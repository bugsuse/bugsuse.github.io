<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_SF_BEP_BEM'><A href='../../html_code/phys/module_sf_bep_bem.F.html#MODULE_SF_BEP_BEM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sf_bep_bem</font> <A href='../../call_to/MODULE_SF_BEP_BEM.html' TARGET='index'>3</A><a name='3'>
<a name='4'>
<font color=#447700>!USE module_model_constants<a name='5'></font>
 USE <A href='../../html_code/phys/module_sf_urban.F.html#MODULE_SF_URBAN'>module_sf_urban</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#module_sf_bep_bem.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_URBAN_3"><a name='6'>
 USE <A href='../../html_code/phys/module_sf_bem.F.html#MODULE_SF_BEM'>module_sf_bem</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#module_sf_bep_bem.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_BEM_1"><a name='7'>
<a name='8'>
<font color=#447700>! SGClarke 09/11/2008<a name='9'></font>
<font color=#447700>! Access urban_param.tbl values through calling urban_param_init in module_physics_init<a name='10'></font>
<font color=#447700>! for CASE (BEPSCHEME) select sf_urban_physics<a name='11'></font>
<font color=#447700>!<a name='12'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='13'></font>
<font color=#447700>!  Dimension for the array used in the BEP module<a name='14'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='15'></font>
<a name='16'>
      integer nurbm           <font color=#447700>! Maximum number of urban classes    <a name='17'></font>
      parameter (nurbm=3)<a name='18'>
<a name='19'>
      integer ndm             <font color=#447700>! Maximum number of street directions <a name='20'></font>
      parameter (ndm=2)<a name='21'>
<a name='22'>
      integer nz_um           <font color=#447700>! Maximum number of vertical levels in the urban grid<a name='23'></font>
      parameter(nz_um=18)<a name='24'>
<a name='25'>
      integer ng_u            <font color=#447700>! Number of grid levels in the ground<a name='26'></font>
      parameter (ng_u=10)<a name='27'>
      integer nwr_u            <font color=#447700>! Number of grid levels in the walls or roofs<a name='28'></font>
      parameter (nwr_u=10)<a name='29'>
<a name='30'>
      integer nf_u             <font color=#447700>!Number of grid levels in the floors (BEM)<a name='31'></font>
      parameter (nf_u=10)<a name='32'>
<a name='33'>
      integer ngb_u            <font color=#447700>!Number of grid levels in the ground below building (BEM)<a name='34'></font>
      parameter (ngb_u=10)<a name='35'>
<a name='36'>
      real dz_u                <font color=#447700>! Urban grid resolution<a name='37'></font>
      parameter (dz_u=5.)<a name='38'>
<a name='39'>
      integer nbui_max         <font color=#447700>!maximum number of types of buildings in an urban class<a name='40'></font>
      parameter (nbui_max=15)   <font color=#447700>!must be less or equal than nz_um <a name='41'></font>
<a name='42'>
<font color=#447700>!---------------------------------------------------------------------------------<a name='43'></font>
<font color=#447700>!Parameters of the windows. The glasses of windows are considered without films  -<a name='44'></font>
<font color=#447700>!Read the paper of J.Karlsson and A.Roos(2000):"modelling the angular behaviour  -<a name='45'></font>
<font color=#447700>!of the total solar energy transmittance of windows".Solar Energy Vol.69,No.4,   -<a name='46'></font>
<font color=#447700>!pp. 321-329, for more details.                                                  -<a name='47'></font>
<font color=#447700>!---------------------------------------------------------------------------------<a name='48'></font>
      integer p_num            <font color=#447700>!number of panes in the windows (1,2 or 3)<a name='49'></font>
      parameter (p_num=2)<a name='50'>
      integer q_num            <font color=#447700>!category number for the windows (q_num= 4, standard glasses)<a name='51'></font>
      parameter(q_num=4)       <font color=#447700>!Possible values 1,2,...,10<a name='52'></font>
<a name='53'>
<a name='54'>
<font color=#447700>! The change of ng_u, nwr_u should be done in agreement with the block data<a name='55'></font>
<font color=#447700>!  in the routine "surf_temp" <a name='56'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='57'></font>
<font color=#447700>!  Constant used in the BEP module<a name='58'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='59'></font>
           <a name='60'>
      real vk                 <font color=#447700>! von Karman constant<a name='61'></font>
      real g_u                <font color=#447700>! Gravity acceleration<a name='62'></font>
      real pi                 <font color=#447700>!<a name='63'></font>
      real r                  <font color=#447700>! Perfect gas constant<a name='64'></font>
      real cp_u               <font color=#447700>! Specific heat at constant pressure<a name='65'></font>
      real rcp_u              <font color=#447700>!<a name='66'></font>
      real sigma              <font color=#447700>!<a name='67'></font>
      real p0                 <font color=#447700>! Reference pressure at the sea level<a name='68'></font>
      real cdrag              <font color=#447700>! Drag force constant<a name='69'></font>
      real latent             <font color=#447700>! Latent heat of vaporization [J/kg] (used in BEM)<a name='70'></font>
      parameter(vk=0.40,g_u=9.81,pi=3.141592653,r=287.,cp_u=1004.)        <a name='71'>
      parameter(rcp_u=r/cp_u,sigma=5.67e-08,p0=1.e+5,cdrag=0.4,latent=2.45e+06)<a name='72'>
<a name='73'>
<font color=#447700>! -----------------------------------------------------------------------     <a name='74'></font>
<a name='75'>
<a name='76'>
<a name='77'>
<a name='78'>
   CONTAINS<a name='79'>
 <a name='80'>
<A NAME='BEP_BEM'><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP_BEM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='81'>
      <font color=#993300>subroutine </font><font color=#cc0000>BEP_BEM</font>(FRC_URB2D,UTYPE_URB2D,itimestep,dz8w,dt,u_phy,v_phy,      &amp; <A href='../../call_to/BEP_BEM.html' TARGET='index'>2</A>,<A href='../../call_from/BEP_BEM.html' TARGET='index'>6</A><a name='82'>
                      th_phy,rho,p_phy,swdown,glw,                                 &amp;<a name='83'>
                      gmt,julday,xlong,xlat,                                       &amp;<a name='84'>
                      declin_urb,cosz_urb2d,omg_urb2d,                             &amp;<a name='85'>
                      num_urban_layers,num_urban_hi,                               &amp;<a name='86'>
                      trb_urb4d,tw1_urb4d,tw2_urb4d,tgb_urb4d,                     &amp;<a name='87'>
                      tlev_urb3d,qlev_urb3d,tw1lev_urb3d,tw2lev_urb3d,             &amp;<a name='88'>
                      tglev_urb3d,tflev_urb3d,sf_ac_urb3d,lf_ac_urb3d,             &amp;<a name='89'>
                      cm_ac_urb3d,sfvent_urb3d,lfvent_urb3d,                       &amp;<a name='90'>
                      sfwin1_urb3d,sfwin2_urb3d,                                   &amp;<a name='91'>
                      sfw1_urb3d,sfw2_urb3d,sfr_urb3d,sfg_urb3d,                   &amp;<a name='92'>
                      lp_urb2d,hi_urb2d,lb_urb2d,hgt_urb2d,                        &amp;<a name='93'>
                      a_u,a_v,a_t,a_e,b_u,b_v,                                     &amp;<a name='94'>
                      b_t,b_e,b_q,dlg,dl_u,sf,vl,                                  &amp;<a name='95'>
                      rl_up,rs_abs,emiss,grdflx_urb,qv_phy,                        &amp;<a name='96'>
                      ids,ide, jds,jde, kds,kde,                                   &amp;<a name='97'>
                      ims,ime, jms,jme, kms,kme,                                   &amp;<a name='98'>
                      its,ite, jts,jte, kts,kte)                    <a name='99'>
<a name='100'>
      implicit none<a name='101'>
<a name='102'>
<font color=#447700>!------------------------------------------------------------------------<a name='103'></font>
<font color=#447700>!     Input<a name='104'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='105'></font>
   INTEGER ::                       ids,ide, jds,jde, kds,kde,  &amp;<a name='106'>
                                    ims,ime, jms,jme, kms,kme,  &amp;<a name='107'>
                                    its,ite, jts,jte, kts,kte,  &amp;<a name='108'>
                                    itimestep<a name='109'>
 <a name='110'>
<a name='111'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   DZ8W<a name='112'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   P_PHY<a name='113'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   RHO<a name='114'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   TH_PHY<a name='115'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   T_PHY<a name='116'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   U_PHY<a name='117'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   V_PHY<a name='118'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   U<a name='119'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   V<a name='120'>
   REAL, DIMENSION( ims:ime , jms:jme )        ::   GLW<a name='121'>
   REAL, DIMENSION( ims:ime , jms:jme )        ::   swdown<a name='122'>
   REAL, DIMENSION( ims:ime, jms:jme )         ::   UST<a name='123'>
   INTEGER, DIMENSION( ims:ime , jms:jme ), INTENT(IN )::   UTYPE_URB2D<a name='124'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN )::   FRC_URB2D<a name='125'>
   REAL, INTENT(IN  )   ::                                   GMT <a name='126'>
   INTEGER, INTENT(IN  ) ::                               JULDAY<a name='127'>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='128'>
         INTENT(IN   )  ::                           XLAT, XLONG<a name='129'>
   REAL, INTENT(IN) :: DECLIN_URB<a name='130'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: COSZ_URB2D<a name='131'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: OMG_URB2D<a name='132'>
   INTEGER, INTENT(IN  ) :: num_urban_layers<a name='133'>
   INTEGER, INTENT(IN  ) :: num_urban_hi<a name='134'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: trb_urb4d<a name='135'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw1_urb4d<a name='136'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw2_urb4d<a name='137'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tgb_urb4d<a name='138'>
<font color=#447700>!New variables used for BEM<a name='139'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ):: qv_phy<a name='140'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tlev_urb3d<a name='141'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: qlev_urb3d<a name='142'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw1lev_urb3d<a name='143'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw2lev_urb3d<a name='144'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tglev_urb3d<a name='145'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tflev_urb3d<a name='146'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: lf_ac_urb3d<a name='147'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: sf_ac_urb3d<a name='148'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: cm_ac_urb3d<a name='149'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: sfvent_urb3d<a name='150'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: lfvent_urb3d<a name='151'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfwin1_urb3d<a name='152'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfwin2_urb3d<a name='153'>
<font color=#447700>!End variables<a name='154'></font>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfw1_urb3d<a name='155'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfw2_urb3d<a name='156'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfr_urb3d<a name='157'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfg_urb3d<a name='158'>
   REAL, DIMENSION( ims:ime, 1:num_urban_hi, jms:jme ), INTENT(IN) :: hi_urb2d<a name='159'>
   REAL, DIMENSION( ims:ime,jms:jme), INTENT(IN) :: lp_urb2d<a name='160'>
   REAL, DIMENSION( ims:ime,jms:jme), INTENT(IN) :: lb_urb2d<a name='161'>
   REAL, DIMENSION( ims:ime,jms:jme), INTENT(IN) :: hgt_urb2d<a name='162'>
<a name='163'>
   real z(ims:ime,kms:kme,jms:jme)            <font color=#447700>! Vertical coordinates<a name='164'></font>
   REAL, INTENT(IN )::   DT      <font color=#447700>! Time step<a name='165'></font>
<a name='166'>
<font color=#447700>!------------------------------------------------------------------------<a name='167'></font>
<font color=#447700>!     Output<a name='168'></font>
<font color=#447700>!------------------------------------------------------------------------ <a name='169'></font>
<font color=#447700>!<a name='170'></font>
<font color=#447700>!    Implicit and explicit components of the source and sink terms at each levels,<a name='171'></font>
<font color=#447700>!     the fluxes can be computed as follow: FX = A*X + B   example: t_fluxes = a_t * pt + b_t<a name='172'></font>
      real a_u(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Implicit component for the momemtum in X-direction (center)<a name='173'></font>
      real a_v(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Implicit component for the momemtum in Y-direction (center)<a name='174'></font>
      real a_t(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Implicit component for the temperature<a name='175'></font>
      real a_e(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Implicit component for the TKE<a name='176'></font>
      real b_u(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Explicit component for the momemtum in X-direction (center)<a name='177'></font>
      real b_v(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Explicit component for the momemtum in Y-direction (center)<a name='178'></font>
      real b_t(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Explicit component for the temperature<a name='179'></font>
      real b_e(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Explicit component for the TKE<a name='180'></font>
      real b_q(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Explicit component for the Humidity<a name='181'></font>
      real dlg(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Height above ground (L_ground in formula (24) of the BLM paper). <a name='182'></font>
      real dl_u(ims:ime,kms:kme,jms:jme)        <font color=#447700>! Length scale (lb in formula (22) ofthe BLM paper).<a name='183'></font>
<font color=#447700>! urban surface and volumes        <a name='184'></font>
      real sf(ims:ime,kms:kme,jms:jme)           <font color=#447700>! surface of the urban grid cells<a name='185'></font>
      real vl(ims:ime,kms:kme,jms:jme)             <font color=#447700>! volume of the urban grid cells<a name='186'></font>
<font color=#447700>! urban fluxes<a name='187'></font>
      real rl_up(its:ite,jts:jte) <font color=#447700>! upward long wave radiation<a name='188'></font>
      real rs_abs(its:ite,jts:jte) <font color=#447700>! absorbed short wave radiation<a name='189'></font>
      real emiss(its:ite,jts:jte)  <font color=#447700>! emissivity averaged for urban surfaces<a name='190'></font>
      real grdflx_urb(its:ite,jts:jte)  <font color=#447700>! ground heat flux for urban areas<a name='191'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='192'></font>
<font color=#447700>!     Local<a name='193'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='194'></font>
      real hi_urb(its:ite,1:nz_um,jts:jte) <font color=#447700>! Height histograms of buildings<a name='195'></font>
      real hi_urb1D(nz_um)                 <font color=#447700>! Height histograms of buildings<a name='196'></font>
      real ss_urb(nz_um,nurbm)             <font color=#447700>! Probability that a building has an height equal to z<a name='197'></font>
      real pb_urb(nz_um)                   <font color=#447700>! Probability that a building has an height greater or equal to z<a name='198'></font>
      real hb_u(nz_um)                     <font color=#447700>! Bulding's heights<a name='199'></font>
      integer nz_urb(nurbm)                <font color=#447700>! Number of layer in the urban grid<a name='200'></font>
      integer nzurban(nurbm)<a name='201'>
<a name='202'>
<font color=#447700>!    Building parameters      <a name='203'></font>
      real alag_u(nurbm)                      <font color=#447700>! Ground thermal diffusivity [m^2 s^-1]<a name='204'></font>
      real alaw_u(nurbm)                      <font color=#447700>! Wall thermal diffusivity [m^2 s^-1]<a name='205'></font>
      real alar_u(nurbm)                      <font color=#447700>! Roof thermal diffusivity [m^2 s^-1]<a name='206'></font>
      real csg_u(nurbm)                       <font color=#447700>! Specific heat of the ground material [J m^3 K^-1]<a name='207'></font>
      real csw_u(nurbm)                       <font color=#447700>! Specific heat of the wall material [J m^3 K^-1]<a name='208'></font>
      real csr_u(nurbm)                       <font color=#447700>! Specific heat of the roof material [J m^3 K^-1]<a name='209'></font>
      real twini_u(nurbm)                     <font color=#447700>! Initial temperature inside the building's wall [K]<a name='210'></font>
      real trini_u(nurbm)                     <font color=#447700>! Initial temperature inside the building's roof [K]<a name='211'></font>
      real tgini_u(nurbm)                     <font color=#447700>! Initial road temperature<a name='212'></font>
<a name='213'>
<font color=#447700>!<a name='214'></font>
<font color=#447700>!   Building materials<a name='215'></font>
<font color=#447700>!<a name='216'></font>
<a name='217'>
      real csg(ng_u)           <font color=#447700>! Specific heat of the ground material [J m^3 K^-1]<a name='218'></font>
      real csw(nwr_u)          <font color=#447700>! Specific heat of the wall material for the current urban class [J m^3 K^-1]<a name='219'></font>
      real csr(nwr_u)          <font color=#447700>! Specific heat of the roof material for the current urban class [J m^3 K^-1]<a name='220'></font>
      real csgb(ngb_u)         <font color=#447700>! Specific heat of the ground material below the buildings at each ground levels[J m^3 K^-1]<a name='221'></font>
      real csf(nf_u)           <font color=#447700>! Specific heat of the floors materials in the buildings at each levels[J m^3 K^-1]<a name='222'></font>
      real alar(nwr_u+1)       <font color=#447700>! Roof thermal diffusivity for the current urban class [W/m K]<a name='223'></font>
      real alaw(nwr_u+1)       <font color=#447700>! Walls thermal diffusivity for the current urban class [W/m K]<a name='224'></font>
      real alag(ng_u)          <font color=#447700>! Ground thermal diffusivity for the current urban class [m^2 s^-1] <a name='225'></font>
      real alagb(ngb_u+1)      <font color=#447700>! Ground thermal diffusivity below the building at each wall layer [W/m K]<a name='226'></font>
      real alaf(nf_u+1)        <font color=#447700>! Floor thermal diffusivity at each wall layers [W/m K]  <a name='227'></font>
      real dzr(nwr_u)          <font color=#447700>! Layer sizes in the roofs [m]<a name='228'></font>
      real dzf(nf_u)           <font color=#447700>! Layer sizes in the floors[m]<a name='229'></font>
      real dzw(nwr_u)          <font color=#447700>! Layer sizes in the walls [m]<a name='230'></font>
      real dzgb(ngb_u)         <font color=#447700>! Layer sizes in the ground below the buildings [m]<a name='231'></font>
<a name='232'>
<font color=#447700>!<a name='233'></font>
<font color=#447700>!New street and radiation parameters<a name='234'></font>
<font color=#447700>!<a name='235'></font>
<a name='236'>
      real bs(ndm)              <font color=#447700>! Building width for the current urban class<a name='237'></font>
      real ws(ndm)              <font color=#447700>! Street widths of the current urban class<a name='238'></font>
      real strd(ndm)            <font color=#447700>! Street lengths for the current urban class<a name='239'></font>
      real drst(ndm)            <font color=#447700>! street directions for the current urban class<a name='240'></font>
      real ss(nz_um)            <font color=#447700>! Probability to have a building with height h<a name='241'></font>
      real pb(nz_um)            <font color=#447700>! Probability to have a building with an height equal<a name='242'></font>
<font color=#447700>!<a name='243'></font>
<font color=#447700>!New roughness and buildings parameters<a name='244'></font>
<font color=#447700>!<a name='245'></font>
      real z0(ndm,nz_um)        <font color=#447700>! Roughness lengths "profiles"<a name='246'></font>
      real bs_urb(ndm,nurbm)      <font color=#447700>! Building width<a name='247'></font>
      real ws_urb(ndm,nurbm)      <font color=#447700>! Street width<a name='248'></font>
<a name='249'>
<font color=#447700>!<a name='250'></font>
<font color=#447700>! for twini_u, and trini_u the initial value at the deepest level is kept constant during the simulation<a name='251'></font>
<font color=#447700>!<a name='252'></font>
<font color=#447700>!    Radiation paramters<a name='253'></font>
<a name='254'>
      real albg_u(nurbm)                      <font color=#447700>! Albedo of the ground<a name='255'></font>
      real albw_u(nurbm)                      <font color=#447700>! Albedo of the wall<a name='256'></font>
      real albr_u(nurbm)                      <font color=#447700>! Albedo of the roof<a name='257'></font>
      real albwin_u(nurbm)                    <font color=#447700>! Albedo of the windows<a name='258'></font>
      real emwind_u(nurbm)                    <font color=#447700>! Emissivity of windows<a name='259'></font>
      real emg_u(nurbm)                       <font color=#447700>! Emissivity of ground<a name='260'></font>
      real emw_u(nurbm)                       <font color=#447700>! Emissivity of wall<a name='261'></font>
      real emr_u(nurbm)                       <font color=#447700>! Emissivity of roof<a name='262'></font>
<a name='263'>
<font color=#447700>!   fww_u,fwg_u,fgw_u,fsw_u,fsg_u are the view factors used to compute the long wave<a name='264'></font>
<font color=#447700>!   and the short wave radiation. <a name='265'></font>
      real fww_u(nz_um,nz_um,ndm,nurbm)         <font color=#447700>!  from wall to wall<a name='266'></font>
      real fwg_u(nz_um,ndm,nurbm)               <font color=#447700>!  from wall to ground<a name='267'></font>
      real fgw_u(nz_um,ndm,nurbm)               <font color=#447700>!  from ground to wall<a name='268'></font>
      real fsw_u(nz_um,ndm,nurbm)               <font color=#447700>!  from sky to wall<a name='269'></font>
      real fws_u(nz_um,ndm,nurbm)               <font color=#447700>!  from sky to wall<a name='270'></font>
      real fsg_u(ndm,nurbm)                     <font color=#447700>!  from sky to ground<a name='271'></font>
<a name='272'>
<font color=#447700>!    Roughness parameters<a name='273'></font>
      real z0g_u(nurbm)         <font color=#447700>! The ground's roughness length<a name='274'></font>
      real z0r_u(nurbm)         <font color=#447700>! The roof's roughness length<a name='275'></font>
<a name='276'>
<font color=#447700>!    Street parameters<a name='277'></font>
      integer nd_u(nurbm)       <font color=#447700>! Number of street direction for each urban class <a name='278'></font>
      real strd_u(ndm,nurbm)    <font color=#447700>! Street length (fix to greater value to the horizontal length of the cells)<a name='279'></font>
      real drst_u(ndm,nurbm)    <font color=#447700>! Street direction<a name='280'></font>
      real ws_u(ndm,nurbm)      <font color=#447700>! Street width<a name='281'></font>
      real bs_u(ndm,nurbm)      <font color=#447700>! Building width<a name='282'></font>
      real h_b(nz_um,nurbm)     <font color=#447700>! Bulding's heights<a name='283'></font>
      real d_b(nz_um,nurbm)     <font color=#447700>! Probability that a building has an height h_b<a name='284'></font>
      real ss_u(nz_um,nurbm)  <font color=#447700>! Probability that a building has an height equal to z<a name='285'></font>
      real pb_u(nz_um,nurbm)  <font color=#447700>! Probability that a building has an height greater or equal to z<a name='286'></font>
<a name='287'>
<a name='288'>
<font color=#447700>!    Grid parameters<a name='289'></font>
      integer nz_u(nurbm)       <font color=#447700>! Number of layer in the urban grid<a name='290'></font>
      <a name='291'>
      real z_u(nz_um)         <font color=#447700>! Height of the urban grid levels<a name='292'></font>
<font color=#447700>!FS<a name='293'></font>
      real cop_u(nurbm)<a name='294'>
      real pwin_u(nurbm)<a name='295'>
      real beta_u(nurbm)<a name='296'>
      integer sw_cond_u(nurbm)<a name='297'>
      real time_on_u(nurbm)<a name='298'>
      real time_off_u(nurbm)<a name='299'>
      real targtemp_u(nurbm)<a name='300'>
      real gaptemp_u(nurbm)<a name='301'>
      real targhum_u(nurbm)<a name='302'>
      real gaphum_u(nurbm)<a name='303'>
      real perflo_u(nurbm)<a name='304'>
      real hsesf_u(nurbm)<a name='305'>
      real hsequip(24)<a name='306'>
<a name='307'>
<font color=#447700>! 1D array used for the input and output of the routine "urban"<a name='308'></font>
<a name='309'>
      real z1D(kms:kme)               <font color=#447700>! vertical coordinates<a name='310'></font>
      real ua1D(kms:kme)                <font color=#447700>! wind speed in the x directions<a name='311'></font>
      real va1D(kms:kme)                <font color=#447700>! wind speed in the y directions<a name='312'></font>
      real pt1D(kms:kme)                <font color=#447700>! potential temperature<a name='313'></font>
      real da1D(kms:kme)                <font color=#447700>! air density<a name='314'></font>
      real pr1D(kms:kme)                <font color=#447700>! air pressure<a name='315'></font>
      real pt01D(kms:kme)               <font color=#447700>! reference potential temperature<a name='316'></font>
      real zr1D                    <font color=#447700>! zenith angle<a name='317'></font>
      real deltar1D                <font color=#447700>! declination of the sun<a name='318'></font>
      real ah1D                    <font color=#447700>! hour angle (it should come from the radiation routine)<a name='319'></font>
      real rs1D                    <font color=#447700>! solar radiation<a name='320'></font>
      real rld1D                   <font color=#447700>! downward flux of the longwave radiation<a name='321'></font>
<a name='322'>
<a name='323'>
      real tw1D(2*ndm,nz_um,nwr_u,nbui_max) <font color=#447700>! temperature in each layer of the wall<a name='324'></font>
      real tg1D(ndm,ng_u)                   <font color=#447700>! temperature in each layer of the ground<a name='325'></font>
      real tr1D(ndm,nz_um,nwr_u)   <font color=#447700>! temperature in each layer of the roof<a name='326'></font>
<font color=#447700>!<a name='327'></font>
<font color=#447700>!New variable for BEM<a name='328'></font>
<font color=#447700>!<a name='329'></font>
      real tlev1D(nz_um,nbui_max)            <font color=#447700>! temperature in each floor and in each different type of building<a name='330'></font>
      real qlev1D(nz_um,nbui_max)            <font color=#447700>! specific humidity in each floor and in each different type of building<a name='331'></font>
      real twlev1D(2*ndm,nz_um,nbui_max)     <font color=#447700>! temperature in each window in each floor in each different type of building<a name='332'></font>
      real tglev1D(ndm,ngb_u,nbui_max)       <font color=#447700>! temperature in each layer of the ground below of a type of building<a name='333'></font>
      real tflev1D(ndm,nf_u,nz_um-1,nbui_max)<font color=#447700>! temperature in each layer of the floors in each building<a name='334'></font>
      real lflev1D(nz_um,nz_um)           <font color=#447700>! latent heat flux due to the air conditioning systems<a name='335'></font>
      real sflev1D(nz_um,nz_um)           <font color=#447700>! sensible heat flux due to the air conditioning systems<a name='336'></font>
      real lfvlev1D(nz_um,nz_um)          <font color=#447700>! latent heat flux due to ventilation<a name='337'></font>
      real sfvlev1D(nz_um,nz_um)          <font color=#447700>! sensible heat flux due to ventilation<a name='338'></font>
      real sfwin1D(2*ndm,nz_um,nbui_max)     <font color=#447700>! sensible heat flux from windows<a name='339'></font>
      real consumlev1D(nz_um,nz_um)       <font color=#447700>! consumption due to the air conditioning systems<a name='340'></font>
      real qv1D(kms:kme)                  <font color=#447700>! specific humidity<a name='341'></font>
      real meso_urb                       <font color=#447700>! constant to link meso and urban scales [m-2]<a name='342'></font>
      real d_urb(nz_um)    <a name='343'>
      real sf_ac<a name='344'>
      integer ibui,nbui<a name='345'>
      integer nlev(nz_um)<a name='346'>
<font color=#447700>!<a name='347'></font>
<font color=#447700>!End new variables<a name='348'></font>
<font color=#447700>!<a name='349'></font>
<a name='350'>
      real sfw1D(2*ndm,nz_um,nbui_max)      <font color=#447700>! sensible heat flux from walls<a name='351'></font>
      real sfg1D(ndm)              <font color=#447700>! sensible heat flux from ground (road)<a name='352'></font>
      real sfr1D(ndm,nz_um)      <font color=#447700>! sensible heat flux from roofs<a name='353'></font>
      real sf1D(kms:kme)              <font color=#447700>! surface of the urban grid cells<a name='354'></font>
      real vl1D(kms:kme)                <font color=#447700>! volume of the urban grid cells<a name='355'></font>
      real a_u1D(kms:kme)               <font color=#447700>! Implicit component of the momentum sources or sinks in the X-direction<a name='356'></font>
      real a_v1D(kms:kme)               <font color=#447700>! Implicit component of the momentum sources or sinks in the Y-direction<a name='357'></font>
      real a_t1D(kms:kme)               <font color=#447700>! Implicit component of the heat sources or sinks<a name='358'></font>
      real a_e1D(kms:kme)               <font color=#447700>! Implicit component of the TKE sources or sinks<a name='359'></font>
      real b_u1D(kms:kme)               <font color=#447700>! Explicit component of the momentum sources or sinks in the X-direction<a name='360'></font>
      real b_v1D(kms:kme)               <font color=#447700>! Explicit component of the momentum sources or sinks in the Y-direction<a name='361'></font>
      real b_t1D(kms:kme)               <font color=#447700>! Explicit component of the heat sources or sinks<a name='362'></font>
      real b_ac1D(kms:kme)<a name='363'>
      real b_e1D(kms:kme)               <font color=#447700>! Explicit component of the TKE sources or sinks<a name='364'></font>
      real b_q1D(kms:kme)               <font color=#447700>! Explicit component of the Humidity sources or sinks<a name='365'></font>
      real dlg1D(kms:kme)               <font color=#447700>! Height above ground (L_ground in formula (24) of the BLM paper). <a name='366'></font>
      real dl_u1D(kms:kme)              <font color=#447700>! Length scale (lb in formula (22) ofthe BLM paper)<a name='367'></font>
<a name='368'>
      real time_bep<a name='369'>
<font color=#447700>! arrays used to collapse indexes<a name='370'></font>
      integer ind_zwd(nbui_max,nz_um,nwr_u,ndm)<a name='371'>
      integer ind_gd(ng_u,ndm)<a name='372'>
      integer ind_zd(nbui_max,nz_um,ndm)<a name='373'>
      integer ind_zdf(nz_um,ndm)<a name='374'>
      integer ind_zrd(nz_um,nwr_u,ndm)<a name='375'>
<font color=#447700>!<a name='376'></font>
      integer ind_bd(nbui_max,nz_um)<a name='377'>
      integer ind_wd(nbui_max,nz_um,ndm)<a name='378'>
      integer ind_gbd(nbui_max,ngb_u,ndm)  <a name='379'>
      integer ind_fbd(nbui_max,nf_u,nz_um-1,ndm)<a name='380'>
<font color=#447700>!<a name='381'></font>
      integer ix,iy,iz,iurb,id,iz_u,iw,ig,ir,ix1,iy1,k<a name='382'>
      integer it, nint<a name='383'>
      integer iii<a name='384'>
     <a name='385'>
      logical first<a name='386'>
      character(len=80) :: text<a name='387'>
      data first/.true./<a name='388'>
      save first,time_bep <a name='389'>
<a name='390'>
      save alag_u,alaw_u,alar_u,csg_u,csw_u,csr_u,                       &amp;<a name='391'>
           albg_u,albw_u,albr_u,emg_u,emw_u,emr_u,                       &amp;<a name='392'>
           z0g_u,z0r_u, nd_u,strd_u,drst_u,ws_u,bs_u,h_b,d_b,ss_u,pb_u,  &amp;<a name='393'>
           nz_u,z_u,albwin_u,emwind_u,cop_u,pwin_u,beta_u,sw_cond_u,     &amp;<a name='394'>
           time_on_u,time_off_u,targtemp_u,gaptemp_u,targhum_u,gaphum_u, &amp;<a name='395'>
           perflo_u,hsesf_u,hsequip <a name='396'>
<a name='397'>
<font color=#447700>!------------------------------------------------------------------------<a name='398'></font>
<font color=#447700>!    Calculation of the momentum, heat and turbulent kinetic fluxes<a name='399'></font>
<font color=#447700>!     produced by buildings<a name='400'></font>
<font color=#447700>!<a name='401'></font>
<font color=#447700>! References:<a name='402'></font>
<font color=#447700>! Martilli, A., Clappier, A., Rotach, M.W.:2002, 'AN URBAN SURFACE EXCHANGE<a name='403'></font>
<font color=#447700>! PARAMETERISATION FOR MESOSCALE MODELS', Boundary-Layer Meteorolgy 104:<a name='404'></font>
<font color=#447700>! 261-304<a name='405'></font>
<font color=#447700>!<a name='406'></font>
<font color=#447700>! F. Salamanca and A. Martilli, 2009: 'A new Building Energy Model coupled <a name='407'></font>
<font color=#447700>! with an Urban Canopy Parameterization for urban climate simulations-part II. <a name='408'></font>
<font color=#447700>! Validation with one dimension off-line simulations'. Theor Appl Climatol<a name='409'></font>
<font color=#447700>! DOI 10.1007/s00704-009-0143-8 <a name='410'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='411'></font>
<font color=#447700>!<a name='412'></font>
<font color=#447700>!prepare the arrays to collapse indexes<a name='413'></font>
<a name='414'>
      if(num_urban_layers.lt.nbui_max*nz_um*ndm*max(nwr_u,ng_u))then<a name='415'>
        write(*,*)'num_urban_layers too small, please increase to at least ', nbui_max*nz_um*ndm*max(nwr_u,ng_u)<a name='416'>
        stop<a name='417'>
      endif<a name='418'>
<font color=#447700>!<a name='419'></font>
<font color=#447700>!New conditions for BEM<a name='420'></font>
<font color=#447700>!<a name='421'></font>
      if(num_urban_layers.lt.nbui_max*nz_um)then <font color=#447700>!limit for indoor temperature and indoor humidity<a name='422'></font>
        write(*,*)'num_urban_layers too small, please increase to at least ', nbui_max*nz_um<a name='423'>
        stop<a name='424'>
      endif<a name='425'>
<a name='426'>
      if(num_urban_layers.lt.nbui_max*nz_um*ndm)then <font color=#447700>!limit for window temperature<a name='427'></font>
        write(*,*)'num_urban_layers too small, please increase to at least ', nbui_max*nz_um*ndm<a name='428'>
        stop<a name='429'>
      endif<a name='430'>
<a name='431'>
      if(num_urban_layers.lt.nbui_max*ndm*ngb_u)then <font color=#447700>!limit for ground temperature below a building<a name='432'></font>
        write(*,*)'num_urban_layers too small, please increase to at least ', nbui_max*ndm*ngb_u<a name='433'>
        stop<a name='434'>
      endif<a name='435'>
<a name='436'>
      if(num_urban_layers.lt.(nz_um-1)*nbui_max*ndm*nf_u)then <font color=#447700>!limit for floor temperature <a name='437'></font>
        write(*,*)'num_urban_layers too small, please increase to at least ', nbui_max*ndm*nf_u*(nz_um-1),num_urban_layers<a name='438'>
        stop<a name='439'>
      endif<a name='440'>
<a name='441'>
      if (ndm.ne.2)then<a name='442'>
         write(*,*) 'number of directions is not correct',ndm<a name='443'>
         stop<a name='444'>
      endif<a name='445'>
<a name='446'>
<font color=#447700>!<a name='447'></font>
<font color=#447700>!End of new conditions<a name='448'></font>
<font color=#447700>!<a name='449'></font>
<font color=#447700>!<a name='450'></font>
<font color=#447700>!Initialize collapse indexes<a name='451'></font>
<font color=#447700>!<a name='452'></font>
      ind_zwd=0       <a name='453'>
      ind_gd=0<a name='454'>
      ind_zd=0<a name='455'>
      ind_zdf=0<a name='456'>
      ind_zrd=0<a name='457'>
      ind_bd=0<a name='458'>
      ind_wd=0<a name='459'>
      ind_gbd=0<a name='460'>
      ind_fbd=0<a name='461'>
<font color=#447700>!<a name='462'></font>
<font color=#447700>!End initialization indexes<a name='463'></font>
<font color=#447700>!<a name='464'></font>
<a name='465'>
      iii=0<a name='466'>
      do ibui=1,nbui_max<a name='467'>
      do iz_u=1,nz_um<a name='468'>
      do iw=1,nwr_u<a name='469'>
      do id=1,ndm<a name='470'>
       iii=iii+1<a name='471'>
       ind_zwd(ibui,iz_u,iw,id)=iii<a name='472'>
      enddo<a name='473'>
      enddo<a name='474'>
      enddo<a name='475'>
      enddo<a name='476'>
<a name='477'>
      iii=0<a name='478'>
      do ig=1,ng_u<a name='479'>
      do id=1,ndm<a name='480'>
       iii=iii+1<a name='481'>
       ind_gd(ig,id)=iii<a name='482'>
      enddo<a name='483'>
      enddo<a name='484'>
<a name='485'>
      iii=0<a name='486'>
      do ibui=1,nbui_max<a name='487'>
      do iz_u=1,nz_um<a name='488'>
      do id=1,ndm<a name='489'>
       iii=iii+1<a name='490'>
       ind_zd(ibui,iz_u,id)=iii<a name='491'>
      enddo<a name='492'>
      enddo<a name='493'>
      enddo<a name='494'>
  <a name='495'>
      iii=0<a name='496'>
      do iz_u=1,nz_um<a name='497'>
      do iw=1,nwr_u<a name='498'>
      do id=1,ndm<a name='499'>
       iii=iii+1<a name='500'>
       ind_zrd(iz_u,iw,id)=iii<a name='501'>
      enddo<a name='502'>
      enddo<a name='503'>
      enddo<a name='504'>
     <a name='505'>
<font color=#447700>!<a name='506'></font>
<font color=#447700>!New indexes for BEM<a name='507'></font>
<font color=#447700>!<a name='508'></font>
      iii=0<a name='509'>
      do iz_u=1,nz_um<a name='510'>
      do id=1,ndm<a name='511'>
         iii=iii+1<a name='512'>
         ind_zdf(iz_u,id)=iii<a name='513'>
      enddo <font color=#447700>! id<a name='514'></font>
      enddo <font color=#447700>! iz_u<a name='515'></font>
<a name='516'>
      iii=0<a name='517'>
      do ibui=1,nbui_max  <font color=#447700>!Type of building<a name='518'></font>
      do iz_u=1,nz_um     <font color=#447700>!vertical levels<a name='519'></font>
         iii=iii+1<a name='520'>
         ind_bd(ibui,iz_u)=iii<a name='521'>
      enddo <font color=#447700>!iz_u<a name='522'></font>
      enddo <font color=#447700>!ibui<a name='523'></font>
      <a name='524'>
      <a name='525'>
      iii=0<a name='526'>
      do ibui=1,nbui_max <font color=#447700>!type of building<a name='527'></font>
      do iz_u=1,nz_um <font color=#447700>!vertical levels<a name='528'></font>
      do id=1,ndm <font color=#447700>!direction<a name='529'></font>
         iii=iii+1<a name='530'>
         ind_wd(ibui,iz_u,id)=iii<a name='531'>
      enddo <font color=#447700>!id<a name='532'></font>
      enddo <font color=#447700>!iz_u<a name='533'></font>
      enddo <font color=#447700>!ibui<a name='534'></font>
<a name='535'>
      iii=0<a name='536'>
      do ibui=1,nbui_max<font color=#447700>!type of building<a name='537'></font>
      do iw=1,ngb_u <font color=#447700>!layers in the wall (ground below a building)<a name='538'></font>
      do id=1,ndm <font color=#447700>!direction<a name='539'></font>
         iii=iii+1<a name='540'>
         ind_gbd(ibui,iw,id)=iii  <a name='541'>
      enddo <font color=#447700>!id<a name='542'></font>
      enddo <font color=#447700>!iw <a name='543'></font>
      enddo <font color=#447700>!ibui    <a name='544'></font>
<a name='545'>
      iii=0<a name='546'>
      do ibui=1,nbui_max <font color=#447700>!type of building<a name='547'></font>
      do iw=1,nf_u <font color=#447700>!layers in the wall (floor)<a name='548'></font>
      do iz_u=1,nz_um-1 <font color=#447700>!vertical levels<a name='549'></font>
      do id=1,ndm  <font color=#447700>!direction<a name='550'></font>
         iii=iii+1<a name='551'>
         ind_fbd(ibui,iw,iz_u,id)=iii<a name='552'>
      enddo <font color=#447700>!id<a name='553'></font>
      enddo <font color=#447700>!iz_u<a name='554'></font>
      enddo <font color=#447700>!iw<a name='555'></font>
      enddo <font color=#447700>!ibui<a name='556'></font>
<font color=#447700>!<a name='557'></font>
<font color=#447700>!End of new indexes<a name='558'></font>
<font color=#447700>!   <a name='559'></font>
      if (num_urban_hi.ge.nz_um)then<a name='560'>
          write(*,*)'nz_um too small, please increase to at least ', num_urban_hi+1<a name='561'>
          stop         <a name='562'>
      endif<a name='563'>
   <a name='564'>
      do ix=its,ite<a name='565'>
      do iy=jts,jte<a name='566'>
      do iz_u=1,nz_um<a name='567'>
          hi_urb(ix,iz_u,iy)=0.<a name='568'>
      enddo<a name='569'>
      enddo<a name='570'>
      enddo<a name='571'>
<a name='572'>
      do ix=its,ite<a name='573'>
      do iy=jts,jte<a name='574'>
       z(ix,kts,iy)=0.<a name='575'>
       do iz=kts+1,kte+1<a name='576'>
        z(ix,iz,iy)=z(ix,iz-1,iy)+dz8w(ix,iz-1,iy)<a name='577'>
       enddo<a name='578'>
       iii=0<a name='579'>
       do iz_u=1,num_urban_hi<a name='580'>
          hi_urb(ix,iz_u,iy)= hi_urb2d(ix,iz_u,iy)<a name='581'>
          if (hi_urb(ix,iz_u,iy)/=0.) then<a name='582'>
             iii=iii+1<a name='583'>
          endif<a name='584'>
       enddo <font color=#447700>!iz_u<a name='585'></font>
       if (iii.gt.nbui_max) then<a name='586'>
          write(*,*) 'nbui_max too small, please increase to at least ',iii<a name='587'>
          stop<a name='588'>
       endif<a name='589'>
      enddo<a name='590'>
      enddo<a name='591'>
<a name='592'>
      if (first) then                           <font color=#447700>! True only on first call<a name='593'></font>
<a name='594'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INIT_PARA'>init_para</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP_BEM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_PARA_2">(alag_u,alaw_u,alar_u,csg_u,csw_u,csr_u,&amp;<a name='595'>
                twini_u,trini_u,tgini_u,albg_u,albw_u,albr_u,albwin_u,emg_u,emw_u,&amp;<a name='596'>
                emr_u,emwind_u,z0g_u,z0r_u,nd_u,strd_u,drst_u,ws_u,bs_u,h_b,d_b,  &amp;<a name='597'>
                cop_u,pwin_u,beta_u,sw_cond_u,time_on_u,time_off_u,targtemp_u,    &amp;<a name='598'>
                gaptemp_u,targhum_u,gaphum_u,perflo_u,hsesf_u,hsequip)<a name='599'>
<a name='600'>
<font color=#447700>!Initialisation of the urban parameters and calculation of the view factor<a name='601'></font>
<a name='602'>
       call <A href='../../html_code/phys/module_sf_bep_bem.F.html#ICBEP'>icBEP</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP_BEM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICBEP_2">(nd_u,h_b,d_b,ss_u,pb_u,nz_u,z_u)                                  <a name='603'>
<a name='604'>
       first=.false.<a name='605'>
<a name='606'>
      endif <font color=#447700>! first<a name='607'></font>
      <a name='608'>
      do ix=its,ite<a name='609'>
      do iy=jts,jte<a name='610'>
        if (FRC_URB2D(ix,iy).gt.0.) then    <font color=#447700>! Calling BEP only for existing urban classes.<a name='611'></font>
	<a name='612'>
         iurb=UTYPE_URB2D(ix,iy)<a name='613'>
<a name='614'>
         hi_urb1D=0.<a name='615'>
         do iz_u=1,nz_um<a name='616'>
            hi_urb1D(iz_u)=hi_urb(ix,iz_u,iy)<a name='617'>
         enddo<a name='618'>
<a name='619'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#ICBEPHI_XY'>icBEPHI_XY</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP_BEM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICBEPHI_XY_2">(iurb,hb_u,hi_urb1D,ss_urb,pb_urb,    &amp;<a name='620'>
                         nz_urb(iurb),z_u)<a name='621'>
<a name='622'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#PARAM'>param</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP_BEM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PARAM_2">(iurb,nz_u(iurb),nz_urb(iurb),nzurban(iurb),      &amp;<a name='623'>
                    nd_u(iurb),csg_u,csg,alag_u,alag,csr_u,csr,      &amp;<a name='624'>
                    alar_u,alar,csw_u,csw,alaw_u,alaw,               &amp;<a name='625'>
                    ws_u,ws_urb,ws,bs_u,bs_urb,bs,z0g_u,z0r_u,z0,    &amp;<a name='626'>
                    strd_u,strd,drst_u,drst,ss_u,ss_urb,ss,pb_u,     &amp;<a name='627'>
                    pb_urb,pb,dzw,dzr,dzf,csf,alaf,dzgb,csgb,alagb,  &amp;<a name='628'>
                    lp_urb2d(ix,iy),lb_urb2d(ix,iy),                 &amp;<a name='629'>
                    hgt_urb2d(ix,iy),FRC_URB2D(ix,iy))<a name='630'>
         <a name='631'>
<font color=#447700>!<a name='632'></font>
<font color=#447700>!We compute the view factors in the icBEP_XY routine<a name='633'></font>
<font color=#447700>!  <a name='634'></font>
<a name='635'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#ICBEP_XY'>icBEP_XY</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP_BEM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICBEP_XY_2">(iurb,fww_u,fwg_u,fgw_u,fsw_u,fws_u,fsg_u,   &amp;<a name='636'>
                         nd_u(iurb),strd,ws,nzurban(iurb),z_u)   <a name='637'>
<a name='638'>
         ibui=0<a name='639'>
         nlev=0<a name='640'>
         nbui=0<a name='641'>
         d_urb=0.<a name='642'>
         do iz=1,nz_um		   <a name='643'>
         if(ss_urb(iz,iurb).gt.0) then		<a name='644'>
           ibui=ibui+1		                <a name='645'>
           nlev(ibui)=iz-1<a name='646'>
           d_urb(ibui)=ss_urb(iz,iurb)<a name='647'>
           nbui=ibui<a name='648'>
	 endif	  <a name='649'>
         end do  <font color=#447700>!iz<a name='650'></font>
<a name='651'>
         if (nbui.gt.nbui_max) then<a name='652'>
            write (*,*) 'nbui_max must be increased to',nbui<a name='653'>
            stop<a name='654'>
         endif<a name='655'>
<a name='656'>
       do iz= kts,kte<a name='657'>
          ua1D(iz)=u_phy(ix,iz,iy)<a name='658'>
          va1D(iz)=v_phy(ix,iz,iy)<a name='659'>
	  pt1D(iz)=th_phy(ix,iz,iy)<a name='660'>
	  da1D(iz)=rho(ix,iz,iy)<a name='661'>
	  pr1D(iz)=p_phy(ix,iz,iy)<a name='662'>
<font color=#447700>!!	  pt01D(iz)=th_phy(ix,iz,iy)<a name='663'></font>
	  pt01D(iz)=300.<a name='664'>
	  z1D(iz)=z(ix,iz,iy)<a name='665'>
          qv1D(iz)=qv_phy(ix,iz,iy)<a name='666'>
          a_u1D(iz)=0.<a name='667'>
          a_v1D(iz)=0.<a name='668'>
          a_t1D(iz)=0.<a name='669'>
          a_e1D(iz)=0.<a name='670'>
          b_u1D(iz)=0.<a name='671'>
          b_v1D(iz)=0.<a name='672'>
          b_t1D(iz)=0.<a name='673'>
          b_ac1D(iz)=0.<a name='674'>
          b_e1D(iz)=0.           <a name='675'>
         enddo<a name='676'>
	 z1D(kte+1)=z(ix,kte+1,iy)<a name='677'>
<a name='678'>
         do id=1,ndm<a name='679'>
         do iz_u=1,nz_um<a name='680'>
         do iw=1,nwr_u<a name='681'>
         do ibui=1,nbui_max<a name='682'>
<font color=#447700>!!        tw1D(2*id-1,iz_u,iw)=tw1_u(ix,iy,ind_zwd(iz_u,iw,id))<a name='683'></font>
<font color=#447700>!!        tw1D(2*id,iz_u,iw)=tw2_u(ix,iy,ind_zwd(iz_u,iw,id))<a name='684'></font>
          tw1D(2*id-1,iz_u,iw,ibui)=tw1_urb4d(ix,ind_zwd(ibui,iz_u,iw,id),iy)<a name='685'>
          tw1D(2*id,iz_u,iw,ibui)=tw2_urb4d(ix,ind_zwd(ibui,iz_u,iw,id),iy)<a name='686'>
         enddo<a name='687'>
         enddo<a name='688'>
         enddo<a name='689'>
         enddo<a name='690'>
	<a name='691'>
         do id=1,ndm<a name='692'>
          do ig=1,ng_u<a name='693'>
<font color=#447700>!!          tg1D(id,ig)=tg_u(ix,iy,ind_gd(ig,id))<a name='694'></font>
            tg1D(id,ig)=tgb_urb4d(ix,ind_gd(ig,id),iy)<a name='695'>
          enddo<a name='696'>
          do iz_u=1,nz_um<a name='697'>
          do ir=1,nwr_u<a name='698'>
<font color=#447700>!!          tr1D(id,iz_u,ir)=tr_u(ix,iy,ind_zwd(iz_u,ir,id))<a name='699'></font>
            tr1D(id,iz_u,ir)=trb_urb4d(ix,ind_zrd(iz_u,ir,id),iy)<a name='700'>
          enddo<a name='701'>
          enddo<a name='702'>
         enddo<a name='703'>
<font color=#447700>!<a name='704'></font>
<font color=#447700>!Initialize variables for BEM<a name='705'></font>
<font color=#447700>!<a name='706'></font>
         tlev1D=0.  <font color=#447700>!Indoor temperature<a name='707'></font>
         qlev1D=0.  <font color=#447700>!Indoor humidity<a name='708'></font>
<a name='709'>
         twlev1D=0. <font color=#447700>!Window temperature<a name='710'></font>
         tglev1D=0. <font color=#447700>!Ground temperature<a name='711'></font>
         tflev1D=0. <font color=#447700>!Floor temperature<a name='712'></font>
<a name='713'>
         sflev1D=0.    <font color=#447700>!Sensible heat flux from the a.c.<a name='714'></font>
         lflev1D=0.    <font color=#447700>!latent heat flux from the a.c.<a name='715'></font>
         consumlev1D=0.<font color=#447700>!consumption of the a.c.<a name='716'></font>
         sfvlev1D=0.   <font color=#447700>!Sensible heat flux from natural ventilation<a name='717'></font>
         lfvlev1D=0.   <font color=#447700>!Latent heat flux from natural ventilation<a name='718'></font>
         sfwin1D=0.    <font color=#447700>!Sensible heat flux from windows<a name='719'></font>
         sfw1D=0.      <font color=#447700>!Sensible heat flux from walls         <a name='720'></font>
<a name='721'>
         do iz_u=1,nz_um    <font color=#447700>!vertical levels<a name='722'></font>
         do ibui=1,nbui_max <font color=#447700>!Type of building<a name='723'></font>
            tlev1D(iz_u,ibui)= tlev_urb3d(ix,ind_bd(ibui,iz_u),iy)  <a name='724'>
            qlev1D(iz_u,ibui)= qlev_urb3d(ix,ind_bd(ibui,iz_u),iy)  <a name='725'>
         enddo <font color=#447700>!ibui<a name='726'></font>
         enddo <font color=#447700>!iz_u<a name='727'></font>
<a name='728'>
         do id=1,ndm  <font color=#447700>!direction<a name='729'></font>
            do iz_u=1,nz_um <font color=#447700>!vertical levels<a name='730'></font>
               do ibui=1,nbui_max <font color=#447700>!type of building<a name='731'></font>
                  twlev1D(2*id-1,iz_u,ibui)=tw1lev_urb3d(ix,ind_wd(ibui,iz_u,id),iy)<a name='732'>
                  twlev1D(2*id,iz_u,ibui)=tw2lev_urb3d(ix,ind_wd(ibui,iz_u,id),iy)<a name='733'>
                  sfwin1D(2*id-1,iz_u,ibui)=sfwin1_urb3d(ix,ind_wd(ibui,iz_u,id),iy)<a name='734'>
                  sfwin1D(2*id,iz_u,ibui)=sfwin2_urb3d(ix,ind_wd(ibui,iz_u,id),iy)<a name='735'>
               enddo <font color=#447700>!ibui  <a name='736'></font>
            enddo <font color=#447700>!iz_u<a name='737'></font>
         enddo <font color=#447700>!id<a name='738'></font>
<a name='739'>
         do id=1,ndm <font color=#447700>!direction<a name='740'></font>
            do iw=1,ngb_u <font color=#447700>!layer in the wall<a name='741'></font>
               do ibui=1,nbui_max <font color=#447700>!type of building<a name='742'></font>
                  tglev1D(id,iw,ibui)=tglev_urb3d(ix,ind_gbd(ibui,iw,id),iy)<a name='743'>
               enddo <font color=#447700>!ibui<a name='744'></font>
            enddo <font color=#447700>!iw<a name='745'></font>
         enddo <font color=#447700>!id<a name='746'></font>
       <a name='747'>
         do id=1,ndm <font color=#447700>!direction<a name='748'></font>
            do iw=1,nf_u <font color=#447700>!layer in the walls<a name='749'></font>
               do iz_u=1,nz_um-1 <font color=#447700>!verticals levels<a name='750'></font>
                  do ibui=1,nbui_max <font color=#447700>!type of building<a name='751'></font>
                     tflev1D(id,iw,iz_u,ibui)=tflev_urb3d(ix,ind_fbd(ibui,iw,iz_u,id),iy)<a name='752'>
                  enddo <font color=#447700>!ibui<a name='753'></font>
               enddo <font color=#447700>! iz_u<a name='754'></font>
             enddo <font color=#447700>!iw<a name='755'></font>
         enddo <font color=#447700>!id<a name='756'></font>
<a name='757'>
<font color=#447700>!<a name='758'></font>
<font color=#447700>!End initialization for BEM<a name='759'></font>
<font color=#447700>!         <a name='760'></font>
<a name='761'>
         do id=1,ndm<a name='762'>
	 do iz=1,nz_um<a name='763'>
         do ibui=1,nbui_max <font color=#447700>!type of building<a name='764'></font>
<font color=#447700>!!	  sfw1D(2*id-1,iz)=sfw1(ix,iy,ind_zd(iz,id))<a name='765'></font>
<font color=#447700>!!	  sfw1D(2*id,iz)=sfw2(ix,iy,ind_zd(iz,id))<a name='766'></font>
	  sfw1D(2*id-1,iz,ibui)=sfw1_urb3d(ix,ind_zd(ibui,iz,id),iy)<a name='767'>
	  sfw1D(2*id,iz,ibui)=sfw2_urb3d(ix,ind_zd(ibui,iz,id),iy)<a name='768'>
         enddo<a name='769'>
	 enddo<a name='770'>
	 enddo<a name='771'>
	 <a name='772'>
	 do id=1,ndm<a name='773'>
<font color=#447700>!!	  sfg1D(id)=sfg(ix,iy,id)<a name='774'></font>
	  sfg1D(id)=sfg_urb3d(ix,id,iy)<a name='775'>
	 enddo<a name='776'>
	 <a name='777'>
	 do id=1,ndm<a name='778'>
	 do iz=1,nz_um<a name='779'>
<font color=#447700>!!	  sfr1D(id,iz)=sfr(ix,iy,ind_zd(iz,id))<a name='780'></font>
	  sfr1D(id,iz)=sfr_urb3d(ix,ind_zdf(iz,id),iy)<a name='781'>
	 enddo<a name='782'>
	 enddo<a name='783'>
         <a name='784'>
         rs1D=swdown(ix,iy)<a name='785'>
         rld1D=glw(ix,iy)<a name='786'>
<a name='787'>
         zr1D=acos(COSZ_URB2D(ix,iy))<a name='788'>
         deltar1D=DECLIN_URB<a name='789'>
         ah1D=OMG_URB2D(ix,iy)<a name='790'>
<a name='791'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D'>BEP1D</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP_BEM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BEP1D_2">(iurb,kms,kme,kts,kte,z1D,dt,ua1D,va1D,pt1D,da1D,pr1D,pt01D,  &amp;<a name='792'>
                   zr1D,deltar1D,ah1D,rs1D,rld1D,alagb,             &amp; <a name='793'>
                   alag,alaw,alar,alaf,csgb,csg,csw,csr,csf,        &amp; <a name='794'>
                   dzr,dzf,dzw,dzgb,                                &amp;<a name='795'>
                   albg_u(iurb),albw_u(iurb),albr_u(iurb),          &amp;<a name='796'>
                   albwin_u(iurb),emg_u(iurb),emw_u(iurb),          &amp;<a name='797'>
                   emr_u(iurb),emwind_u(iurb),fww_u,fwg_u,          &amp;<a name='798'>
                   fgw_u,fsw_u,fws_u,fsg_u,z0,                      &amp; <a name='799'>
                   nd_u(iurb),strd,drst,ws,bs_urb,bs,ss,pb,         &amp; <a name='800'>
                   nzurban(iurb),z_u,cop_u,pwin_u,beta_u,           &amp; <a name='801'>
                   sw_cond_u,time_on_u,time_off_u,targtemp_u,       &amp;<a name='802'>
                   gaptemp_u,targhum_u,gaphum_u,perflo_u,           &amp;<a name='803'>
                   hsesf_u,hsequip,                                 &amp;<a name='804'>
                   tw1D,tg1D,tr1D,sfw1D,sfg1D,sfr1D,                &amp; <a name='805'>
                   a_u1D,a_v1D,a_t1D,a_e1D,                         &amp; <a name='806'>
                   b_u1D,b_v1D,b_t1D,b_ac1D,b_e1D,b_q1D,            &amp; <a name='807'>
                   dlg1D,dl_u1D,sf1D,vl1D,rl_up(ix,iy),             &amp;<a name='808'>
                   rs_abs(ix,iy),emiss(ix,iy),grdflx_urb(ix,iy),    &amp;<a name='809'>
                   qv1D,tlev1D,qlev1D,sflev1D,lflev1D,consumlev1D,  &amp;<a name='810'>
                   sfvlev1D,lfvlev1D,twlev1D,tglev1D,tflev1D,sfwin1D,&amp;<a name='811'>
                   ix,iy)                            <a name='812'>
 <a name='813'>
         do ibui=1,nbui_max <font color=#447700>!type of building<a name='814'></font>
	    do iz=1,nz_um   <font color=#447700>!vertical levels<a name='815'></font>
               do id=1,ndm <font color=#447700>! direction<a name='816'></font>
	          sfw1_urb3d(ix,ind_zd(ibui,iz,id),iy)=sfw1D(2*id-1,iz,ibui) <a name='817'>
	          sfw2_urb3d(ix,ind_zd(ibui,iz,id),iy)=sfw1D(2*id,iz,ibui) <a name='818'>
	       enddo<a name='819'>
	    enddo<a name='820'>
         enddo<a name='821'>
 <a name='822'>
	 do id=1,ndm<a name='823'>
	  sfg_urb3d(ix,id,iy)=sfg1D(id) <a name='824'>
	 enddo<a name='825'>
         <a name='826'>
	 do id=1,ndm<a name='827'>
	 do iz=1,nz_um<a name='828'>
	  sfr_urb3d(ix,ind_zdf(iz,id),iy)=sfr1D(id,iz)<a name='829'>
	 enddo<a name='830'>
	 enddo<a name='831'>
         <a name='832'>
         do ibui=1,nbui_max<a name='833'>
         do iz_u=1,nz_um<a name='834'>
         do iw=1,nwr_u<a name='835'>
         do id=1,ndm<a name='836'>
          tw1_urb4d(ix,ind_zwd(ibui,iz_u,iw,id),iy)=tw1D(2*id-1,iz_u,iw,ibui)<a name='837'>
          tw2_urb4d(ix,ind_zwd(ibui,iz_u,iw,id),iy)=tw1D(2*id,iz_u,iw,ibui)<a name='838'>
         enddo<a name='839'>
         enddo<a name='840'>
         enddo<a name='841'>
         enddo<a name='842'>
         <a name='843'>
         do id=1,ndm<a name='844'>
            do ig=1,ng_u<a name='845'>
               tgb_urb4d(ix,ind_gd(ig,id),iy)=tg1D(id,ig)<a name='846'>
            enddo<a name='847'>
            do iz_u=1,nz_um<a name='848'>
               do ir=1,nwr_u<a name='849'>
                  trb_urb4d(ix,ind_zrd(iz_u,ir,id),iy)=tr1D(id,iz_u,ir)<a name='850'>
               enddo<a name='851'>
            enddo<a name='852'>
         enddo<a name='853'>
<font color=#447700>!<a name='854'></font>
<font color=#447700>!Outputs of BEM<a name='855'></font>
<font color=#447700>!<a name='856'></font>
        <a name='857'>
         do ibui=1,nbui_max <font color=#447700>!type of building<a name='858'></font>
         do iz_u=1,nz_um <font color=#447700>!vertical levels<a name='859'></font>
            tlev_urb3d(ix,ind_bd(ibui,iz_u),iy)=tlev1D(iz_u,ibui)  <a name='860'>
            qlev_urb3d(ix,ind_bd(ibui,iz_u),iy)=qlev1D(iz_u,ibui)  <a name='861'>
         enddo <font color=#447700>!iz_u<a name='862'></font>
         enddo <font color=#447700>!ibui<a name='863'></font>
 <a name='864'>
         do ibui=1,nbui_max <font color=#447700>!type of building<a name='865'></font>
         do iz_u=1,nz_um <font color=#447700>!vertical levels<a name='866'></font>
            do id=1,ndm <font color=#447700>!direction<a name='867'></font>
               tw1lev_urb3d(ix,ind_wd(ibui,iz_u,id),iy)=twlev1D(2*id-1,iz_u,ibui)<a name='868'>
               tw2lev_urb3d(ix,ind_wd(ibui,iz_u,id),iy)=twlev1D(2*id,iz_u,ibui)<a name='869'>
               sfwin1_urb3d(ix,ind_wd(ibui,iz_u,id),iy)=sfwin1D(2*id-1,iz_u,ibui)<a name='870'>
               sfwin2_urb3d(ix,ind_wd(ibui,iz_u,id),iy)=sfwin1D(2*id,iz_u,ibui)<a name='871'>
            enddo <font color=#447700>!id  <a name='872'></font>
         enddo <font color=#447700>!iz_u<a name='873'></font>
         enddo <font color=#447700>!ibui<a name='874'></font>
        <a name='875'>
         do ibui=1,nbui_max  <font color=#447700>!type of building<a name='876'></font>
            do iw=1,ngb_u <font color=#447700>!layers in the walls<a name='877'></font>
               do id=1,ndm <font color=#447700>!direction<a name='878'></font>
                  tglev_urb3d(ix,ind_gbd(ibui,iw,id),iy)=tglev1D(id,iw,ibui)<a name='879'>
               enddo <font color=#447700>!id<a name='880'></font>
            enddo <font color=#447700>!iw<a name='881'></font>
         enddo <font color=#447700>!ibui<a name='882'></font>
<a name='883'>
         do ibui=1,nbui_max  <font color=#447700>!type of building  <a name='884'></font>
            do iw=1,nf_u <font color=#447700>!layer in the walls<a name='885'></font>
               do iz_u=1,nz_um-1 <font color=#447700>!verticals levels<a name='886'></font>
                  do id=1,ndm   <font color=#447700>!direction<a name='887'></font>
                     tflev_urb3d(ix,ind_fbd(ibui,iw,iz_u,id),iy)=tflev1D(id,iw,iz_u,ibui)<a name='888'>
                  enddo <font color=#447700>!id<a name='889'></font>
               enddo <font color=#447700>!iz_u<a name='890'></font>
             enddo <font color=#447700>!iw<a name='891'></font>
         enddo <font color=#447700>!ibui<a name='892'></font>
 <a name='893'>
         sf_ac_urb3d(ix,iy)=0.<a name='894'>
         lf_ac_urb3d(ix,iy)=0.<a name='895'>
         cm_ac_urb3d(ix,iy)=0.<a name='896'>
         sfvent_urb3d(ix,iy)=0.<a name='897'>
         lfvent_urb3d(ix,iy)=0.<a name='898'>
<a name='899'>
         meso_urb=(1./4.)*FRC_URB2D(ix,iy)/((bs_urb(1,iurb)+ws_urb(1,iurb))*bs_urb(2,iurb))+ &amp;<a name='900'>
                  (1./4.)*FRC_URB2D(ix,iy)/((bs_urb(2,iurb)+ws_urb(2,iurb))*bs_urb(1,iurb))<a name='901'>
<a name='902'>
         <a name='903'>
         ibui=0<a name='904'>
         nlev=0<a name='905'>
         nbui=0<a name='906'>
         d_urb=0.<a name='907'>
         do iz=1,nz_um		   <a name='908'>
         if(ss_urb(iz,iurb).gt.0) then		<a name='909'>
           ibui=ibui+1		                <a name='910'>
           nlev(ibui)=iz-1<a name='911'>
           d_urb(ibui)=ss_urb(iz,iurb)<a name='912'>
           nbui=ibui<a name='913'>
	 endif	  <a name='914'>
         end do  <font color=#447700>!iz<a name='915'></font>
<a name='916'>
         do ibui=1,nbui       <font color=#447700>!type of building   <a name='917'></font>
         do iz_u=1,nlev(ibui) <font color=#447700>!vertical levels                    <a name='918'></font>
               sf_ac_urb3d(ix,iy)=sf_ac_urb3d(ix,iy)+meso_urb*d_urb(ibui)*sflev1D(iz_u,ibui)<a name='919'>
               lf_ac_urb3d(ix,iy)=lf_ac_urb3d(ix,iy)+meso_urb*d_urb(ibui)*lflev1D(iz_u,ibui)<a name='920'>
               cm_ac_urb3d(ix,iy)=cm_ac_urb3d(ix,iy)+meso_urb*d_urb(ibui)*consumlev1D(iz_u,ibui)<a name='921'>
               sfvent_urb3d(ix,iy)=sfvent_urb3d(ix,iy)+meso_urb*d_urb(ibui)*sfvlev1D(iz_u,ibui)<a name='922'>
               lfvent_urb3d(ix,iy)=lfvent_urb3d(ix,iy)+meso_urb*d_urb(ibui)*lfvlev1D(iz_u,ibui)            <a name='923'>
         enddo <font color=#447700>!iz_u<a name='924'></font>
         enddo <font color=#447700>!ibui<a name='925'></font>
<a name='926'>
<font color=#447700>!<a name='927'></font>
<font color=#447700>!Add the latent heat exchanged throughout the ventilation in the lf_ac_urb3d output variable. <a name='928'></font>
<font color=#447700>!it is only a rint variable<a name='929'></font>
<font color=#447700>!<a name='930'></font>
<font color=#447700>!        lf_ac_urb3d(ix,iy)=lf_ac_urb3d(ix,iy)+lfvent_urb3d(ix,iy)<a name='931'></font>
<font color=#447700>!<a name='932'></font>
<a name='933'>
         lf_ac_urb3d(ix,iy)=lf_ac_urb3d(ix,iy)-lfvent_urb3d(ix,iy)        <a name='934'>
<a name='935'>
<a name='936'>
<font color=#447700>!<a name='937'></font>
<font color=#447700>!End outputs of bem<a name='938'></font>
<font color=#447700>!<a name='939'></font>
<a name='940'>
        sf_ac=0.<a name='941'>
        sf(ix,kts:kte,iy)=0.<a name='942'>
        vl(ix,kts:kte,iy)=0.<a name='943'>
        a_u(ix,kts:kte,iy)=0.<a name='944'>
        a_v(ix,kts:kte,iy)=0.<a name='945'>
        a_t(ix,kts:kte,iy)=0.<a name='946'>
        a_e(ix,kts:kte,iy)=0.<a name='947'>
        b_u(ix,kts:kte,iy)=0.<a name='948'>
        b_v(ix,kts:kte,iy)=0.<a name='949'>
        b_t(ix,kts:kte,iy)=0.<a name='950'>
        b_e(ix,kts:kte,iy)=0.<a name='951'>
        b_q(ix,kts:kte,iy)=0.<a name='952'>
        dlg(ix,kts:kte,iy)=0.<a name='953'>
        dl_u(ix,kts:kte,iy)=0.<a name='954'>
<a name='955'>
        do iz= kts,kte<a name='956'>
          sf(ix,iz,iy)=sf1D(iz)<a name='957'>
          vl(ix,iz,iy)=vl1D(iz)<a name='958'>
          a_u(ix,iz,iy)=a_u1D(iz)<a name='959'>
          a_v(ix,iz,iy)=a_v1D(iz)<a name='960'>
          a_t(ix,iz,iy)=a_t1D(iz)<a name='961'>
          a_e(ix,iz,iy)=a_e1D(iz)<a name='962'>
          b_u(ix,iz,iy)=b_u1D(iz)<a name='963'>
          b_v(ix,iz,iy)=b_v1D(iz)<a name='964'>
          b_t(ix,iz,iy)=b_t1D(iz)<a name='965'>
          sf_ac=sf_ac+b_ac1D(iz)*da1D(iz)*cp_u*dz8w(ix,iz,iy)*vl1D(iz)*FRC_URB2D(ix,iy)<a name='966'>
          b_e(ix,iz,iy)=b_e1D(iz)<a name='967'>
          b_q(ix,iz,iy)=b_q1D(iz)<a name='968'>
          dlg(ix,iz,iy)=dlg1D(iz)<a name='969'>
          dl_u(ix,iz,iy)=dl_u1D(iz)<a name='970'>
        enddo<a name='971'>
        sf(ix,kte+1,iy)=sf1D(kte+1)<a name='972'>
<a name='973'>
         endif <font color=#447700>! FRC_URB2D<a name='974'></font>
   <a name='975'>
      enddo  <font color=#447700>! iy<a name='976'></font>
      enddo  <font color=#447700>! ix<a name='977'></font>
<a name='978'>
<a name='979'>
        time_bep=time_bep+dt<a name='980'>
<a name='981'>
      print*, 'ss_urb', ss_urb<a name='982'>
      print*, 'pb_urb', pb_urb<a name='983'>
      print*, 'nz_urb', nz_urb<a name='984'>
      print*, 'd_urb',  d_urb<a name='985'>
            <a name='986'>
      return<a name='987'>
      end subroutine BEP_BEM<a name='988'>
            <a name='989'>
<font color=#447700>! ===6=8===============================================================72<a name='990'></font>
<a name='991'>
<A NAME='BEP1D'><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='992'>
      <font color=#993300>subroutine </font><font color=#cc0000>BEP1D</font>(iurb,kms,kme,kts,kte,z,dt,ua,va,pt,da,pr,pt0,   &amp;   <A href='../../call_to/BEP1D.html' TARGET='index'>2</A>,<A href='../../call_from/BEP1D.html' TARGET='index'>27</A><a name='993'>
                      zr,deltar,ah,rs,rld,alagb,                       &amp; <a name='994'>
                      alag,alaw,alar,alaf,csgb,csg,csw,csr,csf,        &amp; <a name='995'>
                      dzr,dzf,dzw,dzgb,                                &amp;<a name='996'>
                      albg,albw,albr,albwin,emg,emw,emr,               &amp; <a name='997'>
                      emwind,fww,fwg,fgw,fsw,fws,fsg,z0,               &amp; <a name='998'>
                      ndu,strd,drst,ws,bs_u,bs,ss,pb,                  &amp; <a name='999'>
                      nzu,z_u,cop_u,pwin_u,beta_u,sw_cond_u,           &amp; <a name='1000'>
                      time_on_u,time_off_u,targtemp_u,                 &amp;<a name='1001'>
                      gaptemp_u,targhum_u,gaphum_u,perflo_u,           &amp;<a name='1002'>
                      hsesf_u,hsequip,                                 &amp;<a name='1003'>
                      tw,tg,tr,sfw,sfg,sfr,                            &amp; <a name='1004'>
                      a_u,a_v,a_t,a_e,                                 &amp;<a name='1005'>
                      b_u,b_v,b_t,b_ac,b_e,b_q,                        &amp; <a name='1006'>
                      dlg,dl_u,sf,vl,rl_up,rs_abs,emiss,grdflx_urb,    &amp;<a name='1007'>
                      qv,tlev,qlev,sflev,lflev,consumlev,              &amp;<a name='1008'>
                      sfvlev,lfvlev,twlev,tglev,tflev,sfwin,ix,iy)                             <a name='1009'>
<a name='1010'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1011'></font>
<font color=#447700>! This routine computes the effects of buildings on momentum, heat and<a name='1012'></font>
<font color=#447700>!  TKE (turbulent kinetic energy) sources or sinks and on the mixing length.<a name='1013'></font>
<font color=#447700>! It provides momentum, heat and TKE sources or sinks at different levels of a<a name='1014'></font>
<font color=#447700>!  mesoscale grid defined by the altitude of its cell interfaces "z" and<a name='1015'></font>
<font color=#447700>!  its number of levels "nz".<a name='1016'></font>
<font color=#447700>! The meteorological input parameters (wind, temperature, solar radiation)<a name='1017'></font>
<font color=#447700>!  are specified on the "mesoscale grid".<a name='1018'></font>
<font color=#447700>! The inputs concerning the building and street charateristics are defined<a name='1019'></font>
<font color=#447700>!  on a "urban grid". The "urban grid" is defined with its number of levels<a name='1020'></font>
<font color=#447700>!  "nz_u" and its space step "dz_u".<a name='1021'></font>
<font color=#447700>! The input parameters are interpolated on the "urban grid". The sources or sinks<a name='1022'></font>
<font color=#447700>!  are calculated on the "urban grid". Finally the sources or sinks are <a name='1023'></font>
<font color=#447700>!  interpolated on the "mesoscale grid".<a name='1024'></font>
 <a name='1025'>
<a name='1026'>
<font color=#447700>!  Mesoscale grid            Urban grid             Mesoscale grid<a name='1027'></font>
<font color=#447700>!  <a name='1028'></font>
<font color=#447700>! z(4)    ---                                               ---<a name='1029'></font>
<font color=#447700>!          |                                                 |<a name='1030'></font>
<font color=#447700>!          |                                                 |<a name='1031'></font>
<font color=#447700>!          |   Interpolation                  Interpolation  |<a name='1032'></font>
<font color=#447700>!          |            Sources or sinks calculation         |<a name='1033'></font>
<font color=#447700>! z(3)    ---                                               ---<a name='1034'></font>
<font color=#447700>!          | ua               ua_u  ---  uv_a         a_u    |<a name='1035'></font>
<font color=#447700>!          | va               va_u   |   uv_b         b_u    |<a name='1036'></font>
<font color=#447700>!          | pt               pt_u  ---  uh_b         a_v    |<a name='1037'></font>
<font color=#447700>! z(2)    ---                        |    etc...      etc...---<a name='1038'></font>
<font color=#447700>!          |                 z_u(1) ---                      |<a name='1039'></font>
<font color=#447700>!          |                         |                       |<a name='1040'></font>
<font color=#447700>! z(1) ------------------------------------------------------------<a name='1041'></font>
<a name='1042'>
<font color=#447700>!     <a name='1043'></font>
<font color=#447700>! Reference:<a name='1044'></font>
<font color=#447700>! Martilli, A., Clappier, A., Rotach, M.W.:2002, 'AN URBAN SURFACE EXCHANGE<a name='1045'></font>
<font color=#447700>! PARAMETERISATION FOR MESOSCALE MODELS', Boundary-Layer Meteorolgy 104:<a name='1046'></font>
<font color=#447700>! 261-304<a name='1047'></font>
 <a name='1048'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1049'></font>
<a name='1050'>
      implicit none<a name='1051'>
<a name='1052'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1053'></font>
<font color=#447700>! INPUT:<a name='1054'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1055'></font>
<a name='1056'>
<font color=#447700>! Data relative to the "mesoscale grid"<a name='1057'></font>
<a name='1058'>
<font color=#447700>!!    integer nz                 ! Number of vertical levels<a name='1059'></font>
      integer kms,kme,kts,kte<a name='1060'>
      real z(kms:kme)               <font color=#447700>! Altitude above the ground of the cell interfaces.<a name='1061'></font>
      real ua(kms:kme)                <font color=#447700>! Wind speed in the x direction<a name='1062'></font>
      real va(kms:kme)                <font color=#447700>! Wind speed in the y direction<a name='1063'></font>
      real pt(kms:kme)                <font color=#447700>! Potential temperature<a name='1064'></font>
      real da(kms:kme)                <font color=#447700>! Air density<a name='1065'></font>
      real pr(kms:kme)                <font color=#447700>! Air pressure<a name='1066'></font>
      real pt0(kms:kme)               <font color=#447700>! Reference potential temperature (could be equal to "pt")<a name='1067'></font>
      real qv(kms:kme)              <font color=#447700>! Specific humidity<a name='1068'></font>
      real dt                    <font color=#447700>! Time step<a name='1069'></font>
      real zr                    <font color=#447700>! Zenith angle<a name='1070'></font>
      real deltar                <font color=#447700>! Declination of the sun<a name='1071'></font>
      real ah                    <font color=#447700>! Hour angle<a name='1072'></font>
      real rs                    <font color=#447700>! Solar radiation<a name='1073'></font>
      real rld                   <font color=#447700>! Downward flux of the longwave radiation<a name='1074'></font>
<a name='1075'>
<font color=#447700>! Data relative to the "urban grid"<a name='1076'></font>
<a name='1077'>
      integer iurb               <font color=#447700>! Current urban class<a name='1078'></font>
<a name='1079'>
<font color=#447700>!    Radiation parameters<a name='1080'></font>
      real albg                  <font color=#447700>! Albedo of the ground<a name='1081'></font>
      real albw                  <font color=#447700>! Albedo of the wall<a name='1082'></font>
      real albr                  <font color=#447700>! Albedo of the roof<a name='1083'></font>
      real albwin                <font color=#447700>! Albedo of the windows<a name='1084'></font>
      real emwind                <font color=#447700>! Emissivity of windows<a name='1085'></font>
      real emg                   <font color=#447700>! Emissivity of ground<a name='1086'></font>
      real emw                   <font color=#447700>! Emissivity of wall<a name='1087'></font>
      real emr                   <font color=#447700>! Emissivity of roof<a name='1088'></font>
<a name='1089'>
<font color=#447700>!    fww,fwg,fgw,fsw,fsg are the view factors used to compute the long and <a name='1090'></font>
<font color=#447700>!    short wave radation. <a name='1091'></font>
<font color=#447700>!    The calculation of these factor is explained in the Appendix A of the BLM paper<a name='1092'></font>
      real fww(nz_um,nz_um,ndm,nurbm)  <font color=#447700>!  from wall to wall<a name='1093'></font>
      real fwg(nz_um,ndm,nurbm)        <font color=#447700>!  from wall to ground<a name='1094'></font>
      real fgw(nz_um,ndm,nurbm)        <font color=#447700>!  from ground to wall<a name='1095'></font>
      real fsw(nz_um,ndm,nurbm)        <font color=#447700>!  from sky to wall<a name='1096'></font>
      real fws(nz_um,ndm,nurbm)        <font color=#447700>!  from wall to sky<a name='1097'></font>
      real fsg(ndm,nurbm)              <font color=#447700>!  from sky to ground<a name='1098'></font>
      <a name='1099'>
<font color=#447700>!    Street parameters<a name='1100'></font>
      integer ndu                  <font color=#447700>! Number of street direction for each urban class <a name='1101'></font>
      real bs_u(ndm,nurbm)         <font color=#447700>! Building width<a name='1102'></font>
        <a name='1103'>
<font color=#447700>!    Grid parameters<a name='1104'></font>
      integer nzu           <font color=#447700>! Number of layer in the urban grid<a name='1105'></font>
      real z_u(nz_um)       <font color=#447700>! Height of the urban grid levels<a name='1106'></font>
<font color=#447700>!FS<a name='1107'></font>
      real cop_u(nurbm)<a name='1108'>
      real pwin_u(nurbm)<a name='1109'>
      real beta_u(nurbm)<a name='1110'>
      integer sw_cond_u(nurbm)<a name='1111'>
      real time_on_u(nurbm)<a name='1112'>
      real time_off_u(nurbm)<a name='1113'>
      real targtemp_u(nurbm)<a name='1114'>
      real gaptemp_u(nurbm)<a name='1115'>
      real targhum_u(nurbm)<a name='1116'>
      real gaphum_u(nurbm)<a name='1117'>
      real perflo_u(nurbm)<a name='1118'>
      real hsesf_u(nurbm)<a name='1119'>
      real hsequip(24)<a name='1120'>
<a name='1121'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1122'></font>
<font color=#447700>! INPUT-OUTPUT<a name='1123'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1124'></font>
<a name='1125'>
<font color=#447700>! Data relative to the "urban grid" which should be stored from the current time step to the next one<a name='1126'></font>
<a name='1127'>
      real tw(2*ndm,nz_um,nwr_u,nbui_max)  <font color=#447700>! Temperature in each layer of the wall [K]<a name='1128'></font>
      real tr(ndm,nz_um,nwr_u)  <font color=#447700>! Temperature in each layer of the roof [K]<a name='1129'></font>
      real tg(ndm,ng_u)          <font color=#447700>! Temperature in each layer of the ground [K]<a name='1130'></font>
      real sfw(2*ndm,nz_um,nbui_max)      <font color=#447700>! Sensible heat flux from walls<a name='1131'></font>
      real sfg(ndm)              <font color=#447700>! Sensible heat flux from ground (road)<a name='1132'></font>
      real sfr(ndm,nz_um)      <font color=#447700>! Sensible heat flux from roofs<a name='1133'></font>
      real gfg(ndm)             <font color=#447700>! Heat flux transferred from the surface of the ground (road) towards the interior<a name='1134'></font>
      real gfr(ndm,nz_um)     <font color=#447700>! Heat flux transferred from the surface of the roof towards the interior<a name='1135'></font>
      real gfw(2*ndm,nz_um,nbui_max)     <font color=#447700>! Heat flux transfered from the surface of the walls towards the interior<a name='1136'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1137'></font>
<font color=#447700>! OUTPUT:<a name='1138'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1139'></font>
<a name='1140'>
<font color=#447700>! Data relative to the "mesoscale grid"<a name='1141'></font>
<a name='1142'>
      real sf(kms:kme)             <font color=#447700>! Surface of the "mesoscale grid" cells taking into account the buildings<a name='1143'></font>
      real vl(kms:kme)               <font color=#447700>! Volume of the "mesoscale grid" cells taking into account the buildings<a name='1144'></font>
     <a name='1145'>
<font color=#447700>!    Implicit and explicit components of the source and sink terms at each levels,<a name='1146'></font>
<font color=#447700>!     the fluxes can be computed as follow: FX = A*X + B   example: Heat fluxes = a_t * pt + b_t<a name='1147'></font>
      real a_u(kms:kme)              <font color=#447700>! Implicit component of the momentum sources or sinks in the X-direction<a name='1148'></font>
      real a_v(kms:kme)              <font color=#447700>! Implicit component of the momentum sources or sinks in the Y-direction<a name='1149'></font>
      real a_t(kms:kme)              <font color=#447700>! Implicit component of the heat sources or sinks<a name='1150'></font>
      real a_e(kms:kme)              <font color=#447700>! Implicit component of the TKE sources or sinks<a name='1151'></font>
      real b_u(kms:kme)              <font color=#447700>! Explicit component of the momentum sources or sinks in the X-direction<a name='1152'></font>
      real b_v(kms:kme)              <font color=#447700>! Explicit component of the momentum sources or sinks in the Y-direction<a name='1153'></font>
      real b_t(kms:kme)              <font color=#447700>! Explicit component of the heat sources or sinks<a name='1154'></font>
      real b_ac(kms:kme)<a name='1155'>
      real b_e(kms:kme)              <font color=#447700>! Explicit component of the TKE sources or sinks<a name='1156'></font>
      real b_q(kms:kme)              <font color=#447700>! Explicit component of the humidity sources or sinks<a name='1157'></font>
      real dlg(kms:kme)              <font color=#447700>! Height above ground (L_ground in formula (24) of the BLM paper). <a name='1158'></font>
      real dl_u(kms:kme)             <font color=#447700>! Length scale (lb in formula (22) ofthe BLM paper).<a name='1159'></font>
    <a name='1160'>
      <a name='1161'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1162'></font>
<font color=#447700>! LOCAL:<a name='1163'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1164'></font>
<a name='1165'>
      real dz(kms:kme)               <font color=#447700>! vertical space steps of the "mesoscale grid"<a name='1166'></font>
<a name='1167'>
<font color=#447700>! Data interpolated from the "mesoscale grid" to the "urban grid"<a name='1168'></font>
<a name='1169'>
      real ua_u(nz_um)          <font color=#447700>! Wind speed in the x direction<a name='1170'></font>
      real va_u(nz_um)          <font color=#447700>! Wind speed in the y direction<a name='1171'></font>
      real pt_u(nz_um)          <font color=#447700>! Potential temperature<a name='1172'></font>
      real da_u(nz_um)          <font color=#447700>! Air density<a name='1173'></font>
      real pt0_u(nz_um)         <font color=#447700>! Reference potential temperature<a name='1174'></font>
      real pr_u(nz_um)          <font color=#447700>! Air pressure<a name='1175'></font>
      real qv_u(nz_um)          <font color=#447700>!Specific humidity<a name='1176'></font>
<a name='1177'>
<font color=#447700>! Data defining the building and street charateristics<a name='1178'></font>
<a name='1179'>
      real alag(ng_u)           <font color=#447700>! Ground thermal diffusivity for the current urban class [m^2 s^-1] <a name='1180'></font>
      <a name='1181'>
      real csg(ng_u)            <font color=#447700>! Specific heat of the ground material of the current urban class [J m^3 K^-1]<a name='1182'></font>
      real csr(nwr_u)            <font color=#447700>! Specific heat of the roof material for the current urban class [J m^3 K^-1]<a name='1183'></font>
      real csw(nwr_u)            <font color=#447700>! Specific heat of the wall material for the current urban class [J m^3 K^-1]<a name='1184'></font>
<a name='1185'>
      real z0(ndm,nz_um)      <font color=#447700>! Roughness lengths "profiles"<a name='1186'></font>
      real ws(ndm)              <font color=#447700>! Street widths of the current urban class<a name='1187'></font>
      real bs(ndm)              <font color=#447700>! Building widths of the current urban class<a name='1188'></font>
      real strd(ndm)            <font color=#447700>! Street lengths for the current urban class<a name='1189'></font>
      real drst(ndm)            <font color=#447700>! Street directions for the current urban class<a name='1190'></font>
      real ss(nz_um)          <font color=#447700>! Probability to have a building with height h<a name='1191'></font>
      real pb(nz_um)          <font color=#447700>! Probability to have a building with an height equal<a name='1192'></font>
<a name='1193'>
<font color=#447700>! Solar radiation at each level of the "urban grid"<a name='1194'></font>
<a name='1195'>
      real rsg(ndm)             <font color=#447700>! Short wave radiation from the ground<a name='1196'></font>
      real rsw(2*ndm,nz_um)     <font color=#447700>! Short wave radiation from the walls<a name='1197'></font>
      real rlg(ndm)             <font color=#447700>! Long wave radiation from the ground<a name='1198'></font>
      real rlw(2*ndm,nz_um)     <font color=#447700>! Long wave radiation from the walls<a name='1199'></font>
<a name='1200'>
<font color=#447700>! Potential temperature of the surfaces at each level of the "urban grid"<a name='1201'></font>
<a name='1202'>
      real ptg(ndm)             <font color=#447700>! Ground potential temperatures <a name='1203'></font>
      real ptr(ndm,nz_um)     <font color=#447700>! Roof potential temperatures <a name='1204'></font>
      real ptw(2*ndm,nz_um,nbui_max)     <font color=#447700>! Walls potential temperatures <a name='1205'></font>
<a name='1206'>
 <a name='1207'>
<font color=#447700>! Explicit and implicit component of the momentum, temperature and TKE sources or sinks on<a name='1208'></font>
<font color=#447700>! vertical surfaces (walls) ans horizontal surfaces (roofs and street)<a name='1209'></font>
<font color=#447700>! The fluxes can be computed as follow: Fluxes of X = A*X + B<a name='1210'></font>
<font color=#447700>! Example: Momentum fluxes on vertical surfaces = uva_u * ua_u + uvb_u<a name='1211'></font>
<a name='1212'>
      real uhb_u(ndm,nz_um)   <font color=#447700>! U (wind component) Horizontal surfaces, B (explicit) term<a name='1213'></font>
      real uva_u(2*ndm,nz_um)   <font color=#447700>! U (wind component)   Vertical surfaces, A (implicit) term<a name='1214'></font>
      real uvb_u(2*ndm,nz_um)   <font color=#447700>! U (wind component)   Vertical surfaces, B (explicit) term<a name='1215'></font>
      real vhb_u(ndm,nz_um)   <font color=#447700>! V (wind component) Horizontal surfaces, B (explicit) term<a name='1216'></font>
      real vva_u(2*ndm,nz_um)   <font color=#447700>! V (wind component)   Vertical surfaces, A (implicit) term<a name='1217'></font>
      real vvb_u(2*ndm,nz_um)   <font color=#447700>! V (wind component)   Vertical surfaces, B (explicit) term<a name='1218'></font>
      real thb_u(ndm,nz_um)   <font color=#447700>! Temperature        Horizontal surfaces, B (explicit) term<a name='1219'></font>
      real tva_u(2*ndm,nz_um)   <font color=#447700>! Temperature          Vertical surfaces, A (implicit) term<a name='1220'></font>
      real tvb_u(2*ndm,nz_um)   <font color=#447700>! Temperature          Vertical surfaces, B (explicit) term<a name='1221'></font>
      real tvb_ac(2*ndm,nz_um)<a name='1222'>
      real ehb_u(ndm,nz_um)   <font color=#447700>! Energy (TKE)       Horizontal surfaces, B (explicit) term<a name='1223'></font>
      real evb_u(2*ndm,nz_um)   <font color=#447700>! Energy (TKE)         Vertical surfaces, B (explicit) term<a name='1224'></font>
      real qhb_u(ndm,nz_um)     <font color=#447700>! Humidity      Horizontal surfaces, B (explicit) term<a name='1225'></font>
      real qvb_u(2*ndm,nz_um)   <font color=#447700>! Humidity      Vertical surfaces, B (explicit) term      <a name='1226'></font>
<font color=#447700>!<a name='1227'></font>
      real rs_abs <font color=#447700>! solar radiation absorbed by urban surfaces <a name='1228'></font>
      real rl_up <font color=#447700>! longwave radiation emitted by urban surface to the atmosphere <a name='1229'></font>
      real emiss <font color=#447700>! mean emissivity of the urban surface<a name='1230'></font>
      real grdflx_urb <font color=#447700>! ground heat flux<a name='1231'></font>
      real dt_int <font color=#447700>! internal time step<a name='1232'></font>
      integer nt_int <font color=#447700>! number of internal time step<a name='1233'></font>
      integer iz,id, it_int<a name='1234'>
      integer iw,ix,iy<a name='1235'>
<a name='1236'>
<font color=#447700>!---------------------------------------<a name='1237'></font>
<font color=#447700>!New variables uses in BEM<a name='1238'></font>
<font color=#447700>!----------------------------------------<a name='1239'></font>
   <a name='1240'>
      real tmp_u(nz_um)     <font color=#447700>!Air Temperature [K]<a name='1241'></font>
<a name='1242'>
      real dzw(nwr_u)       <font color=#447700>!Layer sizes in the walls<a name='1243'></font>
      real dzr(nwr_u)       <font color=#447700>!Layer sizes in the roofs<a name='1244'></font>
      real dzf(nf_u)        <font color=#447700>!Layer sizes in the floors<a name='1245'></font>
      real dzgb(ngb_u)      <font color=#447700>!Layer sizes in the ground below the buildings<a name='1246'></font>
<a name='1247'>
      real csgb(ngb_u)      <font color=#447700>!Specific heat of the ground material below the buildings <a name='1248'></font>
                            <font color=#447700>!of the current urban class at each ground levels[J m^3 K^-1]<a name='1249'></font>
      real csf(nf_u)        <font color=#447700>!Specific heat of the floors materials in the buildings <a name='1250'></font>
                            <font color=#447700>!of the current urban class at each levels[J m^3 K^-1]<a name='1251'></font>
      real alar(nwr_u+1)    <font color=#447700>! Roof thermal diffusivity for the current urban class [W/m K]<a name='1252'></font>
      real alaw(nwr_u+1)    <font color=#447700>! Walls thermal diffusivity for the current urban class [W/m K] <a name='1253'></font>
      real alaf(nf_u+1)     <font color=#447700>! Floor thermal diffusivity at each wall layers [W/m K]     <a name='1254'></font>
      real alagb(ngb_u+1)   <font color=#447700>! Ground thermal diffusivity below the building at each wall layer [W/m K] <a name='1255'></font>
<a name='1256'>
      real sfrb(ndm,nbui_max)        <font color=#447700>! Sensible heat flux from roofs [W/m2]<a name='1257'></font>
      real gfrb(ndm,nbui_max)        <font color=#447700>! Heat flux flowing inside the roofs [W/m2]<a name='1258'></font>
      real sfwb1D(2*ndm,nz_um)    <font color=#447700>!Sensible heat flux from the walls [W/m2] <a name='1259'></font>
      real sfwin(2*ndm,nz_um,nbui_max)<font color=#447700>!Sensible heat flux from windows [W/m2]<a name='1260'></font>
      real sfwinb1D(2*ndm,nz_um)  <font color=#447700>!Sensible heat flux from windows [W/m2]<a name='1261'></font>
      real gfwb1D(2*ndm,nz_um)    <font color=#447700>!Heat flux flowing inside the walls [W/m2]<a name='1262'></font>
<a name='1263'>
      real qlev(nz_um,nbui_max)      <font color=#447700>!specific humidity [kg/kg]<a name='1264'></font>
      real qlevb1D(nz_um)         <font color=#447700>!specific humidity [kg/kg] <a name='1265'></font>
      real tlev(nz_um,nbui_max)      <font color=#447700>!Indoor temperature [K]<a name='1266'></font>
      real tlevb1D(nz_um)         <font color=#447700>!Indoor temperature [K]<a name='1267'></font>
      real twb1D(2*ndm,nwr_u,nz_um)     <font color=#447700>!Wall temperature in BEM [K]      <a name='1268'></font>
      real twlev(2*ndm,nz_um,nbui_max)     <font color=#447700>!Window temperature in BEM [K]<a name='1269'></font>
      real twlevb1D(2*ndm,nz_um)        <font color=#447700>!Window temperature in BEM [K]<a name='1270'></font>
      real tglev(ndm,ngb_u,nbui_max)        <font color=#447700>!Ground temperature below a building in BEM [K]<a name='1271'></font>
      real tglevb1D(ngb_u)               <font color=#447700>!Ground temperature below a building in BEM [K]<a name='1272'></font>
      real tflev(ndm,nf_u,nz_um-1,nbui_max)<font color=#447700>!Floor temperature in BEM[K]<a name='1273'></font>
      real tflevb1D(nf_u,nz_um-1)       <font color=#447700>!Floor temperature in BEM[K]<a name='1274'></font>
      real trb(ndm,nwr_u,nbui_max)         <font color=#447700>!Roof temperature in BEM [K]<a name='1275'></font>
      real trb1D(nwr_u)                 <font color=#447700>!Roof temperature in BEM [K]<a name='1276'></font>
      <a name='1277'>
      real sflev(nz_um,nz_um)     <font color=#447700>! sensible heat flux due to the air conditioning systems [W]<a name='1278'></font>
      real lflev(nz_um,nz_um)     <font color=#447700>! latent heat flux due to the air conditioning systems  [W]<a name='1279'></font>
      real consumlev(nz_um,nz_um) <font color=#447700>! consumption due to the air conditioning systems [W]<a name='1280'></font>
      real sflev1D(nz_um)         <font color=#447700>! sensible heat flux due to the air conditioning systems [W]<a name='1281'></font>
      real lflev1D(nz_um)         <font color=#447700>! latent heat flux due to the air conditioning systems  [W]<a name='1282'></font>
      real consumlev1D(nz_um)     <font color=#447700>! consumption due to the air conditioning systems [W]<a name='1283'></font>
      real sfvlev(nz_um,nz_um)    <font color=#447700>! sensible heat flux due to ventilation [W]<a name='1284'></font>
      real lfvlev(nz_um,nz_um)    <font color=#447700>! latent heat flux due to ventilation [W]<a name='1285'></font>
      real sfvlev1D(nz_um)        <font color=#447700>! sensible heat flux due to ventilation [W]<a name='1286'></font>
      real lfvlev1D(nz_um)        <font color=#447700>! Latent heat flux due to ventilation [W]<a name='1287'></font>
<a name='1288'>
      real ptwin(2*ndm,nz_um,nbui_max)  <font color=#447700>! window potential temperature<a name='1289'></font>
      real tw_av(2*ndm,nz_um)        <font color=#447700>! Averaged temperature of the wall surfaces<a name='1290'></font>
      real twlev_av(2*ndm,nz_um)     <font color=#447700>! Averaged temperature of the windows<a name='1291'></font>
      real sfw_av(2*ndm,nz_um)       <font color=#447700>! Averaged sensible heat from walls<a name='1292'></font>
      real sfwind_av(2*ndm,nz_um)    <font color=#447700>! Averaged sensible heat from windows<a name='1293'></font>
<a name='1294'>
      integer nbui                <font color=#447700>!Total number of different type of buildings in an urban class<a name='1295'></font>
      integer nlev(nz_um)         <font color=#447700>!Number of levels in each different type of buildings in an urban class<a name='1296'></font>
      integer ibui,ily  <a name='1297'>
      real :: nhourday   <font color=#447700>! Number of hours from midnight, local time<a name='1298'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1299'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='1300'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1301'></font>
<a name='1302'>
<font color=#447700>! Fix some usefull parameters for the computation of the sources or sinks<a name='1303'></font>
<font color=#447700>!<a name='1304'></font>
<font color=#447700>!initialize the variables inside the param routine<a name='1305'></font>
<font color=#447700>!<a name='1306'></font>
<a name='1307'>
      do iz=kts,kte<a name='1308'>
         dz(iz)=z(iz+1)-z(iz)<a name='1309'>
      end do<a name='1310'>
<a name='1311'>
<font color=#447700>! Interpolation on the "urban grid"<a name='1312'></font>
<a name='1313'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERPOL'>interpol</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERPOL_7">(kms,kme,kts,kte,nzu,z,z_u,ua,ua_u)<a name='1314'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERPOL'>interpol</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERPOL_8">(kms,kme,kts,kte,nzu,z,z_u,va,va_u)<a name='1315'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERPOL'>interpol</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERPOL_9">(kms,kme,kts,kte,nzu,z,z_u,pt,pt_u)<a name='1316'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERPOL'>interpol</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERPOL_10">(kms,kme,kts,kte,nzu,z,z_u,pt0,pt0_u)<a name='1317'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERPOL'>interpol</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERPOL_11">(kms,kme,kts,kte,nzu,z,z_u,pr,pr_u)<a name='1318'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERPOL'>interpol</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERPOL_12">(kms,kme,kts,kte,nzu,z,z_u,da,da_u)<a name='1319'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERPOL'>interpol</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERPOL_13">(kms,kme,kts,kte,nzu,z,z_u,qv,qv_u)<a name='1320'>
                   <a name='1321'>
<font color=#447700>! Compute the modification of the radiation due to the buildings<a name='1322'></font>
      <a name='1323'>
<a name='1324'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#AVERAGING_TEMP'>averaging_temp</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AVERAGING_TEMP_1">(tw,twlev,ss,pb,tw_av,twlev_av, &amp;<a name='1325'>
                          sfw_av,sfwind_av,sfw,sfwin)<a name='1326'>
     <a name='1327'>
<a name='1328'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#MODIF_RAD'>modif_rad</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODIF_RAD_2">(iurb,ndu,nzu,z_u,ws,           &amp;<a name='1329'>
                    drst,strd,ss,pb,                &amp;<a name='1330'>
                    tw_av,tg,twlev_av,albg,albw,    &amp;<a name='1331'>
                    emw,emg,pwin_u(iurb),albwin,    &amp;<a name='1332'>
                    emwind,fww,fwg,fgw,fsw,fsg,     &amp;<a name='1333'>
                    zr,deltar,ah,                   &amp;<a name='1334'>
                    rs,rld,rsw,rsg,rlw,rlg)  <a name='1335'>
<a name='1336'>
<font color=#447700>! calculation of the urban albedo and the upward long wave radiation<a name='1337'></font>
<a name='1338'>
       call <A href='../../html_code/phys/module_sf_bep_bem.F.html#UPWARD_RAD'>upward_rad</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPWARD_RAD_2">(ndu,nzu,ws,bs,sigma,pb,ss,                 &amp;<a name='1339'>
                       tg,emg,albg,rlg,rsg,sfg,                   &amp; <a name='1340'>
                       tw_av,emw,albw,rlw,rsw,sfw_av,             &amp; <a name='1341'>
                       tr,emr,albr,emwind,                        &amp;<a name='1342'>
                       albwin,twlev_av,pwin_u(iurb),sfwind_av,rld,rs,sfr, &amp; <a name='1343'>
                       rs_abs,rl_up,emiss,grdflx_urb)               <a name='1344'>
        <a name='1345'>
<font color=#447700>! Compute the surface temperatures<a name='1346'></font>
<a name='1347'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SURF_TEMP'>surf_temp</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURF_TEMP_2">(ndu,pr_u,dt,                   &amp; <a name='1348'>
                    rld,rsg,rlg,                    &amp;<a name='1349'>
                    tg,alag,csg,emg,albg,ptg,sfg,gfg)<a name='1350'>
      <a name='1351'>
<font color=#447700>! Call the BEM (Building Energy Model) routine <a name='1352'></font>
       <a name='1353'>
       do iz=1,nz_um <font color=#447700>!Compute the outdoor temperature <a name='1354'></font>
	 tmp_u(iz)=pt_u(iz)*(pr_u(iz)/p0)**(rcp_u) <a name='1355'>
       end do<a name='1356'>
<a name='1357'>
       ibui=0<a name='1358'>
       nlev=0<a name='1359'>
       nbui=0<a name='1360'>
     <a name='1361'>
       sfrb=0.     <font color=#447700>!Sensible heat flux from roof<a name='1362'></font>
       gfrb=0.     <font color=#447700>!Heat flux flowing inside the roof<a name='1363'></font>
       sfwb1D=0.   <font color=#447700>!Sensible heat flux from walls<a name='1364'></font>
       sfwinb1D=0. <font color=#447700>!Sensible heat flux from windows<a name='1365'></font>
       gfwb1D=0.   <font color=#447700>!Heat flux flowing inside the walls[W/m2]<a name='1366'></font>
<a name='1367'>
<a name='1368'>
       twb1D=0.    <font color=#447700>!Wall temperature<a name='1369'></font>
       twlevb1D=0. <font color=#447700>!Window temperature<a name='1370'></font>
       tglevb1D=0. <font color=#447700>!Ground temperature below a building<a name='1371'></font>
       tflevb1D=0. <font color=#447700>!Floor temperature     <a name='1372'></font>
       trb=0.      <font color=#447700>!Roof temperature<a name='1373'></font>
       trb1D=0.    <font color=#447700>!Roof temperature<a name='1374'></font>
<a name='1375'>
       qlevb1D=0. <font color=#447700>!Indoor humidity<a name='1376'></font>
       tlevb1D=0. <font color=#447700>!indoor temperature<a name='1377'></font>
<a name='1378'>
       sflev1D=0.    <font color=#447700>!Sensible heat flux from the a.c.<a name='1379'></font>
       lflev1D=0.    <font color=#447700>!Latent heat flux from the a.c.<a name='1380'></font>
       consumlev1D=0.<font color=#447700>!Consumption from the a.c.<a name='1381'></font>
       sfvlev1D=0.   <font color=#447700>!Sensible heat flux from the natural ventilation<a name='1382'></font>
       lfvlev1D=0.   <font color=#447700>!Latent heat flux from natural ventilation<a name='1383'></font>
<a name='1384'>
       ptw=0.        <font color=#447700>!Wall potential temperature<a name='1385'></font>
       ptwin=0.      <font color=#447700>!Window potential temperature<a name='1386'></font>
       ptr=0.        <font color=#447700>!Roof potential temperature<a name='1387'></font>
<a name='1388'>
       do iz=1,nz_um		   <a name='1389'>
         if(ss(iz).gt.0) then		<a name='1390'>
           ibui=ibui+1		                <a name='1391'>
           nlev(ibui)=iz-1<a name='1392'>
           nbui=ibui<a name='1393'>
           do id=1,ndm<a name='1394'>
              sfrb(id,ibui)=sfr(id,iz)<a name='1395'>
              do ily=1,nwr_u<a name='1396'>
                 trb(id,ily,ibui)=tr(id,iz,ily)<a name='1397'>
              enddo<a name='1398'>
           enddo<a name='1399'>
	 endif	  <a name='1400'>
       end do  <font color=#447700>!iz<a name='1401'></font>
     <a name='1402'>
<font color=#447700>!--------------------------------------------------------------------------------<a name='1403'></font>
<font color=#447700>!Loop over BEM  -----------------------------------------------------------------<a name='1404'></font>
<font color=#447700>!--------------------------------------------------------------------------------<a name='1405'></font>
<font color=#447700>!--------------------------------------------------------------------------------<a name='1406'></font>
        nhourday=ah/PI*180./15.+12.<a name='1407'>
        if (nhourday &gt;= 24) nhourday = nhourday - 24<a name='1408'>
        if (nhourday &lt; 0)  nhourday = nhourday + 24<a name='1409'>
<a name='1410'>
        do ibui=1,nbui<a name='1411'>
<a name='1412'>
         <a name='1413'>
          do iz=1,nz_um<a name='1414'>
             qlevb1D(iz)=qlev(iz,ibui)<a name='1415'>
             tlevb1D(iz)=tlev(iz,ibui) <a name='1416'>
          enddo<a name='1417'>
          <a name='1418'>
          do id=1,ndm<a name='1419'>
<a name='1420'>
             do ily=1,nwr_u<a name='1421'>
                trb1D(ily)=trb(id,ily,ibui)<a name='1422'>
             enddo<a name='1423'>
             do ily=1,ngb_u<a name='1424'>
                tglevb1D(ily)=tglev(id,ily,ibui) <a name='1425'>
             enddo<a name='1426'>
<a name='1427'>
             do ily=1,nf_u<a name='1428'>
             do iz=1,nz_um-1<a name='1429'>
               tflevb1D(ily,iz)=tflev(id,ily,iz,ibui)<a name='1430'>
             enddo<a name='1431'>
             enddo<a name='1432'>
<a name='1433'>
             do iz=1,nz_um<a name='1434'>
                sfwinb1D(2*id-1,iz)=sfwin(2*id-1,iz,ibui)<a name='1435'>
                sfwinb1D(2*id,iz)=sfwin(2*id,iz,ibui)<a name='1436'>
             enddo<a name='1437'>
<a name='1438'>
             do iz=1,nz_um<a name='1439'>
                do ily=1,nwr_u<a name='1440'>
                   twb1D(2*id-1,ily,iz)=tw(2*id-1,iz,ily,ibui)<a name='1441'>
                   twb1D(2*id,ily,iz)=tw(2*id,iz,ily,ibui)<a name='1442'>
                enddo<a name='1443'>
                sfwb1D(2*id-1,iz)=sfw(2*id-1,iz,ibui)<a name='1444'>
                sfwb1D(2*id,iz)=sfw(2*id,iz,ibui)<a name='1445'>
                twlevb1D(2*id-1,iz)=twlev(2*id-1,iz,ibui)<a name='1446'>
                twlevb1D(2*id,iz)=twlev(2*id,iz,ibui)<a name='1447'>
             enddo<a name='1448'>
          enddo<a name='1449'>
       <a name='1450'>
         <font color=#447700>!print*,'nz_um',nz_um<a name='1451'></font>
         <font color=#447700>!print*,'nlev(ibui)',nlev(ibui)<a name='1452'></font>
         <font color=#447700>!print*,'nhourday',nhourday<a name='1453'></font>
         <font color=#447700>!print*,'dt',dt<a name='1454'></font>
         <font color=#447700>!print*, 'bs_u(1,iurb)',bs_u(1,iurb)<a name='1455'></font>
         <font color=#447700>!print*, 'bs_u(2,iurb)',bs_u(2,iurb)<a name='1456'></font>
         <font color=#447700>!print*, 'dz_u',dz_u<a name='1457'></font>
         <font color=#447700>!print*, 'nwr_u',nwr_u<a name='1458'></font>
         <font color=#447700>!print*, 'nf_u',nf_u<a name='1459'></font>
         <font color=#447700>!print*, 'nwr_u', nwr_u<a name='1460'></font>
         <font color=#447700>!print*, 'ngb_u',ngb_u<a name='1461'></font>
         <font color=#447700>!print*, 'sfwb1D',sfwb1D<a name='1462'></font>
         <font color=#447700>!print*, 'gfwb1D',gfwb1D<a name='1463'></font>
         <font color=#447700>!print*, 'sfwinb1D',sfwinb1D<a name='1464'></font>
         <font color=#447700>!print*, 'sfrb(1,ibui)',sfrb(1,ibui)<a name='1465'></font>
         <font color=#447700>!print*, 'gfrb(1,ibui)',gfrb(1,ibui)<a name='1466'></font>
         <font color=#447700>!print*, 'latent',latent<a name='1467'></font>
         <font color=#447700>!print*,  'sigma',sigma<a name='1468'></font>
         <font color=#447700>!print*, 'albw_u(iurb)',albw<a name='1469'></font>
         <font color=#447700>!print*, 'albwin_u(iurb)',albwin<a name='1470'></font>
         <font color=#447700>!print*, 'albr_u(iurb)',albr<a name='1471'></font>
         <font color=#447700>!print*, 'emr_u(iurb)',emr<a name='1472'></font>
         <font color=#447700>!print*, 'emw_u(iurb)',emw<a name='1473'></font>
         <font color=#447700>!print*, 'emwind_u(iurb)',emwind<a name='1474'></font>
         <font color=#447700>!print*, 'rsw',rsw<a name='1475'></font>
         <font color=#447700>!print*, 'rlw',rlw<a name='1476'></font>
         <font color=#447700>!print*, 'r',r<a name='1477'></font>
         <font color=#447700>!print*, 'cp_u',cp_u<a name='1478'></font>
         <font color=#447700>!print*, 'da_u',da_u<a name='1479'></font>
         <font color=#447700>!print*, 'tmp_u',tmp_u<a name='1480'></font>
         <font color=#447700>!print*, 'qv_u',qv_u<a name='1481'></font>
         <font color=#447700>!print*, 'pr_u',pr_u<a name='1482'></font>
         <font color=#447700>!print*, 'rs',rs<a name='1483'></font>
         <font color=#447700>!print*, 'rld',rld<a name='1484'></font>
         <font color=#447700>!print*, 'dzw',dzw<a name='1485'></font>
         <font color=#447700>!print*, 'csw',csw<a name='1486'></font>
         <font color=#447700>!print*, 'alaw',alaw<a name='1487'></font>
         <font color=#447700>!print*, 'pwin_u',pwin_u<a name='1488'></font>
         <font color=#447700>!print*, 'cop_u(iurb)',cop_u(iurb)<a name='1489'></font>
         <font color=#447700>!print*, 'beta_u(iurb)',beta_u(iurb)<a name='1490'></font>
         <font color=#447700>!print*, 'sw_cond_u(iurb)',sw_cond_u(iurb)<a name='1491'></font>
         <font color=#447700>!print*, 'time_on_u(iurb)',time_on_u(iurb)<a name='1492'></font>
         <font color=#447700>!print*, 'time_off_u(iurb)',time_off_u(iurb)<a name='1493'></font>
         <font color=#447700>!print*, 'targtemp_u(iurb)',targtemp_u(iurb)<a name='1494'></font>
         <font color=#447700>!print*, 'gaptemp_u(iurb)',gaptemp_u(iurb)<a name='1495'></font>
         <font color=#447700>!print*, 'targhum_u(iurb)',targhum_u(iurb)<a name='1496'></font>
         <font color=#447700>!print*, 'gaphum_u(iurb)',gaphum_u(iurb)<a name='1497'></font>
         <font color=#447700>!print*, 'perflo_u(iurb)',perflo_u(iurb)<a name='1498'></font>
         <font color=#447700>!print*, 'hsesf_u(iurb)',hsesf_u(iurb)<a name='1499'></font>
         <font color=#447700>!print*, 'hsequip',hsequip<a name='1500'></font>
         <font color=#447700>!print*, 'dzf',dzf<a name='1501'></font>
         <font color=#447700>!print*, 'csf',csf<a name='1502'></font>
         <font color=#447700>!print*, 'alaf',alaf<a name='1503'></font>
         <font color=#447700>!print*, 'dzgb',dzgb<a name='1504'></font>
         <font color=#447700>!print*, 'csgb',csgb<a name='1505'></font>
         <font color=#447700>!print*, 'alagb',alagb<a name='1506'></font>
         <font color=#447700>!print*, 'dzr',dzr<a name='1507'></font>
         <font color=#447700>!print*, 'csr',csr<a name='1508'></font>
         <font color=#447700>!print*, 'alar',alar<a name='1509'></font>
         <font color=#447700>!print*, 'tlevb1D',tlevb1D<a name='1510'></font>
         <font color=#447700>!print*, 'qlevb1D',qlevb1D<a name='1511'></font>
         <font color=#447700>!print*, 'twb1D',twb1D<a name='1512'></font>
         <font color=#447700>!print*, 'twlevb1D',twlevb1D<a name='1513'></font>
         <font color=#447700>!print*, 'tflevb1D',tflevb1D<a name='1514'></font>
         <font color=#447700>!print*, 'tglevb1D',tglevb1D<a name='1515'></font>
         <font color=#447700>!print*, 'trb1D',trb1D<a name='1516'></font>
         <font color=#447700>!print*, 'sflev1D',sflev1D<a name='1517'></font>
         <font color=#447700>!print*, 'lflev1D',lflev1D<a name='1518'></font>
         <font color=#447700>!print*, 'consumlev1D',consumlev1D<a name='1519'></font>
         <font color=#447700>!print*, 'sfvlev1D',sfvlev1D<a name='1520'></font>
         <font color=#447700>!print*, 'lfvlev1D',lfvlev1D<a name='1521'></font>
<a name='1522'>
<a name='1523'>
<a name='1524'>
<a name='1525'>
     <a name='1526'>
         <a name='1527'>
          call <A href='../../html_code/phys/module_sf_bem.F.html#BEM'>BEM</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BEM_1">(nz_um,nlev(ibui),nhourday,dt,bs_u(1,iurb),                &amp;<a name='1528'>
                   bs_u(2,iurb),dz_u,nwr_u,nf_u,nwr_u,ngb_u,sfwb1D,gfwb1D,   &amp;<a name='1529'>
                   sfwinb1D,sfrb(1,ibui),gfrb(1,ibui),                       &amp;<a name='1530'>
                   latent,sigma,albw,albwin,albr,                            &amp;<a name='1531'>
     	           emr,emw,emwind,rsw,rlw,r,cp_u,                            &amp;<a name='1532'>
     	           da_u,tmp_u,qv_u,pr_u,rs,rld,dzw,csw,alaw,pwin_u(iurb),    &amp;<a name='1533'>
                   cop_u(iurb),beta_u(iurb),sw_cond_u(iurb),time_on_u(iurb), &amp;<a name='1534'>
                   time_off_u(iurb),targtemp_u(iurb),gaptemp_u(iurb),        &amp;<a name='1535'>
                   targhum_u(iurb),gaphum_u(iurb),perflo_u(iurb),            &amp;<a name='1536'>
                   hsesf_u(iurb),hsequip,                                    &amp;<a name='1537'>
     	           dzf,csf,alaf,dzgb,csgb,alagb,dzr,csr,                     &amp;<a name='1538'>
     	           alar,tlevb1D,qlevb1D,twb1D,twlevb1D,tflevb1D,tglevb1D,    &amp;<a name='1539'>
     	           trb1D,sflev1D,lflev1D,consumlev1D,sfvlev1D,lfvlev1D)      <a name='1540'>
<a name='1541'>
         <font color=#447700>!print*,'nz_um A',nz_um<a name='1542'></font>
         <font color=#447700>!print*,'nlev(ibui) A',nlev(ibui)<a name='1543'></font>
         <font color=#447700>!print*,'nhourday A',nhourday<a name='1544'></font>
         <font color=#447700>!print*,'dt A',dt<a name='1545'></font>
         <font color=#447700>!print*, 'bs_u(1,iurb) A',bs_u(1,iurb)<a name='1546'></font>
         <font color=#447700>!print*, 'bs_u(2,iurb) A',bs_u(2,iurb)<a name='1547'></font>
         <font color=#447700>!print*, 'dz_u A',dz_u<a name='1548'></font>
         <font color=#447700>!print*, 'nwr_u A',nwr_u<a name='1549'></font>
         <font color=#447700>!print*, 'nf_u A',nf_u<a name='1550'></font>
         <font color=#447700>!print*, 'nwr_u A', nwr_u<a name='1551'></font>
         <font color=#447700>!print*, 'ngb_u A',ngb_u<a name='1552'></font>
         <font color=#447700>!print*, 'sfwb1D A',sfwb1D<a name='1553'></font>
         <font color=#447700>!print*, 'gfwb1D A',gfwb1D<a name='1554'></font>
         <font color=#447700>!print*, 'sfwinb1D A',sfwinb1D<a name='1555'></font>
         <font color=#447700>!print*, 'sfrb(1,ibui) A',sfrb(1,ibui)<a name='1556'></font>
         <font color=#447700>!print*, 'gfrb(1,ibui) A',gfrb(1,ibui)<a name='1557'></font>
         <font color=#447700>!print*, 'latent A',latent<a name='1558'></font>
         <font color=#447700>!print*,  'sigma A',sigma<a name='1559'></font>
         <font color=#447700>!print*, 'albw_u(iurb) A',albw<a name='1560'></font>
         <font color=#447700>!print*, 'albwin_u(iurb) A',albwin<a name='1561'></font>
         <font color=#447700>!print*, 'albr_u(iurb) A',albr<a name='1562'></font>
         <font color=#447700>!print*, 'emr_u(iurb) A',emr<a name='1563'></font>
         <font color=#447700>!print*, 'emw_u(iurb) A',emw<a name='1564'></font>
         <font color=#447700>!print*, 'emwind_u(iurb) A',emwind<a name='1565'></font>
         <font color=#447700>!print*, 'rsw A',rsw<a name='1566'></font>
         <font color=#447700>!print*, 'rlw A',rlw<a name='1567'></font>
         <font color=#447700>!print*, 'r A',r<a name='1568'></font>
         <font color=#447700>!print*, 'cp_u A',cp_u<a name='1569'></font>
         <font color=#447700>!print*, 'da_u A',da_u<a name='1570'></font>
         <font color=#447700>!print*, 'tmp_u A',tmp_u<a name='1571'></font>
         <font color=#447700>!print*, 'qv_u A',qv_u<a name='1572'></font>
         <font color=#447700>!print*, 'pr_u A',pr_u<a name='1573'></font>
         <font color=#447700>!print*, 'rs A',rs<a name='1574'></font>
         <font color=#447700>!print*, 'rld A',rld<a name='1575'></font>
         <font color=#447700>!print*, 'dzw A',dzw<a name='1576'></font>
         <font color=#447700>!print*, 'csw A',csw<a name='1577'></font>
         <font color=#447700>!print*, 'alaw A',alaw<a name='1578'></font>
         <font color=#447700>!print*, 'pwin_u A',pwin_u<a name='1579'></font>
         <font color=#447700>!print*, 'cop_u(iurb) A',cop_u(iurb)<a name='1580'></font>
         <font color=#447700>!print*, 'beta_u(iurb) A',beta_u(iurb)<a name='1581'></font>
         <font color=#447700>!print*, 'sw_cond_u(iurb) A',sw_cond_u(iurb)<a name='1582'></font>
         <font color=#447700>!print*, 'time_on_u(iurb) A',time_on_u(iurb)<a name='1583'></font>
         <font color=#447700>!!print*, 'time_off_u(iurb) A',time_off_u(iurb)<a name='1584'></font>
         <font color=#447700>!print*, 'targtemp_u(iurb) A',targtemp_u(iurb)<a name='1585'></font>
         <font color=#447700>!print*, 'gaptemp_u(iurb) A ',gaptemp_u(iurb)<a name='1586'></font>
         <font color=#447700>!print*, 'targhum_u(iurb) A ',targhum_u(iurb)<a name='1587'></font>
         <font color=#447700>!print*, 'gaphum_u(iurb) A',gaphum_u(iurb)<a name='1588'></font>
         <font color=#447700>!print*, 'perflo_u(iurb) A',perflo_u(iurb)<a name='1589'></font>
         <font color=#447700>!print*, 'hsesf_u(iurb) A',hsesf_u(iurb)<a name='1590'></font>
         <font color=#447700>!print*, 'hsequip A',hsequip<a name='1591'></font>
         <font color=#447700>!print*, 'dzf A',dzf<a name='1592'></font>
         <font color=#447700>!print*, 'csf A',csf<a name='1593'></font>
         <font color=#447700>!print*, 'alaf A',alaf<a name='1594'></font>
         <font color=#447700>!print*, 'dzgb A',dzgb<a name='1595'></font>
         <font color=#447700>!print*, 'csgb A',csgb<a name='1596'></font>
         <font color=#447700>!print*, 'alagb A',alagb<a name='1597'></font>
         <font color=#447700>!print*, 'dzr A',dzr<a name='1598'></font>
         <font color=#447700>!print*, 'csr A',csr<a name='1599'></font>
         <font color=#447700>!print*, 'alar A',alar<a name='1600'></font>
         <font color=#447700>!print*, 'tlevb1D A',tlevb1D<a name='1601'></font>
         <font color=#447700>!print*, 'qlevb1D A',qlevb1D<a name='1602'></font>
         <font color=#447700>!print*, 'twb1D A',twb1D<a name='1603'></font>
         <font color=#447700>!print*, 'twlevb1D A',twlevb1D<a name='1604'></font>
         <font color=#447700>!print*, 'tflevb1D A',tflevb1D<a name='1605'></font>
         <font color=#447700>!print*, 'tglevb1D A',tglevb1D<a name='1606'></font>
         <font color=#447700>!print*, 'trb1D A',trb1D<a name='1607'></font>
         <font color=#447700>!print*, 'sflev1D A',sflev1D<a name='1608'></font>
         <font color=#447700>!print*, 'lflev1D A',lflev1D<a name='1609'></font>
         <font color=#447700>!print*, 'consumlev1D A',consumlev1D<a name='1610'></font>
         <font color=#447700>!print*, 'sfvlev1D A',sfvlev1D<a name='1611'></font>
         <font color=#447700>!print*, 'lfvlev1D A',lfvlev1D<a name='1612'></font>
<a name='1613'>
        <a name='1614'>
<font color=#447700>!<a name='1615'></font>
<font color=#447700>!Temporal modifications<a name='1616'></font>
<font color=#447700>!<a name='1617'></font>
         sfrb(2,ibui)=sfrb(1,ibui)<a name='1618'>
         gfrb(2,ibui)=gfrb(1,ibui)<a name='1619'>
<font color=#447700>!<a name='1620'></font>
<font color=#447700>!End temporal modifications  <a name='1621'></font>
<font color=#447700>!        <a name='1622'></font>
           do iz=1,nz_um<a name='1623'>
             qlev(iz,ibui)=qlevb1D(iz)<a name='1624'>
             tlev(iz,ibui)=tlevb1D(iz)<a name='1625'>
             sflev(iz,ibui)=sflev1D(iz)<a name='1626'>
             lflev(iz,ibui)=lflev1D(iz)<a name='1627'>
             consumlev(iz,ibui)=consumlev1D(iz)<a name='1628'>
             sfvlev(iz,ibui)=sfvlev1D(iz)<a name='1629'>
             lfvlev(iz,ibui)=lfvlev1D(iz)<a name='1630'>
           enddo<a name='1631'>
 <a name='1632'>
           do id=1,ndm<a name='1633'>
              do ily=1,nwr_u<a name='1634'>
                 trb(id,ily,ibui)=trb1D(ily)<a name='1635'>
              enddo   <a name='1636'>
              do ily=1,ngb_u<a name='1637'>
                 tglev(id,ily,ibui)=tglevb1D(ily) <a name='1638'>
              enddo<a name='1639'>
<a name='1640'>
              do ily=1,nf_u<a name='1641'>
              do iz=1,nz_um-1<a name='1642'>
                 tflev(id,ily,iz,ibui)=tflevb1D(ily,iz)<a name='1643'>
              enddo<a name='1644'>
              enddo<a name='1645'>
           <a name='1646'>
<font color=#447700>!!            do iz=1,nz_um<a name='1647'></font>
<font color=#447700>!!               sfwin(2*id-1,iz,ibui)=sfwinb1D(2*id-1,iz)<a name='1648'></font>
<font color=#447700>!!               sfwin(2*id,iz,ibui)=sfwinb1D(2*id,iz)<a name='1649'></font>
<font color=#447700>!!            enddo<a name='1650'></font>
<a name='1651'>
             do iz=1,nz_um<a name='1652'>
                do ily=1,nwr_u<a name='1653'>
                   tw(2*id-1,iz,ily,ibui)=twb1D(2*id-1,ily,iz)<a name='1654'>
                   tw(2*id,iz,ily,ibui)=twb1D(2*id,ily,iz)<a name='1655'>
                enddo<a name='1656'>
<font color=#447700>!!              sfw(2*id-1,iz,ibui)=sfwb1D(2*id-1,iz)<a name='1657'></font>
<font color=#447700>!!              sfw(2*id,iz,ibui)=sfwb1D(2*id,iz)<a name='1658'></font>
                gfw(2*id-1,iz,ibui)=gfwb1D(2*id-1,iz)<a name='1659'>
                gfw(2*id,iz,ibui)=gfwb1D(2*id,iz)<a name='1660'>
                twlev(2*id-1,iz,ibui)=twlevb1D(2*id-1,iz)<a name='1661'>
                twlev(2*id,iz,ibui)=twlevb1D(2*id,iz)<a name='1662'>
             enddo<a name='1663'>
           enddo       <a name='1664'>
<a name='1665'>
        enddo <font color=#447700>!ibui   <a name='1666'></font>
        <a name='1667'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1668'></font>
<font color=#447700>!End loop over BEM -----------------------------------------------------------<a name='1669'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1670'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1671'></font>
<a name='1672'>
       ibui=0<a name='1673'>
<a name='1674'>
       do iz=1,nz_um	<a name='1675'>
	   <a name='1676'>
         if(ss(iz).gt.0) then		<a name='1677'>
           ibui=ibui+1	<a name='1678'>
           do id=1,ndm	<a name='1679'>
              gfr(id,iz)=gfrb(id,ibui)<a name='1680'>
              sfr(id,iz)=sfrb(id,ibui)<a name='1681'>
              do ily=1,nwr_u<a name='1682'>
                 tr(id,iz,ily)=trb(id,ily,ibui)<a name='1683'>
              enddo<a name='1684'>
              ptr(id,iz)=tr(id,iz,nwr_u)*(pr_u(iz)/p0)**(-rcp_u)<a name='1685'>
           enddo<a name='1686'>
         endif<a name='1687'>
       enddo <font color=#447700>!iz<a name='1688'></font>
<a name='1689'>
<font color=#447700>!Compute the potential temperature for the vertical surfaces of the buildings<a name='1690'></font>
<a name='1691'>
       do id=1,ndm<a name='1692'>
          do iz=1,nz_um<a name='1693'>
             do ibui=1,nbui<a name='1694'>
                ptw(2*id-1,iz,ibui)=tw(2*id-1,iz,nwr_u,ibui)*(pr_u(iz)/p0)**(-rcp_u) <a name='1695'>
                ptw(2*id,iz,ibui)=tw(2*id,iz,nwr_u,ibui)*(pr_u(iz)/p0)**(-rcp_u) <a name='1696'>
                ptwin(2*id-1,iz,ibui)=twlev(2*id-1,iz,ibui)*(pr_u(iz)/p0)**(-rcp_u) <a name='1697'>
                ptwin(2*id,iz,ibui)=twlev(2*id,iz,ibui)*(pr_u(iz)/p0)**(-rcp_u) <a name='1698'>
             enddo<a name='1699'>
          enddo<a name='1700'>
       enddo<a name='1701'>
             <a name='1702'>
        <a name='1703'>
<font color=#447700>! Compute the implicit and explicit components of the sources or sinks on the "urban grid"<a name='1704'></font>
     <a name='1705'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#BUILDINGS'>buildings</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BUILDINGS_2">(iurb,ndu,nzu,z0,ua_u,va_u,                               &amp; <a name='1706'>
                     pt_u,pt0_u,ptg,ptr,da_u,ptw,ptwin,pwin_u(iurb),drst,     &amp;                      <a name='1707'>
                     uva_u,vva_u,uvb_u,vvb_u,tva_u,tvb_u,evb_u,qvb_u,qhb_u,   &amp; <a name='1708'>
                     uhb_u,vhb_u,thb_u,ehb_u,ss,dt,sfw,sfg,sfr,               &amp;<a name='1709'>
                     sfwin,pb,bs_u,dz_u,sflev,lflev,sfvlev,lfvlev,tvb_ac)  <a name='1710'>
      <a name='1711'>
<font color=#447700>! Calculation of the sensible heat fluxes for the ground, the wall and roof<a name='1712'></font>
<font color=#447700>! Sensible Heat Flux = density * Cp_U * ( A* potential temperature + B )<a name='1713'></font>
<font color=#447700>! where A and B are the implicit and explicit components of the heat sources or sinks.<a name='1714'></font>
      <a name='1715'>
<font color=#447700>! Interpolation on the "mesoscale grid"<a name='1716'></font>
<a name='1717'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#URBAN_MESO'>urban_meso</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="URBAN_MESO_2">(ndu,kms,kme,kts,kte,nzu,z,dz,z_u,pb,ss,bs,ws,sf, &amp; <a name='1718'>
                     vl,uva_u,vva_u,uvb_u,vvb_u,tva_u,tvb_u,evb_u,     &amp;<a name='1719'>
                     uhb_u,vhb_u,thb_u,ehb_u,qhb_u,qvb_u,              &amp;<a name='1720'>
                     a_u,a_v,a_t,a_e,b_u,b_v,b_t,b_e,b_q,tvb_ac,b_ac)                    <a name='1721'>
       <a name='1722'>
<a name='1723'>
<font color=#447700>! Calculation of the length scale taking into account the buildings effects<a name='1724'></font>
<a name='1725'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERP_LENGTH'>interp_length</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_LENGTH_2">(ndu,kms,kme,kts,kte,nzu,z_u,z,ss,ws,bs,dlg,dl_u)<a name='1726'>
      <a name='1727'>
      return<a name='1728'>
      end subroutine BEP1D<a name='1729'>
<a name='1730'>
<font color=#447700>! ===6=8===============================================================72<a name='1731'></font>
<font color=#447700>! ===6=8===============================================================72<a name='1732'></font>
<a name='1733'>
<A NAME='PARAM'><A href='../../html_code/phys/module_sf_bep_bem.F.html#PARAM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1734'>
       <font color=#993300>subroutine </font><font color=#cc0000>param</font>(iurb,nzu,nzurb,nzurban,ndu,                   &amp; <A href='../../call_to/PARAM.html' TARGET='index'>2</A><a name='1735'>
                       csg_u,csg,alag_u,alag,csr_u,csr,               &amp;<a name='1736'>
                       alar_u,alar,csw_u,csw,alaw_u,alaw,             &amp;<a name='1737'>
                       ws_u,ws_urb,ws,bs_u,bs_urb,bs,z0g_u,z0r_u,z0,  &amp;  <a name='1738'>
                       strd_u,strd,drst_u,drst,ss_u,ss_urb,ss,pb_u,   &amp;<a name='1739'>
                       pb_urb,pb,dzw,dzr,dzf,csf,alaf,dzgb,csgb,alagb,&amp;<a name='1740'>
                       lp_urb,lb_urb,hgt_urb,frc_urb)        <a name='1741'>
<a name='1742'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1743'></font>
<font color=#447700>!    This routine prepare some usefull parameters       <a name='1744'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1745'></font>
<a name='1746'>
      implicit none<a name='1747'>
<a name='1748'>
  <a name='1749'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1750'></font>
<font color=#447700>! INPUT:<a name='1751'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1752'></font>
      integer iurb                 <font color=#447700>! Current urban class<a name='1753'></font>
      integer nzu                  <font color=#447700>! Number of vertical urban levels in the current class<a name='1754'></font>
      integer ndu                  <font color=#447700>! Number of street direction for the current urban class<a name='1755'></font>
      integer nzurb                <font color=#447700>! Number of vertical urban levels in the current class<a name='1756'></font>
      real alag_u(nurbm)           <font color=#447700>! Ground thermal diffusivity [m^2 s^-1]<a name='1757'></font>
      real alar_u(nurbm)           <font color=#447700>! Roof thermal diffusivity [m^2 s^-1]<a name='1758'></font>
      real alaw_u(nurbm)           <font color=#447700>! Wall thermal diffusivity [m^2 s^-1]<a name='1759'></font>
      real bs_u(ndm,nurbm)         <font color=#447700>! Building width<a name='1760'></font>
      real csg_u(nurbm)            <font color=#447700>! Specific heat of the ground material [J m^3 K^-1]<a name='1761'></font>
      real csr_u(nurbm)            <font color=#447700>! Specific heat of the roof material [J m^3 K^-1]<a name='1762'></font>
      real csw_u(nurbm)            <font color=#447700>! Specific heat of the wall material [J m^3 K^-1]<a name='1763'></font>
      real drst_u(ndm,nurbm)       <font color=#447700>! Street direction<a name='1764'></font>
      real strd_u(ndm,nurbm)       <font color=#447700>! Street length <a name='1765'></font>
      real ws_u(ndm,nurbm)         <font color=#447700>! Street width<a name='1766'></font>
      real z0g_u(nurbm)            <font color=#447700>! The ground's roughness length<a name='1767'></font>
      real z0r_u(nurbm)            <font color=#447700>! The roof's roughness length<a name='1768'></font>
      real ss_u(nz_um,nurbm)       <font color=#447700>! The probability that a building has an height equal to "z"<a name='1769'></font>
      real pb_u(nz_um,nurbm)       <font color=#447700>! The probability that a building has an height greater or equal to "z"<a name='1770'></font>
      real lp_urb                <font color=#447700>! Building plan area density<a name='1771'></font>
      real lb_urb                <font color=#447700>! Building surface area to plan area ratio<a name='1772'></font>
      real hgt_urb               <font color=#447700>! Average building height weighted by building plan area [m]<a name='1773'></font>
      real frc_urb               <font color=#447700>! Urban fraction<a name='1774'></font>
<a name='1775'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1776'></font>
<font color=#447700>! OUTPUT:<a name='1777'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1778'></font>
      real alag(ng_u)           <font color=#447700>! Ground thermal diffusivity at each ground levels<a name='1779'></font>
      real csg(ng_u)            <font color=#447700>! Specific heat of the ground material at each ground levels<a name='1780'></font>
      real bs(ndm)              <font color=#447700>! Building width for the current urban class<a name='1781'></font>
      real drst(ndm)            <font color=#447700>! street directions for the current urban class<a name='1782'></font>
      real strd(ndm)            <font color=#447700>! Street lengths for the current urban class<a name='1783'></font>
      real ws(ndm)              <font color=#447700>! Street widths of the current urban class<a name='1784'></font>
      real z0(ndm,nz_um)      <font color=#447700>! Roughness lengths "profiles"<a name='1785'></font>
      real ss(nz_um)          <font color=#447700>! Probability to have a building with height h<a name='1786'></font>
      real pb(nz_um)          <font color=#447700>! Probability to have a building with an height greater or equal to "z"<a name='1787'></font>
      integer nzurban<a name='1788'>
<a name='1789'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1790'></font>
<font color=#447700>!INPUT/OUTPUT<a name='1791'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1792'></font>
<a name='1793'>
      real dzw(nwr_u)       <font color=#447700>!Layer sizes in the walls [m]<a name='1794'></font>
      real dzr(nwr_u)       <font color=#447700>!Layer sizes in the roofs [m]<a name='1795'></font>
      real dzf(nf_u)        <font color=#447700>!Layer sizes in the floors [m]<a name='1796'></font>
      real dzgb(ngb_u)      <font color=#447700>!layer sizes in the ground below the buildings [m]<a name='1797'></font>
<a name='1798'>
      real csr(nwr_u)       <font color=#447700>! Specific heat of the roof material at each roof levels<a name='1799'></font>
      real csw(nwr_u)       <font color=#447700>! Specific heat of the wall material at each wall levels<a name='1800'></font>
<a name='1801'>
      real csf(nf_u)        <font color=#447700>!Specific heat of the floors materials in the buildings <a name='1802'></font>
                            <font color=#447700>!of the current urban class [J m^3 K^-1]<a name='1803'></font>
      real csgb(ngb_u)      <font color=#447700>!Specific heat of the ground material below the buildings <a name='1804'></font>
                            <font color=#447700>!of the current urban class [J m^3 K^-1]<a name='1805'></font>
      real alar(nwr_u+1)    <font color=#447700>! Roof thermal diffusivity at each roof levels [W/ m K]<a name='1806'></font>
      real alaw(nwr_u+1)    <font color=#447700>! Wall thermal diffusivity at each wall levels [W/ m K]<a name='1807'></font>
      real alaf(nf_u+1)     <font color=#447700>! Floor thermal diffusivity at each wall levels [W/m K]<a name='1808'></font>
      real alagb(ngb_u+1)   <font color=#447700>! Ground thermal diffusivity below the building at each wall levels [W/m K]<a name='1809'></font>
      real bs_urb(ndm,nurbm)         <font color=#447700>! Building width<a name='1810'></font>
      real ws_urb(ndm,nurbm)         <font color=#447700>! Street width<a name='1811'></font>
      real ss_urb(nz_um,nurbm)       <font color=#447700>! The probability that a building has an height equal to "z"<a name='1812'></font>
      real pb_urb(nz_um)             <font color=#447700>! Probability that a building has an height greater or equal to z<a name='1813'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1814'></font>
<font color=#447700>! LOCAL:<a name='1815'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1816'></font>
      integer id,ig,ir,iw,iz,iflo,ihu<a name='1817'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1818'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='1819'></font>
<font color=#447700>! ----------------------------------------------------------------------  <a name='1820'></font>
<font color=#447700>!<a name='1821'></font>
<font color=#447700>!Initialize variables<a name='1822'></font>
<font color=#447700>!<a name='1823'></font>
      ss=0.<a name='1824'>
      pb=0.<a name='1825'>
      csg=0.<a name='1826'>
      alag=0.<a name='1827'>
      csgb=0.<a name='1828'>
      alagb=0.<a name='1829'>
      csf=0.<a name='1830'>
      alaf=0.<a name='1831'>
      csr=0.<a name='1832'>
      alar=0.<a name='1833'>
      csw=0.<a name='1834'>
      alaw=0.<a name='1835'>
      z0=0.<a name='1836'>
      ws=0.<a name='1837'>
      bs=0.<a name='1838'>
      bs_urb=0.<a name='1839'>
      ws_urb=0.<a name='1840'>
      strd=0.<a name='1841'>
      drst=0.<a name='1842'>
      nzurban=0<a name='1843'>
<a name='1844'>
<font color=#447700>!Define the layer sizes in the walls<a name='1845'></font>
<a name='1846'>
      dzgb=(/0.2,0.12,0.08,0.05,0.03,0.02,0.02,0.01,0.005,0.0025/)<a name='1847'>
      dzr=(/0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.01,0.005,0.0025/)   <a name='1848'>
      dzw=(/0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.01,0.005,0.0025/)<a name='1849'>
      dzf=(/0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.02/) <a name='1850'>
  <a name='1851'>
       ihu=0<a name='1852'>
<a name='1853'>
       do iz=1,nz_um<a name='1854'>
          if (ss_urb(iz,iurb)/=0.) then<a name='1855'>
             ihu=1<a name='1856'>
             exit<a name='1857'>
          else<a name='1858'>
             continue<a name='1859'>
          endif<a name='1860'>
       enddo<a name='1861'>
<a name='1862'>
       if (ihu==1) then<a name='1863'>
          do iz=1,nzurb+1<a name='1864'>
             ss(iz)=ss_urb(iz,iurb)<a name='1865'>
             pb(iz)=pb_urb(iz)<a name='1866'>
          enddo<a name='1867'>
          nzurban=nzurb<a name='1868'>
       else<a name='1869'>
          do iz=1,nzu+1<a name='1870'>
             ss(iz)=ss_u(iz,iurb)<a name='1871'>
             pb(iz)=pb_u(iz,iurb)<a name='1872'>
             ss_urb(iz,iurb)=ss_u(iz,iurb)<a name='1873'>
             pb_urb(iz)=pb_u(iz,iurb)<a name='1874'>
          end do <a name='1875'>
          nzurban=nzu<a name='1876'>
       endif<a name='1877'>
      <a name='1878'>
      do ig=1,ngb_u<a name='1879'>
        csgb(ig) = csg_u(iurb)<a name='1880'>
        alagb(ig)= csg_u(iurb)*alag_u(iurb)<a name='1881'>
      enddo<a name='1882'>
      alagb(ngb_u+1)= csg_u(iurb)*alag_u(iurb)<a name='1883'>
<a name='1884'>
      do iflo=1,nf_u<a name='1885'>
        csf(iflo) = csw_u(iurb)<a name='1886'>
        alaf(iflo)= csw_u(iurb)*alaw_u(iurb) <a name='1887'>
      enddo<a name='1888'>
      alaf(nf_u+1)= csw_u(iurb)*alaw_u(iurb) <a name='1889'>
     <a name='1890'>
      do ir=1,nwr_u<a name='1891'>
        csr(ir) = csr_u(iurb)<a name='1892'>
        alar(ir)= csr_u(iurb)*alar_u(iurb)<a name='1893'>
      enddo<a name='1894'>
      alar(nwr_u+1)= csr_u(iurb)*alar_u(iurb)<a name='1895'>
<a name='1896'>
      do iw=1,nwr_u<a name='1897'>
        csw(iw) = csw_u(iurb)<a name='1898'>
        alaw(iw)= csw_u(iurb)*alaw_u(iurb)<a name='1899'>
      enddo<a name='1900'>
      alaw(nwr_u+1)=csw_u(iurb)*alaw_u(iurb) <a name='1901'>
<a name='1902'>
<font color=#447700>!------------------------------------------------------------------------  <a name='1903'></font>
                 <a name='1904'>
       do ig=1,ng_u<a name='1905'>
        csg(ig)=csg_u(iurb)<a name='1906'>
        alag(ig)=alag_u(iurb)<a name='1907'>
       enddo<a name='1908'>
       <a name='1909'>
       do id=1,ndu<a name='1910'>
          z0(id,1)=z0g_u(iurb)<a name='1911'>
        do iz=2,nzurban+1<a name='1912'>
           z0(id,iz)=z0r_u(iurb)<a name='1913'>
        enddo<a name='1914'>
       enddo<a name='1915'>
      <a name='1916'>
       do id=1,ndu<a name='1917'>
          strd(id)=strd_u(id,iurb)<a name='1918'>
          drst(id)=drst_u(id,iurb)     <a name='1919'>
       enddo<a name='1920'>
<a name='1921'>
       do id=1,ndu<a name='1922'>
          if ((hgt_urb&lt;=0.).OR.(lp_urb&lt;=0.).OR.(lb_urb&lt;=0.)) then<a name='1923'>
              ws(id)=ws_u(id,iurb)<a name='1924'>
              bs(id)=bs_u(id,iurb)<a name='1925'>
              bs_urb(id,iurb)=bs_u(id,iurb)<a name='1926'>
              ws_urb(id,iurb)=ws_u(id,iurb)<a name='1927'>
          else if ((lp_urb/frc_urb&lt;1.).and.(lp_urb&lt;lb_urb)) then<a name='1928'>
                  bs(id)=2.*hgt_urb*lp_urb/(lb_urb-lp_urb)<a name='1929'>
                  ws(id)=2.*hgt_urb*lp_urb*((frc_urb/lp_urb)-1.)/(lb_urb-lp_urb)<a name='1930'>
                  bs_urb(id,iurb)=bs(id)<a name='1931'>
                  ws_urb(id,iurb)=ws(id)<a name='1932'>
               else<a name='1933'>
                  ws(id)=ws_u(id,iurb)<a name='1934'>
                  bs(id)=bs_u(id,iurb)<a name='1935'>
                  bs_urb(id,iurb)=bs_u(id,iurb)<a name='1936'>
                  ws_urb(id,iurb)=ws_u(id,iurb)<a name='1937'>
          endif<a name='1938'>
       enddo<a name='1939'>
       do id=1,ndu<a name='1940'>
          if ((bs(id)&lt;=1.).OR.(bs(id)&gt;=150.)) then<a name='1941'>
<font color=#447700>!            write(*,*) 'WARNING, WIDTH OF THE BUILDING WRONG',id,bs(id)<a name='1942'></font>
<font color=#447700>!            write(*,*) 'WIDTH OF THE STREET',id,ws(id)<a name='1943'></font>
             bs(id)=bs_u(id,iurb)<a name='1944'>
             ws(id)=ws_u(id,iurb)<a name='1945'>
             bs_urb(id,iurb)=bs_u(id,iurb)<a name='1946'>
             ws_urb(id,iurb)=ws_u(id,iurb)<a name='1947'>
          endif<a name='1948'>
          if ((ws(id)&lt;=1.).OR.(ws(id)&gt;=150.)) then<a name='1949'>
<font color=#447700>!            write(*,*) 'WARNING, WIDTH OF THE STREET WRONG',id,ws(id)<a name='1950'></font>
<font color=#447700>!            write(*,*) 'WIDTH OF THE BUILDING',id,bs(id)<a name='1951'></font>
             ws(id)=ws_u(id,iurb)<a name='1952'>
             bs(id)=bs_u(id,iurb)<a name='1953'>
             bs_urb(id,iurb)=bs_u(id,iurb)<a name='1954'>
             ws_urb(id,iurb)=ws_u(id,iurb)<a name='1955'>
          endif<a name='1956'>
       enddo<a name='1957'>
       return<a name='1958'>
       end subroutine param<a name='1959'>
       <a name='1960'>
<font color=#447700>! ===6=8===============================================================72<a name='1961'></font>
<font color=#447700>! ===6=8===============================================================72<a name='1962'></font>
<a name='1963'>
<A NAME='INTERPOL'><A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERPOL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1964'>
      <font color=#993300>subroutine </font><font color=#cc0000>interpol</font>(kms,kme,kts,kte,nz_u,z,z_u,c,c_u) <A href='../../call_to/INTERPOL.html' TARGET='index'>13</A><a name='1965'>
<a name='1966'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1967'></font>
<font color=#447700>!  This routine interpolate para<a name='1968'></font>
<font color=#447700>!  meters from the "mesoscale grid" to<a name='1969'></font>
<font color=#447700>!  the "urban grid".<a name='1970'></font>
<font color=#447700>!  See p300 Appendix B.1 of the BLM paper.<a name='1971'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1972'></font>
<a name='1973'>
      implicit none<a name='1974'>
<a name='1975'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1976'></font>
<font color=#447700>! INPUT:<a name='1977'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1978'></font>
<font color=#447700>! Data relative to the "mesoscale grid"<a name='1979'></font>
      integer kts,kte,kms,kme            <a name='1980'>
      real z(kms:kme)          <font color=#447700>! Altitude of the cell interface<a name='1981'></font>
      real c(kms:kme)            <font color=#447700>! Parameter which has to be interpolated<a name='1982'></font>
<font color=#447700>! Data relative to the "urban grid"<a name='1983'></font>
      integer nz_u          <font color=#447700>! Number of levels<a name='1984'></font>
<font color=#447700>!!    real z_u(nz_u+1)      ! Altitude of the cell interface<a name='1985'></font>
      real z_u(nz_um)      <font color=#447700>! Altitude of the cell interface<a name='1986'></font>
<a name='1987'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1988'></font>
<font color=#447700>! OUTPUT:<a name='1989'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1990'></font>
<font color=#447700>!!    real c_u(nz_u)        ! Interpolated paramters in the "urban grid"<a name='1991'></font>
      real c_u(nz_um)        <font color=#447700>! Interpolated paramters in the "urban grid"      <a name='1992'></font>
 <a name='1993'>
<font color=#447700>! LOCAL:<a name='1994'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1995'></font>
      integer iz_u,iz<a name='1996'>
      real ctot,dz<a name='1997'>
<a name='1998'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1999'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='2000'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2001'></font>
<a name='2002'>
       do iz_u=1,nz_u<a name='2003'>
        ctot=0.<a name='2004'>
        do iz=kts,kte<a name='2005'>
         dz=max(min(z(iz+1),z_u(iz_u+1))-max(z(iz),z_u(iz_u)),0.)<a name='2006'>
         ctot=ctot+c(iz)*dz<a name='2007'>
        enddo<a name='2008'>
        c_u(iz_u)=ctot/(z_u(iz_u+1)-z_u(iz_u))<a name='2009'>
       enddo<a name='2010'>
       <a name='2011'>
       return<a name='2012'>
       end subroutine interpol<a name='2013'>
         <a name='2014'>
<font color=#447700>! ===6=8===============================================================72       <a name='2015'></font>
<font color=#447700>! ===6=8===============================================================72    <a name='2016'></font>
<a name='2017'>
<A NAME='AVERAGING_TEMP'><A href='../../html_code/phys/module_sf_bep_bem.F.html#AVERAGING_TEMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2018'>
      <font color=#993300>subroutine  </font><font color=#cc0000>averaging_temp</font>(tw,twlev,ss,pb,tw_av,twlev_av,       &amp; <A href='../../call_to/AVERAGING_TEMP.html' TARGET='index'>1</A><a name='2019'>
                                 sfw_av,sfwind_av,sfw,sfwin) <a name='2020'>
<a name='2021'>
      implicit none<a name='2022'>
<font color=#447700>!<a name='2023'></font>
<font color=#447700>!INPUT VARIABLES<a name='2024'></font>
<font color=#447700>!<a name='2025'></font>
      real tw(2*ndm,nz_um,nwr_u,nbui_max)        <font color=#447700>! Temperature in each layer of the wall [K]<a name='2026'></font>
      real twlev(2*ndm,nz_um,nbui_max)     <font color=#447700>! Window temperature in BEM [K]<a name='2027'></font>
      real pb(nz_um)                    <font color=#447700>! Probability to have a building with an height equal or greater h<a name='2028'></font>
      real ss(nz_um)                    <font color=#447700>! Probability to have a building with height h<a name='2029'></font>
      real sfw(2*ndm,nz_um,nbui_max)             <font color=#447700>! Surface fluxes from the walls<a name='2030'></font>
      real sfwin(2*ndm,nz_um,nbui_max)     <font color=#447700>! Surface fluxes from the windows<a name='2031'></font>
<font color=#447700>!<a name='2032'></font>
<font color=#447700>!OUTPUT VARIABLES<a name='2033'></font>
<font color=#447700>!<a name='2034'></font>
      real tw_av(2*ndm,nz_um)           <font color=#447700>! Averaged temperature of the wall surfaces<a name='2035'></font>
      real twlev_av(2*ndm,nz_um)        <font color=#447700>! Averaged temperature of the windows<a name='2036'></font>
      real sfw_av(2*ndm,nz_um)          <font color=#447700>! Averaged sensible heat from walls<a name='2037'></font>
      real sfwind_av(2*ndm,nz_um)       <font color=#447700>! Averaged sensible heat from windows<a name='2038'></font>
<font color=#447700>!<a name='2039'></font>
<font color=#447700>!LOCAL VARIABLES<a name='2040'></font>
<font color=#447700>!<a name='2041'></font>
      real d_urb(nz_um)    <a name='2042'>
      integer nlev(nz_um)            <a name='2043'>
      integer id,iz<a name='2044'>
      integer nbui,ibui<a name='2045'>
<font color=#447700>!<a name='2046'></font>
<font color=#447700>!Initialize Variables<a name='2047'></font>
<font color=#447700>!<a name='2048'></font>
      tw_av=0.<a name='2049'>
      twlev_av=0.<a name='2050'>
      sfw_av=0.<a name='2051'>
      sfwind_av=0.<a name='2052'>
      ibui=0<a name='2053'>
      nbui=0<a name='2054'>
      nlev=0<a name='2055'>
      d_urb=0.<a name='2056'>
<a name='2057'>
      do iz=1,nz_um		   <a name='2058'>
         if(ss(iz).gt.0) then		<a name='2059'>
           ibui=ibui+1<a name='2060'>
           d_urb(ibui)=ss(iz)<a name='2061'>
           nlev(ibui)=iz-1<a name='2062'>
           nbui=ibui		               <a name='2063'>
         endif<a name='2064'>
      enddo<a name='2065'>
      <a name='2066'>
      do id=1,ndm<a name='2067'>
         do iz=1,nz_um-1<a name='2068'>
            if (pb(iz+1).gt.0) then<a name='2069'>
                do ibui=1,nbui<a name='2070'>
                   if (iz.le.nlev(ibui)) then<a name='2071'>
                      tw_av(2*id-1,iz)=tw_av(2*id-1,iz)+(d_urb(ibui)/pb(iz+1))*&amp;<a name='2072'>
                                       tw(2*id-1,iz,nwr_u,ibui)**4<a name='2073'>
                      tw_av(2*id,iz)=tw_av(2*id,iz)+(d_urb(ibui)/pb(iz+1))*&amp;<a name='2074'>
                                     tw(2*id,iz,nwr_u,ibui)**4<a name='2075'>
                      twlev_av(2*id-1,iz)=twlev_av(2*id-1,iz)+(d_urb(ibui)/pb(iz+1))*&amp;<a name='2076'>
                                          twlev(2*id-1,iz,ibui)**4<a name='2077'>
                      twlev_av(2*id,iz)=twlev_av(2*id,iz)+(d_urb(ibui)/pb(iz+1))*&amp;<a name='2078'>
                                        twlev(2*id,iz,ibui)**4<a name='2079'>
                      sfw_av(2*id-1,iz)=sfw_av(2*id-1,iz)+(d_urb(ibui)/pb(iz+1))*sfw(2*id-1,iz,ibui)<a name='2080'>
                      sfw_av(2*id,iz)=sfw_av(2*id,iz)+(d_urb(ibui)/pb(iz+1))*sfw(2*id,iz,ibui)<a name='2081'>
                      sfwind_av(2*id-1,iz)=sfwind_av(2*id-1,iz)+(d_urb(ibui)/pb(iz+1))*sfwin(2*id-1,iz,ibui)<a name='2082'>
                      sfwind_av(2*id,iz)=sfwind_av(2*id,iz)+(d_urb(ibui)/pb(iz+1))*sfwin(2*id,iz,ibui)<a name='2083'>
                   endif<a name='2084'>
                enddo<a name='2085'>
                tw_av(2*id-1,iz)=tw_av(2*id-1,iz)**(1./4.)<a name='2086'>
                tw_av(2*id,iz)=tw_av(2*id,iz)**(1./4.)<a name='2087'>
                twlev_av(2*id-1,iz)=twlev_av(2*id-1,iz)**(1./4.)<a name='2088'>
                twlev_av(2*id,iz)=twlev_av(2*id,iz)**(1./4.)<a name='2089'>
            endif<a name='2090'>
         enddo <font color=#447700>!iz         <a name='2091'></font>
      enddo <font color=#447700>!id<a name='2092'></font>
      return<a name='2093'>
      end subroutine averaging_temp<a name='2094'>
<font color=#447700>! ===6=8===============================================================72       <a name='2095'></font>
<font color=#447700>! ===6=8===============================================================72    <a name='2096'></font>
<a name='2097'>
<A NAME='MODIF_RAD'><A href='../../html_code/phys/module_sf_bep_bem.F.html#MODIF_RAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2098'>
      <font color=#993300>subroutine </font><font color=#cc0000>modif_rad</font>(iurb,nd,nz_u,z,ws,drst,strd,ss,pb,    &amp; <A href='../../call_to/MODIF_RAD.html' TARGET='index'>2</A>,<A href='../../call_from/MODIF_RAD.html' TARGET='index'>6</A><a name='2099'>
                          tw,tg,twlev,albg,albw,emw,emg,pwin,albwin,   &amp;<a name='2100'>
                          emwin,fww,fwg,fgw,fsw,fsg,             &amp;<a name='2101'>
                          zr,deltar,ah,                          &amp;    <a name='2102'>
                          rs,rl,rsw,rsg,rlw,rlg)                       <a name='2103'>
 <a name='2104'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2105'></font>
<font color=#447700>! This routine computes the modification of the short wave and <a name='2106'></font>
<font color=#447700>!  long wave radiation due to the buildings.<a name='2107'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2108'></font>
<a name='2109'>
      implicit none<a name='2110'>
 <a name='2111'>
 <a name='2112'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2113'></font>
<font color=#447700>! INPUT:<a name='2114'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2115'></font>
      integer iurb              <font color=#447700>! current urban class<a name='2116'></font>
      integer nd                <font color=#447700>! Number of street direction for the current urban class<a name='2117'></font>
      integer nz_u              <font color=#447700>! Number of layer in the urban grid<a name='2118'></font>
      real z(nz_um)           <font color=#447700>! Height of the urban grid levels<a name='2119'></font>
      real ws(ndm)              <font color=#447700>! Street widths of the current urban class<a name='2120'></font>
      real drst(ndm)            <font color=#447700>! street directions for the current urban class<a name='2121'></font>
      real strd(ndm)            <font color=#447700>! Street lengths for the current urban class<a name='2122'></font>
      real ss(nz_um)          <font color=#447700>! probability to have a building with height h<a name='2123'></font>
      real pb(nz_um)          <font color=#447700>! probability to have a building with an height equal<a name='2124'></font>
      real tw(2*ndm,nz_um)    <font color=#447700>! Temperature in each layer of the wall [K]<a name='2125'></font>
      real tg(ndm,ng_u)         <font color=#447700>! Temperature in each layer of the ground [K]<a name='2126'></font>
      real albg                 <font color=#447700>! Albedo of the ground for the current urban class<a name='2127'></font>
      real albw                 <font color=#447700>! Albedo of the wall for the current urban class<a name='2128'></font>
      real emg                  <font color=#447700>! Emissivity of ground for the current urban class<a name='2129'></font>
      real emw                  <font color=#447700>! Emissivity of wall for the current urban class<a name='2130'></font>
      real fgw(nz_um,ndm,nurbm)       <font color=#447700>! View factors from ground to wall<a name='2131'></font>
      real fsg(ndm,nurbm)             <font color=#447700>! View factors from sky to ground<a name='2132'></font>
      real fsw(nz_um,ndm,nurbm)       <font color=#447700>! View factors from sky to wall<a name='2133'></font>
      real fws(nz_um,ndm,nurbm)       <font color=#447700>! View factors from wall to sky<a name='2134'></font>
      real fwg(nz_um,ndm,nurbm)       <font color=#447700>! View factors from wall to ground<a name='2135'></font>
      real fww(nz_um,nz_um,ndm,nurbm) <font color=#447700>! View factors from wall to wall<a name='2136'></font>
      real ah                   <font color=#447700>! Hour angle (it should come from the radiation routine)<a name='2137'></font>
      real zr                   <font color=#447700>! zenith angle<a name='2138'></font>
      real deltar               <font color=#447700>! Declination of the sun<a name='2139'></font>
      real rs                   <font color=#447700>! solar radiation<a name='2140'></font>
      real rl                   <font color=#447700>! downward flux of the longwave radiation<a name='2141'></font>
<font color=#447700>!<a name='2142'></font>
<font color=#447700>!New variables BEM<a name='2143'></font>
<font color=#447700>!<a name='2144'></font>
      real twlev(2*ndm,nz_um)         <font color=#447700>! Window temperature in BEM [K]<a name='2145'></font>
      real pwin                       <font color=#447700>! Coverage area fraction of windows in the walls of the buildings <a name='2146'></font>
      real albwin                     <font color=#447700>! Albedo of the windows for the current urban class<a name='2147'></font>
      real emwin                      <font color=#447700>! Emissivity of the windows for the current urban class<a name='2148'></font>
      real alb_av                     <font color=#447700>! Averaged albedo (window and wall)<a name='2149'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2150'></font>
<font color=#447700>! OUTPUT:<a name='2151'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2152'></font>
      real rlg(ndm)             <font color=#447700>! Long wave radiation at the ground<a name='2153'></font>
      real rlw(2*ndm,nz_um)     <font color=#447700>! Long wave radiation at the walls<a name='2154'></font>
      real rsg(ndm)             <font color=#447700>! Short wave radiation at the ground<a name='2155'></font>
      real rsw(2*ndm,nz_um)     <font color=#447700>! Short wave radiation at the walls<a name='2156'></font>
<a name='2157'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2158'></font>
<font color=#447700>! LOCAL:<a name='2159'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2160'></font>
<a name='2161'>
      integer id,iz<a name='2162'>
<a name='2163'>
<font color=#447700>!  Calculation of the shadow effects<a name='2164'></font>
<a name='2165'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SHADOW_MAS'>shadow_mas</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#MODIF_RAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHADOW_MAS_2">(nd,nz_u,zr,deltar,ah,drst,ws,ss,pb,z,        &amp;<a name='2166'>
                     rs,rsw,rsg)<a name='2167'>
<a name='2168'>
<font color=#447700>! Calculation of the reflection effects          <a name='2169'></font>
      do id=1,nd<a name='2170'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#LONG_RAD'>long_rad</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#MODIF_RAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LONG_RAD_2">(iurb,nz_u,id,emw,emg,emwin,pwin,twlev,      &amp;<a name='2171'>
                      fwg,fww,fgw,fsw,fsg,tg,tw,rlg,rlw,rl,pb)<a name='2172'>
<a name='2173'>
         alb_av=pwin*albwin+(1.-pwin)*albw<a name='2174'>
         <a name='2175'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SHORT_RAD'>short_rad</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#MODIF_RAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHORT_RAD_2">(iurb,nz_u,id,alb_av,albg,fwg,fww,fgw,rsg,rsw,pb)<a name='2176'>
  <a name='2177'>
      enddo<a name='2178'>
      return<a name='2179'>
      end subroutine modif_rad<a name='2180'>
<a name='2181'>
<a name='2182'>
<font color=#447700>! ===6=8===============================================================72  <a name='2183'></font>
<font color=#447700>! ===6=8===============================================================72     <a name='2184'></font>
<a name='2185'>
<A NAME='SURF_TEMP'><A href='../../html_code/phys/module_sf_bep_bem.F.html#SURF_TEMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2186'>
      <font color=#993300>subroutine </font><font color=#cc0000>surf_temp</font>(nd,pr,dt,rl,rsg,rlg,              &amp; <A href='../../call_to/SURF_TEMP.html' TARGET='index'>2</A>,<A href='../../call_from/SURF_TEMP.html' TARGET='index'>5</A><a name='2187'>
                           tg,alag,csg,emg,albg,ptg,sfg,gfg) <a name='2188'>
<a name='2189'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2190'></font>
<font color=#447700>! Computation of the surface temperatures for walls, ground and roofs <a name='2191'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2192'></font>
<a name='2193'>
      implicit none<a name='2194'>
                  <a name='2195'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2196'></font>
<font color=#447700>! INPUT:<a name='2197'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2198'></font>
<a name='2199'>
      integer nd                <font color=#447700>! Number of street direction for the current urban class<a name='2200'></font>
      real alag(ng_u)           <font color=#447700>! Ground thermal diffusivity for the current urban class [m^2 s^-1] <a name='2201'></font>
<a name='2202'>
      real albg                 <font color=#447700>! Albedo of the ground for the current urban class<a name='2203'></font>
<a name='2204'>
      real csg(ng_u)            <font color=#447700>! Specific heat of the ground material of the current urban class [J m^3 K^-1]<a name='2205'></font>
<a name='2206'>
      real dt                   <font color=#447700>! Time step<a name='2207'></font>
      real emg                  <font color=#447700>! Emissivity of ground for the current urban class<a name='2208'></font>
<a name='2209'>
      real pr(nz_um)            <font color=#447700>! Air pressure<a name='2210'></font>
      <a name='2211'>
      real rl                   <font color=#447700>! Downward flux of the longwave radiation<a name='2212'></font>
      real rlg(ndm)             <font color=#447700>! Long wave radiation at the ground<a name='2213'></font>
     <a name='2214'>
      real rsg(ndm)             <font color=#447700>! Short wave radiation at the ground<a name='2215'></font>
      <a name='2216'>
      real sfg(ndm)             <font color=#447700>! Sensible heat flux from ground (road)<a name='2217'></font>
<a name='2218'>
      real gfg(ndm)             <font color=#447700>! Heat flux transferred from the surface of the ground (road) toward the interior<a name='2219'></font>
<a name='2220'>
      real tg(ndm,ng_u)         <font color=#447700>! Temperature in each layer of the ground [K]<a name='2221'></font>
<a name='2222'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2223'></font>
<font color=#447700>! OUTPUT:<a name='2224'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2225'></font>
      real ptg(ndm)             <font color=#447700>! Ground potential temperatures <a name='2226'></font>
<a name='2227'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2228'></font>
<font color=#447700>! LOCAL:<a name='2229'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2230'></font>
      integer id,ig,ir,iw,iz<a name='2231'>
<a name='2232'>
      real rtg(ndm)             <font color=#447700>! Total radiation at ground(road) surface (solar+incoming long+outgoing long)<a name='2233'></font>
<a name='2234'>
      real tg_tmp(ng_u)<a name='2235'>
<a name='2236'>
      real dzg_u(ng_u)          <font color=#447700>! Layer sizes in the ground<a name='2237'></font>
      <a name='2238'>
      data dzg_u /0.2,0.12,0.08,0.05,0.03,0.02,0.02,0.01,0.005,0.0025/<a name='2239'>
<a name='2240'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2241'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='2242'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2243'></font>
<a name='2244'>
        <a name='2245'>
   <a name='2246'>
      do id=1,nd<a name='2247'>
<a name='2248'>
<font color=#447700>!      Calculation for the ground surfaces<a name='2249'></font>
       do ig=1,ng_u<a name='2250'>
        tg_tmp(ig)=tg(id,ig)<a name='2251'>
       end do<a name='2252'>
<font color=#447700>!	        <a name='2253'></font>
       call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SOIL_TEMP'>soil_temp</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#SURF_TEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOIL_TEMP_5">(ng_u,dzg_u,tg_tmp,ptg(id),alag,csg,      &amp;<a name='2254'>
                     rsg(id),rlg(id),pr(1),                    &amp;<a name='2255'>
                     dt,emg,albg,                              &amp;<a name='2256'>
                     rtg(id),sfg(id),gfg(id))    <a name='2257'>
       do ig=1,ng_u<a name='2258'>
        tg(id,ig)=tg_tmp(ig)<a name='2259'>
       end do<a name='2260'>
	<a name='2261'>
      end do <font color=#447700>!id<a name='2262'></font>
      <a name='2263'>
      return<a name='2264'>
      end subroutine surf_temp<a name='2265'>
     <a name='2266'>
<font color=#447700>! ===6=8===============================================================72     <a name='2267'></font>
<font color=#447700>! ===6=8===============================================================72  <a name='2268'></font>
<a name='2269'>
<A NAME='BUILDINGS'><A href='../../html_code/phys/module_sf_bep_bem.F.html#BUILDINGS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2270'>
      <font color=#993300>subroutine </font><font color=#cc0000>buildings</font>(iurb,nd,nz,z0,ua_u,va_u,pt_u,pt0_u,       &amp; <A href='../../call_to/BUILDINGS.html' TARGET='index'>2</A>,<A href='../../call_from/BUILDINGS.html' TARGET='index'>8</A><a name='2271'>
                        ptg,ptr,da_u,ptw,ptwin,pwin,                 &amp;<a name='2272'>
                        drst,uva_u,vva_u,uvb_u,vvb_u,                &amp;<a name='2273'>
                        tva_u,tvb_u,evb_u,qvb_u,qhb_u,               &amp;<a name='2274'>
                        uhb_u,vhb_u,thb_u,ehb_u,ss,dt,sfw,sfg,sfr,   &amp;<a name='2275'>
                        sfwin,pb,bs_u,dz_u,sflev,lflev,sfvlev,lfvlev,tvb_ac)                  <a name='2276'>
<a name='2277'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2278'></font>
<font color=#447700>! This routine computes the sources or sinks of the different quantities <a name='2279'></font>
<font color=#447700>! on the urban grid. The actual calculation is done in the subroutines <a name='2280'></font>
<font color=#447700>! called flux_wall, and flux_flat.<a name='2281'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2282'></font>
<a name='2283'>
      implicit none<a name='2284'>
<a name='2285'>
        <a name='2286'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2287'></font>
<font color=#447700>! INPUT:<a name='2288'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2289'></font>
      integer nd                <font color=#447700>! Number of street direction for the current urban class<a name='2290'></font>
      integer nz                <font color=#447700>! number of vertical space steps<a name='2291'></font>
      real ua_u(nz_um)          <font color=#447700>! Wind speed in the x direction on the urban grid<a name='2292'></font>
      real va_u(nz_um)          <font color=#447700>! Wind speed in the y direction on the urban grid<a name='2293'></font>
      real da_u(nz_um)          <font color=#447700>! air density on the urban grid<a name='2294'></font>
      real drst(ndm)            <font color=#447700>! Street directions for the current urban class<a name='2295'></font>
      real dz<a name='2296'>
      real pt_u(nz_um)          <font color=#447700>! Potential temperature on the urban grid<a name='2297'></font>
      real pt0_u(nz_um)         <font color=#447700>! reference potential temperature on the urban grid<a name='2298'></font>
      real ptg(ndm)             <font color=#447700>! Ground potential temperatures <a name='2299'></font>
      real ptr(ndm,nz_um)       <font color=#447700>! Roof potential temperatures <a name='2300'></font>
      real ptw(2*ndm,nz_um,nbui_max)     <font color=#447700>! Walls potential temperatures <a name='2301'></font>
      real ss(nz_um)            <font color=#447700>! probability to have a building with height h<a name='2302'></font>
      real pb(nz_um)<a name='2303'>
      real z0(ndm,nz_um)        <font color=#447700>! Roughness lengths "profiles"<a name='2304'></font>
      real dt <font color=#447700>! time step<a name='2305'></font>
      integer iurb              <font color=#447700>!Urban class<a name='2306'></font>
<a name='2307'>
<font color=#447700>!<a name='2308'></font>
<font color=#447700>!New variables (BEM)<a name='2309'></font>
<font color=#447700>!<a name='2310'></font>
      real bs_u(ndm,nurbm)    <font color=#447700>! Building width [m]<a name='2311'></font>
      real dz_u               <font color=#447700>! Urban grid resolution<a name='2312'></font>
      real sflev(nz_um,nz_um)     <font color=#447700>! sensible heat flux due to the air conditioning systems  [W]<a name='2313'></font>
      real lflev(nz_um,nz_um)     <font color=#447700>! latent heat flux due to the air conditioning systems  [W]<a name='2314'></font>
      real sfvlev(nz_um,nz_um)    <font color=#447700>! sensible heat flux due to ventilation [W]<a name='2315'></font>
      real lfvlev(nz_um,nz_um)    <font color=#447700>! latent heat flux due to ventilation [W]<a name='2316'></font>
      real qvb_u(2*ndm,nz_um)<a name='2317'>
      real qhb_u(ndm,nz_um)<a name='2318'>
      real ptwin(2*ndm,nz_um,nbui_max)  <font color=#447700>! window potential temperature<a name='2319'></font>
      real pwin<a name='2320'>
      real tvb_ac(2*ndm,nz_um)<a name='2321'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2322'></font>
<font color=#447700>! OUTPUT:<a name='2323'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2324'></font>
<font color=#447700>! Explicit and implicit component of the momentum, temperature and TKE sources or sinks on<a name='2325'></font>
<font color=#447700>! vertical surfaces (walls) and horizontal surfaces (roofs and street)<a name='2326'></font>
<font color=#447700>! The fluxes can be computed as follow: Fluxes of X = A*X + B<a name='2327'></font>
<font color=#447700>!  Example: Momentum fluxes on vertical surfaces = uva_u * ua_u + uvb_u<a name='2328'></font>
<a name='2329'>
      real uhb_u(ndm,nz_um)   <font color=#447700>! U (wind component) Horizontal surfaces, B (explicit) term<a name='2330'></font>
      real uva_u(2*ndm,nz_um)   <font color=#447700>! U (wind component)   Vertical surfaces, A (implicit) term<a name='2331'></font>
      real uvb_u(2*ndm,nz_um)   <font color=#447700>! U (wind component)   Vertical surfaces, B (explicit) term<a name='2332'></font>
      real vhb_u(ndm,nz_um)   <font color=#447700>! V (wind component) Horizontal surfaces, B (explicit) term<a name='2333'></font>
      real vva_u(2*ndm,nz_um)   <font color=#447700>! V (wind component)   Vertical surfaces, A (implicit) term<a name='2334'></font>
      real vvb_u(2*ndm,nz_um)   <font color=#447700>! V (wind component)   Vertical surfaces, B (explicit) term<a name='2335'></font>
      real thb_u(ndm,nz_um)   <font color=#447700>! Temperature        Horizontal surfaces, B (explicit) term<a name='2336'></font>
      real tva_u(2*ndm,nz_um)   <font color=#447700>! Temperature          Vertical surfaces, A (implicit) term<a name='2337'></font>
      real tvb_u(2*ndm,nz_um)   <font color=#447700>! Temperature          Vertical surfaces, B (explicit) term<a name='2338'></font>
      real ehb_u(ndm,nz_um)   <font color=#447700>! Energy (TKE)       Horizontal surfaces, B (explicit) term<a name='2339'></font>
      real evb_u(2*ndm,nz_um)   <font color=#447700>! Energy (TKE)         Vertical surfaces, B (explicit) term<a name='2340'></font>
      real sfw(2*ndm,nz_um,nbui_max)   <font color=#447700>! sensible heat flux from walls<a name='2341'></font>
      real sfwin(2*ndm,nz_um,nbui_max) <font color=#447700>! sensible heat flux form windows<a name='2342'></font>
      real sfr(ndm,nz_um)           <font color=#447700>! sensible heat flux from roof<a name='2343'></font>
      real sfg(ndm)                 <font color=#447700>! sensible heat flux from street<a name='2344'></font>
<a name='2345'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2346'></font>
<font color=#447700>! LOCAL:<a name='2347'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2348'></font>
      real d_urb(nz_um)<a name='2349'>
      real uva_tmp<a name='2350'>
      real vva_tmp<a name='2351'>
      real uvb_tmp<a name='2352'>
      real vvb_tmp <a name='2353'>
      real evb_tmp     <a name='2354'>
      integer nlev(nz_um)<a name='2355'>
      integer id,iz,ibui,nbui<a name='2356'>
<a name='2357'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2358'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='2359'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2360'></font>
      dz=dz_u<a name='2361'>
      ibui=0<a name='2362'>
      nbui=0<a name='2363'>
      nlev=0<a name='2364'>
      d_urb=0.<a name='2365'>
      <a name='2366'>
      uva_u=0.<a name='2367'>
      uvb_u=0.<a name='2368'>
      vhb_u=0.<a name='2369'>
      vva_u=0.<a name='2370'>
      vvb_u=0.<a name='2371'>
      thb_u=0.<a name='2372'>
      tva_u=0.<a name='2373'>
      tvb_u=0.<a name='2374'>
      tvb_ac=0.<a name='2375'>
      ehb_u=0.<a name='2376'>
      evb_u=0.<a name='2377'>
      qvb_u=0.<a name='2378'>
      qhb_u=0.<a name='2379'>
<a name='2380'>
      do iz=1,nz_um		   <a name='2381'>
         if(ss(iz).gt.0) then		<a name='2382'>
           ibui=ibui+1<a name='2383'>
           d_urb(ibui)=ss(iz)<a name='2384'>
           nlev(ibui)=iz-1<a name='2385'>
           nbui=ibui		               <a name='2386'>
         endif<a name='2387'>
      enddo<a name='2388'>
<a name='2389'>
      do id=1,nd<a name='2390'>
<a name='2391'>
<font color=#447700>!        Calculation at the ground surfaces<a name='2392'></font>
<a name='2393'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FLUX_FLAT'>flux_flat</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BUILDINGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUX_FLAT_3">(dz,z0(id,1),ua_u(1),va_u(1),pt_u(1),pt0_u(1),  &amp;<a name='2394'>
                       ptg(id),uhb_u(id,1),                            &amp; <a name='2395'>
                       vhb_u(id,1),sfg(id),ehb_u(id,1),da_u(1))          <a name='2396'>
         thb_u(id,1)=- sfg(id)/(da_u(1)*cp_u)  <a name='2397'>
              <a name='2398'>
<font color=#447700>!        Calculation at the roof surfaces    <a name='2399'></font>
<a name='2400'>
         do iz=2,nz<a name='2401'>
            if(ss(iz).gt.0)then<a name='2402'>
               call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FLUX_FLAT'>flux_flat</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BUILDINGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUX_FLAT_4">(dz,z0(id,iz),ua_u(iz),                  &amp;              <a name='2403'>
                       va_u(iz),pt_u(iz),pt0_u(iz),                   &amp;   <a name='2404'>
                       ptr(id,iz),uhb_u(id,iz),                       &amp;   <a name='2405'>
                       vhb_u(id,iz),sfr(id,iz),ehb_u(id,iz),da_u(iz)) <a name='2406'>
               thb_u(id,iz)=- sfr(id,iz)/(da_u(iz)*cp_u) <a name='2407'>
            else<a name='2408'>
               uhb_u(id,iz) = 0.0<a name='2409'>
               vhb_u(id,iz) = 0.0<a name='2410'>
               thb_u(id,iz) = 0.0<a name='2411'>
               ehb_u(id,iz) = 0.0<a name='2412'>
            endif<a name='2413'>
         end do<a name='2414'>
<a name='2415'>
<font color=#447700>!        Calculation at the wall surfaces        <a name='2416'></font>
 <a name='2417'>
         do ibui=1,nbui<a name='2418'>
         do iz=1,nlev(ibui)  <a name='2419'>
                   <a name='2420'>
            call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FLUX_WALL'>flux_wall</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BUILDINGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUX_WALL_3">(ua_u(iz),va_u(iz),pt_u(iz),da_u(iz),             &amp;  <a name='2421'>
                        ptw(2*id-1,iz,ibui),ptwin(2*id-1,iz,ibui),          &amp;   <a name='2422'>
                        uva_tmp,vva_tmp,                                    &amp;   <a name='2423'>
                        uvb_tmp,vvb_tmp,                                    &amp;   <a name='2424'>
                        sfw(2*id-1,iz,ibui),sfwin(2*id-1,iz,ibui),          &amp;   <a name='2425'>
                        evb_tmp,drst(id),dt)      <a name='2426'>
   <a name='2427'>
            if (pb(iz+1).gt.0.) then<a name='2428'>
<a name='2429'>
                    uva_u(2*id-1,iz)=uva_u(2*id-1,iz)+d_urb(ibui)/pb(iz+1)*uva_tmp<a name='2430'>
                    vva_u(2*id-1,iz)=vva_u(2*id-1,iz)+d_urb(ibui)/pb(iz+1)*vva_tmp<a name='2431'>
                    uvb_u(2*id-1,iz)=uvb_u(2*id-1,iz)+d_urb(ibui)/pb(iz+1)*uvb_tmp<a name='2432'>
                    vvb_u(2*id-1,iz)=vvb_u(2*id-1,iz)+d_urb(ibui)/pb(iz+1)*vvb_tmp<a name='2433'>
                    evb_u(2*id-1,iz)=evb_u(2*id-1,iz)+d_urb(ibui)/pb(iz+1)*evb_tmp<a name='2434'>
                    tvb_u(2*id-1,iz)=tvb_u(2*id-1,iz)-(d_urb(ibui)/pb(iz+1))*                       &amp;<a name='2435'>
                                    (sfw(2*id-1,iz,ibui)*(1.-pwin)+sfwin(2*id-1,iz,ibui)*pwin)/     &amp;<a name='2436'>
                                    da_u(iz)/cp_u-(1./4.)*(d_urb(ibui)/pb(iz+1))*(sfvlev(iz,ibui)-sflev(iz,ibui))/&amp;<a name='2437'>
                                    (dz*bs_u(id,iurb))/da_u(iz)/cp_u<a name='2438'>
                    tvb_ac(2*id-1,iz)=tvb_ac(2*id-1,iz)-(1./4.)*(d_urb(ibui)/pb(iz+1))*(-sflev(iz,ibui))/&amp;<a name='2439'>
                                    (dz*bs_u(id,iurb))/da_u(iz)/cp_u<a name='2440'>
                    qvb_u(2*id-1,iz)=qvb_u(2*id-1,iz)-(1./4.)*(d_urb(ibui)/pb(iz+1))*(lfvlev(iz,ibui)-lflev(iz,ibui))/&amp;<a name='2441'>
                                    (dz*bs_u(id,iurb))/da_u(iz)/latent<a name='2442'>
                                     <a name='2443'>
            endif<a name='2444'>
<a name='2445'>
            call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FLUX_WALL'>flux_wall</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BUILDINGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUX_WALL_4">(ua_u(iz),va_u(iz),pt_u(iz),da_u(iz),    &amp;   <a name='2446'>
                        ptw(2*id,iz,ibui),ptwin(2*id,iz,ibui),     &amp;    <a name='2447'>
                        uva_tmp,vva_tmp,                           &amp;    <a name='2448'>
                        uvb_tmp,vvb_tmp,                           &amp;    <a name='2449'>
                        sfw(2*id,iz,ibui),sfwin(2*id,iz,ibui),     &amp;   <a name='2450'>
                        evb_tmp,drst(id),dt) <a name='2451'>
<a name='2452'>
            if (pb(iz+1).gt.0.) then<a name='2453'>
<a name='2454'>
                    uva_u(2*id,iz)=uva_u(2*id,iz)+d_urb(ibui)/pb(iz+1)*uva_tmp<a name='2455'>
                    vva_u(2*id,iz)=vva_u(2*id,iz)+d_urb(ibui)/pb(iz+1)*vva_tmp<a name='2456'>
                    uvb_u(2*id,iz)=uvb_u(2*id,iz)+d_urb(ibui)/pb(iz+1)*uvb_tmp<a name='2457'>
                    vvb_u(2*id,iz)=vvb_u(2*id,iz)+d_urb(ibui)/pb(iz+1)*vvb_tmp<a name='2458'>
                    evb_u(2*id,iz)=evb_u(2*id,iz)+d_urb(ibui)/pb(iz+1)*evb_tmp<a name='2459'>
                    tvb_u(2*id,iz)=tvb_u(2*id,iz)-(d_urb(ibui)/pb(iz+1))*                    &amp;<a name='2460'>
                                    (sfw(2*id,iz,ibui)*(1.-pwin)+sfwin(2*id,iz,ibui)*pwin)/  &amp;<a name='2461'>
                                     da_u(iz)/cp_u-(1./4.)*(d_urb(ibui)/pb(iz+1))*(sfvlev(iz,ibui)-sflev(iz,ibui))/&amp;<a name='2462'>
                                    (dz*bs_u(id,iurb))/da_u(iz)/cp_u<a name='2463'>
                    tvb_ac(2*id,iz)=tvb_ac(2*id,iz)-(1./4.)*(d_urb(ibui)/pb(iz+1))*(-sflev(iz,ibui))/&amp;<a name='2464'>
                                    (dz*bs_u(id,iurb))/da_u(iz)/cp_u<a name='2465'>
                    qvb_u(2*id,iz)=qvb_u(2*id,iz)-(1./4.)*(d_urb(ibui)/pb(iz+1))*(lfvlev(iz,ibui)-lflev(iz,ibui))/&amp;<a name='2466'>
                                    (dz*bs_u(id,iurb))/da_u(iz)/latent<a name='2467'>
<a name='2468'>
            endif<a name='2469'>
<font color=#447700>!<a name='2470'></font>
          enddo <font color=#447700>!iz<a name='2471'></font>
         enddo <font color=#447700>!ibui<a name='2472'></font>
         <a name='2473'>
      end do <font color=#447700>!id<a name='2474'></font>
                <a name='2475'>
      return<a name='2476'>
      end subroutine buildings<a name='2477'>
      <a name='2478'>
<a name='2479'>
<font color=#447700>! ===6=8===============================================================72<a name='2480'></font>
<font color=#447700>! ===6=8===============================================================72<a name='2481'></font>
<a name='2482'>
<A NAME='URBAN_MESO'><A href='../../html_code/phys/module_sf_bep_bem.F.html#URBAN_MESO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2483'>
        <font color=#993300>subroutine </font><font color=#cc0000>urban_meso</font>(nd,kms,kme,kts,kte,nz_u,z,dz,z_u,pb,ss,bs,ws,sf,vl,    &amp; <A href='../../call_to/URBAN_MESO.html' TARGET='index'>2</A><a name='2484'>
                             uva_u,vva_u,uvb_u,vvb_u,tva_u,tvb_u,evb_u, &amp;       <a name='2485'>
                             uhb_u,vhb_u,thb_u,ehb_u,qhb_u,qvb_u,       &amp;      <a name='2486'>
                             a_u,a_v,a_t,a_e,b_u,b_v,b_t,b_e,b_q,tvb_ac,b_ac)           <a name='2487'>
<a name='2488'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2489'></font>
<font color=#447700>!  This routine interpolates the parameters from the "urban grid" to the<a name='2490'></font>
<font color=#447700>!  "mesoscale grid".<a name='2491'></font>
<font color=#447700>!  See p300-301 Appendix B.2 of the BLM paper.  <a name='2492'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2493'></font>
<a name='2494'>
      implicit none<a name='2495'>
<a name='2496'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2497'></font>
<font color=#447700>! INPUT:<a name='2498'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2499'></font>
<font color=#447700>! Data relative to the "mesoscale grid"<a name='2500'></font>
      integer kms,kme,kts,kte               <a name='2501'>
      real z(kms:kme)              <font color=#447700>! Altitude above the ground of the cell interface<a name='2502'></font>
      real dz(kms:kme)               <font color=#447700>! Vertical space steps<a name='2503'></font>
<a name='2504'>
<font color=#447700>! Data relative to the "uban grid"<a name='2505'></font>
      integer nz_u              <font color=#447700>! Number of layer in the urban grid<a name='2506'></font>
      integer nd                <font color=#447700>! Number of street direction for the current urban class<a name='2507'></font>
      real bs(ndm)              <font color=#447700>! Building widths of the current urban class<a name='2508'></font>
      real ws(ndm)              <font color=#447700>! Street widths of the current urban class<a name='2509'></font>
      real z_u(nz_um)         <font color=#447700>! Height of the urban grid levels<a name='2510'></font>
      real pb(nz_um)          <font color=#447700>! Probability to have a building with an height equal<a name='2511'></font>
      real ss(nz_um)          <font color=#447700>! Probability to have a building with height h<a name='2512'></font>
      real uhb_u(ndm,nz_um)   <font color=#447700>! U (x-wind component) Horizontal surfaces, B (explicit) term<a name='2513'></font>
      real uva_u(2*ndm,nz_um)   <font color=#447700>! U (x-wind component) Vertical surfaces, A (implicit) term<a name='2514'></font>
      real uvb_u(2*ndm,nz_um)   <font color=#447700>! U (x-wind component) Vertical surfaces, B (explicit) term<a name='2515'></font>
      real vhb_u(ndm,nz_um)   <font color=#447700>! V (y-wind component) Horizontal surfaces, B (explicit) term<a name='2516'></font>
      real vva_u(2*ndm,nz_um)   <font color=#447700>! V (y-wind component) Vertical surfaces, A (implicit) term<a name='2517'></font>
      real vvb_u(2*ndm,nz_um)   <font color=#447700>! V (y-wind component) Vertical surfaces, B (explicit) term<a name='2518'></font>
      real thb_u(ndm,nz_um)   <font color=#447700>! Temperature        Horizontal surfaces, B (explicit) term<a name='2519'></font>
      real tva_u(2*ndm,nz_um)   <font color=#447700>! Temperature          Vertical surfaces, A (implicit) term<a name='2520'></font>
      real tvb_u(2*ndm,nz_um)   <font color=#447700>! Temperature          Vertical surfaces, B (explicit) term<a name='2521'></font>
      real tvb_ac(2*ndm,nz_um)<a name='2522'>
      real ehb_u(ndm,nz_um)   <font color=#447700>! Energy (TKE)       Horizontal surfaces, B (explicit) term<a name='2523'></font>
      real evb_u(2*ndm,nz_um)   <font color=#447700>! Energy (TKE)         Vertical surfaces, B (explicit) term<a name='2524'></font>
<font color=#447700>!<a name='2525'></font>
<font color=#447700>!New variables for BEM<a name='2526'></font>
<font color=#447700>!<a name='2527'></font>
      real qhb_u(ndm,nz_um)<a name='2528'>
      real qvb_u(2*ndm,nz_um)<a name='2529'>
     <a name='2530'>
<a name='2531'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2532'></font>
<font color=#447700>! OUTPUT:<a name='2533'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2534'></font>
<font color=#447700>! Data relative to the "mesoscale grid"<a name='2535'></font>
      real sf(kms:kme)             <font color=#447700>! Surface of the "mesoscale grid" cells taking into account the buildings<a name='2536'></font>
      real vl(kms:kme)               <font color=#447700>! Volume of the "mesoscale grid" cells taking into account the buildings<a name='2537'></font>
      real a_u(kms:kme)              <font color=#447700>! Implicit component of the momentum sources or sinks in the X-direction<a name='2538'></font>
      real a_v(kms:kme)              <font color=#447700>! Implicit component of the momentum sources or sinks in the Y-direction<a name='2539'></font>
      real a_t(kms:kme)              <font color=#447700>! Implicit component of the heat sources or sinks<a name='2540'></font>
      real a_e(kms:kme)              <font color=#447700>! Implicit component of the TKE sources or sinks<a name='2541'></font>
      real b_u(kms:kme)              <font color=#447700>! Explicit component of the momentum sources or sinks in the X-direction<a name='2542'></font>
      real b_v(kms:kme)              <font color=#447700>! Explicit component of the momentum sources or sinks in the Y-direction<a name='2543'></font>
      real b_t(kms:kme)              <font color=#447700>! Explicit component of the heat sources or sinks<a name='2544'></font>
      real b_ac(kms:kme)<a name='2545'>
      real b_e(kms:kme)              <font color=#447700>! Explicit component of the TKE sources or sinks<a name='2546'></font>
      real b_q(kms:kme)               <font color=#447700>! Explicit component of the humidity sources or sinks<a name='2547'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2548'></font>
<font color=#447700>! LOCAL:<a name='2549'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2550'></font>
      real dzz<a name='2551'>
      real fact<a name='2552'>
      integer id,iz,iz_u<a name='2553'>
      real se,sr,st,su,sv,sq<a name='2554'>
      real uet(kms:kme)                <font color=#447700>! Contribution to TKE due to walls<a name='2555'></font>
      real veb,vta,vtb,vte,vtot,vua,vub,vva,vvb,vqb,vtb_ac<a name='2556'>
<a name='2557'>
<a name='2558'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2559'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='2560'></font>
<font color=#447700>! ---------------------------------------------------------------------- <a name='2561'></font>
<a name='2562'>
<font color=#447700>! initialisation<a name='2563'></font>
<a name='2564'>
      do iz=kts,kte<a name='2565'>
         a_u(iz)=0.<a name='2566'>
         a_v(iz)=0.<a name='2567'>
         a_t(iz)=0.<a name='2568'>
         a_e(iz)=0.<a name='2569'>
         b_u(iz)=0.<a name='2570'>
         b_v(iz)=0.<a name='2571'>
         b_e(iz)=0.<a name='2572'>
         b_t(iz)=0.<a name='2573'>
         b_ac(iz)=0.<a name='2574'>
         uet(iz)=0.<a name='2575'>
         b_q(iz)=0.<a name='2576'>
      end do<a name='2577'>
            <a name='2578'>
<font color=#447700>! horizontal surfaces<a name='2579'></font>
      do iz=kts,kte<a name='2580'>
         sf(iz)=0.<a name='2581'>
         vl(iz)=0.<a name='2582'>
      enddo<a name='2583'>
      sf(kte+1)=0. <a name='2584'>
      <a name='2585'>
      do id=1,nd      <a name='2586'>
         do iz=kts+1,kte+1<a name='2587'>
            sr=0.<a name='2588'>
            do iz_u=2,nz_u<a name='2589'>
               if(z(iz).lt.z_u(iz_u).and.z(iz).ge.z_u(iz_u-1))then<a name='2590'>
                  sr=pb(iz_u)<a name='2591'>
               endif<a name='2592'>
            enddo<a name='2593'>
            sf(iz)=sf(iz)+((ws(id)+(1.-sr)*bs(id))/(ws(id)+bs(id)))/nd<a name='2594'>
         enddo<a name='2595'>
      enddo<a name='2596'>
<a name='2597'>
<font color=#447700>! volume      <a name='2598'></font>
      do iz=kts,kte<a name='2599'>
         do id=1,nd<a name='2600'>
            vtot=0.<a name='2601'>
            do iz_u=1,nz_u<a name='2602'>
               dzz=max(min(z_u(iz_u+1),z(iz+1))-max(z_u(iz_u),z(iz)),0.)<a name='2603'>
               vtot=vtot+pb(iz_u+1)*dzz<a name='2604'>
            enddo<a name='2605'>
            vtot=vtot/(z(iz+1)-z(iz))<a name='2606'>
            vl(iz)=vl(iz)+(1.-vtot*bs(id)/(ws(id)+bs(id)))/nd<a name='2607'>
         enddo<a name='2608'>
      enddo<a name='2609'>
      <a name='2610'>
<font color=#447700>! horizontal surface impact  <a name='2611'></font>
<a name='2612'>
      do id=1,nd<a name='2613'>
      <a name='2614'>
         fact=1./vl(kts)/dz(kts)*ws(id)/(ws(id)+bs(id))/nd<a name='2615'>
         b_t(kts)=b_t(kts)+thb_u(id,1)*fact<a name='2616'>
         b_u(kts)=b_u(kts)+uhb_u(id,1)*fact<a name='2617'>
         b_v(kts)=b_v(kts)+vhb_u(id,1)*fact <a name='2618'>
         b_e(kts)=b_e(kts)+ehb_u(id,1)*fact*(z_u(2)-z_u(1))<a name='2619'>
         b_q(kts)=b_q(kts)+qhb_u(id,1)*fact         <a name='2620'>
<a name='2621'>
         do iz=kts,kte<a name='2622'>
            st=0.<a name='2623'>
            su=0.<a name='2624'>
            sv=0.<a name='2625'>
            se=0.<a name='2626'>
            sq=0.<a name='2627'>
            do iz_u=2,nz_u<a name='2628'>
               if(z(iz).le.z_u(iz_u).and.z(iz+1).gt.z_u(iz_u))then<a name='2629'>
                  st=st+ss(iz_u)*thb_u(id,iz_u)<a name='2630'>
                  su=su+ss(iz_u)*uhb_u(id,iz_u)<a name='2631'>
                  sv=sv+ss(iz_u)*vhb_u(id,iz_u)          <a name='2632'>
                  se=se+ss(iz_u)*ehb_u(id,iz_u)*(z_u(iz_u+1)-z_u(iz_u))<a name='2633'>
                  sq=sq+ss(iz_u)*qhb_u(id,iz_u)<a name='2634'>
               endif<a name='2635'>
            enddo<a name='2636'>
      <a name='2637'>
            fact=bs(id)/(ws(id)+bs(id))/vl(iz)/dz(iz)/nd<a name='2638'>
            b_t(iz)=b_t(iz)+st*fact<a name='2639'>
            b_u(iz)=b_u(iz)+su*fact<a name='2640'>
            b_v(iz)=b_v(iz)+sv*fact<a name='2641'>
            b_e(iz)=b_e(iz)+se*fact<a name='2642'>
            b_q(iz)=b_q(iz)+sq*fact<a name='2643'>
         enddo<a name='2644'>
      enddo              <a name='2645'>
<a name='2646'>
<font color=#447700>! vertical surface impact<a name='2647'></font>
           <a name='2648'>
      do iz=kts,kte <a name='2649'>
         uet(iz)=0.<a name='2650'>
         do id=1,nd              <a name='2651'>
            vtb=0.<a name='2652'>
            vtb_ac=0.<a name='2653'>
            vta=0.<a name='2654'>
            vua=0.<a name='2655'>
            vub=0.<a name='2656'>
            vva=0.<a name='2657'>
            vvb=0.<a name='2658'>
            veb=0.<a name='2659'>
	    vte=0.<a name='2660'>
            vqb=0.<a name='2661'>
            do iz_u=1,nz_u<a name='2662'>
               dzz=max(min(z_u(iz_u+1),z(iz+1))-max(z_u(iz_u),z(iz)),0.)<a name='2663'>
               fact=dzz/(ws(id)+bs(id))<a name='2664'>
               vtb=vtb+pb(iz_u+1)*                                  &amp;        <a name='2665'>
                    (tvb_u(2*id-1,iz_u)+tvb_u(2*id,iz_u))*fact <a name='2666'>
               vtb_ac=vtb_ac+pb(iz_u+1)*                            &amp;        <a name='2667'>
                    (tvb_ac(2*id-1,iz_u)+tvb_ac(2*id,iz_u))*fact     <a name='2668'>
               vta=vta+pb(iz_u+1)*                                  &amp;        <a name='2669'>
                   (tva_u(2*id-1,iz_u)+tva_u(2*id,iz_u))*fact<a name='2670'>
               vua=vua+pb(iz_u+1)*                                  &amp;        <a name='2671'>
                    (uva_u(2*id-1,iz_u)+uva_u(2*id,iz_u))*fact<a name='2672'>
               vva=vva+pb(iz_u+1)*                                  &amp;        <a name='2673'>
                    (vva_u(2*id-1,iz_u)+vva_u(2*id,iz_u))*fact<a name='2674'>
               vub=vub+pb(iz_u+1)*                                  &amp;        <a name='2675'>
                    (uvb_u(2*id-1,iz_u)+uvb_u(2*id,iz_u))*fact<a name='2676'>
               vvb=vvb+pb(iz_u+1)*                                  &amp;        <a name='2677'>
                    (vvb_u(2*id-1,iz_u)+vvb_u(2*id,iz_u))*fact<a name='2678'>
               veb=veb+pb(iz_u+1)*                                  &amp;        <a name='2679'>
                    (evb_u(2*id-1,iz_u)+evb_u(2*id,iz_u))*fact<a name='2680'>
               vqb=vqb+pb(iz_u+1)*                                  &amp;        <a name='2681'>
                    (qvb_u(2*id-1,iz_u)+qvb_u(2*id,iz_u))*fact   <a name='2682'>
            enddo<a name='2683'>
           <a name='2684'>
            fact=1./vl(iz)/dz(iz)/nd<a name='2685'>
            b_t(iz)=b_t(iz)+vtb*fact<a name='2686'>
            b_ac(iz)=b_ac(iz)+vtb_ac*fact<a name='2687'>
            a_t(iz)=a_t(iz)+vta*fact<a name='2688'>
            a_u(iz)=a_u(iz)+vua*fact<a name='2689'>
            a_v(iz)=a_v(iz)+vva*fact<a name='2690'>
            b_u(iz)=b_u(iz)+vub*fact<a name='2691'>
            b_v(iz)=b_v(iz)+vvb*fact<a name='2692'>
            b_e(iz)=b_e(iz)+veb*fact<a name='2693'>
            uet(iz)=uet(iz)+vte*fact<a name='2694'>
            b_q(iz)=b_q(iz)+vqb*fact<a name='2695'>
         enddo              <a name='2696'>
      enddo<a name='2697'>
      <a name='2698'>
<a name='2699'>
      <a name='2700'>
      return<a name='2701'>
      end subroutine urban_meso<a name='2702'>
<a name='2703'>
<font color=#447700>! ===6=8===============================================================72 <a name='2704'></font>
<font color=#447700>! ===6=8===============================================================72 <a name='2705'></font>
<a name='2706'>
<A NAME='INTERP_LENGTH'><A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERP_LENGTH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2707'>
      <font color=#993300>subroutine </font><font color=#cc0000>interp_length</font>(nd,kms,kme,kts,kte,nz_u,z_u,z,ss,ws,bs,              &amp; <A href='../../call_to/INTERP_LENGTH.html' TARGET='index'>2</A><a name='2708'>
                             dlg,dl_u)<a name='2709'>
<a name='2710'>
<font color=#447700>! ----------------------------------------------------------------------     <a name='2711'></font>
<font color=#447700>!    Calculation of the length scales<a name='2712'></font>
<font color=#447700>!    See p272-274 formula (22) and (24) of the BLM paper    <a name='2713'></font>
<font color=#447700>! ----------------------------------------------------------------------     <a name='2714'></font>
     <a name='2715'>
      implicit none<a name='2716'>
<a name='2717'>
<a name='2718'>
<font color=#447700>! ----------------------------------------------------------------------     <a name='2719'></font>
<font color=#447700>! INPUT:<a name='2720'></font>
<font color=#447700>! ----------------------------------------------------------------------     <a name='2721'></font>
      integer kms,kme,kts,kte                <a name='2722'>
      real z(kms:kme)              <font color=#447700>! Altitude above the ground of the cell interface<a name='2723'></font>
      integer nd                <font color=#447700>! Number of street direction for the current urban class<a name='2724'></font>
      integer nz_u              <font color=#447700>! Number of levels in the "urban grid"<a name='2725'></font>
      real z_u(nz_um)         <font color=#447700>! Height of the urban grid levels<a name='2726'></font>
      real bs(ndm)              <font color=#447700>! Building widths of the current urban class<a name='2727'></font>
      real ss(nz_um)          <font color=#447700>! Probability to have a building with height h<a name='2728'></font>
      real ws(ndm)              <font color=#447700>! Street widths of the current urban class<a name='2729'></font>
<a name='2730'>
<a name='2731'>
<font color=#447700>! ----------------------------------------------------------------------     <a name='2732'></font>
<font color=#447700>! OUTPUT:<a name='2733'></font>
<font color=#447700>! ----------------------------------------------------------------------     <a name='2734'></font>
      real dlg(kms:kme)              <font color=#447700>! Height above ground (L_ground in formula (24) of the BLM paper). <a name='2735'></font>
      real dl_u(kms:kme)             <font color=#447700>! Length scale (lb in formula (22) ofthe BLM paper).<a name='2736'></font>
<a name='2737'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2738'></font>
<font color=#447700>! LOCAL:<a name='2739'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2740'></font>
      real dlgtmp<a name='2741'>
      integer id,iz,iz_u<a name='2742'>
      real sftot<a name='2743'>
      real ulu,ssl<a name='2744'>
<a name='2745'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2746'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='2747'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2748'></font>
   <a name='2749'>
        do iz=kts,kte<a name='2750'>
         ulu=0.<a name='2751'>
         ssl=0.<a name='2752'>
         do id=1,nd        <a name='2753'>
          do iz_u=2,nz_u<a name='2754'>
           if(z_u(iz_u).gt.z(iz))then<a name='2755'>
            ulu=ulu+ss(iz_u)/z_u(iz_u)/nd<a name='2756'>
            ssl=ssl+ss(iz_u)/nd<a name='2757'>
           endif<a name='2758'>
          enddo<a name='2759'>
         enddo<a name='2760'>
<a name='2761'>
        if(ulu.ne.0)then<a name='2762'>
          dl_u(iz)=ssl/ulu<a name='2763'>
         else<a name='2764'>
          dl_u(iz)=0.<a name='2765'>
         endif<a name='2766'>
        enddo<a name='2767'>
       <a name='2768'>
<a name='2769'>
        do iz=kts,kte<a name='2770'>
         dlg(iz)=0.<a name='2771'>
          do id=1,nd<a name='2772'>
           sftot=ws(id)  <a name='2773'>
           dlgtmp=ws(id)/((z(iz)+z(iz+1))/2.)<a name='2774'>
           do iz_u=1,nz_u<a name='2775'>
            if((z(iz)+z(iz+1))/2..gt.z_u(iz_u))then<a name='2776'>
             dlgtmp=dlgtmp+ss(iz_u)*bs(id)/                           &amp;                <a name='2777'>
                    ((z(iz)+z(iz+1))/2.-z_u(iz_u))<a name='2778'>
             sftot=sftot+ss(iz_u)*bs(id)<a name='2779'>
            endif<a name='2780'>
           enddo<a name='2781'>
           dlg(iz)=dlg(iz)+dlgtmp/sftot/nd<a name='2782'>
         enddo<a name='2783'>
         dlg(iz)=1./dlg(iz)<a name='2784'>
        enddo<a name='2785'>
        <a name='2786'>
       return<a name='2787'>
       end subroutine interp_length<a name='2788'>
<a name='2789'>
<font color=#447700>! ===6=8===============================================================72<a name='2790'></font>
<font color=#447700>! ===6=8===============================================================72   <a name='2791'></font>
<a name='2792'>
<A NAME='SHADOW_MAS'><A href='../../html_code/phys/module_sf_bep_bem.F.html#SHADOW_MAS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2793'>
      <font color=#993300>subroutine </font><font color=#cc0000>shadow_mas</font>(nd,nz_u,zr,deltar,ah,drst,ws,ss,pb,z,    &amp; <A href='../../call_to/SHADOW_MAS.html' TARGET='index'>2</A>,<A href='../../call_from/SHADOW_MAS.html' TARGET='index'>4</A><a name='2794'>
                           rs,rsw,rsg)<a name='2795'>
        <a name='2796'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2797'></font>
<font color=#447700>!         Modification of short wave radiation to take into account<a name='2798'></font>
<font color=#447700>!         the shadow produced by the buildings<a name='2799'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2800'></font>
<a name='2801'>
      implicit none<a name='2802'>
     <a name='2803'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2804'></font>
<font color=#447700>! INPUT:<a name='2805'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2806'></font>
      integer nd                <font color=#447700>! Number of street direction for the current urban class<a name='2807'></font>
      integer nz_u              <font color=#447700>! number of vertical layers defined in the urban grid<a name='2808'></font>
      real ah                   <font color=#447700>! Hour angle (it should come from the radiation routine)<a name='2809'></font>
      real deltar               <font color=#447700>! Declination of the sun<a name='2810'></font>
      real drst(ndm)            <font color=#447700>! street directions for the current urban class<a name='2811'></font>
      real rs                   <font color=#447700>! solar radiation<a name='2812'></font>
      real ss(nz_um)          <font color=#447700>! probability to have a building with height h<a name='2813'></font>
      real pb(nz_um)          <font color=#447700>! Probability that a building has an height greater or equal to h<a name='2814'></font>
      real ws(ndm)              <font color=#447700>! Street width of the current urban class<a name='2815'></font>
      real z(nz_um)           <font color=#447700>! Height of the urban grid levels<a name='2816'></font>
      real zr                   <font color=#447700>! zenith angle<a name='2817'></font>
<a name='2818'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2819'></font>
<font color=#447700>! OUTPUT:<a name='2820'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2821'></font>
      real rsg(ndm)             <font color=#447700>! Short wave radiation at the ground<a name='2822'></font>
      real rsw(2*ndm,nz_um)     <font color=#447700>! Short wave radiation at the walls<a name='2823'></font>
<a name='2824'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2825'></font>
<font color=#447700>! LOCAL:<a name='2826'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2827'></font>
      integer id,iz,jz<a name='2828'>
      real aae,aaw,bbb,phix,rd,rtot,wsd<a name='2829'>
      <a name='2830'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2831'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='2832'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2833'></font>
<a name='2834'>
      if(rs.eq.0.or.sin(zr).eq.1)then<a name='2835'>
         do id=1,nd<a name='2836'>
            rsg(id)=0.<a name='2837'>
            do iz=1,nz_u<a name='2838'>
               rsw(2*id-1,iz)=0.<a name='2839'>
               rsw(2*id,iz)=0.<a name='2840'>
            enddo<a name='2841'>
         enddo<a name='2842'>
      else            <a name='2843'>
<font color=#447700>!test              <a name='2844'></font>
         if(abs(sin(zr)).gt.1.e-10)then<a name='2845'>
          if(cos(deltar)*sin(ah)/sin(zr).ge.1)then<a name='2846'>
           bbb=pi/2.<a name='2847'>
          elseif(cos(deltar)*sin(ah)/sin(zr).le.-1)then<a name='2848'>
           bbb=-pi/2.<a name='2849'>
          else<a name='2850'>
           bbb=asin(cos(deltar)*sin(ah)/sin(zr))<a name='2851'>
          endif<a name='2852'>
         else<a name='2853'>
          if(cos(deltar)*sin(ah).ge.0)then<a name='2854'>
           bbb=pi/2.<a name='2855'>
          elseif(cos(deltar)*sin(ah).lt.0)then<a name='2856'>
           bbb=-pi/2.<a name='2857'>
          endif<a name='2858'>
         endif<a name='2859'>
<a name='2860'>
         phix=zr<a name='2861'>
           <a name='2862'>
         do id=1,nd<a name='2863'>
        <a name='2864'>
            rsg(id)=0.<a name='2865'>
           <a name='2866'>
            aae=bbb-drst(id)<a name='2867'>
            aaw=bbb-drst(id)+pi<a name='2868'>
                    <a name='2869'>
            do iz=1,nz_u<a name='2870'>
               rsw(2*id-1,iz)=0.<a name='2871'>
               rsw(2*id,iz)=0.          <a name='2872'>
            if(pb(iz+1).gt.0.)then          <a name='2873'>
               do jz=1,nz_u                    <a name='2874'>
                if(abs(sin(aae)).gt.1.e-10)then<a name='2875'>
                  call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SHADE_WALL'>shade_wall</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#SHADOW_MAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHADE_WALL_3">(z(iz),z(iz+1),z(jz+1),phix,aae,   &amp;    <a name='2876'>
                      ws(id),rd)                  <a name='2877'>
                  rsw(2*id-1,iz)=rsw(2*id-1,iz)+rs*rd*ss(jz+1)/pb(iz+1)<a name='2878'>
                endif<a name='2879'>
              <a name='2880'>
                if(abs(sin(aaw)).gt.1.e-10)then<a name='2881'>
                  call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SHADE_WALL'>shade_wall</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#SHADOW_MAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHADE_WALL_4">(z(iz),z(iz+1),z(jz+1),phix,aaw,   &amp;    <a name='2882'>
                      ws(id),rd)<a name='2883'>
                  rsw(2*id,iz)=rsw(2*id,iz)+rs*rd*ss(jz+1)/pb(iz+1)                  <a name='2884'>
                endif<a name='2885'>
               enddo             <a name='2886'>
            endif  <a name='2887'>
            enddo<a name='2888'>
        if(abs(sin(aae)).gt.1.e-10)then<a name='2889'>
            wsd=abs(ws(id)/sin(aae))<a name='2890'>
              <a name='2891'>
            do jz=1,nz_u           <a name='2892'>
               rd=max(0.,wsd-z(jz+1)*tan(phix))<a name='2893'>
               rsg(id)=rsg(id)+rs*rd*ss(jz+1)/wsd          <a name='2894'>
            enddo<a name='2895'>
            rtot=0.<a name='2896'>
           <a name='2897'>
            do iz=1,nz_u<a name='2898'>
               rtot=rtot+(rsw(2*id,iz)+rsw(2*id-1,iz))*            &amp;<a name='2899'>
                         (z(iz+1)-z(iz))<a name='2900'>
            enddo<a name='2901'>
            rtot=rtot+rsg(id)*ws(id)<a name='2902'>
        else<a name='2903'>
            rsg(id)=rs<a name='2904'>
        endif<a name='2905'>
            <a name='2906'>
         enddo<a name='2907'>
      endif<a name='2908'>
         <a name='2909'>
      return<a name='2910'>
      end subroutine shadow_mas<a name='2911'>
         <a name='2912'>
<font color=#447700>! ===6=8===============================================================72     <a name='2913'></font>
<font color=#447700>! ===6=8===============================================================72     <a name='2914'></font>
<a name='2915'>
<A NAME='SHADE_WALL'><A href='../../html_code/phys/module_sf_bep_bem.F.html#SHADE_WALL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2916'>
      <font color=#993300>subroutine </font><font color=#cc0000>shade_wall</font>(z1,z2,hu,phix,aa,ws,rd) <A href='../../call_to/SHADE_WALL.html' TARGET='index'>4</A><a name='2917'>
<a name='2918'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2919'></font>
<font color=#447700>! This routine computes the effects of a shadow induced by a building of <a name='2920'></font>
<font color=#447700>! height hu, on a portion of wall between z1 and z2. See equation A10, <a name='2921'></font>
<font color=#447700>! and correction described below formula A11, and figure A1. Basically rd<a name='2922'></font>
<font color=#447700>! is the ratio between the horizontal surface illuminated and the portion<a name='2923'></font>
<font color=#447700>! of wall. Referring to figure A1, multiplying radiation flux density on <a name='2924'></font>
<font color=#447700>! a horizontal surface (rs) by x1-x2 we have the radiation energy per <a name='2925'></font>
<font color=#447700>! unit time. Dividing this by z2-z1, we obtain the radiation flux <a name='2926'></font>
<font color=#447700>! density reaching the portion of the wall between z2 and z1 <a name='2927'></font>
<font color=#447700>! (everything is assumed in 2D)<a name='2928'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2929'></font>
<a name='2930'>
      implicit none<a name='2931'>
      <a name='2932'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2933'></font>
<font color=#447700>! INPUT:<a name='2934'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2935'></font>
      real aa                   <font color=#447700>! Angle between the sun direction and the face of the wall (A12)<a name='2936'></font>
      real hu                   <font color=#447700>! Height of the building that generates the shadow<a name='2937'></font>
      real phix                 <font color=#447700>! Solar zenith angle<a name='2938'></font>
      real ws                   <font color=#447700>! Width of the street<a name='2939'></font>
      real z1                   <font color=#447700>! Height of the level z(iz)<a name='2940'></font>
      real z2                   <font color=#447700>! Height of the level z(iz+1)<a name='2941'></font>
<a name='2942'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2943'></font>
<font color=#447700>! OUTPUT:<a name='2944'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2945'></font>
      real rd                   <font color=#447700>! Ratio between (x1-x2)/(z2-z1), see Fig. 1A. <a name='2946'></font>
                                <font color=#447700>! Multiplying rd by rs (radiation flux <a name='2947'></font>
                                <font color=#447700>! density on a horizontal surface) gives <a name='2948'></font>
                                <font color=#447700>! the radiation flux density on the <a name='2949'></font>
                                <font color=#447700>! portion of wall between z1 and z2. <a name='2950'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2951'></font>
<font color=#447700>! LOCAL:<a name='2952'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2953'></font>
      real x1,x2                <font color=#447700>! x1,x2 see Fig. A1.<a name='2954'></font>
<a name='2955'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2956'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='2957'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2958'></font>
<a name='2959'>
      x1=min((hu-z1)*tan(phix),max(0.,ws/sin(aa)))<a name='2960'>
      <a name='2961'>
      x2=max((hu-z2)*tan(phix),0.)<a name='2962'>
<a name='2963'>
      rd=max(0.,sin(aa)*(max(0.,x1-x2))/(z2-z1))<a name='2964'>
      <a name='2965'>
      return<a name='2966'>
      end subroutine shade_wall<a name='2967'>
<a name='2968'>
<font color=#447700>! ===6=8===============================================================72     <a name='2969'></font>
<font color=#447700>! ===6=8===============================================================72     <a name='2970'></font>
<a name='2971'>
<A NAME='LONG_RAD'><A href='../../html_code/phys/module_sf_bep_bem.F.html#LONG_RAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2972'>
      <font color=#993300>subroutine </font><font color=#cc0000>long_rad</font>(iurb,nz_u,id,emw,emg,emwin,pwin,twlev,&amp; <A href='../../call_to/LONG_RAD.html' TARGET='index'>2</A>,<A href='../../call_from/LONG_RAD.html' TARGET='index'>2</A><a name='2973'>
                         fwg,fww,fgw,fsw,fsg,tg,tw,rlg,rlw,rl,pb)<a name='2974'>
<a name='2975'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2976'></font>
<font color=#447700>! This routine computes the effects of the reflections of long-wave <a name='2977'></font>
<font color=#447700>! radiation in the street canyon by solving the system <a name='2978'></font>
<font color=#447700>! of 2*nz_u+1 eqn. in 2*nz_u+1<a name='2979'></font>
<font color=#447700>! unkonwn defined in A4, A5 and A6 of the paper (pages 295 and 296).<a name='2980'></font>
<font color=#447700>! The system is solved by solving A X= B,<a name='2981'></font>
<font color=#447700>! with A matrix B vector, and X solution. <a name='2982'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2983'></font>
<a name='2984'>
      implicit none<a name='2985'>
<a name='2986'>
  <a name='2987'>
      <a name='2988'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2989'></font>
<font color=#447700>! INPUT:<a name='2990'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2991'></font>
      real emg                        <font color=#447700>! Emissivity of ground for the current urban class<a name='2992'></font>
      real emw                        <font color=#447700>! Emissivity of wall for the current urban class<a name='2993'></font>
      real fgw(nz_um,ndm,nurbm)       <font color=#447700>! View factors from ground to wall<a name='2994'></font>
      real fsg(ndm,nurbm)             <font color=#447700>! View factors from sky to ground<a name='2995'></font>
      real fsw(nz_um,ndm,nurbm)       <font color=#447700>! View factors from sky to wall<a name='2996'></font>
      real fwg(nz_um,ndm,nurbm)       <font color=#447700>! View factors from wall to ground<a name='2997'></font>
      real fww(nz_um,nz_um,ndm,nurbm) <font color=#447700>! View factors from wall to wall<a name='2998'></font>
      integer id                      <font color=#447700>! Current street direction<a name='2999'></font>
      integer iurb                    <font color=#447700>! Current urban class<a name='3000'></font>
      integer nz_u                    <font color=#447700>! Number of layer in the urban grid<a name='3001'></font>
      real pb(nz_um)                  <font color=#447700>! Probability to have a building with an height equal<a name='3002'></font>
      real rl                         <font color=#447700>! Downward flux of the longwave radiation<a name='3003'></font>
      real tg(ndm,ng_u)               <font color=#447700>! Temperature in each layer of the ground [K]<a name='3004'></font>
      real tw(2*ndm,nz_um)            <font color=#447700>! Temperature in each layer of the wall [K]<a name='3005'></font>
<font color=#447700>!<a name='3006'></font>
<font color=#447700>!New Variables for BEM<a name='3007'></font>
<font color=#447700>!<a name='3008'></font>
      real twlev(2*ndm,nz_um)         <font color=#447700>! Window temperature in BEM [K]<a name='3009'></font>
      real emwin                      <font color=#447700>! Emissivity of windows<a name='3010'></font>
      real pwin                       <font color=#447700>! Coverage area fraction of windows in the walls of the buildings (BEM)<a name='3011'></font>
      <a name='3012'>
<a name='3013'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3014'></font>
<font color=#447700>! OUTPUT:<a name='3015'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3016'></font>
      real rlg(ndm)                   <font color=#447700>! Long wave radiation at the ground<a name='3017'></font>
      real rlw(2*ndm,nz_um)           <font color=#447700>! Long wave radiation at the walls<a name='3018'></font>
<a name='3019'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3020'></font>
<font color=#447700>! LOCAL:<a name='3021'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3022'></font>
      integer i,j<a name='3023'>
      real aaa(2*nz_um+1,2*nz_um+1)   <font color=#447700>! terms of the matrix<a name='3024'></font>
      real bbb(2*nz_um+1)             <font color=#447700>! terms of the vector<a name='3025'></font>
<a name='3026'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3027'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='3028'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3029'></font>
<a name='3030'>
<a name='3031'>
<font color=#447700>! west wall<a name='3032'></font>
       <a name='3033'>
      do i=1,nz_u<a name='3034'>
        <a name='3035'>
        do j=1,nz_u<a name='3036'>
         aaa(i,j)=0.<a name='3037'>
        enddo<a name='3038'>
        <a name='3039'>
        aaa(i,i)=1.        <a name='3040'>
       <a name='3041'>
        do j=nz_u+1,2*nz_u<a name='3042'>
         aaa(i,j)=-(1.-emw*(1.-pwin)-emwin*pwin)* &amp;<a name='3043'>
                  fww(j-nz_u,i,id,iurb)*pb(j-nz_u+1)<a name='3044'>
        enddo<a name='3045'>
        <a name='3046'>
<font color=#447700>!!      aaa(i,2*nz_u+1)=-(1.-emg)*fgw(i,id,iurb)*pb(i+1)<a name='3047'></font>
        aaa(i,2*nz_u+1)=-(1.-emg)*fgw(i,id,iurb)<a name='3048'>
        <a name='3049'>
        bbb(i)=fsw(i,id,iurb)*rl+emg*fgw(i,id,iurb)*sigma*tg(id,ng_u)**4<a name='3050'>
        do j=1,nz_u<a name='3051'>
           bbb(i)=bbb(i)+pb(j+1)*sigma*fww(j,i,id,iurb)* &amp;<a name='3052'>
                 (emw*(1.-pwin)*tw(2*id,j)**4+emwin*pwin*twlev(2*id,j)**4)+ &amp;<a name='3053'>
                 fww(j,i,id,iurb)*rl*(1.-pb(j+1))<a name='3054'>
        enddo<a name='3055'>
        <a name='3056'>
       enddo<a name='3057'>
       <a name='3058'>
<font color=#447700>! east wall<a name='3059'></font>
<a name='3060'>
       do i=1+nz_u,2*nz_u<a name='3061'>
        <a name='3062'>
        do j=1,nz_u<a name='3063'>
         aaa(i,j)=-(1.-emw*(1.-pwin)-emwin*pwin)*fww(j,i-nz_u,id,iurb)*pb(j+1)<a name='3064'>
        enddo<a name='3065'>
        <a name='3066'>
        do j=1+nz_u,2*nz_u<a name='3067'>
         aaa(i,j)=0.<a name='3068'>
        enddo<a name='3069'>
        <a name='3070'>
        aaa(i,i)=1.<a name='3071'>
        <a name='3072'>
<font color=#447700>!!      aaa(i,2*nz_u+1)=-(1.-emg)*fgw(i-nz_u,id,iurb)*pb(i-nz_u+1)<a name='3073'></font>
        aaa(i,2*nz_u+1)=-(1.-emg)*fgw(i-nz_u,id,iurb)<a name='3074'>
        <a name='3075'>
        bbb(i)=fsw(i-nz_u,id,iurb)*rl+  &amp;     <a name='3076'>
               emg*fgw(i-nz_u,id,iurb)*sigma*tg(id,ng_u)**4<a name='3077'>
<a name='3078'>
        do j=1,nz_u<a name='3079'>
         bbb(i)=bbb(i)+pb(j+1)*sigma*fww(j,i-nz_u,id,iurb)*  &amp;   <a name='3080'>
                (emw*(1.-pwin)*tw(2*id-1,j)**4+emwin*pwin*twlev(2*id-1,j)**4)+&amp;   <a name='3081'>
                fww(j,i-nz_u,id,iurb)*rl*(1.-pb(j+1))<a name='3082'>
        enddo<a name='3083'>
       <a name='3084'>
       enddo<a name='3085'>
<a name='3086'>
<font color=#447700>! ground<a name='3087'></font>
       do j=1,nz_u<a name='3088'>
        aaa(2*nz_u+1,j)=-(1.-emw*(1.-pwin)-emwin*pwin)* &amp;<a name='3089'>
                         fwg(j,id,iurb)*pb(j+1)<a name='3090'>
       enddo<a name='3091'>
       <a name='3092'>
       do j=nz_u+1,2*nz_u<a name='3093'>
        aaa(2*nz_u+1,j)=-(1.-emw*(1.-pwin)-emwin*pwin)* &amp;<a name='3094'>
                         fwg(j-nz_u,id,iurb)*pb(j-nz_u+1)<a name='3095'>
       enddo<a name='3096'>
       <a name='3097'>
       aaa(2*nz_u+1,2*nz_u+1)=1.<a name='3098'>
       <a name='3099'>
       bbb(2*nz_u+1)=fsg(id,iurb)*rl<a name='3100'>
       <a name='3101'>
       do i=1,nz_u<a name='3102'>
        bbb(2*nz_u+1)=bbb(2*nz_u+1)+sigma*fwg(i,id,iurb)*pb(i+1)*         &amp;<a name='3103'>
                      (emw*(1.-pwin)*(tw(2*id-1,i)**4+tw(2*id,i)**4)+     &amp;<a name='3104'>
                      emwin*pwin*(twlev(2*id-1,i)**4+twlev(2*id,i)**4))+  &amp;<a name='3105'>
                      2.*fwg(i,id,iurb)*(1.-pb(i+1))*rl                  <a name='3106'>
       enddo<a name='3107'>
   <a name='3108'>
<a name='3109'>
     <a name='3110'>
       call <A href='../../html_code/phys/module_sf_bep_bem.F.html#GAUSSJ'>gaussj</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#LONG_RAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAUSSJ_3">(aaa,2*nz_u+1,bbb,2*nz_um+1)<a name='3111'>
<a name='3112'>
       do i=1,nz_u<a name='3113'>
        rlw(2*id-1,i)=bbb(i)<a name='3114'>
       enddo<a name='3115'>
       <a name='3116'>
       do i=nz_u+1,2*nz_u<a name='3117'>
        rlw(2*id,i-nz_u)=bbb(i)<a name='3118'>
       enddo<a name='3119'>
       <a name='3120'>
       rlg(id)=bbb(2*nz_u+1)<a name='3121'>
  <a name='3122'>
       return<a name='3123'>
       end subroutine long_rad<a name='3124'>
             <a name='3125'>
<font color=#447700>! ===6=8===============================================================72<a name='3126'></font>
<font color=#447700>! ===6=8===============================================================72<a name='3127'></font>
<a name='3128'>
<A NAME='SHORT_RAD'><A href='../../html_code/phys/module_sf_bep_bem.F.html#SHORT_RAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3129'>
       <font color=#993300>subroutine </font><font color=#cc0000>short_rad</font>(iurb,nz_u,id,albw,                        &amp;  <A href='../../call_to/SHORT_RAD.html' TARGET='index'>2</A>,<A href='../../call_from/SHORT_RAD.html' TARGET='index'>2</A><a name='3130'>
                           albg,fwg,fww,fgw,rsg,rsw,pb)<a name='3131'>
<a name='3132'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3133'></font>
<font color=#447700>! This routine computes the effects of the reflections of short-wave <a name='3134'></font>
<font color=#447700>! (solar) radiation in the street canyon by solving the system <a name='3135'></font>
<font color=#447700>! of 2*nz_u+1 eqn. in 2*nz_u+1<a name='3136'></font>
<font color=#447700>! unkonwn defined in A4, A5 and A6 of the paper (pages 295 and 296).<a name='3137'></font>
<font color=#447700>! The system is solved by solving A X= B,<a name='3138'></font>
<font color=#447700>! with A matrix B vector, and X solution. <a name='3139'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3140'></font>
<a name='3141'>
      implicit none<a name='3142'>
<a name='3143'>
  <a name='3144'>
      <a name='3145'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3146'></font>
<font color=#447700>! INPUT:<a name='3147'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3148'></font>
      real albg                 <font color=#447700>! Albedo of the ground for the current urban class<a name='3149'></font>
      real albw                 <font color=#447700>! Albedo of the wall for the current urban class<a name='3150'></font>
      real fgw(nz_um,ndm,nurbm)       <font color=#447700>! View factors from ground to wall<a name='3151'></font>
      real fwg(nz_um,ndm,nurbm)       <font color=#447700>! View factors from wall to ground<a name='3152'></font>
      real fww(nz_um,nz_um,ndm,nurbm) <font color=#447700>! View factors from wall to wall<a name='3153'></font>
      integer id                <font color=#447700>! current street direction <a name='3154'></font>
      integer iurb              <font color=#447700>! current urban class<a name='3155'></font>
      integer nz_u              <font color=#447700>! Number of layer in the urban grid<a name='3156'></font>
      real pb(nz_um)          <font color=#447700>! probability to have a building with an height equal<a name='3157'></font>
<a name='3158'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3159'></font>
<font color=#447700>! OUTPUT:<a name='3160'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3161'></font>
      real rsg(ndm)             <font color=#447700>! Short wave radiation at the ground<a name='3162'></font>
      real rsw(2*ndm,nz_um)     <font color=#447700>! Short wave radiation at the walls<a name='3163'></font>
<a name='3164'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3165'></font>
<font color=#447700>! LOCAL:<a name='3166'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3167'></font>
      integer i,j<a name='3168'>
      real aaa(2*nz_um+1,2*nz_um+1)  <font color=#447700>! terms of the matrix<a name='3169'></font>
      real bbb(2*nz_um+1)            <font color=#447700>! terms of the vector<a name='3170'></font>
<a name='3171'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3172'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='3173'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3174'></font>
<a name='3175'>
      <a name='3176'>
<font color=#447700>! west wall<a name='3177'></font>
       <a name='3178'>
      do i=1,nz_u<a name='3179'>
         do j=1,nz_u<a name='3180'>
            aaa(i,j)=0.<a name='3181'>
         enddo<a name='3182'>
         <a name='3183'>
         aaa(i,i)=1.        <a name='3184'>
         <a name='3185'>
         do j=nz_u+1,2*nz_u<a name='3186'>
            aaa(i,j)=-albw*fww(j-nz_u,i,id,iurb)*pb(j-nz_u+1)<a name='3187'>
         enddo<a name='3188'>
         <a name='3189'>
         aaa(i,2*nz_u+1)=-albg*fgw(i,id,iurb)<a name='3190'>
         bbb(i)=rsw(2*id-1,i)<a name='3191'>
         <a name='3192'>
      enddo<a name='3193'>
       <a name='3194'>
<font color=#447700>! east wall<a name='3195'></font>
<a name='3196'>
      do i=1+nz_u,2*nz_u<a name='3197'>
         do j=1,nz_u<a name='3198'>
            aaa(i,j)=-albw*fww(j,i-nz_u,id,iurb)*pb(j+1)<a name='3199'>
         enddo<a name='3200'>
         <a name='3201'>
         do j=1+nz_u,2*nz_u<a name='3202'>
            aaa(i,j)=0.<a name='3203'>
         enddo<a name='3204'>
         <a name='3205'>
        aaa(i,i)=1.<a name='3206'>
        aaa(i,2*nz_u+1)=-albg*fgw(i-nz_u,id,iurb)<a name='3207'>
        bbb(i)=rsw(2*id,i-nz_u)<a name='3208'>
        <a name='3209'>
      enddo<a name='3210'>
<a name='3211'>
<font color=#447700>! ground<a name='3212'></font>
<a name='3213'>
      do j=1,nz_u<a name='3214'>
         aaa(2*nz_u+1,j)=-albw*fwg(j,id,iurb)*pb(j+1)<a name='3215'>
      enddo<a name='3216'>
       <a name='3217'>
      do j=nz_u+1,2*nz_u<a name='3218'>
         aaa(2*nz_u+1,j)=-albw*fwg(j-nz_u,id,iurb)*pb(j-nz_u+1)<a name='3219'>
      enddo<a name='3220'>
       <a name='3221'>
      aaa(2*nz_u+1,2*nz_u+1)=1.<a name='3222'>
      bbb(2*nz_u+1)=rsg(id)<a name='3223'>
       <a name='3224'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#GAUSSJ'>gaussj</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#SHORT_RAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAUSSJ_4">(aaa,2*nz_u+1,bbb,2*nz_um+1)<a name='3225'>
<a name='3226'>
      do i=1,nz_u<a name='3227'>
         rsw(2*id-1,i)=bbb(i)<a name='3228'>
      enddo<a name='3229'>
       <a name='3230'>
      do i=nz_u+1,2*nz_u<a name='3231'>
         rsw(2*id,i-nz_u)=bbb(i) <a name='3232'>
      enddo<a name='3233'>
       <a name='3234'>
      rsg(id)=bbb(2*nz_u+1)<a name='3235'>
       <a name='3236'>
      return<a name='3237'>
      end subroutine short_rad<a name='3238'>
             <a name='3239'>
<a name='3240'>
<font color=#447700>! ===6=8===============================================================72     <a name='3241'></font>
<font color=#447700>! ===6=8===============================================================72     <a name='3242'></font>
      <a name='3243'>
<A NAME='GAUSSJ'><A href='../../html_code/phys/module_sf_bep_bem.F.html#GAUSSJ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3244'>
      <font color=#993300>subroutine </font><font color=#cc0000>gaussj</font>(a,n,b,np) <A href='../../call_to/GAUSSJ.html' TARGET='index'>4</A>,<A href='../../call_from/GAUSSJ.html' TARGET='index'>4</A><a name='3245'>
<a name='3246'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3247'></font>
<font color=#447700>! This routine solve a linear system of n equations of the form<a name='3248'></font>
<font color=#447700>!              A X = B<a name='3249'></font>
<font color=#447700>!  where  A is a matrix a(i,j)<a name='3250'></font>
<font color=#447700>!         B a vector and X the solution<a name='3251'></font>
<font color=#447700>! In output b is replaced by the solution     <a name='3252'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3253'></font>
<a name='3254'>
      implicit none<a name='3255'>
<a name='3256'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3257'></font>
<font color=#447700>! INPUT:<a name='3258'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3259'></font>
      integer np<a name='3260'>
      real a(np,np)<a name='3261'>
<a name='3262'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3263'></font>
<font color=#447700>! OUTPUT:<a name='3264'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3265'></font>
      real b(np)<a name='3266'>
<a name='3267'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3268'></font>
<font color=#447700>! LOCAL:<a name='3269'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3270'></font>
      integer nmax<a name='3271'>
      parameter (nmax=150)<a name='3272'>
<a name='3273'>
      real big,dum<a name='3274'>
      integer i,icol,irow<a name='3275'>
      integer j,k,l,ll,n<a name='3276'>
      integer ipiv(nmax)<a name='3277'>
      real pivinv<a name='3278'>
<a name='3279'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3280'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='3281'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3282'></font>
       <a name='3283'>
      do j=1,n<a name='3284'>
         ipiv(j)=0.<a name='3285'>
      enddo<a name='3286'>
       <a name='3287'>
      do i=1,n<a name='3288'>
         big=0.<a name='3289'>
         do j=1,n<a name='3290'>
            if(ipiv(j).ne.1)then<a name='3291'>
               do k=1,n<a name='3292'>
                  if(ipiv(k).eq.0)then<a name='3293'>
                     if(abs(a(j,k)).ge.big)then<a name='3294'>
                        big=abs(a(j,k))<a name='3295'>
                        irow=j<a name='3296'>
                        icol=k<a name='3297'>
                     endif<a name='3298'>
                  elseif(ipiv(k).gt.1)then<a name='3299'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#GAUSSJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1136">('singular matrix in gaussj')<a name='3300'>
                  endif<a name='3301'>
               enddo<a name='3302'>
            endif<a name='3303'>
         enddo<a name='3304'>
         <a name='3305'>
         ipiv(icol)=ipiv(icol)+1<a name='3306'>
         <a name='3307'>
         if(irow.ne.icol)then<a name='3308'>
            do l=1,n<a name='3309'>
               dum=a(irow,l)<a name='3310'>
               a(irow,l)=a(icol,l)<a name='3311'>
               a(icol,l)=dum<a name='3312'>
            enddo<a name='3313'>
            <a name='3314'>
            dum=b(irow)<a name='3315'>
            b(irow)=b(icol)<a name='3316'>
            b(icol)=dum<a name='3317'>
          <a name='3318'>
         endif<a name='3319'>
         <a name='3320'>
         if(a(icol,icol).eq.0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#GAUSSJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1137">('singular matrix in gaussj')<a name='3321'>
         <a name='3322'>
         pivinv=1./a(icol,icol)<a name='3323'>
         a(icol,icol)=1<a name='3324'>
         <a name='3325'>
         do l=1,n<a name='3326'>
            a(icol,l)=a(icol,l)*pivinv<a name='3327'>
         enddo<a name='3328'>
         <a name='3329'>
         b(icol)=b(icol)*pivinv<a name='3330'>
         <a name='3331'>
         do ll=1,n<a name='3332'>
            if(ll.ne.icol)then<a name='3333'>
               dum=a(ll,icol)<a name='3334'>
               a(ll,icol)=0.<a name='3335'>
               do l=1,n<a name='3336'>
                  a(ll,l)=a(ll,l)-a(icol,l)*dum<a name='3337'>
               enddo<a name='3338'>
               <a name='3339'>
               b(ll)=b(ll)-b(icol)*dum<a name='3340'>
               <a name='3341'>
            endif<a name='3342'>
         enddo<a name='3343'>
      enddo<a name='3344'>
      <a name='3345'>
      return<a name='3346'>
      end subroutine gaussj<a name='3347'>
         <a name='3348'>
<font color=#447700>! ===6=8===============================================================72     <a name='3349'></font>
<font color=#447700>! ===6=8===============================================================72     <a name='3350'></font>
       <a name='3351'>
<A NAME='SOIL_TEMP'><A href='../../html_code/phys/module_sf_bep_bem.F.html#SOIL_TEMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3352'>
      <font color=#993300>subroutine </font><font color=#cc0000>soil_temp</font>(nz,dz,temp,pt,ala,cs,                       &amp; <A href='../../call_to/SOIL_TEMP.html' TARGET='index'>5</A>,<A href='../../call_from/SOIL_TEMP.html' TARGET='index'>2</A><a name='3353'>
                          rs,rl,press,dt,em,alb,rt,sf,gf)<a name='3354'>
<a name='3355'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3356'></font>
<font color=#447700>! This routine solves the Fourier diffusion equation for heat in <a name='3357'></font>
<font color=#447700>! the material (wall, roof, or ground). Resolution is done implicitely.<a name='3358'></font>
<font color=#447700>! Boundary conditions are: <a name='3359'></font>
<font color=#447700>! - fixed temperature at the interior<a name='3360'></font>
<font color=#447700>! - energy budget at the surface<a name='3361'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3362'></font>
<a name='3363'>
      implicit none<a name='3364'>
<a name='3365'>
     <a name='3366'>
                <a name='3367'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3368'></font>
<font color=#447700>! INPUT:<a name='3369'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3370'></font>
      integer nz                <font color=#447700>! Number of layers<a name='3371'></font>
      real ala(nz)              <font color=#447700>! Thermal diffusivity in each layers [m^2 s^-1] <a name='3372'></font>
      real alb                  <font color=#447700>! Albedo of the surface<a name='3373'></font>
      real cs(nz)               <font color=#447700>! Specific heat of the material [J m^3 K^-1]<a name='3374'></font>
      real dt                   <font color=#447700>! Time step<a name='3375'></font>
      real em                   <font color=#447700>! Emissivity of the surface<a name='3376'></font>
      real press                <font color=#447700>! Pressure at ground level<a name='3377'></font>
      real rl                   <font color=#447700>! Downward flux of the longwave radiation<a name='3378'></font>
      real rs                   <font color=#447700>! Solar radiation<a name='3379'></font>
      real sf                   <font color=#447700>! Sensible heat flux at the surface<a name='3380'></font>
      real temp(nz)             <font color=#447700>! Temperature in each layer [K]<a name='3381'></font>
      real dz(nz)               <font color=#447700>! Layer sizes [m]<a name='3382'></font>
<a name='3383'>
<a name='3384'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3385'></font>
<font color=#447700>! OUTPUT:<a name='3386'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3387'></font>
      real gf                   <font color=#447700>! Heat flux transferred from the surface toward the interior<a name='3388'></font>
      real pt                   <font color=#447700>! Potential temperature at the surface<a name='3389'></font>
      real rt                   <font color=#447700>! Total radiation at the surface (solar+incoming long+outgoing long)<a name='3390'></font>
<a name='3391'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3392'></font>
<font color=#447700>! LOCAL:<a name='3393'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3394'></font>
      integer iz<a name='3395'>
      real a(nz,3)<a name='3396'>
      real alpha<a name='3397'>
      real c(nz)<a name='3398'>
      real cddz(nz+2)<a name='3399'>
      real tsig<a name='3400'>
<a name='3401'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3402'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='3403'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3404'></font>
       <a name='3405'>
      tsig=temp(nz)<a name='3406'>
      alpha=(1.-alb)*rs+em*rl-em*sigma*(tsig**4)+sf<a name='3407'>
<font color=#447700>! Compute cddz=2*cd/dz  <a name='3408'></font>
        <a name='3409'>
      cddz(1)=ala(1)/dz(1)<a name='3410'>
      do iz=2,nz<a name='3411'>
         cddz(iz)=2.*ala(iz)/(dz(iz)+dz(iz-1))<a name='3412'>
      enddo<a name='3413'>
<font color=#447700>!        cddz(nz+1)=ala(nz+1)/dz(nz)<a name='3414'></font>
       <a name='3415'>
      a(1,1)=0.<a name='3416'>
      a(1,2)=1.<a name='3417'>
      a(1,3)=0.<a name='3418'>
      c(1)=temp(1)<a name='3419'>
          <a name='3420'>
      do iz=2,nz-1<a name='3421'>
         a(iz,1)=-cddz(iz)*dt/dz(iz)<a name='3422'>
         a(iz,2)=1+dt*(cddz(iz)+cddz(iz+1))/dz(iz)          <a name='3423'>
         a(iz,3)=-cddz(iz+1)*dt/dz(iz)<a name='3424'>
         c(iz)=temp(iz)<a name='3425'>
      enddo          <a name='3426'>
                     <a name='3427'>
      a(nz,1)=-dt*cddz(nz)/dz(nz)<a name='3428'>
      a(nz,2)=1.+dt*cddz(nz)/dz(nz)<a name='3429'>
      a(nz,3)=0.<a name='3430'>
      c(nz)=temp(nz)+dt*alpha/cs(nz)/dz(nz)<a name='3431'>
<a name='3432'>
      <a name='3433'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INVERT'>invert</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#SOIL_TEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INVERT_4">(nz,a,c,temp)<a name='3434'>
<a name='3435'>
           <a name='3436'>
      pt=temp(nz)*(press/1.e+5)**(-rcp_u)<a name='3437'>
<a name='3438'>
      rt=(1.-alb)*rs+em*rl-em*sigma*(tsig**4)<a name='3439'>
                        <a name='3440'>
<font color=#447700>!      gf=-cddz(nz)*(temp(nz)-temp(nz-1))*cs(nz)<a name='3441'></font>
       gf=(1.-alb)*rs+em*rl-em*sigma*(tsig**4)+sf                                   <a name='3442'>
      return<a name='3443'>
      end subroutine soil_temp<a name='3444'>
<a name='3445'>
<font color=#447700>! ===6=8===============================================================72 <a name='3446'></font>
<font color=#447700>! ===6=8===============================================================72 <a name='3447'></font>
<a name='3448'>
<A NAME='INVERT'><A href='../../html_code/phys/module_sf_bep_bem.F.html#INVERT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3449'>
      <font color=#993300>subroutine </font><font color=#cc0000>invert</font>(n,a,c,x) <A href='../../call_to/INVERT.html' TARGET='index'>4</A><a name='3450'>
<a name='3451'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3452'></font>
<font color=#447700>!        Inversion and resolution of a tridiagonal matrix<a name='3453'></font>
<font color=#447700>!                   A X = C<a name='3454'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3455'></font>
<a name='3456'>
      implicit none<a name='3457'>
                <a name='3458'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3459'></font>
<font color=#447700>! INPUT:<a name='3460'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3461'></font>
       integer n<a name='3462'>
       real a(n,3)              <font color=#447700>!  a(*,1) lower diagonal (Ai,i-1)<a name='3463'></font>
                                <font color=#447700>!  a(*,2) principal diagonal (Ai,i)<a name='3464'></font>
                                <font color=#447700>!  a(*,3) upper diagonal (Ai,i+1)<a name='3465'></font>
       real c(n)<a name='3466'>
<a name='3467'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3468'></font>
<font color=#447700>! OUTPUT:<a name='3469'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3470'></font>
       real x(n)    <a name='3471'>
<a name='3472'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3473'></font>
<font color=#447700>! LOCAL:<a name='3474'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3475'></font>
       integer i<a name='3476'>
<a name='3477'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3478'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='3479'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3480'></font>
                     <a name='3481'>
       do i=n-1,1,-1                 <a name='3482'>
          c(i)=c(i)-a(i,3)*c(i+1)/a(i+1,2)<a name='3483'>
          a(i,2)=a(i,2)-a(i,3)*a(i+1,1)/a(i+1,2)<a name='3484'>
       enddo<a name='3485'>
       <a name='3486'>
       do i=2,n        <a name='3487'>
          c(i)=c(i)-a(i,1)*c(i-1)/a(i-1,2)<a name='3488'>
       enddo<a name='3489'>
        <a name='3490'>
       do i=1,n<a name='3491'>
          x(i)=c(i)/a(i,2)<a name='3492'>
       enddo<a name='3493'>
<a name='3494'>
       return<a name='3495'>
       end subroutine invert<a name='3496'>
  <a name='3497'>
<a name='3498'>
<font color=#447700>! ===6=8===============================================================72  <a name='3499'></font>
<font color=#447700>! ===6=8===============================================================72<a name='3500'></font>
  <a name='3501'>
<A NAME='FLUX_WALL'><A href='../../html_code/phys/module_sf_bep_bem.F.html#FLUX_WALL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3502'>
      <font color=#993300>subroutine </font><font color=#cc0000>flux_wall</font>(ua,va,pt,da,ptw,ptwin,uva,vva,uvb,vvb,  &amp; <A href='../../call_to/FLUX_WALL.html' TARGET='index'>4</A><a name='3503'>
                           sfw,sfwin,evb,drst,dt)         <a name='3504'>
       <a name='3505'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3506'></font>
<font color=#447700>! This routine computes the surface sources or sinks of momentum, tke,<a name='3507'></font>
<font color=#447700>! and heat from vertical surfaces (walls).   <a name='3508'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3509'></font>
      implicit none   <a name='3510'>
         <a name='3511'>
<font color=#447700>! INPUT:<a name='3512'></font>
<font color=#447700>! -----<a name='3513'></font>
      real drst                 <font color=#447700>! street directions for the current urban class<a name='3514'></font>
      real da                   <font color=#447700>! air density<a name='3515'></font>
      real pt                   <font color=#447700>! potential temperature<a name='3516'></font>
      real ptw                  <font color=#447700>! Walls potential temperatures <a name='3517'></font>
      real ptwin                <font color=#447700>! Windows potential temperatures<a name='3518'></font>
      real ua                   <font color=#447700>! wind speed<a name='3519'></font>
      real va                   <font color=#447700>! wind speed<a name='3520'></font>
      real dt                   <font color=#447700>!time step<a name='3521'></font>
<a name='3522'>
<font color=#447700>! OUTPUT:<a name='3523'></font>
<font color=#447700>! ------<a name='3524'></font>
<font color=#447700>! Explicit and implicit component of the momentum, temperature and TKE sources or sinks on<a name='3525'></font>
<font color=#447700>! vertical surfaces (walls).<a name='3526'></font>
<font color=#447700>! The fluxes can be computed as follow: Fluxes of X = A*X + B<a name='3527'></font>
<font color=#447700>! Example: Momentum fluxes on vertical surfaces = uva_u * ua_u + uvb_u<a name='3528'></font>
<a name='3529'>
      real uva                  <font color=#447700>! U (wind component)   Vertical surfaces, A (implicit) term<a name='3530'></font>
      real uvb                  <font color=#447700>! U (wind component)   Vertical surfaces, B (explicit) term<a name='3531'></font>
      real vva                  <font color=#447700>! V (wind component)   Vertical surfaces, A (implicit) term<a name='3532'></font>
      real vvb                  <font color=#447700>! V (wind component)   Vertical surfaces, B (explicit) term<a name='3533'></font>
      real tva                  <font color=#447700>! Temperature          Vertical surfaces, A (implicit) term<a name='3534'></font>
      real tvb                  <font color=#447700>! Temperature          Vertical surfaces, B (explicit) term<a name='3535'></font>
      real evb                  <font color=#447700>! Energy (TKE)         Vertical surfaces, B (explicit) term<a name='3536'></font>
      real sfw                  <font color=#447700>! Surfaces fluxes from the walls<a name='3537'></font>
      real sfwin                <font color=#447700>! Surfaces fluxes from the windows<a name='3538'></font>
<a name='3539'>
<font color=#447700>! LOCAL:<a name='3540'></font>
<font color=#447700>! -----<a name='3541'></font>
      real hc<a name='3542'>
      real hcwin<a name='3543'>
      real u_ort<a name='3544'>
      real vett<a name='3545'>
<a name='3546'>
<a name='3547'>
<font color=#447700>! -------------------------<a name='3548'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='3549'></font>
<font color=#447700>! -------------------------<a name='3550'></font>
<a name='3551'>
      vett=(ua**2+va**2)**.5         <a name='3552'>
         <a name='3553'>
      u_ort=abs((cos(drst)*ua-sin(drst)*va))<a name='3554'>
       <a name='3555'>
      uva=-cdrag*u_ort/2.*cos(drst)*cos(drst)<a name='3556'>
      vva=-cdrag*u_ort/2.*sin(drst)*sin(drst)<a name='3557'>
         <a name='3558'>
      uvb=cdrag*u_ort/2.*sin(drst)*cos(drst)*va<a name='3559'>
      vvb=cdrag*u_ort/2.*sin(drst)*cos(drst)*ua         <a name='3560'>
<a name='3561'>
      if (vett.lt.4.88) then   <a name='3562'>
         hc=5.678*(1.09+0.23*(vett/0.3048))  <a name='3563'>
      else<a name='3564'>
         hc=5.678*0.53*((vett/0.3048)**0.78)<a name='3565'>
      endif <a name='3566'>
<a name='3567'>
      if (hc.gt.da*cp_u/dt)then<a name='3568'>
         hc=da*cp_u/dt<a name='3569'>
      endif<a name='3570'>
<a name='3571'>
       if (vett.lt.4.88) then<a name='3572'>
          hcwin=5.678*(0.99+0.21*(vett/0.3048))<a name='3573'>
       else<a name='3574'>
          hcwin=5.678*0.50*((vett/0.3048)**0.78)<a name='3575'>
       endif<a name='3576'>
<a name='3577'>
       if (hcwin.gt.da*cp_u/dt) then<a name='3578'>
           hcwin=da*cp_u/dt<a name='3579'>
       endif<a name='3580'>
         <a name='3581'>
<font color=#447700>!         tvb=hc*ptw/da/cp_u<a name='3582'></font>
<font color=#447700>!         tva=-hc/da/cp_u<a name='3583'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!<a name='3584'></font>
<font color=#447700>! explicit <a name='3585'></font>
<a name='3586'>
      sfw=hc*(pt-ptw)<a name='3587'>
      sfwin=hcwin*(pt-ptwin)  <a name='3588'>
       <a name='3589'>
         <a name='3590'>
      evb=cdrag*(abs(u_ort)**3.)/2.<a name='3591'>
              <a name='3592'>
      return<a name='3593'>
      end subroutine flux_wall<a name='3594'>
         <a name='3595'>
<font color=#447700>! ===6=8===============================================================72<a name='3596'></font>
<font color=#447700>! ===6=8===============================================================72<a name='3597'></font>
<a name='3598'>
<A NAME='FLUX_FLAT'><A href='../../html_code/phys/module_sf_bep_bem.F.html#FLUX_FLAT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3599'>
      <font color=#993300>subroutine </font><font color=#cc0000>flux_flat</font>(dz,z0,ua,va,pt,pt0,ptg,                     &amp; <A href='../../call_to/FLUX_FLAT.html' TARGET='index'>4</A><a name='3600'>
                          uhb,vhb,sf,ehb,da)<a name='3601'>
                                <a name='3602'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3603'></font>
<font color=#447700>!           Calculation of the flux at the ground <a name='3604'></font>
<font color=#447700>!           Formulation of Louis (Louis, 1979)       <a name='3605'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3606'></font>
<a name='3607'>
      implicit none<a name='3608'>
<a name='3609'>
      real dz                   <font color=#447700>! first vertical level<a name='3610'></font>
      real pt                   <font color=#447700>! potential temperature<a name='3611'></font>
      real pt0                  <font color=#447700>! reference potential temperature<a name='3612'></font>
      real ptg                  <font color=#447700>! ground potential temperature<a name='3613'></font>
      real ua                   <font color=#447700>! wind speed<a name='3614'></font>
      real va                   <font color=#447700>! wind speed<a name='3615'></font>
      real z0                   <font color=#447700>! Roughness length<a name='3616'></font>
      real da                   <font color=#447700>! air density<a name='3617'></font>
      <a name='3618'>
     <a name='3619'>
<a name='3620'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3621'></font>
<font color=#447700>! OUTPUT:<a name='3622'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3623'></font>
<font color=#447700>! Explicit component of the momentum, temperature and TKE sources or sinks on horizontal <a name='3624'></font>
<font color=#447700>!  surfaces (roofs and street)<a name='3625'></font>
<font color=#447700>! The fluxes can be computed as follow: Fluxes of X = B<a name='3626'></font>
<font color=#447700>!  Example: Momentum fluxes on horizontal surfaces =  uhb_u<a name='3627'></font>
      real uhb                  <font color=#447700>! U (wind component) Horizontal surfaces, B (explicit) term<a name='3628'></font>
      real vhb                  <font color=#447700>! V (wind component) Horizontal surfaces, B (explicit) term<a name='3629'></font>
<font color=#447700>!     real thb                  ! Temperature        Horizontal surfaces, B (explicit) term<a name='3630'></font>
      real tva                  <font color=#447700>! Temperature          Vertical surfaces, A (implicit) term<a name='3631'></font>
      real tvb                  <font color=#447700>! Temperature          Vertical surfaces, B (explicit) term<a name='3632'></font>
      real ehb                  <font color=#447700>! Energy (TKE)       Horizontal surfaces, B (explicit) term<a name='3633'></font>
      real sf<a name='3634'>
<a name='3635'>
<a name='3636'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3637'></font>
<font color=#447700>! LOCAL:<a name='3638'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3639'></font>
      real aa<a name='3640'>
      real al<a name='3641'>
      real buu<a name='3642'>
      real c<a name='3643'>
      real fbuw<a name='3644'>
      real fbpt<a name='3645'>
      real fh<a name='3646'>
      real fm<a name='3647'>
      real ric<a name='3648'>
      real tstar<a name='3649'>
      real ustar<a name='3650'>
      real utot<a name='3651'>
      real wstar<a name='3652'>
      real zz<a name='3653'>
      <a name='3654'>
      real b,cm,ch,rr,tol<a name='3655'>
      parameter(b=9.4,cm=7.4,ch=5.3,rr=0.74,tol=.001)<a name='3656'>
<a name='3657'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3658'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='3659'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3660'></font>
<a name='3661'>
<a name='3662'>
<font color=#447700>! computation of the ground temperature<a name='3663'></font>
         <a name='3664'>
      utot=(ua**2+va**2)**.5<a name='3665'>
        <a name='3666'>
      <a name='3667'>
<font color=#447700>!!!! Louis formulation<a name='3668'></font>
<font color=#447700>!<a name='3669'></font>
<font color=#447700>! compute the bulk Richardson Number<a name='3670'></font>
<a name='3671'>
      zz=dz/2.<a name='3672'>
   <a name='3673'>
<font color=#447700>!        if(tstar.lt.0.)then<a name='3674'></font>
<font color=#447700>!         wstar=(-ustar*tstar*g*hii/pt)**(1./3.)<a name='3675'></font>
<font color=#447700>!        else<a name='3676'></font>
<font color=#447700>!         wstar=0.<a name='3677'></font>
<font color=#447700>!        endif<a name='3678'></font>
<font color=#447700>!        <a name='3679'></font>
<font color=#447700>!      if (utot.le.0.7*wstar) utot=max(0.7*wstar,0.00001)<a name='3680'></font>
<a name='3681'>
      utot=max(utot,0.01)<a name='3682'>
          <a name='3683'>
      ric=2.*g_u*zz*(pt-ptg)/((pt+ptg)*(utot**2))<a name='3684'>
              <a name='3685'>
      aa=vk/log(zz/z0)<a name='3686'>
<a name='3687'>
<font color=#447700>! determine the parameters fm and fh for stable, neutral and unstable conditions<a name='3688'></font>
<a name='3689'>
      if(ric.gt.0)then<a name='3690'>
         fm=1/(1+0.5*b*ric)**2<a name='3691'>
         fh=fm<a name='3692'>
      else<a name='3693'>
         c=b*cm*aa*aa*(zz/z0)**.5<a name='3694'>
         fm=1-b*ric/(1+c*(-ric)**.5)<a name='3695'>
         c=c*ch/cm<a name='3696'>
         fh=1-b*ric/(1+c*(-ric)**.5)<a name='3697'>
      endif<a name='3698'>
      <a name='3699'>
      fbuw=-aa*aa*utot*utot*fm<a name='3700'>
      fbpt=-aa*aa*utot*(pt-ptg)*fh/rr<a name='3701'>
                     <a name='3702'>
      ustar=(-fbuw)**.5<a name='3703'>
      tstar=-fbpt/ustar<a name='3704'>
<a name='3705'>
      al=(vk*g_u*tstar)/(pt*ustar*ustar)                      <a name='3706'>
      <a name='3707'>
      buu=-g_u/pt0*ustar*tstar<a name='3708'>
       <a name='3709'>
      uhb=-ustar*ustar*ua/utot<a name='3710'>
      vhb=-ustar*ustar*va/utot <a name='3711'>
      sf= ustar*tstar*da*cp_u   <a name='3712'>
       <a name='3713'>
<font color=#447700>!     thb= 0.      <a name='3714'></font>
      ehb=buu<a name='3715'>
<font color=#447700>!!!!!!!!!!!!!!!<a name='3716'></font>
         <a name='3717'>
      return<a name='3718'>
      end subroutine flux_flat<a name='3719'>
<a name='3720'>
<font color=#447700>! ===6=8===============================================================72<a name='3721'></font>
<font color=#447700>! ===6=8===============================================================72<a name='3722'></font>
<a name='3723'>
<A NAME='ICBEP'><A href='../../html_code/phys/module_sf_bep_bem.F.html#ICBEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3724'>
      <font color=#993300>subroutine </font><font color=#cc0000>icBEP</font> (nd_u,h_b,d_b,ss_u,pb_u,nz_u,z_u)                                <A href='../../call_to/ICBEP.html' TARGET='index'>2</A><a name='3725'>
<a name='3726'>
      implicit none     <a name='3727'>
<a name='3728'>
<font color=#447700>!    Street parameters<a name='3729'></font>
      integer nd_u(nurbm)     <font color=#447700>! Number of street direction for each urban class<a name='3730'></font>
      real h_b(nz_um,nurbm)   <font color=#447700>! Bulding's heights [m]<a name='3731'></font>
      real d_b(nz_um,nurbm)   <font color=#447700>! The probability that a building has an height h_b<a name='3732'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='3733'></font>
<font color=#447700>!     Output<a name='3734'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3735'></font>
<a name='3736'>
      real ss_u(nz_um,nurbm)     <font color=#447700>! The probability that a building has an height equal to z<a name='3737'></font>
      real pb_u(nz_um,nurbm)     <font color=#447700>! The probability that a building has an height greater or equal to z<a name='3738'></font>
        <a name='3739'>
<font color=#447700>!    Grid parameters<a name='3740'></font>
      integer nz_u(nurbm)     <font color=#447700>! Number of layer in the urban grid<a name='3741'></font>
      real z_u(nz_um)       <font color=#447700>! Height of the urban grid levels<a name='3742'></font>
<a name='3743'>
<a name='3744'>
<font color=#447700>! -----------------------------------------------------------------------<a name='3745'></font>
<font color=#447700>!     Local<a name='3746'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3747'></font>
<a name='3748'>
      integer iz_u,id,ilu,iurb<a name='3749'>
<a name='3750'>
      real dtot<a name='3751'>
      real hbmax<a name='3752'>
<a name='3753'>
<font color=#447700>! -----------------------------------------------------------------------<a name='3754'></font>
<font color=#447700>!     This routine initialise the urban paramters for the BEP module<a name='3755'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3756'></font>
<font color=#447700>!<a name='3757'></font>
<font color=#447700>!Initialize variables<a name='3758'></font>
<font color=#447700>!<a name='3759'></font>
      nz_u=0<a name='3760'>
      z_u=0.<a name='3761'>
      ss_u=0.<a name='3762'>
      pb_u=0.<a name='3763'>
<a name='3764'>
<font color=#447700>! Computation of the urban levels height<a name='3765'></font>
 <a name='3766'>
      z_u(1)=0.<a name='3767'>
     <a name='3768'>
      do iz_u=1,nz_um-1<a name='3769'>
         z_u(iz_u+1)=z_u(iz_u)+dz_u<a name='3770'>
      enddo<a name='3771'>
      <a name='3772'>
<font color=#447700>! Normalisation of the building density<a name='3773'></font>
<a name='3774'>
      do iurb=1,nurbm<a name='3775'>
         dtot=0.<a name='3776'>
         do ilu=1,nz_um<a name='3777'>
            dtot=dtot+d_b(ilu,iurb)<a name='3778'>
         enddo<a name='3779'>
         do ilu=1,nz_um<a name='3780'>
            d_b(ilu,iurb)=d_b(ilu,iurb)/dtot<a name='3781'>
         enddo<a name='3782'>
      enddo      <a name='3783'>
<a name='3784'>
<font color=#447700>! Compute the view factors, pb and ss <a name='3785'></font>
      <a name='3786'>
      do iurb=1,nurbm         <a name='3787'>
         hbmax=0.<a name='3788'>
         nz_u(iurb)=0<a name='3789'>
         do ilu=1,nz_um<a name='3790'>
            if(h_b(ilu,iurb).gt.hbmax)hbmax=h_b(ilu,iurb)<a name='3791'>
         enddo<a name='3792'>
         <a name='3793'>
         do iz_u=1,nz_um-1<a name='3794'>
            if(z_u(iz_u+1).gt.hbmax)go to 10<a name='3795'>
         enddo<a name='3796'>
         <a name='3797'>
 10      continue<a name='3798'>
         nz_u(iurb)=iz_u+1<a name='3799'>
<a name='3800'>
         do id=1,nd_u(iurb)<a name='3801'>
<a name='3802'>
            do iz_u=1,nz_u(iurb)<a name='3803'>
               ss_u(iz_u,iurb)=0.<a name='3804'>
               do ilu=1,nz_um<a name='3805'>
                  if(z_u(iz_u).le.h_b(ilu,iurb)                      &amp;    <a name='3806'>
                    .and.z_u(iz_u+1).gt.h_b(ilu,iurb))then            <a name='3807'>
                        ss_u(iz_u,iurb)=ss_u(iz_u,iurb)+d_b(ilu,iurb)<a name='3808'>
                  endif <a name='3809'>
               enddo<a name='3810'>
            enddo<a name='3811'>
<a name='3812'>
            pb_u(1,iurb)=1.<a name='3813'>
            do iz_u=1,nz_u(iurb)<a name='3814'>
               pb_u(iz_u+1,iurb)=max(0.,pb_u(iz_u,iurb)-ss_u(iz_u,iurb))<a name='3815'>
            enddo<a name='3816'>
<a name='3817'>
         enddo<a name='3818'>
      end do<a name='3819'>
     <a name='3820'>
                  <a name='3821'>
      return       <a name='3822'>
      end subroutine icBEP<a name='3823'>
<a name='3824'>
<font color=#447700>! ===6=8===============================================================72<a name='3825'></font>
<font color=#447700>! ===6=8===============================================================72<a name='3826'></font>
<a name='3827'>
<A NAME='VIEW_FACTORS'><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3828'>
      <font color=#993300>subroutine </font><font color=#cc0000>view_factors</font>(iurb,nz_u,id,dxy,z,ws,fww,fwg,fgw,fsg,fsw,fws)  <A href='../../call_to/VIEW_FACTORS.html' TARGET='index'>2</A>,<A href='../../call_from/VIEW_FACTORS.html' TARGET='index'>26</A><a name='3829'>
     <a name='3830'>
      implicit none<a name='3831'>
<a name='3832'>
 <a name='3833'>
<a name='3834'>
<font color=#447700>! -----------------------------------------------------------------------<a name='3835'></font>
<font color=#447700>!     Input<a name='3836'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3837'></font>
<a name='3838'>
      integer iurb            <font color=#447700>! Number of the urban class<a name='3839'></font>
      integer nz_u            <font color=#447700>! Number of levels in the urban grid<a name='3840'></font>
      integer id              <font color=#447700>! Street direction number<a name='3841'></font>
      real ws                 <font color=#447700>! Street width<a name='3842'></font>
      real z(nz_um)         <font color=#447700>! Height of the urban grid levels<a name='3843'></font>
      real dxy                <font color=#447700>! Street lenght<a name='3844'></font>
<a name='3845'>
<a name='3846'>
<font color=#447700>! -----------------------------------------------------------------------<a name='3847'></font>
<font color=#447700>!     Output<a name='3848'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3849'></font>
<a name='3850'>
<font color=#447700>!   fww,fwg,fgw,fsw,fsg are the view factors used to compute the long wave<a name='3851'></font>
<font color=#447700>!   and the short wave radation. They are the part of radiation from a surface<a name='3852'></font>
<font color=#447700>!   or from the sky to another surface.<a name='3853'></font>
<a name='3854'>
      real fww(nz_um,nz_um,ndm,nurbm)            <font color=#447700>!  from wall to wall<a name='3855'></font>
      real fwg(nz_um,ndm,nurbm)                  <font color=#447700>!  from wall to ground<a name='3856'></font>
      real fgw(nz_um,ndm,nurbm)                  <font color=#447700>!  from ground to wall<a name='3857'></font>
      real fsw(nz_um,ndm,nurbm)                  <font color=#447700>!  from sky to wall<a name='3858'></font>
      real fws(nz_um,ndm,nurbm)                  <font color=#447700>!  from wall to sky<a name='3859'></font>
      real fsg(ndm,nurbm)                        <font color=#447700>!  from sky to ground<a name='3860'></font>
<a name='3861'>
<a name='3862'>
<font color=#447700>! -----------------------------------------------------------------------<a name='3863'></font>
<font color=#447700>!     Local<a name='3864'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3865'></font>
<a name='3866'>
      integer jz,iz<a name='3867'>
<a name='3868'>
      real hut<a name='3869'>
      real f1,f2,f12,f23,f123,ftot<a name='3870'>
      real fprl,fnrm<a name='3871'>
      real a1,a2,a3,a4,a12,a23,a123<a name='3872'>
<a name='3873'>
<font color=#447700>! -----------------------------------------------------------------------<a name='3874'></font>
<font color=#447700>!     This routine calculates the view factors<a name='3875'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3876'></font>
        <a name='3877'>
      hut=z(nz_u+1)<a name='3878'>
        <a name='3879'>
      do jz=1,nz_u      <a name='3880'>
      <a name='3881'>
<font color=#447700>! radiation from wall to wall<a name='3882'></font>
       <a name='3883'>
         do iz=1,nz_u<a name='3884'>
     <a name='3885'>
            call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FPRLS'>fprls</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPRLS_6"> (fprl,dxy,abs(z(jz+1)-z(iz  )),ws)<a name='3886'>
            f123=fprl<a name='3887'>
            call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FPRLS'>fprls</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPRLS_7"> (fprl,dxy,abs(z(jz+1)-z(iz+1)),ws)<a name='3888'>
            f23=fprl<a name='3889'>
            call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FPRLS'>fprls</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPRLS_8"> (fprl,dxy,abs(z(jz  )-z(iz  )),ws)<a name='3890'>
            f12=fprl<a name='3891'>
            call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FPRLS'>fprls</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPRLS_9"> (fprl,dxy,abs(z(jz  )-z(iz+1)),ws)<a name='3892'>
            f2 = fprl<a name='3893'>
       <a name='3894'>
            a123=dxy*(abs(z(jz+1)-z(iz  )))<a name='3895'>
            a12 =dxy*(abs(z(jz  )-z(iz  )))<a name='3896'>
            a23 =dxy*(abs(z(jz+1)-z(iz+1)))<a name='3897'>
            a1  =dxy*(abs(z(iz+1)-z(iz  )))<a name='3898'>
            a2  =dxy*(abs(z(jz  )-z(iz+1)))<a name='3899'>
            a3  =dxy*(abs(z(jz+1)-z(jz  )))<a name='3900'>
       <a name='3901'>
            ftot=0.5*(a123*f123-a23*f23-a12*f12+a2*f2)/a1<a name='3902'>
       <a name='3903'>
            fww(iz,jz,id,iurb)=ftot*a1/a3<a name='3904'>
<a name='3905'>
         enddo <a name='3906'>
<a name='3907'>
<font color=#447700>! radiation from ground to wall<a name='3908'></font>
       <a name='3909'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_9"> (fnrm,z(jz+1),dxy,ws)<a name='3910'>
         f12=fnrm<a name='3911'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_10"> (fnrm,z(jz)  ,dxy,ws)<a name='3912'>
         f1=fnrm<a name='3913'>
       <a name='3914'>
         a1 = ws*dxy<a name='3915'>
         <a name='3916'>
         a12= ws*dxy<a name='3917'>
       <a name='3918'>
         a4=(z(jz+1)-z(jz))*dxy<a name='3919'>
       <a name='3920'>
         ftot=(a12*f12-a12*f1)/a1<a name='3921'>
                    <a name='3922'>
         fgw(jz,id,iurb)=ftot*a1/a4<a name='3923'>
     <a name='3924'>
<font color=#447700>!  radiation from sky to wall<a name='3925'></font>
     <a name='3926'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_11">(fnrm,hut-z(jz)  ,dxy,ws)<a name='3927'>
         f12 = fnrm<a name='3928'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_12"> (fnrm,hut-z(jz+1),dxy,ws)<a name='3929'>
         f1 =fnrm<a name='3930'>
       <a name='3931'>
         a1 = ws*dxy<a name='3932'>
       <a name='3933'>
         a12= ws*dxy<a name='3934'>
              <a name='3935'>
         a4 = (z(jz+1)-z(jz))*dxy<a name='3936'>
       <a name='3937'>
         ftot=(a12*f12-a12*f1)/a1<a name='3938'>
        <a name='3939'>
         fsw(jz,id,iurb)=ftot*a1/a4       <a name='3940'>
      <a name='3941'>
      enddo<a name='3942'>
<a name='3943'>
<font color=#447700>! radiation from wall to sky      <a name='3944'></font>
      do iz=1,nz_u<a name='3945'>
       call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_13">(fnrm,ws,dxy,hut-z(iz))<a name='3946'>
       f12=fnrm<a name='3947'>
       call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_14">(fnrm,ws,dxy,hut-z(iz+1))<a name='3948'>
       f1=fnrm<a name='3949'>
       a1 = (z(iz+1)-z(iz))*dxy<a name='3950'>
       a2 = (hut-z(iz+1))*dxy<a name='3951'>
       a12= (hut-z(iz))*dxy<a name='3952'>
       a4 = ws*dxy<a name='3953'>
       ftot=(a12*f12-a2*f1)/a1<a name='3954'>
       fws(iz,id,iurb)=ftot*a1/a4 <a name='3955'>
 <a name='3956'>
      enddo<a name='3957'>
<font color=#447700>!!!!!!!!!!!!!<a name='3958'></font>
<a name='3959'>
<a name='3960'>
       do iz=1,nz_u<a name='3961'>
<a name='3962'>
<font color=#447700>! radiation from wall to ground<a name='3963'></font>
      <a name='3964'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_15"> (fnrm,ws,dxy,z(iz+1))<a name='3965'>
         f12=fnrm<a name='3966'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_16"> (fnrm,ws,dxy,z(iz  ))<a name='3967'>
         f1 =fnrm<a name='3968'>
         <a name='3969'>
         a1= (z(iz+1)-z(iz) )*dxy<a name='3970'>
       <a name='3971'>
         a2 = z(iz)*dxy<a name='3972'>
         a12= z(iz+1)*dxy<a name='3973'>
         a4 = ws*dxy<a name='3974'>
<a name='3975'>
         ftot=(a12*f12-a2*f1)/a1        <a name='3976'>
                    <a name='3977'>
         fwg(iz,id,iurb)=ftot*a1/a4<a name='3978'>
        <a name='3979'>
      enddo<a name='3980'>
<a name='3981'>
<font color=#447700>! radiation from sky to ground<a name='3982'></font>
      <a name='3983'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FPRLS'>fprls</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPRLS_10"> (fprl,dxy,ws,hut)<a name='3984'>
      fsg(id,iurb)=fprl<a name='3985'>
<a name='3986'>
      return<a name='3987'>
      end subroutine view_factors<a name='3988'>
<a name='3989'>
<font color=#447700>! ===6=8===============================================================72<a name='3990'></font>
<font color=#447700>! ===6=8===============================================================72<a name='3991'></font>
<a name='3992'>
<A NAME='FPRLS'><A href='../../html_code/phys/module_sf_bep_bem.F.html#FPRLS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3993'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>fprls</font> (fprl,a,b,c) <A href='../../call_to/FPRLS.html' TARGET='index'>10</A><a name='3994'>
<a name='3995'>
      implicit none<a name='3996'>
<a name='3997'>
     <a name='3998'>
            <a name='3999'>
      real a,b,c<a name='4000'>
      real x,y<a name='4001'>
      real fprl<a name='4002'>
<a name='4003'>
<a name='4004'>
      x=a/c<a name='4005'>
      y=b/c<a name='4006'>
      <a name='4007'>
      if(a.eq.0.or.b.eq.0.)then<a name='4008'>
       fprl=0.<a name='4009'>
      else<a name='4010'>
       fprl=log( ( (1.+x**2)*(1.+y**2)/(1.+x**2+y**2) )**.5)+  &amp;<a name='4011'>
           y*((1.+x**2)**.5)*atan(y/((1.+x**2)**.5))+          &amp;  <a name='4012'>
           x*((1.+y**2)**.5)*atan(x/((1.+y**2)**.5))-          &amp;   <a name='4013'>
           y*atan(y)-x*atan(x)<a name='4014'>
       fprl=fprl*2./(pi*x*y)<a name='4015'>
      endif<a name='4016'>
      <a name='4017'>
      return<a name='4018'>
      end subroutine fprls<a name='4019'>
<a name='4020'>
<font color=#447700>! ===6=8===============================================================72     <a name='4021'></font>
<font color=#447700>! ===6=8===============================================================72<a name='4022'></font>
<a name='4023'>
<A NAME='FNRMS'><A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4024'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>fnrms</font> (fnrm,a,b,c) <A href='../../call_to/FNRMS.html' TARGET='index'>16</A><a name='4025'>
<a name='4026'>
      implicit none<a name='4027'>
<a name='4028'>
<a name='4029'>
<a name='4030'>
      real a,b,c<a name='4031'>
      real x,y,z,a1,a2,a3,a4,a5,a6<a name='4032'>
      real fnrm<a name='4033'>
      <a name='4034'>
      x=a/b<a name='4035'>
      y=c/b<a name='4036'>
      z=x**2+y**2<a name='4037'>
      <a name='4038'>
      if(y.eq.0.or.x.eq.0)then<a name='4039'>
       fnrm=0.<a name='4040'>
      else<a name='4041'>
       a1=log( (1.+x*x)*(1.+y*y)/(1.+z) )<a name='4042'>
       a2=y*y*log(y*y*(1.+z)/z/(1.+y*y) )<a name='4043'>
       a3=x*x*log(x*x*(1.+z)/z/(1.+x*x) )<a name='4044'>
       a4=y*atan(1./y)<a name='4045'>
       a5=x*atan(1./x)<a name='4046'>
       a6=sqrt(z)*atan(1./sqrt(z))<a name='4047'>
       fnrm=0.25*(a1+a2+a3)+a4+a5-a6<a name='4048'>
       fnrm=fnrm/(pi*y)<a name='4049'>
      endif<a name='4050'>
      <a name='4051'>
      return<a name='4052'>
      end subroutine fnrms<a name='4053'>
  <font color=#447700>! ===6=8===============================================================72  <a name='4054'></font>
     <a name='4055'>
<A NAME='INIT_PARA'><A href='../../html_code/phys/module_sf_bep_bem.F.html#INIT_PARA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4056'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_para</font>(alag_u,alaw_u,alar_u,csg_u,csw_u,csr_u,&amp; <A href='../../call_to/INIT_PARA.html' TARGET='index'>2</A>,<A href='../../call_from/INIT_PARA.html' TARGET='index'>1</A><a name='4057'>
        twini_u,trini_u,tgini_u,albg_u,albw_u,albr_u,albwin_u,emg_u,emw_u,&amp;<a name='4058'>
        emr_u,emwind_u,z0g_u,z0r_u,nd_u,strd_u,drst_u,ws_u,bs_u,h_b,d_b,  &amp;<a name='4059'>
        cop_u,pwin_u,beta_u,sw_cond_u,time_on_u,time_off_u,targtemp_u,    &amp;<a name='4060'>
        gaptemp_u, targhum_u,gaphum_u,perflo_u,hsesf_u,hsequip)<a name='4061'>
<a name='4062'>
<font color=#447700>! initialization routine, where the variables from the table are read<a name='4063'></font>
<a name='4064'>
      implicit none<a name='4065'>
      <a name='4066'>
      integer iurb            <font color=#447700>! urban class number<a name='4067'></font>
<font color=#447700>!    Building parameters      <a name='4068'></font>
      real alag_u(nurbm)      <font color=#447700>! Ground thermal diffusivity [m^2 s^-1]<a name='4069'></font>
      real alaw_u(nurbm)      <font color=#447700>! Wall thermal diffusivity [m^2 s^-1]<a name='4070'></font>
      real alar_u(nurbm)      <font color=#447700>! Roof thermal diffusivity [m^2 s^-1]<a name='4071'></font>
      real csg_u(nurbm)       <font color=#447700>! Specific heat of the ground material [J m^3 K^-1]<a name='4072'></font>
      real csw_u(nurbm)       <font color=#447700>! Specific heat of the wall material [J m^3 K^-1]<a name='4073'></font>
      real csr_u(nurbm)       <font color=#447700>! Specific heat of the roof material [J m^3 K^-1]<a name='4074'></font>
      real twini_u(nurbm)     <font color=#447700>! Temperature inside the buildings behind the wall [K]<a name='4075'></font>
      real trini_u(nurbm)     <font color=#447700>! Temperature inside the buildings behind the roof [K]<a name='4076'></font>
      real tgini_u(nurbm)     <font color=#447700>! Initial road temperature<a name='4077'></font>
<a name='4078'>
<font color=#447700>!    Radiation parameters<a name='4079'></font>
      real albg_u(nurbm)      <font color=#447700>! Albedo of the ground<a name='4080'></font>
      real albw_u(nurbm)      <font color=#447700>! Albedo of the wall<a name='4081'></font>
      real albr_u(nurbm)      <font color=#447700>! Albedo of the roof<a name='4082'></font>
      real albwin_u(nurbm)    <font color=#447700>! Albedo of the window<a name='4083'></font>
      real emg_u(nurbm)       <font color=#447700>! Emissivity of ground<a name='4084'></font>
      real emw_u(nurbm)       <font color=#447700>! Emissivity of wall<a name='4085'></font>
      real emr_u(nurbm)       <font color=#447700>! Emissivity of roof<a name='4086'></font>
      real emwind_u(nurbm)    <font color=#447700>! Emissivity of windows<a name='4087'></font>
<a name='4088'>
<font color=#447700>!    Roughness parameters<a name='4089'></font>
      real z0g_u(nurbm)       <font color=#447700>! The ground's roughness length      <a name='4090'></font>
      real z0r_u(nurbm)       <font color=#447700>! The roof's roughness length<a name='4091'></font>
<a name='4092'>
<font color=#447700>!    Street parameters<a name='4093'></font>
      integer nd_u(nurbm)     <font color=#447700>! Number of street direction for each urban class<a name='4094'></font>
<a name='4095'>
      real strd_u(ndm,nurbm)  <font color=#447700>! Street length (fix to greater value to the horizontal length of the cells)<a name='4096'></font>
      real drst_u(ndm,nurbm)  <font color=#447700>! Street direction [degree]<a name='4097'></font>
      real ws_u(ndm,nurbm)    <font color=#447700>! Street width [m]<a name='4098'></font>
      real bs_u(ndm,nurbm)    <font color=#447700>! Building width [m]<a name='4099'></font>
      real h_b(nz_um,nurbm)   <font color=#447700>! Bulding's heights [m]<a name='4100'></font>
      real d_b(nz_um,nurbm)   <font color=#447700>! The probability that a building has an height h_b<a name='4101'></font>
<a name='4102'>
      integer i,iu<a name='4103'>
      integer nurb <font color=#447700>! number of urban classes used<a name='4104'></font>
      real, intent(out) :: cop_u(nurbm)<a name='4105'>
      real, intent(out) :: pwin_u(nurbm)<a name='4106'>
      real, intent(out) :: beta_u(nurbm)<a name='4107'>
      integer, intent(out) :: sw_cond_u(nurbm)<a name='4108'>
      real, intent(out) :: time_on_u(nurbm)<a name='4109'>
      real, intent(out) :: time_off_u(nurbm)<a name='4110'>
      real, intent(out) :: targtemp_u(nurbm)<a name='4111'>
      real, intent(out) :: gaptemp_u(nurbm)<a name='4112'>
      real, intent(out) :: targhum_u(nurbm)<a name='4113'>
      real, intent(out) :: gaphum_u(nurbm)<a name='4114'>
      real, intent(out) :: perflo_u(nurbm)<a name='4115'>
      real, intent(out) :: hsesf_u(nurbm)<a name='4116'>
      real, intent(out) :: hsequip(24)<a name='4117'>
<a name='4118'>
<font color=#447700>!<a name='4119'></font>
<font color=#447700>!Initialize some variables<a name='4120'></font>
<font color=#447700>!  <a name='4121'></font>
     <a name='4122'>
       h_b=0.<a name='4123'>
       d_b=0.<a name='4124'>
<a name='4125'>
       nurb=ICATE<a name='4126'>
       do iu=1,nurb                         <a name='4127'>
          nd_u(iu)=0<a name='4128'>
       enddo<a name='4129'>
<a name='4130'>
       csw_u=CAPB_TBL / (( 1.0 / 4.1868 ) * 1.E-6)<a name='4131'>
       csr_u=CAPR_TBL / (( 1.0 / 4.1868 ) * 1.E-6)<a name='4132'>
       csg_u=CAPG_TBL / (( 1.0 / 4.1868 ) * 1.E-6)<a name='4133'>
       do i=1,icate<a name='4134'>
         alaw_u(i)=AKSB_TBL(i) / csw_u(i) / (( 1.0 / 4.1868 ) * 1.E-2)<a name='4135'>
         alar_u(i)=AKSR_TBL(i) / csr_u(i) / (( 1.0 / 4.1868 ) * 1.E-2)<a name='4136'>
         alag_u(i)=AKSG_TBL(i) / csg_u(i) / (( 1.0 / 4.1868 ) * 1.E-2)<a name='4137'>
       enddo<a name='4138'>
       twini_u=TBLEND_TBL<a name='4139'>
       trini_u=TRLEND_TBL<a name='4140'>
       tgini_u=TGLEND_TBL<a name='4141'>
       albw_u=ALBB_TBL<a name='4142'>
       albr_u=ALBR_TBL<a name='4143'>
       albg_u=ALBG_TBL<a name='4144'>
       emw_u=EPSB_TBL<a name='4145'>
       emr_u=EPSR_TBL<a name='4146'>
       emg_u=EPSG_TBL<a name='4147'>
       z0r_u=Z0R_TBL<a name='4148'>
       z0g_u=Z0G_TBL<a name='4149'>
       nd_u=NUMDIR_TBL<a name='4150'>
<font color=#447700>!FS<a name='4151'></font>
       cop_u = cop_tbl<a name='4152'>
       pwin_u = pwin_tbl<a name='4153'>
       beta_u = beta_tbl<a name='4154'>
       sw_cond_u = sw_cond_tbl<a name='4155'>
       time_on_u = time_on_tbl<a name='4156'>
       time_off_u = time_off_tbl<a name='4157'>
       targtemp_u = targtemp_tbl<a name='4158'>
       gaptemp_u = gaptemp_tbl<a name='4159'>
       targhum_u = targhum_tbl<a name='4160'>
       gaphum_u = gaphum_tbl<a name='4161'>
       perflo_u = perflo_tbl<a name='4162'>
       hsesf_u = hsesf_tbl<a name='4163'>
       hsequip = hsequip_tbl<a name='4164'>
<a name='4165'>
       do iu=1,icate<a name='4166'>
              if(ndm.lt.nd_u(iu))then<a name='4167'>
                write(*,*)'ndm too small in module_sf_bep_bem, please increase to at least ', nd_u(iu)<a name='4168'>
                write(*,*)'remember also that num_urban_layers should be equal or greater than nz_um*ndm*nwr-u<font color=#447700>!'<a name='4169'></font>
                stop<a name='4170'>
              endif<a name='4171'>
         do i=1,nd_u(iu)<a name='4172'>
           drst_u(i,iu)=STREET_DIRECTION_TBL(i,iu) * pi/180.<a name='4173'>
           ws_u(i,iu)=STREET_WIDTH_TBL(i,iu)<a name='4174'>
           bs_u(i,iu)=BUILDING_WIDTH_TBL(i,iu)<a name='4175'>
         enddo<a name='4176'>
       enddo<a name='4177'>
       do iu=1,ICATE<a name='4178'>
          if(nz_um.lt.numhgt_tbl(iu)+3)then<a name='4179'>
              write(*,*)'nz_um too small in module_sf_bep, please increase to at least ',numhgt_tbl(iu)+3<a name='4180'>
              write(*,*)'remember also that num_urban_layers should be equal or greater than nz_um*ndm*nwr-u<font color=#447700>!'<a name='4181'></font>
              stop<a name='4182'>
          endif<a name='4183'>
         do i=1,NUMHGT_TBL(iu)<a name='4184'>
           h_b(i,iu)=HEIGHT_BIN_TBL(i,iu)<a name='4185'>
           d_b(i,iu)=HPERCENT_BIN_TBL(i,iu)<a name='4186'>
         enddo<a name='4187'>
       enddo<a name='4188'>
<a name='4189'>
       do i=1,ndm<a name='4190'>
        do iu=1,nurbm<a name='4191'>
         strd_u(i,iu)=100000.<a name='4192'>
        enddo<a name='4193'>
       enddo<a name='4194'>
<a name='4195'>
       do iu=1,nurb  <a name='4196'>
          emwind_u(iu)=0.9                       <a name='4197'>
          call <A href='../../html_code/phys/module_sf_bep_bem.F.html#ALBWINDOW'>albwindow</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#INIT_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALBWINDOW_1">(albwin_u(iu))  <a name='4198'>
       enddo<a name='4199'>
       <a name='4200'>
       return<a name='4201'>
       end subroutine init_para<a name='4202'>
<font color=#447700>!==============================================================<a name='4203'></font>
<font color=#447700>!==============================================================<a name='4204'></font>
<font color=#447700>!====6=8===============================================================72         <a name='4205'></font>
<font color=#447700>!====6=8===============================================================72 <a name='4206'></font>
<a name='4207'>
<A NAME='UPWARD_RAD'><A href='../../html_code/phys/module_sf_bep_bem.F.html#UPWARD_RAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4208'>
      <font color=#993300>subroutine </font><font color=#cc0000>upward_rad</font>(ndu,nzu,ws,bs,sigma,pb,ss,                &amp; <A href='../../call_to/UPWARD_RAD.html' TARGET='index'>2</A><a name='4209'>
                       tg,emg_u,albg_u,rlg,rsg,sfg,                   &amp; <a name='4210'>
                       tw,emw_u,albw_u,rlw,rsw,sfw,                   &amp; <a name='4211'>
                       tr,emr_u,albr_u,emwind,albwind,twlev,pwin,     &amp;<a name='4212'>
                       sfwind,rld,rs, sfr,                            &amp; <a name='4213'>
                       rs_abs,rl_up,emiss,grdflx_urb)<a name='4214'>
<font color=#447700>!<a name='4215'></font>
<font color=#447700>! IN this surboutine we compute the upward longwave flux, and the albedo<a name='4216'></font>
<font color=#447700>! needed for the radiation scheme<a name='4217'></font>
<font color=#447700>!<a name='4218'></font>
      implicit none<a name='4219'>
<a name='4220'>
<font color=#447700>!<a name='4221'></font>
<font color=#447700>!INPUT VARIABLES<a name='4222'></font>
<font color=#447700>!<a name='4223'></font>
      real rsw(2*ndm,nz_um)        <font color=#447700>! Short wave radiation at the wall for a given canyon direction [W/m2]<a name='4224'></font>
      real rlw(2*ndm,nz_um)         <font color=#447700>! Long wave radiation at the walls for a given canyon direction [W/m2]<a name='4225'></font>
      real rsg(ndm)                   <font color=#447700>! Short wave radiation at the canyon for a given canyon direction [W/m2]<a name='4226'></font>
      real rlg(ndm)                   <font color=#447700>! Long wave radiation at the ground for a given canyon direction [W/m2]<a name='4227'></font>
      real rs                        <font color=#447700>! Short wave radiation at the horizontal surface from the sun [W/m2]  <a name='4228'></font>
      real sfw(2*ndm,nz_um)      <font color=#447700>! Sensible heat flux from walls [W/m2]<a name='4229'></font>
      real sfg(ndm)              <font color=#447700>! Sensible heat flux from ground (road) [W/m2]<a name='4230'></font>
      real sfr(ndm,nz_um)      <font color=#447700>! Sensible heat flux from roofs [W/m2]                      <a name='4231'></font>
      real rld                        <font color=#447700>! Long wave radiation from the sky [W/m2]<a name='4232'></font>
      real albg_u                    <font color=#447700>! albedo of the ground/street<a name='4233'></font>
      real albw_u                    <font color=#447700>! albedo of the walls<a name='4234'></font>
      real albr_u                    <font color=#447700>! albedo of the roof <a name='4235'></font>
      real ws(ndm)                        <font color=#447700>! width of the street<a name='4236'></font>
      real bs(ndm)<a name='4237'>
                        <font color=#447700>! building size<a name='4238'></font>
      real pb(nz_um)                <font color=#447700>! Probability to have a building with an height equal or higher   <a name='4239'></font>
      integer nzu<a name='4240'>
      real ss(nz_um)                <font color=#447700>! Probability to have a building of a given height<a name='4241'></font>
      real sigma                       <a name='4242'>
      real emg_u                       <font color=#447700>! emissivity of the street<a name='4243'></font>
      real emw_u                       <font color=#447700>! emissivity of the wall<a name='4244'></font>
      real emr_u                       <font color=#447700>! emissivity of the roof<a name='4245'></font>
      real tw(2*ndm,nz_um)  <font color=#447700>! Temperature in each layer of the wall [K]<a name='4246'></font>
      real tr(ndm,nz_um,nwr_u)  <font color=#447700>! Temperature in each layer of the roof [K]<a name='4247'></font>
      real tg(ndm,ng_u)          <font color=#447700>! Temperature in each layer of the ground [K]<a name='4248'></font>
      integer id <font color=#447700>! street direction<a name='4249'></font>
      integer ndu <font color=#447700>! number of street directions<a name='4250'></font>
<font color=#447700>!<a name='4251'></font>
<font color=#447700>!New variables BEM<a name='4252'></font>
<font color=#447700>!<a name='4253'></font>
      real emwind               <font color=#447700>!Emissivity of the windows<a name='4254'></font>
      real albwind              <font color=#447700>!Albedo of the windows<a name='4255'></font>
      real twlev(2*ndm,nz_um)   <font color=#447700>!Averaged Temperature of the windows <a name='4256'></font>
      real pwin                 <font color=#447700>!Coverage area fraction of the windows<a name='4257'></font>
      real gflwin               <font color=#447700>!Heat stored for the windows<a name='4258'></font>
      real sfwind(2*ndm,nz_um)  <font color=#447700>!Sensible heat flux from windows [W/m2]<a name='4259'></font>
<a name='4260'>
<font color=#447700>!OUTPUT/INPUT<a name='4261'></font>
      real rs_abs  <font color=#447700>! absrobed solar radiationfor this street direction<a name='4262'></font>
      real rl_up   <font color=#447700>! upward longwave radiation for this street direction<a name='4263'></font>
      real emiss <font color=#447700>! mean emissivity<a name='4264'></font>
      real grdflx_urb <font color=#447700>! ground heat flux <a name='4265'></font>
<font color=#447700>!LOCAL<a name='4266'></font>
      integer iz,iw<a name='4267'>
      real rl_inc,rl_emit<a name='4268'>
      real gfl<a name='4269'>
      integer ix,iy,iwrong<a name='4270'>
<a name='4271'>
         iwrong=1<a name='4272'>
      do iz=1,nzu+1<a name='4273'>
      do id=1,ndu<a name='4274'>
      do iw=1,nwr_u<a name='4275'>
        if(tr(id,iz,iw).lt.100.)then<a name='4276'>
              write(*,*)'in upward_rad ',iz,id,iw,tr(id,iz,iw) <a name='4277'>
              iwrong=0<a name='4278'>
        endif<a name='4279'>
      enddo<a name='4280'>
      enddo<a name='4281'>
      enddo<a name='4282'>
           if(iwrong.eq.0)stop<a name='4283'>
<a name='4284'>
      rl_up=0.<a name='4285'>
 <a name='4286'>
      rs_abs=0.<a name='4287'>
      rl_inc=0.<a name='4288'>
      emiss=0.<a name='4289'>
      rl_emit=0.<a name='4290'>
      grdflx_urb=0.<a name='4291'>
      do id=1,ndu          <a name='4292'>
       rl_emit=rl_emit-( emg_u*sigma*(tg(id,ng_u)**4.)+(1-emg_u)*rlg(id))*ws(id)/(ws(id)+bs(id))/ndu<a name='4293'>
       rl_inc=rl_inc+rlg(id)*ws(id)/(ws(id)+bs(id))/ndu       <a name='4294'>
       rs_abs=rs_abs+(1.-albg_u)*rsg(id)*ws(id)/(ws(id)+bs(id))/ndu<a name='4295'>
         gfl=(1.-albg_u)*rsg(id)+emg_u*rlg(id)-emg_u*sigma*(tg(id,ng_u)**4.)+sfg(id)<a name='4296'>
         grdflx_urb=grdflx_urb-gfl*ws(id)/(ws(id)+bs(id))/ndu  <a name='4297'>
 <a name='4298'>
          do iz=2,nzu<a name='4299'>
            rl_emit=rl_emit-(emr_u*sigma*(tr(id,iz,nwr_u)**4.)+(1-emr_u)*rld)*ss(iz)*bs(id)/(ws(id)+bs(id))/ndu<a name='4300'>
            rl_inc=rl_inc+rld*ss(iz)*bs(id)/(ws(id)+bs(id))/ndu            <a name='4301'>
            rs_abs=rs_abs+(1.-albr_u)*rs*ss(iz)*bs(id)/(ws(id)+bs(id))/ndu<a name='4302'>
            gfl=(1.-albr_u)*rs+emr_u*rld-emr_u*sigma*(tr(id,iz,nwr_u)**4.)+sfr(id,iz)<a name='4303'>
            grdflx_urb=grdflx_urb-gfl*ss(iz)*bs(id)/(ws(id)+bs(id))/ndu<a name='4304'>
         enddo<a name='4305'>
           <a name='4306'>
         do iz=1,nzu <a name='4307'>
           <a name='4308'>
            rl_emit=rl_emit-(emw_u*(1.-pwin)*sigma*(tw(2*id-1,iz)**4.+tw(2*id,iz)**4.)+ &amp;<a name='4309'>
                            (emwind*pwin*sigma*(twlev(2*id-1,iz)**4.+twlev(2*id,iz)**4.))+ &amp;<a name='4310'>
                ((1.-emw_u)*(1.-pwin)+pwin*(1.-emwind))*(rlw(2*id-1,iz)+rlw(2*id,iz)))* &amp;<a name='4311'>
                            dz_u*pb(iz+1)/(ws(id)+bs(id))/ndu<a name='4312'>
<a name='4313'>
            rl_inc=rl_inc+((rlw(2*id-1,iz)+rlw(2*id,iz)))*dz_u*pb(iz+1)/(ws(id)+bs(id))/ndu<a name='4314'>
<a name='4315'>
            rs_abs=rs_abs+(((1.-albw_u)*(1.-pwin)+(1.-albwind)*pwin)*(rsw(2*id-1,iz)+rsw(2*id,iz)))*&amp;<a name='4316'>
                          dz_u*pb(iz+1)/(ws(id)+bs(id))/ndu <a name='4317'>
<a name='4318'>
            gfl=(1.-albw_u)*(rsw(2*id-1,iz)+rsw(2*id,iz)) +emw_u*( rlw(2*id-1,iz)+rlw(2*id,iz) )   &amp;<a name='4319'>
             -emw_u*sigma*( tw(2*id-1,iz)**4.+tw(2*id,iz)**4. )+(sfw(2*id-1,iz)+sfw(2*id,iz))   <a name='4320'>
<a name='4321'>
            gflwin=(1.-albwind)*(rsw(2*id-1,iz)+rsw(2*id,iz)) +emwind*(rlw(2*id-1,iz)+rlw(2*id,iz))   &amp;<a name='4322'>
             -emwind*sigma*( twlev(2*id-1,iz)**4.+twlev(2*id,iz)**4.)+(sfwind(2*id-1,iz)+sfwind(2*id,iz)) <a name='4323'>
               <a name='4324'>
           <a name='4325'>
            grdflx_urb=grdflx_urb-(gfl*(1.-pwin)+pwin*gflwin)*dz_u*pb(iz+1)/(ws(id)+bs(id))/ndu<a name='4326'>
<a name='4327'>
         enddo<a name='4328'>
          <a name='4329'>
      enddo<a name='4330'>
        emiss=(emg_u+emw_u+emr_u)/3.<a name='4331'>
        rl_up=(rl_inc+rl_emit)-rld<a name='4332'>
       <a name='4333'>
         <a name='4334'>
      return<a name='4335'>
<a name='4336'>
      END SUBROUTINE upward_rad<a name='4337'>
<a name='4338'>
<font color=#447700>!====6=8===============================================================72         <a name='4339'></font>
<font color=#447700>!====6=8===============================================================72 <a name='4340'></font>
<font color=#447700>! ===6================================================================72<a name='4341'></font>
<font color=#447700>! ===6================================================================72<a name='4342'></font>
<a name='4343'>
<A NAME='ALBWINDOW'><A href='../../html_code/phys/module_sf_bep_bem.F.html#ALBWINDOW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4344'>
         <font color=#993300>subroutine </font><font color=#cc0000>albwindow</font>(albwin) <A href='../../call_to/ALBWINDOW.html' TARGET='index'>1</A>,<A href='../../call_from/ALBWINDOW.html' TARGET='index'>2</A><a name='4345'>
		<a name='4346'>
<font color=#447700>!-------------------------------------------------------------------<a name='4347'></font>
	 implicit none<a name='4348'>
<a name='4349'>
<a name='4350'>
<font color=#447700>! -------------------------------------------------------------------<a name='4351'></font>
<font color=#447700>!Based on the <a name='4352'></font>
<font color=#447700>!paper of J.Karlsson and A.Roos(2000):"modelling the angular behaviour<a name='4353'></font>
<font color=#447700>!of the total solar energy transmittance of windows"<a name='4354'></font>
<font color=#447700>!Solar Energy Vol.69,No.4,pp. 321-329.      <a name='4355'></font>
<font color=#447700>! -------------------------------------------------------------------<a name='4356'></font>
<font color=#447700>!Input<a name='4357'></font>
<font color=#447700>!-----	<a name='4358'></font>
        <a name='4359'>
<font color=#447700>!Output<a name='4360'></font>
<font color=#447700>!------<a name='4361'></font>
         real albwin	        <font color=#447700>! albedo of the window  <a name='4362'></font>
<font color=#447700>!Local<a name='4363'></font>
<font color=#447700>!-----<a name='4364'></font>
	 real a,b,c		<font color=#447700>!Polynomial coefficients<a name='4365'></font>
	 real alfa,delta,gama	<font color=#447700>!Polynomial powers<a name='4366'></font>
	 real g0	        <font color=#447700>!transmittance when the angle <a name='4367'></font>
                                <font color=#447700>!of incidence is normal to the surface.<a name='4368'></font>
         real asup,ainf<a name='4369'>
	 real fonc<a name='4370'>
<a name='4371'>
<font color=#447700>!Constants<a name='4372'></font>
<font color=#447700>!--------------------<a name='4373'></font>
         <a name='4374'>
         real epsilon              <font color=#447700>!accuracy of the integration<a name='4375'></font>
         parameter (epsilon=1.e-07) <a name='4376'>
         real n1,n2                <font color=#447700>!Index of refraction for glasses and air<a name='4377'></font>
         parameter(n1=1.,n2=1.5)<a name='4378'>
         integer intg,k<a name='4379'>
<font color=#447700>!--------------------------------------------------------------------		<a name='4380'></font>
         if (q_num.eq.0) then<a name='4381'>
           write(*,*) 'Category parameter of the windows no valid'<a name='4382'>
           stop<a name='4383'>
         endif<a name='4384'>
<a name='4385'>
         g0=4.*n1*n2/((n1+n2)*(n1+n2))<a name='4386'>
	 a=8.<a name='4387'>
	 b=0.25/q_num<a name='4388'>
         c=1.-a-b	<a name='4389'>
	 alfa =5.2 + (0.7*q_num)<a name='4390'>
	 delta =2.<a name='4391'>
	 gama =(5.26+0.06*p_num)+(0.73+0.04*p_num)*q_num<a name='4392'>
<a name='4393'>
         intg=1<a name='4394'>
<font color=#447700>!----------------------------------------------------------------------<a name='4395'></font>
<a name='4396'>
<a name='4397'>
100      asup=0.<a name='4398'>
         ainf=0.<a name='4399'>
<a name='4400'>
         do k=1,intg<a name='4401'>
          call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FONCS'>foncs</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#ALBWINDOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FONCS_1">(fonc,(pi*k/intg),a,b,c,alfa,delta,gama)<a name='4402'>
          asup=asup+(pi/intg)*fonc<a name='4403'>
         enddo<a name='4404'>
<a name='4405'>
         intg=intg+1<a name='4406'>
<a name='4407'>
         do k=1,intg<a name='4408'>
          call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FONCS'>foncs</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#ALBWINDOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FONCS_2">(fonc,(pi*k/intg),a,b,c,alfa,delta,gama)<a name='4409'>
          ainf=ainf+(pi/intg)*fonc<a name='4410'>
         enddo<a name='4411'>
	 <a name='4412'>
         if(abs(asup-ainf).lt.epsilon) then<a name='4413'>
           albwin=1-g0+(g0/2.)*asup<a name='4414'>
         else<a name='4415'>
           goto 100<a name='4416'>
         endif<a name='4417'>
        <a name='4418'>
<font color=#447700>!---------------------------------------------------------------------- 	<a name='4419'></font>
	return<a name='4420'>
	end subroutine albwindow<a name='4421'>
<font color=#447700>!====================================================================72<a name='4422'></font>
<font color=#447700>!====================================================================72<a name='4423'></font>
<a name='4424'>
<A NAME='FONCS'><A href='../../html_code/phys/module_sf_bep_bem.F.html#FONCS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4425'>
        <font color=#993300>subroutine </font><font color=#cc0000>foncs</font>(fonc,x,aa,bb,cc,alf,delt,gam) <A href='../../call_to/FONCS.html' TARGET='index'>2</A><a name='4426'>
<a name='4427'>
        implicit none<a name='4428'>
<font color=#447700>!<a name='4429'></font>
        real x,aa,bb,cc<a name='4430'>
        real alf,delt,gam<a name='4431'>
        real fonc<a name='4432'>
  <a name='4433'>
        fonc=(((aa*(x**alf))/(pi**alf))+   &amp;<a name='4434'>
             ((bb*(x**delt))/(pi**delt))+  &amp;<a name='4435'>
             ((cc*(x**gam))/(pi**gam)))*sin(x)<a name='4436'>
        <a name='4437'>
        return<a name='4438'>
	end subroutine foncs<a name='4439'>
<font color=#447700>!====================================================================72<a name='4440'></font>
<font color=#447700>!====================================================================72  <a name='4441'></font>
<a name='4442'>
<A NAME='ICBEP_XY'><A href='../../html_code/phys/module_sf_bep_bem.F.html#ICBEP_XY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4443'>
      <font color=#993300>subroutine </font><font color=#cc0000>icBEP_XY</font>(iurb,fww_u,fwg_u,fgw_u,fsw_u,             &amp; <A href='../../call_to/ICBEP_XY.html' TARGET='index'>2</A>,<A href='../../call_from/ICBEP_XY.html' TARGET='index'>2</A><a name='4444'>
                          fws_u,fsg_u,ndu,strd,ws,nzu,z_u)                               <a name='4445'>
<a name='4446'>
      implicit none       <a name='4447'>
        <a name='4448'>
<font color=#447700>!    Street parameters<a name='4449'></font>
      integer ndu     <font color=#447700>! Number of street direction for each urban class<a name='4450'></font>
      integer iurb<a name='4451'>
<a name='4452'>
      real strd(ndm)        <font color=#447700>! Street length (fix to greater value to the horizontal length of the cells)<a name='4453'></font>
      real ws(ndm)          <font color=#447700>! Street width [m]<a name='4454'></font>
<a name='4455'>
<font color=#447700>!    Grid parameters<a name='4456'></font>
      integer nzu          <font color=#447700>! Number of layer in the urban grid<a name='4457'></font>
      real z_u(nz_um)       <font color=#447700>! Height of the urban grid levels<a name='4458'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='4459'></font>
<font color=#447700>!     Output<a name='4460'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='4461'></font>
<a name='4462'>
<font color=#447700>!   fww_u,fwg_u,fgw_u,fsw_u,fsg_u are the view factors used to compute the long wave<a name='4463'></font>
<font color=#447700>!   and the short wave radation. They are the part of radiation from a surface<a name='4464'></font>
<font color=#447700>!   or from the sky to another surface.<a name='4465'></font>
<a name='4466'>
      real fww_u(nz_um,nz_um,ndm,nurbm)         <font color=#447700>!  from wall to wall<a name='4467'></font>
      real fwg_u(nz_um,ndm,nurbm)               <font color=#447700>!  from wall to ground<a name='4468'></font>
      real fgw_u(nz_um,ndm,nurbm)               <font color=#447700>!  from ground to wall<a name='4469'></font>
      real fsw_u(nz_um,ndm,nurbm)               <font color=#447700>!  from sky to wall<a name='4470'></font>
      real fws_u(nz_um,ndm,nurbm)               <font color=#447700>!  from sky to wall<a name='4471'></font>
      real fsg_u(ndm,nurbm)                     <font color=#447700>!  from sky to ground<a name='4472'></font>
<a name='4473'>
<font color=#447700>! -----------------------------------------------------------------------<a name='4474'></font>
<font color=#447700>!     Local<a name='4475'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='4476'></font>
<a name='4477'>
      integer id<a name='4478'>
<a name='4479'>
<font color=#447700>! -----------------------------------------------------------------------<a name='4480'></font>
<font color=#447700>!     This routine compute the view factors<a name='4481'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='4482'></font>
<font color=#447700>!<a name='4483'></font>
<font color=#447700>!Initialize<a name='4484'></font>
<font color=#447700>!<a name='4485'></font>
      fww_u=0.<a name='4486'>
      fwg_u=0.<a name='4487'>
      fgw_u=0.<a name='4488'>
      fsw_u=0.<a name='4489'>
      fws_u=0.<a name='4490'>
      fsg_u=0.<a name='4491'>
      <a name='4492'>
      do id=1,ndu<a name='4493'>
<a name='4494'>
            call <A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS'>view_factors</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#ICBEP_XY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VIEW_FACTORS_2">(iurb,nzu,id,strd(id),z_u,ws(id),  &amp;    <a name='4495'>
                              fww_u,fwg_u,fgw_u,fsg_u,fsw_u,fws_u) <a name='4496'>
      <a name='4497'>
      enddo               <a name='4498'>
      return       <a name='4499'>
      end subroutine icBEP_XY<a name='4500'>
<font color=#447700>!====================================================================72<a name='4501'></font>
<font color=#447700>!====================================================================72  <a name='4502'></font>
<A NAME='ICBEPHI_XY'><A href='../../html_code/phys/module_sf_bep_bem.F.html#ICBEPHI_XY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4503'>
      <font color=#993300>subroutine </font><font color=#cc0000>icBEPHI_XY</font>(iurb,hb_u,hi_urb1D,ss_u,pb_u,nzu,z_u) <A href='../../call_to/ICBEPHI_XY.html' TARGET='index'>2</A><a name='4504'>
<a name='4505'>
      implicit none   <a name='4506'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4507'></font>
<font color=#447700>!    Inputs<a name='4508'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4509'></font>
<font color=#447700>!    Street parameters<a name='4510'></font>
<font color=#447700>!<a name='4511'></font>
      real hi_urb1D(nz_um)    <font color=#447700>! The probability that a building has an height h_b<a name='4512'></font>
      integer iurb            <font color=#447700>! Number of the urban class<a name='4513'></font>
<font color=#447700>!<a name='4514'></font>
<font color=#447700>!     Grid parameters<a name='4515'></font>
<font color=#447700>!<a name='4516'></font>
      real z_u(nz_um)         <font color=#447700>! Height of the urban grid levels<a name='4517'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='4518'></font>
<font color=#447700>!     Output<a name='4519'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='4520'></font>
<a name='4521'>
      real ss_u(nz_um,nurbm)  <font color=#447700>! The probability that a building has an height equal to z<a name='4522'></font>
      real pb_u(nz_um)        <font color=#447700>! The probability that a building has an height greater or equal to z<a name='4523'></font>
<font color=#447700>!        <a name='4524'></font>
<font color=#447700>!    Grid parameters<a name='4525'></font>
<font color=#447700>!<a name='4526'></font>
      integer nzu                <font color=#447700>! Number of layer in the urban grid<a name='4527'></font>
<a name='4528'>
<font color=#447700>! -----------------------------------------------------------------------<a name='4529'></font>
<font color=#447700>!     Local<a name='4530'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='4531'></font>
      real hb_u(nz_um)        <font color=#447700>! Bulding's heights [m]<a name='4532'></font>
      integer iz_u,id,ilu<a name='4533'>
<a name='4534'>
      real dtot<a name='4535'>
      real hbmax<a name='4536'>
<a name='4537'>
<font color=#447700>!------------------------------------------------------------------------<a name='4538'></font>
<a name='4539'>
<font color=#447700>!Initialize variables<a name='4540'></font>
<font color=#447700>!<a name='4541'></font>
      <a name='4542'>
      nzu=0<a name='4543'>
      ss_u=0.<a name='4544'>
      pb_u=0.<a name='4545'>
      <a name='4546'>
<font color=#447700>! Normalisation of the building density<a name='4547'></font>
<a name='4548'>
         dtot=0.<a name='4549'>
         hb_u=0.<a name='4550'>
<a name='4551'>
         do ilu=1,nz_um<a name='4552'>
            dtot=dtot+hi_urb1D(ilu)<a name='4553'>
         enddo<a name='4554'>
<a name='4555'>
         do ilu=1,nz_um<a name='4556'>
            if (hi_urb1D(ilu)&lt;0.) then<a name='4557'>
<font color=#447700>!              write(*,*) 'WARNING, HI_URB1D(ilu) &lt; 0 IN BEP_BEM'<a name='4558'></font>
               go to 20<a name='4559'>
            endif<a name='4560'>
         enddo<a name='4561'>
<a name='4562'>
         if (dtot.gt.0.) then<a name='4563'>
            continue<a name='4564'>
         else<a name='4565'>
<font color=#447700>!           write(*,*) 'WARNING, HI_URB1D &lt;= 0 IN BEP_BEM'<a name='4566'></font>
            go to 20<a name='4567'>
         endif<a name='4568'>
<a name='4569'>
         do ilu=1,nz_um<a name='4570'>
            hi_urb1D(ilu)=hi_urb1D(ilu)/dtot<a name='4571'>
         enddo<a name='4572'>
         <a name='4573'>
         hb_u(1)=dz_u   <a name='4574'>
         do ilu=2,nz_um<a name='4575'>
            hb_u(ilu)=dz_u+hb_u(ilu-1)<a name='4576'>
         enddo<a name='4577'>
           <a name='4578'>
<a name='4579'>
<font color=#447700>! Compute pb and ss <a name='4580'></font>
      <a name='4581'>
            <a name='4582'>
         hbmax=0.<a name='4583'>
       <a name='4584'>
         do ilu=1,nz_um<a name='4585'>
            if (hi_urb1D(ilu)&gt;0.and.hi_urb1D(ilu)&lt;=1.) then<a name='4586'>
                hbmax=hb_u(ilu)<a name='4587'>
            endif<a name='4588'>
         enddo<a name='4589'>
         <a name='4590'>
         do iz_u=1,nz_um-1<a name='4591'>
            if(z_u(iz_u+1).gt.hbmax)go to 10<a name='4592'>
         enddo<a name='4593'>
<a name='4594'>
10       continue <a name='4595'>
        <a name='4596'>
         nzu=iz_u+1<a name='4597'>
      <a name='4598'>
         if ((nzu+1).gt.nz_um) then <a name='4599'>
             write(*,*) 'error, nz_um has to be increased to at least',nzu+1<a name='4600'>
             stop<a name='4601'>
         endif<a name='4602'>
<a name='4603'>
            do iz_u=1,nzu<a name='4604'>
               ss_u(iz_u,iurb)=0.<a name='4605'>
               do ilu=1,nz_um<a name='4606'>
                  if(z_u(iz_u).le.hb_u(ilu)                      &amp;    <a name='4607'>
                    .and.z_u(iz_u+1).gt.hb_u(ilu))then            <a name='4608'>
                        ss_u(iz_u,iurb)=ss_u(iz_u,iurb)+hi_urb1D(ilu)<a name='4609'>
                  endif <a name='4610'>
               enddo<a name='4611'>
            enddo<a name='4612'>
<a name='4613'>
            pb_u(1)=1.<a name='4614'>
            do iz_u=1,nzu<a name='4615'>
               pb_u(iz_u+1)=max(0.,pb_u(iz_u)-ss_u(iz_u,iurb))<a name='4616'>
            enddo<a name='4617'>
<a name='4618'>
20    continue    <a name='4619'>
      return<a name='4620'>
      end subroutine icBEPHI_XY<a name='4621'>
<font color=#447700>!====================================================================72<a name='4622'></font>
<font color=#447700>!====================================================================72<a name='4623'></font>
END MODULE module_sf_bep_bem<a name='4624'>
</pre></body></html>