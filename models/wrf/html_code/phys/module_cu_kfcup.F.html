<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!--------------------------------------------------------------------<a name='2'></font>
<font color=#447700>! Kain-Fritsch + CuP Cumulus Parameterization<a name='3'></font>
<font color=#447700>!<a name='4'></font>
<font color=#447700>! Module contents:<a name='5'></font>
<font color=#447700>!   kf_cup_cps* - the top-level driver routine<a name='6'></font>
<font color=#447700>!   kf_cup_para* - the guts of the KF scheme<a name='7'></font>
<font color=#447700>!   tpmix2<a name='8'></font>
<font color=#447700>!   dtfrznew<a name='9'></font>
<font color=#447700>!   condload<a name='10'></font>
<font color=#447700>!   prof5<a name='11'></font>
<font color=#447700>!   tpmix2dd<a name='12'></font>
<font color=#447700>!   envirtht<a name='13'></font>
<font color=#447700>!   kf_cup_init*<a name='14'></font>
<font color=#447700>!   kf_lutab<a name='15'></font>
<font color=#447700>!   cupCloudFraction*<a name='16'></font>
<font color=#447700>!   cup_jfd*<a name='17'></font>
<font color=#447700>!   cupSlopeSigma*<a name='18'></font>
<font color=#447700>!   findCp*<a name='19'></font>
<font color=#447700>!   findIndex*<a name='20'></font>
<font color=#447700>!   findRs*<a name='21'></font>
<font color=#447700>!   findRsi*<a name='22'></font>
<font color=#447700>!<a name='23'></font>
<font color=#447700>! * = Subroutine either modified or added for CuP compared to the<a name='24'></font>
<font color=#447700>!     original kfeta scheme.<a name='25'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='26'></font>
<a name='27'>
<font color=#447700>!--------------------------------------------------------------------<a name='28'></font>
<font color=#447700>!TODO's:<a name='29'></font>
<font color=#447700>! - Add variable descriptions with units and other code docs<a name='30'></font>
<font color=#447700>! - Should we vary rBinSize based on t2 to get more sensitivity when cold?<a name='31'></font>
<font color=#447700>! - Figure out appropriate limiting values for the slopes and sigmas<a name='32'></font>
<font color=#447700>!   that ensure the jfd sums to one and gives at least some<a name='33'></font>
<font color=#447700>!   perturbations.<a name='34'></font>
<font color=#447700>! - Figure out how to make minimum frequency settings dependent upon<a name='35'></font>
<font color=#447700>!   the chosen bin sizes.<a name='36'></font>
<font color=#447700>! - Tie cloud radius calc. to dx or the shallow trigger.<a name='37'></font>
<font color=#447700>! - When run with a small dx, deep convection should never be allowed<a name='38'></font>
<font color=#447700>!   to trigger. Right now, it can.<a name='39'></font>
<font color=#447700>! - Figure out how to do cloud fraction feedback.<a name='40'></font>
<font color=#447700>! - Figure out how to handle combination of liquid and ice for cloud<a name='41'></font>
<font color=#447700>!   fraction calculation.<a name='42'></font>
<font color=#447700>! - Clean up cldfratend_cup once we are sure that it will never be<a name='43'></font>
<font color=#447700>!   used again.<a name='44'></font>
<font color=#447700>! - When fluxes are negative, wstar goes negative and then the<a name='45'></font>
<font color=#447700>!   time scales go negative for tstar and taucloud. The neg. cancels<a name='46'></font>
<font color=#447700>!   out for the cloud fraction, but it is troublesome none the less.<a name='47'></font>
<font color=#447700>! - Deep convective clouds don't necessarily develop concurrent<a name='48'></font>
<font color=#447700>!   condensed phase mass. This has impacts for radiation and should<a name='49'></font>
<font color=#447700>!   be investigated.<a name='50'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='51'></font>
<a name='52'>
<A NAME='MODULE_CU_KFCUP'><A href='../../html_code/phys/module_cu_kfcup.F.html#MODULE_CU_KFCUP' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='53'>
<font color=#993300>MODULE </font><font color=#cc0000>module_cu_kfcup</font> <A href='../../call_to/MODULE_CU_KFCUP.html' TARGET='index'>2</A><a name='54'>
<a name='55'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_cu_kfcup.F.html#module_cu_kfcup.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_46"><a name='56'>
<a name='57'>
   IMPLICIT NONE<a name='58'>
<a name='59'>
<font color=#447700>!--------------------------------------------------------------------<a name='60'></font>
<font color=#447700>! Lookup table variables:<a name='61'></font>
      INTEGER, PARAMETER, PRIVATE :: KFNT=250,KFNP=220<a name='62'>
      REAL, DIMENSION(KFNT,KFNP),PRIVATE, SAVE :: TTAB,QSTAB<a name='63'>
      REAL, DIMENSION(KFNP),PRIVATE, SAVE :: THE0K<a name='64'>
      REAL, DIMENSION(200),PRIVATE, SAVE :: ALU<a name='65'>
      REAL, PRIVATE, SAVE :: RDPR,RDTHK,PLUTOP<a name='66'>
<a name='67'>
<font color=#447700>! Note:  KF Lookup table is used by subroutines KF_cup_PARA, TPMIX2,<a name='68'></font>
<font color=#447700>!        TPMIX2DD, ENVIRTHT<a name='69'></font>
<font color=#447700>! End of Lookup table variables:<a name='70'></font>
<a name='71'>
      real, parameter, private :: eps=0.622 <font color=#447700>!used to be epsilon<a name='72'></font>
      <font color=#447700>!real, parameter, private :: reallysmall=1e-30 !for div by 0 checks<a name='73'></font>
      real, parameter, private :: reallysmall=5e-4 <font color=#447700>!for div by 0 checks<a name='74'></font>
<a name='75'>
<font color=#447700>! if ==1, apply barahona and nenes (2007) entrainment adjustment to activation <a name='76'></font>
<font color=#447700>! at cloud base ; if =/1, do not apply this<a name='77'></font>
      integer, parameter, private :: qndrop_cldbase_entrain_opt = 1<a name='78'>
<font color=#447700>! if ==1, updraft qndrop above cloud base is reduced by entrainment (dilution) ; <a name='79'></font>
<font color=#447700>! if /=1, no dilution<a name='80'></font>
      integer, parameter, private :: qndrop_incloud_entrain_opt = 1<a name='81'>
<font color=#447700>! minimum vertical velocity (m/s) passed to activate routine<a name='82'></font>
      real, parameter, private :: w_act_min = 0.2<a name='83'>
<a name='84'>
<font color=#447700>! for testing -- multiply aerosol number/volume by this before activation calculation<a name='85'></font>
<font color=#447700>!     real, parameter, private :: naero_adjust_factor = 1.0<a name='86'></font>
<font color=#447700>! for testing -- if ==1, set aerosol size to dcen_sect for activation calcs<a name='87'></font>
<font color=#447700>!                if /=1, do not adjust aerosol size<a name='88'></font>
<font color=#447700>!     integer, parameter, private :: vaero_dsect_adjust_opt = 0<a name='89'></font>
<a name='90'>
<a name='91'>
CONTAINS<a name='92'>
<a name='93'>
<A NAME='KF_CUP_CPS'><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_CPS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='94'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>KF_cup_CPS</font>( grid_id,                           &amp; <font color=#447700>! rce 10-may-2012 <A href='../../call_to/KF_CUP_CPS.html' TARGET='index'>1</A>,<A href='../../call_from/KF_CUP_CPS.html' TARGET='index'>13</A><a name='95'></font>
              ids,ide, jds,jde, kds,kde                      &amp;<a name='96'>
             ,ims,ime, jms,jme, kms,kme                      &amp;<a name='97'>
             ,its,ite, jts,jte, kts,kte                      &amp;<a name='98'>
             ,DT,KTAU,DX                                     &amp;<a name='99'>
             ,rho,RAINCV,NCA                                 &amp;<a name='100'>
             ,U,V,TH,T,W,dz8w,Pcps,pi                        &amp;<a name='101'>
             ,W0AVG,XLV0,XLV1,XLS0,XLS1,CP,R,G,EP1           &amp;<a name='102'>
             ,EP2,SVP1,SVP2,SVP3,SVPT0                       &amp;<a name='103'>
             ,STEPCU,CU_ACT_FLAG,warm_rain,CUTOP,CUBOT       &amp;<a name='104'>
             ,QV                                             &amp;<a name='105'>
             ,xland                                          &amp; <font color=#447700>!LD 18-Oct-2011 <a name='106'></font>
             ,psfc,z,z_at_w,ht,tsk,hfx,qfx,mavail            &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='107'></font>
             ,sf_sfclay_physics                              &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='108'></font>
             ,br,regime,pblh,kpbl,t2,q2                      &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='109'></font>
             ,slopeSfc,slopeEZ,sigmasfc,sigmaEZ              &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='110'></font>
             ,cupflag,cldfra_cup,cldfratend_cup              &amp; <font color=#447700>!CuP, wig, 18-Sep-2006<a name='111'></font>
             ,shall,taucloud,tactive                         &amp; <font color=#447700>!CuP, wig, 18-Sep-2006<a name='112'></font>
             ,activeFrac                                     &amp; <font color=#447700>!CuP, lkb 5-May-2010<a name='113'></font>
             ,tstar, lnterms                                 &amp; <font color=#447700>!CuP, wig 4-Oct-2006<a name='114'></font>
             ,lnint                                          &amp; <font color=#447700>!CuP, wig 4-Oct-2006<a name='115'></font>
             ,numBins, thBinSize, rBinSize                   &amp; <font color=#447700>!CuP, lkb 4-Nov-2009<a name='116'></font>
             ,minDeepFreq, minShallowFreq                    &amp; <font color=#447700>!CuP, lkb 4-Nov-2009<a name='117'></font>
             ,wCloudBase                                     &amp; <font color=#447700>!CuP, lkb 4-April-2010<a name='118'></font>
             ,wact_cup                                       &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='119'></font>
             ,wulcl_cup                                      &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='120'></font>
             ,wup_cup                                        &amp; <font color=#447700>!CuP, rce 15-mar-2013<a name='121'></font>
             ,qc_ic_cup                                      &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='122'></font>
             ,qndrop_ic_cup                                  &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='123'></font>
             ,qc_iu_cup                                      &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='124'></font>
             ,fcvt_qc_to_pr_cup                              &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='125'></font>
             ,fcvt_qc_to_qi_cup                              &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='126'></font>
             ,fcvt_qi_to_pr_cup                              &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='127'></font>
             ,mfup_cup                                       &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='128'></font>
             ,mfup_ent_cup                                   &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='129'></font>
             ,mfdn_cup                                       &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='130'></font>
             ,mfdn_ent_cup                                   &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='131'></font>
             ,updfra_cup                                     &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='132'></font>
             ,tcloud_cup                                     &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='133'></font>
             ,shcu_aerosols_opt                              &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='134'></font>
            <font color=#447700>! optionals<a name='135'></font>
             ,chem_opt                                       &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='136'></font>
             ,chem                                           &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='137'></font>
             ,F_QV    ,F_QC    ,F_QR    ,F_QI    ,F_QS       &amp;<a name='138'>
             ,RTHCUTEN,RQVCUTEN,RQCCUTEN,RQRCUTEN            &amp;<a name='139'>
             ,RQICUTEN,RQSCUTEN                              &amp;<a name='140'>
                                                             )<a name='141'>
<font color=#447700>!<a name='142'></font>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_112">, only:  num_chem<a name='143'>
#if ( WRF_CHEM == 1 )<a name='144'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_113">, only:  cbmz_mosaic_4bin, cbmz_mosaic_4bin_aq, &amp;<a name='145'>
                                        cbmz_mosaic_8bin, cbmz_mosaic_8bin_aq, &amp;<a name='146'>
                                        saprc99_mosaic_8bin_vbs2_aq_kpp,       &amp;<a name='147'>
                                        saprc99_mosaic_8bin_vbs2_kpp<a name='148'>
   USE module_data_mosaic_asect, only:  maxd_acomp, maxd_aphase, maxd_atype, maxd_asize, &amp;<a name='149'>
                                        ntype_aer, nsize_aer, ncomp_aer, &amp;<a name='150'>
                                        ai_phase, msectional, massptr_aer, numptr_aer, &amp;<a name='151'>
                                        dlo_sect, dhi_sect, dens_aer, hygro_aer, sigmag_aer<a name='152'>
#endif<a name='153'>
<a name='154'>
<font color=#447700>!-------------------------------------------------------------<a name='155'></font>
   IMPLICIT NONE<a name='156'>
<font color=#447700>!-------------------------------------------------------------<a name='157'></font>
   INTEGER,      INTENT(IN   ) :: grid_id,                   &amp; <font color=#447700>!rce 10-may-2012<a name='158'></font>
                                  ids,ide, jds,jde, kds,kde, &amp;<a name='159'>
                                  ims,ime, jms,jme, kms,kme, &amp;<a name='160'>
                                  its,ite, jts,jte, kts,kte<a name='161'>
<a name='162'>
   INTEGER,      INTENT(IN   ) :: STEPCU<a name='163'>
   LOGICAL,      INTENT(IN   ) :: warm_rain<a name='164'>
<a name='165'>
   REAL,         INTENT(IN   ) :: XLV0,XLV1,XLS0,XLS1<a name='166'>
   REAL,         INTENT(IN   ) :: CP,R,G,EP1,EP2<a name='167'>
   REAL,         INTENT(IN   ) :: SVP1,SVP2,SVP3,SVPT0<a name='168'>
<a name='169'>
   INTEGER,      INTENT(IN   ) :: KTAU, &amp;<a name='170'>
                                          sf_sfclay_physics, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='171'></font>
                                          shcu_aerosols_opt    <font color=#447700>!CuP, rce, 10-may-2012<a name='172'></font>
<a name='173'>
   INTEGER,  DIMENSION( ims:ime , jms:jme )                , &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='174'></font>
          INTENT(IN   ) ::                                   &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='175'></font>
                                                       kpbl    <font color=#447700>!Note that this is different from kpbl in the main KF scheme below. CuP, wig, 24-Aug-2006<a name='176'></font>
<a name='177'>
   REAL,  DIMENSION( ims:ime , jms:jme )                   , &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='178'></font>
          INTENT(IN   ) ::                                   &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='179'></font>
                                                       psfc, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='180'></font>
                                                         ht, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='181'></font>
                                                        tsk, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='182'></font>
                                                        hfx, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='183'></font>
                                                        qfx, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='184'></font>
                                                     mavail, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='185'></font>
                                                         br, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='186'></font>
                                                     regime, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='187'></font>
                                                       pblh, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='188'></font>
                                                         t2, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='189'></font>
                                                         q2, &amp;    <font color=#447700>!CuP, wig, 24-Aug-2006<a name='190'></font>
                                                      xland       <font color=#447700>!LD 18-Oct-2011<a name='191'></font>
<a name='192'>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         , &amp;<a name='193'>
          INTENT(IN   ) ::                                   &amp;<a name='194'>
                                                          U, &amp;<a name='195'>
                                                          V, &amp;<a name='196'>
                                                          W, &amp;<a name='197'>
                                                         TH, &amp;<a name='198'>
                                                          T, &amp;<a name='199'>
                                                         QV, &amp;<a name='200'>
                                                       dz8w, &amp;<a name='201'>
                                                       Pcps, &amp;<a name='202'>
                                                        rho, &amp;<a name='203'>
                                                         pi, &amp;<a name='204'>
                                                          z, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='205'></font>
                                                     z_at_w    <font color=#447700>!CuP, wig 5-Oct-2006<a name='206'></font>
<font color=#447700>!<a name='207'></font>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         , &amp;<a name='208'>
          INTENT(INOUT) ::                                   &amp;<a name='209'>
                                                      W0AVG, &amp;<a name='210'>
                                                 cldfra_cup, &amp; <font color=#447700>!CuP, wig, 18-Sep-2006<a name='211'></font>
                                             cldfratend_cup    <font color=#447700>!CuP, wig, 18-Sep-2006<a name='212'></font>
<a name='213'>
   REAL,  INTENT(IN   ) :: DT, DX<a name='214'>
<font color=#447700>!<a name='215'></font>
   REAL, DIMENSION( ims:ime , jms:jme ),                     &amp;<a name='216'>
          INTENT(INOUT) ::                           RAINCV  <a name='217'>
<a name='218'>
   REAL,    DIMENSION( ims:ime , jms:jme ),                  &amp;<a name='219'>
            INTENT(INOUT) ::                            NCA, &amp;<a name='220'>
                                                      shall    <font color=#447700>!CuP, wig, 18-Sep-2006 This has to be "real" because "integer" would only output zeros to the history file.<a name='221'></font>
<a name='222'>
   REAL, DIMENSION( ims:ime , jms:jme ),                     &amp;<a name='223'>
          INTENT(OUT) ::                              CUBOT, &amp;<a name='224'>
                                                      CUTOP, &amp;<a name='225'>
                                                   slopeSfc, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='226'></font>
                                                    slopeEZ, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='227'></font>
                                                   sigmaSfc, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='228'></font>
                                                    sigmaEZ, &amp; <font color=#447700>!CuP, wig, 24-Aug-2006<a name='229'></font>
                                                   taucloud, &amp; <font color=#447700>!CuP, wig, 1-Oct-2006<a name='230'></font>
                                                    tactive, &amp; <font color=#447700>!CuP, wig, 1-Oct-2006<a name='231'></font>
                                                      tstar, &amp; <font color=#447700>!CuP, wig, 4-Oct-2006<a name='232'></font>
                                                      lnint, &amp; <font color=#447700>!CuP, wig, 4-Oct-2006<a name='233'></font>
                                                 activeFrac, &amp; <font color=#447700>!CuP, lkb, 5-May-2010<a name='234'></font>
                                                 wCloudBase    <font color=#447700>!CuP, lkb, 10-April-2010<a name='235'></font>
<a name='236'>
   REAL, DIMENSION( ims:ime , jms:jme ),                     &amp;<a name='237'>
        INTENT(INOUT) ::                           wact_cup, &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='238'></font>
                                                  wulcl_cup, &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='239'></font>
                                                 tcloud_cup    <font color=#447700>!CuP, rce 10-may-2012<a name='240'></font>
<a name='241'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),            &amp;<a name='242'>
         INTENT(INOUT) ::                                    &amp;<a name='243'>
                                                    wup_cup, &amp; <font color=#447700>!CuP, rce 15-mar-2013<a name='244'></font>
                                                  qc_ic_cup, &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='245'></font>
                                              qndrop_ic_cup, &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='246'></font>
                                                  qc_iu_cup, &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='247'></font>
                                          fcvt_qc_to_pr_cup, &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='248'></font>
                                          fcvt_qc_to_qi_cup, &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='249'></font>
                                          fcvt_qi_to_pr_cup, &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='250'></font>
                                                   mfup_cup, &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='251'></font>
                                               mfup_ent_cup, &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='252'></font>
                                                   mfdn_cup, &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='253'></font>
                                               mfdn_ent_cup, &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='254'></font>
                                                 updfra_cup    <font color=#447700>!CuP, rce 10-may-2012<a name='255'></font>
<a name='256'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),            &amp;<a name='257'>
         INTENT(OUT) ::                                      &amp;<a name='258'>
                                                    lnterms    <font color=#447700>!CuP, wig 4-Oct-2006<a name='259'></font>
<a name='260'>
   LOGICAL, DIMENSION( ims:ime , jms:jme ),                  &amp;<a name='261'>
          INTENT(INOUT) ::                      CU_ACT_FLAG, &amp;<a name='262'>
                                                    cupflag    <font color=#447700>!CuP, wig 9-Oct-2006<a name='263'></font>
   INTEGER, INTENT(IN) :: numBins<a name='264'>
   REAL, INTENT(IN) :: thBinSize, rBinSize<a name='265'>
   REAL, INTENT(IN) :: minDeepFreq, minShallowFreq<a name='266'>
<font color=#447700>!<a name='267'></font>
<font color=#447700>! Optional arguments<a name='268'></font>
<font color=#447700>!<a name='269'></font>
   INTEGER, OPTIONAL, INTENT(IN   ) ::             chem_opt    <font color=#447700>!CuP, rce 10-may-2012<a name='270'></font>
<a name='271'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme, 1:num_chem ),&amp;<a name='272'>
         OPTIONAL, INTENT(IN) ::                             &amp;<a name='273'>
                                                       chem    <font color=#447700>!CuP, rce 10-may-2012<a name='274'></font>
<a name='275'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),           &amp;<a name='276'>
         OPTIONAL,                                           &amp;<a name='277'>
         INTENT(INOUT) ::                                    &amp;<a name='278'>
                                                   RTHCUTEN, &amp;<a name='279'>
                                                   RQVCUTEN, &amp;<a name='280'>
                                                   RQCCUTEN, &amp;<a name='281'>
<a name='282'>
                                                   RQRCUTEN, &amp;<a name='283'>
                                                   RQICUTEN, &amp;<a name='284'>
                                                   RQSCUTEN<a name='285'>
<a name='286'>
<font color=#447700>!<a name='287'></font>
<font color=#447700>! Flags relating to the optional tendency arrays declared above<a name='288'></font>
<font color=#447700>! Models that carry the optional tendencies will provdide the<a name='289'></font>
<font color=#447700>! optional arguments at compile time; these flags all the model<a name='290'></font>
<font color=#447700>! to determine at run-time whether a particular tracer is in<a name='291'></font>
<font color=#447700>! use or not.<a name='292'></font>
<font color=#447700>!<a name='293'></font>
   LOGICAL, OPTIONAL ::                                      &amp;<a name='294'>
                                                   F_QV      &amp;<a name='295'>
                                                  ,F_QC      &amp;<a name='296'>
                                                  ,F_QR      &amp;<a name='297'>
                                                  ,F_QI      &amp;<a name='298'>
                                                  ,F_QS<a name='299'>
<a name='300'>
<a name='301'>
<font color=#447700>! LOCAL VARS<a name='302'></font>
<a name='303'>
   LOGICAL :: flag_qr, flag_qi, flag_qs<a name='304'>
   LOGICAL :: flag_chem   <font color=#447700>! rce 10-may-2012<a name='305'></font>
<a name='306'>
   REAL, DIMENSION( kts:kte ) ::                             &amp;<a name='307'>
                                                        U1D, &amp;<a name='308'>
                                                        V1D, &amp;<a name='309'>
                                                        T1D, &amp;<a name='310'>
                                                       th1d, &amp; <font color=#447700>!wig, CuP, 24-Aug-2006<a name='311'></font>
                                                        z1d, &amp; <font color=#447700>!wig, CuP, 15-Sep-2006<a name='312'></font>
                                                   z_at_w1d, &amp; <font color=#447700>!wig, CuP 5-Oct-2006<a name='313'></font>
                                                       DZ1D, &amp;<a name='314'>
                                                       QV1D, &amp;<a name='315'>
                                                        P1D, &amp;<a name='316'>
                                                      RHO1D, &amp;<a name='317'>
                                                    W0AVG1D, &amp;<a name='318'>
                                               cldfra_cup1d, &amp; <font color=#447700>!wig, CuP, 20-Sep-2006<a name='319'></font>
                                           cldfratend_cup1d, &amp; <font color=#447700>!wig, CuP, 20-Sep-2006<a name='320'></font>
                                                   qndrop1d, &amp; <font color=#447700>!rce, CuP, 11-may-2012<a name='321'></font>
                                                       qc1d, &amp; <font color=#447700>!rce, CuP, 11-may-2012<a name='322'></font>
                                                       qi1d, &amp; <font color=#447700>!rce, CuP, 11-may-2012<a name='323'></font>
                                              fcvt_qc_to_pr, &amp; <font color=#447700>!rce, CuP, 11-may-2012<a name='324'></font>
                                              fcvt_qc_to_qi, &amp; <font color=#447700>!rce, CuP, 11-may-2012<a name='325'></font>
                                              fcvt_qi_to_pr    <font color=#447700>!rce, CuP, 11-may-2012<a name='326'></font>
<a name='327'>
   REAL, DIMENSION( kts:kte )::                              &amp;<a name='328'>
                                                       DQDT, &amp;<a name='329'>
                                                      DQIDT, &amp;<a name='330'>
                                                      DQCDT, &amp;<a name='331'>
                                                      DQRDT, &amp;<a name='332'>
                                                      DQSDT, &amp;<a name='333'>
                                                       DTDT<a name='334'>
<a name='335'>
   REAL, DIMENSION( kts:kte, 1:num_chem ) ::                 &amp;<a name='336'>
                                                     chem1d    <font color=#447700>!rce, CuP, 11-may-2012<a name='337'></font>
<a name='338'>
   REAL    ::         TST,tv,PRS,RHOE,W0,SCR1,DXSQ,tmp,RTHCUMAX<a name='339'>
<a name='340'>
<a name='341'>
   INTEGER :: i,j,k,NTST,ICLDCK<a name='342'>
<a name='343'>
<font color=#447700>! Local vars specific to CuP... wig, 24-Aug-2006<a name='344'></font>
<font color=#447700>!~sensitivity test for 41   integer, parameter :: numBins = 21   !Number of perturbations for each variable (theta &amp; qvapor)<a name='345'></font>
<font color=#447700>!!   integer, parameter :: numBins =  41 !41!Number of perturbations for each variable (theta &amp; qvapor)<a name='346'></font>
<font color=#447700>!!                                        !  Should be an odd value.<a name='347'></font>
<font color=#447700>!!   real, parameter :: thBinSize  = 0.1   !0.1  !Size of potential temp. perturbation increment (K)<a name='348'></font>
<font color=#447700>!!   real, parameter :: rBinSize   = 1.0e-4 !1e-4 !Size of mxing ratio perturbation increment (kg/kg)<a name='349'></font>
<font color=#447700>!   real, parameter :: minFreq    = 1e-5 !Minimum frequency required for a perturbation to be used ~should be dependent upon bin sizes<a name='350'></font>
<font color=#447700>!!   real, parameter :: minDeepFreq= 50e-2 !Cumulative freq. threshold before deep convection is allowed ~this was 5e-2 before<a name='351'></font>
<a name='352'>
   integer :: ipert, ishall, jpert, kcubot, kcutop<a name='353'>
   <font color=#447700>!!real :: activeFrac, biggestDeepFreq, cumDeepFreq, cumShallFreq,  &amp;<a name='354'></font>
   real :: biggestDeepFreq, cumDeepFreq, cumShallFreq,  &amp;<a name='355'>
           cubot_deep, cutop_deep, nca_deep, raincv_deep,           &amp;<a name='356'>
           cubot_shall, cutop_shall, nca_shall, raincv_shall,       &amp;<a name='357'>
           minFreq, wstar, wLCL<a name='358'>
   real, dimension(numBins) :: r_perturb, th_perturb<a name='359'>
   real, dimension(numBins, numBins) :: jfd<a name='360'>
   real, dimension(kts:kte) :: dqdt_deep, dqidt_deep, dqcdt_deep,    &amp;<a name='361'>
                               dqrdt_deep, dqsdt_deep, dtdt_deep,    &amp;<a name='362'>
                               dqdt_shall, dqidt_shall, dqcdt_shall, &amp;<a name='363'>
                               dqrdt_shall, dqsdt_shall, dtdt_shall, &amp;<a name='364'>
                               qlg, qlg_shall, qig, qig_shall<a name='365'>
   character(len=200) :: message<a name='366'>
<a name='367'>
<font color=#447700>! rce 11-may-2012 mods start -------------------------------------------<a name='368'></font>
   integer :: idiagee, idiagff<a name='369'>
   integer :: ipert_deepsv, jpert_deepsv<a name='370'>
   integer :: kcubotmin, kcubotmax, kcutopmin, kcutopmax<a name='371'>
   integer :: kupdrbot_deep, kupdrbot_shall<a name='372'>
   integer :: l<a name='373'>
<a name='374'>
   logical :: ltmpa<a name='375'>
<a name='376'>
   real :: tmpa, tmpb, tmpc, tmpd, tmpe, tmpf, tmpg, tmph, tmpi, tmpj<a name='377'>
   real :: tmpr, tmps, tmpx, tmpy, tmpz<a name='378'>
   real :: tmpcf<a name='379'>
   real :: tmp_nca, tmp_updfra<a name='380'>
   real :: tmpveca(1:999)<a name='381'>
   real :: updfra, updfra_deep, updfra_shall<a name='382'>
   real :: wact, wact_deep, wact_shall<a name='383'>
   real :: wcb_v2, wcb_v2_shall, wcb_v2_deep<a name='384'>
   real :: wulcl, wulcl_deep, wulcl_shall<a name='385'>
   real :: wcloudbase_shall, wcloudbase_deep<a name='386'>
<a name='387'>
   real, dimension(kts:kte) ::                   &amp;<a name='388'>
           qlg_deep, qig_deep,                   &amp;<a name='389'>
           qndrop_ic_deep, qndrop_ic_shall,      &amp;<a name='390'>
           qc_ic_deep, qc_ic_shall,              &amp;<a name='391'>
           qi_ic_deep, qi_ic_shall,              &amp;<a name='392'>
           fcvt_qc_to_pr_deep, fcvt_qc_to_pr_shall, &amp;<a name='393'>
           fcvt_qc_to_qi_deep, fcvt_qc_to_qi_shall, &amp;<a name='394'>
           fcvt_qi_to_pr_deep, fcvt_qi_to_pr_shall, &amp;<a name='395'>
           cumshallfreq1d,                       &amp;<a name='396'>
           umfout, uerout, udrout,               &amp;<a name='397'>
           umf_deep, uer_deep, udr_deep,         &amp;<a name='398'>
           umf_shall, uer_shall, udr_shall,      &amp;<a name='399'>
           dmfout, derout, ddrout,               &amp;<a name='400'>
           dmf_deep, der_deep, ddr_deep,         &amp;  <font color=#447700>! only deep has downdraft<a name='401'></font>
           wup, wup_deep, wup_shall<a name='402'>
<font color=#447700>! rce 11-may-2012 mods end ---------------------------------------------<a name='403'></font>
   <a name='404'>
<font color=#447700>!<a name='405'></font>
   DXSQ=DX*DX<a name='406'>
<font color=#447700>!----------------------<a name='407'></font>
   NTST=STEPCU<a name='408'>
   TST=float(NTST*2)<a name='409'>
   flag_qr = .FALSE.<a name='410'>
   flag_qi = .FALSE.<a name='411'>
   flag_qs = .FALSE.<a name='412'>
   IF ( PRESENT(F_QR) ) flag_qr = F_QR<a name='413'>
   IF ( PRESENT(F_QI) ) flag_qi = F_QI<a name='414'>
   IF ( PRESENT(F_QS) ) flag_qs = F_QS<a name='415'>
<a name='416'>
<font color=#447700>! flag_chem is .TRUE. only when chem is present, shcu_aerosols_opt &gt;= 2, and chem_opt is appropriate<a name='417'></font>
   flag_chem = .FALSE.<a name='418'>
#if ( WRF_CHEM == 1 )<a name='419'>
   if ( PRESENT( chem ) .and. shcu_aerosols_opt &gt;= 2) then<a name='420'>
      if ( chem_opt == cbmz_mosaic_4bin    .or. &amp;<a name='421'>
           chem_opt == cbmz_mosaic_4bin_aq .or. &amp;<a name='422'>
           chem_opt == cbmz_mosaic_8bin    .or. &amp;<a name='423'>
           chem_opt == cbmz_mosaic_8bin_aq .or. &amp;<a name='424'>
           chem_opt == saprc99_mosaic_8bin_vbs2_aq_kpp .or. &amp; <a name='425'>
           chem_opt == saprc99_mosaic_8bin_vbs2_kpp ) then <font color=#447700>!BSINGH (04/08/2014): Added for non-aq vbs <a name='426'></font>
<a name='427'>
         flag_chem = .TRUE.<a name='428'>
      else<a name='429'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_606">( 'kf_cup_cps - bad chem_opt for shcu_aerosols_opt &gt;= 2' )<a name='430'>
      end if<a name='431'>
   end if<a name='432'>
#endif<a name='433'>
<a name='434'>
   idiagff = 0 ; idiagee = 0  <font color=#447700>! rce 11-may-2012 start<a name='435'></font>
   if ((ide-ids &lt;= 3) .and. (jde-jds &lt;= 3)) then<a name='436'>
      idiagff = 1  <font color=#447700>! turn on diagnostics at i=j=1 for single column runs<a name='437'></font>
<font color=#447700>!     idiagff = 0  ! (do this to turn off extra diagnostics)<a name='438'></font>
   end if  <font color=#447700>! rce 11-may-2012 end<a name='439'></font>
<a name='440'>
<font color=#447700>!<a name='441'></font>
  DO J = jts,jte<a name='442'>
      DO K=kts,kte<a name='443'>
         DO I= its,ite<a name='444'>
<font color=#447700>!            SCR1=-5.0E-4*G*rho(I,K,J)*(w(I,K,J)+w(I,K+1,J))<a name='445'></font>
<font color=#447700>!            TV=T(I,K,J)*(1.+EP1*QV(I,K,J))<a name='446'></font>
<font color=#447700>!            RHOE=Pcps(I,K,J)/(R*TV)<a name='447'></font>
<font color=#447700>!            W0=-101.9368*SCR1/RHOE<a name='448'></font>
            W0=0.5*(w(I,K,J)+w(I,K+1,J))  <font color=#447700>!~this can probably be passed in instead of recalced<a name='449'></font>
            W0AVG(I,K,J)=(W0AVG(I,K,J)*(TST-1.)+W0)/TST<a name='450'>
<font color=#447700>!            CLDFRA_CUP(I,K,j) = 0.0   ! Start with 0 cloud fraction, added by LK Berg 10/29/09 01/11/2012<a name='451'></font>
         ENDDO<a name='452'>
      ENDDO<a name='453'>
   ENDDO<a name='454'>
<font color=#447700>!<a name='455'></font>
<font color=#447700>!...CHECK FOR CONVECTIVE INITIATION EVERY 5 MINUTES (OR NTST/2)...<a name='456'></font>
<font color=#447700>!<a name='457'></font>
<font color=#447700>!----------------------<a name='458'></font>
   ICLDCK=MOD(KTAU,NTST)<a name='459'>
<a name='460'>
<font color=#447700>! rce 11-may-2012 mods start -------------------------------------------<a name='461'></font>
   if (idiagff &gt; 0) then<a name='462'>
      if (ktau &lt;= 1) then<a name='463'>
      write(*,'(a,i5,1p,4e11.3)') 'kfcup_control numbins, ...binsize, min...freq', numbins, thbinsize, rbinsize, mindeepfreq, minshallowfreq<a name='464'>
      write(*,'(a,3i5)') 'kfcup_control -- qndrop_cldbase_entrain_opt, ...incloud', &amp;<a name='465'>
         qndrop_cldbase_entrain_opt, qndrop_incloud_entrain_opt<a name='466'>
      write(*,'(a,1p,2e11.35)') 'kfcup_control -- w_act_min', w_act_min<a name='467'>
      write(*,'(a,2i5/(a,3(i9,i5)))') 'kfcup_control -- grid_id, ktau', grid_id, ktau, &amp;<a name='468'>
         'kfcup_control -- d indices', ids,ide, jds,jde, kds,kde, &amp;<a name='469'>
         'kfcup_control -- m indices', ims,ime, jms,jme, kms,kme, &amp;<a name='470'>
         'kfcup_control -- e indices', its,ite, jts,jte, kts,kte<a name='471'>
      end if<a name='472'>
<a name='473'>
      write(*,'(a)') 'kfcup', 'kfcup', 'kfcup--------------------------------------------------------------------------------'<a name='474'>
      write(*,'(a,l5)') 'kfcup -- flag_chem', flag_chem<a name='475'>
      write(*,'(a,3i5,l5,3i5,f10.1,1p,2e10.2)') 'kfcup a00 ktau,ntst,icldck; cupflag,ishall,bot/top; nca,cldfra', &amp;<a name='476'>
         ktau, ntst, icldck, cupflag(its,jts), nint(shall(its,jts)), nint(cubot(its,jts)), nint(cutop(its,jts)), nca(its,jts), &amp;<a name='477'>
         maxval(cldfra_cup(its,kts:kte-2,jts)), maxval(rqvcuten(its,kts:kte-2,jts))<a name='478'>
      write(*,'(a,i5,1p,4e11.3)') 'kfcup numbins, ...binsize, min...freq', numbins, thbinsize, rbinsize, mindeepfreq, minshallowfreq<a name='479'>
   end if <font color=#447700>! (idiagff &gt; 0)<a name='480'></font>
<font color=#447700>! rce 11-may-2012 mods end ---------------------------------------------<a name='481'></font>
<a name='482'>
   if ((ide-ids &lt;= 3) .and. (jde-jds &lt;= 3)) then  <font color=#447700>! rce 11-may-2012<a name='483'></font>
      <font color=#447700>! for single column, skip ktau=1<a name='484'></font>
      ltmpa = (ICLDCK .EQ. 0) .and. (KTAU .gt. 1)<a name='485'>
   else<a name='486'>
      ltmpa = (ICLDCK .EQ. 0) .or. (KTAU .eq. 1)<a name='487'>
   end if<a name='488'>
<a name='489'>
main_test_on_ktau_ntst: &amp;  <font color=#447700>! rce 11-may-2012<a name='490'></font>
   IF ( ltmpa ) then<a name='491'>
<font color=#447700>!  IF(ICLDCK.EQ.0 .or. KTAU .eq. 1) then<a name='492'></font>
<a name='493'>
<font color=#447700>!<a name='494'></font>
<font color=#447700>!write(message,*)'~trying convection...'<a name='495'></font>
<font color=#447700>!call wrf_message(message)<a name='496'></font>
     DO J = jts,jte<a name='497'>
     DO I= its,ite<a name='498'>
        CU_ACT_FLAG(i,j) = .true.<a name='499'>
     ENDDO<a name='500'>
     ENDDO<a name='501'>
<a name='502'>
main_loop_on_j: &amp;  <font color=#447700>! rce 11-may-2012<a name='503'></font>
     DO J = jts,jte<a name='504'>
main_loop_on_i: &amp;  <font color=#447700>! rce 11-may-2012<a name='505'></font>
       DO I=its,ite<a name='506'>
<a name='507'>
         idiagee = 0  <font color=#447700>! rce 11-may-2012<a name='508'></font>
         if (idiagff &gt; 0) then<a name='509'>
            <font color=#447700>! turn on diagnostics at i=j=1 for single column runs<a name='510'></font>
            if (i==its .and. j==jts) idiagee = 1<a name='511'>
         end if<a name='512'>
<a name='513'>
         ishall = int(shall(i,j)) <font color=#447700>!CuP, wig 19-Sep-2006<a name='514'></font>
<font color=#447700>!write(message,*)'~i,j,nca,shall=',i,j,nca(i,j),ishall<a name='515'></font>
<font color=#447700>!call wrf_message(message)<a name='516'></font>
<a name='517'>
main_test_on_nca: &amp;  <font color=#447700>! rce 11-may-2012<a name='518'></font>
         IF ( NCA(I,J) .ge. 0.5*DT ) then    <font color=#447700>!byang 26 aug 2011<a name='519'></font>
<font color=#447700>! A previous call to KF triggered a cloud, and now we have to wait for<a name='520'></font>
<font color=#447700>! the appropriate time scale before triggering another cloud.<a name='521'></font>
            CU_ACT_FLAG(i,j) = .false.<a name='522'>
<a name='523'>
         ELSE<a name='524'>
<font color=#447700>!call wrf_message("~doing convection...")<a name='525'></font>
            DO k=kts,kte<a name='526'>
               DQDT(k)=0.<a name='527'>
               DQIDT(k)=0.<a name='528'>
               DQCDT(k)=0.<a name='529'>
               DQRDT(k)=0.<a name='530'>
               DQSDT(k)=0.<a name='531'>
               DTDT(k)=0.<a name='532'>
            ENDDO<a name='533'>
            RAINCV(I,J)=0.<a name='534'>
            CUTOP(I,J)=KTS<a name='535'>
            CUBOT(I,J)=KTE+1<a name='536'>
<a name='537'>
            qc_ic_cup(i,:,j) = 0.0  <font color=#447700>! rce 11-may-2012 start<a name='538'></font>
            qndrop_ic_cup(i,:,j) = 0.0<a name='539'>
            qc_iu_cup(i,:,j) = 0.0<a name='540'>
            fcvt_qc_to_pr_cup(i,:,j) = 0.0<a name='541'>
            fcvt_qc_to_qi_cup(i,:,j) = 0.0<a name='542'>
            fcvt_qi_to_pr_cup(i,:,j) = 0.0<a name='543'>
            wup_cup(i,:,j) = 0.0<a name='544'>
            wact_cup(i,j) = 0.0<a name='545'>
            wulcl_cup(i,j) = 0.0<a name='546'>
            tcloud_cup(i,j) = 0.0<a name='547'>
            updfra_cup(i,:,j) = 0.0<a name='548'>
            mfup_cup(i,:,j) = 0.0<a name='549'>
            mfup_ent_cup(i,:,j) = 0.0<a name='550'>
            mfdn_cup(i,:,j) = 0.0<a name='551'>
            mfdn_ent_cup(i,:,j) = 0.0  <font color=#447700>! rce 11-may-2012 end<a name='552'></font>
<font color=#447700>!<a name='553'></font>
<font color=#447700>! assign vars from 3D to 1D<a name='554'></font>
            DO K=kts,kte<a name='555'>
               U1D(K) =U(I,K,J)<a name='556'>
               V1D(K) =V(I,K,J)<a name='557'>
               T1D(K) =T(I,K,J)<a name='558'>
               th1d(k) = th(i,k,j)  <font color=#447700>!wig, CuP 24-Aug-2006<a name='559'></font>
               RHO1D(K) =rho(I,K,J)<a name='560'>
               QV1D(K)=QV(I,K,J)<a name='561'>
               P1D(K) =Pcps(I,K,J)<a name='562'>
               W0AVG1D(K) =W0AVG(I,K,J)<a name='563'>
               z1d(k) = z(i,k,j)    <font color=#447700>!wig, CuP 15-Sep-2006<a name='564'></font>
               z_at_w1d(k) = z_at_w(i,k,j)    <font color=#447700>!wig, CuP 15-Sep-2006<a name='565'></font>
               DZ1D(k)=dz8w(I,K,J)<a name='566'>
               cldfra_cup1d(k) = cldfra_cup(i,k,j) <font color=#447700>!wig, CuP 20-Sep-2006<a name='567'></font>
            ENDDO<a name='568'>
<a name='569'>
            if ( flag_chem ) then  <font color=#447700>! rce 11-may-2012 start<a name='570'></font>
               do l = 1, num_chem<a name='571'>
               do k = kts, kte<a name='572'>
                  chem1d(k,l) = chem(i,k,j,l)<a name='573'>
               end do<a name='574'>
               end do<a name='575'>
            end if<a name='576'>
            qndrop1d = 0.0<a name='577'>
            qc1d = 0.0<a name='578'>
            qi1d = 0.0<a name='579'>
            fcvt_qc_to_pr = 0.0<a name='580'>
            fcvt_qc_to_qi = 0.0<a name='581'>
            fcvt_qi_to_pr = 0.0<a name='582'>
            wup = 0.0<a name='583'>
            wact = 0.0<a name='584'>
            updfra = 0.0<a name='585'>
            ipert_deepsv = -999<a name='586'>
            jpert_deepsv = -999  <font color=#447700>! rce 11-may-2012 end<a name='587'></font>
<font color=#447700>! <a name='588'></font>
<font color=#447700>! CuP, wig: begin, Aug-2006<a name='589'></font>
<font color=#447700>! Get the slopes and std. dev. for CuP<a name='590'></font>
<a name='591'>
<font color=#447700>!!$!~beg<a name='592'></font>
<font color=#447700>!!$print*,dx, psfc(i,j), p1d, rho1d<a name='593'></font>
<font color=#447700>!!$print*,                 dz1d, z1d, ht(i,j)                  <a name='594'></font>
<font color=#447700>!!$print*,                 t1d, th1d, tsk(i,j), u1d, v1d<a name='595'></font>
<font color=#447700>!!$print*,                 qv1d, hfx(i,j), qfx(i,j), mavail(i,j)       <a name='596'></font>
<font color=#447700>!!$print*,                 sf_sfclay_physics, br(i,j), regime(i,j), pblh(i,j)<a name='597'></font>
<font color=#447700>!!$print*,                 kpbl(i,j), t2(i,j), q2(i,j)                <a name='598'></font>
<font color=#447700>!!$print*,                 slopeSfc(i,j), slopeEZ(i,j)                 <a name='599'></font>
<font color=#447700>!!$print*,                 sigmaSfc(i,j), sigmaEZ(i,j)             <a name='600'></font>
<font color=#447700>!!$print*,                 wstar, cupflag(i,j)                        <a name='601'></font>
<font color=#447700>!!$print*,                 kms, kme, kts, kte <a name='602'></font>
<font color=#447700>!!$<a name='603'></font>
<font color=#447700>!!$print*,'~entering cupSlopeSigma',i,j<a name='604'></font>
<font color=#447700>!!$!~end<a name='605'></font>
            call <A href='../../html_code/phys/module_cu_kfcup.F.html#CUPSLOPESIGMA'>cupSlopeSigma</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUPSLOPESIGMA_1">(dx, psfc(i,j), p1d, rho1d,           &amp;<a name='606'>
                 dz1d, z1d, ht(i,j),                                &amp;<a name='607'>
                 t1d, th1d, tsk(i,j), u1d, v1d,                     &amp;<a name='608'>
                 qv1d, hfx(i,j),xland(i,j), qfx(i,j), mavail(i,j),  &amp;  <font color=#447700>! add xland LD 19-Oct-2011<a name='609'></font>
                 sf_sfclay_physics, br(i,j), regime(i,j), pblh(i,j),&amp;<a name='610'>
                 kpbl(i,j), t2(i,j), q2(i,j),                       &amp;<a name='611'>
                 slopeSfc(i,j), slopeEZ(i,j),                       &amp;<a name='612'>
                 sigmaSfc(i,j), sigmaEZ(i,j),                       &amp;<a name='613'>
                 wstar, cupflag(i,j), shall(i,j),                   &amp;<a name='614'>
                 kms, kme, kts, kte                                 )<a name='615'>
<a name='616'>
            if (idiagee&gt;0) then  <font color=#447700>! rce 11-may-2012<a name='617'></font>
               write(*,'(a,l5,i5)')         'kfcup cupslopesigma cupflag, ishall', cupflag(i,j), nint(shall(i,j))<a name='618'>
               write(*,'(a,i10,1p,5e10.2)') 'kfcup kpbl, pblh, ht, z1d, dz', kpbl(i,j), pblh(i,j), ht(i,j), z1d(1), dz1d(1)<a name='619'>
               write(*,'(a,    1p,5e10.2)') 'kfcup hfx, qfx, regime // w0', hfx(i,j), qfx(i,j), regime(i,j)<a name='620'>
               write(*,'(     1p,10e10.2)') w0avg1d(kts:kts+19)<a name='621'>
            end if<a name='622'>
<a name='623'>
<font color=#447700>! If the CuP scheme is activated, use the CuP perturbations.<a name='624'></font>
<font color=#447700>! Otherwise, default to the standard KF algorithm.<a name='625'></font>
main_test_on_cupflag: &amp;  <font color=#447700>! rce 11-may-2012<a name='626'></font>
            if( cupflag(i,j) ) then<a name='627'>
<font color=#447700>!<a name='628'></font>
<font color=#447700>! Get the joint frequency distribution and the associated perturbations<a name='629'></font>
<font color=#447700>!<a name='630'></font>
<font color=#447700>!~The pert. calcs can be pulled out of the i/j do loops for speed, but<a name='631'></font>
<font color=#447700>!~are left in right now in case we want to vary the pert. values based<a name='632'></font>
<font color=#447700>!~on environmental conditions.<a name='633'></font>
               call <A href='../../html_code/phys/module_cu_kfcup.F.html#CUP_JFD'>cup_jfd</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_JFD_1">(slopeSfc(i,j), slopeEZ(i,j),            &amp;<a name='634'>
                    sigmaSfc(i,j), sigmaEZ(i,j),                    &amp;<a name='635'>
                    numBins, thBinSize, rBinSize,                   &amp;<a name='636'>
                    th_perturb, r_perturb, jfd                      )<a name='637'>
<font color=#447700>!<a name='638'></font>
<font color=#447700>! Determine the minimum frequency of occurance that we will allow to<a name='639'></font>
<font color=#447700>! contribute to the results. This serves two purposes. It prevents large<a name='640'></font>
<font color=#447700>! excursions from the mean that might creep in from mal-conditioned<a name='641'></font>
<font color=#447700>! PBL structures. And, it also speeds up overall calculation time by<a name='642'></font>
<font color=#447700>! limiting which bins to send to the KF scheme for lifting.<a name='643'></font>
<font color=#447700>!<a name='644'></font>
               minFreq = minShallowFreq*jfd(int(numBins/2)+1, int(numBins/2)+1)<a name='645'>
               <font color=#447700>!!minFreq = 1e-2*jfd(int(numBins/2)+1, int(numBins/2)+1)<a name='646'></font>
               if (idiagee&gt;0) write(*,'(a,2i5,1p,2e11.3)') 'kfcup minfreq stuff', &amp;<a name='647'>
                  int(numBins/2)+1, int(numBins/2)+1, minshallowfreq, minfreq  <font color=#447700>! rce 11-may-2012<a name='648'></font>
<font color=#447700>!<a name='649'></font>
<font color=#447700>! Setup some vars and then loop through all the perturbation<a name='650'></font>
<font color=#447700>! possibilities...<a name='651'></font>
<font color=#447700>!<a name='652'></font>
               biggestDeepFreq = -999.<a name='653'>
               cumDeepFreq     = 0.<a name='654'>
               cumShallFreq    = 0.<a name='655'>
               dqdt_shall      = 0.<a name='656'>
               dqidt_shall     = 0.<a name='657'>
               dqcdt_shall     = 0.<a name='658'>
               dqrdt_shall     = 0.<a name='659'>
               dqsdt_shall     = 0.<a name='660'>
               dtdt_shall      = 0.<a name='661'>
               raincv_shall    = 0.<a name='662'>
               cubot_shall     = 0.<a name='663'>
               cutop_shall     = 0.<a name='664'>
               qlg_shall       = 0.<a name='665'>
               qig_shall       = 0.<a name='666'>
               wCloudBase(i,j) = 0.<a name='667'>
<a name='668'>
<font color=#447700>! rce 11-may-2012 mods start -------------------------------------------<a name='669'></font>
               cumShallFreq1d  = 0.<a name='670'>
               qndrop_ic_shall = 0.<a name='671'>
               qc_ic_shall     = 0.<a name='672'>
               qi_ic_shall     = 0.<a name='673'>
               fcvt_qc_to_pr_shall = 0.<a name='674'>
               fcvt_qc_to_qi_shall = 0.<a name='675'>
               fcvt_qi_to_pr_shall = 0.<a name='676'>
               wact_shall      = 0.<a name='677'>
               wulcl_shall     = 0.<a name='678'>
               wCloudBase_shall= 0.<a name='679'>
               updfra_shall    = 0.<a name='680'>
               umf_shall       = 0.<a name='681'>
               uer_shall       = 0.<a name='682'>
               udr_shall       = 0.<a name='683'>
               wcb_v2          = 0.<a name='684'>
               wcb_v2_shall    = 0.<a name='685'>
               kcubotmin       = 99<a name='686'>
               kcubotmax       =  0<a name='687'>
               kcutopmin       = 99<a name='688'>
               kcutopmax       =  0<a name='689'>
               wup_deep        = 0.<a name='690'>
               wup_shall       = 0.<a name='691'>
<font color=#447700>! rce 11-may-2012 mods end ---------------------------------------------<a name='692'></font>
<a name='693'>
<a name='694'>
PERTLOOPS:     do jpert = 1,numBins<a name='695'>
               do ipert = 1,numBins<a name='696'>
<font color=#447700>!<a name='697'></font>
<font color=#447700>! Only consider the perturbations that exceed a threshold value. Also,<a name='698'></font>
<font color=#447700>! skip this perturbation if we already know deep convection will be<a name='699'></font>
<font color=#447700>! output and the current probability is lower than a previous deep<a name='700'></font>
<font color=#447700>! convective possibility.<a name='701'></font>
<font color=#447700>!<a name='702'></font>
                  if( (jfd(ipert,jpert) &lt; minFreq) .or. &amp;<a name='703'>
                       <font color=#447700>!!(jfd(ipert,jpert) &gt; 0.001) .or.     &amp; ! lkb, 18-Aug-2008<a name='704'></font>
                       <font color=#447700>!!(th_perturb(ipert) &lt;= 0) .or.     &amp; ! lkb, 18-Aug-2008 : Commented out for tests run on 11/3/09 looking at lower freq. of DC<a name='705'></font>
                       <font color=#447700>!!(r_perturb(ipert) &lt;= 0) .or.     &amp; ! lkb, 18-Aug-2008 : COmmented out for tests run on 11/3/09 <a name='706'></font>
                       (cumDeepFreq &gt; minDeepFreq .and. &amp; <font color=#447700>! lkb, 18-Aug_2008<a name='707'></font>
                       jfd(ipert,jpert) &lt; biggestDeepFreq) ) cycle<a name='708'>
                  <a name='709'>
<a name='710'>
 <a name='711'>
<font color=#447700>!                   write(*,*) raincv ,'in if before KF_cup_PARA'   !LD, 20-April-2011<a name='712'></font>
                  if (idiagee&gt;0) then  <font color=#447700>! rce 11-may-2012<a name='713'></font>
                     write(*,'(a,2i5,1p,2e11.3)') 'kfcup calling kf_cup_para'<a name='714'>
                     write(98,'(///a,i5,2i5,5x,a,2i5,1pe11.3)') 'kfcup calling kf_cup_para, ktau, i, j', ktau, i, j, &amp;<a name='715'>
                        'ijpert, jdf', ipert, jpert, jfd(ipert,jpert)<a name='716'>
                  end if<a name='717'>
 <a name='718'>
                  CALL <A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA'>KF_cup_PARA</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="KF_CUP_PARA_1">( GRID_ID, KTAU,          &amp; <font color=#447700>! rce 11-may-2012<a name='719'></font>
                       I, J,                                &amp;<a name='720'>
                       U1D,V1D,T1D,QV1D,P1D,DZ1D,           &amp;<a name='721'>
                       W0AVG1D,DT,DX,DXSQ,RHO1D,            &amp;<a name='722'>
                       XLV0,XLV1,XLS0,XLS1,CP,R,G,          &amp;<a name='723'>
                       EP2,SVP1,SVP2,SVP3,SVPT0,            &amp;<a name='724'>
                       pblh(i,j),z_at_w1d,cupflag(i,j),     &amp; <font color=#447700>!wig, 21-Feb-2008<a name='725'></font>
                       th_perturb(ipert),r_perturb(jpert),  &amp; <font color=#447700>!wig, 25-Aug-2006<a name='726'></font>
                       jfd(ipert,jpert),                    &amp; <font color=#447700>!lkb, 15-Aug-2008<a name='727'></font>
                       ishall,qlg,qig,                      &amp; <font color=#447700>!wig, 20-Sep-2006<a name='728'></font>
                       DQDT,DQIDT,DQCDT,DQRDT,DQSDT,DTDT,   &amp;<a name='729'>
                       RAINCV,NCA,NTST,                     &amp;  <font color=#447700>!LD add PRATEC 21-April-2011<a name='730'></font>
                       flag_QI,flag_QS,warm_rain,           &amp;<a name='731'>
                       CUTOP,CUBOT, wLCL,                   &amp;<a name='732'>
                       ids,ide, jds,jde, kds,kde,           &amp;<a name='733'>
                       ims,ime, jms,jme, kms,kme,           &amp;<a name='734'>
                       its,ite, jts,jte, kts,kte,           &amp;<a name='735'>
                       idiagee, updfra, wulcl, wup,         &amp;<a name='736'>
                       umfout, uerout, udrout,              &amp; <font color=#447700>! rce 11-may-2012<a name='737'></font>
                       dmfout, derout, ddrout,              &amp; <font color=#447700>!         "<a name='738'></font>
                       shcu_aerosols_opt,                   &amp; <font color=#447700>!         "<a name='739'></font>
                       flag_chem, num_chem,                 &amp; <font color=#447700>!         "<a name='740'></font>
                       wact, qndrop1d, qc1d, qi1d,          &amp; <font color=#447700>!         "<a name='741'></font>
                       fcvt_qc_to_qi, fcvt_qc_to_pr,        &amp; <font color=#447700>!         "<a name='742'></font>
                       fcvt_qi_to_pr, chem1d,               &amp; <font color=#447700>!         "<a name='743'></font>
#if ( WRF_CHEM == 1 )<a name='744'>
                       maxd_acomp, maxd_aphase,             &amp; <font color=#447700>!         "<a name='745'></font>
                       maxd_atype, maxd_asize,              &amp; <font color=#447700>!         "<a name='746'></font>
                       ntype_aer, nsize_aer, ncomp_aer,     &amp; <font color=#447700>!         "<a name='747'></font>
                       ai_phase, msectional,                &amp; <font color=#447700>!         "<a name='748'></font>
                       massptr_aer, numptr_aer,             &amp; <font color=#447700>!         "<a name='749'></font>
                       dlo_sect, dhi_sect,                  &amp; <font color=#447700>!         "<a name='750'></font>
                       dens_aer, hygro_aer, sigmag_aer      ) <font color=#447700>!         "<a name='751'></font>
#else<a name='752'>
                       1, 1,                                &amp; <font color=#447700>!         "<a name='753'></font>
                       1, 1                                 ) <font color=#447700>! rce 11-may-2012<a name='754'></font>
#endif<a name='755'>
<a name='756'>
                  if (idiagee&gt;0) then  <font color=#447700>! rce 11-may-2012<a name='757'></font>
                     if (ishall==0 .or. ishall==1) then<a name='758'>
                        write(*,'(a,3i5,1p,e11.3,a)') 'kfcup 1 ishall, cubot/top, nca', &amp;<a name='759'>
                           ishall, nint(cubot(i,j)), nint(cutop(i,j)), nca(i,j), '  triggered'<a name='760'>
                     else<a name='761'>
                        write(*,'(a,3i5,1p,e11.3,a)') 'kfcup 1 ishall, cubot/top, nca', &amp;<a name='762'>
                           ishall, nint(cubot(i,j)), nint(cutop(i,j)), nca(i,j)<a name='763'>
                     end if<a name='764'>
                  end if<a name='765'>
<a name='766'>
<font color=#447700>! if( raincv(i,j).ne. 0 ) then         &amp;!LD, 20-April-2011<a name='767'></font>
<font color=#447700>!                      write(*,*) raincv,'after cup_PARA' !LD, 20-April-2011<a name='768'></font>
<font color=#447700>!                  end if                               &amp;!LD, 20-April-2011 <a name='769'></font>
<a name='770'>
<font color=#447700>! Move these tendency applications to after the averaging for all the<a name='771'></font>
<font color=#447700>! different CuP perturbations.<a name='772'></font>
<font color=#447700>!!$            IF(PRESENT(rthcuten).AND.PRESENT(rqvcuten)) THEN<a name='773'></font>
<font color=#447700>!!$              DO K=kts,kte<a name='774'></font>
<font color=#447700>!!$                 RTHCUTEN(I,K,J)=DTDT(K)/pi(I,K,J)<a name='775'></font>
<font color=#447700>!!$!              RTHCUMAX=max(abs(RTHCUTEN(I,K,J)),RTHCUMAX)<a name='776'></font>
<font color=#447700>!!$                 RQVCUTEN(I,K,J)=DQDT(K)<a name='777'></font>
<font color=#447700>!!$              ENDDO<a name='778'></font>
<font color=#447700>!!$            ENDIF<a name='779'></font>
<font color=#447700>!<a name='780'></font>
<font color=#447700>! If deep convection triggered, accumulate the deep convective<a name='781'></font>
<font color=#447700>! probability. This will also be the case if no convection occurred<a name='782'></font>
<font color=#447700>! and then the results would be small. Save the results if this deep<a name='783'></font>
<font color=#447700>! possibility is more probable than previous possibilities...<a name='784'></font>
<font color=#447700>!<a name='785'></font>
                  if( ishall == 0 ) then<a name='786'>
                     cumDeepFreq = cumDeepFreq + jfd(ipert,jpert)<a name='787'>
                     if( jfd(ipert,jpert) &gt; biggestDeepFreq ) then<a name='788'>
                        biggestDeepFreq = jfd(ipert,jpert)<a name='789'>
                        do k = kts, kte      <font color=#447700>! Added by lkb<a name='790'></font>
                           dqdt_deep(k)       = dqdt(k)<a name='791'>
                           dqidt_deep(k)      = dqidt(k)<a name='792'>
                           dqcdt_deep(k)      = dqcdt(k)<a name='793'>
                           dqrdt_deep(k)      = dqrdt(k)<a name='794'>
                           dqsdt_deep(k)      = dqsdt(k)<a name='795'>
                           dtdt_deep(k)       = dtdt(k)<a name='796'>
                        enddo<a name='797'>
                        nca_deep        = nca(i,j)<a name='798'>
                        raincv_deep     = raincv(i,j)<a name='799'>
                        cubot_deep      = cubot(i,j)<a name='800'>
                        cutop_deep      = cutop(i,j)<a name='801'>
<a name='802'>
                        ipert_deepsv = ipert  <font color=#447700>! rce 11-may-2012 start<a name='803'></font>
                        jpert_deepsv = jpert<a name='804'>
                        qlg_deep        = qlg<a name='805'>
                        qig_deep        = qig<a name='806'>
                        qndrop_ic_deep  = qndrop1d<a name='807'>
                        qc_ic_deep      = qc1d<a name='808'>
                        qi_ic_deep      = qi1d<a name='809'>
                        fcvt_qc_to_pr_deep = fcvt_qc_to_pr<a name='810'>
                        fcvt_qc_to_qi_deep = fcvt_qc_to_qi<a name='811'>
                        fcvt_qi_to_pr_deep = fcvt_qi_to_pr<a name='812'>
                        updfra_deep     = updfra<a name='813'>
                        wup_deep        = wup<a name='814'>
                        wact_deep       = wact<a name='815'>
                        wulcl_deep      = wulcl<a name='816'>
                        wcb_v2_deep     = max( wlcl, wulcl )<a name='817'>
                        wcloudbase_deep = wlcl<a name='818'>
<a name='819'>
                        kcubot = nint(cubot_deep)<a name='820'>
                        kupdrbot_deep = kcubot<a name='821'>
                        do k = kcubot-1, kts, -1<a name='822'>
                           if ((umfout(k) &gt; 0.0) .or. (uerout(k) &gt; 0.0)) kupdrbot_deep = k<a name='823'>
                        end do<a name='824'>
                        do k = kts, kte<a name='825'>
                           umf_deep(k) = max( 0.0, umfout(k) )<a name='826'>
                           uer_deep(k) = max( 0.0, uerout(k) )<a name='827'>
                           udr_deep(k) = max( 0.0, udrout(k) )<a name='828'>
                           dmf_deep(k) = min( 0.0, dmfout(k) )<a name='829'>
                           der_deep(k) = max( 0.0, derout(k) )<a name='830'>
                           ddr_deep(k) = max( 0.0, ddrout(k) )<a name='831'>
                        enddo  <font color=#447700>! rce 11-may-2012 end<a name='832'></font>
                     end if<a name='833'>
<font color=#447700>!<a name='834'></font>
<font color=#447700>! Or if shallow convection ocurred and we need to accumulate<a name='835'></font>
<font color=#447700>! frequency weighted running sums of the results...<a name='836'></font>
<font color=#447700>!<a name='837'></font>
                  else if( ishall == 1 ) then<a name='838'>
                     cumShallFreq = cumShallFreq + jfd(ipert,jpert)     <font color=#447700>! lkb-9/02/08 changed to just use JFD<a name='839'></font>
                     <font color=#447700>!!dqdt_shall   = dqdt_shall + dqdt*jfd(ipert,jpert)<a name='840'></font>
                     <a name='841'>
                    do k = kts, kte            <font color=#447700>! Added by lkb<a name='842'></font>
                        <font color=#447700>!!!dqdt_shall   = dqdt_shall + dqdt*jfd(ipert,jpert)<a name='843'></font>
                        dqdt_shall(k)   = dqdt_shall(k) + dqdt(k)<a name='844'>
                        <font color=#447700>!!!dqidt_shall  = dqidt_shall + dqidt*jfd(ipert,jpert)<a name='845'></font>
                        dqidt_shall(k)  = dqidt_shall(k) + dqidt(k)<a name='846'>
                        <font color=#447700>!!!dqcdt_shall  = dqcdt_shall + dqcdt*jfd(ipert,jpert)<a name='847'></font>
                        dqcdt_shall(k)  = dqcdt_shall(k) + dqcdt(k)<a name='848'>
                        <font color=#447700>!!!dqrdt_shall  = dqrdt_shall + dqrdt*jfd(ipert,jpert)<a name='849'></font>
                        dqrdt_shall(k)  = dqrdt_shall(k) + dqrdt(k)<a name='850'>
                        <font color=#447700>!!!dqsdt_shall  = dqsdt_shall + dqsdt*jfd(ipert,jpert)<a name='851'></font>
                        dqsdt_shall(k)  = dqsdt_shall(k) + dqsdt(k)<a name='852'>
                        <font color=#447700>!!!dtdt_shall(k)   = dtdt_shall(k) + dtdt(k)*jfd(ipert,jpert)<a name='853'></font>
                        dtdt_shall(k)   = dtdt_shall(k) + dtdt(k)<a name='854'>
<font color=#447700>! in kf_cup_para, when you have shallow conv,<a name='855'></font>
<font color=#447700>!    ainc (and so updraft area and mass fluxes) get multiplied by jfd(ipert,jpert)<a name='856'></font>
<font color=#447700>!       which is passed in as "freq"<a name='857'></font>
<font color=#447700>!    thus the following variables that are averaged over perts <a name='858'></font>
<font color=#447700>!       should not be weighted by jfd (same for updfra_shall) <a name='859'></font>
                        umf_shall(k)    = umf_shall(k) + max( 0.0, umfout(k) )  <font color=#447700>! rce 11-may-2012 start<a name='860'></font>
                        uer_shall(k)    = uer_shall(k) + max( 0.0, uerout(k) )<a name='861'>
                        udr_shall(k)    = udr_shall(k) + max( 0.0, udrout(k) )  <font color=#447700>! rce 11-may-2012 end<a name='862'></font>
                     enddo<a name='863'>
                     nca_shall    = nca(i,j)<font color=#447700>!NINT(TIMEC_SHALL/DT)*DT ! add 01/11/2012 real(ntst)*DT !add dt 01/11/2012 All shallow clouds have a 40 min time scale per KF code.<a name='864'></font>
                     raincv_shall = raincv_shall + raincv(i,j)*jfd(ipert,jpert)<a name='865'>
                     <font color=#447700>!!!raincv_shall = raincv_shall + raincv(i,j)<a name='866'></font>
                     cubot_shall  = cubot_shall + z1d(nint(cubot(i,j)))*jfd(ipert,jpert) <font color=#447700>!Average the heights, then back out index later<a name='867'></font>
                     cutop_shall  = cutop_shall + z1d(nint(cutop(i,j)))*jfd(ipert,jpert) <font color=#447700>!ditto<a name='868'></font>
                     qlg_shall    = qlg_shall + qlg*jfd(ipert,jpert)<a name='869'>
                     <font color=#447700>!!!qlg_shall    = qlg_shall + qlg<a name='870'></font>
                     qig_shall    = qig_shall + qig*jfd(ipert,jpert)<a name='871'>
                     <font color=#447700>!!!qig_shall    = qig_shall + qig<a name='872'></font>
<font color=#447700>!                    wCloudBase(i,j) = wLCL * jfd(ipert,jpert) + wCloudBase(i,j)  ! rce 11-may-2012 start<a name='873'></font>
                     wCloudBase_shall= wLCL * jfd(ipert,jpert) + wCloudBase_shall<a name='874'>
                     do k = max( kts, nint(cubot(i,j)) ), min( kte, nint(cutop(i,j)) )<a name='875'>
                        <font color=#447700>! these are "in cloud" values, so only do them for cubot &lt;= k &lt;= cutop<a name='876'></font>
                        cumshallfreq1d(k)  = cumshallfreq1d(k)  + jfd(ipert,jpert)<a name='877'>
                        qndrop_ic_shall(k) = qndrop_ic_shall(k) + qndrop1d(k)*jfd(ipert,jpert)<a name='878'>
                        qc_ic_shall(k)     = qc_ic_shall(k)     + qc1d(k)*jfd(ipert,jpert)<a name='879'>
                        qi_ic_shall(k)     = qi_ic_shall(k)     + qi1d(k)*jfd(ipert,jpert)<a name='880'>
                        <font color=#447700>! fcvt_qc_to_pr is fraction of qc converted to precip as air moves through the updraft layer<a name='881'></font>
                        <font color=#447700>! compute average as:  sum( fcvt_qc_to_pr * qc1d * jfd ) / sum( qc1d * jfd )<a name='882'></font>
                        fcvt_qc_to_pr_shall(k) = fcvt_qc_to_pr_shall(k) + fcvt_qc_to_pr(k)*qc1d(k)*jfd(ipert,jpert)<a name='883'>
                        fcvt_qc_to_qi_shall(k) = fcvt_qc_to_qi_shall(k) + fcvt_qc_to_qi(k)*qc1d(k)*jfd(ipert,jpert)<a name='884'>
                        fcvt_qi_to_pr_shall(k) = fcvt_qi_to_pr_shall(k) + fcvt_qi_to_pr(k)*qi1d(k)*jfd(ipert,jpert)<a name='885'>
                     end do<a name='886'>
                     wup_shall    = wup_shall    + wup*jfd(ipert,jpert)<a name='887'>
                     wact_shall   = wact_shall   + wact*jfd(ipert,jpert)<a name='888'>
                     wulcl_shall  = wulcl_shall  + wulcl*jfd(ipert,jpert)<a name='889'>
                     updfra_shall = updfra_shall + updfra<a name='890'>
                     wcb_v2_shall = wcb_v2_shall + jfd(ipert,jpert)*max( wlcl, wulcl )<a name='891'>
                     kcubotmin = min( kcubotmin, nint(cubot(i,j)) )<a name='892'>
                     kcubotmax = max( kcubotmax, nint(cubot(i,j)) )<a name='893'>
                     kcutopmin = min( kcutopmin, nint(cutop(i,j)) )<a name='894'>
                     kcutopmax = max( kcutopmax, nint(cutop(i,j)) )  <font color=#447700>! rce 11-may-2012 end<a name='895'></font>
                  end if<a name='896'>
<a name='897'>
             <a name='898'>
<font color=#447700>!<a name='899'></font>
<font color=#447700>! Otherwise, no convection occurred so do nothing.<a name='900'></font>
<font color=#447700>!<a name='901'></font>
               end do<a name='902'>
               end do PERTLOOPS<a name='903'>
<font color=#447700>!<a name='904'></font>
<font color=#447700>! Now that we know what kind of convection will occur, copy the<a name='905'></font>
<font color=#447700>! appropriate type, shallow or deep, into the output arrays that<a name='906'></font>
<font color=#447700>! KF normally expects. Shallow convection needs to be turned into<a name='907'></font>
<font color=#447700>! an average from a running sum.<a name='908'></font>
<font color=#447700>!<a name='909'></font>
<font color=#447700>!               write(*,*) 'raincv_deep',raincv_deep,ishall,'raincv_deep' !LD, 20-April-2011<a name='910'></font>
<a name='911'>
main_test_on_deep_shall_freq: &amp;  <font color=#447700>! rce 11-may-2012<a name='912'></font>
               if( cumDeepFreq &gt; minDeepFreq ) then <font color=#447700>!Deep convection<a name='913'></font>
                  ishall      = 0<a name='914'>
                  activeFrac(i,j)  = 1.<a name='915'>
                  do k = kts, kte            <font color=#447700>! Added by lkb<a name='916'></font>
                     dqdt(k)        = dqdt_deep(k)<a name='917'>
                     dqidt(k)       = dqidt_deep(k)<a name='918'>
                     dqcdt(k)       = dqcdt_deep(k)<a name='919'>
                     dqrdt(k)       = dqrdt_deep(k)<a name='920'>
                     dqsdt(k)       = dqsdt_deep(k)<a name='921'>
                     dtdt(k)        = dtdt_deep(k)<a name='922'>
                  enddo<a name='923'>
<a name='924'>
                  nca(i,j)    = nca_deep<a name='925'>
                  raincv(i,j) = raincv_deep<a name='926'>
                  cubot(i,j)  = cubot_deep<a name='927'>
                  cutop(i,j)  = cutop_deep<a name='928'>
<font color=#447700>!               write(*,*) 'raincv',raincv,ishall,'raincv' !LD, 20-April-2011<a name='929'></font>
<a name='930'>
                  qc_iu_cup(i,kts:kte,j)     = qc_ic_deep(kts:kte)  <font color=#447700>! rce 11-may-2012 start<a name='931'></font>
                  qc_ic_cup(i,kts:kte,j)     = qc_ic_deep(kts:kte)<a name='932'>
                  qndrop_ic_cup(i,kts:kte,j) = qndrop_ic_deep(kts:kte)<a name='933'>
                  wup_cup(i,kts:kte,j)       = wup_deep(kts:kte)<a name='934'>
                  wact_cup(i,j)           = wact_deep<a name='935'>
                  wulcl_cup(i,j)          = wulcl_deep<a name='936'>
                  wCloudBase(i,j)         = wCloudBase_deep<a name='937'>
                  wcb_v2                  = wcb_v2_deep<a name='938'>
<a name='939'>
                  kcutop = nint(cutop_deep)<a name='940'>
                  fcvt_qc_to_pr_cup(i,kts:kcutop,j) = fcvt_qc_to_pr_deep(kts:kcutop)<a name='941'>
                  fcvt_qc_to_qi_cup(i,kts:kcutop,j) = fcvt_qc_to_qi_deep(kts:kcutop)<a name='942'>
                  fcvt_qi_to_pr_cup(i,kts:kcutop,j) = fcvt_qi_to_pr_deep(kts:kcutop)<a name='943'>
<a name='944'>
                  call <A href='../../html_code/phys/module_cu_kfcup.F.html#ADJUST_MFENTDET_KFCUP'>adjust_mfentdet_kfcup</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_MFENTDET_KFCUP_1">( idiagee, grid_id, ktau, &amp;<a name='945'>
                     i, j, kts, kte, kcutop, ishall, &amp;<a name='946'>
                     umf_deep, uer_deep, udr_deep, dmf_deep, der_deep, ddr_deep )<a name='947'>
<a name='948'>
                  <font color=#447700>! mfup_ent_cup(k) is at center of layer k, and is 0 for k &gt; kcutop<a name='949'></font>
                  mfup_ent_cup(i,kts:kcutop,j) = uer_deep(kts:kcutop)<a name='950'>
                  <font color=#447700>! mfup_cup(k)  is at bottom of layer k, and is 0 for k &gt; kcutop<a name='951'></font>
                  <font color=#447700>! umf_deep(k) is at top of layer k<a name='952'></font>
                  mfup_cup(i,kts+1:kcutop,j) = umf_deep(kts:kcutop-1)<a name='953'>
                  mfdn_ent_cup(i,kts:kcutop,j) = der_deep(kts:kcutop)<a name='954'>
                  mfdn_cup(i,kts+1:kcutop,j) = dmf_deep(kts:kcutop-1)<a name='955'>
<a name='956'>
                  updfra_cup(i,kupdrbot_deep:kcutop,j) = updfra_deep<a name='957'>
                  tcloud_cup(i,j) = nca_deep  <font color=#447700>! rce 11-may-2012 end<a name='958'></font>
<a name='959'>
<font color=#447700>!main_test_on_deep_shall_freq: &amp;  ! rce 11-may-2012<a name='960'></font>
               else if( cumShallFreq &gt; 0. ) then  <font color=#447700>!Shallow convection<a name='961'></font>
                  ishall      = 1<a name='962'>
                  activeFrac(i,j)  = cumShallFreq<a name='963'>
                  <a name='964'>
                  do k = kts, kte            <font color=#447700>! Added by lkb<a name='965'></font>
                     <font color=#447700>!!!dqdt        = dqdt_shall / cumShallFreq<a name='966'></font>
                     dqdt(k)        = dqdt_shall(k)<a name='967'>
                     <font color=#447700>!!!dqidt       = dqidt_shall / cumShallFreq<a name='968'></font>
                     dqidt(k)       = dqidt_shall(k)<a name='969'>
                     <font color=#447700>!!!dqcdt       = dqcdt_shall / cumShallFreq<a name='970'></font>
                     dqcdt(k)       = dqcdt_shall(k)<a name='971'>
                     <font color=#447700>!!!dqrdt       = dqrdt_shall / cumShallFreq<a name='972'></font>
                     dqrdt(k)       = dqrdt_shall(k) <a name='973'>
                     <font color=#447700>!!!dqsdt       = dqsdt_shall / cumShallFreq<a name='974'></font>
                     dqsdt(k)       = dqsdt_shall(k) <a name='975'>
                     <font color=#447700>!!!dtdt(k)        = dtdt_shall(k) / cumShallFreq<a name='976'></font>
                     dtdt(k)        = dtdt_shall(k)<a name='977'>
                  enddo<a name='978'>
 <a name='979'>
                  nca(i,j)    = nca_shall    <font color=#447700>! shallow convection timescale is locked to convective time scale<a name='980'></font>
                  raincv(i,j) = raincv_shall / cumShallFreq<a name='981'>
                  <font color=#447700>!!!raincv(i,j) = raincv_shall<a name='982'></font>
<a name='983'>
                  cubot_shall = cubot_shall / cumShallFreq <font color=#447700>!This gives the average height in AMSL<a name='984'></font>
                  cutop_shall = cutop_shall / cumShallFreq <font color=#447700>!ditto<a name='985'></font>
                  cubot(i,j)  = <A href='../../html_code/phys/module_cu_kfcup.F.html#FINDINDEX'>findIndex</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FINDINDEX_2">(cubot_shall, z_at_w1d)-1 <font color=#447700>!Now, get the index of the level<a name='986'></font>
                  cutop(i,j)  = <A href='../../html_code/phys/module_cu_kfcup.F.html#FINDINDEX'>findIndex</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FINDINDEX_3">(cutop_shall, z_at_w1d)-1 <font color=#447700>!ditto<a name='987'></font>
                  qlg         = qlg_shall / cumShallFreq<a name='988'>
                  <font color=#447700>!!!qlg         = qlg_shall <a name='989'></font>
                  qig         = qig_shall / cumShallFreq<a name='990'>
                  <font color=#447700>!!!qig         = qig_shall<a name='991'></font>
<a name='992'>
<font color=#447700>!                 wCloudBase(i,j) = wCloudBase(i,j) / cumShallFreq  ! rce 11-may-2012 start<a name='993'></font>
                  wCloudBase_shall= wCloudBase_shall/ cumShallFreq<a name='994'>
                  wCloudBase(i,j) = wCloudBase_shall<a name='995'>
<a name='996'>
                  do k = kts, kte<a name='997'>
                     <font color=#447700>! these are "in cloud" values<a name='998'></font>
                     if (cumshallfreq1d(k) &gt; 0.0) then<a name='999'>
                        fcvt_qc_to_pr_shall(k) = fcvt_qc_to_pr_shall(k) / max( 1.0e-20, qc_ic_shall(k) )<a name='1000'>
                        fcvt_qc_to_qi_shall(k) = fcvt_qc_to_qi_shall(k) / max( 1.0e-20, qc_ic_shall(k) )<a name='1001'>
                        fcvt_qi_to_pr_shall(k) = fcvt_qi_to_pr_shall(k) / max( 1.0e-20, qi_ic_shall(k) )<a name='1002'>
                        qndrop_ic_shall(k) = qndrop_ic_shall(k)/cumshallfreq1d(k)<a name='1003'>
                        qc_ic_shall(k)     = qc_ic_shall(k)/cumshallfreq1d(k)<a name='1004'>
                        qi_ic_shall(k)     = qi_ic_shall(k)/cumshallfreq1d(k)<a name='1005'>
                     end if<a name='1006'>
                     cumshallfreq1d(k) = cumshallfreq1d(k)/cumshallfreq<a name='1007'>
                  end do<a name='1008'>
                  wup_shall    = wup_shall/cumshallfreq<a name='1009'>
                  wact_shall   = wact_shall/cumshallfreq<a name='1010'>
                  wulcl_shall  = wulcl_shall/cumshallfreq<a name='1011'>
                  wcb_v2_shall = wcb_v2_shall / cumshallfreq<a name='1012'>
                  wup_cup(i,kts:kte,j) = wup_shall(kts:kte)<a name='1013'>
                  wact_cup(i,j)  = wact_shall<a name='1014'>
                  wulcl_cup(i,j) = wulcl_shall<a name='1015'>
                  wcb_v2         = wcb_v2_shall<a name='1016'>
<a name='1017'>
                  kcubot = nint(cubot(i,j))<a name='1018'>
                  kcutop = nint(cutop(i,j))<a name='1019'>
                  <font color=#447700>! qc_ic_cup(k) and qndrop_ic_cup(k) are at center of layer k, and are 0 for k &gt; kcutop<a name='1020'></font>
                  qc_ic_cup(i,kts:kcutop,j)     = qc_ic_shall(kts:kcutop)<a name='1021'>
                  qndrop_ic_cup(i,kts:kcutop,j) = qndrop_ic_shall(kts:kcutop)<a name='1022'>
                  <font color=#447700>! note:  qc_ic_shall = qc1d from subr. kf_cup_para is really for updraft<a name='1023'></font>
                  <font color=#447700>! if an empirical "in cumulus" cloud-water is used for radiation, <a name='1024'></font>
                  <font color=#447700>!    it should be put into qc_ic_cup, and used for cloud-chemistry too<a name='1025'></font>
                  qc_iu_cup(i,kts:kcutop,j)     = qc_ic_shall(kts:kcutop)<a name='1026'>
                  <font color=#447700>! for qc_ic_cup, use the value in module_ra_cam (1.0 g/kg)<a name='1027'></font>
                  <font color=#447700>!    For shallow convection, use a representative condensate value based on<a name='1028'></font>
                  <font color=#447700>!    observations from CHAPS (Oklahoma area) and Florida (Blyth et al. 2005)<a name='1029'></font>
                  qc_ic_cup(i,kcubot:kcutop,j) = 1.0e-3<a name='1030'>
<a name='1031'>
                  fcvt_qc_to_pr_cup(i,kts:kcutop,j) = fcvt_qc_to_pr_shall(kts:kcutop)<a name='1032'>
                  fcvt_qc_to_qi_cup(i,kts:kcutop,j) = fcvt_qc_to_qi_shall(kts:kcutop)<a name='1033'>
                  fcvt_qi_to_pr_cup(i,kts:kcutop,j) = fcvt_qi_to_pr_shall(kts:kcutop)<a name='1034'>
<a name='1035'>
                  call <A href='../../html_code/phys/module_cu_kfcup.F.html#ADJUST_MFENTDET_KFCUP'>adjust_mfentdet_kfcup</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_MFENTDET_KFCUP_2">( idiagee, grid_id, ktau, &amp;<a name='1036'>
                     i, j, kts, kte, kcutop, ishall, &amp;<a name='1037'>
                     umf_shall, uer_shall, udr_shall, dmfout, derout, ddrout )<a name='1038'>
<a name='1039'>
                  <font color=#447700>! mfup_ent_cup(k) is at center of layer k, and is 0 for k &gt; kcutop<a name='1040'></font>
                  mfup_ent_cup(i,kts:kcutop,j) = uer_shall(kts:kcutop)<a name='1041'>
                  <font color=#447700>! mfup_cup(k)  is at bottom of layer k, and is 0 for k &gt; kcutop<a name='1042'></font>
                  <font color=#447700>! umf_shall(k) is at top of layer k<a name='1043'></font>
                  mfup_cup(i,kts+1:kcutop,j) = umf_shall(kts:kcutop-1)<a name='1044'>
<a name='1045'>
                  kupdrbot_shall = kcubot<a name='1046'>
                  do k = kcubot-1, kts, -1<a name='1047'>
                     if ((umf_shall(k) &gt; 0.0) .or. (uer_shall(k) &gt; 0.0)) kupdrbot_shall = k<a name='1048'>
                  end do<a name='1049'>
                  updfra_cup(i,kupdrbot_shall:kcutop,j) = updfra_shall<a name='1050'>
                  tcloud_cup(i,j) = nca_shall  <font color=#447700>! rce 11-may-2012 end<a name='1051'></font>
                 <a name='1052'>
<font color=#447700>!main_test_on_deep_shall_freq: &amp;  ! rce 11-may-2012<a name='1053'></font>
               else                                <font color=#447700>!No convection<a name='1054'></font>
                  ishall      = 2<a name='1055'>
                  activeFrac(i,j)  = 0.<a name='1056'>
                  dqdt        = 0.<a name='1057'>
                  dqidt       = 0.<a name='1058'>
                  dqcdt       = 0.<a name='1059'>
                  dqrdt       = 0.<a name='1060'>
                  dqsdt       = 0.<a name='1061'>
                  dtdt        = 0.<a name='1062'>
                  nca(i,j)    = -1.<a name='1063'>
                  raincv(i,j) = 0.<a name='1064'>
                  cubot(i,j)  = 1.<font color=#447700>! add 1 replace 0 LD 01/11/2012<a name='1065'></font>
                  cutop(i,j)  = 1.<a name='1066'>
               end if main_test_on_deep_shall_freq  <font color=#447700>! rce 11-may-2012<a name='1067'></font>
            <a name='1068'>
               if (idiagee&gt;0) write(*,'(a,3i5,1p,3e11.3)') 'kfcup 2 ishall, cubot/top, nca', &amp;<a name='1069'>
                  ishall, nint(cubot(i,j)), nint(cutop(i,j)), nca(i,j)  <font color=#447700>! rce 11-may-2012<a name='1070'></font>
<a name='1071'>
               shall(i,j) = real(ishall)<a name='1072'>
               kcubot = int(cubot(i,j))<a name='1073'>
               kcutop = int(cutop(i,j))<a name='1074'>
               call <A href='../../html_code/phys/module_cu_kfcup.F.html#CUPCLOUDFRACTION'>cupCloudFraction</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUPCLOUDFRACTION_1">(qlg, qig, qv1d, t1d, z1d, p1d, &amp;<a name='1075'>
                    kcubot, kcutop, ishall, wStar, wCloudBase(i,j), pblh(i,j), dt, &amp;<a name='1076'>
                    activeFrac(i,j), cldfra_cup1d, cldfratend_cup1d, &amp;<a name='1077'>
                    taucloud(i,j), tActive(i,j), tstar(i,j), lnterms(i,:,j), &amp;<a name='1078'>
                    lnint(i,j), &amp;<a name='1079'>
                    kts, kte, mfup_cup(i,:,j))  <font color=#447700>! add mfup_cup LD 06 29 2012<a name='1080'></font>
                  <font color=#447700>! kts, kte)<a name='1081'></font>
               do k=kts,kte<a name='1082'>
                  cldfra_cup(i,k,j) = cldfra_cup1d(k)<a name='1083'>
               end do<a name='1084'>
<a name='1085'>
<a name='1086'>
               if (idiagee &gt; 0) then<a name='1087'>
                  call <A href='../../html_code/phys/module_cu_kfcup.F.html#CU_KFCUP_DIAGEE01'>cu_kfcup_diagee01</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CU_KFCUP_DIAGEE01_1">( &amp;  <font color=#447700>! rce 11-may-2012<a name='1088'></font>
                     ims, ime, jms, jme, kms, kme, kts, kte, &amp;<a name='1089'>
                     i, j, &amp;<a name='1090'>
                     idiagee, idiagff, ishall, ktau, &amp;<a name='1091'>
                     kcubotmin, kcubotmax, kcutopmin, kcutopmax, &amp;<a name='1092'>
                     activefrac, cldfra_cup1d, &amp;<a name='1093'>
                     cubot, cutop, cumshallfreq1d, &amp;<a name='1094'>
                     ddr_deep, der_deep, dmf_deep, dt, dz1d, &amp;<a name='1095'>
                     fcvt_qc_to_pr_deep, fcvt_qc_to_qi_deep, fcvt_qi_to_pr_deep, &amp;<a name='1096'>
                     fcvt_qc_to_pr_shall, fcvt_qc_to_qi_shall, fcvt_qi_to_pr_shall, &amp;<a name='1097'>
                     nca_deep, nca_shall, p1d, pblh, &amp;<a name='1098'>
                     qc_ic_deep, qc_ic_shall, qi_ic_deep, qi_ic_shall, qndrop_ic_cup, rho1d, &amp;<a name='1099'>
                     tactive, taucloud, tstar, &amp;<a name='1100'>
                     udr_deep, udr_shall, uer_deep, uer_shall, umf_deep, umf_shall, &amp;<a name='1101'>
                     updfra_deep, updfra_shall, updfra_cup, &amp;<a name='1102'>
                     wact_cup, wcloudbase, wcb_v2, wcb_v2_shall, &amp;<a name='1103'>
                     wulcl_cup, wstar, z1d, z_at_w1d )<a name='1104'>
               end if<a name='1105'>
<a name='1106'>
              <a name='1107'>
<font color=#447700>!!$      write(message,'(2i4,a,f10.5,a,f10.5)') i,j," Frequencies: cumDeepFreq=",cumDeepFreq," cumShallFreq=",cumShallFreq<a name='1108'></font>
<font color=#447700>!!$      call wrf_message(message)<a name='1109'></font>
               <a name='1110'>
<a name='1111'>
<font color=#447700>!main_test_on_cupflag  ! rce 11-may-2012<a name='1112'></font>
            else<a name='1113'>
<font color=#447700>!<a name='1114'></font>
<font color=#447700>! CuP did not trigger due to stable conditions so default to standard<a name='1115'></font>
<font color=#447700>! KF scheme...<a name='1116'></font>
<font color=#447700>!<a name='1117'></font>
               <font color=#447700>!!CALL KF_cup_PARA(I, J,                    &amp;<a name='1118'></font>
               <font color=#447700>!!     U1D,V1D,T1D,QV1D,P1D,DZ1D,           &amp;<a name='1119'></font>
               <font color=#447700>!!     W0AVG1D,DT,DX,DXSQ,RHO1D,            &amp;<a name='1120'></font>
               <font color=#447700>!!     XLV0,XLV1,XLS0,XLS1,CP,R,G,          &amp;<a name='1121'></font>
               <font color=#447700>!!     EP2,SVP1,SVP2,SVP3,SVPT0,            &amp;<a name='1122'></font>
               <font color=#447700>!!     pblh(i,j),z_at_w1d,cupflag(i,j),     &amp; !wig, 21-Feb-2008<a name='1123'></font>
               <font color=#447700>!!     th_perturb(1),r_perturb(1),          &amp; !wig, 9-Oct-2006<a name='1124'></font>
               <font color=#447700>!!    0.01,                                &amp; !lkb, 15-Aug-2008, replace mass flux with default<a name='1125'></font>
               <font color=#447700>!!     ishall,qlg,qig,                      &amp; !wig, 20-Sep-2006<a name='1126'></font>
               <font color=#447700>!!     DQDT,DQIDT,DQCDT,DQRDT,DQSDT,DTDT,   &amp;<a name='1127'></font>
               <font color=#447700>!!     RAINCV,NCA,NTST,                     &amp;<a name='1128'></font>
               <font color=#447700>!!     flag_QI,flag_QS,warm_rain,           &amp;<a name='1129'></font>
               <font color=#447700>!!     CUTOP,CUBOT,                         &amp;<a name='1130'></font>
               <font color=#447700>!!     ids,ide, jds,jde, kds,kde,           &amp;<a name='1131'></font>
               <font color=#447700>!!     ims,ime, jms,jme, kms,kme,           &amp;<a name='1132'></font>
               <font color=#447700>!!     its,ite, jts,jte, kts,kte)<a name='1133'></font>
<a name='1134'>
               CALL <A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA'>KF_cup_PARA</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="KF_CUP_PARA_2">( GRID_ID, KTAU,          &amp; <font color=#447700>! rce 11-may-2012<a name='1135'></font>
                    I, J,                                &amp;<a name='1136'>
                    U1D,V1D,T1D,QV1D,P1D,DZ1D,           &amp;<a name='1137'>
                    W0AVG1D,DT,DX,DXSQ,RHO1D,            &amp;<a name='1138'>
                    XLV0,XLV1,XLS0,XLS1,CP,R,G,          &amp;<a name='1139'>
                    EP2,SVP1,SVP2,SVP3,SVPT0,            &amp;<a name='1140'>
                    pblh(i,j),z_at_w1d,cupflag(i,j),     &amp; <font color=#447700>!wig, 21-Feb-2008<a name='1141'></font>
                    th_perturb(1),r_perturb(1),          &amp; <font color=#447700>!wig, 9-Oct-2006<a name='1142'></font>
                    0.01,                                 &amp; <font color=#447700>!lkb, 15-Aug-2008, replace mass flux with default<a name='1143'></font>
                    ishall,qlg,qig,                      &amp; <font color=#447700>!wig, 20-Sep-2006<a name='1144'></font>
                    DQDT,DQIDT,DQCDT,DQRDT,DQSDT,DTDT,   &amp;<a name='1145'>
                    RAINCV,NCA,NTST,                     &amp; <font color=#447700>!LD, add PRATEC 21-Apr-2011<a name='1146'></font>
                    flag_QI,flag_QS,warm_rain,           &amp;<a name='1147'>
                    CUTOP,CUBOT,WLCL,                    &amp;<a name='1148'>
                    ids,ide, jds,jde, kds,kde,           &amp;<a name='1149'>
                    ims,ime, jms,jme, kms,kme,           &amp;<a name='1150'>
                    its,ite, jts,jte, kts,kte,           &amp;<a name='1151'>
                    idiagee, updfra, wulcl, wup,         &amp;<a name='1152'>
                    umfout, uerout, udrout,              &amp; <font color=#447700>! rce 11-may-2012<a name='1153'></font>
                    dmfout, derout, ddrout,              &amp; <font color=#447700>!         "<a name='1154'></font>
                    shcu_aerosols_opt,                   &amp; <font color=#447700>!         "<a name='1155'></font>
                    flag_chem, num_chem,                 &amp; <font color=#447700>!         "<a name='1156'></font>
                    wact, qndrop1d, qc1d, qi1d,          &amp; <font color=#447700>!         "<a name='1157'></font>
                    fcvt_qc_to_qi, fcvt_qc_to_pr,        &amp; <font color=#447700>!         "<a name='1158'></font>
                    fcvt_qi_to_pr, chem1d,               &amp; <font color=#447700>!         "<a name='1159'></font>
#if ( WRF_CHEM == 1 )<a name='1160'>
                    maxd_acomp, maxd_aphase,             &amp; <font color=#447700>!         "<a name='1161'></font>
                    maxd_atype, maxd_asize,              &amp; <font color=#447700>!         "<a name='1162'></font>
                    ntype_aer, nsize_aer, ncomp_aer,     &amp; <font color=#447700>!         "<a name='1163'></font>
                    ai_phase, msectional,                &amp; <font color=#447700>!         "<a name='1164'></font>
                    massptr_aer, numptr_aer,             &amp; <font color=#447700>!         "<a name='1165'></font>
                    dlo_sect, dhi_sect,                  &amp; <font color=#447700>!         "<a name='1166'></font>
                    dens_aer, hygro_aer, sigmag_aer      ) <font color=#447700>!         "<a name='1167'></font>
#else<a name='1168'>
                    1, 1,                                &amp; <font color=#447700>!         "<a name='1169'></font>
                    1, 1                                 ) <font color=#447700>! rce 11-may-2012<a name='1170'></font>
#endif<a name='1171'>
<a name='1172'>
               <font color=#447700>!!shall(i,j) = real(ishall)<a name='1173'></font>
               <font color=#447700>!!do k=kts,kte<a name='1174'></font>
               <font color=#447700>!!   cldfra_cup(i,k,j) = 0.<a name='1175'></font>
               <font color=#447700>!!end do<a name='1176'></font>
<a name='1177'>
               <font color=#447700>! rce 11-may-2012 *** currently, clouds produce by this call to kf_cup_para do not<a name='1178'></font>
               <font color=#447700>! rce 11-may-2012 ***    produce any "cup" diagnostics and do not used by chem_cup<a name='1179'></font>
               <font color=#447700>! rce 11-may-2012 *** may want to change that eventually<a name='1180'></font>
               <a name='1181'>
            end if main_test_on_cupflag  <font color=#447700>! rce 11-may-2012<a name='1182'></font>
            <a name='1183'>
<a name='1184'>
<font color=#447700>! This was moved from earlier in the routine...<a name='1185'></font>
      IF(PRESENT(rthcuten).AND.PRESENT(rqvcuten)) THEN<a name='1186'>
         DO K=kts,kte<a name='1187'>
            RTHCUTEN(I,K,J)=DTDT(K)/pi(I,K,J)<a name='1188'>
            RQVCUTEN(I,K,J)=DQDT(K)<a name='1189'>
         ENDDO<a name='1190'>
      ENDIF<a name='1191'>
<font color=#447700>! wig: end<a name='1192'></font>
<a name='1193'>
            IF(PRESENT(rqrcuten).AND.PRESENT(rqccuten)) THEN<a name='1194'>
              IF( F_QR )THEN<a name='1195'>
                DO K=kts,kte<a name='1196'>
                   RQRCUTEN(I,K,J)=DQRDT(K)<a name='1197'>
                   RQCCUTEN(I,K,J)=DQCDT(K)<a name='1198'>
                ENDDO<a name='1199'>
              ELSE<a name='1200'>
<font color=#447700>! This is the case for Eta microphysics without 3d rain field<a name='1201'></font>
                DO K=kts,kte<a name='1202'>
                   RQRCUTEN(I,K,J)=0.<a name='1203'>
                   RQCCUTEN(I,K,J)=DQRDT(K)+DQCDT(K)<a name='1204'>
                ENDDO<a name='1205'>
              ENDIF<a name='1206'>
            ENDIF<a name='1207'>
<a name='1208'>
<font color=#447700>!......     QSTEN STORES GRAUPEL TENDENCY IF IT EXISTS, OTHERISE SNOW (V2)<a name='1209'></font>
<a name='1210'>
            IF(PRESENT( rqicuten )) THEN<a name='1211'>
              IF ( F_QI ) THEN<a name='1212'>
                DO K=kts,kte<a name='1213'>
                   RQICUTEN(I,K,J)=DQIDT(K)<a name='1214'>
                ENDDO<a name='1215'>
              ENDIF<a name='1216'>
            ENDIF<a name='1217'>
<a name='1218'>
            IF(PRESENT( rqscuten )) THEN<a name='1219'>
              IF ( F_QS ) THEN<a name='1220'>
                DO K=kts,kte<a name='1221'>
                   RQSCUTEN(I,K,J)=DQSDT(K)<a name='1222'>
                ENDDO<a name='1223'>
              ENDIF<a name='1224'>
            ENDIF<a name='1225'>
<font color=#447700>!<a name='1226'></font>
         if (idiagee&gt;0) then  <font color=#447700>! rce 11-may-2012<a name='1227'></font>
            write(*,'(a,3i5,1p,3e11.3)') 'kfcup 3 ishall, cubot/top, nca', ishall, nint(cubot(i,j)), nint(cutop(i,j)), nca(i,j)<a name='1228'>
            write(*,'(a,5i5,1p,3e11.3)') 'kfcup a08 ishall, i/jpert_deep, cubot/top, nca', ishall, &amp;<a name='1229'>
               ipert_deepsv, jpert_deepsv, nint(cubot(i,j)), nint(cutop(i,j)), nca(i,j)<a name='1230'>
         end if<a name='1231'>
<a name='1232'>
         ENDIF main_test_on_nca  <font color=#447700>! rce 11-may-2012<a name='1233'></font>
<a name='1234'>
        ENDDO main_loop_on_i  <font color=#447700>! rce 11-may-2012<a name='1235'></font>
     ENDDO main_loop_on_j  <font color=#447700>! rce 11-may-2012<a name='1236'></font>
   ENDIF main_test_on_ktau_ntst  <font color=#447700>! rce 11-may-2012<a name='1237'></font>
<a name='1238'>
<font color=#447700>!            write(*,*) 'end',raincv,ishall,'end'    !LD, 20-April-2011<a name='1239'></font>
<a name='1240'>
   if (idiagff &gt; 0) then  <font color=#447700>! rce 11-may-2012<a name='1241'></font>
      i = its ; j = jts<a name='1242'>
      write(*,'(a,i5,10x,l5,3i5,f10.1,1p,2e10.2)') 'kfcup a09 ktau;    cupflag,ishall,bot/top; nca,cldfra,rqvcuten', &amp;<a name='1243'>
         ktau, cupflag(i,j), nint(shall(i,j)), nint(cubot(i,j)), nint(cutop(i,j)), nca(i,j), &amp;<a name='1244'>
         maxval(cldfra_cup(i,kts:kte-2,j)), maxval(rqvcuten(i,kts:kte-2,j))<a name='1245'>
      write(*,'(a,10i5)') 'kfcup a10 maxlocs for cldfra_cup &amp; rqvcuten', &amp;<a name='1246'>
         maxloc(cldfra_cup(i,kts:kte-2,j)), maxloc(rqvcuten(i,kts:kte-2,j))<a name='1247'>
      write(*,'(a,i7,l5,3i5,2f10.1)') 'kfcup_a20 ktau, cupflag, ishall, bot/top, nca, tcloud', &amp;<a name='1248'>
         ktau, cupflag(i,j), nint(shall(i,j)), nint(cubot(i,j)), nint(cutop(i,j)), nca(i,j), tcloud_cup(i,j)<a name='1249'>
   end if<a name='1250'>
<a name='1251'>
   END SUBROUTINE KF_cup_CPS<a name='1252'>
<font color=#447700>! ****************************************************************************<a name='1253'></font>
<font color=#447700>!-----------------------------------------------------------<a name='1254'></font>
<A NAME='KF_CUP_PARA'><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1255'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>KF_cup_PARA</font> ( GRID_ID, KTAU,                 &amp; <font color=#447700>! rce 11-may-2012 <A href='../../call_to/KF_CUP_PARA.html' TARGET='index'>2</A>,<A href='../../call_from/KF_CUP_PARA.html' TARGET='index'>20</A><a name='1256'></font>
                      I, J,                                &amp;<a name='1257'>
                      U0,V0,T0,QV0,P0,DZQ,W0AVG1D,         &amp;<a name='1258'>
                      DT,DX,DXSQ,rhoe,                     &amp;<a name='1259'>
                      XLV0,XLV1,XLS0,XLS1,CP,R,G,          &amp;<a name='1260'>
                      EP2,SVP1,SVP2,SVP3,SVPT0,            &amp;<a name='1261'>
                      pblh,z_at_w1d,cupflag,               &amp; <font color=#447700>!wig, 21-Feb-2008<a name='1262'></font>
                      th_perturb,r_perturb,                &amp; <font color=#447700>!wig, 25-Aug-2006<a name='1263'></font>
                      freq,                                &amp; <font color=#447700>!lkb, 15-Aug-2008<a name='1264'></font>
                      ishall,qlg,qig,                      &amp; <font color=#447700>!wig, 25-Aug-2006<a name='1265'></font>
                      DQDT,DQIDT,DQCDT,DQRDT,DQSDT,DTDT,   &amp;<a name='1266'>
                      RAINCV,NCA,NTST,                     &amp; <font color=#447700>!LD, add PRATEC 21-Apr-2011<a name='1267'></font>
                      F_QI,F_QS,warm_rain,                 &amp;<a name='1268'>
                      CUTOP,CUBOT, wLCL,                   &amp;<a name='1269'>
                      ids,ide, jds,jde, kds,kde,           &amp;<a name='1270'>
                      ims,ime, jms,jme, kms,kme,           &amp;<a name='1271'>
                      its,ite, jts,jte, kts,kte,           &amp; <font color=#447700>! rce 11-may-2012<a name='1272'></font>
                      idiagee, updfra, wulcl, wup,         &amp; <font color=#447700>!         "<a name='1273'></font>
                      umfout, uerout, udrout,              &amp; <font color=#447700>!         "<a name='1274'></font>
                      dmfout, derout, ddrout,              &amp; <font color=#447700>!         "<a name='1275'></font>
                      shcu_aerosols_opt,                   &amp; <font color=#447700>!         "<a name='1276'></font>
                      flag_chem, num_chem,                 &amp; <font color=#447700>!         "<a name='1277'></font>
                      wact, qndrop1d, qc1d, qi1d,          &amp; <font color=#447700>!         "<a name='1278'></font>
                      fcvt_qc_to_qi, fcvt_qc_to_pr,        &amp; <font color=#447700>!         "<a name='1279'></font>
                      fcvt_qi_to_pr, chem1d,               &amp; <font color=#447700>!         "<a name='1280'></font>
                      maxd_acomp, maxd_aphase,             &amp; <font color=#447700>!         "<a name='1281'></font>
                      maxd_atype, maxd_asize,              &amp; <font color=#447700>!         "<a name='1282'></font>
                      ntype_aer, nsize_aer, ncomp_aer,     &amp; <font color=#447700>!         "<a name='1283'></font>
                      ai_phase, msectional,                &amp; <font color=#447700>!         "<a name='1284'></font>
                      massptr_aer, numptr_aer,             &amp; <font color=#447700>!         "<a name='1285'></font>
                      dlo_sect, dhi_sect,                  &amp; <font color=#447700>!         "<a name='1286'></font>
                      dens_aer, hygro_aer, sigmag_aer      ) <font color=#447700>! rce 11-may-2012<a name='1287'></font>
<a name='1288'>
<font color=#447700>!-----------------------------------------------------------<a name='1289'></font>
<font color=#447700>!***** The KF scheme that is currently used in experimental runs of EMCs <a name='1290'></font>
<font color=#447700>!***** Eta model....jsk 8/00<a name='1291'></font>
<font color=#447700>!<a name='1292'></font>
      IMPLICIT NONE<a name='1293'>
<font color=#447700>!-----------------------------------------------------------<a name='1294'></font>
      INTEGER, INTENT(IN   ) :: ids,ide, jds,jde, kds,kde, &amp;<a name='1295'>
                                ims,ime, jms,jme, kms,kme, &amp;<a name='1296'>
                                its,ite, jts,jte, kts,kte, &amp;<a name='1297'>
                                I,J,NTST,                  &amp;<a name='1298'>
                                GRID_ID, KTAU                <font color=#447700>! rce 11-may-2012<a name='1299'></font>
          <font color=#447700>! ,P_QI,P_QS,P_FIRST_SCALAR<a name='1300'></font>
<a name='1301'>
      LOGICAL, INTENT(IN   ) :: F_QI, F_QS<a name='1302'>
<a name='1303'>
      LOGICAL, INTENT(IN   ) ::                 warm_rain, &amp;<a name='1304'>
                                                  cupflag    <font color=#447700>!CuP, wig 9-Oct-2006<a name='1305'></font>
<font color=#447700>!<a name='1306'></font>
      REAL, DIMENSION( kts:kte ),                          &amp;<a name='1307'>
            INTENT(IN   ) ::                           U0, &amp;<a name='1308'>
                                                       V0, &amp;<a name='1309'>
                                                       T0, &amp;<a name='1310'>
                                                      QV0, &amp;<a name='1311'>
                                                       P0, &amp;<a name='1312'>
                                                     rhoe, &amp;<a name='1313'>
                                                      DZQ, &amp;<a name='1314'>
                                                  W0AVG1D, &amp;<a name='1315'>
                                                 z_at_w1d    <font color=#447700>!wig, 21-Feb-2008<a name='1316'></font>
<font color=#447700>!<a name='1317'></font>
      REAL,  INTENT(IN   ) :: DT,DX,DXSQ, &amp;<a name='1318'>
                              pblh, &amp;                  <font color=#447700>!wig, 21-Feb-2008<a name='1319'></font>
                              th_perturb, r_perturb, &amp; <font color=#447700>!wig, 25-Aug-2006<a name='1320'></font>
                              freq                     <font color=#447700>!lkb, 15-Aug-2008<a name='1321'></font>
<font color=#447700>!<a name='1322'></font>
<a name='1323'>
      REAL,  INTENT(IN   ) :: XLV0,XLV1,XLS0,XLS1,CP,R,G<a name='1324'>
      REAL,  INTENT(IN   ) :: EP2,SVP1,SVP2,SVP3,SVPT0<a name='1325'>
<a name='1326'>
<font color=#447700>!<a name='1327'></font>
      REAL, DIMENSION( kts:kte ), INTENT(INOUT) ::         &amp;<a name='1328'>
                                                     DQDT, &amp;<a name='1329'>
                                                    DQIDT, &amp;<a name='1330'>
                                                    DQCDT, &amp;<a name='1331'>
                                                    DQRDT, &amp;<a name='1332'>
                                                    DQSDT, &amp;<a name='1333'>
                                                     DTDT<a name='1334'>
<a name='1335'>
      REAL,    DIMENSION( ims:ime , jms:jme ),             &amp;<a name='1336'>
            INTENT(INOUT) ::                          NCA<a name='1337'>
<a name='1338'>
      REAL, DIMENSION( ims:ime , jms:jme ),                &amp;<a name='1339'>
            INTENT(INOUT) ::                       RAINCV   <font color=#447700>!LD, add PRATEC 21-Apr-2011<a name='1340'></font>
<a name='1341'>
      integer, intent(out) ::                      ishall    <font color=#447700>!wig, 25-Aug-2006 (was local before)<a name='1342'></font>
      real, intent(out) ::                         wLCL      <font color=#447700>!lkb, 29-April-2010<a name='1343'></font>
      REAL, DIMENSION( kts:kte ), INTENT(OUT) ::           &amp;<a name='1344'>
                                                      qlg, &amp; <font color=#447700>!wig, 20-Sep-2006 (was local before)<a name='1345'></font>
                                                      qig    <font color=#447700>!wig, 20-Sep-2006 (was local before)<a name='1346'></font>
      REAL, DIMENSION( ims:ime , jms:jme ),                &amp;<a name='1347'>
            INTENT(OUT) ::                          CUBOT, &amp;<a name='1348'>
                                                    CUTOP<a name='1349'>
<a name='1350'>
<font color=#447700>! rce 11-may-2012 mods start -------------------------------------------<a name='1351'></font>
      INTEGER, INTENT(IN   ) ::                   idiagee, &amp;<a name='1352'>
                                        shcu_aerosols_opt, &amp;<a name='1353'>
                                                 num_chem<a name='1354'>
<a name='1355'>
      LOGICAL, INTENT(IN   ) ::                 flag_chem   <a name='1356'>
<a name='1357'>
      REAL, INTENT(OUT  ) ::                       updfra, &amp;<a name='1358'>
                                                    wulcl, &amp;<a name='1359'>
                                                     wact<a name='1360'>
<a name='1361'>
      REAL, DIMENSION( kts:kte ),                          &amp;<a name='1362'>
            INTENT(INOUT) ::                       umfout, &amp;<a name='1363'>
                                                   uerout, &amp;<a name='1364'>
                                                   udrout, &amp;<a name='1365'>
                                                   dmfout, &amp;<a name='1366'>
                                                   derout, &amp;<a name='1367'>
                                                   ddrout, &amp;<a name='1368'>
                                                   wup   <a name='1369'>
<a name='1370'>
      REAL, DIMENSION( kts:kte ),                          &amp;<a name='1371'>
            INTENT(INOUT) ::                     qndrop1d, &amp;<a name='1372'>
                                                     qc1d, &amp;<a name='1373'>
                                                     qi1d, &amp;<a name='1374'>
                                            fcvt_qc_to_qi, &amp;<a name='1375'>
                                            fcvt_qc_to_pr, &amp;<a name='1376'>
                                            fcvt_qi_to_pr   <a name='1377'>
<a name='1378'>
      REAL, DIMENSION( kts:kte, 1:num_chem ),              &amp;<a name='1379'>
            INTENT(INOUT) ::                       chem1d   <a name='1380'>
<a name='1381'>
      INTEGER, INTENT(IN   ) ::                maxd_acomp, &amp;<a name='1382'>
                                              maxd_aphase, &amp;<a name='1383'>
                                               maxd_atype, &amp;<a name='1384'>
                                               maxd_asize<a name='1385'>
<a name='1386'>
      INTEGER, INTENT(IN   ), OPTIONAL ::       ntype_aer, &amp;<a name='1387'>
                                    nsize_aer(maxd_atype), &amp;<a name='1388'>
                                    ncomp_aer(maxd_atype), &amp;<a name='1389'>
                                                 ai_phase, &amp;<a name='1390'>
                                               msectional, &amp;<a name='1391'>
         massptr_aer(maxd_acomp,maxd_asize,maxd_atype,maxd_aphase), &amp;<a name='1392'>
            numptr_aer(maxd_asize,maxd_atype,maxd_aphase)   <a name='1393'>
<a name='1394'>
      REAL, DIMENSION( maxd_asize, maxd_atype ),           &amp;<a name='1395'>
            INTENT(IN   ), OPTIONAL :: dlo_sect, dhi_sect, &amp;<a name='1396'>
                                               sigmag_aer   <a name='1397'>
<a name='1398'>
      REAL, DIMENSION( maxd_acomp, maxd_atype ),           &amp;<a name='1399'>
            INTENT(IN   ), OPTIONAL :: dens_aer, hygro_aer  <a name='1400'>
<font color=#447700>! rce 11-may-2012 mods end ---------------------------------------------<a name='1401'></font>
<a name='1402'>
<font color=#447700>!<a name='1403'></font>
<font color=#447700>!...DEFINE LOCAL VARIABLES...<a name='1404'></font>
<font color=#447700>!<a name='1405'></font>
      REAL, DIMENSION( kts:kte ) ::                        &amp;<a name='1406'>
            Q0,Z0,TV0,TU,TVU,QU,TZ,TVD,                    &amp;<a name='1407'>
            QD,QES,THTES,TG,TVG,QG,WU,WD,W0,EMS,EMSD,      &amp;<a name='1408'>
            UMF,UER,UDR,DMF,DER,DDR,UMF2,UER2,             &amp;<a name='1409'>
            UDR2,DMF2,DER2,DDR2,DZA,THTA0,THETEE,          &amp;<a name='1410'>
            THTAU,THETEU,THTAD,THETED,QLIQ,QICE,           &amp;<a name='1411'>
            QLQOUT,QICOUT,PPTLIQ,PPTICE,DETLQ,DETIC,       &amp;<a name='1412'>
            DETLQ2,DETIC2,RATIO,RATIO2<a name='1413'>
<a name='1414'>
<a name='1415'>
      REAL, DIMENSION( kts:kte ) ::                        &amp;<a name='1416'>
            DOMGDP,EXN,TVQU,DP,RH,EQFRC,WSPD,              &amp;<a name='1417'>
            QDT,FXM,THTAG,THPA,THFXOUT,                    &amp;<a name='1418'>
            THFXIN,QPA,QFXOUT,QFXIN,QLPA,QLFXIN,           &amp;<a name='1419'>
            QLFXOUT,QIPA,QIFXIN,QIFXOUT,QRPA,              &amp;<a name='1420'>
            QRFXIN,QRFXOUT,QSPA,QSFXIN,QSFXOUT,            &amp;<a name='1421'>
            QL0,QI0,QR0,QRG,QS0,QSG<a name='1422'>
<a name='1423'>
<a name='1424'>
      REAL, DIMENSION( kts:kte+1 ) :: OMG<a name='1425'>
      REAL, DIMENSION( kts:kte ) :: RAINFB,SNOWFB<a name='1426'>
      REAL, DIMENSION( kts:kte ) ::                        &amp;<a name='1427'>
            CLDHGT,QSD,DILFRC,DDILFRC,TKE,TGU,QGU,THTEEG<a name='1428'>
<a name='1429'>
<font color=#447700>! LOCAL VARS<a name='1430'></font>
<a name='1431'>
      REAL    :: P00,T00,RLF,RHIC,RHBC,PIE,         &amp;<a name='1432'>
                 TTFRZ,TBFRZ,C5,RATE<a name='1433'>
      REAL    :: GDRY,ROCP,ALIQ,BLIQ,                      &amp;<a name='1434'>
                 CLIQ,DLIQ<a name='1435'>
      REAL    :: FBFRC,P300,DPTHMX,THMIX,QMIX,ZMIX,PMIX,   &amp;<a name='1436'>
                 ROCPQ,TMIX,EMIX,TLOG,TDPT,TLCL,TVLCL,     &amp;<a name='1437'>
                 CPORQ,PLCL,ES,DLP,TENV,QENV,TVEN,TVBAR,   &amp;<a name='1438'>
                 ZLCL,WKL,WABS,TRPPT,WSIGNE,DTLCL,GDT,     &amp;<a name='1439'>
                 <font color=#447700>!!ZLCL,WKL,WABS,TRPPT,WSIGNE,DTLCL,GDT,WLCL,&amp;<a name='1440'></font>
                 TVAVG,QESE,WTW,RHOLCL,AU0,VMFLCL,UPOLD,   &amp;<a name='1441'>
                 UPNEW,ABE,WKLCL,TTEMP,FRC1,   &amp;<a name='1442'>
                 QNEWIC,RL,R1,QNWFRZ,EFFQ,BE,BOTERM,ENTERM,&amp;<a name='1443'>
                 DZZ,UDLBE,REI,EE2,UD2,TTMP,F1,F2,         &amp;<a name='1444'>
                 THTTMP,QTMP,TMPLIQ,TMPICE,TU95,TU10,EE1,  &amp;<a name='1445'>
                 UD1,DPTT,QNEWLQ,DUMFDP,EE,TSAT,           &amp;<a name='1446'>
                 THTA,VCONV,TIMEC,SHSIGN,VWS,PEF, &amp;<a name='1447'>
                 CBH,RCBH,PEFCBH,PEFF,PEFF2,TDER,THTMIN,   &amp;<a name='1448'>
                 DTMLTD,QS,TADVEC,DPDD,FRC,DPT,RDD,A1,     &amp;<a name='1449'>
                 DSSDT,DTMP,T1RH,QSRH,PPTFLX,CPR,CNDTNF,   &amp;<a name='1450'>
                 UPDINC,AINCM2,DEVDMF,PPR,RCED,DPPTDF,     &amp;<a name='1451'>
                 DMFLFS,DMFLFS2,RCED2,DDINC,AINCMX,AINCM1, &amp;<a name='1452'>
                 AINC,TDER2,PPTFL2,FABE,STAB,DTT,DTT1,     &amp;<a name='1453'>
                 DTIME,TMA,TMB,TMM,BCOEFF,ACOEFF,QVDIFF,   &amp;<a name='1454'>
                 TOPOMG,CPM,DQ,ABEG,DABE,DFDA,FRC2,DR,     &amp;<a name='1455'>
                 UDFRC,TUC,QGS,RH0,RHG,QINIT,QFNL,ERR2,    &amp;<a name='1456'>
                 RELERR,RLC,RLS,RNC,FABEOLD,AINCOLD,UEFRC, &amp;<a name='1457'>
                 DDFRC,TDC,DEFRC,RHBAR,DMFFRC,DPMIN,DILBE<a name='1458'>
   REAL    ::    TIMEC_SHALL                               <font color=#447700>! Added by lkb, 10/31/10<a name='1459'></font>
   REAL    ::    ASTRT,TP,VALUE,AINTRP,TKEMAX,QFRZ,&amp;<a name='1460'>
                 QSS,PPTMLT,DTMELT,RHH,EVAC,BINC<a name='1461'>
<font color=#447700>!<a name='1462'></font>
      INTEGER :: INDLU,NU,NUCHM,NNN,KLFS<a name='1463'>
   REAL    :: CHMIN,PM15,CHMAX,DTRH,RAD,DPPP<a name='1464'>
   REAL    :: TVDIFF,DTTOT,ABSOMG,ABSOMGTC,FRDP<a name='1465'>
<a name='1466'>
      INTEGER :: KX,K,KL<a name='1467'>
<font color=#447700>!<a name='1468'></font>
      INTEGER :: NCHECK<a name='1469'>
      INTEGER, DIMENSION (kts:kte) :: KCHECK<a name='1470'>
<a name='1471'>
      INTEGER :: ISTOP,ML,L5,KMIX,LOW,                     &amp;<a name='1472'>
                 LC,MXLAYR,LLFC,NLAYRS,NK,                 &amp;<a name='1473'>
                 <font color=#447700>!KPBL,KLCL,LCL,LET,IFLAG,                  &amp;<a name='1474'></font>
                 KCLDLAYER,KLCL,LCL,LET,IFLAG,                  &amp;<a name='1475'>
                 NK1,LTOP,NJ,LTOP1,                        &amp;<a name='1476'>
                 LTOPM1,LVF,KSTART,KMIN,LFS,               &amp;<a name='1477'>
                 ND,NIC,LDB,LDT,ND1,NDK,                   &amp;<a name='1478'>
                 NM,LMAX,NCOUNT,NOITR,                     &amp;<a name='1479'>
                 NSTEP,NTC,NCHM,NSHALL<a name='1480'>
      LOGICAL :: IPRNT<a name='1481'>
      CHARACTER*1024 message<a name='1482'>
<a name='1483'>
      INTEGER :: ksvaa                                  <font color=#447700>! rce 11-may-2012<a name='1484'></font>
      REAL :: rho_act, tk_act, w_act, w_act_eff         <font color=#447700>! rce 11-may-2012<a name='1485'></font>
      REAL :: qndrop_tmp                                <font color=#447700>! rce 11-may-2012<a name='1486'></font>
      REAL :: tmpa, tmpb, tmpc, tmpd, tmpe, tmpf, tmpg, tmph, tmpi<a name='1487'>
      REAL :: tmp_alphabn, tmp_ebn, tmp_escale, tmp_lv  <font color=#447700>! rce 11-may-2012<a name='1488'></font>
      REAL :: tmp_deltarh, tmp_deltatk, tmp_deltatkfact <font color=#447700>! rce 11-may-2012<a name='1489'></font>
      REAL :: qndropbb(kts:kte)                         <font color=#447700>! rce 11-may-2012<a name='1490'></font>
<a name='1491'>
<font color=#447700>!<a name='1492'></font>
      DATA P00,T00/1.E5,273.16/<a name='1493'>
      DATA RLF/3.339E5/<a name='1494'>
      DATA RHIC,RHBC/1.,0.90/<a name='1495'>
      DATA PIE,TTFRZ,TBFRZ,C5/3.141592654,268.16,248.16,1.0723E-3/<a name='1496'>
      DATA RATE/0.03/<a name='1497'>
<a name='1498'>
<font color=#447700>!-----------------------------------------------------------<a name='1499'></font>
      IPRNT=.FALSE.<a name='1500'>
      GDRY=-G/CP<a name='1501'>
      ROCP=R/CP<a name='1502'>
      NSHALL = 0<a name='1503'>
      KL=kte<a name='1504'>
      KX=kte<a name='1505'>
<a name='1506'>
<font color=#447700>! rce 11-may-2012 mods start -------------------------------------------<a name='1507'></font>
      if (idiagee &gt; 0) IPRNT=.TRUE.<a name='1508'>
      updfra = 0.0<a name='1509'>
      wup = 0.0<a name='1510'>
      wulcl = 0.0<a name='1511'>
      wact = 0.0<a name='1512'>
      qndrop1d = 0.0<a name='1513'>
      qc1d = 0.0<a name='1514'>
      qi1d = 0.0<a name='1515'>
      fcvt_qc_to_qi = 0.0<a name='1516'>
      fcvt_qc_to_pr = 0.0<a name='1517'>
      fcvt_qi_to_pr = 0.0<a name='1518'>
      umfout = 0.0<a name='1519'>
      uerout = 0.0<a name='1520'>
      udrout = 0.0<a name='1521'>
      dmfout = 0.0<a name='1522'>
      derout = 0.0<a name='1523'>
      ddrout = 0.0<a name='1524'>
<font color=#447700>! rce 11-may-2012 mods end ---------------------------------------------<a name='1525'></font>
<a name='1526'>
<font color=#447700>!<a name='1527'></font>
<font color=#447700>!     ALIQ = 613.3<a name='1528'></font>
<font color=#447700>!     BLIQ = 17.502<a name='1529'></font>
<font color=#447700>!     CLIQ = 4780.8<a name='1530'></font>
<font color=#447700>!     DLIQ = 32.19<a name='1531'></font>
      ALIQ = SVP1*1000.<a name='1532'>
      BLIQ = SVP2<a name='1533'>
      CLIQ = SVP2*SVPT0<a name='1534'>
      DLIQ = SVP3<a name='1535'>
<font color=#447700>!<a name='1536'></font>
<font color=#447700>!<a name='1537'></font>
<font color=#447700>!****************************************************************************<a name='1538'></font>
<font color=#447700>!                                                      ! PPT FB MODS<a name='1539'></font>
<font color=#447700>!...OPTION TO FEED CONVECTIVELY GENERATED RAINWATER    ! PPT FB MODS<a name='1540'></font>
<font color=#447700>!...INTO GRID-RESOLVED RAINWATER (OR SNOW/GRAUPEL)     ! PPT FB MODS<a name='1541'></font>
<font color=#447700>!...FIELD.  "FBFRC" IS THE FRACTION OF AVAILABLE       ! PPT FB MODS<a name='1542'></font>
<font color=#447700>!...PRECIPITATION TO BE FED BACK (0.0 - 1.0)...        ! PPT FB MODS<a name='1543'></font>
      FBFRC=0.0                                        <font color=#447700>! PPT FB MODS<a name='1544'></font>
<font color=#447700>!...mods to allow shallow convection...<a name='1545'></font>
      NCHM = 0<a name='1546'>
      ISHALL = 0<a name='1547'>
      DPMIN = 5.E3<a name='1548'>
<font color=#447700>!...<a name='1549'></font>
      P300=P0(1)-30000.<a name='1550'>
<a name='1551'>
<font color=#447700>!... Set time constant for shallow convection<a name='1552'></font>
     TIMEC_SHALL = 1800.0                              <font color=#447700>! Set to the min value allowed for all convection<a name='1553'></font>
<a name='1554'>
<font color=#447700>!<a name='1555'></font>
<font color=#447700>!...PRESSURE PERTURBATION TERM IS ONLY DEFINED AT MID-POINT OF<a name='1556'></font>
<font color=#447700>!...VERTICAL LAYERS...SINCE TOTAL PRESSURE IS NEEDED AT THE TOP AND<a name='1557'></font>
<font color=#447700>!...BOTTOM OF LAYERS BELOW, DO AN INTERPOLATION...<a name='1558'></font>
<font color=#447700>!<a name='1559'></font>
<font color=#447700>!...INPUT A VERTICAL SOUNDING ... NOTE THAT MODEL LAYERS ARE NUMBERED<a name='1560'></font>
<font color=#447700>!...FROM BOTTOM-UP IN THE KF SCHEME...<a name='1561'></font>
<font color=#447700>!<a name='1562'></font>
      ML=0 <a name='1563'>
<font color=#447700>!SUE  tmprpsb=1./PSB(I,J)<a name='1564'></font>
<font color=#447700>!SUE  CELL=PTOP*tmprpsb<a name='1565'></font>
<font color=#447700>!<a name='1566'></font>
      DO K=1,KX<a name='1567'>
<font color=#447700>!<a name='1568'></font>
<font color=#447700>!...IF Q0 IS ABOVE SATURATION VALUE, REDUCE IT TO SATURATION LEVEL...<a name='1569'></font>
<font color=#447700>!<a name='1570'></font>
         ES=ALIQ*EXP((BLIQ*T0(K)-CLIQ)/(T0(K)-DLIQ))<a name='1571'>
         QES(K)=0.622*ES/(P0(K)-ES)<a name='1572'>
         Q0(K)=AMIN1(QES(K),QV0(K))<a name='1573'>
         Q0(K)=AMAX1(0.000001,Q0(K))<a name='1574'>
         QL0(K)=0.<a name='1575'>
         QI0(K)=0.<a name='1576'>
         QR0(K)=0.<a name='1577'>
         QS0(K)=0.<a name='1578'>
         RH(K) = Q0(K)/QES(K)<a name='1579'>
         DILFRC(K) = 1.<a name='1580'>
         TV0(K)=T0(K)*(1.+0.608*Q0(K))<a name='1581'>
<font color=#447700>!        RHOE(K)=P0(K)/(R*TV0(K))<a name='1582'></font>
<font color=#447700>!   DP IS THE PRESSURE INTERVAL BETWEEN FULL SIGMA LEVELS...<a name='1583'></font>
         DP(K)=rhoe(k)*g*DZQ(k)<a name='1584'>
<font color=#447700>! IF Turbulent Kinetic Energy (TKE) is available from turbulent mixing scheme<a name='1585'></font>
<font color=#447700>! use it for shallow convection...For now, assume it is not available....<a name='1586'></font>
<font color=#447700>!         TKE(K) = Q2(I,J,NK)<a name='1587'></font>
         TKE(K) = 0.<a name='1588'>
         CLDHGT(K) = 0.<a name='1589'>
<font color=#447700>!        IF(P0(K).GE.500E2)L5=K<a name='1590'></font>
         IF(P0(K).GE.0.5*P0(1))L5=K<a name='1591'>
         IF(P0(K).GE.P300)LLFC=K<a name='1592'>
         IF(T0(K).GT.T00)ML=K<a name='1593'>
      ENDDO<a name='1594'>
<font color=#447700>!<a name='1595'></font>
<font color=#447700>!...DZQ IS DZ BETWEEN SIGMA SURFACES, DZA IS DZ BETWEEN MODEL HALF LEVEL<a name='1596'></font>
        Z0(1)=.5*DZQ(1)<a name='1597'>
<font color=#447700>!cdir novector<a name='1598'></font>
        DO K=2,KL<a name='1599'>
          Z0(K)=Z0(K-1)+.5*(DZQ(K)+DZQ(K-1))<a name='1600'>
          DZA(K-1)=Z0(K)-Z0(K-1)<a name='1601'>
        ENDDO   <a name='1602'>
        DZA(KL)=0.<a name='1603'>
<font color=#447700>!<a name='1604'></font>
<font color=#447700>!<a name='1605'></font>
<font color=#447700>!  To save time, specify a pressure interval to move up in sequential<a name='1606'></font>
<font color=#447700>!  check of different ~50 mb deep groups of adjacent model layers in<a name='1607'></font>
<font color=#447700>!  the process of identifying updraft source layer (USL).  Note that <a name='1608'></font>
<font color=#447700>!  this search is terminated as soon as a buoyant parcel is found and <a name='1609'></font>
<font color=#447700>!  this parcel can produce a cloud greater than specifed minimum depth<a name='1610'></font>
<font color=#447700>!  (CHMIN)...For now, set interval at 15 mb...<a name='1611'></font>
<font color=#447700>!<a name='1612'></font>
       NCHECK = 1<a name='1613'>
       KCHECK(NCHECK)=1<a name='1614'>
       PM15 = P0(1)-15.E2<a name='1615'>
       DO K=2,LLFC<a name='1616'>
         IF(P0(K).LT.PM15)THEN<a name='1617'>
           NCHECK = NCHECK+1<a name='1618'>
           KCHECK(NCHECK) = K<a name='1619'>
           PM15 = PM15-15.E2<a name='1620'>
         ENDIF<a name='1621'>
       ENDDO<a name='1622'>
<font color=#447700>!<a name='1623'></font>
       NU=0<a name='1624'>
       NUCHM=0<a name='1625'>
usl:   DO<a name='1626'>
           NU = NU+1<a name='1627'>
           IF(NU.GT.NCHECK)THEN <a name='1628'>
             IF(ISHALL.EQ.1)THEN<a name='1629'>
               CHMAX = 0.<a name='1630'>
               NCHM = 0<a name='1631'>
               DO NK = 1,NCHECK<a name='1632'>
                 NNN=KCHECK(NK)<a name='1633'>
                 IF(CLDHGT(NNN).GT.CHMAX)THEN<a name='1634'>
                   NCHM = NNN<a name='1635'>
                   NUCHM = NK<a name='1636'>
                   CHMAX = CLDHGT(NNN)<a name='1637'>
                 ENDIF<a name='1638'>
               ENDDO<a name='1639'>
               NU = NUCHM-1<a name='1640'>
               FBFRC=1.<a name='1641'>
               CYCLE usl<a name='1642'>
             ELSE<a name='1643'>
<font color=#447700>! wig, 29-Aug-2006: I think this is where no convecion occurs. So, force<a name='1644'></font>
<font color=#447700>! ishall to a flag value to indicate this for accounting purposes.<a name='1645'></font>
                ishall = 2<a name='1646'>
               RETURN<a name='1647'>
             ENDIF<a name='1648'>
           ENDIF      <a name='1649'>
           KMIX = KCHECK(NU)<a name='1650'>
           LOW=KMIX<a name='1651'>
<font color=#447700>!...<a name='1652'></font>
           LC = LOW<a name='1653'>
<font color=#447700>!<a name='1654'></font>
<font color=#447700>!...ASSUME THAT IN ORDER TO SUPPORT A DEEP UPDRAFT YOU NEED A LAYER OF<a name='1655'></font>
<font color=#447700>!...UNSTABLE AIR AT LEAST 50 mb DEEP...TO APPROXIMATE THIS, ISOLATE A<a name='1656'></font>
<font color=#447700>!...GROUP OF ADJACENT INDIVIDUAL MODEL LAYERS, WITH THE BASE AT LEVEL<a name='1657'></font>
<font color=#447700>!...LC, SUCH THAT THE COMBINED DEPTH OF THESE LAYERS IS AT LEAST 50 mb..<a name='1658'></font>
<font color=#447700>!   <a name='1659'></font>
           NLAYRS=0<a name='1660'>
           DPTHMX=0.<a name='1661'>
           NK=LC-1<a name='1662'>
           IF ( NK+1 .LT. KTS ) THEN<a name='1663'>
             WRITE(message,*)'WOULD GO OFF BOTTOM: KF_CUP_PARA I,J,NK',I,J,NK<a name='1664'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_628"> (TRIM(message)) <a name='1665'>
           ELSE<a name='1666'>
             DO <a name='1667'>
               NK=NK+1   <a name='1668'>
               IF ( NK .GT. KTE ) THEN<a name='1669'>
                 WRITE(message,*) &amp;<a name='1670'>
                     'WOULD GO OFF TOP: KF_CUP_PARA I,J,DPTHMX,DPMIN',I,J,DPTHMX,DPMIN<a name='1671'>
                 CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_629"> (TRIM(message))<a name='1672'>
                 EXIT<a name='1673'>
               ENDIF<a name='1674'>
               DPTHMX=DPTHMX+DP(NK)<a name='1675'>
               NLAYRS=NLAYRS+1<a name='1676'>
               IF(DPTHMX.GT.DPMIN)THEN<a name='1677'>
                 EXIT <a name='1678'>
               ENDIF<a name='1679'>
             END DO    <a name='1680'>
           ENDIF<a name='1681'>
           IF(DPTHMX.LT.DPMIN)THEN<a name='1682'>
<font color=#447700>! wig, 29-Aug-2006: Indicate no convection occurred in ishall.<a name='1683'></font>
              ishall = 2<a name='1684'>
             RETURN<a name='1685'>
           ENDIF<a name='1686'>
           <font color=#447700>!!KPBL=LC+NLAYRS-1   <a name='1687'></font>
           KCLDLAYER=LC+NLAYRS-1       <font color=#447700>! Added new veriable for top of cloud layer <a name='1688'></font>
           <font color=#447700>!!if(ishall .eq. 0) KPBL=LC !lkb, changed to only adjust mixed layer depth for deep convection  <a name='1689'></font>
<font color=#447700>!<a name='1690'></font>
<font color=#447700>!...********************************************************<a name='1691'></font>
<font color=#447700>!...for computational simplicity without much loss in accuracy,<a name='1692'></font>
<font color=#447700>!...mix temperature instead of theta for evaluating convective<a name='1693'></font>
<font color=#447700>!...initiation (triggering) potential...<a name='1694'></font>
<font color=#447700>!          THMIX=0.<a name='1695'></font>
           TMIX=0.<a name='1696'>
           QMIX=0.<a name='1697'>
           ZMIX=0.<a name='1698'>
           PMIX=0.<a name='1699'>
<font color=#447700>!<a name='1700'></font>
<font color=#447700>!...FIND THE THERMODYNAMIC CHARACTERISTICS OF THE LAYER BY<a name='1701'></font>
<font color=#447700>!...MASS-WEIGHTING THE CHARACTERISTICS OF THE INDIVIDUAL MODEL<a name='1702'></font>
<font color=#447700>!...LAYERS...<a name='1703'></font>
<font color=#447700>!<a name='1704'></font>
<font color=#447700>!cdir novector<a name='1705'></font>
           <font color=#447700>!!DO NK=LC,KPBL<a name='1706'></font>
           DO NK=LC,KCLDLAYER<a name='1707'>
             TMIX=TMIX+DP(NK)*T0(NK)<a name='1708'>
             QMIX=QMIX+DP(NK)*Q0(NK)<a name='1709'>
             ZMIX=ZMIX+DP(NK)*Z0(NK)<a name='1710'>
             PMIX=PMIX+DP(NK)*P0(NK)<a name='1711'>
           ENDDO   <a name='1712'>
<font color=#447700>!         THMIX=THMIX/DPTHMX<a name='1713'></font>
          TMIX=TMIX/DPTHMX<a name='1714'>
          QMIX=QMIX/DPTHMX<a name='1715'>
          ZMIX=ZMIX/DPTHMX<a name='1716'>
          PMIX=PMIX/DPTHMX<a name='1717'>
          EMIX=QMIX*PMIX/(0.622+QMIX)<a name='1718'>
<font color=#447700>!<a name='1719'></font>
<font color=#447700>!...FIND THE TEMPERATURE OF THE MIXTURE AT ITS LCL...<a name='1720'></font>
<font color=#447700>!<a name='1721'></font>
<font color=#447700>!        TLOG=ALOG(EMIX/ALIQ)<a name='1722'></font>
<font color=#447700>! ...calculate dewpoint using lookup table...<a name='1723'></font>
<font color=#447700>!<a name='1724'></font>
          astrt=1.e-3<a name='1725'>
          ainc=0.075<a name='1726'>
          a1=emix/aliq<a name='1727'>
          tp=(a1-astrt)/ainc<a name='1728'>
          indlu=int(tp)+1<a name='1729'>
          value=(indlu-1)*ainc+astrt<a name='1730'>
          aintrp=(a1-value)/ainc<a name='1731'>
          tlog=aintrp*alu(indlu+1)+(1-aintrp)*alu(indlu)<a name='1732'>
          TDPT=(CLIQ-DLIQ*TLOG)/(BLIQ-TLOG)<a name='1733'>
          TLCL=TDPT-(.212+1.571E-3*(TDPT-T00)-4.36E-4*(TMIX-T00))*(TMIX-TDPT)<a name='1734'>
          TLCL=AMIN1(TLCL,TMIX)<a name='1735'>
          TVLCL=TLCL*(1.+0.608*QMIX)<a name='1736'>
          ZLCL = ZMIX+(TLCL-TMIX)/GDRY<a name='1737'>
          NK = LC-1<a name='1738'>
          DO <a name='1739'>
            NK = NK+1<a name='1740'>
            KLCL=NK<a name='1741'>
            IF(ZLCL.LE.Z0(NK) .or. NK.GT.KL)THEN<a name='1742'>
              EXIT<a name='1743'>
            ENDIF <a name='1744'>
          ENDDO   <a name='1745'>
          IF(NK.GT.KL)THEN<a name='1746'>
<font color=#447700>! wig, 29-Aug-2006: Indicate no convection occurred.<a name='1747'></font>
             ishall = 2<a name='1748'>
            RETURN  <a name='1749'>
          ENDIF<a name='1750'>
          K=KLCL-1<a name='1751'>
          DLP=(ZLCL-Z0(K))/(Z0(KLCL)-Z0(K))<a name='1752'>
<font color=#447700>!     <a name='1753'></font>
<font color=#447700>!...ESTIMATE ENVIRONMENTAL TEMPERATURE AND MIXING RATIO AT THE LCL...<a name='1754'></font>
<font color=#447700>!     <a name='1755'></font>
          TENV=T0(K)+(T0(KLCL)-T0(K))*DLP<a name='1756'>
          QENV=Q0(K)+(Q0(KLCL)-Q0(K))*DLP<a name='1757'>
          TVEN=TENV*(1.+0.608*QENV)<a name='1758'>
<font color=#447700>!     <a name='1759'></font>
<font color=#447700>!...CHECK TO SEE IF CLOUD IS BUOYANT USING FRITSCH-CHAPPELL TRIGGER<a name='1760'></font>
<font color=#447700>!...FUNCTION DESCRIBED IN KAIN AND FRITSCH (1992)...W0 IS AN<a name='1761'></font>
<font color=#447700>!...APROXIMATE VALUE FOR THE RUNNING-MEAN GRID-SCALE VERTICAL<a name='1762'></font>
<font color=#447700>!...VELOCITY, WHICH GIVES SMOOTHER FIELDS OF CONVECTIVE INITIATION<a name='1763'></font>
<font color=#447700>!...THAN THE INSTANTANEOUS VALUE...FORMULA RELATING TEMPERATURE<a name='1764'></font>
<font color=#447700>!...PERTURBATION TO VERTICAL VELOCITY HAS BEEN USED WITH THE MOST<a name='1765'></font>
<font color=#447700>!...SUCCESS AT GRID LENGTHS NEAR 25 km.  FOR DIFFERENT GRID-LENGTHS,<a name='1766'></font>
<font color=#447700>!...ADJUST VERTICAL VELOCITY TO EQUIVALENT VALUE FOR 25 KM GRID<a name='1767'></font>
<font color=#447700>!...LENGTH, ASSUMING LINEAR DEPENDENCE OF W ON GRID LENGTH...<a name='1768'></font>
          IF(ZLCL.LT.2.E3)THEN<a name='1769'>
            WKLCL=0.02*ZLCL/2.E3<a name='1770'>
          ELSE<a name='1771'>
            WKLCL=0.02<a name='1772'>
          ENDIF<a name='1773'>
          WKL=(W0AVG1D(K)+(W0AVG1D(KLCL)-W0AVG1D(K))*DLP)*DX/25.E3-WKLCL<a name='1774'>
<a name='1775'>
<font color=#447700>! CuP, wig, 28-Aug-2006, begin:<a name='1776'></font>
<font color=#447700>!<a name='1777'></font>
<font color=#447700>! Replace KF perturbation temperatures with CuP perturbations. CuP<a name='1778'></font>
<font color=#447700>! perturbations are in potential temp. so convert the theta difference<a name='1779'></font>
<font color=#447700>! to a temperature difference. For the moisture perturbation, convert<a name='1780'></font>
<font color=#447700>! the CuP mixing ratio (kg/kg) into a virtual temperature adjustment.<a name='1781'></font>
<font color=#447700>!<a name='1782'></font>
<font color=#447700>! Standard KF way...<a name='1783'></font>
          if( .not. cupflag ) then<a name='1784'>
             IF(WKL.LT.0.0001)THEN<a name='1785'>
                DTLCL=0.<a name='1786'>
             ELSE <a name='1787'>
                DTLCL=4.64*WKL**0.33<a name='1788'>
             ENDIF<a name='1789'>
             DTRH = 0. <font color=#447700>!CuP, wig: Move this from a few lines below since<a name='1790'></font>
                       <font color=#447700>!          it is commented out there for CuP.<a name='1791'></font>
          else<a name='1792'>
<font color=#447700>! New CuP way...<a name='1793'></font>
             PLCL=P0(K)+(P0(KLCL)-P0(K))*DLP<a name='1794'>
             dtlcl = th_perturb*(p00/p0(k))**rocp<a name='1795'>
             dtrh = 0.608*r_perturb<a name='1796'>
          end if<a name='1797'>
<font color=#447700>! wig: end<a name='1798'></font>
<a name='1799'>
<font color=#447700>!<a name='1800'></font>
<font color=#447700>!...for ETA model, give parcel an extra temperature perturbation based<a name='1801'></font>
<font color=#447700>!...the threshold RH for condensation (U00)...<a name='1802'></font>
<font color=#447700>!<a name='1803'></font>
<font color=#447700>!...for now, just assume U00=0.75...<a name='1804'></font>
<font color=#447700>!...!!!!!! for MM5, SET DTRH = 0. !!!!!!!!<a name='1805'></font>
<font color=#447700>!         U00 = 0.75<a name='1806'></font>
<font color=#447700>!         IF(U00.lt.1.)THEN<a name='1807'></font>
<font color=#447700>!           QSLCL=QES(K)+(QES(KLCL)-QES(K))*DLP<a name='1808'></font>
<font color=#447700>!           RHLCL = QENV/QSLCL<a name='1809'></font>
<font color=#447700>!           DQSSDT = QMIX*(CLIQ-BLIQ*DLIQ)/((TLCL-DLIQ)*(TLCL-DLIQ))<a name='1810'></font>
<font color=#447700>!           IF(RHLCL.ge.0.75 .and. RHLCL.le.0.95)then<a name='1811'></font>
<font color=#447700>!             DTRH = 0.25*(RHLCL-0.75)*QMIX/DQSSDT<a name='1812'></font>
<font color=#447700>!           ELSEIF(RHLCL.GT.0.95)THEN<a name='1813'></font>
<font color=#447700>!             DTRH = (1./RHLCL-1.)*QMIX/DQSSDT<a name='1814'></font>
<font color=#447700>!           ELSE<a name='1815'></font>
<font color=#447700>!!$wig, 28-Aug-2006               DTRH = 0.<a name='1816'></font>
<font color=#447700>!           ENDIF<a name='1817'></font>
<font color=#447700>!         ENDIF   <a name='1818'></font>
<font color=#447700>!         IF(ISHALL.EQ.1)IPRNT=.TRUE.<a name='1819'></font>
<font color=#447700>!         IPRNT=.TRUE.<a name='1820'></font>
<font color=#447700>!         IF(TLCL+DTLCL.GT.TENV)GOTO 45<a name='1821'></font>
<font color=#447700>!<a name='1822'></font>
<a name='1823'>
<font color=#447700>! CuP, wig 28-Aug-2006, begin: Change parcel temperature adjustment<a name='1824'></font>
<font color=#447700>! comparison to use virtual temperature instead of "normal"<a name='1825'></font>
<font color=#447700>! temperature...<a name='1826'></font>
<font color=#447700>!~Check to see if this should be switched back if cupflag==F. Why isn't<a name='1827'></font>
<font color=#447700>! the virt. temp. used in the standard scheme?<a name='1828'></font>
<font color=#447700>!!$trigger:  IF(TLCL+DTLCL+DTRH.LT.TENV)THEN   <a name='1829'></font>
          TVLCL=TLCL*(1.+0.608*QMIX)<a name='1830'>
trigger:  if( tvlcl+dtlcl+dtrh &lt; tven ) then<a name='1831'>
<font color=#447700>! wig: end<a name='1832'></font>
<a name='1833'>
<font color=#447700>!<a name='1834'></font>
<font color=#447700>! Parcel not buoyant, CYCLE back to start of trigger and evaluate next potential USL...<a name='1835'></font>
<font color=#447700>!<a name='1836'></font>
            CYCLE usl<a name='1837'>
<font color=#447700>!<a name='1838'></font>
          ELSE                            <font color=#447700>! Parcel is buoyant, determine updraft<a name='1839'></font>
<font color=#447700>!     <a name='1840'></font>
<font color=#447700>!...CONVECTIVE TRIGGERING CRITERIA HAS BEEN SATISFIED...COMPUTE<a name='1841'></font>
<font color=#447700>!...EQUIVALENT POTENTIAL TEMPERATURE<a name='1842'></font>
<font color=#447700>!...(THETEU) AND VERTICAL VELOCITY OF THE RISING PARCEL AT THE LCL...<a name='1843'></font>
<font color=#447700>!     <a name='1844'></font>
            CALL <A href='../../html_code/phys/module_cu_mskf.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_5">(PMIX,TMIX,QMIX,THETEU(K),ALIQ,BLIQ,CLIQ,DLIQ)<a name='1845'>
<font color=#447700>!<a name='1846'></font>
<font color=#447700>!...modify calculation of initial parcel vertical velocity...jsk 11/26/97<a name='1847'></font>
<font color=#447700>!<a name='1848'></font>
<font color=#447700>! CuP, wig 28-Aug-2006: The original KF algorithm sets the parcel's<a name='1849'></font>
<font color=#447700>! initial pert. vertical velocity at the LCL based on the pert.<a name='1850'></font>
<font color=#447700>! temperature, with a minimum W of 3. But, if the pert. temp. is<a name='1851'></font>
<font color=#447700>! negative, a smaller minimum positive W is set (==1). For CuP,<a name='1852'></font>
<font color=#447700>! allow the perturbation to set the W without any constraints<a name='1853'></font>
<font color=#447700>! except that the pert. must be positive.<a name='1854'></font>
            DTTOT = DTLCL+DTRH<a name='1855'>
            IF(DTTOT.GT.1.E-4)THEN<a name='1856'>
              GDT=2.*G*DTTOT*500./TVEN<a name='1857'>
              WLCL=1.+0.5*SQRT(GDT)<a name='1858'>
              if( .not. cupflag ) WLCL = AMIN1(WLCL,3.) <font color=#447700>!wig 9-Oct-2006<a name='1859'></font>
            ELSE<a name='1860'>
              if( cupflag ) then<a name='1861'>
                 wlcl = 0.<a name='1862'>
              else<a name='1863'>
                 WLCL=1.<a name='1864'>
              end if<a name='1865'>
            ENDIF<a name='1866'>
<font color=#447700>!print*,'~    dttot and wlcl=',dttot,wlcl<a name='1867'></font>
<font color=#447700>! wig: end<a name='1868'></font>
            PLCL=P0(K)+(P0(KLCL)-P0(K))*DLP<a name='1869'>
            WTW=WLCL*WLCL<a name='1870'>
<font color=#447700>!<a name='1871'></font>
            TVLCL=TLCL*(1.+0.608*QMIX)<a name='1872'>
            RHOLCL=PLCL/(R*TVLCL)<a name='1873'>
<font color=#447700>!        <a name='1874'></font>
            LCL=KLCL<a name='1875'>
            LET=LCL<a name='1876'>
<font color=#447700>! make RAD a function of background vertical velocity...<a name='1877'></font>
            IF(WKL.LT.0.)THEN<a name='1878'>
              RAD = 1000.<a name='1879'>
            ELSEIF(WKL.GT.0.1)THEN<a name='1880'>
              RAD = 2000.<a name='1881'>
            ELSE<a name='1882'>
              RAD = 1000.+1000*WKL/0.1<a name='1883'>
            ENDIF<a name='1884'>
<font color=#447700>!     <a name='1885'></font>
<font color=#447700>!*******************************************************************<a name='1886'></font>
<font color=#447700>!                                                                  *<a name='1887'></font>
<font color=#447700>!                 COMPUTE UPDRAFT PROPERTIES                       *<a name='1888'></font>
<font color=#447700>!                                                                  *<a name='1889'></font>
<font color=#447700>!*******************************************************************<a name='1890'></font>
<font color=#447700>!     <a name='1891'></font>
<font color=#447700>!     <a name='1892'></font>
<font color=#447700>!...<a name='1893'></font>
<font color=#447700>!...ESTIMATE INITIAL UPDRAFT MASS FLUX (UMF(K))...<a name='1894'></font>
<font color=#447700>!     <a name='1895'></font>
            WU(K)=WLCL<a name='1896'>
            AU0=0.01*DXSQ<a name='1897'>
            UMF(K)=RHOLCL*AU0<a name='1898'>
            <font color=#447700>!!UMF(K)=freq*dxsq*WU(K)*RHOLCL  ! Added by lkb<a name='1899'></font>
            VMFLCL=UMF(K)<a name='1900'>
            UPOLD=VMFLCL<a name='1901'>
            UPNEW=UPOLD<a name='1902'>
            ksvaa = k  <font color=#447700>! rce 11-may-2012<a name='1903'></font>
<font color=#447700>!     <a name='1904'></font>
<font color=#447700>!...RATIO2 IS THE DEGREE OF GLACIATION IN THE CLOUD (0 TO 1),<a name='1905'></font>
<font color=#447700>!...UER IS THE ENVIR ENTRAINMENT RATE, ABE IS AVAILABLE<a name='1906'></font>
<font color=#447700>!...BUOYANT ENERGY, TRPPT IS THE TOTAL RATE OF PRECIPITATION<a name='1907'></font>
<font color=#447700>!...PRODUCTION...<a name='1908'></font>
<font color=#447700>!     <a name='1909'></font>
            RATIO2(K)=0.<a name='1910'>
            UER(K)=0.<a name='1911'>
            ABE=0.<a name='1912'>
            TRPPT=0.<a name='1913'>
            TU(K)=TLCL<a name='1914'>
            TVU(K)=TVLCL<a name='1915'>
            QU(K)=QMIX<a name='1916'>
            EQFRC(K)=1.<a name='1917'>
            QLIQ(K)=0.<a name='1918'>
            QICE(K)=0.<a name='1919'>
            QLQOUT(K)=0.<a name='1920'>
            QICOUT(K)=0.<a name='1921'>
            DETLQ(K)=0.<a name='1922'>
            DETIC(K)=0.<a name='1923'>
            PPTLIQ(K)=0.<a name='1924'>
            PPTICE(K)=0.<a name='1925'>
            IFLAG=0<a name='1926'>
<font color=#447700>!     <a name='1927'></font>
<font color=#447700>!...TTEMP IS USED DURING CALCULATION OF THE LINEAR GLACIATION<a name='1928'></font>
<font color=#447700>!...PROCESS; IT IS INITIALLY SET TO THE TEMPERATURE AT WHICH<a name='1929'></font>
<font color=#447700>!...FREEZING IS SPECIFIED TO BEGIN.  WITHIN THE GLACIATION<a name='1930'></font>
<font color=#447700>!...INTERVAL, IT IS SET EQUAL TO THE UPDRAFT TEMP AT THE<a name='1931'></font>
<font color=#447700>!...PREVIOUS MODEL LEVEL...<a name='1932'></font>
<font color=#447700>!     <a name='1933'></font>
            TTEMP=TTFRZ<a name='1934'>
<font color=#447700>!     <a name='1935'></font>
<font color=#447700>!...ENTER THE LOOP FOR UPDRAFT CALCULATIONS...CALCULATE UPDRAFT TEMP,<a name='1936'></font>
<font color=#447700>!...MIXING RATIO, VERTICAL MASS FLUX, LATERAL DETRAINMENT OF MASS AND<a name='1937'></font>
<font color=#447700>!...MOISTURE, PRECIPITATION RATES AT EACH MODEL LEVEL...<a name='1938'></font>
<font color=#447700>!     <a name='1939'></font>
<font color=#447700>!     <a name='1940'></font>
            EE1=1.<a name='1941'>
            UD1=0.<a name='1942'>
            REI = 0.<a name='1943'>
            DILBE = 0.<a name='1944'>
            qndropbb(:) = 0.0  <font color=#447700>! rce 11-may-2012<a name='1945'></font>
<a name='1946'>
updraft:    DO NK=K,KL-1<a name='1947'>
              NK1=NK+1<a name='1948'>
              RATIO2(NK1)=RATIO2(NK)<a name='1949'>
              FRC1=0.<a name='1950'>
              TU(NK1)=T0(NK1)<a name='1951'>
              THETEU(NK1)=THETEU(NK)<a name='1952'>
              QU(NK1)=QU(NK)<a name='1953'>
              QLIQ(NK1)=QLIQ(NK)<a name='1954'>
              QICE(NK1)=QICE(NK)<a name='1955'>
              call <A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2'>tpmix2</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2_1">(p0(nk1),theteu(nk1),tu(nk1),qu(nk1),qliq(nk1),        &amp;<a name='1956'>
                     qice(nk1),qnewlq,qnewic,XLV1,XLV0)<a name='1957'>
<font color=#447700>!<a name='1958'></font>
<font color=#447700>!<a name='1959'></font>
<font color=#447700>!...CHECK TO SEE IF UPDRAFT TEMP IS ABOVE THE TEMPERATURE AT WHICH<a name='1960'></font>
<font color=#447700>!...GLACIATION IS ASSUMED TO INITIATE; IF IT IS, CALCULATE THE<a name='1961'></font>
<font color=#447700>!...FRACTION OF REMAINING LIQUID WATER TO FREEZE...TTFRZ IS THE<a name='1962'></font>
<font color=#447700>!...TEMP AT WHICH FREEZING BEGINS, TBFRZ THE TEMP BELOW WHICH ALL<a name='1963'></font>
<font color=#447700>!...LIQUID WATER IS FROZEN AT EACH LEVEL...<a name='1964'></font>
<font color=#447700>!<a name='1965'></font>
              IF(TU(NK1).LE.TTFRZ)THEN<a name='1966'>
                IF(TU(NK1).GT.TBFRZ)THEN<a name='1967'>
                  IF(TTEMP.GT.TTFRZ)TTEMP=TTFRZ<a name='1968'>
                  FRC1=(TTEMP-TU(NK1))/(TTEMP-TBFRZ)<a name='1969'>
                ELSE<a name='1970'>
                  FRC1=1.<a name='1971'>
                  IFLAG=1<a name='1972'>
                ENDIF<a name='1973'>
                TTEMP=TU(NK1)<a name='1974'>
<font color=#447700>!<a name='1975'></font>
<font color=#447700>!  DETERMINE THE EFFECTS OF LIQUID WATER FREEZING WHEN TEMPERATURE<a name='1976'></font>
<font color=#447700>!...IS BELOW TTFRZ...<a name='1977'></font>
<font color=#447700>!<a name='1978'></font>
                <font color=#447700>! rce 11-may-2012 - added lines with tmpa/c and fcvt_qc_to_qi<a name='1979'></font>
                tmpa = max( 0.0, qliq(nk1)+qnewlq ) <font color=#447700>! qliq before freezing calc<a name='1980'></font>
                QFRZ = (QLIQ(NK1)+QNEWLQ)*FRC1<a name='1981'>
                QNEWIC=QNEWIC+QNEWLQ*FRC1<a name='1982'>
                QNEWLQ=QNEWLQ-QNEWLQ*FRC1<a name='1983'>
                QICE(NK1) = QICE(NK1)+QLIQ(NK1)*FRC1<a name='1984'>
                QLIQ(NK1) = QLIQ(NK1)-QLIQ(NK1)*FRC1<a name='1985'>
                tmpc = max( 0.0, qliq(nk1)+qnewlq ) <font color=#447700>! qliq after  freezing calc<a name='1986'></font>
                fcvt_qc_to_qi(nk1) = max( 0.0, tmpa-tmpc ) / max( 1.0e-10, tmpa )<a name='1987'>
                CALL <A href='../../html_code/phys/module_cu_mskf.F.html#DTFRZNEW'>DTFRZNEW</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DTFRZNEW_2">(TU(NK1),P0(NK1),THETEU(NK1),QU(NK1),QFRZ,         &amp;<a name='1988'>
                          QICE(NK1),ALIQ,BLIQ,CLIQ,DLIQ)<a name='1989'>
              ENDIF<a name='1990'>
              TVU(NK1)=TU(NK1)*(1.+0.608*QU(NK1))<a name='1991'>
<font color=#447700>!<a name='1992'></font>
<font color=#447700>!  CALCULATE UPDRAFT VERTICAL VELOCITY AND PRECIPITATION FALLOUT...<a name='1993'></font>
<font color=#447700>!<a name='1994'></font>
              IF(NK.EQ.K)THEN<a name='1995'>
                BE=(TVLCL+TVU(NK1))/(TVEN+TV0(NK1))-1.<a name='1996'>
                BOTERM=2.*(Z0(NK1)-ZLCL)*G*BE/1.5<a name='1997'>
                DZZ=Z0(NK1)-ZLCL<a name='1998'>
              ELSE<a name='1999'>
                BE=(TVU(NK)+TVU(NK1))/(TV0(NK)+TV0(NK1))-1.<a name='2000'>
                BOTERM=2.*DZA(NK)*G*BE/1.5<a name='2001'>
                DZZ=DZA(NK)<a name='2002'>
              ENDIF<a name='2003'>
              ENTERM=2.*REI*WTW/UPOLD<a name='2004'>
<a name='2005'>
              <font color=#447700>! rce 11-may-2012 - added lines with tmpa/b/c and fcvt_q?_to_pr<a name='2006'></font>
              tmpa = max( 0.0, qliq(nk1)+qnewlq ) <font color=#447700>! qliq before precip calc<a name='2007'></font>
              tmpb = max( 0.0, qice(nk1)+qnewic ) <font color=#447700>! qice before precip calc<a name='2008'></font>
              CALL <A href='../../html_code/phys/module_cu_mskf.F.html#CONDLOAD'>CONDLOAD</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDLOAD_2">(QLIQ(NK1),QICE(NK1),WTW,DZZ,BOTERM,ENTERM,      &amp;<a name='2009'>
                        RATE,QNEWLQ,QNEWIC,QLQOUT(NK1),QICOUT(NK1),G)<a name='2010'>
              tmpc = max( 0.0, qliq(nk1)+qnewlq ) <font color=#447700>! qliq after  precip calc<a name='2011'></font>
              fcvt_qc_to_pr(nk1) = max( 0.0, tmpa-tmpc ) / max( 1.0e-10, tmpa )<a name='2012'>
              tmpc = max( 0.0, qice(nk1)+qnewic ) <font color=#447700>! qice after  precip calc<a name='2013'></font>
              fcvt_qi_to_pr(nk1) = max( 0.0, tmpb-tmpc ) / max( 1.0e-10, tmpb )<a name='2014'>
<a name='2015'>
<font color=#447700>!<a name='2016'></font>
<font color=#447700>!...IF VERT VELOCITY IS LESS THAN ZERO, EXIT THE UPDRAFT LOOP AND,<a name='2017'></font>
<font color=#447700>!...IF CLOUD IS TALL ENOUGH, FINALIZE UPDRAFT CALCULATIONS...<a name='2018'></font>
<font color=#447700>!<a name='2019'></font>
              IF(WTW.LT.1.E-3)THEN<a name='2020'>
                EXIT<a name='2021'>
              ELSE<a name='2022'>
                WU(NK1)=SQRT(WTW)<a name='2023'>
              ENDIF<a name='2024'>
<font color=#447700>!...Calculate value of THETA-E in environment to entrain into updraft...<a name='2025'></font>
<font color=#447700>!<a name='2026'></font>
              CALL <A href='../../html_code/phys/module_cu_mskf.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_6">(P0(NK1),T0(NK1),Q0(NK1),THETEE(NK1),ALIQ,BLIQ,CLIQ,DLIQ)<a name='2027'>
<font color=#447700>!<a name='2028'></font>
<font color=#447700>!...REI IS THE RATE OF ENVIRONMENTAL INFLOW...<a name='2029'></font>
<font color=#447700>!<a name='2030'></font>
              REI=VMFLCL*DP(NK1)*0.03/RAD<a name='2031'>
              TVQU(NK1)=TU(NK1)*(1.+0.608*QU(NK1)-QLIQ(NK1)-QICE(NK1))<a name='2032'>
              IF(NK.EQ.K)THEN<a name='2033'>
                DILBE=((TVLCL+TVQU(NK1))/(TVEN+TV0(NK1))-1.)*DZZ<a name='2034'>
              ELSE<a name='2035'>
                DILBE=((TVQU(NK)+TVQU(NK1))/(TV0(NK)+TV0(NK1))-1.)*DZZ<a name='2036'>
              ENDIF<a name='2037'>
              IF(DILBE.GT.0.)ABE=ABE+DILBE*G<a name='2038'>
<font color=#447700>!<a name='2039'></font>
<font color=#447700>!...IF CLOUD PARCELS ARE VIRTUALLY COLDER THAN THE ENVIRONMENT, MINIMAL <a name='2040'></font>
<font color=#447700>!...ENTRAINMENT (0.5*REI) IS IMPOSED...<a name='2041'></font>
<font color=#447700>!<a name='2042'></font>
              IF(TVQU(NK1).LE.TV0(NK1))THEN    <font color=#447700>! Entrain/Detrain IF BLOCK<a name='2043'></font>
                EE2=0.5<a name='2044'>
                UD2=1.<a name='2045'>
                EQFRC(NK1)=0.<a name='2046'>
              ELSE<a name='2047'>
                LET=NK1<a name='2048'>
                TTMP=TVQU(NK1)<a name='2049'>
<font color=#447700>!<a name='2050'></font>
<font color=#447700>!...DETERMINE THE CRITICAL MIXED FRACTION OF UPDRAFT AND ENVIRONMENTAL AIR...<a name='2051'></font>
<font color=#447700>!<a name='2052'></font>
                F1=0.95<a name='2053'>
                F2=1.-F1<a name='2054'>
                THTTMP=F1*THETEE(NK1)+F2*THETEU(NK1)<a name='2055'>
                QTMP=F1*Q0(NK1)+F2*QU(NK1)<a name='2056'>
                TMPLIQ=F2*QLIQ(NK1)<a name='2057'>
                TMPICE=F2*QICE(NK1)<a name='2058'>
                call <A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2'>tpmix2</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2_2">(p0(nk1),thttmp,ttmp,qtmp,tmpliq,tmpice,        &amp;<a name='2059'>
                           qnewlq,qnewic,XLV1,XLV0)<a name='2060'>
                TU95=TTMP*(1.+0.608*QTMP-TMPLIQ-TMPICE)<a name='2061'>
                IF(TU95.GT.TV0(NK1))THEN<a name='2062'>
                  EE2=1.<a name='2063'>
                  UD2=0.<a name='2064'>
                  EQFRC(NK1)=1.0<a name='2065'>
                ELSE<a name='2066'>
                  F1=0.10<a name='2067'>
                  F2=1.-F1<a name='2068'>
                  THTTMP=F1*THETEE(NK1)+F2*THETEU(NK1)<a name='2069'>
                  QTMP=F1*Q0(NK1)+F2*QU(NK1)<a name='2070'>
                  TMPLIQ=F2*QLIQ(NK1)<a name='2071'>
                  TMPICE=F2*QICE(NK1)<a name='2072'>
                  call <A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2'>tpmix2</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2_3">(p0(nk1),thttmp,ttmp,qtmp,tmpliq,tmpice,        &amp;<a name='2073'>
                               qnewlq,qnewic,XLV1,XLV0)<a name='2074'>
                  TU10=TTMP*(1.+0.608*QTMP-TMPLIQ-TMPICE)<a name='2075'>
                  TVDIFF = ABS(TU10-TVQU(NK1))<a name='2076'>
                  IF(TVDIFF.LT.1.e-3)THEN<a name='2077'>
                    EE2=1.<a name='2078'>
                    UD2=0.<a name='2079'>
                    EQFRC(NK1)=1.0<a name='2080'>
                  ELSE<a name='2081'>
                    EQFRC(NK1)=(TV0(NK1)-TVQU(NK1))*F1/(TU10-TVQU(NK1))<a name='2082'>
                    EQFRC(NK1)=AMAX1(0.0,EQFRC(NK1))<a name='2083'>
                    EQFRC(NK1)=AMIN1(1.0,EQFRC(NK1))<a name='2084'>
                    IF(EQFRC(NK1).EQ.1)THEN<a name='2085'>
                      EE2=1.<a name='2086'>
                      UD2=0.<a name='2087'>
                    ELSEIF(EQFRC(NK1).EQ.0.)THEN<a name='2088'>
                      EE2=0.<a name='2089'>
                      UD2=1.<a name='2090'>
                    ELSE<a name='2091'>
<font color=#447700>!<a name='2092'></font>
<font color=#447700>!...SUBROUTINE PROF5 INTEGRATES OVER THE GAUSSIAN DIST TO DETERMINE THE<a name='2093'></font>
<font color=#447700>!   FRACTIONAL ENTRAINMENT AND DETRAINMENT RATES...<a name='2094'></font>
<font color=#447700>!<a name='2095'></font>
                      CALL <A href='../../html_code/phys/module_cu_mskf.F.html#PROF5'>PROF5</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PROF5_2">(EQFRC(NK1),EE2,UD2)<a name='2096'>
                    ENDIF<a name='2097'>
                  ENDIF<a name='2098'>
                ENDIF<a name='2099'>
              ENDIF                            <font color=#447700>! End of Entrain/Detrain IF BLOCK<a name='2100'></font>
<font color=#447700>!<a name='2101'></font>
<font color=#447700>!<a name='2102'></font>
<font color=#447700>!...NET ENTRAINMENT AND DETRAINMENT RATES ARE GIVEN BY THE AVERAGE FRACTIONAL<a name='2103'></font>
<font color=#447700>!   VALUES IN THE LAYER...<a name='2104'></font>
<font color=#447700>!<a name='2105'></font>
              EE2 = AMAX1(EE2,0.5)<a name='2106'>
              UD2 = 1.5*UD2<a name='2107'>
              UER(NK1)=0.5*REI*(EE1+EE2)<a name='2108'>
              UDR(NK1)=0.5*REI*(UD1+UD2)<a name='2109'>
<font color=#447700>!<a name='2110'></font>
<font color=#447700>!...IF THE CALCULATED UPDRAFT DETRAINMENT RATE IS GREATER THAN THE TOTAL<a name='2111'></font>
<font color=#447700>!   UPDRAFT MASS FLUX, ALL CLOUD MASS DETRAINS, EXIT UPDRAFT CALCULATIONS...<a name='2112'></font>
<font color=#447700>!<a name='2113'></font>
              IF(UMF(NK)-UDR(NK1).LT.10.)THEN<a name='2114'>
<font color=#447700>!<a name='2115'></font>
<font color=#447700>!...IF THE CALCULATED DETRAINED MASS FLUX IS GREATER THAN THE TOTAL UPD MASS<a name='2116'></font>
<font color=#447700>!   FLUX, IMPOSE TOTAL DETRAINMENT OF UPDRAFT MASS AT THE PREVIOUS MODEL LVL..<a name='2117'></font>
<font color=#447700>!   First, correct ABE calculation if needed...<a name='2118'></font>
<font color=#447700>!<a name='2119'></font>
                IF(DILBE.GT.0.)THEN<a name='2120'>
                  ABE=ABE-DILBE*G<a name='2121'>
                ENDIF<a name='2122'>
                LET=NK<a name='2123'>
<font color=#447700>!               WRITE(98,1015)P0(NK1)/100.<a name='2124'></font>
                EXIT <a name='2125'>
              ELSE<a name='2126'>
                EE1=EE2<a name='2127'>
                UD1=UD2<a name='2128'>
                UPOLD=UMF(NK)-UDR(NK1)<a name='2129'>
                UPNEW=UPOLD+UER(NK1)<a name='2130'>
                UMF(NK1)=UPNEW<a name='2131'>
                DILFRC(NK1) = UPNEW/UPOLD<a name='2132'>
<font color=#447700>!<a name='2133'></font>
<font color=#447700>!...DETLQ AND DETIC ARE THE RATES OF DETRAINMENT OF LIQUID AND<a name='2134'></font>
<font color=#447700>!...ICE IN THE DETRAINING UPDRAFT MASS...<a name='2135'></font>
<font color=#447700>!<a name='2136'></font>
                DETLQ(NK1)=QLIQ(NK1)*UDR(NK1)<a name='2137'>
                DETIC(NK1)=QICE(NK1)*UDR(NK1)<a name='2138'>
                QDT(NK1)=QU(NK1)<a name='2139'>
                QU(NK1)=(UPOLD*QU(NK1)+UER(NK1)*Q0(NK1))/UPNEW<a name='2140'>
                THETEU(NK1)=(THETEU(NK1)*UPOLD+THETEE(NK1)*UER(NK1))/UPNEW<a name='2141'>
                QLIQ(NK1)=QLIQ(NK1)*UPOLD/UPNEW<a name='2142'>
                QICE(NK1)=QICE(NK1)*UPOLD/UPNEW<a name='2143'>
<font color=#447700>!<a name='2144'></font>
<font color=#447700>!...PPTLIQ IS THE RATE OF GENERATION (FALLOUT) OF<a name='2145'></font>
<font color=#447700>!...LIQUID PRECIP AT A GIVEN MODEL LVL, PPTICE THE SAME FOR ICE,<a name='2146'></font>
<font color=#447700>!...TRPPT IS THE TOTAL RATE OF PRODUCTION OF PRECIP UP TO THE<a name='2147'></font>
<font color=#447700>!...CURRENT MODEL LEVEL...<a name='2148'></font>
<font color=#447700>!<a name='2149'></font>
                PPTLIQ(NK1)=QLQOUT(NK1)*UMF(NK)<a name='2150'>
                PPTICE(NK1)=QICOUT(NK1)*UMF(NK)<a name='2151'>
<font color=#447700>!<a name='2152'></font>
                TRPPT=TRPPT+PPTLIQ(NK1)+PPTICE(NK1)<a name='2153'>
                <font color=#447700>!!IF(NK1.LE.KPBL)UER(NK1)=UER(NK1)+VMFLCL*DP(NK1)/DPTHMX<a name='2154'></font>
                IF(NK1.LE.KCLDLAYER)UER(NK1)=UER(NK1)+VMFLCL*DP(NK1)/DPTHMX<a name='2155'>
              ENDIF<a name='2156'>
<font color=#447700>!<a name='2157'></font>
            END DO updraft<a name='2158'>
<font color=#447700>!<a name='2159'></font>
<font color=#447700>!...CHECK CLOUD DEPTH...IF CLOUD IS TALL ENOUGH, ESTIMATE THE EQUILIBRIU<a name='2160'></font>
<font color=#447700>!   TEMPERATURE LEVEL (LET) AND ADJUST MASS FLUX PROFILE AT CLOUD TOP SO<a name='2161'></font>
<font color=#447700>!   THAT MASS FLUX DECREASES TO ZERO AS A LINEAR FUNCTION OF PRESSURE BE<a name='2162'></font>
<font color=#447700>!   THE LET AND CLOUD TOP...<a name='2163'></font>
<font color=#447700>!     <a name='2164'></font>
<font color=#447700>!...LTOP IS THE MODEL LEVEL JUST BELOW THE LEVEL AT WHICH VERTICAL VELOC<a name='2165'></font>
<font color=#447700>!   FIRST BECOMES NEGATIVE...<a name='2166'></font>
<font color=#447700>!     <a name='2167'></font>
            LTOP=NK<a name='2168'>
            CLDHGT(LC)=Z0(LTOP)-ZLCL <a name='2169'>
<font color=#447700>!<a name='2170'></font>
<font color=#447700>!...Instead of using the same minimum cloud height (for deep convection)<a name='2171'></font>
<font color=#447700>!...everywhere, try specifying minimum cloud depth as a function of TLCL...<a name='2172'></font>
<font color=#447700>!<a name='2173'></font>
<font color=#447700>!<a name='2174'></font>
<font color=#447700>!<a name='2175'></font>
            IF(TLCL.GT.293.)THEN<a name='2176'>
              CHMIN = 4.E3<a name='2177'>
            ELSEIF(TLCL.LE.293. .and. TLCL.GE.273)THEN<a name='2178'>
              CHMIN = 2.E3 + 100.*(TLCL-273.)<a name='2179'>
            ELSEIF(TLCL.LT.273.)THEN<a name='2180'>
              CHMIN = 2.E3<a name='2181'>
            ENDIF<a name='2182'>
<a name='2183'>
<font color=#447700>!     <a name='2184'></font>
<font color=#447700>!...If cloud top height is less than the specified minimum for deep <a name='2185'></font>
<font color=#447700>!...convection, save value to consider this level as source for <a name='2186'></font>
<font color=#447700>!...shallow convection, go back up to check next level...<a name='2187'></font>
<font color=#447700>!     <a name='2188'></font>
<font color=#447700>!...Try specifying minimum cloud depth as a function of TLCL...<a name='2189'></font>
<font color=#447700>!<a name='2190'></font>
<font color=#447700>!<a name='2191'></font>
<font color=#447700>!...DO NOT ALLOW ANY CLOUD FROM THIS LAYER IF:<a name='2192'></font>
<font color=#447700>!<a name='2193'></font>
<font color=#447700>!...            1.) if there is no CAPE, or <a name='2194'></font>
<font color=#447700>!...            2.) cloud top is at model level just above LCL, or<a name='2195'></font>
<font color=#447700>!...            3.) cloud top is within updraft source layer, or<a name='2196'></font>
<font color=#447700>!...            4.) cloud-top detrainment layer begins within <a name='2197'></font>
<font color=#447700>!...                updraft source layer.<a name='2198'></font>
<font color=#447700>!<a name='2199'></font>
            <font color=#447700>!!IF(LTOP.LE.KLCL .or. LTOP.LE.KPBL .or. LET+1.LE.KPBL)THEN  ! No Convection Allowed<a name='2200'></font>
            IF(LTOP.LE.KLCL .or. LTOP.LE.KCLDLAYER .or. LET+1.LE.KCLDLAYER)THEN  <font color=#447700>! No Convection Allowed<a name='2201'></font>
              CLDHGT(LC)=0.<a name='2202'>
              DO NK=K,LTOP<a name='2203'>
                UMF(NK)=0.<a name='2204'>
                UDR(NK)=0.<a name='2205'>
                UER(NK)=0.<a name='2206'>
                DETLQ(NK)=0.<a name='2207'>
                DETIC(NK)=0.<a name='2208'>
                PPTLIQ(NK)=0.<a name='2209'>
                PPTICE(NK)=0.<a name='2210'>
              ENDDO<a name='2211'>
<font color=#447700>!        <a name='2212'></font>
            ELSEIF(CLDHGT(LC).GT.CHMIN .and. ABE.GT.1)THEN      <font color=#447700>! Deep Convection allowed<a name='2213'></font>
              ISHALL=0<a name='2214'>
              EXIT usl<a name='2215'>
            ELSE<a name='2216'>
<font color=#447700>!<a name='2217'></font>
<font color=#447700>!...TO DISALLOW SHALLOW CONVECTION, COMMENT OUT NEXT LINE !!!!!!!!<a name='2218'></font>
              ISHALL = 1<a name='2219'>
              IF(NU.EQ.NUCHM)THEN<a name='2220'>
                EXIT usl               <font color=#447700>! Shallow Convection from this layer<a name='2221'></font>
              ELSE<a name='2222'>
<font color=#447700>! Remember this layer (by virtue of non-zero CLDHGT) as potential shallow-cloud layer<a name='2223'></font>
                DO NK=K,LTOP<a name='2224'>
                  UMF(NK)=0.<a name='2225'>
                  UDR(NK)=0.<a name='2226'>
                  UER(NK)=0.<a name='2227'>
                  DETLQ(NK)=0.<a name='2228'>
                  DETIC(NK)=0.<a name='2229'>
                  PPTLIQ(NK)=0.<a name='2230'>
                  PPTICE(NK)=0.<a name='2231'>
                ENDDO<a name='2232'>
              ENDIF<a name='2233'>
            ENDIF<a name='2234'>
          ENDIF trigger<a name='2235'>
        END DO usl<a name='2236'>
    IF(ISHALL.EQ.1)THEN<a name='2237'>
      <font color=#447700>!!KSTART=MAX0(KPBL,KLCL)<a name='2238'></font>
      KSTART=MAX0(KCLDLAYER,KLCL)<a name='2239'>
      if (idiagee &gt; 0) write(98,'(a,1p,2i5,2x,2i5)') &amp;<a name='2240'>
         'kfcup let_old, let_new, klcl, ltop', let, kstart, klcl, ltop <font color=#447700>! rce 11-may-2012<a name='2241'></font>
      LET=KSTART<a name='2242'>
    endif<a name='2243'>
<font color=#447700>!     <a name='2244'></font>
<font color=#447700>!...IF THE LET AND LTOP ARE THE SAME, DETRAIN ALL OF THE UPDRAFT MASS FL<a name='2245'></font>
<font color=#447700>!   THIS LEVEL...<a name='2246'></font>
<font color=#447700>!     <a name='2247'></font>
    IF(LET.EQ.LTOP)THEN<a name='2248'>
      UDR(LTOP)=UMF(LTOP)+UDR(LTOP)-UER(LTOP)<a name='2249'>
      DETLQ(LTOP)=QLIQ(LTOP)*UDR(LTOP)*UPNEW/UPOLD<a name='2250'>
      DETIC(LTOP)=QICE(LTOP)*UDR(LTOP)*UPNEW/UPOLD<a name='2251'>
      UER(LTOP)=0.<a name='2252'>
      UMF(LTOP)=0.<a name='2253'>
    ELSE <a name='2254'>
<font color=#447700>!     <a name='2255'></font>
<font color=#447700>!   BEGIN TOTAL DETRAINMENT AT THE LEVEL ABOVE THE LET...<a name='2256'></font>
<font color=#447700>!     <a name='2257'></font>
      DPTT=0.<a name='2258'>
      DO NJ=LET+1,LTOP<a name='2259'>
        DPTT=DPTT+DP(NJ)<a name='2260'>
      ENDDO<a name='2261'>
      DUMFDP=UMF(LET)/DPTT<a name='2262'>
<font color=#447700>!     <a name='2263'></font>
<font color=#447700>!...ADJUST MASS FLUX PROFILES, DETRAINMENT RATES, AND PRECIPITATION FALL<a name='2264'></font>
<font color=#447700>!   RATES TO REFLECT THE LINEAR DECREASE IN MASS FLX BETWEEN THE LET AND<a name='2265'></font>
<font color=#447700>!     <a name='2266'></font>
      DO NK=LET+1,LTOP<a name='2267'>
<font color=#447700>!<a name='2268'></font>
<font color=#447700>!...entrainment is allowed at every level except for LTOP, so disallow<a name='2269'></font>
<font color=#447700>!...entrainment at LTOP and adjust entrainment rates between LET and LTOP<a name='2270'></font>
<font color=#447700>!...so the the dilution factor due to entyrianment is not changed but <a name='2271'></font>
<font color=#447700>!...the actual entrainment rate will change due due forced total <a name='2272'></font>
<font color=#447700>!...detrainment in this layer...<a name='2273'></font>
<font color=#447700>!<a name='2274'></font>
        IF(NK.EQ.LTOP)THEN<a name='2275'>
          UDR(NK) = UMF(NK-1)<a name='2276'>
          UER(NK) = 0.<a name='2277'>
          DETLQ(NK) = UDR(NK)*QLIQ(NK)*DILFRC(NK)<a name='2278'>
          DETIC(NK) = UDR(NK)*QICE(NK)*DILFRC(NK)<a name='2279'>
        ELSE<a name='2280'>
          UMF(NK)=UMF(NK-1)-DP(NK)*DUMFDP<a name='2281'>
          UER(NK)=UMF(NK)*(1.-1./DILFRC(NK))<a name='2282'>
          UDR(NK)=UMF(NK-1)-UMF(NK)+UER(NK)<a name='2283'>
          DETLQ(NK)=UDR(NK)*QLIQ(NK)*DILFRC(NK)<a name='2284'>
          DETIC(NK)=UDR(NK)*QICE(NK)*DILFRC(NK)<a name='2285'>
        ENDIF<a name='2286'>
        IF(NK.GE.LET+2)THEN<a name='2287'>
          TRPPT=TRPPT-PPTLIQ(NK)-PPTICE(NK)<a name='2288'>
          PPTLIQ(NK)=UMF(NK-1)*QLQOUT(NK)<a name='2289'>
          PPTICE(NK)=UMF(NK-1)*QICOUT(NK)<a name='2290'>
          TRPPT=TRPPT+PPTLIQ(NK)+PPTICE(NK)<a name='2291'>
        ENDIF<a name='2292'>
      ENDDO<a name='2293'>
    ENDIF<a name='2294'>
<font color=#447700>!     <a name='2295'></font>
<font color=#447700>! Initialize some arrays below cloud base and above cloud top...<a name='2296'></font>
<font color=#447700>!<a name='2297'></font>
    DO NK=1,K<a name='2298'>
      IF(NK.GE.LC)THEN<a name='2299'>
        IF(NK.EQ.LC)THEN<a name='2300'>
          UMF(NK)=VMFLCL*DP(NK)/DPTHMX<a name='2301'>
          UER(NK)=VMFLCL*DP(NK)/DPTHMX<a name='2302'>
        <font color=#447700>!!ELSEIF(NK.LE.KPBL)THEN<a name='2303'></font>
        ELSEIF(NK.LE.KCLDLAYER)THEN<a name='2304'>
          UER(NK)=VMFLCL*DP(NK)/DPTHMX<a name='2305'>
          UMF(NK)=UMF(NK-1)+UER(NK)<a name='2306'>
        ELSE<a name='2307'>
          UMF(NK)=VMFLCL<a name='2308'>
          UER(NK)=0.<a name='2309'>
        ENDIF<a name='2310'>
        TU(NK)=TMIX+(Z0(NK)-ZMIX)*GDRY<a name='2311'>
        QU(NK)=QMIX<a name='2312'>
        WU(NK)=WLCL<a name='2313'>
      ELSE<a name='2314'>
        TU(NK)=0.<a name='2315'>
        QU(NK)=0.<a name='2316'>
        UMF(NK)=0.<a name='2317'>
        WU(NK)=0.<a name='2318'>
        UER(NK)=0.<a name='2319'>
      ENDIF<a name='2320'>
      UDR(NK)=0.<a name='2321'>
      QDT(NK)=0.<a name='2322'>
      QLIQ(NK)=0.<a name='2323'>
      QICE(NK)=0.<a name='2324'>
      QLQOUT(NK)=0.<a name='2325'>
      QICOUT(NK)=0.<a name='2326'>
      PPTLIQ(NK)=0.<a name='2327'>
      PPTICE(NK)=0.<a name='2328'>
      DETLQ(NK)=0.<a name='2329'>
      DETIC(NK)=0.<a name='2330'>
      RATIO2(NK)=0.<a name='2331'>
      CALL <A href='../../html_code/phys/module_cu_mskf.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_7">(P0(NK),T0(NK),Q0(NK),THETEE(NK),ALIQ,BLIQ,CLIQ,DLIQ)<a name='2332'>
      EQFRC(NK)=1.0<a name='2333'>
    ENDDO<a name='2334'>
<font color=#447700>!     <a name='2335'></font>
      LTOP1=LTOP+1<a name='2336'>
      LTOPM1=LTOP-1<a name='2337'>
<font color=#447700>!     <a name='2338'></font>
<font color=#447700>!...DEFINE VARIABLES ABOVE CLOUD TOP...<a name='2339'></font>
<font color=#447700>!     <a name='2340'></font>
      DO NK=LTOP1,KX<a name='2341'>
        UMF(NK)=0.<a name='2342'>
        UDR(NK)=0.<a name='2343'>
        UER(NK)=0.<a name='2344'>
        QDT(NK)=0.<a name='2345'>
        QLIQ(NK)=0.<a name='2346'>
        QICE(NK)=0.<a name='2347'>
        QLQOUT(NK)=0.<a name='2348'>
        QICOUT(NK)=0.<a name='2349'>
        DETLQ(NK)=0.<a name='2350'>
        DETIC(NK)=0.<a name='2351'>
        PPTLIQ(NK)=0.<a name='2352'>
        PPTICE(NK)=0.<a name='2353'>
        <font color=#447700>!IF(NK.GT.LTOP1)THEN<a name='2354'></font>
        IF(NK.GE.LTOP1)THEN <font color=#447700>!BSINGH(11/12/2014): So that wu, qu and tu has a value for NK==LTOP1<a name='2355'></font>
          TU(NK)=0.<a name='2356'>
          QU(NK)=0.<a name='2357'>
          WU(NK)=0.<a name='2358'>
        ENDIF<a name='2359'>
        THTA0(NK)=0.<a name='2360'>
        THTAU(NK)=0.<a name='2361'>
        EMS(NK)=0.<a name='2362'>
        EMSD(NK)=0.<a name='2363'>
        TG(NK)=T0(NK)<a name='2364'>
        QG(NK)=Q0(NK)<a name='2365'>
        QLG(NK)=0.<a name='2366'>
        QIG(NK)=0.<a name='2367'>
        QRG(NK)=0.<a name='2368'>
        QSG(NK)=0.<a name='2369'>
        OMG(NK)=0.<a name='2370'>
      ENDDO<a name='2371'>
        OMG(KX+1)=0.<a name='2372'>
<a name='2373'>
<font color=#447700>! rce 11-may-2012 mods start -------------------------------------------<a name='2374'></font>
<font color=#447700>!   calc droplet number (qndropbb)<a name='2375'></font>
           if ( flag_chem ) then<a name='2376'>
              do nk1 = klcl, ltop<a name='2377'>
                 nk = nk1 - 1<a name='2378'>
                 if (nk1 == klcl) then<a name='2379'>
<font color=#447700>!   calculate aerosol activatation at cloud base<a name='2380'></font>
                    tk_act = tu(nk1)<a name='2381'>
                    rho_act = p0(nk1)/(r*tu(nk1)*(1.+0.608*qu(nk1)))<a name='2382'>
<font color=#447700>!   with cup, wlcl can be 0.0, so use wu(k+1) when wlcl is small<a name='2383'></font>
                    w_act = wlcl<a name='2384'>
                    if (wlcl &lt; 0.1) w_act = max( w_act, wu(nk1) )<a name='2385'>
<a name='2386'>
<font color=#447700>!   effective w_act accounting for entrainment, from Barahona and Nenes (2007) eqn 14b<a name='2387'></font>
<font color=#447700>!<a name='2388'></font>
<font color=#447700>!   w_act_effective = w_act * escale<a name='2389'></font>
<font color=#447700>!<a name='2390'></font>
<font color=#447700>!   escale = 1 + (eBN/alphaBN) * [ (delHv*Mw /(Ru*T*T))*deltaT - deltaRH ]   <a name='2391'></font>
<font color=#447700>!            1 + (eBN/alphaBN) * [ (delHv*ep2/(Ra*T*T))*deltaT - deltaRH ]   <a name='2392'></font>
<font color=#447700>!<a name='2393'></font>
<font color=#447700>!   eBN = entrainment rate = d[ln(updraft_mass_flux)]/dz<a name='2394'></font>
<font color=#447700>!   alphaBN = [g*Mw *delHv/(cp*Ru*T*T)] - [g*Ma/(Ru*T)]<a name='2395'></font>
<font color=#447700>!           = [g*ep2*delHv/(cp*Ra*T*T)] - [g   /(Ra*T)]<a name='2396'></font>
<font color=#447700>!<a name='2397'></font>
<font color=#447700>!   Mw, Ma = molecular weights of water and air ;  ep2 = Mw/Ma<a name='2398'></font>
<font color=#447700>!   delHv = latent heat of vaporization<a name='2399'></font>
<font color=#447700>!   Ru = universal gas constant                 ;  Ra = dry-air gas const<a name='2400'></font>
<font color=#447700>!   deltaT = Tupdr - Tenv                       ;  deltaRH = RHupdr - RHenv = 1 - RHenv<a name='2401'></font>
                    tmpa = max( umf(nk), 1.0e-10 )<a name='2402'>
                    tmpb = max( uer(nk1), 0.0 )<a name='2403'>
                    tmpe = tmpb/(tmpa+0.5*tmpb)<a name='2404'>
                    tmp_lv = xlv0 - xlv1*tk_act<a name='2405'>
                    tmp_deltatkfact = tmp_lv*ep2/(r*tk_act*tk_act)<a name='2406'>
                    tmp_alphabn = tmp_deltatkfact*g/cp - g/(r*tk_act)<a name='2407'>
                    tmp_ebn = tmpe/dzq(nk1)<a name='2408'>
                    tmp_deltatk = tk_act - t0(nk1)<a name='2409'>
                    tmp_deltarh = 1.0 - q0(nk1)/qu(nk1)<a name='2410'>
                    tmp_escale = 1.0 + (tmp_ebn/tmp_alphabn) * (tmp_deltatkfact*tmp_deltatk - tmp_deltarh)  <a name='2411'>
                    w_act_eff = w_act<a name='2412'>
                    if (qndrop_cldbase_entrain_opt == 1) w_act_eff = w_act*tmp_escale<a name='2413'>
                    w_act_eff = max( w_act_eff, w_act_min )<a name='2414'>
                    wact = w_act_eff<a name='2415'>
<a name='2416'>
                    if (idiagee &gt; 0) then<a name='2417'>
                       write(98,'(//a,8i5)') 'kfcup bb activate_cldbase_kfcup - i, j, nu, kcheck, ksrc1/2', &amp;<a name='2418'>
                          i, j, nu, kcheck(nu), lc, kcldlayer<a name='2419'>
                       write(98,'(  a,3i11     )') 'nk1, klcl, k                      ', nk1, klcl, k<a name='2420'>
                       write(98,'(  a,3i11     )') 'cldbase_entopt, incloud_entopt    ', qndrop_cldbase_entrain_opt, qndrop_incloud_entrain_opt<a name='2421'>
                       write(98,'(  a,1p,8e11.3)') 'wlcl, wu(nk1), w_act, _eff, _min  ', wlcl, wu(nk1), w_act, w_act_eff, w_act_min<a name='2422'>
                       write(98,'(  a,1p,8e11.3)') 'r, p, t, q, rho                   ', r, p0(nk1), tk_act, qu(nk1), rho_act<a name='2423'>
                       write(98,'(  a,1p,8e11.3)') 'g, r, cp, ep2, xlv0, xlv1, tmp_lv ', g, r, cp, ep2, xlv0, xlv1, tmp_lv<a name='2424'>
                       write(98,'(  a,1p,8e11.3)') 'tmpa/dx2, tmpb/dx2, tmpe          ', tmpa/dxsq, tmpb/dxsq, tmpe<a name='2425'>
                       write(98,'(  a,1p,8e11.3)') 'ebn, dzq(nk1), dz...              ', tmp_ebn, dzq(nk1), z_at_w1d(nk1+1)-z_at_w1d(nk1)<a name='2426'>
                       write(98,'(  a,1p,8e11.3)') 'deltarh, deltatk, deltatk*factor  ', tmp_deltarh, tmp_deltatk, tmp_deltatk*tmp_deltatkfact<a name='2427'>
                       write(98,'(  a,1p,8e11.3)') 'escale, alphabn, deltatkfact      ', tmp_escale, tmp_alphabn, tmp_deltatkfact<a name='2428'>
                    end if<a name='2429'>
                    call <A href='../../html_code/phys/module_cu_kfcup.F.html#ACTIVATE_CLDBASE_KFCUP'>activate_cldbase_kfcup</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACTIVATE_CLDBASE_KFCUP_1">( idiagee, grid_id, ktau, &amp;<a name='2430'>
                       i, j, nk1, kts, kte, lc, kcldlayer, &amp;<a name='2431'>
                       num_chem, maxd_acomp, maxd_aphase, maxd_atype, maxd_asize, &amp;<a name='2432'>
                       ntype_aer, nsize_aer, ncomp_aer, &amp;<a name='2433'>
                       ai_phase, msectional, massptr_aer, numptr_aer, &amp;<a name='2434'>
                       dlo_sect, dhi_sect, dens_aer, hygro_aer, sigmag_aer, &amp;<a name='2435'>
                       tk_act, rho_act, dp, w_act_eff, &amp;<a name='2436'>
                       chem1d, qndrop_tmp )<a name='2437'>
                    qndrop_tmp = qndrop_tmp<a name='2438'>
                 end if<a name='2439'>
<a name='2440'>
<font color=#447700>!   calculate dilution from entrainment<a name='2441'></font>
<font color=#447700>!   umf(nk) is flux at bottom of layer nk1 ; uer(nk1) is entrainment (delta-umf) in layer nk1<a name='2442'></font>
                 tmpa = max( umf(nk), 1.0e-10 )<a name='2443'>
                 tmpb = max( uer(nk1), 0.0 )<a name='2444'>
                 if (qndrop_incloud_entrain_opt == 1) then<a name='2445'>
<font color=#447700>!   qndrop at center of layer nk1<a name='2446'></font>
                    qndropbb(nk1) = qndrop_tmp*(tmpa/(tmpa+0.5*tmpb))<a name='2447'>
<font color=#447700>!   qndrop at top of layer nk1<a name='2448'></font>
                    qndrop_tmp = qndrop_tmp*(tmpa/(tmpa+tmpb))<a name='2449'>
                 else<a name='2450'>
                    qndropbb(nk1) = qndrop_tmp<a name='2451'>
                 end if<a name='2452'>
                 if (idiagee &gt; 0 .and. nk1 &lt;= klcl+4) then<a name='2453'>
                       write(98,'(  a,i3,1p,8e11.3)') 'nk1, tmpa/dx2, tmpb/dx2, qndrop', nk1, tmpa/dxsq, tmpb/dxsq, qndropbb(nk1)<a name='2454'>
                 end if<a name='2455'>
              end do <font color=#447700>! nk1<a name='2456'></font>
              if (idiagee &gt; 0) write(98,'(a)')<a name='2457'>
           end if <font color=#447700>! ( flag_chem ) then<a name='2458'></font>
<font color=#447700>! rce 11-may-2012 mods end ---------------------------------------------<a name='2459'></font>
<a name='2460'>
        DO NK=1,LTOP<a name='2461'>
          EMS(NK)=DP(NK)*DXSQ/G<a name='2462'>
          EMSD(NK)=1./EMS(NK)<a name='2463'>
<font color=#447700>!     <a name='2464'></font>
<font color=#447700>!...INITIALIZE SOME VARIABLES TO BE USED LATER IN THE VERT ADVECTION SCH<a name='2465'></font>
<font color=#447700>!     <a name='2466'></font>
          EXN(NK)=(P00/P0(NK))**(0.2854*(1.-0.28*QDT(NK)))<a name='2467'>
          THTAU(NK)=TU(NK)*EXN(NK)<a name='2468'>
          EXN(NK)=(P00/P0(NK))**(0.2854*(1.-0.28*Q0(NK)))<a name='2469'>
          THTA0(NK)=T0(NK)*EXN(NK)<a name='2470'>
          DDILFRC(NK) = 1./DILFRC(NK)<a name='2471'>
          OMG(NK)=0.<a name='2472'>
        ENDDO<a name='2473'>
<font color=#447700>!     IF (XTIME.LT.10.)THEN<a name='2474'></font>
<font color=#447700>!      WRITE(98,1025)KLCL,ZLCL,DTLCL,LTOP,P0(LTOP),IFLAG,<a name='2475'></font>
<font color=#447700>!    * TMIX-T00,PMIX,QMIX,ABE<a name='2476'></font>
<font color=#447700>!      WRITE(98,1030)P0(LET)/100.,P0(LTOP)/100.,VMFLCL,PLCL/100.,<a name='2477'></font>
<font color=#447700>!    * WLCL,CLDHGT<a name='2478'></font>
<font color=#447700>!     ENDIF<a name='2479'></font>
<font color=#447700>!     <a name='2480'></font>
<font color=#447700>!...COMPUTE CONVECTIVE TIME SCALE(TIMEC). THE MEAN WIND AT THE LCL<a name='2481'></font>
<font color=#447700>!...AND MIDTROPOSPHERE IS USED.<a name='2482'></font>
<font color=#447700>!     <a name='2483'></font>
        WSPD(KLCL)=SQRT(U0(KLCL)*U0(KLCL)+V0(KLCL)*V0(KLCL))<a name='2484'>
        WSPD(L5)=SQRT(U0(L5)*U0(L5)+V0(L5)*V0(L5))<a name='2485'>
        WSPD(LTOP)=SQRT(U0(LTOP)*U0(LTOP)+V0(LTOP)*V0(LTOP))<a name='2486'>
        VCONV=.5*(WSPD(KLCL)+WSPD(L5))<a name='2487'>
<font color=#447700>!...for ETA model, DX is a function of location...<a name='2488'></font>
<font color=#447700>!       TIMEC=DX(I,J)/VCONV<a name='2489'></font>
        TIMEC=DX/VCONV<a name='2490'>
        TADVEC=TIMEC<a name='2491'>
        TIMEC=AMAX1(1800.,TIMEC)<a name='2492'>
        TIMEC=AMIN1(3600.,TIMEC)<a name='2493'>
        <font color=#447700>!!IF(ISHALL.EQ.1)TIMEC=2400.<a name='2494'></font>
        IF(ISHALL.EQ.1)TIMEC=TIMEC_SHALL  <font color=#447700>! Reduced time constant, lkb 3/31/10<a name='2495'></font>
        NIC=NINT(TIMEC/DT)<a name='2496'>
        TIMEC=FLOAT(NIC)*DT<a name='2497'>
<font color=#447700>!     <a name='2498'></font>
<font color=#447700>!...COMPUTE WIND SHEAR AND PRECIPITATION EFFICIENCY.<a name='2499'></font>
<font color=#447700>!     <a name='2500'></font>
        IF(WSPD(LTOP).GT.WSPD(KLCL))THEN<a name='2501'>
          SHSIGN=1.<a name='2502'>
        ELSE<a name='2503'>
          SHSIGN=-1.<a name='2504'>
        ENDIF<a name='2505'>
        VWS=(U0(LTOP)-U0(KLCL))*(U0(LTOP)-U0(KLCL))+(V0(LTOP)-V0(KLCL))*   &amp;<a name='2506'>
            (V0(LTOP)-V0(KLCL))<a name='2507'>
        VWS=1.E3*SHSIGN*SQRT(VWS)/(Z0(LTOP)-Z0(LCL))<a name='2508'>
        PEF=1.591+VWS*(-.639+VWS*(9.53E-2-VWS*4.96E-3))<a name='2509'>
        PEF=AMAX1(PEF,.2)<a name='2510'>
        PEF=AMIN1(PEF,.9)<a name='2511'>
<font color=#447700>!     <a name='2512'></font>
<font color=#447700>!...PRECIPITATION EFFICIENCY IS A FUNCTION OF THE HEIGHT OF CLOUD BASE.<a name='2513'></font>
<font color=#447700>!     <a name='2514'></font>
        CBH=(ZLCL-Z0(1))*3.281E-3<a name='2515'>
        IF(CBH.LT.3.)THEN<a name='2516'>
          RCBH=.02<a name='2517'>
        ELSE<a name='2518'>
          RCBH=.96729352+CBH*(-.70034167+CBH*(.162179896+CBH*(-            &amp;<a name='2519'>
               1.2569798E-2+CBH*(4.2772E-4-CBH*5.44E-6))))<a name='2520'>
        ENDIF<a name='2521'>
        IF(CBH.GT.25)RCBH=2.4<a name='2522'>
        PEFCBH=1./(1.+RCBH)<a name='2523'>
        PEFCBH=AMIN1(PEFCBH,.9)<a name='2524'>
<font color=#447700>!     <a name='2525'></font>
<font color=#447700>!... MEAN PEF. IS USED TO COMPUTE RAINFALL.<a name='2526'></font>
<font color=#447700>!     <a name='2527'></font>
        PEFF=.5*(PEF+PEFCBH)<a name='2528'>
        PEFF2 = PEFF                                <font color=#447700>! JSK MODS<a name='2529'></font>
       IF(IPRNT)THEN  <a name='2530'>
         WRITE(98,1035)PEF,PEFCBH,LC,LET,WKL,VWS<a name='2531'>
<font color=#447700>!       flush(98)   <a name='2532'></font>
       endif     <a name='2533'>
<font color=#447700>!        WRITE(98,1035)PEF,PEFCBH,LC,LET,WKL,VWS<a name='2534'></font>
<font color=#447700>!*****************************************************************<a name='2535'></font>
<font color=#447700>!                                                                *<a name='2536'></font>
<font color=#447700>!                  COMPUTE DOWNDRAFT PROPERTIES                  *<a name='2537'></font>
<font color=#447700>!                                                                *<a name='2538'></font>
<font color=#447700>!*****************************************************************<a name='2539'></font>
<font color=#447700>!     <a name='2540'></font>
<font color=#447700>!     <a name='2541'></font>
       TDER=0.<a name='2542'>
 devap:IF(ISHALL.EQ.1)THEN<a name='2543'>
         LFS = 1<a name='2544'>
         DMF(1:KX)=0.  <font color=#447700>! rce 11-may-2012 - zero these out to avoid problems<a name='2545'></font>
         DER(1:KX)=0.  <font color=#447700>!    with unit=98 diagnostic output<a name='2546'></font>
         DDR(1:KX)=0.<a name='2547'>
         WD(1:KX)=0.<a name='2548'>
         TZ(1:KX)=0.<a name='2549'>
         QD(1:KX)=0.<a name='2550'>
         THTAD(1:KX)=0.<a name='2551'>
       ELSE<a name='2552'>
<font color=#447700>!<a name='2553'></font>
<font color=#447700>!...start downdraft about 150 mb above cloud base...<a name='2554'></font>
<font color=#447700>!<a name='2555'></font>
<font color=#447700>!        KSTART=MAX0(KPBL,KLCL)<a name='2556'></font>
<font color=#447700>!        KSTART=KPBL                                  ! Changed 7/23/99<a name='2557'></font>
         <font color=#447700>!!KSTART=KPBL+1                                ! Changed 7/23/99<a name='2558'></font>
         KSTART=KCLDLAYER+1                                <font color=#447700>! Changed 7/23/99<a name='2559'></font>
         KLFS = LET-1<a name='2560'>
         DO NK = KSTART+1,KL<a name='2561'>
           DPPP = P0(KSTART)-P0(NK)<a name='2562'>
<font color=#447700>!          IF(DPPP.GT.200.E2)THEN<a name='2563'></font>
           IF(DPPP.GT.150.E2)THEN<a name='2564'>
             KLFS = NK<a name='2565'>
             EXIT <a name='2566'>
           ENDIF<a name='2567'>
         ENDDO<a name='2568'>
         KLFS = MIN0(KLFS,LET-1)<a name='2569'>
         LFS = KLFS<a name='2570'>
<font color=#447700>!<a name='2571'></font>
<font color=#447700>!...if LFS is not at least 50 mb above cloud base (implying that the <a name='2572'></font>
<font color=#447700>!...level of equil temp, LET, is just above cloud base) do not allow a<a name='2573'></font>
<font color=#447700>!...downdraft...<a name='2574'></font>
<font color=#447700>!<a name='2575'></font>
        IF((P0(KSTART)-P0(LFS)).GT.50.E2)THEN<a name='2576'>
          THETED(LFS) = THETEE(LFS)<a name='2577'>
          QD(LFS) = Q0(LFS)<a name='2578'>
<font color=#447700>!<a name='2579'></font>
<font color=#447700>!...call tpmix2dd to find wet-bulb temp, qv...<a name='2580'></font>
<font color=#447700>!<a name='2581'></font>
          call <A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2DD'>tpmix2dd</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2DD_1">(p0(lfs),theted(lfs),tz(lfs),qss,i,j)<a name='2582'>
          THTAD(LFS)=TZ(LFS)*(P00/P0(LFS))**(0.2854*(1.-0.28*QSS))<a name='2583'>
<font color=#447700>!     <a name='2584'></font>
<font color=#447700>!...TAKE A FIRST GUESS AT THE INITIAL DOWNDRAFT MASS FLUX...<a name='2585'></font>
<font color=#447700>!     <a name='2586'></font>
          TVD(LFS)=TZ(LFS)*(1.+0.608*QSS)<a name='2587'>
          RDD=P0(LFS)/(R*TVD(LFS))<a name='2588'>
          A1=(1.-PEFF)*AU0<a name='2589'>
          DMF(LFS)=-A1*RDD<a name='2590'>
          DER(LFS)=DMF(LFS)<a name='2591'>
          DDR(LFS)=0.<a name='2592'>
          RHBAR = RH(LFS)*DP(LFS)<a name='2593'>
          DPTT = DP(LFS)<a name='2594'>
          DO ND = LFS-1,KSTART,-1<a name='2595'>
            ND1 = ND+1<a name='2596'>
            DER(ND)=DER(LFS)*EMS(ND)/EMS(LFS)<a name='2597'>
            DDR(ND)=0.<a name='2598'>
            DMF(ND)=DMF(ND1)+DER(ND)<a name='2599'>
            THETED(ND)=(THETED(ND1)*DMF(ND1)+THETEE(ND)*DER(ND))/DMF(ND)<a name='2600'>
            QD(ND)=(QD(ND1)*DMF(ND1)+Q0(ND)*DER(ND))/DMF(ND)    <a name='2601'>
            DPTT = DPTT+DP(ND)<a name='2602'>
            RHBAR = RHBAR+RH(ND)*DP(ND)<a name='2603'>
          ENDDO<a name='2604'>
          RHBAR = RHBAR/DPTT<a name='2605'>
          DMFFRC = 2.*(1.-RHBAR)<a name='2606'>
          DPDD = 0.<a name='2607'>
<font color=#447700>!...Calculate melting effect<a name='2608'></font>
<font color=#447700>!... first, compute total frozen precipitation generated...<a name='2609'></font>
<font color=#447700>!<a name='2610'></font>
          pptmlt = 0.<a name='2611'>
          DO NK = KLCL,LTOP<a name='2612'>
            PPTMLT = PPTMLT+PPTICE(NK)<a name='2613'>
          ENDDO<a name='2614'>
          if(lc.lt.ml)then<a name='2615'>
<font color=#447700>!...For now, calculate melting effect as if DMF = -UMF at KLCL, i.e., as<a name='2616'></font>
<font color=#447700>!...if DMFFRC=1.  Otherwise, for small DMFFRC, DTMELT gets too large!<a name='2617'></font>
<font color=#447700>!...12/14/98 jsk...<a name='2618'></font>
            DTMELT = RLF*PPTMLT/(CP*UMF(KLCL))<a name='2619'>
          else<a name='2620'>
            DTMELT = 0.<a name='2621'>
          endif<a name='2622'>
          LDT = MIN0(LFS-1,KSTART-1)<a name='2623'>
<font color=#447700>!<a name='2624'></font>
          call <A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2DD'>tpmix2dd</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2DD_2">(p0(kstart),theted(kstart),tz(kstart),qss,i,j)<a name='2625'>
<font color=#447700>!<a name='2626'></font>
          tz(kstart) = tz(kstart)-dtmelt<a name='2627'>
          ES=ALIQ*EXP((BLIQ*TZ(KSTART)-CLIQ)/(TZ(KSTART)-DLIQ))<a name='2628'>
          QSS=0.622*ES/(P0(KSTART)-ES)<a name='2629'>
          THETED(KSTART)=TZ(KSTART)*(1.E5/P0(KSTART))**(0.2854*(1.-0.28*QSS))*    &amp;<a name='2630'>
                EXP((3374.6525/TZ(KSTART)-2.5403)*QSS*(1.+0.81*QSS))<a name='2631'>
<font color=#447700>!....  <a name='2632'></font>
          LDT = MIN0(LFS-1,KSTART-1)                        <font color=#447700>! Determine the level to start at,<a name='2633'></font>
                                                            <font color=#447700>! KSTART is level of PBL<a name='2634'></font>
          DO ND = LDT,1,-1<a name='2635'>
            DPDD = DPDD+DP(ND)<a name='2636'>
            THETED(ND) = THETED(KSTART)<a name='2637'>
            QD(ND)     = QD(KSTART)       <a name='2638'>
<font color=#447700>!<a name='2639'></font>
<font color=#447700>!...call tpmix2dd to find wet bulb temp, saturation mixing ratio...<a name='2640'></font>
<font color=#447700>!<a name='2641'></font>
            call <A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2DD'>tpmix2dd</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2DD_3">(p0(nd),theted(nd),tz(nd),qss,i,j)<a name='2642'>
            qsd(nd) = qss<a name='2643'>
<font color=#447700>!<a name='2644'></font>
<font color=#447700>!...specify RH decrease of 20%/km in downdraft...<a name='2645'></font>
<font color=#447700>!<a name='2646'></font>
            RHH = 1.-0.2/1000.*(Z0(KSTART)-Z0(ND))<a name='2647'>
<font color=#447700>!<a name='2648'></font>
<font color=#447700>!...adjust downdraft TEMP, Q to specified RH:<a name='2649'></font>
<font color=#447700>!<a name='2650'></font>
            IF(RHH.LT.1.)THEN<a name='2651'>
              DSSDT=(CLIQ-BLIQ*DLIQ)/((TZ(ND)-DLIQ)*(TZ(ND)-DLIQ))<a name='2652'>
              RL=XLV0-XLV1*TZ(ND)<a name='2653'>
              DTMP=RL*QSS*(1.-RHH)/(CP+RL*RHH*QSS*DSSDT)<a name='2654'>
              T1RH=TZ(ND)+DTMP<a name='2655'>
              ES=RHH*ALIQ*EXP((BLIQ*T1RH-CLIQ)/(T1RH-DLIQ))  <font color=#447700>! Teten's equation to find Es<a name='2656'></font>
              QSRH=0.622*ES/(P0(ND)-ES)                      <font color=#447700>! Find the sat. mixing ratio<a name='2657'></font>
<font color=#447700>!<a name='2658'></font>
<font color=#447700>!...CHECK TO SEE IF MIXING RATIO AT SPECIFIED RH IS LESS THAN ACTUAL<a name='2659'></font>
<font color=#447700>!...MIXING RATIO...IF SO, ADJUST TO GIVE ZERO EVAPORATION...<a name='2660'></font>
<font color=#447700>!<a name='2661'></font>
              IF(QSRH.LT.QD(ND))THEN<a name='2662'>
                QSRH=QD(ND)<a name='2663'>
                T1RH=TZ(ND)+(QSS-QSRH)*RL/CP<a name='2664'>
              ENDIF<a name='2665'>
              TZ(ND)=T1RH<a name='2666'>
              QSS=QSRH<a name='2667'>
              QSD(ND) = QSS<a name='2668'>
            ENDIF         <a name='2669'>
            TVD(nd) = tz(nd)*(1.+0.608*qsd(nd))<a name='2670'>
            IF(TVD(ND).GT.TV0(ND).OR.ND.EQ.1)THEN<a name='2671'>
              LDB=ND<a name='2672'>
              EXIT<a name='2673'>
            ENDIF<a name='2674'>
          ENDDO<a name='2675'>
          IF((P0(LDB)-P0(LFS)) .gt. 50.E2)THEN   <font color=#447700>! minimum Downdraft depth! <a name='2676'></font>
            DO ND=LDT,LDB,-1<a name='2677'>
              ND1 = ND+1<a name='2678'>
              DDR(ND) = -DMF(KSTART)*DP(ND)/DPDD<a name='2679'>
              DER(ND) = 0.<a name='2680'>
              DMF(ND) = DMF(ND1)+DDR(ND)<a name='2681'>
              TDER=TDER+(QSD(nd)-QD(ND))*DDR(ND)<a name='2682'>
              QD(ND)=QSD(nd)<a name='2683'>
              THTAD(ND)=TZ(ND)*(P00/P0(ND))**(0.2854*(1.-0.28*QD(ND)))<a name='2684'>
            ENDDO<a name='2685'>
          ENDIF<a name='2686'>
        ENDIF<a name='2687'>
      ENDIF devap<a name='2688'>
<font color=#447700>!<a name='2689'></font>
<font color=#447700>!...IF DOWNDRAFT DOES NOT EVAPORATE ANY WATER FOR SPECIFIED RELATIVE<a name='2690'></font>
<font color=#447700>!...HUMIDITY, NO DOWNDRAFT IS ALLOWED...<a name='2691'></font>
<font color=#447700>!<a name='2692'></font>
d_mf:   IF(TDER.LT.1.)THEN<a name='2693'>
<font color=#447700>!           WRITE(98,3004)I,J <a name='2694'></font>
<font color=#447700>!3004       FORMAT(' ','No Downdraft!;  I=',I3,2X,'J=',I3,'ISHALL =',I2)<a name='2695'></font>
          PPTFLX=TRPPT<a name='2696'>
          CPR=TRPPT<a name='2697'>
          TDER=0.<a name='2698'>
          CNDTNF=0.<a name='2699'>
          UPDINC=1.<a name='2700'>
          LDB=LFS<a name='2701'>
          DO NDK=1,LTOP<a name='2702'>
            DMF(NDK)=0.<a name='2703'>
            DER(NDK)=0.<a name='2704'>
            DDR(NDK)=0.<a name='2705'>
            THTAD(NDK)=0.<a name='2706'>
            WD(NDK)=0.<a name='2707'>
            TZ(NDK)=0.<a name='2708'>
            QD(NDK)=0.<a name='2709'>
          ENDDO<a name='2710'>
          AINCM2=100.<a name='2711'>
        ELSE <a name='2712'>
          DDINC = -DMFFRC*UMF(KLCL)/DMF(KSTART)<a name='2713'>
          UPDINC=1.<a name='2714'>
          IF(TDER*DDINC.GT.TRPPT)THEN<a name='2715'>
            DDINC = TRPPT/TDER<a name='2716'>
          ENDIF<a name='2717'>
          TDER = TDER*DDINC<a name='2718'>
          DO NK=LDB,LFS<a name='2719'>
            DMF(NK)=DMF(NK)*DDINC<a name='2720'>
            DER(NK)=DER(NK)*DDINC<a name='2721'>
            DDR(NK)=DDR(NK)*DDINC<a name='2722'>
          ENDDO<a name='2723'>
         CPR=TRPPT<a name='2724'>
         PPTFLX = TRPPT-TDER<a name='2725'>
         PEFF=PPTFLX/TRPPT<a name='2726'>
         IF(IPRNT)THEN<a name='2727'>
           write(98,*)'PRECIP EFFICIENCY =',PEFF<a name='2728'>
<font color=#447700>!          flush(98)   <a name='2729'></font>
         ENDIF<a name='2730'>
<font color=#447700>!<a name='2731'></font>
<font color=#447700>!<a name='2732'></font>
<font color=#447700>!...ADJUST UPDRAFT MASS FLUX, MASS DETRAINMENT RATE, AND LIQUID WATER AN<a name='2733'></font>
<font color=#447700>!   DETRAINMENT RATES TO BE CONSISTENT WITH THE TRANSFER OF THE ESTIMATE<a name='2734'></font>
<font color=#447700>!   FROM THE UPDRAFT TO THE DOWNDRAFT AT THE LFS...<a name='2735'></font>
<font color=#447700>!     <a name='2736'></font>
<font color=#447700>!         DO NK=LC,LFS<a name='2737'></font>
<font color=#447700>!           UMF(NK)=UMF(NK)*UPDINC<a name='2738'></font>
<font color=#447700>!           UDR(NK)=UDR(NK)*UPDINC<a name='2739'></font>
<font color=#447700>!           UER(NK)=UER(NK)*UPDINC<a name='2740'></font>
<font color=#447700>!           PPTLIQ(NK)=PPTLIQ(NK)*UPDINC<a name='2741'></font>
<font color=#447700>!           PPTICE(NK)=PPTICE(NK)*UPDINC<a name='2742'></font>
<font color=#447700>!           DETLQ(NK)=DETLQ(NK)*UPDINC<a name='2743'></font>
<font color=#447700>!           DETIC(NK)=DETIC(NK)*UPDINC<a name='2744'></font>
<font color=#447700>!         ENDDO<a name='2745'></font>
<font color=#447700>!     <a name='2746'></font>
<font color=#447700>!...ZERO OUT THE ARRAYS FOR DOWNDRAFT DATA AT LEVELS ABOVE AND BELOW THE<a name='2747'></font>
<font color=#447700>!...DOWNDRAFT...<a name='2748'></font>
<font color=#447700>!     <a name='2749'></font>
         IF(LDB.GT.1)THEN<a name='2750'>
           DO NK=1,LDB-1<a name='2751'>
             DMF(NK)=0.<a name='2752'>
             DER(NK)=0.<a name='2753'>
             DDR(NK)=0.<a name='2754'>
             WD(NK)=0.<a name='2755'>
             TZ(NK)=0.<a name='2756'>
             QD(NK)=0.<a name='2757'>
             THTAD(NK)=0.<a name='2758'>
           ENDDO<a name='2759'>
         ENDIF<a name='2760'>
         DO NK=LFS+1,KX<a name='2761'>
           DMF(NK)=0.<a name='2762'>
           DER(NK)=0.<a name='2763'>
           DDR(NK)=0.<a name='2764'>
           WD(NK)=0.<a name='2765'>
           TZ(NK)=0.<a name='2766'>
           QD(NK)=0.<a name='2767'>
           THTAD(NK)=0.<a name='2768'>
         ENDDO<a name='2769'>
         DO NK=LDT+1,LFS-1<a name='2770'>
           TZ(NK)=0.<a name='2771'>
           QD(NK)=0.<a name='2772'>
           THTAD(NK)=0.<a name='2773'>
         ENDDO<a name='2774'>
       ENDIF d_mf<a name='2775'>
<font color=#447700>!<a name='2776'></font>
<font color=#447700>!...SET LIMITS ON THE UPDRAFT AND DOWNDRAFT MASS FLUXES SO THAT THE INFL<a name='2777'></font>
<font color=#447700>!   INTO CONVECTIVE DRAFTS FROM A GIVEN LAYER IS NO MORE THAN IS AVAILAB<a name='2778'></font>
<font color=#447700>!   IN THAT LAYER INITIALLY...<a name='2779'></font>
<font color=#447700>!     <a name='2780'></font>
       AINCMX=1000.<a name='2781'>
       LMAX=MAX0(KLCL,LFS)<a name='2782'>
       DO NK=LC,LMAX<a name='2783'>
         <font color=#447700>!IF((UER(NK)-DER(NK)).GT.1.e-3)THEN<a name='2784'></font>
         IF((UER(NK)-DER(NK)).GT.1.e-5)THEN<a name='2785'>
           AINCM1=EMS(NK)/((UER(NK)-DER(NK))*TIMEC)<a name='2786'>
           <font color=#447700>!write(*,*) 'Larry... LMAX ', LMAX, LC, UER(NK), DER(NK)<a name='2787'></font>
           AINCMX=AMIN1(AINCMX,AINCM1)<a name='2788'>
         ENDIF<a name='2789'>
       ENDDO<a name='2790'>
       AINC=1.<a name='2791'>
       IF(AINCMX.LT.AINC)AINC=AINCMX<a name='2792'>
<font color=#447700>!     <a name='2793'></font>
<font color=#447700>!...SAVE THE RELEVENT VARIABLES FOR A UNIT UPDRAFT AND DOWNDRAFT...THEY WILL <a name='2794'></font>
<font color=#447700>!...BE ITERATIVELY ADJUSTED BY THE FACTOR AINC TO SATISFY THE STABILIZATION<a name='2795'></font>
<font color=#447700>!...CLOSURE...<a name='2796'></font>
<font color=#447700>!     <a name='2797'></font>
       TDER2=TDER<a name='2798'>
       PPTFL2=PPTFLX<a name='2799'>
       DO NK=1,LTOP<a name='2800'>
         DETLQ2(NK)=DETLQ(NK)<a name='2801'>
         DETIC2(NK)=DETIC(NK)<a name='2802'>
         UDR2(NK)=UDR(NK)<a name='2803'>
         UER2(NK)=UER(NK)<a name='2804'>
         DDR2(NK)=DDR(NK)<a name='2805'>
         DER2(NK)=DER(NK)<a name='2806'>
         UMF2(NK)=UMF(NK)<a name='2807'>
         DMF2(NK)=DMF(NK)<a name='2808'>
       ENDDO<a name='2809'>
       FABE=1.<a name='2810'>
       STAB=0.95<a name='2811'>
       NOITR=0<a name='2812'>
       ISTOP=0<a name='2813'>
<font color=#447700>!<a name='2814'></font>
        IF(ISHALL.EQ.1)THEN                              <font color=#447700>! First for shallow convection<a name='2815'></font>
<font color=#447700>!<a name='2816'></font>
<font color=#447700>! No iteration for shallow convection; if turbulent kinetic energy (TKE) is available<a name='2817'></font>
<font color=#447700>! from a turbulence parameterization, scale cloud-base updraft mass flux as a function<a name='2818'></font>
<font color=#447700>! of TKE, but for now, just specify shallow-cloud mass flux using TKEMAX = 5...<a name='2819'></font>
<font color=#447700>!<a name='2820'></font>
<font color=#447700>!...find the maximum TKE value between LC and KLCL...<a name='2821'></font>
<font color=#447700>!         TKEMAX = 0.<a name='2822'></font>
          TKEMAX = 5.<a name='2823'>
          <font color=#447700>!!TKEMAX = 10.<a name='2824'></font>
<font color=#447700>!          DO 173 K = LC,KLCL<a name='2825'></font>
<font color=#447700>!            NK = KX-K+1<a name='2826'></font>
<font color=#447700>!            TKEMAX = AMAX1(TKEMAX,Q2(I,J,NK))<a name='2827'></font>
<font color=#447700>! 173      CONTINUE<a name='2828'></font>
<font color=#447700>!          TKEMAX = AMIN1(TKEMAX,10.)<a name='2829'></font>
<font color=#447700>!          TKEMAX = AMAX1(TKEMAX,5.)<a name='2830'></font>
<font color=#447700>!c         TKEMAX = 10.<a name='2831'></font>
<font color=#447700>!c...3_24_99...DPMIN was changed for shallow convection so that it is the<a name='2832'></font>
<font color=#447700>!c...          the same as for deep convection (5.E3).  Since this doubles<a name='2833'></font>
<font color=#447700>!c...          (roughly) the value of DPTHMX, add a factor of 0.5 to calcu-<a name='2834'></font>
<font color=#447700>!c...          lation of EVAC...<a name='2835'></font>
<font color=#447700>!c         EVAC  = TKEMAX*0.1<a name='2836'></font>
          EVAC  = 0.5*TKEMAX*0.1<a name='2837'>
          <font color=#447700>!!EVAC  = 0.5*TKEMAX*0.1*freq<a name='2838'></font>
<font color=#447700>!         AINC = 0.1*DPTHMX*DXIJ*DXIJ/(VMFLCL*G*TIMEC)<a name='2839'></font>
          <font color=#447700>!!AINC = EVAC*DPTHMX*DX(I,J)*DX(I,J)/(VMFLCL*G*TIMEC)<a name='2840'></font>
          <font color=#447700>!!AINC = EVAC*DPTHMX*DXSQ/(VMFLCL*G*TIMEC)<a name='2841'></font>
          AINC = EVAC*DPTHMX*DXSQ/(VMFLCL*G*TIMEC) * freq * 2.0  <font color=#447700>! Use factor of two becuase only 1/2 of pdf would be expected to rise<a name='2842'></font>
          <font color=#447700>!!write(*,*) 'Larry ... old AINC ', AINC<a name='2843'></font>
          <font color=#447700>!!AINC = WLCL*freq*DXSQ*RHOLCL/(VMFLCL) ! This version uses mass flux from CuP<a name='2844'></font>
          <font color=#447700>!!AINC = 1<a name='2845'></font>
<a name='2846'>
          TDER=TDER2*AINC<a name='2847'>
          PPTFLX=PPTFL2*AINC<a name='2848'>
          DO NK=1,LTOP<a name='2849'>
            UMF(NK)=UMF2(NK)*AINC<a name='2850'>
            DMF(NK)=DMF2(NK)*AINC<a name='2851'>
            DETLQ(NK)=DETLQ2(NK)*AINC<a name='2852'>
            DETIC(NK)=DETIC2(NK)*AINC<a name='2853'>
            UDR(NK)=UDR2(NK)*AINC<a name='2854'>
            UER(NK)=UER2(NK)*AINC<a name='2855'>
            DER(NK)=DER2(NK)*AINC<a name='2856'>
            DDR(NK)=DDR2(NK)*AINC<a name='2857'>
          ENDDO<a name='2858'>
        ENDIF                                           <font color=#447700>! Otherwise for deep convection<a name='2859'></font>
<font color=#447700>! use iterative procedure to find mass fluxes...<a name='2860'></font>
iter:     DO NCOUNT=1,10<a name='2861'>
<font color=#447700>!     <a name='2862'></font>
<font color=#447700>!*****************************************************************<a name='2863'></font>
<font color=#447700>!                                                                *<a name='2864'></font>
<font color=#447700>!           COMPUTE PROPERTIES FOR COMPENSATIONAL SUBSIDENCE     *<a name='2865'></font>
<font color=#447700>!                                                                *<a name='2866'></font>
<font color=#447700>!*****************************************************************<a name='2867'></font>
<font color=#447700>!     <a name='2868'></font>
<font color=#447700>!...DETERMINE OMEGA VALUE NECESSARY AT TOP AND BOTTOM OF EACH LAYER TO<a name='2869'></font>
<font color=#447700>!...SATISFY MASS CONTINUITY...<a name='2870'></font>
<font color=#447700>!     <a name='2871'></font>
            DTT=TIMEC<a name='2872'>
            DO NK=1,LTOP<a name='2873'>
              DOMGDP(NK)=-(UER(NK)-DER(NK)-UDR(NK)-DDR(NK))*EMSD(NK)<a name='2874'>
              IF(NK.GT.1)THEN<a name='2875'>
                OMG(NK)=OMG(NK-1)-DP(NK-1)*DOMGDP(NK-1)<a name='2876'>
                ABSOMG = ABS(OMG(NK))<a name='2877'>
                ABSOMGTC = ABSOMG*TIMEC<a name='2878'>
                FRDP = 0.75*DP(NK-1)<a name='2879'>
                IF(ABSOMGTC.GT.FRDP)THEN<a name='2880'>
                  DTT1 = FRDP/ABSOMG<a name='2881'>
                  DTT=AMIN1(DTT,DTT1)<a name='2882'>
                ENDIF<a name='2883'>
              ENDIF<a name='2884'>
            ENDDO<a name='2885'>
            DO NK=1,LTOP<a name='2886'>
              THPA(NK)=THTA0(NK)<a name='2887'>
              QPA(NK)=Q0(NK)<a name='2888'>
              NSTEP=NINT(TIMEC/DTT+1)<a name='2889'>
              DTIME=TIMEC/FLOAT(NSTEP)<a name='2890'>
              FXM(NK)=OMG(NK)*DXSQ/G<a name='2891'>
            ENDDO<a name='2892'>
<font color=#447700>!     <a name='2893'></font>
<font color=#447700>!...DO AN UPSTREAM/FORWARD-IN-TIME ADVECTION OF THETA, QV...<a name='2894'></font>
<font color=#447700>!     <a name='2895'></font>
        DO NTC=1,NSTEP<a name='2896'>
<font color=#447700>!     <a name='2897'></font>
<font color=#447700>!...ASSIGN THETA AND Q VALUES AT THE TOP AND BOTTOM OF EACH LAYER BASED<a name='2898'></font>
<font color=#447700>!...SIGN OF OMEGA...<a name='2899'></font>
<font color=#447700>!     <a name='2900'></font>
            DO  NK=1,LTOP<a name='2901'>
              THFXIN(NK)=0.<a name='2902'>
              THFXOUT(NK)=0.<a name='2903'>
              QFXIN(NK)=0.<a name='2904'>
              QFXOUT(NK)=0.<a name='2905'>
            ENDDO<a name='2906'>
            DO NK=2,LTOP<a name='2907'>
              IF(OMG(NK).LE.0.)THEN<a name='2908'>
                THFXIN(NK)=-FXM(NK)*THPA(NK-1)<a name='2909'>
                QFXIN(NK)=-FXM(NK)*QPA(NK-1)<a name='2910'>
                THFXOUT(NK-1)=THFXOUT(NK-1)+THFXIN(NK)<a name='2911'>
                QFXOUT(NK-1)=QFXOUT(NK-1)+QFXIN(NK)<a name='2912'>
              ELSE<a name='2913'>
                THFXOUT(NK)=FXM(NK)*THPA(NK)<a name='2914'>
                QFXOUT(NK)=FXM(NK)*QPA(NK)<a name='2915'>
                THFXIN(NK-1)=THFXIN(NK-1)+THFXOUT(NK)<a name='2916'>
                QFXIN(NK-1)=QFXIN(NK-1)+QFXOUT(NK)<a name='2917'>
              ENDIF<a name='2918'>
            ENDDO<a name='2919'>
<font color=#447700>!     <a name='2920'></font>
<font color=#447700>!...UPDATE THE THETA AND QV VALUES AT EACH LEVEL...<a name='2921'></font>
<font color=#447700>!     <a name='2922'></font>
            DO NK=1,LTOP<a name='2923'>
              THPA(NK)=THPA(NK)+(THFXIN(NK)+UDR(NK)*THTAU(NK)+DDR(NK)*      &amp;<a name='2924'>
                       THTAD(NK)-THFXOUT(NK)-(UER(NK)-DER(NK))*THTA0(NK))*  &amp;<a name='2925'>
                       DTIME*EMSD(NK)<a name='2926'>
              QPA(NK)=QPA(NK)+(QFXIN(NK)+UDR(NK)*QDT(NK)+DDR(NK)*QD(NK)-    &amp;<a name='2927'>
                      QFXOUT(NK)-(UER(NK)-DER(NK))*Q0(NK))*DTIME*EMSD(NK)<a name='2928'>
            ENDDO   <a name='2929'>
          ENDDO   <a name='2930'>
          DO NK=1,LTOP<a name='2931'>
            THTAG(NK)=THPA(NK)<a name='2932'>
            QG(NK)=QPA(NK)<a name='2933'>
          ENDDO<a name='2934'>
<font color=#447700>!     <a name='2935'></font>
<font color=#447700>!...CHECK TO SEE IF MIXING RATIO DIPS BELOW ZERO ANYWHERE;  IF SO, BORRO<a name='2936'></font>
<font color=#447700>!...MOISTURE FROM ADJACENT LAYERS TO BRING IT BACK UP ABOVE ZERO...<a name='2937'></font>
<font color=#447700>!     <a name='2938'></font>
        DO NK=1,LTOP<a name='2939'>
          IF(QG(NK).LT.0.)THEN<a name='2940'>
            IF(NK.EQ.1)THEN                             <font color=#447700>! JSK MODS<a name='2941'></font>
<font color=#447700>!              PRINT *,' PROBLEM WITH KF SCHEME:  ' ! JSK MODS<a name='2942'></font>
<font color=#447700>!              PRINT *,'QG = 0 AT THE SURFACE!!!!!!!'    ! JSK MODS<a name='2943'></font>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_607"> ( 'QG, QG(NK).LT.0') <font color=#447700>! JSK MODS<a name='2944'></font>
            ENDIF                                       <font color=#447700>! JSK MODS<a name='2945'></font>
            NK1=NK+1<a name='2946'>
            IF(NK.EQ.LTOP)THEN<a name='2947'>
              NK1=KLCL<a name='2948'>
            ENDIF<a name='2949'>
            TMA=QG(NK1)*EMS(NK1)<a name='2950'>
            TMB=QG(NK-1)*EMS(NK-1)<a name='2951'>
            TMM=(QG(NK)-1.E-9)*EMS(NK  )<a name='2952'>
            BCOEFF=-TMM/((TMA*TMA)/TMB+TMB)<a name='2953'>
            ACOEFF=BCOEFF*TMA/TMB<a name='2954'>
            TMB=TMB*(1.-BCOEFF)<a name='2955'>
            TMA=TMA*(1.-ACOEFF)<a name='2956'>
            IF(NK.EQ.LTOP)THEN<a name='2957'>
              QVDIFF=(QG(NK1)-TMA*EMSD(NK1))*100./QG(NK1)<a name='2958'>
<font color=#447700>!              IF(ABS(QVDIFF).GT.1.)THEN<a name='2959'></font>
<font color=#447700>!             PRINT *,'!!!WARNING!!! CLOUD BASE WATER VAPOR CHANGES BY ',     &amp;<a name='2960'></font>
<font color=#447700>!                      QVDIFF,                                                &amp;<a name='2961'></font>
<font color=#447700>!                     '% WHEN MOISTURE IS BORROWED TO PREVENT NEGATIVE ',     &amp;<a name='2962'></font>
<font color=#447700>!                     'VALUES IN KAIN-FRITSCH'<a name='2963'></font>
<font color=#447700>!              ENDIF<a name='2964'></font>
            ENDIF<a name='2965'>
            QG(NK)=1.E-9<a name='2966'>
            QG(NK1)=TMA*EMSD(NK1)<a name='2967'>
            QG(NK-1)=TMB*EMSD(NK-1)<a name='2968'>
          ENDIF<a name='2969'>
        ENDDO<a name='2970'>
        TOPOMG=(UDR(LTOP)-UER(LTOP))*DP(LTOP)*EMSD(LTOP)<a name='2971'>
        IF(ABS(TOPOMG-OMG(LTOP)).GT.1.E-3)THEN<a name='2972'>
<font color=#447700>!       WRITE(99,*)'ERROR:  MASS DOES NOT BALANCE IN KF SCHEME;            &amp;<a name='2973'></font>
<font color=#447700>!      TOPOMG, OMG =',TOPOMG,OMG(LTOP)<a name='2974'></font>
<font color=#447700>!      TOPOMG, OMG =',TOPOMG,OMG(LTOP)<a name='2975'></font>
          ISTOP=1<a name='2976'>
          IPRNT=.TRUE.<a name='2977'>
          EXIT iter<a name='2978'>
        ENDIF<a name='2979'>
<font color=#447700>!     <a name='2980'></font>
<font color=#447700>!...CONVERT THETA TO T...<a name='2981'></font>
<font color=#447700>!     <a name='2982'></font>
        DO NK=1,LTOP<a name='2983'>
          EXN(NK)=(P00/P0(NK))**(0.2854*(1.-0.28*QG(NK)))<a name='2984'>
          TG(NK)=THTAG(NK)/EXN(NK)<a name='2985'>
          TVG(NK)=TG(NK)*(1.+0.608*QG(NK))<a name='2986'>
        ENDDO<a name='2987'>
        IF(ISHALL.EQ.1)THEN<a name='2988'>
<font color=#447700>!          write(*,*) 'Larry, exiting iter ',NCOUNT <a name='2989'></font>
          if (idiagee &gt; 0) write(*,*) 'Larry, exiting iter - ncount,i,j',NCOUNT, I, J  <font color=#447700>! rce 11-may-2012<a name='2990'></font>
          EXIT iter<a name='2991'>
<font color=#447700>!          write(*,*) 'Larry, exited, no more iter'<a name='2992'></font>
        ENDIF<a name='2993'>
<font color=#447700>!     <a name='2994'></font>
<font color=#447700>!*******************************************************************<a name='2995'></font>
<font color=#447700>!                                                                  *<a name='2996'></font>
<font color=#447700>!     COMPUTE NEW CLOUD AND CHANGE IN AVAILABLE BUOYANT ENERGY.    *<a name='2997'></font>
<font color=#447700>!                                                                  *<a name='2998'></font>
<font color=#447700>!*******************************************************************<a name='2999'></font>
<font color=#447700>!     <a name='3000'></font>
<font color=#447700>!...THE FOLLOWING COMPUTATIONS ARE SIMILAR TO THAT FOR UPDRAFT<a name='3001'></font>
<font color=#447700>!     <a name='3002'></font>
<font color=#447700>!        THMIX=0.<a name='3003'></font>
          TMIX=0.<a name='3004'>
          QMIX=0.<a name='3005'>
<font color=#447700>!<a name='3006'></font>
<font color=#447700>!...FIND THE THERMODYNAMIC CHARACTERISTICS OF THE LAYER BY<a name='3007'></font>
<font color=#447700>!...MASS-WEIGHTING THE CHARACTERISTICS OF THE INDIVIDUAL MODEL<a name='3008'></font>
<font color=#447700>!...LAYERS...<a name='3009'></font>
<font color=#447700>!<a name='3010'></font>
          <font color=#447700>!!DO NK=LC,KPBL<a name='3011'></font>
          DO NK=LC,KCLDLAYER<a name='3012'>
            TMIX=TMIX+DP(NK)*TG(NK)<a name='3013'>
            QMIX=QMIX+DP(NK)*QG(NK)  <a name='3014'>
          ENDDO<a name='3015'>
          TMIX=TMIX/DPTHMX<a name='3016'>
          QMIX=QMIX/DPTHMX<a name='3017'>
          ES=ALIQ*EXP((TMIX*BLIQ-CLIQ)/(TMIX-DLIQ))<a name='3018'>
          QSS=0.622*ES/(PMIX-ES)<a name='3019'>
<font color=#447700>!     <a name='3020'></font>
<font color=#447700>!...REMOVE SUPERSATURATION FOR DIAGNOSTIC PURPOSES, IF NECESSARY...<a name='3021'></font>
<font color=#447700>!     <a name='3022'></font>
          IF(QMIX.GT.QSS)THEN<a name='3023'>
            RL=XLV0-XLV1*TMIX<a name='3024'>
            CPM=CP*(1.+0.887*QMIX)<a name='3025'>
            DSSDT=QSS*(CLIQ-BLIQ*DLIQ)/((TMIX-DLIQ)*(TMIX-DLIQ))<a name='3026'>
            DQ=(QMIX-QSS)/(1.+RL*DSSDT/CPM)<a name='3027'>
            TMIX=TMIX+RL/CP*DQ<a name='3028'>
            QMIX=QMIX-DQ<a name='3029'>
            TLCL=TMIX<a name='3030'>
          ELSE<a name='3031'>
            QMIX=AMAX1(QMIX,0.)<a name='3032'>
            EMIX=QMIX*PMIX/(0.622+QMIX)<a name='3033'>
            astrt=1.e-3<a name='3034'>
            binc=0.075<a name='3035'>
            a1=emix/aliq<a name='3036'>
            tp=(a1-astrt)/binc<a name='3037'>
            indlu=int(tp)+1<a name='3038'>
            value=(indlu-1)*binc+astrt<a name='3039'>
            aintrp=(a1-value)/binc<a name='3040'>
            tlog=aintrp*alu(indlu+1)+(1-aintrp)*alu(indlu)<a name='3041'>
            TDPT=(CLIQ-DLIQ*TLOG)/(BLIQ-TLOG)<a name='3042'>
            TLCL=TDPT-(.212+1.571E-3*(TDPT-T00)-4.36E-4*(TMIX-T00))*(TMIX-TDPT)<a name='3043'>
            TLCL=AMIN1(TLCL,TMIX)<a name='3044'>
          ENDIF<a name='3045'>
          TVLCL=TLCL*(1.+0.608*QMIX)<a name='3046'>
          ZLCL = ZMIX+(TLCL-TMIX)/GDRY<a name='3047'>
          DO NK = LC,KL<a name='3048'>
            KLCL=NK<a name='3049'>
            IF(ZLCL.LE.Z0(NK))THEN<a name='3050'>
              EXIT <a name='3051'>
            ENDIF<a name='3052'>
          ENDDO<a name='3053'>
          K=KLCL-1<a name='3054'>
          DLP=(ZLCL-Z0(K))/(Z0(KLCL)-Z0(K))<a name='3055'>
<font color=#447700>!     <a name='3056'></font>
<font color=#447700>!...ESTIMATE ENVIRONMENTAL TEMPERATURE AND MIXING RATIO AT THE LCL...<a name='3057'></font>
<font color=#447700>!     <a name='3058'></font>
          TENV=TG(K)+(TG(KLCL)-TG(K))*DLP<a name='3059'>
          QENV=QG(K)+(QG(KLCL)-QG(K))*DLP<a name='3060'>
          TVEN=TENV*(1.+0.608*QENV)<a name='3061'>
          PLCL=P0(K)+(P0(KLCL)-P0(K))*DLP<a name='3062'>
          THETEU(K)=TMIX*(1.E5/PMIX)**(0.2854*(1.-0.28*QMIX))*             &amp;<a name='3063'>
                  EXP((3374.6525/TLCL-2.5403)*QMIX*(1.+0.81*QMIX))<a name='3064'>
<font color=#447700>!     <a name='3065'></font>
<font color=#447700>!...COMPUTE ADJUSTED ABE(ABEG).<a name='3066'></font>
<font color=#447700>!     <a name='3067'></font>
          ABEG=0.<a name='3068'>
          DO NK=K,LTOPM1<a name='3069'>
            NK1=NK+1<a name='3070'>
            THETEU(NK1) = THETEU(NK)<a name='3071'>
<font color=#447700>!<a name='3072'></font>
            call <A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2DD'>tpmix2dd</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2DD_4">(p0(nk1),theteu(nk1),tgu(nk1),qgu(nk1),i,j)<a name='3073'>
<font color=#447700>!<a name='3074'></font>
            TVQU(NK1)=TGU(NK1)*(1.+0.608*QGU(NK1)-QLIQ(NK1)-QICE(NK1))<a name='3075'>
            IF(NK.EQ.K)THEN<a name='3076'>
              DZZ=Z0(KLCL)-ZLCL<a name='3077'>
              DILBE=((TVLCL+TVQU(NK1))/(TVEN+TVG(NK1))-1.)*DZZ<a name='3078'>
            ELSE<a name='3079'>
              DZZ=DZA(NK)<a name='3080'>
              DILBE=((TVQU(NK)+TVQU(NK1))/(TVG(NK)+TVG(NK1))-1.)*DZZ<a name='3081'>
            ENDIF<a name='3082'>
            IF(DILBE.GT.0.)ABEG=ABEG+DILBE*G<a name='3083'>
<font color=#447700>!<a name='3084'></font>
<font color=#447700>!...DILUTE BY ENTRAINMENT BY THE RATE AS ORIGINAL UPDRAFT...<a name='3085'></font>
<font color=#447700>!<a name='3086'></font>
            CALL <A href='../../html_code/phys/module_cu_mskf.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_8">(P0(NK1),TG(NK1),QG(NK1),THTEEG(NK1),ALIQ,BLIQ,CLIQ,DLIQ)<a name='3087'>
            THETEU(NK1)=THETEU(NK1)*DDILFRC(NK1)+THTEEG(NK1)*(1.-DDILFRC(NK1))<a name='3088'>
          ENDDO<a name='3089'>
<font color=#447700>!     <a name='3090'></font>
<font color=#447700>!...ASSUME AT LEAST 90% OF CAPE (ABE) IS REMOVED BY CONVECTION DURING<a name='3091'></font>
<font color=#447700>!...THE PERIOD TIMEC...<a name='3092'></font>
<font color=#447700>!     <a name='3093'></font>
          IF(NOITR.EQ.1)THEN<a name='3094'>
<font color=#447700>!         write(98,*)' '<a name='3095'></font>
<font color=#447700>!         write(98,*)'TAU, I, J, =',NTSD,I,J<a name='3096'></font>
<font color=#447700>!         WRITE(98,1060)FABE<a name='3097'></font>
<font color=#447700>!          GOTO 265<a name='3098'></font>
          EXIT iter<a name='3099'>
          ENDIF<a name='3100'>
          DABE=AMAX1(ABE-ABEG,0.1*ABE)<a name='3101'>
          FABE=ABEG/ABE<a name='3102'>
          IF(FABE.GT.1. .and. ISHALL.EQ.0)THEN<a name='3103'>
<font color=#447700>!          WRITE(98,*)'UPDRAFT/DOWNDRAFT COUPLET INCREASES CAPE AT THIS<a name='3104'></font>
<font color=#447700>!     *GRID POINT; NO CONVECTION ALLOWED!'<a name='3105'></font>
<font color=#447700>! wig, 29-Aug-2006: Indicate no convection occurred.<a name='3106'></font>
             ishall = 2<a name='3107'>
            RETURN  <a name='3108'>
          ENDIF<a name='3109'>
          IF(NCOUNT.NE.1)THEN<a name='3110'>
            IF(ABS(AINC-AINCOLD).LT.0.0001)THEN<a name='3111'>
              NOITR=1<a name='3112'>
              AINC=AINCOLD<a name='3113'>
              CYCLE iter<a name='3114'>
            ENDIF<a name='3115'>
            DFDA=(FABE-FABEOLD)/(AINC-AINCOLD)<a name='3116'>
            IF(DFDA.GT.0.)THEN<a name='3117'>
              NOITR=1<a name='3118'>
              AINC=AINCOLD<a name='3119'>
              CYCLE iter<a name='3120'>
            ENDIF<a name='3121'>
          ENDIF<a name='3122'>
          AINCOLD=AINC<a name='3123'>
          FABEOLD=FABE<a name='3124'>
          IF(AINC/AINCMX.GT.0.999.AND.FABE.GT.1.05-STAB)THEN<a name='3125'>
<font color=#447700>!           write(98,*)' '<a name='3126'></font>
<font color=#447700>!           write(98,*)'TAU, I, J, =',NTSD,I,J<a name='3127'></font>
<font color=#447700>!           WRITE(98,1055)FABE<a name='3128'></font>
<font color=#447700>!            GOTO 265<a name='3129'></font>
            EXIT<a name='3130'>
          ENDIF<a name='3131'>
<font color=#447700>!         If there are shallow clouds, relax 90% requiremnt<a name='3132'></font>
<font color=#447700>!         This code is not needed, exit out of shallow cu happens earlier<a name='3133'></font>
          <font color=#447700>!!IF(ISHALL .EQ. 1) THEN<a name='3134'></font>
          <font color=#447700>!!  EXIT iter<a name='3135'></font>
          IF((FABE.LE.1.05-STAB.AND.FABE.GE.0.95-STAB) .or. NCOUNT.EQ.10)THEN<a name='3136'>
            EXIT iter<a name='3137'>
          ELSE<a name='3138'>
            IF(NCOUNT.GT.10)THEN<a name='3139'>
<font color=#447700>!             write(98,*)' '<a name='3140'></font>
<font color=#447700>!             write(98,*)'TAU, I, J, =',NTSD,I,J<a name='3141'></font>
<font color=#447700>!             WRITE(98,1060)FABE<a name='3142'></font>
<font color=#447700>!             GOTO 265<a name='3143'></font>
              EXIT<a name='3144'>
            ENDIF<a name='3145'>
<font color=#447700>!     <a name='3146'></font>
<font color=#447700>!...IF MORE THAN 10% OF THE ORIGINAL CAPE REMAINS, INCREASE THE CONVECTI<a name='3147'></font>
<font color=#447700>!...MASS FLUX BY THE FACTOR AINC:<a name='3148'></font>
<font color=#447700>!     <a name='3149'></font>
            IF(FABE.EQ.0.)THEN<a name='3150'>
              AINC=AINC*0.5<a name='3151'>
            ELSE<a name='3152'>
              IF(DABE.LT.1.e-4)THEN<a name='3153'>
                NOITR=1<a name='3154'>
                AINC=AINCOLD<a name='3155'>
                CYCLE iter<a name='3156'>
              ELSE<a name='3157'>
                AINC=AINC*STAB*ABE/DABE<a name='3158'>
              ENDIF<a name='3159'>
            ENDIF<a name='3160'>
<font color=#447700>!           AINC=AMIN1(AINCMX,AINC)<a name='3161'></font>
            AINC=AMIN1(AINCMX,AINC)<a name='3162'>
<font color=#447700>!...IF AINC BECOMES VERY SMALL, EFFECTS OF CONVECTION ! JSK MODS<a name='3163'></font>
<font color=#447700>!...WILL BE MINIMAL SO JUST IGNORE IT...              ! JSK MODS<a name='3164'></font>
            IF(AINC.LT.0.05)then<a name='3165'>
<font color=#447700>! wig, 29-Aug-2006: Indicate no convection occurred.<a name='3166'></font>
               ishall = 2<a name='3167'>
              RETURN                          <font color=#447700>! JSK MODS<a name='3168'></font>
            ENDIF<a name='3169'>
<font color=#447700>!            AINC=AMAX1(AINC,0.05)                        ! JSK MODS<a name='3170'></font>
            TDER=TDER2*AINC<a name='3171'>
            PPTFLX=PPTFL2*AINC<a name='3172'>
<font color=#447700>!           IF (XTIME.LT.10.)THEN<a name='3173'></font>
<font color=#447700>!           WRITE(98,1080)LFS,LDB,LDT,TIMEC,TADVEC,NSTEP,NCOUNT,<a name='3174'></font>
<font color=#447700>!          *              FABEOLD,AINCOLD <a name='3175'></font>
<font color=#447700>!           ENDIF<a name='3176'></font>
            DO NK=1,LTOP<a name='3177'>
              UMF(NK)=UMF2(NK)*AINC<a name='3178'>
              DMF(NK)=DMF2(NK)*AINC<a name='3179'>
              DETLQ(NK)=DETLQ2(NK)*AINC<a name='3180'>
              DETIC(NK)=DETIC2(NK)*AINC<a name='3181'>
              UDR(NK)=UDR2(NK)*AINC<a name='3182'>
              UER(NK)=UER2(NK)*AINC<a name='3183'>
              DER(NK)=DER2(NK)*AINC<a name='3184'>
              DDR(NK)=DDR2(NK)*AINC<a name='3185'>
            ENDDO<a name='3186'>
<font color=#447700>!     <a name='3187'></font>
<font color=#447700>!...GO BACK UP FOR ANOTHER ITERATION...<a name='3188'></font>
<font color=#447700>!     <a name='3189'></font>
          ENDIF<a name='3190'>
        ENDDO iter<a name='3191'>
<font color=#447700>!     <a name='3192'></font>
<font color=#447700>!...COMPUTE HYDROMETEOR TENDENCIES AS IS DONE FOR T, QV...<a name='3193'></font>
<font color=#447700>!     <a name='3194'></font>
<font color=#447700>!...FRC2 IS THE FRACTION OF TOTAL CONDENSATE      !  PPT FB MODS<a name='3195'></font>
<font color=#447700>!...GENERATED THAT GOES INTO PRECIPITIATION       !  PPT FB MODS<a name='3196'></font>
<font color=#447700>!<a name='3197'></font>
<font color=#447700>!  Redistribute hydormeteors according to the final mass-flux values:<a name='3198'></font>
<font color=#447700>!<a name='3199'></font>
        IF(CPR.GT.0.)THEN <a name='3200'>
          FRC2=PPTFLX/(CPR*AINC)                    <font color=#447700>!  PPT FB MODS<a name='3201'></font>
        ELSE<a name='3202'>
           FRC2=0.<a name='3203'>
        ENDIF<a name='3204'>
        DO NK=1,LTOP<a name='3205'>
          QLPA(NK)=QL0(NK)<a name='3206'>
          QIPA(NK)=QI0(NK)<a name='3207'>
          QRPA(NK)=QR0(NK)<a name='3208'>
          QSPA(NK)=QS0(NK)<a name='3209'>
          RAINFB(NK)=PPTLIQ(NK)*AINC*FBFRC*FRC2   <font color=#447700>!  PPT FB MODS<a name='3210'></font>
          SNOWFB(NK)=PPTICE(NK)*AINC*FBFRC*FRC2   <font color=#447700>!  PPT FB MODS<a name='3211'></font>
        ENDDO<a name='3212'>
        DO NTC=1,NSTEP<a name='3213'>
<font color=#447700>!     <a name='3214'></font>
<font color=#447700>!...ASSIGN HYDROMETEORS CONCENTRATIONS AT THE TOP AND BOTTOM OF EACH LAY<a name='3215'></font>
<font color=#447700>!...BASED ON THE SIGN OF OMEGA...<a name='3216'></font>
<font color=#447700>!     <a name='3217'></font>
          DO NK=1,LTOP<a name='3218'>
            QLFXIN(NK)=0.<a name='3219'>
            QLFXOUT(NK)=0.<a name='3220'>
            QIFXIN(NK)=0.<a name='3221'>
            QIFXOUT(NK)=0.<a name='3222'>
            QRFXIN(NK)=0.<a name='3223'>
            QRFXOUT(NK)=0.<a name='3224'>
            QSFXIN(NK)=0.<a name='3225'>
            QSFXOUT(NK)=0.<a name='3226'>
          ENDDO   <a name='3227'>
          DO NK=2,LTOP<a name='3228'>
            IF(OMG(NK).LE.0.)THEN<a name='3229'>
              QLFXIN(NK)=-FXM(NK)*QLPA(NK-1)<a name='3230'>
              QIFXIN(NK)=-FXM(NK)*QIPA(NK-1)<a name='3231'>
              QRFXIN(NK)=-FXM(NK)*QRPA(NK-1)<a name='3232'>
              QSFXIN(NK)=-FXM(NK)*QSPA(NK-1)<a name='3233'>
              QLFXOUT(NK-1)=QLFXOUT(NK-1)+QLFXIN(NK)<a name='3234'>
              QIFXOUT(NK-1)=QIFXOUT(NK-1)+QIFXIN(NK)<a name='3235'>
              QRFXOUT(NK-1)=QRFXOUT(NK-1)+QRFXIN(NK)<a name='3236'>
              QSFXOUT(NK-1)=QSFXOUT(NK-1)+QSFXIN(NK)<a name='3237'>
            ELSE<a name='3238'>
              QLFXOUT(NK)=FXM(NK)*QLPA(NK)<a name='3239'>
              QIFXOUT(NK)=FXM(NK)*QIPA(NK)<a name='3240'>
              QRFXOUT(NK)=FXM(NK)*QRPA(NK)<a name='3241'>
              QSFXOUT(NK)=FXM(NK)*QSPA(NK)<a name='3242'>
              QLFXIN(NK-1)=QLFXIN(NK-1)+QLFXOUT(NK)<a name='3243'>
              QIFXIN(NK-1)=QIFXIN(NK-1)+QIFXOUT(NK)<a name='3244'>
              QRFXIN(NK-1)=QRFXIN(NK-1)+QRFXOUT(NK)<a name='3245'>
              QSFXIN(NK-1)=QSFXIN(NK-1)+QSFXOUT(NK)<a name='3246'>
            ENDIF<a name='3247'>
          ENDDO   <a name='3248'>
<font color=#447700>!     <a name='3249'></font>
<font color=#447700>!...UPDATE THE HYDROMETEOR CONCENTRATION VALUES AT EACH LEVEL...<a name='3250'></font>
<font color=#447700>!     <a name='3251'></font>
          DO NK=1,LTOP<a name='3252'>
            QLPA(NK)=QLPA(NK)+(QLFXIN(NK)+DETLQ(NK)-QLFXOUT(NK))*DTIME*EMSD(NK)<a name='3253'>
            QIPA(NK)=QIPA(NK)+(QIFXIN(NK)+DETIC(NK)-QIFXOUT(NK))*DTIME*EMSD(NK)<a name='3254'>
            QRPA(NK)=QRPA(NK)+(QRFXIN(NK)-QRFXOUT(NK)+RAINFB(NK))*DTIME*EMSD(NK)         <font color=#447700>!  PPT FB MODS<a name='3255'></font>
            QSPA(NK)=QSPA(NK)+(QSFXIN(NK)-QSFXOUT(NK)+SNOWFB(NK))*DTIME*EMSD(NK)         <font color=#447700>!  PPT FB MODS<a name='3256'></font>
          ENDDO     <a name='3257'>
        ENDDO<a name='3258'>
        DO NK=1,LTOP<a name='3259'>
          QLG(NK)=QLPA(NK)<a name='3260'>
          QIG(NK)=QIPA(NK)<a name='3261'>
          QRG(NK)=QRPA(NK)<a name='3262'>
          QSG(NK)=QSPA(NK)<a name='3263'>
        ENDDO   <a name='3264'>
<font color=#447700>!<a name='3265'></font>
<font color=#447700>!...CLEAN THINGS UP, CALCULATE CONVECTIVE FEEDBACK TENDENCIES FOR THIS<a name='3266'></font>
<font color=#447700>!...GRID POINT...<a name='3267'></font>
<font color=#447700>!     <a name='3268'></font>
<font color=#447700>!     IF (XTIME.LT.10.)THEN<a name='3269'></font>
<font color=#447700>!     WRITE(98,1080)LFS,LDB,LDT,TIMEC,TADVEC,NSTEP,NCOUNT,FABE,AINC <a name='3270'></font>
<font color=#447700>!     ENDIF<a name='3271'></font>
       IF(IPRNT)THEN  <a name='3272'>
         WRITE(98,1080)LFS,LDB,LDT,TIMEC,TADVEC,NSTEP,NCOUNT,FABE,AINC<a name='3273'>
<font color=#447700>!        flush(98)   <a name='3274'></font>
       endif  <a name='3275'>
<font color=#447700>!     <a name='3276'></font>
<font color=#447700>!...SEND FINAL PARAMETERIZED VALUES TO OUTPUT FILES...<a name='3277'></font>
<font color=#447700>!     <a name='3278'></font>
<font color=#447700>!297   IF(IPRNT)then <a name='3279'></font>
       IF(IPRNT)then <a name='3280'>
<font color=#447700>!    if(I.eq.16 .and. J.eq.41)then<a name='3281'></font>
<font color=#447700>!      IF(ISTOP.EQ.1)THEN<a name='3282'></font>
         write(98,*)<a name='3283'>
<font color=#447700>!        write(98,*)'At t(h), I, J =',float(NTSD)*72./3600.,I,J<a name='3284'></font>
         write(98,*)'P(LC), DTP, WKL, WKLCL =',p0(LC)/100.,       &amp;<a name='3285'>
                     TLCL+DTLCL+dtrh-TENV,WKL,WKLCL<a name='3286'>
         write(98,*)'TLCL, DTLCL, DTRH, TENV =',TLCL,DTLCL,       &amp;<a name='3287'>
                      DTRH,TENV   <a name='3288'>
         WRITE(98,1025)KLCL,ZLCL,DTLCL,LTOP,P0(LTOP),IFLAG,       &amp;<a name='3289'>
         TMIX-T00,PMIX,QMIX,ABE<a name='3290'>
         WRITE(98,1030)P0(LET)/100.,P0(LTOP)/100.,VMFLCL,PLCL/100.,  &amp;<a name='3291'>
         WLCL,CLDHGT(LC)<a name='3292'>
         WRITE(98,1035)PEF,PEFCBH,LC,LET,WKL,VWS <a name='3293'>
         write(98,*)'PRECIP EFFICIENCY =',PEFF <a name='3294'>
      WRITE(98,1080)LFS,LDB,LDT,TIMEC,TADVEC,NSTEP,NCOUNT,FABE,AINC<a name='3295'>
<font color=#447700>!      ENDIF<a name='3296'></font>
<font color=#447700>!!!!! HERE !!!!!!!<a name='3297'></font>
           WRITE(98,1070)'  P  ','   DP ',' DT K/D ',' DR K/D ', &amp;<a name='3298'>
                         '   OMG  ',' DOMGDP ','   UMF  ','   UER  ', &amp;<a name='3299'>
                         '   UDR  ','   DMF  ','   DER  '  ,'   DDR  ',&amp;<a name='3300'>
                         '   EMS  ','    W0  ','  DETLQ ',' DETIC '<a name='3301'>
           write(98,*)'just before DO 300...'<a name='3302'>
<font color=#447700>!          flush(98)<a name='3303'></font>
           DO NK=1,LTOP<a name='3304'>
             K=LTOP-NK+1<a name='3305'>
             DTT=(TG(K)-T0(K))*86400./TIMEC<a name='3306'>
             RL=XLV0-XLV1*TG(K)<a name='3307'>
             DR=-(QG(K)-Q0(K))*RL*86400./(TIMEC*CP)<a name='3308'>
             UDFRC=UDR(K)*TIMEC*EMSD(K)<a name='3309'>
             UEFRC=UER(K)*TIMEC*EMSD(K)<a name='3310'>
             DDFRC=DDR(K)*TIMEC*EMSD(K)<a name='3311'>
             DEFRC=-DER(K)*TIMEC*EMSD(K)<a name='3312'>
             WRITE(98,1075)P0(K)/100.,DP(K)/100.,DTT,DR,OMG(K),DOMGDP(K)*1.E4,       &amp;<a name='3313'>
             UMF(K)/1.E6,UEFRC,UDFRC,DMF(K)/1.E6,DEFRC,DDFRC,EMS(K)/1.E11,           &amp;<a name='3314'>
             W0AVG1D(K)*1.E2,DETLQ(K)*TIMEC*EMSD(K)*1.E3,DETIC(K)*  &amp;<a name='3315'>
             TIMEC*EMSD(K)*1.E3<a name='3316'>
           ENDDO<a name='3317'>
<a name='3318'>
<font color=#447700>! rce 11-may-2012 mods start -------------------------------------------<a name='3319'></font>
           if (idiagee &gt; 0) then<a name='3320'>
           write(98,'(/31x,3x,15a11)') 'umf/aeai', 'uer/aeai', 'umf/ae', 'uer/ae'<a name='3321'>
           do k = klcl-2, ltop+2<a name='3322'>
              if (k &gt;= kte) cycle<a name='3323'>
              if (k &lt;  kts) cycle<a name='3324'>
              write(98,'(31x,i3,1p,15e11.3)') k, umf(k)/(dxsq*ainc), uer(k)/(dxsq*ainc), umf(k)/dxsq, uer(k)/dxsq<a name='3325'>
           end do<a name='3326'>
<a name='3327'>
           write(98,'(/a,1p,15i11  )') 'lc, kcldx, klcl, ksvaa, let, ltop', lc, kcldlayer, klcl, ksvaa, let, ltop<a name='3328'>
           write(98,'( a,1p,15e11.3)') 'dt, timec, dx, ae=dxsq, au0, ainc', dt, timec, dx, dxsq, au0, ainc<a name='3329'>
           write(98,'(a,1p,15e11.3 )') 'au0/ae, au0*ainc/ae              ', au0/dxsq, au0*ainc/dxsq<a name='3330'>
           write(98,'(a,1p,15e11.3 )') 'vmflcl/ae, vmflcl*ainc/ae        ', vmflcl/dxsq, vmflcl*ainc/dxsq<a name='3331'>
           write(98,'(a,1p,15e11.3 )') 'evac, freq, timec, tmp1 / 2 / 3  ', &amp;<a name='3332'>
              evac, freq, timec, (dpthmx/g), (dpthmx/g)*(2.0*evac*freq), (vmflcl*ainc/dxsq)*timec<a name='3333'>
           write(98,'(a,1p,15e11.3 )') 'wlcl, wu(klcl), tpert, rpert     ', wlcl, wu(klcl), th_perturb,r_perturb<a name='3334'>
           write(98,'( a,1p,15e11.3)') 'tmpc = (umf/ae)/(wu*rho)     tmpd = umf/(wu*rho*au0*ainc)'<a name='3335'>
           write(98,'(3x,15a11)') 'p0', 'dp', 'omg/g', 'umf/ae', 'del-umf', 'uer-udr', 'uer/ae', 'udr/ae', 'wu', 'tmpc', 'tmpd', 'ems'<a name='3336'>
           do k = ltop+2, 1, -1<a name='3337'>
              if (k &gt;= kte) cycle<a name='3338'>
              tmpa = 0.0 ; tmpb = 0.0 ; tmpc = 0.0 ; tmpd = 0.0<a name='3339'>
              if (k &gt; 1 .and. k &lt; ltop) tmpa = (umf(k)-umf(k-1))/dxsq<a name='3340'>
              if (k == ltop)            tmpa = (0.0   -umf(k-1))/dxsq<a name='3341'>
              tmpb = (uer(k)-udr(k))/dxsq<a name='3342'>
              if (wu(k) &gt; 1.0e-3) tmpc = umf(k)/(wu(k)*rhoe(k)*dxsq)<a name='3343'>
              if (wu(k) &gt; 1.0e-3) tmpd = umf(k)/(wu(k)*rhoe(k)*au0*ainc)<a name='3344'>
              write(98,'(i3,1p,15e11.3)') k, p0(k), dp(k), omg(k)/g, umf(k)/dxsq, tmpa, tmpb, uer(k)/dxsq, udr(k)/dxsq, wu(k), tmpc, tmpd, ems(k)<a name='3345'>
           end do<a name='3346'>
<a name='3347'>
           write(98,'(/3x,15a11)') 't0', 'p0', 'dp', 'q0', 'qg', 'qu', 'qliq', 'qlg', 'qice', 'qig', 'qndropbb'<a name='3348'>
           do k = ltop, 1, -1<a name='3349'>
              write(98,'(i3,f11.2,1p,15e11.3)') k, t0(k)-t00, p0(k), dp(k), q0(k), qg(k), qu(k), qliq(k), qlg(k), qice(k), qig(k), &amp;<a name='3350'>
                 qndropbb(k)<a name='3351'>
           end do<a name='3352'>
           write(98,'(a)')<a name='3353'>
           end if<a name='3354'>
<font color=#447700>! rce 11-may-2012 mods end ---------------------------------------------<a name='3355'></font>
<a name='3356'>
           WRITE(98,1085)'K','P','Z','T0','TG','DT','TU','TD','Q0', &amp;<a name='3357'>
                  'QG',             &amp;<a name='3358'>
                  'DQ','QU','QD','QLG','QIG','QRG','QSG','RH0','RHG'<a name='3359'>
           DO NK=1,KL<a name='3360'>
             K=KX-NK+1<a name='3361'>
             DTT=TG(K)-T0(K)<a name='3362'>
             TUC=TU(K)-T00<a name='3363'>
             IF(K.LT.LC.OR.K.GT.LTOP)TUC=0.<a name='3364'>
             TDC=TZ(K)-T00<a name='3365'>
             IF((K.LT.LDB.OR.K.GT.LDT).AND.K.NE.LFS)TDC=0.<a name='3366'>
             IF(T0(K).LT.T00)THEN<a name='3367'>
               ES=ALIQ*EXP((BLIQ*TG(K)-CLIQ)/(TG(K)-DLIQ))<a name='3368'>
             ELSE<a name='3369'>
               ES=ALIQ*EXP((BLIQ*TG(K)-CLIQ)/(TG(K)-DLIQ))<a name='3370'>
             ENDIF  <a name='3371'>
             QGS=ES*0.622/(P0(K)-ES)<a name='3372'>
             RH0=Q0(K)/QES(K)<a name='3373'>
             RHG=QG(K)/QGS<a name='3374'>
             WRITE(98,1090)K,P0(K)/100.,Z0(K),T0(K)-T00,TG(K)-T00,DTT,TUC,            &amp;<a name='3375'>
             TDC,Q0(K)*1000.,QG(K)*1000.,(QG(K)-Q0(K))*1000.,QU(K)*                   &amp;<a name='3376'>
             1000.,QD(K)*1000.,QLG(K)*1000.,QIG(K)*1000.,QRG(K)*1000.,                &amp;<a name='3377'>
             QSG(K)*1000.,RH0,RHG<a name='3378'>
           ENDDO<a name='3379'>
<font color=#447700>!     <a name='3380'></font>
<font color=#447700>!...IF CALCULATIONS ABOVE SHOW AN ERROR IN THE MASS BUDGET, PRINT OUT A<a name='3381'></font>
<font color=#447700>!...TO BE USED LATER FOR DIAGNOSTIC PURPOSES, THEN ABORT RUN...<a name='3382'></font>
<font color=#447700>!     <a name='3383'></font>
<font color=#447700>!         IF(ISTOP.EQ.1 .or. ISHALL.EQ.1)THEN<a name='3384'></font>
<a name='3385'>
<font color=#447700>!         IF(ISHALL.NE.1)THEN<a name='3386'></font>
<font color=#447700>!            write(98,4421)i,j,iyr,imo,idy,ihr,imn<a name='3387'></font>
<font color=#447700>!           write(98)i,j,iyr,imo,idy,ihr,imn,kl<a name='3388'></font>
<font color=#447700>! 4421       format(7i4)<a name='3389'></font>
<font color=#447700>!            write(98,4422)kl<a name='3390'></font>
<font color=#447700>! 4422       format(i6) <a name='3391'></font>
            write(98,'(8a11)') 'p0', 't0', 'q0', 'u0', 'v0', 'w0avg1d', 'dp', 'tke' <font color=#447700>! rce 11-may-2012<a name='3392'></font>
            DO 310 NK = 1,KL<a name='3393'>
              k = kl - nk + 1<a name='3394'>
              write(98,4455) p0(k)/100.,t0(k)-273.16,q0(k)*1000.,       &amp;<a name='3395'>
                       u0(k),v0(k),W0AVG1D(K),dp(k),tke(k)<a name='3396'>
<font color=#447700>!             write(98) p0,t0,q0,u0,v0,w0,dp,tke<a name='3397'></font>
<font color=#447700>!           WRITE(98,1115)Z0(K),P0(K)/100.,T0(K)-273.16,Q0(K)*1000.,<a name='3398'></font>
<font color=#447700>!    *               U0(K),V0(K),DP(K)/100.,W0AVG(I,J,K)<a name='3399'></font>
 310        CONTINUE<a name='3400'>
            IF(ISTOP.EQ.1)THEN<a name='3401'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_608"> ( 'KAIN-FRITSCH, istop=1, diags' )<a name='3402'>
            ENDIF<a name='3403'>
<font color=#447700>!         ENDIF<a name='3404'></font>
  4455  format(8f11.3) <a name='3405'>
       ENDIF<a name='3406'>
        CNDTNF=(1.-EQFRC(LFS))*(QLIQ(LFS)+QICE(LFS))*DMF(LFS)<a name='3407'>
        RAINCV(I,J)=DT*PPTFLX*(1.-FBFRC)/DXSQ     <font color=#447700>!  PPT FB MODS<a name='3408'></font>
<font color=#447700>!        RAINCV(I,J)=.1*.5*DT*PPTFLX/DXSQ               !  PPT FB MODS<a name='3409'></font>
<font color=#447700>!         RNC=0.1*TIMEC*PPTFLX/DXSQ<a name='3410'></font>
        RNC=RAINCV(I,J)*NIC<a name='3411'>
       IF(ISHALL.EQ.0.AND.IPRNT)write (98,909)I,J,RNC<a name='3412'>
<a name='3413'>
<font color=#447700>!     WRITE(98,1095)CPR*AINC,TDER+PPTFLX+CNDTNF<a name='3414'></font>
<font color=#447700>!     <a name='3415'></font>
<font color=#447700>!  EVALUATE MOISTURE BUDGET...<a name='3416'></font>
<font color=#447700>!     <a name='3417'></font>
<a name='3418'>
        QINIT=0.<a name='3419'>
        QFNL=0.<a name='3420'>
        DPT=0.<a name='3421'>
        DO 315 NK=1,LTOP<a name='3422'>
          DPT=DPT+DP(NK)<a name='3423'>
          QINIT=QINIT+Q0(NK)*EMS(NK)<a name='3424'>
          QFNL=QFNL+QG(NK)*EMS(NK)<a name='3425'>
          QFNL=QFNL+(QLG(NK)+QIG(NK)+QRG(NK)+QSG(NK))*EMS(NK)<a name='3426'>
  315   CONTINUE<a name='3427'>
        QFNL=QFNL+PPTFLX*TIMEC*(1.-FBFRC)       <font color=#447700>!  PPT FB MODS<a name='3428'></font>
<font color=#447700>!        QFNL=QFNL+PPTFLX*TIMEC                 !  PPT FB MODS<a name='3429'></font>
        ERR2=(QFNL-QINIT)*100./QINIT<a name='3430'>
       IF(IPRNT)WRITE(98,1110)QINIT,QFNL,ERR2<a name='3431'>
      IF(ABS(ERR2).GT.0.05 .AND. ISTOP.EQ.0)THEN <a name='3432'>
<font color=#447700>!       write(99,*)'!!!!!!!! MOISTURE BUDGET ERROR IN KFPARA !!!'<a name='3433'></font>
<font color=#447700>!       WRITE(99,1110)QINIT,QFNL,ERR2<a name='3434'></font>
        IPRNT=.TRUE.<a name='3435'>
        ISTOP=1<a name='3436'>
            write(98,4422)kl<a name='3437'>
 4422       format(i6)<a name='3438'>
            DO 311 NK = 1,KL<a name='3439'>
              k = kl - nk + 1<a name='3440'>
<font color=#447700>!             write(99,4455) p0(k)/100.,t0(k)-273.16,q0(k)*1000.,       &amp;<a name='3441'></font>
<font color=#447700>!                      u0(k),v0(k),W0AVG1D(K),dp(k)<a name='3442'></font>
<font color=#447700>!             write(98) p0,t0,q0,u0,v0,w0,dp,tke<a name='3443'></font>
<font color=#447700>!           WRITE(98,1115)P0(K)/100.,T0(K)-273.16,Q0(K)*1000.,          &amp;<a name='3444'></font>
<font color=#447700>!                    U0(K),V0(K),W0AVG1D(K),dp(k)/100.,tke(k)<a name='3445'></font>
            WRITE(98,4456)P0(K)/100.,T0(K)-273.16,Q0(K)*1000.,          &amp;<a name='3446'>
                     U0(K),V0(K),W0AVG1D(K),dp(k)/100.,tke(k)<a name='3447'>
 311        CONTINUE<a name='3448'>
<font color=#447700>!           flush(98)<a name='3449'></font>
<a name='3450'>
<font color=#447700>!        GOTO 297<a name='3451'></font>
<font color=#447700>!         STOP 'QVERR'<a name='3452'></font>
      ENDIF<a name='3453'>
 1115 FORMAT (2X,F7.2,2X,F5.1,2X,F6.3,2(2X,F5.1),2X,F7.2,2X,F7.4)<a name='3454'>
 4456  format(8f12.3)<a name='3455'>
        IF(PPTFLX.GT.0.)THEN<a name='3456'>
          RELERR=ERR2*QINIT/(PPTFLX*TIMEC)<a name='3457'>
        ELSE<a name='3458'>
          RELERR=0.<a name='3459'>
        ENDIF<a name='3460'>
     IF(IPRNT)THEN<a name='3461'>
        WRITE(98,1120)RELERR<a name='3462'>
        WRITE(98,*)'TDER, CPR, TRPPT =',              &amp;<a name='3463'>
          TDER,CPR*AINC,TRPPT*AINC<a name='3464'>
     ENDIF<a name='3465'>
<font color=#447700>!     <a name='3466'></font>
<font color=#447700>!...FEEDBACK TO RESOLVABLE SCALE TENDENCIES.<a name='3467'></font>
<font color=#447700>!     <a name='3468'></font>
<font color=#447700>!...IF THE ADVECTIVE TIME PERIOD (TADVEC) IS LESS THAN SPECIFIED MINIMUM<a name='3469'></font>
<font color=#447700>!...TIMEC, ALLOW FEEDBACK TO OCCUR ONLY DURING TADVEC...<a name='3470'></font>
<font color=#447700>!     <a name='3471'></font>
        IF(TADVEC.LT.TIMEC)NIC=NINT(TADVEC/DT)<a name='3472'>
        NCA(I,J)=REAL(NIC)*DT  <font color=#447700>!byang <a name='3473'></font>
        IF(ISHALL.EQ.1)THEN<a name='3474'>
          TIMEC = TIMEC_SHALL   <font color=#447700>!! Changed to match other location where TIMEC is set lkb 10/31/10<a name='3475'></font>
          <font color=#447700>!!TIMEC = 2400.<a name='3476'></font>
          NCA(I,J) = NINT(TIMEC_SHALL/DT)*DT   <font color=#447700>! add 01/11/2012<a name='3477'></font>
<font color=#447700>!          NCA(I,J) = NTST*DT !byang<a name='3478'></font>
          NSHALL = NSHALL+1<a name='3479'>
        ENDIF <a name='3480'>
        DO K=1,KX<a name='3481'>
<font color=#447700>!         IF(IMOIST(INEST).NE.2)THEN<a name='3482'></font>
<font color=#447700>!<a name='3483'></font>
<font color=#447700>!...IF HYDROMETEORS ARE NOT ALLOWED, THEY MUST BE EVAPORATED OR SUBLIMAT<a name='3484'></font>
<font color=#447700>!...AND FED BACK AS VAPOR, ALONG WITH ASSOCIATED CHANGES IN TEMPERATURE.<a name='3485'></font>
<font color=#447700>!...NOTE:  THIS WILL INTRODUCE CHANGES IN THE CONVECTIVE TEMPERATURE AND<a name='3486'></font>
<font color=#447700>!...WATER VAPOR FEEDBACK TENDENCIES AND MAY LEAD TO SUPERSATURATED VALUE<a name='3487'></font>
<font color=#447700>!...OF QG...<a name='3488'></font>
<font color=#447700>!<a name='3489'></font>
<font color=#447700>!           RLC=XLV0-XLV1*TG(K)<a name='3490'></font>
<font color=#447700>!           RLS=XLS0-XLS1*TG(K)<a name='3491'></font>
<font color=#447700>!           CPM=CP*(1.+0.887*QG(K))<a name='3492'></font>
<font color=#447700>!           TG(K)=TG(K)-(RLC*(QLG(K)+QRG(K))+RLS*(QIG(K)+QSG(K)))/CPM<a name='3493'></font>
<font color=#447700>!           QG(K)=QG(K)+(QLG(K)+QRG(K)+QIG(K)+QSG(K))<a name='3494'></font>
<font color=#447700>!           DQLDT(I,J,NK)=0.<a name='3495'></font>
<font color=#447700>!           DQIDT(I,J,NK)=0.<a name='3496'></font>
<font color=#447700>!           DQRDT(I,J,NK)=0.<a name='3497'></font>
<font color=#447700>!           DQSDT(I,J,NK)=0.<a name='3498'></font>
<font color=#447700>!         ELSE<a name='3499'></font>
<font color=#447700>!<a name='3500'></font>
<font color=#447700>!...IF ICE PHASE IS NOT ALLOWED, MELT ALL FROZEN HYDROMETEORS...<a name='3501'></font>
<font color=#447700>!<a name='3502'></font>
          IF(warm_rain)THEN<a name='3503'>
<a name='3504'>
            CPM=CP*(1.+0.887*QG(K))<a name='3505'>
            TG(K)=TG(K)-(QIG(K)+QSG(K))*RLF/CPM<a name='3506'>
            DQCDT(K)=(QLG(K)+QIG(K)-QL0(K)-QI0(K))/TIMEC<a name='3507'>
            DQIDT(K)=0.<a name='3508'>
            DQRDT(K)=(QRG(K)+QSG(K)-QR0(K)-QS0(K))/TIMEC<a name='3509'>
            DQSDT(K)=0.<a name='3510'>
          ELSEIF(.NOT. F_QS)THEN<a name='3511'>
<font color=#447700>!<a name='3512'></font>
<font color=#447700>!...IF ICE PHASE IS ALLOWED, BUT MIXED PHASE IS NOT, MELT FROZEN HYDROMETEORS<a name='3513'></font>
<font color=#447700>!...BELOW THE MELTING LEVEL, FREEZE LIQUID WATER ABOVE THE MELTING LEVEL<a name='3514'></font>
<font color=#447700>!<a name='3515'></font>
            CPM=CP*(1.+0.887*QG(K))<a name='3516'>
            IF(K.LE.ML)THEN<a name='3517'>
              TG(K)=TG(K)-(QIG(K)+QSG(K))*RLF/CPM<a name='3518'>
            ELSEIF(K.GT.ML)THEN<a name='3519'>
              TG(K)=TG(K)+(QLG(K)+QRG(K))*RLF/CPM<a name='3520'>
            ENDIF<a name='3521'>
            DQCDT(K)=(QLG(K)+QIG(K)-QL0(K)-QI0(K))/TIMEC<a name='3522'>
            DQIDT(K)=0.<a name='3523'>
            DQRDT(K)=(QRG(K)+QSG(K)-QR0(K)-QS0(K))/TIMEC<a name='3524'>
            DQSDT(K)=0.<a name='3525'>
          ELSEIF(F_QS) THEN<a name='3526'>
<font color=#447700>!<a name='3527'></font>
<font color=#447700>!...IF MIXED PHASE HYDROMETEORS ARE ALLOWED, FEED BACK CONVECTIVE TENDENCIES<a name='3528'></font>
<font color=#447700>!...OF HYDROMETEORS DIRECTLY...<a name='3529'></font>
<font color=#447700>!<a name='3530'></font>
            DQCDT(K)=(QLG(K)-QL0(K))/TIMEC<a name='3531'>
            DQSDT(K)=(QSG(K)-QS0(K))/TIMEC<a name='3532'>
            DQRDT(K)=(QRG(K)-QR0(K))/TIMEC<a name='3533'>
            IF (F_QI) THEN<a name='3534'>
               DQIDT(K)=(QIG(K)-QI0(K))/TIMEC<a name='3535'>
            ELSE<a name='3536'>
               DQSDT(K)=DQSDT(K)+(QIG(K)-QI0(K))/TIMEC<a name='3537'>
            ENDIF<a name='3538'>
          ELSE<a name='3539'>
<font color=#447700>!              PRINT *,'THIS COMBINATION OF IMOIST, IEXICE, IICE NOT ALLOWED!'<a name='3540'></font>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_609"> ( 'KAIN-FRITSCH, THIS MICROPHYSICS CHOICE IS NOT ALLOWED' )<a name='3541'>
          ENDIF<a name='3542'>
          DTDT(K)=(TG(K)-T0(K))/TIMEC<a name='3543'>
          DQDT(K)=(QG(K)-Q0(K))/TIMEC<a name='3544'>
        ENDDO<a name='3545'>
<a name='3546'>
<font color=#447700>!         PRATEC(I,J)=PPTFLX*(1.-FBFRC)/DXSQ         !LD add PRATEC 21-April-2011              <a name='3547'></font>
<font color=#447700>!         RAINCV(I,J)=DT*PRATEC(I,J)                 !LD add PRATEC 21-April-2011<a name='3548'></font>
      <a name='3549'>
        RAINCV(I,J)=DT*PPTFLX*(1.-FBFRC)/DXSQ     <font color=#447700>!  PPT FB MODS<a name='3550'></font>
<a name='3551'>
<font color=#447700>!        RAINCV(I,J)=.1*.5*DT*PPTFLX/DXSQ               !  PPT FB MODS<a name='3552'></font>
<font color=#447700>!         RNC=0.1*TIMEC*PPTFLX/DXSQ<a name='3553'></font>
        RNC=RAINCV(I,J)*NIC<a name='3554'>
 909     FORMAT('AT I, J =',i3,1x,i3,' CONVECTIVE RAINFALL =',F8.4,' mm')<a name='3555'>
<font color=#447700>!      write (98,909)I,J,RNC<a name='3556'></font>
<font color=#447700>!      write (6,909)I,J,RNC<a name='3557'></font>
<font color=#447700>!      WRITE(98,*)'at NTSD =',NTSD,',No. of KF points activated =',<a name='3558'></font>
<font color=#447700>!     *            NCCNT<a name='3559'></font>
<font color=#447700>!      flush(98)<a name='3560'></font>
1000  FORMAT(' ',10A8)<a name='3561'>
1005  FORMAT(' ',F6.0,2X,F6.4,2X,F7.3,1X,F6.4,2X,4(F6.3,2X),2(F7.3,1X))<a name='3562'>
1010  FORMAT(' ',' VERTICAL VELOCITY IS NEGATIVE AT ',F4.0,' MB')<a name='3563'>
1015   FORMAT(' ','ALL REMAINING MASS DETRAINS BELOW ',F4.0,' MB')<a name='3564'>
1025   FORMAT(5X,' KLCL=',I2,' ZLCL=',F7.1,'M',                         &amp;<a name='3565'>
        ' DTLCL=',F5.2,' LTOP=',I2,' P0(LTOP)=',-2PF5.1,'MB FRZ LV=',   &amp;<a name='3566'>
        I2,' TMIX=',0PF4.1,1X,'PMIX=',-2PF6.1,' QMIX=',3PF5.1,          &amp;<a name='3567'>
        ' CAPE=',0PF7.1)<a name='3568'>
1030   FORMAT(' ',' P0(LET) = ',F6.1,' P0(LTOP) = ',F6.1,' VMFLCL =',   &amp;<a name='3569'>
      E12.3,' PLCL =',F6.1,' WLCL =',F6.3,' CLDHGT =',                  &amp;<a name='3570'>
      F8.1)<a name='3571'>
1035  FORMAT(1X,'PEF(WS)=',F4.2,'(CB)=',F4.2,'LC,LET=',2I3,'WKL='       &amp;<a name='3572'>
      ,F6.3,'VWS=',F5.2)<a name='3573'>
<font color=#447700>!1055  FORMAT('*** DEGREE OF STABILIZATION =',F5.3,                  &amp;<a name='3574'></font>
<font color=#447700>!      ', NO MORE MASS FLUX IS ALLOWED!')<a name='3575'></font>
<font color=#447700>!1060     FORMAT(' ITERATION DOES NOT CONVERGE TO GIVE THE SPECIFIED    &amp;<a name='3576'></font>
<font color=#447700>!      &amp;DEGREE OF STABILIZATION!  FABE= ',F6.4) <a name='3577'></font>
 1070 FORMAT (16A8) <a name='3578'>
 1075 FORMAT (F8.2,3(F8.2),2(F8.3),F8.2,2F8.3,F8.2,6F8.3) <a name='3579'>
 1080 FORMAT(2X,'LFS,LDB,LDT =',3I3,' TIMEC, TADVEC, NSTEP=',           &amp;<a name='3580'>
              2(1X,F5.0),I3,'NCOUNT, FABE, AINC=',I2,1X,F5.3,F6.2) <a name='3581'>
 1085 FORMAT (A3,16A7,2A8) <a name='3582'>
 1090 FORMAT (I3,F7.2,F7.0,10F7.2,4F7.3,2F8.3) <a name='3583'>
 1095 FORMAT(' ','  PPT PRODUCTION RATE= ',F10.0,' TOTAL EVAP+PPT= ',F10.0)<a name='3584'>
1105   FORMAT(' ','NET LATENT HEAT RELEASE =',E12.5,' ACTUAL HEATING =',&amp;<a name='3585'>
       E12.5,' J/KG-S, DIFFERENCE = ',F9.3,'%')<a name='3586'>
1110   FORMAT(' ','INITIAL WATER =',E12.5,' FINAL WATER =',E12.5,       &amp;<a name='3587'>
       ' TOTAL WATER CHANGE =',F8.2,'%')<a name='3588'>
<font color=#447700>! 1115 FORMAT (2X,F6.0,2X,F7.2,2X,F5.1,2X,F6.3,2(2X,F5.1),2X,F7.2,2X,F7.4)<a name='3589'></font>
1120   FORMAT(' ','MOISTURE ERROR AS FUNCTION OF TOTAL PPT =',F9.3,'%')<a name='3590'>
<font color=#447700>!<a name='3591'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3592'></font>
<font color=#447700>!--------------SAVE CLOUD TOP AND BOTTOM FOR RADIATION------------------<a name='3593'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3594'></font>
<font color=#447700>!<a name='3595'></font>
   IF (ISHALL&lt;2) THEN  <font color=#447700>! add LKB 12/23/2011 01/11/2012 only define cloud base<a name='3596'></font>
      CUTOP(I,J)=REAL(LTOP)  <font color=#447700>! if there are clouds<a name='3597'></font>
      CUBOT(I,J)=REAL(LCL)<a name='3598'>
<a name='3599'>
<font color=#447700>! rce 11-may-2012 mods start -------------------------------------------<a name='3600'></font>
      updfra = au0*ainc/dxsq<a name='3601'>
      wulcl = wu(klcl)<a name='3602'>
      wup(:) = wu(:)<a name='3603'>
      qc1d(:) = qliq(:)<a name='3604'>
      qi1d(:) = qice(:)<a name='3605'>
      qndrop1d(:) = qndropbb(:)<a name='3606'>
<a name='3607'>
<font color=#447700>! umf(k) and umfout(k) are at top of layer k<a name='3608'></font>
      umfout(kts:ltop-1) = max( 0.0, umf(kts:ltop-1)/dxsq )<a name='3609'>
      uerout(kts:ltop)   = max( 0.0, uer(kts:ltop)/dxsq )<a name='3610'>
      udrout(kts:ltop)   = max( 0.0, udr(kts:ltop)/dxsq )<a name='3611'>
<font color=#447700>! dmf(k) is at bottom of layer k; ! dmfout(k) is at top of layer k [like umf(k) and umfout(k)]<a name='3612'></font>
      dmfout(kts:ltop-1) = min( 0.0, dmf(kts+1:ltop)/dxsq )<a name='3613'>
<font color=#447700>! der(k) is negative; derout(k) is positive<a name='3614'></font>
      derout(kts:ltop)   = max( 0.0, -der(kts:ltop)/dxsq )<a name='3615'>
<font color=#447700>! ddr(k) is positive so no change needed<a name='3616'></font>
      ddrout(kts:ltop)   = max( 0.0, ddr(kts:ltop)/dxsq )<a name='3617'>
<a name='3618'>
      if ( idiagee &gt; 0 .and. ((ishall == 0) .or. (ishall == 1)) ) then<a name='3619'>
           write(98,'(/a,1p,15i11  )') 'lc, kcldx, klcl, ksvaa, let, ltop', lc, kcldlayer, klcl, ksvaa, let, ltop<a name='3620'>
           write(98,'( a,1p,15e11.3)') 'dt, timec, dx, ae=dxsq, au0, ainc', dt, timec, dx, dxsq, au0, ainc<a name='3621'>
           write(98,'(a,1p,15e11.3 )') 'au0/ae, au0*ainc/ae              ', au0/dxsq, au0*ainc/dxsq<a name='3622'>
           write(98,'(a,1p,15e11.3 )') 'wlcl, wu(klcl), tpert, rpert     ', wlcl, wu(klcl), th_perturb,r_perturb<a name='3623'>
           tmpa = 0.0 ; tmpb = 0.0<a name='3624'>
           do k = 1, ltop<a name='3625'>
              tmpa = tmpa + uerout(k)<a name='3626'>
              if (k &gt;= klcl) tmpb = tmpb + dp(k)<a name='3627'>
           end do<a name='3628'>
           write(98,'(a,1p,15e11.3 )') 'tmpu, ...*tau, tmpv, ...*area/g  ', tmpa, tmpa*dt*ntst, tmpb, (tmpb/g)*(au0*ainc/dxsq)<a name='3629'>
           write(98,'(3x,15a11)') 'p0', 'dp', 'omg/g', 'umfout', 'del-umf', 'uer-udr', 'uerout', 'udrout', &amp;<a name='3630'>
              'qc1d', 'qi1d', 'f_qc2qi', 'f_qc2pr', 'f_qi2pr'<a name='3631'>
           do k = ltop+2, 1, -1<a name='3632'>
              if (k &gt;= kte) cycle<a name='3633'>
              tmpa = 0.0 ; tmpb = 0.0 ; tmpc = 0.0 ; tmpd = 0.0<a name='3634'>
              if (k &gt; 1 ) tmpa = umfout(k)-umfout(k-1)<a name='3635'>
              if (k == 1) tmpa = umfout(k)<a name='3636'>
              tmpb =  uerout(k)-udrout(k)<a name='3637'>
              write(98,'(i3,1p,15e11.3)') k, p0(k), dp(k), omg(k)/g, umfout(k), tmpa, tmpb, uerout(k), udrout(k), &amp;<a name='3638'>
                        qc1d(k), qi1d(k), fcvt_qc_to_qi(k), fcvt_qc_to_pr(k), fcvt_qi_to_pr(k)<a name='3639'>
           end do<a name='3640'>
           write(98,'(3x,15a11)') 'p0', 'dp', '     ', 'dmfout', 'del-dmf', 'der-ddr', 'derout', 'ddrout'<a name='3641'>
           do k = ltop+2, 1, -1<a name='3642'>
              if (k &gt;= kte) cycle<a name='3643'>
              tmpa = 0.0 ; tmpb = 0.0 ; tmpc = 0.0 ; tmpd = 0.0<a name='3644'>
              if (k &gt; 1 ) tmpa = dmfout(k)-dmfout(k-1)<a name='3645'>
              if (k == 1) tmpa = dmfout(k)<a name='3646'>
              tmpb =  derout(k)-ddrout(k)<a name='3647'>
              write(98,'(i3,1p,15e11.3)') k, p0(k), dp(k), 0.0, dmfout(k), tmpa, tmpb, derout(k), ddrout(k)<a name='3648'>
           end do<a name='3649'>
      end if <font color=#447700>! ( idiagee &gt; 0 .and. ((ishall == 0) .or. (ishall == 1)) ) then<a name='3650'></font>
<font color=#447700>! rce 11-may-2012 mods end ---------------------------------------------<a name='3651'></font>
   ENDIF<a name='3652'>
<font color=#447700>!<a name='3653'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3654'></font>
<font color=#447700>! begin: wig, 21-Feb-2008<a name='3655'></font>
<font color=#447700>! Only allow shallow-Cu to occur if the cloud base is within 500 m of<a name='3656'></font>
<font color=#447700>! the top of the PBL. This prevents us from getting too many clouds<a name='3657'></font>
<font color=#447700>! in the mid-troposphere.<a name='3658'></font>
      if( ishall==1 .and. (z_at_w1d(lcl)-pblh) &gt; 500. ) ishall = 2<a name='3659'>
<font color=#447700>! end: wig, 21-Feb-2008<a name='3660'></font>
<a name='3661'>
   END SUBROUTINE  KF_cup_PARA<a name='3662'>
<a name='3663'>
<font color=#447700>!********************************************************************<a name='3664'></font>
<font color=#447700>! ***********************************************************************<a name='3665'></font>
<a name='3666'>
<A NAME='TPMIX2'><A href='../../html_code/phys/module_cu_kfcup.F.html#TPMIX2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3667'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>TPMIX2</font>(p,thes,tu,qu,qliq,qice,qnewlq,qnewic,XLV1,XLV0) <A href='../../call_to/TPMIX2.html' TARGET='index'>6</A><a name='3668'>
<font color=#447700>!<a name='3669'></font>
<font color=#447700>! Lookup table variables:<a name='3670'></font>
<font color=#447700>!     INTEGER, PARAMETER :: (KFNT=250,KFNP=220)<a name='3671'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNT,1:KFNP) :: TTAB,QSTAB<a name='3672'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNP) :: THE0K<a name='3673'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:200) :: ALU<a name='3674'></font>
<font color=#447700>!     REAL, SAVE :: RDPR,RDTHK,PLUTOP<a name='3675'></font>
<font color=#447700>! End of Lookup table variables:<a name='3676'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3677'></font>
   IMPLICIT NONE<a name='3678'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3679'></font>
   REAL,         INTENT(IN   )   :: P,THES,XLV1,XLV0<a name='3680'>
   REAL,         INTENT(OUT  )   :: QNEWLQ,QNEWIC<a name='3681'>
   REAL,         INTENT(INOUT)   :: TU,QU,QLIQ,QICE<a name='3682'>
   REAL    ::    TP,QQ,BTH,TTH,PP,T00,T10,T01,T11,Q00,Q10,Q01,Q11,          &amp;<a name='3683'>
                 TEMP,QS,QNEW,DQ,QTOT,RLL,CPP<a name='3684'>
   INTEGER ::    IPTB,ITHTB<a name='3685'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3686'></font>
<a name='3687'>
<font color=#447700>!c******** LOOKUP TABLE VARIABLES... ****************************<a name='3688'></font>
<font color=#447700>!      parameter(kfnt=250,kfnp=220)<a name='3689'></font>
<font color=#447700>!c<a name='3690'></font>
<font color=#447700>!      COMMON/KFLUT/ ttab(kfnt,kfnp),qstab(kfnt,kfnp),the0k(kfnp),<a name='3691'></font>
<font color=#447700>!     *              alu(200),rdpr,rdthk,plutop <a name='3692'></font>
<font color=#447700>!C*************************************************************** <a name='3693'></font>
<font color=#447700>!c<a name='3694'></font>
<font color=#447700>!c***********************************************************************<a name='3695'></font>
<font color=#447700>!c     scaling pressure and tt table index                         <a name='3696'></font>
<font color=#447700>!c***********************************************************************<a name='3697'></font>
<font color=#447700>!c<a name='3698'></font>
<font color=#447700>! plutop = model top pressure<a name='3699'></font>
<font color=#447700>! p = pressure level<a name='3700'></font>
<font color=#447700>! rdpr = a pressure (or 1/pressure) increment<a name='3701'></font>
<font color=#447700>! tp = a number of levels (a pressure difference divided by the increment<a name='3702'></font>
      tp=(p-plutop)*rdpr<a name='3703'>
      qq=tp-aint(tp)<a name='3704'>
      iptb=int(tp)+1<a name='3705'>
<a name='3706'>
<font color=#447700>!<a name='3707'></font>
<font color=#447700>!***********************************************************************<a name='3708'></font>
<font color=#447700>!              base and scaling factor for the                           <a name='3709'></font>
<font color=#447700>!***********************************************************************<a name='3710'></font>
<font color=#447700>!<a name='3711'></font>
<font color=#447700>!  scaling the and tt table index                                        <a name='3712'></font>
      bth=(the0k(iptb+1)-the0k(iptb))*qq+the0k(iptb)<a name='3713'>
      tth=(thes-bth)*rdthk<a name='3714'>
      pp   =tth-aint(tth)<a name='3715'>
      ithtb=int(tth)+1<a name='3716'>
       IF(IPTB.GE.220 .OR. IPTB.LE.1 .OR. ITHTB.GE.250 .OR. ITHTB.LE.1)THEN<a name='3717'>
         write(98,*)'**** OUT OF BOUNDS *********'<a name='3718'>
<font color=#447700>!        flush(98)<a name='3719'></font>
       ENDIF<a name='3720'>
<font color=#447700>!<a name='3721'></font>
      t00=ttab(ithtb  ,iptb  )<a name='3722'>
      t10=ttab(ithtb+1,iptb  )<a name='3723'>
      t01=ttab(ithtb  ,iptb+1)<a name='3724'>
      t11=ttab(ithtb+1,iptb+1)<a name='3725'>
<font color=#447700>!<a name='3726'></font>
      q00=qstab(ithtb  ,iptb  )<a name='3727'>
      q10=qstab(ithtb+1,iptb  )<a name='3728'>
      q01=qstab(ithtb  ,iptb+1)<a name='3729'>
      q11=qstab(ithtb+1,iptb+1)<a name='3730'>
<font color=#447700>!<a name='3731'></font>
<font color=#447700>!***********************************************************************<a name='3732'></font>
<font color=#447700>!              parcel temperature                                        <a name='3733'></font>
<font color=#447700>!***********************************************************************<a name='3734'></font>
<font color=#447700>!<a name='3735'></font>
      temp=(t00+(t10-t00)*pp+(t01-t00)*qq+(t00-t10-t01+t11)*pp*qq)<a name='3736'>
<font color=#447700>!<a name='3737'></font>
      qs=(q00+(q10-q00)*pp+(q01-q00)*qq+(q00-q10-q01+q11)*pp*qq)<a name='3738'>
<font color=#447700>!<a name='3739'></font>
      DQ=QS-QU<a name='3740'>
      IF(DQ.LE.0.)THEN<a name='3741'>
        QNEW=QU-QS<a name='3742'>
        QU=QS<a name='3743'>
      ELSE <a name='3744'>
<font color=#447700>!<a name='3745'></font>
<font color=#447700>!   IF THE PARCEL IS SUBSATURATED, TEMPERATURE AND MIXING RATIO MUST BE<a name='3746'></font>
<font color=#447700>!   ADJUSTED...IF LIQUID WATER IS PRESENT, IT IS ALLOWED TO EVAPORATE<a name='3747'></font>
<font color=#447700>! <a name='3748'></font>
        QNEW=0.<a name='3749'>
        QTOT=QLIQ+QICE<a name='3750'>
<font color=#447700>!<a name='3751'></font>
<font color=#447700>!   IF THERE IS ENOUGH LIQUID OR ICE TO SATURATE THE PARCEL, TEMP STAYS AT ITS<a name='3752'></font>
<font color=#447700>!   WET BULB VALUE, VAPOR MIXING RATIO IS AT SATURATED LEVEL, AND THE MIXING<a name='3753'></font>
<font color=#447700>!   RATIOS OF LIQUID AND ICE ARE ADJUSTED TO MAKE UP THE ORIGINAL SATURATION<a name='3754'></font>
<font color=#447700>!   DEFICIT... OTHERWISE, ANY AVAILABLE LIQ OR ICE VAPORIZES AND APPROPRIATE<a name='3755'></font>
<font color=#447700>!   ADJUSTMENTS TO PARCEL TEMP; VAPOR, LIQUID, AND ICE MIXING RATIOS ARE MADE.<a name='3756'></font>
<font color=#447700>!<a name='3757'></font>
<font color=#447700>!...subsaturated values only occur in calculations involving various mixtures of<a name='3758'></font>
<font color=#447700>!...updraft and environmental air for estimation of entrainment and detrainment.<a name='3759'></font>
<font color=#447700>!...For these purposes, assume that reasonable estimates can be given using <a name='3760'></font>
<font color=#447700>!...liquid water saturation calculations only - i.e., ignore the effect of the<a name='3761'></font>
<font color=#447700>!...ice phase in this process only...will not affect conservative properties...<a name='3762'></font>
<font color=#447700>!<a name='3763'></font>
        IF(QTOT.GE.DQ)THEN<a name='3764'>
          qliq=qliq-dq*qliq/(qtot+1.e-10)<a name='3765'>
          qice=qice-dq*qice/(qtot+1.e-10)<a name='3766'>
          QU=QS<a name='3767'>
        ELSE<a name='3768'>
          RLL=XLV0-XLV1*TEMP<a name='3769'>
          CPP=1004.5*(1.+0.89*QU)<a name='3770'>
          IF(QTOT.LT.1.E-10)THEN<a name='3771'>
<font color=#447700>!<a name='3772'></font>
<font color=#447700>!...IF NO LIQUID WATER OR ICE IS AVAILABLE, TEMPERATURE IS GIVEN BY:<a name='3773'></font>
            TEMP=TEMP+RLL*(DQ/(1.+DQ))/CPP<a name='3774'>
          ELSE<a name='3775'>
<font color=#447700>!<a name='3776'></font>
<font color=#447700>!...IF SOME LIQ WATER/ICE IS AVAILABLE, BUT NOT ENOUGH TO ACHIEVE SATURATION,<a name='3777'></font>
<font color=#447700>!   THE TEMPERATURE IS GIVEN BY:<a name='3778'></font>
<font color=#447700>!<a name='3779'></font>
            TEMP=TEMP+RLL*((DQ-QTOT)/(1+DQ-QTOT))/CPP<a name='3780'>
            QU=QU+QTOT<a name='3781'>
            QTOT=0.<a name='3782'>
            QLIQ=0.<a name='3783'>
            QICE=0.<a name='3784'>
          ENDIF<a name='3785'>
        ENDIF<a name='3786'>
      ENDIF<a name='3787'>
      TU=TEMP<a name='3788'>
      qnewlq=qnew<a name='3789'>
      qnewic=0.<a name='3790'>
<font color=#447700>!<a name='3791'></font>
   END SUBROUTINE TPMIX2<a name='3792'>
<font color=#447700>!******************************************************************************<a name='3793'></font>
<A NAME='DTFRZNEW'><A href='../../html_code/phys/module_cu_kfcup.F.html#DTFRZNEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3794'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>DTFRZNEW</font>(TU,P,THTEU,QU,QFRZ,QICE,ALIQ,BLIQ,CLIQ,DLIQ) <A href='../../call_to/DTFRZNEW.html' TARGET='index'>3</A><a name='3795'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3796'></font>
   IMPLICIT NONE<a name='3797'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3798'></font>
   REAL,         INTENT(IN   )   :: P,QFRZ,ALIQ,BLIQ,CLIQ,DLIQ<a name='3799'>
   REAL,         INTENT(INOUT)   :: TU,THTEU,QU,QICE<a name='3800'>
   REAL    ::    RLC,RLS,RLF,CPP,A,DTFRZ,ES,QS,DQEVAP,PII<a name='3801'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3802'></font>
<font color=#447700>!<a name='3803'></font>
<font color=#447700>!...ALLOW THE FREEZING OF LIQUID WATER IN THE UPDRAFT TO PROCEED AS AN <a name='3804'></font>
<font color=#447700>!...APPROXIMATELY LINEAR FUNCTION OF TEMPERATURE IN THE TEMPERATURE RANGE <a name='3805'></font>
<font color=#447700>!...TTFRZ TO TBFRZ...<a name='3806'></font>
<font color=#447700>!...FOR COLDER TERMPERATURES, FREEZE ALL LIQUID WATER...<a name='3807'></font>
<font color=#447700>!...THERMODYNAMIC PROPERTIES ARE STILL CALCULATED WITH RESPECT TO LIQUID WATER<a name='3808'></font>
<font color=#447700>!...TO ALLOW THE USE OF LOOKUP TABLE TO EXTRACT TMP FROM THETAE...<a name='3809'></font>
<font color=#447700>!<a name='3810'></font>
      RLC=2.5E6-2369.276*(TU-273.16)<a name='3811'>
      RLS=2833922.-259.532*(TU-273.16)<a name='3812'>
      RLF=RLS-RLC<a name='3813'>
      CPP=1004.5*(1.+0.89*QU)<a name='3814'>
<font color=#447700>!<a name='3815'></font>
<font color=#447700>!  A = D(es)/DT IS THAT CALCULATED FROM BUCK (1981) EMPERICAL FORMULAS<a name='3816'></font>
<font color=#447700>!  FOR SATURATION VAPOR PRESSURE...<a name='3817'></font>
<font color=#447700>!<a name='3818'></font>
      A=(CLIQ-BLIQ*DLIQ)/((TU-DLIQ)*(TU-DLIQ))<a name='3819'>
      DTFRZ = RLF*QFRZ/(CPP+RLS*QU*A)<a name='3820'>
      TU = TU+DTFRZ<a name='3821'>
      <a name='3822'>
      ES = ALIQ*EXP((BLIQ*TU-CLIQ)/(TU-DLIQ))<a name='3823'>
      QS = ES*0.622/(P-ES)<a name='3824'>
<font color=#447700>!<a name='3825'></font>
<font color=#447700>!...FREEZING WARMS THE AIR AND IT BECOMES UNSATURATED...ASSUME THAT SOME OF THE <a name='3826'></font>
<font color=#447700>!...LIQUID WATER THAT IS AVAILABLE FOR FREEZING EVAPORATES TO MAINTAIN SATURA-<a name='3827'></font>
<font color=#447700>!...TION...SINCE THIS WATER HAS ALREADY BEEN TRANSFERRED TO THE ICE CATEGORY,<a name='3828'></font>
<font color=#447700>!...SUBTRACT IT FROM ICE CONCENTRATION, THEN SET UPDRAFT MIXING RATIO AT THE NEW<a name='3829'></font>
<font color=#447700>!...TEMPERATURE TO THE SATURATION VALUE...<a name='3830'></font>
<font color=#447700>!<a name='3831'></font>
      DQEVAP = QS-QU<a name='3832'>
      QICE = QICE-DQEVAP<a name='3833'>
      QU = QU+DQEVAP<a name='3834'>
      PII=(1.E5/P)**(0.2854*(1.-0.28*QU))<a name='3835'>
      THTEU=TU*PII*EXP((3374.6525/TU-2.5403)*QU*(1.+0.81*QU))<a name='3836'>
<font color=#447700>!<a name='3837'></font>
   END SUBROUTINE DTFRZNEW<a name='3838'>
<font color=#447700>! --------------------------------------------------------------------------------<a name='3839'></font>
<a name='3840'>
<A NAME='CONDLOAD'><A href='../../html_code/phys/module_cu_kfcup.F.html#CONDLOAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3841'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>CONDLOAD</font>(QLIQ,QICE,WTW,DZ,BOTERM,ENTERM,RATE,QNEWLQ,           &amp; <A href='../../call_to/CONDLOAD.html' TARGET='index'>3</A><a name='3842'>
                          QNEWIC,QLQOUT,QICOUT,G)<a name='3843'>
<a name='3844'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3845'></font>
   IMPLICIT NONE<a name='3846'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3847'></font>
<font color=#447700>!  9/18/88...THIS PRECIPITATION FALLOUT SCHEME IS BASED ON THE SCHEME US<a name='3848'></font>
<font color=#447700>!  BY OGURA AND CHO (1973).  LIQUID WATER FALLOUT FROM A PARCEL IS CAL-<a name='3849'></font>
<font color=#447700>!  CULATED USING THE EQUATION DQ=-RATE*Q*DT, BUT TO SIMULATE A QUASI-<a name='3850'></font>
<font color=#447700>!  CONTINUOUS PROCESS, AND TO ELIMINATE A DEPENDENCY ON VERTICAL<a name='3851'></font>
<font color=#447700>!  RESOLUTION THIS IS EXPRESSED AS Q=Q*EXP(-RATE*DZ).<a name='3852'></font>
<a name='3853'>
      REAL, INTENT(IN   )   :: G<a name='3854'>
      REAL, INTENT(IN   )   :: DZ,BOTERM,ENTERM,RATE<a name='3855'>
      REAL, INTENT(INOUT)   :: QLQOUT,QICOUT,WTW,QLIQ,QICE,QNEWLQ,QNEWIC<a name='3856'>
      REAL :: QTOT,QNEW,QEST,G1,WAVG,CONV,RATIO3,OLDQ,RATIO4,DQ,PPTDRG<a name='3857'>
<a name='3858'>
<font color=#447700>!<a name='3859'></font>
<font color=#447700>!  9/18/88...THIS PRECIPITATION FALLOUT SCHEME IS BASED ON THE SCHEME US<a name='3860'></font>
<font color=#447700>!  BY OGURA AND CHO (1973).  LIQUID WATER FALLOUT FROM A PARCEL IS CAL- <a name='3861'></font>
<font color=#447700>!  CULATED USING THE EQUATION DQ=-RATE*Q*DT, BUT TO SIMULATE A QUASI-   <a name='3862'></font>
<font color=#447700>!  CONTINUOUS PROCESS, AND TO ELIMINATE A DEPENDENCY ON VERTICAL        <a name='3863'></font>
<font color=#447700>!  RESOLUTION THIS IS EXPRESSED AS Q=Q*EXP(-RATE*DZ).                   <a name='3864'></font>
      QTOT=QLIQ+QICE                                                    <a name='3865'>
      QNEW=QNEWLQ+QNEWIC                                                <a name='3866'>
<font color=#447700>!                                                                       <a name='3867'></font>
<font color=#447700>!  ESTIMATE THE VERTICAL VELOCITY SO THAT AN AVERAGE VERTICAL VELOCITY <a name='3868'></font>
<font color=#447700>!  BE CALCULATED TO ESTIMATE THE TIME REQUIRED FOR ASCENT BETWEEN MODEL <a name='3869'></font>
<font color=#447700>!  LEVELS...                                                            <a name='3870'></font>
<font color=#447700>!                                                                       <a name='3871'></font>
      QEST=0.5*(QTOT+QNEW)                                              <a name='3872'>
      G1=WTW+BOTERM-ENTERM-2.*G*DZ*QEST/1.5                             <a name='3873'>
      IF(G1.LT.0.0)G1=0.                                                <a name='3874'>
      WAVG=0.5*(SQRT(WTW)+SQRT(G1))                                      <a name='3875'>
      CONV=RATE*DZ/max(WAVG,1e-7) <font color=#447700>!wig, 12-Sep-2006: added div by 0 check<a name='3876'></font>
<font color=#447700>!                                                                       <a name='3877'></font>
<font color=#447700>!  RATIO3 IS THE FRACTION OF LIQUID WATER IN FRESH CONDENSATE, RATIO4 IS<a name='3878'></font>
<font color=#447700>!  THE FRACTION OF LIQUID WATER IN THE TOTAL AMOUNT OF CONDENSATE INVOLV<a name='3879'></font>
<font color=#447700>!  IN THE PRECIPITATION PROCESS - NOTE THAT ONLY 60% OF THE FRESH CONDEN<a name='3880'></font>
<font color=#447700>!  SATE IS IS ALLOWED TO PARTICIPATE IN THE CONVERSION PROCESS...       <a name='3881'></font>
<font color=#447700>!                                                                       <a name='3882'></font>
      RATIO3=QNEWLQ/(QNEW+1.E-8)                                       <a name='3883'>
<font color=#447700>!     OLDQ=QTOT                                                         <a name='3884'></font>
      QTOT=QTOT+0.6*QNEW                                                <a name='3885'>
      OLDQ=QTOT                                                         <a name='3886'>
      RATIO4=(0.6*QNEWLQ+QLIQ)/(QTOT+1.E-8)                            <a name='3887'>
      QTOT=QTOT*EXP(-CONV)                                              <a name='3888'>
<font color=#447700>!                                                                       <a name='3889'></font>
<font color=#447700>!  DETERMINE THE AMOUNT OF PRECIPITATION THAT FALLS OUT OF THE UPDRAFT  <a name='3890'></font>
<font color=#447700>!  PARCEL AT THIS LEVEL...                                              <a name='3891'></font>
<font color=#447700>!                                                                       <a name='3892'></font>
      DQ=OLDQ-QTOT                                                      <a name='3893'>
      QLQOUT=RATIO4*DQ                                                  <a name='3894'>
      QICOUT=(1.-RATIO4)*DQ                                             <a name='3895'>
<font color=#447700>!                                                                       <a name='3896'></font>
<font color=#447700>!  ESTIMATE THE MEAN LOAD OF CONDENSATE ON THE UPDRAFT IN THE LAYER, CAL<a name='3897'></font>
<font color=#447700>!  LATE VERTICAL VELOCITY                                               <a name='3898'></font>
<font color=#447700>!                                                                       <a name='3899'></font>
      PPTDRG=0.5*(OLDQ+QTOT-0.2*QNEW)                                   <a name='3900'>
      WTW=WTW+BOTERM-ENTERM-2.*G*DZ*PPTDRG/1.5                          <a name='3901'>
      IF(ABS(WTW).LT.1.E-4)WTW=1.E-4<a name='3902'>
<font color=#447700>!                                                                       <a name='3903'></font>
<font color=#447700>!  DETERMINE THE NEW LIQUID WATER AND ICE CONCENTRATIONS INCLUDING LOSSE<a name='3904'></font>
<font color=#447700>!  DUE TO PRECIPITATION AND GAINS FROM CONDENSATION...                  <a name='3905'></font>
<font color=#447700>!                                                                       <a name='3906'></font>
      QLIQ=RATIO4*QTOT+RATIO3*0.4*QNEW                                  <a name='3907'>
      QICE=(1.-RATIO4)*QTOT+(1.-RATIO3)*0.4*QNEW                        <a name='3908'>
      QNEWLQ=0.                                                         <a name='3909'>
      QNEWIC=0.                                                         <a name='3910'>
<a name='3911'>
   END SUBROUTINE CONDLOAD<a name='3912'>
<a name='3913'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3914'></font>
<A NAME='PROF5'><A href='../../html_code/phys/module_cu_kfcup.F.html#PROF5' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3915'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>PROF5</font>(EQ,EE,UD)                                         <A href='../../call_to/PROF5.html' TARGET='index'>3</A><a name='3916'>
<font color=#447700>!<a name='3917'></font>
<font color=#447700>!***********************************************************************<a name='3918'></font>
<font color=#447700>!*****    GAUSSIAN TYPE MIXING PROFILE....******************************<a name='3919'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3920'></font>
<font color=#447700>!  THIS SUBROUTINE INTEGRATES THE AREA UNDER THE CURVE IN THE GAUSSIAN  <a name='3921'></font>
<font color=#447700>!  DISTRIBUTION...THE NUMERICAL APPROXIMATION TO THE INTEGRAL IS TAKEN FROM<a name='3922'></font>
<font color=#447700>!  "HANDBOOK OF MATHEMATICAL FUNCTIONS WITH FORMULAS, GRAPHS AND MATHEMATICS TABLES"<a name='3923'></font>
<font color=#447700>!  ED. BY ABRAMOWITZ AND STEGUN, NATL BUREAU OF STANDARDS APPLIED<a name='3924'></font>
<font color=#447700>!  MATHEMATICS SERIES.  JUNE, 1964., MAY, 1968.                         <a name='3925'></font>
<font color=#447700>!                                     JACK KAIN                         <a name='3926'></font>
<font color=#447700>!                                     7/6/89                            <a name='3927'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3928'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3929'></font>
   IMPLICIT NONE<a name='3930'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3931'></font>
   REAL,         INTENT(IN   )   :: EQ<a name='3932'>
   REAL,         INTENT(INOUT)   :: EE,UD<a name='3933'>
   REAL ::       SQRT2P,A1,A2,A3,P,SIGMA,FE,X,Y,EY,E45,T1,T2,C1,C2<a name='3934'>
<a name='3935'>
      DATA SQRT2P,A1,A2,A3,P,SIGMA,FE/2.506628,0.4361836,-0.1201676,       &amp;<a name='3936'>
           0.9372980,0.33267,0.166666667,0.202765151/                        <a name='3937'>
      X=(EQ-0.5)/SIGMA                                                  <a name='3938'>
      Y=6.*EQ-3.                                                        <a name='3939'>
      EY=EXP(Y*Y/(-2))                                                  <a name='3940'>
      E45=EXP(-4.5)                                                     <a name='3941'>
      T2=1./(1.+P*ABS(Y))                                               <a name='3942'>
      T1=0.500498                                                       <a name='3943'>
      C1=A1*T1+A2*T1*T1+A3*T1*T1*T1                                     <a name='3944'>
      C2=A1*T2+A2*T2*T2+A3*T2*T2*T2                                     <a name='3945'>
      IF(Y.GE.0.)THEN                                                   <a name='3946'>
        EE=SIGMA*(0.5*(SQRT2P-E45*C1-EY*C2)+SIGMA*(E45-EY))-E45*EQ*EQ/2.<a name='3947'>
        UD=SIGMA*(0.5*(EY*C2-E45*C1)+SIGMA*(E45-EY))-E45*(0.5+EQ*EQ/2.-    &amp;<a name='3948'>
           EQ)                                                          <a name='3949'>
      ELSE                                                              <a name='3950'>
        EE=SIGMA*(0.5*(EY*C2-E45*C1)+SIGMA*(E45-EY))-E45*EQ*EQ/2.       <a name='3951'>
        UD=SIGMA*(0.5*(SQRT2P-E45*C1-EY*C2)+SIGMA*(E45-EY))-E45*(0.5+EQ*   &amp;<a name='3952'>
           EQ/2.-EQ)                                                    <a name='3953'>
      ENDIF                                                             <a name='3954'>
      EE=EE/FE                                                          <a name='3955'>
      UD=UD/FE                                                          <a name='3956'>
<a name='3957'>
   END SUBROUTINE PROF5<a name='3958'>
<a name='3959'>
<font color=#447700>! ------------------------------------------------------------------------<a name='3960'></font>
<A NAME='TPMIX2DD'><A href='../../html_code/phys/module_cu_kfcup.F.html#TPMIX2DD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3961'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>TPMIX2DD</font>(p,thes,ts,qs,i,j) <A href='../../call_to/TPMIX2DD.html' TARGET='index'>8</A><a name='3962'>
<font color=#447700>!<a name='3963'></font>
<font color=#447700>! Lookup table variables:<a name='3964'></font>
<font color=#447700>!     INTEGER, PARAMETER :: (KFNT=250,KFNP=220)<a name='3965'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNT,1:KFNP) :: TTAB,QSTAB<a name='3966'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNP) :: THE0K<a name='3967'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:200) :: ALU<a name='3968'></font>
<font color=#447700>!     REAL, SAVE :: RDPR,RDTHK,PLUTOP<a name='3969'></font>
<font color=#447700>! End of Lookup table variables:<a name='3970'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3971'></font>
   IMPLICIT NONE<a name='3972'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3973'></font>
   REAL,         INTENT(IN   )   :: P,THES<a name='3974'>
   REAL,         INTENT(INOUT)   :: TS,QS<a name='3975'>
   INTEGER,      INTENT(IN   )   :: i,j     <font color=#447700>! avail for debugging<a name='3976'></font>
   REAL    ::    TP,QQ,BTH,TTH,PP,T00,T10,T01,T11,Q00,Q10,Q01,Q11<a name='3977'>
   INTEGER ::    IPTB,ITHTB<a name='3978'>
   CHARACTER*256 :: MESS<a name='3979'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3980'></font>
<a name='3981'>
<font color=#447700>!<a name='3982'></font>
<font color=#447700>!******** LOOKUP TABLE VARIABLES (F77 format)... ****************************<a name='3983'></font>
<font color=#447700>!     parameter(kfnt=250,kfnp=220)<a name='3984'></font>
<font color=#447700>!<a name='3985'></font>
<font color=#447700>!     COMMON/KFLUT/ ttab(kfnt,kfnp),qstab(kfnt,kfnp),the0k(kfnp),        &amp;<a name='3986'></font>
<font color=#447700>!                   alu(200),rdpr,rdthk,plutop <a name='3987'></font>
<font color=#447700>!*************************************************************** <a name='3988'></font>
<font color=#447700>!<a name='3989'></font>
<font color=#447700>!***********************************************************************<a name='3990'></font>
<font color=#447700>!     scaling pressure and tt table index                         <a name='3991'></font>
<font color=#447700>!***********************************************************************<a name='3992'></font>
<font color=#447700>!<a name='3993'></font>
      tp=(p-plutop)*rdpr<a name='3994'>
      qq=tp-aint(tp)<a name='3995'>
      iptb=int(tp)+1<a name='3996'>
<font color=#447700>!<a name='3997'></font>
<font color=#447700>!***********************************************************************<a name='3998'></font>
<font color=#447700>!              base and scaling factor for the                           <a name='3999'></font>
<font color=#447700>!***********************************************************************<a name='4000'></font>
<font color=#447700>!<a name='4001'></font>
<font color=#447700>!  scaling the and tt table index                                        <a name='4002'></font>
      bth=(the0k(iptb+1)-the0k(iptb))*qq+the0k(iptb)<a name='4003'>
      tth=(thes-bth)*rdthk<a name='4004'>
      pp   =tth-aint(tth)<a name='4005'>
      ithtb=int(tth)+1<a name='4006'>
<font color=#447700>!<a name='4007'></font>
      t00=ttab(ithtb  ,iptb  )<a name='4008'>
      t10=ttab(ithtb+1,iptb  )<a name='4009'>
      t01=ttab(ithtb  ,iptb+1)<a name='4010'>
      t11=ttab(ithtb+1,iptb+1)<a name='4011'>
<font color=#447700>!<a name='4012'></font>
      q00=qstab(ithtb  ,iptb  )<a name='4013'>
      q10=qstab(ithtb+1,iptb  )<a name='4014'>
      q01=qstab(ithtb  ,iptb+1)<a name='4015'>
      q11=qstab(ithtb+1,iptb+1)<a name='4016'>
<font color=#447700>!<a name='4017'></font>
<font color=#447700>!***********************************************************************<a name='4018'></font>
<font color=#447700>!              parcel temperature and saturation mixing ratio                                        <a name='4019'></font>
<font color=#447700>!***********************************************************************<a name='4020'></font>
<font color=#447700>!<a name='4021'></font>
      ts=(t00+(t10-t00)*pp+(t01-t00)*qq+(t00-t10-t01+t11)*pp*qq)<a name='4022'>
<font color=#447700>!<a name='4023'></font>
      qs=(q00+(q10-q00)*pp+(q01-q00)*qq+(q00-q10-q01+q11)*pp*qq)<a name='4024'>
<font color=#447700>!<a name='4025'></font>
   END SUBROUTINE TPMIX2DD<a name='4026'>
<a name='4027'>
<font color=#447700>! -----------------------------------------------------------------------<a name='4028'></font>
<A NAME='ENVIRTHT'><A href='../../html_code/phys/module_cu_kfcup.F.html#ENVIRTHT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4029'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ENVIRTHT</font>(P1,T1,Q1,THT1,ALIQ,BLIQ,CLIQ,DLIQ)                        <A href='../../call_to/ENVIRTHT.html' TARGET='index'>12</A><a name='4030'>
<font color=#447700>!<a name='4031'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4032'></font>
   IMPLICIT NONE<a name='4033'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4034'></font>
   REAL,         INTENT(IN   )   :: P1,T1,Q1,ALIQ,BLIQ,CLIQ,DLIQ<a name='4035'>
   REAL,         INTENT(INOUT)   :: THT1<a name='4036'>
   REAL    ::    EE,TLOG,ASTRT,AINC,A1,TP,VALUE,AINTRP,TDPT,TSAT,THT,      &amp;<a name='4037'>
                 T00,P00,C1,C2,C3,C4,C5<a name='4038'>
   INTEGER ::    INDLU<a name='4039'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4040'></font>
      DATA T00,P00,C1,C2,C3,C4,C5/273.16,1.E5,3374.6525,2.5403,3114.834,   &amp;<a name='4041'>
           0.278296,1.0723E-3/                                          <a name='4042'>
<font color=#447700>!                                                                       <a name='4043'></font>
<font color=#447700>!  CALCULATE ENVIRONMENTAL EQUIVALENT POTENTIAL TEMPERATURE...          <a name='4044'></font>
<font color=#447700>!                                                                       <a name='4045'></font>
<font color=#447700>! NOTE: Calculations for mixed/ice phase no longer used...jsk 8/00<a name='4046'></font>
<font color=#447700>!<a name='4047'></font>
      EE=Q1*P1/(0.622+Q1)                                             <a name='4048'>
<font color=#447700>!     TLOG=ALOG(EE/ALIQ)                                              <a name='4049'></font>
<font color=#447700>! ...calculate LOG term using lookup table...<a name='4050'></font>
<font color=#447700>!<a name='4051'></font>
      astrt=1.e-3<a name='4052'>
      ainc=0.075<a name='4053'>
      a1=ee/aliq<a name='4054'>
      tp=(a1-astrt)/ainc<a name='4055'>
      indlu=int(tp)+1<a name='4056'>
      value=(indlu-1)*ainc+astrt<a name='4057'>
      aintrp=(a1-value)/ainc<a name='4058'>
      tlog=aintrp*alu(indlu+1)+(1-aintrp)*alu(indlu)<a name='4059'>
<font color=#447700>!<a name='4060'></font>
      TDPT=(CLIQ-DLIQ*TLOG)/(BLIQ-TLOG)                               <a name='4061'>
      TSAT=TDPT-(.212+1.571E-3*(TDPT-T00)-4.36E-4*(T1-T00))*(T1-TDPT) <a name='4062'>
      THT=T1*(P00/P1)**(0.2854*(1.-0.28*Q1))                          <a name='4063'>
      THT1=THT*EXP((C1/TSAT-C2)*Q1*(1.+0.81*Q1))                      <a name='4064'>
<font color=#447700>!<a name='4065'></font>
  END SUBROUTINE ENVIRTHT                                                              <a name='4066'>
<font color=#447700>! ***********************************************************************<a name='4067'></font>
<font color=#447700>!====================================================================<a name='4068'></font>
<A NAME='KF_CUP_INIT'><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4069'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>kf_cup_init</font>(RTHCUTEN,RQVCUTEN,RQCCUTEN,RQRCUTEN,      &amp; <A href='../../call_to/KF_CUP_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/KF_CUP_INIT.html' TARGET='index'>1</A><a name='4070'>
                     RQICUTEN,RQSCUTEN,NCA,W0AVG,P_QI,P_QS,         &amp;<a name='4071'>
                     SVP1,SVP2,SVP3,SVPT0,                          &amp;<a name='4072'>
                     cupflag,cldfra_cup,cldfratend_cup,             &amp; <font color=#447700>!CuP, wig 18-Sep-2006<a name='4073'></font>
                     shall,                                         &amp; <font color=#447700>!CuP, wig 18-Sep-2006<a name='4074'></font>
                     tcloud_cup,                                    &amp; <font color=#447700>!CuP, rce 10-may-2012<a name='4075'></font>
                     P_FIRST_SCALAR,restart,allowed_to_read,        &amp;<a name='4076'>
                     ids, ide, jds, jde, kds, kde,                  &amp;<a name='4077'>
                     ims, ime, jms, jme, kms, kme,                  &amp;<a name='4078'>
                     its, ite, jts, jte, kts, kte                   )<a name='4079'>
<font color=#447700>!--------------------------------------------------------------------<a name='4080'></font>
   IMPLICIT NONE<a name='4081'>
<font color=#447700>!--------------------------------------------------------------------<a name='4082'></font>
   LOGICAL , INTENT(IN)           ::  restart,allowed_to_read<a name='4083'>
   INTEGER , INTENT(IN)           ::  ids, ide, jds, jde, kds, kde, &amp;<a name='4084'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='4085'>
                                      its, ite, jts, jte, kts, kte<a name='4086'>
   INTEGER , INTENT(IN)           ::  P_QI,P_QS,P_FIRST_SCALAR<a name='4087'>
<a name='4088'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::       &amp;<a name='4089'>
                                                          RTHCUTEN, &amp;<a name='4090'>
                                                          RQVCUTEN, &amp;<a name='4091'>
                                                          RQCCUTEN, &amp;<a name='4092'>
                                                          RQRCUTEN, &amp;<a name='4093'>
                                                          RQICUTEN, &amp;<a name='4094'>
                                                          RQSCUTEN<a name='4095'>
<a name='4096'>
   REAL ,   DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) :: &amp;<a name='4097'>
                                                             W0AVG, &amp;<a name='4098'>
                                                        cldfra_cup, &amp; <font color=#447700>!CuP, wig 18-Sep-2006<a name='4099'></font>
                                                    cldfratend_cup    <font color=#447700>!CuP, wig 18-Sep-2006<a name='4100'></font>
<a name='4101'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT)::       NCA, &amp;<a name='4102'>
                                                             shall, &amp; <font color=#447700>!CuP, wig 19-Sep-2006<a name='4103'></font>
                                                        tcloud_cup    <font color=#447700>!CuP, rce 10-may-2012<a name='4104'></font>
<a name='4105'>
   LOGICAL, DIMENSION( ims:ime , jms:jme ), INTENT(OUT)::  cupflag    <font color=#447700>!CuP, wig 9-Oct-2006<a name='4106'></font>
<a name='4107'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='4108'>
   REAL, INTENT(IN)    :: SVP1,SVP2,SVP3,SVPT0<a name='4109'>
<a name='4110'>
   jtf=min0(jte,jde-1)<a name='4111'>
   ktf=min0(kte,kde-1)<a name='4112'>
   itf=min0(ite,ide-1)<a name='4113'>
<a name='4114'>
   IF(.not.restart)THEN<a name='4115'>
<a name='4116'>
      DO j=jts,jtf<a name='4117'>
      DO k=kts,ktf<a name='4118'>
      DO i=its,itf<a name='4119'>
         RTHCUTEN(i,k,j)=0.<a name='4120'>
         RQVCUTEN(i,k,j)=0.<a name='4121'>
         RQCCUTEN(i,k,j)=0.<a name='4122'>
         RQRCUTEN(i,k,j)=0.<a name='4123'>
         cldfra_cup(i,k,j) = 0.     <font color=#447700>!CuP, wig 18-Sep-2006<a name='4124'></font>
         cldfratend_cup(i,k,j) = 0. <font color=#447700>!CuP, wig 18-Sep-2006<a name='4125'></font>
      ENDDO<a name='4126'>
      ENDDO<a name='4127'>
      ENDDO<a name='4128'>
<a name='4129'>
      IF (P_QI .ge. P_FIRST_SCALAR) THEN<a name='4130'>
         DO j=jts,jtf<a name='4131'>
         DO k=kts,ktf<a name='4132'>
         DO i=its,itf<a name='4133'>
            RQICUTEN(i,k,j)=0.<a name='4134'>
         ENDDO<a name='4135'>
         ENDDO<a name='4136'>
         ENDDO<a name='4137'>
      ENDIF<a name='4138'>
<a name='4139'>
      IF (P_QS .ge. P_FIRST_SCALAR) THEN<a name='4140'>
         DO j=jts,jtf<a name='4141'>
         DO k=kts,ktf<a name='4142'>
         DO i=its,itf<a name='4143'>
            RQSCUTEN(i,k,j)=0.<a name='4144'>
         ENDDO<a name='4145'>
         ENDDO<a name='4146'>
         ENDDO<a name='4147'>
      ENDIF<a name='4148'>
<a name='4149'>
      DO j=jts,jtf<a name='4150'>
      DO i=its,itf<a name='4151'>
         NCA(i,j)=-100.<a name='4152'>
         shall(i,j) = 2. <font color=#447700>!Indicate no convection at 1st time step. CuP, wig 18-Sep-2006<a name='4153'></font>
         cupflag(i,j) = .false. <font color=#447700>!CuP, wig 9-Oct-2006<a name='4154'></font>
         tcloud_cup(i,j) = 0.0  <font color=#447700>!CuP, rce 10-may-2012<a name='4155'></font>
      ENDDO<a name='4156'>
      ENDDO<a name='4157'>
<a name='4158'>
      DO j=jts,jtf<a name='4159'>
      DO k=kts,ktf<a name='4160'>
      DO i=its,itf<a name='4161'>
         W0AVG(i,k,j)=0.<a name='4162'>
      ENDDO<a name='4163'>
      ENDDO<a name='4164'>
      ENDDO<a name='4165'>
<a name='4166'>
   endif<a name='4167'>
 <a name='4168'>
   CALL <A href='../../html_code/phys/module_cu_mskf.F.html#KF_LUTAB'>KF_LUTAB</A><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_CUP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="KF_LUTAB_1">(SVP1,SVP2,SVP3,SVPT0)<a name='4169'>
<a name='4170'>
   END SUBROUTINE kf_cup_init<a name='4171'>
<a name='4172'>
<font color=#447700>!-------------------------------------------------------<a name='4173'></font>
<a name='4174'>
<A NAME='KF_LUTAB'><A href='../../html_code/phys/module_cu_kfcup.F.html#KF_LUTAB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4175'>
      <font color=#993300>subroutine </font><font color=#cc0000>kf_lutab</font>(SVP1,SVP2,SVP3,SVPT0) <A href='../../call_to/KF_LUTAB.html' TARGET='index'>2</A><a name='4176'>
<font color=#447700>!<a name='4177'></font>
<font color=#447700>!  This subroutine is a lookup table.<a name='4178'></font>
<font color=#447700>!  Given a series of series of saturation equivalent potential <a name='4179'></font>
<font color=#447700>!  temperatures, the temperature is calculated.<a name='4180'></font>
<font color=#447700>!<a name='4181'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='4182'></font>
   IMPLICIT NONE<a name='4183'>
<font color=#447700>!--------------------------------------------------------------------<a name='4184'></font>
<font color=#447700>! Lookup table variables<a name='4185'></font>
<font color=#447700>!     INTEGER, SAVE, PARAMETER :: KFNT=250,KFNP=220<a name='4186'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNT,1:KFNP) :: TTAB,QSTAB<a name='4187'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNP) :: THE0K<a name='4188'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:200) :: ALU<a name='4189'></font>
<font color=#447700>!     REAL, SAVE :: RDPR,RDTHK,PLUTOP<a name='4190'></font>
<font color=#447700>! End of Lookup table variables<a name='4191'></font>
<a name='4192'>
     INTEGER :: KP,IT,ITCNT,I<a name='4193'>
     REAL :: DTH,TMIN,TOLER,PBOT,DPR,                               &amp;<a name='4194'>
             TEMP,P,ES,QS,PI,THES,TGUES,THGUES,F0,T1,T0,THGS,F1,DT, &amp;<a name='4195'>
             ASTRT,AINC,A1,THTGS<a name='4196'>
<font color=#447700>!    REAL    :: ALIQ,BLIQ,CLIQ,DLIQ,SVP1,SVP2,SVP3,SVPT0<a name='4197'></font>
     REAL    :: ALIQ,BLIQ,CLIQ,DLIQ<a name='4198'>
     REAL, INTENT(IN)    :: SVP1,SVP2,SVP3,SVPT0<a name='4199'>
<font color=#447700>!<a name='4200'></font>
<font color=#447700>! equivalent potential temperature increment<a name='4201'></font>
      data dth/1./<a name='4202'>
<font color=#447700>! minimum starting temp <a name='4203'></font>
      data tmin/150./<a name='4204'>
<font color=#447700>! tolerance for accuracy of temperature <a name='4205'></font>
      data toler/0.001/<a name='4206'>
<font color=#447700>! top pressure (pascals)<a name='4207'></font>
      plutop=5000.0<a name='4208'>
<font color=#447700>! bottom pressure (pascals)<a name='4209'></font>
      pbot=110000.0<a name='4210'>
<a name='4211'>
      ALIQ = SVP1*1000.<a name='4212'>
      BLIQ = SVP2<a name='4213'>
      CLIQ = SVP2*SVPT0<a name='4214'>
      DLIQ = SVP3<a name='4215'>
<a name='4216'>
<font color=#447700>!<a name='4217'></font>
<font color=#447700>! compute parameters<a name='4218'></font>
<font color=#447700>!<a name='4219'></font>
<font color=#447700>! 1._over_(sat. equiv. theta increment)<a name='4220'></font>
      rdthk=1./dth<a name='4221'>
<font color=#447700>! pressure increment<a name='4222'></font>
<font color=#447700>!<a name='4223'></font>
      DPR=(PBOT-PLUTOP)/REAL(KFNP-1)<a name='4224'>
<font color=#447700>!      dpr=(pbot-plutop)/REAL(kfnp-1)<a name='4225'></font>
<font color=#447700>! 1._over_(pressure increment)<a name='4226'></font>
      rdpr=1./dpr<a name='4227'>
<font color=#447700>! compute the spread of thes<a name='4228'></font>
<font color=#447700>!     thespd=dth*(kfnt-1)<a name='4229'></font>
<font color=#447700>!<a name='4230'></font>
<font color=#447700>! calculate the starting sat. equiv. theta<a name='4231'></font>
<font color=#447700>!<a name='4232'></font>
      temp=tmin <a name='4233'>
      p=plutop-dpr<a name='4234'>
      do kp=1,kfnp<a name='4235'>
        p=p+dpr<a name='4236'>
        es=aliq*exp((bliq*temp-cliq)/(temp-dliq))<a name='4237'>
        qs=0.622*es/(p-es)<a name='4238'>
        pi=(1.e5/p)**(0.2854*(1.-0.28*qs))<a name='4239'>
        the0k(kp)=temp*pi*exp((3374.6525/temp-2.5403)*qs*        &amp;<a name='4240'>
               (1.+0.81*qs))<a name='4241'>
      enddo   <a name='4242'>
<font color=#447700>!<a name='4243'></font>
<font color=#447700>! compute temperatures for each sat. equiv. potential temp.<a name='4244'></font>
<font color=#447700>!<a name='4245'></font>
      p=plutop-dpr<a name='4246'>
      do kp=1,kfnp<a name='4247'>
        thes=the0k(kp)-dth<a name='4248'>
        p=p+dpr<a name='4249'>
        do it=1,kfnt<a name='4250'>
<font color=#447700>! define sat. equiv. pot. temp.<a name='4251'></font>
          thes=thes+dth<a name='4252'>
<font color=#447700>! iterate to find temperature<a name='4253'></font>
<font color=#447700>! find initial guess<a name='4254'></font>
          if(it.eq.1) then<a name='4255'>
            tgues=tmin<a name='4256'>
          else<a name='4257'>
            tgues=ttab(it-1,kp)<a name='4258'>
          endif<a name='4259'>
          es=aliq*exp((bliq*tgues-cliq)/(tgues-dliq))<a name='4260'>
          qs=0.622*es/(p-es)<a name='4261'>
          pi=(1.e5/p)**(0.2854*(1.-0.28*qs))<a name='4262'>
          thgues=tgues*pi*exp((3374.6525/tgues-2.5403)*qs*      &amp;<a name='4263'>
               (1.+0.81*qs))<a name='4264'>
          f0=thgues-thes<a name='4265'>
          t1=tgues-0.5*f0<a name='4266'>
          t0=tgues<a name='4267'>
          itcnt=0<a name='4268'>
<font color=#447700>! iteration loop<a name='4269'></font>
          do itcnt=1,11<a name='4270'>
            es=aliq*exp((bliq*t1-cliq)/(t1-dliq))<a name='4271'>
            qs=0.622*es/(p-es)<a name='4272'>
            pi=(1.e5/p)**(0.2854*(1.-0.28*qs))<a name='4273'>
            thtgs=t1*pi*exp((3374.6525/t1-2.5403)*qs*(1.+0.81*qs))<a name='4274'>
            f1=thtgs-thes<a name='4275'>
            if(abs(f1).lt.toler)then<a name='4276'>
              exit<a name='4277'>
            endif<a name='4278'>
<font color=#447700>!           itcnt=itcnt+1<a name='4279'></font>
            dt=f1*(t1-t0)/(f1-f0)<a name='4280'>
            t0=t1<a name='4281'>
            f0=f1<a name='4282'>
            t1=t1-dt<a name='4283'>
          enddo <a name='4284'>
          ttab(it,kp)=t1 <a name='4285'>
          qstab(it,kp)=qs<a name='4286'>
        enddo<a name='4287'>
      enddo   <a name='4288'>
<font color=#447700>!<a name='4289'></font>
<font color=#447700>! lookup table for tlog(emix/aliq)<a name='4290'></font>
<font color=#447700>!<a name='4291'></font>
<font color=#447700>! set up intial values for lookup tables<a name='4292'></font>
<font color=#447700>!<a name='4293'></font>
       astrt=1.e-3<a name='4294'>
       ainc=0.075<a name='4295'>
<font color=#447700>!<a name='4296'></font>
       a1=astrt-ainc<a name='4297'>
       do i=1,200<a name='4298'>
         a1=a1+ainc<a name='4299'>
         alu(i)=alog(a1)<a name='4300'>
       enddo   <a name='4301'>
<font color=#447700>!<a name='4302'></font>
   END SUBROUTINE KF_LUTAB<a name='4303'>
<a name='4304'>
<a name='4305'>
<font color=#447700>!--------------------------------------------------------------------<a name='4306'></font>
<font color=#447700>! Calculates the cloud fraction tendency.<a name='4307'></font>
<font color=#447700>!<a name='4308'></font>
<A NAME='CUPCLOUDFRACTION'><A href='../../html_code/phys/module_cu_kfcup.F.html#CUPCLOUDFRACTION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4309'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>cupCloudFraction</font>(qlg, qig, qv1d, t1d, z1d, p1d,     &amp; <A href='../../call_to/CUPCLOUDFRACTION.html' TARGET='index'>1</A>,<A href='../../call_from/CUPCLOUDFRACTION.html' TARGET='index'>6</A><a name='4310'>
                            kcubot, kcutop, ishall, wStar, wParcel, pblh, dt, activeFrac, &amp;<a name='4311'>
                            cldfra, cldfraTend, &amp;<a name='4312'>
                            taucloud, tActive, tstar, lnterms, lnint, &amp;<a name='4313'>
                            kts, kte, mfup_cup)  <font color=#447700>! add mfup_cup LD 06 29 2012<a name='4314'></font>
                      <font color=#447700>!     kts, kte)<a name='4315'></font>
                            <a name='4316'>
  use <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUPCLOUDFRACTION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_48">, only: r_v, xls0, xls1, xlv0, xlv1<a name='4317'>
<font color=#447700>!<a name='4318'></font>
<font color=#447700>! Arguments...<a name='4319'></font>
<font color=#447700>!<a name='4320'></font>
   integer, intent(in) :: kts, kte<a name='4321'>
   integer, intent(in) :: ishall     <font color=#447700>! Flag for cloud type (0=deep, 1=shallow, 2=none)<a name='4322'></font>
<a name='4323'>
   integer, intent(in) :: kcubot, kcutop  <font color=#447700>! Indices of cloud top and bottom<a name='4324'></font>
   real, intent(in) :: wStar, pblh   <font color=#447700>! Deardorff velocity scale and mixed-layer depth<a name='4325'></font>
   real, intent(in) :: wParcel       <font color=#447700>! Vertical velocity of parcel<a name='4326'></font>
   real, intent(in) :: activeFrac    <font color=#447700>! Active cloud fraction, determined from cloud model<a name='4327'></font>
   real, intent(in) :: dt            <font color=#447700>! Time step used to find cloud fraction<a name='4328'></font>
<a name='4329'>
   real, dimension(kts:kte), intent(in) :: qlg     <font color=#447700>! Cloud liquid water<a name='4330'></font>
   real, dimension(kts:kte), intent(in) :: qig     <font color=#447700>! Cloud ice<a name='4331'></font>
   real, dimension(kts:kte), intent(in) :: t1d     <font color=#447700>! Environment temperature<a name='4332'></font>
   real, dimension(kts:kte), intent(in) :: qv1d    <font color=#447700>! Environmental mixing ratio<a name='4333'></font>
   real, dimension(kts:kte), intent(in) :: z1d     <font color=#447700>! Height array on cell middles<a name='4334'></font>
   real, dimension(kts:kte), intent(in) :: p1d     <font color=#447700>! Pressure array<a name='4335'></font>
<a name='4336'>
   real, dimension(kts:kte), intent(inout) :: cldfra <font color=#447700>! Cloud fraction<a name='4337'></font>
   real, dimension(kts:kte), intent(in) :: mfup_cup <font color=#447700>! LD 06 29 2012<a name='4338'></font>
   real, dimension(kts:kte), intent(out) :: cldfraTend <font color=#447700>! Cloud fraction tendency<a name='4339'></font>
<font color=#447700>!<a name='4340'></font>
<font color=#447700>! Local vars...<a name='4341'></font>
<font color=#447700>!<a name='4342'></font>
   integer :: k, kp1 ,kcutop_p1 <font color=#447700>!BSINGH - Added kcutop_p1<a name='4343'></font>
<a name='4344'>
   real :: gamma, zsum<a name='4345'>
   real,intent(out) :: tauCloud      <font color=#447700>! Cloud time scale  ~can make local after testing<a name='4346'></font>
   real,intent(out) :: tActive       <font color=#447700>! Cloud time scale  ~can make local after testing<a name='4347'></font>
<font color=#447700>!!!   real,intent(out) :: wParcel       ! Cloud velocity scale  ~can make local after testing<a name='4348'></font>
   real,intent(out) :: tStar         <font color=#447700>! Boundary-layer time scale  ~can make local after testing<a name='4349'></font>
<font color=#447700>!!!   real,intent(out) :: activeFrac    ! Fraction of PDF that forms clouds<a name='4350'></font>
   real :: ice_term, liquid_term     <font color=#447700>! Terms inside of log for gamma<a name='4351'></font>
   real, dimension(kts:kte),intent(out) :: lnTerms <font color=#447700>! Combined log terms to be integrated  ~can make local after testing<a name='4352'></font>
   real,intent(out) :: lnInt                     <font color=#447700>! Integrated log terms for gamma  ~can make local after testing<a name='4353'></font>
   real :: intQC                     <font color=#447700>! Integrated cloud water add 2010/01/17<a name='4354'></font>
   real, dimension(kts:kte) :: satDef <font color=#447700>! Saturation deficit  add 2010/01/17<a name='4355'></font>
   real :: intSatDef                 <font color=#447700>! Integrated saturation deficit aa 2010/01/17<a name='4356'></font>
   real :: deltaZ                    <font color=#447700>! Height diff. between cell centers<a name='4357'></font>
   real :: deltaRsInt                <font color=#447700>! Integrated delta rs<a name='4358'></font>
   real :: deltaRsTop, deltaRsBot    <font color=#447700>! Value at deltaRs at the top an bottom of the layer<a name='4359'></font>
   real :: TEnvTop, TEnvBot          <font color=#447700>! Env. temperature at top and bottom of the layer<a name='4360'></font>
   real :: rs, rsi                   <font color=#447700>! Saturation mixing ratios w.r.t liquid and ice<a name='4361'></font>
   real :: cp , Ls, Lv               <font color=#447700>! Thermodynamic related "constants"<a name='4362'></font>
<a name='4363'>
   if( ishall==2 ) then<a name='4364'>
      <font color=#447700>! If no convection, then zero out the cloud fraction...<a name='4365'></font>
      cldfra(:) = 0.<a name='4366'>
<a name='4367'>
   else if( ishall==0 ) then<a name='4368'>
      <font color=#447700>! If deep convection formed, then set the cloud fraction to 1.<a name='4369'></font>
      cldfra(:) = 0.<a name='4370'>
    <a name='4371'>
  <font color=#447700>!   cldfra(kcubot:kcutop) = 1.    !!LD<a name='4372'></font>
  <font color=#447700>!!   print(UMF(?)) unit??<a name='4373'></font>
         do k=kcubot,kcutop<a name='4374'>
          cldfra(k) = max(0.,min(0.1*log(1.+675.*mfup_cup(k)),1.))  <font color=#447700>!!  LD 06 29 2012 :: .1/675 adjustable parameter<a name='4375'></font>
         end do<a name='4376'>
<font color=#447700>!    print*,"mfup_cup(kcubot)=",mfup_cup(kcubot)  <a name='4377'></font>
    <a name='4378'>
     tStar = pblh / wStar  <font color=#447700>! rce 11-may-2012<a name='4379'></font>
<a name='4380'>
   else if( ishall==1 ) then<a name='4381'>
    <a name='4382'>
      <font color=#447700>! Shallow convection occurred so we need to be more detailed...<a name='4383'></font>
<a name='4384'>
      tStar = pblh / wStar           <font color=#447700>! Find tStar based on mixed-layer depth<a name='4385'></font>
<a name='4386'>
      <font color=#447700>! Integrate the log terms for the cloud time scale over the depth<a name='4387'></font>
      <font color=#447700>! of the cloud and take into account both liquid and ice as<a name='4388'></font>
      <font color=#447700>! separate terms. Do not allow super saturation, and at the same<a name='4389'></font>
      <font color=#447700>! time, preclude divide by zeros by limiting the (rs-r)'s to<a name='4390'></font>
      <font color=#447700>! positive values.<a name='4391'></font>
      lnTerms(:) = 0.<a name='4392'>
     <a name='4393'>
     <font color=#447700>!!The determination of the cloud time scales around line 3523.<a name='4394'></font>
     <font color=#447700>!!modified the do loop that computes the integrated cloud water and the saturation deficit.  <a name='4395'></font>
     <font color=#447700>!!code starts at line 3541 and continues through 3560<a name='4396'></font>
<a name='4397'>
      <font color=#447700>!!do k=kcubot,kcutop<a name='4398'></font>
           <font color=#447700>!!cp = findCp(qv1d(k))<a name='4399'></font>
           <font color=#447700>!!rs = findRs(t1d(k), p1d(k))<a name='4400'></font>
           <font color=#447700>!!Lv =  xlv0 - xlv1*t1d(k)<a name='4401'></font>
           <font color=#447700>!!gamma = eps*(Lv**2)*rs / (cp*r_v*t1d(k)**2)<a name='4402'></font>
           <font color=#447700>!!liquid_term = (1.+gamma)*qlg(k) / max(rs - qv1d(k),1e-20)<a name='4403'></font>
<a name='4404'>
         <font color=#447700>!!Ls =  xls0 - xls1*t1d(k)<a name='4405'></font>
         <font color=#447700>!!rsi = findRsi(t1d(k), p1d(k))<a name='4406'></font>
         <font color=#447700>!!gamma = eps*(Ls**2)*rsi / (cp*r_v*t1d(k)**2)<a name='4407'></font>
         <font color=#447700>!!ice_term = (1.+gamma)*qig(k) / max(rsi - qv1d(k),1e-20)<a name='4408'></font>
<a name='4409'>
         <font color=#447700>!!lnTerms(k) = 1. + liquid_term !~tmp + ice_term <a name='4410'></font>
      <font color=#447700>!!end do<a name='4411'></font>
     <a name='4412'>
      <font color=#447700>!lnInt = 0.! add 2011/01/16 start<a name='4413'></font>
      intQC = 0.  <a name='4414'>
      intSatDef = 0.<a name='4415'>
      zsum  = 0.<a name='4416'>
<a name='4417'>
      <font color=#447700>!BSINGH - Added do-loop to compute 'satDef' before it is being used in the next do-loop<a name='4418'></font>
      <font color=#447700>!BSINGH - This loop should go to (kcutop+1) as we are trying to access satDef(k+1) in the next do-loop<a name='4419'></font>
      kcutop_p1 = min(kcutop + 1,kte)<a name='4420'>
      do k = kcubot, kcutop_p1 <a name='4421'>
         rs = <A href='../../html_code/phys/module_cu_kfcup.F.html#FINDRS'>findRs</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUPCLOUDFRACTION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FINDRS_1">(t1d(k), p1d(k))<a name='4422'>
         satDef(k) = max(rs - qv1d(k), 1.0e-20)<a name='4423'>
      end do<a name='4424'>
      <font color=#447700>!BSINGH - ENDS<a name='4425'></font>
<a name='4426'>
      do k=kcubot,kcutop<a name='4427'>
         kp1 = min(k+1,kte-1)<a name='4428'>
         deltaZ = z1d(kp1) - z1d(k)  <font color=#447700>! Find the interval<a name='4429'></font>
         zsum = zsum + deltaz<a name='4430'>
         <font color=#447700>!!lnInt = lnInt + 0.5*(lnTerms(k) + lnTerms(kp1))*deltaZ<a name='4431'></font>
         rs = <A href='../../html_code/phys/module_cu_kfcup.F.html#FINDRS'>findRs</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUPCLOUDFRACTION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FINDRS_2">(t1d(k), p1d(k))<a name='4432'>
         satDef(k) = max(rs - qv1d(k), 1e-20)<a name='4433'>
         intQC = 0.5*(qlg(k) + qlg(kp1)) * deltaz + intQC<a name='4434'>
<font color=#447700>!         print *, 'Values within cupCloudFraction', intSatDef, satDef(k),satDef(kp1),deltaz,k,kp1<a name='4435'></font>
         <font color=#447700>!print *, 'Values within cupCloudFraction',rs,qv1d(k),qlg(k),qlg(kp1),k,kp1<a name='4436'></font>
         intSatDef = 0.5*(satDef(k) + satDef(kp1)) * deltaz + intSatDef<a name='4437'>
      end do<a name='4438'>
      <font color=#447700>!!lnInt = lnInt/zsum !Turn the integral into an average<a name='4439'></font>
      cp = <A href='../../html_code/phys/module_cu_kfcup.F.html#FINDCP'>findCp</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUPCLOUDFRACTION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FINDCP_1">(qv1d(kcubot))              <font color=#447700>! Use the thermodynamic properties at cloud base for defining gamma<a name='4440'></font>
      rs = <A href='../../html_code/phys/module_cu_kfcup.F.html#FINDRS'>findRs</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUPCLOUDFRACTION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FINDRS_3">(t1d(kcubot), p1d(kcubot))<a name='4441'>
      Lv =  xlv0 - xlv1*t1d(kcubot)<a name='4442'>
      gamma = (Lv**2)*rs / (cp*r_v*t1d(kcubot)**2)<a name='4443'>
      lnInt = log(1.0 + (1.0 + gamma) * intQC / intSatDef)<a name='4444'>
      lnInt = max(lnInt, 1.0)                <font color=#447700>! Set the value of lnInt to be 1 or greater<a name='4445'></font>
                   <font color=#447700>! add 2011/01/16 end<a name='4446'></font>
      <font color=#447700>! Find the time scale of the cloud lifetime, tauCloud, and the time<a name='4447'></font>
      <font color=#447700>! scale of the cloud formation, tActive...<a name='4448'></font>
      <font color=#447700>!!tauCloud = min(tStar*lnInt, 3600.) !Set a max taucld of 60 min.<a name='4449'></font>
      tauCloud = min(tStar*lnInt, 1800.) <font color=#447700>!Set a max taucld of 60 min.<a name='4450'></font>
      if(wParcel .gt. 0) then<a name='4451'>
        tActive = z1d(kcutop)/wParcel<a name='4452'>
      else <a name='4453'>
        tActive = z1d(kcutop) / wStar<a name='4454'>
      endif<a name='4455'>
<font color=#447700>!!!! tActive or tactive matter? Dec-15-2010-LP<a name='4456'></font>
<font color=#447700>!!$      ! Now, find the cloud fraction tendency. Above and below the cloud,<a name='4457'></font>
<font color=#447700>!!$      ! it is zero.<a name='4458'></font>
<font color=#447700>!!$      cldfraTend(kts:max(kcubot-1,kts)) = 0.<a name='4459'></font>
<font color=#447700>!!$      cldfraTend(min(kcutop+1,kte):kte) = 0.<a name='4460'></font>
<font color=#447700>!!$      do k=kcubot,kcutop<a name='4461'></font>
<font color=#447700>!!$         cldfraTend(k) = dt*(activeFrac/tActive - cldfra(k)/tauCloud)<a name='4462'></font>
<font color=#447700>!!$      enddo<a name='4463'></font>
<a name='4464'>
      <font color=#447700>! Now, get a steady-state cloud fraction and restrict it to the<a name='4465'></font>
      <font color=#447700>! range [0,1]...<a name='4466'></font>
      cldfra(:) = 0.<a name='4467'>
      do k=kcubot,kcutop<a name='4468'>
         cldfra(k) = activeFrac*tauCloud/tActive<a name='4469'>
         cldfra(k) = max(cldfra(k), 0.01)  <font color=#447700>! LKB 9/9/09 Changed from 0 to be 0.1<a name='4470'></font>
         cldfra(k) = min(cldfra(k), 1.)<a name='4471'>
      end do<a name='4472'>
<a name='4473'>
   else<a name='4474'>
      <font color=#447700>!This should never happen!<a name='4475'></font>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUPCLOUDFRACTION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_610">("Bad ishall value in kfcup.")<a name='4476'>
   end if<a name='4477'>
<a name='4478'>
END SUBROUTINE cupCloudFraction<a name='4479'>
<a name='4480'>
<a name='4481'>
<font color=#447700>!------------------------------------------------------------------------<a name='4482'></font>
<A NAME='CUP_JFD'><A href='../../html_code/phys/module_cu_kfcup.F.html#CUP_JFD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4483'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_jfd</font>(slopeSfc, slopeEZ, sigmaSfc, sigmaEZ,                &amp; <A href='../../call_to/CUP_JFD.html' TARGET='index'>1</A>,<A href='../../call_from/CUP_JFD.html' TARGET='index'>3</A><a name='4484'>
     numBins, thBinSize, rBinSize, th_perturb, r_perturb, jfd           )<a name='4485'>
<a name='4486'>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUP_JFD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_49">, only: pi2<a name='4487'>
<font color=#447700>!<a name='4488'></font>
<font color=#447700>! Arguments...<a name='4489'></font>
<font color=#447700>!<a name='4490'></font>
  integer, intent(in) :: numBins<a name='4491'>
  real, intent(in) :: thBinSize, rBinSize<a name='4492'>
  real, intent(inout) :: slopeSfc, slopeEZ, sigmaSfc, sigmaEZ<a name='4493'>
  real, dimension(numBins), intent(out) :: r_perturb, th_perturb<a name='4494'>
  real, dimension(numBins,numBins), intent(out) :: jfd<a name='4495'>
<font color=#447700>!<a name='4496'></font>
<font color=#447700>! Local vars...<a name='4497'></font>
<font color=#447700>!<a name='4498'></font>
  integer :: centerBin, i, j<a name='4499'>
  real :: bigcheck, c, constants, cterm, dslope, jacobian, jfdCheckSum, m, mterm<a name='4500'>
  character(len=150) :: message<a name='4501'>
<font color=#447700>!<a name='4502'></font>
<font color=#447700>! Limit the allowable values of the slopes and sigmas ~get the right values for caps<a name='4503'></font>
<font color=#447700>!<a name='4504'></font>
<font color=#447700>!  slopeSfc = sign( min( abs(slopeSfc), 2e6 ), slopeSfc)<a name='4505'></font>
<font color=#447700>!  slopeEZ  = sign( min( abs(slopeEZ), 2e6 ), slopeEZ)<a name='4506'></font>
<font color=#447700>!~  sigmaSfc = max( abs(sigmaSfc), rBinSize ) ! &lt;-- This one is the only one that really limited anything. It was only giving the value rBinSize.<a name='4507'></font>
<font color=#447700>!~  sigmaEZ  = max( abs(sigmaEZ), rBinSize )<a name='4508'></font>
<a name='4509'>
<font color=#447700>!!$!~wig begin: testing due to overflow of jfd calc 13-dec-2006<a name='4510'></font>
<font color=#447700>!!$if( abs(slopesfc) &lt; 1e-14 ) print*,"small slopesfc =",slopesfc<a name='4511'></font>
<font color=#447700>!!$if( abs(slopeez)  &lt; 1e-14 ) print*,"small slopeez  =",slopeez<a name='4512'></font>
<font color=#447700>!!$if( abs(sigmasfc) &lt; 1e-14 ) print*,"small sigmasfc =",sigmasfc<a name='4513'></font>
<font color=#447700>!!$if( abs(sigmaez)  &lt; 1e-14 ) print*,"small sigmaez  =",sigmaez<a name='4514'></font>
<font color=#447700>!!$!~wig end<a name='4515'></font>
<a name='4516'>
  slopeSfc = sign(max( abs(slopeSfc), 1e-15 ), slopeSfc)<a name='4517'>
  <font color=#447700>!!slopeEZ  = sign(max( abs(slopeEZ), 1e-10 ), slopeEZ) !1e-15 caused an overflow for the jfd~<a name='4518'></font>
  if(slopeEZ &gt; 2000) then<a name='4519'>
     slopeEZ = 2000.0<a name='4520'>
  else if(slopeEZ &lt; -2000) then <a name='4521'>
     slopeEZ = -2000.0<a name='4522'>
  else if(slopeEZ &lt; 10 .and. slopeEZ &gt; 0) then <a name='4523'>
     slopeEZ = 10.0<a name='4524'>
  else if(slopeEZ &lt; 0 .and. slopeEZ &gt; -10.0) then <a name='4525'>
     slopeEZ = -10.0<a name='4526'>
  endif<a name='4527'>
  sigmaSfc = sign(max( abs(sigmaSfc), 1e-15 ), sigmaSfc)<a name='4528'>
  sigmaEZ  = sign(max( abs(sigmaEZ), 1e-15 ), sigmaEZ)<a name='4529'>
  <font color=#447700>!!slopeEZ = 1000.0 ! Larry, set constant value of slopeEZ<a name='4530'></font>
<font color=#447700>!!  slopeSfc = sign(min (abs(slopeSfc), 5000.0), slopeSfc)   ! lkb Added check on size of slopes<a name='4531'></font>
<font color=#447700>!!  slopeSfc = sign(min (abs(slopeEZ), 5000.0), slopeEZ)<a name='4532'></font>
<font color=#447700>!<a name='4533'></font>
<font color=#447700>! Calculate all the values that are held constant while looping through<a name='4534'></font>
<font color=#447700>! the perturbations...<a name='4535'></font>
<font color=#447700>!<a name='4536'></font>
  centerBin = numBins / 2 + 1                 <font color=#447700>! Find the center bin<a name='4537'></font>
  dslope = sign(max(abs(slopeEZ-slopeSfc),1e-15),slopeEZ-slopeSfc)<a name='4538'>
  jacobian = slopeEZ / dslope                 <font color=#447700>! Compute the jacobian<a name='4539'></font>
  <font color=#447700>!wig: 22-Dec-2006 added parentheses that had been inadvertantly dropped...<a name='4540'></font>
<font color=#447700>!wig  constants = jacobian*thBinSize*rBinSize / (pi2*sigmaSfc*sigmaEZ)<a name='4541'></font>
  bigcheck = sqrt(huge(c))   <font color=#447700>! 10/30/08 lkb 0.1*huge(c)<a name='4542'></font>
<font color=#447700>!<a name='4543'></font>
<font color=#447700>! Loop through all the perturbation possibilities and get the jfd...<a name='4544'></font>
<font color=#447700>!<a name='4545'></font>
  jfdCheckSum = 0.<a name='4546'>
  do j = 1, numBins                           <font color=#447700>! For each bin of the jfd<a name='4547'></font>
     r_perturb(j) = rBinSize * (j - centerBin)<a name='4548'>
     do i = 1, numBins<a name='4549'>
        th_perturb(i) = thBinSize * (i - centerBin)<a name='4550'>
<a name='4551'>
        <font color=#447700>! Convert theta and r to c and m space. This uses eq. 4<a name='4552'></font>
        <font color=#447700>! from Berg and Stull (2004)<a name='4553'></font>
        c = slopeEZ * (th_perturb(i) - slopeSfc * r_perturb(j)) / dslope<a name='4554'>
        m = (th_perturb(i) - slopeEZ * r_perturb(j)) / dslope<a name='4555'>
<a name='4556'>
<font color=#447700>!wig, 22-Dec-2006: Actual desired calc commented since was getting<a name='4557'></font>
<font color=#447700>!                  an overflow. So, added code to enforce limits.<a name='4558'></font>
<font color=#447700>!        jfd(i,j) = exp(-0.5 * ( (m/sigmaSfc) * (m/sigmaSfc) + &amp;<a name='4559'></font>
<font color=#447700>!                   (c/sigmaEZ) * (c/sigmaEZ) )) * constants<a name='4560'></font>
        cterm = c/sigmaEZ<a name='4561'>
        if( abs(cterm) &gt; bigcheck ) then<a name='4562'>
           write(message, &amp;<a name='4563'>
           '("KFCuP setting a bogus cterm for JFD. c=",1e15.6," &amp;<a name='4564'>
            &amp; sigmaEZ=",1e15.6)') &amp;<a name='4565'>
                c, sigmaEZ<a name='4566'>
           call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUP_JFD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_536">(0,trim(message))<a name='4567'>
           cterm = sign(bigcheck,cterm)<a name='4568'>
        else<a name='4569'>
           cterm = cterm*cterm<a name='4570'>
        end if<a name='4571'>
        mterm = m/sigmaSfc<a name='4572'>
<font color=#447700>!!$        if( abs(mterm) &gt; 0.1*bigcheck ) then<a name='4573'></font>
<font color=#447700>!!$           write(message, &amp;<a name='4574'></font>
<font color=#447700>!!$                '("KFCuP has a big mterm for JFD. m=",1e15.6," sigmaSfc=",1e15.6," dslope=",1e15.6," slopeEZ=",1e15.6," slopeSfc=",1e15.6)') &amp;<a name='4575'></font>
<font color=#447700>!!$                m, sigmaSfc,dslope,slopeEZ,slopeSfc<a name='4576'></font>
<font color=#447700>!!$           call wrf_debug(0,trim(message))<a name='4577'></font>
<font color=#447700>!!$           flush(0)<a name='4578'></font>
<font color=#447700>!!$           flush(6)<a name='4579'></font>
<font color=#447700>!!$        end if<a name='4580'></font>
        if( abs(mterm) &gt; bigcheck ) then<a name='4581'>
<a name='4582'>
print*,'bigcheck=',bigcheck<a name='4583'>
           write(message, &amp;<a name='4584'>
                '("KFCuP setting a bogus mterm for JFD. m=",1e15.6, &amp;<a name='4585'>
                &amp; " sigmaSfc=",1e15.6)') &amp;<a name='4586'>
                m, sigmaSfc<a name='4587'>
           call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUP_JFD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_537">(0,trim(message))<a name='4588'>
           flush(0)<a name='4589'>
           flush(6)<a name='4590'>
           mterm = sign(bigcheck,mterm)<a name='4591'>
        else<a name='4592'>
           mterm = mterm*mterm<a name='4593'>
        end if<a name='4594'>
<font color=#447700>!wig: took off constants because they will not affect the outcome after normalizing to one<a name='4595'></font>
        jfd(i,j) = exp( -0.5*(mterm + cterm) )  <font color=#447700>!* constants <a name='4596'></font>
<font color=#447700>!wig: end of overflow hack<a name='4597'></font>
<a name='4598'>
        jfdCheckSum = jfdCheckSum + jfd(i,j)<a name='4599'>
<a name='4600'>
     enddo<a name='4601'>
  enddo<a name='4602'>
<a name='4603'>
<font color=#447700>!!$!~Add check to only output the check sum if it is out of the ordinary...<a name='4604'></font>
<font color=#447700>!!$  write(*,*) "JFD sums to ", jfdCheckSum, " Number of bins is ", numBins<a name='4605'></font>
<font color=#447700>!!$  write(30,*) "~JFD sums to ", jfdCheckSum, " Number of bins is ", numBins<a name='4606'></font>
<font color=#447700>!!$  write(30,'("slope sfc/ez &amp; sigma sfc/ez: ",4g18.8)') slopesfc,slopeez,sigmasfc,sigmaez<a name='4607'></font>
<font color=#447700>!!$  if( count(abs(jfd) &gt; 1e-30) &gt; 1 ) write(30,*) "---Non-spiked JFD---",count(abs(jfd) &gt; 1e-30)<a name='4608'></font>
<font color=#447700>!!$  write(30,'(21g11.4)') 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21<a name='4609'></font>
<font color=#447700>!!$  do j=1,numBins<a name='4610'></font>
<font color=#447700>!!$     write(30,'(i3, 17e11.4)') j,jfd(:,j)<a name='4611'></font>
<font color=#447700>!!$  end do<a name='4612'></font>
<a name='4613'>
<font color=#447700>! Force jfd sum to be one...<a name='4614'></font>
  if( jfdCheckSum /= 0. ) jfd(:,:) = jfd(:,:)/jfdCheckSum  <font color=#447700>!~Re-normalize the jfd to sum to one<a name='4615'></font>
<a name='4616'>
<font color=#447700>!!$  write(30,*) "~adjusted JFD..."<a name='4617'></font>
<font color=#447700>!!$  write(30,'(21g11.4)') 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21<a name='4618'></font>
<font color=#447700>!!$  do j=1,numBins<a name='4619'></font>
<font color=#447700>!!$     write(30,'(i3, 21e11.4)') j,jfd(:,j)<a name='4620'></font>
<font color=#447700>!!$  end do<a name='4621'></font>
<font color=#447700>!!$  write(30,*)<a name='4622'></font>
<a name='4623'>
END SUBROUTINE cup_jfd<a name='4624'>
<a name='4625'>
<a name='4626'>
<font color=#447700>!------------------------------------------------------------------------<a name='4627'></font>
<A NAME='CUPSLOPESIGMA'><A href='../../html_code/phys/module_cu_kfcup.F.html#CUPSLOPESIGMA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4628'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>cupSlopeSigma</font>(dx, psfc, p, rho, dz8w, z, ht,                 &amp; <A href='../../call_to/CUPSLOPESIGMA.html' TARGET='index'>1</A>,<A href='../../call_from/CUPSLOPESIGMA.html' TARGET='index'>6</A><a name='4629'>
               t, th, tsk, u, v, qv_curr, hfx,xland, qfxin, mavail,     &amp; <font color=#447700>! add xland, LD 19-Oct-2011<a name='4630'></font>
               sf_sfclay_physics, br, regime, pblh, kpbl, t2, q2,       &amp;<a name='4631'>
               slopeSfc, slopeEZ, sigmaSfc, sigmaEZ, wStar, cupflag,    &amp;<a name='4632'>
               shall, kms, kme, kts, kte                             )<a name='4633'>
<a name='4634'>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUPSLOPESIGMA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_50">, only: cp, ep_1, ep_2, g, r_d, rcp, &amp;<a name='4635'>
                                    svp1, svp2, svp3, svpt0, xlv<a name='4636'>
<a name='4637'>
  USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUPSLOPESIGMA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_114">, ONLY : KFCUPSCHEME               &amp;<a name='4638'>
                                      ,SFCLAYSCHEME              &amp;<a name='4639'>
                                      ,MYJSFCSCHEME              &amp;<a name='4640'>
                                      ,GFSSFCSCHEME              &amp;<a name='4641'>
                                      ,SLABSCHEME                &amp;<a name='4642'>
                                      ,LSMSCHEME                 &amp;<a name='4643'>
                                      ,RUCLSMSCHEME<a name='4644'>
<font color=#447700>! MPI is needed for the test printouts (to get the rank)...<a name='4645'></font>
<font color=#447700>!#ifdef ( DM_PARALLEL ) &amp;&amp; !defined( STUBMPI )<a name='4646'></font>
#if ( <font color=#447700>! defined(DM_PARALLEL)  &amp;&amp;   ! defined(STUBMPI) )<a name='4647'></font>
<font color=#447700>! rce_testing turn this off<a name='4648'></font>
<font color=#447700>! INCLUDE 'mpif.h'<a name='4649'></font>
#endif<a name='4650'>
<a name='4651'>
<font color=#447700>!<a name='4652'></font>
<font color=#447700>! Arguments...<a name='4653'></font>
<font color=#447700>!<a name='4654'></font>
  integer, intent(in) :: kpbl, sf_sfclay_physics, &amp;<a name='4655'>
                         kms, kme, kts, kte<a name='4656'>
<a name='4657'>
  real, intent(in) :: &amp;<a name='4658'>
       br, dx, hfx,xland, ht, mavail, pblh, psfc, q2, qfxin, regime, t2, tsk <font color=#447700>!add xland LD 19-Oct-2011<a name='4659'></font>
<a name='4660'>
  real, dimension(kms:kme), intent(in) :: &amp;<a name='4661'>
       p, rho, dz8w, z, t, th, qv_curr, u, v<a name='4662'>
<a name='4663'>
  real, intent(out) :: &amp;<a name='4664'>
       slopeSfc, slopeEZ, sigmaSfc, sigmaEZ, wStar<a name='4665'>
  real, intent(inout) :: shall<a name='4666'>
<a name='4667'>
  logical, intent(out) :: cupflag<a name='4668'>
<font color=#447700>!<a name='4669'></font>
<font color=#447700>! Local vars...<a name='4670'></font>
<font color=#447700>!<a name='4671'></font>
  integer :: docldstep, fout, i, ierr, j, k, kpblmid, numZ<a name='4672'>
  real :: br2, dtcu, e1, dthvdz, flux, govrth, psfccmb, qdiff, qfx, &amp;<a name='4673'>
       qsfc, rhox, thv2, thgb, thv, tskv, tvcon, vconv, vsgd, wspd, za<a name='4674'>
  real, dimension(kts:kte) :: zagl<a name='4675'>
  logical :: UnstableOrNeutral<a name='4676'>
  character(len=50) :: filename<a name='4677'>
<font color=#447700>!<a name='4678'></font>
<font color=#447700>! Artificially force a latent heat flux that is not close to zero. This<a name='4679'></font>
<font color=#447700>! prevents sigmaSfc from becoming too small and leading to overflows<a name='4680'></font>
<font color=#447700>! in the JFD calculation.<a name='4681'></font>
<font color=#447700>!<a name='4682'></font>
  if( abs(qfxin) &lt; 1./xlv ) then<a name='4683'>
     qfx = sign(1./xlv,qfxin)<a name='4684'>
  else<a name='4685'>
     qfx = qfxin<a name='4686'>
  end if<a name='4687'>
<font color=#447700>!<a name='4688'></font>
<font color=#447700>! Determine if each column is stable or (unstable or neutral). If the regime<a name='4689'></font>
<font color=#447700>! is already calculated by one of the surface schemes, we can use it. If not,<a name='4690'></font>
<font color=#447700>! deterimine the stability based on the bulk richardson number. We only<a name='4691'></font>
<font color=#447700>! care about stable vs. (neutral or unstable).<a name='4692'></font>
<font color=#447700>!<a name='4693'></font>
   UnstableOrNeutral = .false.<a name='4694'>
   sfclay_case: SELECT CASE (sf_sfclay_physics)<a name='4695'>
   CASE (SFCLAYSCHEME)<a name='4696'>
      <font color=#447700>! Regime categories:<a name='4697'></font>
      <font color=#447700>!    1 = Stable (nighttime)<a name='4698'></font>
      <font color=#447700>!    2 = Damped mechanical turbulence<a name='4699'></font>
      <font color=#447700>!    3 = Forced convection<a name='4700'></font>
      <font color=#447700>!    4 = Free convection<a name='4701'></font>
      <font color=#447700>! Add condition for positive heat flux because negative heat fluxes<a name='4702'></font>
      <font color=#447700>! were causing the wstar calculation to core dump--can't do a 1/3<a name='4703'></font>
      <font color=#447700>! root of a negative value. wig, 5-Feb-2008<a name='4704'></font>
      if( regime &gt; 2.5 &amp;<a name='4705'>
           .AND. hfx &gt;= 0. ) UnstableOrNeutral = .true.<a name='4706'>
<a name='4707'>
   CASE (GFSSFCSCHEME)<a name='4708'>
      if( br &lt;= 0. ) UnstableOrNeutral = .true.<a name='4709'>
<a name='4710'>
   CASE DEFAULT  <a name='4711'>
      <font color=#447700>! The selected sfc scheme does not already provide a stability<a name='4712'></font>
      <font color=#447700>! criteria. So, we will mimic the bulk Richardson calculation from<a name='4713'></font>
      <font color=#447700>! module_sf_sfclay.F.<a name='4714'></font>
<a name='4715'>
      <font color=#447700>!!if( pblh &lt;= 0. ) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUPSLOPESIGMA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_611">( &amp;<a name='4716'></font>
      <font color=#447700>!!     "CuP needs a PBL height from a PBL scheme.")<a name='4717'></font>
      if(pblh &lt;= 0.0)then<a name='4718'>
         UnstableOrNeutral = .false.   <font color=#447700>! Added by LKB 9/8/09<a name='4719'></font>
<a name='4720'>
      else                                          <font color=#447700>! Added by LKB 9/8/09<a name='4721'></font>
         ZA    = 0.5*dz8w(1)<a name='4722'>
<a name='4723'>
         E1    = SVP1*EXP(SVP2*(TSK-SVPT0)/(TSK-SVP3))<a name='4724'>
         PSFCCMB=PSFC/1000.  <font color=#447700>!converts from Pa to cmb<a name='4725'></font>
         QSFC  = EP_2*E1/(PSFCCMB-E1)<a name='4726'>
         THGB  = TSK*(100./PSFCCMB)**RCP<a name='4727'>
         TSKV  = THGB*(1.+EP_1*QSFC*MAVAIL)<a name='4728'>
         TVCON = 1.+EP_1*QV_CURR(1)<a name='4729'>
         THV   = TH(1)*TVCON<a name='4730'>
         DTHVDZ= (THV-TSKV)<a name='4731'>
<a name='4732'>
         GOVRTH= G/TH(1)<a name='4733'>
<a name='4734'>
         RHOX  = PSFC/(r_d*t(1)*TVCON)<a name='4735'>
         flux  = max(hfx/rhox/cp + ep_1*tskv*qfx/rhox,0.)<a name='4736'>
         VCONV = (g/TSK*pblh*flux)**.33<a name='4737'>
         VSGD  = 0.32 * (max(dx/5000.-1.,0.))**.33<a name='4738'>
         WSPD  = SQRT(U(1)*U(1)+V(1)*V(1))<a name='4739'>
         WSPD  = SQRT(WSPD*WSPD+VCONV*VCONV+vsgd*vsgd)<a name='4740'>
         WSPD  = MAX(WSPD,0.1)<a name='4741'>
<a name='4742'>
         <font color=#447700>!And finally, the bulk Richardson number...<a name='4743'></font>
         BR2   = GOVRTH*ZA*DTHVDZ/(WSPD*WSPD)<a name='4744'>
<a name='4745'>
         if( br2 &lt;= 0. ) then<a name='4746'>
            UnstableOrNeutral = .true.<a name='4747'>
         else <a name='4748'>
            UnstableOrNeutral = .false.<a name='4749'>
         endif<a name='4750'>
      endif<a name='4751'>
   END SELECT sfclay_case<a name='4752'>
<a name='4753'>
   <font color=#447700>! If we are in a stable regime, then the assumptions for CuP do not<a name='4754'></font>
   <font color=#447700>! make sense, so default back to the standard KF algorithm. Also, do<a name='4755'></font>
   <font color=#447700>! this if the pbl is at the lowest level since then we cannot<a name='4756'></font>
   <font color=#447700>!calculate a proper difference with the surface.<a name='4757'></font>
   <font color=#447700>!if( kpbl == 1 .or. (.not. UnstableOrNeutral) .or. hfx &lt; 0 .or. qfx &lt; 0) then !~ lkb 8/25/08 changed to require + heat flux<a name='4758'></font>
     <font color=#447700>! if( kpbl == 1 .or. hfx &lt; 1 ) then !~ lkb 8/25/08 changed to require + heat flux<a name='4759'></font>
     <font color=#447700>! if( kpbl == 1 .or. hfx &lt; 50 ) then !~ lkb 8/25/08 changed to require + heat flux<a name='4760'></font>
     <font color=#447700>! if( kpbl &lt;= 2 .or. hfx &lt; 100 ) then !~ lkb 8/25/08 changed to require + heat flux<a name='4761'></font>
      if(xland .eq.1 )then <font color=#447700>!~ LD 18-Oct-2011<a name='4762'></font>
      if( kpbl &lt;= 2 .or. hfx &lt; 100 ) then <font color=#447700>!~ lkb 8/25/08 changed to require + heat flux<a name='4763'></font>
      cupflag = .false.<a name='4764'>
      slopeSfc = 0.<a name='4765'>
      slopeEZ  = 0.<a name='4766'>
      sigmaSfc = 0.<a name='4767'>
      sigmaEZ  = 0.<a name='4768'>
      shall = 2                           <font color=#447700>! Added by LK Berg on 6/17/09 to stop shallow clouds at night<a name='4769'></font>
      return         <font color=#447700>! &lt;---Alternate return point<a name='4770'></font>
      else<a name='4771'>
      cupflag = .true.<a name='4772'>
      end if<a name='4773'>
      else<a name='4774'>
      if( kpbl &lt;= 2 .or. hfx &lt; 1 ) then <font color=#447700>!~ lkb 8/25/08 changed to require + heat flux<a name='4775'></font>
      cupflag = .false.<a name='4776'>
      slopeSfc = 0.<a name='4777'>
      slopeEZ  = 0.<a name='4778'>
      sigmaSfc = 0.<a name='4779'>
      sigmaEZ  = 0.<a name='4780'>
      shall = 2                           <font color=#447700>! Added by LK Berg on 6/17/09 to stop shallow clouds at night<a name='4781'></font>
      return         <font color=#447700>! &lt;---Alternate return point<a name='4782'></font>
      else<a name='4783'>
      cupflag = .true.<a name='4784'>
      end if<a name='4785'>
      end if  <a name='4786'>
<a name='4787'>
   <font color=#447700>! Convert height from AMSL to AGL...<a name='4788'></font>
   do k=kts, kte-1<a name='4789'>
      zagl(k) = z(k) - ht<a name='4790'>
   end do<a name='4791'>
<a name='4792'>
<font color=#447700>!!$           ! Find the index closest to the middle of the PBL...<a name='4793'></font>
<font color=#447700>!!$           kpblmid = 0<a name='4794'></font>
<font color=#447700>!!$           do k=kts, kte-1<a name='4795'></font>
<font color=#447700>!!$              if( zagl(k) &gt; pblh(i,j) ) then<a name='4796'></font>
<font color=#447700>!!$                 kpblmid = max(1, k/2)<a name='4797'></font>
<font color=#447700>!!$                 exit<a name='4798'></font>
<font color=#447700>!!$              end if<a name='4799'></font>
<font color=#447700>!!$           end do<a name='4800'></font>
<font color=#447700>!!$           if( kpblmid == 0 ) &amp;<a name='4801'></font>
<font color=#447700>!!$                call wrf_error("CuP ERROR: PBLH not within the domain.")<a name='4802'></font>
<a name='4803'>
   if( kpbl == 0 ) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUPSLOPESIGMA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_612">("CuP ERROR: kpbl==0")<a name='4804'>
<a name='4805'>
   <font color=#447700>! Calculate the Deardorff velocity, wStar. As a rough<a name='4806'></font>
   <font color=#447700>! approximation of the middle of PBL averaged theta and mixing<a name='4807'></font>
   <font color=#447700>! ratio, use the value at the middle of the PBL.<a name='4808'></font>
   <font color=#447700>! The flux amalgamation formula is from Stull, p.147 and<a name='4809'></font>
   <font color=#447700>! wStar is from Stull, p. 118.<a name='4810'></font>
   kpblmid = max(kts,kpbl/2)<a name='4811'>
   flux  = (1. + EP_1*qv_curr(1))*hfx/rho(1)/cp + &amp;<a name='4812'>
           EP_1*th(1)*qfx/rho(1)  <font color=#447700>!badbad/xlv<a name='4813'></font>
   tvcon = 1.+EP_1*qv_curr(kpblmid)<a name='4814'>
   thv   = th(kpblmid)*tvcon<a name='4815'>
   wStar = (g*pblh*flux/thv)**(1./3.)<a name='4816'>
      <font color=#447700>!!write(*,*) 'Larry ... wStar', wStar, pblh, flux, thv<a name='4817'></font>
   <font color=#447700>! Calculate the slope (dTemp/dMixRatio) for the surface layer<a name='4818'></font>
   <font color=#447700>! and entrainment zone...<a name='4819'></font>
   thv   = th(kpblmid)*tvcon  <font color=#447700>!Virt. pot. temp. at lowest model level<a name='4820'></font>
   tvcon = 1.+EP_1*qv_curr(1)<a name='4821'>
   thv2  = th(1)*tvcon  <font color=#447700>!Virt. pot. temp. at lowest model level<a name='4822'></font>
   qdiff = qv_curr(kpblmid)-qv_curr(1)<a name='4823'>
   if( abs(qdiff) &lt; reallysmall ) qdiff = sign(reallysmall,qdiff)<a name='4824'>
<font color=#447700>!   slopeSfc = (thv-thv2) / qdiff<a name='4825'></font>
<font color=#447700>!   Changed slopeSfc to use Bowen ratio<a name='4826'></font>
    slopeSfc = hfx/(xlv * qfx) * xlv / cp <font color=#447700>! Recall that hfx is in W m-2 and LH is also in W m-2<a name='4827'></font>
   tvcon = 1.+EP_1*qv_curr(min(kpbl+2,kte))<a name='4828'>
   thv   = th(min(kpbl+2,kte))*tvcon <a name='4829'>
   tvcon = 1.+EP_1*qv_curr(kpblmid)<a name='4830'>
   thv2  = th(kpblmid)*tvcon<a name='4831'>
   qdiff = qv_curr(min(kpbl+2,kte)) - qv_curr(kpblmid)<a name='4832'>
   if( abs(qdiff) &lt; reallysmall ) then<a name='4833'>
        qdiff = sign(reallysmall,qdiff)<a name='4834'>
   endif<a name='4835'>
   slopeEZ = (thv-thv2) / qdiff<a name='4836'>
   <font color=#447700>! Calculate the standard deviations along the theta and <a name='4837'></font>
   <font color=#447700>! mixing ratio axes of the PDF following Berg and Stull (2004)<a name='4838'></font>
   <font color=#447700>! eqs. 17a and 17b. For sigmaSfc, we currently are only using<a name='4839'></font>
   <font color=#447700>! rstar and not rstarNew.<a name='4840'></font>
   <font color=#447700>! For sigmaEZ, reuse the flux var that contains (w'thetav')bar<a name='4841'></font>
   sigmaEz = flux/wStar* &amp;<a name='4842'>
        ( 2. + (8.2e-4)* &amp;<a name='4843'>
        (zagl(kpblmid)/pblh)**(-1.8) )  <font color=#447700>! Changed by lkb, 1/21/09 to use kpblmid<a name='4844'></font>
        <font color=#447700>!!(zagl(min(kpbl+2,kte))/pblh)**(-1.8) )<a name='4845'></font>
<a name='4846'>
   flux = qfx/rho(1)  <font color=#447700>!badbad /xlv                ! (w'qv')bar<a name='4847'></font>
<font color=#447700>!!$           sigmaSfc(i,j) = flux*(1-zagl(1)/pblh(i,j))/wStar * &amp;<a name='4848'></font>
<font color=#447700>!!$                ( 2.3 + 1.1e-2*(zagl(1)/pblh(i,j))**(-1.6) )<a name='4849'></font>
   sigmaSfc = flux/wStar * &amp;<a name='4850'>
        ( 2.3 + 1.1e-2*(zagl(kpblmid)/pblh)**(-1.6) )<a name='4851'>
<a name='4852'>
#if 0<a name='4853'>
   <font color=#447700>!<a name='4854'></font>
   <font color=#447700>! Output the inputs to CuP for debugging with offline code...<a name='4855'></font>
   <font color=#447700>!<a name='4856'></font>
   call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUPSLOPESIGMA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_630">("Outputting cupin file.")<a name='4857'>
   k = 0<a name='4858'>
#ifdef ( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4859'></font>
   CALL MPI_Comm_rank ( MPI_COMM_WORLD, k, ierr ) <font color=#447700>!this isn't tested with MPI yet<a name='4860'></font>
#endif<a name='4861'>
   write(filename, '("cupin.",i3.3,".txt")') k<a name='4862'>
   fout = 17<a name='4863'>
   do <font color=#447700>!Make sure we use an available unit.<a name='4864'></font>
      inquire(UNIT=fout,OPENED=ierr)<a name='4865'>
      if( ierr==.true. ) exit<a name='4866'>
      fout = fout + 1<a name='4867'>
      if( fout &gt; 100 ) exit<a name='4868'>
   end do<a name='4869'>
   open(UNIT=fout, FILE=trim(filename), FORM="formatted", &amp;<a name='4870'>
        STATUS="unknown", IOSTAT=k)<a name='4871'>
   if( k /= 0 ) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kfcup.F.html#CUPSLOPESIGMA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_613">("Could not open cupin file.")<a name='4872'>
<a name='4873'>
   write(UNIT=fout,FMT='(a)') "Inputs to cup_driver..."<a name='4874'>
<font color=#447700>!!$   write(UNIT=fout,FMT='("ktau,i,j=",i,2i5)') ktau, i, j<a name='4875'></font>
<font color=#447700>!!$         write(UNIT=fout,FMT='("stepcu, dt=",i,g17.9)') stepcu, dt<a name='4876'></font>
<font color=#447700>!!$         write(UNIT=fout,FMT='("ids,ide, jds, jde, kds, kde=",6i5)') &amp;<a name='4877'></font>
<font color=#447700>!!$              ids,ide, jds, jde, kds, kde<a name='4878'></font>
<font color=#447700>!!$         write(UNIT=fout,FMT='("ims,ime, jms, jme, kms, kme=",6i5)') &amp;<a name='4879'></font>
<font color=#447700>!!$              ims,ime, jms, jme, kms, kme<a name='4880'></font>
<font color=#447700>!!$         write(UNIT=fout,FMT='("its,ite, jts, jte, kts, kte=",6i5)') &amp;<a name='4881'></font>
<font color=#447700>!!$              its,ite, jts, jte, kts, kte<a name='4882'></font>
<a name='4883'>
   write(UNIT=fout,FMT='("sf_sfclay_physics =",i)') sf_sfclay_physics<a name='4884'>
   write(UNIT=fout,FMT='("dx =",g17.9)') dx<a name='4885'>
   write(UNIT=fout,FMT='("psfc =",g17.9)') psfc<a name='4886'>
   write(UNIT=fout,FMT='("kpbl =",i)') kpbl<a name='4887'>
   write(UNIT=fout,FMT='("pblh =",g17.9)') pblh<a name='4888'>
   write(UNIT=fout,FMT='("ht =",g17.9)') ht<a name='4889'>
   write(UNIT=fout,FMT='("tsk =",g17.9)') tsk<a name='4890'>
   write(UNIT=fout,FMT='("t2 =",g17.9)') t2<a name='4891'>
   write(UNIT=fout,FMT='("q2 =",g17.9)') q2<a name='4892'>
   write(UNIT=fout,FMT='("hfx =",g17.9)') hfx<a name='4893'>
   write(UNIT=fout,FMT='("qfx =",g17.9)') qfx<a name='4894'>
   write(UNIT=fout,FMT='("mavail =",g17.9)') mavail<a name='4895'>
   write(UNIT=fout,FMT='("br =",g17.9)') br<a name='4896'>
   write(UNIT=fout,FMT='("regime =",g17.9)') regime<a name='4897'>
<a name='4898'>
   write(UNIT=fout,FMT='("p,rho, t, th, qv:")')<a name='4899'>
   do k=kts,kte<a name='4900'>
      write(UNIT=fout,FMT='("   ",5g17.9)') &amp;<a name='4901'>
           p(k), rho(k), t(k), th(k), qv_curr(k)<a name='4902'>
   end do<a name='4903'>
<a name='4904'>
   write(UNIT=fout,FMT='("z, dz8w, u, v:")')<a name='4905'>
   do k=kts,kte<a name='4906'>
      write(UNIT=fout,FMT='("   ",4g17.9)') &amp;<a name='4907'>
           z(k), dz8w(k), u(k), v(k)<a name='4908'>
   end do<a name='4909'>
<a name='4910'>
   write(UNIT=fout,FMT='(a)') "Calculated inside cup_driver..."<a name='4911'>
   write(UNIT=fout,FMT='("slopeSfc =",g17.9)') SlopeSfc<a name='4912'>
   write(UNIT=fout,FMT='("slopeEZ =",g17.9)') SlopeEZ<a name='4913'>
   write(UNIT=fout,FMT='("sigmaSfc =",g17.9)') sigmaSfc<a name='4914'>
   write(UNIT=fout,FMT='("sigmaEZ =",g17.9)') sigmaEZ<a name='4915'>
   write(UNIT=fout,FMT='("wStar =",g17.9)') wStar<a name='4916'>
   write(UNIT=fout,FMT='("dtcu =",g17.9)') dtcu<a name='4917'>
<a name='4918'>
   write(UNIT=fout,FMT='("zagl:")')<a name='4919'>
   do k=kts,kte<a name='4920'>
      write(UNIT=fout,FMT='("   ",1g17.9)') &amp;<a name='4921'>
           zagl(k)<a name='4922'>
   end do<a name='4923'>
<a name='4924'>
   close(UNIT=fout)<a name='4925'>
#endif<a name='4926'>
END SUBROUTINE cupSlopeSigma<a name='4927'>
<a name='4928'>
<a name='4929'>
<font color=#447700>!------------------------------------------------------------------------<a name='4930'></font>
<font color=#447700>! Find Cp for moist air<a name='4931'></font>
<font color=#447700>!<a name='4932'></font>
<A NAME='FINDCP'><A href='../../html_code/phys/module_cu_kfcup.F.html#FINDCP' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4933'>
<font color=#993300>FUNCTION </font><font color=#cc0000>findCp</font>(r) <A href='../../call_to/FINDCP.html' TARGET='index'>1</A><a name='4934'>
  implicit none<a name='4935'>
  real :: findCp<a name='4936'>
  real, intent(in) :: r  <font color=#447700>! Mixing ratio<a name='4937'></font>
<a name='4938'>
  findCp = 1004.67 * (1.0 + 0.84 * r)<a name='4939'>
END FUNCTION findCp<a name='4940'>
<a name='4941'>
<a name='4942'>
<font color=#447700>!------------------------------------------------------------------------<a name='4943'></font>
<font color=#447700>! Finds the index when an ordered list becomes bigger than a given value.<a name='4944'></font>
<font color=#447700>! The list is assumed to be ordered from small to big values.<a name='4945'></font>
<A NAME='FINDINDEX'><A href='../../html_code/phys/module_cu_kfcup.F.html#FINDINDEX' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4946'>
<font color=#993300>FUNCTION </font><font color=#cc0000>findIndex</font>(value,list) <A href='../../call_to/FINDINDEX.html' TARGET='index'>3</A><a name='4947'>
  implicit none<a name='4948'>
  integer :: findindex<a name='4949'>
  real, intent(in) :: value<a name='4950'>
  real, intent(in), dimension(:) :: list<a name='4951'>
<a name='4952'>
  integer :: i<a name='4953'>
<a name='4954'>
  findindex = 0<a name='4955'>
  do i=1,ubound(list,1)<a name='4956'>
     if( value &lt;= list(i) ) then<a name='4957'>
        findindex = i<a name='4958'>
        exit<a name='4959'>
     end if<a name='4960'>
  end do<a name='4961'>
END FUNCTION findIndex<a name='4962'>
<a name='4963'>
<font color=#447700>!------------------------------------------------------------------------<a name='4964'></font>
<font color=#447700>! Find the saturation mixing ratio w.r.t. water. This subroutine uses<a name='4965'></font>
<font color=#447700>! Teten's formula.<a name='4966'></font>
<font color=#447700>!    T in K and p in hPa<a name='4967'></font>
<A NAME='FINDRS'><A href='../../html_code/phys/module_cu_kfcup.F.html#FINDRS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4968'>
<font color=#993300>FUNCTION </font><font color=#cc0000>findRs</font>(t,p) <A href='../../call_to/FINDRS.html' TARGET='index'>3</A><a name='4969'>
  real :: findRs<a name='4970'>
  real, intent(in) :: t, p<a name='4971'>
  real :: es<a name='4972'>
<a name='4973'>
  es = 610.78 * exp( 17.67 * (t - 273.16) / (t - 29.66))<a name='4974'>
  findRs = eps * es / (p - es)<a name='4975'>
END FUNCTION findRs<a name='4976'>
<a name='4977'>
<a name='4978'>
<font color=#447700>!------------------------------------------------------------------------<a name='4979'></font>
<font color=#447700>! Find the saturation mixing ratio w.r.t. ice.<a name='4980'></font>
<font color=#447700>!    T in K and p in hPa<a name='4981'></font>
<A NAME='FINDRSI'><A href='../../html_code/phys/module_cu_kfcup.F.html#FINDRSI' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4982'>
<font color=#993300>FUNCTION </font><font color=#cc0000>findRsi</font>(t,p)<a name='4983'>
  real :: findRsi<a name='4984'>
  real, intent(in) :: t, p<a name='4985'>
  real :: esi<a name='4986'>
<a name='4987'>
<font color=#447700>! WMO formula:<a name='4988'></font>
<font color=#447700>!  esi = 10.**(-9.09685*(273.15/t - 1.) - 3.56654*log10(273.15/t) &amp;<a name='4989'></font>
<font color=#447700>!       + 0.87682*(1. - t/273.15) + 0.78614)<a name='4990'></font>
<a name='4991'>
<font color=#447700>! GoffGratch formula:<a name='4992'></font>
  esi = 10**(-9.09718*(273.15/t - 1.) - 3.56654*log10(273.15/t) &amp;<a name='4993'>
       + 0.876793*(1. - t/273.15) + log10(6.1071))<a name='4994'>
<a name='4995'>
  findRsi = eps * esi / (p - esi)<a name='4996'>
END FUNCTION findRsi<a name='4997'>
<a name='4998'>
<a name='4999'>
<font color=#447700>!------------------------------------------------------------------------<a name='5000'></font>
<A NAME='ACTIVATE_CLDBASE_KFCUP'><A href='../../html_code/phys/module_cu_kfcup.F.html#ACTIVATE_CLDBASE_KFCUP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5001'>
      <font color=#993300>subroutine </font><font color=#cc0000>activate_cldbase_kfcup</font>( idiagee, grid_id, ktau, &amp; <A href='../../call_to/ACTIVATE_CLDBASE_KFCUP.html' TARGET='index'>1</A>,<A href='../../call_from/ACTIVATE_CLDBASE_KFCUP.html' TARGET='index'>2</A><a name='5002'>
         ii, jj, kk, kts, kte, lc, kcldlayer, &amp;<a name='5003'>
         num_chem, maxd_acomp, maxd_aphase, maxd_atype, maxd_asize, &amp;<a name='5004'>
         ntype_aer, nsize_aer, ncomp_aer, &amp;<a name='5005'>
         ai_phase, msectional, massptr_aer, numptr_aer, &amp;<a name='5006'>
         dlo_sect, dhi_sect, dens_aer, hygro_aer, sigmag_aer, &amp;<a name='5007'>
         tk_act, rho_act, dp, w_act, &amp;<a name='5008'>
         chem1d, qndrop_act )<a name='5009'>
<a name='5010'>
      use <A href='../../html_code/phys/module_mixactivate.F.html#MODULE_MIXACTIVATE'>module_mixactivate</A><A href='../../html_code/phys/module_cu_kfcup.F.html#ACTIVATE_CLDBASE_KFCUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MIXACTIVATE_1">, only:  activate<a name='5011'>
<a name='5012'>
      integer, intent(in) :: &amp;<a name='5013'>
         idiagee, grid_id, ktau, &amp;<a name='5014'>
         ii, jj, kk, kts, kte, lc, kcldlayer, &amp;<a name='5015'>
         num_chem, maxd_acomp, maxd_aphase, maxd_atype, maxd_asize, &amp;<a name='5016'>
         msectional, ntype_aer, ai_phase<a name='5017'>
      integer, intent(in) :: ncomp_aer(maxd_atype), nsize_aer(maxd_atype)<a name='5018'>
      integer, intent(in) :: massptr_aer(maxd_acomp,maxd_asize,maxd_atype,maxd_aphase)<a name='5019'>
      integer, intent(in) :: numptr_aer(maxd_asize,maxd_atype,maxd_aphase)   <a name='5020'>
<a name='5021'>
      real, intent(in   ) :: chem1d(kts:kte,1:num_chem)<a name='5022'>
      real, intent(in   ) :: dens_aer(maxd_acomp,maxd_atype)<a name='5023'>
      real, intent(in   ) :: dlo_sect(maxd_asize,maxd_atype), dhi_sect(maxd_asize,maxd_atype)<a name='5024'>
      real, intent(in   ) :: dp(kts:kte)<a name='5025'>
      real, intent(in   ) :: hygro_aer(maxd_acomp,maxd_atype)<a name='5026'>
      real, intent(inout) :: qndrop_act<a name='5027'>
      real, intent(in   ) :: rho_act<a name='5028'>
      real, intent(in   ) :: sigmag_aer(maxd_asize,maxd_atype)<a name='5029'>
      real, intent(in   ) :: tk_act<a name='5030'>
      real, intent(in   ) :: w_act<a name='5031'>
<a name='5032'>
      integer :: icomp, iphase, isize, itype, k, l<a name='5033'>
<a name='5034'>
      real :: flux_fullact<a name='5035'>
      real :: tmpa, tmpdpsum, tmpvol, tmpwght<a name='5036'>
      real, dimension( 1:maxd_asize, 1:maxd_atype ) :: &amp;<a name='5037'>
                     fn, fs, fm, fluxn, fluxs, fluxm, &amp;<a name='5038'>
                     hygroavg, numbravg, volumavg<a name='5039'>
<a name='5040'>
<font color=#447700>!<a name='5041'></font>
<font color=#447700>! for each isize and itype, calculate average number, volume, and hygro<a name='5042'></font>
<font color=#447700>! over the updraft source layers<a name='5043'></font>
<font color=#447700>!<a name='5044'></font>
<font color=#447700>!     if (idiagee &gt; 0) write(98,'(//a,5i5)') 'kfcup activate_cldbase_kfcup - i, j, ksrc1/2', i, j, lc, kcldlayer<a name='5045'></font>
      hygroavg(:,:) = 0.0<a name='5046'>
      numbravg(:,:) = 0.0<a name='5047'>
      volumavg(:,:) = 0.0<a name='5048'>
      tmpdpsum = sum( dp(lc:kcldlayer) )<a name='5049'>
      iphase = ai_phase<a name='5050'>
      do k = lc, kcldlayer<a name='5051'>
         tmpwght = dp(k)/tmpdpsum<a name='5052'>
         do itype = 1, ntype_aer<a name='5053'>
         do isize = 1, nsize_aer(itype)<a name='5054'>
            l = numptr_aer(isize,itype,iphase)<a name='5055'>
            numbravg(isize,itype) = numbravg(isize,itype) + tmpwght*max( 0.0, chem1d(k,l) )<a name='5056'>
            do icomp = 1, ncomp_aer(itype)<a name='5057'>
               l = massptr_aer(icomp,isize,itype,iphase)<a name='5058'>
               tmpvol = max( 0.0, chem1d(k,l) ) / dens_aer(icomp,itype)<a name='5059'>
               volumavg(isize,itype) = volumavg(isize,itype) + tmpwght*tmpvol<a name='5060'>
               hygroavg(isize,itype) = hygroavg(isize,itype) + tmpwght*tmpvol*hygro_aer(icomp,itype)<a name='5061'>
            end do<a name='5062'>
         end do <font color=#447700>! isize<a name='5063'></font>
         end do <font color=#447700>! itype<a name='5064'></font>
      end do <font color=#447700>! k<a name='5065'></font>
<a name='5066'>
      do itype = 1, ntype_aer<a name='5067'>
      do isize = 1, nsize_aer(itype)<a name='5068'>
         hygroavg(isize,itype) = hygroavg(isize,itype) / max( 1.0e-35, volumavg(isize,itype) )<a name='5069'>
<font color=#447700>! convert numbravg from (#/kg) to (#/m3)<a name='5070'></font>
         numbravg(isize,itype) = numbravg(isize,itype)*rho_act<a name='5071'>
<font color=#447700>! convert volumavg to (m3/m3) -- need 1e-12 factor because (rho_act*chem1d)/dens_aer = [(ugaero/m3air)/(gaero/cm3aero)]<a name='5072'></font>
         volumavg(isize,itype) = volumavg(isize,itype)*rho_act*1.0e-12<a name='5073'>
<a name='5074'>
<font color=#447700>!        if (vaero_dsect_adjust_opt == 1) then<a name='5075'></font>
<font color=#447700>! recalc volumavg using particle diameter = dcen_sect<a name='5076'></font>
<font color=#447700>!           tmpvol = sqrt( dlo_sect(isize,itype) * dhi_sect(isize,itype) ) * 1.0e-2  ! particle diameter in (m)<a name='5077'></font>
<font color=#447700>!           tmpvol = (tmpvol**3) * 3.1415926536/6.0  ! particle volume in (m3)<a name='5078'></font>
<font color=#447700>!           volumavg(isize,itype) = numbravg(isize,itype) * tmpvol<a name='5079'></font>
<font color=#447700>!        end if<a name='5080'></font>
      end do <font color=#447700>! isize<a name='5081'></font>
      end do <font color=#447700>! itype<a name='5082'></font>
<a name='5083'>
<font color=#447700>! adjust number and volume for scm sensitivity testing<a name='5084'></font>
<font color=#447700>!     numbravg(:,:) = numbravg(:,:) * max( naero_adjust_factor, 1.0e-2 )<a name='5085'></font>
<font color=#447700>!     volumavg(:,:) = volumavg(:,:) * max( naero_adjust_factor, 1.0e-2 )<a name='5086'></font>
<a name='5087'>
      call <A href='../../html_code/phys/module_mp_full_sbm.F.html#ACTIVATE'>activate</A><A href='../../html_code/phys/module_cu_kfcup.F.html#ACTIVATE_CLDBASE_KFCUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACTIVATE_2">( w_act, 0.0, 0.0, 0.0, 1.0, tk_act, rho_act,  &amp;<a name='5088'>
                      msectional, maxd_atype, ntype_aer, maxd_asize, nsize_aer,    &amp;<a name='5089'>
                      numbravg, volumavg, dlo_sect, dhi_sect, sigmag_aer, hygroavg, &amp;<a name='5090'>
                      fn, fs, fm, fluxn, fluxs, fluxm, flux_fullact, &amp;<a name='5091'>
                      grid_id, ktau, ii, jj, kk )<a name='5092'>
<a name='5093'>
<font color=#447700>!     subroutine activate( wbar, sigw, wdiab, wminf, wmaxf, tair, rhoair,  &amp;<a name='5094'></font>
<font color=#447700>!                     msectional, maxd_atype, ntype_aer, maxd_asize, nsize_aer,    &amp;<a name='5095'></font>
<font color=#447700>!                     na, volc, dlo_sect, dhi_sect, sigman, hygro, &amp;<a name='5096'></font>
<font color=#447700>!                     fn, fs, fm, fluxn, fluxs, fluxm, flux_fullact, &amp;<a name='5097'></font>
<font color=#447700>!                     grid_id, ktau, ii, jj, kk )<a name='5098'></font>
<font color=#447700>!      mks units<a name='5099'></font>
<font color=#447700>!<a name='5100'></font>
<font color=#447700>!  input<a name='5101'></font>
<font color=#447700>!     integer,intent(in) :: maxd_atype      ! dimension of types<a name='5102'></font>
<font color=#447700>!     integer,intent(in) :: maxd_asize      ! dimension of sizes<a name='5103'></font>
<font color=#447700>!     integer,intent(in) :: ntype_aer       ! number of types<a name='5104'></font>
<font color=#447700>!     integer,intent(in) :: nsize_aer(maxd_atype) ! number of sizes for type<a name='5105'></font>
<font color=#447700>!     integer,intent(in) :: msectional      ! 1 for sectional, 0 for modal<a name='5106'></font>
<font color=#447700>!     integer,intent(in) :: grid_id         ! WRF grid%id<a name='5107'></font>
<font color=#447700>!     integer,intent(in) :: ktau            ! WRF time step count<a name='5108'></font>
<font color=#447700>!     integer,intent(in) :: ii, jj, kk      ! i,j,k of current grid cell<a name='5109'></font>
<font color=#447700>!     real,intent(in) :: wbar          ! grid cell mean vertical velocity (m/s)<a name='5110'></font>
<font color=#447700>!     real,intent(in) :: sigw          ! subgrid standard deviation of vertical vel (m/s)<a name='5111'></font>
<font color=#447700>!     real,intent(in) :: wdiab         ! diabatic vertical velocity (0 if adiabatic)<a name='5112'></font>
<font color=#447700>!     real,intent(in) :: wminf         ! minimum updraft velocity for integration (m/s)<a name='5113'></font>
<font color=#447700>!     real,intent(in) :: wmaxf         ! maximum updraft velocity for integration (m/s)<a name='5114'></font>
<font color=#447700>!     real,intent(in) :: tair          ! air temperature (K)<a name='5115'></font>
<font color=#447700>!     real,intent(in) :: rhoair        ! air density (kg/m3)<a name='5116'></font>
<font color=#447700>!     real,intent(in) :: na(maxd_asize,maxd_atype)     ! aerosol number concentration (/m3)<a name='5117'></font>
<font color=#447700>!     real,intent(in) :: sigman(maxd_asize,maxd_atype) ! geometric standard deviation of aerosol size distribution<a name='5118'></font>
<font color=#447700>!     real,intent(in) :: hygro(maxd_asize,maxd_atype)  ! bulk hygroscopicity of aerosol mode<a name='5119'></font>
<font color=#447700>!     real,intent(in) :: volc(maxd_asize,maxd_atype)   ! total aerosol volume  concentration (m3/m3)<a name='5120'></font>
<font color=#447700>!     real,intent(in) :: dlo_sect( maxd_asize, maxd_atype ), &amp;  ! minimum size of section (cm)<a name='5121'></font>
<font color=#447700>!                        dhi_sect( maxd_asize, maxd_atype )     ! maximum size of section (cm)<a name='5122'></font>
<font color=#447700>!<a name='5123'></font>
<font color=#447700>!  output<a name='5124'></font>
<font color=#447700>!     real,intent(inout) :: fn(maxd_asize,maxd_atype)    ! number fraction of aerosols activated<a name='5125'></font>
<font color=#447700>!     real,intent(inout) :: fs(maxd_asize,maxd_atype)    ! surface fraction of aerosols activated<a name='5126'></font>
<font color=#447700>!     real,intent(inout) :: fm(maxd_asize,maxd_atype)    ! mass fraction of aerosols activated<a name='5127'></font>
<font color=#447700>!     real,intent(inout) :: fluxn(maxd_asize,maxd_atype) ! flux of activated aerosol number fraction into cloud (m/s)<a name='5128'></font>
<font color=#447700>!     real,intent(inout) :: fluxs(maxd_asize,maxd_atype) ! flux of activated aerosol surface fraction (m/s)<a name='5129'></font>
<font color=#447700>!     real,intent(inout) :: fluxm(maxd_asize,maxd_atype) ! flux of activated aerosol mass fraction into cloud (m/s)<a name='5130'></font>
<font color=#447700>!     real,intent(inout) :: flux_fullact                 ! flux when activation fraction = 100% (m/s)<a name='5131'></font>
<a name='5132'>
      qndrop_act = 0.0<a name='5133'>
      do itype = 1, ntype_aer<a name='5134'>
      do isize = 1, nsize_aer(itype)<a name='5135'>
         qndrop_act = qndrop_act + numbravg(isize,itype)*fn(isize,itype)<a name='5136'>
         tmpa = max( numbravg(isize,itype), max(volumavg(isize,itype),1.0)*1.0e-30 )<a name='5137'>
         tmpa = (6.0*volumavg(isize,itype)/(3.1415926536*tmpa))**0.33333333<a name='5138'>
         if (idiagee &gt; 0) write(98,'(a,2i3,1p,9e10.2)') 'bin, numbr, volum, hygro, sg, dlo, dav, dhi, fn, fm', itype, isize, &amp;<a name='5139'>
            numbravg(isize,itype), volumavg(isize,itype), hygroavg(isize,itype), &amp;<a name='5140'>
            sigmag_aer(isize,itype), 0.01*dlo_sect(isize,itype), tmpa, 0.01*dhi_sect(isize,itype), &amp;<a name='5141'>
            fn(isize,itype), fm(isize,itype)<a name='5142'>
      end do <font color=#447700>! isize<a name='5143'></font>
      end do <font color=#447700>! itype<a name='5144'></font>
      qndrop_act = qndrop_act/rho_act<a name='5145'>
      if (idiagee &gt; 0) write(98,'(a,21x,i6,1p,2e10.2)') 'msectional, w_act, qndrop', msectional, w_act, qndrop_act<a name='5146'>
<a name='5147'>
      return<a name='5148'>
      end subroutine activate_cldbase_kfcup<a name='5149'>
<a name='5150'>
<a name='5151'>
<font color=#447700>!------------------------------------------------------------------------<a name='5152'></font>
<A NAME='ADJUST_MFENTDET_KFCUP'><A href='../../html_code/phys/module_cu_kfcup.F.html#ADJUST_MFENTDET_KFCUP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5153'>
      <font color=#993300>subroutine </font><font color=#cc0000>adjust_mfentdet_kfcup</font>( idiagee, grid_id, ktau, &amp; <A href='../../call_to/ADJUST_MFENTDET_KFCUP.html' TARGET='index'>2</A><a name='5154'>
         ii, jj, kts, kte, kcutop, ishall, &amp;<a name='5155'>
         umfout, uerout, udrout, dmfout, derout, ddrout )<a name='5156'>
<a name='5157'>
      integer, intent(in) :: &amp;<a name='5158'>
         idiagee, grid_id, ktau, &amp;<a name='5159'>
         ii, jj, kts, kte, kcutop, ishall<a name='5160'>
<a name='5161'>
      real, dimension( kts:kte ), intent(inout) :: &amp;<a name='5162'>
         umfout, uerout, udrout, dmfout, derout, ddrout<a name='5163'>
<a name='5164'>
      integer :: k<a name='5165'>
      real, parameter :: rtol = 1.0e-6<a name='5166'>
      real :: tmpa, tmpb, tmpc, tmpf, tmpg, tmph, tmpold<a name='5167'>
<a name='5168'>
<a name='5169'>
<font color=#447700>! check that delta(dmfout) = derout - ddrout<a name='5170'></font>
<font color=#447700>!    if not, then adjust either derout or ddrout<a name='5171'></font>
<font color=#447700>! the diagnostic output shows these adjustments to be very small,<a name='5172'></font>
<font color=#447700>!    so this may be unnecessary<a name='5173'></font>
check_dmf: &amp;<a name='5174'>
      if (ishall == 0) then<a name='5175'>
<a name='5176'>
      dmfout(kcutop:kte) = 0.0<a name='5177'>
      if (kcutop &lt; kte) then<a name='5178'>
        derout(kcutop+1:kte) = 0.0<a name='5179'>
        ddrout(kcutop+1:kte) = 0.0<a name='5180'>
      end if<a name='5181'>
      tmpg = 0.0<a name='5182'>
<a name='5183'>
      do k = kts, kcutop<a name='5184'>
         tmpa = dmfout(k)<a name='5185'>
         if (k &gt; kts) then<a name='5186'>
            tmpa = dmfout(k) - dmfout(k-1)<a name='5187'>
         else<a name='5188'>
            tmpa = dmfout(k)<a name='5189'>
         end if<a name='5190'>
         tmpb = derout(k) - ddrout(k)<a name='5191'>
         tmpc = tmpa - tmpb<a name='5192'>
         if (tmpc &gt; 0.0) then<a name='5193'>
            if (derout(k) &lt; ddrout(k)*0.05) then<a name='5194'>
               <font color=#447700>! der &lt;&lt; ddr, so decrease ddr first, then increase der if needed<a name='5195'></font>
               tmpold = ddrout(k)<a name='5196'>
               ddrout(k) = max( 0.0, ddrout(k) - tmpc )<a name='5197'>
               tmpg = tmpg + abs(ddrout(k)-tmpold)<a name='5198'>
               tmpb = derout(k) - ddrout(k)<a name='5199'>
               tmpc = tmpa - tmpb<a name='5200'>
               derout(k) = derout(k) + tmpc<a name='5201'>
               tmpg = tmpg + abs(tmpc)<a name='5202'>
            else<a name='5203'>
               <font color=#447700>! just increase der<a name='5204'></font>
               derout(k) = derout(k) + tmpc<a name='5205'>
               tmpg = tmpg + abs(tmpc)<a name='5206'>
            end if<a name='5207'>
         else<a name='5208'>
            if (ddrout(k) &lt;= derout(k)*0.05) then<a name='5209'>
               <font color=#447700>! ddr &lt;&lt; der, so decrease der first, then increase ddr if needed<a name='5210'></font>
               tmpold = derout(k)<a name='5211'>
               derout(k) = max( 0.0, derout(k) + tmpc )<a name='5212'>
               tmpg = tmpg + abs(derout(k)-tmpold)<a name='5213'>
               tmpb = derout(k) - ddrout(k)<a name='5214'>
               tmpc = tmpa - tmpb<a name='5215'>
               ddrout(k) = ddrout(k) - tmpc<a name='5216'>
               tmpg = tmpg + abs(tmpc)<a name='5217'>
            else<a name='5218'>
               <font color=#447700>! just increase ddr<a name='5219'></font>
               ddrout(k) = ddrout(k) - tmpc<a name='5220'>
               tmpg = tmpg + abs(tmpc)<a name='5221'>
            end if<a name='5222'>
         end if<a name='5223'>
      end do<a name='5224'>
<a name='5225'>
      if ( idiagee &gt; 0 ) then <a name='5226'>
         tmpf = sum(derout(kts:kcutop)) + sum(ddrout(kts:kcutop))<a name='5227'>
         tmph = tmpg/max(tmpg,tmpf,1.0e-20)<a name='5228'>
         if (abs(tmph) &gt; rtol) &amp;<a name='5229'>
            write(*,'(a,i9,2i5,1p,4e10.2)') 'kfcupmfadjup', ktau, ii, jj, &amp;<a name='5230'>
            minval(dmfout(kts:kcutop)), tmpf, tmpg, tmph<a name='5231'>
      end if<a name='5232'>
<a name='5233'>
      end if check_dmf<a name='5234'>
<a name='5235'>
<font color=#447700>! check that delta(umfout) = uerout - udrout<a name='5236'></font>
<font color=#447700>!    if not, then adjust either uerout or udrout<a name='5237'></font>
<font color=#447700>! the diagnostic output shows these adjustments to mostly be very small,<a name='5238'></font>
<font color=#447700>!    but there is an occasional problem at klcl, <a name='5239'></font>
<font color=#447700>! this suggests a problem in the code that calculates umf and uer,<a name='5240'></font>
<font color=#447700>!    but i have not been able to locate it, so this bandaid is needed<a name='5241'></font>
check_umf: &amp;<a name='5242'>
      if ((ishall == 0) .or. (ishall == 1)) then<a name='5243'>
<a name='5244'>
      umfout(kcutop:kte) = 0.0<a name='5245'>
      if (kcutop &lt; kte) then<a name='5246'>
        uerout(kcutop+1:kte) = 0.0<a name='5247'>
        udrout(kcutop+1:kte) = 0.0<a name='5248'>
      end if<a name='5249'>
      tmpg = 0.0<a name='5250'>
<a name='5251'>
      do k = kts, kcutop<a name='5252'>
         if (k &gt; kts) then<a name='5253'>
            tmpa = umfout(k) - umfout(k-1)<a name='5254'>
         else<a name='5255'>
            tmpa = umfout(k)<a name='5256'>
         end if<a name='5257'>
         tmpb = uerout(k) - udrout(k)<a name='5258'>
         tmpc = tmpa - tmpb<a name='5259'>
         if (tmpc &gt; 0.0) then<a name='5260'>
            if (uerout(k) &lt; udrout(k)*0.05) then<a name='5261'>
               <font color=#447700>! uer &lt;&lt; udr, so decrease udr first, then increase uer if needed<a name='5262'></font>
               tmpold = udrout(k)<a name='5263'>
               udrout(k) = max( 0.0, udrout(k) - tmpc )<a name='5264'>
               tmpg = tmpg + abs(udrout(k)-tmpold)<a name='5265'>
               tmpb = uerout(k) - udrout(k)<a name='5266'>
               tmpc = tmpa - tmpb<a name='5267'>
               uerout(k) = uerout(k) + tmpc<a name='5268'>
               tmpg = tmpg + abs(tmpc)<a name='5269'>
            else<a name='5270'>
               <font color=#447700>! just increase uer<a name='5271'></font>
               uerout(k) = uerout(k) + tmpc<a name='5272'>
               tmpg = tmpg + abs(tmpc)<a name='5273'>
            end if<a name='5274'>
         else<a name='5275'>
            if (udrout(k) &lt;= uerout(k)*0.05) then<a name='5276'>
               <font color=#447700>! udr &lt;&lt; uer, so decrease uer first, then increase udr if needed<a name='5277'></font>
               tmpold = uerout(k)<a name='5278'>
               uerout(k) = max( 0.0, uerout(k) + tmpc )<a name='5279'>
               tmpg = tmpg + abs(uerout(k)-tmpold)<a name='5280'>
               tmpb = uerout(k) - udrout(k)<a name='5281'>
               tmpc = tmpa - tmpb<a name='5282'>
               udrout(k) = udrout(k) - tmpc<a name='5283'>
               tmpg = tmpg + abs(tmpc)<a name='5284'>
            else<a name='5285'>
               <font color=#447700>! just increase udr<a name='5286'></font>
               udrout(k) = udrout(k) - tmpc<a name='5287'>
               tmpg = tmpg + abs(tmpc)<a name='5288'>
            end if<a name='5289'>
         end if<a name='5290'>
      end do<a name='5291'>
<a name='5292'>
      if ( idiagee &gt; 0 ) then<a name='5293'>
         tmpf = sum(uerout(kts:kcutop)) + sum(udrout(kts:kcutop))<a name='5294'>
         tmph = tmpg/max(tmpg,tmpf,1.0e-20)<a name='5295'>
         if (abs(tmph) &gt; rtol) &amp;<a name='5296'>
            write(*,'(a,i9,2i5,1p,4e10.2)') 'kfcupmfadjup', ktau, ii, jj, &amp;<a name='5297'>
            maxval(umfout(kts:kcutop)), tmpf, tmpg, tmph<a name='5298'>
      end if<a name='5299'>
<a name='5300'>
      end if check_umf<a name='5301'>
<a name='5302'>
<a name='5303'>
      return<a name='5304'>
      end subroutine adjust_mfentdet_kfcup<a name='5305'>
<a name='5306'>
<a name='5307'>
<font color=#447700>! rce 11-may-2012 mods start -------------------------------------------<a name='5308'></font>
<A NAME='CU_KFCUP_DIAGEE01'><A href='../../html_code/phys/module_cu_kfcup.F.html#CU_KFCUP_DIAGEE01' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5309'>
      <font color=#993300>subroutine </font><font color=#cc0000>cu_kfcup_diagee01</font>( &amp; <A href='../../call_to/CU_KFCUP_DIAGEE01.html' TARGET='index'>1</A><a name='5310'>
         ims, ime, jms, jme, kms, kme, kts, kte, &amp;<a name='5311'>
         i, j, &amp;<a name='5312'>
         idiagee, idiagff, ishall, ktau, &amp;<a name='5313'>
         kcubotmin, kcubotmax, kcutopmin, kcutopmax, &amp;<a name='5314'>
         activefrac, cldfra_cup1d, &amp;<a name='5315'>
         cubot, cutop, cumshallfreq1d, &amp;<a name='5316'>
         ddr_deep, der_deep, dmf_deep, dt, dz1d, &amp;<a name='5317'>
         fcvt_qc_to_pr_deep, fcvt_qc_to_qi_deep, fcvt_qi_to_pr_deep, &amp;<a name='5318'>
         fcvt_qc_to_pr_shall, fcvt_qc_to_qi_shall, fcvt_qi_to_pr_shall, &amp;<a name='5319'>
         nca_deep, nca_shall, p1d, pblh, &amp;<a name='5320'>
         qc_ic_deep, qc_ic_shall, qi_ic_deep, qi_ic_shall, qndrop_ic_cup, rho1d, &amp;<a name='5321'>
         tactive, taucloud, tstar, &amp;<a name='5322'>
         udr_deep, udr_shall, uer_deep, uer_shall, umf_deep, umf_shall, &amp;<a name='5323'>
         updfra_deep, updfra_shall, updfra_cup, &amp;<a name='5324'>
         wact_cup, wcloudbase, wcb_v2, wcb_v2_shall, &amp;<a name='5325'>
         wulcl_cup, wstar, z1d, z_at_w1d )<a name='5326'>
<a name='5327'>
<font color=#447700>! arguments<a name='5328'></font>
      integer, intent(in) :: &amp;<a name='5329'>
         ims, ime, jms, jme, kms, kme, kts, kte, &amp;<a name='5330'>
         i, j, &amp;<a name='5331'>
         idiagee, idiagff, ishall, ktau, &amp;<a name='5332'>
         kcubotmin, kcubotmax, kcutopmin, kcutopmax<a name='5333'>
<a name='5334'>
      real, intent(in) :: &amp;<a name='5335'>
         dt, &amp;<a name='5336'>
         nca_deep, &amp;<a name='5337'>
         nca_shall, &amp;<a name='5338'>
         updfra_deep, &amp;<a name='5339'>
         updfra_shall, &amp;<a name='5340'>
         wcb_v2, &amp;<a name='5341'>
         wcb_v2_shall, &amp;<a name='5342'>
         wstar<a name='5343'>
<a name='5344'>
      real, dimension( kts:kte ), intent(in) :: &amp;<a name='5345'>
         cumshallfreq1d, &amp;<a name='5346'>
         cldfra_cup1d, &amp;<a name='5347'>
         ddr_deep, &amp;<a name='5348'>
         der_deep, &amp;<a name='5349'>
         dmf_deep, &amp;<a name='5350'>
         dz1d, &amp;<a name='5351'>
         fcvt_qc_to_pr_deep, &amp;<a name='5352'>
         fcvt_qc_to_pr_shall, &amp;<a name='5353'>
         fcvt_qc_to_qi_deep, &amp;<a name='5354'>
         fcvt_qc_to_qi_shall, &amp;<a name='5355'>
         fcvt_qi_to_pr_deep, &amp;<a name='5356'>
         fcvt_qi_to_pr_shall, &amp;<a name='5357'>
         p1d, &amp;<a name='5358'>
         qc_ic_deep, &amp;<a name='5359'>
         qc_ic_shall, &amp;<a name='5360'>
         qi_ic_deep, &amp;<a name='5361'>
         qi_ic_shall, &amp;<a name='5362'>
         rho1d, &amp;<a name='5363'>
         udr_deep, &amp;<a name='5364'>
         udr_shall, &amp;<a name='5365'>
         uer_deep, &amp;<a name='5366'>
         uer_shall, &amp;<a name='5367'>
         umf_deep, &amp;<a name='5368'>
         umf_shall, &amp;<a name='5369'>
         z1d, &amp; <a name='5370'>
         z_at_w1d <a name='5371'>
<a name='5372'>
      real, dimension( ims:ime, jms:jme ), intent(in) :: &amp;<a name='5373'>
         activefrac, &amp;<a name='5374'>
         cubot, &amp;<a name='5375'>
         cutop, &amp;<a name='5376'>
         pblh, &amp;<a name='5377'>
         tactive, &amp;<a name='5378'>
         taucloud, &amp;<a name='5379'>
         tstar, &amp;<a name='5380'>
         wact_cup, &amp;<a name='5381'>
         wcloudbase, &amp;<a name='5382'>
         wulcl_cup<a name='5383'>
<a name='5384'>
      real, dimension( ims:ime, kms:kme, jms:jme ), intent(in) :: &amp;<a name='5385'>
         qndrop_ic_cup, &amp;<a name='5386'>
         updfra_cup<a name='5387'>
<a name='5388'>
<a name='5389'>
<font color=#447700>! local variables<a name='5390'></font>
      integer :: &amp;<a name='5391'>
         k, kcubot, kcutop<a name='5392'>
<a name='5393'>
      real :: tmpa, tmpb, tmpc, tmpd, tmpe, tmpf, tmpg, tmph, tmpi, tmpj<a name='5394'>
      real :: tmpr, tmps, tmpx, tmpy, tmpz<a name='5395'>
      real :: tmpcf<a name='5396'>
      real :: tmp_nca, tmp_updfra<a name='5397'>
      real :: tmpveca(1:999)<a name='5398'>
      real :: updfra<a name='5399'>
<a name='5400'>
      if (idiagee &gt; 0) then<a name='5401'>
<a name='5402'>
      tmpveca = 0.0<a name='5403'>
<a name='5404'>
      kcubot = nint(cubot(i,j))<a name='5405'>
      kcutop = nint(cutop(i,j))<a name='5406'>
      k = (kcubot+kcutop)/2<a name='5407'>
      updfra = 0.0 ; if (ishall == 0) updfra = updfra_deep ; if (ishall == 1) updfra = updfra_shall<a name='5408'>
<font color=#447700>!!!      write(*,'(a,1p,5e11.3,3x,3e11.3)') 'activefrac, cldfra(b/m/t), updfra', &amp;<a name='5409'></font>
<font color=#447700>!!!         activefrac(i,j), &amp;<a name='5410'></font>
<font color=#447700>!!!         cldfra_cup1d(kcubot), cldfra_cup1d(k), cldfra_cup1d(kcutop), updfra<a name='5411'></font>
<font color=#447700>!!!      write(*,'(a,1p,4e11.3,3x,3e11.3)') 'wcb, wcb_v2, wulcl, wact         ', &amp;<a name='5412'></font>
<font color=#447700>!!!         wcloudbase(i,j), wcb_v2_shall, wulcl_cup(i,j), wact_cup(i,j)<a name='5413'></font>
<font color=#447700>!!!      write(*,'(a,1p,5e11.3,3x,3e11.3)') 'qndrop(b/m/t/t-b)                ', &amp;<a name='5414'></font>
<font color=#447700>!!!         qndrop_ic_cup(kcubot), qndrop_ic_cup(k), qndrop_ic_cup(kcutop), &amp;<a name='5415'></font>
<font color=#447700>!!!         qndrop_ic_cup(kcutop)-qndrop_ic_cup(kcubot) <a name='5416'></font>
<font color=#447700>!!!      write(*,'(a,4i5,f9.5,10(2x,5i5))') 'updfraprofile*1e4', &amp;<a name='5417'></font>
<font color=#447700>!!!         ktau, ishall, kcubot, kcutop, updfra, &amp;<a name='5418'></font>
<font color=#447700>!!!         ( nint(updfra_cup(i,k,j)*1.0e4), k=kts,min(kte-1,kcutop+3) )<a name='5419'></font>
<a name='5420'>
      if ((ishall==1 .or. ishall==0) .and. idiagee&gt;0) then<a name='5421'>
         if (ishall == 1) then<a name='5422'>
            tmp_updfra = updfra_shall<a name='5423'>
            tmp_nca    = nca_shall<a name='5424'>
         else<a name='5425'>
            tmp_updfra = updfra_deep<a name='5426'>
            tmp_nca    = nca_deep<a name='5427'>
         end if<a name='5428'>
<a name='5429'>
         tmpa = 0.0 ; tmpb = 0.0 ; tmpc = 0.0 ; tmpd = 0.0 ; tmpe = 0.0 ; tmpf = 0.0<a name='5430'>
         do k=kts,kte<a name='5431'>
            if (ishall == 1) then<a name='5432'>
               tmpa = tmpa + max( 0.0, uer_shall(k) )<a name='5433'>
               tmpx = cumshallfreq1d(k)<a name='5434'>
            else<a name='5435'>
               tmpa = tmpa + max( 0.0, uer_deep(k) )<a name='5436'>
               tmpx = 1.0<a name='5437'>
            end if<a name='5438'>
            tmpcf = cldfra_cup1d(k)*tmpx<a name='5439'>
            tmpc = tmpc + max( 0.0, tmpcf             ) * dz1d(k)*rho1d(k)<a name='5440'>
<font color=#447700>!           tmpd = tmpd + max( 0.0, cldfra_cup(i,k,j) ) * dz1d(k)*rho1d(k)<a name='5441'></font>
            tmpd = tmpd + max( 0.0, cldfra_cup1d(k)   ) * dz1d(k)*rho1d(k)<a name='5442'>
<a name='5443'>
            tmpe = tmpe + max( 0.0, tmp_updfra*tmpx ) * dz1d(k)*rho1d(k)<a name='5444'>
            if (kcubot &lt;= k .and. k &lt;= kcutop) &amp;<a name='5445'>
            tmpf = tmpf + max( 0.0, tmp_updfra                   ) * dz1d(k)*rho1d(k)<a name='5446'>
         end do<a name='5447'>
         tmpa = tmpa*tmp_nca<a name='5448'>
         tmpb = cldfra_cup1d(kcubot)*wcb_v2*rho1d(kcubot)*tmp_nca<a name='5449'>
<font color=#447700>!        tmpg = 0.0<a name='5450'></font>
<font color=#447700>!        if (tmpd &gt; 1.0e-10) tmpg = tmpa/tmpd<a name='5451'></font>
<a name='5452'>
<font color=#447700>!        if (idiagee&gt;0) write(*,'(a,1p,6e11.3,0p,f11.3,i8)') 'entrain mass, cloud-vol mass b-e ', &amp;<a name='5453'></font>
<font color=#447700>!           tmpa, tmpf, tmpd, tmpe, tmpb, tmpc, tmpg, ktau<a name='5454'></font>
         if (idiagee&gt;0) write(*,'(a,1p,2e11.3,0p,2f9.3,2(3x,1p,2e11.3,0p,f9.3),i8,2(2x,3i3))') 'cloudmassaa ', &amp;<a name='5455'>
            tmpa, tmpb, &amp;<a name='5456'>
            tmpa/max(tmpc,1.0e-10), tmpb/max(tmpc,1.0e-10), &amp;<a name='5457'>
            tmpc, tmpd, max(tmpc,1.0e-10)/max(tmpd,1.0e-10), &amp;<a name='5458'>
            tmpe, tmpf, max(tmpe,1.0e-10)/max(tmpf,1.0e-10), &amp;<a name='5459'>
            ktau, kcubot, kcubotmin, kcubotmax, kcutop, kcutopmin, kcutopmax<a name='5460'>
<a name='5461'>
         tmpi = 0.0 ; tmpj = 0.0<a name='5462'>
         do k = kcubot, kcutop<a name='5463'>
            if (ishall == 1) then<a name='5464'>
                tmpi = tmpi + cldfra_cup1d(k)*dz1d(k)*rho1d(k)*qc_ic_shall(k)<a name='5465'>
            else<a name='5466'>
                tmpi = tmpi + cldfra_cup1d(k)*dz1d(k)*rho1d(k)*qc_ic_deep(k)<a name='5467'>
            end if<a name='5468'>
            tmpj = tmpj + cldfra_cup1d(k)*dz1d(k)*rho1d(k)<a name='5469'>
         end do<a name='5470'>
<a name='5471'>
         tmpveca(1) = tmpa/max(tmpd,1.0e-10)<a name='5472'>
         tmpveca(2) = tmpb/max(tmpd,1.0e-10)<a name='5473'>
         tmpveca(3) = cldfra_cup1d(kcubot)<a name='5474'>
         tmpveca(4) = sum( dz1d(kcubot:kcutop) )<a name='5475'>
         tmpveca(5) = wcb_v2<a name='5476'>
<a name='5477'>
         tmpa = tmpa/tmp_nca                               <font color=#447700>! total inflow<a name='5478'></font>
         tmpg = tmpd * (tmp_updfra/cldfra_cup1d(kcubot))   <font color=#447700>! updraft mass<a name='5479'></font>
         tmpveca(101) = cldfra_cup1d(kcubot)<a name='5480'>
         tmpveca(102) = tmp_updfra<a name='5481'>
         tmpveca(103) = sum( dz1d(kcubot:kcutop) )<a name='5482'>
         tmpveca(104) = wcb_v2                           <font color=#447700>! w at cloud base<a name='5483'></font>
         tmpveca(105) = tmpd                                 <font color=#447700>! cloud mass<a name='5484'></font>
         tmpveca(106) = tmpa                                 <font color=#447700>! total inflow<a name='5485'></font>
         if (ishall == 1) then<a name='5486'>
            tmpveca(107) = umf_shall(max(1,kcubot-1))        <font color=#447700>! cloud base inflow<a name='5487'></font>
         else<a name='5488'>
            tmpveca(107) = umf_deep(max(1,kcubot-1))         <font color=#447700>! cloud base inflow<a name='5489'></font>
         end if<a name='5490'>
         tmpveca(108) = tmpg/tmpa                            <font color=#447700>! time to "fill" updraft<a name='5491'></font>
         tmpveca(109) = tmpd/tmpa                            <font color=#447700>! time to "fill" cloud<a name='5492'></font>
         tmpveca(110) = tactive(i,j)                         <font color=#447700>! active cloud time-scale<a name='5493'></font>
         tmpveca(111) = taucloud(i,j)                        <font color=#447700>! cloud dissipation time-scale<a name='5494'></font>
         tmpveca(112) = tstar(i,j)                           <font color=#447700>! boundary layer time-scale<a name='5495'></font>
         tmpveca(113) = wstar                                <font color=#447700>! boundary layer convective velocity scale<a name='5496'></font>
         tmpveca(114) = pblh(i,j)                            <font color=#447700>! pbl height (m)<a name='5497'></font>
         tmpveca(115) = z_at_w1d(kcubot  ) - z_at_w1d(kts)   <font color=#447700>! bottom of cloudbase layer (m agl)<a name='5498'></font>
         tmpveca(116) = z_at_w1d(kcutop+1) - z_at_w1d(kts)   <font color=#447700>! top    of cloudtop  layer (m agl)<a name='5499'></font>
         tmpveca(117) = (tmpi/max(tmpj,1.0e-30))*1.0e3       <font color=#447700>! convert kg/kg to g/kg<a name='5500'></font>
<a name='5501'>
         tmpveca(106:107) = tmpveca(106:107)*60.0            <font color=#447700>! convert kg/m2/s to kg/m2/min<a name='5502'></font>
         tmpveca(108:112) = tmpveca(108:112)/60.0            <font color=#447700>! convert s to min<a name='5503'></font>
      end if <font color=#447700>! ((ishall==1 .or. ishall==0) .and. idiagee&gt;0) then<a name='5504'></font>
<a name='5505'>
      if (idiagee&gt;0 .and. ishall==1) then<a name='5506'>
         write(*,'(a)') 'k, p, z, dz, umf, del(umf), uer-udr, uer, -udr, qc, qi, f_qc2qi, f_qc2pr, f_qi2pr'<a name='5507'>
         do k = min( kcutop+2, kte-1 ), kts, -1<a name='5508'>
            if (k .eq. kts) then<a name='5509'>
               tmpa = umf_shall(k)<a name='5510'>
            else<a name='5511'>
               tmpa = umf_shall(k) - umf_shall(k-1)<a name='5512'>
            end if<a name='5513'>
            tmpb = uer_shall(k) - udr_shall(k)<a name='5514'>
            write(*,'(i2,1p,3e11.3,3x,5e11.3,3x,5e11.3)') &amp;<a name='5515'>
               k, p1d(k), z1d(k), dz1d(k), umf_shall(k), tmpa, tmpb, uer_shall(k), -udr_shall(k), &amp;<a name='5516'>
               qc_ic_shall(k), qi_ic_shall(k), fcvt_qc_to_qi_shall(k), fcvt_qc_to_pr_shall(k), fcvt_qi_to_pr_shall(k)<a name='5517'>
         end do<a name='5518'>
      end if <font color=#447700>! (idiagee&gt;0 .and. ishall==1) then<a name='5519'></font>
<a name='5520'>
      if (idiagee&gt;0 .and. ishall==0) then<a name='5521'>
         write(*,'(a)') 'k, p, z, dz, umf, del(umf), uer-udr, uer, -udr, qc, qi, f_qc2qi, f_qc2pr, f_qi2pr'<a name='5522'>
         do k = min( kcutop+2, kte-1 ), kts, -1<a name='5523'>
            if (k .eq. kts) then<a name='5524'>
               tmpa = umf_deep(k)<a name='5525'>
            else<a name='5526'>
               tmpa = umf_deep(k) - umf_deep(k-1)<a name='5527'>
            end if<a name='5528'>
            tmpb = uer_deep(k) - udr_deep(k)<a name='5529'>
            write(*,'(i2,1p,3e11.3,3x,5e11.3,3x,5e11.3)') &amp;<a name='5530'>
               k, p1d(k), z1d(k), dz1d(k), umf_deep(k), tmpa, tmpb, uer_deep(k), -udr_deep(k), &amp;<a name='5531'>
               qc_ic_deep(k), qi_ic_deep(k), fcvt_qc_to_qi_deep(k), fcvt_qc_to_pr_deep(k), fcvt_qi_to_pr_deep(k)<a name='5532'>
         end do<a name='5533'>
         write(*,'(a)') 'k, p, z, dz, dmf, del(dmf), der-ddr, der, -ddr, qc'<a name='5534'>
         do k = min( kcutop+2, kte-1 ), kts, -1<a name='5535'>
            if (k .eq. kts) then<a name='5536'>
               tmpa = dmf_deep(k)<a name='5537'>
            else<a name='5538'>
               tmpa = dmf_deep(k) - dmf_deep(k-1)<a name='5539'>
            end if<a name='5540'>
            tmpb = der_deep(k) - ddr_deep(k)<a name='5541'>
            write(*,'(i2,1p,3e11.3,3x,5e11.3,3x,5e11.3)') &amp;<a name='5542'>
               k, p1d(k), z1d(k), dz1d(k), dmf_deep(k), tmpa, tmpb, der_deep(k), -ddr_deep(k), qc_ic_deep(k)<a name='5543'>
         end do<a name='5544'>
      end if <font color=#447700>! (idiagee&gt;0 .and. ishall==0) then<a name='5545'></font>
<a name='5546'>
      write(*,'(i6,1p,6e11.3,a)') &amp;<a name='5547'>
         ktau, (ktau*dt/3600.0), tmpveca(1:5), &amp;<a name='5548'>
         '  cloudmassbb ktau, t(h), ratio1, ratio2, cldfra, cldhgt, wcb'<a name='5549'>
<a name='5550'>
      write(*,'(i6,i2, f7.2, 2x,2f8.5,f8.2,2f7.3, 2x,f9.4,2f9.5, 2x,5f8.2, 3f9.1,f9.5, 3a)') &amp;<a name='5551'>
         ktau, ishall, (ktau*dt/3600.0), tmpveca(101:104), tmpveca(113), &amp;<a name='5552'>
         min(9999.99,tmpveca(105)), min(99.99,tmpveca(106:107)), &amp;<a name='5553'>
         min(9999.99,tmpveca(108:112)), min(99999.9,tmpveca(114:116)), min(99.9999,tmpveca(117)), &amp;<a name='5554'>
         '  cloudmasscc ktau,ish,t(h),  cldfra,updfra,cldhgt,wcb,wstar', &amp;<a name='5555'>
         ',  cldmass,uertot,uerbase,  tauinupd,tauincld,tactive,taucloud,tstar', &amp;<a name='5556'>
         ',  pblh,zbot,ztop, qc_ic_av'<a name='5557'>
<a name='5558'>
      end if <font color=#447700>! (idiagee &gt; 0) then<a name='5559'></font>
<a name='5560'>
      return<a name='5561'>
      end subroutine cu_kfcup_diagee01<a name='5562'>
<font color=#447700>! rce 11-may-2012 mods end ---------------------------------------------<a name='5563'></font>
<a name='5564'>
<a name='5565'>
END MODULE module_cu_kfcup<a name='5566'>
</pre></body></html>