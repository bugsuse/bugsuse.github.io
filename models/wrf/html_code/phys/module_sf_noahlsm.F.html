<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_SF_NOAHLSM'><A href='../../html_code/phys/module_sf_noahlsm.F.html#MODULE_SF_NOAHLSM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sf_noahlsm</font> <A href='../../call_to/MODULE_SF_NOAHLSM.html' TARGET='index'>7</A><a name='3'>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#module_sf_noahlsm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_96">, only : CP, R_D, XLF, XLV, RHOWATER, STBOLT, KARMAN<a name='4'>
<a name='5'>
<font color=#447700>!ckay=KIRAN ALAPATY @ US EPA -- November 01, 2015<a name='6'></font>
<font color=#447700>!<a name='7'></font>
<font color=#447700>! Tim Glotfelty@CNSU; AJ Deng@PSU<a name='8'></font>
<font color=#447700>!modified for use with FASDAS <a name='9'></font>
<font color=#447700>!Flux Adjusting Surface Data Assimilation System to assimilate <a name='10'></font>
<font color=#447700>!surface layer and soil layers temperature and moisture using<a name='11'></font>
<font color=#447700>! surfance reanalsys <a name='12'></font>
<font color=#447700>!Reference: Alapaty et al., 2008: Development of the flux-adjusting surface<a name='13'></font>
<font color=#447700>! data assimilation system for mesoscale models. JAMC, 47, 2331-2350<a name='14'></font>
<font color=#447700>!<a name='15'></font>
<a name='16'>
<font color=#447700>!   REAL, PARAMETER    :: CP = 1004.5<a name='17'></font>
  REAL, PARAMETER      :: RD = 287.04, SIGMA = 5.67E-8,                 &amp;<a name='18'>
                          CPH2O = 4.218E+3,CPICE = 2.106E+3,            &amp;<a name='19'>
                          LSUBF = 3.335E+5,                             &amp;<a name='20'>
                          EMISSI_S = 0.95<a name='21'>
<a name='22'>
<font color=#447700>! VEGETATION PARAMETERS<a name='23'></font>
        INTEGER :: LUCATS , BARE<a name='24'>
        INTEGER :: NATURAL<a name='25'>
        INTEGER :: LOW_DENSITY_RESIDENTIAL, HIGH_DENSITY_RESIDENTIAL, HIGH_INTENSITY_INDUSTRIAL<a name='26'>
        integer, PARAMETER :: NLUS=50<a name='27'>
        CHARACTER(LEN=256) LUTYPE<a name='28'>
        INTEGER, DIMENSION(1:NLUS) :: NROTBL<a name='29'>
        real, dimension(1:NLUS) ::  SNUPTBL, RSTBL, RGLTBL, HSTBL,                &amp;<a name='30'>
                                    SHDTBL, MAXALB,                               &amp;<a name='31'>
                                    EMISSMINTBL, EMISSMAXTBL,                     &amp;<a name='32'>
                                    LAIMINTBL, LAIMAXTBL,                         &amp;<a name='33'>
                                    Z0MINTBL, Z0MAXTBL,                           &amp;<a name='34'>
                                    ALBEDOMINTBL, ALBEDOMAXTBL,                   &amp;<a name='35'>
                                    ZTOPVTBL,ZBOTVTBL<a name='36'>
        REAL ::   TOPT_DATA,CMCMAX_DATA,CFACTR_DATA,RSMAX_DATA<a name='37'>
<a name='38'>
<font color=#447700>! SOIL PARAMETERS<a name='39'></font>
        INTEGER :: SLCATS<a name='40'>
        INTEGER, PARAMETER :: NSLTYPE=30<a name='41'>
        CHARACTER(LEN=256) SLTYPE<a name='42'>
        REAL, DIMENSION (1:NSLTYPE) :: BB,DRYSMC,F11,                           &amp;<a name='43'>
        MAXSMC, REFSMC,SATPSI,SATDK,SATDW, WLTSMC,QTZ<a name='44'>
<a name='45'>
<font color=#447700>! LSM GENERAL PARAMETERS<a name='46'></font>
        INTEGER :: SLPCATS<a name='47'>
        INTEGER, PARAMETER :: NSLOPE=30<a name='48'>
        REAL, DIMENSION (1:NSLOPE) :: SLOPE_DATA<a name='49'>
        REAL ::  SBETA_DATA,FXEXP_DATA,CSOIL_DATA,SALP_DATA,REFDK_DATA,           &amp;<a name='50'>
                 REFKDT_DATA,FRZK_DATA,ZBOT_DATA,  SMLOW_DATA,SMHIGH_DATA,        &amp;<a name='51'>
                        CZIL_DATA<a name='52'>
        REAL ::  LVCOEF_DATA<a name='53'>
<a name='54'>
        CHARACTER*256  :: err_message<a name='55'>
<a name='56'>
        integer, private :: iloc, jloc<a name='57'>
<font color=#447700>!$omp threadprivate(iloc, jloc)<a name='58'></font>
<font color=#447700>!<a name='59'></font>
CONTAINS<a name='60'>
<font color=#447700>!<a name='61'></font>
<a name='62'>
<A NAME='SFLX'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='63'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFLX</font> (IILOC,JJLOC,FFROZP,ISURBAN,DT,ZLVL,NSOIL,SLDPTH, &amp;    <font color=#447700>!C <A href='../../call_to/SFLX.html' TARGET='index'>3</A>,<A href='../../call_from/SFLX.html' TARGET='index'>14</A><a name='64'></font>
                       LOCAL,                                           &amp;    <font color=#447700>!L<a name='65'></font>
                       LLANDUSE, LSOIL,                                 &amp;    <font color=#447700>!CL<a name='66'></font>
                       LWDN,SOLDN,SOLNET,SFCPRS,PRCP,SFCTMP,Q2,SFCSPD,  &amp;    <font color=#447700>!F<a name='67'></font>
                       COSZ,PRCPRAIN, SOLARDIRECT,                      &amp;    <font color=#447700>!F<a name='68'></font>
                       TH2,Q2SAT,DQSDT2,                                &amp;    <font color=#447700>!I<a name='69'></font>
                       VEGTYP,SOILTYP,SLOPETYP,SHDFAC,SHDMIN,SHDMAX,    &amp;    <font color=#447700>!I<a name='70'></font>
                       ALB, SNOALB,TBOT, Z0BRD, Z0, EMISSI, EMBRD,      &amp;    <font color=#447700>!S<a name='71'></font>
                       CMC,T1,STC,SMC,SH2O,SNOWH,SNEQV,ALBEDO,CH,CM,    &amp;    <font color=#447700>!H<a name='72'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='73'></font>
<font color=#447700>! OUTPUTS, DIAGNOSTICS, PARAMETERS BELOW GENERALLY NOT NECESSARY WHEN<a name='74'></font>
<font color=#447700>! COUPLED WITH E.G. A NWP MODEL (SUCH AS THE NOAA/NWS/NCEP MESOSCALE ETA<a name='75'></font>
<font color=#447700>! MODEL).  OTHER APPLICATIONS MAY REQUIRE DIFFERENT OUTPUT VARIABLES.<a name='76'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='77'></font>
                       ETA,SHEAT, ETA_KINEMATIC,FDOWN,                  &amp;    <font color=#447700>!O<a name='78'></font>
                       EC,EDIR,ET,ETT,ESNOW,DRIP,DEW,                   &amp;    <font color=#447700>!O<a name='79'></font>
                       BETA,ETP,SSOIL,                                  &amp;    <font color=#447700>!O<a name='80'></font>
                       FLX1,FLX2,FLX3,                                  &amp;    <font color=#447700>!O<a name='81'></font>
		       FLX4,FVB,FBUR,FGSN,UA_PHYS,                      &amp;    <font color=#447700>!UA <a name='82'></font>
                       SNOMLT,SNCOVR,                                   &amp;    <font color=#447700>!O<a name='83'></font>
                       RUNOFF1,RUNOFF2,RUNOFF3,                         &amp;    <font color=#447700>!O<a name='84'></font>
                       RC,PC,RSMIN,XLAI,RCS,RCT,RCQ,RCSOIL,             &amp;    <font color=#447700>!O<a name='85'></font>
                       SOILW,SOILM,Q1,SMAV,                             &amp;    <font color=#447700>!D<a name='86'></font>
                       RDLAI2D,USEMONALB,                               &amp;<a name='87'>
                       SNOTIME1,                                        &amp;<a name='88'>
                       RIBB,                                            &amp;<a name='89'>
                       SMCWLT,SMCDRY,SMCREF,SMCMAX,NROOT,   &amp;<a name='90'>
                       SFHEAD1RT,                                       &amp;    <font color=#447700>!I<a name='91'></font>
                       INFXS1RT,ETPND1,OPT_THCND,AOASIS                 &amp;    <font color=#447700>!P<a name='92'></font>
                      ,XSDA_QFX,HFX_PHY,QFX_PHY,XQNORM                  &amp;    <font color=#447700>!fasdas<a name='93'></font>
                      ,fasdas,HCPCT_FASDAS                              )    <font color=#447700>!fasdas<a name='94'></font>
<a name='95'>
<font color=#447700>! ----------------------------------------------------------------------<a name='96'></font>
<font color=#447700>! SUBROUTINE SFLX - UNIFIED NOAHLSM VERSION 1.0 JULY 2007<a name='97'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='98'></font>
<font color=#447700>! SUB-DRIVER FOR "Noah LSM" FAMILY OF PHYSICS SUBROUTINES FOR A<a name='99'></font>
<font color=#447700>! SOIL/VEG/SNOWPACK LAND-SURFACE MODEL TO UPDATE SOIL MOISTURE, SOIL<a name='100'></font>
<font color=#447700>! ICE, SOIL TEMPERATURE, SKIN TEMPERATURE, SNOWPACK WATER CONTENT,<a name='101'></font>
<font color=#447700>! SNOWDEPTH, AND ALL TERMS OF THE SURFACE ENERGY BALANCE AND SURFACE<a name='102'></font>
<font color=#447700>! WATER BALANCE (EXCLUDING INPUT ATMOSPHERIC FORCINGS OF DOWNWARD<a name='103'></font>
<font color=#447700>! RADIATION AND PRECIP)<a name='104'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='105'></font>
<font color=#447700>! SFLX ARGUMENT LIST KEY:<a name='106'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='107'></font>
<font color=#447700>!  C  CONFIGURATION INFORMATION<a name='108'></font>
<font color=#447700>!  L  LOGICAL<a name='109'></font>
<font color=#447700>! CL  4-string character bearing logical meaning<a name='110'></font>
<font color=#447700>!  F  FORCING DATA<a name='111'></font>
<font color=#447700>!  I  OTHER (INPUT) FORCING DATA<a name='112'></font>
<font color=#447700>!  S  SURFACE CHARACTERISTICS<a name='113'></font>
<font color=#447700>!  H  HISTORY (STATE) VARIABLES<a name='114'></font>
<font color=#447700>!  O  OUTPUT VARIABLES<a name='115'></font>
<font color=#447700>!  D  DIAGNOSTIC OUTPUT<a name='116'></font>
<font color=#447700>!  P  Parameters<a name='117'></font>
<font color=#447700>!  Msic Miscellaneous terms passed from gridded driver<a name='118'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='119'></font>
<font color=#447700>! 1. CONFIGURATION INFORMATION (C):<a name='120'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='121'></font>
<font color=#447700>!   DT         TIMESTEP (SEC) (DT SHOULD NOT EXCEED 3600 SECS, RECOMMEND<a name='122'></font>
<font color=#447700>!                1800 SECS OR LESS)<a name='123'></font>
<font color=#447700>!   ZLVL       HEIGHT (M) ABOVE GROUND OF ATMOSPHERIC FORCING VARIABLES<a name='124'></font>
<font color=#447700>!   NSOIL      NUMBER OF SOIL LAYERS (AT LEAST 2, AND NOT GREATER THAN<a name='125'></font>
<font color=#447700>!                PARAMETER NSOLD SET BELOW)<a name='126'></font>
<font color=#447700>!   SLDPTH     THE THICKNESS OF EACH SOIL LAYER (M)<a name='127'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='128'></font>
<font color=#447700>! 2. LOGICAL:<a name='129'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='130'></font>
<font color=#447700>!   LCH       Exchange coefficient (Ch) calculation flag (false: using<a name='131'></font>
<font color=#447700>!                ch-routine SFCDIF; true: Ch is brought in)<a name='132'></font>
<font color=#447700>!   LOCAL      Flag for local-site simulation (where there is no<a name='133'></font>
<font color=#447700>!              maps for albedo, veg fraction, and roughness<a name='134'></font>
<font color=#447700>!             true:  all LSM parameters (inluding albedo, veg fraction and<a name='135'></font>
<font color=#447700>!                    roughness length) will be defined by three tables<a name='136'></font>
<font color=#447700>!   LLANDUSE  (=USGS, using USGS landuse classification)<a name='137'></font>
<font color=#447700>!   LSOIL     (=STAS, using FAO/STATSGO soil texture classification)<a name='138'></font>
<font color=#447700>!   OPT_THCND option for how to treat thermal conductivity<a name='139'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='140'></font>
<font color=#447700>! 3. FORCING DATA (F):<a name='141'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='142'></font>
<font color=#447700>!   LWDN       LW DOWNWARD RADIATION (W M-2; POSITIVE, NOT NET LONGWAVE)<a name='143'></font>
<font color=#447700>!   SOLDN      SOLAR DOWNWARD RADIATION (W M-2; POSITIVE, NOT NET SOLAR)<a name='144'></font>
<font color=#447700>!   SOLNET     NET DOWNWARD SOLAR RADIATION ((W M-2; POSITIVE)<a name='145'></font>
<font color=#447700>!   SFCPRS     PRESSURE AT HEIGHT ZLVL ABOVE GROUND (PASCALS)<a name='146'></font>
<font color=#447700>!   PRCP       PRECIP RATE (KG M-2 S-1) (NOTE, THIS IS A RATE)<a name='147'></font>
<font color=#447700>!   SFCTMP     AIR TEMPERATURE (K) AT HEIGHT ZLVL ABOVE GROUND<a name='148'></font>
<font color=#447700>!   TH2        AIR POTENTIAL TEMPERATURE (K) AT HEIGHT ZLVL ABOVE GROUND<a name='149'></font>
<font color=#447700>!   Q2         MIXING RATIO AT HEIGHT ZLVL ABOVE GROUND (KG KG-1)<a name='150'></font>
<font color=#447700>!   COSZ       Solar zenith angle (not used for now)<a name='151'></font>
<font color=#447700>!   PRCPRAIN   Liquid-precipitation rate (KG M-2 S-1) (not used)<a name='152'></font>
<font color=#447700>! SOLARDIRECT  Direct component of downward solar radiation (W M-2) (not used)<a name='153'></font>
<font color=#447700>!   FFROZP     FRACTION OF FROZEN PRECIPITATION<a name='154'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='155'></font>
<font color=#447700>! 4. OTHER FORCING (INPUT) DATA (I):<a name='156'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='157'></font>
<font color=#447700>!   SFCSPD     WIND SPEED (M S-1) AT HEIGHT ZLVL ABOVE GROUND<a name='158'></font>
<font color=#447700>!   Q2SAT      SAT SPECIFIC HUMIDITY AT HEIGHT ZLVL ABOVE GROUND (KG KG-1)<a name='159'></font>
<font color=#447700>!   DQSDT2     SLOPE OF SAT SPECIFIC HUMIDITY CURVE AT T=SFCTMP<a name='160'></font>
<font color=#447700>!                (KG KG-1 K-1)<a name='161'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='162'></font>
<font color=#447700>! 5. CANOPY/SOIL CHARACTERISTICS (S):<a name='163'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='164'></font>
<font color=#447700>!   VEGTYP     VEGETATION TYPE (INTEGER INDEX)<a name='165'></font>
<font color=#447700>!   SOILTYP    SOIL TYPE (INTEGER INDEX)<a name='166'></font>
<font color=#447700>!   SLOPETYP   CLASS OF SFC SLOPE (INTEGER INDEX)<a name='167'></font>
<font color=#447700>!   SHDFAC     AREAL FRACTIONAL COVERAGE OF GREEN VEGETATION<a name='168'></font>
<font color=#447700>!                (FRACTION= 0.0-1.0)<a name='169'></font>
<font color=#447700>!   SHDMIN     MINIMUM AREAL FRACTIONAL COVERAGE OF GREEN VEGETATION<a name='170'></font>
<font color=#447700>!                (FRACTION= 0.0-1.0) &lt;= SHDFAC<a name='171'></font>
<font color=#447700>!   PTU        PHOTO THERMAL UNIT (PLANT PHENOLOGY FOR ANNUALS/CROPS)<a name='172'></font>
<font color=#447700>!                (NOT YET USED, BUT PASSED TO REDPRM FOR FUTURE USE IN<a name='173'></font>
<font color=#447700>!                VEG PARMS)<a name='174'></font>
<font color=#447700>!   ALB        BACKROUND SNOW-FREE SURFACE ALBEDO (FRACTION), FOR JULIAN<a name='175'></font>
<font color=#447700>!                DAY OF YEAR (USUALLY FROM TEMPORAL INTERPOLATION OF<a name='176'></font>
<font color=#447700>!                MONTHLY MEAN VALUES' CALLING PROG MAY OR MAY NOT<a name='177'></font>
<font color=#447700>!                INCLUDE DIURNAL SUN ANGLE EFFECT)<a name='178'></font>
<font color=#447700>!   SNOALB     UPPER BOUND ON MAXIMUM ALBEDO OVER DEEP SNOW (E.G. FROM<a name='179'></font>
<font color=#447700>!                ROBINSON AND KUKLA, 1985, J. CLIM. &amp; APPL. METEOR.)<a name='180'></font>
<font color=#447700>!   TBOT       BOTTOM SOIL TEMPERATURE (LOCAL YEARLY-MEAN SFC AIR<a name='181'></font>
<font color=#447700>!                TEMPERATURE)<a name='182'></font>
<font color=#447700>!   Z0BRD      Background fixed roughness length (M)<a name='183'></font>
<font color=#447700>!   Z0         Time varying roughness length (M) as function of snow depth<a name='184'></font>
<font color=#447700>!<a name='185'></font>
<font color=#447700>!   EMBRD      Background surface emissivity (between 0 and 1)<a name='186'></font>
<font color=#447700>!   EMISSI     Surface emissivity (between 0 and 1)<a name='187'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='188'></font>
<font color=#447700>! 6. HISTORY (STATE) VARIABLES (H):<a name='189'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='190'></font>
<font color=#447700>!  CMC         CANOPY MOISTURE CONTENT (M)<a name='191'></font>
<font color=#447700>!  T1          GROUND/CANOPY/SNOWPACK) EFFECTIVE SKIN TEMPERATURE (K)<a name='192'></font>
<font color=#447700>!  STC(NSOIL)  SOIL TEMP (K)<a name='193'></font>
<font color=#447700>!  SMC(NSOIL)  TOTAL SOIL MOISTURE CONTENT (VOLUMETRIC FRACTION)<a name='194'></font>
<font color=#447700>!  SH2O(NSOIL) UNFROZEN SOIL MOISTURE CONTENT (VOLUMETRIC FRACTION)<a name='195'></font>
<font color=#447700>!                NOTE: FROZEN SOIL MOISTURE = SMC - SH2O<a name='196'></font>
<font color=#447700>!  SNOWH       ACTUAL SNOW DEPTH (M)<a name='197'></font>
<font color=#447700>!  SNEQV       LIQUID WATER-EQUIVALENT SNOW DEPTH (M)<a name='198'></font>
<font color=#447700>!                NOTE: SNOW DENSITY = SNEQV/SNOWH<a name='199'></font>
<font color=#447700>!  ALBEDO      SURFACE ALBEDO INCLUDING SNOW EFFECT (UNITLESS FRACTION)<a name='200'></font>
<font color=#447700>!                =SNOW-FREE ALBEDO (ALB) WHEN SNEQV=0, OR<a name='201'></font>
<font color=#447700>!                =FCT(MSNOALB,ALB,VEGTYP,SHDFAC,SHDMIN) WHEN SNEQV&gt;0<a name='202'></font>
<font color=#447700>!  CH          SURFACE EXCHANGE COEFFICIENT FOR HEAT AND MOISTURE<a name='203'></font>
<font color=#447700>!                (M S-1); NOTE: CH IS TECHNICALLY A CONDUCTANCE SINCE<a name='204'></font>
<font color=#447700>!                IT HAS BEEN MULTIPLIED BY WIND SPEED.<a name='205'></font>
<font color=#447700>!  CM          SURFACE EXCHANGE COEFFICIENT FOR MOMENTUM (M S-1); NOTE:<a name='206'></font>
<font color=#447700>!                CM IS TECHNICALLY A CONDUCTANCE SINCE IT HAS BEEN<a name='207'></font>
<font color=#447700>!                MULTIPLIED BY WIND SPEED.<a name='208'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='209'></font>
<font color=#447700>! 7. OUTPUT (O):<a name='210'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='211'></font>
<font color=#447700>! OUTPUT VARIABLES NECESSARY FOR A COUPLED NUMERICAL WEATHER PREDICTION<a name='212'></font>
<font color=#447700>! MODEL, E.G. NOAA/NWS/NCEP MESOSCALE ETA MODEL.  FOR THIS APPLICATION,<a name='213'></font>
<font color=#447700>! THE REMAINING OUTPUT/DIAGNOSTIC/PARAMETER BLOCKS BELOW ARE NOT<a name='214'></font>
<font color=#447700>! NECESSARY.  OTHER APPLICATIONS MAY REQUIRE DIFFERENT OUTPUT VARIABLES.<a name='215'></font>
<font color=#447700>!   ETA        ACTUAL LATENT HEAT FLUX (W m-2: NEGATIVE, IF UP FROM<a name='216'></font>
<font color=#447700>!              SURFACE)<a name='217'></font>
<font color=#447700>!  ETA_KINEMATIC atctual latent heat flux in Kg m-2 s-1<a name='218'></font>
<font color=#447700>!   SHEAT      SENSIBLE HEAT FLUX (W M-2: POSITIVE, IF UPWARD FROM<a name='219'></font>
<font color=#447700>!              SURFACE)<a name='220'></font>
<font color=#447700>!   FDOWN      Radiation forcing at the surface (W m-2) = SOLDN*(1-alb)+LWDN<a name='221'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='222'></font>
<font color=#447700>!   EC         CANOPY WATER EVAPORATION (W m-2)<a name='223'></font>
<font color=#447700>!   EDIR       DIRECT SOIL EVAPORATION (W m-2)<a name='224'></font>
<font color=#447700>!   ET(NSOIL)  PLANT TRANSPIRATION FROM A PARTICULAR ROOT (SOIL) LAYER<a name='225'></font>
<font color=#447700>!                 (W m-2)<a name='226'></font>
<font color=#447700>!   ETT        TOTAL PLANT TRANSPIRATION (W m-2)<a name='227'></font>
<font color=#447700>!   ESNOW      SUBLIMATION FROM (OR DEPOSITION TO IF &lt;0) SNOWPACK<a name='228'></font>
<font color=#447700>!                (W m-2)<a name='229'></font>
<font color=#447700>!   DRIP       THROUGH-FALL OF PRECIP AND/OR DEW IN EXCESS OF CANOPY<a name='230'></font>
<font color=#447700>!                WATER-HOLDING CAPACITY (M)<a name='231'></font>
<font color=#447700>!   DEW        DEWFALL (OR FROSTFALL FOR T&lt;273.15) (M)<a name='232'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='233'></font>
<font color=#447700>!   BETA       RATIO OF ACTUAL/POTENTIAL EVAP (DIMENSIONLESS)<a name='234'></font>
<font color=#447700>!   ETP        POTENTIAL EVAPORATION (W m-2)<a name='235'></font>
<font color=#447700>!   SSOIL      SOIL HEAT FLUX (W M-2: NEGATIVE IF DOWNWARD FROM SURFACE)<a name='236'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='237'></font>
<font color=#447700>!   FLX1       PRECIP-SNOW SFC (W M-2)<a name='238'></font>
<font color=#447700>!   FLX2       FREEZING RAIN LATENT HEAT FLUX (W M-2)<a name='239'></font>
<font color=#447700>!   FLX3       PHASE-CHANGE HEAT FLUX FROM SNOWMELT (W M-2)<a name='240'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='241'></font>
<font color=#447700>!   SNOMLT     SNOW MELT (M) (WATER EQUIVALENT)<a name='242'></font>
<font color=#447700>!   SNCOVR     FRACTIONAL SNOW COVER (UNITLESS FRACTION, 0-1)<a name='243'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='244'></font>
<font color=#447700>!   RUNOFF1    SURFACE RUNOFF (M S-1), NOT INFILTRATING THE SURFACE<a name='245'></font>
<font color=#447700>!   RUNOFF2    SUBSURFACE RUNOFF (M S-1), DRAINAGE OUT BOTTOM OF LAST<a name='246'></font>
<font color=#447700>!                SOIL LAYER (BASEFLOW)<a name='247'></font>
<font color=#447700>!   RUNOFF3    NUMERICAL TRUNCTATION IN EXCESS OF POROSITY (SMCMAX)<a name='248'></font>
<font color=#447700>!                FOR A GIVEN SOIL LAYER AT THE END OF A TIME STEP (M S-1).<a name='249'></font>
<font color=#447700>! Note: the above RUNOFF2 is actually the sum of RUNOFF2 and RUNOFF3<a name='250'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='251'></font>
<font color=#447700>!   RC         CANOPY RESISTANCE (S M-1)<a name='252'></font>
<font color=#447700>!   PC         PLANT COEFFICIENT (UNITLESS FRACTION, 0-1) WHERE PC*ETP<a name='253'></font>
<font color=#447700>!                = ACTUAL TRANSP<a name='254'></font>
<font color=#447700>!   XLAI       LEAF AREA INDEX (DIMENSIONLESS)<a name='255'></font>
<font color=#447700>!   RSMIN      MINIMUM CANOPY RESISTANCE (S M-1)<a name='256'></font>
<font color=#447700>!   RCS        INCOMING SOLAR RC FACTOR (DIMENSIONLESS)<a name='257'></font>
<font color=#447700>!   RCT        AIR TEMPERATURE RC FACTOR (DIMENSIONLESS)<a name='258'></font>
<font color=#447700>!   RCQ        ATMOS VAPOR PRESSURE DEFICIT RC FACTOR (DIMENSIONLESS)<a name='259'></font>
<font color=#447700>!   RCSOIL     SOIL MOISTURE RC FACTOR (DIMENSIONLESS)<a name='260'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='261'></font>
<font color=#447700>! 8. DIAGNOSTIC OUTPUT (D):<a name='262'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='263'></font>
<font color=#447700>!   SOILW      AVAILABLE SOIL MOISTURE IN ROOT ZONE (UNITLESS FRACTION<a name='264'></font>
<font color=#447700>!              BETWEEN SMCWLT AND SMCMAX)<a name='265'></font>
<font color=#447700>!   SOILM      TOTAL SOIL COLUMN MOISTURE CONTENT (FROZEN+UNFROZEN) (M)<a name='266'></font>
<font color=#447700>!   Q1         Effective mixing ratio at surface (kg kg-1), used for<a name='267'></font>
<font color=#447700>!              diagnosing the mixing ratio at 2 meter for coupled model<a name='268'></font>
<font color=#447700>!   SMAV       Soil Moisture Availability for each layer, as a fraction<a name='269'></font>
<font color=#447700>!              between SMCWLT and SMCMAX.<a name='270'></font>
<font color=#447700>!  Documentation for SNOTIME1 and SNOABL2 ?????<a name='271'></font>
<font color=#447700>!  What categories of arguments do these variables fall into ????<a name='272'></font>
<font color=#447700>!  Documentation for RIBB ?????<a name='273'></font>
<font color=#447700>!  What category of argument does RIBB fall into ?????<a name='274'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='275'></font>
<font color=#447700>! 9. PARAMETERS (P):<a name='276'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='277'></font>
<font color=#447700>!   SMCWLT     WILTING POINT (VOLUMETRIC)<a name='278'></font>
<font color=#447700>!   SMCDRY     DRY SOIL MOISTURE THRESHOLD WHERE DIRECT EVAP FRM TOP<a name='279'></font>
<font color=#447700>!                LAYER ENDS (VOLUMETRIC)<a name='280'></font>
<font color=#447700>!   SMCREF     SOIL MOISTURE THRESHOLD WHERE TRANSPIRATION BEGINS TO<a name='281'></font>
<font color=#447700>!                STRESS (VOLUMETRIC)<a name='282'></font>
<font color=#447700>!   SMCMAX     POROSITY, I.E. SATURATED VALUE OF SOIL MOISTURE<a name='283'></font>
<font color=#447700>!                (VOLUMETRIC)<a name='284'></font>
<font color=#447700>!   NROOT      NUMBER OF ROOT LAYERS, A FUNCTION OF VEG TYPE, DETERMINED<a name='285'></font>
<font color=#447700>!              IN SUBROUTINE REDPRM.<a name='286'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='287'></font>
<a name='288'>
<a name='289'>
      IMPLICIT NONE<a name='290'>
<font color=#447700>! ----------------------------------------------------------------------<a name='291'></font>
<a name='292'>
<font color=#447700>! DECLARATIONS - LOGICAL AND CHARACTERS<a name='293'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='294'></font>
<a name='295'>
      INTEGER, INTENT(IN) :: IILOC, JJLOC<a name='296'>
      LOGICAL, INTENT(IN)::  LOCAL<a name='297'>
      LOGICAL            ::  FRZGRA, SNOWNG<a name='298'>
      CHARACTER (LEN=256), INTENT(IN)::  LLANDUSE, LSOIL<a name='299'>
<a name='300'>
<font color=#447700>! ----------------------------------------------------------------------<a name='301'></font>
<font color=#447700>! 1. CONFIGURATION INFORMATION (C):<a name='302'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='303'></font>
      INTEGER,INTENT(IN) ::  NSOIL,SLOPETYP,SOILTYP,VEGTYP<a name='304'>
      INTEGER, INTENT(IN) :: ISURBAN<a name='305'>
      INTEGER,INTENT(OUT)::  NROOT<a name='306'>
      INTEGER  KZ, K, iout<a name='307'>
<a name='308'>
<font color=#447700>! ----------------------------------------------------------------------<a name='309'></font>
<font color=#447700>! 2. LOGICAL:<a name='310'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='311'></font>
      LOGICAL, INTENT(IN) :: RDLAI2D<a name='312'>
      LOGICAL, INTENT(IN) :: USEMONALB<a name='313'>
      INTEGER, INTENT(IN) :: OPT_THCND<a name='314'>
<a name='315'>
      REAL, INTENT(INOUT):: SFHEAD1RT,INFXS1RT, ETPND1<a name='316'>
<a name='317'>
      REAL, INTENT(IN)   :: SHDMIN,SHDMAX,DT,DQSDT2,LWDN,PRCP,PRCPRAIN,     &amp;<a name='318'>
                            Q2,Q2SAT,SFCPRS,SFCSPD,SFCTMP, SNOALB,          &amp;<a name='319'>
                            SOLDN,SOLNET,TBOT,TH2,ZLVL,                            &amp;<a name='320'>
                            FFROZP,AOASIS<a name='321'>
      REAL, INTENT(OUT)  :: EMBRD<a name='322'>
      REAL, INTENT(OUT)  :: ALBEDO<a name='323'>
      REAL, INTENT(INOUT):: COSZ, SOLARDIRECT,CH,CM,                        &amp;<a name='324'>
                            CMC,SNEQV,SNCOVR,SNOWH,T1,XLAI,SHDFAC,Z0BRD,    &amp;<a name='325'>
                            EMISSI, ALB<a name='326'>
      REAL, INTENT(INOUT):: SNOTIME1<a name='327'>
      REAL, INTENT(INOUT):: RIBB<a name='328'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN) :: SLDPTH<a name='329'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT):: ET<a name='330'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT):: SMAV<a name='331'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT) ::  SH2O, SMC, STC<a name='332'>
      REAL,DIMENSION(1:NSOIL)::   RTDIS, ZSOIL<a name='333'>
<a name='334'>
      REAL,INTENT(OUT)   :: ETA_KINEMATIC,BETA,DEW,DRIP,EC,EDIR,ESNOW,ETA,  &amp;<a name='335'>
                            ETP,FLX1,FLX2,FLX3,SHEAT,PC,RUNOFF1,RUNOFF2,    &amp;<a name='336'>
                            RUNOFF3,RC,RSMIN,RCQ,RCS,RCSOIL,RCT,SSOIL,      &amp;<a name='337'>
                            SMCDRY,SMCMAX,SMCREF,SMCWLT,SNOMLT, SOILM,      &amp;<a name='338'>
                            SOILW,FDOWN,Q1<a name='339'>
      LOGICAL, INTENT(IN) :: UA_PHYS   <font color=#447700>! UA: flag for UA option<a name='340'></font>
      REAL,INTENT(OUT)    :: FLX4      <font color=#447700>! UA: energy added to sensible heat<a name='341'></font>
      REAL,INTENT(OUT)    :: FVB       <font color=#447700>! UA: frac. veg. w/snow beneath<a name='342'></font>
      REAL,INTENT(OUT)    :: FBUR      <font color=#447700>! UA: fraction of canopy buried<a name='343'></font>
      REAL,INTENT(OUT)    :: FGSN      <font color=#447700>! UA: ground snow cover fraction<a name='344'></font>
      REAL                :: ZTOPV     <font color=#447700>! UA: height of canopy top<a name='345'></font>
      REAL                :: ZBOTV     <font color=#447700>! UA: height of canopy bottom<a name='346'></font>
      REAL                :: GAMA      <font color=#447700>! UA: = EXP(-1.* XLAI)<a name='347'></font>
      REAL                :: FNET      <font color=#447700>! UA:<a name='348'></font>
      REAL                :: ETPN      <font color=#447700>! UA:<a name='349'></font>
      REAL                :: RU        <font color=#447700>! UA:<a name='350'></font>
<a name='351'>
      REAL :: BEXP,CFACTR,CMCMAX,CSOIL,CZIL,DF1,DF1H,DF1A,DKSAT,DWSAT,      &amp;<a name='352'>
              DSOIL,DTOT,ETT,FRCSNO,FRCSOI,EPSCA,F1,FXEXP,FRZX,HS,          &amp;<a name='353'>
              KDT,LVH2O,PRCP1,PSISAT,QUARTZ,R,RCH,REFKDT,RR,RGL,            &amp;<a name='354'>
              RSMAX,                                                        &amp;<a name='355'>
              RSNOW,SNDENS,SNCOND,SBETA,SN_NEW,SLOPE,SNUP,SALP,SOILWM,      &amp;<a name='356'>
              SOILWW,T1V,T24,T2V,TH2V,TOPT,TFREEZ,TSNOW,ZBOT,Z0,PRCPF,      &amp;<a name='357'>
              ETNS,PTU,LSUBS<a name='358'>
        REAL ::  LVCOEF<a name='359'>
      REAL :: INTERP_FRACTION<a name='360'>
      REAL :: LAIMIN,    LAIMAX<a name='361'>
      REAL :: ALBEDOMIN, ALBEDOMAX<a name='362'>
      REAL :: EMISSMIN,  EMISSMAX<a name='363'>
      REAL :: Z0MIN,     Z0MAX<a name='364'>
<a name='365'>
<font color=#447700>! ----------------------------------------------------------------------<a name='366'></font>
<font color=#447700>! DECLARATIONS - PARAMETERS<a name='367'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='368'></font>
      PARAMETER (TFREEZ = 273.15)<a name='369'>
      PARAMETER (LVH2O = 2.501E+6)<a name='370'>
      PARAMETER (LSUBS = 2.83E+6)<a name='371'>
      PARAMETER (R = 287.04)<a name='372'>
<font color=#447700>!<a name='373'></font>
<font color=#447700>!  FASDAS<a name='374'></font>
<font color=#447700>!<a name='375'></font>
   INTEGER, INTENT(IN   )  ::  fasdas<a name='376'>
   REAL,    INTENT(INOUT)  ::  XSDA_QFX, XQNORM<a name='377'>
   REAL,    INTENT(INOUT)  ::  HFX_PHY, QFX_PHY<a name='378'>
   REAL,    INTENT(  OUT)  ::  HCPCT_FASDAS<a name='379'>
<font color=#447700>!<a name='380'></font>
<font color=#447700>!  END FASDAS<a name='381'></font>
<font color=#447700>!<a name='382'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='383'></font>
<font color=#447700>!   INITIALIZATION<a name='384'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='385'></font>
      ILOC = IILOC<a name='386'>
      JLOC = JJLOC<a name='387'>
<a name='388'>
      RUNOFF1 = 0.0<a name='389'>
      RUNOFF2 = 0.0<a name='390'>
      RUNOFF3 = 0.0<a name='391'>
      SNOMLT = 0.0<a name='392'>
<a name='393'>
      IF ( .NOT. UA_PHYS ) THEN<a name='394'>
          FLX4 = 0.0<a name='395'>
          FVB  = 0.0<a name='396'>
          FBUR = 0.0<a name='397'>
          FGSN = 0.0<a name='398'>
      ENDIF<a name='399'>
<a name='400'>
<font color=#447700>! ----------------------------------------------------------------------<a name='401'></font>
<font color=#447700>! CALCULATE DEPTH (NEGATIVE) BELOW GROUND FROM TOP SKIN SFC TO BOTTOM OF<a name='402'></font>
<font color=#447700>!   EACH SOIL LAYER.  NOTE:  SIGN OF ZSOIL IS NEGATIVE (DENOTING BELOW<a name='403'></font>
<font color=#447700>!   GROUND)<a name='404'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='405'></font>
      ZSOIL (1) = - SLDPTH (1)<a name='406'>
      DO KZ = 2,NSOIL<a name='407'>
         ZSOIL (KZ) = - SLDPTH (KZ) + ZSOIL (KZ -1)<a name='408'>
      END DO<a name='409'>
<a name='410'>
<font color=#447700>! ----------------------------------------------------------------------<a name='411'></font>
<font color=#447700>! NEXT IS CRUCIAL CALL TO SET THE LAND-SURFACE PARAMETERS, INCLUDING<a name='412'></font>
<font color=#447700>! SOIL-TYPE AND VEG-TYPE DEPENDENT PARAMETERS.<a name='413'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='414'></font>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM'>REDPRM</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REDPRM_1"> (VEGTYP,SOILTYP,SLOPETYP,CFACTR,CMCMAX,RSMAX,TOPT,   &amp;<a name='415'>
                       REFKDT,KDT,SBETA, SHDFAC,RSMIN,RGL,HS,ZBOT,FRZX,    &amp;<a name='416'>
                         PSISAT,SLOPE,SNUP,SALP,BEXP,DKSAT,DWSAT,          &amp;<a name='417'>
                         SMCMAX,SMCWLT,SMCREF,SMCDRY,F1,QUARTZ,FXEXP,      &amp;<a name='418'>
                         RTDIS,SLDPTH,ZSOIL,NROOT,NSOIL,CZIL,              &amp;<a name='419'>
                         LAIMIN, LAIMAX, EMISSMIN, EMISSMAX, ALBEDOMIN,    &amp;<a name='420'>
                         ALBEDOMAX, Z0MIN, Z0MAX, CSOIL, PTU, LLANDUSE,    &amp;<a name='421'>
                         LSOIL,LOCAL,LVCOEF,ZTOPV,ZBOTV)<a name='422'>
<a name='423'>
<font color=#447700>!urban<a name='424'></font>
         IF(VEGTYP==ISURBAN)THEN<a name='425'>
              SHDFAC=0.05<a name='426'>
              RSMIN=400.0<a name='427'>
              SMCMAX = 0.45<a name='428'>
              SMCREF = 0.42<a name='429'>
              SMCWLT = 0.40<a name='430'>
              SMCDRY = 0.40<a name='431'>
         ENDIF<a name='432'>
<a name='433'>
         IF ( SHDFAC &gt;= SHDMAX ) THEN<a name='434'>
            EMBRD = EMISSMAX<a name='435'>
            IF (.NOT. RDLAI2D) THEN<a name='436'>
               XLAI  = LAIMAX<a name='437'>
            ENDIF<a name='438'>
            IF (.NOT. USEMONALB) THEN<a name='439'>
               ALB   = ALBEDOMIN<a name='440'>
            ENDIF<a name='441'>
            Z0BRD = Z0MAX<a name='442'>
         ELSE IF ( SHDFAC &lt;= SHDMIN ) THEN<a name='443'>
            EMBRD = EMISSMIN<a name='444'>
            IF(.NOT. RDLAI2D) THEN<a name='445'>
               XLAI  = LAIMIN<a name='446'>
            ENDIF<a name='447'>
            IF(.NOT. USEMONALB) then<a name='448'>
               ALB   = ALBEDOMAX<a name='449'>
            ENDIF<a name='450'>
            Z0BRD = Z0MIN<a name='451'>
         ELSE<a name='452'>
<a name='453'>
            IF ( SHDMAX &gt; SHDMIN ) THEN<a name='454'>
<a name='455'>
               INTERP_FRACTION = ( SHDFAC - SHDMIN ) / ( SHDMAX - SHDMIN )<a name='456'>
               <font color=#447700>! Bound INTERP_FRACTION between 0 and 1<a name='457'></font>
               INTERP_FRACTION = MIN ( INTERP_FRACTION, 1.0 )<a name='458'>
               INTERP_FRACTION = MAX ( INTERP_FRACTION, 0.0 )<a name='459'>
               <font color=#447700>! Scale Emissivity and LAI between EMISSMIN and EMISSMAX by INTERP_FRACTION<a name='460'></font>
               EMBRD = ( ( 1.0 - INTERP_FRACTION ) * EMISSMIN  ) + ( INTERP_FRACTION * EMISSMAX  )<a name='461'>
               IF (.NOT. RDLAI2D) THEN<a name='462'>
                  XLAI  = ( ( 1.0 - INTERP_FRACTION ) * LAIMIN    ) + ( INTERP_FRACTION * LAIMAX    )<a name='463'>
               ENDIF<a name='464'>
               if (.not. USEMONALB) then<a name='465'>
                  ALB   = ( ( 1.0 - INTERP_FRACTION ) * ALBEDOMAX ) + ( INTERP_FRACTION * ALBEDOMIN )<a name='466'>
               endif<a name='467'>
               Z0BRD = ( ( 1.0 - INTERP_FRACTION ) * Z0MIN     ) + ( INTERP_FRACTION * Z0MAX     )<a name='468'>
<a name='469'>
            ELSE<a name='470'>
<a name='471'>
               EMBRD = 0.5 * EMISSMIN  + 0.5 * EMISSMAX<a name='472'>
               IF (.NOT. RDLAI2D) THEN<a name='473'>
                  XLAI  = 0.5 * LAIMIN    + 0.5 * LAIMAX<a name='474'>
               ENDIF<a name='475'>
               if (.not. USEMONALB) then<a name='476'>
                  ALB   = 0.5 * ALBEDOMIN + 0.5 * ALBEDOMAX<a name='477'>
               endif<a name='478'>
               Z0BRD = 0.5 * Z0MIN     + 0.5 * Z0MAX<a name='479'>
<a name='480'>
            ENDIF<a name='481'>
<a name='482'>
         ENDIF<a name='483'>
<font color=#447700>! ----------------------------------------------------------------------<a name='484'></font>
<font color=#447700>!  INITIALIZE PRECIPITATION LOGICALS.<a name='485'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='486'></font>
         SNOWNG = .FALSE.<a name='487'>
         FRZGRA = .FALSE.<a name='488'>
<a name='489'>
<font color=#447700>! ----------------------------------------------------------------------<a name='490'></font>
<font color=#447700>! IF INPUT SNOWPACK IS NONZERO, THEN COMPUTE SNOW DENSITY "SNDENS" AND<a name='491'></font>
<font color=#447700>!   SNOW THERMAL CONDUCTIVITY "SNCOND" (NOTE THAT CSNOW IS A FUNCTION<a name='492'></font>
<font color=#447700>!   SUBROUTINE)<a name='493'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='494'></font>
         IF ( SNEQV &lt;= 1.E-7 ) THEN <font color=#447700>! safer IF	kmh (2008/03/25)<a name='495'></font>
            SNEQV = 0.0<a name='496'>
            SNDENS = 0.0<a name='497'>
            SNOWH = 0.0<a name='498'>
            SNCOND = 1.0<a name='499'>
         ELSE<a name='500'>
            SNDENS = SNEQV / SNOWH<a name='501'>
            IF(SNDENS &gt; 1.0) THEN<a name='502'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1171"> ( 'Physical snow depth is less than snow water equiv.' )<a name='503'>
            ENDIF<a name='504'>
            CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CSNOW'>CSNOW</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CSNOW_3"> (SNCOND,SNDENS)<a name='505'>
         END IF<a name='506'>
<font color=#447700>! ----------------------------------------------------------------------<a name='507'></font>
<font color=#447700>! DETERMINE IF IT'S PRECIPITATING AND WHAT KIND OF PRECIP IT IS.<a name='508'></font>
<font color=#447700>! IF IT'S PRCPING AND THE AIR TEMP IS COLDER THAN 0 C, IT'S SNOWING!<a name='509'></font>
<font color=#447700>! IF IT'S PRCPING AND THE AIR TEMP IS WARMER THAN 0 C, BUT THE GRND<a name='510'></font>
<font color=#447700>! TEMP IS COLDER THAN 0 C, FREEZING RAIN IS PRESUMED TO BE FALLING.<a name='511'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='512'></font>
         IF (PRCP &gt; 0.0) THEN<a name='513'>
<font color=#447700>! snow defined when fraction of frozen precip (FFROZP) &gt; 0.5,<a name='514'></font>
<font color=#447700>! passed in from model microphysics.<a name='515'></font>
            IF (FFROZP .GT. 0.5) THEN<a name='516'>
               SNOWNG = .TRUE.<a name='517'>
            ELSE<a name='518'>
               IF (T1 &lt;= TFREEZ) FRZGRA = .TRUE.<a name='519'>
            END IF<a name='520'>
         END IF<a name='521'>
<font color=#447700>! ----------------------------------------------------------------------<a name='522'></font>
<font color=#447700>! IF EITHER PRCP FLAG IS SET, DETERMINE NEW SNOWFALL (CONVERTING PRCP<a name='523'></font>
<font color=#447700>! RATE FROM KG M-2 S-1 TO A LIQUID EQUIV SNOW DEPTH IN METERS) AND ADD<a name='524'></font>
<font color=#447700>! IT TO THE EXISTING SNOWPACK.<a name='525'></font>
<font color=#447700>! NOTE THAT SINCE ALL PRECIP IS ADDED TO SNOWPACK, NO PRECIP INFILTRATES<a name='526'></font>
<font color=#447700>! INTO THE SOIL SO THAT PRCP1 IS SET TO ZERO.<a name='527'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='528'></font>
         IF ( (SNOWNG) .OR. (FRZGRA) ) THEN<a name='529'>
            SN_NEW = PRCP * DT * 0.001<a name='530'>
            SNEQV = SNEQV + SN_NEW<a name='531'>
            PRCPF = 0.0<a name='532'>
<a name='533'>
<font color=#447700>! ----------------------------------------------------------------------<a name='534'></font>
<font color=#447700>! UPDATE SNOW DENSITY BASED ON NEW SNOWFALL, USING OLD AND NEW SNOW.<a name='535'></font>
<font color=#447700>! UPDATE SNOW THERMAL CONDUCTIVITY<a name='536'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='537'></font>
            CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOW_NEW'>SNOW_NEW</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOW_NEW_2"> (SFCTMP,SN_NEW,SNOWH,SNDENS)<a name='538'>
            CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CSNOW'>CSNOW</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CSNOW_4"> (SNCOND,SNDENS)<a name='539'>
<a name='540'>
<font color=#447700>! ----------------------------------------------------------------------<a name='541'></font>
<font color=#447700>! PRECIP IS LIQUID (RAIN), HENCE SAVE IN THE PRECIP VARIABLE THAT<a name='542'></font>
<font color=#447700>! LATER CAN WHOLELY OR PARTIALLY INFILTRATE THE SOIL (ALONG WITH<a name='543'></font>
<font color=#447700>! ANY CANOPY "DRIP" ADDED TO THIS LATER)<a name='544'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='545'></font>
         ELSE<a name='546'>
            PRCPF = PRCP<a name='547'>
         ENDIF<a name='548'>
<font color=#447700>! ----------------------------------------------------------------------<a name='549'></font>
<font color=#447700>! DETERMINE SNOWCOVER AND ALBEDO OVER LAND.<a name='550'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='551'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='552'></font>
<font color=#447700>! IF SNOW DEPTH=0, SET SNOW FRACTION=0, ALBEDO=SNOW FREE ALBEDO.<a name='553'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='554'></font>
         IF (SNEQV  == 0.0) THEN<a name='555'>
            SNCOVR = 0.0<a name='556'>
            ALBEDO = ALB<a name='557'>
            EMISSI = EMBRD<a name='558'>
	    IF(UA_PHYS) FGSN = 0.0<a name='559'>
	    IF(UA_PHYS) FVB = 0.0<a name='560'>
	    IF(UA_PHYS) FBUR = 0.0<a name='561'>
         ELSE<a name='562'>
<font color=#447700>! ----------------------------------------------------------------------<a name='563'></font>
<font color=#447700>! DETERMINE SNOW FRACTIONAL COVERAGE.<a name='564'></font>
<font color=#447700>! DETERMINE SURFACE ALBEDO MODIFICATION DUE TO SNOWDEPTH STATE.<a name='565'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='566'></font>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SNFRAC'>SNFRAC</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNFRAC_1"> (SNEQV,SNUP,SALP,SNOWH,SNCOVR, &amp;<a name='567'>
                         XLAI,SHDFAC,FVB,GAMA,FBUR,    &amp;<a name='568'>
                         FGSN,ZTOPV,ZBOTV,UA_PHYS)<a name='569'>
<a name='570'>
            IF ( UA_PHYS ) then<a name='571'>
              IF(SFCTMP &lt;= T1) THEN<a name='572'>
                RU = 0.<a name='573'>
              ELSE<a name='574'>
                RU = 100.*SHDFAC*FGSN*MIN((SFCTMP-T1)/5., 1.)*(1.-EXP(-XLAI))<a name='575'>
              ENDIF<a name='576'>
              CH = CH/(1.+RU*CH)<a name='577'>
            ENDIF<a name='578'>
<a name='579'>
            SNCOVR = MIN(SNCOVR,0.98) <a name='580'>
<a name='581'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#ALCALC'>ALCALC</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALCALC_1"> (ALB,SNOALB,EMBRD,SHDFAC,SHDMIN,SNCOVR,T1, &amp;<a name='582'>
                 ALBEDO,EMISSI,DT,SNOWNG,SNOTIME1,LVCOEF)<a name='583'>
         ENDIF<a name='584'>
<font color=#447700>! ----------------------------------------------------------------------<a name='585'></font>
<font color=#447700>! NEXT CALCULATE THE SUBSURFACE HEAT FLUX, WHICH FIRST REQUIRES<a name='586'></font>
<font color=#447700>! CALCULATION OF THE THERMAL DIFFUSIVITY.  TREATMENT OF THE<a name='587'></font>
<font color=#447700>! LATTER FOLLOWS THAT ON PAGES 148-149 FROM "HEAT TRANSFER IN<a name='588'></font>
<font color=#447700>! COLD CLIMATES", BY V. J. LUNARDINI (PUBLISHED IN 1981<a name='589'></font>
<font color=#447700>! BY VAN NOSTRAND REINHOLD CO.) I.E. TREATMENT OF TWO CONTIGUOUS<a name='590'></font>
<font color=#447700>! "PLANE PARALLEL" MEDIUMS (NAMELY HERE THE FIRST SOIL LAYER<a name='591'></font>
<font color=#447700>! AND THE SNOWPACK LAYER, IF ANY). THIS DIFFUSIVITY TREATMENT<a name='592'></font>
<font color=#447700>! BEHAVES WELL FOR BOTH ZERO AND NONZERO SNOWPACK, INCLUDING THE<a name='593'></font>
<font color=#447700>! LIMIT OF VERY THIN SNOWPACK.  THIS TREATMENT ALSO ELIMINATES<a name='594'></font>
<font color=#447700>! THE NEED TO IMPOSE AN ARBITRARY UPPER BOUND ON SUBSURFACE<a name='595'></font>
<font color=#447700>! HEAT FLUX WHEN THE SNOWPACK BECOMES EXTREMELY THIN.<a name='596'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='597'></font>
<font color=#447700>! FIRST CALCULATE THERMAL DIFFUSIVITY OF TOP SOIL LAYER, USING<a name='598'></font>
<font color=#447700>! BOTH THE FROZEN AND LIQUID SOIL MOISTURE, FOLLOWING THE<a name='599'></font>
<font color=#447700>! SOIL THERMAL DIFFUSIVITY FUNCTION OF PETERS-LIDARD ET AL.<a name='600'></font>
<font color=#447700>! (1998,JAS, VOL 55, 1209-1224), WHICH REQUIRES THE SPECIFYING<a name='601'></font>
<font color=#447700>! THE QUARTZ CONTENT OF THE GIVEN SOIL CLASS (SEE ROUTINE REDPRM)<a name='602'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='603'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='604'></font>
<font color=#447700>! NEXT ADD SUBSURFACE HEAT FLUX REDUCTION EFFECT FROM THE<a name='605'></font>
<font color=#447700>! OVERLYING GREEN CANOPY, ADAPTED FROM SECTION 2.1.2 OF<a name='606'></font>
<font color=#447700>! PETERS-LIDARD ET AL. (1997, JGR, VOL 102(D4))<a name='607'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='608'></font>
            CALL <A href='../../html_code/phys/module_sf_urban.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_1"> (DF1,SMC (1),QUARTZ,SMCMAX,SH2O (1),BEXP, PSISAT, SOILTYP, OPT_THCND)<a name='609'>
<a name='610'>
<font color=#447700>!urban<a name='611'></font>
            IF ( VEGTYP == ISURBAN ) DF1=3.24<a name='612'>
<a name='613'>
            DF1 = DF1 * EXP (SBETA * SHDFAC)<a name='614'>
<font color=#447700>!<a name='615'></font>
<font color=#447700>! kmh 09/03/2006<a name='616'></font>
<font color=#447700>! kmh 03/25/2008  change SNCOVR threshold to 0.97<a name='617'></font>
<font color=#447700>!<a name='618'></font>
            IF (  SNCOVR .GT. 0.97 ) THEN<a name='619'>
               DF1 = SNCOND<a name='620'>
            ENDIF<a name='621'>
<font color=#447700>!<a name='622'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='623'></font>
<font color=#447700>! FINALLY "PLANE PARALLEL" SNOWPACK EFFECT FOLLOWING<a name='624'></font>
<font color=#447700>! V.J. LINARDINI REFERENCE CITED ABOVE. NOTE THAT DTOT IS<a name='625'></font>
<font color=#447700>! COMBINED DEPTH OF SNOWDEPTH AND THICKNESS OF FIRST SOIL LAYER<a name='626'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='627'></font>
<a name='628'>
         DSOIL = - (0.5 * ZSOIL (1))<a name='629'>
         IF (SNEQV == 0.) THEN<a name='630'>
            SSOIL = DF1 * (T1- STC (1) ) / DSOIL<a name='631'>
         ELSE<a name='632'>
            DTOT = SNOWH + DSOIL<a name='633'>
            FRCSNO = SNOWH / DTOT<a name='634'>
<a name='635'>
<font color=#447700>! 1. HARMONIC MEAN (SERIES FLOW)<a name='636'></font>
<font color=#447700>!        DF1 = (SNCOND*DF1)/(FRCSOI*SNCOND+FRCSNO*DF1)<a name='637'></font>
            FRCSOI = DSOIL / DTOT<a name='638'>
<font color=#447700>! 2. ARITHMETIC MEAN (PARALLEL FLOW)<a name='639'></font>
<font color=#447700>!        DF1 = FRCSNO*SNCOND + FRCSOI*DF1<a name='640'></font>
            DF1H = (SNCOND * DF1)/ (FRCSOI * SNCOND+ FRCSNO * DF1)<a name='641'>
<a name='642'>
<font color=#447700>! 3. GEOMETRIC MEAN (INTERMEDIATE BETWEEN HARMONIC AND ARITHMETIC MEAN)<a name='643'></font>
<font color=#447700>!        DF1 = (SNCOND**FRCSNO)*(DF1**FRCSOI)<a name='644'></font>
<font color=#447700>! weigh DF by snow fraction<a name='645'></font>
<font color=#447700>!        DF1 = DF1H*SNCOVR + DF1A*(1.0-SNCOVR)<a name='646'></font>
<font color=#447700>!        DF1 = DF1H*SNCOVR + DF1*(1.0-SNCOVR)<a name='647'></font>
            DF1A = FRCSNO * SNCOND+ FRCSOI * DF1<a name='648'>
<a name='649'>
<font color=#447700>! ----------------------------------------------------------------------<a name='650'></font>
<font color=#447700>! CALCULATE SUBSURFACE HEAT FLUX, SSOIL, FROM FINAL THERMAL DIFFUSIVITY<a name='651'></font>
<font color=#447700>! OF SURFACE MEDIUMS, DF1 ABOVE, AND SKIN TEMPERATURE AND TOP<a name='652'></font>
<font color=#447700>! MID-LAYER SOIL TEMPERATURE<a name='653'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='654'></font>
            DF1 = DF1A * SNCOVR + DF1* (1.0- SNCOVR)<a name='655'>
            SSOIL = DF1 * (T1- STC (1) ) / DTOT<a name='656'>
         END IF<a name='657'>
<font color=#447700>! ----------------------------------------------------------------------<a name='658'></font>
<font color=#447700>! DETERMINE SURFACE ROUGHNESS OVER SNOWPACK USING SNOW CONDITION FROM<a name='659'></font>
<font color=#447700>! THE PREVIOUS TIMESTEP.<a name='660'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='661'></font>
         IF (SNCOVR  &gt; 0. ) THEN<a name='662'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOWZ0'>SNOWZ0</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWZ0_2"> (SNCOVR,Z0,Z0BRD,SNOWH,FBUR,FGSN,SHDMAX,UA_PHYS)<a name='663'>
         ELSE<a name='664'>
            Z0=Z0BRD<a name='665'>
            IF(UA_PHYS) CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOWZ0'>SNOWZ0</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWZ0_3"> (SNCOVR,Z0,Z0BRD,SNOWH,FBUR,FGSN, &amp;<a name='666'>
	                             SHDMAX,UA_PHYS)<a name='667'>
         END IF<a name='668'>
<font color=#447700>! ----------------------------------------------------------------------<a name='669'></font>
<font color=#447700>! NEXT CALL ROUTINE SFCDIF TO CALCULATE THE SFC EXCHANGE COEF (CH) FOR<a name='670'></font>
<font color=#447700>! HEAT AND MOISTURE.<a name='671'></font>
<a name='672'>
<font color=#447700>! NOTE !!!<a name='673'></font>
<font color=#447700>! DO NOT CALL SFCDIF UNTIL AFTER ABOVE CALL TO REDPRM, IN CASE<a name='674'></font>
<font color=#447700>! ALTERNATIVE VALUES OF ROUGHNESS LENGTH (Z0) AND ZILINTINKEVICH COEF<a name='675'></font>
<font color=#447700>! (CZIL) ARE SET THERE VIA NAMELIST I/O.<a name='676'></font>
<a name='677'>
<font color=#447700>! NOTE !!!<a name='678'></font>
<font color=#447700>! ROUTINE SFCDIF RETURNS A CH THAT REPRESENTS THE WIND SPD TIMES THE<a name='679'></font>
<font color=#447700>! "ORIGINAL" NONDIMENSIONAL "Ch" TYPICAL IN LITERATURE.  HENCE THE CH<a name='680'></font>
<font color=#447700>! RETURNED FROM SFCDIF HAS UNITS OF M/S.  THE IMPORTANT COMPANION<a name='681'></font>
<font color=#447700>! COEFFICIENT OF CH, CARRIED HERE AS "RCH", IS THE CH FROM SFCDIF TIMES<a name='682'></font>
<font color=#447700>! AIR DENSITY AND PARAMETER "CP".  "RCH" IS COMPUTED IN "CALL PENMAN".<a name='683'></font>
<font color=#447700>! RCH RATHER THAN CH IS THE COEFF USUALLY INVOKED LATER IN EQNS.<a name='684'></font>
<a name='685'>
<font color=#447700>! NOTE !!!<a name='686'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='687'></font>
<font color=#447700>! SFCDIF ALSO RETURNS THE SURFACE EXCHANGE COEFFICIENT FOR MOMENTUM, CM,<a name='688'></font>
<font color=#447700>! ALSO KNOWN AS THE SURFACE DRAGE COEFFICIENT. Needed as a state variable<a name='689'></font>
<font color=#447700>! for iterative/implicit solution of CH in SFCDIF<a name='690'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='691'></font>
<font color=#447700>!        IF(.NOT.LCH) THEN<a name='692'></font>
<font color=#447700>!          T1V = T1 * (1.0+ 0.61 * Q2)<a name='693'></font>
<font color=#447700>!          TH2V = TH2 * (1.0+ 0.61 * Q2)<a name='694'></font>
<font color=#447700>!          CALL SFCDIF_off (ZLVL,Z0,T1V,TH2V,SFCSPD,CZIL,CM,CH)<a name='695'></font>
<font color=#447700>!        ENDIF<a name='696'></font>
<a name='697'>
<font color=#447700>! ----------------------------------------------------------------------<a name='698'></font>
<font color=#447700>! CALL PENMAN SUBROUTINE TO CALCULATE POTENTIAL EVAPORATION (ETP), AND<a name='699'></font>
<font color=#447700>! OTHER PARTIAL PRODUCTS AND SUMS SAVE IN COMMON/RITE FOR LATER<a name='700'></font>
<font color=#447700>! CALCULATIONS.<a name='701'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='702'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='703'></font>
<font color=#447700>! CALCULATE TOTAL DOWNWARD RADIATION (SOLAR PLUS LONGWAVE) NEEDED IN<a name='704'></font>
<font color=#447700>! PENMAN EP SUBROUTINE THAT FOLLOWS<a name='705'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='706'></font>
<font color=#447700>!         FDOWN = SOLDN * (1.0- ALBEDO) + LWDN<a name='707'></font>
         FDOWN =  SOLNET + LWDN<a name='708'>
<font color=#447700>! ----------------------------------------------------------------------<a name='709'></font>
<font color=#447700>! CALC VIRTUAL TEMPS AND VIRTUAL POTENTIAL TEMPS NEEDED BY SUBROUTINES<a name='710'></font>
<font color=#447700>! PENMAN.<a name='711'></font>
         T2V = SFCTMP * (1.0+ 0.61 * Q2 )<a name='712'>
<a name='713'>
         iout=0<a name='714'>
         if(iout.eq.1) then<a name='715'>
         print*,'before penman'<a name='716'>
         print*,' SFCTMP',SFCTMP,'SFCPRS',SFCPRS,'CH',CH,'T2V',T2V,      &amp;<a name='717'>
       'TH2',TH2,'PRCP',PRCP,'FDOWN',FDOWN,'T24',T24,'SSOIL',SSOIL,      &amp;<a name='718'>
        'Q2',Q2,'Q2SAT',Q2SAT,'ETP',ETP,'RCH',RCH,                       &amp;<a name='719'>
        'EPSCA',EPSCA,'RR',RR  ,'SNOWNG',SNOWNG,'FRZGRA',FRZGRA,           &amp;<a name='720'>
        'DQSDT2',DQSDT2,'FLX2',FLX2,'SNOWH',SNOWH,'SNEQV',SNEQV,         &amp;<a name='721'>
        ' DSOIL',DSOIL,' FRCSNO',FRCSNO,' SNCOVR',SNCOVR,' DTOT',DTOT,   &amp;<a name='722'>
       ' ZSOIL (1)',ZSOIL(1),' DF1',DF1,'T1',T1,' STC1',STC(1),          &amp;<a name='723'>
        'ALBEDO',ALBEDO,'SMC',SMC,'STC',STC,'SH2O',SH2O<a name='724'>
         endif<a name='725'>
<a name='726'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#PENMAN'>PENMAN</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PENMAN_2"> (SFCTMP,SFCPRS,CH,T2V,TH2,PRCP,FDOWN,T24,SSOIL,     &amp;<a name='727'>
                       Q2,Q2SAT,ETP,RCH,EPSCA,RR,SNOWNG,FRZGRA,          &amp;<a name='728'>
                       DQSDT2,FLX2,EMISSI,SNEQV,T1,SNCOVR,AOASIS,        &amp;<a name='729'>
		       ALBEDO,SOLDN,FVB,GAMA,STC(1),ETPN,FLX4,UA_PHYS)<a name='730'>
<font color=#447700>!<a name='731'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='732'></font>
<font color=#447700>! CALL CANRES TO CALCULATE THE CANOPY RESISTANCE AND CONVERT IT INTO PC<a name='733'></font>
<font color=#447700>! IF NONZERO GREENNESS FRACTION<a name='734'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='735'></font>
<a name='736'>
<font color=#447700>! ----------------------------------------------------------------------<a name='737'></font>
<font color=#447700>!  FROZEN GROUND EXTENSION: TOTAL SOIL WATER "SMC" WAS REPLACED<a name='738'></font>
<font color=#447700>!  BY UNFROZEN SOIL WATER "SH2O" IN CALL TO CANRES BELOW<a name='739'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='740'></font>
         IF ( (SHDFAC &gt; 0.) .AND. (XLAI &gt; 0.) ) THEN<a name='741'>
            CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CANRES'>CANRES</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CANRES_1"> (SOLDN,CH,SFCTMP,Q2,SFCPRS,SH2O,ZSOIL,NSOIL,     &amp;<a name='742'>
                          SMCWLT,SMCREF,RSMIN,RC,PC,NROOT,Q2SAT,DQSDT2,  &amp;<a name='743'>
                          TOPT,RSMAX,RGL,HS,XLAI,                        &amp;<a name='744'>
                          RCS,RCT,RCQ,RCSOIL,EMISSI)<a name='745'>
         ELSE<a name='746'>
            RC = 0.0<a name='747'>
         END IF<a name='748'>
<font color=#447700>! ----------------------------------------------------------------------<a name='749'></font>
<font color=#447700>! NOW DECIDE MAJOR PATHWAY BRANCH TO TAKE DEPENDING ON WHETHER SNOWPACK<a name='750'></font>
<font color=#447700>! EXISTS OR NOT:<a name='751'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='752'></font>
         ESNOW = 0.0<a name='753'>
         IF (SNEQV  == 0.0) THEN<a name='754'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC'>NOPAC</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOPAC_1"> (ETP,ETA,PRCP,SMC,SMCMAX,SMCWLT,                  &amp;<a name='755'>
                            SMCREF,SMCDRY,CMC,CMCMAX,NSOIL,DT,           &amp;<a name='756'>
                            SHDFAC,                                      &amp;<a name='757'>
                            SBETA,Q2,T1,SFCTMP,T24,TH2,FDOWN,F1,EMISSI,  &amp;<a name='758'>
                            SSOIL,                                       &amp;<a name='759'>
                            STC,EPSCA,BEXP,PC,RCH,RR,CFACTR,             &amp;<a name='760'>
                            SH2O,SLOPE,KDT,FRZX,PSISAT,ZSOIL,            &amp;<a name='761'>
                            DKSAT,DWSAT,TBOT,ZBOT,RUNOFF1,RUNOFF2,       &amp;<a name='762'>
                            RUNOFF3,EDIR,EC,ET,ETT,NROOT,RTDIS,          &amp;<a name='763'>
                            QUARTZ,FXEXP,CSOIL,                          &amp;<a name='764'>
                            BETA,DRIP,DEW,FLX1,FLX3,VEGTYP,ISURBAN,      &amp;<a name='765'>
                            SFHEAD1RT,INFXS1RT,ETPND1,SOILTYP,OPT_THCND  &amp;<a name='766'>
                           ,XSDA_QFX,QFX_PHY,XQNORM,fasdas,HCPCT_FASDAS  ) <font color=#447700>!fasdas<a name='767'></font>
            ETA_KINEMATIC = ETA<a name='768'>
         ELSE<a name='769'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOPAC'>SNOPAC</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOPAC_2"> (ETP,ETA,PRCP,PRCPF,SNOWNG,SMC,SMCMAX,SMCWLT,    &amp;<a name='770'>
                         SMCREF,SMCDRY,CMC,CMCMAX,NSOIL,DT,              &amp;<a name='771'>
                         SBETA,DF1,                                      &amp;<a name='772'>
                         Q2,T1,SFCTMP,T24,TH2,FDOWN,F1,SSOIL,STC,EPSCA,  &amp;<a name='773'>
                         SFCPRS,BEXP,PC,RCH,RR,CFACTR,SNCOVR,SNEQV,SNDENS,&amp;<a name='774'>
                         SNOWH,SH2O,SLOPE,KDT,FRZX,PSISAT,               &amp;<a name='775'>
                         ZSOIL,DWSAT,DKSAT,TBOT,ZBOT,SHDFAC,RUNOFF1,     &amp;<a name='776'>
                         RUNOFF2,RUNOFF3,EDIR,EC,ET,ETT,NROOT,SNOMLT,    &amp;<a name='777'>
                         RTDIS,QUARTZ,FXEXP,CSOIL,                       &amp;<a name='778'>
                         BETA,DRIP,DEW,FLX1,FLX2,FLX3,ESNOW,ETNS,EMISSI, &amp;<a name='779'>
                         RIBB,SOLDN,                                     &amp;<a name='780'>
                         ISURBAN,                                        &amp;<a name='781'>
                         VEGTYP,                                         &amp;<a name='782'>
                         ETPN,FLX4,UA_PHYS,                              &amp;<a name='783'>
                         SFHEAD1RT,INFXS1RT,ETPND1,SOILTYP,OPT_THCND     &amp;<a name='784'>
                        ,QFX_PHY,fasdas,HCPCT_FASDAS                     ) <font color=#447700>!fasdas<a name='785'></font>
            ETA_KINEMATIC =  ESNOW + ETNS - 1000.0*DEW<a name='786'>
         END IF<a name='787'>
<a name='788'>
<font color=#447700>!     Calculate effective mixing ratio at grnd level (skin)<a name='789'></font>
<font color=#447700>!<a name='790'></font>
<font color=#447700>!     Q1=Q2+ETA*CP/RCH<a name='791'></font>
     Q1=Q2+ETA_KINEMATIC*CP/RCH<a name='792'>
<font color=#447700>!<a name='793'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='794'></font>
<font color=#447700>! DETERMINE SENSIBLE HEAT (H) IN ENERGY UNITS (W M-2)<a name='795'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='796'></font>
<a name='797'>
         SHEAT = - (CH * CP * SFCPRS)/ (R * T2V) * ( TH2- T1 )<a name='798'>
         IF(UA_PHYS) SHEAT = SHEAT + FLX4   <a name='799'>
<font color=#447700>!<a name='800'></font>
<font color=#447700>! FASDAS<a name='801'></font>
<font color=#447700>!<a name='802'></font>
      IF ( fasdas == 1 ) THEN<a name='803'>
        HFX_PHY = SHEAT<a name='804'>
      ENDIF<a name='805'>
<font color=#447700>!<a name='806'></font>
<font color=#447700>! END FASDAS<a name='807'></font>
<font color=#447700>!<a name='808'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='809'></font>
<font color=#447700>! CONVERT EVAP TERMS FROM KINEMATIC (KG M-2 S-1) TO ENERGY UNITS (W M-2)<a name='810'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='811'></font>
      EDIR = EDIR * LVH2O<a name='812'>
      EC = EC * LVH2O<a name='813'>
      DO K=1,4<a name='814'>
      ET(K) = ET(K) * LVH2O<a name='815'>
      ENDDO<a name='816'>
      ETT = ETT * LVH2O<a name='817'>
      <a name='818'>
      ETPND1=ETPND1 * LVH2O<a name='819'>
<a name='820'>
      ESNOW = ESNOW * LSUBS<a name='821'>
      ETP = ETP*((1.-SNCOVR)*LVH2O + SNCOVR*LSUBS)<a name='822'>
      IF(UA_PHYS) ETPN = ETPN*((1.-SNCOVR)*LVH2O + SNCOVR*LSUBS)<a name='823'>
      IF (ETP .GT. 0.) THEN<a name='824'>
         ETA = EDIR + EC + ETT + ESNOW<a name='825'>
      ELSE<a name='826'>
        ETA = ETP<a name='827'>
      ENDIF<a name='828'>
<font color=#447700>! ----------------------------------------------------------------------<a name='829'></font>
<font color=#447700>! DETERMINE BETA (RATIO OF ACTUAL TO POTENTIAL EVAP)<a name='830'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='831'></font>
      IF (ETP == 0.0) THEN<a name='832'>
        BETA = 0.0<a name='833'>
      ELSE<a name='834'>
        BETA = ETA/ETP<a name='835'>
      ENDIF<a name='836'>
<a name='837'>
<font color=#447700>! ----------------------------------------------------------------------<a name='838'></font>
<font color=#447700>! CONVERT THE SIGN OF SOIL HEAT FLUX SO THAT:<a name='839'></font>
<font color=#447700>!   SSOIL&gt;0: WARM THE SURFACE  (NIGHT TIME)<a name='840'></font>
<font color=#447700>!   SSOIL&lt;0: COOL THE SURFACE  (DAY TIME)<a name='841'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='842'></font>
         SSOIL = -1.0* SSOIL<a name='843'>
<a name='844'>
<font color=#447700>! ----------------------------------------------------------------------<a name='845'></font>
<font color=#447700>!  FOR THE CASE OF LAND:<a name='846'></font>
<font color=#447700>!  CONVERT RUNOFF3 (INTERNAL LAYER RUNOFF FROM SUPERSAT) FROM M TO M S-1<a name='847'></font>
<font color=#447700>!  AND ADD TO SUBSURFACE RUNOFF/DRAINAGE/BASEFLOW.  RUNOFF2 IS ALREADY<a name='848'></font>
<font color=#447700>!  A RATE AT THIS POINT<a name='849'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='850'></font>
         RUNOFF3 = RUNOFF3/ DT<a name='851'>
         RUNOFF2 = RUNOFF2+ RUNOFF3<a name='852'>
         SOILM = -1.0* SMC (1)* ZSOIL (1)<a name='853'>
         DO K = 2,NSOIL<a name='854'>
            SOILM = SOILM + SMC (K)* (ZSOIL (K -1) - ZSOIL (K))<a name='855'>
         END DO<a name='856'>
         SOILWM = -1.0* (SMCMAX - SMCWLT)* ZSOIL (1)<a name='857'>
         SOILWW = -1.0* (SMC (1) - SMCWLT)* ZSOIL (1)<a name='858'>
<a name='859'>
         DO K = 1,NSOIL<a name='860'>
            SMAV(K)=(SMC(K) - SMCWLT)/(SMCMAX - SMCWLT)<a name='861'>
         END DO<a name='862'>
<a name='863'>
         IF (NROOT &gt;= 2) THEN<a name='864'>
            DO K = 2,NROOT<a name='865'>
                SOILWM = SOILWM + (SMCMAX - SMCWLT)* (ZSOIL (K -1) - ZSOIL (K))<a name='866'>
                SOILWW = SOILWW + (SMC(K) - SMCWLT)* (ZSOIL (K -1) - ZSOIL (K))<a name='867'>
            END DO<a name='868'>
         END IF<a name='869'>
         IF (SOILWM .LT. 1.E-6) THEN<a name='870'>
           SOILWM = 0.0<a name='871'>
           SOILW  = 0.0<a name='872'>
           SOILM  = 0.0<a name='873'>
         ELSE<a name='874'>
           SOILW = SOILWW / SOILWM<a name='875'>
         END IF<a name='876'>
<a name='877'>
<font color=#447700>! ----------------------------------------------------------------------<a name='878'></font>
  END SUBROUTINE SFLX<a name='879'>
<font color=#447700>! ----------------------------------------------------------------------<a name='880'></font>
<a name='881'>
<A NAME='ALCALC'><A href='../../html_code/phys/module_sf_noahlsm.F.html#ALCALC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='882'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>ALCALC</font> (ALB,SNOALB,EMBRD,SHDFAC,SHDMIN,SNCOVR,TSNOW,ALBEDO,EMISSI,   &amp; <A href='../../call_to/ALCALC.html' TARGET='index'>2</A><a name='883'>
                         DT,SNOWNG,SNOTIME1,LVCOEF)<a name='884'>
<a name='885'>
<font color=#447700>! ----------------------------------------------------------------------<a name='886'></font>
<font color=#447700>! CALCULATE ALBEDO INCLUDING SNOW EFFECT (0 -&gt; 1)<a name='887'></font>
<font color=#447700>!   ALB     SNOWFREE ALBEDO<a name='888'></font>
<font color=#447700>!   SNOALB  MAXIMUM (DEEP) SNOW ALBEDO<a name='889'></font>
<font color=#447700>!   SHDFAC    AREAL FRACTIONAL COVERAGE OF GREEN VEGETATION<a name='890'></font>
<font color=#447700>!   SHDMIN    MINIMUM AREAL FRACTIONAL COVERAGE OF GREEN VEGETATION<a name='891'></font>
<font color=#447700>!   SNCOVR  FRACTIONAL SNOW COVER<a name='892'></font>
<font color=#447700>!   ALBEDO  SURFACE ALBEDO INCLUDING SNOW EFFECT<a name='893'></font>
<font color=#447700>!   TSNOW   SNOW SURFACE TEMPERATURE (K)<a name='894'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='895'></font>
      IMPLICIT NONE<a name='896'>
<a name='897'>
<font color=#447700>! ----------------------------------------------------------------------<a name='898'></font>
<font color=#447700>! SNOALB IS ARGUMENT REPRESENTING MAXIMUM ALBEDO OVER DEEP SNOW,<a name='899'></font>
<font color=#447700>! AS PASSED INTO SFLX, AND ADAPTED FROM THE SATELLITE-BASED MAXIMUM<a name='900'></font>
<font color=#447700>! SNOW ALBEDO FIELDS PROVIDED BY D. ROBINSON AND G. KUKLA<a name='901'></font>
<font color=#447700>! (1985, JCAM, VOL 24, 402-411)<a name='902'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='903'></font>
      REAL, INTENT(IN)  ::  ALB, SNOALB, EMBRD, SHDFAC, SHDMIN, SNCOVR, TSNOW<a name='904'>
      REAL, INTENT(IN)  :: DT<a name='905'>
      LOGICAL, INTENT(IN) :: SNOWNG<a name='906'>
      REAL, INTENT(INOUT):: SNOTIME1<a name='907'>
      REAL, INTENT(OUT) ::  ALBEDO, EMISSI<a name='908'>
      REAL              :: SNOALB2<a name='909'>
      REAL              :: TM,SNOALB1<a name='910'>
      REAL, INTENT(IN)  :: LVCOEF<a name='911'>
      REAL, PARAMETER   :: SNACCA=0.94,SNACCB=0.58,SNTHWA=0.82,SNTHWB=0.46<a name='912'>
<font color=#447700>! turn of vegetation effect<a name='913'></font>
<font color=#447700>!      ALBEDO = ALB + (1.0- (SHDFAC - SHDMIN))* SNCOVR * (SNOALB - ALB)<a name='914'></font>
<font color=#447700>!      ALBEDO = (1.0-SNCOVR)*ALB + SNCOVR*SNOALB !this is equivalent to below<a name='915'></font>
      ALBEDO = ALB + SNCOVR*(SNOALB-ALB)<a name='916'>
      EMISSI = EMBRD + SNCOVR*(EMISSI_S - EMBRD)<a name='917'>
<a name='918'>
<font color=#447700>!     BASE FORMULATION (DICKINSON ET AL., 1986, COGLEY ET AL., 1990)<a name='919'></font>
<font color=#447700>!          IF (TSNOW.LE.263.16) THEN<a name='920'></font>
<font color=#447700>!            ALBEDO=SNOALB<a name='921'></font>
<font color=#447700>!          ELSE<a name='922'></font>
<font color=#447700>!            IF (TSNOW.LT.273.16) THEN<a name='923'></font>
<font color=#447700>!              TM=0.1*(TSNOW-263.16)<a name='924'></font>
<font color=#447700>!              SNOALB1=0.5*((0.9-0.2*(TM**3))+(0.8-0.16*(TM**3)))<a name='925'></font>
<font color=#447700>!            ELSE<a name='926'></font>
<font color=#447700>!              SNOALB1=0.67<a name='927'></font>
<font color=#447700>!             IF(SNCOVR.GT.0.95) SNOALB1= 0.6<a name='928'></font>
<font color=#447700>!             SNOALB1 = ALB + SNCOVR*(SNOALB-ALB)<a name='929'></font>
<font color=#447700>!            ENDIF<a name='930'></font>
<font color=#447700>!          ENDIF<a name='931'></font>
<font color=#447700>!            ALBEDO = ALB + SNCOVR*(SNOALB1-ALB)<a name='932'></font>
<a name='933'>
<font color=#447700>!     ISBA FORMULATION (VERSEGHY, 1991; BAKER ET AL., 1990)<a name='934'></font>
<font color=#447700>!          SNOALB1 = SNOALB+COEF*(0.85-SNOALB)<a name='935'></font>
<font color=#447700>!          SNOALB2=SNOALB1<a name='936'></font>
<font color=#447700>!!m          LSTSNW=LSTSNW+1<a name='937'></font>
<font color=#447700>!          SNOTIME1 = SNOTIME1 + DT<a name='938'></font>
<font color=#447700>!          IF (SNOWNG) THEN<a name='939'></font>
<font color=#447700>!             SNOALB2=SNOALB<a name='940'></font>
<font color=#447700>!!m             LSTSNW=0<a name='941'></font>
<font color=#447700>!             SNOTIME1 = 0.0<a name='942'></font>
<font color=#447700>!          ELSE<a name='943'></font>
<font color=#447700>!            IF (TSNOW.LT.273.16) THEN<a name='944'></font>
<font color=#447700>!!              SNOALB2=SNOALB-0.008*LSTSNW*DT/86400<a name='945'></font>
<font color=#447700>!!m              SNOALB2=SNOALB-0.008*SNOTIME1/86400<a name='946'></font>
<font color=#447700>!              SNOALB2=(SNOALB2-0.65)*EXP(-0.05*DT/3600)+0.65<a name='947'></font>
<font color=#447700>!!              SNOALB2=(ALBEDO-0.65)*EXP(-0.01*DT/3600)+0.65<a name='948'></font>
<font color=#447700>!            ELSE<a name='949'></font>
<font color=#447700>!              SNOALB2=(SNOALB2-0.5)*EXP(-0.0005*DT/3600)+0.5<a name='950'></font>
<font color=#447700>!!              SNOALB2=(SNOALB-0.5)*EXP(-0.24*LSTSNW*DT/86400)+0.5<a name='951'></font>
<font color=#447700>!!m              SNOALB2=(SNOALB-0.5)*EXP(-0.24*SNOTIME1/86400)+0.5<a name='952'></font>
<font color=#447700>!            ENDIF<a name='953'></font>
<font color=#447700>!          ENDIF<a name='954'></font>
<font color=#447700>!<a name='955'></font>
<font color=#447700>!!               print*,'SNOALB2',SNOALB2,'ALBEDO',ALBEDO,'DT',DT<a name='956'></font>
<font color=#447700>!          ALBEDO = ALB + SNCOVR*(SNOALB2-ALB)<a name='957'></font>
<font color=#447700>!          IF (ALBEDO .GT. SNOALB2) ALBEDO=SNOALB2<a name='958'></font>
<font color=#447700>!!m          LSTSNW1=LSTSNW<a name='959'></font>
<font color=#447700>!!          SNOTIME = SNOTIME1<a name='960'></font>
<a name='961'>
<font color=#447700>! formulation by Livneh<a name='962'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='963'></font>
<font color=#447700>! SNOALB IS CONSIDERED AS THE MAXIMUM SNOW ALBEDO FOR NEW SNOW, AT<a name='964'></font>
<font color=#447700>! A VALUE OF 85%. SNOW ALBEDO CURVE DEFAULTS ARE FROM BRAS P.263. SHOULD<a name='965'></font>
<font color=#447700>! NOT BE CHANGED EXCEPT FOR SERIOUS PROBLEMS WITH SNOW MELT.<a name='966'></font>
<font color=#447700>! TO IMPLEMENT ACCUMULATIN PARAMETERS, SNACCA AND SNACCB, ASSERT THAT IT<a name='967'></font>
<font color=#447700>! IS INDEED ACCUMULATION SEASON. I.E. THAT SNOW SURFACE TEMP IS BELOW<a name='968'></font>
<font color=#447700>! ZERO AND THE DATE FALLS BETWEEN OCTOBER AND FEBRUARY<a name='969'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='970'></font>
         SNOALB1 = SNOALB+LVCOEF*(0.85-SNOALB)<a name='971'>
         SNOALB2=SNOALB1<a name='972'>
<font color=#447700>! ---------------- Initial LSTSNW --------------------------------------<a name='973'></font>
          IF (SNOWNG) THEN<a name='974'>
             SNOTIME1 = 0.<a name='975'>
          ELSE<a name='976'>
           SNOTIME1=SNOTIME1+DT<a name='977'>
<font color=#447700>!               IF (TSNOW.LT.273.16) THEN<a name='978'></font>
                   SNOALB2=SNOALB1*(SNACCA**((SNOTIME1/86400.0)**SNACCB))<a name='979'>
<font color=#447700>!               ELSE<a name='980'></font>
<font color=#447700>!                  SNOALB2 =SNOALB1*(SNTHWA**((SNOTIME1/86400.0)**SNTHWB))<a name='981'></font>
<font color=#447700>!               ENDIF<a name='982'></font>
          ENDIF<a name='983'>
<font color=#447700>!<a name='984'></font>
           SNOALB2 = MAX ( SNOALB2, ALB )<a name='985'>
           ALBEDO = ALB + SNCOVR*(SNOALB2-ALB)<a name='986'>
           IF (ALBEDO .GT. SNOALB2) ALBEDO=SNOALB2<a name='987'>
<a name='988'>
<font color=#447700>!          IF (TSNOW.LT.273.16) THEN<a name='989'></font>
<font color=#447700>!            ALBEDO=SNOALB-0.008*DT/86400<a name='990'></font>
<font color=#447700>!          ELSE<a name='991'></font>
<font color=#447700>!            ALBEDO=(SNOALB-0.5)*EXP(-0.24*DT/86400)+0.5<a name='992'></font>
<font color=#447700>!          ENDIF<a name='993'></font>
<a name='994'>
<font color=#447700>!      IF (ALBEDO &gt; SNOALB) ALBEDO = SNOALB<a name='995'></font>
<a name='996'>
<font color=#447700>! ----------------------------------------------------------------------<a name='997'></font>
  END SUBROUTINE ALCALC<a name='998'>
<font color=#447700>! ----------------------------------------------------------------------<a name='999'></font>
<a name='1000'>
<A NAME='CANRES'><A href='../../html_code/phys/module_sf_noahlsm.F.html#CANRES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1001'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>CANRES</font> (SOLAR,CH,SFCTMP,Q2,SFCPRS,SMC,ZSOIL,NSOIL,       &amp; <A href='../../call_to/CANRES.html' TARGET='index'>3</A>,<A href='../../call_from/CANRES.html' TARGET='index'>1</A><a name='1002'>
                         SMCWLT,SMCREF,RSMIN,RC,PC,NROOT,Q2SAT,DQSDT2,    &amp;<a name='1003'>
                         TOPT,RSMAX,RGL,HS,XLAI,                          &amp;<a name='1004'>
                         RCS,RCT,RCQ,RCSOIL,EMISSI)<a name='1005'>
<a name='1006'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1007'></font>
<font color=#447700>! SUBROUTINE CANRES<a name='1008'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1009'></font>
<font color=#447700>! CALCULATE CANOPY RESISTANCE WHICH DEPENDS ON INCOMING SOLAR RADIATION,<a name='1010'></font>
<font color=#447700>! AIR TEMPERATURE, ATMOSPHERIC WATER VAPOR PRESSURE DEFICIT AT THE<a name='1011'></font>
<font color=#447700>! LOWEST MODEL LEVEL, AND SOIL MOISTURE (PREFERABLY UNFROZEN SOIL<a name='1012'></font>
<font color=#447700>! MOISTURE RATHER THAN TOTAL)<a name='1013'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1014'></font>
<font color=#447700>! SOURCE:  JARVIS (1976), NOILHAN AND PLANTON (1989, MWR), JACQUEMIN AND<a name='1015'></font>
<font color=#447700>! NOILHAN (1990, BLM)<a name='1016'></font>
<font color=#447700>! SEE ALSO:  CHEN ET AL (1996, JGR, VOL 101(D3), 7251-7268), EQNS 12-14<a name='1017'></font>
<font color=#447700>! AND TABLE 2 OF SEC. 3.1.2<a name='1018'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1019'></font>
<font color=#447700>! INPUT:<a name='1020'></font>
<font color=#447700>!   SOLAR   INCOMING SOLAR RADIATION<a name='1021'></font>
<font color=#447700>!   CH      SURFACE EXCHANGE COEFFICIENT FOR HEAT AND MOISTURE<a name='1022'></font>
<font color=#447700>!   SFCTMP  AIR TEMPERATURE AT 1ST LEVEL ABOVE GROUND<a name='1023'></font>
<font color=#447700>!   Q2      AIR HUMIDITY AT 1ST LEVEL ABOVE GROUND<a name='1024'></font>
<font color=#447700>!   Q2SAT   SATURATION AIR HUMIDITY AT 1ST LEVEL ABOVE GROUND<a name='1025'></font>
<font color=#447700>!   DQSDT2  SLOPE OF SATURATION HUMIDITY FUNCTION WRT TEMP<a name='1026'></font>
<font color=#447700>!   SFCPRS  SURFACE PRESSURE<a name='1027'></font>
<font color=#447700>!   SMC     VOLUMETRIC SOIL MOISTURE<a name='1028'></font>
<font color=#447700>!   ZSOIL   SOIL DEPTH (NEGATIVE SIGN, AS IT IS BELOW GROUND)<a name='1029'></font>
<font color=#447700>!   NSOIL   NO. OF SOIL LAYERS<a name='1030'></font>
<font color=#447700>!   NROOT   NO. OF SOIL LAYERS IN ROOT ZONE (1.LE.NROOT.LE.NSOIL)<a name='1031'></font>
<font color=#447700>!   XLAI    LEAF AREA INDEX<a name='1032'></font>
<font color=#447700>!   SMCWLT  WILTING POINT<a name='1033'></font>
<font color=#447700>!   SMCREF  REFERENCE SOIL MOISTURE (WHERE SOIL WATER DEFICIT STRESS<a name='1034'></font>
<font color=#447700>!             SETS IN)<a name='1035'></font>
<font color=#447700>! RSMIN, RSMAX, TOPT, RGL, HS ARE CANOPY STRESS PARAMETERS SET IN<a name='1036'></font>
<font color=#447700>!   SURBOUTINE REDPRM<a name='1037'></font>
<font color=#447700>! OUTPUT:<a name='1038'></font>
<font color=#447700>!   PC  PLANT COEFFICIENT<a name='1039'></font>
<font color=#447700>!   RC  CANOPY RESISTANCE<a name='1040'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1041'></font>
<a name='1042'>
      IMPLICIT NONE<a name='1043'>
      INTEGER, INTENT(IN) :: NROOT,NSOIL<a name='1044'>
      INTEGER  K<a name='1045'>
      REAL,    INTENT(IN) :: CH,DQSDT2,HS,Q2,Q2SAT,RSMIN,RGL,RSMAX,        &amp;<a name='1046'>
                             SFCPRS,SFCTMP,SMCREF,SMCWLT, SOLAR,TOPT,XLAI, &amp;<a name='1047'>
                             EMISSI<a name='1048'>
      REAL,DIMENSION(1:NSOIL), INTENT(IN) :: SMC,ZSOIL<a name='1049'>
      REAL,    INTENT(OUT):: PC,RC,RCQ,RCS,RCSOIL,RCT<a name='1050'>
      REAL                :: DELTA,FF,GX,P,RR<a name='1051'>
      REAL, DIMENSION(1:NSOIL) ::  PART<a name='1052'>
      REAL, PARAMETER     :: SLV = 2.501000E6<a name='1053'>
<a name='1054'>
<a name='1055'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1056'></font>
<font color=#447700>! INITIALIZE CANOPY RESISTANCE MULTIPLIER TERMS.<a name='1057'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1058'></font>
      RCS = 0.0<a name='1059'>
      RCT = 0.0<a name='1060'>
      RCQ = 0.0<a name='1061'>
      RCSOIL = 0.0<a name='1062'>
<a name='1063'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1064'></font>
<font color=#447700>! CONTRIBUTION DUE TO INCOMING SOLAR RADIATION<a name='1065'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1066'></font>
      RC = 0.0<a name='1067'>
      FF = 0.55*2.0* SOLAR / (RGL * XLAI)<a name='1068'>
      RCS = (FF + RSMIN / RSMAX) / (1.0+ FF)<a name='1069'>
<a name='1070'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1071'></font>
<font color=#447700>! CONTRIBUTION DUE TO AIR TEMPERATURE AT FIRST MODEL LEVEL ABOVE GROUND<a name='1072'></font>
<font color=#447700>! RCT EXPRESSION FROM NOILHAN AND PLANTON (1989, MWR).<a name='1073'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1074'></font>
      RCS = MAX (RCS,0.0001)<a name='1075'>
      RCT = 1.0- 0.0016* ( (TOPT - SFCTMP)**2.0)<a name='1076'>
<a name='1077'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1078'></font>
<font color=#447700>! CONTRIBUTION DUE TO VAPOR PRESSURE DEFICIT AT FIRST MODEL LEVEL.<a name='1079'></font>
<font color=#447700>! RCQ EXPRESSION FROM SSIB<a name='1080'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1081'></font>
      RCT = MAX (RCT,0.0001)<a name='1082'>
      RCQ = 1.0/ (1.0+ HS * (Q2SAT - Q2))<a name='1083'>
<a name='1084'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1085'></font>
<font color=#447700>! CONTRIBUTION DUE TO SOIL MOISTURE AVAILABILITY.<a name='1086'></font>
<font color=#447700>! DETERMINE CONTRIBUTION FROM EACH SOIL LAYER, THEN ADD THEM UP.<a name='1087'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1088'></font>
      RCQ = MAX (RCQ,0.01)<a name='1089'>
      GX = (SMC (1) - SMCWLT) / (SMCREF - SMCWLT)<a name='1090'>
      IF (GX  &gt;  1.) GX = 1.<a name='1091'>
      IF (GX  &lt;  0.) GX = 0.<a name='1092'>
<a name='1093'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1094'></font>
<font color=#447700>! USE SOIL DEPTH AS WEIGHTING FACTOR<a name='1095'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1096'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1097'></font>
<font color=#447700>! USE ROOT DISTRIBUTION AS WEIGHTING FACTOR<a name='1098'></font>
<font color=#447700>!      PART(1) = RTDIS(1) * GX<a name='1099'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1100'></font>
      PART (1) = (ZSOIL (1)/ ZSOIL (NROOT)) * GX<a name='1101'>
      DO K = 2,NROOT<a name='1102'>
         GX = (SMC (K) - SMCWLT) / (SMCREF - SMCWLT)<a name='1103'>
         IF (GX &gt;  1.) GX = 1.<a name='1104'>
         IF (GX &lt;  0.) GX = 0.<a name='1105'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1106'></font>
<font color=#447700>! USE SOIL DEPTH AS WEIGHTING FACTOR<a name='1107'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1108'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1109'></font>
<font color=#447700>! USE ROOT DISTRIBUTION AS WEIGHTING FACTOR<a name='1110'></font>
<font color=#447700>!        PART(K) = RTDIS(K) * GX<a name='1111'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1112'></font>
         PART (K) = ( (ZSOIL (K) - ZSOIL (K -1))/ ZSOIL (NROOT)) * GX<a name='1113'>
      END DO<a name='1114'>
      DO K = 1,NROOT<a name='1115'>
         RCSOIL = RCSOIL + PART (K)<a name='1116'>
      END DO<a name='1117'>
<a name='1118'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1119'></font>
<font color=#447700>! DETERMINE CANOPY RESISTANCE DUE TO ALL FACTORS.  CONVERT CANOPY<a name='1120'></font>
<font color=#447700>! RESISTANCE (RC) TO PLANT COEFFICIENT (PC) TO BE USED WITH POTENTIAL<a name='1121'></font>
<font color=#447700>! EVAP IN DETERMINING ACTUAL EVAP.  PC IS DETERMINED BY:<a name='1122'></font>
<font color=#447700>!   PC * LINERIZED PENMAN POTENTIAL EVAP =<a name='1123'></font>
<font color=#447700>!   PENMAN-MONTEITH ACTUAL EVAPORATION (CONTAINING RC TERM).<a name='1124'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1125'></font>
      RCSOIL = MAX (RCSOIL,0.0001)<a name='1126'>
<a name='1127'>
      RC = RSMIN / (XLAI * RCS * RCT * RCQ * RCSOIL)<a name='1128'>
<font color=#447700>!      RR = (4.* SIGMA * RD / CP)* (SFCTMP **4.)/ (SFCPRS * CH) + 1.0<a name='1129'></font>
      RR = (4.* EMISSI *SIGMA * RD / CP)* (SFCTMP **4.)/ (SFCPRS * CH) &amp;<a name='1130'>
             + 1.0<a name='1131'>
<a name='1132'>
      DELTA = (SLV / CP)* DQSDT2<a name='1133'>
<a name='1134'>
      PC = (RR + DELTA)/ (RR * (1. + RC * CH) + DELTA)<a name='1135'>
<a name='1136'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1137'></font>
  END SUBROUTINE CANRES<a name='1138'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1139'></font>
<a name='1140'>
<A NAME='CSNOW'><A href='../../html_code/phys/module_sf_noahlsm.F.html#CSNOW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1141'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>CSNOW</font> (SNCOND,DSNOW) <A href='../../call_to/CSNOW.html' TARGET='index'>7</A><a name='1142'>
<a name='1143'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1144'></font>
<font color=#447700>! SUBROUTINE CSNOW<a name='1145'></font>
<font color=#447700>! FUNCTION CSNOW<a name='1146'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1147'></font>
<font color=#447700>! CALCULATE SNOW TERMAL CONDUCTIVITY<a name='1148'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1149'></font>
      IMPLICIT NONE<a name='1150'>
      REAL, INTENT(IN) :: DSNOW<a name='1151'>
      REAL, INTENT(OUT):: SNCOND<a name='1152'>
      REAL             :: C<a name='1153'>
      REAL, PARAMETER  :: UNIT = 0.11631<a name='1154'>
<a name='1155'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1156'></font>
<font color=#447700>! SNCOND IN UNITS OF CAL/(CM*HR*C), RETURNED IN W/(M*C)<a name='1157'></font>
<font color=#447700>! CSNOW IN UNITS OF CAL/(CM*HR*C), RETURNED IN W/(M*C)<a name='1158'></font>
<font color=#447700>! BASIC VERSION IS DYACHKOVA EQUATION (1960), FOR RANGE 0.1-0.4<a name='1159'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1160'></font>
      C = 0.328*10** (2.25* DSNOW)<a name='1161'>
<font color=#447700>!      CSNOW=UNIT*C<a name='1162'></font>
<a name='1163'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1164'></font>
<font color=#447700>! DE VAUX EQUATION (1933), IN RANGE 0.1-0.6<a name='1165'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1166'></font>
<font color=#447700>!      SNCOND=0.0293*(1.+100.*DSNOW**2)<a name='1167'></font>
<font color=#447700>!      CSNOW=0.0293*(1.+100.*DSNOW**2)<a name='1168'></font>
<a name='1169'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1170'></font>
<font color=#447700>! E. ANDERSEN FROM FLERCHINGER<a name='1171'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1172'></font>
<font color=#447700>!      SNCOND=0.021+2.51*DSNOW**2<a name='1173'></font>
<font color=#447700>!      CSNOW=0.021+2.51*DSNOW**2<a name='1174'></font>
<a name='1175'>
<font color=#447700>!      SNCOND = UNIT * C<a name='1176'></font>
<font color=#447700>! double snow thermal conductivity<a name='1177'></font>
      SNCOND = 2.0 * UNIT * C<a name='1178'>
<a name='1179'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1180'></font>
  END SUBROUTINE CSNOW<a name='1181'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1182'></font>
<A NAME='DEVAP'><A href='../../html_code/phys/module_sf_noahlsm.F.html#DEVAP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1183'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>DEVAP</font> (EDIR,ETP1,SMC,ZSOIL,SHDFAC,SMCMAX,BEXP,         &amp; <A href='../../call_to/DEVAP.html' TARGET='index'>2</A><a name='1184'>
                        DKSAT,DWSAT,SMCDRY,SMCREF,SMCWLT,FXEXP)<a name='1185'>
<a name='1186'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1187'></font>
<font color=#447700>! SUBROUTINE DEVAP<a name='1188'></font>
<font color=#447700>! FUNCTION DEVAP<a name='1189'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1190'></font>
<font color=#447700>! CALCULATE DIRECT SOIL EVAPORATION<a name='1191'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1192'></font>
      IMPLICIT NONE<a name='1193'>
      REAL, INTENT(IN) :: ETP1,SMC,BEXP,DKSAT,DWSAT,FXEXP,              &amp;<a name='1194'>
                          SHDFAC,SMCDRY,SMCMAX,ZSOIL,SMCREF,SMCWLT<a name='1195'>
      REAL, INTENT(OUT):: EDIR<a name='1196'>
      REAL             :: FX, SRATIO<a name='1197'>
<a name='1198'>
<a name='1199'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1200'></font>
<font color=#447700>! DIRECT EVAP A FUNCTION OF RELATIVE SOIL MOISTURE AVAILABILITY, LINEAR<a name='1201'></font>
<font color=#447700>! WHEN FXEXP=1.<a name='1202'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1203'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1204'></font>
<font color=#447700>! FX &gt; 1 REPRESENTS DEMAND CONTROL<a name='1205'></font>
<font color=#447700>! FX &lt; 1 REPRESENTS FLUX CONTROL<a name='1206'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1207'></font>
<a name='1208'>
      SRATIO = (SMC - SMCDRY) / (SMCMAX - SMCDRY)<a name='1209'>
      IF (SRATIO &gt; 0.) THEN<a name='1210'>
        FX = SRATIO**FXEXP<a name='1211'>
        FX = MAX ( MIN ( FX, 1. ) ,0. )<a name='1212'>
      ELSE<a name='1213'>
        FX = 0.<a name='1214'>
      ENDIF<a name='1215'>
<a name='1216'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1217'></font>
<font color=#447700>! ALLOW FOR THE DIRECT-EVAP-REDUCING EFFECT OF SHADE<a name='1218'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1219'></font>
      EDIR = FX * ( 1.0- SHDFAC ) * ETP1<a name='1220'>
<a name='1221'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1222'></font>
  END SUBROUTINE DEVAP<a name='1223'>
<a name='1224'>
<A NAME='DEVAP_HYDRO'><A href='../../html_code/phys/module_sf_noahlsm.F.html#DEVAP_HYDRO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1225'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>DEVAP_hydro</font> (EDIR,ETP1,SMC,ZSOIL,SHDFAC,SMCMAX,BEXP,         &amp;<a name='1226'>
                        DKSAT,DWSAT,SMCDRY,SMCREF,SMCWLT,FXEXP,         &amp;<a name='1227'>
                        SFHEAD1RT,ETPND1,DT)<a name='1228'>
<a name='1229'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1230'></font>
<font color=#447700>! SUBROUTINE DEVAP<a name='1231'></font>
<font color=#447700>! FUNCTION DEVAP<a name='1232'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1233'></font>
<font color=#447700>! CALCULATE DIRECT SOIL EVAPORATION<a name='1234'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1235'></font>
      IMPLICIT NONE<a name='1236'>
      REAL, INTENT(IN) :: ETP1,SMC,BEXP,DKSAT,DWSAT,FXEXP,              &amp;<a name='1237'>
                          SHDFAC,SMCDRY,SMCMAX,ZSOIL,SMCREF,SMCWLT<a name='1238'>
      REAL, INTENT(OUT):: EDIR<a name='1239'>
      REAL             :: FX, SRATIO<a name='1240'>
<a name='1241'>
      REAL, INTENT(INOUT) :: SFHEAD1RT,ETPND1<a name='1242'>
      REAL, INTENT(IN   ) :: DT<a name='1243'>
       REAL             :: EDIRTMP<a name='1244'>
<a name='1245'>
<a name='1246'>
<a name='1247'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1248'></font>
<font color=#447700>! DIRECT EVAP A FUNCTION OF RELATIVE SOIL MOISTURE AVAILABILITY, LINEAR<a name='1249'></font>
<font color=#447700>! WHEN FXEXP=1.<a name='1250'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1251'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1252'></font>
<font color=#447700>! FX &gt; 1 REPRESENTS DEMAND CONTROL<a name='1253'></font>
<font color=#447700>! FX &lt; 1 REPRESENTS FLUX CONTROL<a name='1254'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1255'></font>
<a name='1256'>
      SRATIO = (SMC - SMCDRY) / (SMCMAX - SMCDRY)<a name='1257'>
      IF (SRATIO &gt; 0.) THEN<a name='1258'>
        FX = SRATIO**FXEXP<a name='1259'>
        FX = MAX ( MIN ( FX, 1. ) ,0. )<a name='1260'>
      ELSE<a name='1261'>
        FX = 0.<a name='1262'>
      ENDIF<a name='1263'>
<a name='1264'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edits... Adjustment for ponded surface water : Reduce ETP1<a name='1265'></font>
      EDIRTMP = 0.<a name='1266'>
      ETPND1 = 0.<a name='1267'>
<a name='1268'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edits...  Calc Max Potential Dir Evap. (ETP1 units: }=m/s)<a name='1269'></font>
<a name='1270'>
<font color=#447700>!DJG NDHMS/WRF-Hydro...currently set ponded water evap to 0.0 until further notice...11/5/2012<a name='1271'></font>
<font color=#447700>!EDIRTMP = ( 1.0- SHDFAC ) * ETP1<a name='1272'></font>
<a name='1273'>
<font color=#447700>! Convert all units to (m)<a name='1274'></font>
<font color=#447700>! Convert EDIRTMP  from (kg m{-2} s{-1}=m/s) to (m) ...<a name='1275'></font>
      EDIRTMP = EDIRTMP * DT<a name='1276'>
<a name='1277'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edits... Convert SFHEAD from (mm) to (m) ...<a name='1278'></font>
      SFHEAD1RT=SFHEAD1RT * 0.001<a name='1279'>
<a name='1280'>
<a name='1281'>
<a name='1282'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edits... Calculate ETPND as reduction in EDIR(TMP)...<a name='1283'></font>
      IF (EDIRTMP &gt; 0.) THEN<a name='1284'>
       IF ( EDIRTMP &gt; SFHEAD1RT ) THEN<a name='1285'>
         ETPND1 = SFHEAD1RT<a name='1286'>
         SFHEAD1RT=0.<a name='1287'>
         EDIRTMP = EDIRTMP - ETPND1<a name='1288'>
       ELSE<a name='1289'>
         ETPND1 = EDIRTMP<a name='1290'>
         EDIRTMP = 0.<a name='1291'>
         SFHEAD1RT = SFHEAD1RT - ETPND1<a name='1292'>
       END IF<a name='1293'>
      END IF<a name='1294'>
<a name='1295'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edits... Convert SFHEAD units back to (mm)<a name='1296'></font>
      IF ( SFHEAD1RT /= 0.) SFHEAD1RT=SFHEAD1RT * 1000.<a name='1297'>
<a name='1298'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edits...Convert ETPND and EDIRTMP back to (mm/s=kg m{-2} s{-1})<a name='1299'></font>
      ETPND1 = ETPND1 / DT<a name='1300'>
      EDIRTMP = EDIRTMP / DT<a name='1301'>
<font color=#447700>!DEBUG    print *, "After DEVAP...SFCHEAD+ETPND1",SFHEAD1RT+ETPND1*DT<a name='1302'></font>
<a name='1303'>
<a name='1304'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1305'></font>
<font color=#447700>! ALLOW FOR THE DIRECT-EVAP-REDUCING EFFECT OF SHADE<a name='1306'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1307'></font>
<font color=#447700>!DJG NDHMS/WRF-Hydro edits...<a name='1308'></font>
<font color=#447700>!       EDIR = FX * ( 1.0- SHDFAC ) * ETP1<a name='1309'></font>
       EDIR = FX * EDIRTMP<a name='1310'>
<a name='1311'>
<a name='1312'>
<a name='1313'>
<a name='1314'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1315'></font>
  END SUBROUTINE DEVAP_hydro<a name='1316'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1317'></font>
<a name='1318'>
<A NAME='EVAPO'><A href='../../html_code/phys/module_sf_noahlsm.F.html#EVAPO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1319'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>EVAPO</font> (ETA1,SMC,NSOIL,CMC,ETP1,DT,ZSOIL,               &amp; <A href='../../call_to/EVAPO.html' TARGET='index'>2</A>,<A href='../../call_from/EVAPO.html' TARGET='index'>3</A><a name='1320'>
                         SH2O,                                          &amp;<a name='1321'>
                         SMCMAX,BEXP,PC,SMCWLT,DKSAT,DWSAT,             &amp;<a name='1322'>
                         SMCREF,SHDFAC,CMCMAX,                          &amp;<a name='1323'>
                         SMCDRY,CFACTR,                                 &amp;<a name='1324'>
                         EDIR,EC,ET,ETT,SFCTMP,Q2,NROOT,RTDIS,FXEXP,    &amp;<a name='1325'>
                         SFHEAD1RT,ETPND1)<a name='1326'>
<a name='1327'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1328'></font>
<font color=#447700>! SUBROUTINE EVAPO<a name='1329'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1330'></font>
<font color=#447700>! CALCULATE SOIL MOISTURE FLUX.  THE SOIL MOISTURE CONTENT (SMC - A PER<a name='1331'></font>
<font color=#447700>! UNIT VOLUME MEASUREMENT) IS A DEPENDENT VARIABLE THAT IS UPDATED WITH<a name='1332'></font>
<font color=#447700>! PROGNOSTIC EQNS. THE CANOPY MOISTURE CONTENT (CMC) IS ALSO UPDATED.<a name='1333'></font>
<font color=#447700>! FROZEN GROUND VERSION:  NEW STATES ADDED: SH2O, AND FROZEN GROUND<a name='1334'></font>
<font color=#447700>! CORRECTION FACTOR, FRZFACT AND PARAMETER SLOPE.<a name='1335'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1336'></font>
      IMPLICIT NONE<a name='1337'>
      INTEGER, INTENT(IN)   :: NSOIL, NROOT<a name='1338'>
      INTEGER               :: I,K<a name='1339'>
      REAL,    INTENT(IN)   :: BEXP, CFACTR,CMC,CMCMAX,DKSAT,           &amp;<a name='1340'>
                                 DT,DWSAT,ETP1,FXEXP,PC,Q2,SFCTMP,           &amp;<a name='1341'>
                                 SHDFAC,SMCDRY,SMCMAX,SMCREF,SMCWLT<a name='1342'>
      REAL,    INTENT(OUT)  :: EC,EDIR,ETA1,ETT<a name='1343'>
      REAL                  :: CMC2MS<a name='1344'>
      REAL,DIMENSION(1:NSOIL), INTENT(IN) :: RTDIS, SMC, SH2O, ZSOIL<a name='1345'>
      REAL,DIMENSION(1:NSOIL), INTENT(OUT) :: ET<a name='1346'>
<a name='1347'>
      REAL,   INTENT(INOUT) :: SFHEAD1RT,ETPND1<a name='1348'>
<a name='1349'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1350'></font>
<font color=#447700>! EXECUTABLE CODE BEGINS HERE IF THE POTENTIAL EVAPOTRANSPIRATION IS<a name='1351'></font>
<font color=#447700>! GREATER THAN ZERO.<a name='1352'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1353'></font>
      EDIR = 0.<a name='1354'>
      EC = 0.<a name='1355'>
      ETT = 0.<a name='1356'>
      DO K = 1,NSOIL<a name='1357'>
         ET (K) = 0.<a name='1358'>
      END DO<a name='1359'>
<a name='1360'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1361'></font>
<font color=#447700>! RETRIEVE DIRECT EVAPORATION FROM SOIL SURFACE.  CALL THIS FUNCTION<a name='1362'></font>
<font color=#447700>! ONLY IF VEG COVER NOT COMPLETE.<a name='1363'></font>
<font color=#447700>! FROZEN GROUND VERSION:  SH2O STATES REPLACE SMC STATES.<a name='1364'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1365'></font>
      IF (ETP1 &gt; 0.0) THEN<a name='1366'>
         IF (SHDFAC &lt;  1.) THEN<a name='1367'>
#ifdef WRF_HYDRO<a name='1368'>
<font color=#447700>!            CALL DEVAP_hydro (EDIR,ETP1,SMC (1),ZSOIL (1),SHDFAC,SMCMAX,      &amp;<a name='1369'></font>
<font color=#447700>!                        BEXP,DKSAT,DWSAT,SMCDRY,SMCREF,SMCWLT,FXEXP,    &amp;<a name='1370'></font>
<font color=#447700>!                         SFHEAD1RT,ETPND1,DT)<a name='1371'></font>
<font color=#447700>!DJG Reduce ETP1 by EDIR &amp; ETPND1...<a name='1372'></font>
<font color=#447700>!                ETP1=ETP1-EDIR-ETPND1<a name='1373'></font>
<a name='1374'>
<font color=#447700>! following is the temparay setting ...<a name='1375'></font>
             CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#DEVAP'>DEVAP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#EVAPO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEVAP_1"> (EDIR,ETP1,SMC (1),ZSOIL (1),SHDFAC,SMCMAX,      &amp;<a name='1376'>
                         BEXP,DKSAT,DWSAT,SMCDRY,SMCREF,SMCWLT,FXEXP)<a name='1377'>
<font color=#447700>!            ETP1=ETP1-EDIR<a name='1378'></font>
#else<a name='1379'>
             CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#DEVAP'>DEVAP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#EVAPO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEVAP_2"> (EDIR,ETP1,SMC (1),ZSOIL (1),SHDFAC,SMCMAX,      &amp;<a name='1380'>
                         BEXP,DKSAT,DWSAT,SMCDRY,SMCREF,SMCWLT,FXEXP)<a name='1381'>
#endif<a name='1382'>
         END IF<a name='1383'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1384'></font>
<font color=#447700>! INITIALIZE PLANT TOTAL TRANSPIRATION, RETRIEVE PLANT TRANSPIRATION,<a name='1385'></font>
<font color=#447700>! AND ACCUMULATE IT FOR ALL SOIL LAYERS.<a name='1386'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1387'></font>
<a name='1388'>
         IF (SHDFAC &gt; 0.0) THEN<a name='1389'>
            CALL <A href='../../html_code/phys/module_sf_urban.F.html#TRANSP'>TRANSP</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#EVAPO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRANSP_1"> (ET,NSOIL,ETP1,SH2O,CMC,ZSOIL,SHDFAC,SMCWLT,     &amp;<a name='1390'>
                          CMCMAX,PC,CFACTR,SMCREF,SFCTMP,Q2,NROOT,RTDIS)<a name='1391'>
            DO K = 1,NSOIL<a name='1392'>
               ETT = ETT + ET ( K )<a name='1393'>
            END DO<a name='1394'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1395'></font>
<font color=#447700>! CALCULATE CANOPY EVAPORATION.<a name='1396'></font>
<font color=#447700>! IF STATEMENTS TO AVOID TANGENT LINEAR PROBLEMS NEAR CMC=0.0.<a name='1397'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1398'></font>
            IF (CMC &gt; 0.0) THEN<a name='1399'>
               EC = SHDFAC * ( ( CMC / CMCMAX ) ** CFACTR ) * ETP1<a name='1400'>
            ELSE<a name='1401'>
               EC = 0.0<a name='1402'>
            END IF<a name='1403'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1404'></font>
<font color=#447700>! EC SHOULD BE LIMITED BY THE TOTAL AMOUNT OF AVAILABLE WATER ON THE<a name='1405'></font>
<font color=#447700>! CANOPY.  -F.CHEN, 18-OCT-1994<a name='1406'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1407'></font>
            CMC2MS = CMC / DT<a name='1408'>
            EC = MIN ( CMC2MS, EC )<a name='1409'>
         END IF<a name='1410'>
      END IF<a name='1411'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1412'></font>
<font color=#447700>! TOTAL UP EVAP AND TRANSP TYPES TO OBTAIN ACTUAL EVAPOTRANSP<a name='1413'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1414'></font>
      ETA1 = EDIR + ETT + EC<a name='1415'>
<a name='1416'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1417'></font>
  END SUBROUTINE EVAPO<a name='1418'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1419'></font>
<a name='1420'>
<A NAME='FAC2MIT'><A href='../../html_code/phys/module_sf_noahlsm.F.html#FAC2MIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1421'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>FAC2MIT</font>(SMCMAX,FLIMIT) <A href='../../call_to/FAC2MIT.html' TARGET='index'>1</A><a name='1422'>
    IMPLICIT NONE		<a name='1423'>
    REAL, INTENT(IN)  :: SMCMAX<a name='1424'>
    REAL, INTENT(OUT) :: FLIMIT<a name='1425'>
<a name='1426'>
    FLIMIT = 0.90<a name='1427'>
<a name='1428'>
    IF ( SMCMAX == 0.395 ) THEN<a name='1429'>
       FLIMIT = 0.59<a name='1430'>
    ELSE IF ( ( SMCMAX == 0.434 ) .OR. ( SMCMAX == 0.404 ) ) THEN<a name='1431'>
       FLIMIT = 0.85<a name='1432'>
    ELSE IF ( ( SMCMAX == 0.465 ) .OR. ( SMCMAX == 0.406 ) ) THEN<a name='1433'>
       FLIMIT = 0.86<a name='1434'>
    ELSE IF ( ( SMCMAX == 0.476 ) .OR. ( SMCMAX == 0.439 ) ) THEN<a name='1435'>
       FLIMIT = 0.74<a name='1436'>
    ELSE IF ( ( SMCMAX == 0.200 ) .OR. ( SMCMAX == 0.464 ) ) THEN<a name='1437'>
       FLIMIT = 0.80<a name='1438'>
    ENDIF<a name='1439'>
<a name='1440'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1441'></font>
  END SUBROUTINE FAC2MIT<a name='1442'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1443'></font>
<a name='1444'>
<A NAME='FRH2O'><A href='../../html_code/phys/module_sf_noahlsm.F.html#FRH2O' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1445'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>FRH2O</font> (FREE,TKELV,SMC,SH2O,SMCMAX,BEXP,PSIS) <A href='../../call_to/FRH2O.html' TARGET='index'>3</A>,<A href='../../call_from/FRH2O.html' TARGET='index'>1</A><a name='1446'>
<a name='1447'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1448'></font>
<font color=#447700>! SUBROUTINE FRH2O<a name='1449'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1450'></font>
<font color=#447700>! CALCULATE AMOUNT OF SUPERCOOLED LIQUID SOIL WATER CONTENT IF<a name='1451'></font>
<font color=#447700>! TEMPERATURE IS BELOW 273.15K (T0).  REQUIRES NEWTON-TYPE ITERATION TO<a name='1452'></font>
<font color=#447700>! SOLVE THE NONLINEAR IMPLICIT EQUATION GIVEN IN EQN 17 OF KOREN ET AL<a name='1453'></font>
<font color=#447700>! (1999, JGR, VOL 104(D16), 19569-19585).<a name='1454'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1455'></font>
<font color=#447700>! NEW VERSION (JUNE 2001): MUCH FASTER AND MORE ACCURATE NEWTON<a name='1456'></font>
<font color=#447700>! ITERATION ACHIEVED BY FIRST TAKING LOG OF EQN CITED ABOVE -- LESS THAN<a name='1457'></font>
<font color=#447700>! 4 (TYPICALLY 1 OR 2) ITERATIONS ACHIEVES CONVERGENCE.  ALSO, EXPLICIT<a name='1458'></font>
<font color=#447700>! 1-STEP SOLUTION OPTION FOR SPECIAL CASE OF PARAMETER CK=0, WHICH<a name='1459'></font>
<font color=#447700>! REDUCES THE ORIGINAL IMPLICIT EQUATION TO A SIMPLER EXPLICIT FORM,<a name='1460'></font>
<font color=#447700>! KNOWN AS THE "FLERCHINGER EQN". IMPROVED HANDLING OF SOLUTION IN THE<a name='1461'></font>
<font color=#447700>! LIMIT OF FREEZING POINT TEMPERATURE T0.<a name='1462'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1463'></font>
<font color=#447700>! INPUT:<a name='1464'></font>
<a name='1465'>
<font color=#447700>!   TKELV.........TEMPERATURE (Kelvin)<a name='1466'></font>
<font color=#447700>!   SMC...........TOTAL SOIL MOISTURE CONTENT (VOLUMETRIC)<a name='1467'></font>
<font color=#447700>!   SH2O..........LIQUID SOIL MOISTURE CONTENT (VOLUMETRIC)<a name='1468'></font>
<font color=#447700>!   SMCMAX........SATURATION SOIL MOISTURE CONTENT (FROM REDPRM)<a name='1469'></font>
<font color=#447700>!   B.............SOIL TYPE "B" PARAMETER (FROM REDPRM)<a name='1470'></font>
<font color=#447700>!   PSIS..........SATURATED SOIL MATRIC POTENTIAL (FROM REDPRM)<a name='1471'></font>
<a name='1472'>
<font color=#447700>! OUTPUT:<a name='1473'></font>
<font color=#447700>!   FRH2O.........SUPERCOOLED LIQUID WATER CONTENT<a name='1474'></font>
<font color=#447700>!   FREE..........SUPERCOOLED LIQUID WATER CONTENT<a name='1475'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1476'></font>
      IMPLICIT NONE<a name='1477'>
      REAL, INTENT(IN)     :: BEXP,PSIS,SH2O,SMC,SMCMAX,TKELV<a name='1478'>
      REAL, INTENT(OUT)    :: FREE<a name='1479'>
      REAL                 :: BX,DENOM,DF,DSWL,FK,SWL,SWLK<a name='1480'>
      INTEGER              :: NLOG,KCOUNT<a name='1481'>
<font color=#447700>!      PARAMETER(CK = 0.0)<a name='1482'></font>
      REAL, PARAMETER      :: CK = 8.0, BLIM = 5.5, ERROR = 0.005,       &amp;<a name='1483'>
                              HLICE = 3.335E5, GS = 9.81,DICE = 920.0,   &amp;<a name='1484'>
                              DH2O = 1000.0, T0 = 273.15<a name='1485'>
<a name='1486'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1487'></font>
<font color=#447700>! LIMITS ON PARAMETER B: B &lt; 5.5  (use parameter BLIM)<a name='1488'></font>
<font color=#447700>! SIMULATIONS SHOWED IF B &gt; 5.5 UNFROZEN WATER CONTENT IS<a name='1489'></font>
<font color=#447700>! NON-REALISTICALLY HIGH AT VERY LOW TEMPERATURES.<a name='1490'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1491'></font>
      BX = BEXP<a name='1492'>
<a name='1493'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1494'></font>
<font color=#447700>! INITIALIZING ITERATIONS COUNTER AND ITERATIVE SOLUTION FLAG.<a name='1495'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1496'></font>
      IF (BEXP &gt;  BLIM) BX = BLIM<a name='1497'>
      NLOG = 0<a name='1498'>
<a name='1499'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1500'></font>
<font color=#447700>!  IF TEMPERATURE NOT SIGNIFICANTLY BELOW FREEZING (T0), SH2O = SMC<a name='1501'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1502'></font>
      KCOUNT = 0<a name='1503'>
<font color=#447700>!      FRH2O = SMC<a name='1504'></font>
      IF (TKELV &gt; (T0- 1.E-3)) THEN<a name='1505'>
          FREE = SMC<a name='1506'>
      ELSE<a name='1507'>
<a name='1508'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1509'></font>
<font color=#447700>! OPTION 1: ITERATED SOLUTION FOR NONZERO CK<a name='1510'></font>
<font color=#447700>! IN KOREN ET AL, JGR, 1999, EQN 17<a name='1511'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1512'></font>
<font color=#447700>! INITIAL GUESS FOR SWL (frozen content)<a name='1513'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1514'></font>
         IF (CK /= 0.0) THEN<a name='1515'>
            SWL = SMC - SH2O<a name='1516'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1517'></font>
<font color=#447700>! KEEP WITHIN BOUNDS.<a name='1518'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1519'></font>
            IF (SWL &gt; (SMC -0.02)) SWL = SMC -0.02<a name='1520'>
<a name='1521'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1522'></font>
<font color=#447700>!  START OF ITERATIONS<a name='1523'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1524'></font>
            IF (SWL &lt; 0.) SWL = 0.<a name='1525'>
 1001       Continue<a name='1526'>
              IF (.NOT.( (NLOG &lt; 10) .AND. (KCOUNT == 0)))   goto 1002<a name='1527'>
              NLOG = NLOG +1<a name='1528'>
              DF = ALOG ( ( PSIS * GS / HLICE ) * ( ( 1. + CK * SWL )**2.) * &amp;<a name='1529'>
                   ( SMCMAX / (SMC - SWL) )** BX) - ALOG ( - (               &amp;<a name='1530'>
                   TKELV - T0)/ TKELV)<a name='1531'>
              DENOM = 2. * CK / ( 1. + CK * SWL ) + BX / ( SMC - SWL )<a name='1532'>
              SWLK = SWL - DF / DENOM<a name='1533'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1534'></font>
<font color=#447700>! BOUNDS USEFUL FOR MATHEMATICAL SOLUTION.<a name='1535'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1536'></font>
              IF (SWLK &gt; (SMC -0.02)) SWLK = SMC - 0.02<a name='1537'>
              IF (SWLK &lt; 0.) SWLK = 0.<a name='1538'>
<a name='1539'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1540'></font>
<font color=#447700>! MATHEMATICAL SOLUTION BOUNDS APPLIED.<a name='1541'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1542'></font>
              DSWL = ABS (SWLK - SWL)<a name='1543'>
<a name='1544'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1545'></font>
<font color=#447700>! IF MORE THAN 10 ITERATIONS, USE EXPLICIT METHOD (CK=0 APPROX.)<a name='1546'></font>
<font color=#447700>! WHEN DSWL LESS OR EQ. ERROR, NO MORE ITERATIONS REQUIRED.<a name='1547'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1548'></font>
              SWL = SWLK<a name='1549'>
              IF ( DSWL &lt;= ERROR ) THEN<a name='1550'>
                    KCOUNT = KCOUNT +1<a name='1551'>
              END IF<a name='1552'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1553'></font>
<font color=#447700>!  END OF ITERATIONS<a name='1554'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1555'></font>
<font color=#447700>! BOUNDS APPLIED WITHIN DO-BLOCK ARE VALID FOR PHYSICAL SOLUTION.<a name='1556'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1557'></font>
<font color=#447700>!          FRH2O = SMC - SWL<a name='1558'></font>
           goto 1001<a name='1559'>
 1002   continue<a name='1560'>
           FREE = SMC - SWL<a name='1561'>
         END IF<a name='1562'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1563'></font>
<font color=#447700>! END OPTION 1<a name='1564'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1565'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1566'></font>
<font color=#447700>! OPTION 2: EXPLICIT SOLUTION FOR FLERCHINGER EQ. i.e. CK=0<a name='1567'></font>
<font color=#447700>! IN KOREN ET AL., JGR, 1999, EQN 17<a name='1568'></font>
<font color=#447700>! APPLY PHYSICAL BOUNDS TO FLERCHINGER SOLUTION<a name='1569'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1570'></font>
         IF (KCOUNT == 0) THEN<a name='1571'>
             PRINT *,'Flerchinger USEd in NEW version. Iterations=',NLOG<a name='1572'>
                  FK = ( ( (HLICE / (GS * ( - PSIS)))*                    &amp;<a name='1573'>
                       ( (TKELV - T0)/ TKELV))** ( -1/ BX))* SMCMAX<a name='1574'>
<font color=#447700>!            FRH2O = MIN (FK, SMC)<a name='1575'></font>
             IF (FK &lt; 0.02) FK = 0.02<a name='1576'>
             FREE = MIN (FK, SMC)<a name='1577'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1578'></font>
<font color=#447700>! END OPTION 2<a name='1579'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1580'></font>
         END IF<a name='1581'>
      END IF<a name='1582'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1583'></font>
  END SUBROUTINE FRH2O<a name='1584'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1585'></font>
<a name='1586'>
<A NAME='HRT'><A href='../../html_code/phys/module_sf_noahlsm.F.html#HRT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1587'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>HRT</font> (RHSTS,STC,SMC,SMCMAX,NSOIL,ZSOIL,YY,ZZ1,          &amp; <A href='../../call_to/HRT.html' TARGET='index'>3</A>,<A href='../../call_from/HRT.html' TARGET='index'>17</A><a name='1588'>
                       TBOT,ZBOT,PSISAT,SH2O,DT,BEXP,SOILTYP,OPT_THCND, &amp;<a name='1589'>
                       F1,DF1,QUARTZ,CSOIL,AI,BI,CI,VEGTYP,ISURBAN      &amp;<a name='1590'>
                      ,HCPCT_FASDAS                                     ) <font color=#447700>!fasdas<a name='1591'></font>
<a name='1592'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1593'></font>
<font color=#447700>! SUBROUTINE HRT<a name='1594'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1595'></font>
<font color=#447700>! CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY TERM OF THE SOIL<a name='1596'></font>
<font color=#447700>! THERMAL DIFFUSION EQUATION.  ALSO TO COMPUTE ( PREPARE ) THE MATRIX<a name='1597'></font>
<font color=#447700>! COEFFICIENTS FOR THE TRI-DIAGONAL MATRIX OF THE IMPLICIT TIME SCHEME.<a name='1598'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1599'></font>
      IMPLICIT NONE<a name='1600'>
      LOGICAL              :: ITAVG<a name='1601'>
      INTEGER, INTENT(IN)  :: OPT_THCND<a name='1602'>
      INTEGER, INTENT(IN)  :: NSOIL, VEGTYP, SOILTYP<a name='1603'>
      INTEGER, INTENT(IN)  :: ISURBAN<a name='1604'>
      INTEGER              :: I, K<a name='1605'>
<a name='1606'>
      REAL, INTENT(IN)     :: BEXP, CSOIL, DF1, DT,F1,PSISAT,QUARTZ,     &amp;<a name='1607'>
                              SMCMAX ,TBOT,YY,ZZ1, ZBOT<a name='1608'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: SMC,STC,ZSOIL<a name='1609'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT):: SH2O<a name='1610'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT)  :: RHSTS<a name='1611'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT)  :: AI, BI,CI<a name='1612'>
      REAL                 :: DDZ, DDZ2, DENOM, DF1N, DF1K, DTSDZ,       &amp;<a name='1613'>
                              DTSDZ2,HCPCT,QTOT,SSOIL,SICE,TAVG,TBK,     &amp;<a name='1614'>
                              TBK1,TSNSR,TSURF,CSOIL_LOC<a name='1615'>
      REAL, PARAMETER      :: T0 = 273.15, CAIR = 1004.0, CICE = 2.106E6,&amp;<a name='1616'>
                              CH2O = 4.2E6<a name='1617'>
<a name='1618'>
<font color=#447700>!<a name='1619'></font>
<font color=#447700>! FASDAS<a name='1620'></font>
<font color=#447700>!<a name='1621'></font>
      REAL, INTENT(  OUT)       :: HCPCT_FASDAS<a name='1622'>
<font color=#447700>!<a name='1623'></font>
<font color=#447700>! END FASDAS<a name='1624'></font>
<font color=#447700>!<a name='1625'></font>
<a name='1626'>
<font color=#447700>!urban<a name='1627'></font>
        IF( VEGTYP == ISURBAN ) then<a name='1628'>
            CSOIL_LOC=3.0E6<a name='1629'>
        ELSE<a name='1630'>
            CSOIL_LOC=CSOIL<a name='1631'>
        ENDIF<a name='1632'>
<a name='1633'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1634'></font>
<font color=#447700>! INITIALIZE LOGICAL FOR SOIL LAYER TEMPERATURE AVERAGING.<a name='1635'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1636'></font>
       ITAVG = .TRUE.<a name='1637'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1638'></font>
<font color=#447700>! BEGIN SECTION FOR TOP SOIL LAYER<a name='1639'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1640'></font>
<font color=#447700>! CALC THE HEAT CAPACITY OF THE TOP SOIL LAYER<a name='1641'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1642'></font>
      HCPCT = SH2O (1)* CH2O + (1.0- SMCMAX)* CSOIL_LOC + (SMCMAX - SMC (1))&amp;<a name='1643'>
       * CAIR                                                           &amp;<a name='1644'>
              + ( SMC (1) - SH2O (1) )* CICE<a name='1645'>
<font color=#447700>!<a name='1646'></font>
<font color=#447700>! FASDAS<a name='1647'></font>
<font color=#447700>!<a name='1648'></font>
      HCPCT_FASDAS = HCPCT<a name='1649'>
<font color=#447700>!<a name='1650'></font>
<font color=#447700>! END FASDAS<a name='1651'></font>
<font color=#447700>!<a name='1652'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1653'></font>
<font color=#447700>! CALC THE MATRIX COEFFICIENTS AI, BI, AND CI FOR THE TOP LAYER<a name='1654'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1655'></font>
      DDZ = 1.0 / ( -0.5 * ZSOIL (2) )<a name='1656'>
      AI (1) = 0.0<a name='1657'>
      CI (1) = (DF1 * DDZ) / (ZSOIL (1) * HCPCT)<a name='1658'>
<a name='1659'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1660'></font>
<font color=#447700>! CALCULATE THE VERTICAL SOIL TEMP GRADIENT BTWN THE 1ST AND 2ND SOIL<a name='1661'></font>
<font color=#447700>! LAYERS.  THEN CALCULATE THE SUBSURFACE HEAT FLUX. USE THE TEMP<a name='1662'></font>
<font color=#447700>! GRADIENT AND SUBSFC HEAT FLUX TO CALC "RIGHT-HAND SIDE TENDENCY<a name='1663'></font>
<font color=#447700>! TERMS", OR "RHSTS", FOR TOP SOIL LAYER.<a name='1664'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1665'></font>
      BI (1) = - CI (1) + DF1 / (0.5 * ZSOIL (1) * ZSOIL (1)* HCPCT *    &amp;<a name='1666'>
       ZZ1)<a name='1667'>
      DTSDZ = (STC (1) - STC (2)) / ( -0.5 * ZSOIL (2))<a name='1668'>
      SSOIL = DF1 * (STC (1) - YY) / (0.5 * ZSOIL (1) * ZZ1)<a name='1669'>
<font color=#447700>!      RHSTS(1) = (DF1 * DTSDZ - SSOIL) / (ZSOIL(1) * HCPCT)<a name='1670'></font>
      DENOM = (ZSOIL (1) * HCPCT)<a name='1671'>
<a name='1672'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1673'></font>
<font color=#447700>! NEXT CAPTURE THE VERTICAL DIFFERENCE OF THE HEAT FLUX AT TOP AND<a name='1674'></font>
<font color=#447700>! BOTTOM OF FIRST SOIL LAYER FOR USE IN HEAT FLUX CONSTRAINT APPLIED TO<a name='1675'></font>
<font color=#447700>! POTENTIAL SOIL FREEZING/THAWING IN ROUTINE SNKSRC.<a name='1676'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1677'></font>
<font color=#447700>!      QTOT = SSOIL - DF1*DTSDZ<a name='1678'></font>
      RHSTS (1) = (DF1 * DTSDZ - SSOIL) / DENOM<a name='1679'>
<a name='1680'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1681'></font>
<font color=#447700>! CALCULATE FROZEN WATER CONTENT IN 1ST SOIL LAYER.<a name='1682'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1683'></font>
      QTOT = -1.0* RHSTS (1)* DENOM<a name='1684'>
<a name='1685'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1686'></font>
<font color=#447700>! IF TEMPERATURE AVERAGING INVOKED (ITAVG=TRUE; ELSE SKIP):<a name='1687'></font>
<font color=#447700>! SET TEMP "TSURF" AT TOP OF SOIL COLUMN (FOR USE IN FREEZING SOIL<a name='1688'></font>
<font color=#447700>! PHYSICS LATER IN FUNCTION SUBROUTINE SNKSRC).  IF SNOWPACK CONTENT IS<a name='1689'></font>
<font color=#447700>! ZERO, THEN TSURF EXPRESSION BELOW GIVES TSURF = SKIN TEMP.  IF<a name='1690'></font>
<font color=#447700>! SNOWPACK IS NONZERO (HENCE ARGUMENT ZZ1=1), THEN TSURF EXPRESSION<a name='1691'></font>
<font color=#447700>! BELOW YIELDS SOIL COLUMN TOP TEMPERATURE UNDER SNOWPACK.  THEN<a name='1692'></font>
<font color=#447700>! CALCULATE TEMPERATURE AT BOTTOM INTERFACE OF 1ST SOIL LAYER FOR USE<a name='1693'></font>
<font color=#447700>! LATER IN FUNCTION SUBROUTINE SNKSRC<a name='1694'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1695'></font>
      SICE = SMC (1) - SH2O (1)<a name='1696'>
      IF (ITAVG) THEN<a name='1697'>
         TSURF = (YY + (ZZ1-1) * STC (1)) / ZZ1<a name='1698'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1699'></font>
<font color=#447700>! IF FROZEN WATER PRESENT OR ANY OF LAYER-1 MID-POINT OR BOUNDING<a name='1700'></font>
<font color=#447700>! INTERFACE TEMPERATURES BELOW FREEZING, THEN CALL SNKSRC TO<a name='1701'></font>
<font color=#447700>! COMPUTE HEAT SOURCE/SINK (AND CHANGE IN FROZEN WATER CONTENT)<a name='1702'></font>
<font color=#447700>! DUE TO POSSIBLE SOIL WATER PHASE CHANGE<a name='1703'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1704'></font>
         CALL <A href='../../html_code/phys/module_sf_urban.F.html#TBND'>TBND</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TBND_1"> (STC (1),STC (2),ZSOIL,ZBOT,1,NSOIL,TBK)<a name='1705'>
         IF ( (SICE &gt; 0.) .OR. (STC (1) &lt; T0) .OR.                         &amp;<a name='1706'>
            (TSURF &lt; T0) .OR. (TBK &lt; T0) ) THEN<a name='1707'>
<font color=#447700>!          TSNSR = SNKSRC (TAVG,SMC(1),SH2O(1),<a name='1708'></font>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TMPAVG'>TMPAVG</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TMPAVG_1"> (TAVG,TSURF,STC (1),TBK,ZSOIL,NSOIL,1)<a name='1709'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SNKSRC'>SNKSRC</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNKSRC_1"> (TSNSR,TAVG,SMC (1),SH2O (1),                      &amp;<a name='1710'>
                          ZSOIL,NSOIL,SMCMAX,PSISAT,BEXP,DT,1,QTOT)<a name='1711'>
<font color=#447700>!          RHSTS(1) = RHSTS(1) - TSNSR / ( ZSOIL(1) * HCPCT )<a name='1712'></font>
            RHSTS (1) = RHSTS (1) - TSNSR / DENOM<a name='1713'>
         END IF<a name='1714'>
      ELSE<a name='1715'>
<font color=#447700>!          TSNSR = SNKSRC (STC(1),SMC(1),SH2O(1),<a name='1716'></font>
         IF ( (SICE &gt; 0.) .OR. (STC (1) &lt; T0) ) THEN<a name='1717'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SNKSRC'>SNKSRC</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNKSRC_2"> (TSNSR,STC (1),SMC (1),SH2O (1),                   &amp;<a name='1718'>
                          ZSOIL,NSOIL,SMCMAX,PSISAT,BEXP,DT,1,QTOT)<a name='1719'>
<font color=#447700>!          RHSTS(1) = RHSTS(1) - TSNSR / ( ZSOIL(1) * HCPCT )<a name='1720'></font>
            RHSTS (1) = RHSTS (1) - TSNSR / DENOM<a name='1721'>
         END IF<a name='1722'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1723'></font>
<font color=#447700>! THIS ENDS SECTION FOR TOP SOIL LAYER.<a name='1724'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1725'></font>
      END IF<a name='1726'>
<a name='1727'>
<font color=#447700>! INITIALIZE DDZ2<a name='1728'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1729'></font>
<a name='1730'>
      DDZ2 = 0.0<a name='1731'>
      DF1K = DF1<a name='1732'>
<a name='1733'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1734'></font>
<font color=#447700>! LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABOVE PROCESS<a name='1735'></font>
<font color=#447700>! (EXCEPT SUBSFC OR "GROUND" HEAT FLUX NOT REPEATED IN LOWER LAYERS)<a name='1736'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1737'></font>
<font color=#447700>! CALCULATE HEAT CAPACITY FOR THIS SOIL LAYER.<a name='1738'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1739'></font>
      DO K = 2,NSOIL<a name='1740'>
         HCPCT = SH2O (K)* CH2O + (1.0- SMCMAX)* CSOIL_LOC + (SMCMAX - SMC (  &amp;<a name='1741'>
                K))* CAIR + ( SMC (K) - SH2O (K) )* CICE<a name='1742'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1743'></font>
<font color=#447700>! THIS SECTION FOR LAYER 2 OR GREATER, BUT NOT LAST LAYER.<a name='1744'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1745'></font>
<font color=#447700>! CALCULATE THERMAL DIFFUSIVITY FOR THIS LAYER.<a name='1746'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1747'></font>
         IF (K /= NSOIL) THEN<a name='1748'>
<a name='1749'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1750'></font>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT THRU THIS LAYER<a name='1751'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1752'></font>
            CALL <A href='../../html_code/phys/module_sf_urban.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_2"> (DF1N,SMC (K),QUARTZ,SMCMAX,SH2O (K),BEXP, PSISAT, SOILTYP, OPT_THCND)<a name='1753'>
<a name='1754'>
<font color=#447700>!urban<a name='1755'></font>
       IF ( VEGTYP == ISURBAN ) DF1N = 3.24<a name='1756'>
<a name='1757'>
            DENOM = 0.5 * ( ZSOIL (K -1) - ZSOIL (K +1) )<a name='1758'>
<a name='1759'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1760'></font>
<font color=#447700>! CALC THE MATRIX COEF, CI, AFTER CALC'NG ITS PARTIAL PRODUCT<a name='1761'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1762'></font>
            DTSDZ2 = ( STC (K) - STC (K +1) ) / DENOM<a name='1763'>
            DDZ2 = 2. / (ZSOIL (K -1) - ZSOIL (K +1))<a name='1764'>
<a name='1765'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1766'></font>
<font color=#447700>! IF TEMPERATURE AVERAGING INVOKED (ITAVG=TRUE; ELSE SKIP):  CALCULATE<a name='1767'></font>
<font color=#447700>! TEMP AT BOTTOM OF LAYER.<a name='1768'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1769'></font>
            CI (K) = - DF1N * DDZ2 / ( (ZSOIL (K -1) - ZSOIL (K)) *      &amp;<a name='1770'>
       HCPCT)<a name='1771'>
            IF (ITAVG) THEN<a name='1772'>
               CALL <A href='../../html_code/phys/module_sf_urban.F.html#TBND'>TBND</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TBND_2"> (STC (K),STC (K +1),ZSOIL,ZBOT,K,NSOIL,TBK1)<a name='1773'>
            END IF<a name='1774'>
<a name='1775'>
         ELSE<a name='1776'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1777'></font>
<font color=#447700>! SPECIAL CASE OF BOTTOM SOIL LAYER:  CALCULATE THERMAL DIFFUSIVITY FOR<a name='1778'></font>
<font color=#447700>! BOTTOM LAYER.<a name='1779'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1780'></font>
<a name='1781'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1782'></font>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT THRU BOTTOM LAYER.<a name='1783'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1784'></font>
            CALL <A href='../../html_code/phys/module_sf_urban.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_3"> (DF1N,SMC (K),QUARTZ,SMCMAX,SH2O (K),BEXP, PSISAT, SOILTYP, OPT_THCND)<a name='1785'>
<a name='1786'>
<a name='1787'>
<font color=#447700>!urban<a name='1788'></font>
       IF ( VEGTYP == ISURBAN ) DF1N = 3.24<a name='1789'>
<a name='1790'>
            DENOM = .5 * (ZSOIL (K -1) + ZSOIL (K)) - ZBOT<a name='1791'>
<a name='1792'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1793'></font>
<font color=#447700>! SET MATRIX COEF, CI TO ZERO IF BOTTOM LAYER.<a name='1794'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1795'></font>
            DTSDZ2 = (STC (K) - TBOT) / DENOM<a name='1796'>
<a name='1797'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1798'></font>
<font color=#447700>! IF TEMPERATURE AVERAGING INVOKED (ITAVG=TRUE; ELSE SKIP):  CALCULATE<a name='1799'></font>
<font color=#447700>! TEMP AT BOTTOM OF LAST LAYER.<a name='1800'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1801'></font>
            CI (K) = 0.<a name='1802'>
            IF (ITAVG) THEN<a name='1803'>
               CALL <A href='../../html_code/phys/module_sf_urban.F.html#TBND'>TBND</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TBND_3"> (STC (K),TBOT,ZSOIL,ZBOT,K,NSOIL,TBK1)<a name='1804'>
            END IF<a name='1805'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1806'></font>
<font color=#447700>! THIS ENDS SPECIAL LOOP FOR BOTTOM LAYER.<a name='1807'></font>
         END IF<a name='1808'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1809'></font>
<font color=#447700>! CALCULATE RHSTS FOR THIS LAYER AFTER CALC'NG A PARTIAL PRODUCT.<a name='1810'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1811'></font>
         DENOM = ( ZSOIL (K) - ZSOIL (K -1) ) * HCPCT<a name='1812'>
         RHSTS (K) = ( DF1N * DTSDZ2- DF1K * DTSDZ ) / DENOM<a name='1813'>
         QTOT = -1.0* DENOM * RHSTS (K)<a name='1814'>
<a name='1815'>
         SICE = SMC (K) - SH2O (K)<a name='1816'>
         IF (ITAVG) THEN<a name='1817'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#TMPAVG'>TMPAVG</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TMPAVG_2"> (TAVG,TBK,STC (K),TBK1,ZSOIL,NSOIL,K)<a name='1818'>
<font color=#447700>!            TSNSR = SNKSRC(TAVG,SMC(K),SH2O(K),ZSOIL,NSOIL,<a name='1819'></font>
            IF ( (SICE &gt; 0.) .OR. (STC (K) &lt; T0) .OR.                   &amp;<a name='1820'>
               (TBK .lt. T0) .OR. (TBK1 .lt. T0) ) THEN<a name='1821'>
               CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SNKSRC'>SNKSRC</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNKSRC_3"> (TSNSR,TAVG,SMC (K),SH2O (K),ZSOIL,NSOIL,    &amp;<a name='1822'>
                             SMCMAX,PSISAT,BEXP,DT,K,QTOT)<a name='1823'>
               RHSTS (K) = RHSTS (K) - TSNSR / DENOM<a name='1824'>
            END IF<a name='1825'>
         ELSE<a name='1826'>
<font color=#447700>!            TSNSR = SNKSRC(STC(K),SMC(K),SH2O(K),ZSOIL,NSOIL,<a name='1827'></font>
            IF ( (SICE &gt; 0.) .OR. (STC (K) &lt; T0) ) THEN<a name='1828'>
               CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SNKSRC'>SNKSRC</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNKSRC_4"> (TSNSR,STC (K),SMC (K),SH2O (K),ZSOIL,NSOIL, &amp;<a name='1829'>
                             SMCMAX,PSISAT,BEXP,DT,K,QTOT)<a name='1830'>
               RHSTS (K) = RHSTS (K) - TSNSR / DENOM<a name='1831'>
            END IF<a name='1832'>
         END IF<a name='1833'>
<a name='1834'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1835'></font>
<font color=#447700>! CALC MATRIX COEFS, AI, AND BI FOR THIS LAYER.<a name='1836'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1837'></font>
         AI (K) = - DF1K * DDZ / ( (ZSOIL (K -1) - ZSOIL (K)) * HCPCT)<a name='1838'>
<a name='1839'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1840'></font>
<font color=#447700>! RESET VALUES OF DF1, DTSDZ, DDZ, AND TBK FOR LOOP TO NEXT SOIL LAYER.<a name='1841'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1842'></font>
         BI (K) = - (AI (K) + CI (K))<a name='1843'>
         TBK = TBK1<a name='1844'>
         DF1K = DF1N<a name='1845'>
         DTSDZ = DTSDZ2<a name='1846'>
         DDZ = DDZ2<a name='1847'>
      END DO<a name='1848'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1849'></font>
  END SUBROUTINE HRT<a name='1850'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1851'></font>
<a name='1852'>
<A NAME='HSTEP'><A href='../../html_code/phys/module_sf_noahlsm.F.html#HSTEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1853'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>HSTEP</font> (STCOUT,STCIN,RHSTS,DT,NSOIL,AI,BI,CI) <A href='../../call_to/HSTEP.html' TARGET='index'>5</A>,<A href='../../call_from/HSTEP.html' TARGET='index'>4</A><a name='1854'>
<a name='1855'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1856'></font>
<font color=#447700>! SUBROUTINE HSTEP<a name='1857'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1858'></font>
<font color=#447700>! CALCULATE/UPDATE THE SOIL TEMPERATURE FIELD.<a name='1859'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1860'></font>
      IMPLICIT NONE<a name='1861'>
      INTEGER, INTENT(IN)  :: NSOIL<a name='1862'>
      INTEGER              :: K<a name='1863'>
<a name='1864'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN):: STCIN<a name='1865'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT):: STCOUT<a name='1866'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT):: RHSTS<a name='1867'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT):: AI,BI,CI<a name='1868'>
      REAL, DIMENSION(1:NSOIL) :: RHSTSin<a name='1869'>
      REAL, DIMENSION(1:NSOIL) :: CIin<a name='1870'>
      REAL                 :: DT<a name='1871'>
<a name='1872'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1873'></font>
<font color=#447700>! CREATE FINITE DIFFERENCE VALUES FOR USE IN ROSR12 ROUTINE<a name='1874'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1875'></font>
      DO K = 1,NSOIL<a name='1876'>
         RHSTS (K) = RHSTS (K) * DT<a name='1877'>
         AI (K) = AI (K) * DT<a name='1878'>
         BI (K) = 1. + BI (K) * DT<a name='1879'>
         CI (K) = CI (K) * DT<a name='1880'>
      END DO<a name='1881'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1882'></font>
<font color=#447700>! COPY VALUES FOR INPUT VARIABLES BEFORE CALL TO ROSR12<a name='1883'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1884'></font>
      DO K = 1,NSOIL<a name='1885'>
         RHSTSin (K) = RHSTS (K)<a name='1886'>
      END DO<a name='1887'>
      DO K = 1,NSOIL<a name='1888'>
         CIin (K) = CI (K)<a name='1889'>
      END DO<a name='1890'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1891'></font>
<font color=#447700>! SOLVE THE TRI-DIAGONAL MATRIX EQUATION<a name='1892'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1893'></font>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#ROSR12'>ROSR12</A><A href='../../html_code/phys/module_sf_urban.F.html#HSTEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROSR12_1"> (CI,AI,BI,CIin,RHSTSin,RHSTS,NSOIL)<a name='1894'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1895'></font>
<font color=#447700>! CALC/UPDATE THE SOIL TEMPS USING MATRIX SOLUTION<a name='1896'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1897'></font>
      DO K = 1,NSOIL<a name='1898'>
         STCOUT (K) = STCIN (K) + CI (K)<a name='1899'>
      END DO<a name='1900'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1901'></font>
  END SUBROUTINE HSTEP<a name='1902'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1903'></font>
<a name='1904'>
<A NAME='NOPAC'><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1905'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>NOPAC</font> (ETP,ETA,PRCP,SMC,SMCMAX,SMCWLT,                 &amp; <A href='../../call_to/NOPAC.html' TARGET='index'>1</A>,<A href='../../call_from/NOPAC.html' TARGET='index'>5</A><a name='1906'>
                         SMCREF,SMCDRY,CMC,CMCMAX,NSOIL,DT,SHDFAC,      &amp;<a name='1907'>
                         SBETA,Q2,T1,SFCTMP,T24,TH2,FDOWN,F1,EMISSI,    &amp;<a name='1908'>
                         SSOIL,                                         &amp;<a name='1909'>
                         STC,EPSCA,BEXP,PC,RCH,RR,CFACTR,               &amp;<a name='1910'>
                         SH2O,SLOPE,KDT,FRZFACT,PSISAT,ZSOIL,           &amp;<a name='1911'>
                         DKSAT,DWSAT,TBOT,ZBOT,RUNOFF1,RUNOFF2,         &amp;<a name='1912'>
                         RUNOFF3,EDIR,EC,ET,ETT,NROOT,RTDIS,            &amp;<a name='1913'>
                         QUARTZ,FXEXP,CSOIL,                            &amp;<a name='1914'>
                         BETA,DRIP,DEW,FLX1,FLX3,VEGTYP,ISURBAN,        &amp;<a name='1915'>
                         SFHEAD1RT,INFXS1RT,ETPND1,SOILTYP,OPT_THCND    &amp;<a name='1916'>
                        ,XSDA_QFX,QFX_PHY,XQNORM,fasdas,HCPCT_FASDAS    ) <font color=#447700>!fasdas<a name='1917'></font>
<a name='1918'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1919'></font>
<font color=#447700>! SUBROUTINE NOPAC<a name='1920'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1921'></font>
<font color=#447700>! CALCULATE SOIL MOISTURE AND HEAT FLUX VALUES AND UPDATE SOIL MOISTURE<a name='1922'></font>
<font color=#447700>! CONTENT AND SOIL HEAT CONTENT VALUES FOR THE CASE WHEN NO SNOW PACK IS<a name='1923'></font>
<font color=#447700>! PRESENT.<a name='1924'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1925'></font>
      IMPLICIT NONE<a name='1926'>
<a name='1927'>
      INTEGER, INTENT(IN)  :: OPT_THCND<a name='1928'>
      INTEGER, INTENT(IN)  :: NROOT,NSOIL,VEGTYP,SOILTYP<a name='1929'>
      INTEGER, INTENT(IN)  :: ISURBAN<a name='1930'>
      INTEGER              :: K<a name='1931'>
<a name='1932'>
      REAL, INTENT(IN)     :: BEXP,CFACTR, CMCMAX,CSOIL,DKSAT,DT,DWSAT, &amp;<a name='1933'>
                              EPSCA,ETP,FDOWN,F1,FXEXP,FRZFACT,KDT,PC,  &amp;<a name='1934'>
                              PRCP,PSISAT,Q2,QUARTZ,RCH,RR,SBETA,SFCTMP,&amp;<a name='1935'>
                              SHDFAC,SLOPE,SMCDRY,SMCMAX,SMCREF,SMCWLT, &amp;<a name='1936'>
                              T24,TBOT,TH2,ZBOT,EMISSI<a name='1937'>
      REAL, INTENT(INOUT)  :: CMC,BETA,T1<a name='1938'>
      REAL, INTENT(OUT)    :: DEW,DRIP,EC,EDIR,ETA,ETT,FLX1,FLX3,       &amp;<a name='1939'>
                              RUNOFF1,RUNOFF2,RUNOFF3,SSOIL<a name='1940'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edit...<a name='1941'></font>
      REAL, INTENT(INOUT)  :: SFHEAD1RT,INFXS1RT,ETPND1<a name='1942'>
<a name='1943'>
      REAL, DIMENSION(1:NSOIL),INTENT(IN)     :: RTDIS,ZSOIL<a name='1944'>
      REAL, DIMENSION(1:NSOIL),INTENT(OUT)    :: ET<a name='1945'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: SMC,SH2O,STC<a name='1946'>
      REAL, DIMENSION(1:NSOIL) :: ET1<a name='1947'>
      REAL                 :: EC1,EDIR1,ETT1,DF1,ETA1,ETP1,PRCP1,YY,    &amp;<a name='1948'>
                              YYNUM,ZZ1<a name='1949'>
<font color=#447700>!<a name='1950'></font>
<font color=#447700>! FASDAS<a name='1951'></font>
<font color=#447700>!<a name='1952'></font>
      REAL                       ::  XSDA_QFX, QFX_PHY, XQNORM<a name='1953'>
      INTEGER                    ::  fasdas<a name='1954'>
      REAL , DIMENSION(1:NSOIL)  ::  EFT(NSOIL), wetty(1:NSOIL)<a name='1955'>
      REAL                       ::  EFDIR, EFC, EALL_now<a name='1956'>
      REAL, INTENT(  OUT)        ::  HCPCT_FASDAS<a name='1957'>
<font color=#447700>!<a name='1958'></font>
<font color=#447700>! END FASDAS<a name='1959'></font>
<font color=#447700>!<a name='1960'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1961'></font>
<font color=#447700>! EXECUTABLE CODE BEGINS HERE:<a name='1962'></font>
<font color=#447700>! CONVERT ETP Fnd PRCP FROM KG M-2 S-1 TO M S-1 AND INITIALIZE DEW.<a name='1963'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1964'></font>
      PRCP1 = PRCP * 0.001<a name='1965'>
      ETP1 = ETP * 0.001<a name='1966'>
      DEW = 0.0<a name='1967'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1968'></font>
<font color=#447700>! INITIALIZE EVAP TERMS.<a name='1969'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1970'></font>
<font color=#447700>!<a name='1971'></font>
<font color=#447700>! FASDAS<a name='1972'></font>
<font color=#447700>!<a name='1973'></font>
      QFX_PHY = 0.0<a name='1974'>
<font color=#447700>!<a name='1975'></font>
<font color=#447700>! END FASDAS<a name='1976'></font>
<font color=#447700>!<a name='1977'></font>
      EDIR = 0.<a name='1978'>
      EDIR1 = 0.<a name='1979'>
      EC1 = 0.<a name='1980'>
      EC = 0.<a name='1981'>
      DO K = 1,NSOIL<a name='1982'>
        ET(K) = 0.<a name='1983'>
        ET1(K) = 0.<a name='1984'>
<font color=#447700>!<a name='1985'></font>
<font color=#447700>! FASDAS<a name='1986'></font>
<font color=#447700>!<a name='1987'></font>
        wetty(K) = 1.0<a name='1988'>
<font color=#447700>!<a name='1989'></font>
<font color=#447700>! END FASDAS<a name='1990'></font>
<font color=#447700>!<a name='1991'></font>
      END DO<a name='1992'>
      ETT = 0.<a name='1993'>
      ETT1 = 0.<a name='1994'>
<a name='1995'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edit...<a name='1996'></font>
      ETPND1 = 0.<a name='1997'>
<a name='1998'>
<a name='1999'>
      IF (ETP &gt; 0.0) THEN<a name='2000'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#EVAPO'>EVAPO</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EVAPO_1"> (ETA1,SMC,NSOIL,CMC,ETP1,DT,ZSOIL,                  &amp;<a name='2001'>
                      SH2O,                                             &amp;<a name='2002'>
                      SMCMAX,BEXP,PC,SMCWLT,DKSAT,DWSAT,                &amp;<a name='2003'>
                      SMCREF,SHDFAC,CMCMAX,                             &amp;<a name='2004'>
                      SMCDRY,CFACTR,                                    &amp;<a name='2005'>
                       EDIR1,EC1,ET1,ETT1,SFCTMP,Q2,NROOT,RTDIS,FXEXP,  &amp;<a name='2006'>
                      SFHEAD1RT,ETPND1 )<a name='2007'>
<font color=#447700>!<a name='2008'></font>
<font color=#447700>! FASDAS<a name='2009'></font>
<font color=#447700>!<a name='2010'></font>
      IF( fasdas == 1 ) THEN<a name='2011'>
        DO K=1,NSOIL<a name='2012'>
        QFX_PHY = QFX_PHY + ET1(K)   <font color=#447700>! m/s<a name='2013'></font>
<font color=#447700>! dont add moisture fluxes if soil moisture is = or &gt; smcref<a name='2014'></font>
        IF(SMC(K).GE.SMCREF.and.XSDA_QFX.gt.0.0) wetty(K)=0.0<a name='2015'>
        END DO<a name='2016'>
       QFX_PHY = EDIR1+EC1+QFX_PHY    <font color=#447700>! m/s<a name='2017'></font>
       EALL_now = QFX_PHY           <font color=#447700>! m/s<a name='2018'></font>
       QFX_PHY = QFX_PHY*1000.0     <font color=#447700>! Kg/m2/s<a name='2019'></font>
<a name='2020'>
       if(EALL_now.ne.0.0) then<a name='2021'>
       EFDIR = (EDIR1/EALL_now)*XSDA_QFX*1.0E-03*XQNORM<a name='2022'>
       EFDIR = EFDIR * wetty(1)<a name='2023'>
          <font color=#447700>!TWG2015 Bugfix Flip Sign to conform to Net upward Flux<a name='2024'></font>
           EDIR1 = EDIR1 + EFDIR    <font color=#447700>! new value<a name='2025'></font>
       <a name='2026'>
       EFC = (EC1/EALL_now)*XSDA_QFX*1.0E-03*XQNORM<a name='2027'>
       <font color=#447700>!TWG2015 Bugfix Flip Sign to conform to Net upward Flux<a name='2028'></font>
       EC1 = EC1 + EFC         <font color=#447700>! new value<a name='2029'></font>
<a name='2030'>
<a name='2031'>
       DO K=1,NSOIL<a name='2032'>
        EFT(K) = (ET1(K)/EALL_now)*XSDA_QFX*1.0E-03*XQNORM<a name='2033'>
        EFT(K) =  EFT(K) * wetty(K)<a name='2034'>
        <font color=#447700>!TWG2015 Bugfix Flip Sign to conform to Net upward Flux<a name='2035'></font>
        ET1(K) = ET1(K) + EFT(K) <font color=#447700>! new value<a name='2036'></font>
       END DO<a name='2037'>
<a name='2038'>
<a name='2039'>
       END IF <font color=#447700>! for non-zero eall_now<a name='2040'></font>
      ELSE<a name='2041'>
        QFX_PHY = 0.0<a name='2042'>
      ENDIF<a name='2043'>
<font color=#447700>!<a name='2044'></font>
<font color=#447700>! END FASDAS<a name='2045'></font>
<font color=#447700>!<a name='2046'></font>
         CALL <A href='../../html_code/phys/module_sf_urban.F.html#SMFLX'>SMFLX</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMFLX_1"> (SMC,NSOIL,CMC,DT,PRCP1,ZSOIL,                      &amp;<a name='2047'>
                      SH2O,SLOPE,KDT,FRZFACT,                           &amp;<a name='2048'>
                      SMCMAX,BEXP,SMCWLT,DKSAT,DWSAT,                   &amp;<a name='2049'>
                      SHDFAC,CMCMAX,                                    &amp;<a name='2050'>
                      RUNOFF1,RUNOFF2,RUNOFF3,                          &amp;<a name='2051'>
                      EDIR1,EC1,ET1,                                    &amp;<a name='2052'>
                      DRIP, SFHEAD1RT,INFXS1RT)<a name='2053'>
<a name='2054'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2055'></font>
<font color=#447700>! CONVERT MODELED EVAPOTRANSPIRATION FROM  M S-1  TO  KG M-2 S-1.<a name='2056'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2057'></font>
<a name='2058'>
         ETA = ETA1 * 1000.0<a name='2059'>
<a name='2060'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2061'></font>
<font color=#447700>! IF ETP &lt; 0, ASSUME DEW FORMS (TRANSFORM ETP1 INTO DEW AND REINITIALIZE<a name='2062'></font>
<font color=#447700>! ETP1 TO ZERO).<a name='2063'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2064'></font>
      ELSE<a name='2065'>
         DEW = - ETP1<a name='2066'>
<a name='2067'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2068'></font>
<font color=#447700>! CONVERT PRCP FROM 'KG M-2 S-1' TO 'M S-1' AND ADD DEW AMOUNT.<a name='2069'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2070'></font>
<a name='2071'>
         PRCP1 = PRCP1+ DEW<a name='2072'>
<font color=#447700>!<a name='2073'></font>
<font color=#447700>! FASDAS<a name='2074'></font>
<font color=#447700>!<a name='2075'></font>
     IF( fasdas == 1 ) THEN<a name='2076'>
       DO K=1,NSOIL<a name='2077'>
        QFX_PHY = QFX_PHY + ET1(K)   <font color=#447700>! m/s<a name='2078'></font>
<font color=#447700>! dont add moisture fluxes if soil moisture is = or &gt; smcref<a name='2079'></font>
        IF(SMC(K).GE.SMCREF.and.XSDA_QFX.gt.0.0) wetty(K)=0.0<a name='2080'>
       END DO<a name='2081'>
       QFX_PHY = EDIR1+EC1+QFX_PHY    <font color=#447700>! m/s<a name='2082'></font>
        EALL_now = QFX_PHY     <font color=#447700>! m/s<a name='2083'></font>
       QFX_PHY = QFX_PHY*1000.0    <font color=#447700>! Kg/m2/s<a name='2084'></font>
<a name='2085'>
       IF(EALL_now.ne.0.0) then<a name='2086'>
       EFDIR = (EDIR1/EALL_now)*XSDA_QFX*1.0E-03*XQNORM<a name='2087'>
        EFDIR =  EFDIR * wetty(1)<a name='2088'>
          <font color=#447700>!TWG2015 Bugfix Flip Sign to conform to Net Upward Flux<a name='2089'></font>
           EDIR1 = EDIR1 + EFDIR    <font color=#447700>! new value<a name='2090'></font>
<a name='2091'>
        EFC = (EC1/EALL_now)*XSDA_QFX*1.0E-03*XQNORM<a name='2092'>
        <font color=#447700>!TWG2015 Bugfix Flip Sign to conform to Net Upward Flux<a name='2093'></font>
        EC1 = EC1+ EFC         <font color=#447700>! new value<a name='2094'></font>
<a name='2095'>
       DO K=1,NSOIL<a name='2096'>
        EFT(K) = (ET1(K)/EALL_now)*XSDA_QFX*1.0E-03*XQNORM<a name='2097'>
        EFT(K) = EFT(K) * wetty(K)<a name='2098'>
        <font color=#447700>!TWG2015 Bugfix Flip Sign to conform to Net Upward Flux<a name='2099'></font>
        ET1(K) = ET1(K) + EFT(K)   <font color=#447700>! new value<a name='2100'></font>
       END DO<a name='2101'>
<a name='2102'>
        END IF <font color=#447700>! for non-zero eall_now<a name='2103'></font>
      ELSE<a name='2104'>
        QFX_PHY = 0.0<a name='2105'>
      ENDIF<a name='2106'>
<font color=#447700>!<a name='2107'></font>
<font color=#447700>! END FASDAS<a name='2108'></font>
<font color=#447700>!<a name='2109'></font>
         CALL <A href='../../html_code/phys/module_sf_urban.F.html#SMFLX'>SMFLX</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMFLX_2"> (SMC,NSOIL,CMC,DT,PRCP1,ZSOIL,                      &amp;<a name='2110'>
                      SH2O,SLOPE,KDT,FRZFACT,                           &amp;<a name='2111'>
                      SMCMAX,BEXP,SMCWLT,DKSAT,DWSAT,                   &amp;<a name='2112'>
                      SHDFAC,CMCMAX,                                    &amp;<a name='2113'>
                      RUNOFF1,RUNOFF2,RUNOFF3,                          &amp;<a name='2114'>
                      EDIR1,EC1,ET1,                                    &amp;<a name='2115'>
                      DRIP, SFHEAD1RT,INFXS1RT)<a name='2116'>
<a name='2117'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2118'></font>
<font color=#447700>! CONVERT MODELED EVAPOTRANSPIRATION FROM 'M S-1' TO 'KG M-2 S-1'.<a name='2119'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2120'></font>
<font color=#447700>!         ETA = ETA1 * 1000.0<a name='2121'></font>
      END IF<a name='2122'>
<a name='2123'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2124'></font>
<font color=#447700>! BASED ON ETP AND E VALUES, DETERMINE BETA<a name='2125'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2126'></font>
<a name='2127'>
      IF ( ETP &lt;= 0.0 ) THEN<a name='2128'>
         BETA = 0.0<a name='2129'>
         ETA = ETP<a name='2130'>
         IF ( ETP &lt; 0.0 ) THEN<a name='2131'>
            BETA = 1.0<a name='2132'>
         END IF<a name='2133'>
      ELSE<a name='2134'>
         BETA = ETA / ETP<a name='2135'>
      END IF<a name='2136'>
<a name='2137'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2138'></font>
<font color=#447700>! CONVERT MODELED EVAPOTRANSPIRATION COMPONENTS 'M S-1' TO 'KG M-2 S-1'.<a name='2139'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2140'></font>
      EDIR = EDIR1*1000.<a name='2141'>
      EC = EC1*1000.<a name='2142'>
      DO K = 1,NSOIL<a name='2143'>
        ET(K) = ET1(K)*1000.<a name='2144'>
      END DO<a name='2145'>
      ETT = ETT1*1000.<a name='2146'>
<a name='2147'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2148'></font>
<font color=#447700>! GET SOIL THERMAL DIFFUXIVITY/CONDUCTIVITY FOR TOP SOIL LYR,<a name='2149'></font>
<font color=#447700>! CALC. ADJUSTED TOP LYR SOIL TEMP AND ADJUSTED SOIL FLUX, THEN<a name='2150'></font>
<font color=#447700>! CALL SHFLX TO COMPUTE/UPDATE SOIL HEAT FLUX AND SOIL TEMPS.<a name='2151'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2152'></font>
<a name='2153'>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_4"> (DF1,SMC (1),QUARTZ,SMCMAX,SH2O (1),BEXP, PSISAT, SOILTYP, OPT_THCND)<a name='2154'>
<a name='2155'>
<font color=#447700>!urban<a name='2156'></font>
      IF ( VEGTYP == ISURBAN ) DF1=3.24<a name='2157'>
<font color=#447700>!<a name='2158'></font>
<a name='2159'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2160'></font>
<font color=#447700>! VEGETATION GREENNESS FRACTION REDUCTION IN SUBSURFACE HEAT FLUX<a name='2161'></font>
<font color=#447700>! VIA REDUCTION FACTOR, WHICH IS CONVENIENT TO APPLY HERE TO THERMAL<a name='2162'></font>
<font color=#447700>! DIFFUSIVITY THAT IS LATER USED IN HRT TO COMPUTE SUB SFC HEAT FLUX<a name='2163'></font>
<font color=#447700>! (SEE ADDITIONAL COMMENTS ON VEG EFFECT SUB-SFC HEAT FLX IN<a name='2164'></font>
<font color=#447700>! ROUTINE SFLX)<a name='2165'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2166'></font>
      DF1 = DF1 * EXP (SBETA * SHDFAC)<a name='2167'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2168'></font>
<font color=#447700>! COMPUTE INTERMEDIATE TERMS PASSED TO ROUTINE HRT (VIA ROUTINE<a name='2169'></font>
<font color=#447700>! SHFLX BELOW) FOR USE IN COMPUTING SUBSURFACE HEAT FLUX IN HRT<a name='2170'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2171'></font>
      YYNUM = FDOWN - EMISSI*SIGMA * T24<a name='2172'>
      YY = SFCTMP + (YYNUM / RCH + TH2- SFCTMP - BETA * EPSCA) / RR<a name='2173'>
<a name='2174'>
      ZZ1 = DF1 / ( -0.5 * ZSOIL (1) * RCH * RR ) + 1.0<a name='2175'>
<a name='2176'>
<font color=#447700>!urban<a name='2177'></font>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#SHFLX'>SHFLX</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#NOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHFLX_2"> (SSOIL,STC,SMC,SMCMAX,NSOIL,T1,DT,YY,ZZ1,ZSOIL,       &amp;<a name='2178'>
                  TBOT,ZBOT,SMCWLT,PSISAT,SH2O,BEXP,F1,DF1,            &amp;<a name='2179'>
                  QUARTZ,CSOIL,VEGTYP,ISURBAN,SOILTYP,OPT_THCND        &amp;<a name='2180'>
                 ,HCPCT_FASDAS                                         ) <font color=#447700>!fasdas<a name='2181'></font>
<a name='2182'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2183'></font>
<font color=#447700>! SET FLX1 AND FLX3 (SNOPACK PHASE CHANGE HEAT FLUXES) TO ZERO SINCE<a name='2184'></font>
<font color=#447700>! THEY ARE NOT USED HERE IN SNOPAC.  FLX2 (FREEZING RAIN HEAT FLUX) WAS<a name='2185'></font>
<font color=#447700>! SIMILARLY INITIALIZED IN THE PENMAN ROUTINE.<a name='2186'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2187'></font>
      FLX1 = CPH2O * PRCP * (T1- SFCTMP)<a name='2188'>
      FLX3 = 0.0<a name='2189'>
<a name='2190'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2191'></font>
  END SUBROUTINE NOPAC<a name='2192'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2193'></font>
<a name='2194'>
<A NAME='PENMAN'><A href='../../html_code/phys/module_sf_noahlsm.F.html#PENMAN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2195'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>PENMAN</font> (SFCTMP,SFCPRS,CH,T2V,TH2,PRCP,FDOWN,T24,SSOIL, &amp; <A href='../../call_to/PENMAN.html' TARGET='index'>3</A><a name='2196'>
     &amp;                   Q2,Q2SAT,ETP,RCH,EPSCA,RR,SNOWNG,FRZGRA,       &amp;<a name='2197'>
     &amp;                   DQSDT2,FLX2,EMISSI_IN,SNEQV,T1,SNCOVR,AOASIS,  &amp;<a name='2198'>
		         ALBEDO,SOLDN,FVB,GAMA,STC1,ETPN,FLX4,UA_PHYS)<a name='2199'>
<a name='2200'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2201'></font>
<font color=#447700>! SUBROUTINE PENMAN<a name='2202'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2203'></font>
<font color=#447700>! CALCULATE POTENTIAL EVAPORATION FOR THE CURRENT POINT.  VARIOUS<a name='2204'></font>
<font color=#447700>! PARTIAL SUMS/PRODUCTS ARE ALSO CALCULATED AND PASSED BACK TO THE<a name='2205'></font>
<font color=#447700>! CALLING ROUTINE FOR LATER USE.<a name='2206'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2207'></font>
      IMPLICIT NONE<a name='2208'>
      LOGICAL, INTENT(IN)     :: SNOWNG, FRZGRA<a name='2209'>
      REAL, INTENT(IN)        :: CH, DQSDT2,FDOWN,PRCP,                 &amp;<a name='2210'>
                                 Q2, Q2SAT,SSOIL, SFCPRS, SFCTMP,       &amp;<a name='2211'>
                                 T2V, TH2,EMISSI_IN,SNEQV,AOASIS<a name='2212'>
      REAL, INTENT(IN)        :: T1 , SNCOVR<a name='2213'>
      REAL, INTENT(IN)        :: ALBEDO,SOLDN,FVB,GAMA,STC1<a name='2214'>
      LOGICAL, INTENT(IN)     :: UA_PHYS<a name='2215'>
<font color=#447700>!<a name='2216'></font>
      REAL, INTENT(OUT)       :: EPSCA,ETP,FLX2,RCH,RR,T24<a name='2217'>
      REAL, INTENT(OUT)       :: FLX4,ETPN<a name='2218'>
      REAL                    :: A, DELTA, FNET,RAD,RHO,EMISSI,ELCP1,LVS<a name='2219'>
      REAL                    :: TOTABS,UCABS,SIGNCK,FNETN,RADN,EPSCAN<a name='2220'>
<a name='2221'>
      REAL, PARAMETER      :: ELCP = 2.4888E+3, LSUBC = 2.501000E+6,CP = 1004.6<a name='2222'>
      REAL, PARAMETER      :: LSUBS = 2.83E+6<a name='2223'>
      REAL, PARAMETER      :: ALGDSN = 0.5, ALVGSN = 0.13<a name='2224'>
<a name='2225'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2226'></font>
<font color=#447700>! EXECUTABLE CODE BEGINS HERE:<a name='2227'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2228'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2229'></font>
<font color=#447700>! PREPARE PARTIAL QUANTITIES FOR PENMAN EQUATION.<a name='2230'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2231'></font>
        EMISSI=EMISSI_IN<a name='2232'>
        ELCP1  = (1.0-SNCOVR)*ELCP  + SNCOVR*ELCP*LSUBS/LSUBC<a name='2233'>
        LVS    = (1.0-SNCOVR)*LSUBC + SNCOVR*LSUBS<a name='2234'>
<a name='2235'>
      FLX2 = 0.0<a name='2236'>
<font color=#447700>!      DELTA = ELCP * DQSDT2<a name='2237'></font>
      DELTA = ELCP1 * DQSDT2<a name='2238'>
      T24 = SFCTMP * SFCTMP * SFCTMP * SFCTMP<a name='2239'>
<font color=#447700>!      RR = T24 * 6.48E-8 / (SFCPRS * CH) + 1.0<a name='2240'></font>
      RR = EMISSI*T24 * 6.48E-8 / (SFCPRS * CH) + 1.0<a name='2241'>
      RHO = SFCPRS / (RD * T2V)<a name='2242'>
<a name='2243'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2244'></font>
<font color=#447700>! ADJUST THE PARTIAL SUMS / PRODUCTS WITH THE LATENT HEAT<a name='2245'></font>
<font color=#447700>! EFFECTS CAUSED BY FALLING PRECIPITATION.<a name='2246'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2247'></font>
      RCH = RHO * CP * CH<a name='2248'>
      IF (.NOT. SNOWNG) THEN<a name='2249'>
         IF (PRCP &gt;  0.0) RR = RR + CPH2O * PRCP / RCH<a name='2250'>
      ELSE<a name='2251'>
         RR = RR + CPICE * PRCP / RCH<a name='2252'>
      END IF<a name='2253'>
<a name='2254'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2255'></font>
<font color=#447700>! INCLUDE THE LATENT HEAT EFFECTS OF FRZNG RAIN CONVERTING TO ICE ON<a name='2256'></font>
<font color=#447700>! IMPACT IN THE CALCULATION OF FLX2 AND FNET.<a name='2257'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2258'></font>
<font color=#447700>!      FNET = FDOWN - SIGMA * T24- SSOIL<a name='2259'></font>
      FNET = FDOWN -  EMISSI*SIGMA * T24- SSOIL<a name='2260'>
<a name='2261'>
      FLX4 = 0.0<a name='2262'>
      IF(UA_PHYS) THEN<a name='2263'>
        IF(SNEQV &gt; 0. .AND. FNET &gt; 0. .AND. SOLDN &gt; 0. ) THEN<a name='2264'>
         TOTABS = (1.-ALBEDO)*SOLDN*FVB           <font color=#447700>! solar radiation absorbed <a name='2265'></font>
                                                  <font color=#447700>! by vegetated fraction<a name='2266'></font>
         UCABS = MIN(TOTABS,((1.0-ALGDSN)*(1.0-ALVGSN)*SOLDN*GAMA)*FVB)<a name='2267'>
<font color=#447700>!         print*,'penman',UCABS,TOTABS,SOLDN,GAMA,FVB<a name='2268'></font>
<font color=#447700>!         UCABS = MIN(TOTABS,(0.44*SOLDN*GAMA)*FVB)  <a name='2269'></font>
                                                  <font color=#447700>! UCABS -&gt; solar radiation<a name='2270'></font>
						  <font color=#447700>! absorbed under canopy<a name='2271'></font>
         FLX4 = MIN(TOTABS - UCABS, MIN(250., 0.5*(1.-ALBEDO)*SOLDN))<a name='2272'>
        ENDIF<a name='2273'>
<a name='2274'>
        SIGNCK = (STC1-273.15)*(SFCTMP-273.15)<a name='2275'>
<a name='2276'>
        IF(FLX4 &gt; 0. .AND. (SIGNCK &lt;= 0. .OR. STC1 &lt; 273.15)) THEN<a name='2277'>
          IF(FNET &gt;= FLX4) THEN<a name='2278'>
           FNETN = FNET - FLX4<a name='2279'>
          ELSE<a name='2280'>
           FLX4 = FNET<a name='2281'>
           FNETN = 0.<a name='2282'>
          ENDIF<a name='2283'>
        ELSE<a name='2284'>
          FLX4 = 0.0<a name='2285'>
          FNETN = 0.<a name='2286'>
        ENDIF<a name='2287'>
      ENDIF<a name='2288'>
<a name='2289'>
      IF (FRZGRA) THEN<a name='2290'>
         FLX2 = - LSUBF * PRCP<a name='2291'>
         FNET = FNET - FLX2<a name='2292'>
         IF(UA_PHYS) FNETN = FNETN - FLX2<a name='2293'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2294'></font>
<font color=#447700>! FINISH PENMAN EQUATION CALCULATIONS.<a name='2295'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2296'></font>
      END IF<a name='2297'>
      RAD = FNET / RCH + TH2- SFCTMP<a name='2298'>
<font color=#447700>!      A = ELCP * (Q2SAT - Q2)<a name='2299'></font>
      A = ELCP1 * (Q2SAT - Q2)<a name='2300'>
      EPSCA = (A * RR + RAD * DELTA) / (DELTA + RR)<a name='2301'>
<font color=#447700>! Fei-Mike<a name='2302'></font>
      IF (EPSCA&gt;0.) EPSCA = EPSCA * AOASIS<a name='2303'>
<font color=#447700>!      ETP = EPSCA * RCH / LSUBC<a name='2304'></font>
      ETP = EPSCA * RCH / LVS<a name='2305'>
<a name='2306'>
      IF(UA_PHYS) THEN<a name='2307'>
        RADN = FNETN / RCH + TH2- SFCTMP<a name='2308'>
        EPSCAN = (A * RR + RADN * DELTA) / (DELTA + RR)<a name='2309'>
        ETPN = EPSCAN * RCH / LVS<a name='2310'>
      END IF<a name='2311'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2312'></font>
  END SUBROUTINE PENMAN<a name='2313'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2314'></font>
<a name='2315'>
<A NAME='REDPRM'><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2316'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>REDPRM</font> (VEGTYP,SOILTYP,SLOPETYP,CFACTR,CMCMAX,RSMAX,      &amp; <A href='../../call_to/REDPRM.html' TARGET='index'>1</A>,<A href='../../call_from/REDPRM.html' TARGET='index'>4</A><a name='2317'>
                         TOPT,                                             &amp;<a name='2318'>
                         REFKDT,KDT,SBETA, SHDFAC,RSMIN,RGL,HS,ZBOT,FRZX,  &amp;<a name='2319'>
                         PSISAT,SLOPE,SNUP,SALP,BEXP,DKSAT,DWSAT,          &amp;<a name='2320'>
                         SMCMAX,SMCWLT,SMCREF,SMCDRY,F1,QUARTZ,FXEXP,      &amp;<a name='2321'>
                         RTDIS,SLDPTH,ZSOIL, NROOT,NSOIL,CZIL,             &amp;<a name='2322'>
                         LAIMIN, LAIMAX, EMISSMIN, EMISSMAX, ALBEDOMIN,    &amp;<a name='2323'>
                         ALBEDOMAX, Z0MIN, Z0MAX, CSOIL, PTU, LLANDUSE,    &amp;<a name='2324'>
                         LSOIL, LOCAL,LVCOEF,ZTOPV,ZBOTV)<a name='2325'>
<a name='2326'>
      IMPLICIT NONE<a name='2327'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2328'></font>
<font color=#447700>! Internally set (default valuess)<a name='2329'></font>
<font color=#447700>! all soil and vegetation parameters required for the execusion oF<a name='2330'></font>
<font color=#447700>! the Noah lsm are defined in VEGPARM.TBL, SOILPARM.TB, and GENPARM.TBL.<a name='2331'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2332'></font>
<font color=#447700>!     Vegetation parameters:<a name='2333'></font>
<font color=#447700>!             ALBBRD: SFC background snow-free albedo<a name='2334'></font>
<font color=#447700>!             CMXTBL: MAX CNPY Capacity<a name='2335'></font>
<font color=#447700>!              Z0BRD: Background roughness length<a name='2336'></font>
<font color=#447700>!             SHDFAC: Green vegetation fraction<a name='2337'></font>
<font color=#447700>!              NROOT: Rooting depth<a name='2338'></font>
<font color=#447700>!              RSMIN: Mimimum stomatal resistance<a name='2339'></font>
<font color=#447700>!              RSMAX: Max. stomatal resistance<a name='2340'></font>
<font color=#447700>!                RGL: Parameters used in radiation stress function<a name='2341'></font>
<font color=#447700>!                 HS: Parameter used in vapor pressure deficit functio<a name='2342'></font>
<font color=#447700>!               TOPT: Optimum transpiration air temperature.<a name='2343'></font>
<font color=#447700>!             CMCMAX: Maximum canopy water capacity<a name='2344'></font>
<font color=#447700>!             CFACTR: Parameter used in the canopy inteception calculation<a name='2345'></font>
<font color=#447700>!               SNUP: Threshold snow depth (in water equivalent m) that<a name='2346'></font>
<font color=#447700>!                     implies 100 percent snow cover<a name='2347'></font>
<font color=#447700>!                LAI: Leaf area index<a name='2348'></font>
<font color=#447700>!<a name='2349'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2350'></font>
<font color=#447700>!      Soil parameters:<a name='2351'></font>
<font color=#447700>!        SMCMAX: MAX soil moisture content (porosity)<a name='2352'></font>
<font color=#447700>!        SMCREF: Reference soil moisture  (field capacity)<a name='2353'></font>
<font color=#447700>!        SMCWLT: Wilting point soil moisture<a name='2354'></font>
<font color=#447700>!        SMCWLT: Air dry soil moist content limits<a name='2355'></font>
<font color=#447700>!       SSATPSI: SAT (saturation) soil potential<a name='2356'></font>
<font color=#447700>!         DKSAT: SAT soil conductivity<a name='2357'></font>
<font color=#447700>!          BEXP: B parameter<a name='2358'></font>
<font color=#447700>!        SSATDW: SAT soil diffusivity<a name='2359'></font>
<font color=#447700>!           F1: Soil thermal diffusivity/conductivity coef.<a name='2360'></font>
<font color=#447700>!        QUARTZ: Soil quartz content<a name='2361'></font>
<font color=#447700>!  Modified by F. Chen (12/22/97)  to use the STATSGO soil map<a name='2362'></font>
<font color=#447700>!  Modified By F. Chen (01/22/00)  to include PLaya, Lava, and White San<a name='2363'></font>
<font color=#447700>!  Modified By F. Chen (08/05/02)  to include additional parameters for the Noah<a name='2364'></font>
<font color=#447700>! NOTE: SATDW = BB*SATDK*(SATPSI/MAXSMC)<a name='2365'></font>
<font color=#447700>!         F11 = ALOG10(SATPSI) + BB*ALOG10(MAXSMC) + 2.0<a name='2366'></font>
<font color=#447700>!       REFSMC1=MAXSMC*(5.79E-9/SATDK)**(1/(2*BB+3)) 5.79E-9 m/s= 0.5 mm<a name='2367'></font>
<font color=#447700>!       REFSMC=REFSMC1+1./3.(MAXSMC-REFSMC1)<a name='2368'></font>
<font color=#447700>!       WLTSMC1=MAXSMC*(200./SATPSI)**(-1./BB)    (Wetzel and Chang, 198<a name='2369'></font>
<font color=#447700>!       WLTSMC=WLTSMC1-0.5*WLTSMC1<a name='2370'></font>
<font color=#447700>! Note: the values for playa is set for it to have a thermal conductivit<a name='2371'></font>
<font color=#447700>! as sand and to have a hydrulic conductivity as clay<a name='2372'></font>
<font color=#447700>!<a name='2373'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2374'></font>
<font color=#447700>! Class parameter 'SLOPETYP' was included to estimate linear reservoir<a name='2375'></font>
<font color=#447700>! coefficient 'SLOPE' to the baseflow runoff out of the bottom layer.<a name='2376'></font>
<font color=#447700>! lowest class (slopetyp=0) means highest slope parameter = 1.<a name='2377'></font>
<font color=#447700>! definition of slopetyp from 'zobler' slope type:<a name='2378'></font>
<font color=#447700>! slope class  percent slope<a name='2379'></font>
<font color=#447700>! 1            0-8<a name='2380'></font>
<font color=#447700>! 2            8-30<a name='2381'></font>
<font color=#447700>! 3            &gt; 30<a name='2382'></font>
<font color=#447700>! 4            0-30<a name='2383'></font>
<font color=#447700>! 5            0-8 &amp; &gt; 30<a name='2384'></font>
<font color=#447700>! 6            8-30 &amp; &gt; 30<a name='2385'></font>
<font color=#447700>! 7            0-8, 8-30, &gt; 30<a name='2386'></font>
<font color=#447700>! 9            GLACIAL ICE<a name='2387'></font>
<font color=#447700>! BLANK        OCEAN/SEA<a name='2388'></font>
<font color=#447700>!       SLOPE_DATA: linear reservoir coefficient<a name='2389'></font>
<font color=#447700>!       SBETA_DATA: parameter used to caluculate vegetation effect on soil heat<a name='2390'></font>
<font color=#447700>!       FXEXP_DAT:  soil evaporation exponent used in DEVAP<a name='2391'></font>
<font color=#447700>!       CSOIL_DATA: soil heat capacity [J M-3 K-1]<a name='2392'></font>
<font color=#447700>!       SALP_DATA: shape parameter of  distribution function of snow cover<a name='2393'></font>
<font color=#447700>!       REFDK_DATA and REFKDT_DATA: parameters in the surface runoff parameteriz<a name='2394'></font>
<font color=#447700>!       FRZK_DATA: frozen ground parameter<a name='2395'></font>
<font color=#447700>!       ZBOT_DATA: depth[M] of lower boundary soil temperature<a name='2396'></font>
<font color=#447700>!       CZIL_DATA: calculate roughness length of heat<a name='2397'></font>
<font color=#447700>!       SMLOW_DATA and MHIGH_DATA: two soil moisture wilt, soil moisture referen<a name='2398'></font>
<font color=#447700>!                 parameters<a name='2399'></font>
<font color=#447700>! Set maximum number of soil-, veg-, and slopetyp in data statement.<a name='2400'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2401'></font>
      INTEGER, PARAMETER     :: MAX_SLOPETYP=30,MAX_SOILTYP=30,MAX_VEGTYP=30<a name='2402'>
      LOGICAL                :: LOCAL<a name='2403'>
      CHARACTER (LEN=256), INTENT(IN)::  LLANDUSE, LSOIL<a name='2404'>
<a name='2405'>
<font color=#447700>! Veg parameters<a name='2406'></font>
      INTEGER, INTENT(IN)    :: VEGTYP<a name='2407'>
      INTEGER, INTENT(OUT)   :: NROOT<a name='2408'>
      REAL, INTENT(INOUT)    :: SHDFAC<a name='2409'>
      REAL, INTENT(OUT)      :: HS,RSMIN,RGL,SNUP,                          &amp;<a name='2410'>
                                CMCMAX,RSMAX,TOPT,                          &amp;<a name='2411'>
                                EMISSMIN,  EMISSMAX,                        &amp;<a name='2412'>
                                LAIMIN,    LAIMAX,                          &amp;<a name='2413'>
                                Z0MIN,     Z0MAX,                           &amp;<a name='2414'>
                                ALBEDOMIN, ALBEDOMAX, ZTOPV, ZBOTV<a name='2415'>
<font color=#447700>! Soil parameters<a name='2416'></font>
      INTEGER, INTENT(IN)    :: SOILTYP<a name='2417'>
      REAL, INTENT(OUT)      :: BEXP,DKSAT,DWSAT,F1,QUARTZ,SMCDRY,          &amp;<a name='2418'>
                                SMCMAX,SMCREF,SMCWLT,PSISAT<a name='2419'>
<font color=#447700>! General parameters<a name='2420'></font>
      INTEGER, INTENT(IN)    :: SLOPETYP,NSOIL<a name='2421'>
      INTEGER                :: I<a name='2422'>
<a name='2423'>
      REAL,    INTENT(OUT)   :: SLOPE,CZIL,SBETA,FXEXP,                     &amp;<a name='2424'>
                                CSOIL,SALP,FRZX,KDT,CFACTR,      &amp;<a name='2425'>
                                ZBOT,REFKDT,PTU<a name='2426'>
      REAL,    INTENT(OUT)   :: LVCOEF<a name='2427'>
      REAL,DIMENSION(1:NSOIL),INTENT(IN) :: SLDPTH,ZSOIL<a name='2428'>
      REAL,DIMENSION(1:NSOIL),INTENT(OUT):: RTDIS<a name='2429'>
      REAL                   :: FRZFACT,FRZK,REFDK<a name='2430'>
<a name='2431'>
<font color=#447700>!      SAVE<a name='2432'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2433'></font>
<font color=#447700>!<a name='2434'></font>
               IF (SOILTYP .gt. SLCATS) THEN<a name='2435'>
                        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1172"> ( 'Warning: too many input soil types' )<a name='2436'>
               END IF<a name='2437'>
               IF (VEGTYP .gt. LUCATS) THEN<a name='2438'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1173"> ( 'Warning: too many input landuse types' )<a name='2439'>
               END IF<a name='2440'>
               IF (SLOPETYP .gt. SLPCATS) THEN<a name='2441'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1174"> ( 'Warning: too many input slope types' )<a name='2442'>
               END IF<a name='2443'>
<a name='2444'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2445'></font>
<font color=#447700>!  SET-UP SOIL PARAMETERS<a name='2446'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2447'></font>
      CSOIL = CSOIL_DATA<a name='2448'>
      BEXP = BB (SOILTYP)<a name='2449'>
      DKSAT = SATDK (SOILTYP)<a name='2450'>
      DWSAT = SATDW (SOILTYP)<a name='2451'>
      F1 = F11 (SOILTYP)<a name='2452'>
      PSISAT = SATPSI (SOILTYP)<a name='2453'>
      QUARTZ = QTZ (SOILTYP)<a name='2454'>
      SMCDRY = DRYSMC (SOILTYP)<a name='2455'>
      SMCMAX = MAXSMC (SOILTYP)<a name='2456'>
      SMCREF = REFSMC (SOILTYP)<a name='2457'>
      SMCWLT = WLTSMC (SOILTYP)<a name='2458'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2459'></font>
<font color=#447700>! Set-up universal parameters (not dependent on SOILTYP, VEGTYP or<a name='2460'></font>
<font color=#447700>! SLOPETYP)<a name='2461'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2462'></font>
      ZBOT = ZBOT_DATA<a name='2463'>
      SALP = SALP_DATA<a name='2464'>
      SBETA = SBETA_DATA<a name='2465'>
      REFDK = REFDK_DATA<a name='2466'>
      FRZK = FRZK_DATA<a name='2467'>
      FXEXP = FXEXP_DATA<a name='2468'>
      REFKDT = REFKDT_DATA<a name='2469'>
      PTU = 0.    <font color=#447700>! (not used yet) to satisify intent(out)<a name='2470'></font>
      KDT = REFKDT * DKSAT / REFDK<a name='2471'>
      CZIL = CZIL_DATA<a name='2472'>
      SLOPE = SLOPE_DATA (SLOPETYP)<a name='2473'>
      LVCOEF = LVCOEF_DATA<a name='2474'>
<a name='2475'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2476'></font>
<font color=#447700>! TO ADJUST FRZK PARAMETER TO ACTUAL SOIL TYPE: FRZK * FRZFACT<a name='2477'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2478'></font>
      FRZFACT = (SMCMAX / SMCREF) * (0.412 / 0.468)<a name='2479'>
      FRZX = FRZK * FRZFACT<a name='2480'>
<a name='2481'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2482'></font>
<font color=#447700>! SET-UP VEGETATION PARAMETERS<a name='2483'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2484'></font>
      TOPT = TOPT_DATA<a name='2485'>
      CMCMAX = CMCMAX_DATA<a name='2486'>
      CFACTR = CFACTR_DATA<a name='2487'>
      RSMAX = RSMAX_DATA<a name='2488'>
      NROOT = NROTBL (VEGTYP)<a name='2489'>
      SNUP = SNUPTBL (VEGTYP)<a name='2490'>
      RSMIN = RSTBL (VEGTYP)<a name='2491'>
      RGL = RGLTBL (VEGTYP)<a name='2492'>
      HS = HSTBL (VEGTYP)<a name='2493'>
      EMISSMIN  = EMISSMINTBL  (VEGTYP)<a name='2494'>
      EMISSMAX  = EMISSMAXTBL  (VEGTYP)<a name='2495'>
      LAIMIN    = LAIMINTBL    (VEGTYP)<a name='2496'>
      LAIMAX    = LAIMAXTBL    (VEGTYP)<a name='2497'>
      Z0MIN     = Z0MINTBL     (VEGTYP)<a name='2498'>
      Z0MAX     = Z0MAXTBL     (VEGTYP)<a name='2499'>
      ALBEDOMIN = ALBEDOMINTBL (VEGTYP)<a name='2500'>
      ALBEDOMAX = ALBEDOMAXTBL (VEGTYP)<a name='2501'>
      ZTOPV     = ZTOPVTBL     (VEGTYP)<a name='2502'>
      ZBOTV     = ZBOTVTBL     (VEGTYP)<a name='2503'>
<a name='2504'>
               IF (VEGTYP .eq. BARE) SHDFAC = 0.0<a name='2505'>
               IF (NROOT .gt. NSOIL) THEN<a name='2506'>
                  WRITE (err_message,*) 'Error: too many root layers ',  &amp;<a name='2507'>
                                                 NSOIL,NROOT<a name='2508'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#REDPRM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1175"> ( err_message )<a name='2509'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2510'></font>
<font color=#447700>! CALCULATE ROOT DISTRIBUTION.  PRESENT VERSION ASSUMES UNIFORM<a name='2511'></font>
<font color=#447700>! DISTRIBUTION BASED ON SOIL LAYER DEPTHS.<a name='2512'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2513'></font>
               END IF<a name='2514'>
               DO I = 1,NROOT<a name='2515'>
                  RTDIS (I) = - SLDPTH (I)/ ZSOIL (NROOT)<a name='2516'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2517'></font>
<font color=#447700>!  SET-UP SLOPE PARAMETER<a name='2518'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2519'></font>
               END DO<a name='2520'>
<a name='2521'>
<font color=#447700>!        print*,'end of PRMRED'<a name='2522'></font>
<font color=#447700>!       print*,'VEGTYP',VEGTYP,'SOILTYP',SOILTYP,'SLOPETYP',SLOPETYP,    &amp;<a name='2523'></font>
<font color=#447700>!    &amp; 'CFACTR',CFACTR,'CMCMAX',CMCMAX,'RSMAX',RSMAX,'TOPT',TOPT,        &amp;<a name='2524'></font>
<font color=#447700>!    &amp; 'REFKDT',REFKDT,'KDT',KDT,'SBETA',SBETA, 'SHDFAC',SHDFAC,         &amp;<a name='2525'></font>
<font color=#447700>!    &amp;  'RSMIN',RSMIN,'RGL',RGL,'HS',HS,'ZBOT',ZBOT,'FRZX',FRZX,         &amp;<a name='2526'></font>
<font color=#447700>!    &amp;  'PSISAT',PSISAT,'SLOPE',SLOPE,'SNUP',SNUP,'SALP',SALP,'BEXP',    &amp;<a name='2527'></font>
<font color=#447700>!    &amp;   BEXP,                                                           &amp;<a name='2528'></font>
<font color=#447700>!    &amp;  'DKSAT',DKSAT,'DWSAT',DWSAT,                                     &amp;<a name='2529'></font>
<font color=#447700>!    &amp;  'SMCMAX',SMCMAX,'SMCWLT',SMCWLT,'SMCREF',SMCREF,'SMCDRY',SMCDRY, &amp;<a name='2530'></font>
<font color=#447700>!    &amp;  'F1',F1,'QUARTZ',QUARTZ,'FXEXP',FXEXP,                           &amp;<a name='2531'></font>
<font color=#447700>!    &amp;  'RTDIS',RTDIS,'SLDPTH',SLDPTH,'ZSOIL',ZSOIL, 'NROOT',NROOT,      &amp;<a name='2532'></font>
<font color=#447700>!    &amp;  'NSOIL',NSOIL,'Z0',Z0,'CZIL',CZIL,'LAI',LAI,                     &amp;<a name='2533'></font>
<font color=#447700>!    &amp;  'CSOIL',CSOIL,'PTU',PTU,                                         &amp;<a name='2534'></font>
<font color=#447700>!    &amp;  'LOCAL', LOCAL<a name='2535'></font>
<a name='2536'>
      END  SUBROUTINE REDPRM<a name='2537'>
<a name='2538'>
<A NAME='ROSR12'><A href='../../html_code/phys/module_sf_noahlsm.F.html#ROSR12' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2539'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>ROSR12</font> (P,A,B,C,D,DELTA,NSOIL) <A href='../../call_to/ROSR12.html' TARGET='index'>7</A><a name='2540'>
<a name='2541'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2542'></font>
<font color=#447700>! SUBROUTINE ROSR12<a name='2543'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2544'></font>
<font color=#447700>! INVERT (SOLVE) THE TRI-DIAGONAL MATRIX PROBLEM SHOWN BELOW:<a name='2545'></font>
<font color=#447700>! ###                                            ### ###  ###   ###  ###<a name='2546'></font>
<font color=#447700>! #B(1), C(1),  0  ,  0  ,  0  ,   . . .  ,    0   # #      #   #      #<a name='2547'></font>
<font color=#447700>! #A(2), B(2), C(2),  0  ,  0  ,   . . .  ,    0   # #      #   #      #<a name='2548'></font>
<font color=#447700>! # 0  , A(3), B(3), C(3),  0  ,   . . .  ,    0   # #      #   # D(3) #<a name='2549'></font>
<font color=#447700>! # 0  ,  0  , A(4), B(4), C(4),   . . .  ,    0   # # P(4) #   # D(4) #<a name='2550'></font>
<font color=#447700>! # 0  ,  0  ,  0  , A(5), B(5),   . . .  ,    0   # # P(5) #   # D(5) #<a name='2551'></font>
<font color=#447700>! # .                                          .   # #  .   # = #   .  #<a name='2552'></font>
<font color=#447700>! # .                                          .   # #  .   #   #   .  #<a name='2553'></font>
<font color=#447700>! # .                                          .   # #  .   #   #   .  #<a name='2554'></font>
<font color=#447700>! # 0  , . . . , 0 , A(M-2), B(M-2), C(M-2),   0   # #P(M-2)#   #D(M-2)#<a name='2555'></font>
<font color=#447700>! # 0  , . . . , 0 ,   0   , A(M-1), B(M-1), C(M-1)# #P(M-1)#   #D(M-1)#<a name='2556'></font>
<font color=#447700>! # 0  , . . . , 0 ,   0   ,   0   ,  A(M) ,  B(M) # # P(M) #   # D(M) #<a name='2557'></font>
<font color=#447700>! ###                                            ### ###  ###   ###  ###<a name='2558'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2559'></font>
      IMPLICIT NONE<a name='2560'>
<a name='2561'>
      INTEGER, INTENT(IN)   :: NSOIL<a name='2562'>
      INTEGER               :: K, KK<a name='2563'>
<a name='2564'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN):: A, B, D<a name='2565'>
      REAL, DIMENSION(1:NSOIL),INTENT(INOUT):: C,P,DELTA<a name='2566'>
<a name='2567'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2568'></font>
<font color=#447700>! INITIALIZE EQN COEF C FOR THE LOWEST SOIL LAYER<a name='2569'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2570'></font>
      C (NSOIL) = 0.0<a name='2571'>
      P (1) = - C (1) / B (1)<a name='2572'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2573'></font>
<font color=#447700>! SOLVE THE COEFS FOR THE 1ST SOIL LAYER<a name='2574'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2575'></font>
<a name='2576'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2577'></font>
<font color=#447700>! SOLVE THE COEFS FOR SOIL LAYERS 2 THRU NSOIL<a name='2578'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2579'></font>
      DELTA (1) = D (1) / B (1)<a name='2580'>
      DO K = 2,NSOIL<a name='2581'>
         P (K) = - C (K) * ( 1.0 / (B (K) + A (K) * P (K -1)) )<a name='2582'>
         DELTA (K) = (D (K) - A (K)* DELTA (K -1))* (1.0/ (B (K) + A (K)&amp;<a name='2583'>
                    * P (K -1)))<a name='2584'>
      END DO<a name='2585'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2586'></font>
<font color=#447700>! SET P TO DELTA FOR LOWEST SOIL LAYER<a name='2587'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2588'></font>
      P (NSOIL) = DELTA (NSOIL)<a name='2589'>
<a name='2590'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2591'></font>
<font color=#447700>! ADJUST P FOR SOIL LAYERS 2 THRU NSOIL<a name='2592'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2593'></font>
      DO K = 2,NSOIL<a name='2594'>
         KK = NSOIL - K + 1<a name='2595'>
         P (KK) = P (KK) * P (KK +1) + DELTA (KK)<a name='2596'>
      END DO<a name='2597'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2598'></font>
  END SUBROUTINE ROSR12<a name='2599'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2600'></font>
<a name='2601'>
<a name='2602'>
<A NAME='SHFLX'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SHFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2603'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SHFLX</font> (SSOIL,STC,SMC,SMCMAX,NSOIL,T1,DT,YY,ZZ1,ZSOIL, &amp; <A href='../../call_to/SHFLX.html' TARGET='index'>5</A>,<A href='../../call_from/SHFLX.html' TARGET='index'>8</A><a name='2604'>
                         TBOT,ZBOT,SMCWLT,PSISAT,SH2O,BEXP,F1,DF1,     &amp;<a name='2605'>
                         QUARTZ,CSOIL,VEGTYP,ISURBAN,SOILTYP,OPT_THCND &amp;<a name='2606'>
                        ,HCPCT_FASDAS                                  ) <font color=#447700>! fasdas<a name='2607'></font>
<a name='2608'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2609'></font>
<font color=#447700>! SUBROUTINE SHFLX<a name='2610'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2611'></font>
<font color=#447700>! UPDATE THE TEMPERATURE STATE OF THE SOIL COLUMN BASED ON THE THERMAL<a name='2612'></font>
<font color=#447700>! DIFFUSION EQUATION AND UPDATE THE FROZEN SOIL MOISTURE CONTENT BASED<a name='2613'></font>
<font color=#447700>! ON THE TEMPERATURE.<a name='2614'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2615'></font>
      IMPLICIT NONE<a name='2616'>
<a name='2617'>
      INTEGER, INTENT(IN)   :: OPT_THCND<a name='2618'>
      INTEGER, INTENT(IN)   :: NSOIL, VEGTYP, ISURBAN, SOILTYP<a name='2619'>
      INTEGER               :: I<a name='2620'>
<a name='2621'>
      REAL, INTENT(IN)      :: BEXP,CSOIL,DF1,DT,F1,PSISAT,QUARTZ,     &amp;<a name='2622'>
                               SMCMAX, SMCWLT, TBOT,YY, ZBOT,ZZ1<a name='2623'>
      REAL, INTENT(INOUT)   :: T1<a name='2624'>
      REAL, INTENT(OUT)     :: SSOIL<a name='2625'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)    :: SMC,ZSOIL<a name='2626'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: SH2O<a name='2627'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: STC<a name='2628'>
      REAL, DIMENSION(1:NSOIL)             :: AI, BI, CI, STCF,RHSTS<a name='2629'>
      REAL, PARAMETER       :: T0 = 273.15<a name='2630'>
<a name='2631'>
<font color=#447700>!<a name='2632'></font>
<font color=#447700>! FASDAS<a name='2633'></font>
<font color=#447700>!<a name='2634'></font>
      REAL, INTENT(  OUT)     :: HCPCT_FASDAS<a name='2635'>
<font color=#447700>!<a name='2636'></font>
<font color=#447700>! END FASDAS<a name='2637'></font>
<font color=#447700>!<a name='2638'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2639'></font>
<font color=#447700>! HRT ROUTINE CALCS THE RIGHT HAND SIDE OF THE SOIL TEMP DIF EQN<a name='2640'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2641'></font>
<a name='2642'>
      <font color=#447700>! Land case<a name='2643'></font>
<a name='2644'>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#HRT'>HRT</A><A href='../../html_code/phys/module_sf_urban.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HRT_1"> (RHSTS,STC,SMC,SMCMAX,NSOIL,ZSOIL,YY,ZZ1,TBOT,     &amp;<a name='2645'>
                ZBOT,PSISAT,SH2O,DT,BEXP,SOILTYP,OPT_THCND,       &amp;<a name='2646'>
                F1,DF1,QUARTZ,CSOIL,AI,BI,CI,VEGTYP,ISURBAN       &amp;<a name='2647'>
               ,HCPCT_FASDAS                                      ) <font color=#447700>!fasdas<a name='2648'></font>
<a name='2649'>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#HSTEP'>HSTEP</A><A href='../../html_code/phys/module_sf_urban.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HSTEP_2"> (STCF,STC,RHSTS,DT,NSOIL,AI,BI,CI)<a name='2650'>
<a name='2651'>
      DO I = 1,NSOIL<a name='2652'>
         STC (I) = STCF (I)<a name='2653'>
      ENDDO<a name='2654'>
<a name='2655'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2656'></font>
<font color=#447700>! IN THE NO SNOWPACK CASE (VIA ROUTINE NOPAC BRANCH,) UPDATE THE GRND<a name='2657'></font>
<font color=#447700>! (SKIN) TEMPERATURE HERE IN RESPONSE TO THE UPDATED SOIL TEMPERATURE<a name='2658'></font>
<font color=#447700>! PROFILE ABOVE.  (NOTE: INSPECTION OF ROUTINE SNOPAC SHOWS THAT T1<a name='2659'></font>
<font color=#447700>! BELOW IS A DUMMY VARIABLE ONLY, AS SKIN TEMPERATURE IS UPDATED<a name='2660'></font>
<font color=#447700>! DIFFERENTLY IN ROUTINE SNOPAC)<a name='2661'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2662'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2663'></font>
<font color=#447700>! CALCULATE SURFACE SOIL HEAT FLUX<a name='2664'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2665'></font>
      T1 = (YY + (ZZ1- 1.0) * STC (1)) / ZZ1<a name='2666'>
      SSOIL = DF1 * (STC (1) - T1) / (0.5 * ZSOIL (1))<a name='2667'>
<a name='2668'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2669'></font>
  END SUBROUTINE SHFLX<a name='2670'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2671'></font>
<a name='2672'>
<A NAME='SMFLX'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SMFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2673'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SMFLX</font> (SMC,NSOIL,CMC,DT,PRCP1,ZSOIL,                   &amp; <A href='../../call_to/SMFLX.html' TARGET='index'>5</A>,<A href='../../call_from/SMFLX.html' TARGET='index'>9</A><a name='2674'>
     &amp;                   SH2O,SLOPE,KDT,FRZFACT,                        &amp;<a name='2675'>
     &amp;                   SMCMAX,BEXP,SMCWLT,DKSAT,DWSAT,                &amp;<a name='2676'>
     &amp;                   SHDFAC,CMCMAX,                                 &amp;<a name='2677'>
     &amp;                   RUNOFF1,RUNOFF2,RUNOFF3,                       &amp;<a name='2678'>
     &amp;                   EDIR,EC,ET,                                    &amp;<a name='2679'>
     &amp;                   DRIP, SFHEAD1RT,INFXS1RT)<a name='2680'>
<a name='2681'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2682'></font>
<font color=#447700>! SUBROUTINE SMFLX<a name='2683'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2684'></font>
<font color=#447700>! CALCULATE SOIL MOISTURE FLUX.  THE SOIL MOISTURE CONTENT (SMC - A PER<a name='2685'></font>
<font color=#447700>! UNIT VOLUME MEASUREMENT) IS A DEPENDENT VARIABLE THAT IS UPDATED WITH<a name='2686'></font>
<font color=#447700>! PROGNOSTIC EQNS. THE CANOPY MOISTURE CONTENT (CMC) IS ALSO UPDATED.<a name='2687'></font>
<font color=#447700>! FROZEN GROUND VERSION:  NEW STATES ADDED: SH2O, AND FROZEN GROUND<a name='2688'></font>
<font color=#447700>! CORRECTION FACTOR, FRZFACT AND PARAMETER SLOPE.<a name='2689'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2690'></font>
      IMPLICIT NONE<a name='2691'>
<a name='2692'>
      INTEGER, INTENT(IN)   :: NSOIL<a name='2693'>
      INTEGER               :: I,K<a name='2694'>
<a name='2695'>
      REAL, INTENT(IN)      :: BEXP, CMCMAX, DKSAT,DWSAT, DT, EC, EDIR,  &amp;<a name='2696'>
                               KDT, PRCP1, SHDFAC, SLOPE, SMCMAX, SMCWLT<a name='2697'>
      REAL, INTENT(OUT)                      :: DRIP, RUNOFF1, RUNOFF2, RUNOFF3<a name='2698'>
      REAL, INTENT(INOUT)   :: CMC<a name='2699'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: ET,ZSOIL<a name='2700'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT):: SMC, SH2O<a name='2701'>
      REAL, DIMENSION(1:NSOIL)             :: AI, BI, CI, STCF,RHSTS, RHSTT, &amp;<a name='2702'>
                                              SICE, SH2OA, SH2OFG<a name='2703'>
      REAL                  :: DUMMY, EXCESS,FRZFACT,PCPDRP,RHSCT,TRHSCT<a name='2704'>
      REAL :: FAC2<a name='2705'>
      REAL :: FLIMIT<a name='2706'>
<a name='2707'>
      REAL,    INTENT(INOUT)                 :: SFHEAD1RT,INFXS1RT<a name='2708'>
<a name='2709'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2710'></font>
<font color=#447700>! EXECUTABLE CODE BEGINS HERE.<a name='2711'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2712'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2713'></font>
<font color=#447700>! COMPUTE THE RIGHT HAND SIDE OF THE CANOPY EQN TERM ( RHSCT )<a name='2714'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2715'></font>
      DUMMY = 0.<a name='2716'>
<a name='2717'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2718'></font>
<font color=#447700>! CONVERT RHSCT (A RATE) TO TRHSCT (AN AMOUNT) AND ADD IT TO EXISTING<a name='2719'></font>
<font color=#447700>! CMC.  IF RESULTING AMT EXCEEDS MAX CAPACITY, IT BECOMES DRIP AND WILL<a name='2720'></font>
<font color=#447700>! FALL TO THE GRND.<a name='2721'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2722'></font>
      RHSCT = SHDFAC * PRCP1- EC<a name='2723'>
      DRIP = 0.<a name='2724'>
      TRHSCT = DT * RHSCT<a name='2725'>
      EXCESS = CMC + TRHSCT<a name='2726'>
<a name='2727'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2728'></font>
<font color=#447700>! PCPDRP IS THE COMBINED PRCP1 AND DRIP (FROM CMC) THAT GOES INTO THE<a name='2729'></font>
<font color=#447700>! SOIL<a name='2730'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2731'></font>
      IF (EXCESS &gt; CMCMAX) DRIP = EXCESS - CMCMAX<a name='2732'>
      PCPDRP = (1. - SHDFAC) * PRCP1+ DRIP / DT<a name='2733'>
<a name='2734'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2735'></font>
<font color=#447700>! STORE ICE CONTENT AT EACH SOIL LAYER BEFORE CALLING SRT and SSTEP<a name='2736'></font>
<font color=#447700>!<a name='2737'></font>
      DO I = 1,NSOIL<a name='2738'>
         SICE (I) = SMC (I) - SH2O (I)<a name='2739'>
      END DO<a name='2740'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2741'></font>
<font color=#447700>! CALL SUBROUTINES SRT AND SSTEP TO SOLVE THE SOIL MOISTURE<a name='2742'></font>
<font color=#447700>! TENDENCY EQUATIONS.<a name='2743'></font>
<font color=#447700>! IF THE INFILTRATING PRECIP RATE IS NONTRIVIAL,<a name='2744'></font>
<font color=#447700>!   (WE CONSIDER NONTRIVIAL TO BE A PRECIP TOTAL OVER THE TIME STEP<a name='2745'></font>
<font color=#447700>!    EXCEEDING ONE ONE-THOUSANDTH OF THE WATER HOLDING CAPACITY OF<a name='2746'></font>
<font color=#447700>!    THE FIRST SOIL LAYER)<a name='2747'></font>
<font color=#447700>! THEN CALL THE SRT/SSTEP SUBROUTINE PAIR TWICE IN THE MANNER OF<a name='2748'></font>
<font color=#447700>!   TIME SCHEME "F" (IMPLICIT STATE, AVERAGED COEFFICIENT)<a name='2749'></font>
<font color=#447700>!   OF SECTION 2 OF KALNAY AND KANAMITSU (1988, MWR, VOL 116,<a name='2750'></font>
<font color=#447700>!   PAGES 1945-1958)TO MINIMIZE 2-DELTA-T OSCILLATIONS IN THE<a name='2751'></font>
<font color=#447700>!   SOIL MOISTURE VALUE OF THE TOP SOIL LAYER THAT CAN ARISE BECAUSE<a name='2752'></font>
<font color=#447700>!   OF THE EXTREME NONLINEAR DEPENDENCE OF THE SOIL HYDRAULIC<a name='2753'></font>
<font color=#447700>!   DIFFUSIVITY COEFFICIENT AND THE HYDRAULIC CONDUCTIVITY ON THE<a name='2754'></font>
<font color=#447700>!   SOIL MOISTURE STATE<a name='2755'></font>
<font color=#447700>! OTHERWISE CALL THE SRT/SSTEP SUBROUTINE PAIR ONCE IN THE MANNER OF<a name='2756'></font>
<font color=#447700>!   TIME SCHEME "D" (IMPLICIT STATE, EXPLICIT COEFFICIENT)<a name='2757'></font>
<font color=#447700>!   OF SECTION 2 OF KALNAY AND KANAMITSU<a name='2758'></font>
<font color=#447700>! PCPDRP IS UNITS OF KG/M**2/S OR MM/S, ZSOIL IS NEGATIVE DEPTH IN M<a name='2759'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2760'></font>
<font color=#447700>!  According to Dr. Ken Mitchell's suggestion, add the second contraint<a name='2761'></font>
<font color=#447700>!  to remove numerical instability of runoff and soil moisture<a name='2762'></font>
<font color=#447700>!  FLIMIT is a limit value for FAC2<a name='2763'></font>
      FAC2=0.0<a name='2764'>
      DO I=1,NSOIL<a name='2765'>
         FAC2=MAX(FAC2,SH2O(I)/SMCMAX)<a name='2766'>
      ENDDO<a name='2767'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#FAC2MIT'>FAC2MIT</A><A href='../../html_code/phys/module_sf_urban.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FAC2MIT_1">(SMCMAX,FLIMIT)<a name='2768'>
<a name='2769'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2770'></font>
<font color=#447700>! FROZEN GROUND VERSION:<a name='2771'></font>
<font color=#447700>! SMC STATES REPLACED BY SH2O STATES IN SRT SUBR.  SH2O &amp; SICE STATES<a name='2772'></font>
<font color=#447700>! INC&amp;UDED IN SSTEP SUBR.  FROZEN GROUND CORRECTION FACTOR, FRZFACT<a name='2773'></font>
<font color=#447700>! ADDED.  ALL WATER BALANCE CALCULATIONS USING UNFROZEN WATER<a name='2774'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2775'></font>
<a name='2776'>
#ifdef WRF_HYDRO<a name='2777'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edit... Add previous ponded water to new precip drip...<a name='2778'></font>
    PCPDRP = PCPDRP + SFHEAD1RT/1000./DT   <font color=#447700>! convert SFHEAD1RT to (m/s)<a name='2779'></font>
#endif<a name='2780'>
<a name='2781'>
<a name='2782'>
      IF ( ( (PCPDRP * DT) &gt; (0.0001*1000.0* (- ZSOIL (1))* SMCMAX) )   &amp;<a name='2783'>
           .OR. (FAC2 &gt; FLIMIT) ) THEN<a name='2784'>
         CALL <A href='../../html_code/phys/module_sf_urban.F.html#SRT'>SRT</A><A href='../../html_code/phys/module_sf_urban.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SRT_1"> (RHSTT,EDIR,ET,SH2O,SH2O,NSOIL,PCPDRP,ZSOIL,          &amp;<a name='2785'>
                    DWSAT,DKSAT,SMCMAX,BEXP,RUNOFF1,                    &amp;<a name='2786'>
                    RUNOFF2,DT,SMCWLT,SLOPE,KDT,FRZFACT,SICE,AI,BI,CI,  &amp;<a name='2787'>
                    SFHEAD1RT,INFXS1RT)<a name='2788'>
         CALL <A href='../../html_code/phys/module_sf_urban.F.html#SSTEP'>SSTEP</A><A href='../../html_code/phys/module_sf_urban.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SSTEP_1"> (SH2OFG,SH2O,DUMMY,RHSTT,RHSCT,DT,NSOIL,SMCMAX,     &amp;<a name='2789'>
                        CMCMAX,RUNOFF3,ZSOIL,SMC,SICE,AI,BI,CI,INFXS1RT)<a name='2790'>
         DO K = 1,NSOIL<a name='2791'>
            SH2OA (K) = (SH2O (K) + SH2OFG (K)) * 0.5<a name='2792'>
         END DO<a name='2793'>
         CALL <A href='../../html_code/phys/module_sf_urban.F.html#SRT'>SRT</A><A href='../../html_code/phys/module_sf_urban.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SRT_2"> (RHSTT,EDIR,ET,SH2O,SH2OA,NSOIL,PCPDRP,ZSOIL,         &amp;<a name='2794'>
                    DWSAT,DKSAT,SMCMAX,BEXP,RUNOFF1,                    &amp;<a name='2795'>
                    RUNOFF2,DT,SMCWLT,SLOPE,KDT,FRZFACT,SICE,AI,BI,CI,  &amp;<a name='2796'>
                    SFHEAD1RT,INFXS1RT)<a name='2797'>
         CALL <A href='../../html_code/phys/module_sf_urban.F.html#SSTEP'>SSTEP</A><A href='../../html_code/phys/module_sf_urban.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SSTEP_2"> (SH2O,SH2O,CMC,RHSTT,RHSCT,DT,NSOIL,SMCMAX,         &amp;<a name='2798'>
                        CMCMAX,RUNOFF3,ZSOIL,SMC,SICE,AI,BI,CI,INFXS1RT)<a name='2799'>
<a name='2800'>
      ELSE<a name='2801'>
         CALL <A href='../../html_code/phys/module_sf_urban.F.html#SRT'>SRT</A><A href='../../html_code/phys/module_sf_urban.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SRT_3"> (RHSTT,EDIR,ET,SH2O,SH2O,NSOIL,PCPDRP,ZSOIL,          &amp;<a name='2802'>
                    DWSAT,DKSAT,SMCMAX,BEXP,RUNOFF1,                    &amp;<a name='2803'>
                    RUNOFF2,DT,SMCWLT,SLOPE,KDT,FRZFACT,SICE,AI,BI,CI,  &amp;<a name='2804'>
                   SFHEAD1RT,INFXS1RT)<a name='2805'>
         CALL <A href='../../html_code/phys/module_sf_urban.F.html#SSTEP'>SSTEP</A><A href='../../html_code/phys/module_sf_urban.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SSTEP_3"> (SH2O,SH2O,CMC,RHSTT,RHSCT,DT,NSOIL,SMCMAX,         &amp;<a name='2806'>
                     CMCMAX,RUNOFF3,ZSOIL,SMC,SICE,AI,BI,CI,INFXS1RT)<a name='2807'>
<font color=#447700>!      RUNOF = RUNOFF<a name='2808'></font>
<a name='2809'>
      END IF<a name='2810'>
<a name='2811'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2812'></font>
  END SUBROUTINE SMFLX<a name='2813'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2814'></font>
<a name='2815'>
<a name='2816'>
<A NAME='SNFRAC'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNFRAC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2817'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNFRAC</font> (SNEQV,SNUP,SALP,SNOWH,SNCOVR, &amp; <A href='../../call_to/SNFRAC.html' TARGET='index'>1</A><a name='2818'>
                         XLAI,SHDFAC,FVB,GAMA,FBUR,    &amp;<a name='2819'>
                         FGSN,ZTOPV,ZBOTV,UA_PHYS)<a name='2820'>
<a name='2821'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2822'></font>
<font color=#447700>! SUBROUTINE SNFRAC<a name='2823'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2824'></font>
<font color=#447700>! CALCULATE SNOW FRACTION (0 -&gt; 1)<a name='2825'></font>
<font color=#447700>! SNEQV   SNOW WATER EQUIVALENT (M)<a name='2826'></font>
<font color=#447700>! SNUP    THRESHOLD SNEQV DEPTH ABOVE WHICH SNCOVR=1<a name='2827'></font>
<font color=#447700>! SALP    TUNING PARAMETER<a name='2828'></font>
<font color=#447700>! SNCOVR  FRACTIONAL SNOW COVER<a name='2829'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2830'></font>
      IMPLICIT NONE<a name='2831'>
<a name='2832'>
      REAL, INTENT(IN)     :: SNEQV,SNUP,SALP,SNOWH<a name='2833'>
      REAL, INTENT(OUT)    :: SNCOVR<a name='2834'>
      REAL                 :: RSNOW, Z0N<a name='2835'>
      LOGICAL, INTENT(IN)  :: UA_PHYS  <font color=#447700>! UA: flag for UA option<a name='2836'></font>
      REAL, INTENT(IN)     :: ZTOPV    <font color=#447700>! UA: height of canopy top<a name='2837'></font>
      REAL, INTENT(IN)     :: ZBOTV    <font color=#447700>! UA: height of canopy bottom<a name='2838'></font>
      REAL, INTENT(IN)     :: SHDFAC   <font color=#447700>! UA: vegetation fraction<a name='2839'></font>
      REAL, INTENT(INOUT)  :: XLAI     <font color=#447700>! UA: LAI modified by snow<a name='2840'></font>
      REAL, INTENT(OUT)    :: FVB      <font color=#447700>! UA: frac. veg. w/snow beneath<a name='2841'></font>
      REAL, INTENT(OUT)    :: GAMA     <font color=#447700>! UA: = EXP(-1.* XLAI)<a name='2842'></font>
      REAL, INTENT(OUT)    :: FBUR     <font color=#447700>! UA: fraction of canopy buried<a name='2843'></font>
      REAL, INTENT(OUT)    :: FGSN     <font color=#447700>! UA: ground snow cover fraction<a name='2844'></font>
<a name='2845'>
      REAL ::  SNUPGRD = 0.02          <font color=#447700>! UA: SWE limit for ground cover<a name='2846'></font>
<a name='2847'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2848'></font>
<font color=#447700>! SNUP IS VEG-CLASS DEPENDENT SNOWDEPTH THRESHHOLD (SET IN ROUTINE<a name='2849'></font>
<font color=#447700>! REDPRM) ABOVE WHICH SNOCVR=1.<a name='2850'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2851'></font>
      IF (SNEQV &lt; SNUP) THEN<a name='2852'>
         RSNOW = SNEQV / SNUP<a name='2853'>
         SNCOVR = 1. - ( EXP ( - SALP * RSNOW) - RSNOW * EXP ( - SALP))<a name='2854'>
      ELSE<a name='2855'>
         SNCOVR = 1.0<a name='2856'>
      END IF<a name='2857'>
<a name='2858'>
<font color=#447700>!     FORMULATION OF DICKINSON ET AL. 1986<a name='2859'></font>
<font color=#447700>!     Z0N = 0.035<a name='2860'></font>
<a name='2861'>
<font color=#447700>!        SNCOVR=SNOWH/(SNOWH + 5*Z0N)<a name='2862'></font>
<a name='2863'>
<font color=#447700>!     FORMULATION OF MARSHALL ET AL. 1994<a name='2864'></font>
<font color=#447700>!        SNCOVR=SNEQV/(SNEQV + 2*Z0N)<a name='2865'></font>
<a name='2866'>
      IF(UA_PHYS) THEN<a name='2867'>
<a name='2868'>
<font color=#447700>!---------------------------------------------------------------------<a name='2869'></font>
<font color=#447700>! FGSN: FRACTION OF SOIL COVERED WITH SNOW<a name='2870'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='2871'></font>
        IF (SNEQV &lt; SNUPGRD) THEN<a name='2872'>
         FGSN = SNEQV / SNUPGRD<a name='2873'>
        ELSE<a name='2874'>
         FGSN = 1.0<a name='2875'>
        END IF<a name='2876'>
<font color=#447700>!------------------------------------------------------------------<a name='2877'></font>
<font color=#447700>! FBUR: VERTICAL FRACTION OF VEGETATION COVERED BY SNOW<a name='2878'></font>
<font color=#447700>! GRASS, CROP, AND SHRUB: MULTIPLY 0.4 BY ZTOPV AND ZBOTV BECAUSE <a name='2879'></font>
<font color=#447700>! THEY WILL BE PRESSED DOWN BY THE SNOW.<a name='2880'></font>
<font color=#447700>! FOREST: DON'T NEED TO CHANGE ZTOPV AND ZBOTV.<a name='2881'></font>
<a name='2882'>
        IF(ZBOTV &gt; 0. .AND. SNOWH &gt; ZBOTV) THEN<a name='2883'>
          IF(ZBOTV &lt;= 0.5) THEN<a name='2884'>
            FBUR = (SNOWH - 0.4*ZBOTV) / (0.4*(ZTOPV-ZBOTV)) <font color=#447700>! short veg.<a name='2885'></font>
          ELSE<a name='2886'>
            FBUR = (SNOWH - ZBOTV) / (ZTOPV-ZBOTV)           <font color=#447700>!  tall veg.<a name='2887'></font>
          ENDIF<a name='2888'>
        ELSE<a name='2889'>
          FBUR = 0.<a name='2890'>
        ENDIF<a name='2891'>
<a name='2892'>
        FBUR = MIN(MAX(FBUR,0.0),1.0)<a name='2893'>
<a name='2894'>
<font color=#447700>! XLAI IS ADJUSTED FOR VERTICAL BURYING BY SNOW<a name='2895'></font>
        XLAI = XLAI * (1.0 - FBUR)<a name='2896'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2897'></font>
<font color=#447700>! SNOW-COVERED SOIL: (1-SHDFAC)*FGSN<a name='2898'></font>
<font color=#447700>! VEGETATION WITH SNOW ABOVE DUE TO BURIAL FVEG_SN_AB = SHDFAC*FBUR<a name='2899'></font>
<font color=#447700>! SNOW ON THE GROUND THAT CAN BE "SEEN" BY SATELLITE<a name='2900'></font>
<font color=#447700>! (IF XLAI GOES TO ZERO): GAMA*FVB<a name='2901'></font>
<font color=#447700>! Where GAMA = exp(-XLAI)<a name='2902'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2903'></font>
<a name='2904'>
<font color=#447700>! VEGETATION WITH SNOW BELOW<a name='2905'></font>
        FVB = SHDFAC * FGSN * (1.0 - FBUR)<a name='2906'>
<a name='2907'>
<font color=#447700>! GAMA IS USED TO DIVIDE FVB INTO TWO PARTS:<a name='2908'></font>
<font color=#447700>! GAMA=1 FOR XLAI=0 AND GAMA=0 FOR XLAI=6<a name='2909'></font>
        GAMA = EXP(-1.* XLAI)<a name='2910'>
      ELSE<a name='2911'>
        <font color=#447700>! Define intent(out) terms for .NOT. UA_PHYS case<a name='2912'></font>
        FVB  = 0.0<a name='2913'>
        GAMA = 0.0<a name='2914'>
        FBUR = 0.0<a name='2915'>
        FGSN = 0.0<a name='2916'>
      END IF    <font color=#447700>! UA_PHYS<a name='2917'></font>
<a name='2918'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2919'></font>
  END SUBROUTINE SNFRAC<a name='2920'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2921'></font>
<a name='2922'>
<A NAME='SNKSRC'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNKSRC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2923'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNKSRC</font> (TSNSR,TAVG,SMC,SH2O,ZSOIL,NSOIL,               &amp; <A href='../../call_to/SNKSRC.html' TARGET='index'>4</A>,<A href='../../call_from/SNKSRC.html' TARGET='index'>1</A><a name='2924'>
     &amp;                      SMCMAX,PSISAT,BEXP,DT,K,QTOT)<a name='2925'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2926'></font>
<font color=#447700>! SUBROUTINE SNKSRC<a name='2927'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2928'></font>
<font color=#447700>! CALCULATE SINK/SOURCE TERM OF THE TERMAL DIFFUSION EQUATION. (SH2O) IS<a name='2929'></font>
<font color=#447700>! AVAILABLE LIQUED WATER.<a name='2930'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2931'></font>
      IMPLICIT NONE<a name='2932'>
<a name='2933'>
      INTEGER, INTENT(IN)   :: K,NSOIL<a name='2934'>
      REAL, INTENT(IN)      :: BEXP, DT, PSISAT, QTOT, SMC, SMCMAX,    &amp;<a name='2935'>
                               TAVG<a name='2936'>
      REAL, INTENT(INOUT)   :: SH2O<a name='2937'>
<a name='2938'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN):: ZSOIL<a name='2939'>
<a name='2940'>
      REAL                  :: DF, DZ, DZH, FREE, TSNSR,               &amp;<a name='2941'>
                               TDN, TM, TUP, TZ, X0, XDN, XH2O, XUP<a name='2942'>
<a name='2943'>
      REAL, PARAMETER       :: DH2O = 1.0000E3, HLICE = 3.3350E5,      &amp;<a name='2944'>
                               T0 = 2.7315E2<a name='2945'>
<a name='2946'>
      IF (K == 1) THEN<a name='2947'>
         DZ = - ZSOIL (1)<a name='2948'>
      ELSE<a name='2949'>
         DZ = ZSOIL (K -1) - ZSOIL (K)<a name='2950'>
      END IF<a name='2951'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2952'></font>
<font color=#447700>! VIA FUNCTION FRH2O, COMPUTE POTENTIAL OR 'EQUILIBRIUM' UNFROZEN<a name='2953'></font>
<font color=#447700>! SUPERCOOLED FREE WATER FOR GIVEN SOIL TYPE AND SOIL LAYER TEMPERATURE.<a name='2954'></font>
<font color=#447700>! FUNCTION FRH20 INVOKES EQN (17) FROM V. KOREN ET AL (1999, JGR, VOL.<a name='2955'></font>
<font color=#447700>! 104, PG 19573).  (ASIDE:  LATTER EQN IN JOURNAL IN CENTIGRADE UNITS.<a name='2956'></font>
<font color=#447700>! ROUTINE FRH2O USE FORM OF EQN IN KELVIN UNITS.)<a name='2957'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2958'></font>
<font color=#447700>!      FREE = FRH2O(TAVG,SMC,SH2O,SMCMAX,BEXP,PSISAT)<a name='2959'></font>
<a name='2960'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2961'></font>
<font color=#447700>! IN NEXT BLOCK OF CODE, INVOKE EQN 18 OF V. KOREN ET AL (1999, JGR,<a name='2962'></font>
<font color=#447700>! VOL. 104, PG 19573.)  THAT IS, FIRST ESTIMATE THE NEW AMOUNTOF LIQUID<a name='2963'></font>
<font color=#447700>! WATER, 'XH2O', IMPLIED BY THE SUM OF (1) THE LIQUID WATER AT THE BEGIN<a name='2964'></font>
<font color=#447700>! OF CURRENT TIME STEP, AND (2) THE FREEZE OF THAW CHANGE IN LIQUID<a name='2965'></font>
<font color=#447700>! WATER IMPLIED BY THE HEAT FLUX 'QTOT' PASSED IN FROM ROUTINE HRT.<a name='2966'></font>
<font color=#447700>! SECOND, DETERMINE IF XH2O NEEDS TO BE BOUNDED BY 'FREE' (EQUIL AMT) OR<a name='2967'></font>
<font color=#447700>! IF 'FREE' NEEDS TO BE BOUNDED BY XH2O.<a name='2968'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2969'></font>
      CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#FRH2O'>FRH2O</A><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNKSRC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FRH2O_2"> (FREE,TAVG,SMC,SH2O,SMCMAX,BEXP,PSISAT)<a name='2970'>
<a name='2971'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2972'></font>
<font color=#447700>! FIRST, IF FREEZING AND REMAINING LIQUID LESS THAN LOWER BOUND, THEN<a name='2973'></font>
<font color=#447700>! REDUCE EXTENT OF FREEZING, THEREBY LETTING SOME OR ALL OF HEAT FLUX<a name='2974'></font>
<font color=#447700>! QTOT COOL THE SOIL TEMP LATER IN ROUTINE HRT.<a name='2975'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2976'></font>
      XH2O = SH2O + QTOT * DT / (DH2O * HLICE * DZ)<a name='2977'>
      IF ( XH2O &lt; SH2O .AND. XH2O &lt; FREE) THEN<a name='2978'>
         IF ( FREE &gt; SH2O ) THEN<a name='2979'>
            XH2O = SH2O<a name='2980'>
         ELSE<a name='2981'>
            XH2O = FREE<a name='2982'>
         END IF<a name='2983'>
      END IF<a name='2984'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2985'></font>
<font color=#447700>! SECOND, IF THAWING AND THE INCREASE IN LIQUID WATER GREATER THAN UPPER<a name='2986'></font>
<font color=#447700>! BOUND, THEN REDUCE EXTENT OF THAW, THEREBY LETTING SOME OR ALL OF HEAT<a name='2987'></font>
<font color=#447700>! FLUX QTOT WARM THE SOIL TEMP LATER IN ROUTINE HRT.<a name='2988'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2989'></font>
      IF ( XH2O &gt; SH2O .AND. XH2O &gt; FREE ) THEN<a name='2990'>
         IF ( FREE &lt; SH2O ) THEN<a name='2991'>
            XH2O = SH2O<a name='2992'>
         ELSE<a name='2993'>
            XH2O = FREE<a name='2994'>
         END IF<a name='2995'>
      END IF<a name='2996'>
<a name='2997'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2998'></font>
<font color=#447700>! CALCULATE PHASE-CHANGE HEAT SOURCE/SINK TERM FOR USE IN ROUTINE HRT<a name='2999'></font>
<font color=#447700>! AND UPDATE LIQUID WATER TO REFLCET FINAL FREEZE/THAW INCREMENT.<a name='3000'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3001'></font>
<font color=#447700>!      SNKSRC = -DH2O*HLICE*DZ*(XH2O-SH2O)/DT<a name='3002'></font>
      IF (XH2O &lt; 0.) XH2O = 0.<a name='3003'>
      IF (XH2O &gt; SMC) XH2O = SMC<a name='3004'>
      TSNSR = - DH2O * HLICE * DZ * (XH2O - SH2O)/ DT<a name='3005'>
      SH2O = XH2O<a name='3006'>
<a name='3007'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3008'></font>
  END SUBROUTINE SNKSRC<a name='3009'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3010'></font>
<a name='3011'>
<A NAME='SNOPAC'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOPAC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3012'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOPAC</font> (ETP,ETA,PRCP,PRCPF,SNOWNG,SMC,SMCMAX,SMCWLT,   &amp; <A href='../../call_to/SNOPAC.html' TARGET='index'>3</A>,<A href='../../call_from/SNOPAC.html' TARGET='index'>9</A><a name='3013'>
                          SMCREF,SMCDRY,CMC,CMCMAX,NSOIL,DT,            &amp;<a name='3014'>
                          SBETA,DF1,                                    &amp;<a name='3015'>
                          Q2,T1,SFCTMP,T24,TH2,FDOWN,F1,SSOIL,STC,EPSCA,&amp;<a name='3016'>
                         SFCPRS,BEXP,PC,RCH,RR,CFACTR,SNCOVR,ESD,SNDENS,&amp;<a name='3017'>
                          SNOWH,SH2O,SLOPE,KDT,FRZFACT,PSISAT,          &amp;<a name='3018'>
                          ZSOIL,DWSAT,DKSAT,TBOT,ZBOT,SHDFAC,RUNOFF1,   &amp;<a name='3019'>
                          RUNOFF2,RUNOFF3,EDIR,EC,ET,ETT,NROOT,SNOMLT,  &amp;<a name='3020'>
                          RTDIS,QUARTZ,FXEXP,CSOIL,                     &amp;<a name='3021'>
                          BETA,DRIP,DEW,FLX1,FLX2,FLX3,ESNOW,ETNS,EMISSI,&amp;<a name='3022'>
                          RIBB,SOLDN,                                   &amp;<a name='3023'>
                          ISURBAN,                                      &amp;<a name='3024'>
                          VEGTYP,                                       &amp;<a name='3025'>
                          ETPN,FLX4,UA_PHYS,                            &amp;<a name='3026'>
                          SFHEAD1RT,INFXS1RT,ETPND1,SOILTYP,OPT_THCND   &amp;<a name='3027'>
                         ,QFX_PHY,fasdas,HCPCT_FASDAS                   ) <font color=#447700>!fasdas<a name='3028'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3029'></font>
<font color=#447700>! SUBROUTINE SNOPAC<a name='3030'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3031'></font>
<font color=#447700>! CALCULATE SOIL MOISTURE AND HEAT FLUX VALUES &amp; UPDATE SOIL MOISTURE<a name='3032'></font>
<font color=#447700>! CONTENT AND SOIL HEAT CONTENT VALUES FOR THE CASE WHEN A SNOW PACK IS<a name='3033'></font>
<font color=#447700>! PRESENT.<a name='3034'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3035'></font>
      IMPLICIT NONE<a name='3036'>
<a name='3037'>
      INTEGER, INTENT(IN)   :: OPT_THCND<a name='3038'>
      INTEGER, INTENT(IN)   :: NROOT, NSOIL,VEGTYP,SOILTYP<a name='3039'>
      INTEGER, INTENT(IN)   :: ISURBAN<a name='3040'>
      INTEGER               :: K<a name='3041'>
<font color=#447700>!<a name='3042'></font>
<font color=#447700>! kmh 09/03/2006 add IT16 for surface temperature iteration<a name='3043'></font>
<font color=#447700>!<a name='3044'></font>
      INTEGER               :: IT16<a name='3045'>
      LOGICAL, INTENT(IN)   :: SNOWNG<a name='3046'>
<a name='3047'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edit...<a name='3048'></font>
       REAL, INTENT(INOUT)    ::  SFHEAD1RT,INFXS1RT,ETPND1<a name='3049'>
<a name='3050'>
      REAL, INTENT(IN)      :: BEXP,CFACTR, CMCMAX,CSOIL,DF1,DKSAT,     &amp;<a name='3051'>
                               DT,DWSAT, EPSCA,FDOWN,F1,FXEXP,          &amp;<a name='3052'>
                               FRZFACT,KDT,PC, PRCP,PSISAT,Q2,QUARTZ,   &amp;<a name='3053'>
                               RCH,RR,SBETA,SFCPRS, SFCTMP, SHDFAC,     &amp;<a name='3054'>
                               SLOPE,SMCDRY,SMCMAX,SMCREF,SMCWLT, T24,  &amp;<a name='3055'>
                               TBOT,TH2,ZBOT,EMISSI,SOLDN<a name='3056'>
      REAL, INTENT(INOUT)   :: CMC, BETA, ESD,FLX2,PRCPF,SNOWH,SNCOVR,  &amp;<a name='3057'>
                               SNDENS, T1, RIBB, ETP<a name='3058'>
      REAL, INTENT(OUT)     :: DEW,DRIP,EC,EDIR, ETNS, ESNOW,ETT,       &amp;<a name='3059'>
                               FLX1,FLX3, RUNOFF1,RUNOFF2,RUNOFF3,      &amp;<a name='3060'>
                               SSOIL,SNOMLT<a name='3061'>
      REAL, DIMENSION(1:NSOIL),INTENT(IN)     :: RTDIS,ZSOIL<a name='3062'>
      REAL, DIMENSION(1:NSOIL),INTENT(OUT)    :: ET<a name='3063'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: SMC,SH2O,STC<a name='3064'>
      REAL, DIMENSION(1:NSOIL) :: ET1<a name='3065'>
      REAL                  :: DENOM,DSOIL,DTOT,EC1,EDIR1,ESDFLX,ETA,   &amp;<a name='3066'>
                               ETT1, ESNOW1, ESNOW2, ETA1,ETP1,ETP2,    &amp;<a name='3067'>
                               ETP3, ETNS1, ETANRG, ETAX, EX, FLX3X,    &amp;<a name='3068'>
                               FRCSNO,FRCSOI, PRCP1, QSAT,RSNOW, SEH,   &amp;<a name='3069'>
                               SNCOND,SSOIL1, T11,T12, T12A, T12AX,     &amp;<a name='3070'>
                               T12B, T14, YY, ZZ1<a name='3071'>
<font color=#447700>!                               T12B, T14, YY, ZZ1,EMISSI_S<a name='3072'></font>
<font color=#447700>!<a name='3073'></font>
<font color=#447700>! kmh 01/11/2007 add T15, T16, and DTOT2 for SFC T iteration and snow heat flux<a name='3074'></font>
<font color=#447700>!<a name='3075'></font>
      REAL                  :: T15, T16, DTOT2<a name='3076'>
      REAL, PARAMETER       :: ESDMIN = 1.E-6, LSUBC = 2.501000E+6,     &amp;<a name='3077'>
                               LSUBS = 2.83E+6, TFREEZ = 273.15,        &amp;<a name='3078'>
                               SNOEXP = 2.0<a name='3079'>
      LOGICAL, INTENT(IN)   :: UA_PHYS  <font color=#447700>! UA: flag for UA option<a name='3080'></font>
      REAL, INTENT(INOUT)   :: FLX4     <font color=#447700>! UA: energy removed by canopy<a name='3081'></font>
      REAL, INTENT(IN)      :: ETPN     <font color=#447700>! UA: adjusted pot. evap. [mm/s]<a name='3082'></font>
      REAL                  :: ETP1N    <font color=#447700>! UA: adjusted pot. evap. [m/s]<a name='3083'></font>
<a name='3084'>
<font color=#447700>!<a name='3085'></font>
<font color=#447700>!  FASDAS<a name='3086'></font>
<font color=#447700>!<a name='3087'></font>
      REAL                  :: QFX_PHY<a name='3088'>
      INTEGER               :: fasdas<a name='3089'>
      REAL, INTENT(  OUT)   :: HCPCT_FASDAS<a name='3090'>
<font color=#447700>!<a name='3091'></font>
<font color=#447700>!  END FASDAS<a name='3092'></font>
<font color=#447700>!<a name='3093'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3094'></font>
<font color=#447700>! EXECUTABLE CODE BEGINS HERE:<a name='3095'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3096'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3097'></font>
<font color=#447700>! INITIALIZE EVAP TERMS.<a name='3098'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3099'></font>
<font color=#447700>! conversions:<a name='3100'></font>
<font color=#447700>! ESNOW [KG M-2 S-1]<a name='3101'></font>
<font color=#447700>! ESDFLX [KG M-2 S-1] .le. ESNOW<a name='3102'></font>
<font color=#447700>! ESNOW1 [M S-1]<a name='3103'></font>
<font color=#447700>! ESNOW2 [M]<a name='3104'></font>
<font color=#447700>! ETP [KG M-2 S-1]<a name='3105'></font>
<font color=#447700>! ETP1 [M S-1]<a name='3106'></font>
<font color=#447700>! ETP2 [M]<a name='3107'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3108'></font>
      DEW = 0.<a name='3109'>
      EDIR = 0.<a name='3110'>
      EDIR1 = 0.<a name='3111'>
      EC1 = 0.<a name='3112'>
      EC = 0.<a name='3113'>
<font color=#447700>!      EMISSI_S=0.95    ! For snow<a name='3114'></font>
<a name='3115'>
      DO K = 1,NSOIL<a name='3116'>
         ET (K) = 0.<a name='3117'>
         ET1 (K) = 0.<a name='3118'>
      END DO<a name='3119'>
      ETT = 0.<a name='3120'>
      ETT1 = 0.<a name='3121'>
<a name='3122'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edit...<a name='3123'></font>
      ETPND1 = 0.<a name='3124'>
<a name='3125'>
<a name='3126'>
      ETNS = 0.<a name='3127'>
      ETNS1 = 0.<a name='3128'>
      ESNOW = 0.<a name='3129'>
      ESNOW1 = 0.<a name='3130'>
      ESNOW2 = 0.<a name='3131'>
<a name='3132'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3133'></font>
<font color=#447700>! CONVERT POTENTIAL EVAP (ETP) FROM KG M-2 S-1 TO ETP1 IN M S-1<a name='3134'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3135'></font>
      PRCP1 = PRCPF *0.001<a name='3136'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3137'></font>
<font color=#447700>! IF ETP&lt;0 (DOWNWARD) THEN DEWFALL (=FROSTFALL IN THIS CASE).<a name='3138'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3139'></font>
      BETA = 1.0<a name='3140'>
      IF (ETP &lt;= 0.0) THEN<a name='3141'>
         IF ( ( RIBB &gt;= 0.1 ) .AND. ( FDOWN &gt; 150.0 ) ) THEN<a name='3142'>
            ETP=(MIN(ETP*(1.0-RIBB),0.)*SNCOVR/0.980 + ETP*(0.980-SNCOVR))/0.980<a name='3143'>
         ENDIF<a name='3144'>
         IF(ETP == 0.) BETA = 0.0<a name='3145'>
         ETP1 = ETP * 0.001<a name='3146'>
         IF(UA_PHYS) ETP1N = ETPN * 0.001<a name='3147'>
         DEW = -ETP1<a name='3148'>
         ESNOW2 = ETP1*DT<a name='3149'>
         ETANRG = ETP*((1.-SNCOVR)*LSUBC + SNCOVR*LSUBS)<a name='3150'>
      ELSE<a name='3151'>
         ETP1 = ETP * 0.001<a name='3152'>
         IF(UA_PHYS) ETP1N = ETPN * 0.001<a name='3153'>
         <font color=#447700>!  LAND CASE<a name='3154'></font>
         IF (SNCOVR &lt;  1.) THEN<a name='3155'>
            CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#EVAPO'>EVAPO</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EVAPO_2"> (ETNS1,SMC,NSOIL,CMC,ETP1,DT,ZSOIL,           &amp;<a name='3156'>
                         SH2O,                                       &amp;<a name='3157'>
                         SMCMAX,BEXP,PC,SMCWLT,DKSAT,DWSAT,          &amp;<a name='3158'>
                         SMCREF,SHDFAC,CMCMAX,                       &amp;<a name='3159'>
                         SMCDRY,CFACTR,                              &amp;<a name='3160'>
                         EDIR1,EC1,ET1,ETT1,SFCTMP,Q2,NROOT,RTDIS,   &amp;<a name='3161'>
                         FXEXP, SFHEAD1RT,ETPND1)<a name='3162'>
<font color=#447700>! ----------------------------------------------------------------------------<a name='3163'></font>
            EDIR1 = EDIR1* (1. - SNCOVR)<a name='3164'>
            EC1 = EC1* (1. - SNCOVR)<a name='3165'>
            DO K = 1,NSOIL<a name='3166'>
               ET1 (K) = ET1 (K)* (1. - SNCOVR)<a name='3167'>
            END DO<a name='3168'>
            ETT1 = ETT1*(1.-SNCOVR)<a name='3169'>
<font color=#447700>!            ETNS1 = EDIR1+ EC1+ ETT1<a name='3170'></font>
            ETNS1 = ETNS1*(1.-SNCOVR)<a name='3171'>
<font color=#447700>! ----------------------------------------------------------------------------<a name='3172'></font>
            EDIR = EDIR1*1000.<a name='3173'>
            EC = EC1*1000.<a name='3174'>
            DO K = 1,NSOIL<a name='3175'>
               ET (K) = ET1 (K)*1000.<a name='3176'>
            END DO<a name='3177'>
<font color=#447700>!<a name='3178'></font>
<font color=#447700>! FASDAS<a name='3179'></font>
<font color=#447700>!<a name='3180'></font>
            if( fasdas ==  1 ) then<a name='3181'>
              QFX_PHY = EDIR + EC<a name='3182'>
              DO K=1,NSOIL<a name='3183'>
                 QFX_PHY = QFX_PHY + ET(K)<a name='3184'>
              END DO<a name='3185'>
            endif<a name='3186'>
<font color=#447700>!<a name='3187'></font>
<font color=#447700>! END FASDAS<a name='3188'></font>
<font color=#447700>!<a name='3189'></font>
            ETT = ETT1*1000.<a name='3190'>
            ETNS = ETNS1*1000.<a name='3191'>
<a name='3192'>
<a name='3193'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edit...<a name='3194'></font>
               ETPND1 = ETPND1*1000.<a name='3195'>
<a name='3196'>
<a name='3197'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3198'></font>
<a name='3199'>
         ENDIF<a name='3200'>
         ESNOW = ETP*SNCOVR<a name='3201'>
         IF(UA_PHYS) ESNOW = ETPN*SNCOVR   <font color=#447700>! USE ADJUSTED ETP<a name='3202'></font>
         ESNOW1 = ESNOW*0.001<a name='3203'>
         ESNOW2 = ESNOW1*DT<a name='3204'>
         ETANRG = ESNOW*LSUBS + ETNS*LSUBC<a name='3205'>
      ENDIF<a name='3206'>
<a name='3207'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3208'></font>
<font color=#447700>! IF PRECIP IS FALLING, CALCULATE HEAT FLUX FROM SNOW SFC TO NEWLY<a name='3209'></font>
<font color=#447700>! ACCUMULATING PRECIP.  NOTE THAT THIS REFLECTS THE FLUX APPROPRIATE FOR<a name='3210'></font>
<font color=#447700>! THE NOT-YET-UPDATED SKIN TEMPERATURE (T1).  ASSUMES TEMPERATURE OF THE<a name='3211'></font>
<font color=#447700>! SNOWFALL STRIKING THE GROUND IS =SFCTMP (LOWEST MODEL LEVEL AIR TEMP).<a name='3212'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3213'></font>
      FLX1 = 0.0<a name='3214'>
      IF (SNOWNG) THEN<a name='3215'>
         FLX1 = CPICE * PRCP * (T1- SFCTMP)<a name='3216'>
      ELSE<a name='3217'>
         IF (PRCP &gt;  0.0) FLX1 = CPH2O * PRCP * (T1- SFCTMP)<a name='3218'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3219'></font>
<font color=#447700>! CALCULATE AN 'EFFECTIVE SNOW-GRND SFC TEMP' (T12) BASED ON HEAT FLUXES<a name='3220'></font>
<font color=#447700>! BETWEEN THE SNOW PACK AND THE SOIL AND ON NET RADIATION.<a name='3221'></font>
<font color=#447700>! INCLUDE FLX1 (PRECIP-SNOW SFC) AND FLX2 (FREEZING RAIN LATENT HEAT)<a name='3222'></font>
<font color=#447700>! FLUXES.  FLX1 FROM ABOVE, FLX2 BROUGHT IN VIA COMMOM BLOCK RITE.<a name='3223'></font>
<font color=#447700>! FLX2 REFLECTS FREEZING RAIN LATENT HEAT FLUX USING T1 CALCULATED IN<a name='3224'></font>
<font color=#447700>! PENMAN.<a name='3225'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3226'></font>
      END IF<a name='3227'>
      DSOIL = - (0.5 * ZSOIL (1))<a name='3228'>
      DTOT = SNOWH + DSOIL<a name='3229'>
      DENOM = 1.0+ DF1 / (DTOT * RR * RCH)<a name='3230'>
<font color=#447700>! surface emissivity weighted by snow cover fraction<a name='3231'></font>
<font color=#447700>!      T12A = ( (FDOWN - FLX1 - FLX2 -                                   &amp;<a name='3232'></font>
<font color=#447700>!     &amp;       ((SNCOVR*EMISSI_S)+EMISSI*(1.0-SNCOVR))*SIGMA *T24)/RCH    &amp;<a name='3233'></font>
<font color=#447700>!     &amp;       + TH2 - SFCTMP - ETANRG/RCH ) / RR<a name='3234'></font>
      T12A = ( (FDOWN - FLX1- FLX2- EMISSI * SIGMA * T24)/ RCH                    &amp;<a name='3235'>
                + TH2- SFCTMP - ETANRG / RCH ) / RR<a name='3236'>
<a name='3237'>
      T12B = DF1 * STC (1) / (DTOT * RR * RCH)<a name='3238'>
<a name='3239'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3240'></font>
<font color=#447700>! IF THE 'EFFECTIVE SNOW-GRND SFC TEMP' IS AT OR BELOW FREEZING, NO SNOW<a name='3241'></font>
<font color=#447700>! MELT WILL OCCUR.  SET THE SKIN TEMP TO THIS EFFECTIVE TEMP.  REDUCE<a name='3242'></font>
<font color=#447700>! (BY SUBLIMINATION ) OR INCREASE (BY FROST) THE DEPTH OF THE SNOWPACK,<a name='3243'></font>
<font color=#447700>! DEPENDING ON SIGN OF ETP.<a name='3244'></font>
<font color=#447700>! UPDATE SOIL HEAT FLUX (SSOIL) USING NEW SKIN TEMPERATURE (T1)<a name='3245'></font>
<font color=#447700>! SINCE NO SNOWMELT, SET ACCUMULATED SNOWMELT TO ZERO, SET 'EFFECTIVE'<a name='3246'></font>
<font color=#447700>! PRECIP FROM SNOWMELT TO ZERO, SET PHASE-CHANGE HEAT FLUX FROM SNOWMELT<a name='3247'></font>
<font color=#447700>! TO ZERO.<a name='3248'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3249'></font>
<font color=#447700>! SUB-FREEZING BLOCK<a name='3250'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3251'></font>
      T12 = (SFCTMP + T12A + T12B) / DENOM<a name='3252'>
      IF (T12 &lt;=  TFREEZ) THEN<a name='3253'>
         T1 = T12<a name='3254'>
         SSOIL = DF1 * (T1- STC (1)) / DTOT<a name='3255'>
<font color=#447700>!        ESD = MAX (0.0, ESD- ETP2)<a name='3256'></font>
         ESD = MAX(0.0, ESD-ESNOW2)<a name='3257'>
         FLX3 = 0.0<a name='3258'>
         EX = 0.0<a name='3259'>
<a name='3260'>
         SNOMLT = 0.0<a name='3261'>
         IF(UA_PHYS) FLX4 = 0.0<a name='3262'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3263'></font>
<font color=#447700>! IF THE 'EFFECTIVE SNOW-GRND SFC TEMP' IS ABOVE FREEZING, SNOW MELT<a name='3264'></font>
<font color=#447700>! WILL OCCUR.  CALL THE SNOW MELT RATE,EX AND AMT, SNOMLT.  REVISE THE<a name='3265'></font>
<font color=#447700>! EFFECTIVE SNOW DEPTH.  REVISE THE SKIN TEMP BECAUSE IT WOULD HAVE CHGD<a name='3266'></font>
<font color=#447700>! DUE TO THE LATENT HEAT RELEASED BY THE MELTING. CALC THE LATENT HEAT<a name='3267'></font>
<font color=#447700>! RELEASED, FLX3. SET THE EFFECTIVE PRECIP, PRCP1 TO THE SNOW MELT RATE,<a name='3268'></font>
<font color=#447700>! EX FOR USE IN SMFLX.  ADJUSTMENT TO T1 TO ACCOUNT FOR SNOW PATCHES.<a name='3269'></font>
<font color=#447700>! CALCULATE QSAT VALID AT FREEZING POINT.  NOTE THAT ESAT (SATURATION<a name='3270'></font>
<font color=#447700>! VAPOR PRESSURE) VALUE OF 6.11E+2 USED HERE IS THAT VALID AT FRZZING<a name='3271'></font>
<font color=#447700>! POINT.  NOTE THAT ETP FROM CALL PENMAN IN SFLX IS IGNORED HERE IN<a name='3272'></font>
<font color=#447700>! FAVOR OF BULK ETP OVER 'OPEN WATER' AT FREEZING TEMP.<a name='3273'></font>
<font color=#447700>! UPDATE SOIL HEAT FLUX (S) USING NEW SKIN TEMPERATURE (T1)<a name='3274'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3275'></font>
<font color=#447700>! ABOVE FREEZING BLOCK<a name='3276'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3277'></font>
      ELSE<a name='3278'>
<font color=#447700>!     From V3.9 original code (commented) replaced to allow complete melting of small snow amounts<a name='3279'></font>
<font color=#447700>!        T1 = TFREEZ * SNCOVR ** SNOEXP + T12 * (1.0- SNCOVR ** SNOEXP)<a name='3280'></font>
         T1 = TFREEZ * max(0.01,SNCOVR ** SNOEXP) + T12 * (1.0- max(0.01,SNCOVR ** SNOEXP))<a name='3281'>
         BETA = 1.0<a name='3282'>
<a name='3283'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3284'></font>
<font color=#447700>! IF POTENTIAL EVAP (SUBLIMATION) GREATER THAN DEPTH OF SNOWPACK.<a name='3285'></font>
<font color=#447700>! BETA&lt;1<a name='3286'></font>
<font color=#447700>! SNOWPACK HAS SUBLIMATED AWAY, SET DEPTH TO ZERO.<a name='3287'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3288'></font>
         SSOIL = DF1 * (T1- STC (1)) / DTOT<a name='3289'>
         IF (ESD-ESNOW2 &lt;= ESDMIN) THEN<a name='3290'>
            ESD = 0.0<a name='3291'>
            EX = 0.0<a name='3292'>
            SNOMLT = 0.0<a name='3293'>
            FLX3 = 0.0<a name='3294'>
            IF(UA_PHYS) FLX4 = 0.0<a name='3295'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3296'></font>
<font color=#447700>! SUBLIMATION LESS THAN DEPTH OF SNOWPACK<a name='3297'></font>
<font color=#447700>! SNOWPACK (ESD) REDUCED BY ESNOW2 (DEPTH OF SUBLIMATED SNOW)<a name='3298'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3299'></font>
         ELSE<a name='3300'>
            ESD = ESD-ESNOW2<a name='3301'>
            ETP3 = ETP * LSUBC<a name='3302'>
            SEH = RCH * (T1- TH2)<a name='3303'>
            T14 = T1* T1<a name='3304'>
            T14 = T14* T14<a name='3305'>
<font color=#447700>!           FLX3 = FDOWN - FLX1 - FLX2 -                                 &amp;<a name='3306'></font>
<font color=#447700>!                  ((SNCOVR*EMISSI_S)+EMISSI*(1-SNCOVR))*SIGMA*T14 -     &amp;<a name='3307'></font>
<font color=#447700>!                    SSOIL - SEH - ETANRG<a name='3308'></font>
            FLX3 = FDOWN - FLX1- FLX2- EMISSI*SIGMA * T14- SSOIL - SEH - ETANRG<a name='3309'>
            IF (FLX3 &lt;= 0.0) FLX3 = 0.0<a name='3310'>
<a name='3311'>
            IF(UA_PHYS .AND. FLX4 &gt; 0. .AND. FLX3 &gt; 0.) THEN<a name='3312'>
              IF(FLX3 &gt;= FLX4) THEN<a name='3313'>
                FLX3 = FLX3 - FLX4<a name='3314'>
              ELSE<a name='3315'>
                FLX4 = FLX3<a name='3316'>
                FLX3 = 0.<a name='3317'>
              ENDIF<a name='3318'>
            ELSE<a name='3319'>
              FLX4 = 0.0<a name='3320'>
            ENDIF<a name='3321'>
<a name='3322'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3323'></font>
<font color=#447700>! SNOWMELT REDUCTION DEPENDING ON SNOW COVER<a name='3324'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3325'></font>
            EX = FLX3*0.001/ LSUBF<a name='3326'>
<a name='3327'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3328'></font>
<font color=#447700>! ESDMIN REPRESENTS A SNOWPACK DEPTH THRESHOLD VALUE BELOW WHICH WE<a name='3329'></font>
<font color=#447700>! CHOOSE NOT TO RETAIN ANY SNOWPACK, AND INSTEAD INCLUDE IT IN SNOWMELT.<a name='3330'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3331'></font>
            SNOMLT = EX * DT<a name='3332'>
            IF (ESD- SNOMLT &gt;=  ESDMIN) THEN<a name='3333'>
               ESD = ESD- SNOMLT<a name='3334'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3335'></font>
<font color=#447700>! SNOWMELT EXCEEDS SNOW DEPTH<a name='3336'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3337'></font>
            ELSE<a name='3338'>
               EX = ESD / DT<a name='3339'>
               FLX3 = EX *1000.0* LSUBF<a name='3340'>
               SNOMLT = ESD<a name='3341'>
<a name='3342'>
               ESD = 0.0<a name='3343'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3344'></font>
<font color=#447700>! END OF 'ESD .LE. ETP2' IF-BLOCK<a name='3345'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3346'></font>
            END IF<a name='3347'>
         END IF<a name='3348'>
<a name='3349'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3350'></font>
<font color=#447700>! END OF 'T12 .LE. TFREEZ' IF-BLOCK<a name='3351'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3352'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3353'></font>
<font color=#447700>! IF NON-GLACIAL LAND, ADD SNOWMELT RATE (EX) TO PRECIP RATE TO BE USED<a name='3354'></font>
<font color=#447700>! IN SUBROUTINE SMFLX (SOIL MOISTURE EVOLUTION) VIA INFILTRATION.<a name='3355'></font>
<font color=#447700>!<a name='3356'></font>
<font color=#447700>! RUNOFF/BASEFLOW LATER NEAR THE END OF SFLX (AFTER RETURN FROM CALL TO<a name='3357'></font>
<font color=#447700>! SUBROUTINE SNOPAC)<a name='3358'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3359'></font>
         PRCP1 = PRCP1+ EX<a name='3360'>
<a name='3361'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3362'></font>
<font color=#447700>! SET THE EFFECTIVE POTNL EVAPOTRANSP (ETP1) TO ZERO SINCE THIS IS SNOW<a name='3363'></font>
<font color=#447700>! CASE, SO SURFACE EVAP NOT CALCULATED FROM EDIR, EC, OR ETT IN SMFLX<a name='3364'></font>
<font color=#447700>! (BELOW).<a name='3365'></font>
<font color=#447700>! SMFLX RETURNS UPDATED SOIL MOISTURE VALUES FOR NON-GLACIAL LAND.<a name='3366'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3367'></font>
      END IF<a name='3368'>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#SMFLX'>SMFLX</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMFLX_3"> (SMC,NSOIL,CMC,DT,PRCP1,ZSOIL,                      &amp;<a name='3369'>
                   SH2O,SLOPE,KDT,FRZFACT,                           &amp;<a name='3370'>
                   SMCMAX,BEXP,SMCWLT,DKSAT,DWSAT,                   &amp;<a name='3371'>
                   SHDFAC,CMCMAX,                                    &amp;<a name='3372'>
                   RUNOFF1,RUNOFF2,RUNOFF3,                          &amp;<a name='3373'>
                   EDIR1,EC1,ET1,                                    &amp;<a name='3374'>
                   DRIP, SFHEAD1RT,INFXS1RT)<a name='3375'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3376'></font>
<font color=#447700>! BEFORE CALL SHFLX IN THIS SNOWPACK CASE, SET ZZ1 AND YY ARGUMENTS TO<a name='3377'></font>
<font color=#447700>! SPECIAL VALUES THAT ENSURE THAT GROUND HEAT FLUX CALCULATED IN SHFLX<a name='3378'></font>
<font color=#447700>! MATCHES THAT ALREADY COMPUTER FOR BELOW THE SNOWPACK, THUS THE SFC<a name='3379'></font>
<font color=#447700>! HEAT FLUX TO BE COMPUTED IN SHFLX WILL EFFECTIVELY BE THE FLUX AT THE<a name='3380'></font>
<font color=#447700>! SNOW TOP SURFACE.  T11 IS A DUMMY ARGUEMENT SO WE WILL NOT USE THE<a name='3381'></font>
<font color=#447700>! SKIN TEMP VALUE AS REVISED BY SHFLX.<a name='3382'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3383'></font>
      ZZ1 = 1.0<a name='3384'>
      YY = STC (1) -0.5* SSOIL * ZSOIL (1)* ZZ1/ DF1<a name='3385'>
<a name='3386'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3387'></font>
<font color=#447700>! SHFLX WILL CALC/UPDATE THE SOIL TEMPS.  NOTE:  THE SUB-SFC HEAT FLUX<a name='3388'></font>
<font color=#447700>! (SSOIL1) AND THE SKIN TEMP (T11) OUTPUT FROM THIS SHFLX CALL ARE NOT<a name='3389'></font>
<font color=#447700>! USED  IN ANY SUBSEQUENT CALCULATIONS. RATHER, THEY ARE DUMMY VARIABLES<a name='3390'></font>
<font color=#447700>! HERE IN THE SNOPAC CASE, SINCE THE SKIN TEMP AND SUB-SFC HEAT FLUX ARE<a name='3391'></font>
<font color=#447700>! UPDATED INSTEAD NEAR THE BEGINNING OF THE CALL TO SNOPAC.<a name='3392'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3393'></font>
      T11 = T1<a name='3394'>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#SHFLX'>SHFLX</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHFLX_3"> (SSOIL1,STC,SMC,SMCMAX,NSOIL,T11,DT,YY,ZZ1,ZSOIL,     &amp;<a name='3395'>
                   TBOT,ZBOT,SMCWLT,PSISAT,SH2O,BEXP,F1,DF1,           &amp;<a name='3396'>
                   QUARTZ,CSOIL,VEGTYP,ISURBAN,SOILTYP,OPT_THCND       &amp;<a name='3397'>
                  ,HCPCT_FASDAS                                        ) <font color=#447700>!fasdas<a name='3398'></font>
<a name='3399'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3400'></font>
<font color=#447700>! SNOW DEPTH AND DENSITY ADJUSTMENT BASED ON SNOW COMPACTION.  YY IS<a name='3401'></font>
<font color=#447700>! ASSUMED TO BE THE SOIL TEMPERTURE AT THE TOP OF THE SOIL COLUMN.<a name='3402'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3403'></font>
      <font color=#447700>! LAND<a name='3404'></font>
      IF (ESD &gt;  0.) THEN<a name='3405'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOWPACK'>SNOWPACK</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWPACK_3"> (ESD,DT,SNOWH,SNDENS,T1,YY,SNOMLT,UA_PHYS)<a name='3406'>
      ELSE<a name='3407'>
         ESD = 0.<a name='3408'>
         SNOWH = 0.<a name='3409'>
         SNDENS = 0.<a name='3410'>
         SNCOND = 1.<a name='3411'>
         SNCOVR = 0.<a name='3412'>
      END IF<a name='3413'>
<a name='3414'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3415'></font>
  END SUBROUTINE SNOPAC<a name='3416'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3417'></font>
<a name='3418'>
<a name='3419'>
<A NAME='SNOWPACK'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOWPACK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3420'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWPACK</font> (ESD,DTSEC,SNOWH,SNDENS,TSNOW,TSOIL,SNOMLT,UA_PHYS) <A href='../../call_to/SNOWPACK.html' TARGET='index'>4</A><a name='3421'>
<a name='3422'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3423'></font>
<font color=#447700>! SUBROUTINE SNOWPACK<a name='3424'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3425'></font>
<font color=#447700>! CALCULATE COMPACTION OF SNOWPACK UNDER CONDITIONS OF INCREASING SNOW<a name='3426'></font>
<font color=#447700>! DENSITY, AS OBTAINED FROM AN APPROXIMATE SOLUTION OF E. ANDERSON'S<a name='3427'></font>
<font color=#447700>! DIFFERENTIAL EQUATION (3.29), NOAA TECHNICAL REPORT NWS 19, BY VICTOR<a name='3428'></font>
<font color=#447700>! KOREN, 03/25/95.<a name='3429'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3430'></font>
<font color=#447700>! ESD     WATER EQUIVALENT OF SNOW (M)<a name='3431'></font>
<font color=#447700>! DTSEC   TIME STEP (SEC)<a name='3432'></font>
<font color=#447700>! SNOWH   SNOW DEPTH (M)<a name='3433'></font>
<font color=#447700>! SNDENS  SNOW DENSITY (G/CM3=DIMENSIONLESS FRACTION OF H2O DENSITY)<a name='3434'></font>
<font color=#447700>! TSNOW   SNOW SURFACE TEMPERATURE (K)<a name='3435'></font>
<font color=#447700>! TSOIL   SOIL SURFACE TEMPERATURE (K)<a name='3436'></font>
<a name='3437'>
<font color=#447700>! SUBROUTINE WILL RETURN NEW VALUES OF SNOWH AND SNDENS<a name='3438'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3439'></font>
      IMPLICIT NONE<a name='3440'>
<a name='3441'>
      INTEGER                :: IPOL, J<a name='3442'>
      REAL, INTENT(IN)       :: ESD, DTSEC,TSNOW,TSOIL<a name='3443'>
      REAL, INTENT(INOUT)    :: SNOWH, SNDENS<a name='3444'>
      REAL                   :: BFAC,DSX,DTHR,DW,SNOWHC,PEXP,           &amp;<a name='3445'>
                                TAVGC,TSNOWC,TSOILC,ESDC,ESDCX<a name='3446'>
      REAL, PARAMETER        :: C1 = 0.01, C2 = 21.0, G = 9.81,         &amp;<a name='3447'>
                                KN = 4000.0<a name='3448'>
      LOGICAL, INTENT(IN)    :: UA_PHYS  <font color=#447700>! UA: flag for UA option<a name='3449'></font>
      REAL, INTENT(IN)       :: SNOMLT   <font color=#447700>! UA: snow melt [m]<a name='3450'></font>
      REAL                   :: SNOMLTC  <font color=#447700>! UA: snow melt [cm]<a name='3451'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3452'></font>
<font color=#447700>! CONVERSION INTO SIMULATION UNITS<a name='3453'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3454'></font>
      SNOWHC = SNOWH *100.<a name='3455'>
      ESDC = ESD *100.<a name='3456'>
      IF(UA_PHYS) SNOMLTC = SNOMLT *100.<a name='3457'>
      DTHR = DTSEC /3600.<a name='3458'>
      TSNOWC = TSNOW -273.15<a name='3459'>
      TSOILC = TSOIL -273.15<a name='3460'>
<a name='3461'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3462'></font>
<font color=#447700>! CALCULATING OF AVERAGE TEMPERATURE OF SNOW PACK<a name='3463'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3464'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3465'></font>
<font color=#447700>! CALCULATING OF SNOW DEPTH AND DENSITY AS A RESULT OF COMPACTION<a name='3466'></font>
<font color=#447700>!  SNDENS=DS0*(EXP(BFAC*ESD)-1.)/(BFAC*ESD)<a name='3467'></font>
<font color=#447700>!  BFAC=DTHR*C1*EXP(0.08*TAVGC-C2*DS0)<a name='3468'></font>
<font color=#447700>! NOTE: BFAC*ESD IN SNDENS EQN ABOVE HAS TO BE CAREFULLY TREATED<a name='3469'></font>
<font color=#447700>! NUMERICALLY BELOW:<a name='3470'></font>
<font color=#447700>!   C1 IS THE FRACTIONAL INCREASE IN DENSITY (1/(CM*HR))<a name='3471'></font>
<font color=#447700>!   C2 IS A CONSTANT (CM3/G) KOJIMA ESTIMATED AS 21 CMS/G<a name='3472'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3473'></font>
      TAVGC = 0.5* (TSNOWC + TSOILC)<a name='3474'>
      IF (ESDC &gt;  1.E-2) THEN<a name='3475'>
         ESDCX = ESDC<a name='3476'>
      ELSE<a name='3477'>
         ESDCX = 1.E-2<a name='3478'>
      END IF<a name='3479'>
<a name='3480'>
<font color=#447700>!      DSX = SNDENS*((DEXP(BFAC*ESDC)-1.)/(BFAC*ESDC))<a name='3481'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3482'></font>
<font color=#447700>! THE FUNCTION OF THE FORM (e**x-1)/x EMBEDDED IN ABOVE EXPRESSION<a name='3483'></font>
<font color=#447700>! FOR DSX WAS CAUSING NUMERICAL DIFFICULTIES WHEN THE DENOMINATOR "x"<a name='3484'></font>
<font color=#447700>! (I.E. BFAC*ESDC) BECAME ZERO OR APPROACHED ZERO (DESPITE THE FACT THAT<a name='3485'></font>
<font color=#447700>! THE ANALYTICAL FUNCTION (e**x-1)/x HAS A WELL DEFINED LIMIT AS<a name='3486'></font>
<font color=#447700>! "x" APPROACHES ZERO), HENCE BELOW WE REPLACE THE (e**x-1)/x<a name='3487'></font>
<font color=#447700>! EXPRESSION WITH AN EQUIVALENT, NUMERICALLY WELL-BEHAVED<a name='3488'></font>
<font color=#447700>! POLYNOMIAL EXPANSION.<a name='3489'></font>
<a name='3490'>
<font color=#447700>! NUMBER OF TERMS OF POLYNOMIAL EXPANSION, AND HENCE ITS ACCURACY,<a name='3491'></font>
<font color=#447700>! IS GOVERNED BY ITERATION LIMIT "IPOL".<a name='3492'></font>
<font color=#447700>!      IPOL GREATER THAN 9 ONLY MAKES A DIFFERENCE ON DOUBLE<a name='3493'></font>
<font color=#447700>!            PRECISION (RELATIVE ERRORS GIVEN IN PERCENT %).<a name='3494'></font>
<font color=#447700>!       IPOL=9, FOR REL.ERROR &lt;~ 1.6 E-6 % (8 SIGNIFICANT DIGITS)<a name='3495'></font>
<font color=#447700>!       IPOL=8, FOR REL.ERROR &lt;~ 1.8 E-5 % (7 SIGNIFICANT DIGITS)<a name='3496'></font>
<font color=#447700>!       IPOL=7, FOR REL.ERROR &lt;~ 1.8 E-4 % ...<a name='3497'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3498'></font>
      BFAC = DTHR * C1* EXP (0.08* TAVGC - C2* SNDENS)<a name='3499'>
      IPOL = 4<a name='3500'>
      PEXP = 0.<a name='3501'>
<font color=#447700>!        PEXP = (1. + PEXP)*BFAC*ESDC/REAL(J+1)<a name='3502'></font>
      DO J = IPOL,1, -1<a name='3503'>
         PEXP = (1. + PEXP)* BFAC * ESDCX / REAL (J +1)<a name='3504'>
      END DO<a name='3505'>
<a name='3506'>
      PEXP = PEXP + 1.<a name='3507'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3508'></font>
<font color=#447700>! ABOVE LINE ENDS POLYNOMIAL SUBSTITUTION<a name='3509'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3510'></font>
<font color=#447700>!     END OF KOREAN FORMULATION<a name='3511'></font>
<a name='3512'>
<font color=#447700>!     BASE FORMULATION (COGLEY ET AL., 1990)<a name='3513'></font>
<font color=#447700>!     CONVERT DENSITY FROM G/CM3 TO KG/M3<a name='3514'></font>
<font color=#447700>!       DSM=SNDENS*1000.0<a name='3515'></font>
<a name='3516'>
<font color=#447700>!       DSX=DSM+DTSEC*0.5*DSM*G*ESD/<a name='3517'></font>
<font color=#447700>!    &amp;      (1E7*EXP(-0.02*DSM+KN/(TAVGC+273.16)-14.643))<a name='3518'></font>
<a name='3519'>
<font color=#447700>!  &amp;   CONVERT DENSITY FROM KG/M3 TO G/CM3<a name='3520'></font>
<font color=#447700>!       DSX=DSX/1000.0<a name='3521'></font>
<a name='3522'>
<font color=#447700>!     END OF COGLEY ET AL. FORMULATION<a name='3523'></font>
<a name='3524'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3525'></font>
<font color=#447700>! SET UPPER/LOWER LIMIT ON SNOW DENSITY<a name='3526'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3527'></font>
      DSX = SNDENS * (PEXP)<a name='3528'>
      IF (DSX &gt; 0.40) DSX = 0.40<a name='3529'>
      IF (DSX &lt; 0.05) DSX = 0.05<a name='3530'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3531'></font>
<font color=#447700>! UPDATE OF SNOW DEPTH AND DENSITY DEPENDING ON LIQUID WATER DURING<a name='3532'></font>
<font color=#447700>! SNOWMELT.  ASSUMED THAT 13% OF LIQUID WATER CAN BE STORED IN SNOW PER<a name='3533'></font>
<font color=#447700>! DAY DURING SNOWMELT TILL SNOW DENSITY 0.40.<a name='3534'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3535'></font>
      SNDENS = DSX<a name='3536'>
      IF (TSNOWC &gt;=  0.) THEN<a name='3537'>
         DW = 0.13* DTHR /24.<a name='3538'>
         IF ( UA_PHYS .AND. TSOILC &gt;= 0.) THEN<a name='3539'>
             DW = MIN (DW, 0.13*SNOMLTC/(ESDCX+0.13*SNOMLTC))<a name='3540'>
         ENDIF<a name='3541'>
         SNDENS = SNDENS * (1. - DW) + DW<a name='3542'>
         IF (SNDENS &gt;=  0.40) SNDENS = 0.40<a name='3543'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3544'></font>
<font color=#447700>! CALCULATE SNOW DEPTH (CM) FROM SNOW WATER EQUIVALENT AND SNOW DENSITY.<a name='3545'></font>
<font color=#447700>! CHANGE SNOW DEPTH UNITS TO METERS<a name='3546'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3547'></font>
      END IF<a name='3548'>
      SNOWHC = ESDC / SNDENS<a name='3549'>
      SNOWH = SNOWHC *0.01<a name='3550'>
<a name='3551'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3552'></font>
  END SUBROUTINE SNOWPACK<a name='3553'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3554'></font>
<a name='3555'>
<A NAME='SNOWZ0'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOWZ0' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3556'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWZ0</font> (SNCOVR,Z0, Z0BRD, SNOWH,FBUR,FGSN,SHDMAX,UA_PHYS) <A href='../../call_to/SNOWZ0.html' TARGET='index'>4</A><a name='3557'>
<a name='3558'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3559'></font>
<font color=#447700>! SUBROUTINE SNOWZ0<a name='3560'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3561'></font>
<font color=#447700>! CALCULATE TOTAL ROUGHNESS LENGTH OVER SNOW<a name='3562'></font>
<font color=#447700>! SNCOVR  FRACTIONAL SNOW COVER<a name='3563'></font>
<font color=#447700>! Z0      ROUGHNESS LENGTH (m)<a name='3564'></font>
<font color=#447700>! Z0S     SNOW ROUGHNESS LENGTH:=0.001 (m)<a name='3565'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3566'></font>
      IMPLICIT NONE<a name='3567'>
      REAL, INTENT(IN)        :: SNCOVR, Z0BRD<a name='3568'>
      REAL, INTENT(OUT)       :: Z0<a name='3569'>
      REAL, PARAMETER         :: Z0S=0.001<a name='3570'>
      REAL, INTENT(IN)        :: SNOWH<a name='3571'>
      REAL                    :: BURIAL<a name='3572'>
      REAL                    :: Z0EFF<a name='3573'>
      LOGICAL, INTENT(IN)     :: UA_PHYS   <font color=#447700>! UA: flag for UA option<a name='3574'></font>
      REAL, INTENT(IN)        :: FBUR      <font color=#447700>! UA: fraction of canopy buried<a name='3575'></font>
      REAL, INTENT(IN)        :: FGSN      <font color=#447700>! UA: ground snow cover fraction<a name='3576'></font>
      REAL, INTENT(IN)        :: SHDMAX    <font color=#447700>! UA: maximum vegetation fraction<a name='3577'></font>
      REAL, PARAMETER         :: Z0G=0.01  <font color=#447700>! UA: soil roughness<a name='3578'></font>
      REAL                    :: FV,A1,A2<a name='3579'>
<a name='3580'>
      IF(UA_PHYS) THEN<a name='3581'>
<a name='3582'>
          FV = SHDMAX * (1.-FBUR)<a name='3583'>
          A1 = (1.-FV)**2*((1.-FGSN**2)*LOG(Z0G) + (FGSN**2)*LOG(Z0S))<a name='3584'>
          A2 = (1.-(1.-FV)**2)*LOG(Z0BRD)<a name='3585'>
          Z0 = EXP(A1+A2)<a name='3586'>
<a name='3587'>
      ELSE<a name='3588'>
<a name='3589'>
<font color=#447700>!m        Z0 = (1.- SNCOVR)* Z0BRD + SNCOVR * Z0S<a name='3590'></font>
          BURIAL = 7.0*Z0BRD - SNOWH<a name='3591'>
          IF(BURIAL.LE.0.0007) THEN<a name='3592'>
              Z0EFF = Z0S<a name='3593'>
          ELSE      <a name='3594'>
              Z0EFF = BURIAL/7.0<a name='3595'>
          ENDIF<a name='3596'>
      <a name='3597'>
          Z0 = (1.- SNCOVR)* Z0BRD + SNCOVR * Z0EFF<a name='3598'>
<a name='3599'>
      ENDIF<a name='3600'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3601'></font>
  END SUBROUTINE SNOWZ0<a name='3602'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3603'></font>
<a name='3604'>
<a name='3605'>
<A NAME='SNOW_NEW'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SNOW_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3606'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOW_NEW</font> (TEMP,NEWSN,SNOWH,SNDENS) <A href='../../call_to/SNOW_NEW.html' TARGET='index'>3</A><a name='3607'>
<a name='3608'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3609'></font>
<font color=#447700>! SUBROUTINE SNOW_NEW<a name='3610'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3611'></font>
<font color=#447700>! CALCULATE SNOW DEPTH AND DENSITY TO ACCOUNT FOR THE NEW SNOWFALL.<a name='3612'></font>
<font color=#447700>! NEW VALUES OF SNOW DEPTH &amp; DENSITY RETURNED.<a name='3613'></font>
<a name='3614'>
<font color=#447700>! TEMP    AIR TEMPERATURE (K)<a name='3615'></font>
<font color=#447700>! NEWSN   NEW SNOWFALL (M)<a name='3616'></font>
<font color=#447700>! SNOWH   SNOW DEPTH (M)<a name='3617'></font>
<font color=#447700>! SNDENS  SNOW DENSITY (G/CM3=DIMENSIONLESS FRACTION OF H2O DENSITY)<a name='3618'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3619'></font>
      IMPLICIT NONE<a name='3620'>
      REAL, INTENT(IN)        :: NEWSN, TEMP<a name='3621'>
      REAL, INTENT(INOUT)     :: SNDENS, SNOWH<a name='3622'>
      REAL                    :: DSNEW, HNEWC, SNOWHC,NEWSNC,TEMPC<a name='3623'>
<a name='3624'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3625'></font>
<font color=#447700>! CONVERSION INTO SIMULATION UNITS<a name='3626'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3627'></font>
      SNOWHC = SNOWH *100.<a name='3628'>
      NEWSNC = NEWSN *100.<a name='3629'>
<a name='3630'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3631'></font>
<font color=#447700>! CALCULATING NEW SNOWFALL DENSITY DEPENDING ON TEMPERATURE<a name='3632'></font>
<font color=#447700>! EQUATION FROM GOTTLIB L. 'A GENERAL RUNOFF MODEL FOR SNOWCOVERED<a name='3633'></font>
<font color=#447700>! AND GLACIERIZED BASIN', 6TH NORDIC HYDROLOGICAL CONFERENCE,<a name='3634'></font>
<font color=#447700>! VEMADOLEN, SWEDEN, 1980, 172-177PP.<a name='3635'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3636'></font>
      TEMPC = TEMP -273.15<a name='3637'>
      IF (TEMPC &lt;=  -15.) THEN<a name='3638'>
         DSNEW = 0.05<a name='3639'>
      ELSE<a name='3640'>
         DSNEW = 0.05+0.0017* (TEMPC +15.)**1.5<a name='3641'>
      END IF<a name='3642'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3643'></font>
<font color=#447700>! ADJUSTMENT OF SNOW DENSITY DEPENDING ON NEW SNOWFALL<a name='3644'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3645'></font>
      HNEWC = NEWSNC / DSNEW<a name='3646'>
      IF (SNOWHC + HNEWC .LT. 1.0E-3) THEN<a name='3647'>
         SNDENS = MAX(DSNEW,SNDENS)<a name='3648'>
      ELSE<a name='3649'>
         SNDENS = (SNOWHC * SNDENS + HNEWC * DSNEW)/ (SNOWHC + HNEWC)<a name='3650'>
      ENDIF<a name='3651'>
      SNOWHC = SNOWHC + HNEWC<a name='3652'>
      SNOWH = SNOWHC *0.01<a name='3653'>
<a name='3654'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3655'></font>
  END SUBROUTINE SNOW_NEW<a name='3656'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3657'></font>
<a name='3658'>
<A NAME='SRT'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SRT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3659'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SRT</font> (RHSTT,EDIR,ET,SH2O,SH2OA,NSOIL,PCPDRP,            &amp; <A href='../../call_to/SRT.html' TARGET='index'>5</A>,<A href='../../call_from/SRT.html' TARGET='index'>10</A><a name='3660'>
                       ZSOIL,DWSAT,DKSAT,SMCMAX,BEXP,RUNOFF1,           &amp;<a name='3661'>
                     RUNOFF2,DT,SMCWLT,SLOPE,KDT,FRZX,SICE,AI,BI,CI,  &amp;<a name='3662'>
                     SFHEAD1RT,INFXS1RT )<a name='3663'>
<a name='3664'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3665'></font>
<font color=#447700>! SUBROUTINE SRT<a name='3666'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3667'></font>
<font color=#447700>! CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY TERM OF THE SOIL<a name='3668'></font>
<font color=#447700>! WATER DIFFUSION EQUATION.  ALSO TO COMPUTE ( PREPARE ) THE MATRIX<a name='3669'></font>
<font color=#447700>! COEFFICIENTS FOR THE TRI-DIAGONAL MATRIX OF THE IMPLICIT TIME SCHEME.<a name='3670'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3671'></font>
      IMPLICIT NONE<a name='3672'>
      INTEGER, INTENT(IN)       :: NSOIL<a name='3673'>
      INTEGER                   :: IALP1, IOHINF, J, JJ,  K, KS<a name='3674'>
<a name='3675'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edit... Variables used in OV routing infiltration calcs<a name='3676'></font>
       REAL, INTENT(INOUT)     :: SFHEAD1RT, INFXS1RT<a name='3677'>
       REAL                    :: SFCWATR,chcksm<a name='3678'>
<a name='3679'>
<a name='3680'>
<a name='3681'>
      REAL, INTENT(IN)          :: BEXP, DKSAT, DT, DWSAT, EDIR, FRZX,  &amp;<a name='3682'>
                                   KDT, PCPDRP, SLOPE, SMCMAX, SMCWLT<a name='3683'>
      REAL, INTENT(OUT)         :: RUNOFF1, RUNOFF2<a name='3684'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: ET, SH2O, SH2OA, SICE,  &amp;<a name='3685'>
                                                ZSOIL<a name='3686'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT)  :: RHSTT<a name='3687'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT)  :: AI, BI, CI<a name='3688'>
      REAL, DIMENSION(1:NSOIL)  :: DMAX<a name='3689'>
      REAL                      :: ACRT, DD, DDT, DDZ, DDZ2, DENOM,     &amp;<a name='3690'>
                                   DENOM2,DICE, DSMDZ, DSMDZ2, DT1,     &amp;<a name='3691'>
                                   FCR,INFMAX,MXSMC,MXSMC2,NUMER,PDDUM, &amp;<a name='3692'>
                                   PX, SICEMAX,SLOPX, SMCAV, SSTT,      &amp;<a name='3693'>
                                   SUM, VAL, WCND, WCND2, WDF, WDF2<a name='3694'>
      INTEGER, PARAMETER        :: CVFRZ = 3<a name='3695'>
<a name='3696'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3697'></font>
<font color=#447700>! FROZEN GROUND VERSION:<a name='3698'></font>
<font color=#447700>! REFERENCE FROZEN GROUND PARAMETER, CVFRZ, IS A SHAPE PARAMETER OF<a name='3699'></font>
<font color=#447700>! AREAL DISTRIBUTION FUNCTION OF SOIL ICE CONTENT WHICH EQUALS 1/CV.<a name='3700'></font>
<font color=#447700>! CV IS A COEFFICIENT OF SPATIAL VARIATION OF SOIL ICE CONTENT.  BASED<a name='3701'></font>
<font color=#447700>! ON FIELD DATA CV DEPENDS ON AREAL MEAN OF FROZEN DEPTH, AND IT CLOSE<a name='3702'></font>
<font color=#447700>! TO CONSTANT = 0.6 IF AREAL MEAN FROZEN DEPTH IS ABOVE 20 CM.  THAT IS<a name='3703'></font>
<font color=#447700>! WHY PARAMETER CVFRZ = 3 (INT{1/0.6*0.6}).<a name='3704'></font>
<font color=#447700>! CURRENT LOGIC DOESN'T ALLOW CVFRZ BE BIGGER THAN 3<a name='3705'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3706'></font>
<a name='3707'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3708'></font>
<font color=#447700>! DETERMINE RAINFALL INFILTRATION RATE AND RUNOFF.  INCLUDE THE<a name='3709'></font>
<font color=#447700>! INFILTRATION FORMULE FROM SCHAAKE AND KOREN MODEL.<a name='3710'></font>
<font color=#447700>! MODIFIED BY Q DUAN<a name='3711'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3712'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3713'></font>
<font color=#447700>! LET SICEMAX BE THE GREATEST, IF ANY, FROZEN WATER CONTENT WITHIN SOIL<a name='3714'></font>
<font color=#447700>! LAYERS.<a name='3715'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3716'></font>
      IOHINF = 1<a name='3717'>
      SICEMAX = 0.0<a name='3718'>
      DO KS = 1,NSOIL<a name='3719'>
         IF (SICE (KS) &gt;  SICEMAX) SICEMAX = SICE (KS)<a name='3720'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3721'></font>
<font color=#447700>! DETERMINE RAINFALL INFILTRATION RATE AND RUNOFF<a name='3722'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3723'></font>
      END DO<a name='3724'>
<a name='3725'>
#ifdef WRF_HYDRO<a name='3726'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edit...<a name='3727'></font>
<font color=#447700>!DJG Use previously merged Precip and Sfchead for infil. cap. calc.<a name='3728'></font>
      SFCWATR = PCPDRP<a name='3729'>
      PDDUM = SFCWATR<a name='3730'>
<font color=#447700>!DJG original   PDDUM = PCPDRP<a name='3731'></font>
      RUNOFF1 = 0.0<a name='3732'>
      INFXS1RT = 0.0<a name='3733'>
#else<a name='3734'>
      PDDUM = PCPDRP<a name='3735'>
      RUNOFF1 = 0.0<a name='3736'>
#endif<a name='3737'>
<a name='3738'>
<a name='3739'>
<a name='3740'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3741'></font>
<font color=#447700>! MODIFIED BY Q. DUAN, 5/16/94<a name='3742'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3743'></font>
<font color=#447700>!        IF (IOHINF == 1) THEN<a name='3744'></font>
<a name='3745'>
#ifdef WRF_HYDRO<a name='3746'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edit...<a name='3747'></font>
<font color=#447700>!DJG IF (PCPDRP /=  0.0) THEN<a name='3748'></font>
      IF (SFCWATR /=  0.0) THEN<a name='3749'>
#else<a name='3750'>
     IF (PCPDRP /=  0.0) THEN<a name='3751'>
#endif<a name='3752'>
         DT1 = DT /86400.<a name='3753'>
         SMCAV = SMCMAX - SMCWLT<a name='3754'>
<a name='3755'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3756'></font>
<font color=#447700>! FROZEN GROUND VERSION:<a name='3757'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3758'></font>
         DMAX (1)= - ZSOIL (1)* SMCAV<a name='3759'>
<a name='3760'>
         DICE = - ZSOIL (1) * SICE (1)<a name='3761'>
         DMAX (1)= DMAX (1)* (1.0- (SH2OA (1) + SICE (1) - SMCWLT)/      &amp;<a name='3762'>
                    SMCAV)<a name='3763'>
<a name='3764'>
         DD = DMAX (1)<a name='3765'>
<a name='3766'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3767'></font>
<font color=#447700>! FROZEN GROUND VERSION:<a name='3768'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3769'></font>
         DO KS = 2,NSOIL<a name='3770'>
<a name='3771'>
            DICE = DICE+ ( ZSOIL (KS -1) - ZSOIL (KS) ) * SICE (KS)<a name='3772'>
            DMAX (KS) = (ZSOIL (KS -1) - ZSOIL (KS))* SMCAV<a name='3773'>
            DMAX (KS) = DMAX (KS)* (1.0- (SH2OA (KS) + SICE (KS)        &amp;<a name='3774'>
                        - SMCWLT)/ SMCAV)<a name='3775'>
            DD = DD+ DMAX (KS)<a name='3776'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3777'></font>
<font color=#447700>! VAL = (1.-EXP(-KDT*SQRT(DT1)))<a name='3778'></font>
<font color=#447700>! IN BELOW, REMOVE THE SQRT IN ABOVE<a name='3779'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3780'></font>
         END DO<a name='3781'>
         VAL = (1. - EXP ( - KDT * DT1))<a name='3782'>
         DDT = DD * VAL<a name='3783'>
#ifdef WRF_HYDRO<a name='3784'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edit...<a name='3785'></font>
<font color=#447700>!DJG        PX = PCPDRP * DT<a name='3786'></font>
         PX = SFCWATR * DT<a name='3787'>
#else<a name='3788'>
         PX = PCPDRP * DT<a name='3789'>
#endif<a name='3790'>
         IF (PX &lt;  0.0) PX = 0.0<a name='3791'>
<a name='3792'>
<a name='3793'>
<a name='3794'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3795'></font>
<font color=#447700>! FROZEN GROUND VERSION:<a name='3796'></font>
<font color=#447700>! REDUCTION OF INFILTRATION BASED ON FROZEN GROUND PARAMETERS<a name='3797'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3798'></font>
         INFMAX = (PX * (DDT / (PX + DDT)))/ DT<a name='3799'>
         FCR = 1.<a name='3800'>
         IF (DICE &gt;  1.E-2) THEN<a name='3801'>
            ACRT = CVFRZ * FRZX / DICE<a name='3802'>
            SUM = 1.<a name='3803'>
            IALP1 = CVFRZ - 1<a name='3804'>
            DO J = 1,IALP1<a name='3805'>
               K = 1<a name='3806'>
               DO JJ = J +1,IALP1<a name='3807'>
                  K = K * JJ<a name='3808'>
               END DO<a name='3809'>
               SUM = SUM + (ACRT ** ( CVFRZ - J)) / FLOAT (K)<a name='3810'>
            END DO<a name='3811'>
            FCR = 1. - EXP ( - ACRT) * SUM<a name='3812'>
         END IF<a name='3813'>
<a name='3814'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3815'></font>
<font color=#447700>! CORRECTION OF INFILTRATION LIMITATION:<a name='3816'></font>
<font color=#447700>! IF INFMAX .LE. HYDROLIC CONDUCTIVITY ASSIGN INFMAX THE VALUE OF<a name='3817'></font>
<font color=#447700>! HYDROLIC CONDUCTIVITY<a name='3818'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3819'></font>
<font color=#447700>!         MXSMC = MAX ( SH2OA(1), SH2OA(2) )<a name='3820'></font>
         INFMAX = INFMAX * FCR<a name='3821'>
<a name='3822'>
         MXSMC = SH2OA (1)<a name='3823'>
         CALL <A href='../../html_code/phys/module_sf_urban.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_urban.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_1"> (WDF,WCND,MXSMC,SMCMAX,BEXP,DKSAT,DWSAT,           &amp;<a name='3824'>
                         SICEMAX)<a name='3825'>
         INFMAX = MAX (INFMAX,WCND)<a name='3826'>
<a name='3827'>
         INFMAX = MIN (INFMAX,PX/DT)<a name='3828'>
#ifdef WRF_HYDRO <a name='3829'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edit...<a name='3830'></font>
<font color=#447700>!DJG       IF (PCPDRP &gt;  INFMAX) THEN<a name='3831'></font>
         IF (SFCWATR &gt; INFMAX) THEN<a name='3832'>
<font color=#447700>!DJG          RUNOFF1 = PCPDRP - INFMAX<a name='3833'></font>
          RUNOFF1 = SFCWATR - INFMAX<a name='3834'>
#else<a name='3835'>
         IF (PCPDRP &gt;  INFMAX) THEN<a name='3836'>
            RUNOFF1 = PCPDRP - INFMAX<a name='3837'>
#endif<a name='3838'>
          INFXS1RT = RUNOFF1*DT*1000.<a name='3839'>
          PDDUM = INFMAX<a name='3840'>
         END IF<a name='3841'>
<a name='3842'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3843'></font>
<font color=#447700>! TO AVOID SPURIOUS DRAINAGE BEHAVIOR, 'UPSTREAM DIFFERENCING' IN LINE<a name='3844'></font>
<font color=#447700>! BELOW REPLACED WITH NEW APPROACH IN 2ND LINE:<a name='3845'></font>
<font color=#447700>! 'MXSMC = MAX(SH2OA(1), SH2OA(2))'<a name='3846'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3847'></font>
      END IF<a name='3848'>
<a name='3849'>
      MXSMC = SH2OA (1)<a name='3850'>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_urban.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_2"> (WDF,WCND,MXSMC,SMCMAX,BEXP,DKSAT,DWSAT,              &amp;<a name='3851'>
                    SICEMAX)<a name='3852'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3853'></font>
<font color=#447700>! CALC THE MATRIX COEFFICIENTS AI, BI, AND CI FOR THE TOP LAYER<a name='3854'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3855'></font>
      DDZ = 1. / ( - .5 * ZSOIL (2) )<a name='3856'>
      AI (1) = 0.0<a name='3857'>
      BI (1) = WDF * DDZ / ( - ZSOIL (1) )<a name='3858'>
<a name='3859'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3860'></font>
<font color=#447700>! CALC RHSTT FOR THE TOP LAYER AFTER CALC'NG THE VERTICAL SOIL MOISTURE<a name='3861'></font>
<font color=#447700>! GRADIENT BTWN THE TOP AND NEXT TO TOP LAYERS.<a name='3862'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3863'></font>
      CI (1) = - BI (1)<a name='3864'>
      DSMDZ = ( SH2O (1) - SH2O (2) ) / ( - .5 * ZSOIL (2) )<a name='3865'>
      RHSTT (1) = (WDF * DSMDZ + WCND- PDDUM + EDIR + ET (1))/ ZSOIL (1)<a name='3866'>
<a name='3867'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3868'></font>
<font color=#447700>! INITIALIZE DDZ2<a name='3869'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3870'></font>
      SSTT = WDF * DSMDZ + WCND+ EDIR + ET (1)<a name='3871'>
<a name='3872'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3873'></font>
<font color=#447700>! LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABV PROCESS<a name='3874'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3875'></font>
      DDZ2 = 0.0<a name='3876'>
      DO K = 2,NSOIL<a name='3877'>
         DENOM2 = (ZSOIL (K -1) - ZSOIL (K))<a name='3878'>
         IF (K /= NSOIL) THEN<a name='3879'>
<a name='3880'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3881'></font>
<font color=#447700>! AGAIN, TO AVOID SPURIOUS DRAINAGE BEHAVIOR, 'UPSTREAM DIFFERENCING' IN<a name='3882'></font>
<font color=#447700>! LINE BELOW REPLACED WITH NEW APPROACH IN 2ND LINE:<a name='3883'></font>
<font color=#447700>! 'MXSMC2 = MAX (SH2OA(K), SH2OA(K+1))'<a name='3884'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3885'></font>
            SLOPX = 1.<a name='3886'>
<a name='3887'>
            MXSMC2 = SH2OA (K)<a name='3888'>
            CALL <A href='../../html_code/phys/module_sf_urban.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_urban.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_3"> (WDF2,WCND2,MXSMC2,SMCMAX,BEXP,DKSAT,DWSAT,     &amp;<a name='3889'>
                          SICEMAX)<a name='3890'>
<font color=#447700>! -----------------------------------------------------------------------<a name='3891'></font>
<font color=#447700>! CALC SOME PARTIAL PRODUCTS FOR LATER USE IN CALC'NG RHSTT<a name='3892'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3893'></font>
            DENOM = (ZSOIL (K -1) - ZSOIL (K +1))<a name='3894'>
<a name='3895'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3896'></font>
<font color=#447700>! CALC THE MATRIX COEF, CI, AFTER CALC'NG ITS PARTIAL PRODUCT<a name='3897'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3898'></font>
            DSMDZ2 = (SH2O (K) - SH2O (K +1)) / (DENOM * 0.5)<a name='3899'>
            DDZ2 = 2.0 / DENOM<a name='3900'>
            CI (K) = - WDF2 * DDZ2 / DENOM2<a name='3901'>
<a name='3902'>
         ELSE<a name='3903'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3904'></font>
<font color=#447700>! SLOPE OF BOTTOM LAYER IS INTRODUCED<a name='3905'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3906'></font>
<a name='3907'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3908'></font>
<font color=#447700>! RETRIEVE THE SOIL WATER DIFFUSIVITY AND HYDRAULIC CONDUCTIVITY FOR<a name='3909'></font>
<font color=#447700>! THIS LAYER<a name='3910'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3911'></font>
            SLOPX = SLOPE<a name='3912'>
          CALL <A href='../../html_code/phys/module_sf_urban.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_urban.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_4"> (WDF2,WCND2,SH2OA (NSOIL),SMCMAX,BEXP,DKSAT,DWSAT,     &amp;<a name='3913'>
                            SICEMAX)<a name='3914'>
<a name='3915'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3916'></font>
<font color=#447700>! CALC A PARTIAL PRODUCT FOR LATER USE IN CALC'NG RHSTT<a name='3917'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3918'></font>
<a name='3919'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3920'></font>
<font color=#447700>! SET MATRIX COEF CI TO ZERO<a name='3921'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3922'></font>
            DSMDZ2 = 0.0<a name='3923'>
            CI (K) = 0.0<a name='3924'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3925'></font>
<font color=#447700>! CALC RHSTT FOR THIS LAYER AFTER CALC'NG ITS NUMERATOR<a name='3926'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3927'></font>
         END IF<a name='3928'>
         NUMER = (WDF2 * DSMDZ2) + SLOPX * WCND2- (WDF * DSMDZ)         &amp;<a name='3929'>
                 - WCND+ ET (K)<a name='3930'>
<a name='3931'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3932'></font>
<font color=#447700>! CALC MATRIX COEFS, AI, AND BI FOR THIS LAYER<a name='3933'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3934'></font>
         RHSTT (K) = NUMER / ( - DENOM2)<a name='3935'>
         AI (K) = - WDF * DDZ / DENOM2<a name='3936'>
<a name='3937'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3938'></font>
<font color=#447700>! RESET VALUES OF WDF, WCND, DSMDZ, AND DDZ FOR LOOP TO NEXT LYR<a name='3939'></font>
<font color=#447700>! RUNOFF2:  SUB-SURFACE OR BASEFLOW RUNOFF<a name='3940'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3941'></font>
         BI (K) = - ( AI (K) + CI (K) )<a name='3942'>
         IF (K .eq. NSOIL) THEN<a name='3943'>
            RUNOFF2 = SLOPX * WCND2<a name='3944'>
         END IF<a name='3945'>
         IF (K .ne. NSOIL) THEN<a name='3946'>
            WDF = WDF2<a name='3947'>
            WCND = WCND2<a name='3948'>
            DSMDZ = DSMDZ2<a name='3949'>
            DDZ = DDZ2<a name='3950'>
         END IF<a name='3951'>
      END DO<a name='3952'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3953'></font>
  END SUBROUTINE SRT<a name='3954'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3955'></font>
<a name='3956'>
<A NAME='SSTEP'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SSTEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3957'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SSTEP</font> (SH2OOUT,SH2OIN,CMC,RHSTT,RHSCT,DT,              &amp; <A href='../../call_to/SSTEP.html' TARGET='index'>5</A>,<A href='../../call_from/SSTEP.html' TARGET='index'>3</A><a name='3958'>
                        NSOIL,SMCMAX,CMCMAX,RUNOFF3,ZSOIL,SMC,SICE,     &amp;<a name='3959'>
                        AI,BI,CI, INFXS1RT)<a name='3960'>
<a name='3961'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3962'></font>
<font color=#447700>! SUBROUTINE SSTEP<a name='3963'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3964'></font>
<font color=#447700>! CALCULATE/UPDATE SOIL MOISTURE CONTENT VALUES AND CANOPY MOISTURE<a name='3965'></font>
<font color=#447700>! CONTENT VALUES.<a name='3966'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3967'></font>
      IMPLICIT NONE<a name='3968'>
      INTEGER, INTENT(IN)       :: NSOIL<a name='3969'>
      INTEGER                   :: I, K, KK11<a name='3970'>
<a name='3971'>
<font color=#447700>!!DJG NDHMS/WRF-Hydro edit...<a name='3972'></font>
      REAL, INTENT(INOUT)       :: INFXS1RT<a name='3973'>
      REAL                      :: AVAIL<a name='3974'>
<a name='3975'>
      REAL, INTENT(IN)          :: CMCMAX, DT, SMCMAX<a name='3976'>
      REAL, INTENT(OUT)         :: RUNOFF3<a name='3977'>
      REAL, INTENT(INOUT)       :: CMC<a name='3978'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)     :: SH2OIN, SICE, ZSOIL<a name='3979'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT)    :: SH2OOUT<a name='3980'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT)  :: RHSTT, SMC<a name='3981'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT)  :: AI, BI, CI<a name='3982'>
      REAL, DIMENSION(1:NSOIL)  :: RHSTTin<a name='3983'>
      REAL, DIMENSION(1:NSOIL)  :: CIin<a name='3984'>
      REAL                      :: DDZ, RHSCT, STOT, WPLUS<a name='3985'>
<a name='3986'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3987'></font>
<font color=#447700>! CREATE 'AMOUNT' VALUES OF VARIABLES TO BE INPUT TO THE<a name='3988'></font>
<font color=#447700>! TRI-DIAGONAL MATRIX ROUTINE.<a name='3989'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3990'></font>
      DO K = 1,NSOIL<a name='3991'>
         RHSTT (K) = RHSTT (K) * DT<a name='3992'>
         AI (K) = AI (K) * DT<a name='3993'>
         BI (K) = 1. + BI (K) * DT<a name='3994'>
         CI (K) = CI (K) * DT<a name='3995'>
      END DO<a name='3996'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3997'></font>
<font color=#447700>! COPY VALUES FOR INPUT VARIABLES BEFORE CALL TO ROSR12<a name='3998'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3999'></font>
      DO K = 1,NSOIL<a name='4000'>
         RHSTTin (K) = RHSTT (K)<a name='4001'>
      END DO<a name='4002'>
      DO K = 1,NSOIL<a name='4003'>
         CIin (K) = CI (K)<a name='4004'>
      END DO<a name='4005'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4006'></font>
<font color=#447700>! CALL ROSR12 TO SOLVE THE TRI-DIAGONAL MATRIX<a name='4007'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4008'></font>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#ROSR12'>ROSR12</A><A href='../../html_code/phys/module_sf_urban.F.html#SSTEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROSR12_2"> (CI,AI,BI,CIin,RHSTTin,RHSTT,NSOIL)<a name='4009'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4010'></font>
<font color=#447700>! SUM THE PREVIOUS SMC VALUE AND THE MATRIX SOLUTION TO GET A<a name='4011'></font>
<font color=#447700>! NEW VALUE.  MIN ALLOWABLE VALUE OF SMC WILL BE 0.02.<a name='4012'></font>
<font color=#447700>! RUNOFF3: RUNOFF WITHIN SOIL LAYERS<a name='4013'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4014'></font>
      WPLUS = 0.0<a name='4015'>
      RUNOFF3 = 0.<a name='4016'>
<a name='4017'>
      DDZ = - ZSOIL (1)<a name='4018'>
      DO K = 1,NSOIL<a name='4019'>
         IF (K /= 1) DDZ = ZSOIL (K - 1) - ZSOIL (K)<a name='4020'>
         SH2OOUT (K) = SH2OIN (K) + CI (K) + WPLUS / DDZ<a name='4021'>
         STOT = SH2OOUT (K) + SICE (K)<a name='4022'>
         IF (STOT &gt; SMCMAX) THEN<a name='4023'>
            IF (K .eq. 1) THEN<a name='4024'>
               DDZ = - ZSOIL (1)<a name='4025'>
            ELSE<a name='4026'>
               KK11 = K - 1<a name='4027'>
               DDZ = - ZSOIL (K) + ZSOIL (KK11)<a name='4028'>
            END IF<a name='4029'>
            WPLUS = (STOT - SMCMAX) * DDZ<a name='4030'>
         ELSE<a name='4031'>
            WPLUS = 0.<a name='4032'>
         END IF<a name='4033'>
         SMC (K) = MAX ( MIN (STOT,SMCMAX),0.02 )<a name='4034'>
         SH2OOUT (K) = MAX ( (SMC (K) - SICE (K)),0.0)<a name='4035'>
      END DO<a name='4036'>
#ifdef WRF_HYDRO<a name='4037'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edit...<a name='4038'></font>
<font color=#447700>!DJG Modifications to redstribute WPLUS/RUNOFF3 (soil moisture closure error) to soil profile<a name='4039'></font>
<font color=#447700>!DJG beginning at bottom layer (NSOIL)<a name='4040'></font>
         IF (WPLUS &gt; 0.) THEN<a name='4041'>
           DO K=NSOIL,2,-1<a name='4042'>
<a name='4043'>
               IF (K .eq. 2) THEN     <font color=#447700>!Assign soil depths<a name='4044'></font>
                 DDZ = -ZSOIL(1)<a name='4045'>
               ELSE<a name='4046'>
                 DDZ = ZSOIL(K-2)-ZSOIL(K-1)<a name='4047'>
               END IF<a name='4048'>
<a name='4049'>
               AVAIL = (SMCMAX - SMC(K-1)) * DDZ    <font color=#447700>!Det. Avail. Stor.<a name='4050'></font>
<a name='4051'>
<font color=#447700>!               print *, "ZZZZZ", K,DDZ,AVAIL,WPLUS,SMC(K),SMC(K-1),SMCMAX<a name='4052'></font>
<a name='4053'>
               IF (WPLUS &lt;= AVAIL) THEN<a name='4054'>
                 SMC(K-1) = SMC(K-1) + WPLUS/DDZ<a name='4055'>
                 WPLUS = 0.<a name='4056'>
               ELSE<a name='4057'>
                 SMC(K-1) = SMCMAX<a name='4058'>
                 WPLUS = WPLUS - AVAIL<a name='4059'>
                 IF (K-1 .eq. 1) THEN<a name='4060'>
                   INFXS1RT = INFXS1RT + WPLUS*1000<a name='4061'>
                   WPLUS = 0.<a name='4062'>
                 END IF<a name='4063'>
               END IF<a name='4064'>
<a name='4065'>
<font color=#447700>!             SMC (K) = MAX ( MIN (STOT,SMCMAX),0.02 )<a name='4066'></font>
             SH2OOUT (K) = MAX ( (SMC (K) - SICE (K)),0.0)<a name='4067'>
<a name='4068'>
           END DO<a name='4069'>
         END IF<a name='4070'>
<font color=#447700>!DJG NDHMS/WRF-Hydro edit...End of modification<a name='4071'></font>
#endif<a name='4072'>
<a name='4073'>
<a name='4074'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4075'></font>
<font color=#447700>! UPDATE CANOPY WATER CONTENT/INTERCEPTION (CMC).  CONVERT RHSCT TO<a name='4076'></font>
<font color=#447700>! AN 'AMOUNT' VALUE AND ADD TO PREVIOUS CMC VALUE TO GET NEW CMC.<a name='4077'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4078'></font>
      RUNOFF3 = WPLUS<a name='4079'>
      CMC = CMC + DT * RHSCT<a name='4080'>
      IF (CMC &lt; 1.E-20) CMC = 0.0<a name='4081'>
      CMC = MIN (CMC,CMCMAX)<a name='4082'>
<a name='4083'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4084'></font>
  END SUBROUTINE SSTEP<a name='4085'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4086'></font>
<a name='4087'>
<A NAME='TBND'><A href='../../html_code/phys/module_sf_noahlsm.F.html#TBND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4088'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TBND</font> (TU,TB,ZSOIL,ZBOT,K,NSOIL,TBND1) <A href='../../call_to/TBND.html' TARGET='index'>7</A><a name='4089'>
<a name='4090'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4091'></font>
<font color=#447700>! SUBROUTINE TBND<a name='4092'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4093'></font>
<font color=#447700>! CALCULATE TEMPERATURE ON THE BOUNDARY OF THE LAYER BY INTERPOLATION OF<a name='4094'></font>
<font color=#447700>! THE MIDDLE LAYER TEMPERATURES<a name='4095'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4096'></font>
      IMPLICIT NONE<a name='4097'>
      INTEGER, INTENT(IN)       :: NSOIL<a name='4098'>
      INTEGER                   :: K<a name='4099'>
      REAL, INTENT(IN)          :: TB, TU, ZBOT<a name='4100'>
      REAL, INTENT(OUT)         :: TBND1<a name='4101'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: ZSOIL<a name='4102'>
      REAL                      :: ZB, ZUP<a name='4103'>
      REAL, PARAMETER           :: T0 = 273.15<a name='4104'>
<a name='4105'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4106'></font>
<font color=#447700>! USE SURFACE TEMPERATURE ON THE TOP OF THE FIRST LAYER<a name='4107'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4108'></font>
     IF (K == 1) THEN<a name='4109'>
         ZUP = 0.<a name='4110'>
      ELSE<a name='4111'>
         ZUP = ZSOIL (K -1)<a name='4112'>
      END IF<a name='4113'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4114'></font>
<font color=#447700>! USE DEPTH OF THE CONSTANT BOTTOM TEMPERATURE WHEN INTERPOLATE<a name='4115'></font>
<font color=#447700>! TEMPERATURE INTO THE LAST LAYER BOUNDARY<a name='4116'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4117'></font>
      IF (K ==  NSOIL) THEN<a name='4118'>
         ZB = 2.* ZBOT - ZSOIL (K)<a name='4119'>
      ELSE<a name='4120'>
         ZB = ZSOIL (K +1)<a name='4121'>
      END IF<a name='4122'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4123'></font>
<font color=#447700>! LINEAR INTERPOLATION BETWEEN THE AVERAGE LAYER TEMPERATURES<a name='4124'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4125'></font>
<a name='4126'>
      TBND1 = TU + (TB - TU)* (ZUP - ZSOIL (K))/ (ZUP - ZB)<a name='4127'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4128'></font>
  END SUBROUTINE TBND<a name='4129'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4130'></font>
<a name='4131'>
<a name='4132'>
<A NAME='TDFCND'><A href='../../html_code/phys/module_sf_noahlsm.F.html#TDFCND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4133'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TDFCND</font> ( DF, SMC, QZ, SMCMAX, SH2O, BEXP, PSISAT, SOILTYP, OPT_THCND) <A href='../../call_to/TDFCND.html' TARGET='index'>8</A><a name='4134'>
<a name='4135'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4136'></font>
<font color=#447700>! SUBROUTINE TDFCND<a name='4137'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4138'></font>
<font color=#447700>! CALCULATE THERMAL DIFFUSIVITY AND CONDUCTIVITY OF THE SOIL FOR A GIVEN<a name='4139'></font>
<font color=#447700>! POINT AND TIME.<a name='4140'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4141'></font>
<font color=#447700>! PETERS-LIDARD APPROACH (PETERS-LIDARD et al., 1998)<a name='4142'></font>
<font color=#447700>! June 2001 CHANGES: FROZEN SOIL CONDITION.<a name='4143'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4144'></font>
      IMPLICIT NONE<a name='4145'>
      INTEGER, INTENT(IN)       :: SOILTYP, OPT_THCND  <a name='4146'>
      REAL, INTENT(IN)          :: QZ,  SMC, SMCMAX, SH2O, BEXP, PSISAT<a name='4147'>
      REAL, INTENT(OUT)         :: DF<a name='4148'>
      REAL                      :: AKE, GAMMD, THKDRY, THKICE, THKO,    &amp;<a name='4149'>
                                   THKQTZ,THKSAT,THKS,THKW,SATRATIO,XU, &amp;<a name='4150'>
                                   XUNFROZ,AKEI,AKEL,PSIF,PF  <a name='4151'>
<a name='4152'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4153'></font>
<font color=#447700>! WE NOW GET QUARTZ AS AN INPUT ARGUMENT (SET IN ROUTINE REDPRM):<a name='4154'></font>
<font color=#447700>!      DATA QUARTZ /0.82, 0.10, 0.25, 0.60, 0.52,<a name='4155'></font>
<font color=#447700>!     &amp;             0.35, 0.60, 0.40, 0.82/<a name='4156'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4157'></font>
<font color=#447700>! IF THE SOIL HAS ANY MOISTURE CONTENT COMPUTE A PARTIAL SUM/PRODUCT<a name='4158'></font>
<font color=#447700>! OTHERWISE USE A CONSTANT VALUE WHICH WORKS WELL WITH MOST SOILS<a name='4159'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4160'></font>
<font color=#447700>!  THKW ......WATER THERMAL CONDUCTIVITY<a name='4161'></font>
<font color=#447700>!  THKQTZ ....THERMAL CONDUCTIVITY FOR QUARTZ<a name='4162'></font>
<font color=#447700>!  THKO ......THERMAL CONDUCTIVITY FOR OTHER SOIL COMPONENTS<a name='4163'></font>
<font color=#447700>!  THKS ......THERMAL CONDUCTIVITY FOR THE SOLIDS COMBINED(QUARTZ+OTHER)<a name='4164'></font>
<font color=#447700>!  THKICE ....ICE THERMAL CONDUCTIVITY<a name='4165'></font>
<font color=#447700>!  SMCMAX ....POROSITY (= SMCMAX)<a name='4166'></font>
<font color=#447700>!  QZ .........QUARTZ CONTENT (SOIL TYPE DEPENDENT)<a name='4167'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4168'></font>
<font color=#447700>! USE AS IN PETERS-LIDARD, 1998 (MODIF. FROM JOHANSEN, 1975).<a name='4169'></font>
<a name='4170'>
<font color=#447700>!                                  PABLO GRUNMANN, 08/17/98<a name='4171'></font>
<font color=#447700>! REFS.:<a name='4172'></font>
<font color=#447700>!      FAROUKI, O.T.,1986: THERMAL PROPERTIES OF SOILS. SERIES ON ROCK<a name='4173'></font>
<font color=#447700>!              AND SOIL MECHANICS, VOL. 11, TRANS TECH, 136 PP.<a name='4174'></font>
<font color=#447700>!      JOHANSEN, O., 1975: THERMAL CONDUCTIVITY OF SOILS. PH.D. THESIS,<a name='4175'></font>
<font color=#447700>!              UNIVERSITY OF TRONDHEIM,<a name='4176'></font>
<font color=#447700>!      PETERS-LIDARD, C. D., ET AL., 1998: THE EFFECT OF SOIL THERMAL<a name='4177'></font>
<font color=#447700>!              CONDUCTIVITY PARAMETERIZATION ON SURFACE ENERGY FLUXES<a name='4178'></font>
<font color=#447700>!              AND TEMPERATURES. JOURNAL OF THE ATMOSPHERIC SCIENCES,<a name='4179'></font>
<font color=#447700>!              VOL. 55, PP. 1209-1224.<a name='4180'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4181'></font>
<a name='4182'>
IF ( OPT_THCND == 1 .OR. ( OPT_THCND == 2 .AND. (SOILTYP /= 4 .AND. SOILTYP /= 3)) )THEN<a name='4183'>
<a name='4184'>
<font color=#447700>! NEEDS PARAMETERS<a name='4185'></font>
<font color=#447700>! POROSITY(SOIL TYPE):<a name='4186'></font>
<font color=#447700>!      POROS = SMCMAX<a name='4187'></font>
<font color=#447700>! SATURATION RATIO:<a name='4188'></font>
<font color=#447700>! PARAMETERS  W/(M.K)<a name='4189'></font>
      SATRATIO = SMC / SMCMAX<a name='4190'>
<font color=#447700>! ICE CONDUCTIVITY:<a name='4191'></font>
      THKICE = 2.2<a name='4192'>
<font color=#447700>! WATER CONDUCTIVITY:<a name='4193'></font>
      THKW = 0.57<a name='4194'>
<font color=#447700>! THERMAL CONDUCTIVITY OF "OTHER" SOIL COMPONENTS<a name='4195'></font>
<font color=#447700>!      IF (QZ .LE. 0.2) THKO = 3.0<a name='4196'></font>
      THKO = 2.0<a name='4197'>
<font color=#447700>! QUARTZ' CONDUCTIVITY<a name='4198'></font>
      THKQTZ = 7.7<a name='4199'>
<font color=#447700>! SOLIDS' CONDUCTIVITY<a name='4200'></font>
      THKS = (THKQTZ ** QZ)* (THKO ** (1. - QZ))<a name='4201'>
<a name='4202'>
<font color=#447700>! UNFROZEN FRACTION (FROM 1., i.e., 100%LIQUID, TO 0. (100% FROZEN))<a name='4203'></font>
      XUNFROZ = SH2O / SMC<a name='4204'>
<font color=#447700>! UNFROZEN VOLUME FOR SATURATION (POROSITY*XUNFROZ)<a name='4205'></font>
      XU = XUNFROZ * SMCMAX<a name='4206'>
<a name='4207'>
<font color=#447700>! SATURATED THERMAL CONDUCTIVITY<a name='4208'></font>
      THKSAT = THKS ** (1. - SMCMAX)* THKICE ** (SMCMAX - XU)* THKW **   &amp;<a name='4209'>
         (XU)<a name='4210'>
<a name='4211'>
<font color=#447700>! DRY DENSITY IN KG/M3<a name='4212'></font>
      GAMMD = (1. - SMCMAX)*2700.<a name='4213'>
<a name='4214'>
<font color=#447700>! DRY THERMAL CONDUCTIVITY IN W.M-1.K-1<a name='4215'></font>
      THKDRY = (0.135* GAMMD+ 64.7)/ (2700. - 0.947* GAMMD)<a name='4216'>
<font color=#447700>! FROZEN<a name='4217'></font>
         AKEI = SATRATIO<a name='4218'>
<font color=#447700>! UNFROZEN<a name='4219'></font>
<font color=#447700>! RANGE OF VALIDITY FOR THE KERSTEN NUMBER (AKE)<a name='4220'></font>
<a name='4221'>
<font color=#447700>! KERSTEN NUMBER (USING "FINE" FORMULA, VALID FOR SOILS CONTAINING AT<a name='4222'></font>
<font color=#447700>! LEAST 5% OF PARTICLES WITH DIAMETER LESS THAN 2.E-6 METERS.)<a name='4223'></font>
<font color=#447700>! (FOR "COARSE" FORMULA, SEE PETERS-LIDARD ET AL., 1998).<a name='4224'></font>
<a name='4225'>
         IF ( SATRATIO &gt;  0.1 ) THEN<a name='4226'>
<a name='4227'>
            AKEL = LOG10 (SATRATIO) + 1.0<a name='4228'>
<a name='4229'>
<font color=#447700>! USE K = KDRY<a name='4230'></font>
         ELSE<a name='4231'>
<a name='4232'>
            AKEL = 0.0<a name='4233'>
         END IF<a name='4234'>
      AKE = ((SMC-SH2O)*AKEI + SH2O*AKEL)/SMC<a name='4235'>
<font color=#447700>!  THERMAL CONDUCTIVITY<a name='4236'></font>
<a name='4237'>
<a name='4238'>
      DF = AKE * (THKSAT - THKDRY) + THKDRY<a name='4239'>
<a name='4240'>
    ELSE<a name='4241'>
 <a name='4242'>
<font color=#447700>! use the Mccumber and Pielke approach for silt loam (4), sandy loam (3)<a name='4243'></font>
<a name='4244'>
         PSIF = PSISAT*100.*(SMCMAX/(SMC))**BEXP<a name='4245'>
<font color=#447700>!--- PSIF should be in [CM] to compute PF<a name='4246'></font>
           PF=log10(abs(PSIF))<a name='4247'>
<font color=#447700>!--- HK is for McCumber thermal conductivity<a name='4248'></font>
         IF(PF.LE.5.1) THEN<a name='4249'>
           DF=420.*EXP(-(PF+2.7))<a name='4250'>
         ELSE<a name='4251'>
           DF=.1744<a name='4252'>
         END IF<a name='4253'>
<a name='4254'>
    ENDIF  <font color=#447700>! for OPT_THCND OPTIONS             <a name='4255'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4256'></font>
  END SUBROUTINE TDFCND<a name='4257'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4258'></font>
<a name='4259'>
<A NAME='TMPAVG'><A href='../../html_code/phys/module_sf_noahlsm.F.html#TMPAVG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4260'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TMPAVG</font> (TAVG,TUP,TM,TDN,ZSOIL,NSOIL,K) <A href='../../call_to/TMPAVG.html' TARGET='index'>2</A><a name='4261'>
<a name='4262'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4263'></font>
<font color=#447700>! SUBROUTINE TMPAVG<a name='4264'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4265'></font>
<font color=#447700>! CALCULATE SOIL LAYER AVERAGE TEMPERATURE (TAVG) IN FREEZING/THAWING<a name='4266'></font>
<font color=#447700>! LAYER USING UP, DOWN, AND MIDDLE LAYER TEMPERATURES (TUP, TDN, TM),<a name='4267'></font>
<font color=#447700>! WHERE TUP IS AT TOP BOUNDARY OF LAYER, TDN IS AT BOTTOM BOUNDARY OF<a name='4268'></font>
<font color=#447700>! LAYER.  TM IS LAYER PROGNOSTIC STATE TEMPERATURE.<a name='4269'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4270'></font>
      IMPLICIT NONE<a name='4271'>
      INTEGER  K<a name='4272'>
<a name='4273'>
      INTEGER  NSOIL<a name='4274'>
      REAL     DZ<a name='4275'>
      REAL     DZH<a name='4276'>
      REAL     T0<a name='4277'>
      REAL     TAVG<a name='4278'>
      REAL     TDN<a name='4279'>
      REAL     TM<a name='4280'>
      REAL     TUP<a name='4281'>
      REAL     X0<a name='4282'>
      REAL     XDN<a name='4283'>
      REAL     XUP<a name='4284'>
<a name='4285'>
      REAL     ZSOIL (NSOIL)<a name='4286'>
<a name='4287'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4288'></font>
      PARAMETER (T0 = 2.7315E2)<a name='4289'>
      IF (K .eq. 1) THEN<a name='4290'>
         DZ = - ZSOIL (1)<a name='4291'>
      ELSE<a name='4292'>
         DZ = ZSOIL (K -1) - ZSOIL (K)<a name='4293'>
      END IF<a name='4294'>
<a name='4295'>
      DZH = DZ *0.5<a name='4296'>
      IF (TUP .lt. T0) THEN<a name='4297'>
         IF (TM .lt. T0) THEN<a name='4298'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4299'></font>
<font color=#447700>! TUP, TM, TDN &lt; T0<a name='4300'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4301'></font>
            IF (TDN .lt. T0) THEN<a name='4302'>
               TAVG = (TUP + 2.0* TM + TDN)/ 4.0<a name='4303'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4304'></font>
<font color=#447700>! TUP &amp; TM &lt; T0,  TDN .ge. T0<a name='4305'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4306'></font>
            ELSE<a name='4307'>
               X0 = (T0- TM) * DZH / (TDN - TM)<a name='4308'>
               TAVG = 0.5 * (TUP * DZH + TM * (DZH + X0) + T0* (        &amp;<a name='4309'>
     &amp;               2.* DZH - X0)) / DZ<a name='4310'>
            END IF<a name='4311'>
         ELSE<a name='4312'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4313'></font>
<font color=#447700>! TUP &lt; T0, TM .ge. T0, TDN &lt; T0<a name='4314'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4315'></font>
            IF (TDN .lt. T0) THEN<a name='4316'>
               XUP = (T0- TUP) * DZH / (TM - TUP)<a name='4317'>
               XDN = DZH - (T0- TM) * DZH / (TDN - TM)<a name='4318'>
               TAVG = 0.5 * (TUP * XUP + T0* (2.* DZ - XUP - XDN)       &amp;<a name='4319'>
     &amp;                + TDN * XDN) / DZ<a name='4320'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4321'></font>
<font color=#447700>! TUP &lt; T0, TM .ge. T0, TDN .ge. T0<a name='4322'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4323'></font>
            ELSE<a name='4324'>
               XUP = (T0- TUP) * DZH / (TM - TUP)<a name='4325'>
               TAVG = 0.5 * (TUP * XUP + T0* (2.* DZ - XUP)) / DZ<a name='4326'>
            END IF<a name='4327'>
         END IF<a name='4328'>
      ELSE<a name='4329'>
         IF (TM .lt. T0) THEN<a name='4330'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4331'></font>
<font color=#447700>! TUP .ge. T0, TM &lt; T0, TDN &lt; T0<a name='4332'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4333'></font>
            IF (TDN .lt. T0) THEN<a name='4334'>
               XUP = DZH - (T0- TUP) * DZH / (TM - TUP)<a name='4335'>
               TAVG = 0.5 * (T0* (DZ - XUP) + TM * (DZH + XUP)          &amp;<a name='4336'>
     &amp;                + TDN * DZH) / DZ<a name='4337'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4338'></font>
<font color=#447700>! TUP .ge. T0, TM &lt; T0, TDN .ge. T0<a name='4339'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4340'></font>
            ELSE<a name='4341'>
               XUP = DZH - (T0- TUP) * DZH / (TM - TUP)<a name='4342'>
               XDN = (T0- TM) * DZH / (TDN - TM)<a name='4343'>
               TAVG = 0.5 * (T0* (2.* DZ - XUP - XDN) + TM *            &amp;<a name='4344'>
     &amp; (XUP + XDN)) / DZ<a name='4345'>
            END IF<a name='4346'>
         ELSE<a name='4347'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4348'></font>
<font color=#447700>! TUP .ge. T0, TM .ge. T0, TDN &lt; T0<a name='4349'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4350'></font>
            IF (TDN .lt. T0) THEN<a name='4351'>
               XDN = DZH - (T0- TM) * DZH / (TDN - TM)<a name='4352'>
               TAVG = (T0* (DZ - XDN) +0.5* (T0+ TDN)* XDN) / DZ<a name='4353'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4354'></font>
<font color=#447700>! TUP .ge. T0, TM .ge. T0, TDN .ge. T0<a name='4355'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4356'></font>
            ELSE<a name='4357'>
               TAVG = (TUP + 2.0* TM + TDN) / 4.0<a name='4358'>
            END IF<a name='4359'>
         END IF<a name='4360'>
      END IF<a name='4361'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4362'></font>
  END SUBROUTINE TMPAVG<a name='4363'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4364'></font>
<a name='4365'>
<A NAME='TRANSP'><A href='../../html_code/phys/module_sf_noahlsm.F.html#TRANSP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4366'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TRANSP</font> (ET,NSOIL,ETP1,SMC,CMC,ZSOIL,SHDFAC,SMCWLT,     &amp; <A href='../../call_to/TRANSP.html' TARGET='index'>2</A><a name='4367'>
     &amp;                      CMCMAX,PC,CFACTR,SMCREF,SFCTMP,Q2,NROOT,    &amp;<a name='4368'>
     &amp;                      RTDIS)<a name='4369'>
<a name='4370'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4371'></font>
<font color=#447700>! SUBROUTINE TRANSP<a name='4372'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4373'></font>
<font color=#447700>! CALCULATE TRANSPIRATION FOR THE VEG CLASS.<a name='4374'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4375'></font>
      IMPLICIT NONE<a name='4376'>
      INTEGER  I<a name='4377'>
      INTEGER  K<a name='4378'>
      INTEGER  NSOIL<a name='4379'>
<a name='4380'>
      INTEGER  NROOT<a name='4381'>
      REAL     CFACTR<a name='4382'>
      REAL     CMC<a name='4383'>
      REAL     CMCMAX<a name='4384'>
      REAL     DENOM<a name='4385'>
      REAL     ET (NSOIL)<a name='4386'>
      REAL     ETP1<a name='4387'>
      REAL     ETP1A<a name='4388'>
<font color=#447700>!.....REAL PART(NSOIL)<a name='4389'></font>
      REAL     GX (NROOT)<a name='4390'>
      REAL     PC<a name='4391'>
      REAL     Q2<a name='4392'>
      REAL     RTDIS (NSOIL)<a name='4393'>
      REAL     RTX<a name='4394'>
      REAL     SFCTMP<a name='4395'>
      REAL     SGX<a name='4396'>
      REAL     SHDFAC<a name='4397'>
      REAL     SMC (NSOIL)<a name='4398'>
      REAL     SMCREF<a name='4399'>
      REAL     SMCWLT<a name='4400'>
<a name='4401'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4402'></font>
<font color=#447700>! INITIALIZE PLANT TRANSP TO ZERO FOR ALL SOIL LAYERS.<a name='4403'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4404'></font>
      REAL     ZSOIL (NSOIL)<a name='4405'>
      DO K = 1,NSOIL<a name='4406'>
         ET (K) = 0.<a name='4407'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4408'></font>
<font color=#447700>! CALCULATE AN 'ADJUSTED' POTENTIAL TRANSPIRATION<a name='4409'></font>
<font color=#447700>! IF STATEMENT BELOW TO AVOID TANGENT LINEAR PROBLEMS NEAR ZERO<a name='4410'></font>
<font color=#447700>! NOTE: GX AND OTHER TERMS BELOW REDISTRIBUTE TRANSPIRATION BY LAYER,<a name='4411'></font>
<font color=#447700>! ET(K), AS A FUNCTION OF SOIL MOISTURE AVAILABILITY, WHILE PRESERVING<a name='4412'></font>
<font color=#447700>! TOTAL ETP1A.<a name='4413'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4414'></font>
      END DO<a name='4415'>
      IF (CMC .ne. 0.0) THEN<a name='4416'>
         ETP1A = SHDFAC * PC * ETP1 * (1.0- (CMC / CMCMAX) ** CFACTR)<a name='4417'>
      ELSE<a name='4418'>
         ETP1A = SHDFAC * PC * ETP1<a name='4419'>
      END IF<a name='4420'>
      SGX = 0.0<a name='4421'>
      DO I = 1,NROOT<a name='4422'>
         GX (I) = ( SMC (I) - SMCWLT ) / ( SMCREF - SMCWLT )<a name='4423'>
         GX (I) = MAX ( MIN ( GX (I), 1. ), 0. )<a name='4424'>
         SGX = SGX + GX (I)<a name='4425'>
      END DO<a name='4426'>
<a name='4427'>
      SGX = SGX / NROOT<a name='4428'>
      DENOM = 0.<a name='4429'>
      DO I = 1,NROOT<a name='4430'>
         RTX = RTDIS (I) + GX (I) - SGX<a name='4431'>
         GX (I) = GX (I) * MAX ( RTX, 0. )<a name='4432'>
         DENOM = DENOM + GX (I)<a name='4433'>
      END DO<a name='4434'>
<a name='4435'>
      IF (DENOM .le. 0.0) DENOM = 1.<a name='4436'>
      DO I = 1,NROOT<a name='4437'>
         ET (I) = ETP1A * GX (I) / DENOM<a name='4438'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4439'></font>
<font color=#447700>! ABOVE CODE ASSUMES A VERTICALLY UNIFORM ROOT DISTRIBUTION<a name='4440'></font>
<font color=#447700>! CODE BELOW TESTS A VARIABLE ROOT DISTRIBUTION<a name='4441'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4442'></font>
<font color=#447700>!      ET(1) = ( ZSOIL(1) / ZSOIL(NROOT) ) * GX * ETP1A<a name='4443'></font>
<font color=#447700>!      ET(1) = ( ZSOIL(1) / ZSOIL(NROOT) ) * ETP1A<a name='4444'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4445'></font>
<font color=#447700>! USING ROOT DISTRIBUTION AS WEIGHTING FACTOR<a name='4446'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4447'></font>
<font color=#447700>!      ET(1) = RTDIS(1) * ETP1A<a name='4448'></font>
<font color=#447700>!      ET(1) = ETP1A * PART(1)<a name='4449'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4450'></font>
<font color=#447700>! LOOP DOWN THRU THE SOIL LAYERS REPEATING THE OPERATION ABOVE,<a name='4451'></font>
<font color=#447700>! BUT USING THE THICKNESS OF THE SOIL LAYER (RATHER THAN THE<a name='4452'></font>
<font color=#447700>! ABSOLUTE DEPTH OF EACH LAYER) IN THE FINAL CALCULATION.<a name='4453'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4454'></font>
<font color=#447700>!      DO K = 2,NROOT<a name='4455'></font>
<font color=#447700>!        GX = ( SMC(K) - SMCWLT ) / ( SMCREF - SMCWLT )<a name='4456'></font>
<font color=#447700>!        GX = MAX ( MIN ( GX, 1. ), 0. )<a name='4457'></font>
<font color=#447700>! TEST CANOPY RESISTANCE<a name='4458'></font>
<font color=#447700>!        GX = 1.0<a name='4459'></font>
<font color=#447700>!        ET(K) = ((ZSOIL(K)-ZSOIL(K-1))/ZSOIL(NROOT))*GX*ETP1A<a name='4460'></font>
<font color=#447700>!        ET(K) = ((ZSOIL(K)-ZSOIL(K-1))/ZSOIL(NROOT))*ETP1A<a name='4461'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4462'></font>
<font color=#447700>! USING ROOT DISTRIBUTION AS WEIGHTING FACTOR<a name='4463'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4464'></font>
<font color=#447700>!        ET(K) = RTDIS(K) * ETP1A<a name='4465'></font>
<font color=#447700>!        ET(K) = ETP1A*PART(K)<a name='4466'></font>
<font color=#447700>!      END DO<a name='4467'></font>
      END DO<a name='4468'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4469'></font>
  END SUBROUTINE TRANSP<a name='4470'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4471'></font>
<a name='4472'>
<A NAME='WDFCND'><A href='../../html_code/phys/module_sf_noahlsm.F.html#WDFCND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4473'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>WDFCND</font> (WDF,WCND,SMC,SMCMAX,BEXP,DKSAT,DWSAT,          &amp; <A href='../../call_to/WDFCND.html' TARGET='index'>8</A><a name='4474'>
     &amp;                      SICEMAX)<a name='4475'>
<a name='4476'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4477'></font>
<font color=#447700>! SUBROUTINE WDFCND<a name='4478'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4479'></font>
<font color=#447700>! CALCULATE SOIL WATER DIFFUSIVITY AND SOIL HYDRAULIC CONDUCTIVITY.<a name='4480'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4481'></font>
      IMPLICIT NONE<a name='4482'>
      REAL     BEXP<a name='4483'>
      REAL     DKSAT<a name='4484'>
      REAL     DWSAT<a name='4485'>
      REAL     EXPON<a name='4486'>
      REAL     FACTR1<a name='4487'>
      REAL     FACTR2<a name='4488'>
      REAL     SICEMAX<a name='4489'>
      REAL     SMC<a name='4490'>
      REAL     SMCMAX<a name='4491'>
      REAL     VKwgt<a name='4492'>
      REAL     WCND<a name='4493'>
<a name='4494'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4495'></font>
<font color=#447700>!     CALC THE RATIO OF THE ACTUAL TO THE MAX PSBL SOIL H2O CONTENT<a name='4496'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4497'></font>
      REAL     WDF<a name='4498'>
      FACTR1 = 0.05 / SMCMAX<a name='4499'>
<a name='4500'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4501'></font>
<font color=#447700>! PREP AN EXPNTL COEF AND CALC THE SOIL WATER DIFFUSIVITY<a name='4502'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4503'></font>
      FACTR2 = SMC / SMCMAX<a name='4504'>
      FACTR1 = MIN(FACTR1,FACTR2)<a name='4505'>
      EXPON = BEXP + 2.0<a name='4506'>
<a name='4507'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4508'></font>
<font color=#447700>! FROZEN SOIL HYDRAULIC DIFFUSIVITY.  VERY SENSITIVE TO THE VERTICAL<a name='4509'></font>
<font color=#447700>! GRADIENT OF UNFROZEN WATER. THE LATTER GRADIENT CAN BECOME VERY<a name='4510'></font>
<font color=#447700>! EXTREME IN FREEZING/THAWING SITUATIONS, AND GIVEN THE RELATIVELY<a name='4511'></font>
<font color=#447700>! FEW AND THICK SOIL LAYERS, THIS GRADIENT SUFFERES SERIOUS<a name='4512'></font>
<font color=#447700>! TRUNCTION ERRORS YIELDING ERRONEOUSLY HIGH VERTICAL TRANSPORTS OF<a name='4513'></font>
<font color=#447700>! UNFROZEN WATER IN BOTH DIRECTIONS FROM HUGE HYDRAULIC DIFFUSIVITY.<a name='4514'></font>
<font color=#447700>! THEREFORE, WE FOUND WE HAD TO ARBITRARILY CONSTRAIN WDF<a name='4515'></font>
<font color=#447700>! --<a name='4516'></font>
<font color=#447700>! VERSION D_10CM: ........  FACTR1 = 0.2/SMCMAX<a name='4517'></font>
<font color=#447700>! WEIGHTED APPROACH...................... PABLO GRUNMANN, 28_SEP_1999.<a name='4518'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4519'></font>
      WDF = DWSAT * FACTR2 ** EXPON<a name='4520'>
      IF (SICEMAX .gt. 0.0) THEN<a name='4521'>
         VKWGT = 1./ (1. + (500.* SICEMAX)**3.)<a name='4522'>
         WDF = VKWGT * WDF + (1. - VKWGT)* DWSAT * FACTR1** EXPON<a name='4523'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4524'></font>
<font color=#447700>! RESET THE EXPNTL COEF AND CALC THE HYDRAULIC CONDUCTIVITY<a name='4525'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4526'></font>
      END IF<a name='4527'>
      EXPON = (2.0 * BEXP) + 3.0<a name='4528'>
      WCND = DKSAT * FACTR2 ** EXPON<a name='4529'>
<a name='4530'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4531'></font>
  END SUBROUTINE WDFCND<a name='4532'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4533'></font>
<a name='4534'>
<A NAME='SFCDIF_OFF'><A href='../../html_code/phys/module_sf_noahlsm.F.html#SFCDIF_OFF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4535'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFCDIF_off</font> (ZLM,Z0,THZ0,THLM,SFCSPD,CZIL,AKMS,AKHS)<a name='4536'>
<a name='4537'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4538'></font>
<font color=#447700>! SUBROUTINE SFCDIF (renamed SFCDIF_off to avoid clash with Eta PBL)<a name='4539'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4540'></font>
<font color=#447700>! CALCULATE SURFACE LAYER EXCHANGE COEFFICIENTS VIA ITERATIVE PROCESS.<a name='4541'></font>
<font color=#447700>! SEE CHEN ET AL (1997, BLM)<a name='4542'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4543'></font>
<a name='4544'>
      IMPLICIT NONE<a name='4545'>
      REAL     WWST, WWST2, G, VKRM, EXCM, BETA, BTG, ELFC, WOLD, WNEW<a name='4546'>
      REAL     PIHF, EPSU2, EPSUST, EPSIT, EPSA, ZTMIN, ZTMAX, HPBL,     &amp;<a name='4547'>
     &amp; SQVISC<a name='4548'>
      REAL     RIC, RRIC, FHNEU, RFC, RFAC, ZZ, PSLMU, PSLMS, PSLHU,     &amp;<a name='4549'>
     &amp; PSLHS<a name='4550'>
      REAL     XX, PSPMU, YY, PSPMS, PSPHU, PSPHS, ZLM, Z0, THZ0, THLM<a name='4551'>
      REAL     SFCSPD, CZIL, AKMS, AKHS, ZILFC, ZU, ZT, RDZ, CXCH<a name='4552'>
      REAL     DTHV, DU2, BTGH, WSTAR2, USTAR, ZSLU, ZSLT, RLOGU, RLOGT<a name='4553'>
      REAL     RLMO, ZETALT, ZETALU, ZETAU, ZETAT, XLU4, XLT4, XU4, XT4<a name='4554'>
<font color=#447700>!CC   ......REAL ZTFC<a name='4555'></font>
<a name='4556'>
      REAL     XLU, XLT, XU, XT, PSMZ, SIMM, PSHZ, SIMH, USTARK, RLMN,  &amp;<a name='4557'>
     &amp;         RLMA<a name='4558'>
<a name='4559'>
      INTEGER  ITRMX, ILECH, ITR<a name='4560'>
      PARAMETER                                                         &amp;<a name='4561'>
     &amp;        (WWST = 1.2,WWST2 = WWST * WWST,G = 9.8,VKRM = 0.40,      &amp;<a name='4562'>
     &amp;         EXCM = 0.001                                             &amp;<a name='4563'>
     &amp;        ,BETA = 1./270.,BTG = BETA * G,ELFC = VKRM * BTG          &amp;<a name='4564'>
     &amp;                  ,WOLD =.15,WNEW = 1. - WOLD,ITRMX = 05,         &amp;<a name='4565'>
     &amp;                   PIHF = 3.14159265/2.)<a name='4566'>
      PARAMETER                                                         &amp;<a name='4567'>
     &amp;         (EPSU2 = 1.E-4,EPSUST = 0.07,EPSIT = 1.E-4,EPSA = 1.E-8  &amp;<a name='4568'>
     &amp;         ,ZTMIN = -5.,ZTMAX = 1.,HPBL = 1000.0                    &amp;<a name='4569'>
     &amp;          ,SQVISC = 258.2)<a name='4570'>
      PARAMETER                                                         &amp;<a name='4571'>
     &amp;       (RIC = 0.183,RRIC = 1.0/ RIC,FHNEU = 0.8,RFC = 0.191       &amp;<a name='4572'>
     &amp;        ,RFAC = RIC / (FHNEU * RFC * RFC))<a name='4573'>
<a name='4574'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4575'></font>
<font color=#447700>! NOTE: THE TWO CODE BLOCKS BELOW DEFINE FUNCTIONS<a name='4576'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4577'></font>
<font color=#447700>! LECH'S SURFACE FUNCTIONS<a name='4578'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4579'></font>
      PSLMU (ZZ)= -0.96* log (1.0-4.5* ZZ)<a name='4580'>
      PSLMS (ZZ)= ZZ * RRIC -2.076* (1. -1./ (ZZ +1.))<a name='4581'>
      PSLHU (ZZ)= -0.96* log (1.0-4.5* ZZ)<a name='4582'>
<a name='4583'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4584'></font>
<font color=#447700>! PAULSON'S SURFACE FUNCTIONS<a name='4585'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4586'></font>
      PSLHS (ZZ)= ZZ * RFAC -2.076* (1. -1./ (ZZ +1.))<a name='4587'>
      PSPMU (XX)= -2.* log ( (XX +1.)*0.5) - log ( (XX * XX +1.)*0.5)   &amp;<a name='4588'>
     &amp;        +2.* ATAN (XX)                                            &amp;<a name='4589'>
     &amp;- PIHF<a name='4590'>
      PSPMS (YY)= 5.* YY<a name='4591'>
      PSPHU (XX)= -2.* log ( (XX * XX +1.)*0.5)<a name='4592'>
<a name='4593'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4594'></font>
<font color=#447700>! THIS ROUTINE SFCDIF CAN HANDLE BOTH OVER OPEN WATER (SEA, OCEAN) AND<a name='4595'></font>
<font color=#447700>! OVER SOLID SURFACE (LAND, SEA-ICE).<a name='4596'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4597'></font>
      PSPHS (YY)= 5.* YY<a name='4598'>
<a name='4599'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4600'></font>
<font color=#447700>!     ZTFC: RATIO OF ZOH/ZOM  LESS OR EQUAL THAN 1<a name='4601'></font>
<font color=#447700>!     C......ZTFC=0.1<a name='4602'></font>
<font color=#447700>!     CZIL: CONSTANT C IN Zilitinkevich, S. S.1995,:NOTE ABOUT ZT<a name='4603'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4604'></font>
      ILECH = 0<a name='4605'>
<a name='4606'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4607'></font>
      ZILFC = - CZIL * VKRM * SQVISC<a name='4608'>
<font color=#447700>!     C.......ZT=Z0*ZTFC<a name='4609'></font>
      ZU = Z0<a name='4610'>
      RDZ = 1./ ZLM<a name='4611'>
      CXCH = EXCM * RDZ<a name='4612'>
      DTHV = THLM - THZ0<a name='4613'>
<a name='4614'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4615'></font>
<font color=#447700>! BELJARS CORRECTION OF USTAR<a name='4616'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4617'></font>
      DU2 = MAX (SFCSPD * SFCSPD,EPSU2)<a name='4618'>
<font color=#447700>!cc   If statements to avoid TANGENT LINEAR problems near zero<a name='4619'></font>
      BTGH = BTG * HPBL<a name='4620'>
      IF (BTGH * AKHS * DTHV .ne. 0.0) THEN<a name='4621'>
         WSTAR2 = WWST2* ABS (BTGH * AKHS * DTHV)** (2./3.)<a name='4622'>
      ELSE<a name='4623'>
         WSTAR2 = 0.0<a name='4624'>
      END IF<a name='4625'>
<a name='4626'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4627'></font>
<font color=#447700>! ZILITINKEVITCH APPROACH FOR ZT<a name='4628'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4629'></font>
      USTAR = MAX (SQRT (AKMS * SQRT (DU2+ WSTAR2)),EPSUST)<a name='4630'>
<a name='4631'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4632'></font>
      ZT = EXP (ZILFC * SQRT (USTAR * Z0))* Z0<a name='4633'>
      ZSLU = ZLM + ZU<a name='4634'>
<font color=#447700>!     PRINT*,'ZSLT=',ZSLT<a name='4635'></font>
<font color=#447700>!     PRINT*,'ZLM=',ZLM<a name='4636'></font>
<font color=#447700>!     PRINT*,'ZT=',ZT<a name='4637'></font>
<a name='4638'>
      ZSLT = ZLM + ZT<a name='4639'>
      RLOGU = log (ZSLU / ZU)<a name='4640'>
<a name='4641'>
      RLOGT = log (ZSLT / ZT)<a name='4642'>
<font color=#447700>!     PRINT*,'RLMO=',RLMO<a name='4643'></font>
<font color=#447700>!     PRINT*,'ELFC=',ELFC<a name='4644'></font>
<font color=#447700>!     PRINT*,'AKHS=',AKHS<a name='4645'></font>
<font color=#447700>!     PRINT*,'DTHV=',DTHV<a name='4646'></font>
<font color=#447700>!     PRINT*,'USTAR=',USTAR<a name='4647'></font>
<a name='4648'>
      RLMO = ELFC * AKHS * DTHV / USTAR **3<a name='4649'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4650'></font>
<font color=#447700>! 1./MONIN-OBUKKHOV LENGTH-SCALE<a name='4651'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4652'></font>
      DO ITR = 1,ITRMX<a name='4653'>
         ZETALT = MAX (ZSLT * RLMO,ZTMIN)<a name='4654'>
         RLMO = ZETALT / ZSLT<a name='4655'>
         ZETALU = ZSLU * RLMO<a name='4656'>
         ZETAU = ZU * RLMO<a name='4657'>
<a name='4658'>
         ZETAT = ZT * RLMO<a name='4659'>
         IF (ILECH .eq. 0) THEN<a name='4660'>
            IF (RLMO .lt. 0.)THEN<a name='4661'>
               XLU4 = 1. -16.* ZETALU<a name='4662'>
               XLT4 = 1. -16.* ZETALT<a name='4663'>
               XU4 = 1. -16.* ZETAU<a name='4664'>
<a name='4665'>
               XT4 = 1. -16.* ZETAT<a name='4666'>
               XLU = SQRT (SQRT (XLU4))<a name='4667'>
               XLT = SQRT (SQRT (XLT4))<a name='4668'>
               XU = SQRT (SQRT (XU4))<a name='4669'>
<a name='4670'>
               XT = SQRT (SQRT (XT4))<a name='4671'>
<font color=#447700>!     PRINT*,'-----------1------------'<a name='4672'></font>
<font color=#447700>!     PRINT*,'PSMZ=',PSMZ<a name='4673'></font>
<font color=#447700>!     PRINT*,'PSPMU(ZETAU)=',PSPMU(ZETAU)<a name='4674'></font>
<font color=#447700>!     PRINT*,'XU=',XU<a name='4675'></font>
<font color=#447700>!     PRINT*,'------------------------'<a name='4676'></font>
               PSMZ = PSPMU (XU)<a name='4677'>
               SIMM = PSPMU (XLU) - PSMZ + RLOGU<a name='4678'>
               PSHZ = PSPHU (XT)<a name='4679'>
               SIMH = PSPHU (XLT) - PSHZ + RLOGT<a name='4680'>
            ELSE<a name='4681'>
               ZETALU = MIN (ZETALU,ZTMAX)<a name='4682'>
               ZETALT = MIN (ZETALT,ZTMAX)<a name='4683'>
<font color=#447700>!     PRINT*,'-----------2------------'<a name='4684'></font>
<font color=#447700>!     PRINT*,'PSMZ=',PSMZ<a name='4685'></font>
<font color=#447700>!     PRINT*,'PSPMS(ZETAU)=',PSPMS(ZETAU)<a name='4686'></font>
<font color=#447700>!     PRINT*,'ZETAU=',ZETAU<a name='4687'></font>
<font color=#447700>!     PRINT*,'------------------------'<a name='4688'></font>
               PSMZ = PSPMS (ZETAU)<a name='4689'>
               SIMM = PSPMS (ZETALU) - PSMZ + RLOGU<a name='4690'>
               PSHZ = PSPHS (ZETAT)<a name='4691'>
               SIMH = PSPHS (ZETALT) - PSHZ + RLOGT<a name='4692'>
            END IF<a name='4693'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4694'></font>
<font color=#447700>! LECH'S FUNCTIONS<a name='4695'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4696'></font>
         ELSE<a name='4697'>
            IF (RLMO .lt. 0.)THEN<a name='4698'>
<font color=#447700>!     PRINT*,'-----------3------------'<a name='4699'></font>
<font color=#447700>!     PRINT*,'PSMZ=',PSMZ<a name='4700'></font>
<font color=#447700>!     PRINT*,'PSLMU(ZETAU)=',PSLMU(ZETAU)<a name='4701'></font>
<font color=#447700>!     PRINT*,'ZETAU=',ZETAU<a name='4702'></font>
<font color=#447700>!     PRINT*,'------------------------'<a name='4703'></font>
               PSMZ = PSLMU (ZETAU)<a name='4704'>
               SIMM = PSLMU (ZETALU) - PSMZ + RLOGU<a name='4705'>
               PSHZ = PSLHU (ZETAT)<a name='4706'>
               SIMH = PSLHU (ZETALT) - PSHZ + RLOGT<a name='4707'>
            ELSE<a name='4708'>
               ZETALU = MIN (ZETALU,ZTMAX)<a name='4709'>
<a name='4710'>
               ZETALT = MIN (ZETALT,ZTMAX)<a name='4711'>
<font color=#447700>!     PRINT*,'-----------4------------'<a name='4712'></font>
<font color=#447700>!     PRINT*,'PSMZ=',PSMZ<a name='4713'></font>
<font color=#447700>!     PRINT*,'PSLMS(ZETAU)=',PSLMS(ZETAU)<a name='4714'></font>
<font color=#447700>!     PRINT*,'ZETAU=',ZETAU<a name='4715'></font>
<font color=#447700>!     PRINT*,'------------------------'<a name='4716'></font>
               PSMZ = PSLMS (ZETAU)<a name='4717'>
               SIMM = PSLMS (ZETALU) - PSMZ + RLOGU<a name='4718'>
               PSHZ = PSLHS (ZETAT)<a name='4719'>
               SIMH = PSLHS (ZETALT) - PSHZ + RLOGT<a name='4720'>
            END IF<a name='4721'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4722'></font>
<font color=#447700>! BELJAARS CORRECTION FOR USTAR<a name='4723'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4724'></font>
         END IF<a name='4725'>
<a name='4726'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4727'></font>
<font color=#447700>! ZILITINKEVITCH FIX FOR ZT<a name='4728'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4729'></font>
         USTAR = MAX (SQRT (AKMS * SQRT (DU2+ WSTAR2)),EPSUST)<a name='4730'>
<a name='4731'>
         ZT = EXP (ZILFC * SQRT (USTAR * Z0))* Z0<a name='4732'>
         ZSLT = ZLM + ZT<a name='4733'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4734'></font>
         RLOGT = log (ZSLT / ZT)<a name='4735'>
         USTARK = USTAR * VKRM<a name='4736'>
         AKMS = MAX (USTARK / SIMM,CXCH)<a name='4737'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4738'></font>
<font color=#447700>! IF STATEMENTS TO AVOID TANGENT LINEAR PROBLEMS NEAR ZERO<a name='4739'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4740'></font>
         AKHS = MAX (USTARK / SIMH,CXCH)<a name='4741'>
         IF (BTGH * AKHS * DTHV .ne. 0.0) THEN<a name='4742'>
            WSTAR2 = WWST2* ABS (BTGH * AKHS * DTHV)** (2./3.)<a name='4743'>
         ELSE<a name='4744'>
            WSTAR2 = 0.0<a name='4745'>
         END IF<a name='4746'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4747'></font>
         RLMN = ELFC * AKHS * DTHV / USTAR **3<a name='4748'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4749'></font>
<font color=#447700>!     IF(ABS((RLMN-RLMO)/RLMA).LT.EPSIT)    GO TO 110<a name='4750'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4751'></font>
         RLMA = RLMO * WOLD+ RLMN * WNEW<a name='4752'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4753'></font>
         RLMO = RLMA<a name='4754'>
<font color=#447700>!     PRINT*,'----------------------------'<a name='4755'></font>
<font color=#447700>!     PRINT*,'SFCDIF OUTPUT !  ! ! ! ! ! ! ! !  !   !    !'<a name='4756'></font>
<a name='4757'>
<font color=#447700>!     PRINT*,'ZLM=',ZLM<a name='4758'></font>
<font color=#447700>!     PRINT*,'Z0=',Z0<a name='4759'></font>
<font color=#447700>!     PRINT*,'THZ0=',THZ0<a name='4760'></font>
<font color=#447700>!     PRINT*,'THLM=',THLM<a name='4761'></font>
<font color=#447700>!     PRINT*,'SFCSPD=',SFCSPD<a name='4762'></font>
<font color=#447700>!     PRINT*,'CZIL=',CZIL<a name='4763'></font>
<font color=#447700>!     PRINT*,'AKMS=',AKMS<a name='4764'></font>
<font color=#447700>!     PRINT*,'AKHS=',AKHS<a name='4765'></font>
<font color=#447700>!     PRINT*,'----------------------------'<a name='4766'></font>
<a name='4767'>
      END DO<a name='4768'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4769'></font>
  END SUBROUTINE SFCDIF_off<a name='4770'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4771'></font>
<a name='4772'>
END MODULE module_sf_noahlsm<a name='4773'>
</pre></body></html>