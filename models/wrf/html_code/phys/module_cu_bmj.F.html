<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6'></font>
<font color=#447700>!<a name='7'></font>
<A NAME='MODULE_CU_BMJ'><A href='../../html_code/phys/module_cu_bmj.F.html#MODULE_CU_BMJ' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='8'>
      <font color=#993300>MODULE </font><font color=#cc0000>MODULE_CU_BMJ</font> <A href='../../call_to/MODULE_CU_BMJ.html' TARGET='index'>3</A><a name='9'>
<font color=#447700>!<a name='10'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='11'></font>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/phys/module_cu_bmj.F.html#module_cu_bmj.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_46"><a name='12'>
<font color=#447700>!-----------------------------------------------------------------------<a name='13'></font>
<font color=#447700>!<a name='14'></font>
      REAL,PARAMETER ::                                                 &amp;<a name='15'>
     &amp;                  DSPC=-3000.                                     &amp;<a name='16'>
     &amp;                 ,DTTOP=0.,EFIFC=5.0,EFIMN=0.20,EFMNT=0.70        &amp; <a name='17'>
     &amp;                 ,ELIWV=2.683E6,ENPLO=20000.,ENPUP=15000.         &amp;<a name='18'>
     &amp;                 ,EPSDN=1.05,EPSDT=0.                             &amp;<a name='19'>
     &amp;                 ,EPSNTP=.0001,EPSNTT=.0001,EPSPR=1.E-7           &amp;<a name='20'>
     &amp;                 ,EPSUP=1.00                                      &amp;<a name='21'>
     &amp;                 ,FR=1.00,FSL=0.85,FSS=0.85                       &amp;<a name='22'>
     &amp;                 ,FUP=0.                                          &amp;<a name='23'>
     &amp;                 ,PBM=13000.,PFRZ=15000.,PNO=1000.                &amp;<a name='24'>
     &amp;                 ,PONE=2500.,PQM=20000.                           &amp;<a name='25'>
     &amp;                 ,PSH=20000.,PSHU=45000.                          &amp;<a name='26'>
     &amp;                 ,RENDP=1./(ENPLO-ENPUP)                          &amp;<a name='27'>
     &amp;                 ,RHLSC=0.00,RHHSC=1.10                           &amp;<a name='28'>
     &amp;                 ,ROW=1.E3                                        &amp;<a name='29'>
     &amp;                 ,STABDF=0.90,STABDS=0.90                         &amp;<a name='30'>
     &amp;                 ,STABS=1.0,STRESH=1.10                           &amp;<a name='31'>
     &amp;                 ,DTSHAL=-1.0,TREL=2400.<a name='32'>
<font color=#447700>!<a name='33'></font>
      REAL,PARAMETER :: DTtrigr=-0.0                                    &amp;<a name='34'>
                       ,DTPtrigr=DTtrigr*PONE      <font color=#447700>!&lt;-- Average parcel virtual temperature deficit over depth PONE.<a name='35'></font>
                                                   <font color=#447700>!&lt;-- NOTE: CAPEtrigr is scaled by the cloud base temperature (see below)<a name='36'></font>
<font color=#447700>!<a name='37'></font>
      REAL,PARAMETER :: DSPBFL=-3875.*FR                                &amp;<a name='38'>
     &amp;                 ,DSP0FL=-5875.*FR                                &amp;<a name='39'>
     &amp;                 ,DSPTFL=-1875.*FR                                &amp;<a name='40'>
     &amp;                 ,DSPBFS=-3875.                                   &amp;<a name='41'>
     &amp;                 ,DSP0FS=-5875.                                   &amp;<a name='42'>
     &amp;                 ,DSPTFS=-1875.<a name='43'>
<font color=#447700>!<a name='44'></font>
      REAL,PARAMETER :: PL=2500.,PLQ=70000.,PH=105000.                  &amp;<a name='45'>
     &amp;                 ,THL=210.,THH=365.,THHQ=325.<a name='46'>
<font color=#447700>!<a name='47'></font>
      INTEGER,PARAMETER :: ITB=76,JTB=134,ITBQ=152,JTBQ=440<a name='48'>
<font color=#447700>!<a name='49'></font>
      INTEGER,PARAMETER :: ITREFI_MAX=3<a name='50'>
<font color=#447700>!<a name='51'></font>
<font color=#447700>!***  ARRAYS FOR LOOKUP TABLES<a name='52'></font>
<font color=#447700>!<a name='53'></font>
      REAL,DIMENSION(ITB),PRIVATE,SAVE :: STHE,THE0<a name='54'>
      REAL,DIMENSION(JTB),PRIVATE,SAVE :: QS0,SQS<a name='55'>
      REAL,DIMENSION(ITBQ),PRIVATE,SAVE :: STHEQ,THE0Q<a name='56'>
      REAL,DIMENSION(ITB,JTB),PRIVATE,SAVE :: PTBL<a name='57'>
      REAL,DIMENSION(JTB,ITB),PRIVATE,SAVE :: TTBL<a name='58'>
      REAL,DIMENSION(JTBQ,ITBQ),PRIVATE,SAVE :: TTBLQ<a name='59'>
<a name='60'>
<font color=#447700>!***  SHARE COPIES FOR MODULE_BL_MYJPBL<a name='61'></font>
<font color=#447700>!<a name='62'></font>
      REAL,DIMENSION(JTB) :: QS0_EXP,SQS_EXP<a name='63'>
      REAL,DIMENSION(ITB,JTB) :: PTBL_EXP<a name='64'>
<font color=#447700>!<a name='65'></font>
      REAL,PARAMETER :: RDP=(ITB-1.)/(PH-PL),RDPQ=(ITBQ-1.)/(PH-PLQ)  &amp;<a name='66'>
     &amp;                 ,RDQ=ITB-1,RDTH=(JTB-1.)/(THH-THL)             &amp;<a name='67'>
     &amp;                 ,RDTHE=JTB-1.,RDTHEQ=JTBQ-1.                   &amp;<a name='68'>
     &amp;                 ,RSFCP=1./101300.<a name='69'>
<font color=#447700>!<a name='70'></font>
      REAL,PARAMETER :: AVGEFI=(EFIMN+1.)*0.5<a name='71'>
<font color=#447700>!<a name='72'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='73'></font>
<font color=#447700>!<a name='74'></font>
CONTAINS<a name='75'>
<font color=#447700>!<a name='76'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='77'></font>
<A NAME='BMJDRV'><A href='../../html_code/phys/module_cu_bmj.F.html#BMJDRV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='78'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>BMJDRV</font>(                                                &amp; <A href='../../call_to/BMJDRV.html' TARGET='index'>1</A>,<A href='../../call_from/BMJDRV.html' TARGET='index'>1</A><a name='79'>
     &amp;                  IDS,IDE,JDS,JDE,KDS,KDE                         &amp;<a name='80'>
     &amp;                 ,IMS,IME,JMS,JME,KMS,KME                         &amp;<a name='81'>
     &amp;                 ,ITS,ITE,JTS,JTE,KTS,KTE                         &amp;<a name='82'>
     &amp;                 ,DT,ITIMESTEP,STEPCU                             &amp;<a name='83'>
     &amp;                 ,RAINCV,PRATEC,CUTOP,CUBOT,KPBL                  &amp;<a name='84'>
     &amp;                 ,TH,T,QV                                         &amp;<a name='85'>
     &amp;                 ,PINT,PMID,PI,RHO,DZ8W                           &amp;<a name='86'>
     &amp;                 ,CP,R,ELWV,ELIV,G,TFRZ,D608                      &amp;<a name='87'>
     &amp;                 ,CLDEFI,LOWLYR,XLAND,CU_ACT_FLAG                 &amp;<a name='88'>
                      <font color=#447700>! optional<a name='89'></font>
     &amp;                 ,RTHCUTEN, RQVCUTEN                              &amp;<a name='90'>
     &amp;                                                                  )<a name='91'>
<font color=#447700>!-----------------------------------------------------------------------<a name='92'></font>
      IMPLICIT NONE<a name='93'>
<font color=#447700>!-----------------------------------------------------------------------<a name='94'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='95'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp; <a name='96'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='97'>
<font color=#447700>!<a name='98'></font>
      INTEGER,INTENT(IN) :: ITIMESTEP,STEPCU<a name='99'>
<font color=#447700>!<a name='100'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: KPBL,LOWLYR<a name='101'>
<font color=#447700>!<a name='102'></font>
      REAL,INTENT(IN) :: CP,DT,ELIV,ELWV,G,R,TFRZ,D608<a name='103'>
<font color=#447700>!<a name='104'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: XLAND<a name='105'>
<font color=#447700>!<a name='106'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: DZ8W        &amp;<a name='107'>
     &amp;                                                     ,PI,PINT     &amp;<a name='108'>
     &amp;                                                     ,PMID,QV     &amp;<a name='109'>
     &amp;                                                     ,RHO,T,TH<a name='110'>
<font color=#447700>!<a name='111'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME)                           &amp;<a name='112'>
     &amp;    ,OPTIONAL                                                     &amp;<a name='113'>
     &amp;    ,INTENT(INOUT) ::                        RQVCUTEN,RTHCUTEN <a name='114'>
<font color=#447700>! <a name='115'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: CLDEFI,RAINCV,   &amp;<a name='116'>
           PRATEC<a name='117'>
<font color=#447700>!<a name='118'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: CUBOT,CUTOP<a name='119'>
<font color=#447700>!<a name='120'></font>
      LOGICAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: CU_ACT_FLAG<a name='121'>
<a name='122'>
<font color=#447700>!<a name='123'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='124'></font>
<font color=#447700>!***<a name='125'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='126'></font>
<font color=#447700>!***<a name='127'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='128'></font>
      INTEGER :: LBOT,LPBL,LTOP<a name='129'>
<font color=#447700>!<a name='130'></font>
      REAL :: DTCNVC,LANDMASK,PCPCOL,PSFC,PTOP<a name='131'>
<font color=#447700>! <a name='132'></font>
      REAL,DIMENSION(KTS:KTE) :: DPCOL,DQDT,DTDT,PCOL,QCOL,TCOL<a name='133'>
<font color=#447700>!<a name='134'></font>
      INTEGER :: I,J,K,KFLIP,LMH<a name='135'>
<a name='136'>
<font color=#447700>!***  Begin debugging convection<a name='137'></font>
      REAL :: DELQ,DELT,PLYR<a name='138'>
      INTEGER :: IMD,JMD<a name='139'>
      LOGICAL :: PRINT_DIAG<a name='140'>
<font color=#447700>!***  End debugging convection<a name='141'></font>
<font color=#447700>!<a name='142'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='143'></font>
<font color=#447700>!*********************************************************************** <a name='144'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='145'></font>
<font color=#447700>!<a name='146'></font>
<font color=#447700>!***  PREPARE TO CALL BMJ CONVECTION SCHEME<a name='147'></font>
<font color=#447700>!<a name='148'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='149'></font>
<a name='150'>
<font color=#447700>!***  Begin debugging convection<a name='151'></font>
      IMD=(IMS+IME)/2<a name='152'>
      JMD=(JMS+JME)/2<a name='153'>
      PRINT_DIAG=.FALSE.<a name='154'>
<font color=#447700>!***  End debugging convection<a name='155'></font>
<a name='156'>
<font color=#447700>!<a name='157'></font>
        DO J=JTS,JTE<a name='158'>
        DO I=ITS,ITE<a name='159'>
          CU_ACT_FLAG(I,J)=.TRUE.<a name='160'>
        ENDDO<a name='161'>
        ENDDO<a name='162'>
<a name='163'>
<font color=#447700>!<a name='164'></font>
        DTCNVC=DT*STEPCU<a name='165'>
<font color=#447700>!<a name='166'></font>
        DO J=JTS,JTE  <a name='167'>
        DO I=ITS,ITE<a name='168'>
<font color=#447700>!<a name='169'></font>
          DO K=KTS,KTE<a name='170'>
            DQDT(K)=0.<a name='171'>
            DTDT(K)=0.<a name='172'>
          ENDDO<a name='173'>
<font color=#447700>!<a name='174'></font>
          RAINCV(I,J)=0.<a name='175'>
          PRATEC(I,J)=0.<a name='176'>
          PCPCOL=0.<a name='177'>
          PSFC=PINT(I,LOWLYR(I,J),J)<a name='178'>
          PTOP=PINT(I,KTE+1,J)      <font color=#447700>! KTE+1=KME<a name='179'></font>
<font color=#447700>!<a name='180'></font>
<font color=#447700>!***  CONVERT TO BMJ LAND MASK (1.0 FOR SEA; 0.0 FOR LAND)<a name='181'></font>
<font color=#447700>!<a name='182'></font>
          LANDMASK=XLAND(I,J)-1.<a name='183'>
<font color=#447700>!<a name='184'></font>
<font color=#447700>!***  FILL 1-D VERTICAL ARRAYS <a name='185'></font>
<font color=#447700>!***  AND FLIP DIRECTION SINCE BMJ SCHEME <a name='186'></font>
<font color=#447700>!***  COUNTS DOWNWARD FROM THE DOMAIN'S TOP<a name='187'></font>
<font color=#447700>!<a name='188'></font>
          DO K=KTS,KTE<a name='189'>
            KFLIP=KTE+1-K<a name='190'>
<font color=#447700>!<a name='191'></font>
<font color=#447700>!***  CONVERT FROM MIXING RATIO TO SPECIFIC HUMIDITY<a name='192'></font>
<font color=#447700>!<a name='193'></font>
            QCOL(K)=MAX(EPSQ,QV(I,KFLIP,J)/(1.+QV(I,KFLIP,J)))<a name='194'>
            TCOL(K)=T(I,KFLIP,J)<a name='195'>
            PCOL(K)=PMID(I,KFLIP,J)<a name='196'>
<font color=#447700>!           DPCOL(K)=PINT(I,KFLIP,J)-PINT(I,KFLIP+1,J)<a name='197'></font>
            DPCOL(K)=RHO(I,KFLIP,J)*G*DZ8W(I,KFLIP,J)<a name='198'>
          ENDDO<a name='199'>
<font color=#447700>!<a name='200'></font>
<font color=#447700>!***  LOWEST LAYER ABOVE GROUND MUST ALSO BE FLIPPED<a name='201'></font>
<font color=#447700>!<a name='202'></font>
          LMH=KTE+1-LOWLYR(I,J)<a name='203'>
          LPBL=KTE+1-KPBL(I,J)<a name='204'>
<font color=#447700>!-----------------------------------------------------------------------<a name='205'></font>
<font color=#447700>!***<a name='206'></font>
<font color=#447700>!***  CALL CONVECTION<a name='207'></font>
<font color=#447700>!***<a name='208'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='209'></font>
<font color=#447700>!***  Begin debugging convection<a name='210'></font>
<font color=#447700>!         PRINT_DIAG=.FALSE.<a name='211'></font>
<font color=#447700>!         IF(I==IMD.AND.J==JMD)PRINT_DIAG=.TRUE.<a name='212'></font>
<font color=#447700>!***  End debugging convection<a name='213'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='214'></font>
          CALL <A href='../../html_code/phys/module_cu_bmj.F.html#BMJ'>BMJ</A><A href='../../html_code/phys/module_cu_bmj.F.html#BMJDRV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BMJ_1">(ITIMESTEP,I,J,DTCNVC,LMH,LANDMASK,CLDEFI(I,J)        &amp;<a name='215'>
     &amp;            ,DPCOL,PCOL,QCOL,TCOL,PSFC,PTOP                       &amp;<a name='216'>
     &amp;            ,DQDT,DTDT,PCPCOL,LBOT,LTOP,LPBL                      &amp;<a name='217'>
     &amp;            ,CP,R,ELWV,ELIV,G,TFRZ,D608                           &amp;   <a name='218'>
     &amp;            ,PRINT_DIAG                                           &amp;   <a name='219'>
     &amp;            ,IDS,IDE,JDS,JDE,KDS,KDE                              &amp;     <a name='220'>
     &amp;            ,IMS,IME,JMS,JME,KMS,KME                              &amp;<a name='221'>
     &amp;            ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='222'>
<font color=#447700>!-----------------------------------------------------------------------<a name='223'></font>
<font color=#447700>! <a name='224'></font>
<font color=#447700>!***  COMPUTE HEATING AND MOISTENING TENDENCIES<a name='225'></font>
<font color=#447700>!<a name='226'></font>
          IF ( PRESENT( RTHCUTEN ) .AND. PRESENT( RQVCUTEN )) THEN<a name='227'>
            DO K=KTS,KTE<a name='228'>
              KFLIP=KTE+1-K<a name='229'>
              RTHCUTEN(I,K,J)=DTDT(KFLIP)/PI(I,K,J)<a name='230'>
<font color=#447700>!<a name='231'></font>
<font color=#447700>!***  CONVERT FROM SPECIFIC HUMIDTY BACK TO MIXING RATIO<a name='232'></font>
<font color=#447700>!<a name='233'></font>
              RQVCUTEN(I,K,J)=DQDT(KFLIP)/(1.-QCOL(KFLIP))**2<a name='234'>
            ENDDO<a name='235'>
          ENDIF<a name='236'>
<font color=#447700>!<a name='237'></font>
<font color=#447700>!***  ALL UNITS IN BMJ SCHEME ARE MKS, THUS CONVERT PRECIP FROM METERS<a name='238'></font>
<font color=#447700>!***  TO MILLIMETERS PER STEP FOR OUTPUT.<a name='239'></font>
<font color=#447700>!<a name='240'></font>
          RAINCV(I,J)=PCPCOL*1.E3/STEPCU<a name='241'>
          PRATEC(I,J)=PCPCOL*1.E3/(STEPCU * DT)<a name='242'>
<font color=#447700>!<a name='243'></font>
<font color=#447700>!***  CONVECTIVE CLOUD TOP AND BOTTOM FROM THIS CALL<a name='244'></font>
<font color=#447700>!<a name='245'></font>
          CUTOP(I,J)=REAL(KTE+1-LTOP)<a name='246'>
          CUBOT(I,J)=REAL(KTE+1-LBOT)<a name='247'>
<font color=#447700>!<a name='248'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='249'></font>
<font color=#447700>!***  Begin debugging convection<a name='250'></font>
          IF(PRINT_DIAG)THEN<a name='251'>
            DELT=0.<a name='252'>
            DELQ=0.<a name='253'>
            PLYR=0.<a name='254'>
            IF(LBOT&gt;0.AND.LTOP&lt;LBOT)THEN<a name='255'>
              DO K=LTOP,LBOT<a name='256'>
                PLYR=PLYR+DPCOL(K)<a name='257'>
                DELQ=DELQ+DPCOL(K)*DTCNVC*ABS(DQDT(K))<a name='258'>
                DELT=DELT+DPCOL(K)*DTCNVC*ABS(DTDT(K))<a name='259'>
              ENDDO<a name='260'>
              DELQ=DELQ/PLYR<a name='261'>
              DELT=DELT/PLYR<a name='262'>
            ENDIF<a name='263'>
<font color=#447700>!<a name='264'></font>
            WRITE(6,"(2a,2i4,3e12.4,f7.2,4i3)") &amp;<a name='265'>
                 '{cu3 i,j,PCPCOL,DTavg,DQavg,PLYR,'  &amp;<a name='266'>
                 ,'LBOT,LTOP,CUBOT,CUTOP = '  &amp;<a name='267'>
                 ,i,j, PCPCOL,DELT,1000.*DELQ,.01*PLYR  &amp;<a name='268'>
                 ,LBOT,LTOP,NINT(CUBOT(I,J)),NINT(CUTOP(I,J))<a name='269'>
<font color=#447700>!<a name='270'></font>
            IF(PLYR&gt; 0.)THEN<a name='271'>
              DO K=LBOT,LTOP,-1<a name='272'>
                KFLIP=KTE+1-K<a name='273'>
                WRITE(6,"(a,i3,2e12.4,f7.2)") '{cu3a KFLIP,DT,DQ,DP = ' &amp;<a name='274'>
                     ,KFLIP,DTCNVC*DTDT(K),1000.*DTCNVC*DQDT(K),.01*DPCOL(K)<a name='275'>
              ENDDO<a name='276'>
            ENDIF<a name='277'>
          ENDIF<a name='278'>
<font color=#447700>!***  End debugging convection<a name='279'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='280'></font>
<font color=#447700>!<a name='281'></font>
        ENDDO<a name='282'>
        ENDDO<a name='283'>
<font color=#447700>!<a name='284'></font>
      END SUBROUTINE BMJDRV<a name='285'>
<font color=#447700>!-----------------------------------------------------------------------<a name='286'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='287'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='288'></font>
<A NAME='BMJ'><A href='../../html_code/phys/module_cu_bmj.F.html#BMJ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='289'>
                          <font color=#993300>SUBROUTINE </font><font color=#cc0000>BMJ</font>                                &amp; <A href='../../call_to/BMJ.html' TARGET='index'>1</A>,<A href='../../call_from/BMJ.html' TARGET='index'>6</A><a name='290'>
<font color=#447700>!-----------------------------------------------------------------------<a name='291'></font>
     &amp; (ITIMESTEP,I,J,DTCNVC,LMH,SM,CLDEFI                              &amp;<a name='292'>
     &amp; ,DPRS,PRSMID,Q,T,PSFC,PT                                         &amp;<a name='293'>
     &amp; ,DQDT,DTDT,PCPCOL,LBOT,LTOP,LPBL                                 &amp;<a name='294'>
     &amp; ,CP,R,ELWV,ELIV,G,TFRZ,D608                                      &amp;<a name='295'>
     &amp; ,PRINT_DIAG                                                      &amp;   <a name='296'>
     &amp; ,IDS,IDE,JDS,JDE,KDS,KDE                                         &amp;<a name='297'>
     &amp; ,IMS,IME,JMS,JME,KMS,KME                                         &amp;<a name='298'>
     &amp; ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='299'>
<font color=#447700>!-----------------------------------------------------------------------<a name='300'></font>
      IMPLICIT NONE<a name='301'>
<font color=#447700>!-----------------------------------------------------------------------<a name='302'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='303'>
                           ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='304'>
                           ,ITS,ITE,JTS,JTE,KTS,KTE                     &amp;<a name='305'>
                           ,I,J,ITIMESTEP<a name='306'>
<font color=#447700>! <a name='307'></font>
      INTEGER,INTENT(IN) :: LMH,LPBL<a name='308'>
<font color=#447700>!<a name='309'></font>
      INTEGER,INTENT(OUT) :: LBOT,LTOP<a name='310'>
<font color=#447700>!<a name='311'></font>
      REAL,INTENT(IN) :: CP,D608,DTCNVC,ELIV,ELWV,G,PSFC,PT,R,SM,TFRZ<a name='312'>
<font color=#447700>!<a name='313'></font>
      REAL,DIMENSION(KTS:KTE),INTENT(IN) :: DPRS,PRSMID,Q,T<a name='314'>
<font color=#447700>!<a name='315'></font>
      REAL,INTENT(INOUT) :: CLDEFI,PCPCOL<a name='316'>
<font color=#447700>!<a name='317'></font>
      REAL,DIMENSION(KTS:KTE),INTENT(INOUT) :: DQDT,DTDT<a name='318'>
<font color=#447700>!<a name='319'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='320'></font>
<font color=#447700>!***  DEFINE LOCAL VARIABLES<a name='321'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='322'></font>
<font color=#447700>!                                                            <a name='323'></font>
      REAL,DIMENSION(KTS:KTE) :: APEK,APESK,EL,FPK                      &amp;<a name='324'>
                                ,PK,PSK,QK,QREFK,QSATK                  &amp;<a name='325'>
                                ,THERK,THEVRF,THSK                      &amp;<a name='326'>
                                ,THVMOD,THVREF,TK,TREFK<a name='327'>
      REAL,DIMENSION(KTS:KTE) :: APE,DIFQ,DIFT,THEE,THES,TREF<a name='328'>
<font color=#447700>!<a name='329'></font>
      REAL,DIMENSION(KTS:KTE) :: CPE,CPEcnv,DTV,DTVcnv,THEScnv    <font color=#447700>!&lt;-- CPE for shallow convection buoyancy check (24 Aug 2006)<a name='330'></font>
<font color=#447700>!<a name='331'></font>
      LOGICAL :: DEEP,SHALLOW<a name='332'>
<font color=#447700>!<a name='333'></font>
<font color=#447700>!***  Begin debugging convection<a name='334'></font>
      LOGICAL :: PRINT_DIAG<a name='335'>
<font color=#447700>!***  End debugging convection<a name='336'></font>
<font color=#447700>!<a name='337'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='338'></font>
<font color=#447700>!***<a name='339'></font>
<font color=#447700>!***  LOCAL SCALARS<a name='340'></font>
<font color=#447700>!***<a name='341'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='342'></font>
      REAL :: APEKL,APEKXX,APEKXY,APES,APESTS                           &amp;<a name='343'>
     &amp;            ,AVRGT,AVRGTL,BQ,BQK,BQS00K,BQS10K                    &amp;<a name='344'>
     &amp;            ,CAPA,CUP,DEN,DENTPY,DEPMIN,DEPTH                     &amp;<a name='345'>
     &amp;            ,DEPWL,DHDT,DIFQL,DIFTL,DP,DPKL,DPLO,DPMIX,DPOT       &amp;<a name='346'>
     &amp;            ,DPUP,DQREF,DRHDP,DRHEAT,DSP                          &amp;<a name='347'>
     &amp;            ,DSP0,DSP0K,DSPB,DSPBK,DSPT,DSPTK                     &amp;<a name='348'>
     &amp;            ,DSQ,DST,DSTQ,DTHEM,DTDP,EFI                          &amp;<a name='349'>
     &amp;            ,FEFI,FFUP,FPRS,FPTK,HCORR                            &amp;<a name='350'>
     &amp;            ,OTSUM,P,P00K,P01K,P10K,P11K                          &amp;<a name='351'>
     &amp;            ,PART1,PART2,PART3,PBOT,PBOTFC,PBTK                   &amp;<a name='352'>
     &amp;            ,PK0,PKB,PKL,PKT,PKXXXX,PKXXXY                        &amp;<a name='353'>
     &amp;            ,PLMH,PELEVFC,PBTmx,plo,POTSUM,PP1,PPK,PRECK          &amp;<a name='354'>
     &amp;            ,PRESK,PSP,PSUM,PTHRS,PTOP,PTPK,PUP                   &amp;<a name='355'>
     &amp;            ,QBT,QKL,QNEW,QOTSUM,QQ1,QQK,QRFKL                    &amp;<a name='356'>
     &amp;            ,QRFTP,QSP,QSUM,QUP,RDP0T                             &amp;<a name='357'>
     &amp;            ,RDPSUM,RDTCNVC,RHH,RHL,RHMAX,ROTSUM,RTBAR,RHAVG      &amp;<a name='358'>
     &amp;            ,SM1,SMIX,SQ,SQK,SQS00K,SQS10K,STABDL,SUMDE,SUMDP     &amp;<a name='359'>
     &amp;            ,SUMDT,TAUK,TAUKSC,TCORR,THBT,THERKX,THERKY           &amp;<a name='360'>
     &amp;            ,THESP,THSKL,THTPK,THVMKL,TKL,TNEW                    &amp;<a name='361'>
     &amp;            ,TQ,TQK,TREFKX,TRFKL,trmlo,trmup,TSKL,tsp,TTH         &amp;<a name='362'>
     &amp;            ,TTHK,TUP                                             &amp;<a name='363'>
     &amp;            ,CAPEcnv,PSPcnv,THBTcnv,CAPEtrigr,CAPE                &amp;<a name='364'>
     &amp;            ,TLEV2,QSAT1,QSAT2,RHSHmax<a name='365'>
<font color=#447700>!<a name='366'></font>
      INTEGER :: IQ,IQTB,IT,ITER,ITREFI,ITTB,ITTBK,KB,KNUMH,KNUML       &amp;<a name='367'>
     &amp;          ,L,L0,L0M1,LB,LBM1,LCOR,LPT1                            &amp;<a name='368'>
     &amp;          ,LQM,LSHU,LTP1,LTP2,LTSH, LBOTcnv,LTOPcnv,LMID<a name='369'>
<font color=#447700>!-----------------------------------------------------------------------<a name='370'></font>
<font color=#447700>!<a name='371'></font>
      REAL,PARAMETER :: DSPBSL=DSPBFL*FSL,DSP0SL=DSP0FL*FSL             &amp;<a name='372'>
     &amp;                 ,DSPTSL=DSPTFL*FSL                               &amp;<a name='373'>
     &amp;                 ,DSPBSS=DSPBFS*FSS,DSP0SS=DSP0FS*FSS             &amp;<a name='374'>
     &amp;                 ,DSPTSS=DSPTFS*FSS<a name='375'>
<font color=#447700>!<a name='376'></font>
      REAL,PARAMETER :: ELEVFC=0.6,STEFI=1.<a name='377'>
<font color=#447700>!<a name='378'></font>
      REAL,PARAMETER :: SLOPBL=(DSPBFL-DSPBSL)/(1.-EFIMN)               &amp;<a name='379'>
     &amp;                 ,SLOP0L=(DSP0FL-DSP0SL)/(1.-EFIMN)               &amp;<a name='380'>
     &amp;                 ,SLOPTL=(DSPTFL-DSPTSL)/(1.-EFIMN)               &amp;<a name='381'>
     &amp;                 ,SLOPBS=(DSPBFS-DSPBSS)/(1.-EFIMN)               &amp;<a name='382'>
     &amp;                 ,SLOP0S=(DSP0FS-DSP0SS)/(1.-EFIMN)               &amp;<a name='383'>
     &amp;                 ,SLOPTS=(DSPTFS-DSPTSS)/(1.-EFIMN)               &amp;<a name='384'>
     &amp;                 ,SLOPST=(STABDF-STABDS)/(1.-EFIMN)               &amp;<a name='385'>
     &amp;                 ,SLOPE=(1.-EFMNT)/(1.-EFIMN)<a name='386'>
<font color=#447700>!<a name='387'></font>
      REAL :: A23M4L,CPRLG,ELOCP,RCP,QWAT<a name='388'>
<font color=#447700>!-----------------------------------------------------------------------<a name='389'></font>
<font color=#447700>!***********************************************************************<a name='390'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='391'></font>
      CAPA=R/CP<a name='392'>
      CPRLG=CP/(ROW*G*ELWV)<a name='393'>
      ELOCP=ELIWV/CP<a name='394'>
      RCP=1./CP<a name='395'>
      A23M4L=A2*(A3-A4)*ELWV<a name='396'>
      RDTCNVC=1./DTCNVC<a name='397'>
      DEPMIN=PSH*PSFC*RSFCP<a name='398'>
<font color=#447700>!<a name='399'></font>
      DEEP=.FALSE.<a name='400'>
      SHALLOW=.FALSE.<a name='401'>
<font color=#447700>!<a name='402'></font>
      DSP0=0.<a name='403'>
      DSPB=0.<a name='404'>
      DSPT=0.<a name='405'>
<font color=#447700>!-----------------------------------------------------------------------<a name='406'></font>
      TAUK=DTCNVC/TREL<a name='407'>
      TAUKSC=DTCNVC/(1.0*TREL) <a name='408'>
<font color=#447700>!-----------------------------------------------------------------------<a name='409'></font>
<font color=#447700>!-----------------------------PREPARATIONS------------------------------<a name='410'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='411'></font>
      LBOT=LMH<a name='412'>
      PCPCOL=0.<a name='413'>
      TREF(KTS)=T(KTS)<a name='414'>
<font color=#447700>!<a name='415'></font>
      DO L=KTS,LMH<a name='416'>
        APESTS=PRSMID(L)<a name='417'>
        APE(L)=(1.E5/APESTS)**CAPA<a name='418'>
        CPEcnv(L)=0.<a name='419'>
        DTVcnv(L)=0.<a name='420'>
        THEScnv(L)=0.<a name='421'>
      ENDDO<a name='422'>
<font color=#447700>!<a name='423'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='424'></font>
<font color=#447700>!----------------SEARCH FOR MAXIMUM BUOYANCY LEVEL----------------------<a name='425'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='426'></font>
<font color=#447700>!<a name='427'></font>
      PLMH=PRSMID(LMH)<a name='428'>
      PELEVFC=PLMH*ELEVFC<a name='429'>
      PBTmx=PRSMID(LMH)-PONE<a name='430'>
      CAPEcnv=0.<a name='431'>
      PSPcnv=0.<a name='432'>
      THBTcnv=0.<a name='433'>
      LBOTcnv=LBOT<a name='434'>
      LTOPcnv=LBOT<a name='435'>
<font color=#447700>!<a name='436'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='437'></font>
<font color=#447700>!----------------TRIAL MAXIMUM BUOYANCY LEVEL VARIABLES-----------------<a name='438'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='439'></font>
<font color=#447700>!<a name='440'></font>
      max_buoy_loop: DO KB=LMH,1,-1<a name='441'>
<font color=#447700>!<a name='442'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='443'></font>
<font color=#447700>!<a name='444'></font>
        PKL=PRSMID(KB)<a name='445'>
<font color=#447700>!       IF (PKL&lt;PELEVFC .OR. T(KB)&lt;=TFRZ) EXIT<a name='446'></font>
        IF (PKL&lt;PELEVFC) EXIT<a name='447'>
        LBOT=LMH<a name='448'>
        LTOP=LMH<a name='449'>
<font color=#447700>!<a name='450'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='451'></font>
<font color=#447700>!***  SEARCH OVER A SCALED DEPTH IN FINDING THE PARCEL<a name='452'></font>
<font color=#447700>!***  WITH THE MAX THETA-E <a name='453'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='454'></font>
<font color=#447700>!<a name='455'></font>
        QBT=Q(KB)<a name='456'>
        THBT=T(KB)*APE(KB)<a name='457'>
        TTH=(THBT-THL)*RDTH<a name='458'>
        QQ1=TTH-AINT(TTH)<a name='459'>
        ITTB=INT(TTH)+1<a name='460'>
<font color=#447700>!----------------KEEPING INDICES WITHIN THE TABLE-----------------------<a name='461'></font>
        IF(ITTB&lt;1)THEN<a name='462'>
          ITTB=1<a name='463'>
          QQ1=0.<a name='464'>
        ELSE IF(ITTB&gt;=JTB)THEN<a name='465'>
          ITTB=JTB-1<a name='466'>
          QQ1=0.<a name='467'>
        ENDIF<a name='468'>
<font color=#447700>!--------------BASE AND SCALING FACTOR FOR SPEC. HUMIDITY---------------<a name='469'></font>
        ITTBK=ITTB<a name='470'>
        BQS00K=QS0(ITTBK)<a name='471'>
        SQS00K=SQS(ITTBK)<a name='472'>
        BQS10K=QS0(ITTBK+1)<a name='473'>
        SQS10K=SQS(ITTBK+1)<a name='474'>
<font color=#447700>!--------------SCALING SPEC. HUMIDITY &amp; TABLE INDEX---------------------<a name='475'></font>
        BQ=(BQS10K-BQS00K)*QQ1+BQS00K<a name='476'>
        SQ=(SQS10K-SQS00K)*QQ1+SQS00K<a name='477'>
        TQ=(QBT-BQ)/SQ*RDQ<a name='478'>
        PP1=TQ-AINT(TQ)<a name='479'>
        IQTB=INT(TQ)+1<a name='480'>
<font color=#447700>!----------------KEEPING INDICES WITHIN THE TABLE-----------------------<a name='481'></font>
        IF(IQTB&lt;1)THEN<a name='482'>
          IQTB=1<a name='483'>
          PP1=0.<a name='484'>
        ELSE IF(IQTB&gt;=ITB)THEN<a name='485'>
          IQTB=ITB-1<a name='486'>
          PP1=0.<a name='487'>
        ENDIF<a name='488'>
<font color=#447700>!--------------SATURATION PRESSURE AT FOUR SURROUNDING TABLE PTS.-------<a name='489'></font>
        IQ=IQTB<a name='490'>
        IT=ITTB<a name='491'>
        P00K=PTBL(IQ  ,IT  )<a name='492'>
        P10K=PTBL(IQ+1,IT  )<a name='493'>
        P01K=PTBL(IQ  ,IT+1)<a name='494'>
        P11K=PTBL(IQ+1,IT+1)<a name='495'>
<font color=#447700>!<a name='496'></font>
<font color=#447700>!--------------SATURATION POINT VARIABLES AT THE BOTTOM-----------------<a name='497'></font>
<font color=#447700>!<a name='498'></font>
        PSP=P00K+(P10K-P00K)*PP1+(P01K-P00K)*QQ1                        &amp;<a name='499'>
     &amp;          +(P00K-P10K-P01K+P11K)*PP1*QQ1<a name='500'>
        APES=(1.E5/PSP)**CAPA<a name='501'>
        THESP=THBT*EXP(ELOCP*QBT*APES/THBT)<a name='502'>
<font color=#447700>!<a name='503'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='504'></font>
<font color=#447700>!-----------CHOOSE CLOUD BASE AS MODEL LEVEL JUST BELOW PSP-------------<a name='505'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='506'></font>
<font color=#447700>!<a name='507'></font>
        DO L=KTS,LMH-1<a name='508'>
          P=PRSMID(L)<a name='509'>
          IF(P&lt;PSP.AND.P&gt;=PQM)LBOT=L+1<a name='510'>
        ENDDO<a name='511'>
<font color=#447700>!***<a name='512'></font>
<font color=#447700>!*** WARNING: LBOT MUST NOT BE &gt; LMH-1 IN SHALLOW CONVECTION<a name='513'></font>
<font color=#447700>!*** MAKE SURE CLOUD BASE IS AT LEAST PONE ABOVE THE SURFACE<a name='514'></font>
<font color=#447700>!***<a name='515'></font>
        PBOT=PRSMID(LBOT)<a name='516'>
        IF(PBOT&gt;=PBTmx.OR.LBOT&gt;=LMH)THEN<a name='517'>
          DO L=KTS,LMH-1<a name='518'>
            P=PRSMID(L)<a name='519'>
            IF(P&lt;PBTmx)LBOT=L<a name='520'>
          ENDDO<a name='521'>
          PBOT=PRSMID(LBOT)<a name='522'>
        ENDIF <a name='523'>
<font color=#447700>!<a name='524'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='525'></font>
<font color=#447700>!----------------CLOUD TOP COMPUTATION----------------------------------<a name='526'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='527'></font>
<font color=#447700>!<a name='528'></font>
        LTOP=LBOT<a name='529'>
        PTOP=PBOT<a name='530'>
        DO L=LMH,KTS,-1<a name='531'>
          THES(L)=THESP<a name='532'>
        ENDDO<a name='533'>
<font color=#447700>!<a name='534'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='535'></font>
<font color=#447700>!### BEGIN: ###########  WARNING  ###########  WARNING  ###########<a name='536'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='537'></font>
<font color=#447700>!<a name='538'></font>
<font color=#447700>!### IMPORTANT: THIS "DO KB=LMH,1,-1" loop must be broken up into two<a name='539'></font>
<font color=#447700>!    separate loops in order for entrainment as programmed below to work<a name='540'></font>
<font color=#447700>!    properly.  <a name='541'></font>
<font color=#447700>!<a name='542'></font>
<font color=#447700>!---------------  ENTRAINMENT DURING PARCEL ASCENT  --------------------<a name='543'></font>
<font color=#447700>!<a name='544'></font>
<font color=#447700>!        DO L=LMH,KB,-1<a name='545'></font>
<font color=#447700>!          THES(L)=THESP<a name='546'></font>
<font color=#447700>!        ENDDO<a name='547'></font>
<font color=#447700>!<a name='548'></font>
<font color=#447700>!        DO L=KTS,LMH<a name='549'></font>
<font color=#447700>!          THEE(L)=THES(L)<a name='550'></font>
<font color=#447700>!        ENDDO<a name='551'></font>
<font color=#447700>!!<a name='552'></font>
<font color=#447700>!        FEFI=(CLDEFI-EFIMN)*SLOPE+EFMNT<a name='553'></font>
<font color=#447700>!        FFUP=FUP/(FEFI*FEFI)<a name='554'></font>
<font color=#447700>!!<a name='555'></font>
<font color=#447700>!        IF(PBOT&gt;ENPLO)THEN<a name='556'></font>
<font color=#447700>!          FPRS=1.<a name='557'></font>
<font color=#447700>!        ELSEIF(PBOT&gt;ENPUP)THEN<a name='558'></font>
<font color=#447700>!          FPRS=(PBOT-ENPUP)*RENDP<a name='559'></font>
<font color=#447700>!        ELSE<a name='560'></font>
<font color=#447700>!          FPRS=0.<a name='561'></font>
<font color=#447700>!        ENDIF<a name='562'></font>
<font color=#447700>!!<a name='563'></font>
<font color=#447700>!        FFUP=FFUP*FPRS*FPRS*0.5<a name='564'></font>
<font color=#447700>!        DPUP=DPRS(KB)<a name='565'></font>
<font color=#447700>!!<a name='566'></font>
<font color=#447700>!        DO L=KB-1,KTS,-1<a name='567'></font>
<font color=#447700>!          DPLO=DPUP<a name='568'></font>
<font color=#447700>!          DPUP=DPRS(L)<a name='569'></font>
<font color=#447700>!!<a name='570'></font>
<font color=#447700>!          THES(L)=((-FFUP*DPLO+1.)*THES(L+1)                           &amp;<a name='571'></font>
<font color=#447700>!     &amp;            +(THEE(L)*DPUP+THEE(L+1)*DPLO)*FFUP)                 &amp;<a name='572'></font>
<font color=#447700>!     &amp;           /(FFUP*DPUP+1.)<a name='573'></font>
<font color=#447700>!      ENDDO<a name='574'></font>
<font color=#447700>!<a name='575'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='576'></font>
<font color=#447700>!### END: ###########  WARNING  ###########  WARNING  ###########<a name='577'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='578'></font>
<font color=#447700>!!<a name='579'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='580'></font>
<font color=#447700>!!***  COMPUTE PARCEL TEMPERATURE ALONG THE ASCENT TRAJECTORY<a name='581'></font>
<font color=#447700>!!***  SCALING PRESSURE &amp; TT TABLE INDEX.<a name='582'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='583'></font>
<font color=#447700>!!<a name='584'></font>
<font color=#447700>!!<a name='585'></font>
<font color=#447700>!       DO L=LMH,KTS,-1<a name='586'></font>
<font color=#447700>!!<a name='587'></font>
<font color=#447700>!         PRESK=PRSMID(L)<a name='588'></font>
<font color=#447700>!!<a name='589'></font>
<font color=#447700>!         IF(PRESK&lt;PLQ)THEN<a name='590'></font>
<font color=#447700>!           CALL TTBLEX(ITB,JTB,PL,PRESK,RDP,RDTHE                      &amp;<a name='591'></font>
<font color=#447700>!     &amp;                ,STHE,THE0,THES(L),TTBL,TREF(L))<a name='592'></font>
<font color=#447700>!         ELSE<a name='593'></font>
<font color=#447700>!           CALL TTBLEX(ITBQ,JTBQ,PLQ,PRESK,RDPQ,RDTHEQ                 &amp;<a name='594'></font>
<font color=#447700>!     &amp;                ,STHEQ,THE0Q,THES(L),TTBLQ,TREF(L))<a name='595'></font>
<font color=#447700>!         ENDIF<a name='596'></font>
<font color=#447700>!!<a name='597'></font>
<font color=#447700>!       ENDDO<a name='598'></font>
<font color=#447700>!!<a name='599'></font>
<font color=#447700>!!-----------------------------------------------------------------------<a name='600'></font>
<font color=#447700>!!----------------BUOYANCY CHECK-----------------------------------------<a name='601'></font>
<font color=#447700>!!-----------------------------------------------------------------------<a name='602'></font>
<font color=#447700>!!<a name='603'></font>
<font color=#447700>!       DO L=LMH,KTS,-1<a name='604'></font>
<font color=#447700>!         IF(TREF(L)&gt;T(L)-DTTOP)LTOP=L<a name='605'></font>
<font color=#447700>!       ENDDO<a name='606'></font>
<font color=#447700>!!<a name='607'></font>
<font color=#447700>!!***  CLOUD TOP PRESSURE<a name='608'></font>
<font color=#447700>!!<a name='609'></font>
<font color=#447700>!       PTOP=PRSMID(LTOP)<a name='610'></font>
<font color=#447700>!<a name='611'></font>
<font color=#447700>!------------------FIRST ENTROPY CHECK----------------------------------<a name='612'></font>
<font color=#447700>!<a name='613'></font>
        DO L=KTS,LMH<a name='614'>
          CPE(L)=0.<a name='615'>
          DTV(L)=0.<a name='616'>
        ENDDO<a name='617'>
<font color=#447700>!-----------------------------------------------------------------------<a name='618'></font>
<font color=#447700>!       lbot_ltop: IF(LBOT&gt;LTOP)THEN<a name='619'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='620'></font>
<font color=#447700>!-- Begin: Buoyancy check including deep convection (24 Aug 2006) <a name='621'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='622'></font>
          DENTPY=0.<a name='623'>
          L=KB<a name='624'>
          PLO=PRSMID(L)<a name='625'>
          TRMLO=0.<a name='626'>
          CAPEtrigr=DTPtrigr/T(LBOT)<a name='627'>
<font color=#447700>!<a name='628'></font>
<font color=#447700>!--- Below cloud base<a name='629'></font>
<font color=#447700>!<a name='630'></font>
          IF(KB&gt;LBOT) THEN<a name='631'>
            DO L=KB-1,LBOT+1,-1<a name='632'>
              PUP=PRSMID(L)<a name='633'>
              TUP=THBT/APE(L)<a name='634'>
              DP=PLO-PUP<a name='635'>
              TRMUP=(TUP*(QBT*0.608+1.)                                 &amp;<a name='636'>
     &amp;            -T(L)*(Q(L)*0.608+1.))*0.5                            &amp;<a name='637'>
     &amp;             /(T(L)*(Q(L)*0.608+1.))<a name='638'>
              DTV(L)=TRMLO+TRMUP<a name='639'>
              DENTPY=DTV(L)*DP+DENTPY<a name='640'>
              CPE(L)=DENTPY<a name='641'>
              IF (DENTPY &lt; CAPEtrigr) GO TO 170<a name='642'>
              PLO=PUP<a name='643'>
              TRMLO=TRMUP<a name='644'>
            ENDDO<a name='645'>
          ELSE<a name='646'>
            L=LBOT+1<a name='647'>
            PLO=PRSMID(L)<a name='648'>
            TUP=THBT/APE(L)<a name='649'>
            TRMLO=(TUP*(QBT*0.608+1.)                                   &amp;<a name='650'>
     &amp;            -T(L)*(Q(L)*0.608+1.))*0.5                            &amp;<a name='651'>
     &amp;             /(T(L)*(Q(L)*0.608+1.))<a name='652'>
          ENDIF  <font color=#447700>! IF(KB&gt;LBOT) THEN<a name='653'></font>
<font color=#447700>!<a name='654'></font>
<font color=#447700>!--- At cloud base<a name='655'></font>
<font color=#447700>!<a name='656'></font>
          L=LBOT<a name='657'>
          PUP=PSP<a name='658'>
          TUP=THBT/APES<a name='659'>
          TSP=(T(L+1)-T(L))/(PLO-PBOT)                                  &amp;<a name='660'>
     &amp;       *(PUP-PBOT)+T(L)<a name='661'>
          QSP=(Q(L+1)-Q(L))/(PLO-PBOT)                                  &amp;<a name='662'>
     &amp;       *(PUP-PBOT)+Q(L)<a name='663'>
          DP=PLO-PUP<a name='664'>
          TRMUP=(TUP*(QBT*0.608+1.)                                     &amp;<a name='665'>
     &amp;          -TSP*(QSP*0.608+1.))*0.5                                &amp;<a name='666'>
     &amp;         /(TSP*(QSP*0.608+1.))<a name='667'>
          DTV(L)=TRMLO+TRMUP<a name='668'>
          DENTPY=DTV(L)*DP+DENTPY<a name='669'>
          CPE(L)=DENTPY<a name='670'>
          DTV(L)=DTV(L)*DP<a name='671'>
          PLO=PUP<a name='672'>
          TRMLO=TRMUP<a name='673'>
          PUP=PRSMID(L)<a name='674'>
<font color=#447700>!<a name='675'></font>
<font color=#447700>!--- Calculate updraft temperature along moist adiabat (TUP)<a name='676'></font>
<font color=#447700>!<a name='677'></font>
          IF(PUP&lt;PLQ)THEN<a name='678'>
            CALL <A href='../../html_code/phys/module_cu_bmj.F.html#TTBLEX'>TTBLEX</A><A href='../../html_code/phys/module_cu_bmj.F.html#BMJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TTBLEX_1">(ITB,JTB,PL,PUP,RDP,RDTHE                        &amp;<a name='679'>
     &amp;                 ,STHE,THE0,THES(L),TTBL,TUP)<a name='680'>
          ELSE<a name='681'>
            CALL <A href='../../html_code/phys/module_cu_bmj.F.html#TTBLEX'>TTBLEX</A><A href='../../html_code/phys/module_cu_bmj.F.html#BMJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TTBLEX_2">(ITBQ,JTBQ,PLQ,PUP,RDPQ,RDTHEQ                   &amp;<a name='682'>
     &amp;                 ,STHEQ,THE0Q,THES(L),TTBLQ,TUP)<a name='683'>
          ENDIF<a name='684'>
<font color=#447700>!<a name='685'></font>
          QUP=PQ0/PUP*EXP(A2*(TUP-A3)/(TUP-A4))<a name='686'>
          QWAT=QBT-QUP  <font color=#447700>!-- Water loading effects, reversible adiabat<a name='687'></font>
          DP=PLO-PUP<a name='688'>
          TRMUP=(TUP*(QUP*0.608+1.-QWAT)                                &amp;<a name='689'>
     &amp;          -T(L)*(Q(L)*0.608+1.))*0.5                              &amp;<a name='690'>
     &amp;         /(T(L)*(Q(L)*0.608+1.))<a name='691'>
          DENTPY=(TRMLO+TRMUP)*DP+DENTPY<a name='692'>
          CPE(L)=DENTPY<a name='693'>
          DTV(L)=(DTV(L)+(TRMLO+TRMUP)*DP)/(PRSMID(LBOT+1)-PRSMID(LBOT))<a name='694'>
<font color=#447700>!<a name='695'></font>
          IF (DENTPY &lt; CAPEtrigr) GO TO 170<a name='696'>
<font color=#447700>!<a name='697'></font>
          PLO=PUP<a name='698'>
          TRMLO=TRMUP<a name='699'>
<font color=#447700>!<a name='700'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='701'></font>
<font color=#447700>!--- In cloud above cloud base<a name='702'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='703'></font>
<font color=#447700>!<a name='704'></font>
          DO L=LBOT-1,KTS,-1<a name='705'>
            PUP=PRSMID(L)<a name='706'>
<font color=#447700>!<a name='707'></font>
<font color=#447700>!--- Calculate updraft temperature along moist adiabat (TUP)<a name='708'></font>
<font color=#447700>!<a name='709'></font>
            IF(PUP&lt;PLQ)THEN<a name='710'>
              CALL <A href='../../html_code/phys/module_cu_bmj.F.html#TTBLEX'>TTBLEX</A><A href='../../html_code/phys/module_cu_bmj.F.html#BMJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TTBLEX_3">(ITB,JTB,PL,PUP,RDP,RDTHE                      &amp;<a name='711'>
       &amp;                 ,STHE,THE0,THES(L),TTBL,TUP)<a name='712'>
            ELSE<a name='713'>
              CALL <A href='../../html_code/phys/module_cu_bmj.F.html#TTBLEX'>TTBLEX</A><A href='../../html_code/phys/module_cu_bmj.F.html#BMJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TTBLEX_4">(ITBQ,JTBQ,PLQ,PUP,RDPQ,RDTHEQ                 &amp;<a name='714'>
       &amp;                 ,STHEQ,THE0Q,THES(L),TTBLQ,TUP)<a name='715'>
            ENDIF<a name='716'>
<font color=#447700>!<a name='717'></font>
            QUP=PQ0/PUP*EXP(A2*(TUP-A3)/(TUP-A4))<a name='718'>
            QWAT=QBT-QUP  <font color=#447700>!-- Water loading effects, reversible adiabat<a name='719'></font>
            DP=PLO-PUP<a name='720'>
            TRMUP=(TUP*(QUP*0.608+1.-QWAT)                              &amp;<a name='721'>
     &amp;            -T(L)*(Q(L)*0.608+1.))*0.5                            &amp;<a name='722'>
     &amp;           /(T(L)*(Q(L)*0.608+1.))<a name='723'>
            DTV(L)=TRMLO+TRMUP<a name='724'>
            DENTPY=DTV(L)*DP+DENTPY<a name='725'>
            CPE(L)=DENTPY<a name='726'>
<font color=#447700>!<a name='727'></font>
            IF (DENTPY &lt; CAPEtrigr) GO TO 170<a name='728'>
<font color=#447700>!<a name='729'></font>
            PLO=PUP<a name='730'>
            TRMLO=TRMUP<a name='731'>
          ENDDO<a name='732'>
<font color=#447700>!<a name='733'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='734'></font>
<font color=#447700>!<a name='735'></font>
170       LTP1=KB<a name='736'>
          CAPE=0.<a name='737'>
<font color=#447700>!<a name='738'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='739'></font>
<font color=#447700>!--- Cloud top level (LTOP) is located where CAPE is a maximum<a name='740'></font>
<font color=#447700>!--- Exit cloud-top search if CAPE &lt; CAPEtrigr<a name='741'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='742'></font>
<font color=#447700>!<a name='743'></font>
          DO L=KB,KTS,-1<a name='744'>
            IF (CPE(L) &lt; CAPEtrigr) THEN<a name='745'>
              EXIT<a name='746'>
            ELSE IF (CPE(L) &gt; CAPE) THEN<a name='747'>
              LTP1=L<a name='748'>
              CAPE=CPE(L)<a name='749'>
            ENDIF<a name='750'>
          ENDDO      <font color=#447700>!-- End DO L=KB,KTS,-1<a name='751'></font>
<font color=#447700>!<a name='752'></font>
          LTOP=MIN(LTP1,LBOT)<a name='753'>
<font color=#447700>! <a name='754'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='755'></font>
<font color=#447700>!--------------- CHECK FOR MAXIMUM INSTABILITY  ------------------------<a name='756'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='757'></font>
          IF(CAPE &gt; CAPEcnv) THEN<a name='758'>
            CAPEcnv=CAPE<a name='759'>
            PSPcnv=PSP<a name='760'>
            THBTcnv=THBT<a name='761'>
            LBOTcnv=LBOT<a name='762'>
            LTOPcnv=LTOP<a name='763'>
            DO L=LMH,KTS,-1<a name='764'>
              CPEcnv(L)=CPE(L)<a name='765'>
              DTVcnv(L)=DTV(L)<a name='766'>
              THEScnv(L)=THES(L)<a name='767'>
            ENDDO<a name='768'>
          ENDIF    <font color=#447700>! End IF(CAPE &gt; CAPEcnv) THEN<a name='769'></font>
<font color=#447700>!<a name='770'></font>
<font color=#447700>!       ENDIF lbot_ltop<a name='771'></font>
<font color=#447700>!<a name='772'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='773'></font>
<font color=#447700>!<a name='774'></font>
      ENDDO max_buoy_loop<a name='775'>
<font color=#447700>!<a name='776'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='777'></font>
<font color=#447700>!------------------------  MAXIMUM INSTABILITY  ------------------------<a name='778'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='779'></font>
<font color=#447700>!<a name='780'></font>
      IF(CAPEcnv &gt; 0.) THEN<a name='781'>
        PSP=PSPcnv<a name='782'>
        THBT=THBTcnv<a name='783'>
        LBOT=LBOTcnv<a name='784'>
        LTOP=LTOPcnv<a name='785'>
        PBOT=PRSMID(LBOT)<a name='786'>
        PTOP=PRSMID(LTOP)<a name='787'>
<font color=#447700>!<a name='788'></font>
        DO L=LMH,KTS,-1<a name='789'>
          CPE(L)=CPEcnv(L)<a name='790'>
          DTV(L)=DTVcnv(L)<a name='791'>
          THES(L)=THEScnv(L)<a name='792'>
        ENDDO<a name='793'>
<font color=#447700>!<a name='794'></font>
      ENDIF<a name='795'>
<font color=#447700>!<a name='796'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='797'></font>
<font color=#447700>!-----  Quick exit if cloud is too thin or no CAPE is present  ---------<a name='798'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='799'></font>
<font color=#447700>!<a name='800'></font>
      IF(PTOP&gt;PBOT-PNO.OR.LTOP&gt;LBOT-2.OR.CAPEcnv&lt;=0.)THEN<a name='801'>
        LBOT=0<a name='802'>
        LTOP=KTE<a name='803'>
        PBOT=PRSMID(LMH)<a name='804'>
        PTOP=PBOT<a name='805'>
        CLDEFI=AVGEFI*SM+STEFI*(1.-SM)<a name='806'>
        GO TO 800<a name='807'>
      ENDIF<a name='808'>
<font color=#447700>!<a name='809'></font>
<font color=#447700>!***  DEPTH OF CLOUD REQUIRED TO MAKE THE POINT A DEEP CONVECTION POINT<a name='810'></font>
<font color=#447700>!***  IS A SCALED VALUE OF PSFC.<a name='811'></font>
<font color=#447700>!<a name='812'></font>
      DEPTH=PBOT-PTOP<a name='813'>
<font color=#447700>!<a name='814'></font>
      IF(DEPTH&gt;=DEPMIN) THEN<a name='815'>
        DEEP=.TRUE.<a name='816'>
      ELSE<a name='817'>
        SHALLOW=.TRUE.<a name='818'>
        GO TO 600<a name='819'>
      ENDIF<a name='820'>
<font color=#447700>!<a name='821'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='822'></font>
<font color=#447700>!DCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCD<a name='823'></font>
<font color=#447700>!DCDCDCDCDCDCDCDCDCDCDC    DEEP CONVECTION   DCDCDCDCDCDCDCDCDCDCDCDCDCD<a name='824'></font>
<font color=#447700>!DCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCD<a name='825'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='826'></font>
<font color=#447700>!<a name='827'></font>
  300 CONTINUE<a name='828'>
<font color=#447700>!<a name='829'></font>
      LB =LBOT<a name='830'>
      EFI=CLDEFI<a name='831'>
<font color=#447700>!-----------------------------------------------------------------------<a name='832'></font>
<font color=#447700>!--------------INITIALIZE VARIABLES IN THE CONVECTIVE COLUMN------------<a name='833'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='834'></font>
<font color=#447700>!***<a name='835'></font>
<font color=#447700>!***  ONE SHOULD NOTE THAT THE VALUES ASSIGNED TO THE ARRAY TREFK<a name='836'></font>
<font color=#447700>!***  IN THE FOLLOWING LOOP ARE REALLY ONLY RELEVANT IN ANCHORING THE<a name='837'></font>
<font color=#447700>!***  REFERENCE TEMPERATURE PROFILE AT LEVEL LB.  WHEN BUILDING THE<a name='838'></font>
<font color=#447700>!***  REFERENCE PROFILE FROM CLOUD BASE, THEN ASSIGNING THE<a name='839'></font>
<font color=#447700>!***  AMBIENT TEMPERATURE TO TREFK IS ACCEPTABLE.  HOWEVER, WHEN<a name='840'></font>
<font color=#447700>!***  BUILDING THE REFERENCE PROFILE FROM SOME OTHER LEVEL (SUCH AS<a name='841'></font>
<font color=#447700>!***  ONE LEVEL ABOVE THE GROUND), THEN TREFK SHOULD BE FILLED WITH<a name='842'></font>
<font color=#447700>!***  THE TEMPERATURES IN TREF(L) WHICH ARE THE TEMPERATURES OF<a name='843'></font>
<font color=#447700>!***  THE MOIST ADIABAT THROUGH CLOUD BASE.  BY THE TIME THE LINE <a name='844'></font>
<font color=#447700>!***  NUMBERED 450 HAS BEEN REACHED, TREFK ACTUALLY DOES HOLD THE<a name='845'></font>
<font color=#447700>!***  REFERENCE TEMPERATURE PROFILE.<a name='846'></font>
<font color=#447700>!***<a name='847'></font>
      DO L=KTS,LMH<a name='848'>
        DIFT  (L)=0.<a name='849'>
        DIFQ  (L)=0.<a name='850'>
        TKL      =T(L)<a name='851'>
        TK    (L)=TKL<a name='852'>
        TREFK (L)=TKL<a name='853'>
        QKL      =Q(L)<a name='854'>
        QK    (L)=QKL<a name='855'>
        QREFK (L)=QKL<a name='856'>
        PKL      =PRSMID(L)<a name='857'>
        PK    (L)=PKL<a name='858'>
        PSK   (L)=PKL<a name='859'>
        APEKL    =APE(L)<a name='860'>
        APEK  (L)=APEKL<a name='861'>
<font color=#447700>!<a name='862'></font>
<font color=#447700>!--- Calculate temperature along moist adiabat (TREF)<a name='863'></font>
<font color=#447700>!<a name='864'></font>
        IF(PKL&lt;PLQ)THEN<a name='865'>
          CALL <A href='../../html_code/phys/module_cu_bmj.F.html#TTBLEX'>TTBLEX</A><A href='../../html_code/phys/module_cu_bmj.F.html#BMJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TTBLEX_5">(ITB,JTB,PL,PKL,RDP,RDTHE                          &amp;<a name='866'>
     &amp;               ,STHE,THE0,THES(L),TTBL,TREF(L))<a name='867'>
        ELSE<a name='868'>
          CALL <A href='../../html_code/phys/module_cu_bmj.F.html#TTBLEX'>TTBLEX</A><A href='../../html_code/phys/module_cu_bmj.F.html#BMJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TTBLEX_6">(ITBQ,JTBQ,PLQ,PKL,RDPQ,RDTHEQ                     &amp;<a name='869'>
     &amp;               ,STHEQ,THE0Q,THES(L),TTBLQ,TREF(L))<a name='870'>
        ENDIF<a name='871'>
        THERK (L)=TREF(L)*APEKL<a name='872'>
      ENDDO<a name='873'>
<font color=#447700>!<a name='874'></font>
<font color=#447700>!------------DEEP CONVECTION REFERENCE TEMPERATURE PROFILE------------<a name='875'></font>
<font color=#447700>!<a name='876'></font>
      LTP1=LTOP+1<a name='877'>
      LBM1=LB-1<a name='878'>
      PKB=PK(LB)<a name='879'>
      PKT=PK(LTOP)<a name='880'>
      STABDL=(EFI-EFIMN)*SLOPST+STABDS<a name='881'>
<font color=#447700>!<a name='882'></font>
<font color=#447700>!------------TEMPERATURE REFERENCE PROFILE BELOW FREEZING LEVEL-------<a name='883'></font>
<font color=#447700>!<a name='884'></font>
      EL(LB) = ELWV    <a name='885'>
      L0=LB<a name='886'>
      PK0=PK(LB)<a name='887'>
      TREFKX=TREFK(LB)<a name='888'>
      THERKX=THERK(LB)<a name='889'>
      APEKXX=APEK(LB)<a name='890'>
      THERKY=THERK(LBM1)<a name='891'>
      APEKXY=APEK(LBM1)<a name='892'>
<font color=#447700>!<a name='893'></font>
      DO L=LBM1,LTOP,-1<a name='894'>
        IF(T(L+1)&lt;TFRZ)GO TO 430<a name='895'>
        TREFKX=((THERKY-THERKX)*STABDL                                  &amp;<a name='896'>
     &amp;          +TREFKX*APEKXX)/APEKXY<a name='897'>
        TREFK(L)=TREFKX<a name='898'>
        EL(L)=ELWV<a name='899'>
        APEKXX=APEKXY<a name='900'>
        THERKX=THERKY<a name='901'>
        APEKXY=APEK(L-1)<a name='902'>
        THERKY=THERK(L-1)<a name='903'>
        L0=L<a name='904'>
        PK0=PK(L0)<a name='905'>
      ENDDO<a name='906'>
<font color=#447700>!<a name='907'></font>
<font color=#447700>!--------------FREEZING LEVEL AT OR ABOVE THE CLOUD TOP-----------------<a name='908'></font>
<font color=#447700>!<a name='909'></font>
      GO TO 450<a name='910'>
<font color=#447700>!<a name='911'></font>
<font color=#447700>!--------------TEMPERATURE REFERENCE PROFILE ABOVE FREEZING LEVEL-------<a name='912'></font>
<font color=#447700>!<a name='913'></font>
  430 L0M1=L0-1<a name='914'>
      RDP0T=1./(PK0-PKT)<a name='915'>
      DTHEM=THERK(L0)-TREFK(L0)*APEK(L0)<a name='916'>
<font color=#447700>!<a name='917'></font>
      DO L=LTOP,L0M1<a name='918'>
        TREFK(L)=(THERK(L)-(PK(L)-PKT)*DTHEM*RDP0T)/APEK(L)<a name='919'>
        EL(L)=ELWV <font color=#447700>!ELIV<a name='920'></font>
      ENDDO<a name='921'>
<font color=#447700>!<a name='922'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='923'></font>
<font color=#447700>!--------------DEEP CONVECTION REFERENCE HUMIDITY PROFILE---------------<a name='924'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='925'></font>
<font color=#447700>!<a name='926'></font>
<font color=#447700>!***  DEPWL IS THE PRESSURE DIFFERENCE BETWEEN CLOUD BASE AND<a name='927'></font>
<font color=#447700>!***  THE FREEZING LEVEL<a name='928'></font>
<font color=#447700>!<a name='929'></font>
  450 CONTINUE<a name='930'>
      DEPWL=PKB-PK0<a name='931'>
      DEPTH=PFRZ*PSFC*RSFCP<a name='932'>
      SM1=1.-SM<a name='933'>
      PBOTFC=1.<a name='934'>
<font color=#447700>!<a name='935'></font>
<font color=#447700>!-------------FIRST ADJUSTMENT OF TEMPERATURE PROFILE-------------------<a name='936'></font>
<font color=#447700>!!<a name='937'></font>
<font color=#447700>!      SUMDT=0.<a name='938'></font>
<font color=#447700>!      SUMDP=0.<a name='939'></font>
<font color=#447700>!!<a name='940'></font>
<font color=#447700>!      DO L=LTOP,LB<a name='941'></font>
<font color=#447700>!        SUMDT=(TK(L)-TREFK(L))*DPRS(L)+SUMDT<a name='942'></font>
<font color=#447700>!        SUMDP=SUMDP+DPRS(L)<a name='943'></font>
<font color=#447700>!      ENDDO<a name='944'></font>
<font color=#447700>!!<a name='945'></font>
<font color=#447700>!      TCORR=SUMDT/SUMDP<a name='946'></font>
<font color=#447700>!!<a name='947'></font>
<font color=#447700>!      DO L=LTOP,LB<a name='948'></font>
<font color=#447700>!        TREFK(L)=TREFK(L)+TCORR<a name='949'></font>
<font color=#447700>!      ENDDO<a name='950'></font>
<font color=#447700>!!<a name='951'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='952'></font>
<font color=#447700>!--------------- ITERATION LOOP FOR CLOUD EFFICIENCY -------------------<a name='953'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='954'></font>
<font color=#447700>!<a name='955'></font>
      cloud_efficiency : DO ITREFI=1,ITREFI_MAX  <a name='956'>
<font color=#447700>!<a name='957'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='958'></font>
        DSPBK=((EFI-EFIMN)*SLOPBS+DSPBSS*PBOTFC)*SM                     &amp;<a name='959'>
     &amp;       +((EFI-EFIMN)*SLOPBL+DSPBSL*PBOTFC)*SM1<a name='960'>
        DSP0K=((EFI-EFIMN)*SLOP0S+DSP0SS*PBOTFC)*SM                     &amp;<a name='961'>
     &amp;       +((EFI-EFIMN)*SLOP0L+DSP0SL*PBOTFC)*SM1<a name='962'>
        DSPTK=((EFI-EFIMN)*SLOPTS+DSPTSS*PBOTFC)*SM                     &amp;<a name='963'>
     &amp;       +((EFI-EFIMN)*SLOPTL+DSPTSL*PBOTFC)*SM1<a name='964'>
<font color=#447700>!<a name='965'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='966'></font>
<font color=#447700>!<a name='967'></font>
        DO L=LTOP,LB<a name='968'>
<font color=#447700>!<a name='969'></font>
<font color=#447700>!***<a name='970'></font>
<font color=#447700>!***  SATURATION PRESSURE DIFFERENCE<a name='971'></font>
<font color=#447700>!***<a name='972'></font>
          IF(DEPWL&gt;=DEPTH)THEN<a name='973'>
            IF(L&lt;L0)THEN<a name='974'>
              DSP=((PK0-PK(L))*DSPTK+(PK(L)-PKT)*DSP0K)/(PK0-PKT)<a name='975'>
            ELSE<a name='976'>
              DSP=((PKB-PK(L))*DSP0K+(PK(L)-PK0)*DSPBK)/(PKB-PK0)<a name='977'>
            ENDIF<a name='978'>
          ELSE<a name='979'>
            DSP=DSP0K<a name='980'>
            IF(L&lt;L0)THEN<a name='981'>
              DSP=((PK0-PK(L))*DSPTK+(PK(L)-PKT)*DSP0K)/(PK0-PKT)<a name='982'>
            ENDIF<a name='983'>
          ENDIF<a name='984'>
<font color=#447700>!***<a name='985'></font>
<font color=#447700>!***  HUMIDITY PROFILE<a name='986'></font>
<font color=#447700>!***<a name='987'></font>
          IF(PK(L)&gt;PQM)THEN<a name='988'>
            PSK(L)=PK(L)+DSP<a name='989'>
            APESK(L)=(1.E5/PSK(L))**CAPA<a name='990'>
            THSK(L)=TREFK(L)*APEK(L)<a name='991'>
            QREFK(L)=PQ0/PSK(L)*EXP(A2*(THSK(L)-A3*APESK(L))            &amp;<a name='992'>
     &amp;                                /(THSK(L)-A4*APESK(L)))<a name='993'>
          ELSE<a name='994'>
            QREFK(L)=QK(L)<a name='995'>
          ENDIF<a name='996'>
<font color=#447700>!<a name='997'></font>
        ENDDO<a name='998'>
<font color=#447700>!-----------------------------------------------------------------------<a name='999'></font>
<font color=#447700>!***<a name='1000'></font>
<font color=#447700>!***  ENTHALPY CONSERVATION INTEGRAL<a name='1001'></font>
<font color=#447700>!***<a name='1002'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1003'></font>
        enthalpy_conservation : DO ITER=1,2<a name='1004'>
<font color=#447700>!<a name='1005'></font>
          SUMDE=0.<a name='1006'>
          SUMDP=0.<a name='1007'>
<font color=#447700>!<a name='1008'></font>
          DO L=LTOP,LB<a name='1009'>
            SUMDE=((TK(L)-TREFK(L))*CP+(QK(L)-QREFK(L))*EL(L))*DPRS(L)  &amp;<a name='1010'>
     &amp;            +SUMDE<a name='1011'>
            SUMDP=SUMDP+DPRS(L)<a name='1012'>
          ENDDO<a name='1013'>
<font color=#447700>!<a name='1014'></font>
          HCORR=SUMDE/(SUMDP-DPRS(LTOP))<a name='1015'>
          LCOR=LTOP+1<a name='1016'>
<font color=#447700>!***<a name='1017'></font>
<font color=#447700>!***  FIND LQM<a name='1018'></font>
<font color=#447700>!***<a name='1019'></font>
          LQM=1<a name='1020'>
          DO L=KTS,LB<a name='1021'>
            IF(PK(L)&lt;=PQM)LQM=L<a name='1022'>
          ENDDO<a name='1023'>
<font color=#447700>!***<a name='1024'></font>
<font color=#447700>!***  ABOVE LQM CORRECT TEMPERATURE ONLY<a name='1025'></font>
<font color=#447700>!***<a name='1026'></font>
          IF(LCOR&lt;=LQM)THEN<a name='1027'>
            DO L=LCOR,LQM<a name='1028'>
              TREFK(L)=TREFK(L)+HCORR*RCP<a name='1029'>
            ENDDO<a name='1030'>
            LCOR=LQM+1<a name='1031'>
          ENDIF<a name='1032'>
<font color=#447700>!***<a name='1033'></font>
<font color=#447700>!***  BELOW LQM CORRECT BOTH TEMPERATURE AND MOISTURE<a name='1034'></font>
<font color=#447700>!***<a name='1035'></font>
          DO L=LCOR,LB<a name='1036'>
            TSKL=TREFK(L)*APEK(L)/APESK(L)<a name='1037'>
            DHDT=QREFK(L)*A23M4L/(TSKL-A4)**2+CP<a name='1038'>
            TREFK(L)=HCORR/DHDT+TREFK(L)<a name='1039'>
            THSKL=TREFK(L)*APEK(L)<a name='1040'>
            QREFK(L)=PQ0/PSK(L)*EXP(A2*(THSKL-A3*APESK(L))              &amp;<a name='1041'>
     &amp;                                /(THSKL-A4*APESK(L)))<a name='1042'>
          ENDDO<a name='1043'>
<font color=#447700>!<a name='1044'></font>
        ENDDO  enthalpy_conservation<a name='1045'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1046'></font>
<font color=#447700>!<a name='1047'></font>
<font color=#447700>!***  HEATING, MOISTENING, PRECIPITATION<a name='1048'></font>
<font color=#447700>!<a name='1049'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1050'></font>
        AVRGT=0.<a name='1051'>
        PRECK=0.<a name='1052'>
        DSQ=0.<a name='1053'>
        DST=0.<a name='1054'>
<font color=#447700>!<a name='1055'></font>
        DO L=LTOP,LB<a name='1056'>
          TKL=TK(L)<a name='1057'>
          DIFTL=(TREFK(L)-TKL  )*TAUK<a name='1058'>
          DIFQL=(QREFK(L)-QK(L))*TAUK<a name='1059'>
          AVRGTL=(TKL+TKL+DIFTL)<a name='1060'>
          DPOT=DPRS(L)/AVRGTL<a name='1061'>
          DST=DIFTL*DPOT+DST<a name='1062'>
          DSQ=DIFQL*EL(L)*DPOT+DSQ<a name='1063'>
          AVRGT=AVRGTL*DPRS(L)+AVRGT<a name='1064'>
          PRECK=DIFTL*DPRS(L)+PRECK<a name='1065'>
          DIFT(L)=DIFTL<a name='1066'>
          DIFQ(L)=DIFQL<a name='1067'>
        ENDDO<a name='1068'>
<font color=#447700>!<a name='1069'></font>
        DST=(DST+DST)*CP<a name='1070'>
        DSQ=DSQ+DSQ<a name='1071'>
        DENTPY=DST+DSQ<a name='1072'>
        AVRGT=AVRGT/(SUMDP+SUMDP)<a name='1073'>
<font color=#447700>!<a name='1074'></font>
<font color=#447700>!        DRHEAT=PRECK*CP/AVRGT<a name='1075'></font>
        DRHEAT=(PRECK*SM+MAX(1.E-7,PRECK)*(1.-SM))*CP/AVRGT <font color=#447700>!As in Eta!<a name='1076'></font>
        DRHEAT=MAX(DRHEAT,1.E-20)<a name='1077'>
        EFI=EFIFC*DENTPY/DRHEAT<a name='1078'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1079'></font>
        EFI=MIN(EFI,1.)<a name='1080'>
        EFI=MAX(EFI,EFIMN)<a name='1081'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1082'></font>
<font color=#447700>!<a name='1083'></font>
      ENDDO  cloud_efficiency<a name='1084'>
<font color=#447700>!<a name='1085'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1086'></font>
<font color=#447700>!<a name='1087'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1088'></font>
<font color=#447700>!---------------------- DEEP CONVECTION --------------------------------<a name='1089'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1090'></font>
<font color=#447700>!<a name='1091'></font>
      IF(DENTPY&gt;=EPSNTP.AND.PRECK&gt;EPSPR)THEN<a name='1092'>
<font color=#447700>!<a name='1093'></font>
        CLDEFI=EFI<a name='1094'>
        FEFI=EFMNT+SLOPE*(EFI-EFIMN)<a name='1095'>
        FEFI=(DENTPY-EPSNTP)*FEFI/DENTPY<a name='1096'>
        PRECK=PRECK*FEFI<a name='1097'>
<font color=#447700>!<a name='1098'></font>
<font color=#447700>!***  UPDATE PRECIPITATION AND TENDENCIES OF TEMPERATURE AND MOISTURE<a name='1099'></font>
<font color=#447700>!<a name='1100'></font>
        CUP=PRECK*CPRLG<a name='1101'>
        PCPCOL=CUP<a name='1102'>
<font color=#447700>!<a name='1103'></font>
        DO L=LTOP,LB<a name='1104'>
          DTDT(L)=DIFT(L)*FEFI*RDTCNVC<a name='1105'>
          DQDT(L)=DIFQ(L)*FEFI*RDTCNVC<a name='1106'>
        ENDDO<a name='1107'>
<font color=#447700>!<a name='1108'></font>
      ELSE<a name='1109'>
<font color=#447700>!<a name='1110'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1111'></font>
<font color=#447700>!***  REDUCE THE CLOUD TOP<a name='1112'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1113'></font>
<font color=#447700>!<a name='1114'></font>
<font color=#447700>!        LTOP=LTOP+3<a name='1115'></font>
<font color=#447700>!        PTOP=PRSMID(LTOP)<a name='1116'></font>
<font color=#447700>!        DEPMIN=PSH*PSFC*RSFCP<a name='1117'></font>
<font color=#447700>!        DEPTH=PBOT-PTOP<a name='1118'></font>
<font color=#447700>!***<a name='1119'></font>
<font color=#447700>!***  ITERATE DEEP CONVECTION PROCEDURE IF NEEDED<a name='1120'></font>
<font color=#447700>!***<a name='1121'></font>
<font color=#447700>!        IF(DEPTH&gt;=DEPMIN)THEN<a name='1122'></font>
<font color=#447700>!          GO TO 300<a name='1123'></font>
<font color=#447700>!        ENDIF<a name='1124'></font>
<font color=#447700>!<a name='1125'></font>
<font color=#447700>!        CLDEFI=AVGEFI<a name='1126'></font>
         CLDEFI=EFIMN*SM+STEFI*(1.-SM)<a name='1127'>
<font color=#447700>!***<a name='1128'></font>
<font color=#447700>!***  SEARCH FOR SHALLOW CLOUD TOP<a name='1129'></font>
<font color=#447700>!***<a name='1130'></font>
<font color=#447700>!        LTSH=LBOT<a name='1131'></font>
<font color=#447700>!        LBM1=LBOT-1<a name='1132'></font>
<font color=#447700>!        PBTK=PK(LBOT)<a name='1133'></font>
<font color=#447700>!        DEPMIN=PSH*PSFC*RSFCP<a name='1134'></font>
<font color=#447700>!        PTPK=PBTK-DEPMIN<a name='1135'></font>
        PTPK=MAX(PSHU, PK(LBOT)-DEPMIN)<a name='1136'>
<font color=#447700>!***<a name='1137'></font>
<font color=#447700>!***  CLOUD TOP IS THE LEVEL JUST BELOW PBTK-PSH or JUST BELOW PSHU<a name='1138'></font>
<font color=#447700>!***<a name='1139'></font>
        DO L=KTS,LMH<a name='1140'>
          IF(PK(L)&lt;=PTPK)LTOP=L+1<a name='1141'>
        ENDDO<a name='1142'>
<font color=#447700>!<a name='1143'></font>
<font color=#447700>!        PTPK=PK(LTOP)<a name='1144'></font>
<font color=#447700>!!***<a name='1145'></font>
<font color=#447700>!!***  HIGHEST LEVEL ALLOWED IS LEVEL JUST BELOW PSHU<a name='1146'></font>
<font color=#447700>!!***<a name='1147'></font>
<font color=#447700>!        IF(PTPK&lt;=PSHU)THEN<a name='1148'></font>
<font color=#447700>!!<a name='1149'></font>
<font color=#447700>!          DO L=KTS,LMH<a name='1150'></font>
<font color=#447700>!            IF(PK(L)&lt;=PSHU)LSHU=L+1<a name='1151'></font>
<font color=#447700>!          ENDDO<a name='1152'></font>
<font color=#447700>!!<a name='1153'></font>
<font color=#447700>!          LTOP=LSHU<a name='1154'></font>
<font color=#447700>!          PTPK=PK(LTOP)<a name='1155'></font>
<font color=#447700>!        ENDIF<a name='1156'></font>
<font color=#447700>!<a name='1157'></font>
<font color=#447700>!        if(ltop&gt;=lbot)then<a name='1158'></font>
<font color=#447700>!!!!!!     lbot=0<a name='1159'></font>
<font color=#447700>!          ltop=lmh<a name='1160'></font>
<font color=#447700>!!!!!!     pbot=pk(lbot)<a name='1161'></font>
<font color=#447700>!          ptop=pk(ltop)<a name='1162'></font>
<font color=#447700>!          pbot=ptop<a name='1163'></font>
<font color=#447700>!          go to 600<a name='1164'></font>
<font color=#447700>!        endif<a name='1165'></font>
<font color=#447700>!<a name='1166'></font>
<font color=#447700>!        LTP1=LTOP+1<a name='1167'></font>
<font color=#447700>!        LTP2=LTOP+2<a name='1168'></font>
<font color=#447700>!!<a name='1169'></font>
<font color=#447700>!        DO L=LTOP,LBOT<a name='1170'></font>
<font color=#447700>!          QSATK(L)=PQ0/PK(L)*EXP(A2*(TK(L)-A3)/(TK(L)-A4))<a name='1171'></font>
<font color=#447700>!        ENDDO<a name='1172'></font>
<font color=#447700>!!<a name='1173'></font>
<font color=#447700>!        RHH=QK(LTOP)/QSATK(LTOP)<a name='1174'></font>
<font color=#447700>!        RHMAX=0.<a name='1175'></font>
<font color=#447700>!        LTSH=LTOP<a name='1176'></font>
<font color=#447700>!!<a name='1177'></font>
<font color=#447700>!        DO L=LTP1,LBM1<a name='1178'></font>
<font color=#447700>!          RHL=QK(L)/QSATK(L)<a name='1179'></font>
<font color=#447700>!          DRHDP=(RHH-RHL)/(PK(L-1)-PK(L))<a name='1180'></font>
<font color=#447700>!!<a name='1181'></font>
<font color=#447700>!          IF(DRHDP&gt;RHMAX)THEN<a name='1182'></font>
<font color=#447700>!            LTSH=L-1<a name='1183'></font>
<font color=#447700>!            RHMAX=DRHDP<a name='1184'></font>
<font color=#447700>!          ENDIF<a name='1185'></font>
<font color=#447700>!!<a name='1186'></font>
<font color=#447700>!          RHH=RHL<a name='1187'></font>
<font color=#447700>!        ENDDO<a name='1188'></font>
<font color=#447700>!<a name='1189'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1190'></font>
<font color=#447700>!-- Make shallow cloud top a function of virtual temperature excess (DTV)<a name='1191'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1192'></font>
<font color=#447700>!<a name='1193'></font>
        LTP1=LBOT<a name='1194'>
        DO L=LBOT-1,LTOP,-1<a name='1195'>
          IF (DTV(L) &gt; 0.) THEN<a name='1196'>
            LTP1=L<a name='1197'>
          ELSE<a name='1198'>
            EXIT<a name='1199'>
          ENDIF<a name='1200'>
        ENDDO<a name='1201'>
        LTOP=MIN(LTP1,LBOT)<a name='1202'>
<font color=#447700>!***<a name='1203'></font>
<font color=#447700>!***  CLOUD MUST BE AT LEAST TWO LAYERS THICK<a name='1204'></font>
<font color=#447700>!***<a name='1205'></font>
<font color=#447700>!        IF(LBOT-LTOP&lt;2)LTOP=LBOT-2  (eliminate this criterion)<a name='1206'></font>
<font color=#447700>!<a name='1207'></font>
<font color=#447700>!-- End: Buoyancy check (24 Aug 2006)<a name='1208'></font>
<font color=#447700>!<a name='1209'></font>
        PTOP=PK(LTOP)<a name='1210'>
        SHALLOW=.TRUE.<a name='1211'>
        DEEP=.FALSE.<a name='1212'>
<font color=#447700>!<a name='1213'></font>
      ENDIF<a name='1214'>
<font color=#447700>!DCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCD<a name='1215'></font>
<font color=#447700>!DCDCDCDCDCDCDC          END OF DEEP CONVECTION            DCDCDCDCDCDCD<a name='1216'></font>
<font color=#447700>!DCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCDCD<a name='1217'></font>
<font color=#447700>!<a name='1218'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1219'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1220'></font>
  600 CONTINUE<a name='1221'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1222'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1223'></font>
<font color=#447700>!<a name='1224'></font>
<font color=#447700>!----------------GATHER SHALLOW CONVECTION POINTS-----------------------<a name='1225'></font>
<font color=#447700>!<a name='1226'></font>
<font color=#447700>!      IF(PTOP&lt;=PBOT-PNO.AND.LTOP&lt;=LBOT-2)THEN<a name='1227'></font>
<font color=#447700>!         DEPMIN=PSH*PSFC*RSFCP<a name='1228'></font>
<font color=#447700>!!<a name='1229'></font>
<font color=#447700>!!        if(lpbl&lt;lbot)lbot=lpbl<a name='1230'></font>
<font color=#447700>!!        if(lbot&gt;lmh-1)lbot=lmh-1<a name='1231'></font>
<font color=#447700>!!        pbot=prsmid(lbot)<a name='1232'></font>
<font color=#447700>!!<a name='1233'></font>
<font color=#447700>!         IF(PTOP+1.&gt;=PBOT-DEPMIN)SHALLOW=.TRUE.<a name='1234'></font>
<font color=#447700>!      ELSE<a name='1235'></font>
<font color=#447700>!         LBOT=0<a name='1236'></font>
<font color=#447700>!         LTOP=KTE<a name='1237'></font>
<font color=#447700>!      ENDIF<a name='1238'></font>
<font color=#447700>!<a name='1239'></font>
<font color=#447700>!***********************************************************************<a name='1240'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1241'></font>
<font color=#447700>!***  Begin debugging convection<a name='1242'></font>
      IF(PRINT_DIAG)THEN<a name='1243'>
        WRITE(6,"(a,2i3,L2,3e12.4)")  &amp;<a name='1244'>
             '{cu2a lbot,ltop,shallow,pbot,ptop,depmin = ' &amp;<a name='1245'>
             ,lbot,ltop,shallow,pbot,ptop,depmin<a name='1246'>
      ENDIF<a name='1247'>
<font color=#447700>!***  End debugging convection<a name='1248'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1249'></font>
<font color=#447700>!<a name='1250'></font>
      IF(.NOT.SHALLOW)GO TO 800<a name='1251'>
<font color=#447700>!<a name='1252'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1253'></font>
<font color=#447700>!***********************************************************************<a name='1254'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1255'></font>
<font color=#447700>!SCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCS<a name='1256'></font>
<font color=#447700>!SCSCSCSCSCSCSC         SHALLOW CONVECTION          CSCSCSCSCSCSCSCSCSCS<a name='1257'></font>
<font color=#447700>!SCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCS<a name='1258'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1259'></font>
      DO L=KTS,LMH<a name='1260'>
        TKL      =T(L)<a name='1261'>
        TK   (L) =TKL<a name='1262'>
        TREFK(L) =TKL<a name='1263'>
        QKL      =Q(L)<a name='1264'>
        QK   (L) =QKL<a name='1265'>
        QREFK(L) =QKL<a name='1266'>
        PKL      =PRSMID(L)<a name='1267'>
        PK   (L) =PKL<a name='1268'>
        QSATK(L) =PQ0/PK(L)*EXP(A2*(TK(L)-A3)/(TK(L)-A4))<a name='1269'>
        APEKL    =APE(L)<a name='1270'>
        APEK (L) =APEKL<a name='1271'>
        THVMKL   =TKL*APEKL*(QKL*D608+1.)<a name='1272'>
        THVREF(L)=THVMKL<a name='1273'>
<font color=#447700>!<a name='1274'></font>
<font color=#447700>!        IF(TKL&gt;=TFRZ)THEN<a name='1275'></font>
          EL(L)=ELWV<a name='1276'>
<font color=#447700>!        ELSE<a name='1277'></font>
<font color=#447700>!          EL(L)=ELIV<a name='1278'></font>
<font color=#447700>!        ENDIF<a name='1279'></font>
      ENDDO<a name='1280'>
<font color=#447700>!<a name='1281'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1282'></font>
<font color=#447700>!-- Begin: Raise cloud top if avg RH&gt;RHSHmax and CAPE&gt;0<a name='1283'></font>
<font color=#447700>!   RHSHmax=RH at cloud base associated with a DSP of PONE<a name='1284'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1285'></font>
<font color=#447700>!<a name='1286'></font>
      TLEV2=T(LBOT)*((PK(LBOT)-PONE)/PK(LBOT))**CAPA<a name='1287'>
      QSAT1=PQ0/PK(LBOT)*EXP(A2*(T(LBOT)-A3)/(TK(LBOT)-A4))<a name='1288'>
      QSAT2=PQ0/(PK(LBOT)-PONE)*EXP(A2*(TLEV2-A3)/(TLEV2-A4))<a name='1289'>
      RHSHmax=QSAT2/QSAT1<a name='1290'>
      SUMDP=0.<a name='1291'>
      RHAVG=0.<a name='1292'>
<font color=#447700>!<a name='1293'></font>
      DO L=LBOT,LTOP,-1<a name='1294'>
        RHAVG=RHAVG+DPRS(L)*QK(L)/QSATK(L)<a name='1295'>
        SUMDP=SUMDP+DPRS(L)<a name='1296'>
      ENDDO<a name='1297'>
<font color=#447700>!<a name='1298'></font>
      IF (RHAVG/SUMDP &gt; RHSHmax) THEN<a name='1299'>
        LTSH=LTOP<a name='1300'>
        DO L=LTOP-1,KTS,-1<a name='1301'>
          RHAVG=RHAVG+DPRS(L)*QK(L)/QSATK(L)<a name='1302'>
          SUMDP=SUMDP+DPRS(L)<a name='1303'>
          IF (CPE(L) &gt; 0.) THEN<a name='1304'>
            LTSH=L<a name='1305'>
          ELSE<a name='1306'>
            EXIT<a name='1307'>
          ENDIF<a name='1308'>
          IF (RHAVG/SUMDP &lt;= RHSHmax) EXIT<a name='1309'>
          IF (PK(L) &lt;= PSHU) EXIT<a name='1310'>
        ENDDO<a name='1311'>
        LTOP=LTSH<a name='1312'>
      ENDIF<a name='1313'>
<font color=#447700>!<a name='1314'></font>
<font color=#447700>!-- End: Raise cloud top if avg RH&gt;RHSHmax and CAPE&gt;0<a name='1315'></font>
<font color=#447700>!<a name='1316'></font>
<font color=#447700>!---------------------------SHALLOW CLOUD TOP---------------------------<a name='1317'></font>
      LBM1=LBOT-1<a name='1318'>
      PTPK=PTOP<a name='1319'>
      LTP1=LTOP-1<a name='1320'>
      DEPTH=PBOT-PTOP<a name='1321'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1322'></font>
<font color=#447700>!***  Begin debugging convection<a name='1323'></font>
      IF(PRINT_DIAG)THEN<a name='1324'>
        WRITE(6,"(a,4e12.4)") '{cu2b PBOT,PTOP,DEPTH,DEPMIN= ' &amp;<a name='1325'>
             ,PBOT,PTOP,DEPTH,DEPMIN<a name='1326'>
      ENDIF<a name='1327'>
<font color=#447700>!***  End debugging convection<a name='1328'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1329'></font>
<font color=#447700>!<a name='1330'></font>
<font color=#447700>!BSF      IF(DEPTH&lt;DEPMIN)THEN<a name='1331'></font>
<font color=#447700>!BSF        GO TO 800<a name='1332'></font>
<font color=#447700>!BSF      ENDIF<a name='1333'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1334'></font>
      IF(PTOP&gt;PBOT-PNO.OR.LTOP&gt;LBOT-2)THEN<a name='1335'>
        LBOT=0<a name='1336'>
<font color=#447700>!!!     LTOP=LBOT<a name='1337'></font>
        LTOP=KTE<a name='1338'>
        PTOP=PBOT<a name='1339'>
        GO TO 800<a name='1340'>
      ENDIF<a name='1341'>
<font color=#447700>!<a name='1342'></font>
<font color=#447700>!--------------SCALING POTENTIAL TEMPERATURE &amp; TABLE INDEX AT TOP-------<a name='1343'></font>
<font color=#447700>!<a name='1344'></font>
      THTPK=T(LTP1)*APE(LTP1)<a name='1345'>
<font color=#447700>!<a name='1346'></font>
      TTHK=(THTPK-THL)*RDTH<a name='1347'>
      QQK =TTHK-AINT(TTHK)<a name='1348'>
      IT  =INT(TTHK)+1<a name='1349'>
<font color=#447700>!<a name='1350'></font>
      IF(IT&lt;1)THEN<a name='1351'>
        IT=1<a name='1352'>
        QQK=0.<a name='1353'>
      ENDIF<a name='1354'>
<font color=#447700>!<a name='1355'></font>
      IF(IT&gt;=JTB)THEN<a name='1356'>
        IT=JTB-1<a name='1357'>
        QQK=0.<a name='1358'>
      ENDIF<a name='1359'>
<font color=#447700>!<a name='1360'></font>
<font color=#447700>!--------------BASE AND SCALING FACTOR FOR SPEC. HUMIDITY AT TOP--------<a name='1361'></font>
<font color=#447700>!<a name='1362'></font>
      BQS00K=QS0(IT)<a name='1363'>
      SQS00K=SQS(IT)<a name='1364'>
      BQS10K=QS0(IT+1)<a name='1365'>
      SQS10K=SQS(IT+1)<a name='1366'>
<font color=#447700>!<a name='1367'></font>
<font color=#447700>!--------------SCALING SPEC. HUMIDITY &amp; TABLE INDEX AT TOP--------------<a name='1368'></font>
<font color=#447700>!<a name='1369'></font>
      BQK=(BQS10K-BQS00K)*QQK+BQS00K<a name='1370'>
      SQK=(SQS10K-SQS00K)*QQK+SQS00K<a name='1371'>
<font color=#447700>!<a name='1372'></font>
<font color=#447700>!     TQK=(Q(LTOP)-BQK)/SQK*RDQ<a name='1373'></font>
      TQK=(Q(LTP1)-BQK)/SQK*RDQ<a name='1374'>
<font color=#447700>!<a name='1375'></font>
      PPK=TQK-AINT(TQK)<a name='1376'>
      IQ =INT(TQK)+1<a name='1377'>
<font color=#447700>!<a name='1378'></font>
      IF(IQ&lt;1)THEN<a name='1379'>
        IQ=1<a name='1380'>
        PPK=0.<a name='1381'>
      ENDIF<a name='1382'>
<font color=#447700>!<a name='1383'></font>
      IF(IQ&gt;=ITB)THEN<a name='1384'>
        IQ=ITB-1<a name='1385'>
        PPK=0.<a name='1386'>
      ENDIF<a name='1387'>
<font color=#447700>!<a name='1388'></font>
<font color=#447700>!----------------CLOUD TOP SATURATION POINT PRESSURE--------------------<a name='1389'></font>
<font color=#447700>!<a name='1390'></font>
      PART1=(PTBL(IQ+1,IT)-PTBL(IQ,IT))*PPK<a name='1391'>
      PART2=(PTBL(IQ,IT+1)-PTBL(IQ,IT))*QQK<a name='1392'>
      PART3=(PTBL(IQ  ,IT  )-PTBL(IQ+1,IT  )                            &amp;<a name='1393'>
     &amp;      -PTBL(IQ  ,IT+1)+PTBL(IQ+1,IT+1))*PPK*QQK<a name='1394'>
      PTPK=PTBL(IQ,IT)+PART1+PART2+PART3<a name='1395'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1396'></font>
      DPMIX=PTPK-PSP<a name='1397'>
      IF(ABS(DPMIX).LT.3000.)DPMIX=-3000.<a name='1398'>
<font color=#447700>!<a name='1399'></font>
<font color=#447700>!----------------TEMPERATURE PROFILE SLOPE------------------------------<a name='1400'></font>
<font color=#447700>!<a name='1401'></font>
      SMIX=(THTPK-THBT)/DPMIX*STABS<a name='1402'>
<font color=#447700>!<a name='1403'></font>
      TREFKX=TREFK(LBOT+1)<a name='1404'>
      PKXXXX=PK(LBOT+1)<a name='1405'>
      PKXXXY=PK(LBOT)<a name='1406'>
      APEKXX=APEK(LBOT+1)<a name='1407'>
      APEKXY=APEK(LBOT)<a name='1408'>
<font color=#447700>!<a name='1409'></font>
      LMID=.5*(LBOT+LTOP)<a name='1410'>
<font color=#447700>!<a name='1411'></font>
      DO L=LBOT,LTOP,-1<a name='1412'>
        TREFKX=((PKXXXY-PKXXXX)*SMIX                                    &amp;<a name='1413'>
     &amp;          +TREFKX*APEKXX)/APEKXY<a name='1414'>
        TREFK(L)=TREFKX<a name='1415'>
        IF(L&lt;=LMID) TREFK(L)=MAX(TREFK(L), TK(L)+DTSHAL)<a name='1416'>
        APEKXX=APEKXY<a name='1417'>
        PKXXXX=PKXXXY<a name='1418'>
        APEKXY=APEK(L-1)<a name='1419'>
        PKXXXY=PK(L-1)<a name='1420'>
      ENDDO<a name='1421'>
<font color=#447700>!<a name='1422'></font>
<font color=#447700>!----------------TEMPERATURE REFERENCE PROFILE CORRECTION---------------<a name='1423'></font>
<font color=#447700>!<a name='1424'></font>
      SUMDT=0.<a name='1425'>
      SUMDP=0.<a name='1426'>
<font color=#447700>!<a name='1427'></font>
      DO L=LTOP,LBOT<a name='1428'>
        SUMDT=(TK(L)-TREFK(L))*DPRS(L)+SUMDT<a name='1429'>
        SUMDP=SUMDP+DPRS(L)<a name='1430'>
      ENDDO<a name='1431'>
<font color=#447700>!<a name='1432'></font>
      RDPSUM=1./SUMDP<a name='1433'>
      FPK(LBOT)=TREFK(LBOT)<a name='1434'>
<font color=#447700>!<a name='1435'></font>
      TCORR=SUMDT*RDPSUM<a name='1436'>
<font color=#447700>!<a name='1437'></font>
      DO L=LTOP,LBOT<a name='1438'>
        TRFKL   =TREFK(L)+TCORR<a name='1439'>
        TREFK(L)=TRFKL<a name='1440'>
        FPK  (L)=TRFKL<a name='1441'>
      ENDDO<a name='1442'>
<font color=#447700>!<a name='1443'></font>
<font color=#447700>!----------------HUMIDITY PROFILE EQUATIONS-----------------------------<a name='1444'></font>
<font color=#447700>!<a name='1445'></font>
      PSUM  =0.<a name='1446'>
      QSUM  =0.<a name='1447'>
      POTSUM=0.<a name='1448'>
      QOTSUM=0.<a name='1449'>
      OTSUM =0.<a name='1450'>
      DST   =0.<a name='1451'>
      FPTK  =FPK(LTOP)<a name='1452'>
<font color=#447700>!<a name='1453'></font>
      DO L=LTOP,LBOT<a name='1454'>
        DPKL  =FPK(L)-FPTK<a name='1455'>
        PSUM  =DPKL *DPRS(L)+PSUM<a name='1456'>
        QSUM  =QK(L)*DPRS(L)+QSUM<a name='1457'>
        RTBAR =2./(TREFK(L)+TK(L))<a name='1458'>
        OTSUM =DPRS(L)*RTBAR+OTSUM<a name='1459'>
        POTSUM=DPKL    *RTBAR*DPRS(L)+POTSUM<a name='1460'>
        QOTSUM=QK(L)   *RTBAR*DPRS(L)+QOTSUM<a name='1461'>
        DST   =(TREFK(L)-TK(L))*RTBAR*DPRS(L)/EL(L)+DST<a name='1462'>
      ENDDO<a name='1463'>
<font color=#447700>!<a name='1464'></font>
      PSUM  =PSUM*RDPSUM<a name='1465'>
      QSUM  =QSUM*RDPSUM<a name='1466'>
      ROTSUM=1./OTSUM<a name='1467'>
      POTSUM=POTSUM*ROTSUM<a name='1468'>
      QOTSUM=QOTSUM*ROTSUM<a name='1469'>
      DST   =DST*ROTSUM*CP<a name='1470'>
<font color=#447700>!<a name='1471'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1472'></font>
<font color=#447700>!***  Begin debugging convection<a name='1473'></font>
      IF(PRINT_DIAG)THEN<a name='1474'>
        WRITE(6,"(a,5e12.4)") '{cu2c DST,PSUM,QSUM,POTSUM,QOTSUM = ' &amp;<a name='1475'>
             ,DST,PSUM,QSUM,POTSUM,QOTSUM<a name='1476'>
      ENDIF<a name='1477'>
<font color=#447700>!***  End debugging convection<a name='1478'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1479'></font>
<font color=#447700>!<a name='1480'></font>
<font color=#447700>!----------------ENSURE POSITIVE ENTROPY CHANGE-------------------------<a name='1481'></font>
<font color=#447700>!<a name='1482'></font>
      IF(DST&gt;0.)THEN<a name='1483'>
<font color=#447700>!        dstq=dst*epsup<a name='1484'></font>
        LBOT=0<a name='1485'>
<font color=#447700>!!!!    LTOP=LBOT<a name='1486'></font>
        LTOP=KTE<a name='1487'>
        PTOP=PBOT<a name='1488'>
        GO TO 800<a name='1489'>
      ELSE<a name='1490'>
        DSTQ=DST*EPSDN<a name='1491'>
      ENDIF<a name='1492'>
<font color=#447700>!<a name='1493'></font>
<font color=#447700>!----------------CHECK FOR ISOTHERMAL ATMOSPHERE------------------------<a name='1494'></font>
<font color=#447700>!<a name='1495'></font>
      DEN=POTSUM-PSUM<a name='1496'>
<font color=#447700>!<a name='1497'></font>
      IF(-DEN/PSUM&lt;5.E-5)THEN<a name='1498'>
        LBOT=0<a name='1499'>
<font color=#447700>!!!!    LTOP=LBOT<a name='1500'></font>
        LTOP=KTE<a name='1501'>
        PTOP=PBOT<a name='1502'>
        GO TO 800<a name='1503'>
<font color=#447700>!<a name='1504'></font>
<font color=#447700>!----------------SLOPE OF THE REFERENCE HUMIDITY PROFILE----------------<a name='1505'></font>
<font color=#447700>!<a name='1506'></font>
      ELSE<a name='1507'>
        DQREF=(QOTSUM-DSTQ-QSUM)/DEN<a name='1508'>
      ENDIF<a name='1509'>
<font color=#447700>!<a name='1510'></font>
<font color=#447700>!-------------- HUMIDITY DOES NOT INCREASE WITH HEIGHT------------------<a name='1511'></font>
<font color=#447700>!<a name='1512'></font>
      IF(DQREF&lt;0.)THEN<a name='1513'>
        LBOT=0<a name='1514'>
<font color=#447700>!!!!    LTOP=LBOT<a name='1515'></font>
        LTOP=KTE<a name='1516'>
        PTOP=PBOT<a name='1517'>
        GO TO 800<a name='1518'>
      ENDIF<a name='1519'>
<font color=#447700>!<a name='1520'></font>
<font color=#447700>!----------------HUMIDITY AT THE CLOUD TOP------------------------------<a name='1521'></font>
<font color=#447700>!<a name='1522'></font>
      QRFTP=QSUM-DQREF*PSUM<a name='1523'>
<font color=#447700>!<a name='1524'></font>
<font color=#447700>!----------------HUMIDITY PROFILE---------------------------------------<a name='1525'></font>
<font color=#447700>!<a name='1526'></font>
      DO L=LTOP,LBOT<a name='1527'>
        QRFKL=(FPK(L)-FPTK)*DQREF+QRFTP<a name='1528'>
<font color=#447700>!<a name='1529'></font>
<font color=#447700>!***  TOO DRY CLOUDS NOT ALLOWED<a name='1530'></font>
<font color=#447700>!<a name='1531'></font>
        TNEW=(TREFK(L)-TK(L))*TAUKSC+TK(L)<a name='1532'>
        QSATK(L)=PQ0/PK(L)*EXP(A2*(TNEW-A3)/(TNEW-A4))<a name='1533'>
        QNEW=(QRFKL-QK(L))*TAUKSC+QK(L)<a name='1534'>
<font color=#447700>!<a name='1535'></font>
        IF(QNEW&lt;QSATK(L)*RHLSC)THEN<a name='1536'>
          LBOT=0<a name='1537'>
<font color=#447700>!!!!      LTOP=LBOT<a name='1538'></font>
          LTOP=KTE<a name='1539'>
          PTOP=PBOT<a name='1540'>
          GO TO 800<a name='1541'>
        ENDIF<a name='1542'>
<font color=#447700>!<a name='1543'></font>
<font color=#447700>!-------------TOO MOIST CLOUDS NOT ALLOWED------------------------------<a name='1544'></font>
<font color=#447700>!<a name='1545'></font>
        IF(QNEW&gt;QSATK(L)*RHHSC)THEN<a name='1546'>
          LBOT=0<a name='1547'>
<font color=#447700>!!!!      LTOP=LBOT<a name='1548'></font>
          LTOP=KTE<a name='1549'>
          PTOP=PBOT<a name='1550'>
          GO TO 800<a name='1551'>
        ENDIF<a name='1552'>
<a name='1553'>
<font color=#447700>!<a name='1554'></font>
        THVREF(L)=TREFK(L)*APEK(L)*(QRFKL*D608+1.)<a name='1555'>
        QREFK(L)=QRFKL<a name='1556'>
      ENDDO<a name='1557'>
<font color=#447700>!<a name='1558'></font>
<font color=#447700>!------------------ ELIMINATE CLOUDS WITH BOTTOMS TOO DRY --------------<a name='1559'></font>
<font color=#447700>!!<a name='1560'></font>
<font color=#447700>!      qnew=(qrefk(lbot)-qk(lbot))*tauksc+qk(lbot)<a name='1561'></font>
<font color=#447700>!!<a name='1562'></font>
<font color=#447700>!      if(qnew&lt;qk(lbot+1)*stresh)then  !!?? stresh too large!!<a name='1563'></font>
<font color=#447700>!        lbot=0<a name='1564'></font>
<font color=#447700>!!!!!!   ltop=lbot<a name='1565'></font>
<font color=#447700>!        ltop=kte<a name='1566'></font>
<font color=#447700>!        ptop=pbot<a name='1567'></font>
<font color=#447700>!        go to 800<a name='1568'></font>
<font color=#447700>!      endif<a name='1569'></font>
<font color=#447700>!!<a name='1570'></font>
<font color=#447700>!-------------- ELIMINATE IMPOSSIBLE SLOPES (BETTS,DTHETA/DQ)------------<a name='1571'></font>
<font color=#447700>!<a name='1572'></font>
      DO L=LTOP,LBOT<a name='1573'>
        DTDP=(THVREF(L-1)-THVREF(L))/(PRSMID(L)-PRSMID(L-1))<a name='1574'>
<font color=#447700>!<a name='1575'></font>
        IF(DTDP&lt;EPSDT)THEN<a name='1576'>
          LBOT=0<a name='1577'>
<font color=#447700>!!!!!     LTOP=LBOT<a name='1578'></font>
          LTOP=KTE<a name='1579'>
          PTOP=PBOT<a name='1580'>
          GO TO 800<a name='1581'>
        ENDIF<a name='1582'>
<font color=#447700>!<a name='1583'></font>
      ENDDO<a name='1584'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1585'></font>
<font color=#447700>!--------------RELAXATION TOWARD REFERENCE PROFILES---------------------<a name='1586'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1587'></font>
<font color=#447700>!<a name='1588'></font>
      DO L=LTOP,LBOT<a name='1589'>
        DTDT(L)=(TREFK(L)-TK(L))*TAUKSC*RDTCNVC<a name='1590'>
        DQDT(L)=(QREFK(L)-QK(L))*TAUKSC*RDTCNVC<a name='1591'>
      ENDDO<a name='1592'>
<font color=#447700>!<a name='1593'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1594'></font>
<font color=#447700>!***  Begin debugging convection<a name='1595'></font>
      IF(PRINT_DIAG)THEN<a name='1596'>
        DO L=LBOT,LTOP,-1<a name='1597'>
          WRITE(6,"(a,i3,4e12.4)") '{cu2 KFLIP,DT,DTDT,DQ,DQDT = ' &amp;<a name='1598'>
               ,KTE+1-L,TREFK(L)-TK(L),DTDT(L),QREFK(L)-QK(L),DQDT(L)<a name='1599'>
        ENDDO<a name='1600'>
      ENDIF<a name='1601'>
<font color=#447700>!***  End debugging convection<a name='1602'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1603'></font>
<font color=#447700>!<a name='1604'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1605'></font>
<font color=#447700>!SCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCS<a name='1606'></font>
<font color=#447700>!SCSCSCSCSCSCSC         END OF SHALLOW CONVECTION        SCSCSCSCSCSCSCS<a name='1607'></font>
<font color=#447700>!SCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCSCS<a name='1608'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1609'></font>
  800 CONTINUE<a name='1610'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1611'></font>
      END SUBROUTINE BMJ<a name='1612'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1613'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='1614'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1615'></font>
<A NAME='TTBLEX'><A href='../../html_code/phys/module_cu_bmj.F.html#TTBLEX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1616'>
                           <font color=#993300>SUBROUTINE </font><font color=#cc0000>TTBLEX</font>                            &amp; <A href='../../call_to/TTBLEX.html' TARGET='index'>6</A><a name='1617'>
     &amp; (ITBX,JTBX,PLX,PRSMID,RDPX,RDTHEX,STHE                           &amp;<a name='1618'>
     &amp; ,THE0,THESP,TTBL,TREF)<a name='1619'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1620'></font>
<font color=#447700>!     ******************************************************************<a name='1621'></font>
<font color=#447700>!     *                                                                *<a name='1622'></font>
<font color=#447700>!     *           EXTRACT TEMPERATURE OF THE MOIST ADIABAT FROM        *<a name='1623'></font>
<font color=#447700>!     *                      THE APPROPRIATE TTBL                      *<a name='1624'></font>
<font color=#447700>!     *                                                                *<a name='1625'></font>
<font color=#447700>!     ******************************************************************<a name='1626'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1627'></font>
      IMPLICIT NONE<a name='1628'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1629'></font>
      INTEGER,INTENT(IN) :: ITBX,JTBX<a name='1630'>
<font color=#447700>!<a name='1631'></font>
      REAL,INTENT(IN) :: PLX,PRSMID,RDPX,RDTHEX,THESP<a name='1632'>
<font color=#447700>!<a name='1633'></font>
      REAL,DIMENSION(ITBX),INTENT(IN) :: STHE,THE0<a name='1634'>
<font color=#447700>!<a name='1635'></font>
      REAL,DIMENSION(JTBX,ITBX),INTENT(IN) :: TTBL<a name='1636'>
<font color=#447700>!<a name='1637'></font>
      REAL,INTENT(OUT) :: TREF<a name='1638'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1639'></font>
      REAL :: BTHE00K,BTHE10K,BTHK,PK,PP,QQ,STHE00K,STHE10K,STHK        &amp;<a name='1640'>
     &amp;       ,T00K,T01K,T10K,T11K,TPK,TTHK<a name='1641'>
<font color=#447700>!<a name='1642'></font>
      INTEGER :: IPTB,ITHTB<a name='1643'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1644'></font>
<font color=#447700>!----------------SCALING PRESSURE &amp; TT TABLE INDEX----------------------<a name='1645'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1646'></font>
      PK=PRSMID<a name='1647'>
      TPK=(PK-PLX)*RDPX<a name='1648'>
      QQ=TPK-AINT(TPK)<a name='1649'>
      IPTB=INT(TPK)+1<a name='1650'>
<font color=#447700>!----------------KEEPING INDICES WITHIN THE TABLE-----------------------<a name='1651'></font>
      IF(IPTB&lt;1)THEN<a name='1652'>
        IPTB=1<a name='1653'>
        QQ=0.<a name='1654'>
      ENDIF<a name='1655'>
<font color=#447700>!<a name='1656'></font>
      IF(IPTB&gt;=ITBX)THEN<a name='1657'>
        IPTB=ITBX-1<a name='1658'>
        QQ=0.<a name='1659'>
      ENDIF<a name='1660'>
<font color=#447700>!----------------BASE AND SCALING FACTOR FOR THETAE---------------------<a name='1661'></font>
      BTHE00K=THE0(IPTB)<a name='1662'>
      STHE00K=STHE(IPTB)<a name='1663'>
      BTHE10K=THE0(IPTB+1)<a name='1664'>
      STHE10K=STHE(IPTB+1)<a name='1665'>
<font color=#447700>!----------------SCALING THE &amp; TT TABLE INDEX---------------------------<a name='1666'></font>
      BTHK=(BTHE10K-BTHE00K)*QQ+BTHE00K<a name='1667'>
      STHK=(STHE10K-STHE00K)*QQ+STHE00K<a name='1668'>
      TTHK=(THESP-BTHK)/STHK*RDTHEX<a name='1669'>
      PP=TTHK-AINT(TTHK)<a name='1670'>
      ITHTB=INT(TTHK)+1<a name='1671'>
<font color=#447700>!----------------KEEPING INDICES WITHIN THE TABLE-----------------------<a name='1672'></font>
      IF(ITHTB&lt;1)THEN<a name='1673'>
        ITHTB=1<a name='1674'>
        PP=0.<a name='1675'>
      ENDIF<a name='1676'>
<font color=#447700>!<a name='1677'></font>
      IF(ITHTB&gt;=JTBX)THEN<a name='1678'>
        ITHTB=JTBX-1<a name='1679'>
        PP=0.<a name='1680'>
      ENDIF<a name='1681'>
<font color=#447700>!----------------TEMPERATURE AT FOUR SURROUNDING TT TABLE PTS.----------<a name='1682'></font>
      T00K=TTBL(ITHTB,IPTB)<a name='1683'>
      T10K=TTBL(ITHTB+1,IPTB)<a name='1684'>
      T01K=TTBL(ITHTB,IPTB+1)<a name='1685'>
      T11K=TTBL(ITHTB+1,IPTB+1)<a name='1686'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1687'></font>
<font color=#447700>!----------------PARCEL TEMPERATURE-------------------------------------<a name='1688'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1689'></font>
      TREF=(T00K+(T10K-T00K)*PP+(T01K-T00K)*QQ                          &amp;<a name='1690'>
     &amp;    +(T00K-T10K-T01K+T11K)*PP*QQ)<a name='1691'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1692'></font>
      END SUBROUTINE TTBLEX<a name='1693'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1694'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1695'></font>
<A NAME='BMJINIT'><A href='../../html_code/phys/module_cu_bmj.F.html#BMJINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1696'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>BMJINIT</font>(RTHCUTEN,RQVCUTEN,RQCCUTEN,RQRCUTEN            &amp; <A href='../../call_to/BMJINIT.html' TARGET='index'>1</A>,<A href='../../call_from/BMJINIT.html' TARGET='index'>3</A><a name='1697'>
     &amp;                  ,CLDEFI,LOWLYR,CP,RD,RESTART                    &amp;<a name='1698'>
     &amp;                  ,ALLOWED_TO_READ                                &amp;<a name='1699'>
     &amp;                  ,IDS,IDE,JDS,JDE,KDS,KDE                        &amp;<a name='1700'>
     &amp;                  ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='1701'>
     &amp;                  ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1702'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1703'></font>
      IMPLICIT NONE<a name='1704'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1705'></font>
      LOGICAL,INTENT(IN) :: RESTART,ALLOWED_TO_READ<a name='1706'>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='1707'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='1708'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='1709'>
<font color=#447700>!<a name='1710'></font>
      REAL,INTENT(IN) :: CP,RD<a name='1711'>
<font color=#447700>!<a name='1712'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT) ::            &amp;<a name='1713'>
     &amp;                                              RTHCUTEN            &amp;<a name='1714'>
     &amp;                                             ,RQVCUTEN            &amp;<a name='1715'>
     &amp;                                             ,RQCCUTEN            &amp;<a name='1716'>
     &amp;                                             ,RQRCUTEN<a name='1717'>
<font color=#447700>!<a name='1718'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: CLDEFI<a name='1719'>
<a name='1720'>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: LOWLYR<a name='1721'>
<font color=#447700>!<a name='1722'></font>
      REAL,PARAMETER :: EPS=1.E-9<a name='1723'>
<font color=#447700>!<a name='1724'></font>
      REAL, DIMENSION(JTB) :: APP,APT,AQP,AQT,PNEW,POLD,QSNEW,QSOLD     &amp;<a name='1725'>
     &amp;                       ,THENEW,THEOLD,TNEW,TOLD,Y2P,Y2T<a name='1726'>
<font color=#447700>!<a name='1727'></font>
      REAL,DIMENSION(JTBQ) :: APTQ,AQTQ,THENEWQ,THEOLDQ                 &amp;<a name='1728'>
     &amp;                       ,TNEWQ,TOLDQ,Y2TQ<a name='1729'>
<font color=#447700>!<a name='1730'></font>
      INTEGER :: I,J,K,ITF,JTF,KTF<a name='1731'>
      INTEGER :: KTH,KTHM,KTHM1,KP,KPM,KPM1<a name='1732'>
<font color=#447700>!<a name='1733'></font>
      REAL :: APE,DP,DQS,DTH,DTHE,P,QS,QS0K,SQSK,STHEK                  &amp;<a name='1734'>
     &amp;       ,TH,THE0K,DENOM,ELOCP<a name='1735'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1736'></font>
<a name='1737'>
      ELOCP=ELIWV/CP<a name='1738'>
      JTF=MIN0(JTE,JDE-1)<a name='1739'>
      KTF=MIN0(KTE,KDE-1)<a name='1740'>
      ITF=MIN0(ITE,IDE-1)<a name='1741'>
<font color=#447700>! <a name='1742'></font>
      IF(.NOT.RESTART)THEN<a name='1743'>
        DO J=JTS,JTF<a name='1744'>
        DO K=KTS,KTF<a name='1745'>
        DO I=ITS,ITF<a name='1746'>
          RTHCUTEN(I,K,J)=0.<a name='1747'>
          RQVCUTEN(I,K,J)=0.<a name='1748'>
          RQCCUTEN(I,K,J)=0.<a name='1749'>
          RQRCUTEN(I,K,J)=0.<a name='1750'>
        ENDDO<a name='1751'>
        ENDDO<a name='1752'>
        ENDDO<a name='1753'>
<font color=#447700>!<a name='1754'></font>
        DO J=JTS,JTF<a name='1755'>
        DO I=ITS,ITF<a name='1756'>
          CLDEFI(I,J)=AVGEFI<a name='1757'>
        ENDDO<a name='1758'>
        ENDDO<a name='1759'>
      ENDIF<a name='1760'>
<font color=#447700>!<a name='1761'></font>
<font color=#447700>!***  FOR NOW, ASSUME SIGMA MODE FOR LOWEST MODEL LAYER<a name='1762'></font>
<font color=#447700>!<a name='1763'></font>
      DO J=JTS,JTF<a name='1764'>
      DO I=ITS,ITF<a name='1765'>
        LOWLYR(I,J)=1<a name='1766'>
      ENDDO<a name='1767'>
      ENDDO<a name='1768'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1769'></font>
<font color=#447700>!----------------COARSE LOOK-UP TABLE FOR SATURATION POINT--------------<a name='1770'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1771'></font>
<font color=#447700>!<a name='1772'></font>
      KTHM=JTB<a name='1773'>
      KPM=ITB<a name='1774'>
      KTHM1=KTHM-1<a name='1775'>
      KPM1=KPM-1<a name='1776'>
<font color=#447700>!<a name='1777'></font>
      DTH=(THH-THL)/REAL(KTHM-1)<a name='1778'>
      DP =(PH -PL )/REAL(KPM -1)<a name='1779'>
<font color=#447700>!<a name='1780'></font>
      TH=THL-DTH<a name='1781'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1782'></font>
      DO 100 KTH=1,KTHM<a name='1783'>
<font color=#447700>!<a name='1784'></font>
      TH=TH+DTH<a name='1785'>
      P=PL-DP<a name='1786'>
<font color=#447700>!<a name='1787'></font>
      DO KP=1,KPM<a name='1788'>
        P=P+DP<a name='1789'>
        APE=(100000./P)**(RD/CP)<a name='1790'>
        DENOM=TH-A4*APE<a name='1791'>
        IF (DENOM&gt;EPS) THEN<a name='1792'>
           QSOLD(KP)=PQ0/P*EXP(A2*(TH-A3*APE)/DENOM)<a name='1793'>
        ELSE<a name='1794'>
           QSOLD(KP)=0.<a name='1795'>
        ENDIF<a name='1796'>
        POLD(KP)=P<a name='1797'>
      ENDDO<a name='1798'>
<font color=#447700>!<a name='1799'></font>
      QS0K=QSOLD(1)<a name='1800'>
      SQSK=QSOLD(KPM)-QSOLD(1)<a name='1801'>
      QSOLD(1  )=0.<a name='1802'>
      QSOLD(KPM)=1.<a name='1803'>
<font color=#447700>!<a name='1804'></font>
      DO KP=2,KPM1<a name='1805'>
        QSOLD(KP)=(QSOLD(KP)-QS0K)/SQSK<a name='1806'>
        IF((QSOLD(KP)-QSOLD(KP-1)).LT.EPS)QSOLD(KP)=QSOLD(KP-1)+EPS<a name='1807'>
      ENDDO<a name='1808'>
<font color=#447700>!<a name='1809'></font>
      QS0(KTH)=QS0K<a name='1810'>
      QS0_EXP(KTH)=QS0K<a name='1811'>
      SQS(KTH)=SQSK<a name='1812'>
      SQS_EXP(KTH)=SQSK<a name='1813'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1814'></font>
      QSNEW(1  )=0.<a name='1815'>
      QSNEW(KPM)=1.<a name='1816'>
      DQS=1./REAL(KPM-1)<a name='1817'>
<font color=#447700>!<a name='1818'></font>
      DO KP=2,KPM1<a name='1819'>
        QSNEW(KP)=QSNEW(KP-1)+DQS<a name='1820'>
      ENDDO<a name='1821'>
<font color=#447700>!<a name='1822'></font>
      Y2P(1   )=0.<a name='1823'>
      Y2P(KPM )=0.<a name='1824'>
<font color=#447700>!<a name='1825'></font>
      CALL <A href='../../html_code/phys/module_ra_flg.F.html#SPLINE'>SPLINE</A><A href='../../html_code/phys/module_cu_bmj.F.html#BMJINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPLINE_1">(JTB,KPM,QSOLD,POLD,Y2P,KPM,QSNEW,PNEW,APP,AQP)<a name='1826'>
<font color=#447700>!<a name='1827'></font>
      DO KP=1,KPM<a name='1828'>
        PTBL(KP,KTH)=PNEW(KP)<a name='1829'>
        PTBL_EXP(KP,KTH)=PNEW(KP)<a name='1830'>
      ENDDO<a name='1831'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1832'></font>
  100 CONTINUE<a name='1833'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1834'></font>
<font color=#447700>!------------COARSE LOOK-UP TABLE FOR T(P) FROM CONSTANT THE------------<a name='1835'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1836'></font>
      P=PL-DP<a name='1837'>
<font color=#447700>!<a name='1838'></font>
      DO 200 KP=1,KPM<a name='1839'>
<font color=#447700>!<a name='1840'></font>
      P=P+DP<a name='1841'>
      TH=THL-DTH<a name='1842'>
<font color=#447700>!<a name='1843'></font>
      DO KTH=1,KTHM<a name='1844'>
        TH=TH+DTH<a name='1845'>
        APE=(1.E5/P)**(RD/CP)<a name='1846'>
        DENOM=TH-A4*APE<a name='1847'>
        IF (DENOM&gt;EPS) THEN<a name='1848'>
           QS=PQ0/P*EXP(A2*(TH-A3*APE)/DENOM)<a name='1849'>
        ELSE<a name='1850'>
           QS=0.<a name='1851'>
        ENDIF<a name='1852'>
<font color=#447700>!        QS=PQ0/P*EXP(A2*(TH-A3*APE)/(TH-A4*APE))<a name='1853'></font>
        TOLD(KTH)=TH/APE<a name='1854'>
        THEOLD(KTH)=TH*EXP(ELOCP*QS/TOLD(KTH))<a name='1855'>
      ENDDO<a name='1856'>
<font color=#447700>!<a name='1857'></font>
      THE0K=THEOLD(1)<a name='1858'>
      STHEK=THEOLD(KTHM)-THEOLD(1)<a name='1859'>
      THEOLD(1   )=0.<a name='1860'>
      THEOLD(KTHM)=1.<a name='1861'>
<font color=#447700>!<a name='1862'></font>
      DO KTH=2,KTHM1<a name='1863'>
        THEOLD(KTH)=(THEOLD(KTH)-THE0K)/STHEK<a name='1864'>
        IF((THEOLD(KTH)-THEOLD(KTH-1)).LT.EPS)                          &amp;<a name='1865'>
     &amp;      THEOLD(KTH)=THEOLD(KTH-1)  +  EPS<a name='1866'>
      ENDDO<a name='1867'>
<font color=#447700>!<a name='1868'></font>
      THE0(KP)=THE0K<a name='1869'>
      STHE(KP)=STHEK<a name='1870'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1871'></font>
      THENEW(1  )=0.<a name='1872'>
      THENEW(KTHM)=1.<a name='1873'>
      DTHE=1./REAL(KTHM-1)<a name='1874'>
<font color=#447700>!<a name='1875'></font>
      DO KTH=2,KTHM1<a name='1876'>
        THENEW(KTH)=THENEW(KTH-1)+DTHE<a name='1877'>
      ENDDO<a name='1878'>
<font color=#447700>!<a name='1879'></font>
      Y2T(1   )=0.<a name='1880'>
      Y2T(KTHM)=0.<a name='1881'>
<font color=#447700>!<a name='1882'></font>
      CALL <A href='../../html_code/phys/module_ra_flg.F.html#SPLINE'>SPLINE</A><A href='../../html_code/phys/module_cu_bmj.F.html#BMJINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPLINE_2">(JTB,KTHM,THEOLD,TOLD,Y2T,KTHM,THENEW,TNEW,APT,AQT)<a name='1883'>
<font color=#447700>!<a name='1884'></font>
      DO KTH=1,KTHM<a name='1885'>
        TTBL(KTH,KP)=TNEW(KTH)<a name='1886'>
      ENDDO<a name='1887'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1888'></font>
  200 CONTINUE<a name='1889'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1890'></font>
<font color=#447700>!<a name='1891'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1892'></font>
<font color=#447700>!---------------FINE LOOK-UP TABLE FOR SATURATION POINT-----------------<a name='1893'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1894'></font>
      KTHM=JTBQ<a name='1895'>
      KPM=ITBQ<a name='1896'>
      KTHM1=KTHM-1<a name='1897'>
      KPM1=KPM-1<a name='1898'>
<font color=#447700>!<a name='1899'></font>
      DTH=(THHQ-THL)/REAL(KTHM-1)<a name='1900'>
      DP=(PH-PLQ)/REAL(KPM-1)<a name='1901'>
<font color=#447700>!<a name='1902'></font>
      TH=THL-DTH<a name='1903'>
      P=PLQ-DP<a name='1904'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1905'></font>
<font color=#447700>!---------------FINE LOOK-UP TABLE FOR T(P) FROM CONSTANT THE-----------<a name='1906'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1907'></font>
      DO 300 KP=1,KPM<a name='1908'>
<font color=#447700>!<a name='1909'></font>
      P=P+DP<a name='1910'>
      TH=THL-DTH<a name='1911'>
<font color=#447700>!<a name='1912'></font>
      DO KTH=1,KTHM<a name='1913'>
        TH=TH+DTH<a name='1914'>
        APE=(1.E5/P)**(RD/CP)<a name='1915'>
        DENOM=TH-A4*APE<a name='1916'>
        IF (DENOM&gt;EPS) THEN<a name='1917'>
           QS=PQ0/P*EXP(A2*(TH-A3*APE)/DENOM)<a name='1918'>
        ELSE<a name='1919'>
           QS=0.<a name='1920'>
        ENDIF<a name='1921'>
<font color=#447700>!        QS=PQ0/P*EXP(A2*(TH-A3*APE)/(TH-A4*APE))<a name='1922'></font>
        TOLDQ(KTH)=TH/APE<a name='1923'>
        THEOLDQ(KTH)=TH*EXP(ELOCP*QS/TOLDQ(KTH))<a name='1924'>
      ENDDO<a name='1925'>
<font color=#447700>!<a name='1926'></font>
      THE0K=THEOLDQ(1)<a name='1927'>
      STHEK=THEOLDQ(KTHM)-THEOLDQ(1)<a name='1928'>
      THEOLDQ(1   )=0.<a name='1929'>
      THEOLDQ(KTHM)=1.<a name='1930'>
<font color=#447700>!<a name='1931'></font>
      DO KTH=2,KTHM1<a name='1932'>
        THEOLDQ(KTH)=(THEOLDQ(KTH)-THE0K)/STHEK<a name='1933'>
        IF((THEOLDQ(KTH)-THEOLDQ(KTH-1))&lt;EPS)                           &amp;<a name='1934'>
     &amp;      THEOLDQ(KTH)=THEOLDQ(KTH-1)+EPS<a name='1935'>
      ENDDO<a name='1936'>
<font color=#447700>!<a name='1937'></font>
      THE0Q(KP)=THE0K<a name='1938'>
      STHEQ(KP)=STHEK<a name='1939'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1940'></font>
      THENEWQ(1  )=0.<a name='1941'>
      THENEWQ(KTHM)=1.<a name='1942'>
      DTHE=1./REAL(KTHM-1)<a name='1943'>
<font color=#447700>!<a name='1944'></font>
      DO KTH=2,KTHM1<a name='1945'>
        THENEWQ(KTH)=THENEWQ(KTH-1)+DTHE<a name='1946'>
      ENDDO<a name='1947'>
<font color=#447700>!<a name='1948'></font>
      Y2TQ(1   )=0.<a name='1949'>
      Y2TQ(KTHM)=0.<a name='1950'>
<font color=#447700>!<a name='1951'></font>
      CALL <A href='../../html_code/phys/module_ra_flg.F.html#SPLINE'>SPLINE</A><A href='../../html_code/phys/module_cu_bmj.F.html#BMJINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPLINE_3">(JTBQ,KTHM,THEOLDQ,TOLDQ,Y2TQ,KTHM                     &amp;<a name='1952'>
     &amp;           ,THENEWQ,TNEWQ,APTQ,AQTQ)<a name='1953'>
<font color=#447700>!<a name='1954'></font>
      DO KTH=1,KTHM<a name='1955'>
        TTBLQ(KTH,KP)=TNEWQ(KTH)<a name='1956'>
      ENDDO<a name='1957'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1958'></font>
  300 CONTINUE<a name='1959'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1960'></font>
      END SUBROUTINE BMJINIT<a name='1961'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1962'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='1963'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1964'></font>
<A NAME='SPLINE'><A href='../../html_code/phys/module_cu_bmj.F.html#SPLINE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1965'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SPLINE</font>(JTBX,NOLD,XOLD,YOLD,Y2,NNEW,XNEW,YNEW,P,Q) <A href='../../call_to/SPLINE.html' TARGET='index'>4</A><a name='1966'>
<font color=#447700>!   ********************************************************************<a name='1967'></font>
<font color=#447700>!   *                                                                  *<a name='1968'></font>
<font color=#447700>!   *  THIS IS A ONE-DIMENSIONAL CUBIC SPLINE FITTING ROUTINE          *<a name='1969'></font>
<font color=#447700>!   *  PROGRAMED FOR A SMALL SCALAR MACHINE.                           *<a name='1970'></font>
<font color=#447700>!   *                                                                  *<a name='1971'></font>
<font color=#447700>!   *  PROGRAMER Z. JANJIC                                             *<a name='1972'></font>
<font color=#447700>!   *                                                                  *<a name='1973'></font>
<font color=#447700>!   *  NOLD - NUMBER OF GIVEN VALUES OF THE FUNCTION.  MUST BE GE 3.   *<a name='1974'></font>
<font color=#447700>!   *  XOLD - LOCATIONS OF THE POINTS AT WHICH THE VALUES OF THE       *<a name='1975'></font>
<font color=#447700>!   *         FUNCTION ARE GIVEN.  MUST BE IN ASCENDING ORDER.         *<a name='1976'></font>
<font color=#447700>!   *  YOLD - THE GIVEN VALUES OF THE FUNCTION AT THE POINTS XOLD.     *<a name='1977'></font>
<font color=#447700>!   *  Y2   - THE SECOND DERIVATIVES AT THE POINTS XOLD.  IF NATURAL   *<a name='1978'></font>
<font color=#447700>!   *         SPLINE IS FITTED Y2(1)=0. AND Y2(NOLD)=0. MUST BE        *<a name='1979'></font>
<font color=#447700>!   *         SPECIFIED.                                               *<a name='1980'></font>
<font color=#447700>!   *  NNEW - NUMBER OF VALUES OF THE FUNCTION TO BE CALCULATED.       *<a name='1981'></font>
<font color=#447700>!   *  XNEW - LOCATIONS OF THE POINTS AT WHICH THE VALUES OF THE       *<a name='1982'></font>
<font color=#447700>!   *         FUNCTION ARE CALCULATED.  XNEW(K) MUST BE GE XOLD(1)     *<a name='1983'></font>
<font color=#447700>!   *         AND LE XOLD(NOLD).                                       *<a name='1984'></font>
<font color=#447700>!   *  YNEW - THE VALUES OF THE FUNCTION TO BE CALCULATED.             *<a name='1985'></font>
<font color=#447700>!   *  P, Q - AUXILIARY VECTORS OF THE LENGTH NOLD-2.                  *<a name='1986'></font>
<font color=#447700>!   *                                                                  *<a name='1987'></font>
<font color=#447700>!   ********************************************************************<a name='1988'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1989'></font>
      IMPLICIT NONE<a name='1990'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1991'></font>
      INTEGER,INTENT(IN) :: JTBX,NNEW,NOLD<a name='1992'>
      REAL,DIMENSION(JTBX),INTENT(IN) :: XNEW,XOLD,YOLD<a name='1993'>
      REAL,DIMENSION(JTBX),INTENT(INOUT) :: P,Q,Y2<a name='1994'>
      REAL,DIMENSION(JTBX),INTENT(OUT) :: YNEW<a name='1995'>
<font color=#447700>!<a name='1996'></font>
      INTEGER :: K,K1,K2,KOLD,NOLDM1<a name='1997'>
      REAL :: AK,BK,CK,DEN,DX,DXC,DXL,DXR,DYDXL,DYDXR                   &amp;<a name='1998'>
     &amp;       ,RDX,RTDXC,X,XK,XSQ,Y2K,Y2KP1<a name='1999'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2000'></font>
      NOLDM1=NOLD-1<a name='2001'>
<font color=#447700>!<a name='2002'></font>
      DXL=XOLD(2)-XOLD(1)<a name='2003'>
      DXR=XOLD(3)-XOLD(2)<a name='2004'>
      DYDXL=(YOLD(2)-YOLD(1))/DXL<a name='2005'>
      DYDXR=(YOLD(3)-YOLD(2))/DXR<a name='2006'>
      RTDXC=0.5/(DXL+DXR)<a name='2007'>
<font color=#447700>!<a name='2008'></font>
      P(1)= RTDXC*(6.*(DYDXR-DYDXL)-DXL*Y2(1))<a name='2009'>
      Q(1)=-RTDXC*DXR<a name='2010'>
<font color=#447700>!<a name='2011'></font>
      IF(NOLD==3)GO TO 150<a name='2012'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2013'></font>
      K=3<a name='2014'>
<font color=#447700>!<a name='2015'></font>
  100 DXL=DXR<a name='2016'>
      DYDXL=DYDXR<a name='2017'>
      DXR=XOLD(K+1)-XOLD(K)<a name='2018'>
      DYDXR=(YOLD(K+1)-YOLD(K))/DXR<a name='2019'>
      DXC=DXL+DXR<a name='2020'>
      DEN=1./(DXL*Q(K-2)+DXC+DXC)<a name='2021'>
<font color=#447700>!<a name='2022'></font>
      P(K-1)= DEN*(6.*(DYDXR-DYDXL)-DXL*P(K-2))<a name='2023'>
      Q(K-1)=-DEN*DXR<a name='2024'>
<font color=#447700>!<a name='2025'></font>
      K=K+1<a name='2026'>
      IF(K&lt;NOLD)GO TO 100<a name='2027'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2028'></font>
  150 K=NOLDM1<a name='2029'>
<font color=#447700>!<a name='2030'></font>
  200 Y2(K)=P(K-1)+Q(K-1)*Y2(K+1)<a name='2031'>
<font color=#447700>!<a name='2032'></font>
      K=K-1<a name='2033'>
      IF(K&gt;1)GO TO 200<a name='2034'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2035'></font>
      K1=1<a name='2036'>
<font color=#447700>!<a name='2037'></font>
  300 XK=XNEW(K1)<a name='2038'>
<font color=#447700>!<a name='2039'></font>
      DO 400 K2=2,NOLD<a name='2040'>
<font color=#447700>!<a name='2041'></font>
      IF(XOLD(K2)&gt;XK)THEN<a name='2042'>
        KOLD=K2-1<a name='2043'>
        GO TO 450<a name='2044'>
      ENDIF<a name='2045'>
<font color=#447700>!<a name='2046'></font>
  400 CONTINUE<a name='2047'>
<font color=#447700>!<a name='2048'></font>
      YNEW(K1)=YOLD(NOLD)<a name='2049'>
      GO TO 600<a name='2050'>
<font color=#447700>!<a name='2051'></font>
  450 IF(K1==1)GO TO 500<a name='2052'>
      IF(K==KOLD)GO TO 550<a name='2053'>
<font color=#447700>!<a name='2054'></font>
  500 K=KOLD<a name='2055'>
<font color=#447700>!<a name='2056'></font>
      Y2K=Y2(K)<a name='2057'>
      Y2KP1=Y2(K+1)<a name='2058'>
      DX=XOLD(K+1)-XOLD(K)<a name='2059'>
      RDX=1./DX<a name='2060'>
<font color=#447700>!<a name='2061'></font>
      AK=.1666667*RDX*(Y2KP1-Y2K)<a name='2062'>
      BK=0.5*Y2K<a name='2063'>
      CK=RDX*(YOLD(K+1)-YOLD(K))-.1666667*DX*(Y2KP1+Y2K+Y2K)<a name='2064'>
<font color=#447700>!<a name='2065'></font>
  550 X=XK-XOLD(K)<a name='2066'>
      XSQ=X*X<a name='2067'>
<font color=#447700>!<a name='2068'></font>
      YNEW(K1)=AK*XSQ*X+BK*XSQ+CK*X+YOLD(K)<a name='2069'>
<font color=#447700>!<a name='2070'></font>
  600 K1=K1+1<a name='2071'>
      IF(K1&lt;=NNEW)GO TO 300<a name='2072'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2073'></font>
      END SUBROUTINE SPLINE<a name='2074'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2075'></font>
<font color=#447700>!<a name='2076'></font>
      END MODULE MODULE_CU_BMJ<a name='2077'>
<font color=#447700>!<a name='2078'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2079'></font>
</pre></body></html>