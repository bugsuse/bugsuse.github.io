<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_BL_MFSHCONVPBL'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MODULE_BL_MFSHCONVPBL' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
     <font color=#993300>MODULE </font><font color=#cc0000>MODULE_BL_MFSHCONVPBL</font> <A href='../../call_to/MODULE_BL_MFSHCONVPBL.html' TARGET='index'>2</A><a name='3'>
<a name='4'>
<a name='5'>
<a name='6'>
<a name='7'>
USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#module_bl_mfshconvpbl.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_41"><a name='8'>
<a name='9'>
REAL,PARAMETER :: XG      = 9.80665<a name='10'>
<a name='11'>
REAL,PARAMETER :: XP00= 1.E5               <font color=#447700>! Reference pressure<a name='12'></font>
<font color=#447700>!<a name='13'></font>
<font color=#447700>!<a name='14'></font>
REAL,PARAMETER :: XMD= 28.9644E-3<a name='15'>
REAL,PARAMETER :: XMV= 18.0153E-3            <font color=#447700>! Molar mass of dry air and molar mass of vapor<a name='16'></font>
REAL,PARAMETER :: XRD=R_D<a name='17'>
REAL,PARAMETER :: XRV=R_V        <font color=#447700>! Gaz constant for dry air, gaz constant for vapor<a name='18'></font>
REAL,PARAMETER :: XCPD=7.* XRD /2.<a name='19'>
REAL,PARAMETER :: XCPV=4.* XRV          <font color=#447700>! Cpd (dry air), Cpv (vapor)<a name='20'></font>
REAL,PARAMETER :: XCL= 4.218E+3<a name='21'>
REAL,PARAMETER :: XCI= 2.106E+3      <font color=#447700>! Cl (liquid), Ci (ice)<a name='22'></font>
REAL,PARAMETER :: XTT= 273.16        <font color=#447700>! Triple point temperature<a name='23'></font>
REAL,PARAMETER :: XLVTT=2.5008E+6              <font color=#447700>! Vaporization heat constant<a name='24'></font>
REAL,PARAMETER :: XLSTT=2.8345E+6   <font color=#447700>! Sublimation heat constant<a name='25'></font>
                               <font color=#447700>!  temperature<a name='26'></font>
REAL,PARAMETER :: XGAMW = (XCL - XCPV) / XRV<font color=#447700>! Constants for saturation vapor<a name='27'></font>
REAL,PARAMETER :: XBETAW= (XLVTT/XRV) + (XGAMW * XTT)<a name='28'>
<font color=#447700>!The use of intrinsics in an initialization expressions is a F2003 feature.<a name='29'></font>
<font color=#447700>!For backward compatibility, hard coded Log(644.11) &amp; Log(XTT) here<a name='30'></font>
<font color=#447700>!REAL,PARAMETER :: XALPW= LOG(611.14) + (XBETAW /XTT) + (XGAMW *LOG(XTT))<a name='31'></font>
REAL,PARAMETER :: LOG_611_14 = 6.415326<a name='32'>
REAL,PARAMETER :: LOG_XTT    = 5.610058<a name='33'>
REAL,PARAMETER :: XALPW= LOG_611_14 + (XBETAW /XTT) + (XGAMW *LOG_XTT)<a name='34'>
                                <font color=#447700>!  pressure  function<a name='35'></font>
REAL,PARAMETER :: XGAMI  = (XCI - XCPV) / XRV<a name='36'>
REAL,PARAMETER :: XBETAI = (XLSTT/XRV) + (XGAMI * XTT)<a name='37'>
<font color=#447700>!REAL,PARAMETER :: XALPI  = LOG(611.14) + (XBETAI /XTT) + (XGAMI *LOG(XTT))<a name='38'></font>
REAL,PARAMETER :: XALPI  = LOG_611_14 + (XBETAI /XTT) + (XGAMI *LOG_XTT)<a name='39'>
REAL,PARAMETER :: XLINI = 0.32<a name='40'>
<a name='41'>
<a name='42'>
REAL, PARAMETER :: XALP_PERT   = 0.3  <font color=#447700>! coefficient for the perturbation of<a name='43'></font>
                   <font color=#447700>! theta_l and r_t at the first level of<a name='44'></font>
                   <font color=#447700>! the updraft<a name='45'></font>
REAL, PARAMETER ::XABUO       = 1.   <font color=#447700>! coefficient of the buoyancy term in the w_up equation<a name='46'></font>
REAL, PARAMETER ::XBENTR      = 1.   <font color=#447700>! coefficient of the entrainment term in thew_up equation<a name='47'></font>
REAL, PARAMETER ::XBDETR      = 0.   <font color=#447700>! coefficient of the detrainment term in thew_up equation<a name='48'></font>
<a name='49'>
<a name='50'>
REAL, PARAMETER ::XCMF        = 0.065<font color=#447700>! coefficient for the mass flux at the firstlevel 0.065<a name='51'></font>
                                <font color=#447700>! of the updraft (closure) XCMF        = 0.065<a name='52'></font>
REAL, PARAMETER ::XENTR_DRY   = 0.55 <font color=#447700>! coefficient for entrainment in dry part XENTR_DRY   = 0.55<a name='53'></font>
REAL, PARAMETER ::XDETR_DRY   = 10.  <font color=#447700>! coefficient for detrainment in dry part XDETR_DRY   = 10.<a name='54'></font>
REAL, PARAMETER ::XDETR_LUP   = 1.0   <font color=#447700>!  coefficient for detrainment in dry part XDETR_LUP   = 1.<a name='55'></font>
<a name='56'>
REAL, PARAMETER ::XENTR_MF    = 0.035<font color=#447700>! entrainment constant (m/Pa) = 0.2 (m)  XENTR_MF    = 0.035<a name='57'></font>
REAL, PARAMETER ::XCRAD_MF    = 50.  <font color=#447700>! cloud radius in cloudy part<a name='58'></font>
REAL, PARAMETER ::XKCF_MF     = 2.75 <font color=#447700>! coefficient for cloud fraction<a name='59'></font>
REAL, PARAMETER ::XKRC_MF     = 1.   <font color=#447700>! coefficient for convective rc<a name='60'></font>
REAL, PARAMETER ::XTAUSIGMF   = 600.<a name='61'>
REAL, PARAMETER ::XPRES_UV    = 0.5  <font color=#447700>! coefficient for pressure term in wind mixing<a name='62'></font>
<font color=#447700>!<a name='63'></font>
REAL, PARAMETER ::XFRAC_UP_MAX= 0.33 <font color=#447700>! maximum Updraft fraction<a name='64'></font>
<a name='65'>
<a name='66'>
<font color=#447700>!<a name='67'></font>
<a name='68'>
     CONTAINS<a name='69'>
<a name='70'>
<a name='71'>
<A NAME='MFSHCONVPBL'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MFSHCONVPBL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='72'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>MFSHCONVPBL</font> (DT,STEPBL,HT,DZ           &amp; <A href='../../call_to/MFSHCONVPBL.html' TARGET='index'>1</A>,<A href='../../call_from/MFSHCONVPBL.html' TARGET='index'>1</A><a name='73'>
                    ,RHO,PMID,PINT,TH,EXNER             &amp;<a name='74'>
                    ,QV, QC, U, V                       &amp;<a name='75'>
                    ,HFX, QFX, TKE                      &amp;<a name='76'>
                    ,RUBLTEN,RVBLTEN,RTHBLTEN           &amp;<a name='77'>
                    ,RQVBLTEN,RQCBLTEN                  &amp;<a name='78'>
                    ,IDS,IDE,JDS,JDE,KDS,KDE            &amp;<a name='79'>
                    ,IMS,IME,JMS,JME,KMS,KME            &amp;<a name='80'>
                    ,ITS,ITE,JTS,JTE,KTS,KTE,KRR        &amp;<a name='81'>
                    ,MASSFLUX_EDKF, ENTR_EDKF, DETR_EDKF &amp; <a name='82'>
                    ,THL_UP, THV_UP, RT_UP, RV_UP       &amp;<a name='83'>
                    ,RC_UP, U_UP, V_UP, FRAC_UP, RC_MF  &amp;<a name='84'>
                    ,WTHV,PLM_BL89 )                   <a name='85'>
 <a name='86'>
      IMPLICIT NONE<a name='87'>
<font color=#447700>!<a name='88'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='89'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='90'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='91'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='92'>
<font color=#447700>!<a name='93'></font>
      INTEGER,INTENT(IN) :: KRR<a name='94'>
<a name='95'>
      INTEGER,INTENT(IN) :: STEPBL<a name='96'>
<a name='97'>
      REAL,INTENT(IN) :: DT<a name='98'>
<font color=#447700>!<a name='99'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: HT, HFX, QFX<a name='100'>
<font color=#447700>!<a name='101'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: DZ          &amp;<a name='102'>
     &amp;                                                     ,EXNER       &amp;<a name='103'>
     &amp;                                                     ,PMID,PINT   &amp;<a name='104'>
     &amp;                                                     ,QV,QC,RHO   &amp;<a name='105'>
     &amp;                                                     ,TH,U,V,TKE   <a name='106'>
<font color=#447700>!<a name='107'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(INOUT) :: RQCBLTEN,RQVBLTEN       &amp;<a name='108'>
     &amp;                                        ,RTHBLTEN                                &amp;<a name='109'>
     &amp;                                        ,RUBLTEN,RVBLTEN        <a name='110'>
  <a name='111'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),OPTIONAL,INTENT(OUT) ::              &amp;<a name='112'>
     &amp;                                         MASSFLUX_EDKF, ENTR_EDKF, DETR_EDKF &amp;<a name='113'>
     &amp;                                        ,THL_UP, THV_UP, RT_UP, RV_UP        &amp;<a name='114'>
     &amp;                                        ,RC_UP, U_UP, V_UP, FRAC_UP<a name='115'>
<a name='116'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),OPTIONAL,INTENT(INOUT) ::            &amp;<a name='117'>
     &amp;                                         RC_MF<a name='118'>
<a name='119'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(INOUT) ::   WTHV<a name='120'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(INOUT) ::   PLM_BL89<a name='121'>
<a name='122'>
<font color=#447700>!<a name='123'></font>
<font color=#447700>!Local declaration<a name='124'></font>
<a name='125'>
INTEGER   :: KRRL      <font color=#447700>! number of liquid water var.<a name='126'></font>
INTEGER   :: KRRI      <font color=#447700>! number of ice water var.<a name='127'></font>
LOGICAL   :: OMIXUV    <font color=#447700>! True if mixing of momentum<a name='128'></font>
<a name='129'>
REAL   :: PIMPL_MF     <font color=#447700>! degre of implicitness<a name='130'></font>
REAL   ::  PTSTEP   <font color=#447700>! Dynamical timestep <a name='131'></font>
REAL   ::  PTSTEP_MET<font color=#447700>! Timestep for meteorological variables                        <a name='132'></font>
<a name='133'>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE)   :: PZZ       <font color=#447700>!  Height at the flux point<a name='134'></font>
<a name='135'>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE)   :: PZZM      <font color=#447700>!  Height at the mass point<a name='136'></font>
<a name='137'>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE)   :: PDZZ      <font color=#447700>! depth between mass levels <a name='138'></font>
 <a name='139'>
REAL, DIMENSION(ITS:ITE,JTS:JTE)   ::  PSFTH,PSFRV<a name='140'>
                                            <font color=#447700>! normal surface fluxes of theta,rv<a name='141'></font>
<font color=#447700>!<a name='142'></font>
<font color=#447700>!    prognostic variables at t- deltat<a name='143'></font>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE) ::  PPABSM      <font color=#447700>! Pressure at mass point<a name='144'></font>
<font color=#447700>!REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE) ::  PPABSF    ! Pressure at flux point<a name='145'></font>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE) ::  PEXNM       <font color=#447700>! Exner function at t-dt<a name='146'></font>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE) ::  PRHODREF    <font color=#447700>! dry density of the<a name='147'></font>
                                                     <font color=#447700>! reference state<a name='148'></font>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE) ::  PRHODJ    <font color=#447700>! dry density of the<a name='149'></font>
<a name='150'>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE) ::  PTKEM       <font color=#447700>! TKE<a name='151'></font>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE) ::  PUM,PVM     <font color=#447700>! momentum<a name='152'></font>
<a name='153'>
<font color=#447700>!   thermodynamical variables which are transformed in conservative var.<a name='154'></font>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE)     ::  PTHM       <font color=#447700>! pot. temp. = PTHLM in turb.f90<a name='155'></font>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE,KRR) ::  PRM        <font color=#447700>! water species <a name='156'></font>
<a name='157'>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE)     ::  PRUS,PRVS,PRTHS <a name='158'>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE,KRR) ::  PRRS<a name='159'>
<a name='160'>
<font color=#447700>! For diagnostic output<a name='161'></font>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE)     :: PEMF, PENTR, PDETR<a name='162'>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE)     :: PTHL_UP, PRT_UP, PRV_UP, PRC_UP<a name='163'>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE)     :: PU_UP, PV_UP, PTHV_UP, PFRAC_UP                   <a name='164'>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE)     :: PRC_MF<a name='165'>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE)     :: WTHV_MF<a name='166'>
REAL, DIMENSION(ITS:ITE,JTS:JTE,KTS:KTE)     :: PLM_MF<a name='167'>
<a name='168'>
INTEGER :: I,J,K  <font color=#447700>! loop variables<a name='169'></font>
      <a name='170'>
<font color=#447700>! Transform WRF Variable to input of mass flux scheme<a name='171'></font>
<a name='172'>
DO J=JTS,JTE<a name='173'>
   DO K=KTS,KTE<a name='174'>
      DO I=ITS,ITE<a name='175'>
        IF (K==KTS) PZZ(I,J,K)=0.<a name='176'>
        PEMF(I,J,K)=0.<a name='177'>
        PENTR(I,J,K)=0.<a name='178'>
        PDETR(I,J,K)=0.<a name='179'>
        PTHL_UP(I,J,K)=0.<a name='180'>
        PTHV_UP(I,J,K)=0.<a name='181'>
        PRT_UP(I,J,K)=0.<a name='182'>
        PRV_UP(I,J,K)=0.<a name='183'>
        PRC_UP(I,J,K)=0.<a name='184'>
        PU_UP(I,J,K)=0.<a name='185'>
        PV_UP(I,J,K)=0.<a name='186'>
        PFRAC_UP(I,J,K)=0.<a name='187'>
        WTHV_MF(I,J,K)=0.<a name='188'>
        PTHM(I,J,K)=TH(I,K,J)<a name='189'>
        PTKEM(I,J,K)=TKE(I,K,J)<a name='190'>
        PRM(I,J,K,1)=QV(I,K,J)-RC_MF(I,K,J)<a name='191'>
        PRM(I,J,K,2)=RC_MF(I,K,J)<a name='192'>
        PUM(I,J,K)=U(I,K,J)<a name='193'>
        PVM(I,J,K)=V(I,K,J)<a name='194'>
        PRHODREF(I,J,K)=RHO(I,K,J)/(1.+QV(I,K,J))<a name='195'>
        PEXNM(I,J,K)=EXNER(I,K,J)<a name='196'>
        PPABSM(I,J,K)=PMID(I,K,J)<a name='197'>
        IF (K/=KTE) THEN<a name='198'>
            PZZ(I,J,K+1)=PZZ(I,J,K)+DZ(I,K,J)<a name='199'>
            PZZM(I,J,K)=0.5*(PZZ(I,J,K+1)+PZZ(I,J,K)) <font color=#447700>! z at mass point<a name='200'></font>
        ELSE<a name='201'>
            PZZM(I,J,K)=PZZ(I,J,K)+0.5*DZ(I,K-1,J) <font color=#447700>! z at mass point<a name='202'></font>
        ENDIF<a name='203'>
        IF (K==KTS) THEN<a name='204'>
           PDZZ(I,J,K)=2*(PZZM(I,J,K))      <a name='205'>
        ELSE<a name='206'>
           PDZZ(I,J,K)=PZZM(I,J,K)-PZZM(I,J,K-1)      <a name='207'>
        ENDIF<a name='208'>
     <a name='209'>
        PRHODJ(I,J,K)=PRHODREF(I,J,K)*DZ(I,K,J)<a name='210'>
  <a name='211'>
<a name='212'>
      ENDDO<a name='213'>
   ENDDO<a name='214'>
ENDDO<a name='215'>
<a name='216'>
<font color=#447700>! fill the kte+1 level<a name='217'></font>
PTHM(:,:,KTE)=PTHM(:,:,KTE-1)<a name='218'>
PTKEM(:,:,KTE)=PTKEM(:,:,KTE-1)<a name='219'>
PRM(:,:,KTE,1)=PRM(:,:,KTE-1,1)<a name='220'>
PRM(:,:,KTE,2)=PRM(:,:,KTE-1,2)<a name='221'>
PUM(:,:,KTE)=PUM(:,:,KTE-1)<a name='222'>
PVM(:,:,KTE)=PVM(:,:,KTE-1)<a name='223'>
PRHODREF(:,:,KTE)=PRHODREF(:,:,KTE-1)<a name='224'>
PEXNM(:,:,KTE)=PEXNM(:,:,KTE-1)<a name='225'>
PPABSM(:,:,KTE)=PPABSM(:,:,KTE-1)<a name='226'>
PRHODJ(:,:,KTE)=PRHODJ(:,:,KTE-1)<a name='227'>
<a name='228'>
PSFTH(:,:)=HFX(ITS:ITE,JTS:JTE)/(PRHODREF(:,:,KTS)*XCPD)<a name='229'>
PSFRV(:,:)=QFX(ITS:ITE,JTS:JTE)/(PRHODREF(:,:,KTS))<a name='230'>
<a name='231'>
<a name='232'>
<a name='233'>
<font color=#447700>! Assign some variables<a name='234'></font>
<a name='235'>
OMIXUV=.FALSE.<a name='236'>
KRRL=1 <font color=#447700>!Qc is managed<a name='237'></font>
KRRI=0 <font color=#447700>!Qi not<a name='238'></font>
PIMPL_MF=0.<a name='239'>
PTSTEP=DT*STEPBL<a name='240'>
PTSTEP_MET=PTSTEP<a name='241'>
<a name='242'>
      CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MFSHCONVPBL_CORE'>MFSHCONVPBL_CORE</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MFSHCONVPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MFSHCONVPBL_CORE_1">(KRR,KRRL,KRRI,                            &amp;<a name='243'>
                OMIXUV,                                               &amp;<a name='244'>
                PIMPL_MF,PTSTEP,PTSTEP_MET,                           &amp;<a name='245'>
                PDZZ, PZZ,                                            &amp;<a name='246'>
                PRHODJ, PRHODREF,                                     &amp;<a name='247'>
                PPABSM, PEXNM,                                        &amp;<a name='248'>
                PSFTH,PSFRV,                                          &amp;<a name='249'>
                PTHM,PRM,PUM,PVM,PTKEM,                               &amp;<a name='250'>
                PRTHS,PRRS,PRUS,PRVS,PEMF, PENTR, PDETR,              &amp;<a name='251'>
                PTHL_UP, PRT_UP, PRV_UP, PRC_UP,                      &amp;<a name='252'>
                PU_UP, PV_UP, PTHV_UP, PFRAC_UP, PRC_MF, WTHV_MF,PLM_MF  )<a name='253'>
<a name='254'>
<a name='255'>
DO J=JTS,JTE<a name='256'>
   DO K=KTS,KTE<a name='257'>
      DO I=ITS,ITE<a name='258'>
         RQCBLTEN(I,K,J)=PRRS(I,J,K,2)       <a name='259'>
         RQVBLTEN(I,K,J)=PRRS(I,J,K,1)       <a name='260'>
         RTHBLTEN(I,K,J)=PRTHS(I,J,K)                <a name='261'>
         RUBLTEN(I,K,J)=PRUS(I,J,K)<a name='262'>
         RVBLTEN(I,K,J)=PRVS(I,J,K)<a name='263'>
         WTHV(I,K,J)=WTHV_MF(I,J,K)<a name='264'>
         PLM_BL89(I,K,J)=PLM_MF(I,J,K)<a name='265'>
      ENDDO<a name='266'>
   ENDDO<a name='267'>
ENDDO<a name='268'>
<a name='269'>
      IF ( PRESENT(MASSFLUX_EDKF) ) THEN<a name='270'>
         DO J=JTS,JTE<a name='271'>
            DO K=KTS,KTE<a name='272'>
               DO I=ITS,ITE<a name='273'>
                  MASSFLUX_EDKF(I,K,J)=PEMF(I,J,K)<a name='274'>
                  ENTR_EDKF(I,K,J)=PENTR(I,J,K)<a name='275'>
                  DETR_EDKF(I,K,J)=PDETR(I,J,K)<a name='276'>
                  THL_UP(I,K,J)=PTHL_UP(I,J,K)<a name='277'>
                  THV_UP(I,K,J)=PTHV_UP(I,J,K)<a name='278'>
                  RT_UP(I,K,J)=PRT_UP(I,J,K)<a name='279'>
                  RV_UP(I,K,J)=PRV_UP(I,J,K)<a name='280'>
                  RC_UP(I,K,J)=PRC_UP(I,J,K)<a name='281'>
                  U_UP(I,K,J)=PU_UP(I,J,K)<a name='282'>
                  V_UP(I,K,J)=PV_UP(I,J,K)<a name='283'>
                  FRAC_UP(I,K,J)=PFRAC_UP(I,J,K)<a name='284'>
                  RC_MF(I,K,J)=PRC_MF(I,J,K)<a name='285'>
               ENDDO<a name='286'>
            ENDDO<a name='287'>
         ENDDO<a name='288'>
      ENDIF<a name='289'>
<a name='290'>
<a name='291'>
END SUBROUTINE MFSHCONVPBL<a name='292'>
<a name='293'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='294'></font>
<font color=#447700>!   WRAPPER from WRF to MASS FLUX SCHEME <a name='295'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   <a name='296'></font>
  <a name='297'>
<A NAME='MFSHCONVPBL_CORE'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MFSHCONVPBL_CORE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='298'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>MFSHCONVPBL_CORE</font>(KRR,KRRL,KRRI,                            &amp; <A href='../../call_to/MFSHCONVPBL_CORE.html' TARGET='index'>1</A>,<A href='../../call_from/MFSHCONVPBL_CORE.html' TARGET='index'>6</A><a name='299'>
                OMIXUV,                       &amp;<a name='300'>
                PIMPL_MF,PTSTEP,PTSTEP_MET,                 &amp;<a name='301'>
                PDZZ, PZZ,                                            &amp;<a name='302'>
                PRHODJ, PRHODREF,                                     &amp;<a name='303'>
                PPABSM, PEXNM,                                        &amp;<a name='304'>
                PSFTH,PSFRV,                                          &amp;<a name='305'>
                PTHM,PRM,PUM,PVM,PTKEM,                               &amp;<a name='306'>
                PRTHS,PRRS,PRUS,PRVS,  PEMF, PENTR, PDETR,            &amp;<a name='307'>
                PTHL_UP, PRT_UP, PRV_UP, PRC_UP,                      &amp;<a name='308'>
                PU_UP, PV_UP, PTHV_UP, PFRAC_UP,  PRC_MF,             &amp;<a name='309'>
                PFLXZTHVMF,PLM       )<a name='310'>
<font color=#447700>!!<a name='311'></font>
<font color=#447700>!!****  *MFSHCONVPBL_CORE* - Interfacing routine<a name='312'></font>
<font color=#447700>!!<a name='313'></font>
<a name='314'>
<font color=#447700>!! --------------------------------------------------------------------------<a name='315'></font>
<font color=#447700>!<a name='316'></font>
<a name='317'>
<a name='318'>
IMPLICIT NONE<a name='319'>
<a name='320'>
INTEGER,                INTENT(IN)   :: KRR          <font color=#447700>! number of moist var.<a name='321'></font>
INTEGER,                INTENT(IN)   :: KRRL         <font color=#447700>! number of liquid water var.<a name='322'></font>
INTEGER,                INTENT(IN)   :: KRRI         <font color=#447700>! number of ice water var.<a name='323'></font>
LOGICAL,                INTENT(IN)   :: OMIXUV    <font color=#447700>! True if mixing of momentum<a name='324'></font>
             <a name='325'>
REAL,                   INTENT(IN)   :: PIMPL_MF     <font color=#447700>! degre of implicitness<a name='326'></font>
REAL,                 INTENT(IN)     ::  PTSTEP   <font color=#447700>! Dynamical timestep <a name='327'></font>
REAL,                 INTENT(IN)     ::  PTSTEP_MET<font color=#447700>! Timestep for meteorological variables                        <a name='328'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN) ::  PZZ         <font color=#447700>! Height of flux point<a name='329'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN) ::  PDZZ        <font color=#447700>! Metric coefficients<a name='330'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN) ::  PRHODJ      <font color=#447700>! dry density * Grid size<a name='331'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN) ::  PRHODREF    <font color=#447700>! dry density of the<a name='332'></font>
                                                     <font color=#447700>! reference state<a name='333'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN) ::  PPABSM      <font color=#447700>! Pressure at time t-1<a name='334'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN) ::  PEXNM       <font color=#447700>! Exner function at t-dt<a name='335'></font>
<a name='336'>
REAL, DIMENSION(:,:),   INTENT(IN)   ::  PSFTH,PSFRV <font color=#447700>! normal surface fluxes of theta and Rv <a name='337'></font>
REAL, DIMENSION(:,:,:), INTENT(IN)   ::  PTHM        <font color=#447700>! Theta at t-dt<a name='338'></font>
REAL, DIMENSION(:,:,:,:), INTENT(IN) ::  PRM         <font color=#447700>! water var. at t-dt<a name='339'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN) ::  PUM,PVM     <font color=#447700>! wind components at t-dt<a name='340'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN) ::  PTKEM       <font color=#447700>! tke at t-dt<a name='341'></font>
<a name='342'>
<a name='343'>
REAL, DIMENSION(:,:,:),   INTENT(OUT) ::  PRUS,PRVS,PRTHS <font color=#447700>! Meso-NH sources<a name='344'></font>
REAL, DIMENSION(:,:,:,:), INTENT(OUT) ::  PRRS <a name='345'>
<a name='346'>
REAL, DIMENSION(:,:,:), INTENT(OUT) ::  PEMF, PENTR, PDETR<a name='347'>
REAL, DIMENSION(:,:,:), INTENT(OUT) ::  PTHL_UP, PRT_UP, PRV_UP, PRC_UP <a name='348'>
REAL, DIMENSION(:,:,:), INTENT(OUT) ::  PU_UP, PV_UP, PTHV_UP, PFRAC_UP<a name='349'>
REAL, DIMENSION(:,:,:), INTENT(INOUT) ::  PRC_MF <a name='350'>
REAL, DIMENSION(:,:,:), INTENT(OUT) ::  PFLXZTHVMF <a name='351'>
REAL, DIMENSION(:,:,:), INTENT(OUT) ::  PLM<a name='352'>
  <a name='353'>
<a name='354'>
<font color=#447700>!<a name='355'></font>
<font color=#447700>!                     0.2  Declaration of local variables<a name='356'></font>
<font color=#447700>!<a name='357'></font>
REAL, DIMENSION(SIZE(PTHM,1),SIZE(PTHM,2),SIZE(PTHM,3)) ::     &amp;<a name='358'>
          ZEXN,ZCPH,                                      &amp;<a name='359'>
          PRV,PRL,PTH,                                    &amp;<a name='360'>
          ZTM,                                            &amp;  <font color=#447700>! Temperature at t-dt<a name='361'></font>
          ZLVOCPEXN,                                      &amp;  <font color=#447700>!<a name='362'></font>
          ZCF_MF,                                         &amp; <a name='363'>
          ZLSOCPEXN,                                      &amp;  <font color=#447700>!<a name='364'></font>
          ZAMOIST,                                        &amp;  <font color=#447700>!<a name='365'></font>
          ZATHETA,                                        &amp;  <font color=#447700>!<a name='366'></font>
          ZTHLM,                                          &amp;  <font color=#447700>!<a name='367'></font>
          ZRTM,                                           &amp;  <font color=#447700>!<a name='368'></font>
          ZTHVM,ZTHVREF,ZUMM,ZVMM,                        &amp;  <font color=#447700>!<a name='369'></font>
          ZRI_UP,ZW_UP,                                   &amp; <font color=#447700>! <a name='370'></font>
          ZEMF_O_RHODREF,                                 &amp; <font color=#447700>! entrainment/detrainment<a name='371'></font>
          ZTHLDT,ZRTDT,ZUDT,ZVDT,                         &amp; <font color=#447700>! tendencies<a name='372'></font>
          ZFLXZTHMF,ZFLXZRMF,ZFLXZUMF,ZFLXZVMF   <font color=#447700>! fluxes<a name='373'></font>
<a name='374'>
<a name='375'>
INTEGER,DIMENSION(SIZE(PTHM,1),SIZE(PTHM,2))  :: IKLCL,IKETL,IKCTL <a name='376'>
                    <a name='377'>
INTEGER :: IKU, IKB, IKE  <a name='378'>
INTEGER :: JI,JJ,JK,JSV                          <font color=#447700>! Loop counters<a name='379'></font>
INTEGER :: IRESP    <font color=#447700>! error code<a name='380'></font>
<a name='381'>
<a name='382'>
<font color=#447700>!------------------------------------------------------------------------<a name='383'></font>
<a name='384'>
<font color=#447700>!!! 1. Initialisation<a name='385'></font>
<a name='386'>
<font color=#447700>! Internal Domain<a name='387'></font>
IKU=SIZE(PTHM,3)<a name='388'>
IKB=1              <font color=#447700>! Modif WRF JP<a name='389'></font>
IKE=IKU-1<a name='390'>
<a name='391'>
<a name='392'>
<font color=#447700>! number of scalar var<a name='393'></font>
<a name='394'>
  ZUMM=PUM   <font color=#447700>!Modif WRF JP<a name='395'></font>
  ZVMM=PVM   <font color=#447700>!Modif WRF JP<a name='396'></font>
<a name='397'>
<font color=#447700>! Thermodynamics functions<a name='398'></font>
<a name='399'>
  CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_FUNCTION_THERMO_MF'>COMPUTE_FUNCTION_THERMO_MF</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MFSHCONVPBL_CORE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_FUNCTION_THERMO_MF_1">( KRR,KRRL,KRRI,                   &amp;<a name='400'>
                                   PTHM,PRM,PEXNM,PPABSM,           &amp;<a name='401'>
                                   ZTM,ZLVOCPEXN,ZLSOCPEXN,         &amp;<a name='402'>
                                   ZAMOIST,ZATHETA                  )<a name='403'>
<a name='404'>
<a name='405'>
<a name='406'>
<font color=#447700>! Conservative variables at t-dt<a name='407'></font>
<a name='408'>
  CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#THL_RT_FROM_TH_R_MF'>THL_RT_FROM_TH_R_MF</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MFSHCONVPBL_CORE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THL_RT_FROM_TH_R_MF_1">( KRR,KRRL,KRRI,                         &amp;<a name='409'>
                                  PTHM, PRM, ZLVOCPEXN, ZLSOCPEXN,       &amp;<a name='410'>
                                  ZTHLM, ZRTM                            )<a name='411'>
<a name='412'>
<a name='413'>
<a name='414'>
<font color=#447700>! Virtual potential temperature at t-dt<a name='415'></font>
<a name='416'>
ZTHVM(:,:,:) = PTHM(:,:,:)*((1.+XRV / XRD *PRM(:,:,:,1))/(1.+ZRTM(:,:,:))) <a name='417'>
<a name='418'>
<a name='419'>
       ZTHVREF=XG/ZTHVM<a name='420'>
       CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#BL89'>BL89</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MFSHCONVPBL_CORE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BL89_1">(PZZ,PDZZ,ZTHVREF,ZTHLM,KRR, &amp;<a name='421'>
                 PRM,PTKEM,PLM)<a name='422'>
<a name='423'>
<font color=#447700>!!! 2. Compute updraft<a name='424'></font>
<a name='425'>
<a name='426'>
      CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#UPDRAFT_SOPE'>UPDRAFT_SOPE</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MFSHCONVPBL_CORE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPDRAFT_SOPE_1"> (KRR,KRRL,KRRI,OMIXUV,                     &amp;<a name='427'>
                         PZZ,PDZZ,PSFTH,PSFRV,PPABSM,PRHODREF,     &amp;<a name='428'>
                         PTKEM,PTHM,PRM,ZTHLM,ZRTM,ZUMM,ZVMM,      &amp;<a name='429'>
                         PTHL_UP,PRT_UP,PRV_UP,PU_UP,PV_UP,        &amp;<a name='430'>
                         PRC_UP,ZRI_UP,PTHV_UP,ZW_UP,PFRAC_UP,PEMF,&amp;<a name='431'>
                         PDETR,PENTR,IKLCL,IKETL,IKCTL )<a name='432'>
<a name='433'>
<font color=#447700>!!! 3. Compute fluxes of conservative variables and their divergence = tendency<a name='434'></font>
<a name='435'>
       ZEMF_O_RHODREF=PEMF/PRHODREF<a name='436'>
       CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MF_TURB'>MF_TURB</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MFSHCONVPBL_CORE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MF_TURB_1">(OMIXUV, PIMPL_MF, PTSTEP,PTSTEP_MET,       &amp;<a name='437'>
                PDZZ, PRHODJ, ZTHLM,ZTHVM,ZRTM,ZUMM,ZVMM,           &amp;<a name='438'>
                ZTHLDT,ZRTDT,ZUDT,ZVDT,                            &amp;<a name='439'>
                ZEMF_O_RHODREF,PTHL_UP,PTHV_UP,PRT_UP,PU_UP,PV_UP,&amp;<a name='440'>
                ZFLXZTHMF,PFLXZTHVMF,ZFLXZRMF,ZFLXZUMF,ZFLXZVMF   )<a name='441'>
<a name='442'>
               <a name='443'>
<font color=#447700>!!! 5. Compute diagnostic convective cloud fraction and content<a name='444'></font>
<font color=#447700>! ! !  ONLY liquid cloud implemented (yet)<a name='445'></font>
<a name='446'>
      CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_MF_CLOUD'>COMPUTE_MF_CLOUD</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MFSHCONVPBL_CORE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_MF_CLOUD_1">(KRRL,ZTHLM,PRC_UP,PFRAC_UP,PDZZ,IKLCL,  &amp;<a name='447'>
                            PRC_MF,ZCF_MF                      )<a name='448'>
<a name='449'>
<a name='450'>
<font color=#447700>!!! 6. Compute tendency terms for pronostic variables<a name='451'></font>
<a name='452'>
ZEXN(:,:,:)=(PPABSM(:,:,:)/XP00) ** (XRD/XCPD)<a name='453'>
<font color=#447700>!<a name='454'></font>
<a name='455'>
<a name='456'>
PRV(:,:,:)=PRM(:,:,:,1)-PRC_MF(:,:,:)<a name='457'>
PRL(:,:,:)=PRC_MF(:,:,:)<a name='458'>
      <font color=#447700>!       2.1 Cph<a name='459'></font>
ZCPH(:,:,:)=XCPD+ XCPV * PRV(:,:,:)+ XCL * PRL(:,:,:) <a name='460'>
      <a name='461'>
PTH(:,:,:)=(ZTHLM(:,:,:)+ZTHLDT(:,:,:))+(XLVTT/(ZCPH*ZEXN(:,:,:))*PRL(:,:,:))          <a name='462'>
<a name='463'>
PRTHS(:,:,:)  = ZTHLDT(:,:,:)<a name='464'>
PRTHS(:,:,:)  = (PTH(:,:,:)-PTHM(:,:,:))/PTSTEP_MET<a name='465'>
PRRS(:,:,:,2) = (PRC_MF-PRM(:,:,:,2))/PTSTEP_MET<a name='466'>
PRRS(:,:,:,1) = ZRTDT(:,:,:)-PRRS(:,:,:,2)<a name='467'>
<a name='468'>
PRTHS(:,:,:)  = ZTHLDT(:,:,:)<a name='469'>
PRRS(:,:,:,1) = ZRTDT(:,:,:)<a name='470'>
PRRS(:,:,:,2) = 0<a name='471'>
PRUS(:,:,:)   = ZUDT(:,:,:)<a name='472'>
PRVS(:,:,:)   = ZVDT(:,:,:) <a name='473'>
  <a name='474'>
<a name='475'>
END SUBROUTINE MFSHCONVPBL_CORE <a name='476'>
<a name='477'>
<a name='478'>
<font color=#447700>!     ###################################################################<a name='479'></font>
<A NAME='COMPUTE_BL89_ML'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_BL89_ML' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='480'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>COMPUTE_BL89_ML</font>(PDZZ2D, &amp; <A href='../../call_to/COMPUTE_BL89_ML.html' TARGET='index'>3</A><a name='481'>
             PTKEM2D,PG_O_THVREF2D,PVPT,KK,OUPORDN,PLWORK)<a name='482'>
<font color=#447700>!     ###################################################################<a name='483'></font>
<font color=#447700>!!<a name='484'></font>
<font color=#447700>!!     COMPUTE_BL89_ML routine to:<a name='485'></font>
<font color=#447700>!!<a name='486'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='487'></font>
<font color=#447700>!<a name='488'></font>
<font color=#447700>!*       0.    DECLARATIONS<a name='489'></font>
<font color=#447700>!<a name='490'></font>
<font color=#447700>!              ------------<a name='491'></font>
<font color=#447700>!USE MODD_CST<a name='492'></font>
<font color=#447700>!<a name='493'></font>
<font color=#447700>!<a name='494'></font>
IMPLICIT NONE<a name='495'>
<font color=#447700>!<a name='496'></font>
<font color=#447700>!          0.1 arguments<a name='497'></font>
<font color=#447700>!<a name='498'></font>
REAL, DIMENSION(:,:),   INTENT(IN)  :: PDZZ2D<a name='499'>
REAL, DIMENSION(:,:),   INTENT(IN)  :: PTKEM2D<a name='500'>
REAL, DIMENSION(:,:),   INTENT(IN)  :: PG_O_THVREF2D<a name='501'>
REAL, DIMENSION(:,:),   INTENT(IN)  :: PVPT<a name='502'>
INTEGER,                INTENT(IN)  :: KK<a name='503'>
LOGICAL,                INTENT(IN)  :: OUPORDN<a name='504'>
REAL, DIMENSION(:),     INTENT(OUT) :: PLWORK<a name='505'>
<a name='506'>
<font color=#447700>!          0.2 Local variable<a name='507'></font>
<font color=#447700>!<a name='508'></font>
REAL, DIMENSION(SIZE(PTKEM2D,1)) :: ZLWORK1,ZLWORK2 <font color=#447700>! Temporary mixing length<a name='509'></font>
REAL, DIMENSION(SIZE(PTKEM2D,1)) :: ZINTE,ZPOTE     <font color=#447700>! TKE and potential energy<a name='510'></font>
                                                    <font color=#447700>! between 2 levels<a name='511'></font>
INTEGER :: IKB,IKE<a name='512'>
<font color=#447700>!<a name='513'></font>
REAL, DIMENSION(SIZE(PTKEM2D,1),SIZE(PTKEM2D,2)) :: ZDELTVPT,ZHLVPT                                <a name='514'>
                      <font color=#447700>!Virtual Potential Temp at Half level and DeltaThv between<a name='515'></font>
                      <font color=#447700>!2 levels<a name='516'></font>
REAL, DIMENSION(SIZE(PTKEM2D,1)) :: ZTH<font color=#447700>! Potential Temp <a name='517'></font>
<a name='518'>
INTEGER :: IIJU,IKU             <font color=#447700>!Internal Domain<a name='519'></font>
INTEGER :: J1D                  <font color=#447700>!horizontal loop counter<a name='520'></font>
INTEGER :: JKK                  <font color=#447700>!loop counters<a name='521'></font>
INTEGER :: JRR                  <font color=#447700>!moist loop counter<a name='522'></font>
INTEGER :: JIJK                 <font color=#447700>!loop counters <a name='523'></font>
REAL    :: ZTEST,ZTEST0,ZTESTM  <font color=#447700>!test for vectorization<a name='524'></font>
<font color=#447700>!-------------------------------------------------------------------------------------<a name='525'></font>
<font color=#447700>!<a name='526'></font>
<font color=#447700>!*       1.    INITIALISATION<a name='527'></font>
<font color=#447700>!              --------------<a name='528'></font>
IIJU=SIZE(PTKEM2D,1)<a name='529'>
<font color=#447700>!<a name='530'></font>
IKB = 1 <font color=#447700>!Modif WRF JP<a name='531'></font>
IKE = SIZE(PTKEM2D,2)-1 <font color=#447700>!Modif WRF JP<a name='532'></font>
IKU = SIZE(PTKEM2D,2)<a name='533'>
<a name='534'>
ZDELTVPT(:,2:IKU)=PVPT(:,2:IKU)-PVPT(:,1:IKU-1)<a name='535'>
ZDELTVPT(:,1)=0.<a name='536'>
<a name='537'>
<font color=#447700>! to prevent division by zero<a name='538'></font>
WHERE (ABS(ZDELTVPT(:,:))&lt;1.E-10)<a name='539'>
  ZDELTVPT(:,:)=1.E-10<a name='540'>
END WHERE<a name='541'>
<font color=#447700>!<a name='542'></font>
ZHLVPT(:,2:IKU)= 0.5 * ( PVPT(:,2:IKU)+PVPT(:,1:IKU-1) )<a name='543'>
ZHLVPT(:,1)    = PVPT(:,1)<a name='544'>
<a name='545'>
<font color=#447700>!<a name='546'></font>
<font color=#447700>!<a name='547'></font>
<font color=#447700>!<a name='548'></font>
<font color=#447700>!*       2.    CALCULATION OF THE UPWARD MIXING LENGTH<a name='549'></font>
<font color=#447700>!              ---------------------------------------<a name='550'></font>
<font color=#447700>!<a name='551'></font>
<a name='552'>
IF (OUPORDN.EQV..TRUE.) THEN <a name='553'>
 ZINTE(:)=PTKEM2D(:,KK)<a name='554'>
 PLWORK=0.<a name='555'>
 ZLWORK1=0.<a name='556'>
 ZLWORK2=0.<a name='557'>
 ZTESTM=1.<a name='558'>
 ZTH(:)=PVPT(:,KK)<a name='559'>
 DO JKK=KK+1,IKE<a name='560'>
    IF(ZTESTM &gt; 0.) THEN<a name='561'>
      ZTESTM=0<a name='562'>
      DO J1D=1,IIJU<a name='563'>
        ZTEST0=0.5+SIGN(0.5,ZINTE(J1D))<a name='564'>
        ZPOTE(J1D) = ZTEST0*(PG_O_THVREF2D(J1D,KK)      *      &amp;<a name='565'>
            (ZHLVPT(J1D,JKK) - ZTH(J1D)))  * PDZZ2D(J1D,JKK) <font color=#447700>!particle keeps its temperature<a name='566'></font>
        ZTEST =0.5+SIGN(0.5,ZINTE(J1D)-ZPOTE(J1D))<a name='567'>
        ZTESTM=ZTESTM+ZTEST0<a name='568'>
        ZLWORK1(J1D)=PDZZ2D(J1D,JKK)<a name='569'>
        <font color=#447700>!ZLWORK2 jump of the last reached level<a name='570'></font>
        ZLWORK2(J1D)=        ( - PG_O_THVREF2D(J1D,KK) *                     &amp;<a name='571'>
            (  PVPT(J1D,JKK-1) - ZTH(J1D) )                              &amp;<a name='572'>
          + SQRT (ABS(                                                       &amp;<a name='573'>
            ( PG_O_THVREF2D(J1D,KK) * (PVPT(J1D,JKK-1) - ZTH(J1D)) )**2  &amp;<a name='574'>
            + 2. * ZINTE(J1D) * PG_O_THVREF2D(J1D,KK)                        &amp;<a name='575'>
                 * ZDELTVPT(J1D,JKK) / PDZZ2D(J1D,JKK) ))    ) /             &amp;<a name='576'>
        ( PG_O_THVREF2D(J1D,KK) * ZDELTVPT(J1D,JKK) / PDZZ2D(J1D,JKK) ) <a name='577'>
      <font color=#447700>!<a name='578'></font>
        PLWORK(J1D)=PLWORK(J1D)+ZTEST0*(ZTEST*ZLWORK1(J1D)+  &amp;<a name='579'>
                                    (1-ZTEST)*ZLWORK2(J1D))<a name='580'>
        ZINTE(J1D) = ZINTE(J1D) - ZPOTE(J1D)<a name='581'>
      END DO <a name='582'>
    ENDIF<a name='583'>
  END DO <a name='584'>
ENDIF<a name='585'>
<font color=#447700>!!<a name='586'></font>
<font color=#447700>!*       2.    CALCULATION OF THE DOWNWARD MIXING LENGTH<a name='587'></font>
<font color=#447700>!              ---------------------------------------<a name='588'></font>
<font color=#447700>!<a name='589'></font>
<a name='590'>
IF (OUPORDN.EQV..FALSE.) THEN <a name='591'>
 ZINTE(:)=PTKEM2D(:,KK)<a name='592'>
 PLWORK=0.<a name='593'>
 ZLWORK1=0.<a name='594'>
 ZLWORK2=0.<a name='595'>
 ZTESTM=1.<a name='596'>
 ZTH(:)=PVPT(:,KK)<a name='597'>
 DO JKK=KK,IKB,-1 <a name='598'>
    IF(ZTESTM &gt; 0.) THEN<a name='599'>
      ZTESTM=0<a name='600'>
      DO J1D=1,IIJU<a name='601'>
        ZTEST0=0.5+SIGN(0.5,ZINTE(J1D))<a name='602'>
        ZPOTE(J1D) = -ZTEST0*(PG_O_THVREF2D(J1D,KK)      *      &amp;<a name='603'>
            (ZHLVPT(J1D,JKK) - ZTH(J1D)))  * PDZZ2D(J1D,JKK) <font color=#447700>!particle keeps its temperature<a name='604'></font>
        ZTEST =0.5+SIGN(0.5,ZINTE(J1D)-ZPOTE(J1D))<a name='605'>
        ZTESTM=ZTESTM+ZTEST0<a name='606'>
        ZLWORK1(J1D)=PDZZ2D(J1D,JKK)<a name='607'>
        ZLWORK2(J1D)=        ( + PG_O_THVREF2D(J1D,KK) *                     &amp;<a name='608'>
            (  PVPT(J1D,JKK) - ZTH(J1D) )                              &amp;<a name='609'>
          + SQRT (ABS(                                                       &amp;<a name='610'>
            ( PG_O_THVREF2D(J1D,KK) * (PVPT(J1D,JKK) - ZTH(J1D)) )**2  &amp;<a name='611'>
            + 2. * ZINTE(J1D) * PG_O_THVREF2D(J1D,KK)                        &amp;<a name='612'>
                 * ZDELTVPT(J1D,JKK) / PDZZ2D(J1D,JKK) ))    ) /             &amp;<a name='613'>
        ( PG_O_THVREF2D(J1D,KK) * ZDELTVPT(J1D,JKK) / PDZZ2D(J1D,JKK) ) <a name='614'>
      <font color=#447700>!<a name='615'></font>
        PLWORK(J1D)=PLWORK(J1D)+ZTEST0*(ZTEST*ZLWORK1(J1D)+  &amp;<a name='616'>
                                    (1-ZTEST)*ZLWORK2(J1D)) <a name='617'>
        ZINTE(J1D) = ZINTE(J1D) - ZPOTE(J1D)<a name='618'>
      END DO <a name='619'>
    ENDIF<a name='620'>
  END DO <a name='621'>
ENDIF<a name='622'>
  <a name='623'>
END SUBROUTINE COMPUTE_BL89_ML<a name='624'>
<font color=#447700>!<a name='625'></font>
<a name='626'>
<font color=#447700>!<a name='627'></font>
<font color=#447700>!         #############################################################<a name='628'></font>
<A NAME='COMPUTE_ENTR_DETR'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_ENTR_DETR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='629'>
          <font color=#993300>SUBROUTINE </font><font color=#cc0000>COMPUTE_ENTR_DETR</font>(OTEST,OTESTLCL,&amp; <A href='../../call_to/COMPUTE_ENTR_DETR.html' TARGET='index'>1</A>,<A href='../../call_from/COMPUTE_ENTR_DETR.html' TARGET='index'>5</A><a name='630'>
                            HFRAC_ICE,PFRAC_ICE,KK,PPABSM,PZZ,PDZZ,&amp;<a name='631'>
                            PTHVM,PTHLM,PRTM,PW_UP2,&amp;<a name='632'>
                            PTHL_UP,PRT_UP,PLUP,&amp;<a name='633'>
                            PENTR,PDETR,PBUO_INTEG)<a name='634'>
<font color=#447700>!         #############################################################<a name='635'></font>
<a name='636'>
<font color=#447700>!!<a name='637'></font>
<font color=#447700>!!***COMPUTE_ENTR_DETR* - calculates caracteristics of the updraft or downdraft<a name='638'></font>
<font color=#447700>!!                       using model of the EDMF scheme <a name='639'></font>
<font color=#447700>!!<a name='640'></font>
<font color=#447700>!!<a name='641'></font>
<font color=#447700>!! --------------------------------------------------------------------------<a name='642'></font>
<font color=#447700>!<a name='643'></font>
<a name='644'>
<a name='645'>
<a name='646'>
IMPLICIT NONE<a name='647'>
<font color=#447700>!<a name='648'></font>
<font color=#447700>!                         <a name='649'></font>
<font color=#447700>!*                    1.1  Declaration of Arguments<a name='650'></font>
<font color=#447700>!<a name='651'></font>
<font color=#447700>!<a name='652'></font>
<a name='653'>
LOGICAL,DIMENSION(:),INTENT(INOUT)  :: OTEST <font color=#447700>! test to see if updraft is running<a name='654'></font>
LOGICAL,DIMENSION(:),INTENT(INOUT)  :: OTESTLCL <font color=#447700>!test of condensation <a name='655'></font>
CHARACTER*1                         :: HFRAC_ICE <font color=#447700>! frac_ice can be compute using<a name='656'></font>
                                              <font color=#447700>! Temperature (T) or prescribed<a name='657'></font>
                                              <font color=#447700>! (Y)<a name='658'></font>
REAL, DIMENSION(:), INTENT(INOUT)   :: PFRAC_ICE <font color=#447700>! if frac_ice is prescribed<a name='659'></font>
INTEGER,            INTENT(IN)      :: KK  <font color=#447700>! level where E and D are computed     <a name='660'></font>
<font color=#447700>!<a name='661'></font>
<font color=#447700>!    prognostic variables at t- deltat<a name='662'></font>
<font color=#447700>!<a name='663'></font>
REAL, DIMENSION(:,:),   INTENT(IN) ::  PPABSM      <font color=#447700>! Pressure at time t-1<a name='664'></font>
REAL, DIMENSION(:,:),   INTENT(IN) ::  PZZ       <font color=#447700>!  Height at the flux point<a name='665'></font>
REAL, DIMENSION(:,:),   INTENT(IN) ::  PDZZ       <font color=#447700>!  metrics coefficient<a name='666'></font>
REAL, DIMENSION(:,:),   INTENT(IN) ::  PTHVM      <font color=#447700>! ThetaV environment <a name='667'></font>
<a name='668'>
<font color=#447700>!<a name='669'></font>
<font color=#447700>!   thermodynamical variables which are transformed in conservative var.<a name='670'></font>
<font color=#447700>!<a name='671'></font>
REAL, DIMENSION(:),   INTENT(IN)     ::  PTHLM     <font color=#447700>! Thetal<a name='672'></font>
REAL, DIMENSION(:),   INTENT(IN)     ::  PRTM      <font color=#447700>! total mixing ratio <a name='673'></font>
REAL, DIMENSION(:,:), INTENT(INOUT)  ::  PW_UP2    <font color=#447700>! Vertical velocity^2<a name='674'></font>
REAL, DIMENSION(:),   INTENT(IN)     ::  PTHL_UP,PRT_UP  <font color=#447700>! updraft properties<a name='675'></font>
REAL, DIMENSION(:),   INTENT(IN)     ::  PLUP      <font color=#447700>! LUP compute from the ground<a name='676'></font>
REAL, DIMENSION(:),   INTENT(INOUT)  ::  PENTR     <font color=#447700>! Mass flux entrainment of the updraft<a name='677'></font>
REAL, DIMENSION(:),   INTENT(INOUT)  ::  PDETR     <font color=#447700>! Mass flux detrainment of the updraft<a name='678'></font>
REAL, DIMENSION(:),   INTENT(INOUT)  ::  PBUO_INTEG<font color=#447700>! Integral Buoyancy<a name='679'></font>
<font color=#447700>!<a name='680'></font>
<font color=#447700>!<a name='681'></font>
<font color=#447700>!                       1.2  Declaration of local variables<a name='682'></font>
<font color=#447700>!<a name='683'></font>
<font color=#447700>!<a name='684'></font>
<a name='685'>
<font color=#447700>! Variables for cloudy part<a name='686'></font>
<a name='687'>
REAL, DIMENSION(SIZE(PTHLM))   :: ZKIC           <font color=#447700>! fraction of env. mass in the muxtures<a name='688'></font>
REAL, DIMENSION(SIZE(PTHLM))   :: ZEPSI,ZDELTA   <font color=#447700>! factor entrainment detrainment<a name='689'></font>
REAL, DIMENSION(SIZE(PTHLM))   :: ZEPSI_CLOUD    <font color=#447700>! factor entrainment detrainment<a name='690'></font>
REAL, DIMENSION(SIZE(PTHLM))   :: ZCOEFFMF_CLOUD <font color=#447700>! factor for compputing entr. detr.<a name='691'></font>
<a name='692'>
REAL, DIMENSION(SIZE(PTHLM))   :: ZMIXTHL,ZMIXRT <font color=#447700>! Thetal and rt in the mixtures<a name='693'></font>
<font color=#447700>!<a name='694'></font>
REAL, DIMENSION(SIZE(PTHLM))   :: ZTHMIX,ZTHVMIX <font color=#447700>! Theta and Thetav  of mixtures<a name='695'></font>
REAL, DIMENSION(SIZE(PTHLM))   :: ZRVMIX,ZRCMIX,ZRIMIX <font color=#447700>! mixing ratios in mixtures<a name='696'></font>
<a name='697'>
REAL, DIMENSION(SIZE(PTHLM))   :: ZTHMIX_F2     <font color=#447700>! Theta and Thetav  of mixtures<a name='698'></font>
REAL, DIMENSION(SIZE(PTHLM))   :: ZRVMIX_F2,ZRCMIX_F2,ZRIMIX_F2 <font color=#447700>! mixing ratios in mixtures<a name='699'></font>
<a name='700'>
REAL, DIMENSION(SIZE(PTHLM))   :: ZTHV_UP       <font color=#447700>! thvup at mass point kk<a name='701'></font>
<a name='702'>
<a name='703'>
REAL, DIMENSION(SIZE(PTHLM))   :: ZTHVMIX_1,ZTHVMIX_2 <font color=#447700>! Theta and Thetav  of mixtures<a name='704'></font>
<a name='705'>
<a name='706'>
<font color=#447700>! Variables for dry part<a name='707'></font>
<a name='708'>
REAL, DIMENSION(SIZE(PTHLM))   :: ZBUO_INTEG,&amp;         <font color=#447700>! Temporary integral Buoyancy<a name='709'></font>
                                  ZDZ_HALF,&amp;           <font color=#447700>! half-DeltaZ between 2 flux points<a name='710'></font>
                                  ZDZ_STOP,&amp;           <font color=#447700>! Exact Height of the LCL <a name='711'></font>
                                  ZTHV_MINUS_HALF,&amp;    <font color=#447700>! Thv at flux point(kk)  <a name='712'></font>
                                  ZTHV_PLUS_HALF,&amp;     <font color=#447700>! Thv at flux point(kk+1)<a name='713'></font>
                                  ZCOEFF_MINUS_HALF,&amp;  <font color=#447700>! Variation of Thv between mass points kk-1 and kk<a name='714'></font>
                                  ZCOEFF_PLUS_HALF,&amp;   <font color=#447700>! Variation of Thv between mass points kk and kk+1<a name='715'></font>
                                  ZCOTHVU_MINUS_HALF,&amp; <font color=#447700>! Variation of Thvup between flux point kk and mass point kk<a name='716'></font>
                                  ZCOTHVU_PLUS_HALF,&amp;  <font color=#447700>! Variation of Thvup between mass point kk and flux point kk+1    <a name='717'></font>
                                  ZW2_HALF             <font color=#447700>! w**2 at mass point KK  <a name='718'></font>
<a name='719'>
REAL, DIMENSION(SIZE(PTHLM))   :: ZCOPRE_MINUS_HALF,&amp;  <font color=#447700>! Variation of pressure between mass points kk-1 and kk<a name='720'></font>
                                  ZCOPRE_PLUS_HALF,&amp;   <font color=#447700>! Variation of pressure between mass points kk and kk+1<a name='721'></font>
                                  ZPRE_MINUS_HALF,&amp;    <font color=#447700>! pressure at flux point kk<a name='722'></font>
                                  ZPRE_PLUS_HALF,&amp;     <font color=#447700>! pressure at flux point kk+1<a name='723'></font>
                                  ZTHV_UP_F1,&amp;         <font color=#447700>! thv_up at flux point kk<a name='724'></font>
                                  ZTHV_UP_F2           <font color=#447700>! thv_up at flux point kk+1<a name='725'></font>
REAL, DIMENSION(SIZE(PTHLM))   :: ZCOEFF_QSAT,&amp;        <font color=#447700>! variation of Qsat at the transition between dry part and cloudy part<a name='726'></font>
                                  ZRC_ORD,&amp;            <font color=#447700>! <a name='727'></font>
                                  ZPART_DRY            <font color=#447700>! part of dry part at the transition level<a name='728'></font>
<font color=#447700>!<a name='729'></font>
REAL, DIMENSION(SIZE(PTHLM))   :: ZQVSAT <font color=#447700>! QV at saturation<a name='730'></font>
<a name='731'>
REAL, DIMENSION(SIZE(PTHLM))   :: PT <font color=#447700>! temperature to compute saturation vapour mixing ratio <a name='732'></font>
<a name='733'>
REAL, DIMENSION(SIZE(PTHVM,1),SIZE(PTHVM,2))   ::ZG_O_THVREF<a name='734'>
<font color=#447700>!<a name='735'></font>
LOGICAL, DIMENSION(SIZE(OTEST,1)) :: GTEST_LOCAL_LCL,&amp; <font color=#447700>! true if LCL found between flux point KK and mass point KK  <a name='736'></font>
                                     GTEST_LOCAL_LCL2  <font color=#447700>! true if LCL found between mass point KK and flux point KK+1<a name='737'></font>
<font color=#447700>!<a name='738'></font>
REAL     :: ZRDORV       <font color=#447700>! RD/RV<a name='739'></font>
REAL     :: ZRVORD       <font color=#447700>! RV/RD<a name='740'></font>
INTEGER  :: ILON, ITEST, IKB         <font color=#447700>!<a name='741'></font>
<a name='742'>
<a name='743'>
<font color=#447700>!----------------------------------------------------------------------------------<a name='744'></font>
                        <a name='745'>
<font color=#447700>!                1.3 Initialisation<a name='746'></font>
<font color=#447700>!                ------------------<a name='747'></font>
  IKB=1 <font color=#447700>! modif WRF JP    <a name='748'></font>
<a name='749'>
  <a name='750'>
  ZRDORV   = XRD / XRV   <font color=#447700>!=0.622<a name='751'></font>
  ZRVORD   = XRV / XRD   <font color=#447700>!=1.607<a name='752'></font>
  ZG_O_THVREF=XG/PTHVM<a name='753'>
  <a name='754'>
  ZCOEFF_QSAT=0.<a name='755'>
  ZRC_ORD=0.<a name='756'>
  ZPART_DRY=1.<a name='757'>
  GTEST_LOCAL_LCL=.FALSE.<a name='758'>
  ZDZ_HALF(:) = (PZZ(:,KK+1)-PZZ(:,KK))/2.<a name='759'>
  ZDZ_STOP(:) = ZDZ_HALF(:)<a name='760'>
 <a name='761'>
  ZKIC(:)=0.1  <font color=#447700>! starting value for critical mixed fraction for CLoudy Part<a name='762'></font>
<a name='763'>
<a name='764'>
<font color=#447700>!                Computation of KIC<a name='765'></font>
<font color=#447700>!                ---------------------<a name='766'></font>
<a name='767'>
<font color=#447700>!        2.1    Compute critical mixed fraction by estimating unknown  <a name='768'></font>
<font color=#447700>!               T^mix r_c^mix and r_i^mix from thl^mix and r_t^mix<a name='769'></font>
<font color=#447700>!               We determine the zero crossing of the linear curve<a name='770'></font>
<font color=#447700>!               evaluating the derivative using ZMIXF=0.1.<a name='771'></font>
<font color=#447700>!               -----------------------------------------------------<a name='772'></font>
<a name='773'>
  ZMIXTHL(:) = ZKIC(:) * PTHLM(:)+(1. - ZKIC(:))*PTHL_UP(:)<a name='774'>
  ZMIXRT(:)  = ZKIC(:) * PRTM(:)+(1. - ZKIC(:))*PRT_UP(:)<a name='775'>
<a name='776'>
<font color=#447700>! MIXTURE FOR CLOUDY PART<a name='777'></font>
  <font color=#447700>!  Compute pressure at flux level KK and at flux Level KK+1  <a name='778'></font>
<a name='779'>
<a name='780'>
IF (KK==IKB) THEN <font color=#447700>!MODIF WRF JP<a name='781'></font>
  ZCOPRE_MINUS_HALF(:) = 0. <font color=#447700>!MODIF WRF JP<a name='782'></font>
ELSE<font color=#447700>!MODIF WRF JP<a name='783'></font>
  ZCOPRE_MINUS_HALF(:) = ((PPABSM(:,KK)-PPABSM(:,KK-1))/PDZZ(:,KK))<a name='784'>
ENDIF<font color=#447700>!MODIF WRF JP   <a name='785'></font>
  ZCOPRE_PLUS_HALF(:) = ((PPABSM(:,KK+1)-PPABSM(:,KK))/PDZZ(:,KK+1))<a name='786'>
  <a name='787'>
IF (KK==IKB) THEN <font color=#447700>!MODIF WRF JP   <a name='788'></font>
  ZPRE_MINUS_HALF(:)= PPABSM(:,KK)<a name='789'>
ELSE<font color=#447700>!MODIF WRF JP<a name='790'></font>
  ZPRE_MINUS_HALF(:)= ZCOPRE_MINUS_HALF*0.5*(PZZ(:,KK)-PZZ(:,KK-1))+PPABSM(:,KK-1)<a name='791'>
ENDIF<font color=#447700>!MODIF WRF JP   <a name='792'></font>
  ZPRE_PLUS_HALF(:) = ZCOPRE_PLUS_HALF*0.5*(PZZ(:,KK+1)-PZZ(:,KK))+PPABSM(:,KK)  <a name='793'>
<a name='794'>
<a name='795'>
  <font color=#447700>!  Compute non cons. var. of mixture at the mass level<a name='796'></font>
  CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_1D'>TH_R_FROM_THL_RT_1D</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_ENTR_DETR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TH_R_FROM_THL_RT_1D_1">(HFRAC_ICE,PFRAC_ICE,&amp;<a name='797'>
               PPABSM(:,KK),ZMIXTHL,ZMIXRT,&amp;<a name='798'>
               ZTHMIX,ZRVMIX,ZRCMIX,ZRIMIX)<a name='799'>
             <a name='800'>
<a name='801'>
  <font color=#447700>! Compute theta_v of mixture at mass level KK for KF90        <a name='802'></font>
  ZTHVMIX_1(:) = ZTHMIX(:)*(1.+ZRVORD*ZRVMIX(:))/(1.+ZMIXRT(:))<a name='803'>
<a name='804'>
  <font color=#447700>!  Compute non cons. var. of mixture at the flux level KK+1<a name='805'></font>
  CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_1D'>TH_R_FROM_THL_RT_1D</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_ENTR_DETR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TH_R_FROM_THL_RT_1D_2">(HFRAC_ICE,PFRAC_ICE,&amp;<a name='806'>
               ZPRE_PLUS_HALF,ZMIXTHL,ZMIXRT,&amp;<a name='807'>
               ZTHMIX,ZRVMIX,ZRCMIX,ZRIMIX)<a name='808'>
             <a name='809'>
<a name='810'>
  <font color=#447700>! compute theta_v of mixture at the flux level KK+1 for KF90       <a name='811'></font>
  ZTHVMIX_2(:) = ZTHMIX(:)*(1.+ZRVORD*ZRVMIX(:))/(1.+ZMIXRT(:))<a name='812'>
<a name='813'>
<a name='814'>
<font color=#447700>!        2.1    Compute critical mixed fraction by estimating unknown  <a name='815'></font>
<font color=#447700>!               T^mix r_c^mix and r_i^mix from thl^mix and r_t^mix<a name='816'></font>
<font color=#447700>!               We determine the zero crossing of the linear curve<a name='817'></font>
<font color=#447700>!               evaluating the derivative using ZMIXF=0.1.<a name='818'></font>
<font color=#447700>!               -----------------------------------------------------<a name='819'></font>
<a name='820'>
<a name='821'>
<font color=#447700>! THV_UP FOR DRY PART<a name='822'></font>
  <font color=#447700>! Compute theta_v of updraft at flux level KK                 <a name='823'></font>
  CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_1D'>TH_R_FROM_THL_RT_1D</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_ENTR_DETR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TH_R_FROM_THL_RT_1D_3">(HFRAC_ICE,PFRAC_ICE,&amp;<a name='824'>
               ZPRE_MINUS_HALF,PTHL_UP,PRT_UP,&amp;<a name='825'>
               ZTHMIX,ZRVMIX,ZRCMIX,ZRIMIX)<a name='826'>
  ZTHV_UP_F1(:) = ZTHMIX(:)*(1.+ZRVORD*ZRVMIX(:))/(1.+PRT_UP(:))<a name='827'>
 <a name='828'>
  <font color=#447700>! Compute theta_v of updraft at mass level KK                 <a name='829'></font>
  CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_1D'>TH_R_FROM_THL_RT_1D</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_ENTR_DETR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TH_R_FROM_THL_RT_1D_4">(HFRAC_ICE,PFRAC_ICE,&amp;<a name='830'>
               PPABSM(:,KK),PTHL_UP,PRT_UP,&amp;<a name='831'>
               ZTHMIX,ZRVMIX,ZRCMIX,ZRIMIX)            <a name='832'>
  ZTHV_UP(:) = ZTHMIX(:)*(1.+ZRVORD*ZRVMIX(:))/(1.+PRT_UP(:))<a name='833'>
<a name='834'>
  <font color=#447700>! Compute theta_v of updraft at flux level KK+1                   <a name='835'></font>
  CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_1D'>TH_R_FROM_THL_RT_1D</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_ENTR_DETR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TH_R_FROM_THL_RT_1D_5">(HFRAC_ICE,PFRAC_ICE,&amp;<a name='836'>
               ZPRE_PLUS_HALF,PTHL_UP,PRT_UP,&amp;<a name='837'>
               ZTHMIX_F2,ZRVMIX_F2,ZRCMIX_F2,ZRIMIX_F2)<a name='838'>
  ZTHV_UP_F2(:) = ZTHMIX_F2(:)*(1.+ZRVORD*ZRVMIX_F2(:))/(1.+PRT_UP(:))<a name='839'>
 <a name='840'>
   <a name='841'>
<font color=#447700>!<a name='842'></font>
<font color=#447700>!*   2.2     Compute final values for entr. and detr. <a name='843'></font>
<font color=#447700>!            ----------------------------------------<a name='844'></font>
<font color=#447700>!<a name='845'></font>
<font color=#447700>! Dry PART  <a name='846'></font>
<a name='847'>
 <font color=#447700>! Computation of integral entrainment and detrainment between flux level KK<a name='848'></font>
 <font color=#447700>! and mass level KK <a name='849'></font>
<a name='850'>
  WHERE ((ZRCMIX(:)&gt;0.).AND.(.NOT.OTESTLCL)) <a name='851'>
<font color=#447700>! If rc is found between flux level KK and mass level KK<a name='852'></font>
<font color=#447700>! a part of dry entrainment/detrainment is defined<a name='853'></font>
<font color=#447700>! the exact height of LCL is also determined<a name='854'></font>
     ZCOEFF_QSAT(:) = (ZRCMIX_F2(:) - ZRCMIX(:))/ ZDZ_HALF(:)<a name='855'>
     ZRC_ORD(:) = ZRCMIX(:) - ZCOEFF_QSAT(:) * ZDZ_HALF(:)<a name='856'>
     ZDZ_STOP = (- ZRC_ORD(:)/ZCOEFF_QSAT(:))     <a name='857'>
     ZPART_DRY(:) = ZDZ_STOP / (PZZ(:,KK+1)-PZZ(:,KK))<a name='858'>
     GTEST_LOCAL_LCL(:)=.TRUE.<a name='859'>
  <a name='860'>
  ENDWHERE<a name='861'>
<a name='862'>
IF (KK==IKB) THEN <font color=#447700>!MODIF WRF JP   <a name='863'></font>
  ZCOEFF_MINUS_HALF = 0.<a name='864'>
ELSE<font color=#447700>!MODIF WRF JP<a name='865'></font>
  ZCOEFF_MINUS_HALF = ((PTHVM(:,KK)-PTHVM(:,KK-1))/PDZZ(:,KK))<a name='866'>
ENDIF<font color=#447700>!MODIF WRF JP   <a name='867'></font>
<a name='868'>
  ZCOEFF_PLUS_HALF  = ((PTHVM(:,KK+1)-PTHVM(:,KK))/PDZZ(:,KK+1))<a name='869'>
  <a name='870'>
  ZCOTHVU_MINUS_HALF = (ZTHV_UP(:)-ZTHV_UP_F1(:))/ZDZ_HALF(:)<a name='871'>
  ZCOTHVU_PLUS_HALF  = (ZTHV_UP_F2(:)-ZTHV_UP(:))/ZDZ_HALF(:)<a name='872'>
<a name='873'>
IF (KK==IKB) THEN <font color=#447700>!MODIF WRF JP   <a name='874'></font>
  ZTHV_MINUS_HALF = PTHVM(:,KK)<a name='875'>
ELSE<font color=#447700>!MODIF WRF JP<a name='876'></font>
  ZTHV_MINUS_HALF = ZCOEFF_MINUS_HALF*0.5*(PZZ(:,KK)-PZZ(:,KK-1))+PTHVM(:,KK-1)<a name='877'>
ENDIF<font color=#447700>!MODIF WRF JP   <a name='878'></font>
<a name='879'>
  ZTHV_PLUS_HALF  = ZCOEFF_PLUS_HALF*0.5*(PZZ(:,KK+1)-PZZ(:,KK))+ ZTHV_MINUS_HALF  <font color=#447700>! BUG JP 16082010<a name='880'></font>
 <a name='881'>
  <font color=#447700>! Integral Buoyancy between flux level KK and mass level KK <a name='882'></font>
          <a name='883'>
  PBUO_INTEG = ZG_O_THVREF(:,KK)*ZDZ_HALF(:)*&amp;<a name='884'>
              (0.5*( ZCOTHVU_MINUS_HALF - ZCOEFF_MINUS_HALF)*ZDZ_HALF(:) &amp;<a name='885'>
                - ZTHV_MINUS_HALF + ZTHV_UP_F1(:) ) <a name='886'>
<a name='887'>
<a name='888'>
 <a name='889'>
  WHERE ((OTEST).AND.(.NOT.OTESTLCL))<a name='890'>
     PENTR=0.<a name='891'>
     PDETR=0.<a name='892'>
<a name='893'>
 <a name='894'>
     ZBUO_INTEG = ZG_O_THVREF(:,KK)*ZDZ_STOP(:)*&amp;<a name='895'>
                (0.5 * (  - ZCOEFF_MINUS_HALF)* ZDZ_STOP(:) &amp;<a name='896'>
                  - ZTHV_MINUS_HALF + ZTHV_UP_F1(:) ) <a name='897'>
           <a name='898'>
  <a name='899'>
     WHERE (ZBUO_INTEG(:)&gt;=0.)<a name='900'>
         PENTR = 0.5/(XABUO-XBENTR*XENTR_DRY)*&amp;<a name='901'>
                 LOG(1.+ (2.*(XABUO-XBENTR*XENTR_DRY)/PW_UP2(:,KK))* &amp;<a name='902'>
                 ZBUO_INTEG)<a name='903'>
         PDETR = 0.<a name='904'>
    <a name='905'>
         ZW2_HALF = PW_UP2(:,KK) +  2*(XABUO-XBENTR*XENTR_DRY)*(ZBUO_INTEG)<a name='906'>
     ELSEWHERE<a name='907'>
         PENTR = 0.<a name='908'>
         PDETR = 0.5/(XABUO)*&amp;<a name='909'>
                 LOG(1.+ (2.*(XABUO)/PW_UP2(:,KK))* &amp;<a name='910'>
                 MAX(0.,-ZBUO_INTEG))<a name='911'>
<a name='912'>
         ZW2_HALF = PW_UP2(:,KK) +  2*(XABUO)*(ZBUO_INTEG)<a name='913'>
     ENDWHERE<a name='914'>
     <a name='915'>
 ENDWHERE<a name='916'>
<a name='917'>
 <a name='918'>
 ZDZ_STOP(:) = ZDZ_HALF(:)<a name='919'>
  <a name='920'>
<font color=#447700>! total Integral Buoyancy between flux level KK and flux level KK+1 <a name='921'></font>
<a name='922'>
 PBUO_INTEG = PBUO_INTEG + ZG_O_THVREF(:,KK)*ZDZ_HALF(:)*&amp;<a name='923'>
                (0.5*(ZCOTHVU_PLUS_HALF - ZCOEFF_PLUS_HALF)* ZDZ_HALF(:) - &amp; <a name='924'>
                PTHVM(:,KK) + ZTHV_UP(:) ) <a name='925'>
              <a name='926'>
               <a name='927'>
 WHERE ((((ZRCMIX_F2(:)&gt;0.).AND.(ZRCMIX(:)&lt;=0.)).AND.(.NOT.OTESTLCL)).AND.(.NOT.GTEST_LOCAL_LCL(:)))<a name='928'>
 <font color=#447700>! If rc is found between mass level KK and flux level KK+1<a name='929'></font>
 <font color=#447700>! a part of dry entrainment is defined<a name='930'></font>
 <font color=#447700>! the exact height of LCL is also determined<a name='931'></font>
     PT(:)=ZTHMIX_F2(:)*((PPABSM(:,KK+1)/XP00)**(XRD/XCPD)) <a name='932'>
     ZQVSAT(:)=EXP( XALPW - XBETAW/PT(:) - XGAMW*LOG(PT(:))  )<a name='933'>
     ZQVSAT(:)=XRD/XRV*ZQVSAT(:)/PPABSM(:,KK+1)   &amp;<a name='934'>
                   / (1.+(XRD/XRV-1.)*ZQVSAT(:)/PPABSM(:,KK+1))   <a name='935'>
     ZCOEFF_QSAT(:) = (PRT_UP(:) - ZQVSAT(:) - &amp;<a name='936'>
                ZRCMIX(:))/ (0.5* (PZZ(:,KK+2)-PZZ(:,KK+1)))<a name='937'>
     ZRC_ORD(:) = ZRCMIX_F2(:) - ZCOEFF_QSAT(:) * ZDZ_HALF(:)<a name='938'>
     ZDZ_STOP = (- ZRC_ORD(:)/ZCOEFF_QSAT(:))     <a name='939'>
     ZPART_DRY(:) = 0.5+ZDZ_STOP  / (PZZ(:,KK+1)-PZZ(:,KK))<a name='940'>
     GTEST_LOCAL_LCL2(:)=.TRUE.     <a name='941'>
 ENDWHERE<a name='942'>
<a name='943'>
<a name='944'>
 WHERE (((OTEST).AND.(.NOT.OTESTLCL)).AND.(.NOT.GTEST_LOCAL_LCL(:)))<a name='945'>
   <a name='946'>
     ZBUO_INTEG = ZG_O_THVREF(:,KK)*ZDZ_STOP(:)*&amp;<a name='947'>
                (0.5*( - ZCOEFF_PLUS_HALF)* ZDZ_STOP(:)&amp;<a name='948'>
                - PTHVM(:,KK) + ZTHV_UP(:) )<a name='949'>
<a name='950'>
             <a name='951'>
<a name='952'>
     WHERE (ZW2_HALF&gt;0.)<a name='953'>
        WHERE (ZBUO_INTEG(:)&gt;=0.)<a name='954'>
           PENTR = PENTR + 0.5/(XABUO-XBENTR*XENTR_DRY)* &amp;<a name='955'>
                LOG(1.+ (2.*(XABUO-XBENTR*XENTR_DRY)/ZW2_HALF(:)) * ZBUO_INTEG)<a name='956'>
          <a name='957'>
           PDETR = PDETR<a name='958'>
              <a name='959'>
        ELSEWHERE<a name='960'>
          PENTR = PENTR<a name='961'>
          <a name='962'>
          PDETR = PDETR + 0.5/(XABUO)* &amp;<a name='963'>
                LOG(1.+ (2.*(XABUO)/ZW2_HALF(:)) * &amp;<a name='964'>
                MAX(-ZBUO_INTEG,0.))<a name='965'>
        ENDWHERE     <a name='966'>
     ELSEWHERE<a name='967'>
        <font color=#447700>! if w**2&lt;0 the updraft is stopped <a name='968'></font>
           OTEST=.FALSE.<a name='969'>
           PENTR = PENTR <a name='970'>
           PDETR = PDETR <a name='971'>
     ENDWHERE<a name='972'>
              <a name='973'>
 ENDWHERE<a name='974'>
 PENTR = XENTR_DRY*PENTR/(PZZ(:,KK+1)-PZZ(:,KK))    <a name='975'>
 PDETR = XDETR_DRY*PDETR/(PZZ(:,KK+1)-PZZ(:,KK))<a name='976'>
 PDETR = MAX(ZPART_DRY(:)*XDETR_LUP/(PLUP-0.5*(PZZ(:,KK)+PZZ(:,KK+1))),PDETR)<a name='977'>
<a name='978'>
<a name='979'>
  <a name='980'>
<a name='981'>
<font color=#447700>! compute final value of critical mixed fraction using theta_v<a name='982'></font>
<font color=#447700>! of mixture, grid-scale and updraft in cloud<a name='983'></font>
<a name='984'>
 WHERE ((OTEST).AND.(OTESTLCL))<a name='985'>
     ZKIC(:) = MAX(0.,ZTHV_UP(:)-PTHVM(:,KK))*ZKIC(:) /  &amp;  <a name='986'>
                 (ZTHV_UP(:)-ZTHVMIX_1(:)+1.E-10)<a name='987'>
                       <a name='988'>
     ZKIC(:) = MAX(0., MIN(1., ZKIC(:)))<a name='989'>
    <a name='990'>
     ZEPSI(:) = ZKIC(:) **2.<a name='991'>
     ZDELTA(:) = (1.-ZKIC(:))**2.<a name='992'>
     ZEPSI_CLOUD=MIN(ZDELTA,ZEPSI)<a name='993'>
     ZCOEFFMF_CLOUD(:)=XENTR_MF * XG / XCRAD_MF         <a name='994'>
     PENTR(:) = ZCOEFFMF_CLOUD(:)*ZEPSI_CLOUD(:)<a name='995'>
     PDETR(:) = ZCOEFFMF_CLOUD(:)*ZDELTA(:)<a name='996'>
 ENDWHERE<a name='997'>
 <a name='998'>
<font color=#447700>! compute final value of critical mixed fraction using theta_v<a name='999'></font>
<font color=#447700>! of mixture, grid-scale and updraft in cloud<a name='1000'></font>
<a name='1001'>
<a name='1002'>
 WHERE (((OTEST).AND.(.NOT.(OTESTLCL))).AND.((GTEST_LOCAL_LCL(:).OR.GTEST_LOCAL_LCL2(:))))<a name='1003'>
     ZKIC(:) = MAX(0.,ZTHV_UP_F2(:)-ZTHV_PLUS_HALF)*ZKIC(:) /  &amp;  <a name='1004'>
                       (ZTHV_UP_F2(:)-ZTHVMIX_2(:)+1.E-10)                      <a name='1005'>
     ZKIC(:) = MAX(0., MIN(1., ZKIC(:)))<a name='1006'>
     ZEPSI(:) = ZKIC(:) **2.<a name='1007'>
     ZDELTA(:) = (1.-ZKIC(:))**2.<a name='1008'>
     ZEPSI_CLOUD=MIN(ZDELTA,ZEPSI)<a name='1009'>
     ZCOEFFMF_CLOUD(:)=XENTR_MF * XG / XCRAD_MF     <a name='1010'>
     PENTR(:) = PENTR+(1.-ZPART_DRY(:))*ZCOEFFMF_CLOUD(:)*ZEPSI_CLOUD(:)<a name='1011'>
     PDETR(:) = PDETR+(1.-ZPART_DRY(:))*ZCOEFFMF_CLOUD(:)*ZDELTA(:)<a name='1012'>
 ENDWHERE<a name='1013'>
 <a name='1014'>
<a name='1015'>
<a name='1016'>
END SUBROUTINE COMPUTE_ENTR_DETR  <a name='1017'>
<a name='1018'>
                                       <a name='1019'>
<font color=#447700>!     #################################################################<a name='1020'></font>
<A NAME='COMPUTE_FUNCTION_THERMO_MF'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_FUNCTION_THERMO_MF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1021'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>COMPUTE_FUNCTION_THERMO_MF</font>( KRR,KRRL,KRRI,                  &amp; <A href='../../call_to/COMPUTE_FUNCTION_THERMO_MF.html' TARGET='index'>1</A><a name='1022'>
                                       PTH, PR, PEXN, PPABS,                 &amp;<a name='1023'>
                                       PT,PLVOCPEXN,PLSOCPEXN,               &amp;<a name='1024'>
                                       PAMOIST,PATHETA                       )<a name='1025'>
<font color=#447700>!     #################################################################<a name='1026'></font>
<font color=#447700>!<a name='1027'></font>
<font color=#447700>!!<a name='1028'></font>
<font color=#447700>!!****  *COMPUTE_FUNCTION_THERMO_MF* - <a name='1029'></font>
<font color=#447700>!!<a name='1030'></font>
<font color=#447700>!!<a name='1031'></font>
<font color=#447700>!! --------------------------------------------------------------------------<a name='1032'></font>
<font color=#447700>!       <a name='1033'></font>
<a name='1034'>
<font color=#447700>!<a name='1035'></font>
IMPLICIT NONE<a name='1036'>
<font color=#447700>!<a name='1037'></font>
<font color=#447700>!<a name='1038'></font>
<font color=#447700>!*      0.1  declarations of arguments<a name='1039'></font>
<font color=#447700>!<a name='1040'></font>
INTEGER,                INTENT(IN)   :: KRR           <font color=#447700>! number of moist var.<a name='1041'></font>
INTEGER,                INTENT(IN)   :: KRRL          <font color=#447700>! number of liquid water var.<a name='1042'></font>
INTEGER,                INTENT(IN)   :: KRRI          <font color=#447700>! number of ice water var.<a name='1043'></font>
<a name='1044'>
REAL, DIMENSION(:,:,:), INTENT(IN)   :: PTH      <font color=#447700>! theta<a name='1045'></font>
REAL, DIMENSION(:,:,:,:), INTENT(IN) :: PR       <font color=#447700>! water species<a name='1046'></font>
REAL, DIMENSION(:,:,:)  , INTENT(IN) :: PPABS,PEXN    <font color=#447700>! pressure, Exner funct.<a name='1047'></font>
<a name='1048'>
REAL, DIMENSION(:,:,:), INTENT(OUT)   :: PT      <font color=#447700>! temperature<a name='1049'></font>
REAL, DIMENSION(:,:,:), INTENT(OUT)   :: PLVOCPEXN,PLSOCPEXN     <font color=#447700>! L/(cp*Pi)<a name='1050'></font>
<a name='1051'>
REAL, DIMENSION(:,:,:), INTENT(OUT)  ::  PAMOIST,PATHETA<a name='1052'>
<font color=#447700>!<a name='1053'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1054'></font>
<font color=#447700>! <a name='1055'></font>
<font color=#447700>!*       0.2   Declarations of local variables<a name='1056'></font>
<font color=#447700>!<a name='1057'></font>
REAL                :: ZEPS         <font color=#447700>! XMV / XMD<a name='1058'></font>
REAL, DIMENSION(SIZE(PTH,1),SIZE(PTH,2),SIZE(PTH,3)) ::     &amp;<a name='1059'>
          ZCP,                        &amp;  <font color=#447700>! Cp <a name='1060'></font>
          ZE,                         &amp;  <font color=#447700>! Saturation mixing ratio<a name='1061'></font>
          ZDEDT,                      &amp;  <font color=#447700>! Saturation mixing ratio derivative<a name='1062'></font>
          ZFRAC_ICE,                  &amp;  <font color=#447700>! Ice fraction<a name='1063'></font>
          ZAMOIST_W,                  &amp;  <font color=#447700>! Coefficients for s = f (Thetal,Rnp)<a name='1064'></font>
          ZATHETA_W,                  &amp;  <font color=#447700>!<a name='1065'></font>
          ZAMOIST_I,                  &amp;  <font color=#447700>!<a name='1066'></font>
          ZATHETA_I                      <font color=#447700>!<a name='1067'></font>
<a name='1068'>
INTEGER             :: JRR<a name='1069'>
<font color=#447700>!<a name='1070'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1071'></font>
<font color=#447700>!<a name='1072'></font>
  ZEPS = XMV / XMD<a name='1073'>
<a name='1074'>
  PLVOCPEXN(:,:,:) = 0.<a name='1075'>
  PLSOCPEXN(:,:,:) = 0.<a name='1076'>
  PAMOIST(:,:,:) = 0.<a name='1077'>
  PATHETA(:,:,:) = 0.<a name='1078'>
  ZFRAC_ICE(:,:,:) = 0.0<a name='1079'>
  ZAMOIST_W(:,:,:) = 0.0<a name='1080'>
  ZATHETA_W(:,:,:) = 0.0<a name='1081'>
  ZAMOIST_I(:,:,:) = 0.0<a name='1082'>
  ZATHETA_I(:,:,:) = 0.0<a name='1083'>
<font color=#447700>!<a name='1084'></font>
<font color=#447700>!*       Cph<a name='1085'></font>
<font color=#447700>!<a name='1086'></font>
ZCP=XCPD<a name='1087'>
<a name='1088'>
IF (KRR &gt; 0) ZCP(:,:,:) = ZCP(:,:,:) + XCPV * PR(:,:,:,1)<a name='1089'>
<a name='1090'>
DO JRR = 2,1+KRRL  <font color=#447700>! loop on the liquid components  <a name='1091'></font>
   ZCP(:,:,:)  = ZCP(:,:,:) + XCL * PR(:,:,:,JRR)<a name='1092'>
END DO<a name='1093'>
<a name='1094'>
DO JRR = 2+KRRL,1+KRRL+KRRI <font color=#447700>! loop on the solid components   <a name='1095'></font>
  ZCP(:,:,:)  = ZCP(:,:,:)  + XCI * PR(:,:,:,JRR)<a name='1096'>
END DO<a name='1097'>
<a name='1098'>
<font color=#447700>!*      Temperature<a name='1099'></font>
<font color=#447700>!<a name='1100'></font>
PT(:,:,:) =  PTH(:,:,:) * PEXN(:,:,:)<a name='1101'>
<font color=#447700>!<a name='1102'></font>
<font color=#447700>!<a name='1103'></font>
<font color=#447700>!! Liquid water<a name='1104'></font>
<font color=#447700>!<a name='1105'></font>
IF ( KRRL &gt;= 1 ) THEN <a name='1106'>
<font color=#447700>!<a name='1107'></font>
<font color=#447700>!*       Lv/Cph <a name='1108'></font>
<font color=#447700>!<a name='1109'></font>
  PLVOCPEXN(:,:,:) = (XLVTT + (XCPV-XCL) *  (PT(:,:,:)-XTT) ) / ZCP(:,:,:)<a name='1110'>
<font color=#447700>!<a name='1111'></font>
<font color=#447700>!*      Saturation vapor pressure with respect to water<a name='1112'></font>
<font color=#447700>!<a name='1113'></font>
  ZE(:,:,:) =  EXP( XALPW - XBETAW/PT(:,:,:) - XGAMW*ALOG( PT(:,:,:) ) )<a name='1114'>
<font color=#447700>!<a name='1115'></font>
<font color=#447700>!*      Saturation  mixing ratio with respect to water<a name='1116'></font>
<font color=#447700>!<a name='1117'></font>
  ZE(:,:,:) =  ZE(:,:,:) * ZEPS / ( PPABS(:,:,:) - ZE(:,:,:) )<a name='1118'>
<font color=#447700>!<a name='1119'></font>
<font color=#447700>!*      Compute the saturation mixing ratio derivative (rvs')<a name='1120'></font>
<font color=#447700>!<a name='1121'></font>
  ZDEDT(:,:,:) = ( XBETAW / PT(:,:,:)  - XGAMW ) / PT(:,:,:)   &amp;<a name='1122'>
                 * ZE(:,:,:) * ( 1. + ZE(:,:,:) / ZEPS )<a name='1123'>
<font color=#447700>!<a name='1124'></font>
<font color=#447700>!*      Compute Amoist<a name='1125'></font>
<font color=#447700>!<a name='1126'></font>
  ZAMOIST_W(:,:,:)=  0.5 / ( 1.0 + ZDEDT(:,:,:) * PLVOCPEXN(:,:,:) )<a name='1127'>
<font color=#447700>!<a name='1128'></font>
<font color=#447700>!*      Compute Atheta<a name='1129'></font>
<font color=#447700>!<a name='1130'></font>
  ZATHETA_W(:,:,:)= ZAMOIST_W(:,:,:) * PEXN(:,:,:) *                       &amp;<a name='1131'>
        ( ( ZE(:,:,:) - PR(:,:,:,1) ) * PLVOCPEXN(:,:,:) /                  &amp;<a name='1132'>
          ( 1. + ZDEDT(:,:,:) * PLVOCPEXN(:,:,:) )           *              &amp;<a name='1133'>
          (                                                                 &amp;<a name='1134'>
           ZE(:,:,:) * (1. + ZE(:,:,:)/ZEPS)                                &amp;<a name='1135'>
                        * ( -2.*XBETAW/PT(:,:,:) + XGAMW ) / PT(:,:,:)**2   &amp;<a name='1136'>
          +ZDEDT(:,:,:) * (1. + 2. * ZE(:,:,:)/ZEPS)                        &amp;<a name='1137'>
                        * ( XBETAW/PT(:,:,:) - XGAMW ) / PT(:,:,:)          &amp;<a name='1138'>
          )                                                                 &amp;<a name='1139'>
         - ZDEDT(:,:,:)                                                     &amp;<a name='1140'>
        )<a name='1141'>
<a name='1142'>
<font color=#447700>!<a name='1143'></font>
<font color=#447700>!! Solid water<a name='1144'></font>
<font color=#447700>!<a name='1145'></font>
  IF ( KRRI &gt;= 1 ) THEN <a name='1146'>
<a name='1147'>
<font color=#447700>!<a name='1148'></font>
<font color=#447700>!*       Fraction of ice<a name='1149'></font>
<font color=#447700>!<a name='1150'></font>
    WHERE(PR(:,:,:,2)+PR(:,:,:,4)&gt;0.0)<a name='1151'>
      ZFRAC_ICE(:,:,:) = PR(:,:,:,4) / ( PR(:,:,:,2)+PR(:,:,:,4) )<a name='1152'>
    END WHERE<a name='1153'>
<font color=#447700>!<a name='1154'></font>
<font color=#447700>!*       Ls/Cph <a name='1155'></font>
<font color=#447700>!<a name='1156'></font>
    PLSOCPEXN(:,:,:) = (XLSTT + (XCPV-XCI) *  (PT(:,:,:)-XTT) ) / ZCP(:,:,:)<a name='1157'>
<font color=#447700>!<a name='1158'></font>
<font color=#447700>!*      Saturation vapor pressure with respect to ice<a name='1159'></font>
<font color=#447700>!<a name='1160'></font>
    ZE(:,:,:) =  EXP( XALPI - XBETAI/PT(:,:,:) - XGAMI*ALOG( PT(:,:,:) ) )<a name='1161'>
<font color=#447700>!<a name='1162'></font>
<font color=#447700>!*      Saturation  mixing ratio with respect to ice<a name='1163'></font>
<font color=#447700>!<a name='1164'></font>
    ZE(:,:,:) =  ZE(:,:,:) * ZEPS / ( PPABS(:,:,:) - ZE(:,:,:) )<a name='1165'>
<font color=#447700>!<a name='1166'></font>
<font color=#447700>!*      Compute the saturation mixing ratio derivative (rvs')<a name='1167'></font>
<font color=#447700>!<a name='1168'></font>
    ZDEDT(:,:,:) = ( XBETAI / PT(:,:,:)  - XGAMI ) / PT(:,:,:)   &amp;<a name='1169'>
                   * ZE(:,:,:) * ( 1. + ZE(:,:,:) / ZEPS )<a name='1170'>
<font color=#447700>!<a name='1171'></font>
<font color=#447700>!*      Compute Amoist<a name='1172'></font>
<font color=#447700>!<a name='1173'></font>
    ZAMOIST_I(:,:,:)=  0.5 / ( 1.0 + ZDEDT(:,:,:) * PLSOCPEXN(:,:,:) )<a name='1174'>
<font color=#447700>!<a name='1175'></font>
<font color=#447700>!*      Compute Atheta<a name='1176'></font>
<font color=#447700>!<a name='1177'></font>
    ZATHETA_I(:,:,:)= ZAMOIST_I(:,:,:) * PEXN(:,:,:) *                     &amp;<a name='1178'>
        ( ( ZE(:,:,:) - PR(:,:,:,1) ) * PLSOCPEXN(:,:,:) /                  &amp;<a name='1179'>
          ( 1. + ZDEDT(:,:,:) * PLSOCPEXN(:,:,:) )           *              &amp;<a name='1180'>
          (                                                                 &amp;<a name='1181'>
           ZE(:,:,:) * (1. + ZE(:,:,:)/ZEPS)                                &amp;<a name='1182'>
                        * ( -2.*XBETAI/PT(:,:,:) + XGAMI ) / PT(:,:,:)**2   &amp;<a name='1183'>
          +ZDEDT(:,:,:) * (1. + 2. * ZE(:,:,:)/ZEPS)                        &amp;<a name='1184'>
                        * ( XBETAI/PT(:,:,:) - XGAMI ) / PT(:,:,:)          &amp;<a name='1185'>
          )                                                                 &amp;<a name='1186'>
         - ZDEDT(:,:,:)                                                     &amp;<a name='1187'>
        )<a name='1188'>
<a name='1189'>
<a name='1190'>
  ENDIF<a name='1191'>
<a name='1192'>
  PAMOIST(:,:,:) = (1.0-ZFRAC_ICE(:,:,:))*ZAMOIST_W(:,:,:) &amp;<a name='1193'>
                         +ZFRAC_ICE(:,:,:) *ZAMOIST_I(:,:,:)<a name='1194'>
  PATHETA(:,:,:) = (1.0-ZFRAC_ICE(:,:,:))*ZATHETA_W(:,:,:) &amp;<a name='1195'>
                         +ZFRAC_ICE(:,:,:) *ZATHETA_I(:,:,:)<a name='1196'>
<a name='1197'>
<font color=#447700>!<a name='1198'></font>
<font color=#447700>!*      Lv/Cph/Exner and  Ls/Cph/Exner<a name='1199'></font>
<font color=#447700>!<a name='1200'></font>
  PLVOCPEXN(:,:,:) = PLVOCPEXN(:,:,:) / PEXN(:,:,:)<a name='1201'>
  PLSOCPEXN(:,:,:) = PLSOCPEXN(:,:,:) / PEXN(:,:,:)<a name='1202'>
<font color=#447700>!<a name='1203'></font>
ENDIF<a name='1204'>
<a name='1205'>
END SUBROUTINE COMPUTE_FUNCTION_THERMO_MF<a name='1206'>
<font color=#447700>!<a name='1207'></font>
<font color=#447700>!     #################################################################<a name='1208'></font>
<A NAME='COMPUTE_UPDRAFT'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_UPDRAFT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1209'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>COMPUTE_UPDRAFT</font>(OMIXUV,PZZ,PDZZ,KK,              &amp; <A href='../../call_to/COMPUTE_UPDRAFT.html' TARGET='index'>1</A>,<A href='../../call_from/COMPUTE_UPDRAFT.html' TARGET='index'>4</A><a name='1210'>
                                 PSFTH,PSFRV,                     &amp;<a name='1211'>
                                 PPABSM,PRHODREF,PUM,PVM, PTKEM,  &amp;<a name='1212'>
                                 PTHM,PRVM,PRCM,PRIM,PTHLM,PRTM,  &amp;<a name='1213'>
                                 PTHL_UP,PRT_UP,                  &amp;<a name='1214'>
                                 PRV_UP,PRC_UP,PRI_UP,PTHV_UP,    &amp;<a name='1215'>
                                 PW_UP,PU_UP, PV_UP,              &amp;<a name='1216'>
                                 PFRAC_UP,PEMF,PDETR,PENTR,       &amp;<a name='1217'>
                                 KKLCL,KKETL,KKCTL)<a name='1218'>
<font color=#447700>!     #################################################################<a name='1219'></font>
<font color=#447700>!!<a name='1220'></font>
<font color=#447700>!!****  *COMPUTE_UPDRAFT* - calculates caracteristics of the updraft <a name='1221'></font>
<font color=#447700>!!                         <a name='1222'></font>
<font color=#447700>!! --------------------------------------------------------------------------<a name='1223'></font>
<a name='1224'>
<a name='1225'>
<a name='1226'>
IMPLICIT NONE<a name='1227'>
<a name='1228'>
<font color=#447700>!*                    1.1  Declaration of Arguments<a name='1229'></font>
<font color=#447700>!<a name='1230'></font>
<font color=#447700>!<a name='1231'></font>
<font color=#447700>!<a name='1232'></font>
LOGICAL,                INTENT(IN) :: OMIXUV    <font color=#447700>! True if mixing of momentum<a name='1233'></font>
REAL, DIMENSION(:,:), INTENT(IN)   :: PZZ       <font color=#447700>!  Height at the flux point<a name='1234'></font>
REAL, DIMENSION(:,:), INTENT(IN)   :: PDZZ      <font color=#447700>!  Metrics coefficient<a name='1235'></font>
 <a name='1236'>
INTEGER,              INTENT(IN)   ::  KK        <a name='1237'>
REAL, DIMENSION(:),   INTENT(IN)   ::  PSFTH,PSFRV<a name='1238'>
<font color=#447700>! normal surface fluxes of theta,rv,(u,v) parallel to the orography<a name='1239'></font>
<font color=#447700>!<a name='1240'></font>
REAL, DIMENSION(:,:),   INTENT(IN) ::  PPABSM     <font color=#447700>! Pressure at t-dt<a name='1241'></font>
REAL, DIMENSION(:,:),   INTENT(IN) ::  PRHODREF   <font color=#447700>! dry density of the<a name='1242'></font>
                                                  <font color=#447700>! reference state<a name='1243'></font>
REAL, DIMENSION(:,:),   INTENT(IN) ::  PUM        <font color=#447700>! u mean wind<a name='1244'></font>
REAL, DIMENSION(:,:),   INTENT(IN) ::  PVM        <font color=#447700>! v mean wind<a name='1245'></font>
REAL, DIMENSION(:,:),   INTENT(IN) ::  PTKEM      <font color=#447700>! TKE at t-dt<a name='1246'></font>
<font color=#447700>!<a name='1247'></font>
REAL, DIMENSION(:,:),   INTENT(IN)   ::  PTHM           <font color=#447700>! liquid pot. temp. at t-dt<a name='1248'></font>
REAL, DIMENSION(:,:),   INTENT(IN)   ::  PRVM,PRCM,PRIM <font color=#447700>! vapor mixing ratio at t-dt<a name='1249'></font>
REAL, DIMENSION(:,:),   INTENT(IN)   ::  PTHLM,PRTM     <font color=#447700>! cons. var. at t-dt<a name='1250'></font>
<a name='1251'>
<a name='1252'>
REAL, DIMENSION(:,:),   INTENT(OUT)  ::  PTHL_UP,PRT_UP   <font color=#447700>! updraft properties<a name='1253'></font>
REAL, DIMENSION(:,:),   INTENT(OUT)  ::  PU_UP, PV_UP     <font color=#447700>! updraft wind components<a name='1254'></font>
REAL, DIMENSION(:,:),   INTENT(OUT)  ::  PRV_UP,PRC_UP, &amp; <font color=#447700>! updraft rv, rc<a name='1255'></font>
                                         PRI_UP,PTHV_UP,&amp; <font color=#447700>! updraft ri, THv<a name='1256'></font>
                                         PW_UP,PFRAC_UP   <font color=#447700>! updraft w, fraction<a name='1257'></font>
<a name='1258'>
                                         <a name='1259'>
REAL, DIMENSION(:,:),   INTENT(OUT)  ::  PEMF,PDETR,PENTR <font color=#447700>! Mass_flux,<a name='1260'></font>
                                                          <font color=#447700>! detrainment,entrainment<a name='1261'></font>
INTEGER, DIMENSION(:),  INTENT(OUT)  ::  KKLCL,KKETL,KKCTL<font color=#447700>! LCL, ETL, CTL                                     <a name='1262'></font>
<font color=#447700>!                       1.2  Declaration of local variables<a name='1263'></font>
<font color=#447700>!<a name='1264'></font>
<font color=#447700>!<a name='1265'></font>
<font color=#447700>! Mean environment variables at t-dt at flux point<a name='1266'></font>
REAL, DIMENSION(SIZE(PTHM,1),SIZE(PTHM,2)) ::    &amp;<a name='1267'>
                        ZTHM_F,ZRVM_F,ZRCM_F,ZRIM_F   <font color=#447700>! Theta,rv,rl,ri of<a name='1268'></font>
                                                      <font color=#447700>! updraft environnement<a name='1269'></font>
REAL, DIMENSION(SIZE(PTHM,1),SIZE(PTHM,2)) ::    &amp;<a name='1270'>
                        ZRTM_F, ZTHLM_F, ZTKEM_F,&amp;    <font color=#447700>! rt, thetal,TKE,pressure,<a name='1271'></font>
                        ZUM_F,ZVM_F,ZRHO_F,      &amp;    <font color=#447700>! density,momentum<a name='1272'></font>
                        ZPRES_F,ZTHVM_F,ZTHVM,   &amp;    <font color=#447700>! interpolated at the flux point<a name='1273'></font>
                        ZG_O_THVREF,             &amp;    <font color=#447700>! g*ThetaV ref<a name='1274'></font>
                        ZW_UP2                        <font color=#447700>! w**2  of the updraft<a name='1275'></font>
<a name='1276'>
                        <a name='1277'>
REAL, DIMENSION(SIZE(PTHM,1),SIZE(PTHM,2)) ::  &amp;<a name='1278'>
                        ZTH_UP,                  &amp;    <font color=#447700>! updraft THETA <a name='1279'></font>
                        ZFRAC_ICE                     <font color=#447700>! Ice fraction<a name='1280'></font>
<a name='1281'>
REAL, DIMENSION(SIZE(PTHM,1),SIZE(PTHM,2)) ::  ZCOEF  <font color=#447700>! diminution coefficient for too high clouds <a name='1282'></font>
                        <a name='1283'>
REAL, DIMENSION(SIZE(PSFTH,1) )            ::  ZWTHVSURF  <font color=#447700>! Surface w'thetav'<a name='1284'></font>
CHARACTER(LEN=1)                           ::  YFRAC_ICE  <font color=#447700>! Ice Fraction<a name='1285'></font>
                                                          <font color=#447700>! precribed or computed <a name='1286'></font>
<a name='1287'>
REAL  :: ZRDORV       <font color=#447700>! RD/RV<a name='1288'></font>
REAL  :: ZRVORD       <font color=#447700>! RV/RD<a name='1289'></font>
<a name='1290'>
<a name='1291'>
REAL, DIMENSION(SIZE(PTHM,1)) :: ZMIX1,ZMIX2,ZMIX3<a name='1292'>
REAL, DIMENSION(SIZE(PTHM,1)) :: ZBUO_INTEG           <font color=#447700>! Integrated Buoyancy <a name='1293'></font>
<a name='1294'>
REAL, DIMENSION(SIZE(PTHM,1)) :: ZLUP         <font color=#447700>! Upward Mixing length from the ground<a name='1295'></font>
REAL, DIMENSION(SIZE(PTHM,1)) :: ZDEPTH       <font color=#447700>! Deepness limit for cloud<a name='1296'></font>
<a name='1297'>
INTEGER  :: IKB,IKE            <font color=#447700>! index value for the Beginning and the End<a name='1298'></font>
                               <font color=#447700>! of the physical domain for the mass points<a name='1299'></font>
INTEGER  :: IKU           <font color=#447700>! array size in k<a name='1300'></font>
INTEGER  :: JK,JI,JSV          <font color=#447700>! loop counters<a name='1301'></font>
<a name='1302'>
LOGICAL, DIMENSION(SIZE(PTHM,1)) ::  GTEST,GTESTLCL,GTESTETL<a name='1303'>
                               <font color=#447700>! Test if the ascent continue, if LCL or ETL is reached<a name='1304'></font>
LOGICAL                          ::  GLMIX <a name='1305'>
                               <font color=#447700>! To choose upward or downward mixing length<a name='1306'></font>
LOGICAL, DIMENSION(SIZE(PTHM,1))              :: GWORK1<a name='1307'>
LOGICAL, DIMENSION(SIZE(PTHM,1),SIZE(PTHM,2)) :: GWORK2<a name='1308'>
<a name='1309'>
INTEGER  :: ITEST<a name='1310'>
REAL  :: ZTMAX,ZRMAX  <font color=#447700>! control value<a name='1311'></font>
<font color=#447700>! Thresholds for the  perturbation of<a name='1312'></font>
<font color=#447700>! theta_l and r_t at the first level of the updraft<a name='1313'></font>
ZTMAX=2.0<a name='1314'>
ZRMAX=1.E-3<a name='1315'>
<font color=#447700>!------------------------------------------------------------------------<a name='1316'></font>
<a name='1317'>
<font color=#447700>!                     INITIALISATION<a name='1318'></font>
<a name='1319'>
<font color=#447700>!                 Local variables, internal domain<a name='1320'></font>
<font color=#447700>! Internal Domain<a name='1321'></font>
IKU=SIZE(PTHM,2)<a name='1322'>
IKB=1        <font color=#447700>! modif WRF JP<a name='1323'></font>
IKE=IKU-1      <font color=#447700>! modif WRF JP<a name='1324'></font>
<a name='1325'>
<font color=#447700>! Initialisation of intersesting Level :LCL,ETL,CTL<a name='1326'></font>
KKLCL(:)=IKE<a name='1327'>
KKETL(:)=IKE<a name='1328'>
KKCTL(:)=IKE<a name='1329'>
<a name='1330'>
<font color=#447700>! <a name='1331'></font>
<font color=#447700>! Initialisation<a name='1332'></font>
PRV_UP(:,:)=0.<a name='1333'>
PRC_UP(:,:)=0.<a name='1334'>
<a name='1335'>
PW_UP(:,:)=0.<a name='1336'>
PEMF(:,:)=0.<a name='1337'>
PDETR(:,:)=0.<a name='1338'>
PENTR(:,:)=0.<a name='1339'>
ZTH_UP(:,:)=0.<a name='1340'>
PFRAC_UP(:,:)=0.<a name='1341'>
PTHV_UP(:,:)=0.<a name='1342'>
<a name='1343'>
<font color=#447700>!no ice cloud coded yet <a name='1344'></font>
PRI_UP(:,:)=0.<a name='1345'>
ZFRAC_ICE(:,:)=0.<a name='1346'>
YFRAC_ICE='T'<a name='1347'>
<a name='1348'>
ZBUO_INTEG=0.<a name='1349'>
<font color=#447700>! Initialisation of the constants   <a name='1350'></font>
ZRDORV   = XRD / XRV   <font color=#447700>!=0.622<a name='1351'></font>
ZRVORD   = (XRV / XRD) <a name='1352'>
<a name='1353'>
<a name='1354'>
<font color=#447700>! Initialisation of environment variables at t-dt<a name='1355'></font>
<a name='1356'>
<font color=#447700>! variables at flux level<a name='1357'></font>
<a name='1358'>
<a name='1359'>
ZTHM_F (:,IKB+1:IKU) = 0.5*(PTHM(:,IKB:IKU-1)+PTHM(:,IKB+1:IKU))<a name='1360'>
ZTHLM_F(:,IKB+1:IKU) = 0.5*(PTHLM(:,IKB:IKU-1)+PTHLM(:,IKB+1:IKU))<a name='1361'>
ZRTM_F (:,IKB+1:IKU) = 0.5*(PRTM(:,IKB:IKU-1)+PRTM(:,IKB+1:IKU))<a name='1362'>
ZTKEM_F(:,IKB+1:IKU) = 0.5*(PTKEM(:,IKB:IKU-1)+PTKEM(:,IKB+1:IKU))<a name='1363'>
ZPRES_F(:,IKB+1:IKU) = 0.5*(PPABSM(:,IKB:IKU-1)+PPABSM(:,IKB+1:IKU))<a name='1364'>
ZRHO_F (:,IKB+1:IKU) = 0.5*(PRHODREF(:,IKB:IKU-1)+PRHODREF(:,IKB+1:IKU))<a name='1365'>
ZRVM_F (:,IKB+1:IKU) = 0.5*(PRVM(:,IKB:IKU-1)+PRVM(:,IKB+1:IKU))<a name='1366'>
ZUM_F  (:,IKB+1:IKU) = 0.5*(PUM(:,IKB:IKU-1)+PUM(:,IKB+1:IKU))<a name='1367'>
ZVM_F  (:,IKB+1:IKU) = 0.5*(PVM(:,IKB:IKU-1)+PVM(:,IKB+1:IKU))<a name='1368'>
<a name='1369'>
<a name='1370'>
<a name='1371'>
ZTHM_F (:,IKB) = PTHM(:,IKB) <a name='1372'>
ZTHLM_F(:,IKB) = PTHLM(:,IKB)<a name='1373'>
ZRTM_F (:,IKB) = PRTM (:,IKB)<a name='1374'>
ZTKEM_F(:,IKB) = PTKEM(:,IKB)<a name='1375'>
ZPRES_F(:,IKB) = PPABSM(:,IKB)<a name='1376'>
ZRHO_F(:,IKB)  = PRHODREF(:,IKB)<a name='1377'>
ZRVM_F(:,IKB)  = PRVM(:,IKB)<a name='1378'>
ZUM_F(:,IKB)   = PUM(:,IKB)<a name='1379'>
ZVM_F(:,IKB)   = PVM(:,IKB)<a name='1380'>
<a name='1381'>
<a name='1382'>
<font color=#447700>! thetav at mass and flux levels <a name='1383'></font>
ZTHVM_F(:,:)=ZTHM_F(:,:)*((1.+ZRVORD*ZRVM_F(:,:))/(1.+ZRTM_F(:,:)))<a name='1384'>
ZTHVM(:,:)=PTHM(:,:)*((1.+ZRVORD*PRVM(:,:))/(1.+PRTM(:,:)))<a name='1385'>
<a name='1386'>
<a name='1387'>
<font color=#447700>!                     <a name='1388'></font>
<font color=#447700>!          Initialisation of updraft characteristics <a name='1389'></font>
PTHL_UP(:,:)=ZTHLM_F(:,:)<a name='1390'>
PRT_UP(:,:)=ZRTM_F(:,:)<a name='1391'>
ZW_UP2(:,:)=0.<a name='1392'>
PTHV_UP(:,:)=ZTHVM_F(:,:)<a name='1393'>
PU_UP(:,:)=ZUM_F(:,:)<a name='1394'>
PV_UP(:,:)=ZVM_F(:,:)<a name='1395'>
<a name='1396'>
<a name='1397'>
<font color=#447700>! Computation or initialisation of updraft characteristics at the KK level<a name='1398'></font>
<font color=#447700>! thetal_up,rt_up,thetaV_up, w-squared,Buoyancy term and mass flux (PEMF)<a name='1399'></font>
<a name='1400'>
<font color=#447700>! 03/2009<a name='1401'></font>
<font color=#447700>!PTHL_UP(:,KK)= ZTHLM_F(:,KK)+(PSFTH(:)/SQRT(ZTKEM_F(:,KK)))*XALP_PERT<a name='1402'></font>
<font color=#447700>!PRT_UP(:,KK) = ZRTM_F(:,KK)+(PSFRV(:)/SQRT(ZTKEM_F(:,KK)))*XALP_PERT<a name='1403'></font>
PTHL_UP(:,KK)= ZTHLM_F(:,KK)+MAX(0.,MIN(ZTMAX,(PSFTH(:)/SQRT(ZTKEM_F(:,KK)))*XALP_PERT))<a name='1404'>
PRT_UP(:,KK) = ZRTM_F(:,KK)+MAX(0.,MIN(ZRMAX,(PSFRV(:)/SQRT(ZTKEM_F(:,KK)))*XALP_PERT)) <a name='1405'>
<a name='1406'>
<a name='1407'>
<a name='1408'>
ZW_UP2(:,KK) = MAX(0.0001,(2./3.)*ZTKEM_F(:,KK))<a name='1409'>
<a name='1410'>
<a name='1411'>
<font color=#447700>! Computation of non conservative variable for the KK level of the updraft<a name='1412'></font>
<font color=#447700>! (all or nothing ajustement)<a name='1413'></font>
CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_2D'>TH_R_FROM_THL_RT_2D</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_UPDRAFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TH_R_FROM_THL_RT_2D_1">(YFRAC_ICE,ZFRAC_ICE(:,KK:KK),ZPRES_F(:,KK:KK), &amp;<a name='1414'>
             PTHL_UP(:,KK:KK),PRT_UP(:,KK:KK),ZTH_UP(:,KK:KK), &amp;<a name='1415'>
             PRV_UP(:,KK:KK),PRC_UP(:,KK:KK),PRI_UP(:,KK:KK))<a name='1416'>
<a name='1417'>
<font color=#447700>! compute updraft thevav and buoyancy term at KK level             <a name='1418'></font>
PTHV_UP(:,KK) = ZTH_UP(:,KK)*((1+ZRVORD*PRV_UP(:,KK))/(1+PRT_UP(:,KK))) <a name='1419'>
                                                            <a name='1420'>
<font color=#447700>! Closure assumption for mass flux at KK level                                                  <a name='1421'></font>
ZG_O_THVREF=XG/ZTHVM_F<a name='1422'>
<a name='1423'>
<font color=#447700>! compute L_up<a name='1424'></font>
GLMIX=.TRUE.<a name='1425'>
ZTKEM_F(:,KK)=0.<a name='1426'>
<a name='1427'>
CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_BL89_ML'>COMPUTE_BL89_ML</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_UPDRAFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_BL89_ML_1">(PDZZ,ZTKEM_F,ZG_O_THVREF,ZTHVM_F,KK,GLMIX,ZLUP)<a name='1428'>
ZLUP(:)=MAX(ZLUP(:),1.E-10)<a name='1429'>
<a name='1430'>
<font color=#447700>! Compute Buoyancy flux at the ground<a name='1431'></font>
ZWTHVSURF(:) = (ZTHVM_F(:,IKB)/ZTHM_F(:,IKB))*PSFTH(:)+     &amp;<a name='1432'>
                (0.61*ZTHM_F(:,IKB))*PSFRV(:)<a name='1433'>
<a name='1434'>
<font color=#447700>! Mass flux at KK level (updraft triggered if PSFTH&gt;0.)<a name='1435'></font>
WHERE (ZWTHVSURF(:)&gt;0.)<a name='1436'>
  PEMF(:,KK) = XCMF * ZRHO_F(:,KK) * ((ZG_O_THVREF(:,KK))*ZWTHVSURF*ZLUP)**(1./3.)<a name='1437'>
  PFRAC_UP(:,KK)=MIN(PEMF(:,KK)/(SQRT(ZW_UP2(:,KK))*ZRHO_F(:,KK)),XFRAC_UP_MAX)<a name='1438'>
  ZW_UP2(:,KK)=(PEMF(:,KK)/(PFRAC_UP(:,KK)*ZRHO_F(:,KK)))**2<a name='1439'>
  GTEST(:)=.TRUE.<a name='1440'>
ELSEWHERE<a name='1441'>
  PEMF(:,KK) =0.<a name='1442'>
  GTEST(:)=.FALSE.<a name='1443'>
ENDWHERE<a name='1444'>
<a name='1445'>
<a name='1446'>
<font color=#447700>!--------------------------------------------------------------------------<a name='1447'></font>
<a name='1448'>
<font color=#447700>!                        3. Iteration<a name='1449'></font>
<font color=#447700>!                           ---------<a name='1450'></font>
<font color=#447700>!<a name='1451'></font>
<font color=#447700>! If GTEST = T the updraft starts from the KK level and stops when GTEST becomes F<a name='1452'></font>
<font color=#447700>!<a name='1453'></font>
<font color=#447700>!<a name='1454'></font>
GTESTLCL(:)=.FALSE.<a name='1455'>
GTESTETL(:)=.FALSE.<a name='1456'>
<a name='1457'>
<font color=#447700>!       Loop on vertical level<a name='1458'></font>
<a name='1459'>
DO JK=KK,IKE-1<a name='1460'>
<font color=#447700>! IF the updraft top is reached for all column, stop the loop on levels<a name='1461'></font>
ITEST=COUNT(GTEST)<a name='1462'>
IF (ITEST==0) CYCLE<a name='1463'>
<font color=#447700>!       Computation of entrainment and detrainment with KF90<a name='1464'></font>
<font color=#447700>!       parameterization in clouds and LR01 in subcloud layer<a name='1465'></font>
<a name='1466'>
<a name='1467'>
<font color=#447700>! to find the LCL (check if JK is LCL or not)<a name='1468'></font>
<a name='1469'>
  WHERE(GTEST)<a name='1470'>
  WHERE ((PRC_UP(:,JK)&gt;0.).AND.(.NOT.(GTESTLCL)))<a name='1471'>
      KKLCL(:) = JK           <a name='1472'>
      GTESTLCL(:)=.TRUE.<a name='1473'>
  ENDWHERE<a name='1474'>
  ENDWHERE<a name='1475'>
<a name='1476'>
<a name='1477'>
<font color=#447700>! COMPUTE PENTR and PDETR at mass level JK<a name='1478'></font>
<a name='1479'>
 CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_ENTR_DETR'>COMPUTE_ENTR_DETR</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_UPDRAFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_ENTR_DETR_1">(GTEST,GTESTLCL,YFRAC_ICE,ZFRAC_ICE(:,JK),JK,&amp;<a name='1480'>
                       PPABSM(:,:),PZZ(:,:),PDZZ(:,:),ZTHVM(:,:),&amp;<a name='1481'>
                       PTHLM(:,JK),PRTM(:,JK),ZW_UP2(:,:),   &amp;<a name='1482'>
                       PTHL_UP(:,JK),PRT_UP(:,JK),ZLUP(:), &amp;<a name='1483'>
                       PENTR(:,JK),PDETR(:,JK),ZBUO_INTEG)<a name='1484'>
  <a name='1485'>
<a name='1486'>
  IF (JK==KK) THEN<a name='1487'>
       PDETR(:,JK)=0.<a name='1488'>
  ENDIF   <a name='1489'>
<a name='1490'>
 <a name='1491'>
<font color=#447700>!       Computation of updraft characteristics at level JK+1<a name='1492'></font>
  WHERE(GTEST)<a name='1493'>
    ZMIX1(:)=0.5*(PZZ(:,JK+1)-PZZ(:,JK))*(PENTR(:,JK)-PDETR(:,JK))<a name='1494'>
    PEMF(:,JK+1)=PEMF(:,JK)*EXP(2*ZMIX1(:))<a name='1495'>
  ENDWHERE<a name='1496'>
  <a name='1497'>
  <a name='1498'>
<a name='1499'>
<font color=#447700>! stop the updraft if MF becomes negative<a name='1500'></font>
  WHERE (GTEST.AND.(PEMF(:,JK+1)&lt;=0.))<a name='1501'>
    PEMF(:,JK+1)=0.<a name='1502'>
    GTEST(:)=.FALSE.<a name='1503'>
    KKCTL(:) = JK+1         <a name='1504'>
  ENDWHERE<a name='1505'>
<a name='1506'>
<a name='1507'>
<font color=#447700>! If the updraft did not stop, compute cons updraft characteritics at jk+1<a name='1508'></font>
  WHERE(GTEST)     <a name='1509'>
    ZMIX2(:) = (PZZ(:,JK+1)-PZZ(:,JK))*PENTR(:,JK) <font color=#447700>!&amp;<a name='1510'></font>
    ZMIX3(:) = (PZZ(:,JK+1)-PZZ(:,JK))*PDETR(:,JK) <font color=#447700>!&amp;                   <a name='1511'></font>
                <a name='1512'>
    PTHL_UP(:,JK+1) = (PTHL_UP(:,JK)*(1.-0.5*ZMIX2(:)) + PTHLM(:,JK)*ZMIX2(:)) &amp;<a name='1513'>
                          /(1.+0.5*ZMIX2(:))   <a name='1514'>
    PRT_UP(:,JK+1) = (PRT_UP (:,JK)*(1.-0.5*ZMIX2(:)) + PRTM(:,JK)*ZMIX2(:))   &amp;<a name='1515'>
                          /(1.+0.5*ZMIX2(:))<a name='1516'>
  ENDWHERE<a name='1517'>
  <a name='1518'>
<a name='1519'>
  IF(OMIXUV) THEN<a name='1520'>
    WHERE(GTEST) <a name='1521'>
      PU_UP(:,JK+1) = (PU_UP (:,JK)*(1-0.5*ZMIX2(:)) + PUM(:,JK)*ZMIX2(:)+ &amp;<a name='1522'>
                        0.5*XPRES_UV*(PZZ(:,JK+1)-PZZ(:,JK))*&amp;<a name='1523'>
                        ((PUM(:,JK+1)-PUM(:,JK))/PDZZ(:,JK+1)+&amp;<a name='1524'>
                         (PUM(:,JK)-PUM(:,JK-1))/PDZZ(:,JK))        )   &amp;<a name='1525'>
                        /(1+0.5*ZMIX2(:))<a name='1526'>
      PV_UP(:,JK+1) = (PV_UP (:,JK)*(1-0.5*ZMIX2(:)) + PVM(:,JK)*ZMIX2(:)+ &amp;<a name='1527'>
                        0.5*XPRES_UV*(PZZ(:,JK+1)-PZZ(:,JK))*&amp;<a name='1528'>
                        ((PVM(:,JK+1)-PVM(:,JK))/PDZZ(:,JK+1)+&amp;<a name='1529'>
                         (PVM(:,JK)-PVM(:,JK-1))/PDZZ(:,JK))    )   &amp;<a name='1530'>
                        /(1+0.5*ZMIX2(:))<a name='1531'>
    ENDWHERE<a name='1532'>
  ENDIF<a name='1533'>
  <a name='1534'>
<font color=#447700>! Compute non cons. var. at level JK+1<a name='1535'></font>
  CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_2D'>TH_R_FROM_THL_RT_2D</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_UPDRAFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TH_R_FROM_THL_RT_2D_2">(YFRAC_ICE,ZFRAC_ICE(:,JK+1:JK+1),ZPRES_F(:,JK+1:JK+1), &amp;<a name='1536'>
          PTHL_UP(:,JK+1:JK+1),PRT_UP(:,JK+1:JK+1),ZTH_UP(:,JK+1:JK+1), &amp;<a name='1537'>
          PRV_UP(:,JK+1:JK+1),PRC_UP(:,JK+1:JK+1),PRI_UP(:,JK+1:JK+1))<a name='1538'>
  <a name='1539'>
<a name='1540'>
<font color=#447700>! Compute the updraft theta_v, buoyancy and w**2 for level JK+1   <a name='1541'></font>
  WHERE(GTEST)<a name='1542'>
      PTHV_UP(:,JK+1) = ZTH_UP(:,JK+1)*((1+ZRVORD*PRV_UP(:,JK+1))/(1+PRT_UP(:,JK+1)))<a name='1543'>
   WHERE (.NOT.(GTESTLCL)) <a name='1544'>
      WHERE (ZBUO_INTEG(:)&gt;0.)<a name='1545'>
        ZW_UP2(:,JK+1)  = ZW_UP2(:,JK) + 2.*(XABUO-XBENTR*XENTR_DRY)* ZBUO_INTEG(:)              <a name='1546'>
      ENDWHERE<a name='1547'>
      WHERE (ZBUO_INTEG(:)&lt;=0.)<a name='1548'>
        ZW_UP2(:,JK+1)  = ZW_UP2(:,JK) + 2.*XABUO* ZBUO_INTEG(:)<a name='1549'>
      ENDWHERE      <a name='1550'>
   ENDWHERE      <a name='1551'>
   WHERE (GTESTLCL)<a name='1552'>
      ZW_UP2(:,JK+1)  = ZW_UP2(:,JK)*(1.-(XBDETR*ZMIX3(:)+XBENTR*ZMIX2(:)))&amp;<a name='1553'>
            /(1.+(XBDETR*ZMIX3(:)+XBENTR*ZMIX2(:))) &amp;<a name='1554'>
            +2.*(XABUO)*ZBUO_INTEG/(1.+(XBDETR*ZMIX3(:)+XBENTR*ZMIX2(:)))<a name='1555'>
   ENDWHERE<a name='1556'>
 ENDWHERE<a name='1557'>
<a name='1558'>
<a name='1559'>
<font color=#447700>! Test if the updraft has reach the ETL<a name='1560'></font>
  GTESTETL(:)=.FALSE.<a name='1561'>
  WHERE (GTEST.AND.(ZBUO_INTEG(:)&lt;=0.))<a name='1562'>
      KKETL(:) = JK+1           <a name='1563'>
      GTESTETL(:)=.TRUE.<a name='1564'>
  ENDWHERE<a name='1565'>
<a name='1566'>
<font color=#447700>! Test is we have reached the top of the updraft<a name='1567'></font>
  WHERE (GTEST.AND.((ZW_UP2(:,JK+1)&lt;=0.).OR.(PEMF(:,JK+1)&lt;=0.)))<a name='1568'>
      ZW_UP2(:,JK+1)=0.<a name='1569'>
      PEMF(:,JK+1)=0.<a name='1570'>
      GTEST(:)=.FALSE.<a name='1571'>
      PTHL_UP(:,JK+1)=ZTHLM_F(:,JK+1)<a name='1572'>
      PRT_UP(:,JK+1)=ZRTM_F(:,JK+1)<a name='1573'>
      PRC_UP(:,JK+1)=0.<a name='1574'>
      PRV_UP(:,JK+1)=0.<a name='1575'>
      PTHV_UP(:,JK+1)=ZTHVM_F(:,JK+1)<a name='1576'>
      PFRAC_UP(:,JK+1)=0.<a name='1577'>
      KKCTL(:)=JK+1<a name='1578'>
  ENDWHERE<a name='1579'>
 <a name='1580'>
<font color=#447700>! compute frac_up at JK+1<a name='1581'></font>
  WHERE (GTEST)<a name='1582'>
      PFRAC_UP(:,JK+1)=PEMF(:,JK+1)/(SQRT(ZW_UP2(:,JK+1))*ZRHO_F(:,JK+1))<a name='1583'>
  ENDWHERE<a name='1584'>
<a name='1585'>
<font color=#447700>! Updraft fraction must be smaller than XFRAC_UP_MAX<a name='1586'></font>
  WHERE (GTEST)<a name='1587'>
      PFRAC_UP(:,JK+1)=MIN(XFRAC_UP_MAX,PFRAC_UP(:,JK+1))<a name='1588'>
  ENDWHERE<a name='1589'>
<a name='1590'>
<a name='1591'>
<font color=#447700>! When cloudy and non-buoyant, updraft fraction must decrease<a name='1592'></font>
  <a name='1593'>
  WHERE ((GTEST.AND.GTESTETL).AND.GTESTLCL)<a name='1594'>
    PFRAC_UP(:,JK+1)=MIN(PFRAC_UP(:,JK+1),PFRAC_UP(:,JK))<a name='1595'>
  ENDWHERE<a name='1596'>
<a name='1597'>
<font color=#447700>! Mass flux is updated with the new updraft fraction<a name='1598'></font>
  <a name='1599'>
  PEMF(:,JK+1)=PFRAC_UP(:,JK+1)*SQRT(ZW_UP2(:,JK+1))*ZRHO_F(:,JK+1)<a name='1600'>
<a name='1601'>
ENDDO<a name='1602'>
<a name='1603'>
<a name='1604'>
PW_UP(:,:)=SQRT(ZW_UP2(:,:))<a name='1605'>
<a name='1606'>
PEMF(:,KK) =0.<a name='1607'>
PEMF(:,IKU)=0. <font color=#447700>! modif WRF JP<a name='1608'></font>
PFRAC_UP(:,IKU)=0.<a name='1609'>
<a name='1610'>
<a name='1611'>
DO JI=1,SIZE(PTHM,1) <a name='1612'>
   ZDEPTH(JI) = (PZZ(JI,KKCTL(JI)) -  PZZ(JI,KKLCL(JI)) )<a name='1613'>
END DO<a name='1614'>
<a name='1615'>
GWORK1(:)= (GTESTLCL(:) .AND. (ZDEPTH(:) &gt; 3000.) )<a name='1616'>
GWORK2(:,:) = SPREAD( GWORK1(:), DIM=2, NCOPIES=IKU )<a name='1617'>
ZCOEF(:,:) = SPREAD( (1.-(ZDEPTH(:)-3000.)/1000.), DIM=2, NCOPIES=IKU)<a name='1618'>
ZCOEF=MIN(MAX(ZCOEF,0.),1.)<a name='1619'>
<a name='1620'>
WHERE (GWORK2) <a name='1621'>
   PEMF(:,:)     = PEMF(:,:)     * ZCOEF(:,:)<a name='1622'>
   PFRAC_UP(:,:) = PFRAC_UP(:,:) * ZCOEF(:,:)<a name='1623'>
ENDWHERE<a name='1624'>
<a name='1625'>
<a name='1626'>
END SUBROUTINE COMPUTE_UPDRAFT<a name='1627'>
<a name='1628'>
<a name='1629'>
                <a name='1630'>
<font color=#447700>!     #################################################################<a name='1631'></font>
<A NAME='MF_TURB'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MF_TURB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1632'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>MF_TURB</font>(OMIXUV, PIMPL, PTSTEP,                       &amp; <A href='../../call_to/MF_TURB.html' TARGET='index'>1</A>,<A href='../../call_from/MF_TURB.html' TARGET='index'>4</A><a name='1633'>
                PTSTEP_MET,  PDZZ,                          &amp;<a name='1634'>
                PRHODJ,                                               &amp;<a name='1635'>
                PTHLM,PTHVM,PRTM,PUM,PVM,                             &amp;<a name='1636'>
                PTHLDT,PRTDT,PUDT,PVDT,                               &amp;<a name='1637'>
                PEMF,PTHL_UP,PTHV_UP,PRT_UP,PU_UP,PV_UP,              &amp;<a name='1638'>
                PFLXZTHMF,PFLXZTHVMF,PFLXZRMF,PFLXZUMF,PFLXZVMF       )<a name='1639'>
<a name='1640'>
<font color=#447700>!     #################################################################<a name='1641'></font>
<font color=#447700>!<a name='1642'></font>
<font color=#447700>!<a name='1643'></font>
<font color=#447700>!!****  *MF_TURB* - computes the MF_turbulent source terms for the prognostic<a name='1644'></font>
<font color=#447700>!!                  variables. <a name='1645'></font>
<font color=#447700>!!<a name='1646'></font>
<a name='1647'>
<font color=#447700>!! --------------------------------------------------------------------------<a name='1648'></font>
<a name='1649'>
<font color=#447700>!<a name='1650'></font>
<font color=#447700>!<a name='1651'></font>
IMPLICIT NONE<a name='1652'>
<font color=#447700>!<a name='1653'></font>
<font color=#447700>!<a name='1654'></font>
<font color=#447700>!*      0.1  declarations of arguments<a name='1655'></font>
<font color=#447700>!<a name='1656'></font>
<font color=#447700>!<a name='1657'></font>
LOGICAL,                INTENT(IN)   :: OMIXUV      <font color=#447700>! True if mixing of momentum<a name='1658'></font>
REAL,                   INTENT(IN)   :: PIMPL       <font color=#447700>! degree of implicitness<a name='1659'></font>
REAL,                 INTENT(IN)     ::  PTSTEP   <font color=#447700>! Dynamical timestep <a name='1660'></font>
REAL,                 INTENT(IN)     ::  PTSTEP_MET<font color=#447700>! Timestep for meteorological variables                        <a name='1661'></font>
<font color=#447700>!<a name='1662'></font>
REAL, DIMENSION(:,:,:), INTENT(IN)   :: PDZZ        <font color=#447700>! metric coefficients<a name='1663'></font>
<a name='1664'>
REAL, DIMENSION(:,:,:), INTENT(IN)   :: PRHODJ      <font color=#447700>! dry density * Grid size<a name='1665'></font>
<a name='1666'>
<font color=#447700>!   Conservative var. at t-dt<a name='1667'></font>
REAL, DIMENSION(:,:,:), INTENT(IN) ::  PTHLM        <font color=#447700>! conservative pot. temp.<a name='1668'></font>
REAL, DIMENSION(:,:,:), INTENT(IN) ::  PRTM         <font color=#447700>! water var.  where <a name='1669'></font>
<font color=#447700>!  Virtual potential temperature at t-dt<a name='1670'></font>
REAL, DIMENSION(:,:,:), INTENT(IN) ::  PTHVM <a name='1671'>
<font color=#447700>!  Momentum at t-dt<a name='1672'></font>
REAL, DIMENSION(:,:,:), INTENT(IN) ::  PUM<a name='1673'>
REAL, DIMENSION(:,:,:), INTENT(IN) ::  PVM<a name='1674'>
<font color=#447700>!<a name='1675'></font>
<font color=#447700>! Tendencies of conservative variables<a name='1676'></font>
REAL, DIMENSION(:,:,:),   INTENT(OUT) ::  PTHLDT<a name='1677'>
<a name='1678'>
REAL, DIMENSION(:,:,:),   INTENT(OUT) ::  PRTDT <a name='1679'>
<font color=#447700>! Tendencies of momentum<a name='1680'></font>
REAL, DIMENSION(:,:,:),   INTENT(OUT) ::  PUDT<a name='1681'>
REAL, DIMENSION(:,:,:),   INTENT(OUT) ::  PVDT<a name='1682'>
<font color=#447700>! Tendencies of scalar variables<a name='1683'></font>
<a name='1684'>
<a name='1685'>
<font color=#447700>! Updraft characteritics<a name='1686'></font>
REAL, DIMENSION(:,:,:), INTENT(IN)   ::  PEMF,PTHL_UP,PTHV_UP,PRT_UP,PU_UP,PV_UP<a name='1687'>
<font color=#447700>! Fluxes<a name='1688'></font>
REAL, DIMENSION(:,:,:), INTENT(OUT)  ::  PFLXZTHMF,PFLXZTHVMF,PFLXZRMF,PFLXZUMF,PFLXZVMF<a name='1689'>
<a name='1690'>
<font color=#447700>!<a name='1691'></font>
<font color=#447700>!<a name='1692'></font>
<font color=#447700>!<a name='1693'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1694'></font>
<font color=#447700>!<a name='1695'></font>
<font color=#447700>!       0.2  declaration of local variables<a name='1696'></font>
<font color=#447700>!<a name='1697'></font>
<a name='1698'>
REAL, DIMENSION(SIZE(PTHLM,1),SIZE(PTHLM,2),SIZE(PTHLM,3)) :: ZVARS<a name='1699'>
<a name='1700'>
<font color=#447700>!<a name='1701'></font>
<font color=#447700>!----------------------------------------------------------------------------<a name='1702'></font>
<font color=#447700>!<a name='1703'></font>
<font color=#447700>!*      1.PRELIMINARIES<a name='1704'></font>
<font color=#447700>!         -------------<a name='1705'></font>
<font color=#447700>!<a name='1706'></font>
<font color=#447700>!<a name='1707'></font>
<a name='1708'>
<font color=#447700>!<a name='1709'></font>
PFLXZTHMF = 0.<a name='1710'>
PFLXZRMF = 0.<a name='1711'>
PFLXZTHVMF = 0.<a name='1712'>
PFLXZUMF = 0.<a name='1713'>
PFLXZVMF = 0.<a name='1714'>
PTHLDT = 0.<a name='1715'>
PRTDT = 0.<a name='1716'>
PUDT = 0.<a name='1717'>
PVDT = 0.<a name='1718'>
<a name='1719'>
<font color=#447700>!<a name='1720'></font>
<font color=#447700>!----------------------------------------------------------------------------<a name='1721'></font>
<font color=#447700>!<a name='1722'></font>
<font color=#447700>!*      2. COMPUTE THE MEAN FLUX OF CONSERVATIVE VARIABLES at time t-dt<a name='1723'></font>
<font color=#447700>!          (equation (3) of Soares et al)<a name='1724'></font>
<font color=#447700>!          + THE MEAN FLUX OF THETA_V (buoyancy flux)<a name='1725'></font>
<font color=#447700>!          -----------------------------------------------<a name='1726'></font>
<font color=#447700>!   ( Resulting fluxes are in flux level (w-point) as PEMF and PTHL_UP )<a name='1727'></font>
<font color=#447700>!<a name='1728'></font>
<a name='1729'>
PFLXZTHMF(:,:,:) = PEMF(:,:,:)*(PTHL_UP(:,:,:)-MZM(PTHLM(:,:,:)))<a name='1730'>
<a name='1731'>
PFLXZRMF(:,:,:) =  PEMF(:,:,:)*(PRT_UP(:,:,:)-MZM(PRTM(:,:,:)))<a name='1732'>
<a name='1733'>
PFLXZTHVMF(:,:,:) = PEMF(:,:,:)*(PTHV_UP(:,:,:)-MZM(PTHVM(:,:,:)))<a name='1734'>
<a name='1735'>
PFLXZTHVMF(:,:,:) = 9.81/PTHVM(:,:,:)* PEMF(:,:,:)*(PTHV_UP(:,:,:)-MZM(PTHVM(:,:,:))) <font color=#447700>!JP<a name='1736'></font>
<a name='1737'>
IF (OMIXUV) THEN<a name='1738'>
  PFLXZUMF(:,:,:) =  PEMF(:,:,:)*(PU_UP(:,:,:)-MZM(PUM(:,:,:)))<a name='1739'>
  PFLXZVMF(:,:,:) =  PEMF(:,:,:)*(PV_UP(:,:,:)-MZM(PVM(:,:,:)))<a name='1740'>
ENDIF<a name='1741'>
<font color=#447700>!<a name='1742'></font>
<font color=#447700>!<a name='1743'></font>
<font color=#447700>!----------------------------------------------------------------------------<a name='1744'></font>
<font color=#447700>!<a name='1745'></font>
<font color=#447700>!*      3. COMPUTE TENDENCIES OF CONSERVATIVE VARIABLES (or treated as such...)<a name='1746'></font>
<font color=#447700>!          (implicit formulation)<a name='1747'></font>
<font color=#447700>!          --------------------------------------------<a name='1748'></font>
<font color=#447700>!<a name='1749'></font>
<a name='1750'>
<font color=#447700>!<a name='1751'></font>
<font color=#447700>!<a name='1752'></font>
<font color=#447700>! 3.1 Compute the tendency for the conservative potential temperature<a name='1753'></font>
<font color=#447700>!     (PDZZ and flux in w-point and PRHODJ is mass point, result in mass point)<a name='1754'></font>
<font color=#447700>!<a name='1755'></font>
CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TRIDIAG_MASSFLUX'>TRIDIAG_MASSFLUX</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MF_TURB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_MASSFLUX_1">(PTHLM,PFLXZTHMF,-PEMF,PTSTEP_MET,PIMPL,  &amp;<a name='1756'>
                      PDZZ,PRHODJ,ZVARS )<a name='1757'>
<font color=#447700>! compute new flux<a name='1758'></font>
PFLXZTHMF(:,:,:) = PEMF(:,:,:)*(PTHL_UP(:,:,:)-MZM(ZVARS(:,:,:)))<a name='1759'>
<a name='1760'>
<font color=#447700>!!! compute THL tendency<a name='1761'></font>
<font color=#447700>!<a name='1762'></font>
PTHLDT(:,:,:)= (ZVARS(:,:,:)-PTHLM(:,:,:))/PTSTEP_MET<a name='1763'>
<a name='1764'>
<font color=#447700>!<a name='1765'></font>
<font color=#447700>! 3.2 Compute the tendency for the conservative mixing ratio<a name='1766'></font>
<font color=#447700>!<a name='1767'></font>
CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TRIDIAG_MASSFLUX'>TRIDIAG_MASSFLUX</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MF_TURB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_MASSFLUX_2">(PRTM(:,:,:),PFLXZRMF,-PEMF,PTSTEP_MET,PIMPL,  &amp;<a name='1768'>
                                 PDZZ,PRHODJ,ZVARS )<a name='1769'>
<font color=#447700>! compute new flux<a name='1770'></font>
PFLXZRMF(:,:,:) =  PEMF(:,:,:)*(PRT_UP(:,:,:)-MZM(ZVARS(:,:,:)))<a name='1771'>
<a name='1772'>
<font color=#447700>!!! compute RT tendency<a name='1773'></font>
PRTDT(:,:,:) = (ZVARS(:,:,:)-PRTM(:,:,:))/PTSTEP_MET<a name='1774'>
<font color=#447700>!<a name='1775'></font>
<font color=#447700>! 3.3 Compute the tendency for the (non conservative but treated as it)  mixing ratio<a name='1776'></font>
<font color=#447700>!<a name='1777'></font>
<font color=#447700>!CALL TRIDIAG_MASSFLUX(PTHVM(:,:,:),PFLXZTHVMF,-PEMF,PTSTEP,PIMPL,  &amp;<a name='1778'></font>
<font color=#447700>!                                PDZZ,PRHODJ,ZVARS )<a name='1779'></font>
<font color=#447700>! compute new flux<a name='1780'></font>
<font color=#447700>!PFLXZTHVMF(:,:,:) =  PEMF(:,:,:)*(PTHV_UP(:,:,:)-MZM(ZVARS(:,:,:)))<a name='1781'></font>
<a name='1782'>
<a name='1783'>
<a name='1784'>
IF (OMIXUV) THEN<a name='1785'>
<font color=#447700>!<a name='1786'></font>
<font color=#447700>! 3.3 Compute the tendency for the (non conservative but treated as it) zonal momentum<a name='1787'></font>
<font color=#447700>!     (PDZZ and flux in w-point and PRHODJ is mass point, result in mass point)<a name='1788'></font>
<font color=#447700>!<a name='1789'></font>
<a name='1790'>
 CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TRIDIAG_MASSFLUX'>TRIDIAG_MASSFLUX</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MF_TURB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_MASSFLUX_3">(PUM,PFLXZUMF,-PEMF,PTSTEP,PIMPL,  &amp;<a name='1791'>
                                 PDZZ,PRHODJ,ZVARS )<a name='1792'>
<font color=#447700>! compute new flux<a name='1793'></font>
PFLXZUMF(:,:,:) = PEMF(:,:,:)*(PU_UP(:,:,:)-MZM(ZVARS(:,:,:)))<a name='1794'>
<a name='1795'>
<font color=#447700>! compute U tendency<a name='1796'></font>
  PUDT(:,:,:)= (ZVARS(:,:,:)-PUM(:,:,:))/PTSTEP_MET<a name='1797'>
<a name='1798'>
<font color=#447700>!<a name='1799'></font>
<font color=#447700>!<a name='1800'></font>
<font color=#447700>! 3.4 Compute the tendency for the (non conservative but treated as it for the time beiing) <a name='1801'></font>
<font color=#447700>!                                  meridian momentum<a name='1802'></font>
<font color=#447700>!     (PDZZ and flux in w-point and PRHODJ is mass point, result in mass point)<a name='1803'></font>
<font color=#447700>!<a name='1804'></font>
  CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TRIDIAG_MASSFLUX'>TRIDIAG_MASSFLUX</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MF_TURB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_MASSFLUX_4">(PVM,PFLXZVMF,-PEMF,PTSTEP,PIMPL,  &amp;<a name='1805'>
                                 PDZZ,PRHODJ,ZVARS )<a name='1806'>
<font color=#447700>! compute new flux<a name='1807'></font>
PFLXZVMF(:,:,:) = PEMF(:,:,:)*(PV_UP(:,:,:)-MZM(ZVARS(:,:,:)))<a name='1808'>
<a name='1809'>
<font color=#447700>! compute V tendency<a name='1810'></font>
  PVDT(:,:,:)= (ZVARS(:,:,:)-PVM(:,:,:))/PTSTEP_MET<a name='1811'>
<a name='1812'>
ENDIF<a name='1813'>
<a name='1814'>
<a name='1815'>
<a name='1816'>
<font color=#447700>!<a name='1817'></font>
END SUBROUTINE MF_TURB   <a name='1818'>
<a name='1819'>
<A NAME='MZM'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MZM' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1820'>
<font color=#993300>FUNCTION </font><font color=#cc0000>MZM</font>(PA)  RESULT(PMZM) <A href='../../call_to/MZM.html' TARGET='index'>1</A><a name='1821'>
<a name='1822'>
<a name='1823'>
<font color=#447700>!<a name='1824'></font>
IMPLICIT NONE<a name='1825'>
<font color=#447700>!<a name='1826'></font>
<font color=#447700>!*       0.1   Declarations of argument and result<a name='1827'></font>
<font color=#447700>!              ------------------------------------<a name='1828'></font>
<font color=#447700>!<a name='1829'></font>
<a name='1830'>
REAL, DIMENSION(:,:,:), INTENT(IN)                :: PA     <font color=#447700>! variable at mass localization<a name='1831'></font>
REAL, DIMENSION(SIZE(PA,1),SIZE(PA,2),SIZE(PA,3)) :: PMZM   <font color=#447700>! result at flux localization<a name='1832'></font>
<a name='1833'>
<font color=#447700>!        0.2   Declarations of local variables<a name='1834'></font>
<font color=#447700>!              -------------------------------<a name='1835'></font>
<font color=#447700>!<a name='1836'></font>
<a name='1837'>
INTEGER :: JK             <font color=#447700>! Loop index in z direction<a name='1838'></font>
INTEGER :: IKU            <font color=#447700>! upper bound in z direction of PA<a name='1839'></font>
<font color=#447700>!<a name='1840'></font>
IKU = SIZE(PA,3)<a name='1841'>
<a name='1842'>
<font color=#447700>!DO JK=2,IKU MODIF WRF JP<a name='1843'></font>
DO JK=2,IKU<a name='1844'>
   PMZM(:,:,JK)=0.5*(PA(:,:,JK)+PA(:,:,JK-1))<a name='1845'>
ENDDO<a name='1846'>
<a name='1847'>
PMZM(:,:,1)=PA(:,:,2)<a name='1848'>
<a name='1849'>
<a name='1850'>
END FUNCTION MZM<a name='1851'>
<a name='1852'>
<a name='1853'>
<font color=#447700>!<a name='1854'></font>
<font color=#447700>!<a name='1855'></font>
<font color=#447700>!     #################################################################<a name='1856'></font>
<A NAME='TH_R_FROM_THL_RT_1D'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_1D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1857'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TH_R_FROM_THL_RT_1D</font>(HFRAC_ICE,PFRAC_ICE,PP,             &amp; <A href='../../call_to/TH_R_FROM_THL_RT_1D.html' TARGET='index'>5</A>,<A href='../../call_from/TH_R_FROM_THL_RT_1D.html' TARGET='index'>3</A><a name='1858'>
                                  PTHL, PRT, PTH, PRV, PRL, PRI       )<a name='1859'>
<font color=#447700>!     #################################################################<a name='1860'></font>
<font color=#447700>!<a name='1861'></font>
<font color=#447700>!<a name='1862'></font>
<font color=#447700>!!****  *TH_R_FROM_THL_RT_1D* - computes the non-conservative variables<a name='1863'></font>
<font color=#447700>!!                          from conservative variables<a name='1864'></font>
<font color=#447700>!!<a name='1865'></font>
<a name='1866'>
<font color=#447700>!!<a name='1867'></font>
<font color=#447700>!! --------------------------------------------------------------------------<a name='1868'></font>
<font color=#447700>!       <a name='1869'></font>
<a name='1870'>
<font color=#447700>!<a name='1871'></font>
IMPLICIT NONE<a name='1872'>
<font color=#447700>!<a name='1873'></font>
<font color=#447700>!<a name='1874'></font>
<font color=#447700>!*      0.1  declarations of arguments<a name='1875'></font>
<font color=#447700>!<a name='1876'></font>
CHARACTER*1           , INTENT(IN) :: HFRAC_ICE<a name='1877'>
REAL, DIMENSION(:), INTENT(INOUT) :: PFRAC_ICE<a name='1878'>
REAL, DIMENSION(:), INTENT(IN) :: PP          <font color=#447700>! Pressure<a name='1879'></font>
REAL, DIMENSION(:), INTENT(IN) :: PTHL    <font color=#447700>! thetal (or thetal tendency) to<a name='1880'></font>
                                             <font color=#447700>! transform into th (or tendency)<a name='1881'></font>
REAL, DIMENSION(:),INTENT(IN)  :: PRT    <font color=#447700>! Total mixing ratios (or tendency) to<a name='1882'></font>
                                             <font color=#447700>! transform into rv,rc and ri<a name='1883'></font>
                                             <font color=#447700>! (or its tendency)<a name='1884'></font>
REAL, DIMENSION(:), INTENT(OUT):: PTH    <font color=#447700>! th (or th_l tendency)<a name='1885'></font>
REAL, DIMENSION(:), INTENT(OUT):: PRV    <font color=#447700>! vapor mixing ratio (or its tendency)<a name='1886'></font>
REAL, DIMENSION(:), INTENT(OUT):: PRL    <font color=#447700>! vapor mixing ratio (or its tendency)<a name='1887'></font>
REAL, DIMENSION(:), INTENT(OUT):: PRI    <font color=#447700>! vapor mixing ratio (or its tendency)<a name='1888'></font>
<a name='1889'>
<font color=#447700>!<a name='1890'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1891'></font>
<font color=#447700>!<a name='1892'></font>
<font color=#447700>!       0.2  declaration of local variables<a name='1893'></font>
<font color=#447700>!<a name='1894'></font>
INTEGER                       :: II<a name='1895'>
<font color=#447700>! Loop control<a name='1896'></font>
REAL                          :: ZCOEF<a name='1897'>
REAL, DIMENSION(SIZE(PP,1))   :: ZEXN,ZFOES,ZQVSAT<a name='1898'>
REAL, DIMENSION(SIZE(PTHL,1)) :: ZRVSAT,ZCPH,ZRLTEMP  <a name='1899'>
REAL, DIMENSION(SIZE(PTHL,1)) :: ZT,ZLOVCPEXN,ZLOSCPEXN<a name='1900'>
<font color=#447700>!----------------------------------------------------------------------------<a name='1901'></font>
<font color=#447700>!<a name='1902'></font>
<font color=#447700>!*      1 Initialisation <a name='1903'></font>
<font color=#447700>!         --------------<a name='1904'></font>
<font color=#447700>!<a name='1905'></font>
<font color=#447700>!<a name='1906'></font>
ZCOEF = 0.8<a name='1907'>
PRL(:)=0.<a name='1908'>
PRI(:)=0.<a name='1909'>
ZRLTEMP(:)=0.<a name='1910'>
PRV(:)=PRT(:)<a name='1911'>
PTH(:)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PTHL'>PTHL</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PTHL_1">(:)<a name='1912'>
ZEXN(:)=(PP(:)/XP00) ** (XRD/XCPD)<a name='1913'>
<font color=#447700>!<a name='1914'></font>
<font color=#447700>!       2 Iteration<a name='1915'></font>
<font color=#447700>!         ---------<a name='1916'></font>
<a name='1917'>
    DO II=1,20<a name='1918'>
      ZT(:)=PTH(:)*ZEXN(:)<a name='1919'>
<a name='1920'>
      WHERE (ZT(:) &gt; 273.15)<a name='1921'>
<font color=#447700>! warm cloud<a name='1922'></font>
      ZFOES(:) = EXP( XALPW - XBETAW/ZT(:) - XGAMW*LOG(ZT(:))  )<a name='1923'>
      ZQVSAT(:) = XRD/XRV*ZFOES(:)/PP(:)   &amp;<a name='1924'>
                   / (1.+(XRD/XRV-1.)*ZFOES(:)/PP(:))<a name='1925'>
<a name='1926'>
      ZRVSAT(:) = (1-ZCOEF)*ZQVSAT(:)*(1+PRT(:))+(ZCOEF)*PRV(:)<a name='1927'>
<font color=#447700>!      CALL COMPUTE_FRAC_ICE_1D(HFRAC_ICE,PFRAC_ICE,PP,ZT) <a name='1928'></font>
      PFRAC_ICE(:)=0.<a name='1929'>
      ZRLTEMP(:)=MAX(0.,PRV(:)-ZRVSAT(:))<a name='1930'>
      PRV(:)=PRV(:)-ZRLTEMP(:)<a name='1931'>
      PRL(:)=PRL(:)+PRI(:)+ZRLTEMP(:)<a name='1932'>
      PRI(:)    = PFRAC_ICE(:)    * (PRL(:))<a name='1933'>
      PRL(:)    = (1-PFRAC_ICE(:))* (PRT(:) - PRV(:))<a name='1934'>
      <font color=#447700>!       2.1 Cph<a name='1935'></font>
      ZCPH(:)=XCPD+ XCPV * PRV(:)+ XCL * PRL(:) + XCI * PRI(:)<a name='1936'>
      <a name='1937'>
      <font color=#447700>!       2.2 L/Cp/EXN<a name='1938'></font>
      ZLOVCPEXN(:) = (XLVTT + (XCPV-XCL) * (ZT(:)-XTT)) &amp;<a name='1939'>
                        /(ZCPH*ZEXN(:))<a name='1940'>
      ZLOSCPEXN(:) = (XLSTT + (XCPV-XCI) * (ZT(:)-XTT)) &amp;<a name='1941'>
                        /(ZCPH*ZEXN(:))<a name='1942'>
      PTH(:)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PTHL'>PTHL</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PTHL_2">(:)+ZLOVCPEXN*PRL(:)+ZLOSCPEXN(:)*PRI(:)          <a name='1943'>
<a name='1944'>
      ELSEWHERE<a name='1945'>
             <font color=#447700>! cold shallow cloud not yet coded <a name='1946'></font>
             <font color=#447700>! probleme also for the highest level of fire case<a name='1947'></font>
        PRL(:)=0.<a name='1948'>
        PRI(:)=0.<a name='1949'>
        PRV(:)=PRT(:)<a name='1950'>
        PTH(:)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PTHL'>PTHL</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PTHL_3">(:)<a name='1951'>
      ENDWHERE <a name='1952'>
    ENDDO<a name='1953'>
   <a name='1954'>
END SUBROUTINE TH_R_FROM_THL_RT_1D<a name='1955'>
<a name='1956'>
              <a name='1957'>
<font color=#447700>!     #################################################################<a name='1958'></font>
<A NAME='TH_R_FROM_THL_RT_2D'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1959'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TH_R_FROM_THL_RT_2D</font>(HFRAC_ICE,PFRAC_ICE,PP,             &amp; <A href='../../call_to/TH_R_FROM_THL_RT_2D.html' TARGET='index'>2</A>,<A href='../../call_from/TH_R_FROM_THL_RT_2D.html' TARGET='index'>3</A><a name='1960'>
                                  PTHL, PRT, PTH, PRV, PRL, PRI       )<a name='1961'>
<font color=#447700>!     #################################################################<a name='1962'></font>
<font color=#447700>!<a name='1963'></font>
<font color=#447700>!<a name='1964'></font>
<font color=#447700>!!****  *TH_R_FROM_THL_RT_2D* - computes the non-conservative variables<a name='1965'></font>
<font color=#447700>!!                          from conservative variables<a name='1966'></font>
<font color=#447700>!!<a name='1967'></font>
<font color=#447700>!!<a name='1968'></font>
<font color=#447700>!!<a name='1969'></font>
<font color=#447700>!! --------------------------------------------------------------------------<a name='1970'></font>
<a name='1971'>
<a name='1972'>
<font color=#447700>!<a name='1973'></font>
IMPLICIT NONE<a name='1974'>
<font color=#447700>!<a name='1975'></font>
<font color=#447700>!<a name='1976'></font>
<font color=#447700>!*      0.1  declarations of arguments<a name='1977'></font>
<font color=#447700>!<a name='1978'></font>
CHARACTER*1         , INTENT(IN) :: HFRAC_ICE<a name='1979'>
REAL, DIMENSION(:,:), INTENT(INOUT) :: PFRAC_ICE<a name='1980'>
REAL, DIMENSION(:,:), INTENT(IN) :: PP          <font color=#447700>! Pressure<a name='1981'></font>
REAL, DIMENSION(:,:), INTENT(IN) :: PTHL    <font color=#447700>! thetal (or thetal tendency) to<a name='1982'></font>
                                             <font color=#447700>! transform into th (or tendency)<a name='1983'></font>
REAL, DIMENSION(:,:),INTENT(IN)  :: PRT    <font color=#447700>! Total mixing ratios (or tendency) to<a name='1984'></font>
                                             <font color=#447700>! transform into rv,rc and ri<a name='1985'></font>
                                             <font color=#447700>! (or its tendency)<a name='1986'></font>
REAL, DIMENSION(:,:), INTENT(OUT):: PTH    <font color=#447700>! th (or th_l tendency)<a name='1987'></font>
REAL, DIMENSION(:,:), INTENT(OUT):: PRV    <font color=#447700>! vapor mixing ratio (or its tendency)<a name='1988'></font>
REAL, DIMENSION(:,:), INTENT(OUT):: PRL    <font color=#447700>! vapor mixing ratio (or its tendency)<a name='1989'></font>
REAL, DIMENSION(:,:), INTENT(OUT):: PRI    <font color=#447700>! vapor mixing ratio (or its tendency)<a name='1990'></font>
<a name='1991'>
<font color=#447700>!<a name='1992'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1993'></font>
<font color=#447700>!<a name='1994'></font>
<font color=#447700>!       0.2  declaration of local variables<a name='1995'></font>
<font color=#447700>!<a name='1996'></font>
INTEGER                :: II<a name='1997'>
<font color=#447700>! Loop control<a name='1998'></font>
REAL                                         :: ZCOEF<a name='1999'>
REAL, DIMENSION(SIZE(PP,1),SIZE(PP,2))       :: ZEXN,ZFOES,ZQVSAT<a name='2000'>
REAL, DIMENSION(SIZE(PTHL,1),SIZE(PTHL,2))   :: ZRVSAT,ZCPH,ZRLTEMP  <a name='2001'>
REAL, DIMENSION(SIZE(PTHL,1),SIZE(PTHL,2))   :: ZT,ZLOVCPEXN,ZLOSCPEXN<a name='2002'>
<font color=#447700>!----------------------------------------------------------------------------<a name='2003'></font>
<font color=#447700>!<a name='2004'></font>
<font color=#447700>!*      1 Initialisation <a name='2005'></font>
<font color=#447700>!         --------------<a name='2006'></font>
<font color=#447700>!<a name='2007'></font>
<font color=#447700>!<a name='2008'></font>
ZCOEF = 0.8<a name='2009'>
PRL(:,:)=0.<a name='2010'>
PRI(:,:)=0.<a name='2011'>
ZRLTEMP(:,:)=0.<a name='2012'>
PRV(:,:)=PRT(:,:)<a name='2013'>
PTH(:,:)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PTHL'>PTHL</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PTHL_4">(:,:)<a name='2014'>
ZEXN(:,:)=(PP(:,:)/XP00) ** (XRD/XCPD)<a name='2015'>
<font color=#447700>!<a name='2016'></font>
<font color=#447700>!       2 Iteration<a name='2017'></font>
<font color=#447700>!         ---------<a name='2018'></font>
<a name='2019'>
    DO II=1,20<a name='2020'>
      ZT(:,:)=PTH(:,:)*ZEXN(:,:)<a name='2021'>
      WHERE (ZT(:,:) &gt; 273.15)<a name='2022'>
<font color=#447700>! warm cloud<a name='2023'></font>
<a name='2024'>
      ZFOES(:,:) = EXP( XALPW - XBETAW/ZT(:,:) - XGAMW*LOG(ZT(:,:))  )<a name='2025'>
      ZQVSAT(:,:) = XRD/XRV*ZFOES(:,:)/PP(:,:)   &amp;<a name='2026'>
                   / (1.+(XRD/XRV-1.)*ZFOES(:,:)/PP(:,:))<a name='2027'>
      ZRVSAT(:,:) = (1-ZCOEF)*ZQVSAT(:,:)*(1+PRT(:,:))+(ZCOEF)*PRV(:,:)<a name='2028'>
<a name='2029'>
<font color=#447700>!      CALL COMPUTE_FRAC_ICE_2D(HFRAC_ICE,PFRAC_ICE,PP,ZT) <a name='2030'></font>
      PFRAC_ICE(:,:) = 0.<a name='2031'>
      ZRLTEMP(:,:)=MAX(0.,PRV(:,:)-ZRVSAT(:,:))<a name='2032'>
      PRV(:,:)=PRV(:,:)-ZRLTEMP(:,:)<a name='2033'>
      PRL(:,:)=PRL(:,:)+PRI(:,:)+ZRLTEMP(:,:)<a name='2034'>
      PRI(:,:)    = PFRAC_ICE(:,:)    * (PRL(:,:))<a name='2035'>
      PRL(:,:)    = (1-PFRAC_ICE(:,:))* (PRT(:,:) - PRV(:,:))<a name='2036'>
      <font color=#447700>!       2.1 Cph<a name='2037'></font>
        ZCPH(:,:)=XCPD+ XCPV * PRV(:,:)+ XCL * PRL(:,:) + XCI * PRI(:,:)<a name='2038'>
      <a name='2039'>
        <font color=#447700>!       2.2 L/Cp/EXN<a name='2040'></font>
        ZLOVCPEXN(:,:) = (XLVTT + (XCPV-XCL) * (ZT(:,:)-XTT)) &amp;<a name='2041'>
                        /(ZCPH*ZEXN(:,:))<a name='2042'>
        ZLOSCPEXN(:,:) = (XLSTT + (XCPV-XCI) * (ZT(:,:)-XTT)) &amp;<a name='2043'>
                        /(ZCPH*ZEXN(:,:))<a name='2044'>
        PTH(:,:)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PTHL'>PTHL</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PTHL_5">(:,:)+ZLOVCPEXN*PRL(:,:)+ZLOSCPEXN(:,:)*PRI(:,:)          <a name='2045'>
      ELSEWHERE<a name='2046'>
        <font color=#447700>! cold shallow cloud not yet coded <a name='2047'></font>
        <font color=#447700>! probleme also for the highest level of fire case<a name='2048'></font>
        PRL(:,:)=0.<a name='2049'>
        PRI(:,:)=0.<a name='2050'>
        PRV(:,:)=PRT(:,:)<a name='2051'>
        PTH(:,:)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PTHL'>PTHL</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TH_R_FROM_THL_RT_2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PTHL_6">(:,:)<a name='2052'>
       ENDWHERE   <a name='2053'>
    ENDDO<a name='2054'>
   <a name='2055'>
END SUBROUTINE TH_R_FROM_THL_RT_2D<a name='2056'>
<a name='2057'>
<a name='2058'>
                                       <a name='2059'>
<font color=#447700>!     #################################################################<a name='2060'></font>
<A NAME='THL_RT_FROM_TH_R_MF'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#THL_RT_FROM_TH_R_MF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2061'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>THL_RT_FROM_TH_R_MF</font>( KRR,KRRL,KRRI,                  &amp; <A href='../../call_to/THL_RT_FROM_TH_R_MF.html' TARGET='index'>1</A><a name='2062'>
                                       PTH, PR, PLVOCPEXN, PLSOCPEXN, &amp;<a name='2063'>
                                       PTHL, PRT                      )<a name='2064'>
<font color=#447700>!     #################################################################<a name='2065'></font>
<font color=#447700>!<a name='2066'></font>
<font color=#447700>!!<a name='2067'></font>
<font color=#447700>!!****  *THL_RT_FROM_TH_R* - computes the conservative variables THL and RT<a name='2068'></font>
<font color=#447700>!!                           from TH and the non precipitating water species<a name='2069'></font>
<font color=#447700>!!<a name='2070'></font>
<font color=#447700>!! --------------------------------------------------------------------------<a name='2071'></font>
<font color=#447700>!       <a name='2072'></font>
<font color=#447700>!*      0. DECLARATIONS<a name='2073'></font>
<font color=#447700>!          ------------<a name='2074'></font>
<font color=#447700>!<a name='2075'></font>
<font color=#447700>!USE MODD_CST<a name='2076'></font>
<font color=#447700>!<a name='2077'></font>
IMPLICIT NONE<a name='2078'>
<font color=#447700>!<a name='2079'></font>
<font color=#447700>!<a name='2080'></font>
<font color=#447700>!*      0.1  declarations of arguments<a name='2081'></font>
<font color=#447700>!<a name='2082'></font>
INTEGER,                INTENT(IN)   :: KRR           <font color=#447700>! number of moist var.<a name='2083'></font>
INTEGER,                INTENT(IN)   :: KRRL          <font color=#447700>! number of liquid water var.<a name='2084'></font>
INTEGER,                INTENT(IN)   :: KRRI          <font color=#447700>! number of ice water var.<a name='2085'></font>
<a name='2086'>
REAL, DIMENSION(:,:,:), INTENT(IN)   :: PTH      <font color=#447700>! theta<a name='2087'></font>
REAL, DIMENSION(:,:,:,:), INTENT(IN) :: PR       <font color=#447700>! water species<a name='2088'></font>
REAL, DIMENSION(:,:,:), INTENT(IN)   :: PLVOCPEXN, PLSOCPEXN      <font color=#447700>! L/(cp*Pi)<a name='2089'></font>
<a name='2090'>
REAL, DIMENSION(:,:,:), INTENT(OUT)  :: PTHL     <font color=#447700>! th_l<a name='2091'></font>
REAL, DIMENSION(:,:,:), INTENT(OUT)  :: PRT      <font color=#447700>! total non precip. water<a name='2092'></font>
<font color=#447700>!<a name='2093'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2094'></font>
<font color=#447700>!<a name='2095'></font>
<font color=#447700>!       0.2  declaration of local variables<a name='2096'></font>
<font color=#447700>!<a name='2097'></font>
<a name='2098'>
<font color=#447700>!----------------------------------------------------------------------------<a name='2099'></font>
<a name='2100'>
<font color=#447700>!----------------------------------------------------------------------------<a name='2101'></font>
<font color=#447700>!<a name='2102'></font>
<font color=#447700>!<a name='2103'></font>
<a name='2104'>
IF ( KRRL &gt;= 1 ) THEN<a name='2105'>
  IF ( KRRI &gt;= 1 ) THEN <a name='2106'>
    <font color=#447700>! Rnp <a name='2107'></font>
    PRT(:,:,:)  = PR(:,:,:,1)  + PR(:,:,:,2)  + PR(:,:,:,4)<a name='2108'>
    <font color=#447700>! Theta_l <a name='2109'></font>
    PTHL(:,:,:)  = PTH(:,:,:)  - PLVOCPEXN(:,:,:) * PR(:,:,:,2) &amp;<a name='2110'>
                               - PLSOCPEXN(:,:,:) * PR(:,:,:,4)<a name='2111'>
  ELSE<a name='2112'>
    <font color=#447700>! Rnp<a name='2113'></font>
    PRT(:,:,:)  = PR(:,:,:,1)  + PR(:,:,:,2) <a name='2114'>
    <font color=#447700>! Theta_l<a name='2115'></font>
    PTHL(:,:,:) = PTH(:,:,:)  - PLVOCPEXN(:,:,:) * PR(:,:,:,2)<a name='2116'>
  END IF<a name='2117'>
ELSE<a name='2118'>
    <font color=#447700>! Rnp = rv<a name='2119'></font>
PRT(:,:,:)  = PR(:,:,:,1)<a name='2120'>
    <font color=#447700>! Theta_l = Theta<a name='2121'></font>
PTHL(:,:,:) = PTH(:,:,:)<a name='2122'>
END IF<a name='2123'>
<a name='2124'>
END SUBROUTINE THL_RT_FROM_TH_R_MF<a name='2125'>
<a name='2126'>
<a name='2127'>
<font color=#447700>!      #################################################<a name='2128'></font>
<A NAME='TRIDIAG_MASSFLUX'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TRIDIAG_MASSFLUX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2129'>
       <font color=#993300>SUBROUTINE </font><font color=#cc0000>TRIDIAG_MASSFLUX</font>(PVARM,PF,PDFDT,PTSTEP,PIMPL,  &amp; <A href='../../call_to/TRIDIAG_MASSFLUX.html' TARGET='index'>4</A>,<A href='../../call_from/TRIDIAG_MASSFLUX.html' TARGET='index'>1</A><a name='2130'>
                                 PDZZ,PRHODJ,PVARP             )<a name='2131'>
<font color=#447700>!      #################################################<a name='2132'></font>
<font color=#447700>!<a name='2133'></font>
<font color=#447700>!<a name='2134'></font>
<font color=#447700>!!****   *TRIDIAG_MASSFLUX* - routine to solve a time implicit scheme<a name='2135'></font>
<font color=#447700>!!<a name='2136'></font>
<font color=#447700>!!<a name='2137'></font>
<font color=#447700>!! ---------------------------------------------------------------------<a name='2138'></font>
<font color=#447700>!<a name='2139'></font>
<font color=#447700>!*       0. DECLARATIONS<a name='2140'></font>
<font color=#447700>!<a name='2141'></font>
<font color=#447700>!<a name='2142'></font>
<font color=#447700>!<a name='2143'></font>
IMPLICIT NONE<a name='2144'>
<font color=#447700>!<a name='2145'></font>
<font color=#447700>!<a name='2146'></font>
<font color=#447700>!*       0.1 declarations of arguments<a name='2147'></font>
<font color=#447700>!<a name='2148'></font>
REAL, DIMENSION(:,:,:), INTENT(IN) :: PVARM   <font color=#447700>! variable at t-1      at mass point<a name='2149'></font>
REAL, DIMENSION(:,:,:), INTENT(IN) :: PF      <font color=#447700>! flux in dT/dt=-dF/dz at flux point<a name='2150'></font>
REAL, DIMENSION(:,:,:), INTENT(IN) :: PDFDT   <font color=#447700>! dF/dT                at flux point<a name='2151'></font>
REAL,                   INTENT(IN) :: PTSTEP  <font color=#447700>! Double time step<a name='2152'></font>
REAL,                   INTENT(IN) :: PIMPL   <font color=#447700>! implicit weight<a name='2153'></font>
REAL, DIMENSION(:,:,:), INTENT(IN) :: PDZZ    <font color=#447700>! Dz                   at flux point<a name='2154'></font>
REAL, DIMENSION(:,:,:), INTENT(IN) :: PRHODJ  <font color=#447700>! (dry rho)*J          at mass point<a name='2155'></font>
<font color=#447700>!<a name='2156'></font>
REAL, DIMENSION(:,:,:), INTENT(OUT):: PVARP   <font color=#447700>! variable at t+1      at mass point<a name='2157'></font>
<font color=#447700>!<a name='2158'></font>
<font color=#447700>!<a name='2159'></font>
<font color=#447700>!*       0.2 declarations of local variables<a name='2160'></font>
<font color=#447700>!<a name='2161'></font>
REAL, DIMENSION(SIZE(PVARM,1),SIZE(PVARM,2),SIZE(PVARM,3))  :: ZRHODJ_DFDT_O_DZ<a name='2162'>
REAL, DIMENSION(SIZE(PVARM,1),SIZE(PVARM,2),SIZE(PVARM,3))  :: ZMZM_RHODJ<a name='2163'>
REAL, DIMENSION(SIZE(PVARM,1),SIZE(PVARM,2),SIZE(PVARM,3))  :: ZA, ZB, ZC<a name='2164'>
REAL, DIMENSION(SIZE(PVARM,1),SIZE(PVARM,2),SIZE(PVARM,3))  :: ZY ,ZGAM <a name='2165'>
                                         <font color=#447700>! RHS of the equation, 3D work array<a name='2166'></font>
REAL, DIMENSION(SIZE(PVARM,1),SIZE(PVARM,2))                :: ZBET<a name='2167'>
                                         <font color=#447700>! 2D work array<a name='2168'></font>
INTEGER                              :: JK            <font color=#447700>! loop counter<a name='2169'></font>
INTEGER                              :: IKB,IKE       <font color=#447700>! inner vertical limits<a name='2170'></font>
<font color=#447700>!<a name='2171'></font>
<font color=#447700>! ---------------------------------------------------------------------------<a name='2172'></font>
<font color=#447700>!                                              <a name='2173'></font>
<font color=#447700>!*      1.  Preliminaries<a name='2174'></font>
<font color=#447700>!           -------------<a name='2175'></font>
<font color=#447700>!<a name='2176'></font>
IKB=1<a name='2177'>
IKE=SIZE(PVARM,3)-1 <a name='2178'>
<font color=#447700>!<a name='2179'></font>
ZMZM_RHODJ  = <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MZM'>MZM</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#TRIDIAG_MASSFLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MZM_1">(PRHODJ)<a name='2180'>
ZRHODJ_DFDT_O_DZ = ZMZM_RHODJ*PDFDT/PDZZ<a name='2181'>
<font color=#447700>!<a name='2182'></font>
ZA=0.<a name='2183'>
ZB=0.<a name='2184'>
ZC=0.<a name='2185'>
ZY=0.<a name='2186'>
<font color=#447700>!<a name='2187'></font>
<font color=#447700>!<a name='2188'></font>
<font color=#447700>!*      2.  COMPUTE THE RIGHT HAND SIDE<a name='2189'></font>
<font color=#447700>!           ---------------------------<a name='2190'></font>
<font color=#447700>!<a name='2191'></font>
ZY(:,:,IKB) = PRHODJ(:,:,IKB)*PVARM(:,:,IKB)/PTSTEP             &amp;<a name='2192'>
    - ZMZM_RHODJ(:,:,IKB+1) * PF(:,:,IKB+1)/PDZZ(:,:,IKB+1)     &amp;<a name='2193'>
    + ZMZM_RHODJ(:,:,IKB  ) * PF(:,:,IKB  )/PDZZ(:,:,IKB  )     &amp;<a name='2194'>
    + ZRHODJ_DFDT_O_DZ(:,:,IKB+1) * 0.5*PIMPL * PVARM(:,:,IKB+1)    &amp;<a name='2195'>
    + ZRHODJ_DFDT_O_DZ(:,:,IKB+1) * 0.5*PIMPL * PVARM(:,:,IKB  )<a name='2196'>
<font color=#447700>!<a name='2197'></font>
DO JK=IKB+1,IKE-1<a name='2198'>
  ZY(:,:,JK) = PRHODJ(:,:,JK)*PVARM(:,:,JK)/PTSTEP          &amp;<a name='2199'>
    - ZMZM_RHODJ(:,:,JK+1) * PF(:,:,JK+1)/PDZZ(:,:,JK+1)    &amp;<a name='2200'>
    + ZMZM_RHODJ(:,:,JK  ) * PF(:,:,JK  )/PDZZ(:,:,JK  )    &amp;<a name='2201'>
    + ZRHODJ_DFDT_O_DZ(:,:,JK+1) * 0.5*PIMPL * PVARM(:,:,JK+1)  &amp;<a name='2202'>
    + ZRHODJ_DFDT_O_DZ(:,:,JK+1) * 0.5*PIMPL * PVARM(:,:,JK  )  &amp;<a name='2203'>
    - ZRHODJ_DFDT_O_DZ(:,:,JK  ) * 0.5*PIMPL * PVARM(:,:,JK  )  &amp;<a name='2204'>
    - ZRHODJ_DFDT_O_DZ(:,:,JK  ) * 0.5*PIMPL * PVARM(:,:,JK-1)<a name='2205'>
END DO<a name='2206'>
<font color=#447700>! <a name='2207'></font>
ZY(:,:,IKE) = PRHODJ(:,:,IKE)*PVARM(:,:,IKE)/PTSTEP         &amp;<a name='2208'>
    - ZMZM_RHODJ(:,:,IKE+1) * PF(:,:,IKE+1)/PDZZ(:,:,IKE+1) &amp;<a name='2209'>
    + ZMZM_RHODJ(:,:,IKE  ) * PF(:,:,IKE  )/PDZZ(:,:,IKE  ) &amp;<a name='2210'>
    - ZRHODJ_DFDT_O_DZ(:,:,IKE ) * 0.5*PIMPL * PVARM(:,:,IKE  ) &amp;<a name='2211'>
    - ZRHODJ_DFDT_O_DZ(:,:,IKE ) * 0.5*PIMPL * PVARM(:,:,IKE-1)<a name='2212'>
<font color=#447700>!<a name='2213'></font>
<font color=#447700>!<a name='2214'></font>
<font color=#447700>!*       3.  INVERSION OF THE TRIDIAGONAL SYSTEM<a name='2215'></font>
<font color=#447700>!            -----------------------------------<a name='2216'></font>
<font color=#447700>!<a name='2217'></font>
IF ( PIMPL &gt; 1.E-10 ) THEN<a name='2218'>
<font color=#447700>!<a name='2219'></font>
<font color=#447700>!*       3.1 arrays A, B, C<a name='2220'></font>
<font color=#447700>!            --------------<a name='2221'></font>
<font color=#447700>!<a name='2222'></font>
  ZB(:,:,IKB) =   PRHODJ(:,:,IKB)/PTSTEP                   &amp;<a name='2223'>
                + ZRHODJ_DFDT_O_DZ(:,:,IKB+1) * 0.5*PIMPL<a name='2224'>
  ZC(:,:,IKB) =   ZRHODJ_DFDT_O_DZ(:,:,IKB+1) * 0.5*PIMPL<a name='2225'>
<a name='2226'>
  DO JK=IKB+1,IKE-1<a name='2227'>
    ZA(:,:,JK) = - ZRHODJ_DFDT_O_DZ(:,:,JK  ) * 0.5*PIMPL<a name='2228'>
    ZB(:,:,JK) =   PRHODJ(:,:,JK)/PTSTEP                   &amp;<a name='2229'>
                 + ZRHODJ_DFDT_O_DZ(:,:,JK+1) * 0.5*PIMPL &amp;<a name='2230'>
                 - ZRHODJ_DFDT_O_DZ(:,:,JK  ) * 0.5*PIMPL<a name='2231'>
    ZC(:,:,JK) =   ZRHODJ_DFDT_O_DZ(:,:,JK+1) * 0.5*PIMPL<a name='2232'>
  END DO<a name='2233'>
<a name='2234'>
  ZA(:,:,IKE) = - ZRHODJ_DFDT_O_DZ(:,:,IKE  ) * 0.5*PIMPL<a name='2235'>
  ZB(:,:,IKE) =   PRHODJ(:,:,IKE)/PTSTEP                   &amp;<a name='2236'>
                - ZRHODJ_DFDT_O_DZ(:,:,IKE  ) * 0.5*PIMPL<a name='2237'>
<font color=#447700>!<a name='2238'></font>
<font color=#447700>!*       3.2 going up<a name='2239'></font>
<font color=#447700>!            --------<a name='2240'></font>
<font color=#447700>!<a name='2241'></font>
  ZBET(:,:) = ZB(:,:,IKB)  <font color=#447700>! bet = b(ikb)<a name='2242'></font>
  PVARP(:,:,IKB) = ZY(:,:,IKB) / ZBET(:,:)<a name='2243'>
<a name='2244'>
  <font color=#447700>!<a name='2245'></font>
  DO JK = IKB+1,IKE-1<a name='2246'>
    ZGAM(:,:,JK) = ZC(:,:,JK-1) / ZBET(:,:)  <a name='2247'>
                                                    <font color=#447700>! gam(k) = c(k-1) / bet<a name='2248'></font>
    ZBET(:,:)    = ZB(:,:,JK) - ZA(:,:,JK) * ZGAM(:,:,JK)<a name='2249'>
                                                    <font color=#447700>! bet = b(k) - a(k)* gam(k)  <a name='2250'></font>
    PVARP(:,:,JK)= ( ZY(:,:,JK) - ZA(:,:,JK) * PVARP(:,:,JK-1) ) / ZBET(:,:)<a name='2251'>
                                        <font color=#447700>! res(k) = (y(k) -a(k)*res(k-1))/ bet <a name='2252'></font>
  END DO <a name='2253'>
  <font color=#447700>! special treatment for the last level<a name='2254'></font>
  ZGAM(:,:,IKE) = ZC(:,:,IKE-1) / ZBET(:,:) <a name='2255'>
                                                    <font color=#447700>! gam(k) = c(k-1) / bet<a name='2256'></font>
  ZBET(:,:)     = ZB(:,:,IKE) - ZA(:,:,IKE) * ZGAM(:,:,IKE)<a name='2257'>
                                                    <font color=#447700>! bet = b(k) - a(k)* gam(k)  <a name='2258'></font>
  PVARP(:,:,IKE)= ( ZY(:,:,IKE) - ZA(:,:,IKE) * PVARP(:,:,IKE-1) ) / ZBET(:,:)<a name='2259'>
                                       <font color=#447700>! res(k) = (y(k) -a(k)*res(k-1))/ bet <a name='2260'></font>
<font color=#447700>!<a name='2261'></font>
<font color=#447700>!*       3.3 going down<a name='2262'></font>
<font color=#447700>!            ----------<a name='2263'></font>
<font color=#447700>!<a name='2264'></font>
  DO JK = IKE-1,IKB,-1<a name='2265'>
    PVARP(:,:,JK) = PVARP(:,:,JK) - ZGAM(:,:,JK+1) * PVARP(:,:,JK+1)<a name='2266'>
  END DO<a name='2267'>
<font color=#447700>!<a name='2268'></font>
<font color=#447700>!<a name='2269'></font>
ELSE<a name='2270'>
<font color=#447700>!!! EXPLICIT FORMULATION<a name='2271'></font>
<font color=#447700>! <a name='2272'></font>
  PVARP(:,:,IKB:IKE) = ZY(:,:,IKB:IKE) * PTSTEP / PRHODJ(:,:,IKB:IKE)<a name='2273'>
<font color=#447700>!<a name='2274'></font>
END IF <a name='2275'>
<font color=#447700>!<a name='2276'></font>
<font color=#447700>!<a name='2277'></font>
<font color=#447700>!*       4.  FILL THE UPPER AND LOWER EXTERNAL VALUES<a name='2278'></font>
<font color=#447700>!            ----------------------------------------<a name='2279'></font>
<font color=#447700>!<a name='2280'></font>
<font color=#447700>!PVARP(:,:,IKB-1)=PVARP(:,:,IKB) MODIF WRF JP<a name='2281'></font>
PVARP(:,:,IKE+1)=PVARP(:,:,IKE)<a name='2282'>
<font color=#447700>!<a name='2283'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2284'></font>
<font color=#447700>!<a name='2285'></font>
END SUBROUTINE TRIDIAG_MASSFLUX<a name='2286'>
<a name='2287'>
<font color=#447700>!     <a name='2288'></font>
<font color=#447700>!     #################################################################<a name='2289'></font>
<A NAME='UPDRAFT_SOPE'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#UPDRAFT_SOPE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2290'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>UPDRAFT_SOPE</font>(KRR,KRRL,KRRI,OMIXUV,                   &amp;  <A href='../../call_to/UPDRAFT_SOPE.html' TARGET='index'>1</A>,<A href='../../call_from/UPDRAFT_SOPE.html' TARGET='index'>1</A><a name='2291'>
                         PZZ,PDZZ,PSFTH,PSFRV,PPABSM,PRHODREF,        &amp;<a name='2292'>
                         PTKEM,PTHM,PRM,PTHLM,PRTM,PUM,PVM,           &amp;<a name='2293'>
                         PTHL_UP,PRT_UP,PRV_UP,PU_UP,PV_UP,           &amp;<a name='2294'>
                         PRC_UP,PRI_UP,PTHV_UP,PW_UP,PFRAC_UP,PEMF,   &amp;<a name='2295'>
                         PDETR,PENTR,KKLCL,KKETL,KKCTL )<a name='2296'>
<font color=#447700>!     #################################################################<a name='2297'></font>
<font color=#447700>!!<a name='2298'></font>
<font color=#447700>!!****  *UPDRAFT_SOPE* - Interfacing routine<a name='2299'></font>
<font color=#447700>!!<a name='2300'></font>
<font color=#447700>!! --------------------------------------------------------------------------<a name='2301'></font>
<font color=#447700>!<a name='2302'></font>
<font color=#447700>!*      0. DECLARATIONS<a name='2303'></font>
<font color=#447700>!          ------------<a name='2304'></font>
<font color=#447700>!<a name='2305'></font>
<a name='2306'>
IMPLICIT NONE<a name='2307'>
<a name='2308'>
<font color=#447700>!*                    1.1  Declaration of Arguments<a name='2309'></font>
<font color=#447700>!<a name='2310'></font>
<font color=#447700>!<a name='2311'></font>
INTEGER,                INTENT(IN)   :: KRR       <font color=#447700>! number of moist var.<a name='2312'></font>
INTEGER,                INTENT(IN)   :: KRRL      <font color=#447700>! number of liquid water var.<a name='2313'></font>
INTEGER,                INTENT(IN)   :: KRRI      <font color=#447700>! number of ice water var.<a name='2314'></font>
LOGICAL,                INTENT(IN)   :: OMIXUV    <font color=#447700>! True if mixing of momentum<a name='2315'></font>
<a name='2316'>
REAL, DIMENSION(:,:,:), INTENT(IN)   :: PZZ       <font color=#447700>!  Height at the flux point<a name='2317'></font>
<a name='2318'>
REAL, DIMENSION(:,:,:), INTENT(IN)   :: PDZZ      <font color=#447700>! depth between mass levels <a name='2319'></font>
 <a name='2320'>
REAL, DIMENSION(:,:),   INTENT(IN)   ::  PSFTH,PSFRV<a name='2321'>
                                            <font color=#447700>! normal surface fluxes of theta,rv<a name='2322'></font>
<font color=#447700>!<a name='2323'></font>
<font color=#447700>!    prognostic variables at t- deltat<a name='2324'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN) ::  PPABSM      <font color=#447700>! Pressure at time t-1<a name='2325'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN) ::  PRHODREF    <font color=#447700>! dry density of the<a name='2326'></font>
                                                     <font color=#447700>! reference state<a name='2327'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN) ::  PTKEM       <font color=#447700>! TKE<a name='2328'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN) ::  PUM,PVM     <font color=#447700>! momentum<a name='2329'></font>
<a name='2330'>
<font color=#447700>!<a name='2331'></font>
<font color=#447700>!   thermodynamical variables which are transformed in conservative var.<a name='2332'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN)   ::  PTHM       <font color=#447700>! pot. temp. = PTHLM in turb.f90<a name='2333'></font>
REAL, DIMENSION(:,:,:,:), INTENT(IN)   ::  PRM        <font color=#447700>! water species <a name='2334'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN)   ::  PTHLM,PRTM <font color=#447700>!cons. var.  <a name='2335'></font>
REAL, DIMENSION(:,:,:),   INTENT(OUT)  ::  PTHL_UP,PRT_UP  <font color=#447700>! updraft properties<a name='2336'></font>
REAL, DIMENSION(:,:,:),   INTENT(OUT)  ::  PRV_UP,PRC_UP,PRI_UP,&amp;<font color=#447700>!Thl,Rt,Rv,Rc,Ri<a name='2337'></font>
                                           PW_UP,PFRAC_UP,PEMF, &amp;<font color=#447700>!w,Updraft Fraction, Mass Flux<a name='2338'></font>
                                           PDETR,PENTR,PTHV_UP, &amp;<font color=#447700>!entrainment, detrainment, ThV<a name='2339'></font>
                                           PU_UP, PV_UP          <font color=#447700>!updraft wind component<a name='2340'></font>
                                           <a name='2341'>
INTEGER, DIMENSION(:,:),  INTENT(OUT)  ::  KKLCL,KKETL,KKCTL     <font color=#447700>!index for LCL,ETL,CTL       <a name='2342'></font>
<font color=#447700>!<a name='2343'></font>
<font color=#447700>!<a name='2344'></font>
<font color=#447700>!<a name='2345'></font>
<font color=#447700>!                       1.2  Declaration of local variables<a name='2346'></font>
<a name='2347'>
INTEGER :: IKB<a name='2348'>
<a name='2349'>
<font color=#447700>!<a name='2350'></font>
<font color=#447700>! Variables to transform 3D fields in 2D fields<a name='2351'></font>
REAL, DIMENSION(SIZE(PTKEM,1)*SIZE(PTKEM,2),SIZE(PTKEM,3)) :: ZPABSM,ZRHODREF<a name='2352'>
       <a name='2353'>
REAL, DIMENSION(SIZE(PTKEM,1)*SIZE(PTKEM,2),SIZE(PTKEM,3)) :: ZZZ,ZDZZ<a name='2354'>
<a name='2355'>
REAL, DIMENSION(SIZE(PTKEM,1)*SIZE(PTKEM,2),SIZE(PTKEM,3)) :: ZTHLM,ZRTM,&amp;<a name='2356'>
                                                              ZTHM,ZTKEM,&amp;<a name='2357'>
                                                              ZUM,ZVM<a name='2358'>
                                                              <a name='2359'>
REAL, DIMENSION(SIZE(PTKEM,1)*SIZE(PTKEM,2),SIZE(PTKEM,3)) :: ZRVM,ZRCM,ZRIM<a name='2360'>
<a name='2361'>
REAL, DIMENSION(SIZE(PSFTH,1)*SIZE(PSFTH,2))    ::  ZSFTH,ZSFRV<a name='2362'>
<a name='2363'>
REAL, DIMENSION(SIZE(PTKEM,1)*SIZE(PTKEM,2),SIZE(PTKEM,3))  :: ZTHL_UP,ZRT_UP,&amp;<a name='2364'>
                                      ZRV_UP,ZRC_UP, ZRI_UP, &amp;<a name='2365'>
                                      ZW_UP,ZU_UP,ZV_UP,ZTHV_UP,           &amp;<a name='2366'>
                                      ZFRAC_UP,ZEMF_UP,ZENTR_UP,ZDETR_UP<a name='2367'>
<a name='2368'>
REAL, DIMENSION(SIZE(PTKEM,1)*SIZE(PTKEM,2))    :: ZFRAC_GRID<a name='2369'>
INTEGER, DIMENSION(SIZE(PTKEM,1)*SIZE(PTKEM,2)) :: JKETL,JKCTL,JKLCL<a name='2370'>
<a name='2371'>
INTEGER :: IIU,IJU,IKU<font color=#447700>! Limit of the grid<a name='2372'></font>
INTEGER :: J1D        <font color=#447700>! horizontal loop counter<a name='2373'></font>
INTEGER :: JK,JKK,JSV <font color=#447700>! loop counters<a name='2374'></font>
INTEGER :: JRR        <font color=#447700>! moist loop counter<a name='2375'></font>
REAL    :: ZRVORD     <font color=#447700>! Rv/Rd (=1/0.622 cf glossaire)<a name='2376'></font>
<a name='2377'>
<font color=#447700>!------------------------------------------------------------------------<a name='2378'></font>
<a name='2379'>
<font color=#447700>!                     2. INITIALISATION<a name='2380'></font>
<a name='2381'>
<font color=#447700>!                     2.1 Local variables, internal domain<a name='2382'></font>
<a name='2383'>
IIU=SIZE(PTKEM,1)<a name='2384'>
IJU=SIZE(PTKEM,2)<a name='2385'>
<font color=#447700>!<a name='2386'></font>
IKB = 1              <font color=#447700>! Modif WRF JP<a name='2387'></font>
IKU = SIZE(PTKEM,3)<a name='2388'>
<a name='2389'>
ZRVORD = XRV / XRD<a name='2390'>
<a name='2391'>
<a name='2392'>
DO JK=IKB,IKU<a name='2393'>
  ZZZ    (:,JK) = RESHAPE(PZZ    (:,:,JK),(/ IIU*IJU /) )<a name='2394'>
  ZDZZ   (:,JK) = RESHAPE(PDZZ    (:,:,JK),(/ IIU*IJU /) )  <a name='2395'>
  ZTHM   (:,JK) = RESHAPE(PTHM   (:,:,JK),(/ IIU*IJU /) )<a name='2396'>
  ZTKEM  (:,JK) = RESHAPE(PTKEM  (:,:,JK),(/ IIU*IJU /) )<a name='2397'>
  ZPABSM (:,JK) = RESHAPE(PPABSM (:,:,JK),(/ IIU*IJU /) )<a name='2398'>
  ZRHODREF(:,JK) = RESHAPE(PRHODREF(:,:,JK),(/ IIU*IJU /) )  <a name='2399'>
  ZRVM   (:,JK) = RESHAPE(PRM    (:,:,JK,1),(/ IIU*IJU /) ) <a name='2400'>
  ZTHLM  (:,JK) = RESHAPE(PTHLM   (:,:,JK),(/ IIU*IJU /) )<a name='2401'>
  ZRTM   (:,JK) = RESHAPE(PRTM    (:,:,JK),(/ IIU*IJU /) )<a name='2402'>
  ZUM    (:,JK) = RESHAPE(PUM    (:,:,JK),(/ IIU*IJU /) )<a name='2403'>
  ZVM    (:,JK) = RESHAPE(PVM    (:,:,JK),(/ IIU*IJU /) )<a name='2404'>
END DO<a name='2405'>
<a name='2406'>
IF (KRRL&gt;1) THEN<a name='2407'>
DO JK=1,IKU<a name='2408'>
  ZRCM   (:,JK) = RESHAPE(PRM    (:,:,JK,2),(/ IIU*IJU /) ) <a name='2409'>
END DO<a name='2410'>
ELSE<a name='2411'>
  ZRCM   (:,:) =0.<a name='2412'>
ENDIF<a name='2413'>
IF (KRRI&gt;1) THEN<a name='2414'>
DO JK=1,IKU<a name='2415'>
  ZRIM   (:,JK) = RESHAPE(PRM    (:,:,JK,4),(/ IIU*IJU /) ) <a name='2416'>
END DO<a name='2417'>
ELSE<a name='2418'>
  ZRIM   (:,:) =0.<a name='2419'>
ENDIF<a name='2420'>
<a name='2421'>
ZSFTH(:)=RESHAPE(PSFTH(:,:),(/ IIU*IJU /) )<a name='2422'>
ZSFRV(:)=RESHAPE(PSFRV(:,:),(/ IIU*IJU /) )<a name='2423'>
<a name='2424'>
<font color=#447700>!Updraft begins at level 1 (Modif WRF)<a name='2425'></font>
JK=IKB <a name='2426'>
<a name='2427'>
<font color=#447700>!        6.2 compute properties of the updraft<a name='2428'></font>
CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_UPDRAFT'>COMPUTE_UPDRAFT</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#UPDRAFT_SOPE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_UPDRAFT_1">(OMIXUV,ZZZ,ZDZZ,JK,      &amp;<a name='2429'>
                     ZSFTH,ZSFRV,ZPABSM,ZRHODREF,ZUM,ZVM,ZTKEM, &amp;<a name='2430'>
                     ZTHM,ZRVM,ZRCM,ZRIM,ZTHLM,ZRTM,       &amp;<a name='2431'>
                     ZTHL_UP,ZRT_UP,ZRV_UP,ZRC_UP,ZRI_UP,&amp;<a name='2432'>
                     ZTHV_UP,ZW_UP,ZU_UP,ZV_UP, &amp;<a name='2433'>
                     ZFRAC_UP,ZEMF_UP,&amp;<a name='2434'>
                     ZDETR_UP,ZENTR_UP,&amp;<a name='2435'>
                     JKLCL,JKETL,JKCTL)<a name='2436'>
<a name='2437'>
<a name='2438'>
PTHL_UP(:,:,:)= RESHAPE(ZTHL_UP(:,:), (/ IIU,IJU,IKU /))<a name='2439'>
PRT_UP(:,:,:)=RESHAPE(ZRT_UP(:,:), (/ IIU,IJU,IKU /) )<a name='2440'>
PRV_UP(:,:,:)=RESHAPE(ZRV_UP(:,:), (/ IIU,IJU,IKU /) )<a name='2441'>
PRC_UP(:,:,:)=RESHAPE(ZRC_UP(:,:), (/ IIU,IJU,IKU /) )<a name='2442'>
PRI_UP(:,:,:)=RESHAPE(ZRI_UP(:,:), (/ IIU,IJU,IKU /) )<a name='2443'>
PW_UP(:,:,:)=RESHAPE(ZW_UP(:,:), (/ IIU,IJU,IKU /) )<a name='2444'>
PU_UP(:,:,:)=RESHAPE(ZU_UP(:,:), (/ IIU,IJU,IKU /) )<a name='2445'>
PV_UP(:,:,:)=RESHAPE(ZV_UP(:,:), (/ IIU,IJU,IKU /) )<a name='2446'>
PEMF(:,:,:)=RESHAPE(ZEMF_UP(:,:), (/ IIU,IJU,IKU /) )<a name='2447'>
PDETR(:,:,:)=RESHAPE(ZDETR_UP(:,:), (/ IIU,IJU,IKU /) )<a name='2448'>
PENTR(:,:,:)=RESHAPE(ZENTR_UP(:,:), (/ IIU,IJU,IKU /) )<a name='2449'>
PTHV_UP(:,:,:)=RESHAPE(ZTHV_UP(:,:), (/ IIU,IJU,IKU /) )<a name='2450'>
KKETL(:,:)=RESHAPE(JKETL(:),(/ IIU,IJU/) )<a name='2451'>
KKCTL(:,:)=RESHAPE(JKCTL(:),(/ IIU,IJU/) )<a name='2452'>
KKLCL(:,:)=RESHAPE(JKLCL(:),(/ IIU,IJU/) )<a name='2453'>
PFRAC_UP(:,:,:)=RESHAPE(ZFRAC_UP(:,:),(/ IIU,IJU,IKU /) )<a name='2454'>
<a name='2455'>
END SUBROUTINE UPDRAFT_SOPE<a name='2456'>
<a name='2457'>
<font color=#447700>!     #################################################################<a name='2458'></font>
<A NAME='COMPUTE_MF_CLOUD'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_MF_CLOUD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2459'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>COMPUTE_MF_CLOUD</font>(KRRL, PTHLM,PRC_UP, PFRAC_UP, PDZZ, KKLCL,&amp; <A href='../../call_to/COMPUTE_MF_CLOUD.html' TARGET='index'>1</A><a name='2460'>
                                  PRC_MF,PCF_MF                     )<a name='2461'>
<font color=#447700>!     #################################################################<a name='2462'></font>
<font color=#447700>!!<a name='2463'></font>
<font color=#447700>!!****  *COMPUTE_MF_CLOUD* - <a name='2464'></font>
<font color=#447700>!!       compute diagnostic subgrid cumulus cloud caracteristics<a name='2465'></font>
<font color=#447700>!!<a name='2466'></font>
<font color=#447700>!!    PURPOSE<a name='2467'></font>
<font color=#447700>!!    -------<a name='2468'></font>
<font color=#447700>!!****  The purpose of this routine is to compute the cloud fraction and <a name='2469'></font>
<font color=#447700>!!      the mean cloud content associated with clouds described by the <a name='2470'></font>
<font color=#447700>!!      mass flux scheme<a name='2471'></font>
<font color=#447700>!!<a name='2472'></font>
<font color=#447700>!<a name='2473'></font>
<font color=#447700>!!**  METHOD<a name='2474'></font>
<font color=#447700>!!    ------<a name='2475'></font>
<font color=#447700>!!<a name='2476'></font>
<font color=#447700>!!    EXTERNAL<a name='2477'></font>
<font color=#447700>!!    --------<a name='2478'></font>
<font color=#447700>!!      <a name='2479'></font>
<font color=#447700>!!    IMPLICIT ARGUMENTS<a name='2480'></font>
<font color=#447700>!!    ------------------<a name='2481'></font>
<font color=#447700>!!<a name='2482'></font>
<font color=#447700>!!     REFERENCE<a name='2483'></font>
<font color=#447700>!!     ---------<a name='2484'></font>
<font color=#447700>!!<a name='2485'></font>
<font color=#447700>!!<a name='2486'></font>
<font color=#447700>!!     AUTHOR<a name='2487'></font>
<font color=#447700>!!     ------<a name='2488'></font>
<font color=#447700>!! --------------------------------------------------------------------------<a name='2489'></font>
<font color=#447700>!<a name='2490'></font>
<font color=#447700>!*      0. DECLARATIONS<a name='2491'></font>
<font color=#447700>!          ------------<a name='2492'></font>
<font color=#447700>!<a name='2493'></font>
<a name='2494'>
<a name='2495'>
IMPLICIT NONE<a name='2496'>
<a name='2497'>
<font color=#447700>!*                    1.1  Declaration of Arguments<a name='2498'></font>
<font color=#447700>!<a name='2499'></font>
<font color=#447700>!<a name='2500'></font>
<font color=#447700>!<a name='2501'></font>
INTEGER,                  INTENT(IN)   ::  KRRL         <font color=#447700>! number of liquid water var.<a name='2502'></font>
                                                        <font color=#447700>! scheme<a name='2503'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN)   ::  PTHLM <font color=#447700>! updraft characteritics<a name='2504'></font>
<a name='2505'>
REAL, DIMENSION(:,:,:),   INTENT(IN)   ::  PRC_UP <font color=#447700>! updraft characteritics<a name='2506'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN)   ::  PFRAC_UP          <font color=#447700>! Updraft Fraction<a name='2507'></font>
<a name='2508'>
REAL, DIMENSION(:,:,:),   INTENT(IN)   ::  PDZZ<a name='2509'>
INTEGER, DIMENSION(:,:),  INTENT(IN)   ::  KKLCL          <font color=#447700>! index of updraft condensation level<a name='2510'></font>
REAL, DIMENSION(:,:,:),   INTENT(OUT)  ::  PRC_MF, PCF_MF <font color=#447700>! cloud content and<a name='2511'></font>
                                                          <font color=#447700>! cloud fraction for MF scheme<a name='2512'></font>
<a name='2513'>
<font color=#447700>!<a name='2514'></font>
<font color=#447700>!                       1.2  Declaration of local variables<a name='2515'></font>
<font color=#447700>!<a name='2516'></font>
REAL, DIMENSION(SIZE(PTHLM,1),SIZE(PTHLM,2),SIZE(PTHLM,3)) ::  ZFLXZ<a name='2517'>
INTEGER  :: IKU, IKB, IKE, JI,JJ,JK<a name='2518'>
<font color=#447700>!------------------------------------------------------------------------<a name='2519'></font>
<a name='2520'>
<font color=#447700>!                     1. INITIALISATION<a name='2521'></font>
<a name='2522'>
<font color=#447700>!                     2.1 Internal domain<a name='2523'></font>
<a name='2524'>
<font color=#447700>! Internal Domain<a name='2525'></font>
IKU=SIZE(PTHLM,3)<a name='2526'>
IKB=1<a name='2527'>
IKE=IKU-1<a name='2528'>
<a name='2529'>
PCF_MF = 0.<a name='2530'>
PRC_MF = 0.<a name='2531'>
<a name='2532'>
<a name='2533'>
<font color=#447700>!<a name='2534'></font>
<font color=#447700>!                    Direct cloud scheme<a name='2535'></font>
<font color=#447700>!        This scheme may be activated only if the selected updraft model<a name='2536'></font>
<font color=#447700>!        gives the updraft fraction as an output<a name='2537'></font>
<font color=#447700>!        <a name='2538'></font>
<a name='2539'>
<font color=#447700>! attention, les variables de l'updraft sont en niveaux flux<a name='2540'></font>
<font color=#447700>! ils faut les passer aux niveaux masse pour calculer PRC_MF et PCF_MF<a name='2541'></font>
DO JI=1,SIZE(PCF_MF,1)<a name='2542'>
DO JJ=1,SIZE(PCF_MF,2)<a name='2543'>
<a name='2544'>
DO JK=KKLCL(JI,JJ),IKE<a name='2545'>
<a name='2546'>
PCF_MF(JI,JJ,JK ) = XKCF_MF *0.5* (       &amp;<a name='2547'>
  &amp;    PFRAC_UP(JI,JJ,JK) +  PFRAC_UP(JI,JJ,JK+1) )<a name='2548'>
PRC_MF(JI,JJ,JK)  = 0.5* XKCF_MF * ( PFRAC_UP(JI,JJ,JK)*PRC_UP(JI,JJ,JK)  &amp;<a name='2549'>
                         + PFRAC_UP(JI,JJ,JK+1)*PRC_UP(JI,JJ,JK+1) )<a name='2550'>
<a name='2551'>
<a name='2552'>
END DO<a name='2553'>
END DO<a name='2554'>
END DO<a name='2555'>
<a name='2556'>
<a name='2557'>
END SUBROUTINE COMPUTE_MF_CLOUD<a name='2558'>
<a name='2559'>
<a name='2560'>
<font color=#447700>!     #################################################################<a name='2561'></font>
<A NAME='MFSHCONVPBLINIT'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MFSHCONVPBLINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2562'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>mfshconvpblinit</font>(massflux_EDKF, entr_EDKF, detr_EDKF &amp;  <A href='../../call_to/MFSHCONVPBLINIT.html' TARGET='index'>1</A><a name='2563'>
                                     ,thl_up, thv_up, rt_up       &amp;<a name='2564'>
                                     ,rv_up, rc_up, u_up, v_up    &amp;<a name='2565'>
                                     ,frac_up,RESTART,ALLOWED_TO_READ,     &amp;<a name='2566'>
     &amp;                      IDS,IDE,JDS,JDE,KDS,KDE,                    &amp;<a name='2567'>
     &amp;                      IMS,IME,JMS,JME,KMS,KME,                    &amp;<a name='2568'>
     &amp;                      ITS,ITE,JTS,JTE,KTS,KTE                 )<a name='2569'>
<font color=#447700>!     #################################################################<a name='2570'></font>
<a name='2571'>
      IMPLICIT NONE<a name='2572'>
<a name='2573'>
      LOGICAL,INTENT(IN) :: ALLOWED_TO_READ,RESTART<a name='2574'>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE,                    &amp;<a name='2575'>
     &amp;                      IMS,IME,JMS,JME,KMS,KME,                    &amp;<a name='2576'>
     &amp;                      ITS,ITE,JTS,JTE,KTS,KTE<a name='2577'>
<a name='2578'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT),OPTIONAL ::             &amp;<a name='2579'>
     &amp;                                        MASSFLUX_EDKF, ENTR_EDKF, DETR_EDKF &amp;<a name='2580'>
     &amp;                                       ,THL_UP, THV_UP, RT_UP, RV_UP        &amp;<a name='2581'>
     &amp;                                       ,RC_UP, U_UP, V_UP, FRAC_UP <a name='2582'>
<a name='2583'>
      INTEGER :: I,J,K,ITF,JTF,KTF<a name='2584'>
<a name='2585'>
<font color=#447700>!---------------------------------------------<a name='2586'></font>
      JTF=MIN0(JTE,JDE-1)<a name='2587'>
      KTF=MIN0(KTE,KDE-1)<a name='2588'>
      ITF=MIN0(ITE,IDE-1)<a name='2589'>
<a name='2590'>
<font color=#447700>!     IF(.NOT.RESTART)THEN<a name='2591'></font>
      IF( PRESENT (MASSFLUX_EDKF) ) THEN<a name='2592'>
        DO J=JTS,JTF<a name='2593'>
        DO K=KTS,KTF<a name='2594'>
        DO I=ITS,ITF<a name='2595'>
          MASSFLUX_EDKF(I,K,J)=0.<a name='2596'>
          ENTR_EDKF(I,K,J)=0.<a name='2597'>
          DETR_EDKF(I,K,J)=0.<a name='2598'>
          THL_UP(I,K,J)=0.<a name='2599'>
          THV_UP(I,K,J)=0.<a name='2600'>
          RT_UP(I,K,J)=0.<a name='2601'>
          RV_UP(I,K,J)=0.<a name='2602'>
          RC_UP(I,K,J)=0.<a name='2603'>
          U_UP(I,K,J)=0.<a name='2604'>
          V_UP(I,K,J)=0.<a name='2605'>
          FRAC_UP(I,K,J)=0.<a name='2606'>
        ENDDO<a name='2607'>
        ENDDO<a name='2608'>
        ENDDO<a name='2609'>
      ENDIF<a name='2610'>
<a name='2611'>
END SUBROUTINE mfshconvpblinit<a name='2612'>
<a name='2613'>
<a name='2614'>
<font color=#447700>!     #########################################################<a name='2615'></font>
<A NAME='BL89'><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#BL89' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2616'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>BL89</font>(PZZ,PDZZ,PTHVREF,PTHLM,KRR, &amp; <A href='../../call_to/BL89.html' TARGET='index'>1</A>,<A href='../../call_from/BL89.html' TARGET='index'>2</A><a name='2617'>
                 PRM,PTKEM,PLM)<a name='2618'>
<font color=#447700>!     #########################################################<a name='2619'></font>
<font color=#447700>!<a name='2620'></font>
<font color=#447700>!!****  *BL89* -<a name='2621'></font>
<font color=#447700>!!<a name='2622'></font>
<font color=#447700>!!    PURPOSE<a name='2623'></font>
<font color=#447700>!!    -------<a name='2624'></font>
<font color=#447700>!!    This routine computes the mixing length from Bougeault-Lacarrere 89<a name='2625'></font>
<font color=#447700>!!    formula.<a name='2626'></font>
<font color=#447700>!!<a name='2627'></font>
<font color=#447700>!!**  METHOD<a name='2628'></font>
<font color=#447700>!!    ------<a name='2629'></font>
<font color=#447700>!!<a name='2630'></font>
<font color=#447700>!*       0.1   Declaration of arguments<a name='2631'></font>
<font color=#447700>!              ------------------------<a name='2632'></font>
<font color=#447700>!<a name='2633'></font>
INTEGER,                INTENT(IN)   :: KRR<a name='2634'>
<a name='2635'>
REAL, DIMENSION(:,:,:),   INTENT(IN)  :: PZZ<a name='2636'>
REAL, DIMENSION(:,:,:),   INTENT(IN)  :: PDZZ<a name='2637'>
REAL, DIMENSION(:,:,:),   INTENT(IN)  :: PTHVREF<a name='2638'>
REAL, DIMENSION(:,:,:),   INTENT(IN) ::  PTKEM       <font color=#447700>! TKE<a name='2639'></font>
<font color=#447700>!   thermodynamical variables PTHLM=Theta at the begining<a name='2640'></font>
REAL, DIMENSION(:,:,:),   INTENT(IN) ::  PTHLM     <font color=#447700>! conservative pot. temp.<a name='2641'></font>
REAL, DIMENSION(:,:,:,:), INTENT(IN) ::  PRM       <font color=#447700>! water var.                 <a name='2642'></font>
REAL, DIMENSION(:,:,:),   INTENT(OUT) :: PLM       <font color=#447700>! Mixing length<a name='2643'></font>
<a name='2644'>
<font color=#447700>!*       0.2   Declaration of local variables<a name='2645'></font>
<font color=#447700>!              ------------------------------<a name='2646'></font>
<font color=#447700>!<a name='2647'></font>
INTEGER :: IKB,IKE<a name='2648'>
<a name='2649'>
REAL, DIMENSION(SIZE(PTKEM,1)*SIZE(PTKEM,2),SIZE(PTKEM,3)) :: ZRTM<a name='2650'>
REAL, DIMENSION(SIZE(PTKEM,1)*SIZE(PTKEM,2),SIZE(PTKEM,3)) ::ZVPT  <font color=#447700>! Virtual Potential Temp at half levels<a name='2651'></font>
REAL, DIMENSION(SIZE(PTKEM,1)*SIZE(PTKEM,2)) ::  ZLWORK<a name='2652'>
<font color=#447700>!           ! downwards then upwards vertical displacement,<a name='2653'></font>
REAL, DIMENSION(SIZE(PTKEM,1)*SIZE(PTKEM,2),SIZE(PTKEM,3)) :: ZZZ,ZDZZ,&amp;<a name='2654'>
                                                              ZG_O_THVREF, &amp;<a name='2655'>
                                                              ZTHM,ZTKEM,ZLM,&amp;<a name='2656'>
                                                              ZLMUP,ZLMDN,&amp;<a name='2657'>
                                                              ZLMTEST<a name='2658'>
<font color=#447700>!           ! input and output arrays packed according one horizontal coord.<a name='2659'></font>
REAL, DIMENSION(SIZE(PRM,1)*SIZE(PRM,2),SIZE(PRM,3),SIZE(PRM,4)) :: ZRM<a name='2660'>
<font color=#447700>!           ! input array packed according one horizontal coord.<a name='2661'></font>
REAL, DIMENSION(SIZE(PRM,1)*SIZE(PRM,2),SIZE(PRM,3)) :: ZSUM <font color=#447700>! to replace SUM function<a name='2662'></font>
<a name='2663'>
REAL   :: ZPOTE,ZLWORK1,ZLWORK2<a name='2664'>
<a name='2665'>
INTEGER :: IIU,IJU,IKU,IICE<a name='2666'>
INTEGER :: J1D        <font color=#447700>! horizontal loop counter<a name='2667'></font>
INTEGER :: JK,JKK     <font color=#447700>! loop counters<a name='2668'></font>
INTEGER :: JRR        <font color=#447700>! moist loop counter<a name='2669'></font>
REAL    :: ZRVORD     <font color=#447700>! Rv/Rd (=1/0.622 cf glossaire)<a name='2670'></font>
LOGICAL :: GUPORDN    <font color=#447700>!Test for computation of upward or downward mixing length<a name='2671'></font>
REAL    :: Z2SQRT2<a name='2672'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2673'></font>
<font color=#447700>!<a name='2674'></font>
Z2SQRT2=2.*SQRT(2.)<a name='2675'>
IIU=SIZE(PTKEM,1)<a name='2676'>
IJU=SIZE(PTKEM,2)<a name='2677'>
<font color=#447700>!<a name='2678'></font>
IKB =  1<a name='2679'>
IKE = SIZE(PTKEM,3)-1<a name='2680'>
IKU = SIZE(PTKEM,3)<a name='2681'>
ZRVORD = XRV / XRD<a name='2682'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2683'></font>
<font color=#447700>!<a name='2684'></font>
<font color=#447700>!*       1.    pack the horizontal dimensions into one<a name='2685'></font>
<font color=#447700>!              ---------------------------------------<a name='2686'></font>
<font color=#447700>!<a name='2687'></font>
DO JK=1,IKU<a name='2688'>
  ZZZ    (:,JK)   = RESHAPE(PZZ    (:,:,JK),(/ IIU*IJU /) )<a name='2689'>
  ZDZZ   (:,JK)   = RESHAPE(PDZZ   (:,:,JK),(/ IIU*IJU /) )<a name='2690'>
  ZTHM   (:,JK)   = RESHAPE(PTHLM  (:,:,JK),(/ IIU*IJU /) )<a name='2691'>
  ZTKEM  (:,JK)   = RESHAPE(PTKEM  (:,:,JK),(/ IIU*IJU /) )<a name='2692'>
  ZG_O_THVREF(:,JK)   = RESHAPE(XG/PTHVREF(:,:,JK),(/ IIU*IJU /) )<a name='2693'>
  DO JRR=1,KRR<a name='2694'>
    ZRM  (:,JK,JRR) = RESHAPE(PRM    (:,:,JK,JRR),(/ IIU*IJU /) )<a name='2695'>
  END DO<a name='2696'>
END DO<a name='2697'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2698'></font>
<font color=#447700>!<a name='2699'></font>
<font color=#447700>!*       2.    Virtual potential temperature on the model grid<a name='2700'></font>
<font color=#447700>!              -----------------------------------------------<a name='2701'></font>
<font color=#447700>!<a name='2702'></font>
IF(KRR /= 0) THEN<a name='2703'>
  ZSUM(:,:) = 0.<a name='2704'>
  DO JRR=1,KRR<a name='2705'>
    ZSUM(:,:) = ZSUM(:,:)+ZRM(:,:,JRR)<a name='2706'>
  ENDDO<a name='2707'>
  ZVPT(:,1:)=ZTHM(:,:) * ( 1. + ZRVORD*ZRM(:,:,1) )  &amp;<a name='2708'>
                           / ( 1. + ZSUM(:,:) )<a name='2709'>
ELSE<a name='2710'>
  ZVPT(:,1:)=ZTHM(:,:)<a name='2711'>
END IF<a name='2712'>
<font color=#447700>!<a name='2713'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2714'></font>
<font color=#447700>!<a name='2715'></font>
<font color=#447700>!*       3.  loop on model levels<a name='2716'></font>
<font color=#447700>!            --------------------<a name='2717'></font>
<font color=#447700>!<a name='2718'></font>
DO JK=IKB,IKE<a name='2719'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2720'></font>
<font color=#447700>!<a name='2721'></font>
<font color=#447700>!*       4.  mixing length for a downwards displacement<a name='2722'></font>
<font color=#447700>!            ------------------------------------------<a name='2723'></font>
   GUPORDN=.FALSE.<a name='2724'>
   CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_BL89_ML'>COMPUTE_BL89_ML</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#BL89' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_BL89_ML_2">(ZDZZ,ZTKEM,ZG_O_THVREF,ZVPT,JK,GUPORDN,ZLWORK)<a name='2725'>
<a name='2726'>
<a name='2727'>
<a name='2728'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2729'></font>
<font color=#447700>!<a name='2730'></font>
<font color=#447700>!*       5.  intermediate storage of the final mixing length<a name='2731'></font>
<font color=#447700>!            -----------------------------------------------<a name='2732'></font>
<font color=#447700>!<a name='2733'></font>
   ZLMDN(:,JK)=MIN(ZLWORK(:),0.5*(ZZZ(:,JK)+ZZZ(:,JK+1))-ZZZ(:,IKB))<a name='2734'>
<font color=#447700>!<a name='2735'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2736'></font>
<font color=#447700>!<a name='2737'></font>
<font color=#447700>!*       6.  mixing length for an upwards displacement<a name='2738'></font>
<font color=#447700>!            -----------------------------------------<a name='2739'></font>
 <a name='2740'>
   GUPORDN=.TRUE.<a name='2741'>
   CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#COMPUTE_BL89_ML'>COMPUTE_BL89_ML</A><A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#BL89' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_BL89_ML_3">(ZDZZ,ZTKEM,ZG_O_THVREF,ZVPT,JK,GUPORDN,ZLWORK)<a name='2742'>
<a name='2743'>
   ZLMUP(:,JK)=ZLWORK(:)<a name='2744'>
<a name='2745'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2746'></font>
<font color=#447700>! <a name='2747'></font>
  DO J1D=1,IIU*IJU<a name='2748'>
    ZLWORK1=MAX(ZLMDN(J1D,JK),1.E-10)<a name='2749'>
    ZLWORK2=MAX(ZLMUP(J1D,JK),1.E-10)<a name='2750'>
    ZPOTE = ZLWORK1 / ZLWORK2<a name='2751'>
    ZLWORK2=1.d0 + ZPOTE**(2./3.)<a name='2752'>
    ZLM(J1D,JK) = Z2SQRT2*ZLWORK1/(ZLWORK2*SQRT(ZLWORK2))<a name='2753'>
  END DO<a name='2754'>
<a name='2755'>
ZLM(:,JK)=( 0.5* (MAX(ZLMDN(:,JK),1.E-10)**(-2./3.)+MAX(ZLMUP(:,JK),1.E-10)**(-2./3.)) )**(-1.5)<a name='2756'>
ZLM(:,JK)=MAX(ZLM(:,JK),XLINI)<a name='2757'>
<a name='2758'>
<font color=#447700>!*       8.  end of the loop on the vertical levels<a name='2759'></font>
<font color=#447700>!            --------------------------------------<a name='2760'></font>
<font color=#447700>!<a name='2761'></font>
END DO<a name='2762'>
<font color=#447700>!<a name='2763'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2764'></font>
<font color=#447700>!<a name='2765'></font>
<font color=#447700>!*       9.  boundaries<a name='2766'></font>
<font color=#447700>!            ----------<a name='2767'></font>
<font color=#447700>!<a name='2768'></font>
ZLM(:,IKE)  =ZLM(:,IKE-1)<a name='2769'>
ZLM(:,IKE+1)=ZLM(:,IKE-1)<a name='2770'>
ZLMUP(:,IKE)  =ZLMUP(:,IKE-1)<a name='2771'>
ZLMUP(:,IKE+1)=ZLMUP(:,IKE-1)<a name='2772'>
ZLMDN(:,IKE)  =ZLMDN(:,IKE-1)<a name='2773'>
ZLMDN(:,IKE+1)=ZLMDN(:,IKE-1)<a name='2774'>
<font color=#447700>!<a name='2775'></font>
  DO JK=1,IKU<a name='2776'>
    PLM  (:,:,JK)   = RESHAPE(ZLM  (:,JK), (/ IIU,IJU /) )<a name='2777'>
  END DO<a name='2778'>
<a name='2779'>
END SUBROUTINE BL89<a name='2780'>
                        <a name='2781'>
END  MODULE MODULE_BL_MFSHCONVPBL<a name='2782'>
<a name='2783'>
</pre></body></html>