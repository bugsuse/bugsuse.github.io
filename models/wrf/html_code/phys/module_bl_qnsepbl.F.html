<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_BL_QNSEPBL'><A href='../../html_code/phys/module_bl_qnsepbl.F.html#MODULE_BL_QNSEPBL' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
      <font color=#993300>MODULE </font><font color=#cc0000>MODULE_BL_QNSEPBL</font> <A href='../../call_to/MODULE_BL_QNSEPBL.html' TARGET='index'>2</A><a name='5'>
<font color=#447700>!<a name='6'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='7'></font>
<font color=#447700>!<a name='8'></font>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/phys/module_bl_qnsepbl.F.html#module_bl_qnsepbl.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_45"><a name='9'>
<font color=#447700>!<a name='10'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='11'></font>
<font color=#447700>!<a name='12'></font>
<font color=#447700>! REFERENCES:  Janjic (2002), NCEP Office Note 437<a name='13'></font>
<font color=#447700>!              Mellor and Yamada (1982), Rev. Geophys. Space Phys.<a name='14'></font>
<font color=#447700>!<a name='15'></font>
<font color=#447700>! ABSTRACT:<a name='16'></font>
<font color=#447700>!     MYJ UPDATES THE TURBULENT KINETIC ENERGY WITH THE PRODUCTION/<a name='17'></font>
<font color=#447700>!     DISSIPATION TERM AND THE VERTICAL DIFFUSION TERM<a name='18'></font>
<font color=#447700>!     (USING AN IMPLICIT FORMULATION) FROM MELLOR-YAMADA<a name='19'></font>
<font color=#447700>!     LEVEL 2.5 AS EXTENDED BY JANJIC.  EXCHANGE COEFFICIENTS FOR<a name='20'></font>
<font color=#447700>!     THE SURFACE AND FOR ALL LAYER INTERFACES ARE COMPUTED FROM<a name='21'></font>
<font color=#447700>!     MONIN-OBUKHOV THEORY.<a name='22'></font>
<font color=#447700>!     THE TURBULENT VERTICAL EXCHANGE IS THEN EXECUTED.<a name='23'></font>
<font color=#447700>!<a name='24'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='25'></font>
<font color=#447700>!<a name='26'></font>
      INTEGER :: ITRMX=5 <font color=#447700>! Iteration count for mixing length computation<a name='27'></font>
<font color=#447700>!<a name='28'></font>
<font color=#447700>!     REAL,PARAMETER :: G=9.81,PI=3.1415926,R_D=287.04,R_V=461.6        &amp;<a name='29'></font>
<font color=#447700>!    &amp;                 ,VKARMAN=0.4<a name='30'></font>
      REAL,PARAMETER :: PI=3.1415926,VKARMAN=0.4<a name='31'>
<font color=#447700>!<a name='32'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='33'></font>
<font color=#447700>!***  QNSE MODEL CONSTANTS <a name='34'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='35'></font>
<font color=#447700>!<a name='36'></font>
      REAL,PARAMETER :: EPSQ2L=0.01<a name='37'>
      REAL,PARAMETER :: C0=0.55,CEPS=C0**3,BLCKDR=0.0063,CN=0.75        &amp;<a name='38'>
     &amp;                 ,AM1=8.0,AM2=2.3,AM3=35.0,AH1=1.4,AH2=-0.01      &amp;<a name='39'>
     &amp;                 ,AH3=1.29,AH4=2.44,AH5=19.8                      &amp;<a name='40'>
     &amp;                 ,ARIMIN=0.127,BM1=2.88,BM2=16.0,BH1=3.6,BH2=16.0 &amp;<a name='41'>
     &amp;                 ,BH3=720.0,EPSKM=1.E-3<a name='42'>
<font color=#447700>!<a name='43'></font>
      REAL,PARAMETER :: CAPA=R_D/CP<a name='44'>
      REAL,PARAMETER :: RLIVWV=XLS/XLV,ELOCP=2.72E6/CP<a name='45'>
      REAL,PARAMETER :: EPS1=1.E-12,EPS2=0.<a name='46'>
      REAL,PARAMETER :: EPSL=0.32,EPSRU=1.E-7,EPSRS=1.E-7               &amp;<a name='47'>
     &amp;                 ,EPSTRB=1.E-24<a name='48'>
      REAL,PARAMETER :: EPSA=1.E-8,EPSIT=1.E-4,EPSU2=1.E-4,EPSUST=0.07  &amp;<a name='49'>
     &amp;                 ,FH=1.01 <a name='50'>
      REAL,PARAMETER :: ALPH=0.30,BETA=1./273.,EL0MAX=1000.,EL0MIN=1.   &amp;<a name='51'>
     &amp;                 ,ELFC=0.23*0.5,GAM1=0.2222222222222222222        &amp;<a name='52'>
     &amp;                 ,PRT=1.<a name='53'>
      REAL,PARAMETER :: A1=0.659888514560862645                         &amp;<a name='54'>
     &amp;                 ,A2x=0.6574209922667784586                       &amp;<a name='55'>
     &amp;                 ,B1=11.87799326209552761                         &amp;<a name='56'>
     &amp;                 ,B2=7.226971804046074028                         &amp;<a name='57'>
     &amp;                 ,C1=0.000830955950095854396<a name='58'>
      REAL,PARAMETER :: A2S=17.2693882,A3S=273.16,A4S=35.86<a name='59'>
      REAL,PARAMETER :: ELZ0=0.,ESQ=5.0,EXCM=0.001                      &amp;<a name='60'>
     &amp;                 ,FHNEU=0.8,GLKBR=10.,GLKBS=30.                   &amp;<a name='61'>
     &amp;                 ,QVISC=2.1E-5,RFC=0.191,RIC=0.505,SMALL=0.35     &amp;<a name='62'>
     &amp;                 ,SQPR=0.84,SQSC=0.84,SQVISC=258.2,TVISC=2.1E-5   &amp;<a name='63'>
     &amp;                 ,USTC=0.7,USTR=0.225,VISC=1.5E-5                 &amp;<a name='64'>
     &amp;                 ,WOLD=0.15,WWST=1.2,ZTMAX=1.,ZTFC=1.,ZTMIN=-5.<a name='65'>
<font color=#447700>!<a name='66'></font>
      REAL,PARAMETER :: SEAFC=0.98,PQ0SEA=PQ0*SEAFC<a name='67'>
<font color=#447700>!<a name='68'></font>
      REAL,PARAMETER :: BTG=BETA*G,CZIV=SMALL*GLKBS                     &amp;<a name='69'>
<font color=#447700>!    &amp;                 ,EP_1=R_V/R_D-1.,ESQHF=0.5*5.0,GRRS=GLKBR/GLKBS  &amp;<a name='70'></font>
     &amp;                 ,ESQHF=0.5*5.0,GRRS=GLKBR/GLKBS                  &amp;<a name='71'>
     &amp;                 ,RB1=1./B1,RTVISC=1./TVISC,RVISC=1./VISC         &amp;<a name='72'>
     &amp;                 ,ZQRZT=SQSC/SQPR<a name='73'>
<font color=#447700>!<a name='74'></font>
      REAL,PARAMETER :: ADNH= 9.*A1*A2x*A2x*(12.*A1+3.*B2)*BTG*BTG      &amp;                  <a name='75'>
     &amp;                 ,ADNM=18.*A1*A1*A2x*(B2-3.*A2x)*BTG              &amp; <a name='76'>
     &amp;                 ,ANMH=-9.*A1*A2x*A2x*BTG*BTG                     &amp;<a name='77'>
     &amp;                 ,ANMM=-3.*A1*A2x*(3.*A2x+3.*B2*C1+18.*A1*C1-B2)  &amp;<a name='78'>
     &amp;                                *BTG                              &amp;   <a name='79'>
     &amp;                 ,BDNH= 3.*A2x*(7.*A1+B2)*BTG                     &amp;<a name='80'>
     &amp;                 ,BDNM= 6.*A1*A1                                  &amp;<a name='81'>
     &amp;                 ,BEQH= A2x*B1*BTG+3.*A2x*(7.*A1+B2)*BTG          &amp;<a name='82'>
     &amp;                 ,BEQM=-A1*B1*(1.-3.*C1)+6.*A1*A1                 &amp;<a name='83'>
     &amp;                 ,BNMH=-A2x*BTG                                   &amp;     <a name='84'>
     &amp;                 ,BNMM=A1*(1.-3.*C1)                              &amp;<a name='85'>
     &amp;                 ,BSHH=9.*A1*A2x*A2x*BTG                          &amp;<a name='86'>
     &amp;                 ,BSHM=18.*A1*A1*A2x*C1                           &amp;<a name='87'>
     &amp;                 ,BSMH=-3.*A1*A2x*(3.*A2x+3.*B2*C1+12.*A1*C1-B2)  &amp;<a name='88'>
     &amp;                                *BTG                              &amp;<a name='89'>
     &amp;                 ,CESH=A2x                                        &amp;<a name='90'>
     &amp;                 ,CESM=A1*(1.-3.*C1)                              &amp;<a name='91'>
     &amp;                 ,CNV=EP_1*G/BTG                                  &amp;<a name='92'>
     &amp;                 ,ELFCS=VKARMAN*BTG                               &amp;<a name='93'>
     &amp;                 ,FZQ1=RTVISC*QVISC*ZQRZT                         &amp;<a name='94'>
     &amp;                 ,FZQ2=RTVISC*QVISC*ZQRZT                         &amp;<a name='95'>
     &amp;                 ,FZT1=RVISC *TVISC*SQPR                          &amp;<a name='96'>
     &amp;                 ,FZT2=CZIV*GRRS*TVISC*SQPR                       &amp;<a name='97'>
     &amp;                 ,FZU1=CZIV*VISC                                  &amp;<a name='98'>
     &amp;                 ,PIHF=0.5*PI                                     &amp;<a name='99'>
     &amp;                 ,RFAC=RIC/(FHNEU*RFC*RFC)                        &amp;<a name='100'>
     &amp;                 ,RQVISC=1./QVISC                                 &amp;<a name='101'>
     &amp;                 ,RRIC=1./RIC                                     &amp;<a name='102'>
     &amp;                 ,USTFC=0.018/G                                   &amp;<a name='103'>
     &amp;                 ,WNEW=1.-WOLD                                    &amp;<a name='104'>
     &amp;                 ,WWST2=WWST*WWST<a name='105'>
<font color=#447700>!<a name='106'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='107'></font>
<font color=#447700>!***  FREE TERM IN THE EQUILIBRIUM EQUATION FOR (L/Q)**2<a name='108'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='109'></font>
<font color=#447700>!<a name='110'></font>
      REAL,PARAMETER :: AEQH=9.*A1*A2x*A2x*B1*BTG*BTG                   &amp;<a name='111'>
     &amp;                      +9.*A1*A2x*A2x*(12.*A1+3.*B2)*BTG*BTG       &amp;<a name='112'>
     &amp;                 ,AEQM=3.*A1*A2x*B1*(3.*A2x+3.*B2*C1+18.*A1*C1-B2)&amp;<a name='113'>
     &amp;                      *BTG+18.*A1*A1*A2x*(B2-3.*A2x)*BTG<a name='114'>
<font color=#447700>!<a name='115'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='116'></font>
<font color=#447700>!***  FORBIDDEN TURBULENCE AREA<a name='117'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='118'></font>
<font color=#447700>!<a name='119'></font>
      REAL,PARAMETER :: REQU=-AEQH/AEQM                                 &amp;<a name='120'>
     &amp;                 ,EPSGH=1.E-9,EPSGM=REQU*EPSGH<a name='121'>
<font color=#447700>!<a name='122'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='123'></font>
<font color=#447700>!***  NEAR ISOTROPY FOR SHEAR TURBULENCE, WW/Q2 LOWER LIMIT<a name='124'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='125'></font>
<font color=#447700>! <a name='126'></font>
      REAL,PARAMETER :: UBRYL=(18.*REQU*A1*A1*A2x*B2*C1*BTG             &amp;<a name='127'>
     &amp;                         +9.*A1*A2x*A2x*B2*BTG*BTG)               &amp;<a name='128'>
     &amp;                        /(REQU*ADNM+ADNH)                         &amp;<a name='129'>
     &amp;                 ,UBRY=(1.+EPSRS)*UBRYL,UBRY3=3.*UBRY<a name='130'>
<font color=#447700>!<a name='131'></font>
      REAL,PARAMETER :: AUBH=27.*A1*A2x*A2x*B2*BTG*BTG-ADNH*UBRY3       &amp;<a name='132'>
     &amp;                 ,AUBM=54.*A1*A1*A2x*B2*C1*BTG -ADNM*UBRY3        &amp;<a name='133'>
     &amp;                 ,BUBH=(9.*A1*A2x+3.*A2x*B2)*BTG-BDNH*UBRY3       &amp;<a name='134'>
     &amp;                 ,BUBM=18.*A1*A1*C1           -BDNM*UBRY3         &amp;<a name='135'>
     &amp;                 ,CUBR=1.                     -     UBRY3         &amp;<a name='136'>
     &amp;                 ,RCUBR=1./CUBR<a name='137'>
<font color=#447700>!<a name='138'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='139'></font>
<font color=#447700>!<a name='140'></font>
      CONTAINS<a name='141'>
<font color=#447700>!<a name='142'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='143'></font>
<A NAME='QNSEPBL'><A href='../../html_code/phys/module_bl_qnsepbl.F.html#QNSEPBL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='144'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>QNSEPBL</font>(DT,STEPBL,HT,DZ                                &amp; <A href='../../call_to/QNSEPBL.html' TARGET='index'>1</A>,<A href='../../call_from/QNSEPBL.html' TARGET='index'>6</A><a name='145'>
     &amp;                 ,PMID,PINT,TH,T,EXNER,QV,CWM,U,V,RHO            &amp;<a name='146'>
     &amp;                 ,TSK,QSFC,CHKLOWQ,THZ0,QZ0,UZ0,VZ0,CORF         &amp;<a name='147'>
     &amp;                 ,LOWLYR,XLAND,SICE,SNOW                         &amp;<a name='148'>
     &amp;                 ,TKE,EXCH_H,EXCH_M,USTAR,ZNT,EL_MYJ,PBLH,KPBL,CT &amp;<a name='149'>
     &amp;                 ,AKHS,AKMS,ELFLX,HFX                            &amp; <font color=#447700>!JP HFX<a name='150'></font>
     &amp;                 ,LM_BL89,WTHV_MF                                        &amp;<a name='151'>
     &amp;                 ,RUBLTEN,RVBLTEN,RTHBLTEN,RQVBLTEN,RQCBLTEN     &amp;<a name='152'>
     &amp;                 ,IDS,IDE,JDS,JDE,KDS,KDE                        &amp;<a name='153'>
     &amp;                 ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='154'>
     &amp;                 ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='155'>
<font color=#447700>!----------------------------------------------------------------------<a name='156'></font>
<font color=#447700>!<a name='157'></font>
      IMPLICIT NONE<a name='158'>
<font color=#447700>!<a name='159'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='160'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='161'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='162'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='163'>
<font color=#447700>!<a name='164'></font>
      INTEGER,INTENT(IN) :: STEPBL<a name='165'>
<a name='166'>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: LOWLYR<a name='167'>
<font color=#447700>!<a name='168'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: KPBL<a name='169'>
<font color=#447700>!<a name='170'></font>
      REAL,INTENT(IN) :: DT<a name='171'>
<font color=#447700>!<a name='172'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: HT,SICE,SNOW       &amp;<a name='173'>
     &amp;                                             ,TSK,XLAND,HFX  <a name='174'>
<font color=#447700>!<a name='175'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: CWM,DZ     &amp;<a name='176'>
     &amp;                                                     ,EXNER      &amp;<a name='177'>
     &amp;                                                     ,PMID,PINT  &amp;<a name='178'>
     &amp;                                                     ,QV,RHO     &amp;<a name='179'>
     &amp;                                                     ,T,TH,U,V    <a name='180'>
<a name='181'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN),OPTIONAL ::   &amp;<a name='182'>
     &amp;                                                      WTHV_MF    &amp;<a name='183'>
     &amp;                                                     ,LM_BL89 <a name='184'>
<font color=#447700>!<a name='185'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: PBLH<a name='186'>
<font color=#447700>!<a name='187'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: AKHS,AKMS<a name='188'>
<font color=#447700>!<a name='189'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME)                          &amp;<a name='190'>
     &amp;    ,INTENT(OUT) ::                                   EL_MYJ<a name='191'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME)                          &amp;<a name='192'>
     &amp;    ,INTENT(INOUT) ::                    RQCBLTEN,RQVBLTEN       &amp;<a name='193'>
     &amp;                                        ,RTHBLTEN                &amp;<a name='194'>
     &amp;                                        ,RUBLTEN,RVBLTEN        <a name='195'>
<font color=#447700>!<a name='196'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: CT,QSFC,QZ0     &amp;<a name='197'>
     &amp;                                                ,THZ0,USTAR      &amp;<a name='198'>
     &amp;                                                ,UZ0,VZ0,ZNT<a name='199'>
<font color=#447700>!<a name='200'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME)                          &amp;<a name='201'>
     &amp;    ,INTENT(INOUT) ::                    EXCH_H,EXCH_M,TKE<a name='202'>
<font color=#447700>!<a name='203'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: CHKLOWQ,ELFLX,CORF<a name='204'>
<font color=#447700>!<a name='205'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='206'></font>
<font color=#447700>!***<a name='207'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='208'></font>
<font color=#447700>!***<a name='209'></font>
      INTEGER :: I,J,K,KFLIP,LLOW,LMH,LMXL<a name='210'>
<font color=#447700>!<a name='211'></font>
      INTEGER,DIMENSION(ITS:ITE,JTS:JTE) :: LPBL<a name='212'>
<font color=#447700>!<a name='213'></font>
      REAL :: AKHS_DENS,AKMS_DENS,APEX,DCDT,DELTAZ,DQDT,DTDIF,DTDT     &amp;<a name='214'>
     &amp;       ,DTTURBL,DUDT,DVDT,EXNSFC,PSFC,PTOP,QFC1,QLOW,QOLD        &amp;<a name='215'>
     &amp;       ,RATIOMX,RDTTURBL,RG,RWMSK,SEAMASK,THNEW,THOLD,TX         &amp;<a name='216'>
     &amp;       ,ULOW,VLOW,WMSK,RLOW <a name='217'>
<font color=#447700>!<a name='218'></font>
      REAL,DIMENSION(KTS:KTE) :: CWMK,PK,Q2K,QK,THEK,TK,UK,VK,&amp;<a name='219'>
                                WTHV_MFK,LM_BL89K<a name='220'>
<font color=#447700>!<a name='221'></font>
      REAL,DIMENSION(KTS:KTE-1) :: AKHK,AKMK,EL,RI,GH,S2<a name='222'>
<font color=#447700>!<a name='223'></font>
      REAL,DIMENSION(KTS:KTE+1) :: ZHK<a name='224'>
<font color=#447700>!<a name='225'></font>
      REAL,DIMENSION(ITS:ITE,JTS:JTE) :: THSK<a name='226'>
<font color=#447700>!<a name='227'></font>
      REAL,DIMENSION(KTS:KTE,ITS:ITE) :: RHOK<a name='228'>
<font color=#447700>!<a name='229'></font>
      REAL,DIMENSION(ITS:ITE,KTS:KTE,JTS:JTE) :: APE,THE<a name='230'>
<font color=#447700>!<a name='231'></font>
      REAL,DIMENSION(ITS:ITE,KTS:KTE-1,JTS:JTE) :: AKH,AKM<a name='232'>
<font color=#447700>!<a name='233'></font>
      REAL,DIMENSION(ITS:ITE,KTS:KTE+1,JTS:JTE) :: ZINT<a name='234'>
<font color=#447700>!<a name='235'></font>
<font color=#447700>!***  Begin debugging<a name='236'></font>
      REAL :: ZSL_DIAG<a name='237'>
      INTEGER :: IMD,JMD,PRINT_DIAG<a name='238'>
<font color=#447700>!***  End debugging<a name='239'></font>
<font color=#447700>!<a name='240'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='241'></font>
<font color=#447700>!**********************************************************************<a name='242'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='243'></font>
<font color=#447700>!<a name='244'></font>
<font color=#447700>!***  Begin debugging<a name='245'></font>
      IMD=(IMS+IME)/2<a name='246'>
      JMD=(JMS+JME)/2<a name='247'>
<font color=#447700>!***  End debugging<a name='248'></font>
<font color=#447700>!<a name='249'></font>
<font color=#447700>!***  MAKE PREPARATIONS<a name='250'></font>
<font color=#447700>!<a name='251'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='252'></font>
      DTTURBL=DT*STEPBL<a name='253'>
      RDTTURBL=1./DTTURBL<a name='254'>
      DTDIF=DTTURBL<a name='255'>
      RG=1./G<a name='256'>
<font color=#447700>!<a name='257'></font>
      DO J=JTS,JTE<a name='258'>
      DO K=KTS,KTE-1<a name='259'>
      DO I=ITS,ITE<a name='260'>
        AKM(I,K,J)=0.<a name='261'>
      ENDDO<a name='262'>
      ENDDO<a name='263'>
      ENDDO<a name='264'>
<font color=#447700>!<a name='265'></font>
      DO J=JTS,JTE<a name='266'>
      DO K=KTS,KTE+1<a name='267'>
      DO I=ITS,ITE<a name='268'>
        ZINT(I,K,J)=0.<a name='269'>
      ENDDO<a name='270'>
      ENDDO<a name='271'>
      ENDDO<a name='272'>
<font color=#447700>!<a name='273'></font>
      DO J=JTS,JTE<a name='274'>
      DO I=ITS,ITE<a name='275'>
        ZINT(I,KTE+1,J)=HT(I,J)     <font color=#447700>! Z at bottom of lowest sigma layer<a name='276'></font>
<font color=#447700>!<a name='277'></font>
<font color=#447700>!!!!!!!!!<a name='278'></font>
<font color=#447700>!!!!!! UNCOMMENT THESE LINES IF USING ETA COORDINATES<a name='279'></font>
<font color=#447700>!!!!!!!!!<a name='280'></font>
<font color=#447700>!!!!!!  ZINT(I,KTE+1,J)=1.E-4       ! Z of bottom of lowest eta layer<a name='281'></font>
<font color=#447700>!!!!!!  ZHK(KTE+1)=1.E-4            ! Z of bottom of lowest eta layer<a name='282'></font>
<font color=#447700>!<a name='283'></font>
      ENDDO<a name='284'>
      ENDDO<a name='285'>
<font color=#447700>!<a name='286'></font>
      DO J=JTS,JTE<a name='287'>
      DO K=KTE,KTS,-1<a name='288'>
        KFLIP=KTE+1-K<a name='289'>
        DO I=ITS,ITE<a name='290'>
          ZINT(I,K,J)=ZINT(I,K+1,J)+DZ(I,KFLIP,J)<a name='291'>
          APEX=1./EXNER(I,K,J)<a name='292'>
          APE(I,K,J)=APEX<a name='293'>
          TX=T(I,K,J)<a name='294'>
          THE(I,K,J)=(CWM(I,K,J)*(-ELOCP/TX)+1.)*TH(I,K,J)<a name='295'>
        ENDDO<a name='296'>
      ENDDO<a name='297'>
      ENDDO<a name='298'>
<font color=#447700>!<a name='299'></font>
      EL_MYJ(its:ite,:,jts:jte) = 0.<a name='300'>
<font color=#447700>!<a name='301'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='302'></font>
      setup_integration:  DO J=JTS,JTE<a name='303'>
<font color=#447700>!----------------------------------------------------------------------<a name='304'></font>
<font color=#447700>!<a name='305'></font>
        DO I=ITS,ITE<a name='306'>
<font color=#447700>!<a name='307'></font>
<font color=#447700>!***  LOWEST LAYER ABOVE GROUND MUST BE FLIPPED<a name='308'></font>
<font color=#447700>!<a name='309'></font>
          LMH=KTE-LOWLYR(I,J)+1<a name='310'>
<font color=#447700>!<a name='311'></font>
          PTOP=PINT(I,KTE+1,J)      <font color=#447700>! KTE+1=KME<a name='312'></font>
          PSFC=PINT(I,LOWLYR(I,J),J)<a name='313'>
<font color=#447700>!<a name='314'></font>
<font color=#447700>!***  CONVERT LAND MASK (1 FOR SEA; 0 FOR LAND)<a name='315'></font>
<font color=#447700>!<a name='316'></font>
          SEAMASK=XLAND(I,J)-1.<a name='317'>
<font color=#447700>!<a name='318'></font>
<font color=#447700>!***  FILL 1-D VERTICAL ARRAYS<a name='319'></font>
<font color=#447700>!***  AND FLIP DIRECTION SINCE MYJ SCHEME<a name='320'></font>
<font color=#447700>!***  COUNTS DOWNWARD FROM THE DOMAIN'S TOP<a name='321'></font>
<font color=#447700>!<a name='322'></font>
          DO K=KTE,KTS,-1<a name='323'>
            KFLIP=KTE+1-K<a name='324'>
            TK(K)=T(I,KFLIP,J)<a name='325'>
            THEK(K)=THE(I,KFLIP,J)<a name='326'>
            RATIOMX=QV(I,KFLIP,J)<a name='327'>
            QK(K)=RATIOMX/(1.+RATIOMX)<a name='328'>
            CWMK(K)=CWM(I,KFLIP,J)<a name='329'>
            PK(K)=PMID(I,KFLIP,J)<a name='330'>
            UK(K)=U(I,KFLIP,J)<a name='331'>
            VK(K)=V(I,KFLIP,J)<a name='332'>
<font color=#447700>!<a name='333'></font>
<font color=#447700>!***  TKE=0.5*(q**2) ==&gt; q**2=2.*TKE<a name='334'></font>
<font color=#447700>!<a name='335'></font>
            Q2K(K)=2.*TKE(I,KFLIP,J)<a name='336'>
<a name='337'>
<font color=#447700>!****  buoyancy flux of mass flux shallow convection scheme<a name='338'></font>
<font color=#447700>!<a name='339'></font>
            IF ( PRESENT (WTHV_MF) .AND. PRESENT (LM_BL89) ) THEN<a name='340'>
              WTHV_MFK(K)=WTHV_MF(I,KFLIP,J)<a name='341'>
              LM_BL89K(K)=LM_BL89(I,KFLIP,J)<a name='342'>
            ELSE<a name='343'>
              WTHV_MFK(K)=0.<a name='344'>
              LM_BL89K(K)=0.<a name='345'>
            ENDIF<a name='346'>
<a name='347'>
<font color=#447700>!***  COMPUTE THE HEIGHTS OF THE LAYER INTERFACES<a name='348'></font>
<font color=#447700>!<a name='349'></font>
            ZHK(K)=ZINT(I,K,J)<a name='350'>
<font color=#447700>!<a name='351'></font>
          ENDDO<a name='352'>
          ZHK(KTE+1)=HT(I,J)          <font color=#447700>! Z at bottom of lowest sigma layer<a name='353'></font>
<font color=#447700>!<a name='354'></font>
<font color=#447700>!***  Begin debugging<a name='355'></font>
<font color=#447700>!         IF(I==IMD.AND.J==JMD)THEN<a name='356'></font>
<font color=#447700>!           PRINT_DIAG=1<a name='357'></font>
<font color=#447700>!         ELSE<a name='358'></font>
<font color=#447700>!           PRINT_DIAG=0<a name='359'></font>
<font color=#447700>!         ENDIF<a name='360'></font>
<font color=#447700>!         IF(I==227.AND.J==363)PRINT_DIAG=2<a name='361'></font>
<font color=#447700>!***  End debugging<a name='362'></font>
<font color=#447700>!<a name='363'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='364'></font>
<font color=#447700>!***<a name='365'></font>
<font color=#447700>!***  FIND THE MIXING LENGTH<a name='366'></font>
<font color=#447700>!***<a name='367'></font>
          CALL <A href='../../html_code/phys/module_bl_shinhong.F.html#MIXLEN'>MIXLEN</A><A href='../../html_code/phys/module_bl_qnsepbl.F.html#QNSEPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MIXLEN_3">(LMH,UK,VK,TK,THEK,QK,CWMK                        &amp;<a name='368'>
     &amp;               ,Q2K,ZHK,USTAR(I,J),CORF(I,J),S2,GH,RI,EL         &amp;<a name='369'>
     &amp;               ,PBLH(I,J),LPBL(I,J),LMXL,CT(I,J),LM_BL89K        &amp;<a name='370'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                          &amp;<a name='371'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                          &amp;<a name='372'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='373'>
<font color=#447700>!<a name='374'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='375'></font>
<font color=#447700>!*** THE MODEL LAYER (COUNTING UPWARD) CONTAINING THE TOP OF THE PBL<a name='376'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='377'></font>
<font color=#447700>!<a name='378'></font>
          KPBL(I,J)=KTE-LPBL(I,J)+1<a name='379'>
<font color=#447700>!<a name='380'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='381'></font>
<font color=#447700>!***<a name='382'></font>
<font color=#447700>!***  FIND THE QNSE EXCHANGE COEFFICIENTS<a name='383'></font>
<font color=#447700>!***<a name='384'></font>
          CALL <A href='../../html_code/phys/module_bl_qnsepbl.F.html#DIFCOF'>DIFCOF</A><A href='../../html_code/phys/module_bl_qnsepbl.F.html#QNSEPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIFCOF_3">(LMH,EL,RI,Q2K,ZHK,AKMK,AKHK                      &amp;<a name='385'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                          &amp;<a name='386'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                          &amp;<a name='387'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE,PRINT_DIAG)   <font color=#447700>! debug<a name='388'></font>
<font color=#447700>!<a name='389'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='390'></font>
<font color=#447700>!***  COUNTING DOWNWARD FROM THE TOP, THE EXCHANGE COEFFICIENTS AKH <a name='391'></font>
<font color=#447700>!***  ARE DEFINED ON THE BOTTOMS OF THE LAYERS KTS TO KTE-1.  COUNTING <a name='392'></font>
<font color=#447700>!***  COUNTING UPWARD FROM THE BOTTOM, THOSE SAME COEFFICIENTS EXCH_H<a name='393'></font>
<font color=#447700>!***  ARE DEFINED ON THE TOPS OF THE LAYERS KTS TO KTE-1.<a name='394'></font>
<font color=#447700>!<a name='395'></font>
          DO K=KTS,KTE-1<a name='396'>
            KFLIP=KTE-K<a name='397'>
            AKH(I,K,J)=AKHK(K)<a name='398'>
            AKM(I,K,J)=AKMK(K)<a name='399'>
            DELTAZ=0.5*(ZHK(KFLIP)-ZHK(KFLIP+2))<a name='400'>
            EXCH_H(I,K+1,J)=AKHK(KFLIP)*DELTAZ<a name='401'>
            EXCH_M(I,K+1,J)=AKMK(KFLIP)*DELTAZ<a name='402'>
          ENDDO<a name='403'>
<font color=#447700>!<a name='404'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='405'></font>
<font color=#447700>!***<a name='406'></font>
<font color=#447700>!***  SOLVE FOR THE PRODUCTION/DISSIPATION OF<a name='407'></font>
<font color=#447700>!***  THE TURBULENT KINETIC ENERGY<a name='408'></font>
<font color=#447700>!***<a name='409'></font>
<font color=#447700>!<a name='410'></font>
          CALL <A href='../../html_code/phys/module_bl_shinhong.F.html#PRODQ2'>PRODQ2</A><A href='../../html_code/phys/module_bl_qnsepbl.F.html#QNSEPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PRODQ2_3">(LMH,DTTURBL,USTAR(I,J),S2,RI,Q2K,EL,ZHK,AKMK,AKHK &amp;<a name='411'>
     &amp;               ,WTHV_MFK,IDS,IDE,JDS,JDE,KDS,KDE                  &amp;<a name='412'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='413'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='414'>
<font color=#447700>!<a name='415'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='416'></font>
<font color=#447700>!***<a name='417'></font>
<font color=#447700>!***  CARRY OUT THE VERTICAL DIFFUSION OF<a name='418'></font>
<font color=#447700>!***  TURBULENT KINETIC ENERGY<a name='419'></font>
<font color=#447700>!***<a name='420'></font>
<font color=#447700>!<a name='421'></font>
          CALL <A href='../../html_code/phys/module_bl_shinhong.F.html#VDIFQ'>VDIFQ</A><A href='../../html_code/phys/module_bl_qnsepbl.F.html#QNSEPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VDIFQ_3">(LMH,DTDIF,Q2K,EL,ZHK                              &amp;<a name='422'>
     &amp;              ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='423'>
     &amp;              ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='424'>
     &amp;              ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='425'>
<font color=#447700>!<a name='426'></font>
<font color=#447700>!***  SAVE THE NEW TKE AND MIXING LENGTH.<a name='427'></font>
<font color=#447700>!<a name='428'></font>
          DO K=KTS,KTE<a name='429'>
            KFLIP=KTE+1-K<a name='430'>
            Q2K(KFLIP)=AMAX1(Q2K(KFLIP),EPSQ2L)<a name='431'>
            TKE(I,K,J)=0.5*Q2K(KFLIP)<a name='432'>
            IF(KFLIP/=KTE)EL_MYJ(I,K,J)=EL(KFLIP)   <font color=#447700>! EL IS NOT DEFINED AT KTE<a name='433'></font>
          ENDDO<a name='434'>
<font color=#447700>!<a name='435'></font>
        ENDDO<a name='436'>
<font color=#447700>!<a name='437'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='438'></font>
      ENDDO setup_integration<a name='439'>
<font color=#447700>!----------------------------------------------------------------------<a name='440'></font>
<font color=#447700>!<a name='441'></font>
<font color=#447700>!***  CONVERT SURFACE SENSIBLE TEMPERATURE TO POTENTIAL TEMPERATURE.<a name='442'></font>
<font color=#447700>!<a name='443'></font>
<a name='444'>
      DO J=JTS,JTE<a name='445'>
      DO I=ITS,ITE<a name='446'>
        PSFC=PINT(I,LOWLYR(I,J),J)<a name='447'>
        RLOW=PSFC/(R_D*T(I,1,J))          <a name='448'>
<a name='449'>
        THSK(I,J)=THZ0(I,J)<a name='450'>
        THSK(I,J)=HFX(I,J)/(AKHS(I,J)*RLOW*CP)+TH(I,1,J)<a name='451'>
<a name='452'>
      ENDDO<a name='453'>
      ENDDO<a name='454'>
<a name='455'>
<a name='456'>
<font color=#447700>!<a name='457'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='458'></font>
<font color=#447700>!<a name='459'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='460'></font>
      main_integration:  DO J=JTS,JTE<a name='461'>
<font color=#447700>!----------------------------------------------------------------------<a name='462'></font>
<font color=#447700>!<a name='463'></font>
        DO I=ITS,ITE<a name='464'>
<font color=#447700>!<a name='465'></font>
<font color=#447700>!***  FILL 1-D VERTICAL ARRAYS<a name='466'></font>
<font color=#447700>!***  AND FLIP DIRECTION SINCE MYJ SCHEME<a name='467'></font>
<font color=#447700>!***  COUNTS DOWNWARD FROM THE DOMAIN'S TOP<a name='468'></font>
<font color=#447700>!<a name='469'></font>
          DO K=KTE,KTS,-1<a name='470'>
            KFLIP=KTE+1-K<a name='471'>
            THEK(K)=THE(I,KFLIP,J)<a name='472'>
            RATIOMX=QV(I,KFLIP,J)<a name='473'>
            QK(K)=RATIOMX/(1.+RATIOMX)<a name='474'>
            CWMK(K)=CWM(I,KFLIP,J)<a name='475'>
            ZHK(K)=ZINT(I,K,J)<a name='476'>
            RHOK(K,I)=PMID(I,KFLIP,J)/(R_D*T(I,KFLIP,J)*               &amp;<a name='477'>
     &amp;                                (1.+P608*QK(K)-CWMK(K)))<a name='478'>
          ENDDO<a name='479'>
<font color=#447700>!<a name='480'></font>
<font color=#447700>!***  COUNTING DOWNWARD FROM THE TOP, THE EXCHANGE COEFFICIENTS AKH<a name='481'></font>
<font color=#447700>!***  ARE DEFINED ON THE BOTTOMS OF THE LAYERS KTS TO KTE-1.  THESE COEFFICIENTS<a name='482'></font>
<font color=#447700>!***  ARE ALSO MULTIPLIED BY THE DENSITY AT THE BOTTOM INTERFACE LEVEL.<a name='483'></font>
<font color=#447700>!<a name='484'></font>
          DO K=KTS,KTE-1<a name='485'>
            AKHK(K)=AKH(I,K,J)*0.5*(RHOK(K,I)+RHOK(K+1,I))<a name='486'>
          ENDDO<a name='487'>
<font color=#447700>!<a name='488'></font>
          ZHK(KTE+1)=ZINT(I,KTE+1,J)<a name='489'>
<font color=#447700>!<a name='490'></font>
          SEAMASK=XLAND(I,J)-1.<a name='491'>
          THZ0(I,J)=(1.-SEAMASK)*THSK(I,J)+SEAMASK*THZ0(I,J)<a name='492'>
<font color=#447700>!<a name='493'></font>
          LLOW=LOWLYR(I,J)<a name='494'>
          AKHS_DENS=AKHS(I,J)*RHOK(KTE+1-LLOW,I)<a name='495'>
<font color=#447700>!<a name='496'></font>
          IF(SEAMASK&lt;0.5)THEN<a name='497'>
            QFC1=XLV*CHKLOWQ(I,J)*AKHS_DENS<a name='498'>
<font color=#447700>!<a name='499'></font>
            IF(SNOW(I,J)&gt;0..OR.SICE(I,J)&gt;0.5)THEN<a name='500'>
              QFC1=QFC1*RLIVWV<a name='501'>
            ENDIF<a name='502'>
<font color=#447700>!<a name='503'></font>
            IF(QFC1&gt;0.)THEN<a name='504'>
              QLOW=QK(KTE+1-LLOW)<a name='505'>
              QSFC(I,J)=QLOW+ELFLX(I,J)/QFC1<a name='506'>
            ENDIF<a name='507'>
<font color=#447700>!<a name='508'></font>
          ELSE<a name='509'>
            PSFC=PINT(I,LOWLYR(I,J),J)<a name='510'>
            EXNSFC=(1.E5/PSFC)**CAPA<a name='511'>
            QSFC(I,J)=PQ0SEA/PSFC                                      &amp;<a name='512'>
     &amp;         *EXP(A2*(THSK(I,J)-A3*EXNSFC)/(THSK(I,J)-A4*EXNSFC))<a name='513'>
          ENDIF<a name='514'>
<font color=#447700>!<a name='515'></font>
          QZ0 (I,J)=(1.-SEAMASK)*QSFC(I,J)+SEAMASK*QZ0 (I,J)<a name='516'>
<font color=#447700>!<a name='517'></font>
<font color=#447700>!***  LOWEST LAYER ABOVE GROUND MUST BE FLIPPED<a name='518'></font>
<font color=#447700>!<a name='519'></font>
          LMH=KTE-LOWLYR(I,J)+1<a name='520'>
<font color=#447700>!<a name='521'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='522'></font>
<font color=#447700>!***  CARRY OUT THE VERTICAL DIFFUSION OF<a name='523'></font>
<font color=#447700>!***  TEMPERATURE AND WATER VAPOR<a name='524'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='525'></font>
<font color=#447700>!<a name='526'></font>
          CALL <A href='../../html_code/phys/module_bl_qnsepbl.F.html#VDIFH'>VDIFH</A><A href='../../html_code/phys/module_bl_qnsepbl.F.html#QNSEPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VDIFH_3">(DTDIF,LMH,THZ0(I,J),QZ0(I,J)                      &amp;<a name='527'>
     &amp;              ,AKHS_DENS,CHKLOWQ(I,J),CT(I,J)                    &amp;<a name='528'>
     &amp;              ,THEK,QK,CWMK,AKHK,ZHK,RHOK(KTS,I)                 &amp;<a name='529'>
     &amp;              ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='530'>
     &amp;              ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='531'>
     &amp;              ,ITS,ITE,JTS,JTE,KTS,KTE,I,J)<a name='532'>
<font color=#447700>!----------------------------------------------------------------------<a name='533'></font>
<font color=#447700>!***<a name='534'></font>
<font color=#447700>!***  COMPUTE PRIMARY VARIABLE TENDENCIES<a name='535'></font>
<font color=#447700>!***<a name='536'></font>
          DO K=KTS,KTE<a name='537'>
            KFLIP=KTE+1-K<a name='538'>
            THOLD=TH(I,K,J)<a name='539'>
            THNEW=THEK(KFLIP)+CWMK(KFLIP)*ELOCP*APE(I,K,J)<a name='540'>
            DTDT=(THNEW-THOLD)*RDTTURBL<a name='541'>
            QOLD=QV(I,K,J)/(1.+QV(I,K,J))<a name='542'>
            DQDT=(QK(KFLIP)-QOLD)*RDTTURBL<a name='543'>
            DCDT=(CWMK(KFLIP)-CWM(I,K,J))*RDTTURBL<a name='544'>
<font color=#447700>!<a name='545'></font>
            RTHBLTEN(I,K,J)=DTDT + RTHBLTEN(I,K,J)<a name='546'>
            RQVBLTEN(I,K,J)=DQDT/(1.-QK(KFLIP))**2 + RQVBLTEN(I,K,J)<a name='547'>
            RQCBLTEN(I,K,J)=DCDT + RQCBLTEN(I,K,J)<a name='548'>
          ENDDO<a name='549'>
<font color=#447700>!<a name='550'></font>
<font color=#447700>!*** Begin debugging<a name='551'></font>
<font color=#447700>!         IF(I==IMD.AND.J==JMD)THEN<a name='552'></font>
<font color=#447700>!           PRINT_DIAG=0<a name='553'></font>
<font color=#447700>!         ELSE<a name='554'></font>
<font color=#447700>!           PRINT_DIAG=0<a name='555'></font>
<font color=#447700>!         ENDIF<a name='556'></font>
<font color=#447700>!         IF(I==227.AND.J==363)PRINT_DIAG=0<a name='557'></font>
<font color=#447700>!*** End debugging<a name='558'></font>
<font color=#447700>!<a name='559'></font>
        PSFC=.01*PINT(I,LOWLYR(I,J),J)<a name='560'>
        ZSL_DIAG=0.5*DZ(I,1,J)<a name='561'>
<font color=#447700>!<a name='562'></font>
<font color=#447700>!*** Begin debugging<a name='563'></font>
<font color=#447700>!         IF(PRINT_DIAG==1)THEN<a name='564'></font>
<font color=#447700>!<a name='565'></font>
<font color=#447700>!           write(6,"(a, 2i5, 2i3, 2f8.2, f6.2, 2f8.2)") &amp;<a name='566'></font>
<font color=#447700>!           '{turb4 i,j, Kpbl, Kmxl, Psfc, Zsfc, Zsl, Zpbl, Zmxl = ' &amp;<a name='567'></font>
<font color=#447700>!           , i, j, KPBL(i,j), KTE-LMXL+1, PSFC, ZHK(LMH+1), ZSL_diag  &amp;<a name='568'></font>
<font color=#447700>!           , PBLH(i,j), ZHK(LMXL)-ZHK(LMH+1)<a name='569'></font>
<font color=#447700>!           write(6,"(a, 2f7.2, f7.3, 3e11.4)") &amp;<a name='570'></font>
<font color=#447700>!           '{turb4 tsk, thsk, qz0, q**2_0, akhs, exch_0 = ' &amp;<a name='571'></font>
<font color=#447700>!           , tsk(i,j)-273.15, thsk(i,j), 1000.*qz0(i,j) &amp;<a name='572'></font>
<font color=#447700>!           , 2.*tke_myj(i,1,j), akhs(i,j), akhs(i,j)*ZSL_diag<a name='573'></font>
<font color=#447700>!           write(6,"(a)") &amp;<a name='574'></font>
<font color=#447700>!           '{turb5 k, Pmid, Pint_1, Tc, TH, DTH, GH, S2, EL, Q**2, Akh, EXCH_h, Dz, Dp'<a name='575'></font>
<font color=#447700>!           do k=kts,kte/2<a name='576'></font>
<font color=#447700>!             KFLIP=KTE-K   !-- Includes the KFLIP-1 in earlier versions<a name='577'></font>
<font color=#447700>!             write(6,"(a,i3, 2f8.2, 2f8.3, 3e12.4, 4e11.4, f7.2, f6.2)") &amp;<a name='578'></font>
<font color=#447700>!            '{turb5 ', k, .01*pmid(i,k,j),.01*pint(i,k,j), T(i,k,j)-273.15 &amp;<a name='579'></font>
<font color=#447700>!            , th(i,k,j), DTTURBL*rthblten(i,k,j), GH(KFLIP), S2(KFLIP) &amp;<a name='580'></font>
<font color=#447700>!            , el_myj(i,KFLIP,j), 2.*tke_myj(i,k+1,j), akh(i,KFLIP,j) &amp;<a name='581'></font>
<font color=#447700>!            , exch_h(i,k,j), dz(i,k,j), .01*(pint(i,k,j)-pint(i,k+1,j))<a name='582'></font>
<font color=#447700>!           enddo<a name='583'></font>
<font color=#447700>!<a name='584'></font>
<font color=#447700>!         ELSEIF(PRINT_DIAG==2)THEN<a name='585'></font>
<font color=#447700>!<a name='586'></font>
<font color=#447700>!           write(6,"(a, 2i5, 2i3, 2f8.2, f6.2, 2f8.2)") &amp;<a name='587'></font>
<font color=#447700>!           '}turb4 i,j, Kpbl, Kmxl, Psfc, Zsfc, Zsl, Zpbl, Zmxl = ' &amp;<a name='588'></font>
<font color=#447700>!           , i, j, KPBL(i,j), KTE-LMXL+1, PSFC, ZHK(LMH+1), ZSL_diag  &amp;<a name='589'></font>
<font color=#447700>!           , PBLH(i,j), ZHK(LMXL)-ZHK(LMH+1)<a name='590'></font>
<font color=#447700>!           write(6,"(a, 2f7.2, f7.3, 3e11.4)") &amp;<a name='591'></font>
<font color=#447700>!           '}turb4 tsk, thsk, qz0, q**2_0, akhs, exch_0 = ' &amp;<a name='592'></font>
<font color=#447700>!           , tsk(i,j)-273.15, thsk(i,j), 1000.*qz0(i,j) &amp;<a name='593'></font>
<font color=#447700>!           , 2.*tke_myj(i,1,j), akhs(i,j), akhs(i,j)*ZSL_diag<a name='594'></font>
<font color=#447700>!           write(6,"(a)") &amp;<a name='595'></font>
<font color=#447700>!           '}turb5 k, Pmid, Pint_1, Tc, TH, DTH, GH, S2, EL, Q**2, Akh, EXCH_h, Dz, Dp'<a name='596'></font>
<font color=#447700>!           do k=kts,kte/2<a name='597'></font>
<font color=#447700>!             KFLIP=KTE-K   !-- Includes the KFLIP-1 in earlier versions<a name='598'></font>
<font color=#447700>!             write(6,"(a,i3, 2f8.2, 2f8.3, 3e12.4, 4e11.4, f7.2, f6.2)") &amp;<a name='599'></font>
<font color=#447700>!            '}turb5 ', k, .01*pmid(i,k,j),.01*pint(i,k,j), T(i,k,j)-273.15 &amp;<a name='600'></font>
<font color=#447700>!            , th(i,k,j), DTTURBL*rthblten(i,k,j), GH(KFLIP), S2(KFLIP) &amp;<a name='601'></font>
<font color=#447700>!            , el_myj(i,KFLIP,j), 2.*tke_myj(i,k+1,j), akh(i,KFLIP,j) &amp;<a name='602'></font>
<font color=#447700>!            , exch_h(i,k,j), dz(i,k,j), .01*(pint(i,k,j)-pint(i,k+1,j))<a name='603'></font>
<font color=#447700>!           enddo<a name='604'></font>
<font color=#447700>!         ENDIF<a name='605'></font>
<font color=#447700>!*** End debugging<a name='606'></font>
<font color=#447700>!<a name='607'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='608'></font>
        ENDDO<a name='609'>
<font color=#447700>!----------------------------------------------------------------------<a name='610'></font>
        DO I=ITS,ITE<a name='611'>
<font color=#447700>!<a name='612'></font>
<font color=#447700>!***  FILL 1-D VERTICAL ARRAYS<a name='613'></font>
<font color=#447700>!***  AND FLIP DIRECTION SINCE MYJ SCHEME<a name='614'></font>
<font color=#447700>!***  COUNTS DOWNWARD FROM THE DOMAIN'S TOP<a name='615'></font>
<font color=#447700>!<a name='616'></font>
          DO K=KTS,KTE-1<a name='617'>
            AKMK(K)=AKM(I,K,J)<a name='618'>
            AKMK(K)=AKMK(K)*(RHOK(K,I)+RHOK(K+1,I))*0.5<a name='619'>
          ENDDO<a name='620'>
<font color=#447700>!<a name='621'></font>
          LLOW=LOWLYR(I,J)<a name='622'>
          AKMS_DENS=AKMS(I,J)*RHOK(KTE+1-LLOW,I)<a name='623'>
<font color=#447700>!<a name='624'></font>
          DO K=KTE,KTS,-1<a name='625'>
            KFLIP=KTE+1-K<a name='626'>
            UK(K)=U(I,KFLIP,J)<a name='627'>
            VK(K)=V(I,KFLIP,J)<a name='628'>
            ZHK(K)=ZINT(I,K,J)<a name='629'>
          ENDDO<a name='630'>
          ZHK(KTE+1)=ZINT(I,KTE+1,J)<a name='631'>
<font color=#447700>!<a name='632'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='633'></font>
<font color=#447700>!***  CARRY OUT THE VERTICAL DIFFUSION OF<a name='634'></font>
<font color=#447700>!***  VELOCITY COMPONENTS<a name='635'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='636'></font>
<font color=#447700>!<a name='637'></font>
          CALL <A href='../../html_code/phys/module_bl_qnsepbl.F.html#VDIFV'>VDIFV</A><A href='../../html_code/phys/module_bl_qnsepbl.F.html#QNSEPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VDIFV_3">(LMH,DTDIF,UZ0(I,J),VZ0(I,J)                       &amp;<a name='638'>
     &amp;              ,AKMS_DENS,UK,VK,AKMK,ZHK,RHOK(KTS,I)              &amp;<a name='639'>
     &amp;              ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='640'>
     &amp;              ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='641'>
     &amp;              ,ITS,ITE,JTS,JTE,KTS,KTE,I,J)<a name='642'>
<font color=#447700>!<a name='643'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='644'></font>
<font color=#447700>!***<a name='645'></font>
<font color=#447700>!***  COMPUTE PRIMARY VARIABLE TENDENCIES<a name='646'></font>
<font color=#447700>!***<a name='647'></font>
          DO K=KTS,KTE<a name='648'>
            KFLIP=KTE+1-K<a name='649'>
            DUDT=(UK(KFLIP)-U(I,K,J))*RDTTURBL<a name='650'>
            DVDT=(VK(KFLIP)-V(I,K,J))*RDTTURBL<a name='651'>
            RUBLTEN(I,K,J)=DUDT + RUBLTEN(I,K,J)<a name='652'>
            RVBLTEN(I,K,J)=DVDT + RVBLTEN(I,K,J)<a name='653'>
          ENDDO<a name='654'>
<font color=#447700>!<a name='655'></font>
        ENDDO<a name='656'>
<font color=#447700>!----------------------------------------------------------------------<a name='657'></font>
<font color=#447700>!<a name='658'></font>
      ENDDO main_integration<a name='659'>
<font color=#447700>!<a name='660'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='661'></font>
<font color=#447700>!<a name='662'></font>
      END SUBROUTINE QNSEPBL<a name='663'>
<font color=#447700>!<a name='664'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='665'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='666'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='667'></font>
<A NAME='MIXLEN'><A href='../../html_code/phys/module_bl_qnsepbl.F.html#MIXLEN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='668'>
                          <font color=#993300>SUBROUTINE </font><font color=#cc0000>MIXLEN</font>                            &amp; <A href='../../call_to/MIXLEN.html' TARGET='index'>4</A><a name='669'>
<font color=#447700>!----------------------------------------------------------------------<a name='670'></font>
<font color=#447700>!   ******************************************************************<a name='671'></font>
<font color=#447700>!   *                                                                *<a name='672'></font>
<font color=#447700>!   *                   LEVEL 2.5 MIXING LENGTH                      *<a name='673'></font>
<font color=#447700>!   *                                                                *<a name='674'></font>
<font color=#447700>!   ******************************************************************<a name='675'></font>
<font color=#447700>!<a name='676'></font>
     &amp;(LMH,U,V,T,THE,Q,CWM,Q2,Z,USTAR,CORF                             &amp;<a name='677'>
     &amp;,S2,GH,RI,EL,PBLH,LPBL,LMXL,CT,LM_BL89                           &amp;<a name='678'>
     &amp;,IDS,IDE,JDS,JDE,KDS,KDE                                         &amp;<a name='679'>
     &amp;,IMS,IME,JMS,JME,KMS,KME                                         &amp;<a name='680'>
     &amp;,ITS,ITE,JTS,JTE,KTS,KTE)<a name='681'>
<font color=#447700>!----------------------------------------------------------------------<a name='682'></font>
<font color=#447700>!<a name='683'></font>
      IMPLICIT NONE<a name='684'>
<font color=#447700>!<a name='685'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='686'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='687'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='688'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='689'>
<font color=#447700>!<a name='690'></font>
      INTEGER,INTENT(IN) :: LMH<a name='691'>
<font color=#447700>!<a name='692'></font>
      INTEGER,INTENT(OUT) :: LMXL,LPBL<a name='693'>
<font color=#447700>!<a name='694'></font>
      REAL,DIMENSION(KTS:KTE),INTENT(IN) :: CWM,Q,Q2,T,THE,U,V,LM_BL89<a name='695'>
<font color=#447700>!<a name='696'></font>
      REAL,DIMENSION(KTS:KTE+1),INTENT(IN) :: Z<a name='697'>
<font color=#447700>!<a name='698'></font>
      REAL,INTENT(OUT) :: PBLH<a name='699'>
<font color=#447700>!<a name='700'></font>
      REAL,DIMENSION(KTS:KTE-1),INTENT(OUT) :: EL,RI,GH,S2<a name='701'>
<font color=#447700>!<a name='702'></font>
      REAL,INTENT(INOUT) :: CT<a name='703'>
<font color=#447700>!<a name='704'></font>
      REAL,INTENT(IN) :: CORF,USTAR<a name='705'>
<font color=#447700>!----------------------------------------------------------------------<a name='706'></font>
<font color=#447700>!***<a name='707'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='708'></font>
<font color=#447700>!***<a name='709'></font>
      INTEGER :: K,LPBLM<a name='710'>
<font color=#447700>!<a name='711'></font>
      REAL :: A,ADEN,B,BDEN,AUBR,BUBR,BLMX,EL0,ELOQ2X,GHL,S2L          &amp;<a name='712'>
     &amp;       ,QOL2ST,QOL2UN,QDZL,RDZ,SQ,SREL,SZQ,TEM,THM,VKRMZ,RLAMBDA &amp;<a name='713'>
     &amp;       ,RLB,RLN,F<a name='714'>
<font color=#447700>!<a name='715'></font>
      REAL,DIMENSION(KTS:KTE) :: Q1,EN2<a name='716'>
<font color=#447700>!<a name='717'></font>
      REAL,DIMENSION(KTS:KTE-1) :: DTH,ELM,REL<a name='718'>
<font color=#447700>!<a name='719'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='720'></font>
<font color=#447700>!**********************************************************************<a name='721'></font>
<font color=#447700>!--------------FIND THE HEIGHT OF THE PBL-------------------------------<a name='722'></font>
      LPBL=LMH<a name='723'>
<font color=#447700>!<a name='724'></font>
      DO K=LMH-1,1,-1<a name='725'>
        IF(Q2(K)&lt;=EPSQ2L*FH)THEN<a name='726'>
          LPBL=K<a name='727'>
          GO TO 110<a name='728'>
        ENDIF<a name='729'>
      ENDDO<a name='730'>
<font color=#447700>!<a name='731'></font>
      LPBL=1<a name='732'>
<font color=#447700>!<a name='733'></font>
<font color=#447700>!--------------THE HEIGHT OF THE PBL------------------------------------<a name='734'></font>
<font color=#447700>!<a name='735'></font>
 110  PBLH=Z(LPBL)-Z(LMH+1)<a name='736'>
<font color=#447700>!<a name='737'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='738'></font>
      DO K=KTS,LMH<a name='739'>
        Q1(K)=0.<a name='740'>
      ENDDO<a name='741'>
<font color=#447700>!<a name='742'></font>
      DO K=1,LMH-1<a name='743'>
        DTH(K)=THE(K)-THE(K+1)<a name='744'>
      ENDDO<a name='745'>
<font color=#447700>!<a name='746'></font>
      DO K=LMH-2,1,-1<a name='747'>
        IF(DTH(K)&gt;0..AND.DTH(K+1)&lt;=0.)THEN<a name='748'>
          DTH(K)=DTH(K)+CT<a name='749'>
          EXIT<a name='750'>
        ENDIF<a name='751'>
      ENDDO<a name='752'>
<font color=#447700>!<a name='753'></font>
      CT=0.<a name='754'>
<font color=#447700>!----------------------------------------------------------------------<a name='755'></font>
<font color=#447700>!***  COMPUTE LOCAL GRADIENT RICHARDSON NUMBER <a name='756'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='757'></font>
      DO K=KTS,LMH-1<a name='758'>
        RDZ=2./(Z(K)-Z(K+2))<a name='759'>
        S2L=((U(K)-U(K+1))**2+(V(K)-V(K+1))**2)*RDZ*RDZ   <font color=#447700>! S**2<a name='760'></font>
        S2L=MAX(S2L,EPSGM)<a name='761'>
        S2(K)=S2L<a name='762'>
<font color=#447700>!<a name='763'></font>
        TEM=(T(K)+T(K+1))*0.5<a name='764'>
        THM=(THE(K)+THE(K+1))*0.5<a name='765'>
<font color=#447700>!<a name='766'></font>
        A=THM*P608<a name='767'>
        B=(ELOCP/TEM-1.-P608)*THM<a name='768'>
<font color=#447700>!<a name='769'></font>
        GHL=(DTH(K)*((Q(K)+Q(K+1)+CWM(K)+CWM(K+1))*(0.5*P608)+1.)      &amp;<a name='770'>
     &amp;     +(Q(K)-Q(K+1)+CWM(K)-CWM(K+1))*A                            &amp;<a name='771'>
     &amp;     +(CWM(K)-CWM(K+1))*B)*RDZ                       <font color=#447700>! dTheta/dz<a name='772'></font>
<font color=#447700>!<a name='773'></font>
        IF(ABS(GHL)&lt;=EPSGH)GHL=EPSGH<a name='774'>
<font color=#447700>!<a name='775'></font>
        EN2(K)=GHL*G/THM                                   <font color=#447700>! N**2<a name='776'></font>
<font color=#447700>!<a name='777'></font>
        GH(K)=GHL<a name='778'>
        RI(K)=EN2(K)/S2L<a name='779'>
      ENDDO<a name='780'>
<font color=#447700>!<a name='781'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='782'></font>
<font color=#447700>!***  FIND MAXIMUM MIXING LENGTHS AND THE LEVEL OF THE PBL TOP<a name='783'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='784'></font>
<font color=#447700>!<a name='785'></font>
      LMXL=LMH<a name='786'>
<font color=#447700>!<a name='787'></font>
      DO K=KTS,LMH-1<a name='788'>
        S2L=S2(K)<a name='789'>
        GHL=GH(K)<a name='790'>
<font color=#447700>!<a name='791'></font>
        IF(GHL&gt;=EPSGH)THEN<a name='792'>
          IF(S2L/GHL&lt;=REQU)THEN<a name='793'>
            ELM(K)=EPSL<a name='794'>
            LMXL=K<a name='795'>
          ELSE<a name='796'>
            AUBR=(AUBM*S2L+AUBH*GHL)*GHL<a name='797'>
            BUBR= BUBM*S2L+BUBH*GHL<a name='798'>
            QOL2ST=(-0.5*BUBR+SQRT(BUBR*BUBR*0.25-AUBR*CUBR))*RCUBR<a name='799'>
            ELOQ2X=1./QOL2ST<a name='800'>
            ELM(K)=MAX(SQRT(ELOQ2X*Q2(K)),EPSL)<a name='801'>
          ENDIF<a name='802'>
        ELSE<a name='803'>
          ADEN=(ADNM*S2L+ADNH*GHL)*GHL<a name='804'>
          BDEN= BDNM*S2L+BDNH*GHL<a name='805'>
          QOL2UN=-0.5*BDEN+SQRT(BDEN*BDEN*0.25-ADEN)<a name='806'>
          ELOQ2X=1./(QOL2UN+EPSRU)       <font color=#447700>! repsr1/qol2un<a name='807'></font>
          ELM(K)=MAX(SQRT(ELOQ2X*Q2(K)),EPSL)<a name='808'>
        ENDIF<a name='809'>
      ENDDO<a name='810'>
<font color=#447700>!<a name='811'></font>
      IF(ELM(LMH-1)==EPSL)LMXL=LMH<a name='812'>
<font color=#447700>!<a name='813'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='814'></font>
<font color=#447700>!***  THE HEIGHT OF THE MIXED LAYER<a name='815'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='816'></font>
<font color=#447700>!<a name='817'></font>
      BLMX=Z(LMXL)-Z(LMH+1)<a name='818'>
<font color=#447700>!<a name='819'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='820'></font>
      DO K=LPBL,LMH<a name='821'>
        Q1(K)=SQRT(Q2(K))<a name='822'>
      ENDDO<a name='823'>
<font color=#447700>!----------------------------------------------------------------------<a name='824'></font>
      SZQ=0.<a name='825'>
      SQ =0.<a name='826'>
<font color=#447700>!<a name='827'></font>
      DO K=KTS,LMH-1<a name='828'>
        QDZL=(Q1(K)+Q1(K+1))*(Z(K+1)-Z(K+2))<a name='829'>
        SZQ=(Z(K+1)+Z(K+2)-Z(LMH+1)-Z(LMH+1))*QDZL+SZQ<a name='830'>
        SQ=QDZL+SQ<a name='831'>
      ENDDO<a name='832'>
<font color=#447700>!<a name='833'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='834'></font>
<font color=#447700>!***  COMPUTATION OF ASYMPTOTIC L IN BLACKADAR FORMULA<a name='835'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='836'></font>
<font color=#447700>!<a name='837'></font>
      EL0=MIN(ALPH*SZQ*0.5/SQ,EL0MAX)<a name='838'>
      EL0=MAX(EL0            ,EL0MIN)<a name='839'>
<font color=#447700>!<a name='840'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='841'></font>
<font color=#447700>!***  ABOVE THE PBL TOP<a name='842'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='843'></font>
<font color=#447700>!<a name='844'></font>
      LPBLM=MAX(LPBL-1,1)<a name='845'>
<font color=#447700>!<a name='846'></font>
      DO K=KTS,LPBLM<a name='847'>
        EL(K)=MIN((Z(K)-Z(K+2))*ELFC,ELM(K))<a name='848'>
        REL(K)=EL(K)/ELM(K)<a name='849'>
      ENDDO<a name='850'>
<font color=#447700>!<a name='851'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='852'></font>
<font color=#447700>!***  INSIDE THE PBL<a name='853'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='854'></font>
<font color=#447700>!<a name='855'></font>
      IF(LPBL&lt;LMH)THEN<a name='856'>
        DO K=LPBL,LMH-1<a name='857'>
          VKRMZ=(Z(K+1)-Z(LMH+1))*VKARMAN<a name='858'>
          EL(K)=MIN(VKRMZ/(VKRMZ/EL0+1.),ELM(K))<a name='859'>
          REL(K)=EL(K)/ELM(K)<a name='860'>
        ENDDO<a name='861'>
      ENDIF<a name='862'>
<font color=#447700>!<a name='863'></font>
      DO K=LPBL+1,LMH-2<a name='864'>
        SREL=MIN(((REL(K-1)+REL(K+1))*0.5+REL(K))*0.5,REL(K))<a name='865'>
        EL(K)=MAX(SREL*ELM(K),EPSL)      <a name='866'>
      ENDDO<a name='867'>
<font color=#447700>!<a name='868'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='869'></font>
<font color=#447700>!***  MIXING LENGTH FOR THE QNSE MODEL IN STABLE CASE<a name='870'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='871'></font>
<font color=#447700>!<a name='872'></font>
      F=MAX(CORF,EPS1)<a name='873'>
      RLAMBDA=F/(BLCKDR*USTAR)<a name='874'>
      DO K=KTS,LMH-1<a name='875'>
        IF(EN2(K)&gt;=0.0)THEN                          <font color=#447700>! Stable case<a name='876'></font>
          VKRMZ=(Z(K+1)-Z(LMH+1))*VKARMAN<a name='877'>
          RLB=RLAMBDA+1./VKRMZ<a name='878'>
          RLN=SQRT(2.*EN2(K)/Q2(K))/CN<a name='879'>
<font color=#447700>!         EL(K)=MIN(1./(RLB+RLN),ELM(K))<a name='880'></font>
          EL(K)=1./(RLB+RLN)<a name='881'>
        ENDIF<a name='882'>
      ENDDO<a name='883'>
<font color=#447700>!<a name='884'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='885'></font>
      END SUBROUTINE MIXLEN<a name='886'>
<font color=#447700>!----------------------------------------------------------------------<a name='887'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='888'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='889'></font>
<A NAME='PRODQ2'><A href='../../html_code/phys/module_bl_qnsepbl.F.html#PRODQ2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='890'>
                          <font color=#993300>SUBROUTINE </font><font color=#cc0000>PRODQ2</font>                            &amp; <A href='../../call_to/PRODQ2.html' TARGET='index'>4</A><a name='891'>
<font color=#447700>!----------------------------------------------------------------------<a name='892'></font>
<font color=#447700>!   ******************************************************************<a name='893'></font>
<font color=#447700>!   *                                                                *<a name='894'></font>
<font color=#447700>!   *            LEVEL 2.5 Q2 PRODUCTION/DISSIPATION                 *<a name='895'></font>
<font color=#447700>!   *                                                                *<a name='896'></font>
<font color=#447700>!   ******************************************************************<a name='897'></font>
<font color=#447700>!<a name='898'></font>
     &amp;(LMH,DTTURBL,USTAR,S2,RI,Q2,EL,Z,AKM,AKH,WTHV_MF                 &amp;<a name='899'>
     &amp;,IDS,IDE,JDS,JDE,KDS,KDE                                         &amp;<a name='900'>
     &amp;,IMS,IME,JMS,JME,KMS,KME                                         &amp;<a name='901'>
     &amp;,ITS,ITE,JTS,JTE,KTS,KTE)<a name='902'>
<font color=#447700>!----------------------------------------------------------------------<a name='903'></font>
<font color=#447700>!<a name='904'></font>
      IMPLICIT NONE<a name='905'>
<font color=#447700>!<a name='906'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='907'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='908'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='909'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='910'>
<font color=#447700>!<a name='911'></font>
      INTEGER,INTENT(IN) :: LMH<a name='912'>
<font color=#447700>!<a name='913'></font>
      REAL,INTENT(IN) :: DTTURBL,USTAR<a name='914'>
<font color=#447700>!<a name='915'></font>
      REAL,DIMENSION(KTS:KTE-1),INTENT(IN) :: S2,RI,AKM,AKH,EL<a name='916'>
<font color=#447700>!<a name='917'></font>
      REAL,DIMENSION(KTS:KTE+1),INTENT(IN) :: Z<a name='918'>
<font color=#447700>!<a name='919'></font>
<a name='920'>
      REAL,DIMENSION(KTS:KTE),INTENT(IN) :: WTHV_MF<a name='921'>
<a name='922'>
      REAL,DIMENSION(KTS:KTE),INTENT(INOUT) :: Q2<a name='923'>
<a name='924'>
<font color=#447700>!----------------------------------------------------------------------<a name='925'></font>
<font color=#447700>!***<a name='926'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='927'></font>
<font color=#447700>!***<a name='928'></font>
      INTEGER :: K<a name='929'>
<font color=#447700>!<a name='930'></font>
      REAL :: S2L,Q2L,DELTAZ,AKML,AKHL,EN2,PR,BPR,DIS,RC02<a name='931'>
<font color=#447700>!<a name='932'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='933'></font>
<font color=#447700>!**********************************************************************<a name='934'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='935'></font>
<font color=#447700>!<a name='936'></font>
      RC02=2.0/(C0*C0)<a name='937'>
      main_integration: DO K=1,LMH-1<a name='938'>
        S2L=S2(K)<a name='939'>
        Q2L=Q2(K)<a name='940'>
        DELTAZ=0.5*(Z(K)-Z(K+2))<a name='941'>
        AKML=AKM(K)*DELTAZ<a name='942'>
        AKHL=AKH(K)*DELTAZ<a name='943'>
        EN2=RI(K)*S2L                                           <font color=#447700>!N**2<a name='944'></font>
<font color=#447700>!<a name='945'></font>
<font color=#447700>!***  TURBULENCE PRODUCTION TERM<a name='946'></font>
<font color=#447700>!<a name='947'></font>
        PR=AKML*S2L<a name='948'>
<font color=#447700>!<a name='949'></font>
<font color=#447700>!***  BUOYANCY PRODUCTION<a name='950'></font>
<font color=#447700>!<a name='951'></font>
        BPR=AKHL*EN2<a name='952'>
<font color=#447700>!        BPR=BPR-WTHV_MF(K)<a name='953'></font>
<font color=#447700>!***  DISSIPATION<a name='954'></font>
<font color=#447700>!<a name='955'></font>
        DIS=CEPS*(0.5*Q2L)**1.5/EL(K)<a name='956'>
<font color=#447700>!<a name='957'></font>
        Q2L=Q2L+2.0*(PR-BPR-DIS)*DTTURBL<a name='958'>
        Q2(K)=AMAX1(Q2L,EPSQ2L)<a name='959'>
<font color=#447700>!----------------------------------------------------------------------<a name='960'></font>
<font color=#447700>!***  END OF PRODUCTION/DISSIPATION LOOP<a name='961'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='962'></font>
<font color=#447700>!<a name='963'></font>
      ENDDO main_integration<a name='964'>
<font color=#447700>!<a name='965'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='966'></font>
<font color=#447700>!***  LOWER BOUNDARY CONDITION FOR Q2<a name='967'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='968'></font>
<font color=#447700>!<a name='969'></font>
      Q2(LMH)=AMAX1(RC02*USTAR*USTAR,EPSQ2L)<a name='970'>
<font color=#447700>!----------------------------------------------------------------------<a name='971'></font>
<font color=#447700>!<a name='972'></font>
      END SUBROUTINE PRODQ2<a name='973'>
<font color=#447700>!<a name='974'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='975'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='976'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='977'></font>
<A NAME='DIFCOF'><A href='../../html_code/phys/module_bl_qnsepbl.F.html#DIFCOF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='978'>
                           <font color=#993300>SUBROUTINE </font><font color=#cc0000>DIFCOF</font>                           &amp; <A href='../../call_to/DIFCOF.html' TARGET='index'>3</A><a name='979'>
<font color=#447700>!   ******************************************************************<a name='980'></font>
<font color=#447700>!   *                                                                *<a name='981'></font>
<font color=#447700>!   *      DIFFUSION COEFFICIENTS KM, KH BASED ON THE QNSE THEORY    *<a name='982'></font>
<font color=#447700>!   *                                                                *<a name='983'></font>
<font color=#447700>!   ******************************************************************<a name='984'></font>
     &amp;(LMH,EL,RI,Q2,Z,AKM,AKH                                          &amp;<a name='985'>
     &amp;,IDS,IDE,JDS,JDE,KDS,KDE                                         &amp;<a name='986'>
     &amp;,IMS,IME,JMS,JME,KMS,KME                                         &amp;<a name='987'>
     &amp;,ITS,ITE,JTS,JTE,KTS,KTE,PRINT_DIAG)   <font color=#447700>! debug<a name='988'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='989'></font>
<font color=#447700>!<a name='990'></font>
      IMPLICIT NONE<a name='991'>
<font color=#447700>!<a name='992'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='993'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='994'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='995'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='996'>
<font color=#447700>!<a name='997'></font>
      INTEGER,INTENT(IN) :: LMH<a name='998'>
<font color=#447700>!<a name='999'></font>
      REAL,DIMENSION(KTS:KTE),INTENT(IN) :: Q2<a name='1000'>
      REAL,DIMENSION(KTS:KTE-1),INTENT(IN) :: EL,RI<a name='1001'>
      REAL,DIMENSION(KTS:KTE+1),INTENT(IN) :: Z<a name='1002'>
<font color=#447700>!<a name='1003'></font>
      REAL,DIMENSION(KTS:KTE-1),INTENT(OUT) :: AKH,AKM<a name='1004'>
<font color=#447700>!----------------------------------------------------------------------<a name='1005'></font>
<font color=#447700>!***<a name='1006'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='1007'></font>
<font color=#447700>!***<a name='1008'></font>
      INTEGER :: K<a name='1009'>
<font color=#447700>!<a name='1010'></font>
      REAL :: AK0,ALPHAM,ALPHAH,RIL,RIL2,ARIL,ARIL2,ARIL4,ELL,Q1L,RDZ  &amp;<a name='1011'>
     &amp;       ,AK0DZ,AKMIN<a name='1012'>
<font color=#447700>!<a name='1013'></font>
<font color=#447700>!*** Begin debugging<a name='1014'></font>
      INTEGER,INTENT(IN) :: PRINT_DIAG<a name='1015'>
<font color=#447700>!     REAL :: D2Tmin<a name='1016'></font>
<font color=#447700>!*** End debugging<a name='1017'></font>
<font color=#447700>!<a name='1018'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1019'></font>
<font color=#447700>!**********************************************************************<a name='1020'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1021'></font>
<font color=#447700>!<a name='1022'></font>
      DO K=1,LMH-1<a name='1023'>
        ELL=EL(K)<a name='1024'>
        Q1L=SQRT(0.5*Q2(K))               <font color=#447700>!Note that Q1L is SQRT(TKE)<a name='1025'></font>
        RIL=RI(K)<a name='1026'>
        AK0=C0*ELL*Q1L                    <font color=#447700>!KM in neutral case<a name='1027'></font>
<font color=#447700>!<a name='1028'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1029'></font>
<font color=#447700>!***  STABILITY FUNCTIONS ALPHAM AND ALPHAH<a name='1030'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1031'></font>
<font color=#447700>!<a name='1032'></font>
<font color=#447700>!!! UNSTABLE CASE<a name='1033'></font>
<font color=#447700>!<a name='1034'></font>
        IF(RIL&lt;=0) THEN<a name='1035'>
          ARIL=MIN(ABS(RIL),2.*ARIMIN)<a name='1036'>
          ARIL2=ARIL*ARIL<a name='1037'>
          ARIL4=ARIL2*ARIL2<a name='1038'>
          ALPHAM=1.0+BM1*ARIL+BM2*ARIL2<a name='1039'>
          ALPHAH=AH1+BH1*ARIL+BH2*ARIL2+BH3*ARIL4<a name='1040'>
<font color=#447700>!<a name='1041'></font>
<font color=#447700>!!! STABLE CASE<a name='1042'></font>
<font color=#447700>!<a name='1043'></font>
        ELSE<a name='1044'>
          RIL2=RIL*RIL<a name='1045'>
          ALPHAM=(1.0+AM1*RIL2)/(1.0+AM2*RIL+AM3*RIL2)<a name='1046'>
          ALPHAH=(AH1+AH2*RIL+AH3*RIL2)/(1.0+AH4*RIL+AH5*RIL2)<a name='1047'>
        ENDIF<a name='1048'>
<font color=#447700>!<a name='1049'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1050'></font>
<font color=#447700>!*** END OF STABILITY FUNCTIONS COMPUTATIONS<a name='1051'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1052'></font>
<font color=#447700>!<a name='1053'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1054'></font>
<font color=#447700>!***  DIFFUSION COEFFICIENTS<a name='1055'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1056'></font>
<font color=#447700>!<a name='1057'></font>
        RDZ=2./(Z(K)-Z(K+2))<a name='1058'>
        AK0DZ=AK0*RDZ<a name='1059'>
        AKMIN=EPSKM*RDZ<a name='1060'>
        AKM(K)=MAX(AK0DZ*ALPHAM,AKMIN)<a name='1061'>
        AKH(K)=MAX(AK0DZ*ALPHAH,AKMIN)<a name='1062'>
<font color=#447700>!----------------------------------------------------------------------<a name='1063'></font>
      ENDDO<a name='1064'>
<font color=#447700>!----------------------------------------------------------------------<a name='1065'></font>
<font color=#447700>!<a name='1066'></font>
      END SUBROUTINE DIFCOF<a name='1067'>
<font color=#447700>!<a name='1068'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1069'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='1070'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1071'></font>
<A NAME='VDIFQ'><A href='../../html_code/phys/module_bl_qnsepbl.F.html#VDIFQ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1072'>
                           <font color=#993300>SUBROUTINE </font><font color=#cc0000>VDIFQ</font>                            &amp; <A href='../../call_to/VDIFQ.html' TARGET='index'>4</A><a name='1073'>
<font color=#447700>!   ******************************************************************<a name='1074'></font>
<font color=#447700>!   *                                                                *<a name='1075'></font>
<font color=#447700>!   *               VERTICAL DIFFUSION OF Q2 (TKE)                   *<a name='1076'></font>
<font color=#447700>!   *                                                                *<a name='1077'></font>
<font color=#447700>!   ******************************************************************<a name='1078'></font>
     &amp;(LMH,DTDIF,Q2,EL,Z                                               &amp;<a name='1079'>
     &amp;,IDS,IDE,JDS,JDE,KDS,KDE                                         &amp;<a name='1080'>
     &amp;,IMS,IME,JMS,JME,KMS,KME                                         &amp;<a name='1081'>
     &amp;,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1082'>
<font color=#447700>!----------------------------------------------------------------------<a name='1083'></font>
<font color=#447700>!<a name='1084'></font>
      IMPLICIT NONE<a name='1085'>
<font color=#447700>!<a name='1086'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1087'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='1088'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='1089'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='1090'>
<font color=#447700>!<a name='1091'></font>
      INTEGER,INTENT(IN) :: LMH<a name='1092'>
<font color=#447700>!<a name='1093'></font>
      REAL,INTENT(IN) :: DTDIF<a name='1094'>
<font color=#447700>!<a name='1095'></font>
      REAL,DIMENSION(KTS:KTE-1),INTENT(IN) :: EL<a name='1096'>
      REAL,DIMENSION(KTS:KTE+1),INTENT(IN) :: Z<a name='1097'>
<font color=#447700>!<a name='1098'></font>
      REAL,DIMENSION(KTS:KTE),INTENT(INOUT) :: Q2<a name='1099'>
<font color=#447700>!----------------------------------------------------------------------<a name='1100'></font>
<font color=#447700>!***<a name='1101'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='1102'></font>
<font color=#447700>!***<a name='1103'></font>
      INTEGER :: K<a name='1104'>
<font color=#447700>!<a name='1105'></font>
      REAL :: ADEN,AKQS,BDEN,BESH,BESM,CDEN,CF,DTOZS,ELL,ELOQ2,ELOQ4   &amp;<a name='1106'>
     &amp;       ,ELQDZ,ESH,ESM,ESQHF,GHL,GML,Q1L,RDEN,RDZ<a name='1107'>
<font color=#447700>!<a name='1108'></font>
      REAL,DIMENSION(KTS:KTE-2) :: AKQ,CM,CR,DTOZ,RSQ2<a name='1109'>
<font color=#447700>!----------------------------------------------------------------------<a name='1110'></font>
<font color=#447700>!**********************************************************************<a name='1111'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1112'></font>
<font color=#447700>!***<a name='1113'></font>
<font color=#447700>!***  VERTICAL TURBULENT DIFFUSION<a name='1114'></font>
<font color=#447700>!***<a name='1115'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1116'></font>
      ESQHF=0.5*ESQ<a name='1117'>
<font color=#447700>!<a name='1118'></font>
      DO K=KTS,LMH-2<a name='1119'>
        DTOZ(K)=(DTDIF+DTDIF)/(Z(K)-Z(K+2))<a name='1120'>
        AKQ(K)=SQRT((Q2(K)+Q2(K+1))*0.5)*(EL(K)+EL(K+1))*ESQHF         &amp;<a name='1121'>
     &amp;        /(Z(K+1)-Z(K+2))<a name='1122'>
        CR(K)=-DTOZ(K)*AKQ(K)<a name='1123'>
      ENDDO<a name='1124'>
<font color=#447700>!<a name='1125'></font>
      CM(1)=DTOZ(1)*AKQ(1)+1.<a name='1126'>
      RSQ2(1)=Q2(1)<a name='1127'>
<font color=#447700>!<a name='1128'></font>
      DO K=KTS+1,LMH-2<a name='1129'>
        CF=-DTOZ(K)*AKQ(K-1)/CM(K-1)<a name='1130'>
        CM(K)=-CR(K-1)*CF+(AKQ(K-1)+AKQ(K))*DTOZ(K)+1.<a name='1131'>
        RSQ2(K)=-RSQ2(K-1)*CF+Q2(K)<a name='1132'>
      ENDDO<a name='1133'>
<font color=#447700>!<a name='1134'></font>
      DTOZS=(DTDIF+DTDIF)/(Z(LMH-1)-Z(LMH+1))<a name='1135'>
      AKQS=SQRT((Q2(LMH-1)+Q2(LMH))*0.5)*(EL(LMH-1)+ELZ0)*ESQHF        &amp;<a name='1136'>
     &amp;    /(Z(LMH)-Z(LMH+1))<a name='1137'>
<font color=#447700>!<a name='1138'></font>
      CF=-DTOZS*AKQ(LMH-2)/CM(LMH-2)<a name='1139'>
<font color=#447700>!<a name='1140'></font>
      Q2(LMH-1)=(DTOZS*AKQS*Q2(LMH)-RSQ2(LMH-2)*CF+Q2(LMH-1))          &amp;<a name='1141'>
     &amp;        /((AKQ(LMH-2)+AKQS)*DTOZS-CR(LMH-2)*CF+1.)<a name='1142'>
<font color=#447700>!<a name='1143'></font>
      DO K=LMH-2,KTS,-1<a name='1144'>
        Q2(K)=(-CR(K)*Q2(K+1)+RSQ2(K))/CM(K)<a name='1145'>
      ENDDO<a name='1146'>
<font color=#447700>!----------------------------------------------------------------------<a name='1147'></font>
<font color=#447700>!<a name='1148'></font>
      END SUBROUTINE VDIFQ<a name='1149'>
<font color=#447700>!<a name='1150'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1151'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='1152'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1153'></font>
<A NAME='VDIFH'><A href='../../html_code/phys/module_bl_qnsepbl.F.html#VDIFH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1154'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>VDIFH</font>(DTDIF,LMH,THZ0,QZ0,RKHS,CHKLOWQ,CT             &amp; <A href='../../call_to/VDIFH.html' TARGET='index'>3</A><a name='1155'>
     &amp;                ,THE,Q,CWM,RKH,Z,RHO                            &amp;<a name='1156'>
     &amp;                ,IDS,IDE,JDS,JDE,KDS,KDE                        &amp;<a name='1157'>
     &amp;                ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='1158'>
     &amp;                ,ITS,ITE,JTS,JTE,KTS,KTE,I,J)<a name='1159'>
<font color=#447700>!     ***************************************************************<a name='1160'></font>
<font color=#447700>!     *                                                             *<a name='1161'></font>
<font color=#447700>!     *         VERTICAL DIFFUSION OF MASS VARIABLES                *<a name='1162'></font>
<font color=#447700>!     *                                                             *<a name='1163'></font>
<font color=#447700>!     ***************************************************************<a name='1164'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1165'></font>
<font color=#447700>!<a name='1166'></font>
      IMPLICIT NONE<a name='1167'>
<font color=#447700>!<a name='1168'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1169'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='1170'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='1171'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE,I,J<a name='1172'>
<font color=#447700>!<a name='1173'></font>
      INTEGER,INTENT(IN) :: LMH<a name='1174'>
<font color=#447700>!<a name='1175'></font>
      REAL,INTENT(IN) :: CHKLOWQ,CT,DTDIF,QZ0,RKHS,THZ0<a name='1176'>
<font color=#447700>!<a name='1177'></font>
      REAL,DIMENSION(KTS:KTE-1),INTENT(IN) :: RKH<a name='1178'>
      REAL,DIMENSION(KTS:KTE),INTENT(IN) :: RHO<a name='1179'>
      REAL,DIMENSION(KTS:KTE+1),INTENT(IN) :: Z<a name='1180'>
      REAL,DIMENSION(KTS:KTE),INTENT(INOUT) :: CWM,Q,THE<a name='1181'>
<font color=#447700>!<a name='1182'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1183'></font>
<font color=#447700>!***<a name='1184'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='1185'></font>
<font color=#447700>!***<a name='1186'></font>
      INTEGER :: K<a name='1187'>
<font color=#447700>!<a name='1188'></font>
      REAL :: CF,CMB,CMCB,CMQB,CMTB,CTHF,DTOZL,DTOZS                   &amp;<a name='1189'>
     &amp;       ,RCML,RKHH,RKQS,RSCB,RSQB,RSTB<a name='1190'>
<font color=#447700>!<a name='1191'></font>
      REAL,DIMENSION(KTS:KTE-1) :: CM,CR,DTOZ,RKCT,RSC,RSQ,RST<a name='1192'>
<font color=#447700>!<a name='1193'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1194'></font>
<font color=#447700>!**********************************************************************<a name='1195'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1196'></font>
      CTHF=0.5*CT<a name='1197'>
<font color=#447700>!<a name='1198'></font>
      DO K=KTS,LMH-1<a name='1199'>
        DTOZ(K)=DTDIF/(Z(K)-Z(K+1))<a name='1200'>
        CR(K)=-DTOZ(K)*RKH(K)<a name='1201'>
        RKCT(K)=RKH(K)*(Z(K)-Z(K+2))*CTHF<a name='1202'>
      ENDDO<a name='1203'>
<font color=#447700>!<a name='1204'></font>
      CM(KTS)=DTOZ(KTS)*RKH(KTS)+RHO(KTS)<a name='1205'>
<font color=#447700>!----------------------------------------------------------------------<a name='1206'></font>
      RST(KTS)=-RKCT(KTS)*DTOZ(KTS)                                    &amp;<a name='1207'>
     &amp;         +THE(KTS)*RHO(KTS)<a name='1208'>
      RSQ(KTS)=Q(KTS)  *RHO(KTS)<a name='1209'>
      RSC(KTS)=CWM(KTS)*RHO(KTS)<a name='1210'>
<font color=#447700>!----------------------------------------------------------------------<a name='1211'></font>
      DO K=KTS+1,LMH-1<a name='1212'>
        DTOZL=DTOZ(K)<a name='1213'>
        CF=-DTOZL*RKH(K-1)/CM(K-1)<a name='1214'>
        CM(K)=-CR(K-1)*CF+(RKH(K-1)+RKH(K))*DTOZL+RHO(K)<a name='1215'>
        RST(K)=-RST(K-1)*CF+(RKCT(K-1)-RKCT(K))*DTOZL+THE(K)*RHO(K)<a name='1216'>
        RSQ(K)=-RSQ(K-1)*CF+Q(K)  *RHO(K)<a name='1217'>
        RSC(K)=-RSC(K-1)*CF+CWM(K)*RHO(K)<a name='1218'>
      ENDDO<a name='1219'>
<font color=#447700>!<a name='1220'></font>
      DTOZS=DTDIF/(Z(LMH)-Z(LMH+1))<a name='1221'>
      RKHH=RKH(LMH-1)<a name='1222'>
<font color=#447700>!<a name='1223'></font>
      CF=-DTOZS*RKHH/CM(LMH-1)<a name='1224'>
      RKQS=RKHS*CHKLOWQ<a name='1225'>
<font color=#447700>!<a name='1226'></font>
      CMB=CR(LMH-1)*CF<a name='1227'>
      CMTB=-CMB+(RKHH+RKHS)*DTOZS+RHO(LMH)<a name='1228'>
      CMQB=-CMB+(RKHH+RKQS)*DTOZS+RHO(LMH)<a name='1229'>
      CMCB=-CMB+(RKHH     )*DTOZS+RHO(LMH)<a name='1230'>
<font color=#447700>!<a name='1231'></font>
      RSTB=-RST(LMH-1)*CF+RKCT(LMH-1)*DTOZS+THE(LMH)*RHO(LMH)<a name='1232'>
      RSQB=-RSQ(LMH-1)*CF+Q(LMH)  *RHO(LMH)<a name='1233'>
      RSCB=-RSC(LMH-1)*CF+CWM(LMH)*RHO(LMH)<a name='1234'>
<font color=#447700>!----------------------------------------------------------------------<a name='1235'></font>
      THE(LMH)=(DTOZS*RKHS*THZ0+RSTB)/CMTB<a name='1236'>
      Q(LMH)  =(DTOZS*RKQS*QZ0 +RSQB)/CMQB<a name='1237'>
      CWM(LMH)=(                RSCB)/CMCB<a name='1238'>
<font color=#447700>!----------------------------------------------------------------------<a name='1239'></font>
      DO K=LMH-1,KTS,-1<a name='1240'>
        RCML=1./CM(K)<a name='1241'>
        THE(K)=(-CR(K)*THE(K+1)+RST(K))*RCML<a name='1242'>
        Q(K)  =(-CR(K)*  Q(K+1)+RSQ(K))*RCML<a name='1243'>
        CWM(K)=(-CR(K)*CWM(K+1)+RSC(K))*RCML<a name='1244'>
      ENDDO<a name='1245'>
<font color=#447700>!----------------------------------------------------------------------<a name='1246'></font>
<font color=#447700>!<a name='1247'></font>
      END SUBROUTINE VDIFH<a name='1248'>
<font color=#447700>!<a name='1249'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1250'></font>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='1251'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1252'></font>
<A NAME='VDIFV'><A href='../../html_code/phys/module_bl_qnsepbl.F.html#VDIFV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1253'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>VDIFV</font>(LMH,DTDIF,UZ0,VZ0,RKMS,U,V,RKM,Z,RHO           &amp; <A href='../../call_to/VDIFV.html' TARGET='index'>3</A><a name='1254'>
     &amp;                ,IDS,IDE,JDS,JDE,KDS,KDE                        &amp;<a name='1255'>
     &amp;                ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='1256'>
                      ,ITS,ITE,JTS,JTE,KTS,KTE,I,J)<a name='1257'>
<font color=#447700>!     ***************************************************************<a name='1258'></font>
<font color=#447700>!     *                                                             *<a name='1259'></font>
<font color=#447700>!     *        VERTICAL DIFFUSION OF VELOCITY COMPONENTS            *<a name='1260'></font>
<font color=#447700>!     *                                                             *<a name='1261'></font>
<font color=#447700>!     ***************************************************************<a name='1262'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1263'></font>
<font color=#447700>!<a name='1264'></font>
      IMPLICIT NONE<a name='1265'>
<font color=#447700>!<a name='1266'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1267'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                   &amp;<a name='1268'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                   &amp;<a name='1269'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE,I,J<a name='1270'>
<font color=#447700>!<a name='1271'></font>
      INTEGER,INTENT(IN) :: LMH<a name='1272'>
<font color=#447700>!<a name='1273'></font>
      REAL,INTENT(IN) :: RKMS,DTDIF,UZ0,VZ0<a name='1274'>
<font color=#447700>!<a name='1275'></font>
      REAL,DIMENSION(KTS:KTE-1),INTENT(IN) :: RKM<a name='1276'>
      REAL,DIMENSION(KTS:KTE),INTENT(IN) :: RHO<a name='1277'>
      REAL,DIMENSION(KTS:KTE+1),INTENT(IN) :: Z<a name='1278'>
<font color=#447700>!<a name='1279'></font>
      REAL,DIMENSION(KTS:KTE),INTENT(INOUT) :: U,V<a name='1280'>
<font color=#447700>!----------------------------------------------------------------------<a name='1281'></font>
<font color=#447700>!***<a name='1282'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='1283'></font>
<font color=#447700>!***<a name='1284'></font>
      INTEGER :: K<a name='1285'>
<font color=#447700>!<a name='1286'></font>
      REAL :: CF,DTOZAK,DTOZL,DTOZS,RCML,RCMVB,RHOK,RKMH<a name='1287'>
<font color=#447700>!<a name='1288'></font>
      REAL,DIMENSION(KTS:KTE-1) :: CM,CR,DTOZ,RSU,RSV<a name='1289'>
<font color=#447700>!----------------------------------------------------------------------<a name='1290'></font>
<font color=#447700>!**********************************************************************<a name='1291'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1292'></font>
      DO K=1,LMH-1<a name='1293'>
        DTOZ(K)=DTDIF/(Z(K)-Z(K+1))<a name='1294'>
        CR(K)=-DTOZ(K)*RKM(K)<a name='1295'>
      ENDDO<a name='1296'>
<font color=#447700>!<a name='1297'></font>
      RHOK=RHO(1)<a name='1298'>
      CM(1)=DTOZ(1)*RKM(1)+RHOK<a name='1299'>
      RSU(1)=U(1)*RHOK<a name='1300'>
      RSV(1)=V(1)*RHOK<a name='1301'>
<font color=#447700>!----------------------------------------------------------------------<a name='1302'></font>
      DO K=2,LMH-1<a name='1303'>
        DTOZL=DTOZ(K)<a name='1304'>
        CF=-DTOZL*RKM(K-1)/CM(K-1)<a name='1305'>
        RHOK=RHO(K)<a name='1306'>
        CM(K)=-CR(K-1)*CF+(RKM(K-1)+RKM(K))*DTOZL+RHOK<a name='1307'>
        RSU(K)=-RSU(K-1)*CF+U(K)*RHOK<a name='1308'>
        RSV(K)=-RSV(K-1)*CF+V(K)*RHOK<a name='1309'>
      ENDDO<a name='1310'>
<font color=#447700>!----------------------------------------------------------------------<a name='1311'></font>
      DTOZS=DTDIF/(Z(LMH)-Z(LMH+1))<a name='1312'>
      RKMH=RKM(LMH-1)<a name='1313'>
<font color=#447700>!<a name='1314'></font>
      CF=-DTOZS*RKMH/CM(LMH-1)<a name='1315'>
      RHOK=RHO(LMH)<a name='1316'>
      RCMVB=1./((RKMH+RKMS)*DTOZS-CR(LMH-1)*CF+RHOK)<a name='1317'>
      DTOZAK=DTOZS*RKMS<a name='1318'>
<font color=#447700>!----------------------------------------------------------------------<a name='1319'></font>
      U(LMH)=(DTOZAK*UZ0-RSU(LMH-1)*CF+U(LMH)*RHOK)*RCMVB<a name='1320'>
      V(LMH)=(DTOZAK*VZ0-RSV(LMH-1)*CF+V(LMH)*RHOK)*RCMVB<a name='1321'>
<font color=#447700>!----------------------------------------------------------------------<a name='1322'></font>
      DO K=LMH-1,1,-1<a name='1323'>
        RCML=1./CM(K)<a name='1324'>
        U(K)=(-CR(K)*U(K+1)+RSU(K))*RCML<a name='1325'>
        V(K)=(-CR(K)*V(K+1)+RSV(K))*RCML<a name='1326'>
      ENDDO<a name='1327'>
<font color=#447700>!----------------------------------------------------------------------<a name='1328'></font>
<font color=#447700>!<a name='1329'></font>
      END SUBROUTINE VDIFV<a name='1330'>
<font color=#447700>!<a name='1331'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1332'></font>
<font color=#447700>!<a name='1333'></font>
<font color=#447700>!=======================================================================<a name='1334'></font>
<A NAME='QNSEPBLINIT'><A href='../../html_code/phys/module_bl_qnsepbl.F.html#QNSEPBLINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1335'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>QNSEPBLINIT</font>(RUBLTEN,RVBLTEN,RTHBLTEN,RQVBLTEN,          &amp; <A href='../../call_to/QNSEPBLINIT.html' TARGET='index'>1</A><a name='1336'>
     &amp;                      TKE,EXCH_H,RESTART,ALLOWED_TO_READ,         &amp;<a name='1337'>
     &amp;                      IDS,IDE,JDS,JDE,KDS,KDE,                    &amp;<a name='1338'>
     &amp;                      IMS,IME,JMS,JME,KMS,KME,                    &amp;<a name='1339'>
     &amp;                      ITS,ITE,JTS,JTE,KTS,KTE                 )<a name='1340'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1341'></font>
      IMPLICIT NONE<a name='1342'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1343'></font>
      LOGICAL,INTENT(IN) :: ALLOWED_TO_READ,RESTART<a name='1344'>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE,                    &amp;<a name='1345'>
     &amp;                      IMS,IME,JMS,JME,KMS,KME,                    &amp;<a name='1346'>
     &amp;                      ITS,ITE,JTS,JTE,KTS,KTE<a name='1347'>
<a name='1348'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT) ::    EXCH_H, &amp;<a name='1349'>
     &amp;                                                         RUBLTEN, &amp;<a name='1350'>
     &amp;                                                         RVBLTEN, &amp;<a name='1351'>
     &amp;                                                        RTHBLTEN, &amp;<a name='1352'>
     &amp;                                                        RQVBLTEN, &amp;<a name='1353'>
     &amp;                                                         TKE<a name='1354'>
      INTEGER :: I,J,K,ITF,JTF,KTF<a name='1355'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1356'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1357'></font>
<a name='1358'>
      JTF=MIN0(JTE,JDE-1)<a name='1359'>
      KTF=MIN0(KTE,KDE-1)<a name='1360'>
      ITF=MIN0(ITE,IDE-1)<a name='1361'>
<a name='1362'>
      IF(.NOT.RESTART)THEN<a name='1363'>
        DO J=JTS,JTF<a name='1364'>
        DO K=KTS,KTF<a name='1365'>
        DO I=ITS,ITF<a name='1366'>
          TKE(I,K,J)=EPSQ2L<a name='1367'>
          RUBLTEN(I,K,J)=0.<a name='1368'>
          RVBLTEN(I,K,J)=0.<a name='1369'>
          RTHBLTEN(I,K,J)=0.<a name='1370'>
          RQVBLTEN(I,K,J)=0.<a name='1371'>
          EXCH_H(I,K,J)=0.<a name='1372'>
        ENDDO<a name='1373'>
        ENDDO<a name='1374'>
        ENDDO<a name='1375'>
      ENDIF<a name='1376'>
<a name='1377'>
      END SUBROUTINE QNSEPBLINIT<a name='1378'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1379'></font>
<font color=#447700>!<a name='1380'></font>
      END MODULE MODULE_BL_QNSEPBL<a name='1381'>
<font color=#447700>!<a name='1382'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1383'></font>
</pre></body></html>