<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!!<a name='2'></font>
<font color=#447700>!! LOG<a name='3'></font>
<font color=#447700>!!  2015-12-10  Weiguo Wang  added gfs scale-aware SAS scheme to HWRF<a name='4'></font>
<a name='5'>
<A NAME='MODULE_CU_SCALESAS'><A href='../../html_code/phys/module_cu_scalesas.F.html#MODULE_CU_SCALESAS' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='6'>
<font color=#993300>MODULE </font><font color=#cc0000>module_cu_scalesas</font>  <A href='../../call_to/MODULE_CU_SCALESAS.html' TARGET='index'>2</A><a name='7'>
<a name='8'>
CONTAINS<a name='9'>
<a name='10'>
<font color=#447700>!-----------------------------------------------------------------<a name='11'></font>
<A NAME='CU_SCALESAS'><A href='../../html_code/phys/module_cu_scalesas.F.html#CU_SCALESAS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='12'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>CU_SCALESAS</font>(DT,ITIMESTEP,STEPCU,                        &amp; <A href='../../call_to/CU_SCALESAS.html' TARGET='index'>1</A>,<A href='../../call_from/CU_SCALESAS.html' TARGET='index'>6</A><a name='13'>
                 RTHCUTEN,RQVCUTEN,RQCCUTEN,RQICUTEN,               &amp;<a name='14'>
                 RUCUTEN,RVCUTEN,                                   &amp; <a name='15'>
                 RAINCV,PRATEC,HTOP,HBOT,                           &amp;<a name='16'>
                 U3D,V3D,W,T3D,QV3D,QC3D,QI3D,PI3D,RHO3D,           &amp;<a name='17'>
                 DZ8W,PCPS,P8W,XLAND,CU_ACT_FLAG,                   &amp;<a name='18'>
                 P_QC,                                              &amp; <a name='19'>
                 MOMMIX, &amp; <font color=#447700>! gopal's doing<a name='20'></font>
                 PGCON,sas_mass_flux,                               &amp;<a name='21'>
                 shalconv,shal_pgcon,                               &amp;<a name='22'>
                 HPBL2D,EVAP2D,HEAT2D,                              &amp; <font color=#447700>!Kwon for shallow convection<a name='23'></font>
                 P_QI,P_FIRST_SCALAR,                               &amp; <a name='24'>
                 DX2D, DY,                                          &amp; <font color=#447700>! Wang W for scale-aware cnv<a name='25'></font>
                 SCALEFUN, SCALEFUN1,                               &amp; <font color=#447700>!cnv scale functions<a name='26'></font>
                 SIGMU,SIGMU1,                                      &amp;<a name='27'>
                 ids,ide, jds,jde, kds,kde,                         &amp;<a name='28'>
                 ims,ime, jms,jme, kms,kme,                         &amp;<a name='29'>
                 its,ite, jts,jte, kts,kte                          )<a name='30'>
<a name='31'>
<font color=#447700>!-------------------------------------------------------------------<a name='32'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_cu_scalesas.F.html#CU_SCALESAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_23"> , ONLY : kind_phys<a name='33'>
      USE <A href='../../html_code/phys/module_gfs_funcphys.F.html#MODULE_GFS_FUNCPHYS'>MODULE_GFS_FUNCPHYS</A><A href='../../html_code/phys/module_cu_scalesas.F.html#CU_SCALESAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_FUNCPHYS_9"> , ONLY : gfuncphys<a name='34'>
      USE <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_PHYSCONS</A><A href='../../html_code/phys/module_cu_scalesas.F.html#CU_SCALESAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_15">, grav =&gt; con_g, CP =&gt; con_CP, HVAP =&gt; con_HVAP  &amp;<a name='35'>
     &amp;,             RV =&gt; con_RV, FV =&gt; con_fvirt, T0C =&gt; con_T0C       &amp;<a name='36'>
     &amp;,             CVAP =&gt; con_CVAP, CLIQ =&gt; con_CLIQ                  &amp; <a name='37'>
     &amp;,             EPS =&gt; con_eps, EPSM1 =&gt; con_epsm1                  &amp;<a name='38'>
     &amp;,             ROVCP =&gt; con_rocp, RD =&gt; con_rd<a name='39'>
<font color=#447700>!-------------------------------------------------------------------<a name='40'></font>
      IMPLICIT NONE<a name='41'>
<font color=#447700>!-------------------------------------------------------------------<a name='42'></font>
<font color=#447700>!-- U3D         3D u-velocity interpolated to theta points (m/s)<a name='43'></font>
<font color=#447700>!-- V3D         3D v-velocity interpolated to theta points (m/s)<a name='44'></font>
<font color=#447700>!-- TH3D	3D potential temperature (K)<a name='45'></font>
<font color=#447700>!-- T3D         temperature (K)<a name='46'></font>
<font color=#447700>!-- QV3D        3D water vapor mixing ratio (Kg/Kg)<a name='47'></font>
<font color=#447700>!-- QC3D        3D cloud mixing ratio (Kg/Kg)<a name='48'></font>
<font color=#447700>!-- QI3D        3D ice mixing ratio (Kg/Kg)<a name='49'></font>
<font color=#447700>!-- P8w         3D pressure at full levels (Pa)<a name='50'></font>
<font color=#447700>!-- Pcps        3D pressure (Pa)<a name='51'></font>
<font color=#447700>!-- PI3D	3D exner function (dimensionless)<a name='52'></font>
<font color=#447700>!-- rr3D	3D dry air density (kg/m^3)<a name='53'></font>
<font color=#447700>!-- RUBLTEN     U tendency due to<a name='54'></font>
<font color=#447700>!               PBL parameterization (m/s^2)<a name='55'></font>
<font color=#447700>!-- RVBLTEN     V tendency due to<a name='56'></font>
<font color=#447700>!               PBL parameterization (m/s^2)<a name='57'></font>
<font color=#447700>!-- RTHBLTEN    Theta tendency due to<a name='58'></font>
<font color=#447700>!               PBL parameterization (K/s)<a name='59'></font>
<font color=#447700>!-- RQVBLTEN    Qv tendency due to<a name='60'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='61'></font>
<font color=#447700>!-- RQCBLTEN    Qc tendency due to<a name='62'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='63'></font>
<font color=#447700>!-- RQIBLTEN    Qi tendency due to<a name='64'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='65'></font>
<font color=#447700>!<a name='66'></font>
<font color=#447700>!-- MOMMIX      MOMENTUM MIXING COEFFICIENT (can be set in the namelist)<a name='67'></font>
<font color=#447700>!-- RUCUTEN     U tendency due to Cumulus Momentum Mixing (gopal's doing for SAS)<a name='68'></font>
<font color=#447700>!-- RVCUTEN     V tendency due to Cumulus Momentum Mixing (gopal's doing for SAS)<a name='69'></font>
<font color=#447700>!<a name='70'></font>
<font color=#447700>!-- CP          heat capacity at constant pressure for dry air (J/kg/K)<a name='71'></font>
<font color=#447700>!-- GRAV        acceleration due to gravity (m/s^2)<a name='72'></font>
<font color=#447700>!-- ROVCP       R/CP<a name='73'></font>
<font color=#447700>!-- RD          gas constant for dry air (J/kg/K)<a name='74'></font>
<font color=#447700>!-- ROVG 	R/G<a name='75'></font>
<font color=#447700>!-- P_QI	species index for cloud ice<a name='76'></font>
<font color=#447700>!-- dz8w	dz between full levels (m)<a name='77'></font>
<font color=#447700>!-- z		height above sea level (m)<a name='78'></font>
<font color=#447700>!-- PSFC        pressure at the surface (Pa)<a name='79'></font>
<font color=#447700>!-- UST		u* in similarity theory (m/s)<a name='80'></font>
<font color=#447700>!-- PBL		PBL height (m)<a name='81'></font>
<font color=#447700>!-- PSIM        similarity stability function for momentum<a name='82'></font>
<font color=#447700>!-- PSIH        similarity stability function for heat<a name='83'></font>
<font color=#447700>!-- HFX		upward heat flux at the surface (W/m^2)<a name='84'></font>
<font color=#447700>!-- QFX		upward moisture flux at the surface (kg/m^2/s)<a name='85'></font>
<font color=#447700>!-- TSK		surface temperature (K)<a name='86'></font>
<font color=#447700>!-- GZ1OZ0      log(z/z0) where z0 is roughness length<a name='87'></font>
<font color=#447700>!-- WSPD        wind speed at lowest model level (m/s)<a name='88'></font>
<font color=#447700>!-- BR          bulk Richardson number in surface layer<a name='89'></font>
<font color=#447700>!-- DT		time step (s)<a name='90'></font>
<font color=#447700>!-- rvovrd      R_v divided by R_d (dimensionless)<a name='91'></font>
<font color=#447700>!-- EP1         constant for virtual temperature (R_v/R_d - 1) (dimensionless)<a name='92'></font>
<font color=#447700>!-- KARMAN      Von Karman constant<a name='93'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='94'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='95'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='96'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='97'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='98'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='99'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='100'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='101'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='102'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='103'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='104'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='105'></font>
<font color=#447700>!-- its         start index for i in tile<a name='106'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='107'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='108'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='109'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='110'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='111'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='112'></font>
<a name='113'>
      INTEGER ::                        ICLDCK<a name='114'>
<a name='115'>
      INTEGER, INTENT(IN) ::            ids,ide, jds,jde, kds,kde,      &amp;<a name='116'>
                                        ims,ime, jms,jme, kms,kme,      &amp;<a name='117'>
                                        its,ite, jts,jte, kts,kte,      &amp;<a name='118'>
                                        ITIMESTEP,                      &amp;     <font color=#447700>!NSTD<a name='119'></font>
                                        P_FIRST_SCALAR,                 &amp;<a name='120'>
                                        P_QC,                           &amp;<a name='121'>
                                        P_QI,                           &amp;<a name='122'>
                                        STEPCU<a name='123'>
<a name='124'>
      REAL,    INTENT(IN) ::                                            &amp;<a name='125'>
                                        DT<a name='126'>
<a name='127'>
<font color=#447700>!wang<a name='128'></font>
      REAL,    INTENT(IN) ::            DY <a name='129'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: DX2D<a name='130'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: SCALEFUN,SCALEFUN1, &amp; <font color=#447700>!updaft area fraction for deep and shallow cnv<a name='131'></font>
                                                     SIGMU, SIGMU1      <font color=#447700>!updaft area fraction for      deep and shallow cnv<a name='132'></font>
<a name='133'>
<font color=#447700>!wang<a name='134'></font>
<a name='135'>
      REAL, OPTIONAL, INTENT(IN) :: PGCON,sas_mass_flux,shal_pgcon<a name='136'>
      INTEGER, OPTIONAL, INTENT(IN) :: shalconv<a name='137'>
      REAL(kind=kind_phys)       :: PGCON_USE,SHAL_PGCON_USE,massf<a name='138'>
      INTEGER :: shalconv_use<a name='139'>
      REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::      &amp;<a name='140'>
                                        RQCCUTEN,                       &amp;<a name='141'>
                                        RQICUTEN,                       &amp;<a name='142'>
                                        RQVCUTEN,                       &amp;<a name='143'>
                                        RTHCUTEN<a name='144'>
      REAL, DIMENSION(ims:ime, jms:jme, kms:kme), INTENT(INOUT) ::      &amp;<a name='145'>
                                        RUCUTEN,                        &amp;  <a name='146'>
                                        RVCUTEN                             <a name='147'>
      REAL, OPTIONAL,   INTENT(IN) ::    MOMMIX<a name='148'>
<a name='149'>
      REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL,                   &amp;<a name='150'>
                         INTENT(IN) :: HPBL2D,EVAP2D,HEAT2D                <font color=#447700>!Kwon for sha<a name='151'></font>
<a name='152'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(IN) ::               &amp;<a name='153'>
                                        XLAND<a name='154'>
<a name='155'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(INOUT) ::            &amp;<a name='156'>
                                        RAINCV, PRATEC<a name='157'>
<a name='158'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(OUT) ::              &amp;<a name='159'>
                                        HBOT,                           &amp;<a name='160'>
                                        HTOP<a name='161'>
<a name='162'>
      LOGICAL, DIMENSION(IMS:IME,JMS:JME), INTENT(INOUT) ::             &amp;<a name='163'>
                                        CU_ACT_FLAG<a name='164'>
<a name='165'>
<a name='166'>
      REAL,    DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN) ::      &amp;<a name='167'>
                                        DZ8W,                           &amp;<a name='168'>
                                        P8w,                            &amp;<a name='169'>
                                        Pcps,                           &amp;<a name='170'>
                                        PI3D,                           &amp;<a name='171'>
                                        QC3D,                           &amp;<a name='172'>
                                        QI3D,                           &amp;<a name='173'>
                                        QV3D,                           &amp;<a name='174'>
                                        RHO3D,                          &amp;<a name='175'>
                                        T3D,                            &amp;<a name='176'>
                                        U3D,                            &amp;<a name='177'>
                                        V3D,                            &amp;<a name='178'>
                                        W<a name='179'>
<a name='180'>
<font color=#447700>!--------------------------- LOCAL VARS ------------------------------<a name='181'></font>
<a name='182'>
      REAL,    DIMENSION(ims:ime, jms:jme) ::                           &amp;<a name='183'>
                                        PSFC<a name='184'>
<a name='185'>
      REAL,    DIMENSION(its:ite, jts:jte) ::                           &amp;<a name='186'>
                                        RAINCV1, PRATEC1<a name='187'>
      REAL,    DIMENSION(its:ite, jts:jte) ::                           &amp;<a name='188'>
                                        RAINCV2, PRATEC2<a name='189'>
<a name='190'>
      REAL     (kind=kind_phys) ::                                      &amp;<a name='191'>
                                        DELT,                           &amp;<a name='192'>
                                        DPSHC,                          &amp;<a name='193'>
                                        RDELT,                          &amp;<a name='194'>
                                        RSEED<a name='195'>
<a name='196'>
      REAL     (kind=kind_phys), DIMENSION(its:ite) ::                  &amp;<a name='197'>
                                        CLDWRK,                         &amp;<a name='198'>
                                        PS,                             &amp;<a name='199'>
                                        RCS,                            &amp;<a name='200'>
                                        RN,                             &amp;<a name='201'>
                                        SLIMSK,                         &amp;<a name='202'>
                                        HPBL,EVAP,HEAT                     <font color=#447700>!Kwon for shallow convection<a name='203'></font>
<a name='204'>
      REAL     (kind=kind_phys), DIMENSION(its:ite) :: garea             <font color=#447700>! grid box area in m^2, <a name='205'></font>
                                                                         <font color=#447700>! Wang scale-aware cnv<a name='206'></font>
<a name='207'>
      REAL     (kind=kind_phys), DIMENSION(its:ite) :: SCALEFUN_out,SCALEFUN1_out,&amp;  <font color=#447700>!updraft area fraction for deep and shallow cnv <a name='208'></font>
                                                      SIGMU_out,SIGMU1_out  <font color=#447700>!updraft area fraction for deep and shallow cnv<a name='209'></font>
<a name='210'>
<a name='211'>
      REAL     (kind=kind_phys), DIMENSION(its:ite, kts:kte+1) ::       &amp;<a name='212'>
                                        PRSI                            <a name='213'>
<a name='214'>
      REAL     (kind=kind_phys), DIMENSION(its:ite, kts:kte) ::         &amp;<a name='215'>
                                        DEL,                            &amp;<a name='216'>
                                        DOT,                            &amp;<a name='217'>
                                        PHIL,                           &amp;<a name='218'>
                                        PRSL,                           &amp;<a name='219'>
                                        PRSLK,                          &amp;<a name='220'>
                                        Q1,                             &amp; <a name='221'>
                                        T1,                             &amp; <a name='222'>
                                        U1,                             &amp; <a name='223'>
                                        V1,                             &amp; <a name='224'>
                                        ZI,                             &amp; <a name='225'>
                                        ZL <a name='226'>
<a name='227'>
      REAL     (kind=kind_phys), DIMENSION(its:ite, kts:kte) ::         &amp;<a name='228'>
                                        cnvw,cnvc,ud_mf,dd_mf,dt_mf        <font color=#447700>! Wang, *_mf not useful for HWRF. it is for transport<a name='229'></font>
<a name='230'>
      REAL     (kind=kind_phys), DIMENSION(its:ite, kts:kte, 2) ::      &amp;<a name='231'>
                                        QL <a name='232'>
<a name='233'>
      INTEGER, DIMENSION(its:ite) ::                                    &amp;<a name='234'>
                                        KBOT,                           &amp;<a name='235'>
                                        KTOP,                           &amp;<a name='236'>
                                        KCNV<a name='237'>
<a name='238'>
      INTEGER ::                                                        &amp;<a name='239'>
                                        I,                              &amp;<a name='240'>
                                        IGPVS,                          &amp;<a name='241'>
                                        IM,                             &amp;<a name='242'>
                                        J,                              &amp;<a name='243'>
                                        JCAP,                           &amp;<a name='244'>
                                        K,                              &amp;<a name='245'>
                                        KM,                             &amp;<a name='246'>
                                        KP,                             &amp;<a name='247'>
                                        KX,                             &amp;<a name='248'>
                                        NCLOUD <a name='249'>
<a name='250'>
      DATA IGPVS/0/<a name='251'>
<a name='252'>
<font color=#447700>!-----------------------------------------------------------------------<a name='253'></font>
<font color=#447700>!<a name='254'></font>
  <font color=#447700>!     write(0,*)' in scale-aware sas'<a name='255'></font>
<a name='256'>
<a name='257'>
      if(present(shalconv)) then<a name='258'>
         shalconv_use=shalconv<a name='259'>
      else<a name='260'>
#if (NMM_CORE==1)<a name='261'>
         shalconv_use=0<a name='262'>
#else<a name='263'>
#if (EM_CORE==1)<a name='264'>
         shalconv_use=1<a name='265'>
#else<a name='266'>
         shalconv_use=0<a name='267'>
#endif<a name='268'>
#endif<a name='269'>
      endif<a name='270'>
<a name='271'>
      if(present(pgcon)) then<a name='272'>
         pgcon_use  = pgcon<a name='273'>
      else<a name='274'>
<font color=#447700>!        pgcon_use  = 0.7     ! Gregory et al. (1997, QJRMS)<a name='275'></font>
         pgcon_use  = 0.55    <font color=#447700>! Zhang &amp; Wu (2003,JAS), used in GFS (25km res spectral)<a name='276'></font>
<font color=#447700>!        pgcon_use  = 0.2     ! HWRF, for model tuning purposes<a name='277'></font>
<font color=#447700>!        pgcon_use  = 0.3     ! GFDL, or so I am told<a name='278'></font>
<a name='279'>
         <font color=#447700>! For those attempting to tune pgcon:<a name='280'></font>
<a name='281'>
         <font color=#447700>! The value of 0.55 comes from an observational study of<a name='282'></font>
         <font color=#447700>! synoptic-scale deep convection and 0.7 came from an<a name='283'></font>
         <font color=#447700>! incorrect fit to the same data.  That value is likely<a name='284'></font>
         <font color=#447700>! correct for deep convection at gridscales near that of GFS,<a name='285'></font>
         <font color=#447700>! but is questionable in shallow convection, or for scales<a name='286'></font>
         <font color=#447700>! much finer than synoptic scales.<a name='287'></font>
<a name='288'>
         <font color=#447700>! Then again, the assumptions of SAS break down when the<a name='289'></font>
         <font color=#447700>! gridscale is near the convection scale anyway.  In a large<a name='290'></font>
         <font color=#447700>! storm such as a hurricane, there is often no environment to<a name='291'></font>
         <font color=#447700>! detrain into since adjancent gridsquares are also undergoing<a name='292'></font>
         <font color=#447700>! active convection.  Each gridsquare will no longer have many<a name='293'></font>
         <font color=#447700>! updrafts and downdrafts.  At sub-convective timescales, you<a name='294'></font>
         <font color=#447700>! will find unstable columns for many (say, 5 second length)<a name='295'></font>
         <font color=#447700>! timesteps in a real atmosphere during a convection cell's<a name='296'></font>
         <font color=#447700>! lifetime, so forcing it to be neutrally stable is unphysical.<a name='297'></font>
<a name='298'>
         <font color=#447700>! Hence, in scales near the convection scale (cells have<a name='299'></font>
         <font color=#447700>! ~0.5-4km diameter in hurricanes), this parameter is more of a<a name='300'></font>
         <font color=#447700>! tuning parameter to get a scheme that is inappropriate for<a name='301'></font>
         <font color=#447700>! that resolution to do a reasonable job.<a name='302'></font>
<a name='303'>
         <font color=#447700>! Your mileage might vary.<a name='304'></font>
<a name='305'>
         <font color=#447700>! - Sam Trahan<a name='306'></font>
      endif<a name='307'>
<a name='308'>
      if(present(sas_mass_flux)) then<a name='309'>
         massf=sas_mass_flux<a name='310'>
         <font color=#447700>! Use this to reduce the fluxes added by SAS to prevent<a name='311'></font>
         <font color=#447700>! computational instability as a result of large fluxes.<a name='312'></font>
      else<a name='313'>
         massf=9e9 <font color=#447700>! large number to disable check<a name='314'></font>
      endif<a name='315'>
<a name='316'>
      if(present(shal_pgcon)) then<a name='317'>
         if(shal_pgcon&gt;=0) then<a name='318'>
            shal_pgcon_use  = shal_pgcon<a name='319'>
         else<a name='320'>
            <font color=#447700>! shal_pgcon&lt;0 means use deep pgcon<a name='321'></font>
            shal_pgcon_use  = pgcon_use<a name='322'>
         endif<a name='323'>
      else<a name='324'>
         <font color=#447700>! Default: Same as deep convection pgcon<a name='325'></font>
         shal_pgcon_use  = pgcon_use<a name='326'>
         <font color=#447700>! Read the warning above though.  It may be advisable for<a name='327'></font>
         <font color=#447700>! these to be different.  <a name='328'></font>
      endif<a name='329'>
<a name='330'>
      DO J=JTS,JTE<a name='331'>
         DO I=ITS,ITE<a name='332'>
            CU_ACT_FLAG(I,J)=.TRUE.<a name='333'>
         ENDDO<a name='334'>
      ENDDO<a name='335'>
 <a name='336'>
      IM=ITE-ITS+1<a name='337'>
      KX=KTE-KTS+1<a name='338'>
      JCAP=126<a name='339'>
      DPSHC=30_kind_phys<a name='340'>
      DELT=DT*STEPCU<a name='341'>
      RDELT=1./DELT<a name='342'>
      NCLOUD=1<a name='343'>
<a name='344'>
<a name='345'>
   DO J=jms,jme<a name='346'>
     DO I=ims,ime<a name='347'>
       PSFC(i,j)=P8w(i,kms,j)<a name='348'>
     ENDDO<a name='349'>
   ENDDO<a name='350'>
<a name='351'>
   if(igpvs.eq.0) CALL <A href='../../html_code/phys/module_gfs_funcphys.F.html#GFUNCPHYS'>GFUNCPHYS</A><A href='../../html_code/phys/module_cu_scalesas.F.html#CU_SCALESAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GFUNCPHYS_3"><a name='352'>
   igpvs=1<a name='353'>
<a name='354'>
<font color=#447700>!-------------  J LOOP (OUTER) --------------------------------------------------<a name='355'></font>
<a name='356'>
   big_outer_j_loop: DO J=jts,jte<a name='357'>
<a name='358'>
<font color=#447700>! --------------- compute zi and zl -----------------------------------------<a name='359'></font>
      DO i=its,ite<a name='360'>
        ZI(I,KTS)=0.0<a name='361'>
      ENDDO<a name='362'>
<a name='363'>
      DO k=kts+1,kte<a name='364'>
        KM=K-1<a name='365'>
        DO i=its,ite<a name='366'>
          ZI(I,K)=ZI(I,KM)+dz8w(i,km,j)<a name='367'>
        ENDDO<a name='368'>
      ENDDO<a name='369'>
<a name='370'>
      DO k=kts+1,kte<a name='371'>
        KM=K-1<a name='372'>
        DO i=its,ite<a name='373'>
          ZL(I,KM)=(ZI(I,K)+ZI(I,KM))*0.5<a name='374'>
        ENDDO<a name='375'>
      ENDDO<a name='376'>
<a name='377'>
      DO i=its,ite<a name='378'>
        ZL(I,KTE)=2.*ZI(I,KTE)-ZL(I,KTE-1)<a name='379'>
      ENDDO<a name='380'>
<a name='381'>
<font color=#447700>! --------------- end compute zi and zl -------------------------------------<a name='382'></font>
<a name='383'>
      DO i=its,ite<a name='384'>
        <font color=#447700>!!PS(i)=PSFC(i,j)*.001<a name='385'></font>
        PS(i)=PSFC(i,j)      <font color=#447700>! wang, in Pa<a name='386'></font>
        RCS(i)=1.<a name='387'>
        SLIMSK(i)=ABS(XLAND(i,j)-2.)<a name='388'>
<a name='389'>
        garea(I)=DX2D(i,j)*DY*2.0         <font color=#447700>!wang,  grid box area in m^2<a name='390'></font>
        KCNV(I)=0                         <font color=#447700>!wang, initialize KCNV<a name='391'></font>
      ENDDO<a name='392'>
<a name='393'>
#if (NMM_CORE == 1)<a name='394'>
      if(shalconv_use==1) then<a name='395'>
      DO i=its,ite<a name='396'>
         HPBL(I) = HPBL2D(I,J)          <font color=#447700>!kwon for shallow convection<a name='397'></font>
         EVAP(I) = EVAP2D(I,J)          <font color=#447700>!kwon for shallow convection<a name='398'></font>
         HEAT(I) = HEAT2D(I,J)          <font color=#447700>!kwon for shallow convection<a name='399'></font>
      ENDDO<a name='400'>
      endif<a name='401'>
#endif<a name='402'>
<a name='403'>
      DO i=its,ite<a name='404'>
        PRSI(i,kts)=PS(i)<a name='405'>
      ENDDO<a name='406'>
<a name='407'>
      DO k=kts,kte<a name='408'>
        kp=k+1<a name='409'>
        DO i=its,ite<a name='410'>
          <font color=#447700>!PRSL(I,K)=Pcps(i,k,j)*.001<a name='411'></font>
          PRSL(I,K)=Pcps(i,k,j)          <font color=#447700>!wang in Pa<a name='412'></font>
          PHIL(I,K)=ZL(I,K)*GRAV<a name='413'>
          <font color=#447700>!DOT(i,k)=-5.0E-4*GRAV*rho3d(i,k,j)*(w(i,k,j)+w(i,kp,j))<a name='414'></font>
          DOT(i,k)=-0.5*GRAV*rho3d(i,k,j)*(w(i,k,j)+w(i,kp,j)) <font color=#447700>!wang in Pa<a name='415'></font>
        ENDDO<a name='416'>
      ENDDO<a name='417'>
<a name='418'>
      DO k=kts,kte<a name='419'>
        DO i=its,ite<a name='420'>
          DEL(i,k)=PRSL(i,k)*GRAV/RD*dz8w(i,k,j)/T3D(i,k,j)<a name='421'>
          U1(i,k)=U3D(i,k,j)<a name='422'>
          V1(i,k)=V3D(i,k,j)<a name='423'>
          Q1(i,k)=QV3D(i,k,j)/(1.+QV3D(i,k,j))<a name='424'>
          T1(i,k)=T3D(i,k,j)<a name='425'>
          QL(i,k,1)=QI3D(i,k,j)/(1.+QI3D(i,k,j))<a name='426'>
          QL(i,k,2)=QC3D(i,k,j)/(1.+QC3D(i,k,j))<a name='427'>
          <font color=#447700>!PRSLK(I,K)=(PRSL(i,k)*.01)**ROVCP<a name='428'></font>
          PRSLK(I,K)=(PRSL(i,k)*1.0e-5)**ROVCP   <font color=#447700>! prsl in Pa<a name='429'></font>
        ENDDO<a name='430'>
      ENDDO<a name='431'>
<a name='432'>
      DO k=kts+1,kte+1<a name='433'>
        km=k-1<a name='434'>
        DO i=its,ite<a name='435'>
          PRSI(i,k)=PRSI(i,km)-del(i,km) <a name='436'>
        ENDDO<a name='437'>
      ENDDO<a name='438'>
<a name='439'>
       <font color=#447700>!    write(0,*)'dx2d=',dx2d(its,jts:jts+5)<a name='440'></font>
       <font color=#447700>!    write(0,*)'dy=',dy<a name='441'></font>
       <font color=#447700>!    write(0,*)'ps=',ps(its)<a name='442'></font>
       <font color=#447700>!    write(0,*)'del=',del(its,kts:kts+5)<a name='443'></font>
       <font color=#447700>!    write(0,*)'prsl=',prsl(its,kts:kts+5)<a name='444'></font>
       <font color=#447700>!    write(0,*)'dot=',dot(its,kts:kts+5)<a name='445'></font>
<a name='446'>
<font color=#447700>!      CALL SASCNVN(IM,IM,KX,JCAP,DELT,DEL,PRSL,PS,PHIL,                  &amp;<a name='447'></font>
<font color=#447700>!                  QL,Q1,T1,U1,V1,RCS,CLDWRK,RN,KBOT,                    &amp;<a name='448'></font>
<font color=#447700>!                  KTOP,KCNV,SLIMSK,DOT,NCLOUD,PGCON_USE,massf)<a name='449'></font>
       <font color=#447700>!! call scale-aware deep cnv,  <a name='450'></font>
       <font color=#447700>!! added 2015-12-10 W Wang<a name='451'></font>
       <font color=#447700>!! Note: ps, prsl,del are in Pa. dot in pa/s<a name='452'></font>
          <a name='453'>
        CALL <A href='../../html_code/phys/module_cu_scalesas.F.html#SCALE_SASCNVN'>scale_sascnvn</A><A href='../../html_code/phys/module_cu_scalesas.F.html#CU_SCALESAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCALE_SASCNVN_1">(IM,IM,KX,JCAP,DELT,DEL,PRSL,PS,PHIL,QL,     &amp;   <a name='454'>
            q1,t1,u1,v1,cldwrk,rn,kbot,ktop,kcnv,nint(slimsk),garea,       &amp;<a name='455'>
            dot,ncloud,ud_mf,dd_mf,dt_mf,cnvw,cnvc,SIGMU_out,SCALEFUN_out)<a name='456'>
<font color=#447700>!<a name='457'></font>
<a name='458'>
      do i=its,ite<a name='459'>
        RAINCV1(I,J)=RN(I)*1000./STEPCU<a name='460'>
        PRATEC1(I,J)=RN(I)*1000./(STEPCU * DT)<a name='461'>
      enddo<a name='462'>
<font color=#447700>!<a name='463'></font>
      do i=its,ite<a name='464'>
        RAINCV2(I,J)=0.<a name='465'>
        PRATEC2(I,J)=0.<a name='466'>
      enddo<a name='467'>
<font color=#447700>!<a name='468'></font>
<font color=#447700>!<a name='469'></font>
      if_shallow_conv: if(shalconv_use==1) then<a name='470'>
#if (NMM_CORE == 1)<a name='471'>
         <font color=#447700>! NMM calls the new shallow convection developed by J Han<a name='472'></font>
         <font color=#447700>! (Added to WRF by Y.Kwon)<a name='473'></font>
<font color=#447700>!        call shalcnv(im,im,kx,jcap,delt,del,prsl,ps,phil,ql,        &amp;<a name='474'></font>
<font color=#447700>!     &amp;               q1,t1,u1,v1,rcs,rn,kbot,ktop,kcnv,slimsk,      &amp;<a name='475'></font>
<font color=#447700>!     &amp;               dot,ncloud,hpbl,heat,evap,shal_pgcon_use)<a name='476'></font>
<a name='477'>
       <font color=#447700>!! call scale-aware shallow cnv,  <a name='478'></font>
       <font color=#447700>!! added 2015-12-10 W Wang<a name='479'></font>
        call <A href='../../html_code/phys/module_cu_scalesas.F.html#SCALE_SHALCNV'>scale_shalcnv</A><A href='../../html_code/phys/module_cu_scalesas.F.html#CU_SCALESAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCALE_SHALCNV_1">(im,im,kx,delt,del,prsl,ps,phil,ql,       &amp;<a name='480'>
     &amp;     q1,t1,u1,v1,rn,kbot,ktop,kcnv,nint(slimsk),garea,             &amp;<a name='481'>
     &amp;     dot,ncloud,hpbl,heat,evap,ud_mf,dt_mf,cnvw,cnvc,SIGMU1_out,SCALEFUN1_out)<a name='482'>
<font color=#447700>!<a name='483'></font>
      DO I=ITS,ITE<a name='484'>
        RAINCV2(I,J)=RN(I)*1000./STEPCU<a name='485'>
        PRATEC2(I,J)=RN(I)*1000./(STEPCU * DT)<a name='486'>
      ENDDO<a name='487'>
<font color=#447700>!<a name='488'></font>
#else<a name='489'>
#if (EM_CORE == 1)<a name='490'>
        <font color=#447700>! NOTE: ARW should be able to call the new shalcnv here, but<a name='491'></font>
        <font color=#447700>! they need to add the three new variables, so I'm leaving the<a name='492'></font>
        <font color=#447700>! old shallow convection call here - Sam Trahan<a name='493'></font>
       <a name='494'>
      <font color=#447700>!!wang removed  CALL OLD_ARW_SHALCV(IM,IM,KX,DELT,DEL,PRSI,PRSL,PRSLK,KCNV,Q1,T1,DPSHC)<a name='495'></font>
#else<a name='496'>
        <font color=#447700>! Shallow convection is untested for other cores.<a name='497'></font>
#endif<a name='498'>
#endif<a name='499'>
     endif if_shallow_conv<a name='500'>
<a name='501'>
<font color=#447700>!! output updraft area fractions for deep and shallow cnv<a name='502'></font>
      do i=its,ite<a name='503'>
        SCALEFUN(I,J)=SCALEFUN_OUT(i)<a name='504'>
        SCALEFUN1(I,J)=SCALEFUN1_OUT(i)<a name='505'>
        SIGMU(I,J)=SIGMU_OUT(i)<a name='506'>
        SIGMU1(I,J)=SIGMU1_OUT(i)<a name='507'>
      enddo<a name='508'>
<a name='509'>
<a name='510'>
        DO I=ITS,ITE<a name='511'>
        RAINCV(I,J)= RAINCV1(I,J) + RAINCV2(I,J)<a name='512'>
        PRATEC(I,J)= PRATEC1(I,J) + PRATEC2(I,J)<a name='513'>
        HBOT(I,J)=KBOT(I)<a name='514'>
        HTOP(I,J)=KTOP(I)<a name='515'>
      ENDDO<a name='516'>
<a name='517'>
      DO K=KTS,KTE<a name='518'>
        DO I=ITS,ITE<a name='519'>
          RTHCUTEN(I,K,J)=(T1(I,K)-T3D(I,K,J))/PI3D(I,K,J)*RDELT<a name='520'>
          RQVCUTEN(I,K,J)=(Q1(I,K)/(1.-q1(i,k))-QV3D(I,K,J))*RDELT<a name='521'>
        ENDDO<a name='522'>
      ENDDO<a name='523'>
<a name='524'>
<font color=#447700>!===============================================================================<a name='525'></font>
<font color=#447700>!     ADD MOMENTUM MIXING TERM AS TENDENCIES. This is gopal's doing for SAS<a name='526'></font>
<font color=#447700>!     MOMMIX is the reduction factor set to 0.7 by default. Because NMM has <a name='527'></font>
<font color=#447700>!     divergence damping term, a reducion factor for cumulum mixing may be<a name='528'></font>
<font color=#447700>!     required otherwise storms were too weak.<a name='529'></font>
<font color=#447700>!===============================================================================<a name='530'></font>
<font color=#447700>!<a name='531'></font>
#if (NMM_CORE == 1)<a name='532'>
      DO K=KTS,KTE<a name='533'>
        DO I=ITS,ITE<a name='534'>
<font color=#447700>!         RUCUTEN(I,J,K)=MOMMIX*(U1(I,K)-U3D(I,K,J))*RDELT<a name='535'></font>
<font color=#447700>!         RVCUTEN(I,J,K)=MOMMIX*(V1(I,K)-V3D(I,K,J))*RDELT<a name='536'></font>
         RUCUTEN(I,J,K)=(U1(I,K)-U3D(I,K,J))*RDELT<a name='537'>
         RVCUTEN(I,J,K)=(V1(I,K)-V3D(I,K,J))*RDELT<a name='538'>
        ENDDO<a name='539'>
      ENDDO<a name='540'>
#endif<a name='541'>
<a name='542'>
<a name='543'>
      IF(P_QC .ge. P_FIRST_SCALAR)THEN<a name='544'>
        DO K=KTS,KTE<a name='545'>
          DO I=ITS,ITE<a name='546'>
            RQCCUTEN(I,K,J)=(QL(I,K,2)/(1.-ql(i,k,2))-QC3D(I,K,J))*RDELT<a name='547'>
          ENDDO<a name='548'>
        ENDDO<a name='549'>
      ENDIF<a name='550'>
<a name='551'>
      IF(P_QI .ge. P_FIRST_SCALAR)THEN<a name='552'>
        DO K=KTS,KTE<a name='553'>
          DO I=ITS,ITE<a name='554'>
            RQICUTEN(I,K,J)=(QL(I,K,1)/(1.-ql(i,k,1))-QI3D(I,K,J))*RDELT<a name='555'>
          ENDDO<a name='556'>
        ENDDO<a name='557'>
      ENDIF<a name='558'>
<a name='559'>
   ENDDO big_outer_j_loop    <font color=#447700>! Outer most J loop<a name='560'></font>
<a name='561'>
   END SUBROUTINE CU_SCALESAS<a name='562'>
<a name='563'>
<font color=#447700>!====================================================================<a name='564'></font>
<A NAME='SCALESASINIT'><A href='../../html_code/phys/module_cu_scalesas.F.html#SCALESASINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='565'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>scalesasinit</font>(RTHCUTEN,RQVCUTEN,RQCCUTEN,RQICUTEN,          &amp; <A href='../../call_to/SCALESASINIT.html' TARGET='index'>1</A><a name='566'>
                      RUCUTEN,RVCUTEN,                              &amp;   <a name='567'>
                      RESTART,P_QC,P_QI,P_FIRST_SCALAR,             &amp;<a name='568'>
                      allowed_to_read,                              &amp;<a name='569'>
                      ids, ide, jds, jde, kds, kde,                 &amp;<a name='570'>
                      ims, ime, jms, jme, kms, kme,                 &amp;<a name='571'>
                      its, ite, jts, jte, kts, kte                  )<a name='572'>
<font color=#447700>!--------------------------------------------------------------------<a name='573'></font>
   IMPLICIT NONE<a name='574'>
<font color=#447700>!--------------------------------------------------------------------<a name='575'></font>
   LOGICAL , INTENT(IN)           ::  allowed_to_read,restart<a name='576'>
   INTEGER , INTENT(IN)           ::  ids, ide, jds, jde, kds, kde, &amp;<a name='577'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='578'>
                                      its, ite, jts, jte, kts, kte<a name='579'>
   INTEGER , INTENT(IN)           ::  P_FIRST_SCALAR, P_QI, P_QC<a name='580'>
<a name='581'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::  &amp;<a name='582'>
                                                              RTHCUTEN, &amp;<a name='583'>
                                                              RQVCUTEN, &amp;<a name='584'>
                                                              RQCCUTEN, &amp;<a name='585'>
                                                              RQICUTEN<a name='586'>
   REAL,     DIMENSION( ims:ime , jms:jme , kms:kme ) , INTENT(OUT) ::  &amp;<a name='587'>
                                                              RUCUTEN,  &amp; <font color=#447700>! gopal's doing for SAS<a name='588'></font>
                                                              RVCUTEN   <a name='589'>
<a name='590'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='591'>
<a name='592'>
   jtf=min0(jte,jde-1)<a name='593'>
   ktf=min0(kte,kde-1)<a name='594'>
   itf=min0(ite,ide-1)<a name='595'>
<a name='596'>
#ifdef HWRF<a name='597'>
<font color=#447700>!zhang's doing<a name='598'></font>
   IF(.not.restart .or. .not.allowed_to_read)THEN<a name='599'>
<font color=#447700>!end of zhang's doing<a name='600'></font>
#else<a name='601'>
   IF(.not.restart)THEN<a name='602'>
#endif<a name='603'>
     DO j=jts,jtf<a name='604'>
     DO k=kts,ktf<a name='605'>
     DO i=its,itf<a name='606'>
       RTHCUTEN(i,k,j)=0.<a name='607'>
       RQVCUTEN(i,k,j)=0.<a name='608'>
       RUCUTEN(i,j,k)=0.   <a name='609'>
       RVCUTEN(i,j,k)=0.    <a name='610'>
     ENDDO<a name='611'>
     ENDDO<a name='612'>
     ENDDO<a name='613'>
<a name='614'>
     IF (P_QC .ge. P_FIRST_SCALAR) THEN<a name='615'>
        DO j=jts,jtf<a name='616'>
        DO k=kts,ktf<a name='617'>
        DO i=its,itf<a name='618'>
           RQCCUTEN(i,k,j)=0.<a name='619'>
        ENDDO<a name='620'>
        ENDDO<a name='621'>
        ENDDO<a name='622'>
     ENDIF<a name='623'>
<a name='624'>
     IF (P_QI .ge. P_FIRST_SCALAR) THEN<a name='625'>
        DO j=jts,jtf<a name='626'>
        DO k=kts,ktf<a name='627'>
        DO i=its,itf<a name='628'>
           RQICUTEN(i,k,j)=0.<a name='629'>
        ENDDO<a name='630'>
        ENDDO<a name='631'>
        ENDDO<a name='632'>
     ENDIF<a name='633'>
   ENDIF<a name='634'>
<a name='635'>
      END SUBROUTINE scalesasinit<a name='636'>
<a name='637'>
<font color=#447700>!-----------------------------------------------------------------------<a name='638'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='639'></font>
<font color=#447700>!!! scale aware SAS <a name='640'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='641'></font>
<a name='642'>
<A NAME='SCALE_SASCNVN'><A href='../../html_code/phys/module_cu_scalesas.F.html#SCALE_SASCNVN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='643'>
      <font color=#993300>subroutine </font><font color=#cc0000>scale_sascnvn</font>(im,ix,km,jcap,delt,delp,prslp,psp,phil,ql,  &amp; <A href='../../call_to/SCALE_SASCNVN.html' TARGET='index'>1</A>,<A href='../../call_from/SCALE_SASCNVN.html' TARGET='index'>3</A><a name='644'>
     &amp;     q1,t1,u1,v1,cldwrk,rn,kbot,ktop,kcnv,islimsk,garea,             &amp;<a name='645'>
<font color=#447700>!     &amp;     dot,ncloud,ud_mf,dd_mf,dt_mf,cnvw,cnvc, tmpout9)<a name='646'></font>
     &amp;     dot,ncloud,ud_mf,dd_mf,dt_mf,cnvw,cnvc, sigmuout,scaldfunc)<a name='647'>
<font color=#447700>!    &amp;     q1,t1,u1,v1,rcs,cldwrk,rn,kbot,ktop,kcnv,islimsk,<a name='648'></font>
<font color=#447700>!    &amp;     dot,ncloud,ud_mf,dd_mf,dt_mf,me)<a name='649'></font>
<font color=#447700>!<a name='650'></font>
<font color=#447700>!      use machine , only : kind_phys<a name='651'></font>
<font color=#447700>!      use funcphys , only : fpvs<a name='652'></font>
<font color=#447700>!      use physcons, grav =&gt; con_g, cp =&gt; con_cp, hvap =&gt; con_hvap<a name='653'></font>
       USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_cu_scalesas.F.html#SCALE_SASCNVN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_24">, ONLY : kind_phys<a name='654'>
       USE <A href='../../html_code/phys/module_gfs_funcphys.F.html#MODULE_GFS_FUNCPHYS'>MODULE_GFS_FUNCPHYS</A><A href='../../html_code/phys/module_cu_scalesas.F.html#SCALE_SASCNVN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_FUNCPHYS_10">, ONLY : fpvs<a name='655'>
       USE <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_PHYSCONS</A><A href='../../html_code/phys/module_cu_scalesas.F.html#SCALE_SASCNVN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_16">, grav =&gt; con_g, cp =&gt; con_cp         &amp;<a name='656'>
     &amp;  ,            hvap =&gt; con_hvap                               &amp;<a name='657'>
     &amp;,             rv =&gt; con_rv, fv =&gt; con_fvirt, t0c =&gt; con_t0c    &amp;<a name='658'>
     &amp;,             rd =&gt; con_rd, cvap =&gt; con_cvap, cliq =&gt; con_cliq &amp;<a name='659'>
     &amp;,             eps =&gt; con_eps, epsm1 =&gt; con_epsm1 <a name='660'>
      implicit none<a name='661'>
<font color=#447700>!<a name='662'></font>
      integer            im, ix,  km, jcap, ncloud,                 &amp;<a name='663'>
     &amp;                   kbot(im), ktop(im), kcnv(im) <a name='664'>
<font color=#447700>!    &amp;,                  me<a name='665'></font>
      real(kind=kind_phys) delt<a name='666'>
      real(kind=kind_phys) psp(im),    delp(ix,km), prslp(ix,km)<a name='667'>
      real(kind=kind_phys) ps(im),     del(ix,km),  prsl(ix,km),       &amp;<a name='668'>
     &amp;                     ql(ix,km,2),q1(ix,km),   t1(ix,km),         &amp; <a name='669'>
     &amp;                     u1(ix,km),  v1(ix,km),                      &amp;<a name='670'>
<font color=#447700>!    &amp;                     u1(ix,km),  v1(ix,km),   rcs(im),<a name='671'></font>
     &amp;                     cldwrk(im), rn(im),      garea(im),         &amp;   <a name='672'>
     &amp;                     dot(ix,km), phil(ix,km),                    &amp;<a name='673'>
     &amp;                     cnvw(ix,km),cnvc(ix,km),                    &amp;<a name='674'>
<font color=#447700>! hchuang code change mass flux output<a name='675'></font>
     &amp;                     ud_mf(im,km),dd_mf(im,km),dt_mf(im,km)<a name='676'>
<font color=#447700>!<a name='677'></font>
      integer              i, indx, jmn, k, kk, km1, n<a name='678'>
      integer, dimension(im), intent(in) :: islimsk<a name='679'>
<font color=#447700>!     integer              latd,lond<a name='680'></font>
<font color=#447700>!<a name='681'></font>
      real(kind=kind_phys) clam,    cxlamu,  cxlamd,                   &amp;<a name='682'>
     &amp;                     xlamde,  xlamdd,                            &amp;<a name='683'>
     &amp;                     crtlamu, crtlamd<a name='684'>
<font color=#447700>! <a name='685'></font>
<font color=#447700>!     real(kind=kind_phys) detad<a name='686'></font>
      real(kind=kind_phys) adw,     aup,     aafac,                    &amp;<a name='687'>
     &amp;                     beta,    betal,   betas,                    &amp;<a name='688'>
     &amp;                     c0l,     c0s,     d0,                       &amp;<a name='689'>
     &amp;                     c1l,     c1s,     asolfac,                  &amp;<a name='690'>
     &amp;                     dellat,  delta,   desdt,   dg,              &amp;<a name='691'>
     &amp;                     dh,      dhh,     dp,                       &amp;<a name='692'>
     &amp;                     dq,      dqsdp,   dqsdt,   dt,              &amp;<a name='693'>
     &amp;                     dt2,     dtmax,   dtmin,                    &amp;<a name='694'>
     &amp;                     dv1h,    dv2h,    dv3h,                     &amp;<a name='695'>
     &amp;                     dv1q,    dv2q,    dv3q,                     &amp;<a name='696'>
     &amp;                     dz,      dz1,     e1,      edtmax,          &amp;<a name='697'>
     &amp;                     edtmaxl, edtmaxs, el2orc,  elocp,           &amp;<a name='698'>
     &amp;                     es,      etah,    cthk,    dthk,            &amp;<a name='699'>
     &amp;                     evef,    evfact,  evfactl, fact1,           &amp;<a name='700'>
     &amp;                     fact2,   factor,  fjcap,   fkm,             &amp;<a name='701'>
     &amp;                     g,       gamma,   pprime,  cm,              &amp;<a name='702'>
     &amp;                     qlk,     qrch,    qs,                       &amp;<a name='703'>
     &amp;                     rain,    rfact,   shear,                    &amp;<a name='704'>
     &amp;                     val,     val1,    val2,                     &amp;<a name='705'>
     &amp;                     w1,      w1l,     w1s,     w2,              &amp;<a name='706'>
     &amp;                     w2l,     w2s,     w3,      w3l,             &amp;<a name='707'>
     &amp;                     w3s,     w4,      w4l,     w4s,             &amp; <a name='708'>
     &amp;                     xdby,    xpw,     xpwd,                     &amp;<a name='709'>
<font color=#447700>!    &amp;                     xqrch,   mbdt,    tem,<a name='710'></font>
     &amp;                     xqrch,   tem,     tem1,    tem2,            &amp;<a name='711'>
     &amp;                     ptem,    ptem1,   ptem2,                    &amp;<a name='712'>
     &amp;                     pgcon<a name='713'>
<font color=#447700>!<a name='714'></font>
      integer              kb(im), kbcon(im), kbcon1(im),              &amp;<a name='715'>
     &amp;                     ktcon(im), ktcon1(im), ktconn(im),          &amp;<a name='716'>
     &amp;                     jmin(im), lmin(im), kbmax(im),              &amp;<a name='717'>
     &amp;                     kbm(im), kmax(im)<a name='718'>
<font color=#447700>!<a name='719'></font>
      real(kind=kind_phys) aa1(im),     acrt(im),   acrtfct(im),       &amp;<a name='720'>
     &amp;                     delhbar(im), delq(im),   delq2(im),         &amp;<a name='721'>
     &amp;                     delqbar(im), delqev(im), deltbar(im),       &amp;<a name='722'>
     &amp;                     deltv(im),   dtconv(im), edt(im),           &amp;<a name='723'>
     &amp;                     edto(im),    edtx(im),   fld(im),           &amp;<a name='724'>
     &amp;                     hcdo(im,km), hmax(im),   hmin(im),          &amp;<a name='725'>
     &amp;                     ucdo(im,km), vcdo(im,km),aa2(im),           &amp;<a name='726'>
     &amp;                     pdot(im),    po(im,km),                     &amp;<a name='727'>
     &amp;                     pwavo(im),   pwevo(im),  mbdt(im),          &amp;<a name='728'>
     &amp;                     qcdo(im,km), qcond(im),  qevap(im),         &amp;<a name='729'>
     &amp;                     rntot(im),   vshear(im), xaa0(im),          &amp;<a name='730'>
     &amp;                     xk(im),      xlamd(im),  cina(im),          &amp;<a name='731'>
     &amp;                     xmb(im),     xmbmax(im), xpwav(im),         &amp;<a name='732'>
     &amp;                     xpwev(im),   delubar(im),delvbar(im)<a name='733'>
<font color=#447700>!<a name='734'></font>
      real(kind=kind_phys) c0(im),      c1(im)<a name='735'>
<font color=#447700>!cj<a name='736'></font>
      real(kind=kind_phys) cinpcr,  cinpcrmx,  cinpcrmn,              &amp;<a name='737'>
     &amp;                     cinacr,  cinacrmx,  cinacrmn<a name='738'>
<font color=#447700>!cj<a name='739'></font>
<font color=#447700>!  parameters for updraft core fraction calculation<a name='740'></font>
      real(kind=kind_phys) fs0,  fp1<a name='741'>
      real(kind=kind_phys) gfudarea<a name='742'>
      integer itsig<a name='743'>
<font color=#447700>!<a name='744'></font>
<font color=#447700>!  parameters for updraft velocity calculation<a name='745'></font>
      real(kind=kind_phys) bet1,    cd1,     f1,      gam1,           &amp;<a name='746'>
     &amp;                     bb1,     bb2,     wucb,                    &amp;    <a name='747'>
     &amp;                     tfac<a name='748'>
<font color=#447700>!<a name='749'></font>
<font color=#447700>!c  physical parameters<a name='750'></font>
      parameter(g=grav,asolfac=0.89)<a name='751'>
      parameter(elocp=hvap/cp,el2orc=hvap*hvap/(rv*cp))<a name='752'>
<font color=#447700>!     parameter(c0l=.0015,c0s=.002,c1l=.0015,c1s=.002,d0=.07)<a name='753'></font>
      <font color=#447700>!parameter(c0s=.002,c1s=.002,d0=.07)<a name='754'></font>
      parameter(c0s=.002,c1s=.002,d0=.01)<a name='755'>
      parameter(c0l=c0s*asolfac,c1l=c1s*asolfac)<a name='756'>
      parameter(cm=1.0,delta=fv)<a name='757'>
      parameter(fact1=(cvap-cliq)/rv,fact2=hvap/rv-fact1*t0c)<a name='758'>
      parameter(cthk=150.,dthk=25.)<a name='759'>
      parameter(cinpcrmx=180.,cinpcrmn=120.)<a name='760'>
      parameter(cinacrmx=-120.,cinacrmn=-120.)<a name='761'>
      parameter(bet1=1.875,cd1=.506,f1=2.0,gam1=.5)<a name='762'>
      parameter(tfac=1.0)<a name='763'>
      parameter(itsig=7,gfudarea=25632653.0)<a name='764'>
<font color=#447700>!c  local variables and arrays<a name='765'></font>
      real(kind=kind_phys) pfld(im,km),    to(im,km),     qo(im,km),   &amp;<a name='766'>
     &amp;                     uo(im,km),      vo(im,km),     qeso(im,km)<a name='767'>
<font color=#447700>!  for updraft velocity calculation<a name='768'></font>
      real(kind=kind_phys) wu2(im,km),     buo(im,km),    drag(im,km)<a name='769'>
      real(kind=kind_phys) wc(im),         wcxmb(im)<a name='770'>
      real(kind=kind_phys) wbar(im),       xmbeta(im)<a name='771'>
      real(kind=kind_phys) scaldfunc(im),  awlam(im),  xlamx(im),       &amp;<a name='772'>
     &amp;                     sigmaw(im),     sigmagf(im) ,   sigmagfm(im) <a name='773'>
<a name='774'>
<font color=#447700>!! tmpout<a name='775'></font>
      real(kind=kind_phys) tmpout9(im), sigmuout(im)<a name='776'>
<a name='777'>
<font color=#447700>!<a name='778'></font>
<font color=#447700>!c  cloud water<a name='779'></font>
<font color=#447700>!     real(kind=kind_phys) tvo(im,km)<a name='780'></font>
      real(kind=kind_phys) qlko_ktcon(im), dellal(im,km), tvo(im,km),    &amp;<a name='781'>
     &amp;                     dbyo(im,km),    zo(im,km),                    &amp;<a name='782'>
     &amp;                     xlamue(im,km),  xlamud(im,km),                &amp;<a name='783'>
     &amp;                     fent1(im,km),   fent2(im,km),  frh(im,km),    &amp;<a name='784'>
     &amp;                     heo(im,km),     heso(im,km),                  &amp;<a name='785'>
     &amp;                     qrcd(im,km),    dellah(im,km), dellaq(im,km), &amp;<a name='786'>
     &amp;                     dellau(im,km),  dellav(im,km), hcko(im,km),   &amp;<a name='787'>
     &amp;                     ucko(im,km),    vcko(im,km),   qcko(im,km),   &amp; <a name='788'>
     &amp;                     eta(im,km),     etad(im,km),   zi(im,km),     &amp;<a name='789'>
     &amp;                     qrcko(im,km),   qrcdo(im,km),                  &amp;<a name='790'>
     &amp;                     pwo(im,km),     pwdo(im,km),   c0t(im,km),    &amp;<a name='791'>
     &amp;                     tx1(im),        sumx(im),      cnvwt(im,km)<a name='792'>
<font color=#447700>!    &amp;,                    rhbar(im)<a name='793'></font>
<font color=#447700>!<a name='794'></font>
      logical totflg, cnvflg(im), flg(im)<a name='795'>
<font color=#447700>!<a name='796'></font>
      real(kind=kind_phys) pcrit(15), acritt(15), acrit(15)<a name='797'>
<font color=#447700>!     save pcrit, acritt<a name='798'></font>
      data pcrit/850.,800.,750.,700.,650.,600.,550.,500.,450.,400.,      &amp;<a name='799'>
     &amp;           350.,300.,250.,200.,150./<a name='800'>
      data acritt/.0633,.0445,.0553,.0664,.075,.1082,.1521,.2216,        &amp;<a name='801'>
     &amp;           .3151,.3677,.41,.5255,.7663,1.1686,1.6851/<a name='802'>
<font color=#447700>!c  gdas derived acrit<a name='803'></font>
<font color=#447700>!c     data acritt/.203,.515,.521,.566,.625,.665,.659,.688,<a name='804'></font>
<font color=#447700>!c    &amp;            .743,.813,.886,.947,1.138,1.377,1.896/<a name='805'></font>
      real(kind=kind_phys) tf, tcr, tcrf<a name='806'>
      parameter (tf=233.16, tcr=263.16, tcrf=1.0/(tcr-tf))<a name='807'>
<font color=#447700>!<a name='808'></font>
<font color=#447700>!c-----------------------------------------------------------------------<a name='809'></font>
<font color=#447700>!<a name='810'></font>
<font color=#447700>!************************************************************************<a name='811'></font>
<font color=#447700>!     convert input Pa terms to Cb terms  -- Moorthi<a name='812'></font>
      ps   = psp   * 0.001<a name='813'>
      prsl = prslp * 0.001<a name='814'>
      del  = delp  * 0.001<a name='815'>
<font color=#447700>!************************************************************************<a name='816'></font>
<font color=#447700>!<a name='817'></font>
<font color=#447700>!<a name='818'></font>
      km1 = km - 1<a name='819'>
<font color=#447700>!c<a name='820'></font>
<font color=#447700>!c  initialize arrays<a name='821'></font>
<font color=#447700>!c<a name='822'></font>
      do i=1,im<a name='823'>
        cnvflg(i) = .true.<a name='824'>
        rn(i)=0.<a name='825'>
        mbdt(i)=10.<a name='826'>
        kbot(i)=km+1<a name='827'>
        ktop(i)=0<a name='828'>
        kbcon(i)=km<a name='829'>
        ktcon(i)=1<a name='830'>
        ktconn(i)=1<a name='831'>
        dtconv(i) = 3600.<a name='832'>
        cldwrk(i) = 0.<a name='833'>
        pdot(i) = 0.<a name='834'>
        lmin(i) = 1<a name='835'>
        jmin(i) = 1<a name='836'>
        qlko_ktcon(i) = 0.<a name='837'>
        edt(i)  = 0.<a name='838'>
        edto(i) = 0.<a name='839'>
        edtx(i) = 0.<a name='840'>
        acrt(i) = 0.<a name='841'>
        acrtfct(i) = 1.<a name='842'>
        aa1(i)  = 0.<a name='843'>
        aa2(i)  = 0.<a name='844'>
        xaa0(i) = 0.<a name='845'>
        cina(i) = 0.<a name='846'>
        pwavo(i)= 0.<a name='847'>
        pwevo(i)= 0.<a name='848'>
        xpwav(i)= 0.<a name='849'>
        xpwev(i)= 0.<a name='850'>
        vshear(i) = 0.<a name='851'>
<a name='852'>
         scaldfunc(i)=-1.0   <font color=#447700>! initialized wang<a name='853'></font>
          sigmaw(i)=-1.0<a name='854'>
          sigmagf(i)=-1.0<a name='855'>
          sigmagfm(i)=-1.0<a name='856'>
          tmpout9(i)=-1.0<a name='857'>
          sigmuout(i)=-1.0<a name='858'>
      enddo<a name='859'>
<font color=#447700>!<a name='860'></font>
      do i=1,im<a name='861'>
        if(islimsk(i) == 1) then<a name='862'>
           c0(i) = c0l<a name='863'>
           c1(i) = c1l<a name='864'>
        else<a name='865'>
           c0(i) = c0s<a name='866'>
           c1(i) = c1s<a name='867'>
        endif<a name='868'>
      enddo<a name='869'>
      do k = 1, km<a name='870'>
        do i = 1, im<a name='871'>
          if(t1(i,k).gt.273.16) then<a name='872'>
            c0t(i,k) = c0(i)<a name='873'>
          else<a name='874'>
            tem = d0 * (t1(i,k) - 273.16)<a name='875'>
            tem1 = exp(tem)<a name='876'>
            c0t(i,k) = c0(i) * tem1<a name='877'>
          endif<a name='878'>
        enddo<a name='879'>
      enddo<a name='880'>
<font color=#447700>!<a name='881'></font>
      do k = 1, km<a name='882'>
        do i = 1, im<a name='883'>
          cnvw(i,k) = 0.<a name='884'>
          cnvc(i,k) = 0.<a name='885'>
        enddo<a name='886'>
      enddo<a name='887'>
<font color=#447700>! hchuang code change<a name='888'></font>
      do k = 1, km<a name='889'>
        do i = 1, im<a name='890'>
          ud_mf(i,k) = 0.<a name='891'>
          dd_mf(i,k) = 0.<a name='892'>
          dt_mf(i,k) = 0.<a name='893'>
        enddo<a name='894'>
      enddo<a name='895'>
<font color=#447700>!c<a name='896'></font>
      do k = 1, 15<a name='897'>
        acrit(k) = acritt(k) * (975. - pcrit(k))<a name='898'>
      enddo<a name='899'>
      dt2 = delt<a name='900'>
      val   =         1200.<a name='901'>
      dtmin = max(dt2, val )<a name='902'>
      val   =         5400.<a name='903'>
      dtmax = max(dt2, val )<a name='904'>
<font color=#447700>!c  model tunable parameters are all here<a name='905'></font>
      edtmaxl = .3<a name='906'>
      edtmaxs = .3<a name='907'>
      clam    = .1<a name='908'>
      aafac   = .1<a name='909'>
<font color=#447700>!     betal   = .15<a name='910'></font>
<font color=#447700>!     betas   = .15<a name='911'></font>
      betal   = .05<a name='912'>
      betas   = .05<a name='913'>
<font color=#447700>!c     evef    = 0.07<a name='914'></font>
      evfact  = 0.3<a name='915'>
      evfactl = 0.3<a name='916'>
<font color=#447700>!<a name='917'></font>
      crtlamu = 1.0e-4<a name='918'>
      crtlamd = 1.0e-4<a name='919'>
<font color=#447700>!<a name='920'></font>
      <font color=#447700>!cxlamu  = 1.0e-4<a name='921'></font>
      cxlamu  = 1.0e-3   <font color=#447700>! 2015-12-15<a name='922'></font>
      cxlamd  = 1.0e-4<a name='923'>
      xlamde  = 1.0e-4<a name='924'>
      xlamdd  = 1.0e-4<a name='925'>
<font color=#447700>!<a name='926'></font>
<font color=#447700>!     pgcon   = 0.7     ! Gregory et al. (1997, QJRMS)<a name='927'></font>
      pgcon   = 0.55    <font color=#447700>! Zhang &amp; Wu (2003,JAS)<a name='928'></font>
      fjcap   = (float(jcap) / 126.) ** 2<a name='929'>
      val     =           1.<a name='930'>
      fjcap   = max(fjcap,val)<a name='931'>
      fkm     = (float(km) / 28.) ** 2<a name='932'>
      fkm     = max(fkm,val)<a name='933'>
      w1l     = -8.e-3 <a name='934'>
      w2l     = -4.e-2<a name='935'>
      w3l     = -5.e-3 <a name='936'>
      w4l     = -5.e-4<a name='937'>
      w1s     = -2.e-4<a name='938'>
      w2s     = -2.e-3<a name='939'>
      w3s     = -1.e-3<a name='940'>
      w4s     = -2.e-5<a name='941'>
<font color=#447700>!c<a name='942'></font>
<font color=#447700>!c  define top layer for search of the downdraft originating layer<a name='943'></font>
<font color=#447700>!c  and the maximum thetae for updraft<a name='944'></font>
<font color=#447700>!c<a name='945'></font>
      do i=1,im<a name='946'>
        kbmax(i) = km<a name='947'>
        kbm(i)   = km<a name='948'>
        kmax(i)  = km<a name='949'>
        tx1(i)   = 1.0 / ps(i)<a name='950'>
      enddo<a name='951'>
<font color=#447700>!     <a name='952'></font>
      do k = 1, km<a name='953'>
        do i=1,im<a name='954'>
          if (prsl(i,k)*tx1(i) .gt. 0.04) kmax(i)  = k + 1<a name='955'>
          if (prsl(i,k)*tx1(i) .gt. 0.45) kbmax(i) = k + 1<a name='956'>
          if (prsl(i,k)*tx1(i) .gt. 0.70) kbm(i)   = k + 1<a name='957'>
        enddo<a name='958'>
      enddo<a name='959'>
      do i=1,im<a name='960'>
        kmax(i)  = min(km,kmax(i))<a name='961'>
        kbmax(i) = min(kbmax(i),kmax(i))<a name='962'>
        kbm(i)   = min(kbm(i),kmax(i))<a name='963'>
      enddo<a name='964'>
<font color=#447700>!c<a name='965'></font>
<font color=#447700>!c  hydrostatic height assume zero terr and initially assume<a name='966'></font>
<font color=#447700>!c    updraft entrainment rate as an inverse function of height <a name='967'></font>
<font color=#447700>!c<a name='968'></font>
      do k = 1, km<a name='969'>
        do i=1,im<a name='970'>
          zo(i,k) = phil(i,k) / g<a name='971'>
        enddo<a name='972'>
      enddo<a name='973'>
      do k = 1, km1<a name='974'>
        do i=1,im<a name='975'>
          zi(i,k) = 0.5*(zo(i,k)+zo(i,k+1))<a name='976'>
          xlamue(i,k) = clam / zi(i,k)<a name='977'>
<font color=#447700>!          xlamue(i,k) = max(xlamue(i,k), crtlamu)<a name='978'></font>
        enddo<a name='979'>
      enddo<a name='980'>
<font color=#447700>!c<a name='981'></font>
<font color=#447700>!c!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='982'></font>
<font color=#447700>!c   convert surface pressure to mb from cb<a name='983'></font>
<font color=#447700>!c<a name='984'></font>
      do k = 1, km<a name='985'>
        do i = 1, im<a name='986'>
          if (k .le. kmax(i)) then<a name='987'>
            pfld(i,k) = prsl(i,k) * 10.0<a name='988'>
            eta(i,k)  = 1.<a name='989'>
            fent1(i,k)= 1.<a name='990'>
            fent2(i,k)= 1.<a name='991'>
            frh(i,k)  = 0.<a name='992'>
            hcko(i,k) = 0.<a name='993'>
            qcko(i,k) = 0.<a name='994'>
            qrcko(i,k)= 0.<a name='995'>
            ucko(i,k) = 0.<a name='996'>
            vcko(i,k) = 0.<a name='997'>
            etad(i,k) = 1.<a name='998'>
            hcdo(i,k) = 0.<a name='999'>
            qcdo(i,k) = 0.<a name='1000'>
            ucdo(i,k) = 0.<a name='1001'>
            vcdo(i,k) = 0.<a name='1002'>
            qrcd(i,k) = 0.<a name='1003'>
            qrcdo(i,k)= 0.<a name='1004'>
            dbyo(i,k) = 0.<a name='1005'>
            pwo(i,k)  = 0.<a name='1006'>
            pwdo(i,k) = 0.<a name='1007'>
            dellal(i,k) = 0.<a name='1008'>
            to(i,k)   = t1(i,k)<a name='1009'>
            qo(i,k)   = q1(i,k)<a name='1010'>
            uo(i,k)   = u1(i,k)<a name='1011'>
            vo(i,k)   = v1(i,k)<a name='1012'>
<font color=#447700>!           uo(i,k)   = u1(i,k) * rcs(i)<a name='1013'></font>
<font color=#447700>!           vo(i,k)   = v1(i,k) * rcs(i)<a name='1014'></font>
            wu2(i,k)  = 0.<a name='1015'>
            buo(i,k)  = 0.<a name='1016'>
            drag(i,k) = 0.<a name='1017'>
            cnvwt(i,k)= 0.<a name='1018'>
          endif<a name='1019'>
        enddo<a name='1020'>
      enddo<a name='1021'>
<font color=#447700>!c<a name='1022'></font>
<font color=#447700>!c  column variables<a name='1023'></font>
<font color=#447700>!c  p is pressure of the layer (mb)<a name='1024'></font>
<font color=#447700>!c  t is temperature at t-dt (k)..tn<a name='1025'></font>
<font color=#447700>!c  q is mixing ratio at t-dt (kg/kg)..qn<a name='1026'></font>
<font color=#447700>!c  to is temperature at t+dt (k)... this is after advection and turbulan<a name='1027'></font>
<font color=#447700>!c  qo is mixing ratio at t+dt (kg/kg)..q1<a name='1028'></font>
<font color=#447700>!c<a name='1029'></font>
      do k = 1, km<a name='1030'>
        do i=1,im<a name='1031'>
          if (k .le. kmax(i)) then<a name='1032'>
            qeso(i,k) = 0.01 * fpvs(to(i,k))      <font color=#447700>! fpvs is in pa<a name='1033'></font>
            qeso(i,k) = eps * qeso(i,k) / (pfld(i,k) + epsm1*qeso(i,k))<a name='1034'>
            val1      =             1.e-8<a name='1035'>
            qeso(i,k) = max(qeso(i,k), val1)<a name='1036'>
            val2      =           1.e-10<a name='1037'>
            qo(i,k)   = max(qo(i,k), val2 )<a name='1038'>
<font color=#447700>!           qo(i,k)   = min(qo(i,k),qeso(i,k))<a name='1039'></font>
<font color=#447700>!           tvo(i,k)  = to(i,k) + delta * to(i,k) * qo(i,k)<a name='1040'></font>
          endif<a name='1041'>
        enddo<a name='1042'>
      enddo<a name='1043'>
<font color=#447700>!c<a name='1044'></font>
<font color=#447700>!c  compute moist static energy<a name='1045'></font>
<font color=#447700>!c<a name='1046'></font>
      do k = 1, km<a name='1047'>
        do i=1,im<a name='1048'>
          if (k .le. kmax(i)) then<a name='1049'>
<font color=#447700>!           tem       = g * zo(i,k) + cp * to(i,k)<a name='1050'></font>
            tem       = phil(i,k) + cp * to(i,k)<a name='1051'>
            heo(i,k)  = tem  + hvap * qo(i,k)<a name='1052'>
            heso(i,k) = tem  + hvap * qeso(i,k)<a name='1053'>
<font color=#447700>!c           heo(i,k)  = min(heo(i,k),heso(i,k))<a name='1054'></font>
          endif<a name='1055'>
        enddo<a name='1056'>
      enddo<a name='1057'>
<font color=#447700>!c<a name='1058'></font>
<font color=#447700>!c  determine level with largest moist static energy<a name='1059'></font>
<font color=#447700>!c  this is the level where updraft starts<a name='1060'></font>
<font color=#447700>!c<a name='1061'></font>
      do i=1,im<a name='1062'>
        hmax(i) = heo(i,1)<a name='1063'>
        kb(i)   = 1<a name='1064'>
      enddo<a name='1065'>
      do k = 2, km<a name='1066'>
        do i=1,im<a name='1067'>
          if (k .le. kbm(i)) then<a name='1068'>
            if(heo(i,k).gt.hmax(i)) then<a name='1069'>
              kb(i)   = k<a name='1070'>
              hmax(i) = heo(i,k)<a name='1071'>
            endif<a name='1072'>
          endif<a name='1073'>
        enddo<a name='1074'>
      enddo<a name='1075'>
<font color=#447700>!c<a name='1076'></font>
      do k = 1, km1<a name='1077'>
        do i=1,im<a name='1078'>
          if (k .le. kmax(i)-1) then<a name='1079'>
            dz      = .5 * (zo(i,k+1) - zo(i,k))<a name='1080'>
            dp      = .5 * (pfld(i,k+1) - pfld(i,k))<a name='1081'>
            es      = 0.01 * fpvs(to(i,k+1))      <font color=#447700>! fpvs is in pa<a name='1082'></font>
            pprime  = pfld(i,k+1) + epsm1 * es<a name='1083'>
            qs      = eps * es / pprime<a name='1084'>
            dqsdp   = - qs / pprime<a name='1085'>
            desdt   = es * (fact1 / to(i,k+1) + fact2 / (to(i,k+1)**2))<a name='1086'>
            dqsdt   = qs * pfld(i,k+1) * desdt / (es * pprime)<a name='1087'>
            gamma   = el2orc * qeso(i,k+1) / (to(i,k+1)**2)<a name='1088'>
            dt      = (g * dz + hvap * dqsdp * dp) / (cp * (1. + gamma))<a name='1089'>
            dq      = dqsdt * dt + dqsdp * dp<a name='1090'>
            to(i,k) = to(i,k+1) + dt<a name='1091'>
            qo(i,k) = qo(i,k+1) + dq<a name='1092'>
            po(i,k) = .5 * (pfld(i,k) + pfld(i,k+1))<a name='1093'>
          endif<a name='1094'>
        enddo<a name='1095'>
      enddo<a name='1096'>
<font color=#447700>!<a name='1097'></font>
      do k = 1, km1<a name='1098'>
        do i=1,im<a name='1099'>
          if (k .le. kmax(i)-1) then<a name='1100'>
            qeso(i,k) = 0.01 * fpvs(to(i,k))      <font color=#447700>! fpvs is in pa<a name='1101'></font>
            qeso(i,k) = eps * qeso(i,k) / (po(i,k) + epsm1*qeso(i,k))<a name='1102'>
            val1      =             1.e-8<a name='1103'>
            qeso(i,k) = max(qeso(i,k), val1)<a name='1104'>
            val2      =           1.e-10<a name='1105'>
            qo(i,k)   = max(qo(i,k), val2 )<a name='1106'>
<font color=#447700>!           qo(i,k)   = min(qo(i,k),qeso(i,k))<a name='1107'></font>
            frh(i,k)  = 1. - min(qo(i,k)/qeso(i,k), 1._kind_phys)        <a name='1108'>
            heo(i,k)  = .5 * g * (zo(i,k) + zo(i,k+1)) +    &amp;<a name='1109'>
     &amp;                  cp * to(i,k) + hvap * qo(i,k)<a name='1110'>
            heso(i,k) = .5 * g * (zo(i,k) + zo(i,k+1)) +    &amp;<a name='1111'>
     &amp;                  cp * to(i,k) + hvap * qeso(i,k)<a name='1112'>
            uo(i,k)   = .5 * (uo(i,k) + uo(i,k+1))<a name='1113'>
            vo(i,k)   = .5 * (vo(i,k) + vo(i,k+1))<a name='1114'>
          endif<a name='1115'>
        enddo<a name='1116'>
      enddo<a name='1117'>
<font color=#447700>!c<a name='1118'></font>
<font color=#447700>!c  look for the level of free convection as cloud base<a name='1119'></font>
<font color=#447700>!c<a name='1120'></font>
      do i=1,im<a name='1121'>
        flg(i)   = .true.<a name='1122'>
        kbcon(i) = kmax(i)<a name='1123'>
      enddo<a name='1124'>
      do k = 1, km1<a name='1125'>
        do i=1,im<a name='1126'>
          if (flg(i).and.k.le.kbmax(i)) then<a name='1127'>
            if(k.gt.kb(i).and.heo(i,kb(i)).gt.heso(i,k)) then<a name='1128'>
              kbcon(i) = k<a name='1129'>
              flg(i)   = .false.<a name='1130'>
            endif<a name='1131'>
          endif<a name='1132'>
        enddo<a name='1133'>
      enddo<a name='1134'>
<font color=#447700>!c<a name='1135'></font>
      do i=1,im<a name='1136'>
        if(kbcon(i).eq.kmax(i)) cnvflg(i) = .false.<a name='1137'>
      enddo<a name='1138'>
<font color=#447700>!!<a name='1139'></font>
      totflg = .true.<a name='1140'>
      do i=1,im<a name='1141'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='1142'>
      enddo<a name='1143'>
      if(totflg) return<a name='1144'>
<font color=#447700>!!<a name='1145'></font>
      do i=1,im<a name='1146'>
        if(cnvflg(i)) then<a name='1147'>
<font color=#447700>!         pdot(i)  = 10.* dot(i,kbcon(i))<a name='1148'></font>
          pdot(i)  = 0.01 * dot(i,kbcon(i)) <font color=#447700>! Now dot is in Pa/s<a name='1149'></font>
        endif<a name='1150'>
      enddo<a name='1151'>
<font color=#447700>!c<a name='1152'></font>
<font color=#447700>!c   turn off convection if pressure depth between parcel source level<a name='1153'></font>
<font color=#447700>!c      and cloud base is larger than a critical value, cinpcr<a name='1154'></font>
<font color=#447700>!c<a name='1155'></font>
      do i=1,im<a name='1156'>
        if(cnvflg(i)) then<a name='1157'>
          if(islimsk(i) == 1) then<a name='1158'>
            w1 = w1l<a name='1159'>
            w2 = w2l<a name='1160'>
            w3 = w3l<a name='1161'>
            w4 = w4l<a name='1162'>
          else<a name='1163'>
            w1 = w1s<a name='1164'>
            w2 = w2s<a name='1165'>
            w3 = w3s<a name='1166'>
            w4 = w4s<a name='1167'>
          endif<a name='1168'>
          if(pdot(i).le.w4) then<a name='1169'>
            tem = (pdot(i) - w4) / (w3 - w4)<a name='1170'>
          elseif(pdot(i).ge.-w4) then<a name='1171'>
            tem = - (pdot(i) + w4) / (w4 - w3)<a name='1172'>
          else<a name='1173'>
            tem = 0.<a name='1174'>
          endif<a name='1175'>
          val1    =            -1.<a name='1176'>
          tem = max(tem,val1)<a name='1177'>
          val2    =             1.<a name='1178'>
          tem = min(tem,val2)<a name='1179'>
          ptem = 1. - tem<a name='1180'>
          ptem1= .5*(cinpcrmx-cinpcrmn)<a name='1181'>
          cinpcr = cinpcrmx - ptem * ptem1<a name='1182'>
          tem1 = pfld(i,kb(i)) - pfld(i,kbcon(i))<a name='1183'>
          if(tem1.gt.cinpcr) then<a name='1184'>
             cnvflg(i) = .false.<a name='1185'>
          endif<a name='1186'>
        endif<a name='1187'>
      enddo<a name='1188'>
<font color=#447700>!!<a name='1189'></font>
      totflg = .true.<a name='1190'>
      do i=1,im<a name='1191'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='1192'>
      enddo<a name='1193'>
      if(totflg) return<a name='1194'>
<font color=#447700>!!<a name='1195'></font>
<font color=#447700>!c<a name='1196'></font>
<font color=#447700>!c  assume that updraft entrainment rate above cloud base is<a name='1197'></font>
<font color=#447700>!c    same as that at cloud base<a name='1198'></font>
<font color=#447700>!c<a name='1199'></font>
<font color=#447700>!     do k = 2, km1<a name='1200'></font>
<font color=#447700>!       do i=1,im<a name='1201'></font>
<font color=#447700>!         if(cnvflg(i).and.<a name='1202'></font>
<font color=#447700>!    &amp;      (k.gt.kbcon(i).and.k.lt.kmax(i))) then<a name='1203'></font>
<font color=#447700>!             xlamue(i,k) = xlamue(i,kbcon(i))<a name='1204'></font>
<font color=#447700>!         endif<a name='1205'></font>
<font color=#447700>!       enddo<a name='1206'></font>
<font color=#447700>!     enddo<a name='1207'></font>
<a name='1208'>
       do i=1,im<a name='1209'>
         if(cnvflg(i)) then<a name='1210'>
           xlamx(i) = xlamue(i,kbcon(i))<a name='1211'>
         endif<a name='1212'>
       enddo<a name='1213'>
       do k = 2, km1<a name='1214'>
         do i=1,im<a name='1215'>
           if(cnvflg(i).and.    &amp;<a name='1216'>
     &amp;      (k.gt.kbcon(i).and.k.lt.kmax(i))) then<a name='1217'>
               xlamue(i,k) = xlamx(i)<a name='1218'>
           endif<a name='1219'>
         enddo<a name='1220'>
       enddo<a name='1221'>
<a name='1222'>
<a name='1223'>
<font color=#447700>!c<a name='1224'></font>
<font color=#447700>!c  specify a background (turbulent) detrainment rate for the updrafts<a name='1225'></font>
<font color=#447700>!c<a name='1226'></font>
      do k = 1, km1<a name='1227'>
        do i=1,im<a name='1228'>
          if(cnvflg(i).and.k.lt.kmax(i)) then<a name='1229'>
<font color=#447700>!           xlamud(i,k) = xlamue(i,kbcon(i))<a name='1230'></font>
<font color=#447700>!            xlamud(i,k) = crtlamd<a name='1231'></font>
            xlamud(i,k) = xlamx(i)<a name='1232'>
          endif<a name='1233'>
        enddo<a name='1234'>
      enddo<a name='1235'>
<font color=#447700>!c<a name='1236'></font>
<font color=#447700>!c  functions rapidly decreasing with height, mimicking a cloud ensemble<a name='1237'></font>
<font color=#447700>!c    (Bechtold et al., 2008)<a name='1238'></font>
<font color=#447700>!c<a name='1239'></font>
      do k = 2, km1<a name='1240'>
        do i=1,im<a name='1241'>
          if(cnvflg(i).and.                                              &amp;<a name='1242'>
     &amp;      (k.gt.kbcon(i).and.k.lt.kmax(i))) then<a name='1243'>
              tem = qeso(i,k)/qeso(i,kbcon(i))<a name='1244'>
              fent1(i,k) = tem**2<a name='1245'>
              fent2(i,k) = tem**3<a name='1246'>
          endif<a name='1247'>
        enddo<a name='1248'>
      enddo<a name='1249'>
<font color=#447700>!c<a name='1250'></font>
<font color=#447700>!c  final entrainment and detrainment rates as the sum of turbulent part and<a name='1251'></font>
<font color=#447700>!c    organized entrainment depending on the environmental relative humidity<a name='1252'></font>
<font color=#447700>!c    (Bechtold et al., 2008)<a name='1253'></font>
<font color=#447700>!c<a name='1254'></font>
      do k = 2, km1<a name='1255'>
        do i=1,im<a name='1256'>
          if(cnvflg(i).and.                                             &amp;<a name='1257'>
     &amp;      (k.gt.kbcon(i).and.k.lt.kmax(i))) then<a name='1258'>
              tem = cxlamu * frh(i,k) * fent2(i,k)<a name='1259'>
              xlamue(i,k) = xlamue(i,k)*fent1(i,k) + tem<a name='1260'>
<font color=#447700>!             tem1 = cxlamd * frh(i,k)<a name='1261'></font>
<font color=#447700>!             xlamud(i,k) = xlamud(i,k) + tem1<a name='1262'></font>
          endif<a name='1263'>
        enddo<a name='1264'>
      enddo<a name='1265'>
<font color=#447700>!<a name='1266'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1267'></font>
<font color=#447700>!c<a name='1268'></font>
<font color=#447700>!c  determine updraft mass flux for the subcloud layers<a name='1269'></font>
<font color=#447700>!c<a name='1270'></font>
      do k = km1, 1, -1<a name='1271'>
        do i = 1, im<a name='1272'>
          if (cnvflg(i)) then<a name='1273'>
            if(k.lt.kbcon(i).and.k.ge.kb(i)) then<a name='1274'>
              dz       = zi(i,k+1) - zi(i,k)<a name='1275'>
              tem      = 0.5*(xlamud(i,k)+xlamud(i,k+1))<a name='1276'>
              ptem     = 0.5*(xlamue(i,k)+xlamue(i,k+1))-tem<a name='1277'>
              eta(i,k) = eta(i,k+1) / (1. + ptem * dz)<a name='1278'>
            endif<a name='1279'>
          endif<a name='1280'>
        enddo<a name='1281'>
      enddo<a name='1282'>
<font color=#447700>!c<a name='1283'></font>
<font color=#447700>!c  compute mass flux above cloud base<a name='1284'></font>
<font color=#447700>!c<a name='1285'></font>
      do i = 1, im<a name='1286'>
        flg(i) = cnvflg(i)<a name='1287'>
      enddo<a name='1288'>
      do k = 2, km1<a name='1289'>
        do i = 1, im<a name='1290'>
         if(flg(i))then<a name='1291'>
           if(k.gt.kbcon(i).and.k.lt.kmax(i)) then<a name='1292'>
              dz       = zi(i,k) - zi(i,k-1)<a name='1293'>
              tem      = 0.5*(xlamud(i,k)+xlamud(i,k-1))<a name='1294'>
              ptem     = 0.5*(xlamue(i,k)+xlamue(i,k-1))-tem<a name='1295'>
              eta(i,k) = eta(i,k-1) * (1 + ptem * dz)<a name='1296'>
              if(eta(i,k).le.0.) then<a name='1297'>
                kmax(i) = k<a name='1298'>
                ktconn(i) = k<a name='1299'>
                flg(i)   = .false.<a name='1300'>
              endif<a name='1301'>
           endif<a name='1302'>
         endif<a name='1303'>
        enddo<a name='1304'>
      enddo<a name='1305'>
<font color=#447700>!c<a name='1306'></font>
<font color=#447700>!c  compute updraft cloud properties<a name='1307'></font>
<font color=#447700>!c<a name='1308'></font>
      do i = 1, im<a name='1309'>
        if(cnvflg(i)) then<a name='1310'>
          indx         = kb(i)<a name='1311'>
          hcko(i,indx) = heo(i,indx)<a name='1312'>
          ucko(i,indx) = uo(i,indx)<a name='1313'>
          vcko(i,indx) = vo(i,indx)<a name='1314'>
          pwavo(i)     = 0.<a name='1315'>
        endif<a name='1316'>
      enddo<a name='1317'>
<font color=#447700>!c<a name='1318'></font>
<font color=#447700>!c  cloud property is modified by the entrainment process<a name='1319'></font>
<font color=#447700>!c<a name='1320'></font>
<font color=#447700>!  cm is an enhancement factor in entrainment rates for momentum<a name='1321'></font>
<font color=#447700>!<a name='1322'></font>
      do k = 2, km1<a name='1323'>
        do i = 1, im<a name='1324'>
          if (cnvflg(i)) then<a name='1325'>
            if(k.gt.kb(i).and.k.lt.kmax(i)) then<a name='1326'>
              dz   = zi(i,k) - zi(i,k-1)<a name='1327'>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='1328'>
              tem1 = 0.25 * (xlamud(i,k)+xlamud(i,k-1)) * dz<a name='1329'>
              factor = 1. + tem - tem1<a name='1330'>
              hcko(i,k) = ((1.-tem1)*hcko(i,k-1)+tem*0.5*             &amp;<a name='1331'>
     &amp;                     (heo(i,k)+heo(i,k-1)))/factor<a name='1332'>
              dbyo(i,k) = hcko(i,k) - heso(i,k)<a name='1333'>
<font color=#447700>!<a name='1334'></font>
              tem  = 0.5 * cm * tem<a name='1335'>
              factor = 1. + tem<a name='1336'>
              ptem = tem + pgcon<a name='1337'>
              ptem1= tem - pgcon<a name='1338'>
              ucko(i,k) = ((1.-tem)*ucko(i,k-1)+ptem*uo(i,k)           &amp;<a name='1339'>
     &amp;                     +ptem1*uo(i,k-1))/factor<a name='1340'>
              vcko(i,k) = ((1.-tem)*vcko(i,k-1)+ptem*vo(i,k)           &amp;<a name='1341'>
     &amp;                     +ptem1*vo(i,k-1))/factor<a name='1342'>
            endif<a name='1343'>
          endif<a name='1344'>
        enddo<a name='1345'>
      enddo<a name='1346'>
<font color=#447700>!c<a name='1347'></font>
<font color=#447700>!c   taking account into convection inhibition due to existence of<a name='1348'></font>
<font color=#447700>!c    dry layers below cloud base<a name='1349'></font>
<font color=#447700>!c<a name='1350'></font>
      do i=1,im<a name='1351'>
        flg(i) = cnvflg(i)<a name='1352'>
        kbcon1(i) = kmax(i)<a name='1353'>
      enddo<a name='1354'>
      do k = 2, km1<a name='1355'>
      do i=1,im<a name='1356'>
        if (flg(i).and.k.lt.kmax(i)) then<a name='1357'>
          if(k.ge.kbcon(i).and.dbyo(i,k).gt.0.) then<a name='1358'>
            kbcon1(i) = k<a name='1359'>
            flg(i)    = .false.<a name='1360'>
          endif<a name='1361'>
        endif<a name='1362'>
      enddo<a name='1363'>
      enddo<a name='1364'>
      do i=1,im<a name='1365'>
        if(cnvflg(i)) then<a name='1366'>
          if(kbcon1(i).eq.kmax(i)) cnvflg(i) = .false.<a name='1367'>
        endif<a name='1368'>
      enddo<a name='1369'>
      do i=1,im<a name='1370'>
        if(cnvflg(i)) then<a name='1371'>
          tem = pfld(i,kbcon(i)) - pfld(i,kbcon1(i))<a name='1372'>
          if(tem.gt.dthk) then<a name='1373'>
             cnvflg(i) = .false.<a name='1374'>
          endif<a name='1375'>
        endif<a name='1376'>
      enddo<a name='1377'>
<font color=#447700>!!<a name='1378'></font>
      totflg = .true.<a name='1379'>
      do i = 1, im<a name='1380'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='1381'>
      enddo<a name='1382'>
      if(totflg) return<a name='1383'>
<font color=#447700>!!<a name='1384'></font>
<font color=#447700>!c<a name='1385'></font>
<font color=#447700>!c  calculate convective inhibition<a name='1386'></font>
<font color=#447700>!c<a name='1387'></font>
      do k = 2, km1<a name='1388'>
        do i = 1, im<a name='1389'>
          if (cnvflg(i)) then<a name='1390'>
            if(k.gt.kb(i).and.k.lt.kbcon1(i)) then<a name='1391'>
              dz1 = zo(i,k+1) - zo(i,k)<a name='1392'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='1393'>
              rfact =  1. + delta * cp * gamma                         &amp;<a name='1394'>
     &amp;                 * to(i,k) / hvap<a name='1395'>
              cina(i) = cina(i) +                                      &amp;<a name='1396'>
<font color=#447700>!    &amp;                 dz1 * eta(i,k) * (g / (cp * to(i,k)))<a name='1397'></font>
     &amp;                 dz1 * (g / (cp * to(i,k)))                      &amp;<a name='1398'>
     &amp;                 * dbyo(i,k) / (1. + gamma)                      &amp;<a name='1399'>
     &amp;                 * rfact<a name='1400'>
              val = 0.<a name='1401'>
              cina(i) = cina(i) +                                      &amp;<a name='1402'>
<font color=#447700>!    &amp;                 dz1 * eta(i,k) * g * delta *<a name='1403'></font>
     &amp;                 dz1 * g * delta *                               &amp;<a name='1404'>
     &amp;                 max(val,(qeso(i,k) - qo(i,k)))<a name='1405'>
            endif<a name='1406'>
          endif<a name='1407'>
        enddo<a name='1408'>
      enddo<a name='1409'>
      do i = 1, im<a name='1410'>
        if(cnvflg(i)) then<a name='1411'>
<font color=#447700>!<a name='1412'></font>
<font color=#447700>!         if(islimsk(i) == 1) then<a name='1413'></font>
<font color=#447700>!           w1 = w1l<a name='1414'></font>
<font color=#447700>!           w2 = w2l<a name='1415'></font>
<font color=#447700>!           w3 = w3l<a name='1416'></font>
<font color=#447700>!           w4 = w4l<a name='1417'></font>
<font color=#447700>!         else<a name='1418'></font>
<font color=#447700>!           w1 = w1s<a name='1419'></font>
<font color=#447700>!           w2 = w2s<a name='1420'></font>
<font color=#447700>!           w3 = w3s<a name='1421'></font>
<font color=#447700>!           w4 = w4s<a name='1422'></font>
<font color=#447700>!         endif<a name='1423'></font>
<font color=#447700>!         if(pdot(i).le.w4) then<a name='1424'></font>
<font color=#447700>!           tem = (pdot(i) - w4) / (w3 - w4)<a name='1425'></font>
<font color=#447700>!         elseif(pdot(i).ge.-w4) then<a name='1426'></font>
<font color=#447700>!           tem = - (pdot(i) + w4) / (w4 - w3)<a name='1427'></font>
<font color=#447700>!         else<a name='1428'></font>
<font color=#447700>!           tem = 0.<a name='1429'></font>
<font color=#447700>!         endif<a name='1430'></font>
<font color=#447700>!<a name='1431'></font>
<font color=#447700>!         val1    =            -1.<a name='1432'></font>
<font color=#447700>!         tem = max(tem,val1)<a name='1433'></font>
<font color=#447700>!         val2    =             1.<a name='1434'></font>
<font color=#447700>!         tem = min(tem,val2)<a name='1435'></font>
<font color=#447700>!         tem = 1. - tem<a name='1436'></font>
<font color=#447700>!         tem1= .5*(cinacrmx-cinacrmn)<a name='1437'></font>
<font color=#447700>!         cinacr = cinacrmx - tem * tem1<a name='1438'></font>
<font color=#447700>!<a name='1439'></font>
          cinacr = cinacrmx<a name='1440'>
          if(cina(i).lt.cinacr) cnvflg(i) = .false.<a name='1441'>
        endif<a name='1442'>
      enddo<a name='1443'>
<font color=#447700>!!<a name='1444'></font>
      totflg = .true.<a name='1445'>
      do i=1,im<a name='1446'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='1447'>
      enddo<a name='1448'>
      if(totflg) return<a name='1449'>
<font color=#447700>!!<a name='1450'></font>
<font color=#447700>!c<a name='1451'></font>
<font color=#447700>!c  determine first guess cloud top as the level of zero buoyancy<a name='1452'></font>
<font color=#447700>!c<a name='1453'></font>
      do i = 1, im<a name='1454'>
        flg(i) = cnvflg(i)<a name='1455'>
        ktcon(i) = 1<a name='1456'>
      enddo<a name='1457'>
      do k = 2, km1<a name='1458'>
      do i = 1, im<a name='1459'>
        if (flg(i).and.k .lt. kmax(i)) then<a name='1460'>
          if(k.gt.kbcon1(i).and.dbyo(i,k).lt.0.) then<a name='1461'>
             ktcon(i) = k<a name='1462'>
             flg(i)   = .false.<a name='1463'>
          endif<a name='1464'>
        endif<a name='1465'>
      enddo<a name='1466'>
      enddo<a name='1467'>
<font color=#447700>!c<a name='1468'></font>
      do i = 1, im<a name='1469'>
        if(cnvflg(i)) then<a name='1470'>
          if(ktcon(i).eq.1 .and. ktconn(i).gt.1) then<a name='1471'>
             ktcon(i) = ktconn(i)<a name='1472'>
          endif<a name='1473'>
          tem = pfld(i,kbcon(i))-pfld(i,ktcon(i))<a name='1474'>
          if(tem.lt.cthk) cnvflg(i) = .false.<a name='1475'>
        endif<a name='1476'>
      enddo<a name='1477'>
<font color=#447700>!!<a name='1478'></font>
      totflg = .true.<a name='1479'>
      do i = 1, im<a name='1480'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='1481'>
      enddo<a name='1482'>
      if(totflg) return<a name='1483'>
<font color=#447700>!!<a name='1484'></font>
<font color=#447700>!c<a name='1485'></font>
<font color=#447700>!c  search for downdraft originating level above theta-e minimum<a name='1486'></font>
<font color=#447700>!c<a name='1487'></font>
      do i = 1, im<a name='1488'>
        if(cnvflg(i)) then<a name='1489'>
           hmin(i) = heo(i,kbcon1(i))<a name='1490'>
           lmin(i) = kbmax(i)<a name='1491'>
           jmin(i) = kbmax(i)<a name='1492'>
        endif<a name='1493'>
      enddo<a name='1494'>
      do k = 2, km1<a name='1495'>
        do i = 1, im<a name='1496'>
          if (cnvflg(i) .and. k .le. kbmax(i)) then<a name='1497'>
            if(k.gt.kbcon1(i).and.heo(i,k).lt.hmin(i)) then<a name='1498'>
               lmin(i) = k + 1<a name='1499'>
               hmin(i) = heo(i,k)<a name='1500'>
            endif<a name='1501'>
          endif<a name='1502'>
        enddo<a name='1503'>
      enddo<a name='1504'>
<font color=#447700>!c<a name='1505'></font>
<font color=#447700>!c  make sure that jmin(i) is within the cloud<a name='1506'></font>
<font color=#447700>!c<a name='1507'></font>
      do i = 1, im<a name='1508'>
        if(cnvflg(i)) then<a name='1509'>
          jmin(i) = min(lmin(i),ktcon(i)-1)<a name='1510'>
          jmin(i) = max(jmin(i),kbcon1(i)+1)<a name='1511'>
          if(jmin(i).ge.ktcon(i)) cnvflg(i) = .false.<a name='1512'>
        endif<a name='1513'>
      enddo<a name='1514'>
<font color=#447700>!c<a name='1515'></font>
<font color=#447700>!c  specify upper limit of mass flux at cloud base<a name='1516'></font>
<font color=#447700>!c<a name='1517'></font>
      do i = 1, im<a name='1518'>
        if(cnvflg(i)) then<a name='1519'>
<font color=#447700>!         xmbmax(i) = .1<a name='1520'></font>
<font color=#447700>!<a name='1521'></font>
          k = kbcon(i)<a name='1522'>
          dp = 1000. * del(i,k)<a name='1523'>
          xmbmax(i) = dp / (g * dt2)<a name='1524'>
          mbdt(i) = 0.1 * dp / g<a name='1525'>
<font color=#447700>!<a name='1526'></font>
<font color=#447700>!         tem = dp / (g * dt2)<a name='1527'></font>
<font color=#447700>!         xmbmax(i) = min(tem, xmbmax(i))<a name='1528'></font>
        endif<a name='1529'>
      enddo<a name='1530'>
<font color=#447700>!c<a name='1531'></font>
<font color=#447700>!c  compute cloud moisture property and precipitation<a name='1532'></font>
<font color=#447700>!c<a name='1533'></font>
      do i = 1, im<a name='1534'>
        if (cnvflg(i)) then<a name='1535'>
<font color=#447700>!         aa1(i) = 0.<a name='1536'></font>
          qcko(i,kb(i)) = qo(i,kb(i))<a name='1537'>
          qrcko(i,kb(i)) = qo(i,kb(i))<a name='1538'>
<font color=#447700>!         rhbar(i) = 0.<a name='1539'></font>
        endif<a name='1540'>
      enddo<a name='1541'>
      do k = 2, km1<a name='1542'>
        do i = 1, im<a name='1543'>
          if (cnvflg(i)) then<a name='1544'>
            if(k.gt.kb(i).and.k.lt.ktcon(i)) then<a name='1545'>
              dz    = zi(i,k) - zi(i,k-1)<a name='1546'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='1547'>
              qrch = qeso(i,k)                                              &amp;<a name='1548'>
     &amp;             + gamma * dbyo(i,k) / (hvap * (1. + gamma))<a name='1549'>
<font color=#447700>!cj<a name='1550'></font>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='1551'>
              tem1 = 0.25 * (xlamud(i,k)+xlamud(i,k-1)) * dz<a name='1552'>
              factor = 1. + tem - tem1<a name='1553'>
              qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*                   &amp;<a name='1554'>
     &amp;                     (qo(i,k)+qo(i,k-1)))/factor<a name='1555'>
              qrcko(i,k) = qcko(i,k)<a name='1556'>
<font color=#447700>!cj<a name='1557'></font>
              dq = eta(i,k) * (qcko(i,k) - qrch)<a name='1558'>
<font color=#447700>!c<a name='1559'></font>
<font color=#447700>!             rhbar(i) = rhbar(i) + qo(i,k) / qeso(i,k)<a name='1560'></font>
<font color=#447700>!c<a name='1561'></font>
<font color=#447700>!c  check if there is excess moisture to release latent heat<a name='1562'></font>
<font color=#447700>!c<a name='1563'></font>
              if(k.ge.kbcon(i).and.dq.gt.0.) then<a name='1564'>
                etah = .5 * (eta(i,k) + eta(i,k-1))<a name='1565'>
                if(ncloud.gt.0.and.k.gt.jmin(i)) then<a name='1566'>
                  dp = 1000. * del(i,k)<a name='1567'>
                  ptem = c0t(i,k) + c1(i)<a name='1568'>
                  qlk = dq / (eta(i,k) + etah * ptem * dz)<a name='1569'>
                  dellal(i,k) = etah * c1(i) * dz * qlk * g / dp<a name='1570'>
                else<a name='1571'>
                  qlk = dq / (eta(i,k) + etah * c0t(i,k) * dz)<a name='1572'>
                endif<a name='1573'>
<font color=#447700>!               aa1(i) = aa1(i) - dz * g * qlk * etah<a name='1574'></font>
<font color=#447700>!               aa1(i) = aa1(i) - dz * g * qlk<a name='1575'></font>
                buo(i,k) = buo(i,k) - g * qlk<a name='1576'>
                qcko(i,k) = qlk + qrch<a name='1577'>
                pwo(i,k) = etah * c0t(i,k) * dz * qlk<a name='1578'>
                pwavo(i) = pwavo(i) + pwo(i,k)<a name='1579'>
<font color=#447700>!               cnvwt(i,k) = (etah*qlk + pwo(i,k)) * g / dp<a name='1580'></font>
                cnvwt(i,k) = etah * qlk * g / dp<a name='1581'>
              endif<a name='1582'>
<font color=#447700>!<a name='1583'></font>
<font color=#447700>!  compute buoyancy and drag for updraft velocity<a name='1584'></font>
<font color=#447700>!<a name='1585'></font>
              if(k.ge.kbcon(i)) then<a name='1586'>
                rfact =  1. + delta * cp * gamma                       &amp;<a name='1587'>
     &amp;                   * to(i,k) / hvap<a name='1588'>
                buo(i,k) = buo(i,k) + (g / (cp * to(i,k)))             &amp;<a name='1589'>
     &amp;                   * dbyo(i,k) / (1. + gamma)                    &amp;<a name='1590'>
     &amp;                   * rfact<a name='1591'>
                val = 0.<a name='1592'>
                buo(i,k) = buo(i,k) + g * delta *                      &amp;<a name='1593'>
     &amp;                     max(val,(qeso(i,k) - qo(i,k)))<a name='1594'>
                drag(i,k) = max(xlamue(i,k),xlamud(i,k))<a name='1595'>
              endif<a name='1596'>
<font color=#447700>!<a name='1597'></font>
            endif<a name='1598'>
          endif<a name='1599'>
        enddo<a name='1600'>
      enddo<a name='1601'>
<font color=#447700>!c<a name='1602'></font>
<font color=#447700>!     do i = 1, im<a name='1603'></font>
<font color=#447700>!       if(cnvflg(i)) then<a name='1604'></font>
<font color=#447700>!         indx = ktcon(i) - kb(i) - 1<a name='1605'></font>
<font color=#447700>!         rhbar(i) = rhbar(i) / float(indx)<a name='1606'></font>
<font color=#447700>!       endif<a name='1607'></font>
<font color=#447700>!     enddo<a name='1608'></font>
<font color=#447700>!c<a name='1609'></font>
<font color=#447700>!c  calculate cloud work function<a name='1610'></font>
<font color=#447700>!c<a name='1611'></font>
<font color=#447700>!     do k = 2, km1<a name='1612'></font>
<font color=#447700>!       do i = 1, im<a name='1613'></font>
<font color=#447700>!         if (cnvflg(i)) then<a name='1614'></font>
<font color=#447700>!           if(k.ge.kbcon(i).and.k.lt.ktcon(i)) then<a name='1615'></font>
<font color=#447700>!             dz1 = zo(i,k+1) - zo(i,k)<a name='1616'></font>
<font color=#447700>!             gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='1617'></font>
<font color=#447700>!             rfact =  1. + delta * cp * gamma<a name='1618'></font>
<font color=#447700>!    &amp;                 * to(i,k) / hvap<a name='1619'></font>
<font color=#447700>!             aa1(i) = aa1(i) +<a name='1620'></font>
<font color=#447700>!!   &amp;                 dz1 * eta(i,k) * (g / (cp * to(i,k)))<a name='1621'></font>
<font color=#447700>!    &amp;                 dz1 * (g / (cp * to(i,k)))<a name='1622'></font>
<font color=#447700>!    &amp;                 * dbyo(i,k) / (1. + gamma)<a name='1623'></font>
<font color=#447700>!    &amp;                 * rfact<a name='1624'></font>
<font color=#447700>!             val = 0.<a name='1625'></font>
<font color=#447700>!             aa1(i) = aa1(i) +<a name='1626'></font>
<font color=#447700>!!   &amp;                 dz1 * eta(i,k) * g * delta *<a name='1627'></font>
<font color=#447700>!    &amp;                 dz1 * g * delta *<a name='1628'></font>
<font color=#447700>!    &amp;                 max(val,(qeso(i,k) - qo(i,k)))<a name='1629'></font>
<font color=#447700>!           endif<a name='1630'></font>
<font color=#447700>!         endif<a name='1631'></font>
<font color=#447700>!       enddo<a name='1632'></font>
<font color=#447700>!     enddo<a name='1633'></font>
<font color=#447700>!<a name='1634'></font>
<font color=#447700>!  calculate cloud work function<a name='1635'></font>
<font color=#447700>!<a name='1636'></font>
      do i = 1, im<a name='1637'>
        if (cnvflg(i)) then<a name='1638'>
          aa1(i) = 0.<a name='1639'>
        endif<a name='1640'>
      enddo<a name='1641'>
      do k = 2, km1<a name='1642'>
        do i = 1, im<a name='1643'>
          if (cnvflg(i)) then<a name='1644'>
            if(k.ge.kbcon(i) .and. k.lt.ktcon(i)) then<a name='1645'>
              dz1 = zo(i,k+1) - zo(i,k)<a name='1646'>
<font color=#447700>!             aa1(i) = aa1(i) + buo(i,k) * dz1 * eta(i,k)<a name='1647'></font>
              aa1(i) = aa1(i) + buo(i,k) * dz1<a name='1648'>
            endif<a name='1649'>
          endif<a name='1650'>
        enddo<a name='1651'>
      enddo<a name='1652'>
<font color=#447700>!<a name='1653'></font>
      do i = 1, im<a name='1654'>
        if(cnvflg(i).and.aa1(i).le.0.) cnvflg(i) = .false.<a name='1655'>
      enddo<a name='1656'>
<font color=#447700>!!<a name='1657'></font>
      totflg = .true.<a name='1658'>
      do i=1,im<a name='1659'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='1660'>
      enddo<a name='1661'>
      if(totflg) return<a name='1662'>
<font color=#447700>!!<a name='1663'></font>
<font color=#447700>!c<a name='1664'></font>
<font color=#447700>!c  estimate the onvective overshooting as the level <a name='1665'></font>
<font color=#447700>!c    where the [aafac * cloud work function] becomes zero,<a name='1666'></font>
<font color=#447700>!c    which is the final cloud top<a name='1667'></font>
<font color=#447700>!c<a name='1668'></font>
      do i = 1, im<a name='1669'>
        if (cnvflg(i)) then<a name='1670'>
          aa2(i) = aafac * aa1(i)<a name='1671'>
        endif<a name='1672'>
      enddo<a name='1673'>
<font color=#447700>!c<a name='1674'></font>
      do i = 1, im<a name='1675'>
        flg(i) = cnvflg(i)<a name='1676'>
        ktcon1(i) = kmax(i)<a name='1677'>
      enddo<a name='1678'>
      do k = 2, km1<a name='1679'>
        do i = 1, im<a name='1680'>
          if (flg(i)) then<a name='1681'>
            if(k.ge.ktcon(i).and.k.lt.kmax(i)) then<a name='1682'>
              dz1 = zo(i,k+1) - zo(i,k)<a name='1683'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='1684'>
              rfact =  1. + delta * cp * gamma                          &amp;<a name='1685'>
     &amp;                 * to(i,k) / hvap<a name='1686'>
              aa2(i) = aa2(i) +                                         &amp;<a name='1687'>
<font color=#447700>!    &amp;                 dz1 * eta(i,k) * (g / (cp * to(i,k)))<a name='1688'></font>
     &amp;                 dz1 * (g / (cp * to(i,k)))                       &amp;<a name='1689'>
     &amp;                 * dbyo(i,k) / (1. + gamma)                       &amp;<a name='1690'>
     &amp;                 * rfact<a name='1691'>
<font color=#447700>!             val = 0.<a name='1692'></font>
<font color=#447700>!             aa2(i) = aa2(i) +<a name='1693'></font>
<font color=#447700>!!   &amp;                 dz1 * eta(i,k) * g * delta *<a name='1694'></font>
<font color=#447700>!    &amp;                 dz1 * g * delta *<a name='1695'></font>
<font color=#447700>!    &amp;                 max(val,(qeso(i,k) - qo(i,k)))<a name='1696'></font>
              if(aa2(i).lt.0.) then<a name='1697'>
                ktcon1(i) = k<a name='1698'>
                flg(i) = .false.<a name='1699'>
              endif<a name='1700'>
            endif<a name='1701'>
          endif<a name='1702'>
        enddo<a name='1703'>
      enddo<a name='1704'>
<font color=#447700>!c<a name='1705'></font>
<font color=#447700>!c  compute cloud moisture property, detraining cloud water <a name='1706'></font>
<font color=#447700>!c    and precipitation in overshooting layers <a name='1707'></font>
<font color=#447700>!c<a name='1708'></font>
      do k = 2, km1<a name='1709'>
        do i = 1, im<a name='1710'>
          if (cnvflg(i)) then<a name='1711'>
            if(k.ge.ktcon(i).and.k.lt.ktcon1(i)) then<a name='1712'>
              dz    = zi(i,k) - zi(i,k-1)<a name='1713'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='1714'>
              qrch = qeso(i,k)                                      &amp;<a name='1715'>
     &amp;             + gamma * dbyo(i,k) / (hvap * (1. + gamma))<a name='1716'>
<font color=#447700>!cj<a name='1717'></font>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='1718'>
              tem1 = 0.25 * (xlamud(i,k)+xlamud(i,k-1)) * dz<a name='1719'>
              factor = 1. + tem - tem1<a name='1720'>
              qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*            &amp;<a name='1721'>
     &amp;                     (qo(i,k)+qo(i,k-1)))/factor<a name='1722'>
              qrcko(i,k) = qcko(i,k)<a name='1723'>
<font color=#447700>!cj<a name='1724'></font>
              dq = eta(i,k) * (qcko(i,k) - qrch)<a name='1725'>
<font color=#447700>!c<a name='1726'></font>
<font color=#447700>!c  check if there is excess moisture to release latent heat<a name='1727'></font>
<font color=#447700>!c<a name='1728'></font>
              if(dq.gt.0.) then<a name='1729'>
                etah = .5 * (eta(i,k) + eta(i,k-1))<a name='1730'>
                if(ncloud.gt.0) then<a name='1731'>
                  dp = 1000. * del(i,k)<a name='1732'>
                  ptem = c0t(i,k) + c1(i)<a name='1733'>
                  qlk = dq / (eta(i,k) + etah * ptem * dz)<a name='1734'>
                  dellal(i,k) = etah * c1(i) * dz * qlk * g / dp<a name='1735'>
                else<a name='1736'>
                  qlk = dq / (eta(i,k) + etah * c0t(i,k) * dz)<a name='1737'>
                endif<a name='1738'>
                qcko(i,k) = qlk + qrch<a name='1739'>
                pwo(i,k) = etah * c0t(i,k) * dz * qlk<a name='1740'>
                pwavo(i) = pwavo(i) + pwo(i,k)<a name='1741'>
<font color=#447700>!               cnvwt(i,k) = (etah*qlk + pwo(i,k)) * g / dp<a name='1742'></font>
                cnvwt(i,k) = etah * qlk * g / dp<a name='1743'>
              endif<a name='1744'>
            endif<a name='1745'>
          endif<a name='1746'>
        enddo<a name='1747'>
      enddo<a name='1748'>
<font color=#447700>!<a name='1749'></font>
<font color=#447700>!  compute updraft velocity square(wu2)<a name='1750'></font>
<font color=#447700>!<a name='1751'></font>
      bb1 = 2. * (1.+bet1*cd1)<a name='1752'>
      bb2 = 2. / (f1*(1.+gam1))<a name='1753'>
<font color=#447700>!<a name='1754'></font>
<font color=#447700>!     bb1 = 12.0<a name='1755'></font>
<font color=#447700>!     bb2 = 0.67<a name='1756'></font>
<font color=#447700>!<a name='1757'></font>
      do i = 1, im<a name='1758'>
        if (cnvflg(i)) then<a name='1759'>
          k = kbcon1(i)<a name='1760'>
          tem = po(i,k) / (rd * to(i,k))<a name='1761'>
          wucb = -0.01 * dot(i,k) / (tem * g)<a name='1762'>
          if(wucb.gt.0.) then<a name='1763'>
            wu2(i,k) = wucb * wucb<a name='1764'>
          else<a name='1765'>
            wu2(i,k) = 0.<a name='1766'>
          endif<a name='1767'>
        endif<a name='1768'>
      enddo<a name='1769'>
      do k = 2, km1<a name='1770'>
        do i = 1, im<a name='1771'>
          if (cnvflg(i)) then<a name='1772'>
            if(k.gt.kbcon1(i) .and. k.lt.ktcon(i)) then<a name='1773'>
              dz    = zi(i,k) - zi(i,k-1)<a name='1774'>
              tem  = 0.25 * bb1 * (drag(i,k)+drag(i,k-1)) * dz<a name='1775'>
              tem1 = 0.5 * bb2 * (buo(i,k)+buo(i,k-1)) * dz<a name='1776'>
              ptem = (1. - tem) * wu2(i,k-1)<a name='1777'>
              ptem1 = 1. + tem<a name='1778'>
              wu2(i,k) = (ptem + tem1) / ptem1<a name='1779'>
              wu2(i,k) = max(wu2(i,k), 0._kind_phys)<a name='1780'>
            endif<a name='1781'>
          endif<a name='1782'>
        enddo<a name='1783'>
      enddo<a name='1784'>
<font color=#447700>!<a name='1785'></font>
<font color=#447700>!  compute updraft velocity averaged over the whole cumulus<a name='1786'></font>
<font color=#447700>!<a name='1787'></font>
      do i = 1, im<a name='1788'>
        wc(i) = 0.<a name='1789'>
        sumx(i) = 0.<a name='1790'>
      enddo<a name='1791'>
      do k = 2, km1<a name='1792'>
        do i = 1, im<a name='1793'>
          if (cnvflg(i)) then<a name='1794'>
            if(k &gt; kbcon1(i) .and. k &lt; ktcon(i)) then<a name='1795'>
              dz = zi(i,k) - zi(i,k-1)<a name='1796'>
              tem = 0.5 * (sqrt(wu2(i,k)) + sqrt(wu2(i,k-1)))<a name='1797'>
              wc(i) = wc(i) + tem * dz<a name='1798'>
              sumx(i) = sumx(i) + dz<a name='1799'>
            endif<a name='1800'>
          endif<a name='1801'>
        enddo<a name='1802'>
      enddo<a name='1803'>
      do i = 1, im<a name='1804'>
        if(cnvflg(i)) then<a name='1805'>
          if(sumx(i) == 0.) then<a name='1806'>
             cnvflg(i)=.false.<a name='1807'>
          else<a name='1808'>
             wc(i) = wc(i) / sumx(i)<a name='1809'>
          endif<a name='1810'>
          val = 1.e-4<a name='1811'>
          if (wc(i) &lt; val) cnvflg(i)=.false.<a name='1812'>
        endif<a name='1813'>
      enddo<a name='1814'>
<font color=#447700>!c<a name='1815'></font>
<font color=#447700>!c exchange ktcon with ktcon1<a name='1816'></font>
<font color=#447700>!c<a name='1817'></font>
      do i = 1, im<a name='1818'>
        if(cnvflg(i)) then<a name='1819'>
          kk = ktcon(i)<a name='1820'>
          ktcon(i) = ktcon1(i)<a name='1821'>
          ktcon1(i) = kk<a name='1822'>
        endif<a name='1823'>
      enddo<a name='1824'>
<font color=#447700>!c<a name='1825'></font>
<font color=#447700>!c  this section is ready for cloud water<a name='1826'></font>
<font color=#447700>!c<a name='1827'></font>
      if(ncloud.gt.0) then<a name='1828'>
<font color=#447700>!c<a name='1829'></font>
<font color=#447700>!c  compute liquid and vapor separation at cloud top<a name='1830'></font>
<font color=#447700>!c<a name='1831'></font>
      do i = 1, im<a name='1832'>
        if(cnvflg(i)) then<a name='1833'>
          k = ktcon(i) - 1<a name='1834'>
          gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='1835'>
          qrch = qeso(i,k)                                           &amp;<a name='1836'>
     &amp;         + gamma * dbyo(i,k) / (hvap * (1. + gamma))<a name='1837'>
          dq = qcko(i,k) - qrch<a name='1838'>
<font color=#447700>!c<a name='1839'></font>
<font color=#447700>!c  check if there is excess moisture to release latent heat<a name='1840'></font>
<font color=#447700>!c<a name='1841'></font>
          if(dq.gt.0.) then<a name='1842'>
            qlko_ktcon(i) = dq<a name='1843'>
            qcko(i,k) = qrch<a name='1844'>
          endif<a name='1845'>
        endif<a name='1846'>
      enddo<a name='1847'>
      endif<a name='1848'>
<font color=#447700>!c<a name='1849'></font>
<font color=#447700>!ccccc if(lat.eq.latd.and.lon.eq.lond.and.cnvflg(i)) then<a name='1850'></font>
<font color=#447700>!ccccc   print *, ' aa1(i) before dwndrft =', aa1(i)<a name='1851'></font>
<font color=#447700>!ccccc endif<a name='1852'></font>
<font color=#447700>!c<a name='1853'></font>
<font color=#447700>!c------- downdraft calculations<a name='1854'></font>
<font color=#447700>!c<a name='1855'></font>
<font color=#447700>!c--- compute precipitation efficiency in terms of windshear<a name='1856'></font>
<font color=#447700>!c<a name='1857'></font>
      do i = 1, im<a name='1858'>
        if(cnvflg(i)) then<a name='1859'>
          vshear(i) = 0.<a name='1860'>
        endif<a name='1861'>
      enddo<a name='1862'>
      do k = 2, km<a name='1863'>
        do i = 1, im<a name='1864'>
          if (cnvflg(i)) then<a name='1865'>
            if(k.gt.kb(i).and.k.le.ktcon(i)) then<a name='1866'>
              shear= sqrt((uo(i,k)-uo(i,k-1)) ** 2                    &amp;<a name='1867'>
     &amp;                  + (vo(i,k)-vo(i,k-1)) ** 2)<a name='1868'>
              vshear(i) = vshear(i) + shear<a name='1869'>
            endif<a name='1870'>
          endif<a name='1871'>
        enddo<a name='1872'>
      enddo<a name='1873'>
      do i = 1, im<a name='1874'>
        if(cnvflg(i)) then<a name='1875'>
          vshear(i) = 1.e3 * vshear(i) / (zi(i,ktcon(i))-zi(i,kb(i)))<a name='1876'>
          e1=1.591-.639*vshear(i)                                     &amp;<a name='1877'>
     &amp;       +.0953*(vshear(i)**2)-.00496*(vshear(i)**3)<a name='1878'>
          edt(i)=1.-e1<a name='1879'>
          val =         .9<a name='1880'>
          edt(i) = min(edt(i),val)<a name='1881'>
          val =         .0<a name='1882'>
          edt(i) = max(edt(i),val)<a name='1883'>
          edto(i)=edt(i)<a name='1884'>
          edtx(i)=edt(i)<a name='1885'>
        endif<a name='1886'>
      enddo<a name='1887'>
<font color=#447700>!c<a name='1888'></font>
<font color=#447700>!c  determine detrainment rate between 1 and kbcon<a name='1889'></font>
<font color=#447700>!c<a name='1890'></font>
      do i = 1, im<a name='1891'>
        if(cnvflg(i)) then<a name='1892'>
          sumx(i) = 0.<a name='1893'>
        endif<a name='1894'>
      enddo<a name='1895'>
      do k = 1, km1<a name='1896'>
      do i = 1, im<a name='1897'>
        if(cnvflg(i).and.k.ge.1.and.k.lt.kbcon(i)) then<a name='1898'>
          dz = zi(i,k+1) - zi(i,k)<a name='1899'>
          sumx(i) = sumx(i) + dz<a name='1900'>
        endif<a name='1901'>
      enddo<a name='1902'>
      enddo<a name='1903'>
      do i = 1, im<a name='1904'>
        beta = betas<a name='1905'>
        if(islimsk(i) == 1) beta = betal<a name='1906'>
        if(cnvflg(i)) then<a name='1907'>
          dz  = (sumx(i)+zi(i,1))/float(kbcon(i))<a name='1908'>
          tem = 1./float(kbcon(i))<a name='1909'>
          xlamd(i) = (1.-beta**tem)/dz<a name='1910'>
        endif<a name='1911'>
      enddo<a name='1912'>
<font color=#447700>!c<a name='1913'></font>
<font color=#447700>!c  determine downdraft mass flux<a name='1914'></font>
<font color=#447700>!c<a name='1915'></font>
      do k = km1, 1, -1<a name='1916'>
        do i = 1, im<a name='1917'>
          if (cnvflg(i) .and. k .le. kmax(i)-1) then<a name='1918'>
           if(k.lt.jmin(i).and.k.ge.kbcon(i)) then<a name='1919'>
              dz        = zi(i,k+1) - zi(i,k)<a name='1920'>
              ptem      = xlamdd - xlamde<a name='1921'>
              etad(i,k) = etad(i,k+1) * (1. - ptem * dz)<a name='1922'>
           else if(k.lt.kbcon(i)) then<a name='1923'>
              dz        = zi(i,k+1) - zi(i,k)<a name='1924'>
              ptem      = xlamd(i) + xlamdd - xlamde<a name='1925'>
              etad(i,k) = etad(i,k+1) * (1. - ptem * dz)<a name='1926'>
           endif<a name='1927'>
          endif<a name='1928'>
        enddo<a name='1929'>
      enddo<a name='1930'>
<font color=#447700>!c<a name='1931'></font>
<font color=#447700>!c--- downdraft moisture properties<a name='1932'></font>
<font color=#447700>!c<a name='1933'></font>
      do i = 1, im<a name='1934'>
        if(cnvflg(i)) then<a name='1935'>
          jmn = jmin(i)<a name='1936'>
          hcdo(i,jmn) = heo(i,jmn)<a name='1937'>
          qcdo(i,jmn) = qo(i,jmn)<a name='1938'>
          qrcdo(i,jmn)= qo(i,jmn)<a name='1939'>
          ucdo(i,jmn) = uo(i,jmn)<a name='1940'>
          vcdo(i,jmn) = vo(i,jmn)<a name='1941'>
          pwevo(i) = 0.<a name='1942'>
        endif<a name='1943'>
      enddo<a name='1944'>
<font color=#447700>!cj<a name='1945'></font>
      do k = km1, 1, -1<a name='1946'>
        do i = 1, im<a name='1947'>
          if (cnvflg(i) .and. k.lt.jmin(i)) then<a name='1948'>
              dz = zi(i,k+1) - zi(i,k)<a name='1949'>
              if(k.ge.kbcon(i)) then<a name='1950'>
                 tem  = xlamde * dz<a name='1951'>
                 tem1 = 0.5 * xlamdd * dz<a name='1952'>
              else<a name='1953'>
                 tem  = xlamde * dz<a name='1954'>
                 tem1 = 0.5 * (xlamd(i)+xlamdd) * dz<a name='1955'>
              endif<a name='1956'>
              factor = 1. + tem - tem1<a name='1957'>
              hcdo(i,k) = ((1.-tem1)*hcdo(i,k+1)+tem*0.5*            &amp;<a name='1958'>
     &amp;                     (heo(i,k)+heo(i,k+1)))/factor<a name='1959'>
              dbyo(i,k) = hcdo(i,k) - heso(i,k)<a name='1960'>
<font color=#447700>!<a name='1961'></font>
              tem  = 0.5 * cm * tem<a name='1962'>
              factor = 1. + tem<a name='1963'>
              ptem = tem - pgcon<a name='1964'>
              ptem1= tem + pgcon<a name='1965'>
              ucdo(i,k) = ((1.-tem)*ucdo(i,k+1)+ptem*uo(i,k+1)        &amp;<a name='1966'>
     &amp;                     +ptem1*uo(i,k))/factor<a name='1967'>
              vcdo(i,k) = ((1.-tem)*vcdo(i,k+1)+ptem*vo(i,k+1)        &amp;<a name='1968'>
     &amp;                     +ptem1*vo(i,k))/factor<a name='1969'>
          endif<a name='1970'>
        enddo<a name='1971'>
      enddo<a name='1972'>
<font color=#447700>!c<a name='1973'></font>
      do k = km1, 1, -1<a name='1974'>
        do i = 1, im<a name='1975'>
          if (cnvflg(i).and.k.lt.jmin(i)) then<a name='1976'>
              gamma      = el2orc * qeso(i,k) / (to(i,k)**2)<a name='1977'>
              qrcdo(i,k) = qeso(i,k)+                                 &amp;<a name='1978'>
     &amp;                (1./hvap)*(gamma/(1.+gamma))*dbyo(i,k)<a name='1979'>
<font color=#447700>!             detad      = etad(i,k+1) - etad(i,k)<a name='1980'></font>
<font color=#447700>!cj<a name='1981'></font>
              dz = zi(i,k+1) - zi(i,k)<a name='1982'>
              if(k.ge.kbcon(i)) then<a name='1983'>
                 tem  = xlamde * dz<a name='1984'>
                 tem1 = 0.5 * xlamdd * dz<a name='1985'>
              else<a name='1986'>
                 tem  = xlamde * dz<a name='1987'>
                 tem1 = 0.5 * (xlamd(i)+xlamdd) * dz<a name='1988'>
              endif<a name='1989'>
              factor = 1. + tem - tem1<a name='1990'>
              qcdo(i,k) = ((1.-tem1)*qrcdo(i,k+1)+tem*0.5*           &amp;<a name='1991'>
     &amp;                     (qo(i,k)+qo(i,k+1)))/factor<a name='1992'>
<font color=#447700>!cj<a name='1993'></font>
<font color=#447700>!             pwdo(i,k)  = etad(i,k+1) * qcdo(i,k+1) -<a name='1994'></font>
<font color=#447700>!    &amp;                     etad(i,k) * qrcdo(i,k)<a name='1995'></font>
<font color=#447700>!             pwdo(i,k)  = pwdo(i,k) - detad *<a name='1996'></font>
<font color=#447700>!    &amp;                    .5 * (qrcdo(i,k) + qrcdo(i,k+1))<a name='1997'></font>
<font color=#447700>!cj<a name='1998'></font>
              pwdo(i,k)  = etad(i,k) * (qcdo(i,k) - qrcdo(i,k))<a name='1999'>
              pwevo(i)   = pwevo(i) + pwdo(i,k)<a name='2000'>
          endif<a name='2001'>
        enddo<a name='2002'>
      enddo<a name='2003'>
<font color=#447700>!c<a name='2004'></font>
<font color=#447700>!c--- final downdraft strength dependent on precip<a name='2005'></font>
<font color=#447700>!c--- efficiency (edt), normalized condensate (pwav), and<a name='2006'></font>
<font color=#447700>!c--- evaporate (pwev)<a name='2007'></font>
<font color=#447700>!c<a name='2008'></font>
      do i = 1, im<a name='2009'>
        edtmax = edtmaxl<a name='2010'>
        if(islimsk(i) == 0) edtmax = edtmaxs<a name='2011'>
        if(cnvflg(i)) then<a name='2012'>
          if(pwevo(i).lt.0.) then<a name='2013'>
            edto(i) = -edto(i) * pwavo(i) / pwevo(i)<a name='2014'>
            edto(i) = min(edto(i),edtmax)<a name='2015'>
          else<a name='2016'>
            edto(i) = 0.<a name='2017'>
          endif<a name='2018'>
        endif<a name='2019'>
      enddo<a name='2020'>
<font color=#447700>!c<a name='2021'></font>
<font color=#447700>!c--- downdraft cloudwork functions<a name='2022'></font>
<font color=#447700>!c<a name='2023'></font>
      do k = km1, 1, -1<a name='2024'>
        do i = 1, im<a name='2025'>
          if (cnvflg(i) .and. k .lt. jmin(i)) then<a name='2026'>
              gamma = el2orc * qeso(i,k) / to(i,k)**2<a name='2027'>
              dhh=hcdo(i,k)<a name='2028'>
              dt=to(i,k)<a name='2029'>
              dg=gamma<a name='2030'>
              dh=heso(i,k)<a name='2031'>
              dz=-1.*(zo(i,k+1)-zo(i,k))<a name='2032'>
<font color=#447700>!             aa1(i)=aa1(i)+edto(i)*dz*etad(i,k)<a name='2033'></font>
              aa1(i)=aa1(i)+edto(i)*dz                                 &amp;<a name='2034'>
     &amp;               *(g/(cp*dt))*((dhh-dh)/(1.+dg))                   &amp;<a name='2035'>
     &amp;               *(1.+delta*cp*dg*dt/hvap)<a name='2036'>
              val=0.<a name='2037'>
<font color=#447700>!             aa1(i)=aa1(i)+edto(i)*dz*etad(i,k)<a name='2038'></font>
              aa1(i)=aa1(i)+edto(i)*dz                                 &amp;<a name='2039'>
     &amp;               *g*delta*max(val,(qeso(i,k)-qo(i,k)))<a name='2040'>
          endif<a name='2041'>
        enddo<a name='2042'>
      enddo<a name='2043'>
      do i = 1, im<a name='2044'>
        if(cnvflg(i).and.aa1(i).le.0.) then<a name='2045'>
           cnvflg(i) = .false.<a name='2046'>
        endif<a name='2047'>
      enddo<a name='2048'>
<font color=#447700>!!<a name='2049'></font>
      totflg = .true.<a name='2050'>
      do i=1,im<a name='2051'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='2052'>
      enddo<a name='2053'>
      if(totflg) return<a name='2054'>
<font color=#447700>!!<a name='2055'></font>
<font color=#447700>!c<a name='2056'></font>
<font color=#447700>!c--- what would the change be, that a cloud with unit mass<a name='2057'></font>
<font color=#447700>!c--- will do to the environment?<a name='2058'></font>
<font color=#447700>!c<a name='2059'></font>
      do k = 1, km<a name='2060'>
        do i = 1, im<a name='2061'>
          if(cnvflg(i) .and. k .le. kmax(i)) then<a name='2062'>
            dellah(i,k) = 0.<a name='2063'>
            dellaq(i,k) = 0.<a name='2064'>
            dellau(i,k) = 0.<a name='2065'>
            dellav(i,k) = 0.<a name='2066'>
          endif<a name='2067'>
        enddo<a name='2068'>
      enddo<a name='2069'>
      do i = 1, im<a name='2070'>
        if(cnvflg(i)) then<a name='2071'>
          dp = 1000. * del(i,1)<a name='2072'>
          dellah(i,1) = edto(i) * etad(i,1) * (hcdo(i,1)               &amp;<a name='2073'>
     &amp;                   - heo(i,1)) * g / dp<a name='2074'>
          dellaq(i,1) = edto(i) * etad(i,1) * (qrcdo(i,1)              &amp;<a name='2075'>
     &amp;                   - qo(i,1)) * g / dp<a name='2076'>
          dellau(i,1) = edto(i) * etad(i,1) * (ucdo(i,1)               &amp;<a name='2077'>
     &amp;                   - uo(i,1)) * g / dp<a name='2078'>
          dellav(i,1) = edto(i) * etad(i,1) * (vcdo(i,1)               &amp;<a name='2079'>
     &amp;                   - vo(i,1)) * g / dp<a name='2080'>
        endif<a name='2081'>
      enddo<a name='2082'>
<font color=#447700>!c<a name='2083'></font>
<font color=#447700>!c--- changed due to subsidence and entrainment<a name='2084'></font>
<font color=#447700>!c<a name='2085'></font>
      do k = 2, km1<a name='2086'>
        do i = 1, im<a name='2087'>
          if (cnvflg(i).and.k.lt.ktcon(i)) then<a name='2088'>
              aup = 1.<a name='2089'>
              if(k.le.kb(i)) aup = 0.<a name='2090'>
              adw = 1.<a name='2091'>
              if(k.gt.jmin(i)) adw = 0.<a name='2092'>
              dp = 1000. * del(i,k)<a name='2093'>
              dz = zi(i,k) - zi(i,k-1)<a name='2094'>
<font color=#447700>!c<a name='2095'></font>
              dv1h = heo(i,k)<a name='2096'>
              dv2h = .5 * (heo(i,k) + heo(i,k-1))<a name='2097'>
              dv3h = heo(i,k-1)<a name='2098'>
              dv1q = qo(i,k)<a name='2099'>
              dv2q = .5 * (qo(i,k) + qo(i,k-1))<a name='2100'>
              dv3q = qo(i,k-1)<a name='2101'>
<font color=#447700>!c<a name='2102'></font>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1))<a name='2103'>
              tem1 = 0.5 * (xlamud(i,k)+xlamud(i,k-1))<a name='2104'>
<font color=#447700>!c<a name='2105'></font>
              if(k.le.kbcon(i)) then<a name='2106'>
                ptem  = xlamde<a name='2107'>
                ptem1 = xlamd(i)+xlamdd<a name='2108'>
              else<a name='2109'>
                ptem  = xlamde<a name='2110'>
                ptem1 = xlamdd<a name='2111'>
              endif<a name='2112'>
<font color=#447700>!cj<a name='2113'></font>
              dellah(i,k) = dellah(i,k) +                                &amp;<a name='2114'>
     &amp;     ((aup*eta(i,k)-adw*edto(i)*etad(i,k))*dv1h                    &amp;<a name='2115'>
     &amp;    - (aup*eta(i,k-1)-adw*edto(i)*etad(i,k-1))*dv3h                 &amp;<a name='2116'>
     &amp;    - (aup*tem*eta(i,k-1)+adw*edto(i)*ptem*etad(i,k))*dv2h*dz       &amp;<a name='2117'>
     &amp;    +  aup*tem1*eta(i,k-1)*.5*(hcko(i,k)+hcko(i,k-1))*dz            &amp;<a name='2118'>
     &amp;    +  adw*edto(i)*ptem1*etad(i,k)*.5*(hcdo(i,k)+hcdo(i,k-1))*dz    &amp;<a name='2119'>
     &amp;         ) *g/dp<a name='2120'>
<font color=#447700>!cj<a name='2121'></font>
              dellaq(i,k) = dellaq(i,k) +                                 &amp;<a name='2122'>
     &amp;     ((aup*eta(i,k)-adw*edto(i)*etad(i,k))*dv1q                     &amp;<a name='2123'>
     &amp;    - (aup*eta(i,k-1)-adw*edto(i)*etad(i,k-1))*dv3q                 &amp;<a name='2124'>
     &amp;    - (aup*tem*eta(i,k-1)+adw*edto(i)*ptem*etad(i,k))*dv2q*dz       &amp;<a name='2125'>
     &amp;    +  aup*tem1*eta(i,k-1)*.5*(qrcko(i,k)+qcko(i,k-1))*dz           &amp;<a name='2126'>
     &amp;    +  adw*edto(i)*ptem1*etad(i,k)*.5*(qrcdo(i,k)+qcdo(i,k-1))*dz   &amp;<a name='2127'>
     &amp;         ) *g/dp<a name='2128'>
<font color=#447700>!cj<a name='2129'></font>
              tem1=eta(i,k)*(uo(i,k)-ucko(i,k))<a name='2130'>
              tem2=eta(i,k-1)*(uo(i,k-1)-ucko(i,k-1))<a name='2131'>
              ptem1=etad(i,k)*(uo(i,k)-ucdo(i,k))<a name='2132'>
              ptem2=etad(i,k-1)*(uo(i,k-1)-ucdo(i,k-1))<a name='2133'>
              dellau(i,k) = dellau(i,k) +                                &amp;<a name='2134'>
     &amp;           (aup*(tem1-tem2)-adw*edto(i)*(ptem1-ptem2))*g/dp<a name='2135'>
<font color=#447700>!cj<a name='2136'></font>
              tem1=eta(i,k)*(vo(i,k)-vcko(i,k))<a name='2137'>
              tem2=eta(i,k-1)*(vo(i,k-1)-vcko(i,k-1))<a name='2138'>
              ptem1=etad(i,k)*(vo(i,k)-vcdo(i,k))<a name='2139'>
              ptem2=etad(i,k-1)*(vo(i,k-1)-vcdo(i,k-1))<a name='2140'>
              dellav(i,k) = dellav(i,k) +                                &amp;<a name='2141'>
     &amp;           (aup*(tem1-tem2)-adw*edto(i)*(ptem1-ptem2))*g/dp<a name='2142'>
<font color=#447700>!cj<a name='2143'></font>
          endif<a name='2144'>
        enddo<a name='2145'>
      enddo<a name='2146'>
<font color=#447700>!c<a name='2147'></font>
<font color=#447700>!c------- cloud top<a name='2148'></font>
<font color=#447700>!c<a name='2149'></font>
      do i = 1, im<a name='2150'>
        if(cnvflg(i)) then<a name='2151'>
          indx = ktcon(i)<a name='2152'>
          dp = 1000. * del(i,indx)<a name='2153'>
          dv1h = heo(i,indx-1)<a name='2154'>
          dellah(i,indx) = eta(i,indx-1) *                               &amp;<a name='2155'>
     &amp;                     (hcko(i,indx-1) - dv1h) * g / dp<a name='2156'>
          dv1q = qo(i,indx-1)<a name='2157'>
          dellaq(i,indx) = eta(i,indx-1) *                                &amp;<a name='2158'>
     &amp;                     (qcko(i,indx-1) - dv1q) * g / dp<a name='2159'>
          dellau(i,indx) = eta(i,indx-1) *                                &amp;<a name='2160'>
     &amp;             (ucko(i,indx-1) - uo(i,indx-1)) * g / dp<a name='2161'>
          dellav(i,indx) = eta(i,indx-1) *                                &amp;<a name='2162'>
     &amp;             (vcko(i,indx-1) - vo(i,indx-1)) * g / dp<a name='2163'>
<font color=#447700>!c<a name='2164'></font>
<font color=#447700>!c  cloud water<a name='2165'></font>
<font color=#447700>!c<a name='2166'></font>
          dellal(i,indx) = eta(i,indx-1) *                                &amp;<a name='2167'>
     &amp;                     qlko_ktcon(i) * g / dp<a name='2168'>
        endif<a name='2169'>
      enddo<a name='2170'>
<font color=#447700>!c<a name='2171'></font>
<font color=#447700>!c------- final changed variable per unit mass flux<a name='2172'></font>
<font color=#447700>!c<a name='2173'></font>
      do k = 1, km<a name='2174'>
        do i = 1, im<a name='2175'>
          if (cnvflg(i).and.k .le. kmax(i)) then<a name='2176'>
            if(k.gt.ktcon(i)) then<a name='2177'>
              qo(i,k) = q1(i,k)<a name='2178'>
              to(i,k) = t1(i,k)<a name='2179'>
            endif<a name='2180'>
            if(k.le.ktcon(i)) then<a name='2181'>
              qo(i,k) = dellaq(i,k) * mbdt(i) + q1(i,k)<a name='2182'>
              dellat = (dellah(i,k) - hvap * dellaq(i,k)) / cp<a name='2183'>
              to(i,k) = dellat * mbdt(i) + t1(i,k)<a name='2184'>
              val   =           1.e-10<a name='2185'>
              qo(i,k) = max(qo(i,k), val  )<a name='2186'>
            endif<a name='2187'>
          endif<a name='2188'>
        enddo<a name='2189'>
      enddo<a name='2190'>
<font color=#447700>!c!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2191'></font>
<font color=#447700>!c<a name='2192'></font>
<font color=#447700>!c--- the above changed environment is now used to calulate the<a name='2193'></font>
<font color=#447700>!c--- effect the arbitrary cloud (with unit mass flux)<a name='2194'></font>
<font color=#447700>!c--- would have on the stability,<a name='2195'></font>
<font color=#447700>!c--- which then is used to calculate the real mass flux,<a name='2196'></font>
<font color=#447700>!c--- necessary to keep this change in balance with the large-scale<a name='2197'></font>
<font color=#447700>!c--- destabilization.<a name='2198'></font>
<font color=#447700>!c<a name='2199'></font>
<font color=#447700>!c--- environmental conditions again, first heights<a name='2200'></font>
<font color=#447700>!c<a name='2201'></font>
      do k = 1, km<a name='2202'>
        do i = 1, im<a name='2203'>
          if(cnvflg(i) .and. k .le. kmax(i)) then<a name='2204'>
            qeso(i,k) = 0.01 * fpvs(to(i,k))      <font color=#447700>! fpvs is in pa<a name='2205'></font>
            qeso(i,k) = eps * qeso(i,k) / (pfld(i,k)+epsm1*qeso(i,k))<a name='2206'>
            val       =             1.e-8<a name='2207'>
            qeso(i,k) = max(qeso(i,k), val )<a name='2208'>
<font color=#447700>!           tvo(i,k)  = to(i,k) + delta * to(i,k) * qo(i,k)<a name='2209'></font>
          endif<a name='2210'>
        enddo<a name='2211'>
      enddo<a name='2212'>
<font color=#447700>!c<a name='2213'></font>
<font color=#447700>!c--- moist static energy<a name='2214'></font>
<font color=#447700>!c<a name='2215'></font>
      do k = 1, km1<a name='2216'>
        do i = 1, im<a name='2217'>
          if(cnvflg(i) .and. k .le. kmax(i)-1) then<a name='2218'>
            dz = .5 * (zo(i,k+1) - zo(i,k))<a name='2219'>
            dp = .5 * (pfld(i,k+1) - pfld(i,k))<a name='2220'>
            es = 0.01 * fpvs(to(i,k+1))      <font color=#447700>! fpvs is in pa<a name='2221'></font>
            pprime = pfld(i,k+1) + epsm1 * es<a name='2222'>
            qs = eps * es / pprime<a name='2223'>
            dqsdp = - qs / pprime<a name='2224'>
            desdt = es * (fact1 / to(i,k+1) + fact2 / (to(i,k+1)**2))<a name='2225'>
            dqsdt = qs * pfld(i,k+1) * desdt / (es * pprime)<a name='2226'>
            gamma = el2orc * qeso(i,k+1) / (to(i,k+1)**2)<a name='2227'>
            dt = (g * dz + hvap * dqsdp * dp) / (cp * (1. + gamma))<a name='2228'>
            dq = dqsdt * dt + dqsdp * dp<a name='2229'>
            to(i,k) = to(i,k+1) + dt<a name='2230'>
            qo(i,k) = qo(i,k+1) + dq<a name='2231'>
            po(i,k) = .5 * (pfld(i,k) + pfld(i,k+1))<a name='2232'>
          endif<a name='2233'>
        enddo<a name='2234'>
      enddo<a name='2235'>
      do k = 1, km1<a name='2236'>
        do i = 1, im<a name='2237'>
          if(cnvflg(i) .and. k .le. kmax(i)-1) then<a name='2238'>
            qeso(i,k) = 0.01 * fpvs(to(i,k))      <font color=#447700>! fpvs is in pa<a name='2239'></font>
            qeso(i,k) = eps * qeso(i,k) / (po(i,k) + epsm1 * qeso(i,k))<a name='2240'>
            val1      =             1.e-8<a name='2241'>
            qeso(i,k) = max(qeso(i,k), val1)<a name='2242'>
            val2      =           1.e-10<a name='2243'>
            qo(i,k)   = max(qo(i,k), val2 )<a name='2244'>
<font color=#447700>!           qo(i,k)   = min(qo(i,k),qeso(i,k))<a name='2245'></font>
            heo(i,k)   = .5 * g * (zo(i,k) + zo(i,k+1)) +               &amp;<a name='2246'>
     &amp;                    cp * to(i,k) + hvap * qo(i,k)<a name='2247'>
            heso(i,k) = .5 * g * (zo(i,k) + zo(i,k+1)) +                &amp;<a name='2248'>
     &amp;                  cp * to(i,k) + hvap * qeso(i,k)<a name='2249'>
          endif<a name='2250'>
        enddo<a name='2251'>
      enddo<a name='2252'>
      do i = 1, im<a name='2253'>
        if(cnvflg(i)) then<a name='2254'>
          k = kmax(i)<a name='2255'>
          heo(i,k) = g * zo(i,k) + cp * to(i,k) + hvap * qo(i,k)<a name='2256'>
          heso(i,k) = g * zo(i,k) + cp * to(i,k) + hvap * qeso(i,k)<a name='2257'>
<font color=#447700>!c         heo(i,k) = min(heo(i,k),heso(i,k))<a name='2258'></font>
        endif<a name='2259'>
      enddo<a name='2260'>
<font color=#447700>!c<a name='2261'></font>
<font color=#447700>!c**************************** static control<a name='2262'></font>
<font color=#447700>!c<a name='2263'></font>
<font color=#447700>!c------- moisture and cloud work functions<a name='2264'></font>
<font color=#447700>!c<a name='2265'></font>
      do i = 1, im<a name='2266'>
        if(cnvflg(i)) then<a name='2267'>
          xaa0(i) = 0.<a name='2268'>
          xpwav(i) = 0.<a name='2269'>
        endif<a name='2270'>
      enddo<a name='2271'>
<font color=#447700>!c<a name='2272'></font>
      do i = 1, im<a name='2273'>
        if(cnvflg(i)) then<a name='2274'>
          indx = kb(i)<a name='2275'>
          hcko(i,indx) = heo(i,indx)<a name='2276'>
          qcko(i,indx) = qo(i,indx)<a name='2277'>
        endif<a name='2278'>
      enddo<a name='2279'>
      do k = 2, km1<a name='2280'>
        do i = 1, im<a name='2281'>
          if (cnvflg(i)) then<a name='2282'>
            if(k.gt.kb(i).and.k.le.ktcon(i)) then<a name='2283'>
              dz = zi(i,k) - zi(i,k-1)<a name='2284'>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='2285'>
              tem1 = 0.25 * (xlamud(i,k)+xlamud(i,k-1)) * dz<a name='2286'>
              factor = 1. + tem - tem1<a name='2287'>
              hcko(i,k) = ((1.-tem1)*hcko(i,k-1)+tem*0.5*               &amp;<a name='2288'>
     &amp;                     (heo(i,k)+heo(i,k-1)))/factor<a name='2289'>
            endif<a name='2290'>
          endif<a name='2291'>
        enddo<a name='2292'>
      enddo<a name='2293'>
      do k = 2, km1<a name='2294'>
        do i = 1, im<a name='2295'>
          if (cnvflg(i)) then<a name='2296'>
            if(k.gt.kb(i).and.k.lt.ktcon(i)) then<a name='2297'>
              dz = zi(i,k) - zi(i,k-1)<a name='2298'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='2299'>
              xdby = hcko(i,k) - heso(i,k)<a name='2300'>
              xqrch = qeso(i,k)                                        &amp;<a name='2301'>
     &amp;              + gamma * xdby / (hvap * (1. + gamma))<a name='2302'>
<font color=#447700>!cj<a name='2303'></font>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='2304'>
              tem1 = 0.25 * (xlamud(i,k)+xlamud(i,k-1)) * dz<a name='2305'>
              factor = 1. + tem - tem1<a name='2306'>
              qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*               &amp;<a name='2307'>
     &amp;                     (qo(i,k)+qo(i,k-1)))/factor<a name='2308'>
<font color=#447700>!cj<a name='2309'></font>
              dq = eta(i,k) * (qcko(i,k) - xqrch)<a name='2310'>
<font color=#447700>!c<a name='2311'></font>
              if(k.ge.kbcon(i).and.dq.gt.0.) then<a name='2312'>
                etah = .5 * (eta(i,k) + eta(i,k-1))<a name='2313'>
                if(ncloud.gt.0.and.k.gt.jmin(i)) then<a name='2314'>
                  ptem = c0t(i,k) + c1(i)<a name='2315'>
                  qlk = dq / (eta(i,k) + etah * ptem * dz)<a name='2316'>
                else<a name='2317'>
                  qlk = dq / (eta(i,k) + etah * c0t(i,k) * dz)<a name='2318'>
                endif<a name='2319'>
                if(k.lt.ktcon1(i)) then<a name='2320'>
<font color=#447700>!                 xaa0(i) = xaa0(i) - dz * g * qlk * etah<a name='2321'></font>
                  xaa0(i) = xaa0(i) - dz * g * qlk<a name='2322'>
                endif<a name='2323'>
                qcko(i,k) = qlk + xqrch<a name='2324'>
                xpw = etah * c0t(i,k) * dz * qlk<a name='2325'>
                xpwav(i) = xpwav(i) + xpw<a name='2326'>
              endif<a name='2327'>
            endif<a name='2328'>
            if(k.ge.kbcon(i).and.k.lt.ktcon1(i)) then<a name='2329'>
              dz1 = zo(i,k+1) - zo(i,k)<a name='2330'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='2331'>
              rfact =  1. + delta * cp * gamma                         &amp;<a name='2332'>
     &amp;                 * to(i,k) / hvap<a name='2333'>
              xaa0(i) = xaa0(i)                                         &amp;<a name='2334'>
<font color=#447700>!    &amp;                + dz1 * eta(i,k) * (g / (cp * to(i,k)))<a name='2335'></font>
     &amp;                + dz1 * (g / (cp * to(i,k)))                      &amp;<a name='2336'>
     &amp;                * xdby / (1. + gamma)                             &amp;<a name='2337'>
     &amp;                * rfact<a name='2338'>
              val=0.<a name='2339'>
              xaa0(i) = xaa0(i) +                                       &amp;<a name='2340'>
<font color=#447700>!    &amp;                 dz1 * eta(i,k) * g * delta *<a name='2341'></font>
     &amp;                 dz1 * g * delta *                                &amp;<a name='2342'>
     &amp;                 max(val,(qeso(i,k) - qo(i,k)))<a name='2343'>
            endif<a name='2344'>
          endif<a name='2345'>
        enddo<a name='2346'>
      enddo<a name='2347'>
<font color=#447700>!c<a name='2348'></font>
<font color=#447700>!c------- downdraft calculations<a name='2349'></font>
<font color=#447700>!c<a name='2350'></font>
<font color=#447700>!c--- downdraft moisture properties<a name='2351'></font>
<font color=#447700>!c<a name='2352'></font>
      do i = 1, im<a name='2353'>
        if(cnvflg(i)) then<a name='2354'>
          jmn = jmin(i)<a name='2355'>
          hcdo(i,jmn) = heo(i,jmn)<a name='2356'>
          qcdo(i,jmn) = qo(i,jmn)<a name='2357'>
          qrcd(i,jmn) = qo(i,jmn)<a name='2358'>
          xpwev(i) = 0.<a name='2359'>
        endif<a name='2360'>
      enddo<a name='2361'>
<font color=#447700>!cj<a name='2362'></font>
      do k = km1, 1, -1<a name='2363'>
        do i = 1, im<a name='2364'>
          if (cnvflg(i) .and. k.lt.jmin(i)) then<a name='2365'>
              dz = zi(i,k+1) - zi(i,k)<a name='2366'>
              if(k.ge.kbcon(i)) then<a name='2367'>
                 tem  = xlamde * dz<a name='2368'>
                 tem1 = 0.5 * xlamdd * dz<a name='2369'>
              else<a name='2370'>
                 tem  = xlamde * dz<a name='2371'>
                 tem1 = 0.5 * (xlamd(i)+xlamdd) * dz<a name='2372'>
              endif<a name='2373'>
              factor = 1. + tem - tem1<a name='2374'>
              hcdo(i,k) = ((1.-tem1)*hcdo(i,k+1)+tem*0.5*                &amp;<a name='2375'>
     &amp;                     (heo(i,k)+heo(i,k+1)))/factor<a name='2376'>
          endif<a name='2377'>
        enddo<a name='2378'>
      enddo<a name='2379'>
<font color=#447700>!cj<a name='2380'></font>
      do k = km1, 1, -1<a name='2381'>
        do i = 1, im<a name='2382'>
          if (cnvflg(i) .and. k .lt. jmin(i)) then<a name='2383'>
              dq = qeso(i,k)<a name='2384'>
              dt = to(i,k)<a name='2385'>
              gamma    = el2orc * dq / dt**2<a name='2386'>
              dh       = hcdo(i,k) - heso(i,k)<a name='2387'>
              qrcd(i,k)=dq+(1./hvap)*(gamma/(1.+gamma))*dh<a name='2388'>
<font color=#447700>!             detad    = etad(i,k+1) - etad(i,k)<a name='2389'></font>
<font color=#447700>!cj<a name='2390'></font>
              dz = zi(i,k+1) - zi(i,k)<a name='2391'>
              if(k.ge.kbcon(i)) then<a name='2392'>
                 tem  = xlamde * dz<a name='2393'>
                 tem1 = 0.5 * xlamdd * dz<a name='2394'>
              else<a name='2395'>
                 tem  = xlamde * dz<a name='2396'>
                 tem1 = 0.5 * (xlamd(i)+xlamdd) * dz<a name='2397'>
              endif<a name='2398'>
              factor = 1. + tem - tem1<a name='2399'>
              qcdo(i,k) = ((1.-tem1)*qrcd(i,k+1)+tem*0.5*             &amp;<a name='2400'>
     &amp;                     (qo(i,k)+qo(i,k+1)))/factor<a name='2401'>
<font color=#447700>!cj<a name='2402'></font>
<font color=#447700>!             xpwd     = etad(i,k+1) * qcdo(i,k+1) -<a name='2403'></font>
<font color=#447700>!    &amp;                   etad(i,k) * qrcd(i,k)<a name='2404'></font>
<font color=#447700>!             xpwd     = xpwd - detad *<a name='2405'></font>
<font color=#447700>!    &amp;                 .5 * (qrcd(i,k) + qrcd(i,k+1))<a name='2406'></font>
<font color=#447700>!cj<a name='2407'></font>
              xpwd     = etad(i,k) * (qcdo(i,k) - qrcd(i,k))<a name='2408'>
              xpwev(i) = xpwev(i) + xpwd<a name='2409'>
          endif<a name='2410'>
        enddo<a name='2411'>
      enddo<a name='2412'>
<font color=#447700>!c<a name='2413'></font>
      do i = 1, im<a name='2414'>
        edtmax = edtmaxl<a name='2415'>
        if(islimsk(i) == 0) edtmax = edtmaxs<a name='2416'>
        if(cnvflg(i)) then<a name='2417'>
          if(xpwev(i).ge.0.) then<a name='2418'>
            edtx(i) = 0.<a name='2419'>
          else<a name='2420'>
            edtx(i) = -edtx(i) * xpwav(i) / xpwev(i)<a name='2421'>
            edtx(i) = min(edtx(i),edtmax)<a name='2422'>
          endif<a name='2423'>
        endif<a name='2424'>
      enddo<a name='2425'>
<font color=#447700>!c<a name='2426'></font>
<font color=#447700>!c<a name='2427'></font>
<font color=#447700>!c--- downdraft cloudwork functions<a name='2428'></font>
<font color=#447700>!c<a name='2429'></font>
<font color=#447700>!c<a name='2430'></font>
      do k = km1, 1, -1<a name='2431'>
        do i = 1, im<a name='2432'>
          if (cnvflg(i) .and. k.lt.jmin(i)) then<a name='2433'>
              gamma = el2orc * qeso(i,k) / to(i,k)**2<a name='2434'>
              dhh=hcdo(i,k)<a name='2435'>
              dt= to(i,k)<a name='2436'>
              dg= gamma<a name='2437'>
              dh= heso(i,k)<a name='2438'>
              dz=-1.*(zo(i,k+1)-zo(i,k))<a name='2439'>
<font color=#447700>!             xaa0(i)=xaa0(i)+edtx(i)*dz*etad(i,k)<a name='2440'></font>
              xaa0(i)=xaa0(i)+edtx(i)*dz                                    &amp;<a name='2441'>
     &amp;                *(g/(cp*dt))*((dhh-dh)/(1.+dg))                       &amp;<a name='2442'>
     &amp;                *(1.+delta*cp*dg*dt/hvap)<a name='2443'>
              val=0.<a name='2444'>
<font color=#447700>!             xaa0(i)=xaa0(i)+edtx(i)*dz*etad(i,k)<a name='2445'></font>
              xaa0(i)=xaa0(i)+edtx(i)*dz                                       &amp;<a name='2446'>
     &amp;                *g*delta*max(val,(qeso(i,k)-qo(i,k)))<a name='2447'>
          endif<a name='2448'>
        enddo<a name='2449'>
      enddo<a name='2450'>
<font color=#447700>!c<a name='2451'></font>
<font color=#447700>!c  calculate critical cloud work function<a name='2452'></font>
<font color=#447700>!c<a name='2453'></font>
<font color=#447700>!     do i = 1, im<a name='2454'></font>
<font color=#447700>!       if(cnvflg(i)) then<a name='2455'></font>
<font color=#447700>!         if(pfld(i,ktcon(i)).lt.pcrit(15))then<a name='2456'></font>
<font color=#447700>!           acrt(i)=acrit(15)*(975.-pfld(i,ktcon(i)))<a name='2457'></font>
<font color=#447700>!    &amp;              /(975.-pcrit(15))<a name='2458'></font>
<font color=#447700>!         else if(pfld(i,ktcon(i)).gt.pcrit(1))then<a name='2459'></font>
<font color=#447700>!           acrt(i)=acrit(1)<a name='2460'></font>
<font color=#447700>!         else<a name='2461'></font>
<font color=#447700>!           k =  int((850. - pfld(i,ktcon(i)))/50.) + 2<a name='2462'></font>
<font color=#447700>!           k = min(k,15)<a name='2463'></font>
<font color=#447700>!           k = max(k,2)<a name='2464'></font>
<font color=#447700>!           acrt(i)=acrit(k)+(acrit(k-1)-acrit(k))*<a name='2465'></font>
<font color=#447700>!    &amp;           (pfld(i,ktcon(i))-pcrit(k))/(pcrit(k-1)-pcrit(k))<a name='2466'></font>
<font color=#447700>!         endif<a name='2467'></font>
<font color=#447700>!       endif<a name='2468'></font>
<font color=#447700>!     enddo<a name='2469'></font>
      do i = 1, im<a name='2470'>
        if(cnvflg(i)) then<a name='2471'>
<font color=#447700>!         if(islimsk(i) == 1) then<a name='2472'></font>
<font color=#447700>!           w1 = w1l<a name='2473'></font>
<font color=#447700>!           w2 = w2l<a name='2474'></font>
<font color=#447700>!           w3 = w3l<a name='2475'></font>
<font color=#447700>!           w4 = w4l<a name='2476'></font>
<font color=#447700>!         else<a name='2477'></font>
<font color=#447700>!           w1 = w1s<a name='2478'></font>
<font color=#447700>!           w2 = w2s<a name='2479'></font>
<font color=#447700>!           w3 = w3s<a name='2480'></font>
<font color=#447700>!           w4 = w4s<a name='2481'></font>
<font color=#447700>!         endif<a name='2482'></font>
<font color=#447700>!c<a name='2483'></font>
<font color=#447700>!c  modify critical cloud workfunction by cloud base vertical velocity<a name='2484'></font>
<font color=#447700>!c<a name='2485'></font>
<font color=#447700>!         if(pdot(i).le.w4) then<a name='2486'></font>
<font color=#447700>!           acrtfct(i) = (pdot(i) - w4) / (w3 - w4)<a name='2487'></font>
<font color=#447700>!         elseif(pdot(i).ge.-w4) then<a name='2488'></font>
<font color=#447700>!           acrtfct(i) = - (pdot(i) + w4) / (w4 - w3)<a name='2489'></font>
<font color=#447700>!         else<a name='2490'></font>
<font color=#447700>!           acrtfct(i) = 0.<a name='2491'></font>
<font color=#447700>!         endif<a name='2492'></font>
<font color=#447700>!         val1    =            -1.<a name='2493'></font>
<font color=#447700>!         acrtfct(i) = max(acrtfct(i),val1)<a name='2494'></font>
<font color=#447700>!         val2    =             1.<a name='2495'></font>
<font color=#447700>!         acrtfct(i) = min(acrtfct(i),val2)<a name='2496'></font>
<font color=#447700>!         acrtfct(i) = 1. - acrtfct(i)<a name='2497'></font>
<font color=#447700>!c<a name='2498'></font>
<font color=#447700>!c  modify acrtfct(i) by colume mean rh if rhbar(i) is greater than 80 percent<a name='2499'></font>
<font color=#447700>!c<a name='2500'></font>
<font color=#447700>!c         if(rhbar(i).ge..8) then<a name='2501'></font>
<font color=#447700>!c           acrtfct(i) = acrtfct(i) * (.9 - min(rhbar(i),.9)) * 10.<a name='2502'></font>
<font color=#447700>!c         endif<a name='2503'></font>
<font color=#447700>!c<a name='2504'></font>
<font color=#447700>!c  modify adjustment time scale by cloud base vertical velocity<a name='2505'></font>
<font color=#447700>!c<a name='2506'></font>
<font color=#447700>!         dtconv(i) = dt2 + max((1800. - dt2),0.) *<a name='2507'></font>
<font color=#447700>!    &amp;                (pdot(i) - w2) / (w1 - w2)<a name='2508'></font>
<font color=#447700>!c         dtconv(i) = max(dtconv(i), dt2)<a name='2509'></font>
<font color=#447700>!c         dtconv(i) = 1800. * (pdot(i) - w2) / (w1 - w2)<a name='2510'></font>
<font color=#447700>!<a name='2511'></font>
          tem = zi(i,ktcon1(i)) - zi(i,kbcon1(i))<a name='2512'>
<font color=#447700>!!        tem = zi(i,ktcon(i)) - zi(i,kb(i))<a name='2513'></font>
          dtconv(i) = tfac * tem / wc(i)<a name='2514'>
          dtconv(i) = max(dtconv(i),dtmin)<a name='2515'>
          dtconv(i) = min(dtconv(i),dtmax)<a name='2516'>
<font color=#447700>!         dtconv(i) = max(1800., dt2)<a name='2517'></font>
<font color=#447700>!c<a name='2518'></font>
        endif<a name='2519'>
      enddo<a name='2520'>
<font color=#447700>!c<a name='2521'></font>
<font color=#447700>!c--- large scale forcing<a name='2522'></font>
<font color=#447700>!c<a name='2523'></font>
      do i= 1, im<a name='2524'>
        if(cnvflg(i)) then<a name='2525'>
<font color=#447700>!         fld(i)=(aa1(i)-acrt(i)* acrtfct(i))/dtconv(i)<a name='2526'></font>
          fld(i)=aa1(i)/dtconv(i)<a name='2527'>
          if(fld(i).le.0.) cnvflg(i) = .false.<a name='2528'>
        endif<a name='2529'>
        if(cnvflg(i)) then<a name='2530'>
<font color=#447700>!c         xaa0(i) = max(xaa0(i),0.)<a name='2531'></font>
          xk(i) = (xaa0(i) - aa1(i)) / mbdt(i)<a name='2532'>
          if(xk(i).ge.0.) cnvflg(i) = .false.<a name='2533'>
        endif<a name='2534'>
<font color=#447700>!c<a name='2535'></font>
<font color=#447700>!c--- kernel, cloud base mass flux<a name='2536'></font>
<font color=#447700>!c<a name='2537'></font>
        if(cnvflg(i)) then<a name='2538'>
          xmb(i) = -fld(i) / xk(i)<a name='2539'>
<font color=#447700>!         xmb(i) = min(xmb(i),xmbmax(i))<a name='2540'></font>
        endif<a name='2541'>
      enddo<a name='2542'>
<font color=#447700>!!<a name='2543'></font>
      totflg = .true.<a name='2544'>
      do i=1,im<a name='2545'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='2546'>
      enddo<a name='2547'>
      if(totflg) return<a name='2548'>
<font color=#447700>!!<a name='2549'></font>
<font color=#447700>!<a name='2550'></font>
<font color=#447700>!--- compute updraft fraction based on Arakawa &amp; Wu (2013)<a name='2551'></font>
<font color=#447700>!    using values at cloud base<a name='2552'></font>
<font color=#447700>!<a name='2553'></font>
<font color=#447700>!  grid-scale vertical velocity at cloud base<a name='2554'></font>
<font color=#447700>!<a name='2555'></font>
      ptem = -0.01 * rd / g <a name='2556'>
      do i = 1, im<a name='2557'>
        wbar(i) = 0.<a name='2558'>
        if (cnvflg(i)) then<a name='2559'>
          k = kbcon(i)<a name='2560'>
          tem  = dot(i,k) * to(i,k) / po(i,k)<a name='2561'>
          wbar(i) = ptem * tem <a name='2562'>
        endif<a name='2563'>
      enddo<a name='2564'>
<font color=#447700>!<a name='2565'></font>
<font color=#447700>!  estimate updraft velocity at cloud base using cloud base mass flux<a name='2566'></font>
<font color=#447700>!<a name='2567'></font>
      ptem = 0.01 * rd  <a name='2568'>
      do i = 1, im<a name='2569'>
        wcxmb(i) = 0.<a name='2570'>
        if (cnvflg(i)) then<a name='2571'>
          k = kbcon(i)<a name='2572'>
          tem  = xmb(i) * ptem * to(i,k)  /  po(i,k)<a name='2573'>
          wcxmb(i) = tem / 0.1<a name='2574'>
<font color=#447700>!         wcxmb(i) = tem / 0.03<a name='2575'></font>
        endif<a name='2576'>
      enddo<a name='2577'>
<font color=#447700>!<a name='2578'></font>
<font color=#447700>!  compute updraft fraction<a name='2579'></font>
<font color=#447700>!<a name='2580'></font>
      ptem = 0.01 * rd<a name='2581'>
      do i = 1, im<a name='2582'>
        xmbeta(i) = 0.<a name='2583'>
        if (cnvflg(i)) then<a name='2584'>
          k = kbcon(i)<a name='2585'>
          tem  = to(i,k) / po(i,k)<a name='2586'>
          xmbeta(i) = xmb(i) * ptem * tem<a name='2587'>
        endif<a name='2588'>
      enddo<a name='2589'>
      do i = 1, im<a name='2590'>
        if (cnvflg(i)) then<a name='2591'>
          tem = wcxmb(i) - wbar(i)<a name='2592'>
          val = 1.e-8<a name='2593'>
          tem = max(tem, val)<a name='2594'>
          awlam(i) = xmbeta(i) / tem<a name='2595'>
<font color=#447700>!         awlam(i) = min(awlam(i), 100.)<a name='2596'></font>
        endif<a name='2597'>
      enddo<a name='2598'>
<font color=#447700>!<a name='2599'></font>
      do i = 1, im<a name='2600'>
        if(cnvflg(i)) then<a name='2601'>
          sigmaw(i) = .001<a name='2602'>
          flg(i) = .true.<a name='2603'>
        endif<a name='2604'>
      enddo<a name='2605'>
<font color=#447700>!<a name='2606'></font>
      do i = 1, im<a name='2607'>
        if(cnvflg(i)) then<a name='2608'>
          do n = 1, itsig<a name='2609'>
            if(flg(i)) then<a name='2610'>
              ptem = sigmaw(i)<a name='2611'>
              tem = 1. - ptem<a name='2612'>
              fs0 = awlam(i) * (tem**3.) - ptem<a name='2613'>
              fp1 = -3. * awlam(i) * (tem**2.) - 1.<a name='2614'>
              fp1 = min(fp1, -1.e-3_kind_phys)<a name='2615'>
              sigmaw(i) = ptem - fs0 / fp1<a name='2616'>
              tem1 = abs(sigmaw(i) - ptem)<a name='2617'>
              if(tem1 &lt; .01) then<a name='2618'>
                flg(i)   = .false.<a name='2619'>
              endif<a name='2620'>
            endif<a name='2621'>
          enddo<a name='2622'>
          sigmaw(i) = max(sigmaw(i), 0.001_kind_phys)<a name='2623'>
          sigmaw(i) = min(sigmaw(i), 0.999_kind_phys)<a name='2624'>
        endif<a name='2625'>
      enddo<a name='2626'>
<font color=#447700>!<a name='2627'></font>
<font color=#447700>!--- compute updraft fraction based on Grell &amp; Freitas (2014)<a name='2628'></font>
<font color=#447700>!<a name='2629'></font>
      do i = 1, im<a name='2630'>
        if(cnvflg(i)) then<a name='2631'>
          sigmagf(i) = gfudarea / garea(i)<a name='2632'>
          sigmagf(i) = max(sigmagf(i), 0.001_kind_phys)<a name='2633'>
          sigmagf(i) = min(sigmagf(i), 0.7_kind_phys)<a name='2634'>
        endif<a name='2635'>
      enddo<a name='2636'>
<a name='2637'>
<font color=#447700>!--- modified Grell &amp; Freitas' (2014) updraft fraction which uses<a name='2638'></font>
<font color=#447700>!     actual entrainment rate at cloud base<a name='2639'></font>
<font color=#447700>!<a name='2640'></font>
      do i = 1, im<a name='2641'>
        if(cnvflg(i)) then<a name='2642'>
<font color=#447700>!          k = kbcon(i)<a name='2643'></font>
<font color=#447700>!          tem = 0.2 / max(xlamue(i,k), 3.e-5)<a name='2644'></font>
          tem = min(max(xlamx(i), 7.e-5_kind_phys), 3.e-4_kind_phys)<a name='2645'>
             tmpout9(i)=tem<a name='2646'>
          tem = 0.2 / tem<a name='2647'>
          tem1 = 3.14 * tem * tem<a name='2648'>
          sigmagfm(i) = tem1 / garea(i)<a name='2649'>
          sigmagfm(i) = max(sigmagfm(i), 0.001_kind_phys)<a name='2650'>
          sigmagfm(i) = min(sigmagfm(i), 0.999_kind_phys)<a name='2651'>
<a name='2652'>
        endif<a name='2653'>
      enddo<a name='2654'>
<font color=#447700>!<a name='2655'></font>
<a name='2656'>
<font color=#447700>!<a name='2657'></font>
<font color=#447700>!--- compute scale-aware function based on Arakawa &amp; Wu (2013)<a name='2658'></font>
<font color=#447700>!  using combination of updraft fractions from both <a name='2659'></font>
<font color=#447700>!   Arakawa &amp; Wu (2013) and Grell &amp; Freitas (2014)<a name='2660'></font>
<font color=#447700>!<a name='2661'></font>
      do i = 1, im<a name='2662'>
        if(cnvflg(i)) then<a name='2663'>
          tem = 0.001 * sqrt(garea(i))<a name='2664'>
          if (tem &lt; 25.) then<a name='2665'>
<font color=#447700>!           scaldfunc(i) = (1.-sigmaw(i)) * (1.-sigmaw(i))   ! Arakawa &amp; Wu (2013)<a name='2666'></font>
<font color=#447700>!           scaldfunc(i) = (1.-sigmagf(i)) * (1.-sigmagf(i)) ! Grell &amp; Freitas (2014)<a name='2667'></font>
            scaldfunc(i) = (1.-sigmagfm(i)) * (1.-sigmagfm(i)) <font color=#447700>! modified Grell &amp; Freitas(2014)<a name='2668'></font>
       <a name='2669'>
<font color=#447700>!            scaldfunc(i) = (1.-sigmaw(i)) * (1.-sigmagf(i))  ! AW &amp; GF<a name='2670'></font>
            scaldfunc(i) = max(min(scaldfunc(i), 1.0_kind_phys), 0._kind_phys)<a name='2671'>
             sigmuout(i)=sigmagfm(i)<a name='2672'>
          else<a name='2673'>
            scaldfunc(i) = 1.0<a name='2674'>
          endif<a name='2675'>
          xmb(i) = xmb(i) * scaldfunc(i)<a name='2676'>
          xmb(i) = min(xmb(i),xmbmax(i))<a name='2677'>
        endif<a name='2678'>
      enddo<a name='2679'>
<font color=#447700>!c<a name='2680'></font>
<font color=#447700>!c  restore to,qo,uo,vo to t1,q1,u1,v1 in case convection stops<a name='2681'></font>
<font color=#447700>!c<a name='2682'></font>
      do k = 1, km<a name='2683'>
        do i = 1, im<a name='2684'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='2685'>
            to(i,k) = t1(i,k)<a name='2686'>
            qo(i,k) = q1(i,k)<a name='2687'>
            uo(i,k) = u1(i,k)<a name='2688'>
            vo(i,k) = v1(i,k)<a name='2689'>
            qeso(i,k) = 0.01 * fpvs(t1(i,k))      <font color=#447700>! fpvs is in pa<a name='2690'></font>
            qeso(i,k) = eps * qeso(i,k) / (pfld(i,k) + epsm1*qeso(i,k))<a name='2691'>
            val     =             1.e-8<a name='2692'>
            qeso(i,k) = max(qeso(i,k), val )<a name='2693'>
          endif<a name='2694'>
        enddo<a name='2695'>
      enddo<a name='2696'>
<font color=#447700>!c!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2697'></font>
<font color=#447700>!c<a name='2698'></font>
<font color=#447700>!c--- feedback: simply the changes from the cloud with unit mass flux<a name='2699'></font>
<font color=#447700>!c---           multiplied by  the mass flux necessary to keep the<a name='2700'></font>
<font color=#447700>!c---           equilibrium with the larger-scale.<a name='2701'></font>
<font color=#447700>!c<a name='2702'></font>
      do i = 1, im<a name='2703'>
        delhbar(i) = 0.<a name='2704'>
        delqbar(i) = 0.<a name='2705'>
        deltbar(i) = 0.<a name='2706'>
        delubar(i) = 0.<a name='2707'>
        delvbar(i) = 0.<a name='2708'>
        qcond(i) = 0.<a name='2709'>
      enddo<a name='2710'>
      do k = 1, km<a name='2711'>
        do i = 1, im<a name='2712'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='2713'>
            if(k.le.ktcon(i)) then<a name='2714'>
              dellat = (dellah(i,k) - hvap * dellaq(i,k)) / cp<a name='2715'>
              t1(i,k) = t1(i,k) + dellat * xmb(i) * dt2<a name='2716'>
              q1(i,k) = q1(i,k) + dellaq(i,k) * xmb(i) * dt2<a name='2717'>
<font color=#447700>!             tem = 1./rcs(i)<a name='2718'></font>
<font color=#447700>!             u1(i,k) = u1(i,k) + dellau(i,k) * xmb(i) * dt2 * tem<a name='2719'></font>
<font color=#447700>!             v1(i,k) = v1(i,k) + dellav(i,k) * xmb(i) * dt2 * tem<a name='2720'></font>
              u1(i,k) = u1(i,k) + dellau(i,k) * xmb(i) * dt2<a name='2721'>
              v1(i,k) = v1(i,k) + dellav(i,k) * xmb(i) * dt2<a name='2722'>
              dp = 1000. * del(i,k)<a name='2723'>
              delhbar(i) = delhbar(i) + dellah(i,k)*xmb(i)*dp/g<a name='2724'>
              delqbar(i) = delqbar(i) + dellaq(i,k)*xmb(i)*dp/g<a name='2725'>
              deltbar(i) = deltbar(i) + dellat*xmb(i)*dp/g<a name='2726'>
              delubar(i) = delubar(i) + dellau(i,k)*xmb(i)*dp/g<a name='2727'>
              delvbar(i) = delvbar(i) + dellav(i,k)*xmb(i)*dp/g<a name='2728'>
            endif<a name='2729'>
          endif<a name='2730'>
        enddo<a name='2731'>
      enddo<a name='2732'>
      do k = 1, km<a name='2733'>
        do i = 1, im<a name='2734'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='2735'>
            if(k.le.ktcon(i)) then<a name='2736'>
              qeso(i,k) = 0.01 * fpvs(t1(i,k))      <font color=#447700>! fpvs is in pa<a name='2737'></font>
              qeso(i,k) = eps * qeso(i,k)/(pfld(i,k) + epsm1*qeso(i,k))<a name='2738'>
              val     =             1.e-8<a name='2739'>
              qeso(i,k) = max(qeso(i,k), val )<a name='2740'>
            endif<a name='2741'>
          endif<a name='2742'>
        enddo<a name='2743'>
      enddo<a name='2744'>
<font color=#447700>!c<a name='2745'></font>
      do i = 1, im<a name='2746'>
        rntot(i) = 0.<a name='2747'>
        delqev(i) = 0.<a name='2748'>
        delq2(i) = 0.<a name='2749'>
        flg(i) = cnvflg(i)<a name='2750'>
      enddo<a name='2751'>
      do k = km, 1, -1<a name='2752'>
        do i = 1, im<a name='2753'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='2754'>
            if(k.lt.ktcon(i)) then<a name='2755'>
              aup = 1.<a name='2756'>
              if(k.le.kb(i)) aup = 0.<a name='2757'>
              adw = 1.<a name='2758'>
              if(k.ge.jmin(i)) adw = 0.<a name='2759'>
              rain =  aup * pwo(i,k) + adw * edto(i) * pwdo(i,k)<a name='2760'>
              rntot(i) = rntot(i) + rain * xmb(i) * .001 * dt2<a name='2761'>
            endif<a name='2762'>
          endif<a name='2763'>
        enddo<a name='2764'>
      enddo<a name='2765'>
      do k = km, 1, -1<a name='2766'>
        do i = 1, im<a name='2767'>
          if (k .le. kmax(i)) then<a name='2768'>
            deltv(i) = 0.<a name='2769'>
            delq(i) = 0.<a name='2770'>
            qevap(i) = 0.<a name='2771'>
            if(cnvflg(i).and.k.lt.ktcon(i)) then<a name='2772'>
              aup = 1.<a name='2773'>
              if(k.le.kb(i)) aup = 0.<a name='2774'>
              adw = 1.<a name='2775'>
              if(k.ge.jmin(i)) adw = 0.<a name='2776'>
              rain =  aup * pwo(i,k) + adw * edto(i) * pwdo(i,k)<a name='2777'>
              rn(i) = rn(i) + rain * xmb(i) * .001 * dt2<a name='2778'>
            endif<a name='2779'>
            if(flg(i).and.k.lt.ktcon(i)) then<a name='2780'>
              evef = edt(i) * evfact<a name='2781'>
              if(islimsk(i) == 1) evef=edt(i) * evfactl<a name='2782'>
<font color=#447700>!             if(islimsk(i) == 1) evef=.07<a name='2783'></font>
<font color=#447700>!c             if(islimsk(i) == 1) evef = 0.<a name='2784'></font>
              qcond(i) = evef * (q1(i,k) - qeso(i,k))                   &amp;<a name='2785'>
     &amp;                 / (1. + el2orc * qeso(i,k) / t1(i,k)**2)<a name='2786'>
              dp = 1000. * del(i,k)<a name='2787'>
              if(rn(i).gt.0..and.qcond(i).lt.0.) then<a name='2788'>
                qevap(i) = -qcond(i) * (1.-exp(-.32*sqrt(dt2*rn(i))))<a name='2789'>
                qevap(i) = min(qevap(i), rn(i)*1000.*g/dp)<a name='2790'>
                delq2(i) = delqev(i) + .001 * qevap(i) * dp / g<a name='2791'>
              endif<a name='2792'>
              if(rn(i).gt.0..and.qcond(i).lt.0..and.                      &amp;<a name='2793'>
     &amp;           delq2(i).gt.rntot(i)) then<a name='2794'>
                qevap(i) = 1000.* g * (rntot(i) - delqev(i)) / dp<a name='2795'>
                flg(i) = .false.<a name='2796'>
              endif<a name='2797'>
              if(rn(i).gt.0..and.qevap(i).gt.0.) then<a name='2798'>
                q1(i,k) = q1(i,k) + qevap(i)<a name='2799'>
                t1(i,k) = t1(i,k) - elocp * qevap(i)<a name='2800'>
                rn(i) = rn(i) - .001 * qevap(i) * dp / g<a name='2801'>
                deltv(i) = - elocp*qevap(i)/dt2<a name='2802'>
                delq(i) =  + qevap(i)/dt2<a name='2803'>
                delqev(i) = delqev(i) + .001*dp*qevap(i)/g<a name='2804'>
              endif<a name='2805'>
              delqbar(i) = delqbar(i) + delq(i)*dp/g<a name='2806'>
              deltbar(i) = deltbar(i) + deltv(i)*dp/g<a name='2807'>
            endif<a name='2808'>
          endif<a name='2809'>
        enddo<a name='2810'>
      enddo<a name='2811'>
<font color=#447700>!cj<a name='2812'></font>
<font color=#447700>!     do i = 1, im<a name='2813'></font>
<font color=#447700>!     if(me.eq.31.and.cnvflg(i)) then<a name='2814'></font>
<font color=#447700>!     if(cnvflg(i)) then<a name='2815'></font>
<font color=#447700>!       print *, ' deep delhbar, delqbar, deltbar = ',<a name='2816'></font>
<font color=#447700>!    &amp;             delhbar(i),hvap*delqbar(i),cp*deltbar(i)<a name='2817'></font>
<font color=#447700>!       print *, ' deep delubar, delvbar = ',delubar(i),delvbar(i)<a name='2818'></font>
<font color=#447700>!       print *, ' precip =', hvap*rn(i)*1000./dt2<a name='2819'></font>
<font color=#447700>!       print*,'pdif= ',pfld(i,kbcon(i))-pfld(i,ktcon(i))<a name='2820'></font>
<font color=#447700>!     endif<a name='2821'></font>
<font color=#447700>!     enddo<a name='2822'></font>
<font color=#447700>!c<a name='2823'></font>
<font color=#447700>!c  precipitation rate converted to actual precip<a name='2824'></font>
<font color=#447700>!c  in unit of m instead of kg<a name='2825'></font>
<font color=#447700>!c<a name='2826'></font>
      do i = 1, im<a name='2827'>
        if(cnvflg(i)) then<a name='2828'>
<font color=#447700>!c<a name='2829'></font>
<font color=#447700>!c  in the event of upper level rain evaporation and lower level downdraft<a name='2830'></font>
<font color=#447700>!c    moistening, rn can become negative, in this case, we back out of the<a name='2831'></font>
<font color=#447700>!c    heating and the moistening<a name='2832'></font>
<font color=#447700>!c<a name='2833'></font>
          if(rn(i).lt.0..and..not.flg(i)) rn(i) = 0.<a name='2834'>
          if(rn(i).le.0.) then<a name='2835'>
            rn(i) = 0.<a name='2836'>
          else<a name='2837'>
            ktop(i) = ktcon(i)<a name='2838'>
            kbot(i) = kbcon(i)<a name='2839'>
            kcnv(i) = 1<a name='2840'>
            cldwrk(i) = aa1(i)<a name='2841'>
          endif<a name='2842'>
        endif<a name='2843'>
      enddo<a name='2844'>
<font color=#447700>!c<a name='2845'></font>
<font color=#447700>!c  convective cloud water<a name='2846'></font>
<font color=#447700>!c<a name='2847'></font>
      do k = 1, km<a name='2848'>
        do i = 1, im<a name='2849'>
          if (cnvflg(i) .and. rn(i).gt.0.) then<a name='2850'>
            if (k.ge.kbcon(i).and.k.lt.ktcon(i)) then<a name='2851'>
              cnvw(i,k) = cnvwt(i,k) * xmb(i) * dt2<a name='2852'>
            endif<a name='2853'>
          endif<a name='2854'>
        enddo<a name='2855'>
      enddo<a name='2856'>
<font color=#447700>!c<a name='2857'></font>
<font color=#447700>!c  convective cloud cover<a name='2858'></font>
<font color=#447700>!c<a name='2859'></font>
      do k = 1, km<a name='2860'>
        do i = 1, im<a name='2861'>
          if (cnvflg(i) .and. rn(i).gt.0.) then<a name='2862'>
            if (k.ge.kbcon(i).and.k.lt.ktcon(i)) then<a name='2863'>
              cnvc(i,k) = 0.04 * log(1. + 675. * eta(i,k) * xmb(i)) <a name='2864'>
              cnvc(i,k) = min(cnvc(i,k), 0.6_kind_phys)<a name='2865'>
              cnvc(i,k) = max(cnvc(i,k), 0.0_kind_phys)<a name='2866'>
            endif<a name='2867'>
          endif<a name='2868'>
        enddo<a name='2869'>
      enddo<a name='2870'>
<a name='2871'>
<font color=#447700>!c<a name='2872'></font>
<font color=#447700>!c  cloud water<a name='2873'></font>
<font color=#447700>!c<a name='2874'></font>
      if (ncloud.gt.0) then<a name='2875'>
<font color=#447700>!<a name='2876'></font>
      do k = 1, km<a name='2877'>
        do i = 1, im<a name='2878'>
          if (cnvflg(i) .and. rn(i).gt.0.) then<a name='2879'>
<font color=#447700>!            if (k.gt.kb(i).and.k.le.ktcon(i)) then<a name='2880'></font>
             if (k.ge.kbcon(i).and.k.le.ktcon(i)) then<a name='2881'>
              tem  = dellal(i,k) * xmb(i) * dt2<a name='2882'>
              tem1 = max(0.0_kind_phys, min(1.0_kind_phys, (tcr-t1(i,k))*tcrf))<a name='2883'>
              if (ql(i,k,2) .gt. -999.0) then<a name='2884'>
                ql(i,k,1) = ql(i,k,1) + tem * tem1            <font color=#447700>! ice<a name='2885'></font>
                ql(i,k,2) = ql(i,k,2) + tem *(1.0-tem1)       <font color=#447700>! water<a name='2886'></font>
              else<a name='2887'>
                ql(i,k,1) = ql(i,k,1) + tem<a name='2888'>
              endif<a name='2889'>
            endif<a name='2890'>
          endif<a name='2891'>
        enddo<a name='2892'>
      enddo<a name='2893'>
<font color=#447700>!<a name='2894'></font>
      endif<a name='2895'>
<font color=#447700>!c<a name='2896'></font>
      do k = 1, km<a name='2897'>
        do i = 1, im<a name='2898'>
          if(cnvflg(i).and.rn(i).le.0.) then<a name='2899'>
            if (k .le. kmax(i)) then<a name='2900'>
              t1(i,k) = to(i,k)<a name='2901'>
              q1(i,k) = qo(i,k)<a name='2902'>
              u1(i,k) = uo(i,k)<a name='2903'>
              v1(i,k) = vo(i,k)<a name='2904'>
            endif<a name='2905'>
          endif<a name='2906'>
        enddo<a name='2907'>
      enddo<a name='2908'>
<font color=#447700>!<a name='2909'></font>
<font color=#447700>! hchuang code change<a name='2910'></font>
<font color=#447700>!<a name='2911'></font>
      do k = 1, km<a name='2912'>
        do i = 1, im<a name='2913'>
          if(cnvflg(i).and.rn(i).gt.0.) then<a name='2914'>
            if(k.ge.kb(i) .and. k.lt.ktop(i)) then<a name='2915'>
              ud_mf(i,k) = eta(i,k) * xmb(i) * dt2<a name='2916'>
            endif<a name='2917'>
          endif<a name='2918'>
        enddo<a name='2919'>
      enddo<a name='2920'>
      do i = 1, im<a name='2921'>
        if(cnvflg(i).and.rn(i).gt.0.) then<a name='2922'>
           k = ktop(i)-1<a name='2923'>
           dt_mf(i,k) = ud_mf(i,k)<a name='2924'>
        endif<a name='2925'>
      enddo<a name='2926'>
      do k = 1, km<a name='2927'>
        do i = 1, im<a name='2928'>
          if(cnvflg(i).and.rn(i).gt.0.) then<a name='2929'>
            if(k.ge.1 .and. k.le.jmin(i)) then<a name='2930'>
              dd_mf(i,k) = edto(i) * etad(i,k) * xmb(i) * dt2<a name='2931'>
            endif<a name='2932'>
          endif<a name='2933'>
        enddo<a name='2934'>
      enddo<a name='2935'>
<font color=#447700>!!<a name='2936'></font>
      return<a name='2937'>
      end subroutine scale_sascnvn<a name='2938'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2939'></font>
<font color=#447700>!! scale aware shallow sas<a name='2940'></font>
<a name='2941'>
<font color=#447700>!     subroutine shalcnv(im,ix,km,jcap,delt,delp,prslp,psp,phil,ql,<a name='2942'></font>
<A NAME='SCALE_SHALCNV'><A href='../../html_code/phys/module_cu_scalesas.F.html#SCALE_SHALCNV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2943'>
      <font color=#993300>subroutine </font><font color=#cc0000>scale_shalcnv</font>(im,ix,km,delt,delp,prslp,psp,phil,ql,      &amp; <A href='../../call_to/SCALE_SHALCNV.html' TARGET='index'>1</A>,<A href='../../call_from/SCALE_SHALCNV.html' TARGET='index'>3</A><a name='2944'>
     &amp;     q1,t1,u1,v1,rn,kbot,ktop,kcnv,islimsk,garea,                   &amp;<a name='2945'>
     &amp;     dot,ncloud,hpbl,heat,evap,ud_mf,dt_mf,cnvw,cnvc, sigmuout,scaldfunc)<a name='2946'>
<font color=#447700>!     &amp;     dot,ncloud,hpbl,heat,evap,ud_mf,dt_mf,cnvw,cnvc, sigmagfm)<a name='2947'></font>
<font color=#447700>!    &amp;     q1,t1,u1,v1,rcs,rn,kbot,ktop,kcnv,islimsk,<a name='2948'></font>
<font color=#447700>!    &amp;     dot,ncloud,hpbl,heat,evap,ud_mf,dt_mf,me)<a name='2949'></font>
<font color=#447700>!<a name='2950'></font>
<a name='2951'>
      use <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_machine</A><A href='../../html_code/phys/module_cu_scalesas.F.html#SCALE_SHALCNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_25"> , only : kind_phys<a name='2952'>
      use <A href='../../html_code/phys/module_gfs_funcphys.F.html#MODULE_GFS_FUNCPHYS'>MODULE_GFS_funcphys</A><A href='../../html_code/phys/module_cu_scalesas.F.html#SCALE_SHALCNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_FUNCPHYS_11"> , only : fpvs<a name='2953'>
      use <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_physcons</A><A href='../../html_code/phys/module_cu_scalesas.F.html#SCALE_SHALCNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_17">, grav =&gt; con_g, cp =&gt; con_cp, hvap =&gt; con_hvap   &amp; <a name='2954'>
<font color=#447700>!      use machine , only : kind_phys<a name='2955'></font>
<font color=#447700>!      use funcphys , only : fpvs<a name='2956'></font>
<font color=#447700>!      use physcons, grav =&gt; con_g, cp =&gt; con_cp, hvap =&gt; con_hvap<a name='2957'></font>
     &amp;,             rv =&gt; con_rv, fv =&gt; con_fvirt, t0c =&gt; con_t0c              &amp;<a name='2958'>
     &amp;,             rd =&gt; con_rd, cvap =&gt; con_cvap, cliq =&gt; con_cliq           &amp;<a name='2959'>
     &amp;,             eps =&gt; con_eps, epsm1 =&gt; con_epsm1<a name='2960'>
      implicit none<a name='2961'>
<font color=#447700>!<a name='2962'></font>
<font color=#447700>!     integer            im, ix,  km, jcap, ncloud,<a name='2963'></font>
      integer            im, ix,  km, ncloud,                              &amp;<a name='2964'>
     &amp;                   kbot(im), ktop(im), kcnv(im) <a name='2965'>
<font color=#447700>!    &amp;,                  me<a name='2966'></font>
      real(kind=kind_phys) delt<a name='2967'>
      real(kind=kind_phys) psp(im),    delp(ix,km), prslp(ix,km)<a name='2968'>
      real(kind=kind_phys) ps(im),     del(ix,km),  prsl(ix,km),              &amp;<a name='2969'>
     &amp;                     ql(ix,km,2),q1(ix,km),   t1(ix,km),                &amp;<a name='2970'>
     &amp;                     u1(ix,km),  v1(ix,km),                             &amp;<a name='2971'>
<font color=#447700>!    &amp;                     u1(ix,km),  v1(ix,km),   rcs(im),<a name='2972'></font>
     &amp;                     rn(im),     garea(im),                             &amp;<a name='2973'>
     &amp;                     dot(ix,km), phil(ix,km), hpbl(im),                 &amp;<a name='2974'>
     &amp;                     heat(im),   evap(im),    cnvw(ix,km),              &amp;<a name='2975'>
     &amp;                     cnvc(ix,km)                                        &amp;<a name='2976'>
<font color=#447700>! hchuang code change mass flux output<a name='2977'></font>
     &amp;,                    ud_mf(im,km),dt_mf(im,km)<a name='2978'>
<font color=#447700>!<a name='2979'></font>
      integer              i,j,indx, k, kk, km1, n<a name='2980'>
      integer              kpbl(im)<a name='2981'>
      integer, dimension(im), intent(in) :: islimsk<a name='2982'>
<font color=#447700>!<a name='2983'></font>
      real(kind=kind_phys) dellat,  delta,                            &amp;<a name='2984'>
     &amp;                     c0l,     c0s,     d0,                      &amp;<a name='2985'>
     &amp;                     c1l,     c1s,     asolfac,                 &amp;<a name='2986'>
     &amp;                     desdt,   dp,                               &amp;<a name='2987'>
     &amp;                     dq,      dqsdp,   dqsdt,   dt,             &amp;<a name='2988'>
     &amp;                     dt2,     dv1h,    dv2h,    dv3h,           &amp;<a name='2989'>
     &amp;                     dv1q,    dv2q,    dv3q,                    &amp;<a name='2990'>
     &amp;                     dz,      dz1,     e1,      clam,           &amp;<a name='2991'>
     &amp;                     el2orc,  elocp,   aafac,   cm,              &amp;<a name='2992'>
     &amp;                     es,      etah,    h1,                      &amp;<a name='2993'>
     &amp;                     evef,    evfact,  evfactl, fact1,          &amp;<a name='2994'>
<font color=#447700>!    &amp;                     fact2,   factor,  fjcap,   dthk,<a name='2995'></font>
     &amp;                     fact2,   factor,  dthk,                     &amp;<a name='2996'>
     &amp;                     g,       gamma,   pprime,  betaw,            &amp;<a name='2997'>
     &amp;                     qlk,     qrch,    qs,                      &amp;<a name='2998'>
     &amp;                     rfact,   shear,                            &amp;<a name='2999'>
     &amp;                     val,     val1,    val2,    wfac,             &amp;<a name='3000'>
     &amp;                     w1,      w1l,     w1s,     w2,               &amp;<a name='3001'>
     &amp;                     w2l,     w2s,     w3,      w3l,                &amp;<a name='3002'>
     &amp;                     w3s,     w4,      w4l,     w4s,             &amp;<a name='3003'>
     &amp;                     tem,     tem1,    tem2,                     &amp;<a name='3004'>
     &amp;                     ptem,    ptem1,                             &amp;<a name='3005'>
     &amp;                     pgcon<a name='3006'>
<font color=#447700>!<a name='3007'></font>
      integer              kb(im), kbcon(im), kbcon1(im),             &amp;<a name='3008'>
     &amp;                     ktcon(im), ktcon1(im), ktconn(im),         &amp;<a name='3009'>
     &amp;                     kbm(im), kmax(im)<a name='3010'>
<font color=#447700>!<a name='3011'></font>
      real(kind=kind_phys) aa1(im),     cina(im),                     &amp;<a name='3012'>
     &amp;                     delhbar(im), delq(im),   delq2(im),        &amp;<a name='3013'>
     &amp;                     delqbar(im), delqev(im), deltbar(im),      &amp;<a name='3014'>
     &amp;                     deltv(im),   edt(im),                      &amp;<a name='3015'>
     &amp;                     wstar(im),   sflx(im),                     &amp;<a name='3016'>
     &amp;                     pdot(im),    po(im,km),                         &amp;<a name='3017'>
     &amp;                     qcond(im),   qevap(im),  hmax(im),         &amp;<a name='3018'>
     &amp;                     rntot(im),   vshear(im),                   &amp;<a name='3019'>
     &amp;                     xlamud(im),  xmb(im),    xmbmax(im),       &amp;<a name='3020'>
     &amp;                     delubar(im), delvbar(im)<a name='3021'>
<font color=#447700>!<a name='3022'></font>
      real(kind=kind_phys) c0(im),      c1(im)<a name='3023'>
<font color=#447700>!c<a name='3024'></font>
      real(kind=kind_phys) crtlamd<a name='3025'>
<font color=#447700>!<a name='3026'></font>
      real(kind=kind_phys) cinpcr,  cinpcrmx,  cinpcrmn,              &amp;<a name='3027'>
     &amp;                     cinacr,  cinacrmx,  cinacrmn<a name='3028'>
<font color=#447700>!  parameters for updraft core fraction calculation<a name='3029'></font>
      real(kind=kind_phys) fs0,  fp1<a name='3030'>
      real(kind=kind_phys) gfudarea<a name='3031'>
      integer itsig<a name='3032'>
<font color=#447700>!<a name='3033'></font>
<font color=#447700>!  parameters for updraft velocity calculation<a name='3034'></font>
      real(kind=kind_phys) bet1,    cd1,     f1,      gam1,          &amp;<a name='3035'>
     &amp;                     bb1,     bb2,     wucb<a name='3036'>
<font color=#447700>!cc<a name='3037'></font>
<font color=#447700>!c  physical parameters<a name='3038'></font>
      parameter(g=grav,asolfac=0.89)<a name='3039'>
      parameter(elocp=hvap/cp,                                       &amp;<a name='3040'>
     &amp;          el2orc=hvap*hvap/(rv*cp))<a name='3041'>
<font color=#447700>!     parameter(c0l=0.00178,c0s=0.002,c1l=3.5e-4,c1s=5.e-4,d0=.07)<a name='3042'></font>
      <font color=#447700>!parameter(c0s=0.002,c1s=5.e-4,d0=.07)<a name='3043'></font>
      parameter(c0s=0.002,c1s=5.e-4,d0=.01)<a name='3044'>
      parameter(c0l=c0s*asolfac,c1l=c1s*asolfac)<a name='3045'>
      parameter(cm=1.0,delta=fv)<a name='3046'>
      parameter(fact1=(cvap-cliq)/rv,fact2=hvap/rv-fact1*t0c)<a name='3047'>
      parameter(wfac=-150.,dthk=25.)<a name='3048'>
      parameter(cinpcrmx=180.,cinpcrmn=120.)<a name='3049'>
      parameter(cinacrmx=-120.,cinacrmn=-120.)<a name='3050'>
      parameter(crtlamd=3.e-4)<a name='3051'>
      parameter(bet1=1.875,cd1=.506,f1=2.0,gam1=.5)<a name='3052'>
      parameter(betaw=.03)<a name='3053'>
      parameter(itsig=7,gfudarea=25632653.0)<a name='3054'>
      parameter(h1=0.33333333)<a name='3055'>
<font color=#447700>!c  local variables and arrays<a name='3056'></font>
      real(kind=kind_phys) pfld(im,km),    to(im,km),     qo(im,km),   &amp;<a name='3057'>
     &amp;                     uo(im,km),      vo(im,km),     qeso(im,km)<a name='3058'>
<font color=#447700>!  for updraft velocity calculation<a name='3059'></font>
<font color=#447700>!     real(kind=kind_phys) wu2(im,km),     buo(im,km),    drag(im,km)<a name='3060'></font>
      real(kind=kind_phys) buo(im,km)<a name='3061'>
<font color=#447700>!     real(kind=kind_phys) wc(im),         wcxmb(im)<a name='3062'></font>
      real(kind=kind_phys) wcxmb(im)<a name='3063'>
      real(kind=kind_phys) wbar(im),       xmbeta(im)<a name='3064'>
      real(kind=kind_phys) scaldfunc(im),  awlam(im),                  &amp;<a name='3065'>
     &amp;                     sigmaw(im),     sigmagf(im), sigmagfm(im)<a name='3066'>
      real(kind=kind_phys) sigmuout(im)   <font color=#447700>! output sigm_u,<a name='3067'></font>
<font color=#447700>!<a name='3068'></font>
<font color=#447700>!c  cloud water<a name='3069'></font>
<font color=#447700>!     real(kind=kind_phys) qlko_ktcon(im), dellal(im,km), tvo(im,km),<a name='3070'></font>
      real(kind=kind_phys) qlko_ktcon(im), dellal(im,km),                &amp;<a name='3071'>
     &amp;                     dbyo(im,km),    zo(im,km),     xlamue(im,km), &amp;<a name='3072'>
     &amp;                     heo(im,km),     heso(im,km),                  &amp;<a name='3073'>
     &amp;                     dellah(im,km),  dellaq(im,km),                &amp;<a name='3074'>
     &amp;                     dellau(im,km),  dellav(im,km), hcko(im,km),   &amp;<a name='3075'>
     &amp;                     ucko(im,km),    vcko(im,km),   qcko(im,km),   &amp;<a name='3076'>
     &amp;                     qrcko(im,km),   eta(im,km),                   &amp;<a name='3077'>
     &amp;                     zi(im,km),      pwo(im,km),    c0t(im,km),    &amp;<a name='3078'>
<font color=#447700>!    &amp;                     sumx(im),       tx1(im),       cnvwt(im,km)<a name='3079'></font>
     &amp;                     tx1(im),        cnvwt(im,km)<a name='3080'>
<font color=#447700>!<a name='3081'></font>
      logical totflg, cnvflg(im), flg(im)<a name='3082'>
<font color=#447700>!<a name='3083'></font>
      real(kind=kind_phys) tf, tcr, tcrf<a name='3084'>
      parameter (tf=233.16, tcr=263.16, tcrf=1.0/(tcr-tf))<a name='3085'>
<font color=#447700>!<a name='3086'></font>
<font color=#447700>!c-----------------------------------------------------------------------<a name='3087'></font>
<font color=#447700>!<a name='3088'></font>
<font color=#447700>!************************************************************************<a name='3089'></font>
<font color=#447700>!     convert input Pa terms to Cb terms  -- Moorthi<a name='3090'></font>
      ps   = psp   * 0.001<a name='3091'>
      prsl = prslp * 0.001<a name='3092'>
      del  = delp  * 0.001<a name='3093'>
<font color=#447700>!************************************************************************<a name='3094'></font>
<font color=#447700>!<a name='3095'></font>
      km1 = km - 1<a name='3096'>
<font color=#447700>!c<a name='3097'></font>
<font color=#447700>!c  compute surface buoyancy flux<a name='3098'></font>
<font color=#447700>!c<a name='3099'></font>
      do i=1,im<a name='3100'>
        sflx(i) = heat(i)+fv*t1(i,1)*evap(i)<a name='3101'>
      enddo<a name='3102'>
<font color=#447700>!c<a name='3103'></font>
<font color=#447700>!c  initialize arrays<a name='3104'></font>
<font color=#447700>!c<a name='3105'></font>
      do i=1,im<a name='3106'>
        cnvflg(i) = .true.<a name='3107'>
        if(kcnv(i).eq.1) cnvflg(i) = .false.<a name='3108'>
        if(sflx(i).le.0.) cnvflg(i) = .false.<a name='3109'>
        if(cnvflg(i)) then<a name='3110'>
          kbot(i)=km+1<a name='3111'>
          ktop(i)=0<a name='3112'>
        endif<a name='3113'>
        rn(i)=0.<a name='3114'>
        kbcon(i)=km<a name='3115'>
        ktcon(i)=1<a name='3116'>
        ktconn(i)=1<a name='3117'>
        kb(i)=km<a name='3118'>
        pdot(i) = 0.<a name='3119'>
        qlko_ktcon(i) = 0.<a name='3120'>
        edt(i)  = 0.<a name='3121'>
        aa1(i)  = 0.<a name='3122'>
        cina(i) = 0.<a name='3123'>
        vshear(i) = 0.<a name='3124'>
          scaldfunc(i)=-1.0  <font color=#447700>! wang initialized<a name='3125'></font>
          sigmaw(i)=-1.0<a name='3126'>
          sigmagf(i)=-1.0<a name='3127'>
          sigmagfm(i)=-1.0<a name='3128'>
           sigmuout(i)=-1.0<a name='3129'>
      enddo<a name='3130'>
<font color=#447700>!!<a name='3131'></font>
      totflg = .true.<a name='3132'>
      do i=1,im<a name='3133'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='3134'>
      enddo<a name='3135'>
      if(totflg) return<a name='3136'>
<font color=#447700>!!<a name='3137'></font>
      do i=1,im<a name='3138'>
        if(islimsk(i) == 1) then<a name='3139'>
           c0(i) = c0l<a name='3140'>
           c1(i) = c1l<a name='3141'>
        else<a name='3142'>
           c0(i) = c0s<a name='3143'>
           c1(i) = c1s<a name='3144'>
        endif<a name='3145'>
      enddo<a name='3146'>
<font color=#447700>!<a name='3147'></font>
      do k = 1, km<a name='3148'>
        do i = 1, im<a name='3149'>
          if(t1(i,k).gt.273.16) then<a name='3150'>
            c0t(i,k) = c0(i)<a name='3151'>
          else<a name='3152'>
            tem = d0 * (t1(i,k) - 273.16)<a name='3153'>
            tem1 = exp(tem)<a name='3154'>
            c0t(i,k) = c0(i) * tem1<a name='3155'>
          endif<a name='3156'>
        enddo<a name='3157'>
      enddo<a name='3158'>
<font color=#447700>!<a name='3159'></font>
      do k = 1, km<a name='3160'>
        do i = 1, im<a name='3161'>
          cnvw(i,k) = 0.<a name='3162'>
          cnvc(i,k) = 0.<a name='3163'>
        enddo<a name='3164'>
      enddo<a name='3165'>
<font color=#447700>! hchuang code change<a name='3166'></font>
      do k = 1, km<a name='3167'>
        do i = 1, im<a name='3168'>
          ud_mf(i,k) = 0.<a name='3169'>
          dt_mf(i,k) = 0.<a name='3170'>
        enddo<a name='3171'>
      enddo<a name='3172'>
<font color=#447700>!c<a name='3173'></font>
      dt2   = delt<a name='3174'>
<font color=#447700>!<a name='3175'></font>
<font color=#447700>!c  model tunable parameters are all here<a name='3176'></font>
      clam    = .3<a name='3177'>
      aafac   = .1<a name='3178'>
<font color=#447700>!c     evef    = 0.07<a name='3179'></font>
      evfact  = 0.3<a name='3180'>
      evfactl = 0.3<a name='3181'>
<font color=#447700>!<a name='3182'></font>
<font color=#447700>!     pgcon   = 0.7     ! Gregory et al. (1997, QJRMS)<a name='3183'></font>
      pgcon   = 0.55    <font color=#447700>! Zhang &amp; Wu (2003,JAS)<a name='3184'></font>
<font color=#447700>!     fjcap   = (float(jcap) / 126.) ** 2<a name='3185'></font>
<font color=#447700>!     val     =           1.<a name='3186'></font>
<font color=#447700>!     fjcap   = max(fjcap,val)<a name='3187'></font>
      w1l     = -8.e-3 <a name='3188'>
      w2l     = -4.e-2<a name='3189'>
      w3l     = -5.e-3 <a name='3190'>
      w4l     = -5.e-4<a name='3191'>
      w1s     = -2.e-4<a name='3192'>
      w2s     = -2.e-3<a name='3193'>
      w3s     = -1.e-3<a name='3194'>
      w4s     = -2.e-5<a name='3195'>
<font color=#447700>!c<a name='3196'></font>
<font color=#447700>!c  define top layer for search of the downdraft originating layer<a name='3197'></font>
<font color=#447700>!c  and the maximum thetae for updraft<a name='3198'></font>
<font color=#447700>!c<a name='3199'></font>
      do i=1,im<a name='3200'>
        kbm(i)   = km<a name='3201'>
        kmax(i)  = km<a name='3202'>
        tx1(i)   = 1.0 / ps(i)<a name='3203'>
      enddo<a name='3204'>
<font color=#447700>!     <a name='3205'></font>
      do k = 1, km<a name='3206'>
        do i=1,im<a name='3207'>
          if (prsl(i,k)*tx1(i) .gt. 0.70) kbm(i)   = k + 1<a name='3208'>
          if (prsl(i,k)*tx1(i) .gt. 0.60) kmax(i)  = k + 1<a name='3209'>
        enddo<a name='3210'>
      enddo<a name='3211'>
      do i=1,im<a name='3212'>
        kbm(i)   = min(kbm(i),kmax(i))<a name='3213'>
      enddo<a name='3214'>
<font color=#447700>!c<a name='3215'></font>
<font color=#447700>!c  hydrostatic height assume zero terr and compute<a name='3216'></font>
<font color=#447700>!c  updraft entrainment rate as an inverse function of height<a name='3217'></font>
<font color=#447700>!c<a name='3218'></font>
      do k = 1, km<a name='3219'>
        do i=1,im<a name='3220'>
          zo(i,k) = phil(i,k) / g<a name='3221'>
        enddo<a name='3222'>
      enddo<a name='3223'>
      do k = 1, km1<a name='3224'>
        do i=1,im<a name='3225'>
          zi(i,k) = 0.5*(zo(i,k)+zo(i,k+1))<a name='3226'>
          xlamue(i,k) = clam / zi(i,k)<a name='3227'>
        enddo<a name='3228'>
      enddo<a name='3229'>
      do i=1,im<a name='3230'>
        xlamue(i,km) = xlamue(i,km1)<a name='3231'>
      enddo<a name='3232'>
<font color=#447700>!c<a name='3233'></font>
<font color=#447700>!c  pbl height<a name='3234'></font>
<font color=#447700>!c<a name='3235'></font>
      do i=1,im<a name='3236'>
        flg(i) = cnvflg(i)<a name='3237'>
        kpbl(i)= 1<a name='3238'>
      enddo<a name='3239'>
      do k = 2, km1<a name='3240'>
        do i=1,im<a name='3241'>
          if (flg(i).and.zo(i,k).le.hpbl(i)) then<a name='3242'>
            kpbl(i) = k<a name='3243'>
          else<a name='3244'>
            flg(i) = .false.<a name='3245'>
          endif<a name='3246'>
        enddo<a name='3247'>
      enddo<a name='3248'>
      do i=1,im<a name='3249'>
        kpbl(i)= min(kpbl(i),kbm(i))<a name='3250'>
      enddo<a name='3251'>
<font color=#447700>!c<a name='3252'></font>
<font color=#447700>!c!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='3253'></font>
<font color=#447700>!c   convert surface pressure to mb from cb<a name='3254'></font>
<font color=#447700>!c<a name='3255'></font>
      do k = 1, km<a name='3256'>
        do i = 1, im<a name='3257'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='3258'>
            pfld(i,k) = prsl(i,k) * 10.0<a name='3259'>
            eta(i,k)  = 1.<a name='3260'>
            hcko(i,k) = 0.<a name='3261'>
            qcko(i,k) = 0.<a name='3262'>
            qrcko(i,k)= 0.<a name='3263'>
            ucko(i,k) = 0.<a name='3264'>
            vcko(i,k) = 0.<a name='3265'>
            dbyo(i,k) = 0.<a name='3266'>
            pwo(i,k)  = 0.<a name='3267'>
            dellal(i,k) = 0.<a name='3268'>
            to(i,k)   = t1(i,k)<a name='3269'>
            qo(i,k)   = q1(i,k)<a name='3270'>
            uo(i,k)   = u1(i,k)<a name='3271'>
            vo(i,k)   = v1(i,k)<a name='3272'>
<font color=#447700>!           uo(i,k)   = u1(i,k) * rcs(i)<a name='3273'></font>
<font color=#447700>!           vo(i,k)   = v1(i,k) * rcs(i)<a name='3274'></font>
<font color=#447700>!           wu2(i,k)  = 0.<a name='3275'></font>
            buo(i,k)  = 0.<a name='3276'>
<font color=#447700>!           drag(i,k) = 0.<a name='3277'></font>
            cnvwt(i,k) = 0.<a name='3278'>
          endif<a name='3279'>
        enddo<a name='3280'>
      enddo<a name='3281'>
<font color=#447700>!c<a name='3282'></font>
<font color=#447700>!c  column variables<a name='3283'></font>
<font color=#447700>!c  p is pressure of the layer (mb)<a name='3284'></font>
<font color=#447700>!c  t is temperature at t-dt (k)..tn<a name='3285'></font>
<font color=#447700>!c  q is mixing ratio at t-dt (kg/kg)..qn<a name='3286'></font>
<font color=#447700>!c  to is temperature at t+dt (k)... this is after advection and turbulan<a name='3287'></font>
<font color=#447700>!c  qo is mixing ratio at t+dt (kg/kg)..q1<a name='3288'></font>
<font color=#447700>!c<a name='3289'></font>
      do k = 1, km<a name='3290'>
        do i=1,im<a name='3291'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='3292'>
            qeso(i,k) = 0.01 * fpvs(to(i,k))      <font color=#447700>! fpvs is in pa<a name='3293'></font>
            qeso(i,k) = eps * qeso(i,k) / (pfld(i,k) + epsm1*qeso(i,k))<a name='3294'>
            val1      =             1.e-8<a name='3295'>
            qeso(i,k) = max(qeso(i,k), val1)<a name='3296'>
            val2      =           1.e-10<a name='3297'>
            qo(i,k)   = max(qo(i,k), val2 )<a name='3298'>
<font color=#447700>!           qo(i,k)   = min(qo(i,k),qeso(i,k))<a name='3299'></font>
<font color=#447700>!           tvo(i,k)  = to(i,k) + delta * to(i,k) * qo(i,k)<a name='3300'></font>
          endif<a name='3301'>
        enddo<a name='3302'>
      enddo<a name='3303'>
<font color=#447700>!c<a name='3304'></font>
<font color=#447700>!c  compute moist static energy<a name='3305'></font>
<font color=#447700>!c<a name='3306'></font>
      do k = 1, km<a name='3307'>
        do i=1,im<a name='3308'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='3309'>
<font color=#447700>!           tem       = g * zo(i,k) + cp * to(i,k)<a name='3310'></font>
            tem       = phil(i,k) + cp * to(i,k)<a name='3311'>
            heo(i,k)  = tem  + hvap * qo(i,k)<a name='3312'>
            heso(i,k) = tem  + hvap * qeso(i,k)<a name='3313'>
<font color=#447700>!c           heo(i,k)  = min(heo(i,k),heso(i,k))<a name='3314'></font>
          endif<a name='3315'>
        enddo<a name='3316'>
      enddo<a name='3317'>
<font color=#447700>!c<a name='3318'></font>
<font color=#447700>!c  determine level with largest moist static energy within pbl<a name='3319'></font>
<font color=#447700>!c  this is the level where updraft starts<a name='3320'></font>
<font color=#447700>!c<a name='3321'></font>
      do i=1,im<a name='3322'>
         if (cnvflg(i)) then<a name='3323'>
            hmax(i) = heo(i,1)<a name='3324'>
            kb(i) = 1<a name='3325'>
         endif<a name='3326'>
      enddo<a name='3327'>
      do k = 2, km<a name='3328'>
        do i=1,im<a name='3329'>
          if (cnvflg(i).and.k.le.kpbl(i)) then<a name='3330'>
            if(heo(i,k).gt.hmax(i)) then<a name='3331'>
              kb(i)   = k<a name='3332'>
              hmax(i) = heo(i,k)<a name='3333'>
            endif<a name='3334'>
          endif<a name='3335'>
        enddo<a name='3336'>
      enddo<a name='3337'>
<font color=#447700>!c<a name='3338'></font>
      do k = 1, km1<a name='3339'>
        do i=1,im<a name='3340'>
          if (cnvflg(i) .and. k .le. kmax(i)-1) then<a name='3341'>
            dz      = .5 * (zo(i,k+1) - zo(i,k))<a name='3342'>
            dp      = .5 * (pfld(i,k+1) - pfld(i,k))<a name='3343'>
            es      = 0.01 * fpvs(to(i,k+1))      <font color=#447700>! fpvs is in pa<a name='3344'></font>
            pprime  = pfld(i,k+1) + epsm1 * es<a name='3345'>
            qs      = eps * es / pprime<a name='3346'>
            dqsdp   = - qs / pprime<a name='3347'>
            desdt   = es * (fact1 / to(i,k+1) + fact2 / (to(i,k+1)**2))<a name='3348'>
            dqsdt   = qs * pfld(i,k+1) * desdt / (es * pprime)<a name='3349'>
            gamma   = el2orc * qeso(i,k+1) / (to(i,k+1)**2)<a name='3350'>
            dt      = (g * dz + hvap * dqsdp * dp) / (cp * (1. + gamma))<a name='3351'>
            dq      = dqsdt * dt + dqsdp * dp<a name='3352'>
            to(i,k) = to(i,k+1) + dt<a name='3353'>
            qo(i,k) = qo(i,k+1) + dq<a name='3354'>
            po(i,k) = .5 * (pfld(i,k) + pfld(i,k+1))<a name='3355'>
          endif<a name='3356'>
        enddo<a name='3357'>
      enddo<a name='3358'>
<font color=#447700>!<a name='3359'></font>
      do k = 1, km1<a name='3360'>
        do i=1,im<a name='3361'>
          if (cnvflg(i) .and. k .le. kmax(i)-1) then<a name='3362'>
            qeso(i,k) = 0.01 * fpvs(to(i,k))      <font color=#447700>! fpvs is in pa<a name='3363'></font>
            qeso(i,k) = eps * qeso(i,k) / (po(i,k) + epsm1*qeso(i,k))<a name='3364'>
            val1      =             1.e-8<a name='3365'>
            qeso(i,k) = max(qeso(i,k), val1)<a name='3366'>
            val2      =           1.e-10<a name='3367'>
            qo(i,k)   = max(qo(i,k), val2 )<a name='3368'>
<font color=#447700>!           qo(i,k)   = min(qo(i,k),qeso(i,k))<a name='3369'></font>
            heo(i,k)  = .5 * g * (zo(i,k) + zo(i,k+1)) +                &amp;<a name='3370'>
     &amp;                  cp * to(i,k) + hvap * qo(i,k)<a name='3371'>
            heso(i,k) = .5 * g * (zo(i,k) + zo(i,k+1)) +                &amp;<a name='3372'>
     &amp;                  cp * to(i,k) + hvap * qeso(i,k)<a name='3373'>
            uo(i,k)   = .5 * (uo(i,k) + uo(i,k+1))<a name='3374'>
            vo(i,k)   = .5 * (vo(i,k) + vo(i,k+1))<a name='3375'>
          endif<a name='3376'>
        enddo<a name='3377'>
      enddo<a name='3378'>
<font color=#447700>!c<a name='3379'></font>
<font color=#447700>!c  look for the level of free convection as cloud base<a name='3380'></font>
<font color=#447700>!c<a name='3381'></font>
      do i=1,im<a name='3382'>
        flg(i)   = cnvflg(i)<a name='3383'>
        if(flg(i)) kbcon(i) = kmax(i)<a name='3384'>
      enddo<a name='3385'>
      do k = 2, km1<a name='3386'>
        do i=1,im<a name='3387'>
          if (flg(i).and.k.lt.kbm(i)) then<a name='3388'>
            if(k.gt.kb(i).and.heo(i,kb(i)).gt.heso(i,k)) then<a name='3389'>
              kbcon(i) = k<a name='3390'>
              flg(i)   = .false.<a name='3391'>
            endif<a name='3392'>
          endif<a name='3393'>
        enddo<a name='3394'>
      enddo<a name='3395'>
<font color=#447700>!c<a name='3396'></font>
      do i=1,im<a name='3397'>
        if(cnvflg(i)) then<a name='3398'>
          if(kbcon(i).eq.kmax(i)) cnvflg(i) = .false.<a name='3399'>
        endif<a name='3400'>
      enddo<a name='3401'>
<font color=#447700>!!<a name='3402'></font>
      totflg = .true.<a name='3403'>
      do i=1,im<a name='3404'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='3405'>
      enddo<a name='3406'>
      if(totflg) return<a name='3407'>
<font color=#447700>!!<a name='3408'></font>
      do i=1,im<a name='3409'>
        if(cnvflg(i)) then<a name='3410'>
<font color=#447700>!         pdot(i)  = 10.* dot(i,kbcon(i))<a name='3411'></font>
          pdot(i)  = 0.01 * dot(i,kbcon(i)) <font color=#447700>! Now dot is in Pa/s<a name='3412'></font>
        endif<a name='3413'>
      enddo<a name='3414'>
<font color=#447700>!c<a name='3415'></font>
<font color=#447700>!c   turn off convection if pressure depth between parcel source level<a name='3416'></font>
<font color=#447700>!c      and cloud base is larger than a critical value, cinpcr<a name='3417'></font>
<font color=#447700>!c<a name='3418'></font>
      do i=1,im<a name='3419'>
        if(cnvflg(i)) then<a name='3420'>
          if(islimsk(i) == 1) then<a name='3421'>
            w1 = w1l<a name='3422'>
            w2 = w2l<a name='3423'>
            w3 = w3l<a name='3424'>
            w4 = w4l<a name='3425'>
          else<a name='3426'>
            w1 = w1s<a name='3427'>
            w2 = w2s<a name='3428'>
            w3 = w3s<a name='3429'>
            w4 = w4s<a name='3430'>
          endif<a name='3431'>
          if(pdot(i).le.w4) then<a name='3432'>
            tem = (pdot(i) - w4) / (w3 - w4)<a name='3433'>
          elseif(pdot(i).ge.-w4) then<a name='3434'>
            tem = - (pdot(i) + w4) / (w4 - w3)<a name='3435'>
          else<a name='3436'>
            tem = 0.<a name='3437'>
          endif<a name='3438'>
          val1    =            -1.<a name='3439'>
          tem = max(tem,val1)<a name='3440'>
          val2    =             1.<a name='3441'>
          tem = min(tem,val2)<a name='3442'>
          ptem = 1. - tem<a name='3443'>
          ptem1= .5*(cinpcrmx-cinpcrmn)<a name='3444'>
          cinpcr = cinpcrmx - ptem * ptem1<a name='3445'>
          tem1 = pfld(i,kb(i)) - pfld(i,kbcon(i))<a name='3446'>
          if(tem1.gt.cinpcr) then<a name='3447'>
             cnvflg(i) = .false.<a name='3448'>
          endif<a name='3449'>
        endif<a name='3450'>
      enddo<a name='3451'>
<font color=#447700>!!<a name='3452'></font>
      totflg = .true.<a name='3453'>
      do i=1,im<a name='3454'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='3455'>
      enddo<a name='3456'>
      if(totflg) return<a name='3457'>
<font color=#447700>!!<a name='3458'></font>
<font color=#447700>!c<a name='3459'></font>
<font color=#447700>!c  specify the detrainment rate for the updrafts<a name='3460'></font>
<font color=#447700>!c<a name='3461'></font>
      do i = 1, im<a name='3462'>
        if(cnvflg(i)) then<a name='3463'>
          xlamud(i) = xlamue(i,kbcon(i))<a name='3464'>
<font color=#447700>!         xlamud(i) = xlamue(i,kbcon(i))<a name='3465'></font>
<font color=#447700>!          xlamud(i) = crtlamd<a name='3466'></font>
        endif<a name='3467'>
      enddo<a name='3468'>
<font color=#447700>!c<a name='3469'></font>
<font color=#447700>!c  determine updraft mass flux for the subcloud layers<a name='3470'></font>
<font color=#447700>!c<a name='3471'></font>
      do k = km1, 1, -1<a name='3472'>
        do i = 1, im<a name='3473'>
          if (cnvflg(i)) then<a name='3474'>
            if(k.lt.kbcon(i).and.k.ge.kb(i)) then<a name='3475'>
              dz       = zi(i,k+1) - zi(i,k)<a name='3476'>
              ptem     = 0.5*(xlamue(i,k)+xlamue(i,k+1))-xlamud(i)<a name='3477'>
              eta(i,k) = eta(i,k+1) / (1. + ptem * dz)<a name='3478'>
            endif<a name='3479'>
          endif<a name='3480'>
        enddo<a name='3481'>
      enddo<a name='3482'>
<font color=#447700>!c<a name='3483'></font>
<font color=#447700>!c  compute mass flux above cloud base<a name='3484'></font>
<font color=#447700>!c<a name='3485'></font>
      do i = 1, im<a name='3486'>
        flg(i) = cnvflg(i)<a name='3487'>
      enddo<a name='3488'>
      do k = 2, km1<a name='3489'>
        do i = 1, im<a name='3490'>
         if(flg(i))then<a name='3491'>
           if(k.gt.kbcon(i).and.k.lt.kmax(i)) then<a name='3492'>
              dz       = zi(i,k) - zi(i,k-1)<a name='3493'>
              ptem     = 0.5*(xlamue(i,k)+xlamue(i,k-1))-xlamud(i)<a name='3494'>
              eta(i,k) = eta(i,k-1) * (1 + ptem * dz)<a name='3495'>
              if(eta(i,k).le.0.) then<a name='3496'>
                kmax(i) = k<a name='3497'>
                ktconn(i) = k<a name='3498'>
                kbm(i) = min(kbm(i),kmax(i))<a name='3499'>
                flg(i) = .false.<a name='3500'>
              endif<a name='3501'>
           endif<a name='3502'>
         endif<a name='3503'>
        enddo<a name='3504'>
      enddo<a name='3505'>
<font color=#447700>!c<a name='3506'></font>
<font color=#447700>!c  compute updraft cloud property<a name='3507'></font>
<font color=#447700>!c<a name='3508'></font>
      do i = 1, im<a name='3509'>
        if(cnvflg(i)) then<a name='3510'>
          indx         = kb(i)<a name='3511'>
          hcko(i,indx) = heo(i,indx)<a name='3512'>
          ucko(i,indx) = uo(i,indx)<a name='3513'>
          vcko(i,indx) = vo(i,indx)<a name='3514'>
        endif<a name='3515'>
      enddo<a name='3516'>
<font color=#447700>!c<a name='3517'></font>
<font color=#447700>!  cm is an enhancement factor in entrainment rates for momentum<a name='3518'></font>
<font color=#447700>!<a name='3519'></font>
      do k = 2, km1<a name='3520'>
        do i = 1, im<a name='3521'>
          if (cnvflg(i)) then<a name='3522'>
            if(k.gt.kb(i).and.k.lt.kmax(i)) then<a name='3523'>
              dz   = zi(i,k) - zi(i,k-1)<a name='3524'>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='3525'>
              tem1 = 0.5 * xlamud(i) * dz<a name='3526'>
              factor = 1. + tem - tem1<a name='3527'>
              hcko(i,k) = ((1.-tem1)*hcko(i,k-1)+tem*0.5*            &amp;<a name='3528'>
     &amp;                     (heo(i,k)+heo(i,k-1)))/factor<a name='3529'>
              dbyo(i,k) = hcko(i,k) - heso(i,k)<a name='3530'>
<font color=#447700>!<a name='3531'></font>
              tem  = 0.5 * cm * tem<a name='3532'>
              factor = 1. + tem<a name='3533'>
              ptem = tem + pgcon<a name='3534'>
              ptem1= tem - pgcon<a name='3535'>
              ucko(i,k) = ((1.-tem)*ucko(i,k-1)+ptem*uo(i,k)           &amp;<a name='3536'>
     &amp;                     +ptem1*uo(i,k-1))/factor<a name='3537'>
              vcko(i,k) = ((1.-tem)*vcko(i,k-1)+ptem*vo(i,k)           &amp;<a name='3538'>
     &amp;                     +ptem1*vo(i,k-1))/factor<a name='3539'>
            endif<a name='3540'>
          endif<a name='3541'>
        enddo<a name='3542'>
      enddo<a name='3543'>
<font color=#447700>!c<a name='3544'></font>
<font color=#447700>!c   taking account into convection inhibition due to existence of<a name='3545'></font>
<font color=#447700>!c    dry layers below cloud base<a name='3546'></font>
<font color=#447700>!c<a name='3547'></font>
      do i=1,im<a name='3548'>
        flg(i) = cnvflg(i)<a name='3549'>
        kbcon1(i) = kmax(i)<a name='3550'>
      enddo<a name='3551'>
      do k = 2, km1<a name='3552'>
      do i=1,im<a name='3553'>
        if (flg(i).and.k.lt.kbm(i)) then<a name='3554'>
          if(k.ge.kbcon(i).and.dbyo(i,k).gt.0.) then<a name='3555'>
            kbcon1(i) = k<a name='3556'>
            flg(i)    = .false.<a name='3557'>
          endif<a name='3558'>
        endif<a name='3559'>
      enddo<a name='3560'>
      enddo<a name='3561'>
      do i=1,im<a name='3562'>
        if(cnvflg(i)) then<a name='3563'>
          if(kbcon1(i).eq.kmax(i)) cnvflg(i) = .false.<a name='3564'>
        endif<a name='3565'>
      enddo<a name='3566'>
      do i=1,im<a name='3567'>
        if(cnvflg(i)) then<a name='3568'>
          tem = pfld(i,kbcon(i)) - pfld(i,kbcon1(i))<a name='3569'>
          if(tem.gt.dthk) then<a name='3570'>
             cnvflg(i) = .false.<a name='3571'>
          endif<a name='3572'>
        endif<a name='3573'>
      enddo<a name='3574'>
<font color=#447700>!!<a name='3575'></font>
      totflg = .true.<a name='3576'>
      do i = 1, im<a name='3577'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='3578'>
      enddo<a name='3579'>
      if(totflg) return<a name='3580'>
<font color=#447700>!!<a name='3581'></font>
<font color=#447700>!c<a name='3582'></font>
<font color=#447700>!c  calculate convective inhibition<a name='3583'></font>
<font color=#447700>!c<a name='3584'></font>
      do k = 2, km1<a name='3585'>
        do i = 1, im<a name='3586'>
          if (cnvflg(i)) then<a name='3587'>
            if(k.gt.kb(i).and.k.lt.kbcon1(i)) then<a name='3588'>
              dz1 = zo(i,k+1) - zo(i,k)<a name='3589'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='3590'>
              rfact =  1. + delta * cp * gamma                         &amp;<a name='3591'>
     &amp;                 * to(i,k) / hvap<a name='3592'>
              cina(i) = cina(i) +                                      &amp;<a name='3593'>
<font color=#447700>!    &amp;                 dz1 * eta(i,k) * (g / (cp * to(i,k)))<a name='3594'></font>
     &amp;                 dz1 * (g / (cp * to(i,k)))                      &amp;<a name='3595'>
     &amp;                 * dbyo(i,k) / (1. + gamma)                      &amp;<a name='3596'>
     &amp;                 * rfact<a name='3597'>
              val = 0.<a name='3598'>
              cina(i) = cina(i) +                                        &amp;<a name='3599'>
<font color=#447700>!    &amp;                 dz1 * eta(i,k) * g * delta *<a name='3600'></font>
     &amp;                 dz1 * g * delta *                                  &amp;<a name='3601'>
     &amp;                 max(val,(qeso(i,k) - qo(i,k)))<a name='3602'>
            endif<a name='3603'>
          endif<a name='3604'>
        enddo<a name='3605'>
      enddo<a name='3606'>
      do i = 1, im<a name='3607'>
        if(cnvflg(i)) then<a name='3608'>
<font color=#447700>!<a name='3609'></font>
<font color=#447700>!         if(islimsk(i) == 1) then<a name='3610'></font>
<font color=#447700>!           w1 = w1l<a name='3611'></font>
<font color=#447700>!           w2 = w2l<a name='3612'></font>
<font color=#447700>!           w3 = w3l<a name='3613'></font>
<font color=#447700>!           w4 = w4l<a name='3614'></font>
<font color=#447700>!         else<a name='3615'></font>
<font color=#447700>!           w1 = w1s<a name='3616'></font>
<font color=#447700>!           w2 = w2s<a name='3617'></font>
<font color=#447700>!           w3 = w3s<a name='3618'></font>
<font color=#447700>!           w4 = w4s<a name='3619'></font>
<font color=#447700>!         endif<a name='3620'></font>
<font color=#447700>!         if(pdot(i).le.w4) then<a name='3621'></font>
<font color=#447700>!           tem = (pdot(i) - w4) / (w3 - w4)<a name='3622'></font>
<font color=#447700>!         elseif(pdot(i).ge.-w4) then<a name='3623'></font>
<font color=#447700>!           tem = - (pdot(i) + w4) / (w4 - w3)<a name='3624'></font>
<font color=#447700>!         else<a name='3625'></font>
<font color=#447700>!           tem = 0.<a name='3626'></font>
<font color=#447700>!         endif<a name='3627'></font>
<font color=#447700>!<a name='3628'></font>
<font color=#447700>!         val1    =            -1.<a name='3629'></font>
<font color=#447700>!         tem = max(tem,val1)<a name='3630'></font>
<font color=#447700>!         val2    =             1.<a name='3631'></font>
<font color=#447700>!         tem = min(tem,val2)<a name='3632'></font>
<font color=#447700>!         tem = 1. - tem<a name='3633'></font>
<font color=#447700>!         tem1= .5*(cinacrmx-cinacrmn)<a name='3634'></font>
<font color=#447700>!         cinacr = cinacrmx - tem * tem1<a name='3635'></font>
<font color=#447700>!<a name='3636'></font>
          cinacr = cinacrmx<a name='3637'>
          if(cina(i).lt.cinacr) cnvflg(i) = .false.<a name='3638'>
        endif<a name='3639'>
      enddo<a name='3640'>
<font color=#447700>!!<a name='3641'></font>
      totflg = .true.<a name='3642'>
      do i=1,im<a name='3643'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='3644'>
      enddo<a name='3645'>
      if(totflg) return<a name='3646'>
<font color=#447700>!!<a name='3647'></font>
<font color=#447700>!c<a name='3648'></font>
<font color=#447700>!c  determine first guess cloud top as the level of zero buoyancy<a name='3649'></font>
<font color=#447700>!c    limited to the level of P/Ps=0.7<a name='3650'></font>
<font color=#447700>!c<a name='3651'></font>
      do i = 1, im<a name='3652'>
        flg(i) = cnvflg(i)<a name='3653'>
        if(flg(i)) ktcon(i) = kbm(i)<a name='3654'>
      enddo<a name='3655'>
      do k = 2, km1<a name='3656'>
      do i=1,im<a name='3657'>
        if (flg(i).and.k .lt. kbm(i)) then<a name='3658'>
          if(k.gt.kbcon1(i).and.dbyo(i,k).lt.0.) then<a name='3659'>
             ktcon(i) = k<a name='3660'>
             flg(i)   = .false.<a name='3661'>
          endif<a name='3662'>
        endif<a name='3663'>
      enddo<a name='3664'>
      enddo<a name='3665'>
<font color=#447700>!c<a name='3666'></font>
<font color=#447700>!c  turn off shallow convection if cloud top is less than pbl top<a name='3667'></font>
<font color=#447700>!c<a name='3668'></font>
<font color=#447700>!     do i=1,im<a name='3669'></font>
<font color=#447700>!       if(cnvflg(i)) then<a name='3670'></font>
<font color=#447700>!         kk = kpbl(i)+1<a name='3671'></font>
<font color=#447700>!         if(ktcon(i).le.kk) cnvflg(i) = .false.<a name='3672'></font>
<font color=#447700>!       endif<a name='3673'></font>
<font color=#447700>!     enddo<a name='3674'></font>
<font color=#447700>!!<a name='3675'></font>
<font color=#447700>!     totflg = .true.<a name='3676'></font>
<font color=#447700>!     do i = 1, im<a name='3677'></font>
<font color=#447700>!       totflg = totflg .and. (.not. cnvflg(i))<a name='3678'></font>
<font color=#447700>!     enddo<a name='3679'></font>
<font color=#447700>!     if(totflg) return<a name='3680'></font>
<font color=#447700>!!<a name='3681'></font>
<font color=#447700>!c<a name='3682'></font>
<font color=#447700>!c  specify upper limit of mass flux at cloud base<a name='3683'></font>
<font color=#447700>!c<a name='3684'></font>
      do i = 1, im<a name='3685'>
        if(cnvflg(i)) then<a name='3686'>
<font color=#447700>!         xmbmax(i) = .1<a name='3687'></font>
<font color=#447700>!<a name='3688'></font>
          k = kbcon(i)<a name='3689'>
          dp = 1000. * del(i,k)<a name='3690'>
          xmbmax(i) = dp / (g * dt2)<a name='3691'>
<font color=#447700>!<a name='3692'></font>
<font color=#447700>!         tem = dp / (g * dt2)<a name='3693'></font>
<font color=#447700>!         xmbmax(i) = min(tem, xmbmax(i))<a name='3694'></font>
        endif<a name='3695'>
      enddo<a name='3696'>
<font color=#447700>!c<a name='3697'></font>
<font color=#447700>!c  compute cloud moisture property and precipitation<a name='3698'></font>
<font color=#447700>!c<a name='3699'></font>
      do i = 1, im<a name='3700'>
        if (cnvflg(i)) then<a name='3701'>
          aa1(i) = 0.<a name='3702'>
          qcko(i,kb(i)) = qo(i,kb(i))<a name='3703'>
          qrcko(i,kb(i)) = qo(i,kb(i))<a name='3704'>
        endif<a name='3705'>
      enddo<a name='3706'>
      do k = 2, km1<a name='3707'>
        do i = 1, im<a name='3708'>
          if (cnvflg(i)) then<a name='3709'>
            if(k.gt.kb(i).and.k.lt.ktcon(i)) then<a name='3710'>
              dz    = zi(i,k) - zi(i,k-1)<a name='3711'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='3712'>
              qrch = qeso(i,k)                                               &amp;<a name='3713'>
     &amp;             + gamma * dbyo(i,k) / (hvap * (1. + gamma))<a name='3714'>
<font color=#447700>!cj<a name='3715'></font>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='3716'>
              tem1 = 0.5 * xlamud(i) * dz<a name='3717'>
              factor = 1. + tem - tem1<a name='3718'>
              qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*                    &amp;<a name='3719'>
     &amp;                     (qo(i,k)+qo(i,k-1)))/factor<a name='3720'>
              qrcko(i,k) = qcko(i,k)<a name='3721'>
<font color=#447700>!cj<a name='3722'></font>
              dq = eta(i,k) * (qcko(i,k) - qrch)<a name='3723'>
<font color=#447700>!c<a name='3724'></font>
<font color=#447700>!             rhbar(i) = rhbar(i) + qo(i,k) / qeso(i,k)<a name='3725'></font>
<font color=#447700>!c<a name='3726'></font>
<font color=#447700>!c  below lfc check if there is excess moisture to release latent heat<a name='3727'></font>
<font color=#447700>!c<a name='3728'></font>
              if(k.ge.kbcon(i).and.dq.gt.0.) then<a name='3729'>
                etah = .5 * (eta(i,k) + eta(i,k-1))<a name='3730'>
                if(ncloud.gt.0) then<a name='3731'>
                  dp = 1000. * del(i,k)<a name='3732'>
                  ptem = c0t(i,k) + c1(i)<a name='3733'>
                  qlk = dq / (eta(i,k) + etah * ptem * dz)<a name='3734'>
                  dellal(i,k) = etah * c1(i) * dz * qlk * g / dp<a name='3735'>
                else<a name='3736'>
                  qlk = dq / (eta(i,k) + etah * c0t(i,k) * dz)<a name='3737'>
                endif<a name='3738'>
                buo(i,k) = buo(i,k) - g * qlk<a name='3739'>
                qcko(i,k)= qlk + qrch<a name='3740'>
                pwo(i,k) = etah * c0t(i,k) * dz * qlk<a name='3741'>
                cnvwt(i,k) = etah * qlk * g / dp<a name='3742'>
              endif<a name='3743'>
<font color=#447700>!<a name='3744'></font>
<font color=#447700>!  compute buoyancy and drag for updraft velocity<a name='3745'></font>
<font color=#447700>!<a name='3746'></font>
              if(k &gt;= kbcon(i)) then<a name='3747'>
                rfact =  1. + delta * cp * gamma                      &amp;<a name='3748'>
     &amp;                   * to(i,k) / hvap<a name='3749'>
                buo(i,k) = buo(i,k) + (g / (cp * to(i,k)))              &amp;<a name='3750'>
     &amp;                   * dbyo(i,k) / (1. + gamma)                    &amp;<a name='3751'>
     &amp;                   * rfact<a name='3752'>
                val = 0.<a name='3753'>
                buo(i,k) = buo(i,k) + g * delta *                     &amp;<a name='3754'>
     &amp;                     max(val,(qeso(i,k) - qo(i,k)))<a name='3755'>
<font color=#447700>!               drag(i,k) = max(xlamue(i,k),xlamud(i))<a name='3756'></font>
              endif<a name='3757'>
<font color=#447700>!<a name='3758'></font>
            endif<a name='3759'>
          endif<a name='3760'>
        enddo<a name='3761'>
      enddo<a name='3762'>
<font color=#447700>!c<a name='3763'></font>
<font color=#447700>!c  calculate cloud work function<a name='3764'></font>
<font color=#447700>!c<a name='3765'></font>
<font color=#447700>!     do k = 2, km1<a name='3766'></font>
<font color=#447700>!       do i = 1, im<a name='3767'></font>
<font color=#447700>!         if (cnvflg(i)) then<a name='3768'></font>
<font color=#447700>!           if(k.ge.kbcon(i).and.k.lt.ktcon(i)) then<a name='3769'></font>
<font color=#447700>!             dz1 = zo(i,k+1) - zo(i,k)<a name='3770'></font>
<font color=#447700>!             gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='3771'></font>
<font color=#447700>!             rfact =  1. + delta * cp * gamma<a name='3772'></font>
<font color=#447700>!    &amp;                 * to(i,k) / hvap<a name='3773'></font>
<font color=#447700>!             aa1(i) = aa1(i) +<a name='3774'></font>
<font color=#447700>!!   &amp;                 dz1 * eta(i,k) * (g / (cp * to(i,k)))<a name='3775'></font>
<font color=#447700>!    &amp;                 dz1 * (g / (cp * to(i,k)))<a name='3776'></font>
<font color=#447700>!    &amp;                 * dbyo(i,k) / (1. + gamma)<a name='3777'></font>
<font color=#447700>!    &amp;                 * rfact<a name='3778'></font>
<font color=#447700>!             val = 0.<a name='3779'></font>
<font color=#447700>!             aa1(i) = aa1(i) +<a name='3780'></font>
<font color=#447700>!!   &amp;                 dz1 * eta(i,k) * g * delta *<a name='3781'></font>
<font color=#447700>!    &amp;                 dz1 * g * delta *<a name='3782'></font>
<font color=#447700>!    &amp;                 max(val,(qeso(i,k) - qo(i,k)))<a name='3783'></font>
<font color=#447700>!           endif<a name='3784'></font>
<font color=#447700>!         endif<a name='3785'></font>
<font color=#447700>!       enddo<a name='3786'></font>
<font color=#447700>!     enddo<a name='3787'></font>
<font color=#447700>!     do i = 1, im<a name='3788'></font>
<font color=#447700>!       if(cnvflg(i).and.aa1(i).le.0.) cnvflg(i) = .false.<a name='3789'></font>
<font color=#447700>!     enddo<a name='3790'></font>
<font color=#447700>!<a name='3791'></font>
<font color=#447700>!  calculate cloud work function<a name='3792'></font>
<font color=#447700>!<a name='3793'></font>
      do i = 1, im<a name='3794'>
        if (cnvflg(i)) then<a name='3795'>
          aa1(i) = 0.<a name='3796'>
        endif<a name='3797'>
      enddo<a name='3798'>
      do k = 2, km1<a name='3799'>
        do i = 1, im<a name='3800'>
          if (cnvflg(i)) then<a name='3801'>
            if(k &gt;= kbcon(i) .and. k &lt; ktcon(i)) then<a name='3802'>
              dz1 = zo(i,k+1) - zo(i,k)<a name='3803'>
              aa1(i) = aa1(i) + buo(i,k) * dz1<a name='3804'>
            endif<a name='3805'>
          endif<a name='3806'>
        enddo<a name='3807'>
      enddo<a name='3808'>
      do i = 1, im<a name='3809'>
        if(cnvflg(i) .and. aa1(i) &lt;= 0.) cnvflg(i) = .false.<a name='3810'>
      enddo<a name='3811'>
<font color=#447700>!!<a name='3812'></font>
      totflg = .true.<a name='3813'>
      do i=1,im<a name='3814'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='3815'>
      enddo<a name='3816'>
      if(totflg) return<a name='3817'>
<font color=#447700>!!<a name='3818'></font>
<font color=#447700>!c<a name='3819'></font>
<font color=#447700>!c  estimate the onvective overshooting as the level<a name='3820'></font>
<font color=#447700>!c    where the [aafac * cloud work function] becomes zero,<a name='3821'></font>
<font color=#447700>!c    which is the final cloud top<a name='3822'></font>
<font color=#447700>!c    limited to the level of P/Ps=0.7<a name='3823'></font>
<font color=#447700>!c<a name='3824'></font>
      do i = 1, im<a name='3825'>
        if (cnvflg(i)) then<a name='3826'>
          aa1(i) = aafac * aa1(i)<a name='3827'>
        endif<a name='3828'>
      enddo<a name='3829'>
<font color=#447700>!c<a name='3830'></font>
      do i = 1, im<a name='3831'>
        flg(i) = cnvflg(i)<a name='3832'>
        ktcon1(i) = kbm(i)<a name='3833'>
      enddo<a name='3834'>
      do k = 2, km1<a name='3835'>
        do i = 1, im<a name='3836'>
          if (flg(i)) then<a name='3837'>
            if(k.ge.ktcon(i).and.k.lt.kbm(i)) then<a name='3838'>
              dz1 = zo(i,k+1) - zo(i,k)<a name='3839'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='3840'>
              rfact =  1. + delta * cp * gamma                     &amp;<a name='3841'>
     &amp;                 * to(i,k) / hvap<a name='3842'>
              aa1(i) = aa1(i) +                                     &amp;<a name='3843'>
<font color=#447700>!    &amp;                 dz1 * eta(i,k) * (g / (cp * to(i,k)))<a name='3844'></font>
     &amp;                 dz1 * (g / (cp * to(i,k)))                   &amp;<a name='3845'>
     &amp;                 * dbyo(i,k) / (1. + gamma)                   &amp;<a name='3846'>
     &amp;                 * rfact<a name='3847'>
<font color=#447700>!             val = 0.<a name='3848'></font>
<font color=#447700>!             aa1(i) = aa1(i) +<a name='3849'></font>
<font color=#447700>!!   &amp;                 dz1 * eta(i,k) * g * delta *<a name='3850'></font>
<font color=#447700>!    &amp;                 dz1 * g * delta *<a name='3851'></font>
<font color=#447700>!    &amp;                 max(val,(qeso(i,k) - qo(i,k)))<a name='3852'></font>
              if(aa1(i).lt.0.) then<a name='3853'>
                ktcon1(i) = k<a name='3854'>
                flg(i) = .false.<a name='3855'>
              endif<a name='3856'>
            endif<a name='3857'>
          endif<a name='3858'>
        enddo<a name='3859'>
      enddo<a name='3860'>
<font color=#447700>!c<a name='3861'></font>
<font color=#447700>!c  compute cloud moisture property, detraining cloud water<a name='3862'></font>
<font color=#447700>!c    and precipitation in overshooting layers<a name='3863'></font>
<font color=#447700>!c<a name='3864'></font>
      do k = 2, km1<a name='3865'>
        do i = 1, im<a name='3866'>
          if (cnvflg(i)) then<a name='3867'>
            if(k.ge.ktcon(i).and.k.lt.ktcon1(i)) then<a name='3868'>
              dz    = zi(i,k) - zi(i,k-1)<a name='3869'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='3870'>
              qrch = qeso(i,k)                                          &amp;<a name='3871'>
     &amp;             + gamma * dbyo(i,k) / (hvap * (1. + gamma))<a name='3872'>
<font color=#447700>!cj<a name='3873'></font>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='3874'>
              tem1 = 0.5 * xlamud(i) * dz<a name='3875'>
              factor = 1. + tem - tem1<a name='3876'>
              qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*               &amp;<a name='3877'>
     &amp;                     (qo(i,k)+qo(i,k-1)))/factor<a name='3878'>
              qrcko(i,k) = qcko(i,k)<a name='3879'>
<font color=#447700>!cj<a name='3880'></font>
              dq = eta(i,k) * (qcko(i,k) - qrch)<a name='3881'>
<font color=#447700>!c<a name='3882'></font>
<font color=#447700>!c  check if there is excess moisture to release latent heat<a name='3883'></font>
<font color=#447700>!c<a name='3884'></font>
              if(dq.gt.0.) then<a name='3885'>
                etah = .5 * (eta(i,k) + eta(i,k-1))<a name='3886'>
                if(ncloud.gt.0) then<a name='3887'>
                  dp = 1000. * del(i,k)<a name='3888'>
                  ptem = c0t(i,k) + c1(i)<a name='3889'>
                  qlk = dq / (eta(i,k) + etah * ptem * dz)<a name='3890'>
                  dellal(i,k) = etah * c1(i) * dz * qlk * g / dp<a name='3891'>
                else<a name='3892'>
                  qlk = dq / (eta(i,k) + etah * c0t(i,k) * dz)<a name='3893'>
                endif<a name='3894'>
                qcko(i,k) = qlk + qrch<a name='3895'>
                pwo(i,k) = etah * c0t(i,k) * dz * qlk<a name='3896'>
                cnvwt(i,k) = etah * qlk * g / dp<a name='3897'>
              endif<a name='3898'>
            endif<a name='3899'>
          endif<a name='3900'>
        enddo<a name='3901'>
      enddo<a name='3902'>
<font color=#447700>!<a name='3903'></font>
<font color=#447700>!  compute updraft velocity square(wu2)<a name='3904'></font>
<font color=#447700>!<a name='3905'></font>
<font color=#447700>!     bb1 = 2. * (1.+bet1*cd1)<a name='3906'></font>
<font color=#447700>!     bb2 = 2. / (f1*(1.+gam1))<a name='3907'></font>
<font color=#447700>!<a name='3908'></font>
<font color=#447700>!!    bb1 = 12.0<a name='3909'></font>
<font color=#447700>!!    bb2 = 0.67<a name='3910'></font>
<font color=#447700>!<a name='3911'></font>
<font color=#447700>!     do i = 1, im<a name='3912'></font>
<font color=#447700>!       if (cnvflg(i)) then<a name='3913'></font>
<font color=#447700>!         k = kbcon1(i)<a name='3914'></font>
<font color=#447700>!         tem = po(i,k) / (rd * to(i,k))<a name='3915'></font>
<font color=#447700>!         wucb = -0.01 * dot(i,k) / (tem * g)<a name='3916'></font>
<font color=#447700>!         if(wucb &gt; 0.) then<a name='3917'></font>
<font color=#447700>!           wu2(i,k) = wucb * wucb<a name='3918'></font>
<font color=#447700>!         else<a name='3919'></font>
<font color=#447700>!           wu2(i,k) = 0.<a name='3920'></font>
<font color=#447700>!         endif<a name='3921'></font>
<font color=#447700>!       endif<a name='3922'></font>
<font color=#447700>!     enddo<a name='3923'></font>
<font color=#447700>!     do k = 2, km1<a name='3924'></font>
<font color=#447700>!       do i = 1, im<a name='3925'></font>
<font color=#447700>!         if (cnvflg(i)) then<a name='3926'></font>
<font color=#447700>!           if(k &gt; kbcon1(i) .and. k &lt; ktcon(i)) then<a name='3927'></font>
<font color=#447700>!             dz    = zi(i,k) - zi(i,k-1)<a name='3928'></font>
<font color=#447700>!             tem  = 0.25 * bb1 * (drag(i,k)+drag(i,k-1)) * dz<a name='3929'></font>
<font color=#447700>!             tem1 = 0.5 * bb2 * (buo(i,k)+buo(i,k-1)) * dz<a name='3930'></font>
<font color=#447700>!             ptem = (1. - tem) * wu2(i,k-1)<a name='3931'></font>
<font color=#447700>!             ptem1 = 1. + tem<a name='3932'></font>
<font color=#447700>!             wu2(i,k) = (ptem + tem1) / ptem1<a name='3933'></font>
<font color=#447700>!             wu2(i,k) = max(wu2(i,k), 0.)<a name='3934'></font>
<font color=#447700>!           endif<a name='3935'></font>
<font color=#447700>!         endif<a name='3936'></font>
<font color=#447700>!       enddo<a name='3937'></font>
<font color=#447700>!     enddo<a name='3938'></font>
<font color=#447700>!<a name='3939'></font>
<font color=#447700>!  compute updraft velocity averaged over the whole cumulus<a name='3940'></font>
<font color=#447700>!<a name='3941'></font>
<font color=#447700>!     do i = 1, im<a name='3942'></font>
<font color=#447700>!       wc(i) = 0.<a name='3943'></font>
<font color=#447700>!       sumx(i) = 0.<a name='3944'></font>
<font color=#447700>!     enddo<a name='3945'></font>
<font color=#447700>!     do k = 2, km1<a name='3946'></font>
<font color=#447700>!       do i = 1, im<a name='3947'></font>
<font color=#447700>!         if (cnvflg(i)) then<a name='3948'></font>
<font color=#447700>!           if(k &gt; kbcon1(i) .and. k &lt; ktcon(i)) then<a name='3949'></font>
<font color=#447700>!             dz = zi(i,k) - zi(i,k-1)<a name='3950'></font>
<font color=#447700>!             tem = 0.5 * (sqrt(wu2(i,k)) + sqrt(wu2(i,k-1)))<a name='3951'></font>
<font color=#447700>!             wc(i) = wc(i) + tem * dz<a name='3952'></font>
<font color=#447700>!             sumx(i) = sumx(i) + dz<a name='3953'></font>
<font color=#447700>!           endif<a name='3954'></font>
<font color=#447700>!         endif<a name='3955'></font>
<font color=#447700>!       enddo<a name='3956'></font>
<font color=#447700>!     enddo<a name='3957'></font>
<font color=#447700>!     do i = 1, im<a name='3958'></font>
<font color=#447700>!       if(cnvflg(i)) then<a name='3959'></font>
<font color=#447700>!         if(sumx(i) == 0.) then<a name='3960'></font>
<font color=#447700>!            cnvflg(i)=.false.<a name='3961'></font>
<font color=#447700>!         else<a name='3962'></font>
<font color=#447700>!            wc(i) = wc(i) / sumx(i)<a name='3963'></font>
<font color=#447700>!         endif<a name='3964'></font>
<font color=#447700>!         val = 1.e-4<a name='3965'></font>
<font color=#447700>!         if (wc(i) &lt; val) cnvflg(i)=.false.<a name='3966'></font>
<font color=#447700>!       endif<a name='3967'></font>
<font color=#447700>!     enddo<a name='3968'></font>
<font color=#447700>!c<a name='3969'></font>
<font color=#447700>!c exchange ktcon with ktcon1<a name='3970'></font>
<font color=#447700>!c<a name='3971'></font>
      do i = 1, im<a name='3972'>
        if(cnvflg(i)) then<a name='3973'>
          kk = ktcon(i)<a name='3974'>
          ktcon(i) = ktcon1(i)<a name='3975'>
          ktcon1(i) = kk<a name='3976'>
        endif<a name='3977'>
      enddo<a name='3978'>
<font color=#447700>!c<a name='3979'></font>
<font color=#447700>!c  this section is ready for cloud water<a name='3980'></font>
<font color=#447700>!c<a name='3981'></font>
      if(ncloud.gt.0) then<a name='3982'>
<font color=#447700>!c<a name='3983'></font>
<font color=#447700>!c  compute liquid and vapor separation at cloud top<a name='3984'></font>
<font color=#447700>!c<a name='3985'></font>
      do i = 1, im<a name='3986'>
        if(cnvflg(i)) then<a name='3987'>
          k = ktcon(i) - 1<a name='3988'>
          gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='3989'>
          qrch = qeso(i,k)                                         &amp;<a name='3990'>
     &amp;         + gamma * dbyo(i,k) / (hvap * (1. + gamma))<a name='3991'>
          dq = qcko(i,k) - qrch<a name='3992'>
<font color=#447700>!c<a name='3993'></font>
<font color=#447700>!c  check if there is excess moisture to release latent heat<a name='3994'></font>
<font color=#447700>!c<a name='3995'></font>
          if(dq.gt.0.) then<a name='3996'>
            qlko_ktcon(i) = dq<a name='3997'>
            qcko(i,k) = qrch<a name='3998'>
          endif<a name='3999'>
        endif<a name='4000'>
      enddo<a name='4001'>
      endif<a name='4002'>
<font color=#447700>!c<a name='4003'></font>
<font color=#447700>!c--- compute precipitation efficiency in terms of windshear<a name='4004'></font>
<font color=#447700>!c<a name='4005'></font>
      do i = 1, im<a name='4006'>
        if(cnvflg(i)) then<a name='4007'>
          vshear(i) = 0.<a name='4008'>
        endif<a name='4009'>
      enddo<a name='4010'>
      do k = 2, km<a name='4011'>
        do i = 1, im<a name='4012'>
          if (cnvflg(i)) then<a name='4013'>
            if(k.gt.kb(i).and.k.le.ktcon(i)) then<a name='4014'>
              shear= sqrt((uo(i,k)-uo(i,k-1)) ** 2                     &amp;<a name='4015'>
     &amp;                  + (vo(i,k)-vo(i,k-1)) ** 2)<a name='4016'>
              vshear(i) = vshear(i) + shear<a name='4017'>
            endif<a name='4018'>
          endif<a name='4019'>
        enddo<a name='4020'>
      enddo<a name='4021'>
      do i = 1, im<a name='4022'>
        if(cnvflg(i)) then<a name='4023'>
          vshear(i) = 1.e3 * vshear(i) / (zi(i,ktcon(i))-zi(i,kb(i)))<a name='4024'>
          e1=1.591-.639*vshear(i)                                     &amp;<a name='4025'>
     &amp;       +.0953*(vshear(i)**2)-.00496*(vshear(i)**3)<a name='4026'>
          edt(i)=1.-e1<a name='4027'>
          val =         .9<a name='4028'>
          edt(i) = min(edt(i),val)<a name='4029'>
          val =         .0<a name='4030'>
          edt(i) = max(edt(i),val)<a name='4031'>
        endif<a name='4032'>
      enddo<a name='4033'>
<font color=#447700>!c<a name='4034'></font>
<font color=#447700>!c--- what would the change be, that a cloud with unit mass<a name='4035'></font>
<font color=#447700>!c--- will do to the environment?<a name='4036'></font>
<font color=#447700>!c<a name='4037'></font>
      do k = 1, km<a name='4038'>
        do i = 1, im<a name='4039'>
          if(cnvflg(i) .and. k .le. kmax(i)) then<a name='4040'>
            dellah(i,k) = 0.<a name='4041'>
            dellaq(i,k) = 0.<a name='4042'>
            dellau(i,k) = 0.<a name='4043'>
            dellav(i,k) = 0.<a name='4044'>
          endif<a name='4045'>
        enddo<a name='4046'>
      enddo<a name='4047'>
<font color=#447700>!c<a name='4048'></font>
<font color=#447700>!c--- changed due to subsidence and entrainment<a name='4049'></font>
<font color=#447700>!c<a name='4050'></font>
      do k = 2, km1<a name='4051'>
        do i = 1, im<a name='4052'>
          if (cnvflg(i)) then<a name='4053'>
            if(k.gt.kb(i).and.k.lt.ktcon(i)) then<a name='4054'>
              dp = 1000. * del(i,k)<a name='4055'>
              dz = zi(i,k) - zi(i,k-1)<a name='4056'>
<font color=#447700>!c<a name='4057'></font>
              dv1h = heo(i,k)<a name='4058'>
              dv2h = .5 * (heo(i,k) + heo(i,k-1))<a name='4059'>
              dv3h = heo(i,k-1)<a name='4060'>
              dv1q = qo(i,k)<a name='4061'>
              dv2q = .5 * (qo(i,k) + qo(i,k-1))<a name='4062'>
              dv3q = qo(i,k-1)<a name='4063'>
<font color=#447700>!c<a name='4064'></font>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1))<a name='4065'>
              tem1 = xlamud(i)<a name='4066'>
<font color=#447700>!cj<a name='4067'></font>
              dellah(i,k) = dellah(i,k) +                      &amp;<a name='4068'>
     &amp;     ( eta(i,k)*dv1h - eta(i,k-1)*dv3h                   &amp;<a name='4069'>
     &amp;    -  tem*eta(i,k-1)*dv2h*dz                             &amp;<a name='4070'>
     &amp;    +  tem1*eta(i,k-1)*.5*(hcko(i,k)+hcko(i,k-1))*dz      &amp;<a name='4071'>
     &amp;         ) *g/dp<a name='4072'>
<font color=#447700>!cj<a name='4073'></font>
              dellaq(i,k) = dellaq(i,k) +                       &amp;<a name='4074'>
     &amp;     ( eta(i,k)*dv1q - eta(i,k-1)*dv3q                    &amp;<a name='4075'>
     &amp;    -  tem*eta(i,k-1)*dv2q*dz                               &amp;<a name='4076'>
     &amp;    +  tem1*eta(i,k-1)*.5*(qrcko(i,k)+qcko(i,k-1))*dz        &amp;<a name='4077'>
     &amp;         ) *g/dp<a name='4078'>
<font color=#447700>!cj<a name='4079'></font>
              tem1=eta(i,k)*(uo(i,k)-ucko(i,k))<a name='4080'>
              tem2=eta(i,k-1)*(uo(i,k-1)-ucko(i,k-1))<a name='4081'>
              dellau(i,k) = dellau(i,k) + (tem1-tem2) * g/dp<a name='4082'>
<font color=#447700>!cj<a name='4083'></font>
              tem1=eta(i,k)*(vo(i,k)-vcko(i,k))<a name='4084'>
              tem2=eta(i,k-1)*(vo(i,k-1)-vcko(i,k-1))<a name='4085'>
              dellav(i,k) = dellav(i,k) + (tem1-tem2) * g/dp<a name='4086'>
<font color=#447700>!cj<a name='4087'></font>
            endif<a name='4088'>
          endif<a name='4089'>
        enddo<a name='4090'>
      enddo<a name='4091'>
<font color=#447700>!c<a name='4092'></font>
<font color=#447700>!c------- cloud top<a name='4093'></font>
<font color=#447700>!c<a name='4094'></font>
      do i = 1, im<a name='4095'>
        if(cnvflg(i)) then<a name='4096'>
          indx = ktcon(i)<a name='4097'>
          dp = 1000. * del(i,indx)<a name='4098'>
          dv1h = heo(i,indx-1)<a name='4099'>
          dellah(i,indx) = eta(i,indx-1) *                         &amp;<a name='4100'>
     &amp;                     (hcko(i,indx-1) - dv1h) * g / dp<a name='4101'>
          dv1q = qo(i,indx-1)<a name='4102'>
          dellaq(i,indx) = eta(i,indx-1) *                         &amp;<a name='4103'>
     &amp;                     (qcko(i,indx-1) - dv1q) * g / dp<a name='4104'>
          dellau(i,indx) = eta(i,indx-1) *                          &amp;<a name='4105'>
     &amp;             (ucko(i,indx-1) - uo(i,indx-1)) * g / dp<a name='4106'>
          dellav(i,indx) = eta(i,indx-1) *                          &amp;<a name='4107'>
     &amp;             (vcko(i,indx-1) - vo(i,indx-1)) * g / dp<a name='4108'>
<font color=#447700>!c<a name='4109'></font>
<font color=#447700>!c  cloud water<a name='4110'></font>
<font color=#447700>!c<a name='4111'></font>
          dellal(i,indx) = eta(i,indx-1) *                         &amp;<a name='4112'>
     &amp;                     qlko_ktcon(i) * g / dp<a name='4113'>
        endif<a name='4114'>
      enddo<a name='4115'>
<font color=#447700>!c<a name='4116'></font>
<font color=#447700>!c  mass flux at cloud base for shallow convection<a name='4117'></font>
<font color=#447700>!c  (Grant, 2001)<a name='4118'></font>
<font color=#447700>!c<a name='4119'></font>
      do i= 1, im<a name='4120'>
        if(cnvflg(i)) then<a name='4121'>
          k = kbcon(i)<a name='4122'>
<font color=#447700>!         ptem = g*sflx(i)*zi(i,k)/t1(i,1)<a name='4123'></font>
          ptem = g*sflx(i)*hpbl(i)/t1(i,1)<a name='4124'>
          wstar(i) = ptem**h1<a name='4125'>
          tem = po(i,k)*100. / (rd*to(i,k))<a name='4126'>
          xmb(i) = betaw*tem*wstar(i)<a name='4127'>
        endif<a name='4128'>
      enddo<a name='4129'>
<font color=#447700>!<a name='4130'></font>
<font color=#447700>!--- compute updraft fraction based on Arakawa &amp; Wu (2013)<a name='4131'></font>
<font color=#447700>!    using values at cloud base<a name='4132'></font>
<font color=#447700>!<a name='4133'></font>
<font color=#447700>!  grid-scale vertical velocity at cloud base<a name='4134'></font>
<font color=#447700>!<a name='4135'></font>
      ptem = -0.01 * rd / g<a name='4136'>
      do i = 1, im<a name='4137'>
        wbar(i) = 0.<a name='4138'>
        if (cnvflg(i)) then<a name='4139'>
          k = kbcon(i)<a name='4140'>
          tem  = dot(i,k) * to(i,k) / po(i,k)<a name='4141'>
          wbar(i) = ptem * tem<a name='4142'>
        endif<a name='4143'>
      enddo<a name='4144'>
<font color=#447700>!<a name='4145'></font>
<font color=#447700>!  estimate updraft velocity at cloud base using cloud base mass flux<a name='4146'></font>
<font color=#447700>!<a name='4147'></font>
      ptem = 0.01 * rd<a name='4148'>
      do i = 1, im<a name='4149'>
        wcxmb(i) = 0.<a name='4150'>
        if (cnvflg(i)) then<a name='4151'>
          k = kbcon(i)<a name='4152'>
          tem  = xmb(i) * ptem * to(i,k)  /  po(i,k)<a name='4153'>
          wcxmb(i) = tem / 0.1<a name='4154'>
<font color=#447700>!         wcxmb(i) = tem / 0.03<a name='4155'></font>
        endif<a name='4156'>
      enddo<a name='4157'>
<font color=#447700>!<a name='4158'></font>
<font color=#447700>!  compute updraft fraction<a name='4159'></font>
<font color=#447700>!<a name='4160'></font>
      ptem = 0.01 * rd<a name='4161'>
      do i = 1, im<a name='4162'>
        xmbeta(i) = 0.<a name='4163'>
        if (cnvflg(i)) then<a name='4164'>
          k = kbcon(i)<a name='4165'>
          tem  = to(i,k) / po(i,k)<a name='4166'>
          xmbeta(i) = xmb(i) * ptem * tem<a name='4167'>
        endif<a name='4168'>
      enddo<a name='4169'>
      do i = 1, im<a name='4170'>
        if (cnvflg(i)) then<a name='4171'>
          tem = wcxmb(i) - wbar(i)<a name='4172'>
          val = 1.e-8<a name='4173'>
          tem = max(tem, val)<a name='4174'>
          awlam(i) = xmbeta(i) / tem<a name='4175'>
<font color=#447700>!         awlam(i) = min(awlam(i), 100.)<a name='4176'></font>
        endif<a name='4177'>
      enddo<a name='4178'>
<font color=#447700>!<a name='4179'></font>
      do i = 1, im<a name='4180'>
        if(cnvflg(i)) then<a name='4181'>
          sigmaw(i) = .001<a name='4182'>
          flg(i) = .true.<a name='4183'>
        endif<a name='4184'>
      enddo<a name='4185'>
<font color=#447700>!<a name='4186'></font>
      do i = 1, im<a name='4187'>
        if(cnvflg(i)) then<a name='4188'>
          do n = 1, itsig<a name='4189'>
            if(flg(i)) then<a name='4190'>
              ptem = sigmaw(i)<a name='4191'>
              tem = 1. - ptem<a name='4192'>
              fs0 = awlam(i) * (tem**3.) - ptem<a name='4193'>
              fp1 = -3. * awlam(i) * (tem**2.) - 1.<a name='4194'>
              fp1 = min(fp1, -1.e-3_kind_phys)<a name='4195'>
              sigmaw(i) = ptem - fs0 / fp1<a name='4196'>
              tem1 = abs(sigmaw(i) - ptem)<a name='4197'>
              if(tem1 &lt; .01) then<a name='4198'>
                flg(i)   = .false.<a name='4199'>
              endif<a name='4200'>
            endif<a name='4201'>
          enddo<a name='4202'>
          sigmaw(i) = max(sigmaw(i), 0.001_kind_phys)<a name='4203'>
          sigmaw(i) = min(sigmaw(i), 0.999_kind_phys)<a name='4204'>
        endif<a name='4205'>
      enddo<a name='4206'>
<font color=#447700>!<a name='4207'></font>
<font color=#447700>!--- compute updraft fraction based on Grell &amp; Freitas (2014)<a name='4208'></font>
<font color=#447700>!<a name='4209'></font>
      do i = 1, im<a name='4210'>
        if(cnvflg(i)) then<a name='4211'>
          sigmagf(i) = gfudarea / garea(i)<a name='4212'>
          sigmagf(i) = max(sigmagf(i), 0.001_kind_phys)<a name='4213'>
          sigmagf(i) = min(sigmagf(i), 0.7_kind_phys)<a name='4214'>
        endif<a name='4215'>
      enddo<a name='4216'>
<a name='4217'>
<font color=#447700>!--- modified Grell &amp; Freitas' (2014) updraft fraction which uses<a name='4218'></font>
<font color=#447700>!     actual entrainment rate at cloud base<a name='4219'></font>
<font color=#447700>!<a name='4220'></font>
      do i = 1, im<a name='4221'>
        if(cnvflg(i)) then<a name='4222'>
<font color=#447700>!          k = kbcon(i)<a name='4223'></font>
<font color=#447700>!          tem = 0.2 / max(xlamue(i,k), 3.e-5)<a name='4224'></font>
           tem = min(max(xlamue(i,kbcon(i)), 2.e-4_kind_phys), 6.e-4_kind_phys)<a name='4225'>
           tem = 0.2 / tem<a name='4226'>
<a name='4227'>
          tem1 = 3.14 * tem * tem<a name='4228'>
          sigmagfm(i) = tem1 / garea(i)<a name='4229'>
          sigmagfm(i) = max(sigmagfm(i), 0.001_kind_phys)<a name='4230'>
          sigmagfm(i) = min(sigmagfm(i), 0.999_kind_phys)<a name='4231'>
        endif<a name='4232'>
      enddo<a name='4233'>
<a name='4234'>
<a name='4235'>
<font color=#447700>!<a name='4236'></font>
<font color=#447700>!--- compute scale-aware function based on Arakawa &amp; Wu (2013)<a name='4237'></font>
<font color=#447700>!  using combination of updraft fractions from both<a name='4238'></font>
<font color=#447700>!   Arakawa &amp; Wu (2013) and Grell &amp; Freitas (2014)<a name='4239'></font>
<font color=#447700>!<a name='4240'></font>
<font color=#447700>!<a name='4241'></font>
      do i = 1, im<a name='4242'>
        if(cnvflg(i)) then<a name='4243'>
          tem = 0.001 * sqrt(garea(i))<a name='4244'>
          if (tem &lt; 25.) then<a name='4245'>
<font color=#447700>!           scaldfunc(i) = (1.-sigmaw(i)) * (1.-sigmaw(i))   ! Arakawa &amp; Wu (2013)<a name='4246'></font>
<font color=#447700>!           scaldfunc(i) = (1.-sigmagf(i)) * (1.-sigmagf(i)) ! Grell &amp; Freitas (2014)<a name='4247'></font>
            scaldfunc(i) = (1.-sigmagfm(i)) * (1.-sigmagfm(i)) <font color=#447700>! modified Grell &amp; Freitas(2014)<a name='4248'></font>
<font color=#447700>!            scaldfunc(i) = (1.-sigmaw(i)) * (1.-sigmagf(i))  ! AW &amp; GF<a name='4249'></font>
            scaldfunc(i) = max(min(scaldfunc(i), 1.0_kind_phys), 0._kind_phys)<a name='4250'>
             sigmuout(i) = sigmagfm(i)<a name='4251'>
          else<a name='4252'>
            scaldfunc(i) = 1.0<a name='4253'>
          endif<a name='4254'>
          xmb(i) = xmb(i) * scaldfunc(i)<a name='4255'>
          xmb(i) = min(xmb(i),xmbmax(i))<a name='4256'>
        endif<a name='4257'>
      enddo<a name='4258'>
<font color=#447700>!c<a name='4259'></font>
<font color=#447700>!c!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='4260'></font>
<font color=#447700>!c<a name='4261'></font>
      do k = 1, km<a name='4262'>
        do i = 1, im<a name='4263'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='4264'>
            qeso(i,k) = 0.01 * fpvs(t1(i,k))      <font color=#447700>! fpvs is in pa<a name='4265'></font>
            qeso(i,k) = eps * qeso(i,k) / (pfld(i,k) + epsm1*qeso(i,k))<a name='4266'>
            val     =             1.e-8<a name='4267'>
            qeso(i,k) = max(qeso(i,k), val )<a name='4268'>
          endif<a name='4269'>
        enddo<a name='4270'>
      enddo<a name='4271'>
<font color=#447700>!c!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='4272'></font>
<font color=#447700>!c<a name='4273'></font>
      do i = 1, im<a name='4274'>
        delhbar(i) = 0.<a name='4275'>
        delqbar(i) = 0.<a name='4276'>
        deltbar(i) = 0.<a name='4277'>
        delubar(i) = 0.<a name='4278'>
        delvbar(i) = 0.<a name='4279'>
        qcond(i) = 0.<a name='4280'>
      enddo<a name='4281'>
      do k = 1, km<a name='4282'>
        do i = 1, im<a name='4283'>
          if (cnvflg(i)) then<a name='4284'>
            if(k.gt.kb(i).and.k.le.ktcon(i)) then<a name='4285'>
              dellat = (dellah(i,k) - hvap * dellaq(i,k)) / cp<a name='4286'>
              t1(i,k) = t1(i,k) + dellat * xmb(i) * dt2<a name='4287'>
              q1(i,k) = q1(i,k) + dellaq(i,k) * xmb(i) * dt2<a name='4288'>
<font color=#447700>!             tem = 1./rcs(i)<a name='4289'></font>
<font color=#447700>!             u1(i,k) = u1(i,k) + dellau(i,k) * xmb(i) * dt2 * tem<a name='4290'></font>
<font color=#447700>!             v1(i,k) = v1(i,k) + dellav(i,k) * xmb(i) * dt2 * tem<a name='4291'></font>
              u1(i,k) = u1(i,k) + dellau(i,k) * xmb(i) * dt2<a name='4292'>
              v1(i,k) = v1(i,k) + dellav(i,k) * xmb(i) * dt2<a name='4293'>
              dp = 1000. * del(i,k)<a name='4294'>
              delhbar(i) = delhbar(i) + dellah(i,k)*xmb(i)*dp/g<a name='4295'>
              delqbar(i) = delqbar(i) + dellaq(i,k)*xmb(i)*dp/g<a name='4296'>
              deltbar(i) = deltbar(i) + dellat*xmb(i)*dp/g<a name='4297'>
              delubar(i) = delubar(i) + dellau(i,k)*xmb(i)*dp/g<a name='4298'>
              delvbar(i) = delvbar(i) + dellav(i,k)*xmb(i)*dp/g<a name='4299'>
            endif<a name='4300'>
          endif<a name='4301'>
        enddo<a name='4302'>
      enddo<a name='4303'>
<font color=#447700>!<a name='4304'></font>
      do k = 1, km<a name='4305'>
        do i = 1, im<a name='4306'>
          if (cnvflg(i)) then<a name='4307'>
            if(k.gt.kb(i).and.k.le.ktcon(i)) then<a name='4308'>
              qeso(i,k) = 0.01 * fpvs(t1(i,k))      <font color=#447700>! fpvs is in pa<a name='4309'></font>
              qeso(i,k) = eps * qeso(i,k)/(pfld(i,k) + epsm1*qeso(i,k))<a name='4310'>
              val     =             1.e-8<a name='4311'>
              qeso(i,k) = max(qeso(i,k), val )<a name='4312'>
            endif<a name='4313'>
          endif<a name='4314'>
        enddo<a name='4315'>
      enddo<a name='4316'>
<font color=#447700>!c<a name='4317'></font>
      do i = 1, im<a name='4318'>
        rntot(i) = 0.<a name='4319'>
        delqev(i) = 0.<a name='4320'>
        delq2(i) = 0.<a name='4321'>
        flg(i) = cnvflg(i)<a name='4322'>
      enddo<a name='4323'>
      do k = km, 1, -1<a name='4324'>
        do i = 1, im<a name='4325'>
          if (cnvflg(i)) then<a name='4326'>
            if(k.lt.ktcon(i).and.k.gt.kb(i)) then<a name='4327'>
              rntot(i) = rntot(i) + pwo(i,k) * xmb(i) * .001 * dt2<a name='4328'>
            endif<a name='4329'>
          endif<a name='4330'>
        enddo<a name='4331'>
      enddo<a name='4332'>
<font color=#447700>!c<a name='4333'></font>
<font color=#447700>!c evaporating rain<a name='4334'></font>
<font color=#447700>!c<a name='4335'></font>
      do k = km, 1, -1<a name='4336'>
        do i = 1, im<a name='4337'>
          if (k .le. kmax(i)) then<a name='4338'>
            deltv(i) = 0.<a name='4339'>
            delq(i) = 0.<a name='4340'>
            qevap(i) = 0.<a name='4341'>
            if(cnvflg(i)) then<a name='4342'>
              if(k.lt.ktcon(i).and.k.gt.kb(i)) then<a name='4343'>
                rn(i) = rn(i) + pwo(i,k) * xmb(i) * .001 * dt2<a name='4344'>
              endif<a name='4345'>
            endif<a name='4346'>
            if(flg(i).and.k.lt.ktcon(i)) then<a name='4347'>
              evef = edt(i) * evfact<a name='4348'>
              if(islimsk(i) == 1) evef=edt(i) * evfactl<a name='4349'>
<font color=#447700>!             if(islimsk(i) == 1) evef=.07<a name='4350'></font>
<font color=#447700>!c             if(islimsk(i) == 1) evef = 0.<a name='4351'></font>
              qcond(i) = evef * (q1(i,k) - qeso(i,k))                    &amp;<a name='4352'>
     &amp;                 / (1. + el2orc * qeso(i,k) / t1(i,k)**2)<a name='4353'>
              dp = 1000. * del(i,k)<a name='4354'>
              if(rn(i).gt.0..and.qcond(i).lt.0.) then<a name='4355'>
                qevap(i) = -qcond(i) * (1.-exp(-.32*sqrt(dt2*rn(i))))<a name='4356'>
                qevap(i) = min(qevap(i), rn(i)*1000.*g/dp)<a name='4357'>
                delq2(i) = delqev(i) + .001 * qevap(i) * dp / g<a name='4358'>
              endif<a name='4359'>
              if(rn(i).gt.0..and.qcond(i).lt.0..and.                          &amp;<a name='4360'>
     &amp;           delq2(i).gt.rntot(i)) then<a name='4361'>
                qevap(i) = 1000.* g * (rntot(i) - delqev(i)) / dp<a name='4362'>
                flg(i) = .false.<a name='4363'>
              endif<a name='4364'>
              if(rn(i).gt.0..and.qevap(i).gt.0.) then<a name='4365'>
                tem  = .001 * dp / g<a name='4366'>
                tem1 = qevap(i) * tem<a name='4367'>
                if(tem1.gt.rn(i)) then<a name='4368'>
                  qevap(i) = rn(i) / tem<a name='4369'>
                  rn(i) = 0.<a name='4370'>
                else<a name='4371'>
                  rn(i) = rn(i) - tem1<a name='4372'>
                endif<a name='4373'>
                q1(i,k) = q1(i,k) + qevap(i)<a name='4374'>
                t1(i,k) = t1(i,k) - elocp * qevap(i)<a name='4375'>
                deltv(i) = - elocp*qevap(i)/dt2<a name='4376'>
                delq(i) =  + qevap(i)/dt2<a name='4377'>
                delqev(i) = delqev(i) + .001*dp*qevap(i)/g<a name='4378'>
              endif<a name='4379'>
              delqbar(i) = delqbar(i) + delq(i)*dp/g<a name='4380'>
              deltbar(i) = deltbar(i) + deltv(i)*dp/g<a name='4381'>
            endif<a name='4382'>
          endif<a name='4383'>
        enddo<a name='4384'>
      enddo<a name='4385'>
<font color=#447700>!cj<a name='4386'></font>
<font color=#447700>!     do i = 1, im<a name='4387'></font>
<font color=#447700>!     if(me.eq.31.and.cnvflg(i)) then<a name='4388'></font>
<font color=#447700>!     if(cnvflg(i)) then<a name='4389'></font>
<font color=#447700>!       print *, ' shallow delhbar, delqbar, deltbar = ',<a name='4390'></font>
<font color=#447700>!    &amp;             delhbar(i),hvap*delqbar(i),cp*deltbar(i)<a name='4391'></font>
<font color=#447700>!       print *, ' shallow delubar, delvbar = ',delubar(i),delvbar(i)<a name='4392'></font>
<font color=#447700>!       print *, ' precip =', hvap*rn(i)*1000./dt2<a name='4393'></font>
<font color=#447700>!       print*,'pdif= ',pfld(i,kbcon(i))-pfld(i,ktcon(i))<a name='4394'></font>
<font color=#447700>!     endif<a name='4395'></font>
<font color=#447700>!     enddo<a name='4396'></font>
<font color=#447700>!cj<a name='4397'></font>
      do i = 1, im<a name='4398'>
        if(cnvflg(i)) then<a name='4399'>
          if(rn(i).lt.0..or..not.flg(i)) rn(i) = 0.<a name='4400'>
          ktop(i) = ktcon(i)<a name='4401'>
          kbot(i) = kbcon(i)<a name='4402'>
          kcnv(i) = 2<a name='4403'>
        endif<a name='4404'>
      enddo<a name='4405'>
<font color=#447700>!c<a name='4406'></font>
<font color=#447700>!c  convective cloud water<a name='4407'></font>
<font color=#447700>!c<a name='4408'></font>
      do k = 1, km<a name='4409'>
        do i = 1, im<a name='4410'>
          if (cnvflg(i)) then<a name='4411'>
            if (k.ge.kbcon(i).and.k.lt.ktcon(i)) then<a name='4412'>
              cnvw(i,k) = cnvwt(i,k) * xmb(i) * dt2<a name='4413'>
            endif<a name='4414'>
          endif<a name='4415'>
        enddo<a name='4416'>
      enddo<a name='4417'>
<a name='4418'>
<font color=#447700>!c<a name='4419'></font>
<font color=#447700>!c  convective cloud cover<a name='4420'></font>
<font color=#447700>!c<a name='4421'></font>
      do k = 1, km<a name='4422'>
        do i = 1, im<a name='4423'>
          if (cnvflg(i)) then<a name='4424'>
            if (k.ge.kbcon(i).and.k.lt.ktcon(i)) then<a name='4425'>
              cnvc(i,k) = 0.04 * log(1. + 675. * eta(i,k) * xmb(i))<a name='4426'>
              cnvc(i,k) = min(cnvc(i,k), 0.2_kind_phys)<a name='4427'>
              cnvc(i,k) = max(cnvc(i,k), 0.0_kind_phys)<a name='4428'>
            endif<a name='4429'>
          endif<a name='4430'>
        enddo<a name='4431'>
      enddo<a name='4432'>
<a name='4433'>
<font color=#447700>!c<a name='4434'></font>
<font color=#447700>!c  cloud water<a name='4435'></font>
<font color=#447700>!c<a name='4436'></font>
      if (ncloud.gt.0) then<a name='4437'>
<font color=#447700>!<a name='4438'></font>
      do k = 1, km1<a name='4439'>
        do i = 1, im<a name='4440'>
          if (cnvflg(i)) then<a name='4441'>
<font color=#447700>!            if (k.gt.kb(i).and.k.le.ktcon(i)) then<a name='4442'></font>
            if (k.ge.kbcon(i).and.k.le.ktcon(i)) then<a name='4443'>
              tem  = dellal(i,k) * xmb(i) * dt2<a name='4444'>
              tem1 = max(0.0_kind_phys, min(1.0_kind_phys, (tcr-t1(i,k))*tcrf))<a name='4445'>
              if (ql(i,k,2) .gt. -999.0) then<a name='4446'>
                ql(i,k,1) = ql(i,k,1) + tem * tem1            <font color=#447700>! ice<a name='4447'></font>
                ql(i,k,2) = ql(i,k,2) + tem *(1.0-tem1)       <font color=#447700>! water<a name='4448'></font>
              else<a name='4449'>
                ql(i,k,1) = ql(i,k,1) + tem<a name='4450'>
              endif<a name='4451'>
            endif<a name='4452'>
          endif<a name='4453'>
        enddo<a name='4454'>
      enddo<a name='4455'>
<font color=#447700>!<a name='4456'></font>
      endif<a name='4457'>
<font color=#447700>!<a name='4458'></font>
<font color=#447700>! hchuang code change<a name='4459'></font>
<font color=#447700>!<a name='4460'></font>
      do k = 1, km<a name='4461'>
        do i = 1, im<a name='4462'>
          if(cnvflg(i)) then<a name='4463'>
            if(k.ge.kb(i) .and. k.lt.ktop(i)) then<a name='4464'>
              ud_mf(i,k) = eta(i,k) * xmb(i) * dt2<a name='4465'>
            endif<a name='4466'>
          endif<a name='4467'>
        enddo<a name='4468'>
      enddo<a name='4469'>
      do i = 1, im<a name='4470'>
        if(cnvflg(i)) then<a name='4471'>
           k = ktop(i)-1<a name='4472'>
           dt_mf(i,k) = ud_mf(i,k)<a name='4473'>
        endif<a name='4474'>
      enddo<a name='4475'>
<font color=#447700>!!<a name='4476'></font>
      return<a name='4477'>
      end subroutine scale_shalcnv<a name='4478'>
<a name='4479'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='4480'></font>
      END MODULE module_cu_scalesas<a name='4481'>
<a name='4482'>
</pre></body></html>