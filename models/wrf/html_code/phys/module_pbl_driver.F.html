<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MEDIATION_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<A NAME='MODULE_PBL_DRIVER'><A href='../../html_code/phys/module_pbl_driver.F.html#MODULE_PBL_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
<font color=#993300>MODULE </font><font color=#cc0000>module_pbl_driver</font> <A href='../../call_to/MODULE_PBL_DRIVER.html' TARGET='index'>2</A><a name='6'>
CONTAINS<a name='7'>
<a name='8'>
<font color=#447700>!------------------------------------------------------------------<a name='9'></font>
<A NAME='PBL_DRIVER'><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='10'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>pbl_driver</font>(                                          &amp; <A href='../../call_to/PBL_DRIVER.html' TARGET='index'>2</A>,<A href='../../call_from/PBL_DRIVER.html' TARGET='index'>86</A><a name='11'>
                  itimestep,dt,u_frame,v_frame                     &amp;<a name='12'>
                 ,bldt,curr_secs,adapt_step_flag                   &amp;<a name='13'>
                 ,bldtacttime                                      &amp; <a name='14'>
                 ,rublten,rvblten,rthblten                         &amp;<a name='15'>
                 ,tsk,xland,znt                                    &amp;<a name='16'>
#if (HWRF==1)<a name='17'>
                 ,msang,scurx,scury,iwavecpl,lcurr_sf              &amp;<a name='18'>
                 ,mznt                                             &amp;<a name='19'>
#endif<a name='20'>
                 ,ht                                               &amp;   <a name='21'>
                 ,ust,pblh,hfx,qfx,grdflx                          &amp;<a name='22'>
                 ,u_phy,v_phy,w,th_phy,rho                         &amp;<a name='23'>
                 ,p_phy,pi_phy,p8w,t_phy,dz8w,z                    &amp;<a name='24'>
                 ,exch_h,exch_m,akhs,akms                          &amp;<a name='25'>
                 ,thz0,qz0,uz0,vz0,qsfc,f                          &amp;<a name='26'>
                 ,lowlyr,u10,v10,uoce,voce,t2                      &amp;<a name='27'>
                 ,psim,psih,fm,fhh,gz1oz0, wspd,br,chklowq         &amp;<a name='28'>
                 ,bl_pbl_physics, ra_lw_physics, dx, dy            &amp;<a name='29'>
                 ,stepbl,warm_rain                                 &amp;<a name='30'>
                 ,kpbl,mixht,ct,lh,snow,xice                       &amp;<a name='31'>
                 ,znu, znw, mut, p_top                             &amp;<a name='32'>
<font color=#447700>! paj<a name='33'></font>
                 ,ctopo,ctopo2,windfarm_opt,power                  &amp;<a name='34'>
                 ,ysu_topdown_pblmix                               &amp;<a name='35'>
                 ,shinhong_tke_diag                                &amp;<a name='36'>
              <font color=#447700>! OPTIONAL for TEMF scheme<a name='37'></font>
                 ,te_temf,km_temf,kh_temf                     &amp;<a name='38'>
                 ,shf_temf,qf_temf,uw_temf,vw_temf                &amp;<a name='39'>
                 ,hd_temf,lcl_temf,hct_temf                       &amp;<a name='40'>
                 ,wupd_temf,mf_temf,thup_temf,qtup_temf,qlup_temf &amp;<a name='41'>
                 ,exch_temf,cf3d_temf,cfm_temf                    &amp;<a name='42'>
                 ,flhc,flqc                                        &amp;<a name='43'>
              <font color=#447700>! MYNN<a name='44'></font>
                 ,qke,Sh3d                                         &amp;<a name='45'>
                 ,qke_adv,bl_mynn_tkeadvect                        &amp; <font color=#447700>!ACF for QKE advection<a name='46'></font>
                 ,tsq,qsq,cov,rmol,ch,qcg,grav_settling            &amp; <a name='47'>
                 ,dqke,qWT,qSHEAR,qBUOY,qDISS,bl_mynn_tkebudget    &amp;<a name='48'>
                 ,bl_mynn_cloudpdf                                 &amp;<a name='49'>
                 ,bl_mynn_mixlength                                &amp;<a name='50'>
                 ,icloud_bl,qc_bl,cldfra_bl                        &amp;<a name='51'>
                 ,bl_mynn_edmf,bl_mynn_edmf_mom,bl_mynn_edmf_tke   &amp;<a name='52'>
                 ,bl_mynn_edmf_part                                &amp;<a name='53'>
                 ,bl_mynn_cloudmix,bl_mynn_mixqt                   &amp;<a name='54'>
                 ,edmf_a,edmf_w,edmf_thl                           &amp;<a name='55'>
                 ,edmf_qt,edmf_ent,edmf_qc                         &amp;<a name='56'>
                 ,vdfg                                             &amp;<a name='57'>
                 ,spp_pbl,pattern_spp_pbl                          &amp;<a name='58'>
#if (NMM_CORE==1)<a name='59'>
                 ,DISHEAT                                          &amp;<a name='60'>
                 ,HPBL2D, EVAP2D, HEAT2D, RC2D                     &amp;   <font color=#447700>!Kwon FOR SHAL. CON.<a name='61'></font>
#if ( HWRF == 1 )<a name='62'>
                 ,VAR_RIC                                          &amp;   <font color=#447700>!Kwon for Variable Ric<a name='63'></font>
#endif<a name='64'>
                 ,DKU3D,DKT3D                                      &amp;<a name='65'>
#endif<a name='66'>
#if (HWRF==1)<a name='67'>
                 ,coef_ric_l,coef_ric_s,gfs_alpha                  &amp;<a name='68'>
                 ,pert_pbl, ens_random_seed, ens_pblamp            &amp;<a name='69'>
#endif<a name='70'>
                 ,ids,ide, jds,jde, kds,kde                        &amp;<a name='71'>
                 ,ims,ime, jms,jme, kms,kme                        &amp;<a name='72'>
                 ,i_start,i_end, j_start,j_end, kts,kte, num_tiles &amp;<a name='73'>
             <font color=#447700>! Optional<a name='74'></font>
                 ,hol, mol, regime                                 &amp;<a name='75'>
             <font color=#447700>! Optional gravity-wave drag             <a name='76'></font>
                 ,gwd_opt                                          &amp;<a name='77'>
                 ,dtaux3d,dtauy3d                                  &amp;<a name='78'>
                 ,dusfcg,dvsfcg,var2d,oc12d                        &amp;<a name='79'>
                 ,oa1,oa2,oa3,oa4,ol1,ol2,ol3,ol4                  &amp;<a name='80'>
             <font color=#447700>!  Optional moisture tracers<a name='81'></font>
                 ,qv_curr, qc_curr, qr_curr                        &amp;<a name='82'>
                 ,qi_curr, qs_curr, qg_curr                        &amp;<a name='83'>
                 ,rqvblten,rqcblten,rqiblten                       &amp;<a name='84'>
                 ,rqrblten,rqsblten,rqgblten                       &amp;<a name='85'>
             <font color=#447700>!  Optional moisture tracer flags<a name='86'></font>
                 ,f_qv,f_qc,f_qr                                   &amp;<a name='87'>
                 ,f_qi,f_qs,f_qg                                   &amp;<a name='88'>
<font color=#447700>! variables added for BEP<a name='89'></font>
               ,frc_urb2d                                  &amp;<a name='90'>
               ,a_u_bep,a_v_bep,a_t_bep,a_q_bep            &amp;<a name='91'>
               ,b_u_bep,b_v_bep,b_t_bep,b_q_bep            &amp;<a name='92'>
               ,sf_bep,vl_bep                              &amp;<a name='93'>
               ,sf_sfclay_physics,sf_urban_physics         &amp;<a name='94'>
               ,tke_pbl,el_pbl                             &amp;<a name='95'>
#if (NMM_CORE <font color=#447700>!= 1)<a name='96'></font>
               ,wu_tur,wv_tur,wt_tur,wq_tur &amp;<a name='97'>
#endif<a name='98'>
<font color=#447700>! variables  for GBM PBL<a name='99'></font>
               ,exch_tke, rthraten                         &amp;<a name='100'>
               ,a_e_bep,b_e_bep,dlg_bep,dl_u_bep           &amp;<a name='101'>
               ,mfshconv, massflux_EDKF, entr_EDKF, detr_EDKF    &amp; <a name='102'>
               ,thl_up, thv_up, rt_up ,rv_up, rc_up, u_up, v_up    &amp;<a name='103'>
               ,frac_up,rc_mf                                      &amp; <a name='104'>
<font color=#447700>! Wind Turbine Parameterizations<a name='105'></font>
               ,phb,xlat_u,xlong_u,xlat_v,xlong_v,id                 &amp;<a name='106'>
<font color=#447700>! variables required for camuwpbl scheme<a name='107'></font>
               , z_at_w,cldfra_old_mp,cldfra, rthratenlw             &amp;<a name='108'>
               , tauresx2d,tauresy2d                                 &amp;<a name='109'>
               , tpert2d,qpert2d,wpert2d,wsedl3d                     &amp;<a name='110'>
               , turbtype3d,smaw3d                                   &amp;<a name='111'>
               , fnm,fnp                                             &amp;<a name='112'>
<font color=#447700>! variables required for camuwpbl scheme (optional)               <a name='113'></font>
               ,qnc_curr,f_qnc,qni_curr,f_qni,rqniblten              &amp;<a name='114'>
               ,IS_CAMMGMP_USED                                      &amp;<a name='115'>
<font color=#447700>! for grims shallow convection with ysupbl/MYNN<a name='116'></font>
               , wstar,delta                                         &amp;<a name='117'>
<font color=#447700>! for pbl mixing of scalars and tracers<a name='118'></font>
     &amp;        ,scalar,scalar_tend,num_scalar                         &amp;<a name='119'>
     &amp;        ,tracer,tracer_tend,num_tracer                         &amp;<a name='120'>
     &amp;        ,scalar_pblmix,tracer_pblmix                           &amp;<a name='121'>
#if (WRF_CHEM == 1)<a name='122'>
               ,chem,vd,nchem,kdvel,ndvel,num_vert_mix             &amp;<a name='123'>
#endif<a name='124'>
<font color=#447700>!<a name='125'></font>
<font color=#447700>! FASDAS<a name='126'></font>
<font color=#447700>!<a name='127'></font>
              ,QNORM, fasdas           &amp;<a name='128'>
<font color=#447700>!<a name='129'></font>
<font color=#447700>! END FASDAS<a name='130'></font>
<font color=#447700>!<a name='131'></font>
                                                                     )<a name='132'>
       <a name='133'>
<font color=#447700>!------------------------------------------------------------------<a name='134'></font>
#if (EM_CORE==1)<a name='135'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_135">, ONLY :                            &amp;<a name='136'>
                   YSUSCHEME,MRFSCHEME,GFSSCHEME,MYJPBLSCHEME,ACMPBLSCHEME,&amp;<a name='137'>
                   QNSEPBLSCHEME,MYNNPBLSCHEME2,MYNNPBLSCHEME3,BOULACSCHEME,&amp;<a name='138'>
                   CAMUWPBLSCHEME,BEPSCHEME,BEP_BEMSCHEME,MYJSFCSCHEME, &amp;<a name='139'>
                   FITCHSCHEME,SHINHONGSCHEME,                       &amp;<a name='140'>
                   TEMFPBLSCHEME,GBMPBLSCHEME,                       &amp;<a name='141'>
                   CAMMGMPSCHEME,p_qi,p_qni,p_qnc,param_first_scalar  <font color=#447700>!CAMMGMPSCHEME, p_qni,p_qnc is used for camuwpbl scheme<a name='142'></font>
#else<a name='143'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_136">, ONLY :                            &amp;<a name='144'>
                   YSUSCHEME,MRFSCHEME,GFSSCHEME,MYJPBLSCHEME,ACMPBLSCHEME &amp;<a name='145'>
                   , QNSEPBLSCHEME, p_qi,param_first_scalar &amp;<a name='146'>
                   , TEMFPBLSCHEME, GFSEDMFSCHEME           &amp;<a name='147'>
                   , CAMUWPBLSCHEME                                       &amp;<a name='148'>
                   , FITCHSCHEME, SHINHONGSCHEME                          &amp;<a name='149'>
                   , GBMPBLSCHEME, MYJSFCSCHEME<a name='150'>
#endif<a name='151'>
<a name='152'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_79"><a name='153'>
<a name='154'>
<font color=#447700>! *** add new modules of schemes here<a name='155'></font>
<a name='156'>
   USE <A href='../../html_code/phys/module_bl_myjpbl.F.html#MODULE_BL_MYJPBL'>module_bl_myjpbl</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_MYJPBL_1"><a name='157'>
   USE <A href='../../html_code/phys/module_bl_qnsepbl.F.html#MODULE_BL_QNSEPBL'>module_bl_qnsepbl</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_QNSEPBL_1"><a name='158'>
   USE <A href='../../html_code/phys/module_bl_ysu.F.html#MODULE_BL_YSU'>module_bl_ysu</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_YSU_1"><a name='159'>
   USE <A href='../../html_code/phys/module_bl_shinhong.F.html#MODULE_BL_SHINHONG'>module_bl_shinhong</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_SHINHONG_1"><a name='160'>
   USE <A href='../../html_code/phys/module_bl_mrf.F.html#MODULE_BL_MRF'>module_bl_mrf</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_MRF_1"><a name='161'>
   USE <A href='../../html_code/phys/module_bl_gfs.F.html#MODULE_BL_GFS'>module_bl_gfs</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_GFS_1"><a name='162'>
#if (HWRF==1)<a name='163'>
   USE <A href='../../html_code/phys/module_bl_gfsedmf.F.html#MODULE_BL_GFSEDMF'>module_bl_gfsedmf</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_GFSEDMF_1">, only: bl_gfsedmf<a name='164'>
#endif<a name='165'>
   USE <A href='../../html_code/phys/module_bl_acm.F.html#MODULE_BL_ACM'>module_bl_acm</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_ACM_1"><a name='166'>
   USE <A href='../../html_code/phys/module_bl_gwdo.F.html#MODULE_BL_GWDO'>module_bl_gwdo</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_GWDO_1"><a name='167'>
   USE <A href='../../html_code/phys/module_bl_myjurb.F.html#MODULE_BL_MYJURB'>module_bl_myjurb</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_MYJURB_1"><a name='168'>
   USE <A href='../../html_code/phys/module_bl_boulac.F.html#MODULE_BL_BOULAC'>module_bl_boulac</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_BOULAC_1"><a name='169'>
   USE <A href='../../html_code/phys/module_bl_camuwpbl_driver.F.html#MODULE_BL_CAMUWPBL_DRIVER'>module_bl_camuwpbl_driver</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_CAMUWPBL_DRIVER_1">, only:CAMUWPBL<a name='170'>
   USE <A href='../../html_code/phys/module_bl_temf.F.html#MODULE_BL_TEMF'>module_bl_temf</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_TEMF_1"><a name='171'>
   USE <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MODULE_BL_MFSHCONVPBL'>module_bl_mfshconvpbl</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_MFSHCONVPBL_1"><a name='172'>
   USE <A href='../../html_code/phys/module_bl_gbmpbl.F.html#MODULE_BL_GBMPBL'>module_bl_gbmpbl</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_GBMPBL_1"><a name='173'>
#if (EM_CORE==1)<a name='174'>
   USE <A href='../../html_code/phys/module_bl_mynn.F.html#MODULE_BL_MYNN'>module_bl_mynn</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_MYNN_2"><a name='175'>
   USE <A href='../../html_code/phys/module_bl_fogdes.F.html#MODULE_BL_FOGDES'>module_bl_fogdes</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_FOGDES_1"><a name='176'>
   USE <A href='../../html_code/phys/module_wind_fitch.F.html#MODULE_WIND_FITCH'>module_wind_fitch</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WIND_FITCH_1"><a name='177'>
#endif<a name='178'>
<a name='179'>
   <font color=#447700>!  This driver calls subroutines for the PBL parameterizations.<a name='180'></font>
   <font color=#447700>!<a name='181'></font>
   <font color=#447700>!  pbl scheme:<a name='182'></font>
   <font color=#447700>!      1. ysupbl<a name='183'></font>
   <font color=#447700>!      2. myjpbl<a name='184'></font>
   <font color=#447700>!      4. qnsepbl<a name='185'></font>
   <font color=#447700>!      5. mynnpbl2<a name='186'></font>
   <font color=#447700>!      6. mynnpbl3<a name='187'></font>
   <font color=#447700>!      7. acmpbl<a name='188'></font>
   <font color=#447700>!      8. boulacpbl<a name='189'></font>
   <font color=#447700>!      9. camuwpbl<a name='190'></font>
   <font color=#447700>!      10. temfpbl<a name='191'></font>
   <font color=#447700>!      11. shinhongpbl<a name='192'></font>
   <font color=#447700>!      99. mrfpbl<a name='193'></font>
   <font color=#447700>!      12. gbmpbl<a name='194'></font>
   <font color=#447700>!<a name='195'></font>
<font color=#447700>!------------------------------------------------------------------<a name='196'></font>
   IMPLICIT NONE<a name='197'>
<font color=#447700>!======================================================================<a name='198'></font>
<font color=#447700>! Grid structure in physics part of WRF<a name='199'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='200'></font>
<font color=#447700>! The horizontal velocities used in the physics are unstaggered<a name='201'></font>
<font color=#447700>! relative to temperature/moisture variables. All predicted<a name='202'></font>
<font color=#447700>! variables are carried at half levels except w, which is at full<a name='203'></font>
<font color=#447700>! levels. Some arrays with names (*8w) are at w (full) levels.<a name='204'></font>
<font color=#447700>!<a name='205'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='206'></font>
<font color=#447700>! In WRF, kms (smallest number) is the bottom level and kme (largest<a name='207'></font>
<font color=#447700>! number) is the top level.  In your scheme, if 1 is at the top level,<a name='208'></font>
<font color=#447700>! then you have to reverse the order in the k direction.<a name='209'></font>
<font color=#447700>!<a name='210'></font>
<font color=#447700>!         kme      -   half level (no data at this level)<a name='211'></font>
<font color=#447700>!         kme    ----- full level<a name='212'></font>
<font color=#447700>!         kme-1    -   half level<a name='213'></font>
<font color=#447700>!         kme-1  ----- full level<a name='214'></font>
<font color=#447700>!         .<a name='215'></font>
<font color=#447700>!         .<a name='216'></font>
<font color=#447700>!         .<a name='217'></font>
<font color=#447700>!         kms+2    -   half level<a name='218'></font>
<font color=#447700>!         kms+2  ----- full level<a name='219'></font>
<font color=#447700>!         kms+1    -   half level<a name='220'></font>
<font color=#447700>!         kms+1  ----- full level<a name='221'></font>
<font color=#447700>!         kms      -   half level<a name='222'></font>
<font color=#447700>!         kms    ----- full level<a name='223'></font>
<font color=#447700>!<a name='224'></font>
<font color=#447700>!======================================================================<a name='225'></font>
<font color=#447700>! Definitions<a name='226'></font>
<font color=#447700>!-----------<a name='227'></font>
<font color=#447700>! Rho_d      dry density (kg/m^3)<a name='228'></font>
<font color=#447700>! Theta_m    moist potential temperature (K)<a name='229'></font>
<font color=#447700>! Qv         water vapor mixing ratio (kg/kg)<a name='230'></font>
<font color=#447700>! Qc         cloud water mixing ratio (kg/kg)<a name='231'></font>
<font color=#447700>! Qr         rain water mixing ratio (kg/kg)<a name='232'></font>
<font color=#447700>! Qi         cloud ice mixing ratio (kg/kg)<a name='233'></font>
<font color=#447700>! Qs         snow mixing ratio (kg/kg)<a name='234'></font>
<font color=#447700>! QNC        cloud Liq number concentration (#/kg) !For CAMUWPBL scheme<a name='235'></font>
<font color=#447700>! QNI        cloud ice number concentration (#/kg) !For CAMUWPBL scheme<a name='236'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='237'></font>
<font color=#447700>!-- RUBLTEN       U tendency due to <a name='238'></font>
<font color=#447700>!                 PBL parameterization (m/s^2)<a name='239'></font>
<font color=#447700>!-- RVBLTEN       V tendency due to <a name='240'></font>
<font color=#447700>!                 PBL parameterization (m/s^2)<a name='241'></font>
<font color=#447700>!-- RTHBLTEN      Theta tendency due to <a name='242'></font>
<font color=#447700>!                 PBL parameterization (K/s)<a name='243'></font>
<font color=#447700>!-- RQVBLTEN      Qv tendency due to <a name='244'></font>
<font color=#447700>!                 PBL parameterization (kg/kg/s)<a name='245'></font>
<font color=#447700>!-- RQCBLTEN      Qc tendency due to <a name='246'></font>
<font color=#447700>!                 PBL parameterization (kg/kg/s)<a name='247'></font>
<font color=#447700>!-- RQIBLTEN      Qi tendency due to <a name='248'></font>
<font color=#447700>!                 PBL parameterization (kg/kg/s)<a name='249'></font>
<font color=#447700>!-- RQNIBLTEN     Qni tendency due to <a name='250'></font>
<font color=#447700>!                 PBL parameterization (#/kg/s) !For CAMUWPBL scheme<a name='251'></font>
<font color=#447700>!-- id            WRF grid id  (optional, only needed by turbine drag schemes)<a name='252'></font>
<font color=#447700>!-- itimestep     number of time steps<a name='253'></font>
<font color=#447700>!-- GLW           downward long wave flux at ground surface (W/m^2)<a name='254'></font>
<font color=#447700>!-- GSW           downward short wave flux at ground surface (W/m^2)<a name='255'></font>
<font color=#447700>!-- EMISS         surface emissivity (between 0 and 1)<a name='256'></font>
<font color=#447700>!-- TSK           surface temperature (K)<a name='257'></font>
<font color=#447700>!-- TMN           soil temperature at lower boundary (K)<a name='258'></font>
<font color=#447700>!-- XLAND         land mask (1 for land, 2 for water)<a name='259'></font>
<font color=#447700>!-- ZNT           thermal roughness length (m)<a name='260'></font>
<font color=#447700>!-- MZNT          momentum roughness length (m)<a name='261'></font>
<font color=#447700>!-- MAVAIL        surface moisture availability (between 0 and 1)<a name='262'></font>
<font color=#447700>!-- UST           u* in similarity theory (m/s)<a name='263'></font>
<font color=#447700>!-- MOL           T* (similarity theory) (K)<a name='264'></font>
<font color=#447700>!-- HOL           PBL height over Monin-Obukhov length<a name='265'></font>
<font color=#447700>!-- PBLH          PBL height (m)<a name='266'></font>
<font color=#447700>!-- CAPG          heat capacity for soil (J/K/m^3)<a name='267'></font>
<font color=#447700>!-- THC           thermal inertia (Cal/cm/K/s^0.5)<a name='268'></font>
<font color=#447700>!-- SNOWC         flag indicating snow coverage (1 for snow cover)<a name='269'></font>
<font color=#447700>!-- HFX           upward heat flux at the surface (W/m^2)<a name='270'></font>
<font color=#447700>!-- QFX           upward moisture flux at the surface (kg/m^2/s)<a name='271'></font>
<font color=#447700>!-- REGIME        flag indicating PBL regime (stable, unstable, etc.)<a name='272'></font>
<font color=#447700>!-- exch_m        exchange coefficient for momentum, m^2/s<a name='273'></font>
<font color=#447700>!-- exch_h        exchange coefficient for heat, K m/s <a name='274'></font>
<font color=#447700>!-- exch_tke      exchange coeff. for TKE [enhanced], m^2/s (gbmpbl scheme)<a name='275'></font>
<font color=#447700>!-- rthraten      tendency from radiation, used in GBM PBL scheme<a name='276'></font>
<font color=#447700>!-- akhs          sfc exchange coefficient of heat/moisture from MYJ<a name='277'></font>
<font color=#447700>!-- akms          sfc exchange coefficient of momentum from MYJ<a name='278'></font>
<font color=#447700>!-- tke_pbl       turbulence kinetic energy from PBL schemes (m^2/s^2)<a name='279'></font>
<font color=#447700>!-- el_pbl        length scale from PBL schemes (m)<a name='280'></font>
<font color=#447700>!-- wu_tur        turbulent flux of momentum (x) (m^2/s^2)<a name='281'></font>
<font color=#447700>!-- wv_tur        turbulent flux of momentum (y) (m^2/s^2)<a name='282'></font>
<font color=#447700>!-- wt_tur        turbulent flux of potential temperature  (K m/s)<a name='283'></font>
<font color=#447700>!-- wq_tur        turbulent flux of water vapor  (- m/s)<a name='284'></font>
<font color=#447700>!-- te_temf       Total energy from TEMF BL scheme<a name='285'></font>
<font color=#447700>!-- km_temf       Exchange coefficient for momentum from TEMF BL scheme<a name='286'></font>
<font color=#447700>!-- kh_temf       Exchange coefficient for heat from TEMF BL scheme<a name='287'></font>
<font color=#447700>!-- shf_temf      Sensible heat flux from TEMF BL scheme<a name='288'></font>
<font color=#447700>!-- qf_temf       Water vapor flux from TEMF BL scheme<a name='289'></font>
<font color=#447700>!-- uw_temf       Momentum flux in U direction from TEMF BL scheme<a name='290'></font>
<font color=#447700>!-- vw_temf       Momentum flux in V direction from TEMF BL scheme<a name='291'></font>
<font color=#447700>!-- wupd_temf     Updraft velocity from TEMF BL scheme<a name='292'></font>
<font color=#447700>!-- mf_temf       Mass flux from TEMF BL scheme<a name='293'></font>
<font color=#447700>!-- thup_temf     Updraft thetal from TEMF BL scheme<a name='294'></font>
<font color=#447700>!-- qtup_temf     Updraft qt from TEMF BL scheme<a name='295'></font>
<font color=#447700>!-- qlup_temf     Updraft ql from TEMF BL scheme<a name='296'></font>
<font color=#447700>!-- cf3d_temf     3D cloud fraction from TEMF PBL<a name='297'></font>
<font color=#447700>!-- cfm_temf      Column cloud fraction from TEMF PBL<a name='298'></font>
<font color=#447700>!-- exch_temf     Surface exchange coefficient (as for moisture) from TEMF surface layer scheme<a name='299'></font>
<font color=#447700>!-- flhc          Surface exchange coefficient for heat (for TEMF)<a name='300'></font>
<font color=#447700>!-- flqc          Surface exchange coefficient for moisture (for TEMF)<a name='301'></font>
<font color=#447700>!-- thz0          potential temperature at roughness length (K)<a name='302'></font>
<font color=#447700>!-- uz0           u wind component at roughness length (m/s)<a name='303'></font>
<font color=#447700>!-- vz0           v wind component at roughness length (m/s)<a name='304'></font>
<font color=#447700>!-- qsfc          specific humidity at lower boundary (kg/kg)<a name='305'></font>
<font color=#447700>!-- UOCE          sea surface zonal currents (m s-1)<a name='306'></font>
<font color=#447700>!-- VOCE          sea surface meridional currents (m s-1)<a name='307'></font>
<font color=#447700>!-- th2           diagnostic 2-m theta from surface layer and lsm<a name='308'></font>
<font color=#447700>!-- t2            diagnostic 2-m temperature from surface layer and lsm<a name='309'></font>
<font color=#447700>!-- q2            diagnostic 2-m mixing ratio from surface layer and lsm<a name='310'></font>
<font color=#447700>!-- lowlyr        index of lowest model layer above ground<a name='311'></font>
<font color=#447700>!-- rr            dry air density (kg/m^3)<a name='312'></font>
<font color=#447700>!-- u_phy         u-velocity interpolated to theta points (m/s)<a name='313'></font>
<font color=#447700>!-- v_phy         v-velocity interpolated to theta points (m/s)<a name='314'></font>
<font color=#447700>!-- th_phy        potential temperature (K)<a name='315'></font>
<font color=#447700>!-- p_phy         pressure (Pa)<a name='316'></font>
<font color=#447700>!-- pi_phy        exner function (dimensionless)<a name='317'></font>
<font color=#447700>!-- p8w           pressure at full levels (Pa)<a name='318'></font>
<font color=#447700>!-- t_phy         temperature (K)<a name='319'></font>
<font color=#447700>!-- dz8w          dz between full levels (m)<a name='320'></font>
<font color=#447700>!-- z             height above sea level (m)<a name='321'></font>
<font color=#447700>!-- DX            horizontal space interval (m)<a name='322'></font>
<font color=#447700>!-- DT            time step (second)<a name='323'></font>
<font color=#447700>!-- n_moist       number of moisture species<a name='324'></font>
<font color=#447700>!-- PSFC          pressure at the surface (Pa)<a name='325'></font>
<font color=#447700>!-- TSLB          <a name='326'></font>
<font color=#447700>!-- ZS<a name='327'></font>
<font color=#447700>!-- DZS<a name='328'></font>
<font color=#447700>!-- num_soil_layers number of soil layer<a name='329'></font>
<font color=#447700>!-- IFSNOW      ifsnow=1 for snow-cover effects<a name='330'></font>
<font color=#447700>!-- z_at_w      Height above sea level at layer interfaces (m) <a name='331'></font>
<font color=#447700>!-- cldfra      Cloud fraction [unitless]<a name='332'></font>
<font color=#447700>!-- cldfra_old_mp      Cloud fraction [unitless]<a name='333'></font>
<font color=#447700>!-- rthratenlw  Tendency for LW ( K/s)<a name='334'></font>
<font color=#447700>!-- tauresx2d   X-COMP OF RESIDUAL STRESS(m^2/s^2)<a name='335'></font>
<font color=#447700>!-- tauresy2d   Y-COMP OF RESIDUAL STRESS(m^2/s^2)<a name='336'></font>
<font color=#447700>!-- tpert2d     Convective temperature excess (K)<a name='337'></font>
<font color=#447700>!-- qpert2d     Convective humidity excess (kg/kg)<a name='338'></font>
<font color=#447700>!-- wpert2d     Turbulent velocity excess (m/s)<a name='339'></font>
<font color=#447700>!-- wsedl3d     Sedimentation velocity of stratiform liquid cloud droplet (m/s)<a name='340'></font>
<font color=#447700>!-- turbtype3d  Turbulent interface types [ no unit ]  <a name='341'></font>
<font color=#447700>!-- smaw3d      Normalized Galperin instability function for momentum  ( 0&lt;= &lt;=4.964 and 1 at neutral ) [no units]<a name='342'></font>
<font color=#447700>!<a name='343'></font>
<font color=#447700>!-- P_QV          species index for water vapor<a name='344'></font>
<font color=#447700>!-- P_QC          species index for cloud water<a name='345'></font>
<font color=#447700>!-- P_QR          species index for rain water<a name='346'></font>
<font color=#447700>!-- P_QI          species index for cloud ice<a name='347'></font>
<font color=#447700>!-- P_QNC         species index for cloud liq number concentration !For CAMUWPBL scheme<a name='348'></font>
<font color=#447700>!-- P_QNI         species index for cloud ice number concentration !For CAMUWPBL scheme<a name='349'></font>
<font color=#447700>!-- P_QS          species index for snow<a name='350'></font>
<font color=#447700>!-- P_QG          species index for graupel<a name='351'></font>
<font color=#447700>!-- ids           start index for i in domain<a name='352'></font>
<font color=#447700>!-- ide           end index for i in domain<a name='353'></font>
<font color=#447700>!-- jds           start index for j in domain<a name='354'></font>
<font color=#447700>!-- jde           end index for j in domain<a name='355'></font>
<font color=#447700>!-- kds           start index for k in domain<a name='356'></font>
<font color=#447700>!-- kde           end index for k in domain<a name='357'></font>
<font color=#447700>!-- ims           start index for i in memory<a name='358'></font>
<font color=#447700>!-- ime           end index for i in memory<a name='359'></font>
<font color=#447700>!-- jms           start index for j in memory<a name='360'></font>
<font color=#447700>!-- jme           end index for j in memory<a name='361'></font>
<font color=#447700>!-- kms           start index for k in memory<a name='362'></font>
<font color=#447700>!-- kme           end index for k in memory<a name='363'></font>
<font color=#447700>!-- jts           start index for j in tile<a name='364'></font>
<font color=#447700>!-- jte           end index for j in tile<a name='365'></font>
<font color=#447700>!-- kts           start index for k in tile<a name='366'></font>
<font color=#447700>!-- kte           end index for k in tile<a name='367'></font>
<font color=#447700>!<a name='368'></font>
<font color=#447700>!******************************************************************<a name='369'></font>
<font color=#447700>!------------------------------------------------------------------ <a name='370'></font>
<font color=#447700>!<a name='371'></font>
<a name='372'>
<a name='373'>
   INTEGER,    INTENT(IN   )    ::     bl_pbl_physics, ra_lw_physics,sf_sfclay_physics,sf_urban_physics,windfarm_opt<a name='374'>
   INTEGER,    INTENT(IN   )    ::     ysu_topdown_pblmix<a name='375'>
   INTEGER,    OPTIONAL,  INTENT(IN   )    ::     shinhong_tke_diag<a name='376'>
   INTEGER,    OPTIONAL,  INTENT(IN   )    ::     scalar_pblmix, tracer_pblmix<a name='377'>
<a name='378'>
   INTEGER,    INTENT(IN   )    ::     ids,ide, jds,jde, kds,kde, &amp;<a name='379'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='380'>
                                       kts,kte, num_tiles<a name='381'>
   INTEGER,    INTENT(IN   )    ::     num_scalar, num_tracer<a name='382'>
<a name='383'>
   INTEGER, DIMENSION(num_tiles), INTENT(IN) ::                   &amp;<a name='384'>
  &amp;                                    i_start,i_end,j_start,j_end<a name='385'>
<a name='386'>
   INTEGER,    INTENT(IN   )    ::     itimestep,STEPBL<a name='387'>
   INTEGER,    DIMENSION( ims:ime , jms:jme ),                    &amp;<a name='388'>
               INTENT(IN   )    ::                        LOWLYR<a name='389'>
<font color=#447700>!<a name='390'></font>
   LOGICAL,      INTENT(IN   )    ::   warm_rain<a name='391'>
   LOGICAL,      INTENT(IN   )    ::   is_CAMMGMP_used <font color=#447700>!BSINGH:01/31/2013: Added for CAMUWPBL<a name='392'></font>
#if (HWRF==1)<a name='393'>
   INTEGER,      INTENT(IN   )    ::   iwavecpl<a name='394'>
   LOGICAL,      INTENT(IN   )    ::   lcurr_sf<a name='395'>
#endif<a name='396'>
#if (NMM_CORE==1)<a name='397'>
   LOGICAL,      INTENT(IN   )    ::   DISHEAT <font color=#447700>! (for HWRF)<a name='398'></font>
   REAL, DIMENSION( ims:ime , jms:jme ),                         &amp;<a name='399'>
                   INTENT(OUT) ::  HPBL2D, EVAP2D, HEAT2D, RC2D      <font color=#447700>!Kwon for Shallow Convection<a name='400'></font>
<a name='401'>
   REAL, DIMENSION( ims:ime , jms:jme , kms:kme ),                         &amp;<a name='402'>
                   INTENT(OUT) ::  DKU3D,DKT3D                      <font color=#447700>!Kwon duffusivity<a name='403'></font>
#endif<a name='404'>
#if ( HWRF == 1 )<a name='405'>
   REAL,       INTENT(IN)         ::   VAR_RIC                       <font color=#447700>!Kwon for variable Ric<a name='406'></font>
   integer,intent(in) :: ens_random_seed<a name='407'>
   real,intent(in) :: ens_pblamp<a name='408'>
   logical,intent(in) :: pert_pbl<a name='409'>
   REAL,       INTENT(IN)         ::   gfs_alpha,coef_ric_l,coef_ric_s<a name='410'>
#endif<a name='411'>
<a name='412'>
<a name='413'>
   REAL,       DIMENSION( kms:kme ),                              &amp;<a name='414'>
               OPTIONAL, INTENT(IN   )    ::               znu,   &amp;<a name='415'>
                                                           znw<a name='416'>
<font color=#447700>!<a name='417'></font>
   REAL,       INTENT(IN   )    ::     DT,DX,DY<a name='418'>
   REAL,       INTENT(IN   ),OPTIONAL    ::     bldt<a name='419'>
   REAL,       INTENT(IN   ),OPTIONAL    ::     curr_secs<a name='420'>
   LOGICAL,    INTENT(IN   ),OPTIONAL    ::     adapt_step_flag<a name='421'>
   REAL,       INTENT(INOUT),OPTIONAL    ::     bldtacttime  <a name='422'>
<font color=#447700>! Optional for Wind Turbine Parameterizations<a name='423'></font>
   REAL, DIMENSION( ims:ime, kms:kme ,jms:jme ), &amp;<a name='424'>
         INTENT(IN), OPTIONAL    :: phb<a name='425'>
   REAL, DIMENSION( ims:ime, jms:jme ), &amp;<a name='426'>
         INTENT(IN), OPTIONAL    :: xlat_u,xlong_u,xlat_v,xlong_v<a name='427'>
<a name='428'>
   REAL,       DIMENSION( ims:ime, kms:kme ,jms:jme ),            &amp;<a name='429'>
               INTENT(IN), OPTIONAL    :: w<a name='430'>
<font color=#447700>!<a name='431'></font>
   REAL,       DIMENSION( ims:ime, kms:kme, jms:jme ),            &amp;<a name='432'>
               INTENT(IN   )    ::                         p_phy, &amp;<a name='433'>
                                                          pi_phy, &amp;<a name='434'>
                                                             p8w, &amp;<a name='435'>
                                                             rho, &amp;<a name='436'>
                                                           t_phy, &amp;<a name='437'>
                                                           u_phy, &amp;<a name='438'>
                                                           v_phy, &amp;<a name='439'>
                                                            dz8w, &amp;<a name='440'>
                                                               z, &amp;<a name='441'>
                                                          th_phy<a name='442'>
<a name='443'>
<font color=#447700>!1D variables required for CAMUWPBL scheme<a name='444'></font>
   REAL , DIMENSION( kms:kme ) ,                                      &amp;<a name='445'>
        INTENT(IN   ) , OPTIONAL ::                                        fnm,  &amp; <font color=#447700>!Factors for interpolation at "w" grid (interfaces)<a name='446'></font>
                                                                fnp                                                                  <a name='447'>
<font color=#447700>!3D Variables for camuwpbl scheme<a name='448'></font>
    REAL,       DIMENSION( ims:ime, kms:kme, jms:jme ),           &amp;<a name='449'>
               INTENT(IN   ), OPTIONAL    ::              z_at_w, &amp;<a name='450'>
                                                   cldfra_old_mp, &amp;<a name='451'>
                                                          cldfra, &amp;<a name='452'>
                                                      rthratenlw, &amp;<a name='453'>
                                                      wsedl3d<a name='454'>
<a name='455'>
<a name='456'>
<font color=#447700>!2D Variables required by camuwpbl scheme<a name='457'></font>
    REAL,       DIMENSION( ims:ime , jms:jme ),                   &amp;<a name='458'>
               INTENT(INOUT   ), OPTIONAL    ::        tauresx2d, &amp;<a name='459'>
                                                       tauresy2d, &amp;<a name='460'>
                                                         tpert2d, &amp;<a name='461'>
                                                         qpert2d, &amp;<a name='462'>
                                                         wpert2d<a name='463'>
<a name='464'>
<a name='465'>
<font color=#447700>!3D Variables for camuwpbl scheme - out<a name='466'></font>
    REAL,       DIMENSION( ims:ime, kms:kme, jms:jme ),           &amp;<a name='467'>
               INTENT(OUT) , OPTIONAL   ::                      turbtype3d, &amp;<a name='468'>
                                                          smaw3d<a name='469'>
<font color=#447700>!<a name='470'></font>
<font color=#447700>! for grims shallow convection with ysupbl<a name='471'></font>
<font color=#447700>!<a name='472'></font>
    REAL,      DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='473'>
               INTENT(INOUT   ), OPTIONAL    ::          wstar<a name='474'>
    REAL,      DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='475'>
               INTENT(INOUT   ), OPTIONAL    ::            delta<a name='476'>
<font color=#447700>!<a name='477'></font>
   REAL,       DIMENSION( ims:ime , jms:jme ),                    &amp;<a name='478'>
               INTENT(IN   )    ::                         XLAND, &amp;<a name='479'>
                                                              HT, &amp;<a name='480'>
                                                            PSIM, &amp;<a name='481'>
                                                            PSIH, &amp;<a name='482'>
                                                              FM, &amp;<a name='483'>
                                                             FHH, &amp;<a name='484'>
                                                          GZ1OZ0, &amp;<a name='485'>
                                                              BR, &amp;<a name='486'>
                                                               F, &amp;<a name='487'>
                                                         CHKLOWQ<a name='488'>
#if (HWRF==1)<a name='489'>
   REAL,       DIMENSION( ims:ime , jms:jme ),                    &amp;<a name='490'>
               INTENT(IN   )    ::                         SCURX, &amp;<a name='491'>
                                                           SCURY, &amp;<a name='492'>
                                                           MSANG<a name='493'>
#endif<a name='494'>
<a name='495'>
<font color=#447700>!<a name='496'></font>
   REAL,       DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='497'>
               INTENT(INOUT)    ::                           TSK, &amp;<a name='498'>
                                                             UST, &amp;<a name='499'>
                                                            PBLH, &amp;<a name='500'>
                                                             HFX, &amp;<a name='501'>
                                                             QFX, &amp;<a name='502'>
                                                             ZNT, &amp;<a name='503'>
#if (HWRF==1)<a name='504'>
                                                            MZNT, &amp;  <font color=#447700>! KWON FOR MOMENTUM Z0<a name='505'></font>
#endif<a name='506'>
                                                            QSFC, &amp;<a name='507'>
                                                            AKHS, &amp;<a name='508'>
                                                            AKMS, &amp;<a name='509'>
                                                           MIXHT, &amp;<a name='510'>
                                                             QZ0, &amp;<a name='511'>
                                                            THZ0, &amp;<a name='512'>
                                                             UZ0, &amp;<a name='513'>
                                                             VZ0, &amp;<a name='514'>
                                                              CT, &amp;<a name='515'>
                                                          GRDFLX, &amp;<a name='516'>
                                                             U10, &amp;<a name='517'>
                                                             V10, &amp;<a name='518'>
                                                            UOCE, &amp;<a name='519'>
                                                            VOCE, &amp;<a name='520'>
                                                              T2, &amp;<a name='521'>
                                                           POWER, &amp;<a name='522'>
                                                            WSPD<a name='523'>
<a name='524'>
<font color=#447700>!<a name='525'></font>
   REAL,       DIMENSION( ims:ime, kms:kme, jms:jme ),            &amp;<a name='526'>
               INTENT(INOUT)    ::                       RUBLTEN, &amp;<a name='527'>
                                                         RVBLTEN, &amp;<a name='528'>
                                                        RTHBLTEN, &amp;<a name='529'>
                                           EXCH_H,EXCH_M,TKE_PBL, &amp;<a name='530'>
                                                        RTHRATEN  <font color=#447700>! for GBM PBL scheme<a name='531'></font>
#if (NMM_CORE <font color=#447700>!= 1)<a name='532'></font>
 REAL,       DIMENSION( ims:ime, kms:kme, jms:jme ),            &amp;<a name='533'>
               INTENT(OUT)    ::                       WU_TUR,WV_TUR,WT_TUR,WQ_TUR<a name='534'>
<font color=#447700>!<a name='535'></font>
#endif<a name='536'>
<a name='537'>
<font color=#447700>!MYNN<a name='538'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),     &amp;<a name='539'>
          INTENT(INOUT) ::        tsq,qsq,cov, &amp; <font color=#447700>!,k_m,k_h,k_q &amp;<a name='540'></font>
                                  qke,Sh3d,                    &amp;<a name='541'>
                                  dqke,qWT,qSHEAR,qBUOY,qDISS, &amp;<a name='542'>
                                  qc_bl,cldfra_bl<a name='543'>
<a name='544'>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),     &amp;<a name='545'>
          INTENT(INOUT) ::         edmf_a,edmf_w,edmf_thl,     &amp; <font color=#447700>!JOE- MYNN edmf<a name='546'></font>
                                   edmf_qt,edmf_ent,edmf_qc      <font color=#447700>!JOE- MYNN edmf<a name='547'></font>
<a name='548'>
   INTEGER, OPTIONAL, INTENT(IN)  :: bl_mynn_tkebudget,        &amp;<a name='549'>
                                     grav_settling,            &amp;<a name='550'>
                                     bl_mynn_cloudpdf,         &amp;<a name='551'>
                                     bl_mynn_mixlength,        &amp;<a name='552'>
                                     bl_mynn_edmf,             &amp;<a name='553'>
                                     bl_mynn_edmf_mom,         &amp;<a name='554'>
                                     bl_mynn_edmf_tke,         &amp;<a name='555'>
                                     bl_mynn_edmf_part,        &amp;<a name='556'>
                                     bl_mynn_cloudmix,         &amp;<a name='557'>
                                     bl_mynn_mixqt,            &amp;<a name='558'>
                                     icloud_bl<a name='559'>
<a name='560'>
<font color=#447700>!ACF-QKE advection start<a name='561'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), &amp;<a name='562'>
        &amp; INTENT(INOUT) :: qke_adv<a name='563'>
   LOGICAL, OPTIONAL, INTENT(IN) :: bl_mynn_tkeadvect<a name='564'>
<font color=#447700>!ACF-QKE advection end<a name='565'></font>
<font color=#447700>! Katata-added -<a name='566'></font>
   REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL,              &amp;<a name='567'>
        &amp;    INTENT(INOUT)::                               vdfg<a name='568'>
<font color=#447700>! Katata-end<a name='569'></font>
<a name='570'>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), &amp;<a name='571'>
        &amp; INTENT(INOUT) ::  exch_tke      <font color=#447700>! for GBM PBL scheme<a name='572'></font>
<a name='573'>
<a name='574'>
   INTEGER, OPTIONAL :: id<a name='575'>
<a name='576'>
   REAL,    DIMENSION( ims:ime , jms:jme ), &amp;<a name='577'>
        &amp;OPTIONAL, INTENT(IN) ::  &amp;<a name='578'>
        &amp; qcg,  ch<a name='579'>
   REAL,    DIMENSION( ims:ime , jms:jme ), &amp;<a name='580'>
        &amp;OPTIONAL, INTENT(INOUT) ::  rmol<a name='581'>
   <a name='582'>
<a name='583'>
<a name='584'>
<font color=#447700>!<a name='585'></font>
   REAL,       DIMENSION( ims:ime, kms:kme, jms:jme ),            &amp;<a name='586'>
               INTENT(OUT)    ::                          EL_PBL<a name='587'>
<a name='588'>
   REAL ,                             INTENT(IN   )  ::  u_frame, &amp;<a name='589'>
                                                         v_frame<a name='590'>
<font color=#447700>!<a name='591'></font>
<a name='592'>
   INTEGER,    DIMENSION( ims:ime , jms:jme ),                    &amp;<a name='593'>
               INTENT(INOUT) ::                             KPBL<a name='594'>
<a name='595'>
   REAL,       DIMENSION( ims:ime , jms:jme ),                    &amp;<a name='596'>
               INTENT(IN)    :: XICE, SNOW, LH<a name='597'>
<a name='598'>
   <font color=#447700>! Stochastic parameter perturbations<a name='599'></font>
   INTEGER,    INTENT(IN), OPTIONAL              ::             spp_pbl<a name='600'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),INTENT(IN),OPTIONAL ::pattern_spp_pbl<a name='601'>
<a name='602'>
<font color=#447700>! Bep changes: variable added for urban<a name='603'></font>
   real, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) ::FRC_URB2D   <font color=#447700>! URBAN Landuse fraction<a name='604'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_u_bep        <font color=#447700>! Implicit component for the momemtum in X-direction<a name='605'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_v_bep        <font color=#447700>! Implicit component for the momemtum in Y-direction<a name='606'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_t_bep        <font color=#447700>! Implicit component for the Pot. Temp.<a name='607'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_q_bep        <font color=#447700>! Implicit component for Moisture<a name='608'></font>
<a name='609'>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_e_bep        <font color=#447700>! Implicit component for the TKE<a name='610'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_u_bep        <font color=#447700>! Explicit component for the momemtum in X-direction<a name='611'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_v_bep        <font color=#447700>! Explicit component for the momemtum in Y-direction<a name='612'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_t_bep        <font color=#447700>! Explicit component for the Pot. Temp.<a name='613'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_q_bep        <font color=#447700>! Explicit component for Moisture<a name='614'></font>
<a name='615'>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_e_bep        <font color=#447700>! Explicit component for the TKE<a name='616'></font>
<a name='617'>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::dlg_bep        <font color=#447700>! Height above ground (L_ground in formula (24) of the BLM paper). <a name='618'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::dl_u_bep        <font color=#447700>! Length scale (lb in formula (22) ofthe BLM paper).<a name='619'></font>
<font color=#447700>! urban surface and volumes        <a name='620'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::sf_bep           <font color=#447700>! surfaces<a name='621'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::vl_bep            <font color=#447700>! volumes<a name='622'></font>
 <a name='623'>
<font color=#447700>! Bep changes end<a name='624'></font>
<font color=#447700>!  New variables for TEMF scheme<a name='625'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            &amp;<a name='626'>
               INTENT(INOUT) :: te_temf<a name='627'>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            &amp;<a name='628'>
               INTENT(  OUT) :: km_temf, kh_temf,        &amp;<a name='629'>
                         shf_temf,qf_temf,uw_temf,vw_temf,        &amp;<a name='630'>
                         wupd_temf,mf_temf,thup_temf,qtup_temf,   &amp;<a name='631'>
                         qlup_temf,cf3d_temf<a name='632'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),            &amp;<a name='633'>
               INTENT(INOUT) :: flhc,flqc<a name='634'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),            &amp;<a name='635'>
               INTENT(  OUT) :: hd_temf, lcl_temf, hct_temf, cfm_temf<a name='636'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),            &amp;<a name='637'>
               INTENT(INOUT) :: exch_temf<a name='638'>
<a name='639'>
<font color=#447700>!<a name='640'></font>
<font color=#447700>!<a name='641'></font>
<font color=#447700>! Optional<a name='642'></font>
<font color=#447700>!<a name='643'></font>
<font color=#447700>!<a name='644'></font>
<font color=#447700>! Flags relating to the optional tendency arrays declared above<a name='645'></font>
<font color=#447700>! Models that carry the optional tendencies will provdide the<a name='646'></font>
<font color=#447700>! optional arguments at compile time; these flags all the model<a name='647'></font>
<font color=#447700>! to determine at run-time whether a particular tracer is in<a name='648'></font>
<font color=#447700>! use or not.<a name='649'></font>
<font color=#447700>!<a name='650'></font>
   LOGICAL, INTENT(IN), OPTIONAL ::                             &amp;<a name='651'>
                                                      f_qv      &amp;<a name='652'>
                                                     ,f_qc      &amp;<a name='653'>
                                                     ,f_qr      &amp;<a name='654'>
                                                     ,f_qi      &amp;<a name='655'>
                                                     ,f_qs      &amp;<a name='656'>
                                                     ,f_qg      &amp;<a name='657'>
                                                     ,f_qnc     &amp; <font color=#447700>!used in CAMUWPBL<a name='658'></font>
                                                     ,f_qni       <font color=#447700>!used in CAMUWPBL<a name='659'></font>
<a name='660'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                 &amp;<a name='661'>
         OPTIONAL, INTENT(INOUT) ::                              &amp;<a name='662'>
                      <font color=#447700>! optional moisture tracers<a name='663'></font>
                      <font color=#447700>! 2 time levels; if only one then use CURR<a name='664'></font>
                      qv_curr, qc_curr, qr_curr                  &amp;<a name='665'>
                     ,qi_curr, qs_curr, qg_curr                  &amp;<a name='666'>
                     ,qnc_curr,qni_curr                          &amp; <font color=#447700>!used in CAMUWPBL<a name='667'></font>
                     ,rqvblten,rqcblten,rqrblten                 &amp;<a name='668'>
                     ,rqiblten,rqsblten,rqgblten,rqniblten         <font color=#447700>!rqniblten  used in CAMUWPBL<a name='669'></font>
<a name='670'>
<a name='671'>
   REAL,       DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='672'>
               OPTIONAL                                         , &amp;<a name='673'>
               INTENT(INOUT)    ::                           HOL, &amp;<a name='674'>
                                                             MOL, &amp;<a name='675'>
                                                          REGIME<a name='676'>
   REAL,       DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='677'>
               OPTIONAL                                         , &amp;<a name='678'>
               INTENT(IN)    ::                           mut<a name='679'>
<font color=#447700>!<a name='680'></font>
   INTEGER,    OPTIONAL, INTENT(IN)    ::               gwd_opt<a name='681'>
   REAL,       OPTIONAL, INTENT(IN)    ::               p_top<a name='682'>
<font color=#447700>!<a name='683'></font>
  real,   dimension( ims:ime, kms:kme, jms:jme )                             , &amp;<a name='684'>
          optional                                                           , &amp;<a name='685'>
             intent(inout  )   ::                                     dtaux3d, &amp;<a name='686'>
                                                                      dtauy3d<a name='687'>
<font color=#447700>!<a name='688'></font>
  real,   dimension( ims:ime, jms:jme )                                      , &amp;<a name='689'>
          optional                                                           , &amp;<a name='690'>
             intent(inout  )   ::                                      dusfcg, &amp;<a name='691'>
                                                                       dvsfcg<a name='692'>
<font color=#447700>!<a name='693'></font>
  real,   dimension( ims:ime, jms:jme )                                      , &amp;<a name='694'>
          optional                                                           , &amp;<a name='695'>
             intent(in  )   ::                                          var2d, &amp;<a name='696'>
                                                                        oc12d, &amp;<a name='697'>
                                                              oa1,oa2,oa3,oa4, &amp;<a name='698'>
                                                              ol1,ol2,ol3,ol4<a name='699'>
<font color=#447700>! paj<a name='700'></font>
   REAL, OPTIONAL,   DIMENSION( ims:ime , jms:jme ),                    &amp;  <font color=#447700>!mchen<a name='701'></font>
               INTENT(IN   )    ::                        CTOPO, &amp;<a name='702'>
                                                          CTOPO2<a name='703'>
<a name='704'>
<font color=#447700>! Variables and Diagnostic for QNSE and EDKF JP<a name='705'></font>
   INTEGER, INTENT(IN) ::  mfshconv<a name='706'>
<a name='707'>
   REAL,       DIMENSION( ims:ime, kms:kme, jms:jme ), OPTIONAL,  &amp;<a name='708'>
               INTENT(OUT) ::    massflux_EDKF, entr_EDKF, detr_EDKF &amp; <a name='709'>
                                     ,thl_up, thv_up, rt_up       &amp;<a name='710'>
                                     ,rv_up, rc_up, u_up, v_up    &amp;<a name='711'>
                                     ,frac_up,rc_mf  <a name='712'>
<a name='713'>
    REAL , OPTIONAL   ,DIMENSION(ims:ime,kms:kme,jms:jme,num_tracer),INTENT(INOUT)   :: tracer<a name='714'>
    REAL , OPTIONAL   ,DIMENSION(ims:ime,kms:kme,jms:jme,num_tracer),INTENT(INOUT)   :: tracer_tend<a name='715'>
    REAL , OPTIONAL   ,DIMENSION(ims:ime,kms:kme,jms:jme,num_scalar),INTENT(INOUT)   :: scalar<a name='716'>
    REAL , OPTIONAL   ,DIMENSION(ims:ime,kms:kme,jms:jme,num_scalar),INTENT(INOUT)   :: scalar_tend<a name='717'>
<a name='718'>
#if (WRF_CHEM == 1)<a name='719'>
<font color=#447700>!   ACM Chem<a name='720'></font>
    INTEGER, INTENT(IN) :: nchem, kdvel,ndvel,num_vert_mix<a name='721'>
    REAL, INTENT(INOUT),  DIMENSION( ims:ime, kms:kme, jms:jme,nchem ) :: CHEM<a name='722'>
    REAL, INTENT(IN)   ,  DIMENSION( ims:ime, kdvel, jms:jme, ndvel )  :: VD<a name='723'>
#endif<a name='724'>
<a name='725'>
<font color=#447700>!  LOCAL  VAR<a name='726'></font>
<a name='727'>
   REAL,       DIMENSION( ims:ime, kms:kme, jms:jme ) ::v_phytmp<a name='728'>
   REAL,       DIMENSION( ims:ime, kms:kme, jms:jme ) ::u_phytmp<a name='729'>
<a name='730'>
   REAL,       DIMENSION( ims:ime, jms:jme )          ::  TSKOLD, &amp;<a name='731'>
                                                          USTOLD, &amp;<a name='732'>
                                                          ZNTOLD, &amp;<a name='733'>
                                                             ZOL, &amp;<a name='734'>
                                                            PSFC<a name='735'>
<a name='736'>
<font color=#447700>! make these allocatable depending on the setting of idiff<a name='737'></font>
<font color=#447700>! Typically, we try to avoide allocating and deallocating local storage like this<a name='738'></font>
<font color=#447700>! so as not to fragment the stack. But at this point, the idiff = 1 case is disabled<a name='739'></font>
<font color=#447700>! (set to 0 for all cases) and has to be set manually by users who want to work with<a name='740'></font>
<font color=#447700>! it.  When it becomes a more standard option, this should be redone, either defining<a name='741'></font>
<font color=#447700>! these as state with package clauses to turn them on and off and passing them in,<a name='742'></font>
<font color=#447700>! or pass in an integer flag that can be used to dimension the arrays to 1:1:1 as<a name='743'></font>
<font color=#447700>! local variables.  JM 20100316<a name='744'></font>
<a name='745'>
   REAL, ALLOCATABLE, DIMENSION( :, :, : )::a_u        <font color=#447700>! Implicit component for the momemtum in X-direction<a name='746'></font>
   REAL, ALLOCATABLE, DIMENSION( :, :, : )::a_v        <font color=#447700>! Implicit component for the momemtum in Y-direction<a name='747'></font>
   REAL, ALLOCATABLE, DIMENSION( :, :, : )::a_t        <font color=#447700>! Implicit component for the Pot. Temp.<a name='748'></font>
   REAL, ALLOCATABLE, DIMENSION( :, :, : )::a_q        <font color=#447700>! Implicit component for the water vapor<a name='749'></font>
<a name='750'>
   REAL, ALLOCATABLE, DIMENSION( :, :, : )::b_u        <font color=#447700>! Explicit component for the momemtum in X-direction<a name='751'></font>
   REAL, ALLOCATABLE, DIMENSION( :, :, : )::b_v        <font color=#447700>! Explicit component for the momemtum in Y-direction<a name='752'></font>
   REAL, ALLOCATABLE, DIMENSION( :, :, : )::b_t        <font color=#447700>! Explicit component for the Pot. Temp.<a name='753'></font>
   REAL, ALLOCATABLE, DIMENSION( :, :, : )::b_q        <font color=#447700>! Explicit component for the water vapor<a name='754'></font>
<a name='755'>
   REAL, ALLOCATABLE, DIMENSION( :, :, : )::sf         <font color=#447700>! surfaces<a name='756'></font>
   REAL, ALLOCATABLE, DIMENSION( :, :, : )::vl         <font color=#447700>! volumes<a name='757'></font>
<a name='758'>
   REAL    :: DTMIN,DTBL<a name='759'>
<font color=#447700>!<a name='760'></font>
   INTEGER :: initflag<a name='761'>
<font color=#447700>!<a name='762'></font>
   INTEGER :: i,J,K,NK,jj,ij,its,ite,jts,jte<a name='763'>
   LOGICAL :: radiation<a name='764'>
   LOGICAL :: flag_bep<a name='765'>
   LOGICAL :: flag_myjsfc<a name='766'>
   LOGICAL :: flag_qv, flag_qc, flag_qr, flag_qi, flag_qs, flag_qg, flag_qnc,flag_qni <font color=#447700>!flag_qnc,flag_qnc are used in camuwpbl scheme<a name='767'></font>
   CHARACTER*256 :: message<a name='768'>
   REAL    :: next_bl_time<a name='769'>
   LOGICAL :: run_param , doing_adapt_dt , decided<a name='770'>
   LOGICAL :: do_adapt<a name='771'>
   integer iu_bep,iurb,idiff<a name='772'>
   real seamask,thsk,zzz,unew,vnew,tnew,qnew,umom,vmom<a name='773'>
   REAL :: z0,z1,z2,w1,w2<a name='774'>
<font color=#447700>!<a name='775'></font>
<font color=#447700>! FASDAS<a name='776'></font>
<font color=#447700>!<a name='777'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(  OUT) , OPTIONAL ::   QNORM<a name='778'>
   INTEGER, INTENT(IN   )                                         ::   fasdas<a name='779'>
   REAL                                                           ::   scrp1<a name='780'>
<font color=#447700>!<a name='781'></font>
<font color=#447700>! END FASDAS<a name='782'></font>
<font color=#447700>!<a name='783'></font>
<font color=#447700>!------------------------------------------------------------------<a name='784'></font>
<font color=#447700>!<a name='785'></font>
<font color=#447700>!!!!!!!if using BEP set flag_bep to true<a name='786'></font>
    SELECT CASE(sf_urban_physics)<a name='787'>
#if (NMM_CORE <font color=#447700>!= 1)<a name='788'></font>
      CASE (BEPSCHEME)<a name='789'>
        flag_bep=.true.<a name='790'>
      CASE (BEP_BEMSCHEME)<a name='791'>
        flag_bep=.true.<a name='792'>
#endif<a name='793'>
      CASE DEFAULT<a name='794'>
        flag_bep=.false.<a name='795'>
    END SELECT<a name='796'>
<a name='797'>
    SELECT CASE(sf_sfclay_physics)<a name='798'>
      CASE (MYJSFCSCHEME)<a name='799'>
         flag_myjsfc=.true.<a name='800'>
      CASE DEFAULT<a name='801'>
         flag_myjsfc=.false.<a name='802'>
    END SELECT<a name='803'>
<font color=#447700>!<a name='804'></font>
  flag_qv = .FALSE. ; IF ( PRESENT( F_QV ) ) flag_qv = F_QV<a name='805'>
  flag_qc = .FALSE. ; IF ( PRESENT( F_QC ) ) flag_qc = F_QC<a name='806'>
  flag_qr = .FALSE. ; IF ( PRESENT( F_QR ) ) flag_qr = F_QR<a name='807'>
  flag_qi = .FALSE. ; IF ( PRESENT( F_QI ) ) flag_qi = F_QI<a name='808'>
  flag_qs = .FALSE. ; IF ( PRESENT( F_QS ) ) flag_qs = F_QS<a name='809'>
  flag_qg = .FALSE. ; IF ( PRESENT( F_QG ) ) flag_qg = F_QG<a name='810'>
  flag_qnc = .FALSE. ; IF ( PRESENT( F_QNC ) ) flag_qnc = F_QNC <font color=#447700>!Used in CAMUWPBL<a name='811'></font>
  flag_qni = .FALSE. ; IF ( PRESENT( F_QNI ) ) flag_qni = F_QNI <font color=#447700>!Used in CAMUWPBL<a name='812'></font>
<a name='813'>
  if (bl_pbl_physics .eq. 0) return<a name='814'>
<a name='815'>
<font color=#447700>! RAINBL in mm (Accumulation between PBL calls)<a name='816'></font>
<font color=#447700>!<a name='817'></font>
   doing_adapt_dt = .FALSE.<a name='818'>
   IF ( PRESENT(adapt_step_flag) ) THEN<a name='819'>
      IF ( adapt_step_flag ) THEN<a name='820'>
         doing_adapt_dt = .TRUE.<a name='821'>
         IF ( bldtacttime .eq. 0. ) THEN<a name='822'>
            bldtacttime = CURR_SECS + bldt*60.<a name='823'>
         END IF<a name='824'>
      END IF<a name='825'>
   END IF<a name='826'>
<a name='827'>
<font color=#447700>!  Do we run through this scheme or not?<a name='828'></font>
<a name='829'>
<font color=#447700>!    Test 1:  If this is the initial model time, then yes.<a name='830'></font>
<font color=#447700>!                ITIMESTEP=1<a name='831'></font>
<font color=#447700>!    Test 2:  If the user asked for the pbl to be run every time step, then yes.<a name='832'></font>
<font color=#447700>!                BLDT=0 or STEPBL=1<a name='833'></font>
<font color=#447700>!    Test 3:  If not adaptive dt, and this is on the requested pbl frequency, then yes.<a name='834'></font>
<font color=#447700>!                MOD(ITIMESTEP,STEPBL)=0<a name='835'></font>
<font color=#447700>!    Test 4:  If using adaptive dt and the current time is past the last requested activate pbl time, then yes.<a name='836'></font>
<font color=#447700>!                CURR_SECS &gt;= BLDTACTTIME<a name='837'></font>
<a name='838'>
<font color=#447700>!  If we do run through the scheme, we set the flag run_param to TRUE and we set the decided flag<a name='839'></font>
<font color=#447700>!  to TRUE.  The decided flag says that one of these tests was able to say "yes", run the scheme.<a name='840'></font>
<font color=#447700>!  We only proceed to other tests if the previous tests all have left decided as FALSE.<a name='841'></font>
<a name='842'>
<font color=#447700>!  If we set run_param to TRUE and this is adaptive time stepping, we set the time to the next<a name='843'></font>
<font color=#447700>!  pbl run.<a name='844'></font>
<a name='845'>
   run_param = .FALSE.<a name='846'>
   decided = .FALSE.<a name='847'>
   IF ( ( .NOT. decided ) .AND. &amp;<a name='848'>
        ( itimestep .EQ. 1 ) ) THEN<a name='849'>
      run_param   = .TRUE.<a name='850'>
      decided     = .TRUE.<a name='851'>
   END IF<a name='852'>
<a name='853'>
   IF ( PRESENT(bldt) )THEN<a name='854'>
      IF ( ( .NOT. decided ) .AND. &amp;<a name='855'>
           ( ( bldt .EQ. 0. ) .OR. ( stepbl .EQ. 1 ) ) ) THEN<a name='856'>
         run_param   = .TRUE.<a name='857'>
         decided     = .TRUE.<a name='858'>
      END IF<a name='859'>
   ELSE<a name='860'>
      IF ( ( .NOT. decided ) .AND. &amp;<a name='861'>
                                   ( stepbl .EQ. 1 )   ) THEN<a name='862'>
         run_param   = .TRUE.<a name='863'>
         decided     = .TRUE.<a name='864'>
      END IF<a name='865'>
   END IF<a name='866'>
<a name='867'>
   IF ( ( .NOT. decided ) .AND. &amp;<a name='868'>
        ( .NOT. doing_adapt_dt ) .AND. &amp;<a name='869'>
        ( MOD(itimestep,stepbl) .EQ. 0 ) ) THEN<a name='870'>
      run_param   = .TRUE.<a name='871'>
      decided     = .TRUE.<a name='872'>
   END IF<a name='873'>
<a name='874'>
   IF ( ( .NOT. decided ) .AND. &amp;<a name='875'>
        ( doing_adapt_dt ) .AND. &amp;<a name='876'>
        ( curr_secs .GE. bldtacttime ) ) THEN<a name='877'>
      run_param   = .TRUE.<a name='878'>
      decided     = .TRUE.<a name='879'>
      bldtacttime = curr_secs + bldt*60<a name='880'>
   END IF<a name='881'>
<a name='882'>
<a name='883'>
 IF (run_param) THEN<a name='884'>
  radiation = .false.<a name='885'>
  IF (ra_lw_physics .gt. 0) radiation = .true.<a name='886'>
<a name='887'>
<font color=#447700>!---- <a name='888'></font>
<font color=#447700>! CALCULATE CONSTANT<a name='889'></font>
 <a name='890'>
   DTMIN=DT/60.<a name='891'>
<font color=#447700>! PBL schemes need PBL time step for updates<a name='892'></font>
<a name='893'>
    if (PRESENT(adapt_step_flag)) then<a name='894'>
       if (adapt_step_flag) then<a name='895'>
          do_adapt = .TRUE.<a name='896'>
       else<a name='897'>
          do_adapt = .FALSE.<a name='898'>
       endif<a name='899'>
    else<a name='900'>
       do_adapt = .FALSE.<a name='901'>
    endif<a name='902'>
<a name='903'>
   if (PRESENT(BLDT)) then<a name='904'>
      if (bldt .eq. 0) then<a name='905'>
         DTBL = dt<a name='906'>
      ELSE<a name='907'>
         if (do_adapt) then<a name='908'>
            IF ( curr_secs .LT. 2. * dt ) THEN<a name='909'>
               call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_834">("WARNING: When using an adaptive time-step the boundary layer"// &amp;<a name='910'>
                                " time-step should be 0 (i.e., equivalent to model time-step).  ")<a name='911'>
               call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_835">("In order to proceed, for boundary layer calculations, the "// &amp;<a name='912'>
                                "boundary layer time-step"// &amp;<a name='913'>
                                 " will be rounded to the nearest minute," )<a name='914'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_836">("possibly resulting in innacurate results.")<a name='915'>
            END IF<a name='916'>
            DTBL=bldt*60<a name='917'>
         else<a name='918'>
            DTBL=DT*STEPBL<a name='919'>
         endif<a name='920'>
      endif<a name='921'>
   else<a name='922'>
      DTBL=DT*STEPBL<a name='923'>
   endif<a name='924'>
<a name='925'>
#if (NMM_CORE <font color=#447700>!= 1)<a name='926'></font>
<font color=#447700>!!Alberto. If idiff=1, then compute the tendencies at the end in the routine diff3d<a name='927'></font>
<font color=#447700>!!Alberto. If idiff=0, then compute the tendencies in each PBL routine (standard version).<a name='928'></font>
       idiff=0<a name='929'>
#else<a name='930'>
<font color=#447700>! Added this else clause so that idiff is always initialized regardless of which core we are using<a name='931'></font>
       idiff=0<a name='932'>
#endif<a name='933'>
<a name='934'>
   IF ( idiff .EQ. 1 ) THEN<a name='935'>
     ALLOCATE (a_u(ims:ime,kms:kme,jms:jme))       <font color=#447700>! Implicit component for the momemtum in X-direction<a name='936'></font>
     ALLOCATE (a_v(ims:ime,kms:kme,jms:jme))       <font color=#447700>! Implicit component for the momemtum in Y-direction<a name='937'></font>
     ALLOCATE (a_t(ims:ime,kms:kme,jms:jme))       <font color=#447700>! Implicit component for the Pot. Temp.<a name='938'></font>
     ALLOCATE (a_q(ims:ime,kms:kme,jms:jme))       <font color=#447700>! Implicit component for the water vapor<a name='939'></font>
     ALLOCATE (b_u(ims:ime,kms:kme,jms:jme))       <font color=#447700>! Explicit component for the momemtum in X-direction<a name='940'></font>
     ALLOCATE (b_v(ims:ime,kms:kme,jms:jme))       <font color=#447700>! Explicit component for the momemtum in Y-direction<a name='941'></font>
     ALLOCATE (b_t(ims:ime,kms:kme,jms:jme))       <font color=#447700>! Explicit component for the Pot. Temp.<a name='942'></font>
     ALLOCATE (b_q(ims:ime,kms:kme,jms:jme))       <font color=#447700>! Explicit component for the water vapor<a name='943'></font>
     ALLOCATE (sf(ims:ime,kms:kme,jms:jme) )       <font color=#447700>! surfaces<a name='944'></font>
     ALLOCATE (vl(ims:ime,kms:kme,jms:jme) )       <font color=#447700>! volumes<a name='945'></font>
   ENDIF<a name='946'>
   <a name='947'>
<font color=#447700>! SAVE OLD VALUES<a name='948'></font>
<a name='949'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='950'></font>
   <font color=#447700>!$OMP PRIVATE ( ij,i,j,k )<a name='951'></font>
<a name='952'>
   DO ij = 1 , num_tiles<a name='953'>
      DO j=j_start(ij),j_end(ij)<a name='954'>
      DO i=i_start(ij),i_end(ij)<a name='955'>
         TSKOLD(i,j)=TSK(i,j)<a name='956'>
         USTOLD(i,j)=UST(i,j)<a name='957'>
         ZNTOLD(i,j)=ZNT(i,j)<a name='958'>
<a name='959'>
<font color=#447700>! REVERSE ORDER IN THE VERTICAL DIRECTION<a name='960'></font>
<a name='961'>
<font color=#447700>! testing change later<a name='962'></font>
<a name='963'>
         DO k=kts,kte<a name='964'>
            v_phytmp(i,k,j)=v_phy(i,k,j)+v_frame<a name='965'>
            u_phytmp(i,k,j)=u_phy(i,k,j)+u_frame<a name='966'>
         ENDDO<a name='967'>
<a name='968'>
<font color=#447700>! PSFC : in Pa<a name='969'></font>
<a name='970'>
         PSFC(I,J)=p8w(I,kms,J)<a name='971'>
<a name='972'>
         DO k=kts,min(kte+1,kde)<a name='973'>
            RTHBLTEN(I,K,J)=0.<a name='974'>
            RUBLTEN(I,K,J)=0.<a name='975'>
            RVBLTEN(I,K,J)=0.<a name='976'>
            IF ( PRESENT( RQCBLTEN )) RQCBLTEN(I,K,J)=0.<a name='977'>
            IF ( PRESENT( RQVBLTEN )) RQVBLTEN(I,K,J)=0.<a name='978'>
         ENDDO<a name='979'>
<a name='980'>
         IF (flag_QI .AND. PRESENT(RQIBLTEN) ) THEN<a name='981'>
            DO k=kts,min(kte+1,kde)<a name='982'>
               RQIBLTEN(I,K,J)=0.<a name='983'>
            ENDDO<a name='984'>
         ENDIF<a name='985'>
         <font color=#447700>!Following if condition is added for CAMUWPBL scheme<a name='986'></font>
         IF (flag_QNI .AND. PRESENT(RQNIBLTEN) ) THEN<a name='987'>
            DO k=kts,min(kte+1,kde)<a name='988'>
               RQNIBLTEN(I,K,J)=0.<a name='989'>
            ENDDO<a name='990'>
         ENDIF<a name='991'>
      ENDDO<a name='992'>
      ENDDO<a name='993'>
<a name='994'>
      IF (bl_pbl_physics .EQ. QNSEPBLSCHEME ) THEN<a name='995'>
<font color=#447700>! use u_phytmp instead of wthv_mf, and v_phytmp instead of lm_bl89<a name='996'></font>
           DO j=j_start(ij),j_end(ij)<a name='997'>
           DO i=i_start(ij),i_end(ij)<a name='998'>
           DO k=kms,kme<a name='999'>
              u_phytmp(i,k,j)=0.<a name='1000'>
              v_phytmp(i,k,j)=0.<a name='1001'>
           ENDDO<a name='1002'>
           ENDDO<a name='1003'>
           ENDDO<a name='1004'>
      ENDIF<a name='1005'>
<a name='1006'>
#if (NMM_CORE <font color=#447700>!= 1)<a name='1007'></font>
      IF ( idiff.eq.1 ) THEN<a name='1008'>
<font color=#447700>!Alberto<a name='1009'></font>
<font color=#447700>! Here we should put a switch: <a name='1010'></font>
<font color=#447700>! if we do not use BEP, just initialize the values of the a, and b to zero, except for the lowest model level, <a name='1011'></font>
<font color=#447700>! where the heat and momentum fluxes are introduced         <a name='1012'></font>
<font color=#447700>! if we use BEP, use the values computed by BEP weigthed by the urban fraction.<a name='1013'></font>
<font color=#447700>! for the moment I put a simple "if" but it should be changed to a more elegant way after(using the CASE, maybe?)<a name='1014'></font>
<font color=#447700>!!!!!!!!!!!!!!<a name='1015'></font>
<font color=#447700>! This is the more general way to go, however some of these variables (e. g. a_t, a_q) may be zero nearly all time. <a name='1016'></font>
<font color=#447700>! if we need to be as tight as possible for the memory we can think how to reduce the storage.<a name='1017'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!<a name='1018'></font>
<font color=#447700>! This stuff is becoming large, probably better to put in a subroutine<a name='1019'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!<a name='1020'></font>
<font color=#447700>! preparing the a, b, sf, and vl terms<a name='1021'></font>
         <a name='1022'>
         IF (flag_bep) THEN    <a name='1023'>
           do j=j_start(ij),j_end(ij)<a name='1024'>
           do i=i_start(ij),i_end(ij)            <a name='1025'>
           do k=kts,kte<a name='1026'>
             a_u(i,k,j)=a_u_bep(i,k,j)<a name='1027'>
             a_v(i,k,j)=a_v_bep(i,k,j)<a name='1028'>
             a_t(i,k,j)=a_t_bep(i,k,j)<a name='1029'>
             a_q(i,k,j)=a_q_bep(i,k,j)<a name='1030'>
             b_u(i,k,j)=b_u_bep(i,k,j)<a name='1031'>
             b_v(i,k,j)=b_v_bep(i,k,j)<a name='1032'>
             b_t(i,k,j)=b_t_bep(i,k,j)<a name='1033'>
             b_q(i,k,j)=b_q_bep(i,k,j)<a name='1034'>
             vl(i,k,j)=vl_bep(i,k,j)<a name='1035'>
             sf(i,k,j)=sf_bep(i,k,j)<a name='1036'>
           enddo<a name='1037'>
           sf(i,kte+1,j)=1.<a name='1038'>
           enddo<a name='1039'>
           enddo<a name='1040'>
         ELSE<a name='1041'>
           do j=j_start(ij),j_end(ij)<a name='1042'>
           do i=i_start(ij),i_end(ij)<a name='1043'>
           do k=kts,kte<a name='1044'>
             a_u(i,k,j)=0.<a name='1045'>
             a_v(i,k,j)=0.<a name='1046'>
             a_t(i,k,j)=0.<a name='1047'>
             a_q(i,k,j)=0.<a name='1048'>
             b_u(i,k,j)=0.<a name='1049'>
             b_v(i,k,j)=0.<a name='1050'>
             b_t(i,k,j)=0.<a name='1051'>
             b_q(i,k,j)=0.<a name='1052'>
             vl(i,k,j)=1.<a name='1053'>
             sf(i,k,j)=1.<a name='1054'>
           enddo<a name='1055'>
           sf(i,kte+1,j)=1.<a name='1056'>
<font color=#447700>! fix the values for the surface fluxes (source/sink terms)<a name='1057'></font>
<font color=#447700>! here for momentum the resolution is done implicitely<a name='1058'></font>
<font color=#447700>! while for heat and moisture is done explicitely <a name='1059'></font>
            a_u(i,1,j)=(-ust(I,J)*ust(I,J))/dz8w(i,1,j)/((u_phy(i,1,j)**2+v_phy(i,1,j)**2.)**.5)           <a name='1060'>
            a_v(i,1,j)=(-ust(I,J)*ust(I,J))/dz8w(i,1,j)/((u_phy(i,1,j)**2+v_phy(i,1,j)**2.)**.5)<a name='1061'>
            b_t(i,1,j)=hfx(i,j)/rho(i,1,j)/CP/dz8w(i,1,j)<a name='1062'>
            b_q(i,1,j)=qfx(i,j)/rho(i,1,j)/dz8w(i,1,j)<a name='1063'>
<font color=#447700>!! if you want to solve also the heat and moisture fluxes implicitely, uncomment the following lines.<a name='1064'></font>
<font color=#447700>!! (of course you will need the values of thz0,qz0,akhs).<a name='1065'></font>
<font color=#447700>!             b_t(i,1,j)=akhs(i,j)*(thz0(I,J))/dz8w(i,1,j)<a name='1066'></font>
<font color=#447700>!             b_q(i,1,j)=akhs(i,j)*(qz0(I,J))/dz8w(i,1,j)<a name='1067'></font>
<font color=#447700>!             a_t(i,1,j)=-1.*akhs(i,j)/dz8w(i,1,j)<a name='1068'></font>
<font color=#447700>!             a_q(i,1,j)=-1.*akhs(i,j)/dz8w(i,1,j)<a name='1069'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1070'></font>
           enddo<a name='1071'>
           enddo<a name='1072'>
           <a name='1073'>
         ENDIF<a name='1074'>
<a name='1075'>
        endif      <a name='1076'>
                                           <a name='1077'>
     <a name='1078'>
 <a name='1079'>
<font color=#447700>!Alberto. From this point if some PBL scheme has a non local term <a name='1080'></font>
<font color=#447700>! (not dependent on the local values of the variable)<a name='1081'></font>
<font color=#447700>! this can be added to b_t, b_q, or b_u, b_v.<a name='1082'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!           <a name='1083'></font>
 <a name='1084'>
#endif <a name='1085'>
      <a name='1086'>
   ENDDO<a name='1087'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='1088'></font>
<font color=#447700>!<a name='1089'></font>
  <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1090'></font>
  <font color=#447700>!$OMP PRIVATE ( ij, i,j,k, its, ite, jts, jte, z0, z1, z2, w1, w2, message, initflag )<a name='1091'></font>
  DO ij = 1 , num_tiles<a name='1092'>
<a name='1093'>
   its = i_start(ij)<a name='1094'>
   ite = i_end(ij)<a name='1095'>
   jts = j_start(ij)<a name='1096'>
   jte = j_end(ij)<a name='1097'>
<a name='1098'>
   pbl_select: SELECT CASE(bl_pbl_physics)<a name='1099'>
<a name='1100'>
      CASE (TEMFPBLSCHEME)<a name='1101'>
<font color=#447700>! WA Test<a name='1102'></font>
       <font color=#447700>! WRITE( message , * ) 'Calling TEMF PBL scheme, timestep = ', itimestep<a name='1103'></font>
       <font color=#447700>! CALL wrf_message ( message )<a name='1104'></font>
       <font color=#447700>! print *,'Calling TEMF PBL scheme'<a name='1105'></font>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_693">(100,'in TEMF PBL')<a name='1106'>
           IF ( PRESENT( qv_curr )  .AND. PRESENT( qc_curr )  .AND. &amp;<a name='1107'>
                PRESENT( qi_curr )                            .AND. &amp;<a name='1108'>
                PRESENT( rqvblten ) .AND. PRESENT( rqcblten ) .AND. &amp;<a name='1109'>
                PRESENT( rqiblten )                           .AND. &amp;<a name='1110'>
                PRESENT( te_temf ) .AND. PRESENT( cfm_temf ) .AND. &amp;<a name='1111'>
                PRESENT( hol      ) ) THEN<a name='1112'>
             CALL <A href='../../html_code/phys/module_bl_temf.F.html#TEMFPBL'>temfpbl</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TEMFPBL_1">(                                              &amp;<a name='1113'>
               U3D=u_phytmp,V3D=v_phytmp,TH3D=th_phy,T3D=t_phy      &amp;<a name='1114'>
              ,QV3D=qv_curr,QC3D=qc_curr,QI3D=qi_curr               &amp;<a name='1115'>
              ,P3D=p_phy,P3DI=p8w,PI3D=pi_phy,RHO=rho               &amp;<a name='1116'>
              ,RUBLTEN=rublten,RVBLTEN=rvblten                      &amp;<a name='1117'>
              ,RTHBLTEN=rthblten,RQVBLTEN=rqvblten                  &amp;<a name='1118'>
              ,RQCBLTEN=rqcblten,RQIBLTEN=rqiblten                  &amp;<a name='1119'>
              ,FLAG_QI=flag_qi                                      &amp;<a name='1120'>
              ,g=g,cp=cp,rcp=rcp,r_d=r_d,r_v=r_v,cpv=cpv                    &amp;<a name='1121'>
              ,Z=z,XLV=XLV,PSFC=PSFC               &amp;<a name='1122'>
              ,P_TOP=p_top                                          &amp;<a name='1123'>
              ,ZNT=znt,HT=ht,UST=ust,ZOL=zol,HOL=hol,HPBL=pblh      &amp;<a name='1124'>
              ,PSIM=psim,PSIH=psih,XLAND=xland                      &amp;<a name='1125'>
              ,HFX=hfx,QFX=qfx,TSK=tskold,QSFC=qsfc,GZ1OZ0=gz1oz0   &amp;<a name='1126'>
              ,U10=u10,V10=v10,T2=t2                                &amp;<a name='1127'>
              ,WSPD=wspd,BR=br,DT=dtbl,DTMIN=dtmin,KPBL2D=kpbl      &amp;<a name='1128'>
              ,SVP1=svp1,SVP2=svp2,SVP3=svp3,SVPT0=svpt0            &amp;<a name='1129'>
              ,EP1=ep_1,EP2=ep_2,KARMAN=karman,EOMEG=eomeg          &amp;<a name='1130'>
              ,STBOLT=stbolt                                       &amp;<a name='1131'>
              ,te_temf=te_temf,kh_temf=kh_temf,km_temf=km_temf      &amp;<a name='1132'>
              ,shf_temf=shf_temf,qf_temf=qf_temf                    &amp;<a name='1133'>
              ,uw_temf=uw_temf,vw_temf=vw_temf                      &amp;<a name='1134'>
              ,hd_temf=hd_temf,lcl_temf=lcl_temf,hct_temf=hct_temf  &amp;<a name='1135'>
              ,wupd_temf=wupd_temf,mf_temf=mf_temf                  &amp;<a name='1136'>
              ,thup_temf=thup_temf,qtup_temf=qtup_temf,qlup_temf=qlup_temf  &amp;<a name='1137'>
              ,cf3d_temf=cf3d_temf,cfm_temf=cfm_temf                &amp;<a name='1138'>
              ,flhc=flhc,flqc=flqc,exch_temf=exch_temf              &amp;<a name='1139'>
              ,fCor=f                                            &amp;<a name='1140'>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde      &amp;<a name='1141'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme      &amp;<a name='1142'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte      &amp;<a name='1143'>
                                                                    )<a name='1144'>
           ELSE<a name='1145'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_892">('Lack arguments to call TEMF pbl')<a name='1146'>
           ENDIF<a name='1147'>
<a name='1148'>
      CASE (YSUSCHEME)<a name='1149'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_694">(100,'in YSU PBL')<a name='1150'>
           IF ( PRESENT( qv_curr )  .AND. PRESENT( qc_curr )  .AND. &amp;<a name='1151'>
                PRESENT( qi_curr )                            .AND. &amp;<a name='1152'>
                PRESENT( rqvblten ) .AND. PRESENT( rqcblten ) .AND. &amp;<a name='1153'>
                PRESENT( rqiblten )                           .AND. &amp;<a name='1154'>
                PRESENT( hol      ) ) THEN<a name='1155'>
<font color=#447700>!<a name='1156'></font>
             CALL <A href='../../html_code/phys/module_bl_ysu.F.html#YSU'>ysu</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="YSU_1">(                                              &amp;<a name='1157'>
               U3D=u_phytmp,V3D=v_phytmp,TH3D=th_phy,T3D=t_phy      &amp;<a name='1158'>
              ,QV3D=qv_curr,QC3D=qc_curr,QI3D=qi_curr               &amp;<a name='1159'>
              ,P3D=p_phy,P3DI=p8w,PI3D=pi_phy                       &amp;<a name='1160'>
              ,RUBLTEN=rublten,RVBLTEN=rvblten                      &amp;<a name='1161'>
              ,RTHBLTEN=rthblten,RQVBLTEN=rqvblten                  &amp;<a name='1162'>
              ,RQCBLTEN=rqcblten,RQIBLTEN=rqiblten                  &amp;<a name='1163'>
              ,FLAG_QI=flag_qi                                      &amp;<a name='1164'>
              ,CP=cp,G=g,ROVCP=rcp,RD=r_D,ROVG=rovg                 &amp;<a name='1165'>
              ,DZ8W=dz8w,XLV=XLV,RV=r_v,PSFC=PSFC                   &amp;<a name='1166'>
              ,ZNU=znu,ZNW=znw,P_TOP=p_top                          &amp;<a name='1167'>
              ,ZNT=znt,UST=ust,HPBL=pblh                            &amp;<a name='1168'>
              ,PSIM=fm,PSIH=fhh,XLAND=xland                         &amp;<a name='1169'>
              ,HFX=hfx,QFX=qfx                                      &amp;<a name='1170'>
              ,U10=u10,V10=v10                                      &amp;<a name='1171'>
              ,UOCE=uoce,VOCE=voce                                  &amp;<a name='1172'>
<font color=#447700>! paj<a name='1173'></font>
              ,CTOPO=ctopo,CTOPO2=ctopo2                            &amp;<a name='1174'>
              ,YSU_TOPDOWN_PBLMIX=ysu_topdown_pblmix                &amp;<a name='1175'>
              ,WSPD=wspd,BR=br,DT=dtbl,KPBL2D=kpbl                  &amp;<a name='1176'>
              ,EP1=ep_1,EP2=ep_2,KARMAN=karman                      &amp;<a name='1177'>
              ,EXCH_H=exch_h,REGIME=regime                          &amp;<a name='1178'>
              ,RTHRATEN=RTHRATEN                                    &amp;<a name='1179'>
<font color=#447700>! for grims shallow convection with ysupbl<a name='1180'></font>
              ,WSTAR=wstar,DELTA=delta                              &amp;<a name='1181'>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde      &amp;<a name='1182'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme      &amp;<a name='1183'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte      &amp;<a name='1184'>
                                                                    )<a name='1185'>
<font color=#447700>!<a name='1186'></font>
<font color=#447700>! FASDAS<a name='1187'></font>
<font color=#447700>!<a name='1188'></font>
              IF( fasdas == 1 ) THEN<a name='1189'>
                  DO j=j_start(ij),j_end(ij)<a name='1190'>
                  DO i=i_start(ij),i_end(ij)<a name='1191'>
                     scrp1 = rqvblten(i,1,j)<a name='1192'>
                     scrp1 = scrp1*(2.0*DT)/qv_curr(i,1,j)<a name='1193'>
                     scrp1 = scrp1*100.0<a name='1194'>
                     scrp1 = amax1(0.0,scrp1)<a name='1195'>
                     scrp1 = amin1(5.0,scrp1)<a name='1196'>
                     QNORM(I,J)= scrp1/100.0<a name='1197'>
                  ENDDO<a name='1198'>
                  ENDDO<a name='1199'>
              ENDIF<a name='1200'>
<font color=#447700>!<a name='1201'></font>
<font color=#447700>! END FASDAS<a name='1202'></font>
<font color=#447700>!<a name='1203'></font>
<a name='1204'>
           ELSE<a name='1205'>
               WRITE ( message , FMT = '(A,7(L1,1X))' )             &amp;<a name='1206'>
                 'present: '//                                      &amp;<a name='1207'>
                 'qv_curr, '//                                      &amp;<a name='1208'>
                 'qc_curr, '//                                      &amp;<a name='1209'>
                 'qi_curr, '//                                      &amp;<a name='1210'>
                 'rqvblten, '//                                     &amp;<a name='1211'>
                 'rqcblten, '//                                     &amp;<a name='1212'>
                 'rqiblten, '//                                     &amp;<a name='1213'>
                 'hol = ' ,                                         &amp;<a name='1214'>
                  PRESENT( qv_curr ) ,                              &amp;<a name='1215'>
                  PRESENT( qc_curr ) ,                              &amp;<a name='1216'>
                  PRESENT( qi_curr ) ,                              &amp;<a name='1217'>
                  PRESENT( rqvblten ) ,                             &amp;<a name='1218'>
                  PRESENT( rqcblten ) ,                             &amp;<a name='1219'>
                  PRESENT( rqiblten ) ,                             &amp;<a name='1220'>
                  PRESENT( hol      )<a name='1221'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_695">(0,message)<a name='1222'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_893">('Lack arguments to call YSU pbl')<a name='1223'>
           ENDIF<a name='1224'>
<a name='1225'>
      CASE (SHINHONGSCHEME)<a name='1226'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_696">(100,'in SHINHONG PBL')<a name='1227'>
           IF ( PRESENT( qv_curr )  .AND. PRESENT( qc_curr )  .AND. &amp;<a name='1228'>
                PRESENT( qi_curr )                            .AND. &amp;<a name='1229'>
                PRESENT( rqvblten ) .AND. PRESENT( rqcblten ) .AND. &amp;<a name='1230'>
                PRESENT( rqiblten )                           .AND. &amp;<a name='1231'>
                PRESENT( hol      ) ) THEN<a name='1232'>
<font color=#447700>!<a name='1233'></font>
             CALL <A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG'>shinhong</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHINHONG_1">(                                         &amp;<a name='1234'>
               U3D=u_phytmp,V3D=v_phytmp,TH3D=th_phy,T3D=t_phy      &amp;<a name='1235'>
              ,QV3D=qv_curr,QC3D=qc_curr,QI3D=qi_curr               &amp;<a name='1236'>
              ,P3D=p_phy,P3DI=p8w,PI3D=pi_phy                       &amp;<a name='1237'>
              ,RUBLTEN=rublten,RVBLTEN=rvblten                      &amp;<a name='1238'>
              ,RTHBLTEN=rthblten,RQVBLTEN=rqvblten                  &amp;<a name='1239'>
              ,RQCBLTEN=rqcblten,RQIBLTEN=rqiblten                  &amp;<a name='1240'>
              ,FLAG_QI=flag_qi                                      &amp;<a name='1241'>
              ,CP=cp,G=g,ROVCP=rcp,RD=r_D,ROVG=rovg                 &amp;<a name='1242'>
              ,DZ8W=dz8w,XLV=XLV,RV=r_v,PSFC=PSFC                   &amp;<a name='1243'>
              ,ZNU=znu,ZNW=znw,P_TOP=p_top                          &amp;<a name='1244'>
              ,ZNT=znt,UST=ust,HPBL=pblh                            &amp;<a name='1245'>
              ,PSIM=fm,PSIH=fhh,XLAND=xland                         &amp;<a name='1246'>
              ,HFX=hfx,QFX=qfx                                      &amp;<a name='1247'>
              ,U10=u10,V10=v10                                      &amp;<a name='1248'>
<font color=#447700>! paj<a name='1249'></font>
              ,CTOPO=ctopo,CTOPO2=ctopo2                            &amp;<a name='1250'>
              ,SHINHONG_TKE_DIAG=shinhong_tke_diag                  &amp;<a name='1251'>
              ,WSPD=wspd,BR=br,DT=dtbl,KPBL2D=kpbl                  &amp;<a name='1252'>
              ,EP1=ep_1,EP2=ep_2,KARMAN=karman                      &amp;<a name='1253'>
              ,EXCH_H=exch_h,REGIME=regime                          &amp;<a name='1254'>
<font color=#447700>! for grims shallow convection with shinhongpbl<a name='1255'></font>
              ,WSTAR=wstar,DELTA=delta                              &amp;<a name='1256'>
              ,TKE_PBL=tke_pbl,EL_PBL=el_pbl,CORF=f                 &amp;<a name='1257'>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde      &amp;<a name='1258'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme      &amp;<a name='1259'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte      &amp;<a name='1260'>
              ,DX=dx,DY=dy                                          &amp;<a name='1261'>
                                                                    )<a name='1262'>
           ELSE<a name='1263'>
               WRITE ( message , FMT = '(A,7(L1,1X))' )             &amp;<a name='1264'>
                 'present: '//                                      &amp;<a name='1265'>
                 'qv_curr, '//                                      &amp;<a name='1266'>
                 'qc_curr, '//                                      &amp;<a name='1267'>
                 'qi_curr, '//                                      &amp;<a name='1268'>
                 'rqvblten, '//                                     &amp;<a name='1269'>
                 'rqcblten, '//                                     &amp;<a name='1270'>
                 'rqiblten, '//                                     &amp;<a name='1271'>
                 'hol = ' ,                                         &amp;<a name='1272'>
                  PRESENT( qv_curr ) ,                              &amp;<a name='1273'>
                  PRESENT( qc_curr ) ,                              &amp;<a name='1274'>
                  PRESENT( qi_curr ) ,                              &amp;<a name='1275'>
                  PRESENT( rqvblten ) ,                             &amp;<a name='1276'>
                  PRESENT( rqcblten ) ,                             &amp;<a name='1277'>
                  PRESENT( rqiblten ) ,                             &amp;<a name='1278'>
                  PRESENT( hol      )<a name='1279'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_697">(0,message)<a name='1280'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_894">('Lack arguments to call SHINHONG pbl')<a name='1281'>
           ENDIF<a name='1282'>
<a name='1283'>
      CASE (MRFSCHEME)<a name='1284'>
           IF ( PRESENT( qv_curr )  .AND. PRESENT( qc_curr )  .AND. &amp;<a name='1285'>
                PRESENT( rqvblten ) .AND. PRESENT( rqcblten ) .AND. &amp;<a name='1286'>
                PRESENT( hol      )                           .AND. &amp;<a name='1287'>
                                                        .TRUE.  ) THEN<a name='1288'>
<a name='1289'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_698">(100,'in MRF')<a name='1290'>
             CALL <A href='../../html_code/phys/module_bl_mrf.F.html#MRF'>mrf</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MRF_1">(                                              &amp;<a name='1291'>
               U3D=u_phytmp,V3D=v_phytmp,TH3D=th_phy,T3D=t_phy      &amp;<a name='1292'>
              ,QV3D=qv_curr                                         &amp;<a name='1293'>
              ,QC3D=qc_curr                                         &amp;<a name='1294'>
              ,QI3D=qi_curr                                         &amp;<a name='1295'>
              ,P3D=p_phy,PI3D=pi_phy                                &amp;<a name='1296'>
              ,RUBLTEN=rublten,RVBLTEN=rvblten                      &amp;<a name='1297'>
              ,RTHBLTEN=rthblten,RQVBLTEN=rqvblten                  &amp;<a name='1298'>
              ,RQCBLTEN=rqcblten,RQIBLTEN=rqiblten                  &amp;<a name='1299'>
              ,CP=cp,G=g,ROVCP=rcp,R=r_d,ROVG=rovg                  &amp;<a name='1300'>
              ,DZ8W=dz8w,Z=z,XLV=xlv,RV=r_v,PSFC=psfc               &amp;<a name='1301'>
              ,P1000MB=p1000mb                                      &amp;<a name='1302'>
              ,ZNT=znt,UST=ust,ZOL=zol,HOL=hol                      &amp;<a name='1303'>
              ,PBL=pblh,PSIM=psim,PSIH=psih                         &amp;<a name='1304'>
              ,XLAND=xland,HFX=hfx,QFX=qfx,TSK=tskold               &amp;<a name='1305'>
              ,GZ1OZ0=gz1oz0,WSPD=wspd,BR=br                        &amp;<a name='1306'>
              ,DT=dtbl,DTMIN=dtmin,KPBL2D=kpbl                      &amp;<a name='1307'>
              ,SVP1=svp1,SVP2=svp2,SVP3=svp3,SVPT0=svpt0            &amp;<a name='1308'>
              ,EP1=ep_1,EP2=ep_2,KARMAN=karman,EOMEG=eomeg          &amp;<a name='1309'>
              ,STBOLT=stbolt,REGIME=regime                          &amp;<a name='1310'>
              ,FLAG_QI=flag_qi                                      &amp;<a name='1311'>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde      &amp;<a name='1312'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme      &amp;<a name='1313'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte      &amp;<a name='1314'>
                                                                    ) <a name='1315'>
           ELSE<a name='1316'>
               WRITE ( message , FMT = '(A,5(L1,1X))' )             &amp;<a name='1317'>
                 'present: '//                                      &amp;<a name='1318'>
                 'qv_curr, '//                                      &amp;<a name='1319'>
                 'qc_curr, '//                                      &amp;<a name='1320'>
                 'rqvblten, '//                                     &amp;<a name='1321'>
                 'rqcblten, '//                                     &amp;<a name='1322'>
                 'hol = ' ,                                         &amp;<a name='1323'>
                  PRESENT( qv_curr ) ,                              &amp;<a name='1324'>
                  PRESENT( qc_curr ) ,                              &amp;<a name='1325'>
                  PRESENT( rqvblten ) ,                             &amp;<a name='1326'>
                  PRESENT( rqcblten ) ,                             &amp;<a name='1327'>
                  PRESENT( hol      )<a name='1328'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_699">(0,message)<a name='1329'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_895">('Lack arguments to call MRF pbl')<a name='1330'>
           ENDIF<a name='1331'>
<a name='1332'>
      CASE (GFSSCHEME)<a name='1333'>
           IF ( PRESENT( qv_curr )  .AND. PRESENT( qc_curr )  .AND. &amp;<a name='1334'>
                PRESENT( rqvblten ) .AND. PRESENT( rqcblten ) .AND. &amp;<a name='1335'>
                                                        .TRUE.  ) THEN<a name='1336'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_700">(100,'in GFS')<a name='1337'>
             CALL <A href='../../html_code/phys/module_bl_gfs.F.html#BL_GFS'>bl_gfs</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BL_GFS_1">(                                           &amp;<a name='1338'>
               U3D=u_phytmp,V3D=v_phytmp                            &amp;<a name='1339'>
              ,TH3D=th_phy,T3D=t_phy                                &amp;<a name='1340'>
              ,QV3D=qv_curr,QC3D=qc_curr,QI3D=qi_curr               &amp;<a name='1341'>
              ,P3D=p_phy,PI3D=pi_phy                                &amp;<a name='1342'>
              ,RUBLTEN=rublten,RVBLTEN=rvblten,RTHBLTEN=rthblten    &amp;<a name='1343'>
              ,RQVBLTEN=rqvblten,RQCBLTEN=rqcblten                  &amp;<a name='1344'>
              ,RQIBLTEN=rqiblten                                    &amp;<a name='1345'>
              ,CP=cp,G=g,ROVCP=rcp,R=r_d,ROVG=rovg                  &amp;<a name='1346'>
              ,DZ8W=dz8w,z=z,PSFC=psfc                              &amp;<a name='1347'>
              ,UST=ust,PBL=pblh,PSIM=psim,PSIH=psih                 &amp;<a name='1348'>
              ,HFX=hfx,QFX=qfx,TSK=tskold,GZ1OZ0=gz1oz0             &amp;<a name='1349'>
              ,WSPD=wspd,BR=br                                      &amp;<a name='1350'>
              ,DT=dtbl,KPBL2D=kpbl,EP1=ep_1,KARMAN=karman           &amp;<a name='1351'>
#if (NMM_CORE==1)<a name='1352'>
              ,DISHEAT=DISHEAT                                      &amp;<a name='1353'>
#endif<a name='1354'>
#if ( HWRF == 1 )<a name='1355'>
              ,ALPHA=gfs_alpha                                      &amp;<a name='1356'>
              ,HPBL2D=HPBL2D, EVAP2D=EVAP2D, HEAT2D=HEAT2D          &amp;   <font color=#447700>!Kwon add FOR SHAL. CON.<a name='1357'></font>
              ,VAR_RIC=VAR_RIC                                      &amp;   <font color=#447700>!Kwon for variable Ric<a name='1358'></font>
              ,U10=U10,V10=V10,ZNT=ZNT,MZNT=MZNT,RC2D=RC2D          &amp;   <font color=#447700>!Kwon for variable Ric<a name='1359'></font>
              ,DKU3D=DKU3D,DKT3D=DKT3D                              &amp;<a name='1360'>
              ,coef_ric_l=coef_ric_l,coef_ric_s=coef_ric_s,xland=xland    &amp;<a name='1361'>
              ,MSANG=MSANG,SCURX=SCURX,SCURY=SCURY,IWAVECPL=IWAVECPL,LCURR_SF=LCURR_SF &amp;<a name='1362'>
              ,pert_pbl=pert_pbl                                    &amp;<a name='1363'>
              ,ens_random_seed=ens_random_seed                      &amp;<a name='1364'>
              ,ens_pblamp=ens_pblamp                                &amp;<a name='1365'>
#endif<a name='1366'>
              ,P_QI=p_qi,P_FIRST_SCALAR=param_first_scalar          &amp;<a name='1367'>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde      &amp;<a name='1368'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme      &amp;<a name='1369'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte      &amp;<a name='1370'>
                                                                    )<a name='1371'>
           ELSE<a name='1372'>
               WRITE ( message , FMT = '(A,4(L1,1X))' )             &amp;<a name='1373'>
                 'present: '//                                      &amp;<a name='1374'>
                 'qv_curr, '//                                      &amp;<a name='1375'>
                 'qc_curr, '//                                      &amp;<a name='1376'>
                 'rqvblten, '//                                     &amp;<a name='1377'>
                 'rqcblten = ',                                     &amp;<a name='1378'>
                  PRESENT( qv_curr ) ,                              &amp;<a name='1379'>
                  PRESENT( qc_curr ) ,                              &amp;<a name='1380'>
                  PRESENT( rqvblten ) ,                             &amp;<a name='1381'>
                  PRESENT( rqcblten )<a name='1382'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_701">(0,message)<a name='1383'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_896">('Lack arguments to call GFS pbl')<a name='1384'>
           ENDIF<a name='1385'>
<a name='1386'>
#if (HWRF==1)<a name='1387'>
      CASE (GFSEDMFSCHEME)<a name='1388'>
           IF ( PRESENT( qv_curr )  .AND. PRESENT( qc_curr )  .AND. &amp;<a name='1389'>
                PRESENT( rqvblten ) .AND. PRESENT( rqcblten ) .AND. &amp;<a name='1390'>
                                                        .TRUE.  ) THEN<a name='1391'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_702">(100,'in GFS')<a name='1392'>
             CALL <A href='../../html_code/phys/module_bl_gfsedmf.F.html#BL_GFSEDMF'>bl_gfsedmf</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BL_GFSEDMF_1">(                                       &amp;<a name='1393'>
               U3D=u_phytmp,V3D=v_phytmp                            &amp;<a name='1394'>
              ,TH3D=th_phy,T3D=t_phy                                &amp;<a name='1395'>
              ,QV3D=qv_curr,QC3D=qc_curr,QI3D=qi_curr               &amp;<a name='1396'>
              ,P3D=p_phy,PI3D=pi_phy                                &amp;<a name='1397'>
              ,RUBLTEN=rublten,RVBLTEN=rvblten,RTHBLTEN=rthblten    &amp;<a name='1398'>
              ,RQVBLTEN=rqvblten,RQCBLTEN=rqcblten                  &amp;<a name='1399'>
              ,RQIBLTEN=rqiblten                                    &amp;<a name='1400'>
              ,CP=cp,G=g,ROVCP=rcp,R=r_d,ROVG=rovg                  &amp;<a name='1401'>
              ,P_QI=p_qi,P_FIRST_SCALAR=param_first_scalar          &amp;<a name='1402'>
              ,DZ8W=dz8w,z=z,PSFC=psfc                              &amp;<a name='1403'>
              ,UST=ust,PBL=pblh,PSIM=psim,PSIH=psih                 &amp;<a name='1404'>
              ,HFX=hfx,QFX=qfx,TSK=tskold,GZ1OZ0=gz1oz0             &amp;<a name='1405'>
              ,WSPD=wspd,BR=br                                      &amp;<a name='1406'>
              ,DT=dtbl,KPBL2D=kpbl,EP1=ep_1,KARMAN=karman           &amp;<a name='1407'>
              ,DISHEAT=DISHEAT                                      &amp;<a name='1408'>
              ,RTHRATEN=RTHRATEN                    &amp;<a name='1409'>
              ,HPBL2D=HPBL2D, EVAP2D=EVAP2D, HEAT2D=HEAT2D          &amp;<a name='1410'>
              ,U10=u10,V10=v10,ZNT=mznt                             &amp;<a name='1411'>
              ,DKU3D=dku3d,DKT3D=dkt3d                             &amp;<a name='1412'>
              ,VAR_RIC=VAR_RIC                                      &amp;<a name='1413'>
              ,coef_ric_l=coef_ric_l,coef_ric_s=coef_ric_s          &amp;<a name='1414'>
              ,ALPHA=gfs_alpha                                      &amp;<a name='1415'>
              ,xland=xland                                          &amp;<a name='1416'>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde      &amp;<a name='1417'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme      &amp;<a name='1418'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte      &amp;<a name='1419'>
                                                                    )<a name='1420'>
           ELSE<a name='1421'>
               WRITE ( message , FMT = '(A,4(L1,1X))' )             &amp;<a name='1422'>
                 'present: '//                                      &amp;<a name='1423'>
                 'qv_curr, '//                                      &amp;<a name='1424'>
                 'qc_curr, '//                                      &amp;<a name='1425'>
                 'rqvblten, '//                                     &amp;<a name='1426'>
                 'rqcblten = ',                                     &amp;<a name='1427'>
                  PRESENT( qv_curr ) ,                              &amp;<a name='1428'>
                  PRESENT( qc_curr ) ,                              &amp;<a name='1429'>
                  PRESENT( rqvblten ) ,                             &amp;<a name='1430'>
                  PRESENT( rqcblten )<a name='1431'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_703">(0,message)<a name='1432'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_897">('Lack arguments to call GFS edmf pbl')<a name='1433'>
           ENDIF<a name='1434'>
#endif<a name='1435'>
      CASE (MYJPBLSCHEME)<a name='1436'>
           IF ( PRESENT( qv_curr )  .AND. PRESENT( qc_curr )  .AND. &amp;<a name='1437'>
                PRESENT( rqvblten ) .AND. PRESENT( rqcblten ) .AND. &amp;<a name='1438'>
                                                        .TRUE.  ) THEN<a name='1439'>
<a name='1440'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_704">(100,'in MYJPBL')<a name='1441'>
            IF ( .not.flag_bep .and. idiff.ne.1) THEN<a name='1442'>
             CALL <A href='../../html_code/phys/module_bl_myjpbl.F.html#MYJPBL'>myjpbl</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYJPBL_1">(DT=dt,STEPBL=stepbl,HT=ht,DZ=dz8w          &amp;<a name='1443'>
              ,PMID=p_phy,PINT=p8w,TH=th_phy,T=t_phy,EXNER=pi_phy   &amp;<a name='1444'>
              ,QV=qv_curr,QCW=qc_curr,QCI=qi_curr,QCS=qs_curr       &amp; <font color=#447700>!BSF<a name='1445'></font>
              ,QCR=qr_curr,QCG=qg_curr                              &amp; <font color=#447700>!BSF<a name='1446'></font>
              ,U=u_phy,V=v_phy,RHO=rho                              &amp;<a name='1447'>
              ,TSK=tsk,QSFC=qsfc,CHKLOWQ=chklowq,THZ0=thz0          &amp;<a name='1448'>
              ,QZ0=qz0,UZ0=uz0,VZ0=vz0                              &amp;<a name='1449'>
              ,LOWLYR=lowlyr                                        &amp;<a name='1450'>
              ,XLAND=xland,SICE=xice,SNOW=snow                      &amp;<a name='1451'>
              ,TKE_MYJ=tke_pbl,EXCH_H=exch_h,USTAR=ust,ZNT=znt      &amp;<a name='1452'>
              ,EL_MYJ=el_pbl,PBLH=pblh,KPBL=kpbl,CT=ct              &amp;<a name='1453'>
              ,AKHS=akhs,AKMS=akms,ELFLX=lh,MIXHT=mixht             &amp;  <a name='1454'>
              ,RUBLTEN=rublten,RVBLTEN=rvblten,RTHBLTEN=rthblten    &amp;<a name='1455'>
              ,RQVBLTEN=rqvblten,RQCBLTEN=rqcblten                  &amp;<a name='1456'>
              ,RQIBLTEN=rqiblten,RQSBLTEN=rqsblten                  &amp; <font color=#447700>!BSF<a name='1457'></font>
              ,RQRBLTEN=rqrblten,RQGBLTEN=rqgblten                  &amp; <font color=#447700>!BSF<a name='1458'></font>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde      &amp;<a name='1459'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme      &amp;<a name='1460'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte      &amp;<a name='1461'>
                                                                    )<a name='1462'>
            ELSE <font color=#447700>!(SF_URBAN_PHYSICS.EQ.2)<a name='1463'></font>
<font color=#447700>! Bep changes begin<a name='1464'></font>
<a name='1465'>
             CALL <A href='../../html_code/phys/module_bl_myjurb.F.html#MYJURB'>myjurb</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYJURB_1">(IDIFF=idiff,FLAG_BEP=flag_bep              &amp;<a name='1466'>
              ,DT=dtbl,STEPBL=stepbl,HT=ht,DZ=dz8w                  &amp;<a name='1467'>
              ,PMID=p_phy,PINT=p8w,TH=th_phy,T=t_phy,EXNER=pi_phy   &amp;<a name='1468'>
              ,QV=qv_curr, CWM=qc_curr                              &amp;<a name='1469'>
              ,U=u_phy,V=v_phy,RHO=rho                              &amp;<a name='1470'>
              ,TSK=tsk,QSFC=qsfc,CHKLOWQ=chklowq,THZ0=thz0          &amp;<a name='1471'>
              ,QZ0=qz0,UZ0=uz0,VZ0=vz0                              &amp;<a name='1472'>
              ,LOWLYR=lowlyr                                        &amp;<a name='1473'>
              ,XLAND=xland,SICE=xice,SNOW=snow                      &amp;<a name='1474'>
              ,TKE_MYJ=tke_pbl,EXCH_H=exch_h,EXCH_M=exch_m          &amp;<a name='1475'>
              ,USTAR=ust,ZNT=znt                                    &amp;<a name='1476'>
              ,EL_MYJ=el_pbl,PBLH=pblh,KPBL=kpbl,CT=ct              &amp;<a name='1477'>
              ,AKHS=akhs,AKMS=akms,ELFLX=lh                         &amp;<a name='1478'>
              ,RUBLTEN=rublten,RVBLTEN=rvblten,RTHBLTEN=rthblten    &amp;<a name='1479'>
              ,RQVBLTEN=rqvblten,RQCBLTEN=rqcblten                  &amp;<a name='1480'>
<font color=#447700>! Multi-layer UCM<a name='1481'></font>
              ,FRC_URB2D=frc_urb2d                                  &amp;<a name='1482'>
              ,A_U_BEP=a_u_bep,A_V_BEP=a_v_bep,A_T_BEP=a_t_bep      &amp;<a name='1483'>
              ,A_Q_BEP=a_q_bep                                      &amp;<a name='1484'>
              ,A_E_BEP=a_e_bep,B_U_BEP=b_u_bep,B_V_BEP=b_v_bep      &amp;<a name='1485'>
              ,B_T_BEP=b_t_bep,B_Q_BEP=b_q_bep                      &amp;<a name='1486'>
              ,B_E_BEP=b_e_bep,DLG_BEP=dlg_bep                      &amp;<a name='1487'>
              ,DL_U_BEP=dl_u_bep,SF_BEP=sf_bep,VL_BEP=vl_bep        &amp;<a name='1488'>
<font color=#447700>! UCM end<a name='1489'></font>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde      &amp;<a name='1490'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme      &amp;<a name='1491'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte      &amp;<a name='1492'>
                                                                    )<a name='1493'>
            ENDIF<a name='1494'>
<a name='1495'>
           ELSE<a name='1496'>
               WRITE ( message , FMT = '(A,4(L1,1X))' )             &amp;<a name='1497'>
                 'present: '//                                      &amp;<a name='1498'>
                 'qv_curr, '//                                      &amp;<a name='1499'>
                 'qc_curr, '//                                      &amp;<a name='1500'>
                 'rqvblten, '//                                     &amp;<a name='1501'>
                 'rqcblten = ' ,                                    &amp;<a name='1502'>
                  PRESENT( qv_curr ) ,                              &amp;<a name='1503'>
                  PRESENT( qc_curr ) ,                              &amp;<a name='1504'>
                  PRESENT( rqvblten ) ,                             &amp;<a name='1505'>
                  PRESENT( rqcblten )<a name='1506'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_705">(0,message)<a name='1507'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_898">('Lack arguments to call MYJ pbl')<a name='1508'>
           ENDIF<a name='1509'>
 <a name='1510'>
      CASE (QNSEPBLSCHEME)<a name='1511'>
           IF ( PRESENT( qv_curr )  .AND. PRESENT( qc_curr )  .AND. &amp;<a name='1512'>
                PRESENT( rqvblten ) .AND. PRESENT( rqcblten ) .AND. &amp;<a name='1513'>
                                                        .TRUE.  ) THEN<a name='1514'>
               IF ( MFSHCONV.EQ.1 )THEN<a name='1515'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_706">(100,'in MFSHCONVPBL')<a name='1516'>
               CALL <A href='../../html_code/phys/module_bl_mfshconvpbl.F.html#MFSHCONVPBL'>mfshconvpbl</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MFSHCONVPBL_1">(DT=dt,STEPBL=stepbl,HT=ht,DZ=dz8w         &amp;<a name='1517'>
                    ,RHO=rho,PMID=p_phy,PINT=p8w,TH=th_phy,EXNER=pi_phy   &amp;<a name='1518'>
                    ,QV=qv_curr, QC=qc_curr                    &amp;<a name='1519'>
                    ,U=u_phy,V=v_phy                                      &amp;<a name='1520'>
                    ,HFX=hfx, QFX=qfx,TKE=tke_pbl                         &amp;<a name='1521'>
                    ,RUBLTEN=rublten,RVBLTEN=rvblten,RTHBLTEN=rthblten    &amp;<a name='1522'>
                    ,RQVBLTEN=rqvblten,RQCBLTEN=rqcblten                  &amp;<a name='1523'>
                    ,IDS=IDS,IDE=IDE,JDS=JDS,JDE=JDE,KDS=KDS,KDE=KDE      &amp;<a name='1524'>
                    ,IMS=IMS,IME=IME,JMS=JMS,JME=JME,KMS=KMS,KME=KME      &amp;<a name='1525'>
                    ,ITS=ITS,ITE=ITE,JTS=JTS,JTE=JTE,KTS=KTS,KTE=KTE      &amp;<a name='1526'>
                    ,KRR=2,MASSFLUX_EDKF=massflux_EDKF                    &amp;<a name='1527'>
                    ,ENTR_EDKF=entr_EDKF, DETR_EDKF=detr_EDKF             &amp; <a name='1528'>
                    ,THL_UP=thl_up, THV_UP=thv_up, RT_UP=rt_up            &amp;<a name='1529'>
                    ,RV_UP=rv_up,RC_UP=rc_up, U_UP=u_up, V_UP=v_up        &amp;<a name='1530'>
                    ,FRAC_UP=frac_up, RC_MF=rc_mf,WTHV=u_phytmp           &amp;<a name='1531'>
                    ,PLM_BL89=v_phytmp   ) <a name='1532'>
               ENDIF   <a name='1533'>
<a name='1534'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_707">(100,'in QNSEPBL')<a name='1535'>
             CALL <A href='../../html_code/phys/module_bl_qnsepbl.F.html#QNSEPBL'>qnsepbl</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QNSEPBL_1">(                                           &amp;<a name='1536'>
               DT=dt,STEPBL=stepbl,HT=ht,DZ=dz8w                    &amp;<a name='1537'>
              ,PMID=p_phy,PINT=p8w,TH=th_phy,T=t_phy,EXNER=pi_phy   &amp;<a name='1538'>
              ,QV=qv_curr, CWM=qc_curr                              &amp;<a name='1539'>
              ,U=u_phy,V=v_phy,RHO=rho                              &amp;<a name='1540'>
              ,TSK=tsk,QSFC=qsfc,CHKLOWQ=chklowq,THZ0=thz0          &amp;<a name='1541'>
              ,QZ0=qz0,UZ0=uz0,VZ0=vz0,CORF=f                       &amp;<a name='1542'>
              ,LOWLYR=lowlyr                                        &amp;<a name='1543'>
              ,XLAND=xland,SICE=xice,SNOW=snow                      &amp;<a name='1544'>
              ,TKE=tke_pbl,EXCH_H=exch_h,EXCH_M=exch_m,USTAR=ust,ZNT=znt      &amp;<a name='1545'>
              ,EL_MYJ=el_pbl,PBLH=pblh,KPBL=kpbl,CT=ct              &amp;<a name='1546'>
              ,AKHS=akhs,AKMS=akms,ELFLX=lh                         &amp;<a name='1547'>
              ,HFX=hfx,WTHV_MF=u_phytmp,LM_BL89=v_phytmp            &amp; <a name='1548'>
              ,RUBLTEN=rublten,RVBLTEN=rvblten,RTHBLTEN=rthblten    &amp;<a name='1549'>
              ,RQVBLTEN=rqvblten,RQCBLTEN=rqcblten                  &amp;<a name='1550'>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde      &amp;<a name='1551'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme      &amp;<a name='1552'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte      &amp;<a name='1553'>
                                                                    )<a name='1554'>
<font color=#447700>! note the tendencies have been added inside qnse <a name='1555'></font>
<font color=#447700>!            IF ( PRESENT (MFSHCONV) )THEN<a name='1556'></font>
<font color=#447700>!              IF (MFSHCONV.EQ.1)THEN<a name='1557'></font>
<font color=#447700>!              rublten(:,:,:)=rublten(:,:,:)+rumften(:,:,:)<a name='1558'></font>
<font color=#447700>!              rvblten(:,:,:)=rvblten(:,:,:)+rvmften(:,:,:)<a name='1559'></font>
<font color=#447700>!              rthblten(:,:,:)=rthblten(:,:,:)+rthmften(:,:,:)<a name='1560'></font>
<font color=#447700>!              rqvblten(:,:,:)=rqvblten(:,:,:)+rqvmften(:,:,:)<a name='1561'></font>
<font color=#447700>!              rqcblten(:,:,:)=rqcblten(:,:,:)+rqcmften(:,:,:)<a name='1562'></font>
<font color=#447700>!              ENDIF   <a name='1563'></font>
<font color=#447700>!            ENDIF   <a name='1564'></font>
<a name='1565'>
            ELSE<a name='1566'>
               WRITE ( message , FMT = '(A,4(L1,1X))' )             &amp;<a name='1567'>
                 'present: '//                                      &amp;<a name='1568'>
                 'qv_curr, '//                                      &amp;<a name='1569'>
                 'qc_curr, '//                                      &amp;<a name='1570'>
                 'rqvblten, '//                                     &amp;<a name='1571'>
                 'rqcblten = ' ,                                    &amp;<a name='1572'>
                  PRESENT( qv_curr ) ,                              &amp;<a name='1573'>
                  PRESENT( qc_curr ) ,                              &amp;<a name='1574'>
                  PRESENT( rqvblten ) ,                             &amp;<a name='1575'>
                  PRESENT( rqcblten )<a name='1576'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_708">(0,message)<a name='1577'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_899">('Lack arguments to call QNSE pbl')<a name='1578'>
           ENDIF<a name='1579'>
<a name='1580'>
      CASE (ACMPBLSCHEME)<a name='1581'>
           <a name='1582'>
           <font color=#447700>!!  These are values that are not supplied to pbl driver, but are required by ACM<a name='1583'></font>
           IF ( PRESENT( qv_curr )  .AND. PRESENT( qc_curr )  .AND. &amp;<a name='1584'>
                PRESENT( rqvblten ) .AND. PRESENT( rqcblten ) .AND. &amp;<a name='1585'>
                                                        .TRUE.  ) THEN<a name='1586'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_709">(100,'in ACM PBL')<a name='1587'>
<a name='1588'>
             CALL <A href='../../html_code/phys/module_bl_acm.F.html#ACMPBL'>ACMPBL</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACMPBL_1">(                                                        &amp;<a name='1589'>
               XTIME=itimestep, DTPBL=dtbl, ZNW=znw, SIGMAH=znu               &amp;<a name='1590'>
              ,U3D=u_phytmp, V3D=v_phytmp, PP3D=p_phy, DZ8W=dz8w, TH3D=th_phy, T3D=t_phy            &amp;<a name='1591'>
              ,QV3D=qv_curr, QC3D=qc_curr, QI3D=qi_curr, RR3D=rho                &amp;<a name='1592'>
#if (WRF_CHEM == 1)<a name='1593'>
              ,CHEM3D=CHEM,   VD3D=VD,  NCHEM=nchem, KDVEL=kdvel              &amp;<a name='1594'>
              ,NDVEL=ndvel, NUM_VERT_MIX=num_vert_mix                         &amp;<a name='1595'>
#endif<a name='1596'>
              ,UST=UST, HFX=HFX, QFX=QFX, TSK=tsk                               &amp;<a name='1597'>
              ,PSFC=PSFC, EP1=EP_1, G=g, ROVCP=rcp,RD=r_D,CPD=cp                 &amp;<a name='1598'>
              ,PBLH=pblh, KPBL2D=kpbl, EXCH_H=exch_h, REGIME=regime              &amp;<a name='1599'>
              ,GZ1OZ0=gz1oz0,WSPD=wspd,PSIM=psim, MUT=mut, RMOL=rmol             &amp;<a name='1600'>
              ,RUBLTEN=rublten,RVBLTEN=rvblten,RTHBLTEN=rthblten                 &amp;<a name='1601'>
              ,RQVBLTEN=rqvblten,RQCBLTEN=rqcblten,RQIBLTEN=rqiblten             &amp;<a name='1602'>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde                   &amp;<a name='1603'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme                   &amp;<a name='1604'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte                   &amp;   <a name='1605'>
                                                                      )<a name='1606'>
           ELSE<a name='1607'>
               WRITE ( message , FMT = '(A,4(L1,1X))' )             &amp;<a name='1608'>
                 'present: '//                                      &amp;<a name='1609'>
                 'qv_curr, '//                                      &amp;<a name='1610'>
                 'qc_curr, '//                                      &amp;<a name='1611'>
                 'rqvblten, '//                                     &amp;<a name='1612'>
                 'rqcblten = ' ,                                    &amp;<a name='1613'>
                  PRESENT( qv_curr ) ,                              &amp;<a name='1614'>
                  PRESENT( qc_curr ) ,                              &amp;<a name='1615'>
                  PRESENT( rqvblten ) ,                             &amp;<a name='1616'>
                  PRESENT( rqcblten )<a name='1617'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_710">(0,message)<a name='1618'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_900">('Lack arguments to call ACM2 pbl')<a name='1619'>
           ENDIF<a name='1620'>
<a name='1621'>
#if (EM_CORE==1)<a name='1622'>
<a name='1623'>
        CASE (MYNNPBLSCHEME2, MYNNPBLSCHEME3)<a name='1624'>
<a name='1625'>
           IF ( PRESENT( qv_curr )  .AND. PRESENT( qc_curr )  .AND. &amp;<a name='1626'>
                PRESENT( rqvblten ) .AND. PRESENT( rqcblten ) .AND. &amp;<a name='1627'>
                PRESENT( qi_curr ) .AND. PRESENT( rqiblten ) .AND.  &amp;<a name='1628'>
                PRESENT( rqniblten ) .AND. PRESENT( qni_curr ) .AND.&amp;<a name='1629'>
                PRESENT(qke) .AND. PRESENT(tsq) .AND.               &amp;<a name='1630'>
                PRESENT(qsq) .AND. PRESENT(cov) .AND.               &amp;<a name='1631'>
                PRESENT(rmol) .AND.                                 &amp;<a name='1632'>
                PRESENT(qcg) .AND. PRESENT(ch) .AND.                &amp;<a name='1633'>
                PRESENT(grav_settling) .AND.                        &amp;<a name='1634'>
                PRESENT(bl_mynn_tkebudget) .AND.                    &amp;<a name='1635'>
<font color=#447700>!ACF,JOE-QKE advection<a name='1636'></font>
                PRESENT(qke_adv) .AND. PRESENT(bl_mynn_tkeadvect) .AND.&amp;<a name='1637'>
<font color=#447700>!ACF,JOE-end<a name='1638'></font>
                PRESENT(vdfg) ) THEN<a name='1639'>
<a name='1640'>
              CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_711">(100,'in MYNNPBL')<a name='1641'>
<a name='1642'>
              IF (itimestep==1) THEN<a name='1643'>
                 initflag=1<a name='1644'>
              ELSE<a name='1645'>
                 initflag=0<a name='1646'>
              ENDIF<a name='1647'>
              <a name='1648'>
              CALL  <A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER'>mynn_bl_driver</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYNN_BL_DRIVER_1">(&amp;<a name='1649'>
                   &amp;initflag=initflag,grav_settling=grav_settling,       &amp;<a name='1650'>
                   &amp;delt=dtbl,dz=dz8w,dx=dx,znt=znt,                     &amp;<a name='1651'>
                   &amp;u=u_phy,v=v_phy,w=w,th=th_phy,qv=qv_curr,qc=qc_curr, &amp;<a name='1652'>
                   &amp;qi=qi_curr,qni=qni_curr,qnc=qnc_curr,                &amp;<a name='1653'>
                   &amp;p=p_phy,exner=pi_phy,rho=rho,T3D=t_phy,              &amp;<a name='1654'>
                   &amp;xland=xland,ts=tsk,qsfc=qsfc,qcg=qcg,ps=psfc,        &amp;<a name='1655'>
                   &amp;ust=ust,ch=ch,hfx=hfx,qfx=qfx,rmol=rmol,wspd=wspd,   &amp;<a name='1656'>
                   &amp;uoce=uoce,voce=voce,                                 &amp; <font color=#447700>!Ocean currents<a name='1657'></font>
                   &amp;vdfg=vdfg,                                           &amp; <font color=#447700>!Katata -added<a name='1658'></font>
                   &amp;Qke=qke,TKE_PBL=tke_pbl,                             &amp;<a name='1659'>
                   &amp;Sh3d=Sh3d,                                           &amp;<a name='1660'>
                   &amp;qke_adv=qke_adv,bl_mynn_tkeadvect=bl_mynn_tkeadvect, &amp;<a name='1661'>
#if (WRF_CHEM == 1)<a name='1662'>
                   &amp;chem3d=chem,vd3d=vd,nchem=nchem,kdvel=kdvel,         &amp; <font color=#447700>! WA 7/31/15<a name='1663'></font>
                   &amp;ndvel=ndvel,num_vert_mix=num_vert_mix,               &amp;<a name='1664'>
#endif<a name='1665'>
                   &amp;Tsq=tsq,Qsq=qsq,Cov=cov,                             &amp;<a name='1666'>
                   &amp;RUBLTEN=rublten,RVBLTEN=rvblten,RTHBLTEN=rthblten,   &amp;<a name='1667'>
                   &amp;RQVBLTEN=rqvblten,RQCBLTEN=rqcblten,RQIBLTEN=rqiblten,&amp;<a name='1668'>
                   &amp;RQNIBLTEN=rqniblten,                                 &amp;<a name='1669'>
                   &amp;EXCH_H=exch_h,EXCH_M=exch_m,                         &amp;<a name='1670'>
                   &amp;pblh=pblh,KPBL=KPBL                                  &amp;<a name='1671'>
                   &amp;,el_pbl=el_pbl                                       &amp;<a name='1672'>
                   &amp;,dqke=dqke                                           &amp;<a name='1673'>
                   &amp;,qWT=qWT,qSHEAR=qSHEAR,qBUOY=qBUOY,qDISS=qDISS       &amp;<a name='1674'>
                   &amp;,WSTAR=wstar,DELTA=delta                             &amp; <font color=#447700>! for grims shallow-cu<a name='1675'></font>
                   &amp;,bl_mynn_tkebudget=bl_mynn_tkebudget                 &amp;<a name='1676'>
                   &amp;,bl_mynn_cloudpdf=bl_mynn_cloudpdf                   &amp;<a name='1677'>
                   &amp;,bl_mynn_mixlength=bl_mynn_mixlength                 &amp;<a name='1678'>
                   &amp;,icloud_bl=icloud_bl,qc_bl=qc_bl                     &amp;<a name='1679'>
                   &amp;,cldfra_bl=cldfra_bl                                 &amp;<a name='1680'>
                   &amp;,bl_mynn_edmf=bl_mynn_edmf                           &amp;<a name='1681'>
                   &amp;,bl_mynn_edmf_mom=bl_mynn_edmf_mom                   &amp;<a name='1682'>
                   &amp;,bl_mynn_edmf_tke=bl_mynn_edmf_tke                   &amp;<a name='1683'>
                   &amp;,bl_mynn_edmf_part=bl_mynn_edmf_part                 &amp;<a name='1684'>
                   &amp;,bl_mynn_cloudmix=bl_mynn_cloudmix                   &amp;<a name='1685'>
                   &amp;,bl_mynn_mixqt=bl_mynn_mixqt                         &amp;<a name='1686'>
                   &amp;,edmf_a=edmf_a,edmf_w=edmf_w,edmf_qt=edmf_qt         &amp;<a name='1687'>
                   &amp;,edmf_thl=edmf_thl,edmf_ent=edmf_ent,edmf_qc=edmf_qc &amp;<a name='1688'>
                   &amp;,spp_pbl=spp_pbl,pattern_spp_pbl=pattern_spp_pbl     &amp;<a name='1689'>
                   &amp;,FLAG_QI=flag_qi,FLAG_QNI=flag_qni                   &amp;<a name='1690'>
                   &amp;,FLAG_QC=flag_qc,FLAG_QNC=flag_qnc                   &amp;<a name='1691'>
                   ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde      &amp;<a name='1692'>
                   ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme      &amp;<a name='1693'>
                   ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte      &amp;<a name='1694'>
                   )<a name='1695'>
           ELSE<a name='1696'>
               WRITE ( message , FMT = '(A,20(L1,1X))' )            &amp;<a name='1697'>
                 'present: '//                                      &amp;<a name='1698'>
                 'qv_curr, '//                                      &amp;<a name='1699'>
                 'qc_curr, '//                                      &amp;<a name='1700'>
                 'qi_curr, '//                                      &amp;<a name='1701'>
                 'qni_curr, '//                                     &amp;<a name='1702'>
                 'rqvblten, '//                                     &amp;<a name='1703'>
                 'rqcblten, '//                                     &amp;<a name='1704'>
                 'rqiblten, '//                                     &amp;<a name='1705'>
                 'rqniblten, '//                                    &amp;<a name='1706'>
                 'qke, '//                                          &amp;<a name='1707'>
                 'tsq, '//                                          &amp;<a name='1708'>
                 'qsq, '//                                          &amp;<a name='1709'>
                 'cov, '//                                          &amp;<a name='1710'>
                 'rmol, '//                                         &amp;<a name='1711'>
                 'qcg, '//                                          &amp;<a name='1712'>
                 'ch, '//                                           &amp;<a name='1713'>
                 'grav_settling, '//                                &amp;<a name='1714'>
                 'bl_mynn_tkebudget, '//                            &amp;<a name='1715'>
                 'qke_adv, '//                                      &amp;<a name='1716'>
                 'bl_mynn_tkeadvect, '//                            &amp;<a name='1717'>
                 'vdfg = ' ,                                        &amp;<a name='1718'>
                  PRESENT( qv_curr ) ,                              &amp;<a name='1719'>
                  PRESENT( qc_curr ) ,                              &amp;<a name='1720'>
                  PRESENT( qi_curr ) ,                              &amp;<a name='1721'>
                  PRESENT( qni_curr ) ,                             &amp;<a name='1722'>
                  PRESENT( rqvblten ) ,                             &amp;<a name='1723'>
                  PRESENT( rqcblten ) ,                             &amp;<a name='1724'>
                  PRESENT( rqiblten ) ,                             &amp;<a name='1725'>
                  PRESENT( rqniblten ) ,                            &amp;<a name='1726'>
                  PRESENT( qke      ) ,                             &amp;<a name='1727'>
                  PRESENT( tsq      ) ,                             &amp;<a name='1728'>
                  PRESENT( qsq      ) ,                             &amp;<a name='1729'>
                  PRESENT( cov      ) ,                             &amp;<a name='1730'>
                  PRESENT( rmol     ) ,                             &amp;<a name='1731'>
                  PRESENT( qcg      ) ,                             &amp;<a name='1732'>
                  PRESENT( ch       ) ,                             &amp;<a name='1733'>
                  PRESENT( grav_settling),                          &amp;<a name='1734'>
                  PRESENT( bl_mynn_tkebudget) ,                     &amp;<a name='1735'>
                  PRESENT( qke_adv  ) ,                             &amp;<a name='1736'>
                  PRESENT( bl_mynn_tkeadvect) ,                     &amp;<a name='1737'>
                  PRESENT( vdfg )<a name='1738'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_712">(0,message)<a name='1739'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_901">('Lack arguments to call MYNN pbl')<a name='1740'>
           ENDIF<a name='1741'>
<a name='1742'>
        CASE (BOULACSCHEME)<a name='1743'>
<a name='1744'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_713">(100,'in boulac')<a name='1745'>
<a name='1746'>
             CALL <A href='../../html_code/phys/module_bl_boulac.F.html#BOULAC'>BOULAC</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BOULAC_1">(FRC_URB2D=frc_urb2d,IDIFF=idiff,FLAG_BEP=flag_bep     &amp;<a name='1747'>
              ,DZ8W=dz8w,DT=dt,U_PHY=u_phytmp                                  &amp;<a name='1748'>
              ,V_PHY=v_phytmp,TH_PHY=th_phy                                    &amp;<a name='1749'>
              ,RHO=rho,QV_CURR=qv_curr,QC_CURR=qc_curr,HFX=hfx                 &amp;<a name='1750'>
              ,QFX=qfx,USTAR=ust,CP=cp,G=g                                     &amp;<a name='1751'>
              ,RUBLTEN=rublten,RVBLTEN=rvblten,RTHBLTEN=rthblten               &amp;<a name='1752'>
              ,RQVBLTEN=rqvblten,RQCBLTEN=rqcblten                            &amp;<a name='1753'>
              ,TKE=tke_pbl,DLK=el_pbl,WU=wu_tur,WV=wv_tur,WT=wt_tur,WQ=wq_tur  &amp;<a name='1754'>
              ,EXCH_H=exch_h,EXCH_M=exch_m,PBLH=pblh                           &amp;<a name='1755'>
              ,A_U_BEP=a_u_bep,A_V_BEP=a_v_bep,A_T_BEP=a_t_bep                 &amp;<a name='1756'>
              ,A_Q_BEP=a_q_bep                                                 &amp;<a name='1757'>
              ,A_E_BEP=a_e_bep,B_U_BEP=b_u_bep,B_V_BEP=b_v_bep                 &amp;<a name='1758'>
              ,B_T_BEP=b_t_bep,B_E_BEP=b_e_bep,DLG_BEP=dlg_bep                 &amp;<a name='1759'>
              ,B_Q_BEP=b_q_bep                                                 &amp;<a name='1760'>
              ,DL_U_BEP=dl_u_bep,SF_BEP=sf_bep,VL_BEP=vl_bep                   &amp;<a name='1761'>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde                 &amp;<a name='1762'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme                 &amp;<a name='1763'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte  )<a name='1764'>
<a name='1765'>
           CASE (CAMUWPBLSCHEME)<a name='1766'>
              <a name='1767'>
              CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_714">(100,'in camuwpbl')<a name='1768'>
              IF ( PRESENT( qv_curr  )  .AND. PRESENT( qc_curr   )  .AND. &amp;<a name='1769'>
                   PRESENT( qi_curr  )  .AND. PRESENT( qnc_curr  )  .AND. &amp;<a name='1770'>
                   PRESENT( qni_curr )  .AND.                             &amp;<a name='1771'>
                   PRESENT( rqvblten )  .AND. PRESENT( rqcblten  )  .AND. &amp;<a name='1772'>
                   PRESENT( rqiblten )  .AND. PRESENT( rqniblten )        &amp;                   <a name='1773'>
                 )THEN<a name='1774'>
                 CALL <A href='../../html_code/phys/module_bl_camuwpbl_driver.F.html#CAMUWPBL'>CAMUWPBL</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAMUWPBL_1">(DT=dt,U_PHY=u_phy,V_PHY=v_phy,TH_PHY=th_phy,RHO=rho   &amp;<a name='1775'>
                      ,QV_CURR=qv_curr,HFX=hfx,QFX=qfx,USTAR=ust,P8W=p8w,P_PHY=p_phy &amp;<a name='1776'>
                      ,Z=z,T_PHY=t_phy,QC_CURR=qc_curr,QI_CURR=qi_curr,Z_AT_W=z_at_w &amp;<a name='1777'>
                      ,CLDFRA_OLD_mp=cldfra_old_mp,CLDFRA=cldfra,HT=ht               &amp;<a name='1778'>
                      ,RTHRATENLW=rthratenlw,EXNER=pi_phy                            &amp;<a name='1779'>
                      ,is_CAMMGMP_used=is_CAMMGMP_used                               &amp;<a name='1780'>
                      ,ITIMESTEP=itimestep,QNC_CURR=qnc_curr,QNI_CURR=qni_curr       &amp;<a name='1781'>
                      ,WSEDL3D=wsedl3d                                               &amp;<a name='1782'>
<a name='1783'>
                      ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde             &amp;<a name='1784'>
                      ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme             &amp;<a name='1785'>
                      ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte             &amp;<a name='1786'>
<font color=#447700>!Intent-inout <a name='1787'></font>
                      ,TAURESX2D=tauresx2d,TAURESY2D=tauresy2d                       &amp;<a name='1788'>
                      ,RUBLTEN=rublten,RVBLTEN=rvblten,RTHBLTEN=rthblten             &amp;<a name='1789'>
                      ,RQIBLTEN=rqiblten,RQNIBLTEN=rqniblten,RQVBLTEN=rqvblten       &amp;<a name='1790'>
                      ,RQCBLTEN=rqcblten,KVM3D=exch_m,KVH3D=exch_h                   &amp;<a name='1791'>
<font color=#447700>!Intent-out<a name='1792'></font>
                      ,TPERT2D=tpert2d,QPERT2D=qpert2d,WPERT2D=wpert2d,SMAW3D=smaw3d &amp;<a name='1793'>
                      ,TURBTYPE3D=turbtype3d                                         &amp;<a name='1794'>
                      ,TKE_pbl=tke_pbl,PBLH2D=pblh,KPBL2D=kpbl                       )<a name='1795'>
              ELSE<a name='1796'>
                 WRITE ( message , FMT = '(A,8(L1,1X))' )            &amp;<a name='1797'>
                      'present: '//                                      &amp;<a name='1798'>
                      'qv_curr, '//                                      &amp;<a name='1799'>
                      'qc_curr, '//                                      &amp;<a name='1800'>
                      'qi_curr, '//                                      &amp;<a name='1801'>
                      'qnc_curr, '//                                     &amp;<a name='1802'>
                      'qni_curr, '//                                     &amp;<a name='1803'>
                      'rqvblten, '//                                     &amp;<a name='1804'>
                      'rqcblten, '//                                     &amp;<a name='1805'>
                      'rqiblten, '//                                     &amp;<a name='1806'>
                      'rqniblten= ',                                     &amp;<a name='1807'>
                      PRESENT( qv_curr ) ,                              &amp;<a name='1808'>
                      PRESENT( qc_curr ) ,                              &amp;<a name='1809'>
                      PRESENT( qi_curr ) ,                              &amp;<a name='1810'>
                      PRESENT( qnc_curr ) ,                             &amp;<a name='1811'>
                      PRESENT( qni_curr ) ,                             &amp;<a name='1812'>
                      PRESENT( rqvblten ) ,                             &amp;<a name='1813'>
                      PRESENT( rqcblten ) ,                             &amp;<a name='1814'>
                      PRESENT( rqiblten ) ,                             &amp;<a name='1815'>
                      PRESENT( rqniblten ) <a name='1816'>
<a name='1817'>
                 CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_715">(0,message)<a name='1818'>
                 CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_902">('Lack arguments to call CAMUWPBL pbl')<a name='1819'>
              ENDIF<a name='1820'>
              <a name='1821'>
#endif<a name='1822'>
<a name='1823'>
           CASE (GBMPBLSCHEME)<a name='1824'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_716">(100,'in gbmpbl') <a name='1825'>
               IF ( PRESENT( qv_curr )  .AND. PRESENT( qc_curr )  .AND.&amp;<a name='1826'>
               PRESENT( qi_curr )                            .AND. &amp;<a name='1827'>
               PRESENT( rqvblten ) .AND. PRESENT( rqcblten ) .AND. &amp;<a name='1828'>
               PRESENT( rqiblten )                           .AND. &amp;<a name='1829'>
               PRESENT( hol      )                           .AND. &amp;<a name='1830'>
                                       .TRUE.  ) THEN<a name='1831'>
             CALL <A href='../../html_code/phys/module_bl_gbmpbl.F.html#GBMPBL'>gbmpbl</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GBMPBL_1">(                                           &amp;<a name='1832'>
               U3D=u_phytmp,V3D=v_phytmp,TH3D=th_phy,T3D=t_phy      &amp;<a name='1833'>
              ,QV3D=qv_curr,QC3D=qc_curr,QI3D=qi_curr               &amp;<a name='1834'>
              ,P3D=p_phy,PI3D=pi_phy                                &amp;<a name='1835'>
              ,RUBLTEN=rublten,RVBLTEN=rvblten                      &amp;<a name='1836'>
              ,RTHBLTEN=rthblten,RQVBLTEN=rqvblten                  &amp;<a name='1837'>
              ,RQCBLTEN=rqcblten,RQIBLTEN=rqiblten                  &amp;<a name='1838'>
              ,KZM_GBM=exch_m,KTH_GBM=exch_h,KETHL_GBM=exch_tke     &amp; <a name='1839'>
              ,EL_GBM=el_pbl,DZ8W=dz8w,Z=z,PSFC=PSFC                &amp;<a name='1840'>
              ,TKE_PBL=tke_pbl,RTHRATEN=rthraten                    &amp; <a name='1841'>
              ,ZNT=znt,UST=ust,ZOL=zol,HOL=hol,PBL=pblh             &amp; <a name='1842'>
              ,KPBL2D=kpbl,REGIME=regime                            &amp; <a name='1843'>
              ,PSIM=psim,PSIH=psih,XLAND=xland                      &amp;<a name='1844'>
              ,HFX=hfx,QFX=qfx,TSK=tskold,GZ1OZ0=gz1oz0             &amp;<a name='1845'>
              ,WSPD=wspd,BR=br,DT=dtbl,DTMIN=dtmin                  &amp;<a name='1846'>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde      &amp;<a name='1847'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme      &amp;<a name='1848'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte      &amp;<a name='1849'>
                                                                    )<a name='1850'>
              ELSE<a name='1851'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_903">('Lack arguments to call GBM pbl')<a name='1852'>
              ENDIF<a name='1853'>
<a name='1854'>
     CASE DEFAULT<a name='1855'>
<a name='1856'>
       WRITE( message , * ) 'The pbl option does not exist: bl_pbl_physics = ', bl_pbl_physics<a name='1857'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_904"> ( message )<a name='1858'>
<a name='1859'>
   END SELECT pbl_select<a name='1860'>
<a name='1861'>
#if (EM_CORE==1)<a name='1862'>
<font color=#447700>!<a name='1863'></font>
<font color=#447700>! ... paj: wind farm ...<a name='1864'></font>
<font color=#447700>!<a name='1865'></font>
    windfarm_select: SELECT CASE(windfarm_opt)<a name='1866'>
<a name='1867'>
      CASE (fitchscheme)<a name='1868'>
<a name='1869'>
                  IF (PRESENT(id) .AND.                                  &amp;<a name='1870'>
                     PRESENT(z_at_w) ) THEN<a name='1871'>
<font color=#447700>!<a name='1872'></font>
                     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_717">(100,'in phys/module_wind_fitch.F')<a name='1873'>
                     CALL <A href='../../html_code/phys/module_wind_fitch.F.html#DRAGFORCE'>dragforce</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DRAGFORCE_1">(                                  &amp;<a name='1874'>
                     &amp; ID=id                                             &amp;<a name='1875'>
                     &amp;,Z_AT_W=z_at_w,u=u_phy,v=v_phy                     &amp;<a name='1876'>
                     &amp;,DX=dx,DZ=dz8w,DT=dt                               &amp;<a name='1877'>
                     &amp;,QKE=qke                                           &amp;<a name='1878'>
                     &amp;,DU=rublten,DV=rvblten                             &amp;<a name='1879'>
                     &amp;,WINDFARM_OPT=windfarm_opt,POWER=power             &amp;<a name='1880'>
                     &amp;,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde   &amp;<a name='1881'>
                     &amp;,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme   &amp;<a name='1882'>
                     &amp;,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte   &amp;<a name='1883'>
                     &amp;)<a name='1884'>
                  ELSE<a name='1885'>
                     WRITE ( message , FMT = '(A,6(L1,1X))' )           &amp;<a name='1886'>
                     'present: '//                                      &amp;<a name='1887'>
                     'ID, '//                                           &amp;<a name='1888'>
                     'z_at_w, '//                                       &amp;<a name='1889'>
                     'xlat_u, '//                                       &amp;<a name='1890'>
                     'xlong_u, '//                                      &amp;<a name='1891'>
                     'xlat_v, '//                                       &amp;<a name='1892'>
                     'xlong_v = ' ,                                     &amp;<a name='1893'>
                      PRESENT( id ) ,                                   &amp;<a name='1894'>
                      PRESENT( z_at_w ) <a name='1895'>
                     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_718">(0,message)<a name='1896'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_905">('Lack arguments to call turbine_drag')<a name='1897'>
                  ENDIF<a name='1898'>
<a name='1899'>
   END SELECT windfarm_select<a name='1900'>
#endif<a name='1901'>
<a name='1902'>
<a name='1903'>
   <a name='1904'>
   IF (PRESENT(dtaux3d)) THEN<a name='1905'>
       IF(gwd_opt .EQ. 1)THEN<a name='1906'>
             CALL <A href='../../html_code/phys/module_bl_gwdo.F.html#GWDO'>gwdo</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GWDO_1">(                                              &amp;<a name='1907'>
               U3D=u_phytmp,V3D=v_phytmp,T3D=t_phy      &amp;<a name='1908'>
              ,QV3D=qv_curr                                         &amp;<a name='1909'>
              ,P3D=p_phy,P3DI=p8w,PI3D=pi_phy,Z=z                        &amp;<a name='1910'>
              ,RUBLTEN=rublten,RVBLTEN=rvblten                      &amp;<a name='1911'>
              ,DTAUX3D=dtaux3d,DTAUY3D=dtauy3d                      &amp;<a name='1912'>
              ,DUSFCG=dusfcg,DVSFCG=dvsfcg &amp;<a name='1913'>
              ,VAR2D=var2d,OC12D=oc12d     &amp;<a name='1914'>
              ,OA2D1=oa1,OA2D2=oa2,OA2D3=oa3,OA2D4=oa4  &amp;<a name='1915'>
              ,OL2D1=ol1,OL2D2=ol2,OL2D3=ol3,OL2D4=ol4  &amp;<a name='1916'>
              ,ZNU=znu,ZNW=znw,P_TOP=p_top                &amp;<a name='1917'>
              ,CP=cp,G=g,RD=r_d                           &amp;<a name='1918'>
              ,RV=r_v,EP1=ep_1,PI=3.141592653                        &amp;<a name='1919'>
              ,DT=dtbl,DX=dx,KPBL2D=kpbl,ITIMESTEP=itimestep      &amp;<a name='1920'>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde      &amp;<a name='1921'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme      &amp;<a name='1922'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte      )<a name='1923'>
       ENDIF<a name='1924'>
   ENDIF<a name='1925'>
<a name='1926'>
#if (EM_CORE==1)                                                                                                                                                                             <a name='1927'>
<font color=#447700>!JOE-added - fog (cloud) water deposition calculation<a name='1928'></font>
   IF (grav_settling .GE. 1) THEN<a name='1929'>
      IF ( PRESENT(vdfg) .AND. PRESENT(qc_curr)) THEN<a name='1930'>
         <font color=#447700>!NOTE 1: vdfg is calculated in the surface driver.<a name='1931'></font>
         <font color=#447700>!NOTE 2: as of now, only qc_curr settles, not # conc.<a name='1932'></font>
<a name='1933'>
          CALL <A href='../../html_code/phys/module_bl_fogdes.F.html#BL_FOGDES'>bl_fogdes</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BL_FOGDES_1">(                                        &amp;<a name='1934'>
               vdfg,qc_curr,dtbl,rho,dz8w,grav_settling,RQCBLTEN,&amp;<a name='1935'>
               ids,ide, jds,jde, kds,kde,                        &amp;<a name='1936'>
               ims,ime, jms,jme, kms,kme,                        &amp;<a name='1937'>
               i_start(ij),i_end(ij),                            &amp;<a name='1938'>
               j_start(ij),j_end(ij),kts,kte                     )<a name='1939'>
      ELSE<a name='1940'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_906">('Missing args for bl_fogdes in pbl driver')<a name='1941'>
      ENDIF<a name='1942'>
   ENDIF<a name='1943'>
<font color=#447700>!JOE-END<a name='1944'></font>
#endif<a name='1945'>
<a name='1946'>
#if (NMM_CORE <font color=#447700>!= 1)<a name='1947'></font>
<a name='1948'>
     IF (idiff.eq.1) THEN<a name='1949'>
<a name='1950'>
<font color=#447700>!Alberto: here we call the general routine to solve the diffusion<a name='1951'></font>
<font color=#447700>! + all the source/sink terms.<a name='1952'></font>
<font color=#447700>! the only thing that should be passed from the PBL schemes is the value of the exch_h, and exch_m <a name='1953'></font>
<font color=#447700>! (and the non local terms, if present, through the b).<a name='1954'></font>
<font color=#447700>! So, this routine can be used by any of the previous schemes. We only need to pass the right variables<a name='1955'></font>
<font color=#447700>! (and eliminate the computation of the tendencies from the previous routines, to avoid doing twice the job).<a name='1956'></font>
<font color=#447700>! As I explain below, in the routine, here we could extract the vertical turbulent <a name='1957'></font>
<font color=#447700>! fluxes (something that will be general for all the routines).<a name='1958'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1959'></font>
    <a name='1960'>
            <a name='1961'>
          CALL <A href='../../html_code/phys/module_pbl_driver.F.html#DIFF3D'>diff3d</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIFF3D_1">  (DT=dtbl,CP=cp,DZ=dz8w,TH=th_phy,QV=qv_curr,QC=qc_curr,T=t_phy  &amp;<a name='1962'>
              ,U=u_phy,V=v_phy,RHO=rho,EXCH_H=exch_h                  &amp;<a name='1963'>
              ,EXCH_M=exch_m                                          &amp;<a name='1964'>
              ,RUBLTEN=rublten,RVBLTEN=rvblten,RTHBLTEN=rthblten      &amp;<a name='1965'>
             ,RQVBLTEN=rqvblten,RQCBLTEN=rqcblten                    &amp;<a name='1966'>
              ,WU=wu_tur,WV=wv_tur,WT=wt_tur,WQ=wq_tur                    &amp;<a name='1967'>
              ,A_U=a_u,A_V=a_v,A_T=a_t,A_Q=a_q        &amp;<a name='1968'>
              ,B_U=b_u,B_V=b_v,B_T=b_t,B_Q=b_q        &amp;<a name='1969'>
              ,SF=sf,VL=vl            &amp;<a name='1970'>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde        &amp;<a name='1971'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme        &amp;<a name='1972'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte)<a name='1973'>
<a name='1974'>
          DEALLOCATE (a_u)       <font color=#447700>! Implicit component for the momemtum in X-direction<a name='1975'></font>
          DEALLOCATE (a_v)       <font color=#447700>! Implicit component for the momemtum in Y-direction<a name='1976'></font>
          DEALLOCATE (a_t)       <font color=#447700>! Implicit component for the Pot. Temp.<a name='1977'></font>
          DEALLOCATE (a_q)       <font color=#447700>! Implicit component for the water vapor<a name='1978'></font>
          DEALLOCATE (b_u)       <font color=#447700>! Explicit component for the momemtum in X-direction<a name='1979'></font>
          DEALLOCATE (b_v)       <font color=#447700>! Explicit component for the momemtum in Y-direction<a name='1980'></font>
          DEALLOCATE (b_t)       <font color=#447700>! Explicit component for the Pot. Temp.<a name='1981'></font>
          DEALLOCATE (b_q)       <font color=#447700>! Explicit component for the water vapor<a name='1982'></font>
          DEALLOCATE (sf )       <font color=#447700>! surfaces<a name='1983'></font>
          DEALLOCATE (vl )       <font color=#447700>! volumes<a name='1984'></font>
     ENDIF       <font color=#447700>!idiff<a name='1985'></font>
      <a name='1986'>
          IF(scalar_pblmix .GT. 0)THEN<a name='1987'>
            CALL <A href='../../html_code/phys/module_pbl_driver.F.html#DIFF4D'>diff4d</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIFF4D_1">  (DT=dtbl,DZ=dz8w, SCALAR=scalar, is_scalar=.true.  &amp;<a name='1988'>
              ,RHO=rho,EXCH_H=exch_h        &amp;<a name='1989'>
              ,EXCH_M=exch_m                &amp;<a name='1990'>
              ,SCALAR_TEND=scalar_tend      &amp;<a name='1991'>
              ,NUM_SCALAR=num_scalar, PARAM_FIRST_SCALAR=param_first_scalar &amp;<a name='1992'>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde        &amp;<a name='1993'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme        &amp;<a name='1994'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte)<a name='1995'>
          ENDIF<a name='1996'>
          IF(tracer_pblmix .GT. 0)THEN<a name='1997'>
            CALL <A href='../../html_code/phys/module_pbl_driver.F.html#DIFF4D'>diff4d</A><A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIFF4D_2">  (DT=dtbl,DZ=dz8w, SCALAR=tracer, is_scalar=.false.  &amp;<a name='1998'>
              ,RHO=rho,EXCH_H=exch_h        &amp;<a name='1999'>
              ,EXCH_M=exch_m                &amp;<a name='2000'>
              ,SCALAR_TEND=tracer_tend      &amp;<a name='2001'>
              ,NUM_SCALAR=num_tracer, PARAM_FIRST_SCALAR=param_first_scalar &amp;<a name='2002'>
              ,IDS=ids,IDE=ide,JDS=jds,JDE=jde,KDS=kds,KDE=kde        &amp;<a name='2003'>
              ,IMS=ims,IME=ime,JMS=jms,JME=jme,KMS=kms,KME=kme        &amp;<a name='2004'>
              ,ITS=its,ITE=ite,JTS=jts,JTE=jte,KTS=kts,KTE=kte)<a name='2005'>
          ENDIF<a name='2006'>
<a name='2007'>
#endif<a name='2008'>
      <a name='2009'>
   ENDDO<a name='2010'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2011'></font>
<a name='2012'>
   ENDIF<a name='2013'>
<a name='2014'>
   END SUBROUTINE pbl_driver<a name='2015'>
<a name='2016'>
<font color=#447700>!=============================================================================<a name='2017'></font>
<A NAME='DIFF3D'><A href='../../html_code/phys/module_pbl_driver.F.html#DIFF3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2018'>
          <font color=#993300>SUBROUTINE </font><font color=#cc0000>diff3d</font>(DT,CP,DZ,TH ,QV,QC,T,U,V,RHO                              &amp; <A href='../../call_to/DIFF3D.html' TARGET='index'>1</A>,<A href='../../call_from/DIFF3D.html' TARGET='index'>5</A><a name='2019'>
              ,EXCH_H,EXCH_M                   &amp;  <a name='2020'>
              ,RUBLTEN,RVBLTEN,RTHBLTEN    &amp;<a name='2021'>
              ,RQVBLTEN,RQCBLTEN                  &amp;<a name='2022'>
              ,WU,WV,WT,WQ                 &amp;<a name='2023'>
              ,A_U,A_V,A_T,A_Q      &amp;<a name='2024'>
              ,B_U,B_V,B_T,B_Q      &amp;<a name='2025'>
              ,SF,VL        &amp;<a name='2026'>
              ,IDS,IDE,JDS,JDE,KDS,KDE      &amp;<a name='2027'>
              ,IMS,IME,JMS,JME,KMS,KME      &amp;<a name='2028'>
              ,ITS,ITE,JTS,JTE,KTS,KTE      &amp;<a name='2029'>
                                                                    )<a name='2030'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2031'></font>
<font color=#447700>!    Subroutine written by Alberto Martilli, CIEMAT, Spain,<a name='2032'></font>
<font color=#447700>!    e-mail:alberto_martilli@ciemat.es<a name='2033'></font>
<font color=#447700>!    August 2008.<a name='2034'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2035'></font>
<font color=#447700>! ALberto<a name='2036'></font>
<font color=#447700>! This routine solves the vertical diffusion <a name='2037'></font>
<font color=#447700>! + other source/sink terms (surface fluxes, building drag, non local terms, etc.)<a name='2038'></font>
<font color=#447700>! for U,V, potential temperature and moisture. The equation should be written <a name='2039'></font>
<font color=#447700>! as follow, for a generic variable M:<a name='2040'></font>
<font color=#447700>! <a name='2041'></font>
<font color=#447700>!      dM      1     d      dM<a name='2042'></font>
<font color=#447700>!     ---- =----  ---(rho*K----)+AM+B<a name='2043'></font>
<font color=#447700>!      dt     rho    dz     dz  <a name='2044'></font>
<font color=#447700>! where A and B are the implict and explcit coefficients of the source/sink terms<a name='2045'></font>
<font color=#447700>! (at the lowest level the surface fluxes should go in these terms)<a name='2046'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2047'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2048'></font>
<a name='2049'>
      IMPLICIT NONE<a name='2050'>
<font color=#447700>!<a name='2051'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2052'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='2053'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='2054'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='2055'>
<a name='2056'>
<font color=#447700>! INputs<a name='2057'></font>
      real DT,CP<a name='2058'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: DZ <font color=#447700>! Depth of vertical levels<a name='2059'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: TH <font color=#447700>! Potential Temperature<a name='2060'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: QV <font color=#447700>! water vapor mixing ratio (kg/kg)<a name='2061'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: QC <font color=#447700>! cloud water mixing ratio (kg/kg)<a name='2062'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: T  <font color=#447700>! temperature<a name='2063'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: U <font color=#447700>! X-compnent of the wind<a name='2064'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: V <font color=#447700>! Y-compnent of the wind<a name='2065'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: RHO <font color=#447700>! Air Density<a name='2066'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: EXCH_H <font color=#447700>! Turbulent coefficient for heat<a name='2067'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: EXCH_M <font color=#447700>! Turbulent coefficient for momentum <a name='2068'></font>
      <a name='2069'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: A_U <font color=#447700>! Implicit coefficient for DRAG (x -component)<a name='2070'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: B_U <font color=#447700>! Explicit coefficient for DRAG (x -component)<a name='2071'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: A_V <font color=#447700>! Implicit coefficient for DRAG (y -component)<a name='2072'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: B_V <font color=#447700>! Explicit coefficient for DRAG (y -component)<a name='2073'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: A_T <font color=#447700>! Implicit coefficient for Heat flux from buildings<a name='2074'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: B_T <font color=#447700>! Explicit coefficient for Heat flux from buildings<a name='2075'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: A_Q <font color=#447700>! Implicit coefficient for moisture flux<a name='2076'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: B_Q <font color=#447700>! Explicit coefficient for moisture flux <a name='2077'></font>
    <a name='2078'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: VL <font color=#447700>! fraction of air volume in the grid cell<a name='2079'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: SF <font color=#447700>! fraction of air at the face of the grid cell<a name='2080'></font>
<font color=#447700>!outputs<a name='2081'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT) :: RUBLTEN <font color=#447700>! tendency for x-wind component<a name='2082'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT) :: RVBLTEN <font color=#447700>! tendency for y-wind component<a name='2083'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT) :: RTHBLTEN <font color=#447700>! tendency for Potential Temperature<a name='2084'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT) :: RQVBLTEN <font color=#447700>! tendency for water vapor mixing ratio (kg/kg)<a name='2085'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT) :: RQCBLTEN <font color=#447700>! tendency for cloud water mixing ratio (kg/kg)<a name='2086'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT) :: WU <font color=#447700>! turbulent flux of momentum (x)<a name='2087'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT) :: WV <font color=#447700>! turbulent flux of momentum (y)<a name='2088'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT) :: WT <font color=#447700>! turbulent flux of potential temperature<a name='2089'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT) :: WQ <font color=#447700>! turbulent flux of water vapor<a name='2090'></font>
<font color=#447700>! Parameters<a name='2091'></font>
     REAL ELOCP <a name='2092'>
<font color=#447700>! locals (same meaning as above, but 1D)<a name='2093'></font>
<a name='2094'>
      real u1d(kms:kme),v1d(kms:kme),exch_h1d(kms:kme)<a name='2095'>
      real the1d(kms:kme) <font color=#447700>! Equivalent potential temperature<a name='2096'></font>
      real exch_m1d(kms:kme),qv1d(kms:kme),qc1d(kms:kme)<a name='2097'>
      real dz1d(kms:kme),rho1d(kms:kme),rhoz1d(kms:kme)<a name='2098'>
      real sf1d(kms:kme),vl1d(kms:kme)   <a name='2099'>
      real a_u1d(kms:kme),b_u1d(kms:kme)<a name='2100'>
      real a_v1d(kms:kme),b_v1d(kms:kme)<a name='2101'>
      real a_t1d(kms:kme),b_t1d(kms:kme)<a name='2102'>
      real a_q1d(kms:kme),b_q1d(kms:kme)<a name='2103'>
      real a_qc1d(kms:kme),b_qc1d(kms:kme)<a name='2104'>
      real wu1d(kms:kme),wv1d(kms:kme),wt1d(kms:kme),wq1d(kms:kme),wqc1d(kms:kme)<a name='2105'>
      real thnew<a name='2106'>
<font color=#447700>!<a name='2107'></font>
      integer i,k,j  <a name='2108'>
<font color=#447700>!----------------------------------------------------------------------<a name='2109'></font>
      ELOCP=2.72E6/CP<a name='2110'>
      u1d=0.<a name='2111'>
      v1d=0.<a name='2112'>
      exch_h1d=0.<a name='2113'>
      exch_m1d=0.<a name='2114'>
      qv1d=0.<a name='2115'>
      qc1d=0.<a name='2116'>
      dz1d=0.<a name='2117'>
      rho1d=0.<a name='2118'>
      rhoz1d=0.<a name='2119'>
      sf1d=0.<a name='2120'>
      vl1d=0.<a name='2121'>
      a_u1d=0.<a name='2122'>
      a_v1d=0.<a name='2123'>
      a_t1d=0.<a name='2124'>
      a_q1d=0.<a name='2125'>
      a_qc1d=0.<a name='2126'>
      b_u1d=0.<a name='2127'>
      b_v1d=0.<a name='2128'>
      b_t1d=0.<a name='2129'>
      b_q1d=0.<a name='2130'>
      b_qc1d=0.<a name='2131'>
       <a name='2132'>
      do j=jts,jte<a name='2133'>
      do i=its,ite<a name='2134'>
<a name='2135'>
<font color=#447700>! put three D variables in temporary 1D variables<a name='2136'></font>
<a name='2137'>
       do k=kts,kte<a name='2138'>
        u1d(k)=U(i,k,j)<a name='2139'>
        v1d(k)=V(i,k,j)<a name='2140'>
        the1d(k)=TH(i,k,j)*(QC(i,k,j)*(-ELOCP/T(i,k,j))+1)<a name='2141'>
        qv1d(k)=qv(i,k,j)<a name='2142'>
        dz1d(k)=dz(i,k,j)<a name='2143'>
        rho1d(k)=rho(i,k,j) <a name='2144'>
        a_u1d(k)=a_u(i,k,j)<a name='2145'>
        b_u1d(k)=b_u(i,k,j)<a name='2146'>
        a_v1d(k)=a_v(i,k,j)<a name='2147'>
        b_v1d(k)=b_v(i,k,j)<a name='2148'>
        a_t1d(k)=a_t(i,k,j)<a name='2149'>
        b_t1d(k)=b_t(i,k,j)<a name='2150'>
        a_q1d(k)=a_q(i,k,j)<a name='2151'>
        b_q1d(k)=b_q(i,k,j)<a name='2152'>
        a_qc1d(k)=0.<a name='2153'>
        b_qc1d(k)=0.<a name='2154'>
        vl1d(k)=vl(i,k,j)<a name='2155'>
        sf1d(k)=sf(i,k,j)<a name='2156'>
       enddo<a name='2157'>
       sf1d(kte+1)=1. <a name='2158'>
       do k=kts,kte    <a name='2159'>
        exch_h1d(k)=exch_h(i,k,j)<a name='2160'>
        exch_m1d(k)=exch_m(i,k,j)<a name='2161'>
       enddo<a name='2162'>
       exch_h1d(kts)=0.<a name='2163'>
<font color=#447700>!       exch_h1d(kte+1)=0  <a name='2164'></font>
       exch_m1d(kts)=0.<a name='2165'>
<font color=#447700>!       exch_m1d(kte+1)=0<a name='2166'></font>
        rhoz1d(kts)=rho1d(kts)<a name='2167'>
        do k=kts+1,kte<a name='2168'>
         rhoz1d(k)=(rho1d(k)*dz1d(k-1)+rho1d(k-1)*dz1d(k))/       &amp;<a name='2169'>
     &amp;                      (dz1d(k-1)+dz1d(k))<a name='2170'>
        enddo<a name='2171'>
        rhoz1d(kte+1)=rho1d(kte)<a name='2172'>
<a name='2173'>
<a name='2174'>
<font color=#447700>! solve the diffusion for x-component of the wind   <a name='2175'></font>
          <a name='2176'>
       call <A href='../../html_code/phys/module_pbl_driver.F.html#DIFF'>diff</A><A href='../../html_code/phys/module_pbl_driver.F.html#DIFF3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIFF_7">(kms,kme,kts,kte,dt,u1d,rho1d,rhoz1d,exch_m1d,a_u1d,b_u1d,sf1d, &amp;<a name='2177'>
     &amp;            vl1d,dz1d,wu1d) <a name='2178'>
<a name='2179'>
<font color=#447700>! solve the diffusion for y-component of the wind              <a name='2180'></font>
<a name='2181'>
       call <A href='../../html_code/phys/module_pbl_driver.F.html#DIFF'>diff</A><A href='../../html_code/phys/module_pbl_driver.F.html#DIFF3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIFF_8">(kms,kme,kts,kte,dt,v1d,rho1d,rhoz1d,exch_m1d,a_v1d,b_v1d,sf1d, &amp;<a name='2182'>
     &amp;            vl1d,dz1d,wv1d) <a name='2183'>
<a name='2184'>
<font color=#447700>! solve the diffusion for equivalent potential temperature<a name='2185'></font>
<a name='2186'>
       call <A href='../../html_code/phys/module_pbl_driver.F.html#DIFF'>diff</A><A href='../../html_code/phys/module_pbl_driver.F.html#DIFF3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIFF_9">(kms,kme,kts,kte,dt,the1d,rho1d,rhoz1d,exch_h1d,a_t1d,b_t1d,sf1d, &amp;<a name='2187'>
     &amp;            vl1d,dz1d,wt1d) <a name='2188'>
<a name='2189'>
<font color=#447700>! solve the diffusion for the water vapor mixing ratio<a name='2190'></font>
<a name='2191'>
       call <A href='../../html_code/phys/module_pbl_driver.F.html#DIFF'>diff</A><A href='../../html_code/phys/module_pbl_driver.F.html#DIFF3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIFF_10">(kms,kme,kts,kte,dt,qv1d,rho1d,rhoz1d,exch_h1d,a_q1d,b_q1d,sf1d, &amp;<a name='2192'>
     &amp;            vl1d,dz1d,wq1d) <a name='2193'>
<a name='2194'>
<font color=#447700>! solve the diffusion for the cloud water mixing ratio<a name='2195'></font>
<a name='2196'>
       call <A href='../../html_code/phys/module_pbl_driver.F.html#DIFF'>diff</A><A href='../../html_code/phys/module_pbl_driver.F.html#DIFF3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIFF_11">(kms,kme,kts,kte,dt,qc1d,rho1d,rhoz1d,exch_h1d,a_qc1d,b_qc1d,sf1d, &amp;<a name='2197'>
     &amp;            vl1d,dz1d,wqc1d)        <a name='2198'>
<a name='2199'>
<font color=#447700>!     <a name='2200'></font>
<font color=#447700>! compute the tendencies<a name='2201'></font>
<a name='2202'>
        do k=kts,kte<a name='2203'>
          rublten(i,k,j)=(u1d(k)-u(i,k,j))/dt<a name='2204'>
          rvblten(i,k,j)=(v1d(k)-v(i,k,j))/dt<a name='2205'>
          thnew=the1d(k)/(QC(i,k,j)*(-ELOCP/T(i,k,j))+1)<a name='2206'>
          rthblten(i,k,j)=(thnew-th(i,k,j))/dt<a name='2207'>
          rqvblten(i,k,j)=(qv1d(k)-qv(i,k,j))/dt<a name='2208'>
          rqcblten(i,k,j)=(qc1d(k)-qc(i,k,j))/dt<a name='2209'>
          wu(i,k,j)=wu1d(k)<a name='2210'>
          wv(i,k,j)=wv1d(k)<a name='2211'>
          wt(i,k,j)=wt1d(k)<a name='2212'>
          wq(i,k,j)=wq1d(k)<a name='2213'>
        enddo<a name='2214'>
      enddo<a name='2215'>
      enddo <a name='2216'>
<font color=#447700>!!!!!!!!!!!!<a name='2217'></font>
<a name='2218'>
        <a name='2219'>
      END SUBROUTINE diff3d<a name='2220'>
#if (EM_CORE==1)<a name='2221'>
<font color=#447700>! ===6=8===============================================================72<a name='2222'></font>
<A NAME='DIFF4D'><A href='../../html_code/phys/module_pbl_driver.F.html#DIFF4D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2223'>
          <font color=#993300>SUBROUTINE </font><font color=#cc0000>diff4d</font>(DT,DZ,SCALAR,IS_SCALAR,RHO              &amp; <A href='../../call_to/DIFF4D.html' TARGET='index'>2</A>,<A href='../../call_from/DIFF4D.html' TARGET='index'>2</A><a name='2224'>
              ,EXCH_H,EXCH_M  &amp;  <a name='2225'>
              ,SCALAR_TEND    &amp;<a name='2226'>
              ,NUM_SCALAR, PARAM_FIRST_SCALAR     &amp;<a name='2227'>
              ,IDS,IDE,JDS,JDE,KDS,KDE      &amp;<a name='2228'>
              ,IMS,IME,JMS,JME,KMS,KME      &amp;<a name='2229'>
              ,ITS,ITE,JTS,JTE,KTS,KTE      &amp;<a name='2230'>
                                                                    )<a name='2231'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2232'></font>
<font color=#447700>!    Based on subroutine written by Alberto Martilli, CIEMAT, Spain,<a name='2233'></font>
<font color=#447700>!    e-mail:alberto_martilli@ciemat.es<a name='2234'></font>
<font color=#447700>!    August 2008.<a name='2235'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2236'></font>
<font color=#447700>! ALberto<a name='2237'></font>
<font color=#447700>! This routine solves the vertical diffusion <a name='2238'></font>
<font color=#447700>! + other source/sink terms (surface fluxes, building drag, non local terms, etc.)<a name='2239'></font>
<font color=#447700>! for U,V, potential temperature and moisture. The equation should be written <a name='2240'></font>
<font color=#447700>! as follow, for a generic variable M:<a name='2241'></font>
<font color=#447700>! <a name='2242'></font>
<font color=#447700>!      dM      1     d      dM<a name='2243'></font>
<font color=#447700>!     ---- =----  ---(rho*K----)+AM+B<a name='2244'></font>
<font color=#447700>!      dt     rho    dz     dz  <a name='2245'></font>
<font color=#447700>! where A and B are the implict and explcit coefficients of the source/sink terms<a name='2246'></font>
<font color=#447700>! (at the lowest level the surface fluxes should go in these terms)<a name='2247'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2248'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2249'></font>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_pbl_driver.F.html#DIFF4D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_137">, ONLY: &amp;<a name='2250'>
                  P_QNS, P_QNR, P_QNG, P_QT, P_QNH, P_QVOLG, P_QKE_ADV<a name='2251'>
<a name='2252'>
<a name='2253'>
      IMPLICIT NONE<a name='2254'>
<font color=#447700>!<a name='2255'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2256'></font>
      INTEGER,INTENT(IN) :: NUM_SCALAR, PARAM_FIRST_SCALAR<a name='2257'>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='2258'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='2259'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='2260'>
<a name='2261'>
<font color=#447700>! inputs<a name='2262'></font>
      REAL, INTENT(IN)   :: DT<a name='2263'>
      LOGICAL,INTENT(IN) :: IS_SCALAR<a name='2264'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: DZ <font color=#447700>! Depth of vertical levels<a name='2265'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME,NUM_SCALAR),INTENT(IN) :: SCALAR <font color=#447700>! 4d scalar mixing ratio<a name='2266'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: RHO <font color=#447700>! Air Density<a name='2267'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: EXCH_H <font color=#447700>! Turbulent coefficient for heat<a name='2268'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: EXCH_M <font color=#447700>! Turbulent coefficient for momentum <a name='2269'></font>
      <a name='2270'>
<font color=#447700>! outputs<a name='2271'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME,NUM_SCALAR),INTENT(INOUT) :: SCALAR_TEND <font color=#447700>! 4d scalar mixing ratio tendency<a name='2272'></font>
<font color=#447700>! locals (same meaning as above, but 1D)<a name='2273'></font>
<a name='2274'>
      real s1d(kms:kme),exch_h1d(kms:kme)<a name='2275'>
      real exch_m1d(kms:kme)<a name='2276'>
      real dz1d(kms:kme),rho1d(kms:kme),rhoz1d(kms:kme)<a name='2277'>
      real sf1d(kms:kme),vl1d(kms:kme)   <a name='2278'>
      real a_s1d(kms:kme),b_s1d(kms:kme)<a name='2279'>
      real ws1d(kms:kme)<a name='2280'>
<font color=#447700>!<a name='2281'></font>
      integer i,k,j,im  <a name='2282'>
<font color=#447700>!----------------------------------------------------------------------<a name='2283'></font>
      s1d=0.<a name='2284'>
      exch_h1d=0.<a name='2285'>
      exch_m1d=0.<a name='2286'>
      rho1d=0.<a name='2287'>
      rhoz1d=0.<a name='2288'>
      sf1d=0.<a name='2289'>
      vl1d=0.<a name='2290'>
      a_s1d=0.<a name='2291'>
      b_s1d=0.<a name='2292'>
       <a name='2293'>
      DO im=PARAM_FIRST_SCALAR,NUM_SCALAR<a name='2294'>
<font color=#447700>! need to avoid mixing scalars associated with precipitating species (e.g. Nr)<a name='2295'></font>
        IF((IS_SCALAR .AND. im.NE.P_QNS .AND. im.NE.P_QNR .AND. im.NE.P_QNG &amp;<a name='2296'>
          .AND. im.NE.P_QNH .AND. im.NE.P_QT .AND. im.NE.P_QVOLG .AND. im.NE.P_QKE_ADV) &amp;<a name='2297'>
          .OR. (.not. IS_SCALAR)) THEN<a name='2298'>
        do j=jts,jte<a name='2299'>
        do i=its,ite<a name='2300'>
<a name='2301'>
<font color=#447700>! put three D variables in temporary 1D variables<a name='2302'></font>
<a name='2303'>
       do k=kts,kte<a name='2304'>
        s1d(k)=SCALAR(i,k,j,im)<a name='2305'>
        dz1d(k)=dz(i,k,j)<a name='2306'>
        rho1d(k)=rho(i,k,j) <a name='2307'>
<font color=#447700>!        a_s1d(k)=a_s(i,k,j)   ! implicit source<a name='2308'></font>
<font color=#447700>!        b_s1d(k)=b_s(i,k,j)   ! explicit source<a name='2309'></font>
        vl1d(k)=1.<a name='2310'>
        sf1d(k)=1.<a name='2311'>
       enddo<a name='2312'>
       sf1d(kte+1)=1. <a name='2313'>
       do k=kts,kte    <a name='2314'>
        exch_h1d(k)=exch_h(i,k,j)<a name='2315'>
        exch_m1d(k)=exch_m(i,k,j)<a name='2316'>
       enddo<a name='2317'>
       exch_h1d(kts)=0.<a name='2318'>
<font color=#447700>!       exch_h1d(kte+1)=0  <a name='2319'></font>
       exch_m1d(kts)=0.<a name='2320'>
<font color=#447700>!       exch_m1d(kte+1)=0<a name='2321'></font>
        rhoz1d(kts)=rho1d(kts)<a name='2322'>
        do k=kts+1,kte<a name='2323'>
         rhoz1d(k)=(rho1d(k)*dz1d(k-1)+rho1d(k-1)*dz1d(k))/       &amp;<a name='2324'>
     &amp;                      (dz1d(k-1)+dz1d(k))<a name='2325'>
        enddo<a name='2326'>
        rhoz1d(kte+1)=rho1d(kte)<a name='2327'>
<a name='2328'>
<a name='2329'>
<font color=#447700>! solve the diffusion for scalar<a name='2330'></font>
          <a name='2331'>
       call <A href='../../html_code/phys/module_pbl_driver.F.html#DIFF'>diff</A><A href='../../html_code/phys/module_pbl_driver.F.html#DIFF4D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIFF_12">(kms,kme,kts,kte,dt,s1d,rho1d,rhoz1d,exch_h1d,a_s1d,b_s1d,sf1d, &amp;<a name='2332'>
     &amp;            vl1d,dz1d,ws1d) <a name='2333'>
<a name='2334'>
<font color=#447700>!     <a name='2335'></font>
<font color=#447700>! compute the tendencies<a name='2336'></font>
<a name='2337'>
        do k=kts,kte<a name='2338'>
          scalar_tend(i,k,j,im)=(s1d(k)-scalar(i,k,j,im))/dt<a name='2339'>
<font color=#447700>!          ws(i,k,j)=ws1d(k)   ! output fluxes<a name='2340'></font>
        enddo<a name='2341'>
        enddo<a name='2342'>
        enddo <a name='2343'>
      ELSE<a name='2344'>
<font color=#447700>!      print *,'scalar skipped im=',im, is_scalar<a name='2345'></font>
      ENDIF<a name='2346'>
      <a name='2347'>
      ENDDO <font color=#447700>! im loop<a name='2348'></font>
<font color=#447700>!!!!!!!!!!!!<a name='2349'></font>
<a name='2350'>
        <a name='2351'>
      END SUBROUTINE diff4d<a name='2352'>
<font color=#447700>! ===6=8===============================================================72<a name='2353'></font>
#endif<a name='2354'>
<a name='2355'>
<A NAME='DIFF'><A href='../../html_code/phys/module_pbl_driver.F.html#DIFF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2356'>
       <font color=#993300>subroutine </font><font color=#cc0000>diff</font>(kms,kme,kts,kte,dt,co,da,daz,cd,aa,bb,sf,vl,dz,fc) <A href='../../call_to/DIFF.html' TARGET='index'>12</A>,<A href='../../call_from/DIFF.html' TARGET='index'>2</A><a name='2357'>
<a name='2358'>
<font color=#447700>!------------------------------------------------------------------------<a name='2359'></font>
<font color=#447700>!           Calculation of the diffusion in 1D<a name='2360'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2361'></font>
<font color=#447700>!  - Input:<a name='2362'></font>
<font color=#447700>!       nz    : number of points<a name='2363'></font>
<font color=#447700>!       iz1   : first calculated point<a name='2364'></font>
<font color=#447700>!       co    : concentration of the variable of interest<a name='2365'></font>
<font color=#447700>!       dz    : vertical levels<a name='2366'></font>
<font color=#447700>!       cd    : diffusion coefficients<a name='2367'></font>
<font color=#447700>!       da    : density of the air at the center<a name='2368'></font>
<font color=#447700>!       daz   : density of the air at the face<a name='2369'></font>
<font color=#447700>!       dt    : diffusion time step<a name='2370'></font>
<font color=#447700>!  - Output:<a name='2371'></font>
<font color=#447700>!       co :concentration of the variable of interest<a name='2372'></font>
<a name='2373'>
<font color=#447700>!  - Internal:<a name='2374'></font>
<font color=#447700>!       cddz  : constant terms in the equations<a name='2375'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='2376'></font>
<a name='2377'>
        implicit none<a name='2378'>
        integer iz,iz1,izf<a name='2379'>
        integer kms,kme,kts,kte<a name='2380'>
        real dt,dzv<a name='2381'>
        real co(kms:kme),cd(kms:kme),dz(kms:kme)<a name='2382'>
        real da(kms:kme),daz(kms:kme)<a name='2383'>
        real cddz(kms:kme),fc(kms:kme),df(kms:kme)<a name='2384'>
        real a(kms:kme,3),c(kms:kme)<a name='2385'>
        real sf(kms:kme),vl(kms:kme)<a name='2386'>
        real aa(kms:kme),bb(kms:kme)<a name='2387'>
<a name='2388'>
        <a name='2389'>
<font color=#447700>! Compute cddz=2*cd/dz<a name='2390'></font>
<a name='2391'>
        cddz(kts)=sf(kts)*daz(kts)*cd(kts)/dz(kts)<a name='2392'>
        do iz=kts+1,kte<a name='2393'>
         cddz(iz)=2.*sf(iz)*daz(iz)*cd(iz)/(dz(iz)+dz(iz-1))<a name='2394'>
        enddo<a name='2395'>
        cddz(kte+1)=sf(kte+1)*daz(kte+1)*cd(kte+1)/dz(kte)<a name='2396'>
<a name='2397'>
          iz1=1<a name='2398'>
          izf=1<a name='2399'>
<a name='2400'>
          do iz=iz1,kte-1<a name='2401'>
<a name='2402'>
           dzv=vl(iz)*dz(iz)<a name='2403'>
           a(iz,1)=-cddz(iz)*dt/dzv/da(iz)<a name='2404'>
           a(iz,2)=1+dt*(cddz(iz)+cddz(iz+1))/dzv/da(iz)-aa(iz)*dt<a name='2405'>
           a(iz,3)=-cddz(iz+1)*dt/dzv/da(iz)<a name='2406'>
           c(iz)=co(iz)+bb(iz)*dt<a name='2407'>
          enddo<a name='2408'>
<a name='2409'>
          do iz=kte-(izf-1),kte<a name='2410'>
           a(iz,1)=0.<a name='2411'>
           a(iz,2)=1<a name='2412'>
           a(iz,3)=0.<a name='2413'>
           c(iz)=co(iz)<a name='2414'>
          enddo<a name='2415'>
          call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INVERT'>invert</A><A href='../../html_code/phys/module_pbl_driver.F.html#DIFF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INVERT_2"> (kms,kme,kts,kte,a,c,co)<a name='2416'>
           <a name='2417'>
<font color=#447700>!let compute the fluxes, as diagnostic variable<a name='2418'></font>
<a name='2419'>
          do iz=kts,iz1<a name='2420'>
           fc(iz)=0.<a name='2421'>
          enddo<a name='2422'>
<a name='2423'>
          do iz=iz1+1,kte<a name='2424'>
           fc(iz)=-(cddz(iz)*(co(iz)-co(iz-1)))/da(iz)<a name='2425'>
          enddo<a name='2426'>
<a name='2427'>
<a name='2428'>
<a name='2429'>
       return<a name='2430'>
       end subroutine diff<a name='2431'>
<font color=#447700>! ===6=8===============================================================72<a name='2432'></font>
<a name='2433'>
<A NAME='INVERT'><A href='../../html_code/phys/module_pbl_driver.F.html#INVERT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2434'>
       <font color=#993300>subroutine </font><font color=#cc0000>invert</font>(kms,kme,kts,kte,a,c,x) <A href='../../call_to/INVERT.html' TARGET='index'>4</A><a name='2435'>
<a name='2436'>
<font color=#447700>!ccccccccccccccccccccccccccccccc<a name='2437'></font>
<font color=#447700>! Aim: Inversion and resolution of a tridiagonal matrix<a name='2438'></font>
<font color=#447700>!          A X = C<a name='2439'></font>
<font color=#447700>! Input:<a name='2440'></font>
<font color=#447700>!  a(*,1) lower diagonal (Ai,i-1)<a name='2441'></font>
<font color=#447700>!  a(*,2) principal diagonal (Ai,i)<a name='2442'></font>
<font color=#447700>!  a(*,3) upper diagonal (Ai,i+1)<a name='2443'></font>
<font color=#447700>!  c<a name='2444'></font>
<font color=#447700>! Output<a name='2445'></font>
<font color=#447700>!  x     results<a name='2446'></font>
<font color=#447700>!ccccccccccccccccccccccccccccccc<a name='2447'></font>
<a name='2448'>
       implicit none<a name='2449'>
       integer kms,kme,kts,kte,in<a name='2450'>
       real a(kms:kme,3),c(kms:kme),x(kms:kme)<a name='2451'>
<a name='2452'>
        do in=kte-1,kts,-1<a name='2453'>
         c(in)=c(in)-a(in,3)*c(in+1)/a(in+1,2)<a name='2454'>
         a(in,2)=a(in,2)-a(in,3)*a(in+1,1)/a(in+1,2)<a name='2455'>
        enddo<a name='2456'>
<a name='2457'>
        do in=kts+1,kte<a name='2458'>
         c(in)=c(in)-a(in,1)*c(in-1)/a(in-1,2)<a name='2459'>
        enddo<a name='2460'>
<a name='2461'>
        do in=kts,kte<a name='2462'>
         x(in)=c(in)/a(in,2)<a name='2463'>
        enddo<a name='2464'>
<a name='2465'>
        return<a name='2466'>
        end subroutine invert<a name='2467'>
<a name='2468'>
<font color=#447700>! ===6=8===============================================================72<a name='2469'></font>
<a name='2470'>
<a name='2471'>
<a name='2472'>
<a name='2473'>
<a name='2474'>
<a name='2475'>
<a name='2476'>
<a name='2477'>
<a name='2478'>
<a name='2479'>
<a name='2480'>
<a name='2481'>
<a name='2482'>
END MODULE module_pbl_driver<a name='2483'>
</pre></body></html>