<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!!<a name='2'></font>
<A NAME='MODULE_CU_SAS'><A href='../../html_code/phys/module_cu_sas.F.html#MODULE_CU_SAS' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='3'>
<font color=#993300>MODULE </font><font color=#cc0000>module_cu_sas</font>  <A href='../../call_to/MODULE_CU_SAS.html' TARGET='index'>2</A><a name='4'>
<a name='5'>
CONTAINS<a name='6'>
<a name='7'>
<font color=#447700>!-----------------------------------------------------------------<a name='8'></font>
<A NAME='CU_SAS'><A href='../../html_code/phys/module_cu_sas.F.html#CU_SAS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='9'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>CU_SAS</font>(DT,ITIMESTEP,STEPCU,                        &amp; <A href='../../call_to/CU_SAS.html' TARGET='index'>1</A>,<A href='../../call_from/CU_SAS.html' TARGET='index'>7</A><a name='10'>
                 RTHCUTEN,RQVCUTEN,RQCCUTEN,RQICUTEN,               &amp;<a name='11'>
                 RUCUTEN,RVCUTEN,                                   &amp; <a name='12'>
                 RAINCV,PRATEC,HTOP,HBOT,                           &amp;<a name='13'>
                 U3D,V3D,W,T3D,QV3D,QC3D,QI3D,PI3D,RHO3D,           &amp;<a name='14'>
                 DZ8W,PCPS,P8W,XLAND,CU_ACT_FLAG,                   &amp;<a name='15'>
                 P_QC,                                              &amp; <a name='16'>
                 MOMMIX, &amp; <font color=#447700>! gopal's doing<a name='17'></font>
                 PGCON,sas_mass_flux,                               &amp;<a name='18'>
                 pert_sas, ens_random_seed, ens_sasamp,             &amp;<a name='19'>
                 shalconv,shal_pgcon,                               &amp;<a name='20'>
                 HPBL2D,EVAP2D,HEAT2D,                              &amp; <font color=#447700>!Kwon for shallow convection<a name='21'></font>
                 P_QI,P_FIRST_SCALAR,                               &amp; <a name='22'>
                 ids,ide, jds,jde, kds,kde,                         &amp;<a name='23'>
                 ims,ime, jms,jme, kms,kme,                         &amp;<a name='24'>
                 its,ite, jts,jte, kts,kte                          )<a name='25'>
<a name='26'>
<font color=#447700>!-------------------------------------------------------------------<a name='27'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_cu_sas.F.html#CU_SAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_16"> , ONLY : kind_phys<a name='28'>
      USE <A href='../../html_code/phys/module_gfs_funcphys.F.html#MODULE_GFS_FUNCPHYS'>MODULE_GFS_FUNCPHYS</A><A href='../../html_code/phys/module_cu_sas.F.html#CU_SAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_FUNCPHYS_4"> , ONLY : gfuncphys<a name='29'>
      USE <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_PHYSCONS</A><A href='../../html_code/phys/module_cu_sas.F.html#CU_SAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_9">, grav =&gt; con_g, CP =&gt; con_CP, HVAP =&gt; con_HVAP  &amp;<a name='30'>
     &amp;,             RV =&gt; con_RV, FV =&gt; con_fvirt, T0C =&gt; con_T0C       &amp;<a name='31'>
     &amp;,             CVAP =&gt; con_CVAP, CLIQ =&gt; con_CLIQ                  &amp; <a name='32'>
     &amp;,             EPS =&gt; con_eps, EPSM1 =&gt; con_epsm1                  &amp;<a name='33'>
     &amp;,             ROVCP =&gt; con_rocp, RD =&gt; con_rd<a name='34'>
<font color=#447700>!-------------------------------------------------------------------<a name='35'></font>
      IMPLICIT NONE<a name='36'>
<font color=#447700>!-------------------------------------------------------------------<a name='37'></font>
<font color=#447700>!-- U3D         3D u-velocity interpolated to theta points (m/s)<a name='38'></font>
<font color=#447700>!-- V3D         3D v-velocity interpolated to theta points (m/s)<a name='39'></font>
<font color=#447700>!-- TH3D	3D potential temperature (K)<a name='40'></font>
<font color=#447700>!-- T3D         temperature (K)<a name='41'></font>
<font color=#447700>!-- QV3D        3D water vapor mixing ratio (Kg/Kg)<a name='42'></font>
<font color=#447700>!-- QC3D        3D cloud mixing ratio (Kg/Kg)<a name='43'></font>
<font color=#447700>!-- QI3D        3D ice mixing ratio (Kg/Kg)<a name='44'></font>
<font color=#447700>!-- P8w         3D pressure at full levels (Pa)<a name='45'></font>
<font color=#447700>!-- Pcps        3D pressure (Pa)<a name='46'></font>
<font color=#447700>!-- PI3D	3D exner function (dimensionless)<a name='47'></font>
<font color=#447700>!-- rr3D	3D dry air density (kg/m^3)<a name='48'></font>
<font color=#447700>!-- RUBLTEN     U tendency due to<a name='49'></font>
<font color=#447700>!               PBL parameterization (m/s^2)<a name='50'></font>
<font color=#447700>!-- RVBLTEN     V tendency due to<a name='51'></font>
<font color=#447700>!               PBL parameterization (m/s^2)<a name='52'></font>
<font color=#447700>!-- RTHBLTEN    Theta tendency due to<a name='53'></font>
<font color=#447700>!               PBL parameterization (K/s)<a name='54'></font>
<font color=#447700>!-- RQVBLTEN    Qv tendency due to<a name='55'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='56'></font>
<font color=#447700>!-- RQCBLTEN    Qc tendency due to<a name='57'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='58'></font>
<font color=#447700>!-- RQIBLTEN    Qi tendency due to<a name='59'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='60'></font>
<font color=#447700>!<a name='61'></font>
<font color=#447700>!-- MOMMIX      MOMENTUM MIXING COEFFICIENT (can be set in the namelist)<a name='62'></font>
<font color=#447700>!-- RUCUTEN     U tendency due to Cumulus Momentum Mixing (gopal's doing for SAS)<a name='63'></font>
<font color=#447700>!-- RVCUTEN     V tendency due to Cumulus Momentum Mixing (gopal's doing for SAS)<a name='64'></font>
<font color=#447700>!<a name='65'></font>
<font color=#447700>!-- CP          heat capacity at constant pressure for dry air (J/kg/K)<a name='66'></font>
<font color=#447700>!-- GRAV        acceleration due to gravity (m/s^2)<a name='67'></font>
<font color=#447700>!-- ROVCP       R/CP<a name='68'></font>
<font color=#447700>!-- RD          gas constant for dry air (J/kg/K)<a name='69'></font>
<font color=#447700>!-- ROVG 	R/G<a name='70'></font>
<font color=#447700>!-- P_QI	species index for cloud ice<a name='71'></font>
<font color=#447700>!-- dz8w	dz between full levels (m)<a name='72'></font>
<font color=#447700>!-- z		height above sea level (m)<a name='73'></font>
<font color=#447700>!-- PSFC        pressure at the surface (Pa)<a name='74'></font>
<font color=#447700>!-- UST		u* in similarity theory (m/s)<a name='75'></font>
<font color=#447700>!-- PBL		PBL height (m)<a name='76'></font>
<font color=#447700>!-- PSIM        similarity stability function for momentum<a name='77'></font>
<font color=#447700>!-- PSIH        similarity stability function for heat<a name='78'></font>
<font color=#447700>!-- HFX		upward heat flux at the surface (W/m^2)<a name='79'></font>
<font color=#447700>!-- QFX		upward moisture flux at the surface (kg/m^2/s)<a name='80'></font>
<font color=#447700>!-- TSK		surface temperature (K)<a name='81'></font>
<font color=#447700>!-- GZ1OZ0      log(z/z0) where z0 is roughness length<a name='82'></font>
<font color=#447700>!-- WSPD        wind speed at lowest model level (m/s)<a name='83'></font>
<font color=#447700>!-- BR          bulk Richardson number in surface layer<a name='84'></font>
<font color=#447700>!-- DT		time step (s)<a name='85'></font>
<font color=#447700>!-- rvovrd      R_v divided by R_d (dimensionless)<a name='86'></font>
<font color=#447700>!-- EP1         constant for virtual temperature (R_v/R_d - 1) (dimensionless)<a name='87'></font>
<font color=#447700>!-- KARMAN      Von Karman constant<a name='88'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='89'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='90'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='91'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='92'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='93'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='94'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='95'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='96'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='97'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='98'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='99'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='100'></font>
<font color=#447700>!-- its         start index for i in tile<a name='101'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='102'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='103'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='104'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='105'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='106'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='107'></font>
<a name='108'>
      INTEGER ::                        ICLDCK<a name='109'>
<a name='110'>
      INTEGER, INTENT(IN) ::            ids,ide, jds,jde, kds,kde,      &amp;<a name='111'>
                                        ims,ime, jms,jme, kms,kme,      &amp;<a name='112'>
                                        its,ite, jts,jte, kts,kte,      &amp;<a name='113'>
                                        ITIMESTEP,                      &amp;     <font color=#447700>!NSTD<a name='114'></font>
                                        P_FIRST_SCALAR,                 &amp;<a name='115'>
                                        P_QC,                           &amp;<a name='116'>
                                        P_QI,                           &amp;<a name='117'>
                                        STEPCU<a name='118'>
<a name='119'>
      REAL,    INTENT(IN) ::                                            &amp;<a name='120'>
                                        DT<a name='121'>
<a name='122'>
      REAL, OPTIONAL, INTENT(IN) :: PGCON,sas_mass_flux,shal_pgcon<a name='123'>
      INTEGER, OPTIONAL, INTENT(IN) :: shalconv<a name='124'>
      REAL(kind=kind_phys)       :: PGCON_USE,SHAL_PGCON_USE,massf<a name='125'>
      logical,intent(in)  :: pert_sas<a name='126'>
      integer,intent(in)  :: ens_random_seed<a name='127'>
      real,intent(in)     :: ens_sasamp<a name='128'>
      INTEGER :: shalconv_use<a name='129'>
      REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::      &amp;<a name='130'>
                                        RQCCUTEN,                       &amp;<a name='131'>
                                        RQICUTEN,                       &amp;<a name='132'>
                                        RQVCUTEN,                       &amp;<a name='133'>
                                        RTHCUTEN<a name='134'>
      REAL, DIMENSION(ims:ime, jms:jme, kms:kme), INTENT(INOUT) ::      &amp;<a name='135'>
                                        RUCUTEN,                        &amp;  <a name='136'>
                                        RVCUTEN                             <a name='137'>
      REAL, OPTIONAL,   INTENT(IN) ::    MOMMIX<a name='138'>
<a name='139'>
      REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL,                   &amp;<a name='140'>
                         INTENT(IN) :: HPBL2D,EVAP2D,HEAT2D                <font color=#447700>!Kwon for sha<a name='141'></font>
<a name='142'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(IN) ::               &amp;<a name='143'>
                                        XLAND<a name='144'>
<a name='145'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(INOUT) ::            &amp;<a name='146'>
                                        RAINCV, PRATEC<a name='147'>
<a name='148'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(OUT) ::              &amp;<a name='149'>
                                        HBOT,                           &amp;<a name='150'>
                                        HTOP<a name='151'>
<a name='152'>
      LOGICAL, DIMENSION(IMS:IME,JMS:JME), INTENT(INOUT) ::             &amp;<a name='153'>
                                        CU_ACT_FLAG<a name='154'>
<a name='155'>
<a name='156'>
      REAL,    DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN) ::      &amp;<a name='157'>
                                        DZ8W,                           &amp;<a name='158'>
                                        P8w,                            &amp;<a name='159'>
                                        Pcps,                           &amp;<a name='160'>
                                        PI3D,                           &amp;<a name='161'>
                                        QC3D,                           &amp;<a name='162'>
                                        QI3D,                           &amp;<a name='163'>
                                        QV3D,                           &amp;<a name='164'>
                                        RHO3D,                          &amp;<a name='165'>
                                        T3D,                            &amp;<a name='166'>
                                        U3D,                            &amp;<a name='167'>
                                        V3D,                            &amp;<a name='168'>
                                        W<a name='169'>
<a name='170'>
<font color=#447700>!--------------------------- LOCAL VARS ------------------------------<a name='171'></font>
<a name='172'>
      REAL,    DIMENSION(ims:ime, jms:jme) ::                           &amp;<a name='173'>
                                        PSFC<a name='174'>
<a name='175'>
      REAL,    DIMENSION(its:ite, jts:jte) ::                           &amp;<a name='176'>
                                        RAINCV1, PRATEC1<a name='177'>
      REAL,    DIMENSION(its:ite, jts:jte) ::                           &amp;<a name='178'>
                                        RAINCV2, PRATEC2<a name='179'>
<a name='180'>
      REAL     (kind=kind_phys) ::                                      &amp;<a name='181'>
                                        DELT,                           &amp;<a name='182'>
                                        DPSHC,                          &amp;<a name='183'>
                                        RDELT,                          &amp;<a name='184'>
                                        RSEED<a name='185'>
<a name='186'>
      REAL     (kind=kind_phys), DIMENSION(its:ite) ::                  &amp;<a name='187'>
                                        CLDWRK,                         &amp;<a name='188'>
                                        PS,                             &amp;<a name='189'>
                                        RCS,                            &amp;<a name='190'>
                                        RN,                             &amp;<a name='191'>
                                        SLIMSK,                         &amp;<a name='192'>
                                        HPBL,EVAP,HEAT                     <font color=#447700>!Kwon for shallow convection<a name='193'></font>
<a name='194'>
      REAL     (kind=kind_phys), DIMENSION(its:ite, kts:kte+1) ::       &amp;<a name='195'>
                                        PRSI                            <a name='196'>
<a name='197'>
      REAL     (kind=kind_phys), DIMENSION(its:ite, kts:kte) ::         &amp;<a name='198'>
                                        DEL,                            &amp;<a name='199'>
                                        DOT,                            &amp;<a name='200'>
                                        PHIL,                           &amp;<a name='201'>
                                        PRSL,                           &amp;<a name='202'>
                                        PRSLK,                          &amp;<a name='203'>
                                        Q1,                             &amp; <a name='204'>
                                        T1,                             &amp; <a name='205'>
                                        U1,                             &amp; <a name='206'>
                                        V1,                             &amp; <a name='207'>
                                        ZI,                             &amp; <a name='208'>
                                        ZL <a name='209'>
<a name='210'>
      REAL     (kind=kind_phys), DIMENSION(its:ite, kts:kte, 2) ::      &amp;<a name='211'>
                                        QL <a name='212'>
<a name='213'>
      INTEGER, DIMENSION(its:ite) ::                                    &amp;<a name='214'>
                                        KBOT,                           &amp;<a name='215'>
                                        KTOP,                           &amp;<a name='216'>
                                        KCNV<a name='217'>
<a name='218'>
      INTEGER ::                                                        &amp;<a name='219'>
                                        I,                              &amp;<a name='220'>
                                        IGPVS,                          &amp;<a name='221'>
                                        IM,                             &amp;<a name='222'>
                                        J,                              &amp;<a name='223'>
                                        JCAP,                           &amp;<a name='224'>
                                        K,                              &amp;<a name='225'>
                                        KM,                             &amp;<a name='226'>
                                        KP,                             &amp;<a name='227'>
                                        KX,                             &amp;<a name='228'>
                                        NCLOUD <a name='229'>
<a name='230'>
      DATA IGPVS/0/<a name='231'>
<a name='232'>
<font color=#447700>!-----------------------------------------------------------------------<a name='233'></font>
<font color=#447700>!<a name='234'></font>
<a name='235'>
      if(present(shalconv)) then<a name='236'>
         shalconv_use=shalconv<a name='237'>
      else<a name='238'>
#if (NMM_CORE==1)<a name='239'>
         shalconv_use=0<a name='240'>
#else<a name='241'>
#if (EM_CORE==1)<a name='242'>
         shalconv_use=1<a name='243'>
#else<a name='244'>
         shalconv_use=0<a name='245'>
#endif<a name='246'>
#endif<a name='247'>
      endif<a name='248'>
<a name='249'>
      if(present(pgcon)) then<a name='250'>
         pgcon_use  = pgcon<a name='251'>
      else<a name='252'>
<font color=#447700>!        pgcon_use  = 0.7     ! Gregory et al. (1997, QJRMS)<a name='253'></font>
         pgcon_use  = 0.55    <font color=#447700>! Zhang &amp; Wu (2003,JAS), used in GFS (25km res spectral)<a name='254'></font>
<font color=#447700>!        pgcon_use  = 0.2     ! HWRF, for model tuning purposes<a name='255'></font>
<font color=#447700>!        pgcon_use  = 0.3     ! GFDL, or so I am told<a name='256'></font>
<a name='257'>
         <font color=#447700>! For those attempting to tune pgcon:<a name='258'></font>
<a name='259'>
         <font color=#447700>! The value of 0.55 comes from an observational study of<a name='260'></font>
         <font color=#447700>! synoptic-scale deep convection and 0.7 came from an<a name='261'></font>
         <font color=#447700>! incorrect fit to the same data.  That value is likely<a name='262'></font>
         <font color=#447700>! correct for deep convection at gridscales near that of GFS,<a name='263'></font>
         <font color=#447700>! but is questionable in shallow convection, or for scales<a name='264'></font>
         <font color=#447700>! much finer than synoptic scales.<a name='265'></font>
<a name='266'>
         <font color=#447700>! Then again, the assumptions of SAS break down when the<a name='267'></font>
         <font color=#447700>! gridscale is near the convection scale anyway.  In a large<a name='268'></font>
         <font color=#447700>! storm such as a hurricane, there is often no environment to<a name='269'></font>
         <font color=#447700>! detrain into since adjancent gridsquares are also undergoing<a name='270'></font>
         <font color=#447700>! active convection.  Each gridsquare will no longer have many<a name='271'></font>
         <font color=#447700>! updrafts and downdrafts.  At sub-convective timescales, you<a name='272'></font>
         <font color=#447700>! will find unstable columns for many (say, 5 second length)<a name='273'></font>
         <font color=#447700>! timesteps in a real atmosphere during a convection cell's<a name='274'></font>
         <font color=#447700>! lifetime, so forcing it to be neutrally stable is unphysical.<a name='275'></font>
<a name='276'>
         <font color=#447700>! Hence, in scales near the convection scale (cells have<a name='277'></font>
         <font color=#447700>! ~0.5-4km diameter in hurricanes), this parameter is more of a<a name='278'></font>
         <font color=#447700>! tuning parameter to get a scheme that is inappropriate for<a name='279'></font>
         <font color=#447700>! that resolution to do a reasonable job.<a name='280'></font>
<a name='281'>
         <font color=#447700>! Your mileage might vary.<a name='282'></font>
<a name='283'>
         <font color=#447700>! - Sam Trahan<a name='284'></font>
      endif<a name='285'>
<a name='286'>
      if(present(sas_mass_flux)) then<a name='287'>
         massf=sas_mass_flux<a name='288'>
         <font color=#447700>! Use this to reduce the fluxes added by SAS to prevent<a name='289'></font>
         <font color=#447700>! computational instability as a result of large fluxes.<a name='290'></font>
      else<a name='291'>
         massf=9e9 <font color=#447700>! large number to disable check<a name='292'></font>
      endif<a name='293'>
<a name='294'>
      if(present(shal_pgcon)) then<a name='295'>
         if(shal_pgcon&gt;=0) then<a name='296'>
            shal_pgcon_use  = shal_pgcon<a name='297'>
         else<a name='298'>
            <font color=#447700>! shal_pgcon&lt;0 means use deep pgcon<a name='299'></font>
            shal_pgcon_use  = pgcon_use<a name='300'>
         endif<a name='301'>
      else<a name='302'>
         <font color=#447700>! Default: Same as deep convection pgcon<a name='303'></font>
         shal_pgcon_use  = pgcon_use<a name='304'>
         <font color=#447700>! Read the warning above though.  It may be advisable for<a name='305'></font>
         <font color=#447700>! these to be different.  <a name='306'></font>
      endif<a name='307'>
<a name='308'>
      DO J=JTS,JTE<a name='309'>
         DO I=ITS,ITE<a name='310'>
            CU_ACT_FLAG(I,J)=.TRUE.<a name='311'>
         ENDDO<a name='312'>
      ENDDO<a name='313'>
 <a name='314'>
      IM=ITE-ITS+1<a name='315'>
      KX=KTE-KTS+1<a name='316'>
      JCAP=126<a name='317'>
      DPSHC=30_kind_phys<a name='318'>
      DELT=DT*STEPCU<a name='319'>
      RDELT=1./DELT<a name='320'>
      NCLOUD=1<a name='321'>
<a name='322'>
<a name='323'>
   DO J=jms,jme<a name='324'>
     DO I=ims,ime<a name='325'>
       PSFC(i,j)=P8w(i,kms,j)<a name='326'>
     ENDDO<a name='327'>
   ENDDO<a name='328'>
<a name='329'>
   if(igpvs.eq.0) CALL <A href='../../html_code/phys/module_gfs_funcphys.F.html#GFUNCPHYS'>GFUNCPHYS</A><A href='../../html_code/phys/module_cu_sas.F.html#CU_SAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GFUNCPHYS_2"><a name='330'>
   igpvs=1<a name='331'>
<a name='332'>
<font color=#447700>!-------------  J LOOP (OUTER) --------------------------------------------------<a name='333'></font>
<a name='334'>
   big_outer_j_loop: DO J=jts,jte<a name='335'>
<a name='336'>
<font color=#447700>! --------------- compute zi and zl -----------------------------------------<a name='337'></font>
      DO i=its,ite<a name='338'>
        ZI(I,KTS)=0.0<a name='339'>
      ENDDO<a name='340'>
<a name='341'>
      DO k=kts+1,kte<a name='342'>
        KM=K-1<a name='343'>
        DO i=its,ite<a name='344'>
          ZI(I,K)=ZI(I,KM)+dz8w(i,km,j)<a name='345'>
        ENDDO<a name='346'>
      ENDDO<a name='347'>
<a name='348'>
      DO k=kts+1,kte<a name='349'>
        KM=K-1<a name='350'>
        DO i=its,ite<a name='351'>
          ZL(I,KM)=(ZI(I,K)+ZI(I,KM))*0.5<a name='352'>
        ENDDO<a name='353'>
      ENDDO<a name='354'>
<a name='355'>
      DO i=its,ite<a name='356'>
        ZL(I,KTE)=2.*ZI(I,KTE)-ZL(I,KTE-1)<a name='357'>
      ENDDO<a name='358'>
<a name='359'>
<font color=#447700>! --------------- end compute zi and zl -------------------------------------<a name='360'></font>
<a name='361'>
      DO i=its,ite<a name='362'>
        PS(i)=PSFC(i,j)*.001<a name='363'>
        RCS(i)=1.<a name='364'>
        SLIMSK(i)=ABS(XLAND(i,j)-2.)<a name='365'>
      ENDDO<a name='366'>
<a name='367'>
#if (NMM_CORE == 1)<a name='368'>
      if(shalconv_use==1) then<a name='369'>
      DO i=its,ite<a name='370'>
         HPBL(I) = HPBL2D(I,J)          <font color=#447700>!kwon for shallow convection<a name='371'></font>
         EVAP(I) = EVAP2D(I,J)          <font color=#447700>!kwon for shallow convection<a name='372'></font>
         HEAT(I) = HEAT2D(I,J)          <font color=#447700>!kwon for shallow convection<a name='373'></font>
      ENDDO<a name='374'>
      endif<a name='375'>
#endif<a name='376'>
<a name='377'>
      DO i=its,ite<a name='378'>
        PRSI(i,kts)=PS(i)<a name='379'>
      ENDDO<a name='380'>
<a name='381'>
      DO k=kts,kte<a name='382'>
        kp=k+1<a name='383'>
        DO i=its,ite<a name='384'>
          PRSL(I,K)=Pcps(i,k,j)*.001<a name='385'>
          PHIL(I,K)=ZL(I,K)*GRAV<a name='386'>
          DOT(i,k)=-5.0E-4*GRAV*rho3d(i,k,j)*(w(i,k,j)+w(i,kp,j))<a name='387'>
        ENDDO<a name='388'>
      ENDDO<a name='389'>
<a name='390'>
      DO k=kts,kte<a name='391'>
        DO i=its,ite<a name='392'>
          DEL(i,k)=PRSL(i,k)*GRAV/RD*dz8w(i,k,j)/T3D(i,k,j)<a name='393'>
          U1(i,k)=U3D(i,k,j)<a name='394'>
          V1(i,k)=V3D(i,k,j)<a name='395'>
          Q1(i,k)=QV3D(i,k,j)/(1.+QV3D(i,k,j))<a name='396'>
          T1(i,k)=T3D(i,k,j)<a name='397'>
          QL(i,k,1)=QI3D(i,k,j)/(1.+QI3D(i,k,j))<a name='398'>
          QL(i,k,2)=QC3D(i,k,j)/(1.+QC3D(i,k,j))<a name='399'>
          PRSLK(I,K)=(PRSL(i,k)*.01)**ROVCP<a name='400'>
        ENDDO<a name='401'>
      ENDDO<a name='402'>
<a name='403'>
      DO k=kts+1,kte+1<a name='404'>
        km=k-1<a name='405'>
        DO i=its,ite<a name='406'>
          PRSI(i,k)=PRSI(i,km)-del(i,km) <a name='407'>
        ENDDO<a name='408'>
      ENDDO<a name='409'>
<a name='410'>
      CALL <A href='../../html_code/phys/module_cu_sas.F.html#SASCNVN'>SASCNVN</A><A href='../../html_code/phys/module_cu_sas.F.html#CU_SAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SASCNVN_1">(IM,IM,KX,JCAP,DELT,DEL,PRSL,PS,PHIL,                 &amp;<a name='411'>
                  QL,Q1,T1,U1,V1,RCS,CLDWRK,RN,KBOT,                    &amp;<a name='412'>
                  KTOP,KCNV,SLIMSK,DOT,NCLOUD,PGCON_USE,massf,          &amp;<a name='413'>
                  pert_sas, ens_random_seed, ens_sasamp)                         <a name='414'>
<font color=#447700>!<a name='415'></font>
      do i=its,ite<a name='416'>
        RAINCV1(I,J)=RN(I)*1000./STEPCU<a name='417'>
        PRATEC1(I,J)=RN(I)*1000./(STEPCU * DT)<a name='418'>
      enddo<a name='419'>
<font color=#447700>!<a name='420'></font>
      do i=its,ite<a name='421'>
        RAINCV2(I,J)=0.<a name='422'>
        PRATEC2(I,J)=0.<a name='423'>
      enddo<a name='424'>
<font color=#447700>!<a name='425'></font>
<a name='426'>
      if_shallow_conv: if(shalconv_use==1) then<a name='427'>
#if (NMM_CORE == 1)<a name='428'>
         <font color=#447700>! NMM calls the new shallow convection developed by J Han<a name='429'></font>
         <font color=#447700>! (Added to WRF by Y.Kwon)<a name='430'></font>
        call <A href='../../html_code/phys/module_cu_sas.F.html#SHALCNV'>shalcnv</A><A href='../../html_code/phys/module_cu_sas.F.html#CU_SAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHALCNV_1">(im,im,kx,jcap,delt,del,prsl,ps,phil,ql,        &amp;<a name='431'>
     &amp;               q1,t1,u1,v1,rcs,rn,kbot,ktop,kcnv,slimsk,      &amp;<a name='432'>
     &amp;               dot,ncloud,hpbl,heat,evap,shal_pgcon_use)<a name='433'>
<font color=#447700>!<a name='434'></font>
      DO I=ITS,ITE<a name='435'>
        RAINCV2(I,J)=RN(I)*1000./STEPCU<a name='436'>
        PRATEC2(I,J)=RN(I)*1000./(STEPCU * DT)<a name='437'>
      ENDDO<a name='438'>
<font color=#447700>!<a name='439'></font>
#else<a name='440'>
#if (EM_CORE == 1)<a name='441'>
        <font color=#447700>! NOTE: ARW should be able to call the new shalcnv here, but<a name='442'></font>
        <font color=#447700>! they need to add the three new variables, so I'm leaving the<a name='443'></font>
        <font color=#447700>! old shallow convection call here - Sam Trahan<a name='444'></font>
        CALL <A href='../../html_code/phys/module_cu_sas.F.html#OLD_ARW_SHALCV'>OLD_ARW_SHALCV</A><A href='../../html_code/phys/module_cu_sas.F.html#CU_SAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OLD_ARW_SHALCV_1">(IM,IM,KX,DELT,DEL,PRSI,PRSL,PRSLK,KCNV,Q1,T1,DPSHC)<a name='445'>
#else<a name='446'>
        <font color=#447700>! Shallow convection is untested for other cores.<a name='447'></font>
#endif<a name='448'>
#endif<a name='449'>
     endif if_shallow_conv<a name='450'>
<a name='451'>
        DO I=ITS,ITE<a name='452'>
        RAINCV(I,J)= RAINCV1(I,J) + RAINCV2(I,J)<a name='453'>
        PRATEC(I,J)= PRATEC1(I,J) + PRATEC2(I,J)<a name='454'>
        HBOT(I,J)=KBOT(I)<a name='455'>
        HTOP(I,J)=KTOP(I)<a name='456'>
      ENDDO<a name='457'>
<a name='458'>
      DO K=KTS,KTE<a name='459'>
        DO I=ITS,ITE<a name='460'>
          RTHCUTEN(I,K,J)=(T1(I,K)-T3D(I,K,J))/PI3D(I,K,J)*RDELT<a name='461'>
          RQVCUTEN(I,K,J)=(Q1(I,K)/(1.-q1(i,k))-QV3D(I,K,J))*RDELT<a name='462'>
        ENDDO<a name='463'>
      ENDDO<a name='464'>
<a name='465'>
<font color=#447700>!===============================================================================<a name='466'></font>
<font color=#447700>!     ADD MOMENTUM MIXING TERM AS TENDENCIES. This is gopal's doing for SAS<a name='467'></font>
<font color=#447700>!     MOMMIX is the reduction factor set to 0.7 by default. Because NMM has <a name='468'></font>
<font color=#447700>!     divergence damping term, a reducion factor for cumulum mixing may be<a name='469'></font>
<font color=#447700>!     required otherwise storms were too weak.<a name='470'></font>
<font color=#447700>!===============================================================================<a name='471'></font>
<font color=#447700>!<a name='472'></font>
#if (NMM_CORE == 1)<a name='473'>
      DO K=KTS,KTE<a name='474'>
        DO I=ITS,ITE<a name='475'>
<font color=#447700>!         RUCUTEN(I,J,K)=MOMMIX*(U1(I,K)-U3D(I,K,J))*RDELT<a name='476'></font>
<font color=#447700>!         RVCUTEN(I,J,K)=MOMMIX*(V1(I,K)-V3D(I,K,J))*RDELT<a name='477'></font>
         RUCUTEN(I,J,K)=(U1(I,K)-U3D(I,K,J))*RDELT<a name='478'>
         RVCUTEN(I,J,K)=(V1(I,K)-V3D(I,K,J))*RDELT<a name='479'>
        ENDDO<a name='480'>
      ENDDO<a name='481'>
#endif<a name='482'>
<a name='483'>
<a name='484'>
      IF(P_QC .ge. P_FIRST_SCALAR)THEN<a name='485'>
        DO K=KTS,KTE<a name='486'>
          DO I=ITS,ITE<a name='487'>
            RQCCUTEN(I,K,J)=(QL(I,K,2)/(1.-ql(i,k,2))-QC3D(I,K,J))*RDELT<a name='488'>
          ENDDO<a name='489'>
        ENDDO<a name='490'>
      ENDIF<a name='491'>
<a name='492'>
      IF(P_QI .ge. P_FIRST_SCALAR)THEN<a name='493'>
        DO K=KTS,KTE<a name='494'>
          DO I=ITS,ITE<a name='495'>
            RQICUTEN(I,K,J)=(QL(I,K,1)/(1.-ql(i,k,1))-QI3D(I,K,J))*RDELT<a name='496'>
          ENDDO<a name='497'>
        ENDDO<a name='498'>
      ENDIF<a name='499'>
<a name='500'>
   ENDDO big_outer_j_loop    <font color=#447700>! Outer most J loop<a name='501'></font>
<a name='502'>
   END SUBROUTINE CU_SAS<a name='503'>
<a name='504'>
<font color=#447700>!====================================================================<a name='505'></font>
<A NAME='SASINIT'><A href='../../html_code/phys/module_cu_sas.F.html#SASINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='506'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>sasinit</font>(RTHCUTEN,RQVCUTEN,RQCCUTEN,RQICUTEN,          &amp; <A href='../../call_to/SASINIT.html' TARGET='index'>1</A><a name='507'>
                      RUCUTEN,RVCUTEN,                              &amp;   <a name='508'>
                      RESTART,P_QC,P_QI,P_FIRST_SCALAR,             &amp;<a name='509'>
                      allowed_to_read,                              &amp;<a name='510'>
                      ids, ide, jds, jde, kds, kde,                 &amp;<a name='511'>
                      ims, ime, jms, jme, kms, kme,                 &amp;<a name='512'>
                      its, ite, jts, jte, kts, kte                  )<a name='513'>
<font color=#447700>!--------------------------------------------------------------------<a name='514'></font>
   IMPLICIT NONE<a name='515'>
<font color=#447700>!--------------------------------------------------------------------<a name='516'></font>
   LOGICAL , INTENT(IN)           ::  allowed_to_read,restart<a name='517'>
   INTEGER , INTENT(IN)           ::  ids, ide, jds, jde, kds, kde, &amp;<a name='518'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='519'>
                                      its, ite, jts, jte, kts, kte<a name='520'>
   INTEGER , INTENT(IN)           ::  P_FIRST_SCALAR, P_QI, P_QC<a name='521'>
<a name='522'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::  &amp;<a name='523'>
                                                              RTHCUTEN, &amp;<a name='524'>
                                                              RQVCUTEN, &amp;<a name='525'>
                                                              RQCCUTEN, &amp;<a name='526'>
                                                              RQICUTEN<a name='527'>
   REAL,     DIMENSION( ims:ime , jms:jme , kms:kme ) , INTENT(OUT) ::  &amp;<a name='528'>
                                                              RUCUTEN,  &amp; <font color=#447700>! gopal's doing for SAS<a name='529'></font>
                                                              RVCUTEN   <a name='530'>
<a name='531'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='532'>
<a name='533'>
   jtf=min0(jte,jde-1)<a name='534'>
   ktf=min0(kte,kde-1)<a name='535'>
   itf=min0(ite,ide-1)<a name='536'>
<a name='537'>
#if ( HWRF == 1 )<a name='538'>
<font color=#447700>!zhang's doing<a name='539'></font>
   IF(.not.restart .or. .not.allowed_to_read)THEN<a name='540'>
<font color=#447700>!end of zhang's doing<a name='541'></font>
#else<a name='542'>
   IF(.not.restart)THEN<a name='543'>
#endif<a name='544'>
     DO j=jts,jtf<a name='545'>
     DO k=kts,ktf<a name='546'>
     DO i=its,itf<a name='547'>
       RTHCUTEN(i,k,j)=0.<a name='548'>
       RQVCUTEN(i,k,j)=0.<a name='549'>
       RUCUTEN(i,j,k)=0.   <a name='550'>
       RVCUTEN(i,j,k)=0.    <a name='551'>
     ENDDO<a name='552'>
     ENDDO<a name='553'>
     ENDDO<a name='554'>
<a name='555'>
     IF (P_QC .ge. P_FIRST_SCALAR) THEN<a name='556'>
        DO j=jts,jtf<a name='557'>
        DO k=kts,ktf<a name='558'>
        DO i=its,itf<a name='559'>
           RQCCUTEN(i,k,j)=0.<a name='560'>
        ENDDO<a name='561'>
        ENDDO<a name='562'>
        ENDDO<a name='563'>
     ENDIF<a name='564'>
<a name='565'>
     IF (P_QI .ge. P_FIRST_SCALAR) THEN<a name='566'>
        DO j=jts,jtf<a name='567'>
        DO k=kts,ktf<a name='568'>
        DO i=its,itf<a name='569'>
           RQICUTEN(i,k,j)=0.<a name='570'>
        ENDDO<a name='571'>
        ENDDO<a name='572'>
        ENDDO<a name='573'>
     ENDIF<a name='574'>
   ENDIF<a name='575'>
<a name='576'>
      END SUBROUTINE sasinit<a name='577'>
<a name='578'>
<font color=#447700>! ------------------------------------------------------------------------<a name='579'></font>
<a name='580'>
<A NAME='SASCNV'><A href='../../html_code/phys/module_cu_sas.F.html#SASCNV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='581'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SASCNV</font>(IM,IX,KM,JCAP,DELT,DEL,PRSL,PS,PHIL,QL,         &amp;,<A href='../../call_from/SASCNV.html' TARGET='index'>3</A><a name='582'>
<font color=#447700>!     SUBROUTINE SASCNV(IM,IX,KM,JCAP,DLT,DEL,PRSL,PHIL,QL,             &amp;<a name='583'></font>
     &amp;       Q1,T1,U1,V1,RCS,CLDWRK,RN,KBOT,KTOP,KUO,SLIMSK,            &amp;<a name='584'>
     &amp;       DOT,XKT2,ncloud)<a name='585'>
<font color=#447700>!  for cloud water version<a name='586'></font>
<font color=#447700>!     parameter(ncloud=0)<a name='587'></font>
<font color=#447700>!     SUBROUTINE SASCNV(KM,JCAP,DELT,DEL,SL,SLK,PS,QL,<a name='588'></font>
<font color=#447700>!    &amp;       Q1,T1,U1,V1,RCS,CLDWRK,RN,KBOT,KTOP,KUO,SLIMSK,<a name='589'></font>
<font color=#447700>!    &amp;       DOT,xkt2,ncloud)<a name='590'></font>
<font color=#447700>!<a name='591'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_cu_sas.F.html#SASCNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_17"> , ONLY : kind_phys<a name='592'>
      USE <A href='../../html_code/phys/module_gfs_funcphys.F.html#MODULE_GFS_FUNCPHYS'>MODULE_GFS_FUNCPHYS</A><A href='../../html_code/phys/module_cu_sas.F.html#SASCNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_FUNCPHYS_5"> ,ONLY : fpvs<a name='593'>
      USE <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_PHYSCONS</A><A href='../../html_code/phys/module_cu_sas.F.html#SASCNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_10">, grav =&gt; con_g, CP =&gt; con_CP, HVAP =&gt; con_HVAP &amp;<a name='594'>
     &amp;,             RV =&gt; con_RV, FV =&gt; con_fvirt, T0C =&gt; con_T0C       &amp;<a name='595'>
     &amp;,             CVAP =&gt; con_CVAP, CLIQ =&gt; con_CLIQ                  &amp;<a name='596'>
     &amp;,             EPS =&gt; con_eps, EPSM1 =&gt; con_epsm1<a name='597'>
<a name='598'>
      implicit none<a name='599'>
<font color=#447700>!<a name='600'></font>
<font color=#447700>!     include 'constant.h'<a name='601'></font>
<font color=#447700>!<a name='602'></font>
      integer            IM, IX,  KM, JCAP, ncloud,                     &amp;<a name='603'>
     &amp;                   KBOT(IM), KTOP(IM), KUO(IM), J<a name='604'>
      real(kind=kind_phys) DELT<a name='605'>
      real(kind=kind_phys) PS(IM),      DEL(IX,KM),  PRSL(IX,KM),       &amp;<a name='606'>
<font color=#447700>!     real(kind=kind_phys)              DEL(IX,KM),  PRSL(IX,KM),<a name='607'></font>
     &amp;                     QL(IX,KM,2), Q1(IX,KM),   T1(IX,KM),         &amp;<a name='608'>
     &amp;                     U1(IX,KM),   V1(IX,KM),   RCS(IM),           &amp;<a name='609'>
     &amp;                     CLDWRK(IM),  RN(IM),      SLIMSK(IM),        &amp;<a name='610'>
     &amp;                     DOT(IX,KM),  XKT2(IM),    PHIL(IX,KM)<a name='611'>
<font color=#447700>!<a name='612'></font>
      integer              I, INDX, jmn, k, knumb, latd, lond, km1<a name='613'>
<font color=#447700>!<a name='614'></font>
      real(kind=kind_phys) adw,     alpha,   alphal,  alphas,           &amp;<a name='615'>
     &amp;                     aup,     beta,    betal,   betas,            &amp;<a name='616'>
     &amp;                     c0,      cpoel,   dellat,  delta,            &amp;<a name='617'>
     &amp;                     desdt,   deta,    detad,   dg,               &amp;<a name='618'>
     &amp;                     dh,      dhh,     dlnsig,  dp,               &amp;<a name='619'>
     &amp;                     dq,      dqsdp,   dqsdt,   dt,               &amp;<a name='620'>
     &amp;                     dt2,     dtmax,   dtmin,   dv1,              &amp;<a name='621'>
     &amp;                     dv1q,    dv2,     dv2q,    dv1u,             &amp;<a name='622'>
     &amp;                     dv1v,    dv2u,    dv2v,    dv3u,             &amp;<a name='623'>
     &amp;                     dv3v,    dv3,     dv3q,    dvq1,             &amp;<a name='624'>
     &amp;                     dz,      dz1,     e1,      edtmax,           &amp;<a name='625'>
     &amp;                     edtmaxl, edtmaxs, el2orc,  elocp,            &amp;<a name='626'>
     &amp;                     es,      etah,                               &amp;<a name='627'>
     &amp;                     evef,    evfact,  evfactl, fact1,            &amp;<a name='628'>
     &amp;                     fact2,   factor,  fjcap,   fkm,              &amp;<a name='629'>
     &amp;                     fuv,     g,       gamma,   onemf,            &amp;<a name='630'>
     &amp;                     onemfu,  pdetrn,  pdpdwn,  pprime,           &amp;<a name='631'>
     &amp;                     qc,      qlk,     qrch,    qs,               &amp;<a name='632'>
     &amp;                     rain,    rfact,   shear,   tem1,             &amp;<a name='633'>
     &amp;                     tem2,    terr,    val,     val1,             &amp;<a name='634'>
     &amp;                     val2,    w1,      w1l,     w1s,              &amp;<a name='635'>
     &amp;                     w2,      w2l,     w2s,     w3,               &amp;<a name='636'>
     &amp;                     w3l,     w3s,     w4,      w4l,              &amp; <a name='637'>
     &amp;                     w4s,     xdby,    xpw,     xpwd,             &amp; <a name='638'>
     &amp;                     xqc,     xqrch,   xlambu,  mbdt,             &amp;<a name='639'>
     &amp;                     tem<a name='640'>
<font color=#447700>!<a name='641'></font>
<font color=#447700>!<a name='642'></font>
      integer              JMIN(IM), KB(IM), KBCON(IM), KBDTR(IM),      &amp; <a name='643'>
     &amp;                     KT2(IM),  KTCON(IM), LMIN(IM),               &amp;<a name='644'>
     &amp;                     kbm(IM),  kbmax(IM), kmax(IM)<a name='645'>
<font color=#447700>!<a name='646'></font>
      real(kind=kind_phys) AA1(IM),     ACRT(IM),   ACRTFCT(IM),        &amp; <a name='647'>
     &amp;                     DELHBAR(IM), DELQ(IM),   DELQ2(IM),          &amp;<a name='648'>
     &amp;                     DELQBAR(IM), DELQEV(IM), DELTBAR(IM),        &amp;<a name='649'>
     &amp;                     DELTV(IM),   DTCONV(IM), EDT(IM),            &amp;<a name='650'>
     &amp;                     EDTO(IM),    EDTX(IM),   FLD(IM),            &amp;<a name='651'>
     &amp;                     HCDO(IM),    HKBO(IM),   HMAX(IM),           &amp;<a name='652'>
     &amp;                     HMIN(IM),    HSBAR(IM),  UCDO(IM),           &amp;<a name='653'>
     &amp;                     UKBO(IM),    VCDO(IM),   VKBO(IM),           &amp;<a name='654'>
     &amp;                     PBCDIF(IM),  PDOT(IM),   PO(IM,KM),          &amp;<a name='655'>
     &amp;                                  PWAVO(IM),  PWEVO(IM),          &amp;<a name='656'>
<font color=#447700>!    &amp;                     PSFC(IM),    PWAVO(IM),  PWEVO(IM),          &amp;<a name='657'></font>
     &amp;                     QCDO(IM),    QCOND(IM),  QEVAP(IM),          &amp;<a name='658'>
     &amp;                     QKBO(IM),    RNTOT(IM),  VSHEAR(IM),         &amp;<a name='659'>
     &amp;                     XAA0(IM),    XHCD(IM),   XHKB(IM),           &amp; <a name='660'>
     &amp;                     XK(IM),      XLAMB(IM),  XLAMD(IM),          &amp;<a name='661'>
     &amp;                     XMB(IM),     XMBMAX(IM), XPWAV(IM),          &amp;<a name='662'>
     &amp;                     XPWEV(IM),   XQCD(IM),   XQKB(IM)<a name='663'>
<font color=#447700>!<a name='664'></font>
<font color=#447700>!  PHYSICAL PARAMETERS<a name='665'></font>
      PARAMETER(G=grav)<a name='666'>
      PARAMETER(CPOEL=CP/HVAP,ELOCP=HVAP/CP,                            &amp;<a name='667'>
     &amp;          EL2ORC=HVAP*HVAP/(RV*CP))<a name='668'>
      PARAMETER(TERR=0.,C0=.002,DELTA=fv)<a name='669'>
      PARAMETER(FACT1=(CVAP-CLIQ)/RV,FACT2=HVAP/RV-FACT1*T0C)<a name='670'>
<font color=#447700>!  LOCAL VARIABLES AND ARRAYS<a name='671'></font>
      real(kind=kind_phys) PFLD(IM,KM),    TO(IM,KM),     QO(IM,KM),    &amp;<a name='672'>
     &amp;                     UO(IM,KM),      VO(IM,KM),     QESO(IM,KM)<a name='673'>
<font color=#447700>!  cloud water<a name='674'></font>
      real(kind=kind_phys) QLKO_KTCON(IM), DELLAL(IM),    TVO(IM,KM),   &amp;<a name='675'>
     &amp;                     DBYO(IM,KM),    ZO(IM,KM),     SUMZ(IM,KM),  &amp;<a name='676'>
     &amp;                     SUMH(IM,KM),    HEO(IM,KM),    HESO(IM,KM),  &amp;<a name='677'>
     &amp;                     QRCD(IM,KM),    DELLAH(IM,KM), DELLAQ(IM,KM),&amp;<a name='678'>
     &amp;                     DELLAU(IM,KM),  DELLAV(IM,KM), HCKO(IM,KM),  &amp;<a name='679'>
     &amp;                     UCKO(IM,KM),    VCKO(IM,KM),   QCKO(IM,KM),  &amp;<a name='680'>
     &amp;                     ETA(IM,KM),     ETAU(IM,KM),   ETAD(IM,KM),  &amp;<a name='681'>
     &amp;                     QRCDO(IM,KM),   PWO(IM,KM),    PWDO(IM,KM),  &amp;<a name='682'>
     &amp;                     RHBAR(IM),      TX1(IM)<a name='683'>
<font color=#447700>!<a name='684'></font>
      LOGICAL TOTFLG, CNVFLG(IM), DWNFLG(IM), DWNFLG2(IM), FLG(IM)<a name='685'>
<font color=#447700>!<a name='686'></font>
      real(kind=kind_phys) PCRIT(15), ACRITT(15), ACRIT(15)<a name='687'>
<font color=#447700>!     SAVE PCRIT, ACRITT<a name='688'></font>
      DATA PCRIT/850.,800.,750.,700.,650.,600.,550.,500.,450.,400.,     &amp;<a name='689'>
     &amp;           350.,300.,250.,200.,150./<a name='690'>
      DATA ACRITT/.0633,.0445,.0553,.0664,.075,.1082,.1521,.2216,       &amp;<a name='691'>
     &amp;           .3151,.3677,.41,.5255,.7663,1.1686,1.6851/<a name='692'>
<font color=#447700>!  GDAS DERIVED ACRIT<a name='693'></font>
<font color=#447700>!     DATA ACRITT/.203,.515,.521,.566,.625,.665,.659,.688,              &amp; <a name='694'></font>
<font color=#447700>!    &amp;            .743,.813,.886,.947,1.138,1.377,1.896/<a name='695'></font>
<font color=#447700>!<a name='696'></font>
      real(kind=kind_phys) TF, TCR, TCRF, RZERO, RONE<a name='697'>
      parameter (TF=233.16, TCR=263.16, TCRF=1.0/(TCR-TF))<a name='698'>
      parameter (RZERO=0.0,RONE=1.0)<a name='699'>
<font color=#447700>!-----------------------------------------------------------------------<a name='700'></font>
<font color=#447700>!<a name='701'></font>
      km1 = km - 1<a name='702'>
<font color=#447700>!  INITIALIZE ARRAYS<a name='703'></font>
<font color=#447700>!<a name='704'></font>
      DO I=1,IM<a name='705'>
        RN(I)=0.<a name='706'>
        KBOT(I)=KM+1<a name='707'>
        KTOP(I)=0<a name='708'>
        KUO(I)=0<a name='709'>
        CNVFLG(I) = .TRUE.<a name='710'>
        DTCONV(I) = 3600.<a name='711'>
        CLDWRK(I) = 0.<a name='712'>
        PDOT(I) = 0.<a name='713'>
        KT2(I) = 0<a name='714'>
        QLKO_KTCON(I) = 0.<a name='715'>
        DELLAL(I) = 0.<a name='716'>
      ENDDO<a name='717'>
<font color=#447700>!!<a name='718'></font>
      DO K = 1, 15<a name='719'>
        ACRIT(K) = ACRITT(K) * (975. - PCRIT(K))<a name='720'>
      ENDDO<a name='721'>
      DT2 = DELT<a name='722'>
<font color=#447700>!cmr  dtmin = max(dt2,1200.)<a name='723'></font>
      val   =         1200.<a name='724'>
      dtmin = max(dt2, val )<a name='725'>
<font color=#447700>!cmr  dtmax = max(dt2,3600.)<a name='726'></font>
      val   =         3600.<a name='727'>
      dtmax = max(dt2, val )<a name='728'>
<font color=#447700>!  MODEL TUNABLE PARAMETERS ARE ALL HERE<a name='729'></font>
      MBDT    = 10.<a name='730'>
      EDTMAXl = .3<a name='731'>
      EDTMAXs = .3<a name='732'>
      ALPHAl  = .5<a name='733'>
      ALPHAs  = .5<a name='734'>
      BETAl   = .15<a name='735'>
      betas   = .15<a name='736'>
      BETAl   = .05<a name='737'>
      betas   = .05<a name='738'>
<font color=#447700>!     change for hurricane model<a name='739'></font>
        BETAl = .5<a name='740'>
        betas = .5<a name='741'>
<font color=#447700>!     EVEF    = 0.07<a name='742'></font>
      evfact  = 0.3<a name='743'>
      evfactl = 0.3<a name='744'>
<font color=#447700>!     change for hurricane model<a name='745'></font>
         evfact = 0.6<a name='746'>
         evfactl = .6<a name='747'>
#if ( EM_CORE == 1 )<a name='748'>
<font color=#447700>!  HAWAII TEST - ZCX<a name='749'></font>
      ALPHAl  = .5<a name='750'>
      ALPHAs  = .75<a name='751'>
      BETAl   = .05<a name='752'>
      betas   = .05<a name='753'>
      evfact  = 0.5<a name='754'>
      evfactl = 0.5<a name='755'>
#endif<a name='756'>
      PDPDWN  = 0.<a name='757'>
      PDETRN  = 200.<a name='758'>
      xlambu  = 1.e-4<a name='759'>
      fjcap   = (float(jcap) / 126.) ** 2<a name='760'>
<font color=#447700>!cmr  fjcap   = max(fjcap,1.)<a name='761'></font>
      val     =           1.<a name='762'>
      fjcap   = max(fjcap,val)<a name='763'>
      fkm     = (float(km) / 28.) ** 2<a name='764'>
<font color=#447700>!cmr  fkm     = max(fkm,1.)<a name='765'></font>
      fkm     = max(fkm,val)<a name='766'>
      W1l     = -8.E-3 <a name='767'>
      W2l     = -4.E-2<a name='768'>
      W3l     = -5.E-3 <a name='769'>
      W4l     = -5.E-4<a name='770'>
      W1s     = -2.E-4<a name='771'>
      W2s     = -2.E-3<a name='772'>
      W3s     = -1.E-3<a name='773'>
      W4s     = -2.E-5<a name='774'>
<font color=#447700>!CCCC IF(IM.EQ.384) THEN<a name='775'></font>
        LATD  = 92<a name='776'>
        lond  = 189<a name='777'>
<font color=#447700>!CCCC ELSEIF(IM.EQ.768) THEN<a name='778'></font>
<font color=#447700>!CCCC   LATD = 80<a name='779'></font>
<font color=#447700>!CCCC ELSE<a name='780'></font>
<font color=#447700>!CCCC   LATD = 0<a name='781'></font>
<font color=#447700>!CCCC ENDIF<a name='782'></font>
<font color=#447700>!<a name='783'></font>
<font color=#447700>!  DEFINE TOP LAYER FOR SEARCH OF THE DOWNDRAFT ORIGINATING LAYER<a name='784'></font>
<font color=#447700>!  AND THE MAXIMUM THETAE FOR UPDRAFT<a name='785'></font>
<font color=#447700>!<a name='786'></font>
      DO I=1,IM<a name='787'>
        KBMAX(I) = KM<a name='788'>
        KBM(I)   = KM<a name='789'>
        KMAX(I)  = KM<a name='790'>
        TX1(I)   = 1.0 / PS(I)<a name='791'>
      ENDDO<a name='792'>
<font color=#447700>!     <a name='793'></font>
      DO K = 1, KM<a name='794'>
        DO I=1,IM<a name='795'>
          IF (prSL(I,K)*tx1(I) .GT. 0.45) KBMAX(I) = K + 1<a name='796'>
          IF (prSL(I,K)*tx1(I) .GT. 0.70) KBM(I)   = K + 1<a name='797'>
          IF (prSL(I,K)*tx1(I) .GT. 0.04) KMAX(I)  = MIN(KM,K + 1)<a name='798'>
        ENDDO<a name='799'>
      ENDDO<a name='800'>
      DO I=1,IM<a name='801'>
        KBMAX(I) = MIN(KBMAX(I),KMAX(I))<a name='802'>
        KBM(I)   = MIN(KBM(I),KMAX(I))<a name='803'>
      ENDDO<a name='804'>
<font color=#447700>!<a name='805'></font>
<font color=#447700>!   CONVERT SURFACE PRESSURE TO MB FROM CB<a name='806'></font>
<font color=#447700>!<a name='807'></font>
<font color=#447700>!!<a name='808'></font>
      DO K = 1, KM<a name='809'>
        DO I=1,IM<a name='810'>
          if (K .le. kmax(i)) then<a name='811'>
            PFLD(I,k) = PRSL(I,K) * 10.0<a name='812'>
            PWO(I,k)  = 0.<a name='813'>
            PWDO(I,k) = 0.<a name='814'>
            TO(I,k)   = T1(I,k)<a name='815'>
            QO(I,k)   = Q1(I,k)<a name='816'>
            UO(I,k)   = U1(I,k)<a name='817'>
            VO(I,k)   = V1(I,k)<a name='818'>
            DBYO(I,k) = 0.<a name='819'>
            SUMZ(I,k) = 0.<a name='820'>
            SUMH(I,k) = 0.<a name='821'>
          endif<a name='822'>
        ENDDO<a name='823'>
      ENDDO<a name='824'>
<a name='825'>
<font color=#447700>!<a name='826'></font>
<font color=#447700>!  COLUMN VARIABLES<a name='827'></font>
<font color=#447700>!  P IS PRESSURE OF THE LAYER (MB)<a name='828'></font>
<font color=#447700>!  T IS TEMPERATURE AT T-DT (K)..TN<a name='829'></font>
<font color=#447700>!  Q IS MIXING RATIO AT T-DT (KG/KG)..QN<a name='830'></font>
<font color=#447700>!  TO IS TEMPERATURE AT T+DT (K)... THIS IS AFTER ADVECTION AND TURBULAN<a name='831'></font>
<font color=#447700>!  QO IS MIXING RATIO AT T+DT (KG/KG)..Q1<a name='832'></font>
<font color=#447700>!<a name='833'></font>
      DO K = 1, KM<a name='834'>
        DO I=1,IM<a name='835'>
          if (k .le. kmax(i)) then<a name='836'>
         <font color=#447700>!jfe        QESO(I,k) = 10. * FPVS(T1(I,k))<a name='837'></font>
         <font color=#447700>!<a name='838'></font>
            QESO(I,k) = 0.01 * fpvs(T1(I,K))      <font color=#447700>! fpvs is in Pa<a name='839'></font>
         <font color=#447700>!<a name='840'></font>
            QESO(I,k) = EPS * QESO(I,k) / (PFLD(I,k) + EPSM1*QESO(I,k))<a name='841'>
         <font color=#447700>!cmr        QESO(I,k) = MAX(QESO(I,k),1.E-8)<a name='842'></font>
            val1      =             1.E-8<a name='843'>
            QESO(I,k) = MAX(QESO(I,k), val1)<a name='844'>
         <font color=#447700>!cmr        QO(I,k)   = max(QO(I,k),1.e-10)<a name='845'></font>
            val2      =           1.e-10<a name='846'>
            QO(I,k)   = max(QO(I,k), val2 )<a name='847'>
         <font color=#447700>!           QO(I,k)   = MIN(QO(I,k),QESO(I,k))<a name='848'></font>
            TVO(I,k)  = TO(I,k) + DELTA * TO(I,k) * QO(I,k)<a name='849'>
          endif<a name='850'>
        ENDDO<a name='851'>
      ENDDO<a name='852'>
<a name='853'>
<font color=#447700>!<a name='854'></font>
<font color=#447700>!  HYDROSTATIC HEIGHT ASSUME ZERO TERR<a name='855'></font>
<font color=#447700>!<a name='856'></font>
      DO K = 1, KM<a name='857'>
        DO I=1,IM<a name='858'>
          ZO(I,k) = PHIL(I,k) / G<a name='859'>
        ENDDO<a name='860'>
      ENDDO<a name='861'>
<font color=#447700>!  COMPUTE MOIST STATIC ENERGY<a name='862'></font>
      DO K = 1, KM<a name='863'>
        DO I=1,IM<a name='864'>
          if (K .le. kmax(i)) then<a name='865'>
<font color=#447700>!           tem       = G * ZO(I,k) + CP * TO(I,k)<a name='866'></font>
            tem       = PHIL(I,k) + CP * TO(I,k)<a name='867'>
            HEO(I,k)  = tem  + HVAP * QO(I,k)<a name='868'>
            HESO(I,k) = tem  + HVAP * QESO(I,k)<a name='869'>
<font color=#447700>!           HEO(I,k)  = MIN(HEO(I,k),HESO(I,k))<a name='870'></font>
          endif<a name='871'>
        ENDDO<a name='872'>
      ENDDO<a name='873'>
<font color=#447700>!<a name='874'></font>
<font color=#447700>!  DETERMINE LEVEL WITH LARGEST MOIST STATIC ENERGY<a name='875'></font>
<font color=#447700>!  THIS IS THE LEVEL WHERE UPDRAFT STARTS<a name='876'></font>
<font color=#447700>!<a name='877'></font>
      DO I=1,IM<a name='878'>
        HMAX(I) = HEO(I,1)<a name='879'>
        KB(I) = 1<a name='880'>
      ENDDO<a name='881'>
<font color=#447700>!!<a name='882'></font>
      DO K = 2, KM<a name='883'>
        DO I=1,IM<a name='884'>
          if (k .le. kbm(i)) then<a name='885'>
            IF(HEO(I,k).GT.HMAX(I).AND.CNVFLG(I)) THEN<a name='886'>
              KB(I)   = K<a name='887'>
              HMAX(I) = HEO(I,k)<a name='888'>
            ENDIF<a name='889'>
          endif<a name='890'>
        ENDDO<a name='891'>
      ENDDO<a name='892'>
<font color=#447700>!     DO K = 1, KMAX - 1<a name='893'></font>
<font color=#447700>!         TOL(k) = .5 * (TO(I,k) + TO(I,k+1))<a name='894'></font>
<font color=#447700>!         QOL(k) = .5 * (QO(I,k) + QO(I,k+1))<a name='895'></font>
<font color=#447700>!         QESOL(I,k) = .5 * (QESO(I,k) + QESO(I,k+1))<a name='896'></font>
<font color=#447700>!         HEOL(I,k) = .5 * (HEO(I,k) + HEO(I,k+1))<a name='897'></font>
<font color=#447700>!         HESOL(I,k) = .5 * (HESO(I,k) + HESO(I,k+1))<a name='898'></font>
<font color=#447700>!     ENDDO<a name='899'></font>
      DO K = 1, KM1<a name='900'>
        DO I=1,IM<a name='901'>
          if (k .le. kmax(i)-1) then<a name='902'>
            DZ      = .5 * (ZO(I,k+1) - ZO(I,k))<a name='903'>
            DP      = .5 * (PFLD(I,k+1) - PFLD(I,k))<a name='904'>
<font color=#447700>!jfe        ES      = 10. * FPVS(TO(I,k+1))<a name='905'></font>
<font color=#447700>!<a name='906'></font>
            ES      = 0.01 * fpvs(TO(I,K+1))      <font color=#447700>! fpvs is in Pa<a name='907'></font>
<font color=#447700>!<a name='908'></font>
            PPRIME  = PFLD(I,k+1) + EPSM1 * ES<a name='909'>
            QS      = EPS * ES / PPRIME<a name='910'>
            DQSDP   = - QS / PPRIME<a name='911'>
            DESDT   = ES * (FACT1 / TO(I,k+1) + FACT2 / (TO(I,k+1)**2))<a name='912'>
            DQSDT   = QS * PFLD(I,k+1) * DESDT / (ES * PPRIME)<a name='913'>
            GAMMA   = EL2ORC * QESO(I,k+1) / (TO(I,k+1)**2)<a name='914'>
            DT      = (G * DZ + HVAP * DQSDP * DP) / (CP * (1. + GAMMA))<a name='915'>
            DQ      = DQSDT * DT + DQSDP * DP<a name='916'>
            TO(I,k) = TO(I,k+1) + DT<a name='917'>
            QO(I,k) = QO(I,k+1) + DQ<a name='918'>
            PO(I,k) = .5 * (PFLD(I,k) + PFLD(I,k+1))<a name='919'>
          endif<a name='920'>
        ENDDO<a name='921'>
      ENDDO<a name='922'>
<font color=#447700>!<a name='923'></font>
      DO K = 1, KM1<a name='924'>
        DO I=1,IM<a name='925'>
          if (k .le. kmax(I)-1) then<a name='926'>
<font color=#447700>!jfe        QESO(I,k) = 10. * FPVS(TO(I,k))<a name='927'></font>
<font color=#447700>!<a name='928'></font>
            QESO(I,k) = 0.01 * fpvs(TO(I,K))      <font color=#447700>! fpvs is in Pa<a name='929'></font>
<font color=#447700>!<a name='930'></font>
            QESO(I,k) = EPS * QESO(I,k) / (PO(I,k) + EPSM1*QESO(I,k))<a name='931'>
<font color=#447700>!cmr        QESO(I,k) = MAX(QESO(I,k),1.E-8)<a name='932'></font>
            val1      =             1.E-8<a name='933'>
            QESO(I,k) = MAX(QESO(I,k), val1)<a name='934'>
<font color=#447700>!cmr        QO(I,k)   = max(QO(I,k),1.e-10)<a name='935'></font>
            val2      =           1.e-10<a name='936'>
            QO(I,k)   = max(QO(I,k), val2 )<a name='937'>
<font color=#447700>!           QO(I,k)   = MIN(QO(I,k),QESO(I,k))<a name='938'></font>
            HEO(I,k)  = .5 * G * (ZO(I,k) + ZO(I,k+1)) +                &amp;<a name='939'>
     &amp;                  CP * TO(I,k) + HVAP * QO(I,k)<a name='940'>
            HESO(I,k) = .5 * G * (ZO(I,k) + ZO(I,k+1)) +                &amp; <a name='941'>
     &amp;                  CP * TO(I,k) + HVAP * QESO(I,k)<a name='942'>
            UO(I,k)   = .5 * (UO(I,k) + UO(I,k+1))<a name='943'>
            VO(I,k)   = .5 * (VO(I,k) + VO(I,k+1))<a name='944'>
          endif<a name='945'>
        ENDDO<a name='946'>
      ENDDO<a name='947'>
<font color=#447700>!     k = kmax<a name='948'></font>
<font color=#447700>!       HEO(I,k) = HEO(I,k)<a name='949'></font>
<font color=#447700>!       hesol(k) = HESO(I,k)<a name='950'></font>
<font color=#447700>!      IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I)) THEN<a name='951'></font>
<font color=#447700>!        PRINT *, '   HEO ='<a name='952'></font>
<font color=#447700>!        PRINT 6001, (HEO(I,K),K=1,KMAX)<a name='953'></font>
<font color=#447700>!        PRINT *, '   HESO ='<a name='954'></font>
<font color=#447700>!        PRINT 6001, (HESO(I,K),K=1,KMAX)<a name='955'></font>
<font color=#447700>!        PRINT *, '   TO ='<a name='956'></font>
<font color=#447700>!        PRINT 6002, (TO(I,K)-273.16,K=1,KMAX)<a name='957'></font>
<font color=#447700>!        PRINT *, '   QO ='<a name='958'></font>
<font color=#447700>!        PRINT 6003, (QO(I,K),K=1,KMAX)<a name='959'></font>
<font color=#447700>!        PRINT *, '   QSO ='<a name='960'></font>
<font color=#447700>!        PRINT 6003, (QESO(I,K),K=1,KMAX)<a name='961'></font>
<font color=#447700>!      ENDIF<a name='962'></font>
<font color=#447700>!<a name='963'></font>
<font color=#447700>!  LOOK FOR CONVECTIVE CLOUD BASE AS THE LEVEL OF FREE CONVECTION<a name='964'></font>
<font color=#447700>!<a name='965'></font>
      DO I=1,IM<a name='966'>
        IF(CNVFLG(I)) THEN<a name='967'>
          INDX    = KB(I)<a name='968'>
          HKBO(I) = HEO(I,INDX)<a name='969'>
          QKBO(I) = QO(I,INDX)<a name='970'>
          UKBO(I) = UO(I,INDX)<a name='971'>
          VKBO(I) = VO(I,INDX)<a name='972'>
        ENDIF<a name='973'>
        FLG(I)    = CNVFLG(I)<a name='974'>
        KBCON(I)  = KMAX(I)<a name='975'>
      ENDDO<a name='976'>
<font color=#447700>!!<a name='977'></font>
      DO K = 1, KM<a name='978'>
        DO I=1,IM<a name='979'>
          if (k .le. kbmax(i)) then<a name='980'>
            IF(FLG(I).AND.K.GT.KB(I)) THEN<a name='981'>
              HSBAR(I)   = HESO(I,k)<a name='982'>
              IF(HKBO(I).GT.HSBAR(I)) THEN<a name='983'>
                FLG(I)   = .FALSE.<a name='984'>
                KBCON(I) = K<a name='985'>
              ENDIF<a name='986'>
            ENDIF<a name='987'>
          endif<a name='988'>
        ENDDO<a name='989'>
      ENDDO<a name='990'>
      DO I=1,IM<a name='991'>
        IF(CNVFLG(I)) THEN<a name='992'>
          PBCDIF(I) = -PFLD(I,KBCON(I)) + PFLD(I,KB(I))<a name='993'>
          PDOT(I)   = 10.* DOT(I,KBCON(I))<a name='994'>
          IF(PBCDIF(I).GT.150.)    CNVFLG(I) = .FALSE.<a name='995'>
          IF(KBCON(I).EQ.KMAX(I))  CNVFLG(I) = .FALSE.<a name='996'>
        ENDIF<a name='997'>
      ENDDO<a name='998'>
<font color=#447700>!!<a name='999'></font>
      TOTFLG = .TRUE.<a name='1000'>
      DO I=1,IM<a name='1001'>
        TOTFLG = TOTFLG .AND. (.NOT. CNVFLG(I))<a name='1002'>
      ENDDO<a name='1003'>
      IF(TOTFLG) RETURN<a name='1004'>
<font color=#447700>!  FOUND LFC, CAN DEFINE REST OF VARIABLES<a name='1005'></font>
 6001 FORMAT(2X,-2P10F12.2)<a name='1006'>
 6002 FORMAT(2X,10F12.2)<a name='1007'>
 6003 FORMAT(2X,3P10F12.2)<a name='1008'>
<a name='1009'>
<font color=#447700>!<a name='1010'></font>
<font color=#447700>!  DETERMINE ENTRAINMENT RATE BETWEEN KB AND KBCON<a name='1011'></font>
<font color=#447700>!<a name='1012'></font>
      DO I = 1, IM<a name='1013'>
        alpha = alphas<a name='1014'>
        if(SLIMSK(I).eq.1.) alpha = alphal<a name='1015'>
        IF(CNVFLG(I)) THEN<a name='1016'>
          IF(KB(I).EQ.1) THEN<a name='1017'>
            DZ = .5 * (ZO(I,KBCON(I)) + ZO(I,KBCON(I)-1)) - ZO(I,1)<a name='1018'>
          ELSE<a name='1019'>
            DZ = .5 * (ZO(I,KBCON(I)) + ZO(I,KBCON(I)-1))               &amp;<a name='1020'>
     &amp;         - .5 * (ZO(I,KB(I)) + ZO(I,KB(I)-1))<a name='1021'>
          ENDIF<a name='1022'>
          IF(KBCON(I).NE.KB(I)) THEN<a name='1023'>
<font color=#447700>!cmr        XLAMB(I) = -ALOG(ALPHA) / DZ<a name='1024'></font>
            XLAMB(I) = - LOG(ALPHA) / DZ<a name='1025'>
          ELSE<a name='1026'>
            XLAMB(I) = 0.<a name='1027'>
          ENDIF<a name='1028'>
        ENDIF<a name='1029'>
      ENDDO<a name='1030'>
<font color=#447700>!  DETERMINE UPDRAFT MASS FLUX<a name='1031'></font>
      DO K = 1, KM<a name='1032'>
        DO I = 1, IM<a name='1033'>
          if (k .le. kmax(i) .and. CNVFLG(I)) then<a name='1034'>
            ETA(I,k)  = 1.<a name='1035'>
            ETAU(I,k) = 1.<a name='1036'>
          ENDIF<a name='1037'>
        ENDDO<a name='1038'>
      ENDDO<a name='1039'>
      DO K = KM1, 2, -1<a name='1040'>
        DO I = 1, IM<a name='1041'>
          if (k .le. kbmax(i)) then<a name='1042'>
            IF(CNVFLG(I).AND.K.LT.KBCON(I).AND.K.GE.KB(I)) THEN<a name='1043'>
              DZ        = .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1044'>
              ETA(I,k)  = ETA(I,k+1) * EXP(-XLAMB(I) * DZ)<a name='1045'>
              ETAU(I,k) = ETA(I,k)<a name='1046'>
            ENDIF<a name='1047'>
          endif<a name='1048'>
        ENDDO<a name='1049'>
      ENDDO<a name='1050'>
      DO I = 1, IM<a name='1051'>
        IF(CNVFLG(I).AND.KB(I).EQ.1.AND.KBCON(I).GT.1) THEN<a name='1052'>
          DZ = .5 * (ZO(I,2) - ZO(I,1))<a name='1053'>
          ETA(I,1) = ETA(I,2) * EXP(-XLAMB(I) * DZ)<a name='1054'>
          ETAU(I,1) = ETA(I,1)<a name='1055'>
        ENDIF<a name='1056'>
      ENDDO<a name='1057'>
<font color=#447700>!<a name='1058'></font>
<font color=#447700>!  WORK UP UPDRAFT CLOUD PROPERTIES<a name='1059'></font>
<font color=#447700>!<a name='1060'></font>
      DO I = 1, IM<a name='1061'>
        IF(CNVFLG(I)) THEN<a name='1062'>
          INDX         = KB(I)<a name='1063'>
          HCKO(I,INDX) = HKBO(I)<a name='1064'>
          QCKO(I,INDX) = QKBO(I)<a name='1065'>
          UCKO(I,INDX) = UKBO(I)<a name='1066'>
          VCKO(I,INDX) = VKBO(I)<a name='1067'>
          PWAVO(I)     = 0.<a name='1068'>
        ENDIF<a name='1069'>
      ENDDO<a name='1070'>
<font color=#447700>!<a name='1071'></font>
<font color=#447700>!  CLOUD PROPERTY BELOW CLOUD BASE IS MODIFIED BY THE ENTRAINMENT PROCES<a name='1072'></font>
<font color=#447700>!<a name='1073'></font>
      DO K = 2, KM1<a name='1074'>
        DO I = 1, IM<a name='1075'>
          if (k .le. kmax(i)-1) then<a name='1076'>
            IF(CNVFLG(I).AND.K.GT.KB(I).AND.K.LE.KBCON(I)) THEN<a name='1077'>
              FACTOR = ETA(I,k-1) / ETA(I,k)<a name='1078'>
              ONEMF = 1. - FACTOR<a name='1079'>
              HCKO(I,k) = FACTOR * HCKO(I,k-1) + ONEMF *                &amp;<a name='1080'>
     &amp;                    .5 * (HEO(I,k) + HEO(I,k+1))<a name='1081'>
              UCKO(I,k) = FACTOR * UCKO(I,k-1) + ONEMF *                &amp; <a name='1082'>
     &amp;                    .5 * (UO(I,k) + UO(I,k+1))<a name='1083'>
              VCKO(I,k) = FACTOR * VCKO(I,k-1) + ONEMF *                &amp;<a name='1084'>
     &amp;                    .5 * (VO(I,k) + VO(I,k+1))<a name='1085'>
              DBYO(I,k) = HCKO(I,k) - HESO(I,k)<a name='1086'>
            ENDIF<a name='1087'>
            IF(CNVFLG(I).AND.K.GT.KBCON(I)) THEN<a name='1088'>
              HCKO(I,k) = HCKO(I,k-1)<a name='1089'>
              UCKO(I,k) = UCKO(I,k-1)<a name='1090'>
              VCKO(I,k) = VCKO(I,k-1)<a name='1091'>
              DBYO(I,k) = HCKO(I,k) - HESO(I,k)<a name='1092'>
            ENDIF<a name='1093'>
          endif<a name='1094'>
        ENDDO<a name='1095'>
      ENDDO<a name='1096'>
<font color=#447700>!  DETERMINE CLOUD TOP<a name='1097'></font>
      DO I = 1, IM<a name='1098'>
        FLG(I) = CNVFLG(I)<a name='1099'>
        KTCON(I) = 1<a name='1100'>
      ENDDO<a name='1101'>
<font color=#447700>!     DO K = 2, KMAX<a name='1102'></font>
<font color=#447700>!       KK = KMAX - K + 1<a name='1103'></font>
<font color=#447700>!         IF(DBYO(I,kK).GE.0..AND.FLG(I).AND.KK.GT.KBCON(I)) THEN<a name='1104'></font>
<font color=#447700>!           KTCON(I) = KK + 1<a name='1105'></font>
<font color=#447700>!           FLG(I) = .FALSE.<a name='1106'></font>
<font color=#447700>!         ENDIF<a name='1107'></font>
<font color=#447700>!     ENDDO<a name='1108'></font>
      DO K = 2, KM<a name='1109'>
        DO I = 1, IM<a name='1110'>
          if (k .le. kmax(i)) then<a name='1111'>
            IF(DBYO(I,k).LT.0..AND.FLG(I).AND.K.GT.KBCON(I)) THEN<a name='1112'>
              KTCON(I) = K<a name='1113'>
              FLG(I) = .FALSE.<a name='1114'>
            ENDIF<a name='1115'>
          endif<a name='1116'>
        ENDDO<a name='1117'>
      ENDDO<a name='1118'>
      DO I = 1, IM<a name='1119'>
        IF(CNVFLG(I).AND.(PFLD(I,KBCON(I)) - PFLD(I,KTCON(I))).LT.150.) &amp;<a name='1120'>
     &amp;  CNVFLG(I) = .FALSE.<a name='1121'>
      ENDDO<a name='1122'>
      TOTFLG = .TRUE.<a name='1123'>
      DO I = 1, IM<a name='1124'>
        TOTFLG = TOTFLG .AND. (.NOT. CNVFLG(I))<a name='1125'>
      ENDDO<a name='1126'>
      IF(TOTFLG) RETURN<a name='1127'>
<font color=#447700>!<a name='1128'></font>
<font color=#447700>!  SEARCH FOR DOWNDRAFT ORIGINATING LEVEL ABOVE THETA-E MINIMUM<a name='1129'></font>
<font color=#447700>!<a name='1130'></font>
      DO I = 1, IM<a name='1131'>
        HMIN(I) = HEO(I,KBCON(I))<a name='1132'>
        LMIN(I) = KBMAX(I)<a name='1133'>
        JMIN(I) = KBMAX(I)<a name='1134'>
      ENDDO<a name='1135'>
      DO I = 1, IM<a name='1136'>
        DO K = KBCON(I), KBMAX(I)<a name='1137'>
          IF(HEO(I,k).LT.HMIN(I).AND.CNVFLG(I)) THEN<a name='1138'>
            LMIN(I) = K + 1<a name='1139'>
            HMIN(I) = HEO(I,k)<a name='1140'>
          ENDIF<a name='1141'>
        ENDDO<a name='1142'>
      ENDDO<a name='1143'>
<font color=#447700>!<a name='1144'></font>
<font color=#447700>!  Make sure that JMIN(I) is within the cloud<a name='1145'></font>
<font color=#447700>!<a name='1146'></font>
      DO I = 1, IM<a name='1147'>
        IF(CNVFLG(I)) THEN<a name='1148'>
          JMIN(I) = MIN(LMIN(I),KTCON(I)-1)<a name='1149'>
          XMBMAX(I) = .1<a name='1150'>
          JMIN(I) = MAX(JMIN(I),KBCON(I)+1)<a name='1151'>
        ENDIF<a name='1152'>
      ENDDO<a name='1153'>
<font color=#447700>!<a name='1154'></font>
<font color=#447700>!  ENTRAINING CLOUD<a name='1155'></font>
<font color=#447700>!<a name='1156'></font>
      do k = 2, km1<a name='1157'>
        DO I = 1, IM<a name='1158'>
          if (k .le. kmax(i)-1) then<a name='1159'>
            if(CNVFLG(I).and.k.gt.JMIN(I).and.k.le.KTCON(I)) THEN<a name='1160'>
              SUMZ(I,k) = SUMZ(I,k-1) + .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1161'>
              SUMH(I,k) = SUMH(I,k-1) + .5 * (ZO(I,k+1) - ZO(I,k-1))    &amp;<a name='1162'>
     &amp;                  * HEO(I,k)<a name='1163'>
            ENDIF<a name='1164'>
          endif<a name='1165'>
        enddo<a name='1166'>
      enddo<a name='1167'>
<font color=#447700>!!<a name='1168'></font>
      DO I = 1, IM<a name='1169'>
        IF(CNVFLG(I)) THEN<a name='1170'>
<font color=#447700>!         call random_number(XKT2)<a name='1171'></font>
<font color=#447700>!         call srand(fhour)<a name='1172'></font>
<font color=#447700>!         XKT2(I) = rand()<a name='1173'></font>
          KT2(I) = nint(XKT2(I)*float(KTCON(I)-JMIN(I))-.5)+JMIN(I)+1<a name='1174'>
<font color=#447700>!         KT2(I) = nint(sqrt(XKT2(I))*float(KTCON(I)-JMIN(I))-.5) + JMIN(I) + 1<a name='1175'></font>
<font color=#447700>!         KT2(I) = nint(ranf() *float(KTCON(I)-JMIN(I))-.5) + JMIN(I) + 1<a name='1176'></font>
          tem1 = (HCKO(I,JMIN(I)) - HESO(I,KT2(I)))<a name='1177'>
          tem2 = (SUMZ(I,KT2(I)) * HESO(I,KT2(I)) - SUMH(I,KT2(I)))<a name='1178'>
          if (abs(tem2) .gt. 0.000001) THEN<a name='1179'>
            XLAMB(I) = tem1 / tem2<a name='1180'>
          else<a name='1181'>
            CNVFLG(I) = .false.<a name='1182'>
          ENDIF<a name='1183'>
<font color=#447700>!         XLAMB(I) = (HCKO(I,JMIN(I)) - HESO(I,KT2(I)))<a name='1184'></font>
<font color=#447700>!    &amp;          / (SUMZ(I,KT2(I)) * HESO(I,KT2(I)) - SUMH(I,KT2(I)))<a name='1185'></font>
          XLAMB(I) = max(XLAMB(I),RZERO)<a name='1186'>
          XLAMB(I) = min(XLAMB(I),2.3/SUMZ(I,KT2(I)))<a name='1187'>
        ENDIF<a name='1188'>
      ENDDO<a name='1189'>
<font color=#447700>!!<a name='1190'></font>
      DO I = 1, IM<a name='1191'>
       DWNFLG(I)  = CNVFLG(I)<a name='1192'>
       DWNFLG2(I) = CNVFLG(I)<a name='1193'>
       IF(CNVFLG(I)) THEN<a name='1194'>
        if(KT2(I).ge.KTCON(I)) DWNFLG(I) = .false.<a name='1195'>
      if(XLAMB(I).le.1.e-30.or.HCKO(I,JMIN(I))-HESO(I,KT2(I)).le.1.e-30)&amp;<a name='1196'>
     &amp;  DWNFLG(I) = .false.<a name='1197'>
        do k = JMIN(I), KT2(I)<a name='1198'>
          if(DWNFLG(I).and.HEO(I,k).gt.HESO(I,KT2(I))) DWNFLG(I)=.false.<a name='1199'>
        enddo<a name='1200'>
<font color=#447700>!       IF(CNVFLG(I).AND.(PFLD(KBCON(I))-PFLD(KTCON(I))).GT.PDETRN)<a name='1201'></font>
<font color=#447700>!    &amp;     DWNFLG(I)=.FALSE.<a name='1202'></font>
        IF(CNVFLG(I).AND.(PFLD(I,KBCON(I))-PFLD(I,KTCON(I))).LT.PDPDWN) &amp;<a name='1203'>
     &amp;     DWNFLG2(I)=.FALSE.<a name='1204'>
       ENDIF<a name='1205'>
      ENDDO<a name='1206'>
<font color=#447700>!!<a name='1207'></font>
      DO K = 2, KM1<a name='1208'>
        DO I = 1, IM<a name='1209'>
          if (k .le. kmax(i)-1) then<a name='1210'>
            IF(DWNFLG(I).AND.K.GT.JMIN(I).AND.K.LE.KT2(I)) THEN<a name='1211'>
              DZ        = .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1212'>
<font color=#447700>!             ETA(I,k)  = ETA(I,k-1) * EXP( XLAMB(I) * DZ)<a name='1213'></font>
<font color=#447700>!  to simplify matter, we will take the linear approach here<a name='1214'></font>
<font color=#447700>!<a name='1215'></font>
              ETA(I,k)  = ETA(I,k-1) * (1. + XLAMB(I) * dz)<a name='1216'>
              ETAU(I,k) = ETAU(I,k-1) * (1. + (XLAMB(I)+xlambu) * dz)<a name='1217'>
            ENDIF<a name='1218'>
          endif<a name='1219'>
        ENDDO<a name='1220'>
      ENDDO<a name='1221'>
<font color=#447700>!!<a name='1222'></font>
      DO K = 2, KM1<a name='1223'>
        DO I = 1, IM<a name='1224'>
          if (k .le. kmax(i)-1) then<a name='1225'>
<font color=#447700>!           IF(.NOT.DWNFLG(I).AND.K.GT.JMIN(I).AND.K.LE.KT2(I)) THEN<a name='1226'></font>
            IF(.NOT.DWNFLG(I).AND.K.GT.JMIN(I).AND.K.LE.KTCON(I)) THEN<a name='1227'>
              DZ        = .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1228'>
              ETAU(I,k) = ETAU(I,k-1) * (1. + xlambu * dz)<a name='1229'>
            ENDIF<a name='1230'>
          endif<a name='1231'>
        ENDDO<a name='1232'>
      ENDDO<a name='1233'>
<font color=#447700>!      IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I)) THEN<a name='1234'></font>
<font color=#447700>!        PRINT *, ' LMIN(I), KT2(I)=', LMIN(I), KT2(I)<a name='1235'></font>
<font color=#447700>!        PRINT *, ' KBOT, KTOP, JMIN(I) =', KBCON(I), KTCON(I), JMIN(I)<a name='1236'></font>
<font color=#447700>!      ENDIF<a name='1237'></font>
<font color=#447700>!     IF(LAT.EQ.LATD.AND.lon.eq.lond) THEN<a name='1238'></font>
<font color=#447700>!       print *, ' xlamb =', xlamb<a name='1239'></font>
<font color=#447700>!       print *, ' eta =', (eta(k),k=1,KT2(I))<a name='1240'></font>
<font color=#447700>!       print *, ' ETAU =', (ETAU(I,k),k=1,KT2(I))<a name='1241'></font>
<font color=#447700>!       print *, ' HCKO =', (HCKO(I,k),k=1,KT2(I))<a name='1242'></font>
<font color=#447700>!       print *, ' SUMZ =', (SUMZ(I,k),k=1,KT2(I))<a name='1243'></font>
<font color=#447700>!       print *, ' SUMH =', (SUMH(I,k),k=1,KT2(I))<a name='1244'></font>
<font color=#447700>!     ENDIF<a name='1245'></font>
      DO I = 1, IM<a name='1246'>
        if(DWNFLG(I)) THEN<a name='1247'>
          KTCON(I) = KT2(I)<a name='1248'>
        ENDIF<a name='1249'>
      ENDDO<a name='1250'>
<font color=#447700>!<a name='1251'></font>
<font color=#447700>!  CLOUD PROPERTY ABOVE CLOUD Base IS MODIFIED BY THE DETRAINMENT PROCESS<a name='1252'></font>
<font color=#447700>!<a name='1253'></font>
      DO K = 2, KM1<a name='1254'>
        DO I = 1, IM<a name='1255'>
          if (k .le. kmax(i)-1) then<a name='1256'>
<font color=#447700>!jfe<a name='1257'></font>
            IF(CNVFLG(I).AND.K.GT.KBCON(I).AND.K.LE.KTCON(I)) THEN<a name='1258'>
<font color=#447700>!jfe      IF(K.GT.KBCON(I).AND.K.LE.KTCON(I)) THEN<a name='1259'></font>
              FACTOR    = ETA(I,k-1) / ETA(I,k)<a name='1260'>
              ONEMF     = 1. - FACTOR<a name='1261'>
              fuv       = ETAU(I,k-1) / ETAU(I,k)<a name='1262'>
              onemfu    = 1. - fuv<a name='1263'>
              HCKO(I,k) = FACTOR * HCKO(I,k-1) + ONEMF *                &amp;<a name='1264'>
     &amp;                    .5 * (HEO(I,k) + HEO(I,k+1))<a name='1265'>
              UCKO(I,k) = fuv * UCKO(I,k-1) + ONEMFu *                  &amp;<a name='1266'>
     &amp;                    .5 * (UO(I,k) + UO(I,k+1))<a name='1267'>
              VCKO(I,k) = fuv * VCKO(I,k-1) + ONEMFu *                  &amp;<a name='1268'>
     &amp;                    .5 * (VO(I,k) + VO(I,k+1))<a name='1269'>
              DBYO(I,k) = HCKO(I,k) - HESO(I,k)<a name='1270'>
            ENDIF<a name='1271'>
          endif<a name='1272'>
        ENDDO<a name='1273'>
      ENDDO<a name='1274'>
<font color=#447700>!      IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I)) THEN<a name='1275'></font>
<font color=#447700>!        PRINT *, ' UCKO=', (UCKO(I,k),k=KBCON(I)+1,KTCON(I))<a name='1276'></font>
<font color=#447700>!        PRINT *, ' uenv=', (.5*(UO(I,k)+UO(I,k-1)),k=KBCON(I)+1,KTCON(I))<a name='1277'></font>
<font color=#447700>!      ENDIF<a name='1278'></font>
      DO I = 1, IM<a name='1279'>
        if(CNVFLG(I).and.DWNFLG2(I).and.JMIN(I).le.KBCON(I))            &amp;<a name='1280'>
     &amp;     THEN<a name='1281'>
          CNVFLG(I) = .false.<a name='1282'>
          DWNFLG(I) = .false.<a name='1283'>
          DWNFLG2(I) = .false.<a name='1284'>
        ENDIF<a name='1285'>
      ENDDO<a name='1286'>
<font color=#447700>!!<a name='1287'></font>
      TOTFLG = .TRUE.<a name='1288'>
      DO I = 1, IM<a name='1289'>
        TOTFLG = TOTFLG .AND. (.NOT. CNVFLG(I))<a name='1290'>
      ENDDO<a name='1291'>
      IF(TOTFLG) RETURN<a name='1292'>
<font color=#447700>!!<a name='1293'></font>
<font color=#447700>!<a name='1294'></font>
<font color=#447700>!  COMPUTE CLOUD MOISTURE PROPERTY AND PRECIPITATION<a name='1295'></font>
<font color=#447700>!<a name='1296'></font>
      DO I = 1, IM<a name='1297'>
          AA1(I) = 0.<a name='1298'>
          RHBAR(I) = 0.<a name='1299'>
      ENDDO<a name='1300'>
      DO K = 1, KM<a name='1301'>
        DO I = 1, IM<a name='1302'>
          if (k .le. kmax(i)) then<a name='1303'>
            IF(CNVFLG(I).AND.K.GT.KB(I).AND.K.LT.KTCON(I)) THEN<a name='1304'>
              DZ = .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1305'>
              DZ1 = (ZO(I,k) - ZO(I,k-1))<a name='1306'>
              GAMMA = EL2ORC * QESO(I,k) / (TO(I,k)**2)<a name='1307'>
              QRCH = QESO(I,k)                                          &amp;<a name='1308'>
     &amp;             + GAMMA * DBYO(I,k) / (HVAP * (1. + GAMMA))<a name='1309'>
              FACTOR = ETA(I,k-1) / ETA(I,k)<a name='1310'>
              ONEMF = 1. - FACTOR<a name='1311'>
              QCKO(I,k) = FACTOR * QCKO(I,k-1) + ONEMF *                &amp;<a name='1312'>
     &amp;                    .5 * (QO(I,k) + QO(I,k+1))<a name='1313'>
              DQ = ETA(I,k) * QCKO(I,k) - ETA(I,k) * QRCH<a name='1314'>
              RHBAR(I) = RHBAR(I) + QO(I,k) / QESO(I,k)<a name='1315'>
<font color=#447700>!<a name='1316'></font>
<font color=#447700>!  BELOW LFC CHECK IF THERE IS EXCESS MOISTURE TO RELEASE LATENT HEAT<a name='1317'></font>
<font color=#447700>!<a name='1318'></font>
              IF(DQ.GT.0.) THEN<a name='1319'>
                ETAH = .5 * (ETA(I,k) + ETA(I,k-1))<a name='1320'>
                QLK = DQ / (ETA(I,k) + ETAH * C0 * DZ)<a name='1321'>
                AA1(I) = AA1(I) - DZ1 * G * QLK<a name='1322'>
                QC = QLK + QRCH<a name='1323'>
                PWO(I,k) = ETAH * C0 * DZ * QLK<a name='1324'>
                QCKO(I,k) = QC<a name='1325'>
                PWAVO(I) = PWAVO(I) + PWO(I,k)<a name='1326'>
              ENDIF<a name='1327'>
            ENDIF<a name='1328'>
          endif<a name='1329'>
        ENDDO<a name='1330'>
      ENDDO<a name='1331'>
      DO I = 1, IM<a name='1332'>
        RHBAR(I) = RHBAR(I) / float(KTCON(I) - KB(I) - 1)<a name='1333'>
      ENDDO<a name='1334'>
<font color=#447700>!<a name='1335'></font>
<font color=#447700>!  this section is ready for cloud water<a name='1336'></font>
<font color=#447700>!<a name='1337'></font>
      if(ncloud.gt.0) THEN<a name='1338'>
<font color=#447700>!<a name='1339'></font>
<font color=#447700>!  compute liquid and vapor separation at cloud top<a name='1340'></font>
<font color=#447700>!<a name='1341'></font>
      DO I = 1, IM<a name='1342'>
        k = KTCON(I)<a name='1343'>
        IF(CNVFLG(I)) THEN<a name='1344'>
          GAMMA = EL2ORC * QESO(I,K) / (TO(I,K)**2)<a name='1345'>
          QRCH = QESO(I,K)                                              &amp;<a name='1346'>
     &amp;         + GAMMA * DBYO(I,K) / (HVAP * (1. + GAMMA))<a name='1347'>
          DQ = QCKO(I,K-1) - QRCH<a name='1348'>
<font color=#447700>!<a name='1349'></font>
<font color=#447700>!  CHECK IF THERE IS EXCESS MOISTURE TO RELEASE LATENT HEAT<a name='1350'></font>
<font color=#447700>!<a name='1351'></font>
          IF(DQ.GT.0.) THEN<a name='1352'>
            QLKO_KTCON(I) = dq<a name='1353'>
            QCKO(I,K-1) = QRCH<a name='1354'>
          ENDIF<a name='1355'>
        ENDIF<a name='1356'>
      ENDDO<a name='1357'>
      ENDIF<a name='1358'>
<font color=#447700>!<a name='1359'></font>
<font color=#447700>!  CALCULATE CLOUD WORK FUNCTION AT T+DT<a name='1360'></font>
<font color=#447700>!<a name='1361'></font>
      DO K = 1, KM<a name='1362'>
        DO I = 1, IM<a name='1363'>
          if (k .le. kmax(i)) then<a name='1364'>
            IF(CNVFLG(I).AND.K.GT.KBCON(I).AND.K.LE.KTCON(I)) THEN<a name='1365'>
              DZ1 = ZO(I,k) - ZO(I,k-1)<a name='1366'>
              GAMMA = EL2ORC * QESO(I,k-1) / (TO(I,k-1)**2)<a name='1367'>
              RFACT =  1. + DELTA * CP * GAMMA                          &amp;<a name='1368'>
     &amp;                 * TO(I,k-1) / HVAP<a name='1369'>
              AA1(I) = AA1(I) +                                         &amp;<a name='1370'>
     &amp;                 DZ1 * (G / (CP * TO(I,k-1)))                     &amp;<a name='1371'>
     &amp;                 * DBYO(I,k-1) / (1. + GAMMA)                     &amp;<a name='1372'>
     &amp;                 * RFACT<a name='1373'>
              val = 0.<a name='1374'>
              AA1(I)=AA1(I)+                                            &amp;<a name='1375'>
     &amp;                 DZ1 * G * DELTA *                                &amp;<a name='1376'>
<font color=#447700>!cmr &amp;                 MAX( 0.,(QESO(I,k-1) - QO(I,k-1)))               &amp; <a name='1377'></font>
     &amp;                 MAX(val,(QESO(I,k-1) - QO(I,k-1)))<a name='1378'>
            ENDIF<a name='1379'>
          endif<a name='1380'>
        ENDDO<a name='1381'>
      ENDDO<a name='1382'>
      DO I = 1, IM<a name='1383'>
        IF(CNVFLG(I).AND.AA1(I).LE.0.) DWNFLG(I)  = .FALSE.<a name='1384'>
        IF(CNVFLG(I).AND.AA1(I).LE.0.) DWNFLG2(I) = .FALSE.<a name='1385'>
        IF(CNVFLG(I).AND.AA1(I).LE.0.) CNVFLG(I)  = .FALSE.<a name='1386'>
      ENDDO<a name='1387'>
<font color=#447700>!!<a name='1388'></font>
      TOTFLG = .TRUE.<a name='1389'>
      DO I = 1, IM<a name='1390'>
        TOTFLG = TOTFLG .AND. (.NOT. CNVFLG(I))<a name='1391'>
      ENDDO<a name='1392'>
      IF(TOTFLG) RETURN<a name='1393'>
<font color=#447700>!!<a name='1394'></font>
<font color=#447700>!cccc IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I)) THEN<a name='1395'></font>
<font color=#447700>!cccc   PRINT *, ' AA1(I) BEFORE DWNDRFT =', AA1(I)<a name='1396'></font>
<font color=#447700>!cccc ENDIF<a name='1397'></font>
<font color=#447700>!<a name='1398'></font>
<font color=#447700>!------- DOWNDRAFT CALCULATIONS<a name='1399'></font>
<font color=#447700>!<a name='1400'></font>
<font color=#447700>!<a name='1401'></font>
<font color=#447700>!--- DETERMINE DOWNDRAFT STRENGTH IN TERMS OF WINDSHEAR<a name='1402'></font>
<font color=#447700>!<a name='1403'></font>
      DO I = 1, IM<a name='1404'>
        IF(CNVFLG(I)) THEN<a name='1405'>
          VSHEAR(I) = 0.<a name='1406'>
        ENDIF<a name='1407'>
      ENDDO<a name='1408'>
      DO K = 1, KM<a name='1409'>
        DO I = 1, IM<a name='1410'>
          if (k .le. kmax(i)) then<a name='1411'>
            IF(K.GE.KB(I).AND.K.LE.KTCON(I).AND.CNVFLG(I)) THEN<a name='1412'>
              shear=rcs(I) * sqrt((UO(I,k+1)-UO(I,k)) ** 2              &amp;<a name='1413'>
     &amp;                          + (VO(I,k+1)-VO(I,k)) ** 2)<a name='1414'>
              VSHEAR(I) = VSHEAR(I) + SHEAR<a name='1415'>
            ENDIF<a name='1416'>
          endif<a name='1417'>
        ENDDO<a name='1418'>
      ENDDO<a name='1419'>
      DO I = 1, IM<a name='1420'>
        EDT(I) = 0.<a name='1421'>
        IF(CNVFLG(I)) THEN<a name='1422'>
          KNUMB = KTCON(I) - KB(I) + 1<a name='1423'>
          KNUMB = MAX(KNUMB,1)<a name='1424'>
          VSHEAR(I) = 1.E3 * VSHEAR(I) / (ZO(I,KTCON(I))-ZO(I,KB(I)))<a name='1425'>
          E1=1.591-.639*VSHEAR(I)                                       &amp;<a name='1426'>
     &amp;       +.0953*(VSHEAR(I)**2)-.00496*(VSHEAR(I)**3)<a name='1427'>
          EDT(I)=1.-E1<a name='1428'>
<font color=#447700>!cmr      EDT(I) = MIN(EDT(I),.9)<a name='1429'></font>
          val =         .9<a name='1430'>
          EDT(I) = MIN(EDT(I),val)<a name='1431'>
<font color=#447700>!cmr      EDT(I) = MAX(EDT(I),.0)<a name='1432'></font>
          val =         .0<a name='1433'>
          EDT(I) = MAX(EDT(I),val)<a name='1434'>
          EDTO(I)=EDT(I)<a name='1435'>
          EDTX(I)=EDT(I)<a name='1436'>
        ENDIF<a name='1437'>
      ENDDO<a name='1438'>
<font color=#447700>!  DETERMINE DETRAINMENT RATE BETWEEN 1 AND KBDTR<a name='1439'></font>
      DO I = 1, IM<a name='1440'>
        KBDTR(I) = KBCON(I)<a name='1441'>
        beta = betas<a name='1442'>
        if(SLIMSK(I).eq.1.) beta = betal<a name='1443'>
        IF(CNVFLG(I)) THEN<a name='1444'>
          KBDTR(I) = KBCON(I)<a name='1445'>
          KBDTR(I) = MAX(KBDTR(I),1)<a name='1446'>
          XLAMD(I) = 0.<a name='1447'>
          IF(KBDTR(I).GT.1) THEN<a name='1448'>
            DZ = .5 * ZO(I,KBDTR(I)) + .5 * ZO(I,KBDTR(I)-1)            &amp;<a name='1449'>
     &amp;         - ZO(I,1)<a name='1450'>
            XLAMD(I) =  LOG(BETA) / DZ<a name='1451'>
          ENDIF<a name='1452'>
        ENDIF<a name='1453'>
      ENDDO<a name='1454'>
<font color=#447700>!  DETERMINE DOWNDRAFT MASS FLUX<a name='1455'></font>
      DO K = 1, KM<a name='1456'>
        DO I = 1, IM<a name='1457'>
          IF(k .le. kmax(i)) then<a name='1458'>
            IF(CNVFLG(I)) THEN<a name='1459'>
              ETAD(I,k) = 1.<a name='1460'>
            ENDIF<a name='1461'>
            QRCDO(I,k) = 0.<a name='1462'>
          endif<a name='1463'>
        ENDDO<a name='1464'>
      ENDDO<a name='1465'>
      DO K = KM1, 2, -1<a name='1466'>
        DO I = 1, IM<a name='1467'>
          if (k .le. kbmax(i)) then<a name='1468'>
            IF(CNVFLG(I).AND.K.LT.KBDTR(I)) THEN<a name='1469'>
              DZ        = .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1470'>
              ETAD(I,k) = ETAD(I,k+1) * EXP(XLAMD(I) * DZ)<a name='1471'>
            ENDIF<a name='1472'>
          endif<a name='1473'>
        ENDDO<a name='1474'>
      ENDDO<a name='1475'>
      K = 1<a name='1476'>
      DO I = 1, IM<a name='1477'>
        IF(CNVFLG(I).AND.KBDTR(I).GT.1) THEN<a name='1478'>
          DZ = .5 * (ZO(I,2) - ZO(I,1))<a name='1479'>
          ETAD(I,k) = ETAD(I,k+1) * EXP(XLAMD(I) * DZ)<a name='1480'>
        ENDIF<a name='1481'>
      ENDDO<a name='1482'>
<font color=#447700>!<a name='1483'></font>
<font color=#447700>!--- DOWNDRAFT MOISTURE PROPERTIES<a name='1484'></font>
<font color=#447700>!<a name='1485'></font>
      DO I = 1, IM<a name='1486'>
        PWEVO(I) = 0.<a name='1487'>
        FLG(I) = CNVFLG(I)<a name='1488'>
      ENDDO<a name='1489'>
      DO I = 1, IM<a name='1490'>
        IF(CNVFLG(I)) THEN<a name='1491'>
          JMN = JMIN(I)<a name='1492'>
          HCDO(I) = HEO(I,JMN)<a name='1493'>
          QCDO(I) = QO(I,JMN)<a name='1494'>
          QRCDO(I,JMN) = QESO(I,JMN)<a name='1495'>
          UCDO(I) = UO(I,JMN)<a name='1496'>
          VCDO(I) = VO(I,JMN)<a name='1497'>
        ENDIF<a name='1498'>
      ENDDO<a name='1499'>
      DO K = KM1, 1, -1<a name='1500'>
        DO I = 1, IM<a name='1501'>
          if (k .le. kmax(i)-1) then<a name='1502'>
            IF(CNVFLG(I).AND.K.LT.JMIN(I)) THEN<a name='1503'>
              DQ = QESO(I,k)<a name='1504'>
              DT = TO(I,k)<a name='1505'>
              GAMMA      = EL2ORC * DQ / DT**2<a name='1506'>
              DH         = HCDO(I) - HESO(I,k)<a name='1507'>
              QRCDO(I,k) = DQ+(1./HVAP)*(GAMMA/(1.+GAMMA))*DH<a name='1508'>
              DETAD      = ETAD(I,k+1) - ETAD(I,k)<a name='1509'>
              PWDO(I,k)  = ETAD(I,k+1) * QCDO(I) -                      &amp;<a name='1510'>
     &amp;                     ETAD(I,k) * QRCDO(I,k)<a name='1511'>
              PWDO(I,k)  = PWDO(I,k) - DETAD *                          &amp;<a name='1512'>
     &amp;                    .5 * (QRCDO(I,k) + QRCDO(I,k+1))<a name='1513'>
              QCDO(I)    = QRCDO(I,k)<a name='1514'>
              PWEVO(I)   = PWEVO(I) + PWDO(I,k)<a name='1515'>
            ENDIF<a name='1516'>
          endif<a name='1517'>
        ENDDO<a name='1518'>
      ENDDO<a name='1519'>
<font color=#447700>!     IF(LAT.EQ.LATD.AND.lon.eq.lond.and.DWNFLG(I)) THEN<a name='1520'></font>
<font color=#447700>!       PRINT *, ' PWAVO(I), PWEVO(I) =', PWAVO(I), PWEVO(I)<a name='1521'></font>
<font color=#447700>!     ENDIF<a name='1522'></font>
<font color=#447700>!<a name='1523'></font>
<font color=#447700>!--- FINAL DOWNDRAFT STRENGTH DEPENDENT ON PRECIP<a name='1524'></font>
<font color=#447700>!--- EFFICIENCY (EDT), NORMALIZED CONDENSATE (PWAV), AND<a name='1525'></font>
<font color=#447700>!--- EVAPORATE (PWEV)<a name='1526'></font>
<font color=#447700>!<a name='1527'></font>
      DO I = 1, IM<a name='1528'>
        edtmax = edtmaxl<a name='1529'>
        if(SLIMSK(I).eq.0.) edtmax = edtmaxs<a name='1530'>
        IF(DWNFLG2(I)) THEN<a name='1531'>
          IF(PWEVO(I).LT.0.) THEN<a name='1532'>
            EDTO(I) = -EDTO(I) * PWAVO(I) / PWEVO(I)<a name='1533'>
            EDTO(I) = MIN(EDTO(I),EDTMAX)<a name='1534'>
          ELSE<a name='1535'>
            EDTO(I) = 0.<a name='1536'>
          ENDIF<a name='1537'>
        ELSE<a name='1538'>
          EDTO(I) = 0.<a name='1539'>
        ENDIF<a name='1540'>
      ENDDO<a name='1541'>
<font color=#447700>!<a name='1542'></font>
<font color=#447700>!<a name='1543'></font>
<font color=#447700>!--- DOWNDRAFT CLOUDWORK FUNCTIONS<a name='1544'></font>
<font color=#447700>!<a name='1545'></font>
<font color=#447700>!<a name='1546'></font>
      DO K = KM1, 1, -1<a name='1547'>
        DO I = 1, IM<a name='1548'>
          if (k .le. kmax(i)-1) then<a name='1549'>
            IF(DWNFLG2(I).AND.K.LT.JMIN(I)) THEN<a name='1550'>
              GAMMA = EL2ORC * QESO(I,k+1) / TO(I,k+1)**2<a name='1551'>
              DHH=HCDO(I)<a name='1552'>
              DT=TO(I,k+1)<a name='1553'>
              DG=GAMMA<a name='1554'>
              DH=HESO(I,k+1)<a name='1555'>
              DZ=-1.*(ZO(I,k+1)-ZO(I,k))<a name='1556'>
              AA1(I)=AA1(I)+EDTO(I)*DZ*(G/(CP*DT))*((DHH-DH)/(1.+DG))   &amp;<a name='1557'>
     &amp;               *(1.+DELTA*CP*DG*DT/HVAP)<a name='1558'>
              val=0.<a name='1559'>
              AA1(I)=AA1(I)+EDTO(I)*                                    &amp; <a name='1560'>
<font color=#447700>!cmr &amp;        DZ*G*DELTA*MAX( 0.,(QESO(I,k+1)-QO(I,k+1)))               &amp;<a name='1561'></font>
     &amp;        DZ*G*DELTA*MAX(val,(QESO(I,k+1)-QO(I,k+1)))<a name='1562'>
            ENDIF<a name='1563'>
          endif<a name='1564'>
        ENDDO<a name='1565'>
      ENDDO<a name='1566'>
<font color=#447700>!cccc IF(LAT.EQ.LATD.AND.lon.eq.lond.and.DWNFLG2(I)) THEN<a name='1567'></font>
<font color=#447700>!cccc   PRINT *, '  AA1(I) AFTER DWNDRFT =', AA1(I)<a name='1568'></font>
<font color=#447700>!cccc ENDIF<a name='1569'></font>
      DO I = 1, IM<a name='1570'>
        IF(AA1(I).LE.0.) CNVFLG(I)  = .FALSE.<a name='1571'>
        IF(AA1(I).LE.0.) DWNFLG(I)  = .FALSE.<a name='1572'>
        IF(AA1(I).LE.0.) DWNFLG2(I) = .FALSE.<a name='1573'>
      ENDDO<a name='1574'>
<font color=#447700>!!<a name='1575'></font>
      TOTFLG = .TRUE.<a name='1576'>
      DO I = 1, IM<a name='1577'>
        TOTFLG = TOTFLG .AND. (.NOT. CNVFLG(I))<a name='1578'>
      ENDDO<a name='1579'>
      IF(TOTFLG) RETURN<a name='1580'>
<font color=#447700>!!<a name='1581'></font>
<font color=#447700>!<a name='1582'></font>
<font color=#447700>!<a name='1583'></font>
<font color=#447700>!--- WHAT WOULD THE CHANGE BE, THAT A CLOUD WITH UNIT MASS<a name='1584'></font>
<font color=#447700>!--- WILL DO TO THE ENVIRONMENT?<a name='1585'></font>
<font color=#447700>!<a name='1586'></font>
      DO K = 1, KM<a name='1587'>
        DO I = 1, IM<a name='1588'>
          IF(k .le. kmax(i) .and. CNVFLG(I)) THEN<a name='1589'>
            DELLAH(I,k) = 0.<a name='1590'>
            DELLAQ(I,k) = 0.<a name='1591'>
            DELLAU(I,k) = 0.<a name='1592'>
            DELLAV(I,k) = 0.<a name='1593'>
          ENDIF<a name='1594'>
        ENDDO<a name='1595'>
      ENDDO<a name='1596'>
      DO I = 1, IM<a name='1597'>
        IF(CNVFLG(I)) THEN<a name='1598'>
          DP = 1000. * DEL(I,1)<a name='1599'>
          DELLAH(I,1) = EDTO(I) * ETAD(I,1) * (HCDO(I)                  &amp;<a name='1600'>
     &amp;                - HEO(I,1)) * G / DP<a name='1601'>
          DELLAQ(I,1) = EDTO(I) * ETAD(I,1) * (QCDO(I)                  &amp;<a name='1602'>
     &amp;                - QO(I,1)) * G / DP<a name='1603'>
          DELLAU(I,1) = EDTO(I) * ETAD(I,1) * (UCDO(I)                  &amp;<a name='1604'>
     &amp;                - UO(I,1)) * G / DP<a name='1605'>
          DELLAV(I,1) = EDTO(I) * ETAD(I,1) * (VCDO(I)                  &amp;<a name='1606'>
     &amp;                - VO(I,1)) * G / DP<a name='1607'>
        ENDIF<a name='1608'>
      ENDDO<a name='1609'>
<font color=#447700>!<a name='1610'></font>
<font color=#447700>!--- CHANGED DUE TO SUBSIDENCE AND ENTRAINMENT<a name='1611'></font>
<font color=#447700>!<a name='1612'></font>
      DO K = 2, KM1<a name='1613'>
        DO I = 1, IM<a name='1614'>
          if (k .le. kmax(i)-1) then<a name='1615'>
            IF(CNVFLG(I).AND.K.LT.KTCON(I)) THEN<a name='1616'>
              AUP = 1.<a name='1617'>
              IF(K.LE.KB(I)) AUP = 0.<a name='1618'>
              ADW = 1.<a name='1619'>
              IF(K.GT.JMIN(I)) ADW = 0.<a name='1620'>
              DV1= HEO(I,k)<a name='1621'>
              DV2 = .5 * (HEO(I,k) + HEO(I,k+1))<a name='1622'>
              DV3= HEO(I,k-1)<a name='1623'>
              DV1Q= QO(I,k)<a name='1624'>
              DV2Q = .5 * (QO(I,k) + QO(I,k+1))<a name='1625'>
              DV3Q= QO(I,k-1)<a name='1626'>
              DV1U= UO(I,k)<a name='1627'>
              DV2U = .5 * (UO(I,k) + UO(I,k+1))<a name='1628'>
              DV3U= UO(I,k-1)<a name='1629'>
              DV1V= VO(I,k)<a name='1630'>
              DV2V = .5 * (VO(I,k) + VO(I,k+1))<a name='1631'>
              DV3V= VO(I,k-1)<a name='1632'>
              DP = 1000. * DEL(I,K)<a name='1633'>
              DZ = .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1634'>
              DETA = ETA(I,k) - ETA(I,k-1)<a name='1635'>
              DETAD = ETAD(I,k) - ETAD(I,k-1)<a name='1636'>
              DELLAH(I,k) = DELLAH(I,k) +                               &amp;<a name='1637'>
     &amp;            ((AUP * ETA(I,k) - ADW * EDTO(I) * ETAD(I,k)) * DV1   &amp;<a name='1638'>
     &amp;        - (AUP * ETA(I,k-1) - ADW * EDTO(I) * ETAD(I,k-1))* DV3   &amp;<a name='1639'>
     &amp;                    - AUP * DETA * DV2                            &amp;<a name='1640'>
     &amp;                    + ADW * EDTO(I) * DETAD * HCDO(I)) * G / DP<a name='1641'>
              DELLAQ(I,k) = DELLAQ(I,k) +                               &amp;<a name='1642'>
     &amp;            ((AUP * ETA(I,k) - ADW * EDTO(I) * ETAD(I,k)) * DV1Q  &amp;<a name='1643'>
     &amp;        - (AUP * ETA(I,k-1) - ADW * EDTO(I) * ETAD(I,k-1))* DV3Q  &amp;<a name='1644'>
     &amp;                    - AUP * DETA * DV2Q                           &amp;<a name='1645'>
     &amp;       +ADW*EDTO(I)*DETAD*.5*(QRCDO(I,k)+QRCDO(I,k-1))) * G / DP<a name='1646'>
              DELLAU(I,k) = DELLAU(I,k) +                               &amp;<a name='1647'>
     &amp;            ((AUP * ETA(I,k) - ADW * EDTO(I) * ETAD(I,k)) * DV1U  &amp;<a name='1648'>
     &amp;        - (AUP * ETA(I,k-1) - ADW * EDTO(I) * ETAD(I,k-1))* DV3U  &amp;<a name='1649'>
     &amp;                     - AUP * DETA * DV2U                          &amp;<a name='1650'>
     &amp;                    + ADW * EDTO(I) * DETAD * UCDO(I)             &amp; <a name='1651'>
     &amp;                    ) * G / DP<a name='1652'>
              DELLAV(I,k) = DELLAV(I,k) +                               &amp;<a name='1653'>
     &amp;            ((AUP * ETA(I,k) - ADW * EDTO(I) * ETAD(I,k)) * DV1V  &amp;<a name='1654'>
     &amp;        - (AUP * ETA(I,k-1) - ADW * EDTO(I) * ETAD(I,k-1))* DV3V  &amp;<a name='1655'>
     &amp;                     - AUP * DETA * DV2V                          &amp;<a name='1656'>
     &amp;                    + ADW * EDTO(I) * DETAD * VCDO(I)             &amp;<a name='1657'>
     &amp;                    ) * G / DP<a name='1658'>
            ENDIF<a name='1659'>
          endif<a name='1660'>
        ENDDO<a name='1661'>
      ENDDO<a name='1662'>
<font color=#447700>!<a name='1663'></font>
<font color=#447700>!------- CLOUD TOP<a name='1664'></font>
<font color=#447700>!<a name='1665'></font>
      DO I = 1, IM<a name='1666'>
        IF(CNVFLG(I)) THEN<a name='1667'>
          INDX = KTCON(I)<a name='1668'>
          DP = 1000. * DEL(I,INDX)<a name='1669'>
          DV1 = HEO(I,INDX-1)<a name='1670'>
          DELLAH(I,INDX) = ETA(I,INDX-1) *                              &amp;<a name='1671'>
     &amp;                     (HCKO(I,INDX-1) - DV1) * G / DP<a name='1672'>
          DVQ1 = QO(I,INDX-1) <a name='1673'>
          DELLAQ(I,INDX) = ETA(I,INDX-1) *                              &amp;<a name='1674'>
     &amp;                     (QCKO(I,INDX-1) - DVQ1) * G / DP<a name='1675'>
          DV1U = UO(I,INDX-1)<a name='1676'>
          DELLAU(I,INDX) = ETA(I,INDX-1) *                              &amp;<a name='1677'>
     &amp;                     (UCKO(I,INDX-1) - DV1U) * G / DP<a name='1678'>
          DV1V = VO(I,INDX-1)<a name='1679'>
          DELLAV(I,INDX) = ETA(I,INDX-1) *                              &amp;<a name='1680'>
     &amp;                     (VCKO(I,INDX-1) - DV1V) * G / DP<a name='1681'>
<font color=#447700>!<a name='1682'></font>
<font color=#447700>!  cloud water<a name='1683'></font>
<font color=#447700>!<a name='1684'></font>
          DELLAL(I) = ETA(I,INDX-1) * QLKO_KTCON(I) * g / dp<a name='1685'>
        ENDIF<a name='1686'>
      ENDDO<a name='1687'>
<font color=#447700>!<a name='1688'></font>
<font color=#447700>!------- FINAL CHANGED VARIABLE PER UNIT MASS FLUX<a name='1689'></font>
<font color=#447700>!<a name='1690'></font>
      DO K = 1, KM<a name='1691'>
        DO I = 1, IM<a name='1692'>
          if (k .le. kmax(i)) then<a name='1693'>
            IF(CNVFLG(I).and.k.gt.KTCON(I)) THEN<a name='1694'>
              QO(I,k) = Q1(I,k)<a name='1695'>
              TO(I,k) = T1(I,k)<a name='1696'>
              UO(I,k) = U1(I,k)<a name='1697'>
              VO(I,k) = V1(I,k)<a name='1698'>
            ENDIF<a name='1699'>
            IF(CNVFLG(I).AND.K.LE.KTCON(I)) THEN<a name='1700'>
              QO(I,k) = DELLAQ(I,k) * MBDT + Q1(I,k)<a name='1701'>
              DELLAT = (DELLAH(I,k) - HVAP * DELLAQ(I,k)) / CP<a name='1702'>
              TO(I,k) = DELLAT * MBDT + T1(I,k)<a name='1703'>
<font color=#447700>!cmr          QO(I,k) = max(QO(I,k),1.e-10)<a name='1704'></font>
              val   =           1.e-10<a name='1705'>
              QO(I,k) = max(QO(I,k), val  )<a name='1706'>
            ENDIF<a name='1707'>
          endif<a name='1708'>
        ENDDO<a name='1709'>
      ENDDO<a name='1710'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1711'></font>
<font color=#447700>!<a name='1712'></font>
<font color=#447700>!--- THE ABOVE CHANGED ENVIRONMENT IS NOW USED TO CALULATE THE<a name='1713'></font>
<font color=#447700>!--- EFFECT THE ARBITRARY CLOUD (WITH UNIT MASS FLUX)<a name='1714'></font>
<font color=#447700>!--- WOULD HAVE ON THE STABILITY,<a name='1715'></font>
<font color=#447700>!--- WHICH THEN IS USED TO CALCULATE THE REAL MASS FLUX,<a name='1716'></font>
<font color=#447700>!--- NECESSARY TO KEEP THIS CHANGE IN BALANCE WITH THE LARGE-SCALE<a name='1717'></font>
<font color=#447700>!--- DESTABILIZATION.<a name='1718'></font>
<font color=#447700>!<a name='1719'></font>
<font color=#447700>!--- ENVIRONMENTAL CONDITIONS AGAIN, FIRST HEIGHTS<a name='1720'></font>
<font color=#447700>!<a name='1721'></font>
      DO K = 1, KM<a name='1722'>
        DO I = 1, IM<a name='1723'>
          IF(k .le. kmax(i) .and. CNVFLG(I)) THEN<a name='1724'>
<font color=#447700>!jfe        QESO(I,k) = 10. * FPVS(TO(I,k))<a name='1725'></font>
<font color=#447700>!<a name='1726'></font>
            QESO(I,k) = 0.01 * fpvs(TO(I,K))      <font color=#447700>! fpvs is in Pa<a name='1727'></font>
<font color=#447700>!<a name='1728'></font>
            QESO(I,k) = EPS * QESO(I,k) / (PFLD(I,k)+EPSM1*QESO(I,k))<a name='1729'>
<font color=#447700>!cmr        QESO(I,k) = MAX(QESO(I,k),1.E-8)<a name='1730'></font>
            val       =             1.E-8<a name='1731'>
            QESO(I,k) = MAX(QESO(I,k), val )<a name='1732'>
            TVO(I,k)  = TO(I,k) + DELTA * TO(I,k) * QO(I,k)<a name='1733'>
          ENDIF<a name='1734'>
        ENDDO<a name='1735'>
      ENDDO<a name='1736'>
      DO I = 1, IM<a name='1737'>
        IF(CNVFLG(I)) THEN<a name='1738'>
          XAA0(I) = 0.<a name='1739'>
          XPWAV(I) = 0.<a name='1740'>
        ENDIF<a name='1741'>
      ENDDO<a name='1742'>
<font color=#447700>!<a name='1743'></font>
<font color=#447700>!  HYDROSTATIC HEIGHT ASSUME ZERO TERR<a name='1744'></font>
<font color=#447700>!<a name='1745'></font>
<font color=#447700>!     DO I = 1, IM<a name='1746'></font>
<font color=#447700>!       IF(CNVFLG(I)) THEN<a name='1747'></font>
<font color=#447700>!         DLNSIG =  LOG(PRSL(I,1)/PS(I))<a name='1748'></font>
<font color=#447700>!         ZO(I,1) = TERR - DLNSIG * RD / G * TVO(I,1)<a name='1749'></font>
<font color=#447700>!       ENDIF<a name='1750'></font>
<font color=#447700>!     ENDDO<a name='1751'></font>
<font color=#447700>!     DO K = 2, KM<a name='1752'></font>
<font color=#447700>!       DO I = 1, IM<a name='1753'></font>
<font color=#447700>!         IF(k .le. kmax(i) .and. CNVFLG(I)) THEN<a name='1754'></font>
<font color=#447700>!           DLNSIG =  LOG(PRSL(I,K) / PRSL(I,K-1))<a name='1755'></font>
<font color=#447700>!           ZO(I,k) = ZO(I,k-1) - DLNSIG * RD / G<a name='1756'></font>
<font color=#447700>!    &amp;             * .5 * (TVO(I,k) + TVO(I,k-1))<a name='1757'></font>
<font color=#447700>!         ENDIF<a name='1758'></font>
<font color=#447700>!       ENDDO<a name='1759'></font>
<font color=#447700>!     ENDDO<a name='1760'></font>
<font color=#447700>!<a name='1761'></font>
<font color=#447700>!--- MOIST STATIC ENERGY<a name='1762'></font>
<font color=#447700>!<a name='1763'></font>
      DO K = 1, KM1<a name='1764'>
        DO I = 1, IM<a name='1765'>
          IF(k .le. kmax(i)-1 .and. CNVFLG(I)) THEN<a name='1766'>
            DZ = .5 * (ZO(I,k+1) - ZO(I,k))<a name='1767'>
            DP = .5 * (PFLD(I,k+1) - PFLD(I,k))<a name='1768'>
<font color=#447700>!jfe        ES = 10. * FPVS(TO(I,k+1))<a name='1769'></font>
<font color=#447700>!<a name='1770'></font>
            ES = 0.01 * fpvs(TO(I,K+1))      <font color=#447700>! fpvs is in Pa<a name='1771'></font>
<font color=#447700>!<a name='1772'></font>
            PPRIME = PFLD(I,k+1) + EPSM1 * ES<a name='1773'>
            QS = EPS * ES / PPRIME<a name='1774'>
            DQSDP = - QS / PPRIME<a name='1775'>
            DESDT = ES * (FACT1 / TO(I,k+1) + FACT2 / (TO(I,k+1)**2))<a name='1776'>
            DQSDT = QS * PFLD(I,k+1) * DESDT / (ES * PPRIME)<a name='1777'>
            GAMMA = EL2ORC * QESO(I,k+1) / (TO(I,k+1)**2)<a name='1778'>
            DT = (G * DZ + HVAP * DQSDP * DP) / (CP * (1. + GAMMA))<a name='1779'>
            DQ = DQSDT * DT + DQSDP * DP<a name='1780'>
            TO(I,k) = TO(I,k+1) + DT<a name='1781'>
            QO(I,k) = QO(I,k+1) + DQ<a name='1782'>
            PO(I,k) = .5 * (PFLD(I,k) + PFLD(I,k+1))<a name='1783'>
          ENDIF<a name='1784'>
        ENDDO<a name='1785'>
      ENDDO<a name='1786'>
      DO K = 1, KM1<a name='1787'>
        DO I = 1, IM<a name='1788'>
          IF(k .le. kmax(i)-1 .and. CNVFLG(I)) THEN<a name='1789'>
<font color=#447700>!jfe        QESO(I,k) = 10. * FPVS(TO(I,k))<a name='1790'></font>
<font color=#447700>!<a name='1791'></font>
            QESO(I,k) = 0.01 * fpvs(TO(I,K))      <font color=#447700>! fpvs is in Pa<a name='1792'></font>
<font color=#447700>!<a name='1793'></font>
            QESO(I,k) = EPS * QESO(I,k) / (PO(I,k) + EPSM1 * QESO(I,k))<a name='1794'>
<font color=#447700>!cmr        QESO(I,k) = MAX(QESO(I,k),1.E-8)<a name='1795'></font>
            val1      =             1.E-8<a name='1796'>
            QESO(I,k) = MAX(QESO(I,k), val1)<a name='1797'>
<font color=#447700>!cmr        QO(I,k)   = max(QO(I,k),1.e-10)<a name='1798'></font>
            val2      =           1.e-10<a name='1799'>
            QO(I,k)   = max(QO(I,k), val2 )<a name='1800'>
<font color=#447700>!           QO(I,k)   = MIN(QO(I,k),QESO(I,k))<a name='1801'></font>
            HEO(I,k)   = .5 * G * (ZO(I,k) + ZO(I,k+1)) +               &amp;<a name='1802'>
     &amp;                    CP * TO(I,k) + HVAP * QO(I,k)<a name='1803'>
            HESO(I,k) = .5 * G * (ZO(I,k) + ZO(I,k+1)) +                &amp;<a name='1804'>
     &amp;                  CP * TO(I,k) + HVAP * QESO(I,k)<a name='1805'>
          ENDIF<a name='1806'>
        ENDDO<a name='1807'>
      ENDDO<a name='1808'>
      DO I = 1, IM<a name='1809'>
        k = kmax(i)<a name='1810'>
        IF(CNVFLG(I)) THEN<a name='1811'>
          HEO(I,k) = G * ZO(I,k) + CP * TO(I,k) + HVAP * QO(I,k)<a name='1812'>
          HESO(I,k) = G * ZO(I,k) + CP * TO(I,k) + HVAP * QESO(I,k)<a name='1813'>
<font color=#447700>!         HEO(I,k) = MIN(HEO(I,k),HESO(I,k))<a name='1814'></font>
        ENDIF<a name='1815'>
      ENDDO<a name='1816'>
      DO I = 1, IM<a name='1817'>
        IF(CNVFLG(I)) THEN<a name='1818'>
          INDX = KB(I)<a name='1819'>
          XHKB(I) = HEO(I,INDX)<a name='1820'>
          XQKB(I) = QO(I,INDX)<a name='1821'>
          HCKO(I,INDX) = XHKB(I)<a name='1822'>
          QCKO(I,INDX) = XQKB(I)<a name='1823'>
        ENDIF<a name='1824'>
      ENDDO<a name='1825'>
<font color=#447700>!<a name='1826'></font>
<font color=#447700>!<a name='1827'></font>
<font color=#447700>!**************************** STATIC CONTROL<a name='1828'></font>
<font color=#447700>!<a name='1829'></font>
<font color=#447700>!<a name='1830'></font>
<font color=#447700>!------- MOISTURE AND CLOUD WORK FUNCTIONS<a name='1831'></font>
<font color=#447700>!<a name='1832'></font>
      DO K = 2, KM1<a name='1833'>
        DO I = 1, IM<a name='1834'>
          if (k .le. kmax(i)-1) then<a name='1835'>
<font color=#447700>!           IF(CNVFLG(I).AND.K.GT.KB(I).AND.K.LE.KBCON(I)) THEN<a name='1836'></font>
            IF(CNVFLG(I).AND.K.GT.KB(I).AND.K.LE.KTCON(I)) THEN<a name='1837'>
              FACTOR = ETA(I,k-1) / ETA(I,k)<a name='1838'>
              ONEMF = 1. - FACTOR<a name='1839'>
              HCKO(I,k) = FACTOR * HCKO(I,k-1) + ONEMF *                &amp;<a name='1840'>
     &amp;                    .5 * (HEO(I,k) + HEO(I,k+1))<a name='1841'>
            ENDIF<a name='1842'>
<font color=#447700>!           IF(CNVFLG(I).AND.K.GT.KBCON(I)) THEN<a name='1843'></font>
<font color=#447700>!             HEO(I,k) = HEO(I,k-1)<a name='1844'></font>
<font color=#447700>!           ENDIF<a name='1845'></font>
          endif<a name='1846'>
        ENDDO<a name='1847'>
      ENDDO<a name='1848'>
      DO K = 2, KM1<a name='1849'>
        DO I = 1, IM<a name='1850'>
          if (k .le. kmax(i)-1) then<a name='1851'>
            IF(CNVFLG(I).AND.K.GT.KB(I).AND.K.LT.KTCON(I)) THEN<a name='1852'>
              DZ = .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1853'>
              GAMMA = EL2ORC * QESO(I,k) / (TO(I,k)**2)<a name='1854'>
              XDBY = HCKO(I,k) - HESO(I,k)<a name='1855'>
<font color=#447700>!cmr          XDBY = MAX(XDBY,0.)<a name='1856'></font>
              val  =          0.<a name='1857'>
              XDBY = MAX(XDBY,val)<a name='1858'>
              XQRCH = QESO(I,k)                                         &amp;<a name='1859'>
     &amp;              + GAMMA * XDBY / (HVAP * (1. + GAMMA))<a name='1860'>
              FACTOR = ETA(I,k-1) / ETA(I,k)<a name='1861'>
              ONEMF = 1. - FACTOR<a name='1862'>
              QCKO(I,k) = FACTOR * QCKO(I,k-1) + ONEMF *                &amp;<a name='1863'>
     &amp;                    .5 * (QO(I,k) + QO(I,k+1))<a name='1864'>
              DQ = ETA(I,k) * QCKO(I,k) - ETA(I,k) * XQRCH<a name='1865'>
              IF(DQ.GT.0.) THEN<a name='1866'>
                ETAH = .5 * (ETA(I,k) + ETA(I,k-1))<a name='1867'>
                QLK = DQ / (ETA(I,k) + ETAH * C0 * DZ)<a name='1868'>
                XAA0(I) = XAA0(I) - (ZO(I,k) - ZO(I,k-1)) * G * QLK<a name='1869'>
                XQC = QLK + XQRCH<a name='1870'>
                XPW = ETAH * C0 * DZ * QLK<a name='1871'>
                QCKO(I,k) = XQC<a name='1872'>
                XPWAV(I) = XPWAV(I) + XPW<a name='1873'>
              ENDIF<a name='1874'>
            ENDIF<a name='1875'>
<font color=#447700>!           IF(CNVFLG(I).AND.K.GT.KBCON(I).AND.K.LT.KTCON(I)) THEN<a name='1876'></font>
            IF(CNVFLG(I).AND.K.GT.KBCON(I).AND.K.LE.KTCON(I)) THEN<a name='1877'>
              DZ1 = ZO(I,k) - ZO(I,k-1)<a name='1878'>
              GAMMA = EL2ORC * QESO(I,k-1) / (TO(I,k-1)**2)<a name='1879'>
              RFACT =  1. + DELTA * CP * GAMMA                          &amp;<a name='1880'>
     &amp;                 * TO(I,k-1) / HVAP<a name='1881'>
              XDBY = HCKO(I,k-1) - HESO(I,k-1)<a name='1882'>
              XAA0(I) = XAA0(I)                                         &amp; <a name='1883'>
     &amp;                + DZ1 * (G / (CP * TO(I,k-1)))                    &amp;<a name='1884'>
     &amp;                * XDBY / (1. + GAMMA)                             &amp;<a name='1885'>
     &amp;                * RFACT<a name='1886'>
              val=0.<a name='1887'>
              XAA0(I)=XAA0(I)+                                          &amp;<a name='1888'>
     &amp;                 DZ1 * G * DELTA *                                &amp;<a name='1889'>
<font color=#447700>!cmr &amp;                 MAX( 0.,(QESO(I,k-1) - QO(I,k-1)))               &amp; <a name='1890'></font>
     &amp;                 MAX(val,(QESO(I,k-1) - QO(I,k-1)))<a name='1891'>
            ENDIF<a name='1892'>
          endif<a name='1893'>
        ENDDO<a name='1894'>
      ENDDO<a name='1895'>
<font color=#447700>!cccc IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I)) THEN<a name='1896'></font>
<font color=#447700>!cccc   PRINT *, ' XAA BEFORE DWNDRFT =', XAA0(I)<a name='1897'></font>
<font color=#447700>!cccc ENDIF<a name='1898'></font>
<font color=#447700>!<a name='1899'></font>
<font color=#447700>!------- DOWNDRAFT CALCULATIONS<a name='1900'></font>
<font color=#447700>!<a name='1901'></font>
<font color=#447700>!<a name='1902'></font>
<font color=#447700>!--- DOWNDRAFT MOISTURE PROPERTIES<a name='1903'></font>
<font color=#447700>!<a name='1904'></font>
      DO I = 1, IM<a name='1905'>
        XPWEV(I) = 0.<a name='1906'>
      ENDDO<a name='1907'>
      DO I = 1, IM<a name='1908'>
        IF(DWNFLG2(I)) THEN<a name='1909'>
          JMN = JMIN(I)<a name='1910'>
          XHCD(I) = HEO(I,JMN)<a name='1911'>
          XQCD(I) = QO(I,JMN)<a name='1912'>
          QRCD(I,JMN) = QESO(I,JMN)<a name='1913'>
        ENDIF<a name='1914'>
      ENDDO<a name='1915'>
      DO K = KM1, 1, -1<a name='1916'>
        DO I = 1, IM<a name='1917'>
          if (k .le. kmax(i)-1) then<a name='1918'>
            IF(DWNFLG2(I).AND.K.LT.JMIN(I)) THEN<a name='1919'>
              DQ = QESO(I,k)<a name='1920'>
              DT = TO(I,k)<a name='1921'>
              GAMMA    = EL2ORC * DQ / DT**2<a name='1922'>
              DH       = XHCD(I) - HESO(I,k)<a name='1923'>
              QRCD(I,k)=DQ+(1./HVAP)*(GAMMA/(1.+GAMMA))*DH<a name='1924'>
              DETAD    = ETAD(I,k+1) - ETAD(I,k)<a name='1925'>
              XPWD     = ETAD(I,k+1) * QRCD(I,k+1) -                    &amp;<a name='1926'>
     &amp;                   ETAD(I,k) * QRCD(I,k)<a name='1927'>
              XPWD     = XPWD - DETAD *                                 &amp; <a name='1928'>
     &amp;                 .5 * (QRCD(I,k) + QRCD(I,k+1))<a name='1929'>
              XPWEV(I) = XPWEV(I) + XPWD<a name='1930'>
            ENDIF<a name='1931'>
          endif<a name='1932'>
        ENDDO<a name='1933'>
      ENDDO<a name='1934'>
<font color=#447700>!<a name='1935'></font>
      DO I = 1, IM<a name='1936'>
        edtmax = edtmaxl<a name='1937'>
        if(SLIMSK(I).eq.0.) edtmax = edtmaxs<a name='1938'>
        IF(DWNFLG2(I)) THEN<a name='1939'>
          IF(XPWEV(I).GE.0.) THEN<a name='1940'>
            EDTX(I) = 0.<a name='1941'>
          ELSE<a name='1942'>
            EDTX(I) = -EDTX(I) * XPWAV(I) / XPWEV(I)<a name='1943'>
            EDTX(I) = MIN(EDTX(I),EDTMAX)<a name='1944'>
          ENDIF<a name='1945'>
        ELSE<a name='1946'>
          EDTX(I) = 0.<a name='1947'>
        ENDIF<a name='1948'>
      ENDDO<a name='1949'>
<font color=#447700>!<a name='1950'></font>
<font color=#447700>!<a name='1951'></font>
<font color=#447700>!<a name='1952'></font>
<font color=#447700>!--- DOWNDRAFT CLOUDWORK FUNCTIONS<a name='1953'></font>
<font color=#447700>!<a name='1954'></font>
<font color=#447700>!<a name='1955'></font>
      DO K = KM1, 1, -1<a name='1956'>
        DO I = 1, IM<a name='1957'>
          if (k .le. kmax(i)-1) then<a name='1958'>
            IF(DWNFLG2(I).AND.K.LT.JMIN(I)) THEN<a name='1959'>
              GAMMA = EL2ORC * QESO(I,k+1) / TO(I,k+1)**2<a name='1960'>
              DHH=XHCD(I)<a name='1961'>
              DT= TO(I,k+1)<a name='1962'>
              DG= GAMMA<a name='1963'>
              DH= HESO(I,k+1)<a name='1964'>
              DZ=-1.*(ZO(I,k+1)-ZO(I,k))<a name='1965'>
              XAA0(I)=XAA0(I)+EDTX(I)*DZ*(G/(CP*DT))*((DHH-DH)/(1.+DG)) &amp;<a name='1966'>
     &amp;                *(1.+DELTA*CP*DG*DT/HVAP)<a name='1967'>
              val=0.<a name='1968'>
              XAA0(I)=XAA0(I)+EDTX(I)*                                  &amp;<a name='1969'>
<font color=#447700>!cmr &amp;        DZ*G*DELTA*MAX( 0.,(QESO(I,k+1)-QO(I,k+1)))               &amp;<a name='1970'></font>
     &amp;        DZ*G*DELTA*MAX(val,(QESO(I,k+1)-QO(I,k+1)))<a name='1971'>
            ENDIF<a name='1972'>
          endif<a name='1973'>
        ENDDO<a name='1974'>
      ENDDO<a name='1975'>
<font color=#447700>!cccc IF(LAT.EQ.LATD.AND.lon.eq.lond.and.DWNFLG2(I)) THEN<a name='1976'></font>
<font color=#447700>!cccc   PRINT *, '  XAA AFTER DWNDRFT =', XAA0(I)<a name='1977'></font>
<font color=#447700>!cccc ENDIF<a name='1978'></font>
<font color=#447700>!<a name='1979'></font>
<font color=#447700>!  CALCULATE CRITICAL CLOUD WORK FUNCTION<a name='1980'></font>
<font color=#447700>!<a name='1981'></font>
      DO I = 1, IM<a name='1982'>
        ACRT(I) = 0.<a name='1983'>
        IF(CNVFLG(I)) THEN<a name='1984'>
<font color=#447700>!       IF(CNVFLG(I).AND.SLIMSK(I).NE.1.) THEN<a name='1985'></font>
          IF(PFLD(I,KTCON(I)).LT.PCRIT(15))THEN<a name='1986'>
            ACRT(I)=ACRIT(15)*(975.-PFLD(I,KTCON(I)))                   &amp;    <a name='1987'>
     &amp;              /(975.-PCRIT(15))<a name='1988'>
          ELSE IF(PFLD(I,KTCON(I)).GT.PCRIT(1))THEN<a name='1989'>
            ACRT(I)=ACRIT(1)<a name='1990'>
          ELSE<a name='1991'>
<font color=#447700>!cmr        K = IFIX((850. - PFLD(I,KTCON(I)))/50.) + 2<a name='1992'></font>
            K =  int((850. - PFLD(I,KTCON(I)))/50.) + 2<a name='1993'>
            K = MIN(K,15)<a name='1994'>
            K = MAX(K,2)<a name='1995'>
            ACRT(I)=ACRIT(K)+(ACRIT(K-1)-ACRIT(K))*                     &amp;<a name='1996'>
     &amp;           (PFLD(I,KTCON(I))-PCRIT(K))/(PCRIT(K-1)-PCRIT(K))<a name='1997'>
           ENDIF<a name='1998'>
<font color=#447700>!        ELSE<a name='1999'></font>
<font color=#447700>!          ACRT(I) = .5 * (PFLD(I,KBCON(I)) - PFLD(I,KTCON(I)))<a name='2000'></font>
         ENDIF<a name='2001'>
      ENDDO<a name='2002'>
      DO I = 1, IM<a name='2003'>
        ACRTFCT(I) = 1.<a name='2004'>
        IF(CNVFLG(I)) THEN<a name='2005'>
          if(SLIMSK(I).eq.1.) THEN<a name='2006'>
            w1 = w1l<a name='2007'>
            w2 = w2l<a name='2008'>
            w3 = w3l<a name='2009'>
            w4 = w4l<a name='2010'>
          else<a name='2011'>
            w1 = w1s<a name='2012'>
            w2 = w2s<a name='2013'>
            w3 = w3s<a name='2014'>
            w4 = w4s<a name='2015'>
          ENDIF<a name='2016'>
<font color=#447700>!C       IF(CNVFLG(I).AND.SLIMSK(I).EQ.1.) THEN<a name='2017'></font>
<font color=#447700>!         ACRTFCT(I) = PDOT(I) / W3<a name='2018'></font>
<font color=#447700>!<a name='2019'></font>
<font color=#447700>!  modify critical cloud workfunction by cloud base vertical velocity<a name='2020'></font>
<font color=#447700>!<a name='2021'></font>
          IF(PDOT(I).LE.W4) THEN<a name='2022'>
            ACRTFCT(I) = (PDOT(I) - W4) / (W3 - W4)<a name='2023'>
          ELSEIF(PDOT(I).GE.-W4) THEN<a name='2024'>
            ACRTFCT(I) = - (PDOT(I) + W4) / (W4 - W3)<a name='2025'>
          ELSE<a name='2026'>
            ACRTFCT(I) = 0.<a name='2027'>
          ENDIF<a name='2028'>
<font color=#447700>!cmr      ACRTFCT(I) = MAX(ACRTFCT(I),-1.)<a name='2029'></font>
          val1    =             -1.<a name='2030'>
          ACRTFCT(I) = MAX(ACRTFCT(I),val1)<a name='2031'>
<font color=#447700>!cmr      ACRTFCT(I) = MIN(ACRTFCT(I),1.)<a name='2032'></font>
          val2    =             1.<a name='2033'>
          ACRTFCT(I) = MIN(ACRTFCT(I),val2)<a name='2034'>
          ACRTFCT(I) = 1. - ACRTFCT(I)<a name='2035'>
<font color=#447700>!<a name='2036'></font>
<font color=#447700>!  modify ACRTFCT(I) by colume mean rh if RHBAR(I) is greater than 80 percent<a name='2037'></font>
<font color=#447700>!<a name='2038'></font>
<font color=#447700>!         if(RHBAR(I).ge..8) THEN<a name='2039'></font>
<font color=#447700>!           ACRTFCT(I) = ACRTFCT(I) * (.9 - min(RHBAR(I),.9)) * 10.<a name='2040'></font>
<font color=#447700>!         ENDIF<a name='2041'></font>
<font color=#447700>!<a name='2042'></font>
<font color=#447700>!  modify adjustment time scale by cloud base vertical velocity<a name='2043'></font>
<font color=#447700>!<a name='2044'></font>
          DTCONV(I) = DT2 + max((1800. - DT2),RZERO) *                  &amp;<a name='2045'>
     &amp;                (PDOT(I) - W2) / (W1 - W2)<a name='2046'>
<font color=#447700>!         DTCONV(I) = MAX(DTCONV(I), DT2)<a name='2047'></font>
<font color=#447700>!         DTCONV(I) = 1800. * (PDOT(I) - w2) / (w1 - w2)<a name='2048'></font>
          DTCONV(I) = max(DTCONV(I),dtmin)<a name='2049'>
          DTCONV(I) = min(DTCONV(I),dtmax)<a name='2050'>
<a name='2051'>
        ENDIF<a name='2052'>
      ENDDO<a name='2053'>
<font color=#447700>!<a name='2054'></font>
<font color=#447700>!--- LARGE SCALE FORCING<a name='2055'></font>
<font color=#447700>!<a name='2056'></font>
      DO I= 1, IM<a name='2057'>
        FLG(I) = CNVFLG(I)<a name='2058'>
        IF(CNVFLG(I)) THEN<a name='2059'>
<font color=#447700>!         F = AA1(I) / DTCONV(I)<a name='2060'></font>
          FLD(I) = (AA1(I) - ACRT(I) * ACRTFCT(I)) / DTCONV(I)<a name='2061'>
          IF(FLD(I).LE.0.) FLG(I) = .FALSE.<a name='2062'>
        ENDIF<a name='2063'>
        CNVFLG(I) = FLG(I)<a name='2064'>
        IF(CNVFLG(I)) THEN<a name='2065'>
<font color=#447700>!         XAA0(I) = MAX(XAA0(I),0.)<a name='2066'></font>
          XK(I) = (XAA0(I) - AA1(I)) / MBDT<a name='2067'>
          IF(XK(I).GE.0.) FLG(I) = .FALSE.<a name='2068'>
        ENDIF<a name='2069'>
<font color=#447700>!<a name='2070'></font>
<font color=#447700>!--- KERNEL, CLOUD BASE MASS FLUX<a name='2071'></font>
<font color=#447700>!<a name='2072'></font>
        CNVFLG(I) = FLG(I)<a name='2073'>
        IF(CNVFLG(I)) THEN<a name='2074'>
          XMB(I) = -FLD(I) / XK(I)<a name='2075'>
          XMB(I) = MIN(XMB(I),XMBMAX(I))<a name='2076'>
        ENDIF<a name='2077'>
      ENDDO<a name='2078'>
<font color=#447700>!      IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I)) THEN<a name='2079'></font>
<font color=#447700>!        print *, ' RHBAR(I), ACRTFCT(I) =', RHBAR(I), ACRTFCT(I)<a name='2080'></font>
<font color=#447700>!        PRINT *, '  A1, XA =', AA1(I), XAA0(I)<a name='2081'></font>
<font color=#447700>!        PRINT *, ' XMB(I), ACRT =', XMB(I), ACRT<a name='2082'></font>
<font color=#447700>!      ENDIF<a name='2083'></font>
      TOTFLG = .TRUE.<a name='2084'>
      DO I = 1, IM<a name='2085'>
        TOTFLG = TOTFLG .AND. (.NOT. CNVFLG(I))<a name='2086'>
      ENDDO<a name='2087'>
      IF(TOTFLG) RETURN<a name='2088'>
<font color=#447700>!<a name='2089'></font>
<font color=#447700>!  restore t0 and QO to t1 and q1 in case convection stops<a name='2090'></font>
<font color=#447700>!<a name='2091'></font>
      do k = 1, km<a name='2092'>
        DO I = 1, IM<a name='2093'>
          if (k .le. kmax(i)) then<a name='2094'>
            TO(I,k) = T1(I,k)<a name='2095'>
            QO(I,k) = Q1(I,k)<a name='2096'>
<font color=#447700>!jfe        QESO(I,k) = 10. * FPVS(T1(I,k))<a name='2097'></font>
<font color=#447700>!<a name='2098'></font>
            QESO(I,k) = 0.01 * fpvs(T1(I,K))      <font color=#447700>! fpvs is in Pa<a name='2099'></font>
<font color=#447700>!<a name='2100'></font>
            QESO(I,k) = EPS * QESO(I,k) / (PFLD(I,k) + EPSM1*QESO(I,k))<a name='2101'>
<font color=#447700>!cmr        QESO(I,k) = MAX(QESO(I,k),1.E-8)<a name='2102'></font>
            val     =             1.E-8<a name='2103'>
            QESO(I,k) = MAX(QESO(I,k), val )<a name='2104'>
          endif<a name='2105'>
        enddo<a name='2106'>
      enddo<a name='2107'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2108'></font>
<font color=#447700>!<a name='2109'></font>
<font color=#447700>!--- FEEDBACK: SIMPLY THE CHANGES FROM THE CLOUD WITH UNIT MASS FLUX<a name='2110'></font>
<font color=#447700>!---           MULTIPLIED BY  THE MASS FLUX NECESSARY TO KEEP THE<a name='2111'></font>
<font color=#447700>!---           EQUILIBRIUM WITH THE LARGER-SCALE.<a name='2112'></font>
<font color=#447700>!<a name='2113'></font>
      DO I = 1, IM<a name='2114'>
        DELHBAR(I) = 0.<a name='2115'>
        DELQBAR(I) = 0.<a name='2116'>
        DELTBAR(I) = 0.<a name='2117'>
        QCOND(I) = 0.<a name='2118'>
      ENDDO<a name='2119'>
      DO K = 1, KM<a name='2120'>
        DO I = 1, IM<a name='2121'>
          if (k .le. kmax(i)) then<a name='2122'>
            IF(CNVFLG(I).AND.K.LE.KTCON(I)) THEN<a name='2123'>
              AUP = 1.<a name='2124'>
              IF(K.Le.KB(I)) AUP = 0.<a name='2125'>
              ADW = 1.<a name='2126'>
              IF(K.GT.JMIN(I)) ADW = 0.<a name='2127'>
              DELLAT = (DELLAH(I,k) - HVAP * DELLAQ(I,k)) / CP<a name='2128'>
              T1(I,k) = T1(I,k) + DELLAT * XMB(I) * DT2<a name='2129'>
              Q1(I,k) = Q1(I,k) + DELLAQ(I,k) * XMB(I) * DT2<a name='2130'>
              U1(I,k) = U1(I,k) + DELLAU(I,k) * XMB(I) * DT2<a name='2131'>
              V1(I,k) = V1(I,k) + DELLAV(I,k) * XMB(I) * DT2<a name='2132'>
              DP = 1000. * DEL(I,K)<a name='2133'>
              DELHBAR(I) = DELHBAR(I) + DELLAH(I,k)*XMB(I)*DP/G<a name='2134'>
              DELQBAR(I) = DELQBAR(I) + DELLAQ(I,k)*XMB(I)*DP/G<a name='2135'>
              DELTBAR(I) = DELTBAR(I) + DELLAT*XMB(I)*DP/G<a name='2136'>
            ENDIF<a name='2137'>
          endif<a name='2138'>
        ENDDO<a name='2139'>
      ENDDO<a name='2140'>
      DO K = 1, KM<a name='2141'>
        DO I = 1, IM<a name='2142'>
          if (k .le. kmax(i)) then<a name='2143'>
            IF(CNVFLG(I).AND.K.LE.KTCON(I)) THEN<a name='2144'>
<font color=#447700>!jfe          QESO(I,k) = 10. * FPVS(T1(I,k))<a name='2145'></font>
<font color=#447700>!<a name='2146'></font>
              QESO(I,k) = 0.01 * fpvs(T1(I,K))      <font color=#447700>! fpvs is in Pa<a name='2147'></font>
<font color=#447700>!<a name='2148'></font>
              QESO(I,k) = EPS * QESO(I,k)/(PFLD(I,k) + EPSM1*QESO(I,k))<a name='2149'>
<font color=#447700>!cmr          QESO(I,k) = MAX(QESO(I,k),1.E-8)<a name='2150'></font>
              val     =             1.E-8<a name='2151'>
              QESO(I,k) = MAX(QESO(I,k), val )<a name='2152'>
<font color=#447700>!<a name='2153'></font>
<font color=#447700>!  cloud water<a name='2154'></font>
<font color=#447700>!<a name='2155'></font>
              if(ncloud.gt.0.and.CNVFLG(I).and.k.eq.KTCON(I)) THEN<a name='2156'>
                tem  = DELLAL(I) * XMB(I) * dt2<a name='2157'>
                tem1 = MAX(RZERO, MIN(RONE, (TCR-t1(I,K))*TCRF))<a name='2158'>
                if (QL(I,k,2) .gt. -999.0) then<a name='2159'>
                  QL(I,k,1) = QL(I,k,1) + tem * tem1            <font color=#447700>! Ice<a name='2160'></font>
                  QL(I,k,2) = QL(I,k,2) + tem *(1.0-tem1)       <font color=#447700>! Water<a name='2161'></font>
                else<a name='2162'>
                  tem2      = QL(I,k,1) + tem<a name='2163'>
                  QL(I,k,1) = tem2 * tem1                       <font color=#447700>! Ice<a name='2164'></font>
                  QL(I,k,2) = tem2 - QL(I,k,1)                  <font color=#447700>! Water<a name='2165'></font>
                endif<a name='2166'>
<font color=#447700>!               QL(I,k) = QL(I,k) + DELLAL(I) * XMB(I) * dt2<a name='2167'></font>
                dp = 1000. * del(i,k)<a name='2168'>
                DELLAL(I) = DELLAL(I) * XMB(I) * dp / g<a name='2169'>
              ENDIF<a name='2170'>
            ENDIF<a name='2171'>
          endif<a name='2172'>
        ENDDO<a name='2173'>
      ENDDO<a name='2174'>
<font color=#447700>!     IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I) ) THEN<a name='2175'></font>
<font color=#447700>!       PRINT *, ' DELHBAR, DELQBAR, DELTBAR ='<a name='2176'></font>
<font color=#447700>!       PRINT *, DELHBAR, HVAP*DELQBAR, CP*DELTBAR<a name='2177'></font>
<font color=#447700>!       PRINT *, '   DELLBAR ='<a name='2178'></font>
<font color=#447700>!       PRINT 6003,  HVAP*DELLbar<a name='2179'></font>
<font color=#447700>!       PRINT *, '   DELLAQ ='<a name='2180'></font>
<font color=#447700>!       PRINT 6003, (HVAP*DELLAQ(I,k)*XMB(I),K=1,KMAX)<a name='2181'></font>
<font color=#447700>!       PRINT *, '   DELLAT ='<a name='2182'></font>
<font color=#447700>!       PRINT 6003, (DELLAH(i,k)*XMB(I)-HVAP*DELLAQ(I,k)*XMB(I),         &amp;<a name='2183'></font>
<font color=#447700>!    &amp;               K=1,KMAX)<a name='2184'></font>
<font color=#447700>!     ENDIF<a name='2185'></font>
      DO I = 1, IM<a name='2186'>
        RNTOT(I) = 0.<a name='2187'>
        DELQEV(I) = 0.<a name='2188'>
        DELQ2(I) = 0.<a name='2189'>
        FLG(I) = CNVFLG(I)<a name='2190'>
      ENDDO<a name='2191'>
      DO K = KM, 1, -1<a name='2192'>
        DO I = 1, IM<a name='2193'>
          if (k .le. kmax(i)) then<a name='2194'>
            IF(CNVFLG(I).AND.K.LE.KTCON(I)) THEN<a name='2195'>
              AUP = 1.<a name='2196'>
              IF(K.Le.KB(I)) AUP = 0.<a name='2197'>
              ADW = 1.<a name='2198'>
              IF(K.GT.JMIN(I)) ADW = 0.<a name='2199'>
              rain =  AUP * PWO(I,k) + ADW * EDTO(I) * PWDO(I,k)<a name='2200'>
              RNTOT(I) = RNTOT(I) + rain * XMB(I) * .001 * dt2<a name='2201'>
            ENDIF<a name='2202'>
          endif<a name='2203'>
        ENDDO<a name='2204'>
      ENDDO<a name='2205'>
      DO K = KM, 1, -1<a name='2206'>
        DO I = 1, IM<a name='2207'>
          if (k .le. kmax(i)) then<a name='2208'>
            DELTV(I) = 0.<a name='2209'>
            DELQ(I) = 0.<a name='2210'>
            QEVAP(I) = 0.<a name='2211'>
            IF(CNVFLG(I).AND.K.LE.KTCON(I)) THEN<a name='2212'>
              AUP = 1.<a name='2213'>
              IF(K.Le.KB(I)) AUP = 0.<a name='2214'>
              ADW = 1.<a name='2215'>
              IF(K.GT.JMIN(I)) ADW = 0.<a name='2216'>
              rain =  AUP * PWO(I,k) + ADW * EDTO(I) * PWDO(I,k)<a name='2217'>
              RN(I) = RN(I) + rain * XMB(I) * .001 * dt2<a name='2218'>
            ENDIF<a name='2219'>
            IF(FLG(I).AND.K.LE.KTCON(I)) THEN<a name='2220'>
              evef = EDT(I) * evfact<a name='2221'>
              if(SLIMSK(I).eq.1.) evef=EDT(I) * evfactl<a name='2222'>
<font color=#447700>!             if(SLIMSK(I).eq.1.) evef=.07<a name='2223'></font>
<font color=#447700>!             if(SLIMSK(I).ne.1.) evef = 0.<a name='2224'></font>
              QCOND(I) = EVEF * (Q1(I,k) - QESO(I,k))                   &amp;<a name='2225'>
     &amp;                 / (1. + EL2ORC * QESO(I,k) / T1(I,k)**2)<a name='2226'>
              DP = 1000. * DEL(I,K)<a name='2227'>
              IF(RN(I).GT.0..AND.QCOND(I).LT.0.) THEN<a name='2228'>
                QEVAP(I) = -QCOND(I) * (1.-EXP(-.32*SQRT(DT2*RN(I))))<a name='2229'>
                QEVAP(I) = MIN(QEVAP(I), RN(I)*1000.*G/DP)<a name='2230'>
                DELQ2(I) = DELQEV(I) + .001 * QEVAP(I) * dp / g<a name='2231'>
              ENDIF<a name='2232'>
              if(RN(I).gt.0..and.QCOND(I).LT.0..and.                    &amp;<a name='2233'>
     &amp;           DELQ2(I).gt.RNTOT(I)) THEN<a name='2234'>
                QEVAP(I) = 1000.* g * (RNTOT(I) - DELQEV(I)) / dp<a name='2235'>
                FLG(I) = .false.<a name='2236'>
              ENDIF<a name='2237'>
              IF(RN(I).GT.0..AND.QEVAP(I).gt.0.) THEN<a name='2238'>
                Q1(I,k) = Q1(I,k) + QEVAP(I)<a name='2239'>
                T1(I,k) = T1(I,k) - ELOCP * QEVAP(I)<a name='2240'>
                RN(I) = RN(I) - .001 * QEVAP(I) * DP / G<a name='2241'>
                DELTV(I) = - ELOCP*QEVAP(I)/DT2<a name='2242'>
                DELQ(I) =  + QEVAP(I)/DT2<a name='2243'>
                DELQEV(I) = DELQEV(I) + .001*dp*QEVAP(I)/g<a name='2244'>
              ENDIF<a name='2245'>
              DELLAQ(I,k) = DELLAQ(I,k) + DELQ(I) / XMB(I)<a name='2246'>
              DELQBAR(I) = DELQBAR(I) + DELQ(I)*DP/G<a name='2247'>
              DELTBAR(I) = DELTBAR(I) + DELTV(I)*DP/G<a name='2248'>
            ENDIF<a name='2249'>
          endif<a name='2250'>
        ENDDO<a name='2251'>
      ENDDO<a name='2252'>
<font color=#447700>!      IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I) ) THEN<a name='2253'></font>
<font color=#447700>!        PRINT *, '   DELLAH ='<a name='2254'></font>
<font color=#447700>!        PRINT 6003, (DELLAH(k)*XMB(I),K=1,KMAX)<a name='2255'></font>
<font color=#447700>!        PRINT *, '   DELLAQ ='<a name='2256'></font>
<font color=#447700>!        PRINT 6003, (HVAP*DELLAQ(I,k)*XMB(I),K=1,KMAX)<a name='2257'></font>
<font color=#447700>!        PRINT *, ' DELHBAR, DELQBAR, DELTBAR ='<a name='2258'></font>
<font color=#447700>!        PRINT *, DELHBAR, HVAP*DELQBAR, CP*DELTBAR<a name='2259'></font>
<font color=#447700>!        PRINT *, ' PRECIP =', HVAP*RN(I)*1000./DT2<a name='2260'></font>
<font color=#447700>!CCCC   PRINT *, '   DELLBAR ='<a name='2261'></font>
<font color=#447700>!CCCC   PRINT *,  HVAP*DELLbar<a name='2262'></font>
<font color=#447700>!      ENDIF<a name='2263'></font>
<font color=#447700>!<a name='2264'></font>
<font color=#447700>!  PRECIPITATION RATE CONVERTED TO ACTUAL PRECIP<a name='2265'></font>
<font color=#447700>!  IN UNIT OF M INSTEAD OF KG<a name='2266'></font>
<font color=#447700>!<a name='2267'></font>
      DO I = 1, IM<a name='2268'>
        IF(CNVFLG(I)) THEN<a name='2269'>
<font color=#447700>!<a name='2270'></font>
<font color=#447700>!  IN THE EVENT OF UPPER LEVEL RAIN EVAPORATION AND LOWER LEVEL DOWNDRAF<a name='2271'></font>
<font color=#447700>!    MOISTENING, RN CAN BECOME NEGATIVE, IN THIS CASE, WE BACK OUT OF TH<a name='2272'></font>
<font color=#447700>!    HEATING AND THE MOISTENING<a name='2273'></font>
<font color=#447700>!<a name='2274'></font>
          if(RN(I).lt.0..and..not.FLG(I)) RN(I) = 0.<a name='2275'>
          IF(RN(I).LE.0.) THEN<a name='2276'>
            RN(I) = 0.<a name='2277'>
          ELSE<a name='2278'>
            KTOP(I) = KTCON(I)<a name='2279'>
            KBOT(I) = KBCON(I)<a name='2280'>
            KUO(I) = 1<a name='2281'>
            CLDWRK(I) = AA1(I)<a name='2282'>
          ENDIF<a name='2283'>
        ENDIF<a name='2284'>
      ENDDO<a name='2285'>
      DO K = 1, KM<a name='2286'>
        DO I = 1, IM<a name='2287'>
          if (k .le. kmax(i)) then<a name='2288'>
            IF(CNVFLG(I).AND.RN(I).LE.0.) THEN<a name='2289'>
              T1(I,k) = TO(I,k)<a name='2290'>
              Q1(I,k) = QO(I,k)<a name='2291'>
            ENDIF<a name='2292'>
          endif<a name='2293'>
        ENDDO<a name='2294'>
      ENDDO<a name='2295'>
<font color=#447700>!!<a name='2296'></font>
      RETURN<a name='2297'>
   END SUBROUTINE SASCNV<a name='2298'>
<a name='2299'>
<font color=#447700>! ------------------------------------------------------------------------<a name='2300'></font>
<a name='2301'>
<A NAME='OLD_ARW_SHALCV'><A href='../../html_code/phys/module_cu_sas.F.html#OLD_ARW_SHALCV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2302'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>OLD_ARW_SHALCV</font>(IM,IX,KM,DT,DEL,PRSI,PRSL,PRSLK,KUO,Q,T,DPSHC) <A href='../../call_to/OLD_ARW_SHALCV.html' TARGET='index'>1</A>,<A href='../../call_from/OLD_ARW_SHALCV.html' TARGET='index'>4</A><a name='2303'>
<font color=#447700>!<a name='2304'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_cu_sas.F.html#OLD_ARW_SHALCV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_18"> , ONLY : kind_phys<a name='2305'>
      USE <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_PHYSCONS</A><A href='../../html_code/phys/module_cu_sas.F.html#OLD_ARW_SHALCV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_11">, grav =&gt; con_g, CP =&gt; con_CP, HVAP =&gt; con_HVAP &amp;<a name='2306'>
     &amp;,             RD =&gt; con_RD<a name='2307'>
<a name='2308'>
      implicit none<a name='2309'>
<font color=#447700>!<a name='2310'></font>
<font color=#447700>!     include 'constant.h'<a name='2311'></font>
<font color=#447700>!<a name='2312'></font>
      integer              IM, IX, KM, KUO(IM)<a name='2313'>
      real(kind=kind_phys) DEL(IX,KM),   PRSI(IX,KM+1), PRSL(IX,KM),    &amp;<a name='2314'>
     &amp;                     PRSLK(IX,KM),                                &amp;<a name='2315'>
     &amp;                     Q(IX,KM),     T(IX,KM),      DT, DPSHC<a name='2316'>
<font color=#447700>!<a name='2317'></font>
<font color=#447700>!     Locals<a name='2318'></font>
<font color=#447700>!<a name='2319'></font>
      real(kind=kind_phys) ck,    cpdt,   dmse,   dsdz1, dsdz2,         &amp;<a name='2320'>
     &amp;                     dsig,  dtodsl, dtodsu, eldq,  g,             &amp;<a name='2321'>
     &amp;                     gocp,  rtdls<a name='2322'>
<font color=#447700>!<a name='2323'></font>
      integer              k,k1,k2,kliftl,kliftu,kt,N2,I,iku,ik1,ik,ii<a name='2324'>
      integer              INDEX2(IM), KLCL(IM), KBOT(IM), KTOP(IM),kk  &amp;<a name='2325'>
     &amp;,                    KTOPM(IM)<a name='2326'>
<font color=#447700>!!<a name='2327'></font>
<font color=#447700>!  PHYSICAL PARAMETERS<a name='2328'></font>
      PARAMETER(G=GRAV, GOCP=G/CP)<a name='2329'>
<font color=#447700>!  BOUNDS OF PARCEL ORIGIN<a name='2330'></font>
      PARAMETER(KLIFTL=2,KLIFTU=2)<a name='2331'>
      LOGICAL   LSHC(IM)<a name='2332'>
      real(kind=kind_phys) Q2(IM*KM),     T2(IM*KM),                    &amp;<a name='2333'>
     &amp;                     PRSL2(IM*KM),  PRSLK2(IM*KM),                &amp;<a name='2334'>
     &amp;                     AL(IM*(KM-1)), AD(IM*KM), AU(IM*(KM-1))<a name='2335'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2336'></font>
<font color=#447700>!  COMPRESS FIELDS TO POINTS WITH NO DEEP CONVECTION<a name='2337'></font>
<font color=#447700>!  AND MOIST STATIC INSTABILITY.<a name='2338'></font>
      DO I=1,IM<a name='2339'>
        LSHC(I)=.FALSE.<a name='2340'>
      ENDDO<a name='2341'>
      DO K=1,KM-1<a name='2342'>
        DO I=1,IM<a name='2343'>
          IF(KUO(I).EQ.0) THEN<a name='2344'>
            ELDQ    = HVAP*(Q(I,K)-Q(I,K+1))<a name='2345'>
            CPDT    = CP*(T(I,K)-T(I,K+1))<a name='2346'>
            RTDLS   = (PRSL(I,K)-PRSL(I,K+1)) /                         &amp;<a name='2347'>
     &amp;                 PRSI(I,K+1)*RD*0.5*(T(I,K)+T(I,K+1))<a name='2348'>
            DMSE    = ELDQ+CPDT-RTDLS<a name='2349'>
            LSHC(I) = LSHC(I).OR.DMSE.GT.0.<a name='2350'>
          ENDIF<a name='2351'>
        ENDDO<a name='2352'>
      ENDDO<a name='2353'>
      N2 = 0<a name='2354'>
      DO I=1,IM<a name='2355'>
        IF(LSHC(I)) THEN<a name='2356'>
          N2         = N2 + 1<a name='2357'>
          INDEX2(N2) = I<a name='2358'>
        ENDIF<a name='2359'>
      ENDDO<a name='2360'>
      IF(N2.EQ.0) RETURN<a name='2361'>
      DO K=1,KM<a name='2362'>
        KK = (K-1)*N2<a name='2363'>
        DO I=1,N2<a name='2364'>
          IK         = KK + I<a name='2365'>
          ii         = index2(i)<a name='2366'>
          Q2(IK)     = Q(II,K)<a name='2367'>
          T2(IK)     = T(II,K)<a name='2368'>
          PRSL2(IK)  = PRSL(II,K)<a name='2369'>
          PRSLK2(IK) = PRSLK(II,K)<a name='2370'>
        ENDDO<a name='2371'>
      ENDDO<a name='2372'>
      do i=1,N2<a name='2373'>
        ktopm(i) = KM<a name='2374'>
      enddo<a name='2375'>
      do k=2,KM<a name='2376'>
        do i=1,N2<a name='2377'>
          ii = index2(i)<a name='2378'>
          if (prsi(ii,1)-prsi(ii,k) .le. dpshc) ktopm(i) = k<a name='2379'>
        enddo<a name='2380'>
      enddo<a name='2381'>
<a name='2382'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2383'></font>
<font color=#447700>!  COMPUTE MOIST ADIABAT AND DETERMINE LIMITS OF SHALLOW CONVECTION.<a name='2384'></font>
<font color=#447700>!  CHECK FOR MOIST STATIC INSTABILITY AGAIN WITHIN CLOUD.<a name='2385'></font>
      CALL <A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3'>MSTADBT3</A><A href='../../html_code/phys/module_cu_sas.F.html#OLD_ARW_SHALCV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MSTADBT3_2">(N2,KM-1,KLIFTL,KLIFTU,PRSL2,PRSLK2,T2,Q2,           &amp;<a name='2386'>
     &amp;            KLCL,KBOT,KTOP,AL,AU)<a name='2387'>
      DO I=1,N2<a name='2388'>
        KBOT(I) = min(KLCL(I)-1, ktopm(i)-1)<a name='2389'>
        KTOP(I) = min(KTOP(I)+1, ktopm(i))<a name='2390'>
        LSHC(I) = .FALSE.<a name='2391'>
      ENDDO<a name='2392'>
      DO K=1,KM-1<a name='2393'>
        KK = (K-1)*N2<a name='2394'>
        DO I=1,N2<a name='2395'>
          IF(K.GE.KBOT(I).AND.K.LT.KTOP(I)) THEN<a name='2396'>
            IK      = KK + I<a name='2397'>
            IKU     = IK + N2<a name='2398'>
            ELDQ    = HVAP * (Q2(IK)-Q2(IKU))<a name='2399'>
            CPDT    = CP   * (T2(IK)-T2(IKU))<a name='2400'>
            RTDLS   = (PRSL2(IK)-PRSL2(IKU)) /                          &amp;<a name='2401'>
     &amp;                 PRSI(index2(i),K+1)*RD*0.5*(T2(IK)+T2(IKU))<a name='2402'>
            DMSE    = ELDQ + CPDT - RTDLS<a name='2403'>
            LSHC(I) = LSHC(I).OR.DMSE.GT.0.<a name='2404'>
            AU(IK)  = G/RTDLS<a name='2405'>
          ENDIF<a name='2406'>
        ENDDO<a name='2407'>
      ENDDO<a name='2408'>
      K1=KM+1<a name='2409'>
      K2=0<a name='2410'>
      DO I=1,N2<a name='2411'>
        IF(.NOT.LSHC(I)) THEN<a name='2412'>
          KBOT(I) = KM+1<a name='2413'>
          KTOP(I) = 0<a name='2414'>
        ENDIF<a name='2415'>
        K1 = MIN(K1,KBOT(I))<a name='2416'>
        K2 = MAX(K2,KTOP(I))<a name='2417'>
      ENDDO<a name='2418'>
      KT = K2-K1+1<a name='2419'>
      IF(KT.LT.2) RETURN<a name='2420'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2421'></font>
<font color=#447700>!  SET EDDY VISCOSITY COEFFICIENT CKU AT SIGMA INTERFACES.<a name='2422'></font>
<font color=#447700>!  COMPUTE DIAGONALS AND RHS FOR TRIDIAGONAL MATRIX SOLVER.<a name='2423'></font>
<font color=#447700>!  EXPAND FINAL FIELDS.<a name='2424'></font>
      KK = (K1-1) * N2<a name='2425'>
      DO I=1,N2<a name='2426'>
        IK     = KK + I<a name='2427'>
        AD(IK) = 1.<a name='2428'>
      ENDDO<a name='2429'>
<font color=#447700>!<a name='2430'></font>
<font color=#447700>!     DTODSU=DT/DEL(K1)<a name='2431'></font>
      DO K=K1,K2-1<a name='2432'>
<font color=#447700>!       DTODSL=DTODSU<a name='2433'></font>
<font color=#447700>!       DTODSU=   DT/DEL(K+1)<a name='2434'></font>
<font color=#447700>!       DSIG=SL(K)-SL(K+1)<a name='2435'></font>
        KK = (K-1) * N2<a name='2436'>
        DO I=1,N2<a name='2437'>
          ii     = index2(i)<a name='2438'>
          DTODSL = DT/DEL(II,K)<a name='2439'>
          DTODSU = DT/DEL(II,K+1)<a name='2440'>
          DSIG   = PRSL(II,K) - PRSL(II,K+1)<a name='2441'>
          IK     = KK + I<a name='2442'>
          IKU    = IK + N2<a name='2443'>
          IF(K.EQ.KBOT(I)) THEN<a name='2444'>
            CK=1.5<a name='2445'>
          ELSEIF(K.EQ.KTOP(I)-1) THEN<a name='2446'>
            CK=1.<a name='2447'>
          ELSEIF(K.EQ.KTOP(I)-2) THEN<a name='2448'>
            CK=3.<a name='2449'>
          ELSEIF(K.GT.KBOT(I).AND.K.LT.KTOP(I)-2) THEN<a name='2450'>
            CK=5.<a name='2451'>
          ELSE<a name='2452'>
            CK=0.<a name='2453'>
          ENDIF<a name='2454'>
          DSDZ1   = CK*DSIG*AU(IK)*GOCP<a name='2455'>
          DSDZ2   = CK*DSIG*AU(IK)*AU(IK)<a name='2456'>
          AU(IK)  = -DTODSL*DSDZ2<a name='2457'>
          AL(IK)  = -DTODSU*DSDZ2<a name='2458'>
          AD(IK)  = AD(IK)-AU(IK)<a name='2459'>
          AD(IKU) = 1.-AL(IK)<a name='2460'>
          T2(IK)  = T2(IK)+DTODSL*DSDZ1<a name='2461'>
          T2(IKU) = T2(IKU)-DTODSU*DSDZ1<a name='2462'>
        ENDDO<a name='2463'>
      ENDDO<a name='2464'>
      IK1=(K1-1)*N2+1<a name='2465'>
      CALL <A href='../../html_code/phys/module_cu_sas.F.html#TRIDI2T3'>TRIDI2T3</A><A href='../../html_code/phys/module_cu_sas.F.html#OLD_ARW_SHALCV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDI2T3_2">(N2,KT,AL(IK1),AD(IK1),AU(IK1),Q2(IK1),T2(IK1),      &amp;<a name='2466'>
     &amp;                                  AU(IK1),Q2(IK1),T2(IK1))<a name='2467'>
      DO K=K1,K2<a name='2468'>
        KK = (K-1)*N2<a name='2469'>
        DO I=1,N2<a name='2470'>
          IK = KK + I<a name='2471'>
          Q(INDEX2(I),K) = Q2(IK)<a name='2472'>
          T(INDEX2(I),K) = T2(IK)<a name='2473'>
        ENDDO<a name='2474'>
      ENDDO<a name='2475'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2476'></font>
      RETURN<a name='2477'>
      END SUBROUTINE OLD_ARW_SHALCV<a name='2478'>
<a name='2479'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2480'></font>
<A NAME='TRIDI2T3'><A href='../../html_code/phys/module_cu_sas.F.html#TRIDI2T3' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2481'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TRIDI2T3</font>(L,N,CL,CM,CU,R1,R2,AU,A1,A2) <A href='../../call_to/TRIDI2T3.html' TARGET='index'>2</A>,<A href='../../call_from/TRIDI2T3.html' TARGET='index'>2</A><a name='2482'>
<font color=#447700>!yt      INCLUDE DBTRIDI2;<a name='2483'></font>
<font color=#447700>!!<a name='2484'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_cu_sas.F.html#TRIDI2T3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_19"> , ONLY : kind_phys<a name='2485'>
      implicit none<a name='2486'>
      integer             k,n,l,i<a name='2487'>
      real(kind=kind_phys) fk<a name='2488'>
<font color=#447700>!!<a name='2489'></font>
      real(kind=kind_phys)                                              &amp;<a name='2490'>
     &amp;          CL(L,2:N),CM(L,N),CU(L,N-1),R1(L,N),R2(L,N),            &amp;<a name='2491'>
     &amp;          AU(L,N-1),A1(L,N),A2(L,N)<a name='2492'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2493'></font>
      DO I=1,L<a name='2494'>
        FK=1./CM(I,1)<a name='2495'>
        AU(I,1)=FK*CU(I,1)<a name='2496'>
        A1(I,1)=FK*R1(I,1)<a name='2497'>
        A2(I,1)=FK*R2(I,1)<a name='2498'>
      ENDDO<a name='2499'>
      DO K=2,N-1<a name='2500'>
        DO I=1,L<a name='2501'>
          FK=1./(CM(I,K)-CL(I,K)*AU(I,K-1))<a name='2502'>
          AU(I,K)=FK*CU(I,K)<a name='2503'>
          A1(I,K)=FK*(R1(I,K)-CL(I,K)*A1(I,K-1))<a name='2504'>
          A2(I,K)=FK*(R2(I,K)-CL(I,K)*A2(I,K-1))<a name='2505'>
        ENDDO<a name='2506'>
      ENDDO<a name='2507'>
      DO I=1,L<a name='2508'>
        FK=1./(CM(I,N)-CL(I,N)*AU(I,N-1))<a name='2509'>
        A1(I,N)=FK*(R1(I,N)-CL(I,N)*A1(I,N-1))<a name='2510'>
        A2(I,N)=FK*(R2(I,N)-CL(I,N)*A2(I,N-1))<a name='2511'>
      ENDDO<a name='2512'>
      DO K=N-1,1,-1<a name='2513'>
        DO I=1,L<a name='2514'>
          A1(I,K)=A1(I,K)-AU(I,K)*A1(I,K+1)<a name='2515'>
          A2(I,K)=A2(I,K)-AU(I,K)*A2(I,K+1)<a name='2516'>
        ENDDO<a name='2517'>
      ENDDO<a name='2518'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2519'></font>
      RETURN<a name='2520'>
      END SUBROUTINE TRIDI2T3<a name='2521'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2522'></font>
<a name='2523'>
<A NAME='MSTADBT3'><A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2524'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>MSTADBT3</font>(IM,KM,K1,K2,PRSL,PRSLK,TENV,QENV,             &amp; <A href='../../call_to/MSTADBT3.html' TARGET='index'>2</A>,<A href='../../call_from/MSTADBT3.html' TARGET='index'>12</A><a name='2525'>
     &amp;                  KLCL,KBOT,KTOP,TCLD,QCLD)<a name='2526'>
<font color=#447700>!yt      INCLUDE DBMSTADB;<a name='2527'></font>
<font color=#447700>!!<a name='2528'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_20">, ONLY : kind_phys<a name='2529'>
      USE <A href='../../html_code/phys/module_gfs_funcphys.F.html#MODULE_GFS_FUNCPHYS'>MODULE_GFS_FUNCPHYS</A><A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_FUNCPHYS_6">, ONLY : FTDP, FTHE, FTLCL, STMA<a name='2530'>
      USE <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_PHYSCONS</A><A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_12">, EPS =&gt; con_eps, EPSM1 =&gt; con_epsm1, FV =&gt; con_FVirt<a name='2531'>
<a name='2532'>
      implicit none<a name='2533'>
<font color=#447700>!!<a name='2534'></font>
<font color=#447700>!     include 'constant.h'<a name='2535'></font>
<font color=#447700>!!<a name='2536'></font>
      integer              k,k1,k2,km,i,im<a name='2537'>
      real(kind=kind_phys) pv,qma,slklcl,tdpd,thelcl,tlcl<a name='2538'>
      real(kind=kind_phys) tma,tvcld,tvenv<a name='2539'>
<font color=#447700>!!<a name='2540'></font>
      real(kind=kind_phys) PRSL(IM,KM), PRSLK(IM,KM), TENV(IM,KM),      &amp;<a name='2541'>
     &amp;                     QENV(IM,KM), TCLD(IM,KM),  QCLD(IM,KM)<a name='2542'>
      INTEGER              KLCL(IM),    KBOT(IM),      KTOP(IM)<a name='2543'>
<font color=#447700>!  LOCAL ARRAYS<a name='2544'></font>
      real(kind=kind_phys) SLKMA(IM), THEMA(IM)<a name='2545'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2546'></font>
<font color=#447700>!  DETERMINE WARMEST POTENTIAL WET-BULB TEMPERATURE BETWEEN K1 AND K2.<a name='2547'></font>
<font color=#447700>!  COMPUTE ITS LIFTING CONDENSATION LEVEL.<a name='2548'></font>
<font color=#447700>!<a name='2549'></font>
      DO I=1,IM<a name='2550'>
        SLKMA(I) = 0.<a name='2551'>
        THEMA(I) = 0.<a name='2552'>
      ENDDO<a name='2553'>
      DO K=K1,K2<a name='2554'>
        DO I=1,IM<a name='2555'>
          PV   = 1000.0 * PRSL(I,K)*QENV(I,K)/(EPS-EPSM1*QENV(I,K))<a name='2556'>
          TDPD = TENV(I,K)-FTDP(PV)<a name='2557'>
          IF(TDPD.GT.0.) THEN<a name='2558'>
            TLCL   = <A href='../../html_code/phys/module_shcu_grims.F.html#FTLCL'>FTLCL</A><A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FTLCL_2">(TENV(I,K),TDPD)<a name='2559'>
            SLKLCL = PRSLK(I,K)*TLCL/TENV(I,K)<a name='2560'>
          ELSE<a name='2561'>
            TLCL   = TENV(I,K)<a name='2562'>
            SLKLCL = PRSLK(I,K)<a name='2563'>
          ENDIF<a name='2564'>
          THELCL=<A href='../../html_code/phys/module_shcu_grims.F.html#FTHE'>FTHE</A><A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FTHE_2">(TLCL,SLKLCL)<a name='2565'>
          IF(THELCL.GT.THEMA(I)) THEN<a name='2566'>
            SLKMA(I) = SLKLCL<a name='2567'>
            THEMA(I) = THELCL<a name='2568'>
          ENDIF<a name='2569'>
        ENDDO<a name='2570'>
      ENDDO<a name='2571'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2572'></font>
<font color=#447700>!  SET CLOUD TEMPERATURES AND HUMIDITIES WHEREVER THE PARCEL LIFTED UP<a name='2573'></font>
<font color=#447700>!  THE MOIST ADIABAT IS BUOYANT WITH RESPECT TO THE ENVIRONMENT.<a name='2574'></font>
      DO I=1,IM<a name='2575'>
        KLCL(I)=KM+1<a name='2576'>
        KBOT(I)=KM+1<a name='2577'>
        KTOP(I)=0<a name='2578'>
      ENDDO<a name='2579'>
      DO K=1,KM<a name='2580'>
        DO I=1,IM<a name='2581'>
          TCLD(I,K)=0.<a name='2582'>
          QCLD(I,K)=0.<a name='2583'>
        ENDDO<a name='2584'>
      ENDDO<a name='2585'>
      DO K=K1,KM<a name='2586'>
        DO I=1,IM<a name='2587'>
          IF(PRSLK(I,K).LE.SLKMA(I)) THEN<a name='2588'>
            KLCL(I)=MIN(KLCL(I),K)<a name='2589'>
            CALL <A href='../../html_code/phys/module_gfs_funcphys.F.html#STMA'>STMA</A><A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STMA_2">(THEMA(I),PRSLK(I,K),TMA,QMA)<a name='2590'>
<font color=#447700>!           TMA=FTMA(THEMA(I),PRSLK(I,K),QMA)<a name='2591'></font>
            TVCLD=TMA*(1.+FV*QMA)<a name='2592'>
            TVENV=TENV(I,K)*(1.+FV*QENV(I,K))<a name='2593'>
            IF(TVCLD.GT.TVENV) THEN<a name='2594'>
              KBOT(I)=MIN(KBOT(I),K)<a name='2595'>
              KTOP(I)=MAX(KTOP(I),K)<a name='2596'>
              TCLD(I,K)=TMA-TENV(I,K)<a name='2597'>
              QCLD(I,K)=QMA-QENV(I,K)<a name='2598'>
            ENDIF<a name='2599'>
          ENDIF<a name='2600'>
        ENDDO<a name='2601'>
      ENDDO<a name='2602'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2603'></font>
      RETURN<a name='2604'>
      END SUBROUTINE MSTADBT3<a name='2605'>
<a name='2606'>
<A NAME='SASCNVN'><A href='../../html_code/phys/module_cu_sas.F.html#SASCNVN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2607'>
      <font color=#993300>subroutine </font><font color=#cc0000>sascnvn</font>(im,ix,km,jcap,delt,del,prsl,ps,phil,ql,   &amp;  <A href='../../call_to/SASCNVN.html' TARGET='index'>1</A>,<A href='../../call_from/SASCNVN.html' TARGET='index'>3</A><a name='2608'>
     &amp;     q1,t1,u1,v1,rcs,cldwrk,rn,kbot,ktop,kcnv,slimsk,        &amp;<a name='2609'>
     &amp;     dot,ncloud,pgcon,sas_mass_flux,                         &amp;<a name='2610'>
     &amp;     pert_sas, ens_random_seed, ens_sasamp)                         <a name='2611'>
<font color=#447700>!     &amp;     dot,ncloud,ud_mf,dd_mf,dt_mf)                         <a name='2612'></font>
<font color=#447700>!    &amp;     dot,ncloud,ud_mf,dd_mf,dt_mf,me)<a name='2613'></font>
<font color=#447700>!<a name='2614'></font>
<font color=#447700>!      use machine , only : kind_phys<a name='2615'></font>
<font color=#447700>!      use funcphys , only : fpvs<a name='2616'></font>
<font color=#447700>!      use physcons, grav =&gt; con_g, cp =&gt; con_cp, hvap =&gt; con_hvap  &amp;<a name='2617'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_cu_sas.F.html#SASCNVN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_21">, ONLY : kind_phys<a name='2618'>
      USE <A href='../../html_code/phys/module_gfs_funcphys.F.html#MODULE_GFS_FUNCPHYS'>MODULE_GFS_FUNCPHYS</A><A href='../../html_code/phys/module_cu_sas.F.html#SASCNVN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_FUNCPHYS_7">, ONLY : fpvs<a name='2619'>
      USE <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_PHYSCONS</A><A href='../../html_code/phys/module_cu_sas.F.html#SASCNVN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_13">, grav =&gt; con_g, cp =&gt; con_cp         &amp;<a name='2620'>
     &amp;,             hvap =&gt; con_hvap                               &amp;<a name='2621'>
     &amp;,             rv =&gt; con_rv, fv =&gt; con_fvirt, t0c =&gt; con_t0c  &amp;<a name='2622'>
     &amp;,             cvap =&gt; con_cvap, cliq =&gt; con_cliq             &amp;<a name='2623'>
     &amp;,             eps =&gt; con_eps, epsm1 =&gt; con_epsm1<a name='2624'>
      implicit none<a name='2625'>
<font color=#447700>!<a name='2626'></font>
      integer            im, ix,  km, jcap, ncloud,                &amp;<a name='2627'>
     &amp;                   kbot(im), ktop(im), kcnv(im) <a name='2628'>
<font color=#447700>!    &amp;,                  me<a name='2629'></font>
      real(kind=kind_phys) delt,sas_mass_flux<a name='2630'>
      real(kind=kind_phys) ps(im),     del(ix,km),  prsl(ix,km),   &amp;<a name='2631'>
     &amp;                     ql(ix,km,2),q1(ix,km),   t1(ix,km),     &amp;<a name='2632'>
     &amp;                     u1(ix,km),  v1(ix,km),   rcs(im),       &amp;<a name='2633'>
     &amp;                     cldwrk(im), rn(im),      slimsk(im),    &amp;<a name='2634'>
     &amp;                     dot(ix,km), phil(ix,km)<a name='2635'>
<font color=#447700>! hchuang code change mass flux output<a name='2636'></font>
<font color=#447700>!     &amp;,                    ud_mf(im,km),dd_mf(im,km),dt_mf(im,km)<a name='2637'></font>
<font color=#447700>!<a name='2638'></font>
      integer              i, j, indx, jmn, k, kk, latd, lond, km1<a name='2639'>
<font color=#447700>!<a name='2640'></font>
      real(kind=kind_phys) clam, cxlamu, xlamde, xlamdd<a name='2641'>
<font color=#447700>! <a name='2642'></font>
      real(kind=kind_phys) adw,     aup,     aafac,                &amp;<a name='2643'>
     &amp;                     beta,    betal,   betas,                &amp;<a name='2644'>
     &amp;                     c0,      cpoel,   dellat,  delta,       &amp;<a name='2645'>
     &amp;                     desdt,   deta,    detad,   dg,          &amp;<a name='2646'>
     &amp;                     dh,      dhh,     dlnsig,  dp,          &amp;<a name='2647'>
     &amp;                     dq,      dqsdp,   dqsdt,   dt,          &amp;<a name='2648'>
     &amp;                     dt2,     dtmax,   dtmin,   dv1h,        &amp;<a name='2649'>
     &amp;                     dv1q,    dv2h,    dv2q,    dv1u,        &amp;<a name='2650'>
     &amp;                     dv1v,    dv2u,    dv2v,    dv3q,        &amp;<a name='2651'>
     &amp;                     dv3h,    dv3u,    dv3v,                 &amp;<a name='2652'>
     &amp;                     dz,      dz1,     e1,      edtmax,      &amp;<a name='2653'>
     &amp;                     edtmaxl, edtmaxs, el2orc,  elocp,       &amp;<a name='2654'>
     &amp;                     es,      etah,    cthk,    dthk,        &amp;<a name='2655'>
     &amp;                     evef,    evfact,  evfactl, fact1,       &amp;<a name='2656'>
     &amp;                     fact2,   factor,  fjcap,   fkm,         &amp;<a name='2657'>
     &amp;                     g,       gamma,   pprime,               &amp;<a name='2658'>
     &amp;                     qlk,     qrch,    qs,      c1,          &amp;<a name='2659'>
     &amp;                     rain,    rfact,   shear,   tem1,        &amp;<a name='2660'>
     &amp;                     tem2,    terr,    val,     val1,        &amp;<a name='2661'>
     &amp;                     val2,    w1,      w1l,     w1s,         &amp;<a name='2662'>
     &amp;                     w2,      w2l,     w2s,     w3,          &amp;<a name='2663'>
     &amp;                     w3l,     w3s,     w4,      w4l,         &amp;<a name='2664'>
     &amp;                     w4s,     xdby,    xpw,     xpwd,        &amp;<a name='2665'>
     &amp;                     xqrch,   mbdt,    tem,                  &amp;<a name='2666'>
     &amp;                     ptem,    ptem1<a name='2667'>
<font color=#447700>!<a name='2668'></font>
      real(kind=kind_phys), intent(in) :: pgcon<a name='2669'>
      logical,intent(in)  :: pert_sas<a name='2670'>
      integer,intent(in)  :: ens_random_seed<a name='2671'>
      real,intent(in)     :: ens_sasamp<a name='2672'>
<a name='2673'>
      integer              kb(im), kbcon(im), kbcon1(im),          &amp;<a name='2674'>
     &amp;                     ktcon(im), ktcon1(im),                  &amp;<a name='2675'>
     &amp;                     jmin(im), lmin(im), kbmax(im),          &amp;<a name='2676'>
     &amp;                     kbm(im), kmax(im)<a name='2677'>
<font color=#447700>!<a name='2678'></font>
      real(kind=kind_phys) aa1(im),     acrt(im),   acrtfct(im),   &amp;<a name='2679'>
     &amp;                     delhbar(im), delq(im),   delq2(im),     &amp;<a name='2680'>
     &amp;                     delqbar(im), delqev(im), deltbar(im),   &amp;<a name='2681'>
     &amp;                     deltv(im),   dtconv(im), edt(im),       &amp;<a name='2682'>
     &amp;                     edto(im),    edtx(im),   fld(im),       &amp;<a name='2683'>
     &amp;                     hcdo(im,km), hmax(im),   hmin(im),      &amp;<a name='2684'>
     &amp;                     ucdo(im,km), vcdo(im,km),aa2(im),       &amp;<a name='2685'>
     &amp;                     pbcdif(im),  pdot(im),   po(im,km),     &amp;<a name='2686'>
     &amp;                     pwavo(im),   pwevo(im),  xlamud(im),    &amp;<a name='2687'>
     &amp;                     qcdo(im,km), qcond(im),  qevap(im),     &amp;<a name='2688'>
     &amp;                     rntot(im),   vshear(im), xaa0(im),      &amp;<a name='2689'>
     &amp;                     xk(im),      xlamd(im),                 &amp;<a name='2690'>
     &amp;                     xmb(im),     xmbmax(im), xpwav(im),     &amp;<a name='2691'>
     &amp;                     xpwev(im),   delubar(im),delvbar(im)<a name='2692'>
<font color=#447700>!cj<a name='2693'></font>
      real(kind=kind_phys) cincr, cincrmax, cincrmin<a name='2694'>
      real(kind=kind_phys) xmbmx1<a name='2695'>
<font color=#447700>!cj<a name='2696'></font>
<font color=#447700>!c  physical parameters<a name='2697'></font>
      parameter(g=grav)<a name='2698'>
      parameter(cpoel=cp/hvap,elocp=hvap/cp,                       &amp;<a name='2699'>
     &amp;          el2orc=hvap*hvap/(rv*cp))<a name='2700'>
      parameter(terr=0.,c0=.002,c1=.002,delta=fv)<a name='2701'>
      parameter(fact1=(cvap-cliq)/rv,fact2=hvap/rv-fact1*t0c)<a name='2702'>
      parameter(cthk=150.,cincrmax=180.,cincrmin=120.,dthk=25.)<a name='2703'>
<font color=#447700>!c  local variables and arrays<a name='2704'></font>
      real(kind=kind_phys) pfld(im,km),to(im,km), qo(im,km),       &amp;<a name='2705'>
     &amp;                     uo(im,km),  vo(im,km), qeso(im,km)<a name='2706'>
<font color=#447700>!c  cloud water<a name='2707'></font>
      real(kind=kind_phys)qlko_ktcon(im),dellal(im,km),tvo(im,km), &amp;<a name='2708'>
     &amp;                dbyo(im,km), zo(im,km),    xlamue(im,km),    &amp;<a name='2709'>
     &amp;                fent1(im,km),fent2(im,km), frh(im,km),       &amp;<a name='2710'>
     &amp;                heo(im,km),  heso(im,km),                    &amp;<a name='2711'>
     &amp;                qrcd(im,km), dellah(im,km), dellaq(im,km),   &amp;<a name='2712'>
     &amp;                dellau(im,km),dellav(im,km), hcko(im,km),    &amp;<a name='2713'>
     &amp;                ucko(im,km), vcko(im,km),   qcko(im,km),     &amp;<a name='2714'>
     &amp;                eta(im,km),  etad(im,km),   zi(im,km),       &amp;<a name='2715'>
     &amp;                qrcdo(im,km),pwo(im,km),    pwdo(im,km),     &amp;<a name='2716'>
     &amp;                tx1(im),     sumx(im)<a name='2717'>
<font color=#447700>!    &amp;,               rhbar(im)<a name='2718'></font>
<font color=#447700>!<a name='2719'></font>
      logical totflg, cnvflg(im), flg(im)<a name='2720'>
<font color=#447700>!<a name='2721'></font>
      real(kind=kind_phys) pcrit(15), acritt(15), acrit(15)<a name='2722'>
<font color=#447700>!     save pcrit, acritt<a name='2723'></font>
      data pcrit/850.,800.,750.,700.,650.,600.,550.,500.,450.,400.,&amp;<a name='2724'>
     &amp;           350.,300.,250.,200.,150./<a name='2725'>
      data acritt/.0633,.0445,.0553,.0664,.075,.1082,.1521,.2216,  &amp;<a name='2726'>
     &amp;           .3151,.3677,.41,.5255,.7663,1.1686,1.6851/<a name='2727'>
<font color=#447700>!c  gdas derived acrit<a name='2728'></font>
<font color=#447700>!c     data acritt/.203,.515,.521,.566,.625,.665,.659,.688,<a name='2729'></font>
<font color=#447700>!c    &amp;            .743,.813,.886,.947,1.138,1.377,1.896/<a name='2730'></font>
      real(kind=kind_phys) tf, tcr, tcrf<a name='2731'>
      parameter (tf=233.16, tcr=263.16, tcrf=1.0/(tcr-tf))<a name='2732'>
#if HWRF==1<a name='2733'>
      real*8 :: gasdev,ran1          <font color=#447700>!zhang<a name='2734'></font>
      real :: rr                     <font color=#447700>!zhang<a name='2735'></font>
      logical,save :: pert_sas_local            <font color=#447700>!zhang<a name='2736'></font>
      integer,save :: ens_random_seed_local         <font color=#447700>!zhang<a name='2737'></font>
      real,save :: ens_sasamp_local         <font color=#447700>!zhang<a name='2738'></font>
      data ens_random_seed_local/0/<a name='2739'>
      if ( ens_random_seed_local .eq. 0 ) then<a name='2740'>
         ens_random_seed_local=ens_random_seed<a name='2741'>
         pert_sas_local=pert_sas<a name='2742'>
         ens_sasamp_local=ens_sasamp<a name='2743'>
      endif<a name='2744'>
#endif<a name='2745'>
<font color=#447700>!<a name='2746'></font>
<font color=#447700>!c-----------------------------------------------------------------------<a name='2747'></font>
<font color=#447700>!<a name='2748'></font>
<a name='2749'>
      km1 = km - 1<a name='2750'>
<font color=#447700>!c<a name='2751'></font>
<font color=#447700>!c  initialize arrays<a name='2752'></font>
<font color=#447700>!c<a name='2753'></font>
      do i=1,im<a name='2754'>
        kcnv(i)=0<a name='2755'>
        cnvflg(i) = .true.<a name='2756'>
        rn(i)=0.<a name='2757'>
        kbot(i)=km+1<a name='2758'>
        ktop(i)=0<a name='2759'>
        kbcon(i)=km<a name='2760'>
        ktcon(i)=1<a name='2761'>
        dtconv(i) = 3600.<a name='2762'>
        cldwrk(i) = 0.<a name='2763'>
        pdot(i) = 0.<a name='2764'>
        pbcdif(i)= 0.<a name='2765'>
        lmin(i) = 1<a name='2766'>
        jmin(i) = 1<a name='2767'>
        qlko_ktcon(i) = 0.<a name='2768'>
        edt(i)  = 0.<a name='2769'>
        edto(i) = 0.<a name='2770'>
        edtx(i) = 0.<a name='2771'>
        acrt(i) = 0.<a name='2772'>
        acrtfct(i) = 1.<a name='2773'>
        aa1(i)  = 0.<a name='2774'>
        aa2(i)  = 0.<a name='2775'>
        xaa0(i) = 0.<a name='2776'>
        pwavo(i)= 0.<a name='2777'>
        pwevo(i)= 0.<a name='2778'>
        xpwav(i)= 0.<a name='2779'>
        xpwev(i)= 0.<a name='2780'>
        vshear(i) = 0.<a name='2781'>
      enddo<a name='2782'>
<font color=#447700>! hchuang code change<a name='2783'></font>
<font color=#447700>!      do k = 1, km<a name='2784'></font>
<font color=#447700>!        do i = 1, im<a name='2785'></font>
<font color=#447700>!          ud_mf(i,k) = 0.<a name='2786'></font>
<font color=#447700>!          dd_mf(i,k) = 0.<a name='2787'></font>
<font color=#447700>!          dt_mf(i,k) = 0.<a name='2788'></font>
<font color=#447700>!        enddo<a name='2789'></font>
<font color=#447700>!      enddo<a name='2790'></font>
<font color=#447700>!c<a name='2791'></font>
      do k = 1, 15<a name='2792'>
        acrit(k) = acritt(k) * (975. - pcrit(k))<a name='2793'>
      enddo<a name='2794'>
      dt2 = delt<a name='2795'>
      val   =         1200.<a name='2796'>
      dtmin = max(dt2, val )<a name='2797'>
      val   =         3600.<a name='2798'>
      dtmax = max(dt2, val )<a name='2799'>
<font color=#447700>!c  model tunable parameters are all here<a name='2800'></font>
      mbdt    = 10.<a name='2801'>
      edtmaxl = .3<a name='2802'>
      edtmaxs = .3<a name='2803'>
      clam    = .1<a name='2804'>
      aafac   = .1<a name='2805'>
<font color=#447700>!     betal   = .15<a name='2806'></font>
<font color=#447700>!     betas   = .15<a name='2807'></font>
      betal   = .05<a name='2808'>
      betas   = .05<a name='2809'>
<font color=#447700>!c     evef    = 0.07<a name='2810'></font>
      evfact  = 0.3<a name='2811'>
      evfactl = 0.3<a name='2812'>
#if ( EM_CORE == 1 )<a name='2813'>
<font color=#447700>!  HAWAII TEST - ZCX<a name='2814'></font>
      BETAl   = .05<a name='2815'>
      betas   = .05<a name='2816'>
      evfact  = 0.5<a name='2817'>
      evfactl = 0.5<a name='2818'>
#endif<a name='2819'>
<font color=#447700>!<a name='2820'></font>
      cxlamu  = 1.0e-4<a name='2821'>
      xlamde  = 1.0e-4<a name='2822'>
      xlamdd  = 1.0e-4<a name='2823'>
<font color=#447700>!<a name='2824'></font>
      fjcap   = (float(jcap) / 126.) ** 2<a name='2825'>
      val     =           1.<a name='2826'>
      fjcap   = max(fjcap,val)<a name='2827'>
      fkm     = (float(km) / 28.) ** 2<a name='2828'>
      fkm     = max(fkm,val)<a name='2829'>
      w1l     = -8.e-3 <a name='2830'>
      w2l     = -4.e-2<a name='2831'>
      w3l     = -5.e-3 <a name='2832'>
      w4l     = -5.e-4<a name='2833'>
      w1s     = -2.e-4<a name='2834'>
      w2s     = -2.e-3<a name='2835'>
      w3s     = -1.e-3<a name='2836'>
      w4s     = -2.e-5<a name='2837'>
<font color=#447700>!c<a name='2838'></font>
<font color=#447700>!c  define top layer for search of the downdraft originating layer<a name='2839'></font>
<font color=#447700>!c  and the maximum thetae for updraft<a name='2840'></font>
<font color=#447700>!c<a name='2841'></font>
      do i=1,im<a name='2842'>
        kbmax(i) = km<a name='2843'>
        kbm(i)   = km<a name='2844'>
        kmax(i)  = km<a name='2845'>
        tx1(i)   = 1.0 / ps(i)<a name='2846'>
      enddo<a name='2847'>
<font color=#447700>!     <a name='2848'></font>
      do k = 1, km<a name='2849'>
        do i=1,im<a name='2850'>
          IF (prSL(I,K)*tx1(I) .GT. 0.04) KMAX(I)  = MIN(KM,K + 1)<a name='2851'>
<font color=#447700>!2011bugfix          if (prsl(i,k)*tx1(i) .gt. 0.04) kmax(i)  = k + 1<a name='2852'></font>
          if (prsl(i,k)*tx1(i) .gt. 0.45) kbmax(i) = k + 1<a name='2853'>
          if (prsl(i,k)*tx1(i) .gt. 0.70) kbm(i)   = k + 1<a name='2854'>
        enddo<a name='2855'>
      enddo<a name='2856'>
      do i=1,im<a name='2857'>
        kbmax(i) = min(kbmax(i),kmax(i))<a name='2858'>
        kbm(i)   = min(kbm(i),kmax(i))<a name='2859'>
      enddo<a name='2860'>
<font color=#447700>!c<a name='2861'></font>
<font color=#447700>!c  hydrostatic height assume zero terr and initially assume<a name='2862'></font>
<font color=#447700>!c    updraft entrainment rate as an inverse function of height <a name='2863'></font>
<font color=#447700>!c<a name='2864'></font>
      do k = 1, km<a name='2865'>
        do i=1,im<a name='2866'>
          zo(i,k) = phil(i,k) / g<a name='2867'>
        enddo<a name='2868'>
      enddo<a name='2869'>
      do k = 1, km1<a name='2870'>
        do i=1,im<a name='2871'>
          zi(i,k) = 0.5*(zo(i,k)+zo(i,k+1))<a name='2872'>
          xlamue(i,k) = clam / zi(i,k)<a name='2873'>
        enddo<a name='2874'>
      enddo<a name='2875'>
<font color=#447700>!c<a name='2876'></font>
<font color=#447700>!c!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2877'></font>
<font color=#447700>!c   convert surface pressure to mb from cb<a name='2878'></font>
<font color=#447700>!c<a name='2879'></font>
      do k = 1, km<a name='2880'>
        do i = 1, im<a name='2881'>
          if (k .le. kmax(i)) then<a name='2882'>
            pfld(i,k) = prsl(i,k) * 10.0<a name='2883'>
            eta(i,k)  = 1.<a name='2884'>
            fent1(i,k)= 1.<a name='2885'>
            fent2(i,k)= 1.<a name='2886'>
            frh(i,k)  = 0.<a name='2887'>
            hcko(i,k) = 0.<a name='2888'>
            qcko(i,k) = 0.<a name='2889'>
            ucko(i,k) = 0.<a name='2890'>
            vcko(i,k) = 0.<a name='2891'>
            etad(i,k) = 1.<a name='2892'>
            hcdo(i,k) = 0.<a name='2893'>
            qcdo(i,k) = 0.<a name='2894'>
            ucdo(i,k) = 0.<a name='2895'>
            vcdo(i,k) = 0.<a name='2896'>
            qrcd(i,k) = 0.<a name='2897'>
            qrcdo(i,k)= 0.<a name='2898'>
            dbyo(i,k) = 0.<a name='2899'>
            pwo(i,k)  = 0.<a name='2900'>
            pwdo(i,k) = 0.<a name='2901'>
            dellal(i,k) = 0.<a name='2902'>
            to(i,k)   = t1(i,k)<a name='2903'>
            qo(i,k)   = q1(i,k)<a name='2904'>
            uo(i,k)   = u1(i,k) * rcs(i)<a name='2905'>
            vo(i,k)   = v1(i,k) * rcs(i)<a name='2906'>
          endif<a name='2907'>
        enddo<a name='2908'>
      enddo<a name='2909'>
<font color=#447700>!c<a name='2910'></font>
<font color=#447700>!c  column variables<a name='2911'></font>
<font color=#447700>!c  p is pressure of the layer (mb)<a name='2912'></font>
<font color=#447700>!c  t is temperature at t-dt (k)..tn<a name='2913'></font>
<font color=#447700>!c  q is mixing ratio at t-dt (kg/kg)..qn<a name='2914'></font>
<font color=#447700>!c  to is temperature at t+dt (k)... this is after advection and turbulan<a name='2915'></font>
<font color=#447700>!c  qo is mixing ratio at t+dt (kg/kg)..q1<a name='2916'></font>
<font color=#447700>!c<a name='2917'></font>
      do k = 1, km<a name='2918'>
        do i=1,im<a name='2919'>
          if (k .le. kmax(i)) then<a name='2920'>
            qeso(i,k) = 0.01 * fpvs(to(i,k))      <font color=#447700>! fpvs is in pa<a name='2921'></font>
            qeso(i,k) = eps * qeso(i,k) / (pfld(i,k) + epsm1*qeso(i,k))<a name='2922'>
            val1      =             1.e-8<a name='2923'>
            qeso(i,k) = max(qeso(i,k), val1)<a name='2924'>
            val2      =           1.e-10<a name='2925'>
            qo(i,k)   = max(qo(i,k), val2 )<a name='2926'>
<font color=#447700>!           qo(i,k)   = min(qo(i,k),qeso(i,k))<a name='2927'></font>
<font color=#447700>!           tvo(i,k)  = to(i,k) + delta * to(i,k) * qo(i,k)<a name='2928'></font>
          endif<a name='2929'>
        enddo<a name='2930'>
      enddo<a name='2931'>
<font color=#447700>!c<a name='2932'></font>
<font color=#447700>!c  compute moist static energy<a name='2933'></font>
<font color=#447700>!c<a name='2934'></font>
      do k = 1, km<a name='2935'>
        do i=1,im<a name='2936'>
          if (k .le. kmax(i)) then<a name='2937'>
<font color=#447700>!           tem       = g * zo(i,k) + cp * to(i,k)<a name='2938'></font>
            tem       = phil(i,k) + cp * to(i,k)<a name='2939'>
            heo(i,k)  = tem  + hvap * qo(i,k)<a name='2940'>
            heso(i,k) = tem  + hvap * qeso(i,k)<a name='2941'>
<font color=#447700>!c           heo(i,k)  = min(heo(i,k),heso(i,k))<a name='2942'></font>
          endif<a name='2943'>
        enddo<a name='2944'>
      enddo<a name='2945'>
<font color=#447700>!c<a name='2946'></font>
<font color=#447700>!c  determine level with largest moist static energy<a name='2947'></font>
<font color=#447700>!c  this is the level where updraft starts<a name='2948'></font>
<font color=#447700>!c<a name='2949'></font>
      do i=1,im<a name='2950'>
        hmax(i) = heo(i,1)<a name='2951'>
        kb(i)   = 1<a name='2952'>
      enddo<a name='2953'>
      do k = 2, km<a name='2954'>
        do i=1,im<a name='2955'>
          if (k .le. kbm(i)) then<a name='2956'>
            if(heo(i,k).gt.hmax(i)) then<a name='2957'>
              kb(i)   = k<a name='2958'>
              hmax(i) = heo(i,k)<a name='2959'>
            endif<a name='2960'>
          endif<a name='2961'>
        enddo<a name='2962'>
      enddo<a name='2963'>
<font color=#447700>!c<a name='2964'></font>
      do k = 1, km1<a name='2965'>
        do i=1,im<a name='2966'>
          if (k .le. kmax(i)-1) then<a name='2967'>
            dz      = .5 * (zo(i,k+1) - zo(i,k))<a name='2968'>
            dp      = .5 * (pfld(i,k+1) - pfld(i,k))<a name='2969'>
            es      = 0.01 * fpvs(to(i,k+1))      <font color=#447700>! fpvs is in pa<a name='2970'></font>
            pprime  = pfld(i,k+1) + epsm1 * es<a name='2971'>
            qs      = eps * es / pprime<a name='2972'>
            dqsdp   = - qs / pprime<a name='2973'>
            desdt   = es * (fact1 / to(i,k+1) + fact2 / (to(i,k+1)**2))<a name='2974'>
            dqsdt   = qs * pfld(i,k+1) * desdt / (es * pprime)<a name='2975'>
            gamma   = el2orc * qeso(i,k+1) / (to(i,k+1)**2)<a name='2976'>
            dt      = (g * dz + hvap * dqsdp * dp) / (cp * (1. + gamma))<a name='2977'>
            dq      = dqsdt * dt + dqsdp * dp<a name='2978'>
            to(i,k) = to(i,k+1) + dt<a name='2979'>
            qo(i,k) = qo(i,k+1) + dq<a name='2980'>
            po(i,k) = .5 * (pfld(i,k) + pfld(i,k+1))<a name='2981'>
          endif<a name='2982'>
        enddo<a name='2983'>
      enddo<a name='2984'>
<font color=#447700>!<a name='2985'></font>
      do k = 1, km1<a name='2986'>
        do i=1,im<a name='2987'>
          if (k .le. kmax(i)-1) then<a name='2988'>
            qeso(i,k) = 0.01 * fpvs(to(i,k))      <font color=#447700>! fpvs is in pa<a name='2989'></font>
            qeso(i,k) = eps * qeso(i,k) / (po(i,k) + epsm1*qeso(i,k))<a name='2990'>
            val1      =             1.e-8<a name='2991'>
            qeso(i,k) = max(qeso(i,k), val1)<a name='2992'>
            val2      =           1.e-10<a name='2993'>
            qo(i,k)   = max(qo(i,k), val2 )<a name='2994'>
<font color=#447700>!           qo(i,k)   = min(qo(i,k),qeso(i,k))<a name='2995'></font>
            val1      = 1.0<a name='2996'>
            frh(i,k)  = 1. - min(qo(i,k)/qeso(i,k), val1)<a name='2997'>
            heo(i,k)  = .5 * g * (zo(i,k) + zo(i,k+1)) +      &amp;<a name='2998'>
     &amp;                  cp * to(i,k) + hvap * qo(i,k)<a name='2999'>
            heso(i,k) = .5 * g * (zo(i,k) + zo(i,k+1)) +      &amp;<a name='3000'>
     &amp;                  cp * to(i,k) + hvap * qeso(i,k)<a name='3001'>
            uo(i,k)   = .5 * (uo(i,k) + uo(i,k+1))<a name='3002'>
            vo(i,k)   = .5 * (vo(i,k) + vo(i,k+1))<a name='3003'>
          endif<a name='3004'>
        enddo<a name='3005'>
      enddo<a name='3006'>
<font color=#447700>!c<a name='3007'></font>
<font color=#447700>!c  look for the level of free convection as cloud base<a name='3008'></font>
<font color=#447700>!c<a name='3009'></font>
      do i=1,im<a name='3010'>
        flg(i)   = .true.<a name='3011'>
        kbcon(i) = kmax(i)<a name='3012'>
      enddo<a name='3013'>
      do k = 1, km1<a name='3014'>
        do i=1,im<a name='3015'>
          if (flg(i).and.k.le.kbmax(i)) then<a name='3016'>
            if(k.gt.kb(i).and.heo(i,kb(i)).gt.heso(i,k)) then<a name='3017'>
              kbcon(i) = k<a name='3018'>
              flg(i)   = .false.<a name='3019'>
            endif<a name='3020'>
          endif<a name='3021'>
        enddo<a name='3022'>
      enddo<a name='3023'>
<font color=#447700>!c<a name='3024'></font>
      do i=1,im<a name='3025'>
        if(kbcon(i).eq.kmax(i)) cnvflg(i) = .false.<a name='3026'>
      enddo<a name='3027'>
<font color=#447700>!!<a name='3028'></font>
      totflg = .true.<a name='3029'>
      do i=1,im<a name='3030'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='3031'>
      enddo<a name='3032'>
      if(totflg) return<a name='3033'>
<font color=#447700>!!<a name='3034'></font>
<font color=#447700>!c<a name='3035'></font>
<font color=#447700>!c  determine critical convective inhibition<a name='3036'></font>
<font color=#447700>!c  as a function of vertical velocity at cloud base.<a name='3037'></font>
<font color=#447700>!c<a name='3038'></font>
      do i=1,im<a name='3039'>
        if(cnvflg(i)) then<a name='3040'>
          pdot(i)  = 10.* dot(i,kbcon(i))<a name='3041'>
        endif<a name='3042'>
      enddo<a name='3043'>
      do i=1,im<a name='3044'>
        if(cnvflg(i)) then<a name='3045'>
          if(slimsk(i).eq.1.) then<a name='3046'>
            w1 = w1l<a name='3047'>
            w2 = w2l<a name='3048'>
            w3 = w3l<a name='3049'>
            w4 = w4l<a name='3050'>
          else<a name='3051'>
            w1 = w1s<a name='3052'>
            w2 = w2s<a name='3053'>
            w3 = w3s<a name='3054'>
            w4 = w4s<a name='3055'>
          endif<a name='3056'>
          if(pdot(i).le.w4) then<a name='3057'>
            tem = (pdot(i) - w4) / (w3 - w4)<a name='3058'>
          elseif(pdot(i).ge.-w4) then<a name='3059'>
            tem = - (pdot(i) + w4) / (w4 - w3)<a name='3060'>
          else<a name='3061'>
            tem = 0.<a name='3062'>
          endif<a name='3063'>
          val1    =             -1.<a name='3064'>
          tem = max(tem,val1)<a name='3065'>
          val2    =             1.<a name='3066'>
          tem = min(tem,val2)<a name='3067'>
          tem = 1. - tem<a name='3068'>
          tem1= .5*(cincrmax-cincrmin)<a name='3069'>
          cincr = cincrmax - tem * tem1<a name='3070'>
          pbcdif(i) = pfld(i,kb(i)) - pfld(i,kbcon(i))<a name='3071'>
#if HWRF==1<a name='3072'>
<font color=#447700>! randomly perturb the convection trigger<a name='3073'></font>
          if( pert_sas_local ) then<a name='3074'>
          rr=2.0*ens_sasamp_local*ran1(ens_random_seed_local)-ens_sasamp_local<a name='3075'>
          print*, "zhang inde sas=", rr,ens_sasamp_local,ens_random_seed_local<a name='3076'>
          cincr=cincr+rr<a name='3077'>
          endif<a name='3078'>
#endif<a name='3079'>
          if(pbcdif(i).gt.cincr) then<a name='3080'>
             cnvflg(i) = .false.<a name='3081'>
          endif<a name='3082'>
        endif<a name='3083'>
      enddo<a name='3084'>
<font color=#447700>!!<a name='3085'></font>
      totflg = .true.<a name='3086'>
      do i=1,im<a name='3087'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='3088'>
      enddo<a name='3089'>
      if(totflg) return<a name='3090'>
<font color=#447700>!!<a name='3091'></font>
<font color=#447700>!c<a name='3092'></font>
<font color=#447700>!c  assume that updraft entrainment rate above cloud base is<a name='3093'></font>
<font color=#447700>!c    same as that at cloud base<a name='3094'></font>
<font color=#447700>!c<a name='3095'></font>
      do k = 2, km1<a name='3096'>
        do i=1,im<a name='3097'>
          if(cnvflg(i).and.                            &amp;<a name='3098'>
     &amp;      (k.gt.kbcon(i).and.k.lt.kmax(i))) then<a name='3099'>
              xlamue(i,k) = xlamue(i,kbcon(i))<a name='3100'>
          endif<a name='3101'>
        enddo<a name='3102'>
      enddo<a name='3103'>
<font color=#447700>!c<a name='3104'></font>
<font color=#447700>!c  assume the detrainment rate for the updrafts to be same as<a name='3105'></font>
<font color=#447700>!c  the entrainment rate at cloud base<a name='3106'></font>
<font color=#447700>!c<a name='3107'></font>
      do i = 1, im<a name='3108'>
        if(cnvflg(i)) then<a name='3109'>
          xlamud(i) = xlamue(i,kbcon(i))<a name='3110'>
        endif<a name='3111'>
      enddo<a name='3112'>
<font color=#447700>!c<a name='3113'></font>
<font color=#447700>!c  functions rapidly decreasing with height, mimicking a cloud ensemble<a name='3114'></font>
<font color=#447700>!c    (Bechtold et al., 2008)<a name='3115'></font>
<font color=#447700>!c<a name='3116'></font>
      do k = 2, km1<a name='3117'>
        do i=1,im<a name='3118'>
          if(cnvflg(i).and.                          &amp;<a name='3119'>
     &amp;      (k.gt.kbcon(i).and.k.lt.kmax(i))) then<a name='3120'>
              tem = qeso(i,k)/qeso(i,kbcon(i))<a name='3121'>
              fent1(i,k) = tem**2<a name='3122'>
              fent2(i,k) = tem**3<a name='3123'>
          endif<a name='3124'>
        enddo<a name='3125'>
      enddo<a name='3126'>
<font color=#447700>!c<a name='3127'></font>
<font color=#447700>!c  final entrainment rate as the sum of turbulent part and organized entrainment<a name='3128'></font>
<font color=#447700>!c    depending on the environmental relative humidity<a name='3129'></font>
<font color=#447700>!c    (Bechtold et al., 2008)<a name='3130'></font>
<font color=#447700>!c<a name='3131'></font>
      do k = 2, km1<a name='3132'>
        do i=1,im<a name='3133'>
          if(cnvflg(i).and.                         &amp;<a name='3134'>
     &amp;      (k.ge.kbcon(i).and.k.lt.kmax(i))) then<a name='3135'>
              tem = cxlamu * frh(i,k) * fent2(i,k)<a name='3136'>
              xlamue(i,k) = xlamue(i,k)*fent1(i,k) + tem<a name='3137'>
          endif<a name='3138'>
        enddo<a name='3139'>
      enddo<a name='3140'>
<font color=#447700>!c<a name='3141'></font>
<font color=#447700>!c  determine updraft mass flux for the subcloud layers<a name='3142'></font>
<font color=#447700>!c<a name='3143'></font>
      do k = km1, 1, -1<a name='3144'>
        do i = 1, im<a name='3145'>
          if (cnvflg(i)) then<a name='3146'>
            if(k.lt.kbcon(i).and.k.ge.kb(i)) then<a name='3147'>
              dz       = zi(i,k+1) - zi(i,k)<a name='3148'>
              ptem     = 0.5*(xlamue(i,k)+xlamue(i,k+1))-xlamud(i)<a name='3149'>
              eta(i,k) = eta(i,k+1) / (1. + ptem * dz)<a name='3150'>
            endif<a name='3151'>
          endif<a name='3152'>
        enddo<a name='3153'>
      enddo<a name='3154'>
<font color=#447700>!c<a name='3155'></font>
<font color=#447700>!c  compute mass flux above cloud base<a name='3156'></font>
<font color=#447700>!c<a name='3157'></font>
      do k = 2, km1<a name='3158'>
        do i = 1, im<a name='3159'>
         if(cnvflg(i))then<a name='3160'>
           if(k.gt.kbcon(i).and.k.lt.kmax(i)) then<a name='3161'>
              dz       = zi(i,k) - zi(i,k-1)<a name='3162'>
              ptem     = 0.5*(xlamue(i,k)+xlamue(i,k-1))-xlamud(i)<a name='3163'>
              eta(i,k) = eta(i,k-1) * (1 + ptem * dz)<a name='3164'>
           endif<a name='3165'>
         endif<a name='3166'>
        enddo<a name='3167'>
      enddo<a name='3168'>
<font color=#447700>!c<a name='3169'></font>
<font color=#447700>!c  compute updraft cloud properties<a name='3170'></font>
<font color=#447700>!c<a name='3171'></font>
      do i = 1, im<a name='3172'>
        if(cnvflg(i)) then<a name='3173'>
          indx         = kb(i)<a name='3174'>
          hcko(i,indx) = heo(i,indx)<a name='3175'>
          ucko(i,indx) = uo(i,indx)<a name='3176'>
          vcko(i,indx) = vo(i,indx)<a name='3177'>
          pwavo(i)     = 0.<a name='3178'>
        endif<a name='3179'>
      enddo<a name='3180'>
<font color=#447700>!c<a name='3181'></font>
<font color=#447700>!c  cloud property is modified by the entrainment process<a name='3182'></font>
<font color=#447700>!c<a name='3183'></font>
      do k = 2, km1<a name='3184'>
        do i = 1, im<a name='3185'>
          if (cnvflg(i)) then<a name='3186'>
            if(k.gt.kb(i).and.k.lt.kmax(i)) then<a name='3187'>
              dz   = zi(i,k) - zi(i,k-1)<a name='3188'>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='3189'>
              tem1 = 0.5 * xlamud(i) * dz<a name='3190'>
              factor = 1. + tem - tem1<a name='3191'>
              ptem = 0.5 * tem + pgcon<a name='3192'>
              ptem1= 0.5 * tem - pgcon<a name='3193'>
              hcko(i,k) = ((1.-tem1)*hcko(i,k-1)+tem*0.5*     &amp;<a name='3194'>
     &amp;                     (heo(i,k)+heo(i,k-1)))/factor<a name='3195'>
              ucko(i,k) = ((1.-tem1)*ucko(i,k-1)+ptem*uo(i,k) &amp;<a name='3196'>
     &amp;                     +ptem1*uo(i,k-1))/factor<a name='3197'>
              vcko(i,k) = ((1.-tem1)*vcko(i,k-1)+ptem*vo(i,k) &amp;<a name='3198'>
     &amp;                     +ptem1*vo(i,k-1))/factor<a name='3199'>
              dbyo(i,k) = hcko(i,k) - heso(i,k)<a name='3200'>
            endif<a name='3201'>
          endif<a name='3202'>
        enddo<a name='3203'>
      enddo<a name='3204'>
<font color=#447700>!c<a name='3205'></font>
<font color=#447700>!c   taking account into convection inhibition due to existence of<a name='3206'></font>
<font color=#447700>!c    dry layers below cloud base<a name='3207'></font>
<font color=#447700>!c<a name='3208'></font>
      do i=1,im<a name='3209'>
        flg(i) = cnvflg(i)<a name='3210'>
        kbcon1(i) = kmax(i)<a name='3211'>
      enddo<a name='3212'>
      do k = 2, km1<a name='3213'>
      do i=1,im<a name='3214'>
        if (flg(i).and.k.lt.kmax(i)) then<a name='3215'>
          if(k.ge.kbcon(i).and.dbyo(i,k).gt.0.) then<a name='3216'>
            kbcon1(i) = k<a name='3217'>
            flg(i)    = .false.<a name='3218'>
          endif<a name='3219'>
        endif<a name='3220'>
      enddo<a name='3221'>
      enddo<a name='3222'>
      do i=1,im<a name='3223'>
        if(cnvflg(i)) then<a name='3224'>
          if(kbcon1(i).eq.kmax(i)) cnvflg(i) = .false.<a name='3225'>
        endif<a name='3226'>
      enddo<a name='3227'>
      do i=1,im<a name='3228'>
        if(cnvflg(i)) then<a name='3229'>
          tem = pfld(i,kbcon(i)) - pfld(i,kbcon1(i))<a name='3230'>
          if(tem.gt.dthk) then<a name='3231'>
             cnvflg(i) = .false.<a name='3232'>
          endif<a name='3233'>
        endif<a name='3234'>
      enddo<a name='3235'>
<font color=#447700>!!<a name='3236'></font>
      totflg = .true.<a name='3237'>
      do i = 1, im<a name='3238'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='3239'>
      enddo<a name='3240'>
      if(totflg) return<a name='3241'>
<font color=#447700>!!<a name='3242'></font>
<font color=#447700>!c<a name='3243'></font>
<font color=#447700>!c  determine first guess cloud top as the level of zero buoyancy<a name='3244'></font>
<font color=#447700>!c<a name='3245'></font>
      do i = 1, im<a name='3246'>
        flg(i) = cnvflg(i)<a name='3247'>
        ktcon(i) = 1<a name='3248'>
      enddo<a name='3249'>
      do k = 2, km1<a name='3250'>
      do i = 1, im<a name='3251'>
        if (flg(i).and.k .lt. kmax(i)) then<a name='3252'>
          if(k.gt.kbcon1(i).and.dbyo(i,k).lt.0.) then<a name='3253'>
             ktcon(i) = k<a name='3254'>
             flg(i)   = .false.<a name='3255'>
          endif<a name='3256'>
        endif<a name='3257'>
      enddo<a name='3258'>
      enddo<a name='3259'>
<font color=#447700>!c<a name='3260'></font>
      do i = 1, im<a name='3261'>
        if(cnvflg(i)) then<a name='3262'>
          tem = pfld(i,kbcon(i))-pfld(i,ktcon(i))<a name='3263'>
          if(tem.lt.cthk) cnvflg(i) = .false.<a name='3264'>
        endif<a name='3265'>
      enddo<a name='3266'>
<font color=#447700>!!<a name='3267'></font>
      totflg = .true.<a name='3268'>
      do i = 1, im<a name='3269'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='3270'>
      enddo<a name='3271'>
      if(totflg) return<a name='3272'>
<font color=#447700>!!<a name='3273'></font>
<font color=#447700>!c<a name='3274'></font>
<font color=#447700>!c  search for downdraft originating level above theta-e minimum<a name='3275'></font>
<font color=#447700>!c<a name='3276'></font>
      do i = 1, im<a name='3277'>
        if(cnvflg(i)) then<a name='3278'>
           hmin(i) = heo(i,kbcon1(i))<a name='3279'>
           lmin(i) = kbmax(i)<a name='3280'>
           jmin(i) = kbmax(i)<a name='3281'>
        endif<a name='3282'>
      enddo<a name='3283'>
      do k = 2, km1<a name='3284'>
        do i = 1, im<a name='3285'>
          if (cnvflg(i) .and. k .le. kbmax(i)) then<a name='3286'>
            if(k.gt.kbcon1(i).and.heo(i,k).lt.hmin(i)) then<a name='3287'>
               lmin(i) = k + 1<a name='3288'>
               hmin(i) = heo(i,k)<a name='3289'>
            endif<a name='3290'>
          endif<a name='3291'>
        enddo<a name='3292'>
      enddo<a name='3293'>
<font color=#447700>!c<a name='3294'></font>
<font color=#447700>!c  make sure that jmin(i) is within the cloud<a name='3295'></font>
<font color=#447700>!c<a name='3296'></font>
      do i = 1, im<a name='3297'>
        if(cnvflg(i)) then<a name='3298'>
          jmin(i) = min(lmin(i),ktcon(i)-1)<a name='3299'>
          jmin(i) = max(jmin(i),kbcon1(i)+1)<a name='3300'>
          if(jmin(i).ge.ktcon(i)) cnvflg(i) = .false.<a name='3301'>
        endif<a name='3302'>
      enddo<a name='3303'>
<font color=#447700>!c<a name='3304'></font>
<font color=#447700>!c  specify upper limit of mass flux at cloud base<a name='3305'></font>
<font color=#447700>!c<a name='3306'></font>
      do i = 1, im<a name='3307'>
        if(cnvflg(i)) then<a name='3308'>
<font color=#447700>!         xmbmax(i) = .1<a name='3309'></font>
<font color=#447700>!<a name='3310'></font>
          k = kbcon(i)<a name='3311'>
          dp = 1000. * del(i,k)<a name='3312'>
          xmbmax(i) = dp / (g * dt2)<a name='3313'>
          xmbmax(i) = min(sas_mass_flux,xmbmax(i))<a name='3314'>
<font color=#447700>!<a name='3315'></font>
<font color=#447700>!         tem = dp / (g * dt2)<a name='3316'></font>
<font color=#447700>!         xmbmax(i) = min(tem, xmbmax(i))<a name='3317'></font>
        endif<a name='3318'>
      enddo<a name='3319'>
<font color=#447700>!c<a name='3320'></font>
<font color=#447700>!c  compute cloud moisture property and precipitation<a name='3321'></font>
<font color=#447700>!c<a name='3322'></font>
      do i = 1, im<a name='3323'>
        if (cnvflg(i)) then<a name='3324'>
          aa1(i) = 0.<a name='3325'>
          qcko(i,kb(i)) = qo(i,kb(i))<a name='3326'>
<font color=#447700>!         rhbar(i) = 0.<a name='3327'></font>
        endif<a name='3328'>
      enddo<a name='3329'>
      do k = 2, km1<a name='3330'>
        do i = 1, im<a name='3331'>
          if (cnvflg(i)) then<a name='3332'>
            if(k.gt.kb(i).and.k.lt.ktcon(i)) then<a name='3333'>
              dz    = zi(i,k) - zi(i,k-1)<a name='3334'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='3335'>
              qrch = qeso(i,k)                             &amp;<a name='3336'>
     &amp;             + gamma * dbyo(i,k) / (hvap * (1. + gamma))<a name='3337'>
<font color=#447700>!cj<a name='3338'></font>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='3339'>
              tem1 = 0.5 * xlamud(i) * dz<a name='3340'>
              factor = 1. + tem - tem1<a name='3341'>
              qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*  &amp;<a name='3342'>
     &amp;                     (qo(i,k)+qo(i,k-1)))/factor<a name='3343'>
<font color=#447700>!cj<a name='3344'></font>
              dq = eta(i,k) * (qcko(i,k) - qrch)<a name='3345'>
<font color=#447700>!c<a name='3346'></font>
<font color=#447700>!             rhbar(i) = rhbar(i) + qo(i,k) / qeso(i,k)<a name='3347'></font>
<font color=#447700>!c<a name='3348'></font>
<font color=#447700>!c  check if there is excess moisture to release latent heat<a name='3349'></font>
<font color=#447700>!c<a name='3350'></font>
              if(k.ge.kbcon(i).and.dq.gt.0.) then<a name='3351'>
                etah = .5 * (eta(i,k) + eta(i,k-1))<a name='3352'>
                if(ncloud.gt.0..and.k.gt.jmin(i)) then<a name='3353'>
                  dp = 1000. * del(i,k)<a name='3354'>
                  qlk = dq / (eta(i,k) + etah * (c0 + c1) * dz)<a name='3355'>
                  dellal(i,k) = etah * c1 * dz * qlk * g / dp<a name='3356'>
                else<a name='3357'>
                  qlk = dq / (eta(i,k) + etah * c0 * dz)<a name='3358'>
                endif<a name='3359'>
                aa1(i) = aa1(i) - dz * g * qlk<a name='3360'>
                qcko(i,k) = qlk + qrch<a name='3361'>
                pwo(i,k) = etah * c0 * dz * qlk<a name='3362'>
                pwavo(i) = pwavo(i) + pwo(i,k)<a name='3363'>
              endif<a name='3364'>
            endif<a name='3365'>
          endif<a name='3366'>
        enddo<a name='3367'>
      enddo<a name='3368'>
<font color=#447700>!c<a name='3369'></font>
<font color=#447700>!     do i = 1, im<a name='3370'></font>
<font color=#447700>!       if(cnvflg(i)) then<a name='3371'></font>
<font color=#447700>!         indx = ktcon(i) - kb(i) - 1<a name='3372'></font>
<font color=#447700>!         rhbar(i) = rhbar(i) / float(indx)<a name='3373'></font>
<font color=#447700>!       endif<a name='3374'></font>
<font color=#447700>!     enddo<a name='3375'></font>
<font color=#447700>!c<a name='3376'></font>
<font color=#447700>!c  calculate cloud work function<a name='3377'></font>
<font color=#447700>!c<a name='3378'></font>
      do k = 2, km1<a name='3379'>
        do i = 1, im<a name='3380'>
          if (cnvflg(i)) then<a name='3381'>
            if(k.ge.kbcon(i).and.k.lt.ktcon(i)) then<a name='3382'>
              dz1 = zo(i,k+1) - zo(i,k)<a name='3383'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='3384'>
              rfact =  1. + delta * cp * gamma            &amp;<a name='3385'>
     &amp;                 * to(i,k) / hvap<a name='3386'>
              aa1(i) = aa1(i) +                           &amp;<a name='3387'>
     &amp;                 dz1 * (g / (cp * to(i,k)))         &amp;<a name='3388'>
     &amp;                 * dbyo(i,k) / (1. + gamma)         &amp;<a name='3389'>
     &amp;                 * rfact<a name='3390'>
              val = 0.<a name='3391'>
              aa1(i)=aa1(i)+                              &amp;<a name='3392'>
     &amp;                 dz1 * g * delta *                  &amp;<a name='3393'>
     &amp;                 max(val,(qeso(i,k) - qo(i,k)))<a name='3394'>
            endif<a name='3395'>
          endif<a name='3396'>
        enddo<a name='3397'>
      enddo<a name='3398'>
      do i = 1, im<a name='3399'>
        if(cnvflg(i).and.aa1(i).le.0.) cnvflg(i) = .false.<a name='3400'>
      enddo<a name='3401'>
<font color=#447700>!!<a name='3402'></font>
      totflg = .true.<a name='3403'>
      do i=1,im<a name='3404'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='3405'>
      enddo<a name='3406'>
      if(totflg) return<a name='3407'>
<font color=#447700>!!<a name='3408'></font>
<font color=#447700>!c<a name='3409'></font>
<font color=#447700>!c  estimate the onvective overshooting as the level <a name='3410'></font>
<font color=#447700>!c    where the [aafac * cloud work function] becomes zero,<a name='3411'></font>
<font color=#447700>!c    which is the final cloud top<a name='3412'></font>
<font color=#447700>!c<a name='3413'></font>
      do i = 1, im<a name='3414'>
        if (cnvflg(i)) then<a name='3415'>
          aa2(i) = aafac * aa1(i)<a name='3416'>
        endif<a name='3417'>
      enddo<a name='3418'>
<font color=#447700>!c<a name='3419'></font>
      do i = 1, im<a name='3420'>
        flg(i) = cnvflg(i)<a name='3421'>
        ktcon1(i) = kmax(i) - 1<a name='3422'>
      enddo<a name='3423'>
      do k = 2, km1<a name='3424'>
        do i = 1, im<a name='3425'>
          if (flg(i)) then<a name='3426'>
            if(k.ge.ktcon(i).and.k.lt.kmax(i)) then<a name='3427'>
              dz1 = zo(i,k+1) - zo(i,k)<a name='3428'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='3429'>
              rfact =  1. + delta * cp * gamma          &amp;<a name='3430'>
     &amp;                 * to(i,k) / hvap<a name='3431'>
              aa2(i) = aa2(i) +                         &amp;<a name='3432'>
     &amp;                 dz1 * (g / (cp * to(i,k)))       &amp;<a name='3433'>
     &amp;                 * dbyo(i,k) / (1. + gamma)       &amp;<a name='3434'>
     &amp;                 * rfact<a name='3435'>
              if(aa2(i).lt.0.) then<a name='3436'>
                ktcon1(i) = k<a name='3437'>
                flg(i) = .false.<a name='3438'>
              endif<a name='3439'>
            endif<a name='3440'>
          endif<a name='3441'>
        enddo<a name='3442'>
      enddo<a name='3443'>
<font color=#447700>!c<a name='3444'></font>
<font color=#447700>!c  compute cloud moisture property, detraining cloud water <a name='3445'></font>
<font color=#447700>!c    and precipitation in overshooting layers <a name='3446'></font>
<font color=#447700>!c<a name='3447'></font>
      do k = 2, km1<a name='3448'>
        do i = 1, im<a name='3449'>
          if (cnvflg(i)) then<a name='3450'>
            if(k.ge.ktcon(i).and.k.lt.ktcon1(i)) then<a name='3451'>
              dz    = zi(i,k) - zi(i,k-1)<a name='3452'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='3453'>
              qrch = qeso(i,k)                              &amp;<a name='3454'>
     &amp;             + gamma * dbyo(i,k) / (hvap * (1. + gamma))<a name='3455'>
<font color=#447700>!cj<a name='3456'></font>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='3457'>
              tem1 = 0.5 * xlamud(i) * dz<a name='3458'>
              factor = 1. + tem - tem1<a name='3459'>
              qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*   &amp;<a name='3460'>
     &amp;                     (qo(i,k)+qo(i,k-1)))/factor<a name='3461'>
<font color=#447700>!cj<a name='3462'></font>
              dq = eta(i,k) * (qcko(i,k) - qrch)<a name='3463'>
<font color=#447700>!c<a name='3464'></font>
<font color=#447700>!c  check if there is excess moisture to release latent heat<a name='3465'></font>
<font color=#447700>!c<a name='3466'></font>
              if(dq.gt.0.) then<a name='3467'>
                etah = .5 * (eta(i,k) + eta(i,k-1))<a name='3468'>
                if(ncloud.gt.0.) then<a name='3469'>
                  dp = 1000. * del(i,k)<a name='3470'>
                  qlk = dq / (eta(i,k) + etah * (c0 + c1) * dz)<a name='3471'>
                  dellal(i,k) = etah * c1 * dz * qlk * g / dp<a name='3472'>
                else<a name='3473'>
                  qlk = dq / (eta(i,k) + etah * c0 * dz)<a name='3474'>
                endif<a name='3475'>
                qcko(i,k) = qlk + qrch<a name='3476'>
                pwo(i,k) = etah * c0 * dz * qlk<a name='3477'>
                pwavo(i) = pwavo(i) + pwo(i,k)<a name='3478'>
              endif<a name='3479'>
            endif<a name='3480'>
          endif<a name='3481'>
        enddo<a name='3482'>
      enddo<a name='3483'>
<font color=#447700>!c<a name='3484'></font>
<font color=#447700>!c exchange ktcon with ktcon1<a name='3485'></font>
<font color=#447700>!c<a name='3486'></font>
      do i = 1, im<a name='3487'>
        if(cnvflg(i)) then<a name='3488'>
          kk = ktcon(i)<a name='3489'>
          ktcon(i) = ktcon1(i)<a name='3490'>
          ktcon1(i) = kk<a name='3491'>
        endif<a name='3492'>
      enddo<a name='3493'>
<font color=#447700>!c<a name='3494'></font>
<font color=#447700>!c  this section is ready for cloud water<a name='3495'></font>
<font color=#447700>!c<a name='3496'></font>
      if(ncloud.gt.0) then<a name='3497'>
<font color=#447700>!c<a name='3498'></font>
<font color=#447700>!c  compute liquid and vapor separation at cloud top<a name='3499'></font>
<font color=#447700>!c<a name='3500'></font>
      do i = 1, im<a name='3501'>
        if(cnvflg(i)) then<a name='3502'>
          k = ktcon(i) - 1<a name='3503'>
          gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='3504'>
          qrch = qeso(i,k)                              &amp;<a name='3505'>
     &amp;         + gamma * dbyo(i,k) / (hvap * (1. + gamma))<a name='3506'>
          dq = qcko(i,k) - qrch<a name='3507'>
<font color=#447700>!c<a name='3508'></font>
<font color=#447700>!c  check if there is excess moisture to release latent heat<a name='3509'></font>
<font color=#447700>!c<a name='3510'></font>
          if(dq.gt.0.) then<a name='3511'>
            qlko_ktcon(i) = dq<a name='3512'>
            qcko(i,k) = qrch<a name='3513'>
          endif<a name='3514'>
        endif<a name='3515'>
      enddo<a name='3516'>
      endif<a name='3517'>
<font color=#447700>!c<a name='3518'></font>
<font color=#447700>!ccccc if(lat.eq.latd.and.lon.eq.lond.and.cnvflg(i)) then<a name='3519'></font>
<font color=#447700>!ccccc   print *, ' aa1(i) before dwndrft =', aa1(i)<a name='3520'></font>
<font color=#447700>!ccccc endif<a name='3521'></font>
<font color=#447700>!c<a name='3522'></font>
<font color=#447700>!c------- downdraft calculations<a name='3523'></font>
<font color=#447700>!c<a name='3524'></font>
<font color=#447700>!c--- compute precipitation efficiency in terms of windshear<a name='3525'></font>
<font color=#447700>!c<a name='3526'></font>
      do i = 1, im<a name='3527'>
        if(cnvflg(i)) then<a name='3528'>
          vshear(i) = 0.<a name='3529'>
        endif<a name='3530'>
      enddo<a name='3531'>
      do k = 2, km<a name='3532'>
        do i = 1, im<a name='3533'>
          if (cnvflg(i)) then<a name='3534'>
            if(k.gt.kb(i).and.k.le.ktcon(i)) then<a name='3535'>
              shear= sqrt((uo(i,k)-uo(i,k-1)) ** 2      &amp;<a name='3536'>
     &amp;                  + (vo(i,k)-vo(i,k-1)) ** 2)<a name='3537'>
              vshear(i) = vshear(i) + shear<a name='3538'>
            endif<a name='3539'>
          endif<a name='3540'>
        enddo<a name='3541'>
      enddo<a name='3542'>
      do i = 1, im<a name='3543'>
        if(cnvflg(i)) then<a name='3544'>
          vshear(i) = 1.e3 * vshear(i) / (zi(i,ktcon(i))-zi(i,kb(i)))<a name='3545'>
          e1=1.591-.639*vshear(i)                       &amp;<a name='3546'>
     &amp;       +.0953*(vshear(i)**2)-.00496*(vshear(i)**3)<a name='3547'>
          edt(i)=1.-e1<a name='3548'>
          val =         .9<a name='3549'>
          edt(i) = min(edt(i),val)<a name='3550'>
          val =         .0<a name='3551'>
          edt(i) = max(edt(i),val)<a name='3552'>
          edto(i)=edt(i)<a name='3553'>
          edtx(i)=edt(i)<a name='3554'>
        endif<a name='3555'>
      enddo<a name='3556'>
<font color=#447700>!c<a name='3557'></font>
<font color=#447700>!c  determine detrainment rate between 1 and kbcon<a name='3558'></font>
<font color=#447700>!c<a name='3559'></font>
      do i = 1, im<a name='3560'>
        if(cnvflg(i)) then<a name='3561'>
          sumx(i) = 0.<a name='3562'>
        endif<a name='3563'>
      enddo<a name='3564'>
      do k = 1, km1<a name='3565'>
      do i = 1, im<a name='3566'>
        if(cnvflg(i).and.k.ge.1.and.k.lt.kbcon(i)) then<a name='3567'>
          dz = zi(i,k+1) - zi(i,k)<a name='3568'>
          sumx(i) = sumx(i) + dz<a name='3569'>
        endif<a name='3570'>
      enddo<a name='3571'>
      enddo<a name='3572'>
      do i = 1, im<a name='3573'>
        beta = betas<a name='3574'>
        if(slimsk(i).eq.1.) beta = betal<a name='3575'>
        if(cnvflg(i)) then<a name='3576'>
          dz  = (sumx(i)+zi(i,1))/float(kbcon(i))<a name='3577'>
          tem = 1./float(kbcon(i))<a name='3578'>
          xlamd(i) = (1.-beta**tem)/dz<a name='3579'>
        endif<a name='3580'>
      enddo<a name='3581'>
<font color=#447700>!c<a name='3582'></font>
<font color=#447700>!c  determine downdraft mass flux<a name='3583'></font>
<font color=#447700>!c<a name='3584'></font>
      do k = km1, 1, -1<a name='3585'>
        do i = 1, im<a name='3586'>
          if (cnvflg(i) .and. k .le. kmax(i)-1) then<a name='3587'>
           if(k.lt.jmin(i).and.k.ge.kbcon(i)) then<a name='3588'>
              dz        = zi(i,k+1) - zi(i,k)<a name='3589'>
              ptem      = xlamdd - xlamde<a name='3590'>
              etad(i,k) = etad(i,k+1) * (1. - ptem * dz)<a name='3591'>
           else if(k.lt.kbcon(i)) then<a name='3592'>
              dz        = zi(i,k+1) - zi(i,k)<a name='3593'>
              ptem      = xlamd(i) + xlamdd - xlamde<a name='3594'>
              etad(i,k) = etad(i,k+1) * (1. - ptem * dz)<a name='3595'>
           endif<a name='3596'>
          endif<a name='3597'>
        enddo<a name='3598'>
      enddo<a name='3599'>
<font color=#447700>!c<a name='3600'></font>
<font color=#447700>!c--- downdraft moisture properties<a name='3601'></font>
<font color=#447700>!c<a name='3602'></font>
      do i = 1, im<a name='3603'>
        if(cnvflg(i)) then<a name='3604'>
          jmn = jmin(i)<a name='3605'>
          hcdo(i,jmn) = heo(i,jmn)<a name='3606'>
          qcdo(i,jmn) = qo(i,jmn)<a name='3607'>
          qrcdo(i,jmn)= qeso(i,jmn)<a name='3608'>
          ucdo(i,jmn) = uo(i,jmn)<a name='3609'>
          vcdo(i,jmn) = vo(i,jmn)<a name='3610'>
          pwevo(i) = 0.<a name='3611'>
        endif<a name='3612'>
      enddo<a name='3613'>
<font color=#447700>!cj<a name='3614'></font>
      do k = km1, 1, -1<a name='3615'>
        do i = 1, im<a name='3616'>
          if (cnvflg(i) .and. k.lt.jmin(i)) then<a name='3617'>
              dz = zi(i,k+1) - zi(i,k)<a name='3618'>
              if(k.ge.kbcon(i)) then<a name='3619'>
                 tem  = xlamde * dz<a name='3620'>
                 tem1 = 0.5 * xlamdd * dz<a name='3621'>
              else<a name='3622'>
                 tem  = xlamde * dz<a name='3623'>
                 tem1 = 0.5 * (xlamd(i)+xlamdd) * dz<a name='3624'>
              endif<a name='3625'>
              factor = 1. + tem - tem1<a name='3626'>
              ptem = 0.5 * tem - pgcon<a name='3627'>
              ptem1= 0.5 * tem + pgcon<a name='3628'>
              hcdo(i,k) = ((1.-tem1)*hcdo(i,k+1)+tem*0.5*       &amp;<a name='3629'>
     &amp;                     (heo(i,k)+heo(i,k+1)))/factor<a name='3630'>
              ucdo(i,k) = ((1.-tem1)*ucdo(i,k+1)+ptem*uo(i,k+1) &amp;<a name='3631'>
     &amp;                     +ptem1*uo(i,k))/factor<a name='3632'>
              vcdo(i,k) = ((1.-tem1)*vcdo(i,k+1)+ptem*vo(i,k+1) &amp;<a name='3633'>
     &amp;                     +ptem1*vo(i,k))/factor<a name='3634'>
              dbyo(i,k) = hcdo(i,k) - heso(i,k)<a name='3635'>
          endif<a name='3636'>
        enddo<a name='3637'>
      enddo<a name='3638'>
<font color=#447700>!c<a name='3639'></font>
      do k = km1, 1, -1<a name='3640'>
        do i = 1, im<a name='3641'>
          if (cnvflg(i).and.k.lt.jmin(i)) then<a name='3642'>
              gamma      = el2orc * qeso(i,k) / (to(i,k)**2)<a name='3643'>
              qrcdo(i,k) = qeso(i,k)+                          &amp;<a name='3644'>
     &amp;                (1./hvap)*(gamma/(1.+gamma))*dbyo(i,k)<a name='3645'>
<font color=#447700>!             detad      = etad(i,k+1) - etad(i,k)<a name='3646'></font>
<font color=#447700>!cj<a name='3647'></font>
              dz = zi(i,k+1) - zi(i,k)<a name='3648'>
              if(k.ge.kbcon(i)) then<a name='3649'>
                 tem  = xlamde * dz<a name='3650'>
                 tem1 = 0.5 * xlamdd * dz<a name='3651'>
              else<a name='3652'>
                 tem  = xlamde * dz<a name='3653'>
                 tem1 = 0.5 * (xlamd(i)+xlamdd) * dz<a name='3654'>
              endif<a name='3655'>
              factor = 1. + tem - tem1<a name='3656'>
              qcdo(i,k) = ((1.-tem1)*qcdo(i,k+1)+tem*0.5*     &amp;<a name='3657'>
     &amp;                     (qo(i,k)+qo(i,k+1)))/factor<a name='3658'>
<font color=#447700>!cj<a name='3659'></font>
<font color=#447700>!             pwdo(i,k)  = etad(i,k+1) * qcdo(i,k+1) -<a name='3660'></font>
<font color=#447700>!    &amp;                     etad(i,k) * qrcdo(i,k)<a name='3661'></font>
<font color=#447700>!             pwdo(i,k)  = pwdo(i,k) - detad *<a name='3662'></font>
<font color=#447700>!    &amp;                    .5 * (qrcdo(i,k) + qrcdo(i,k+1))<a name='3663'></font>
<font color=#447700>!cj<a name='3664'></font>
              pwdo(i,k)  = etad(i,k+1) * (qcdo(i,k) - qrcdo(i,k))<a name='3665'>
              qcdo(i,k)  = qrcdo(i,k)<a name='3666'>
              pwevo(i)   = pwevo(i) + pwdo(i,k)<a name='3667'>
          endif<a name='3668'>
        enddo<a name='3669'>
      enddo<a name='3670'>
<font color=#447700>!c<a name='3671'></font>
<font color=#447700>!c--- final downdraft strength dependent on precip<a name='3672'></font>
<font color=#447700>!c--- efficiency (edt), normalized condensate (pwav), and<a name='3673'></font>
<font color=#447700>!c--- evaporate (pwev)<a name='3674'></font>
<font color=#447700>!c<a name='3675'></font>
      do i = 1, im<a name='3676'>
        edtmax = edtmaxl<a name='3677'>
        if(slimsk(i).eq.0.) edtmax = edtmaxs<a name='3678'>
        if(cnvflg(i)) then<a name='3679'>
          if(pwevo(i).lt.0.) then<a name='3680'>
            edto(i) = -edto(i) * pwavo(i) / pwevo(i)<a name='3681'>
            edto(i) = min(edto(i),edtmax)<a name='3682'>
          else<a name='3683'>
            edto(i) = 0.<a name='3684'>
          endif<a name='3685'>
        endif<a name='3686'>
      enddo<a name='3687'>
<font color=#447700>!c<a name='3688'></font>
<font color=#447700>!c--- downdraft cloudwork functions<a name='3689'></font>
<font color=#447700>!c<a name='3690'></font>
      do k = km1, 1, -1<a name='3691'>
        do i = 1, im<a name='3692'>
          if (cnvflg(i) .and. k .lt. jmin(i)) then<a name='3693'>
              gamma = el2orc * qeso(i,k) / to(i,k)**2<a name='3694'>
              dhh=hcdo(i,k)<a name='3695'>
              dt=to(i,k)<a name='3696'>
              dg=gamma<a name='3697'>
              dh=heso(i,k)<a name='3698'>
              dz=-1.*(zo(i,k+1)-zo(i,k))<a name='3699'>
              aa1(i)=aa1(i)+edto(i)*dz*(g/(cp*dt))*((dhh-dh)/(1.+dg)) &amp;<a name='3700'>
     &amp;               *(1.+delta*cp*dg*dt/hvap)<a name='3701'>
              val=0.<a name='3702'>
              aa1(i)=aa1(i)+edto(i)*                    &amp;<a name='3703'>
     &amp;        dz*g*delta*max(val,(qeso(i,k)-qo(i,k)))<a name='3704'>
          endif<a name='3705'>
        enddo<a name='3706'>
      enddo<a name='3707'>
      do i = 1, im<a name='3708'>
        if(cnvflg(i).and.aa1(i).le.0.) then<a name='3709'>
           cnvflg(i) = .false.<a name='3710'>
        endif<a name='3711'>
      enddo<a name='3712'>
<font color=#447700>!!<a name='3713'></font>
      totflg = .true.<a name='3714'>
      do i=1,im<a name='3715'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='3716'>
      enddo<a name='3717'>
      if(totflg) return<a name='3718'>
<font color=#447700>!!<a name='3719'></font>
<font color=#447700>!c<a name='3720'></font>
<font color=#447700>!c--- what would the change be, that a cloud with unit mass<a name='3721'></font>
<font color=#447700>!c--- will do to the environment?<a name='3722'></font>
<font color=#447700>!c<a name='3723'></font>
      do k = 1, km<a name='3724'>
        do i = 1, im<a name='3725'>
          if(cnvflg(i) .and. k .le. kmax(i)) then<a name='3726'>
            dellah(i,k) = 0.<a name='3727'>
            dellaq(i,k) = 0.<a name='3728'>
            dellau(i,k) = 0.<a name='3729'>
            dellav(i,k) = 0.<a name='3730'>
          endif<a name='3731'>
        enddo<a name='3732'>
      enddo<a name='3733'>
      do i = 1, im<a name='3734'>
        if(cnvflg(i)) then<a name='3735'>
          dp = 1000. * del(i,1)<a name='3736'>
          dellah(i,1) = edto(i) * etad(i,1) * (hcdo(i,1)     &amp;<a name='3737'>
     &amp;                   - heo(i,1)) * g / dp<a name='3738'>
          dellaq(i,1) = edto(i) * etad(i,1) * (qcdo(i,1)     &amp;<a name='3739'>
     &amp;                   - qo(i,1)) * g / dp<a name='3740'>
          dellau(i,1) = edto(i) * etad(i,1) * (ucdo(i,1)     &amp;<a name='3741'>
     &amp;                   - uo(i,1)) * g / dp<a name='3742'>
          dellav(i,1) = edto(i) * etad(i,1) * (vcdo(i,1)     &amp;<a name='3743'>
     &amp;                   - vo(i,1)) * g / dp<a name='3744'>
        endif<a name='3745'>
      enddo<a name='3746'>
<font color=#447700>!c<a name='3747'></font>
<font color=#447700>!c--- changed due to subsidence and entrainment<a name='3748'></font>
<font color=#447700>!c<a name='3749'></font>
      do k = 2, km1<a name='3750'>
        do i = 1, im<a name='3751'>
          if (cnvflg(i).and.k.lt.ktcon(i)) then<a name='3752'>
              aup = 1.<a name='3753'>
              if(k.le.kb(i)) aup = 0.<a name='3754'>
              adw = 1.<a name='3755'>
              if(k.gt.jmin(i)) adw = 0.<a name='3756'>
              dp = 1000. * del(i,k)<a name='3757'>
              dz = zi(i,k) - zi(i,k-1)<a name='3758'>
<font color=#447700>!c<a name='3759'></font>
              dv1h = heo(i,k)<a name='3760'>
              dv2h = .5 * (heo(i,k) + heo(i,k-1))<a name='3761'>
              dv3h = heo(i,k-1)<a name='3762'>
              dv1q = qo(i,k)<a name='3763'>
              dv2q = .5 * (qo(i,k) + qo(i,k-1))<a name='3764'>
              dv3q = qo(i,k-1)<a name='3765'>
              dv1u = uo(i,k)<a name='3766'>
              dv2u = .5 * (uo(i,k) + uo(i,k-1))<a name='3767'>
              dv3u = uo(i,k-1)<a name='3768'>
              dv1v = vo(i,k)<a name='3769'>
              dv2v = .5 * (vo(i,k) + vo(i,k-1))<a name='3770'>
              dv3v = vo(i,k-1)<a name='3771'>
<font color=#447700>!c<a name='3772'></font>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1))<a name='3773'>
              tem1 = xlamud(i)<a name='3774'>
<font color=#447700>!c<a name='3775'></font>
              if(k.le.kbcon(i)) then<a name='3776'>
                ptem  = xlamde<a name='3777'>
                ptem1 = xlamd(i)+xlamdd<a name='3778'>
              else<a name='3779'>
                ptem  = xlamde<a name='3780'>
                ptem1 = xlamdd<a name='3781'>
              endif<a name='3782'>
<font color=#447700>!cj<a name='3783'></font>
              dellah(i,k) = dellah(i,k) +                           &amp;<a name='3784'>
     &amp;     ((aup*eta(i,k)-adw*edto(i)*etad(i,k))*dv1h               &amp;<a name='3785'>
     &amp;    - (aup*eta(i,k-1)-adw*edto(i)*etad(i,k-1))*dv3h           &amp;<a name='3786'>
     &amp;    - (aup*tem*eta(i,k-1)+adw*edto(i)*ptem*etad(i,k))*dv2h*dz &amp;<a name='3787'>
     &amp;    +  aup*tem1*eta(i,k-1)*.5*(hcko(i,k)+hcko(i,k-1))*dz      &amp;<a name='3788'>
     &amp;    +  adw*edto(i)*ptem1*etad(i,k)*.5*(hcdo(i,k)+hcdo(i,k-1)) &amp;<a name='3789'>
     &amp;         *dz) *g/dp<a name='3790'>
<font color=#447700>!cj<a name='3791'></font>
              dellaq(i,k) = dellaq(i,k) +                             &amp;<a name='3792'>
     &amp;     ((aup*eta(i,k)-adw*edto(i)*etad(i,k))*dv1q                 &amp;<a name='3793'>
     &amp;    - (aup*eta(i,k-1)-adw*edto(i)*etad(i,k-1))*dv3q             &amp;<a name='3794'>
     &amp;    - (aup*tem*eta(i,k-1)+adw*edto(i)*ptem*etad(i,k))*dv2q*dz   &amp;<a name='3795'>
     &amp;    +  aup*tem1*eta(i,k-1)*.5*(qcko(i,k)+qcko(i,k-1))*dz        &amp;<a name='3796'>
     &amp;    +  adw*edto(i)*ptem1*etad(i,k)*.5*(qrcdo(i,k)+qrcdo(i,k-1)) &amp;<a name='3797'>
     &amp;         *dz) *g/dp<a name='3798'>
<font color=#447700>!23456789012345678901234567890123456789012345678901234567890123456789012<a name='3799'></font>
<font color=#447700>!cj<a name='3800'></font>
              dellau(i,k) = dellau(i,k) +                             &amp;<a name='3801'>
     &amp;     ((aup*eta(i,k)-adw*edto(i)*etad(i,k))*dv1u                 &amp;<a name='3802'>
     &amp;    - (aup*eta(i,k-1)-adw*edto(i)*etad(i,k-1))*dv3u             &amp;<a name='3803'>
     &amp;    - (aup*tem*eta(i,k-1)+adw*edto(i)*ptem*etad(i,k))*dv2u*dz   &amp;<a name='3804'>
     &amp;    +  aup*tem1*eta(i,k-1)*.5*(ucko(i,k)+ucko(i,k-1))*dz        &amp;<a name='3805'>
     &amp;    + adw*edto(i)*ptem1*etad(i,k)*.5*(ucdo(i,k)+ucdo(i,k-1))*dz &amp;<a name='3806'>
     &amp;    -  pgcon*(aup*eta(i,k-1)-adw*edto(i)*etad(i,k))*(dv1u-dv3u) &amp;<a name='3807'>
     &amp;         ) *g/dp<a name='3808'>
<font color=#447700>!cj<a name='3809'></font>
              dellav(i,k) = dellav(i,k) +                             &amp;<a name='3810'>
     &amp;     ((aup*eta(i,k)-adw*edto(i)*etad(i,k))*dv1v                 &amp;<a name='3811'>
     &amp;    - (aup*eta(i,k-1)-adw*edto(i)*etad(i,k-1))*dv3v             &amp;<a name='3812'>
     &amp;    - (aup*tem*eta(i,k-1)+adw*edto(i)*ptem*etad(i,k))*dv2v*dz   &amp;<a name='3813'>
     &amp;    +  aup*tem1*eta(i,k-1)*.5*(vcko(i,k)+vcko(i,k-1))*dz        &amp;<a name='3814'>
     &amp;    + adw*edto(i)*ptem1*etad(i,k)*.5*(vcdo(i,k)+vcdo(i,k-1))*dz &amp;<a name='3815'>
     &amp;    -  pgcon*(aup*eta(i,k-1)-adw*edto(i)*etad(i,k))*(dv1v-dv3v) &amp;<a name='3816'>
     &amp;         ) *g/dp<a name='3817'>
<font color=#447700>!cj<a name='3818'></font>
          endif<a name='3819'>
        enddo<a name='3820'>
      enddo<a name='3821'>
<font color=#447700>!c<a name='3822'></font>
<font color=#447700>!c------- cloud top<a name='3823'></font>
<font color=#447700>!c<a name='3824'></font>
      do i = 1, im<a name='3825'>
        if(cnvflg(i)) then<a name='3826'>
          indx = ktcon(i)<a name='3827'>
          dp = 1000. * del(i,indx)<a name='3828'>
          dv1h = heo(i,indx-1)<a name='3829'>
          dellah(i,indx) = eta(i,indx-1) *                    &amp;<a name='3830'>
     &amp;                     (hcko(i,indx-1) - dv1h) * g / dp<a name='3831'>
          dv1q = qo(i,indx-1)<a name='3832'>
          dellaq(i,indx) = eta(i,indx-1) *                    &amp;<a name='3833'>
     &amp;                     (qcko(i,indx-1) - dv1q) * g / dp<a name='3834'>
          dv1u = uo(i,indx-1)<a name='3835'>
          dellau(i,indx) = eta(i,indx-1) *                    &amp;<a name='3836'>
     &amp;                     (ucko(i,indx-1) - dv1u) * g / dp<a name='3837'>
          dv1v = vo(i,indx-1)<a name='3838'>
          dellav(i,indx) = eta(i,indx-1) *                    &amp;<a name='3839'>
     &amp;                     (vcko(i,indx-1) - dv1v) * g / dp<a name='3840'>
<font color=#447700>!c<a name='3841'></font>
<font color=#447700>!c  cloud water<a name='3842'></font>
<font color=#447700>!c<a name='3843'></font>
          dellal(i,indx) = eta(i,indx-1) *                    &amp;<a name='3844'>
     &amp;                     qlko_ktcon(i) * g / dp<a name='3845'>
        endif<a name='3846'>
      enddo<a name='3847'>
<font color=#447700>!c<a name='3848'></font>
<font color=#447700>!c------- final changed variable per unit mass flux<a name='3849'></font>
<font color=#447700>!c<a name='3850'></font>
      do k = 1, km<a name='3851'>
        do i = 1, im<a name='3852'>
          if (cnvflg(i).and.k .le. kmax(i)) then<a name='3853'>
            if(k.gt.ktcon(i)) then<a name='3854'>
              qo(i,k) = q1(i,k)<a name='3855'>
              to(i,k) = t1(i,k)<a name='3856'>
            endif<a name='3857'>
            if(k.le.ktcon(i)) then<a name='3858'>
              qo(i,k) = dellaq(i,k) * mbdt + q1(i,k)<a name='3859'>
              dellat = (dellah(i,k) - hvap * dellaq(i,k)) / cp<a name='3860'>
              to(i,k) = dellat * mbdt + t1(i,k)<a name='3861'>
              val   =           1.e-10<a name='3862'>
              qo(i,k) = max(qo(i,k), val  )<a name='3863'>
            endif<a name='3864'>
          endif<a name='3865'>
        enddo<a name='3866'>
      enddo<a name='3867'>
<font color=#447700>!c!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='3868'></font>
<font color=#447700>!c<a name='3869'></font>
<font color=#447700>!c--- the above changed environment is now used to calulate the<a name='3870'></font>
<font color=#447700>!c--- effect the arbitrary cloud (with unit mass flux)<a name='3871'></font>
<font color=#447700>!c--- would have on the stability,<a name='3872'></font>
<font color=#447700>!c--- which then is used to calculate the real mass flux,<a name='3873'></font>
<font color=#447700>!c--- necessary to keep this change in balance with the large-scale<a name='3874'></font>
<font color=#447700>!c--- destabilization.<a name='3875'></font>
<font color=#447700>!c<a name='3876'></font>
<font color=#447700>!c--- environmental conditions again, first heights<a name='3877'></font>
<font color=#447700>!c<a name='3878'></font>
      do k = 1, km<a name='3879'>
        do i = 1, im<a name='3880'>
          if(cnvflg(i) .and. k .le. kmax(i)) then<a name='3881'>
            qeso(i,k) = 0.01 * fpvs(to(i,k))      <font color=#447700>! fpvs is in pa<a name='3882'></font>
            qeso(i,k) = eps * qeso(i,k) / (pfld(i,k)+epsm1*qeso(i,k))<a name='3883'>
            val       =             1.e-8<a name='3884'>
            qeso(i,k) = max(qeso(i,k), val )<a name='3885'>
<font color=#447700>!           tvo(i,k)  = to(i,k) + delta * to(i,k) * qo(i,k)<a name='3886'></font>
          endif<a name='3887'>
        enddo<a name='3888'>
      enddo<a name='3889'>
<font color=#447700>!c<a name='3890'></font>
<font color=#447700>!c--- moist static energy<a name='3891'></font>
<font color=#447700>!c<a name='3892'></font>
      do k = 1, km1<a name='3893'>
        do i = 1, im<a name='3894'>
          if(cnvflg(i) .and. k .le. kmax(i)-1) then<a name='3895'>
            dz = .5 * (zo(i,k+1) - zo(i,k))<a name='3896'>
            dp = .5 * (pfld(i,k+1) - pfld(i,k))<a name='3897'>
            es = 0.01 * fpvs(to(i,k+1))      <font color=#447700>! fpvs is in pa<a name='3898'></font>
            pprime = pfld(i,k+1) + epsm1 * es<a name='3899'>
            qs = eps * es / pprime<a name='3900'>
            dqsdp = - qs / pprime<a name='3901'>
            desdt = es * (fact1 / to(i,k+1) + fact2 / (to(i,k+1)**2))<a name='3902'>
            dqsdt = qs * pfld(i,k+1) * desdt / (es * pprime)<a name='3903'>
            gamma = el2orc * qeso(i,k+1) / (to(i,k+1)**2)<a name='3904'>
            dt = (g * dz + hvap * dqsdp * dp) / (cp * (1. + gamma))<a name='3905'>
            dq = dqsdt * dt + dqsdp * dp<a name='3906'>
            to(i,k) = to(i,k+1) + dt<a name='3907'>
            qo(i,k) = qo(i,k+1) + dq<a name='3908'>
            po(i,k) = .5 * (pfld(i,k) + pfld(i,k+1))<a name='3909'>
          endif<a name='3910'>
        enddo<a name='3911'>
      enddo<a name='3912'>
      do k = 1, km1<a name='3913'>
        do i = 1, im<a name='3914'>
          if(cnvflg(i) .and. k .le. kmax(i)-1) then<a name='3915'>
            qeso(i,k) = 0.01 * fpvs(to(i,k))      <font color=#447700>! fpvs is in pa<a name='3916'></font>
            qeso(i,k) = eps * qeso(i,k) / (po(i,k) + epsm1 * qeso(i,k))<a name='3917'>
            val1      =             1.e-8<a name='3918'>
            qeso(i,k) = max(qeso(i,k), val1)<a name='3919'>
            val2      =           1.e-10<a name='3920'>
            qo(i,k)   = max(qo(i,k), val2 )<a name='3921'>
<font color=#447700>!           qo(i,k)   = min(qo(i,k),qeso(i,k))<a name='3922'></font>
            heo(i,k)   = .5 * g * (zo(i,k) + zo(i,k+1)) +     &amp;<a name='3923'>
     &amp;                    cp * to(i,k) + hvap * qo(i,k)<a name='3924'>
            heso(i,k) = .5 * g * (zo(i,k) + zo(i,k+1)) +      &amp;<a name='3925'>
     &amp;                  cp * to(i,k) + hvap * qeso(i,k)<a name='3926'>
          endif<a name='3927'>
        enddo<a name='3928'>
      enddo<a name='3929'>
      do i = 1, im<a name='3930'>
        if(cnvflg(i)) then<a name='3931'>
          k = kmax(i)<a name='3932'>
          heo(i,k) = g * zo(i,k) + cp * to(i,k) + hvap * qo(i,k)<a name='3933'>
          heso(i,k) = g * zo(i,k) + cp * to(i,k) + hvap * qeso(i,k)<a name='3934'>
<font color=#447700>!c         heo(i,k) = min(heo(i,k),heso(i,k))<a name='3935'></font>
        endif<a name='3936'>
      enddo<a name='3937'>
<font color=#447700>!c<a name='3938'></font>
<font color=#447700>!c**************************** static control<a name='3939'></font>
<font color=#447700>!c<a name='3940'></font>
<font color=#447700>!c------- moisture and cloud work functions<a name='3941'></font>
<font color=#447700>!c<a name='3942'></font>
      do i = 1, im<a name='3943'>
        if(cnvflg(i)) then<a name='3944'>
          xaa0(i) = 0.<a name='3945'>
          xpwav(i) = 0.<a name='3946'>
        endif<a name='3947'>
      enddo<a name='3948'>
<font color=#447700>!c<a name='3949'></font>
      do i = 1, im<a name='3950'>
        if(cnvflg(i)) then<a name='3951'>
          indx = kb(i)<a name='3952'>
          hcko(i,indx) = heo(i,indx)<a name='3953'>
          qcko(i,indx) = qo(i,indx)<a name='3954'>
        endif<a name='3955'>
      enddo<a name='3956'>
      do k = 2, km1<a name='3957'>
        do i = 1, im<a name='3958'>
          if (cnvflg(i)) then<a name='3959'>
            if(k.gt.kb(i).and.k.le.ktcon(i)) then<a name='3960'>
              dz = zi(i,k) - zi(i,k-1)<a name='3961'>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='3962'>
              tem1 = 0.5 * xlamud(i) * dz<a name='3963'>
              factor = 1. + tem - tem1<a name='3964'>
              hcko(i,k) = ((1.-tem1)*hcko(i,k-1)+tem*0.5*    &amp;<a name='3965'>
     &amp;                     (heo(i,k)+heo(i,k-1)))/factor<a name='3966'>
            endif<a name='3967'>
          endif<a name='3968'>
        enddo<a name='3969'>
      enddo<a name='3970'>
      do k = 2, km1<a name='3971'>
        do i = 1, im<a name='3972'>
          if (cnvflg(i)) then<a name='3973'>
            if(k.gt.kb(i).and.k.lt.ktcon(i)) then<a name='3974'>
              dz = zi(i,k) - zi(i,k-1)<a name='3975'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='3976'>
              xdby = hcko(i,k) - heso(i,k)<a name='3977'>
              xqrch = qeso(i,k)                             &amp;<a name='3978'>
     &amp;              + gamma * xdby / (hvap * (1. + gamma))<a name='3979'>
<font color=#447700>!cj<a name='3980'></font>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='3981'>
              tem1 = 0.5 * xlamud(i) * dz<a name='3982'>
              factor = 1. + tem - tem1<a name='3983'>
              qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*   &amp;<a name='3984'>
     &amp;                     (qo(i,k)+qo(i,k-1)))/factor<a name='3985'>
<font color=#447700>!cj<a name='3986'></font>
              dq = eta(i,k) * (qcko(i,k) - xqrch)<a name='3987'>
<font color=#447700>!c<a name='3988'></font>
              if(k.ge.kbcon(i).and.dq.gt.0.) then<a name='3989'>
                etah = .5 * (eta(i,k) + eta(i,k-1))<a name='3990'>
                if(ncloud.gt.0..and.k.gt.jmin(i)) then<a name='3991'>
                  qlk = dq / (eta(i,k) + etah * (c0 + c1) * dz)<a name='3992'>
                else<a name='3993'>
                  qlk = dq / (eta(i,k) + etah * c0 * dz)<a name='3994'>
                endif<a name='3995'>
                if(k.lt.ktcon1(i)) then<a name='3996'>
                  xaa0(i) = xaa0(i) - dz * g * qlk<a name='3997'>
                endif<a name='3998'>
                qcko(i,k) = qlk + xqrch<a name='3999'>
                xpw = etah * c0 * dz * qlk<a name='4000'>
                xpwav(i) = xpwav(i) + xpw<a name='4001'>
              endif<a name='4002'>
            endif<a name='4003'>
            if(k.ge.kbcon(i).and.k.lt.ktcon1(i)) then<a name='4004'>
              dz1 = zo(i,k+1) - zo(i,k)<a name='4005'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='4006'>
              rfact =  1. + delta * cp * gamma          &amp;<a name='4007'>
     &amp;                 * to(i,k) / hvap<a name='4008'>
              xaa0(i) = xaa0(i)                         &amp;<a name='4009'>
     &amp;                + dz1 * (g / (cp * to(i,k)))      &amp;<a name='4010'>
     &amp;                * xdby / (1. + gamma)             &amp;<a name='4011'>
     &amp;                * rfact<a name='4012'>
              val=0.<a name='4013'>
              xaa0(i)=xaa0(i)+                          &amp;<a name='4014'>
     &amp;                 dz1 * g * delta *                &amp;<a name='4015'>
     &amp;                 max(val,(qeso(i,k) - qo(i,k)))<a name='4016'>
            endif<a name='4017'>
          endif<a name='4018'>
        enddo<a name='4019'>
      enddo<a name='4020'>
<font color=#447700>!c<a name='4021'></font>
<font color=#447700>!c------- downdraft calculations<a name='4022'></font>
<font color=#447700>!c<a name='4023'></font>
<font color=#447700>!c--- downdraft moisture properties<a name='4024'></font>
<font color=#447700>!c<a name='4025'></font>
      do i = 1, im<a name='4026'>
        if(cnvflg(i)) then<a name='4027'>
          jmn = jmin(i)<a name='4028'>
          hcdo(i,jmn) = heo(i,jmn)<a name='4029'>
          qcdo(i,jmn) = qo(i,jmn)<a name='4030'>
          qrcd(i,jmn) = qeso(i,jmn)<a name='4031'>
          xpwev(i) = 0.<a name='4032'>
        endif<a name='4033'>
      enddo<a name='4034'>
<font color=#447700>!cj<a name='4035'></font>
      do k = km1, 1, -1<a name='4036'>
        do i = 1, im<a name='4037'>
          if (cnvflg(i) .and. k.lt.jmin(i)) then<a name='4038'>
              dz = zi(i,k+1) - zi(i,k)<a name='4039'>
              if(k.ge.kbcon(i)) then<a name='4040'>
                 tem  = xlamde * dz<a name='4041'>
                 tem1 = 0.5 * xlamdd * dz<a name='4042'>
              else<a name='4043'>
                 tem  = xlamde * dz<a name='4044'>
                 tem1 = 0.5 * (xlamd(i)+xlamdd) * dz<a name='4045'>
              endif<a name='4046'>
              factor = 1. + tem - tem1<a name='4047'>
              hcdo(i,k) = ((1.-tem1)*hcdo(i,k+1)+tem*0.5*      &amp;<a name='4048'>
     &amp;                     (heo(i,k)+heo(i,k+1)))/factor<a name='4049'>
          endif<a name='4050'>
        enddo<a name='4051'>
      enddo<a name='4052'>
<font color=#447700>!cj<a name='4053'></font>
      do k = km1, 1, -1<a name='4054'>
        do i = 1, im<a name='4055'>
          if (cnvflg(i) .and. k .lt. jmin(i)) then<a name='4056'>
              dq = qeso(i,k)<a name='4057'>
              dt = to(i,k)<a name='4058'>
              gamma    = el2orc * dq / dt**2<a name='4059'>
              dh       = hcdo(i,k) - heso(i,k)<a name='4060'>
              qrcd(i,k)=dq+(1./hvap)*(gamma/(1.+gamma))*dh<a name='4061'>
<font color=#447700>!             detad    = etad(i,k+1) - etad(i,k)<a name='4062'></font>
<font color=#447700>!cj<a name='4063'></font>
              dz = zi(i,k+1) - zi(i,k)<a name='4064'>
              if(k.ge.kbcon(i)) then<a name='4065'>
                 tem  = xlamde * dz<a name='4066'>
                 tem1 = 0.5 * xlamdd * dz<a name='4067'>
              else<a name='4068'>
                 tem  = xlamde * dz<a name='4069'>
                 tem1 = 0.5 * (xlamd(i)+xlamdd) * dz<a name='4070'>
              endif<a name='4071'>
              factor = 1. + tem - tem1<a name='4072'>
              qcdo(i,k) = ((1.-tem1)*qcdo(i,k+1)+tem*0.5*     &amp;<a name='4073'>
     &amp;                     (qo(i,k)+qo(i,k+1)))/factor<a name='4074'>
<font color=#447700>!cj<a name='4075'></font>
<font color=#447700>!             xpwd     = etad(i,k+1) * qcdo(i,k+1) -<a name='4076'></font>
<font color=#447700>!    &amp;                   etad(i,k) * qrcd(i,k)<a name='4077'></font>
<font color=#447700>!             xpwd     = xpwd - detad *<a name='4078'></font>
<font color=#447700>!    &amp;                 .5 * (qrcd(i,k) + qrcd(i,k+1))<a name='4079'></font>
<font color=#447700>!cj<a name='4080'></font>
              xpwd     = etad(i,k+1) * (qcdo(i,k) - qrcd(i,k))<a name='4081'>
              qcdo(i,k)= qrcd(i,k)<a name='4082'>
              xpwev(i) = xpwev(i) + xpwd<a name='4083'>
          endif<a name='4084'>
        enddo<a name='4085'>
      enddo<a name='4086'>
<font color=#447700>!c<a name='4087'></font>
      do i = 1, im<a name='4088'>
        edtmax = edtmaxl<a name='4089'>
        if(slimsk(i).eq.0.) edtmax = edtmaxs<a name='4090'>
        if(cnvflg(i)) then<a name='4091'>
          if(xpwev(i).ge.0.) then<a name='4092'>
            edtx(i) = 0.<a name='4093'>
          else<a name='4094'>
            edtx(i) = -edtx(i) * xpwav(i) / xpwev(i)<a name='4095'>
            edtx(i) = min(edtx(i),edtmax)<a name='4096'>
          endif<a name='4097'>
        endif<a name='4098'>
      enddo<a name='4099'>
<font color=#447700>!c<a name='4100'></font>
<font color=#447700>!c<a name='4101'></font>
<font color=#447700>!c--- downdraft cloudwork functions<a name='4102'></font>
<font color=#447700>!c<a name='4103'></font>
<font color=#447700>!c<a name='4104'></font>
      do k = km1, 1, -1<a name='4105'>
        do i = 1, im<a name='4106'>
          if (cnvflg(i) .and. k.lt.jmin(i)) then<a name='4107'>
              gamma = el2orc * qeso(i,k) / to(i,k)**2<a name='4108'>
              dhh=hcdo(i,k)<a name='4109'>
              dt= to(i,k)<a name='4110'>
              dg= gamma<a name='4111'>
              dh= heso(i,k)<a name='4112'>
              dz=-1.*(zo(i,k+1)-zo(i,k))<a name='4113'>
              xaa0(i)=xaa0(i)+edtx(i)*dz*(g/(cp*dt))*((dhh-dh)/(1.+dg)) &amp;<a name='4114'>
     &amp;                *(1.+delta*cp*dg*dt/hvap)<a name='4115'>
              val=0.<a name='4116'>
              xaa0(i)=xaa0(i)+edtx(i)*                         &amp;<a name='4117'>
     &amp;        dz*g*delta*max(val,(qeso(i,k)-qo(i,k)))<a name='4118'>
          endif<a name='4119'>
        enddo<a name='4120'>
      enddo<a name='4121'>
<font color=#447700>!c<a name='4122'></font>
<font color=#447700>!c  calculate critical cloud work function<a name='4123'></font>
<font color=#447700>!c<a name='4124'></font>
      do i = 1, im<a name='4125'>
        if(cnvflg(i)) then<a name='4126'>
          if(pfld(i,ktcon(i)).lt.pcrit(15))then<a name='4127'>
            acrt(i)=acrit(15)*(975.-pfld(i,ktcon(i)))          &amp;<a name='4128'>
     &amp;              /(975.-pcrit(15))<a name='4129'>
          else if(pfld(i,ktcon(i)).gt.pcrit(1))then<a name='4130'>
            acrt(i)=acrit(1)<a name='4131'>
          else<a name='4132'>
            k =  int((850. - pfld(i,ktcon(i)))/50.) + 2<a name='4133'>
            k = min(k,15)<a name='4134'>
            k = max(k,2)<a name='4135'>
            acrt(i)=acrit(k)+(acrit(k-1)-acrit(k))*            &amp;<a name='4136'>
     &amp;           (pfld(i,ktcon(i))-pcrit(k))/(pcrit(k-1)-pcrit(k))<a name='4137'>
          endif<a name='4138'>
        endif<a name='4139'>
      enddo<a name='4140'>
      do i = 1, im<a name='4141'>
        if(cnvflg(i)) then<a name='4142'>
          if(slimsk(i).eq.1.) then<a name='4143'>
            w1 = w1l<a name='4144'>
            w2 = w2l<a name='4145'>
            w3 = w3l<a name='4146'>
            w4 = w4l<a name='4147'>
          else<a name='4148'>
            w1 = w1s<a name='4149'>
            w2 = w2s<a name='4150'>
            w3 = w3s<a name='4151'>
            w4 = w4s<a name='4152'>
          endif<a name='4153'>
<font color=#447700>!c<a name='4154'></font>
<font color=#447700>!c  modify critical cloud workfunction by cloud base vertical velocity<a name='4155'></font>
<font color=#447700>!c<a name='4156'></font>
          if(pdot(i).le.w4) then<a name='4157'>
            acrtfct(i) = (pdot(i) - w4) / (w3 - w4)<a name='4158'>
          elseif(pdot(i).ge.-w4) then<a name='4159'>
            acrtfct(i) = - (pdot(i) + w4) / (w4 - w3)<a name='4160'>
          else<a name='4161'>
            acrtfct(i) = 0.<a name='4162'>
          endif<a name='4163'>
          val1    =             -1.<a name='4164'>
          acrtfct(i) = max(acrtfct(i),val1)<a name='4165'>
          val2    =             1.<a name='4166'>
          acrtfct(i) = min(acrtfct(i),val2)<a name='4167'>
          acrtfct(i) = 1. - acrtfct(i)<a name='4168'>
<font color=#447700>!c<a name='4169'></font>
<font color=#447700>!c  modify acrtfct(i) by colume mean rh if rhbar(i) is greater than 80 percent<a name='4170'></font>
<font color=#447700>!c<a name='4171'></font>
<font color=#447700>!c         if(rhbar(i).ge..8) then<a name='4172'></font>
<font color=#447700>!c           acrtfct(i) = acrtfct(i) * (.9 - min(rhbar(i),.9)) * 10.<a name='4173'></font>
<font color=#447700>!c         endif<a name='4174'></font>
<font color=#447700>!c<a name='4175'></font>
<font color=#447700>!c  modify adjustment time scale by cloud base vertical velocity<a name='4176'></font>
<font color=#447700>!c<a name='4177'></font>
          val1=0.<a name='4178'>
          dtconv(i) = dt2 + max((1800. - dt2),val1) *         &amp;<a name='4179'>
     &amp;                (pdot(i) - w2) / (w1 - w2)<a name='4180'>
<font color=#447700>!c         dtconv(i) = max(dtconv(i), dt2)<a name='4181'></font>
<font color=#447700>!c         dtconv(i) = 1800. * (pdot(i) - w2) / (w1 - w2)<a name='4182'></font>
          dtconv(i) = max(dtconv(i),dtmin)<a name='4183'>
          dtconv(i) = min(dtconv(i),dtmax)<a name='4184'>
<font color=#447700>!c<a name='4185'></font>
        endif<a name='4186'>
      enddo<a name='4187'>
<font color=#447700>!c<a name='4188'></font>
<font color=#447700>!c--- large scale forcing<a name='4189'></font>
<font color=#447700>!c<a name='4190'></font>
      xmbmx1=-1.e20<a name='4191'>
      do i= 1, im<a name='4192'>
        if(cnvflg(i)) then<a name='4193'>
          fld(i)=(aa1(i)-acrt(i)* acrtfct(i))/dtconv(i)<a name='4194'>
          if(fld(i).le.0.) cnvflg(i) = .false.<a name='4195'>
        endif<a name='4196'>
        if(cnvflg(i)) then<a name='4197'>
<font color=#447700>!c         xaa0(i) = max(xaa0(i),0.)<a name='4198'></font>
          xk(i) = (xaa0(i) - aa1(i)) / mbdt<a name='4199'>
          if(xk(i).ge.0.) cnvflg(i) = .false.<a name='4200'>
        endif<a name='4201'>
<font color=#447700>!c<a name='4202'></font>
<font color=#447700>!c--- kernel, cloud base mass flux<a name='4203'></font>
<font color=#447700>!c<a name='4204'></font>
        if(cnvflg(i)) then<a name='4205'>
          xmb(i) = -fld(i) / xk(i)<a name='4206'>
          xmb(i) = min(xmb(i),xmbmax(i))<a name='4207'>
          xmbmx1=max(xmbmx1,xmb(i))<a name='4208'>
        endif<a name='4209'>
      enddo<a name='4210'>
<font color=#447700>!      if(xmbmx1.gt.0.4)print*,'qingfu test xmbmx1=',xmbmx1<a name='4211'></font>
<font color=#447700>!!<a name='4212'></font>
      totflg = .true.<a name='4213'>
      do i=1,im<a name='4214'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='4215'>
      enddo<a name='4216'>
      if(totflg) return<a name='4217'>
<font color=#447700>!!<a name='4218'></font>
<font color=#447700>!c<a name='4219'></font>
<font color=#447700>!c  restore to,qo,uo,vo to t1,q1,u1,v1 in case convection stops<a name='4220'></font>
<font color=#447700>!c<a name='4221'></font>
      do k = 1, km<a name='4222'>
        do i = 1, im<a name='4223'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='4224'>
            to(i,k) = t1(i,k)<a name='4225'>
            qo(i,k) = q1(i,k)<a name='4226'>
            uo(i,k) = u1(i,k)<a name='4227'>
            vo(i,k) = v1(i,k)<a name='4228'>
            qeso(i,k) = 0.01 * fpvs(t1(i,k))      <font color=#447700>! fpvs is in pa<a name='4229'></font>
            qeso(i,k) = eps * qeso(i,k) / (pfld(i,k) + epsm1*qeso(i,k))<a name='4230'>
            val     =             1.e-8<a name='4231'>
            qeso(i,k) = max(qeso(i,k), val )<a name='4232'>
          endif<a name='4233'>
        enddo<a name='4234'>
      enddo<a name='4235'>
<font color=#447700>!c!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='4236'></font>
<font color=#447700>!c<a name='4237'></font>
<font color=#447700>!c--- feedback: simply the changes from the cloud with unit mass flux<a name='4238'></font>
<font color=#447700>!c---           multiplied by  the mass flux necessary to keep the<a name='4239'></font>
<font color=#447700>!c---           equilibrium with the larger-scale.<a name='4240'></font>
<font color=#447700>!c<a name='4241'></font>
      do i = 1, im<a name='4242'>
        delhbar(i) = 0.<a name='4243'>
        delqbar(i) = 0.<a name='4244'>
        deltbar(i) = 0.<a name='4245'>
        delubar(i) = 0.<a name='4246'>
        delvbar(i) = 0.<a name='4247'>
        qcond(i) = 0.<a name='4248'>
      enddo<a name='4249'>
      do k = 1, km<a name='4250'>
        do i = 1, im<a name='4251'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='4252'>
            if(k.le.ktcon(i)) then<a name='4253'>
              dellat = (dellah(i,k) - hvap * dellaq(i,k)) / cp<a name='4254'>
              t1(i,k) = t1(i,k) + dellat * xmb(i) * dt2<a name='4255'>
              q1(i,k) = q1(i,k) + dellaq(i,k) * xmb(i) * dt2<a name='4256'>
              tem = 1./rcs(i)<a name='4257'>
              u1(i,k) = u1(i,k) + dellau(i,k) * xmb(i) * dt2 * tem<a name='4258'>
              v1(i,k) = v1(i,k) + dellav(i,k) * xmb(i) * dt2 * tem<a name='4259'>
              dp = 1000. * del(i,k)<a name='4260'>
              delhbar(i) = delhbar(i) + dellah(i,k)*xmb(i)*dp/g<a name='4261'>
              delqbar(i) = delqbar(i) + dellaq(i,k)*xmb(i)*dp/g<a name='4262'>
              deltbar(i) = deltbar(i) + dellat*xmb(i)*dp/g<a name='4263'>
              delubar(i) = delubar(i) + dellau(i,k)*xmb(i)*dp/g<a name='4264'>
              delvbar(i) = delvbar(i) + dellav(i,k)*xmb(i)*dp/g<a name='4265'>
            endif<a name='4266'>
          endif<a name='4267'>
        enddo<a name='4268'>
      enddo<a name='4269'>
      do k = 1, km<a name='4270'>
        do i = 1, im<a name='4271'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='4272'>
            if(k.le.ktcon(i)) then<a name='4273'>
              qeso(i,k) = 0.01 * fpvs(t1(i,k))      <font color=#447700>! fpvs is in pa<a name='4274'></font>
              qeso(i,k) = eps * qeso(i,k)/(pfld(i,k) + epsm1*qeso(i,k))<a name='4275'>
              val     =             1.e-8<a name='4276'>
              qeso(i,k) = max(qeso(i,k), val )<a name='4277'>
            endif<a name='4278'>
          endif<a name='4279'>
        enddo<a name='4280'>
      enddo<a name='4281'>
<font color=#447700>!c<a name='4282'></font>
      do i = 1, im<a name='4283'>
        rntot(i) = 0.<a name='4284'>
        delqev(i) = 0.<a name='4285'>
        delq2(i) = 0.<a name='4286'>
        flg(i) = cnvflg(i)<a name='4287'>
      enddo<a name='4288'>
      do k = km, 1, -1<a name='4289'>
        do i = 1, im<a name='4290'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='4291'>
            if(k.lt.ktcon(i)) then<a name='4292'>
              aup = 1.<a name='4293'>
              if(k.le.kb(i)) aup = 0.<a name='4294'>
              adw = 1.<a name='4295'>
              if(k.ge.jmin(i)) adw = 0.<a name='4296'>
              rain =  aup * pwo(i,k) + adw * edto(i) * pwdo(i,k)<a name='4297'>
              rntot(i) = rntot(i) + rain * xmb(i) * .001 * dt2<a name='4298'>
            endif<a name='4299'>
          endif<a name='4300'>
        enddo<a name='4301'>
      enddo<a name='4302'>
      do k = km, 1, -1<a name='4303'>
        do i = 1, im<a name='4304'>
          if (k .le. kmax(i)) then<a name='4305'>
            deltv(i) = 0.<a name='4306'>
            delq(i) = 0.<a name='4307'>
            qevap(i) = 0.<a name='4308'>
            if(cnvflg(i).and.k.lt.ktcon(i)) then<a name='4309'>
              aup = 1.<a name='4310'>
              if(k.le.kb(i)) aup = 0.<a name='4311'>
              adw = 1.<a name='4312'>
              if(k.ge.jmin(i)) adw = 0.<a name='4313'>
              rain =  aup * pwo(i,k) + adw * edto(i) * pwdo(i,k)<a name='4314'>
              rn(i) = rn(i) + rain * xmb(i) * .001 * dt2<a name='4315'>
            endif<a name='4316'>
            if(flg(i).and.k.lt.ktcon(i)) then<a name='4317'>
              evef = edt(i) * evfact<a name='4318'>
              if(slimsk(i).eq.1.) evef=edt(i) * evfactl<a name='4319'>
<font color=#447700>!             if(slimsk(i).eq.1.) evef=.07<a name='4320'></font>
<font color=#447700>!c             if(slimsk(i).ne.1.) evef = 0.<a name='4321'></font>
              qcond(i) = evef * (q1(i,k) - qeso(i,k))     &amp;<a name='4322'>
     &amp;                 / (1. + el2orc * qeso(i,k) / t1(i,k)**2)<a name='4323'>
              dp = 1000. * del(i,k)<a name='4324'>
              if(rn(i).gt.0..and.qcond(i).lt.0.) then<a name='4325'>
                qevap(i) = -qcond(i) * (1.-exp(-.32*sqrt(dt2*rn(i))))<a name='4326'>
                qevap(i) = min(qevap(i), rn(i)*1000.*g/dp)<a name='4327'>
                delq2(i) = delqev(i) + .001 * qevap(i) * dp / g<a name='4328'>
              endif<a name='4329'>
              if(rn(i).gt.0..and.qcond(i).lt.0..and.      &amp;<a name='4330'>
     &amp;           delq2(i).gt.rntot(i)) then<a name='4331'>
                qevap(i) = 1000.* g * (rntot(i) - delqev(i)) / dp<a name='4332'>
                flg(i) = .false.<a name='4333'>
              endif<a name='4334'>
              if(rn(i).gt.0..and.qevap(i).gt.0.) then<a name='4335'>
                q1(i,k) = q1(i,k) + qevap(i)<a name='4336'>
                t1(i,k) = t1(i,k) - elocp * qevap(i)<a name='4337'>
                rn(i) = rn(i) - .001 * qevap(i) * dp / g<a name='4338'>
                deltv(i) = - elocp*qevap(i)/dt2<a name='4339'>
                delq(i) =  + qevap(i)/dt2<a name='4340'>
                delqev(i) = delqev(i) + .001*dp*qevap(i)/g<a name='4341'>
              endif<a name='4342'>
              dellaq(i,k) = dellaq(i,k) + delq(i) / xmb(i)<a name='4343'>
              delqbar(i) = delqbar(i) + delq(i)*dp/g<a name='4344'>
              deltbar(i) = deltbar(i) + deltv(i)*dp/g<a name='4345'>
            endif<a name='4346'>
          endif<a name='4347'>
        enddo<a name='4348'>
      enddo<a name='4349'>
<font color=#447700>!cj<a name='4350'></font>
<font color=#447700>!     do i = 1, im<a name='4351'></font>
<font color=#447700>!     if(me.eq.31.and.cnvflg(i)) then<a name='4352'></font>
<font color=#447700>!     if(cnvflg(i)) then<a name='4353'></font>
<font color=#447700>!       print *, ' deep delhbar, delqbar, deltbar = ',<a name='4354'></font>
<font color=#447700>!    &amp;             delhbar(i),hvap*delqbar(i),cp*deltbar(i)<a name='4355'></font>
<font color=#447700>!       print *, ' deep delubar, delvbar = ',delubar(i),delvbar(i)<a name='4356'></font>
<font color=#447700>!       print *, ' precip =', hvap*rn(i)*1000./dt2<a name='4357'></font>
<font color=#447700>!       print*,'pdif= ',pfld(i,kbcon(i))-pfld(i,ktcon(i))<a name='4358'></font>
<font color=#447700>!     endif<a name='4359'></font>
<font color=#447700>!     enddo<a name='4360'></font>
<font color=#447700>!c<a name='4361'></font>
<font color=#447700>!c  precipitation rate converted to actual precip<a name='4362'></font>
<font color=#447700>!c  in unit of m instead of kg<a name='4363'></font>
<font color=#447700>!c<a name='4364'></font>
      do i = 1, im<a name='4365'>
        if(cnvflg(i)) then<a name='4366'>
<font color=#447700>!c<a name='4367'></font>
<font color=#447700>!c  in the event of upper level rain evaporation and lower level downdraft<a name='4368'></font>
<font color=#447700>!c    moistening, rn can become negative, in this case, we back out of the<a name='4369'></font>
<font color=#447700>!c    heating and the moistening<a name='4370'></font>
<font color=#447700>!c<a name='4371'></font>
          if(rn(i).lt.0..and..not.flg(i)) rn(i) = 0.<a name='4372'>
          if(rn(i).le.0.) then<a name='4373'>
            rn(i) = 0.<a name='4374'>
          else<a name='4375'>
            ktop(i) = ktcon(i)<a name='4376'>
            kbot(i) = kbcon(i)<a name='4377'>
            kcnv(i) = 1<a name='4378'>
            cldwrk(i) = aa1(i)<a name='4379'>
          endif<a name='4380'>
        endif<a name='4381'>
      enddo<a name='4382'>
<font color=#447700>!c<a name='4383'></font>
<font color=#447700>!c  cloud water<a name='4384'></font>
<font color=#447700>!c<a name='4385'></font>
      if (ncloud.gt.0) then<a name='4386'>
<font color=#447700>!<a name='4387'></font>
      val1=1.0<a name='4388'>
      val2=0.0<a name='4389'>
      do k = 1, km<a name='4390'>
        do i = 1, im<a name='4391'>
          if (cnvflg(i) .and. rn(i).gt.0.) then<a name='4392'>
            if (k.gt.kb(i).and.k.le.ktcon(i)) then<a name='4393'>
              tem  = dellal(i,k) * xmb(i) * dt2<a name='4394'>
              tem1 = max(val2, min(val1, (tcr-t1(i,k))*tcrf))<a name='4395'>
              if (ql(i,k,2) .gt. -999.0) then<a name='4396'>
                ql(i,k,1) = ql(i,k,1) + tem * tem1            <font color=#447700>! ice<a name='4397'></font>
                ql(i,k,2) = ql(i,k,2) + tem *(1.0-tem1)       <font color=#447700>! water<a name='4398'></font>
              else<a name='4399'>
                ql(i,k,1) = ql(i,k,1) + tem<a name='4400'>
              endif<a name='4401'>
            endif<a name='4402'>
          endif<a name='4403'>
        enddo<a name='4404'>
      enddo<a name='4405'>
<font color=#447700>!<a name='4406'></font>
      endif<a name='4407'>
<font color=#447700>!c<a name='4408'></font>
      do k = 1, km<a name='4409'>
        do i = 1, im<a name='4410'>
          if(cnvflg(i).and.rn(i).le.0.) then<a name='4411'>
            if (k .le. kmax(i)) then<a name='4412'>
              t1(i,k) = to(i,k)<a name='4413'>
              q1(i,k) = qo(i,k)<a name='4414'>
              u1(i,k) = uo(i,k)<a name='4415'>
              v1(i,k) = vo(i,k)<a name='4416'>
            endif<a name='4417'>
          endif<a name='4418'>
        enddo<a name='4419'>
      enddo<a name='4420'>
<font color=#447700>!<a name='4421'></font>
<font color=#447700>! hchuang code change<a name='4422'></font>
<font color=#447700>!<a name='4423'></font>
<font color=#447700>!      do k = 1, km<a name='4424'></font>
<font color=#447700>!        do i = 1, im<a name='4425'></font>
<font color=#447700>!          if(cnvflg(i).and.rn(i).gt.0.) then<a name='4426'></font>
<font color=#447700>!            if(k.ge.kb(i) .and. k.lt.ktop(i)) then<a name='4427'></font>
<font color=#447700>!              ud_mf(i,k) = eta(i,k) * xmb(i) * dt2<a name='4428'></font>
<font color=#447700>!            endif<a name='4429'></font>
<font color=#447700>!          endif<a name='4430'></font>
<font color=#447700>!        enddo<a name='4431'></font>
<font color=#447700>!      enddo<a name='4432'></font>
<font color=#447700>!      do i = 1, im<a name='4433'></font>
<font color=#447700>!        if(cnvflg(i).and.rn(i).gt.0.) then<a name='4434'></font>
<font color=#447700>!           k = ktop(i)-1<a name='4435'></font>
<font color=#447700>!           dt_mf(i,k) = ud_mf(i,k)<a name='4436'></font>
<font color=#447700>!        endif<a name='4437'></font>
<font color=#447700>!      enddo<a name='4438'></font>
<font color=#447700>!      do k = 1, km<a name='4439'></font>
<font color=#447700>!        do i = 1, im<a name='4440'></font>
<font color=#447700>!          if(cnvflg(i).and.rn(i).gt.0.) then<a name='4441'></font>
<font color=#447700>!            if(k.ge.1 .and. k.le.jmin(i)) then<a name='4442'></font>
<font color=#447700>!              dd_mf(i,k) = edto(i) * etad(i,k) * xmb(i) * dt2<a name='4443'></font>
<font color=#447700>!            endif<a name='4444'></font>
<font color=#447700>!          endif<a name='4445'></font>
<font color=#447700>!        enddo<a name='4446'></font>
<font color=#447700>!      enddo<a name='4447'></font>
<font color=#447700>!!<a name='4448'></font>
      return<a name='4449'>
      end subroutine sascnvn      <a name='4450'>
<a name='4451'>
<A NAME='SHALCNV'><A href='../../html_code/phys/module_cu_sas.F.html#SHALCNV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4452'>
      <font color=#993300>subroutine </font><font color=#cc0000>shalcnv</font>(im,ix,km,jcap,delt,del,prsl,ps,phil,ql,   &amp; <A href='../../call_to/SHALCNV.html' TARGET='index'>1</A>,<A href='../../call_from/SHALCNV.html' TARGET='index'>3</A><a name='4453'>
     &amp;     q1,t1,u1,v1,rcs,rn,kbot,ktop,kcnv,slimsk,               &amp;<a name='4454'>
     &amp;     dot,ncloud,hpbl,heat,evap,pgcon)<a name='4455'>
<font color=#447700>!<a name='4456'></font>
      use <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_machine</A><A href='../../html_code/phys/module_cu_sas.F.html#SHALCNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_22"> , only : kind_phys<a name='4457'>
      use <A href='../../html_code/phys/module_gfs_funcphys.F.html#MODULE_GFS_FUNCPHYS'>MODULE_GFS_funcphys</A><A href='../../html_code/phys/module_cu_sas.F.html#SHALCNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_FUNCPHYS_8"> , only : fpvs<a name='4458'>
      use <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_physcons</A><A href='../../html_code/phys/module_cu_sas.F.html#SHALCNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_14">, grav =&gt; con_g, cp =&gt; con_cp, hvap =&gt; con_hvap         &amp;<a name='4459'>
     &amp;,             rv =&gt; con_rv, fv =&gt; con_fvirt, t0c =&gt; con_t0c         &amp;<a name='4460'>
     &amp;,             rd =&gt; con_rd, cvap =&gt; con_cvap, cliq =&gt; con_cliq      &amp;<a name='4461'>
     &amp;,             eps =&gt; con_eps, epsm1 =&gt; con_epsm1<a name='4462'>
      implicit none<a name='4463'>
<font color=#447700>!<a name='4464'></font>
      integer            im, ix,  km, jcap, ncloud,                       &amp;<a name='4465'>
     &amp;                   kbot(im), ktop(im), kcnv(im)                   <a name='4466'>
      real(kind=kind_phys) delt<a name='4467'>
      real(kind=kind_phys) ps(im),     del(ix,km),  prsl(ix,km),          &amp;<a name='4468'>
     &amp;                     ql(ix,km,2),q1(ix,km),   t1(ix,km),            &amp;<a name='4469'>
     &amp;                     u1(ix,km),  v1(ix,km),   rcs(im),              &amp;<a name='4470'>
     &amp;                     rn(im),     slimsk(im),                        &amp;<a name='4471'>
     &amp;                     dot(ix,km), phil(ix,km), hpbl(im),             &amp;<a name='4472'>
     &amp;                     heat(im),   evap(im)                           <a name='4473'>
<font color=#447700>!     &amp;,                    ud_mf(im,km),dt_mf(im,km)<a name='4474'></font>
<a name='4475'>
      real  ud_mf(im,km),dt_mf(im,km)<a name='4476'>
<font color=#447700>!<a name='4477'></font>
      integer              i,j,indx, jmn, k, kk, latd, lond, km1<a name='4478'>
      integer              kpbl(im)<a name='4479'>
<font color=#447700>!<a name='4480'></font>
      real(kind=kind_phys) c0,      cpoel,   dellat,  delta,        &amp;<a name='4481'>
     &amp;                     desdt,   deta,    detad,   dg,           &amp;<a name='4482'>
     &amp;                     dh,      dhh,     dlnsig,  dp,           &amp;<a name='4483'>
     &amp;                     dq,      dqsdp,   dqsdt,   dt,           &amp;<a name='4484'>
     &amp;                     dt2,     dtmax,   dtmin,   dv1h,         &amp;<a name='4485'>
     &amp;                     dv1q,    dv2h,    dv2q,    dv1u,         &amp;<a name='4486'>
     &amp;                     dv1v,    dv2u,    dv2v,    dv3q,         &amp;<a name='4487'>
     &amp;                     dv3h,    dv3u,    dv3v,    clam,         &amp;<a name='4488'>
     &amp;                     dz,      dz1,     e1,                    &amp;<a name='4489'>
     &amp;                     el2orc,  elocp,   aafac,   cthk,         &amp;<a name='4490'>
     &amp;                     es,      etah,    h1,      dthk,         &amp;<a name='4491'>
     &amp;                     evef,    evfact,  evfactl, fact1,        &amp;<a name='4492'>
     &amp;                     fact2,   factor,  fjcap,                 &amp;<a name='4493'>
     &amp;                     g,       gamma,   pprime,  betaw,        &amp;<a name='4494'>
     &amp;                     qlk,     qrch,    qs,      c1,           &amp;<a name='4495'>
     &amp;                     rain,    rfact,   shear,   tem1,         &amp;<a name='4496'>
     &amp;                     tem2,    terr,    val,     val1,         &amp;<a name='4497'>
     &amp;                     val2,    w1,      w1l,     w1s,          &amp;<a name='4498'>
     &amp;                     w2,      w2l,     w2s,     w3,           &amp;<a name='4499'>
     &amp;                     w3l,     w3s,     w4,      w4l,          &amp;<a name='4500'>
     &amp;                     w4s,     tem,     ptem,    ptem1,        &amp;<a name='4501'>
     &amp;                     pgcon<a name='4502'>
<font color=#447700>!<a name='4503'></font>
      integer              kb(im), kbcon(im), kbcon1(im),           &amp;<a name='4504'>
     &amp;                     ktcon(im), ktcon1(im),                   &amp;<a name='4505'>
     &amp;                     kbm(im), kmax(im)<a name='4506'>
<font color=#447700>!<a name='4507'></font>
      real(kind=kind_phys) aa1(im),                                 &amp;<a name='4508'>
     &amp;                     delhbar(im), delq(im),   delq2(im),      &amp;<a name='4509'>
     &amp;                     delqbar(im), delqev(im), deltbar(im),    &amp;<a name='4510'>
     &amp;                     deltv(im),   edt(im),                    &amp;<a name='4511'>
     &amp;                     wstar(im),   sflx(im),                   &amp;<a name='4512'>
     &amp;                     pdot(im),    po(im,km),                  &amp;<a name='4513'>
     &amp;                     qcond(im),   qevap(im),  hmax(im),       &amp;<a name='4514'>
     &amp;                     rntot(im),   vshear(im),                 &amp;<a name='4515'>
     &amp;                     xlamud(im),  xmb(im),    xmbmax(im),     &amp;<a name='4516'>
     &amp;                     delubar(im), delvbar(im)<a name='4517'>
<font color=#447700>!c<a name='4518'></font>
      real(kind=kind_phys) cincr, cincrmax, cincrmin<a name='4519'>
<font color=#447700>!cc<a name='4520'></font>
<font color=#447700>!c  physical parameters<a name='4521'></font>
      parameter(g=grav)<a name='4522'>
      parameter(cpoel=cp/hvap,elocp=hvap/cp,                            &amp;<a name='4523'>
     &amp;          el2orc=hvap*hvap/(rv*cp))<a name='4524'>
      parameter(terr=0.,c0=.002,c1=5.e-4,delta=fv)<a name='4525'>
      parameter(fact1=(cvap-cliq)/rv,fact2=hvap/rv-fact1*t0c)<a name='4526'>
      parameter(cthk=50.,cincrmax=180.,cincrmin=120.,dthk=25.)<a name='4527'>
      parameter(h1=0.33333333)<a name='4528'>
<font color=#447700>!c  local variables and arrays<a name='4529'></font>
      real(kind=kind_phys) pfld(im,km),    to(im,km),     qo(im,km),    &amp;<a name='4530'>
     &amp;                     uo(im,km),      vo(im,km),     qeso(im,km)<a name='4531'>
<font color=#447700>!c  cloud water<a name='4532'></font>
      real(kind=kind_phys) qlko_ktcon(im), dellal(im,km),                   &amp;<a name='4533'>
     &amp;                     dbyo(im,km),    zo(im,km),     xlamue(im,km),    &amp;<a name='4534'>
     &amp;                     heo(im,km),     heso(im,km),                     &amp;<a name='4535'>
     &amp;                     dellah(im,km),  dellaq(im,km),                   &amp;<a name='4536'>
     &amp;                     dellau(im,km),  dellav(im,km), hcko(im,km),      &amp;<a name='4537'>
     &amp;                     ucko(im,km),    vcko(im,km),   qcko(im,km),      &amp;<a name='4538'>
     &amp;                     eta(im,km),     zi(im,km),     pwo(im,km),       &amp;<a name='4539'>
     &amp;                     tx1(im)<a name='4540'>
<font color=#447700>!<a name='4541'></font>
      logical totflg, cnvflg(im), flg(im)<a name='4542'>
<font color=#447700>!<a name='4543'></font>
      real(kind=kind_phys) tf, tcr, tcrf<a name='4544'>
      parameter (tf=233.16, tcr=263.16, tcrf=1.0/(tcr-tf))<a name='4545'>
<font color=#447700>!<a name='4546'></font>
<font color=#447700>!c-----------------------------------------------------------------------<a name='4547'></font>
<font color=#447700>!<a name='4548'></font>
      km1 = km - 1<a name='4549'>
<font color=#447700>!c<a name='4550'></font>
<font color=#447700>!c  compute surface buoyancy flux<a name='4551'></font>
<font color=#447700>!c<a name='4552'></font>
      do i=1,im<a name='4553'>
        sflx(i) = heat(i)+fv*t1(i,1)*evap(i)<a name='4554'>
      enddo<a name='4555'>
<font color=#447700>!c<a name='4556'></font>
<font color=#447700>!c  initialize arrays<a name='4557'></font>
<font color=#447700>!c<a name='4558'></font>
      do i=1,im<a name='4559'>
        cnvflg(i) = .true.<a name='4560'>
        if(kcnv(i).eq.1) cnvflg(i) = .false.<a name='4561'>
        if(sflx(i).le.0.) cnvflg(i) = .false.<a name='4562'>
        if(cnvflg(i)) then<a name='4563'>
          kbot(i)=km+1<a name='4564'>
          ktop(i)=0<a name='4565'>
        endif<a name='4566'>
        rn(i)=0.<a name='4567'>
        kbcon(i)=km<a name='4568'>
        ktcon(i)=1<a name='4569'>
        kb(i)=km<a name='4570'>
        pdot(i) = 0.<a name='4571'>
        qlko_ktcon(i) = 0.<a name='4572'>
        edt(i)  = 0.<a name='4573'>
        aa1(i)  = 0.<a name='4574'>
        vshear(i) = 0.<a name='4575'>
      enddo<a name='4576'>
<font color=#447700>! hchuang code change<a name='4577'></font>
      do k = 1, km<a name='4578'>
        do i = 1, im<a name='4579'>
          ud_mf(i,k) = 0.<a name='4580'>
          dt_mf(i,k) = 0.<a name='4581'>
        enddo<a name='4582'>
      enddo<a name='4583'>
<font color=#447700>!!<a name='4584'></font>
      totflg = .true.<a name='4585'>
      do i=1,im<a name='4586'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='4587'>
      enddo<a name='4588'>
      if(totflg) return<a name='4589'>
<font color=#447700>!!<a name='4590'></font>
<font color=#447700>!c<a name='4591'></font>
      dt2   = delt<a name='4592'>
      val   =         1200.<a name='4593'>
      dtmin = max(dt2, val )<a name='4594'>
      val   =         3600.<a name='4595'>
      dtmax = max(dt2, val )<a name='4596'>
<font color=#447700>!c  model tunable parameters are all here<a name='4597'></font>
      clam    = .3<a name='4598'>
      aafac   = .1<a name='4599'>
      betaw   = .03<a name='4600'>
<font color=#447700>!c     evef    = 0.07<a name='4601'></font>
      evfact  = 0.3<a name='4602'>
      evfactl = 0.3<a name='4603'>
<font color=#447700>!<a name='4604'></font>
      fjcap   = (float(jcap) / 126.) ** 2<a name='4605'>
      val     =           1.<a name='4606'>
      fjcap   = max(fjcap,val)<a name='4607'>
      w1l     = -8.e-3 <a name='4608'>
      w2l     = -4.e-2<a name='4609'>
      w3l     = -5.e-3 <a name='4610'>
      w4l     = -5.e-4<a name='4611'>
      w1s     = -2.e-4<a name='4612'>
      w2s     = -2.e-3<a name='4613'>
      w3s     = -1.e-3<a name='4614'>
      w4s     = -2.e-5<a name='4615'>
<font color=#447700>!c<a name='4616'></font>
<font color=#447700>!c  define top layer for search of the downdraft originating layer<a name='4617'></font>
<font color=#447700>!c  and the maximum thetae for updraft<a name='4618'></font>
<font color=#447700>!c<a name='4619'></font>
      do i=1,im<a name='4620'>
        kbm(i)   = km<a name='4621'>
        kmax(i)  = km<a name='4622'>
        tx1(i)   = 1.0 / ps(i)<a name='4623'>
      enddo<a name='4624'>
<font color=#447700>!     <a name='4625'></font>
      do k = 1, km<a name='4626'>
        do i=1,im<a name='4627'>
          if (prsl(i,k)*tx1(i) .gt. 0.70) kbm(i)   = k + 1<a name='4628'>
          if (prsl(i,k)*tx1(i) .gt. 0.60) kmax(i)  = k + 1<a name='4629'>
        enddo<a name='4630'>
      enddo<a name='4631'>
      do i=1,im<a name='4632'>
        kbm(i)   = min(kbm(i),kmax(i))<a name='4633'>
      enddo<a name='4634'>
<font color=#447700>!c<a name='4635'></font>
<font color=#447700>!!c  hydrostatic height assume zero terr and compute<a name='4636'></font>
<font color=#447700>!c  updraft entrainment rate as an inverse function of height<a name='4637'></font>
<font color=#447700>!c<a name='4638'></font>
      do k = 1, km<a name='4639'>
        do i=1,im<a name='4640'>
          zo(i,k) = phil(i,k) / g<a name='4641'>
        enddo<a name='4642'>
      enddo<a name='4643'>
      do k = 1, km1<a name='4644'>
        do i=1,im<a name='4645'>
          zi(i,k) = 0.5*(zo(i,k)+zo(i,k+1))<a name='4646'>
          xlamue(i,k) = clam / zi(i,k)<a name='4647'>
        enddo<a name='4648'>
      enddo<a name='4649'>
      do i=1,im<a name='4650'>
        xlamue(i,km) = xlamue(i,km1)<a name='4651'>
      enddo<a name='4652'>
<font color=#447700>!c<a name='4653'></font>
<font color=#447700>!c  pbl height<a name='4654'></font>
<font color=#447700>!c<a name='4655'></font>
      do i=1,im<a name='4656'>
        flg(i) = cnvflg(i)<a name='4657'>
        kpbl(i)= 1<a name='4658'>
      enddo<a name='4659'>
      do k = 2, km1<a name='4660'>
        do i=1,im<a name='4661'>
          if (flg(i).and.zo(i,k).le.hpbl(i)) then<a name='4662'>
            kpbl(i) = k<a name='4663'>
          else<a name='4664'>
            flg(i) = .false.<a name='4665'>
          endif<a name='4666'>
        enddo<a name='4667'>
      enddo<a name='4668'>
      do i=1,im<a name='4669'>
        kpbl(i)= min(kpbl(i),kbm(i))<a name='4670'>
      enddo<a name='4671'>
<font color=#447700>!c<a name='4672'></font>
<font color=#447700>!c!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='4673'></font>
<font color=#447700>!c   convert surface pressure to mb from cb<a name='4674'></font>
<font color=#447700>!c<a name='4675'></font>
      do k = 1, km<a name='4676'>
        do i = 1, im<a name='4677'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='4678'>
            pfld(i,k) = prsl(i,k) * 10.0<a name='4679'>
            eta(i,k)  = 1.<a name='4680'>
            hcko(i,k) = 0.<a name='4681'>
            qcko(i,k) = 0.<a name='4682'>
            ucko(i,k) = 0.<a name='4683'>
            vcko(i,k) = 0.<a name='4684'>
            dbyo(i,k) = 0.<a name='4685'>
            pwo(i,k)  = 0.<a name='4686'>
            dellal(i,k) = 0.<a name='4687'>
            to(i,k)   = t1(i,k)<a name='4688'>
            qo(i,k)   = q1(i,k)<a name='4689'>
            uo(i,k)   = u1(i,k) * rcs(i)<a name='4690'>
            vo(i,k)   = v1(i,k) * rcs(i)<a name='4691'>
          endif<a name='4692'>
        enddo<a name='4693'>
      enddo<a name='4694'>
<font color=#447700>!c<a name='4695'></font>
<font color=#447700>!c  column variables<a name='4696'></font>
<font color=#447700>!c  p is pressure of the layer (mb)<a name='4697'></font>
<font color=#447700>!c  t is temperature at t-dt (k)..tn<a name='4698'></font>
<font color=#447700>!c  q is mixing ratio at t-dt (kg/kg)..qn<a name='4699'></font>
<font color=#447700>!c  to is temperature at t+dt (k)... this is after advection and turbulan<a name='4700'></font>
<font color=#447700>!c  qo is mixing ratio at t+dt (kg/kg)..q1<a name='4701'></font>
<font color=#447700>!c<a name='4702'></font>
      do k = 1, km<a name='4703'>
        do i=1,im<a name='4704'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='4705'>
            qeso(i,k) = 0.01 * fpvs(to(i,k))      <font color=#447700>! fpvs is in pa<a name='4706'></font>
            qeso(i,k) = eps * qeso(i,k) / (pfld(i,k) + epsm1*qeso(i,k))<a name='4707'>
            val1      =             1.e-8<a name='4708'>
            qeso(i,k) = max(qeso(i,k), val1)<a name='4709'>
            val2      =           1.e-10<a name='4710'>
            qo(i,k)   = max(qo(i,k), val2 )<a name='4711'>
<font color=#447700>!           qo(i,k)   = min(qo(i,k),qeso(i,k))<a name='4712'></font>
<font color=#447700>!           tvo(i,k)  = to(i,k) + delta * to(i,k) * qo(i,k)<a name='4713'></font>
          endif<a name='4714'>
        enddo<a name='4715'>
      enddo<a name='4716'>
<font color=#447700>!c<a name='4717'></font>
<font color=#447700>!c  compute moist static energy<a name='4718'></font>
<font color=#447700>!c<a name='4719'></font>
      do k = 1, km<a name='4720'>
        do i=1,im<a name='4721'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='4722'>
<font color=#447700>!           tem       = g * zo(i,k) + cp * to(i,k)<a name='4723'></font>
            tem       = phil(i,k) + cp * to(i,k)<a name='4724'>
            heo(i,k)  = tem  + hvap * qo(i,k)<a name='4725'>
            heso(i,k) = tem  + hvap * qeso(i,k)<a name='4726'>
<font color=#447700>!c           heo(i,k)  = min(heo(i,k),heso(i,k))<a name='4727'></font>
          endif<a name='4728'>
        enddo<a name='4729'>
      enddo<a name='4730'>
<font color=#447700>!c<a name='4731'></font>
<font color=#447700>!c  determine level with largest moist static energy within pbl<a name='4732'></font>
<font color=#447700>!c  this is the level where updraft starts<a name='4733'></font>
<font color=#447700>!c<a name='4734'></font>
      do i=1,im<a name='4735'>
         if (cnvflg(i)) then<a name='4736'>
            hmax(i) = heo(i,1)<a name='4737'>
            kb(i) = 1<a name='4738'>
         endif<a name='4739'>
      enddo<a name='4740'>
      do k = 2, km<a name='4741'>
        do i=1,im<a name='4742'>
          if (cnvflg(i).and.k.le.kpbl(i)) then<a name='4743'>
            if(heo(i,k).gt.hmax(i)) then<a name='4744'>
              kb(i)   = k<a name='4745'>
              hmax(i) = heo(i,k)<a name='4746'>
            endif<a name='4747'>
          endif<a name='4748'>
        enddo<a name='4749'>
      enddo<a name='4750'>
<font color=#447700>!c<a name='4751'></font>
      do k = 1, km1<a name='4752'>
        do i=1,im<a name='4753'>
          if (cnvflg(i) .and. k .le. kmax(i)-1) then<a name='4754'>
            dz      = .5 * (zo(i,k+1) - zo(i,k))<a name='4755'>
            dp      = .5 * (pfld(i,k+1) - pfld(i,k))<a name='4756'>
            es      = 0.01 * fpvs(to(i,k+1))      <font color=#447700>! fpvs is in pa<a name='4757'></font>
            pprime  = pfld(i,k+1) + epsm1 * es<a name='4758'>
            qs      = eps * es / pprime<a name='4759'>
            dqsdp   = - qs / pprime<a name='4760'>
            desdt   = es * (fact1 / to(i,k+1) + fact2 / (to(i,k+1)**2))<a name='4761'>
            dqsdt   = qs * pfld(i,k+1) * desdt / (es * pprime)<a name='4762'>
            gamma   = el2orc * qeso(i,k+1) / (to(i,k+1)**2)<a name='4763'>
            dt      = (g * dz + hvap * dqsdp * dp) / (cp * (1. + gamma))<a name='4764'>
            dq      = dqsdt * dt + dqsdp * dp<a name='4765'>
            to(i,k) = to(i,k+1) + dt<a name='4766'>
            qo(i,k) = qo(i,k+1) + dq<a name='4767'>
            po(i,k) = .5 * (pfld(i,k) + pfld(i,k+1))<a name='4768'>
          endif<a name='4769'>
        enddo<a name='4770'>
      enddo<a name='4771'>
<font color=#447700>!<a name='4772'></font>
      do k = 1, km1<a name='4773'>
        do i=1,im<a name='4774'>
          if (cnvflg(i) .and. k .le. kmax(i)-1) then<a name='4775'>
            qeso(i,k) = 0.01 * fpvs(to(i,k))      <font color=#447700>! fpvs is in pa<a name='4776'></font>
            qeso(i,k) = eps * qeso(i,k) / (po(i,k) + epsm1*qeso(i,k))<a name='4777'>
            val1      =             1.e-8<a name='4778'>
            qeso(i,k) = max(qeso(i,k), val1)<a name='4779'>
            val2      =           1.e-10<a name='4780'>
            qo(i,k)   = max(qo(i,k), val2 )<a name='4781'>
<font color=#447700>!           qo(i,k)   = min(qo(i,k),qeso(i,k))<a name='4782'></font>
            heo(i,k)  = .5 * g * (zo(i,k) + zo(i,k+1)) +                  &amp;<a name='4783'>
     &amp;                  cp * to(i,k) + hvap * qo(i,k)<a name='4784'>
            heso(i,k) = .5 * g * (zo(i,k) + zo(i,k+1)) +                  &amp;<a name='4785'>
     &amp;                  cp * to(i,k) + hvap * qeso(i,k)<a name='4786'>
            uo(i,k)   = .5 * (uo(i,k) + uo(i,k+1))<a name='4787'>
            vo(i,k)   = .5 * (vo(i,k) + vo(i,k+1))<a name='4788'>
          endif<a name='4789'>
        enddo<a name='4790'>
      enddo<a name='4791'>
<font color=#447700>!c<a name='4792'></font>
<font color=#447700>!c  look for the level of free convection as cloud base<a name='4793'></font>
<font color=#447700>!c<a name='4794'></font>
      do i=1,im<a name='4795'>
        flg(i)   = cnvflg(i)<a name='4796'>
        if(flg(i)) kbcon(i) = kmax(i)<a name='4797'>
      enddo<a name='4798'>
      do k = 2, km1<a name='4799'>
        do i=1,im<a name='4800'>
          if (flg(i).and.k.lt.kbm(i)) then<a name='4801'>
            if(k.gt.kb(i).and.heo(i,kb(i)).gt.heso(i,k)) then<a name='4802'>
              kbcon(i) = k<a name='4803'>
              flg(i)   = .false.<a name='4804'>
            endif<a name='4805'>
          endif<a name='4806'>
        enddo<a name='4807'>
      enddo<a name='4808'>
<font color=#447700>!c<a name='4809'></font>
      do i=1,im<a name='4810'>
        if(cnvflg(i)) then<a name='4811'>
          if(kbcon(i).eq.kmax(i)) cnvflg(i) = .false.<a name='4812'>
        endif<a name='4813'>
      enddo<a name='4814'>
<font color=#447700>!!<a name='4815'></font>
      totflg = .true.<a name='4816'>
      do i=1,im<a name='4817'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='4818'>
      enddo<a name='4819'>
      if(totflg) return<a name='4820'>
<font color=#447700>!!<a name='4821'></font>
<font color=#447700>!c<a name='4822'></font>
<font color=#447700>!c  determine critical convective inhibition<a name='4823'></font>
<font color=#447700>!c  as a function of vertical velocity at cloud base.<a name='4824'></font>
<font color=#447700>!c<a name='4825'></font>
      do i=1,im<a name='4826'>
        if(cnvflg(i)) then<a name='4827'>
          pdot(i)  = 10.* dot(i,kbcon(i))<a name='4828'>
        endif<a name='4829'>
      enddo<a name='4830'>
      do i=1,im<a name='4831'>
        if(cnvflg(i)) then<a name='4832'>
          if(slimsk(i).eq.1.) then<a name='4833'>
            w1 = w1l<a name='4834'>
            w2 = w2l<a name='4835'>
            w3 = w3l<a name='4836'>
            w4 = w4l<a name='4837'>
          else<a name='4838'>
            w1 = w1s<a name='4839'>
            w2 = w2s<a name='4840'>
            w3 = w3s<a name='4841'>
            w4 = w4s<a name='4842'>
          endif<a name='4843'>
          if(pdot(i).le.w4) then<a name='4844'>
            ptem = (pdot(i) - w4) / (w3 - w4)<a name='4845'>
          elseif(pdot(i).ge.-w4) then<a name='4846'>
            ptem = - (pdot(i) + w4) / (w4 - w3)<a name='4847'>
          else<a name='4848'>
            ptem = 0.<a name='4849'>
          endif<a name='4850'>
          val1    =             -1.<a name='4851'>
          ptem = max(ptem,val1)<a name='4852'>
          val2    =             1.<a name='4853'>
          ptem = min(ptem,val2)<a name='4854'>
          ptem = 1. - ptem<a name='4855'>
          ptem1= .5*(cincrmax-cincrmin)<a name='4856'>
          cincr = cincrmax - ptem * ptem1<a name='4857'>
          tem1 = pfld(i,kb(i)) - pfld(i,kbcon(i))<a name='4858'>
          if(tem1.gt.cincr) then<a name='4859'>
             cnvflg(i) = .false.<a name='4860'>
          endif<a name='4861'>
        endif<a name='4862'>
      enddo<a name='4863'>
<font color=#447700>!!<a name='4864'></font>
      totflg = .true.<a name='4865'>
      do i=1,im<a name='4866'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='4867'>
      enddo<a name='4868'>
      if(totflg) return<a name='4869'>
<font color=#447700>!!<a name='4870'></font>
<font color=#447700>!c<a name='4871'></font>
<font color=#447700>!c  assume the detrainment rate for the updrafts to be same as <a name='4872'></font>
<font color=#447700>!c  the entrainment rate at cloud base<a name='4873'></font>
<font color=#447700>!c<a name='4874'></font>
      do i = 1, im<a name='4875'>
        if(cnvflg(i)) then<a name='4876'>
          xlamud(i) = xlamue(i,kbcon(i))<a name='4877'>
        endif<a name='4878'>
      enddo<a name='4879'>
<font color=#447700>!c<a name='4880'></font>
<font color=#447700>!c  determine updraft mass flux for the subcloud layers<a name='4881'></font>
<font color=#447700>!c<a name='4882'></font>
      do k = km1, 1, -1<a name='4883'>
        do i = 1, im<a name='4884'>
          if (cnvflg(i)) then<a name='4885'>
            if(k.lt.kbcon(i).and.k.ge.kb(i)) then<a name='4886'>
              dz       = zi(i,k+1) - zi(i,k)<a name='4887'>
              ptem     = 0.5*(xlamue(i,k)+xlamue(i,k+1))-xlamud(i)<a name='4888'>
              eta(i,k) = eta(i,k+1) / (1. + ptem * dz)<a name='4889'>
            endif<a name='4890'>
          endif<a name='4891'>
        enddo<a name='4892'>
      enddo<a name='4893'>
<font color=#447700>!c<a name='4894'></font>
<font color=#447700>!c  compute mass flux above cloud base<a name='4895'></font>
<font color=#447700>!c<a name='4896'></font>
      do k = 2, km1<a name='4897'>
        do i = 1, im<a name='4898'>
         if(cnvflg(i))then<a name='4899'>
           if(k.gt.kbcon(i).and.k.lt.kmax(i)) then<a name='4900'>
              dz       = zi(i,k) - zi(i,k-1)<a name='4901'>
              ptem     = 0.5*(xlamue(i,k)+xlamue(i,k-1))-xlamud(i)<a name='4902'>
              eta(i,k) = eta(i,k-1) * (1 + ptem * dz)<a name='4903'>
           endif<a name='4904'>
         endif<a name='4905'>
        enddo<a name='4906'>
      enddo<a name='4907'>
<font color=#447700>!c<a name='4908'></font>
<font color=#447700>!c  compute updraft cloud property<a name='4909'></font>
<font color=#447700>!c<a name='4910'></font>
      do i = 1, im<a name='4911'>
        if(cnvflg(i)) then<a name='4912'>
          indx         = kb(i)<a name='4913'>
          hcko(i,indx) = heo(i,indx)<a name='4914'>
          ucko(i,indx) = uo(i,indx)<a name='4915'>
          vcko(i,indx) = vo(i,indx)<a name='4916'>
        endif<a name='4917'>
      enddo<a name='4918'>
<font color=#447700>!c<a name='4919'></font>
      do k = 2, km1<a name='4920'>
        do i = 1, im<a name='4921'>
          if (cnvflg(i)) then<a name='4922'>
            if(k.gt.kb(i).and.k.lt.kmax(i)) then<a name='4923'>
              dz   = zi(i,k) - zi(i,k-1)<a name='4924'>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='4925'>
              tem1 = 0.5 * xlamud(i) * dz<a name='4926'>
              factor = 1. + tem - tem1<a name='4927'>
              ptem = 0.5 * tem + pgcon<a name='4928'>
              ptem1= 0.5 * tem - pgcon<a name='4929'>
              hcko(i,k) = ((1.-tem1)*hcko(i,k-1)+tem*0.5*                        &amp;<a name='4930'>
     &amp;                     (heo(i,k)+heo(i,k-1)))/factor<a name='4931'>
              ucko(i,k) = ((1.-tem1)*ucko(i,k-1)+ptem*uo(i,k)                    &amp;<a name='4932'>
     &amp;                     +ptem1*uo(i,k-1))/factor<a name='4933'>
              vcko(i,k) = ((1.-tem1)*vcko(i,k-1)+ptem*vo(i,k)                    &amp;<a name='4934'>
     &amp;                     +ptem1*vo(i,k-1))/factor<a name='4935'>
              dbyo(i,k) = hcko(i,k) - heso(i,k)<a name='4936'>
            endif<a name='4937'>
          endif<a name='4938'>
        enddo<a name='4939'>
      enddo<a name='4940'>
<font color=#447700>!c<a name='4941'></font>
<font color=#447700>!c   taking account into convection inhibition due to existence of<a name='4942'></font>
<font color=#447700>!c    dry layers below cloud base<a name='4943'></font>
<font color=#447700>!c<a name='4944'></font>
      do i=1,im<a name='4945'>
        flg(i) = cnvflg(i)<a name='4946'>
        kbcon1(i) = kmax(i)<a name='4947'>
      enddo<a name='4948'>
      do k = 2, km1<a name='4949'>
      do i=1,im<a name='4950'>
        if (flg(i).and.k.lt.kbm(i)) then<a name='4951'>
          if(k.ge.kbcon(i).and.dbyo(i,k).gt.0.) then<a name='4952'>
            kbcon1(i) = k<a name='4953'>
            flg(i)    = .false.<a name='4954'>
          endif<a name='4955'>
        endif<a name='4956'>
      enddo<a name='4957'>
      enddo<a name='4958'>
      do i=1,im<a name='4959'>
        if(cnvflg(i)) then<a name='4960'>
          if(kbcon1(i).eq.kmax(i)) cnvflg(i) = .false.<a name='4961'>
        endif<a name='4962'>
      enddo<a name='4963'>
      do i=1,im<a name='4964'>
        if(cnvflg(i)) then<a name='4965'>
          tem = pfld(i,kbcon(i)) - pfld(i,kbcon1(i))<a name='4966'>
          if(tem.gt.dthk) then<a name='4967'>
             cnvflg(i) = .false.<a name='4968'>
          endif<a name='4969'>
        endif<a name='4970'>
      enddo<a name='4971'>
<font color=#447700>!!<a name='4972'></font>
      totflg = .true.<a name='4973'>
      do i = 1, im<a name='4974'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='4975'>
      enddo<a name='4976'>
      if(totflg) return<a name='4977'>
<font color=#447700>!!<a name='4978'></font>
<font color=#447700>!c<a name='4979'></font>
<font color=#447700>!c  determine first guess cloud top as the level of zero buoyancy<a name='4980'></font>
<font color=#447700>!c    limited to the level of sigma=0.7<a name='4981'></font>
<font color=#447700>!c<a name='4982'></font>
      do i = 1, im<a name='4983'>
        flg(i) = cnvflg(i)<a name='4984'>
        if(flg(i)) ktcon(i) = kbm(i)<a name='4985'>
      enddo<a name='4986'>
      do k = 2, km1<a name='4987'>
      do i=1,im<a name='4988'>
        if (flg(i).and.k .lt. kbm(i)) then<a name='4989'>
          if(k.gt.kbcon1(i).and.dbyo(i,k).lt.0.) then<a name='4990'>
             ktcon(i) = k<a name='4991'>
             flg(i)   = .false.<a name='4992'>
          endif<a name='4993'>
        endif<a name='4994'>
      enddo<a name='4995'>
      enddo<a name='4996'>
<font color=#447700>!c<a name='4997'></font>
<font color=#447700>!c  turn off shallow convection if cloud top is less than pbl top<a name='4998'></font>
<font color=#447700>!c<a name='4999'></font>
     do i=1,im<a name='5000'>
       if(cnvflg(i)) then<a name='5001'>
         kk = kpbl(i)+1<a name='5002'>
         if(ktcon(i).le.kk) cnvflg(i) = .false.<a name='5003'>
       endif<a name='5004'>
     enddo<a name='5005'>
<font color=#447700>! c<a name='5006'></font>
<font color=#447700>! c  turn off shallow convection if cloud depth is less than<a name='5007'></font>
<font color=#447700>! c    a threshold value (cthk)<a name='5008'></font>
<font color=#447700>! c<a name='5009'></font>
       do i = 1, im<a name='5010'>
         if(cnvflg(i)) then<a name='5011'>
           tem = pfld(i,kbcon(i))-pfld(i,ktcon(i))<a name='5012'>
           if(tem.lt.cthk) cnvflg(i) = .false.<a name='5013'>
         endif<a name='5014'>
       enddo<a name='5015'>
<font color=#447700>!!<a name='5016'></font>
     totflg = .true.<a name='5017'>
     do i = 1, im<a name='5018'>
       totflg = totflg .and. (.not. cnvflg(i))<a name='5019'>
     enddo<a name='5020'>
     if(totflg) return<a name='5021'>
<font color=#447700>!!<a name='5022'></font>
<font color=#447700>!c<a name='5023'></font>
<font color=#447700>!c  specify upper limit of mass flux at cloud base<a name='5024'></font>
<font color=#447700>!c<a name='5025'></font>
      do i = 1, im<a name='5026'>
        if(cnvflg(i)) then<a name='5027'>
<font color=#447700>!         xmbmax(i) = .1<a name='5028'></font>
<font color=#447700>!<a name='5029'></font>
          k = kbcon(i)<a name='5030'>
          dp = 1000. * del(i,k)<a name='5031'>
          xmbmax(i) = dp / (g * dt2)<a name='5032'>
<font color=#447700>!<a name='5033'></font>
<font color=#447700>!         tem = dp / (g * dt2)<a name='5034'></font>
<font color=#447700>!         xmbmax(i) = min(tem, xmbmax(i))<a name='5035'></font>
        endif<a name='5036'>
      enddo<a name='5037'>
<font color=#447700>!c<a name='5038'></font>
<font color=#447700>!c  compute cloud moisture property and precipitation<a name='5039'></font>
<font color=#447700>!c<a name='5040'></font>
      do i = 1, im<a name='5041'>
        if (cnvflg(i)) then<a name='5042'>
          aa1(i) = 0.<a name='5043'>
          qcko(i,kb(i)) = qo(i,kb(i))<a name='5044'>
        endif<a name='5045'>
      enddo<a name='5046'>
      do k = 2, km1<a name='5047'>
        do i = 1, im<a name='5048'>
          if (cnvflg(i)) then<a name='5049'>
            if(k.gt.kb(i).and.k.lt.ktcon(i)) then<a name='5050'>
              dz    = zi(i,k) - zi(i,k-1)<a name='5051'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='5052'>
              qrch = qeso(i,k)                                      &amp;<a name='5053'>
     &amp;             + gamma * dbyo(i,k) / (hvap * (1. + gamma))<a name='5054'>
<font color=#447700>!cj<a name='5055'></font>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='5056'>
              tem1 = 0.5 * xlamud(i) * dz<a name='5057'>
              factor = 1. + tem - tem1<a name='5058'>
              qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*           &amp;<a name='5059'>
     &amp;                     (qo(i,k)+qo(i,k-1)))/factor<a name='5060'>
<font color=#447700>!cj<a name='5061'></font>
              dq = eta(i,k) * (qcko(i,k) - qrch)<a name='5062'>
<font color=#447700>!c<a name='5063'></font>
<font color=#447700>!             rhbar(i) = rhbar(i) + qo(i,k) / qeso(i,k)<a name='5064'></font>
<font color=#447700>!c<a name='5065'></font>
<font color=#447700>!c  below lfc check if there is excess moisture to release latent heat<a name='5066'></font>
<font color=#447700>!c<a name='5067'></font>
              if(k.ge.kbcon(i).and.dq.gt.0.) then<a name='5068'>
                etah = .5 * (eta(i,k) + eta(i,k-1))<a name='5069'>
                if(ncloud.gt.0.) then<a name='5070'>
                  dp = 1000. * del(i,k)<a name='5071'>
                  qlk = dq / (eta(i,k) + etah * (c0 + c1) * dz)<a name='5072'>
                  dellal(i,k) = etah * c1 * dz * qlk * g / dp<a name='5073'>
                else<a name='5074'>
                  qlk = dq / (eta(i,k) + etah * c0 * dz)<a name='5075'>
                endif<a name='5076'>
                aa1(i) = aa1(i) - dz * g * qlk<a name='5077'>
                qcko(i,k)= qlk + qrch<a name='5078'>
                pwo(i,k) = etah * c0 * dz * qlk<a name='5079'>
              endif<a name='5080'>
            endif<a name='5081'>
          endif<a name='5082'>
        enddo<a name='5083'>
      enddo<a name='5084'>
<font color=#447700>!c<a name='5085'></font>
<font color=#447700>!c  calculate cloud work function<a name='5086'></font>
<font color=#447700>!c<a name='5087'></font>
      do k = 2, km1<a name='5088'>
        do i = 1, im<a name='5089'>
          if (cnvflg(i)) then<a name='5090'>
            if(k.ge.kbcon(i).and.k.lt.ktcon(i)) then<a name='5091'>
              dz1 = zo(i,k+1) - zo(i,k)<a name='5092'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='5093'>
              rfact =  1. + delta * cp * gamma                 &amp;<a name='5094'>
     &amp;                 * to(i,k) / hvap<a name='5095'>
              aa1(i) = aa1(i) +                                &amp;<a name='5096'>
     &amp;                 dz1 * (g / (cp * to(i,k)))              &amp;<a name='5097'>
     &amp;                 * dbyo(i,k) / (1. + gamma)              &amp;<a name='5098'>
     &amp;                 * rfact<a name='5099'>
              val = 0.<a name='5100'>
              aa1(i)=aa1(i)+                                   &amp;<a name='5101'>
     &amp;                 dz1 * g * delta *                       &amp;<a name='5102'>
     &amp;                 max(val,(qeso(i,k) - qo(i,k)))<a name='5103'>
            endif<a name='5104'>
          endif<a name='5105'>
        enddo<a name='5106'>
      enddo<a name='5107'>
      do i = 1, im<a name='5108'>
        if(cnvflg(i).and.aa1(i).le.0.) cnvflg(i) = .false.<a name='5109'>
      enddo<a name='5110'>
<font color=#447700>!!<a name='5111'></font>
      totflg = .true.<a name='5112'>
      do i=1,im<a name='5113'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='5114'>
      enddo<a name='5115'>
      if(totflg) return<a name='5116'>
<font color=#447700>!!<a name='5117'></font>
<font color=#447700>!c<a name='5118'></font>
<font color=#447700>!c  estimate the onvective overshooting as the level<a name='5119'></font>
<font color=#447700>!c    where the [aafac * cloud work function] becomes zero,<a name='5120'></font>
<font color=#447700>!c    which is the final cloud top<a name='5121'></font>
<font color=#447700>!c    limited to the level of sigma=0.7<a name='5122'></font>
<font color=#447700>!c<a name='5123'></font>
      do i = 1, im<a name='5124'>
        if (cnvflg(i)) then<a name='5125'>
          aa1(i) = aafac * aa1(i)<a name='5126'>
        endif<a name='5127'>
      enddo<a name='5128'>
<font color=#447700>!c<a name='5129'></font>
      do i = 1, im<a name='5130'>
        flg(i) = cnvflg(i)<a name='5131'>
        ktcon1(i) = kbm(i)<a name='5132'>
      enddo<a name='5133'>
      do k = 2, km1<a name='5134'>
        do i = 1, im<a name='5135'>
          if (flg(i)) then<a name='5136'>
            if(k.ge.ktcon(i).and.k.lt.kbm(i)) then<a name='5137'>
              dz1 = zo(i,k+1) - zo(i,k)<a name='5138'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='5139'>
              rfact =  1. + delta * cp * gamma                            &amp;<a name='5140'>
     &amp;                 * to(i,k) / hvap<a name='5141'>
              aa1(i) = aa1(i) +                                           &amp;<a name='5142'>
     &amp;                 dz1 * (g / (cp * to(i,k)))                         &amp;<a name='5143'>
     &amp;                 * dbyo(i,k) / (1. + gamma)                         &amp;<a name='5144'>
     &amp;                 * rfact<a name='5145'>
              if(aa1(i).lt.0.) then<a name='5146'>
                ktcon1(i) = k<a name='5147'>
                flg(i) = .false.<a name='5148'>
              endif<a name='5149'>
            endif<a name='5150'>
          endif<a name='5151'>
        enddo<a name='5152'>
      enddo<a name='5153'>
<font color=#447700>!c<a name='5154'></font>
<font color=#447700>!c  compute cloud moisture property, detraining cloud water<a name='5155'></font>
<font color=#447700>!c    and precipitation in overshooting layers<a name='5156'></font>
<font color=#447700>!c<a name='5157'></font>
      do k = 2, km1<a name='5158'>
        do i = 1, im<a name='5159'>
          if (cnvflg(i)) then<a name='5160'>
            if(k.ge.ktcon(i).and.k.lt.ktcon1(i)) then<a name='5161'>
              dz    = zi(i,k) - zi(i,k-1)<a name='5162'>
              gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='5163'>
              qrch = qeso(i,k)                                            &amp;<a name='5164'>
     &amp;             + gamma * dbyo(i,k) / (hvap * (1. + gamma))<a name='5165'>
<font color=#447700>!cj<a name='5166'></font>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='5167'>
              tem1 = 0.5 * xlamud(i) * dz<a name='5168'>
              factor = 1. + tem - tem1<a name='5169'>
              qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*                  &amp;<a name='5170'>
     &amp;                     (qo(i,k)+qo(i,k-1)))/factor<a name='5171'>
<font color=#447700>!cj<a name='5172'></font>
              dq = eta(i,k) * (qcko(i,k) - qrch)<a name='5173'>
<font color=#447700>!c<a name='5174'></font>
<font color=#447700>!c  check if there is excess moisture to release latent heat<a name='5175'></font>
<font color=#447700>!c<a name='5176'></font>
              if(dq.gt.0.) then<a name='5177'>
                etah = .5 * (eta(i,k) + eta(i,k-1))<a name='5178'>
                if(ncloud.gt.0.) then<a name='5179'>
                  dp = 1000. * del(i,k)<a name='5180'>
                  qlk = dq / (eta(i,k) + etah * (c0 + c1) * dz)<a name='5181'>
                  dellal(i,k) = etah * c1 * dz * qlk * g / dp<a name='5182'>
                else<a name='5183'>
                  qlk = dq / (eta(i,k) + etah * c0 * dz)<a name='5184'>
                endif<a name='5185'>
                qcko(i,k) = qlk + qrch<a name='5186'>
                pwo(i,k) = etah * c0 * dz * qlk<a name='5187'>
              endif<a name='5188'>
            endif<a name='5189'>
          endif<a name='5190'>
        enddo<a name='5191'>
      enddo<a name='5192'>
<font color=#447700>!c<a name='5193'></font>
<font color=#447700>!c exchange ktcon with ktcon1<a name='5194'></font>
<font color=#447700>!c<a name='5195'></font>
      do i = 1, im<a name='5196'>
        if(cnvflg(i)) then<a name='5197'>
          kk = ktcon(i)<a name='5198'>
          ktcon(i) = ktcon1(i)<a name='5199'>
          ktcon1(i) = kk<a name='5200'>
        endif<a name='5201'>
      enddo<a name='5202'>
<font color=#447700>!c<a name='5203'></font>
<font color=#447700>!c  this section is ready for cloud water<a name='5204'></font>
<font color=#447700>!c<a name='5205'></font>
      if(ncloud.gt.0) then<a name='5206'>
<font color=#447700>!c<a name='5207'></font>
<font color=#447700>!c  compute liquid and vapor separation at cloud top<a name='5208'></font>
<font color=#447700>!c<a name='5209'></font>
      do i = 1, im<a name='5210'>
        if(cnvflg(i)) then<a name='5211'>
          k = ktcon(i) - 1<a name='5212'>
          gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='5213'>
          qrch = qeso(i,k)                                             &amp;<a name='5214'>
     &amp;         + gamma * dbyo(i,k) / (hvap * (1. + gamma))<a name='5215'>
          dq = qcko(i,k) - qrch<a name='5216'>
<font color=#447700>!c<a name='5217'></font>
<font color=#447700>!c  check if there is excess moisture to release latent heat<a name='5218'></font>
<font color=#447700>!c<a name='5219'></font>
          if(dq.gt.0.) then<a name='5220'>
            qlko_ktcon(i) = dq<a name='5221'>
            qcko(i,k) = qrch<a name='5222'>
          endif<a name='5223'>
        endif<a name='5224'>
      enddo<a name='5225'>
      endif<a name='5226'>
<font color=#447700>!!c<a name='5227'></font>
<font color=#447700>!c--- compute precipitation efficiency in terms of windshear<a name='5228'></font>
<font color=#447700>!c<a name='5229'></font>
      do i = 1, im<a name='5230'>
        if(cnvflg(i)) then<a name='5231'>
          vshear(i) = 0.<a name='5232'>
        endif<a name='5233'>
      enddo<a name='5234'>
      do k = 2, km<a name='5235'>
        do i = 1, im<a name='5236'>
          if (cnvflg(i)) then<a name='5237'>
            if(k.gt.kb(i).and.k.le.ktcon(i)) then<a name='5238'>
              shear= sqrt((uo(i,k)-uo(i,k-1)) ** 2                       &amp;<a name='5239'>
     &amp;                  + (vo(i,k)-vo(i,k-1)) ** 2)<a name='5240'>
              vshear(i) = vshear(i) + shear<a name='5241'>
            endif<a name='5242'>
          endif<a name='5243'>
        enddo<a name='5244'>
      enddo<a name='5245'>
      do i = 1, im<a name='5246'>
        if(cnvflg(i)) then<a name='5247'>
          vshear(i) = 1.e3 * vshear(i) / (zi(i,ktcon(i))-zi(i,kb(i)))<a name='5248'>
          e1=1.591-.639*vshear(i)                                               &amp;<a name='5249'>
     &amp;       +.0953*(vshear(i)**2)-.00496*(vshear(i)**3)<a name='5250'>
          edt(i)=1.-e1<a name='5251'>
          val =         .9<a name='5252'>
          edt(i) = min(edt(i),val)<a name='5253'>
          val =         .0<a name='5254'>
          edt(i) = max(edt(i),val)<a name='5255'>
        endif<a name='5256'>
      enddo<a name='5257'>
<font color=#447700>!c<a name='5258'></font>
<font color=#447700>!c--- what would the change be, that a cloud with unit mass<a name='5259'></font>
<font color=#447700>!c--- will do to the environment?<a name='5260'></font>
<font color=#447700>!c<a name='5261'></font>
      do k = 1, km<a name='5262'>
        do i = 1, im<a name='5263'>
          if(cnvflg(i) .and. k .le. kmax(i)) then<a name='5264'>
            dellah(i,k) = 0.<a name='5265'>
            dellaq(i,k) = 0.<a name='5266'>
            dellau(i,k) = 0.<a name='5267'>
            dellav(i,k) = 0.<a name='5268'>
          endif<a name='5269'>
        enddo<a name='5270'>
      enddo<a name='5271'>
<font color=#447700>!c<a name='5272'></font>
<font color=#447700>!c--- changed due to subsidence and entrainment<a name='5273'></font>
<font color=#447700>!c<a name='5274'></font>
      do k = 2, km1<a name='5275'>
        do i = 1, im<a name='5276'>
          if (cnvflg(i)) then<a name='5277'>
            if(k.gt.kb(i).and.k.lt.ktcon(i)) then<a name='5278'>
              dp = 1000. * del(i,k)<a name='5279'>
              dz = zi(i,k) - zi(i,k-1)<a name='5280'>
<font color=#447700>!c<a name='5281'></font>
              dv1h = heo(i,k)<a name='5282'>
              dv2h = .5 * (heo(i,k) + heo(i,k-1))<a name='5283'>
              dv3h = heo(i,k-1)<a name='5284'>
              dv1q = qo(i,k)<a name='5285'>
              dv2q = .5 * (qo(i,k) + qo(i,k-1))<a name='5286'>
              dv3q = qo(i,k-1)<a name='5287'>
              dv1u = uo(i,k)<a name='5288'>
              dv2u = .5 * (uo(i,k) + uo(i,k-1))<a name='5289'>
              dv3u = uo(i,k-1)<a name='5290'>
              dv1v = vo(i,k)<a name='5291'>
              dv2v = .5 * (vo(i,k) + vo(i,k-1))<a name='5292'>
              dv3v = vo(i,k-1)<a name='5293'>
<font color=#447700>!c<a name='5294'></font>
              tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1))<a name='5295'>
              tem1 = xlamud(i)<a name='5296'>
<font color=#447700>!cj<a name='5297'></font>
              dellah(i,k) = dellah(i,k) +                        &amp;<a name='5298'>
     &amp;     ( eta(i,k)*dv1h - eta(i,k-1)*dv3h                     &amp;<a name='5299'>
     &amp;    -  tem*eta(i,k-1)*dv2h*dz                              &amp;<a name='5300'>
     &amp;    +  tem1*eta(i,k-1)*.5*(hcko(i,k)+hcko(i,k-1))*dz       &amp;<a name='5301'>
     &amp;         ) *g/dp<a name='5302'>
<font color=#447700>!cj<a name='5303'></font>
              dellaq(i,k) = dellaq(i,k) +                        &amp;<a name='5304'>
     &amp;     ( eta(i,k)*dv1q - eta(i,k-1)*dv3q                     &amp;<a name='5305'>
     &amp;    -  tem*eta(i,k-1)*dv2q*dz                              &amp;<a name='5306'>
     &amp;    +  tem1*eta(i,k-1)*.5*(qcko(i,k)+qcko(i,k-1))*dz       &amp;<a name='5307'>
     &amp;         ) *g/dp<a name='5308'>
<font color=#447700>!cj<a name='5309'></font>
              dellau(i,k) = dellau(i,k) +                        &amp;<a name='5310'>
     &amp;     ( eta(i,k)*dv1u - eta(i,k-1)*dv3u                     &amp;<a name='5311'>
     &amp;    -  tem*eta(i,k-1)*dv2u*dz                              &amp;<a name='5312'>
     &amp;    +  tem1*eta(i,k-1)*.5*(ucko(i,k)+ucko(i,k-1))*dz       &amp;<a name='5313'>
     &amp;    -  pgcon*eta(i,k-1)*(dv1u-dv3u)                        &amp;<a name='5314'>
     &amp;         ) *g/dp<a name='5315'>
<font color=#447700>!cj<a name='5316'></font>
              dellav(i,k) = dellav(i,k) +                        &amp;<a name='5317'>
     &amp;     ( eta(i,k)*dv1v - eta(i,k-1)*dv3v                     &amp;<a name='5318'>
     &amp;    -  tem*eta(i,k-1)*dv2v*dz                              &amp;<a name='5319'>
     &amp;    +  tem1*eta(i,k-1)*.5*(vcko(i,k)+vcko(i,k-1))*dz       &amp;<a name='5320'>
     &amp;    -  pgcon*eta(i,k-1)*(dv1v-dv3v)                        &amp;<a name='5321'>
     &amp;         ) *g/dp<a name='5322'>
<font color=#447700>!cj<a name='5323'></font>
            endif<a name='5324'>
          endif<a name='5325'>
        enddo<a name='5326'>
      enddo<a name='5327'>
<font color=#447700>!c<a name='5328'></font>
<font color=#447700>!c------- cloud top<a name='5329'></font>
<font color=#447700>!c<a name='5330'></font>
      do i = 1, im<a name='5331'>
        if(cnvflg(i)) then<a name='5332'>
          indx = ktcon(i)<a name='5333'>
          dp = 1000. * del(i,indx)<a name='5334'>
          dv1h = heo(i,indx-1)<a name='5335'>
          dellah(i,indx) = eta(i,indx-1) *                      &amp;<a name='5336'>
     &amp;                     (hcko(i,indx-1) - dv1h) * g / dp<a name='5337'>
          dv1q = qo(i,indx-1)<a name='5338'>
          dellaq(i,indx) = eta(i,indx-1) *                      &amp;<a name='5339'>
     &amp;                     (qcko(i,indx-1) - dv1q) * g / dp<a name='5340'>
          dv1u = uo(i,indx-1)<a name='5341'>
          dellau(i,indx) = eta(i,indx-1) *                      &amp;<a name='5342'>
     &amp;                     (ucko(i,indx-1) - dv1u) * g / dp<a name='5343'>
          dv1v = vo(i,indx-1)<a name='5344'>
          dellav(i,indx) = eta(i,indx-1) *                      &amp;<a name='5345'>
     &amp;                     (vcko(i,indx-1) - dv1v) * g / dp<a name='5346'>
<font color=#447700>!c<a name='5347'></font>
<font color=#447700>!c  cloud water<a name='5348'></font>
<font color=#447700>!c<a name='5349'></font>
          dellal(i,indx) = eta(i,indx-1) *                      &amp;<a name='5350'>
     &amp;                     qlko_ktcon(i) * g / dp<a name='5351'>
        endif<a name='5352'>
      enddo<a name='5353'>
<font color=#447700>!c<a name='5354'></font>
<font color=#447700>!c  mass flux at cloud base for shallow convection<a name='5355'></font>
<font color=#447700>!c  (Grant, 2001)<a name='5356'></font>
<font color=#447700>!c<a name='5357'></font>
      do i= 1, im<a name='5358'>
        if(cnvflg(i)) then<a name='5359'>
          k = kbcon(i)<a name='5360'>
<font color=#447700>!         ptem = g*sflx(i)*zi(i,k)/t1(i,1)<a name='5361'></font>
          ptem = g*sflx(i)*hpbl(i)/t1(i,1)<a name='5362'>
          wstar(i) = ptem**h1<a name='5363'>
          tem = po(i,k)*100. / (rd*t1(i,k))<a name='5364'>
          xmb(i) = betaw*tem*wstar(i)<a name='5365'>
          xmb(i) = min(xmb(i),xmbmax(i))<a name='5366'>
        endif<a name='5367'>
      enddo<a name='5368'>
<font color=#447700>!c<a name='5369'></font>
<font color=#447700>!c!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='5370'></font>
<font color=#447700>!c<a name='5371'></font>
      do k = 1, km<a name='5372'>
        do i = 1, im<a name='5373'>
          if (cnvflg(i) .and. k .le. kmax(i)) then<a name='5374'>
            qeso(i,k) = 0.01 * fpvs(t1(i,k))      <font color=#447700>! fpvs is in pa<a name='5375'></font>
            qeso(i,k) = eps * qeso(i,k) / (pfld(i,k) + epsm1*qeso(i,k))<a name='5376'>
            val     =             1.e-8<a name='5377'>
            qeso(i,k) = max(qeso(i,k), val )<a name='5378'>
          endif<a name='5379'>
        enddo<a name='5380'>
      enddo<a name='5381'>
<font color=#447700>!c!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='5382'></font>
<font color=#447700>!c<a name='5383'></font>
      do i = 1, im<a name='5384'>
        delhbar(i) = 0.<a name='5385'>
        delqbar(i) = 0.<a name='5386'>
        deltbar(i) = 0.<a name='5387'>
        delubar(i) = 0.<a name='5388'>
        delvbar(i) = 0.<a name='5389'>
        qcond(i) = 0.<a name='5390'>
      enddo<a name='5391'>
      do k = 1, km<a name='5392'>
        do i = 1, im<a name='5393'>
          if (cnvflg(i)) then<a name='5394'>
            if(k.gt.kb(i).and.k.le.ktcon(i)) then<a name='5395'>
              dellat = (dellah(i,k) - hvap * dellaq(i,k)) / cp<a name='5396'>
              t1(i,k) = t1(i,k) + dellat * xmb(i) * dt2<a name='5397'>
              q1(i,k) = q1(i,k) + dellaq(i,k) * xmb(i) * dt2<a name='5398'>
              tem = 1./rcs(i)<a name='5399'>
              u1(i,k) = u1(i,k) + dellau(i,k) * xmb(i) * dt2 * tem<a name='5400'>
              v1(i,k) = v1(i,k) + dellav(i,k) * xmb(i) * dt2 * tem<a name='5401'>
              dp = 1000. * del(i,k)<a name='5402'>
              delhbar(i) = delhbar(i) + dellah(i,k)*xmb(i)*dp/g<a name='5403'>
              delqbar(i) = delqbar(i) + dellaq(i,k)*xmb(i)*dp/g<a name='5404'>
              deltbar(i) = deltbar(i) + dellat*xmb(i)*dp/g<a name='5405'>
              delubar(i) = delubar(i) + dellau(i,k)*xmb(i)*dp/g<a name='5406'>
              delvbar(i) = delvbar(i) + dellav(i,k)*xmb(i)*dp/g<a name='5407'>
            endif<a name='5408'>
          endif<a name='5409'>
        enddo<a name='5410'>
      enddo<a name='5411'>
      do k = 1, km<a name='5412'>
        do i = 1, im<a name='5413'>
          if (cnvflg(i)) then<a name='5414'>
            if(k.gt.kb(i).and.k.le.ktcon(i)) then<a name='5415'>
              qeso(i,k) = 0.01 * fpvs(t1(i,k))      <font color=#447700>! fpvs is in pa<a name='5416'></font>
              qeso(i,k) = eps * qeso(i,k)/(pfld(i,k) + epsm1*qeso(i,k))<a name='5417'>
              val     =             1.e-8<a name='5418'>
              qeso(i,k) = max(qeso(i,k), val )<a name='5419'>
            endif<a name='5420'>
          endif<a name='5421'>
        enddo<a name='5422'>
      enddo<a name='5423'>
<font color=#447700>!c<a name='5424'></font>
      do i = 1, im<a name='5425'>
        rntot(i) = 0.<a name='5426'>
        delqev(i) = 0.<a name='5427'>
        delq2(i) = 0.<a name='5428'>
        flg(i) = cnvflg(i)<a name='5429'>
      enddo<a name='5430'>
      do k = km, 1, -1<a name='5431'>
        do i = 1, im<a name='5432'>
          if (cnvflg(i)) then<a name='5433'>
            if(k.lt.ktcon(i).and.k.gt.kb(i)) then<a name='5434'>
              rntot(i) = rntot(i) + pwo(i,k) * xmb(i) * .001 * dt2<a name='5435'>
            endif<a name='5436'>
          endif<a name='5437'>
        enddo<a name='5438'>
      enddo<a name='5439'>
<font color=#447700>!c<a name='5440'></font>
<font color=#447700>!c evaporating rain<a name='5441'></font>
<font color=#447700>!c<a name='5442'></font>
      do k = km, 1, -1<a name='5443'>
        do i = 1, im<a name='5444'>
          if (k .le. kmax(i)) then<a name='5445'>
            deltv(i) = 0.<a name='5446'>
            delq(i) = 0.<a name='5447'>
            qevap(i) = 0.<a name='5448'>
            if(cnvflg(i)) then<a name='5449'>
              if(k.lt.ktcon(i).and.k.gt.kb(i)) then<a name='5450'>
                rn(i) = rn(i) + pwo(i,k) * xmb(i) * .001 * dt2<a name='5451'>
              endif<a name='5452'>
            endif<a name='5453'>
            if(flg(i).and.k.lt.ktcon(i)) then<a name='5454'>
              evef = edt(i) * evfact<a name='5455'>
              if(slimsk(i).eq.1.) evef=edt(i) * evfactl<a name='5456'>
<font color=#447700>!             if(slimsk(i).eq.1.) evef=.07<a name='5457'></font>
<font color=#447700>!c             if(slimsk(i).ne.1.) evef = 0.<a name='5458'></font>
              qcond(i) = evef * (q1(i,k) - qeso(i,k))                            &amp;<a name='5459'>
     &amp;                 / (1. + el2orc * qeso(i,k) / t1(i,k)**2)<a name='5460'>
              dp = 1000. * del(i,k)<a name='5461'>
              if(rn(i).gt.0..and.qcond(i).lt.0.) then<a name='5462'>
                qevap(i) = -qcond(i) * (1.-exp(-.32*sqrt(dt2*rn(i))))<a name='5463'>
                qevap(i) = min(qevap(i), rn(i)*1000.*g/dp)<a name='5464'>
                delq2(i) = delqev(i) + .001 * qevap(i) * dp / g<a name='5465'>
              endif<a name='5466'>
              if(rn(i).gt.0..and.qcond(i).lt.0..and.                            &amp;<a name='5467'>
     &amp;           delq2(i).gt.rntot(i)) then<a name='5468'>
                qevap(i) = 1000.* g * (rntot(i) - delqev(i)) / dp<a name='5469'>
                flg(i) = .false.<a name='5470'>
              endif<a name='5471'>
              if(rn(i).gt.0..and.qevap(i).gt.0.) then<a name='5472'>
                tem  = .001 * dp / g<a name='5473'>
                tem1 = qevap(i) * tem<a name='5474'>
                if(tem1.gt.rn(i)) then<a name='5475'>
                  qevap(i) = rn(i) / tem<a name='5476'>
                  rn(i) = 0.<a name='5477'>
                else<a name='5478'>
                  rn(i) = rn(i) - tem1<a name='5479'>
                endif<a name='5480'>
                q1(i,k) = q1(i,k) + qevap(i)<a name='5481'>
                t1(i,k) = t1(i,k) - elocp * qevap(i)<a name='5482'>
                deltv(i) = - elocp*qevap(i)/dt2<a name='5483'>
                delq(i) =  + qevap(i)/dt2<a name='5484'>
                delqev(i) = delqev(i) + .001*dp*qevap(i)/g<a name='5485'>
              endif<a name='5486'>
              dellaq(i,k) = dellaq(i,k) + delq(i) / xmb(i)<a name='5487'>
              delqbar(i) = delqbar(i) + delq(i)*dp/g<a name='5488'>
              deltbar(i) = deltbar(i) + deltv(i)*dp/g<a name='5489'>
            endif<a name='5490'>
          endif<a name='5491'>
        enddo<a name='5492'>
      enddo<a name='5493'>
<font color=#447700>!cj<a name='5494'></font>
<font color=#447700>!     do i = 1, im<a name='5495'></font>
<font color=#447700>!     if(me.eq.31.and.cnvflg(i)) then<a name='5496'></font>
<font color=#447700>!     if(cnvflg(i)) then<a name='5497'></font>
<font color=#447700>!       print *, ' shallow delhbar, delqbar, deltbar = ',<a name='5498'></font>
<font color=#447700>!    &amp;             delhbar(i),hvap*delqbar(i),cp*deltbar(i)<a name='5499'></font>
<font color=#447700>!       print *, ' shallow delubar, delvbar = ',delubar(i),delvbar(i)<a name='5500'></font>
<font color=#447700>!       print *, ' precip =', hvap*rn(i)*1000./dt2<a name='5501'></font>
<font color=#447700>!       print*,'pdif= ',pfld(i,kbcon(i))-pfld(i,ktcon(i))<a name='5502'></font>
<font color=#447700>!     endif<a name='5503'></font>
<font color=#447700>!     enddo<a name='5504'></font>
<font color=#447700>!cj<a name='5505'></font>
      do i = 1, im<a name='5506'>
        if(cnvflg(i)) then<a name='5507'>
          if(rn(i).lt.0..or..not.flg(i)) rn(i) = 0.<a name='5508'>
          ktop(i) = ktcon(i)<a name='5509'>
          kbot(i) = kbcon(i)<a name='5510'>
          kcnv(i) = 0<a name='5511'>
        endif<a name='5512'>
      enddo<a name='5513'>
<font color=#447700>!c<a name='5514'></font>
<font color=#447700>!c  cloud water<a name='5515'></font>
<font color=#447700>!c<a name='5516'></font>
      if (ncloud.gt.0) then<a name='5517'>
<font color=#447700>!<a name='5518'></font>
      val1 = 1.0<a name='5519'>
      val2 = 0.<a name='5520'>
      do k = 1, km1<a name='5521'>
        do i = 1, im<a name='5522'>
          if (cnvflg(i)) then<a name='5523'>
            if (k.gt.kb(i).and.k.le.ktcon(i)) then<a name='5524'>
              tem  = dellal(i,k) * xmb(i) * dt2<a name='5525'>
<font color=#447700>!             tem1 = max(0.0,  min(1.0,  (tcr-t1(i,k))*tcrf))<a name='5526'></font>
              tem1 = max(val2, min(val1, (tcr-t1(i,k))*tcrf))<a name='5527'>
              if (ql(i,k,2) .gt. -999.0) then<a name='5528'>
                ql(i,k,1) = ql(i,k,1) + tem * tem1            <font color=#447700>! ice<a name='5529'></font>
                ql(i,k,2) = ql(i,k,2) + tem *(1.0-tem1)       <font color=#447700>! water<a name='5530'></font>
              else<a name='5531'>
                ql(i,k,1) = ql(i,k,1) + tem<a name='5532'>
              endif<a name='5533'>
            endif<a name='5534'>
          endif<a name='5535'>
        enddo<a name='5536'>
      enddo<a name='5537'>
<font color=#447700>!<a name='5538'></font>
      endif<a name='5539'>
<font color=#447700>!<a name='5540'></font>
<font color=#447700>! hchuang code change<a name='5541'></font>
<font color=#447700>!<a name='5542'></font>
      do k = 1, km<a name='5543'>
        do i = 1, im<a name='5544'>
          if(cnvflg(i)) then<a name='5545'>
            if(k.ge.kb(i) .and. k.lt.ktop(i)) then<a name='5546'>
              ud_mf(i,k) = eta(i,k) * xmb(i) * dt2<a name='5547'>
            endif<a name='5548'>
          endif<a name='5549'>
        enddo<a name='5550'>
      enddo<a name='5551'>
      do i = 1, im<a name='5552'>
        if(cnvflg(i)) then<a name='5553'>
           k = ktop(i)-1<a name='5554'>
           dt_mf(i,k) = ud_mf(i,k)<a name='5555'>
        endif<a name='5556'>
      enddo<a name='5557'>
<font color=#447700>!!<a name='5558'></font>
      return<a name='5559'>
    end subroutine shalcnv<a name='5560'>
      END MODULE module_cu_sas<a name='5561'>
<a name='5562'>
<A NAME='RAN1'><A href='../../html_code/phys/module_cu_sas.F.html#RAN1' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='5563'>
     <font color=#993300>FUNCTION </font><font color=#cc0000>ran1</font>(idum)<a name='5564'>
      implicit none<a name='5565'>
      integer idum,ia,im,iq,ir,ntab,ndiv<a name='5566'>
      real*8 am,eps,rnmx<a name='5567'>
      real*8 ran1<a name='5568'>
      parameter (ia=16807,im=2147483647,am=1./im,iq=127773,ir=2836,   &amp;<a name='5569'>
     &amp;           ntab=32,ndiv=1+(im-1)/ntab,eps=1.2e-7,rnmx=1.-eps)<a name='5570'>
      integer j,k,iv(32),iy,junk<a name='5571'>
      common /random/ junk,iv,iy<a name='5572'>
      data iv /ntab*0/, iy /0/<a name='5573'>
      if (idum.le.0.or.iy.eq.0) then<a name='5574'>
         idum=max(-idum,1)<a name='5575'>
         do j=ntab+8,1,-1<a name='5576'>
            k=idum/iq<a name='5577'>
            idum=ia*(idum-k*iq)-ir*k<a name='5578'>
            if (idum.lt.0) idum=idum+im<a name='5579'>
            if (j.le.ntab) iv(j)=idum<a name='5580'>
         enddo<a name='5581'>
         iy=iv(1)<a name='5582'>
      endif<a name='5583'>
      k=idum/iq<a name='5584'>
      idum=ia*(idum-k*iq)-ir*k<a name='5585'>
      if (idum.lt.0) idum=idum+im<a name='5586'>
      j=1+iy/ndiv<a name='5587'>
      iy=iv(j)<a name='5588'>
      iv(j)=idum<a name='5589'>
      ran1=min(am*iy,rnmx)<a name='5590'>
      return<a name='5591'>
      END FUNCTION ran1<a name='5592'>
<a name='5593'>
<A NAME='GASDEV'><A href='../../html_code/phys/module_cu_sas.F.html#GASDEV' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='5594'>
      <font color=#993300>FUNCTION </font><font color=#cc0000>gasdev</font>(idum)<a name='5595'>
      INTEGER idum<a name='5596'>
      REAL*8 gasdev<a name='5597'>
<font color=#447700>!CU    USES ran1<a name='5598'></font>
      INTEGER iset<a name='5599'>
      REAL*8 fac,gset,rsq,v1,v2,ran1<a name='5600'>
      SAVE iset,gset<a name='5601'>
      DATA iset/0/<a name='5602'>
      if (iset.eq.0) then<a name='5603'>
   1    v1=2.*ran1(idum)-1.<a name='5604'>
        v2=2.*ran1(idum)-1.<a name='5605'>
        rsq=v1**2+v2**2<a name='5606'>
        if(rsq.ge.1..or.rsq.eq.0.)goto 1<a name='5607'>
        fac=sqrt(-2.*log(rsq)/rsq)<a name='5608'>
        gset=v1*fac<a name='5609'>
        gasdev=v2*fac<a name='5610'>
        iset=1<a name='5611'>
      else<a name='5612'>
        gasdev=gset<a name='5613'>
        iset=0<a name='5614'>
      endif<a name='5615'>
      return<a name='5616'>
      END FUNCTION gasdev<a name='5617'>
</pre></body></html>