<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<A NAME='MODULE_CU_GF_WRFDRV'><A href='../../html_code/phys/module_cu_gf_wrfdrv.F.html#MODULE_CU_GF_WRFDRV' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
<font color=#993300>MODULE </font><font color=#cc0000>module_cu_gf_wrfdrv</font> <A href='../../call_to/MODULE_CU_GF_WRFDRV.html' TARGET='index'>1</A><a name='6'>
use <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>module_gfs_physcons</A><A href='../../html_code/phys/module_cu_gf_wrfdrv.F.html#module_cu_gf_wrfdrv.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_4">, g =&gt; con_g,                           &amp;<a name='7'>
                         cp =&gt; con_cp,                         &amp;<a name='8'>
                         xlv =&gt; con_hvap,                      &amp;<a name='9'>
                         r_v =&gt; con_rv<a name='10'>
use <A href='../../html_code/phys/module_cu_gf_deep.F.html#MODULE_CU_GF_DEEP'>module_cu_gf_deep</A><A href='../../html_code/phys/module_cu_gf_wrfdrv.F.html#module_cu_gf_wrfdrv.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CU_GF_DEEP_2">, only: cup_gf,neg_check,autoconv,aeroevap<a name='11'>
use <A href='../../html_code/phys/module_cu_gf_sh.F.html#MODULE_CU_GF_SH'>module_cu_gf_sh</A><A href='../../html_code/phys/module_cu_gf_wrfdrv.F.html#module_cu_gf_wrfdrv.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CU_GF_SH_1">, only: cup_gf_sh<a name='12'>
<a name='13'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='14'></font>
<font color=#447700>!<a name='15'></font>
<font color=#447700>!     This convective parameterization is build to attempt     !<a name='16'></font>
<font color=#447700>!     a smooth transition to cloud resolving scales as proposed!<a name='17'></font>
<font color=#447700>!     by Arakawa et al (2011, ACP). It currently does not use  !<a name='18'></font>
<font color=#447700>!     subsidencespreading as in G3. Difference and details     !<a name='19'></font>
<font color=#447700>!     will be described in a forthcoming paper by              !<a name='20'></font>
<font color=#447700>!     Grell and Freitas (2013). The parameterization also      !<a name='21'></font>
<font color=#447700>!     offers options to couple with aerosols. Both, the smooth !<a name='22'></font>
<font color=#447700>!     transition part as well as the aerosol coupling are      !<a name='23'></font>
<font color=#447700>!     experimental. While the smooth transition part is turned !<a name='24'></font>
<font color=#447700>!     on, nd has been tested dow to a resolution of about 3km  !<a name='25'></font>
<font color=#447700>!     the aerosol coupling is turned off.                      !<a name='26'></font>
<font color=#447700>!     More clean-up as well as a direct coupling to chemistry  !<a name='27'></font>
<font color=#447700>!     will follow for V3.5.1                                   !<a name='28'></font>
<font color=#447700>!                                                              !<a name='29'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='30'></font>
<font color=#447700>!<a name='31'></font>
<font color=#447700>!Isidora J. stochastic parameter perturbation added to closures<a name='32'></font>
<font color=#447700>!02/29/2016<a name='33'></font>
<font color=#447700>!<a name='34'></font>
CONTAINS<a name='35'>
<a name='36'>
<font color=#447700>!-------------------------------------------------------------<a name='37'></font>
<A NAME='GFDRV'><A href='../../html_code/phys/module_cu_gf_wrfdrv.F.html#GFDRV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='38'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>GFDRV</font>(spp_conv,pattern_spp_conv,field_conv,       &amp; <A href='../../call_to/GFDRV.html' TARGET='index'>1</A>,<A href='../../call_from/GFDRV.html' TARGET='index'>6</A><a name='39'>
               DT,DX                                            &amp;<a name='40'>
              ,rho,RAINCV,PRATEC                                &amp;<a name='41'>
              ,U,V,t,W,q,p,pi                                   &amp;<a name='42'>
              ,dz8w,p8w                                         &amp;<a name='43'>
              ,htop,hbot,ktop_deep                              &amp;<a name='44'>
              ,HT,hfx,qfx,XLAND                                 &amp;<a name='45'>
              ,GDC,GDC2 ,kpbl,k22_shallow,kbcon_shallow         &amp;<a name='46'>
              ,ktop_shallow,xmb_shallow                         &amp;<a name='47'>
              ,ichoice,ishallow_g3                              &amp;<a name='48'>
              ,ids,ide, jds,jde, kds,kde                        &amp;<a name='49'>
              ,ims,ime, jms,jme, kms,kme                        &amp;<a name='50'>
              ,its,ite, jts,jte, kts,kte                        &amp;<a name='51'>
              ,periodic_x,periodic_y                            &amp;<a name='52'>
              ,RQVCUTEN,RQCCUTEN,RQICUTEN                       &amp;<a name='53'>
              ,RQVFTEN,RTHFTEN,RTHCUTEN,RTHRATEN                &amp;<a name='54'>
              ,rqvblten,rthblten                                &amp;<a name='55'>
              ,dudt_phy,dvdt_phy                                &amp;<a name='56'>
#if ( WRF_DFI_RADAR == 1 )<a name='57'>
                 <font color=#447700>! Optional CAP suppress option<a name='58'></font>
              ,do_capsuppress,cap_suppress_loc                  &amp;<a name='59'>
#endif                                 <a name='60'>
                                                                )<a name='61'>
<font color=#447700>!-------------------------------------------------------------<a name='62'></font>
   IMPLICIT NONE<a name='63'>
      integer, parameter :: ideep=1<a name='64'>
      integer, parameter :: imid_gf=0<a name='65'>
      integer, parameter :: ichoicem=0  <font color=#447700>! 0 1 2 8 11 GG<a name='66'></font>
      integer, parameter :: ichoice_s=0 <font color=#447700>! 0 1 2 3<a name='67'></font>
      integer, parameter :: dicycle=1 <font color=#447700>!- diurnal cycle flag<a name='68'></font>
      integer, parameter :: dicycle_m=0 <font color=#447700>!- diurnal cycle flag<a name='69'></font>
      real, parameter :: aodccn=0.1<a name='70'>
<font color=#447700>!-------------------------------------------------------------<a name='71'></font>
   INTEGER,      INTENT(IN   ) ::                               &amp;<a name='72'>
                                  ids,ide, jds,jde, kds,kde,    &amp; <a name='73'>
                                  ims,ime, jms,jme, kms,kme,    &amp; <a name='74'>
                                  its,ite, jts,jte, kts,kte<a name='75'>
   LOGICAL periodic_x,periodic_y<a name='76'>
   integer, intent (in   )              :: ichoice<a name='77'>
  <a name='78'>
   INTEGER,      INTENT(IN   ) :: ishallow_g3<a name='79'>
<a name='80'>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         ,    &amp;<a name='81'>
          INTENT(IN   ) ::                                      &amp;<a name='82'>
                                                          U,    &amp;<a name='83'>
                                                          V,    &amp;<a name='84'>
                                                          W,    &amp;<a name='85'>
                                                         pi,    &amp;<a name='86'>
                                                          t,    &amp;<a name='87'>
                                                          q,    &amp;<a name='88'>
                                                          p,    &amp;<a name='89'>
                                                       dz8w,    &amp;<a name='90'>
                                                       p8w,    &amp;<a name='91'>
                                                        rho<a name='92'>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         ,    &amp;<a name='93'>
          OPTIONAL                                         ,    &amp;<a name='94'>
          INTENT(INOUT   ) ::                                   &amp;<a name='95'>
               GDC,GDC2<a name='96'>
<a name='97'>
   REAL, DIMENSION( ims:ime , jms:jme ),INTENT(IN) :: hfx,qfx,HT,XLAND<a name='98'>
   INTEGER, DIMENSION( ims:ime , jms:jme ),INTENT(IN) :: KPBL<a name='99'>
   INTEGER, DIMENSION( ims:ime , jms:jme ),                     &amp;<a name='100'>
            OPTIONAL                      ,                     &amp;<a name='101'>
            INTENT(INOUT) :: k22_shallow,kbcon_shallow,ktop_shallow<a name='102'>
   REAL, DIMENSION( ims:ime, jms:jme ),INTENT(INOUT  ),         &amp;<a name='103'>
            OPTIONAL  :: xmb_shallow<a name='104'>
<a name='105'>
   REAL, INTENT(IN   ) :: DT, DX<a name='106'>
<font color=#447700>!<a name='107'></font>
<a name='108'>
   REAL, DIMENSION( ims:ime , jms:jme ),                        &amp;<a name='109'>
         INTENT(INOUT) ::           pratec,RAINCV,htop,hbot<a name='110'>
<font color=#447700>!+lxz<a name='111'></font>
<font color=#447700>!  REAL, DIMENSION( ims:ime , jms:jme ) :: &amp; !, INTENT(INOUT) ::       &amp;<a name='112'></font>
<font color=#447700>!        HTOP,     &amp;! highest model layer penetrated by cumulus since last reset in radiation_driver<a name='113'></font>
<font color=#447700>!        HBOT       ! lowest  model layer penetrated by cumulus since last reset in radiation_driver<a name='114'></font>
<font color=#447700>!                   ! HBOT&gt;HTOP follow physics leveling convention<a name='115'></font>
<a name='116'>
   INTEGER, DIMENSION( ims:ime,         jms:jme ),              &amp;<a name='117'>
         OPTIONAL,                                              &amp;<a name='118'>
         INTENT(  OUT) ::                           ktop_deep<a name='119'>
<a name='120'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),              &amp;<a name='121'>
         OPTIONAL,                                              &amp;<a name='122'>
         INTENT(INOUT) ::                           RTHFTEN,    &amp;<a name='123'>
                                                    RQVFTEN<a name='124'>
<a name='125'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),              &amp;<a name='126'>
         OPTIONAL,                                              &amp;<a name='127'>
         INTENT(INOUT) ::                                       &amp;<a name='128'>
                                                   RTHCUTEN,    &amp;<a name='129'>
                                                   RQVCUTEN,    &amp;<a name='130'>
                                                   RQVBLTEN,    &amp;<a name='131'>
                                                   RTHBLTEN,    &amp;<a name='132'>
                                                   RTHRATEN,    &amp;<a name='133'>
                                                   RQCCUTEN,    &amp;<a name='134'>
                                                   RQICUTEN<a name='135'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),              &amp;<a name='136'>
         OPTIONAL,                                              &amp;<a name='137'>
         INTENT(INOUT) ::                          DUDT_PHY,    &amp;<a name='138'>
                                                   DVDT_PHY<a name='139'>
<font color=#447700>!  Stochastic<a name='140'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),OPTIONAL  ::pattern_spp_conv,field_conv<a name='141'>
   REAL, DIMENSION( its:ite, 4 )                 ::   rstochcol <font color=#447700>!,fieldcol_conv<a name='142'></font>
<font color=#447700>! Stochastiv required by GF<a name='143'></font>
   REAL,  DIMENSION( its:ite )   :: rand_mom,rand_vmas<a name='144'>
   REAL,  DIMENSION( its:ite,4 ) :: rand_clos<a name='145'>
<a name='146'>
<font color=#447700>!<a name='147'></font>
<font color=#447700>! Flags relating to the optional tendency arrays declared above<a name='148'></font>
<font color=#447700>! Models that carry the optional tendencies will provdide the<a name='149'></font>
<font color=#447700>! optional arguments at compile time; these flags all the model<a name='150'></font>
<font color=#447700>! to determine at run-time whether a particular tracer is in<a name='151'></font>
<font color=#447700>! use or not.<a name='152'></font>
<font color=#447700>!<a name='153'></font>
<a name='154'>
   INTEGER                                 :: spp_conv<a name='155'>
<a name='156'>
#if ( WRF_DFI_RADAR == 1 )<a name='157'>
<font color=#447700>!<a name='158'></font>
<font color=#447700>!  option of cap suppress: <a name='159'></font>
<font color=#447700>!        do_capsuppress = 1   do<a name='160'></font>
<font color=#447700>!        do_capsuppress = other   don't<a name='161'></font>
<font color=#447700>!<a name='162'></font>
<font color=#447700>!<a name='163'></font>
   INTEGER,      INTENT(IN   ) ,OPTIONAL   :: do_capsuppress<a name='164'>
   REAL, DIMENSION( ims:ime, jms:jme ),INTENT(IN   ),OPTIONAL  :: cap_suppress_loc<a name='165'>
   REAL, DIMENSION( its:ite ) :: cap_suppress_j<a name='166'>
#endif<a name='167'>
<font color=#447700>! LOCAL VARS<a name='168'></font>
     real,    dimension (its:ite,kts:kte) ::                    &amp;<a name='169'>
        dhdt<a name='170'>
     real,    dimension (its:ite,kts:kte) ::                    &amp;<a name='171'>
        OUTT,OUTQ,OUTQC,cupclw,outu,outv,cnvwt<a name='172'>
     real,    dimension (its:ite,kts:kte) ::                    &amp;<a name='173'>
        OUTTs,OUTQs,OUTQCs,cupclws,outus,outvs,cnvwts<a name='174'>
     real,    dimension (its:ite,kts:kte) ::                    &amp;<a name='175'>
        OUTTm,OUTQm,OUTQCm,cupclwm,outum,outvm,cnvwtm<a name='176'>
     real,    dimension (its:ite)         ::                    &amp;<a name='177'>
        pret, prets,pretm,ter11, aa0, xlandi<a name='178'>
     real,    dimension (its:ite)         ::                    &amp;<a name='179'>
        hfxi,qfxi,dxi<a name='180'>
<font color=#447700>!+lxz<a name='181'></font>
     integer, dimension (its:ite) ::                            &amp;<a name='182'>
        ierr,ierrs,ierrm<a name='183'>
     integer, dimension (its:ite) ::                            &amp;<a name='184'>
        kbcon, kbcons, kbconm,                                  &amp;<a name='185'>
        ktop, ktops, ktopm,                                     &amp;<a name='186'>
        kpbli, k22, k22s, k22m<a name='187'>
<font color=#447700>!.lxz<a name='188'></font>
     integer :: ibegc,iendc,jbegc,jendc<a name='189'>
<a name='190'>
     integer, dimension (its:ite)         :: jmin,jminm<a name='191'>
<a name='192'>
<font color=#447700>!<a name='193'></font>
<font color=#447700>! basic environmental input includes moisture convergence (mconv)<a name='194'></font>
<font color=#447700>! omega (omeg), windspeed (us,vs)<a name='195'></font>
<font color=#447700>!<a name='196'></font>
     real,    dimension (its:ite,kts:kte) ::                    &amp;<a name='197'>
        zo,T2d,q2d,PO,P2d,US,VS,rhoi,tn,qo,tshall,qshall<a name='198'>
<font color=#447700>! output from cup routines, can be used for diagnostics<a name='199'></font>
     real,    dimension (its:ite,kts:kte) ::                    &amp;<a name='200'>
        zus,zum,zu,zdm,zd<a name='201'>
     real,    dimension (its:ite,kts:kte) ::                    &amp;<a name='202'>
        omeg<a name='203'>
     real, dimension (its:ite)            ::                    &amp;<a name='204'>
        ccn,Z1,PSUR,cuten,cutens,cutenm,                        &amp;<a name='205'>
        umean,vmean,pmean,xmb,xmbs,                             &amp;<a name='206'>
        xmbm,xmb_out,tau_ecmwf_out,xmb_dumm<a name='207'>
     real, dimension (its:ite)     ::                    &amp;<a name='208'>
        edt,edtm,mconv<a name='209'>
<a name='210'>
   INTEGER :: i,j,k,ICLDCK,ipr,jpr,n<a name='211'>
   REAL    :: tcrit,dp,dq<a name='212'>
   INTEGER :: itf,jtf,ktf,iss,jss,nbegin,nend<a name='213'>
   REAL    :: rkbcon,rktop        <font color=#447700>!-lxz<a name='214'></font>
   character*50 :: ierrc(its:ite)<a name='215'>
   character*50 :: ierrcs(its:ite)<a name='216'>
   character*50 :: ierrcm(its:ite)<a name='217'>
<a name='218'>
     real,    dimension (its:ite,kts:kte) :: hco,hcdo,zdo<a name='219'>
     real,    dimension (its:ite,10)         :: forcing,forcing2<a name='220'>
<a name='221'>
     integer, dimension (its:ite) :: cactiv<a name='222'>
     real,    dimension (its:ite,kts:kte) ::  qcheck<a name='223'>
<a name='224'>
<a name='225'>
<a name='226'>
   tcrit=258.<a name='227'>
   ipr=0 <font color=#447700>!639<a name='228'></font>
   jpr=0 <font color=#447700>!141<a name='229'></font>
   rand_mom(:)    = 0.<a name='230'>
   rand_vmas(:)   = 0.<a name='231'>
   rand_clos(:,:) = 0.<a name='232'>
<a name='233'>
   IF ( periodic_x ) THEN<a name='234'>
      ibegc=max(its,ids)<a name='235'>
      iendc=min(ite,ide-1)<a name='236'>
   ELSE<a name='237'>
      ibegc=max(its,ids+4)<a name='238'>
      iendc=min(ite,ide-5)<a name='239'>
   END IF<a name='240'>
   IF ( periodic_y ) THEN<a name='241'>
      jbegc=max(jts,jds)<a name='242'>
      jendc=min(jte,jde-1)<a name='243'>
   ELSE<a name='244'>
      jbegc=max(jts,jds+4)<a name='245'>
      jendc=min(jte,jde-5)<a name='246'>
   END IF<a name='247'>
   IF(PRESENT(k22_shallow)) THEN<a name='248'>
   do j=jts,jte<a name='249'>
   do i=its,ite<a name='250'>
     k22_shallow(i,j)=0<a name='251'>
     kbcon_shallow(i,j)=0<a name='252'>
     ktop_shallow(i,j)=0<a name='253'>
     xmb_shallow(i,j)=0<a name='254'>
   enddo<a name='255'>
   enddo<a name='256'>
   endif<a name='257'>
   rstochcol=0.0<a name='258'>
   itf=MIN(ite,ide-1)<a name='259'>
   ktf=MIN(kte,kde-1)<a name='260'>
   jtf=MIN(jte,jde-1)<a name='261'>
<font color=#447700>!                                                                      <a name='262'></font>
     DO J = jts,jte<a name='263'>
     DO I= its,ite<a name='264'>
     do k=kts,kte<a name='265'>
       rthcuten(i,k,j)=0.<a name='266'>
       rqvcuten(i,k,j)=0.<a name='267'>
       IF(PRESENT(RQCCUTEN))rqccuten(i,k,j)=0.<a name='268'>
       IF(PRESENT(RQICUTEN))rqicuten(i,k,j)=0.<a name='269'>
       DUDT_PHY(I,K,J)=0.<a name='270'>
       DVDT_PHY(I,K,J)=0.<a name='271'>
     enddo<a name='272'>
     enddo<a name='273'>
     enddo<a name='274'>
<a name='275'>
     DO 100 J = jts,jtf  <a name='276'>
<a name='277'>
     DO I= its,itf<a name='278'>
<font color=#447700>! Stochastic<a name='279'></font>
        if (spp_conv==1) then<a name='280'>
        do n=1,4<a name='281'>
        rstochcol(i,n)= pattern_spp_conv(i,n,j)<a name='282'>
        if (pattern_spp_conv(i,n,j) .le. -1.0) then<a name='283'>
          rstochcol(i,n)= -1.0<a name='284'>
        endif<a name='285'>
        if (pattern_spp_conv(i,n,j) .ge.  1.0) then<a name='286'>
          rstochcol(i,n)=  1.0<a name='287'>
        endif<a name='288'>
        enddo<a name='289'>
        endif<a name='290'>
        ierrc(i)=" "<a name='291'>
        ierrcs(i)=" "<a name='292'>
        ierrcm(i)=" "<a name='293'>
        ierr(i)=0<a name='294'>
        ierrs(i)=0<a name='295'>
        ierrm(i)=0<a name='296'>
<a name='297'>
        cuten(i)=0.<a name='298'>
        cutenm(i)=0.<a name='299'>
        cutens(i)=1.<a name='300'>
        if(ishallow_g3.eq.0)cutens(i)=0.<a name='301'>
<a name='302'>
        kbcon(i)=0<a name='303'>
        kbcons(i)=0<a name='304'>
        kbconm(i)=0<a name='305'>
        ktop(i)=0<a name='306'>
        ktops(i)=0<a name='307'>
        ktopm(i)=0<a name='308'>
        xmb(i)=0.<a name='309'>
        xmbs(i)=0.<a name='310'>
        xmbm(i)=0.<a name='311'>
        xmb_out(i)=0.<a name='312'>
        xmb_dumm(i)=0.<a name='313'>
<a name='314'>
        k22(i)=0<a name='315'>
        k22s(i)=0<a name='316'>
        k22m(i)=0<a name='317'>
<a name='318'>
        HBOT(I,J)  =REAL(KTE)<a name='319'>
        HTOP(I,J)  =REAL(KTS)<a name='320'>
        raincv(i,j)=0.<a name='321'>
        pratec (i,j)=0.<a name='322'>
        xlandi(i)=xland(i,j)<a name='323'>
        hfxi(i)=hfx(i,j)<a name='324'>
        qfxi(i)=qfx(i,j)<a name='325'>
<a name='326'>
        cactiv(i) = 0<a name='327'>
        jmin(i) = 0<a name='328'>
        jminm(i) = 0<a name='329'>
        forcing(i,:)=0.<a name='330'>
        forcing2(i,:)=0.<a name='331'>
        tau_ecmwf_out(i) = 0.<a name='332'>
<a name='333'>
        pret(i)=0.<a name='334'>
        prets(i) = 0.<a name='335'>
        pretm(i) = 0.<a name='336'>
<a name='337'>
        mconv(i)=0.<a name='338'>
        ccn(i)=150.<a name='339'>
<a name='340'>
     ENDDO<a name='341'>
     DO I= its,itf<a name='342'>
        mconv(i)=0.<a name='343'>
     ENDDO<a name='344'>
     do k=kts,kte<a name='345'>
     DO I= its,itf<a name='346'>
         omeg(i,k)=0.<a name='347'>
     ENDDO<a name='348'>
     ENDDO<a name='349'>
<a name='350'>
<font color=#447700>!ipr= 33 !78<a name='351'></font>
<font color=#447700>!jpr= 17 !110<a name='352'></font>
     DO I=ITS,ITF<a name='353'>
         dxi(i)=dx<a name='354'>
         PSUR(I)=p8w(I,1,J)*.01<a name='355'>
<font color=#447700>!        PSUR(I)=p(I,1,J)*.01<a name='356'></font>
         TER11(I)=max(0.,HT(i,j))<a name='357'>
<font color=#447700>! positive upward !!<a name='358'></font>
         hfxi(i)=hfx(i,j)<a name='359'>
         qfxi(i)=qfx(i,j)<a name='360'>
         pret(i)=0.<a name='361'>
         umean(i)=0.<a name='362'>
         vmean(i)=0.<a name='363'>
         pmean(i)=0.<a name='364'>
         kpbli(i)=kpbl(i,j)<a name='365'>
         zo(i,kts)=ter11(i)+.5*dz8w(i,1,j)<a name='366'>
         DO K=kts+1,ktf<a name='367'>
         zo(i,k)=zo(i,k-1)+.5*(dz8w(i,k-1,j)+dz8w(i,k,j))<a name='368'>
         enddo<a name='369'>
     ENDDO<a name='370'>
<font color=#447700>!    if(j.eq.jpr .and. (ipr.gt.its .and. ipr.lt.itf))write(0,*)psur(ipr),ter11(ipr),kpbli(ipr)<a name='371'></font>
     DO K=kts,ktf<a name='372'>
     DO I=ITS,ITF<a name='373'>
         po(i,k)=p(i,k,j)*.01<a name='374'>
         P2d(I,K)=PO(i,k)<a name='375'>
         rhoi(i,k)=rho(i,k,j)<a name='376'>
         US(I,K) =u(i,k,j)<a name='377'>
         VS(I,K) =v(i,k,j)<a name='378'>
         T2d(I,K)=t(i,k,j)<a name='379'>
         q2d(I,K)=q(i,k,j)<a name='380'>
         IF(Q2d(I,K).LT.1.E-08)Q2d(I,K)=1.E-08<a name='381'>
         TN(I,K)=t2d(i,k)+(RTHFTEN(i,k,j)+RTHRATEN(i,k,j)+RTHBLTEN(i,k,j)) &amp;<a name='382'>
                          *pi(i,k,j)*dt<a name='383'>
         QO(I,K)=q2d(i,k)+(RQVFTEN(i,k,j)+RQVBLTEN(i,k,j))*dt<a name='384'>
         TSHALL(I,K)=t2d(i,k)+RTHBLTEN(i,k,j)*pi(i,k,j)*dt<a name='385'>
         DHDT(I,K)=cp*RTHBLTEN(i,k,j)*pi(i,k,j)+ XLV*RQVBLTEN(i,k,j)<a name='386'>
         QSHALL(I,K)=q2d(i,k)+RQVBLTEN(i,k,j)*dt<a name='387'>
         IF(TN(I,K).LT.200.)TN(I,K)=T2d(I,K)<a name='388'>
         IF(QO(I,K).LT.1.E-08)QO(I,K)=1.E-08<a name='389'>
         OUTT(I,K)=0.<a name='390'>
         OUTu(I,K)=0.<a name='391'>
         OUTv(I,K)=0.<a name='392'>
         OUTQ(I,K)=0.<a name='393'>
         OUTQC(I,K)=0.<a name='394'>
         OUTTm(I,K)=0.<a name='395'>
         OUTum(I,K)=0.<a name='396'>
         OUTvm(I,K)=0.<a name='397'>
         OUTQm(I,K)=0.<a name='398'>
         OUTQCm(I,K)=0.<a name='399'>
         OUTTs(I,K)=0.<a name='400'>
         OUTus(I,K)=0.<a name='401'>
         OUTvs(I,K)=0.<a name='402'>
         OUTQs(I,K)=0.<a name='403'>
         OUTQCs(I,K)=0.<a name='404'>
         cupclws(i,k) = 0.<a name='405'>
         cupclw(i,k) = 0.<a name='406'>
         cupclwm(i,k) = 0.<a name='407'>
         qcheck(i,k) = 0.<a name='408'>
     ENDDO<a name='409'>
     ENDDO<a name='410'>
#if (NMM_CORE==1)<a name='411'>
<font color=#447700>! for NMM, tendencies have already been added to T,Q, and total tendencies<a name='412'></font>
<font color=#447700>! are stored in *FTEN variables<a name='413'></font>
     DO K=kts,ktf<a name='414'>
     DO I=ITS,ITF<a name='415'>
         TN(I,K)=t2d(i,k) + RTHFTEN(i,k,j)*pi(i,k,j)*dt<a name='416'>
         QO(I,K)=q2d(i,k) + RQVFTEN(i,k,j)*dt<a name='417'>
         IF(TN(I,K).LT.200.)TN(I,K)=T2d(I,K)<a name='418'>
         IF(QO(I,K).LT.1.E-08)QO(I,K)=1.E-08<a name='419'>
     ENDDO<a name='420'>
     ENDDO<a name='421'>
#endif<a name='422'>
<font color=#447700>! for EM_CORE, tendencies have not yet been added to T,Q, and *FTEN variables<a name='423'></font>
<font color=#447700>! contain advective forcing only<a name='424'></font>
     DO K=kts,ktf<a name='425'>
     DO I=ITS,ITF<a name='426'>
         omeg(I,K)= -g*rho(i,k,j)*w(i,k,j)<a name='427'>
     enddo<a name='428'>
     enddo<a name='429'>
     do k=  kts+1,ktf-1<a name='430'>
     DO I = its,itf<a name='431'>
         if((p2d(i,1)-p2d(i,k)).gt.150.and.p2d(i,k).gt.300)then<a name='432'>
            dp=-.5*(p2d(i,k+1)-p2d(i,k-1))<a name='433'>
            umean(i)=umean(i)+us(i,k)*dp<a name='434'>
            vmean(i)=vmean(i)+vs(i,k)*dp<a name='435'>
            pmean(i)=pmean(i)+dp<a name='436'>
         endif<a name='437'>
     enddo<a name='438'>
     enddo<a name='439'>
      DO K=kts,ktf-1<a name='440'>
      DO I = its,itf<a name='441'>
        dq=(q2d(i,k+1)-q2d(i,k))<a name='442'>
        mconv(i)=mconv(i)+omeg(i,k)*dq/g<a name='443'>
      enddo<a name='444'>
      ENDDO<a name='445'>
      DO I = its,itf<a name='446'>
        if(mconv(i).lt.0.)mconv(i)=0.<a name='447'>
      ENDDO<a name='448'>
<font color=#447700>!<a name='449'></font>
<font color=#447700>!---- CALL CUMULUS PARAMETERIZATION<a name='450'></font>
<font color=#447700>!<a name='451'></font>
#if ( WRF_DFI_RADAR == 1 )<a name='452'>
      if(do_capsuppress == 1 ) then<a name='453'>
        DO I= its,itf<a name='454'>
            cap_suppress_j(i)=cap_suppress_loc(i,j)<a name='455'>
        ENDDO<a name='456'>
      endif<a name='457'>
#endif<a name='458'>
<a name='459'>
       if(ishallow_g3 == 1 )then<a name='460'>
<a name='461'>
          call <A href='../../html_code/phys/module_cu_gf_sh.F.html#CUP_GF_SH'>CUP_gf_sh</A><A href='../../html_code/phys/module_cu_gf_wrfdrv.F.html#GFDRV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_GF_SH_1"> (                                              &amp;<a name='462'>
<font color=#447700>! input variables, must be supplied<a name='463'></font>
              zo,t2d,q2d,ter11,tshall,qshall,p2d,psur,dhdt,kpbli,      &amp;<a name='464'>
              rhoi,hfxi,qfxi,xlandi,ichoice_s,tcrit,dt,                  &amp;<a name='465'>
<font color=#447700>! input variables. Ierr should be initialized to zero or larger than zero for<a name='466'></font>
<font color=#447700>! turning off shallow convection for grid points<a name='467'></font>
              zus,xmbs,kbcons,ktops,k22s,ierrs,ierrcs,    &amp;<a name='468'>
<font color=#447700>! output tendencies<a name='469'></font>
              outts,outqs,outqcs,cnvwt,prets,cupclws,             &amp;<a name='470'>
<font color=#447700>! dimesnional variables<a name='471'></font>
              itf,ktf,its,ite, kts,kte,ipr)<a name='472'>
          do i=its,itf<a name='473'>
           if(xmbs(i).le.0.)cutens(i)=0.<a name='474'>
          enddo<a name='475'>
          CALL <A href='../../html_code/phys/module_cu_gf_deep.F.html#NEG_CHECK'>neg_check</A><A href='../../html_code/phys/module_cu_gf_wrfdrv.F.html#GFDRV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NEG_CHECK_1">('shallow',ipr,dt,q2d,outqs,outts,outus,outvs,   &amp;<a name='476'>
                                 outqcs,prets,its,ite,kts,kte,itf,ktf)<a name='477'>
<a name='478'>
        endif<a name='479'>
<font color=#447700>! Mid-level convection<a name='480'></font>
<a name='481'>
   if(imid_gf == 1)then<a name='482'>
<a name='483'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF'>cup_gf</A><A href='../../html_code/phys/module_cu_gf_wrfdrv.F.html#GFDRV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_GF_1">(        &amp;<a name='484'>
               itf,ktf,its,ite, kts,kte  &amp;<a name='485'>
<a name='486'>
              ,dicycle_m       &amp;<a name='487'>
              ,ichoicem       &amp;<a name='488'>
              ,ipr           &amp;<a name='489'>
              ,ccn           &amp;<a name='490'>
              ,dt         &amp;<a name='491'>
              ,imid_gf          &amp;<a name='492'>
<a name='493'>
              ,kpbli         &amp;<a name='494'>
              ,dhdt          &amp;<a name='495'>
              ,xlandi        &amp;<a name='496'>
<a name='497'>
              ,zo            &amp;<a name='498'>
              ,forcing2      &amp;<a name='499'>
              ,t2d           &amp;<a name='500'>
              ,q2d           &amp;<a name='501'>
              ,ter11         &amp;<a name='502'>
              ,tshall        &amp;<a name='503'>
              ,qshall        &amp;<a name='504'>
              ,p2d          &amp;<a name='505'>
              ,psur          &amp;<a name='506'>
              ,us            &amp;<a name='507'>
              ,vs            &amp;<a name='508'>
              ,rhoi          &amp;<a name='509'>
              ,hfxi          &amp;<a name='510'>
              ,qfxi          &amp;<a name='511'>
              ,dxi            &amp;<a name='512'>
              ,mconv         &amp;<a name='513'>
              ,omeg          &amp;<a name='514'>
<a name='515'>
              ,cactiv        &amp;<a name='516'>
              ,cnvwtm        &amp;<a name='517'>
              ,zum           &amp;<a name='518'>
              ,zdm           &amp;<a name='519'>
              ,edtm          &amp;<a name='520'>
              ,xmbm          &amp;<a name='521'>
              ,xmb_dumm      &amp;<a name='522'>
              ,xmbs          &amp;<a name='523'>
              ,pretm         &amp;<a name='524'>
              ,outum         &amp;<a name='525'>
              ,outvm         &amp;<a name='526'>
              ,outtm         &amp;<a name='527'>
              ,outqm         &amp;<a name='528'>
              ,outqcm        &amp;<a name='529'>
              ,kbconm        &amp;<a name='530'>
              ,ktopm         &amp;<a name='531'>
              ,cupclwm       &amp;<a name='532'>
              ,ierrm         &amp;<a name='533'>
              ,ierrcm        &amp;<a name='534'>
<font color=#447700>!    the following should be set to zero if not available<a name='535'></font>
              ,rand_mom      &amp; <font color=#447700>! for stochastics mom, if temporal and spatial patterns exist<a name='536'></font>
              ,rand_vmas     &amp; <font color=#447700>! for stochastics vertmass, if temporal and spatial patterns exist<a name='537'></font>
              ,rand_clos     &amp; <font color=#447700>! for stochastics closures, if temporal and spatial patterns exist<a name='538'></font>
              ,0             &amp; <font color=#447700>! flag to what you want perturbed<a name='539'></font>
                               <font color=#447700>! 1 = momentum transport <a name='540'></font>
                               <font color=#447700>! 2 = normalized vertical mass flux profile<a name='541'></font>
                               <font color=#447700>! 3 = closures<a name='542'></font>
                               <font color=#447700>! more is possible, talk to developer or<a name='543'></font>
                               <font color=#447700>! implement yourself. pattern is expected to be<a name='544'></font>
                               <font color=#447700>! betwee -1 and +1<a name='545'></font>
#if ( WRF_DFI_RADAR == 1 )<a name='546'>
              ,do_capsuppress,cap_suppress_j &amp;<a name='547'>
#endif<a name='548'>
              ,k22m          &amp;<a name='549'>
              ,jminm)<a name='550'>
<a name='551'>
            DO I=its,itf<a name='552'>
            DO K=kts,ktf<a name='553'>
              qcheck(i,k)=q2d(i,k) +outqs(i,k)*dt<a name='554'>
            enddo<a name='555'>
            enddo<a name='556'>
      CALL <A href='../../html_code/phys/module_cu_gf_deep.F.html#NEG_CHECK'>neg_check</A><A href='../../html_code/phys/module_cu_gf_wrfdrv.F.html#GFDRV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NEG_CHECK_2">('mid',ipr,dt,qcheck,outqm,outtm,outum,outvm,   &amp;<a name='557'>
                     outqcm,pretm,its,ite,kts,kte,itf,ktf)<a name='558'>
    endif<a name='559'>
<a name='560'>
#if ( WRF_DFI_RADAR == 1 )<a name='561'>
      if(do_capsuppress == 1 ) then<a name='562'>
        DO I= its,itf<a name='563'>
            cap_suppress_j(i)=cap_suppress_loc(i,j)<a name='564'>
        ENDDO<a name='565'>
      endif<a name='566'>
#endif<a name='567'>
   if(ideep.eq.1)then<a name='568'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF'>cup_gf</A><A href='../../html_code/phys/module_cu_gf_wrfdrv.F.html#GFDRV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_GF_2">(        &amp;<a name='569'>
               itf,ktf,its,ite, kts,kte  &amp;<a name='570'>
<a name='571'>
              ,dicycle       &amp;<a name='572'>
              ,ichoice       &amp;<a name='573'>
              ,ipr           &amp;<a name='574'>
              ,ccn           &amp;<a name='575'>
              ,dt            &amp;<a name='576'>
              ,0             &amp;<a name='577'>
<a name='578'>
              ,kpbli         &amp;<a name='579'>
              ,dhdt          &amp;<a name='580'>
              ,xlandi        &amp;<a name='581'>
<a name='582'>
              ,zo            &amp;<a name='583'>
              ,forcing       &amp;<a name='584'>
              ,t2d           &amp;<a name='585'>
              ,q2d           &amp;<a name='586'>
              ,ter11         &amp;<a name='587'>
              ,tn            &amp;<a name='588'>
              ,qo            &amp;<a name='589'>
              ,p2d           &amp;<a name='590'>
              ,psur          &amp;<a name='591'>
              ,us            &amp;<a name='592'>
              ,vs            &amp;<a name='593'>
              ,rhoi          &amp;<a name='594'>
              ,hfxi          &amp;<a name='595'>
              ,qfxi          &amp;<a name='596'>
              ,dxi            &amp;<a name='597'>
              ,mconv         &amp;<a name='598'>
              ,omeg          &amp;<a name='599'>
<a name='600'>
              ,cactiv       &amp;<a name='601'>
              ,cnvwt        &amp;<a name='602'>
              ,zu           &amp;<a name='603'>
              ,zd           &amp;<a name='604'>
              ,edt          &amp;<a name='605'>
              ,xmb          &amp;<a name='606'>
              ,xmbm         &amp;<a name='607'>
              ,xmbs         &amp;<a name='608'>
              ,pret         &amp;<a name='609'>
              ,outu         &amp;<a name='610'>
              ,outv         &amp;<a name='611'>
              ,outt         &amp;<a name='612'>
              ,outq         &amp;<a name='613'>
              ,outqc        &amp;<a name='614'>
              ,kbcon        &amp;<a name='615'>
              ,ktop         &amp;<a name='616'>
              ,cupclw       &amp;<a name='617'>
              ,ierr         &amp;<a name='618'>
              ,ierrc        &amp;<a name='619'>
<font color=#447700>!    the following should be set to zero if not available<a name='620'></font>
              ,rand_mom      &amp; <font color=#447700>! for stochastics mom, if temporal and spatial patterns exist<a name='621'></font>
              ,rand_vmas     &amp; <font color=#447700>! for stochastics vertmass, if temporal and spatial patterns exist<a name='622'></font>
              ,rand_clos     &amp; <font color=#447700>! for stochastics closures, if temporal and spatial patterns exist<a name='623'></font>
              ,0             &amp; <font color=#447700>! flag to what you want perturbed<a name='624'></font>
                               <font color=#447700>! 1 = momentum transport <a name='625'></font>
                               <font color=#447700>! 2 = normalized vertical mass flux profile<a name='626'></font>
                               <font color=#447700>! 3 = closures<a name='627'></font>
                               <font color=#447700>! more is possible, talk to developer or<a name='628'></font>
                               <font color=#447700>! implement yourself. pattern is expected to be<a name='629'></font>
                               <font color=#447700>! betwee -1 and +1<a name='630'></font>
#if ( WRF_DFI_RADAR == 1 )<a name='631'>
              ,do_capsuppress,cap_suppress_j &amp;<a name='632'>
#endif<a name='633'>
              ,k22          &amp;<a name='634'>
              ,jmin)<a name='635'>
        jpr=0<a name='636'>
        ipr=0<a name='637'>
            DO I=its,itf<a name='638'>
            DO K=kts,ktf<a name='639'>
              qcheck(i,k)=q2d(i,k) +(outqs(i,k)+outqm(i,k))*dt<a name='640'>
            enddo<a name='641'>
            enddo<a name='642'>
      CALL <A href='../../html_code/phys/module_cu_gf_deep.F.html#NEG_CHECK'>neg_check</A><A href='../../html_code/phys/module_cu_gf_wrfdrv.F.html#GFDRV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NEG_CHECK_3">('deep',ipr,dt,qcheck,outq,outt,outu,outv,   &amp;<a name='643'>
                                         outqc,pret,its,ite,kts,kte,itf,ktf)<a name='644'>
<font color=#447700>!<a name='645'></font>
      endif<a name='646'>
            if(j.lt.jbegc.or.j.gt.jendc)go to 100<a name='647'>
        IF(PRESENT(k22_shallow)) THEN<a name='648'>
             if(ishallow_g3.eq.1)then<a name='649'>
               DO I=ibegc,iendc<a name='650'>
                 xmb_shallow(i,j)=xmbs(i)<a name='651'>
                 k22_shallow(i,j)=k22s(i)<a name='652'>
                 kbcon_shallow(i,j)=kbcons(i)<a name='653'>
                 ktop_shallow(i,j)=ktops(i)<a name='654'>
                 ktop_deep(i,j) = ktop(i)<a name='655'>
               ENDDO<a name='656'>
            endif<a name='657'>
         ENDIF<a name='658'>
            DO I=ibegc,iendc<a name='659'>
              cuten(i)=0.<a name='660'>
              ktop_deep(i,j) = ktop(i)<a name='661'>
              if(pret(i).gt.0.)then<a name='662'>
                 cuten(i)=1.<a name='663'>
              else<a name='664'>
                 cuten(i)=0.<a name='665'>
                 kbcon(i)=0<a name='666'>
                 ktop(i)=0<a name='667'>
              endif<a name='668'>
              if(pretm(i).gt.0.)then<a name='669'>
                 cutenm(i)=1.<a name='670'>
              else<a name='671'>
                 cutenm(i)=0.<a name='672'>
                 kbconm(i)=0<a name='673'>
                 ktopm(i)=0<a name='674'>
              endif<a name='675'>
<a name='676'>
            ENDDO<a name='677'>
            DO I=ibegc,iendc<a name='678'>
            DO K=kts,ktf<a name='679'>
               RTHCUTEN(I,K,J)= (cutens(i)*outts(i,k)+ &amp;<a name='680'>
                                 cutenm(i)*outtm(i,k)+ &amp;<a name='681'>
                                 cuten(i)* outt(i,k)  )/pi(i,k,j)<a name='682'>
               RQVCUTEN(I,K,J)= cuten(i)*outq(i,k)   + &amp;<a name='683'>
                                cutens(i)*outqs(i,k)+  &amp;<a name='684'>
                                cutenm(i)*outqm(i,k)<a name='685'>
               DUDT_PHY(I,K,J)=outum(i,k)*cutenm(i)+outu(i,k)*cuten(i)<a name='686'>
               DVDT_PHY(I,K,J)=outvm(i,k)*cutenm(i)+outv(i,k)*cuten(i)<a name='687'>
            ENDDO<a name='688'>
            ENDDO<a name='689'>
<a name='690'>
            DO I=ibegc,iendc<a name='691'>
              if(pret(i).gt.0. .or. pretm(i).gt.0. .or. prets(i).gt.0.)then<a name='692'>
                 pratec(i,j)=cuten(i)*pret(i)+cutenm(i)*pretm(i)+cutens(i)*prets(i)<a name='693'>
                 raincv(i,j)=pratec(i,j)*dt<a name='694'>
                 rkbcon = kte+kts - kbcon(i)<a name='695'>
                 rktop  = kte+kts -  ktop(i)<a name='696'>
                 if (ktop(i)  &gt; HTOP(i,j)) HTOP(i,j) = ktop(i)+.001<a name='697'>
                 if (kbcon(i) &lt; HBOT(i,j)) HBOT(i,j) = kbcon(i)+.001<a name='698'>
              endif<a name='699'>
            ENDDO<a name='700'>
<a name='701'>
            IF(PRESENT(RQCCUTEN)) THEN<a name='702'>
                DO K=kts,ktf<a name='703'>
                DO I=ibegc,iendc<a name='704'>
                   RQCCUTEN(I,K,J)=outqcm(i,k)+outqcs(i,k)+outqc(I,K)*cuten(i)<a name='705'>
                   IF ( PRESENT( GDC ) ) GDC(I,K,J)=cupclwm(i,k)+cupclws(i,k)+CUPCLW(I,K)*cuten(i)<a name='706'>
                   IF ( PRESENT( GDC2 ) ) GDC2(I,K,J)=0.<a name='707'>
                ENDDO<a name='708'>
                ENDDO<a name='709'>
            ENDIF<a name='710'>
<a name='711'>
            IF(PRESENT(RQICUTEN).AND.PRESENT(RQCCUTEN))THEN<a name='712'>
                DO K=kts,ktf<a name='713'>
                  DO I=ibegc,iendc<a name='714'>
                   if(t2d(i,k).lt.258.)then<a name='715'>
                      RQICUTEN(I,K,J)=outqcm(i,k)+outqcs(i,k)+outqc(I,K)*cuten(i)<a name='716'>
                      RQCCUTEN(I,K,J)=0.<a name='717'>
                      IF ( PRESENT( GDC2 ) ) THEN<a name='718'>
                        GDC2(I,K,J)=cupclwm(i,k)+cupclws(i,k)+CUPCLW(I,K)*cuten(i)<a name='719'>
                        GDC(I,K,J) = 0.<a name='720'>
                      ENDIF<a name='721'>
                   else<a name='722'>
                      RQICUTEN(I,K,J)=0.<a name='723'>
                      RQCCUTEN(I,K,J)=outqcm(i,k)+outqcs(i,k)+outqc(I,K)*cuten(i)<a name='724'>
                      IF ( PRESENT( GDC ) ) THEN<a name='725'>
                        GDC(I,K,J)=cupclwm(i,k)+cupclws(i,k)+CUPCLW(I,K)*cuten(i)<a name='726'>
                        GDC2(I,K,J) = 0.<a name='727'>
                      ENDIF<a name='728'>
                   endif<a name='729'>
                ENDDO<a name='730'>
                ENDDO<a name='731'>
            ENDIF<a name='732'>
 100    continue<a name='733'>
<a name='734'>
   END SUBROUTINE GFDRV<a name='735'>
END MODULE MODULE_CU_GF_WRFDRV<a name='736'>
</pre></body></html>