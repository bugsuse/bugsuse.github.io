<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<A NAME='MODULE_MP_GSFCGCE'><A href='../../html_code/phys/module_mp_gsfcgce.F.html#MODULE_MP_GSFCGCE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
<font color=#993300>MODULE </font><font color=#cc0000>module_mp_gsfcgce</font> <A href='../../call_to/MODULE_MP_GSFCGCE.html' TARGET='index'>1</A><a name='6'>
<a name='7'>
   USE     <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#module_mp_gsfcgce.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_60"><a name='8'>
   USE module_utility, ONLY: WRFU_Clock, WRFU_Alarm<a name='9'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#module_mp_gsfcgce.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_236">, ONLY : HISTORY_ALARM, Is_alarm_tstep<a name='10'>
   USE <A href='../../html_code/phys/module_mp_radar.F.html#MODULE_MP_RADAR'>module_mp_radar</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#module_mp_gsfcgce.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MP_RADAR_3"><a name='11'>
<a name='12'>
<font color=#447700>!JJS 1/3/2008     vvvvv<a name='13'></font>
<a name='14'>
<font color=#447700>!  common /bt/<a name='15'></font>
   REAL,    PRIVATE ::          rd1,  rd2,   al,   cp<a name='16'>
<a name='17'>
<font color=#447700>!  common /cont/<a name='18'></font>
   REAL,    PRIVATE ::          c38, c358, c610, c149, &amp;<a name='19'>
                               c879, c172, c409,  c76, &amp;<a name='20'>
                               c218, c580, c141<a name='21'>
<font color=#447700>!  common /b3cs/<a name='22'></font>
   REAL,    PRIVATE ::           ag,   bg,   as,   bs, &amp;<a name='23'>
                                 aw,   bw,  bgh,  bgq, &amp;<a name='24'>
                                bsh,  bsq,  bwh,  bwq<a name='25'>
<a name='26'>
<font color=#447700>!  common /size/<a name='27'></font>
   REAL,    PRIVATE ::          tnw,  tns,  tng,       &amp;<a name='28'>
                               roqs, roqg, roqr<a name='29'>
<a name='30'>
<font color=#447700>!  common /bterv/<a name='31'></font>
   REAL,    PRIVATE ::          zrc,  zgc,  zsc,       &amp;<a name='32'>
                                vrc,  vgc,  vsc<a name='33'>
<a name='34'>
<font color=#447700>!  common /bsnw/<a name='35'></font>
   REAL,    PRIVATE ::          alv,  alf,  als,   t0,   t00,     &amp;<a name='36'>
                                avc,  afc,  asc,  rn1,  bnd1,     &amp;<a name='37'>
                                rn2, bnd2,  rn3,  rn4,   rn5,     &amp;<a name='38'>
                                rn6,  rn7,  rn8,  rn9,  rn10,     &amp;<a name='39'>
                              rn101,rn10a, rn11,rn11a,  rn12<a name='40'>
<a name='41'>
   REAL,    PRIVATE ::         rn14, rn15,rn15a, rn16,  rn17,     &amp;<a name='42'>
                              rn17a,rn17b,rn17c, rn18, rn18a,     &amp;<a name='43'>
                               rn19,rn19a,rn19b, rn20, rn20a,     &amp;<a name='44'>
                              rn20b, bnd3, rn21, rn22,  rn23,     &amp;<a name='45'>
                              rn23a,rn23b, rn25,rn30a, rn30b,     &amp;<a name='46'>
                              rn30c, rn31, beta, rn32<a name='47'>
<a name='48'>
   REAL,    PRIVATE, DIMENSION( 31 ) ::    rn12a, rn12b, rn13, rn25a<a name='49'>
<a name='50'>
<font color=#447700>!  common /rsnw1/<a name='51'></font>
   REAL,    PRIVATE ::         rn10b, rn10c, rnn191, rnn192,  rn30,     &amp;<a name='52'>
                             rnn30a,  rn33,  rn331,  rn332<a name='53'>
<a name='54'>
<font color=#447700>!<a name='55'></font>
   REAL,    PRIVATE, DIMENSION( 31 )  ::      aa1,  aa2<a name='56'>
   DATA aa1/.7939e-7, .7841e-6, .3369e-5, .4336e-5, .5285e-5,     &amp;<a name='57'>
           .3728e-5, .1852e-5, .2991e-6, .4248e-6, .7434e-6,     &amp;<a name='58'>
           .1812e-5, .4394e-5, .9145e-5, .1725e-4, .3348e-4,     &amp;<a name='59'>
           .1725e-4, .9175e-5, .4412e-5, .2252e-5, .9115e-6,     &amp;<a name='60'>
           .4876e-6, .3473e-6, .4758e-6, .6306e-6, .8573e-6,     &amp;<a name='61'>
           .7868e-6, .7192e-6, .6513e-6, .5956e-6, .5333e-6,     &amp;<a name='62'>
           .4834e-6/<a name='63'>
   DATA aa2/.4006, .4831, .5320, .5307, .5319,      &amp;<a name='64'>
           .5249, .4888, .3894, .4047, .4318,      &amp;<a name='65'>
           .4771, .5183, .5463, .5651, .5813,      &amp;<a name='66'>
           .5655, .5478, .5203, .4906, .4447,      &amp;<a name='67'>
           .4126, .3960, .4149, .4320, .4506,      &amp;<a name='68'>
           .4483, .4460, .4433, .4413, .4382,      &amp;<a name='69'>
           .4361/<a name='70'>
<a name='71'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='72'></font>
<font color=#447700>!..The following 6 variables moved here to facilitate reflectivity<a name='73'></font>
<font color=#447700>!.. calculation similar to other MP schemes, because when they get<a name='74'></font>
<font color=#447700>!.. declared later in the code (now commented out), it makes things<a name='75'></font>
<font color=#447700>!.. more difficult to integreate with the radar code.<a name='76'></font>
      REAL    , PARAMETER ::     xnor = 8.0e6<a name='77'>
      REAL    , PARAMETER ::     xnos = 1.6e7<a name='78'>
      REAL    , PARAMETER ::     xnoh = 2.0e5<a name='79'>
      REAL    , PARAMETER ::     xnog = 4.0e6<a name='80'>
      REAL    , PARAMETER ::     rhohail = 917.<a name='81'>
      REAL    , PARAMETER ::     rhograul = 400.<a name='82'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='83'></font>
<a name='84'>
<font color=#447700>!JJS 1/3/2008     ^^^^^<a name='85'></font>
<a name='86'>
CONTAINS<a name='87'>
<a name='88'>
<font color=#447700>!-------------------------------------------------------------------<a name='89'></font>
<font color=#447700>!  NASA/GSFC GCE<a name='90'></font>
<font color=#447700>!  Tao et al, 2001, Meteo. &amp; Atmos. Phy., 97-137<a name='91'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='92'></font>
<font color=#447700>!  SUBROUTINE gsfcgce(  th, th_old,                                 &amp;<a name='93'></font>
<A NAME='GSFCGCE'><A href='../../html_code/phys/module_mp_gsfcgce.F.html#GSFCGCE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='94'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>gsfcgce</font>(  th,                                         &amp; <A href='../../call_to/GSFCGCE.html' TARGET='index'>1</A>,<A href='../../call_from/GSFCGCE.html' TARGET='index'>10</A><a name='95'>
                       qv, ql,                                     &amp;<a name='96'>
                       qr, qi,                                     &amp;<a name='97'>
                       qs,                                         &amp;<a name='98'>
<font color=#447700>!                       qvold, qlold,                               &amp;<a name='99'></font>
<font color=#447700>!                       qrold, qiold,                               &amp;<a name='100'></font>
<font color=#447700>!                       qsold,                                      &amp;<a name='101'></font>
                       rho, pii, p, dt_in, z,                      &amp;<a name='102'>
                       ht, dz8w, grav,                             &amp;<a name='103'>
                       rhowater, rhosnow,                          &amp;<a name='104'>
                       itimestep,                                  &amp;<a name='105'>
                       ids,ide, jds,jde, kds,kde,                  &amp; <font color=#447700>! domain dims<a name='106'></font>
                       ims,ime, jms,jme, kms,kme,                  &amp; <font color=#447700>! memory dims<a name='107'></font>
                       its,ite, jts,jte, kts,kte,                  &amp; <font color=#447700>! tile   dims<a name='108'></font>
                       rainnc, rainncv,                            &amp;<a name='109'>
                       snownc, snowncv, sr,                        &amp;<a name='110'>
                       graupelnc, graupelncv,                      &amp;<a name='111'>
                       refl_10cm, diagflag, do_radar_ref,          &amp;<a name='112'>
<font color=#447700>!                       f_qg, qg, pgold,                            &amp;<a name='113'></font>
                       f_qg, qg,                                   &amp;<a name='114'>
                       ihail, ice2                                 &amp;<a name='115'>
                                                                   )<a name='116'>
<a name='117'>
<font color=#447700>!-------------------------------------------------------------------<a name='118'></font>
  IMPLICIT NONE<a name='119'>
<font color=#447700>!-------------------------------------------------------------------<a name='120'></font>
<font color=#447700>!<a name='121'></font>
<font color=#447700>! JJS 2/15/2005<a name='122'></font>
<font color=#447700>!<a name='123'></font>
  INTEGER,      INTENT(IN   )    ::   ids,ide, jds,jde, kds,kde , &amp;<a name='124'>
                                      ims,ime, jms,jme, kms,kme , &amp;<a name='125'>
                                      its,ite, jts,jte, kts,kte <a name='126'>
  INTEGER,      INTENT(IN   )    ::   itimestep, ihail, ice2 <a name='127'>
<a name='128'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),                 &amp;<a name='129'>
        INTENT(INOUT) ::                                          &amp;<a name='130'>
                                                              th, &amp;<a name='131'>
                                                              qv, &amp;<a name='132'>
                                                              ql, &amp;<a name='133'>
                                                              qr, &amp;<a name='134'>
                                                              qi, &amp;<a name='135'>
                                                              qs, &amp;<a name='136'>
                                                              qg<a name='137'>
<font color=#447700>!<a name='138'></font>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),                 &amp;<a name='139'>
        INTENT(IN   ) ::                                          &amp;<a name='140'>
<font color=#447700>!                                                         th_old, &amp;<a name='141'></font>
<font color=#447700>!                                                          qvold, &amp;<a name='142'></font>
<font color=#447700>!                                                          qlold, &amp;<a name='143'></font>
<font color=#447700>!                                                          qrold, &amp;<a name='144'></font>
<font color=#447700>!                                                          qiold, &amp;<a name='145'></font>
<font color=#447700>!                                                          qsold, &amp;<a name='146'></font>
<font color=#447700>!                                                          qgold, &amp;<a name='147'></font>
                                                             rho, &amp;<a name='148'>
                                                             pii, &amp;<a name='149'>
                                                               p, &amp;<a name='150'>
                                                            dz8w, &amp;<a name='151'>
                                                               z<a name='152'>
<a name='153'>
  REAL, DIMENSION( ims:ime , jms:jme ),                           &amp;<a name='154'>
        INTENT(INOUT) ::                               rainnc,    &amp;<a name='155'>
                                                       rainncv,   &amp;<a name='156'>
                                                       snownc,    &amp;   <a name='157'>
                                                       snowncv,   &amp;<a name='158'>
                                                       sr,        &amp;<a name='159'>
                                                       graupelnc, &amp;<a name='160'>
                                                       graupelncv <a name='161'>
<a name='162'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='163'></font>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT)::           &amp;  <font color=#447700>! GT<a name='164'></font>
                                                       refl_10cm<a name='165'>
  LOGICAL, OPTIONAL, INTENT(IN) :: diagflag<a name='166'>
  INTEGER, OPTIONAL, INTENT(IN) :: do_radar_ref<a name='167'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='168'></font>
<a name='169'>
  REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN) ::       ht<a name='170'>
<a name='171'>
  REAL, INTENT(IN   ) ::                                   dt_in, &amp;<a name='172'>
                                                            grav, &amp;<a name='173'>
                                                        rhowater, &amp;<a name='174'>
                                                         rhosnow<a name='175'>
<a name='176'>
  LOGICAL, INTENT(IN), OPTIONAL :: F_QG<a name='177'>
<a name='178'>
<font color=#447700>!  LOCAL VAR<a name='179'></font>
<a name='180'>
<a name='181'>
<font color=#447700>!jjs  INTEGER             ::                            min_q, max_q<a name='182'></font>
<a name='183'>
<font color=#447700>!jjs  REAL, DIMENSION( its:ite , jts:jte )                            &amp;<a name='184'></font>
<font color=#447700>!jjs                               ::        rain, snow, graupel,ice<a name='185'></font>
<a name='186'>
<font color=#447700>!<a name='187'></font>
<font color=#447700>!  INTEGER :: IHAIL, itaobraun, ice2, istatmin, new_ice_sat, id<a name='188'></font>
  INTEGER ::  itaobraun, istatmin, new_ice_sat, id<a name='189'>
<a name='190'>
  INTEGER :: i, j, k<a name='191'>
  INTEGER :: iskip, ih, icount, ibud, i24h <a name='192'>
  REAL    :: hour<a name='193'>
  REAL    , PARAMETER :: cmin=1.e-20<a name='194'>
  REAL    :: dth, dqv, dqrest, dqall, dqall1, rhotot, a1, a2 <a name='195'>
<font color=#447700>!  REAL, DIMENSION( its:ite , kts:kte , jts:jte ) ::                   &amp;<a name='196'></font>
<font color=#447700>!                         th1, qv1, ql1, qr1, qi1, qs1, qg1<a name='197'></font>
 <a name='198'>
  LOGICAL :: flag_qg<a name='199'>
<a name='200'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='201'></font>
<a name='202'>
      INTEGER:: NCALL=0<a name='203'>
<a name='204'>
      IF (NCALL .EQ. 0) THEN<a name='205'>
<font color=#447700>!..Set these variables needed for computing radar reflectivity.  These<a name='206'></font>
<font color=#447700>!.. get used within radar_init to create other variables used in the<a name='207'></font>
<font color=#447700>!.. radar module.<a name='208'></font>
         xam_r = 3.14159*rhowater/6.<a name='209'>
         xbm_r = 3.<a name='210'>
         xmu_r = 0.<a name='211'>
         xam_s = 3.14159*rhosnow/6.<a name='212'>
         xbm_s = 3.<a name='213'>
         xmu_s = 0.<a name='214'>
         if (ihail .eq. 1) then<a name='215'>
            xam_g = 3.14159*rhohail/6.<a name='216'>
         else<a name='217'>
            xam_g = 3.14159*rhograul/6.<a name='218'>
         endif<a name='219'>
         xbm_g = 3.<a name='220'>
         xmu_g = 0.<a name='221'>
<a name='222'>
         call <A href='../../html_code/phys/module_mp_radar.F.html#RADAR_INIT'>radar_init</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#GSFCGCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADAR_INIT_3"><a name='223'>
         NCALL = 1<a name='224'>
      ENDIF<a name='225'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='226'></font>
<a name='227'>
<font color=#447700>!<a name='228'></font>
<font color=#447700>!c  ihail = 0    for graupel, for tropical region<a name='229'></font>
<font color=#447700>!c  ihail = 1    for hail, for mid-lat region<a name='230'></font>
<a name='231'>
<font color=#447700>! itaobraun: 0 for Tao's constantis, 1 for Braun's constants<a name='232'></font>
<font color=#447700>!c        if ( itaobraun.eq.1 ) --&gt; betah=0.5*beta=-.46*0.5=-0.23;   cn0=1.e-6<a name='233'></font>
<font color=#447700>!c        if ( itaobraun.eq.0 ) --&gt; betah=0.5*beta=-.6*0.5=-0.30;    cn0=1.e-8<a name='234'></font>
   itaobraun = 1<a name='235'>
<a name='236'>
<font color=#447700>!c  ice2 = 0    for 3 ice --- ice, snow and graupel/hail<a name='237'></font>
<font color=#447700>!c  ice2 = 1    for 2 ice --- ice and snow only<a name='238'></font>
<font color=#447700>!c  ice2 = 2    for 2 ice --- ice and graupel only, use ihail = 0 only<a name='239'></font>
<font color=#447700>!c  ice2 = 3    for 0 ice --- no ice, warm only<a name='240'></font>
<a name='241'>
<font color=#447700>!  if (ice2 .eq. 2) ihail = 0<a name='242'></font>
<a name='243'>
  i24h=nint(86400./dt_in)<a name='244'>
  if (mod(itimestep,i24h).eq.1) then<a name='245'>
     write(6,*) 'ihail=',ihail,'  ice2=',ice2<a name='246'>
     if (ice2.eq.0) then<a name='247'>
        write(6,*) 'Running 3-ice scheme in GSFCGCE with'<a name='248'>
        if (ihail.eq.0) then <a name='249'>
           write(6,*) '     ice, snow and graupel'<a name='250'>
        else if (ihail.eq.1) then<a name='251'>
                write(6,*) '     ice, snow and hail'<a name='252'>
        else<a name='253'>
             write(6,*) 'ihail has to be either 1 or 0'<a name='254'>
             stop<a name='255'>
        endif <font color=#447700>!ihail<a name='256'></font>
     else if (ice2.eq.1) then<a name='257'>
             write(6,*) 'Running 2-ice scheme in GSFCGCE with'<a name='258'>
             write(6,*) '     ice and snow'<a name='259'>
     else if (ice2.eq.2) then<a name='260'>
             write(6,*) 'Running 2-ice scheme in GSFCGCE with'<a name='261'>
             write(6,*) '     ice and graupel'<a name='262'>
     else if (ice2.eq.3) then<a name='263'>
             write(6,*) 'Running warm rain only scheme in GSFCGCE without any ice'<a name='264'>
     else<a name='265'>
             write(6,*) 'gsfcgce_2ice in namelist.input has to be 0, 1, 2, or 3'<a name='266'>
             stop<a name='267'>
     endif <font color=#447700>!ice2<a name='268'></font>
  endif <font color=#447700>!itimestep<a name='269'></font>
<a name='270'>
<font color=#447700>!c  new_ice_sat = 0, 1 or 2 <a name='271'></font>
    new_ice_sat = 2 <a name='272'>
<a name='273'>
<font color=#447700>!c istatmin<a name='274'></font>
    istatmin = 180<a name='275'>
<a name='276'>
<font color=#447700>!c id = 0  without in-line staticstics<a name='277'></font>
<font color=#447700>!c id = 1  with in-line staticstics<a name='278'></font>
    id = 0<a name='279'>
<a name='280'>
<font color=#447700>!c ibud = 0 no calculation of dth, dqv, dqrest and dqall<a name='281'></font>
<font color=#447700>!c ibud = 1 yes<a name='282'></font>
    ibud = 0<a name='283'>
<a name='284'>
<font color=#447700>!jjs   dt=dt_in<a name='285'></font>
<font color=#447700>!jjs   rhoe_s=1.29<a name='286'></font>
<font color=#447700>!<a name='287'></font>
<font color=#447700>!   IF (P_QI .lt. P_FIRST_SCALAR .or. P_QS .lt. P_FIRST_SCALAR) THEN<a name='288'></font>
<font color=#447700>!      CALL wrf_error_fatal3 ( "module_mp_lin.b" , 130 ,  'module_mp_lin: Improper use of Lin et al scheme; no ice phase. Please chose another one.')<a name='289'></font>
<font color=#447700>!   ENDIF<a name='290'></font>
<a name='291'>
<font color=#447700>! calculte fallflux and precipiation in MKS system<a name='292'></font>
<a name='293'>
   call <A href='../../html_code/phys/module_mp_gsfcgce.F.html#FALL_FLUX'>fall_flux</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#GSFCGCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FALL_FLUX_1">(dt_in, qr, qi, qs, qg, p,                   &amp;<a name='294'>
                      rho, z, dz8w, ht, rainnc,               &amp;<a name='295'>
                      rainncv, grav,itimestep,                &amp;<a name='296'>
                      rhowater, rhosnow,                      &amp;<a name='297'>
                      snownc, snowncv, sr,                    &amp;<a name='298'>
                      graupelnc, graupelncv,                  &amp;<a name='299'>
                      ihail, ice2,                            &amp;<a name='300'>
                      ims,ime, jms,jme, kms,kme,              &amp; <font color=#447700>! memory dims<a name='301'></font>
                      its,ite, jts,jte, kts,kte               ) <font color=#447700>! tile   dims<a name='302'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='303'></font>
<a name='304'>
<font color=#447700>!c  set up constants used internally in GCE<a name='305'></font>
<a name='306'>
   call <A href='../../html_code/phys/module_mp_gsfcgce.F.html#CONSAT_S'>consat_s</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#GSFCGCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSAT_S_1"> (ihail, itaobraun)<a name='307'>
<a name='308'>
<a name='309'>
<font color=#447700>!c Negative values correction<a name='310'></font>
<a name='311'>
   iskip = 1<a name='312'>
 <a name='313'>
   if (iskip.eq.0) then<a name='314'>
      call <A href='../../html_code/phys/module_mp_gsfcgce.F.html#NEGCOR'>negcor</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#GSFCGCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NEGCOR_1">(qv,rho,dz8w,ims,ime,jms,jme,kms,kme, &amp;<a name='315'>
                           itimestep,1,             &amp;<a name='316'>
                           its,ite,jts,jte,kts,kte)<a name='317'>
      call <A href='../../html_code/phys/module_mp_gsfcgce.F.html#NEGCOR'>negcor</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#GSFCGCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NEGCOR_2">(ql,rho,dz8w,ims,ime,jms,jme,kms,kme, &amp;<a name='318'>
                           itimestep,2,             &amp;<a name='319'>
                           its,ite,jts,jte,kts,kte)<a name='320'>
      call <A href='../../html_code/phys/module_mp_gsfcgce.F.html#NEGCOR'>negcor</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#GSFCGCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NEGCOR_3">(qr,rho,dz8w,ims,ime,jms,jme,kms,kme, &amp;<a name='321'>
                           itimestep,3,             &amp;<a name='322'>
                           its,ite,jts,jte,kts,kte)<a name='323'>
      call <A href='../../html_code/phys/module_mp_gsfcgce.F.html#NEGCOR'>negcor</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#GSFCGCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NEGCOR_4">(qi,rho,dz8w,ims,ime,jms,jme,kms,kme, &amp;<a name='324'>
                           itimestep,4,             &amp;<a name='325'>
                           its,ite,jts,jte,kts,kte)<a name='326'>
      call <A href='../../html_code/phys/module_mp_gsfcgce.F.html#NEGCOR'>negcor</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#GSFCGCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NEGCOR_5">(qs,rho,dz8w,ims,ime,jms,jme,kms,kme, &amp;<a name='327'>
                           itimestep,5,             &amp;<a name='328'>
                           its,ite,jts,jte,kts,kte)<a name='329'>
      call <A href='../../html_code/phys/module_mp_gsfcgce.F.html#NEGCOR'>negcor</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#GSFCGCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NEGCOR_6">(qg,rho,dz8w,ims,ime,jms,jme,kms,kme, &amp;<a name='330'>
                           itimestep,6,             &amp;<a name='331'>
                           its,ite,jts,jte,kts,kte)<a name='332'>
<font color=#447700>!   else if (mod(itimestep,i24h).eq.1) then<a name='333'></font>
<font color=#447700>!      print *,'no neg correction in mp at timestep=',itimestep<a name='334'></font>
   endif <font color=#447700>! iskip<a name='335'></font>
<a name='336'>
<font color=#447700>!c microphysics in GCE<a name='337'></font>
<a name='338'>
   call <A href='../../html_code/phys/module_mp_gsfcgce.F.html#SATICEL_S'>SATICEL_S</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#GSFCGCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SATICEL_S_1">( dt_in, IHAIL, itaobraun, ICE2, istatmin,     &amp;<a name='339'>
                   new_ice_sat, id,                             &amp;<a name='340'>
<font color=#447700>!                   th, th_old, qv, ql, qr,                      &amp;<a name='341'></font>
                   th, qv, ql, qr,                      &amp;<a name='342'>
                   qi, qs, qg,                                  &amp;<a name='343'>
<font color=#447700>!                   qvold, qlold, qrold,                         &amp;<a name='344'></font>
<font color=#447700>!                   qiold, qsold, qgold,                         &amp;<a name='345'></font>
                   rho, pii, p, itimestep,                      &amp; <a name='346'>
                   refl_10cm, diagflag, do_radar_ref,           &amp; <font color=#447700>! GT added for reflectivity calcs<a name='347'></font>
<font color=#447700>!                  refl_10cm, grid_clock, grid_alarms,          &amp; ! GT added for reflectivity calcs<a name='348'></font>
                   ids,ide, jds,jde, kds,kde,                   &amp; <font color=#447700>! domain dims<a name='349'></font>
                   ims,ime, jms,jme, kms,kme,                   &amp; <font color=#447700>! memory dims<a name='350'></font>
                   its,ite, jts,jte, kts,kte                    &amp; <font color=#447700>! tile   dims<a name='351'></font>
                                                                ) <a name='352'>
<a name='353'>
<a name='354'>
   END SUBROUTINE gsfcgce<a name='355'>
<a name='356'>
<font color=#447700>!-----------------------------------------------------------------------<a name='357'></font>
<A NAME='FALL_FLUX'><A href='../../html_code/phys/module_mp_gsfcgce.F.html#FALL_FLUX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='358'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>fall_flux</font> ( dt, qr, qi, qs, qg, p,              &amp; <A href='../../call_to/FALL_FLUX.html' TARGET='index'>1</A>,<A href='../../call_from/FALL_FLUX.html' TARGET='index'>4</A><a name='359'>
                      rho, z, dz8w, topo, rainnc,             &amp;<a name='360'>
                      rainncv, grav, itimestep,               &amp;<a name='361'>
                      rhowater, rhosnow,                      &amp;<a name='362'>
                      snownc, snowncv, sr,                    &amp;<a name='363'>
                      graupelnc, graupelncv,                  &amp;<a name='364'>
                      ihail, ice2,                            &amp;<a name='365'>
                      ims,ime, jms,jme, kms,kme,              &amp; <font color=#447700>! memory dims<a name='366'></font>
                      its,ite, jts,jte, kts,kte               ) <font color=#447700>! tile   dims<a name='367'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='368'></font>
<font color=#447700>! adopted from Jiun-Dar Chern's codes for Purdue Regional Model<a name='369'></font>
<font color=#447700>! adopted by Jainn J. Shi, 6/10/2005<a name='370'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='371'></font>
<a name='372'>
  IMPLICIT NONE<a name='373'>
  INTEGER, INTENT(IN   )               :: ihail, ice2,                &amp;<a name='374'>
                                          ims,ime, jms,jme, kms,kme,  &amp;<a name='375'>
                                          its,ite, jts,jte, kts,kte <a name='376'>
  INTEGER, INTENT(IN   )               :: itimestep<a name='377'>
  REAL,    DIMENSION( ims:ime , kms:kme , jms:jme ),                  &amp;<a name='378'>
           INTENT(INOUT)               :: qr, qi, qs, qg       <a name='379'>
  REAL,    DIMENSION( ims:ime , jms:jme ),                            &amp;<a name='380'>
           INTENT(INOUT)               :: rainnc, rainncv,            &amp;<a name='381'>
                                          snownc, snowncv, sr,        &amp;<a name='382'>
                                          graupelnc, graupelncv<a name='383'>
  REAL,    DIMENSION( ims:ime , kms:kme , jms:jme ),                  &amp;<a name='384'>
           INTENT(IN   )               :: rho, z, dz8w, p<a name='385'>
<a name='386'>
  REAL,    INTENT(IN   )               :: dt, grav, rhowater, rhosnow<a name='387'>
<a name='388'>
<a name='389'>
  REAL,    DIMENSION( ims:ime , jms:jme ),                            &amp;<a name='390'>
           INTENT(IN   )               :: topo   <a name='391'>
<a name='392'>
<font color=#447700>! temperary vars<a name='393'></font>
<a name='394'>
  REAL,    DIMENSION( kts:kte )           :: sqrhoz<a name='395'>
  REAL                                    :: tmp1, term0<a name='396'>
  REAL                                :: pptrain, pptsnow,        &amp;<a name='397'>
                                         pptgraul, pptice<a name='398'>
  REAL,    DIMENSION( kts:kte )       :: qrz, qiz, qsz, qgz,      &amp;<a name='399'>
                                         zz, dzw, prez, rhoz,     &amp;<a name='400'>
                                         orhoz<a name='401'>
<a name='402'>
<a name='403'>
   INTEGER                    :: k, i, j<a name='404'>
<font color=#447700>!<a name='405'></font>
<a name='406'>
  REAL, DIMENSION( kts:kte )    :: vtr, vts, vtg, vti<a name='407'>
<a name='408'>
  REAL                          :: dtb, pi, consta, constc, gambp4,    &amp;<a name='409'>
                                   gamdp4, gam4pt5, gam4bbar<a name='410'>
<a name='411'>
<font color=#447700>!  Lin<a name='412'></font>
<font color=#447700>!-GT  REAL    , PARAMETER ::     xnor = 8.0e6<a name='413'></font>
<font color=#447700>!   REAL    , PARAMETER ::     xnos = 3.0e6<a name='414'></font>
<font color=#447700>!-GT   REAL    , PARAMETER ::     xnos = 1.6e7   ! Tao's value<a name='415'></font>
   REAL    , PARAMETER ::                              &amp;<a name='416'>
<font color=#447700>!             constb = 0.8, constd = 0.25, o6 = 1./6.,           &amp;<a name='417'></font>
             constb = 0.8, constd = 0.11, o6 = 1./6.,           &amp;<a name='418'>
             cdrag = 0.6<a name='419'>
<font color=#447700>!  Lin<a name='420'></font>
<font color=#447700>!  REAL    , PARAMETER ::     xnoh = 4.0e4<a name='421'></font>
<font color=#447700>!-GT  REAL    , PARAMETER ::     xnoh = 2.0e5    ! Tao's value<a name='422'></font>
<font color=#447700>!-GT  REAL    , PARAMETER ::     rhohail = 917.<a name='423'></font>
<a name='424'>
<font color=#447700>! Hobbs<a name='425'></font>
<font color=#447700>!-GT  REAL    , PARAMETER ::     xnog = 4.0e6<a name='426'></font>
<font color=#447700>!-GT  REAL    , PARAMETER ::     rhograul = 400.<a name='427'></font>
  REAL    , PARAMETER ::     abar = 19.3, bbar = 0.37,      &amp;<a name='428'>
                                      p0 = 1.0e5<a name='429'>
<a name='430'>
  REAL    , PARAMETER ::     rhoe_s = 1.29<a name='431'>
<a name='432'>
<font color=#447700>! for terminal velocity flux<a name='433'></font>
  INTEGER                       :: min_q, max_q<a name='434'>
  REAL                          :: t_del_tv, del_tv, flux, fluxin, fluxout ,tmpqrz<a name='435'>
  LOGICAL                       :: notlast<a name='436'>
<a name='437'>
<font color=#447700>!  if (itimestep.eq.1) then<a name='438'></font>
<font color=#447700>!     write(6, *) 'in fall_flux'<a name='439'></font>
<font color=#447700>!     write(6, *) 'ims=', ims, '  ime=', ime<a name='440'></font>
<font color=#447700>!     write(6, *) 'jms=', jms, '  jme=', jme<a name='441'></font>
<font color=#447700>!     write(6, *) 'kms=', kms, '  kme=', kme<a name='442'></font>
<font color=#447700>!     write(6, *) 'its=', its, '  ite=', ite<a name='443'></font>
<font color=#447700>!     write(6, *) 'jts=', jts, '  jte=', jte<a name='444'></font>
<font color=#447700>!     write(6, *) 'kts=', kts, '  kte=', kte<a name='445'></font>
<font color=#447700>!     write(6, *) 'dt=', dt<a name='446'></font>
<font color=#447700>!     write(6, *) 'ihail=', ihail<a name='447'></font>
<font color=#447700>!     write(6, *) 'ICE2=', ICE2<a name='448'></font>
<font color=#447700>!     write(6, *) 'dt=', dt<a name='449'></font>
<font color=#447700>!   endif <a name='450'></font>
<a name='451'>
<font color=#447700>!-----------------------------------------------------------------------<a name='452'></font>
<font color=#447700>!  This program calculates precipitation fluxes due to terminal velocities.<a name='453'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='454'></font>
<a name='455'>
   dtb=dt<a name='456'>
   pi=acos(-1.)<a name='457'>
   consta=2115.0*0.01**(1-constb)<a name='458'>
<font color=#447700>!   constc=152.93*0.01**(1-constd)<a name='459'></font>
   constc=78.63*0.01**(1-constd)<a name='460'>
<a name='461'>
<font color=#447700>!  Gamma function<a name='462'></font>
   gambp4=<A href='../../html_code/phys/module_mp_sbu_ylin.F.html#GGAMMA'>ggamma</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#FALL_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GGAMMA_1">(constb+4.)<a name='463'>
   gamdp4=<A href='../../html_code/phys/module_mp_sbu_ylin.F.html#GGAMMA'>ggamma</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#FALL_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GGAMMA_2">(constd+4.)<a name='464'>
   gam4pt5=<A href='../../html_code/phys/module_mp_sbu_ylin.F.html#GGAMMA'>ggamma</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#FALL_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GGAMMA_3">(4.5)<a name='465'>
   gam4bbar=<A href='../../html_code/phys/module_mp_sbu_ylin.F.html#GGAMMA'>ggamma</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#FALL_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GGAMMA_4">(4.+bbar)<a name='466'>
<a name='467'>
<font color=#447700>!***********************************************************************<a name='468'></font>
<font color=#447700>! Calculate precipitation fluxes due to terminal velocities.<a name='469'></font>
<font color=#447700>!***********************************************************************<a name='470'></font>
<font color=#447700>!<a name='471'></font>
<font color=#447700>!- Calculate termianl velocity (vt?)  of precipitation q?z<a name='472'></font>
<font color=#447700>!- Find maximum vt? to determine the small delta t<a name='473'></font>
<a name='474'>
 j_loop:  do j = jts, jte<a name='475'>
 i_loop:  do i = its, ite<a name='476'>
<a name='477'>
   pptrain = 0.<a name='478'>
   pptsnow = 0.<a name='479'>
   pptgraul = 0.<a name='480'>
   pptice  = 0.<a name='481'>
<a name='482'>
   do k = kts, kte<a name='483'>
      qrz(k)=qr(i,k,j)<a name='484'>
      rhoz(k)=rho(i,k,j)<a name='485'>
      orhoz(k)=1./rhoz(k)<a name='486'>
      prez(k)=p(i,k,j)<a name='487'>
      sqrhoz(k)=sqrt(rhoe_s/rhoz(k))<a name='488'>
      zz(k)=z(i,k,j)<a name='489'>
      dzw(k)=dz8w(i,k,j)<a name='490'>
   enddo <font color=#447700>!k<a name='491'></font>
<a name='492'>
      DO k = kts, kte<a name='493'>
         qiz(k)=qi(i,k,j)<a name='494'>
      ENDDO<a name='495'>
<a name='496'>
      DO k = kts, kte<a name='497'>
         qsz(k)=qs(i,k,j)<a name='498'>
      ENDDO<a name='499'>
<a name='500'>
   IF (ice2 .eq. 0) THEN<a name='501'>
      DO k = kts, kte<a name='502'>
         qgz(k)=qg(i,k,j)<a name='503'>
      ENDDO<a name='504'>
   ELSE<a name='505'>
      DO k = kts, kte<a name='506'>
         qgz(k)=0.<a name='507'>
      ENDDO<a name='508'>
   ENDIF<a name='509'>
<a name='510'>
<a name='511'>
<font color=#447700>!<a name='512'></font>
<font color=#447700>!-- rain<a name='513'></font>
<font color=#447700>!<a name='514'></font>
    t_del_tv=0.<a name='515'>
    del_tv=dtb<a name='516'>
    notlast=.true.<a name='517'>
    DO while (notlast)<a name='518'>
<font color=#447700>!<a name='519'></font>
      min_q=kte<a name='520'>
      max_q=kts-1<a name='521'>
<font color=#447700>!<a name='522'></font>
      do k=kts,kte-1<a name='523'>
         if (qrz(k) .gt. 1.0e-8) then<a name='524'>
            min_q=min0(min_q,k)<a name='525'>
            max_q=max0(max_q,k)<a name='526'>
            tmp1=sqrt(pi*rhowater*xnor/rhoz(k)/qrz(k))<a name='527'>
            tmp1=sqrt(tmp1)<a name='528'>
            vtr(k)=consta*gambp4*sqrhoz(k)/tmp1**constb<a name='529'>
            vtr(k)=vtr(k)/6.<a name='530'>
            if (k .eq. 1) then<a name='531'>
               del_tv=amin1(del_tv,0.9*(zz(k)-topo(i,j))/vtr(k))<a name='532'>
            else<a name='533'>
               del_tv=amin1(del_tv,0.9*(zz(k)-zz(k-1))/vtr(k))<a name='534'>
            endif<a name='535'>
         else<a name='536'>
            vtr(k)=0.<a name='537'>
         endif<a name='538'>
      enddo<a name='539'>
<a name='540'>
      if (max_q .ge. min_q) then<a name='541'>
<font color=#447700>!<a name='542'></font>
<font color=#447700>!- Check if the summation of the small delta t &gt;=  big delta t<a name='543'></font>
<font color=#447700>!             (t_del_tv)          (del_tv)             (dtb)<a name='544'></font>
<a name='545'>
         t_del_tv=t_del_tv+del_tv<a name='546'>
<font color=#447700>!<a name='547'></font>
         if ( t_del_tv .ge. dtb ) then<a name='548'>
              notlast=.false.<a name='549'>
              del_tv=dtb+del_tv-t_del_tv<a name='550'>
         endif<a name='551'>
<a name='552'>
<font color=#447700>! use small delta t to calculate the qrz flux<a name='553'></font>
<font color=#447700>! termi is the qrz flux pass in the grid box through the upper boundary<a name='554'></font>
<font color=#447700>! termo is the qrz flux pass out the grid box through the lower boundary<a name='555'></font>
<font color=#447700>!<a name='556'></font>
         fluxin=0.<a name='557'>
         do k=max_q,min_q,-1<a name='558'>
            fluxout=rhoz(k)*vtr(k)*qrz(k)<a name='559'>
            flux=(fluxin-fluxout)/rhoz(k)/dzw(k)<a name='560'>
<font color=#447700>!            tmpqrz=qrz(k)<a name='561'></font>
            qrz(k)=qrz(k)+del_tv*flux<a name='562'>
            qrz(k)=amax1(0.,qrz(k))<a name='563'>
            qr(i,k,j)=qrz(k)<a name='564'>
            fluxin=fluxout<a name='565'>
         enddo<a name='566'>
         if (min_q .eq. 1) then<a name='567'>
            pptrain=pptrain+fluxin*del_tv<a name='568'>
         else<a name='569'>
            qrz(min_q-1)=qrz(min_q-1)+del_tv*  &amp;<a name='570'>
                          fluxin/rhoz(min_q-1)/dzw(min_q-1)<a name='571'>
            qr(i,min_q-1,j)=qrz(min_q-1)<a name='572'>
         endif<a name='573'>
<font color=#447700>!<a name='574'></font>
      else<a name='575'>
         notlast=.false.<a name='576'>
      endif<a name='577'>
    ENDDO<a name='578'>
<a name='579'>
<font color=#447700>!<a name='580'></font>
<font color=#447700>!-- snow<a name='581'></font>
<font color=#447700>!<a name='582'></font>
    t_del_tv=0.<a name='583'>
    del_tv=dtb<a name='584'>
    notlast=.true.<a name='585'>
<a name='586'>
    DO while (notlast)<a name='587'>
<font color=#447700>!<a name='588'></font>
      min_q=kte<a name='589'>
      max_q=kts-1<a name='590'>
<font color=#447700>!<a name='591'></font>
      do k=kts,kte-1<a name='592'>
         if (qsz(k) .gt. 1.0e-8) then<a name='593'>
            min_q=min0(min_q,k)<a name='594'>
            max_q=max0(max_q,k)<a name='595'>
            tmp1=sqrt(pi*rhosnow*xnos/rhoz(k)/qsz(k))<a name='596'>
            tmp1=sqrt(tmp1)<a name='597'>
            vts(k)=constc*gamdp4*sqrhoz(k)/tmp1**constd<a name='598'>
            vts(k)=vts(k)/6.<a name='599'>
            if (k .eq. 1) then<a name='600'>
               del_tv=amin1(del_tv,0.9*(zz(k)-topo(i,j))/vts(k))<a name='601'>
            else<a name='602'>
               del_tv=amin1(del_tv,0.9*(zz(k)-zz(k-1))/vts(k))<a name='603'>
            endif<a name='604'>
         else<a name='605'>
            vts(k)=0.<a name='606'>
         endif<a name='607'>
      enddo<a name='608'>
<a name='609'>
      if (max_q .ge. min_q) then<a name='610'>
<font color=#447700>!<a name='611'></font>
<font color=#447700>!<a name='612'></font>
<font color=#447700>!- Check if the summation of the small delta t &gt;=  big delta t<a name='613'></font>
<font color=#447700>!             (t_del_tv)          (del_tv)             (dtb)<a name='614'></font>
<a name='615'>
         t_del_tv=t_del_tv+del_tv<a name='616'>
<a name='617'>
         if ( t_del_tv .ge. dtb ) then<a name='618'>
              notlast=.false.<a name='619'>
              del_tv=dtb+del_tv-t_del_tv<a name='620'>
         endif<a name='621'>
<a name='622'>
<font color=#447700>! use small delta t to calculate the qsz flux<a name='623'></font>
<font color=#447700>! termi is the qsz flux pass in the grid box through the upper boundary<a name='624'></font>
<font color=#447700>! termo is the qsz flux pass out the grid box through the lower boundary<a name='625'></font>
<font color=#447700>!<a name='626'></font>
         fluxin=0.<a name='627'>
         do k=max_q,min_q,-1<a name='628'>
            fluxout=rhoz(k)*vts(k)*qsz(k)<a name='629'>
            flux=(fluxin-fluxout)/rhoz(k)/dzw(k)<a name='630'>
            qsz(k)=qsz(k)+del_tv*flux<a name='631'>
            qsz(k)=amax1(0.,qsz(k))<a name='632'>
            qs(i,k,j)=qsz(k)<a name='633'>
            fluxin=fluxout<a name='634'>
         enddo<a name='635'>
         if (min_q .eq. 1) then<a name='636'>
            pptsnow=pptsnow+fluxin*del_tv<a name='637'>
         else<a name='638'>
            qsz(min_q-1)=qsz(min_q-1)+del_tv*  &amp;<a name='639'>
                         fluxin/rhoz(min_q-1)/dzw(min_q-1)<a name='640'>
            qs(i,min_q-1,j)=qsz(min_q-1)<a name='641'>
         endif<a name='642'>
<font color=#447700>!<a name='643'></font>
      else<a name='644'>
         notlast=.false.<a name='645'>
      endif<a name='646'>
<a name='647'>
    ENDDO<a name='648'>
<a name='649'>
<font color=#447700>!<a name='650'></font>
<font color=#447700>!   ice2=0 --- with hail/graupel <a name='651'></font>
<font color=#447700>!   ice2=1 --- without hail/graupel <a name='652'></font>
<font color=#447700>!<a name='653'></font>
  if (ice2.eq.0) then <a name='654'>
<font color=#447700>!<a name='655'></font>
<font color=#447700>!-- If IHAIL=1, use hail.<a name='656'></font>
<font color=#447700>!-- If IHAIL=0, use graupel.<a name='657'></font>
<font color=#447700>!<a name='658'></font>
<font color=#447700>!    if (ihail .eq. 1) then<a name='659'></font>
<font color=#447700>!       xnog = xnoh<a name='660'></font>
<font color=#447700>!       rhograul = rhohail<a name='661'></font>
<font color=#447700>!    endif<a name='662'></font>
<a name='663'>
    t_del_tv=0.<a name='664'>
    del_tv=dtb<a name='665'>
    notlast=.true.<a name='666'>
<font color=#447700>!<a name='667'></font>
    DO while (notlast)<a name='668'>
<font color=#447700>!<a name='669'></font>
      min_q=kte<a name='670'>
      max_q=kts-1<a name='671'>
<font color=#447700>!<a name='672'></font>
      do k=kts,kte-1<a name='673'>
         if (qgz(k) .gt. 1.0e-8) then<a name='674'>
            if (ihail .eq. 1) then<a name='675'>
<font color=#447700>!  for hail, based on Lin et al (1983)<a name='676'></font>
              min_q=min0(min_q,k)<a name='677'>
              max_q=max0(max_q,k)<a name='678'>
              tmp1=sqrt(pi*rhohail*xnoh/rhoz(k)/qgz(k))<a name='679'>
              tmp1=sqrt(tmp1)<a name='680'>
              term0=sqrt(4.*grav*rhohail/3./rhoz(k)/cdrag)<a name='681'>
              vtg(k)=gam4pt5*term0*sqrt(1./tmp1)<a name='682'>
              vtg(k)=vtg(k)/6.<a name='683'>
              if (k .eq. 1) then<a name='684'>
                 del_tv=amin1(del_tv,0.9*(zz(k)-topo(i,j))/vtg(k))<a name='685'>
              else<a name='686'>
                 del_tv=amin1(del_tv,0.9*(zz(k)-zz(k-1))/vtg(k))<a name='687'>
              endif <font color=#447700>!k<a name='688'></font>
            else<a name='689'>
<font color=#447700>! added by JJS<a name='690'></font>
<font color=#447700>! for graupel, based on RH (1984)<a name='691'></font>
              min_q=min0(min_q,k)<a name='692'>
              max_q=max0(max_q,k)<a name='693'>
              tmp1=sqrt(pi*rhograul*xnog/rhoz(k)/qgz(k))<a name='694'>
              tmp1=sqrt(tmp1)<a name='695'>
              tmp1=tmp1**bbar<a name='696'>
              tmp1=1./tmp1<a name='697'>
              term0=abar*gam4bbar/6.<a name='698'>
              vtg(k)=term0*tmp1*(p0/prez(k))**0.4<a name='699'>
              if (k .eq. 1) then<a name='700'>
                 del_tv=amin1(del_tv,0.9*(zz(k)-topo(i,j))/vtg(k))<a name='701'>
              else<a name='702'>
                 del_tv=amin1(del_tv,0.9*(zz(k)-zz(k-1))/vtg(k))<a name='703'>
              endif <font color=#447700>!k<a name='704'></font>
            endif <font color=#447700>!ihail<a name='705'></font>
         else<a name='706'>
            vtg(k)=0.<a name='707'>
         endif <font color=#447700>!qgz<a name='708'></font>
      enddo <font color=#447700>!k<a name='709'></font>
<a name='710'>
      if (max_q .ge. min_q) then<a name='711'>
<font color=#447700>!<a name='712'></font>
<font color=#447700>!<a name='713'></font>
<font color=#447700>!- Check if the summation of the small delta t &gt;=  big delta t<a name='714'></font>
<font color=#447700>!             (t_del_tv)          (del_tv)             (dtb)<a name='715'></font>
<a name='716'>
         t_del_tv=t_del_tv+del_tv<a name='717'>
<a name='718'>
         if ( t_del_tv .ge. dtb ) then<a name='719'>
              notlast=.false.<a name='720'>
              del_tv=dtb+del_tv-t_del_tv<a name='721'>
         endif<a name='722'>
<a name='723'>
<font color=#447700>! use small delta t to calculate the qgz flux<a name='724'></font>
<font color=#447700>! termi is the qgz flux pass in the grid box through the upper boundary<a name='725'></font>
<font color=#447700>! termo is the qgz flux pass out the grid box through the lower boundary<a name='726'></font>
<font color=#447700>!<a name='727'></font>
         fluxin=0.<a name='728'>
         do k=max_q,min_q,-1<a name='729'>
            fluxout=rhoz(k)*vtg(k)*qgz(k)<a name='730'>
            flux=(fluxin-fluxout)/rhoz(k)/dzw(k)<a name='731'>
            qgz(k)=qgz(k)+del_tv*flux<a name='732'>
            qgz(k)=amax1(0.,qgz(k))<a name='733'>
            qg(i,k,j)=qgz(k)<a name='734'>
            fluxin=fluxout<a name='735'>
         enddo<a name='736'>
         if (min_q .eq. 1) then<a name='737'>
            pptgraul=pptgraul+fluxin*del_tv<a name='738'>
         else<a name='739'>
            qgz(min_q-1)=qgz(min_q-1)+del_tv*  &amp;<a name='740'>
                         fluxin/rhoz(min_q-1)/dzw(min_q-1)<a name='741'>
            qg(i,min_q-1,j)=qgz(min_q-1)<a name='742'>
         endif<a name='743'>
<font color=#447700>!<a name='744'></font>
      else<a name='745'>
         notlast=.false.<a name='746'>
      endif<a name='747'>
<font color=#447700>!<a name='748'></font>
    ENDDO<a name='749'>
 ENDIF <font color=#447700>!ice2<a name='750'></font>
<font color=#447700>!<a name='751'></font>
<font color=#447700>!-- cloud ice  (03/21/02) follow Vaughan T.J. Phillips at GFDL<a name='752'></font>
<font color=#447700>!<a name='753'></font>
<a name='754'>
    t_del_tv=0.<a name='755'>
    del_tv=dtb<a name='756'>
    notlast=.true.<a name='757'>
<font color=#447700>!<a name='758'></font>
    DO while (notlast)<a name='759'>
<font color=#447700>!<a name='760'></font>
      min_q=kte<a name='761'>
      max_q=kts-1<a name='762'>
<font color=#447700>!<a name='763'></font>
      do k=kts,kte-1<a name='764'>
         if (qiz(k) .gt. 1.0e-8) then<a name='765'>
            min_q=min0(min_q,k)<a name='766'>
            max_q=max0(max_q,k)<a name='767'>
            vti(k)= 3.29 * (rhoz(k)* qiz(k))** 0.16  <font color=#447700>! Heymsfield and Donner<a name='768'></font>
            if (k .eq. 1) then<a name='769'>
               del_tv=amin1(del_tv,0.9*(zz(k)-topo(i,j))/vti(k))<a name='770'>
            else<a name='771'>
               del_tv=amin1(del_tv,0.9*(zz(k)-zz(k-1))/vti(k))<a name='772'>
            endif<a name='773'>
         else<a name='774'>
            vti(k)=0.<a name='775'>
         endif<a name='776'>
      enddo<a name='777'>
<a name='778'>
      if (max_q .ge. min_q) then<a name='779'>
<font color=#447700>!<a name='780'></font>
<font color=#447700>!<a name='781'></font>
<font color=#447700>!- Check if the summation of the small delta t &gt;=  big delta t<a name='782'></font>
<font color=#447700>!             (t_del_tv)          (del_tv)             (dtb)<a name='783'></font>
<a name='784'>
         t_del_tv=t_del_tv+del_tv<a name='785'>
<a name='786'>
         if ( t_del_tv .ge. dtb ) then<a name='787'>
              notlast=.false.<a name='788'>
              del_tv=dtb+del_tv-t_del_tv<a name='789'>
         endif<a name='790'>
<a name='791'>
<font color=#447700>! use small delta t to calculate the qiz flux<a name='792'></font>
<font color=#447700>! termi is the qiz flux pass in the grid box through the upper boundary<a name='793'></font>
<font color=#447700>! termo is the qiz flux pass out the grid box through the lower boundary<a name='794'></font>
<font color=#447700>!<a name='795'></font>
<a name='796'>
         fluxin=0.<a name='797'>
         do k=max_q,min_q,-1<a name='798'>
            fluxout=rhoz(k)*vti(k)*qiz(k)<a name='799'>
            flux=(fluxin-fluxout)/rhoz(k)/dzw(k)<a name='800'>
            qiz(k)=qiz(k)+del_tv*flux<a name='801'>
            qiz(k)=amax1(0.,qiz(k))<a name='802'>
            qi(i,k,j)=qiz(k)<a name='803'>
            fluxin=fluxout<a name='804'>
         enddo<a name='805'>
         if (min_q .eq. 1) then<a name='806'>
            pptice=pptice+fluxin*del_tv<a name='807'>
         else<a name='808'>
            qiz(min_q-1)=qiz(min_q-1)+del_tv*  &amp;<a name='809'>
                         fluxin/rhoz(min_q-1)/dzw(min_q-1)<a name='810'>
            qi(i,min_q-1,j)=qiz(min_q-1)<a name='811'>
         endif<a name='812'>
<font color=#447700>!<a name='813'></font>
      else<a name='814'>
         notlast=.false.<a name='815'>
      endif<a name='816'>
<font color=#447700>!<a name='817'></font>
   ENDDO <font color=#447700>!notlast<a name='818'></font>
<a name='819'>
<font color=#447700>!   prnc(i,j)=prnc(i,j)+pptrain<a name='820'></font>
<font color=#447700>!   psnowc(i,j)=psnowc(i,j)+pptsnow<a name='821'></font>
<font color=#447700>!   pgrauc(i,j)=pgrauc(i,j)+pptgraul<a name='822'></font>
<font color=#447700>!   picec(i,j)=picec(i,j)+pptice<a name='823'></font>
<font color=#447700>!                     <a name='824'></font>
<a name='825'>
<font color=#447700>!   write(6,*) 'i=',i,' j=',j,'   ', pptrain, pptsnow, pptgraul, pptice<a name='826'></font>
<font color=#447700>!   flush(6)<a name='827'></font>
<a name='828'>
   snowncv(i,j) = pptsnow<a name='829'>
   snownc(i,j) = snownc(i,j) + pptsnow<a name='830'>
   graupelncv(i,j) = pptgraul<a name='831'>
   graupelnc(i,j) = graupelnc(i,j) + pptgraul <a name='832'>
   RAINNCV(i,j) = pptrain + pptsnow + pptgraul + pptice                 <a name='833'>
   RAINNC(i,j)  = RAINNC(i,j) + pptrain + pptsnow + pptgraul + pptice<a name='834'>
   sr(i,j) = 0.<a name='835'>
   if (RAINNCV(i,j) .gt. 0.) sr(i,j) = (pptsnow + pptgraul + pptice) / RAINNCV(i,j) <a name='836'>
<a name='837'>
  ENDDO i_loop<a name='838'>
  ENDDO j_loop<a name='839'>
<a name='840'>
<font color=#447700>!  if (itimestep.eq.6480) then<a name='841'></font>
<font color=#447700>!     write(51,*) 'in the end of fallflux, itimestep=',itimestep<a name='842'></font>
<font color=#447700>!     do j=jts,jte<a name='843'></font>
<font color=#447700>!        do i=its,ite <a name='844'></font>
<font color=#447700>!           if (rainnc(i,j).gt.400.) then<a name='845'></font>
<font color=#447700>!              write(50,*) 'i=',i,' j=',j,' rainnc=',rainnc<a name='846'></font>
<font color=#447700>!           endif<a name='847'></font>
<font color=#447700>!        enddo<a name='848'></font>
<font color=#447700>!     enddo<a name='849'></font>
<font color=#447700>!  endif<a name='850'></font>
<a name='851'>
  END SUBROUTINE fall_flux<a name='852'>
<a name='853'>
<font color=#447700>!----------------------------------------------------------------<a name='854'></font>
<A NAME='GGAMMA'><A href='../../html_code/phys/module_mp_gsfcgce.F.html#GGAMMA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='855'>
   REAL <font color=#993300>FUNCTION </font><font color=#cc0000>ggamma</font>(X) <A href='../../call_to/GGAMMA.html' TARGET='index'>20</A>,<A href='../../call_from/GGAMMA.html' TARGET='index'>2</A><a name='856'>
<font color=#447700>!----------------------------------------------------------------<a name='857'></font>
   IMPLICIT NONE<a name='858'>
<font color=#447700>!----------------------------------------------------------------<a name='859'></font>
      REAL, INTENT(IN   ) :: x<a name='860'>
      REAL, DIMENSION(8)  :: B<a name='861'>
      INTEGER             ::j, K1<a name='862'>
      REAL                ::PF, G1TO2 ,TEMP<a name='863'>
<a name='864'>
      DATA B/-.577191652,.988205891,-.897056937,.918206857,  &amp;<a name='865'>
             -.756704078,.482199394,-.193527818,.035868343/<a name='866'>
<a name='867'>
      PF=1.<a name='868'>
      TEMP=X<a name='869'>
      DO 10 J=1,200<a name='870'>
      IF (TEMP .LE. 2) GO TO 20<a name='871'>
      TEMP=TEMP-1.<a name='872'>
   10 PF=PF*TEMP<a name='873'>
  100 FORMAT(//,5X,'module_gsfcgce: INPUT TO GAMMA FUNCTION TOO LARGE, X=',E12.5)<a name='874'>
      WRITE(wrf_err_message,100)X<a name='875'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_sbu_ylin.F.html#GGAMMA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_870">(wrf_err_message)<a name='876'>
   20 G1TO2=1.<a name='877'>
      TEMP=TEMP - 1.<a name='878'>
      DO 30 K1=1,8<a name='879'>
   30 G1TO2=G1TO2 + B(K1)*TEMP**K1<a name='880'>
      ggamma=PF*G1TO2<a name='881'>
<a name='882'>
      END FUNCTION ggamma<a name='883'>
<a name='884'>
<font color=#447700>!-----------------------------------------------------------------------<a name='885'></font>
<font color=#447700>!c Correction of negative values  <a name='886'></font>
<A NAME='NEGCOR'><A href='../../html_code/phys/module_mp_gsfcgce.F.html#NEGCOR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='887'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>negcor</font> ( X, rho, dz8w,                         &amp; <A href='../../call_to/NEGCOR.html' TARGET='index'>6</A><a name='888'>
                      ims,ime, jms,jme, kms,kme,              &amp; <font color=#447700>! memory dims<a name='889'></font>
                      itimestep, ics,                         &amp;<a name='890'>
                      its,ite, jts,jte, kts,kte               ) <font color=#447700>! tile   dims<a name='891'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='892'></font>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),                 &amp;<a name='893'>
        INTENT(INOUT) ::                                     X   <a name='894'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),                 &amp;<a name='895'>
        INTENT(IN   ) ::                              rho, dz8w  <a name='896'>
  integer, INTENT(IN   ) ::                           itimestep, ics <a name='897'>
<a name='898'>
<font color=#447700>!c Local variables<a name='899'></font>
<font color=#447700>!  REAL, DIMENSION( kts:kte ) ::  Y1, Y2<a name='900'></font>
  REAL   ::   A0, A1, A2<a name='901'>
<a name='902'>
  A1=0.<a name='903'>
  A2=0.<a name='904'>
  do k=kts,kte<a name='905'>
     do j=jts,jte<a name='906'>
        do i=its,ite<a name='907'>
        A1=A1+max(X(i,k,j), 0.)*rho(i,k,j)*dz8w(i,k,j)<a name='908'>
        A2=A2+max(-X(i,k,j), 0.)*rho(i,k,j)*dz8w(i,k,j)<a name='909'>
        enddo<a name='910'>
     enddo<a name='911'>
  enddo<a name='912'>
<a name='913'>
<font color=#447700>!  A1=0.0<a name='914'></font>
<font color=#447700>!  A2=0.0<a name='915'></font>
<font color=#447700>!  do k=kts,kte<a name='916'></font>
<font color=#447700>!     A1=A1+Y1(k)<a name='917'></font>
<font color=#447700>!     A2=A2+Y2(k)<a name='918'></font>
<font color=#447700>!  enddo<a name='919'></font>
<a name='920'>
  A0=0.0<a name='921'>
<a name='922'>
  if (A1.NE.0.0.and.A1.GT.A2) then <a name='923'>
     A0=(A1-A2)/A1<a name='924'>
<a name='925'>
  if (mod(itimestep,540).eq.0) then<a name='926'>
     if (ics.eq.1) then<a name='927'>
        write(61,*) 'kms=',kms,'  kme=',kme,'  kts=',kts,'  kte=',kte<a name='928'>
        write(61,*) 'jms=',jms,'  jme=',jme,'  jts=',jts,'  jte=',jte <a name='929'>
        write(61,*) 'ims=',ims,'  ime=',ime,'  its=',its,'  ite=',ite <a name='930'>
     endif <a name='931'>
     if (ics.eq.1) then<a name='932'>
         write(61,*) 'qv timestep=',itimestep<a name='933'>
         write(61,*) '  A1=',A1,'   A2=',A2,'   A0=',A0<a name='934'>
     else if (ics.eq.2) then<a name='935'>
             write(61,*) 'ql timestep=',itimestep<a name='936'>
             write(61,*) '  A1=',A1,'   A2=',A2,'   A0=',A0<a name='937'>
     else if (ics.eq.3) then<a name='938'>
             write(61,*) 'qr timestep=',itimestep<a name='939'>
             write(61,*) '  A1=',A1,'   A2=',A2,'   A0=',A0<a name='940'>
     else if (ics.eq.4) then<a name='941'>
             write(61,*) 'qi timestep=',itimestep<a name='942'>
             write(61,*) '  A1=',A1,'   A2=',A2,'   A0=',A0<a name='943'>
     else if (ics.eq.5) then<a name='944'>
             write(61,*) 'qs timestep=',itimestep<a name='945'>
             write(61,*) '  A1=',A1,'   A2=',A2,'   A0=',A0<a name='946'>
     else if (ics.eq.6) then<a name='947'>
             write(61,*) 'qg timestep=',itimestep<a name='948'>
             write(61,*) '  A1=',A1,'   A2=',A2,'   A0=',A0<a name='949'>
     else<a name='950'>
             write(61,*) 'wrong cloud specieis number'<a name='951'>
     endif <a name='952'>
  endif <a name='953'>
<a name='954'>
     do k=kts,kte<a name='955'>
        do j=jts,jte<a name='956'>
           do i=its,ite<a name='957'>
           X(i,k,j)=A0*AMAX1(X(i,k,j), 0.0)<a name='958'>
           enddo<a name='959'>
        enddo<a name='960'>
     enddo<a name='961'>
  endif<a name='962'>
<a name='963'>
  END SUBROUTINE negcor<a name='964'>
<a name='965'>
<A NAME='CONSAT_S'><A href='../../html_code/phys/module_mp_gsfcgce.F.html#CONSAT_S' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='966'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>consat_s</font> (ihail,itaobraun) <A href='../../call_to/CONSAT_S.html' TARGET='index'>1</A>,<A href='../../call_from/CONSAT_S.html' TARGET='index'>10</A><a name='967'>
<a name='968'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='969'></font>
<font color=#447700>!                                                                      c<a name='970'></font>
<font color=#447700>!   Tao, W.-K., and J. Simpson, 1989: Modeling study of a tropical     c<a name='971'></font>
<font color=#447700>!   squall-type convective line. J. Atmos. Sci., 46, 177-202.          c<a name='972'></font>
<font color=#447700>!                                                                      c<a name='973'></font>
<font color=#447700>!   Tao, W.-K., J. Simpson and M. McCumber, 1989: An ice-water         c<a name='974'></font>
<font color=#447700>!   saturation adjustment. Mon. Wea. Rev., 117, 231-235.               c<a name='975'></font>
<font color=#447700>!                                                                      c<a name='976'></font>
<font color=#447700>!   Tao, W.-K., and J. Simpson, 1993: The Goddard Cumulus Ensemble     c<a name='977'></font>
<font color=#447700>!   Model. Part I: Model description. Terrestrial, Atmospheric and     c<a name='978'></font>
<font color=#447700>!   Oceanic Sciences, 4, 35-72.                                        c<a name='979'></font>
<font color=#447700>!                                                                      c<a name='980'></font>
<font color=#447700>!   Tao, W.-K., J. Simpson, D. Baker, S. Braun, M.-D. Chou, B.         c<a name='981'></font>
<font color=#447700>!   Ferrier,D. Johnson, A. Khain, S. Lang,  B. Lynn, C.-L. Shie,       c<a name='982'></font>
<font color=#447700>!   D. Starr, C.-H. Sui, Y. Wang and P. Wetzel, 2003: Microphysics,    c<a name='983'></font>
<font color=#447700>!   radiation and surface processes in the Goddard Cumulus Ensemble    c<a name='984'></font>
<font color=#447700>!   (GCE) model, A Special Issue on Non-hydrostatic Mesoscale          c<a name='985'></font>
<font color=#447700>!   Modeling, Meteorology and Atmospheric Physics, 82, 97-137.         c<a name='986'></font>
<font color=#447700>!                                                                      c<a name='987'></font>
<font color=#447700>!   Lang, S., W.-K. Tao, R. Cifelli, W. Olson, J. Halverson, S.        c<a name='988'></font>
<font color=#447700>!   Rutledge, and J. Simpson, 2007: Improving simulations of           c<a name='989'></font>
<font color=#447700>!   convective system from TRMM LBA: Easterly and Westerly regimes.    c<a name='990'></font>
<font color=#447700>!   J. Atmos. Sci., 64, 1141-1164.                                     c<a name='991'></font>
<font color=#447700>!                                                                      c<a name='992'></font>
<font color=#447700>!   Coded by Tao (1989-2003), modified by S. Lang (2006/07)            c<a name='993'></font>
<font color=#447700>!                                                                      c<a name='994'></font>
<font color=#447700>!   Implemented into WRF  by Roger Shi 2006/2007                       c<a name='995'></font>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='996'></font>
<a name='997'>
<font color=#447700>!        itaobraun=0   ! see Tao and Simpson (1993)<a name='998'></font>
<font color=#447700>!        itaobraun=1   ! see Tao et al. (2003)<a name='999'></font>
<a name='1000'>
 integer :: itaobraun<a name='1001'>
 real    :: cn0<a name='1002'>
<a name='1003'>
<font color=#447700>!JJS 1/3/2008  vvvvv<a name='1004'></font>
<font color=#447700>!JJS   the following common blocks have been moved to the top of<a name='1005'></font>
<font color=#447700>!JJS   module_mp_gsfcgce_driver_instat.F<a name='1006'></font>
<font color=#447700>!<a name='1007'></font>
<font color=#447700>! real,   dimension (1:31) ::  a1, a2<a name='1008'></font>
<font color=#447700>! data a1/.7939e-7,.7841e-6,.3369e-5,.4336e-5,.5285e-5,.3728e-5, &amp;<a name='1009'></font>
<font color=#447700>!         .1852e-5,.2991e-6,.4248e-6,.7434e-6,.1812e-5,.4394e-5,.9145e-5, &amp;<a name='1010'></font>
<font color=#447700>!         .1725e-4,.3348e-4,.1725e-4,.9175e-5,.4412e-5,.2252e-5,.9115e-6, &amp;<a name='1011'></font>
<font color=#447700>!         .4876e-6,.3473e-6,.4758e-6,.6306e-6,.8573e-6,.7868e-6,.7192e-6, &amp;<a name='1012'></font>
<font color=#447700>!         .6513e-6,.5956e-6,.5333e-6,.4834e-6/<a name='1013'></font>
<font color=#447700>! data a2/.4006,.4831,.5320,.5307,.5319,.5249,.4888,.3894,.4047, &amp;<a name='1014'></font>
<font color=#447700>!         .4318,.4771,.5183,.5463,.5651,.5813,.5655,.5478,.5203,.4906, &amp;<a name='1015'></font>
<font color=#447700>!         .4447,.4126,.3960,.4149,.4320,.4506,.4483,.4460,.4433,.4413, &amp;<a name='1016'></font>
<font color=#447700>!         .4382,.4361/<a name='1017'></font>
<font color=#447700>!JJS 1/3/2008  ^^^^^<a name='1018'></font>
<a name='1019'>
<a name='1020'>
<font color=#447700>!     ******************************************************************<a name='1021'></font>
<font color=#447700>!JJS<a name='1022'></font>
      al = 2.5e10<a name='1023'>
      cp = 1.004e7<a name='1024'>
      rd1 = 1.e-3<a name='1025'>
      rd2 = 2.2<a name='1026'>
<font color=#447700>!JJS<a name='1027'></font>
      cpi=4.*atan(1.)<a name='1028'>
      cpi2=cpi*cpi<a name='1029'>
      grvt=980.<a name='1030'>
      cd1=6.e-1<a name='1031'>
      cd2=4.*grvt/(3.*cd1)<a name='1032'>
      tca=2.43e3<a name='1033'>
      dwv=.226<a name='1034'>
      dva=1.718e-4<a name='1035'>
      amw=18.016<a name='1036'>
      ars=8.314e7<a name='1037'>
      scv=2.2904487<a name='1038'>
      t0=273.16<a name='1039'>
      t00=238.16<a name='1040'>
      alv=2.5e10<a name='1041'>
      alf=3.336e9<a name='1042'>
      als=2.8336e10<a name='1043'>
      avc=alv/cp<a name='1044'>
      afc=alf/cp<a name='1045'>
      asc=als/cp<a name='1046'>
      rw=4.615e6<a name='1047'>
      cw=4.187e7<a name='1048'>
      ci=2.093e7<a name='1049'>
      c76=7.66<a name='1050'>
      c358=35.86<a name='1051'>
      c172=17.26939<a name='1052'>
      c409=4098.026<a name='1053'>
      c218=21.87456<a name='1054'>
      c580=5807.695<a name='1055'>
      c610=6.1078e3<a name='1056'>
      c149=1.496286e-5<a name='1057'>
      c879=8.794142<a name='1058'>
      c141=1.4144354e7<a name='1059'>
<font color=#447700>!***   DEFINE THE COEFFICIENTS USED IN TERMINAL VELOCITY<a name='1060'></font>
<font color=#447700>!***   DEFINE THE DENSITY AND SIZE DISTRIBUTION OF PRECIPITATION<a name='1061'></font>
<font color=#447700>!**********   HAIL OR GRAUPEL PARAMETERS   **********<a name='1062'></font>
      if(ihail .eq. 1) then<a name='1063'>
         roqg=.9<a name='1064'>
         ag=sqrt(cd2*roqg)<a name='1065'>
         bg=.5<a name='1066'>
         tng=.002<a name='1067'>
      else<a name='1068'>
         roqg=.4<a name='1069'>
         ag=351.2<a name='1070'>
<font color=#447700>!        AG=372.3 ! if ice913=1 6/15/02 tao's<a name='1071'></font>
         bg=.37<a name='1072'>
         tng=.04<a name='1073'>
      endif<a name='1074'>
<font color=#447700>!**********         SNOW PARAMETERS        **********<a name='1075'></font>
<font color=#447700>!ccshie 6/15/02 tao's<a name='1076'></font>
<font color=#447700>!      TNS=1.<a name='1077'></font>
<font color=#447700>!      TNS=.08 ! if ice913=1, tao's<a name='1078'></font>
      tns=.16 <font color=#447700>! if ice913=0, tao's<a name='1079'></font>
      roqs=.1<a name='1080'>
<font color=#447700>!      AS=152.93<a name='1081'></font>
      as=78.63<a name='1082'>
<font color=#447700>!      BS=.25<a name='1083'></font>
      bs=.11<a name='1084'>
<font color=#447700>!**********         RAIN PARAMETERS        **********<a name='1085'></font>
      aw=2115.<a name='1086'>
      bw=.8<a name='1087'>
      roqr=1.<a name='1088'>
      tnw=.08<a name='1089'>
<font color=#447700>!*****************************************************************<a name='1090'></font>
      bgh=.5*bg<a name='1091'>
      bsh=.5*bs<a name='1092'>
      bwh=.5*bw<a name='1093'>
      bgq=.25*bg<a name='1094'>
      bsq=.25*bs<a name='1095'>
      bwq=.25*bw<a name='1096'>
<font color=#447700>!**********GAMMA FUNCTION CALCULATIONS*************<a name='1097'></font>
      ga3b  = <A href='../../html_code/phys/module_mp_gsfcgce.F.html#GAMMAGCE'>gammagce</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#CONSAT_S' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMAGCE_1">(3.+bw)<a name='1098'>
      ga4b  = <A href='../../html_code/phys/module_mp_gsfcgce.F.html#GAMMAGCE'>gammagce</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#CONSAT_S' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMAGCE_2">(4.+bw)<a name='1099'>
      ga6b  = <A href='../../html_code/phys/module_mp_gsfcgce.F.html#GAMMAGCE'>gammagce</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#CONSAT_S' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMAGCE_3">(6.+bw)<a name='1100'>
      ga5bh = <A href='../../html_code/phys/module_mp_gsfcgce.F.html#GAMMAGCE'>gammagce</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#CONSAT_S' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMAGCE_4">((5.+bw)/2.)<a name='1101'>
      ga3g  = <A href='../../html_code/phys/module_mp_gsfcgce.F.html#GAMMAGCE'>gammagce</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#CONSAT_S' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMAGCE_5">(3.+bg)<a name='1102'>
      ga4g  = <A href='../../html_code/phys/module_mp_gsfcgce.F.html#GAMMAGCE'>gammagce</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#CONSAT_S' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMAGCE_6">(4.+bg)<a name='1103'>
      ga5gh = <A href='../../html_code/phys/module_mp_gsfcgce.F.html#GAMMAGCE'>gammagce</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#CONSAT_S' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMAGCE_7">((5.+bg)/2.)<a name='1104'>
      ga3d  = <A href='../../html_code/phys/module_mp_gsfcgce.F.html#GAMMAGCE'>gammagce</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#CONSAT_S' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMAGCE_8">(3.+bs)<a name='1105'>
      ga4d  = <A href='../../html_code/phys/module_mp_gsfcgce.F.html#GAMMAGCE'>gammagce</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#CONSAT_S' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMAGCE_9">(4.+bs)<a name='1106'>
      ga5dh = <A href='../../html_code/phys/module_mp_gsfcgce.F.html#GAMMAGCE'>gammagce</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#CONSAT_S' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMAGCE_10">((5.+bs)/2.)<a name='1107'>
<font color=#447700>!CCCCC        LIN ET AL., 1983 OR LORD ET AL., 1984   CCCCCCCCCCCCCCCCC<a name='1108'></font>
      ac1=aw<a name='1109'>
<font color=#447700>!JJS<a name='1110'></font>
      ac2=ag<a name='1111'>
      ac3=as<a name='1112'>
<font color=#447700>!JJS<a name='1113'></font>
      bc1=bw<a name='1114'>
      cc1=as<a name='1115'>
      dc1=bs<a name='1116'>
      zrc=(cpi*roqr*tnw)**0.25<a name='1117'>
      zsc=(cpi*roqs*tns)**0.25<a name='1118'>
      zgc=(cpi*roqg*tng)**0.25<a name='1119'>
      vrc=aw*ga4b/(6.*zrc**bw)<a name='1120'>
      vsc=as*ga4d/(6.*zsc**bs)<a name='1121'>
      vgc=ag*ga4g/(6.*zgc**bg)<a name='1122'>
<font color=#447700>!     ****************************<a name='1123'></font>
<font color=#447700>!     RN1=1.E-3<a name='1124'></font>
      rn1=9.4e-15 <font color=#447700>! 6/15/02 tao's<a name='1125'></font>
      bnd1=6.e-4<a name='1126'>
      rn2=1.e-3<a name='1127'>
<font color=#447700>!     BND2=1.25E-3<a name='1128'></font>
<font color=#447700>!     BND2=1.5E-3 ! if ice913=1 6/15/02 tao's<a name='1129'></font>
      bnd2=2.0e-3 <font color=#447700>! if ice913=0 6/15/02 tao's<a name='1130'></font>
      rn3=.25*cpi*tns*cc1*ga3d<a name='1131'>
      esw=1.<a name='1132'>
      rn4=.25*cpi*esw*tns*cc1*ga3d<a name='1133'>
<font color=#447700>!     ERI=1.<a name='1134'></font>
      eri=.1  <font color=#447700>! 6/17/02 tao's ice913=0 (not 1)<a name='1135'></font>
      rn5=.25*cpi*eri*tnw*ac1*ga3b<a name='1136'>
<font color=#447700>!     AMI=1./(24.*4.19E-10)<a name='1137'></font>
      ami=1./(24.*6.e-9) <font color=#447700>! 6/15/02 tao's<a name='1138'></font>
      rn6=cpi2*eri*tnw*ac1*roqr*ga6b*ami<a name='1139'>
<font color=#447700>!     ESR=1. ! also if ice913=1 for tao's<a name='1140'></font>
      esr=.5 <font color=#447700>! 6/15/02 for ice913=0 tao's<a name='1141'></font>
      rn7=cpi2*esr*tnw*tns*roqs<a name='1142'>
      esr=1.<a name='1143'>
      rn8=cpi2*esr*tnw*tns*roqr<a name='1144'>
      rn9=cpi2*tns*tng*roqs<a name='1145'>
      rn10=2.*cpi*tns<a name='1146'>
      rn101=.31*ga5dh*sqrt(cc1)<a name='1147'>
      rn10a=als*als/rw<a name='1148'>
<font color=#447700>!JJS<a name='1149'></font>
       rn10b=alv/tca<a name='1150'>
       rn10c=ars/(dwv*amw)<a name='1151'>
<font color=#447700>!JJS<a name='1152'></font>
      rn11=2.*cpi*tns/alf<a name='1153'>
      rn11a=cw/alf<a name='1154'>
<font color=#447700>!     AMI50=1.51e-7<a name='1155'></font>
      ami50=3.84e-6 <font color=#447700>! 6/15/02 tao's<a name='1156'></font>
<font color=#447700>!     AMI40=2.41e-8<a name='1157'></font>
      ami40=3.08e-8 <font color=#447700>! 6/15/02 tao's<a name='1158'></font>
      eiw=1.<a name='1159'>
<font color=#447700>!     UI50=20.<a name='1160'></font>
      ui50=100. <font color=#447700>! 6/15/02 tao's<a name='1161'></font>
      ri50=2.*5.e-3<a name='1162'>
      cmn=1.05e-15<a name='1163'>
      rn12=cpi*eiw*ui50*ri50**2<a name='1164'>
<a name='1165'>
      do 10 k=1,31<a name='1166'>
         y1=1.-aa2(k)<a name='1167'>
         rn13(k)=aa1(k)*y1/(ami50**y1-ami40**y1)<a name='1168'>
         rn12a(k)=rn13(k)/ami50<a name='1169'>
         rn12b(k)=aa1(k)*ami50**aa2(k)<a name='1170'>
         rn25a(k)=aa1(k)*cmn**aa2(k)<a name='1171'>
   10 continue<a name='1172'>
<a name='1173'>
      egw=1.<a name='1174'>
      rn14=.25*cpi*egw*tng*ga3g*ag<a name='1175'>
      egi=.1<a name='1176'>
      rn15=.25*cpi*egi*tng*ga3g*ag<a name='1177'>
      egi=1.<a name='1178'>
      rn15a=.25*cpi*egi*tng*ga3g*ag<a name='1179'>
      egr=1.<a name='1180'>
      rn16=cpi2*egr*tng*tnw*roqr<a name='1181'>
      rn17=2.*cpi*tng<a name='1182'>
      rn17a=.31*ga5gh*sqrt(ag)<a name='1183'>
      rn17b=cw-ci<a name='1184'>
      rn17c=cw<a name='1185'>
      apri=.66<a name='1186'>
      bpri=1.e-4<a name='1187'>
      bpri=0.5*bpri <font color=#447700>! 6/17/02 tao's<a name='1188'></font>
      rn18=20.*cpi2*bpri*tnw*roqr<a name='1189'>
      rn18a=apri<a name='1190'>
      rn19=2.*cpi*tng/alf<a name='1191'>
      rn19a=.31*ga5gh*sqrt(ag)<a name='1192'>
      rn19b=cw/alf<a name='1193'>
<font color=#447700>!<a name='1194'></font>
       rnn191=.78<a name='1195'>
       rnn192=.31*ga5gh*sqrt(ac2/dva)<a name='1196'>
<font color=#447700>!<a name='1197'></font>
      rn20=2.*cpi*tng<a name='1198'>
      rn20a=als*als/rw<a name='1199'>
      rn20b=.31*ga5gh*sqrt(ag)<a name='1200'>
      bnd3=2.e-3<a name='1201'>
      rn21=1.e3*1.569e-12/0.15<a name='1202'>
      erw=1.<a name='1203'>
      rn22=.25*cpi*erw*ac1*tnw*ga3b<a name='1204'>
      rn23=2.*cpi*tnw<a name='1205'>
      rn23a=.31*ga5bh*sqrt(ac1)<a name='1206'>
      rn23b=alv*alv/rw<a name='1207'>
<a name='1208'>
<a name='1209'>
<font color=#447700>!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='1210'></font>
<font color=#447700>!cc<a name='1211'></font>
<font color=#447700>!cc        "c0" in routine      "consat" (2d), "consatrh" (3d)<a name='1212'></font>
<font color=#447700>!cc        if ( itaobraun.eq.1 ) --&gt; betah=0.5*beta=-.46*0.5=-0.23;   cn0=1.e-6<a name='1213'></font>
<font color=#447700>!cc        if ( itaobraun.eq.0 ) --&gt; betah=0.5*beta=-.6*0.5=-0.30;    cn0=1.e-8<a name='1214'></font>
<a name='1215'>
       if (itaobraun .eq. 0) then<a name='1216'>
         cn0=1.e-8<a name='1217'>
         beta=-.6<a name='1218'>
       elseif (itaobraun .eq. 1) then<a name='1219'>
         cn0=1.e-6<a name='1220'>
         beta=-.46<a name='1221'>
       endif<a name='1222'>
<font color=#447700>!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='1223'></font>
<font color=#447700>!      CN0=1.E-6<a name='1224'></font>
<font color=#447700>!      CN0=1.E-8 ! 6/15/02 tao's<a name='1225'></font>
<font color=#447700>!      BETA=-.46<a name='1226'></font>
<font color=#447700>!      BETA=-.6  ! 6/15/02 tao's<a name='1227'></font>
<a name='1228'>
      rn25=cn0<a name='1229'>
      rn30a=alv*als*amw/(tca*ars)<a name='1230'>
      rn30b=alv/tca<a name='1231'>
      rn30c=ars/(dwv*amw)<a name='1232'>
      rn31=1.e-17<a name='1233'>
<a name='1234'>
      rn32=4.*51.545e-4<a name='1235'>
<font color=#447700>!<a name='1236'></font>
      rn30=2.*cpi*tng<a name='1237'>
      rnn30a=alv*alv*amw/(tca*ars)<a name='1238'>
<font color=#447700>!<a name='1239'></font>
      rn33=4.*tns<a name='1240'>
       rn331=.65<a name='1241'>
       rn332=.44*sqrt(ac3/dva)*ga5dh<a name='1242'>
<font color=#447700>!<a name='1243'></font>
<a name='1244'>
    return<a name='1245'>
 END SUBROUTINE consat_s<a name='1246'>
<a name='1247'>
<A NAME='SATICEL_S'><A href='../../html_code/phys/module_mp_gsfcgce.F.html#SATICEL_S' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1248'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>saticel_s</font> (dt, ihail, itaobraun, ice2, istatmin, &amp; <A href='../../call_to/SATICEL_S.html' TARGET='index'>1</A>,<A href='../../call_from/SATICEL_S.html' TARGET='index'>1</A><a name='1249'>
                       new_ice_sat, id, &amp;<a name='1250'>
                       ptwrf, qvwrf, qlwrf, qrwrf, &amp;<a name='1251'>
                       qiwrf, qswrf, qgwrf, &amp;<a name='1252'>
                       rho_mks, pi_mks, p0_mks,itimestep, &amp;<a name='1253'>
                       refl_10cm, diagflag, do_radar_ref,           &amp; <font color=#447700>! GT added for reflectivity calcs<a name='1254'></font>
<font color=#447700>!                      refl_10cm, grid_clock, grid_alarms,          &amp; ! GT added for reflectivity calcs<a name='1255'></font>
                       ids,ide, jds,jde, kds,kde, &amp;<a name='1256'>
                       ims,ime, jms,jme, kms,kme, &amp;<a name='1257'>
                       its,ite, jts,jte, kts,kte  &amp;<a name='1258'>
                           )<a name='1259'>
    IMPLICIT NONE<a name='1260'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='1261'></font>
<font color=#447700>!                                                                      c<a name='1262'></font>
<font color=#447700>!   Tao, W.-K., and J. Simpson, 1989: Modeling study of a tropical     c<a name='1263'></font>
<font color=#447700>!   squall-type convective line. J. Atmos. Sci., 46, 177-202.          c<a name='1264'></font>
<font color=#447700>!                                                                      c<a name='1265'></font>
<font color=#447700>!   Tao, W.-K., J. Simpson and M. McCumber, 1989: An ice-water         c<a name='1266'></font>
<font color=#447700>!   saturation adjustment. Mon. Wea. Rev., 117, 231-235.               c<a name='1267'></font>
<font color=#447700>!                                                                      c<a name='1268'></font>
<font color=#447700>!   Tao, W.-K., and J. Simpson, 1993: The Goddard Cumulus Ensemble     c<a name='1269'></font>
<font color=#447700>!   Model. Part I: Model description. Terrestrial, Atmospheric and     c<a name='1270'></font>
<font color=#447700>!   Oceanic Sciences, 4, 35-72.                                        c<a name='1271'></font>
<font color=#447700>!                                                                      c<a name='1272'></font>
<font color=#447700>!   Tao, W.-K., J. Simpson, D. Baker, S. Braun, M.-D. Chou, B.         c<a name='1273'></font>
<font color=#447700>!   Ferrier,D. Johnson, A. Khain, S. Lang,  B. Lynn, C.-L. Shie,       c<a name='1274'></font>
<font color=#447700>!   D. Starr, C.-H. Sui, Y. Wang and P. Wetzel, 2003: Microphysics,    c<a name='1275'></font>
<font color=#447700>!   radiation and surface processes in the Goddard Cumulus Ensemble    c<a name='1276'></font>
<font color=#447700>!   (GCE) model, A Special Issue on Non-hydrostatic Mesoscale          c<a name='1277'></font>
<font color=#447700>!   Modeling, Meteorology and Atmospheric Physics, 82, 97-137.         c<a name='1278'></font>
<font color=#447700>!                                                                      c<a name='1279'></font>
<font color=#447700>!   Lang, S., W.-K. Tao, R. Cifelli, W. Olson, J. Halverson, S.        c<a name='1280'></font>
<font color=#447700>!   Rutledge, and J. Simpson, 2007: Improving simulations of           c<a name='1281'></font>
<font color=#447700>!   convective system from TRMM LBA: Easterly and Westerly regimes.    c<a name='1282'></font>
<font color=#447700>!   J. Atmos. Sci., 64, 1141-1164.                                     c<a name='1283'></font>
<font color=#447700>!                                                                      c<a name='1284'></font>
<font color=#447700>!   Tao, W.-K., J. J. Shi,  S. Lang, C. Peters-Lidard, A. Hou, S.      c<a name='1285'></font>
<font color=#447700>!   Braun, and J. Simpson, 2007: New, improved bulk-microphysical      c<a name='1286'></font>
<font color=#447700>!   schemes for studying precipitation processes in WRF. Part I:       c<a name='1287'></font>
<font color=#447700>!   Comparisons with other schemes. to appear on Mon. Wea. Rev.        C<a name='1288'></font>
<font color=#447700>!                                                                      c<a name='1289'></font>
<font color=#447700>!   Coded by Tao (1989-2003), modified by S. Lang (2006/07)            c<a name='1290'></font>
<font color=#447700>!                                                                      c<a name='1291'></font>
<font color=#447700>!   Implemented into WRF  by Roger Shi 2006/2007                       c<a name='1292'></font>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='1293'></font>
<font color=#447700>!<a name='1294'></font>
<font color=#447700>!      COMPUTE ICE PHASE MICROPHYSICS AND SATURATION PROCESSES<a name='1295'></font>
<font color=#447700>!<a name='1296'></font>
  integer,    parameter ::  nt=2880, nt2=2*nt <a name='1297'>
<a name='1298'>
<font color=#447700>!cc   using scott braun's way for pint, pidep computations<a name='1299'></font>
  integer  ::   itaobraun,ice2,ihail,new_ice_sat,id,istatmin<a name='1300'>
  integer  ::   itimestep<a name='1301'>
  real     ::   tairccri, cn0, dt<a name='1302'>
<font color=#447700>!cc<a name='1303'></font>
<a name='1304'>
<font color=#447700>!JJS      common/bxyz/ n,isec,nran,kt1,kt2<a name='1305'></font>
<font color=#447700>!JJS      common/option/ lipps,ijkadv,istatmin,iwater,itoga,imlifting,lin,<a name='1306'></font>
<font color=#447700>!JJS     1   irf,iadvh,irfg,ismg,id<a name='1307'></font>
<a name='1308'>
<font color=#447700>!JJS      common/timestat/ ndt_stat,idq<a name='1309'></font>
<font color=#447700>!JJS      common/iice/ new_ice_sat<a name='1310'></font>
<font color=#447700>!JJS      common/bt/ dt,d2t,rijl2,dts,f5,rd1,rd2,bound,al,cp,ra,ck,ce,eps,<a name='1311'></font>
<font color=#447700>!JJS     1    psfc,fcor,sec,aminut,rdt<a name='1312'></font>
<a name='1313'>
<font color=#447700>!JJS   the following common blocks have been moved to the top of <a name='1314'></font>
<font color=#447700>!JJS   module_mp_gsfcgce_driver_instat.F<a name='1315'></font>
<a name='1316'>
<font color=#447700>!      common/bt/ rd1,rd2,al,cp<a name='1317'></font>
<font color=#447700>!<a name='1318'></font>
<font color=#447700>!<a name='1319'></font>
<font color=#447700>!      common/bterv/ zrc,zgc,zsc,vrc,vgc,vsc<a name='1320'></font>
<font color=#447700>!      common/size/ tnw,tns,tng,roqs,roqg,roqr<a name='1321'></font>
<font color=#447700>!      common/cont/ c38,c358,c610,c149,c879,c172,c409,c76,c218,c580,c141<a name='1322'></font>
<font color=#447700>!        common/b3cs/ ag,bg,as,bs,aw,bw,bgh,bgq,bsh,bsq,bwh,bwq<a name='1323'></font>
<font color=#447700>!      common/bsnw/ alv,alf,als,t0,t00,avc,afc,asc,rn1,bnd1,rn2,bnd2, &amp;<a name='1324'></font>
<font color=#447700>!         rn3,rn4,rn5,rn6,rn7,rn8,rn9,rn10,rn101,rn10a,rn11,rn11a, &amp;<a name='1325'></font>
<font color=#447700>!         rn12,rn12a(31),rn12b(31),rn13(31),rn14,rn15,rn15a,rn16,rn17, &amp;<a name='1326'></font>
<font color=#447700>!         rn17a,rn17b,rn17c,rn18,rn18a,rn19,rn19a,rn19b,rn20,rn20a,rn20b, &amp;<a name='1327'></font>
<font color=#447700>!         bnd3,rn21,rn22,rn23,rn23a,rn23b,rn25,rn25a(31),rn30a,rn30b, &amp;<a name='1328'></font>
<font color=#447700>!         rn30c,rn31,beta,rn32<a name='1329'></font>
<font color=#447700>!      common/rsnw1/ rn10b,rn10c,rnn191,rnn192,rn30,rnn30a,rn33,rn331, &amp;<a name='1330'></font>
<font color=#447700>!                    rn332<a name='1331'></font>
<font color=#447700>!JJS<a name='1332'></font>
<a name='1333'>
  integer ids,ide,jds,jde,kds,kde<a name='1334'>
  integer ims,ime,jms,jme,kms,kme<a name='1335'>
  integer its,ite,jts,jte,kts,kte<a name='1336'>
  integer i,j,k, kp<a name='1337'>
<a name='1338'>
  real :: a0 ,a1 ,a2 ,afcp ,alvr ,ami100 ,ami40 ,ami50 ,ascp ,avcp ,betah &amp;<a name='1339'>
   ,bg3 ,bgh5 ,bs3 ,bs6 ,bsh5 ,bw3 ,bw6 ,bwh5 ,cmin ,cmin1 ,cmin2 ,cp409 &amp;<a name='1340'>
   ,cp580 ,cs580 ,cv409 ,d2t ,del ,dwvp ,ee1 ,ee2 ,f00 ,f2 ,f3 ,ft ,fv0 ,fvs &amp;<a name='1341'>
   ,pi0 ,pir ,pr0 ,qb0 ,r00 ,r0s ,r101f ,r10ar ,r10t ,r11at ,r11rt ,r12r ,r14f &amp;<a name='1342'>
   ,r14r ,r15af ,r15ar ,r15f ,r15r ,r16r ,r17aq ,r17as ,r17r ,r18r ,r19aq ,r19as &amp;<a name='1343'>
   ,r19bt ,r19rt ,r20bq ,r20bs ,r20t ,r22f ,r23af ,r23br ,r23t ,r25a ,r25rt ,r2ice &amp;<a name='1344'>
   ,r31r ,r32rt ,r3f ,r4f ,r5f ,r6f ,r7r ,r8r ,r9r ,r_nci ,rft ,rijl2 ,rp0 ,rr0 &amp;<a name='1345'>
   ,rrq ,rrs ,rt0 ,scc ,sccc ,sddd ,see ,seee ,sfff ,smmm ,ssss ,tb0 ,temp ,ucog &amp;<a name='1346'>
   ,ucor ,ucos ,uwet ,vgcf ,vgcr ,vrcf ,vscf ,zgr ,zrr ,zsr<a name='1347'>
<a name='1348'>
<a name='1349'>
  real, dimension (its:ite,jts:jte,kts:kte) ::  fv<a name='1350'>
  real, dimension (its:ite,jts:jte,kts:kte) ::  dpt, dqv<a name='1351'>
  real, dimension (its:ite,jts:jte,kts:kte) ::  qcl, qrn,      &amp;<a name='1352'>
                                                qci, qcs, qcg<a name='1353'>
<font color=#447700>!JJS 10/16/06    vvvv<a name='1354'></font>
<font color=#447700>!      real dpt1(ims:ime,jms:jme,kms:kme)<a name='1355'></font>
<font color=#447700>!      real dqv1(ims:ime,jms:jme,kms:kme),<a name='1356'></font>
<font color=#447700>!     1             qcl1(ims:ime,jms:jme,kms:kme)<a name='1357'></font>
<font color=#447700>!      real qrn1(ims:ime,jms:jme,kms:kme),<a name='1358'></font>
<font color=#447700>!     1             qci1(ims:ime,jms:jme,kms:kme)<a name='1359'></font>
<font color=#447700>!      real qcs1(ims:ime,jms:jme,kms:kme),<a name='1360'></font>
<font color=#447700>!     1             qcg1(ims:ime,jms:jme,kms:kme)<a name='1361'></font>
<font color=#447700>!JJS 10/16/06    ^^^^<a name='1362'></font>
<a name='1363'>
<font color=#447700>!JJS<a name='1364'></font>
<a name='1365'>
  real, dimension (ims:ime, kms:kme, jms:jme) ::  ptwrf, qvwrf <a name='1366'>
  real, dimension (ims:ime, kms:kme, jms:jme) ::  qlwrf, qrwrf,        &amp;<a name='1367'>
                                                  qiwrf, qswrf, qgwrf<a name='1368'>
<font color=#447700>!JJS 10/16/06    vvvv<a name='1369'></font>
<font color=#447700>!      real ptwrfold(ims:ime, kms:kme, jms:jme)<a name='1370'></font>
<font color=#447700>!      real qvwrfold(ims:ime, kms:kme, jms:jme),<a name='1371'></font>
<font color=#447700>!     1             qlwrfold(ims:ime, kms:kme, jms:jme)<a name='1372'></font>
<font color=#447700>!      real qrwrfold(ims:ime, kms:kme, jms:jme),<a name='1373'></font>
<font color=#447700>!     1             qiwrfold(ims:ime, kms:kme, jms:jme)<a name='1374'></font>
<font color=#447700>!      real qswrfold(ims:ime, kms:kme, jms:jme),<a name='1375'></font>
<font color=#447700>!     1             qgwrfold(ims:ime, kms:kme, jms:jme)<a name='1376'></font>
<font color=#447700>!JJS 10/16/06    ^^^^<a name='1377'></font>
<a name='1378'>
<font color=#447700>!JJS in MKS<a name='1379'></font>
  real, dimension (ims:ime, kms:kme, jms:jme) ::  rho_mks<a name='1380'>
  real, dimension (ims:ime, kms:kme, jms:jme) ::  pi_mks<a name='1381'>
  real, dimension (ims:ime, kms:kme, jms:jme) ::  p0_mks<a name='1382'>
<font color=#447700>!JJS<a name='1383'></font>
<font color=#447700>!  real, dimension (its:ite,jts:jte,kts:kte) ::  ww1<a name='1384'></font>
<font color=#447700>!  real, dimension (its:ite,jts:jte,kts:kte) ::  rsw<a name='1385'></font>
<font color=#447700>!  real, dimension (its:ite,jts:jte,kts:kte) ::  rlw<a name='1386'></font>
<a name='1387'>
<font color=#447700>!JJS      COMMON /BADV/<a name='1388'></font>
  real, dimension (its:ite,jts:jte) ::        &amp;<a name='1389'>
           vg,      zg,       &amp;<a name='1390'>
           ps,      pg,       &amp;<a name='1391'>
          prn,     psn,       &amp;<a name='1392'>
        pwacs,   wgacr,       &amp;<a name='1393'>
        pidep,    pint,       &amp;<a name='1394'>
          qsi,     ssi,       &amp;<a name='1395'>
          esi,     esw,       &amp;<a name='1396'>
          qsw,      pr,       &amp;<a name='1397'>
          ssw,   pihom,       &amp;<a name='1398'>
         pidw,   pimlt,       &amp;<a name='1399'>
        psaut,   qracs,       &amp;<a name='1400'>
        psaci,   psacw,       &amp;<a name='1401'>
        qsacw,   praci,       &amp;<a name='1402'>
        pmlts,   pmltg,       &amp;<a name='1403'>
        asss,       y1,    y2<a name='1404'>
<font color=#447700>!JJS       Y2(its:ite,jts:jte),    DDE(NB)<a name='1405'></font>
<a name='1406'>
<font color=#447700>!JJS      COMMON/BSAT/<a name='1407'></font>
  real, dimension (its:ite,jts:jte) ::        &amp;<a name='1408'>
        praut,   pracw,       &amp;<a name='1409'>
         psfw,    psfi,       &amp;<a name='1410'>
        dgacs,   dgacw,       &amp;<a name='1411'>
        dgaci,   dgacr,       &amp;<a name='1412'>
        pgacs,   wgacs,       &amp;<a name='1413'>
        qgacw,   wgaci,       &amp;<a name='1414'>
        qgacr,   pgwet,       &amp;<a name='1415'>
        pgaut,   pracs,       &amp;<a name='1416'>
        psacr,   qsacr,       &amp;<a name='1417'>
         pgfr,   psmlt,       &amp;<a name='1418'>
        pgmlt,   psdep,       &amp;<a name='1419'>
        pgdep,   piacr,       &amp;<a name='1420'>
           y5,     scv,       &amp;<a name='1421'>
          tca,     dwv,       &amp;<a name='1422'>
          egs,      y3,       &amp;<a name='1423'>
           y4,     ddb<a name='1424'>
<a name='1425'>
<font color=#447700>!JJS      COMMON/BSAT1/<a name='1426'></font>
  real, dimension (its:ite,jts:jte) ::        &amp;<a name='1427'>
           pt,      qv,       &amp;<a name='1428'>
           qc,      qr,       &amp;<a name='1429'>
           qi,      qs,       &amp;<a name='1430'>
           qg,    tair,       &amp;<a name='1431'>
        tairc,   rtair,       &amp;<a name='1432'>
          dep,      dd,       &amp;<a name='1433'>
          dd1,     qvs,       &amp;<a name='1434'>
           dm,      rq,       &amp;<a name='1435'>
        rsub1,     col,       &amp;<a name='1436'>
          cnd,     ern,       &amp;<a name='1437'>
         dlt1,    dlt2,       &amp;<a name='1438'>
         dlt3,    dlt4,       &amp;<a name='1439'>
           zr,      vr,       &amp;<a name='1440'>
           zs,      vs,       &amp;<a name='1441'>
                 pssub,       &amp;<a name='1442'>
        pgsub,     dda<a name='1443'>
<a name='1444'>
<font color=#447700>!JJS      COMMON/B5/<a name='1445'></font>
  real, dimension (its:ite,jts:jte,kts:kte) ::  rho<a name='1446'>
  real, dimension (kts:kte) ::                 &amp; <a name='1447'>
           tb,      qb,    rho1,              &amp;<a name='1448'>
           ta,      qa,     ta1,     qa1,     &amp;<a name='1449'>
         coef,      z1,      z2,      z3,     &amp;<a name='1450'>
           am,     am1,      ub,      vb,     &amp;<a name='1451'>
           wb,     ub1,     vb1,    rrho,     &amp;<a name='1452'>
        rrho1,     wbx<a name='1453'>
<a name='1454'>
<font color=#447700>!JJS      COMMON/B6/<a name='1455'></font>
  real, dimension (its:ite,jts:jte,kts:kte) ::  p0, pi, f0<a name='1456'>
  real, dimension (kts:kte) ::    &amp; <a name='1457'>
           fd,      fe,        &amp;<a name='1458'>
           st,      sv,        &amp;<a name='1459'>
           sq,      sc,        &amp;<a name='1460'>
           se,     sqa<a name='1461'>
<a name='1462'>
<font color=#447700>!JJS      COMMON/BRH1/<a name='1463'></font>
  real, dimension (kts:kte) ::    &amp; <a name='1464'>
         srro,    qrro,    sqc,    sqr,    &amp;<a name='1465'>
          sqi,     sqs,    sqg,   stqc,    &amp;<a name='1466'>
         stqr,    stqi,   stqs,   stqg<a name='1467'>
  real, dimension (nt) ::    &amp; <a name='1468'>
          tqc,     tqr,    tqi,    tqs,    tqg<a name='1469'>
<a name='1470'>
<font color=#447700>!JJS     common/bls/ y0(nx,ny),ts0new(nx,ny),qss0new(nx,ny)<a name='1471'></font>
<a name='1472'>
<font color=#447700>!JJS      COMMON/BLS/<a name='1473'></font>
  real, dimension (ims:ime,jms:jme) ::     &amp;<a name='1474'>
           y0,     ts0,   qss0<a name='1475'>
<a name='1476'>
<font color=#447700>!JJS      COMMON/BI/ IT(its:ite,jts:jte), ICS(its:ite,jts:jte,4)<a name='1477'></font>
  integer, dimension (its:ite,jts:jte) ::        it  <a name='1478'>
  integer, dimension (its:ite,jts:jte, 4) ::    ics <a name='1479'>
<a name='1480'>
  integer :: i24h<a name='1481'>
  integer :: iwarm<a name='1482'>
  real :: r2is, r2ig<a name='1483'>
  <a name='1484'>
<a name='1485'>
<font color=#447700>!JJS      COMMON/MICRO/<a name='1486'></font>
<font color=#447700>!  real, dimension (ims:ime,kms:kme,jms:jme)  ::    dbz <a name='1487'></font>
<a name='1488'>
<font color=#447700>!23456789012345678901234567890123456789012345678901234567890123456789012<a name='1489'></font>
<a name='1490'>
<font color=#447700>!<a name='1491'></font>
<font color=#447700>!JJS 1/3/2008  vvvvv<a name='1492'></font>
<font color=#447700>!JJS   the following common blocks have been moved to the top of<a name='1493'></font>
<font color=#447700>!JJS   module_mp_gsfcgce_driver.F<a name='1494'></font>
<a name='1495'>
<font color=#447700>!  real, dimension (31)   ::      aa1,  aa2<a name='1496'></font>
<font color=#447700>!  data aa1/.7939e-7, .7841e-6, .3369e-5, .4336e-5, .5285e-5,     &amp;<a name='1497'></font>
<font color=#447700>!           .3728e-5, .1852e-5, .2991e-6, .4248e-6, .7434e-6,     &amp;<a name='1498'></font>
<font color=#447700>!           .1812e-5, .4394e-5, .9145e-5, .1725e-4, .3348e-4,     &amp;<a name='1499'></font>
<font color=#447700>!           .1725e-4, .9175e-5, .4412e-5, .2252e-5, .9115e-6,     &amp;<a name='1500'></font>
<font color=#447700>!           .4876e-6, .3473e-6, .4758e-6, .6306e-6, .8573e-6,     &amp;<a name='1501'></font>
<font color=#447700>!           .7868e-6, .7192e-6, .6513e-6, .5956e-6, .5333e-6,     &amp;<a name='1502'></font>
<font color=#447700>!           .4834e-6/<a name='1503'></font>
<font color=#447700>!  data aa2/.4006, .4831, .5320, .5307, .5319,      &amp;<a name='1504'></font>
<font color=#447700>!           .5249, .4888, .3894, .4047, .4318,      &amp;<a name='1505'></font>
<font color=#447700>!           .4771, .5183, .5463, .5651, .5813,      &amp;<a name='1506'></font>
<font color=#447700>!           .5655, .5478, .5203, .4906, .4447,      &amp;<a name='1507'></font>
<font color=#447700>!           .4126, .3960, .4149, .4320, .4506,      &amp;<a name='1508'></font>
<font color=#447700>!           .4483, .4460, .4433, .4413, .4382,      &amp;<a name='1509'></font>
<font color=#447700>!           .4361/<a name='1510'></font>
<a name='1511'>
<font color=#447700>!JJS 1/3/2008  ^^^^^<a name='1512'></font>
<a name='1513'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1514'></font>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT):: refl_10cm  <font color=#447700>! GT<a name='1515'></font>
<font color=#447700>! TYPE (WRFU_Clock):: grid_clock<a name='1516'></font>
<font color=#447700>! TYPE (WRFU_Alarm), POINTER:: grid_alarms(:)<a name='1517'></font>
<a name='1518'>
<a name='1519'>
      REAL, DIMENSION(kts:kte):: qv1d, t1d, p1d, qr1d, qs1d, qg1d, dBZ<a name='1520'>
      LOGICAL, OPTIONAL, INTENT(IN) :: diagflag<a name='1521'>
      INTEGER, OPTIONAL, INTENT(IN) :: do_radar_ref<a name='1522'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1523'></font>
<font color=#447700>!<a name='1524'></font>
<font color=#447700>!jm 20090220      save<a name='1525'></font>
<a name='1526'>
<font color=#447700>!    i24h=nint(86400./dt) <a name='1527'></font>
<font color=#447700>!    if (mod(itimestep,i24h).eq.1) then<a name='1528'></font>
<font color=#447700>!       write(6, *) 'ims=', ims, '  ime=', ime<a name='1529'></font>
<font color=#447700>!       write(6, *) 'jms=', jms, '  jme=', jme<a name='1530'></font>
<font color=#447700>!       write(6, *) 'kms=', kms, '  kme=', kme<a name='1531'></font>
<font color=#447700>!       write(6, *) 'its=', its, '  ite=', ite<a name='1532'></font>
<font color=#447700>!       write(6, *) 'jts=', jts, '  jte=', jte<a name='1533'></font>
<font color=#447700>!       write(6, *) 'kts=', kts, '  kte=', kte<a name='1534'></font>
<font color=#447700>!       write(6, *) '    ihail=', ihail<a name='1535'></font>
<font color=#447700>!       write(6, *) 'itaobraun=',itaobraun<a name='1536'></font>
<font color=#447700>!       write(6, *) '    ice2=', ICE2<a name='1537'></font>
<font color=#447700>!       write(6, *) 'istatmin=',istatmin<a name='1538'></font>
<font color=#447700>!       write(6, *) 'new_ice_sat=', new_ice_sat<a name='1539'></font>
<font color=#447700>!       write(6, *) 'id=', id<a name='1540'></font>
<font color=#447700>!       write(6, *) 'dt=', dt<a name='1541'></font>
<font color=#447700>!    endif<a name='1542'></font>
<a name='1543'>
<font color=#447700>!JJS  convert from mks to cgs, and move from WRF grid to GCE grid<a name='1544'></font>
      do k=kts,kte<a name='1545'>
         do j=jts,jte<a name='1546'>
         do i=its,ite<a name='1547'>
         rho(i,j,k)=rho_mks(i,k,j)*0.001<a name='1548'>
         p0(i,j,k)=p0_mks(i,k,j)*10.0<a name='1549'>
         pi(i,j,k)=pi_mks(i,k,j)<a name='1550'>
         dpt(i,j,k)=ptwrf(i,k,j)<a name='1551'>
         dqv(i,j,k)=qvwrf(i,k,j)<a name='1552'>
         qcl(i,j,k)=qlwrf(i,k,j)<a name='1553'>
         qrn(i,j,k)=qrwrf(i,k,j)<a name='1554'>
         qci(i,j,k)=qiwrf(i,k,j)<a name='1555'>
         qcs(i,j,k)=qswrf(i,k,j)<a name='1556'>
         qcg(i,j,k)=qgwrf(i,k,j)<a name='1557'>
<font color=#447700>!JJS 10/16/06    vvvv<a name='1558'></font>
<font color=#447700>!         dpt1(i,j,k)=ptwrfold(i,k,j)<a name='1559'></font>
<font color=#447700>!         dqv1(i,j,k)=qvwrfold(i,k,j)<a name='1560'></font>
<font color=#447700>!         qcl1(i,j,k)=qlwrfold(i,k,j)<a name='1561'></font>
<font color=#447700>!         qrn1(i,j,k)=qrwrfold(i,k,j)<a name='1562'></font>
<font color=#447700>!         qci1(i,j,k)=qiwrfold(i,k,j)<a name='1563'></font>
<font color=#447700>!         qcs1(i,j,k)=qswrfold(i,k,j)<a name='1564'></font>
<font color=#447700>!         qcg1(i,j,k)=qgwrfold(i,k,j)<a name='1565'></font>
<font color=#447700>!JJS 10/16/06     ^^^^<a name='1566'></font>
         enddo <font color=#447700>!i<a name='1567'></font>
         enddo <font color=#447700>!j<a name='1568'></font>
      enddo <font color=#447700>!k<a name='1569'></font>
<a name='1570'>
      do k=kts,kte<a name='1571'>
         do j=jts,jte<a name='1572'>
         do i=its,ite<a name='1573'>
         fv(i,j,k)=sqrt(rho(i,j,2)/rho(i,j,k))<a name='1574'>
         enddo <font color=#447700>!i<a name='1575'></font>
         enddo <font color=#447700>!j<a name='1576'></font>
      enddo <font color=#447700>!k<a name='1577'></font>
<font color=#447700>!JJS<a name='1578'></font>
<a name='1579'>
<font color=#447700>!<a name='1580'></font>
<font color=#447700>!     ******   THREE CLASSES OF ICE-PHASE   (LIN ET AL, 1983)  *********<a name='1581'></font>
<a name='1582'>
<font color=#447700>!JJS       D22T=D2T<a name='1583'></font>
<font color=#447700>!JJS       IF(IJKADV .EQ. 0) THEN<a name='1584'></font>
<font color=#447700>!JJS         D2T=D2T<a name='1585'></font>
<font color=#447700>!JJS       ELSE<a name='1586'></font>
         d2t=dt<a name='1587'>
<font color=#447700>!JJS       ENDIF<a name='1588'></font>
<font color=#447700>!<a name='1589'></font>
<font color=#447700>!       itaobraun=0 ! original pint and pidep &amp; see Tao and Simpson 1993<a name='1590'></font>
        itaobraun=1 <font color=#447700>! see Tao et al. (2003)<a name='1591'></font>
<font color=#447700>!<a name='1592'></font>
       if ( itaobraun.eq.0 ) then<a name='1593'>
          cn0=1.e-8<a name='1594'>
<font color=#447700>!c        beta=-.6<a name='1595'></font>
       elseif ( itaobraun.eq.1 ) then<a name='1596'>
          cn0=1.e-6<a name='1597'>
<font color=#447700>!         cn0=1.e-8  ! special<a name='1598'></font>
<font color=#447700>!c        beta=-.46<a name='1599'></font>
       endif<a name='1600'>
<font color=#447700>!C  TAO 2007 START<a name='1601'></font>
<font color=#447700>!   ICE2=0 ! default, 3ice with loud ice, snow and graupel<a name='1602'></font>
<font color=#447700>!              r2is=1., r2ig=1.<a name='1603'></font>
<font color=#447700>!   ICE2=1 ! 2ice with cloud ice and snow (no graupel) - r2iceg=1, r2ice=0.<a name='1604'></font>
<font color=#447700>!              r2is=1., r2ig=0.<a name='1605'></font>
<font color=#447700>!   ICE2=2 ! 2ice with cloud ice and graupel (no snow) - r2ice=1, r2iceg=0.<a name='1606'></font>
<font color=#447700>!              r2is=0., r2ig=1.<a name='1607'></font>
<font color=#447700>!c<a name='1608'></font>
<font color=#447700>!        r2ice=1.<a name='1609'></font>
<font color=#447700>!        r2iceg=1.<a name='1610'></font>
         r2ig=1.<a name='1611'>
         r2is=1.<a name='1612'>
          if (ice2 .eq. 1) then<a name='1613'>
<font color=#447700>!              r2ice=0.<a name='1614'></font>
<font color=#447700>!              r2iceg=1.<a name='1615'></font>
              r2ig=0.<a name='1616'>
              r2is=1.<a name='1617'>
          endif<a name='1618'>
          if (ice2 .eq. 2) then<a name='1619'>
<font color=#447700>!              r2ice=1.<a name='1620'></font>
<font color=#447700>!              r2iceg=0.<a name='1621'></font>
              r2ig=1.<a name='1622'>
              r2is=0.<a name='1623'>
          endif<a name='1624'>
<font color=#447700>!C  TAO 2007 END<a name='1625'></font>
     <a name='1626'>
<font color=#447700>!JJS  10/7/2008<a name='1627'></font>
<font color=#447700>!   ICE2=3 ! no ice, warm rain only<a name='1628'></font>
    iwarm = 0<a name='1629'>
    if (ice2 .eq. 3 ) iwarm = 1<a name='1630'>
<a name='1631'>
<a name='1632'>
<a name='1633'>
      cmin=1.e-19<a name='1634'>
      cmin1=1.e-20<a name='1635'>
      cmin2=1.e-12<a name='1636'>
      ucor=3071.29/tnw**0.75<a name='1637'>
      ucos=687.97*roqs**0.25/tns**0.75<a name='1638'>
      ucog=687.97*roqg**0.25/tng**0.75<a name='1639'>
      uwet=4.464**0.95<a name='1640'>
<a name='1641'>
      rijl2 = 1. / (ide-ids) / (jde-jds)<a name='1642'>
<a name='1643'>
<font color=#447700>!JJScap $doacross local(j,i)<a name='1644'></font>
<a name='1645'>
<font color=#447700>!JJS      DO 1 J=1,JMAX<a name='1646'></font>
<font color=#447700>!JJS      DO 1 I=1,IMAX<a name='1647'></font>
       do j=jts,jte<a name='1648'>
          do i=its,ite<a name='1649'>
          it(i,j)=1<a name='1650'>
          enddo<a name='1651'>
       enddo<a name='1652'>
<a name='1653'>
      f2=rd1*d2t<a name='1654'>
      f3=rd2*d2t<a name='1655'>
<a name='1656'>
      ft=dt/d2t<a name='1657'>
      rft=rijl2*ft<a name='1658'>
      a0=.5*istatmin*rijl2<a name='1659'>
      rt0=1./(t0-t00)<a name='1660'>
      bw3=bw+3.<a name='1661'>
      bs3=bs+3.<a name='1662'>
      bg3=bg+3.<a name='1663'>
      bsh5=2.5+bsh<a name='1664'>
      bgh5=2.5+bgh<a name='1665'>
      bwh5=2.5+bwh<a name='1666'>
      bw6=bw+6.<a name='1667'>
      bs6=bs+6.<a name='1668'>
      betah=.5*beta<a name='1669'>
      r10t=rn10*d2t<a name='1670'>
      r11at=rn11a*d2t<a name='1671'>
      r19bt=rn19b*d2t<a name='1672'>
      r20t=-rn20*d2t<a name='1673'>
      r23t=-rn23*d2t<a name='1674'>
      r25a=rn25<a name='1675'>
<a name='1676'>
<font color=#447700>!     ami50 for use in PINT<a name='1677'></font>
       ami50=3.76e-8<a name='1678'>
       ami100=1.51e-7<a name='1679'>
       ami40=2.41e-8<a name='1680'>
<a name='1681'>
<font color=#447700>!C    ******************************************************************<a name='1682'></font>
<a name='1683'>
<font color=#447700>!JJS      DO 1000 K=2,kles<a name='1684'></font>
      do 1000 k=kts,kte<a name='1685'>
         kp=k+1<a name='1686'>
<font color=#447700>!JJS         tb0=ta1(k)<a name='1687'></font>
<font color=#447700>!JJS         qb0=qa1(k)<a name='1688'></font>
         tb0=0.<a name='1689'>
         qb0=0.<a name='1690'>
<a name='1691'>
      do 2000 j=jts,jte<a name='1692'>
         do 2000 i=its,ite<a name='1693'>
<a name='1694'>
         rp0=3.799052e3/p0(i,j,k)<a name='1695'>
         pi0=pi(i,j,k)<a name='1696'>
         pir=1./(pi(i,j,k))<a name='1697'>
         pr0=1./p0(i,j,k)<a name='1698'>
         r00=rho(i,j,k)<a name='1699'>
         r0s=sqrt(rho(i,j,k))<a name='1700'>
<font color=#447700>!JJS         RR0=RRHO(K)<a name='1701'></font>
         rr0=1./rho(i,j,k)<a name='1702'>
<font color=#447700>!JJS         RRS=SRRO(K)<a name='1703'></font>
         rrs=sqrt(rr0)<a name='1704'>
<font color=#447700>!JJS         RRQ=QRRO(K)<a name='1705'></font>
         rrq=sqrt(rrs)<a name='1706'>
         f0(i,j,k)=al/cp/pi(i,j,k)<a name='1707'>
         f00=f0(i,j,k)<a name='1708'>
         fv0=fv(i,j,k)<a name='1709'>
         fvs=sqrt(fv(i,j,k))<a name='1710'>
         zrr=1.e5*zrc*rrq<a name='1711'>
         zsr=1.e5*zsc*rrq<a name='1712'>
         zgr=1.e5*zgc*rrq<a name='1713'>
         cp409=c409*pi0<a name='1714'>
         cv409=c409*avc<a name='1715'>
         cp580=c580*pi0<a name='1716'>
         cs580=c580*asc<a name='1717'>
         alvr=r00*alv<a name='1718'>
         afcp=afc*pir<a name='1719'>
         avcp=avc*pir<a name='1720'>
         ascp=asc*pir<a name='1721'>
         vrcf=vrc*fv0<a name='1722'>
         vscf=vsc*fv0<a name='1723'>
         vgcf=vgc*fv0<a name='1724'>
         vgcr=vgc*rrs<a name='1725'>
         dwvp=c879*pr0<a name='1726'>
         r3f=rn3*fv0<a name='1727'>
         r4f=rn4*fv0<a name='1728'>
         r5f=rn5*fv0<a name='1729'>
         r6f=rn6*fv0<a name='1730'>
         r7r=rn7*rr0<a name='1731'>
         r8r=rn8*rr0<a name='1732'>
         r9r=rn9*rr0<a name='1733'>
         r101f=rn101*fvs<a name='1734'>
         r10ar=rn10a*r00<a name='1735'>
         r11rt=rn11*rr0*d2t<a name='1736'>
         r12r=rn12*r00<a name='1737'>
         r14r=rn14*rrs<a name='1738'>
         r14f=rn14*fv0<a name='1739'>
         r15r=rn15*rrs<a name='1740'>
         r15ar=rn15a*rrs<a name='1741'>
         r15f=rn15*fv0<a name='1742'>
         r15af=rn15a*fv0<a name='1743'>
         r16r=rn16*rr0<a name='1744'>
         r17r=rn17*rr0<a name='1745'>
         r17aq=rn17a*rrq<a name='1746'>
         r17as=rn17a*fvs<a name='1747'>
         r18r=rn18*rr0<a name='1748'>
         r19rt=rn19*rr0*d2t<a name='1749'>
         r19aq=rn19a*rrq<a name='1750'>
         r19as=rn19a*fvs<a name='1751'>
         r20bq=rn20b*rrq<a name='1752'>
         r20bs=rn20b*fvs<a name='1753'>
         r22f=rn22*fv0<a name='1754'>
         r23af=rn23a*fvs<a name='1755'>
         r23br=rn23b*r00<a name='1756'>
         r25rt=rn25*rr0*d2t<a name='1757'>
         r31r=rn31*rr0<a name='1758'>
         r32rt=rn32*d2t*rrs<a name='1759'>
<a name='1760'>
<font color=#447700>!JJS       DO 100 J=3,JLES<a name='1761'></font>
<font color=#447700>!JJS       DO 100 I=3,ILES<a name='1762'></font>
        pt(i,j)=dpt(i,j,k)<a name='1763'>
        qv(i,j)=dqv(i,j,k)<a name='1764'>
        qc(i,j)=qcl(i,j,k)<a name='1765'>
        qr(i,j)=qrn(i,j,k)<a name='1766'>
        qi(i,j)=qci(i,j,k)<a name='1767'>
        qs(i,j)=qcs(i,j,k)<a name='1768'>
        qg(i,j)=qcg(i,j,k)<a name='1769'>
<font color=#447700>!        IF (QV(I,J)+QB0 .LE. 0.) QV(I,J)=-QB0<a name='1770'></font>
         if (qc(i,j) .le.  cmin1) qc(i,j)=0.0<a name='1771'>
         if (qr(i,j) .le.  cmin1) qr(i,j)=0.0<a name='1772'>
         if (qi(i,j) .le.  cmin1) qi(i,j)=0.0<a name='1773'>
         if (qs(i,j) .le.  cmin1) qs(i,j)=0.0<a name='1774'>
         if (qg(i,j) .le.  cmin1) qg(i,j)=0.0<a name='1775'>
        tair(i,j)=(pt(i,j)+tb0)*pi0<a name='1776'>
        tairc(i,j)=tair(i,j)-t0<a name='1777'>
         zr(i,j)=zrr<a name='1778'>
         zs(i,j)=zsr<a name='1779'>
         zg(i,j)=zgr<a name='1780'>
         vr(i,j)=0.0<a name='1781'>
         vs(i,j)=0.0<a name='1782'>
         vg(i,j)=0.0<a name='1783'>
<a name='1784'>
<font color=#447700>!JJS 10/7/2008     vvvvv<a name='1785'></font>
    IF (IWARM .EQ. 1) THEN<a name='1786'>
<font color=#447700>!JJS   for calculating processes related to warm rain only<a name='1787'></font>
                qi(i,j)=0.0<a name='1788'>
                qs(i,j)=0.0<a name='1789'>
                qg(i,j)=0.0<a name='1790'>
                dep(i,j)=0.<a name='1791'>
                pint(i,j)=0.<a name='1792'>
                psdep(i,j)=0.<a name='1793'>
                pgdep(i,j)=0.<a name='1794'>
                dd1(i,j)=0.<a name='1795'>
                pgsub(i,j)=0.<a name='1796'>
                psmlt(i,j)=0.<a name='1797'>
                pgmlt(i,j)=0.<a name='1798'>
                pimlt(i,j)=0.<a name='1799'>
                psacw(i,j)=0.<a name='1800'>
                piacr(i,j)=0.<a name='1801'>
                psfw(i,j)=0.<a name='1802'>
                pgfr(i,j)=0.<a name='1803'>
                dgacw(i,j)=0.<a name='1804'>
                dgacr(i,j)=0.<a name='1805'>
                psacr(i,j)=0.<a name='1806'>
                wgacr(i,j)=0.<a name='1807'>
                pihom(i,j)=0.<a name='1808'>
                pidw(i,j)=0.<a name='1809'>
<a name='1810'>
                if (qr(i,j) .gt. cmin1) then<a name='1811'>
                   dd(i,j)=r00*qr(i,j)<a name='1812'>
                   y1(i,j)=dd(i,j)**.25<a name='1813'>
                   zr(i,j)=zrc/y1(i,j)<a name='1814'>
                   vr(i,j)=max(vrcf*dd(i,j)**bwq, 0.)<a name='1815'>
                endif<a name='1816'>
<a name='1817'>
<font color=#447700>!* 21 * PRAUT   AUTOCONVERSION OF QC TO QR                        **21**<a name='1818'></font>
<font color=#447700>!* 22 * PRACW : ACCRETION OF QC BY QR                             **22**<a name='1819'></font>
                pracw(i,j)=0.<a name='1820'>
                praut(i,j)=0.0<a name='1821'>
                pracw(i,j)=r22f*qc(i,j)/zr(i,j)**bw3<a name='1822'>
                y1(i,j)=qc(i,j)-bnd3<a name='1823'>
                if (y1(i,j).gt.0.0) then<a name='1824'>
                    praut(i,j)=r00*y1(i,j)*y1(i,j)/(1.2e-4+rn21/y1(i,j))<a name='1825'>
                 endif<a name='1826'>
<a name='1827'>
<font color=#447700>!C********   HANDLING THE NEGATIVE CLOUD WATER (QC)    ******************<a name='1828'></font>
                 Y1(I,J)=QC(I,J)/D2T<a name='1829'>
                 PRAUT(I,J)=MIN(Y1(I,J), PRAUT(I,J))<a name='1830'>
                 PRACW(I,J)=MIN(Y1(I,J), PRACW(I,J))<a name='1831'>
                 Y1(I,J)=(PRAUT(I,J)+PRACW(I,J))*D2T<a name='1832'>
               <a name='1833'>
               if (qc(i,j) .lt. y1(i,j) .and. y1(i,j) .ge. cmin2) then<a name='1834'>
                   y2(i,j)=qc(i,j)/(y1(i,j)+cmin2)<a name='1835'>
                   praut(i,j)=praut(i,j)*y2(i,j)<a name='1836'>
                   pracw(i,j)=pracw(i,j)*y2(i,j)<a name='1837'>
                   qc(i,j)=0.0<a name='1838'>
               else<a name='1839'>
                  qc(i,j)=qc(i,j)-y1(i,j)<a name='1840'>
               endif<a name='1841'>
               <a name='1842'>
               PR(I,J)=(PRAUT(I,J)+PRACW(I,J))*D2T<a name='1843'>
               QR(I,J)=QR(I,J)+PR(I,J)<a name='1844'>
                        <a name='1845'>
<font color=#447700>!*****   TAO ET AL (1989) SATURATION TECHNIQUE  ***********************<a name='1846'></font>
           <a name='1847'>
           cnd(i,j)=0.0<a name='1848'>
           tair(i,j)=(pt(i,j)+tb0)*pi0<a name='1849'>
              y1(i,j)=1./(tair(i,j)-c358)<a name='1850'>
              qsw(i,j)=rp0*exp(c172-c409*y1(i,j))<a name='1851'>
              dd(i,j)=cp409*y1(i,j)*y1(i,j)<a name='1852'>
              dm(i,j)=qv(i,j)+qb0-qsw(i,j)<a name='1853'>
              cnd(i,j)=dm(i,j)/(1.+avcp*dd(i,j)*qsw(i,j))<a name='1854'>
<font color=#447700>!c    ******   condensation or evaporation of qc  ******<a name='1855'></font>
              cnd(i,j)=max(-qc(i,j), cnd(i,j))<a name='1856'>
                         pt(i,j)=pt(i,j)+avcp*cnd(i,j)<a name='1857'>
             qv(i,j)=qv(i,j)-cnd(i,j)<a name='1858'>
                         qc(i,j)=qc(i,j)+cnd(i,j)<a name='1859'>
<a name='1860'>
<font color=#447700>!C     ******   EVAPORATION   ******<a name='1861'></font>
<font color=#447700>!* 23 * ERN : EVAPORATION OF QR (SUBSATURATION)                   **23**<a name='1862'></font>
            ern(i,j)=0.0<a name='1863'>
<a name='1864'>
            if(qr(i,j).gt.0.0) then<a name='1865'>
               tair(i,j)=(pt(i,j)+tb0)*pi0<a name='1866'>
               rtair(i,j)=1./(tair(i,j)-c358)<a name='1867'>
               qsw(i,j)=rp0*exp(c172-c409*rtair(i,j))<a name='1868'>
               ssw(i,j)=(qv(i,j)+qb0)/qsw(i,j)-1.0<a name='1869'>
               dm(i,j)=qv(i,j)+qb0-qsw(i,j)<a name='1870'>
               rsub1(i,j)=cv409*qsw(i,j)*rtair(i,j)*rtair(i,j)<a name='1871'>
               dd1(i,j)=max(-dm(i,j)/(1.+rsub1(i,j)), 0.0)<a name='1872'>
               y1(i,j)=.78/zr(i,j)**2+r23af*scv(i,j)/zr(i,j)**bwh5<a name='1873'>
               y2(i,j)=r23br/(tca(i,j)*tair(i,j)**2)+1./(dwv(i,j) &amp;<a name='1874'>
                       *qsw(i,j))<a name='1875'>
<font color=#447700>!cccc<a name='1876'></font>
               ern(i,j)=r23t*ssw(i,j)*y1(i,j)/y2(i,j)<a name='1877'>
               ern(i,j)=min(dd1(i,j),qr(i,j),max(ern(i,j),0.))<a name='1878'>
               pt(i,j)=pt(i,j)-avcp*ern(i,j)<a name='1879'>
               qv(i,j)=qv(i,j)+ern(i,j)<a name='1880'>
               qr(i,j)=qr(i,j)-ern(i,j)<a name='1881'>
            endif<a name='1882'>
<a name='1883'>
       ELSE       <font color=#447700>! part of if (iwarm.eq.1) then<a name='1884'></font>
<font color=#447700>!JJS 10/7/2008     ^^^^^<a name='1885'></font>
<a name='1886'>
<font color=#447700>!JJS   for calculating processes related to both ice and warm rain<a name='1887'></font>
<a name='1888'>
<font color=#447700>!     ***   COMPUTE ZR,ZS,ZG,VR,VS,VG      *****************************<a name='1889'></font>
<a name='1890'>
            if (qr(i,j) .gt. cmin1) then<a name='1891'>
               dd(i,j)=r00*qr(i,j)<a name='1892'>
               y1(i,j)=dd(i,j)**.25<a name='1893'>
               zr(i,j)=zrc/y1(i,j)<a name='1894'>
               vr(i,j)=max(vrcf*dd(i,j)**bwq, 0.)<a name='1895'>
            endif<a name='1896'>
<a name='1897'>
            if (qs(i,j) .gt. cmin1) then<a name='1898'>
               dd(i,j)=r00*qs(i,j)<a name='1899'>
               y1(i,j)=dd(i,j)**.25<a name='1900'>
               zs(i,j)=zsc/y1(i,j)<a name='1901'>
               vs(i,j)=max(vscf*dd(i,j)**bsq, 0.)<a name='1902'>
            endif<a name='1903'>
<a name='1904'>
            if (qg(i,j) .gt. cmin1) then<a name='1905'>
               dd(i,j)=r00*qg(i,j)<a name='1906'>
               y1(i,j)=dd(i,j)**.25<a name='1907'>
               zg(i,j)=zgc/y1(i,j)<a name='1908'>
               if(ihail .eq. 1) then<a name='1909'>
                  vg(i,j)=max(vgcr*dd(i,j)**bgq, 0.)<a name='1910'>
               else<a name='1911'>
                  vg(i,j)=max(vgcf*dd(i,j)**bgq, 0.)<a name='1912'>
               endif<a name='1913'>
            endif<a name='1914'>
<a name='1915'>
            if (qr(i,j) .le. cmin2) vr(i,j)=0.0<a name='1916'>
            if (qs(i,j) .le. cmin2) vs(i,j)=0.0<a name='1917'>
            if (qg(i,j) .le. cmin2) vg(i,j)=0.0<a name='1918'>
<a name='1919'>
<font color=#447700>!     ******************************************************************<a name='1920'></font>
<font color=#447700>!     ***   Y1 : DYNAMIC VISCOSITY OF AIR (U)<a name='1921'></font>
<font color=#447700>!     ***   DWV : DIFFUSIVITY OF WATER VAPOR IN AIR (PI)<a name='1922'></font>
<font color=#447700>!     ***   TCA : THERMAL CONDUCTIVITY OF AIR (KA)<a name='1923'></font>
<font color=#447700>!     ***   Y2 : KINETIC VISCOSITY (V)<a name='1924'></font>
<a name='1925'>
            y1(i,j)=c149*tair(i,j)**1.5/(tair(i,j)+120.)<a name='1926'>
            dwv(i,j)=dwvp*tair(i,j)**1.81<a name='1927'>
            tca(i,j)=c141*y1(i,j)<a name='1928'>
            scv(i,j)=1./((rr0*y1(i,j))**.1666667*dwv(i,j)**.3333333)<a name='1929'>
<font color=#447700>!JJS  100    CONTINUE<a name='1930'></font>
<a name='1931'>
<font color=#447700>!*  1 * PSAUT : AUTOCONVERSION OF QI TO QS                        ***1**<a name='1932'></font>
<font color=#447700>!*  3 * PSACI : ACCRETION OF QI TO QS                             ***3**<a name='1933'></font>
<font color=#447700>!*  4 * PSACW : ACCRETION OF QC BY QS (RIMING) (QSACW FOR PSMLT)  ***4**<a name='1934'></font>
<font color=#447700>!*  5 * PRACI : ACCRETION OF QI BY QR                             ***5**<a name='1935'></font>
<font color=#447700>!*  6 * PIACR : ACCRETION OF QR OR QG BY QI                       ***6**<a name='1936'></font>
<a name='1937'>
<font color=#447700>!JJS         DO 125 J=3,JLES<a name='1938'></font>
<font color=#447700>!JJS         DO 125 I=3,ILES<a name='1939'></font>
            psaut(i,j)=0.0<a name='1940'>
            psaci(i,j)=0.0<a name='1941'>
            praci(i,j)=0.0<a name='1942'>
            piacr(i,j)=0.0<a name='1943'>
            psacw(i,j)=0.0<a name='1944'>
            qsacw(i,j)=0.0<a name='1945'>
            dd(i,j)=1./zs(i,j)**bs3<a name='1946'>
<a name='1947'>
            if (tair(i,j).lt.t0) then<a name='1948'>
               esi(i,j)=exp(.025*tairc(i,j))<a name='1949'>
               psaut(i,j)=r2is*max(rn1*esi(i,j)*(qi(i,j)-bnd1) ,0.0)<a name='1950'>
               psaci(i,j)=r2is*r3f*esi(i,j)*qi(i,j)*dd(i,j)<a name='1951'>
<font color=#447700>!JJS 3/30/06<a name='1952'></font>
<font color=#447700>!    to cut water to snow accretion by half<a name='1953'></font>
<font color=#447700>!               PSACW(I,J)=R4F*QC(I,J)*DD(I,J)<a name='1954'></font>
               psacw(i,j)=r2is*0.5*r4f*qc(i,j)*dd(i,j)<a name='1955'>
<font color=#447700>!JJS 3/30/06<a name='1956'></font>
               praci(i,j)=r2is*r5f*qi(i,j)/zr(i,j)**bw3<a name='1957'>
               piacr(i,j)=r2is*r6f*qi(i,j)*(zr(i,j)**(-bw6))<a name='1958'>
<font color=#447700>!JJS               PIACR(I,J)=R6F*QI(I,J)/ZR(I,J)**BW6<a name='1959'></font>
            else<a name='1960'>
               qsacw(i,j)=r2is*r4f*qc(i,j)*dd(i,j)<a name='1961'>
            endif<a name='1962'>
<a name='1963'>
<font color=#447700>!* 21 * PRAUT   AUTOCONVERSION OF QC TO QR                        **21**<a name='1964'></font>
<font color=#447700>!* 22 * PRACW : ACCRETION OF QC BY QR                             **22**<a name='1965'></font>
<a name='1966'>
            pracw(i,j)=r22f*qc(i,j)/zr(i,j)**bw3<a name='1967'>
            praut(i,j)=0.0<a name='1968'>
            y1(i,j)=qc(i,j)-bnd3<a name='1969'>
            if (y1(i,j).gt.0.0) then<a name='1970'>
               praut(i,j)=r00*y1(i,j)*y1(i,j)/(1.2e-4+rn21/y1(i,j))<a name='1971'>
            endif<a name='1972'>
<a name='1973'>
<font color=#447700>!* 12 * PSFW : BERGERON PROCESSES FOR QS (KOENING, 1971)          **12**<a name='1974'></font>
<font color=#447700>!* 13 * PSFI : BERGERON PROCESSES FOR QS                          **13**<a name='1975'></font>
<a name='1976'>
            psfw(i,j)=0.0<a name='1977'>
            psfi(i,j)=0.0<a name='1978'>
            pidep(i,j)=0.0<a name='1979'>
<a name='1980'>
            if(tair(i,j).lt.t0.and.qi(i,j).gt.cmin) then<a name='1981'>
               y1(i,j)=max( min(tairc(i,j), -1.), -31.)<a name='1982'>
               it(i,j)=int(abs(y1(i,j)))<a name='1983'>
               y1(i,j)=rn12a(it(i,j))<a name='1984'>
               y2(i,j)=rn12b(it(i,j))<a name='1985'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='1986'></font>
          psfw(i,j)=r2is* &amp;<a name='1987'>
                    max(d2t*y1(i,j)*(y2(i,j)+r12r*qc(i,j))*qi(i,j),0.0)<a name='1988'>
               rtair(i,j)=1./(tair(i,j)-c76)<a name='1989'>
               y2(i,j)=exp(c218-c580*rtair(i,j))<a name='1990'>
               qsi(i,j)=rp0*y2(i,j)<a name='1991'>
               esi(i,j)=c610*y2(i,j)<a name='1992'>
               ssi(i,j)=(qv(i,j)+qb0)/qsi(i,j)-1.<a name='1993'>
               r_nci=min(1.e-6*exp(-.46*tairc(i,j)),1.)<a name='1994'>
<font color=#447700>!              R_NCI=min(1.e-8*EXP(-.6*TAIRC(I,J)),1.) ! use Tao's<a name='1995'></font>
               dm(i,j)=max( (qv(i,j)+qb0-qsi(i,j)), 0.)<a name='1996'>
               rsub1(i,j)=cs580*qsi(i,j)*rtair(i,j)*rtair(i,j)<a name='1997'>
               y3(i,j)=1./tair(i,j)<a name='1998'>
          dd(i,j)=y3(i,j)*(rn30a*y3(i,j)-rn30b)+rn30c*tair(i,j)/esi(i,j)<a name='1999'>
               y1(i,j)=206.18*ssi(i,j)/dd(i,j)<a name='2000'>
               pidep(i,j)=y1(i,j)*sqrt(r_nci*qi(i,j)/r00)<a name='2001'>
               dep(i,j)=dm(i,j)/(1.+rsub1(i,j))/d2t<a name='2002'>
               if(dm(i,j).gt.cmin2) then<a name='2003'>
                  a2=1.<a name='2004'>
                if(pidep(i,j).gt.dep(i,j).and.pidep(i,j).gt.cmin2) then<a name='2005'>
                     a2=dep(i,j)/pidep(i,j)<a name='2006'>
                     pidep(i,j)=dep(i,j)<a name='2007'>
                endif<a name='2008'>
                  psfi(i,j)=r2is*a2*.5*qi(i,j)*y1(i,j)/(sqrt(ami100) &amp;<a name='2009'>
                          -sqrt(ami40))<a name='2010'>
                  elseif(dm(i,j).lt.-cmin2) then<a name='2011'>
<font color=#447700>!<a name='2012'></font>
<font color=#447700>!        SUBLIMATION TERMS USED ONLY WHEN SATURATION ADJUSTMENT FOR ICE<a name='2013'></font>
<font color=#447700>!        IS TURNED OFF<a name='2014'></font>
<font color=#447700>!<a name='2015'></font>
                  pidep(i,j)=0.<a name='2016'>
                  psfi(i,j)=0.<a name='2017'>
               else<a name='2018'>
                  pidep(i,j)=0.<a name='2019'>
                  psfi(i,j)=0.<a name='2020'>
               endif<a name='2021'>
            endif<a name='2022'>
<a name='2023'>
<font color=#447700>!TTT***** QG=QG+MIN(PGDRY,PGWET)<a name='2024'></font>
<font color=#447700>!*  9 * PGACS : ACCRETION OF QS BY QG (DGACS,WGACS: DRY AND WET)  ***9**<a name='2025'></font>
<font color=#447700>!* 14 * DGACW : ACCRETION OF QC BY QG (QGACW FOR PGMLT)           **14**<a name='2026'></font>
<font color=#447700>!* 16 * DGACR : ACCRETION OF QR TO QG (QGACR FOR PGMLT)           **16**<a name='2027'></font>
<a name='2028'>
            if(qc(i,j)+qr(i,j).lt.1.e-4) then<a name='2029'>
               ee1=.01<a name='2030'>
              else<a name='2031'>
                 ee1=1.<a name='2032'>
              endif<a name='2033'>
            ee2=0.09<a name='2034'>
            egs(i,j)=ee1*exp(ee2*tairc(i,j))<a name='2035'>
<font color=#447700>!            EGS(I,J)=0.1 ! 6/15/02 tao's<a name='2036'></font>
            if (tair(i,j).ge.t0) egs(i,j)=1.0<a name='2037'>
            y1(i,j)=abs(vg(i,j)-vs(i,j))<a name='2038'>
            y2(i,j)=zs(i,j)*zg(i,j)<a name='2039'>
            y3(i,j)=5./y2(i,j)<a name='2040'>
            y4(i,j)=.08*y3(i,j)*y3(i,j)<a name='2041'>
            y5(i,j)=.05*y3(i,j)*y4(i,j)<a name='2042'>
            dd(i,j)=y1(i,j)*(y3(i,j)/zs(i,j)**5+y4(i,j)/zs(i,j)**3 &amp;<a name='2043'>
                    +y5(i,j)/zs(i,j))<a name='2044'>
            pgacs(i,j)=r2ig*r2is*r9r*egs(i,j)*dd(i,j)<a name='2045'>
<font color=#447700>!JJS 1/3/06 from Steve and Chunglin<a name='2046'></font>
            if (ihail.eq.1) then<a name='2047'>
               dgacs(i,j)=pgacs(i,j)<a name='2048'>
            else<a name='2049'>
               dgacs(i,j)=0.<a name='2050'>
            endif<a name='2051'>
<font color=#447700>!JJS 1/3/06 from Steve and Chunglin<a name='2052'></font>
            wgacs(i,j)=r2ig*r2is*r9r*dd(i,j)<a name='2053'>
<font color=#447700>!            WGACS(I,J)=0.  ! 6/15/02 tao's<a name='2054'></font>
            y1(i,j)=1./zg(i,j)**bg3<a name='2055'>
<a name='2056'>
            if(ihail .eq. 1) then<a name='2057'>
               dgacw(i,j)=r2ig*max(r14r*qc(i,j)*y1(i,j), 0.0)<a name='2058'>
            else<a name='2059'>
               dgacw(i,j)=r2ig*max(r14f*qc(i,j)*y1(i,j), 0.0)<a name='2060'>
            endif<a name='2061'>
<a name='2062'>
            qgacw(i,j)=dgacw(i,j)<a name='2063'>
            y1(i,j)=abs(vg(i,j)-vr(i,j))<a name='2064'>
            y2(i,j)=zr(i,j)*zg(i,j)<a name='2065'>
            y3(i,j)=5./y2(i,j)<a name='2066'>
            y4(i,j)=.08*y3(i,j)*y3(i,j)<a name='2067'>
            y5(i,j)=.05*y3(i,j)*y4(i,j)<a name='2068'>
            dd(i,j)=r16r*y1(i,j)*(y3(i,j)/zr(i,j)**5+y4(i,j)/zr(i,j)**3 &amp;<a name='2069'>
                    +y5(i,j)/zr(i,j))<a name='2070'>
            dgacr(i,j)=r2ig*max(dd(i,j), 0.0)<a name='2071'>
            qgacr(i,j)=dgacr(i,j)<a name='2072'>
<a name='2073'>
            if (tair(i,j).ge.t0) then<a name='2074'>
               dgacs(i,j)=0.0<a name='2075'>
               wgacs(i,j)=0.0<a name='2076'>
               dgacw(i,j)=0.0<a name='2077'>
               dgacr(i,j)=0.0<a name='2078'>
            else<a name='2079'>
               pgacs(i,j)=0.0<a name='2080'>
               qgacw(i,j)=0.0<a name='2081'>
               qgacr(i,j)=0.0<a name='2082'>
            endif<a name='2083'>
<a name='2084'>
<font color=#447700>!*******PGDRY : DGACW+DGACI+DGACR+DGACS                           ******<a name='2085'></font>
<font color=#447700>!* 15 * DGACI : ACCRETION OF QI BY QG (WGACI FOR WET GROWTH)      **15**<a name='2086'></font>
<font color=#447700>!* 17 * PGWET : WET GROWTH OF QG                                  **17**<a name='2087'></font>
<a name='2088'>
            dgaci(i,j)=0.0<a name='2089'>
            wgaci(i,j)=0.0<a name='2090'>
            pgwet(i,j)=0.0<a name='2091'>
<a name='2092'>
            if (tair(i,j).lt.t0) then<a name='2093'>
               y1(i,j)=qi(i,j)/zg(i,j)**bg3<a name='2094'>
               if (ihail.eq.1) then<a name='2095'>
                  dgaci(i,j)=r2ig*r15r*y1(i,j)<a name='2096'>
                  wgaci(i,j)=r2ig*r15ar*y1(i,j)<a name='2097'>
<font color=#447700>!                  WGACI(I,J)=0.  ! 6/15/02 tao's<a name='2098'></font>
               else<a name='2099'>
<a name='2100'>
<font color=#447700>!JJS                  DGACI(I,J)=r2ig*R15F*Y1(I,J)<a name='2101'></font>
                   dgaci(i,j)=0.<a name='2102'>
                  wgaci(i,j)=r2ig*r15af*y1(i,j)<a name='2103'>
<font color=#447700>!                  WGACI(I,J)=0.  ! 6/15/02 tao's<a name='2104'></font>
               endif<a name='2105'>
<font color=#447700>!<a name='2106'></font>
               if (tairc(i,j).ge.-50.) then<a name='2107'>
                if (alf+rn17c*tairc(i,j) .eq. 0.) then<a name='2108'>
                   write(91,*) itimestep, i,j,k, alf, rn17c, tairc(i,j)<a name='2109'>
                endif<a name='2110'>
                y1(i,j)=1./(alf+rn17c*tairc(i,j))<a name='2111'>
                if (ihail.eq.1) then<a name='2112'>
                   y3(i,j)=.78/zg(i,j)**2+r17aq*scv(i,j)/zg(i,j)**bgh5<a name='2113'>
                else<a name='2114'>
                   y3(i,j)=.78/zg(i,j)**2+r17as*scv(i,j)/zg(i,j)**bgh5<a name='2115'>
                endif<a name='2116'>
                y4(i,j)=alvr*dwv(i,j)*(rp0-(qv(i,j)+qb0)) &amp;<a name='2117'>
                        -tca(i,j)*tairc(i,j)<a name='2118'>
                dd(i,j)=y1(i,j)*(r17r*y4(i,j)*y3(i,j) &amp;<a name='2119'>
                       +(wgaci(i,j)+wgacs(i,j))*(alf+rn17b*tairc(i,j)))<a name='2120'>
                pgwet(i,j)=r2ig*max(dd(i,j), 0.0)<a name='2121'>
               endif<a name='2122'>
            endif<a name='2123'>
<font color=#447700>!JJS  125    CONTINUE<a name='2124'></font>
<a name='2125'>
<font color=#447700>!********   HANDLING THE NEGATIVE CLOUD WATER (QC)    ******************<a name='2126'></font>
<font color=#447700>!********   HANDLING THE NEGATIVE CLOUD ICE (QI)      ******************<a name='2127'></font>
<a name='2128'>
<font color=#447700>!JJS         DO 150 J=3,JLES<a name='2129'></font>
<font color=#447700>!JJS         DO 150 I=3,ILES<a name='2130'></font>
<a name='2131'>
            y1(i,j)=qc(i,j)/d2t<a name='2132'>
            psacw(i,j)=min(y1(i,j), psacw(i,j))<a name='2133'>
            praut(i,j)=min(y1(i,j), praut(i,j))<a name='2134'>
            pracw(i,j)=min(y1(i,j), pracw(i,j))<a name='2135'>
            psfw(i,j)= min(y1(i,j), psfw(i,j))<a name='2136'>
            dgacw(i,j)=min(y1(i,j), dgacw(i,j))<a name='2137'>
            qsacw(i,j)=min(y1(i,j), qsacw(i,j))<a name='2138'>
            qgacw(i,j)=min(y1(i,j), qgacw(i,j))<a name='2139'>
<a name='2140'>
            y1(i,j)=(psacw(i,j)+praut(i,j)+pracw(i,j)+psfw(i,j) &amp;<a name='2141'>
                    +dgacw(i,j)+qsacw(i,j)+qgacw(i,j))*d2t<a name='2142'>
            qc(i,j)=qc(i,j)-y1(i,j)<a name='2143'>
<a name='2144'>
            if (qc(i,j) .lt. 0.0) then<a name='2145'>
               a1=1.<a name='2146'>
               if (y1(i,j) .ne. 0.0) a1=qc(i,j)/y1(i,j)+1.<a name='2147'>
               psacw(i,j)=psacw(i,j)*a1<a name='2148'>
               praut(i,j)=praut(i,j)*a1<a name='2149'>
               pracw(i,j)=pracw(i,j)*a1<a name='2150'>
               psfw(i,j)=psfw(i,j)*a1<a name='2151'>
               dgacw(i,j)=dgacw(i,j)*a1<a name='2152'>
               qsacw(i,j)=qsacw(i,j)*a1<a name='2153'>
               qgacw(i,j)=qgacw(i,j)*a1<a name='2154'>
               qc(i,j)=0.0<a name='2155'>
            endif<a name='2156'>
<font color=#447700>!c<a name='2157'></font>
<font color=#447700>!<a name='2158'></font>
<font color=#447700>!******** SHED PROCESS (WGACR=PGWET-DGACW-WGACI-WGACS)<a name='2159'></font>
<font color=#447700>!c<a name='2160'></font>
            wgacr(i,j)=pgwet(i,j)-dgacw(i,j)-wgaci(i,j)-wgacs(i,j)<a name='2161'>
            y2(i,j)=dgacw(i,j)+dgaci(i,j)+dgacr(i,j)+dgacs(i,j)<a name='2162'>
            if (pgwet(i,j).ge.y2(i,j)) then<a name='2163'>
               wgacr(i,j)=0.0<a name='2164'>
               wgaci(i,j)=0.0<a name='2165'>
               wgacs(i,j)=0.0<a name='2166'>
            else<a name='2167'>
               dgacr(i,j)=0.0<a name='2168'>
               dgaci(i,j)=0.0<a name='2169'>
               dgacs(i,j)=0.0<a name='2170'>
            endif<a name='2171'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2172'></font>
<font color=#447700>!c<a name='2173'></font>
            y1(i,j)=qi(i,j)/d2t<a name='2174'>
            psaut(i,j)=min(y1(i,j), psaut(i,j))<a name='2175'>
            psaci(i,j)=min(y1(i,j), psaci(i,j))<a name='2176'>
            praci(i,j)=min(y1(i,j), praci(i,j))<a name='2177'>
            psfi(i,j)= min(y1(i,j), psfi(i,j))<a name='2178'>
            dgaci(i,j)=min(y1(i,j), dgaci(i,j))<a name='2179'>
            wgaci(i,j)=min(y1(i,j), wgaci(i,j))<a name='2180'>
<font color=#447700>!<a name='2181'></font>
            y2(i,j)=(psaut(i,j)+psaci(i,j)+praci(i,j)+psfi(i,j) &amp;<a name='2182'>
                   +dgaci(i,j)+wgaci(i,j))*d2t<a name='2183'>
            qi(i,j)=qi(i,j)-y2(i,j)+pidep(i,j)*d2t<a name='2184'>
<a name='2185'>
            if (qi(i,j).lt.0.0) then<a name='2186'>
               a2=1.<a name='2187'>
               if (y2(i,j) .ne. 0.0) a2=qi(i,j)/y2(i,j)+1.<a name='2188'>
               psaut(i,j)=psaut(i,j)*a2<a name='2189'>
               psaci(i,j)=psaci(i,j)*a2<a name='2190'>
               praci(i,j)=praci(i,j)*a2<a name='2191'>
               psfi(i,j)=psfi(i,j)*a2<a name='2192'>
               dgaci(i,j)=dgaci(i,j)*a2<a name='2193'>
               wgaci(i,j)=wgaci(i,j)*a2<a name='2194'>
               qi(i,j)=0.0<a name='2195'>
            endif<a name='2196'>
<font color=#447700>!<a name='2197'></font>
            dlt3(i,j)=0.0<a name='2198'>
            dlt2(i,j)=0.0<a name='2199'>
<font color=#447700>!<a name='2200'></font>
<a name='2201'>
<font color=#447700>!            DLT4(I,J)=1.0<a name='2202'></font>
<font color=#447700>!            if(qc(i,j) .gt. 5.e-4) dlt4(i,j)=0.0<a name='2203'></font>
<font color=#447700>!            if(qs(i,j) .le. 1.e-4) dlt4(i,j)=1.0<a name='2204'></font>
<font color=#447700>!<a name='2205'></font>
<font color=#447700>!            IF (TAIR(I,J).ge.T0) THEN<a name='2206'></font>
<font color=#447700>!               DLT4(I,J)=0.0<a name='2207'></font>
<font color=#447700>!            ENDIF<a name='2208'></font>
<a name='2209'>
            if (tair(i,j).lt.t0) then<a name='2210'>
               if (qr(i,j).lt.1.e-4) then<a name='2211'>
                  dlt3(i,j)=1.0<a name='2212'>
                  dlt2(i,j)=1.0<a name='2213'>
               endif<a name='2214'>
               if (qs(i,j).ge.1.e-4) then<a name='2215'>
                  dlt2(i,j)=0.0<a name='2216'>
               endif<a name='2217'>
            endif<a name='2218'>
<a name='2219'>
            if (ice2 .eq. 1) then<a name='2220'>
                  dlt3(i,j)=1.0<a name='2221'>
                  dlt2(i,j)=1.0<a name='2222'>
            endif<a name='2223'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2224'></font>
            pr(i,j)=(qsacw(i,j)+praut(i,j)+pracw(i,j)+qgacw(i,j))*d2t<a name='2225'>
            ps(i,j)=(psaut(i,j)+psaci(i,j)+psacw(i,j)+psfw(i,j) &amp;<a name='2226'>
                    +psfi(i,j)+dlt3(i,j)*praci(i,j))*d2t<a name='2227'>
<font color=#447700>!           PS(I,J)=(PSAUT(I,J)+PSACI(I,J)+dlt4(i,j)*PSACW(I,J)<a name='2228'></font>
<font color=#447700>!    1              +PSFW(I,J)+PSFI(I,J)+DLT3(I,J)*PRACI(I,J))*D2T<a name='2229'></font>
            pg(i,j)=((1.-dlt3(i,j))*praci(i,j)+dgaci(i,j)+wgaci(i,j) &amp;<a name='2230'>
                    +dgacw(i,j))*d2t<a name='2231'>
<font color=#447700>!           PG(I,J)=((1.-DLT3(I,J))*PRACI(I,J)+DGACI(I,J)+WGACI(I,J)<a name='2232'></font>
<font color=#447700>!    1              +DGACW(I,J)+(1.-dlt4(i,j))*PSACW(I,J))*D2T<a name='2233'></font>
<a name='2234'>
<font color=#447700>!JJS  150    CONTINUE<a name='2235'></font>
<a name='2236'>
<font color=#447700>!*  7 * PRACS : ACCRETION OF QS BY QR                             ***7**<a name='2237'></font>
<font color=#447700>!*  8 * PSACR : ACCRETION OF QR BY QS (QSACR FOR PSMLT)           ***8**<a name='2238'></font>
<a name='2239'>
<font color=#447700>!JJS         DO 175 J=3,JLES<a name='2240'></font>
<font color=#447700>!JJS         DO 175 I=3,ILES<a name='2241'></font>
<a name='2242'>
            y1(i,j)=abs(vr(i,j)-vs(i,j))<a name='2243'>
            y2(i,j)=zr(i,j)*zs(i,j)<a name='2244'>
            y3(i,j)=5./y2(i,j)<a name='2245'>
            y4(i,j)=.08*y3(i,j)*y3(i,j)<a name='2246'>
            y5(i,j)=.05*y3(i,j)*y4(i,j)<a name='2247'>
            pracs(i,j)=r2ig*r2is*r7r*y1(i,j)*(y3(i,j)/zs(i,j)**5 &amp;<a name='2248'>
                      +y4(i,j)/zs(i,j)**3+y5(i,j)/zs(i,j))<a name='2249'>
            psacr(i,j)=r2is*r8r*y1(i,j)*(y3(i,j)/zr(i,j)**5 &amp;<a name='2250'>
                      +y4(i,j)/zr(i,j)**3+y5(i,j)/zr(i,j))<a name='2251'>
            qsacr(i,j)=psacr(i,j)<a name='2252'>
<a name='2253'>
            if (tair(i,j).ge.t0) then<a name='2254'>
               pracs(i,j)=0.0<a name='2255'>
               psacr(i,j)=0.0<a name='2256'>
            else<a name='2257'>
               qsacr(i,j)=0.0<a name='2258'>
            endif<a name='2259'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2260'></font>
<font color=#447700>!*  2 * PGAUT : AUTOCONVERSION OF QS TO QG                        ***2**<a name='2261'></font>
<font color=#447700>!* 18 * PGFR : FREEZING OF QR TO QG                               **18**<a name='2262'></font>
<a name='2263'>
            pgaut(i,j)=0.0<a name='2264'>
            pgfr(i,j)=0.0<a name='2265'>
<a name='2266'>
            if (tair(i,j) .lt. t0) then<a name='2267'>
<font color=#447700>!               Y1(I,J)=EXP(.09*TAIRC(I,J))<a name='2268'></font>
<font color=#447700>!               PGAUT(I,J)=r2is*max(RN2*Y1(I,J)*(QS(I,J)-BND2), 0.0)<a name='2269'></font>
<font color=#447700>!         IF(IHAIL.EQ.1) PGAUT(I,J)=max(RN2*Y1(I,J)*(QS(I,J)-BND2),0.0)<a name='2270'></font>
               y2(i,j)=exp(rn18a*(t0-tair(i,j)))<a name='2271'>
<font color=#447700>!JJS              PGFR(I,J)=r2ig*max(R18R*(Y2(I,J)-1.)/ZR(I,J)**7., 0.0)<a name='2272'></font>
<font color=#447700>!              pgfr(i,j)=r2ice*max(r18r*(y2(i,j)-1.)* &amp;<a name='2273'></font>
<font color=#447700>!                                    (zr(i,j)**(-7.)), 0.0)<a name='2274'></font>
<font color=#447700>!        modify to prevent underflow on some computers (JD)<a name='2275'></font>
               temp = 1./zr(i,j)<a name='2276'>
               temp = temp*temp*temp*temp*temp*temp*temp<a name='2277'>
               pgfr(i,j)=r2ig*max(r18r*(y2(i,j)-1.)* &amp;<a name='2278'>
                                    temp, 0.0)<a name='2279'>
            endif<a name='2280'>
<a name='2281'>
<font color=#447700>!JJS  175    CONTINUE<a name='2282'></font>
<a name='2283'>
<font color=#447700>!********   HANDLING THE NEGATIVE RAIN WATER (QR)    *******************<a name='2284'></font>
<font color=#447700>!********   HANDLING THE NEGATIVE SNOW (QS)          *******************<a name='2285'></font>
<a name='2286'>
<font color=#447700>!JJS         DO 200 J=3,JLES<a name='2287'></font>
<font color=#447700>!JJS         DO 200 I=3,ILES<a name='2288'></font>
<a name='2289'>
            y1(i,j)=qr(i,j)/d2t<a name='2290'>
            y2(i,j)=-qg(i,j)/d2t<a name='2291'>
            piacr(i,j)=min(y1(i,j), piacr(i,j))<a name='2292'>
            dgacr(i,j)=min(y1(i,j), dgacr(i,j))<a name='2293'>
            wgacr(i,j)=min(y1(i,j), wgacr(i,j))<a name='2294'>
            wgacr(i,j)=max(y2(i,j), wgacr(i,j))<a name='2295'>
            psacr(i,j)=min(y1(i,j), psacr(i,j))<a name='2296'>
            pgfr(i,j)= min(y1(i,j), pgfr(i,j))<a name='2297'>
            del=0.<a name='2298'>
            if(wgacr(i,j) .lt. 0.) del=1.<a name='2299'>
            y1(i,j)=(piacr(i,j)+dgacr(i,j)+(1.-del)*wgacr(i,j) &amp;<a name='2300'>
                    +psacr(i,j)+pgfr(i,j))*d2t<a name='2301'>
            qr(i,j)=qr(i,j)+pr(i,j)-y1(i,j)-del*wgacr(i,j)*d2t<a name='2302'>
            if (qr(i,j) .lt. 0.0) then<a name='2303'>
               a1=1.<a name='2304'>
               if(y1(i,j) .ne. 0.) a1=qr(i,j)/y1(i,j)+1.<a name='2305'>
               piacr(i,j)=piacr(i,j)*a1<a name='2306'>
               dgacr(i,j)=dgacr(i,j)*a1<a name='2307'>
               if (wgacr(i,j).gt.0.) wgacr(i,j)=wgacr(i,j)*a1<a name='2308'>
               pgfr(i,j)=pgfr(i,j)*a1<a name='2309'>
               psacr(i,j)=psacr(i,j)*a1<a name='2310'>
               qr(i,j)=0.0<a name='2311'>
            endif<a name='2312'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2313'></font>
            prn(i,j)=d2t*((1.-dlt3(i,j))*piacr(i,j)+dgacr(i,j) &amp;<a name='2314'>
                     +wgacr(i,j)+(1.-dlt2(i,j))*psacr(i,j)+pgfr(i,j))<a name='2315'>
            ps(i,j)=ps(i,j)+d2t*(dlt3(i,j)*piacr(i,j) &amp;<a name='2316'>
                    +dlt2(i,j)*psacr(i,j))<a name='2317'>
            pracs(i,j)=(1.-dlt2(i,j))*pracs(i,j)<a name='2318'>
            y1(i,j)=qs(i,j)/d2t<a name='2319'>
            pgacs(i,j)=min(y1(i,j), pgacs(i,j))<a name='2320'>
            dgacs(i,j)=min(y1(i,j), dgacs(i,j))<a name='2321'>
            wgacs(i,j)=min(y1(i,j), wgacs(i,j))<a name='2322'>
            pgaut(i,j)=min(y1(i,j), pgaut(i,j))<a name='2323'>
            pracs(i,j)=min(y1(i,j), pracs(i,j))<a name='2324'>
            psn(i,j)=d2t*(pgacs(i,j)+dgacs(i,j)+wgacs(i,j) &amp;<a name='2325'>
                     +pgaut(i,j)+pracs(i,j))<a name='2326'>
            qs(i,j)=qs(i,j)+ps(i,j)-psn(i,j)<a name='2327'>
<a name='2328'>
            if (qs(i,j).lt.0.0) then<a name='2329'>
               a2=1.<a name='2330'>
               if (psn(i,j) .ne. 0.0) a2=qs(i,j)/psn(i,j)+1.<a name='2331'>
               pgacs(i,j)=pgacs(i,j)*a2<a name='2332'>
               dgacs(i,j)=dgacs(i,j)*a2<a name='2333'>
               wgacs(i,j)=wgacs(i,j)*a2<a name='2334'>
               pgaut(i,j)=pgaut(i,j)*a2<a name='2335'>
               pracs(i,j)=pracs(i,j)*a2<a name='2336'>
               psn(i,j)=psn(i,j)*a2<a name='2337'>
               qs(i,j)=0.0<a name='2338'>
            endif<a name='2339'>
<font color=#447700>!<a name='2340'></font>
<font color=#447700>!C           PSN(I,J)=D2T*(PGACS(I,J)+DGACS(I,J)+WGACS(I,J)<a name='2341'></font>
<font color=#447700>!c                    +PGAUT(I,J)+PRACS(I,J))<a name='2342'></font>
            y2(i,j)=d2t*(psacw(i,j)+psfw(i,j)+dgacw(i,j)+piacr(i,j) &amp;<a name='2343'>
                    +dgacr(i,j)+wgacr(i,j)+psacr(i,j)+pgfr(i,j))<a name='2344'>
            pt(i,j)=pt(i,j)+afcp*y2(i,j)<a name='2345'>
            qg(i,j)=qg(i,j)+pg(i,j)+prn(i,j)+psn(i,j)<a name='2346'>
<a name='2347'>
<font color=#447700>!JJS  200    CONTINUE<a name='2348'></font>
<a name='2349'>
<font color=#447700>!* 11 * PSMLT : MELTING OF QS                                     **11**<a name='2350'></font>
<font color=#447700>!* 19 * PGMLT : MELTING OF QG TO QR                               **19**<a name='2351'></font>
<a name='2352'>
<font color=#447700>!JJS         DO 225 J=3,JLES<a name='2353'></font>
<font color=#447700>!JJS         DO 225 I=3,ILES<a name='2354'></font>
<a name='2355'>
            psmlt(i,j)=0.0<a name='2356'>
            pgmlt(i,j)=0.0<a name='2357'>
            tair(i,j)=(pt(i,j)+tb0)*pi0<a name='2358'>
<a name='2359'>
            if (tair(i,j).ge.t0) then<a name='2360'>
               tairc(i,j)=tair(i,j)-t0<a name='2361'>
               y1(i,j)=tca(i,j)*tairc(i,j)-alvr*dwv(i,j) &amp;<a name='2362'>
                               *(rp0-(qv(i,j)+qb0))<a name='2363'>
               y2(i,j)=.78/zs(i,j)**2+r101f*scv(i,j)/zs(i,j)**bsh5<a name='2364'>
               dd(i,j)=r11rt*y1(i,j)*y2(i,j)+r11at*tairc(i,j) &amp;<a name='2365'>
                       *(qsacw(i,j)+qsacr(i,j))<a name='2366'>
               psmlt(i,j)=r2is*max(0.0, min(dd(i,j), qs(i,j)))<a name='2367'>
<a name='2368'>
               if(ihail.eq.1) then<a name='2369'>
                  y3(i,j)=.78/zg(i,j)**2+r19aq*scv(i,j)/zg(i,j)**bgh5<a name='2370'>
               else<a name='2371'>
                  y3(i,j)=.78/zg(i,j)**2+r19as*scv(i,j)/zg(i,j)**bgh5<a name='2372'>
               endif<a name='2373'>
<a name='2374'>
               dd1(i,j)=r19rt*y1(i,j)*y3(i,j)+r19bt*tairc(i,j) &amp;<a name='2375'>
                        *(qgacw(i,j)+qgacr(i,j))<a name='2376'>
               pgmlt(i,j)=r2ig*max(0.0, min(dd1(i,j), qg(i,j)))<a name='2377'>
               pt(i,j)=pt(i,j)-afcp*(psmlt(i,j)+pgmlt(i,j))<a name='2378'>
               qr(i,j)=qr(i,j)+psmlt(i,j)+pgmlt(i,j)<a name='2379'>
               qs(i,j)=qs(i,j)-psmlt(i,j)<a name='2380'>
               qg(i,j)=qg(i,j)-pgmlt(i,j)<a name='2381'>
            endif<a name='2382'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2383'></font>
<font color=#447700>!* 24 * PIHOM : HOMOGENEOUS FREEZING OF QC TO QI (T &lt; T00)        **24**<a name='2384'></font>
<font color=#447700>!* 25 * PIDW : DEPOSITION GROWTH OF QC TO QI ( T0 &lt; T &lt;= T00)     **25**<a name='2385'></font>
<font color=#447700>!* 26 * PIMLT : MELTING OF QI TO QC (T &gt;= T0)                     **26**<a name='2386'></font>
<a name='2387'>
            if (qc(i,j).le.cmin1) qc(i,j)=0.0<a name='2388'>
            if (qi(i,j).le.cmin1) qi(i,j)=0.0<a name='2389'>
            tair(i,j)=(pt(i,j)+tb0)*pi0<a name='2390'>
<a name='2391'>
            if(tair(i,j).le.t00) then<a name='2392'>
               pihom(i,j)=qc(i,j)<a name='2393'>
            else<a name='2394'>
               pihom(i,j)=0.0<a name='2395'>
            endif<a name='2396'>
            if(tair(i,j).ge.t0) then<a name='2397'>
               pimlt(i,j)=qi(i,j)<a name='2398'>
            else<a name='2399'>
               pimlt(i,j)=0.0<a name='2400'>
            endif<a name='2401'>
            pidw(i,j)=0.0<a name='2402'>
<a name='2403'>
            if (tair(i,j).lt.t0 .and. tair(i,j).gt.t00) then<a name='2404'>
               tairc(i,j)=tair(i,j)-t0<a name='2405'>
               y1(i,j)=max( min(tairc(i,j), -1.), -31.)<a name='2406'>
               it(i,j)=int(abs(y1(i,j)))<a name='2407'>
               y2(i,j)=aa1(it(i,j))<a name='2408'>
               y3(i,j)=aa2(it(i,j))<a name='2409'>
               y4(i,j)=exp(abs(beta*tairc(i,j)))<a name='2410'>
               y5(i,j)=(r00*qi(i,j)/(r25a*y4(i,j)))**y3(i,j)<a name='2411'>
               pidw(i,j)=min(r25rt*y2(i,j)*y4(i,j)*y5(i,j), qc(i,j))<a name='2412'>
            endif<a name='2413'>
<a name='2414'>
            y1(i,j)=pihom(i,j)-pimlt(i,j)+pidw(i,j)<a name='2415'>
            pt(i,j)=pt(i,j)+afcp*y1(i,j)+ascp*(pidep(i,j))*d2t<a name='2416'>
            qv(i,j)=qv(i,j)-(pidep(i,j))*d2t<a name='2417'>
            qc(i,j)=qc(i,j)-y1(i,j)<a name='2418'>
            qi(i,j)=qi(i,j)+y1(i,j)<a name='2419'>
<a name='2420'>
<font color=#447700>!* 31 * PINT  : INITIATION OF QI                                  **31**<a name='2421'></font>
<font color=#447700>!* 32 * PIDEP : DEPOSITION OF QI                                  **32**<a name='2422'></font>
<font color=#447700>!<a name='2423'></font>
<font color=#447700>!     CALCULATION OF PINT USES DIFFERENT VALUES OF THE INTERCEPT AND SLOPE FOR<a name='2424'></font>
<font color=#447700>!     THE FLETCHER EQUATION. ALSO, ONLY INITIATE MORE ICE IF THE NEW NUMBER<a name='2425'></font>
<font color=#447700>!     CONCENTRATION EXCEEDS THAT ALREADY PRESENT.<a name='2426'></font>
<font color=#447700>!* 31 * pint  : initiation of qi                                  **31**<a name='2427'></font>
<font color=#447700>!* 32 * pidep : deposition of qi                                  **32**<a name='2428'></font>
           pint(i,j)=0.0<a name='2429'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2430'></font>
        if ( itaobraun.eq.1 ) then<a name='2431'>
            tair(i,j)=(pt(i,j)+tb0)*pi0<a name='2432'>
            if (tair(i,j) .lt. t0) then<a name='2433'>
<font color=#447700>!             if (qi(i,j) .le. cmin) qi(i,j)=0.<a name='2434'></font>
              if (qi(i,j) .le. cmin2) qi(i,j)=0.<a name='2435'>
               tairc(i,j)=tair(i,j)-t0<a name='2436'>
               rtair(i,j)=1./(tair(i,j)-c76)<a name='2437'>
               y2(i,j)=exp(c218-c580*rtair(i,j))<a name='2438'>
              qsi(i,j)=rp0*y2(i,j)<a name='2439'>
               esi(i,j)=c610*y2(i,j)<a name='2440'>
              ssi(i,j)=(qv(i,j)+qb0)/qsi(i,j)-1.<a name='2441'>
                        ami50=3.76e-8<a name='2442'>
<a name='2443'>
<font color=#447700>!ccif ( itaobraun.eq.1 ) --&gt; betah=0.5*beta=-.46*0.5=-0.23;   cn0=1.e-6<a name='2444'></font>
<font color=#447700>!ccif ( itaobraun.eq.0 ) --&gt; betah=0.5*beta=-.6*0.5=-0.30;    cn0=1.e-8<a name='2445'></font>
<a name='2446'>
             y1(i,j)=1./tair(i,j)<a name='2447'>
<a name='2448'>
<font color=#447700>!cc insert a restriction on ice collection that ice collection<a name='2449'></font>
<font color=#447700>!cc should be stopped at -30 c (with cn0=1.e-6, beta=-.46)<a name='2450'></font>
<a name='2451'>
             tairccri=tairc(i,j)          <font color=#447700>! in degree c<a name='2452'></font>
             if(tairccri.le.-30.) tairccri=-30.<a name='2453'>
<a name='2454'>
<font color=#447700>!            y2(i,j)=exp(betah*tairc(i,j))<a name='2455'></font>
             y2(i,j)=exp(betah*tairccri)<a name='2456'>
             y3(i,j)=sqrt(qi(i,j))<a name='2457'>
             dd(i,j)=y1(i,j)*(rn10a*y1(i,j)-rn10b)+rn10c*tair(i,j) &amp;<a name='2458'>
                                                /esi(i,j)<a name='2459'>
          pidep(i,j)=max(r32rt*ssi(i,j)*y2(i,j)*y3(i,j)/dd(i,j), 0.e0)<a name='2460'>
<a name='2461'>
           r_nci=min(cn0*exp(beta*tairc(i,j)),1.)<a name='2462'>
<font color=#447700>!          r_nci=min(1.e-6*exp(-.46*tairc(i,j)),1.)<a name='2463'></font>
<a name='2464'>
           dd(i,j)=max(1.e-9*r_nci/r00-qi(i,j)*1.e-9/ami50, 0.)<a name='2465'>
                dm(i,j)=max( (qv(i,j)+qb0-qsi(i,j)), 0.0)<a name='2466'>
                rsub1(i,j)=cs580*qsi(i,j)*rtair(i,j)*rtair(i,j)<a name='2467'>
              dep(i,j)=dm(i,j)/(1.+rsub1(i,j))<a name='2468'>
              pint(i,j)=max(min(dd(i,j), dm(i,j)), 0.)<a name='2469'>
<a name='2470'>
<font color=#447700>!             pint(i,j)=min(pint(i,j), dep(i,j))<a name='2471'></font>
              pint(i,j)=min(pint(i,j)+pidep(i,j), dep(i,j))<a name='2472'>
<a name='2473'>
<font color=#447700>!              if (pint(i,j) .le. cmin) pint(i,j)=0.<a name='2474'></font>
               if (pint(i,j) .le. cmin2) pint(i,j)=0.<a name='2475'>
              pt(i,j)=pt(i,j)+ascp*pint(i,j)<a name='2476'>
              qv(i,j)=qv(i,j)-pint(i,j)<a name='2477'>
              qi(i,j)=qi(i,j)+pint(i,j)<a name='2478'>
           endif<a name='2479'>
        endif  <font color=#447700>! if ( itaobraun.eq.1 )<a name='2480'></font>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2481'></font>
<font color=#447700>!<a name='2482'></font>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2483'></font>
        if ( itaobraun.eq.0 ) then<a name='2484'>
             tair(i,j)=(pt(i,j)+tb0)*pi0<a name='2485'>
             if (tair(i,j) .lt. t0) then<a name='2486'>
               if (qi(i,j) .le. cmin1) qi(i,j)=0.<a name='2487'>
               tairc(i,j)=tair(i,j)-t0<a name='2488'>
               dd(i,j)=r31r*exp(beta*tairc(i,j))<a name='2489'>
               rtair(i,j)=1./(tair(i,j)-c76)<a name='2490'>
               y2(i,j)=exp(c218-c580*rtair(i,j))<a name='2491'>
               qsi(i,j)=rp0*y2(i,j)<a name='2492'>
               esi(i,j)=c610*y2(i,j)<a name='2493'>
               ssi(i,j)=(qv(i,j)+qb0)/qsi(i,j)-1.<a name='2494'>
               dm(i,j)=max( (qv(i,j)+qb0-qsi(i,j)), 0.)<a name='2495'>
               rsub1(i,j)=cs580*qsi(i,j)*rtair(i,j)*rtair(i,j)<a name='2496'>
               dep(i,j)=dm(i,j)/(1.+rsub1(i,j))<a name='2497'>
              pint(i,j)=max(min(dd(i,j), dm(i,j)), 0.)<a name='2498'>
               y1(i,j)=1./tair(i,j)<a name='2499'>
               y2(i,j)=exp(betah*tairc(i,j))<a name='2500'>
               y3(i,j)=sqrt(qi(i,j))<a name='2501'>
               dd(i,j)=y1(i,j)*(rn10a*y1(i,j)-rn10b) &amp;<a name='2502'>
                     +rn10c*tair(i,j)/esi(i,j)<a name='2503'>
             pidep(i,j)=max(r32rt*ssi(i,j)*y2(i,j)*y3(i,j)/dd(i,j), 0.)<a name='2504'>
              pint(i,j)=pint(i,j)+pidep(i,j)<a name='2505'>
              pint(i,j)=min(pint(i,j),dep(i,j))<a name='2506'>
<font color=#447700>!c          if (pint(i,j) .le. cmin2) pint(i,j)=0.<a name='2507'></font>
             pt(i,j)=pt(i,j)+ascp*pint(i,j)<a name='2508'>
             qv(i,j)=qv(i,j)-pint(i,j)<a name='2509'>
             qi(i,j)=qi(i,j)+pint(i,j)<a name='2510'>
            endif<a name='2511'>
        endif  <font color=#447700>! if ( itaobraun.eq.0 )<a name='2512'></font>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2513'></font>
<a name='2514'>
<font color=#447700>!JJS  225    CONTINUE<a name='2515'></font>
<a name='2516'>
<font color=#447700>!*****   TAO ET AL (1989) SATURATION TECHNIQUE  ***********************<a name='2517'></font>
<a name='2518'>
         if (new_ice_sat .eq. 0) then<a name='2519'>
<a name='2520'>
<font color=#447700>!JJS            DO 250 J=3,JLES<a name='2521'></font>
<font color=#447700>!JJS            DO 250 I=3,ILES<a name='2522'></font>
               tair(i,j)=(pt(i,j)+tb0)*pi0<a name='2523'>
               cnd(i,j)=rt0*(tair(i,j)-t00)<a name='2524'>
               dep(i,j)=rt0*(t0-tair(i,j))<a name='2525'>
               y1(i,j)=1./(tair(i,j)-c358)<a name='2526'>
               y2(i,j)=1./(tair(i,j)-c76)<a name='2527'>
               qsw(i,j)=rp0*exp(c172-c409*y1(i,j))<a name='2528'>
               qsi(i,j)=rp0*exp(c218-c580*y2(i,j))<a name='2529'>
               dd(i,j)=cp409*y1(i,j)*y1(i,j)<a name='2530'>
               dd1(i,j)=cp580*y2(i,j)*y2(i,j)<a name='2531'>
               if (qc(i,j).le.cmin) qc(i,j)=cmin<a name='2532'>
               if (qi(i,j).le.cmin) qi(i,j)=cmin<a name='2533'>
               if (tair(i,j).ge.t0) then<a name='2534'>
                  dep(i,j)=0.0<a name='2535'>
                  cnd(i,j)=1.<a name='2536'>
                  qi(i,j)=0.0<a name='2537'>
               endif<a name='2538'>
<a name='2539'>
               if (tair(i,j).lt.t00) then<a name='2540'>
                  cnd(i,j)=0.0<a name='2541'>
                  dep(i,j)=1.<a name='2542'>
                  qc(i,j)=0.0<a name='2543'>
               endif<a name='2544'>
<a name='2545'>
               y5(i,j)=avcp*cnd(i,j)+ascp*dep(i,j)<a name='2546'>
<font color=#447700>!               if (qc(i,j) .ge. cmin .or. qi(i,j) .ge. cmin) then<a name='2547'></font>
               y1(i,j)=qc(i,j)*qsw(i,j)/(qc(i,j)+qi(i,j))<a name='2548'>
               y2(i,j)=qi(i,j)*qsi(i,j)/(qc(i,j)+qi(i,j))<a name='2549'>
               y4(i,j)=dd(i,j)*y1(i,j)+dd1(i,j)*y2(i,j)<a name='2550'>
               qvs(i,j)=y1(i,j)+y2(i,j)<a name='2551'>
               rsub1(i,j)=(qv(i,j)+qb0-qvs(i,j))/(1.+y4(i,j)*y5(i,j))<a name='2552'>
               cnd(i,j)=cnd(i,j)*rsub1(i,j)<a name='2553'>
               dep(i,j)=dep(i,j)*rsub1(i,j)<a name='2554'>
               if (qc(i,j).le.cmin) qc(i,j)=0.<a name='2555'>
               if (qi(i,j).le.cmin) qi(i,j)=0.<a name='2556'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2557'></font>
<font color=#447700>!c    ******   condensation or evaporation of qc  ******<a name='2558'></font>
<a name='2559'>
               cnd(i,j)=max(-qc(i,j),cnd(i,j))<a name='2560'>
<a name='2561'>
<font color=#447700>!c    ******   deposition or sublimation of qi    ******<a name='2562'></font>
<a name='2563'>
               dep(i,j)=max(-qi(i,j),dep(i,j))<a name='2564'>
<a name='2565'>
               pt(i,j)=pt(i,j)+avcp*cnd(i,j)+ascp*dep(i,j)<a name='2566'>
               qv(i,j)=qv(i,j)-cnd(i,j)-dep(i,j)<a name='2567'>
               qc(i,j)=qc(i,j)+cnd(i,j)<a name='2568'>
               qi(i,j)=qi(i,j)+dep(i,j)<a name='2569'>
<font color=#447700>!JJS  250       continue<a name='2570'></font>
         endif<a name='2571'>
<a name='2572'>
         if (new_ice_sat .eq. 1) then<a name='2573'>
<a name='2574'>
<font color=#447700>!JJS            DO J=3,JLES<a name='2575'></font>
<font color=#447700>!JJS            DO I=3,ILES<a name='2576'></font>
<a name='2577'>
               tair(i,j)=(pt(i,j)+tb0)*pi0<a name='2578'>
               cnd(i,j)=rt0*(tair(i,j)-t00)<a name='2579'>
               dep(i,j)=rt0*(t0-tair(i,j))<a name='2580'>
               y1(i,j)=1./(tair(i,j)-c358)<a name='2581'>
               y2(i,j)=1./(tair(i,j)-c76)<a name='2582'>
               qsw(i,j)=rp0*exp(c172-c409*y1(i,j))<a name='2583'>
               qsi(i,j)=rp0*exp(c218-c580*y2(i,j))<a name='2584'>
               dd(i,j)=cp409*y1(i,j)*y1(i,j)<a name='2585'>
               dd1(i,j)=cp580*y2(i,j)*y2(i,j)<a name='2586'>
               y5(i,j)=avcp*cnd(i,j)+ascp*dep(i,j)<a name='2587'>
               y1(i,j)=rt0*(tair(i,j)-t00)*qsw(i,j)<a name='2588'>
               y2(i,j)=rt0*(t0-tair(i,j))*qsi(i,j)<a name='2589'>
<font color=#447700>!               IF (QC(I,J).LE.CMIN) QC(I,J)=CMIN<a name='2590'></font>
<font color=#447700>!               IF (QI(I,J).LE.CMIN) QI(I,J)=CMIN<a name='2591'></font>
<a name='2592'>
               if (tair(i,j).ge.t0) then<a name='2593'>
<font color=#447700>!                 QI(I,J)=0.0<a name='2594'></font>
                  dep(i,j)=0.0<a name='2595'>
                  cnd(i,j)=1.<a name='2596'>
                  y2(i,j)=0.<a name='2597'>
                  y1(i,j)=qsw(i,j)<a name='2598'>
               endif<a name='2599'>
               if (tair(i,j).lt.t00) then<a name='2600'>
                  cnd(i,j)=0.0<a name='2601'>
                  dep(i,j)=1.<a name='2602'>
                  y2(i,j)=qsi(i,j)<a name='2603'>
                  y1(i,j)=0.<a name='2604'>
<font color=#447700>!                 QC(I,J)=0.0<a name='2605'></font>
               endif<a name='2606'>
<a name='2607'>
<font color=#447700>!            Y1(I,J)=QC(I,J)*QSW(I,J)/(QC(I,J)+QI(I,J))<a name='2608'></font>
<font color=#447700>!            Y2(I,J)=QI(I,J)*QSI(I,J)/(QC(I,J)+QI(I,J))<a name='2609'></font>
<a name='2610'>
               y4(i,j)=dd(i,j)*y1(i,j)+dd1(i,j)*y2(i,j)<a name='2611'>
               qvs(i,j)=y1(i,j)+y2(i,j)<a name='2612'>
               rsub1(i,j)=(qv(i,j)+qb0-qvs(i,j))/(1.+y4(i,j)*y5(i,j))<a name='2613'>
               cnd(i,j)=cnd(i,j)*rsub1(i,j)<a name='2614'>
               dep(i,j)=dep(i,j)*rsub1(i,j)<a name='2615'>
<font color=#447700>!               IF (QC(I,J).LE.CMIN) QC(I,J)=0.<a name='2616'></font>
<font color=#447700>!               IF (QI(I,J).LE.CMIN) QI(I,J)=0.<a name='2617'></font>
<a name='2618'>
<font color=#447700>!C    ******   CONDENSATION OR EVAPORATION OF QC  ******<a name='2619'></font>
<a name='2620'>
               cnd(i,j)=max(-qc(i,j),cnd(i,j))<a name='2621'>
<a name='2622'>
<font color=#447700>!C    ******   DEPOSITION OR SUBLIMATION OF QI    ******<a name='2623'></font>
<a name='2624'>
               dep(i,j)=max(-qi(i,j),dep(i,j))<a name='2625'>
<a name='2626'>
               pt(i,j)=pt(i,j)+avcp*cnd(i,j)+ascp*dep(i,j)<a name='2627'>
               qv(i,j)=qv(i,j)-cnd(i,j)-dep(i,j)<a name='2628'>
               qc(i,j)=qc(i,j)+cnd(i,j)<a name='2629'>
               qi(i,j)=qi(i,j)+dep(i,j)<a name='2630'>
<font color=#447700>!JJS            ENDDO<a name='2631'></font>
<font color=#447700>!JJS            ENDDO<a name='2632'></font>
         endif<a name='2633'>
<a name='2634'>
<font color=#447700>!c<a name='2635'></font>
<font color=#447700>!<a name='2636'></font>
          if (new_ice_sat .eq. 2) then<a name='2637'>
<font color=#447700>!JJS          do j=3,jles<a name='2638'></font>
<font color=#447700>!JJS             do i=3,iles<a name='2639'></font>
          dep(i,j)=0.0<a name='2640'>
          cnd(i,j)=0.0<a name='2641'>
          tair(i,j)=(pt(i,j)+tb0)*pi0<a name='2642'>
          if (tair(i,j) .ge. 253.16) then<a name='2643'>
              y1(i,j)=1./(tair(i,j)-c358)<a name='2644'>
              qsw(i,j)=rp0*exp(c172-c409*y1(i,j))<a name='2645'>
              dd(i,j)=cp409*y1(i,j)*y1(i,j)<a name='2646'>
              dm(i,j)=qv(i,j)+qb0-qsw(i,j)<a name='2647'>
              cnd(i,j)=dm(i,j)/(1.+avcp*dd(i,j)*qsw(i,j))<a name='2648'>
<font color=#447700>!c    ******   condensation or evaporation of qc  ******<a name='2649'></font>
              cnd(i,j)=max(-qc(i,j), cnd(i,j))<a name='2650'>
             pt(i,j)=pt(i,j)+avcp*cnd(i,j)<a name='2651'>
             qv(i,j)=qv(i,j)-cnd(i,j)<a name='2652'>
             qc(i,j)=qc(i,j)+cnd(i,j)<a name='2653'>
         endif<a name='2654'>
          if (tair(i,j) .le. 258.16) then<a name='2655'>
<font color=#447700>!c             cnd(i,j)=0.0<a name='2656'></font>
           y2(i,j)=1./(tair(i,j)-c76)<a name='2657'>
           qsi(i,j)=rp0*exp(c218-c580*y2(i,j))<a name='2658'>
          dd1(i,j)=cp580*y2(i,j)*y2(i,j)<a name='2659'>
         dep(i,j)=(qv(i,j)+qb0-qsi(i,j))/(1.+ascp*dd1(i,j)*qsi(i,j))<a name='2660'>
<font color=#447700>!c    ******   deposition or sublimation of qi    ******<a name='2661'></font>
             dep(i,j)=max(-qi(i,j),dep(i,j))<a name='2662'>
             pt(i,j)=pt(i,j)+ascp*dep(i,j)<a name='2663'>
             qv(i,j)=qv(i,j)-dep(i,j)<a name='2664'>
             qi(i,j)=qi(i,j)+dep(i,j)<a name='2665'>
         endif<a name='2666'>
<font color=#447700>!JJS       enddo<a name='2667'></font>
<font color=#447700>!JJS       enddo<a name='2668'></font>
      endif<a name='2669'>
<a name='2670'>
<font color=#447700>!c<a name='2671'></font>
<font color=#447700>!<a name='2672'></font>
<font color=#447700>!* 10 * PSDEP : DEPOSITION OR SUBLIMATION OF QS                   **10**<a name='2673'></font>
<font color=#447700>!* 20 * PGSUB : SUBLIMATION OF QG                                 **20**<a name='2674'></font>
<a name='2675'>
<font color=#447700>!JJS         DO 275 J=3,JLES<a name='2676'></font>
<font color=#447700>!JJS         DO 275 I=3,ILES<a name='2677'></font>
<a name='2678'>
            psdep(i,j)=0.0<a name='2679'>
            pgdep(i,j)=0.0<a name='2680'>
            pssub(i,j)=0.0<a name='2681'>
            pgsub(i,j)=0.0<a name='2682'>
            tair(i,j)=(pt(i,j)+tb0)*pi0<a name='2683'>
<a name='2684'>
            if(tair(i,j).lt.t0) then<a name='2685'>
               if(qs(i,j).lt.cmin1) qs(i,j)=0.0<a name='2686'>
               if(qg(i,j).lt.cmin1) qg(i,j)=0.0<a name='2687'>
               rtair(i,j)=1./(tair(i,j)-c76)<a name='2688'>
               qsi(i,j)=rp0*exp(c218-c580*rtair(i,j))<a name='2689'>
               ssi(i,j)=(qv(i,j)+qb0)/qsi(i,j)-1.<a name='2690'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2691'></font>
               y1(i,j)=r10ar/(tca(i,j)*tair(i,j)**2)+1./(dwv(i,j) &amp;<a name='2692'>
                      *qsi(i,j))<a name='2693'>
               y2(i,j)=.78/zs(i,j)**2+r101f*scv(i,j)/zs(i,j)**bsh5<a name='2694'>
               psdep(i,j)=r10t*ssi(i,j)*y2(i,j)/y1(i,j)<a name='2695'>
               pssub(i,j)=psdep(i,j)<a name='2696'>
               psdep(i,j)=r2is*max(psdep(i,j), 0.)<a name='2697'>
               pssub(i,j)=r2is*max(-qs(i,j), min(pssub(i,j), 0.))<a name='2698'>
<a name='2699'>
               if(ihail.eq.1) then<a name='2700'>
                  y2(i,j)=.78/zg(i,j)**2+r20bq*scv(i,j)/zg(i,j)**bgh5<a name='2701'>
               else<a name='2702'>
                  y2(i,j)=.78/zg(i,j)**2+r20bs*scv(i,j)/zg(i,j)**bgh5<a name='2703'>
               endif<a name='2704'>
<a name='2705'>
               pgsub(i,j)=r2ig*r20t*ssi(i,j)*y2(i,j)/y1(i,j)<a name='2706'>
               dm(i,j)=qv(i,j)+qb0-qsi(i,j)<a name='2707'>
               rsub1(i,j)=cs580*qsi(i,j)*rtair(i,j)*rtair(i,j)<a name='2708'>
<a name='2709'>
<font color=#447700>!     ********   DEPOSITION OR SUBLIMATION OF QS  **********************<a name='2710'></font>
<a name='2711'>
               y1(i,j)=dm(i,j)/(1.+rsub1(i,j))<a name='2712'>
               psdep(i,j)=r2is*min(psdep(i,j),max(y1(i,j),0.))<a name='2713'>
               y2(i,j)=min(y1(i,j),0.)<a name='2714'>
               pssub(i,j)=r2is*max(pssub(i,j),y2(i,j))<a name='2715'>
<a name='2716'>
<font color=#447700>!     ********   SUBLIMATION OF QG   ***********************************<a name='2717'></font>
<a name='2718'>
               dd(i,j)=max((-y2(i,j)-qs(i,j)), 0.)<a name='2719'>
              pgsub(i,j)=r2ig*min(dd(i,j), qg(i,j), max(pgsub(i,j),0.))<a name='2720'>
<a name='2721'>
               if(qc(i,j)+qi(i,j).gt.1.e-5) then<a name='2722'>
                  dlt1(i,j)=1.<a name='2723'>
               else<a name='2724'>
                  dlt1(i,j)=0.<a name='2725'>
               endif<a name='2726'>
<a name='2727'>
               psdep(i,j)=dlt1(i,j)*psdep(i,j)<a name='2728'>
               pssub(i,j)=(1.-dlt1(i,j))*pssub(i,j)<a name='2729'>
               pgsub(i,j)=(1.-dlt1(i,j))*pgsub(i,j)<a name='2730'>
<a name='2731'>
               pt(i,j)=pt(i,j)+ascp*(psdep(i,j)+pssub(i,j)-pgsub(i,j))<a name='2732'>
               qv(i,j)=qv(i,j)+pgsub(i,j)-pssub(i,j)-psdep(i,j)<a name='2733'>
               qs(i,j)=qs(i,j)+psdep(i,j)+pssub(i,j)<a name='2734'>
               qg(i,j)=qg(i,j)-pgsub(i,j)<a name='2735'>
            endif<a name='2736'>
<a name='2737'>
<font color=#447700>!* 23 * ERN : EVAPORATION OF QR (SUBSATURATION)                   **23**<a name='2738'></font>
<a name='2739'>
            ern(i,j)=0.0<a name='2740'>
<a name='2741'>
            if(qr(i,j).gt.0.0) then<a name='2742'>
               tair(i,j)=(pt(i,j)+tb0)*pi0<a name='2743'>
               rtair(i,j)=1./(tair(i,j)-c358)<a name='2744'>
               qsw(i,j)=rp0*exp(c172-c409*rtair(i,j))<a name='2745'>
               ssw(i,j)=(qv(i,j)+qb0)/qsw(i,j)-1.0<a name='2746'>
               dm(i,j)=qv(i,j)+qb0-qsw(i,j)<a name='2747'>
               rsub1(i,j)=cv409*qsw(i,j)*rtair(i,j)*rtair(i,j)<a name='2748'>
               dd1(i,j)=max(-dm(i,j)/(1.+rsub1(i,j)), 0.0)<a name='2749'>
               y1(i,j)=.78/zr(i,j)**2+r23af*scv(i,j)/zr(i,j)**bwh5<a name='2750'>
               y2(i,j)=r23br/(tca(i,j)*tair(i,j)**2)+1./(dwv(i,j) &amp;<a name='2751'>
                       *qsw(i,j))<a name='2752'>
<font color=#447700>!cccc<a name='2753'></font>
               ern(i,j)=r23t*ssw(i,j)*y1(i,j)/y2(i,j)<a name='2754'>
               ern(i,j)=min(dd1(i,j),qr(i,j),max(ern(i,j),0.))<a name='2755'>
               pt(i,j)=pt(i,j)-avcp*ern(i,j)<a name='2756'>
               qv(i,j)=qv(i,j)+ern(i,j)<a name='2757'>
               qr(i,j)=qr(i,j)-ern(i,j)<a name='2758'>
            endif<a name='2759'>
<a name='2760'>
<font color=#447700>!JJS 10/7/2008     vvvvv<a name='2761'></font>
    ENDIF    <font color=#447700>! part of if (iwarm.eq.1) then<a name='2762'></font>
<font color=#447700>!JJS 10/7/2008     ^^^^^<a name='2763'></font>
<a name='2764'>
<font color=#447700>!            IF (QV(I,J)+QB0 .LE. 0.) QV(I,J)=-QB0<a name='2765'></font>
            if (qc(i,j) .le. cmin1) qc(i,j)=0.<a name='2766'>
            if (qr(i,j) .le. cmin1) qr(i,j)=0.<a name='2767'>
            if (qi(i,j) .le. cmin1) qi(i,j)=0.<a name='2768'>
            if (qs(i,j) .le. cmin1) qs(i,j)=0.<a name='2769'>
            if (qg(i,j) .le. cmin1) qg(i,j)=0.<a name='2770'>
            dpt(i,j,k)=pt(i,j)<a name='2771'>
            dqv(i,j,k)=qv(i,j)<a name='2772'>
            qcl(i,j,k)=qc(i,j)<a name='2773'>
            qrn(i,j,k)=qr(i,j)<a name='2774'>
            qci(i,j,k)=qi(i,j)<a name='2775'>
            qcs(i,j,k)=qs(i,j)<a name='2776'>
            qcg(i,j,k)=qg(i,j)<a name='2777'>
<a name='2778'>
<font color=#447700>!JJS  275    CONTINUE<a name='2779'></font>
<a name='2780'>
         scc=0.<a name='2781'>
         see=0.<a name='2782'>
<a name='2783'>
<font color=#447700>!         DO 110 J=3,JLES<a name='2784'></font>
<font color=#447700>!         DO 110 I=3,ILES<a name='2785'></font>
<font color=#447700>!            DD(I,J)=MAX(-CND(I,J), 0.)<a name='2786'></font>
<font color=#447700>!            CND(I,J)=MAX(CND(I,J), 0.)<a name='2787'></font>
<font color=#447700>!            DD1(I,J)=MAX(-DEP(I,J), 0.)<a name='2788'></font>
<a name='2789'>
<font color=#447700>!ccshie 2/21/02 shie follow tao<a name='2790'></font>
<font color=#447700>!CC for reference    QI(I,J)=QI(I,J)-Y2(I,J)+PIDEP(I,J)*D2T<a name='2791'></font>
<font color=#447700>!CC for reference    QV(I,J)=QV(I,J)-(PIDEP(I,J))*D2T<a name='2792'></font>
<a name='2793'>
<font color=#447700>!c            DEP(I,J)=MAX(DEP(I,J), 0.)<a name='2794'></font>
<font color=#447700>!            DEP(I,J)=MAX(DEP(I,J), 0.)+PIDEP(I,J)*D2T<a name='2795'></font>
<font color=#447700>!            SCC=SCC+CND(I,J)<a name='2796'></font>
<font color=#447700>!            SEE=SEE+DD(I,J)+ERN(I,J)<a name='2797'></font>
<a name='2798'>
<font color=#447700>!  110    CONTINUE<a name='2799'></font>
<a name='2800'>
<font color=#447700>!         SC(K)=SCC+SC(K)<a name='2801'></font>
<font color=#447700>!         SE(K)=SEE+SE(K)<a name='2802'></font>
<a name='2803'>
<font color=#447700>!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2804'></font>
<font color=#447700>!c     henry:  please take a look  (start)<a name='2805'></font>
<font color=#447700>!JJS modified by JJS on 5/1/2007  vvvvv<a name='2806'></font>
<a name='2807'>
<font color=#447700>!JJS       do 305 j=3,jles<a name='2808'></font>
<font color=#447700>!JJS       do 305 i=3,iles<a name='2809'></font>
            dd(i,j)=max(-cnd(i,j), 0.)<a name='2810'>
            cnd(i,j)=max(cnd(i,j), 0.)<a name='2811'>
            dd1(i,j)=max(-dep(i,j), 0.)+pidep(i,j)*d2t<a name='2812'>
            dep(i,j)=max(dep(i,j), 0.)<a name='2813'>
<font color=#447700>!JJS  305  continue<a name='2814'></font>
<a name='2815'>
<font color=#447700>!JJS       do 306 j=3,jles<a name='2816'></font>
<font color=#447700>!JJS       do 306 i=3,iles<a name='2817'></font>
<font color=#447700>!JJS              scc=scc+cnd(i,j)<a name='2818'></font>
<font color=#447700>!JJS              see=see+(dd(i,j)+ern(i,j))<a name='2819'></font>
<font color=#447700>!<a name='2820'></font>
<font color=#447700>!JJS            sddd=sddd+(dep(i,j)+pint(i,j)+psdep(i,j)+pgdep(i,j))<a name='2821'></font>
<font color=#447700>!JJS          ssss=ssss+dd1(i,j)<a name='2822'></font>
<font color=#447700>!JJS<a name='2823'></font>
<font color=#447700>!            shhh=shhh+rsw(i,j,k)*d2t<a name='2824'></font>
<font color=#447700>!            sccc=sccc+rlw(i,j,k)*d2t<a name='2825'></font>
<font color=#447700>!jjs<a name='2826'></font>
<font color=#447700>!JJS              smmm=smmm+(psmlt(i,j)+pgmlt(i,j)+pimlt(i,j))<a name='2827'></font>
<font color=#447700>!JJS              sfff=sfff+d2t*(psacw(i,j)+piacr(i,j)+psfw(i,j)<a name='2828'></font>
<font color=#447700>!JJS     1         +pgfr(i,j)+dgacw(i,j)+dgacr(i,j)+psacr(i,j))<a name='2829'></font>
<font color=#447700>!JJS     2        -qracs(i,j)+pihom(i,j)+pidw(i,j)<a name='2830'></font>
<a name='2831'>
<a name='2832'>
              sccc=cnd(i,j)<a name='2833'>
              seee=dd(i,j)+ern(i,j)<a name='2834'>
              sddd=dep(i,j)+pint(i,j)+psdep(i,j)+pgdep(i,j)<a name='2835'>
              ssss=dd1(i,j) + pgsub(i,j)<a name='2836'>
              smmm=psmlt(i,j)+pgmlt(i,j)+pimlt(i,j)<a name='2837'>
              sfff=d2t*(psacw(i,j)+piacr(i,j)+psfw(i,j) &amp;<a name='2838'>
               +pgfr(i,j)+dgacw(i,j)+dgacr(i,j)+psacr(i,j) &amp;<a name='2839'>
               +wgacr(i,j))+pihom(i,j)+pidw(i,j)<a name='2840'>
<a name='2841'>
<font color=#447700>!           physc(i,k,j) = avcp * sccc / d2t<a name='2842'></font>
<font color=#447700>!           physe(i,k,j) = avcp * seee / d2t<a name='2843'></font>
<font color=#447700>!           physd(i,k,j) = ascp * sddd / d2t<a name='2844'></font>
<font color=#447700>!           physs(i,k,j) = ascp * ssss / d2t<a name='2845'></font>
<font color=#447700>!           physf(i,k,j) = afcp * sfff / d2t<a name='2846'></font>
<font color=#447700>!           physm(i,k,j) = afcp * smmm / d2t<a name='2847'></font>
<font color=#447700>!           physc(i,k,j) = physc(i,k,j) + avcp * sccc <a name='2848'></font>
<font color=#447700>!           physe(i,k,j) = physc(i,k,j) + avcp * seee <a name='2849'></font>
<font color=#447700>!           physd(i,k,j) = physd(i,k,j) + ascp * sddd <a name='2850'></font>
<font color=#447700>!           physs(i,k,j) = physs(i,k,j) + ascp * ssss <a name='2851'></font>
<font color=#447700>!           physf(i,k,j) = physf(i,k,j) + afcp * sfff <a name='2852'></font>
<font color=#447700>!           physm(i,k,j) = physm(i,k,j) + afcp * smmm <a name='2853'></font>
<a name='2854'>
<font color=#447700>!JJS modified by JJS on 5/1/2007  ^^^^^<a name='2855'></font>
<a name='2856'>
 2000 continue<a name='2857'>
<a name='2858'>
 1000 continue<a name='2859'>
<a name='2860'>
<font color=#447700>!JJS  ****************************************************************<a name='2861'></font>
<font color=#447700>!JJS  convert from GCE grid back to WRF grid<a name='2862'></font>
      do k=kts,kte<a name='2863'>
         do j=jts,jte<a name='2864'>
         do i=its,ite<a name='2865'>
         ptwrf(i,k,j) = dpt(i,j,k)<a name='2866'>
         qvwrf(i,k,j) = dqv(i,j,k)<a name='2867'>
         qlwrf(i,k,j) = qcl(i,j,k)<a name='2868'>
         qrwrf(i,k,j) = qrn(i,j,k)<a name='2869'>
         qiwrf(i,k,j) = qci(i,j,k)<a name='2870'>
         qswrf(i,k,j) = qcs(i,j,k)<a name='2871'>
         qgwrf(i,k,j) = qcg(i,j,k)<a name='2872'>
         enddo <font color=#447700>!i<a name='2873'></font>
         enddo <font color=#447700>!j<a name='2874'></font>
      enddo <font color=#447700>!k<a name='2875'></font>
<a name='2876'>
<font color=#447700>!     ****************************************************************<a name='2877'></font>
<a name='2878'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2879'></font>
         IF ( PRESENT (diagflag) ) THEN<a name='2880'>
         if (diagflag .and. do_radar_ref == 1) then<a name='2881'>
            do j=jts,jte<a name='2882'>
            do i=its,ite<a name='2883'>
               DO K=kts,kte<a name='2884'>
                  t1d(k)=ptwrf(i,k,j)*pi_mks(i,k,j)<a name='2885'>
                  p1d(k)=p0_mks(i,k,j)<a name='2886'>
                  qv1d(k)=qvwrf(i,k,j)<a name='2887'>
                  qr1d(k)=qrwrf(i,k,j)<a name='2888'>
               ENDDO<a name='2889'>
               if (ice2.eq.0) then<a name='2890'>
                  DO K=kts,kte<a name='2891'>
                     qs1d(k)=qswrf(i,k,j)<a name='2892'>
                     qg1d(k)=qgwrf(i,k,j)<a name='2893'>
                  ENDDO<a name='2894'>
               elseif (ice2.eq.1) then<a name='2895'>
                  DO K=kts,kte<a name='2896'>
                     qs1d(k)=qswrf(i,k,j)<a name='2897'>
                  ENDDO<a name='2898'>
               elseif (ice2.eq.2) then<a name='2899'>
                  DO K=kts,kte<a name='2900'>
                     qs1d(k)=0.<a name='2901'>
                     qg1d(k)=qgwrf(i,k,j)<a name='2902'>
                  ENDDO<a name='2903'>
               elseif (ice2.eq.3) then<a name='2904'>
                  DO K=kts,kte<a name='2905'>
                     qs1d(k)=0.<a name='2906'>
                     qg1d(k)=0.<a name='2907'>
                  ENDDO<a name='2908'>
               endif<a name='2909'>
               call <A href='../../html_code/phys/module_mp_gsfcgce.F.html#REFL10CM_GSFC'>refl10cm_gsfc</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#SATICEL_S' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REFL10CM_GSFC_1"> (qv1d, qr1d, qs1d, qg1d,             &amp;<a name='2910'>
                       t1d, p1d, dBZ, kts, kte, i, j, ihail)<a name='2911'>
               do k = kts, kte<a name='2912'>
                  refl_10cm(i,k,j) = MAX(-35., dBZ(k))<a name='2913'>
               enddo<a name='2914'>
            enddo<a name='2915'>
            enddo<a name='2916'>
         endif<a name='2917'>
         ENDIF<a name='2918'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2919'></font>
<a name='2920'>
      return<a name='2921'>
 END SUBROUTINE saticel_s<a name='2922'>
<a name='2923'>
<font color=#447700>!JJS<a name='2924'></font>
<font color=#447700>!JJS      REAL FUNCTION GAMMA(X)<a name='2925'></font>
<font color=#447700>!JJS        Y=GAMMLN(X)<a name='2926'></font>
<font color=#447700>!JJS        GAMMA=EXP(Y)<a name='2927'></font>
<font color=#447700>!JJS      RETURN<a name='2928'></font>
<font color=#447700>!JJS      END<a name='2929'></font>
<font color=#447700>!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2930'></font>
<font color=#447700>!JJS      real function GAMMLN (xx)<a name='2931'></font>
<A NAME='GAMMAGCE'><A href='../../html_code/phys/module_mp_gsfcgce.F.html#GAMMAGCE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2932'>
  real <font color=#993300>function </font><font color=#cc0000>gammagce</font> (xx) <A href='../../call_to/GAMMAGCE.html' TARGET='index'>10</A><a name='2933'>
<font color=#447700>!**********************************************************************<a name='2934'></font>
  real*8 cof(6),stp,half,one,fpf,x,tmp,ser<a name='2935'>
  data cof,stp /  76.18009173,-86.50532033,24.01409822, &amp;<a name='2936'>
     -1.231739516,.120858003e-2,-.536382e-5, 2.50662827465 /<a name='2937'>
  data half,one,fpf / .5, 1., 5.5 /<a name='2938'>
<font color=#447700>!<a name='2939'></font>
      x=xx-one<a name='2940'>
      tmp=x+fpf<a name='2941'>
      tmp=(x+half)*log(tmp)-tmp<a name='2942'>
      ser=one<a name='2943'>
      do  j=1,6<a name='2944'>
         x=x+one<a name='2945'>
        ser=ser+cof(j)/x<a name='2946'>
      enddo <font color=#447700>!j<a name='2947'></font>
      gammln=tmp+log(stp*ser)<a name='2948'>
<font color=#447700>!JJS<a name='2949'></font>
      gammagce=exp(gammln)<a name='2950'>
<font color=#447700>!JJS<a name='2951'></font>
      return<a name='2952'>
 END FUNCTION gammagce<a name='2953'>
<a name='2954'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2955'></font>
<a name='2956'>
<A NAME='REFL10CM_GSFC'><A href='../../html_code/phys/module_mp_gsfcgce.F.html#REFL10CM_GSFC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2957'>
      <font color=#993300>subroutine </font><font color=#cc0000>refl10cm_gsfc</font> (qv1d, qr1d, qs1d, qg1d,                 &amp; <A href='../../call_to/REFL10CM_GSFC.html' TARGET='index'>1</A>,<A href='../../call_from/REFL10CM_GSFC.html' TARGET='index'>2</A><a name='2958'>
                       t1d, p1d, dBZ, kts, kte, ii, jj, ihail)<a name='2959'>
<a name='2960'>
      IMPLICIT NONE<a name='2961'>
<a name='2962'>
<font color=#447700>!..Sub arguments<a name='2963'></font>
      INTEGER, INTENT(IN):: kts, kte, ii, jj, ihail<a name='2964'>
      REAL, DIMENSION(kts:kte), INTENT(IN)::                            &amp;<a name='2965'>
                      qv1d, qr1d, qs1d, qg1d, t1d, p1d<a name='2966'>
      REAL, DIMENSION(kts:kte), INTENT(INOUT):: dBZ<a name='2967'>
<a name='2968'>
<font color=#447700>!..Local variables<a name='2969'></font>
      REAL, DIMENSION(kts:kte):: temp, pres, qv, rho<a name='2970'>
      REAL, DIMENSION(kts:kte):: rr, rs, rg<a name='2971'>
<a name='2972'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: ilamr, ilams, ilamg<a name='2973'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: N0_r, N0_s, N0_g<a name='2974'>
      DOUBLE PRECISION:: lamr, lams, lamg<a name='2975'>
      LOGICAL, DIMENSION(kts:kte):: L_qr, L_qs, L_qg<a name='2976'>
<a name='2977'>
      REAL, DIMENSION(kts:kte):: ze_rain, ze_snow, ze_graupel<a name='2978'>
      DOUBLE PRECISION:: fmelt_s, fmelt_g<a name='2979'>
<a name='2980'>
      INTEGER:: i, k, k_0, kbot, n<a name='2981'>
      LOGICAL:: melti<a name='2982'>
<a name='2983'>
      DOUBLE PRECISION:: cback, x, eta, f_d<a name='2984'>
      REAL, PARAMETER:: R=287.<a name='2985'>
      REAL, PARAMETER:: PIx=3.1415926536<a name='2986'>
<a name='2987'>
<font color=#447700>!+---+<a name='2988'></font>
<a name='2989'>
      do k = kts, kte<a name='2990'>
         dBZ(k) = -35.0<a name='2991'>
      enddo<a name='2992'>
<a name='2993'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2994'></font>
<font color=#447700>!..Put column of data into local arrays.<a name='2995'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2996'></font>
      do k = kts, kte<a name='2997'>
         temp(k) = t1d(k)<a name='2998'>
         qv(k) = MAX(1.E-10, qv1d(k))<a name='2999'>
         pres(k) = p1d(k)<a name='3000'>
         rho(k) = 0.622*pres(k)/(R*temp(k)*(qv(k)+0.622))<a name='3001'>
<a name='3002'>
         if (qr1d(k) .gt. 1.E-9) then<a name='3003'>
            rr(k) = qr1d(k)*rho(k)<a name='3004'>
            N0_r(k) = xnor<a name='3005'>
            lamr = (xam_r*xcrg(3)*N0_r(k)/rr(k))**(1./xcre(1))<a name='3006'>
            ilamr(k) = 1./lamr<a name='3007'>
            L_qr(k) = .true.<a name='3008'>
         else<a name='3009'>
            rr(k) = 1.E-12<a name='3010'>
            L_qr(k) = .false.<a name='3011'>
         endif<a name='3012'>
<a name='3013'>
         if (qs1d(k) .gt. 1.E-9) then<a name='3014'>
            rs(k) = qs1d(k)*rho(k)<a name='3015'>
            N0_s(k) = xnos<a name='3016'>
            lams = (xam_s*xcsg(3)*N0_s(k)/rs(k))**(1./xcse(1))<a name='3017'>
            ilams(k) = 1./lams<a name='3018'>
            L_qs(k) = .true.<a name='3019'>
         else<a name='3020'>
            rs(k) = 1.E-12<a name='3021'>
            L_qs(k) = .false.<a name='3022'>
         endif<a name='3023'>
<a name='3024'>
         if (qg1d(k) .gt. 1.E-9) then<a name='3025'>
            rg(k) = qg1d(k)*rho(k)<a name='3026'>
            if (ihail.eq.1) then<a name='3027'>
               N0_g(k) = xnoh<a name='3028'>
            else<a name='3029'>
               N0_g(k) = xnog<a name='3030'>
            endif<a name='3031'>
            lamg = (xam_g*xcgg(3)*N0_g(k)/rg(k))**(1./xcge(1))<a name='3032'>
            ilamg(k) = 1./lamg<a name='3033'>
            L_qg(k) = .true.<a name='3034'>
         else<a name='3035'>
            rg(k) = 1.E-12<a name='3036'>
            L_qg(k) = .false.<a name='3037'>
         endif<a name='3038'>
      enddo<a name='3039'>
<a name='3040'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3041'></font>
<font color=#447700>!..Locate K-level of start of melting (k_0 is level above).<a name='3042'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3043'></font>
      melti = .false.<a name='3044'>
      k_0 = kts<a name='3045'>
      do k = kte-1, kts, -1<a name='3046'>
         if ( (temp(k).gt.273.15) .and. L_qr(k)                         &amp;<a name='3047'>
                                  .and. (L_qs(k+1).or.L_qg(k+1)) ) then<a name='3048'>
            k_0 = MAX(k+1, k_0)<a name='3049'>
            melti=.true.<a name='3050'>
            goto 195<a name='3051'>
         endif<a name='3052'>
      enddo<a name='3053'>
 195  continue<a name='3054'>
<a name='3055'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3056'></font>
<font color=#447700>!..Assume Rayleigh approximation at 10 cm wavelength. Rain (all temps)<a name='3057'></font>
<font color=#447700>!.. and non-water-coated snow and graupel when below freezing are<a name='3058'></font>
<font color=#447700>!.. simple. Integrations of m(D)*m(D)*N(D)*dD.<a name='3059'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3060'></font>
<a name='3061'>
      do k = kts, kte<a name='3062'>
         ze_rain(k) = 1.e-22<a name='3063'>
         ze_snow(k) = 1.e-22<a name='3064'>
         ze_graupel(k) = 1.e-22<a name='3065'>
         if (L_qr(k)) ze_rain(k) = N0_r(k)*xcrg(4)*ilamr(k)**xcre(4)<a name='3066'>
         if (L_qs(k)) ze_snow(k) = (0.176/0.93) * (6.0/PIx)*(6.0/PIx)     &amp;<a name='3067'>
                                 * (xam_s/900.0)*(xam_s/900.0)          &amp;<a name='3068'>
                                 * N0_s(k)*xcsg(4)*ilams(k)**xcse(4)<a name='3069'>
         if (L_qg(k)) ze_graupel(k) = (0.176/0.93) * (6.0/PIx)*(6.0/PIx)  &amp;<a name='3070'>
                                    * (xam_g/900.0)*(xam_g/900.0)       &amp;<a name='3071'>
                                    * N0_g(k)*xcgg(4)*ilamg(k)**xcge(4)<a name='3072'>
      enddo<a name='3073'>
<a name='3074'>
<a name='3075'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3076'></font>
<font color=#447700>!..Special case of melting ice (snow/graupel) particles.  Assume the<a name='3077'></font>
<font color=#447700>!.. ice is surrounded by the liquid water.  Fraction of meltwater is<a name='3078'></font>
<font color=#447700>!.. extremely simple based on amount found above the melting level.<a name='3079'></font>
<font color=#447700>!.. Uses code from Uli Blahak (rayleigh_soak_wetgraupel and supporting<a name='3080'></font>
<font color=#447700>!.. routines).<a name='3081'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3082'></font>
<a name='3083'>
      if (melti .and. k_0.ge.kts+1) then<a name='3084'>
       do k = k_0-1, kts, -1<a name='3085'>
<a name='3086'>
<font color=#447700>!..Reflectivity contributed by melting snow<a name='3087'></font>
          if (L_qs(k) .and. L_qs(k_0) ) then<a name='3088'>
           fmelt_s = MAX(0.005d0, MIN(1.0d0-rs(k)/rs(k_0), 0.99d0))<a name='3089'>
           eta = 0.d0<a name='3090'>
           lams = 1./ilams(k)<a name='3091'>
           do n = 1, nrbins<a name='3092'>
              x = xam_s * xxDs(n)**xbm_s<a name='3093'>
              call <A href='../../html_code/phys/module_mp_radar.F.html#RAYLEIGH_SOAK_WETGRAUPEL'>rayleigh_soak_wetgraupel</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#REFL10CM_GSFC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAYLEIGH_SOAK_WETGRAUPEL_5"> (x,DBLE(xocms),DBLE(xobms), &amp;<a name='3094'>
                    fmelt_s, melt_outside_s, m_w_0, m_i_0, lamda_radar, &amp;<a name='3095'>
                    CBACK, mixingrulestring_s, matrixstring_s,          &amp;<a name='3096'>
                    inclusionstring_s, hoststring_s,                    &amp;<a name='3097'>
                    hostmatrixstring_s, hostinclusionstring_s)<a name='3098'>
              f_d = N0_s(k)*xxDs(n)**xmu_s * DEXP(-lams*xxDs(n))<a name='3099'>
              eta = eta + f_d * CBACK * simpson(n) * xdts(n)<a name='3100'>
           enddo<a name='3101'>
           ze_snow(k) = SNGL(lamda4 / (pi5 * K_w) * eta)<a name='3102'>
          endif<a name='3103'>
<a name='3104'>
<font color=#447700>!..Reflectivity contributed by melting graupel<a name='3105'></font>
<a name='3106'>
          if (L_qg(k) .and. L_qg(k_0) ) then<a name='3107'>
           fmelt_g = MAX(0.005d0, MIN(1.0d0-rg(k)/rg(k_0), 0.99d0))<a name='3108'>
           eta = 0.d0<a name='3109'>
           lamg = 1./ilamg(k)<a name='3110'>
           do n = 1, nrbins<a name='3111'>
              x = xam_g * xxDg(n)**xbm_g<a name='3112'>
              call <A href='../../html_code/phys/module_mp_radar.F.html#RAYLEIGH_SOAK_WETGRAUPEL'>rayleigh_soak_wetgraupel</A><A href='../../html_code/phys/module_mp_gsfcgce.F.html#REFL10CM_GSFC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAYLEIGH_SOAK_WETGRAUPEL_6"> (x,DBLE(xocmg),DBLE(xobmg), &amp;<a name='3113'>
                    fmelt_g, melt_outside_g, m_w_0, m_i_0, lamda_radar, &amp;<a name='3114'>
                    CBACK, mixingrulestring_g, matrixstring_g,          &amp;<a name='3115'>
                    inclusionstring_g, hoststring_g,                    &amp;<a name='3116'>
                    hostmatrixstring_g, hostinclusionstring_g)<a name='3117'>
              f_d = N0_g(k)*xxDg(n)**xmu_g * DEXP(-lamg*xxDg(n))<a name='3118'>
              eta = eta + f_d * CBACK * simpson(n) * xdtg(n)<a name='3119'>
           enddo<a name='3120'>
           ze_graupel(k) = SNGL(lamda4 / (pi5 * K_w) * eta)<a name='3121'>
          endif<a name='3122'>
<a name='3123'>
       enddo<a name='3124'>
      endif<a name='3125'>
<a name='3126'>
      do k = kte, kts, -1<a name='3127'>
         dBZ(k) = 10.*log10((ze_rain(k)+ze_snow(k)+ze_graupel(k))*1.d18)<a name='3128'>
      enddo<a name='3129'>
<a name='3130'>
      end subroutine refl10cm_gsfc<a name='3131'>
<a name='3132'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3133'></font>
<a name='3134'>
END MODULE  module_mp_gsfcgce<a name='3135'>
</pre></body></html>