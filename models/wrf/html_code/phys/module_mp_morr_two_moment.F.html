<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<font color=#447700>! THIS MODULE CONTAINS THE TWO-MOMENT MICROPHYSICS CODE DESCRIBED BY<a name='5'></font>
<font color=#447700>!     MORRISON ET AL. (2009, MWR)<a name='6'></font>
<a name='7'>
<font color=#447700>! CHANGES FOR V3.2, RELATIVE TO MOST RECENT (BUG-FIX) CODE FOR V3.1<a name='8'></font>
<a name='9'>
<font color=#447700>! 1) ADDED ACCELERATED MELTING OF GRAUPEL/SNOW DUE TO COLLISION WITH RAIN, FOLLOWING LIN ET AL. (1983)<a name='10'></font>
<font color=#447700>! 2) INCREASED MINIMUM LAMBDA FOR RAIN, AND ADDED RAIN DROP BREAKUP FOLLOWING MODIFIED VERSION<a name='11'></font>
<font color=#447700>!     OF VERLINDE AND COTTON (1993)<a name='12'></font>
<font color=#447700>! 3) CHANGE MINIMUM ALLOWED MIXING RATIOS IN DRY CONDITIONS (RH &lt; 90%), THIS IMPROVES RADAR REFLECTIIVITY<a name='13'></font>
<font color=#447700>!     IN LOW REFLECTIVITY REGIONS<a name='14'></font>
<font color=#447700>! 4) BUG FIX TO MAXIMUM ALLOWED PARTICLE FALLSPEEDS AS A FUNCTION OF AIR DENSITY<a name='15'></font>
<font color=#447700>! 5) BUG FIX TO CALCULATION OF LIQUID WATER SATURATION VAPOR PRESSURE (CHANGE IS VERY MINOR)<a name='16'></font>
<font color=#447700>! 6) INCLUDE WRF CONSTANTS PER SUGGESTION OF JIMY<a name='17'></font>
<a name='18'>
<font color=#447700>! bug fix, 5/12/10<a name='19'></font>
<font color=#447700>! 7) bug fix for saturation vapor pressure in low pressure, to avoid division by zero<a name='20'></font>
<font color=#447700>! 8) include 'EP2' WRF constant for saturation mixing ratio calculation, instead of hardwire constant<a name='21'></font>
<a name='22'>
<font color=#447700>! CHANGES FOR V3.3<a name='23'></font>
<font color=#447700>! 1) MODIFICATION FOR COUPLING WITH WRF-CHEM (PREDICTED DROPLET NUMBER CONCENTRATION) AS AN OPTION<a name='24'></font>
<font color=#447700>! 2) MODIFY FALLSPEED BELOW THE LOWEST LEVEL OF PRECIPITATION, WHICH PREVENTS<a name='25'></font>
<font color=#447700>!      POTENTIAL FOR SPURIOUS ACCUMULATION OF PRECIPITATION DURING SUB-STEPPING FOR SEDIMENTATION<a name='26'></font>
<font color=#447700>! 3) BUG FIX TO LATENT HEAT RELEASE DUE TO COLLISIONS OF CLOUD ICE WITH RAIN<a name='27'></font>
<font color=#447700>! 4) CLEAN UP OF COMMENTS IN THE CODE<a name='28'></font>
    <a name='29'>
<font color=#447700>! additional minor bug fixes and small changes, 5/30/2011<a name='30'></font>
<font color=#447700>! minor revisions by A. Ackerman April 2011:<a name='31'></font>
<font color=#447700>! 1) replaced kinematic with dynamic viscosity <a name='32'></font>
<font color=#447700>! 2) replaced scaling by air density for cloud droplet sedimentation<a name='33'></font>
<font color=#447700>!    with viscosity-dependent Stokes expression<a name='34'></font>
<font color=#447700>! 3) use Ikawa and Saito (1991) air-density scaling for cloud ice<a name='35'></font>
<font color=#447700>! 4) corrected typo in 2nd digit of ventilation constant F2R<a name='36'></font>
<a name='37'>
<font color=#447700>! additional fixes:<a name='38'></font>
<font color=#447700>! 5) TEMPERATURE FOR ACCELERATED MELTING DUE TO COLLIIONS OF SNOW AND GRAUPEL<a name='39'></font>
<font color=#447700>!    WITH RAIN SHOULD USE CELSIUS, NOT KELVIN (BUG REPORTED BY K. VAN WEVERBERG)<a name='40'></font>
<font color=#447700>! 6) NPRACS IS NOT SUBTRACTED FROM SNOW NUMBER CONCENTRATION, SINCE<a name='41'></font>
<font color=#447700>!    DECREASE IN SNOW NUMBER IS ALREADY ACCOUNTED FOR BY NSMLTS <a name='42'></font>
<font color=#447700>! 7) fix for switch for running w/o graupel/hail (cloud ice and snow only)<a name='43'></font>
<a name='44'>
<font color=#447700>! hm bug fix 3/16/12<a name='45'></font>
<a name='46'>
<font color=#447700>! 1) very minor change to limits on autoconversion source of rain number when cloud water is depleted<a name='47'></font>
<a name='48'>
<font color=#447700>! WRFV3.5<a name='49'></font>
<font color=#447700>! hm/A. Ackerman bug fix 11/08/12<a name='50'></font>
<a name='51'>
<font color=#447700>! 1) for accelerated melting from collisions, should use rain mass collected by snow, not snow mass <a name='52'></font>
<font color=#447700>!    collected by rain<a name='53'></font>
<font color=#447700>! 2) minor changes to some comments<a name='54'></font>
<font color=#447700>! 3) reduction of maximum-allowed ice concentration from 10 cm-3 to 0.3<a name='55'></font>
<font color=#447700>!    cm-3. This was done to address the problem of excessive and persistent<a name='56'></font>
<font color=#447700>!    anvil cirrus produced by the scheme.<a name='57'></font>
<a name='58'>
<font color=#447700>! CHANGES FOR WRFV3.5.1<a name='59'></font>
<font color=#447700>! 1) added output for snow+cloud ice and graupel time step and accumulated<a name='60'></font>
<font color=#447700>!    surface precipitation<a name='61'></font>
<font color=#447700>! 2) bug fix to option w/o graupel/hail (IGRAUP = 1), include PRACI, PGSACW,<a name='62'></font>
<font color=#447700>!    and PGRACS as sources for snow instead of graupel/hail, bug reported by<a name='63'></font>
<font color=#447700>!    Hailong Wang (PNNL)<a name='64'></font>
<font color=#447700>! 3) very minor fix to immersion freezing rate formulation (negligible impact)<a name='65'></font>
<font color=#447700>! 4) clarifications to code comments<a name='66'></font>
<font color=#447700>! 5) minor change to shedding of rain, remove limit so that the number of <a name='67'></font>
<font color=#447700>!    collected drops can smaller than number of shed drops<a name='68'></font>
<font color=#447700>! 6) change of specific heat of liquid water from 4218 to 4187 J/kg/K<a name='69'></font>
<a name='70'>
<font color=#447700>! CHANGES FOR WRFV3.6.1<a name='71'></font>
<font color=#447700>! 1) minor bug fix to melting of snow and graupel, an extra factor of air density (RHO) was removed<a name='72'></font>
<font color=#447700>!    from the calculation of PSMLT and PGMLT<a name='73'></font>
<font color=#447700>! 2) redundant initialization of PSMLT (non answer-changing)<a name='74'></font>
<a name='75'>
<font color=#447700>! CHANGES FOR WRFV3.8.1<a name='76'></font>
<font color=#447700>! 1) changes and cleanup of code comments<a name='77'></font>
<font color=#447700>! 2) correction to universal gas constant (very small change)<a name='78'></font>
<a name='79'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='80'></font>
<a name='81'>
<font color=#447700>! THIS SCHEME IS A BULK DOUBLE-MOMENT SCHEME THAT PREDICTS MIXING<a name='82'></font>
<font color=#447700>! RATIOS AND NUMBER CONCENTRATIONS OF FIVE HYDROMETEOR SPECIES:<a name='83'></font>
<font color=#447700>! CLOUD DROPLETS, CLOUD (SMALL) ICE, RAIN, SNOW, AND GRAUPEL/HAIL.<a name='84'></font>
<a name='85'>
<A NAME='MODULE_MP_MORR_TWO_MOMENT'><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MODULE_MP_MORR_TWO_MOMENT' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='86'>
<font color=#993300>MODULE </font><font color=#cc0000>MODULE_MP_MORR_TWO_MOMENT</font> <A href='../../call_to/MODULE_MP_MORR_TWO_MOMENT.html' TARGET='index'>2</A><a name='87'>
   USE     <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#module_mp_morr_two_moment.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_63"><a name='88'>
   USE module_utility, ONLY: WRFU_Clock, WRFU_Alarm  <font color=#447700>! GT<a name='89'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#module_mp_morr_two_moment.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_238">, ONLY : HISTORY_ALARM, Is_alarm_tstep  <font color=#447700>! GT<a name='90'></font>
   USE <A href='../../html_code/phys/module_mp_radar.F.html#MODULE_MP_RADAR'>module_mp_radar</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#module_mp_morr_two_moment.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MP_RADAR_5"><a name='91'>
<a name='92'>
<font color=#447700>! USE WRF PHYSICS CONSTANTS<a name='93'></font>
  use <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#module_mp_morr_two_moment.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_78">, ONLY: CP, G, R =&gt; r_d, RV =&gt; r_v, EP_2<a name='94'>
<a name='95'>
<font color=#447700>!  USE module_state_description<a name='96'></font>
<a name='97'>
   IMPLICIT NONE<a name='98'>
<a name='99'>
   REAL, PARAMETER :: PI = 3.1415926535897932384626434<a name='100'>
   REAL, PARAMETER :: xxx = 0.9189385332046727417803297<a name='101'>
<a name='102'>
   PUBLIC  ::  MP_MORR_TWO_MOMENT<a name='103'>
   PUBLIC  ::  POLYSVP<a name='104'>
<a name='105'>
   PRIVATE :: GAMMA, DERF1<a name='106'>
   PRIVATE :: PI, xxx<a name='107'>
   PRIVATE :: MORR_TWO_MOMENT_MICRO<a name='108'>
<a name='109'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='110'></font>
<font color=#447700>! SWITCHES FOR MICROPHYSICS SCHEME<a name='111'></font>
<font color=#447700>! IACT = 1, USE POWER-LAW CCN SPECTRA, NCCN = CS^K<a name='112'></font>
<font color=#447700>! IACT = 2, USE LOGNORMAL AEROSOL SIZE DIST TO DERIVE CCN SPECTRA<a name='113'></font>
<font color=#447700>! IACT = 3, ACTIVATION CALCULATED IN MODULE_MIXACTIVATE<a name='114'></font>
<a name='115'>
     INTEGER, PRIVATE ::  IACT<a name='116'>
<a name='117'>
<font color=#447700>! INUM = 0, PREDICT DROPLET CONCENTRATION<a name='118'></font>
<font color=#447700>! INUM = 1, ASSUME CONSTANT DROPLET CONCENTRATION   <a name='119'></font>
<font color=#447700>! !!!NOTE: PREDICTED DROPLET CONCENTRATION NOT AVAILABLE IN THIS VERSION<a name='120'></font>
<font color=#447700>! CONTACT HUGH MORRISON (morrison@ucar.edu) FOR FURTHER INFORMATION<a name='121'></font>
<a name='122'>
     INTEGER, PRIVATE ::  INUM<a name='123'>
<a name='124'>
<font color=#447700>! FOR INUM = 1, SET CONSTANT DROPLET CONCENTRATION (CM-3)<a name='125'></font>
     REAL, PRIVATE ::      NDCNST<a name='126'>
<a name='127'>
<font color=#447700>! SWITCH FOR LIQUID-ONLY RUN<a name='128'></font>
<font color=#447700>! ILIQ = 0, INCLUDE ICE<a name='129'></font>
<font color=#447700>! ILIQ = 1, LIQUID ONLY, NO ICE<a name='130'></font>
<a name='131'>
     INTEGER, PRIVATE ::  ILIQ<a name='132'>
<a name='133'>
<font color=#447700>! SWITCH FOR ICE NUCLEATION<a name='134'></font>
<font color=#447700>! INUC = 0, USE FORMULA FROM RASMUSSEN ET AL. 2002 (MID-LATITUDE)<a name='135'></font>
<font color=#447700>!      = 1, USE MPACE OBSERVATIONS<a name='136'></font>
<a name='137'>
     INTEGER, PRIVATE ::  INUC<a name='138'>
<a name='139'>
<font color=#447700>! IBASE = 1, NEGLECT DROPLET ACTIVATION AT LATERAL CLOUD EDGES DUE TO <a name='140'></font>
<font color=#447700>!             UNRESOLVED ENTRAINMENT AND MIXING, ACTIVATE<a name='141'></font>
<font color=#447700>!             AT CLOUD BASE OR IN REGION WITH LITTLE CLOUD WATER USING <a name='142'></font>
<font color=#447700>!             NON-EQULIBRIUM SUPERSATURATION, <a name='143'></font>
<font color=#447700>!             IN CLOUD INTERIOR ACTIVATE USING EQUILIBRIUM SUPERSATURATION<a name='144'></font>
<font color=#447700>! IBASE = 2, ASSUME DROPLET ACTIVATION AT LATERAL CLOUD EDGES DUE TO <a name='145'></font>
<font color=#447700>!             UNRESOLVED ENTRAINMENT AND MIXING DOMINATES,<a name='146'></font>
<font color=#447700>!             ACTIVATE DROPLETS EVERYWHERE IN THE CLOUD USING NON-EQUILIBRIUM<a name='147'></font>
<font color=#447700>!             SUPERSATURATION, BASED ON THE <a name='148'></font>
<font color=#447700>!             LOCAL SUB-GRID AND/OR GRID-SCALE VERTICAL VELOCITY <a name='149'></font>
<font color=#447700>!             AT THE GRID POINT<a name='150'></font>
<a name='151'>
<font color=#447700>! NOTE: ONLY USED FOR PREDICTED DROPLET CONCENTRATION (INUM = 0) IN NON-WRF-CHEM VERSION OF CODE<a name='152'></font>
<a name='153'>
     INTEGER, PRIVATE ::  IBASE<a name='154'>
<a name='155'>
<font color=#447700>! INCLUDE SUB-GRID VERTICAL VELOCITY IN DROPLET ACTIVATION<a name='156'></font>
<font color=#447700>! ISUB = 0, INCLUDE SUB-GRID W (RECOMMENDED FOR LOWER RESOLUTION)<a name='157'></font>
<font color=#447700>! ISUB = 1, EXCLUDE SUB-GRID W, ONLY USE GRID-SCALE W<a name='158'></font>
<a name='159'>
<font color=#447700>! NOTE: ONLY USED FOR PREDICTED DROPLET CONCENTRATION (INUM = 0) IN NON-WRF-CHEM VERSION OF CODE<a name='160'></font>
<a name='161'>
     INTEGER, PRIVATE ::  ISUB      <a name='162'>
<a name='163'>
<font color=#447700>! SWITCH FOR GRAUPEL/NO GRAUPEL<a name='164'></font>
<font color=#447700>! IGRAUP = 0, INCLUDE GRAUPEL<a name='165'></font>
<font color=#447700>! IGRAUP = 1, NO GRAUPEL<a name='166'></font>
<a name='167'>
     INTEGER, PRIVATE ::  IGRAUP<a name='168'>
<a name='169'>
<font color=#447700>! HM ADDED NEW OPTION FOR HAIL<a name='170'></font>
<font color=#447700>! SWITCH FOR HAIL/GRAUPEL<a name='171'></font>
<font color=#447700>! IHAIL = 0, DENSE PRECIPITATING ICE IS GRAUPEL<a name='172'></font>
<font color=#447700>! IHAIL = 1, DENSE PRECIPITATING GICE IS HAIL<a name='173'></font>
<a name='174'>
     INTEGER, PRIVATE ::  IHAIL<a name='175'>
<a name='176'>
<font color=#447700>! CLOUD MICROPHYSICS CONSTANTS<a name='177'></font>
<a name='178'>
     REAL, PRIVATE ::      AI,AC,AS,AR,AG <font color=#447700>! 'A' PARAMETER IN FALLSPEED-DIAM RELATIONSHIP<a name='179'></font>
     REAL, PRIVATE ::      BI,BC,BS,BR,BG <font color=#447700>! 'B' PARAMETER IN FALLSPEED-DIAM RELATIONSHIP<a name='180'></font>
<font color=#447700>!     REAL, PRIVATE ::      R           ! GAS CONSTANT FOR AIR<a name='181'></font>
<font color=#447700>!     REAL, PRIVATE ::      RV          ! GAS CONSTANT FOR WATER VAPOR<a name='182'></font>
<font color=#447700>!     REAL, PRIVATE ::      CP          ! SPECIFIC HEAT AT CONSTANT PRESSURE FOR DRY AIR<a name='183'></font>
     REAL, PRIVATE ::      RHOSU       <font color=#447700>! STANDARD AIR DENSITY AT 850 MB<a name='184'></font>
     REAL, PRIVATE ::      RHOW        <font color=#447700>! DENSITY OF LIQUID WATER<a name='185'></font>
     REAL, PRIVATE ::      RHOI        <font color=#447700>! BULK DENSITY OF CLOUD ICE<a name='186'></font>
     REAL, PRIVATE ::      RHOSN       <font color=#447700>! BULK DENSITY OF SNOW<a name='187'></font>
     REAL, PRIVATE ::      RHOG        <font color=#447700>! BULK DENSITY OF GRAUPEL<a name='188'></font>
     REAL, PRIVATE ::      AIMM        <font color=#447700>! PARAMETER IN BIGG IMMERSION FREEZING<a name='189'></font>
     REAL, PRIVATE ::      BIMM        <font color=#447700>! PARAMETER IN BIGG IMMERSION FREEZING<a name='190'></font>
     REAL, PRIVATE ::      ECR         <font color=#447700>! COLLECTION EFFICIENCY BETWEEN DROPLETS/RAIN AND SNOW/RAIN<a name='191'></font>
     REAL, PRIVATE ::      DCS         <font color=#447700>! THRESHOLD SIZE FOR CLOUD ICE AUTOCONVERSION<a name='192'></font>
     REAL, PRIVATE ::      MI0         <font color=#447700>! INITIAL SIZE OF NUCLEATED CRYSTAL<a name='193'></font>
     REAL, PRIVATE ::      MG0         <font color=#447700>! MASS OF EMBRYO GRAUPEL<a name='194'></font>
     REAL, PRIVATE ::      F1S         <font color=#447700>! VENTILATION PARAMETER FOR SNOW<a name='195'></font>
     REAL, PRIVATE ::      F2S         <font color=#447700>! VENTILATION PARAMETER FOR SNOW<a name='196'></font>
     REAL, PRIVATE ::      F1R         <font color=#447700>! VENTILATION PARAMETER FOR RAIN<a name='197'></font>
     REAL, PRIVATE ::      F2R         <font color=#447700>! VENTILATION PARAMETER FOR RAIN<a name='198'></font>
<font color=#447700>!     REAL, PRIVATE ::      G           ! GRAVITATIONAL ACCELERATION<a name='199'></font>
     REAL, PRIVATE ::      QSMALL      <font color=#447700>! SMALLEST ALLOWED HYDROMETEOR MIXING RATIO<a name='200'></font>
     REAL, PRIVATE ::      CI,DI,CS,DS,CG,DG <font color=#447700>! SIZE DISTRIBUTION PARAMETERS FOR CLOUD ICE, SNOW, GRAUPEL<a name='201'></font>
     REAL, PRIVATE ::      EII         <font color=#447700>! COLLECTION EFFICIENCY, ICE-ICE COLLISIONS<a name='202'></font>
     REAL, PRIVATE ::      ECI         <font color=#447700>! COLLECTION EFFICIENCY, ICE-DROPLET COLLISIONS<a name='203'></font>
     REAL, PRIVATE ::      RIN     <font color=#447700>! RADIUS OF CONTACT NUCLEI (M)<a name='204'></font>
<font color=#447700>! hm, add for V3.2<a name='205'></font>
     REAL, PRIVATE ::      CPW     <font color=#447700>! SPECIFIC HEAT OF LIQUID WATER<a name='206'></font>
<a name='207'>
<font color=#447700>! CCN SPECTRA FOR IACT = 1<a name='208'></font>
<a name='209'>
     REAL, PRIVATE ::      C1     <font color=#447700>! 'C' IN NCCN = CS^K (CM-3)<a name='210'></font>
     REAL, PRIVATE ::      K1     <font color=#447700>! 'K' IN NCCN = CS^K<a name='211'></font>
<a name='212'>
<font color=#447700>! AEROSOL PARAMETERS FOR IACT = 2<a name='213'></font>
<a name='214'>
     REAL, PRIVATE ::      MW      <font color=#447700>! MOLECULAR WEIGHT WATER (KG/MOL)<a name='215'></font>
     REAL, PRIVATE ::      OSM     <font color=#447700>! OSMOTIC COEFFICIENT<a name='216'></font>
     REAL, PRIVATE ::      VI      <font color=#447700>! NUMBER OF ION DISSOCIATED IN SOLUTION<a name='217'></font>
     REAL, PRIVATE ::      EPSM    <font color=#447700>! AEROSOL SOLUBLE FRACTION<a name='218'></font>
     REAL, PRIVATE ::      RHOA    <font color=#447700>! AEROSOL BULK DENSITY (KG/M3)<a name='219'></font>
     REAL, PRIVATE ::      MAP     <font color=#447700>! MOLECULAR WEIGHT AEROSOL (KG/MOL)<a name='220'></font>
     REAL, PRIVATE ::      MA      <font color=#447700>! MOLECULAR WEIGHT OF 'AIR' (KG/MOL)<a name='221'></font>
     REAL, PRIVATE ::      RR      <font color=#447700>! UNIVERSAL GAS CONSTANT<a name='222'></font>
     REAL, PRIVATE ::      BACT    <font color=#447700>! ACTIVATION PARAMETER<a name='223'></font>
     REAL, PRIVATE ::      RM1     <font color=#447700>! GEOMETRIC MEAN RADIUS, MODE 1 (M)<a name='224'></font>
     REAL, PRIVATE ::      RM2     <font color=#447700>! GEOMETRIC MEAN RADIUS, MODE 2 (M)<a name='225'></font>
     REAL, PRIVATE ::      NANEW1  <font color=#447700>! TOTAL AEROSOL CONCENTRATION, MODE 1 (M^-3)<a name='226'></font>
     REAL, PRIVATE ::      NANEW2  <font color=#447700>! TOTAL AEROSOL CONCENTRATION, MODE 2 (M^-3)<a name='227'></font>
     REAL, PRIVATE ::      SIG1    <font color=#447700>! STANDARD DEVIATION OF AEROSOL S.D., MODE 1<a name='228'></font>
     REAL, PRIVATE ::      SIG2    <font color=#447700>! STANDARD DEVIATION OF AEROSOL S.D., MODE 2<a name='229'></font>
     REAL, PRIVATE ::      F11     <font color=#447700>! CORRECTION FACTOR FOR ACTIVATION, MODE 1<a name='230'></font>
     REAL, PRIVATE ::      F12     <font color=#447700>! CORRECTION FACTOR FOR ACTIVATION, MODE 1<a name='231'></font>
     REAL, PRIVATE ::      F21     <font color=#447700>! CORRECTION FACTOR FOR ACTIVATION, MODE 2<a name='232'></font>
     REAL, PRIVATE ::      F22     <font color=#447700>! CORRECTION FACTOR FOR ACTIVATION, MODE 2     <a name='233'></font>
     REAL, PRIVATE ::      MMULT   <font color=#447700>! MASS OF SPLINTERED ICE PARTICLE<a name='234'></font>
     REAL, PRIVATE ::      LAMMAXI,LAMMINI,LAMMAXR,LAMMINR,LAMMAXS,LAMMINS,LAMMAXG,LAMMING<a name='235'>
<a name='236'>
<font color=#447700>! CONSTANTS TO IMPROVE EFFICIENCY<a name='237'></font>
<a name='238'>
     REAL, PRIVATE :: CONS1,CONS2,CONS3,CONS4,CONS5,CONS6,CONS7,CONS8,CONS9,CONS10<a name='239'>
     REAL, PRIVATE :: CONS11,CONS12,CONS13,CONS14,CONS15,CONS16,CONS17,CONS18,CONS19,CONS20<a name='240'>
     REAL, PRIVATE :: CONS21,CONS22,CONS23,CONS24,CONS25,CONS26,CONS27,CONS28,CONS29,CONS30<a name='241'>
     REAL, PRIVATE :: CONS31,CONS32,CONS33,CONS34,CONS35,CONS36,CONS37,CONS38,CONS39,CONS40<a name='242'>
     REAL, PRIVATE :: CONS41<a name='243'>
<a name='244'>
<a name='245'>
CONTAINS<a name='246'>
<a name='247'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='248'></font>
<A NAME='MORR_TWO_MOMENT_INIT'><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='249'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>MORR_TWO_MOMENT_INIT</font>(hail_opt) <font color=#447700>! RAS <A href='../../call_to/MORR_TWO_MOMENT_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/MORR_TWO_MOMENT_INIT.html' TARGET='index'>18</A><a name='250'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='251'></font>
<font color=#447700>! THIS SUBROUTINE INITIALIZES ALL PHYSICAL CONSTANTS AMND PARAMETERS <a name='252'></font>
<font color=#447700>! NEEDED BY THE MICROPHYSICS SCHEME.<a name='253'></font>
<font color=#447700>! NEEDS TO BE CALLED AT FIRST TIME STEP, PRIOR TO CALL TO MAIN MICROPHYSICS INTERFACE<a name='254'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='255'></font>
<a name='256'>
      IMPLICIT NONE<a name='257'>
<a name='258'>
      INTEGER, INTENT(IN):: hail_opt <font color=#447700>! RAS<a name='259'></font>
<a name='260'>
      integer n,i<a name='261'>
<a name='262'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='263'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='264'></font>
<a name='265'>
<font color=#447700>! THE FOLLOWING PARAMETERS ARE USER-DEFINED SWITCHES AND NEED TO BE<a name='266'></font>
<font color=#447700>! SET PRIOR TO CODE COMPILATION<a name='267'></font>
<a name='268'>
<font color=#447700>! INUM IS AUTOMATICALLY SET TO 0 FOR WRF-CHEM BELOW,<a name='269'></font>
<font color=#447700>! ALLOWING PREDICTION OF DROPLET CONCENTRATION<a name='270'></font>
<font color=#447700>! THUS, THIS PARAMETER SHOULD NOT BE CHANGED HERE<a name='271'></font>
<font color=#447700>! AND SHOULD BE LEFT TO 1<a name='272'></font>
<a name='273'>
      INUM = 1<a name='274'>
<a name='275'>
<font color=#447700>! SET CONSTANT DROPLET CONCENTRATION (UNITS OF CM-3)<a name='276'></font>
<font color=#447700>! IF NO COUPLING WITH WRF-CHEM<a name='277'></font>
<a name='278'>
      NDCNST = 250.<a name='279'>
<a name='280'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='281'></font>
<font color=#447700>! NOTE, THE FOLLOWING OPTIONS RELATED TO DROPLET ACTIVATION <a name='282'></font>
<font color=#447700>! (IACT, IBASE, ISUB) ARE NOT AVAILABLE IN CURRENT VERSION<a name='283'></font>
<font color=#447700>! FOR WRF-CHEM, DROPLET ACTIVATION IS PERFORMED <a name='284'></font>
<font color=#447700>! IN 'MIX_ACTIVATE', NOT IN MICROPHYSICS SCHEME<a name='285'></font>
<a name='286'>
<a name='287'>
<font color=#447700>! IACT = 1, USE POWER-LAW CCN SPECTRA, NCCN = CS^K<a name='288'></font>
<font color=#447700>! IACT = 2, USE LOGNORMAL AEROSOL SIZE DIST TO DERIVE CCN SPECTRA<a name='289'></font>
<a name='290'>
      IACT = 2<a name='291'>
<a name='292'>
<font color=#447700>! IBASE = 1, NEGLECT DROPLET ACTIVATION AT LATERAL CLOUD EDGES DUE TO <a name='293'></font>
<font color=#447700>!             UNRESOLVED ENTRAINMENT AND MIXING, ACTIVATE<a name='294'></font>
<font color=#447700>!             AT CLOUD BASE OR IN REGION WITH LITTLE CLOUD WATER USING <a name='295'></font>
<font color=#447700>!             NON-EQULIBRIUM SUPERSATURATION ASSUMING NO INITIAL CLOUD WATER, <a name='296'></font>
<font color=#447700>!             IN CLOUD INTERIOR ACTIVATE USING EQUILIBRIUM SUPERSATURATION<a name='297'></font>
<font color=#447700>! IBASE = 2, ASSUME DROPLET ACTIVATION AT LATERAL CLOUD EDGES DUE TO <a name='298'></font>
<font color=#447700>!             UNRESOLVED ENTRAINMENT AND MIXING DOMINATES,<a name='299'></font>
<font color=#447700>!             ACTIVATE DROPLETS EVERYWHERE IN THE CLOUD USING NON-EQUILIBRIUM<a name='300'></font>
<font color=#447700>!             SUPERSATURATION ASSUMING NO INITIAL CLOUD WATER, BASED ON THE <a name='301'></font>
<font color=#447700>!             LOCAL SUB-GRID AND/OR GRID-SCALE VERTICAL VELOCITY <a name='302'></font>
<font color=#447700>!             AT THE GRID POINT<a name='303'></font>
<a name='304'>
<font color=#447700>! NOTE: ONLY USED FOR PREDICTED DROPLET CONCENTRATION (INUM = 0)<a name='305'></font>
 <a name='306'>
      IBASE = 2<a name='307'>
<a name='308'>
<font color=#447700>! INCLUDE SUB-GRID VERTICAL VELOCITY (standard deviation of w) IN DROPLET ACTIVATION<a name='309'></font>
<font color=#447700>! ISUB = 0, INCLUDE SUB-GRID W (RECOMMENDED FOR LOWER RESOLUTION)<a name='310'></font>
<font color=#447700>! currently, sub-grid w is constant of 0.5 m/s (not coupled with PBL/turbulence scheme)<a name='311'></font>
<font color=#447700>! ISUB = 1, EXCLUDE SUB-GRID W, ONLY USE GRID-SCALE W<a name='312'></font>
<a name='313'>
<font color=#447700>! NOTE: ONLY USED FOR PREDICTED DROPLET CONCENTRATION (INUM = 0)<a name='314'></font>
<a name='315'>
      ISUB = 0      <a name='316'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='317'></font>
<a name='318'>
<a name='319'>
<font color=#447700>! SWITCH FOR LIQUID-ONLY RUN<a name='320'></font>
<font color=#447700>! ILIQ = 0, INCLUDE ICE<a name='321'></font>
<font color=#447700>! ILIQ = 1, LIQUID ONLY, NO ICE<a name='322'></font>
<a name='323'>
      ILIQ = 0<a name='324'>
<a name='325'>
<font color=#447700>! SWITCH FOR ICE NUCLEATION<a name='326'></font>
<font color=#447700>! INUC = 0, USE FORMULA FROM RASMUSSEN ET AL. 2002 (MID-LATITUDE)<a name='327'></font>
<font color=#447700>!      = 1, USE MPACE OBSERVATIONS (ARCTIC ONLY)<a name='328'></font>
<a name='329'>
      INUC = 0<a name='330'>
<a name='331'>
<font color=#447700>! SWITCH FOR GRAUPEL/HAIL NO GRAUPEL/HAIL<a name='332'></font>
<font color=#447700>! IGRAUP = 0, INCLUDE GRAUPEL/HAIL<a name='333'></font>
<font color=#447700>! IGRAUP = 1, NO GRAUPEL/HAIL<a name='334'></font>
<a name='335'>
      IGRAUP = 0<a name='336'>
<a name='337'>
<font color=#447700>! HM ADDED 11/7/07<a name='338'></font>
<font color=#447700>! SWITCH FOR HAIL/GRAUPEL<a name='339'></font>
<font color=#447700>! IHAIL = 0, DENSE PRECIPITATING ICE IS GRAUPEL<a name='340'></font>
<font color=#447700>! IHAIL = 1, DENSE PRECIPITATING ICE IS HAIL<a name='341'></font>
<font color=#447700>! NOTE ---&gt; RECOMMEND IHAIL = 1 FOR CONTINENTAL DEEP CONVECTION<a name='342'></font>
<a name='343'>
      <font color=#447700>!IHAIL = 0 !changed to namelist option (hail_opt) by RAS<a name='344'></font>
      <font color=#447700>! Check if namelist option is feasible, otherwise default to graupel - RAS<a name='345'></font>
      IF (hail_opt .eq. 1) THEN<a name='346'>
         IHAIL = 1<a name='347'>
      ELSE<a name='348'>
         IHAIL = 0<a name='349'>
      ENDIF<a name='350'>
<a name='351'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='352'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='353'></font>
<font color=#447700>! SET PHYSICAL CONSTANTS<a name='354'></font>
<a name='355'>
<font color=#447700>! FALLSPEED PARAMETERS (V=AD^B)<a name='356'></font>
         AI = 700.<a name='357'>
         AC = 3.E7<a name='358'>
         AS = 11.72<a name='359'>
         AR = 841.99667<a name='360'>
         BI = 1.<a name='361'>
         BC = 2.<a name='362'>
         BS = 0.41<a name='363'>
         BR = 0.8<a name='364'>
         IF (IHAIL.EQ.0) THEN<a name='365'>
	 AG = 19.3<a name='366'>
	 BG = 0.37<a name='367'>
         ELSE <font color=#447700>! (MATSUN AND HUGGINS 1980)<a name='368'></font>
         AG = 114.5 <a name='369'>
         BG = 0.5<a name='370'>
         END IF<a name='371'>
<a name='372'>
<font color=#447700>! CONSTANTS AND PARAMETERS<a name='373'></font>
<font color=#447700>!         R = 287.15<a name='374'></font>
<font color=#447700>!         RV = 461.5<a name='375'></font>
<font color=#447700>!         CP = 1005.<a name='376'></font>
         RHOSU = 85000./(287.15*273.15)<a name='377'>
         RHOW = 997.<a name='378'>
         RHOI = 500.<a name='379'>
         RHOSN = 100.<a name='380'>
         IF (IHAIL.EQ.0) THEN<a name='381'>
	 RHOG = 400.<a name='382'>
         ELSE<a name='383'>
         RHOG = 900.<a name='384'>
         END IF<a name='385'>
         AIMM = 0.66<a name='386'>
         BIMM = 100.<a name='387'>
         ECR = 1.<a name='388'>
         DCS = 125.E-6<a name='389'>
         MI0 = 4./3.*PI*RHOI*(10.E-6)**3<a name='390'>
	 MG0 = 1.6E-10<a name='391'>
         F1S = 0.86<a name='392'>
         F2S = 0.28<a name='393'>
         F1R = 0.78<a name='394'>
<font color=#447700>!         F2R = 0.32<a name='395'></font>
<font color=#447700>! fix 053011<a name='396'></font>
         F2R = 0.308<a name='397'>
<font color=#447700>!         G = 9.806<a name='398'></font>
         QSMALL = 1.E-14<a name='399'>
         EII = 0.1<a name='400'>
         ECI = 0.7<a name='401'>
<font color=#447700>! HM, ADD FOR V3.2<a name='402'></font>
<font color=#447700>! hm, 7/23/13<a name='403'></font>
<font color=#447700>!         CPW = 4218.<a name='404'></font>
         CPW = 4187.<a name='405'>
<a name='406'>
<font color=#447700>! SIZE DISTRIBUTION PARAMETERS<a name='407'></font>
<a name='408'>
         CI = RHOI*PI/6.<a name='409'>
         DI = 3.<a name='410'>
         CS = RHOSN*PI/6.<a name='411'>
         DS = 3.<a name='412'>
         CG = RHOG*PI/6.<a name='413'>
         DG = 3.<a name='414'>
<a name='415'>
<font color=#447700>! RADIUS OF CONTACT NUCLEI<a name='416'></font>
         RIN = 0.1E-6<a name='417'>
<a name='418'>
         MMULT = 4./3.*PI*RHOI*(5.E-6)**3<a name='419'>
<a name='420'>
<font color=#447700>! SIZE LIMITS FOR LAMBDA<a name='421'></font>
<a name='422'>
         LAMMAXI = 1./1.E-6<a name='423'>
         LAMMINI = 1./(2.*DCS+100.E-6)<a name='424'>
         LAMMAXR = 1./20.E-6<a name='425'>
<font color=#447700>!         LAMMINR = 1./500.E-6<a name='426'></font>
         LAMMINR = 1./2800.E-6<a name='427'>
<a name='428'>
         LAMMAXS = 1./10.E-6<a name='429'>
         LAMMINS = 1./2000.E-6<a name='430'>
         LAMMAXG = 1./20.E-6<a name='431'>
         LAMMING = 1./2000.E-6<a name='432'>
<a name='433'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='434'></font>
<font color=#447700>! note: these parameters only used by the non-wrf-chem version of the <a name='435'></font>
<font color=#447700>!       scheme with predicted droplet number<a name='436'></font>
<a name='437'>
<font color=#447700>! CCN SPECTRA FOR IACT = 1<a name='438'></font>
<a name='439'>
<font color=#447700>! MARITIME<a name='440'></font>
<font color=#447700>! MODIFIED FROM RASMUSSEN ET AL. 2002<a name='441'></font>
<font color=#447700>! NCCN = C*S^K, NCCN IS IN CM-3, S IS SUPERSATURATION RATIO IN %<a name='442'></font>
<a name='443'>
              K1 = 0.4<a name='444'>
              C1 = 120. <a name='445'>
<a name='446'>
<font color=#447700>! CONTINENTAL<a name='447'></font>
<a name='448'>
<font color=#447700>!              K1 = 0.5<a name='449'></font>
<font color=#447700>!              C1 = 1000. <a name='450'></font>
<a name='451'>
<font color=#447700>! AEROSOL ACTIVATION PARAMETERS FOR IACT = 2<a name='452'></font>
<font color=#447700>! PARAMETERS CURRENTLY SET FOR AMMONIUM SULFATE<a name='453'></font>
<a name='454'>
         MW = 0.018<a name='455'>
         OSM = 1.<a name='456'>
         VI = 3.<a name='457'>
         EPSM = 0.7<a name='458'>
         RHOA = 1777.<a name='459'>
         MAP = 0.132<a name='460'>
         MA = 0.0284<a name='461'>
<font color=#447700>! hm fix 6/23/16<a name='462'></font>
<font color=#447700>!         RR = 8.3187<a name='463'></font>
         RR = 8.3145<a name='464'>
         BACT = VI*OSM*EPSM*MW*RHOA/(MAP*RHOW)<a name='465'>
<a name='466'>
<font color=#447700>! AEROSOL SIZE DISTRIBUTION PARAMETERS CURRENTLY SET FOR MPACE <a name='467'></font>
<font color=#447700>! (see morrison et al. 2007, JGR)<a name='468'></font>
<font color=#447700>! MODE 1<a name='469'></font>
<a name='470'>
         RM1 = 0.052E-6<a name='471'>
         SIG1 = 2.04<a name='472'>
         NANEW1 = 72.2E6<a name='473'>
         F11 = 0.5*EXP(2.5*(LOG(SIG1))**2)<a name='474'>
         F21 = 1.+0.25*LOG(SIG1)<a name='475'>
<a name='476'>
<font color=#447700>! MODE 2<a name='477'></font>
<a name='478'>
         RM2 = 1.3E-6<a name='479'>
         SIG2 = 2.5<a name='480'>
         NANEW2 = 1.8E6<a name='481'>
         F12 = 0.5*EXP(2.5*(LOG(SIG2))**2)<a name='482'>
         F22 = 1.+0.25*LOG(SIG2)<a name='483'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='484'></font>
<a name='485'>
<font color=#447700>! CONSTANTS FOR EFFICIENCY<a name='486'></font>
<a name='487'>
         CONS1=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_94">(1.+DS)*CS<a name='488'>
         CONS2=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_95">(1.+DG)*CG<a name='489'>
         CONS3=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_96">(4.+BS)/6.<a name='490'>
         CONS4=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_97">(4.+BR)/6.<a name='491'>
         CONS5=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_98">(1.+BS)<a name='492'>
         CONS6=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_99">(1.+BR)<a name='493'>
         CONS7=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_100">(4.+BG)/6.<a name='494'>
         CONS8=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_101">(1.+BG)<a name='495'>
         CONS9=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_102">(5./2.+BR/2.)<a name='496'>
         CONS10=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_103">(5./2.+BS/2.)<a name='497'>
         CONS11=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_104">(5./2.+BG/2.)<a name='498'>
         CONS12=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_105">(1.+DI)*CI<a name='499'>
         CONS13=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_106">(BS+3.)*PI/4.*ECI<a name='500'>
         CONS14=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_107">(BG+3.)*PI/4.*ECI<a name='501'>
         CONS15=-1108.*EII*PI**((1.-BS)/3.)*RHOSN**((-2.-BS)/3.)/(4.*720.)<a name='502'>
         CONS16=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_108">(BI+3.)*PI/4.*ECI<a name='503'>
         CONS17=4.*2.*3.*RHOSU*PI*ECI*ECI*GAMMA(2.*BS+2.)/(8.*(RHOG-RHOSN))<a name='504'>
         CONS18=RHOSN*RHOSN<a name='505'>
         CONS19=RHOW*RHOW<a name='506'>
         CONS20=20.*PI*PI*RHOW*BIMM<a name='507'>
         CONS21=4./(DCS*RHOI)<a name='508'>
         CONS22=PI*RHOI*DCS**3/6.<a name='509'>
         CONS23=PI/4.*EII*GAMMA(BS+3.)<a name='510'>
         CONS24=PI/4.*ECR*GAMMA(BR+3.)<a name='511'>
         CONS25=PI*PI/24.*RHOW*ECR*GAMMA(BR+6.)<a name='512'>
         CONS26=PI/6.*RHOW<a name='513'>
         CONS27=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_109">(1.+BI)<a name='514'>
         CONS28=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_110">(4.+BI)/6.<a name='515'>
         CONS29=4./3.*PI*RHOW*(25.E-6)**3<a name='516'>
         CONS30=4./3.*PI*RHOW<a name='517'>
         CONS31=PI*PI*ECR*RHOSN<a name='518'>
         CONS32=PI/2.*ECR<a name='519'>
         CONS33=PI*PI*ECR*RHOG<a name='520'>
         CONS34=5./2.+BR/2.<a name='521'>
         CONS35=5./2.+BS/2.<a name='522'>
         CONS36=5./2.+BG/2.<a name='523'>
         CONS37=4.*PI*1.38E-23/(6.*PI*RIN)<a name='524'>
         CONS38=PI*PI/3.*RHOW<a name='525'>
         CONS39=PI*PI/36.*RHOW*BIMM<a name='526'>
         CONS40=PI/6.*BIMM<a name='527'>
         CONS41=PI*PI*ECR*RHOW<a name='528'>
<a name='529'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='530'></font>
<font color=#447700>!..Set these variables needed for computing radar reflectivity.  These<a name='531'></font>
<font color=#447700>!.. get used within radar_init to create other variables used in the<a name='532'></font>
<font color=#447700>!.. radar module.<a name='533'></font>
<a name='534'>
         xam_r = PI*RHOW/6.<a name='535'>
         xbm_r = 3.<a name='536'>
         xmu_r = 0.<a name='537'>
         xam_s = CS<a name='538'>
         xbm_s = DS<a name='539'>
         xmu_s = 0.<a name='540'>
         xam_g = CG<a name='541'>
         xbm_g = DG<a name='542'>
         xmu_g = 0.<a name='543'>
<a name='544'>
         call <A href='../../html_code/phys/module_mp_radar.F.html#RADAR_INIT'>radar_init</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADAR_INIT_5"><a name='545'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='546'></font>
<a name='547'>
<a name='548'>
END SUBROUTINE MORR_TWO_MOMENT_INIT<a name='549'>
<a name='550'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='551'></font>
<font color=#447700>! THIS SUBROUTINE IS MAIN INTERFACE WITH THE TWO-MOMENT MICROPHYSICS SCHEME<a name='552'></font>
<font color=#447700>! THIS INTERFACE TAKES IN 3D VARIABLES FROM DRIVER MODEL, CONVERTS TO 1D FOR<a name='553'></font>
<font color=#447700>! CALL TO THE MAIN MICROPHYSICS SUBROUTINE (SUBROUTINE MORR_TWO_MOMENT_MICRO) <a name='554'></font>
<font color=#447700>! WHICH OPERATES ON 1D VERTICAL COLUMNS.<a name='555'></font>
<font color=#447700>! 1D VARIABLES FROM THE MAIN MICROPHYSICS SUBROUTINE ARE THEN REASSIGNED BACK TO 3D FOR OUTPUT<a name='556'></font>
<font color=#447700>! BACK TO DRIVER MODEL USING THIS INTERFACE.<a name='557'></font>
<font color=#447700>! MICROPHYSICS TENDENCIES ARE ADDED TO VARIABLES HERE BEFORE BEING PASSED BACK TO DRIVER MODEL.<a name='558'></font>
<a name='559'>
<font color=#447700>! THIS CODE WAS WRITTEN BY HUGH MORRISON (NCAR) AND SLAVA TATARSKII (GEORGIA TECH).<a name='560'></font>
<a name='561'>
<font color=#447700>! FOR QUESTIONS, CONTACT: HUGH MORRISON, E-MAIL: MORRISON@UCAR.EDU, PHONE:303-497-8916<a name='562'></font>
<a name='563'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='564'></font>
<a name='565'>
<A NAME='MP_MORR_TWO_MOMENT'><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MP_MORR_TWO_MOMENT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='566'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>MP_MORR_TWO_MOMENT</font>(ITIMESTEP,                       &amp; <A href='../../call_to/MP_MORR_TWO_MOMENT.html' TARGET='index'>1</A>,<A href='../../call_from/MP_MORR_TWO_MOMENT.html' TARGET='index'>2</A><a name='567'>
                TH, QV, QC, QR, QI, QS, QG, NI, NS, NR, NG, &amp;<a name='568'>
                RHO, PII, P, DT_IN, DZ, HT, W,          &amp;<a name='569'>
                RAINNC, RAINNCV, SR,                    &amp;<a name='570'>
		SNOWNC,SNOWNCV,GRAUPELNC,GRAUPELNCV,    &amp; <font color=#447700>! hm added 7/13/13<a name='571'></font>
                refl_10cm, diagflag, do_radar_ref,      &amp; <font color=#447700>! GT added for reflectivity calcs<a name='572'></font>
                qrcuten, qscuten, qicuten               &amp; <font color=#447700>! hm added<a name='573'></font>
               ,F_QNDROP, qndrop                        &amp; <font color=#447700>! hm added, wrf-chem <a name='574'></font>
               ,IDS,IDE, JDS,JDE, KDS,KDE               &amp; <font color=#447700>! domain dims<a name='575'></font>
               ,IMS,IME, JMS,JME, KMS,KME               &amp; <font color=#447700>! memory dims<a name='576'></font>
               ,ITS,ITE, JTS,JTE, KTS,KTE               &amp; <font color=#447700>! tile   dims            )<a name='577'></font>
<font color=#447700>!jdf		   ,C2PREC3D,CSED3D,ISED3D,SSED3D,GSED3D,RSED3D &amp; ! HM ADD, WRF-CHEM<a name='578'></font>
               ,rainprod, evapprod                      &amp;<a name='579'>
		   ,QLSINK,PRECR,PRECI,PRECS,PRECG &amp;        <font color=#447700>! HM ADD, WRF-CHEM<a name='580'></font>
                                            )<a name='581'>
 <a name='582'>
<font color=#447700>! QV - water vapor mixing ratio (kg/kg)<a name='583'></font>
<font color=#447700>! QC - cloud water mixing ratio (kg/kg)<a name='584'></font>
<font color=#447700>! QR - rain water mixing ratio (kg/kg)<a name='585'></font>
<font color=#447700>! QI - cloud ice mixing ratio (kg/kg)<a name='586'></font>
<font color=#447700>! QS - snow mixing ratio (kg/kg)<a name='587'></font>
<font color=#447700>! QG - graupel mixing ratio (KG/KG)<a name='588'></font>
<font color=#447700>! NI - cloud ice number concentration (1/kg)<a name='589'></font>
<font color=#447700>! NS - Snow Number concentration (1/kg)<a name='590'></font>
<font color=#447700>! NR - Rain Number concentration (1/kg)<a name='591'></font>
<font color=#447700>! NG - Graupel number concentration (1/kg)<a name='592'></font>
<font color=#447700>! NOTE: RHO AND HT NOT USED BY THIS SCHEME AND DO NOT NEED TO BE PASSED INTO SCHEME!!!!<a name='593'></font>
<font color=#447700>! P - AIR PRESSURE (PA)<a name='594'></font>
<font color=#447700>! W - VERTICAL AIR VELOCITY (M/S)<a name='595'></font>
<font color=#447700>! TH - POTENTIAL TEMPERATURE (K)<a name='596'></font>
<font color=#447700>! PII - exner function - used to convert potential temp to temp<a name='597'></font>
<font color=#447700>! DZ - difference in height over interface (m)<a name='598'></font>
<font color=#447700>! DT_IN - model time step (sec)<a name='599'></font>
<font color=#447700>! ITIMESTEP - time step counter<a name='600'></font>
<font color=#447700>! RAINNC - accumulated grid-scale precipitation (mm)<a name='601'></font>
<font color=#447700>! RAINNCV - one time step grid scale precipitation (mm/time step)<a name='602'></font>
<font color=#447700>! SNOWNC - accumulated grid-scale snow plus cloud ice (mm)<a name='603'></font>
<font color=#447700>! SNOWNCV - one time step grid scale snow plus cloud ice (mm/time step)<a name='604'></font>
<font color=#447700>! GRAUPELNC - accumulated grid-scale graupel (mm)<a name='605'></font>
<font color=#447700>! GRAUPELNCV - one time step grid scale graupel (mm/time step)<a name='606'></font>
<font color=#447700>! SR - one time step mass ratio of snow to total precip<a name='607'></font>
<font color=#447700>! qrcuten, rain tendency from parameterized cumulus convection<a name='608'></font>
<font color=#447700>! qscuten, snow tendency from parameterized cumulus convection<a name='609'></font>
<font color=#447700>! qicuten, cloud ice tendency from parameterized cumulus convection<a name='610'></font>
<a name='611'>
<font color=#447700>! variables below currently not in use, not coupled to PBL or radiation codes<a name='612'></font>
<font color=#447700>! TKE - turbulence kinetic energy (m^2 s-2), NEEDED FOR DROPLET ACTIVATION (SEE CODE BELOW)<a name='613'></font>
<font color=#447700>! NCTEND - droplet concentration tendency from pbl (kg-1 s-1)<a name='614'></font>
<font color=#447700>! NCTEND - CLOUD ICE concentration tendency from pbl (kg-1 s-1)<a name='615'></font>
<font color=#447700>! KZH - heat eddy diffusion coefficient from YSU scheme (M^2 S-1), NEEDED FOR DROPLET ACTIVATION (SEE CODE BELOW)<a name='616'></font>
<font color=#447700>! EFFCS - CLOUD DROPLET EFFECTIVE RADIUS OUTPUT TO RADIATION CODE (micron)<a name='617'></font>
<font color=#447700>! EFFIS - CLOUD DROPLET EFFECTIVE RADIUS OUTPUT TO RADIATION CODE (micron)<a name='618'></font>
<font color=#447700>! HM, ADDED FOR WRF-CHEM COUPLING<a name='619'></font>
<font color=#447700>! QLSINK - TENDENCY OF CLOUD WATER TO RAIN, SNOW, GRAUPEL (KG/KG/S)<a name='620'></font>
<font color=#447700>! CSED,ISED,SSED,GSED,RSED - SEDIMENTATION FLUXES (KG/M^2/S) FOR CLOUD WATER, ICE, SNOW, GRAUPEL, RAIN<a name='621'></font>
<font color=#447700>! PRECI,PRECS,PRECG,PRECR - SEDIMENTATION FLUXES (KG/M^2/S) FOR ICE, SNOW, GRAUPEL, RAIN<a name='622'></font>
<a name='623'>
<font color=#447700>! rainprod - total tendency of conversion of cloud water/ice and graupel to rain (kg kg-1 s-1)<a name='624'></font>
<font color=#447700>! evapprod - tendency of evaporation of rain (kg kg-1 s-1)<a name='625'></font>
<a name='626'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='627'></font>
<a name='628'>
<font color=#447700>! reflectivity currently not included!!!!<a name='629'></font>
<font color=#447700>! REFL_10CM - CALCULATED RADAR REFLECTIVITY AT 10 CM (DBZ)<a name='630'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='631'></font>
<a name='632'>
<font color=#447700>! EFFC - DROPLET EFFECTIVE RADIUS (MICRON)<a name='633'></font>
<font color=#447700>! EFFR - RAIN EFFECTIVE RADIUS (MICRON)<a name='634'></font>
<font color=#447700>! EFFS - SNOW EFFECTIVE RADIUS (MICRON)<a name='635'></font>
<font color=#447700>! EFFI - CLOUD ICE EFFECTIVE RADIUS (MICRON)<a name='636'></font>
<a name='637'>
<font color=#447700>! ADDITIONAL OUTPUT FROM MICRO - SEDIMENTATION TENDENCIES, NEEDED FOR LIQUID-ICE STATIC ENERGY<a name='638'></font>
<a name='639'>
<font color=#447700>! QGSTEN - GRAUPEL SEDIMENTATION TEND (KG/KG/S)<a name='640'></font>
<font color=#447700>! QRSTEN - RAIN SEDIMENTATION TEND (KG/KG/S)<a name='641'></font>
<font color=#447700>! QISTEN - CLOUD ICE SEDIMENTATION TEND (KG/KG/S)<a name='642'></font>
<font color=#447700>! QNISTEN - SNOW SEDIMENTATION TEND (KG/KG/S)<a name='643'></font>
<font color=#447700>! QCSTEN - CLOUD WATER SEDIMENTATION TEND (KG/KG/S)<a name='644'></font>
<a name='645'>
<font color=#447700>! WVAR - STANDARD DEVIATION OF SUB-GRID VERTICAL VELOCITY (M/S)<a name='646'></font>
<a name='647'>
   IMPLICIT NONE<a name='648'>
<a name='649'>
   INTEGER,      INTENT(IN   )    ::   ids, ide, jds, jde, kds, kde , &amp;<a name='650'>
                                       ims, ime, jms, jme, kms, kme , &amp;<a name='651'>
                                       its, ite, jts, jte, kts, kte<a name='652'>
<font color=#447700>! Temporary changed from INOUT to IN<a name='653'></font>
<a name='654'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT):: &amp;<a name='655'>
                          qv, qc, qr, qi, qs, qg, ni, ns, nr, TH, NG   <a name='656'>
<font color=#447700>!jdf                      qndrop ! hm added, wrf-chem<a name='657'></font>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), optional,INTENT(INOUT):: qndrop<a name='658'>
<font color=#447700>!jdf  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(INOUT):: CSED3D, &amp;<a name='659'></font>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), optional,INTENT(INOUT):: QLSINK, &amp;<a name='660'>
                          rainprod, evapprod, &amp;<a name='661'>
                          PRECI,PRECS,PRECG,PRECR <font color=#447700>! HM, WRF-CHEM<a name='662'></font>
<font color=#447700>!, effcs, effis<a name='663'></font>
<a name='664'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN):: &amp;<a name='665'>
                          pii, p, dz, rho, w <font color=#447700>!, tke, nctend, nitend,kzh<a name='666'></font>
   REAL, INTENT(IN):: dt_in<a name='667'>
   INTEGER, INTENT(IN):: ITIMESTEP<a name='668'>
<a name='669'>
   REAL, DIMENSION(ims:ime, jms:jme), INTENT(INOUT):: &amp;<a name='670'>
                          RAINNC, RAINNCV, SR, &amp;<a name='671'>
<font color=#447700>! hm added 7/13/13<a name='672'></font>
                          SNOWNC,SNOWNCV,GRAUPELNC,GRAUPELNCV<a name='673'>
<a name='674'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT)::       &amp;  <font color=#447700>! GT<a name='675'></font>
                          refl_10cm<a name='676'>
<a name='677'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN) ::       ht<a name='678'>
<a name='679'>
   <font color=#447700>! LOCAL VARIABLES<a name='680'></font>
<a name='681'>
   REAL, DIMENSION(its:ite, kts:kte, jts:jte)::                     &amp;<a name='682'>
                      effi, effs, effr, EFFG<a name='683'>
<a name='684'>
   REAL, DIMENSION(its:ite, kts:kte, jts:jte)::                     &amp;<a name='685'>
                      T, WVAR, EFFC<a name='686'>
<a name='687'>
   REAL, DIMENSION(kts:kte) ::                                                                &amp; <a name='688'>
                            QC_TEND1D, QI_TEND1D, QNI_TEND1D, QR_TEND1D,                      &amp;<a name='689'>
                            NI_TEND1D, NS_TEND1D, NR_TEND1D,                                  &amp;<a name='690'>
                            QC1D, QI1D, QR1D,NI1D, NS1D, NR1D, QS1D,                          &amp;<a name='691'>
                            T_TEND1D,QV_TEND1D, T1D, QV1D, P1D, W1D, WVAR1D,         &amp;<a name='692'>
                            EFFC1D, EFFI1D, EFFS1D, EFFR1D,DZ1D,   &amp;<a name='693'>
   <font color=#447700>! HM ADD GRAUPEL<a name='694'></font>
                            QG_TEND1D, NG_TEND1D, QG1D, NG1D, EFFG1D, &amp;<a name='695'>
<a name='696'>
<font color=#447700>! ADD SEDIMENTATION TENDENCIES (UNITS OF KG/KG/S)<a name='697'></font>
                            QGSTEN,QRSTEN, QISTEN, QNISTEN, QCSTEN, &amp;<a name='698'>
<font color=#447700>! ADD CUMULUS TENDENCIES<a name='699'></font>
                            QRCU1D, QSCU1D, QICU1D<a name='700'>
<a name='701'>
<font color=#447700>! add cumulus tendencies<a name='702'></font>
<a name='703'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN):: &amp;<a name='704'>
      qrcuten, qscuten, qicuten<a name='705'>
<a name='706'>
  LOGICAL, INTENT(IN), OPTIONAL ::                F_QNDROP  <font color=#447700>! wrf-chem<a name='707'></font>
  LOGICAL :: flag_qndrop  <font color=#447700>! wrf-chem<a name='708'></font>
  integer :: iinum <font color=#447700>! wrf-chem<a name='709'></font>
<a name='710'>
<font color=#447700>! wrf-chem<a name='711'></font>
   REAL, DIMENSION(kts:kte) :: nc1d, nc_tend1d,C2PREC,CSED,ISED,SSED,GSED,RSED    <a name='712'>
   REAL, DIMENSION(kts:kte) :: rainprod1d, evapprod1d<a name='713'>
<font color=#447700>! HM add reflectivity      <a name='714'></font>
   REAL, DIMENSION(kts:kte) :: dBZ<a name='715'>
                          <a name='716'>
   REAL PRECPRT1D, SNOWRT1D, SNOWPRT1D, GRPLPRT1D <font color=#447700>! hm added 7/13/13<a name='717'></font>
<a name='718'>
   INTEGER I,K,J<a name='719'>
<a name='720'>
   REAL DT<a name='721'>
<a name='722'>
   LOGICAL, OPTIONAL, INTENT(IN) :: diagflag<a name='723'>
   INTEGER, OPTIONAL, INTENT(IN) :: do_radar_ref<a name='724'>
<a name='725'>
<font color=#447700>! below for wrf-chem<a name='726'></font>
   flag_qndrop = .false.<a name='727'>
   IF ( PRESENT ( f_qndrop ) ) flag_qndrop = f_qndrop<a name='728'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!<a name='729'></font>
<a name='730'>
   <font color=#447700>! Initialize tendencies (all set to 0) and transfer<a name='731'></font>
   <font color=#447700>! array to local variables<a name='732'></font>
   DT = DT_IN   <a name='733'>
<a name='734'>
   DO I=ITS,ITE<a name='735'>
   DO J=JTS,JTE<a name='736'>
   DO K=KTS,KTE<a name='737'>
       T(I,K,J)        = TH(i,k,j)*PII(i,k,j)<a name='738'>
<a name='739'>
<font color=#447700>! NOTE: WVAR NOT CURRENTLY USED IN CODE !!!!!!!!!!<a name='740'></font>
<font color=#447700>! currently assign wvar to 0.5 m/s (not coupled with PBL scheme)<a name='741'></font>
<a name='742'>
       WVAR(I,K,J)     = 0.5<a name='743'>
<a name='744'>
<font color=#447700>! currently mixing of number concentrations also is neglected (not coupled with PBL schemes)<a name='745'></font>
<a name='746'>
   END DO<a name='747'>
   END DO<a name='748'>
   END DO<a name='749'>
<a name='750'>
   do i=its,ite      <font color=#447700>! i loop (east-west)<a name='751'></font>
   do j=jts,jte      <font color=#447700>! j loop (north-south)<a name='752'></font>
   <font color=#447700>!<a name='753'></font>
   <font color=#447700>! Transfer 3D arrays into 1D for microphysical calculations<a name='754'></font>
   <font color=#447700>!<a name='755'></font>
<a name='756'>
<font color=#447700>! hm , initialize 1d tendency arrays to zero<a name='757'></font>
<a name='758'>
      do k=kts,kte   <font color=#447700>! k loop (vertical)<a name='759'></font>
<a name='760'>
          QC_TEND1D(k)  = 0.<a name='761'>
          QI_TEND1D(k)  = 0.<a name='762'>
          QNI_TEND1D(k) = 0.<a name='763'>
          QR_TEND1D(k)  = 0.<a name='764'>
          NI_TEND1D(k)  = 0.<a name='765'>
          NS_TEND1D(k)  = 0.<a name='766'>
          NR_TEND1D(k)  = 0.<a name='767'>
          T_TEND1D(k)   = 0.<a name='768'>
          QV_TEND1D(k)  = 0.<a name='769'>
          nc_tend1d(k) = 0. <font color=#447700>! wrf-chem<a name='770'></font>
<a name='771'>
          QC1D(k)       = QC(i,k,j)<a name='772'>
          QI1D(k)       = QI(i,k,j)<a name='773'>
          QS1D(k)       = QS(i,k,j)<a name='774'>
          QR1D(k)       = QR(i,k,j)<a name='775'>
<a name='776'>
          NI1D(k)       = NI(i,k,j)<a name='777'>
<a name='778'>
          NS1D(k)       = NS(i,k,j)<a name='779'>
          NR1D(k)       = NR(i,k,j)<a name='780'>
<font color=#447700>! HM ADD GRAUPEL<a name='781'></font>
          QG1D(K)       = QG(I,K,j)<a name='782'>
          NG1D(K)       = NG(I,K,j)<a name='783'>
          QG_TEND1D(K)  = 0.<a name='784'>
          NG_TEND1D(K)  = 0.<a name='785'>
<a name='786'>
          T1D(k)        = T(i,k,j)<a name='787'>
          QV1D(k)       = QV(i,k,j)<a name='788'>
          P1D(k)        = P(i,k,j)<a name='789'>
          DZ1D(k)       = DZ(i,k,j)<a name='790'>
          W1D(k)        = W(i,k,j)<a name='791'>
          WVAR1D(k)     = WVAR(i,k,j)<a name='792'>
<font color=#447700>! add cumulus tendencies, already decoupled<a name='793'></font>
          qrcu1d(k)     = qrcuten(i,k,j)<a name='794'>
          qscu1d(k)     = qscuten(i,k,j)<a name='795'>
          qicu1d(k)     = qicuten(i,k,j)<a name='796'>
      end do  <font color=#447700>!jdf added this<a name='797'></font>
<font color=#447700>! below for wrf-chem<a name='798'></font>
   IF (flag_qndrop .AND. PRESENT( qndrop )) THEN<a name='799'>
      iact = 3<a name='800'>
      DO k = kts, kte<a name='801'>
         nc1d(k)=qndrop(i,k,j)<a name='802'>
         iinum=0<a name='803'>
      ENDDO<a name='804'>
   ELSE<a name='805'>
      DO k = kts, kte<a name='806'>
         nc1d(k)=0. <font color=#447700>! temporary placeholder, set to constant in microphysics subroutine<a name='807'></font>
         iinum=1<a name='808'>
      ENDDO<a name='809'>
   ENDIF<a name='810'>
<a name='811'>
<font color=#447700>!jdf  end do<a name='812'></font>
<a name='813'>
      call <A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_MICRO'>MORR_TWO_MOMENT_MICRO</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MP_MORR_TWO_MOMENT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MORR_TWO_MOMENT_MICRO_1">(QC_TEND1D, QI_TEND1D, QNI_TEND1D, QR_TEND1D,            &amp;<a name='814'>
       NI_TEND1D, NS_TEND1D, NR_TEND1D,                                                  &amp;<a name='815'>
       QC1D, QI1D, QS1D, QR1D,NI1D, NS1D, NR1D,                                          &amp;<a name='816'>
       T_TEND1D,QV_TEND1D, T1D, QV1D, P1D, DZ1D, W1D, WVAR1D,                   &amp;<a name='817'>
       PRECPRT1D,SNOWRT1D,                                                               &amp;<a name='818'>
       SNOWPRT1D,GRPLPRT1D,                 &amp; <font color=#447700>! hm added 7/13/13<a name='819'></font>
       EFFC1D,EFFI1D,EFFS1D,EFFR1D,DT,                                                   &amp;<a name='820'>
                                            IMS,IME, JMS,JME, KMS,KME,                   &amp;<a name='821'>
                                            ITS,ITE, JTS,JTE, KTS,KTE,                   &amp; <font color=#447700>! HM ADD GRAUPEL<a name='822'></font>
                                    QG_TEND1D,NG_TEND1D,QG1D,NG1D,EFFG1D, &amp;<a name='823'>
                                    qrcu1d, qscu1d, qicu1d, &amp;<a name='824'>
<font color=#447700>! ADD SEDIMENTATION TENDENCIES<a name='825'></font>
                                  QGSTEN,QRSTEN,QISTEN,QNISTEN,QCSTEN, &amp;<a name='826'>
                                  nc1d, nc_tend1d, iinum, C2PREC,CSED,ISED,SSED,GSED,RSED &amp; <font color=#447700>!wrf-chem<a name='827'></font>
#if (WRF_CHEM == 1)<a name='828'>
                                  ,rainprod1d, evapprod1d &amp; <font color=#447700>!wrf-chem<a name='829'></font>
#endif<a name='830'>
                       )<a name='831'>
<a name='832'>
   <font color=#447700>!<a name='833'></font>
   <font color=#447700>! Transfer 1D arrays back into 3D arrays<a name='834'></font>
   <font color=#447700>!<a name='835'></font>
      do k=kts,kte<a name='836'>
<a name='837'>
<font color=#447700>! hm, add tendencies to update global variables <a name='838'></font>
<font color=#447700>! HM, TENDENCIES FOR Q AND N NOW ADDED IN M2005MICRO, SO WE<a name='839'></font>
<font color=#447700>! ONLY NEED TO TRANSFER 1D VARIABLES BACK TO 3D<a name='840'></font>
<a name='841'>
          QC(i,k,j)        = QC1D(k)<a name='842'>
          QI(i,k,j)        = QI1D(k)<a name='843'>
          QS(i,k,j)        = QS1D(k)<a name='844'>
          QR(i,k,j)        = QR1D(k)<a name='845'>
          NI(i,k,j)        = NI1D(k)<a name='846'>
          NS(i,k,j)        = NS1D(k)          <a name='847'>
          NR(i,k,j)        = NR1D(k)<a name='848'>
	  QG(I,K,j)        = QG1D(K)<a name='849'>
          NG(I,K,j)        = NG1D(K)<a name='850'>
<a name='851'>
          T(i,k,j)         = T1D(k)<a name='852'>
          TH(I,K,J)        = T(i,k,j)/PII(i,k,j) <font color=#447700>! CONVERT TEMP BACK TO POTENTIAL TEMP<a name='853'></font>
          QV(i,k,j)        = QV1D(k)<a name='854'>
<a name='855'>
          EFFC(i,k,j)      = EFFC1D(k)<a name='856'>
          EFFI(i,k,j)      = EFFI1D(k)<a name='857'>
          EFFS(i,k,j)      = EFFS1D(k)<a name='858'>
          EFFR(i,k,j)      = EFFR1D(k)<a name='859'>
	  EFFG(I,K,j)      = EFFG1D(K)<a name='860'>
<a name='861'>
<font color=#447700>! wrf-chem<a name='862'></font>
          IF (flag_qndrop .AND. PRESENT( qndrop )) THEN<a name='863'>
             qndrop(i,k,j) = nc1d(k)<a name='864'>
<font color=#447700>!jdf         CSED3D(I,K,J) = CSED(K)<a name='865'></font>
          END IF<a name='866'>
          IF ( PRESENT( QLSINK ) ) THEN<a name='867'>
             if(qc(i,k,j)&gt;1.e-10) then<a name='868'>
                QLSINK(I,K,J)  = C2PREC(K)/QC(I,K,J)<a name='869'>
             else<a name='870'>
                QLSINK(I,K,J)  = 0.0<a name='871'>
             endif<a name='872'>
          END IF<a name='873'>
          IF ( PRESENT( PRECR ) ) PRECR(I,K,J) = RSED(K)<a name='874'>
          IF ( PRESENT( PRECI ) ) PRECI(I,K,J) = ISED(K)<a name='875'>
          IF ( PRESENT( PRECS ) ) PRECS(I,K,J) = SSED(K)<a name='876'>
          IF ( PRESENT( PRECG ) ) PRECG(I,K,J) = GSED(K)<a name='877'>
<font color=#447700>! EFFECTIVE RADIUS FOR RADIATION CODE (currently not coupled)<a name='878'></font>
<font color=#447700>! HM, ADD LIMIT TO PREVENT BLOWING UP OPTICAL PROPERTIES, 8/18/07<a name='879'></font>
<font color=#447700>!          EFFCS(I,K,J)     = MIN(EFFC(I,K,J),50.)<a name='880'></font>
<font color=#447700>!          EFFCS(I,K,J)     = MAX(EFFCS(I,K,J),1.)<a name='881'></font>
<font color=#447700>!          EFFIS(I,K,J)     = MIN(EFFI(I,K,J),130.)<a name='882'></font>
<font color=#447700>!          EFFIS(I,K,J)     = MAX(EFFIS(I,K,J),13.)<a name='883'></font>
<a name='884'>
#if ( WRF_CHEM == 1)<a name='885'>
           IF ( PRESENT( rainprod ) ) rainprod(i,k,j) = rainprod1d(k)<a name='886'>
           IF ( PRESENT( evapprod ) ) evapprod(i,k,j) = evapprod1d(k)<a name='887'>
#endif<a name='888'>
<a name='889'>
      end do<a name='890'>
<a name='891'>
<font color=#447700>! hm modified so that m2005 precip variables correctly match wrf precip variables<a name='892'></font>
      RAINNC(i,j) = RAINNC(I,J)+PRECPRT1D<a name='893'>
      RAINNCV(i,j) = PRECPRT1D<a name='894'>
<font color=#447700>! hm, added 7/13/13<a name='895'></font>
      SNOWNC(i,j) = SNOWNC(I,J)+SNOWPRT1D<a name='896'>
      SNOWNCV(i,j) = SNOWPRT1D<a name='897'>
      GRAUPELNC(i,j) = GRAUPELNC(I,J)+GRPLPRT1D<a name='898'>
      GRAUPELNCV(i,j) = GRPLPRT1D<a name='899'>
      SR(i,j) = SNOWRT1D/(PRECPRT1D+1.E-12)<a name='900'>
<a name='901'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='902'></font>
         IF ( PRESENT (diagflag) ) THEN<a name='903'>
         if (diagflag .and. do_radar_ref == 1) then<a name='904'>
          call <A href='../../html_code/phys/module_mp_morr_two_moment.F.html#REFL10CM_HM'>refl10cm_hm</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MP_MORR_TWO_MOMENT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REFL10CM_HM_3"> (qv1d, qr1d, nr1d, qs1d, ns1d, qg1d, ng1d,   &amp;<a name='905'>
                      t1d, p1d, dBZ, kts, kte, i, j)<a name='906'>
          do k = kts, kte<a name='907'>
             refl_10cm(i,k,j) = MAX(-35., dBZ(k))<a name='908'>
          enddo<a name='909'>
         endif<a name='910'>
         ENDIF<a name='911'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='912'></font>
<a name='913'>
   end do<a name='914'>
   end do   <a name='915'>
<a name='916'>
END SUBROUTINE MP_MORR_TWO_MOMENT<a name='917'>
<a name='918'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='919'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='920'></font>
<A NAME='MORR_TWO_MOMENT_MICRO'><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_MICRO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='921'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>MORR_TWO_MOMENT_MICRO</font>(QC3DTEN,QI3DTEN,QNI3DTEN,QR3DTEN,         &amp; <A href='../../call_to/MORR_TWO_MOMENT_MICRO.html' TARGET='index'>1</A>,<A href='../../call_from/MORR_TWO_MOMENT_MICRO.html' TARGET='index'>1</A><a name='922'>
       NI3DTEN,NS3DTEN,NR3DTEN,QC3D,QI3D,QNI3D,QR3D,NI3D,NS3D,NR3D,              &amp;<a name='923'>
       T3DTEN,QV3DTEN,T3D,QV3D,PRES,DZQ,W3D,WVAR,PRECRT,SNOWRT,            &amp;<a name='924'>
       SNOWPRT,GRPLPRT,                &amp; <font color=#447700>! hm added 7/13/13<a name='925'></font>
       EFFC,EFFI,EFFS,EFFR,DT,                                                   &amp;<a name='926'>
                                            IMS,IME, JMS,JME, KMS,KME,           &amp;<a name='927'>
                                            ITS,ITE, JTS,JTE, KTS,KTE,           &amp; <font color=#447700>! ADD GRAUPEL<a name='928'></font>
                        QG3DTEN,NG3DTEN,QG3D,NG3D,EFFG,qrcu1d,qscu1d, qicu1d,    &amp;<a name='929'>
                        QGSTEN,QRSTEN,QISTEN,QNISTEN,QCSTEN, &amp;<a name='930'>
                        nc3d,nc3dten,iinum, &amp; <font color=#447700>! wrf-chem<a name='931'></font>
				c2prec,CSED,ISED,SSED,GSED,RSED  &amp;  <font color=#447700>! hm added, wrf-chem<a name='932'></font>
#if (WRF_CHEM == 1)<a name='933'>
        ,rainprod, evapprod &amp;<a name='934'>
#endif<a name='935'>
                        )<a name='936'>
<a name='937'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='938'></font>
<font color=#447700>! THIS PROGRAM IS THE MAIN TWO-MOMENT MICROPHYSICS SUBROUTINE DESCRIBED BY<a name='939'></font>
<font color=#447700>! MORRISON ET AL. 2005 JAS AND MORRISON ET AL. 2009 MWR<a name='940'></font>
<a name='941'>
<font color=#447700>! THIS SCHEME IS A BULK DOUBLE-MOMENT SCHEME THAT PREDICTS MIXING<a name='942'></font>
<font color=#447700>! RATIOS AND NUMBER CONCENTRATIONS OF FIVE HYDROMETEOR SPECIES:<a name='943'></font>
<font color=#447700>! CLOUD DROPLETS, CLOUD (SMALL) ICE, RAIN, SNOW, AND GRAUPEL/HAIL.<a name='944'></font>
<a name='945'>
<font color=#447700>! CODE STRUCTURE: MAIN SUBROUTINE IS 'MORR_TWO_MOMENT'. ALSO INCLUDED IN THIS FILE IS<a name='946'></font>
<font color=#447700>! 'FUNCTION POLYSVP', 'FUNCTION DERF1', AND<a name='947'></font>
<font color=#447700>! 'FUNCTION GAMMA'.<a name='948'></font>
<a name='949'>
<font color=#447700>! NOTE: THIS SUBROUTINE USES 1D ARRAY IN VERTICAL (COLUMN), EVEN THOUGH VARIABLES ARE CALLED '3D'......<a name='950'></font>
<a name='951'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='952'></font>
<a name='953'>
<font color=#447700>! DECLARATIONS<a name='954'></font>
<a name='955'>
      IMPLICIT NONE<a name='956'>
<a name='957'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='958'></font>
<font color=#447700>! THESE VARIABLES BELOW MUST BE LINKED WITH THE MAIN MODEL.<a name='959'></font>
<font color=#447700>! DEFINE ARRAY SIZES<a name='960'></font>
<a name='961'>
<font color=#447700>! INPUT NUMBER OF GRID CELLS<a name='962'></font>
<a name='963'>
<font color=#447700>! INPUT/OUTPUT PARAMETERS                                 ! DESCRIPTION (UNITS)<a name='964'></font>
      INTEGER, INTENT( IN)  :: IMS,IME, JMS,JME, KMS,KME,          &amp;<a name='965'>
                               ITS,ITE, JTS,JTE, KTS,KTE<a name='966'>
<a name='967'>
      REAL, DIMENSION(KTS:KTE) ::  QC3DTEN            <font color=#447700>! CLOUD WATER MIXING RATIO TENDENCY (KG/KG/S)<a name='968'></font>
      REAL, DIMENSION(KTS:KTE) ::  QI3DTEN            <font color=#447700>! CLOUD ICE MIXING RATIO TENDENCY (KG/KG/S)<a name='969'></font>
      REAL, DIMENSION(KTS:KTE) ::  QNI3DTEN           <font color=#447700>! SNOW MIXING RATIO TENDENCY (KG/KG/S)<a name='970'></font>
      REAL, DIMENSION(KTS:KTE) ::  QR3DTEN            <font color=#447700>! RAIN MIXING RATIO TENDENCY (KG/KG/S)<a name='971'></font>
      REAL, DIMENSION(KTS:KTE) ::  NI3DTEN            <font color=#447700>! CLOUD ICE NUMBER CONCENTRATION (1/KG/S)<a name='972'></font>
      REAL, DIMENSION(KTS:KTE) ::  NS3DTEN            <font color=#447700>! SNOW NUMBER CONCENTRATION (1/KG/S)<a name='973'></font>
      REAL, DIMENSION(KTS:KTE) ::  NR3DTEN            <font color=#447700>! RAIN NUMBER CONCENTRATION (1/KG/S)<a name='974'></font>
      REAL, DIMENSION(KTS:KTE) ::  QC3D               <font color=#447700>! CLOUD WATER MIXING RATIO (KG/KG)<a name='975'></font>
      REAL, DIMENSION(KTS:KTE) ::  QI3D               <font color=#447700>! CLOUD ICE MIXING RATIO (KG/KG)<a name='976'></font>
      REAL, DIMENSION(KTS:KTE) ::  QNI3D              <font color=#447700>! SNOW MIXING RATIO (KG/KG)<a name='977'></font>
      REAL, DIMENSION(KTS:KTE) ::  QR3D               <font color=#447700>! RAIN MIXING RATIO (KG/KG)<a name='978'></font>
      REAL, DIMENSION(KTS:KTE) ::  NI3D               <font color=#447700>! CLOUD ICE NUMBER CONCENTRATION (1/KG)<a name='979'></font>
      REAL, DIMENSION(KTS:KTE) ::  NS3D               <font color=#447700>! SNOW NUMBER CONCENTRATION (1/KG)<a name='980'></font>
      REAL, DIMENSION(KTS:KTE) ::  NR3D               <font color=#447700>! RAIN NUMBER CONCENTRATION (1/KG)<a name='981'></font>
      REAL, DIMENSION(KTS:KTE) ::  T3DTEN             <font color=#447700>! TEMPERATURE TENDENCY (K/S)<a name='982'></font>
      REAL, DIMENSION(KTS:KTE) ::  QV3DTEN            <font color=#447700>! WATER VAPOR MIXING RATIO TENDENCY (KG/KG/S)<a name='983'></font>
      REAL, DIMENSION(KTS:KTE) ::  T3D                <font color=#447700>! TEMPERATURE (K)<a name='984'></font>
      REAL, DIMENSION(KTS:KTE) ::  QV3D               <font color=#447700>! WATER VAPOR MIXING RATIO (KG/KG)<a name='985'></font>
      REAL, DIMENSION(KTS:KTE) ::  PRES               <font color=#447700>! ATMOSPHERIC PRESSURE (PA)<a name='986'></font>
      REAL, DIMENSION(KTS:KTE) ::  DZQ                <font color=#447700>! DIFFERENCE IN HEIGHT ACROSS LEVEL (m)<a name='987'></font>
      REAL, DIMENSION(KTS:KTE) ::  W3D                <font color=#447700>! GRID-SCALE VERTICAL VELOCITY (M/S)<a name='988'></font>
      REAL, DIMENSION(KTS:KTE) ::  WVAR               <font color=#447700>! SUB-GRID VERTICAL VELOCITY (M/S)<a name='989'></font>
<font color=#447700>! below for wrf-chem<a name='990'></font>
      REAL, DIMENSION(KTS:KTE) ::  nc3d<a name='991'>
      REAL, DIMENSION(KTS:KTE) ::  nc3dten<a name='992'>
      integer, intent(in) :: iinum<a name='993'>
<a name='994'>
<font color=#447700>! HM ADDED GRAUPEL VARIABLES<a name='995'></font>
      REAL, DIMENSION(KTS:KTE) ::  QG3DTEN            <font color=#447700>! GRAUPEL MIX RATIO TENDENCY (KG/KG/S)<a name='996'></font>
      REAL, DIMENSION(KTS:KTE) ::  NG3DTEN            <font color=#447700>! GRAUPEL NUMB CONC TENDENCY (1/KG/S)<a name='997'></font>
      REAL, DIMENSION(KTS:KTE) ::  QG3D            <font color=#447700>! GRAUPEL MIX RATIO (KG/KG)<a name='998'></font>
      REAL, DIMENSION(KTS:KTE) ::  NG3D            <font color=#447700>! GRAUPEL NUMBER CONC (1/KG)<a name='999'></font>
<a name='1000'>
<font color=#447700>! HM, ADD 1/16/07, SEDIMENTATION TENDENCIES FOR MIXING RATIO<a name='1001'></font>
<a name='1002'>
      REAL, DIMENSION(KTS:KTE) ::  QGSTEN            <font color=#447700>! GRAUPEL SED TEND (KG/KG/S)<a name='1003'></font>
      REAL, DIMENSION(KTS:KTE) ::  QRSTEN            <font color=#447700>! RAIN SED TEND (KG/KG/S)<a name='1004'></font>
      REAL, DIMENSION(KTS:KTE) ::  QISTEN            <font color=#447700>! CLOUD ICE SED TEND (KG/KG/S)<a name='1005'></font>
      REAL, DIMENSION(KTS:KTE) ::  QNISTEN           <font color=#447700>! SNOW SED TEND (KG/KG/S)<a name='1006'></font>
      REAL, DIMENSION(KTS:KTE) ::  QCSTEN            <font color=#447700>! CLOUD WAT SED TEND (KG/KG/S)      <a name='1007'></font>
<a name='1008'>
<font color=#447700>! hm add cumulus tendencies for precip<a name='1009'></font>
        REAL, DIMENSION(KTS:KTE) ::   qrcu1d<a name='1010'>
        REAL, DIMENSION(KTS:KTE) ::   qscu1d<a name='1011'>
        REAL, DIMENSION(KTS:KTE) ::   qicu1d<a name='1012'>
<a name='1013'>
<font color=#447700>! OUTPUT VARIABLES<a name='1014'></font>
<a name='1015'>
        REAL PRECRT                <font color=#447700>! TOTAL PRECIP PER TIME STEP (mm)<a name='1016'></font>
        REAL SNOWRT                <font color=#447700>! SNOW PER TIME STEP (mm)<a name='1017'></font>
<font color=#447700>! hm added 7/13/13<a name='1018'></font>
        REAL SNOWPRT      <font color=#447700>! TOTAL CLOUD ICE PLUS SNOW PER TIME STEP (mm)<a name='1019'></font>
	REAL GRPLPRT	  <font color=#447700>! TOTAL GRAUPEL PER TIME STEP (mm)<a name='1020'></font>
<a name='1021'>
        REAL, DIMENSION(KTS:KTE) ::   EFFC            <font color=#447700>! DROPLET EFFECTIVE RADIUS (MICRON)<a name='1022'></font>
        REAL, DIMENSION(KTS:KTE) ::   EFFI            <font color=#447700>! CLOUD ICE EFFECTIVE RADIUS (MICRON)<a name='1023'></font>
        REAL, DIMENSION(KTS:KTE) ::   EFFS            <font color=#447700>! SNOW EFFECTIVE RADIUS (MICRON)<a name='1024'></font>
        REAL, DIMENSION(KTS:KTE) ::   EFFR            <font color=#447700>! RAIN EFFECTIVE RADIUS (MICRON)<a name='1025'></font>
        REAL, DIMENSION(KTS:KTE) ::   EFFG            <font color=#447700>! GRAUPEL EFFECTIVE RADIUS (MICRON)<a name='1026'></font>
<a name='1027'>
<font color=#447700>! MODEL INPUT PARAMETERS (FORMERLY IN COMMON BLOCKS)<a name='1028'></font>
<a name='1029'>
        REAL DT         <font color=#447700>! MODEL TIME STEP (SEC)<a name='1030'></font>
<a name='1031'>
<font color=#447700>!.....................................................................................................<a name='1032'></font>
<font color=#447700>! LOCAL VARIABLES: ALL PARAMETERS BELOW ARE LOCAL TO SCHEME AND DON'T NEED TO COMMUNICATE WITH THE<a name='1033'></font>
<font color=#447700>! REST OF THE MODEL.<a name='1034'></font>
<a name='1035'>
<font color=#447700>! SIZE PARAMETER VARIABLES<a name='1036'></font>
<a name='1037'>
     REAL, DIMENSION(KTS:KTE) :: LAMC          <font color=#447700>! SLOPE PARAMETER FOR DROPLETS (M-1)<a name='1038'></font>
     REAL, DIMENSION(KTS:KTE) :: LAMI          <font color=#447700>! SLOPE PARAMETER FOR CLOUD ICE (M-1)<a name='1039'></font>
     REAL, DIMENSION(KTS:KTE) :: LAMS          <font color=#447700>! SLOPE PARAMETER FOR SNOW (M-1)<a name='1040'></font>
     REAL, DIMENSION(KTS:KTE) :: LAMR          <font color=#447700>! SLOPE PARAMETER FOR RAIN (M-1)<a name='1041'></font>
     REAL, DIMENSION(KTS:KTE) :: LAMG          <font color=#447700>! SLOPE PARAMETER FOR GRAUPEL (M-1)<a name='1042'></font>
     REAL, DIMENSION(KTS:KTE) :: CDIST1        <font color=#447700>! PSD PARAMETER FOR DROPLETS<a name='1043'></font>
     REAL, DIMENSION(KTS:KTE) :: N0I           <font color=#447700>! INTERCEPT PARAMETER FOR CLOUD ICE (KG-1 M-1)<a name='1044'></font>
     REAL, DIMENSION(KTS:KTE) :: N0S           <font color=#447700>! INTERCEPT PARAMETER FOR SNOW (KG-1 M-1)<a name='1045'></font>
     REAL, DIMENSION(KTS:KTE) :: N0RR          <font color=#447700>! INTERCEPT PARAMETER FOR RAIN (KG-1 M-1)<a name='1046'></font>
     REAL, DIMENSION(KTS:KTE) :: N0G           <font color=#447700>! INTERCEPT PARAMETER FOR GRAUPEL (KG-1 M-1)<a name='1047'></font>
     REAL, DIMENSION(KTS:KTE) :: PGAM          <font color=#447700>! SPECTRAL SHAPE PARAMETER FOR DROPLETS<a name='1048'></font>
<a name='1049'>
<font color=#447700>! MICROPHYSICAL PROCESSES<a name='1050'></font>
<a name='1051'>
     REAL, DIMENSION(KTS:KTE) ::  NSUBC     <font color=#447700>! LOSS OF NC DURING EVAP<a name='1052'></font>
     REAL, DIMENSION(KTS:KTE) ::  NSUBI     <font color=#447700>! LOSS OF NI DURING SUB.<a name='1053'></font>
     REAL, DIMENSION(KTS:KTE) ::  NSUBS     <font color=#447700>! LOSS OF NS DURING SUB.<a name='1054'></font>
     REAL, DIMENSION(KTS:KTE) ::  NSUBR     <font color=#447700>! LOSS OF NR DURING EVAP<a name='1055'></font>
     REAL, DIMENSION(KTS:KTE) ::  PRD       <font color=#447700>! DEP CLOUD ICE<a name='1056'></font>
     REAL, DIMENSION(KTS:KTE) ::  PRE       <font color=#447700>! EVAP OF RAIN<a name='1057'></font>
     REAL, DIMENSION(KTS:KTE) ::  PRDS      <font color=#447700>! DEP SNOW<a name='1058'></font>
     REAL, DIMENSION(KTS:KTE) ::  NNUCCC    <font color=#447700>! CHANGE N DUE TO CONTACT FREEZ DROPLETS<a name='1059'></font>
     REAL, DIMENSION(KTS:KTE) ::  MNUCCC    <font color=#447700>! CHANGE Q DUE TO CONTACT FREEZ DROPLETS<a name='1060'></font>
     REAL, DIMENSION(KTS:KTE) ::  PRA       <font color=#447700>! ACCRETION DROPLETS BY RAIN<a name='1061'></font>
     REAL, DIMENSION(KTS:KTE) ::  PRC       <font color=#447700>! AUTOCONVERSION DROPLETS<a name='1062'></font>
     REAL, DIMENSION(KTS:KTE) ::  PCC       <font color=#447700>! COND/EVAP DROPLETS<a name='1063'></font>
     REAL, DIMENSION(KTS:KTE) ::  NNUCCD    <font color=#447700>! CHANGE N FREEZING AEROSOL (PRIM ICE NUCLEATION)<a name='1064'></font>
     REAL, DIMENSION(KTS:KTE) ::  MNUCCD    <font color=#447700>! CHANGE Q FREEZING AEROSOL (PRIM ICE NUCLEATION)<a name='1065'></font>
     REAL, DIMENSION(KTS:KTE) ::  MNUCCR    <font color=#447700>! CHANGE Q DUE TO CONTACT FREEZ RAIN<a name='1066'></font>
     REAL, DIMENSION(KTS:KTE) ::  NNUCCR    <font color=#447700>! CHANGE N DUE TO CONTACT FREEZ RAIN<a name='1067'></font>
     REAL, DIMENSION(KTS:KTE) ::  NPRA      <font color=#447700>! CHANGE IN N DUE TO DROPLET ACC BY RAIN<a name='1068'></font>
     REAL, DIMENSION(KTS:KTE) ::  NRAGG     <font color=#447700>! SELF-COLLECTION/BREAKUP OF RAIN<a name='1069'></font>
     REAL, DIMENSION(KTS:KTE) ::  NSAGG     <font color=#447700>! SELF-COLLECTION OF SNOW<a name='1070'></font>
     REAL, DIMENSION(KTS:KTE) ::  NPRC      <font color=#447700>! CHANGE NC AUTOCONVERSION DROPLETS<a name='1071'></font>
     REAL, DIMENSION(KTS:KTE) ::  NPRC1      <font color=#447700>! CHANGE NR AUTOCONVERSION DROPLETS<a name='1072'></font>
     REAL, DIMENSION(KTS:KTE) ::  PRAI      <font color=#447700>! CHANGE Q ACCRETION CLOUD ICE BY SNOW<a name='1073'></font>
     REAL, DIMENSION(KTS:KTE) ::  PRCI      <font color=#447700>! CHANGE Q AUTOCONVERSIN CLOUD ICE TO SNOW<a name='1074'></font>
     REAL, DIMENSION(KTS:KTE) ::  PSACWS    <font color=#447700>! CHANGE Q DROPLET ACCRETION BY SNOW<a name='1075'></font>
     REAL, DIMENSION(KTS:KTE) ::  NPSACWS   <font color=#447700>! CHANGE N DROPLET ACCRETION BY SNOW<a name='1076'></font>
     REAL, DIMENSION(KTS:KTE) ::  PSACWI    <font color=#447700>! CHANGE Q DROPLET ACCRETION BY CLOUD ICE<a name='1077'></font>
     REAL, DIMENSION(KTS:KTE) ::  NPSACWI   <font color=#447700>! CHANGE N DROPLET ACCRETION BY CLOUD ICE<a name='1078'></font>
     REAL, DIMENSION(KTS:KTE) ::  NPRCI     <font color=#447700>! CHANGE N AUTOCONVERSION CLOUD ICE BY SNOW<a name='1079'></font>
     REAL, DIMENSION(KTS:KTE) ::  NPRAI     <font color=#447700>! CHANGE N ACCRETION CLOUD ICE<a name='1080'></font>
     REAL, DIMENSION(KTS:KTE) ::  NMULTS    <font color=#447700>! ICE MULT DUE TO RIMING DROPLETS BY SNOW<a name='1081'></font>
     REAL, DIMENSION(KTS:KTE) ::  NMULTR    <font color=#447700>! ICE MULT DUE TO RIMING RAIN BY SNOW<a name='1082'></font>
     REAL, DIMENSION(KTS:KTE) ::  QMULTS    <font color=#447700>! CHANGE Q DUE TO ICE MULT DROPLETS/SNOW<a name='1083'></font>
     REAL, DIMENSION(KTS:KTE) ::  QMULTR    <font color=#447700>! CHANGE Q DUE TO ICE RAIN/SNOW<a name='1084'></font>
     REAL, DIMENSION(KTS:KTE) ::  PRACS     <font color=#447700>! CHANGE Q RAIN-SNOW COLLECTION<a name='1085'></font>
     REAL, DIMENSION(KTS:KTE) ::  NPRACS    <font color=#447700>! CHANGE N RAIN-SNOW COLLECTION<a name='1086'></font>
     REAL, DIMENSION(KTS:KTE) ::  PCCN      <font color=#447700>! CHANGE Q DROPLET ACTIVATION<a name='1087'></font>
     REAL, DIMENSION(KTS:KTE) ::  PSMLT     <font color=#447700>! CHANGE Q MELTING SNOW TO RAIN<a name='1088'></font>
     REAL, DIMENSION(KTS:KTE) ::  EVPMS     <font color=#447700>! CHNAGE Q MELTING SNOW EVAPORATING<a name='1089'></font>
     REAL, DIMENSION(KTS:KTE) ::  NSMLTS    <font color=#447700>! CHANGE N MELTING SNOW<a name='1090'></font>
     REAL, DIMENSION(KTS:KTE) ::  NSMLTR    <font color=#447700>! CHANGE N MELTING SNOW TO RAIN<a name='1091'></font>
<font color=#447700>! HM ADDED 12/13/06<a name='1092'></font>
     REAL, DIMENSION(KTS:KTE) ::  PIACR     <font color=#447700>! CHANGE QR, ICE-RAIN COLLECTION<a name='1093'></font>
     REAL, DIMENSION(KTS:KTE) ::  NIACR     <font color=#447700>! CHANGE N, ICE-RAIN COLLECTION<a name='1094'></font>
     REAL, DIMENSION(KTS:KTE) ::  PRACI     <font color=#447700>! CHANGE QI, ICE-RAIN COLLECTION<a name='1095'></font>
     REAL, DIMENSION(KTS:KTE) ::  PIACRS     <font color=#447700>! CHANGE QR, ICE RAIN COLLISION, ADDED TO SNOW<a name='1096'></font>
     REAL, DIMENSION(KTS:KTE) ::  NIACRS     <font color=#447700>! CHANGE N, ICE RAIN COLLISION, ADDED TO SNOW<a name='1097'></font>
     REAL, DIMENSION(KTS:KTE) ::  PRACIS     <font color=#447700>! CHANGE QI, ICE RAIN COLLISION, ADDED TO SNOW<a name='1098'></font>
     REAL, DIMENSION(KTS:KTE) ::  EPRD      <font color=#447700>! SUBLIMATION CLOUD ICE<a name='1099'></font>
     REAL, DIMENSION(KTS:KTE) ::  EPRDS     <font color=#447700>! SUBLIMATION SNOW<a name='1100'></font>
<font color=#447700>! HM ADDED GRAUPEL PROCESSES<a name='1101'></font>
     REAL, DIMENSION(KTS:KTE) ::  PRACG    <font color=#447700>! CHANGE IN Q COLLECTION RAIN BY GRAUPEL<a name='1102'></font>
     REAL, DIMENSION(KTS:KTE) ::  PSACWG    <font color=#447700>! CHANGE IN Q COLLECTION DROPLETS BY GRAUPEL<a name='1103'></font>
     REAL, DIMENSION(KTS:KTE) ::  PGSACW    <font color=#447700>! CONVERSION Q TO GRAUPEL DUE TO COLLECTION DROPLETS BY SNOW<a name='1104'></font>
     REAL, DIMENSION(KTS:KTE) ::  PGRACS    <font color=#447700>! CONVERSION Q TO GRAUPEL DUE TO COLLECTION RAIN BY SNOW<a name='1105'></font>
     REAL, DIMENSION(KTS:KTE) ::  PRDG    <font color=#447700>! DEP OF GRAUPEL<a name='1106'></font>
     REAL, DIMENSION(KTS:KTE) ::  EPRDG    <font color=#447700>! SUB OF GRAUPEL<a name='1107'></font>
     REAL, DIMENSION(KTS:KTE) ::  EVPMG    <font color=#447700>! CHANGE Q MELTING OF GRAUPEL AND EVAPORATION<a name='1108'></font>
     REAL, DIMENSION(KTS:KTE) ::  PGMLT    <font color=#447700>! CHANGE Q MELTING OF GRAUPEL<a name='1109'></font>
     REAL, DIMENSION(KTS:KTE) ::  NPRACG    <font color=#447700>! CHANGE N COLLECTION RAIN BY GRAUPEL<a name='1110'></font>
     REAL, DIMENSION(KTS:KTE) ::  NPSACWG    <font color=#447700>! CHANGE N COLLECTION DROPLETS BY GRAUPEL<a name='1111'></font>
     REAL, DIMENSION(KTS:KTE) ::  NSCNG    <font color=#447700>! CHANGE N CONVERSION TO GRAUPEL DUE TO COLLECTION DROPLETS BY SNOW<a name='1112'></font>
     REAL, DIMENSION(KTS:KTE) ::  NGRACS    <font color=#447700>! CHANGE N CONVERSION TO GRAUPEL DUE TO COLLECTION RAIN BY SNOW<a name='1113'></font>
     REAL, DIMENSION(KTS:KTE) ::  NGMLTG    <font color=#447700>! CHANGE N MELTING GRAUPEL<a name='1114'></font>
     REAL, DIMENSION(KTS:KTE) ::  NGMLTR    <font color=#447700>! CHANGE N MELTING GRAUPEL TO RAIN<a name='1115'></font>
     REAL, DIMENSION(KTS:KTE) ::  NSUBG    <font color=#447700>! CHANGE N SUB/DEP OF GRAUPEL<a name='1116'></font>
     REAL, DIMENSION(KTS:KTE) ::  PSACR    <font color=#447700>! CONVERSION DUE TO COLL OF SNOW BY RAIN<a name='1117'></font>
     REAL, DIMENSION(KTS:KTE) ::  NMULTG    <font color=#447700>! ICE MULT DUE TO ACC DROPLETS BY GRAUPEL<a name='1118'></font>
     REAL, DIMENSION(KTS:KTE) ::  NMULTRG    <font color=#447700>! ICE MULT DUE TO ACC RAIN BY GRAUPEL<a name='1119'></font>
     REAL, DIMENSION(KTS:KTE) ::  QMULTG    <font color=#447700>! CHANGE Q DUE TO ICE MULT DROPLETS/GRAUPEL<a name='1120'></font>
     REAL, DIMENSION(KTS:KTE) ::  QMULTRG    <font color=#447700>! CHANGE Q DUE TO ICE MULT RAIN/GRAUPEL<a name='1121'></font>
<a name='1122'>
<font color=#447700>! TIME-VARYING ATMOSPHERIC PARAMETERS<a name='1123'></font>
<a name='1124'>
     REAL, DIMENSION(KTS:KTE) ::   KAP   <font color=#447700>! THERMAL CONDUCTIVITY OF AIR<a name='1125'></font>
     REAL, DIMENSION(KTS:KTE) ::   EVS   <font color=#447700>! SATURATION VAPOR PRESSURE<a name='1126'></font>
     REAL, DIMENSION(KTS:KTE) ::   EIS   <font color=#447700>! ICE SATURATION VAPOR PRESSURE<a name='1127'></font>
     REAL, DIMENSION(KTS:KTE) ::   QVS   <font color=#447700>! SATURATION MIXING RATIO<a name='1128'></font>
     REAL, DIMENSION(KTS:KTE) ::   QVI   <font color=#447700>! ICE SATURATION MIXING RATIO<a name='1129'></font>
     REAL, DIMENSION(KTS:KTE) ::   QVQVS <font color=#447700>! SAUTRATION RATIO<a name='1130'></font>
     REAL, DIMENSION(KTS:KTE) ::   QVQVSI<font color=#447700>! ICE SATURAION RATIO<a name='1131'></font>
     REAL, DIMENSION(KTS:KTE) ::   DV    <font color=#447700>! DIFFUSIVITY OF WATER VAPOR IN AIR<a name='1132'></font>
     REAL, DIMENSION(KTS:KTE) ::   XXLS  <font color=#447700>! LATENT HEAT OF SUBLIMATION<a name='1133'></font>
     REAL, DIMENSION(KTS:KTE) ::   XXLV  <font color=#447700>! LATENT HEAT OF VAPORIZATION<a name='1134'></font>
     REAL, DIMENSION(KTS:KTE) ::   CPM   <font color=#447700>! SPECIFIC HEAT AT CONST PRESSURE FOR MOIST AIR<a name='1135'></font>
     REAL, DIMENSION(KTS:KTE) ::   MU    <font color=#447700>! VISCOCITY OF AIR<a name='1136'></font>
     REAL, DIMENSION(KTS:KTE) ::   SC    <font color=#447700>! SCHMIDT NUMBER<a name='1137'></font>
     REAL, DIMENSION(KTS:KTE) ::   XLF   <font color=#447700>! LATENT HEAT OF FREEZING<a name='1138'></font>
     REAL, DIMENSION(KTS:KTE) ::   RHO   <font color=#447700>! AIR DENSITY<a name='1139'></font>
     REAL, DIMENSION(KTS:KTE) ::   AB    <font color=#447700>! CORRECTION TO CONDENSATION RATE DUE TO LATENT HEATING<a name='1140'></font>
     REAL, DIMENSION(KTS:KTE) ::   ABI    <font color=#447700>! CORRECTION TO DEPOSITION RATE DUE TO LATENT HEATING<a name='1141'></font>
<a name='1142'>
<font color=#447700>! TIME-VARYING MICROPHYSICS PARAMETERS<a name='1143'></font>
<a name='1144'>
     REAL, DIMENSION(KTS:KTE) ::   DAP    <font color=#447700>! DIFFUSIVITY OF AEROSOL<a name='1145'></font>
     REAL    NACNT                    <font color=#447700>! NUMBER OF CONTACT IN<a name='1146'></font>
     REAL    FMULT                    <font color=#447700>! TEMP.-DEP. PARAMETER FOR RIME-SPLINTERING<a name='1147'></font>
     REAL    COFFI                    <font color=#447700>! ICE AUTOCONVERSION PARAMETER<a name='1148'></font>
<a name='1149'>
<font color=#447700>! FALL SPEED WORKING VARIABLES (DEFINED IN CODE)<a name='1150'></font>
<a name='1151'>
      REAL, DIMENSION(KTS:KTE) ::    DUMI,DUMR,DUMFNI,DUMG,DUMFNG<a name='1152'>
      REAL UNI, UMI,UMR<a name='1153'>
      REAL, DIMENSION(KTS:KTE) ::    FR, FI, FNI,FG,FNG<a name='1154'>
      REAL RGVM<a name='1155'>
      REAL, DIMENSION(KTS:KTE) ::   FALOUTR,FALOUTI,FALOUTNI<a name='1156'>
      REAL FALTNDR,FALTNDI,FALTNDNI,RHO2<a name='1157'>
      REAL, DIMENSION(KTS:KTE) ::   DUMQS,DUMFNS<a name='1158'>
      REAL UMS,UNS<a name='1159'>
      REAL, DIMENSION(KTS:KTE) ::   FS,FNS, FALOUTS,FALOUTNS,FALOUTG,FALOUTNG<a name='1160'>
      REAL FALTNDS,FALTNDNS,UNR,FALTNDG,FALTNDNG<a name='1161'>
      REAL, DIMENSION(KTS:KTE) ::    DUMC,DUMFNC<a name='1162'>
      REAL UNC,UMC,UNG,UMG<a name='1163'>
      REAL, DIMENSION(KTS:KTE) ::   FC,FALOUTC,FALOUTNC<a name='1164'>
      REAL FALTNDC,FALTNDNC<a name='1165'>
      REAL, DIMENSION(KTS:KTE) ::   FNC,DUMFNR,FALOUTNR<a name='1166'>
      REAL FALTNDNR<a name='1167'>
      REAL, DIMENSION(KTS:KTE) ::   FNR<a name='1168'>
<a name='1169'>
<font color=#447700>! FALL-SPEED PARAMETER 'A' WITH AIR DENSITY CORRECTION<a name='1170'></font>
<a name='1171'>
      REAL, DIMENSION(KTS:KTE) ::    AIN,ARN,ASN,ACN,AGN<a name='1172'>
<a name='1173'>
<font color=#447700>! EXTERNAL FUNCTION CALL RETURN VARIABLES<a name='1174'></font>
<a name='1175'>
<font color=#447700>!      REAL GAMMA,      ! EULER GAMMA FUNCTION<a name='1176'></font>
<font color=#447700>!      REAL POLYSVP,    ! SAT. PRESSURE FUNCTION<a name='1177'></font>
<font color=#447700>!      REAL DERF1        ! ERROR FUNCTION<a name='1178'></font>
<a name='1179'>
<font color=#447700>! DUMMY VARIABLES<a name='1180'></font>
<a name='1181'>
     REAL DUM,DUM1,DUM2,DUMT,DUMQV,DUMQSS,DUMQSI,DUMS<a name='1182'>
<a name='1183'>
<font color=#447700>! PROGNOSTIC SUPERSATURATION<a name='1184'></font>
<a name='1185'>
     REAL DQSDT    <font color=#447700>! CHANGE OF SAT. MIX. RAT. WITH TEMPERATURE<a name='1186'></font>
     REAL DQSIDT   <font color=#447700>! CHANGE IN ICE SAT. MIXING RAT. WITH T<a name='1187'></font>
     REAL EPSI     <font color=#447700>! 1/PHASE REL. TIME (SEE M2005), ICE<a name='1188'></font>
     REAL EPSS     <font color=#447700>! 1/PHASE REL. TIME (SEE M2005), SNOW<a name='1189'></font>
     REAL EPSR     <font color=#447700>! 1/PHASE REL. TIME (SEE M2005), RAIN<a name='1190'></font>
     REAL EPSG     <font color=#447700>! 1/PHASE REL. TIME (SEE M2005), GRAUPEL<a name='1191'></font>
<a name='1192'>
<font color=#447700>! NEW DROPLET ACTIVATION VARIABLES<a name='1193'></font>
     REAL TAUC     <font color=#447700>! PHASE REL. TIME (SEE M2005), DROPLETS<a name='1194'></font>
     REAL TAUR     <font color=#447700>! PHASE REL. TIME (SEE M2005), RAIN<a name='1195'></font>
     REAL TAUI     <font color=#447700>! PHASE REL. TIME (SEE M2005), CLOUD ICE<a name='1196'></font>
     REAL TAUS     <font color=#447700>! PHASE REL. TIME (SEE M2005), SNOW<a name='1197'></font>
     REAL TAUG     <font color=#447700>! PHASE REL. TIME (SEE M2005), GRAUPEL<a name='1198'></font>
     REAL DUMACT,DUM3<a name='1199'>
<a name='1200'>
<font color=#447700>! COUNTING/INDEX VARIABLES<a name='1201'></font>
<a name='1202'>
     INTEGER K,NSTEP,N <font color=#447700>! ,I<a name='1203'></font>
<a name='1204'>
<font color=#447700>! LTRUE IS ONLY USED TO SPEED UP THE CODE !!<a name='1205'></font>
<font color=#447700>! LTRUE, SWITCH = 0, NO HYDROMETEORS IN COLUMN, <a name='1206'></font>
<font color=#447700>!               = 1, HYDROMETEORS IN COLUMN<a name='1207'></font>
<a name='1208'>
      INTEGER LTRUE<a name='1209'>
<a name='1210'>
<font color=#447700>! DROPLET ACTIVATION/FREEZING AEROSOL<a name='1211'></font>
<a name='1212'>
<a name='1213'>
     REAL    CT      <font color=#447700>! DROPLET ACTIVATION PARAMETER<a name='1214'></font>
     REAL    TEMP1   <font color=#447700>! DUMMY TEMPERATURE<a name='1215'></font>
     REAL    SAT1    <font color=#447700>! DUMMY SATURATION<a name='1216'></font>
     REAL    SIGVL   <font color=#447700>! SURFACE TENSION LIQ/VAPOR<a name='1217'></font>
     REAL    KEL     <font color=#447700>! KELVIN PARAMETER<a name='1218'></font>
     REAL    KC2     <font color=#447700>! TOTAL ICE NUCLEATION RATE<a name='1219'></font>
<a name='1220'>
       REAL CRY,KRY   <font color=#447700>! AEROSOL ACTIVATION PARAMETERS<a name='1221'></font>
<a name='1222'>
<font color=#447700>! MORE WORKING/DUMMY VARIABLES<a name='1223'></font>
<a name='1224'>
     REAL DUMQI,DUMNI,DC0,DS0,DG0<a name='1225'>
     REAL DUMQC,DUMQR,RATIO,SUM_DEP,FUDGEF<a name='1226'>
<a name='1227'>
<font color=#447700>! EFFECTIVE VERTICAL VELOCITY  (M/S)<a name='1228'></font>
     REAL WEF<a name='1229'>
<a name='1230'>
<font color=#447700>! WORKING PARAMETERS FOR ICE NUCLEATION<a name='1231'></font>
<a name='1232'>
      REAL ANUC,BNUC<a name='1233'>
<a name='1234'>
<font color=#447700>! WORKING PARAMETERS FOR AEROSOL ACTIVATION<a name='1235'></font>
<a name='1236'>
        REAL AACT,GAMM,GG,PSI,ETA1,ETA2,SM1,SM2,SMAX,UU1,UU2,ALPHA<a name='1237'>
<a name='1238'>
<font color=#447700>! DUMMY SIZE DISTRIBUTION PARAMETERS<a name='1239'></font>
<a name='1240'>
        REAL DLAMS,DLAMR,DLAMI,DLAMC,DLAMG,LAMMAX,LAMMIN<a name='1241'>
<a name='1242'>
        INTEGER IDROP<a name='1243'>
<a name='1244'>
<font color=#447700>! FOR WRF-CHEM<a name='1245'></font>
	REAL, DIMENSION(KTS:KTE)::C2PREC,CSED,ISED,SSED,GSED,RSED<a name='1246'>
#if (WRF_CHEM == 1)<a name='1247'>
    REAL, DIMENSION(KTS:KTE), INTENT(INOUT) :: rainprod, evapprod<a name='1248'>
#endif<a name='1249'>
    REAL, DIMENSION(KTS:KTE)                :: tqimelt <font color=#447700>! melting of cloud ice (tendency)<a name='1250'></font>
<a name='1251'>
<font color=#447700>! comment lines for wrf-chem since these are intent(in) in that case<a name='1252'></font>
<font color=#447700>!       REAL, DIMENSION(KTS:KTE) ::  NC3DTEN            ! CLOUD DROPLET NUMBER CONCENTRATION (1/KG/S)<a name='1253'></font>
<font color=#447700>!       REAL, DIMENSION(KTS:KTE) ::  NC3D               ! CLOUD DROPLET NUMBER CONCENTRATION (1/KG)<a name='1254'></font>
<a name='1255'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1256'></font>
<a name='1257'>
<font color=#447700>! SET LTRUE INITIALLY TO 0<a name='1258'></font>
<a name='1259'>
         LTRUE = 0<a name='1260'>
<a name='1261'>
<font color=#447700>! ATMOSPHERIC PARAMETERS THAT VARY IN TIME AND HEIGHT<a name='1262'></font>
         DO K = KTS,KTE<a name='1263'>
<a name='1264'>
<font color=#447700>! NC3DTEN LOCAL ARRAY INITIALIZED<a name='1265'></font>
               NC3DTEN(K) = 0.<a name='1266'>
<font color=#447700>! INITIALIZE VARIABLES FOR WRF-CHEM OUTPUT TO ZERO<a name='1267'></font>
<a name='1268'>
		C2PREC(K)=0.<a name='1269'>
		CSED(K)=0.<a name='1270'>
		ISED(K)=0.<a name='1271'>
		SSED(K)=0.<a name='1272'>
		GSED(K)=0.<a name='1273'>
		RSED(K)=0.<a name='1274'>
<a name='1275'>
#if (WRF_CHEM == 1)<a name='1276'>
         rainprod(K) = 0.<a name='1277'>
         evapprod(K) = 0.<a name='1278'>
         tqimelt(K)  = 0.<a name='1279'>
         PRC(K)      = 0.<a name='1280'>
         PRA(K)      = 0.<a name='1281'>
#endif<a name='1282'>
<a name='1283'>
<font color=#447700>! LATENT HEAT OF VAPORATION<a name='1284'></font>
<a name='1285'>
            XXLV(K) = 3.1484E6-2370.*T3D(K)<a name='1286'>
<a name='1287'>
<font color=#447700>! LATENT HEAT OF SUBLIMATION<a name='1288'></font>
<a name='1289'>
            XXLS(K) = 3.15E6-2370.*T3D(K)+0.3337E6<a name='1290'>
<a name='1291'>
            CPM(K) = CP*(1.+0.887*QV3D(K))<a name='1292'>
<a name='1293'>
<font color=#447700>! SATURATION VAPOR PRESSURE AND MIXING RATIO<a name='1294'></font>
<a name='1295'>
<font color=#447700>! hm, add fix for low pressure, 5/12/10<a name='1296'></font>
            EVS(K) = min(0.99*pres(k),POLYSVP(T3D(K),0))   <font color=#447700>! PA<a name='1297'></font>
            EIS(K) = min(0.99*pres(k),POLYSVP(T3D(K),1))   <font color=#447700>! PA<a name='1298'></font>
<a name='1299'>
<font color=#447700>! MAKE SURE ICE SATURATION DOESN'T EXCEED WATER SAT. NEAR FREEZING<a name='1300'></font>
<a name='1301'>
            IF (EIS(K).GT.EVS(K)) EIS(K) = EVS(K)<a name='1302'>
<a name='1303'>
            QVS(K) = EP_2*EVS(K)/(PRES(K)-EVS(K))<a name='1304'>
            QVI(K) = EP_2*EIS(K)/(PRES(K)-EIS(K))<a name='1305'>
<a name='1306'>
            QVQVS(K) = QV3D(K)/QVS(K)<a name='1307'>
            QVQVSI(K) = QV3D(K)/QVI(K)<a name='1308'>
<a name='1309'>
<font color=#447700>! AIR DENSITY<a name='1310'></font>
<a name='1311'>
            RHO(K) = PRES(K)/(R*T3D(K))<a name='1312'>
<a name='1313'>
<font color=#447700>! ADD NUMBER CONCENTRATION DUE TO CUMULUS TENDENCY<a name='1314'></font>
<font color=#447700>! ASSUME N0 ASSOCIATED WITH CUMULUS PARAM RAIN IS 10^7 M^-4<a name='1315'></font>
<font color=#447700>! ASSUME N0 ASSOCIATED WITH CUMULUS PARAM SNOW IS 2 X 10^7 M^-4<a name='1316'></font>
<font color=#447700>! FOR DETRAINED CLOUD ICE, ASSUME MEAN VOLUME DIAM OF 80 MICRON<a name='1317'></font>
<a name='1318'>
            IF (QRCU1D(K).GE.1.E-10) THEN<a name='1319'>
            DUM=1.8e5*(QRCU1D(K)*DT/(PI*RHOW*RHO(K)**3))**0.25<a name='1320'>
            NR3D(K)=NR3D(K)+DUM<a name='1321'>
            END IF<a name='1322'>
            IF (QSCU1D(K).GE.1.E-10) THEN<a name='1323'>
            DUM=3.e5*(QSCU1D(K)*DT/(CONS1*RHO(K)**3))**(1./(DS+1.))<a name='1324'>
            NS3D(K)=NS3D(K)+DUM<a name='1325'>
            END IF<a name='1326'>
            IF (QICU1D(K).GE.1.E-10) THEN<a name='1327'>
            DUM=QICU1D(K)*DT/(CI*(80.E-6)**DI)<a name='1328'>
            NI3D(K)=NI3D(K)+DUM<a name='1329'>
            END IF<a name='1330'>
<a name='1331'>
<font color=#447700>! AT SUBSATURATION, REMOVE SMALL AMOUNTS OF CLOUD/PRECIP WATER<a name='1332'></font>
<font color=#447700>! hm modify 7/0/09 change limit to 1.e-8<a name='1333'></font>
<a name='1334'>
             IF (QVQVS(K).LT.0.9) THEN<a name='1335'>
               IF (QR3D(K).LT.1.E-8) THEN<a name='1336'>
                  QV3D(K)=QV3D(K)+QR3D(K)<a name='1337'>
                  T3D(K)=T3D(K)-QR3D(K)*XXLV(K)/CPM(K)<a name='1338'>
                  QR3D(K)=0.<a name='1339'>
               END IF<a name='1340'>
               IF (QC3D(K).LT.1.E-8) THEN<a name='1341'>
                  QV3D(K)=QV3D(K)+QC3D(K)<a name='1342'>
                  T3D(K)=T3D(K)-QC3D(K)*XXLV(K)/CPM(K)<a name='1343'>
                  QC3D(K)=0.<a name='1344'>
               END IF<a name='1345'>
             END IF<a name='1346'>
<a name='1347'>
             IF (QVQVSI(K).LT.0.9) THEN<a name='1348'>
               IF (QI3D(K).LT.1.E-8) THEN<a name='1349'>
                  QV3D(K)=QV3D(K)+QI3D(K)<a name='1350'>
                  T3D(K)=T3D(K)-QI3D(K)*XXLS(K)/CPM(K)<a name='1351'>
                  QI3D(K)=0.<a name='1352'>
               END IF<a name='1353'>
               IF (QNI3D(K).LT.1.E-8) THEN<a name='1354'>
                  QV3D(K)=QV3D(K)+QNI3D(K)<a name='1355'>
                  T3D(K)=T3D(K)-QNI3D(K)*XXLS(K)/CPM(K)<a name='1356'>
                  QNI3D(K)=0.<a name='1357'>
               END IF<a name='1358'>
               IF (QG3D(K).LT.1.E-8) THEN<a name='1359'>
                  QV3D(K)=QV3D(K)+QG3D(K)<a name='1360'>
                  T3D(K)=T3D(K)-QG3D(K)*XXLS(K)/CPM(K)<a name='1361'>
                  QG3D(K)=0.<a name='1362'>
               END IF<a name='1363'>
             END IF<a name='1364'>
<a name='1365'>
<font color=#447700>! HEAT OF FUSION<a name='1366'></font>
<a name='1367'>
            XLF(K) = XXLS(K)-XXLV(K)<a name='1368'>
<a name='1369'>
<font color=#447700>!..................................................................<a name='1370'></font>
<font color=#447700>! IF MIXING RATIO &lt; QSMALL SET MIXING RATIO AND NUMBER CONC TO ZERO<a name='1371'></font>
<a name='1372'>
       IF (QC3D(K).LT.QSMALL) THEN<a name='1373'>
         QC3D(K) = 0.<a name='1374'>
         NC3D(K) = 0.<a name='1375'>
         EFFC(K) = 0.<a name='1376'>
       END IF<a name='1377'>
       IF (QR3D(K).LT.QSMALL) THEN<a name='1378'>
         QR3D(K) = 0.<a name='1379'>
         NR3D(K) = 0.<a name='1380'>
         EFFR(K) = 0.<a name='1381'>
       END IF<a name='1382'>
       IF (QI3D(K).LT.QSMALL) THEN<a name='1383'>
         QI3D(K) = 0.<a name='1384'>
         NI3D(K) = 0.<a name='1385'>
         EFFI(K) = 0.<a name='1386'>
       END IF<a name='1387'>
       IF (QNI3D(K).LT.QSMALL) THEN<a name='1388'>
         QNI3D(K) = 0.<a name='1389'>
         NS3D(K) = 0.<a name='1390'>
         EFFS(K) = 0.<a name='1391'>
       END IF<a name='1392'>
       IF (QG3D(K).LT.QSMALL) THEN<a name='1393'>
         QG3D(K) = 0.<a name='1394'>
         NG3D(K) = 0.<a name='1395'>
         EFFG(K) = 0.<a name='1396'>
       END IF<a name='1397'>
<a name='1398'>
<font color=#447700>! INITIALIZE SEDIMENTATION TENDENCIES FOR MIXING RATIO<a name='1399'></font>
<a name='1400'>
      QRSTEN(K) = 0.<a name='1401'>
      QISTEN(K) = 0.<a name='1402'>
      QNISTEN(K) = 0.<a name='1403'>
      QCSTEN(K) = 0.<a name='1404'>
      QGSTEN(K) = 0.<a name='1405'>
<a name='1406'>
<font color=#447700>!..................................................................<a name='1407'></font>
<font color=#447700>! MICROPHYSICS PARAMETERS VARYING IN TIME/HEIGHT<a name='1408'></font>
<a name='1409'>
<font color=#447700>! fix 053011<a name='1410'></font>
            MU(K) = 1.496E-6*T3D(K)**1.5/(T3D(K)+120.)<a name='1411'>
<a name='1412'>
<font color=#447700>! FALL SPEED WITH DENSITY CORRECTION (HEYMSFIELD AND BENSSEMER 2006)<a name='1413'></font>
<a name='1414'>
            DUM = (RHOSU/RHO(K))**0.54<a name='1415'>
<a name='1416'>
<font color=#447700>! fix 053011<a name='1417'></font>
<font color=#447700>!            AIN(K) = DUM*AI<a name='1418'></font>
<font color=#447700>! AA revision 4/1/11: Ikawa and Saito 1991 air-density correction <a name='1419'></font>
            AIN(K) = (RHOSU/RHO(K))**0.35*AI<a name='1420'>
            ARN(K) = DUM*AR<a name='1421'>
            ASN(K) = DUM*AS<a name='1422'>
<font color=#447700>!            ACN(K) = DUM*AC<a name='1423'></font>
<font color=#447700>! AA revision 4/1/11: temperature-dependent Stokes fall speed<a name='1424'></font>
            ACN(K) = G*RHOW/(18.*MU(K))<a name='1425'>
<font color=#447700>! HM ADD GRAUPEL 8/28/06<a name='1426'></font>
            AGN(K) = DUM*AG<a name='1427'>
<a name='1428'>
<font color=#447700>!hm 4/7/09 bug fix, initialize lami to prevent later division by zero<a name='1429'></font>
            LAMI(K)=0.<a name='1430'>
<a name='1431'>
<font color=#447700>!..................................<a name='1432'></font>
<font color=#447700>! IF THERE IS NO CLOUD/PRECIP WATER, AND IF SUBSATURATED, THEN SKIP MICROPHYSICS<a name='1433'></font>
<font color=#447700>! FOR THIS LEVEL<a name='1434'></font>
<a name='1435'>
            IF (QC3D(K).LT.QSMALL.AND.QI3D(K).LT.QSMALL.AND.QNI3D(K).LT.QSMALL &amp;<a name='1436'>
                 .AND.QR3D(K).LT.QSMALL.AND.QG3D(K).LT.QSMALL) THEN<a name='1437'>
                 IF (T3D(K).LT.273.15.AND.QVQVSI(K).LT.0.999) GOTO 200<a name='1438'>
                 IF (T3D(K).GE.273.15.AND.QVQVS(K).LT.0.999) GOTO 200<a name='1439'>
            END IF<a name='1440'>
<a name='1441'>
<font color=#447700>! THERMAL CONDUCTIVITY FOR AIR<a name='1442'></font>
<a name='1443'>
<font color=#447700>! fix 053011<a name='1444'></font>
            KAP(K) = 1.414E3*MU(K)<a name='1445'>
<a name='1446'>
<font color=#447700>! DIFFUSIVITY OF WATER VAPOR<a name='1447'></font>
<a name='1448'>
            DV(K) = 8.794E-5*T3D(K)**1.81/PRES(K)<a name='1449'>
<a name='1450'>
<font color=#447700>! SCHMIT NUMBER<a name='1451'></font>
<a name='1452'>
<font color=#447700>! fix 053011<a name='1453'></font>
            SC(K) = MU(K)/(RHO(K)*DV(K))<a name='1454'>
<a name='1455'>
<font color=#447700>! PSYCHOMETIC CORRECTIONS<a name='1456'></font>
<a name='1457'>
<font color=#447700>! RATE OF CHANGE SAT. MIX. RATIO WITH TEMPERATURE<a name='1458'></font>
<a name='1459'>
            DUM = (RV*T3D(K)**2)<a name='1460'>
<a name='1461'>
            DQSDT = XXLV(K)*QVS(K)/DUM<a name='1462'>
            DQSIDT =  XXLS(K)*QVI(K)/DUM<a name='1463'>
<a name='1464'>
            ABI(K) = 1.+DQSIDT*XXLS(K)/CPM(K)<a name='1465'>
            AB(K) = 1.+DQSDT*XXLV(K)/CPM(K)<a name='1466'>
<a name='1467'>
<font color=#447700>! <a name='1468'></font>
<font color=#447700>!.....................................................................<a name='1469'></font>
<font color=#447700>!.....................................................................<a name='1470'></font>
<font color=#447700>! CASE FOR TEMPERATURE ABOVE FREEZING<a name='1471'></font>
<a name='1472'>
            IF (T3D(K).GE.273.15) THEN<a name='1473'>
<a name='1474'>
<font color=#447700>!......................................................................<a name='1475'></font>
<font color=#447700>!HM ADD, ALLOW FOR CONSTANT DROPLET NUMBER<a name='1476'></font>
<font color=#447700>! INUM = 0, PREDICT DROPLET NUMBER<a name='1477'></font>
<font color=#447700>! INUM = 1, SET CONSTANT DROPLET NUMBER<a name='1478'></font>
<a name='1479'>
         IF (iinum.EQ.1) THEN<a name='1480'>
<font color=#447700>! CONVERT NDCNST FROM CM-3 TO KG-1<a name='1481'></font>
            NC3D(K)=NDCNST*1.E6/RHO(K)<a name='1482'>
         END IF<a name='1483'>
<a name='1484'>
<font color=#447700>! GET SIZE DISTRIBUTION PARAMETERS<a name='1485'></font>
<a name='1486'>
<font color=#447700>! MELT VERY SMALL SNOW AND GRAUPEL MIXING RATIOS, ADD TO RAIN<a name='1487'></font>
       IF (QNI3D(K).LT.1.E-6) THEN<a name='1488'>
          QR3D(K)=QR3D(K)+QNI3D(K)<a name='1489'>
          NR3D(K)=NR3D(K)+NS3D(K)<a name='1490'>
          T3D(K)=T3D(K)-QNI3D(K)*XLF(K)/CPM(K)<a name='1491'>
          QNI3D(K) = 0.<a name='1492'>
          NS3D(K) = 0.<a name='1493'>
       END IF<a name='1494'>
       IF (QG3D(K).LT.1.E-6) THEN<a name='1495'>
          QR3D(K)=QR3D(K)+QG3D(K)<a name='1496'>
          NR3D(K)=NR3D(K)+NG3D(K)<a name='1497'>
          T3D(K)=T3D(K)-QG3D(K)*XLF(K)/CPM(K)<a name='1498'>
          QG3D(K) = 0.<a name='1499'>
          NG3D(K) = 0.<a name='1500'>
       END IF<a name='1501'>
<a name='1502'>
       IF (QC3D(K).LT.QSMALL.AND.QNI3D(K).LT.1.E-8.AND.QR3D(K).LT.QSMALL.AND.QG3D(K).LT.1.E-8) GOTO 300<a name='1503'>
<a name='1504'>
<font color=#447700>! MAKE SURE NUMBER CONCENTRATIONS AREN'T NEGATIVE<a name='1505'></font>
<a name='1506'>
      NS3D(K) = MAX(0.,NS3D(K))<a name='1507'>
      NC3D(K) = MAX(0.,NC3D(K))<a name='1508'>
      NR3D(K) = MAX(0.,NR3D(K))<a name='1509'>
      NG3D(K) = MAX(0.,NG3D(K))<a name='1510'>
<a name='1511'>
<font color=#447700>!......................................................................<a name='1512'></font>
<font color=#447700>! RAIN<a name='1513'></font>
<a name='1514'>
      IF (QR3D(K).GE.QSMALL) THEN<a name='1515'>
      LAMR(K) = (PI*RHOW*NR3D(K)/QR3D(K))**(1./3.)<a name='1516'>
      N0RR(K) = NR3D(K)*LAMR(K)<a name='1517'>
<a name='1518'>
<font color=#447700>! CHECK FOR SLOPE<a name='1519'></font>
<a name='1520'>
<font color=#447700>! ADJUST VARS<a name='1521'></font>
<a name='1522'>
      IF (LAMR(K).LT.LAMMINR) THEN<a name='1523'>
<a name='1524'>
      LAMR(K) = LAMMINR<a name='1525'>
<a name='1526'>
      N0RR(K) = LAMR(K)**4*QR3D(K)/(PI*RHOW)<a name='1527'>
<a name='1528'>
      NR3D(K) = N0RR(K)/LAMR(K)<a name='1529'>
      ELSE IF (LAMR(K).GT.LAMMAXR) THEN<a name='1530'>
      LAMR(K) = LAMMAXR<a name='1531'>
      N0RR(K) = LAMR(K)**4*QR3D(K)/(PI*RHOW)<a name='1532'>
<a name='1533'>
      NR3D(K) = N0RR(K)/LAMR(K)<a name='1534'>
      END IF<a name='1535'>
      END IF<a name='1536'>
<a name='1537'>
<font color=#447700>!......................................................................<a name='1538'></font>
<font color=#447700>! CLOUD DROPLETS<a name='1539'></font>
<a name='1540'>
<font color=#447700>! MARTIN ET AL. (1994) FORMULA FOR PGAM<a name='1541'></font>
<a name='1542'>
      IF (QC3D(K).GE.QSMALL) THEN<a name='1543'>
<a name='1544'>
         DUM = PRES(K)/(287.15*T3D(K))<a name='1545'>
         PGAM(K)=0.0005714*(NC3D(K)/1.E6*DUM)+0.2714<a name='1546'>
         PGAM(K)=1./(PGAM(K)**2)-1.<a name='1547'>
         PGAM(K)=MAX(PGAM(K),2.)<a name='1548'>
         PGAM(K)=MIN(PGAM(K),10.)<a name='1549'>
<a name='1550'>
<font color=#447700>! CALCULATE LAMC<a name='1551'></font>
<a name='1552'>
      LAMC(K) = (CONS26*NC3D(K)*GAMMA(PGAM(K)+4.)/   &amp;<a name='1553'>
                 (QC3D(K)*GAMMA(PGAM(K)+1.)))**(1./3.)<a name='1554'>
<a name='1555'>
<font color=#447700>! LAMMIN, 60 MICRON DIAMETER<a name='1556'></font>
<font color=#447700>! LAMMAX, 1 MICRON<a name='1557'></font>
<a name='1558'>
      LAMMIN = (PGAM(K)+1.)/60.E-6<a name='1559'>
      LAMMAX = (PGAM(K)+1.)/1.E-6<a name='1560'>
<a name='1561'>
      IF (LAMC(K).LT.LAMMIN) THEN<a name='1562'>
      LAMC(K) = LAMMIN<a name='1563'>
<a name='1564'>
      NC3D(K) = EXP(3.*LOG(LAMC(K))+LOG(QC3D(K))+              &amp;<a name='1565'>
                LOG(GAMMA(PGAM(K)+1.))-LOG(GAMMA(PGAM(K)+4.)))/CONS26<a name='1566'>
      ELSE IF (LAMC(K).GT.LAMMAX) THEN<a name='1567'>
      LAMC(K) = LAMMAX<a name='1568'>
<a name='1569'>
      NC3D(K) = EXP(3.*LOG(LAMC(K))+LOG(QC3D(K))+              &amp;<a name='1570'>
                LOG(GAMMA(PGAM(K)+1.))-LOG(GAMMA(PGAM(K)+4.)))/CONS26<a name='1571'>
<a name='1572'>
      END IF<a name='1573'>
<a name='1574'>
      END IF<a name='1575'>
<a name='1576'>
<font color=#447700>!......................................................................<a name='1577'></font>
<font color=#447700>! SNOW<a name='1578'></font>
<a name='1579'>
      IF (QNI3D(K).GE.QSMALL) THEN<a name='1580'>
      LAMS(K) = (CONS1*NS3D(K)/QNI3D(K))**(1./DS)<a name='1581'>
      N0S(K) = NS3D(K)*LAMS(K)<a name='1582'>
<a name='1583'>
<font color=#447700>! CHECK FOR SLOPE<a name='1584'></font>
<a name='1585'>
<font color=#447700>! ADJUST VARS<a name='1586'></font>
<a name='1587'>
      IF (LAMS(K).LT.LAMMINS) THEN<a name='1588'>
      LAMS(K) = LAMMINS<a name='1589'>
      N0S(K) = LAMS(K)**4*QNI3D(K)/CONS1<a name='1590'>
<a name='1591'>
      NS3D(K) = N0S(K)/LAMS(K)<a name='1592'>
<a name='1593'>
      ELSE IF (LAMS(K).GT.LAMMAXS) THEN<a name='1594'>
<a name='1595'>
      LAMS(K) = LAMMAXS<a name='1596'>
      N0S(K) = LAMS(K)**4*QNI3D(K)/CONS1<a name='1597'>
<a name='1598'>
      NS3D(K) = N0S(K)/LAMS(K)<a name='1599'>
      END IF<a name='1600'>
      END IF<a name='1601'>
<a name='1602'>
<font color=#447700>!......................................................................<a name='1603'></font>
<font color=#447700>! GRAUPEL<a name='1604'></font>
<a name='1605'>
      IF (QG3D(K).GE.QSMALL) THEN<a name='1606'>
      LAMG(K) = (CONS2*NG3D(K)/QG3D(K))**(1./DG)<a name='1607'>
      N0G(K) = NG3D(K)*LAMG(K)<a name='1608'>
<a name='1609'>
<font color=#447700>! ADJUST VARS<a name='1610'></font>
<a name='1611'>
      IF (LAMG(K).LT.LAMMING) THEN<a name='1612'>
      LAMG(K) = LAMMING<a name='1613'>
      N0G(K) = LAMG(K)**4*QG3D(K)/CONS2<a name='1614'>
<a name='1615'>
      NG3D(K) = N0G(K)/LAMG(K)<a name='1616'>
<a name='1617'>
      ELSE IF (LAMG(K).GT.LAMMAXG) THEN<a name='1618'>
<a name='1619'>
      LAMG(K) = LAMMAXG<a name='1620'>
      N0G(K) = LAMG(K)**4*QG3D(K)/CONS2<a name='1621'>
<a name='1622'>
      NG3D(K) = N0G(K)/LAMG(K)<a name='1623'>
      END IF<a name='1624'>
      END IF<a name='1625'>
<a name='1626'>
<font color=#447700>!.....................................................................<a name='1627'></font>
<font color=#447700>! ZERO OUT PROCESS RATES<a name='1628'></font>
<a name='1629'>
            PRC(K) = 0.<a name='1630'>
            NPRC(K) = 0.<a name='1631'>
            NPRC1(K) = 0.<a name='1632'>
            PRA(K) = 0.<a name='1633'>
            NPRA(K) = 0.<a name='1634'>
            NRAGG(K) = 0.<a name='1635'>
            NSMLTS(K) = 0.<a name='1636'>
            NSMLTR(K) = 0.<a name='1637'>
            EVPMS(K) = 0.<a name='1638'>
            PCC(K) = 0.<a name='1639'>
            PRE(K) = 0.<a name='1640'>
            NSUBC(K) = 0.<a name='1641'>
            NSUBR(K) = 0.<a name='1642'>
            PRACG(K) = 0.<a name='1643'>
            NPRACG(K) = 0.<a name='1644'>
            PSMLT(K) = 0.<a name='1645'>
            PGMLT(K) = 0.<a name='1646'>
            EVPMG(K) = 0.<a name='1647'>
            PRACS(K) = 0.<a name='1648'>
            NPRACS(K) = 0.<a name='1649'>
            NGMLTG(K) = 0.<a name='1650'>
            NGMLTR(K) = 0.<a name='1651'>
<a name='1652'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1653'></font>
<font color=#447700>! CALCULATION OF MICROPHYSICAL PROCESS RATES, T &gt; 273.15 K<a name='1654'></font>
<a name='1655'>
<font color=#447700>!.................................................................<a name='1656'></font>
<font color=#447700>!.......................................................................<a name='1657'></font>
<font color=#447700>! AUTOCONVERSION OF CLOUD LIQUID WATER TO RAIN<a name='1658'></font>
<font color=#447700>! FORMULA FROM BEHENG (1994)<a name='1659'></font>
<font color=#447700>! USING NUMERICAL SIMULATION OF STOCHASTIC COLLECTION EQUATION<a name='1660'></font>
<font color=#447700>! AND INITIAL CLOUD DROPLET SIZE DISTRIBUTION SPECIFIED<a name='1661'></font>
<font color=#447700>! AS A GAMMA DISTRIBUTION<a name='1662'></font>
<a name='1663'>
<font color=#447700>! USE MINIMUM VALUE OF 1.E-6 TO PREVENT FLOATING POINT ERROR<a name='1664'></font>
<a name='1665'>
         IF (QC3D(K).GE.1.E-6) THEN<a name='1666'>
<a name='1667'>
<font color=#447700>! HM ADD 12/13/06, REPLACE WITH NEWER FORMULA<a name='1668'></font>
<font color=#447700>! FROM KHAIROUTDINOV AND KOGAN 2000, MWR<a name='1669'></font>
<a name='1670'>
                PRC(K)=1350.*QC3D(K)**2.47*  &amp;<a name='1671'>
           (NC3D(K)/1.e6*RHO(K))**(-1.79)<a name='1672'>
<a name='1673'>
<font color=#447700>! note: nprc1 is change in Nr,<a name='1674'></font>
<font color=#447700>! nprc is change in Nc<a name='1675'></font>
<a name='1676'>
        NPRC1(K) = PRC(K)/CONS29<a name='1677'>
        NPRC(K) = PRC(K)/(QC3D(k)/NC3D(K))<a name='1678'>
<a name='1679'>
<font color=#447700>! hm bug fix 3/20/12<a name='1680'></font>
                NPRC(K) = MIN(NPRC(K),NC3D(K)/DT)<a name='1681'>
                NPRC1(K) = MIN(NPRC1(K),NPRC(K))<a name='1682'>
<a name='1683'>
         END IF<a name='1684'>
<a name='1685'>
<font color=#447700>!.......................................................................<a name='1686'></font>
<font color=#447700>! HM ADD 12/13/06, COLLECTION OF SNOW BY RAIN ABOVE FREEZING<a name='1687'></font>
<font color=#447700>! FORMULA FROM IKAWA AND SAITO (1991)<a name='1688'></font>
<a name='1689'>
         IF (QR3D(K).GE.1.E-8.AND.QNI3D(K).GE.1.E-8) THEN<a name='1690'>
<a name='1691'>
            UMS = ASN(K)*CONS3/(LAMS(K)**BS)<a name='1692'>
            UMR = ARN(K)*CONS4/(LAMR(K)**BR)<a name='1693'>
            UNS = ASN(K)*CONS5/LAMS(K)**BS<a name='1694'>
            UNR = ARN(K)*CONS6/LAMR(K)**BR<a name='1695'>
<a name='1696'>
<font color=#447700>! SET REASLISTIC LIMITS ON FALLSPEEDS<a name='1697'></font>
<a name='1698'>
<font color=#447700>! bug fix, 10/08/09<a name='1699'></font>
            dum=(rhosu/rho(k))**0.54<a name='1700'>
            UMS=MIN(UMS,1.2*dum)<a name='1701'>
            UNS=MIN(UNS,1.2*dum)<a name='1702'>
            UMR=MIN(UMR,9.1*dum)<a name='1703'>
            UNR=MIN(UNR,9.1*dum)<a name='1704'>
<a name='1705'>
<font color=#447700>! hm fix, 2/12/13<a name='1706'></font>
<font color=#447700>! for above freezing conditions to get accelerated melting of snow,<a name='1707'></font>
<font color=#447700>! we need collection of rain by snow (following Lin et al. 1983)<a name='1708'></font>
<font color=#447700>!            PRACS(K) = CONS31*(((1.2*UMR-0.95*UMS)**2+              &amp;<a name='1709'></font>
<font color=#447700>!                  0.08*UMS*UMR)**0.5*RHO(K)*                     &amp;<a name='1710'></font>
<font color=#447700>!                 N0RR(K)*N0S(K)/LAMS(K)**3*                    &amp;<a name='1711'></font>
<font color=#447700>!                  (5./(LAMS(K)**3*LAMR(K))+                    &amp;<a name='1712'></font>
<font color=#447700>!                  2./(LAMS(K)**2*LAMR(K)**2)+                  &amp;<a name='1713'></font>
<font color=#447700>!                  0.5/(LAMS(K)*LAMR(K)**3)))<a name='1714'></font>
<a name='1715'>
            PRACS(K) = CONS41*(((1.2*UMR-0.95*UMS)**2+                   &amp;<a name='1716'>
                  0.08*UMS*UMR)**0.5*RHO(K)*                      &amp;<a name='1717'>
                  N0RR(K)*N0S(K)/LAMR(K)**3*                              &amp;<a name='1718'>
                  (5./(LAMR(K)**3*LAMS(K))+                    &amp;<a name='1719'>
                  2./(LAMR(K)**2*LAMS(K)**2)+                  &amp;				 <a name='1720'>
                  0.5/(LAMR(k)*LAMS(k)**3)))<a name='1721'>
<a name='1722'>
<font color=#447700>! fix 053011, npracs no longer subtracted from snow<a name='1723'></font>
<font color=#447700>!            NPRACS(K) = CONS32*RHO(K)*(1.7*(UNR-UNS)**2+            &amp;<a name='1724'></font>
<font color=#447700>!                0.3*UNR*UNS)**0.5*N0RR(K)*N0S(K)*              &amp;<a name='1725'></font>
<font color=#447700>!                (1./(LAMR(K)**3*LAMS(K))+                      &amp;<a name='1726'></font>
<font color=#447700>!                 1./(LAMR(K)**2*LAMS(K)**2)+                   &amp;<a name='1727'></font>
<font color=#447700>!                 1./(LAMR(K)*LAMS(K)**3))<a name='1728'></font>
<a name='1729'>
         END IF<a name='1730'>
<a name='1731'>
<font color=#447700>! ADD COLLECTION OF GRAUPEL BY RAIN ABOVE FREEZING<a name='1732'></font>
<font color=#447700>! ASSUME ALL RAIN COLLECTION BY GRAUPEL ABOVE FREEZING IS SHED<a name='1733'></font>
<font color=#447700>! ASSUME SHED DROPS ARE 1 MM IN SIZE<a name='1734'></font>
<a name='1735'>
         IF (QR3D(K).GE.1.E-8.AND.QG3D(K).GE.1.E-8) THEN<a name='1736'>
<a name='1737'>
            UMG = AGN(K)*CONS7/(LAMG(K)**BG)<a name='1738'>
            UMR = ARN(K)*CONS4/(LAMR(K)**BR)<a name='1739'>
            UNG = AGN(K)*CONS8/LAMG(K)**BG<a name='1740'>
            UNR = ARN(K)*CONS6/LAMR(K)**BR<a name='1741'>
<a name='1742'>
<font color=#447700>! SET REASLISTIC LIMITS ON FALLSPEEDS<a name='1743'></font>
<font color=#447700>! bug fix, 10/08/09<a name='1744'></font>
            dum=(rhosu/rho(k))**0.54<a name='1745'>
            UMG=MIN(UMG,20.*dum)<a name='1746'>
            UNG=MIN(UNG,20.*dum)<a name='1747'>
            UMR=MIN(UMR,9.1*dum)<a name='1748'>
            UNR=MIN(UNR,9.1*dum)<a name='1749'>
<a name='1750'>
<font color=#447700>! PRACG IS MIXING RATIO OF RAIN PER SEC COLLECTED BY GRAUPEL/HAIL<a name='1751'></font>
            PRACG(K) = CONS41*(((1.2*UMR-0.95*UMG)**2+                   &amp;<a name='1752'>
                  0.08*UMG*UMR)**0.5*RHO(K)*                      &amp;<a name='1753'>
                  N0RR(K)*N0G(K)/LAMR(K)**3*                              &amp;<a name='1754'>
                  (5./(LAMR(K)**3*LAMG(K))+                    &amp;<a name='1755'>
                  2./(LAMR(K)**2*LAMG(K)**2)+				   &amp;<a name='1756'>
				  0.5/(LAMR(k)*LAMG(k)**3)))<a name='1757'>
<a name='1758'>
<font color=#447700>! ASSUME 1 MM DROPS ARE SHED, GET NUMBER SHED PER SEC<a name='1759'></font>
<a name='1760'>
            DUM = PRACG(K)/5.2E-7<a name='1761'>
<a name='1762'>
            NPRACG(K) = CONS32*RHO(K)*(1.7*(UNR-UNG)**2+            &amp;<a name='1763'>
                0.3*UNR*UNG)**0.5*N0RR(K)*N0G(K)*              &amp;<a name='1764'>
                (1./(LAMR(K)**3*LAMG(K))+                      &amp;<a name='1765'>
                 1./(LAMR(K)**2*LAMG(K)**2)+                   &amp;<a name='1766'>
                 1./(LAMR(K)*LAMG(K)**3))<a name='1767'>
<a name='1768'>
<font color=#447700>! hm 7/15/13, remove limit so that the number of collected drops can smaller than <a name='1769'></font>
<font color=#447700>! number of shed drops<a name='1770'></font>
<font color=#447700>!            NPRACG(K)=MAX(NPRACG(K)-DUM,0.)<a name='1771'></font>
            NPRACG(K)=NPRACG(K)-DUM<a name='1772'>
<a name='1773'>
	    END IF<a name='1774'>
<a name='1775'>
<font color=#447700>!.......................................................................<a name='1776'></font>
<font color=#447700>! ACCRETION OF CLOUD LIQUID WATER BY RAIN<a name='1777'></font>
<font color=#447700>! CONTINUOUS COLLECTION EQUATION WITH<a name='1778'></font>
<font color=#447700>! GRAVITATIONAL COLLECTION KERNEL, DROPLET FALL SPEED NEGLECTED<a name='1779'></font>
<a name='1780'>
         IF (QR3D(K).GE.1.E-8 .AND. QC3D(K).GE.1.E-8) THEN<a name='1781'>
<a name='1782'>
<font color=#447700>! 12/13/06 HM ADD, REPLACE WITH NEWER FORMULA FROM<a name='1783'></font>
<font color=#447700>! KHAIROUTDINOV AND KOGAN 2000, MWR<a name='1784'></font>
<a name='1785'>
           DUM=(QC3D(K)*QR3D(K))<a name='1786'>
           PRA(K) = 67.*(DUM)**1.15<a name='1787'>
           NPRA(K) = PRA(K)/(QC3D(K)/NC3D(K))<a name='1788'>
<a name='1789'>
         END IF<a name='1790'>
<font color=#447700>!.......................................................................<a name='1791'></font>
<font color=#447700>! SELF-COLLECTION OF RAIN DROPS<a name='1792'></font>
<font color=#447700>! FROM BEHENG(1994)<a name='1793'></font>
<font color=#447700>! FROM NUMERICAL SIMULATION OF THE STOCHASTIC COLLECTION EQUATION<a name='1794'></font>
<font color=#447700>! AS DESCRINED ABOVE FOR AUTOCONVERSION<a name='1795'></font>
<a name='1796'>
         IF (QR3D(K).GE.1.E-8) THEN<a name='1797'>
<font color=#447700>! include breakup add 10/09/09<a name='1798'></font>
            dum1=300.e-6<a name='1799'>
            if (1./lamr(k).lt.dum1) then<a name='1800'>
            dum=1.<a name='1801'>
            else if (1./lamr(k).ge.dum1) then<a name='1802'>
            dum=2.-exp(2300.*(1./lamr(k)-dum1))<a name='1803'>
            end if<a name='1804'>
<font color=#447700>!            NRAGG(K) = -8.*NR3D(K)*QR3D(K)*RHO(K)<a name='1805'></font>
            NRAGG(K) = -5.78*dum*NR3D(K)*QR3D(K)*RHO(K)<a name='1806'>
         END IF<a name='1807'>
<a name='1808'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1809'></font>
<font color=#447700>! CALCULATE EVAP OF RAIN (RUTLEDGE AND HOBBS 1983)<a name='1810'></font>
<a name='1811'>
      IF (QR3D(K).GE.QSMALL) THEN<a name='1812'>
        EPSR = 2.*PI*N0RR(K)*RHO(K)*DV(K)*                           &amp;<a name='1813'>
                   (F1R/(LAMR(K)*LAMR(K))+                       &amp;<a name='1814'>
                    F2R*(ARN(K)*RHO(K)/MU(K))**0.5*                      &amp;<a name='1815'>
                    SC(K)**(1./3.)*CONS9/                   &amp;<a name='1816'>
                (LAMR(K)**CONS34))<a name='1817'>
      ELSE<a name='1818'>
      EPSR = 0.<a name='1819'>
      END IF<a name='1820'>
<a name='1821'>
<font color=#447700>! NO CONDENSATION ONTO RAIN, ONLY EVAP ALLOWED<a name='1822'></font>
<a name='1823'>
           IF (QV3D(K).LT.QVS(K)) THEN<a name='1824'>
              PRE(K) = EPSR*(QV3D(K)-QVS(K))/AB(K)<a name='1825'>
              PRE(K) = MIN(PRE(K),0.)<a name='1826'>
           ELSE<a name='1827'>
              PRE(K) = 0.<a name='1828'>
           END IF<a name='1829'>
<a name='1830'>
<font color=#447700>!.......................................................................<a name='1831'></font>
<font color=#447700>! MELTING OF SNOW<a name='1832'></font>
<a name='1833'>
<font color=#447700>! SNOW MAY PERSITS ABOVE FREEZING, FORMULA FROM RUTLEDGE AND HOBBS, 1984<a name='1834'></font>
<font color=#447700>! IF WATER SUPERSATURATION, SNOW MELTS TO FORM RAIN<a name='1835'></font>
<a name='1836'>
          IF (QNI3D(K).GE.1.E-8) THEN<a name='1837'>
<a name='1838'>
<font color=#447700>! fix 053011<a name='1839'></font>
<font color=#447700>! HM, MODIFY FOR V3.2, ADD ACCELERATED MELTING DUE TO COLLISION WITH RAIN<a name='1840'></font>
<font color=#447700>!             DUM = -CPW/XLF(K)*T3D(K)*PRACS(K)<a name='1841'></font>
             DUM = -CPW/XLF(K)*(T3D(K)-273.15)*PRACS(K)<a name='1842'>
<a name='1843'>
<font color=#447700>! hm fix 1/20/15<a name='1844'></font>
<font color=#447700>!             PSMLT(K)=2.*PI*N0S(K)*KAP(K)*(273.15-T3D(K))/       &amp;<a name='1845'></font>
<font color=#447700>!                    XLF(K)*RHO(K)*(F1S/(LAMS(K)*LAMS(K))+        &amp;<a name='1846'></font>
<font color=#447700>!                    F2S*(ASN(K)*RHO(K)/MU(K))**0.5*                      &amp;<a name='1847'></font>
<font color=#447700>!                    SC(K)**(1./3.)*CONS10/                   &amp;<a name='1848'></font>
<font color=#447700>!                   (LAMS(K)**CONS35))+DUM<a name='1849'></font>
             PSMLT(K)=2.*PI*N0S(K)*KAP(K)*(273.15-T3D(K))/       &amp;<a name='1850'>
                    XLF(K)*(F1S/(LAMS(K)*LAMS(K))+        &amp;<a name='1851'>
                    F2S*(ASN(K)*RHO(K)/MU(K))**0.5*                      &amp;<a name='1852'>
                    SC(K)**(1./3.)*CONS10/                   &amp;<a name='1853'>
                   (LAMS(K)**CONS35))+DUM<a name='1854'>
<a name='1855'>
<font color=#447700>! IN WATER SUBSATURATION, SNOW MELTS AND EVAPORATES<a name='1856'></font>
<a name='1857'>
      IF (QVQVS(K).LT.1.) THEN<a name='1858'>
        EPSS = 2.*PI*N0S(K)*RHO(K)*DV(K)*                            &amp;<a name='1859'>
                   (F1S/(LAMS(K)*LAMS(K))+                       &amp;<a name='1860'>
                    F2S*(ASN(K)*RHO(K)/MU(K))**0.5*                      &amp;<a name='1861'>
                    SC(K)**(1./3.)*CONS10/                   &amp;<a name='1862'>
               (LAMS(K)**CONS35))<a name='1863'>
<font color=#447700>! hm fix 8/4/08<a name='1864'></font>
        EVPMS(K) = (QV3D(K)-QVS(K))*EPSS/AB(K)    <a name='1865'>
        EVPMS(K) = MAX(EVPMS(K),PSMLT(K))<a name='1866'>
        PSMLT(K) = PSMLT(K)-EVPMS(K)<a name='1867'>
      END IF<a name='1868'>
      END IF<a name='1869'>
<a name='1870'>
<font color=#447700>!.......................................................................<a name='1871'></font>
<font color=#447700>! MELTING OF GRAUPEL<a name='1872'></font>
<a name='1873'>
<font color=#447700>! GRAUPEL MAY PERSITS ABOVE FREEZING, FORMULA FROM RUTLEDGE AND HOBBS, 1984<a name='1874'></font>
<font color=#447700>! IF WATER SUPERSATURATION, GRAUPEL MELTS TO FORM RAIN<a name='1875'></font>
<a name='1876'>
          IF (QG3D(K).GE.1.E-8) THEN<a name='1877'>
<a name='1878'>
<font color=#447700>! fix 053011<a name='1879'></font>
<font color=#447700>! HM, MODIFY FOR V3.2, ADD ACCELERATED MELTING DUE TO COLLISION WITH RAIN<a name='1880'></font>
<font color=#447700>!             DUM = -CPW/XLF(K)*T3D(K)*PRACG(K)<a name='1881'></font>
             DUM = -CPW/XLF(K)*(T3D(K)-273.15)*PRACG(K)<a name='1882'>
<a name='1883'>
<font color=#447700>! hm fix 1/20/15<a name='1884'></font>
<font color=#447700>!             PGMLT(K)=2.*PI*N0G(K)*KAP(K)*(273.15-T3D(K))/ 		 &amp;<a name='1885'></font>
<font color=#447700>!                    XLF(K)*RHO(K)*(F1S/(LAMG(K)*LAMG(K))+                &amp;<a name='1886'></font>
<font color=#447700>!                    F2S*(AGN(K)*RHO(K)/MU(K))**0.5*                      &amp;<a name='1887'></font>
<font color=#447700>!                    SC(K)**(1./3.)*CONS11/                   &amp;<a name='1888'></font>
<font color=#447700>!                   (LAMG(K)**CONS36))+DUM<a name='1889'></font>
             PGMLT(K)=2.*PI*N0G(K)*KAP(K)*(273.15-T3D(K))/ 		 &amp;<a name='1890'>
                    XLF(K)*(F1S/(LAMG(K)*LAMG(K))+                &amp;<a name='1891'>
                    F2S*(AGN(K)*RHO(K)/MU(K))**0.5*                      &amp;<a name='1892'>
                    SC(K)**(1./3.)*CONS11/                   &amp;<a name='1893'>
                   (LAMG(K)**CONS36))+DUM<a name='1894'>
<a name='1895'>
<font color=#447700>! IN WATER SUBSATURATION, GRAUPEL MELTS AND EVAPORATES<a name='1896'></font>
<a name='1897'>
      IF (QVQVS(K).LT.1.) THEN<a name='1898'>
        EPSG = 2.*PI*N0G(K)*RHO(K)*DV(K)*                                &amp;<a name='1899'>
                   (F1S/(LAMG(K)*LAMG(K))+                               &amp;<a name='1900'>
                    F2S*(AGN(K)*RHO(K)/MU(K))**0.5*                      &amp;<a name='1901'>
                    SC(K)**(1./3.)*CONS11/                   &amp;<a name='1902'>
               (LAMG(K)**CONS36))<a name='1903'>
<font color=#447700>! hm fix 8/4/08<a name='1904'></font>
        EVPMG(K) = (QV3D(K)-QVS(K))*EPSG/AB(K)<a name='1905'>
        EVPMG(K) = MAX(EVPMG(K),PGMLT(K))<a name='1906'>
        PGMLT(K) = PGMLT(K)-EVPMG(K)<a name='1907'>
      END IF<a name='1908'>
      END IF<a name='1909'>
<a name='1910'>
<font color=#447700>! HM, V3.2<a name='1911'></font>
<font color=#447700>! RESET PRACG AND PRACS TO ZERO, THIS IS DONE BECAUSE THERE IS NO<a name='1912'></font>
<font color=#447700>! TRANSFER OF MASS FROM SNOW AND GRAUPEL TO RAIN DIRECTLY FROM COLLECTION<a name='1913'></font>
<font color=#447700>! ABOVE FREEZING, IT IS ONLY USED FOR ENHANCEMENT OF MELTING AND SHEDDING<a name='1914'></font>
<a name='1915'>
      PRACG(K) = 0.<a name='1916'>
      PRACS(K) = 0.<a name='1917'>
<a name='1918'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='1919'></font>
<a name='1920'>
<font color=#447700>! FOR CLOUD ICE, ONLY PROCESSES OPERATING AT T &gt; 273.15 IS<a name='1921'></font>
<font color=#447700>! MELTING, WHICH IS ALREADY CONSERVED DURING PROCESS<a name='1922'></font>
<font color=#447700>! CALCULATION<a name='1923'></font>
<a name='1924'>
<font color=#447700>! CONSERVATION OF QC<a name='1925'></font>
<a name='1926'>
      DUM = (PRC(K)+PRA(K))*DT<a name='1927'>
<a name='1928'>
      IF (DUM.GT.QC3D(K).AND.QC3D(K).GE.QSMALL) THEN<a name='1929'>
<a name='1930'>
        RATIO = QC3D(K)/DUM<a name='1931'>
<a name='1932'>
        PRC(K) = PRC(K)*RATIO<a name='1933'>
        PRA(K) = PRA(K)*RATIO<a name='1934'>
<a name='1935'>
        END IF<a name='1936'>
<a name='1937'>
<font color=#447700>! CONSERVATION OF SNOW<a name='1938'></font>
<a name='1939'>
        DUM = (-PSMLT(K)-EVPMS(K)+PRACS(K))*DT<a name='1940'>
<a name='1941'>
        IF (DUM.GT.QNI3D(K).AND.QNI3D(K).GE.QSMALL) THEN<a name='1942'>
<a name='1943'>
<font color=#447700>! NO SOURCE TERMS FOR SNOW AT T &gt; FREEZING<a name='1944'></font>
        RATIO = QNI3D(K)/DUM<a name='1945'>
<a name='1946'>
        PSMLT(K) = PSMLT(K)*RATIO<a name='1947'>
        EVPMS(K) = EVPMS(K)*RATIO<a name='1948'>
        PRACS(K) = PRACS(K)*RATIO<a name='1949'>
<a name='1950'>
        END IF<a name='1951'>
<a name='1952'>
<font color=#447700>! CONSERVATION OF GRAUPEL<a name='1953'></font>
<a name='1954'>
        DUM = (-PGMLT(K)-EVPMG(K)+PRACG(K))*DT<a name='1955'>
<a name='1956'>
        IF (DUM.GT.QG3D(K).AND.QG3D(K).GE.QSMALL) THEN<a name='1957'>
<a name='1958'>
<font color=#447700>! NO SOURCE TERM FOR GRAUPEL ABOVE FREEZING<a name='1959'></font>
        RATIO = QG3D(K)/DUM<a name='1960'>
<a name='1961'>
        PGMLT(K) = PGMLT(K)*RATIO<a name='1962'>
        EVPMG(K) = EVPMG(K)*RATIO<a name='1963'>
        PRACG(K) = PRACG(K)*RATIO<a name='1964'>
<a name='1965'>
        END IF<a name='1966'>
<a name='1967'>
<font color=#447700>! CONSERVATION OF QR<a name='1968'></font>
<font color=#447700>! HM 12/13/06, ADDED CONSERVATION OF RAIN SINCE PRE IS NEGATIVE<a name='1969'></font>
<a name='1970'>
        DUM = (-PRACS(K)-PRACG(K)-PRE(K)-PRA(K)-PRC(K)+PSMLT(K)+PGMLT(K))*DT<a name='1971'>
<a name='1972'>
        IF (DUM.GT.QR3D(K).AND.QR3D(K).GE.QSMALL) THEN<a name='1973'>
<a name='1974'>
        RATIO = (QR3D(K)/DT+PRACS(K)+PRACG(K)+PRA(K)+PRC(K)-PSMLT(K)-PGMLT(K))/ &amp;<a name='1975'>
                        (-PRE(K))<a name='1976'>
        PRE(K) = PRE(K)*RATIO<a name='1977'>
        <a name='1978'>
        END IF<a name='1979'>
<a name='1980'>
<font color=#447700>!....................................<a name='1981'></font>
<a name='1982'>
      QV3DTEN(K) = QV3DTEN(K)+(-PRE(K)-EVPMS(K)-EVPMG(K))<a name='1983'>
<a name='1984'>
      T3DTEN(K) = T3DTEN(K)+(PRE(K)*XXLV(K)+(EVPMS(K)+EVPMG(K))*XXLS(K)+&amp;<a name='1985'>
                    (PSMLT(K)+PGMLT(K)-PRACS(K)-PRACG(K))*XLF(K))/CPM(K)<a name='1986'>
<a name='1987'>
      QC3DTEN(K) = QC3DTEN(K)+(-PRA(K)-PRC(K))<a name='1988'>
      QR3DTEN(K) = QR3DTEN(K)+(PRE(K)+PRA(K)+PRC(K)-PSMLT(K)-PGMLT(K)+PRACS(K)+PRACG(K))<a name='1989'>
      QNI3DTEN(K) = QNI3DTEN(K)+(PSMLT(K)+EVPMS(K)-PRACS(K))<a name='1990'>
      QG3DTEN(K) = QG3DTEN(K)+(PGMLT(K)+EVPMG(K)-PRACG(K))<a name='1991'>
<font color=#447700>! fix 053011<a name='1992'></font>
<font color=#447700>!      NS3DTEN(K) = NS3DTEN(K)-NPRACS(K)<a name='1993'></font>
<font color=#447700>! HM, bug fix 5/12/08, npracg is subtracted from nr not ng<a name='1994'></font>
<font color=#447700>!      NG3DTEN(K) = NG3DTEN(K)<a name='1995'></font>
      NC3DTEN(K) = NC3DTEN(K)+ (-NPRA(K)-NPRC(K))<a name='1996'>
      NR3DTEN(K) = NR3DTEN(K)+ (NPRC1(K)+NRAGG(K)-NPRACG(K))<a name='1997'>
<a name='1998'>
<font color=#447700>! HM ADD, WRF-CHEM, ADD TENDENCIES FOR C2PREC<a name='1999'></font>
<a name='2000'>
	C2PREC(K) = PRA(K)+PRC(K)<a name='2001'>
      IF (PRE(K).LT.0.) THEN<a name='2002'>
         DUM = PRE(K)*DT/QR3D(K)<a name='2003'>
           DUM = MAX(-1.,DUM)<a name='2004'>
         NSUBR(K) = DUM*NR3D(K)/DT<a name='2005'>
      END IF<a name='2006'>
<a name='2007'>
        IF (EVPMS(K)+PSMLT(K).LT.0.) THEN<a name='2008'>
         DUM = (EVPMS(K)+PSMLT(K))*DT/QNI3D(K)<a name='2009'>
           DUM = MAX(-1.,DUM)<a name='2010'>
         NSMLTS(K) = DUM*NS3D(K)/DT<a name='2011'>
        END IF<a name='2012'>
        IF (PSMLT(K).LT.0.) THEN<a name='2013'>
          DUM = PSMLT(K)*DT/QNI3D(K)<a name='2014'>
          DUM = MAX(-1.0,DUM)<a name='2015'>
          NSMLTR(K) = DUM*NS3D(K)/DT<a name='2016'>
        END IF<a name='2017'>
        IF (EVPMG(K)+PGMLT(K).LT.0.) THEN<a name='2018'>
         DUM = (EVPMG(K)+PGMLT(K))*DT/QG3D(K)<a name='2019'>
           DUM = MAX(-1.,DUM)<a name='2020'>
         NGMLTG(K) = DUM*NG3D(K)/DT<a name='2021'>
        END IF<a name='2022'>
        IF (PGMLT(K).LT.0.) THEN<a name='2023'>
          DUM = PGMLT(K)*DT/QG3D(K)<a name='2024'>
          DUM = MAX(-1.0,DUM)<a name='2025'>
          NGMLTR(K) = DUM*NG3D(K)/DT<a name='2026'>
        END IF<a name='2027'>
<a name='2028'>
         NS3DTEN(K) = NS3DTEN(K)+(NSMLTS(K))<a name='2029'>
         NG3DTEN(K) = NG3DTEN(K)+(NGMLTG(K))<a name='2030'>
         NR3DTEN(K) = NR3DTEN(K)+(NSUBR(K)-NSMLTR(K)-NGMLTR(K))<a name='2031'>
<a name='2032'>
 300  CONTINUE<a name='2033'>
<a name='2034'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2035'></font>
<font color=#447700>! NOW CALCULATE SATURATION ADJUSTMENT TO CONDENSE EXTRA VAPOR ABOVE<a name='2036'></font>
<font color=#447700>! WATER SATURATION<a name='2037'></font>
<a name='2038'>
      DUMT = T3D(K)+DT*T3DTEN(K)<a name='2039'>
      DUMQV = QV3D(K)+DT*QV3DTEN(K)<a name='2040'>
<font color=#447700>! hm, add fix for low pressure, 5/12/10<a name='2041'></font>
      dum=min(0.99*pres(k),POLYSVP(DUMT,0))<a name='2042'>
      DUMQSS = EP_2*dum/(PRES(K)-dum)<a name='2043'>
      DUMQC = QC3D(K)+DT*QC3DTEN(K)<a name='2044'>
      DUMQC = MAX(DUMQC,0.)<a name='2045'>
<a name='2046'>
<font color=#447700>! SATURATION ADJUSTMENT FOR LIQUID<a name='2047'></font>
<a name='2048'>
      DUMS = DUMQV-DUMQSS<a name='2049'>
      PCC(K) = DUMS/(1.+XXLV(K)**2*DUMQSS/(CPM(K)*RV*DUMT**2))/DT<a name='2050'>
      IF (PCC(K)*DT+DUMQC.LT.0.) THEN<a name='2051'>
           PCC(K) = -DUMQC/DT<a name='2052'>
      END IF<a name='2053'>
<a name='2054'>
      QV3DTEN(K) = QV3DTEN(K)-PCC(K)<a name='2055'>
      T3DTEN(K) = T3DTEN(K)+PCC(K)*XXLV(K)/CPM(K)<a name='2056'>
      QC3DTEN(K) = QC3DTEN(K)+PCC(K)<a name='2057'>
<a name='2058'>
#if (WRF_CHEM == 1)<a name='2059'>
         evapprod(k) = - PRE(K) - EVPMS(K) - EVPMG(K)<a name='2060'>
         rainprod(k) = PRA(K) + PRC(K) + tqimelt(K)<a name='2061'>
#endif<a name='2062'>
<a name='2063'>
<font color=#447700>!.......................................................................<a name='2064'></font>
<font color=#447700>! ACTIVATION OF CLOUD DROPLETS<a name='2065'></font>
<font color=#447700>! ACTIVATION OF DROPLET CURRENTLY NOT CALCULATED<a name='2066'></font>
<font color=#447700>! DROPLET CONCENTRATION IS SPECIFIED !!!!!<a name='2067'></font>
<a name='2068'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2069'></font>
<font color=#447700>! SUBLIMATE, MELT, OR EVAPORATE NUMBER CONCENTRATION<a name='2070'></font>
<font color=#447700>! THIS FORMULATION ASSUMES 1:1 RATIO BETWEEN MASS LOSS AND<a name='2071'></font>
<font color=#447700>! LOSS OF NUMBER CONCENTRATION<a name='2072'></font>
<a name='2073'>
<font color=#447700>!     IF (PCC(K).LT.0.) THEN<a name='2074'></font>
<font color=#447700>!        DUM = PCC(K)*DT/QC3D(K)<a name='2075'></font>
<font color=#447700>!           DUM = MAX(-1.,DUM)<a name='2076'></font>
<font color=#447700>!        NSUBC(K) = DUM*NC3D(K)/DT<a name='2077'></font>
<font color=#447700>!     END IF<a name='2078'></font>
<a name='2079'>
<font color=#447700>! UPDATE TENDENCIES<a name='2080'></font>
<a name='2081'>
<font color=#447700>!        NC3DTEN(K) = NC3DTEN(K)+NSUBC(K)<a name='2082'></font>
<a name='2083'>
<font color=#447700>!.....................................................................<a name='2084'></font>
<font color=#447700>!.....................................................................<a name='2085'></font>
         ELSE  <font color=#447700>! TEMPERATURE &lt; 273.15<a name='2086'></font>
<a name='2087'>
<font color=#447700>!......................................................................<a name='2088'></font>
<font color=#447700>!HM ADD, ALLOW FOR CONSTANT DROPLET NUMBER<a name='2089'></font>
<font color=#447700>! INUM = 0, PREDICT DROPLET NUMBER<a name='2090'></font>
<font color=#447700>! INUM = 1, SET CONSTANT DROPLET NUMBER<a name='2091'></font>
<a name='2092'>
         IF (iinum.EQ.1) THEN<a name='2093'>
<font color=#447700>! CONVERT NDCNST FROM CM-3 TO KG-1<a name='2094'></font>
            NC3D(K)=NDCNST*1.E6/RHO(K)<a name='2095'>
         END IF<a name='2096'>
<a name='2097'>
<font color=#447700>! CALCULATE SIZE DISTRIBUTION PARAMETERS<a name='2098'></font>
<font color=#447700>! MAKE SURE NUMBER CONCENTRATIONS AREN'T NEGATIVE<a name='2099'></font>
<a name='2100'>
      NI3D(K) = MAX(0.,NI3D(K))<a name='2101'>
      NS3D(K) = MAX(0.,NS3D(K))<a name='2102'>
      NC3D(K) = MAX(0.,NC3D(K))<a name='2103'>
      NR3D(K) = MAX(0.,NR3D(K))<a name='2104'>
      NG3D(K) = MAX(0.,NG3D(K))<a name='2105'>
<a name='2106'>
<font color=#447700>!......................................................................<a name='2107'></font>
<font color=#447700>! CLOUD ICE<a name='2108'></font>
<a name='2109'>
      IF (QI3D(K).GE.QSMALL) THEN<a name='2110'>
         LAMI(K) = (CONS12*                 &amp;<a name='2111'>
              NI3D(K)/QI3D(K))**(1./DI)<a name='2112'>
         N0I(K) = NI3D(K)*LAMI(K)<a name='2113'>
<a name='2114'>
<font color=#447700>! CHECK FOR SLOPE<a name='2115'></font>
<a name='2116'>
<font color=#447700>! ADJUST VARS<a name='2117'></font>
<a name='2118'>
      IF (LAMI(K).LT.LAMMINI) THEN<a name='2119'>
<a name='2120'>
      LAMI(K) = LAMMINI<a name='2121'>
<a name='2122'>
      N0I(K) = LAMI(K)**4*QI3D(K)/CONS12<a name='2123'>
<a name='2124'>
      NI3D(K) = N0I(K)/LAMI(K)<a name='2125'>
      ELSE IF (LAMI(K).GT.LAMMAXI) THEN<a name='2126'>
      LAMI(K) = LAMMAXI<a name='2127'>
      N0I(K) = LAMI(K)**4*QI3D(K)/CONS12<a name='2128'>
<a name='2129'>
      NI3D(K) = N0I(K)/LAMI(K)<a name='2130'>
      END IF<a name='2131'>
      END IF<a name='2132'>
<a name='2133'>
<font color=#447700>!......................................................................<a name='2134'></font>
<font color=#447700>! RAIN<a name='2135'></font>
<a name='2136'>
      IF (QR3D(K).GE.QSMALL) THEN<a name='2137'>
      LAMR(K) = (PI*RHOW*NR3D(K)/QR3D(K))**(1./3.)<a name='2138'>
      N0RR(K) = NR3D(K)*LAMR(K)<a name='2139'>
<a name='2140'>
<font color=#447700>! CHECK FOR SLOPE<a name='2141'></font>
<a name='2142'>
<font color=#447700>! ADJUST VARS<a name='2143'></font>
<a name='2144'>
      IF (LAMR(K).LT.LAMMINR) THEN<a name='2145'>
<a name='2146'>
      LAMR(K) = LAMMINR<a name='2147'>
<a name='2148'>
      N0RR(K) = LAMR(K)**4*QR3D(K)/(PI*RHOW)<a name='2149'>
<a name='2150'>
      NR3D(K) = N0RR(K)/LAMR(K)<a name='2151'>
      ELSE IF (LAMR(K).GT.LAMMAXR) THEN<a name='2152'>
      LAMR(K) = LAMMAXR<a name='2153'>
      N0RR(K) = LAMR(K)**4*QR3D(K)/(PI*RHOW)<a name='2154'>
<a name='2155'>
      NR3D(K) = N0RR(K)/LAMR(K)<a name='2156'>
      END IF<a name='2157'>
      END IF<a name='2158'>
<a name='2159'>
<font color=#447700>!......................................................................<a name='2160'></font>
<font color=#447700>! CLOUD DROPLETS<a name='2161'></font>
<a name='2162'>
<font color=#447700>! MARTIN ET AL. (1994) FORMULA FOR PGAM<a name='2163'></font>
<a name='2164'>
      IF (QC3D(K).GE.QSMALL) THEN<a name='2165'>
<a name='2166'>
         DUM = PRES(K)/(287.15*T3D(K))<a name='2167'>
         PGAM(K)=0.0005714*(NC3D(K)/1.E6*DUM)+0.2714<a name='2168'>
         PGAM(K)=1./(PGAM(K)**2)-1.<a name='2169'>
         PGAM(K)=MAX(PGAM(K),2.)<a name='2170'>
         PGAM(K)=MIN(PGAM(K),10.)<a name='2171'>
<a name='2172'>
<font color=#447700>! CALCULATE LAMC<a name='2173'></font>
<a name='2174'>
      LAMC(K) = (CONS26*NC3D(K)*GAMMA(PGAM(K)+4.)/   &amp;<a name='2175'>
                 (QC3D(K)*GAMMA(PGAM(K)+1.)))**(1./3.)<a name='2176'>
<a name='2177'>
<font color=#447700>! LAMMIN, 60 MICRON DIAMETER<a name='2178'></font>
<font color=#447700>! LAMMAX, 1 MICRON<a name='2179'></font>
<a name='2180'>
      LAMMIN = (PGAM(K)+1.)/60.E-6<a name='2181'>
      LAMMAX = (PGAM(K)+1.)/1.E-6<a name='2182'>
<a name='2183'>
      IF (LAMC(K).LT.LAMMIN) THEN<a name='2184'>
      LAMC(K) = LAMMIN<a name='2185'>
<a name='2186'>
      NC3D(K) = EXP(3.*LOG(LAMC(K))+LOG(QC3D(K))+              &amp;<a name='2187'>
                LOG(GAMMA(PGAM(K)+1.))-LOG(GAMMA(PGAM(K)+4.)))/CONS26<a name='2188'>
      ELSE IF (LAMC(K).GT.LAMMAX) THEN<a name='2189'>
      LAMC(K) = LAMMAX<a name='2190'>
      NC3D(K) = EXP(3.*LOG(LAMC(K))+LOG(QC3D(K))+              &amp;<a name='2191'>
                LOG(GAMMA(PGAM(K)+1.))-LOG(GAMMA(PGAM(K)+4.)))/CONS26<a name='2192'>
<a name='2193'>
      END IF<a name='2194'>
<a name='2195'>
<font color=#447700>! TO CALCULATE DROPLET FREEZING<a name='2196'></font>
<a name='2197'>
        CDIST1(K) = NC3D(K)/GAMMA(PGAM(K)+1.)<a name='2198'>
<a name='2199'>
      END IF<a name='2200'>
<a name='2201'>
<font color=#447700>!......................................................................<a name='2202'></font>
<font color=#447700>! SNOW<a name='2203'></font>
<a name='2204'>
      IF (QNI3D(K).GE.QSMALL) THEN<a name='2205'>
      LAMS(K) = (CONS1*NS3D(K)/QNI3D(K))**(1./DS)<a name='2206'>
      N0S(K) = NS3D(K)*LAMS(K)<a name='2207'>
<a name='2208'>
<font color=#447700>! CHECK FOR SLOPE<a name='2209'></font>
<a name='2210'>
<font color=#447700>! ADJUST VARS<a name='2211'></font>
<a name='2212'>
      IF (LAMS(K).LT.LAMMINS) THEN<a name='2213'>
      LAMS(K) = LAMMINS<a name='2214'>
      N0S(K) = LAMS(K)**4*QNI3D(K)/CONS1<a name='2215'>
<a name='2216'>
      NS3D(K) = N0S(K)/LAMS(K)<a name='2217'>
<a name='2218'>
      ELSE IF (LAMS(K).GT.LAMMAXS) THEN<a name='2219'>
<a name='2220'>
      LAMS(K) = LAMMAXS<a name='2221'>
      N0S(K) = LAMS(K)**4*QNI3D(K)/CONS1<a name='2222'>
<a name='2223'>
      NS3D(K) = N0S(K)/LAMS(K)<a name='2224'>
      END IF<a name='2225'>
      END IF<a name='2226'>
<a name='2227'>
<font color=#447700>!......................................................................<a name='2228'></font>
<font color=#447700>! GRAUPEL<a name='2229'></font>
<a name='2230'>
      IF (QG3D(K).GE.QSMALL) THEN<a name='2231'>
      LAMG(K) = (CONS2*NG3D(K)/QG3D(K))**(1./DG)<a name='2232'>
      N0G(K) = NG3D(K)*LAMG(K)<a name='2233'>
<a name='2234'>
<font color=#447700>! CHECK FOR SLOPE<a name='2235'></font>
<a name='2236'>
<font color=#447700>! ADJUST VARS<a name='2237'></font>
<a name='2238'>
      IF (LAMG(K).LT.LAMMING) THEN<a name='2239'>
      LAMG(K) = LAMMING<a name='2240'>
      N0G(K) = LAMG(K)**4*QG3D(K)/CONS2<a name='2241'>
<a name='2242'>
      NG3D(K) = N0G(K)/LAMG(K)<a name='2243'>
<a name='2244'>
      ELSE IF (LAMG(K).GT.LAMMAXG) THEN<a name='2245'>
<a name='2246'>
      LAMG(K) = LAMMAXG<a name='2247'>
      N0G(K) = LAMG(K)**4*QG3D(K)/CONS2<a name='2248'>
<a name='2249'>
      NG3D(K) = N0G(K)/LAMG(K)<a name='2250'>
      END IF<a name='2251'>
      END IF<a name='2252'>
<a name='2253'>
<font color=#447700>!.....................................................................<a name='2254'></font>
<font color=#447700>! ZERO OUT PROCESS RATES<a name='2255'></font>
<a name='2256'>
            MNUCCC(K) = 0.<a name='2257'>
            NNUCCC(K) = 0.<a name='2258'>
            PRC(K) = 0.<a name='2259'>
            NPRC(K) = 0.<a name='2260'>
            NPRC1(K) = 0.<a name='2261'>
            NSAGG(K) = 0.<a name='2262'>
            PSACWS(K) = 0.<a name='2263'>
            NPSACWS(K) = 0.<a name='2264'>
            PSACWI(K) = 0.<a name='2265'>
            NPSACWI(K) = 0.<a name='2266'>
            PRACS(K) = 0.<a name='2267'>
            NPRACS(K) = 0.<a name='2268'>
            NMULTS(K) = 0.<a name='2269'>
            QMULTS(K) = 0.<a name='2270'>
            NMULTR(K) = 0.<a name='2271'>
            QMULTR(K) = 0.<a name='2272'>
            NMULTG(K) = 0.<a name='2273'>
            QMULTG(K) = 0.<a name='2274'>
            NMULTRG(K) = 0.<a name='2275'>
            QMULTRG(K) = 0.<a name='2276'>
            MNUCCR(K) = 0.<a name='2277'>
            NNUCCR(K) = 0.<a name='2278'>
            PRA(K) = 0.<a name='2279'>
            NPRA(K) = 0.<a name='2280'>
            NRAGG(K) = 0.<a name='2281'>
            PRCI(K) = 0.<a name='2282'>
            NPRCI(K) = 0.<a name='2283'>
            PRAI(K) = 0.<a name='2284'>
            NPRAI(K) = 0.<a name='2285'>
            NNUCCD(K) = 0.<a name='2286'>
            MNUCCD(K) = 0.<a name='2287'>
            PCC(K) = 0.<a name='2288'>
            PRE(K) = 0.<a name='2289'>
            PRD(K) = 0.<a name='2290'>
            PRDS(K) = 0.<a name='2291'>
            EPRD(K) = 0.<a name='2292'>
            EPRDS(K) = 0.<a name='2293'>
            NSUBC(K) = 0.<a name='2294'>
            NSUBI(K) = 0.<a name='2295'>
            NSUBS(K) = 0.<a name='2296'>
            NSUBR(K) = 0.<a name='2297'>
            PIACR(K) = 0.<a name='2298'>
            NIACR(K) = 0.<a name='2299'>
            PRACI(K) = 0.<a name='2300'>
            PIACRS(K) = 0.<a name='2301'>
            NIACRS(K) = 0.<a name='2302'>
            PRACIS(K) = 0.<a name='2303'>
<font color=#447700>! HM: ADD GRAUPEL PROCESSES<a name='2304'></font>
            PRACG(K) = 0.<a name='2305'>
            PSACR(K) = 0.<a name='2306'>
	    PSACWG(K) = 0.<a name='2307'>
	    PGSACW(K) = 0.<a name='2308'>
            PGRACS(K) = 0.<a name='2309'>
	    PRDG(K) = 0.<a name='2310'>
	    EPRDG(K) = 0.<a name='2311'>
	    NPRACG(K) = 0.<a name='2312'>
	    NPSACWG(K) = 0.<a name='2313'>
	    NSCNG(K) = 0.<a name='2314'>
 	    NGRACS(K) = 0.<a name='2315'>
	    NSUBG(K) = 0.<a name='2316'>
<a name='2317'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2318'></font>
<font color=#447700>! CALCULATION OF MICROPHYSICAL PROCESS RATES<a name='2319'></font>
<font color=#447700>! ACCRETION/AUTOCONVERSION/FREEZING/MELTING/COAG.<a name='2320'></font>
<font color=#447700>!.......................................................................<a name='2321'></font>
<font color=#447700>! FREEZING OF CLOUD DROPLETS<a name='2322'></font>
<font color=#447700>! ONLY ALLOWED BELOW -4 C<a name='2323'></font>
        IF (QC3D(K).GE.QSMALL .AND. T3D(K).LT.269.15) THEN<a name='2324'>
<a name='2325'>
<font color=#447700>! NUMBER OF CONTACT NUCLEI (M^-3) FROM MEYERS ET AL., 1992<a name='2326'></font>
<font color=#447700>! FACTOR OF 1000 IS TO CONVERT FROM L^-1 TO M^-3<a name='2327'></font>
<a name='2328'>
<font color=#447700>! MEYERS CURVE<a name='2329'></font>
<a name='2330'>
           NACNT = EXP(-2.80+0.262*(273.15-T3D(K)))*1000.<a name='2331'>
<a name='2332'>
<font color=#447700>! COOPER CURVE<a name='2333'></font>
<font color=#447700>!        NACNT =  5.*EXP(0.304*(273.15-T3D(K)))<a name='2334'></font>
<a name='2335'>
<font color=#447700>! FLECTHER<a name='2336'></font>
<font color=#447700>!     NACNT = 0.01*EXP(0.6*(273.15-T3D(K)))<a name='2337'></font>
<a name='2338'>
<font color=#447700>! CONTACT FREEZING<a name='2339'></font>
<a name='2340'>
<font color=#447700>! MEAN FREE PATH<a name='2341'></font>
<a name='2342'>
            DUM = 7.37*T3D(K)/(288.*10.*PRES(K))/100.<a name='2343'>
<a name='2344'>
<font color=#447700>! EFFECTIVE DIFFUSIVITY OF CONTACT NUCLEI<a name='2345'></font>
<font color=#447700>! BASED ON BROWNIAN DIFFUSION<a name='2346'></font>
<a name='2347'>
            DAP(K) = CONS37*T3D(K)*(1.+DUM/RIN)/MU(K)<a name='2348'>
 <a name='2349'>
           MNUCCC(K) = CONS38*DAP(K)*NACNT*EXP(LOG(CDIST1(K))+   &amp;<a name='2350'>
                   LOG(GAMMA(PGAM(K)+5.))-4.*LOG(LAMC(K)))<a name='2351'>
           NNUCCC(K) = 2.*PI*DAP(K)*NACNT*CDIST1(K)*           &amp;<a name='2352'>
                    GAMMA(PGAM(K)+2.)/                         &amp;<a name='2353'>
                    LAMC(K)<a name='2354'>
<a name='2355'>
<font color=#447700>! IMMERSION FREEZING (BIGG 1953)<a name='2356'></font>
<a name='2357'>
<font color=#447700>!           MNUCCC(K) = MNUCCC(K)+CONS39*                   &amp;<a name='2358'></font>
<font color=#447700>!                  EXP(LOG(CDIST1(K))+LOG(GAMMA(7.+PGAM(K)))-6.*LOG(LAMC(K)))*             &amp;<a name='2359'></font>
<font color=#447700>!                   EXP(AIMM*(273.15-T3D(K)))<a name='2360'></font>
<a name='2361'>
<font color=#447700>!           NNUCCC(K) = NNUCCC(K)+                                  &amp;<a name='2362'></font>
<font color=#447700>!            CONS40*EXP(LOG(CDIST1(K))+LOG(GAMMA(PGAM(K)+4.))-3.*LOG(LAMC(K)))              &amp;<a name='2363'></font>
<font color=#447700>!                *EXP(AIMM*(273.15-T3D(K)))<a name='2364'></font>
<a name='2365'>
<font color=#447700>! hm 7/15/13 fix for consistency w/ original formula<a name='2366'></font>
           MNUCCC(K) = MNUCCC(K)+CONS39*                   &amp;<a name='2367'>
                  EXP(LOG(CDIST1(K))+LOG(GAMMA(7.+PGAM(K)))-6.*LOG(LAMC(K)))*             &amp;<a name='2368'>
                   (EXP(AIMM*(273.15-T3D(K)))-1.)<a name='2369'>
<a name='2370'>
           NNUCCC(K) = NNUCCC(K)+                                  &amp;<a name='2371'>
            CONS40*EXP(LOG(CDIST1(K))+LOG(GAMMA(PGAM(K)+4.))-3.*LOG(LAMC(K)))              &amp;<a name='2372'>
                *(EXP(AIMM*(273.15-T3D(K)))-1.)<a name='2373'>
<a name='2374'>
<font color=#447700>! PUT IN A CATCH HERE TO PREVENT DIVERGENCE BETWEEN NUMBER CONC. AND<a name='2375'></font>
<font color=#447700>! MIXING RATIO, SINCE STRICT CONSERVATION NOT CHECKED FOR NUMBER CONC<a name='2376'></font>
<a name='2377'>
           NNUCCC(K) = MIN(NNUCCC(K),NC3D(K)/DT)<a name='2378'>
<a name='2379'>
        END IF<a name='2380'>
<a name='2381'>
<font color=#447700>!.................................................................<a name='2382'></font>
<font color=#447700>!.......................................................................<a name='2383'></font>
<font color=#447700>! AUTOCONVERSION OF CLOUD LIQUID WATER TO RAIN<a name='2384'></font>
<font color=#447700>! FORMULA FROM BEHENG (1994)<a name='2385'></font>
<font color=#447700>! USING NUMERICAL SIMULATION OF STOCHASTIC COLLECTION EQUATION<a name='2386'></font>
<font color=#447700>! AND INITIAL CLOUD DROPLET SIZE DISTRIBUTION SPECIFIED<a name='2387'></font>
<font color=#447700>! AS A GAMMA DISTRIBUTION<a name='2388'></font>
<a name='2389'>
<font color=#447700>! USE MINIMUM VALUE OF 1.E-6 TO PREVENT FLOATING POINT ERROR<a name='2390'></font>
<a name='2391'>
         IF (QC3D(K).GE.1.E-6) THEN<a name='2392'>
<a name='2393'>
<font color=#447700>! HM ADD 12/13/06, REPLACE WITH NEWER FORMULA<a name='2394'></font>
<font color=#447700>! FROM KHAIROUTDINOV AND KOGAN 2000, MWR<a name='2395'></font>
<a name='2396'>
                PRC(K)=1350.*QC3D(K)**2.47*  &amp;<a name='2397'>
           (NC3D(K)/1.e6*RHO(K))**(-1.79)<a name='2398'>
<a name='2399'>
<font color=#447700>! note: nprc1 is change in Nr,<a name='2400'></font>
<font color=#447700>! nprc is change in Nc<a name='2401'></font>
<a name='2402'>
        NPRC1(K) = PRC(K)/CONS29<a name='2403'>
        NPRC(K) = PRC(K)/(QC3D(K)/NC3D(K))<a name='2404'>
<a name='2405'>
<font color=#447700>! hm bug fix 3/20/12<a name='2406'></font>
                NPRC(K) = MIN(NPRC(K),NC3D(K)/DT)<a name='2407'>
                NPRC1(K) = MIN(NPRC1(K),NPRC(K))<a name='2408'>
<a name='2409'>
         END IF<a name='2410'>
<a name='2411'>
<font color=#447700>!.......................................................................<a name='2412'></font>
<font color=#447700>! SELF-COLLECTION OF DROPLET NOT INCLUDED IN KK2000 SCHEME<a name='2413'></font>
<a name='2414'>
<font color=#447700>! SNOW AGGREGATION FROM PASSARELLI, 1978, USED BY REISNER, 1998<a name='2415'></font>
<font color=#447700>! THIS IS HARD-WIRED FOR BS = 0.4 FOR NOW<a name='2416'></font>
<a name='2417'>
         IF (QNI3D(K).GE.1.E-8) THEN<a name='2418'>
             NSAGG(K) = CONS15*ASN(K)*RHO(K)**            &amp;<a name='2419'>
            ((2.+BS)/3.)*QNI3D(K)**((2.+BS)/3.)*                  &amp;<a name='2420'>
            (NS3D(K)*RHO(K))**((4.-BS)/3.)/                       &amp;<a name='2421'>
            (RHO(K))<a name='2422'>
         END IF<a name='2423'>
<a name='2424'>
<font color=#447700>!.......................................................................<a name='2425'></font>
<font color=#447700>! ACCRETION OF CLOUD DROPLETS ONTO SNOW/GRAUPEL<a name='2426'></font>
<font color=#447700>! HERE USE CONTINUOUS COLLECTION EQUATION WITH<a name='2427'></font>
<font color=#447700>! SIMPLE GRAVITATIONAL COLLECTION KERNEL IGNORING<a name='2428'></font>
<a name='2429'>
<font color=#447700>! SNOW<a name='2430'></font>
<a name='2431'>
         IF (QNI3D(K).GE.1.E-8 .AND. QC3D(K).GE.QSMALL) THEN<a name='2432'>
<a name='2433'>
           PSACWS(K) = CONS13*ASN(K)*QC3D(K)*RHO(K)*               &amp;<a name='2434'>
                  N0S(K)/                        &amp;<a name='2435'>
                  LAMS(K)**(BS+3.)<a name='2436'>
           NPSACWS(K) = CONS13*ASN(K)*NC3D(K)*RHO(K)*              &amp;<a name='2437'>
                  N0S(K)/                        &amp;<a name='2438'>
                  LAMS(K)**(BS+3.)<a name='2439'>
<a name='2440'>
         END IF<a name='2441'>
<a name='2442'>
<font color=#447700>!............................................................................<a name='2443'></font>
<font color=#447700>! COLLECTION OF CLOUD WATER BY GRAUPEL<a name='2444'></font>
<a name='2445'>
         IF (QG3D(K).GE.1.E-8 .AND. QC3D(K).GE.QSMALL) THEN<a name='2446'>
<a name='2447'>
           PSACWG(K) = CONS14*AGN(K)*QC3D(K)*RHO(K)*               &amp;<a name='2448'>
                  N0G(K)/                        &amp;<a name='2449'>
                  LAMG(K)**(BG+3.)<a name='2450'>
           NPSACWG(K) = CONS14*AGN(K)*NC3D(K)*RHO(K)*              &amp;<a name='2451'>
                  N0G(K)/                        &amp;<a name='2452'>
                  LAMG(K)**(BG+3.)<a name='2453'>
	    END IF<a name='2454'>
<a name='2455'>
<font color=#447700>!.......................................................................<a name='2456'></font>
<font color=#447700>! HM, ADD 12/13/06<a name='2457'></font>
<font color=#447700>! CLOUD ICE COLLECTING DROPLETS, ASSUME THAT CLOUD ICE MEAN DIAM &gt; 100 MICRON<a name='2458'></font>
<font color=#447700>! BEFORE RIMING CAN OCCUR<a name='2459'></font>
<font color=#447700>! ASSUME THAT RIME COLLECTED ON CLOUD ICE DOES NOT LEAD<a name='2460'></font>
<font color=#447700>! TO HALLET-MOSSOP SPLINTERING<a name='2461'></font>
<a name='2462'>
         IF (QI3D(K).GE.1.E-8 .AND. QC3D(K).GE.QSMALL) THEN<a name='2463'>
<a name='2464'>
<font color=#447700>! PUT IN SIZE DEPENDENT COLLECTION EFFICIENCY BASED ON STOKES LAW<a name='2465'></font>
<font color=#447700>! FROM THOMPSON ET AL. 2004, MWR<a name='2466'></font>
<a name='2467'>
            IF (1./LAMI(K).GE.100.E-6) THEN<a name='2468'>
<a name='2469'>
           PSACWI(K) = CONS16*AIN(K)*QC3D(K)*RHO(K)*               &amp;<a name='2470'>
                  N0I(K)/                        &amp;<a name='2471'>
                  LAMI(K)**(BI+3.)<a name='2472'>
           NPSACWI(K) = CONS16*AIN(K)*NC3D(K)*RHO(K)*              &amp;<a name='2473'>
                  N0I(K)/                        &amp;<a name='2474'>
                  LAMI(K)**(BI+3.)<a name='2475'>
           END IF<a name='2476'>
         END IF<a name='2477'>
<a name='2478'>
<font color=#447700>!.......................................................................<a name='2479'></font>
<font color=#447700>! ACCRETION OF RAIN WATER BY SNOW<a name='2480'></font>
<font color=#447700>! FORMULA FROM IKAWA AND SAITO, 1991, USED BY REISNER ET AL, 1998<a name='2481'></font>
<a name='2482'>
         IF (QR3D(K).GE.1.E-8.AND.QNI3D(K).GE.1.E-8) THEN<a name='2483'>
<a name='2484'>
            UMS = ASN(K)*CONS3/(LAMS(K)**BS)<a name='2485'>
            UMR = ARN(K)*CONS4/(LAMR(K)**BR)<a name='2486'>
            UNS = ASN(K)*CONS5/LAMS(K)**BS<a name='2487'>
            UNR = ARN(K)*CONS6/LAMR(K)**BR<a name='2488'>
<a name='2489'>
<font color=#447700>! SET REASLISTIC LIMITS ON FALLSPEEDS<a name='2490'></font>
<a name='2491'>
<font color=#447700>! bug fix, 10/08/09<a name='2492'></font>
            dum=(rhosu/rho(k))**0.54<a name='2493'>
            UMS=MIN(UMS,1.2*dum)<a name='2494'>
            UNS=MIN(UNS,1.2*dum)<a name='2495'>
            UMR=MIN(UMR,9.1*dum)<a name='2496'>
            UNR=MIN(UNR,9.1*dum)<a name='2497'>
<a name='2498'>
            PRACS(K) = CONS41*(((1.2*UMR-0.95*UMS)**2+                   &amp;<a name='2499'>
                  0.08*UMS*UMR)**0.5*RHO(K)*                      &amp;<a name='2500'>
                  N0RR(K)*N0S(K)/LAMR(K)**3*                              &amp;<a name='2501'>
                  (5./(LAMR(K)**3*LAMS(K))+                    &amp;<a name='2502'>
                  2./(LAMR(K)**2*LAMS(K)**2)+                  &amp;				 <a name='2503'>
                  0.5/(LAMR(k)*LAMS(k)**3)))<a name='2504'>
<a name='2505'>
            NPRACS(K) = CONS32*RHO(K)*(1.7*(UNR-UNS)**2+            &amp;<a name='2506'>
                0.3*UNR*UNS)**0.5*N0RR(K)*N0S(K)*              &amp;<a name='2507'>
                (1./(LAMR(K)**3*LAMS(K))+                      &amp;<a name='2508'>
                 1./(LAMR(K)**2*LAMS(K)**2)+                   &amp;<a name='2509'>
                 1./(LAMR(K)*LAMS(K)**3))<a name='2510'>
<a name='2511'>
<font color=#447700>! MAKE SURE PRACS DOESN'T EXCEED TOTAL RAIN MIXING RATIO<a name='2512'></font>
<font color=#447700>! AS THIS MAY OTHERWISE RESULT IN TOO MUCH TRANSFER OF WATER DURING<a name='2513'></font>
<font color=#447700>! RIME-SPLINTERING<a name='2514'></font>
<a name='2515'>
            PRACS(K) = MIN(PRACS(K),QR3D(K)/DT)<a name='2516'>
<a name='2517'>
<font color=#447700>! COLLECTION OF SNOW BY RAIN - NEEDED FOR GRAUPEL CONVERSION CALCULATIONS<a name='2518'></font>
<font color=#447700>! ONLY CALCULATE IF SNOW AND RAIN MIXING RATIOS EXCEED 0.1 G/KG<a name='2519'></font>
<a name='2520'>
<font color=#447700>! HM MODIFY FOR WRFV3.1<a name='2521'></font>
<font color=#447700>!            IF (IHAIL.EQ.0) THEN<a name='2522'></font>
            IF (QNI3D(K).GE.0.1E-3.AND.QR3D(K).GE.0.1E-3) THEN<a name='2523'>
            PSACR(K) = CONS31*(((1.2*UMR-0.95*UMS)**2+              &amp;<a name='2524'>
                  0.08*UMS*UMR)**0.5*RHO(K)*                     &amp;<a name='2525'>
                 N0RR(K)*N0S(K)/LAMS(K)**3*                               &amp;<a name='2526'>
                  (5./(LAMS(K)**3*LAMR(K))+                    &amp;<a name='2527'>
                  2./(LAMS(K)**2*LAMR(K)**2)+                  &amp;<a name='2528'>
                  0.5/(LAMS(K)*LAMR(K)**3)))            <a name='2529'>
            END IF<a name='2530'>
<font color=#447700>!            END IF<a name='2531'></font>
<a name='2532'>
         END IF<a name='2533'>
<a name='2534'>
<font color=#447700>!.......................................................................<a name='2535'></font>
<a name='2536'>
<font color=#447700>! COLLECTION OF RAINWATER BY GRAUPEL, FROM IKAWA AND SAITO 1990, <a name='2537'></font>
<font color=#447700>! USED BY REISNER ET AL 1998<a name='2538'></font>
         IF (QR3D(K).GE.1.E-8.AND.QG3D(K).GE.1.E-8) THEN<a name='2539'>
<a name='2540'>
            UMG = AGN(K)*CONS7/(LAMG(K)**BG)<a name='2541'>
            UMR = ARN(K)*CONS4/(LAMR(K)**BR)<a name='2542'>
            UNG = AGN(K)*CONS8/LAMG(K)**BG<a name='2543'>
            UNR = ARN(K)*CONS6/LAMR(K)**BR<a name='2544'>
<a name='2545'>
<font color=#447700>! SET REASLISTIC LIMITS ON FALLSPEEDS<a name='2546'></font>
<font color=#447700>! bug fix, 10/08/09<a name='2547'></font>
            dum=(rhosu/rho(k))**0.54<a name='2548'>
            UMG=MIN(UMG,20.*dum)<a name='2549'>
            UNG=MIN(UNG,20.*dum)<a name='2550'>
            UMR=MIN(UMR,9.1*dum)<a name='2551'>
            UNR=MIN(UNR,9.1*dum)<a name='2552'>
<a name='2553'>
            PRACG(K) = CONS41*(((1.2*UMR-0.95*UMG)**2+                   &amp;<a name='2554'>
                  0.08*UMG*UMR)**0.5*RHO(K)*                      &amp;<a name='2555'>
                  N0RR(K)*N0G(K)/LAMR(K)**3*                              &amp;<a name='2556'>
                  (5./(LAMR(K)**3*LAMG(K))+                    &amp;<a name='2557'>
                  2./(LAMR(K)**2*LAMG(K)**2)+				   &amp;<a name='2558'>
				  0.5/(LAMR(k)*LAMG(k)**3)))<a name='2559'>
<a name='2560'>
            NPRACG(K) = CONS32*RHO(K)*(1.7*(UNR-UNG)**2+            &amp;<a name='2561'>
                0.3*UNR*UNG)**0.5*N0RR(K)*N0G(K)*              &amp;<a name='2562'>
                (1./(LAMR(K)**3*LAMG(K))+                      &amp;<a name='2563'>
                 1./(LAMR(K)**2*LAMG(K)**2)+                   &amp;<a name='2564'>
                 1./(LAMR(K)*LAMG(K)**3))<a name='2565'>
<a name='2566'>
<font color=#447700>! MAKE SURE PRACG DOESN'T EXCEED TOTAL RAIN MIXING RATIO<a name='2567'></font>
<font color=#447700>! AS THIS MAY OTHERWISE RESULT IN TOO MUCH TRANSFER OF WATER DURING<a name='2568'></font>
<font color=#447700>! RIME-SPLINTERING<a name='2569'></font>
<a name='2570'>
            PRACG(K) = MIN(PRACG(K),QR3D(K)/DT)<a name='2571'>
<a name='2572'>
	    END IF<a name='2573'>
<a name='2574'>
<font color=#447700>!.......................................................................<a name='2575'></font>
<font color=#447700>! RIME-SPLINTERING - SNOW<a name='2576'></font>
<font color=#447700>! HALLET-MOSSOP (1974)<a name='2577'></font>
<font color=#447700>! NUMBER OF SPLINTERS FORMED IS BASED ON MASS OF RIMED WATER<a name='2578'></font>
<a name='2579'>
<font color=#447700>! DUM1 = MASS OF INDIVIDUAL SPLINTERS<a name='2580'></font>
<a name='2581'>
<font color=#447700>! HM ADD THRESHOLD SNOW AND DROPLET MIXING RATIO FOR RIME-SPLINTERING<a name='2582'></font>
<font color=#447700>! TO LIMIT RIME-SPLINTERING IN STRATIFORM CLOUDS<a name='2583'></font>
<font color=#447700>! THESE THRESHOLDS CORRESPOND WITH GRAUPEL THRESHOLDS IN RH 1984<a name='2584'></font>
<a name='2585'>
<font color=#447700>!v1.4<a name='2586'></font>
         IF (QNI3D(K).GE.0.1E-3) THEN<a name='2587'>
         IF (QC3D(K).GE.0.5E-3.OR.QR3D(K).GE.0.1E-3) THEN<a name='2588'>
         IF (PSACWS(K).GT.0..OR.PRACS(K).GT.0.) THEN<a name='2589'>
            IF (T3D(K).LT.270.16 .AND. T3D(K).GT.265.16) THEN<a name='2590'>
<a name='2591'>
               IF (T3D(K).GT.270.16) THEN<a name='2592'>
                  FMULT = 0.<a name='2593'>
               ELSE IF (T3D(K).LE.270.16.AND.T3D(K).GT.268.16)  THEN<a name='2594'>
                  FMULT = (270.16-T3D(K))/2.<a name='2595'>
               ELSE IF (T3D(K).GE.265.16.AND.T3D(K).LE.268.16)   THEN<a name='2596'>
                  FMULT = (T3D(K)-265.16)/3.<a name='2597'>
               ELSE IF (T3D(K).LT.265.16) THEN<a name='2598'>
                  FMULT = 0.<a name='2599'>
               END IF<a name='2600'>
<a name='2601'>
<font color=#447700>! 1000 IS TO CONVERT FROM KG TO G<a name='2602'></font>
<a name='2603'>
<font color=#447700>! SPLINTERING FROM DROPLETS ACCRETED ONTO SNOW<a name='2604'></font>
<a name='2605'>
               IF (PSACWS(K).GT.0.) THEN<a name='2606'>
                  NMULTS(K) = 35.E4*PSACWS(K)*FMULT*1000.<a name='2607'>
                  QMULTS(K) = NMULTS(K)*MMULT<a name='2608'>
<a name='2609'>
<font color=#447700>! CONSTRAIN SO THAT TRANSFER OF MASS FROM SNOW TO ICE CANNOT BE MORE MASS<a name='2610'></font>
<font color=#447700>! THAN WAS RIMED ONTO SNOW<a name='2611'></font>
<a name='2612'>
                  QMULTS(K) = MIN(QMULTS(K),PSACWS(K))<a name='2613'>
                  PSACWS(K) = PSACWS(K)-QMULTS(K)<a name='2614'>
<a name='2615'>
               END IF<a name='2616'>
<a name='2617'>
<font color=#447700>! RIMING AND SPLINTERING FROM ACCRETED RAINDROPS<a name='2618'></font>
<a name='2619'>
               IF (PRACS(K).GT.0.) THEN<a name='2620'>
                   NMULTR(K) = 35.E4*PRACS(K)*FMULT*1000.<a name='2621'>
                   QMULTR(K) = NMULTR(K)*MMULT<a name='2622'>
<a name='2623'>
<font color=#447700>! CONSTRAIN SO THAT TRANSFER OF MASS FROM SNOW TO ICE CANNOT BE MORE MASS<a name='2624'></font>
<font color=#447700>! THAN WAS RIMED ONTO SNOW<a name='2625'></font>
<a name='2626'>
                   QMULTR(K) = MIN(QMULTR(K),PRACS(K))<a name='2627'>
<a name='2628'>
                   PRACS(K) = PRACS(K)-QMULTR(K)<a name='2629'>
<a name='2630'>
               END IF<a name='2631'>
<a name='2632'>
            END IF<a name='2633'>
         END IF<a name='2634'>
         END IF<a name='2635'>
         END IF<a name='2636'>
<a name='2637'>
<font color=#447700>!.......................................................................<a name='2638'></font>
<font color=#447700>! RIME-SPLINTERING - GRAUPEL <a name='2639'></font>
<font color=#447700>! HALLET-MOSSOP (1974)<a name='2640'></font>
<font color=#447700>! NUMBER OF SPLINTERS FORMED IS BASED ON MASS OF RIMED WATER<a name='2641'></font>
<a name='2642'>
<font color=#447700>! DUM1 = MASS OF INDIVIDUAL SPLINTERS<a name='2643'></font>
<a name='2644'>
<font color=#447700>! HM ADD THRESHOLD SNOW MIXING RATIO FOR RIME-SPLINTERING<a name='2645'></font>
<font color=#447700>! TO LIMIT RIME-SPLINTERING IN STRATIFORM CLOUDS<a name='2646'></font>
<a name='2647'>
<font color=#447700>!         IF (IHAIL.EQ.0) THEN<a name='2648'></font>
<font color=#447700>! v1.4<a name='2649'></font>
         IF (QG3D(K).GE.0.1E-3) THEN<a name='2650'>
         IF (QC3D(K).GE.0.5E-3.OR.QR3D(K).GE.0.1E-3) THEN<a name='2651'>
         IF (PSACWG(K).GT.0..OR.PRACG(K).GT.0.) THEN<a name='2652'>
            IF (T3D(K).LT.270.16 .AND. T3D(K).GT.265.16) THEN<a name='2653'>
<a name='2654'>
               IF (T3D(K).GT.270.16) THEN<a name='2655'>
                  FMULT = 0.<a name='2656'>
               ELSE IF (T3D(K).LE.270.16.AND.T3D(K).GT.268.16)  THEN<a name='2657'>
                  FMULT = (270.16-T3D(K))/2.<a name='2658'>
               ELSE IF (T3D(K).GE.265.16.AND.T3D(K).LE.268.16)   THEN<a name='2659'>
                  FMULT = (T3D(K)-265.16)/3.<a name='2660'>
               ELSE IF (T3D(K).LT.265.16) THEN<a name='2661'>
                  FMULT = 0.<a name='2662'>
               END IF<a name='2663'>
<a name='2664'>
<font color=#447700>! 1000 IS TO CONVERT FROM KG TO G<a name='2665'></font>
<a name='2666'>
<font color=#447700>! SPLINTERING FROM DROPLETS ACCRETED ONTO GRAUPEL<a name='2667'></font>
<a name='2668'>
               IF (PSACWG(K).GT.0.) THEN<a name='2669'>
                  NMULTG(K) = 35.E4*PSACWG(K)*FMULT*1000.<a name='2670'>
                  QMULTG(K) = NMULTG(K)*MMULT<a name='2671'>
<a name='2672'>
<font color=#447700>! CONSTRAIN SO THAT TRANSFER OF MASS FROM GRAUPEL TO ICE CANNOT BE MORE MASS<a name='2673'></font>
<font color=#447700>! THAN WAS RIMED ONTO GRAUPEL<a name='2674'></font>
<a name='2675'>
                  QMULTG(K) = MIN(QMULTG(K),PSACWG(K))<a name='2676'>
                  PSACWG(K) = PSACWG(K)-QMULTG(K)<a name='2677'>
<a name='2678'>
               END IF<a name='2679'>
<a name='2680'>
<font color=#447700>! RIMING AND SPLINTERING FROM ACCRETED RAINDROPS<a name='2681'></font>
<a name='2682'>
               IF (PRACG(K).GT.0.) THEN<a name='2683'>
                   NMULTRG(K) = 35.E4*PRACG(K)*FMULT*1000.<a name='2684'>
                   QMULTRG(K) = NMULTRG(K)*MMULT<a name='2685'>
<a name='2686'>
<font color=#447700>! CONSTRAIN SO THAT TRANSFER OF MASS FROM GRAUPEL TO ICE CANNOT BE MORE MASS<a name='2687'></font>
<font color=#447700>! THAN WAS RIMED ONTO GRAUPEL<a name='2688'></font>
<a name='2689'>
                   QMULTRG(K) = MIN(QMULTRG(K),PRACG(K))<a name='2690'>
                   PRACG(K) = PRACG(K)-QMULTRG(K)<a name='2691'>
<a name='2692'>
               END IF<a name='2693'>
               END IF<a name='2694'>
               END IF<a name='2695'>
            END IF<a name='2696'>
            END IF<a name='2697'>
<font color=#447700>!         END IF<a name='2698'></font>
<a name='2699'>
<font color=#447700>!........................................................................<a name='2700'></font>
<font color=#447700>! CONVERSION OF RIMED CLOUD WATER ONTO SNOW TO GRAUPEL/HAIL<a name='2701'></font>
<a name='2702'>
<font color=#447700>!           IF (IHAIL.EQ.0) THEN<a name='2703'></font>
	   IF (PSACWS(K).GT.0.) THEN<a name='2704'>
<font color=#447700>! ONLY ALLOW CONVERSION IF QNI &gt; 0.1 AND QC &gt; 0.5 G/KG FOLLOWING RUTLEDGE AND HOBBS (1984)<a name='2705'></font>
              IF (QNI3D(K).GE.0.1E-3.AND.QC3D(K).GE.0.5E-3) THEN<a name='2706'>
<a name='2707'>
<font color=#447700>! PORTION OF RIMING CONVERTED TO GRAUPEL (REISNER ET AL. 1998, ORIGINALLY IS1991)<a name='2708'></font>
	     PGSACW(K) = MIN(PSACWS(K),CONS17*DT*N0S(K)*QC3D(K)*QC3D(K)* &amp;<a name='2709'>
                          ASN(K)*ASN(K)/ &amp;<a name='2710'>
                           (RHO(K)*LAMS(K)**(2.*BS+2.))) <a name='2711'>
<a name='2712'>
<font color=#447700>! MIX RAT CONVERTED INTO GRAUPEL AS EMBRYO (REISNER ET AL. 1998, ORIG M1990)<a name='2713'></font>
	     DUM = MAX(RHOSN/(RHOG-RHOSN)*PGSACW(K),0.) <a name='2714'>
<a name='2715'>
<font color=#447700>! NUMBER CONCENTRAITON OF EMBRYO GRAUPEL FROM RIMING OF SNOW<a name='2716'></font>
	     NSCNG(K) = DUM/MG0*RHO(K)<a name='2717'>
<font color=#447700>! LIMIT MAX NUMBER CONVERTED TO SNOW NUMBER<a name='2718'></font>
             NSCNG(K) = MIN(NSCNG(K),NS3D(K)/DT)<a name='2719'>
<a name='2720'>
<font color=#447700>! PORTION OF RIMING LEFT FOR SNOW<a name='2721'></font>
             PSACWS(K) = PSACWS(K) - PGSACW(K)<a name='2722'>
             END IF<a name='2723'>
	   END IF<a name='2724'>
<a name='2725'>
<font color=#447700>! CONVERSION OF RIMED RAINWATER ONTO SNOW CONVERTED TO GRAUPEL<a name='2726'></font>
<a name='2727'>
	   IF (PRACS(K).GT.0.) THEN<a name='2728'>
<font color=#447700>! ONLY ALLOW CONVERSION IF QNI &gt; 0.1 AND QR &gt; 0.1 G/KG FOLLOWING RUTLEDGE AND HOBBS (1984)<a name='2729'></font>
              IF (QNI3D(K).GE.0.1E-3.AND.QR3D(K).GE.0.1E-3) THEN<a name='2730'>
<font color=#447700>! PORTION OF COLLECTED RAINWATER CONVERTED TO GRAUPEL (REISNER ET AL. 1998)<a name='2731'></font>
	      DUM = CONS18*(4./LAMS(K))**3*(4./LAMS(K))**3 &amp;    <a name='2732'>
                   /(CONS18*(4./LAMS(K))**3*(4./LAMS(K))**3+ &amp;  <a name='2733'>
                   CONS19*(4./LAMR(K))**3*(4./LAMR(K))**3)<a name='2734'>
              DUM=MIN(DUM,1.)<a name='2735'>
              DUM=MAX(DUM,0.)<a name='2736'>
	      PGRACS(K) = (1.-DUM)*PRACS(K)<a name='2737'>
            NGRACS(K) = (1.-DUM)*NPRACS(K)<a name='2738'>
<font color=#447700>! LIMIT MAX NUMBER CONVERTED TO MIN OF EITHER RAIN OR SNOW NUMBER CONCENTRATION<a name='2739'></font>
            NGRACS(K) = MIN(NGRACS(K),NR3D(K)/DT)<a name='2740'>
            NGRACS(K) = MIN(NGRACS(K),NS3D(K)/DT)<a name='2741'>
<a name='2742'>
<font color=#447700>! AMOUNT LEFT FOR SNOW PRODUCTION<a name='2743'></font>
            PRACS(K) = PRACS(K) - PGRACS(K)<a name='2744'>
            NPRACS(K) = NPRACS(K) - NGRACS(K)<a name='2745'>
<font color=#447700>! CONVERSION TO GRAUPEL DUE TO COLLECTION OF SNOW BY RAIN<a name='2746'></font>
            PSACR(K)=PSACR(K)*(1.-DUM)<a name='2747'>
            END IF<a name='2748'>
	   END IF<a name='2749'>
<font color=#447700>!           END IF<a name='2750'></font>
<a name='2751'>
<font color=#447700>!.......................................................................<a name='2752'></font>
<font color=#447700>! FREEZING OF RAIN DROPS<a name='2753'></font>
<font color=#447700>! FREEZING ALLOWED BELOW -4 C<a name='2754'></font>
<a name='2755'>
         IF (T3D(K).LT.269.15.AND.QR3D(K).GE.QSMALL) THEN<a name='2756'>
<a name='2757'>
<font color=#447700>! IMMERSION FREEZING (BIGG 1953)<a name='2758'></font>
<font color=#447700>!            MNUCCR(K) = CONS20*NR3D(K)*EXP(AIMM*(273.15-T3D(K)))/LAMR(K)**3 &amp;<a name='2759'></font>
<font color=#447700>!                 /LAMR(K)**3<a name='2760'></font>
<a name='2761'>
<font color=#447700>!            NNUCCR(K) = PI*NR3D(K)*BIMM*EXP(AIMM*(273.15-T3D(K)))/LAMR(K)**3<a name='2762'></font>
<a name='2763'>
<font color=#447700>! hm fix 7/15/13 for consistency w/ original formula<a name='2764'></font>
            MNUCCR(K) = CONS20*NR3D(K)*(EXP(AIMM*(273.15-T3D(K)))-1.)/LAMR(K)**3 &amp;<a name='2765'>
                 /LAMR(K)**3<a name='2766'>
<a name='2767'>
            NNUCCR(K) = PI*NR3D(K)*BIMM*(EXP(AIMM*(273.15-T3D(K)))-1.)/LAMR(K)**3<a name='2768'>
<a name='2769'>
<font color=#447700>! PREVENT DIVERGENCE BETWEEN MIXING RATIO AND NUMBER CONC<a name='2770'></font>
            NNUCCR(K) = MIN(NNUCCR(K),NR3D(K)/DT)<a name='2771'>
<a name='2772'>
         END IF<a name='2773'>
<a name='2774'>
<font color=#447700>!.......................................................................<a name='2775'></font>
<font color=#447700>! ACCRETION OF CLOUD LIQUID WATER BY RAIN<a name='2776'></font>
<font color=#447700>! CONTINUOUS COLLECTION EQUATION WITH<a name='2777'></font>
<font color=#447700>! GRAVITATIONAL COLLECTION KERNEL, DROPLET FALL SPEED NEGLECTED<a name='2778'></font>
<a name='2779'>
         IF (QR3D(K).GE.1.E-8 .AND. QC3D(K).GE.1.E-8) THEN<a name='2780'>
<a name='2781'>
<font color=#447700>! 12/13/06 HM ADD, REPLACE WITH NEWER FORMULA FROM<a name='2782'></font>
<font color=#447700>! KHAIROUTDINOV AND KOGAN 2000, MWR<a name='2783'></font>
<a name='2784'>
           DUM=(QC3D(K)*QR3D(K))<a name='2785'>
           PRA(K) = 67.*(DUM)**1.15<a name='2786'>
           NPRA(K) = PRA(K)/(QC3D(K)/NC3D(K))<a name='2787'>
<a name='2788'>
         END IF<a name='2789'>
<font color=#447700>!.......................................................................<a name='2790'></font>
<font color=#447700>! SELF-COLLECTION OF RAIN DROPS<a name='2791'></font>
<font color=#447700>! FROM BEHENG(1994)<a name='2792'></font>
<font color=#447700>! FROM NUMERICAL SIMULATION OF THE STOCHASTIC COLLECTION EQUATION<a name='2793'></font>
<font color=#447700>! AS DESCRINED ABOVE FOR AUTOCONVERSION<a name='2794'></font>
<a name='2795'>
         IF (QR3D(K).GE.1.E-8) THEN<a name='2796'>
<font color=#447700>! include breakup add 10/09/09<a name='2797'></font>
            dum1=300.e-6<a name='2798'>
            if (1./lamr(k).lt.dum1) then<a name='2799'>
            dum=1.<a name='2800'>
            else if (1./lamr(k).ge.dum1) then<a name='2801'>
            dum=2.-exp(2300.*(1./lamr(k)-dum1))<a name='2802'>
            end if<a name='2803'>
<font color=#447700>!            NRAGG(K) = -8.*NR3D(K)*QR3D(K)*RHO(K)<a name='2804'></font>
            NRAGG(K) = -5.78*dum*NR3D(K)*QR3D(K)*RHO(K)<a name='2805'>
         END IF<a name='2806'>
<a name='2807'>
<font color=#447700>!.......................................................................<a name='2808'></font>
<font color=#447700>! AUTOCONVERSION OF CLOUD ICE TO SNOW<a name='2809'></font>
<font color=#447700>! FOLLOWING HARRINGTON ET AL. (1995) WITH MODIFICATION<a name='2810'></font>
<font color=#447700>! HERE IT IS ASSUMED THAT AUTOCONVERSION CAN ONLY OCCUR WHEN THE<a name='2811'></font>
<font color=#447700>! ICE IS GROWING, I.E. IN CONDITIONS OF ICE SUPERSATURATION<a name='2812'></font>
<a name='2813'>
         IF (QI3D(K).GE.1.E-8 .AND.QVQVSI(K).GE.1.) THEN<a name='2814'>
<a name='2815'>
<font color=#447700>!           COFFI = 2./LAMI(K)<a name='2816'></font>
<font color=#447700>!           IF (COFFI.GE.DCS) THEN<a name='2817'></font>
              NPRCI(K) = CONS21*(QV3D(K)-QVI(K))*RHO(K)                         &amp;<a name='2818'>
                *N0I(K)*EXP(-LAMI(K)*DCS)*DV(K)/ABI(K)<a name='2819'>
              PRCI(K) = CONS22*NPRCI(K)<a name='2820'>
              NPRCI(K) = MIN(NPRCI(K),NI3D(K)/DT)<a name='2821'>
<a name='2822'>
<font color=#447700>!           END IF<a name='2823'></font>
         END IF<a name='2824'>
<a name='2825'>
<font color=#447700>!.......................................................................<a name='2826'></font>
<font color=#447700>! ACCRETION OF CLOUD ICE BY SNOW<a name='2827'></font>
<font color=#447700>! FOR THIS CALCULATION, IT IS ASSUMED THAT THE VS &gt;&gt; VI<a name='2828'></font>
<font color=#447700>! AND DS &gt;&gt; DI FOR CONTINUOUS COLLECTION<a name='2829'></font>
<a name='2830'>
         IF (QNI3D(K).GE.1.E-8 .AND. QI3D(K).GE.QSMALL) THEN<a name='2831'>
            PRAI(K) = CONS23*ASN(K)*QI3D(K)*RHO(K)*N0S(K)/     &amp;<a name='2832'>
                     LAMS(K)**(BS+3.)<a name='2833'>
            NPRAI(K) = CONS23*ASN(K)*NI3D(K)*                                       &amp;<a name='2834'>
                  RHO(K)*N0S(K)/                                 &amp;<a name='2835'>
                  LAMS(K)**(BS+3.)<a name='2836'>
            NPRAI(K)=MIN(NPRAI(K),NI3D(K)/DT)<a name='2837'>
         END IF<a name='2838'>
<a name='2839'>
<font color=#447700>!.......................................................................<a name='2840'></font>
<font color=#447700>! HM, ADD 12/13/06, COLLISION OF RAIN AND ICE TO PRODUCE SNOW OR GRAUPEL<a name='2841'></font>
<font color=#447700>! FOLLOWS REISNER ET AL. 1998<a name='2842'></font>
<font color=#447700>! ASSUMED FALLSPEED AND SIZE OF ICE CRYSTAL &lt;&lt; THAN FOR RAIN<a name='2843'></font>
<a name='2844'>
         IF (QR3D(K).GE.1.E-8.AND.QI3D(K).GE.1.E-8.AND.T3D(K).LE.273.15) THEN<a name='2845'>
<a name='2846'>
<font color=#447700>! ALLOW GRAUPEL FORMATION FROM RAIN-ICE COLLISIONS ONLY IF RAIN MIXING RATIO &gt; 0.1 G/KG,<a name='2847'></font>
<font color=#447700>! OTHERWISE ADD TO SNOW<a name='2848'></font>
<a name='2849'>
            IF (QR3D(K).GE.0.1E-3) THEN<a name='2850'>
            NIACR(K)=CONS24*NI3D(K)*N0RR(K)*ARN(K) &amp;<a name='2851'>
                /LAMR(K)**(BR+3.)*RHO(K)<a name='2852'>
            PIACR(K)=CONS25*NI3D(K)*N0RR(K)*ARN(K) &amp;<a name='2853'>
                /LAMR(K)**(BR+3.)/LAMR(K)**3*RHO(K)<a name='2854'>
            PRACI(K)=CONS24*QI3D(K)*N0RR(K)*ARN(K)/ &amp;<a name='2855'>
                LAMR(K)**(BR+3.)*RHO(K)<a name='2856'>
            NIACR(K)=MIN(NIACR(K),NR3D(K)/DT)<a name='2857'>
            NIACR(K)=MIN(NIACR(K),NI3D(K)/DT)<a name='2858'>
            ELSE <a name='2859'>
            NIACRS(K)=CONS24*NI3D(K)*N0RR(K)*ARN(K) &amp;<a name='2860'>
                /LAMR(K)**(BR+3.)*RHO(K)<a name='2861'>
            PIACRS(K)=CONS25*NI3D(K)*N0RR(K)*ARN(K) &amp;<a name='2862'>
                /LAMR(K)**(BR+3.)/LAMR(K)**3*RHO(K)<a name='2863'>
            PRACIS(K)=CONS24*QI3D(K)*N0RR(K)*ARN(K)/ &amp;<a name='2864'>
                LAMR(K)**(BR+3.)*RHO(K)<a name='2865'>
            NIACRS(K)=MIN(NIACRS(K),NR3D(K)/DT)<a name='2866'>
            NIACRS(K)=MIN(NIACRS(K),NI3D(K)/DT)<a name='2867'>
            END IF<a name='2868'>
         END IF<a name='2869'>
<a name='2870'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2871'></font>
<font color=#447700>! NUCLEATION OF CLOUD ICE FROM HOMOGENEOUS AND HETEROGENEOUS FREEZING ON AEROSOL<a name='2872'></font>
<a name='2873'>
         IF (INUC.EQ.0) THEN<a name='2874'>
<a name='2875'>
<font color=#447700>! add threshold according to Greg Thomspon<a name='2876'></font>
<a name='2877'>
         if ((QVQVS(K).GE.0.999.and.T3D(K).le.265.15).or. &amp;<a name='2878'>
              QVQVSI(K).ge.1.08) then<a name='2879'>
<a name='2880'>
<font color=#447700>! hm, modify dec. 5, 2006, replace with cooper curve<a name='2881'></font>
      kc2 = 0.005*exp(0.304*(273.15-T3D(K)))*1000. <font color=#447700>! convert from L-1 to m-3<a name='2882'></font>
<font color=#447700>! limit to 500 L-1<a name='2883'></font>
      kc2 = min(kc2,500.e3)<a name='2884'>
      kc2=MAX(kc2/rho(k),0.)  <font color=#447700>! convert to kg-1<a name='2885'></font>
<a name='2886'>
          IF (KC2.GT.NI3D(K)+NS3D(K)+NG3D(K)) THEN<a name='2887'>
             NNUCCD(K) = (KC2-NI3D(K)-NS3D(K)-NG3D(K))/DT<a name='2888'>
             MNUCCD(K) = NNUCCD(K)*MI0<a name='2889'>
          END IF<a name='2890'>
<a name='2891'>
          END IF<a name='2892'>
<a name='2893'>
          ELSE IF (INUC.EQ.1) THEN<a name='2894'>
<a name='2895'>
          IF (T3D(K).LT.273.15.AND.QVQVSI(K).GT.1.) THEN<a name='2896'>
<a name='2897'>
             KC2 = 0.16*1000./RHO(K)  <font color=#447700>! CONVERT FROM L-1 TO KG-1<a name='2898'></font>
          IF (KC2.GT.NI3D(K)+NS3D(K)+NG3D(K)) THEN<a name='2899'>
             NNUCCD(K) = (KC2-NI3D(K)-NS3D(K)-NG3D(K))/DT<a name='2900'>
             MNUCCD(K) = NNUCCD(K)*MI0<a name='2901'>
          END IF<a name='2902'>
          END IF<a name='2903'>
<a name='2904'>
         END IF<a name='2905'>
<a name='2906'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2907'></font>
<a name='2908'>
 101      CONTINUE<a name='2909'>
<a name='2910'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='2911'></font>
<font color=#447700>! CALCULATE EVAP/SUB/DEP TERMS FOR QI,QNI,QR<a name='2912'></font>
<a name='2913'>
<font color=#447700>! NO VENTILATION FOR CLOUD ICE<a name='2914'></font>
<a name='2915'>
        IF (QI3D(K).GE.QSMALL) THEN<a name='2916'>
<a name='2917'>
         EPSI = 2.*PI*N0I(K)*RHO(K)*DV(K)/(LAMI(K)*LAMI(K))<a name='2918'>
<a name='2919'>
      ELSE<a name='2920'>
         EPSI = 0.<a name='2921'>
      END IF<a name='2922'>
<a name='2923'>
      IF (QNI3D(K).GE.QSMALL) THEN<a name='2924'>
        EPSS = 2.*PI*N0S(K)*RHO(K)*DV(K)*                            &amp;<a name='2925'>
                   (F1S/(LAMS(K)*LAMS(K))+                       &amp;<a name='2926'>
                    F2S*(ASN(K)*RHO(K)/MU(K))**0.5*                      &amp;<a name='2927'>
                    SC(K)**(1./3.)*CONS10/                   &amp;<a name='2928'>
               (LAMS(K)**CONS35))<a name='2929'>
      ELSE<a name='2930'>
      EPSS = 0.<a name='2931'>
      END IF<a name='2932'>
<a name='2933'>
      IF (QG3D(K).GE.QSMALL) THEN<a name='2934'>
        EPSG = 2.*PI*N0G(K)*RHO(K)*DV(K)*                                &amp;<a name='2935'>
                   (F1S/(LAMG(K)*LAMG(K))+                               &amp;<a name='2936'>
                    F2S*(AGN(K)*RHO(K)/MU(K))**0.5*                      &amp;<a name='2937'>
                    SC(K)**(1./3.)*CONS11/                   &amp;<a name='2938'>
               (LAMG(K)**CONS36))<a name='2939'>
<a name='2940'>
<a name='2941'>
      ELSE<a name='2942'>
      EPSG = 0.<a name='2943'>
      END IF<a name='2944'>
<a name='2945'>
      IF (QR3D(K).GE.QSMALL) THEN<a name='2946'>
        EPSR = 2.*PI*N0RR(K)*RHO(K)*DV(K)*                           &amp;<a name='2947'>
                   (F1R/(LAMR(K)*LAMR(K))+                       &amp;<a name='2948'>
                    F2R*(ARN(K)*RHO(K)/MU(K))**0.5*                      &amp;<a name='2949'>
                    SC(K)**(1./3.)*CONS9/                   &amp;<a name='2950'>
                (LAMR(K)**CONS34))<a name='2951'>
      ELSE<a name='2952'>
      EPSR = 0.<a name='2953'>
      END IF<a name='2954'>
<a name='2955'>
<font color=#447700>! ONLY INCLUDE REGION OF ICE SIZE DIST &lt; DCS<a name='2956'></font>
<font color=#447700>! DUM IS FRACTION OF D*N(D) &lt; DCS<a name='2957'></font>
<a name='2958'>
<font color=#447700>! LOGIC BELOW FOLLOWS THAT OF HARRINGTON ET AL. 1995 (JAS)<a name='2959'></font>
              IF (QI3D(K).GE.QSMALL) THEN              <a name='2960'>
              DUM=(1.-EXP(-LAMI(K)*DCS)*(1.+LAMI(K)*DCS))<a name='2961'>
              PRD(K) = EPSI*(QV3D(K)-QVI(K))/ABI(K)*DUM<a name='2962'>
              ELSE<a name='2963'>
              DUM=0.<a name='2964'>
              END IF<a name='2965'>
<font color=#447700>! ADD DEPOSITION IN TAIL OF ICE SIZE DIST TO SNOW IF SNOW IS PRESENT<a name='2966'></font>
              IF (QNI3D(K).GE.QSMALL) THEN<a name='2967'>
              PRDS(K) = EPSS*(QV3D(K)-QVI(K))/ABI(K)+ &amp;<a name='2968'>
                EPSI*(QV3D(K)-QVI(K))/ABI(K)*(1.-DUM)<a name='2969'>
<font color=#447700>! OTHERWISE ADD TO CLOUD ICE<a name='2970'></font>
              ELSE<a name='2971'>
              PRD(K) = PRD(K)+EPSI*(QV3D(K)-QVI(K))/ABI(K)*(1.-DUM)<a name='2972'>
              END IF<a name='2973'>
<font color=#447700>! VAPOR DPEOSITION ON GRAUPEL<a name='2974'></font>
              PRDG(K) = EPSG*(QV3D(K)-QVI(K))/ABI(K)<a name='2975'>
<a name='2976'>
<font color=#447700>! NO CONDENSATION ONTO RAIN, ONLY EVAP<a name='2977'></font>
<a name='2978'>
           IF (QV3D(K).LT.QVS(K)) THEN<a name='2979'>
              PRE(K) = EPSR*(QV3D(K)-QVS(K))/AB(K)<a name='2980'>
              PRE(K) = MIN(PRE(K),0.)<a name='2981'>
           ELSE<a name='2982'>
              PRE(K) = 0.<a name='2983'>
           END IF<a name='2984'>
<a name='2985'>
<font color=#447700>! MAKE SURE NOT PUSHED INTO ICE SUPERSAT/SUBSAT<a name='2986'></font>
<font color=#447700>! FORMULA FROM REISNER 2 SCHEME<a name='2987'></font>
<a name='2988'>
           DUM = (QV3D(K)-QVI(K))/DT<a name='2989'>
<a name='2990'>
           FUDGEF = 0.9999<a name='2991'>
           SUM_DEP = PRD(K)+PRDS(K)+MNUCCD(K)+PRDG(K)<a name='2992'>
<a name='2993'>
           IF( (DUM.GT.0. .AND. SUM_DEP.GT.DUM*FUDGEF) .OR.                      &amp;<a name='2994'>
               (DUM.LT.0. .AND. SUM_DEP.LT.DUM*FUDGEF) ) THEN<a name='2995'>
               MNUCCD(K) = FUDGEF*MNUCCD(K)*DUM/SUM_DEP<a name='2996'>
               PRD(K) = FUDGEF*PRD(K)*DUM/SUM_DEP<a name='2997'>
               PRDS(K) = FUDGEF*PRDS(K)*DUM/SUM_DEP<a name='2998'>
	       PRDG(K) = FUDGEF*PRDG(K)*DUM/SUM_DEP<a name='2999'>
           ENDIF<a name='3000'>
<a name='3001'>
<font color=#447700>! IF CLOUD ICE/SNOW/GRAUPEL VAP DEPOSITION IS NEG, THEN ASSIGN TO SUBLIMATION PROCESSES<a name='3002'></font>
<a name='3003'>
           IF (PRD(K).LT.0.) THEN<a name='3004'>
              EPRD(K)=PRD(K)<a name='3005'>
              PRD(K)=0.<a name='3006'>
           END IF<a name='3007'>
           IF (PRDS(K).LT.0.) THEN<a name='3008'>
              EPRDS(K)=PRDS(K)<a name='3009'>
              PRDS(K)=0.<a name='3010'>
           END IF<a name='3011'>
           IF (PRDG(K).LT.0.) THEN<a name='3012'>
              EPRDG(K)=PRDG(K)<a name='3013'>
              PRDG(K)=0.<a name='3014'>
           END IF<a name='3015'>
<a name='3016'>
<font color=#447700>!.......................................................................<a name='3017'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3018'></font>
<a name='3019'>
<font color=#447700>! CONSERVATION OF WATER<a name='3020'></font>
<font color=#447700>! THIS IS ADOPTED LOOSELY FROM MM5 RESINER CODE. HOWEVER, HERE WE<a name='3021'></font>
<font color=#447700>! ONLY ADJUST PROCESSES THAT ARE NEGATIVE, RATHER THAN ALL PROCESSES.<a name='3022'></font>
<a name='3023'>
<font color=#447700>! IF MIXING RATIOS LESS THAN QSMALL, THEN NO DEPLETION OF WATER<a name='3024'></font>
<font color=#447700>! THROUGH MICROPHYSICAL PROCESSES, SKIP CONSERVATION<a name='3025'></font>
<a name='3026'>
<font color=#447700>! NOTE: CONSERVATION CHECK NOT APPLIED TO NUMBER CONCENTRATION SPECIES. ADDITIONAL CATCH<a name='3027'></font>
<font color=#447700>! BELOW WILL PREVENT NEGATIVE NUMBER CONCENTRATION<a name='3028'></font>
<font color=#447700>! FOR EACH MICROPHYSICAL PROCESS WHICH PROVIDES A SOURCE FOR NUMBER, THERE IS A CHECK<a name='3029'></font>
<font color=#447700>! TO MAKE SURE THAT CAN'T EXCEED TOTAL NUMBER OF DEPLETED SPECIES WITH THE TIME<a name='3030'></font>
<font color=#447700>! STEP<a name='3031'></font>
<a name='3032'>
<font color=#447700>!****SENSITIVITY - NO ICE<a name='3033'></font>
<a name='3034'>
      IF (ILIQ.EQ.1) THEN<a name='3035'>
      MNUCCC(K)=0.<a name='3036'>
      NNUCCC(K)=0.<a name='3037'>
      MNUCCR(K)=0.<a name='3038'>
      NNUCCR(K)=0.<a name='3039'>
      MNUCCD(K)=0.<a name='3040'>
      NNUCCD(K)=0.<a name='3041'>
      END IF<a name='3042'>
<a name='3043'>
<font color=#447700>! ****SENSITIVITY - NO GRAUPEL<a name='3044'></font>
      IF (IGRAUP.EQ.1) THEN<a name='3045'>
            PRACG(K) = 0.<a name='3046'>
            PSACR(K) = 0.<a name='3047'>
	    PSACWG(K) = 0.<a name='3048'>
	    PRDG(K) = 0.<a name='3049'>
	    EPRDG(K) = 0.<a name='3050'>
            EVPMG(K) = 0.<a name='3051'>
            PGMLT(K) = 0.<a name='3052'>
	    NPRACG(K) = 0.<a name='3053'>
	    NPSACWG(K) = 0.<a name='3054'>
	    NSCNG(K) = 0.<a name='3055'>
 	    NGRACS(K) = 0.<a name='3056'>
	    NSUBG(K) = 0.<a name='3057'>
	    NGMLTG(K) = 0.<a name='3058'>
            NGMLTR(K) = 0.<a name='3059'>
<font color=#447700>! fix 053011<a name='3060'></font>
            PIACRS(K)=PIACRS(K)+PIACR(K)<a name='3061'>
            PIACR(K) = 0.<a name='3062'>
<font color=#447700>! fix 070713<a name='3063'></font>
	    PRACIS(K)=PRACIS(K)+PRACI(K)<a name='3064'>
	    PRACI(K) = 0.<a name='3065'>
	    PSACWS(K)=PSACWS(K)+PGSACW(K)<a name='3066'>
	    PGSACW(K) = 0.<a name='3067'>
	    PRACS(K)=PRACS(K)+PGRACS(K)<a name='3068'>
	    PGRACS(K) = 0.<a name='3069'>
       END IF<a name='3070'>
<a name='3071'>
<font color=#447700>! CONSERVATION OF QC<a name='3072'></font>
<a name='3073'>
      DUM = (PRC(K)+PRA(K)+MNUCCC(K)+PSACWS(K)+PSACWI(K)+QMULTS(K)+PSACWG(K)+PGSACW(K)+QMULTG(K))*DT<a name='3074'>
<a name='3075'>
      IF (DUM.GT.QC3D(K).AND.QC3D(K).GE.QSMALL) THEN<a name='3076'>
        RATIO = QC3D(K)/DUM<a name='3077'>
<a name='3078'>
        PRC(K) = PRC(K)*RATIO<a name='3079'>
        PRA(K) = PRA(K)*RATIO<a name='3080'>
        MNUCCC(K) = MNUCCC(K)*RATIO<a name='3081'>
        PSACWS(K) = PSACWS(K)*RATIO<a name='3082'>
        PSACWI(K) = PSACWI(K)*RATIO<a name='3083'>
        QMULTS(K) = QMULTS(K)*RATIO<a name='3084'>
        QMULTG(K) = QMULTG(K)*RATIO<a name='3085'>
        PSACWG(K) = PSACWG(K)*RATIO<a name='3086'>
	PGSACW(K) = PGSACW(K)*RATIO<a name='3087'>
        END IF<a name='3088'>
 <a name='3089'>
<font color=#447700>! CONSERVATION OF QI<a name='3090'></font>
<a name='3091'>
      DUM = (-PRD(K)-MNUCCC(K)+PRCI(K)+PRAI(K)-QMULTS(K)-QMULTG(K)-QMULTR(K)-QMULTRG(K) &amp;<a name='3092'>
                -MNUCCD(K)+PRACI(K)+PRACIS(K)-EPRD(K)-PSACWI(K))*DT<a name='3093'>
<a name='3094'>
      IF (DUM.GT.QI3D(K).AND.QI3D(K).GE.QSMALL) THEN<a name='3095'>
<a name='3096'>
        RATIO = (QI3D(K)/DT+PRD(K)+MNUCCC(K)+QMULTS(K)+QMULTG(K)+QMULTR(K)+QMULTRG(K)+ &amp;<a name='3097'>
                     MNUCCD(K)+PSACWI(K))/ &amp;<a name='3098'>
                      (PRCI(K)+PRAI(K)+PRACI(K)+PRACIS(K)-EPRD(K))<a name='3099'>
<a name='3100'>
        PRCI(K) = PRCI(K)*RATIO<a name='3101'>
        PRAI(K) = PRAI(K)*RATIO<a name='3102'>
        PRACI(K) = PRACI(K)*RATIO<a name='3103'>
        PRACIS(K) = PRACIS(K)*RATIO<a name='3104'>
        EPRD(K) = EPRD(K)*RATIO<a name='3105'>
<a name='3106'>
        END IF<a name='3107'>
<a name='3108'>
<font color=#447700>! CONSERVATION OF QR<a name='3109'></font>
<a name='3110'>
      DUM=((PRACS(K)-PRE(K))+(QMULTR(K)+QMULTRG(K)-PRC(K))+(MNUCCR(K)-PRA(K))+ &amp;<a name='3111'>
             PIACR(K)+PIACRS(K)+PGRACS(K)+PRACG(K))*DT<a name='3112'>
<a name='3113'>
      IF (DUM.GT.QR3D(K).AND.QR3D(K).GE.QSMALL) THEN<a name='3114'>
<a name='3115'>
        RATIO = (QR3D(K)/DT+PRC(K)+PRA(K))/ &amp;<a name='3116'>
             (-PRE(K)+QMULTR(K)+QMULTRG(K)+PRACS(K)+MNUCCR(K)+PIACR(K)+PIACRS(K)+PGRACS(K)+PRACG(K))<a name='3117'>
<a name='3118'>
        PRE(K) = PRE(K)*RATIO<a name='3119'>
        PRACS(K) = PRACS(K)*RATIO<a name='3120'>
        QMULTR(K) = QMULTR(K)*RATIO<a name='3121'>
        QMULTRG(K) = QMULTRG(K)*RATIO<a name='3122'>
        MNUCCR(K) = MNUCCR(K)*RATIO<a name='3123'>
        PIACR(K) = PIACR(K)*RATIO<a name='3124'>
        PIACRS(K) = PIACRS(K)*RATIO<a name='3125'>
        PGRACS(K) = PGRACS(K)*RATIO<a name='3126'>
        PRACG(K) = PRACG(K)*RATIO<a name='3127'>
<a name='3128'>
        END IF<a name='3129'>
<a name='3130'>
<font color=#447700>! CONSERVATION OF QNI<a name='3131'></font>
<font color=#447700>! CONSERVATION FOR GRAUPEL SCHEME<a name='3132'></font>
<a name='3133'>
        IF (IGRAUP.EQ.0) THEN<a name='3134'>
<a name='3135'>
      DUM = (-PRDS(K)-PSACWS(K)-PRAI(K)-PRCI(K)-PRACS(K)-EPRDS(K)+PSACR(K)-PIACRS(K)-PRACIS(K))*DT<a name='3136'>
<a name='3137'>
      IF (DUM.GT.QNI3D(K).AND.QNI3D(K).GE.QSMALL) THEN<a name='3138'>
<a name='3139'>
        RATIO = (QNI3D(K)/DT+PRDS(K)+PSACWS(K)+PRAI(K)+PRCI(K)+PRACS(K)+PIACRS(K)+PRACIS(K))/(-EPRDS(K)+PSACR(K))<a name='3140'>
<a name='3141'>
       EPRDS(K) = EPRDS(K)*RATIO<a name='3142'>
       PSACR(K) = PSACR(K)*RATIO<a name='3143'>
<a name='3144'>
       END IF<a name='3145'>
<a name='3146'>
<font color=#447700>! FOR NO GRAUPEL, NEED TO INCLUDE FREEZING OF RAIN FOR SNOW<a name='3147'></font>
       ELSE IF (IGRAUP.EQ.1) THEN<a name='3148'>
<a name='3149'>
      DUM = (-PRDS(K)-PSACWS(K)-PRAI(K)-PRCI(K)-PRACS(K)-EPRDS(K)+PSACR(K)-PIACRS(K)-PRACIS(K)-MNUCCR(K))*DT<a name='3150'>
<a name='3151'>
      IF (DUM.GT.QNI3D(K).AND.QNI3D(K).GE.QSMALL) THEN<a name='3152'>
<a name='3153'>
       RATIO = (QNI3D(K)/DT+PRDS(K)+PSACWS(K)+PRAI(K)+PRCI(K)+PRACS(K)+PIACRS(K)+PRACIS(K)+MNUCCR(K))/(-EPRDS(K)+PSACR(K))<a name='3154'>
<a name='3155'>
       EPRDS(K) = EPRDS(K)*RATIO<a name='3156'>
       PSACR(K) = PSACR(K)*RATIO<a name='3157'>
<a name='3158'>
       END IF<a name='3159'>
<a name='3160'>
       END IF<a name='3161'>
<a name='3162'>
<font color=#447700>! CONSERVATION OF QG<a name='3163'></font>
<a name='3164'>
      DUM = (-PSACWG(K)-PRACG(K)-PGSACW(K)-PGRACS(K)-PRDG(K)-MNUCCR(K)-EPRDG(K)-PIACR(K)-PRACI(K)-PSACR(K))*DT<a name='3165'>
<a name='3166'>
      IF (DUM.GT.QG3D(K).AND.QG3D(K).GE.QSMALL) THEN<a name='3167'>
<a name='3168'>
        RATIO = (QG3D(K)/DT+PSACWG(K)+PRACG(K)+PGSACW(K)+PGRACS(K)+PRDG(K)+MNUCCR(K)+PSACR(K)+&amp;<a name='3169'>
                  PIACR(K)+PRACI(K))/(-EPRDG(K))<a name='3170'>
<a name='3171'>
       EPRDG(K) = EPRDG(K)*RATIO<a name='3172'>
<a name='3173'>
      END IF<a name='3174'>
<a name='3175'>
<font color=#447700>! TENDENCIES<a name='3176'></font>
<a name='3177'>
      QV3DTEN(K) = QV3DTEN(K)+(-PRE(K)-PRD(K)-PRDS(K)-MNUCCD(K)-EPRD(K)-EPRDS(K)-PRDG(K)-EPRDG(K))<a name='3178'>
<a name='3179'>
<font color=#447700>! BUG FIX HM, 3/1/11, INCLUDE PIACR AND PIACRS<a name='3180'></font>
      T3DTEN(K) = T3DTEN(K)+(PRE(K)                                 &amp;<a name='3181'>
               *XXLV(K)+(PRD(K)+PRDS(K)+                            &amp;<a name='3182'>
                MNUCCD(K)+EPRD(K)+EPRDS(K)+PRDG(K)+EPRDG(K))*XXLS(K)+         &amp;<a name='3183'>
               (PSACWS(K)+PSACWI(K)+MNUCCC(K)+MNUCCR(K)+                      &amp;<a name='3184'>
                QMULTS(K)+QMULTG(K)+QMULTR(K)+QMULTRG(K)+PRACS(K) &amp;<a name='3185'>
                +PSACWG(K)+PRACG(K)+PGSACW(K)+PGRACS(K)+PIACR(K)+PIACRS(K))*XLF(K))/CPM(K)<a name='3186'>
<a name='3187'>
      QC3DTEN(K) = QC3DTEN(K)+                                      &amp;<a name='3188'>
                 (-PRA(K)-PRC(K)-MNUCCC(K)+PCC(K)-                  &amp;<a name='3189'>
                  PSACWS(K)-PSACWI(K)-QMULTS(K)-QMULTG(K)-PSACWG(K)-PGSACW(K))<a name='3190'>
      QI3DTEN(K) = QI3DTEN(K)+                                      &amp;<a name='3191'>
         (PRD(K)+EPRD(K)+PSACWI(K)+MNUCCC(K)-PRCI(K)-                                 &amp;<a name='3192'>
                  PRAI(K)+QMULTS(K)+QMULTG(K)+QMULTR(K)+QMULTRG(K)+MNUCCD(K)-PRACI(K)-PRACIS(K))<a name='3193'>
      QR3DTEN(K) = QR3DTEN(K)+                                      &amp;<a name='3194'>
                 (PRE(K)+PRA(K)+PRC(K)-PRACS(K)-MNUCCR(K)-QMULTR(K)-QMULTRG(K) &amp;<a name='3195'>
             -PIACR(K)-PIACRS(K)-PRACG(K)-PGRACS(K))<a name='3196'>
<a name='3197'>
      IF (IGRAUP.EQ.0) THEN<a name='3198'>
<a name='3199'>
      QNI3DTEN(K) = QNI3DTEN(K)+                                    &amp;<a name='3200'>
           (PRAI(K)+PSACWS(K)+PRDS(K)+PRACS(K)+PRCI(K)+EPRDS(K)-PSACR(K)+PIACRS(K)+PRACIS(K))<a name='3201'>
      NS3DTEN(K) = NS3DTEN(K)+(NSAGG(K)+NPRCI(K)-NSCNG(K)-NGRACS(K)+NIACRS(K))<a name='3202'>
      QG3DTEN(K) = QG3DTEN(K)+(PRACG(K)+PSACWG(K)+PGSACW(K)+PGRACS(K)+ &amp;<a name='3203'>
                    PRDG(K)+EPRDG(K)+MNUCCR(K)+PIACR(K)+PRACI(K)+PSACR(K))<a name='3204'>
      NG3DTEN(K) = NG3DTEN(K)+(NSCNG(K)+NGRACS(K)+NNUCCR(K)+NIACR(K))<a name='3205'>
<a name='3206'>
<font color=#447700>! FOR NO GRAUPEL, NEED TO INCLUDE FREEZING OF RAIN FOR SNOW<a name='3207'></font>
      ELSE IF (IGRAUP.EQ.1) THEN<a name='3208'>
<a name='3209'>
      QNI3DTEN(K) = QNI3DTEN(K)+                                    &amp;<a name='3210'>
           (PRAI(K)+PSACWS(K)+PRDS(K)+PRACS(K)+PRCI(K)+EPRDS(K)-PSACR(K)+PIACRS(K)+PRACIS(K)+MNUCCR(K))<a name='3211'>
      NS3DTEN(K) = NS3DTEN(K)+(NSAGG(K)+NPRCI(K)-NSCNG(K)-NGRACS(K)+NIACRS(K)+NNUCCR(K))<a name='3212'>
<a name='3213'>
      END IF<a name='3214'>
<a name='3215'>
      NC3DTEN(K) = NC3DTEN(K)+(-NNUCCC(K)-NPSACWS(K)                &amp;<a name='3216'>
            -NPRA(K)-NPRC(K)-NPSACWI(K)-NPSACWG(K))<a name='3217'>
<a name='3218'>
      NI3DTEN(K) = NI3DTEN(K)+                                      &amp;<a name='3219'>
       (NNUCCC(K)-NPRCI(K)-NPRAI(K)+NMULTS(K)+NMULTG(K)+NMULTR(K)+NMULTRG(K)+ &amp;<a name='3220'>
               NNUCCD(K)-NIACR(K)-NIACRS(K))<a name='3221'>
<a name='3222'>
      NR3DTEN(K) = NR3DTEN(K)+(NPRC1(K)-NPRACS(K)-NNUCCR(K)      &amp;<a name='3223'>
                   +NRAGG(K)-NIACR(K)-NIACRS(K)-NPRACG(K)-NGRACS(K))<a name='3224'>
<a name='3225'>
<font color=#447700>! HM ADD, WRF-CHEM, ADD TENDENCIES FOR C2PREC<a name='3226'></font>
<a name='3227'>
	C2PREC(K) = PRA(K)+PRC(K)+PSACWS(K)+QMULTS(K)+QMULTG(K)+PSACWG(K)+ &amp;<a name='3228'>
       PGSACW(K)+MNUCCC(K)+PSACWI(K)<a name='3229'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3230'></font>
<font color=#447700>! NOW CALCULATE SATURATION ADJUSTMENT TO CONDENSE EXTRA VAPOR ABOVE<a name='3231'></font>
<font color=#447700>! WATER SATURATION<a name='3232'></font>
<a name='3233'>
      DUMT = T3D(K)+DT*T3DTEN(K)<a name='3234'>
      DUMQV = QV3D(K)+DT*QV3DTEN(K)<a name='3235'>
<font color=#447700>! hm, add fix for low pressure, 5/12/10<a name='3236'></font>
      dum=min(0.99*pres(k),POLYSVP(DUMT,0))<a name='3237'>
      DUMQSS = EP_2*dum/(PRES(K)-dum)<a name='3238'>
      DUMQC = QC3D(K)+DT*QC3DTEN(K)<a name='3239'>
      DUMQC = MAX(DUMQC,0.)<a name='3240'>
<a name='3241'>
<font color=#447700>! SATURATION ADJUSTMENT FOR LIQUID<a name='3242'></font>
<a name='3243'>
      DUMS = DUMQV-DUMQSS<a name='3244'>
      PCC(K) = DUMS/(1.+XXLV(K)**2*DUMQSS/(CPM(K)*RV*DUMT**2))/DT<a name='3245'>
      IF (PCC(K)*DT+DUMQC.LT.0.) THEN<a name='3246'>
           PCC(K) = -DUMQC/DT<a name='3247'>
      END IF<a name='3248'>
<a name='3249'>
      QV3DTEN(K) = QV3DTEN(K)-PCC(K)<a name='3250'>
      T3DTEN(K) = T3DTEN(K)+PCC(K)*XXLV(K)/CPM(K)<a name='3251'>
      QC3DTEN(K) = QC3DTEN(K)+PCC(K)<a name='3252'>
<a name='3253'>
<font color=#447700>!.......................................................................<a name='3254'></font>
<font color=#447700>! ACTIVATION OF CLOUD DROPLETS<a name='3255'></font>
<font color=#447700>! ACTIVATION OF DROPLET CURRENTLY NOT CALCULATED<a name='3256'></font>
<font color=#447700>! DROPLET CONCENTRATION IS SPECIFIED !!!!!<a name='3257'></font>
<a name='3258'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3259'></font>
<font color=#447700>! SUBLIMATE, MELT, OR EVAPORATE NUMBER CONCENTRATION<a name='3260'></font>
<font color=#447700>! THIS FORMULATION ASSUMES 1:1 RATIO BETWEEN MASS LOSS AND<a name='3261'></font>
<font color=#447700>! LOSS OF NUMBER CONCENTRATION<a name='3262'></font>
<a name='3263'>
<font color=#447700>!     IF (PCC(K).LT.0.) THEN<a name='3264'></font>
<font color=#447700>!        DUM = PCC(K)*DT/QC3D(K)<a name='3265'></font>
<font color=#447700>!           DUM = MAX(-1.,DUM)<a name='3266'></font>
<font color=#447700>!        NSUBC(K) = DUM*NC3D(K)/DT<a name='3267'></font>
<font color=#447700>!     END IF<a name='3268'></font>
<a name='3269'>
      IF (EPRD(K).LT.0.) THEN<a name='3270'>
         DUM = EPRD(K)*DT/QI3D(K)<a name='3271'>
            DUM = MAX(-1.,DUM)<a name='3272'>
         NSUBI(K) = DUM*NI3D(K)/DT<a name='3273'>
      END IF<a name='3274'>
      IF (EPRDS(K).LT.0.) THEN<a name='3275'>
         DUM = EPRDS(K)*DT/QNI3D(K)<a name='3276'>
           DUM = MAX(-1.,DUM)<a name='3277'>
         NSUBS(K) = DUM*NS3D(K)/DT<a name='3278'>
      END IF<a name='3279'>
      IF (PRE(K).LT.0.) THEN<a name='3280'>
         DUM = PRE(K)*DT/QR3D(K)<a name='3281'>
           DUM = MAX(-1.,DUM)<a name='3282'>
         NSUBR(K) = DUM*NR3D(K)/DT<a name='3283'>
      END IF<a name='3284'>
      IF (EPRDG(K).LT.0.) THEN<a name='3285'>
         DUM = EPRDG(K)*DT/QG3D(K)<a name='3286'>
           DUM = MAX(-1.,DUM)<a name='3287'>
         NSUBG(K) = DUM*NG3D(K)/DT<a name='3288'>
      END IF<a name='3289'>
<a name='3290'>
<font color=#447700>!        nsubr(k)=0.<a name='3291'></font>
<font color=#447700>!        nsubs(k)=0.<a name='3292'></font>
<font color=#447700>!        nsubg(k)=0.<a name='3293'></font>
<a name='3294'>
<font color=#447700>! UPDATE TENDENCIES<a name='3295'></font>
<a name='3296'>
<font color=#447700>!        NC3DTEN(K) = NC3DTEN(K)+NSUBC(K)<a name='3297'></font>
         NI3DTEN(K) = NI3DTEN(K)+NSUBI(K)<a name='3298'>
         NS3DTEN(K) = NS3DTEN(K)+NSUBS(K)<a name='3299'>
         NG3DTEN(K) = NG3DTEN(K)+NSUBG(K)<a name='3300'>
         NR3DTEN(K) = NR3DTEN(K)+NSUBR(K)<a name='3301'>
<a name='3302'>
#if (WRF_CHEM == 1)<a name='3303'>
         evapprod(k) = - PRE(K) - EPRDS(K) - EPRDG(K) <a name='3304'>
         rainprod(k) = PRA(K) + PRC(K) + PSACWS(K) + PSACWG(K) + PGSACW(K) &amp; <a name='3305'>
                       + PRAI(K) + PRCI(K) + PRACI(K) + PRACIS(K)  &amp;<a name='3306'>
                       + PRDS(K) + PRDG(K)<a name='3307'>
#endif<a name='3308'>
<a name='3309'>
         END IF <font color=#447700>!!!!!! TEMPERATURE<a name='3310'></font>
<a name='3311'>
<font color=#447700>! SWITCH LTRUE TO 1, SINCE HYDROMETEORS ARE PRESENT<a name='3312'></font>
         LTRUE = 1<a name='3313'>
<a name='3314'>
 200     CONTINUE<a name='3315'>
<a name='3316'>
        END DO<a name='3317'>
<a name='3318'>
<font color=#447700>! INITIALIZE PRECIP AND SNOW RATES<a name='3319'></font>
      PRECRT = 0.<a name='3320'>
      SNOWRT = 0.<a name='3321'>
<font color=#447700>! hm added 7/13/13<a name='3322'></font>
      SNOWPRT = 0.<a name='3323'>
      GRPLPRT = 0.<a name='3324'>
<a name='3325'>
<font color=#447700>! IF THERE ARE NO HYDROMETEORS, THEN SKIP TO END OF SUBROUTINE<a name='3326'></font>
<a name='3327'>
        IF (LTRUE.EQ.0) GOTO 400<a name='3328'>
<a name='3329'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3330'></font>
<font color=#447700>!.......................................................................<a name='3331'></font>
<font color=#447700>! CALCULATE SEDIMENATION<a name='3332'></font>
<font color=#447700>! THE NUMERICS HERE FOLLOW FROM REISNER ET AL. (1998)<a name='3333'></font>
<font color=#447700>! FALLOUT TERMS ARE CALCULATED ON SPLIT TIME STEPS TO ENSURE NUMERICAL<a name='3334'></font>
<font color=#447700>! STABILITY, I.E. COURANT# &lt; 1<a name='3335'></font>
<a name='3336'>
<font color=#447700>!.......................................................................<a name='3337'></font>
<a name='3338'>
      NSTEP = 1<a name='3339'>
<a name='3340'>
      DO K = KTE,KTS,-1<a name='3341'>
<a name='3342'>
        DUMI(K) = QI3D(K)+QI3DTEN(K)*DT<a name='3343'>
        DUMQS(K) = QNI3D(K)+QNI3DTEN(K)*DT<a name='3344'>
        DUMR(K) = QR3D(K)+QR3DTEN(K)*DT<a name='3345'>
        DUMFNI(K) = NI3D(K)+NI3DTEN(K)*DT<a name='3346'>
        DUMFNS(K) = NS3D(K)+NS3DTEN(K)*DT<a name='3347'>
        DUMFNR(K) = NR3D(K)+NR3DTEN(K)*DT<a name='3348'>
        DUMC(K) = QC3D(K)+QC3DTEN(K)*DT<a name='3349'>
        DUMFNC(K) = NC3D(K)+NC3DTEN(K)*DT<a name='3350'>
	DUMG(K) = QG3D(K)+QG3DTEN(K)*DT<a name='3351'>
	DUMFNG(K) = NG3D(K)+NG3DTEN(K)*DT<a name='3352'>
<a name='3353'>
<font color=#447700>! SWITCH FOR CONSTANT DROPLET NUMBER<a name='3354'></font>
        IF (iinum.EQ.1) THEN<a name='3355'>
        DUMFNC(K) = NC3D(K)<a name='3356'>
        END IF<a name='3357'>
<a name='3358'>
<font color=#447700>! GET DUMMY LAMDA FOR SEDIMENTATION CALCULATIONS<a name='3359'></font>
<a name='3360'>
<font color=#447700>! MAKE SURE NUMBER CONCENTRATIONS ARE POSITIVE<a name='3361'></font>
      DUMFNI(K) = MAX(0.,DUMFNI(K))<a name='3362'>
      DUMFNS(K) = MAX(0.,DUMFNS(K))<a name='3363'>
      DUMFNC(K) = MAX(0.,DUMFNC(K))<a name='3364'>
      DUMFNR(K) = MAX(0.,DUMFNR(K))<a name='3365'>
      DUMFNG(K) = MAX(0.,DUMFNG(K))<a name='3366'>
<a name='3367'>
<font color=#447700>!......................................................................<a name='3368'></font>
<font color=#447700>! CLOUD ICE<a name='3369'></font>
<a name='3370'>
      IF (DUMI(K).GE.QSMALL) THEN<a name='3371'>
        DLAMI = (CONS12*DUMFNI(K)/DUMI(K))**(1./DI)<a name='3372'>
        DLAMI=MAX(DLAMI,LAMMINI)<a name='3373'>
        DLAMI=MIN(DLAMI,LAMMAXI)<a name='3374'>
      END IF<a name='3375'>
<font color=#447700>!......................................................................<a name='3376'></font>
<font color=#447700>! RAIN<a name='3377'></font>
<a name='3378'>
      IF (DUMR(K).GE.QSMALL) THEN<a name='3379'>
        DLAMR = (PI*RHOW*DUMFNR(K)/DUMR(K))**(1./3.)<a name='3380'>
        DLAMR=MAX(DLAMR,LAMMINR)<a name='3381'>
        DLAMR=MIN(DLAMR,LAMMAXR)<a name='3382'>
      END IF<a name='3383'>
<font color=#447700>!......................................................................<a name='3384'></font>
<font color=#447700>! CLOUD DROPLETS<a name='3385'></font>
<a name='3386'>
      IF (DUMC(K).GE.QSMALL) THEN<a name='3387'>
         DUM = PRES(K)/(287.15*T3D(K))<a name='3388'>
         PGAM(K)=0.0005714*(NC3D(K)/1.E6*DUM)+0.2714<a name='3389'>
         PGAM(K)=1./(PGAM(K)**2)-1.<a name='3390'>
         PGAM(K)=MAX(PGAM(K),2.)<a name='3391'>
         PGAM(K)=MIN(PGAM(K),10.)<a name='3392'>
<a name='3393'>
        DLAMC = (CONS26*DUMFNC(K)*GAMMA(PGAM(K)+4.)/(DUMC(K)*GAMMA(PGAM(K)+1.)))**(1./3.)<a name='3394'>
        LAMMIN = (PGAM(K)+1.)/60.E-6<a name='3395'>
        LAMMAX = (PGAM(K)+1.)/1.E-6<a name='3396'>
        DLAMC=MAX(DLAMC,LAMMIN)<a name='3397'>
        DLAMC=MIN(DLAMC,LAMMAX)<a name='3398'>
      END IF<a name='3399'>
<font color=#447700>!......................................................................<a name='3400'></font>
<font color=#447700>! SNOW<a name='3401'></font>
<a name='3402'>
      IF (DUMQS(K).GE.QSMALL) THEN<a name='3403'>
        DLAMS = (CONS1*DUMFNS(K)/ DUMQS(K))**(1./DS)<a name='3404'>
        DLAMS=MAX(DLAMS,LAMMINS)<a name='3405'>
        DLAMS=MIN(DLAMS,LAMMAXS)<a name='3406'>
      END IF<a name='3407'>
<font color=#447700>!......................................................................<a name='3408'></font>
<font color=#447700>! GRAUPEL<a name='3409'></font>
<a name='3410'>
      IF (DUMG(K).GE.QSMALL) THEN<a name='3411'>
        DLAMG = (CONS2*DUMFNG(K)/ DUMG(K))**(1./DG)<a name='3412'>
        DLAMG=MAX(DLAMG,LAMMING)<a name='3413'>
        DLAMG=MIN(DLAMG,LAMMAXG)<a name='3414'>
      END IF<a name='3415'>
<a name='3416'>
<font color=#447700>!......................................................................<a name='3417'></font>
<font color=#447700>! CALCULATE NUMBER-WEIGHTED AND MASS-WEIGHTED TERMINAL FALL SPEEDS<a name='3418'></font>
<a name='3419'>
<font color=#447700>! CLOUD WATER<a name='3420'></font>
<a name='3421'>
      IF (DUMC(K).GE.QSMALL) THEN<a name='3422'>
      UNC =  ACN(K)*GAMMA(1.+BC+PGAM(K))/ (DLAMC**BC*GAMMA(PGAM(K)+1.))<a name='3423'>
      UMC = ACN(K)*GAMMA(4.+BC+PGAM(K))/  (DLAMC**BC*GAMMA(PGAM(K)+4.))<a name='3424'>
      ELSE<a name='3425'>
      UMC = 0.<a name='3426'>
      UNC = 0.<a name='3427'>
      END IF<a name='3428'>
<a name='3429'>
      IF (DUMI(K).GE.QSMALL) THEN<a name='3430'>
      UNI =  AIN(K)*CONS27/DLAMI**BI<a name='3431'>
      UMI = AIN(K)*CONS28/(DLAMI**BI)<a name='3432'>
      ELSE<a name='3433'>
      UMI = 0.<a name='3434'>
      UNI = 0.<a name='3435'>
      END IF<a name='3436'>
<a name='3437'>
      IF (DUMR(K).GE.QSMALL) THEN<a name='3438'>
      UNR = ARN(K)*CONS6/DLAMR**BR<a name='3439'>
      UMR = ARN(K)*CONS4/(DLAMR**BR)<a name='3440'>
      ELSE<a name='3441'>
      UMR = 0.<a name='3442'>
      UNR = 0.<a name='3443'>
      END IF<a name='3444'>
<a name='3445'>
      IF (DUMQS(K).GE.QSMALL) THEN<a name='3446'>
      UMS = ASN(K)*CONS3/(DLAMS**BS)<a name='3447'>
      UNS = ASN(K)*CONS5/DLAMS**BS<a name='3448'>
      ELSE<a name='3449'>
      UMS = 0.<a name='3450'>
      UNS = 0.<a name='3451'>
      END IF<a name='3452'>
<a name='3453'>
      IF (DUMG(K).GE.QSMALL) THEN<a name='3454'>
      UMG = AGN(K)*CONS7/(DLAMG**BG)<a name='3455'>
      UNG = AGN(K)*CONS8/DLAMG**BG<a name='3456'>
      ELSE<a name='3457'>
      UMG = 0.<a name='3458'>
      UNG = 0.<a name='3459'>
      END IF<a name='3460'>
<a name='3461'>
<font color=#447700>! SET REALISTIC LIMITS ON FALLSPEED<a name='3462'></font>
<a name='3463'>
<font color=#447700>! bug fix, 10/08/09<a name='3464'></font>
        dum=(rhosu/rho(k))**0.54<a name='3465'>
        UMS=MIN(UMS,1.2*dum)<a name='3466'>
        UNS=MIN(UNS,1.2*dum)<a name='3467'>
<font color=#447700>! fix 053011<a name='3468'></font>
<font color=#447700>! fix for correction by AA 4/6/11<a name='3469'></font>
        UMI=MIN(UMI,1.2*(rhosu/rho(k))**0.35)<a name='3470'>
        UNI=MIN(UNI,1.2*(rhosu/rho(k))**0.35)<a name='3471'>
        UMR=MIN(UMR,9.1*dum)<a name='3472'>
        UNR=MIN(UNR,9.1*dum)<a name='3473'>
        UMG=MIN(UMG,20.*dum)<a name='3474'>
        UNG=MIN(UNG,20.*dum)<a name='3475'>
<a name='3476'>
      FR(K) = UMR<a name='3477'>
      FI(K) = UMI<a name='3478'>
      FNI(K) = UNI<a name='3479'>
      FS(K) = UMS<a name='3480'>
      FNS(K) = UNS<a name='3481'>
      FNR(K) = UNR<a name='3482'>
      FC(K) = UMC<a name='3483'>
      FNC(K) = UNC<a name='3484'>
      FG(K) = UMG<a name='3485'>
      FNG(K) = UNG<a name='3486'>
<a name='3487'>
<font color=#447700>! V3.3 MODIFY FALLSPEED BELOW LEVEL OF PRECIP<a name='3488'></font>
<a name='3489'>
	IF (K.LE.KTE-1) THEN<a name='3490'>
        IF (FR(K).LT.1.E-10) THEN<a name='3491'>
	FR(K)=FR(K+1)<a name='3492'>
	END IF<a name='3493'>
        IF (FI(K).LT.1.E-10) THEN<a name='3494'>
	FI(K)=FI(K+1)<a name='3495'>
	END IF<a name='3496'>
        IF (FNI(K).LT.1.E-10) THEN<a name='3497'>
	FNI(K)=FNI(K+1)<a name='3498'>
	END IF<a name='3499'>
        IF (FS(K).LT.1.E-10) THEN<a name='3500'>
	FS(K)=FS(K+1)<a name='3501'>
	END IF<a name='3502'>
        IF (FNS(K).LT.1.E-10) THEN<a name='3503'>
	FNS(K)=FNS(K+1)<a name='3504'>
	END IF<a name='3505'>
        IF (FNR(K).LT.1.E-10) THEN<a name='3506'>
	FNR(K)=FNR(K+1)<a name='3507'>
	END IF<a name='3508'>
        IF (FC(K).LT.1.E-10) THEN<a name='3509'>
	FC(K)=FC(K+1)<a name='3510'>
	END IF<a name='3511'>
        IF (FNC(K).LT.1.E-10) THEN<a name='3512'>
	FNC(K)=FNC(K+1)<a name='3513'>
	END IF<a name='3514'>
        IF (FG(K).LT.1.E-10) THEN<a name='3515'>
	FG(K)=FG(K+1)<a name='3516'>
	END IF<a name='3517'>
        IF (FNG(K).LT.1.E-10) THEN<a name='3518'>
	FNG(K)=FNG(K+1)<a name='3519'>
	END IF<a name='3520'>
	END IF <font color=#447700>! K LE KTE-1<a name='3521'></font>
<a name='3522'>
<font color=#447700>! CALCULATE NUMBER OF SPLIT TIME STEPS<a name='3523'></font>
<a name='3524'>
      RGVM = MAX(FR(K),FI(K),FS(K),FC(K),FNI(K),FNR(K),FNS(K),FNC(K),FG(K),FNG(K))<a name='3525'>
<font color=#447700>! VVT CHANGED IFIX -&gt; INT (GENERIC FUNCTION)<a name='3526'></font>
      NSTEP = MAX(INT(RGVM*DT/DZQ(K)+1.),NSTEP)<a name='3527'>
<a name='3528'>
<font color=#447700>! MULTIPLY VARIABLES BY RHO<a name='3529'></font>
      DUMR(k) = DUMR(k)*RHO(K)<a name='3530'>
      DUMI(k) = DUMI(k)*RHO(K)<a name='3531'>
      DUMFNI(k) = DUMFNI(K)*RHO(K)<a name='3532'>
      DUMQS(k) = DUMQS(K)*RHO(K)<a name='3533'>
      DUMFNS(k) = DUMFNS(K)*RHO(K)<a name='3534'>
      DUMFNR(k) = DUMFNR(K)*RHO(K)<a name='3535'>
      DUMC(k) = DUMC(K)*RHO(K)<a name='3536'>
      DUMFNC(k) = DUMFNC(K)*RHO(K)<a name='3537'>
      DUMG(k) = DUMG(K)*RHO(K)<a name='3538'>
      DUMFNG(k) = DUMFNG(K)*RHO(K)<a name='3539'>
<a name='3540'>
      END DO<a name='3541'>
<a name='3542'>
      DO N = 1,NSTEP<a name='3543'>
<a name='3544'>
      DO K = KTS,KTE<a name='3545'>
      FALOUTR(K) = FR(K)*DUMR(K)<a name='3546'>
      FALOUTI(K) = FI(K)*DUMI(K)<a name='3547'>
      FALOUTNI(K) = FNI(K)*DUMFNI(K)<a name='3548'>
      FALOUTS(K) = FS(K)*DUMQS(K)<a name='3549'>
      FALOUTNS(K) = FNS(K)*DUMFNS(K)<a name='3550'>
      FALOUTNR(K) = FNR(K)*DUMFNR(K)<a name='3551'>
      FALOUTC(K) = FC(K)*DUMC(K)<a name='3552'>
      FALOUTNC(K) = FNC(K)*DUMFNC(K)<a name='3553'>
      FALOUTG(K) = FG(K)*DUMG(K)<a name='3554'>
      FALOUTNG(K) = FNG(K)*DUMFNG(K)<a name='3555'>
      END DO<a name='3556'>
<a name='3557'>
<font color=#447700>! TOP OF MODEL<a name='3558'></font>
<a name='3559'>
      K = KTE<a name='3560'>
      FALTNDR = FALOUTR(K)/DZQ(k)<a name='3561'>
      FALTNDI = FALOUTI(K)/DZQ(k)<a name='3562'>
      FALTNDNI = FALOUTNI(K)/DZQ(k)<a name='3563'>
      FALTNDS = FALOUTS(K)/DZQ(k)<a name='3564'>
      FALTNDNS = FALOUTNS(K)/DZQ(k)<a name='3565'>
      FALTNDNR = FALOUTNR(K)/DZQ(k)<a name='3566'>
      FALTNDC = FALOUTC(K)/DZQ(k)<a name='3567'>
      FALTNDNC = FALOUTNC(K)/DZQ(k)<a name='3568'>
      FALTNDG = FALOUTG(K)/DZQ(k)<a name='3569'>
      FALTNDNG = FALOUTNG(K)/DZQ(k)<a name='3570'>
<font color=#447700>! ADD FALLOUT TERMS TO EULERIAN TENDENCIES<a name='3571'></font>
<a name='3572'>
      QRSTEN(K) = QRSTEN(K)-FALTNDR/NSTEP/RHO(k)<a name='3573'>
      QISTEN(K) = QISTEN(K)-FALTNDI/NSTEP/RHO(k)<a name='3574'>
      NI3DTEN(K) = NI3DTEN(K)-FALTNDNI/NSTEP/RHO(k)<a name='3575'>
      QNISTEN(K) = QNISTEN(K)-FALTNDS/NSTEP/RHO(k)<a name='3576'>
      NS3DTEN(K) = NS3DTEN(K)-FALTNDNS/NSTEP/RHO(k)<a name='3577'>
      NR3DTEN(K) = NR3DTEN(K)-FALTNDNR/NSTEP/RHO(k)<a name='3578'>
      QCSTEN(K) = QCSTEN(K)-FALTNDC/NSTEP/RHO(k)<a name='3579'>
      NC3DTEN(K) = NC3DTEN(K)-FALTNDNC/NSTEP/RHO(k)<a name='3580'>
      QGSTEN(K) = QGSTEN(K)-FALTNDG/NSTEP/RHO(k)<a name='3581'>
      NG3DTEN(K) = NG3DTEN(K)-FALTNDNG/NSTEP/RHO(k)<a name='3582'>
<a name='3583'>
      DUMR(K) = DUMR(K)-FALTNDR*DT/NSTEP<a name='3584'>
      DUMI(K) = DUMI(K)-FALTNDI*DT/NSTEP<a name='3585'>
      DUMFNI(K) = DUMFNI(K)-FALTNDNI*DT/NSTEP<a name='3586'>
      DUMQS(K) = DUMQS(K)-FALTNDS*DT/NSTEP<a name='3587'>
      DUMFNS(K) = DUMFNS(K)-FALTNDNS*DT/NSTEP<a name='3588'>
      DUMFNR(K) = DUMFNR(K)-FALTNDNR*DT/NSTEP<a name='3589'>
      DUMC(K) = DUMC(K)-FALTNDC*DT/NSTEP<a name='3590'>
      DUMFNC(K) = DUMFNC(K)-FALTNDNC*DT/NSTEP<a name='3591'>
      DUMG(K) = DUMG(K)-FALTNDG*DT/NSTEP<a name='3592'>
      DUMFNG(K) = DUMFNG(K)-FALTNDNG*DT/NSTEP<a name='3593'>
<a name='3594'>
      DO K = KTE-1,KTS,-1<a name='3595'>
      FALTNDR = (FALOUTR(K+1)-FALOUTR(K))/DZQ(K)<a name='3596'>
      FALTNDI = (FALOUTI(K+1)-FALOUTI(K))/DZQ(K)<a name='3597'>
      FALTNDNI = (FALOUTNI(K+1)-FALOUTNI(K))/DZQ(K)<a name='3598'>
      FALTNDS = (FALOUTS(K+1)-FALOUTS(K))/DZQ(K)<a name='3599'>
      FALTNDNS = (FALOUTNS(K+1)-FALOUTNS(K))/DZQ(K)<a name='3600'>
      FALTNDNR = (FALOUTNR(K+1)-FALOUTNR(K))/DZQ(K)<a name='3601'>
      FALTNDC = (FALOUTC(K+1)-FALOUTC(K))/DZQ(K)<a name='3602'>
      FALTNDNC = (FALOUTNC(K+1)-FALOUTNC(K))/DZQ(K)<a name='3603'>
      FALTNDG = (FALOUTG(K+1)-FALOUTG(K))/DZQ(K)<a name='3604'>
      FALTNDNG = (FALOUTNG(K+1)-FALOUTNG(K))/DZQ(K)<a name='3605'>
<a name='3606'>
<font color=#447700>! ADD FALLOUT TERMS TO EULERIAN TENDENCIES<a name='3607'></font>
<a name='3608'>
      QRSTEN(K) = QRSTEN(K)+FALTNDR/NSTEP/RHO(k)<a name='3609'>
      QISTEN(K) = QISTEN(K)+FALTNDI/NSTEP/RHO(k)<a name='3610'>
      NI3DTEN(K) = NI3DTEN(K)+FALTNDNI/NSTEP/RHO(k)<a name='3611'>
      QNISTEN(K) = QNISTEN(K)+FALTNDS/NSTEP/RHO(k)<a name='3612'>
      NS3DTEN(K) = NS3DTEN(K)+FALTNDNS/NSTEP/RHO(k)<a name='3613'>
      NR3DTEN(K) = NR3DTEN(K)+FALTNDNR/NSTEP/RHO(k)<a name='3614'>
      QCSTEN(K) = QCSTEN(K)+FALTNDC/NSTEP/RHO(k)<a name='3615'>
      NC3DTEN(K) = NC3DTEN(K)+FALTNDNC/NSTEP/RHO(k)<a name='3616'>
      QGSTEN(K) = QGSTEN(K)+FALTNDG/NSTEP/RHO(k)<a name='3617'>
      NG3DTEN(K) = NG3DTEN(K)+FALTNDNG/NSTEP/RHO(k)<a name='3618'>
<a name='3619'>
      DUMR(K) = DUMR(K)+FALTNDR*DT/NSTEP<a name='3620'>
      DUMI(K) = DUMI(K)+FALTNDI*DT/NSTEP<a name='3621'>
      DUMFNI(K) = DUMFNI(K)+FALTNDNI*DT/NSTEP<a name='3622'>
      DUMQS(K) = DUMQS(K)+FALTNDS*DT/NSTEP<a name='3623'>
      DUMFNS(K) = DUMFNS(K)+FALTNDNS*DT/NSTEP<a name='3624'>
      DUMFNR(K) = DUMFNR(K)+FALTNDNR*DT/NSTEP<a name='3625'>
      DUMC(K) = DUMC(K)+FALTNDC*DT/NSTEP<a name='3626'>
      DUMFNC(K) = DUMFNC(K)+FALTNDNC*DT/NSTEP<a name='3627'>
      DUMG(K) = DUMG(K)+FALTNDG*DT/NSTEP<a name='3628'>
      DUMFNG(K) = DUMFNG(K)+FALTNDNG*DT/NSTEP<a name='3629'>
<a name='3630'>
<font color=#447700>! FOR WRF-CHEM, NEED PRECIP RATES (UNITS OF KG/M^2/S)<a name='3631'></font>
	  CSED(K)=CSED(K)+FALOUTC(K)/NSTEP<a name='3632'>
	  ISED(K)=ISED(K)+FALOUTI(K)/NSTEP<a name='3633'>
	  SSED(K)=SSED(K)+FALOUTS(K)/NSTEP<a name='3634'>
	  GSED(K)=GSED(K)+FALOUTG(K)/NSTEP<a name='3635'>
	  RSED(K)=RSED(K)+FALOUTR(K)/NSTEP<a name='3636'>
      END DO<a name='3637'>
<a name='3638'>
<font color=#447700>! GET PRECIPITATION AND SNOWFALL ACCUMULATION DURING THE TIME STEP<a name='3639'></font>
<font color=#447700>! FACTOR OF 1000 CONVERTS FROM M TO MM, BUT DIVISION BY DENSITY<a name='3640'></font>
<font color=#447700>! OF LIQUID WATER CANCELS THIS FACTOR OF 1000<a name='3641'></font>
<a name='3642'>
        PRECRT = PRECRT+(FALOUTR(KTS)+FALOUTC(KTS)+FALOUTS(KTS)+FALOUTI(KTS)+FALOUTG(KTS))  &amp;<a name='3643'>
                     *DT/NSTEP<a name='3644'>
        SNOWRT = SNOWRT+(FALOUTS(KTS)+FALOUTI(KTS)+FALOUTG(KTS))*DT/NSTEP<a name='3645'>
<font color=#447700>! hm added 7/13/13<a name='3646'></font>
        SNOWPRT = SNOWPRT+(FALOUTI(KTS)+FALOUTS(KTS))*DT/NSTEP<a name='3647'>
        GRPLPRT = GRPLPRT+(FALOUTG(KTS))*DT/NSTEP<a name='3648'>
<a name='3649'>
      END DO<a name='3650'>
<a name='3651'>
        DO K=KTS,KTE<a name='3652'>
<a name='3653'>
<font color=#447700>! ADD ON SEDIMENTATION TENDENCIES FOR MIXING RATIO TO REST OF TENDENCIES<a name='3654'></font>
<a name='3655'>
        QR3DTEN(K)=QR3DTEN(K)+QRSTEN(K)<a name='3656'>
        QI3DTEN(K)=QI3DTEN(K)+QISTEN(K)<a name='3657'>
        QC3DTEN(K)=QC3DTEN(K)+QCSTEN(K)<a name='3658'>
        QG3DTEN(K)=QG3DTEN(K)+QGSTEN(K)<a name='3659'>
        QNI3DTEN(K)=QNI3DTEN(K)+QNISTEN(K)<a name='3660'>
<a name='3661'>
<font color=#447700>! PUT ALL CLOUD ICE IN SNOW CATEGORY IF MEAN DIAMETER EXCEEDS 2 * dcs<a name='3662'></font>
<a name='3663'>
<font color=#447700>!hm 4/7/09 bug fix<a name='3664'></font>
<font color=#447700>!        IF (QI3D(K).GE.QSMALL.AND.T3D(K).LT.273.15) THEN<a name='3665'></font>
        IF (QI3D(K).GE.QSMALL.AND.T3D(K).LT.273.15.AND.LAMI(K).GE.1.E-10) THEN<a name='3666'>
        IF (1./LAMI(K).GE.2.*DCS) THEN<a name='3667'>
           QNI3DTEN(K) = QNI3DTEN(K)+QI3D(K)/DT+ QI3DTEN(K)<a name='3668'>
           NS3DTEN(K) = NS3DTEN(K)+NI3D(K)/DT+   NI3DTEN(K)<a name='3669'>
           QI3DTEN(K) = -QI3D(K)/DT<a name='3670'>
           NI3DTEN(K) = -NI3D(K)/DT<a name='3671'>
        END IF<a name='3672'>
        END IF<a name='3673'>
<a name='3674'>
<font color=#447700>! hm add tendencies here, then call sizeparameter<a name='3675'></font>
<font color=#447700>! to ensure consisitency between mixing ratio and number concentration<a name='3676'></font>
<a name='3677'>
          QC3D(k)        = QC3D(k)+QC3DTEN(k)*DT<a name='3678'>
          QI3D(k)        = QI3D(k)+QI3DTEN(k)*DT<a name='3679'>
          QNI3D(k)        = QNI3D(k)+QNI3DTEN(k)*DT<a name='3680'>
          QR3D(k)        = QR3D(k)+QR3DTEN(k)*DT<a name='3681'>
          NC3D(k)        = NC3D(k)+NC3DTEN(k)*DT<a name='3682'>
          NI3D(k)        = NI3D(k)+NI3DTEN(k)*DT<a name='3683'>
          NS3D(k)        = NS3D(k)+NS3DTEN(k)*DT<a name='3684'>
          NR3D(k)        = NR3D(k)+NR3DTEN(k)*DT<a name='3685'>
<a name='3686'>
          IF (IGRAUP.EQ.0) THEN<a name='3687'>
          QG3D(k)        = QG3D(k)+QG3DTEN(k)*DT<a name='3688'>
          NG3D(k)        = NG3D(k)+NG3DTEN(k)*DT<a name='3689'>
          END IF<a name='3690'>
<a name='3691'>
<font color=#447700>! ADD TEMPERATURE AND WATER VAPOR TENDENCIES FROM MICROPHYSICS<a name='3692'></font>
          T3D(K)         = T3D(K)+T3DTEN(k)*DT<a name='3693'>
          QV3D(K)        = QV3D(K)+QV3DTEN(k)*DT<a name='3694'>
<a name='3695'>
<font color=#447700>! SATURATION VAPOR PRESSURE AND MIXING RATIO<a name='3696'></font>
<a name='3697'>
<font color=#447700>! hm, add fix for low pressure, 5/12/10<a name='3698'></font>
            EVS(K) = min(0.99*pres(k),POLYSVP(T3D(K),0))   <font color=#447700>! PA<a name='3699'></font>
            EIS(K) = min(0.99*pres(k),POLYSVP(T3D(K),1))   <font color=#447700>! PA<a name='3700'></font>
<a name='3701'>
<font color=#447700>! MAKE SURE ICE SATURATION DOESN'T EXCEED WATER SAT. NEAR FREEZING<a name='3702'></font>
<a name='3703'>
            IF (EIS(K).GT.EVS(K)) EIS(K) = EVS(K)<a name='3704'>
<a name='3705'>
            QVS(K) = EP_2*EVS(K)/(PRES(K)-EVS(K))<a name='3706'>
            QVI(K) = EP_2*EIS(K)/(PRES(K)-EIS(K))<a name='3707'>
<a name='3708'>
            QVQVS(K) = QV3D(K)/QVS(K)<a name='3709'>
            QVQVSI(K) = QV3D(K)/QVI(K)<a name='3710'>
<a name='3711'>
<font color=#447700>! AT SUBSATURATION, REMOVE SMALL AMOUNTS OF CLOUD/PRECIP WATER<a name='3712'></font>
<font color=#447700>! hm 7/9/09 change limit to 1.e-8<a name='3713'></font>
<a name='3714'>
             IF (QVQVS(K).LT.0.9) THEN<a name='3715'>
               IF (QR3D(K).LT.1.E-8) THEN<a name='3716'>
                  QV3D(K)=QV3D(K)+QR3D(K)<a name='3717'>
                  T3D(K)=T3D(K)-QR3D(K)*XXLV(K)/CPM(K)<a name='3718'>
                  QR3D(K)=0.<a name='3719'>
               END IF<a name='3720'>
               IF (QC3D(K).LT.1.E-8) THEN<a name='3721'>
                  QV3D(K)=QV3D(K)+QC3D(K)<a name='3722'>
                  T3D(K)=T3D(K)-QC3D(K)*XXLV(K)/CPM(K)<a name='3723'>
                  QC3D(K)=0.<a name='3724'>
               END IF<a name='3725'>
             END IF<a name='3726'>
<a name='3727'>
             IF (QVQVSI(K).LT.0.9) THEN<a name='3728'>
               IF (QI3D(K).LT.1.E-8) THEN<a name='3729'>
                  QV3D(K)=QV3D(K)+QI3D(K)<a name='3730'>
                  T3D(K)=T3D(K)-QI3D(K)*XXLS(K)/CPM(K)<a name='3731'>
                  QI3D(K)=0.<a name='3732'>
               END IF<a name='3733'>
               IF (QNI3D(K).LT.1.E-8) THEN<a name='3734'>
                  QV3D(K)=QV3D(K)+QNI3D(K)<a name='3735'>
                  T3D(K)=T3D(K)-QNI3D(K)*XXLS(K)/CPM(K)<a name='3736'>
                  QNI3D(K)=0.<a name='3737'>
               END IF<a name='3738'>
               IF (QG3D(K).LT.1.E-8) THEN<a name='3739'>
                  QV3D(K)=QV3D(K)+QG3D(K)<a name='3740'>
                  T3D(K)=T3D(K)-QG3D(K)*XXLS(K)/CPM(K)<a name='3741'>
                  QG3D(K)=0.<a name='3742'>
               END IF<a name='3743'>
             END IF<a name='3744'>
<a name='3745'>
<font color=#447700>!..................................................................<a name='3746'></font>
<font color=#447700>! IF MIXING RATIO &lt; QSMALL SET MIXING RATIO AND NUMBER CONC TO ZERO<a name='3747'></font>
<a name='3748'>
       IF (QC3D(K).LT.QSMALL) THEN<a name='3749'>
         QC3D(K) = 0.<a name='3750'>
         NC3D(K) = 0.<a name='3751'>
         EFFC(K) = 0.<a name='3752'>
       END IF<a name='3753'>
       IF (QR3D(K).LT.QSMALL) THEN<a name='3754'>
         QR3D(K) = 0.<a name='3755'>
         NR3D(K) = 0.<a name='3756'>
         EFFR(K) = 0.<a name='3757'>
       END IF<a name='3758'>
       IF (QI3D(K).LT.QSMALL) THEN<a name='3759'>
         QI3D(K) = 0.<a name='3760'>
         NI3D(K) = 0.<a name='3761'>
         EFFI(K) = 0.<a name='3762'>
       END IF<a name='3763'>
       IF (QNI3D(K).LT.QSMALL) THEN<a name='3764'>
         QNI3D(K) = 0.<a name='3765'>
         NS3D(K) = 0.<a name='3766'>
         EFFS(K) = 0.<a name='3767'>
       END IF<a name='3768'>
       IF (QG3D(K).LT.QSMALL) THEN<a name='3769'>
         QG3D(K) = 0.<a name='3770'>
         NG3D(K) = 0.<a name='3771'>
         EFFG(K) = 0.<a name='3772'>
       END IF<a name='3773'>
<a name='3774'>
<font color=#447700>!..................................<a name='3775'></font>
<font color=#447700>! IF THERE IS NO CLOUD/PRECIP WATER, THEN SKIP CALCULATIONS<a name='3776'></font>
<a name='3777'>
            IF (QC3D(K).LT.QSMALL.AND.QI3D(K).LT.QSMALL.AND.QNI3D(K).LT.QSMALL &amp;<a name='3778'>
                 .AND.QR3D(K).LT.QSMALL.AND.QG3D(K).LT.QSMALL) GOTO 500<a name='3779'>
<a name='3780'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3781'></font>
<font color=#447700>! CALCULATE INSTANTANEOUS PROCESSES<a name='3782'></font>
<a name='3783'>
<font color=#447700>! ADD MELTING OF CLOUD ICE TO FORM RAIN<a name='3784'></font>
<a name='3785'>
        IF (QI3D(K).GE.QSMALL.AND.T3D(K).GE.273.15) THEN<a name='3786'>
           QR3D(K) = QR3D(K)+QI3D(K)<a name='3787'>
           T3D(K) = T3D(K)-QI3D(K)*XLF(K)/CPM(K)<a name='3788'>
#if (WRF_CHEM == 1)<a name='3789'>
           tqimelt(K)=QI3D(K)/DT<a name='3790'>
#endif<a name='3791'>
           QI3D(K) = 0.<a name='3792'>
           NR3D(K) = NR3D(K)+NI3D(K)<a name='3793'>
           NI3D(K) = 0.<a name='3794'>
        END IF<a name='3795'>
<a name='3796'>
<font color=#447700>! ****SENSITIVITY - NO ICE<a name='3797'></font>
        IF (ILIQ.EQ.1) GOTO 778<a name='3798'>
<a name='3799'>
<font color=#447700>! HOMOGENEOUS FREEZING OF CLOUD WATER<a name='3800'></font>
<a name='3801'>
        IF (T3D(K).LE.233.15.AND.QC3D(K).GE.QSMALL) THEN<a name='3802'>
           QI3D(K)=QI3D(K)+QC3D(K)<a name='3803'>
           T3D(K)=T3D(K)+QC3D(K)*XLF(K)/CPM(K)<a name='3804'>
           QC3D(K)=0.<a name='3805'>
           NI3D(K)=NI3D(K)+NC3D(K)<a name='3806'>
           NC3D(K)=0.<a name='3807'>
        END IF<a name='3808'>
<a name='3809'>
<font color=#447700>! HOMOGENEOUS FREEZING OF RAIN<a name='3810'></font>
<a name='3811'>
        IF (IGRAUP.EQ.0) THEN<a name='3812'>
<a name='3813'>
        IF (T3D(K).LE.233.15.AND.QR3D(K).GE.QSMALL) THEN<a name='3814'>
           QG3D(K) = QG3D(K)+QR3D(K)<a name='3815'>
           T3D(K) = T3D(K)+QR3D(K)*XLF(K)/CPM(K)<a name='3816'>
           QR3D(K) = 0.<a name='3817'>
           NG3D(K) = NG3D(K)+ NR3D(K)<a name='3818'>
           NR3D(K) = 0.<a name='3819'>
        END IF<a name='3820'>
<a name='3821'>
        ELSE IF (IGRAUP.EQ.1) THEN<a name='3822'>
<a name='3823'>
        IF (T3D(K).LE.233.15.AND.QR3D(K).GE.QSMALL) THEN<a name='3824'>
           QNI3D(K) = QNI3D(K)+QR3D(K)<a name='3825'>
           T3D(K) = T3D(K)+QR3D(K)*XLF(K)/CPM(K)<a name='3826'>
           QR3D(K) = 0.<a name='3827'>
           NS3D(K) = NS3D(K)+NR3D(K)<a name='3828'>
           NR3D(K) = 0.<a name='3829'>
        END IF<a name='3830'>
<a name='3831'>
        END IF<a name='3832'>
<a name='3833'>
 778    CONTINUE<a name='3834'>
<a name='3835'>
<font color=#447700>! MAKE SURE NUMBER CONCENTRATIONS AREN'T NEGATIVE<a name='3836'></font>
<a name='3837'>
      NI3D(K) = MAX(0.,NI3D(K))<a name='3838'>
      NS3D(K) = MAX(0.,NS3D(K))<a name='3839'>
      NC3D(K) = MAX(0.,NC3D(K))<a name='3840'>
      NR3D(K) = MAX(0.,NR3D(K))<a name='3841'>
      NG3D(K) = MAX(0.,NG3D(K))<a name='3842'>
<a name='3843'>
<font color=#447700>!......................................................................<a name='3844'></font>
<font color=#447700>! CLOUD ICE<a name='3845'></font>
<a name='3846'>
      IF (QI3D(K).GE.QSMALL) THEN<a name='3847'>
         LAMI(K) = (CONS12*                 &amp;<a name='3848'>
              NI3D(K)/QI3D(K))**(1./DI)<a name='3849'>
<a name='3850'>
<font color=#447700>! CHECK FOR SLOPE<a name='3851'></font>
<a name='3852'>
<font color=#447700>! ADJUST VARS<a name='3853'></font>
<a name='3854'>
      IF (LAMI(K).LT.LAMMINI) THEN<a name='3855'>
<a name='3856'>
      LAMI(K) = LAMMINI<a name='3857'>
<a name='3858'>
      N0I(K) = LAMI(K)**4*QI3D(K)/CONS12<a name='3859'>
<a name='3860'>
      NI3D(K) = N0I(K)/LAMI(K)<a name='3861'>
      ELSE IF (LAMI(K).GT.LAMMAXI) THEN<a name='3862'>
      LAMI(K) = LAMMAXI<a name='3863'>
      N0I(K) = LAMI(K)**4*QI3D(K)/CONS12<a name='3864'>
<a name='3865'>
      NI3D(K) = N0I(K)/LAMI(K)<a name='3866'>
      END IF<a name='3867'>
      END IF<a name='3868'>
<a name='3869'>
<font color=#447700>!......................................................................<a name='3870'></font>
<font color=#447700>! RAIN<a name='3871'></font>
<a name='3872'>
      IF (QR3D(K).GE.QSMALL) THEN<a name='3873'>
      LAMR(K) = (PI*RHOW*NR3D(K)/QR3D(K))**(1./3.)<a name='3874'>
<a name='3875'>
<font color=#447700>! CHECK FOR SLOPE<a name='3876'></font>
<a name='3877'>
<font color=#447700>! ADJUST VARS<a name='3878'></font>
<a name='3879'>
      IF (LAMR(K).LT.LAMMINR) THEN<a name='3880'>
<a name='3881'>
      LAMR(K) = LAMMINR<a name='3882'>
<a name='3883'>
      N0RR(K) = LAMR(K)**4*QR3D(K)/(PI*RHOW)<a name='3884'>
<a name='3885'>
      NR3D(K) = N0RR(K)/LAMR(K)<a name='3886'>
      ELSE IF (LAMR(K).GT.LAMMAXR) THEN<a name='3887'>
      LAMR(K) = LAMMAXR<a name='3888'>
      N0RR(K) = LAMR(K)**4*QR3D(K)/(PI*RHOW)<a name='3889'>
<a name='3890'>
      NR3D(K) = N0RR(K)/LAMR(K)<a name='3891'>
      END IF<a name='3892'>
<a name='3893'>
      END IF<a name='3894'>
<a name='3895'>
<font color=#447700>!......................................................................<a name='3896'></font>
<font color=#447700>! CLOUD DROPLETS<a name='3897'></font>
<a name='3898'>
<font color=#447700>! MARTIN ET AL. (1994) FORMULA FOR PGAM<a name='3899'></font>
<a name='3900'>
      IF (QC3D(K).GE.QSMALL) THEN<a name='3901'>
<a name='3902'>
         DUM = PRES(K)/(287.15*T3D(K))<a name='3903'>
         PGAM(K)=0.0005714*(NC3D(K)/1.E6*DUM)+0.2714<a name='3904'>
         PGAM(K)=1./(PGAM(K)**2)-1.<a name='3905'>
         PGAM(K)=MAX(PGAM(K),2.)<a name='3906'>
         PGAM(K)=MIN(PGAM(K),10.)<a name='3907'>
<a name='3908'>
<font color=#447700>! CALCULATE LAMC<a name='3909'></font>
<a name='3910'>
      LAMC(K) = (CONS26*NC3D(K)*GAMMA(PGAM(K)+4.)/   &amp;<a name='3911'>
                 (QC3D(K)*GAMMA(PGAM(K)+1.)))**(1./3.)<a name='3912'>
<a name='3913'>
<font color=#447700>! LAMMIN, 60 MICRON DIAMETER<a name='3914'></font>
<font color=#447700>! LAMMAX, 1 MICRON<a name='3915'></font>
<a name='3916'>
      LAMMIN = (PGAM(K)+1.)/60.E-6<a name='3917'>
      LAMMAX = (PGAM(K)+1.)/1.E-6<a name='3918'>
<a name='3919'>
      IF (LAMC(K).LT.LAMMIN) THEN<a name='3920'>
      LAMC(K) = LAMMIN<a name='3921'>
      NC3D(K) = EXP(3.*LOG(LAMC(K))+LOG(QC3D(K))+              &amp;<a name='3922'>
                LOG(GAMMA(PGAM(K)+1.))-LOG(GAMMA(PGAM(K)+4.)))/CONS26<a name='3923'>
<a name='3924'>
      ELSE IF (LAMC(K).GT.LAMMAX) THEN<a name='3925'>
      LAMC(K) = LAMMAX<a name='3926'>
      NC3D(K) = EXP(3.*LOG(LAMC(K))+LOG(QC3D(K))+              &amp;<a name='3927'>
                LOG(GAMMA(PGAM(K)+1.))-LOG(GAMMA(PGAM(K)+4.)))/CONS26<a name='3928'>
<a name='3929'>
      END IF<a name='3930'>
<a name='3931'>
      END IF<a name='3932'>
<a name='3933'>
<font color=#447700>!......................................................................<a name='3934'></font>
<font color=#447700>! SNOW<a name='3935'></font>
<a name='3936'>
      IF (QNI3D(K).GE.QSMALL) THEN<a name='3937'>
      LAMS(K) = (CONS1*NS3D(K)/QNI3D(K))**(1./DS)<a name='3938'>
<a name='3939'>
<font color=#447700>! CHECK FOR SLOPE<a name='3940'></font>
<a name='3941'>
<font color=#447700>! ADJUST VARS<a name='3942'></font>
<a name='3943'>
      IF (LAMS(K).LT.LAMMINS) THEN<a name='3944'>
      LAMS(K) = LAMMINS<a name='3945'>
      N0S(K) = LAMS(K)**4*QNI3D(K)/CONS1<a name='3946'>
<a name='3947'>
      NS3D(K) = N0S(K)/LAMS(K)<a name='3948'>
<a name='3949'>
      ELSE IF (LAMS(K).GT.LAMMAXS) THEN<a name='3950'>
<a name='3951'>
      LAMS(K) = LAMMAXS<a name='3952'>
      N0S(K) = LAMS(K)**4*QNI3D(K)/CONS1<a name='3953'>
      NS3D(K) = N0S(K)/LAMS(K)<a name='3954'>
      END IF<a name='3955'>
<a name='3956'>
      END IF<a name='3957'>
<a name='3958'>
<font color=#447700>!......................................................................<a name='3959'></font>
<font color=#447700>! GRAUPEL<a name='3960'></font>
<a name='3961'>
      IF (QG3D(K).GE.QSMALL) THEN<a name='3962'>
      LAMG(K) = (CONS2*NG3D(K)/QG3D(K))**(1./DG)<a name='3963'>
<a name='3964'>
<font color=#447700>! CHECK FOR SLOPE<a name='3965'></font>
<a name='3966'>
<font color=#447700>! ADJUST VARS<a name='3967'></font>
<a name='3968'>
      IF (LAMG(K).LT.LAMMING) THEN<a name='3969'>
      LAMG(K) = LAMMING<a name='3970'>
      N0G(K) = LAMG(K)**4*QG3D(K)/CONS2<a name='3971'>
<a name='3972'>
      NG3D(K) = N0G(K)/LAMG(K)<a name='3973'>
<a name='3974'>
      ELSE IF (LAMG(K).GT.LAMMAXG) THEN<a name='3975'>
<a name='3976'>
      LAMG(K) = LAMMAXG<a name='3977'>
      N0G(K) = LAMG(K)**4*QG3D(K)/CONS2<a name='3978'>
<a name='3979'>
      NG3D(K) = N0G(K)/LAMG(K)<a name='3980'>
      END IF<a name='3981'>
<a name='3982'>
      END IF<a name='3983'>
<a name='3984'>
 500  CONTINUE<a name='3985'>
<a name='3986'>
<font color=#447700>! CALCULATE EFFECTIVE RADIUS<a name='3987'></font>
<a name='3988'>
      IF (QI3D(K).GE.QSMALL) THEN<a name='3989'>
         EFFI(K) = 3./LAMI(K)/2.*1.E6<a name='3990'>
      ELSE<a name='3991'>
         EFFI(K) = 25.<a name='3992'>
      END IF<a name='3993'>
<a name='3994'>
      IF (QNI3D(K).GE.QSMALL) THEN<a name='3995'>
         EFFS(K) = 3./LAMS(K)/2.*1.E6<a name='3996'>
      ELSE<a name='3997'>
         EFFS(K) = 25.<a name='3998'>
      END IF<a name='3999'>
<a name='4000'>
      IF (QR3D(K).GE.QSMALL) THEN<a name='4001'>
         EFFR(K) = 3./LAMR(K)/2.*1.E6<a name='4002'>
      ELSE<a name='4003'>
         EFFR(K) = 25.<a name='4004'>
      END IF<a name='4005'>
<a name='4006'>
      IF (QC3D(K).GE.QSMALL) THEN<a name='4007'>
      EFFC(K) = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>GAMMA</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#MORR_TWO_MOMENT_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_111">(PGAM(K)+4.)/                        &amp;<a name='4008'>
             GAMMA(PGAM(K)+3.)/LAMC(K)/2.*1.E6<a name='4009'>
      ELSE<a name='4010'>
      EFFC(K) = 25.<a name='4011'>
      END IF<a name='4012'>
<a name='4013'>
      IF (QG3D(K).GE.QSMALL) THEN<a name='4014'>
         EFFG(K) = 3./LAMG(K)/2.*1.E6<a name='4015'>
      ELSE<a name='4016'>
         EFFG(K) = 25.<a name='4017'>
      END IF<a name='4018'>
<a name='4019'>
<font color=#447700>! HM ADD 1/10/06, ADD UPPER BOUND ON ICE NUMBER, THIS IS NEEDED<a name='4020'></font>
<font color=#447700>! TO PREVENT VERY LARGE ICE NUMBER DUE TO HOMOGENEOUS FREEZING<a name='4021'></font>
<font color=#447700>! OF DROPLETS, ESPECIALLY WHEN INUM = 1, SET MAX AT 10 CM-3<a name='4022'></font>
<font color=#447700>!          NI3D(K) = MIN(NI3D(K),10.E6/RHO(K))<a name='4023'></font>
<font color=#447700>! HM, 12/28/12, LOWER MAXIMUM ICE CONCENTRATION TO ADDRESS PROBLEM<a name='4024'></font>
<font color=#447700>! OF EXCESSIVE AND PERSISTENT ANVIL<a name='4025'></font>
<font color=#447700>! NOTE: THIS MAY CHANGE/REDUCE SENSITIVITY TO AEROSOL/CCN CONCENTRATION<a name='4026'></font>
          NI3D(K) = MIN(NI3D(K),0.3E6/RHO(K))<a name='4027'>
<a name='4028'>
<font color=#447700>! ADD BOUND ON DROPLET NUMBER - CANNOT EXCEED AEROSOL CONCENTRATION<a name='4029'></font>
          IF (iinum.EQ.0.AND.IACT.EQ.2) THEN<a name='4030'>
          NC3D(K) = MIN(NC3D(K),(NANEW1+NANEW2)/RHO(K))<a name='4031'>
          END IF<a name='4032'>
<font color=#447700>! SWITCH FOR CONSTANT DROPLET NUMBER<a name='4033'></font>
          IF (iinum.EQ.1) THEN <a name='4034'>
<font color=#447700>! CHANGE NDCNST FROM CM-3 TO KG-1<a name='4035'></font>
             NC3D(K) = NDCNST*1.E6/RHO(K)<a name='4036'>
          END IF<a name='4037'>
<a name='4038'>
      END DO <font color=#447700>!!! K LOOP<a name='4039'></font>
<a name='4040'>
 400         CONTINUE<a name='4041'>
<a name='4042'>
<font color=#447700>! ALL DONE !!!!!!!!!!!<a name='4043'></font>
      RETURN<a name='4044'>
      END SUBROUTINE MORR_TWO_MOMENT_MICRO<a name='4045'>
<a name='4046'>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='4047'></font>
<a name='4048'>
<A NAME='POLYSVP'><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4049'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>POLYSVP</font> (T,TYPE) <A href='../../call_to/POLYSVP.html' TARGET='index'>27</A><a name='4050'>
<a name='4051'>
<font color=#447700>!-------------------------------------------<a name='4052'></font>
<a name='4053'>
<font color=#447700>!  COMPUTE SATURATION VAPOR PRESSURE<a name='4054'></font>
<a name='4055'>
<font color=#447700>!  POLYSVP RETURNED IN UNITS OF PA.<a name='4056'></font>
<font color=#447700>!  T IS INPUT IN UNITS OF K.<a name='4057'></font>
<font color=#447700>!  TYPE REFERS TO SATURATION WITH RESPECT TO LIQUID (0) OR ICE (1)<a name='4058'></font>
<a name='4059'>
<font color=#447700>! REPLACE GOFF-GRATCH WITH FASTER FORMULATION FROM FLATAU ET AL. 1992, TABLE 4 (RIGHT-HAND COLUMN)<a name='4060'></font>
<a name='4061'>
      IMPLICIT NONE<a name='4062'>
<a name='4063'>
      REAL DUM<a name='4064'>
      REAL T<a name='4065'>
      INTEGER TYPE<a name='4066'>
<font color=#447700>! ice<a name='4067'></font>
      real a0i,a1i,a2i,a3i,a4i,a5i,a6i,a7i,a8i <a name='4068'>
      data a0i,a1i,a2i,a3i,a4i,a5i,a6i,a7i,a8i /&amp;<a name='4069'>
	6.11147274, 0.503160820, 0.188439774e-1, &amp;<a name='4070'>
        0.420895665e-3, 0.615021634e-5,0.602588177e-7, &amp;<a name='4071'>
        0.385852041e-9, 0.146898966e-11, 0.252751365e-14/	<a name='4072'>
<a name='4073'>
<font color=#447700>! liquid<a name='4074'></font>
      real a0,a1,a2,a3,a4,a5,a6,a7,a8 <a name='4075'>
<a name='4076'>
<font color=#447700>! V1.7<a name='4077'></font>
      data a0,a1,a2,a3,a4,a5,a6,a7,a8 /&amp;<a name='4078'>
	6.11239921, 0.443987641, 0.142986287e-1, &amp;<a name='4079'>
        0.264847430e-3, 0.302950461e-5, 0.206739458e-7, &amp;<a name='4080'>
        0.640689451e-10,-0.952447341e-13,-0.976195544e-15/<a name='4081'>
      real dt<a name='4082'>
<a name='4083'>
<font color=#447700>! ICE<a name='4084'></font>
<a name='4085'>
      IF (TYPE.EQ.1) THEN<a name='4086'>
<a name='4087'>
<font color=#447700>!         POLYSVP = 10.**(-9.09718*(273.16/T-1.)-3.56654*                &amp;<a name='4088'></font>
<font color=#447700>!          LOG10(273.16/T)+0.876793*(1.-T/273.16)+						&amp;<a name='4089'></font>
<font color=#447700>!          LOG10(6.1071))*100.<a name='4090'></font>
<a name='4091'>
<a name='4092'>
      dt = max(-80.,t-273.16)<a name='4093'>
      polysvp = a0i + dt*(a1i+dt*(a2i+dt*(a3i+dt*(a4i+dt*(a5i+dt*(a6i+dt*(a7i+a8i*dt))))))) <a name='4094'>
      polysvp = polysvp*100.<a name='4095'>
<a name='4096'>
      END IF<a name='4097'>
<a name='4098'>
<font color=#447700>! LIQUID<a name='4099'></font>
<a name='4100'>
      IF (TYPE.EQ.0) THEN<a name='4101'>
<a name='4102'>
       dt = max(-80.,t-273.16)<a name='4103'>
       polysvp = a0 + dt*(a1+dt*(a2+dt*(a3+dt*(a4+dt*(a5+dt*(a6+dt*(a7+a8*dt)))))))<a name='4104'>
       polysvp = polysvp*100.<a name='4105'>
<a name='4106'>
<font color=#447700>!         POLYSVP = 10.**(-7.90298*(373.16/T-1.)+                        &amp;<a name='4107'></font>
<font color=#447700>!             5.02808*LOG10(373.16/T)-									&amp;<a name='4108'></font>
<font color=#447700>!             1.3816E-7*(10**(11.344*(1.-T/373.16))-1.)+				&amp;<a name='4109'></font>
<font color=#447700>!             8.1328E-3*(10**(-3.49149*(373.16/T-1.))-1.)+				&amp;<a name='4110'></font>
<font color=#447700>!             LOG10(1013.246))*100.<a name='4111'></font>
<a name='4112'>
         END IF<a name='4113'>
<a name='4114'>
<a name='4115'>
      END FUNCTION POLYSVP<a name='4116'>
<a name='4117'>
<font color=#447700>!------------------------------------------------------------------------------<a name='4118'></font>
<a name='4119'>
<A NAME='GAMMA'><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#GAMMA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4120'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>GAMMA</font>(X) <A href='../../call_to/GAMMA.html' TARGET='index'>117</A><a name='4121'>
<font color=#447700>!----------------------------------------------------------------------<a name='4122'></font>
<font color=#447700>!<a name='4123'></font>
<font color=#447700>! THIS ROUTINE CALCULATES THE GAMMA FUNCTION FOR A REAL ARGUMENT X.<a name='4124'></font>
<font color=#447700>!   COMPUTATION IS BASED ON AN ALGORITHM OUTLINED IN REFERENCE 1.<a name='4125'></font>
<font color=#447700>!   THE PROGRAM USES RATIONAL FUNCTIONS THAT APPROXIMATE THE GAMMA<a name='4126'></font>
<font color=#447700>!   FUNCTION TO AT LEAST 20 SIGNIFICANT DECIMAL DIGITS.  COEFFICIENTS<a name='4127'></font>
<font color=#447700>!   FOR THE APPROXIMATION OVER THE INTERVAL (1,2) ARE UNPUBLISHED.<a name='4128'></font>
<font color=#447700>!   THOSE FOR THE APPROXIMATION FOR X .GE. 12 ARE FROM REFERENCE 2.<a name='4129'></font>
<font color=#447700>!   THE ACCURACY ACHIEVED DEPENDS ON THE ARITHMETIC SYSTEM, THE<a name='4130'></font>
<font color=#447700>!   COMPILER, THE INTRINSIC FUNCTIONS, AND PROPER SELECTION OF THE<a name='4131'></font>
<font color=#447700>!   MACHINE-DEPENDENT CONSTANTS.<a name='4132'></font>
<font color=#447700>!<a name='4133'></font>
<font color=#447700>!<a name='4134'></font>
<font color=#447700>!*******************************************************************<a name='4135'></font>
<font color=#447700>!*******************************************************************<a name='4136'></font>
<font color=#447700>!<a name='4137'></font>
<font color=#447700>! EXPLANATION OF MACHINE-DEPENDENT CONSTANTS<a name='4138'></font>
<font color=#447700>!<a name='4139'></font>
<font color=#447700>! BETA   - RADIX FOR THE FLOATING-POINT REPRESENTATION<a name='4140'></font>
<font color=#447700>! MAXEXP - THE SMALLEST POSITIVE POWER OF BETA THAT OVERFLOWS<a name='4141'></font>
<font color=#447700>! XBIG   - THE LARGEST ARGUMENT FOR WHICH GAMMA(X) IS REPRESENTABLE<a name='4142'></font>
<font color=#447700>!          IN THE MACHINE, I.E., THE SOLUTION TO THE EQUATION<a name='4143'></font>
<font color=#447700>!                  GAMMA(XBIG) = BETA**MAXEXP<a name='4144'></font>
<font color=#447700>! XINF   - THE LARGEST MACHINE REPRESENTABLE FLOATING-POINT NUMBER;<a name='4145'></font>
<font color=#447700>!          APPROXIMATELY BETA**MAXEXP<a name='4146'></font>
<font color=#447700>! EPS    - THE SMALLEST POSITIVE FLOATING-POINT NUMBER SUCH THAT<a name='4147'></font>
<font color=#447700>!          1.0+EPS .GT. 1.0<a name='4148'></font>
<font color=#447700>! XMININ - THE SMALLEST POSITIVE FLOATING-POINT NUMBER SUCH THAT<a name='4149'></font>
<font color=#447700>!          1/XMININ IS MACHINE REPRESENTABLE<a name='4150'></font>
<font color=#447700>!<a name='4151'></font>
<font color=#447700>!     APPROXIMATE VALUES FOR SOME IMPORTANT MACHINES ARE:<a name='4152'></font>
<font color=#447700>!<a name='4153'></font>
<font color=#447700>!                            BETA       MAXEXP        XBIG<a name='4154'></font>
<font color=#447700>!<a name='4155'></font>
<font color=#447700>! CRAY-1         (S.P.)        2         8191        966.961<a name='4156'></font>
<font color=#447700>! CYBER 180/855<a name='4157'></font>
<font color=#447700>!   UNDER NOS    (S.P.)        2         1070        177.803<a name='4158'></font>
<font color=#447700>! IEEE (IBM/XT,<a name='4159'></font>
<font color=#447700>!   SUN, ETC.)   (S.P.)        2          128        35.040<a name='4160'></font>
<font color=#447700>! IEEE (IBM/XT,<a name='4161'></font>
<font color=#447700>!   SUN, ETC.)   (D.P.)        2         1024        171.624<a name='4162'></font>
<font color=#447700>! IBM 3033       (D.P.)       16           63        57.574<a name='4163'></font>
<font color=#447700>! VAX D-FORMAT   (D.P.)        2          127        34.844<a name='4164'></font>
<font color=#447700>! VAX G-FORMAT   (D.P.)        2         1023        171.489<a name='4165'></font>
<font color=#447700>!<a name='4166'></font>
<font color=#447700>!                            XINF         EPS        XMININ<a name='4167'></font>
<font color=#447700>!<a name='4168'></font>
<font color=#447700>! CRAY-1         (S.P.)   5.45E+2465   7.11E-15    1.84E-2466<a name='4169'></font>
<font color=#447700>! CYBER 180/855<a name='4170'></font>
<font color=#447700>!   UNDER NOS    (S.P.)   1.26E+322    3.55E-15    3.14E-294<a name='4171'></font>
<font color=#447700>! IEEE (IBM/XT,<a name='4172'></font>
<font color=#447700>!   SUN, ETC.)   (S.P.)   3.40E+38     1.19E-7     1.18E-38<a name='4173'></font>
<font color=#447700>! IEEE (IBM/XT,<a name='4174'></font>
<font color=#447700>!   SUN, ETC.)   (D.P.)   1.79D+308    2.22D-16    2.23D-308<a name='4175'></font>
<font color=#447700>! IBM 3033       (D.P.)   7.23D+75     2.22D-16    1.39D-76<a name='4176'></font>
<font color=#447700>! VAX D-FORMAT   (D.P.)   1.70D+38     1.39D-17    5.88D-39<a name='4177'></font>
<font color=#447700>! VAX G-FORMAT   (D.P.)   8.98D+307    1.11D-16    1.12D-308<a name='4178'></font>
<font color=#447700>!<a name='4179'></font>
<font color=#447700>!*******************************************************************<a name='4180'></font>
<font color=#447700>!*******************************************************************<a name='4181'></font>
<font color=#447700>!<a name='4182'></font>
<font color=#447700>! ERROR RETURNS<a name='4183'></font>
<font color=#447700>!<a name='4184'></font>
<font color=#447700>!  THE PROGRAM RETURNS THE VALUE XINF FOR SINGULARITIES OR<a name='4185'></font>
<font color=#447700>!     WHEN OVERFLOW WOULD OCCUR.  THE COMPUTATION IS BELIEVED<a name='4186'></font>
<font color=#447700>!     TO BE FREE OF UNDERFLOW AND OVERFLOW.<a name='4187'></font>
<font color=#447700>!<a name='4188'></font>
<font color=#447700>!<a name='4189'></font>
<font color=#447700>!  INTRINSIC FUNCTIONS REQUIRED ARE:<a name='4190'></font>
<font color=#447700>!<a name='4191'></font>
<font color=#447700>!     INT, DBLE, EXP, LOG, REAL, SIN<a name='4192'></font>
<font color=#447700>!<a name='4193'></font>
<font color=#447700>!<a name='4194'></font>
<font color=#447700>! REFERENCES:  AN OVERVIEW OF SOFTWARE DEVELOPMENT FOR SPECIAL<a name='4195'></font>
<font color=#447700>!              FUNCTIONS   W. J. CODY, LECTURE NOTES IN MATHEMATICS,<a name='4196'></font>
<font color=#447700>!              506, NUMERICAL ANALYSIS DUNDEE, 1975, G. A. WATSON<a name='4197'></font>
<font color=#447700>!              (ED.), SPRINGER VERLAG, BERLIN, 1976.<a name='4198'></font>
<font color=#447700>!<a name='4199'></font>
<font color=#447700>!              COMPUTER APPROXIMATIONS, HART, ET. AL., WILEY AND<a name='4200'></font>
<font color=#447700>!              SONS, NEW YORK, 1968.<a name='4201'></font>
<font color=#447700>!<a name='4202'></font>
<font color=#447700>!  LATEST MODIFICATION: OCTOBER 12, 1989<a name='4203'></font>
<font color=#447700>!<a name='4204'></font>
<font color=#447700>!  AUTHORS: W. J. CODY AND L. STOLTZ<a name='4205'></font>
<font color=#447700>!           APPLIED MATHEMATICS DIVISION<a name='4206'></font>
<font color=#447700>!           ARGONNE NATIONAL LABORATORY<a name='4207'></font>
<font color=#447700>!           ARGONNE, IL 60439<a name='4208'></font>
<font color=#447700>!<a name='4209'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4210'></font>
      implicit none<a name='4211'>
      INTEGER I,N<a name='4212'>
      LOGICAL PARITY<a name='4213'>
      REAL                                                          &amp;<a name='4214'>
          CONV,EPS,FACT,HALF,ONE,RES,SUM,TWELVE,                    &amp;<a name='4215'>
          TWO,X,XBIG,XDEN,XINF,XMININ,XNUM,Y,Y1,YSQ,Z,ZERO<a name='4216'>
      REAL, DIMENSION(7) :: C<a name='4217'>
      REAL, DIMENSION(8) :: P<a name='4218'>
      REAL, DIMENSION(8) :: Q<a name='4219'>
<font color=#447700>!----------------------------------------------------------------------<a name='4220'></font>
<font color=#447700>!  MATHEMATICAL CONSTANTS<a name='4221'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4222'></font>
      DATA ONE,HALF,TWELVE,TWO,ZERO/1.0E0,0.5E0,12.0E0,2.0E0,0.0E0/<a name='4223'>
<a name='4224'>
<a name='4225'>
<font color=#447700>!----------------------------------------------------------------------<a name='4226'></font>
<font color=#447700>!  MACHINE DEPENDENT PARAMETERS<a name='4227'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4228'></font>
      DATA XBIG,XMININ,EPS/35.040E0,1.18E-38,1.19E-7/,XINF/3.4E38/<a name='4229'>
<font color=#447700>!----------------------------------------------------------------------<a name='4230'></font>
<font color=#447700>!  NUMERATOR AND DENOMINATOR COEFFICIENTS FOR RATIONAL MINIMAX<a name='4231'></font>
<font color=#447700>!     APPROXIMATION OVER (1,2).<a name='4232'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4233'></font>
      DATA P/-1.71618513886549492533811E+0,2.47656508055759199108314E+1,  &amp;<a name='4234'>
             -3.79804256470945635097577E+2,6.29331155312818442661052E+2,  &amp;<a name='4235'>
             8.66966202790413211295064E+2,-3.14512729688483675254357E+4,  &amp;<a name='4236'>
             -3.61444134186911729807069E+4,6.64561438202405440627855E+4/<a name='4237'>
      DATA Q/-3.08402300119738975254353E+1,3.15350626979604161529144E+2,  &amp;<a name='4238'>
             -1.01515636749021914166146E+3,-3.10777167157231109440444E+3, &amp;<a name='4239'>
              2.25381184209801510330112E+4,4.75584627752788110767815E+3,  &amp;<a name='4240'>
            -1.34659959864969306392456E+5,-1.15132259675553483497211E+5/<a name='4241'>
<font color=#447700>!----------------------------------------------------------------------<a name='4242'></font>
<font color=#447700>!  COEFFICIENTS FOR MINIMAX APPROXIMATION OVER (12, INF).<a name='4243'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4244'></font>
      DATA C/-1.910444077728E-03,8.4171387781295E-04,                      &amp;<a name='4245'>
           -5.952379913043012E-04,7.93650793500350248E-04,				   &amp;<a name='4246'>
           -2.777777777777681622553E-03,8.333333333333333331554247E-02,	   &amp;<a name='4247'>
            5.7083835261E-03/<a name='4248'>
<font color=#447700>!----------------------------------------------------------------------<a name='4249'></font>
<font color=#447700>!  STATEMENT FUNCTIONS FOR CONVERSION BETWEEN INTEGER AND FLOAT<a name='4250'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4251'></font>
      CONV(I) = REAL(I)<a name='4252'>
      PARITY=.FALSE.<a name='4253'>
      FACT=ONE<a name='4254'>
      N=0<a name='4255'>
      Y=X<a name='4256'>
      IF(Y.LE.ZERO)THEN<a name='4257'>
<font color=#447700>!----------------------------------------------------------------------<a name='4258'></font>
<font color=#447700>!  ARGUMENT IS NEGATIVE<a name='4259'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4260'></font>
        Y=-X<a name='4261'>
        Y1=AINT(Y)<a name='4262'>
        RES=Y-Y1<a name='4263'>
        IF(RES.NE.ZERO)THEN<a name='4264'>
          IF(Y1.NE.AINT(Y1*HALF)*TWO)PARITY=.TRUE.<a name='4265'>
          FACT=-PI/SIN(PI*RES)<a name='4266'>
          Y=Y+ONE<a name='4267'>
        ELSE<a name='4268'>
          RES=XINF<a name='4269'>
          GOTO 900<a name='4270'>
        ENDIF<a name='4271'>
      ENDIF<a name='4272'>
<font color=#447700>!----------------------------------------------------------------------<a name='4273'></font>
<font color=#447700>!  ARGUMENT IS POSITIVE<a name='4274'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4275'></font>
      IF(Y.LT.EPS)THEN<a name='4276'>
<font color=#447700>!----------------------------------------------------------------------<a name='4277'></font>
<font color=#447700>!  ARGUMENT .LT. EPS<a name='4278'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4279'></font>
        IF(Y.GE.XMININ)THEN<a name='4280'>
          RES=ONE/Y<a name='4281'>
        ELSE<a name='4282'>
          RES=XINF<a name='4283'>
          GOTO 900<a name='4284'>
        ENDIF<a name='4285'>
      ELSEIF(Y.LT.TWELVE)THEN<a name='4286'>
        Y1=Y<a name='4287'>
        IF(Y.LT.ONE)THEN<a name='4288'>
<font color=#447700>!----------------------------------------------------------------------<a name='4289'></font>
<font color=#447700>!  0.0 .LT. ARGUMENT .LT. 1.0<a name='4290'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4291'></font>
          Z=Y<a name='4292'>
          Y=Y+ONE<a name='4293'>
        ELSE<a name='4294'>
<font color=#447700>!----------------------------------------------------------------------<a name='4295'></font>
<font color=#447700>!  1.0 .LT. ARGUMENT .LT. 12.0, REDUCE ARGUMENT IF NECESSARY<a name='4296'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4297'></font>
          N=INT(Y)-1<a name='4298'>
          Y=Y-CONV(N)<a name='4299'>
          Z=Y-ONE<a name='4300'>
        ENDIF<a name='4301'>
<font color=#447700>!----------------------------------------------------------------------<a name='4302'></font>
<font color=#447700>!  EVALUATE APPROXIMATION FOR 1.0 .LT. ARGUMENT .LT. 2.0<a name='4303'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4304'></font>
        XNUM=ZERO<a name='4305'>
        XDEN=ONE<a name='4306'>
        DO I=1,8<a name='4307'>
          XNUM=(XNUM+P(I))*Z<a name='4308'>
          XDEN=XDEN*Z+Q(I)<a name='4309'>
        END DO<a name='4310'>
        RES=XNUM/XDEN+ONE<a name='4311'>
        IF(Y1.LT.Y)THEN<a name='4312'>
<font color=#447700>!----------------------------------------------------------------------<a name='4313'></font>
<font color=#447700>!  ADJUST RESULT FOR CASE  0.0 .LT. ARGUMENT .LT. 1.0<a name='4314'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4315'></font>
          RES=RES/Y1<a name='4316'>
        ELSEIF(Y1.GT.Y)THEN<a name='4317'>
<font color=#447700>!----------------------------------------------------------------------<a name='4318'></font>
<font color=#447700>!  ADJUST RESULT FOR CASE  2.0 .LT. ARGUMENT .LT. 12.0<a name='4319'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4320'></font>
          DO I=1,N<a name='4321'>
            RES=RES*Y<a name='4322'>
            Y=Y+ONE<a name='4323'>
          END DO<a name='4324'>
        ENDIF<a name='4325'>
      ELSE<a name='4326'>
<font color=#447700>!----------------------------------------------------------------------<a name='4327'></font>
<font color=#447700>!  EVALUATE FOR ARGUMENT .GE. 12.0,<a name='4328'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4329'></font>
        IF(Y.LE.XBIG)THEN<a name='4330'>
          YSQ=Y*Y<a name='4331'>
          SUM=C(7)<a name='4332'>
          DO I=1,6<a name='4333'>
            SUM=SUM/YSQ+C(I)<a name='4334'>
          END DO<a name='4335'>
          SUM=SUM/Y-Y+xxx<a name='4336'>
          SUM=SUM+(Y-HALF)*LOG(Y)<a name='4337'>
          RES=EXP(SUM)<a name='4338'>
        ELSE<a name='4339'>
          RES=XINF<a name='4340'>
          GOTO 900<a name='4341'>
        ENDIF<a name='4342'>
      ENDIF<a name='4343'>
<font color=#447700>!----------------------------------------------------------------------<a name='4344'></font>
<font color=#447700>!  FINAL ADJUSTMENTS AND RETURN<a name='4345'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4346'></font>
      IF(PARITY)RES=-RES<a name='4347'>
      IF(FACT.NE.ONE)RES=FACT/RES<a name='4348'>
  900 GAMMA=RES<a name='4349'>
      RETURN<a name='4350'>
<font color=#447700>! ---------- LAST LINE OF GAMMA ----------<a name='4351'></font>
      END FUNCTION GAMMA<a name='4352'>
<a name='4353'>
<a name='4354'>
<A NAME='DERF1'><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#DERF1' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4355'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>DERF1</font>(X)<a name='4356'>
      IMPLICIT NONE<a name='4357'>
      REAL X<a name='4358'>
      REAL, DIMENSION(0 : 64) :: A, B<a name='4359'>
      REAL W,T,Y<a name='4360'>
      INTEGER K,I<a name='4361'>
      DATA A/                                                 &amp;<a name='4362'>
         0.00000000005958930743E0, -0.00000000113739022964E0, &amp;<a name='4363'>
         0.00000001466005199839E0, -0.00000016350354461960E0, &amp;<a name='4364'>
         0.00000164610044809620E0, -0.00001492559551950604E0, &amp;<a name='4365'>
         0.00012055331122299265E0, -0.00085483269811296660E0, &amp;<a name='4366'>
         0.00522397762482322257E0, -0.02686617064507733420E0, &amp;<a name='4367'>
         0.11283791670954881569E0, -0.37612638903183748117E0, &amp;<a name='4368'>
         1.12837916709551257377E0,	                          &amp;<a name='4369'>
         0.00000000002372510631E0, -0.00000000045493253732E0, &amp;<a name='4370'>
         0.00000000590362766598E0, -0.00000006642090827576E0, &amp;<a name='4371'>
         0.00000067595634268133E0, -0.00000621188515924000E0, &amp;<a name='4372'>
         0.00005103883009709690E0, -0.00037015410692956173E0, &amp;<a name='4373'>
         0.00233307631218880978E0, -0.01254988477182192210E0, &amp;<a name='4374'>
         0.05657061146827041994E0, -0.21379664776456006580E0, &amp;<a name='4375'>
         0.84270079294971486929E0,							  &amp;<a name='4376'>
         0.00000000000949905026E0, -0.00000000018310229805E0, &amp;<a name='4377'>
         0.00000000239463074000E0, -0.00000002721444369609E0, &amp;<a name='4378'>
         0.00000028045522331686E0, -0.00000261830022482897E0, &amp;<a name='4379'>
         0.00002195455056768781E0, -0.00016358986921372656E0, &amp;<a name='4380'>
         0.00107052153564110318E0, -0.00608284718113590151E0, &amp;<a name='4381'>
         0.02986978465246258244E0, -0.13055593046562267625E0, &amp;<a name='4382'>
         0.67493323603965504676E0, 							  &amp;<a name='4383'>
         0.00000000000382722073E0, -0.00000000007421598602E0, &amp;<a name='4384'>
         0.00000000097930574080E0, -0.00000001126008898854E0, &amp;<a name='4385'>
         0.00000011775134830784E0, -0.00000111992758382650E0, &amp;<a name='4386'>
         0.00000962023443095201E0, -0.00007404402135070773E0, &amp;<a name='4387'>
         0.00050689993654144881E0, -0.00307553051439272889E0, &amp;<a name='4388'>
         0.01668977892553165586E0, -0.08548534594781312114E0, &amp;<a name='4389'>
         0.56909076642393639985E0,							  &amp;<a name='4390'>
         0.00000000000155296588E0, -0.00000000003032205868E0, &amp;<a name='4391'>
         0.00000000040424830707E0, -0.00000000471135111493E0, &amp;<a name='4392'>
         0.00000005011915876293E0, -0.00000048722516178974E0, &amp;<a name='4393'>
         0.00000430683284629395E0, -0.00003445026145385764E0, &amp;<a name='4394'>
         0.00024879276133931664E0, -0.00162940941748079288E0, &amp;<a name='4395'>
         0.00988786373932350462E0, -0.05962426839442303805E0, &amp;<a name='4396'>
         0.49766113250947636708E0 /<a name='4397'>
      DATA (B(I), I = 0, 12) /                                  &amp;<a name='4398'>
         -0.00000000029734388465E0,  0.00000000269776334046E0, 	&amp;<a name='4399'>
         -0.00000000640788827665E0, -0.00000001667820132100E0,  &amp;<a name='4400'>
         -0.00000021854388148686E0,  0.00000266246030457984E0, 	&amp;<a name='4401'>
          0.00001612722157047886E0, -0.00025616361025506629E0, 	&amp;<a name='4402'>
          0.00015380842432375365E0,  0.00815533022524927908E0, 	&amp;<a name='4403'>
         -0.01402283663896319337E0, -0.19746892495383021487E0,  &amp;<a name='4404'>
          0.71511720328842845913E0 /<a name='4405'>
      DATA (B(I), I = 13, 25) /                                 &amp;<a name='4406'>
         -0.00000000001951073787E0, -0.00000000032302692214E0,  &amp;<a name='4407'>
          0.00000000522461866919E0,  0.00000000342940918551E0, 	&amp;<a name='4408'>
         -0.00000035772874310272E0,  0.00000019999935792654E0, 	&amp;<a name='4409'>
          0.00002687044575042908E0, -0.00011843240273775776E0, 	&amp;<a name='4410'>
         -0.00080991728956032271E0,  0.00661062970502241174E0, 	&amp;<a name='4411'>
          0.00909530922354827295E0, -0.20160072778491013140E0, 	&amp;<a name='4412'>
          0.51169696718727644908E0 /<a name='4413'>
      DATA (B(I), I = 26, 38) /                                 &amp;<a name='4414'>
         0.00000000003147682272E0, -0.00000000048465972408E0,   &amp;<a name='4415'>
         0.00000000063675740242E0,  0.00000003377623323271E0, 	&amp;<a name='4416'>
        -0.00000015451139637086E0, -0.00000203340624738438E0, 	&amp;<a name='4417'>
         0.00001947204525295057E0,  0.00002854147231653228E0, 	&amp;<a name='4418'>
        -0.00101565063152200272E0,  0.00271187003520095655E0, 	&amp;<a name='4419'>
         0.02328095035422810727E0, -0.16725021123116877197E0, 	&amp;<a name='4420'>
         0.32490054966649436974E0 /<a name='4421'>
      DATA (B(I), I = 39, 51) /                                 &amp;<a name='4422'>
         0.00000000002319363370E0, -0.00000000006303206648E0,   &amp;<a name='4423'>
        -0.00000000264888267434E0,  0.00000002050708040581E0, 	&amp;<a name='4424'>
         0.00000011371857327578E0, -0.00000211211337219663E0, 	&amp;<a name='4425'>
         0.00000368797328322935E0,  0.00009823686253424796E0, 	&amp;<a name='4426'>
        -0.00065860243990455368E0, -0.00075285814895230877E0, 	&amp;<a name='4427'>
         0.02585434424202960464E0, -0.11637092784486193258E0, 	&amp;<a name='4428'>
         0.18267336775296612024E0 /<a name='4429'>
      DATA (B(I), I = 52, 64) /                                 &amp;<a name='4430'>
        -0.00000000000367789363E0,  0.00000000020876046746E0, 	&amp;<a name='4431'>
        -0.00000000193319027226E0, -0.00000000435953392472E0, 	&amp;<a name='4432'>
         0.00000018006992266137E0, -0.00000078441223763969E0, 	&amp;<a name='4433'>
        -0.00000675407647949153E0,  0.00008428418334440096E0, 	&amp;<a name='4434'>
        -0.00017604388937031815E0, -0.00239729611435071610E0, 	&amp;<a name='4435'>
         0.02064129023876022970E0, -0.06905562880005864105E0,   &amp;<a name='4436'>
         0.09084526782065478489E0 /<a name='4437'>
      W = ABS(X)<a name='4438'>
      IF (W .LT. 2.2D0) THEN<a name='4439'>
          T = W * W<a name='4440'>
          K = INT(T)<a name='4441'>
          T = T - K<a name='4442'>
          K = K * 13<a name='4443'>
          Y = ((((((((((((A(K) * T + A(K + 1)) * T +              &amp;<a name='4444'>
              A(K + 2)) * T + A(K + 3)) * T + A(K + 4)) * T +     &amp;<a name='4445'>
              A(K + 5)) * T + A(K + 6)) * T + A(K + 7)) * T +     &amp;<a name='4446'>
              A(K + 8)) * T + A(K + 9)) * T + A(K + 10)) * T + 	  &amp;<a name='4447'>
              A(K + 11)) * T + A(K + 12)) * W<a name='4448'>
      ELSE IF (W .LT. 6.9D0) THEN<a name='4449'>
          K = INT(W)<a name='4450'>
          T = W - K<a name='4451'>
          K = 13 * (K - 2)<a name='4452'>
          Y = (((((((((((B(K) * T + B(K + 1)) * T +               &amp;<a name='4453'>
              B(K + 2)) * T + B(K + 3)) * T + B(K + 4)) * T + 	  &amp;<a name='4454'>
              B(K + 5)) * T + B(K + 6)) * T + B(K + 7)) * T + 	  &amp;<a name='4455'>
              B(K + 8)) * T + B(K + 9)) * T + B(K + 10)) * T + 	  &amp;<a name='4456'>
              B(K + 11)) * T + B(K + 12)<a name='4457'>
          Y = Y * Y<a name='4458'>
          Y = Y * Y<a name='4459'>
          Y = Y * Y<a name='4460'>
          Y = 1 - Y * Y<a name='4461'>
      ELSE<a name='4462'>
          Y = 1<a name='4463'>
      END IF<a name='4464'>
      IF (X .LT. 0) Y = -Y<a name='4465'>
      DERF1 = Y<a name='4466'>
      END FUNCTION DERF1<a name='4467'>
<a name='4468'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4469'></font>
<a name='4470'>
<A NAME='REFL10CM_HM'><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#REFL10CM_HM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4471'>
      <font color=#993300>subroutine </font><font color=#cc0000>refl10cm_hm</font> (qv1d, qr1d, nr1d, qs1d, ns1d, qg1d, ng1d, &amp; <A href='../../call_to/REFL10CM_HM.html' TARGET='index'>3</A>,<A href='../../call_from/REFL10CM_HM.html' TARGET='index'>6</A><a name='4472'>
                      t1d, p1d, dBZ, kts, kte, ii, jj)<a name='4473'>
<a name='4474'>
      IMPLICIT NONE<a name='4475'>
<a name='4476'>
<font color=#447700>!..Sub arguments<a name='4477'></font>
      INTEGER, INTENT(IN):: kts, kte, ii, jj<a name='4478'>
      REAL, DIMENSION(kts:kte), INTENT(IN)::                            &amp;<a name='4479'>
                      qv1d, qr1d, nr1d, qs1d, ns1d, qg1d, ng1d, t1d, p1d<a name='4480'>
      REAL, DIMENSION(kts:kte), INTENT(INOUT):: dBZ<a name='4481'>
<a name='4482'>
<font color=#447700>!..Local variables<a name='4483'></font>
      REAL, DIMENSION(kts:kte):: temp, pres, qv, rho<a name='4484'>
      REAL, DIMENSION(kts:kte):: rr, nr, rs, ns, rg, ng<a name='4485'>
<a name='4486'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: ilamr, ilamg, ilams<a name='4487'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: N0_r, N0_g, N0_s<a name='4488'>
      DOUBLE PRECISION:: lamr, lamg, lams<a name='4489'>
      LOGICAL, DIMENSION(kts:kte):: L_qr, L_qs, L_qg<a name='4490'>
<a name='4491'>
      REAL, DIMENSION(kts:kte):: ze_rain, ze_snow, ze_graupel<a name='4492'>
      DOUBLE PRECISION:: fmelt_s, fmelt_g<a name='4493'>
      DOUBLE PRECISION:: cback, x, eta, f_d<a name='4494'>
<a name='4495'>
      INTEGER:: i, k, k_0, kbot, n<a name='4496'>
      LOGICAL:: melti<a name='4497'>
<a name='4498'>
<font color=#447700>!+---+<a name='4499'></font>
<a name='4500'>
      do k = kts, kte<a name='4501'>
         dBZ(k) = -35.0<a name='4502'>
      enddo<a name='4503'>
<a name='4504'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4505'></font>
<font color=#447700>!..Put column of data into local arrays.<a name='4506'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4507'></font>
      do k = kts, kte<a name='4508'>
         temp(k) = t1d(k)<a name='4509'>
         qv(k) = MAX(1.E-10, qv1d(k))<a name='4510'>
         pres(k) = p1d(k)<a name='4511'>
         rho(k) = 0.622*pres(k)/(R*temp(k)*(qv(k)+0.622))<a name='4512'>
<a name='4513'>
         if (qr1d(k) .gt. 1.E-9) then<a name='4514'>
            rr(k) = qr1d(k)*rho(k)<a name='4515'>
            nr(k) = nr1d(k)*rho(k)<a name='4516'>
            lamr = (xam_r*xcrg(3)*xorg2*nr(k)/rr(k))**xobmr<a name='4517'>
            ilamr(k) = 1./lamr<a name='4518'>
            N0_r(k) = nr(k)*xorg2*lamr**xcre(2)<a name='4519'>
            L_qr(k) = .true.<a name='4520'>
         else<a name='4521'>
            rr(k) = 1.E-12<a name='4522'>
            nr(k) = 1.E-12<a name='4523'>
            L_qr(k) = .false.<a name='4524'>
         endif<a name='4525'>
<a name='4526'>
         if (qs1d(k) .gt. 1.E-9) then<a name='4527'>
            rs(k) = qs1d(k)*rho(k)<a name='4528'>
            ns(k) = ns1d(k)*rho(k)<a name='4529'>
            lams = (xam_s*xcsg(3)*xosg2*ns(k)/rs(k))**xobms<a name='4530'>
            ilams(k) = 1./lams<a name='4531'>
            N0_s(k) = ns(k)*xosg2*lams**xcse(2)<a name='4532'>
            L_qs(k) = .true.<a name='4533'>
         else<a name='4534'>
            rs(k) = 1.E-12<a name='4535'>
            ns(k) = 1.E-12<a name='4536'>
            L_qs(k) = .false.<a name='4537'>
         endif<a name='4538'>
<a name='4539'>
         if (qg1d(k) .gt. 1.E-9) then<a name='4540'>
            rg(k) = qg1d(k)*rho(k)<a name='4541'>
            ng(k) = ng1d(k)*rho(k)<a name='4542'>
            lamg = (xam_g*xcgg(3)*xogg2*ng(k)/rg(k))**xobmg<a name='4543'>
            ilamg(k) = 1./lamg<a name='4544'>
            N0_g(k) = ng(k)*xogg2*lamg**xcge(2)<a name='4545'>
            L_qg(k) = .true.<a name='4546'>
         else<a name='4547'>
            rg(k) = 1.E-12<a name='4548'>
            ng(k) = 1.E-12<a name='4549'>
            L_qg(k) = .false.<a name='4550'>
         endif<a name='4551'>
      enddo<a name='4552'>
<a name='4553'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4554'></font>
<font color=#447700>!..Locate K-level of start of melting (k_0 is level above).<a name='4555'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4556'></font>
      melti = .false.<a name='4557'>
      k_0 = kts<a name='4558'>
      do k = kte-1, kts, -1<a name='4559'>
         if ( (temp(k).gt.273.15) .and. L_qr(k)                         &amp;<a name='4560'>
                                  .and. (L_qs(k+1).or.L_qg(k+1)) ) then<a name='4561'>
            k_0 = MAX(k+1, k_0)<a name='4562'>
            melti=.true.<a name='4563'>
            goto 195<a name='4564'>
         endif<a name='4565'>
      enddo<a name='4566'>
 195  continue<a name='4567'>
<a name='4568'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4569'></font>
<font color=#447700>!..Assume Rayleigh approximation at 10 cm wavelength. Rain (all temps)<a name='4570'></font>
<font color=#447700>!.. and non-water-coated snow and graupel when below freezing are<a name='4571'></font>
<font color=#447700>!.. simple. Integrations of m(D)*m(D)*N(D)*dD.<a name='4572'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4573'></font>
<a name='4574'>
      do k = kts, kte<a name='4575'>
         ze_rain(k) = 1.e-22<a name='4576'>
         ze_snow(k) = 1.e-22<a name='4577'>
         ze_graupel(k) = 1.e-22<a name='4578'>
         if (L_qr(k)) ze_rain(k) = N0_r(k)*xcrg(4)*ilamr(k)**xcre(4)<a name='4579'>
         if (L_qs(k)) ze_snow(k) = (0.176/0.93) * (6.0/PI)*(6.0/PI)     &amp;<a name='4580'>
                                 * (xam_s/900.0)*(xam_s/900.0)          &amp;<a name='4581'>
                                 * N0_s(k)*xcsg(4)*ilams(k)**xcse(4)<a name='4582'>
         if (L_qg(k)) ze_graupel(k) = (0.176/0.93) * (6.0/PI)*(6.0/PI)  &amp;<a name='4583'>
                                    * (xam_g/900.0)*(xam_g/900.0)       &amp;<a name='4584'>
                                    * N0_g(k)*xcgg(4)*ilamg(k)**xcge(4)<a name='4585'>
      enddo<a name='4586'>
<a name='4587'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4588'></font>
<font color=#447700>!..Special case of melting ice (snow/graupel) particles.  Assume the<a name='4589'></font>
<font color=#447700>!.. ice is surrounded by the liquid water.  Fraction of meltwater is<a name='4590'></font>
<font color=#447700>!.. extremely simple based on amount found above the melting level.<a name='4591'></font>
<font color=#447700>!.. Uses code from Uli Blahak (rayleigh_soak_wetgraupel and supporting<a name='4592'></font>
<font color=#447700>!.. routines).<a name='4593'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4594'></font>
<a name='4595'>
      if (melti .and. k_0.ge.kts+1) then<a name='4596'>
       do k = k_0-1, kts, -1<a name='4597'>
<a name='4598'>
<font color=#447700>!..Reflectivity contributed by melting snow<a name='4599'></font>
          if (L_qs(k) .and. L_qs(k_0) ) then<a name='4600'>
           fmelt_s = MAX(0.005d0, MIN(1.0d0-rs(k)/rs(k_0), 0.99d0))<a name='4601'>
           eta = 0.d0<a name='4602'>
           lams = 1./ilams(k)<a name='4603'>
           do n = 1, nrbins<a name='4604'>
              x = xam_s * xxDs(n)**xbm_s<a name='4605'>
              call <A href='../../html_code/phys/module_mp_radar.F.html#RAYLEIGH_SOAK_WETGRAUPEL'>rayleigh_soak_wetgraupel</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#REFL10CM_HM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAYLEIGH_SOAK_WETGRAUPEL_9"> (x,DBLE(xocms),DBLE(xobms), &amp;<a name='4606'>
                    fmelt_s, melt_outside_s, m_w_0, m_i_0, lamda_radar, &amp;<a name='4607'>
                    CBACK, mixingrulestring_s, matrixstring_s,          &amp;<a name='4608'>
                    inclusionstring_s, hoststring_s,                    &amp;<a name='4609'>
                    hostmatrixstring_s, hostinclusionstring_s)<a name='4610'>
              f_d = N0_s(k)*xxDs(n)**xmu_s * DEXP(-lams*xxDs(n))<a name='4611'>
              eta = eta + f_d * CBACK * simpson(n) * xdts(n)<a name='4612'>
           enddo<a name='4613'>
           ze_snow(k) = SNGL(lamda4 / (pi5 * K_w) * eta)<a name='4614'>
          endif<a name='4615'>
<a name='4616'>
<a name='4617'>
<font color=#447700>!..Reflectivity contributed by melting graupel<a name='4618'></font>
<a name='4619'>
          if (L_qg(k) .and. L_qg(k_0) ) then<a name='4620'>
           fmelt_g = MAX(0.005d0, MIN(1.0d0-rg(k)/rg(k_0), 0.99d0))<a name='4621'>
           eta = 0.d0<a name='4622'>
           lamg = 1./ilamg(k)<a name='4623'>
           do n = 1, nrbins<a name='4624'>
              x = xam_g * xxDg(n)**xbm_g<a name='4625'>
              call <A href='../../html_code/phys/module_mp_radar.F.html#RAYLEIGH_SOAK_WETGRAUPEL'>rayleigh_soak_wetgraupel</A><A href='../../html_code/phys/module_mp_morr_two_moment.F.html#REFL10CM_HM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAYLEIGH_SOAK_WETGRAUPEL_10"> (x,DBLE(xocmg),DBLE(xobmg), &amp;<a name='4626'>
                    fmelt_g, melt_outside_g, m_w_0, m_i_0, lamda_radar, &amp;<a name='4627'>
                    CBACK, mixingrulestring_g, matrixstring_g,          &amp;<a name='4628'>
                    inclusionstring_g, hoststring_g,                    &amp;<a name='4629'>
                    hostmatrixstring_g, hostinclusionstring_g)<a name='4630'>
              f_d = N0_g(k)*xxDg(n)**xmu_g * DEXP(-lamg*xxDg(n))<a name='4631'>
              eta = eta + f_d * CBACK * simpson(n) * xdtg(n)<a name='4632'>
           enddo<a name='4633'>
           ze_graupel(k) = SNGL(lamda4 / (pi5 * K_w) * eta)<a name='4634'>
          endif<a name='4635'>
<a name='4636'>
       enddo<a name='4637'>
      endif<a name='4638'>
<a name='4639'>
      do k = kte, kts, -1<a name='4640'>
         dBZ(k) = 10.*log10((ze_rain(k)+ze_snow(k)+ze_graupel(k))*1.d18)<a name='4641'>
      enddo<a name='4642'>
<a name='4643'>
<a name='4644'>
      end subroutine refl10cm_hm<a name='4645'>
<a name='4646'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4647'></font>
<a name='4648'>
END MODULE module_mp_morr_two_moment<a name='4649'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4650'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4651'></font>
</pre></body></html>