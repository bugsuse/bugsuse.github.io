<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#define WRF_PORT<a name='2'>
#define MODAL_AERO<a name='3'>
<font color=#447700>! Updated to CESM1.0.3 (CAM5.1.01) by Balwinder.Singh@pnnl.gov<a name='4'></font>
<A NAME='UWSHCU'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#UWSHCU' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
  <font color=#993300>module </font><font color=#cc0000>uwshcu</font> <A href='../../call_to/UWSHCU.html' TARGET='index'>2</A>,<A href='../../call_from/UWSHCU.html' TARGET='index'>5</A><a name='6'>
#ifndef WRF_PORT<a name='7'>
  use cam_history,    only: outfld, addfld, phys_decomp<a name='8'>
#else<a name='9'>
  use <A href='../../html_code/phys/module_cam_support.F.html#MODULE_CAM_SUPPORT'>module_cam_support</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CAM_SUPPORT_73">, only: outfld, addfld, phys_decomp<a name='10'>
#if ( NMM_CORE == 1 )<a name='11'>
  use <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_159">, only: CAMUWPBLSCHEME, MYJPBLSCHEME<a name='12'>
#else<a name='13'>
  use <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_160">, only: CAMUWPBLSCHEME, MYJPBLSCHEME, &amp;<a name='14'>
      MYNNPBLSCHEME2, MYNNPBLSCHEME3<a name='15'>
#endif<a name='16'>
#endif<a name='17'>
  use <A href='../../html_code/phys/module_cam_error_function.F.html#ERROR_FUNCTION'>error_function</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ERROR_FUNCTION_6">, only: erfc<a name='18'>
#ifndef WRF_PORT<a name='19'>
  use cam_logfile,    only: iulog<a name='20'>
  use ppgrid,         only: pcols, pver, pverp<a name='21'>
  use abortutils,     only: endrun<a name='22'>
  use spmd_utils,     only: masterproc<a name='23'>
#else<a name='24'>
  use <A href='../../html_code/phys/module_cam_support.F.html#MODULE_CAM_SUPPORT'>module_cam_support</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CAM_SUPPORT_74">, only: iulog, pcols, pver, pverp, endrun, masterproc<a name='25'>
#endif<a name='26'>
<a name='27'>
<a name='28'>
  implicit none<a name='29'>
  private<a name='30'>
  save<a name='31'>
<a name='32'>
  public &amp;<a name='33'>
     uwshcu_readnl,      &amp;<a name='34'>
     init_uwshcu,        &amp;<a name='35'>
     compute_uwshcu,     &amp;<a name='36'>
     compute_uwshcu_inv<a name='37'>
  <a name='38'>
  integer , parameter :: r8 = selected_real_kind(12)    <font color=#447700>!  8 byte real<a name='39'></font>
  real(r8), parameter :: unset_r8 = huge(1.0_r8)<a name='40'>
  real(r8)            :: xlv                            <font color=#447700>!  Latent heat of vaporization<a name='41'></font>
  real(r8)            :: xlf                            <font color=#447700>!  Latent heat of fusion<a name='42'></font>
  real(r8)            :: xls                            <font color=#447700>!  Latent heat of sublimation = xlv + xlf<a name='43'></font>
  real(r8)            :: cp                             <font color=#447700>!  Specific heat of dry air<a name='44'></font>
  real(r8)            :: zvir                           <font color=#447700>!  rh2o/rair - 1<a name='45'></font>
  real(r8)            :: r                              <font color=#447700>!  Gas constant for dry air<a name='46'></font>
  real(r8)            :: g                              <font color=#447700>!  Gravitational constant<a name='47'></font>
  real(r8)            :: ep2                            <font color=#447700>!  mol wgt water vapor / mol wgt dry air <a name='48'></font>
  real(r8)            :: p00                            <font color=#447700>!  Reference pressure for exner function<a name='49'></font>
  real(r8)            :: rovcp                          <font color=#447700>!  R/cp<a name='50'></font>
<a name='51'>
  <font color=#447700>! Tuning parameters set via namelist<a name='52'></font>
  real(r8) :: rpen          <font color=#447700>!  For penetrative entrainment efficiency<a name='53'></font>
<a name='54'>
<font color=#447700>!===============================================================================<a name='55'></font>
contains<a name='56'>
<font color=#447700>!===============================================================================<a name='57'></font>
  <a name='58'>
<A NAME='EXNF'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#EXNF' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='59'>
  real(r8) <font color=#993300>function </font><font color=#cc0000>exnf</font>(pressure) <A href='../../call_to/EXNF.html' TARGET='index'>2</A><a name='60'>
           real(r8), intent(in)              :: pressure<a name='61'>
           exnf = (pressure/p00)**rovcp<a name='62'>
           return<a name='63'>
  end function exnf<a name='64'>
<a name='65'>
<font color=#447700>!===============================================================================<a name='66'></font>
<a name='67'>
<A NAME='UWSHCU_READNL'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#UWSHCU_READNL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='68'>
<font color=#993300>subroutine </font><font color=#cc0000>uwshcu_readnl</font>(nlfile) <A href='../../call_to/UWSHCU_READNL.html' TARGET='index'>1</A>,<A href='../../call_from/UWSHCU_READNL.html' TARGET='index'>1</A><a name='69'>
#ifndef WRF_PORT<a name='70'>
   use namelist_utils,  only: find_group_name<a name='71'>
   use units,           only: getunit, freeunit<a name='72'>
   use mpishorthand<a name='73'>
#endif<a name='74'>
<a name='75'>
   character(len=*), intent(in) :: nlfile  <font color=#447700>! filepath for file containing namelist input<a name='76'></font>
<a name='77'>
#ifndef WRF_PORT<a name='78'>
   <font color=#447700>! Local variables<a name='79'></font>
   integer :: unitn, ierr<a name='80'>
   character(len=*), parameter :: subname = 'uwshcu_readnl'<a name='81'>
<a name='82'>
   <font color=#447700>! Namelist variables<a name='83'></font>
   real(r8) :: uwshcu_rpen =  unset_r8    <font color=#447700>!  For penetrative entrainment efficiency<a name='84'></font>
<a name='85'>
   namelist /uwshcu_nl/ uwshcu_rpen<a name='86'>
   <font color=#447700>!-----------------------------------------------------------------------------<a name='87'></font>
<a name='88'>
   if (masterproc) then<a name='89'>
      unitn = getunit()<a name='90'>
      open( unitn, file=trim(nlfile), status='old' )<a name='91'>
      call find_group_name(unitn, 'uwshcu_nl', status=ierr)<a name='92'>
      if (ierr == 0) then<a name='93'>
         read(unitn, uwshcu_nl, iostat=ierr)<a name='94'>
         if (ierr /= 0) then<a name='95'>
            call <A href='../../html_code/phys/module_sf_clm.F.html#ENDRUN'>endrun</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#UWSHCU_READNL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENDRUN_156">(subname // ':: ERROR reading namelist')<a name='96'>
         end if<a name='97'>
      end if<a name='98'>
      close(unitn)<a name='99'>
      call freeunit(unitn)<a name='100'>
   end if<a name='101'>
<a name='102'>
#ifdef SPMD<a name='103'>
   <font color=#447700>! Broadcast namelist variables<a name='104'></font>
   call mpibcast(uwshcu_rpen,            1, mpir8,  0, mpicom)<a name='105'>
#endif<a name='106'>
   <a name='107'>
   rpen=uwshcu_rpen<a name='108'>
#else<a name='109'>
   <font color=#447700>!Balwinder.Singh@pnnl.gov: rpen value has been obtained from previous incarnation <a name='110'></font>
   <font color=#447700>!of this module (see CESM101)<a name='111'></font>
   rpen= 10.0_r8<a name='112'>
#endif  <a name='113'>
<a name='114'>
end subroutine uwshcu_readnl<a name='115'>
<a name='116'>
<font color=#447700>!===============================================================================<a name='117'></font>
<a name='118'>
<A NAME='INIT_UWSHCU'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='119'>
  <font color=#993300>subroutine </font><font color=#cc0000>init_uwshcu</font>( kind, xlv_in, cp_in, xlf_in, zvir_in, r_in, g_in, ep2_in &amp; <A href='../../call_to/INIT_UWSHCU.html' TARGET='index'>1</A>,<A href='../../call_from/INIT_UWSHCU.html' TARGET='index'>97</A><a name='120'>
#ifdef WRF_PORT<a name='121'>
       , rushten, rvshten, rthshten, rqvshten,                   &amp;<a name='122'>
       rqcshten, rqrshten, rqishten, rqsshten, rqgshten,         &amp;<a name='123'>
       p_qc, p_qr, p_qi, p_qs, p_qg,                             &amp;<a name='124'>
       bl_pbl_physics, param_first_scalar, restart,              &amp;<a name='125'>
       ids, ide, jds, jde, kds, kde,                             &amp;<a name='126'>
       ims, ime, jms, jme, kms, kme,                             &amp;<a name='127'>
       its, ite, jts, jte, kts, kte                              )<a name='128'>
#else<a name='129'>
                                                                 )<a name='130'>
#endif<a name='131'>
<font color=#447700>!~add in zeroing of things like rliq that may come from ZM or may not<a name='132'></font>
<a name='133'>
    <font color=#447700>!------------------------------------------------------------- ! <a name='134'></font>
    <font color=#447700>! Purpose:                                                     !<a name='135'></font>
    <font color=#447700>! Initialize key constants for the shallow convection package. !<a name='136'></font>
    <font color=#447700>!------------------------------------------------------------- !<a name='137'></font>
#ifndef WRF_PORT<a name='138'>
    use cam_history,   only: outfld, addfld, phys_decomp<a name='139'>
    use ppgrid,        only: pcols, pver, pverp<a name='140'>
#else<a name='141'>
    use <A href='../../html_code/phys/module_cam_support.F.html#MODULE_CAM_SUPPORT'>module_cam_support</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CAM_SUPPORT_75">, only: outfld, addfld, phys_decomp, pcols, pver, pverp<a name='142'>
#endif<a name='143'>
    implicit none<a name='144'>
    integer , intent(in) :: kind       <font color=#447700>!  kind of reals being passed in<a name='145'></font>
    real(r8), intent(in) :: xlv_in     <font color=#447700>!  Latent heat of vaporization<a name='146'></font>
    real(r8), intent(in) :: xlf_in     <font color=#447700>!  Latent heat of fusion<a name='147'></font>
    real(r8), intent(in) :: cp_in      <font color=#447700>!  Specific heat of dry air<a name='148'></font>
    real(r8), intent(in) :: zvir_in    <font color=#447700>!  rh2o/rair - 1<a name='149'></font>
    real(r8), intent(in) :: r_in       <font color=#447700>!  Gas constant for dry air<a name='150'></font>
    real(r8), intent(in) :: g_in       <font color=#447700>!  Gravitational constant<a name='151'></font>
    real(r8), intent(in) :: ep2_in     <font color=#447700>!  mol wgt water vapor / mol wgt dry air <a name='152'></font>
<a name='153'>
    character(len=*), parameter :: subname = 'init_uwshcu'<a name='154'>
#ifdef WRF_PORT<a name='155'>
    LOGICAL , INTENT(IN)           ::   restart<a name='156'>
    INTEGER , INTENT(IN)           ::   ids, ide, jds, jde, kds, kde, &amp;<a name='157'>
                                        ims, ime, jms, jme, kms, kme, &amp;<a name='158'>
                                        its, ite, jts, jte, kts, kte, &amp;<a name='159'>
                                        p_qc, p_qr, p_qi, p_qs, p_qg, &amp;<a name='160'>
                                        param_first_scalar,           &amp;<a name='161'>
                                        bl_pbl_physics<a name='162'>
<a name='163'>
    REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(INOUT) :: &amp;<a name='164'>
                                                             rushten, &amp;<a name='165'>
                                                             rvshten, &amp;<a name='166'>
                                                            rthshten, &amp;<a name='167'>
                                                            rqvshten, &amp;<a name='168'>
                                                            rqcshten, &amp;<a name='169'>
                                                            rqrshten, &amp;<a name='170'>
                                                            rqishten, &amp;<a name='171'>
                                                            rqsshten, &amp;<a name='172'>
                                                            rqgshten<a name='173'>
<a name='174'>
  integer :: i, itf, j, jtf, k, ktf<a name='175'>
<a name='176'>
  jtf = min(jte,jde-1)<a name='177'>
  ktf = min(kte,kde-1)<a name='178'>
  itf = min(ite,ide-1)<a name='179'>
<a name='180'>
#ifdef WRF_PORT<a name='181'>
  <font color=#447700>!Balwinder.Singh@pnnl.gov - Call to assign rpen<a name='182'></font>
  call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#UWSHCU_READNL'>uwshcu_readnl</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UWSHCU_READNL_1">('dummyString')<a name='183'>
#endif<a name='184'>
<font color=#447700>!<a name='185'></font>
<font color=#447700>! The CAM UW shallow Cu scheme only works with PBL schemes that generate<a name='186'></font>
<font color=#447700>! TKE. So, for example, YSU would be an invalid choice to combine with<a name='187'></font>
<font color=#447700>! the UW scheme. For now, we are coupling into the tke_myj version of<a name='188'></font>
<font color=#447700>! TKE used by MYJ and CAMUWPBL. At some point, it would be great to unify<a name='189'></font>
<font color=#447700>! all the different TKEs output so that things work together properly.<a name='190'></font>
<font color=#447700>! For now, we are not trying to deal with the cacophony of variables,<a name='191'></font>
<font color=#447700>! i.e. tke &amp; tke_pbl.<a name='192'></font>
<font color=#447700>!<a name='193'></font>
  select case(bl_pbl_physics)<a name='194'>
#if ( NMM_CORE == 1 )<a name='195'>
  case (CAMUWPBLSCHEME, MYJPBLSCHEME)<a name='196'>
#else<a name='197'>
  case (CAMUWPBLSCHEME, MYJPBLSCHEME, MYNNPBLSCHEME2, MYNNPBLSCHEME3)<a name='198'>
#endif<a name='199'>
     <font color=#447700>!These are acceptable PBL schemes.<a name='200'></font>
  case default<a name='201'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1275">("The CAMUWSHCU scheme requires CAMUWPBLSCHEME, MYJPBLSCHEME or MYNN.")<a name='202'>
  end select<a name='203'>
<font color=#447700>!<a name='204'></font>
<font color=#447700>! Initialize module_cam_support variables...<a name='205'></font>
<font color=#447700>! This could be moved to a master "cam-init" subroutine once multiple CAM<a name='206'></font>
<font color=#447700>! parameterizations are implemented in WRF. For now, it doesn't hurt to<a name='207'></font>
<font color=#447700>! have these possibly initialized more than once since they are<a name='208'></font>
<font color=#447700>! essentially constant.<a name='209'></font>
<font color=#447700>!<a name='210'></font>
  pver  = ktf-kts+1<a name='211'>
  pverp = pver+1<a name='212'>
#endif<a name='213'>
    <font color=#447700>! ------------------------- !<a name='214'></font>
    <font color=#447700>! Internal Output Variables !<a name='215'></font>
    <font color=#447700>! ------------------------- !<a name='216'></font>
<a name='217'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_106">( 'qtflx_Cu'       , 'kg/m2/s' , pverp , 'A' , 'Convective qt flux'                                  , phys_decomp )<a name='218'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_107">( 'slflx_Cu'       , 'J/m2/s'  , pverp , 'A' , 'Convective sl flux'                                  , phys_decomp )<a name='219'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_108">( 'uflx_Cu'        , 'kg/m/s2' , pverp , 'A' , 'Convective  u flux'                                  , phys_decomp )<a name='220'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_109">( 'vflx_Cu'        , 'kg/m/s2' , pverp , 'A' , 'Convective  v flux'                                  , phys_decomp )<a name='221'>
<a name='222'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_110">( 'qtten_Cu'       , 'kg/kg/s' , pver  , 'A' , 'qt tendency by convection'                           , phys_decomp )<a name='223'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_111">( 'slten_Cu'       , 'J/kg/s'  , pver  , 'A' , 'sl tendency by convection'                           , phys_decomp )<a name='224'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_112">( 'uten_Cu'        , 'm/s2'    , pver  , 'A' , ' u tendency by convection'                           , phys_decomp )<a name='225'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_113">( 'vten_Cu'        , 'm/s2'    , pver  , 'A' , ' v tendency by convection'                           , phys_decomp )<a name='226'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_114">( 'qvten_Cu'       , 'kg/kg/s' , pver  , 'A' , 'qv tendency by convection'                           , phys_decomp )<a name='227'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_115">( 'qlten_Cu'       , 'kg/kg/s' , pver  , 'A' , 'ql tendency by convection'                           , phys_decomp )<a name='228'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_116">( 'qiten_Cu'       , 'kg/kg/s' , pver  , 'A' , 'qi tendency by convection'                           , phys_decomp )<a name='229'>
<a name='230'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_117">( 'cbmf_Cu'        , 'kg/m2/s' , 1     , 'A' , 'Cumulus base mass flux'                              , phys_decomp )<a name='231'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_118">( 'ufrcinvbase_Cu' , 'fraction', 1     , 'A' , 'Cumulus fraction at PBL top'                         , phys_decomp ) <a name='232'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_119">( 'ufrclcl_Cu'     , 'fraction', 1     , 'A' , 'Cumulus fraction at LCL'                             , phys_decomp )<a name='233'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_120">( 'winvbase_Cu'    , 'm/s'     , 1     , 'A' , 'Cumulus vertical velocity at PBL top'                , phys_decomp )<a name='234'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_121">( 'wlcl_Cu'        , 'm/s'     , 1     , 'A' , 'Cumulus vertical velocity at LCL'                    , phys_decomp )<a name='235'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_122">( 'plcl_Cu'        , 'Pa'      , 1     , 'A' , 'LCL of source air'                                   , phys_decomp )<a name='236'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_123">( 'pinv_Cu'        , 'Pa'      , 1     , 'A' , 'PBL top pressure'                                    , phys_decomp )<a name='237'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_124">( 'plfc_Cu'        , 'Pa'      , 1     , 'A' , 'LFC of source air'                                   , phys_decomp )<a name='238'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_125">( 'pbup_Cu'        , 'Pa'      , 1     , 'A' , 'Highest interface level of positive cumulus buoyancy', phys_decomp )<a name='239'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_126">( 'ppen_Cu'        , 'Pa'      , 1     , 'A' , 'Highest level where cumulus w is 0'                  , phys_decomp )<a name='240'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_127">( 'qtsrc_Cu'       , 'kg/kg'   , 1     , 'A' , 'Cumulus source air qt'                               , phys_decomp )<a name='241'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_128">( 'thlsrc_Cu'      , 'K'       , 1     , 'A' , 'Cumulus source air thl'                              , phys_decomp )<a name='242'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_129">( 'thvlsrc_Cu'     , 'K'       , 1     , 'A' , 'Cumulus source air thvl'                             , phys_decomp )<a name='243'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_130">( 'emfkbup_Cu'     , 'kg/m2/s' , 1     , 'A' , 'Penetrative mass flux at kbup'                       , phys_decomp )<a name='244'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_131">( 'cin_Cu'         , 'J/kg'    , 1     , 'A' , 'CIN upto LFC'                                        , phys_decomp )<a name='245'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_132">( 'cinlcl_Cu'      , 'J/kg'    , 1     , 'A' , 'CIN upto LCL'                                        , phys_decomp )<a name='246'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_133">( 'cbmflimit_Cu'   , 'kg/m2/s' , 1     , 'A' , 'cbmflimiter'                                         , phys_decomp ) <a name='247'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_134">( 'tkeavg_Cu'      , 'm2/s2'   , 1     , 'A' , 'Average tke within PBL for convection scheme'        , phys_decomp ) <a name='248'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_135">( 'zinv_Cu'        , 'm'       , 1     , 'A' , 'PBL top height'                                      , phys_decomp )<a name='249'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_136">( 'rcwp_Cu'        , 'kg/m2'   , 1     , 'A' , 'Cumulus LWP+IWP'                                     , phys_decomp )<a name='250'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_137">( 'rlwp_Cu'        , 'kg/m2'   , 1     , 'A' , 'Cumulus LWP'                                         , phys_decomp )<a name='251'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_138">( 'riwp_Cu'        , 'kg/m2'   , 1     , 'A' , 'Cumulus IWP'                                         , phys_decomp )<a name='252'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_139">( 'tophgt_Cu'      , 'm'       , 1     , 'A' , 'Cumulus top height'                                  , phys_decomp )<a name='253'>
<a name='254'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_140">( 'wu_Cu'          , 'm/s'     , pverp , 'A' , 'Convective updraft vertical velocity'                , phys_decomp )<a name='255'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_141">( 'ufrc_Cu'        , 'fraction', pverp , 'A' , 'Convective updraft fractional area'                  , phys_decomp )<a name='256'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_142">( 'qtu_Cu'         , 'kg/kg'   , pverp , 'A' , 'Cumulus updraft qt'                                  , phys_decomp )<a name='257'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_143">( 'thlu_Cu'        , 'K'       , pverp , 'A' , 'Cumulus updraft thl'                                 , phys_decomp )<a name='258'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_144">( 'thvu_Cu'        , 'K'       , pverp , 'A' , 'Cumulus updraft thv'                                 , phys_decomp )<a name='259'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_145">( 'uu_Cu'          , 'm/s'     , pverp , 'A' , 'Cumulus updraft uwnd'                                , phys_decomp )<a name='260'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_146">( 'vu_Cu'          , 'm/s'     , pverp , 'A' , 'Cumulus updraft vwnd'                                , phys_decomp )<a name='261'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_147">( 'qtu_emf_Cu'     , 'kg/kg'   , pverp , 'A' , 'qt of penatratively entrained air'                   , phys_decomp )<a name='262'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_148">( 'thlu_emf_Cu'    , 'K'       , pverp , 'A' , 'thl of penatratively entrained air'                  , phys_decomp )<a name='263'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_149">( 'uu_emf_Cu'      , 'm/s'     , pverp , 'A' , 'uwnd of penatratively entrained air'                 , phys_decomp )<a name='264'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_150">( 'vu_emf_Cu'      , 'm/s'     , pverp , 'A' , 'vwnd of penatratively entrained air'                 , phys_decomp )<a name='265'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_151">( 'umf_Cu'         , 'kg/m2/s' , pverp , 'A' , 'Cumulus updraft mass flux'                           , phys_decomp )<a name='266'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_152">( 'uemf_Cu'        , 'kg/m2/s' , pverp , 'A' , 'Cumulus net ( updraft + entrainment ) mass flux'     , phys_decomp )<a name='267'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_153">( 'qcu_Cu'         , 'kg/kg'   , pver  , 'A' , 'Cumulus updraft LWC+IWC'                             , phys_decomp )<a name='268'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_154">( 'qlu_Cu'         , 'kg/kg'   , pver  , 'A' , 'Cumulus updraft LWC'                                 , phys_decomp )<a name='269'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_155">( 'qiu_Cu'         , 'kg/kg'   , pver  , 'A' , 'Cumulus updraft IWC'                                 , phys_decomp )<a name='270'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_156">( 'cufrc_Cu'       , 'fraction', pver  , 'A' , 'Cumulus cloud fraction'                              , phys_decomp )<a name='271'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_157">( 'fer_Cu'         , '1/m'     , pver  , 'A' , 'Cumulus lateral fractional entrainment rate'         , phys_decomp )<a name='272'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_158">( 'fdr_Cu'         , '1/m'     , pver  , 'A' , 'Cumulus lateral fractional detrainment Rate'         , phys_decomp )<a name='273'>
<a name='274'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_159">( 'dwten_Cu'       , 'kg/kg/s' , pver  , 'A' , 'Expellsion rate of cumulus cloud water to env.'      , phys_decomp )<a name='275'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_160">( 'diten_Cu'       , 'kg/kg/s' , pver  , 'A' , 'Expellsion rate of cumulus ice water to env.'        , phys_decomp )<a name='276'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_161">( 'qrten_Cu'       , 'kg/kg/s' , pver  , 'A' , 'Production rate of rain by cumulus'                  , phys_decomp )<a name='277'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_162">( 'qsten_Cu'       , 'kg/kg/s' , pver  , 'A' , 'Production rate of snow by cumulus'                  , phys_decomp )<a name='278'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_163">( 'flxrain_Cu'     , 'kg/m2/s' , pverp , 'A' , 'Rain flux induced by Cumulus'                        , phys_decomp )<a name='279'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_164">( 'flxsnow_Cu'     , 'kg/m2/s' , pverp , 'A' , 'Snow flux induced by Cumulus'                        , phys_decomp )<a name='280'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_165">( 'ntraprd_Cu'     , 'kg/kg/s' , pver  , 'A' , 'Net production rate of rain by Cumulus'              , phys_decomp )<a name='281'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_166">( 'ntsnprd_Cu'     , 'kg/kg/s' , pver  , 'A' , 'Net production rate of snow by Cumulus'              , phys_decomp )<a name='282'>
<a name='283'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_167">( 'excessu_Cu'     , 'no'      , pver  , 'A' , 'Updraft saturation excess'                           , phys_decomp )<a name='284'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_168">( 'excess0_Cu'     , 'no'      , pver  , 'A' , 'Environmental saturation excess'                     , phys_decomp )<a name='285'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_169">( 'xc_Cu'          , 'no'      , pver  , 'A' , 'Critical mixing ratio'                               , phys_decomp )<a name='286'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_170">( 'aquad_Cu'       , 'no'      , pver  , 'A' , 'aquad'                                               , phys_decomp )<a name='287'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_171">( 'bquad_Cu'       , 'no'      , pver  , 'A' , 'bquad'                                               , phys_decomp )<a name='288'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_172">( 'cquad_Cu'       , 'no'      , pver  , 'A' , 'cquad'                                               , phys_decomp )<a name='289'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_173">( 'bogbot_Cu'      , 'no'      , pver  , 'A' , 'Cloud buoyancy at the bottom interface'              , phys_decomp )<a name='290'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_174">( 'bogtop_Cu'      , 'no'      , pver  , 'A' , 'Cloud buoyancy at the top interface'                 , phys_decomp )<a name='291'>
<a name='292'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_175">('exit_UWCu_Cu'    , 'no'      , 1     , 'A' , 'exit_UWCu'                                           , phys_decomp ) <a name='293'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_176">('exit_conden_Cu'  , 'no'      , 1     , 'A' , 'exit_conden'                                         , phys_decomp ) <a name='294'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_177">('exit_klclmkx_Cu' , 'no'      , 1     , 'A' , 'exit_klclmkx'                                        , phys_decomp ) <a name='295'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_178">('exit_klfcmkx_Cu' , 'no'      , 1     , 'A' , 'exit_klfcmkx'                                        , phys_decomp ) <a name='296'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_179">('exit_ufrc_Cu'    , 'no'      , 1     , 'A' , 'exit_ufrc'                                           , phys_decomp ) <a name='297'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_180">('exit_wtw_Cu'     , 'no'      , 1     , 'A' , 'exit_wtw'                                            , phys_decomp ) <a name='298'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_181">('exit_drycore_Cu' , 'no'      , 1     , 'A' , 'exit_drycore'                                        , phys_decomp ) <a name='299'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_182">('exit_wu_Cu'      , 'no'      , 1     , 'A' , 'exit_wu'                                             , phys_decomp ) <a name='300'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_183">('exit_cufilter_Cu', 'no'      , 1     , 'A' , 'exit_cufilter'                                       , phys_decomp ) <a name='301'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_184">('exit_kinv1_Cu'   , 'no'      , 1     , 'A' , 'exit_kinv1'                                          , phys_decomp ) <a name='302'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_185">('exit_rei_Cu'     , 'no'      , 1     , 'A' , 'exit_rei'                                            , phys_decomp ) <a name='303'>
<a name='304'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_186">('limit_shcu_Cu'   , 'no'      , 1     , 'A' , 'limit_shcu'                                          , phys_decomp ) <a name='305'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_187">('limit_negcon_Cu' , 'no'      , 1     , 'A' , 'limit_negcon'                                        , phys_decomp ) <a name='306'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_188">('limit_ufrc_Cu'   , 'no'      , 1     , 'A' , 'limit_ufrc'                                          , phys_decomp ) <a name='307'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_189">('limit_ppen_Cu'   , 'no'      , 1     , 'A' , 'limit_ppen'                                          , phys_decomp ) <a name='308'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_190">('limit_emf_Cu'    , 'no'      , 1     , 'A' , 'limit_emf'                                           , phys_decomp ) <a name='309'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_191">('limit_cinlcl_Cu' , 'no'      , 1     , 'A' , 'limit_cinlcl'                                        , phys_decomp ) <a name='310'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_192">('limit_cin_Cu'    , 'no'      , 1     , 'A' , 'limit_cin'                                           , phys_decomp ) <a name='311'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_193">('limit_cbmf_Cu'   , 'no'      , 1     , 'A' , 'limit_cbmf'                                          , phys_decomp ) <a name='312'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_194">('limit_rei_Cu'    , 'no'      , 1     , 'A' , 'limit_rei'                                           , phys_decomp ) <a name='313'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_195">('ind_delcin_Cu'   , 'no'      , 1     , 'A' , 'ind_delcin'                                          , phys_decomp ) <a name='314'>
<a name='315'>
    if( kind .ne. r8 ) then<a name='316'>
        write(iulog,*) subname//': ERROR -- real KIND does not match internal specification.'<a name='317'>
#ifdef WRF_PORT<a name='318'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1052">(iulog)<a name='319'>
#endif<a name='320'>
        call <A href='../../html_code/phys/module_sf_clm.F.html#ENDRUN'>endrun</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENDRUN_157">(subname//': ERROR -- real KIND does not match internal specification.')<a name='321'>
    endif<a name='322'>
<a name='323'>
    xlv   = xlv_in<a name='324'>
    xlf   = xlf_in<a name='325'>
    xls   = xlv + xlf<a name='326'>
    cp    = cp_in<a name='327'>
    zvir  = zvir_in<a name='328'>
    r     = r_in<a name='329'>
    g     = g_in<a name='330'>
    ep2   = ep2_in<a name='331'>
    p00   = 1.e5_r8<a name='332'>
    rovcp = r/cp<a name='333'>
<a name='334'>
    if (rpen == unset_r8) then<a name='335'>
       call <A href='../../html_code/phys/module_sf_clm.F.html#ENDRUN'>endrun</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENDRUN_158">(subname//': uwshcu_rpen must be set in the namelist')<a name='336'>
    end if<a name='337'>
<a name='338'>
    if ( masterproc ) then <a name='339'>
       write(iulog,*) subname//': tuning parameters: rpen=',rpen<a name='340'>
#ifdef WRF_PORT<a name='341'>
       call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#INIT_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_840">(1,iulog)<a name='342'>
#endif<a name='343'>
    endif<a name='344'>
<a name='345'>
#ifdef WRF_PORT<a name='346'>
    <font color=#447700>!<a name='347'></font>
    <font color=#447700>! Set initial values for WRF arrays dependent on restart conditions<a name='348'></font>
    <font color=#447700>!<a name='349'></font>
    if(.not.restart)then<a name='350'>
       do j=jts,jtf<a name='351'>
          do k=kts,ktf<a name='352'>
             do i=its,itf<a name='353'>
                rushten(i,k,j)  = 0.<a name='354'>
                rvshten(i,k,j)  = 0.<a name='355'>
                rthshten(i,k,j) = 0.<a name='356'>
                rqvshten(i,k,j) = 0.<a name='357'>
                if( p_qc &gt; param_first_scalar ) rqcshten(i,k,j) = 0.<a name='358'>
                if( p_qr &gt; param_first_scalar ) rqrshten(i,k,j) = 0.<a name='359'>
                if( p_qi &gt; param_first_scalar ) rqishten(i,k,j) = 0.<a name='360'>
                if( p_qs &gt; param_first_scalar ) rqsshten(i,k,j) = 0.<a name='361'>
                if( p_qg &gt; param_first_scalar ) rqgshten(i,k,j) = 0.<a name='362'>
             enddo<a name='363'>
          enddo<a name='364'>
       enddo<a name='365'>
    end if   <a name='366'>
#endif<a name='367'>
<a name='368'>
  end subroutine init_uwshcu<a name='369'>
<a name='370'>
<A NAME='COMPUTE_UWSHCU_INV'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU_INV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='371'>
  <font color=#993300>subroutine </font><font color=#cc0000>compute_uwshcu_inv</font>( mix      , mkx        , iend          , ncnst     , dt       ,  &amp;  <A href='../../call_to/COMPUTE_UWSHCU_INV.html' TARGET='index'>1</A>,<A href='../../call_from/COMPUTE_UWSHCU_INV.html' TARGET='index'>1</A><a name='372'>
                                 ps0_inv  , zs0_inv    , p0_inv        , z0_inv    , dp0_inv  ,  &amp;<a name='373'>
                                 u0_inv   , v0_inv     , qv0_inv       , ql0_inv   , qi0_inv  ,  &amp;<a name='374'>
                                 t0_inv   , s0_inv     , tr0_inv       ,                         &amp;<a name='375'>
                                 tke_inv  , cldfrct_inv, concldfrct_inv, pblh      , cush     ,  &amp; <a name='376'>
                                 umf_inv  , slflx_inv  , qtflx_inv     ,                         &amp; <a name='377'>
                                 flxprc1_inv, flxsnow1_inv,     				 &amp;<a name='378'>
                                 qvten_inv, qlten_inv  , qiten_inv     ,                         &amp;<a name='379'>
                                 sten_inv , uten_inv   , vten_inv      , trten_inv ,             &amp;  <a name='380'>
                                 qrten_inv, qsten_inv  , precip        , snow      , evapc_inv,  &amp;<a name='381'>
                                 cufrc_inv, qcu_inv    , qlu_inv       , qiu_inv   ,             &amp;   <a name='382'>
                                 cbmf     , qc_inv     , rliq          ,                         &amp;<a name='383'>
                                 cnt_inv  , cnb_inv    , qsat          , lchnk     , dpdry0_inv )<a name='384'>
<a name='385'>
    implicit none<a name='386'>
    integer , intent(in)    :: lchnk     <a name='387'>
    integer , intent(in)    :: mix<a name='388'>
    integer , intent(in)    :: mkx<a name='389'>
    integer , intent(in)    :: iend<a name='390'>
    integer , intent(in)    :: ncnst<a name='391'>
    real(r8), intent(in)    :: dt                       <font color=#447700>!  Time step : 2*delta_t [ s ]<a name='392'></font>
    real(r8), intent(in)    :: ps0_inv(mix,mkx+1)       <font color=#447700>!  Environmental pressure at the interfaces [ Pa ]<a name='393'></font>
    real(r8), intent(in)    :: zs0_inv(mix,mkx+1)       <font color=#447700>!  Environmental height at the interfaces   [ m ]<a name='394'></font>
    real(r8), intent(in)    :: p0_inv(mix,mkx)          <font color=#447700>!  Environmental pressure at the layer mid-point [ Pa ]<a name='395'></font>
    real(r8), intent(in)    :: z0_inv(mix,mkx)          <font color=#447700>!  Environmental height at the layer mid-point [ m ]<a name='396'></font>
    real(r8), intent(in)    :: dp0_inv(mix,mkx)         <font color=#447700>!  Environmental layer pressure thickness [ Pa ] &gt; 0.<a name='397'></font>
    real(r8), intent(in)    :: dpdry0_inv(mix,mkx)      <font color=#447700>!  Environmental dry layer pressure thickness [ Pa ]<a name='398'></font>
    real(r8), intent(in)    :: u0_inv(mix,mkx)          <font color=#447700>!  Environmental zonal wind [ m/s ]<a name='399'></font>
    real(r8), intent(in)    :: v0_inv(mix,mkx)          <font color=#447700>!  Environmental meridional wind [ m/s ]<a name='400'></font>
    real(r8), intent(in)    :: qv0_inv(mix,mkx)         <font color=#447700>!  Environmental water vapor specific humidity [ kg/kg ]<a name='401'></font>
    real(r8), intent(in)    :: ql0_inv(mix,mkx)         <font color=#447700>!  Environmental liquid water specific humidity [ kg/kg ]<a name='402'></font>
    real(r8), intent(in)    :: qi0_inv(mix,mkx)         <font color=#447700>!  Environmental ice specific humidity [ kg/kg ]<a name='403'></font>
    real(r8), intent(in)    :: t0_inv(mix,mkx)          <font color=#447700>!  Environmental temperature [ K ]<a name='404'></font>
    real(r8), intent(in)    :: s0_inv(mix,mkx)          <font color=#447700>!  Environmental dry static energy [ J/kg ]<a name='405'></font>
    real(r8), intent(in)    :: tr0_inv(mix,mkx,ncnst)   <font color=#447700>!  Environmental tracers [ #, kg/kg ]<a name='406'></font>
    real(r8), intent(in)    :: tke_inv(mix,mkx+1)       <font color=#447700>!  Turbulent kinetic energy at the interfaces [ m2/s2 ]<a name='407'></font>
    real(r8), intent(in)    :: cldfrct_inv(mix,mkx)     <font color=#447700>!  Total cloud fraction at the previous time step [ fraction ]<a name='408'></font>
    real(r8), intent(in)    :: concldfrct_inv(mix,mkx)  <font color=#447700>!  Total convective ( shallow + deep ) cloud fraction at the previous time step [ fraction ]<a name='409'></font>
    real(r8), intent(in)    :: pblh(mix)                <font color=#447700>!  Height of PBL [ m ]<a name='410'></font>
    real(r8), intent(inout) :: cush(mix)                <font color=#447700>!  Convective scale height [ m ]<a name='411'></font>
    real(r8), intent(out)   :: umf_inv(mix,mkx+1)       <font color=#447700>!  Updraft mass flux at the interfaces [ kg/m2/s ]<a name='412'></font>
    real(r8), intent(out)   :: qvten_inv(mix,mkx)       <font color=#447700>!  Tendency of water vapor specific humidity [ kg/kg/s ]<a name='413'></font>
    real(r8), intent(out)   :: qlten_inv(mix,mkx)       <font color=#447700>!  Tendency of liquid water specific humidity [ kg/kg/s ]<a name='414'></font>
    real(r8), intent(out)   :: qiten_inv(mix,mkx)       <font color=#447700>!  Tendency of ice specific humidity [ kg/kg/s ]<a name='415'></font>
    real(r8), intent(out)   :: sten_inv(mix,mkx)        <font color=#447700>!  Tendency of dry static energy [ J/kg/s ]<a name='416'></font>
    real(r8), intent(out)   :: uten_inv(mix,mkx)        <font color=#447700>!  Tendency of zonal wind [ m/s2 ]<a name='417'></font>
    real(r8), intent(out)   :: vten_inv(mix,mkx)        <font color=#447700>!  Tendency of meridional wind [ m/s2 ]<a name='418'></font>
    real(r8), intent(out)   :: trten_inv(mix,mkx,ncnst) <font color=#447700>!  Tendency of tracers [ #/s, kg/kg/s ]<a name='419'></font>
    real(r8), intent(out)   :: qrten_inv(mix,mkx)       <font color=#447700>!  Tendency of rain water specific humidity [ kg/kg/s ]<a name='420'></font>
    real(r8), intent(out)   :: qsten_inv(mix,mkx)       <font color=#447700>!  Tendency of snow specific humidity [ kg/kg/s ]<a name='421'></font>
    real(r8), intent(out)   :: precip(mix)              <font color=#447700>!  Precipitation ( rain + snow ) flux at the surface [ m/s ]<a name='422'></font>
    real(r8), intent(out)   :: snow(mix)                <font color=#447700>!  Snow flux at the surface [ m/s ]<a name='423'></font>
    real(r8), intent(out)   :: evapc_inv(mix,mkx)       <font color=#447700>!  Evaporation of precipitation [ kg/kg/s ]<a name='424'></font>
    real(r8), intent(out)   :: rliq(mix)                <font color=#447700>!  Vertical integral of tendency of detrained cloud condensate qc [ m/s ]<a name='425'></font>
    real(r8), intent(out)   :: slflx_inv(mix,mkx+1)     <font color=#447700>!  Updraft liquid static energy flux [ J/kg * kg/m2/s ]<a name='426'></font>
    real(r8), intent(out)   :: qtflx_inv(mix,mkx+1)     <font color=#447700>!  Updraft total water flux [ kg/kg * kg/m2/s ]<a name='427'></font>
    real(r8), intent(out)   :: flxprc1_inv(mix,mkx+1)   <font color=#447700>! uw grid-box mean rain+snow flux (kg m^-2 s^-1) for physics buffer calls in convect_shallow.F90<a name='428'></font>
    real(r8), intent(out)   :: flxsnow1_inv(mix,mkx+1)  <font color=#447700>! uw grid-box mean snow flux (kg m^-2 s^-1) for physics buffer calls in convect_shallow.F90<a name='429'></font>
<a name='430'>
    real(r8), intent(out)   :: cufrc_inv(mix,mkx)       <font color=#447700>!  Shallow cumulus cloud fraction at the layer mid-point [ fraction ]<a name='431'></font>
    real(r8), intent(out)   :: qcu_inv(mix,mkx)         <font color=#447700>!  Liquid+ice specific humidity within cumulus updraft [ kg/kg ]<a name='432'></font>
    real(r8), intent(out)   :: qlu_inv(mix,mkx)         <font color=#447700>!  Liquid water specific humidity within cumulus updraft [ kg/kg ]<a name='433'></font>
    real(r8), intent(out)   :: qiu_inv(mix,mkx)         <font color=#447700>!  Ice specific humidity within cumulus updraft [ kg/kg ]<a name='434'></font>
    real(r8), intent(out)   :: qc_inv(mix,mkx)          <font color=#447700>!  Tendency of cumulus condensate detrained into the environment [ kg/kg/s ]<a name='435'></font>
    real(r8), intent(out)   :: cbmf(mix)                <font color=#447700>!  Cumulus base mass flux [ kg/m2/s ]<a name='436'></font>
    real(r8), intent(out)   :: cnt_inv(mix)             <font color=#447700>!  Cumulus top  interface index, cnt = kpen [ no ]<a name='437'></font>
    real(r8), intent(out)   :: cnb_inv(mix)             <font color=#447700>!  Cumulus base interface index, cnb = krel - 1 [ no ]<a name='438'></font>
    integer , external      :: qsat                     <font color=#447700>!  Function pointer to sat vap pressure function<a name='439'></font>
<a name='440'>
    real(r8)                :: ps0(mix,0:mkx)           <font color=#447700>!  Environmental pressure at the interfaces [ Pa ]<a name='441'></font>
    real(r8)                :: zs0(mix,0:mkx)           <font color=#447700>!  Environmental height at the interfaces   [ m ]<a name='442'></font>
    real(r8)                :: p0(mix,mkx)              <font color=#447700>!  Environmental pressure at the layer mid-point [ Pa ]<a name='443'></font>
    real(r8)                :: z0(mix,mkx)              <font color=#447700>!  Environmental height at the layer mid-point [ m ]<a name='444'></font>
    real(r8)                :: dp0(mix,mkx)             <font color=#447700>!  Environmental layer pressure thickness [ Pa ] &gt; 0.<a name='445'></font>
    real(r8)                :: dpdry0(mix,mkx)          <font color=#447700>!  Environmental dry layer pressure thickness [ Pa ]<a name='446'></font>
    real(r8)                :: u0(mix,mkx)              <font color=#447700>!  Environmental zonal wind [ m/s ]<a name='447'></font>
    real(r8)                :: v0(mix,mkx)              <font color=#447700>!  Environmental meridional wind [ m/s ]<a name='448'></font>
    real(r8)                :: tke(mix,0:mkx)           <font color=#447700>!  Turbulent kinetic energy at the interfaces [ m2/s2 ]<a name='449'></font>
    real(r8)                :: cldfrct(mix,mkx)         <font color=#447700>!  Total cloud fraction at the previous time step [ fraction ]<a name='450'></font>
    real(r8)                :: concldfrct(mix,mkx)      <font color=#447700>!  Total convective ( shallow + deep ) cloud fraction at the previous time step [ fraction ]<a name='451'></font>
    real(r8)                :: qv0(mix,mkx)             <font color=#447700>!  Environmental water vapor specific humidity [ kg/kg ]<a name='452'></font>
    real(r8)                :: ql0(mix,mkx)             <font color=#447700>!  Environmental liquid water specific humidity [ kg/kg ]<a name='453'></font>
    real(r8)                :: qi0(mix,mkx)             <font color=#447700>!  Environmental ice specific humidity [ kg/kg ]<a name='454'></font>
    real(r8)                :: t0(mix,mkx)              <font color=#447700>!  Environmental temperature [ K ]<a name='455'></font>
    real(r8)                :: s0(mix,mkx)              <font color=#447700>!  Environmental dry static energy [ J/kg ]<a name='456'></font>
    real(r8)                :: tr0(mix,mkx,ncnst)       <font color=#447700>!  Environmental tracers [ #, kg/kg ]<a name='457'></font>
    real(r8)                :: umf(mix,0:mkx)           <font color=#447700>!  Updraft mass flux at the interfaces [ kg/m2/s ]<a name='458'></font>
    real(r8)                :: qvten(mix,mkx)           <font color=#447700>!  Tendency of water vapor specific humidity [ kg/kg/s ]<a name='459'></font>
    real(r8)                :: qlten(mix,mkx)           <font color=#447700>!  Tendency of liquid water specific humidity [ kg/kg/s ]<a name='460'></font>
    real(r8)                :: qiten(mix,mkx)           <font color=#447700>!  tendency of ice specific humidity [ kg/kg/s ]<a name='461'></font>
    real(r8)                :: sten(mix,mkx)            <font color=#447700>!  Tendency of static energy [ J/kg/s ]<a name='462'></font>
    real(r8)                :: uten(mix,mkx)            <font color=#447700>!  Tendency of zonal wind [ m/s2 ]<a name='463'></font>
    real(r8)                :: vten(mix,mkx)            <font color=#447700>!  Tendency of meridional wind [ m/s2 ]<a name='464'></font>
    real(r8)                :: trten(mix,mkx,ncnst)     <font color=#447700>!  Tendency of tracers [ #/s, kg/kg/s ]<a name='465'></font>
    real(r8)                :: qrten(mix,mkx)           <font color=#447700>!  Tendency of rain water specific humidity [ kg/kg/s ]<a name='466'></font>
    real(r8)                :: qsten(mix,mkx)           <font color=#447700>!  Tendency of snow speficif humidity [ kg/kg/s ]<a name='467'></font>
    real(r8)                :: evapc(mix,mkx)           <font color=#447700>!  Tendency of evaporation of precipitation [ kg/kg/s ]<a name='468'></font>
    real(r8)                :: slflx(mix,0:mkx)         <font color=#447700>!  Updraft liquid static energy flux [ J/kg * kg/m2/s ]<a name='469'></font>
    real(r8)                :: qtflx(mix,0:mkx)         <font color=#447700>!  Updraft total water flux [ kg/kg * kg/m2/s ]<a name='470'></font>
    real(r8)                :: flxprc1(mix,0:mkx)       <font color=#447700>! uw grid-box mean rain+snow flux (kg m^-2 s^-1) for physics buffer calls in convect_shallow.F90<a name='471'></font>
    real(r8)                :: flxsnow1(mix,0:mkx)      <font color=#447700>! uw grid-box mean snow flux (kg m^-2 s^-1) for physics buffer calls in convect_shallow.F90<a name='472'></font>
    real(r8)                :: cufrc(mix,mkx)           <font color=#447700>!  Shallow cumulus cloud fraction at the layer mid-point [ fraction ]<a name='473'></font>
    real(r8)                :: qcu(mix,mkx)             <font color=#447700>!  Condensate water specific humidity within cumulus updraft at the layer mid-point [ kg/kg ]<a name='474'></font>
    real(r8)                :: qlu(mix,mkx)             <font color=#447700>!  Liquid water specific humidity within cumulus updraft at the layer mid-point [ kg/kg ]<a name='475'></font>
    real(r8)                :: qiu(mix,mkx)             <font color=#447700>!  Ice specific humidity within cumulus updraft at the layer mid-point [ kg/kg ]<a name='476'></font>
    real(r8)                :: qc(mix,mkx)              <font color=#447700>!  Tendency of cumulus condensate detrained into the environment [ kg/kg/s ]<a name='477'></font>
    real(r8)                :: cnt(mix)                 <font color=#447700>!  Cumulus top  interface index, cnt = kpen [ no ]<a name='478'></font>
    real(r8)                :: cnb(mix)                 <font color=#447700>!  Cumulus base interface index, cnb = krel - 1 [ no ] <a name='479'></font>
    integer                 :: k                        <font color=#447700>!  Vertical index for local fields [ no ] <a name='480'></font>
    integer                 :: k_inv                    <font color=#447700>!  Vertical index for incoming fields [ no ]<a name='481'></font>
    integer                 :: m                        <font color=#447700>!  Tracer index [ no ]<a name='482'></font>
<a name='483'>
    do k = 1, mkx<a name='484'>
       k_inv               = mkx + 1 - k<a name='485'>
       p0(:iend,k)         = p0_inv(:iend,k_inv)<a name='486'>
       u0(:iend,k)         = u0_inv(:iend,k_inv)<a name='487'>
       v0(:iend,k)         = v0_inv(:iend,k_inv)<a name='488'>
       z0(:iend,k)         = z0_inv(:iend,k_inv)<a name='489'>
       dp0(:iend,k)        = dp0_inv(:iend,k_inv)<a name='490'>
       dpdry0(:iend,k)     = dpdry0_inv(:iend,k_inv)<a name='491'>
       qv0(:iend,k)        = qv0_inv(:iend,k_inv)<a name='492'>
       ql0(:iend,k)        = ql0_inv(:iend,k_inv)<a name='493'>
       qi0(:iend,k)        = qi0_inv(:iend,k_inv)<a name='494'>
       t0(:iend,k)         = t0_inv(:iend,k_inv)<a name='495'>
       s0(:iend,k)         = s0_inv(:iend,k_inv)<a name='496'>
       cldfrct(:iend,k)    = cldfrct_inv(:iend,k_inv)<a name='497'>
       concldfrct(:iend,k) = concldfrct_inv(:iend,k_inv)<a name='498'>
       do m = 1, ncnst<a name='499'>
          tr0(:iend,k,m)   = tr0_inv(:iend,k_inv,m)<a name='500'>
       enddo<a name='501'>
    enddo<a name='502'>
    <a name='503'>
    do k = 0, mkx<a name='504'>
       k_inv               = mkx + 1 - k<a name='505'>
       ps0(:iend,k)        = ps0_inv(:iend,k_inv)<a name='506'>
       zs0(:iend,k)        = zs0_inv(:iend,k_inv)<a name='507'>
       tke(:iend,k)        = tke_inv(:iend,k_inv)<a name='508'>
    end do<a name='509'>
<a name='510'>
    call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU'>compute_uwshcu</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU_INV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_UWSHCU_1">( mix  , mkx    , iend      , ncnst , dt   , &amp;<a name='511'>
                         ps0  , zs0    , p0        , z0    , dp0  , &amp;<a name='512'>
                         u0   , v0     , qv0       , ql0   , qi0  , &amp; <a name='513'>
                         t0   , s0     , tr0       ,                &amp; <a name='514'>
                         tke  , cldfrct, concldfrct, pblh  , cush , &amp; <a name='515'>
                         umf  , slflx  , qtflx     ,                &amp;  <a name='516'>
                         flxprc1  , flxsnow1  ,		            &amp;<a name='517'>
                         qvten, qlten  , qiten     ,                &amp; <a name='518'>
                         sten , uten   , vten      , trten ,        &amp;<a name='519'>
                         qrten, qsten  , precip    , snow  , evapc, &amp;<a name='520'>
                         cufrc, qcu    , qlu       , qiu   ,        &amp;<a name='521'>
                         cbmf , qc     , rliq      ,                &amp;<a name='522'>
                         cnt  , cnb    , qsat      , lchnk , dpdry0 )<a name='523'>
<a name='524'>
    <font color=#447700>! Reverse cloud top/base interface indices<a name='525'></font>
<a name='526'>
       cnt_inv(:iend) = mkx + 1 - cnt(:iend)<a name='527'>
       cnb_inv(:iend) = mkx + 1 - cnb(:iend)<a name='528'>
<a name='529'>
    do k = 0, mkx<a name='530'>
       k_inv                  = mkx + 1 - k<a name='531'>
       umf_inv(:iend,k_inv)   = umf(:iend,k)       <a name='532'>
       slflx_inv(:iend,k_inv) = slflx(:iend,k)     <a name='533'>
       qtflx_inv(:iend,k_inv) = qtflx(:iend,k)<a name='534'>
       flxprc1_inv(:iend,k_inv) = flxprc1(:iend,k)     <font color=#447700>! reversed for output to cam<a name='535'></font>
       flxsnow1_inv(:iend,k_inv) = flxsnow1(:iend,k)   <font color=#447700>! ""<a name='536'></font>
    end do<a name='537'>
<a name='538'>
    do k = 1, mkx<a name='539'>
       k_inv                         = mkx + 1 - k<a name='540'>
       qvten_inv(:iend,k_inv)        = qvten(:iend,k)   <a name='541'>
       qlten_inv(:iend,k_inv)        = qlten(:iend,k)   <a name='542'>
       qiten_inv(:iend,k_inv)        = qiten(:iend,k)   <a name='543'>
       sten_inv(:iend,k_inv)         = sten(:iend,k)    <a name='544'>
       uten_inv(:iend,k_inv)         = uten(:iend,k)    <a name='545'>
       vten_inv(:iend,k_inv)         = vten(:iend,k)    <a name='546'>
       qrten_inv(:iend,k_inv)        = qrten(:iend,k)   <a name='547'>
       qsten_inv(:iend,k_inv)        = qsten(:iend,k)   <a name='548'>
       evapc_inv(:iend,k_inv)        = evapc(:iend,k)<a name='549'>
       cufrc_inv(:iend,k_inv)        = cufrc(:iend,k)   <a name='550'>
       qcu_inv(:iend,k_inv)          = qcu(:iend,k)     <a name='551'>
       qlu_inv(:iend,k_inv)          = qlu(:iend,k)     <a name='552'>
       qiu_inv(:iend,k_inv)          = qiu(:iend,k)     <a name='553'>
       qc_inv(:iend,k_inv)           = qc(:iend,k)      <a name='554'>
       do m = 1, ncnst<a name='555'>
          trten_inv(:iend,k_inv,m)   = trten(:iend,k,m) <a name='556'>
       enddo<a name='557'>
<a name='558'>
    enddo<a name='559'>
<a name='560'>
  end subroutine compute_uwshcu_inv<a name='561'>
<a name='562'>
<A NAME='COMPUTE_UWSHCU'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='563'>
  <font color=#993300>subroutine </font><font color=#cc0000>compute_uwshcu</font>( mix      , mkx       , iend         , ncnst    , dt        , &amp; <A href='../../call_to/COMPUTE_UWSHCU.html' TARGET='index'>1</A>,<A href='../../call_from/COMPUTE_UWSHCU.html' TARGET='index'>157</A><a name='564'>
                             ps0_in   , zs0_in    , p0_in        , z0_in    , dp0_in    , &amp;<a name='565'>
                             u0_in    , v0_in     , qv0_in       , ql0_in   , qi0_in    , &amp;<a name='566'>
                             t0_in    , s0_in     , tr0_in       ,                        &amp;<a name='567'>
                             tke_in   , cldfrct_in, concldfrct_in,  pblh_in , cush_inout, &amp; <a name='568'>
                             umf_out  , slflx_out , qtflx_out    ,                        &amp;<a name='569'>
                             flxprc1_out  , flxsnow1_out  , 			 	  &amp;<a name='570'>
                             qvten_out, qlten_out , qiten_out    ,                        &amp; <a name='571'>
                             sten_out , uten_out  , vten_out     , trten_out,             &amp;<a name='572'>
                             qrten_out, qsten_out , precip_out   , snow_out , evapc_out , &amp;<a name='573'>
                             cufrc_out, qcu_out   , qlu_out      , qiu_out  ,             &amp;<a name='574'>
                             cbmf_out , qc_out    , rliq_out     ,                        &amp;<a name='575'>
                             cnt_out  , cnb_out   , qsat         , lchnk    , dpdry0_in )<a name='576'>
<a name='577'>
    <font color=#447700>! ------------------------------------------------------------ !<a name='578'></font>
    <font color=#447700>!                                                              !  <a name='579'></font>
    <font color=#447700>!  University of Washington Shallow Convection Scheme          !<a name='580'></font>
    <font color=#447700>!                                                              !<a name='581'></font>
    <font color=#447700>!  Described in Park and Bretherton. 2008. J. Climate :        !<a name='582'></font>
    <font color=#447700>!                                                              !<a name='583'></font>
    <font color=#447700>! 'The University of Washington shallow convection and         !<a name='584'></font>
    <font color=#447700>!  moist turbulent schemes and their impact on climate         !<a name='585'></font>
    <font color=#447700>!  simulations with the Community Atmosphere Model'            !<a name='586'></font>
    <font color=#447700>!                                                              !<a name='587'></font>
    <font color=#447700>!  Coded by Sungsu Park. Oct.2005.                             ! <a name='588'></font>
    <font color=#447700>!                        May.2008.                             !<a name='589'></font>
    <font color=#447700>!  For questions, send an email to sungsup@ucar.edu or         ! <a name='590'></font>
    <font color=#447700>!                                  sungsu@atmos.washington.edu !<a name='591'></font>
    <font color=#447700>!                                                              !<a name='592'></font>
    <font color=#447700>! ------------------------------------------------------------ !<a name='593'></font>
#ifndef WRF_PORT <a name='594'>
    use cam_history,     only : outfld, addfld, phys_decomp<a name='595'>
#else<a name='596'>
    use <A href='../../html_code/phys/module_cam_support.F.html#MODULE_CAM_SUPPORT'>module_cam_support</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CAM_SUPPORT_76">, only : outfld, addfld, phys_decomp<a name='597'>
#endif<a name='598'>
    use <A href='../../html_code/phys/module_cam_constituents.F.html#CONSTITUENTS'>constituents</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTITUENTS_22">,    only : qmin, cnst_get_type_byind, cnst_get_ind<a name='599'>
#ifdef MODAL_AERO<a name='600'>
    use <A href='../../html_code/phys/module_data_cam_mam_aero.F.html#MODAL_AERO_DATA'>modal_aero_data</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODAL_AERO_DATA_24">, only : ntot_amode, numptr_amode<a name='601'>
#endif<a name='602'>
<a name='603'>
    implicit none<a name='604'>
<a name='605'>
    <font color=#447700>! ---------------------- !<a name='606'></font>
    <font color=#447700>! Input-Output Variables !<a name='607'></font>
    <font color=#447700>! ---------------------- !<a name='608'></font>
<a name='609'>
    integer , intent(in)    :: lchnk<a name='610'>
    integer , intent(in)    :: mix<a name='611'>
    integer , intent(in)    :: mkx<a name='612'>
    integer , intent(in)    :: iend<a name='613'>
    integer , intent(in)    :: ncnst<a name='614'>
    real(r8), intent(in)    :: dt                             <font color=#447700>!  Time step : 2*delta_t [ s ]<a name='615'></font>
    real(r8), intent(in)    :: ps0_in(mix,0:mkx)              <font color=#447700>!  Environmental pressure at the interfaces [ Pa ]<a name='616'></font>
    real(r8), intent(in)    :: zs0_in(mix,0:mkx)              <font color=#447700>!  Environmental height at the interfaces [ m ]<a name='617'></font>
    real(r8), intent(in)    :: p0_in(mix,mkx)                 <font color=#447700>!  Environmental pressure at the layer mid-point [ Pa ]<a name='618'></font>
    real(r8), intent(in)    :: z0_in(mix,mkx)                 <font color=#447700>!  Environmental height at the layer mid-point [ m ]<a name='619'></font>
    real(r8), intent(in)    :: dp0_in(mix,mkx)                <font color=#447700>!  Environmental layer pressure thickness [ Pa ] &gt; 0.<a name='620'></font>
    real(r8), intent(in)    :: dpdry0_in(mix,mkx)             <font color=#447700>!  Environmental dry layer pressure thickness [ Pa ]<a name='621'></font>
    real(r8), intent(in)    :: u0_in(mix,mkx)                 <font color=#447700>!  Environmental zonal wind [ m/s ]<a name='622'></font>
    real(r8), intent(in)    :: v0_in(mix,mkx)                 <font color=#447700>!  Environmental meridional wind [ m/s ]<a name='623'></font>
    real(r8), intent(in)    :: qv0_in(mix,mkx)                <font color=#447700>!  Environmental water vapor specific humidity [ kg/kg ]<a name='624'></font>
    real(r8), intent(in)    :: ql0_in(mix,mkx)                <font color=#447700>!  Environmental liquid water specific humidity [ kg/kg ]<a name='625'></font>
    real(r8), intent(in)    :: qi0_in(mix,mkx)                <font color=#447700>!  Environmental ice specific humidity [ kg/kg ]<a name='626'></font>
    real(r8), intent(in)    :: t0_in(mix,mkx)                 <font color=#447700>!  Environmental temperature [ K ]<a name='627'></font>
    real(r8), intent(in)    :: s0_in(mix,mkx)                 <font color=#447700>!  Environmental dry static energy [ J/kg ]<a name='628'></font>
    real(r8), intent(in)    :: tr0_in(mix,mkx,ncnst)          <font color=#447700>!  Environmental tracers [ #, kg/kg ]<a name='629'></font>
    real(r8), intent(in)    :: tke_in(mix,0:mkx)              <font color=#447700>!  Turbulent kinetic energy at the interfaces [ m2/s2 ]<a name='630'></font>
    real(r8), intent(in)    :: cldfrct_in(mix,mkx)            <font color=#447700>!  Total cloud fraction at the previous time step [ fraction ]<a name='631'></font>
    real(r8), intent(in)    :: concldfrct_in(mix,mkx)         <font color=#447700>!  Total convective cloud fraction at the previous time step [ fraction ]<a name='632'></font>
    real(r8), intent(in)    :: pblh_in(mix)                   <font color=#447700>!  Height of PBL [ m ]<a name='633'></font>
    real(r8), intent(inout) :: cush_inout(mix)                <font color=#447700>!  Convective scale height [ m ]<a name='634'></font>
<a name='635'>
    real(r8)                   tw0_in(mix,mkx)                <font color=#447700>!  Wet bulb temperature [ K ]<a name='636'></font>
    real(r8)                   qw0_in(mix,mkx)                <font color=#447700>!  Wet-bulb specific humidity [ kg/kg ]<a name='637'></font>
<a name='638'>
    real(r8), intent(out)   :: umf_out(mix,0:mkx)             <font color=#447700>!  Updraft mass flux at the interfaces [ kg/m2/s ]<a name='639'></font>
    real(r8), intent(out)   :: qvten_out(mix,mkx)             <font color=#447700>!  Tendency of water vapor specific humidity [ kg/kg/s ]<a name='640'></font>
    real(r8), intent(out)   :: qlten_out(mix,mkx)             <font color=#447700>!  Tendency of liquid water specific humidity [ kg/kg/s ]<a name='641'></font>
    real(r8), intent(out)   :: qiten_out(mix,mkx)             <font color=#447700>!  Tendency of ice specific humidity [ kg/kg/s ]<a name='642'></font>
    real(r8), intent(out)   :: sten_out(mix,mkx)              <font color=#447700>!  Tendency of dry static energy [ J/kg/s ]<a name='643'></font>
    real(r8), intent(out)   :: uten_out(mix,mkx)              <font color=#447700>!  Tendency of zonal wind [ m/s2 ]<a name='644'></font>
    real(r8), intent(out)   :: vten_out(mix,mkx)              <font color=#447700>!  Tendency of meridional wind [ m/s2 ]<a name='645'></font>
    real(r8), intent(out)   :: trten_out(mix,mkx,ncnst)       <font color=#447700>!  Tendency of tracers [ #/s, kg/kg/s ]<a name='646'></font>
    real(r8), intent(out)   :: qrten_out(mix,mkx)             <font color=#447700>!  Tendency of rain water specific humidity [ kg/kg/s ]<a name='647'></font>
    real(r8), intent(out)   :: qsten_out(mix,mkx)             <font color=#447700>!  Tendency of snow specific humidity [ kg/kg/s ]<a name='648'></font>
    real(r8), intent(out)   :: precip_out(mix)                <font color=#447700>!  Precipitation ( rain + snow ) rate at surface [ m/s ]<a name='649'></font>
    real(r8), intent(out)   :: snow_out(mix)                  <font color=#447700>!  Snow rate at surface [ m/s ]<a name='650'></font>
    real(r8), intent(out)   :: evapc_out(mix,mkx)             <font color=#447700>!  Tendency of evaporation of precipitation [ kg/kg/s ]<a name='651'></font>
    real(r8), intent(out)   :: slflx_out(mix,0:mkx)           <font color=#447700>!  Updraft/pen.entrainment liquid static energy flux [ J/kg * kg/m2/s ]<a name='652'></font>
    real(r8), intent(out)   :: qtflx_out(mix,0:mkx)           <font color=#447700>!  updraft/pen.entrainment total water flux [ kg/kg * kg/m2/s ]<a name='653'></font>
    real(r8), intent(out)   :: flxprc1_out(mix,0:mkx)         <font color=#447700>! precip (rain+snow) flux<a name='654'></font>
    real(r8), intent(out)   :: flxsnow1_out(mix,0:mkx)        <font color=#447700>! snow flux<a name='655'></font>
    real(r8), intent(out)   :: cufrc_out(mix,mkx)             <font color=#447700>!  Shallow cumulus cloud fraction at the layer mid-point [ fraction ]<a name='656'></font>
    real(r8), intent(out)   :: qcu_out(mix,mkx)               <font color=#447700>!  Condensate water specific humidity within cumulus updraft [ kg/kg ]<a name='657'></font>
    real(r8), intent(out)   :: qlu_out(mix,mkx)               <font color=#447700>!  Liquid water specific humidity within cumulus updraft [ kg/kg ]<a name='658'></font>
    real(r8), intent(out)   :: qiu_out(mix,mkx)               <font color=#447700>!  Ice specific humidity within cumulus updraft [ kg/kg ]<a name='659'></font>
    real(r8), intent(out)   :: cbmf_out(mix)                  <font color=#447700>!  Cloud base mass flux [ kg/m2/s ]<a name='660'></font>
    real(r8), intent(out)   :: qc_out(mix,mkx)                <font color=#447700>!  Tendency of detrained cumulus condensate into the environment [ kg/kg/s ]<a name='661'></font>
    real(r8), intent(out)   :: rliq_out(mix)                  <font color=#447700>!  Vertical integral of qc_out [ m/s ]<a name='662'></font>
    real(r8), intent(out)   :: cnt_out(mix)                   <font color=#447700>!  Cumulus top  interface index, cnt = kpen [ no ]<a name='663'></font>
    real(r8), intent(out)   :: cnb_out(mix)                   <font color=#447700>!  Cumulus base interface index, cnb = krel - 1 [ no ] <a name='664'></font>
<a name='665'>
    <font color=#447700>!<a name='666'></font>
    <font color=#447700>! Internal Output Variables<a name='667'></font>
    <font color=#447700>!<a name='668'></font>
<a name='669'>
    integer , external      :: qsat <a name='670'>
    real(r8)                   qtten_out(mix,mkx)             <font color=#447700>!  Tendency of qt [ kg/kg/s ]<a name='671'></font>
    real(r8)                   slten_out(mix,mkx)             <font color=#447700>!  Tendency of sl [ J/kg/s ]<a name='672'></font>
    real(r8)                   ufrc_out(mix,0:mkx)            <font color=#447700>!  Updraft fractional area at the interfaces [ fraction ]<a name='673'></font>
    real(r8)                   uflx_out(mix,0:mkx)            <font color=#447700>!  Updraft/pen.entrainment zonal momentum flux [ m/s/m2/s ]<a name='674'></font>
    real(r8)                   vflx_out(mix,0:mkx)            <font color=#447700>!  Updraft/pen.entrainment meridional momentum flux [ m/s/m2/s ]<a name='675'></font>
    real(r8)                   fer_out(mix,mkx)               <font color=#447700>!  Fractional lateral entrainment rate [ 1/Pa ]<a name='676'></font>
    real(r8)                   fdr_out(mix,mkx)               <font color=#447700>!  Fractional lateral detrainment rate [ 1/Pa ]<a name='677'></font>
    real(r8)                   cinh_out(mix)                  <font color=#447700>!  Convective INhibition upto LFC (CIN) [ J/kg ]<a name='678'></font>
    real(r8)                   trflx_out(mix,0:mkx,ncnst)     <font color=#447700>!  Updraft/pen.entrainment tracer flux [ #/m2/s, kg/kg/m2/s ] <a name='679'></font>
   <a name='680'>
    <font color=#447700>! -------------------------------------------- !<a name='681'></font>
    <font color=#447700>! One-dimensional variables at each grid point !<a name='682'></font>
    <font color=#447700>! -------------------------------------------- !<a name='683'></font>
<a name='684'>
    <font color=#447700>! 1. Input variables<a name='685'></font>
<a name='686'>
    real(r8)    ps0(0:mkx)                                    <font color=#447700>!  Environmental pressure at the interfaces [ Pa ]<a name='687'></font>
    real(r8)    zs0(0:mkx)                                    <font color=#447700>!  Environmental height at the interfaces [ m ]<a name='688'></font>
    real(r8)    p0(mkx)                                       <font color=#447700>!  Environmental pressure at the layer mid-point [ Pa ]<a name='689'></font>
    real(r8)    z0(mkx)                                       <font color=#447700>!  Environmental height at the layer mid-point [ m ]<a name='690'></font>
    real(r8)    dp0(mkx)                                      <font color=#447700>!  Environmental layer pressure thickness [ Pa ] &gt; 0.<a name='691'></font>
    real(r8)    dpdry0(mkx)                                   <font color=#447700>!  Environmental dry layer pressure thickness [ Pa ]<a name='692'></font>
    real(r8)    u0(mkx)                                       <font color=#447700>!  Environmental zonal wind [ m/s ]<a name='693'></font>
    real(r8)    v0(mkx)                                       <font color=#447700>!  Environmental meridional wind [ m/s ]<a name='694'></font>
    real(r8)    tke(0:mkx)                                    <font color=#447700>!  Turbulent kinetic energy at the interfaces [ m2/s2 ]<a name='695'></font>
    real(r8)    cldfrct(mkx)                                  <font color=#447700>!  Total cloud fraction at the previous time step [ fraction ]<a name='696'></font>
    real(r8)    concldfrct(mkx)                               <font color=#447700>!  Total convective cloud fraction at the previous time step [ fraction ]<a name='697'></font>
    real(r8)    qv0(mkx)                                      <font color=#447700>!  Environmental water vapor specific humidity [ kg/kg ]<a name='698'></font>
    real(r8)    ql0(mkx)                                      <font color=#447700>!  Environmental liquid water specific humidity [ kg/kg ]<a name='699'></font>
    real(r8)    qi0(mkx)                                      <font color=#447700>!  Environmental ice specific humidity [ kg/kg ]<a name='700'></font>
    real(r8)    t0(mkx)                                       <font color=#447700>!  Environmental temperature [ K ]<a name='701'></font>
    real(r8)    s0(mkx)                                       <font color=#447700>!  Environmental dry static energy [ J/kg ]<a name='702'></font>
    real(r8)    pblh                                          <font color=#447700>!  Height of PBL [ m ]<a name='703'></font>
    real(r8)    cush                                          <font color=#447700>!  Convective scale height [ m ]<a name='704'></font>
    real(r8)    tr0(mkx,ncnst)                                <font color=#447700>!  Environmental tracers [ #, kg/kg ]<a name='705'></font>
<a name='706'>
    <font color=#447700>! 2. Environmental variables directly derived from the input variables<a name='707'></font>
<a name='708'>
    real(r8)    qt0(mkx)                                      <font color=#447700>!  Environmental total specific humidity [ kg/kg ]<a name='709'></font>
    real(r8)    thl0(mkx)                                     <font color=#447700>!  Environmental liquid potential temperature [ K ]<a name='710'></font>
    real(r8)    thvl0(mkx)                                    <font color=#447700>!  Environmental liquid virtual potential temperature [ K ]<a name='711'></font>
    real(r8)    ssqt0(mkx)                                    <font color=#447700>!  Linear internal slope of environmental total specific humidity [ kg/kg/Pa ]<a name='712'></font>
    real(r8)    ssthl0(mkx)                                   <font color=#447700>!  Linear internal slope of environmental liquid potential temperature [ K/Pa ]<a name='713'></font>
    real(r8)    ssu0(mkx)                                     <font color=#447700>!  Linear internal slope of environmental zonal wind [ m/s/Pa ]<a name='714'></font>
    real(r8)    ssv0(mkx)                                     <font color=#447700>!  Linear internal slope of environmental meridional wind [ m/s/Pa ]<a name='715'></font>
    real(r8)    thv0bot(mkx)                                  <font color=#447700>!  Environmental virtual potential temperature at the bottom of each layer [ K ]<a name='716'></font>
    real(r8)    thv0top(mkx)                                  <font color=#447700>!  Environmental virtual potential temperature at the top of each layer [ K ]<a name='717'></font>
    real(r8)    thvl0bot(mkx)                                 <font color=#447700>!  Environmental liquid virtual potential temperature at the bottom of each layer [ K ]<a name='718'></font>
    real(r8)    thvl0top(mkx)                                 <font color=#447700>!  Environmental liquid virtual potential temperature at the top of each layer [ K ]<a name='719'></font>
    real(r8)    exn0(mkx)                                     <font color=#447700>!  Exner function at the layer mid points [ no ]<a name='720'></font>
    real(r8)    exns0(0:mkx)                                  <font color=#447700>!  Exner function at the interfaces [ no ]<a name='721'></font>
    real(r8)    sstr0(mkx,ncnst)                              <font color=#447700>!  Linear slope of environmental tracers [ #/Pa, kg/kg/Pa ]<a name='722'></font>
<a name='723'>
   <font color=#447700>! 2-1. For preventing negative condensate at the provisional time step<a name='724'></font>
<a name='725'>
    real(r8)    qv0_star(mkx)                                 <font color=#447700>!  Environmental water vapor specific humidity [ kg/kg ]<a name='726'></font>
    real(r8)    ql0_star(mkx)                                 <font color=#447700>!  Environmental liquid water specific humidity [ kg/kg ]<a name='727'></font>
    real(r8)    qi0_star(mkx)                                 <font color=#447700>!  Environmental ice specific humidity [ kg/kg ]<a name='728'></font>
    real(r8)    t0_star(mkx)                                  <font color=#447700>!  Environmental temperature [ K ]<a name='729'></font>
    real(r8)    s0_star(mkx)                                  <font color=#447700>!  Environmental dry static energy [ J/kg ]<a name='730'></font>
<a name='731'>
   <font color=#447700>! 3. Variables associated with cumulus convection<a name='732'></font>
<a name='733'>
    real(r8)    umf(0:mkx)                                    <font color=#447700>!  Updraft mass flux at the interfaces [ kg/m2/s ]<a name='734'></font>
    real(r8)    emf(0:mkx)                                    <font color=#447700>!  Penetrative entrainment mass flux at the interfaces [ kg/m2/s ]<a name='735'></font>
    real(r8)    qvten(mkx)                                    <font color=#447700>!  Tendency of water vapor specific humidity [ kg/kg/s ]<a name='736'></font>
    real(r8)    qlten(mkx)                                    <font color=#447700>!  Tendency of liquid water specific humidity [ kg/kg/s ]<a name='737'></font>
    real(r8)    qiten(mkx)                                    <font color=#447700>!  Tendency of ice specific humidity [ kg/kg/s ]<a name='738'></font>
    real(r8)    sten(mkx)                                     <font color=#447700>!  Tendency of dry static energy [ J/kg ]<a name='739'></font>
    real(r8)    uten(mkx)                                     <font color=#447700>!  Tendency of zonal wind [ m/s2 ]<a name='740'></font>
    real(r8)    vten(mkx)                                     <font color=#447700>!  Tendency of meridional wind [ m/s2 ]<a name='741'></font>
    real(r8)    qrten(mkx)                                    <font color=#447700>!  Tendency of rain water specific humidity [ kg/kg/s ]<a name='742'></font>
    real(r8)    qsten(mkx)                                    <font color=#447700>!  Tendency of snow specific humidity [ kg/kg/s ]<a name='743'></font>
    real(r8)    precip                                        <font color=#447700>!  Precipitation rate ( rain + snow) at the surface [ m/s ]<a name='744'></font>
    real(r8)    snow                                          <font color=#447700>!  Snow rate at the surface [ m/s ]<a name='745'></font>
    real(r8)    evapc(mkx)                                    <font color=#447700>!  Tendency of evaporation of precipitation [ kg/kg/s ]<a name='746'></font>
    real(r8)    slflx(0:mkx)                                  <font color=#447700>!  Updraft/pen.entrainment liquid static energy flux [ J/kg * kg/m2/s ]<a name='747'></font>
    real(r8)    qtflx(0:mkx)                                  <font color=#447700>!  Updraft/pen.entrainment total water flux [ kg/kg * kg/m2/s ]<a name='748'></font>
    real(r8)    uflx(0:mkx)                                   <font color=#447700>!  Updraft/pen.entrainment flux of zonal momentum [ m/s/m2/s ]<a name='749'></font>
    real(r8)    vflx(0:mkx)                                   <font color=#447700>!  Updraft/pen.entrainment flux of meridional momentum [ m/s/m2/s ]<a name='750'></font>
    real(r8)    cufrc(mkx)                                    <font color=#447700>!  Shallow cumulus cloud fraction at the layer mid-point [ fraction ]<a name='751'></font>
    real(r8)    qcu(mkx)                                      <font color=#447700>!  Condensate water specific humidity within convective updraft [ kg/kg ]<a name='752'></font>
    real(r8)    qlu(mkx)                                      <font color=#447700>!  Liquid water specific humidity within convective updraft [ kg/kg ]<a name='753'></font>
    real(r8)    qiu(mkx)                                      <font color=#447700>!  Ice specific humidity within convective updraft [ kg/kg ]<a name='754'></font>
    real(r8)    dwten(mkx)                                    <font color=#447700>!  Detrained water tendency from cumulus updraft [ kg/kg/s ]<a name='755'></font>
    real(r8)    diten(mkx)                                    <font color=#447700>!  Detrained ice   tendency from cumulus updraft [ kg/kg/s ]<a name='756'></font>
    real(r8)    fer(mkx)                                      <font color=#447700>!  Fractional lateral entrainment rate [ 1/Pa ]<a name='757'></font>
    real(r8)    fdr(mkx)                                      <font color=#447700>!  Fractional lateral detrainment rate [ 1/Pa ]<a name='758'></font>
    real(r8)    uf(mkx)                                       <font color=#447700>!  Zonal wind at the provisional time step [ m/s ]<a name='759'></font>
    real(r8)    vf(mkx)                                       <font color=#447700>!  Meridional wind at the provisional time step [ m/s ]<a name='760'></font>
    real(r8)    qc(mkx)                                       <font color=#447700>!  Tendency due to detrained 'cloud water + cloud ice' (without rain-snow contribution) [ kg/kg/s ]<a name='761'></font>
    real(r8)    qc_l(mkx)                                     <font color=#447700>!  Tendency due to detrained 'cloud water' (without rain-snow contribution) [ kg/kg/s ]<a name='762'></font>
    real(r8)    qc_i(mkx)                                     <font color=#447700>!  Tendency due to detrained 'cloud ice' (without rain-snow contribution) [ kg/kg/s ]<a name='763'></font>
    real(r8)    qc_lm<a name='764'>
    real(r8)    qc_im<a name='765'>
    real(r8)    nc_lm<a name='766'>
    real(r8)    nc_im<a name='767'>
    real(r8)    ql_emf_kbup<a name='768'>
    real(r8)    qi_emf_kbup<a name='769'>
    real(r8)    nl_emf_kbup<a name='770'>
    real(r8)    ni_emf_kbup<a name='771'>
    real(r8)    qlten_det<a name='772'>
    real(r8)    qiten_det<a name='773'>
    real(r8)    rliq                                          <font color=#447700>!  Vertical integral of qc [ m/s ] <a name='774'></font>
    real(r8)    cnt                                           <font color=#447700>!  Cumulus top  interface index, cnt = kpen [ no ]<a name='775'></font>
    real(r8)    cnb                                           <font color=#447700>!  Cumulus base interface index, cnb = krel - 1 [ no ] <a name='776'></font>
    real(r8)    qtten(mkx)                                    <font color=#447700>!  Tendency of qt [ kg/kg/s ]<a name='777'></font>
    real(r8)    slten(mkx)                                    <font color=#447700>!  Tendency of sl [ J/kg/s ]<a name='778'></font>
    real(r8)    ufrc(0:mkx)                                   <font color=#447700>!  Updraft fractional area [ fraction ]<a name='779'></font>
    real(r8)    trten(mkx,ncnst)                              <font color=#447700>!  Tendency of tracers [ #/s, kg/kg/s ]<a name='780'></font>
    real(r8)    trflx(0:mkx,ncnst)                            <font color=#447700>!  Flux of tracers due to convection [ # * kg/m2/s, kg/kg * kg/m2/s ]<a name='781'></font>
    real(r8)    trflx_d(0:mkx)                                <font color=#447700>!  Adjustive downward flux of tracers to prevent negative tracers<a name='782'></font>
    real(r8)    trflx_u(0:mkx)                                <font color=#447700>!  Adjustive upward   flux of tracers to prevent negative tracers<a name='783'></font>
    real(r8)    trmin                                         <font color=#447700>!  Minimum concentration of tracers allowed<a name='784'></font>
    real(r8)    pdelx, dum <a name='785'>
    <a name='786'>
    <font color=#447700>!----- Variables used for the calculation of condensation sink associated with compensating subsidence<a name='787'></font>
    <font color=#447700>!      In the current code, this 'sink' tendency is simply set to be zero.<a name='788'></font>
<a name='789'>
    real(r8)    uemf(0:mkx)                                   <font color=#447700>!  Net updraft mass flux at the interface ( emf + umf ) [ kg/m2/s ]<a name='790'></font>
    real(r8)    comsub(mkx)                                   <font color=#447700>!  Compensating subsidence at the layer mid-point ( unit of mass flux, umf ) [ kg/m2/s ]<a name='791'></font>
    real(r8)    qlten_sink(mkx)                               <font color=#447700>!  Liquid condensate tendency by compensating subsidence/upwelling [ kg/kg/s ]<a name='792'></font>
    real(r8)    qiten_sink(mkx)                               <font color=#447700>!  Ice    condensate tendency by compensating subsidence/upwelling [ kg/kg/s ]<a name='793'></font>
    real(r8)    nlten_sink(mkx)                               <font color=#447700>!  Liquid droplets # tendency by compensating subsidence/upwelling [ kg/kg/s ]<a name='794'></font>
    real(r8)    niten_sink(mkx)                               <font color=#447700>!  Ice    droplets # tendency by compensating subsidence/upwelling [ kg/kg/s ]<a name='795'></font>
    real(r8)    thlten_sub, qtten_sub                         <font color=#447700>!  Tendency of conservative scalars by compensating subsidence/upwelling<a name='796'></font>
    real(r8)    qlten_sub, qiten_sub                          <font color=#447700>!  Tendency of ql0, qi0             by compensating subsidence/upwelling<a name='797'></font>
    real(r8)    nlten_sub, niten_sub                          <font color=#447700>!  Tendency of nl0, ni0             by compensating subsidence/upwelling<a name='798'></font>
    real(r8)    thl_prog, qt_prog                             <font color=#447700>!  Prognosed 'thl, qt' by compensating subsidence/upwelling <a name='799'></font>
<a name='800'>
    <font color=#447700>!----- Variables describing cumulus updraft<a name='801'></font>
<a name='802'>
    real(r8)    wu(0:mkx)                                     <font color=#447700>!  Updraft vertical velocity at the interface [ m/s ]<a name='803'></font>
    real(r8)    thlu(0:mkx)                                   <font color=#447700>!  Updraft liquid potential temperature at the interface [ K ]<a name='804'></font>
    real(r8)    qtu(0:mkx)                                    <font color=#447700>!  Updraft total specific humidity at the interface [ kg/kg ]<a name='805'></font>
    real(r8)    uu(0:mkx)                                     <font color=#447700>!  Updraft zonal wind at the interface [ m/s ]<a name='806'></font>
    real(r8)    vu(0:mkx)                                     <font color=#447700>!  Updraft meridional wind at the interface [ m/s ]<a name='807'></font>
    real(r8)    thvu(0:mkx)                                   <font color=#447700>!  Updraft virtual potential temperature at the interface [ m/s ]<a name='808'></font>
    real(r8)    rei(mkx)                                      <font color=#447700>!  Updraft fractional mixing rate with the environment [ 1/Pa ]<a name='809'></font>
    real(r8)    tru(0:mkx,ncnst)                              <font color=#447700>!  Updraft tracers [ #, kg/kg ]<a name='810'></font>
<a name='811'>
    <font color=#447700>!----- Variables describing conservative scalars of entraining downdrafts  at the <a name='812'></font>
    <font color=#447700>!      entraining interfaces, i.e., 'kbup &lt;= k &lt; kpen-1'. At the other interfaces,<a name='813'></font>
    <font color=#447700>!      belows are simply set to equal to those of updraft for simplicity - but it<a name='814'></font>
    <font color=#447700>!      does not influence numerical calculation.<a name='815'></font>
<a name='816'>
    real(r8)    thlu_emf(0:mkx)                               <font color=#447700>!  Penetrative downdraft liquid potential temperature at entraining interfaces [ K ]<a name='817'></font>
    real(r8)    qtu_emf(0:mkx)                                <font color=#447700>!  Penetrative downdraft total water at entraining interfaces [ kg/kg ]<a name='818'></font>
    real(r8)    uu_emf(0:mkx)                                 <font color=#447700>!  Penetrative downdraft zonal wind at entraining interfaces [ m/s ]<a name='819'></font>
    real(r8)    vu_emf(0:mkx)                                 <font color=#447700>!  Penetrative downdraft meridional wind at entraining interfaces [ m/s ]<a name='820'></font>
    real(r8)    tru_emf(0:mkx,ncnst)                          <font color=#447700>!  Penetrative Downdraft tracers at entraining interfaces [ #, kg/kg ]    <a name='821'></font>
<a name='822'>
    <font color=#447700>!----- Variables associated with evaporations of convective 'rain' and 'snow'<a name='823'></font>
<a name='824'>
    real(r8)    flxrain(0:mkx)                                <font color=#447700>!  Downward rain flux at each interface [ kg/m2/s ]<a name='825'></font>
    real(r8)    flxsnow(0:mkx)                                <font color=#447700>!  Downward snow flux at each interface [ kg/m2/s ]<a name='826'></font>
    real(r8)    ntraprd(mkx)                                  <font color=#447700>!  Net production ( production - evaporation +  melting ) rate of rain in each layer [ kg/kg/s ]<a name='827'></font>
    real(r8)    ntsnprd(mkx)                                  <font color=#447700>!  Net production ( production - evaporation + freezing ) rate of snow in each layer [ kg/kg/s ]<a name='828'></font>
    real(r8)    flxsntm                                       <font color=#447700>!  Downward snow flux at the top of each layer after melting [ kg/m2/s ]<a name='829'></font>
    real(r8)    snowmlt                                       <font color=#447700>!  Snow melting tendency [ kg/kg/s ]<a name='830'></font>
    real(r8)    subsat                                        <font color=#447700>!  Sub-saturation ratio (1-qv/qs) [ no unit ]<a name='831'></font>
    real(r8)    evprain                                       <font color=#447700>!  Evaporation rate of rain [ kg/kg/s ]<a name='832'></font>
    real(r8)    evpsnow                                       <font color=#447700>!  Evaporation rate of snow [ kg/kg/s ]<a name='833'></font>
    real(r8)    evplimit                                      <font color=#447700>!  Limiter of 'evprain + evpsnow' [ kg/kg/s ]<a name='834'></font>
    real(r8)    evplimit_rain                                 <font color=#447700>!  Limiter of 'evprain' [ kg/kg/s ]<a name='835'></font>
    real(r8)    evplimit_snow                                 <font color=#447700>!  Limiter of 'evpsnow' [ kg/kg/s ]<a name='836'></font>
    real(r8)    evpint_rain                                   <font color=#447700>!  Vertically-integrated evaporative flux of rain [ kg/m2/s ]<a name='837'></font>
    real(r8)    evpint_snow                                   <font color=#447700>!  Vertically-integrated evaporative flux of snow [ kg/m2/s ]<a name='838'></font>
    real(r8)    kevp                                          <font color=#447700>!  Evaporative efficiency [ complex unit ]<a name='839'></font>
<a name='840'>
    <font color=#447700>!----- Other internal variables<a name='841'></font>
<a name='842'>
    integer     kk, mm, k, i, m, kp1, km1<a name='843'>
    integer     iter_scaleh, iter_xc<a name='844'>
    integer     id_check, status<a name='845'>
    integer     klcl                                          <font color=#447700>!  Layer containing LCL of source air<a name='846'></font>
    integer     kinv                                          <font color=#447700>!  Inversion layer with PBL top interface as a lower interface<a name='847'></font>
    integer     krel                                          <font color=#447700>!  Release layer where buoyancy sorting mixing occurs for the first time<a name='848'></font>
    integer     klfc                                          <font color=#447700>!  LFC layer of cumulus source air<a name='849'></font>
    integer     kbup                                          <font color=#447700>!  Top layer in which cloud buoyancy is positive at the top interface<a name='850'></font>
    integer     kpen                                          <font color=#447700>!  Highest layer with positive updraft vertical velocity - top layer cumulus can reach<a name='851'></font>
    logical     id_exit   <a name='852'>
    logical     forcedCu                                      <font color=#447700>!  If 'true', cumulus updraft cannot overcome the buoyancy barrier just above the PBL top.<a name='853'></font>
    real(r8)    thlsrc, qtsrc, usrc, vsrc, thvlsrc            <font color=#447700>!  Updraft source air properties<a name='854'></font>
    real(r8)    PGFc, uplus, vplus<a name='855'>
    real(r8)    trsrc(ncnst), tre(ncnst)<a name='856'>
    real(r8)    plcl, plfc, prel, wrel<a name='857'>
    real(r8)    frc_rasn<a name='858'>
    real(r8)    ee2, ud2, wtw, wtwb, wtwh<a name='859'>
    real(r8)    xc, xc_2                                       <a name='860'>
    real(r8)    cldhgt, scaleh, tscaleh, cridis, rle, rkm<a name='861'>
    real(r8)    rkfre, sigmaw, epsvarw, tkeavg, dpsum, dpi, thvlmin<a name='862'>
    real(r8)    thlxsat, qtxsat, thvxsat, x_cu, x_en, thv_x0, thv_x1<a name='863'>
    real(r8)    thj, qvj, qlj, qij, thvj, tj, thv0j, rho0j, rhos0j, qse <a name='864'>
    real(r8)    cin, cinlcl<a name='865'>
    real(r8)    pe, dpe, exne, thvebot, thle, qte, ue, ve, thlue, qtue, wue<a name='866'>
    real(r8)    mu, mumin0, mumin1, mumin2, mulcl, mulclstar<a name='867'>
    real(r8)    cbmf, wcrit, winv, wlcl, ufrcinv, ufrclcl, rmaxfrac<a name='868'>
    real(r8)    criqc, exql, exqi, ppen<a name='869'>
    real(r8)    thl0top, thl0bot, qt0bot, qt0top, thvubot, thvutop<a name='870'>
    real(r8)    thlu_top, qtu_top, qlu_top, qiu_top, qlu_mid, qiu_mid, exntop<a name='871'>
    real(r8)    thl0lcl, qt0lcl, thv0lcl, thv0rel, rho0inv, autodet<a name='872'>
    real(r8)    aquad, bquad, cquad, xc1, xc2, excessu, excess0, xsat, xs1, xs2<a name='873'>
    real(r8)    bogbot, bogtop, delbog, drage, expfac, rbuoy, rdrag<a name='874'>
    real(r8)    rcwp, rlwp, riwp, qcubelow, qlubelow, qiubelow<a name='875'>
    real(r8)    rainflx, snowflx                     <a name='876'>
    real(r8)    es(1)                               <a name='877'>
    real(r8)    qs(1)                               <a name='878'>
    real(r8)    gam(1)                                        <font color=#447700>!  (L/cp)*dqs/dT<a name='879'></font>
    real(r8)    qsat_arg             <a name='880'>
    real(r8)    xsrc, xmean, xtop, xbot, xflx(0:mkx)<a name='881'>
    real(r8)    tmp1, tmp2<a name='882'>
<a name='883'>
    <font color=#447700>!----- Some diagnostic internal output variables<a name='884'></font>
<a name='885'>
    real(r8)  ufrcinvbase_out(mix)                            <font color=#447700>!  Cumulus updraft fraction at the PBL top [ fraction ]<a name='886'></font>
    real(r8)  ufrclcl_out(mix)                                <font color=#447700>!  Cumulus updraft fraction at the LCL ( or PBL top when LCL is below PBL top ) [ fraction ]<a name='887'></font>
    real(r8)  winvbase_out(mix)                               <font color=#447700>!  Cumulus updraft velocity at the PBL top [ m/s ]<a name='888'></font>
    real(r8)  wlcl_out(mix)                                   <font color=#447700>!  Cumulus updraft velocity at the LCL ( or PBL top when LCL is below PBL top ) [ m/s ]<a name='889'></font>
    real(r8)  plcl_out(mix)                                   <font color=#447700>!  LCL of source air [ Pa ]<a name='890'></font>
    real(r8)  pinv_out(mix)                                   <font color=#447700>!  PBL top pressure [ Pa ]<a name='891'></font>
    real(r8)  plfc_out(mix)                                   <font color=#447700>!  LFC of source air [ Pa ]<a name='892'></font>
    real(r8)  pbup_out(mix)                                   <font color=#447700>!  Highest interface level of positive buoyancy [ Pa ]<a name='893'></font>
    real(r8)  ppen_out(mix)                                   <font color=#447700>!  Highest interface evel where Cu w = 0 [ Pa ]<a name='894'></font>
    real(r8)  qtsrc_out(mix)                                  <font color=#447700>!  Sourse air qt [ kg/kg ]<a name='895'></font>
    real(r8)  thlsrc_out(mix)                                 <font color=#447700>!  Sourse air thl [ K ]<a name='896'></font>
    real(r8)  thvlsrc_out(mix)                                <font color=#447700>!  Sourse air thvl [ K ]<a name='897'></font>
    real(r8)  emfkbup_out(mix)                                <font color=#447700>!  Penetrative downward mass flux at 'kbup' interface [ kg/m2/s ]<a name='898'></font>
    real(r8)  cinlclh_out(mix)                                <font color=#447700>!  Convective INhibition upto LCL (CIN) [ J/kg = m2/s2 ]<a name='899'></font>
    real(r8)  tkeavg_out(mix)                                 <font color=#447700>!  Average tke over the PBL [ m2/s2 ]<a name='900'></font>
    real(r8)  cbmflimit_out(mix)                              <font color=#447700>!  Cloud base mass flux limiter [ kg/m2/s ]<a name='901'></font>
    real(r8)  zinv_out(mix)                                   <font color=#447700>!  PBL top height [ m ]<a name='902'></font>
    real(r8)  rcwp_out(mix)                                   <font color=#447700>!  Layer mean Cumulus LWP+IWP [ kg/m2 ] <a name='903'></font>
    real(r8)  rlwp_out(mix)                                   <font color=#447700>!  Layer mean Cumulus LWP [ kg/m2 ] <a name='904'></font>
    real(r8)  riwp_out(mix)                                   <font color=#447700>!  Layer mean Cumulus IWP [ kg/m2 ] <a name='905'></font>
    real(r8)  wu_out(mix,0:mkx)                               <font color=#447700>!  Updraft vertical velocity ( defined from the release level to 'kpen-1' interface )<a name='906'></font>
    real(r8)  qtu_out(mix,0:mkx)                              <font color=#447700>!  Updraft qt [ kg/kg ]<a name='907'></font>
    real(r8)  thlu_out(mix,0:mkx)                             <font color=#447700>!  Updraft thl [ K ]<a name='908'></font>
    real(r8)  thvu_out(mix,0:mkx)                             <font color=#447700>!  Updraft thv [ K ]<a name='909'></font>
    real(r8)  uu_out(mix,0:mkx)                               <font color=#447700>!  Updraft zonal wind [ m/s ] <a name='910'></font>
    real(r8)  vu_out(mix,0:mkx)                               <font color=#447700>!  Updraft meridional wind [ m/s ]<a name='911'></font>
    real(r8)  qtu_emf_out(mix,0:mkx)                          <font color=#447700>!  Penetratively entrained qt [ kg/kg ]   <a name='912'></font>
    real(r8)  thlu_emf_out(mix,0:mkx)                         <font color=#447700>!  Penetratively entrained thl [ K ]<a name='913'></font>
    real(r8)  uu_emf_out(mix,0:mkx)                           <font color=#447700>!  Penetratively entrained u [ m/s ]<a name='914'></font>
    real(r8)  vu_emf_out(mix,0:mkx)                           <font color=#447700>!  Penetratively entrained v [ m/s ]<a name='915'></font>
    real(r8)  uemf_out(mix,0:mkx)                             <font color=#447700>!  Net upward mass flux including penetrative entrainment (umf+emf) [ kg/m2/s ]<a name='916'></font>
    real(r8)  tru_out(mix,0:mkx,ncnst)                        <font color=#447700>!  Updraft tracers [ #, kg/kg ]   <a name='917'></font>
    real(r8)  tru_emf_out(mix,0:mkx,ncnst)                    <font color=#447700>!  Penetratively entrained tracers [ #, kg/kg ]<a name='918'></font>
<a name='919'>
    real(r8)  wu_s(0:mkx)                                     <font color=#447700>!  Same as above but for implicit CIN<a name='920'></font>
    real(r8)  qtu_s(0:mkx)<a name='921'>
    real(r8)  thlu_s(0:mkx)<a name='922'>
    real(r8)  thvu_s(0:mkx)<a name='923'>
    real(r8)  uu_s(0:mkx)<a name='924'>
    real(r8)  vu_s(0:mkx)<a name='925'>
    real(r8)  qtu_emf_s(0:mkx) <a name='926'>
    real(r8)  thlu_emf_s(0:mkx)  <a name='927'>
    real(r8)  uu_emf_s(0:mkx)   <a name='928'>
    real(r8)  vu_emf_s(0:mkx)<a name='929'>
    real(r8)  uemf_s(0:mkx)   <a name='930'>
    real(r8)  tru_s(0:mkx,ncnst)<a name='931'>
    real(r8)  tru_emf_s(0:mkx,ncnst)   <a name='932'>
<a name='933'>
    real(r8)  dwten_out(mix,mkx)<a name='934'>
    real(r8)  diten_out(mix,mkx)<a name='935'>
    real(r8)  flxrain_out(mix,0:mkx)  <a name='936'>
    real(r8)  flxsnow_out(mix,0:mkx)  <a name='937'>
    real(r8)  ntraprd_out(mix,mkx)    <a name='938'>
    real(r8)  ntsnprd_out(mix,mkx)    <a name='939'>
<a name='940'>
    real(r8)  dwten_s(mkx)<a name='941'>
    real(r8)  diten_s(mkx)<a name='942'>
    real(r8)  flxrain_s(0:mkx)  <a name='943'>
    real(r8)  flxsnow_s(0:mkx)  <a name='944'>
    real(r8)  ntraprd_s(mkx)    <a name='945'>
    real(r8)  ntsnprd_s(mkx)    <a name='946'>
<a name='947'>
    real(r8)  excessu_arr_out(mix,mkx)<a name='948'>
    real(r8)  excessu_arr(mkx) <a name='949'>
    real(r8)  excessu_arr_s(mkx)<a name='950'>
    real(r8)  excess0_arr_out(mix,mkx)<a name='951'>
    real(r8)  excess0_arr(mkx)<a name='952'>
    real(r8)  excess0_arr_s(mkx)<a name='953'>
    real(r8)  xc_arr_out(mix,mkx)<a name='954'>
    real(r8)  xc_arr(mkx)<a name='955'>
    real(r8)  xc_arr_s(mkx)<a name='956'>
    real(r8)  aquad_arr_out(mix,mkx)<a name='957'>
    real(r8)  aquad_arr(mkx)<a name='958'>
    real(r8)  aquad_arr_s(mkx)<a name='959'>
    real(r8)  bquad_arr_out(mix,mkx)<a name='960'>
    real(r8)  bquad_arr(mkx)<a name='961'>
    real(r8)  bquad_arr_s(mkx)<a name='962'>
    real(r8)  cquad_arr_out(mix,mkx) <a name='963'>
    real(r8)  cquad_arr(mkx)<a name='964'>
    real(r8)  cquad_arr_s(mkx)<a name='965'>
    real(r8)  bogbot_arr_out(mix,mkx)<a name='966'>
    real(r8)  bogbot_arr(mkx)<a name='967'>
    real(r8)  bogbot_arr_s(mkx)<a name='968'>
    real(r8)  bogtop_arr_out(mix,mkx)<a name='969'>
    real(r8)  bogtop_arr(mkx)<a name='970'>
    real(r8)  bogtop_arr_s(mkx)<a name='971'>
<a name='972'>
    real(r8)  exit_UWCu(mix)<a name='973'>
    real(r8)  exit_conden(mix)<a name='974'>
    real(r8)  exit_klclmkx(mix)<a name='975'>
    real(r8)  exit_klfcmkx(mix)<a name='976'>
    real(r8)  exit_ufrc(mix)<a name='977'>
    real(r8)  exit_wtw(mix)<a name='978'>
    real(r8)  exit_drycore(mix)<a name='979'>
    real(r8)  exit_wu(mix)<a name='980'>
    real(r8)  exit_cufilter(mix)<a name='981'>
    real(r8)  exit_kinv1(mix)<a name='982'>
    real(r8)  exit_rei(mix)<a name='983'>
<a name='984'>
    real(r8)  limit_shcu(mix)<a name='985'>
    real(r8)  limit_negcon(mix)<a name='986'>
    real(r8)  limit_ufrc(mix)<a name='987'>
    real(r8)  limit_ppen(mix)<a name='988'>
    real(r8)  limit_emf(mix)<a name='989'>
    real(r8)  limit_cinlcl(mix)<a name='990'>
    real(r8)  limit_cin(mix)<a name='991'>
    real(r8)  limit_cbmf(mix)<a name='992'>
    real(r8)  limit_rei(mix)<a name='993'>
    real(r8)  ind_delcin(mix)<a name='994'>
<a name='995'>
    real(r8) :: ufrcinvbase_s, ufrclcl_s, winvbase_s, wlcl_s, plcl_s, pinv_s, plfc_s, &amp;<a name='996'>
                qtsrc_s, thlsrc_s, thvlsrc_s, emfkbup_s, cinlcl_s, pbup_s, ppen_s, cbmflimit_s, &amp;<a name='997'>
                tkeavg_s, zinv_s, rcwp_s, rlwp_s, riwp_s <a name='998'>
    real(r8) :: ufrcinvbase, winvbase, pinv, zinv, emfkbup, cbmflimit, rho0rel  <a name='999'>
<a name='1000'>
    <font color=#447700>!----- Variables for implicit CIN computation<a name='1001'></font>
<a name='1002'>
    real(r8), dimension(mkx)         :: qv0_s  , ql0_s   , qi0_s   , s0_s    , u0_s    ,           &amp; <a name='1003'>
                                        v0_s   , t0_s    , qt0_s   , thl0_s  , thvl0_s , qvten_s , &amp;<a name='1004'>
                                        qlten_s, qiten_s , qrten_s , qsten_s , sten_s  , evapc_s , &amp;<a name='1005'>
                                        uten_s , vten_s  , cufrc_s , qcu_s   , qlu_s   , qiu_s   , &amp;<a name='1006'>
                                        fer_s  , fdr_s   , qc_s    , qtten_s , slten_s <a name='1007'>
    real(r8), dimension(0:mkx)       :: umf_s  , slflx_s , qtflx_s , ufrc_s  , uflx_s , vflx_s<a name='1008'>
    real(r8)                         :: cush_s , precip_s, snow_s  , cin_s   , rliq_s, cbmf_s, cnt_s, cnb_s<a name='1009'>
    real(r8)                         :: cin_i,cin_f,del_CIN,ke,alpha,thlj<a name='1010'>
    real(r8)                         :: cinlcl_i,cinlcl_f,del_cinlcl<a name='1011'>
    integer                          :: iter<a name='1012'>
<a name='1013'>
    real(r8), dimension(mkx,ncnst)   :: tr0_s, trten_s<a name='1014'>
    real(r8), dimension(0:mkx,ncnst) :: trflx_s<a name='1015'>
<a name='1016'>
    <font color=#447700>!----- Variables for temporary storages<a name='1017'></font>
<a name='1018'>
    real(r8), dimension(mkx)         :: qv0_o, ql0_o, qi0_o, t0_o, s0_o, u0_o, v0_o<a name='1019'>
    real(r8), dimension(mkx)         :: qt0_o    , thl0_o   , thvl0_o   ,                         &amp;<a name='1020'>
                                        qvten_o  , qlten_o  , qiten_o   , qrten_o   , qsten_o ,   &amp;<a name='1021'>
                                        sten_o   , uten_o   , vten_o    , qcu_o     , qlu_o   ,   &amp; <a name='1022'>
                                        qiu_o    , cufrc_o  , evapc_o   ,                         &amp;<a name='1023'>
                                        thv0bot_o, thv0top_o, thvl0bot_o, thvl0top_o,             &amp;<a name='1024'>
                                        ssthl0_o , ssqt0_o  , ssu0_o    , ssv0_o    , qc_o    ,   &amp;<a name='1025'>
                                        qtten_o  , slten_o  <a name='1026'>
    real(r8), dimension(0:mkx)       :: umf_o    , slflx_o  , qtflx_o   , ufrc_o <a name='1027'>
    real(r8), dimension(mix)         :: cush_o   , precip_o , snow_o    , rliq_o, cbmf_o, cnt_o, cnb_o<a name='1028'>
    real(r8), dimension(0:mkx)       :: uflx_o   , vflx_o<a name='1029'>
    real(r8)                         :: tkeavg_o , thvlmin_o, qtsrc_o  , thvlsrc_o, thlsrc_o ,    &amp;<a name='1030'>
                                        usrc_o   , vsrc_o   , plcl_o   , plfc_o   ,               &amp;<a name='1031'>
                                        thv0lcl_o, cinlcl_o <a name='1032'>
    integer                          :: kinv_o   , klcl_o   , klfc_o  <a name='1033'>
<a name='1034'>
    real(r8), dimension(mkx,ncnst)   :: tr0_o<a name='1035'>
    real(r8), dimension(mkx,ncnst)   :: trten_o, sstr0_o  <a name='1036'>
    real(r8), dimension(0:mkx,ncnst) :: trflx_o<a name='1037'>
    real(r8), dimension(ncnst)       :: trsrc_o<a name='1038'>
    integer                          :: ixnumliq, ixnumice<a name='1039'>
<a name='1040'>
    <font color=#447700>! ------------------ !<a name='1041'></font>
    <font color=#447700>!                    !<a name='1042'></font>
    <font color=#447700>! Define Parameters  !<a name='1043'></font>
    <font color=#447700>!                    !<a name='1044'></font>
    <font color=#447700>! ------------------ !<a name='1045'></font>
<a name='1046'>
    <font color=#447700>! ------------------------ !<a name='1047'></font>
    <font color=#447700>! Iterative xc calculation !<a name='1048'></font>
    <font color=#447700>! ------------------------ !<a name='1049'></font>
<a name='1050'>
    integer , parameter              :: niter_xc = 2<a name='1051'>
<a name='1052'>
    <font color=#447700>! ----------------------------------------------------------- !<a name='1053'></font>
    <font color=#447700>! Choice of 'CIN = cin' (.true.) or 'CIN = cinlcl' (.false.). !<a name='1054'></font>
    <font color=#447700>! ----------------------------------------------------------- !<a name='1055'></font>
<a name='1056'>
    logical , parameter              :: use_CINcin = .true.<a name='1057'>
<a name='1058'>
    <font color=#447700>! --------------------------------------------------------------- !<a name='1059'></font>
    <font color=#447700>! Choice of 'explicit' ( 1 ) or 'implicit' ( 2 )  CIN.            !<a name='1060'></font>
    <font color=#447700>!                                                                 !<a name='1061'></font>
    <font color=#447700>! When choose 'CIN = cinlcl' above,  it is recommended not to use ! <a name='1062'></font>
    <font color=#447700>! implicit CIN, i.e., do 'NOT' choose simultaneously :            !<a name='1063'></font>
    <font color=#447700>!            [ 'use_CINcin=.false. &amp; 'iter_cin=2' ]               !<a name='1064'></font>
    <font color=#447700>! since 'cinlcl' will be always set to zero whenever LCL is below !<a name='1065'></font>
    <font color=#447700>! the PBL top interface in the current code. So, averaging cinlcl !<a name='1066'></font>
    <font color=#447700>! of two iter_cin steps is likely not so good. Except that,   all !<a name='1067'></font>
    <font color=#447700>! the other combinations of  'use_CINcin'  &amp; 'iter_cin' are OK.   !<a name='1068'></font>
    <font color=#447700>!                                                                 !<a name='1069'></font>
    <font color=#447700>! Feb 2007, Bundy: Note that use_CINcin = .false. will try to use !<a name='1070'></font>
    <font color=#447700>!           a variable (del_cinlcl) that is not currently set     !<a name='1071'></font>
    <font color=#447700>!                                                                 !<a name='1072'></font>
    <font color=#447700>! --------------------------------------------------------------- !<a name='1073'></font>
<a name='1074'>
    integer , parameter              :: iter_cin = 2<a name='1075'>
<a name='1076'>
    <font color=#447700>! ---------------------------------------------------------------- !<a name='1077'></font>
    <font color=#447700>! Choice of 'self-detrainment' by negative buoyancy in calculating !<a name='1078'></font>
    <font color=#447700>! cumulus updraft mass flux at the top interface in each layer.    !<a name='1079'></font>
    <font color=#447700>! ---------------------------------------------------------------- !<a name='1080'></font>
<a name='1081'>
    logical , parameter              :: use_self_detrain = .false.<a name='1082'>
    <a name='1083'>
    <font color=#447700>! --------------------------------------------------------- !<a name='1084'></font>
    <font color=#447700>! Cumulus momentum flux : turn-on (.true.) or off (.false.) !<a name='1085'></font>
    <font color=#447700>! --------------------------------------------------------- !<a name='1086'></font>
<a name='1087'>
    logical , parameter              :: use_momenflx = .true.<a name='1088'>
<a name='1089'>
    <font color=#447700>! ----------------------------------------------------------------------------------------- !<a name='1090'></font>
    <font color=#447700>! Penetrative Entrainment : Cumulative ( .true. , original ) or Non-Cumulative ( .false. )  !<a name='1091'></font>
    <font color=#447700>! This option ( .false. ) is designed to reduce the sensitivity to the vertical resolution. !<a name='1092'></font>
    <font color=#447700>! ----------------------------------------------------------------------------------------- !<a name='1093'></font>
<a name='1094'>
    logical , parameter              :: use_cumpenent = .true.<a name='1095'>
<a name='1096'>
    <font color=#447700>! --------------------------------------------------------------------------------------------------------------- !<a name='1097'></font>
    <font color=#447700>! Computation of the grid-mean condensate tendency.                                                               !<a name='1098'></font>
    <font color=#447700>!     use_expconten = .true.  : explcitly compute tendency by condensate detrainment and compensating subsidence  !<a name='1099'></font>
    <font color=#447700>!     use_expconten = .false. : use the original proportional condensate tendency equation. ( original )          !<a name='1100'></font>
    <font color=#447700>! --------------------------------------------------------------------------------------------------------------- !<a name='1101'></font>
<a name='1102'>
    logical , parameter              :: use_expconten = .true.<a name='1103'>
<a name='1104'>
    <font color=#447700>! --------------------------------------------------------------------------------------------------------------- !<a name='1105'></font>
    <font color=#447700>! Treatment of reserved condensate                                                                                !<a name='1106'></font>
    <font color=#447700>!     use_unicondet = .true.  : detrain condensate uniformly over the environment ( original )                    !<a name='1107'></font>
    <font color=#447700>!     use_unicondet = .false. : detrain condensate into the pre-existing stratus                                  !<a name='1108'></font>
    <font color=#447700>! --------------------------------------------------------------------------------------------------------------- !<a name='1109'></font>
<a name='1110'>
    logical , parameter              :: use_unicondet = .false.<a name='1111'>
<a name='1112'>
    <font color=#447700>! ----------------------- !<a name='1113'></font>
    <font color=#447700>! For lateral entrainment !<a name='1114'></font>
    <font color=#447700>! ----------------------- !<a name='1115'></font>
<a name='1116'>
    parameter (rle = 0.1_r8)         <font color=#447700>!  For critical stopping distance for lateral entrainment [no unit]<a name='1117'></font>
<font color=#447700>!   parameter (rkm = 16.0_r8)        !  Determine the amount of air that is involved in buoyancy-sorting [no unit] <a name='1118'></font>
    parameter (rkm = 14.0_r8)        <font color=#447700>!  Determine the amount of air that is involved in buoyancy-sorting [no unit]<a name='1119'></font>
<a name='1120'>
    parameter (rkfre = 1.0_r8)       <font color=#447700>!  Vertical velocity variance as fraction of  tke. <a name='1121'></font>
    parameter (rmaxfrac = 0.10_r8)   <font color=#447700>!  Maximum allowable 'core' updraft fraction<a name='1122'></font>
    parameter (mumin1 = 0.906_r8)    <font color=#447700>!  Normalized CIN ('mu') corresponding to 'rmaxfrac' at the PBL top<a name='1123'></font>
                                     <font color=#447700>!  obtaind by inverting 'rmaxfrac = 0.5*erfc(mumin1)'.<a name='1124'></font>
                                     <font color=#447700>!  [ rmaxfrac:mumin1 ] = [ 0.05:1.163, 0.075:1.018, 0.1:0.906, 0.15:0.733, 0.2:0.595, 0.25:0.477 ] <a name='1125'></font>
    parameter (rbuoy = 1.0_r8)       <font color=#447700>!  For nonhydrostatic pressure effects on updraft [no unit]<a name='1126'></font>
    parameter (rdrag = 1.0_r8)       <font color=#447700>!  Drag coefficient [no unit]<a name='1127'></font>
<a name='1128'>
    parameter (epsvarw = 5.e-4_r8)   <font color=#447700>!  Variance of w at PBL top by meso-scale component [m2/s2]          <a name='1129'></font>
    parameter (PGFc = 0.7_r8)        <font color=#447700>!  This is used for calculating vertical variations cumulus  <a name='1130'></font>
                                     <font color=#447700>!  'u' &amp; 'v' by horizontal PGF during upward motion [no unit]<a name='1131'></font>
<a name='1132'>
    <font color=#447700>! ---------------------------------------- !<a name='1133'></font>
    <font color=#447700>! Bulk microphysics controlling parameters !<a name='1134'></font>
    <font color=#447700>! --------------------------------------------------------------------------- ! <a name='1135'></font>
    <font color=#447700>! criqc    : Maximum condensate that can be hold by cumulus updraft [kg/kg]   !<a name='1136'></font>
    <font color=#447700>! frc_rasn : Fraction of precipitable condensate in the expelled cloud water  !<a name='1137'></font>
    <font color=#447700>!            from cumulus updraft. The remaining fraction ('1-frc_rasn')  is  !<a name='1138'></font>
    <font color=#447700>!            'suspended condensate'.                                          !<a name='1139'></font>
    <font color=#447700>!                0 : all expelled condensate is 'suspended condensate'        ! <a name='1140'></font>
    <font color=#447700>!                1 : all expelled condensate is 'precipitable condensate'     !<a name='1141'></font>
    <font color=#447700>! kevp     : Evaporative efficiency                                           !<a name='1142'></font>
    <font color=#447700>! noevap_krelkpen : No evaporation from 'krel' to 'kpen' layers               ! <a name='1143'></font>
    <font color=#447700>! --------------------------------------------------------------------------- !    <a name='1144'></font>
<a name='1145'>
    parameter ( criqc    = 0.7e-3_r8 ) <a name='1146'>
    parameter ( frc_rasn = 1.0_r8    )<a name='1147'>
    parameter ( kevp     = 2.e-6_r8  )<a name='1148'>
    logical, parameter :: noevap_krelkpen = .false.<a name='1149'>
<a name='1150'>
    <font color=#447700>!------------------------!<a name='1151'></font>
    <font color=#447700>!                        !<a name='1152'></font>
    <font color=#447700>! Start Main Calculation !<a name='1153'></font>
    <font color=#447700>!                        !<a name='1154'></font>
    <font color=#447700>!------------------------!<a name='1155'></font>
<a name='1156'>
    call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_15">( 'NUMLIQ', ixnumliq )<a name='1157'>
    call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_16">( 'NUMICE', ixnumice )<a name='1158'>
<a name='1159'>
    <font color=#447700>! ------------------------------------------------------- !<a name='1160'></font>
    <font color=#447700>! Initialize output variables defined for all grid points !<a name='1161'></font>
    <font color=#447700>! ------------------------------------------------------- !<a name='1162'></font>
<a name='1163'>
    umf_out(:iend,0:mkx)         = 0.0_r8<a name='1164'>
    slflx_out(:iend,0:mkx)       = 0.0_r8<a name='1165'>
    qtflx_out(:iend,0:mkx)       = 0.0_r8<a name='1166'>
    flxprc1_out(:iend,0:mkx)     = 0.0_r8<a name='1167'>
    flxsnow1_out(:iend,0:mkx)    = 0.0_r8<a name='1168'>
    qvten_out(:iend,:mkx)        = 0.0_r8<a name='1169'>
    qlten_out(:iend,:mkx)        = 0.0_r8<a name='1170'>
    qiten_out(:iend,:mkx)        = 0.0_r8<a name='1171'>
    sten_out(:iend,:mkx)         = 0.0_r8<a name='1172'>
    uten_out(:iend,:mkx)         = 0.0_r8<a name='1173'>
    vten_out(:iend,:mkx)         = 0.0_r8<a name='1174'>
    qrten_out(:iend,:mkx)        = 0.0_r8<a name='1175'>
    qsten_out(:iend,:mkx)        = 0.0_r8<a name='1176'>
    precip_out(:iend)            = 0.0_r8<a name='1177'>
    snow_out(:iend)              = 0.0_r8<a name='1178'>
    evapc_out(:iend,:mkx)        = 0.0_r8<a name='1179'>
    cufrc_out(:iend,:mkx)        = 0.0_r8<a name='1180'>
    qcu_out(:iend,:mkx)          = 0.0_r8<a name='1181'>
    qlu_out(:iend,:mkx)          = 0.0_r8<a name='1182'>
    qiu_out(:iend,:mkx)          = 0.0_r8<a name='1183'>
    fer_out(:iend,:mkx)          = 0.0_r8<a name='1184'>
    fdr_out(:iend,:mkx)          = 0.0_r8<a name='1185'>
    cinh_out(:iend)              = -1.0_r8<a name='1186'>
    cinlclh_out(:iend)           = -1.0_r8<a name='1187'>
    cbmf_out(:iend)              = 0.0_r8<a name='1188'>
    qc_out(:iend,:mkx)           = 0.0_r8<a name='1189'>
    rliq_out(:iend)              = 0.0_r8<a name='1190'>
    cnt_out(:iend)               = real(mkx, r8)<a name='1191'>
    cnb_out(:iend)               = 0.0_r8<a name='1192'>
    qtten_out(:iend,:mkx)        = 0.0_r8<a name='1193'>
    slten_out(:iend,:mkx)        = 0.0_r8<a name='1194'>
    ufrc_out(:iend,0:mkx)        = 0.0_r8<a name='1195'>
<a name='1196'>
    uflx_out(:iend,0:mkx)        = 0.0_r8<a name='1197'>
    vflx_out(:iend,0:mkx)        = 0.0_r8<a name='1198'>
<a name='1199'>
    trten_out(:iend,:mkx,:ncnst) = 0.0_r8<a name='1200'>
    trflx_out(:iend,0:mkx,:ncnst)= 0.0_r8<a name='1201'>
    <a name='1202'>
    ufrcinvbase_out(:iend)       = 0.0_r8<a name='1203'>
    ufrclcl_out(:iend)           = 0.0_r8<a name='1204'>
    winvbase_out(:iend)          = 0.0_r8<a name='1205'>
    wlcl_out(:iend)              = 0.0_r8<a name='1206'>
    plcl_out(:iend)              = 0.0_r8<a name='1207'>
    pinv_out(:iend)              = 0.0_r8<a name='1208'>
    plfc_out(:iend)              = 0.0_r8<a name='1209'>
    pbup_out(:iend)              = 0.0_r8<a name='1210'>
    ppen_out(:iend)              = 0.0_r8<a name='1211'>
    qtsrc_out(:iend)             = 0.0_r8<a name='1212'>
    thlsrc_out(:iend)            = 0.0_r8<a name='1213'>
    thvlsrc_out(:iend)           = 0.0_r8<a name='1214'>
    emfkbup_out(:iend)           = 0.0_r8<a name='1215'>
    cbmflimit_out(:iend)         = 0.0_r8<a name='1216'>
    tkeavg_out(:iend)            = 0.0_r8<a name='1217'>
    zinv_out(:iend)              = 0.0_r8<a name='1218'>
    rcwp_out(:iend)              = 0.0_r8<a name='1219'>
    rlwp_out(:iend)              = 0.0_r8<a name='1220'>
    riwp_out(:iend)              = 0.0_r8<a name='1221'>
<a name='1222'>
    wu_out(:iend,0:mkx)          = 0.0_r8<a name='1223'>
    qtu_out(:iend,0:mkx)         = 0.0_r8<a name='1224'>
    thlu_out(:iend,0:mkx)        = 0.0_r8<a name='1225'>
    thvu_out(:iend,0:mkx)        = 0.0_r8<a name='1226'>
    uu_out(:iend,0:mkx)          = 0.0_r8<a name='1227'>
    vu_out(:iend,0:mkx)          = 0.0_r8<a name='1228'>
    qtu_emf_out(:iend,0:mkx)     = 0.0_r8<a name='1229'>
    thlu_emf_out(:iend,0:mkx)    = 0.0_r8<a name='1230'>
    uu_emf_out(:iend,0:mkx)      = 0.0_r8<a name='1231'>
    vu_emf_out(:iend,0:mkx)      = 0.0_r8<a name='1232'>
    uemf_out(:iend,0:mkx)        = 0.0_r8<a name='1233'>
<a name='1234'>
    tru_out(:iend,0:mkx,:ncnst)     = 0.0_r8<a name='1235'>
    tru_emf_out(:iend,0:mkx,:ncnst) = 0.0_r8<a name='1236'>
<a name='1237'>
    dwten_out(:iend,:mkx)        = 0.0_r8<a name='1238'>
    diten_out(:iend,:mkx)        = 0.0_r8<a name='1239'>
    flxrain_out(:iend,0:mkx)     = 0.0_r8  <a name='1240'>
    flxsnow_out(:iend,0:mkx)     = 0.0_r8<a name='1241'>
    ntraprd_out(:iend,mkx)       = 0.0_r8<a name='1242'>
    ntsnprd_out(:iend,mkx)       = 0.0_r8<a name='1243'>
<a name='1244'>
    excessu_arr_out(:iend,:mkx)  = 0.0_r8<a name='1245'>
    excess0_arr_out(:iend,:mkx)  = 0.0_r8<a name='1246'>
    xc_arr_out(:iend,:mkx)       = 0.0_r8<a name='1247'>
    aquad_arr_out(:iend,:mkx)    = 0.0_r8<a name='1248'>
    bquad_arr_out(:iend,:mkx)    = 0.0_r8<a name='1249'>
    cquad_arr_out(:iend,:mkx)    = 0.0_r8<a name='1250'>
    bogbot_arr_out(:iend,:mkx)   = 0.0_r8<a name='1251'>
    bogtop_arr_out(:iend,:mkx)   = 0.0_r8<a name='1252'>
<a name='1253'>
    exit_UWCu(:iend)             = 0.0_r8 <a name='1254'>
    exit_conden(:iend)           = 0.0_r8 <a name='1255'>
    exit_klclmkx(:iend)          = 0.0_r8 <a name='1256'>
    exit_klfcmkx(:iend)          = 0.0_r8 <a name='1257'>
    exit_ufrc(:iend)             = 0.0_r8 <a name='1258'>
    exit_wtw(:iend)              = 0.0_r8 <a name='1259'>
    exit_drycore(:iend)          = 0.0_r8 <a name='1260'>
    exit_wu(:iend)               = 0.0_r8 <a name='1261'>
    exit_cufilter(:iend)         = 0.0_r8 <a name='1262'>
    exit_kinv1(:iend)            = 0.0_r8 <a name='1263'>
    exit_rei(:iend)              = 0.0_r8 <a name='1264'>
<a name='1265'>
    limit_shcu(:iend)            = 0.0_r8 <a name='1266'>
    limit_negcon(:iend)          = 0.0_r8 <a name='1267'>
    limit_ufrc(:iend)            = 0.0_r8<a name='1268'>
    limit_ppen(:iend)            = 0.0_r8<a name='1269'>
    limit_emf(:iend)             = 0.0_r8<a name='1270'>
    limit_cinlcl(:iend)          = 0.0_r8<a name='1271'>
    limit_cin(:iend)             = 0.0_r8<a name='1272'>
    limit_cbmf(:iend)            = 0.0_r8<a name='1273'>
    limit_rei(:iend)             = 0.0_r8<a name='1274'>
<a name='1275'>
    ind_delcin(:iend)            = 0.0_r8<a name='1276'>
<a name='1277'>
    <font color=#447700>!--------------------------------------------------------------!<a name='1278'></font>
    <font color=#447700>!                                                              !<a name='1279'></font>
    <font color=#447700>! Start the column i loop where i is a horozontal column index !<a name='1280'></font>
    <font color=#447700>!                                                              !<a name='1281'></font>
    <font color=#447700>!--------------------------------------------------------------!<a name='1282'></font>
<a name='1283'>
    <font color=#447700>! Compute wet-bulb temperature and specific humidity<a name='1284'></font>
    <font color=#447700>! for treating evaporation of precipitation.<a name='1285'></font>
<a name='1286'>
    call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP'>findsp</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FINDSP_2">( lchnk, iend, qv0_in, t0_in, p0_in, tw0_in, qw0_in )<a name='1287'>
<a name='1288'>
    do i = 1, iend                                      <a name='1289'>
<a name='1290'>
      id_exit = .false.<a name='1291'>
<a name='1292'>
      <font color=#447700>! -------------------------------------------- !<a name='1293'></font>
      <font color=#447700>! Define 1D input variables at each grid point !<a name='1294'></font>
      <font color=#447700>! -------------------------------------------- !<a name='1295'></font>
<a name='1296'>
      ps0(0:mkx)       = ps0_in(i,0:mkx)<a name='1297'>
      zs0(0:mkx)       = zs0_in(i,0:mkx)<a name='1298'>
      p0(:mkx)         = p0_in(i,:mkx)<a name='1299'>
      z0(:mkx)         = z0_in(i,:mkx)<a name='1300'>
      dp0(:mkx)        = dp0_in(i,:mkx)<a name='1301'>
      dpdry0(:mkx)     = dpdry0_in(i,:mkx)<a name='1302'>
      u0(:mkx)         = u0_in(i,:mkx)<a name='1303'>
      v0(:mkx)         = v0_in(i,:mkx)<a name='1304'>
      qv0(:mkx)        = qv0_in(i,:mkx)<a name='1305'>
      ql0(:mkx)        = ql0_in(i,:mkx)<a name='1306'>
      qi0(:mkx)        = qi0_in(i,:mkx)<a name='1307'>
      t0(:mkx)         = t0_in(i,:mkx)<a name='1308'>
      s0(:mkx)         = s0_in(i,:mkx)<a name='1309'>
      tke(0:mkx)       = tke_in(i,0:mkx)<a name='1310'>
      cldfrct(:mkx)    = cldfrct_in(i,:mkx)<a name='1311'>
      concldfrct(:mkx) = concldfrct_in(i,:mkx)<a name='1312'>
      pblh             = pblh_in(i)<a name='1313'>
      cush             = cush_inout(i)<a name='1314'>
      do m = 1, ncnst<a name='1315'>
         tr0(:mkx,m)   = tr0_in(i,:mkx,m)<a name='1316'>
      enddo<a name='1317'>
<a name='1318'>
      <font color=#447700>! --------------------------------------------------------- !<a name='1319'></font>
      <font color=#447700>! Compute other basic thermodynamic variables directly from ! <a name='1320'></font>
      <font color=#447700>! the input variables at each grid point                    !<a name='1321'></font>
      <font color=#447700>! --------------------------------------------------------- !<a name='1322'></font>
<a name='1323'>
      <font color=#447700>!----- 1. Compute internal environmental variables<a name='1324'></font>
      <a name='1325'>
      exn0(:mkx)   = (p0(:mkx)/p00)**rovcp<a name='1326'>
      exns0(0:mkx) = (ps0(0:mkx)/p00)**rovcp<a name='1327'>
      qt0(:mkx)    = (qv0(:mkx) + ql0(:mkx) + qi0(:mkx))<a name='1328'>
      thl0(:mkx)   = (t0(:mkx) - xlv*ql0(:mkx)/cp - xls*qi0(:mkx)/cp)/exn0(:mkx)<a name='1329'>
      thvl0(:mkx)  = (1._r8 + zvir*qt0(:mkx))*thl0(:mkx)<a name='1330'>
<a name='1331'>
      <font color=#447700>!----- 2. Compute slopes of environmental variables in each layer<a name='1332'></font>
      <font color=#447700>!         Dimension of ssthl0(:mkx) is implicit.<a name='1333'></font>
<a name='1334'>
      ssthl0       = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#SLOPE'>slope</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_1">(mkx,thl0,p0) <a name='1335'>
      ssqt0        = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#SLOPE'>slope</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_2">(mkx,qt0 ,p0)<a name='1336'>
      ssu0         = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#SLOPE'>slope</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_3">(mkx,u0  ,p0)<a name='1337'>
      ssv0         = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#SLOPE'>slope</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_4">(mkx,v0  ,p0)<a name='1338'>
      do m = 1, ncnst<a name='1339'>
         sstr0(:mkx,m) = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#SLOPE'>slope</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_5">(mkx,tr0(:mkx,m),p0)<a name='1340'>
      enddo     <a name='1341'>
 <a name='1342'>
      <font color=#447700>!----- 3. Compute "thv0" and "thvl0" at the top/bottom interfaces in each layer<a name='1343'></font>
      <font color=#447700>!         There are computed from the reconstructed thl, qt at the top/bottom.<a name='1344'></font>
<a name='1345'>
      do k = 1, mkx<a name='1346'>
<a name='1347'>
         thl0bot = thl0(k) + ssthl0(k)*(ps0(k-1) - p0(k))<a name='1348'>
         qt0bot  = qt0(k)  + ssqt0(k) *(ps0(k-1) - p0(k))<a name='1349'>
         call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_1">(ps0(k-1),thl0bot,qt0bot,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='1350'>
         if( id_check .eq. 1 ) then<a name='1351'>
             exit_conden(i) = 1._r8<a name='1352'>
             id_exit = .true.<a name='1353'>
             go to 333<a name='1354'>
         end if<a name='1355'>
         thv0bot(k)  = thj*(1._r8 + zvir*qvj - qlj - qij)<a name='1356'>
         thvl0bot(k) = thl0bot*(1._r8 + zvir*qt0bot)<a name='1357'>
          <a name='1358'>
         thl0top = thl0(k) + ssthl0(k)*(ps0(k) - p0(k))<a name='1359'>
         qt0top  =  qt0(k) + ssqt0(k) *(ps0(k) - p0(k))<a name='1360'>
         call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_2">(ps0(k),thl0top,qt0top,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='1361'>
         if( id_check .eq. 1 ) then<a name='1362'>
             exit_conden(i) = 1._r8<a name='1363'>
             id_exit = .true.<a name='1364'>
             go to 333<a name='1365'>
         end if <a name='1366'>
         thv0top(k)  = thj*(1._r8 + zvir*qvj - qlj - qij)<a name='1367'>
         thvl0top(k) = thl0top*(1._r8 + zvir*qt0top)<a name='1368'>
<a name='1369'>
      end do<a name='1370'>
<a name='1371'>
      <font color=#447700>! ------------------------------------------------------------ !<a name='1372'></font>
      <font color=#447700>! Save input and related environmental thermodynamic variables !<a name='1373'></font>
      <font color=#447700>! for use at "iter_cin=2" when "del_CIN &gt;= 0"                  !<a name='1374'></font>
      <font color=#447700>! ------------------------------------------------------------ !<a name='1375'></font>
<a name='1376'>
      qv0_o(:mkx)          = qv0(:mkx)<a name='1377'>
      ql0_o(:mkx)          = ql0(:mkx)<a name='1378'>
      qi0_o(:mkx)          = qi0(:mkx)<a name='1379'>
      t0_o(:mkx)           = t0(:mkx)<a name='1380'>
      s0_o(:mkx)           = s0(:mkx)<a name='1381'>
      u0_o(:mkx)           = u0(:mkx)<a name='1382'>
      v0_o(:mkx)           = v0(:mkx)<a name='1383'>
      qt0_o(:mkx)          = qt0(:mkx)<a name='1384'>
      thl0_o(:mkx)         = thl0(:mkx)<a name='1385'>
      thvl0_o(:mkx)        = thvl0(:mkx)<a name='1386'>
      ssthl0_o(:mkx)       = ssthl0(:mkx)<a name='1387'>
      ssqt0_o(:mkx)        = ssqt0(:mkx)<a name='1388'>
      thv0bot_o(:mkx)      = thv0bot(:mkx)<a name='1389'>
      thv0top_o(:mkx)      = thv0top(:mkx)<a name='1390'>
      thvl0bot_o(:mkx)     = thvl0bot(:mkx)<a name='1391'>
      thvl0top_o(:mkx)     = thvl0top(:mkx)<a name='1392'>
      ssu0_o(:mkx)         = ssu0(:mkx) <a name='1393'>
      ssv0_o(:mkx)         = ssv0(:mkx) <a name='1394'>
      do m = 1, ncnst<a name='1395'>
         tr0_o(:mkx,m)     = tr0(:mkx,m)<a name='1396'>
         sstr0_o(:mkx,m)   = sstr0(:mkx,m)<a name='1397'>
      enddo <a name='1398'>
<a name='1399'>
      <font color=#447700>! ---------------------------------------------- !<a name='1400'></font>
      <font color=#447700>! Initialize output variables at each grid point !<a name='1401'></font>
      <font color=#447700>! ---------------------------------------------- !<a name='1402'></font>
<a name='1403'>
      umf(0:mkx)          = 0.0_r8<a name='1404'>
      emf(0:mkx)          = 0.0_r8<a name='1405'>
      slflx(0:mkx)        = 0.0_r8<a name='1406'>
      qtflx(0:mkx)        = 0.0_r8<a name='1407'>
      uflx(0:mkx)         = 0.0_r8<a name='1408'>
      vflx(0:mkx)         = 0.0_r8<a name='1409'>
      qvten(:mkx)         = 0.0_r8<a name='1410'>
      qlten(:mkx)         = 0.0_r8<a name='1411'>
      qiten(:mkx)         = 0.0_r8<a name='1412'>
      sten(:mkx)          = 0.0_r8<a name='1413'>
      uten(:mkx)          = 0.0_r8<a name='1414'>
      vten(:mkx)          = 0.0_r8<a name='1415'>
      qrten(:mkx)         = 0.0_r8<a name='1416'>
      qsten(:mkx)         = 0.0_r8<a name='1417'>
      dwten(:mkx)         = 0.0_r8<a name='1418'>
      diten(:mkx)         = 0.0_r8<a name='1419'>
      precip              = 0.0_r8<a name='1420'>
      snow                = 0.0_r8<a name='1421'>
      evapc(:mkx)         = 0.0_r8<a name='1422'>
      cufrc(:mkx)         = 0.0_r8<a name='1423'>
      qcu(:mkx)           = 0.0_r8<a name='1424'>
      qlu(:mkx)           = 0.0_r8<a name='1425'>
      qiu(:mkx)           = 0.0_r8<a name='1426'>
      fer(:mkx)           = 0.0_r8<a name='1427'>
      fdr(:mkx)           = 0.0_r8<a name='1428'>
      cin                 = 0.0_r8<a name='1429'>
      cbmf                = 0.0_r8<a name='1430'>
      qc(:mkx)            = 0.0_r8<a name='1431'>
      qc_l(:mkx)          = 0.0_r8<a name='1432'>
      qc_i(:mkx)          = 0.0_r8<a name='1433'>
      rliq                = 0.0_r8<a name='1434'>
      cnt                 = real(mkx, r8)<a name='1435'>
      cnb                 = 0.0_r8<a name='1436'>
      qtten(:mkx)         = 0.0_r8<a name='1437'>
      slten(:mkx)         = 0.0_r8   <a name='1438'>
      ufrc(0:mkx)         = 0.0_r8  <a name='1439'>
<a name='1440'>
      thlu(0:mkx)         = 0.0_r8<a name='1441'>
      qtu(0:mkx)          = 0.0_r8<a name='1442'>
      uu(0:mkx)           = 0.0_r8<a name='1443'>
      vu(0:mkx)           = 0.0_r8<a name='1444'>
      wu(0:mkx)           = 0.0_r8<a name='1445'>
      thvu(0:mkx)         = 0.0_r8<a name='1446'>
      thlu_emf(0:mkx)     = 0.0_r8<a name='1447'>
      qtu_emf(0:mkx)      = 0.0_r8<a name='1448'>
      uu_emf(0:mkx)       = 0.0_r8<a name='1449'>
      vu_emf(0:mkx)       = 0.0_r8<a name='1450'>
      <a name='1451'>
      ufrcinvbase         = 0.0_r8<a name='1452'>
      ufrclcl             = 0.0_r8<a name='1453'>
      winvbase            = 0.0_r8<a name='1454'>
      wlcl                = 0.0_r8<a name='1455'>
      emfkbup             = 0.0_r8 <a name='1456'>
      cbmflimit           = 0.0_r8<a name='1457'>
      excessu_arr(:mkx)   = 0.0_r8<a name='1458'>
      excess0_arr(:mkx)   = 0.0_r8<a name='1459'>
      xc_arr(:mkx)        = 0.0_r8<a name='1460'>
      aquad_arr(:mkx)     = 0.0_r8<a name='1461'>
      bquad_arr(:mkx)     = 0.0_r8<a name='1462'>
      cquad_arr(:mkx)     = 0.0_r8<a name='1463'>
      bogbot_arr(:mkx)    = 0.0_r8<a name='1464'>
      bogtop_arr(:mkx)    = 0.0_r8<a name='1465'>
<a name='1466'>
      uemf(0:mkx)         = 0.0_r8<a name='1467'>
      comsub(:mkx)        = 0.0_r8<a name='1468'>
      qlten_sink(:mkx)    = 0.0_r8<a name='1469'>
      qiten_sink(:mkx)    = 0.0_r8 <a name='1470'>
      nlten_sink(:mkx)    = 0.0_r8<a name='1471'>
      niten_sink(:mkx)    = 0.0_r8 <a name='1472'>
<a name='1473'>
      do m = 1, ncnst<a name='1474'>
         trflx(0:mkx,m)   = 0.0_r8<a name='1475'>
         trten(:mkx,m)    = 0.0_r8<a name='1476'>
         tru(0:mkx,m)     = 0.0_r8<a name='1477'>
         tru_emf(0:mkx,m) = 0.0_r8<a name='1478'>
      enddo<a name='1479'>
<a name='1480'>
    <font color=#447700>!-----------------------------------------------! <a name='1481'></font>
    <font color=#447700>! Below 'iter' loop is for implicit CIN closure !<a name='1482'></font>
    <font color=#447700>!-----------------------------------------------!<a name='1483'></font>
<a name='1484'>
    <font color=#447700>! ----------------------------------------------------------------------------- ! <a name='1485'></font>
    <font color=#447700>! It is important to note that this iterative cin loop is located at the outest !<a name='1486'></font>
    <font color=#447700>! shell of the code. Thus, source air properties can also be changed during the !<a name='1487'></font>
    <font color=#447700>! iterative cin calculation, because cumulus convection induces non-zero fluxes !<a name='1488'></font>
    <font color=#447700>! even at interfaces below PBL top height through 'fluxbelowinv' subroutine.    !<a name='1489'></font>
    <font color=#447700>! ----------------------------------------------------------------------------- !<a name='1490'></font>
<a name='1491'>
    do iter = 1, iter_cin<a name='1492'>
<a name='1493'>
       <font color=#447700>! ---------------------------------------------------------------------- ! <a name='1494'></font>
       <font color=#447700>! Cumulus scale height                                                   ! <a name='1495'></font>
       <font color=#447700>! In contrast to the premitive code, cumulus scale height is iteratively !<a name='1496'></font>
       <font color=#447700>! calculated at each time step, and at each iterative cin step.          !<a name='1497'></font>
       <font color=#447700>! It is not clear whether I should locate below two lines within or  out !<a name='1498'></font>
       <font color=#447700>! of the iterative cin loop.                                             !<a name='1499'></font>
       <font color=#447700>! ---------------------------------------------------------------------- !<a name='1500'></font>
<a name='1501'>
       tscaleh = cush                        <a name='1502'>
       cush    = -1._r8<a name='1503'>
<a name='1504'>
       <font color=#447700>! ----------------------------------------------------------------------- !<a name='1505'></font>
       <font color=#447700>! Find PBL top height interface index, 'kinv-1' where 'kinv' is the layer !<a name='1506'></font>
       <font color=#447700>! index with PBLH in it. When PBLH is exactly at interface, 'kinv' is the !<a name='1507'></font>
       <font color=#447700>! layer index having PBLH as a lower interface.                           !<a name='1508'></font>
       <font color=#447700>! In the previous code, I set the lower limit of 'kinv' by 2  in order to !<a name='1509'></font>
       <font color=#447700>! be consistent with the other parts of the code. However in the modified !<a name='1510'></font>
       <font color=#447700>! code, I allowed 'kinv' to be 1 &amp; if 'kinv = 1', I just exit the program !<a name='1511'></font>
       <font color=#447700>! without performing cumulus convection. This new approach seems to be    !<a name='1512'></font>
       <font color=#447700>! more reasonable: if PBL height is within 'kinv=1' layer, surface is STL !<a name='1513'></font>
       <font color=#447700>! interface (bflxs &lt;= 0) and interface just above the surface should be   !<a name='1514'></font>
       <font color=#447700>! either non-turbulent (Ri&gt;0.19) or stably turbulent (0&lt;=Ri&lt;0.19 but this !<a name='1515'></font>
       <font color=#447700>! interface is identified as a base external interface of upperlying CL.  !<a name='1516'></font>
       <font color=#447700>! Thus, when 'kinv=1', PBL scheme guarantees 'bflxs &lt;= 0'.  For this case !<a name='1517'></font>
       <font color=#447700>! it is reasonable to assume that cumulus convection does not happen.     !<a name='1518'></font>
       <font color=#447700>! When these is SBCL, PBL height from the PBL scheme is likely to be very !<a name='1519'></font>
       <font color=#447700>! close at 'kinv-1' interface, but not exactly, since 'zi' information is !<a name='1520'></font>
       <font color=#447700>! changed between two model time steps. In order to ensure correct identi !<a name='1521'></font>
       <font color=#447700>! fication of 'kinv' for general case including SBCL, I imposed an offset !<a name='1522'></font>
       <font color=#447700>! of 5 [m] in the below 'kinv' finding block.                             !<a name='1523'></font>
       <font color=#447700>! ----------------------------------------------------------------------- !<a name='1524'></font>
       <a name='1525'>
       do k = mkx - 1, 1, -1 <a name='1526'>
          if( (pblh + 5._r8 - zs0(k))*(pblh + 5._r8 - zs0(k+1)) .lt. 0._r8 ) then<a name='1527'>
               kinv = k + 1 <a name='1528'>
               go to 15<a name='1529'>
          endif <a name='1530'>
       end do<a name='1531'>
       kinv = 1<a name='1532'>
15     continue    <a name='1533'>
<a name='1534'>
       if( kinv .le. 1 ) then          <a name='1535'>
           exit_kinv1(i) = 1._r8<a name='1536'>
           id_exit = .true.<a name='1537'>
           go to 333<a name='1538'>
       endif<a name='1539'>
       <font color=#447700>! From here, it must be 'kinv &gt;= 2'.<a name='1540'></font>
<a name='1541'>
       <font color=#447700>! -------------------------------------------------------------------------- !<a name='1542'></font>
       <font color=#447700>! Find PBL averaged tke ('tkeavg') and minimum 'thvl' ('thvlmin') in the PBL !<a name='1543'></font>
       <font color=#447700>! In the current code, 'tkeavg' is obtained by averaging all interfacial TKE !<a name='1544'></font>
       <font color=#447700>! within the PBL. However, in order to be conceptually consistent with   PBL !<a name='1545'></font>
       <font color=#447700>! scheme, 'tkeavg' should be calculated by considering surface buoyancy flux.!<a name='1546'></font>
       <font color=#447700>! If surface buoyancy flux is positive ( bflxs &gt;0 ), surface interfacial TKE !<a name='1547'></font>
       <font color=#447700>! should be included in calculating 'tkeavg', while if bflxs &lt;= 0,   surface !<a name='1548'></font>
       <font color=#447700>! interfacial TKE should not be included in calculating 'tkeavg'.   I should !<a name='1549'></font>
       <font color=#447700>! modify the code when 'bflxs' is available as an input of cumulus scheme.   !<a name='1550'></font>
       <font color=#447700>! 'thvlmin' is a minimum 'thvl' within PBL obtained by comparing top &amp;  base !<a name='1551'></font>
       <font color=#447700>! interface values of 'thvl' in each layers within the PBL.                  !<a name='1552'></font>
       <font color=#447700>! -------------------------------------------------------------------------- !<a name='1553'></font>
       <a name='1554'>
       dpsum    = 0._r8<a name='1555'>
       tkeavg   = 0._r8<a name='1556'>
       thvlmin  = 1000._r8<a name='1557'>
       do k = 0, kinv - 1   <font color=#447700>! Here, 'k' is an interfacial layer index.  <a name='1558'></font>
          if( k .eq. 0 ) then<a name='1559'>
              dpi = ps0(0) - p0(1)<a name='1560'>
          elseif( k .eq. (kinv-1) ) then <a name='1561'>
              dpi = p0(kinv-1) - ps0(kinv-1)<a name='1562'>
          else<a name='1563'>
              dpi = p0(k) - p0(k+1)<a name='1564'>
          endif <a name='1565'>
          dpsum  = dpsum  + dpi  <a name='1566'>
          tkeavg = tkeavg + dpi*tke(k) <a name='1567'>
          if( k .ne. 0 ) thvlmin = min(thvlmin,min(thvl0bot(k),thvl0top(k)))<a name='1568'>
       end do<a name='1569'>
       tkeavg  = tkeavg/dpsum<a name='1570'>
<a name='1571'>
       <font color=#447700>! ------------------------------------------------------------------ !<a name='1572'></font>
       <font color=#447700>! Find characteristics of cumulus source air: qtsrc,thlsrc,usrc,vsrc !<a name='1573'></font>
       <font color=#447700>! Note that 'thlsrc' was con-cocked using 'thvlsrc' and 'qtsrc'.     !<a name='1574'></font>
       <font color=#447700>! 'qtsrc' is defined as the lowest layer mid-point value;   'thlsrc' !<a name='1575'></font>
       <font color=#447700>! is from 'qtsrc' and 'thvlmin=thvlsrc'; 'usrc' &amp; 'vsrc' are defined !<a name='1576'></font>
       <font color=#447700>! as the values just below the PBL top interface.                    !<a name='1577'></font>
       <font color=#447700>! ------------------------------------------------------------------ !<a name='1578'></font>
<a name='1579'>
       qtsrc   = qt0(1)                     <a name='1580'>
       thvlsrc = thvlmin <a name='1581'>
       thlsrc  = thvlsrc / ( 1._r8 + zvir * qtsrc )  <a name='1582'>
       usrc    = u0(kinv-1) + ssu0(kinv-1) * ( ps0(kinv-1) - p0(kinv-1) )             <a name='1583'>
       vsrc    = v0(kinv-1) + ssv0(kinv-1) * ( ps0(kinv-1) - p0(kinv-1) )             <a name='1584'>
       do m = 1, ncnst<a name='1585'>
          trsrc(m) = tr0(1,m)<a name='1586'>
       enddo <a name='1587'>
<a name='1588'>
       <font color=#447700>! ------------------------------------------------------------------ !<a name='1589'></font>
       <font color=#447700>! Find LCL of the source air and a layer index containing LCL (klcl) !<a name='1590'></font>
       <font color=#447700>! When the LCL is exactly at the interface, 'klcl' is a layer index  ! <a name='1591'></font>
       <font color=#447700>! having 'plcl' as the lower interface similar to the 'kinv' case.   !<a name='1592'></font>
       <font color=#447700>! In the previous code, I assumed that if LCL is located within the  !<a name='1593'></font>
       <font color=#447700>! lowest model layer ( 1 ) or the top model layer ( mkx ), then  no  !<a name='1594'></font>
       <font color=#447700>! convective adjustment is performed and just exited.   However, in  !<a name='1595'></font>
       <font color=#447700>! the revised code, I relaxed the first constraint and  even though  !<a name='1596'></font>
       <font color=#447700>! LCL is at the lowest model layer, I allowed cumulus convection to  !<a name='1597'></font>
       <font color=#447700>! be initiated. For this case, cumulus convection should be started  !<a name='1598'></font>
       <font color=#447700>! from the PBL top height, as shown in the following code.           !<a name='1599'></font>
       <font color=#447700>! When source air is already saturated even at the surface, klcl is  !<a name='1600'></font>
       <font color=#447700>! set to 1.                                                          !<a name='1601'></font>
       <font color=#447700>! ------------------------------------------------------------------ !<a name='1602'></font>
<a name='1603'>
       plcl = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#QSINVERT'>qsinvert</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSINVERT_1">(qtsrc,thlsrc,ps0(0),qsat)<a name='1604'>
       do k = 0, mkx<a name='1605'>
          if( ps0(k) .lt. plcl ) then<a name='1606'>
              klcl = k<a name='1607'>
              go to 25<a name='1608'>
          endif           <a name='1609'>
       end do<a name='1610'>
       klcl = mkx<a name='1611'>
25     continue<a name='1612'>
       klcl = max(1,klcl)<a name='1613'>
     <a name='1614'>
       if( plcl .lt. 30000._r8 ) then               <a name='1615'>
     <font color=#447700>! if( klcl .eq. mkx ) then          <a name='1616'></font>
           exit_klclmkx(i) = 1._r8<a name='1617'>
           id_exit = .true.<a name='1618'>
           go to 333<a name='1619'>
       endif<a name='1620'>
<a name='1621'>
       <font color=#447700>! ------------------------------------------------------------- !<a name='1622'></font>
       <font color=#447700>! Calculate environmental virtual potential temperature at LCL, !<a name='1623'></font>
       <font color=#447700>!'thv0lcl' which is solely used in the 'cin' calculation. Note  !<a name='1624'></font>
       <font color=#447700>! that 'thv0lcl' is calculated first by calculating  'thl0lcl'  !<a name='1625'></font>
       <font color=#447700>! and 'qt0lcl' at the LCL, and performing 'conden' afterward,   !<a name='1626'></font>
       <font color=#447700>! in fully consistent with the other parts of the code.         !<a name='1627'></font>
       <font color=#447700>! ------------------------------------------------------------- !<a name='1628'></font>
<a name='1629'>
       thl0lcl = thl0(klcl) + ssthl0(klcl) * ( plcl - p0(klcl) )<a name='1630'>
       qt0lcl  = qt0(klcl)  + ssqt0(klcl)  * ( plcl - p0(klcl) )<a name='1631'>
       call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_3">(plcl,thl0lcl,qt0lcl,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='1632'>
       if( id_check .eq. 1 ) then<a name='1633'>
           exit_conden(i) = 1._r8<a name='1634'>
           id_exit = .true.<a name='1635'>
           go to 333<a name='1636'>
       end if<a name='1637'>
       thv0lcl = thj * ( 1._r8 + zvir * qvj - qlj - qij )<a name='1638'>
<a name='1639'>
       <font color=#447700>! ------------------------------------------------------------------------ !<a name='1640'></font>
       <font color=#447700>! Compute Convective Inhibition, 'cin' &amp; 'cinlcl' [J/kg]=[m2/s2] TKE unit. !<a name='1641'></font>
       <font color=#447700>!                                                                          !<a name='1642'></font>
       <font color=#447700>! 'cin' (cinlcl) is computed from the PBL top interface to LFC (LCL) using ! <a name='1643'></font>
       <font color=#447700>! piecewisely reconstructed environmental profiles, assuming environmental !<a name='1644'></font>
       <font color=#447700>! buoyancy profile within each layer ( or from LCL to upper interface in   !<a name='1645'></font>
       <font color=#447700>! each layer ) is simply a linear profile. For the purpose of cin (cinlcl) !<a name='1646'></font>
       <font color=#447700>! calculation, we simply assume that lateral entrainment does not occur in !<a name='1647'></font>
       <font color=#447700>! updrafting cumulus plume, i.e., cumulus source air property is conserved.!<a name='1648'></font>
       <font color=#447700>! Below explains some rules used in the calculations of cin (cinlcl).   In !<a name='1649'></font>
       <font color=#447700>! general, both 'cin' and 'cinlcl' are calculated from a PBL top interface !<a name='1650'></font>
       <font color=#447700>! to LCL and LFC, respectively :                                           !<a name='1651'></font>
       <font color=#447700>! 1. If LCL is lower than the PBL height, cinlcl = 0 and cin is calculated !<a name='1652'></font>
       <font color=#447700>!    from PBL height to LFC.                                               !<a name='1653'></font>
       <font color=#447700>! 2. If LCL is higher than PBL height,   'cinlcl' is calculated by summing !<a name='1654'></font>
       <font color=#447700>!    both positive and negative cloud buoyancy up to LCL using 'single_cin'!<a name='1655'></font>
       <font color=#447700>!    From the LCL to LFC, however, only negative cloud buoyancy is counted !<a name='1656'></font>
       <font color=#447700>!    to calculate final 'cin' upto LFC.                                    !<a name='1657'></font>
       <font color=#447700>! 3. If either 'cin' or 'cinlcl' is negative, they are set to be zero.     !<a name='1658'></font>
       <font color=#447700>! In the below code, 'klfc' is the layer index containing 'LFC' similar to !<a name='1659'></font>
       <font color=#447700>! 'kinv' and 'klcl'.                                                       !<a name='1660'></font>
       <font color=#447700>! ------------------------------------------------------------------------ !<a name='1661'></font>
<a name='1662'>
        cin    = 0._r8<a name='1663'>
        cinlcl = 0._r8<a name='1664'>
        plfc   = 0._r8<a name='1665'>
        klfc   = mkx<a name='1666'>
<a name='1667'>
        <font color=#447700>! ------------------------------------------------------------------------- !<a name='1668'></font>
        <font color=#447700>! Case 1. LCL height is higher than PBL interface ( 'pLCL &lt;= ps0(kinv-1)' ) !<a name='1669'></font>
        <font color=#447700>! ------------------------------------------------------------------------- !<a name='1670'></font>
<a name='1671'>
        if( klcl .ge. kinv ) then<a name='1672'>
<a name='1673'>
            do k = kinv, mkx - 1<a name='1674'>
               if( k .lt. klcl ) then<a name='1675'>
                   thvubot = thvlsrc<a name='1676'>
                   thvutop = thvlsrc  <a name='1677'>
                   cin     = cin + single_cin(ps0(k-1),thv0bot(k),ps0(k),thv0top(k),thvubot,thvutop)<a name='1678'>
               elseif( k .eq. klcl ) then<a name='1679'>
                   <font color=#447700>!----- Bottom to LCL<a name='1680'></font>
                   thvubot = thvlsrc<a name='1681'>
                   thvutop = thvlsrc<a name='1682'>
                   cin     = cin + single_cin(ps0(k-1),thv0bot(k),plcl,thv0lcl,thvubot,thvutop)<a name='1683'>
                   if( cin .lt. 0._r8 ) limit_cinlcl(i) = 1._r8<a name='1684'>
                   cinlcl  = max(cin,0._r8)<a name='1685'>
                   cin     = cinlcl<a name='1686'>
                   <font color=#447700>!----- LCL to Top<a name='1687'></font>
                   thvubot = thvlsrc<a name='1688'>
                   call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_4">(ps0(k),thlsrc,qtsrc,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='1689'>
                   if( id_check .eq. 1 ) then<a name='1690'>
                       exit_conden(i) = 1._r8<a name='1691'>
                       id_exit = .true.<a name='1692'>
                       go to 333<a name='1693'>
                   end if<a name='1694'>
                   thvutop = thj * ( 1._r8 + zvir*qvj - qlj - qij )<a name='1695'>
                   call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#GETBUOY'>getbuoy</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETBUOY_1">(plcl,thv0lcl,ps0(k),thv0top(k),thvubot,thvutop,plfc,cin)<a name='1696'>
                   if( plfc .gt. 0._r8 ) then <a name='1697'>
                       klfc = k <a name='1698'>
                       go to 35<a name='1699'>
                   end if<a name='1700'>
               else<a name='1701'>
                   thvubot = thvutop<a name='1702'>
                   call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_5">(ps0(k),thlsrc,qtsrc,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='1703'>
                   if( id_check .eq. 1 ) then<a name='1704'>
                       exit_conden(i) = 1._r8<a name='1705'>
                       id_exit = .true.<a name='1706'>
                       go to 333<a name='1707'>
                   end if<a name='1708'>
                   thvutop = thj * ( 1._r8 + zvir*qvj - qlj - qij )<a name='1709'>
                   call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#GETBUOY'>getbuoy</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETBUOY_2">(ps0(k-1),thv0bot(k),ps0(k),thv0top(k),thvubot,thvutop,plfc,cin)<a name='1710'>
                   if( plfc .gt. 0._r8 ) then <a name='1711'>
                       klfc = k<a name='1712'>
                       go to 35<a name='1713'>
                   end if <a name='1714'>
               endif<a name='1715'>
            end do        <a name='1716'>
<a name='1717'>
       <font color=#447700>! ----------------------------------------------------------------------- !<a name='1718'></font>
       <font color=#447700>! Case 2. LCL height is lower than PBL interface ( 'pLCL &gt; ps0(kinv-1)' ) !<a name='1719'></font>
       <font color=#447700>! ----------------------------------------------------------------------- !<a name='1720'></font>
<a name='1721'>
       else<a name='1722'>
          cinlcl = 0._r8 <a name='1723'>
          do k = kinv, mkx - 1<a name='1724'>
             call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_6">(ps0(k-1),thlsrc,qtsrc,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='1725'>
             if( id_check .eq. 1 ) then<a name='1726'>
                 exit_conden(i) = 1._r8<a name='1727'>
                 id_exit = .true.<a name='1728'>
                 go to 333<a name='1729'>
             end if<a name='1730'>
             thvubot = thj * ( 1._r8 + zvir*qvj - qlj - qij )<a name='1731'>
             call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_7">(ps0(k),thlsrc,qtsrc,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='1732'>
             if( id_check .eq. 1 ) then<a name='1733'>
                 exit_conden(i) = 1._r8<a name='1734'>
                 id_exit = .true.<a name='1735'>
                 go to 333<a name='1736'>
             end if<a name='1737'>
             thvutop = thj * ( 1._r8 + zvir*qvj - qlj - qij )<a name='1738'>
             call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#GETBUOY'>getbuoy</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETBUOY_3">(ps0(k-1),thv0bot(k),ps0(k),thv0top(k),thvubot,thvutop,plfc,cin)<a name='1739'>
             if( plfc .gt. 0._r8 ) then <a name='1740'>
                 klfc = k<a name='1741'>
                 go to 35<a name='1742'>
             end if <a name='1743'>
          end do<a name='1744'>
       endif  <font color=#447700>! End of CIN case selection<a name='1745'></font>
<a name='1746'>
 35    continue<a name='1747'>
       if( cin .lt. 0._r8 ) limit_cin(i) = 1._r8<a name='1748'>
       cin = max(0._r8,cin)<a name='1749'>
       if( klfc .ge. mkx ) then<a name='1750'>
           klfc = mkx<a name='1751'>
         <font color=#447700>! write(iulog,*) 'klfc &gt;= mkx'<a name='1752'></font>
           exit_klfcmkx(i) = 1._r8<a name='1753'>
           id_exit = .true.<a name='1754'>
           go to 333<a name='1755'>
       endif<a name='1756'>
<a name='1757'>
       <font color=#447700>! ---------------------------------------------------------------------- !<a name='1758'></font>
       <font color=#447700>! In order to calculate implicit 'cin' (or 'cinlcl'), save the initially !<a name='1759'></font>
       <font color=#447700>! calculated 'cin' and 'cinlcl', and other related variables. These will !<a name='1760'></font>
       <font color=#447700>! be restored after calculating implicit CIN.                            !<a name='1761'></font>
       <font color=#447700>! ---------------------------------------------------------------------- !<a name='1762'></font>
<a name='1763'>
       if( iter .eq. 1 ) then <a name='1764'>
           cin_i       = cin<a name='1765'>
           cinlcl_i    = cinlcl<a name='1766'>
           ke          = rbuoy / ( rkfre * tkeavg + epsvarw ) <a name='1767'>
           kinv_o      = kinv     <a name='1768'>
           klcl_o      = klcl     <a name='1769'>
           klfc_o      = klfc    <a name='1770'>
           plcl_o      = plcl    <a name='1771'>
           plfc_o      = plfc     <a name='1772'>
           tkeavg_o    = tkeavg   <a name='1773'>
           thvlmin_o   = thvlmin<a name='1774'>
           qtsrc_o     = qtsrc    <a name='1775'>
           thvlsrc_o   = thvlsrc  <a name='1776'>
           thlsrc_o    = thlsrc<a name='1777'>
           usrc_o      = usrc     <a name='1778'>
           vsrc_o      = vsrc     <a name='1779'>
           thv0lcl_o   = thv0lcl  <a name='1780'>
           do m = 1, ncnst<a name='1781'>
              trsrc_o(m) = trsrc(m)<a name='1782'>
           enddo<a name='1783'>
       endif   <a name='1784'>
<a name='1785'>
     <font color=#447700>! Modification : If I impose w = max(0.1_r8, w) up to the top interface of<a name='1786'></font>
     <font color=#447700>!                klfc, I should only use cinlfc.  That is, if I want to<a name='1787'></font>
     <font color=#447700>!                use cinlcl, I should not impose w = max(0.1_r8, w).<a name='1788'></font>
     <font color=#447700>!                Using cinlcl is equivalent to treating only 'saturated'<a name='1789'></font>
     <font color=#447700>!                moist convection. Note that in this sense, I should keep<a name='1790'></font>
     <font color=#447700>!                the functionality of both cinlfc and cinlcl.<a name='1791'></font>
     <font color=#447700>!                However, the treatment of penetrative entrainment level becomes<a name='1792'></font>
     <font color=#447700>!                ambiguous if I choose 'cinlcl'. Thus, the best option is to use<a name='1793'></font>
     <font color=#447700>!                'cinlfc'.<a name='1794'></font>
<a name='1795'>
       <font color=#447700>! -------------------------------------------------------------------------- !<a name='1796'></font>
       <font color=#447700>! Calculate implicit 'cin' by averaging initial and final cins.    Note that !<a name='1797'></font>
       <font color=#447700>! implicit CIN is adopted only when cumulus convection stabilized the system,!<a name='1798'></font>
       <font color=#447700>! i.e., only when 'del_CIN &gt;0'. If 'del_CIN&lt;=0', just use explicit CIN. Note !<a name='1799'></font>
       <font color=#447700>! also that since 'cinlcl' is set to zero whenever LCL is below the PBL top, !<a name='1800'></font>
       <font color=#447700>! (see above CIN calculation part), the use of 'implicit CIN=cinlcl'  is not !<a name='1801'></font>
       <font color=#447700>! good. Thus, when using implicit CIN, always try to only use 'implicit CIN= !<a name='1802'></font>
       <font color=#447700>! cin', not 'implicit CIN=cinlcl'. However, both 'CIN=cin' and 'CIN=cinlcl'  !<a name='1803'></font>
       <font color=#447700>! are good when using explicit CIN.                                          !<a name='1804'></font>
       <font color=#447700>! -------------------------------------------------------------------------- !<a name='1805'></font>
<a name='1806'>
       if( iter .ne. 1 ) then<a name='1807'>
<a name='1808'>
           cin_f = cin<a name='1809'>
           cinlcl_f = cinlcl<a name='1810'>
           if( use_CINcin ) then<a name='1811'>
               del_CIN = cin_f - cin_i<a name='1812'>
           else<a name='1813'>
               del_CIN = cinlcl_f - cinlcl_i<a name='1814'>
           endif<a name='1815'>
<a name='1816'>
           if( del_CIN .gt. 0._r8 ) then<a name='1817'>
<a name='1818'>
               <font color=#447700>! -------------------------------------------------------------- ! <a name='1819'></font>
               <font color=#447700>! Calculate implicit 'cin' and 'cinlcl'. Note that when we chose !<a name='1820'></font>
               <font color=#447700>! to use 'implicit CIN = cin', choose 'cinlcl = cinlcl_i' below: !<a name='1821'></font>
               <font color=#447700>! because iterative CIN only aims to obtain implicit CIN,  once  !<a name='1822'></font>
               <font color=#447700>! we obtained 'implicit CIN=cin', it is good to use the original !<a name='1823'></font>
               <font color=#447700>! profiles information for all the other variables after that.   !<a name='1824'></font>
               <font color=#447700>! Note 'cinlcl' will be explicitly used in calculating  'wlcl' &amp; !<a name='1825'></font>
               <font color=#447700>! 'ufrclcl' after calculating 'winv' &amp; 'ufrcinv'  at the PBL top !<a name='1826'></font>
               <font color=#447700>! interface later, after calculating 'cbmf'.                     !<a name='1827'></font>
               <font color=#447700>! -------------------------------------------------------------- !<a name='1828'></font>
         <a name='1829'>
               alpha = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_ALPHA'>compute_alpha</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_ALPHA_1">( del_CIN, ke ) <a name='1830'>
               cin   = cin_i + alpha * del_CIN<a name='1831'>
               if( use_CINcin ) then<a name='1832'>
                   cinlcl = cinlcl_i                 <a name='1833'>
               else<a name='1834'>
                   cinlcl = cinlcl_i + alpha * del_cinlcl   <a name='1835'>
               endif<a name='1836'>
<a name='1837'>
               <font color=#447700>! ----------------------------------------------------------------- !<a name='1838'></font>
               <font color=#447700>! Restore the original values from the previous 'iter_cin' step (1) !<a name='1839'></font>
               <font color=#447700>! to compute correct tendencies for (n+1) time step by implicit CIN !<a name='1840'></font>
               <font color=#447700>! ----------------------------------------------------------------- !<a name='1841'></font>
<a name='1842'>
               kinv      = kinv_o     <a name='1843'>
               klcl      = klcl_o     <a name='1844'>
               klfc      = klfc_o    <a name='1845'>
               plcl      = plcl_o    <a name='1846'>
               plfc      = plfc_o     <a name='1847'>
               tkeavg    = tkeavg_o   <a name='1848'>
               thvlmin   = thvlmin_o<a name='1849'>
               qtsrc     = qtsrc_o    <a name='1850'>
               thvlsrc   = thvlsrc_o  <a name='1851'>
               thlsrc    = thlsrc_o<a name='1852'>
               usrc      = usrc_o     <a name='1853'>
               vsrc      = vsrc_o     <a name='1854'>
               thv0lcl   = thv0lcl_o  <a name='1855'>
               do m = 1, ncnst<a name='1856'>
                  trsrc(m) = trsrc_o(m)<a name='1857'>
               enddo<a name='1858'>
<a name='1859'>
               qv0(:mkx)            = qv0_o(:mkx)<a name='1860'>
               ql0(:mkx)            = ql0_o(:mkx)<a name='1861'>
               qi0(:mkx)            = qi0_o(:mkx)<a name='1862'>
               t0(:mkx)             = t0_o(:mkx)<a name='1863'>
               s0(:mkx)             = s0_o(:mkx)<a name='1864'>
               u0(:mkx)             = u0_o(:mkx)<a name='1865'>
               v0(:mkx)             = v0_o(:mkx)<a name='1866'>
               qt0(:mkx)            = qt0_o(:mkx)<a name='1867'>
               thl0(:mkx)           = thl0_o(:mkx)<a name='1868'>
               thvl0(:mkx)          = thvl0_o(:mkx)<a name='1869'>
               ssthl0(:mkx)         = ssthl0_o(:mkx)<a name='1870'>
               ssqt0(:mkx)          = ssqt0_o(:mkx)<a name='1871'>
               thv0bot(:mkx)        = thv0bot_o(:mkx)<a name='1872'>
               thv0top(:mkx)        = thv0top_o(:mkx)<a name='1873'>
               thvl0bot(:mkx)       = thvl0bot_o(:mkx)<a name='1874'>
               thvl0top(:mkx)       = thvl0top_o(:mkx)<a name='1875'>
               ssu0(:mkx)           = ssu0_o(:mkx) <a name='1876'>
               ssv0(:mkx)           = ssv0_o(:mkx) <a name='1877'>
               do m = 1, ncnst<a name='1878'>
                  tr0(:mkx,m)   = tr0_o(:mkx,m)<a name='1879'>
                  sstr0(:mkx,m) = sstr0_o(:mkx,m)<a name='1880'>
               enddo<a name='1881'>
<a name='1882'>
               <font color=#447700>! ------------------------------------------------------ !<a name='1883'></font>
               <font color=#447700>! Initialize all fluxes, tendencies, and other variables ! <a name='1884'></font>
               <font color=#447700>! in association with cumulus convection.                !<a name='1885'></font>
               <font color=#447700>! ------------------------------------------------------ ! <a name='1886'></font>
<a name='1887'>
               umf(0:mkx)          = 0.0_r8<a name='1888'>
               emf(0:mkx)          = 0.0_r8<a name='1889'>
               slflx(0:mkx)        = 0.0_r8<a name='1890'>
               qtflx(0:mkx)        = 0.0_r8<a name='1891'>
               uflx(0:mkx)         = 0.0_r8<a name='1892'>
               vflx(0:mkx)         = 0.0_r8<a name='1893'>
               qvten(:mkx)         = 0.0_r8<a name='1894'>
               qlten(:mkx)         = 0.0_r8<a name='1895'>
               qiten(:mkx)         = 0.0_r8<a name='1896'>
               sten(:mkx)          = 0.0_r8<a name='1897'>
               uten(:mkx)          = 0.0_r8<a name='1898'>
               vten(:mkx)          = 0.0_r8<a name='1899'>
               qrten(:mkx)         = 0.0_r8<a name='1900'>
               qsten(:mkx)         = 0.0_r8<a name='1901'>
               dwten(:mkx)         = 0.0_r8<a name='1902'>
               diten(:mkx)         = 0.0_r8<a name='1903'>
               precip              = 0.0_r8<a name='1904'>
               snow                = 0.0_r8<a name='1905'>
               evapc(:mkx)         = 0.0_r8<a name='1906'>
               cufrc(:mkx)         = 0.0_r8<a name='1907'>
               qcu(:mkx)           = 0.0_r8<a name='1908'>
               qlu(:mkx)           = 0.0_r8<a name='1909'>
               qiu(:mkx)           = 0.0_r8<a name='1910'>
               fer(:mkx)           = 0.0_r8<a name='1911'>
               fdr(:mkx)           = 0.0_r8<a name='1912'>
               qc(:mkx)            = 0.0_r8<a name='1913'>
               qc_l(:mkx)          = 0.0_r8<a name='1914'>
               qc_i(:mkx)          = 0.0_r8<a name='1915'>
               rliq                = 0.0_r8<a name='1916'>
               cbmf                = 0.0_r8<a name='1917'>
               cnt                 = real(mkx, r8)<a name='1918'>
               cnb                 = 0.0_r8<a name='1919'>
               qtten(:mkx)         = 0.0_r8<a name='1920'>
               slten(:mkx)         = 0.0_r8<a name='1921'>
               ufrc(0:mkx)         = 0.0_r8<a name='1922'>
<a name='1923'>
               thlu(0:mkx)         = 0.0_r8<a name='1924'>
               qtu(0:mkx)          = 0.0_r8<a name='1925'>
               uu(0:mkx)           = 0.0_r8<a name='1926'>
               vu(0:mkx)           = 0.0_r8<a name='1927'>
               wu(0:mkx)           = 0.0_r8<a name='1928'>
               thvu(0:mkx)         = 0.0_r8<a name='1929'>
               thlu_emf(0:mkx)     = 0.0_r8<a name='1930'>
               qtu_emf(0:mkx)      = 0.0_r8<a name='1931'>
               uu_emf(0:mkx)       = 0.0_r8<a name='1932'>
               vu_emf(0:mkx)       = 0.0_r8<a name='1933'>
             <a name='1934'>
               do m = 1, ncnst<a name='1935'>
                  trflx(0:mkx,m)   = 0.0_r8<a name='1936'>
                  trten(:mkx,m)    = 0.0_r8<a name='1937'>
                  tru(0:mkx,m)     = 0.0_r8<a name='1938'>
                  tru_emf(0:mkx,m) = 0.0_r8<a name='1939'>
               enddo<a name='1940'>
<a name='1941'>
               <font color=#447700>! -------------------------------------------------- !<a name='1942'></font>
               <font color=#447700>! Below are diagnostic output variables for detailed !<a name='1943'></font>
               <font color=#447700>! analysis of cumulus scheme.                        !<a name='1944'></font>
               <font color=#447700>! -------------------------------------------------- ! <a name='1945'></font>
<a name='1946'>
               ufrcinvbase         = 0.0_r8<a name='1947'>
               ufrclcl             = 0.0_r8<a name='1948'>
               winvbase            = 0.0_r8<a name='1949'>
               wlcl                = 0.0_r8<a name='1950'>
               emfkbup             = 0.0_r8 <a name='1951'>
               cbmflimit           = 0.0_r8<a name='1952'>
               excessu_arr(:mkx)   = 0.0_r8<a name='1953'>
               excess0_arr(:mkx)   = 0.0_r8<a name='1954'>
               xc_arr(:mkx)        = 0.0_r8<a name='1955'>
               aquad_arr(:mkx)     = 0.0_r8<a name='1956'>
               bquad_arr(:mkx)     = 0.0_r8<a name='1957'>
               cquad_arr(:mkx)     = 0.0_r8<a name='1958'>
               bogbot_arr(:mkx)    = 0.0_r8<a name='1959'>
               bogtop_arr(:mkx)    = 0.0_r8<a name='1960'>
<a name='1961'>
          else <font color=#447700>! When 'del_CIN &lt; 0', use explicit CIN instead of implicit CIN.<a name='1962'></font>
           <a name='1963'>
               <font color=#447700>! ----------------------------------------------------------- ! <a name='1964'></font>
               <font color=#447700>! Identifier showing whether explicit or implicit CIN is used !<a name='1965'></font>
               <font color=#447700>! ----------------------------------------------------------- ! <a name='1966'></font>
<a name='1967'>
               ind_delcin(i) = 1._r8             <a name='1968'>
   <a name='1969'>
               <font color=#447700>! --------------------------------------------------------- !<a name='1970'></font>
               <font color=#447700>! Restore original output values of "iter_cin = 1" and exit !<a name='1971'></font>
               <font color=#447700>! --------------------------------------------------------- !<a name='1972'></font>
<a name='1973'>
               umf_out(i,0:mkx)         = umf_s(0:mkx)<a name='1974'>
               qvten_out(i,:mkx)        = qvten_s(:mkx)<a name='1975'>
               qlten_out(i,:mkx)        = qlten_s(:mkx)  <a name='1976'>
               qiten_out(i,:mkx)        = qiten_s(:mkx)<a name='1977'>
               sten_out(i,:mkx)         = sten_s(:mkx)<a name='1978'>
               uten_out(i,:mkx)         = uten_s(:mkx)  <a name='1979'>
               vten_out(i,:mkx)         = vten_s(:mkx)<a name='1980'>
               qrten_out(i,:mkx)        = qrten_s(:mkx)<a name='1981'>
               qsten_out(i,:mkx)        = qsten_s(:mkx)  <a name='1982'>
               precip_out(i)            = precip_s<a name='1983'>
               snow_out(i)              = snow_s<a name='1984'>
               evapc_out(i,:mkx)        = evapc_s(:mkx)<a name='1985'>
               cush_inout(i)            = cush_s<a name='1986'>
               cufrc_out(i,:mkx)        = cufrc_s(:mkx)  <a name='1987'>
               slflx_out(i,0:mkx)       = slflx_s(0:mkx)  <a name='1988'>
               qtflx_out(i,0:mkx)       = qtflx_s(0:mkx)<a name='1989'>
               qcu_out(i,:mkx)          = qcu_s(:mkx)    <a name='1990'>
               qlu_out(i,:mkx)          = qlu_s(:mkx)  <a name='1991'>
               qiu_out(i,:mkx)          = qiu_s(:mkx)  <a name='1992'>
               cbmf_out(i)              = cbmf_s<a name='1993'>
               qc_out(i,:mkx)           = qc_s(:mkx)  <a name='1994'>
               rliq_out(i)              = rliq_s<a name='1995'>
               cnt_out(i)               = cnt_s<a name='1996'>
               cnb_out(i)               = cnb_s<a name='1997'>
               do m = 1, ncnst<a name='1998'>
                  trten_out(i,:mkx,m)   = trten_s(:mkx,m)<a name='1999'>
               enddo  <a name='2000'>
             <a name='2001'>
               <font color=#447700>! ------------------------------------------------------------------------------ ! <a name='2002'></font>
               <font color=#447700>! Below are diagnostic output variables for detailed analysis of cumulus scheme. !<a name='2003'></font>
               <font color=#447700>! The order of vertical index is reversed for this internal diagnostic output.   !<a name='2004'></font>
               <font color=#447700>! ------------------------------------------------------------------------------ !   <a name='2005'></font>
<a name='2006'>
               fer_out(i,mkx:1:-1)      = fer_s(:mkx)  <a name='2007'>
               fdr_out(i,mkx:1:-1)      = fdr_s(:mkx)  <a name='2008'>
               cinh_out(i)              = cin_s<a name='2009'>
               cinlclh_out(i)           = cinlcl_s<a name='2010'>
               qtten_out(i,mkx:1:-1)    = qtten_s(:mkx)<a name='2011'>
               slten_out(i,mkx:1:-1)    = slten_s(:mkx)<a name='2012'>
               ufrc_out(i,mkx:0:-1)     = ufrc_s(0:mkx)<a name='2013'>
               uflx_out(i,mkx:0:-1)     = uflx_s(0:mkx)  <a name='2014'>
               vflx_out(i,mkx:0:-1)     = vflx_s(0:mkx)  <a name='2015'>
<a name='2016'>
               ufrcinvbase_out(i)       = ufrcinvbase_s<a name='2017'>
               ufrclcl_out(i)           = ufrclcl_s <a name='2018'>
               winvbase_out(i)          = winvbase_s<a name='2019'>
               wlcl_out(i)              = wlcl_s<a name='2020'>
               plcl_out(i)              = plcl_s<a name='2021'>
               pinv_out(i)              = pinv_s    <a name='2022'>
               plfc_out(i)              = plfc_s    <a name='2023'>
               pbup_out(i)              = pbup_s<a name='2024'>
               ppen_out(i)              = ppen_s    <a name='2025'>
               qtsrc_out(i)             = qtsrc_s<a name='2026'>
               thlsrc_out(i)            = thlsrc_s<a name='2027'>
               thvlsrc_out(i)           = thvlsrc_s<a name='2028'>
               emfkbup_out(i)           = emfkbup_s<a name='2029'>
               cbmflimit_out(i)         = cbmflimit_s<a name='2030'>
               tkeavg_out(i)            = tkeavg_s<a name='2031'>
               zinv_out(i)              = zinv_s<a name='2032'>
               rcwp_out(i)              = rcwp_s<a name='2033'>
               rlwp_out(i)              = rlwp_s<a name='2034'>
               riwp_out(i)              = riwp_s<a name='2035'>
<a name='2036'>
               wu_out(i,mkx:0:-1)       = wu_s(0:mkx)<a name='2037'>
               qtu_out(i,mkx:0:-1)      = qtu_s(0:mkx)<a name='2038'>
               thlu_out(i,mkx:0:-1)     = thlu_s(0:mkx)<a name='2039'>
               thvu_out(i,mkx:0:-1)     = thvu_s(0:mkx)<a name='2040'>
               uu_out(i,mkx:0:-1)       = uu_s(0:mkx)<a name='2041'>
               vu_out(i,mkx:0:-1)       = vu_s(0:mkx)<a name='2042'>
               qtu_emf_out(i,mkx:0:-1)  = qtu_emf_s(0:mkx)<a name='2043'>
               thlu_emf_out(i,mkx:0:-1) = thlu_emf_s(0:mkx)<a name='2044'>
               uu_emf_out(i,mkx:0:-1)   = uu_emf_s(0:mkx)<a name='2045'>
               vu_emf_out(i,mkx:0:-1)   = vu_emf_s(0:mkx)<a name='2046'>
               uemf_out(i,mkx:0:-1)     = uemf_s(0:mkx)<a name='2047'>
<a name='2048'>
               dwten_out(i,mkx:1:-1)    = dwten_s(:mkx)<a name='2049'>
               diten_out(i,mkx:1:-1)    = diten_s(:mkx)<a name='2050'>
               flxrain_out(i,mkx:0:-1)  = flxrain_s(0:mkx)<a name='2051'>
               flxsnow_out(i,mkx:0:-1)  = flxsnow_s(0:mkx)<a name='2052'>
               ntraprd_out(i,mkx:1:-1)  = ntraprd_s(:mkx)<a name='2053'>
               ntsnprd_out(i,mkx:1:-1)  = ntsnprd_s(:mkx)<a name='2054'>
<a name='2055'>
               excessu_arr_out(i,mkx:1:-1)  = excessu_arr_s(:mkx)<a name='2056'>
               excess0_arr_out(i,mkx:1:-1)  = excess0_arr_s(:mkx)<a name='2057'>
               xc_arr_out(i,mkx:1:-1)       = xc_arr_s(:mkx)<a name='2058'>
               aquad_arr_out(i,mkx:1:-1)    = aquad_arr_s(:mkx)<a name='2059'>
               bquad_arr_out(i,mkx:1:-1)    = bquad_arr_s(:mkx)<a name='2060'>
               cquad_arr_out(i,mkx:1:-1)    = cquad_arr_s(:mkx)<a name='2061'>
               bogbot_arr_out(i,mkx:1:-1)   = bogbot_arr_s(:mkx)<a name='2062'>
               bogtop_arr_out(i,mkx:1:-1)   = bogtop_arr_s(:mkx)<a name='2063'>
<a name='2064'>
               do m = 1, ncnst<a name='2065'>
                  trflx_out(i,mkx:0:-1,m)   = trflx_s(0:mkx,m)  <a name='2066'>
                  tru_out(i,mkx:0:-1,m)     = tru_s(0:mkx,m)<a name='2067'>
                  tru_emf_out(i,mkx:0:-1,m) = tru_emf_s(0:mkx,m)<a name='2068'>
               enddo<a name='2069'>
<a name='2070'>
               id_exit = .false.<a name='2071'>
               go to 333<a name='2072'>
<a name='2073'>
          endif<a name='2074'>
<a name='2075'>
       endif    <a name='2076'>
<a name='2077'>
       <font color=#447700>! ------------------------------------------------------------------ !<a name='2078'></font>
       <font color=#447700>! Define a release level, 'prel' and release layer, 'krel'.          !<a name='2079'></font>
       <font color=#447700>! 'prel' is the lowest level from which buoyancy sorting occurs, and !<a name='2080'></font>
       <font color=#447700>! 'krel' is the layer index containing 'prel' in it, similar to  the !<a name='2081'></font>
       <font color=#447700>! previous definitions of 'kinv', 'klcl', and 'klfc'.    In order to !<a name='2082'></font>
       <font color=#447700>! ensure that only PBL scheme works within the PBL,  if LCL is below !<a name='2083'></font>
       <font color=#447700>! PBL top height, then 'krel = kinv', while if LCL is above  PBL top !<a name='2084'></font>
       <font color=#447700>! height, then 'krel = klcl'.   Note however that regardless of  the !<a name='2085'></font>
       <font color=#447700>! definition of 'krel', cumulus convection induces fluxes within PBL !<a name='2086'></font>
       <font color=#447700>! through 'fluxbelowinv'.  We can make cumulus convection start from !<a name='2087'></font>
       <font color=#447700>! any level, even within the PBL by appropriately defining 'krel'  &amp; !<a name='2088'></font>
       <font color=#447700>! 'prel' here. Then it must be accompanied by appropriate definition !<a name='2089'></font>
       <font color=#447700>! of source air properties, CIN, and re-setting of 'fluxbelowinv', &amp; !<a name='2090'></font>
       <font color=#447700>! many other stuffs.                                                 !<a name='2091'></font>
       <font color=#447700>! Note that even when 'prel' is located above the PBL top height, we !<a name='2092'></font>
       <font color=#447700>! still have cumulus convection between PBL top height and 'prel':   !<a name='2093'></font>
       <font color=#447700>! we simply assume that no lateral mixing occurs in this range.      !<a name='2094'></font>
       <font color=#447700>! ------------------------------------------------------------------ !<a name='2095'></font>
<a name='2096'>
       if( klcl .lt. kinv ) then<a name='2097'>
           krel    = kinv<a name='2098'>
           prel    = ps0(krel-1)<a name='2099'>
           thv0rel = thv0bot(krel) <a name='2100'>
       else<a name='2101'>
           krel    = klcl<a name='2102'>
           prel    = plcl <a name='2103'>
           thv0rel = thv0lcl<a name='2104'>
       endif  <a name='2105'>
<a name='2106'>
       <font color=#447700>! --------------------------------------------------------------------------- !<a name='2107'></font>
       <font color=#447700>! Calculate cumulus base mass flux ('cbmf'), fractional area ('ufrcinv'), and !<a name='2108'></font>
       <font color=#447700>! and mean vertical velocity (winv) of cumulus updraft at PBL top interface.  !<a name='2109'></font>
       <font color=#447700>! Also, calculate updraft fractional area (ufrclcl) and vertical velocity  at !<a name='2110'></font>
       <font color=#447700>! the LCL (wlcl). When LCL is below PBLH, cinlcl = 0 and 'ufrclcl = ufrcinv', !<a name='2111'></font>
       <font color=#447700>! and 'wlcl = winv.                                                           !<a name='2112'></font>
       <font color=#447700>! Only updrafts strong enough to overcome CIN can rise over PBL top interface.! <a name='2113'></font>
       <font color=#447700>! Thus,  in order to calculate cumulus mass flux at PBL top interface, 'cbmf',!<a name='2114'></font>
       <font color=#447700>! we need to know 'CIN' ( the strength of potential energy barrier ) and      !<a name='2115'></font>
       <font color=#447700>! 'sigmaw' ( a standard deviation of updraft vertical velocity at the PBL top !<a name='2116'></font>
       <font color=#447700>! interface, a measure of turbulentce strength in the PBL ).   Naturally, the !<a name='2117'></font>
       <font color=#447700>! ratio of these two variables, 'mu' - normalized CIN by TKE- is key variable !<a name='2118'></font>
       <font color=#447700>! controlling 'cbmf'.  If 'mu' becomes large, only small fraction of updrafts !<a name='2119'></font>
       <font color=#447700>! with very strong TKE can rise over the PBL - both 'cbmf' and 'ufrc' becomes !<a name='2120'></font>
       <font color=#447700>! small, but 'winv' becomes large ( this can be easily understood by PDF of w !<a name='2121'></font>
       <font color=#447700>! at PBL top ).  If 'mu' becomes small, lots of updraft can rise over the PBL !<a name='2122'></font>
       <font color=#447700>! top - both 'cbmf' and 'ufrc' becomes large, but 'winv' becomes small. Thus, !<a name='2123'></font>
       <font color=#447700>! all of the key variables associated with cumulus convection  at the PBL top !<a name='2124'></font>
       <font color=#447700>! - 'cbmf', 'ufrc', 'winv' where 'cbmf = rho*ufrc*winv' - are a unique functi !<a name='2125'></font>
       <font color=#447700>! ons of 'mu', normalized CIN. Although these are uniquely determined by 'mu',! <a name='2126'></font>
       <font color=#447700>! we usually impose two comstraints on 'cbmf' and 'ufrc': (1) because we will !<a name='2127'></font>
       <font color=#447700>! simply assume that subsidence warming and drying of 'kinv-1' layer in assoc !<a name='2128'></font>
       <font color=#447700>! iation with 'cbmf' at PBL top interface is confined only in 'kinv-1' layer, !<a name='2129'></font>
       <font color=#447700>! cbmf must not be larger than the mass within the 'kinv-1' layer. Otherwise, !<a name='2130'></font>
       <font color=#447700>! instability will occur due to the breaking of stability con. If we consider !<a name='2131'></font>
       <font color=#447700>! semi-Lagrangian vertical advection scheme and explicitly consider the exten !<a name='2132'></font>
       <font color=#447700>! t of vertical movement of each layer in association with cumulus mass flux, !<a name='2133'></font>
       <font color=#447700>! we don't need to impose this constraint. However,  using a  semi-Lagrangian !<a name='2134'></font>
       <font color=#447700>! scheme is a future research subject. Note that this constraint should be ap !<a name='2135'></font>
       <font color=#447700>! plied for all interfaces above PBL top as well as PBL top interface.   As a !<a name='2136'></font>
       <font color=#447700>! result, this 'cbmf' constraint impose a 'lower' limit on mu - 'mumin0'. (2) !<a name='2137'></font>
       <font color=#447700>! in order for mass flux parameterization - rho*(w'a')= M*(a_c-a_e) - to   be !<a name='2138'></font>
       <font color=#447700>! valid, cumulus updraft fractional area should be much smaller than 1.    In !<a name='2139'></font>
       <font color=#447700>! current code, we impose 'rmaxfrac = 0.1 ~ 0.2'   through the whole vertical !<a name='2140'></font>
       <font color=#447700>! layers where cumulus convection occurs. At the PBL top interface,  the same !<a name='2141'></font>
       <font color=#447700>! constraint is made by imposing another lower 'lower' limit on mu, 'mumin1'. !<a name='2142'></font>
       <font color=#447700>! After that, also limit 'ufrclcl' to be smaller than 'rmaxfrac' by 'mumin2'. !<a name='2143'></font>
       <font color=#447700>! --------------------------------------------------------------------------- !<a name='2144'></font>
       <a name='2145'>
       <font color=#447700>! --------------------------------------------------------------------------- !<a name='2146'></font>
       <font color=#447700>! Calculate normalized CIN, 'mu' satisfying all the three constraints imposed !<a name='2147'></font>
       <font color=#447700>! on 'cbmf'('mumin0'), 'ufrc' at the PBL top - 'ufrcinv' - ( by 'mumin1' from !<a name='2148'></font>
       <font color=#447700>! a parameter sentence), and 'ufrc' at the LCL - 'ufrclcl' ( by 'mumin2').    !<a name='2149'></font>
       <font color=#447700>! Note that 'cbmf' does not change between PBL top and LCL  because we assume !<a name='2150'></font>
       <font color=#447700>! that buoyancy sorting does not occur when cumulus updraft is unsaturated.   !<a name='2151'></font>
       <font color=#447700>! --------------------------------------------------------------------------- !<a name='2152'></font>
   <a name='2153'>
       if( use_CINcin ) then       <a name='2154'>
           wcrit = sqrt( 2._r8 * cin * rbuoy )      <a name='2155'>
       else<a name='2156'>
           wcrit = sqrt( 2._r8 * cinlcl * rbuoy )   <a name='2157'>
       endif<a name='2158'>
       sigmaw = sqrt( rkfre * tkeavg + epsvarw )<a name='2159'>
       mu = wcrit/sigmaw/1.4142_r8                  <a name='2160'>
       if( mu .ge. 3._r8 ) then<a name='2161'>
         <font color=#447700>! write(iulog,*) 'mu &gt;= 3'<a name='2162'></font>
           id_exit = .true.<a name='2163'>
           go to 333<a name='2164'>
       endif<a name='2165'>
       rho0inv = ps0(kinv-1)/(r*thv0top(kinv-1)*exns0(kinv-1))<a name='2166'>
       cbmf = (rho0inv*sigmaw/2.5066_r8)*exp(-mu**2)<a name='2167'>
       <font color=#447700>! 1. 'cbmf' constraint<a name='2168'></font>
       cbmflimit = 0.9_r8*dp0(kinv-1)/g/dt<a name='2169'>
       mumin0 = 0._r8<a name='2170'>
       if( cbmf .gt. cbmflimit ) mumin0 = sqrt(-log(2.5066_r8*cbmflimit/rho0inv/sigmaw))<a name='2171'>
       <font color=#447700>! 2. 'ufrcinv' constraint<a name='2172'></font>
       mu = max(max(mu,mumin0),mumin1)<a name='2173'>
       <font color=#447700>! 3. 'ufrclcl' constraint      <a name='2174'></font>
       mulcl = sqrt(2._r8*cinlcl*rbuoy)/1.4142_r8/sigmaw<a name='2175'>
       mulclstar = sqrt(max(0._r8,2._r8*(exp(-mu**2)/2.5066_r8)**2*(1._r8/erfc(mu)**2-0.25_r8/rmaxfrac**2)))<a name='2176'>
       if( mulcl .gt. 1.e-8_r8 .and. mulcl .gt. mulclstar ) then<a name='2177'>
           mumin2 = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_MUMIN2'>compute_mumin2</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_MUMIN2_1">(mulcl,rmaxfrac,mu)<a name='2178'>
           if( mu .gt. mumin2 ) then<a name='2179'>
               write(iulog,*) 'Critical error in mu calculation in UW_ShCu'<a name='2180'>
#ifdef WRF_PORT<a name='2181'>
               call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1053">(iulog)<a name='2182'>
#endif<a name='2183'>
               call <A href='../../html_code/phys/module_sf_clm.F.html#ENDRUN'>endrun</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENDRUN_159"><a name='2184'>
           endif<a name='2185'>
           mu = max(mu,mumin2)<a name='2186'>
           if( mu .eq. mumin2 ) limit_ufrc(i) = 1._r8<a name='2187'>
       endif<a name='2188'>
       if( mu .eq. mumin0 ) limit_cbmf(i) = 1._r8<a name='2189'>
       if( mu .eq. mumin1 ) limit_ufrc(i) = 1._r8<a name='2190'>
<a name='2191'>
       <font color=#447700>! ------------------------------------------------------------------- !    <a name='2192'></font>
       <font color=#447700>! Calculate final ['cbmf','ufrcinv','winv'] at the PBL top interface. !<a name='2193'></font>
       <font color=#447700>! Note that final 'cbmf' here is obtained in such that 'ufrcinv' and  !<a name='2194'></font>
       <font color=#447700>! 'ufrclcl' are smaller than ufrcmax with no instability.             !<a name='2195'></font>
       <font color=#447700>! ------------------------------------------------------------------- !<a name='2196'></font>
<a name='2197'>
       cbmf = (rho0inv*sigmaw/2.5066_r8)*exp(-mu**2)                       <a name='2198'>
       winv = sigmaw*(2._r8/2.5066_r8)*exp(-mu**2)/erfc(mu)<a name='2199'>
       ufrcinv = cbmf/winv/rho0inv<a name='2200'>
<a name='2201'>
       <font color=#447700>! ------------------------------------------------------------------- !<a name='2202'></font>
       <font color=#447700>! Calculate ['ufrclcl','wlcl'] at the LCL. When LCL is below PBL top, !<a name='2203'></font>
       <font color=#447700>! it automatically becomes 'ufrclcl = ufrcinv' &amp; 'wlcl = winv', since !<a name='2204'></font>
       <font color=#447700>! it was already set to 'cinlcl=0' if LCL is below PBL top interface. !<a name='2205'></font>
       <font color=#447700>! Note 'cbmf' at the PBL top is the same as 'cbmf' at the LCL.  Note  !<a name='2206'></font>
       <font color=#447700>! also that final 'cbmf' here is obtained in such that 'ufrcinv' and  !<a name='2207'></font>
       <font color=#447700>! 'ufrclcl' are smaller than ufrcmax and there is no instability.     !<a name='2208'></font>
       <font color=#447700>! By construction, it must be 'wlcl &gt; 0' but for assurance, I checked !<a name='2209'></font>
       <font color=#447700>! this again in the below block. If 'ufrclcl &lt; 0.1%', just exit.      !<a name='2210'></font>
       <font color=#447700>! ------------------------------------------------------------------- !<a name='2211'></font>
<a name='2212'>
       wtw = winv * winv - 2._r8 * cinlcl * rbuoy<a name='2213'>
       if( wtw .le. 0._r8 ) then<a name='2214'>
         <font color=#447700>! write(iulog,*) 'wlcl &lt; 0 at the LCL'<a name='2215'></font>
           exit_wtw(i) = 1._r8<a name='2216'>
           id_exit = .true.<a name='2217'>
           go to 333<a name='2218'>
       endif<a name='2219'>
       wlcl = sqrt(wtw)<a name='2220'>
       ufrclcl = cbmf/wlcl/rho0inv<a name='2221'>
       wrel = wlcl<a name='2222'>
       if( ufrclcl .le. 0.0001_r8 ) then<a name='2223'>
         <font color=#447700>! write(iulog,*) 'ufrclcl &lt;= 0.0001' <a name='2224'></font>
           exit_ufrc(i) = 1._r8<a name='2225'>
           id_exit = .true.<a name='2226'>
           go to 333<a name='2227'>
       endif<a name='2228'>
       ufrc(krel-1) = ufrclcl<a name='2229'>
<a name='2230'>
       <font color=#447700>! ----------------------------------------------------------------------- !<a name='2231'></font>
       <font color=#447700>! Below is just diagnostic output for detailed analysis of cumulus scheme !<a name='2232'></font>
       <font color=#447700>! ----------------------------------------------------------------------- !<a name='2233'></font>
<a name='2234'>
       ufrcinvbase        = ufrcinv<a name='2235'>
       winvbase           = winv<a name='2236'>
       umf(kinv-1:krel-1) = cbmf   <a name='2237'>
       wu(kinv-1:krel-1)  = winv   <a name='2238'>
<a name='2239'>
       <font color=#447700>! -------------------------------------------------------------------------- ! <a name='2240'></font>
       <font color=#447700>! Define updraft properties at the level where buoyancy sorting starts to be !<a name='2241'></font>
       <font color=#447700>! happening, i.e., by definition, at 'prel' level within the release layer.  !<a name='2242'></font>
       <font color=#447700>! Because no lateral entrainment occurs upto 'prel', conservative scalars of ! <a name='2243'></font>
       <font color=#447700>! cumulus updraft at release level is same as those of source air.  However, ! <a name='2244'></font>
       <font color=#447700>! horizontal momentums of source air are modified by horizontal PGF forcings ! <a name='2245'></font>
       <font color=#447700>! from PBL top interface to 'prel'.  For this case, we should add additional !<a name='2246'></font>
       <font color=#447700>! horizontal momentum from PBL top interface to 'prel' as will be done below !<a name='2247'></font>
       <font color=#447700>! to 'usrc' and 'vsrc'. Note that below cumulus updraft properties - umf, wu,!<a name='2248'></font>
       <font color=#447700>! thlu, qtu, thvu, uu, vu - are defined all interfaces not at the layer mid- !<a name='2249'></font>
       <font color=#447700>! point. From the index notation of cumulus scheme, wu(k) is the cumulus up- !<a name='2250'></font>
       <font color=#447700>! draft vertical velocity at the top interface of k layer.                   !<a name='2251'></font>
       <font color=#447700>! Diabatic horizontal momentum forcing should be treated as a kind of 'body' !<a name='2252'></font>
       <font color=#447700>! forcing without actual mass exchange between convective updraft and        !<a name='2253'></font>
       <font color=#447700>! environment, but still taking horizontal momentum from the environment to  !<a name='2254'></font>
       <font color=#447700>! the convective updrafts. Thus, diabatic convective momentum transport      !<a name='2255'></font>
       <font color=#447700>! vertically redistributes environmental horizontal momentum.                !<a name='2256'></font>
       <font color=#447700>! -------------------------------------------------------------------------- !<a name='2257'></font>
<a name='2258'>
       emf(krel-1)  = 0._r8<a name='2259'>
       umf(krel-1)  = cbmf<a name='2260'>
       wu(krel-1)   = wrel<a name='2261'>
       thlu(krel-1) = thlsrc<a name='2262'>
       qtu(krel-1)  = qtsrc<a name='2263'>
       call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_8">(prel,thlsrc,qtsrc,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='2264'>
       if( id_check .eq. 1 ) then<a name='2265'>
           exit_conden(i) = 1._r8<a name='2266'>
           id_exit = .true.<a name='2267'>
           go to 333<a name='2268'>
       endif<a name='2269'>
       thvu(krel-1) = thj * ( 1._r8 + zvir*qvj - qlj - qij )       <a name='2270'>
<a name='2271'>
       uplus = 0._r8<a name='2272'>
       vplus = 0._r8<a name='2273'>
       if( krel .eq. kinv ) then<a name='2274'>
           uplus = PGFc * ssu0(kinv) * ( prel - ps0(kinv-1) )<a name='2275'>
           vplus = PGFc * ssv0(kinv) * ( prel - ps0(kinv-1) )<a name='2276'>
       else<a name='2277'>
           do k = kinv, max(krel-1,kinv)<a name='2278'>
              uplus = uplus + PGFc * ssu0(k) * ( ps0(k) - ps0(k-1) )<a name='2279'>
              vplus = vplus + PGFc * ssv0(k) * ( ps0(k) - ps0(k-1) )<a name='2280'>
           end do<a name='2281'>
           uplus = uplus + PGFc * ssu0(krel) * ( prel - ps0(krel-1) )<a name='2282'>
           vplus = vplus + PGFc * ssv0(krel) * ( prel - ps0(krel-1) )<a name='2283'>
       end if<a name='2284'>
       uu(krel-1) = usrc + uplus<a name='2285'>
       vu(krel-1) = vsrc + vplus      <a name='2286'>
<a name='2287'>
       do m = 1, ncnst<a name='2288'>
          tru(krel-1,m)  = trsrc(m)<a name='2289'>
       enddo<a name='2290'>
<a name='2291'>
       <font color=#447700>! -------------------------------------------------------------------------- !<a name='2292'></font>
       <font color=#447700>! Define environmental properties at the level where buoyancy sorting occurs !<a name='2293'></font>
       <font color=#447700>! ('pe', normally, layer midpoint except in the 'krel' layer). In the 'krel' !<a name='2294'></font>
       <font color=#447700>! layer where buoyancy sorting starts to occur, however, 'pe' is defined     !<a name='2295'></font>
       <font color=#447700>! differently because LCL is regarded as lower interface for mixing purpose. !<a name='2296'></font>
       <font color=#447700>! -------------------------------------------------------------------------- !<a name='2297'></font>
<a name='2298'>
       pe      = 0.5_r8 * ( prel + ps0(krel) )<a name='2299'>
       dpe     = prel - ps0(krel)<a name='2300'>
       exne    = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#EXNF'>exnf</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXNF_1">(pe)<a name='2301'>
       thvebot = thv0rel<a name='2302'>
       thle    = thl0(krel) + ssthl0(krel) * ( pe - p0(krel) )<a name='2303'>
       qte     = qt0(krel)  + ssqt0(krel)  * ( pe - p0(krel) )<a name='2304'>
       ue      = u0(krel)   + ssu0(krel)   * ( pe - p0(krel) )<a name='2305'>
       ve      = v0(krel)   + ssv0(krel)   * ( pe - p0(krel) )<a name='2306'>
       do m = 1, ncnst<a name='2307'>
          tre(m) = tr0(krel,m)  + sstr0(krel,m) * ( pe - p0(krel) )<a name='2308'>
       enddo<a name='2309'>
<a name='2310'>
       <font color=#447700>!-------------------------! <a name='2311'></font>
       <font color=#447700>! Buoyancy-Sorting Mixing !<a name='2312'></font>
       <font color=#447700>!-------------------------!------------------------------------------------ !<a name='2313'></font>
       <font color=#447700>!                                                                           !<a name='2314'></font>
       <font color=#447700>!  In order to complete buoyancy-sorting mixing at layer mid-point, and so  ! <a name='2315'></font>
       <font color=#447700>!  calculate 'updraft mass flux, updraft w velocity, conservative scalars'  !<a name='2316'></font>
       <font color=#447700>!  at the upper interface of each layer, we need following 3 information.   ! <a name='2317'></font>
       <font color=#447700>!                                                                           !<a name='2318'></font>
       <font color=#447700>!  1. Pressure where mixing occurs ('pe'), and temperature at 'pe' which is !<a name='2319'></font>
       <font color=#447700>!     necessary to calculate various thermodynamic coefficients at pe. This !<a name='2320'></font>
       <font color=#447700>!     temperature is obtained by undiluted cumulus properties lifted to pe. ! <a name='2321'></font>
       <font color=#447700>!  2. Undiluted updraft properties at pe - conservative scalar and vertical !<a name='2322'></font>
       <font color=#447700>!     velocity -which are assumed to be the same as the properties at lower !<a name='2323'></font>
       <font color=#447700>!     interface only for calculation of fractional lateral entrainment  and !<a name='2324'></font>
       <font color=#447700>!     detrainment rate ( fer(k) and fdr(k) [Pa-1] ), respectively.    Final !<a name='2325'></font>
       <font color=#447700>!     values of cumulus conservative scalars and w at the top interface are !<a name='2326'></font>
       <font color=#447700>!     calculated afterward after obtaining fer(k) &amp; fdr(k).                 !<a name='2327'></font>
       <font color=#447700>!  3. Environmental properties at pe.                                       !<a name='2328'></font>
       <font color=#447700>! ------------------------------------------------------------------------- !<a name='2329'></font>
       <a name='2330'>
       <font color=#447700>! ------------------------------------------------------------------------ ! <a name='2331'></font>
       <font color=#447700>! Define cumulus scale height.                                             !<a name='2332'></font>
       <font color=#447700>! Cumulus scale height is defined as the maximum height cumulus can reach. !<a name='2333'></font>
       <font color=#447700>! In case of premitive code, cumulus scale height ('cush')  at the current !<a name='2334'></font>
       <font color=#447700>! time step was assumed to be the same as 'cush' of previous time step.    !<a name='2335'></font>
       <font color=#447700>! However, I directly calculated cush at each time step using an iterative !<a name='2336'></font>
       <font color=#447700>! method. Note that within the cumulus scheme, 'cush' information is  used !<a name='2337'></font>
       <font color=#447700>! only at two places during buoyancy-sorting process:                      !<a name='2338'></font>
       <font color=#447700>! (1) Even negatively buoyancy mixtures with strong vertical velocity      !<a name='2339'></font>
       <font color=#447700>!     enough to rise up to 'rle*scaleh' (rle = 0.1) from pe are entrained  !<a name='2340'></font>
       <font color=#447700>!     into cumulus updraft,                                                !  <a name='2341'></font>
       <font color=#447700>! (2) The amount of mass that is involved in buoyancy-sorting mixing       !<a name='2342'></font>
       <font color=#447700>!      process at pe is rei(k) = rkm/scaleh/rho*g [Pa-1]                   !<a name='2343'></font>
       <font color=#447700>! In terms of (1), I think critical stopping distance might be replaced by !<a name='2344'></font>
       <font color=#447700>! layer thickness. In future, we will use rei(k) = (0.5*rkm/z0(k)/rho/g).  !<a name='2345'></font>
       <font color=#447700>! In the premitive code,  'scaleh' was largely responsible for the jumping !<a name='2346'></font>
       <font color=#447700>! variation of precipitation amount.                                       !<a name='2347'></font>
       <font color=#447700>! ------------------------------------------------------------------------ !   <a name='2348'></font>
<a name='2349'>
       scaleh = tscaleh<a name='2350'>
       if( tscaleh .lt. 0.0_r8 ) scaleh = 1000._r8 <a name='2351'>
<a name='2352'>
     <font color=#447700>! Save time : Set iter_scaleh = 1. This will automatically use 'cush' from the previous time step<a name='2353'></font>
     <font color=#447700>!             at the first implicit iteration. At the second implicit iteration, it will use<a name='2354'></font>
     <font color=#447700>!             the updated 'cush' by the first implicit cin. So, this updating has an effect of<a name='2355'></font>
     <font color=#447700>!             doing one iteration for cush calculation, which is good. <a name='2356'></font>
     <font color=#447700>!             So, only this setting of 'iter_scaleh = 1' is sufficient-enough to save computation time.<a name='2357'></font>
     <font color=#447700>! OK<a name='2358'></font>
<a name='2359'>
       do iter_scaleh = 1, 3<a name='2360'>
<a name='2361'>
       <font color=#447700>! ---------------------------------------------------------------- !<a name='2362'></font>
       <font color=#447700>! Initialization of 'kbup' and 'kpen'                              !<a name='2363'></font>
       <font color=#447700>! ---------------------------------------------------------------- !<a name='2364'></font>
       <font color=#447700>! 'kbup' is the top-most layer in which cloud buoyancy is positive !<a name='2365'></font>
       <font color=#447700>! both at the top and bottom interface of the layer. 'kpen' is the !<a name='2366'></font>
       <font color=#447700>! layer upto which cumulus panetrates ,i.e., cumulus w at the base !<a name='2367'></font>
       <font color=#447700>! interface is positive, but becomes negative at the top interface.!<a name='2368'></font>
       <font color=#447700>! Here, we initialize 'kbup' and 'kpen'. These initializations are !  <a name='2369'></font>
       <font color=#447700>! not trivial but important, expecially   in calculating turbulent !<a name='2370'></font>
       <font color=#447700>! fluxes without confliction among several physics as explained in !<a name='2371'></font>
       <font color=#447700>! detail in the part of turbulent fluxes calculation later.   Note !<a name='2372'></font>
       <font color=#447700>! that regardless of whether 'kbup' and 'kpen' are updated or  not !<a name='2373'></font>
       <font color=#447700>! during updraft motion,  penetrative entrainments are dumped down !<a name='2374'></font>
       <font color=#447700>! across the top interface of 'kbup' later.      More specifically,!<a name='2375'></font>
       <font color=#447700>! penetrative entrainment heat and moisture fluxes are  calculated !<a name='2376'></font>
       <font color=#447700>! from the top interface of 'kbup' layer  to the base interface of !<a name='2377'></font>
       <font color=#447700>! 'kpen' layer. Because of this, initialization of 'kbup' &amp; 'kpen' !<a name='2378'></font>
       <font color=#447700>! influence the convection system when there are not updated.  The !  <a name='2379'></font>
       <font color=#447700>! below initialization of 'kbup = krel' assures  that  penetrative !<a name='2380'></font>
       <font color=#447700>! entrainment fluxes always occur at interfaces above the PBL  top !<a name='2381'></font>
       <font color=#447700>! interfaces (i.e., only at interfaces k &gt;=kinv ), which seems  to !<a name='2382'></font>
       <font color=#447700>! be attractable considering that the most correct fluxes  at  the !<a name='2383'></font>
       <font color=#447700>! PBL top interface can be ontained from the 'fluxbelowinv'  using !<a name='2384'></font>
       <font color=#447700>! reconstructed PBL height.                                        ! <a name='2385'></font>
       <font color=#447700>! The 'kbup = krel'(after going through the whole buoyancy sorting !<a name='2386'></font>
       <font color=#447700>! proces during updraft motion) implies that cumulus updraft  from !<a name='2387'></font>
       <font color=#447700>! the PBL top interface can not reach to the LFC,so that 'kbup' is !<a name='2388'></font>
       <font color=#447700>! not updated during upward. This means that cumulus updraft   did !<a name='2389'></font>
       <font color=#447700>! not fully overcome the buoyancy barrier above just the PBL top.  !<a name='2390'></font>
       <font color=#447700>! If 'kpen' is not updated either ( i.e., cumulus cannot rise over !<a name='2391'></font>
       <font color=#447700>! the top interface of release layer),penetrative entrainment will !<a name='2392'></font>
       <font color=#447700>! not happen at any interfaces.  If cumulus updraft can rise above !<a name='2393'></font>
       <font color=#447700>! the release layer but cannot fully overcome the buoyancy barrier !<a name='2394'></font>
       <font color=#447700>! just above PBL top interface, penetratve entrainment   occurs at !<a name='2395'></font>
       <font color=#447700>! several above interfaces, including the top interface of release ! <a name='2396'></font>
       <font color=#447700>! layer. In the latter case, warming and drying tendencies will be !<a name='2397'></font>
       <font color=#447700>! be initiated in 'krel' layer. Note current choice of 'kbup=krel' !<a name='2398'></font>
       <font color=#447700>! is completely compatible with other flux physics without  double !<a name='2399'></font>
       <font color=#447700>! or miss counting turbulent fluxes at any interface. However, the !<a name='2400'></font>
       <font color=#447700>! alternative choice of 'kbup=krel-1' also has itw own advantage - !<a name='2401'></font>
       <font color=#447700>! when cumulus updraft cannot overcome buoyancy barrier just above !<a name='2402'></font>
       <font color=#447700>! PBL top, entrainment warming and drying are concentrated in  the !<a name='2403'></font>
       <font color=#447700>! 'kinv-1' layer instead of 'kinv' layer for this case. This might !<a name='2404'></font>
       <font color=#447700>! seems to be more dynamically reasonable, but I will choose the   !<a name='2405'></font>
       <font color=#447700>! 'kbup = krel' choice since it is more compatible  with the other !<a name='2406'></font>
       <font color=#447700>! parts of the code, expecially, when we chose ' use_emf=.false. ' !<a name='2407'></font>
       <font color=#447700>! as explained in detail in turbulent flux calculation part.       !<a name='2408'></font>
       <font color=#447700>! ---------------------------------------------------------------- ! <a name='2409'></font>
<a name='2410'>
       kbup    = krel<a name='2411'>
       kpen    = krel<a name='2412'>
       <a name='2413'>
       <font color=#447700>! ------------------------------------------------------------ !<a name='2414'></font>
       <font color=#447700>! Since 'wtw' is continuously updated during vertical motion,  !<a name='2415'></font>
       <font color=#447700>! I need below initialization command within this 'iter_scaleh'!<a name='2416'></font>
       <font color=#447700>! do loop. Similarily, I need initializations of environmental !<a name='2417'></font>
       <font color=#447700>! properties at 'krel' layer as below.                         !<a name='2418'></font>
       <font color=#447700>! ------------------------------------------------------------ !<a name='2419'></font>
<a name='2420'>
       wtw     = wlcl * wlcl<a name='2421'>
       pe      = 0.5_r8 * ( prel + ps0(krel) )<a name='2422'>
       dpe     = prel - ps0(krel)<a name='2423'>
       exne    = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#EXNF'>exnf</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXNF_2">(pe)<a name='2424'>
       thvebot = thv0rel<a name='2425'>
       thle    = thl0(krel) + ssthl0(krel) * ( pe - p0(krel) )<a name='2426'>
       qte     = qt0(krel)  + ssqt0(krel)  * ( pe - p0(krel) )<a name='2427'>
       ue      = u0(krel)   + ssu0(krel)   * ( pe - p0(krel) )<a name='2428'>
       ve      = v0(krel)   + ssv0(krel)   * ( pe - p0(krel) )<a name='2429'>
       do m = 1, ncnst<a name='2430'>
          tre(m) = tr0(krel,m)  + sstr0(krel,m)  * ( pe - p0(krel) )<a name='2431'>
       enddo<a name='2432'>
<a name='2433'>
       <font color=#447700>! ----------------------------------------------------------------------- !<a name='2434'></font>
       <font color=#447700>! Cumulus rises upward from 'prel' ( or base interface of  'krel' layer ) !<a name='2435'></font>
       <font color=#447700>! until updraft vertical velocity becomes zero.                           !<a name='2436'></font>
       <font color=#447700>! Buoyancy sorting is performed via two stages. (1) Using cumulus updraft !<a name='2437'></font>
       <font color=#447700>! properties at the base interface of each layer,perform buoyancy sorting !<a name='2438'></font>
       <font color=#447700>! at the layer mid-point, 'pe',  and update cumulus properties at the top !<a name='2439'></font>
       <font color=#447700>! interface, and then  (2) by averaging updated cumulus properties at the !<a name='2440'></font>
       <font color=#447700>! top interface and cumulus properties at the base interface,   calculate !<a name='2441'></font>
       <font color=#447700>! cumulus updraft properties at pe that will be used  in buoyancy sorting !<a name='2442'></font>
       <font color=#447700>! mixing - thlue, qtue and, wue.  Using this averaged properties, perform !<a name='2443'></font>
       <font color=#447700>! buoyancy sorting again at pe, and re-calculate fer(k) and fdr(k). Using !<a name='2444'></font>
       <font color=#447700>! this recalculated fer(k) and fdr(k),  finally calculate cumulus updraft !<a name='2445'></font>
       <font color=#447700>! properties at the top interface - thlu, qtu, thvu, uu, vu. In the below,!<a name='2446'></font>
       <font color=#447700>! 'iter_xc = 1' performs the first stage, while 'iter_xc= 2' performs the !<a name='2447'></font>
       <font color=#447700>! second stage. We can increase the number of iterations, 'nter_xc'.as we !<a name='2448'></font>
       <font color=#447700>! want, but a sample test indicated that about 3 - 5 iterations  produced !<a name='2449'></font>
       <font color=#447700>! satisfactory converent solution. Finally, identify 'kbup' and 'kpen'.   !<a name='2450'></font>
       <font color=#447700>! ----------------------------------------------------------------------- !<a name='2451'></font>
       <a name='2452'>
       do k = krel, mkx - 1 <font color=#447700>! Here, 'k' is a layer index.<a name='2453'></font>
<a name='2454'>
          km1 = k - 1<a name='2455'>
<a name='2456'>
          thlue = thlu(km1)<a name='2457'>
          qtue  = qtu(km1)    <a name='2458'>
          wue   = wu(km1)<a name='2459'>
          wtwb  = wtw  <a name='2460'>
<a name='2461'>
       do iter_xc = 1, niter_xc<a name='2462'>
          <a name='2463'>
          wtw = wu(km1) * wu(km1)<a name='2464'>
<a name='2465'>
          <font color=#447700>! ---------------------------------------------------------------- !<a name='2466'></font>
          <font color=#447700>! Calculate environmental and cumulus saturation 'excess' at 'pe'. !<a name='2467'></font>
          <font color=#447700>! Note that in order to calculate saturation excess, we should use ! <a name='2468'></font>
          <font color=#447700>! liquid water temperature instead of temperature  as the argument !<a name='2469'></font>
          <font color=#447700>! of "qsat". But note normal argument of "qsat" is temperature.    !<a name='2470'></font>
          <font color=#447700>! ---------------------------------------------------------------- !<a name='2471'></font>
<a name='2472'>
          call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_9">(pe,thle,qte,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='2473'>
          if( id_check .eq. 1 ) then<a name='2474'>
              exit_conden(i) = 1._r8<a name='2475'>
              id_exit = .true.<a name='2476'>
              go to 333<a name='2477'>
          end if<a name='2478'>
          thv0j    = thj * ( 1._r8 + zvir*qvj - qlj - qij )<a name='2479'>
          rho0j    = pe / ( r * thv0j * exne )<a name='2480'>
          qsat_arg = thle*exne     <a name='2481'>
          status   = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#QSAT'>qsat</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_23">(qsat_arg,pe,es(1),qs(1),gam(1),1)<a name='2482'>
          excess0  = qte - qs(1)<a name='2483'>
<a name='2484'>
          call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_10">(pe,thlue,qtue,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='2485'>
          if( id_check .eq. 1 ) then<a name='2486'>
              exit_conden(i) = 1._r8<a name='2487'>
              id_exit = .true.<a name='2488'>
              go to 333<a name='2489'>
          end if<a name='2490'>
          <font color=#447700>! ----------------------------------------------------------------- !<a name='2491'></font>
          <font color=#447700>! Detrain excessive condensate larger than 'criqc' from the cumulus ! <a name='2492'></font>
          <font color=#447700>! updraft before performing buoyancy sorting. All I should to do is !<a name='2493'></font>
          <font color=#447700>! to update 'thlue' &amp;  'que' here. Below modification is completely !<a name='2494'></font>
          <font color=#447700>! compatible with the other part of the code since 'thule' &amp; 'qtue' !<a name='2495'></font>
          <font color=#447700>! are used only for buoyancy sorting. I found that as long as I use !<a name='2496'></font>
          <font color=#447700>! 'niter_xc &gt;= 2',  detraining excessive condensate before buoyancy !<a name='2497'></font>
          <font color=#447700>! sorting has negligible influence on the buoyancy sorting results. !   <a name='2498'></font>
          <font color=#447700>! ----------------------------------------------------------------- !<a name='2499'></font>
          if( (qlj + qij) .gt. criqc ) then<a name='2500'>
               exql  = ( ( qlj + qij ) - criqc ) * qlj / ( qlj + qij )<a name='2501'>
               exqi  = ( ( qlj + qij ) - criqc ) * qij / ( qlj + qij )<a name='2502'>
               qtue  = qtue - exql - exqi<a name='2503'>
               thlue = thlue + (xlv/cp/exne)*exql + (xls/cp/exne)*exqi <a name='2504'>
          endif<a name='2505'>
          call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_11">(pe,thlue,qtue,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='2506'>
          if( id_check .eq. 1 ) then<a name='2507'>
              exit_conden(i) = 1._r8<a name='2508'>
              id_exit = .true.<a name='2509'>
              go to 333<a name='2510'>
          end if<a name='2511'>
          thvj     = thj * ( 1._r8 + zvir * qvj - qlj - qij )<a name='2512'>
          tj       = thj * exne <font color=#447700>! This 'tj' is used for computing thermo. coeffs. below<a name='2513'></font>
          qsat_arg = thlue*exne<a name='2514'>
          status   = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#QSAT'>qsat</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_24">(qsat_arg,pe,es(1),qs(1),gam(1),1)<a name='2515'>
          excessu  = qtue - qs(1)<a name='2516'>
<a name='2517'>
          <font color=#447700>! ------------------------------------------------------------------- !<a name='2518'></font>
          <font color=#447700>! Calculate critical mixing fraction, 'xc'. Mixture with mixing ratio !<a name='2519'></font>
          <font color=#447700>! smaller than 'xc' will be entrained into cumulus updraft.  Both the !<a name='2520'></font>
          <font color=#447700>! saturated updrafts with 'positive buoyancy' or 'negative buoyancy + ! <a name='2521'></font>
          <font color=#447700>! strong vertical velocity enough to rise certain threshold distance' !<a name='2522'></font>
          <font color=#447700>! are kept into the updraft in the below program. If the core updraft !<a name='2523'></font>
          <font color=#447700>! is unsaturated, we can set 'xc = 0' and let the cumulus  convection !<a name='2524'></font>
          <font color=#447700>! still works or we may exit.                                         !<a name='2525'></font>
          <font color=#447700>! Current below code does not entrain unsaturated mixture. However it !<a name='2526'></font>
          <font color=#447700>! should be modified such that it also entrain unsaturated mixture.   !<a name='2527'></font>
          <font color=#447700>! ------------------------------------------------------------------- !<a name='2528'></font>
<a name='2529'>
          <font color=#447700>! ----------------------------------------------------------------- !<a name='2530'></font>
          <font color=#447700>! cridis : Critical stopping distance for buoyancy sorting purpose. !<a name='2531'></font>
          <font color=#447700>!          scaleh is only used here.                                !<a name='2532'></font>
          <font color=#447700>! ----------------------------------------------------------------- !<a name='2533'></font>
<a name='2534'>
            cridis = rle*scaleh                 <font color=#447700>! Original code<a name='2535'></font>
          <font color=#447700>! cridis = 1._r8*(zs0(k) - zs0(k-1))  ! New code<a name='2536'></font>
 <a name='2537'>
          <font color=#447700>! ---------------- !<a name='2538'></font>
          <font color=#447700>! Buoyancy Sorting !<a name='2539'></font>
          <font color=#447700>! ---------------- !                   <a name='2540'></font>
<a name='2541'>
          <font color=#447700>! ----------------------------------------------------------------- !<a name='2542'></font>
          <font color=#447700>! Case 1 : When both cumulus and env. are unsaturated or saturated. !<a name='2543'></font>
          <font color=#447700>! ----------------------------------------------------------------- !<a name='2544'></font>
<a name='2545'>
          if( ( excessu .le. 0._r8 .and. excess0 .le. 0._r8 ) .or. ( excessu .ge. 0._r8 .and. excess0 .ge. 0._r8 ) ) then<a name='2546'>
                xc = min(1._r8,max(0._r8,1._r8-2._r8*rbuoy*g*cridis/wue**2._r8*(1._r8-thvj/thv0j)))<a name='2547'>
              <font color=#447700>! Below 3 lines are diagnostic output not influencing<a name='2548'></font>
              <font color=#447700>! numerical calculations.<a name='2549'></font>
                aquad = 0._r8<a name='2550'>
                bquad = 0._r8<a name='2551'>
                cquad = 0._r8<a name='2552'>
          else<a name='2553'>
          <font color=#447700>! -------------------------------------------------- !<a name='2554'></font>
          <font color=#447700>! Case 2 : When either cumulus or env. is saturated. !<a name='2555'></font>
          <font color=#447700>! -------------------------------------------------- !<a name='2556'></font>
              xsat    = excessu / ( excessu - excess0 );<a name='2557'>
              thlxsat = thlue + xsat * ( thle - thlue );<a name='2558'>
              qtxsat  = qtue  + xsat * ( qte - qtue );<a name='2559'>
              call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_12">(pe,thlxsat,qtxsat,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='2560'>
              if( id_check .eq. 1 ) then<a name='2561'>
                  exit_conden(i) = 1._r8<a name='2562'>
                  id_exit = .true.<a name='2563'>
                  go to 333<a name='2564'>
              end if<a name='2565'>
              thvxsat = thj * ( 1._r8 + zvir * qvj - qlj - qij )               <a name='2566'>
              <font color=#447700>! -------------------------------------------------- !<a name='2567'></font>
              <font color=#447700>! kk=1 : Cumulus Segment, kk=2 : Environment Segment !<a name='2568'></font>
              <font color=#447700>! -------------------------------------------------- ! <a name='2569'></font>
              do kk = 1, 2 <a name='2570'>
                   if( kk .eq. 1 ) then<a name='2571'>
                       thv_x0 = thvj;<a name='2572'>
                       thv_x1 = ( 1._r8 - 1._r8/xsat ) * thvj + ( 1._r8/xsat ) * thvxsat;<a name='2573'>
                   else<a name='2574'>
                       thv_x1 = thv0j;<a name='2575'>
                       thv_x0 = ( xsat / ( xsat - 1._r8 ) ) * thv0j + ( 1._r8/( 1._r8 - xsat ) ) * thvxsat;<a name='2576'>
                   endif<a name='2577'>
                   aquad =  wue**2;<a name='2578'>
                   bquad =  2._r8*rbuoy*g*cridis*(thv_x1 - thv_x0)/thv0j - 2._r8*wue**2;<a name='2579'>
                   cquad =  2._r8*rbuoy*g*cridis*(thv_x0 -  thv0j)/thv0j +       wue**2;<a name='2580'>
                   if( kk .eq. 1 ) then<a name='2581'>
                       if( ( bquad**2-4._r8*aquad*cquad ) .ge. 0._r8 ) then<a name='2582'>
                             call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#ROOTS'>roots</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROOTS_1">(aquad,bquad,cquad,xs1,xs2,status)<a name='2583'>
                             x_cu = min(1._r8,max(0._r8,min(xsat,min(xs1,xs2))))<a name='2584'>
                       else<a name='2585'>
                             x_cu = xsat;<a name='2586'>
                       endif<a name='2587'>
                   else <a name='2588'>
                       if( ( bquad**2-4._r8*aquad*cquad) .ge. 0._r8 ) then<a name='2589'>
                             call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#ROOTS'>roots</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROOTS_2">(aquad,bquad,cquad,xs1,xs2,status)<a name='2590'>
                             x_en = min(1._r8,max(0._r8,max(xsat,min(xs1,xs2))))<a name='2591'>
                       else<a name='2592'>
                             x_en = 1._r8;<a name='2593'>
                       endif<a name='2594'>
                   endif<a name='2595'>
              enddo<a name='2596'>
              if( x_cu .eq. xsat ) then<a name='2597'>
                  xc = max(x_cu, x_en);<a name='2598'>
              else<a name='2599'>
                  xc = x_cu;<a name='2600'>
              endif<a name='2601'>
          endif<a name='2602'>
<a name='2603'>
          <font color=#447700>! ------------------------------------------------------------------------ !<a name='2604'></font>
          <font color=#447700>! Compute fractional lateral entrainment &amp; detrainment rate in each layers.!<a name='2605'></font>
          <font color=#447700>! The unit of rei(k), fer(k), and fdr(k) is [Pa-1].  Alternative choice of !<a name='2606'></font>
          <font color=#447700>! 'rei(k)' is also shown below, where coefficient 0.5 was from approximate !<a name='2607'></font>
          <font color=#447700>! tuning against the BOMEX case.                                           !<a name='2608'></font>
          <font color=#447700>! In order to prevent the onset of instability in association with cumulus !<a name='2609'></font>
          <font color=#447700>! induced subsidence advection, cumulus mass flux at the top interface  in !<a name='2610'></font>
          <font color=#447700>! any layer should be smaller than ( 90% of ) total mass within that layer.!<a name='2611'></font>
          <font color=#447700>! I imposed limits on 'rei(k)' as below,  in such that stability condition ! <a name='2612'></font>
          <font color=#447700>! is always satisfied.                                                     !<a name='2613'></font>
          <font color=#447700>! Below limiter of 'rei(k)' becomes negative for some cases, causing error.!<a name='2614'></font>
          <font color=#447700>! So, for the time being, I came back to the original limiter.             !<a name='2615'></font>
          <font color=#447700>! ------------------------------------------------------------------------ !<a name='2616'></font>
          ee2    = xc**2<a name='2617'>
          ud2    = 1._r8 - 2._r8*xc + xc**2<a name='2618'>
        <font color=#447700>! rei(k) = ( rkm / scaleh / g / rho0j )        ! Default.<a name='2619'></font>
          rei(k) = ( 0.5_r8 * rkm / z0(k) / g /rho0j ) <font color=#447700>! Alternative.<a name='2620'></font>
          if( xc .gt. 0.5_r8 ) rei(k) = min(rei(k),0.9_r8*log(dp0(k)/g/dt/umf(km1) + 1._r8)/dpe/(2._r8*xc-1._r8))<a name='2621'>
          fer(k) = rei(k) * ee2<a name='2622'>
          fdr(k) = rei(k) * ud2<a name='2623'>
<a name='2624'>
          <font color=#447700>! ------------------------------------------------------------------------------ !<a name='2625'></font>
          <font color=#447700>! Iteration Start due to 'maxufrc' constraint [ ****************************** ] ! <a name='2626'></font>
          <font color=#447700>! ------------------------------------------------------------------------------ !<a name='2627'></font>
<a name='2628'>
          <font color=#447700>! -------------------------------------------------------------------------- !<a name='2629'></font>
          <font color=#447700>! Calculate cumulus updraft mass flux and penetrative entrainment mass flux. !<a name='2630'></font>
          <font color=#447700>! Note that  non-zero penetrative entrainment mass flux will be asigned only !<a name='2631'></font>
          <font color=#447700>! to interfaces from the top interface of 'kbup' layer to the base interface !<a name='2632'></font>
          <font color=#447700>! of 'kpen' layer as will be shown later.                                    !<a name='2633'></font>
          <font color=#447700>! -------------------------------------------------------------------------- !<a name='2634'></font>
<a name='2635'>
          umf(k) = umf(km1) * exp( dpe * ( fer(k) - fdr(k) ) )<a name='2636'>
          emf(k) = 0._r8    <a name='2637'>
<a name='2638'>
          <font color=#447700>! --------------------------------------------------------- !<a name='2639'></font>
          <font color=#447700>! Compute cumulus updraft properties at the top interface.  !<a name='2640'></font>
          <font color=#447700>! Also use Tayler expansion in order to treat limiting case !<a name='2641'></font>
          <font color=#447700>! --------------------------------------------------------- !<a name='2642'></font>
<a name='2643'>
          if( fer(k)*dpe .lt. 1.e-4_r8 ) then<a name='2644'>
              thlu(k) = thlu(km1) + ( thle + ssthl0(k) * dpe / 2._r8 - thlu(km1) ) * fer(k) * dpe<a name='2645'>
              qtu(k)  =  qtu(km1) + ( qte  +  ssqt0(k) * dpe / 2._r8 -  qtu(km1) ) * fer(k) * dpe<a name='2646'>
              uu(k)   =   uu(km1) + ( ue   +   ssu0(k) * dpe / 2._r8 -   uu(km1) ) * fer(k) * dpe - PGFc * ssu0(k) * dpe<a name='2647'>
              vu(k)   =   vu(km1) + ( ve   +   ssv0(k) * dpe / 2._r8 -   vu(km1) ) * fer(k) * dpe - PGFc * ssv0(k) * dpe<a name='2648'>
              do m = 1, ncnst<a name='2649'>
                 tru(k,m)  =  tru(km1,m) + ( tre(m)  + sstr0(k,m) * dpe / 2._r8  -  tru(km1,m) ) * fer(k) * dpe<a name='2650'>
              enddo<a name='2651'>
          else<a name='2652'>
              thlu(k) = ( thle + ssthl0(k) / fer(k) - ssthl0(k) * dpe / 2._r8 ) -          &amp;<a name='2653'>
                        ( thle + ssthl0(k) * dpe / 2._r8 - thlu(km1) + ssthl0(k) / fer(k) ) * exp(-fer(k) * dpe)<a name='2654'>
              qtu(k)  = ( qte  +  ssqt0(k) / fer(k) -  ssqt0(k) * dpe / 2._r8 ) -          &amp;  <a name='2655'>
                        ( qte  +  ssqt0(k) * dpe / 2._r8 -  qtu(km1) +  ssqt0(k) / fer(k) ) * exp(-fer(k) * dpe)<a name='2656'>
              uu(k) =   ( ue + ( 1._r8 - PGFc ) * ssu0(k) / fer(k) - ssu0(k) * dpe / 2._r8 ) - &amp;<a name='2657'>
                        ( ue +     ssu0(k) * dpe / 2._r8 -   uu(km1) + ( 1._r8 - PGFc ) * ssu0(k) / fer(k) ) * exp(-fer(k) * dpe)<a name='2658'>
              vu(k) =   ( ve + ( 1._r8 - PGFc ) * ssv0(k) / fer(k) - ssv0(k) * dpe / 2._r8 ) - &amp;<a name='2659'>
                        ( ve +     ssv0(k) * dpe / 2._r8 -   vu(km1) + ( 1._r8 - PGFc ) * ssv0(k) / fer(k) ) * exp(-fer(k) * dpe)<a name='2660'>
              do m = 1, ncnst<a name='2661'>
                 tru(k,m)  = ( tre(m)  + sstr0(k,m) / fer(k) - sstr0(k,m) * dpe / 2._r8 ) - &amp;  <a name='2662'>
                             ( tre(m)  + sstr0(k,m) * dpe / 2._r8 - tru(km1,m) + sstr0(k,m) / fer(k) ) * exp(-fer(k) * dpe)<a name='2663'>
              enddo<a name='2664'>
          end if<a name='2665'>
<a name='2666'>
          <font color=#447700>!------------------------------------------------------------------- !<a name='2667'></font>
          <font color=#447700>! Expel some of cloud water and ice from cumulus  updraft at the top !<a name='2668'></font>
          <font color=#447700>! interface.  Note that this is not 'detrainment' term  but a 'sink' !<a name='2669'></font>
          <font color=#447700>! term of cumulus updraft qt ( or one part of 'source' term of  mean !<a name='2670'></font>
          <font color=#447700>! environmental qt ). At this stage, as the most simplest choice, if !<a name='2671'></font>
          <font color=#447700>! condensate amount within cumulus updraft is larger than a critical !<a name='2672'></font>
          <font color=#447700>! value, 'criqc', expels the surplus condensate from cumulus updraft !<a name='2673'></font>
          <font color=#447700>! to the environment. A certain fraction ( e.g., 'frc_sus' ) of this !<a name='2674'></font>
          <font color=#447700>! expelled condesnate will be in a form that can be suspended in the !<a name='2675'></font>
          <font color=#447700>! layer k where it was formed, while the other fraction, '1-frc_sus' ! <a name='2676'></font>
          <font color=#447700>! will be in a form of precipitatble (e.g.,can potentially fall down !<a name='2677'></font>
          <font color=#447700>! across the base interface of layer k ). In turn we should describe !<a name='2678'></font>
          <font color=#447700>! subsequent falling of precipitable condensate ('1-frc_sus') across !<a name='2679'></font>
          <font color=#447700>! the base interface of the layer k, &amp;  evaporation of precipitating !<a name='2680'></font>
          <font color=#447700>! water in the below layer k-1 and associated evaporative cooling of !<a name='2681'></font>
          <font color=#447700>! the later, k-1, and falling of 'non-evaporated precipitating water !<a name='2682'></font>
          <font color=#447700>! ( which was initially formed in layer k ) and a newly-formed preci !<a name='2683'></font>
          <font color=#447700>! pitable water in the layer, k-1', across the base interface of the !<a name='2684'></font>
          <font color=#447700>! lower layer k-1.  Cloud microphysics should correctly describe all !<a name='2685'></font>
          <font color=#447700>! of these process.  In a near future, I should significantly modify !<a name='2686'></font>
          <font color=#447700>! this cloud microphysics, including precipitation-induced downdraft !<a name='2687'></font>
          <font color=#447700>! also.                                                              !<a name='2688'></font>
          <font color=#447700>! ------------------------------------------------------------------ !<a name='2689'></font>
<a name='2690'>
          call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_13">(ps0(k),thlu(k),qtu(k),thj,qvj,qlj,qij,qse,id_check,qsat)<a name='2691'>
          if( id_check .eq. 1 ) then<a name='2692'>
              exit_conden(i) = 1._r8<a name='2693'>
              id_exit = .true.<a name='2694'>
              go to 333<a name='2695'>
          end if<a name='2696'>
          if( (qlj + qij) .gt. criqc ) then<a name='2697'>
               exql    = ( ( qlj + qij ) - criqc ) * qlj / ( qlj + qij )<a name='2698'>
               exqi    = ( ( qlj + qij ) - criqc ) * qij / ( qlj + qij )<a name='2699'>
               <font color=#447700>! ---------------------------------------------------------------- !<a name='2700'></font>
               <font color=#447700>! It is very important to re-update 'qtu' and 'thlu'  at the upper ! <a name='2701'></font>
               <font color=#447700>! interface after expelling condensate from cumulus updraft at the !<a name='2702'></font>
               <font color=#447700>! top interface of the layer. As mentioned above, this is a 'sink' !<a name='2703'></font>
               <font color=#447700>! of cumulus qt (or equivalently, a 'source' of environmentasl qt),!<a name='2704'></font>
               <font color=#447700>! not a regular convective'detrainment'.                           !<a name='2705'></font>
               <font color=#447700>! ---------------------------------------------------------------- !<a name='2706'></font>
               qtu(k)  = qtu(k) - exql - exqi<a name='2707'>
               thlu(k) = thlu(k) + (xlv/cp/exns0(k))*exql + (xls/cp/exns0(k))*exqi <a name='2708'>
               <font color=#447700>! ---------------------------------------------------------------- !<a name='2709'></font>
               <font color=#447700>! Expelled cloud condensate into the environment from the updraft. ! <a name='2710'></font>
               <font color=#447700>! After all the calculation later, 'dwten' and 'diten' will have a !<a name='2711'></font>
               <font color=#447700>! unit of [ kg/kg/s ], because it is a tendency of qt. Restoration !<a name='2712'></font>
               <font color=#447700>! of 'dwten' and 'diten' to this correct unit through  multiplying !<a name='2713'></font>
               <font color=#447700>! 'umf(k)*g/dp0(k)' will be performed later after finally updating !<a name='2714'></font>
               <font color=#447700>! 'umf' using a 'rmaxfrac' constraint near the end of this updraft !<a name='2715'></font>
               <font color=#447700>! buoyancy sorting loop.                                           !<a name='2716'></font>
               <font color=#447700>! ---------------------------------------------------------------- !<a name='2717'></font>
               dwten(k) = exql   <a name='2718'>
               diten(k) = exqi<a name='2719'>
          else<a name='2720'>
               dwten(k) = 0._r8<a name='2721'>
               diten(k) = 0._r8<a name='2722'>
          endif<a name='2723'>
          <font color=#447700>! ----------------------------------------------------------------- ! <a name='2724'></font>
          <font color=#447700>! Update 'thvu(k)' after detraining condensate from cumulus updraft.!<a name='2725'></font>
          <font color=#447700>! ----------------------------------------------------------------- ! <a name='2726'></font>
          call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_14">(ps0(k),thlu(k),qtu(k),thj,qvj,qlj,qij,qse,id_check,qsat)<a name='2727'>
          if( id_check .eq. 1 ) then<a name='2728'>
              exit_conden(i) = 1._r8<a name='2729'>
              id_exit = .true.<a name='2730'>
              go to 333<a name='2731'>
          end if  <a name='2732'>
          thvu(k) = thj * ( 1._r8 + zvir * qvj - qlj - qij )<a name='2733'>
<a name='2734'>
          <font color=#447700>! ----------------------------------------------------------- ! <a name='2735'></font>
          <font color=#447700>! Calculate updraft vertical velocity at the upper interface. !<a name='2736'></font>
          <font color=#447700>! In order to calculate 'wtw' at the upper interface, we use  !<a name='2737'></font>
          <font color=#447700>! 'wtw' at the lower interface. Note  'wtw'  is continuously  ! <a name='2738'></font>
          <font color=#447700>! updated as cumulus updraft rises.                           !<a name='2739'></font>
          <font color=#447700>! ----------------------------------------------------------- !<a name='2740'></font>
<a name='2741'>
          bogbot = rbuoy * ( thvu(km1) / thvebot  - 1._r8 ) <font color=#447700>! Cloud buoyancy at base interface<a name='2742'></font>
          bogtop = rbuoy * ( thvu(k) / thv0top(k) - 1._r8 ) <font color=#447700>! Cloud buoyancy at top  interface<a name='2743'></font>
<a name='2744'>
          delbog = bogtop - bogbot<a name='2745'>
          drage  = fer(k) * ( 1._r8 + rdrag )<a name='2746'>
          expfac = exp(-2._r8*drage*dpe)<a name='2747'>
<a name='2748'>
          wtwb = wtw<a name='2749'>
          if( drage*dpe .gt. 1.e-3_r8 ) then<a name='2750'>
              wtw = wtw*expfac + (delbog + (1._r8-expfac)*(bogbot + delbog/(-2._r8*drage*dpe)))/(rho0j*drage)<a name='2751'>
          else<a name='2752'>
              wtw = wtw + dpe * ( bogbot + bogtop ) / rho0j<a name='2753'>
          endif<a name='2754'>
<a name='2755'>
        <font color=#447700>! Force the plume rise at least to klfc of the undiluted plume.<a name='2756'></font>
        <font color=#447700>! Because even the below is not complete, I decided not to include this.<a name='2757'></font>
<a name='2758'>
        <font color=#447700>! if( k .le. klfc ) then<a name='2759'></font>
        <font color=#447700>!     wtw = max( 1.e-2_r8, wtw )<a name='2760'></font>
        <font color=#447700>! endif <a name='2761'></font>
         <a name='2762'>
          <font color=#447700>! -------------------------------------------------------------- !<a name='2763'></font>
          <font color=#447700>! Repeat 'iter_xc' iteration loop until 'iter_xc = niter_xc'.    !<a name='2764'></font>
          <font color=#447700>! Also treat the case even when wtw &lt; 0 at the 'kpen' interface. !<a name='2765'></font>
          <font color=#447700>! -------------------------------------------------------------- !  <a name='2766'></font>
          <a name='2767'>
          if( wtw .gt. 0._r8 ) then   <a name='2768'>
              thlue = 0.5_r8 * ( thlu(km1) + thlu(k) )<a name='2769'>
              qtue  = 0.5_r8 * ( qtu(km1)  +  qtu(k) )         <a name='2770'>
              wue   = 0.5_r8 *   sqrt( max( wtwb + wtw, 0._r8 ) )<a name='2771'>
          else<a name='2772'>
              go to 111<a name='2773'>
          endif <a name='2774'>
<a name='2775'>
       enddo <font color=#447700>! End of 'iter_xc' loop  <a name='2776'></font>
<a name='2777'>
   111 continue<a name='2778'>
<a name='2779'>
          <font color=#447700>! --------------------------------------------------------------------------- ! <a name='2780'></font>
          <font color=#447700>! Add the contribution of self-detrainment  to vertical variations of cumulus !<a name='2781'></font>
          <font color=#447700>! updraft mass flux. The reason why we are trying to include self-detrainment !<a name='2782'></font>
          <font color=#447700>! is as follows.  In current scheme,  vertical variation of updraft mass flux !<a name='2783'></font>
          <font color=#447700>! is not fully consistent with the vertical variation of updraft vertical w.  !<a name='2784'></font>
          <font color=#447700>! For example, within a given layer, let's assume that  cumulus w is positive !<a name='2785'></font>
          <font color=#447700>! at the base interface, while negative at the top interface. This means that !<a name='2786'></font>
          <font color=#447700>! cumulus updraft cannot reach to the top interface of the layer. However,    !<a name='2787'></font>
          <font color=#447700>! cumulus updraft mass flux at the top interface is not zero according to the !<a name='2788'></font>
          <font color=#447700>! vertical tendency equation of cumulus mass flux.   Ideally, cumulus updraft ! <a name='2789'></font>
          <font color=#447700>! mass flux at the top interface should be zero for this case. In order to    !<a name='2790'></font>
          <font color=#447700>! assures that cumulus updraft mass flux goes to zero when cumulus updraft    ! <a name='2791'></font>
          <font color=#447700>! vertical velocity goes to zero, we are imposing self-detrainment term as    !<a name='2792'></font>
          <font color=#447700>! below by considering layer-mean cloud buoyancy and cumulus updraft vertical !<a name='2793'></font>
          <font color=#447700>! velocity square at the top interface. Use of auto-detrainment term will  be !<a name='2794'></font>
          <font color=#447700>! determined by setting 'use_self_detrain=.true.' in the parameter sentence.  !<a name='2795'></font>
          <font color=#447700>! --------------------------------------------------------------------------- !<a name='2796'></font>
     <a name='2797'>
          if( use_self_detrain ) then<a name='2798'>
              autodet = min( 0.5_r8*g*(bogbot+bogtop)/(max(wtw,0._r8)+1.e-4_r8), 0._r8 ) <a name='2799'>
              umf(k)  = umf(k) * exp( 0.637_r8*(dpe/rho0j/g) * autodet )   <a name='2800'>
          end if      <a name='2801'>
          if( umf(k) .eq. 0._r8 ) wtw = -1._r8<a name='2802'>
<a name='2803'>
          <font color=#447700>! -------------------------------------- !<a name='2804'></font>
          <font color=#447700>! Below block is just a dignostic output !<a name='2805'></font>
          <font color=#447700>! -------------------------------------- ! <a name='2806'></font>
<a name='2807'>
          excessu_arr(k) = excessu<a name='2808'>
          excess0_arr(k) = excess0<a name='2809'>
          xc_arr(k)      = xc<a name='2810'>
          aquad_arr(k)   = aquad<a name='2811'>
          bquad_arr(k)   = bquad<a name='2812'>
          cquad_arr(K)   = cquad<a name='2813'>
          bogbot_arr(k)  = bogbot<a name='2814'>
          bogtop_arr(k)  = bogtop<a name='2815'>
<a name='2816'>
          <font color=#447700>! ------------------------------------------------------------------- !<a name='2817'></font>
          <font color=#447700>! 'kbup' is the upper most layer in which cloud buoyancy  is positive ! <a name='2818'></font>
          <font color=#447700>! both at the base and top interface.  'kpen' is the upper most layer !<a name='2819'></font>
          <font color=#447700>! up to cumulus can reach. Usually, 'kpen' is located higher than the !<a name='2820'></font>
          <font color=#447700>! 'kbup'. Note we initialized these by 'kbup = krel' &amp; 'kpen = krel'. !<a name='2821'></font>
          <font color=#447700>! As explained before, it is possible that only 'kpen' is updated,    !<a name='2822'></font>
          <font color=#447700>! while 'kbup' keeps its initialization value. For this case, current !<a name='2823'></font>
          <font color=#447700>! scheme will simply turns-off penetrative entrainment fluxes and use ! <a name='2824'></font>
          <font color=#447700>! normal buoyancy-sorting fluxes for 'kbup &lt;= k &lt;= kpen-1' interfaces,!<a name='2825'></font>
          <font color=#447700>! in order to describe shallow continental cumulus convection.        !<a name='2826'></font>
          <font color=#447700>! ------------------------------------------------------------------- !<a name='2827'></font>
          <a name='2828'>
        <font color=#447700>! if( bogbot .gt. 0._r8 .and. bogtop .gt. 0._r8 ) then <a name='2829'></font>
        <font color=#447700>! if( bogtop .gt. 0._r8 ) then          <a name='2830'></font>
          if( bogtop .gt. 0._r8 .and. wtw .gt. 0._r8 ) then <a name='2831'>
              kbup = k<a name='2832'>
          end if<a name='2833'>
<a name='2834'>
          if( wtw .le. 0._r8 ) then<a name='2835'>
              kpen = k<a name='2836'>
              go to 45<a name='2837'>
          end if<a name='2838'>
<a name='2839'>
          wu(k) = sqrt(wtw)<a name='2840'>
          if( wu(k) .gt. 100._r8 ) then<a name='2841'>
              exit_wu(i) = 1._r8<a name='2842'>
              id_exit = .true.<a name='2843'>
              go to 333<a name='2844'>
          endif<a name='2845'>
<a name='2846'>
          <font color=#447700>! ---------------------------------------------------------------------------- !<a name='2847'></font>
          <font color=#447700>! Iteration end due to 'rmaxfrac' constraint [ ***************************** ] ! <a name='2848'></font>
          <font color=#447700>! ---------------------------------------------------------------------------- !<a name='2849'></font>
<a name='2850'>
          <font color=#447700>! ---------------------------------------------------------------------- !<a name='2851'></font>
          <font color=#447700>! Calculate updraft fractional area at the upper interface and set upper ! <a name='2852'></font>
          <font color=#447700>! limit to 'ufrc' by 'rmaxfrac'. In order to keep the consistency  among !<a name='2853'></font>
          <font color=#447700>! ['ufrc','umf','wu (or wtw)'], if ufrc is limited by 'rmaxfrac', either !<a name='2854'></font>
          <font color=#447700>! 'umf' or 'wu' should be changed. Although both 'umf' and 'wu (wtw)' at !<a name='2855'></font>
          <font color=#447700>! the current upper interface are used for updating 'umf' &amp; 'wu'  at the !<a name='2856'></font>
          <font color=#447700>! next upper interface, 'umf' is a passive variable not influencing  the !<a name='2857'></font>
          <font color=#447700>! buoyancy sorting process in contrast to 'wtw'. This is a reason why we !<a name='2858'></font>
          <font color=#447700>! adjusted 'umf' instead of 'wtw'. In turn we updated 'fdr' here instead !<a name='2859'></font>
          <font color=#447700>! of 'fer',  which guarantees  that all previously updated thermodynamic !<a name='2860'></font>
          <font color=#447700>! variables at the upper interface before applying 'rmaxfrac' constraint !<a name='2861'></font>
          <font color=#447700>! are already internally consistent,  even though 'ufrc'  is  limited by !<a name='2862'></font>
          <font color=#447700>! 'rmaxfrac'. Thus, we don't need to go through interation loop again.If !<a name='2863'></font>
          <font color=#447700>! If we update 'fer' however, we should go through above iteration loop. !<a name='2864'></font>
          <font color=#447700>! ---------------------------------------------------------------------- !<a name='2865'></font>
            <a name='2866'>
          rhos0j  = ps0(k) / ( r * 0.5_r8 * ( thv0bot(k+1) + thv0top(k) ) * exns0(k) )<a name='2867'>
          ufrc(k) = umf(k) / ( rhos0j * wu(k) )<a name='2868'>
          if( ufrc(k) .gt. rmaxfrac ) then<a name='2869'>
              limit_ufrc(i) = 1._r8 <a name='2870'>
              ufrc(k) = rmaxfrac<a name='2871'>
              umf(k)  = rmaxfrac * rhos0j * wu(k)<a name='2872'>
              fdr(k)  = fer(k) - log( umf(k) / umf(km1) ) / dpe<a name='2873'>
          endif<a name='2874'>
<a name='2875'>
          <font color=#447700>! ------------------------------------------------------------ !<a name='2876'></font>
          <font color=#447700>! Update environmental properties for at the mid-point of next !<a name='2877'></font>
          <font color=#447700>! upper layer for use in buoyancy sorting.                     !<a name='2878'></font>
          <font color=#447700>! ------------------------------------------------------------ ! <a name='2879'></font>
<a name='2880'>
          pe      = p0(k+1)<a name='2881'>
          dpe     = dp0(k+1)<a name='2882'>
          exne    = exn0(k+1)<a name='2883'>
          thvebot = thv0bot(k+1)<a name='2884'>
          thle    = thl0(k+1)<a name='2885'>
          qte     = qt0(k+1)<a name='2886'>
          ue      = u0(k+1)<a name='2887'>
          ve      = v0(k+1) <a name='2888'>
          do m = 1, ncnst<a name='2889'>
             tre(m)  = tr0(k+1,m)<a name='2890'>
          enddo<a name='2891'>
<a name='2892'>
       end do   <font color=#447700>! End of cumulus updraft loop from the 'krel' layer to 'kpen' layer.<a name='2893'></font>
       <a name='2894'>
       <font color=#447700>! ------------------------------------------------------------------------------- !<a name='2895'></font>
       <font color=#447700>! Up to this point, we finished all of buoyancy sorting processes from the 'krel' !<a name='2896'></font>
       <font color=#447700>! layer to 'kpen' layer: at the top interface of individual layers, we calculated !<a name='2897'></font>
       <font color=#447700>! updraft and penetrative mass fluxes [ umf(k) &amp; emf(k) = 0 ], updraft fractional !<a name='2898'></font>
       <font color=#447700>! area [ ufrc(k) ],  updraft vertical velocity [ wu(k) ],  updraft  thermodynamic !<a name='2899'></font>
       <font color=#447700>! variables [thlu(k),qtu(k),uu(k),vu(k),thvu(k)]. In the layer,we also calculated !<a name='2900'></font>
       <font color=#447700>! fractional entrainment-detrainment rate [ fer(k), fdr(k) ], and detrainment ten !<a name='2901'></font>
       <font color=#447700>! dency of water and ice from cumulus updraft [ dwten(k), diten(k) ]. In addition,!<a name='2902'></font>
       <font color=#447700>! we updated and identified 'krel' and 'kpen' layer index, if any.  In the 'kpen' !<a name='2903'></font>
       <font color=#447700>! layer, we calculated everything mentioned above except the 'wu(k)' and 'ufrc(k)'!<a name='2904'></font>
       <font color=#447700>! since a real value of updraft vertical velocity is not defined at the kpen  top !<a name='2905'></font>
       <font color=#447700>! interface (note 'ufrc' at the top interface of layer is calculated from 'umf(k)'!<a name='2906'></font>
       <font color=#447700>! and 'wu(k)'). As mentioned before, special treatment is required when 'kbup' is !<a name='2907'></font>
       <font color=#447700>! not updated and so 'kbup = krel'.                                               !<a name='2908'></font>
       <font color=#447700>! ------------------------------------------------------------------------------- !<a name='2909'></font>
       <a name='2910'>
       <font color=#447700>! ------------------------------------------------------------------------------ !<a name='2911'></font>
       <font color=#447700>! During the 'iter_scaleh' iteration loop, non-physical ( with non-zero values ) !<a name='2912'></font>
       <font color=#447700>! values can remain in the variable arrays above (also 'including' in case of wu !<a name='2913'></font>
       <font color=#447700>! and ufrc at the top interface) the 'kpen' layer. This can happen when the kpen !<a name='2914'></font>
       <font color=#447700>! layer index identified from the 'iter_scaleh = 1' iteration loop is located at !<a name='2915'></font>
       <font color=#447700>! above the kpen layer index identified from   'iter_scaleh = 3' iteration loop. !<a name='2916'></font>
       <font color=#447700>! Thus, in the following calculations, we should only use the values in each     !<a name='2917'></font>
       <font color=#447700>! variables only up to finally identified 'kpen' layer &amp; 'kpen' interface except ! <a name='2918'></font>
       <font color=#447700>! 'wu' and 'ufrc' at the top interface of 'kpen' layer.    Note that in order to !<a name='2919'></font>
       <font color=#447700>! prevent any problems due to these non-physical values, I re-initialized    the !<a name='2920'></font>
       <font color=#447700>! values of [ umf(kpen:mkx), emf(kpen:mkx), dwten(kpen+1:mkx), diten(kpen+1:mkx),! <a name='2921'></font>
       <font color=#447700>! fer(kpen:mkx), fdr(kpen+1:mkx), ufrc(kpen:mkx) ] to be zero after 'iter_scaleh'!<a name='2922'></font>
       <font color=#447700>! do loop.                                                                       !<a name='2923'></font>
       <font color=#447700>! ------------------------------------------------------------------------------ !<a name='2924'></font>
       <a name='2925'>
 45    continue<a name='2926'>
<a name='2927'>
       <font color=#447700>! ------------------------------------------------------------------------------ !<a name='2928'></font>
       <font color=#447700>! Calculate 'ppen( &lt; 0 )', updarft penetrative distance from the lower interface !<a name='2929'></font>
       <font color=#447700>! of 'kpen' layer. Note that bogbot &amp; bogtop at the 'kpen' layer either when fer !<a name='2930'></font>
       <font color=#447700>! is zero or non-zero was already calculated above.                              !<a name='2931'></font>
       <font color=#447700>! It seems that below qudarature solving formula is valid only when bogbot &lt; 0.  !<a name='2932'></font>
       <font color=#447700>! Below solving equation is clearly wrong ! I should revise this !               !<a name='2933'></font>
       <font color=#447700>! ------------------------------------------------------------------------------ ! <a name='2934'></font>
            <a name='2935'>
       if( drage .eq. 0._r8 ) then<a name='2936'>
           aquad =  ( bogtop - bogbot ) / ( ps0(kpen) - ps0(kpen-1) )<a name='2937'>
           bquad =  2._r8 * bogbot<a name='2938'>
           cquad = -wu(kpen-1)**2 * rho0j<a name='2939'>
           call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#ROOTS'>roots</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROOTS_3">(aquad,bquad,cquad,xc1,xc2,status)<a name='2940'>
           if( status .eq. 0 ) then<a name='2941'>
               if( xc1 .le. 0._r8 .and. xc2 .le. 0._r8 ) then<a name='2942'>
                   ppen = max( xc1, xc2 )<a name='2943'>
                   ppen = min( 0._r8,max( -dp0(kpen), ppen ) )  <a name='2944'>
               elseif( xc1 .gt. 0._r8 .and. xc2 .gt. 0._r8 ) then<a name='2945'>
                   ppen = -dp0(kpen)<a name='2946'>
                   write(iulog,*) 'Warning : UW-Cumulus penetrates upto kpen interface'<a name='2947'>
#ifdef WRF_PORT<a name='2948'>
                   call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1054">(iulog)<a name='2949'>
#endif<a name='2950'>
               else<a name='2951'>
                   ppen = min( xc1, xc2 )<a name='2952'>
                   ppen = min( 0._r8,max( -dp0(kpen), ppen ) )  <a name='2953'>
               endif<a name='2954'>
           else<a name='2955'>
               ppen = -dp0(kpen)<a name='2956'>
               write(iulog,*) 'Warning : UW-Cumulus penetrates upto kpen interface'<a name='2957'>
#ifdef WRF_PORT<a name='2958'>
               call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1055">(iulog)<a name='2959'>
#endif<a name='2960'>
           endif       <a name='2961'>
       else <a name='2962'>
           ppen = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_PPEN'>compute_ppen</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_PPEN_1">(wtwb,drage,bogbot,bogtop,rho0j,dp0(kpen))<a name='2963'>
       endif<a name='2964'>
       if( ppen .eq. -dp0(kpen) .or. ppen .eq. 0._r8 ) limit_ppen(i) = 1._r8<a name='2965'>
<a name='2966'>
       <font color=#447700>! -------------------------------------------------------------------- !<a name='2967'></font>
       <font color=#447700>! Re-calculate the amount of expelled condensate from cloud updraft    !<a name='2968'></font>
       <font color=#447700>! at the cumulus top. This is necessary for refined calculations of    !<a name='2969'></font>
       <font color=#447700>! bulk cloud microphysics at the cumulus top. Note that ppen &lt; 0._r8   !<a name='2970'></font>
       <font color=#447700>! In the below, I explicitly calculate 'thlu_top' &amp; 'qtu_top' by       !<a name='2971'></font>
       <font color=#447700>! using non-zero 'fer(kpen)'.                                          !    <a name='2972'></font>
       <font color=#447700>! -------------------------------------------------------------------- !<a name='2973'></font>
<a name='2974'>
       if( fer(kpen)*(-ppen) .lt. 1.e-4_r8 ) then<a name='2975'>
           thlu_top = thlu(kpen-1) + ( thl0(kpen) + ssthl0(kpen) * (-ppen) / 2._r8 - thlu(kpen-1) ) * fer(kpen) * (-ppen)<a name='2976'>
           qtu_top  =  qtu(kpen-1) + (  qt0(kpen) +  ssqt0(kpen) * (-ppen) / 2._r8  - qtu(kpen-1) ) * fer(kpen) * (-ppen)<a name='2977'>
       else<a name='2978'>
           thlu_top = ( thl0(kpen) + ssthl0(kpen) / fer(kpen) - ssthl0(kpen) * (-ppen) / 2._r8 ) - &amp;<a name='2979'>
                      ( thl0(kpen) + ssthl0(kpen) * (-ppen) / 2._r8 - thlu(kpen-1) + ssthl0(kpen) / fer(kpen) ) * &amp;<a name='2980'>
                        exp(-fer(kpen) * (-ppen))<a name='2981'>
           qtu_top  = ( qt0(kpen)  +  ssqt0(kpen) / fer(kpen) -  ssqt0(kpen) * (-ppen) / 2._r8 ) - &amp;  <a name='2982'>
                      ( qt0(kpen)  +  ssqt0(kpen) * (-ppen) / 2._r8 -  qtu(kpen-1) +  ssqt0(kpen) / fer(kpen) ) * &amp;<a name='2983'>
                        exp(-fer(kpen) * (-ppen))<a name='2984'>
       end if<a name='2985'>
<a name='2986'>
       call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_15">(ps0(kpen-1)+ppen,thlu_top,qtu_top,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='2987'>
       if( id_check .eq. 1 ) then<a name='2988'>
           exit_conden(i) = 1._r8<a name='2989'>
           id_exit = .true.<a name='2990'>
           go to 333<a name='2991'>
       end if<a name='2992'>
       exntop = ((ps0(kpen-1)+ppen)/p00)**rovcp<a name='2993'>
       if( (qlj + qij) .gt. criqc ) then<a name='2994'>
            dwten(kpen) = ( ( qlj + qij ) - criqc ) * qlj / ( qlj + qij )<a name='2995'>
            diten(kpen) = ( ( qlj + qij ) - criqc ) * qij / ( qlj + qij )<a name='2996'>
            qtu_top  = qtu_top - dwten(kpen) - diten(kpen)<a name='2997'>
            thlu_top = thlu_top + (xlv/cp/exntop)*dwten(kpen) + (xls/cp/exntop)*diten(kpen) <a name='2998'>
       else<a name='2999'>
            dwten(kpen) = 0._r8<a name='3000'>
            diten(kpen) = 0._r8<a name='3001'>
       endif      <a name='3002'>
 <a name='3003'>
       <font color=#447700>! ----------------------------------------------------------------------- !<a name='3004'></font>
       <font color=#447700>! Calculate cumulus scale height as the top height that cumulus can reach.!<a name='3005'></font>
       <font color=#447700>! ----------------------------------------------------------------------- !<a name='3006'></font>
       <a name='3007'>
       rhos0j = ps0(kpen-1)/(r*0.5_r8*(thv0bot(kpen)+thv0top(kpen-1))*exns0(kpen-1))  <a name='3008'>
       cush   = zs0(kpen-1) - ppen/rhos0j/g<a name='3009'>
       scaleh = cush <a name='3010'>
<a name='3011'>
    end do   <font color=#447700>! End of 'iter_scaleh' loop.   <a name='3012'></font>
<a name='3013'>
       <font color=#447700>! -------------------------------------------------------------------- !   <a name='3014'></font>
       <font color=#447700>! The 'forcedCu' is logical identifier saying whether cumulus updraft  !<a name='3015'></font>
       <font color=#447700>! overcome the buoyancy barrier just above the PBL top. If it is true, !<a name='3016'></font>
       <font color=#447700>! cumulus did not overcome the barrier -  this is a shallow convection !<a name='3017'></font>
       <font color=#447700>! with negative cloud buoyancy, mimicking  shallow continental cumulus !<a name='3018'></font>
       <font color=#447700>! convection. Depending on 'forcedCu' parameter, treatment of heat  &amp;  !<a name='3019'></font>
       <font color=#447700>! moisture fluxes at the entraining interfaces, 'kbup &lt;= k &lt; kpen - 1' !<a name='3020'></font>
       <font color=#447700>! will be set up in a different ways, as will be shown later.          !<a name='3021'></font>
       <font color=#447700>! -------------------------------------------------------------------- !<a name='3022'></font>
 <a name='3023'>
       if( kbup .eq. krel ) then <a name='3024'>
           forcedCu = .true.<a name='3025'>
           limit_shcu(i) = 1._r8<a name='3026'>
       else<a name='3027'>
           forcedCu = .false.<a name='3028'>
           limit_shcu(i) = 0._r8<a name='3029'>
       endif  <a name='3030'>
       <a name='3031'>
       <font color=#447700>! ------------------------------------------------------------------ !<a name='3032'></font>
       <font color=#447700>! Filtering of unerasonable cumulus adjustment here.  This is a very !<a name='3033'></font>
       <font color=#447700>! important process which should be done cautiously. Various ways of !<a name='3034'></font>
       <font color=#447700>! filtering are possible depending on cases mainly using the indices !<a name='3035'></font>
       <font color=#447700>! of key layers - 'klcl','kinv','krel','klfc','kbup','kpen'. At this !<a name='3036'></font>
       <font color=#447700>! stage, the followings are all possible : 'kinv &gt;= 2', 'klcl &gt;= 1', !<a name='3037'></font>
       <font color=#447700>! 'krel &gt;= kinv', 'kbup &gt;= krel', 'kpen &gt;= krel'. I must design this !<a name='3038'></font>
       <font color=#447700>! filtering very cautiously, in such that none of  realistic cumulus !<a name='3039'></font>
       <font color=#447700>! convection is arbitrarily turned-off. Potentially, I might turn-off! <a name='3040'></font>
       <font color=#447700>! cumulus convection if layer-mean 'ql &gt; 0' in the 'kinv-1' layer,in !<a name='3041'></font>
       <font color=#447700>! order to suppress cumulus convection growing, based at the Sc top. ! <a name='3042'></font>
       <font color=#447700>! This is one of potential future modifications. Note that ppen &lt; 0. !<a name='3043'></font>
       <font color=#447700>! ------------------------------------------------------------------ !<a name='3044'></font>
<a name='3045'>
       cldhgt = ps0(kpen-1) + ppen<a name='3046'>
       if( forcedCu ) then<a name='3047'>
           <font color=#447700>! write(iulog,*) 'forcedCu - did not overcome initial buoyancy barrier'<a name='3048'></font>
           exit_cufilter(i) = 1._r8<a name='3049'>
           id_exit = .true.<a name='3050'>
           go to 333<a name='3051'>
       end if<a name='3052'>
       <font color=#447700>! Limit 'additional shallow cumulus' for DYCOMS simulation.<a name='3053'></font>
       <font color=#447700>! if( cldhgt.ge.88000._r8 ) then<a name='3054'></font>
       <font color=#447700>!     id_exit = .true.<a name='3055'></font>
       <font color=#447700>!     go to 333<a name='3056'></font>
       <font color=#447700>! end if<a name='3057'></font>
       <a name='3058'>
       <font color=#447700>! ------------------------------------------------------------------------------ !<a name='3059'></font>
       <font color=#447700>! Re-initializing some key variables above the 'kpen' layer in order to suppress !<a name='3060'></font>
       <font color=#447700>! the influence of non-physical values above 'kpen', in association with the use !<a name='3061'></font>
       <font color=#447700>! of 'iter_scaleh' loop. Note that umf, emf,  ufrc are defined at the interfaces !<a name='3062'></font>
       <font color=#447700>! (0:mkx), while 'dwten','diten', 'fer', 'fdr' are defined at layer mid-points.  !<a name='3063'></font>
       <font color=#447700>! Initialization of 'fer' and 'fdr' is for correct writing purpose of diagnostic !<a name='3064'></font>
       <font color=#447700>! output. Note that we set umf(kpen)=emf(kpen)=ufrc(kpen)=0, in consistent  with !<a name='3065'></font>
       <font color=#447700>! wtw &lt; 0  at the top interface of 'kpen' layer. However, we still have non-zero !<a name='3066'></font>
       <font color=#447700>! expelled cloud condensate in the 'kpen' layer.                                 !<a name='3067'></font>
       <font color=#447700>! ------------------------------------------------------------------------------ !<a name='3068'></font>
<a name='3069'>
       umf(kpen:mkx)     = 0._r8<a name='3070'>
       emf(kpen:mkx)     = 0._r8<a name='3071'>
       ufrc(kpen:mkx)    = 0._r8<a name='3072'>
       dwten(kpen+1:mkx) = 0._r8<a name='3073'>
       diten(kpen+1:mkx) = 0._r8<a name='3074'>
       fer(kpen+1:mkx)   = 0._r8<a name='3075'>
       fdr(kpen+1:mkx)   = 0._r8<a name='3076'>
       <a name='3077'>
       <font color=#447700>! ------------------------------------------------------------------------ !<a name='3078'></font>
       <font color=#447700>! Calculate downward penetrative entrainment mass flux, 'emf(k) &lt; 0',  and !<a name='3079'></font>
       <font color=#447700>! thermodynamic properties of penetratively entrained airs at   entraining !<a name='3080'></font>
       <font color=#447700>! interfaces. emf(k) is defined from the top interface of the  layer  kbup !<a name='3081'></font>
       <font color=#447700>! to the bottom interface of the layer 'kpen'. Note even when  kbup = krel,!<a name='3082'></font>
       <font color=#447700>! i.e.,even when 'kbup' was not updated in the above buoyancy  sorting  do !<a name='3083'></font>
       <font color=#447700>! loop (i.e., 'kbup' remains as the initialization value),   below do loop !<a name='3084'></font>
       <font color=#447700>! of penetrative entrainment flux can be performed without  any conceptual !<a name='3085'></font>
       <font color=#447700>! or logical problems, because we have already computed all  the variables !<a name='3086'></font>
       <font color=#447700>! necessary for performing below penetrative entrainment block.            !<a name='3087'></font>
       <font color=#447700>! In the below 'do' loop, 'k' is an interface index at which non-zero 'emf'! <a name='3088'></font>
       <font color=#447700>! (penetrative entrainment mass flux) is calculated. Since cumulus updraft !<a name='3089'></font>
       <font color=#447700>! is negatively buoyant in the layers between the top interface of 'kbup'  !<a name='3090'></font>
       <font color=#447700>! layer (interface index, kbup) and the top interface of 'kpen' layer, the !<a name='3091'></font>
       <font color=#447700>! fractional lateral entrainment, fer(k) within these layers will be close !<a name='3092'></font>
       <font color=#447700>! to zero - so it is likely that only strong lateral detrainment occurs in !<a name='3093'></font>
       <font color=#447700>! thses layers. Under this situation,we can easily calculate the amount of !<a name='3094'></font>
       <font color=#447700>! detrainment cumulus air into these negatively buoyanct layers by  simply !<a name='3095'></font>
       <font color=#447700>! comparing cumulus updraft mass fluxes between the base and top interface !<a name='3096'></font>
       <font color=#447700>! of each layer: emf(k) = emf(k-1)*exp(-fdr(k)*dp0(k))                     !<a name='3097'></font>
       <font color=#447700>!                       ~ emf(k-1)*(1-rei(k)*dp0(k))                       !<a name='3098'></font>
       <font color=#447700>!                emf(k-1)-emf(k) ~ emf(k-1)*rei(k)*dp0(k)                  !<a name='3099'></font>
       <font color=#447700>! Current code assumes that about 'rpen~10' times of these detrained  mass !<a name='3100'></font>
       <font color=#447700>! are penetratively re-entrained down into the 'k-1' interface. And all of !<a name='3101'></font>
       <font color=#447700>! these detrained masses are finally dumped down into the top interface of !<a name='3102'></font>
       <font color=#447700>! 'kbup' layer. Thus, the amount of penetratively entrained air across the !<a name='3103'></font>
       <font color=#447700>! top interface of 'kbup' layer with 'rpen~10' becomes too large.          !<a name='3104'></font>
       <font color=#447700>! Note that this penetrative entrainment part can be completely turned-off !<a name='3105'></font>
       <font color=#447700>! and we can simply use normal buoyancy-sorting involved turbulent  fluxes !<a name='3106'></font>
       <font color=#447700>! by modifying 'penetrative entrainment fluxes' part below.                !<a name='3107'></font>
       <font color=#447700>! ------------------------------------------------------------------------ !<a name='3108'></font>
       <a name='3109'>
       <font color=#447700>! -----------------------------------------------------------------------!<a name='3110'></font>
       <font color=#447700>! Calculate entrainment mass flux and conservative scalars of entraining !<a name='3111'></font>
       <font color=#447700>! free air at interfaces of 'kbup &lt;= k &lt; kpen - 1'                       !<a name='3112'></font>
       <font color=#447700>! ---------------------------------------------------------------------- !<a name='3113'></font>
 <a name='3114'>
       do k = 0, mkx<a name='3115'>
          thlu_emf(k) = thlu(k)<a name='3116'>
          qtu_emf(k)  = qtu(k)<a name='3117'>
          uu_emf(k)   = uu(k)<a name='3118'>
          vu_emf(k)   = vu(k)<a name='3119'>
          do m = 1, ncnst<a name='3120'>
             tru_emf(k,m)  = tru(k,m)<a name='3121'>
          enddo<a name='3122'>
       end do<a name='3123'>
<a name='3124'>
       do k = kpen - 1, kbup, -1  <font color=#447700>! Here, 'k' is an interface index at which<a name='3125'></font>
                                  <font color=#447700>! penetrative entrainment fluxes are calculated. <a name='3126'></font>
                                  <a name='3127'>
          rhos0j = ps0(k) / ( r * 0.5_r8 * ( thv0bot(k+1) + thv0top(k) ) * exns0(k) )<a name='3128'>
<a name='3129'>
          if( k .eq. kpen - 1 ) then<a name='3130'>
<a name='3131'>
             <font color=#447700>! ------------------------------------------------------------------------ ! <a name='3132'></font>
             <font color=#447700>! Note that 'ppen' has already been calculated in the above 'iter_scaleh'  !<a name='3133'></font>
             <font color=#447700>! loop assuming zero lateral entrainmentin the layer 'kpen'.               !<a name='3134'></font>
             <font color=#447700>! ------------------------------------------------------------------------ !       <a name='3135'></font>
             <a name='3136'>
             <font color=#447700>! -------------------------------------------------------------------- !<a name='3137'></font>
             <font color=#447700>! Calculate returning mass flux, emf ( &lt; 0 )                           !<a name='3138'></font>
             <font color=#447700>! Current penetrative entrainment rate with 'rpen~10' is too large and !<a name='3139'></font>
             <font color=#447700>! future refinement is necessary including the definition of 'thl','qt'! <a name='3140'></font>
             <font color=#447700>! of penetratively entrained air.  Penetratively entrained airs across !<a name='3141'></font>
             <font color=#447700>! the 'kpen-1' interface is assumed to have the properties of the base !<a name='3142'></font>
             <font color=#447700>! interface of 'kpen' layer. Note that 'emf ~ - umf/ufrc = - w * rho'. !<a name='3143'></font>
             <font color=#447700>! Thus, below limit sets an upper limit of |emf| to be ~ 10cm/s, which !<a name='3144'></font>
             <font color=#447700>! is very loose constraint. Here, I used more restricted constraint on !<a name='3145'></font>
             <font color=#447700>! the limit of emf, assuming 'emf' cannot exceed a net mass within the !<a name='3146'></font>
             <font color=#447700>! layer above the interface. Similar to the case of warming and drying !<a name='3147'></font>
             <font color=#447700>! due to cumulus updraft induced compensating subsidence,  penetrative !<a name='3148'></font>
             <font color=#447700>! entrainment induces compensating upwelling -     in order to prevent !  <a name='3149'></font>
             <font color=#447700>! numerical instability in association with compensating upwelling, we !<a name='3150'></font>
             <font color=#447700>! should similarily limit the amount of penetrative entrainment at the !<a name='3151'></font>
             <font color=#447700>! interface by the amount of masses within the layer just above the    !<a name='3152'></font>
             <font color=#447700>! penetratively entraining interface.                                  !<a name='3153'></font>
             <font color=#447700>! -------------------------------------------------------------------- !<a name='3154'></font>
             <a name='3155'>
             if( ( umf(k)*ppen*rei(kpen)*rpen ) .lt. -0.1_r8*rhos0j )         limit_emf(i) = 1._r8<a name='3156'>
             if( ( umf(k)*ppen*rei(kpen)*rpen ) .lt. -0.9_r8*dp0(kpen)/g/dt ) limit_emf(i) = 1._r8             <a name='3157'>
<a name='3158'>
             emf(k) = max( max( umf(k)*ppen*rei(kpen)*rpen, -0.1_r8*rhos0j), -0.9_r8*dp0(kpen)/g/dt)<a name='3159'>
             thlu_emf(k) = thl0(kpen) + ssthl0(kpen) * ( ps0(k) - p0(kpen) )<a name='3160'>
             qtu_emf(k)  = qt0(kpen)  + ssqt0(kpen)  * ( ps0(k) - p0(kpen) )<a name='3161'>
             uu_emf(k)   = u0(kpen)   + ssu0(kpen)   * ( ps0(k) - p0(kpen) )     <a name='3162'>
             vu_emf(k)   = v0(kpen)   + ssv0(kpen)   * ( ps0(k) - p0(kpen) )   <a name='3163'>
             do m = 1, ncnst<a name='3164'>
                tru_emf(k,m)  = tr0(kpen,m)  + sstr0(kpen,m)  * ( ps0(k) - p0(kpen) )<a name='3165'>
             enddo<a name='3166'>
<a name='3167'>
          else <font color=#447700>! if(k.lt.kpen-1). <a name='3168'></font>
              <a name='3169'>
             <font color=#447700>! --------------------------------------------------------------------------- !<a name='3170'></font>
             <font color=#447700>! Note we are coming down from the higher interfaces to the lower interfaces. !<a name='3171'></font>
             <font color=#447700>! Also note that 'emf &lt; 0'. So, below operation is a summing not subtracting. !<a name='3172'></font>
             <font color=#447700>! In order to ensure numerical stability, I imposed a modified correct limit  ! <a name='3173'></font>
             <font color=#447700>! of '-0.9*dp0(k+1)/g/dt' on emf(k).                                          !<a name='3174'></font>
             <font color=#447700>! --------------------------------------------------------------------------- !<a name='3175'></font>
<a name='3176'>
             if( use_cumpenent ) then  <font color=#447700>! Original Cumulative Penetrative Entrainment<a name='3177'></font>
<a name='3178'>
                 if( ( emf(k+1)-umf(k)*dp0(k+1)*rei(k+1)*rpen ) .lt. -0.1_r8*rhos0j )        limit_emf(i) = 1<a name='3179'>
                 if( ( emf(k+1)-umf(k)*dp0(k+1)*rei(k+1)*rpen ) .lt. -0.9_r8*dp0(k+1)/g/dt ) limit_emf(i) = 1         <a name='3180'>
                 emf(k) = max(max(emf(k+1)-umf(k)*dp0(k+1)*rei(k+1)*rpen, -0.1_r8*rhos0j), -0.9_r8*dp0(k+1)/g/dt )    <a name='3181'>
                 if( abs(emf(k)) .gt. abs(emf(k+1)) ) then<a name='3182'>
                     thlu_emf(k) = ( thlu_emf(k+1) * emf(k+1) + thl0(k+1) * ( emf(k) - emf(k+1) ) ) / emf(k)<a name='3183'>
                     qtu_emf(k)  = ( qtu_emf(k+1)  * emf(k+1) + qt0(k+1)  * ( emf(k) - emf(k+1) ) ) / emf(k)<a name='3184'>
                     uu_emf(k)   = ( uu_emf(k+1)   * emf(k+1) + u0(k+1)   * ( emf(k) - emf(k+1) ) ) / emf(k)<a name='3185'>
                     vu_emf(k)   = ( vu_emf(k+1)   * emf(k+1) + v0(k+1)   * ( emf(k) - emf(k+1) ) ) / emf(k)<a name='3186'>
                     do m = 1, ncnst<a name='3187'>
                        tru_emf(k,m)  = ( tru_emf(k+1,m)  * emf(k+1) + tr0(k+1,m)  * ( emf(k) - emf(k+1) ) ) / emf(k)<a name='3188'>
                     enddo<a name='3189'>
                 else   <a name='3190'>
                     thlu_emf(k) = thl0(k+1)<a name='3191'>
                     qtu_emf(k)  =  qt0(k+1)<a name='3192'>
                     uu_emf(k)   =   u0(k+1)<a name='3193'>
                     vu_emf(k)   =   v0(k+1)<a name='3194'>
                     do m = 1, ncnst<a name='3195'>
                        tru_emf(k,m)  =  tr0(k+1,m)<a name='3196'>
                     enddo<a name='3197'>
                 endif   <a name='3198'>
                     <a name='3199'>
             else <font color=#447700>! Alternative Non-Cumulative Penetrative Entrainment<a name='3200'></font>
<a name='3201'>
                 if( ( -umf(k)*dp0(k+1)*rei(k+1)*rpen ) .lt. -0.1_r8*rhos0j )        limit_emf(i) = 1<a name='3202'>
                 if( ( -umf(k)*dp0(k+1)*rei(k+1)*rpen ) .lt. -0.9_r8*dp0(k+1)/g/dt ) limit_emf(i) = 1         <a name='3203'>
                 emf(k) = max(max(-umf(k)*dp0(k+1)*rei(k+1)*rpen, -0.1_r8*rhos0j), -0.9_r8*dp0(k+1)/g/dt )    <a name='3204'>
                 thlu_emf(k) = thl0(k+1)<a name='3205'>
                 qtu_emf(k)  =  qt0(k+1)<a name='3206'>
                 uu_emf(k)   =   u0(k+1)<a name='3207'>
                 vu_emf(k)   =   v0(k+1)<a name='3208'>
                 do m = 1, ncnst<a name='3209'>
                    tru_emf(k,m)  =  tr0(k+1,m)<a name='3210'>
                 enddo<a name='3211'>
<a name='3212'>
             endif<a name='3213'>
<a name='3214'>
          endif<a name='3215'>
<a name='3216'>
          <font color=#447700>! ---------------------------------------------------------------------------- !<a name='3217'></font>
          <font color=#447700>! In this GCM modeling framework,  all what we should do is to calculate  heat !<a name='3218'></font>
          <font color=#447700>! and moisture fluxes at the given geometrically-fixed height interfaces -  we !<a name='3219'></font>
          <font color=#447700>! don't need to worry about movement of material height surface in association !<a name='3220'></font>
          <font color=#447700>! with compensating subsidence or unwelling, in contrast to the bulk modeling. !<a name='3221'></font>
          <font color=#447700>! In this geometrically fixed height coordinate system, heat and moisture flux !<a name='3222'></font>
          <font color=#447700>! at the geometrically fixed height handle everything - a movement of material !<a name='3223'></font>
          <font color=#447700>! surface is implicitly treated automatically. Note that in terms of turbulent !<a name='3224'></font>
          <font color=#447700>! heat and moisture fluxes at model interfaces, both the cumulus updraft  mass !<a name='3225'></font>
          <font color=#447700>! flux and penetratively entraining mass flux play the same role -both of them ! <a name='3226'></font>
          <font color=#447700>! warms and dries the 'kbup' layer, cools and moistens the 'kpen' layer,   and !<a name='3227'></font>
          <font color=#447700>! cools and moistens any intervening layers between 'kbup' and 'kpen' layers.  !<a name='3228'></font>
          <font color=#447700>! It is important to note these identical roles on turbulent heat and moisture !<a name='3229'></font>
          <font color=#447700>! fluxes of 'umf' and 'emf'.                                                   !<a name='3230'></font>
          <font color=#447700>! When 'kbup' is a stratocumulus-topped PBL top interface,  increase of 'rpen' !<a name='3231'></font>
          <font color=#447700>! is likely to strongly diffuse stratocumulus top interface,  resulting in the !<a name='3232'></font>
          <font color=#447700>! reduction of cloud fraction. In this sense, the 'kbup' interface has a  very !<a name='3233'></font>
          <font color=#447700>! important meaning and role : across the 'kbup' interface, strong penetrative !<a name='3234'></font>
          <font color=#447700>! entrainment occurs, thus any sharp gradient properties across that interface !<a name='3235'></font>
          <font color=#447700>! are easily diffused through strong mass exchange. Thus, an initialization of ! <a name='3236'></font>
          <font color=#447700>! 'kbup' (and also 'kpen') should be done very cautiously as mentioned before. ! <a name='3237'></font>
          <font color=#447700>! In order to prevent this stron diffusion for the shallow cumulus convection  !<a name='3238'></font>
          <font color=#447700>! based at the Sc top, it seems to be good to initialize 'kbup = krel', rather !<a name='3239'></font>
          <font color=#447700>! that 'kbup = krel-1'.                                                        !<a name='3240'></font>
          <font color=#447700>! ---------------------------------------------------------------------------- !<a name='3241'></font>
          <a name='3242'>
       end do<a name='3243'>
<a name='3244'>
       <font color=#447700>!------------------------------------------------------------------ !<a name='3245'></font>
       <font color=#447700>!                                                                   ! <a name='3246'></font>
       <font color=#447700>! Compute turbulent heat, moisture, momentum flux at all interfaces !<a name='3247'></font>
       <font color=#447700>!                                                                   !<a name='3248'></font>
       <font color=#447700>!------------------------------------------------------------------ !<a name='3249'></font>
       <font color=#447700>! It is very important to note that in calculating turbulent fluxes !<a name='3250'></font>
       <font color=#447700>! below, we must not double count turbulent flux at any interefaces.!<a name='3251'></font>
       <font color=#447700>! In the below, turbulent fluxes at the interfaces (interface index !<a name='3252'></font>
       <font color=#447700>! k) are calculated by the following 4 blocks in consecutive order: !<a name='3253'></font>
       <font color=#447700>!                                                                   !<a name='3254'></font>
       <font color=#447700>! (1) " 0 &lt;= k &lt;= kinv - 1 "  : PBL fluxes.                         !<a name='3255'></font>
       <font color=#447700>!     From 'fluxbelowinv' using reconstructed PBL height. Currently,!<a name='3256'></font>
       <font color=#447700>!     the reconstructed PBLs are independently calculated for  each !<a name='3257'></font>
       <font color=#447700>!     individual conservative scalar variables ( qt, thl, u, v ) in !<a name='3258'></font>
       <font color=#447700>!     each 'fluxbelowinv',  instead of being uniquely calculated by !<a name='3259'></font>
       <font color=#447700>!     using thvl. Turbulent flux at the surface is assumed to be 0. !<a name='3260'></font>
       <font color=#447700>! (2) " kinv &lt;= k &lt;= krel - 1 " : Non-buoyancy sorting fluxes       !<a name='3261'></font>
       <font color=#447700>!     Assuming cumulus mass flux  and cumulus updraft thermodynamic !<a name='3262'></font>
       <font color=#447700>!     properties (except u, v which are modified by the PGFc during !<a name='3263'></font>
       <font color=#447700>!     upward motion) are conserved during a updraft motion from the !<a name='3264'></font>
       <font color=#447700>!     PBL top interface to the release level. If these layers don't !<a name='3265'></font>
       <font color=#447700>!     exist (e,g, when 'krel = kinv'), then  current routine do not !<a name='3266'></font>
       <font color=#447700>!     perform this routine automatically. So I don't need to modify !<a name='3267'></font>
       <font color=#447700>!     anything.                                                     ! <a name='3268'></font>
       <font color=#447700>! (3) " krel &lt;= k &lt;= kbup - 1 " : Buoyancy sorting fluxes           !<a name='3269'></font>
       <font color=#447700>!     From laterally entraining-detraining buoyancy sorting plumes. ! <a name='3270'></font>
       <font color=#447700>! (4) " kbup &lt;= k &lt; kpen-1 " : Penetrative entrainment fluxes       !<a name='3271'></font>
       <font color=#447700>!     From penetratively entraining plumes,                         !<a name='3272'></font>
       <font color=#447700>!                                                                   !<a name='3273'></font>
       <font color=#447700>! In case of normal situation, turbulent interfaces  in each groups !<a name='3274'></font>
       <font color=#447700>! are mutually independent of each other. Thus double flux counting !<a name='3275'></font>
       <font color=#447700>! or ambiguous flux counting requiring the choice among the above 4 !<a name='3276'></font>
       <font color=#447700>! groups do not occur normally. However, in case that cumulus plume !<a name='3277'></font>
       <font color=#447700>! could not completely overcome the buoyancy barrier just above the !<a name='3278'></font>
       <font color=#447700>! PBL top interface and so 'kbup = krel' (.forcedCu=.true.) ( here, !<a name='3279'></font>
       <font color=#447700>! it can be either 'kpen = krel' as the initialization, or ' kpen &gt; !<a name='3280'></font>
       <font color=#447700>! krel' if cumulus updraft just penetrated over the top of  release !<a name='3281'></font>
       <font color=#447700>! layer ). If this happens, we should be very careful in organizing !<a name='3282'></font>
       <font color=#447700>! the sequence of the 4 calculation routines above -  note that the !<a name='3283'></font>
       <font color=#447700>! routine located at the later has the higher priority.  Additional ! <a name='3284'></font>
       <font color=#447700>! feature I must consider is that when 'kbup = kinv - 1' (this is a !<a name='3285'></font>
       <font color=#447700>! combined situation of 'kbup=krel-1' &amp; 'krel = kinv' when I  chose !<a name='3286'></font>
       <font color=#447700>! 'kbup=krel-1' instead of current choice of 'kbup=krel'), a strong !<a name='3287'></font>
       <font color=#447700>! penetrative entrainment fluxes exists at the PBL top interface, &amp; !<a name='3288'></font>
       <font color=#447700>! all of these fluxes are concentrated (deposited) within the layer ! <a name='3289'></font>
       <font color=#447700>! just below PBL top interface (i.e., 'kinv-1' layer). On the other !<a name='3290'></font>
       <font color=#447700>! hand, in case of 'fluxbelowinv', only the compensating subsidence !<a name='3291'></font>
       <font color=#447700>! effect is concentrated in the 'kinv-1' layer and 'pure' turbulent !<a name='3292'></font>
       <font color=#447700>! heat and moisture fluxes ( 'pure' means the fluxes not associated !<a name='3293'></font>
       <font color=#447700>! with compensating subsidence) are linearly distributed throughout !<a name='3294'></font>
       <font color=#447700>! the whole PBL. Thus different choice of the above flux groups can !<a name='3295'></font>
       <font color=#447700>! produce very different results. Output variable should be written !<a name='3296'></font>
       <font color=#447700>! consistently to the choice of computation sequences.              !<a name='3297'></font>
       <font color=#447700>! When the case of 'kbup = krel(-1)' happens,another way to dealing !<a name='3298'></font>
       <font color=#447700>! with this case is to simply ' exit ' the whole cumulus convection !<a name='3299'></font>
       <font color=#447700>! calculation without performing any cumulus convection.     We can !<a name='3300'></font>
       <font color=#447700>! choose this approach by specifying a condition in the  'Filtering !<a name='3301'></font>
       <font color=#447700>! of unreasonable cumulus adjustment' just after 'iter_scaleh'. But !<a name='3302'></font>
       <font color=#447700>! this seems not to be a good choice (although this choice was used !<a name='3303'></font>
       <font color=#447700>! previous code ), since it might arbitrary damped-out  the shallow !<a name='3304'></font>
       <font color=#447700>! cumulus convection over the continent land, where shallow cumulus ! <a name='3305'></font>
       <font color=#447700>! convection tends to be negatively buoyant.                        !<a name='3306'></font>
       <font color=#447700>! ----------------------------------------------------------------- !  <a name='3307'></font>
<a name='3308'>
       <font color=#447700>! --------------------------------------------------- !<a name='3309'></font>
       <font color=#447700>! 1. PBL fluxes :  0 &lt;= k &lt;= kinv - 1                 !<a name='3310'></font>
       <font color=#447700>!    All the information necessary to reconstruct PBL ! <a name='3311'></font>
       <font color=#447700>!    height are passed to 'fluxbelowinv'.             !<a name='3312'></font>
       <font color=#447700>! --------------------------------------------------- !<a name='3313'></font>
<a name='3314'>
       xsrc  = qtsrc<a name='3315'>
       xmean = qt0(kinv)<a name='3316'>
       xtop  = qt0(kinv+1) + ssqt0(kinv+1) * ( ps0(kinv)   - p0(kinv+1) )<a name='3317'>
       xbot  = qt0(kinv-1) + ssqt0(kinv-1) * ( ps0(kinv-1) - p0(kinv-1) )        <a name='3318'>
       call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FLUXBELOWINV'>fluxbelowinv</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUXBELOWINV_1">( cbmf, ps0(0:mkx), mkx, kinv, dt, xsrc, xmean, xtop, xbot, xflx )<a name='3319'>
       qtflx(0:kinv-1) = xflx(0:kinv-1)<a name='3320'>
<a name='3321'>
       xsrc  = thlsrc<a name='3322'>
       xmean = thl0(kinv)<a name='3323'>
       xtop  = thl0(kinv+1) + ssthl0(kinv+1) * ( ps0(kinv)   - p0(kinv+1) )<a name='3324'>
       xbot  = thl0(kinv-1) + ssthl0(kinv-1) * ( ps0(kinv-1) - p0(kinv-1) )        <a name='3325'>
       call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FLUXBELOWINV'>fluxbelowinv</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUXBELOWINV_2">( cbmf, ps0(0:mkx), mkx, kinv, dt, xsrc, xmean, xtop, xbot, xflx )<a name='3326'>
       slflx(0:kinv-1) = cp * exns0(0:kinv-1) * xflx(0:kinv-1)<a name='3327'>
<a name='3328'>
       xsrc  = usrc<a name='3329'>
       xmean = u0(kinv)<a name='3330'>
       xtop  = u0(kinv+1) + ssu0(kinv+1) * ( ps0(kinv)   - p0(kinv+1) )<a name='3331'>
       xbot  = u0(kinv-1) + ssu0(kinv-1) * ( ps0(kinv-1) - p0(kinv-1) )<a name='3332'>
       call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FLUXBELOWINV'>fluxbelowinv</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUXBELOWINV_3">( cbmf, ps0(0:mkx), mkx, kinv, dt, xsrc, xmean, xtop, xbot, xflx )<a name='3333'>
       uflx(0:kinv-1) = xflx(0:kinv-1)<a name='3334'>
<a name='3335'>
       xsrc  = vsrc<a name='3336'>
       xmean = v0(kinv)<a name='3337'>
       xtop  = v0(kinv+1) + ssv0(kinv+1) * ( ps0(kinv)   - p0(kinv+1) )<a name='3338'>
       xbot  = v0(kinv-1) + ssv0(kinv-1) * ( ps0(kinv-1) - p0(kinv-1) )<a name='3339'>
       call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FLUXBELOWINV'>fluxbelowinv</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUXBELOWINV_4">( cbmf, ps0(0:mkx), mkx, kinv, dt, xsrc, xmean, xtop, xbot, xflx )<a name='3340'>
       vflx(0:kinv-1) = xflx(0:kinv-1)<a name='3341'>
<a name='3342'>
       do m = 1, ncnst<a name='3343'>
          xsrc  = trsrc(m)<a name='3344'>
          xmean = tr0(kinv,m)<a name='3345'>
          xtop  = tr0(kinv+1,m) + sstr0(kinv+1,m) * ( ps0(kinv)   - p0(kinv+1) )<a name='3346'>
          xbot  = tr0(kinv-1,m) + sstr0(kinv-1,m) * ( ps0(kinv-1) - p0(kinv-1) )        <a name='3347'>
          call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FLUXBELOWINV'>fluxbelowinv</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUXBELOWINV_5">( cbmf, ps0(0:mkx), mkx, kinv, dt, xsrc, xmean, xtop, xbot, xflx )<a name='3348'>
          trflx(0:kinv-1,m) = xflx(0:kinv-1)<a name='3349'>
       enddo<a name='3350'>
<a name='3351'>
       <font color=#447700>! -------------------------------------------------------------- !<a name='3352'></font>
       <font color=#447700>! 2. Non-buoyancy sorting fluxes : kinv &lt;= k &lt;= krel - 1         !<a name='3353'></font>
       <font color=#447700>!    Note that when 'krel = kinv', below block is never executed !<a name='3354'></font>
       <font color=#447700>!    as in a desirable, expected way ( but I must check  if this !<a name='3355'></font>
       <font color=#447700>!    is the case ). The non-buoyancy sorting fluxes are computed !<a name='3356'></font>
       <font color=#447700>!    only when 'krel &gt; kinv'.                                    !<a name='3357'></font>
       <font color=#447700>! -------------------------------------------------------------- !          <a name='3358'></font>
<a name='3359'>
       uplus = 0._r8<a name='3360'>
       vplus = 0._r8<a name='3361'>
       do k = kinv, krel - 1<a name='3362'>
          kp1 = k + 1<a name='3363'>
          qtflx(k) = cbmf * ( qtsrc  - (  qt0(kp1) +  ssqt0(kp1) * ( ps0(k) - p0(kp1) ) ) )          <a name='3364'>
          slflx(k) = cbmf * ( thlsrc - ( thl0(kp1) + ssthl0(kp1) * ( ps0(k) - p0(kp1) ) ) ) * cp * exns0(k)<a name='3365'>
          uplus    = uplus + PGFc * ssu0(k) * ( ps0(k) - ps0(k-1) )<a name='3366'>
          vplus    = vplus + PGFc * ssv0(k) * ( ps0(k) - ps0(k-1) )<a name='3367'>
          uflx(k)  = cbmf * ( usrc + uplus -  (  u0(kp1)  +   ssu0(kp1) * ( ps0(k) - p0(kp1) ) ) ) <a name='3368'>
          vflx(k)  = cbmf * ( vsrc + vplus -  (  v0(kp1)  +   ssv0(kp1) * ( ps0(k) - p0(kp1) ) ) )<a name='3369'>
          do m = 1, ncnst<a name='3370'>
             trflx(k,m) = cbmf * ( trsrc(m)  - (  tr0(kp1,m) +  sstr0(kp1,m) * ( ps0(k) - p0(kp1) ) ) )<a name='3371'>
          enddo          <a name='3372'>
       end do<a name='3373'>
<a name='3374'>
       <font color=#447700>! ------------------------------------------------------------------------ !<a name='3375'></font>
       <font color=#447700>! 3. Buoyancy sorting fluxes : krel &lt;= k &lt;= kbup - 1                       !<a name='3376'></font>
       <font color=#447700>!    In case that 'kbup = krel - 1 ' ( or even in case 'kbup = krel' ),    ! <a name='3377'></font>
       <font color=#447700>!    buoyancy sorting fluxes are not calculated, which is consistent,      !<a name='3378'></font>
       <font color=#447700>!    desirable feature.                                                    !  <a name='3379'></font>
       <font color=#447700>! ------------------------------------------------------------------------ !<a name='3380'></font>
<a name='3381'>
       do k = krel, kbup - 1      <a name='3382'>
          kp1 = k + 1<a name='3383'>
          slflx(k) = cp * exns0(k) * umf(k) * ( thlu(k) - ( thl0(kp1) + ssthl0(kp1) * ( ps0(k) - p0(kp1) ) ) )<a name='3384'>
          qtflx(k) = umf(k) * ( qtu(k) - ( qt0(kp1) + ssqt0(kp1) * ( ps0(k) - p0(kp1) ) ) )<a name='3385'>
          uflx(k)  = umf(k) * ( uu(k) - ( u0(kp1) + ssu0(kp1) * ( ps0(k) - p0(kp1) ) ) )<a name='3386'>
          vflx(k)  = umf(k) * ( vu(k) - ( v0(kp1) + ssv0(kp1) * ( ps0(k) - p0(kp1) ) ) )<a name='3387'>
          do m = 1, ncnst<a name='3388'>
             trflx(k,m) = umf(k) * ( tru(k,m) - ( tr0(kp1,m) + sstr0(kp1,m) * ( ps0(k) - p0(kp1) ) ) )<a name='3389'>
          enddo<a name='3390'>
       end do<a name='3391'>
<a name='3392'>
       <font color=#447700>! ------------------------------------------------------------------------- !<a name='3393'></font>
       <font color=#447700>! 4. Penetrative entrainment fluxes : kbup &lt;= k &lt;= kpen - 1                 !<a name='3394'></font>
       <font color=#447700>!    The only confliction that can happen is when 'kbup = kinv-1'. For this !<a name='3395'></font>
       <font color=#447700>!    case, turbulent flux at kinv-1 is calculated  both from 'fluxbelowinv' !<a name='3396'></font>
       <font color=#447700>!    and here as penetrative entrainment fluxes.  Since penetrative flux is !<a name='3397'></font>
       <font color=#447700>!    calculated later, flux at 'kinv - 1 ' will be that of penetrative flux.!<a name='3398'></font>
       <font color=#447700>!    However, turbulent flux calculated at 'kinv - 1' from penetrative entr.!<a name='3399'></font>
       <font color=#447700>!    is less attractable,  since more reasonable turbulent flux at 'kinv-1' !<a name='3400'></font>
       <font color=#447700>!    should be obtained from 'fluxbelowinv', by considering  re-constructed ! <a name='3401'></font>
       <font color=#447700>!    inversion base height. This conflicting problem can be solved if we can!<a name='3402'></font>
       <font color=#447700>!    initialize 'kbup = krel', instead of kbup = krel - 1. This choice seems!<a name='3403'></font>
       <font color=#447700>!    to be more reasonable since it is not conflicted with 'fluxbelowinv' in!<a name='3404'></font>
       <font color=#447700>!    calculating fluxes at 'kinv - 1' ( for this case, flux at 'kinv-1' is  !<a name='3405'></font>
       <font color=#447700>!    always from 'fluxbelowinv' ), and flux at 'krel-1' is calculated from  !<a name='3406'></font>
       <font color=#447700>!    the non-buoyancy sorting flux without being competed with penetrative  !<a name='3407'></font>
       <font color=#447700>!    entrainment fluxes. Even when we use normal cumulus flux instead of    !<a name='3408'></font>
       <font color=#447700>!    penetrative entrainment fluxes at 'kbup &lt;= k &lt;= kpen-1' interfaces,    !<a name='3409'></font>
       <font color=#447700>!    the initialization of kbup=krel perfectly works without any conceptual !<a name='3410'></font>
       <font color=#447700>!    confliction. Thus it seems to be much better to choose 'kbup = krel'   !<a name='3411'></font>
       <font color=#447700>!    initialization of 'kbup', which is current choice.                     !<a name='3412'></font>
       <font color=#447700>!    Note that below formula uses conventional updraft cumulus fluxes for   !<a name='3413'></font>
       <font color=#447700>!    shallow cumulus which did not overcome the first buoyancy barrier above!<a name='3414'></font>
       <font color=#447700>!    PBL top while uses penetrative entrainment fluxes for the other cases  !<a name='3415'></font>
       <font color=#447700>!    'kbup &lt;= k &lt;= kpen-1' interfaces. Depending on cases, however, I can   !<a name='3416'></font>
       <font color=#447700>!    selelct different choice.                                              !<a name='3417'></font>
       <font color=#447700>! ------------------------------------------------------------------------------------------------------------------ !<a name='3418'></font>
       <font color=#447700>!   if( forcedCu ) then                                                                                              !<a name='3419'></font>
       <font color=#447700>!       slflx(k) = cp * exns0(k) * umf(k) * ( thlu(k) - ( thl0(kp1) + ssthl0(kp1) * ( ps0(k) - p0(kp1) ) ) )         !<a name='3420'></font>
       <font color=#447700>!       qtflx(k) =                 umf(k) * (  qtu(k) - (  qt0(kp1) +  ssqt0(kp1) * ( ps0(k) - p0(kp1) ) ) )         !<a name='3421'></font>
       <font color=#447700>!       uflx(k)  =                 umf(k) * (   uu(k) - (   u0(kp1) +   ssu0(kp1) * ( ps0(k) - p0(kp1) ) ) )         !<a name='3422'></font>
       <font color=#447700>!       vflx(k)  =                 umf(k) * (   vu(k) - (   v0(kp1) +   ssv0(kp1) * ( ps0(k) - p0(kp1) ) ) )         !<a name='3423'></font>
       <font color=#447700>!       do m = 1, ncnst                                                                                              !<a name='3424'></font>
       <font color=#447700>!          trflx(k,m) = umf(k) * ( tru(k,m) - ( tr0(kp1,m) + sstr0(kp1,m) * ( ps0(k) - p0(kp1) ) ) )                 !<a name='3425'></font>
       <font color=#447700>!       enddo                                                                                                        !<a name='3426'></font>
       <font color=#447700>!   else                                                                                                             !<a name='3427'></font>
       <font color=#447700>!       slflx(k) = cp * exns0(k) * emf(k) * ( thlu_emf(k) - ( thl0(k) + ssthl0(k) * ( ps0(k) - p0(k) ) ) )           !<a name='3428'></font>
       <font color=#447700>!       qtflx(k) =                 emf(k) * (  qtu_emf(k) - (  qt0(k) +  ssqt0(k) * ( ps0(k) - p0(k) ) ) )           !<a name='3429'></font>
       <font color=#447700>!       uflx(k)  =                 emf(k) * (   uu_emf(k) - (   u0(k) +   ssu0(k) * ( ps0(k) - p0(k) ) ) )           !<a name='3430'></font>
       <font color=#447700>!       vflx(k)  =                 emf(k) * (   vu_emf(k) - (   v0(k) +   ssv0(k) * ( ps0(k) - p0(k) ) ) )           !<a name='3431'></font>
       <font color=#447700>!       do m = 1, ncnst                                                                                              !<a name='3432'></font>
       <font color=#447700>!          trflx(k,m) = emf(k) * ( tru_emf(k,m) - ( tr0(k,m) + sstr0(k,m) * ( ps0(k) - p0(k) ) ) )                   !<a name='3433'></font>
       <font color=#447700>!       enddo                                                                                                        !<a name='3434'></font>
       <font color=#447700>!   endif                                                                                                            !<a name='3435'></font>
       <font color=#447700>!                                                                                                                    !<a name='3436'></font>
       <font color=#447700>!   if( use_uppenent ) then ! Combined Updraft + Penetrative Entrainment Flux                                        !<a name='3437'></font>
       <font color=#447700>!       slflx(k) = cp * exns0(k) * umf(k) * ( thlu(k)     - ( thl0(kp1) + ssthl0(kp1) * ( ps0(k) - p0(kp1) ) ) ) + &amp; !<a name='3438'></font>
       <font color=#447700>!                  cp * exns0(k) * emf(k) * ( thlu_emf(k) - (   thl0(k) +   ssthl0(k) * ( ps0(k) - p0(k) ) ) )       !<a name='3439'></font>
       <font color=#447700>!       qtflx(k) =                 umf(k) * (  qtu(k)     - (  qt0(kp1) +  ssqt0(kp1) * ( ps0(k) - p0(kp1) ) ) ) + &amp; !<a name='3440'></font>
       <font color=#447700>!                                  emf(k) * (  qtu_emf(k) - (    qt0(k) +    ssqt0(k) * ( ps0(k) - p0(k) ) ) )       !                   <a name='3441'></font>
       <font color=#447700>!       uflx(k)  =                 umf(k) * (   uu(k)     - (   u0(kp1) +   ssu0(kp1) * ( ps0(k) - p0(kp1) ) ) ) + &amp; !<a name='3442'></font>
       <font color=#447700>!                                  emf(k) * (   uu_emf(k) - (     u0(k) +     ssu0(k) * ( ps0(k) - p0(k) ) ) )       !                      <a name='3443'></font>
       <font color=#447700>!       vflx(k)  =                 umf(k) * (   vu(k)     - (   v0(kp1) +   ssv0(kp1) * ( ps0(k) - p0(kp1) ) ) ) + &amp; !<a name='3444'></font>
       <font color=#447700>!                                  emf(k) * (   vu_emf(k) - (     v0(k) +     ssv0(k) * ( ps0(k) - p0(k) ) ) )       !                     <a name='3445'></font>
       <font color=#447700>!       do m = 1, ncnst                                                                                              !<a name='3446'></font>
       <font color=#447700>!          trflx(k,m) = umf(k) * ( tru(k,m) - ( tr0(kp1,m) + sstr0(kp1,m) * ( ps0(k) - p0(kp1) ) ) ) + &amp;             ! <a name='3447'></font>
       <font color=#447700>!                       emf(k) * ( tru_emf(k,m) - ( tr0(k,m) + sstr0(k,m) * ( ps0(k) - p0(k) ) ) )                   ! <a name='3448'></font>
       <font color=#447700>!       enddo                                                                                                        !<a name='3449'></font>
       <font color=#447700>! ------------------------------------------------------------------------------------------------------------------ !<a name='3450'></font>
<a name='3451'>
       do k = kbup, kpen - 1      <a name='3452'>
          kp1 = k + 1<a name='3453'>
          slflx(k) = cp * exns0(k) * emf(k) * ( thlu_emf(k) - ( thl0(k) + ssthl0(k) * ( ps0(k) - p0(k) ) ) )<a name='3454'>
          qtflx(k) =                 emf(k) * (  qtu_emf(k) - (  qt0(k) +  ssqt0(k) * ( ps0(k) - p0(k) ) ) ) <a name='3455'>
          uflx(k)  =                 emf(k) * (   uu_emf(k) - (   u0(k) +   ssu0(k) * ( ps0(k) - p0(k) ) ) ) <a name='3456'>
          vflx(k)  =                 emf(k) * (   vu_emf(k) - (   v0(k) +   ssv0(k) * ( ps0(k) - p0(k) ) ) )<a name='3457'>
          do m = 1, ncnst<a name='3458'>
             trflx(k,m) = emf(k) * ( tru_emf(k,m) - ( tr0(k,m) + sstr0(k,m) * ( ps0(k) - p0(k) ) ) ) <a name='3459'>
          enddo<a name='3460'>
       end do<a name='3461'>
<a name='3462'>
       <font color=#447700>! ------------------------------------------- !<a name='3463'></font>
       <font color=#447700>! Turn-off cumulus momentum flux as an option !<a name='3464'></font>
       <font color=#447700>! ------------------------------------------- !<a name='3465'></font>
<a name='3466'>
       if( .not. use_momenflx ) then<a name='3467'>
           uflx(0:mkx) = 0._r8<a name='3468'>
           vflx(0:mkx) = 0._r8<a name='3469'>
       endif       <a name='3470'>
<a name='3471'>
       <font color=#447700>! -------------------------------------------------------- !<a name='3472'></font>
       <font color=#447700>! Condensate tendency by compensating subsidence/upwelling !<a name='3473'></font>
       <font color=#447700>! -------------------------------------------------------- !<a name='3474'></font>
       <a name='3475'>
       uemf(0:mkx)         = 0._r8<a name='3476'>
       do k = 0, kinv - 2  <font color=#447700>! Assume linear updraft mass flux within the PBL.<a name='3477'></font>
          uemf(k) = cbmf * ( ps0(0) - ps0(k) ) / ( ps0(0) - ps0(kinv-1) ) <a name='3478'>
       end do<a name='3479'>
       uemf(kinv-1:krel-1) = cbmf<a name='3480'>
       uemf(krel:kbup-1)   = umf(krel:kbup-1)<a name='3481'>
       uemf(kbup:kpen-1)   = emf(kbup:kpen-1) <font color=#447700>! Only use penetrative entrainment flux consistently.<a name='3482'></font>
<a name='3483'>
       comsub(1:mkx) = 0._r8<a name='3484'>
       do k = 1, kpen<a name='3485'>
          comsub(k)  = 0.5_r8 * ( uemf(k) + uemf(k-1) ) <a name='3486'>
       end do    <a name='3487'>
<a name='3488'>
       do k = 1, kpen<a name='3489'>
          if( comsub(k) .ge. 0._r8 ) then<a name='3490'>
              if( k .eq. mkx ) then<a name='3491'>
                  thlten_sub = 0._r8<a name='3492'>
                  qtten_sub  = 0._r8<a name='3493'>
                  qlten_sub  = 0._r8<a name='3494'>
                  qiten_sub  = 0._r8<a name='3495'>
                  nlten_sub  = 0._r8<a name='3496'>
                  niten_sub  = 0._r8<a name='3497'>
              else<a name='3498'>
                  thlten_sub = g * comsub(k) * ( thl0(k+1) - thl0(k) ) / ( p0(k) - p0(k+1) )<a name='3499'>
                  qtten_sub  = g * comsub(k) * (  qt0(k+1) -  qt0(k) ) / ( p0(k) - p0(k+1) )<a name='3500'>
                  qlten_sub  = g * comsub(k) * (  ql0(k+1) -  ql0(k) ) / ( p0(k) - p0(k+1) )<a name='3501'>
                  qiten_sub  = g * comsub(k) * (  qi0(k+1) -  qi0(k) ) / ( p0(k) - p0(k+1) )<a name='3502'>
                  nlten_sub  = g * comsub(k) * (  tr0(k+1,ixnumliq) -  tr0(k,ixnumliq) ) / ( p0(k) - p0(k+1) )<a name='3503'>
                  niten_sub  = g * comsub(k) * (  tr0(k+1,ixnumice) -  tr0(k,ixnumice) ) / ( p0(k) - p0(k+1) )<a name='3504'>
              endif<a name='3505'>
          else<a name='3506'>
              if( k .eq. 1 ) then<a name='3507'>
                  thlten_sub = 0._r8<a name='3508'>
                  qtten_sub  = 0._r8<a name='3509'>
                  qlten_sub  = 0._r8<a name='3510'>
                  qiten_sub  = 0._r8<a name='3511'>
                  nlten_sub  = 0._r8<a name='3512'>
                  niten_sub  = 0._r8<a name='3513'>
              else<a name='3514'>
                  thlten_sub = g * comsub(k) * ( thl0(k) - thl0(k-1) ) / ( p0(k-1) - p0(k) )<a name='3515'>
                  qtten_sub  = g * comsub(k) * (  qt0(k) -  qt0(k-1) ) / ( p0(k-1) - p0(k) )<a name='3516'>
                  qlten_sub  = g * comsub(k) * (  ql0(k) -  ql0(k-1) ) / ( p0(k-1) - p0(k) )<a name='3517'>
                  qiten_sub  = g * comsub(k) * (  qi0(k) -  qi0(k-1) ) / ( p0(k-1) - p0(k) )<a name='3518'>
                  nlten_sub  = g * comsub(k) * (  tr0(k,ixnumliq) -  tr0(k-1,ixnumliq) ) / ( p0(k-1) - p0(k) )<a name='3519'>
                  niten_sub  = g * comsub(k) * (  tr0(k,ixnumice) -  tr0(k-1,ixnumice) ) / ( p0(k-1) - p0(k) )<a name='3520'>
              endif<a name='3521'>
          endif<a name='3522'>
          thl_prog = thl0(k) + thlten_sub * dt<a name='3523'>
          qt_prog  = max( qt0(k) + qtten_sub * dt, 1.e-12_r8 )<a name='3524'>
          call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_16">(p0(k),thl_prog,qt_prog,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='3525'>
          if( id_check .eq. 1 ) then<a name='3526'>
              id_exit = .true.<a name='3527'>
              go to 333<a name='3528'>
          endif<a name='3529'>
        <font color=#447700>! qlten_sink(k) = ( qlj - ql0(k) ) / dt<a name='3530'></font>
        <font color=#447700>! qiten_sink(k) = ( qij - qi0(k) ) / dt<a name='3531'></font>
          qlten_sink(k) = max( qlten_sub, - ql0(k) / dt ) <font color=#447700>! For consistency with prognostic macrophysics scheme<a name='3532'></font>
          qiten_sink(k) = max( qiten_sub, - qi0(k) / dt ) <font color=#447700>! For consistency with prognostic macrophysics scheme<a name='3533'></font>
          nlten_sink(k) = max( nlten_sub, - tr0(k,ixnumliq) / dt ) <a name='3534'>
          niten_sink(k) = max( niten_sub, - tr0(k,ixnumice) / dt )<a name='3535'>
       end do<a name='3536'>
<a name='3537'>
       <font color=#447700>! --------------------------------------------- !<a name='3538'></font>
       <font color=#447700>!                                               !<a name='3539'></font>
       <font color=#447700>! Calculate convective tendencies at each layer ! <a name='3540'></font>
       <font color=#447700>!                                               !<a name='3541'></font>
       <font color=#447700>! --------------------------------------------- !<a name='3542'></font>
       <a name='3543'>
       <font color=#447700>! ----------------- !<a name='3544'></font>
       <font color=#447700>! Momentum tendency !<a name='3545'></font>
       <font color=#447700>! ----------------- !<a name='3546'></font>
       <a name='3547'>
       do k = 1, kpen<a name='3548'>
          km1 = k - 1 <a name='3549'>
          uten(k) = ( uflx(km1) - uflx(k) ) * g / dp0(k)<a name='3550'>
          vten(k) = ( vflx(km1) - vflx(k) ) * g / dp0(k) <a name='3551'>
          uf(k)   = u0(k) + uten(k) * dt<a name='3552'>
          vf(k)   = v0(k) + vten(k) * dt<a name='3553'>
        <font color=#447700>! do m = 1, ncnst<a name='3554'></font>
        <font color=#447700>!    trten(k,m) = ( trflx(km1,m) - trflx(k,m) ) * g / dp0(k)<a name='3555'></font>
        <font color=#447700>!  ! Limit trten(k,m) such that negative value is not developed.<a name='3556'></font>
        <font color=#447700>!  ! This limitation does not conserve grid-mean tracers and future<a name='3557'></font>
        <font color=#447700>!  ! refinement is required for tracer-conserving treatment.<a name='3558'></font>
        <font color=#447700>!    trten(k,m) = max(trten(k,m),-tr0(k,m)/dt)              <a name='3559'></font>
        <font color=#447700>! enddo<a name='3560'></font>
       end do        <a name='3561'>
<a name='3562'>
       <font color=#447700>! ----------------------------------------------------------------- !<a name='3563'></font>
       <font color=#447700>! Tendencies of thermodynamic variables.                            ! <a name='3564'></font>
       <font color=#447700>! This part requires a careful treatment of bulk cloud microphysics.!<a name='3565'></font>
       <font color=#447700>! Relocations of 'precipitable condensates' either into the surface ! <a name='3566'></font>
       <font color=#447700>! or into the tendency of 'krel' layer will be performed just after !<a name='3567'></font>
       <font color=#447700>! finishing the below 'do-loop'.                                    !        <a name='3568'></font>
       <font color=#447700>! ----------------------------------------------------------------- !<a name='3569'></font>
       <a name='3570'>
       rliq    = 0._r8<a name='3571'>
       rainflx = 0._r8<a name='3572'>
       snowflx = 0._r8<a name='3573'>
<a name='3574'>
       do k = 1, kpen<a name='3575'>
<a name='3576'>
          km1 = k - 1<a name='3577'>
<a name='3578'>
          <font color=#447700>! ------------------------------------------------------------------------------ !<a name='3579'></font>
          <font color=#447700>! Compute 'slten', 'qtten', 'qvten', 'qlten', 'qiten', and 'sten'                !<a name='3580'></font>
          <font color=#447700>!                                                                                !<a name='3581'></font>
          <font color=#447700>! Key assumptions made in this 'cumulus scheme' are :                            !<a name='3582'></font>
          <font color=#447700>! 1. Cumulus updraft expels condensate into the environment at the top interface !<a name='3583'></font>
          <font color=#447700>!    of each layer. Note that in addition to this expel process ('source' term), !<a name='3584'></font>
          <font color=#447700>!    cumulus updraft can modify layer mean condensate through normal detrainment !<a name='3585'></font>
          <font color=#447700>!    forcing or compensating subsidence.                                         !<a name='3586'></font>
          <font color=#447700>! 2. Expelled water can be either 'sustaining' or 'precipitating' condensate. By !<a name='3587'></font>
          <font color=#447700>!    definition, 'suataining condensate' will remain in the layer where it was   !<a name='3588'></font>
          <font color=#447700>!    formed, while 'precipitating condensate' will fall across the base of the   !<a name='3589'></font>
          <font color=#447700>!    layer where it was formed.                                                  !<a name='3590'></font>
          <font color=#447700>! 3. All precipitating condensates are assumed to fall into the release layer or !<a name='3591'></font>
          <font color=#447700>!    ground as soon as it was formed without being evaporated during the falling !<a name='3592'></font>
          <font color=#447700>!    process down to the desinated layer ( either release layer of surface ).    !<a name='3593'></font>
          <font color=#447700>! ------------------------------------------------------------------------------ !<a name='3594'></font>
<a name='3595'>
          <font color=#447700>! ------------------------------------------------------------------------- !     <a name='3596'></font>
          <font color=#447700>! 'dwten(k)','diten(k)' : Production rate of condensate  within the layer k !<a name='3597'></font>
          <font color=#447700>!      [ kg/kg/s ]        by the expels of condensate from cumulus updraft. !<a name='3598'></font>
          <font color=#447700>! It is important to note that in terms of moisture tendency equation, this !<a name='3599'></font>
          <font color=#447700>! is a 'source' term of enviromental 'qt'.  More importantly,  these source !<a name='3600'></font>
          <font color=#447700>! are already counted in the turbulent heat and moisture fluxes we computed !<a name='3601'></font>
          <font color=#447700>! until now, assuming all the expelled condensate remain in the layer where ! <a name='3602'></font>
          <font color=#447700>! it was formed. Thus, in calculation of 'qtten' and 'slten' below, we MUST !<a name='3603'></font>
          <font color=#447700>! NOT add or subtract these terms explicitly in order not to double or miss !<a name='3604'></font>
          <font color=#447700>! count, unless some expelled condensates fall down out of the layer.  Note !<a name='3605'></font>
          <font color=#447700>! this falling-down process ( i.e., precipitation process ) and  associated !<a name='3606'></font>
          <font color=#447700>! 'qtten' and 'slten' and production of surface precipitation flux  will be !<a name='3607'></font>
          <font color=#447700>! treated later in 'zm_conv_evap' in 'convect_shallow_tend' subroutine.     ! <a name='3608'></font>
          <font color=#447700>! In below, we are converting expelled cloud condensate into correct unit.  !<a name='3609'></font>
          <font color=#447700>! I found that below use of '0.5 * (umf(k-1) + umf(k))' causes conservation !<a name='3610'></font>
          <font color=#447700>! errors at some columns in global simulation. So, I returned to originals. !<a name='3611'></font>
          <font color=#447700>! This will cause no precipitation flux at 'kpen' layer since umf(kpen)=0.  !<a name='3612'></font>
          <font color=#447700>! ------------------------------------------------------------------------- !<a name='3613'></font>
<a name='3614'>
          dwten(k) = dwten(k) * 0.5_r8 * ( umf(k-1) + umf(k) ) * g / dp0(k) <font color=#447700>! [ kg/kg/s ]<a name='3615'></font>
          diten(k) = diten(k) * 0.5_r8 * ( umf(k-1) + umf(k) ) * g / dp0(k) <font color=#447700>! [ kg/kg/s ]  <a name='3616'></font>
<a name='3617'>
          <font color=#447700>! dwten(k) = dwten(k) * umf(k) * g / dp0(k) ! [ kg/kg/s ]<a name='3618'></font>
          <font color=#447700>! diten(k) = diten(k) * umf(k) * g / dp0(k) ! [ kg/kg/s ]<a name='3619'></font>
<a name='3620'>
          <font color=#447700>! --------------------------------------------------------------------------- !<a name='3621'></font>
          <font color=#447700>! 'qrten(k)','qsten(k)' : Production rate of rain and snow within the layer k !<a name='3622'></font>
          <font color=#447700>!     [ kg/kg/s ]         by cumulus expels of condensates to the environment.!         <a name='3623'></font>
          <font color=#447700>! This will be falled-out of the layer where it was formed and will be dumped !<a name='3624'></font>
          <font color=#447700>! dumped into the release layer assuming that there is no evaporative cooling !<a name='3625'></font>
          <font color=#447700>! while precipitable condensate moves to the relaes level. This is reasonable ! <a name='3626'></font>
          <font color=#447700>! assumtion if cumulus is purely vertical and so the path along which precita !<a name='3627'></font>
          <font color=#447700>! ble condensate falls is fully saturared. This 're-allocation' process of    !<a name='3628'></font>
          <font color=#447700>! precipitable condensate into the release layer is fully described in this   !<a name='3629'></font>
          <font color=#447700>! convection scheme. After that, the dumped water into the release layer will !<a name='3630'></font>
          <font color=#447700>! falling down across the base of release layer ( or LCL, if  exact treatment ! <a name='3631'></font>
          <font color=#447700>! is required ) and will be allowed to be evaporated in layers below  release !<a name='3632'></font>
          <font color=#447700>! layer, and finally non-zero surface precipitation flux will be calculated.  !<a name='3633'></font>
          <font color=#447700>! This latter process will be separately treated 'zm_conv_evap' routine.      !<a name='3634'></font>
          <font color=#447700>! --------------------------------------------------------------------------- !<a name='3635'></font>
<a name='3636'>
          qrten(k) = frc_rasn * dwten(k)<a name='3637'>
          qsten(k) = frc_rasn * diten(k) <a name='3638'>
 <a name='3639'>
          <font color=#447700>! ----------------------------------------------------------------------- !         <a name='3640'></font>
          <font color=#447700>! 'rainflx','snowflx' : Cumulative rain and snow flux integrated from the ! <a name='3641'></font>
          <font color=#447700>!     [ kg/m2/s ]       release leyer to the 'kpen' layer. Note that even !<a name='3642'></font>
          <font color=#447700>! though wtw(kpen) &lt; 0 (and umf(kpen) = 0) at the top interface of 'kpen' !<a name='3643'></font>
          <font color=#447700>! layer, 'dwten(kpen)' and diten(kpen)  were calculated after calculating !<a name='3644'></font>
          <font color=#447700>! explicit cloud top height. Thus below calculation of precipitation flux !<a name='3645'></font>
          <font color=#447700>! is correct. Note that  precipitating condensates are formed only in the !<a name='3646'></font>
          <font color=#447700>! layers from 'krel' to 'kpen', including the two layers.                 !<a name='3647'></font>
          <font color=#447700>! ----------------------------------------------------------------------- !<a name='3648'></font>
<a name='3649'>
          rainflx = rainflx + qrten(k) * dp0(k) / g<a name='3650'>
          snowflx = snowflx + qsten(k) * dp0(k) / g<a name='3651'>
<a name='3652'>
          <font color=#447700>! ------------------------------------------------------------------------ !<a name='3653'></font>
          <font color=#447700>! 'slten(k)','qtten(k)'                                                    !<a name='3654'></font>
          <font color=#447700>!  Note that 'slflx(k)' and 'qtflx(k)' we have calculated already included !<a name='3655'></font>
          <font color=#447700>!  all the contributions of (1) expels of condensate (dwten(k), diten(k)), !<a name='3656'></font>
          <font color=#447700>!  (2) mass detrainment ( delta * umf * ( qtu - qt ) ), &amp; (3) compensating !<a name='3657'></font>
          <font color=#447700>!  subsidence ( M * dqt / dz ). Thus 'slflx(k)' and 'qtflx(k)' we computed ! <a name='3658'></font>
          <font color=#447700>!  is a hybrid turbulent flux containing one part of 'source' term - expel !<a name='3659'></font>
          <font color=#447700>!  of condensate. In order to calculate 'slten' and 'qtten', we should add !<a name='3660'></font>
          <font color=#447700>!  additional 'source' term, if any. If the expelled condensate falls down !<a name='3661'></font>
          <font color=#447700>!  across the base of the layer, it will be another sink (negative source) !<a name='3662'></font>
          <font color=#447700>!  term.  Note also that we included frictional heating terms in the below !<a name='3663'></font>
          <font color=#447700>!  calculation of 'slten'.                                                 !<a name='3664'></font>
          <font color=#447700>! ------------------------------------------------------------------------ !<a name='3665'></font>
                   <a name='3666'>
          slten(k) = ( slflx(km1) - slflx(k) ) * g / dp0(k)<a name='3667'>
          if( k .eq. 1 ) then<a name='3668'>
              slten(k) = slten(k) - g / 4._r8 / dp0(k) * (                            &amp;<a name='3669'>
                                    uflx(k)*(uf(k+1) - uf(k) + u0(k+1) - u0(k)) +     &amp; <a name='3670'>
                                    vflx(k)*(vf(k+1) - vf(k) + v0(k+1) - v0(k)))<a name='3671'>
          elseif( k .ge. 2 .and. k .le. kpen-1 ) then<a name='3672'>
              slten(k) = slten(k) - g / 4._r8 / dp0(k) * (                            &amp;<a name='3673'>
                                    uflx(k)*(uf(k+1) - uf(k) + u0(k+1) - u0(k)) +     &amp;<a name='3674'>
                                    uflx(k-1)*(uf(k) - uf(k-1) + u0(k) - u0(k-1)) +   &amp;<a name='3675'>
                                    vflx(k)*(vf(k+1) - vf(k) + v0(k+1) - v0(k)) +     &amp;<a name='3676'>
                                    vflx(k-1)*(vf(k) - vf(k-1) + v0(k) - v0(k-1)))<a name='3677'>
          elseif( k .eq. kpen ) then<a name='3678'>
              slten(k) = slten(k) - g / 4._r8 / dp0(k) * (                            &amp;<a name='3679'>
                                    uflx(k-1)*(uf(k) - uf(k-1) + u0(k) - u0(k-1)) +   &amp;<a name='3680'>
                                    vflx(k-1)*(vf(k) - vf(k-1) + v0(k) - v0(k-1)))<a name='3681'>
          endif<a name='3682'>
          qtten(k) = ( qtflx(km1) - qtflx(k) ) * g / dp0(k)<a name='3683'>
<a name='3684'>
          <font color=#447700>! ---------------------------------------------------------------------------- !<a name='3685'></font>
          <font color=#447700>! Compute condensate tendency, including reserved condensate                   !<a name='3686'></font>
          <font color=#447700>! We assume that eventual detachment and detrainment occurs in kbup layer  due !<a name='3687'></font>
          <font color=#447700>! to downdraft buoyancy sorting. In the layer above the kbup, only penetrative !<a name='3688'></font>
          <font color=#447700>! entrainment exists. Penetrative entrained air is assumed not to contain any  !<a name='3689'></font>
          <font color=#447700>! condensate.                                                                  !<a name='3690'></font>
          <font color=#447700>! ---------------------------------------------------------------------------- !<a name='3691'></font>
  <a name='3692'>
          <font color=#447700>! Compute in-cumulus condensate at the layer mid-point.<a name='3693'></font>
<a name='3694'>
          if( k .lt. krel .or. k .gt. kpen ) then<a name='3695'>
              qlu_mid = 0._r8<a name='3696'>
              qiu_mid = 0._r8<a name='3697'>
              qlj     = 0._r8<a name='3698'>
              qij     = 0._r8<a name='3699'>
          elseif( k .eq. krel ) then <a name='3700'>
              call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_17">(prel,thlu(krel-1),qtu(krel-1),thj,qvj,qlj,qij,qse,id_check,qsat)<a name='3701'>
              if( id_check .eq. 1 ) then<a name='3702'>
                  exit_conden(i) = 1._r8<a name='3703'>
                  id_exit = .true.<a name='3704'>
                  go to 333<a name='3705'>
              endif<a name='3706'>
              qlubelow = qlj       <a name='3707'>
              qiubelow = qij       <a name='3708'>
              call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_18">(ps0(k),thlu(k),qtu(k),thj,qvj,qlj,qij,qse,id_check,qsat)<a name='3709'>
              if( id_check .eq. 1 ) then<a name='3710'>
                  exit_conden(i) = 1._r8<a name='3711'>
                  id_exit = .true.<a name='3712'>
                  go to 333<a name='3713'>
              end if<a name='3714'>
              qlu_mid = 0.5_r8 * ( qlubelow + qlj ) * ( prel - ps0(k) )/( ps0(k-1) - ps0(k) )<a name='3715'>
              qiu_mid = 0.5_r8 * ( qiubelow + qij ) * ( prel - ps0(k) )/( ps0(k-1) - ps0(k) )<a name='3716'>
          elseif( k .eq. kpen ) then <a name='3717'>
              call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_19">(ps0(k-1)+ppen,thlu_top,qtu_top,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='3718'>
              if( id_check .eq. 1 ) then<a name='3719'>
                  exit_conden(i) = 1._r8<a name='3720'>
                  id_exit = .true.<a name='3721'>
                  go to 333<a name='3722'>
              end if<a name='3723'>
              qlu_mid = 0.5_r8 * ( qlubelow + qlj ) * ( -ppen )        /( ps0(k-1) - ps0(k) )<a name='3724'>
              qiu_mid = 0.5_r8 * ( qiubelow + qij ) * ( -ppen )        /( ps0(k-1) - ps0(k) )<a name='3725'>
              qlu_top = qlj<a name='3726'>
              qiu_top = qij<a name='3727'>
          else<a name='3728'>
              call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_20">(ps0(k),thlu(k),qtu(k),thj,qvj,qlj,qij,qse,id_check,qsat)<a name='3729'>
              if( id_check .eq. 1 ) then<a name='3730'>
                  exit_conden(i) = 1._r8<a name='3731'>
                  id_exit = .true.<a name='3732'>
                  go to 333<a name='3733'>
              end if<a name='3734'>
              qlu_mid = 0.5_r8 * ( qlubelow + qlj )<a name='3735'>
              qiu_mid = 0.5_r8 * ( qiubelow + qij )<a name='3736'>
          endif<a name='3737'>
          qlubelow = qlj       <a name='3738'>
          qiubelow = qij       <a name='3739'>
<a name='3740'>
          <font color=#447700>! 1. Sustained Precipitation<a name='3741'></font>
<a name='3742'>
          qc_l(k) = ( 1._r8 - frc_rasn ) * dwten(k) <font color=#447700>! [ kg/kg/s ]<a name='3743'></font>
          qc_i(k) = ( 1._r8 - frc_rasn ) * diten(k) <font color=#447700>! [ kg/kg/s ]<a name='3744'></font>
<a name='3745'>
          <font color=#447700>! 2. Detrained Condensate<a name='3746'></font>
<a name='3747'>
          if( k .le. kbup ) then <a name='3748'>
              qc_l(k) = qc_l(k) + g * 0.5_r8 * ( umf(k-1) + umf(k) ) * fdr(k) * qlu_mid <font color=#447700>! [ kg/kg/s ]<a name='3749'></font>
              qc_i(k) = qc_i(k) + g * 0.5_r8 * ( umf(k-1) + umf(k) ) * fdr(k) * qiu_mid <font color=#447700>! [ kg/kg/s ]<a name='3750'></font>
              qc_lm   =         - g * 0.5_r8 * ( umf(k-1) + umf(k) ) * fdr(k) * ql0(k)  <a name='3751'>
              qc_im   =         - g * 0.5_r8 * ( umf(k-1) + umf(k) ) * fdr(k) * qi0(k)<a name='3752'>
            <font color=#447700>! Below 'nc_lm', 'nc_im' should be used only when frc_rasn = 1.<a name='3753'></font>
              nc_lm   =         - g * 0.5_r8 * ( umf(k-1) + umf(k) ) * fdr(k) * tr0(k,ixnumliq)  <a name='3754'>
              nc_im   =         - g * 0.5_r8 * ( umf(k-1) + umf(k) ) * fdr(k) * tr0(k,ixnumice)<a name='3755'>
          else<a name='3756'>
              qc_lm   = 0._r8<a name='3757'>
              qc_im   = 0._r8<a name='3758'>
              nc_lm   = 0._r8<a name='3759'>
              nc_im   = 0._r8<a name='3760'>
          endif<a name='3761'>
<a name='3762'>
          <font color=#447700>! 3. Detached Updraft <a name='3763'></font>
<a name='3764'>
          if( k .eq. kbup ) then<a name='3765'>
              qc_l(k) = qc_l(k) + g * umf(k) * qlj     / ( ps0(k-1) - ps0(k) ) <font color=#447700>! [ kg/kg/s ]<a name='3766'></font>
              qc_i(k) = qc_i(k) + g * umf(k) * qij     / ( ps0(k-1) - ps0(k) ) <font color=#447700>! [ kg/kg/s ]<a name='3767'></font>
              qc_lm   = qc_lm   - g * umf(k) * ql0(k)  / ( ps0(k-1) - ps0(k) ) <font color=#447700>! [ kg/kg/s ]<a name='3768'></font>
              qc_im   = qc_im   - g * umf(k) * qi0(k)  / ( ps0(k-1) - ps0(k) ) <font color=#447700>! [ kg/kg/s ]<a name='3769'></font>
              nc_lm   = nc_lm   - g * umf(k) * tr0(k,ixnumliq)  / ( ps0(k-1) - ps0(k) ) <font color=#447700>! [ kg/kg/s ]<a name='3770'></font>
              nc_im   = nc_im   - g * umf(k) * tr0(k,ixnumice)  / ( ps0(k-1) - ps0(k) ) <font color=#447700>! [ kg/kg/s ]<a name='3771'></font>
          endif <a name='3772'>
<a name='3773'>
          <font color=#447700>! 4. Cumulative Penetrative entrainment detrained in the 'kbup' layer<a name='3774'></font>
          <font color=#447700>!    Explicitly compute the properties detrained penetrative entrained airs in k = kbup layer.<a name='3775'></font>
<a name='3776'>
          if( k .eq. kbup ) then<a name='3777'>
              call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_21">(p0(k),thlu_emf(k),qtu_emf(k),thj,qvj,ql_emf_kbup,qi_emf_kbup,qse,id_check,qsat)<a name='3778'>
              if( id_check .eq. 1 ) then<a name='3779'>
                  id_exit = .true.<a name='3780'>
                  go to 333<a name='3781'>
              endif<a name='3782'>
              if( ql_emf_kbup .gt. 0._r8 ) then<a name='3783'>
                  nl_emf_kbup = tru_emf(k,ixnumliq)<a name='3784'>
              else<a name='3785'>
                  nl_emf_kbup = 0._r8<a name='3786'>
              endif<a name='3787'>
              if( qi_emf_kbup .gt. 0._r8 ) then<a name='3788'>
                  ni_emf_kbup = tru_emf(k,ixnumice)<a name='3789'>
              else<a name='3790'>
                  ni_emf_kbup = 0._r8<a name='3791'>
              endif<a name='3792'>
              qc_lm   = qc_lm   - g * emf(k) * ( ql_emf_kbup - ql0(k) ) / ( ps0(k-1) - ps0(k) ) <font color=#447700>! [ kg/kg/s ]<a name='3793'></font>
              qc_im   = qc_im   - g * emf(k) * ( qi_emf_kbup - qi0(k) ) / ( ps0(k-1) - ps0(k) ) <font color=#447700>! [ kg/kg/s ]<a name='3794'></font>
              nc_lm   = nc_lm   - g * emf(k) * ( nl_emf_kbup - tr0(k,ixnumliq) ) / ( ps0(k-1) - ps0(k) ) <font color=#447700>! [ kg/kg/s ]<a name='3795'></font>
              nc_im   = nc_im   - g * emf(k) * ( ni_emf_kbup - tr0(k,ixnumice) ) / ( ps0(k-1) - ps0(k) ) <font color=#447700>! [ kg/kg/s ]<a name='3796'></font>
          endif <a name='3797'>
<a name='3798'>
          qlten_det   = qc_l(k) + qc_lm<a name='3799'>
          qiten_det   = qc_i(k) + qc_im<a name='3800'>
<a name='3801'>
          <font color=#447700>! --------------------------------------------------------------------------------- !<a name='3802'></font>
          <font color=#447700>! 'qlten(k)','qiten(k)','qvten(k)','sten(k)'                                        !<a name='3803'></font>
          <font color=#447700>! Note that falling of precipitation will be treated later.                         !<a name='3804'></font>
          <font color=#447700>! The prevension of negative 'qv,ql,qi' will be treated later in positive_moisture. !<a name='3805'></font>
          <font color=#447700>! --------------------------------------------------------------------------------- ! <a name='3806'></font>
<a name='3807'>
          if( use_expconten ) then<a name='3808'>
              if( use_unicondet ) then<a name='3809'>
                  qc_l(k) = 0._r8<a name='3810'>
                  qc_i(k) = 0._r8 <a name='3811'>
                  qlten(k) = frc_rasn * dwten(k) + qlten_sink(k) + qlten_det<a name='3812'>
                  qiten(k) = frc_rasn * diten(k) + qiten_sink(k) + qiten_det<a name='3813'>
              else <a name='3814'>
                  qlten(k) = qc_l(k) + frc_rasn * dwten(k) + ( max( 0._r8, ql0(k) + ( qc_lm + qlten_sink(k) ) * dt ) - ql0(k) ) / dt<a name='3815'>
                  qiten(k) = qc_i(k) + frc_rasn * diten(k) + ( max( 0._r8, qi0(k) + ( qc_im + qiten_sink(k) ) * dt ) - qi0(k) ) / dt<a name='3816'>
                  trten(k,ixnumliq) = max( nc_lm + nlten_sink(k), - tr0(k,ixnumliq) / dt )<a name='3817'>
                  trten(k,ixnumice) = max( nc_im + niten_sink(k), - tr0(k,ixnumice) / dt )<a name='3818'>
              endif<a name='3819'>
          else<a name='3820'>
              if( use_unicondet ) then<a name='3821'>
                  qc_l(k) = 0._r8<a name='3822'>
                  qc_i(k) = 0._r8 <a name='3823'>
              endif                      <a name='3824'>
              qlten(k) = dwten(k) + ( qtten(k) - dwten(k) - diten(k) ) * ( ql0(k) / qt0(k) )<a name='3825'>
              qiten(k) = diten(k) + ( qtten(k) - dwten(k) - diten(k) ) * ( qi0(k) / qt0(k) )<a name='3826'>
          endif<a name='3827'>
<a name='3828'>
          qvten(k) = qtten(k) - qlten(k) - qiten(k)<a name='3829'>
          sten(k)  = slten(k) + xlv * qlten(k) + xls * qiten(k)<a name='3830'>
<a name='3831'>
          <font color=#447700>! -------------------------------------------------------------------------- !<a name='3832'></font>
          <font color=#447700>! 'rliq' : Verticall-integrated 'suspended cloud condensate'                 !<a name='3833'></font>
          <font color=#447700>!  [m/s]   This is so called 'reserved liquid water'  in other subroutines   ! <a name='3834'></font>
          <font color=#447700>! of CAM3, since the contribution of this term should not be included into   !<a name='3835'></font>
          <font color=#447700>! the tendency of each layer or surface flux (precip)  within this cumulus   !<a name='3836'></font>
          <font color=#447700>! scheme. The adding of this term to the layer tendency will be done inthe   !<a name='3837'></font>
          <font color=#447700>! 'stratiform_tend', just after performing sediment process there.           !<a name='3838'></font>
          <font color=#447700>! The main problem of these rather going-back-and-forth and stupid-seeming   ! <a name='3839'></font>
          <font color=#447700>! approach is that the sediment process of suspendened condensate will not   !<a name='3840'></font>
          <font color=#447700>! be treated at all in the 'stratiform_tend'.                                !<a name='3841'></font>
          <font color=#447700>! Note that 'precip' [m/s] is vertically-integrated total 'rain+snow' formed !<a name='3842'></font>
          <font color=#447700>! from the cumulus updraft. Important : in the below, 1000 is rhoh2o ( water !<a name='3843'></font>
          <font color=#447700>! density ) [ kg/m^3 ] used for unit conversion from [ kg/m^2/s ] to [ m/s ] !<a name='3844'></font>
          <font color=#447700>! for use in stratiform.F90.                                                 !<a name='3845'></font>
          <font color=#447700>! -------------------------------------------------------------------------- ! <a name='3846'></font>
<a name='3847'>
          qc(k)  =  qc_l(k) +  qc_i(k)   <a name='3848'>
          rliq   =  rliq    + qc(k) * dp0(k) / g / 1000._r8    <font color=#447700>! [ m/s ]<a name='3849'></font>
<a name='3850'>
       end do<a name='3851'>
<a name='3852'>
          precip  =  rainflx + snowflx                       <font color=#447700>! [ kg/m2/s ]<a name='3853'></font>
          snow    =  snowflx                                 <font color=#447700>! [ kg/m2/s ] <a name='3854'></font>
<a name='3855'>
       <font color=#447700>! ---------------------------------------------------------------- !<a name='3856'></font>
       <font color=#447700>! Now treats the 'evaporation' and 'melting' of rain ( qrten ) and ! <a name='3857'></font>
       <font color=#447700>! snow ( qsten ) during falling process. Below algorithms are from !<a name='3858'></font>
       <font color=#447700>! 'zm_conv_evap' but with some modification, which allows separate !<a name='3859'></font>
       <font color=#447700>! treatment of 'rain' and 'snow' condensates. Note that I included !<a name='3860'></font>
       <font color=#447700>! the evaporation dynamics into the convection scheme for complete !<a name='3861'></font>
       <font color=#447700>! development of cumulus scheme especially in association with the ! <a name='3862'></font>
       <font color=#447700>! implicit CIN closure. In compatible with this internal treatment !<a name='3863'></font>
       <font color=#447700>! of evaporation, I should modify 'convect_shallow',  in such that !<a name='3864'></font>
       <font color=#447700>! 'zm_conv_evap' is not performed when I choose UW PBL-Cu schemes. !                                          <a name='3865'></font>
       <font color=#447700>! ---------------------------------------------------------------- !<a name='3866'></font>
<a name='3867'>
       evpint_rain    = 0._r8 <a name='3868'>
       evpint_snow    = 0._r8<a name='3869'>
       flxrain(0:mkx) = 0._r8<a name='3870'>
       flxsnow(0:mkx) = 0._r8<a name='3871'>
       ntraprd(:mkx)  = 0._r8<a name='3872'>
       ntsnprd(:mkx)  = 0._r8<a name='3873'>
<a name='3874'>
       do k = mkx, 1, -1  <font color=#447700>! 'k' is a layer index : 'mkx'('1') is the top ('bottom') layer<a name='3875'></font>
          <a name='3876'>
          <font color=#447700>! ----------------------------------------------------------------------------- !<a name='3877'></font>
          <font color=#447700>! flxsntm [kg/m2/s] : Downward snow flux at the top of each layer after melting.! <a name='3878'></font>
          <font color=#447700>! snowmlt [kg/kg/s] : Snow melting tendency.                                    !<a name='3879'></font>
          <font color=#447700>! Below allows melting of snow when it goes down into the warm layer below.     !<a name='3880'></font>
          <font color=#447700>! ----------------------------------------------------------------------------- !<a name='3881'></font>
<a name='3882'>
          if( t0(k) .gt. 273.16_r8 ) then<a name='3883'>
              snowmlt = max( 0._r8, flxsnow(k) * g / dp0(k) ) <a name='3884'>
          else<a name='3885'>
              snowmlt = 0._r8<a name='3886'>
          endif<a name='3887'>
<a name='3888'>
          <font color=#447700>! ----------------------------------------------------------------- !<a name='3889'></font>
          <font color=#447700>! Evaporation rate of 'rain' and 'snow' in the layer k, [ kg/kg/s ] !<a name='3890'></font>
          <font color=#447700>! where 'rain' and 'snow' are coming down from the upper layers.    !<a name='3891'></font>
          <font color=#447700>! I used the same evaporative efficiency both for 'rain' and 'snow'.!<a name='3892'></font>
          <font color=#447700>! Note that evaporation is not allowed in the layers 'k &gt;= krel' by !<a name='3893'></font>
          <font color=#447700>! assuming that inside of cumulus cloud, across which precipitation !<a name='3894'></font>
          <font color=#447700>! is falling down, is fully saturated.                              !<a name='3895'></font>
          <font color=#447700>! The asumptions in association with the 'evplimit_rain(snow)' are  !<a name='3896'></font>
          <font color=#447700>!   1. Do not allow evaporation to supersate the layer              !<a name='3897'></font>
          <font color=#447700>!   2. Do not evaporate more than the flux falling into the layer   !<a name='3898'></font>
          <font color=#447700>!   3. Total evaporation cannot exceed the input total surface flux !<a name='3899'></font>
          <font color=#447700>! ----------------------------------------------------------------- !<a name='3900'></font>
<a name='3901'>
          status = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#QSAT'>qsat</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_25">(t0(k),p0(k),es(1),qs(1),gam(1), 1)          <a name='3902'>
          subsat = max( ( 1._r8 - qv0(k)/qs(1) ), 0._r8 )<a name='3903'>
          if( noevap_krelkpen ) then<a name='3904'>
              if( k .ge. krel ) subsat = 0._r8<a name='3905'>
          endif<a name='3906'>
<a name='3907'>
          evprain  = kevp * subsat * sqrt(flxrain(k)+snowmlt*dp0(k)/g) <a name='3908'>
          evpsnow  = kevp * subsat * sqrt(max(flxsnow(k)-snowmlt*dp0(k)/g,0._r8))<a name='3909'>
<a name='3910'>
          evplimit = max( 0._r8, ( qw0_in(i,k) - qv0(k) ) / dt ) <a name='3911'>
<a name='3912'>
          evplimit_rain = min( evplimit,      ( flxrain(k) + snowmlt * dp0(k) / g ) * g / dp0(k) )<a name='3913'>
          evplimit_rain = min( evplimit_rain, ( rainflx - evpint_rain ) * g / dp0(k) )<a name='3914'>
          evprain = max(0._r8,min( evplimit_rain, evprain ))<a name='3915'>
<a name='3916'>
          evplimit_snow = min( evplimit,   max( flxsnow(k) - snowmlt * dp0(k) / g , 0._r8 ) * g / dp0(k) )<a name='3917'>
          evplimit_snow = min( evplimit_snow, ( snowflx - evpint_snow ) * g / dp0(k) )<a name='3918'>
          evpsnow = max(0._r8,min( evplimit_snow, evpsnow ))<a name='3919'>
<a name='3920'>
          if( ( evprain + evpsnow ) .gt. evplimit ) then<a name='3921'>
                tmp1 = evprain * evplimit / ( evprain + evpsnow )<a name='3922'>
                tmp2 = evpsnow * evplimit / ( evprain + evpsnow )<a name='3923'>
                evprain = tmp1<a name='3924'>
                evpsnow = tmp2<a name='3925'>
          endif<a name='3926'>
<a name='3927'>
          evapc(k) = evprain + evpsnow<a name='3928'>
<a name='3929'>
          <font color=#447700>! ------------------------------------------------------------- !<a name='3930'></font>
          <font color=#447700>! Vertically-integrated evaporative fluxes of 'rain' and 'snow' !<a name='3931'></font>
          <font color=#447700>! ------------------------------------------------------------- !<a name='3932'></font>
<a name='3933'>
          evpint_rain = evpint_rain + evprain * dp0(k) / g<a name='3934'>
          evpint_snow = evpint_snow + evpsnow * dp0(k) / g<a name='3935'>
<a name='3936'>
          <font color=#447700>! -------------------------------------------------------------- !<a name='3937'></font>
          <font color=#447700>! Net 'rain' and 'snow' production rate in the layer [ kg/kg/s ] !<a name='3938'></font>
          <font color=#447700>! -------------------------------------------------------------- !         <a name='3939'></font>
<a name='3940'>
          ntraprd(k) = qrten(k) - evprain + snowmlt<a name='3941'>
          ntsnprd(k) = qsten(k) - evpsnow - snowmlt<a name='3942'>
         <a name='3943'>
          <font color=#447700>! -------------------------------------------------------------------------------- !<a name='3944'></font>
          <font color=#447700>! Downward fluxes of 'rain' and 'snow' fluxes at the base of the layer [ kg/m2/s ] !<a name='3945'></font>
          <font color=#447700>! Note that layer index increases with height.                                     !<a name='3946'></font>
          <font color=#447700>! -------------------------------------------------------------------------------- !<a name='3947'></font>
<a name='3948'>
          flxrain(k-1) = flxrain(k) + ntraprd(k) * dp0(k) / g<a name='3949'>
          flxsnow(k-1) = flxsnow(k) + ntsnprd(k) * dp0(k) / g<a name='3950'>
          flxrain(k-1) = max( flxrain(k-1), 0._r8 )<a name='3951'>
          if( flxrain(k-1) .eq. 0._r8 ) ntraprd(k) = -flxrain(k) * g / dp0(k)<a name='3952'>
          flxsnow(k-1) = max( flxsnow(k-1), 0._r8 )         <a name='3953'>
          if( flxsnow(k-1) .eq. 0._r8 ) ntsnprd(k) = -flxsnow(k) * g / dp0(k)<a name='3954'>
<a name='3955'>
          <font color=#447700>! ---------------------------------- !<a name='3956'></font>
          <font color=#447700>! Calculate thermodynamic tendencies !<a name='3957'></font>
          <font color=#447700>! --------------------------------------------------------------------------- !<a name='3958'></font>
          <font color=#447700>! Note that equivalently, we can write tendency formula of 'sten' and 'slten' !<a name='3959'></font>
          <font color=#447700>! by 'sten(k)  = sten(k) - xlv*evprain  - xls*evpsnow - (xls-xlv)*snowmlt' &amp;  !<a name='3960'></font>
          <font color=#447700>!    'slten(k) = sten(k) - xlv*qlten(k) - xls*qiten(k)'.                      !<a name='3961'></font>
          <font color=#447700>! The above formula is equivalent to the below formula. However below formula !<a name='3962'></font>
          <font color=#447700>! is preferred since we have already imposed explicit constraint on 'ntraprd' !<a name='3963'></font>
          <font color=#447700>! and 'ntsnprd' in case that flxrain(k-1) &lt; 0 &amp; flxsnow(k-1) &lt; 0._r8          !<a name='3964'></font>
          <font color=#447700>! Note : In future, I can elborate the limiting of 'qlten','qvten','qiten'    !<a name='3965'></font>
          <font color=#447700>!        such that that energy and moisture conservation error is completely  !<a name='3966'></font>
          <font color=#447700>!        suppressed.                                                          !<a name='3967'></font>
          <font color=#447700>! Re-storation to the positive condensate will be performed later below       !<a name='3968'></font>
          <font color=#447700>! --------------------------------------------------------------------------- !<a name='3969'></font>
<a name='3970'>
          qlten(k) = qlten(k) - qrten(k)<a name='3971'>
          qiten(k) = qiten(k) - qsten(k)<a name='3972'>
          qvten(k) = qvten(k) + evprain  + evpsnow<a name='3973'>
          qtten(k) = qlten(k) + qiten(k) + qvten(k)<a name='3974'>
          if( ( qv0(k) + qvten(k)*dt ) .lt. qmin(1) .or. &amp;<a name='3975'>
              ( ql0(k) + qlten(k)*dt ) .lt. qmin(2) .or. &amp;<a name='3976'>
              ( qi0(k) + qiten(k)*dt ) .lt. qmin(3) ) then<a name='3977'>
               limit_negcon(i) = 1._r8<a name='3978'>
          end if<a name='3979'>
          sten(k)  = sten(k) - xlv*evprain  - xls*evpsnow - (xls-xlv)*snowmlt<a name='3980'>
          slten(k) = sten(k) - xlv*qlten(k) - xls*qiten(k)<a name='3981'>
<a name='3982'>
        <font color=#447700>!  slten(k) = slten(k) + xlv * ntraprd(k) + xls * ntsnprd(k)         <a name='3983'></font>
        <font color=#447700>!  sten(k)  = slten(k) + xlv * qlten(k)   + xls * qiten(k)<a name='3984'></font>
<a name='3985'>
       end do<a name='3986'>
<a name='3987'>
       <font color=#447700>! ------------------------------------------------------------- !<a name='3988'></font>
       <font color=#447700>! Calculate final surface flux of precipitation, rain, and snow !<a name='3989'></font>
       <font color=#447700>! Convert unit to [m/s] for use in 'check_energy_chng'.         !  <a name='3990'></font>
       <font color=#447700>! ------------------------------------------------------------- !<a name='3991'></font>
<a name='3992'>
       precip  = ( flxrain(0) + flxsnow(0) ) / 1000._r8<a name='3993'>
       snow    =   flxsnow(0) / 1000._r8       <a name='3994'>
<a name='3995'>
       <font color=#447700>! --------------------------------------------------------------------------- !<a name='3996'></font>
       <font color=#447700>! Until now, all the calculations are done completely in this shallow cumulus !<a name='3997'></font>
       <font color=#447700>! scheme. If you want to use this cumulus scheme other than CAM3, then do not !<a name='3998'></font>
       <font color=#447700>! perform below block. However, for compatible use with the other subroutines !<a name='3999'></font>
       <font color=#447700>! in CAM3, I should subtract the effect of 'qc(k)' ('rliq') from the tendency !<a name='4000'></font>
       <font color=#447700>! equation in each layer, since this effect will be separately added later in !<a name='4001'></font>
       <font color=#447700>! in 'stratiform_tend' just after performing sediment process there. In order !<a name='4002'></font>
       <font color=#447700>! to be consistent with 'stratiform_tend', just subtract qc(k)  from tendency !<a name='4003'></font>
       <font color=#447700>! equation of each layer, but do not add it to the 'precip'. Apprently,  this !<a name='4004'></font>
       <font color=#447700>! will violate energy and moisture conservations.    However, when performing !<a name='4005'></font>
       <font color=#447700>! conservation check in 'tphysbc.F90' just after 'convect_shallow_tend',   we !<a name='4006'></font>
       <font color=#447700>! will add 'qc(k)' ( rliq ) to the surface flux term just for the purpose  of !<a name='4007'></font>
       <font color=#447700>! passing the energy-moisture conservation check. Explicit adding-back of 'qc'!<a name='4008'></font>
       <font color=#447700>! to the individual layer tendency equation will be done in 'stratiform_tend' !<a name='4009'></font>
       <font color=#447700>! after performing sediment process there. Simply speaking, in 'tphysbc' just !<a name='4010'></font>
       <font color=#447700>! after 'convect_shallow_tend', we will dump 'rliq' into surface as a  'rain' !<a name='4011'></font>
       <font color=#447700>! in order to satisfy energy and moisture conservation, and  in the following !<a name='4012'></font>
       <font color=#447700>! 'stratiform_tend', we will restore it back to 'qlten(k)' ( 'ice' will go to !  <a name='4013'></font>
       <font color=#447700>! 'water' there) from surface precipitation. This is a funny but conceptually !<a name='4014'></font>
       <font color=#447700>! entertaining procedure. One concern I have for this complex process is that !<a name='4015'></font>
       <font color=#447700>! output-writed stratiform precipitation amount will be underestimated due to !<a name='4016'></font>
       <font color=#447700>! arbitrary subtracting of 'rliq' in stratiform_tend, where                   !<a name='4017'></font>
       <font color=#447700>! ' prec_str = prec_sed + prec_pcw - rliq' and 'rliq' is not real but fake.   ! <a name='4018'></font>
       <font color=#447700>! However, as shown in 'srfxfer.F90', large scale precipitation amount (PRECL)!<a name='4019'></font>
       <font color=#447700>! that is writed-output is corrected written since in 'srfxfer.F90',  PRECL = !<a name='4020'></font>
       <font color=#447700>! 'prec_sed + prec_pcw', without including 'rliq'. So current code is correct.!<a name='4021'></font>
       <font color=#447700>! Note also in 'srfxfer.F90', convective precipitation amount is 'PRECC =     ! <a name='4022'></font>
       <font color=#447700>! prec_zmc(i) + prec_cmf(i)' which is also correct.                           !<a name='4023'></font>
       <font color=#447700>! --------------------------------------------------------------------------- !<a name='4024'></font>
<a name='4025'>
       do k = 1, kpen       <a name='4026'>
          qtten(k) = qtten(k) - qc(k)<a name='4027'>
          qlten(k) = qlten(k) - qc_l(k)<a name='4028'>
          qiten(k) = qiten(k) - qc_i(k)<a name='4029'>
          slten(k) = slten(k) + ( xlv * qc_l(k) + xls * qc_i(k) )<a name='4030'>
          <font color=#447700>! ---------------------------------------------------------------------- !<a name='4031'></font>
          <font color=#447700>! Since all reserved condensates will be treated  as liquid water in the !<a name='4032'></font>
          <font color=#447700>! 'check_energy_chng' &amp; 'stratiform_tend' without an explicit conversion !<a name='4033'></font>
          <font color=#447700>! algorithm, I should consider explicitly the energy conversions between !<a name='4034'></font>
          <font color=#447700>! 'ice' and 'liquid' - i.e., I should convert 'ice' to 'liquid'  and the !<a name='4035'></font>
          <font color=#447700>! necessary energy for this conversion should be subtracted from 'sten'. ! <a name='4036'></font>
          <font color=#447700>! Without this conversion here, energy conservation error come out. Note !<a name='4037'></font>
          <font color=#447700>! that there should be no change of 'qvten(k)'.                          !<a name='4038'></font>
          <font color=#447700>! ---------------------------------------------------------------------- !<a name='4039'></font>
          sten(k)  = sten(k)  - ( xls - xlv ) * qc_i(k)<a name='4040'>
       end do<a name='4041'>
<a name='4042'>
       <font color=#447700>! --------------------------------------------------------------- !<a name='4043'></font>
       <font color=#447700>! Prevent the onset-of negative condensate at the next time step  !<a name='4044'></font>
       <font color=#447700>! Potentially, this block can be moved just in front of the above !<a name='4045'></font>
       <font color=#447700>! block.                                                          ! <a name='4046'></font>
       <font color=#447700>! --------------------------------------------------------------- !<a name='4047'></font>
<a name='4048'>
       <font color=#447700>! Modification : I should check whether this 'positive_moisture_single' routine is<a name='4049'></font>
       <font color=#447700>!                consistent with the one used in UW PBL and cloud macrophysics schemes.<a name='4050'></font>
       <font color=#447700>! Modification : Below may overestimate resulting 'ql, qi' if we use the new 'qc_l', 'qc_i'<a name='4051'></font>
       <font color=#447700>!                in combination with the original computation of qlten, qiten. However,<a name='4052'></font>
       <font color=#447700>!                if we use new 'qlten,qiten', there is no problem.<a name='4053'></font>
<a name='4054'>
        qv0_star(:mkx) = qv0(:mkx) + qvten(:mkx) * dt<a name='4055'>
        ql0_star(:mkx) = ql0(:mkx) + qlten(:mkx) * dt<a name='4056'>
        qi0_star(:mkx) = qi0(:mkx) + qiten(:mkx) * dt<a name='4057'>
        s0_star(:mkx)  =  s0(:mkx) +  sten(:mkx) * dt<a name='4058'>
        call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#POSITIVE_MOISTURE_SINGLE'>positive_moisture_single</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POSITIVE_MOISTURE_SINGLE_1">( xlv, xls, mkx, dt, qmin(1), qmin(2), qmin(3), dp0, &amp;<a name='4059'>
                                       qv0_star, ql0_star, qi0_star, s0_star, qvten, qlten, qiten, sten )<a name='4060'>
        qtten(:mkx)    = qvten(:mkx) + qlten(:mkx) + qiten(:mkx)<a name='4061'>
        slten(:mkx)    = sten(:mkx)  - xlv * qlten(:mkx) - xls * qiten(:mkx)<a name='4062'>
<a name='4063'>
       <font color=#447700>! --------------------- !<a name='4064'></font>
       <font color=#447700>! Tendencies of tracers !<a name='4065'></font>
       <font color=#447700>! --------------------- !<a name='4066'></font>
<a name='4067'>
       do m = 4, ncnst<a name='4068'>
<a name='4069'>
       if( m .ne. ixnumliq .and. m .ne. ixnumice ) then<a name='4070'>
<a name='4071'>
          trmin = qmin(m)<a name='4072'>
#ifdef MODAL_AERO<a name='4073'>
          do mm = 1, ntot_amode<a name='4074'>
             if( m .eq. numptr_amode(mm) ) then<a name='4075'>
                 trmin = 1.e-5_r8<a name='4076'>
                 goto 55<a name='4077'>
             endif              <a name='4078'>
          enddo<a name='4079'>
       55 continue<a name='4080'>
#endif <a name='4081'>
          trflx_d(0:mkx) = 0._r8<a name='4082'>
          trflx_u(0:mkx) = 0._r8           <a name='4083'>
          do k = 1, mkx-1<a name='4084'>
             if( cnst_get_type_byind(m) .eq. 'wet' ) then<a name='4085'>
                 pdelx = dp0(k)<a name='4086'>
             else<a name='4087'>
                 pdelx = dpdry0(k)<a name='4088'>
             endif<a name='4089'>
             km1 = k - 1<a name='4090'>
             dum = ( tr0(k,m) - trmin ) *  pdelx / g / dt + trflx(km1,m) - trflx(k,m) + trflx_d(km1)<a name='4091'>
             trflx_d(k) = min( 0._r8, dum )<a name='4092'>
          enddo<a name='4093'>
          do k = mkx, 2, -1<a name='4094'>
             if( cnst_get_type_byind(m) .eq. 'wet' ) then<a name='4095'>
                 pdelx = dp0(k)<a name='4096'>
             else<a name='4097'>
                 pdelx = dpdry0(k)<a name='4098'>
             endif<a name='4099'>
             km1 = k - 1<a name='4100'>
             dum = ( tr0(k,m) - trmin ) * pdelx / g / dt + trflx(km1,m) - trflx(k,m) + &amp;<a name='4101'>
                                                           trflx_d(km1) - trflx_d(k) - trflx_u(k) <a name='4102'>
             trflx_u(km1) = max( 0._r8, -dum ) <a name='4103'>
          enddo<a name='4104'>
          do k = 1, mkx<a name='4105'>
             if( cnst_get_type_byind(m) .eq. 'wet' ) then<a name='4106'>
                 pdelx = dp0(k)<a name='4107'>
             else<a name='4108'>
                 pdelx = dpdry0(k)<a name='4109'>
             endif<a name='4110'>
             km1 = k - 1<a name='4111'>
           <font color=#447700>! Check : I should re-check whether '_u', '_d' are correctly ordered in <a name='4112'></font>
           <font color=#447700>!         the below tendency computation.<a name='4113'></font>
             trten(k,m) = ( trflx(km1,m) - trflx(k,m) + &amp; <a name='4114'>
                            trflx_d(km1) - trflx_d(k) + &amp;<a name='4115'>
                            trflx_u(km1) - trflx_u(k) ) * g / pdelx<a name='4116'>
          enddo<a name='4117'>
<a name='4118'>
       endif<a name='4119'>
<a name='4120'>
       enddo<a name='4121'>
<a name='4122'>
       <font color=#447700>! ---------------------------------------------------------------- !<a name='4123'></font>
       <font color=#447700>! Cumpute default diagnostic outputs                               !<a name='4124'></font>
       <font color=#447700>! Note that since 'qtu(krel-1:kpen-1)' &amp; 'thlu(krel-1:kpen-1)' has !<a name='4125'></font>
       <font color=#447700>! been adjusted after detraining cloud condensate into environment ! <a name='4126'></font>
       <font color=#447700>! during cumulus updraft motion,  below calculations will  exactly !<a name='4127'></font>
       <font color=#447700>! reproduce in-cloud properties as shown in the output analysis.   !<a name='4128'></font>
       <font color=#447700>! ---------------------------------------------------------------- ! <a name='4129'></font>
 <a name='4130'>
       call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_22">(prel,thlu(krel-1),qtu(krel-1),thj,qvj,qlj,qij,qse,id_check,qsat)<a name='4131'>
       if( id_check .eq. 1 ) then<a name='4132'>
           exit_conden(i) = 1._r8<a name='4133'>
           id_exit = .true.<a name='4134'>
           go to 333<a name='4135'>
       end if<a name='4136'>
       qcubelow = qlj + qij<a name='4137'>
       qlubelow = qlj       <a name='4138'>
       qiubelow = qij       <a name='4139'>
       rcwp     = 0._r8<a name='4140'>
       rlwp     = 0._r8<a name='4141'>
       riwp     = 0._r8<a name='4142'>
<a name='4143'>
       <font color=#447700>! --------------------------------------------------------------------- !<a name='4144'></font>
       <font color=#447700>! In the below calculations, I explicitly considered cloud base ( LCL ) !<a name='4145'></font>
       <font color=#447700>! and cloud top height ( ps0(kpen-1) + ppen )                           !<a name='4146'></font>
       <font color=#447700>! ----------------------------------------------------------------------! <a name='4147'></font>
       do k = krel, kpen <font color=#447700>! This is a layer index<a name='4148'></font>
          <font color=#447700>! ------------------------------------------------------------------ ! <a name='4149'></font>
          <font color=#447700>! Calculate cumulus condensate at the upper interface of each layer. !<a name='4150'></font>
          <font color=#447700>! Note 'ppen &lt; 0' and at 'k=kpen' layer, I used 'thlu_top'&amp;'qtu_top' !<a name='4151'></font>
          <font color=#447700>! which explicitly considered zero or non-zero 'fer(kpen)'.          !<a name='4152'></font>
          <font color=#447700>! ------------------------------------------------------------------ ! <a name='4153'></font>
          if( k .eq. kpen ) then <a name='4154'>
              call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_23">(ps0(k-1)+ppen,thlu_top,qtu_top,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='4155'>
          else<a name='4156'>
              call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_24">(ps0(k),thlu(k),qtu(k),thj,qvj,qlj,qij,qse,id_check,qsat)<a name='4157'>
          endif<a name='4158'>
          if( id_check .eq. 1 ) then<a name='4159'>
              exit_conden(i) = 1._r8<a name='4160'>
              id_exit = .true.<a name='4161'>
              go to 333<a name='4162'>
          end if<a name='4163'>
          <font color=#447700>! ---------------------------------------------------------------- !<a name='4164'></font>
          <font color=#447700>! Calculate in-cloud mean LWC ( qlu(k) ), IWC ( qiu(k) ),  &amp; layer !<a name='4165'></font>
          <font color=#447700>! mean cumulus fraction ( cufrc(k) ),  vertically-integrated layer !<a name='4166'></font>
          <font color=#447700>! mean LWP and IWP. Expel some of in-cloud condensate at the upper !<a name='4167'></font>
          <font color=#447700>! interface if it is largr than criqc. Note cumulus cloud fraction !<a name='4168'></font>
          <font color=#447700>! is assumed to be twice of core updraft fractional area. Thus LWP !<a name='4169'></font>
          <font color=#447700>! and IWP will be twice of actual value coming from our scheme.    !<a name='4170'></font>
          <font color=#447700>! ---------------------------------------------------------------- !<a name='4171'></font>
          qcu(k)   = 0.5_r8 * ( qcubelow + qlj + qij )<a name='4172'>
          qlu(k)   = 0.5_r8 * ( qlubelow + qlj )<a name='4173'>
          qiu(k)   = 0.5_r8 * ( qiubelow + qij )<a name='4174'>
          cufrc(k) = ( ufrc(k-1) + ufrc(k) )<a name='4175'>
          if( k .eq. krel ) then<a name='4176'>
              cufrc(k) = ( ufrclcl + ufrc(k) )*( prel - ps0(k) )/( ps0(k-1) - ps0(k) )<a name='4177'>
          else if( k .eq. kpen ) then<a name='4178'>
              cufrc(k) = ( ufrc(k-1) + 0._r8 )*( -ppen )        /( ps0(k-1) - ps0(k) )<a name='4179'>
              if( (qlj + qij) .gt. criqc ) then           <a name='4180'>
                   qcu(k) = 0.5_r8 * ( qcubelow + criqc )<a name='4181'>
                   qlu(k) = 0.5_r8 * ( qlubelow + criqc * qlj / ( qlj + qij ) )<a name='4182'>
                   qiu(k) = 0.5_r8 * ( qiubelow + criqc * qij / ( qlj + qij ) )<a name='4183'>
              endif<a name='4184'>
          endif  <a name='4185'>
          rcwp = rcwp + ( qlu(k) + qiu(k) ) * ( ps0(k-1) - ps0(k) ) / g * cufrc(k)<a name='4186'>
          rlwp = rlwp +   qlu(k)            * ( ps0(k-1) - ps0(k) ) / g * cufrc(k)<a name='4187'>
          riwp = riwp +   qiu(k)            * ( ps0(k-1) - ps0(k) ) / g * cufrc(k)<a name='4188'>
          qcubelow = qlj + qij<a name='4189'>
          qlubelow = qlj<a name='4190'>
          qiubelow = qij<a name='4191'>
       end do<a name='4192'>
       <font color=#447700>! ------------------------------------ !      <a name='4193'></font>
       <font color=#447700>! Cloud top and base interface indices !<a name='4194'></font>
       <font color=#447700>! ------------------------------------ !<a name='4195'></font>
       cnt = real( kpen, r8 )<a name='4196'>
       cnb = real( krel - 1, r8 )<a name='4197'>
<a name='4198'>
       <font color=#447700>! ------------------------------------------------------------------------- !<a name='4199'></font>
       <font color=#447700>! End of formal calculation. Below blocks are for implicit CIN calculations ! <a name='4200'></font>
       <font color=#447700>! with re-initialization and save variables at iter_cin = 1._r8             !<a name='4201'></font>
       <font color=#447700>! ------------------------------------------------------------------------- !<a name='4202'></font>
       <a name='4203'>
       <font color=#447700>! --------------------------------------------------------------- !<a name='4204'></font>
       <font color=#447700>! Adjust the original input profiles for implicit CIN calculation !<a name='4205'></font>
       <font color=#447700>! --------------------------------------------------------------- !<a name='4206'></font>
<a name='4207'>
       if( iter .ne. iter_cin ) then <a name='4208'>
<a name='4209'>
          <font color=#447700>! ------------------------------------------------------------------- !<a name='4210'></font>
          <font color=#447700>! Save the output from "iter_cin = 1"                                 !<a name='4211'></font>
          <font color=#447700>! These output will be writed-out if "iter_cin = 1" was not performed !<a name='4212'></font>
          <font color=#447700>! for some reasons.                                                   !<a name='4213'></font>
          <font color=#447700>! ------------------------------------------------------------------- !<a name='4214'></font>
<a name='4215'>
          qv0_s(:mkx)           = qv0(:mkx) + qvten(:mkx) * dt<a name='4216'>
          ql0_s(:mkx)           = ql0(:mkx) + qlten(:mkx) * dt<a name='4217'>
          qi0_s(:mkx)           = qi0(:mkx) + qiten(:mkx) * dt<a name='4218'>
          s0_s(:mkx)            = s0(:mkx)  +  sten(:mkx) * dt <a name='4219'>
          u0_s(:mkx)            = u0(:mkx)  +  uten(:mkx) * dt<a name='4220'>
          v0_s(:mkx)            = v0(:mkx)  +  vten(:mkx) * dt <a name='4221'>
          qt0_s(:mkx)           = qv0_s(:mkx) + ql0_s(:mkx) + qi0_s(:mkx)<a name='4222'>
          t0_s(:mkx)            = t0(:mkx)  +  sten(:mkx) * dt / cp<a name='4223'>
          do m = 1, ncnst<a name='4224'>
             tr0_s(:mkx,m)      = tr0(:mkx,m) + trten(:mkx,m) * dt<a name='4225'>
          enddo<a name='4226'>
<a name='4227'>
          umf_s(0:mkx)          = umf(0:mkx)<a name='4228'>
          qvten_s(:mkx)         = qvten(:mkx)<a name='4229'>
          qlten_s(:mkx)         = qlten(:mkx)  <a name='4230'>
          qiten_s(:mkx)         = qiten(:mkx)<a name='4231'>
          sten_s(:mkx)          = sten(:mkx)<a name='4232'>
          uten_s(:mkx)          = uten(:mkx)  <a name='4233'>
          vten_s(:mkx)          = vten(:mkx)<a name='4234'>
          qrten_s(:mkx)         = qrten(:mkx)<a name='4235'>
          qsten_s(:mkx)         = qsten(:mkx)  <a name='4236'>
          precip_s              = precip<a name='4237'>
          snow_s                = snow<a name='4238'>
          evapc_s(:mkx)         = evapc(:mkx)<a name='4239'>
          cush_s                = cush<a name='4240'>
          cufrc_s(:mkx)         = cufrc(:mkx)  <a name='4241'>
          slflx_s(0:mkx)        = slflx(0:mkx)  <a name='4242'>
          qtflx_s(0:mkx)        = qtflx(0:mkx)  <a name='4243'>
          qcu_s(:mkx)           = qcu(:mkx)  <a name='4244'>
          qlu_s(:mkx)           = qlu(:mkx)  <a name='4245'>
          qiu_s(:mkx)           = qiu(:mkx)  <a name='4246'>
          fer_s(:mkx)           = fer(:mkx)  <a name='4247'>
          fdr_s(:mkx)           = fdr(:mkx)  <a name='4248'>
          cin_s                 = cin<a name='4249'>
          cinlcl_s              = cinlcl<a name='4250'>
          cbmf_s                = cbmf<a name='4251'>
          rliq_s                = rliq<a name='4252'>
          qc_s(:mkx)            = qc(:mkx)<a name='4253'>
          cnt_s                 = cnt<a name='4254'>
          cnb_s                 = cnb<a name='4255'>
          qtten_s(:mkx)         = qtten(:mkx)<a name='4256'>
          slten_s(:mkx)         = slten(:mkx)<a name='4257'>
          ufrc_s(0:mkx)         = ufrc(0:mkx) <a name='4258'>
<a name='4259'>
          uflx_s(0:mkx)         = uflx(0:mkx)  <a name='4260'>
          vflx_s(0:mkx)         = vflx(0:mkx)  <a name='4261'>
           <a name='4262'>
          ufrcinvbase_s         = ufrcinvbase<a name='4263'>
          ufrclcl_s             = ufrclcl <a name='4264'>
          winvbase_s            = winvbase<a name='4265'>
          wlcl_s                = wlcl<a name='4266'>
          plcl_s                = plcl<a name='4267'>
          pinv_s                = ps0(kinv-1)<a name='4268'>
          plfc_s                = plfc        <a name='4269'>
          pbup_s                = ps0(kbup)<a name='4270'>
          ppen_s                = ps0(kpen-1) + ppen        <a name='4271'>
          qtsrc_s               = qtsrc<a name='4272'>
          thlsrc_s              = thlsrc<a name='4273'>
          thvlsrc_s             = thvlsrc<a name='4274'>
          emfkbup_s             = emf(kbup)<a name='4275'>
          cbmflimit_s           = cbmflimit<a name='4276'>
          tkeavg_s              = tkeavg<a name='4277'>
          zinv_s                = zs0(kinv-1)<a name='4278'>
          rcwp_s                = rcwp<a name='4279'>
          rlwp_s                = rlwp<a name='4280'>
          riwp_s                = riwp<a name='4281'>
<a name='4282'>
          wu_s(0:mkx)           = wu(0:mkx)<a name='4283'>
          qtu_s(0:mkx)          = qtu(0:mkx)<a name='4284'>
          thlu_s(0:mkx)         = thlu(0:mkx)<a name='4285'>
          thvu_s(0:mkx)         = thvu(0:mkx)<a name='4286'>
          uu_s(0:mkx)           = uu(0:mkx)<a name='4287'>
          vu_s(0:mkx)           = vu(0:mkx)<a name='4288'>
          qtu_emf_s(0:mkx)      = qtu_emf(0:mkx)<a name='4289'>
          thlu_emf_s(0:mkx)     = thlu_emf(0:mkx)<a name='4290'>
          uu_emf_s(0:mkx)       = uu_emf(0:mkx)<a name='4291'>
          vu_emf_s(0:mkx)       = vu_emf(0:mkx)<a name='4292'>
          uemf_s(0:mkx)         = uemf(0:mkx)<a name='4293'>
<a name='4294'>
          dwten_s(:mkx)         = dwten(:mkx)<a name='4295'>
          diten_s(:mkx)         = diten(:mkx)<a name='4296'>
          flxrain_s(0:mkx)      = flxrain(0:mkx)<a name='4297'>
          flxsnow_s(0:mkx)      = flxsnow(0:mkx)<a name='4298'>
          ntraprd_s(:mkx)       = ntraprd(:mkx)<a name='4299'>
          ntsnprd_s(:mkx)       = ntsnprd(:mkx)<a name='4300'>
<a name='4301'>
          excessu_arr_s(:mkx)   = excessu_arr(:mkx)<a name='4302'>
          excess0_arr_s(:mkx)   = excess0_arr(:mkx)<a name='4303'>
          xc_arr_s(:mkx)        = xc_arr(:mkx)<a name='4304'>
          aquad_arr_s(:mkx)     = aquad_arr(:mkx)<a name='4305'>
          bquad_arr_s(:mkx)     = bquad_arr(:mkx)<a name='4306'>
          cquad_arr_s(:mkx)     = cquad_arr(:mkx)<a name='4307'>
          bogbot_arr_s(:mkx)    = bogbot_arr(:mkx)<a name='4308'>
          bogtop_arr_s(:mkx)    = bogtop_arr(:mkx)<a name='4309'>
<a name='4310'>
          do m = 1, ncnst<a name='4311'>
             trten_s(:mkx,m)    = trten(:mkx,m)<a name='4312'>
             trflx_s(0:mkx,m)   = trflx(0:mkx,m)<a name='4313'>
             tru_s(0:mkx,m)     = tru(0:mkx,m)<a name='4314'>
             tru_emf_s(0:mkx,m) = tru_emf(0:mkx,m)<a name='4315'>
          enddo<a name='4316'>
<a name='4317'>
          <font color=#447700>! ----------------------------------------------------------------------------- ! <a name='4318'></font>
          <font color=#447700>! Recalculate environmental variables for new cin calculation at "iter_cin = 2" ! <a name='4319'></font>
          <font color=#447700>! using the updated state variables. Perform only for variables necessary  for  !<a name='4320'></font>
          <font color=#447700>! the new cin calculation.                                                      !<a name='4321'></font>
          <font color=#447700>! ----------------------------------------------------------------------------- !<a name='4322'></font>
          <a name='4323'>
          qv0(:mkx)   = qv0_s(:mkx)<a name='4324'>
          ql0(:mkx)   = ql0_s(:mkx)<a name='4325'>
          qi0(:mkx)   = qi0_s(:mkx)<a name='4326'>
          s0(:mkx)    = s0_s(:mkx)<a name='4327'>
          t0(:mkx)    = t0_s(:mkx)<a name='4328'>
      <a name='4329'>
          qt0(:mkx)   = (qv0(:mkx) + ql0(:mkx) + qi0(:mkx))<a name='4330'>
          thl0(:mkx)  = (t0(:mkx) - xlv*ql0(:mkx)/cp - xls*qi0(:mkx)/cp)/exn0(:mkx)<a name='4331'>
          thvl0(:mkx) = (1._r8 + zvir*qt0(:mkx))*thl0(:mkx)<a name='4332'>
<a name='4333'>
          ssthl0      = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#SLOPE'>slope</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_6">(mkx,thl0,p0) <font color=#447700>! Dimension of ssthl0(:mkx) is implicit<a name='4334'></font>
          ssqt0       = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#SLOPE'>slope</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_7">(mkx,qt0 ,p0)<a name='4335'>
          ssu0        = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#SLOPE'>slope</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_8">(mkx,u0  ,p0)<a name='4336'>
          ssv0        = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#SLOPE'>slope</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_9">(mkx,v0  ,p0)<a name='4337'>
          do m = 1, ncnst<a name='4338'>
             sstr0(:mkx,m) = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#SLOPE'>slope</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_10">(mkx,tr0(:mkx,m),p0)<a name='4339'>
          enddo<a name='4340'>
<a name='4341'>
          do k = 1, mkx<a name='4342'>
<a name='4343'>
             thl0bot = thl0(k) + ssthl0(k) * ( ps0(k-1) - p0(k) )<a name='4344'>
             qt0bot  = qt0(k)  + ssqt0(k)  * ( ps0(k-1) - p0(k) )<a name='4345'>
             call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_25">(ps0(k-1),thl0bot,qt0bot,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='4346'>
             if( id_check .eq. 1 ) then<a name='4347'>
                 exit_conden(i) = 1._r8<a name='4348'>
                 id_exit = .true.<a name='4349'>
                 go to 333<a name='4350'>
             end if<a name='4351'>
             thv0bot(k)  = thj * ( 1._r8 + zvir*qvj - qlj - qij )<a name='4352'>
             thvl0bot(k) = thl0bot * ( 1._r8 + zvir*qt0bot )<a name='4353'>
          <a name='4354'>
             thl0top = thl0(k) + ssthl0(k) * ( ps0(k) - p0(k) )<a name='4355'>
             qt0top  =  qt0(k) + ssqt0(k)  * ( ps0(k) - p0(k) )<a name='4356'>
             call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN'>conden</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDEN_26">(ps0(k),thl0top,qt0top,thj,qvj,qlj,qij,qse,id_check,qsat)<a name='4357'>
             if( id_check .eq. 1 ) then<a name='4358'>
                 exit_conden(i) = 1._r8<a name='4359'>
                 id_exit = .true.<a name='4360'>
                 go to 333<a name='4361'>
             end if<a name='4362'>
             thv0top(k)  = thj * ( 1._r8 + zvir*qvj - qlj - qij )<a name='4363'>
             thvl0top(k) = thl0top * ( 1._r8 + zvir*qt0top )<a name='4364'>
<a name='4365'>
          end do<a name='4366'>
<a name='4367'>
       endif               <font color=#447700>! End of 'if(iter .ne. iter_cin)' if sentence. <a name='4368'></font>
<a name='4369'>
     end do                <font color=#447700>! End of implicit CIN loop (cin_iter)      <a name='4370'></font>
<a name='4371'>
     <font color=#447700>! ----------------------- !<a name='4372'></font>
     <font color=#447700>! Update Output Variables !<a name='4373'></font>
     <font color=#447700>! ----------------------- !<a name='4374'></font>
<a name='4375'>
     umf_out(i,0:mkx)             = umf(0:mkx)<a name='4376'>
     slflx_out(i,0:mkx)           = slflx(0:mkx)<a name='4377'>
     qtflx_out(i,0:mkx)           = qtflx(0:mkx)<a name='4378'>
<font color=#447700>!the indices are not reversed, these variables go into compute_mcshallow_inv, this is why they are called "flxprc1" and "flxsnow1". <a name='4379'></font>
     flxprc1_out(i,0:mkx)         = flxrain(0:mkx) + flxsnow(0:mkx)<a name='4380'>
     flxsnow1_out(i,0:mkx)        = flxsnow(0:mkx)<a name='4381'>
     qvten_out(i,:mkx)            = qvten(:mkx)<a name='4382'>
     qlten_out(i,:mkx)            = qlten(:mkx)<a name='4383'>
     qiten_out(i,:mkx)            = qiten(:mkx)<a name='4384'>
     sten_out(i,:mkx)             = sten(:mkx)<a name='4385'>
     uten_out(i,:mkx)             = uten(:mkx)<a name='4386'>
     vten_out(i,:mkx)             = vten(:mkx)<a name='4387'>
     qrten_out(i,:mkx)            = qrten(:mkx)<a name='4388'>
     qsten_out(i,:mkx)            = qsten(:mkx)<a name='4389'>
     precip_out(i)                = precip<a name='4390'>
     snow_out(i)                  = snow<a name='4391'>
     evapc_out(i,:mkx)            = evapc(:mkx)<a name='4392'>
     cufrc_out(i,:mkx)            = cufrc(:mkx)<a name='4393'>
     qcu_out(i,:mkx)              = qcu(:mkx)<a name='4394'>
     qlu_out(i,:mkx)              = qlu(:mkx)<a name='4395'>
     qiu_out(i,:mkx)              = qiu(:mkx)<a name='4396'>
     cush_inout(i)                = cush<a name='4397'>
     cbmf_out(i)                  = cbmf<a name='4398'>
     rliq_out(i)                  = rliq<a name='4399'>
     qc_out(i,:mkx)               = qc(:mkx)<a name='4400'>
     cnt_out(i)                   = cnt<a name='4401'>
     cnb_out(i)                   = cnb<a name='4402'>
<a name='4403'>
     do m = 1, ncnst<a name='4404'>
        trten_out(i,:mkx,m)       = trten(:mkx,m)<a name='4405'>
     enddo<a name='4406'>
  <a name='4407'>
     <font color=#447700>! ------------------------------------------------- !<a name='4408'></font>
     <font color=#447700>! Below are specific diagnostic output for detailed !<a name='4409'></font>
     <font color=#447700>! analysis of cumulus scheme                        !<a name='4410'></font>
     <font color=#447700>! ------------------------------------------------- !<a name='4411'></font>
<a name='4412'>
     fer_out(i,mkx:1:-1)          = fer(:mkx)  <a name='4413'>
     fdr_out(i,mkx:1:-1)          = fdr(:mkx)  <a name='4414'>
     cinh_out(i)                  = cin<a name='4415'>
     cinlclh_out(i)               = cinlcl<a name='4416'>
     qtten_out(i,mkx:1:-1)        = qtten(:mkx)<a name='4417'>
     slten_out(i,mkx:1:-1)        = slten(:mkx)<a name='4418'>
     ufrc_out(i,mkx:0:-1)         = ufrc(0:mkx)<a name='4419'>
     uflx_out(i,mkx:0:-1)         = uflx(0:mkx)  <a name='4420'>
     vflx_out(i,mkx:0:-1)         = vflx(0:mkx)  <a name='4421'>
     <a name='4422'>
     ufrcinvbase_out(i)           = ufrcinvbase<a name='4423'>
     ufrclcl_out(i)               = ufrclcl <a name='4424'>
     winvbase_out(i)              = winvbase<a name='4425'>
     wlcl_out(i)                  = wlcl<a name='4426'>
     plcl_out(i)                  = plcl<a name='4427'>
     pinv_out(i)                  = ps0(kinv-1)<a name='4428'>
     plfc_out(i)                  = plfc    <a name='4429'>
     pbup_out(i)                  = ps0(kbup)        <a name='4430'>
     ppen_out(i)                  = ps0(kpen-1) + ppen            <a name='4431'>
     qtsrc_out(i)                 = qtsrc<a name='4432'>
     thlsrc_out(i)                = thlsrc<a name='4433'>
     thvlsrc_out(i)               = thvlsrc<a name='4434'>
     emfkbup_out(i)               = emf(kbup)<a name='4435'>
     cbmflimit_out(i)             = cbmflimit<a name='4436'>
     tkeavg_out(i)                = tkeavg<a name='4437'>
     zinv_out(i)                  = zs0(kinv-1)<a name='4438'>
     rcwp_out(i)                  = rcwp<a name='4439'>
     rlwp_out(i)                  = rlwp<a name='4440'>
     riwp_out(i)                  = riwp<a name='4441'>
<a name='4442'>
     wu_out(i,mkx:0:-1)           = wu(0:mkx)<a name='4443'>
     qtu_out(i,mkx:0:-1)          = qtu(0:mkx)<a name='4444'>
     thlu_out(i,mkx:0:-1)         = thlu(0:mkx)<a name='4445'>
     thvu_out(i,mkx:0:-1)         = thvu(0:mkx)<a name='4446'>
     uu_out(i,mkx:0:-1)           = uu(0:mkx)<a name='4447'>
     vu_out(i,mkx:0:-1)           = vu(0:mkx)<a name='4448'>
     qtu_emf_out(i,mkx:0:-1)      = qtu_emf(0:mkx)<a name='4449'>
     thlu_emf_out(i,mkx:0:-1)     = thlu_emf(0:mkx)<a name='4450'>
     uu_emf_out(i,mkx:0:-1)       = uu_emf(0:mkx)<a name='4451'>
     vu_emf_out(i,mkx:0:-1)       = vu_emf(0:mkx)<a name='4452'>
     uemf_out(i,mkx:0:-1)         = uemf(0:mkx)<a name='4453'>
<a name='4454'>
     dwten_out(i,mkx:1:-1)        = dwten(:mkx)<a name='4455'>
     diten_out(i,mkx:1:-1)        = diten(:mkx)<a name='4456'>
     flxrain_out(i,mkx:0:-1)      = flxrain(0:mkx)<a name='4457'>
     flxsnow_out(i,mkx:0:-1)      = flxsnow(0:mkx)<a name='4458'>
     ntraprd_out(i,mkx:1:-1)      = ntraprd(:mkx)<a name='4459'>
     ntsnprd_out(i,mkx:1:-1)      = ntsnprd(:mkx)<a name='4460'>
<a name='4461'>
     excessu_arr_out(i,mkx:1:-1)  = excessu_arr(:mkx)<a name='4462'>
     excess0_arr_out(i,mkx:1:-1)  = excess0_arr(:mkx)<a name='4463'>
     xc_arr_out(i,mkx:1:-1)       = xc_arr(:mkx)<a name='4464'>
     aquad_arr_out(i,mkx:1:-1)    = aquad_arr(:mkx)<a name='4465'>
     bquad_arr_out(i,mkx:1:-1)    = bquad_arr(:mkx)<a name='4466'>
     cquad_arr_out(i,mkx:1:-1)    = cquad_arr(:mkx)<a name='4467'>
     bogbot_arr_out(i,mkx:1:-1)   = bogbot_arr(:mkx)<a name='4468'>
     bogtop_arr_out(i,mkx:1:-1)   = bogtop_arr(:mkx)<a name='4469'>
<a name='4470'>
     do m = 1, ncnst<a name='4471'>
        trflx_out(i,mkx:0:-1,m)   = trflx(0:mkx,m)  <a name='4472'>
        tru_out(i,mkx:0:-1,m)     = tru(0:mkx,m)<a name='4473'>
        tru_emf_out(i,mkx:0:-1,m) = tru_emf(0:mkx,m)<a name='4474'>
     enddo<a name='4475'>
<a name='4476'>
 333 if(id_exit) then <font color=#447700>! Exit without cumulus convection<a name='4477'></font>
<a name='4478'>
     exit_UWCu(i) = 1._r8<a name='4479'>
<a name='4480'>
     <font color=#447700>! --------------------------------------------------------------------- !<a name='4481'></font>
     <font color=#447700>! Initialize output variables when cumulus convection was not performed.!<a name='4482'></font>
     <font color=#447700>! --------------------------------------------------------------------- !<a name='4483'></font>
     <a name='4484'>
     umf_out(i,0:mkx)             = 0._r8   <a name='4485'>
     slflx_out(i,0:mkx)           = 0._r8<a name='4486'>
     qtflx_out(i,0:mkx)           = 0._r8<a name='4487'>
     qvten_out(i,:mkx)            = 0._r8<a name='4488'>
     qlten_out(i,:mkx)            = 0._r8<a name='4489'>
     qiten_out(i,:mkx)            = 0._r8<a name='4490'>
     sten_out(i,:mkx)             = 0._r8<a name='4491'>
     uten_out(i,:mkx)             = 0._r8<a name='4492'>
     vten_out(i,:mkx)             = 0._r8<a name='4493'>
     qrten_out(i,:mkx)            = 0._r8<a name='4494'>
     qsten_out(i,:mkx)            = 0._r8<a name='4495'>
     precip_out(i)                = 0._r8<a name='4496'>
     snow_out(i)                  = 0._r8<a name='4497'>
     evapc_out(i,:mkx)            = 0._r8<a name='4498'>
     cufrc_out(i,:mkx)            = 0._r8<a name='4499'>
     qcu_out(i,:mkx)              = 0._r8<a name='4500'>
     qlu_out(i,:mkx)              = 0._r8<a name='4501'>
     qiu_out(i,:mkx)              = 0._r8<a name='4502'>
     cush_inout(i)                = -1._r8<a name='4503'>
     cbmf_out(i)                  = 0._r8   <a name='4504'>
     rliq_out(i)                  = 0._r8<a name='4505'>
     qc_out(i,:mkx)               = 0._r8<a name='4506'>
     cnt_out(i)                   = 1._r8<a name='4507'>
     cnb_out(i)                   = real(mkx, r8)<a name='4508'>
<a name='4509'>
     fer_out(i,mkx:1:-1)          = 0._r8  <a name='4510'>
     fdr_out(i,mkx:1:-1)          = 0._r8  <a name='4511'>
     cinh_out(i)                  = -1._r8 <a name='4512'>
     cinlclh_out(i)               = -1._r8 <a name='4513'>
     qtten_out(i,mkx:1:-1)        = 0._r8<a name='4514'>
     slten_out(i,mkx:1:-1)        = 0._r8<a name='4515'>
     ufrc_out(i,mkx:0:-1)         = 0._r8<a name='4516'>
     uflx_out(i,mkx:0:-1)         = 0._r8  <a name='4517'>
     vflx_out(i,mkx:0:-1)         = 0._r8  <a name='4518'>
<a name='4519'>
     ufrcinvbase_out(i)           = 0._r8 <a name='4520'>
     ufrclcl_out(i)               = 0._r8 <a name='4521'>
     winvbase_out(i)              = 0._r8    <a name='4522'>
     wlcl_out(i)                  = 0._r8    <a name='4523'>
     plcl_out(i)                  = 0._r8    <a name='4524'>
     pinv_out(i)                  = 0._r8     <a name='4525'>
     plfc_out(i)                  = 0._r8     <a name='4526'>
     pbup_out(i)                  = 0._r8    <a name='4527'>
     ppen_out(i)                  = 0._r8    <a name='4528'>
     qtsrc_out(i)                 = 0._r8    <a name='4529'>
     thlsrc_out(i)                = 0._r8    <a name='4530'>
     thvlsrc_out(i)               = 0._r8    <a name='4531'>
     emfkbup_out(i)               = 0._r8<a name='4532'>
     cbmflimit_out(i)             = 0._r8    <a name='4533'>
     tkeavg_out(i)                = 0._r8    <a name='4534'>
     zinv_out(i)                  = 0._r8    <a name='4535'>
     rcwp_out(i)                  = 0._r8    <a name='4536'>
     rlwp_out(i)                  = 0._r8    <a name='4537'>
     riwp_out(i)                  = 0._r8    <a name='4538'>
<a name='4539'>
     wu_out(i,mkx:0:-1)           = 0._r8    <a name='4540'>
     qtu_out(i,mkx:0:-1)          = 0._r8        <a name='4541'>
     thlu_out(i,mkx:0:-1)         = 0._r8         <a name='4542'>
     thvu_out(i,mkx:0:-1)         = 0._r8         <a name='4543'>
     uu_out(i,mkx:0:-1)           = 0._r8        <a name='4544'>
     vu_out(i,mkx:0:-1)           = 0._r8        <a name='4545'>
     qtu_emf_out(i,mkx:0:-1)      = 0._r8         <a name='4546'>
     thlu_emf_out(i,mkx:0:-1)     = 0._r8         <a name='4547'>
     uu_emf_out(i,mkx:0:-1)       = 0._r8          <a name='4548'>
     vu_emf_out(i,mkx:0:-1)       = 0._r8    <a name='4549'>
     uemf_out(i,mkx:0:-1)         = 0._r8    <a name='4550'>
   <a name='4551'>
     dwten_out(i,mkx:1:-1)        = 0._r8    <a name='4552'>
     diten_out(i,mkx:1:-1)        = 0._r8    <a name='4553'>
     flxrain_out(i,mkx:0:-1)      = 0._r8     <a name='4554'>
     flxsnow_out(i,mkx:0:-1)      = 0._r8    <a name='4555'>
     ntraprd_out(i,mkx:1:-1)      = 0._r8    <a name='4556'>
     ntsnprd_out(i,mkx:1:-1)      = 0._r8    <a name='4557'>
<a name='4558'>
     excessu_arr_out(i,mkx:1:-1)  = 0._r8    <a name='4559'>
     excess0_arr_out(i,mkx:1:-1)  = 0._r8    <a name='4560'>
     xc_arr_out(i,mkx:1:-1)       = 0._r8    <a name='4561'>
     aquad_arr_out(i,mkx:1:-1)    = 0._r8    <a name='4562'>
     bquad_arr_out(i,mkx:1:-1)    = 0._r8    <a name='4563'>
     cquad_arr_out(i,mkx:1:-1)    = 0._r8    <a name='4564'>
     bogbot_arr_out(i,mkx:1:-1)   = 0._r8    <a name='4565'>
     bogtop_arr_out(i,mkx:1:-1)   = 0._r8    <a name='4566'>
<a name='4567'>
     do m = 1, ncnst<a name='4568'>
        trten_out(i,:mkx,m)       = 0._r8<a name='4569'>
        trflx_out(i,mkx:0:-1,m)   = 0._r8  <a name='4570'>
        tru_out(i,mkx:0:-1,m)     = 0._r8<a name='4571'>
        tru_emf_out(i,mkx:0:-1,m) = 0._r8<a name='4572'>
     enddo<a name='4573'>
<a name='4574'>
     end if<a name='4575'>
<a name='4576'>
     end do                  <font color=#447700>! end of big i loop for each column.<a name='4577'></font>
<a name='4578'>
     <font color=#447700>! ---------------------------------------- !<a name='4579'></font>
     <font color=#447700>! Writing main diagnostic output variables !<a name='4580'></font>
     <font color=#447700>! ---------------------------------------- !<a name='4581'></font>
<a name='4582'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_110">( 'qtflx_Cu'        , qtflx_out(:,mkx:0:-1),    mix,    lchnk ) <a name='4583'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_111">( 'slflx_Cu'        , slflx_out(:,mkx:0:-1),    mix,    lchnk ) <a name='4584'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_112">( 'uflx_Cu'         , uflx_out,                 mix,    lchnk ) <a name='4585'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_113">( 'vflx_Cu'         , vflx_out,                 mix,    lchnk ) <a name='4586'>
<a name='4587'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_114">( 'qtten_Cu'        , qtten_out,                mix,    lchnk ) <a name='4588'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_115">( 'slten_Cu'        , slten_out,                mix,    lchnk ) <a name='4589'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_116">( 'uten_Cu'         , uten_out(:,mkx:1:-1),     mix,    lchnk ) <a name='4590'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_117">( 'vten_Cu'         , vten_out(:,mkx:1:-1),     mix,    lchnk ) <a name='4591'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_118">( 'qvten_Cu'        , qvten_out(:,mkx:1:-1),    mix,    lchnk ) <a name='4592'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_119">( 'qlten_Cu'        , qlten_out(:,mkx:1:-1),    mix,    lchnk )<a name='4593'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_120">( 'qiten_Cu'        , qiten_out(:,mkx:1:-1),    mix,    lchnk )   <a name='4594'>
<a name='4595'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_121">( 'cbmf_Cu'         , cbmf_out,                 mix,    lchnk ) <a name='4596'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_122">( 'ufrcinvbase_Cu'  , ufrcinvbase_out,          mix,    lchnk ) <a name='4597'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_123">( 'ufrclcl_Cu'      , ufrclcl_out,              mix,    lchnk ) <a name='4598'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_124">( 'winvbase_Cu'     , winvbase_out,             mix,    lchnk ) <a name='4599'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_125">( 'wlcl_Cu'         , wlcl_out,                 mix,    lchnk ) <a name='4600'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_126">( 'plcl_Cu'         , plcl_out,                 mix,    lchnk ) <a name='4601'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_127">( 'pinv_Cu'         , pinv_out,                 mix,    lchnk ) <a name='4602'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_128">( 'plfc_Cu'         , plfc_out,                 mix,    lchnk ) <a name='4603'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_129">( 'pbup_Cu'         , pbup_out,                 mix,    lchnk ) <a name='4604'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_130">( 'ppen_Cu'         , ppen_out,                 mix,    lchnk ) <a name='4605'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_131">( 'qtsrc_Cu'        , qtsrc_out,                mix,    lchnk ) <a name='4606'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_132">( 'thlsrc_Cu'       , thlsrc_out,               mix,    lchnk ) <a name='4607'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_133">( 'thvlsrc_Cu'      , thvlsrc_out,              mix,    lchnk ) <a name='4608'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_134">( 'emfkbup_Cu'      , emfkbup_out,              mix,    lchnk )<a name='4609'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_135">( 'cin_Cu'          , cinh_out,                 mix,    lchnk )  <a name='4610'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_136">( 'cinlcl_Cu'       , cinlclh_out,              mix,    lchnk ) <a name='4611'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_137">( 'cbmflimit_Cu'    , cbmflimit_out,            mix,    lchnk ) <a name='4612'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_138">( 'tkeavg_Cu'       , tkeavg_out,               mix,    lchnk )<a name='4613'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_139">( 'zinv_Cu'         , zinv_out,                 mix,    lchnk )  <a name='4614'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_140">( 'rcwp_Cu'         , rcwp_out,                 mix,    lchnk )<a name='4615'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_141">( 'rlwp_Cu'         , rlwp_out,                 mix,    lchnk )<a name='4616'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_142">( 'riwp_Cu'         , riwp_out,                 mix,    lchnk )<a name='4617'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_143">( 'tophgt_Cu'       , cush_inout,               mix,    lchnk )   <a name='4618'>
<a name='4619'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_144">( 'wu_Cu'           , wu_out,                   mix,    lchnk )<a name='4620'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_145">( 'ufrc_Cu'         , ufrc_out,                 mix,    lchnk )<a name='4621'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_146">( 'qtu_Cu'          , qtu_out,                  mix,    lchnk )<a name='4622'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_147">( 'thlu_Cu'         , thlu_out,                 mix,    lchnk )<a name='4623'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_148">( 'thvu_Cu'         , thvu_out,                 mix,    lchnk )<a name='4624'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_149">( 'uu_Cu'           , uu_out,                   mix,    lchnk )<a name='4625'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_150">( 'vu_Cu'           , vu_out,                   mix,    lchnk )<a name='4626'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_151">( 'qtu_emf_Cu'      , qtu_emf_out,              mix,    lchnk )<a name='4627'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_152">( 'thlu_emf_Cu'     , thlu_emf_out,             mix,    lchnk )<a name='4628'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_153">( 'uu_emf_Cu'       , uu_emf_out,               mix,    lchnk )<a name='4629'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_154">( 'vu_emf_Cu'       , vu_emf_out,               mix,    lchnk )<a name='4630'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_155">( 'umf_Cu'          , umf_out(:,mkx:0:-1),      mix,    lchnk )<a name='4631'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_156">( 'uemf_Cu'         , uemf_out,                 mix,    lchnk )<a name='4632'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_157">( 'qcu_Cu'          , qcu_out(:,mkx:1:-1),      mix,    lchnk )<a name='4633'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_158">( 'qlu_Cu'          , qlu_out(:,mkx:1:-1),      mix,    lchnk )<a name='4634'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_159">( 'qiu_Cu'          , qiu_out(:,mkx:1:-1),      mix,    lchnk )<a name='4635'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_160">( 'cufrc_Cu'        , cufrc_out(:,mkx:1:-1),    mix,    lchnk )  <a name='4636'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_161">( 'fer_Cu'          , fer_out,                  mix,    lchnk )  <a name='4637'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_162">( 'fdr_Cu'          , fdr_out,                  mix,    lchnk )  <a name='4638'>
<a name='4639'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_163">( 'dwten_Cu'        , dwten_out,                mix,    lchnk )<a name='4640'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_164">( 'diten_Cu'        , diten_out,                mix,    lchnk )<a name='4641'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_165">( 'qrten_Cu'        , qrten_out(:,mkx:1:-1),    mix,    lchnk )<a name='4642'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_166">( 'qsten_Cu'        , qsten_out(:,mkx:1:-1),    mix,    lchnk )<a name='4643'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_167">( 'flxrain_Cu'      , flxrain_out,              mix,    lchnk )<a name='4644'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_168">( 'flxsnow_Cu'      , flxsnow_out,              mix,    lchnk )<a name='4645'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_169">( 'ntraprd_Cu'      , ntraprd_out,              mix,    lchnk )<a name='4646'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_170">( 'ntsnprd_Cu'      , ntsnprd_out,              mix,    lchnk )<a name='4647'>
<a name='4648'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_171">( 'excessu_Cu'      , excessu_arr_out,          mix,    lchnk )<a name='4649'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_172">( 'excess0_Cu'      , excess0_arr_out,          mix,    lchnk )<a name='4650'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_173">( 'xc_Cu'           , xc_arr_out,               mix,    lchnk )<a name='4651'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_174">( 'aquad_Cu'        , aquad_arr_out,            mix,    lchnk )<a name='4652'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_175">( 'bquad_Cu'        , bquad_arr_out,            mix,    lchnk )<a name='4653'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_176">( 'cquad_Cu'        , cquad_arr_out,            mix,    lchnk )<a name='4654'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_177">( 'bogbot_Cu'       , bogbot_arr_out,           mix,    lchnk )<a name='4655'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_178">( 'bogtop_Cu'       , bogtop_arr_out,           mix,    lchnk )<a name='4656'>
<a name='4657'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_179">( 'exit_UWCu_Cu'    , exit_UWCu,                mix,    lchnk ) <a name='4658'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_180">( 'exit_conden_Cu'  , exit_conden,              mix,    lchnk ) <a name='4659'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_181">( 'exit_klclmkx_Cu' , exit_klclmkx,             mix,    lchnk ) <a name='4660'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_182">( 'exit_klfcmkx_Cu' , exit_klfcmkx,             mix,    lchnk ) <a name='4661'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_183">( 'exit_ufrc_Cu'    , exit_ufrc,                mix,    lchnk ) <a name='4662'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_184">( 'exit_wtw_Cu'     , exit_wtw,                 mix,    lchnk ) <a name='4663'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_185">( 'exit_drycore_Cu' , exit_drycore,             mix,    lchnk ) <a name='4664'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_186">( 'exit_wu_Cu'      , exit_wu,                  mix,    lchnk ) <a name='4665'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_187">( 'exit_cufilter_Cu', exit_cufilter,            mix,    lchnk ) <a name='4666'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_188">( 'exit_kinv1_Cu'   , exit_kinv1,               mix,    lchnk ) <a name='4667'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_189">( 'exit_rei_Cu'     , exit_rei,                 mix,    lchnk ) <a name='4668'>
<a name='4669'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_190">( 'limit_shcu_Cu'   , limit_shcu,               mix,    lchnk ) <a name='4670'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_191">( 'limit_negcon_Cu' , limit_negcon,             mix,    lchnk ) <a name='4671'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_192">( 'limit_ufrc_Cu'   , limit_ufrc,               mix,    lchnk ) <a name='4672'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_193">( 'limit_ppen_Cu'   , limit_ppen,               mix,    lchnk ) <a name='4673'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_194">( 'limit_emf_Cu'    , limit_emf,                mix,    lchnk ) <a name='4674'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_195">( 'limit_cinlcl_Cu' , limit_cinlcl,             mix,    lchnk ) <a name='4675'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_196">( 'limit_cin_Cu'    , limit_cin,                mix,    lchnk ) <a name='4676'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_197">( 'limit_cbmf_Cu'   , limit_cbmf,               mix,    lchnk ) <a name='4677'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_198">( 'limit_rei_Cu'    , limit_rei,                mix,    lchnk ) <a name='4678'>
     call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_199">( 'ind_delcin_Cu'   , ind_delcin,               mix,    lchnk ) <a name='4679'>
<a name='4680'>
    return<a name='4681'>
<a name='4682'>
  end subroutine compute_uwshcu<a name='4683'>
<a name='4684'>
  <font color=#447700>! ------------------------------ !<a name='4685'></font>
  <font color=#447700>!                                ! <a name='4686'></font>
  <font color=#447700>! Beginning of subroutine blocks !<a name='4687'></font>
  <font color=#447700>!                                !<a name='4688'></font>
  <font color=#447700>! ------------------------------ !<a name='4689'></font>
<a name='4690'>
<A NAME='GETBUOY'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#GETBUOY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4691'>
  <font color=#993300>subroutine </font><font color=#cc0000>getbuoy</font>(pbot,thv0bot,ptop,thv0top,thvubot,thvutop,plfc,cin) <A href='../../call_to/GETBUOY.html' TARGET='index'>3</A><a name='4692'>
  <font color=#447700>! ----------------------------------------------------------- !<a name='4693'></font>
  <font color=#447700>! Subroutine to calculate integrated CIN [ J/kg = m2/s2 ] and !<a name='4694'></font>
  <font color=#447700>! 'cinlcl, plfc' if any. Assume 'thv' is linear in each layer !<a name='4695'></font>
  <font color=#447700>! both for cumulus and environment. Note that this subroutine !<a name='4696'></font>
  <font color=#447700>! only include positive CIN in calculation - if there are any !<a name='4697'></font>
  <font color=#447700>! negative CIN, it is assumed to be zero.    This is slightly !<a name='4698'></font>
  <font color=#447700>! different from 'single_cin' below, where both positive  and !<a name='4699'></font>
  <font color=#447700>! negative CIN are included.                                  !<a name='4700'></font>
  <font color=#447700>! ----------------------------------------------------------- !<a name='4701'></font>
    real(r8) pbot,thv0bot,ptop,thv0top,thvubot,thvutop,plfc,cin,frc<a name='4702'>
<a name='4703'>
    if( thvubot .gt. thv0bot .and. thvutop .gt. thv0top ) then<a name='4704'>
        plfc = pbot<a name='4705'>
        return<a name='4706'>
    elseif( thvubot .le. thv0bot .and. thvutop .le. thv0top ) then <a name='4707'>
        cin  = cin - ( (thvubot/thv0bot - 1._r8) + (thvutop/thv0top - 1._r8)) * (pbot - ptop) /        &amp;<a name='4708'>
                     ( pbot/(r*thv0bot*exnf(pbot)) + ptop/(r*thv0top*exnf(ptop)) )<a name='4709'>
    elseif( thvubot .gt. thv0bot .and. thvutop .le. thv0top ) then <a name='4710'>
        frc  = ( thvutop/thv0top - 1._r8 ) / ( (thvutop/thv0top - 1._r8) - (thvubot/thv0bot - 1._r8) )<a name='4711'>
        cin  = cin - ( thvutop/thv0top - 1._r8 ) * ( (ptop + frc*(pbot - ptop)) - ptop ) /             &amp;<a name='4712'>
                     ( pbot/(r*thv0bot*exnf(pbot)) + ptop/(r*thv0top*exnf(ptop)) )<a name='4713'>
    else            <a name='4714'>
        frc  = ( thvubot/thv0bot - 1._r8 ) / ( (thvubot/thv0bot - 1._r8) - (thvutop/thv0top - 1._r8) )<a name='4715'>
        plfc = pbot - frc * ( pbot - ptop )<a name='4716'>
        cin  = cin - ( thvubot/thv0bot - 1._r8)*(pbot - plfc)/                                         &amp; <a name='4717'>
                     ( pbot/(r*thv0bot*exnf(pbot)) + ptop/(r*thv0top * exnf(ptop)))<a name='4718'>
    endif<a name='4719'>
<a name='4720'>
    return<a name='4721'>
  end subroutine getbuoy<a name='4722'>
<a name='4723'>
<A NAME='SINGLE_CIN'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#SINGLE_CIN' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4724'>
  <font color=#993300>function </font><font color=#cc0000>single_cin</font>(pbot,thv0bot,ptop,thv0top,thvubot,thvutop)<a name='4725'>
  <font color=#447700>! ------------------------------------------------------- !<a name='4726'></font>
  <font color=#447700>! Function to calculate a single layer CIN by summing all ! <a name='4727'></font>
  <font color=#447700>! positive and negative CIN.                              !<a name='4728'></font>
  <font color=#447700>! ------------------------------------------------------- ! <a name='4729'></font>
    real(r8) :: single_cin<a name='4730'>
    real(r8)    pbot,thv0bot,ptop,thv0top,thvubot,thvutop <a name='4731'>
<a name='4732'>
    single_cin = ( (1._r8 - thvubot/thv0bot) + (1._r8 - thvutop/thv0top)) * ( pbot - ptop ) / &amp;<a name='4733'>
                 ( pbot/(r*thv0bot*exnf(pbot)) + ptop/(r*thv0top*exnf(ptop)) )<a name='4734'>
    return<a name='4735'>
  end function single_cin   <a name='4736'>
<a name='4737'>
<a name='4738'>
<A NAME='CONDEN'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4739'>
  <font color=#993300>subroutine </font><font color=#cc0000>conden</font>(p,thl,qt,th,qv,ql,qi,rvls,id_check,qsat) <A href='../../call_to/CONDEN.html' TARGET='index'>26</A>,<A href='../../call_from/CONDEN.html' TARGET='index'>2</A><a name='4740'>
  <font color=#447700>! --------------------------------------------------------------------- !<a name='4741'></font>
  <font color=#447700>! Calculate thermodynamic properties from a given set of ( p, thl, qt ) !<a name='4742'></font>
  <font color=#447700>! --------------------------------------------------------------------- !<a name='4743'></font>
    implicit none<a name='4744'>
    real(r8), intent(in)  :: p<a name='4745'>
    real(r8), intent(in)  :: thl<a name='4746'>
    real(r8), intent(in)  :: qt<a name='4747'>
    real(r8), intent(out) :: th<a name='4748'>
    real(r8), intent(out) :: qv<a name='4749'>
    real(r8), intent(out) :: ql<a name='4750'>
    real(r8), intent(out) :: qi<a name='4751'>
    real(r8), intent(out) :: rvls<a name='4752'>
    integer , intent(out) :: id_check<a name='4753'>
    integer , external    :: qsat<a name='4754'>
    real(r8)              :: tc,temps,t<a name='4755'>
    real(r8)              :: leff, nu, qc<a name='4756'>
    integer               :: iteration<a name='4757'>
    real(r8)              :: es(1)              <font color=#447700>! Saturation vapor pressure<a name='4758'></font>
    real(r8)              :: qs(1)              <font color=#447700>! Saturation spec. humidity<a name='4759'></font>
    real(r8)              :: gam(1)             <font color=#447700>! (L/cp)*dqs/dT<a name='4760'></font>
    integer               :: status             <font color=#447700>! Return status of qsat call<a name='4761'></font>
<a name='4762'>
    tc   = thl*exnf(p)<a name='4763'>
  <font color=#447700>! Modification : In order to be compatible with the dlf treatment in stratiform.F90,<a name='4764'></font>
  <font color=#447700>!                we may use ( 268.15, 238.15 ) with 30K ramping instead of 20 K,<a name='4765'></font>
  <font color=#447700>!                in computing ice fraction below. <a name='4766'></font>
  <font color=#447700>!                Note that 'cldwat_fice' uses ( 243.15, 263.15 ) with 20K ramping for stratus.<a name='4767'></font>
    nu   = max(min((268._r8 - tc)/20._r8,1.0_r8),0.0_r8)  <font color=#447700>! Fraction of ice in the condensate. <a name='4768'></font>
    leff = (1._r8 - nu)*xlv + nu*xls                      <font color=#447700>! This is an estimate that hopefully speeds convergence<a name='4769'></font>
<a name='4770'>
    <font color=#447700>! --------------------------------------------------------------------------- !<a name='4771'></font>
    <font color=#447700>! Below "temps" and "rvls" are just initial guesses for iteration loop below. !<a name='4772'></font>
    <font color=#447700>! Note that the output "temps" from the below iteration loop is "temperature" !<a name='4773'></font>
    <font color=#447700>! NOT "liquid temperature".                                                   !<a name='4774'></font>
    <font color=#447700>! --------------------------------------------------------------------------- !<a name='4775'></font>
<a name='4776'>
    temps  = tc<a name='4777'>
    status = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#QSAT'>qsat</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_26">(temps,p,es(1),qs(1),gam(1), 1)<a name='4778'>
    rvls   = qs(1)<a name='4779'>
<a name='4780'>
    if( qs(1) .ge. qt ) then  <a name='4781'>
        id_check = 0<a name='4782'>
        qv = qt<a name='4783'>
        qc = 0._r8<a name='4784'>
        ql = 0._r8<a name='4785'>
        qi = 0._r8<a name='4786'>
        th = tc/exnf(p)<a name='4787'>
    else <a name='4788'>
        do iteration = 1, 10<a name='4789'>
           temps  = temps + ( (tc-temps)*cp/leff + qt - rvls )/( cp/leff + ep2*leff*rvls/r/temps/temps )<a name='4790'>
           status = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#QSAT'>qsat</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#CONDEN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_27">(temps,p,es(1),qs(1),gam(1),1)<a name='4791'>
           rvls   = qs(1)<a name='4792'>
        end do<a name='4793'>
        qc = max(qt - qs(1),0._r8)<a name='4794'>
        qv = qt - qc<a name='4795'>
        ql = qc*(1._r8 - nu)<a name='4796'>
        qi = nu*qc<a name='4797'>
        th = temps/exnf(p)<a name='4798'>
        if( abs((temps-(leff/cp)*qc)-tc) .ge. 1._r8 ) then<a name='4799'>
            id_check = 1<a name='4800'>
        else<a name='4801'>
            id_check = 0<a name='4802'>
        end if<a name='4803'>
    end if<a name='4804'>
<a name='4805'>
    return<a name='4806'>
  end subroutine conden<a name='4807'>
<a name='4808'>
<A NAME='ROOTS'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#ROOTS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4809'>
  <font color=#993300>subroutine </font><font color=#cc0000>roots</font>(a,b,c,r1,r2,status) <A href='../../call_to/ROOTS.html' TARGET='index'>3</A><a name='4810'>
  <font color=#447700>! --------------------------------------------------------- !<a name='4811'></font>
  <font color=#447700>! Subroutine to solve the second order polynomial equation. !<a name='4812'></font>
  <font color=#447700>! I should check this subroutine later.                     !<a name='4813'></font>
  <font color=#447700>! --------------------------------------------------------- !<a name='4814'></font>
    real(r8), intent(in)  :: a<a name='4815'>
    real(r8), intent(in)  :: b<a name='4816'>
    real(r8), intent(in)  :: c<a name='4817'>
    real(r8), intent(out) :: r1<a name='4818'>
    real(r8), intent(out) :: r2<a name='4819'>
    integer , intent(out) :: status<a name='4820'>
    real(r8)              :: q<a name='4821'>
<a name='4822'>
    status = 0<a name='4823'>
<a name='4824'>
    if( a .eq. 0._r8 ) then                            <font color=#447700>! Form b*x + c = 0<a name='4825'></font>
        if( b .eq. 0._r8 ) then                        <font color=#447700>! Failure: c = 0<a name='4826'></font>
            status = 1<a name='4827'>
        else                                           <font color=#447700>! b*x + c = 0<a name='4828'></font>
            r1 = -c/b<a name='4829'>
        endif<a name='4830'>
        r2 = r1<a name='4831'>
    else<a name='4832'>
        if( b .eq. 0._r8 ) then                        <font color=#447700>! Form a*x**2 + c = 0<a name='4833'></font>
            if( a*c .gt. 0._r8 ) then                  <font color=#447700>! Failure: x**2 = -c/a &lt; 0<a name='4834'></font>
                status = 2  <a name='4835'>
            else                                       <font color=#447700>! x**2 = -c/a <a name='4836'></font>
                r1 = sqrt(-c/a)<a name='4837'>
            endif<a name='4838'>
            r2 = -r1<a name='4839'>
       else                                            <font color=#447700>! Form a*x**2 + b*x + c = 0<a name='4840'></font>
            if( (b**2 - 4._r8*a*c) .lt. 0._r8 ) then   <font color=#447700>! Failure, no real roots<a name='4841'></font>
                 status = 3<a name='4842'>
            else<a name='4843'>
                 q  = -0.5_r8*(b + sign(1.0_r8,b)*sqrt(b**2 - 4._r8*a*c))<a name='4844'>
                 r1 =  q/a<a name='4845'>
                 r2 =  c/q<a name='4846'>
            endif<a name='4847'>
       endif<a name='4848'>
    endif<a name='4849'>
<a name='4850'>
    return<a name='4851'>
  end subroutine roots<a name='4852'>
  <a name='4853'>
<A NAME='SLOPE'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#SLOPE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4854'>
  <font color=#993300>function </font><font color=#cc0000>slope</font>(mkx,field,p0) <A href='../../call_to/SLOPE.html' TARGET='index'>11</A>,<A href='../../call_from/SLOPE.html' TARGET='index'>1</A><a name='4855'>
  <font color=#447700>! ------------------------------------------------------------------ !<a name='4856'></font>
  <font color=#447700>! Function performing profile reconstruction of conservative scalars !<a name='4857'></font>
  <font color=#447700>! in each layer. This is identical to profile reconstruction used in !<a name='4858'></font>
  <font color=#447700>! UW-PBL scheme but from bottom to top layer here.     At the lowest !<a name='4859'></font>
  <font color=#447700>! layer near to surface, slope is defined using the two lowest layer !<a name='4860'></font>
  <font color=#447700>! mid-point values. I checked this subroutine and it is correct.     !<a name='4861'></font>
  <font color=#447700>! ------------------------------------------------------------------ !<a name='4862'></font>
    real(r8)             :: slope(mkx)<a name='4863'>
    integer,  intent(in) :: mkx<a name='4864'>
    real(r8), intent(in) :: field(mkx)<a name='4865'>
    real(r8), intent(in) :: p0(mkx)<a name='4866'>
    <a name='4867'>
    real(r8)             :: below<a name='4868'>
    real(r8)             :: above<a name='4869'>
    integer              :: k<a name='4870'>
<a name='4871'>
    below = ( field(2) - field(1) ) / ( p0(2) - p0(1) )<a name='4872'>
    do k = 2, mkx<a name='4873'>
       above = ( field(k) - field(k-1) ) / ( p0(k) - p0(k-1) )<a name='4874'>
       if( above .gt. 0._r8 ) then<a name='4875'>
           slope(k-1) = max(0._r8,min(above,below))<a name='4876'>
       else <a name='4877'>
           slope(k-1) = min(0._r8,max(above,below))<a name='4878'>
       end if<a name='4879'>
       below = above<a name='4880'>
    end do<a name='4881'>
    slope(mkx) = <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#SLOPE'>slope</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#SLOPE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_11">(mkx-1)<a name='4882'>
<a name='4883'>
    return<a name='4884'>
  end function slope<a name='4885'>
<a name='4886'>
<A NAME='QSINVERT'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#QSINVERT' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4887'>
  <font color=#993300>function </font><font color=#cc0000>qsinvert</font>(qt,thl,psfc,qsat) <A href='../../call_to/QSINVERT.html' TARGET='index'>1</A>,<A href='../../call_from/QSINVERT.html' TARGET='index'>5</A><a name='4888'>
  <font color=#447700>! ----------------------------------------------------------------- !<a name='4889'></font>
  <font color=#447700>! Function calculating saturation pressure ps (or pLCL) from qt and !<a name='4890'></font>
  <font color=#447700>! thl ( liquid potential temperature,  NOT liquid virtual potential ! <a name='4891'></font>
  <font color=#447700>! temperature) by inverting Bolton formula. I should check later if !<a name='4892'></font>
  <font color=#447700>! current use of 'leff' instead of 'xlv' here is reasonable or not. !<a name='4893'></font>
  <font color=#447700>! ----------------------------------------------------------------- !<a name='4894'></font>
    real(r8)          :: qsinvert    <a name='4895'>
    real(r8)             qt, thl, psfc<a name='4896'>
    real(r8)             ps, Pis, Ts, err, dlnqsdT, dTdPis<a name='4897'>
    real(r8)             dPisdps, dlnqsdps, derrdps, dps <a name='4898'>
    real(r8)             Ti, rhi, TLCL, PiLCL, psmin, dpsmax<a name='4899'>
    integer              i<a name='4900'>
    integer, external :: qsat<a name='4901'>
    real(r8)          :: es(1)                     <font color=#447700>! saturation vapor pressure<a name='4902'></font>
    real(r8)          :: qs(1)                     <font color=#447700>! saturation spec. humidity<a name='4903'></font>
    real(r8)          :: gam(1)                    <font color=#447700>! (L/cp)*dqs/dT<a name='4904'></font>
    integer           :: status                    <font color=#447700>! return status of qsat call<a name='4905'></font>
    real(r8)          :: leff, nu<a name='4906'>
<a name='4907'>
    psmin  = 100._r8*100._r8 <font color=#447700>! Default saturation pressure [Pa] if iteration does not converge<a name='4908'></font>
    dpsmax = 1._r8           <font color=#447700>! Tolerance [Pa] for convergence of iteration<a name='4909'></font>
<a name='4910'>
    <font color=#447700>! ------------------------------------ !<a name='4911'></font>
    <font color=#447700>! Calculate best initial guess of pLCL !<a name='4912'></font>
    <font color=#447700>! ------------------------------------ !<a name='4913'></font>
<a name='4914'>
    Ti       =  thl*(psfc/p00)**rovcp<a name='4915'>
    status   =  <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#QSAT'>qsat</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#QSINVERT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_28">(Ti,psfc,es(1),qs(1),gam(1),1)<a name='4916'>
    rhi      =  qt/qs(1)      <a name='4917'>
    if( rhi .le. 0.01_r8 ) then<a name='4918'>
        write(iulog,*) 'Source air is too dry and pLCL is set to psmin in uwshcu.F90' <a name='4919'>
#ifdef WRF_PORT<a name='4920'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#QSINVERT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1056">(iulog)<a name='4921'>
#endif<a name='4922'>
        qsinvert = psmin<a name='4923'>
        return<a name='4924'>
    end if<a name='4925'>
    TLCL     =  55._r8 + 1._r8/(1._r8/(Ti-55._r8)-log(rhi)/2840._r8); <font color=#447700>! Bolton's formula. MWR.1980.Eq.(22)<a name='4926'></font>
    PiLCL    =  TLCL/thl<a name='4927'>
    ps       =  p00*(PiLCL)**(1._r8/rovcp)<a name='4928'>
<a name='4929'>
    do i = 1, 10<a name='4930'>
       Pis      =  (ps/p00)**rovcp<a name='4931'>
       Ts       =  thl*Pis<a name='4932'>
       status   =  <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#QSAT'>qsat</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#QSINVERT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_29">(Ts,ps,es(1),qs(1),gam(1),1)<a name='4933'>
       err      =  qt - qs(1)<a name='4934'>
       nu       =  max(min((268._r8 - Ts)/20._r8,1.0_r8),0.0_r8)        <a name='4935'>
       leff     =  (1._r8 - nu)*xlv + nu*xls                   <a name='4936'>
       dlnqsdT  =  gam(1)*(cp/leff)/qs(1)<a name='4937'>
       dTdPis   =  thl<a name='4938'>
       dPisdps  =  rovcp*Pis/ps <a name='4939'>
       dlnqsdps = -1._r8/(ps - (1._r8 - ep2)*es(1))<a name='4940'>
       derrdps  = -qs(1)*(dlnqsdT * dTdPis * dPisdps + dlnqsdps)<a name='4941'>
       dps      = -err/derrdps<a name='4942'>
       ps       =  ps + dps<a name='4943'>
       if( ps .lt. 0._r8 ) then<a name='4944'>
           write(iulog,*) 'pLCL iteration is negative and set to psmin in uwshcu.F90', qt, thl, psfc <a name='4945'>
#ifdef WRF_PORT<a name='4946'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#QSINVERT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1057">(iulog)<a name='4947'>
#endif<a name='4948'>
           qsinvert = psmin<a name='4949'>
           return    <a name='4950'>
       end if<a name='4951'>
       if( abs(dps) .le. dpsmax ) then<a name='4952'>
           qsinvert = ps<a name='4953'>
           return<a name='4954'>
       end if<a name='4955'>
    end do<a name='4956'>
    write(iulog,*) 'pLCL does not converge and is set to psmin in uwshcu.F90', qt, thl, psfc <a name='4957'>
#ifdef WRF_PORT<a name='4958'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#QSINVERT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1058">(iulog)<a name='4959'>
#endif<a name='4960'>
    qsinvert = psmin<a name='4961'>
    return<a name='4962'>
  end function qsinvert<a name='4963'>
<a name='4964'>
<A NAME='COMPUTE_ALPHA'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_ALPHA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4965'>
  real(r8) <font color=#993300>function </font><font color=#cc0000>compute_alpha</font>(del_CIN,ke) <A href='../../call_to/COMPUTE_ALPHA.html' TARGET='index'>1</A><a name='4966'>
  <font color=#447700>! ------------------------------------------------ !<a name='4967'></font>
  <font color=#447700>! Subroutine to compute proportionality factor for !<a name='4968'></font>
  <font color=#447700>! implicit CIN calculation.                        !   <a name='4969'></font>
  <font color=#447700>! ------------------------------------------------ !<a name='4970'></font>
    real(r8) :: del_CIN, ke<a name='4971'>
    real(r8) :: x0, x1<a name='4972'>
<a name='4973'>
    integer  :: iteration<a name='4974'>
<a name='4975'>
    x0 = 0._r8<a name='4976'>
    do iteration = 1, 10<a name='4977'>
       x1 = x0 - (exp(-x0*ke*del_CIN) - x0)/(-ke*del_CIN*exp(-x0*ke*del_CIN) - 1._r8)<a name='4978'>
       x0 = x1<a name='4979'>
    end do<a name='4980'>
    compute_alpha = x0<a name='4981'>
<a name='4982'>
    return<a name='4983'>
<a name='4984'>
  end function compute_alpha<a name='4985'>
<a name='4986'>
<A NAME='COMPUTE_MUMIN2'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_MUMIN2' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4987'>
  real(r8) <font color=#993300>function </font><font color=#cc0000>compute_mumin2</font>(mulcl,rmaxfrac,mulow) <A href='../../call_to/COMPUTE_MUMIN2.html' TARGET='index'>1</A><a name='4988'>
  <font color=#447700>! --------------------------------------------------------- !<a name='4989'></font>
  <font color=#447700>! Subroutine to compute critical 'mu' (normalized CIN) such ! <a name='4990'></font>
  <font color=#447700>! that updraft fraction at the LCL is equal to 'rmaxfrac'.  !<a name='4991'></font>
  <font color=#447700>! --------------------------------------------------------- !  <a name='4992'></font>
    real(r8) :: mulcl, rmaxfrac, mulow<a name='4993'>
    real(r8) :: x0, x1, ex, ef, exf, f, fs<a name='4994'>
    integer  :: iteration<a name='4995'>
<a name='4996'>
    x0 = mulow<a name='4997'>
    do iteration = 1, 10<a name='4998'>
       ex = exp(-x0**2)<a name='4999'>
       ef = erfc(x0)<a name='5000'>
       <font color=#447700>! if(x0.ge.3._r8) then<a name='5001'></font>
       <font color=#447700>!    compute_mumin2 = 3._r8 <a name='5002'></font>
       <font color=#447700>!    goto 20<a name='5003'></font>
       <font color=#447700>! endif <a name='5004'></font>
       exf = ex/ef<a name='5005'>
       f  = 0.5_r8*exf**2 - 0.5_r8*(ex/2._r8/rmaxfrac)**2 - (mulcl*2.5066_r8/2._r8)**2<a name='5006'>
       fs = (2._r8*exf**2)*(exf/sqrt(3.141592_r8)-x0) + (0.5_r8*x0*ex**2)/(rmaxfrac**2)<a name='5007'>
       x1 = x0 - f/fs     <a name='5008'>
       x0 = x1<a name='5009'>
    end do<a name='5010'>
    compute_mumin2 = x0<a name='5011'>
<a name='5012'>
 20 return<a name='5013'>
<a name='5014'>
  end function compute_mumin2<a name='5015'>
<a name='5016'>
<A NAME='COMPUTE_PPEN'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_PPEN' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='5017'>
  real(r8) <font color=#993300>function </font><font color=#cc0000>compute_ppen</font>(wtwb,D,bogbot,bogtop,rho0j,dpen) <A href='../../call_to/COMPUTE_PPEN.html' TARGET='index'>1</A><a name='5018'>
  <font color=#447700>! ----------------------------------------------------------- !<a name='5019'></font>
  <font color=#447700>! Subroutine to compute critical 'ppen[Pa]&lt;0' ( pressure dis. !<a name='5020'></font>
  <font color=#447700>! from 'ps0(kpen-1)' to the cumulus top where cumulus updraft !<a name='5021'></font>
  <font color=#447700>! vertical velocity is exactly zero ) by considering exact    !<a name='5022'></font>
  <font color=#447700>! non-zero fer(kpen).                                         !  <a name='5023'></font>
  <font color=#447700>! ----------------------------------------------------------- !  <a name='5024'></font>
    real(r8) :: wtwb, D, bogbot, bogtop, rho0j, dpen<a name='5025'>
    real(r8) :: x0, x1, f, fs, SB, s00<a name='5026'>
    integer  :: iteration<a name='5027'>
<a name='5028'>
    <font color=#447700>! Buoyancy slope<a name='5029'></font>
      SB = ( bogtop - bogbot ) / dpen<a name='5030'>
    <font color=#447700>! Sign of slope, 'f' at x = 0<a name='5031'></font>
    <font color=#447700>! If 's00&gt;0', 'w' increases with height.<a name='5032'></font>
      s00 = bogbot / rho0j - D * wtwb<a name='5033'>
<a name='5034'>
    if( D*dpen .lt. 1.e-8 ) then<a name='5035'>
        if( s00 .ge. 0._r8 ) then<a name='5036'>
            x0 = dpen       <a name='5037'>
        else<a name='5038'>
            x0 = max(0._r8,min(dpen,-0.5_r8*wtwb/s00))<a name='5039'>
        endif<a name='5040'>
    else<a name='5041'>
        if( s00 .ge. 0._r8 ) then<a name='5042'>
            x0 = dpen<a name='5043'>
        else <a name='5044'>
            x0 = 0._r8<a name='5045'>
        endif<a name='5046'>
        do iteration = 1, 5<a name='5047'>
           f  = exp(-2._r8*D*x0)*(wtwb-(bogbot-SB/(2._r8*D))/(D*rho0j)) + &amp;<a name='5048'>
                                 (SB*x0+bogbot-SB/(2._r8*D))/(D*rho0j)<a name='5049'>
           fs = -2._r8*D*exp(-2._r8*D*x0)*(wtwb-(bogbot-SB/(2._r8*D))/(D*rho0j)) + &amp;<a name='5050'>
                                 (SB)/(D*rho0j)<a name='5051'>
           if( fs .ge. 0._r8 ) then<a name='5052'>
		fs = max(fs, 1.e-10_r8)<a name='5053'>
           else<a name='5054'>
           	fs = min(fs,-1.e-10_r8)<a name='5055'>
           endif<a name='5056'>
           x1 = x0 - f/fs     <a name='5057'>
           x0 = x1<a name='5058'>
      end do<a name='5059'>
<a name='5060'>
    endif    <a name='5061'>
<a name='5062'>
    compute_ppen = -max(0._r8,min(dpen,x0))<a name='5063'>
<a name='5064'>
  end function compute_ppen<a name='5065'>
<a name='5066'>
<A NAME='FLUXBELOWINV'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FLUXBELOWINV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5067'>
  <font color=#993300>subroutine </font><font color=#cc0000>fluxbelowinv</font>(cbmf,ps0,mkx,kinv,dt,xsrc,xmean,xtopin,xbotin,xflx)    <A href='../../call_to/FLUXBELOWINV.html' TARGET='index'>5</A><a name='5068'>
  <font color=#447700>! ------------------------------------------------------------------------- !<a name='5069'></font>
  <font color=#447700>! Subroutine to calculate turbulent fluxes at and below 'kinv-1' interfaces.!<a name='5070'></font>
  <font color=#447700>! Check in the main program such that input 'cbmf' should not be zero.      !  <a name='5071'></font>
  <font color=#447700>! If the reconstructed inversion height does not go down below the 'kinv-1' !<a name='5072'></font>
  <font color=#447700>! interface, then turbulent flux at 'kinv-1' interface  is simply a product !<a name='5073'></font>
  <font color=#447700>! of 'cmbf' and 'qtsrc-xbot' where 'xbot' is the value at the top interface !<a name='5074'></font>
  <font color=#447700>! of 'kinv-1' layer. This flux is linearly interpolated down to the surface !<a name='5075'></font>
  <font color=#447700>! assuming turbulent fluxes at surface are zero. If reconstructed inversion !<a name='5076'></font>
  <font color=#447700>! height goes down below the 'kinv-1' interface, subsidence warming &amp;drying !<a name='5077'></font>
  <font color=#447700>! measured by 'xtop-xbot', where  'xtop' is the value at the base interface !<a name='5078'></font>
  <font color=#447700>! of 'kinv+1' layer, is added ONLY to the 'kinv-1' layer, using appropriate !<a name='5079'></font>
  <font color=#447700>! mass weighting ( rpinv and rcbmf, or rr = rpinv / rcbmf ) between current !<a name='5080'></font>
  <font color=#447700>! and next provisional time step. Also impose a limiter to enforce outliers !<a name='5081'></font>
  <font color=#447700>! of thermodynamic variables in 'kinv' layer  to come back to normal values !<a name='5082'></font>
  <font color=#447700>! at the next step.                                                         !<a name='5083'></font>
  <font color=#447700>! ------------------------------------------------------------------------- !            <a name='5084'></font>
    integer,  intent(in)                     :: mkx, kinv <a name='5085'>
    real(r8), intent(in)                     :: cbmf, dt, xsrc, xmean, xtopin, xbotin<a name='5086'>
    real(r8), intent(in),  dimension(0:mkx)  :: ps0<a name='5087'>
    real(r8), intent(out), dimension(0:mkx)  :: xflx  <a name='5088'>
    integer k<a name='5089'>
    real(r8) rcbmf, rpeff, dp, rr, pinv_eff, xtop, xbot, pinv, xtop_ori, xbot_ori<a name='5090'>
<a name='5091'>
    xflx(0:mkx) = 0._r8<a name='5092'>
    dp = ps0(kinv-1) - ps0(kinv) <a name='5093'>
#ifndef WRF_PORT    <a name='5094'>
    if( abs(xbotin-xtopin) .le. 1.e-13_r8 ) then<a name='5095'>
        xbot = xbotin - 1.e-13_r8<a name='5096'>
        xtop = xtopin + 1.e-13_r8<a name='5097'>
    else<a name='5098'>
        xbot = xbotin<a name='5099'>
        xtop = xtopin<a name='5100'>
    endif<a name='5101'>
#else<a name='5102'>
    xbot = xbotin<a name='5103'>
    xtop = xtopin<a name='5104'>
#endif<a name='5105'>
    <font color=#447700>! -------------------------------------- !<a name='5106'></font>
    <font color=#447700>! Compute reconstructed inversion height !<a name='5107'></font>
    <font color=#447700>! -------------------------------------- !<a name='5108'></font>
    xtop_ori = xtop<a name='5109'>
    xbot_ori = xbot<a name='5110'>
    rcbmf = ( cbmf * g * dt ) / dp                  <font color=#447700>! Can be larger than 1 : 'OK'      <a name='5111'></font>
#ifndef WRF_PORT<a name='5112'>
    rpeff = ( xmean - xtop ) / ( xbot - xtop ) <a name='5113'>
#else<a name='5114'>
    rpeff = ( xmean - xtop ) / max(1.e-13_r8, (xbot - xtop) ) <a name='5115'>
    rpeff = abs(rpeff)<a name='5116'>
#endif<a name='5117'>
    rpeff = min( max(0._r8,rpeff), 1._r8 )          <font color=#447700>! As of this, 0&lt;= rpeff &lt;= 1   <a name='5118'></font>
    if( rpeff .eq. 0._r8 .or. rpeff .eq. 1._r8 ) then<a name='5119'>
        xbot = xmean<a name='5120'>
        xtop = xmean<a name='5121'>
    endif<a name='5122'>
    <font color=#447700>! Below two commented-out lines are the old code replacing the above 'if' block.   <a name='5123'></font>
    <font color=#447700>! if(rpeff.eq.1) xbot = xmean<a name='5124'></font>
    <font color=#447700>! if(rpeff.eq.0) xtop = xmean    <a name='5125'></font>
    rr       = rpeff / rcbmf<a name='5126'>
    pinv     = ps0(kinv-1) - rpeff * dp             <font color=#447700>! "pinv" before detraining mass<a name='5127'></font>
    pinv_eff = ps0(kinv-1) + ( rcbmf - rpeff ) * dp <font color=#447700>! Effective "pinv" after detraining mass<a name='5128'></font>
    <font color=#447700>! ----------------------------------------------------------------------- !<a name='5129'></font>
    <font color=#447700>! Compute turbulent fluxes.                                               !<a name='5130'></font>
    <font color=#447700>! Below two cases exactly converges at 'kinv-1' interface when rr = 1._r8 !<a name='5131'></font>
    <font color=#447700>! ----------------------------------------------------------------------- !<a name='5132'></font>
    do k = 0, kinv - 1<a name='5133'>
       xflx(k) = cbmf * ( xsrc - xbot ) * ( ps0(0) - ps0(k) ) / ( ps0(0) - pinv )<a name='5134'>
    end do<a name='5135'>
    if( rr .le. 1._r8 ) then<a name='5136'>
        xflx(kinv-1) =  xflx(kinv-1) - ( 1._r8 - rr ) * cbmf * ( xtop_ori - xbot_ori )<a name='5137'>
    endif<a name='5138'>
<a name='5139'>
    return<a name='5140'>
  end subroutine fluxbelowinv<a name='5141'>
<a name='5142'>
<A NAME='POSITIVE_MOISTURE_SINGLE'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#POSITIVE_MOISTURE_SINGLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5143'>
  <font color=#993300>subroutine </font><font color=#cc0000>positive_moisture_single</font>( xlv, xls, mkx, dt, qvmin, qlmin, qimin, dp, qv, ql, qi, s, qvten, qlten, qiten, sten ) <A href='../../call_to/POSITIVE_MOISTURE_SINGLE.html' TARGET='index'>1</A>,<A href='../../call_from/POSITIVE_MOISTURE_SINGLE.html' TARGET='index'>1</A><a name='5144'>
  <font color=#447700>! ------------------------------------------------------------------------------- !<a name='5145'></font>
  <font color=#447700>! If any 'ql &lt; qlmin, qi &lt; qimin, qv &lt; qvmin' are developed in any layer,         !<a name='5146'></font>
  <font color=#447700>! force them to be larger than minimum value by (1) condensating water vapor      !<a name='5147'></font>
  <font color=#447700>! into liquid or ice, and (2) by transporting water vapor from the very lower     !<a name='5148'></font>
  <font color=#447700>! layer. '2._r8' is multiplied to the minimum values for safety.                  !<a name='5149'></font>
  <font color=#447700>! Update final state variables and tendencies associated with this correction.    !<a name='5150'></font>
  <font color=#447700>! If any condensation happens, update (s,t) too.                                  !<a name='5151'></font>
  <font color=#447700>! Note that (qv,ql,qi,s) are final state variables after applying corresponding   !<a name='5152'></font>
  <font color=#447700>! input tendencies and corrective tendencies                                      !<a name='5153'></font>
  <font color=#447700>! ------------------------------------------------------------------------------- !<a name='5154'></font>
    implicit none<a name='5155'>
    integer,  intent(in)     :: mkx<a name='5156'>
    real(r8), intent(in)     :: xlv, xls<a name='5157'>
    real(r8), intent(in)     :: dt, qvmin, qlmin, qimin<a name='5158'>
    real(r8), intent(in)     :: dp(mkx)<a name='5159'>
    real(r8), intent(inout)  :: qv(mkx), ql(mkx), qi(mkx), s(mkx)<a name='5160'>
    real(r8), intent(inout)  :: qvten(mkx), qlten(mkx), qiten(mkx), sten(mkx)<a name='5161'>
    integer   k<a name='5162'>
    real(r8)  dql, dqi, dqv, sum, aa, dum <a name='5163'>
<a name='5164'>
    do k = mkx, 1, -1        <font color=#447700>! From the top to the 1st (lowest) layer from the surface<a name='5165'></font>
       dql = max(0._r8,1._r8*qlmin-ql(k))<a name='5166'>
       dqi = max(0._r8,1._r8*qimin-qi(k))<a name='5167'>
       qlten(k) = qlten(k) +  dql/dt<a name='5168'>
       qiten(k) = qiten(k) +  dqi/dt<a name='5169'>
       qvten(k) = qvten(k) - (dql+dqi)/dt<a name='5170'>
       sten(k)  = sten(k)  + xlv * (dql/dt) + xls * (dqi/dt)<a name='5171'>
       ql(k)    = ql(k) +  dql<a name='5172'>
       qi(k)    = qi(k) +  dqi<a name='5173'>
       qv(k)    = qv(k) -  dql - dqi<a name='5174'>
       s(k)     = s(k)  +  xlv * dql + xls * dqi<a name='5175'>
       dqv      = max(0._r8,1._r8*qvmin-qv(k))<a name='5176'>
       qvten(k) = qvten(k) + dqv/dt<a name='5177'>
       qv(k)    = qv(k)   + dqv<a name='5178'>
       if( k .ne. 1 ) then <a name='5179'>
           qv(k-1)    = qv(k-1)    - dqv*dp(k)/dp(k-1)<a name='5180'>
           qvten(k-1) = qvten(k-1) - dqv*dp(k)/dp(k-1)/dt<a name='5181'>
       endif<a name='5182'>
       qv(k) = max(qv(k),qvmin)<a name='5183'>
       ql(k) = max(ql(k),qlmin)<a name='5184'>
       qi(k) = max(qi(k),qimin)<a name='5185'>
    end do<a name='5186'>
    <font color=#447700>! Extra moisture used to satisfy 'qv(i,1)=qvmin' is proportionally <a name='5187'></font>
    <font color=#447700>! extracted from all the layers that has 'qv &gt; 2*qvmin'. This fully<a name='5188'></font>
    <font color=#447700>! preserves column moisture. <a name='5189'></font>
    if( dqv .gt. 1.e-20_r8 ) then<a name='5190'>
        sum = 0._r8<a name='5191'>
        do k = 1, mkx<a name='5192'>
           if( qv(k) .gt. 2._r8*qvmin ) sum = sum + qv(k)*dp(k)<a name='5193'>
        enddo<a name='5194'>
        aa = dqv*dp(1)/max(1.e-20_r8,sum)<a name='5195'>
        if( aa .lt. 0.5_r8 ) then<a name='5196'>
            do k = 1, mkx<a name='5197'>
               if( qv(k) .gt. 2._r8*qvmin ) then<a name='5198'>
                   dum      = aa*qv(k)<a name='5199'>
                   qv(k)    = qv(k) - dum<a name='5200'>
                   qvten(k) = qvten(k) - dum/dt<a name='5201'>
               endif<a name='5202'>
            enddo <a name='5203'>
        else <a name='5204'>
            write(iulog,*) 'Full positive_moisture is impossible in uwshcu'<a name='5205'>
#ifdef WRF_PORT<a name='5206'>
            call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#POSITIVE_MOISTURE_SINGLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1059">(iulog)<a name='5207'>
#endif<a name='5208'>
        endif<a name='5209'>
    endif <a name='5210'>
<a name='5211'>
    return<a name='5212'>
  end subroutine positive_moisture_single<a name='5213'>
<a name='5214'>
<A NAME='FINDSP'><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5215'>
  <font color=#993300>subroutine </font><font color=#cc0000>findsp</font> (lchnk, ncol, q, t, p, tsp, qsp) <A href='../../call_to/FINDSP.html' TARGET='index'>2</A>,<A href='../../call_from/FINDSP.html' TARGET='index'>35</A><a name='5216'>
<a name='5217'>
  <font color=#447700>!----------------------------------------------------------------------- <a name='5218'></font>
  <font color=#447700>! <a name='5219'></font>
  <font color=#447700>! Purpose: <a name='5220'></font>
  <font color=#447700>!     find the wet bulb temperature for a given t and q<a name='5221'></font>
  <font color=#447700>!     in a longitude height section<a name='5222'></font>
  <font color=#447700>!     wet bulb temp is the temperature and spec humidity that is <a name='5223'></font>
  <font color=#447700>!     just saturated and has the same enthalpy<a name='5224'></font>
  <font color=#447700>!     if q &gt; qs(t) then tsp &gt; t and qsp = qs(tsp) &lt; q<a name='5225'></font>
  <font color=#447700>!     if q &lt; qs(t) then tsp &lt; t and qsp = qs(tsp) &gt; q<a name='5226'></font>
  <font color=#447700>!<a name='5227'></font>
  <font color=#447700>! Method: <a name='5228'></font>
  <font color=#447700>! a Newton method is used<a name='5229'></font>
  <font color=#447700>! first guess uses an algorithm provided by John Petch from the UKMO<a name='5230'></font>
  <font color=#447700>! we exclude points where the physical situation is unrealistic<a name='5231'></font>
  <font color=#447700>! e.g. where the temperature is outside the range of validity for the<a name='5232'></font>
  <font color=#447700>!      saturation vapor pressure, or where the water vapor pressure<a name='5233'></font>
  <font color=#447700>!      exceeds the ambient pressure, or the saturation specific humidity is <a name='5234'></font>
  <font color=#447700>!      unrealistic<a name='5235'></font>
  <font color=#447700>! <a name='5236'></font>
  <font color=#447700>! Author: P. Rasch<a name='5237'></font>
  <font color=#447700>! <a name='5238'></font>
  <font color=#447700>!-----------------------------------------------------------------------<a name='5239'></font>
<a name='5240'>
  use <A href='../../html_code/phys/module_cam_wv_saturation.F.html#WV_SATURATION'>wv_saturation</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WV_SATURATION_18">, only: estblf, hlatv, tmin, hlatf, rgasv, pcf, &amp;<a name='5241'>
                           cp, epsqs, ttrice<a name='5242'>
<a name='5243'>
  <font color=#447700>!<a name='5244'></font>
  <font color=#447700>!     input arguments<a name='5245'></font>
  <font color=#447700>!<a name='5246'></font>
   integer, intent(in) :: lchnk                 <font color=#447700>! chunk identifier<a name='5247'></font>
   integer, intent(in) :: ncol                  <font color=#447700>! number of atmospheric columns<a name='5248'></font>
<a name='5249'>
   real(r8), intent(in) :: q(pcols,pver)        <font color=#447700>! water vapor (kg/kg)<a name='5250'></font>
   real(r8), intent(in) :: t(pcols,pver)        <font color=#447700>! temperature (K)<a name='5251'></font>
   real(r8), intent(in) :: p(pcols,pver)        <font color=#447700>! pressure    (Pa)<a name='5252'></font>
<font color=#447700>!<a name='5253'></font>
<font color=#447700>! output arguments<a name='5254'></font>
<font color=#447700>!<a name='5255'></font>
   real(r8), intent(out) :: tsp(pcols,pver)      <font color=#447700>! saturation temp (K)<a name='5256'></font>
   real(r8), intent(out) :: qsp(pcols,pver)      <font color=#447700>! saturation mixing ratio (kg/kg)<a name='5257'></font>
<font color=#447700>!<a name='5258'></font>
<font color=#447700>! local variables<a name='5259'></font>
<font color=#447700>!<a name='5260'></font>
   integer i                 <font color=#447700>! work variable<a name='5261'></font>
   integer k                 <font color=#447700>! work variable<a name='5262'></font>
   logical lflg              <font color=#447700>! work variable<a name='5263'></font>
   integer iter              <font color=#447700>! work variable<a name='5264'></font>
   integer l                 <font color=#447700>! work variable<a name='5265'></font>
   logical :: error_found<a name='5266'>
<a name='5267'>
   real(r8) omeps                <font color=#447700>! 1 minus epsilon<a name='5268'></font>
   real(r8) trinv                <font color=#447700>! work variable<a name='5269'></font>
   real(r8) es                   <font color=#447700>! sat. vapor pressure<a name='5270'></font>
   real(r8) desdt                <font color=#447700>! change in sat vap pressure wrt temperature<a name='5271'></font>
<font color=#447700>!     real(r8) desdp                ! change in sat vap pressure wrt pressure<a name='5272'></font>
   real(r8) dqsdt                <font color=#447700>! change in sat spec. hum. wrt temperature<a name='5273'></font>
   real(r8) dgdt                 <font color=#447700>! work variable<a name='5274'></font>
   real(r8) g                    <font color=#447700>! work variable<a name='5275'></font>
   real(r8) weight(pcols)        <font color=#447700>! work variable<a name='5276'></font>
   real(r8) hlatsb               <font color=#447700>! (sublimation)<a name='5277'></font>
   real(r8) hlatvp               <font color=#447700>! (vaporization)<a name='5278'></font>
   real(r8) hltalt(pcols,pver)   <font color=#447700>! lat. heat. of vap.<a name='5279'></font>
   real(r8) tterm                <font color=#447700>! work var.<a name='5280'></font>
   real(r8) qs                   <font color=#447700>! spec. hum. of water vapor<a name='5281'></font>
   real(r8) tc                   <font color=#447700>! crit temp of transition to ice<a name='5282'></font>
   real(r8) tt0 <a name='5283'>
<a name='5284'>
<font color=#447700>! work variables<a name='5285'></font>
   real(r8) t1, q1, dt, dq<a name='5286'>
   real(r8) dtm, dqm<a name='5287'>
   real(r8) qvd, a1, tmp<a name='5288'>
   real(r8) rair<a name='5289'>
   real(r8) r1b, c1, c2, c3<a name='5290'>
   real(r8) denom<a name='5291'>
   real(r8) dttol<a name='5292'>
   real(r8) dqtol<a name='5293'>
   integer doit(pcols) <a name='5294'>
   real(r8) enin(pcols), enout(pcols)<a name='5295'>
   real(r8) tlim(pcols)<a name='5296'>
<a name='5297'>
   omeps = 1.0_r8 - epsqs<a name='5298'>
   trinv = 1.0_r8/ttrice<a name='5299'>
   a1 = 7.5_r8*log(10._r8)<a name='5300'>
   rair =  287.04_r8<a name='5301'>
   c3 = rair*a1/cp<a name='5302'>
   dtm = 0._r8    <font color=#447700>! needed for iter=0 blowup with f90 -ei<a name='5303'></font>
   dqm = 0._r8    <font color=#447700>! needed for iter=0 blowup with f90 -ei<a name='5304'></font>
   dttol = 1.e-4_r8 <font color=#447700>! the relative temp error tolerance required to quit the iteration<a name='5305'></font>
   dqtol = 1.e-4_r8 <font color=#447700>! the relative moisture error tolerance required to quit the iteration<a name='5306'></font>
   tt0 = 273.15_r8  <font color=#447700>! Freezing temperature <a name='5307'></font>
<font color=#447700>!  tmin = 173.16 ! the coldest temperature we can deal with<a name='5308'></font>
<font color=#447700>!<a name='5309'></font>
<font color=#447700>! max number of times to iterate the calculation<a name='5310'></font>
   iter = 8<a name='5311'>
<font color=#447700>!<a name='5312'></font>
   do k = 1,pver<a name='5313'>
<a name='5314'>
<font color=#447700>!<a name='5315'></font>
<font color=#447700>! first guess on the wet bulb temperature<a name='5316'></font>
<font color=#447700>!<a name='5317'></font>
      do i = 1,ncol<a name='5318'>
<a name='5319'>
#ifdef DEBUG<a name='5320'>
         if ( (lchnk == lchnklook(nlook) ) .and. (i == icollook(nlook) ) ) then<a name='5321'>
            write(iulog,*) ' '<a name='5322'>
#ifdef WRF_PORT<a name='5323'>
            call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1060">(iulog)<a name='5324'>
#endif<a name='5325'>
            write(iulog,*) ' level, t, q, p', k, t(i,k), q(i,k), p(i,k)<a name='5326'>
#ifdef WRF_PORT<a name='5327'>
            call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1061">(iulog)<a name='5328'>
#endif<a name='5329'>
         endif<a name='5330'>
#endif<a name='5331'>
<font color=#447700>! limit the temperature range to that relevant to the sat vap pres tables<a name='5332'></font>
#if ( <font color=#447700>! defined WACCM_MOZART )<a name='5333'></font>
         tlim(i) = min(max(t(i,k),173._r8),373._r8)<a name='5334'>
#else<a name='5335'>
         tlim(i) = min(max(t(i,k),128._r8),373._r8)<a name='5336'>
#endif<a name='5337'>
         es = <A href='../../html_code/phys/module_ra_cam_support.F.html#ESTBLF'>estblf</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESTBLF_15">(tlim(i))<a name='5338'>
         denom = p(i,k) - omeps*es<a name='5339'>
         qs = epsqs*es/denom<a name='5340'>
         doit(i) = 0<a name='5341'>
         enout(i) = 1._r8<a name='5342'>
<font color=#447700>! make sure a meaningful calculation is possible<a name='5343'></font>
         if (p(i,k) &gt; 5._r8*es .and. qs &gt; 0._r8 .and. qs &lt; 0.5_r8) then<a name='5344'>
<font color=#447700>!<a name='5345'></font>
<font color=#447700>! Saturation specific humidity<a name='5346'></font>
<font color=#447700>!<a name='5347'></font>
             qs = min(epsqs*es/denom,1._r8)<a name='5348'>
<font color=#447700>!<a name='5349'></font>
<font color=#447700>! "generalized" analytic expression for t derivative of es<a name='5350'></font>
<font color=#447700>!  accurate to within 1 percent for 173.16 &lt; t &lt; 373.16<a name='5351'></font>
<font color=#447700>!<a name='5352'></font>
<font color=#447700>! Weighting of hlat accounts for transition from water to ice<a name='5353'></font>
<font color=#447700>! polynomial expression approximates difference between es over<a name='5354'></font>
<font color=#447700>! water and es over ice from 0 to -ttrice (C) (min of ttrice is<a name='5355'></font>
<font color=#447700>! -40): required for accurate estimate of es derivative in transition<a name='5356'></font>
<font color=#447700>! range from ice to water also accounting for change of hlatv with t<a name='5357'></font>
<font color=#447700>! above freezing where const slope is given by -2369 j/(kg c) = cpv - cw<a name='5358'></font>
<font color=#447700>!<a name='5359'></font>
             tc     = tlim(i) - tt0<a name='5360'>
             lflg   = (tc &gt;= -ttrice .and. tc &lt; 0.0_r8)<a name='5361'>
             weight(i) = min(-tc*trinv,1.0_r8)<a name='5362'>
             hlatsb = hlatv + weight(i)*hlatf<a name='5363'>
             hlatvp = hlatv - 2369.0_r8*tc<a name='5364'>
             if (tlim(i) &lt; tt0) then<a name='5365'>
                hltalt(i,k) = hlatsb<a name='5366'>
             else<a name='5367'>
                hltalt(i,k) = hlatvp<a name='5368'>
             end if<a name='5369'>
             enin(i) = cp*tlim(i) + hltalt(i,k)*q(i,k)<a name='5370'>
<a name='5371'>
<font color=#447700>! make a guess at the wet bulb temp using a UKMO algorithm (from J. Petch)<a name='5372'></font>
             tmp =  q(i,k) - qs<a name='5373'>
             c1 = hltalt(i,k)*c3<a name='5374'>
             c2 = (tlim(i) + 36._r8)**2<a name='5375'>
             r1b    = c2/(c2 + c1*qs)<a name='5376'>
             qvd   = r1b*tmp<a name='5377'>
             tsp(i,k) = tlim(i) + ((hltalt(i,k)/cp)*qvd)<a name='5378'>
#ifdef DEBUG<a name='5379'>
             if ( (lchnk == lchnklook(nlook) ) .and. (i == icollook(nlook) ) ) then<a name='5380'>
                write(iulog,*) ' relative humidity ', q(i,k)/qs<a name='5381'>
#ifdef WRF_PORT<a name='5382'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1062">(iulog)<a name='5383'>
#endif<a name='5384'>
                write(iulog,*) ' first guess ', tsp(i,k)<a name='5385'>
#ifdef WRF_PORT<a name='5386'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1063">(iulog)<a name='5387'>
#endif<a name='5388'>
             endif<a name='5389'>
#endif<a name='5390'>
             es = <A href='../../html_code/phys/module_ra_cam_support.F.html#ESTBLF'>estblf</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESTBLF_16">(tsp(i,k))<a name='5391'>
             qsp(i,k) = min(epsqs*es/(p(i,k) - omeps*es),1._r8)<a name='5392'>
          else<a name='5393'>
             doit(i) = 1<a name='5394'>
             tsp(i,k) = tlim(i)<a name='5395'>
             qsp(i,k) = q(i,k)<a name='5396'>
             enin(i) = 1._r8<a name='5397'>
          endif<a name='5398'>
       end do   <font color=#447700>! end do i<a name='5399'></font>
<font color=#447700>!<a name='5400'></font>
<font color=#447700>! now iterate on first guess<a name='5401'></font>
<font color=#447700>!<a name='5402'></font>
      do l = 1, iter<a name='5403'>
         dtm = 0<a name='5404'>
         dqm = 0<a name='5405'>
         do i = 1,ncol<a name='5406'>
            if (doit(i) == 0) then<a name='5407'>
               es = <A href='../../html_code/phys/module_ra_cam_support.F.html#ESTBLF'>estblf</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESTBLF_17">(tsp(i,k))<a name='5408'>
<font color=#447700>!<a name='5409'></font>
<font color=#447700>! Saturation specific humidity<a name='5410'></font>
<font color=#447700>!<a name='5411'></font>
               qs = min(epsqs*es/(p(i,k) - omeps*es),1._r8)<a name='5412'>
<font color=#447700>!<a name='5413'></font>
<font color=#447700>! "generalized" analytic expression for t derivative of es<a name='5414'></font>
<font color=#447700>! accurate to within 1 percent for 173.16 &lt; t &lt; 373.16<a name='5415'></font>
<font color=#447700>!<a name='5416'></font>
<font color=#447700>! Weighting of hlat accounts for transition from water to ice<a name='5417'></font>
<font color=#447700>! polynomial expression approximates difference between es over<a name='5418'></font>
<font color=#447700>! water and es over ice from 0 to -ttrice (C) (min of ttrice is<a name='5419'></font>
<font color=#447700>! -40): required for accurate estimate of es derivative in transition<a name='5420'></font>
<font color=#447700>! range from ice to water also accounting for change of hlatv with t<a name='5421'></font>
<font color=#447700>! above freezing where const slope is given by -2369 j/(kg c) = cpv - cw<a name='5422'></font>
<font color=#447700>!<a name='5423'></font>
               tc     = tsp(i,k) - tt0<a name='5424'>
               lflg   = (tc &gt;= -ttrice .and. tc &lt; 0.0_r8)<a name='5425'>
               weight(i) = min(-tc*trinv,1.0_r8)<a name='5426'>
               hlatsb = hlatv + weight(i)*hlatf<a name='5427'>
               hlatvp = hlatv - 2369.0_r8*tc<a name='5428'>
               if (tsp(i,k) &lt; tt0) then<a name='5429'>
                  hltalt(i,k) = hlatsb<a name='5430'>
               else<a name='5431'>
                  hltalt(i,k) = hlatvp<a name='5432'>
               end if<a name='5433'>
               if (lflg) then<a name='5434'>
                  tterm = pcf(1) + tc*(pcf(2) + tc*(pcf(3)+tc*(pcf(4) + tc*pcf(5))))<a name='5435'>
               else<a name='5436'>
                  tterm = 0.0_r8<a name='5437'>
               end if<a name='5438'>
               desdt = hltalt(i,k)*es/(rgasv*tsp(i,k)*tsp(i,k)) + tterm*trinv<a name='5439'>
               dqsdt = (epsqs + omeps*qs)/(p(i,k) - omeps*es)*desdt<a name='5440'>
<font color=#447700>!              g = cp*(tlim(i)-tsp(i,k)) + hltalt(i,k)*q(i,k)- hltalt(i,k)*qsp(i,k)<a name='5441'></font>
               g = enin(i) - (cp*tsp(i,k) + hltalt(i,k)*qsp(i,k))<a name='5442'>
               dgdt = -(cp + hltalt(i,k)*dqsdt)<a name='5443'>
               t1 = tsp(i,k) - g/dgdt<a name='5444'>
               dt = abs(t1 - tsp(i,k))/t1<a name='5445'>
               tsp(i,k) = max(t1,tmin)<a name='5446'>
               es = <A href='../../html_code/phys/module_ra_cam_support.F.html#ESTBLF'>estblf</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESTBLF_18">(tsp(i,k))<a name='5447'>
               q1 = min(epsqs*es/(p(i,k) - omeps*es),1._r8)<a name='5448'>
               dq = abs(q1 - qsp(i,k))/max(q1,1.e-12_r8)<a name='5449'>
               qsp(i,k) = q1<a name='5450'>
#ifdef DEBUG<a name='5451'>
               if ( (lchnk == lchnklook(nlook) ) .and. (i == icollook(nlook) ) ) then<a name='5452'>
                  write(iulog,*) ' rel chg lev, iter, t, q ', k, l, dt, dq, g<a name='5453'>
#ifdef WRF_PORT<a name='5454'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1064">(iulog)<a name='5455'>
#endif<a name='5456'>
               endif<a name='5457'>
#endif<a name='5458'>
               dtm = max(dtm,dt)<a name='5459'>
               dqm = max(dqm,dq)<a name='5460'>
<font color=#447700>! if converged at this point, exclude it from more iterations<a name='5461'></font>
               if (dt &lt; dttol .and. dq &lt; dqtol) then<a name='5462'>
                  doit(i) = 2<a name='5463'>
               endif<a name='5464'>
               enout(i) = cp*tsp(i,k) + hltalt(i,k)*qsp(i,k)<a name='5465'>
<font color=#447700>! bail out if we are too near the end of temp range<a name='5466'></font>
#if ( <font color=#447700>! defined WACCM_MOZART )<a name='5467'></font>
               if (tsp(i,k) &lt; 174.16_r8) then<a name='5468'>
#else<a name='5469'>
               if (tsp(i,k) &lt; 130.16_r8) then<a name='5470'>
#endif<a name='5471'>
                  doit(i) = 4<a name='5472'>
               endif<a name='5473'>
            else<a name='5474'>
            endif<a name='5475'>
         end do              <font color=#447700>! do i = 1,ncol<a name='5476'></font>
<a name='5477'>
         if (dtm &lt; dttol .and. dqm &lt; dqtol) then<a name='5478'>
            go to 10<a name='5479'>
         endif<a name='5480'>
<a name='5481'>
      end do                 <font color=#447700>! do l = 1,iter<a name='5482'></font>
10    continue<a name='5483'>
<a name='5484'>
      error_found = .false.<a name='5485'>
      if (dtm &gt; dttol .or. dqm &gt; dqtol) then<a name='5486'>
         do i = 1,ncol<a name='5487'>
            if (doit(i) == 0) error_found = .true.<a name='5488'>
         end do<a name='5489'>
         if (error_found) then<a name='5490'>
            do i = 1,ncol<a name='5491'>
               if (doit(i) == 0) then<a name='5492'>
                  write(iulog,*) ' findsp not converging at point i, k ', i, k<a name='5493'>
#ifdef WRF_PORT<a name='5494'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1065">(iulog)<a name='5495'>
#endif<a name='5496'>
                  write(iulog,*) ' t, q, p, enin ', t(i,k), q(i,k), p(i,k), enin(i)<a name='5497'>
#ifdef WRF_PORT<a name='5498'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1066">(iulog)<a name='5499'>
#endif<a name='5500'>
                  write(iulog,*) ' tsp, qsp, enout ', tsp(i,k), qsp(i,k), enout(i)<a name='5501'>
#ifdef WRF_PORT<a name='5502'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1067">(iulog)<a name='5503'>
#endif<a name='5504'>
                  call <A href='../../html_code/phys/module_sf_clm.F.html#ENDRUN'>endrun</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENDRUN_160"> ('FINDSP')<a name='5505'>
               endif<a name='5506'>
            end do<a name='5507'>
         endif<a name='5508'>
      endif<a name='5509'>
      do i = 1,ncol<a name='5510'>
         if (doit(i) == 2 .and. abs((enin(i)-enout(i))/(enin(i)+enout(i))) &gt; 1.e-4_r8) then<a name='5511'>
            error_found = .true.<a name='5512'>
         endif<a name='5513'>
      end do<a name='5514'>
      if (error_found) then<a name='5515'>
         do i = 1,ncol<a name='5516'>
            if (doit(i) == 2 .and. abs((enin(i)-enout(i))/(enin(i)+enout(i))) &gt; 1.e-4_r8) then<a name='5517'>
               write(iulog,*) ' the enthalpy is not conserved for point ', &amp;<a name='5518'>
                  i, k, enin(i), enout(i)<a name='5519'>
#ifdef WRF_PORT<a name='5520'>
               call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1068">(iulog)<a name='5521'>
#endif<a name='5522'>
               write(iulog,*) ' t, q, p, enin ', t(i,k), q(i,k), p(i,k), enin(i)<a name='5523'>
#ifdef WRF_PORT<a name='5524'>
               call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1069">(iulog)<a name='5525'>
#endif<a name='5526'>
               write(iulog,*) ' tsp, qsp, enout ', tsp(i,k), qsp(i,k), enout(i)<a name='5527'>
#ifdef WRF_PORT<a name='5528'>
               call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1070">(iulog)<a name='5529'>
#endif<a name='5530'>
               call <A href='../../html_code/phys/module_sf_clm.F.html#ENDRUN'>endrun</A><A href='../../html_code/phys/module_shcu_camuwshcu.F.html#FINDSP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENDRUN_161"> ('FINDSP')<a name='5531'>
            endif<a name='5532'>
         end do<a name='5533'>
      endif<a name='5534'>
      <a name='5535'>
   end do                    <font color=#447700>! level loop (k=1,pver)<a name='5536'></font>
<a name='5537'>
   return<a name='5538'>
   end subroutine findsp<a name='5539'>
<a name='5540'>
  <font color=#447700>! ------------------------ !<a name='5541'></font>
  <font color=#447700>!                          ! <a name='5542'></font>
  <font color=#447700>! End of subroutine blocks !<a name='5543'></font>
  <font color=#447700>!                          !<a name='5544'></font>
  <font color=#447700>! ------------------------ !<a name='5545'></font>
<a name='5546'>
  end module uwshcu<a name='5547'>
<a name='5548'>
</pre></body></html>