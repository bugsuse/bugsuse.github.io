<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#define MODAL_AERO<a name='2'>
#define WRF_PORT<a name='3'>
<font color=#447700>! Updated to CESM1.0.3 (CAM5.1.01) by Balwinder.Singh@pnnl.gov<a name='4'></font>
<A NAME='CLDWAT2M_MICRO'><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#CLDWAT2M_MICRO' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
<font color=#993300>module </font><font color=#cc0000>cldwat2m_micro</font> <A href='../../call_to/CLDWAT2M_MICRO.html' TARGET='index'>2</A>,<A href='../../call_from/CLDWAT2M_MICRO.html' TARGET='index'>6</A><a name='6'>
<a name='7'>
<font color=#447700>!---------------------------------------------------------------------------------<a name='8'></font>
<font color=#447700>! Purpose:<a name='9'></font>
<font color=#447700>!   CAM Interface for microphysics<a name='10'></font>
<font color=#447700>!<a name='11'></font>
<font color=#447700>! Author: Andrew Gettelman, Hugh Morrison.<a name='12'></font>
<font color=#447700>! Contributions from: Xiaohong Liu and Steve Ghan<a name='13'></font>
<font color=#447700>! December 2005-May 2010<a name='14'></font>
<font color=#447700>! Description in: Morrison and Gettelman, 2008. J. Climate (MG2008)<a name='15'></font>
<font color=#447700>!                 Gettelman et al., 2010 J. Geophys. Res. - Atmospheres (G2010)         <a name='16'></font>
<font color=#447700>! for questions contact Hugh Morrison, Andrew Gettelman<a name='17'></font>
<font color=#447700>! e-mail: morrison@ucar.edu, andrew@ucar.edu<a name='18'></font>
<font color=#447700>!---------------------------------------------------------------------------------<a name='19'></font>
<font color=#447700>! modification for sub-columns, HM, (orig 8/11/10)<a name='20'></font>
<font color=#447700>! This is done using the logical 'sub_column' set to .true. = subcolumns<a name='21'></font>
<font color=#447700>!---------------------------------------------------------------------------------<a name='22'></font>
<a name='23'>
  use <A href='../../html_code/phys/module_cam_shr_kind_mod.F.html#SHR_KIND_MOD'>shr_kind_mod</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#CLDWAT2M_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHR_KIND_MOD_7">,  only: r8=&gt;shr_kind_r8<a name='24'>
#ifndef WRF_PORT<a name='25'>
  use spmd_utils,    only: masterproc<a name='26'>
  use ppgrid,        only: pcols, pver, pverp<a name='27'>
#else<a name='28'>
  use <A href='../../html_code/phys/module_cam_support.F.html#MODULE_CAM_SUPPORT'>module_cam_support</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#CLDWAT2M_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CAM_SUPPORT_13">, only: masterproc, pcols, pver, pverp<a name='29'>
#endif<a name='30'>
  use <A href='../../html_code/phys/module_cam_physconst.F.html#PHYSCONST'>physconst</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#CLDWAT2M_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSCONST_5">,     only: gravit, rair, tmelt, cpair, rh2o, rhoh2o<a name='31'>
  use <A href='../../html_code/phys/module_cam_physconst.F.html#PHYSCONST'>physconst</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#CLDWAT2M_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSCONST_6">,     only: latvap, latice<a name='32'>
  use <A href='../../html_code/phys/module_cam_wv_saturation.F.html#WV_SATURATION'>wv_saturation</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#CLDWAT2M_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WV_SATURATION_5">,  only: polysvp, epsqs <a name='33'>
#ifndef WRF_PORT<a name='34'>
  use cam_history,    only: addfld, add_default, phys_decomp, outfld<a name='35'>
  use cam_history_support, only : fillvalue<a name='36'>
  use cam_logfile,    only: iulog<a name='37'>
  use phys_control,   only: phys_getopts<a name='38'>
  use cldwat2m_macro, only: rhmini<a name='39'>
#else<a name='40'>
  use <A href='../../html_code/phys/module_cam_support.F.html#MODULE_CAM_SUPPORT'>module_cam_support</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#CLDWAT2M_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CAM_SUPPORT_14">, only: addfld, add_default, phys_decomp, outfld, &amp;<a name='41'>
       fillvalue, iulog<a name='42'>
#endif<a name='43'>
<a name='44'>
  implicit none<a name='45'>
  private<a name='46'>
  save<a name='47'>
<a name='48'>
#ifdef WRF_PORT<a name='49'>
  <font color=#447700>!Macrophysics is not ported yet therefore rhmini is defined here (obtained from Cam5's cldwat2_macro)-Balwinder.Singh@pnnl.gov<a name='50'></font>
  real(r8), public,  parameter :: rhmini       = 0.80_r8       <font color=#447700>! Minimum rh for ice cloud fraction &gt; 0.<a name='51'></font>
#endif<a name='52'>
  logical, public :: liu_in = .true.   <font color=#447700>! True = Liu et al 2007 Ice nucleation <a name='53'></font>
                                       <font color=#447700>! False = cooper fixed ice nucleation (MG2008)<a name='54'></font>
<a name='55'>
   public :: ini_micro, mmicro_pcond,gamma<a name='56'>
<a name='57'>
<font color=#447700>!constants remaped<a name='58'></font>
  real(r8), private::  g              <font color=#447700>!gravity<a name='59'></font>
  real(r8), private::  r              <font color=#447700>!Dry air Gas constant<a name='60'></font>
  real(r8), private::  rv             <font color=#447700>!water vapor gas contstant<a name='61'></font>
  real(r8), private::  cpp            <font color=#447700>!specific heat of dry air<a name='62'></font>
  real(r8), private::  rhow           <font color=#447700>!density of liquid water<a name='63'></font>
  real(r8), private::  xxlv           <font color=#447700>! latent heat of vaporization<a name='64'></font>
  real(r8), private::  xlf            <font color=#447700>!latent heat of freezing<a name='65'></font>
  real(r8), private::  xxls           <font color=#447700>!latent heat of sublimation<a name='66'></font>
<a name='67'>
real(r8), private:: rhosn  <font color=#447700>! bulk density snow<a name='68'></font>
real(r8), private:: rhoi   <font color=#447700>! bulk density ice<a name='69'></font>
<a name='70'>
real(r8), private:: ac,bc,as,bs,ai,bi,ar,br  <font color=#447700>!fall speed parameters <a name='71'></font>
real(r8), private:: ci,di    <font color=#447700>!ice mass-diameter relation parameters<a name='72'></font>
real(r8), private:: cs,ds    <font color=#447700>!snow mass-diameter relation parameters<a name='73'></font>
real(r8), private:: cr,dr    <font color=#447700>!drop mass-diameter relation parameters<a name='74'></font>
real(r8), private:: f1s,f2s  <font color=#447700>!ventilation param for snow<a name='75'></font>
real(r8), private:: Eii      <font color=#447700>!collection efficiency aggregation of ice<a name='76'></font>
real(r8), private:: Ecc      <font color=#447700>!collection efficiency<a name='77'></font>
real(r8), private:: Ecr      <font color=#447700>!collection efficiency cloud droplets/rain<a name='78'></font>
real(r8), private:: f1r,f2r  <font color=#447700>!ventilation param for rain<a name='79'></font>
real(r8), private:: DCS      <font color=#447700>!autoconversion size threshold<a name='80'></font>
real(r8), private:: qsmall   <font color=#447700>!min mixing ratio <a name='81'></font>
real(r8), private:: bimm,aimm <font color=#447700>!immersion freezing<a name='82'></font>
real(r8), private:: rhosu     <font color=#447700>!typical 850mn air density<a name='83'></font>
real(r8), private:: mi0       <font color=#447700>! new crystal mass<a name='84'></font>
real(r8), private:: rin       <font color=#447700>! radius of contact nuclei<a name='85'></font>
real(r8), private:: qcvar     <font color=#447700>! 1/relative variance of sub-grid qc<a name='86'></font>
real(r8), private:: pi       <font color=#447700>! pi<a name='87'></font>
<a name='88'>
<font color=#447700>! Additional constants to help speed up code<a name='89'></font>
<a name='90'>
real(r8), private:: cons1<a name='91'>
real(r8), private:: cons2<a name='92'>
real(r8), private:: cons3<a name='93'>
real(r8), private:: cons4<a name='94'>
real(r8), private:: cons5<a name='95'>
real(r8), private:: cons6<a name='96'>
real(r8), private:: cons7<a name='97'>
real(r8), private:: cons8<a name='98'>
real(r8), private:: cons9<a name='99'>
real(r8), private:: cons10<a name='100'>
real(r8), private:: cons11<a name='101'>
real(r8), private:: cons12<a name='102'>
real(r8), private:: cons13<a name='103'>
real(r8), private:: cons14<a name='104'>
real(r8), private:: cons15<a name='105'>
real(r8), private:: cons16<a name='106'>
real(r8), private:: cons17<a name='107'>
real(r8), private:: cons18<a name='108'>
real(r8), private:: cons19<a name='109'>
real(r8), private:: cons20<a name='110'>
real(r8), private:: cons21<a name='111'>
real(r8), private:: cons22<a name='112'>
real(r8), private:: cons23<a name='113'>
real(r8), private:: cons24<a name='114'>
real(r8), private:: cons25<a name='115'>
real(r8), private:: cons27<a name='116'>
real(r8), private:: cons28<a name='117'>
<a name='118'>
real(r8), private:: lammini<a name='119'>
real(r8), private:: lammaxi<a name='120'>
real(r8), private:: lamminr<a name='121'>
real(r8), private:: lammaxr<a name='122'>
real(r8), private:: lammins<a name='123'>
real(r8), private:: lammaxs<a name='124'>
<a name='125'>
<font color=#447700>! parameters for snow/rain fraction for convective clouds<a name='126'></font>
real(r8), private:: tmax_fsnow <font color=#447700>! max temperature for transition to convective snow<a name='127'></font>
real(r8), private:: tmin_fsnow <font color=#447700>! min temperature for transition to convective snow<a name='128'></font>
<a name='129'>
<font color=#447700>!needed for findsp<a name='130'></font>
real(r8), private:: tt0       <font color=#447700>! Freezing temperature<a name='131'></font>
<a name='132'>
real(r8), private:: csmin,csmax,minrefl,mindbz<a name='133'>
<a name='134'>
contains<a name='135'>
<a name='136'>
<font color=#447700>!===============================================================================<a name='137'></font>
<a name='138'>
<A NAME='INI_MICRO'><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='139'>
<font color=#993300>subroutine </font><font color=#cc0000>ini_micro</font> <A href='../../call_to/INI_MICRO.html' TARGET='index'>1</A>,<A href='../../call_from/INI_MICRO.html' TARGET='index'>47</A><a name='140'>
<a name='141'>
<font color=#447700>!----------------------------------------------------------------------- <a name='142'></font>
<font color=#447700>! <a name='143'></font>
<font color=#447700>! Purpose: <a name='144'></font>
<font color=#447700>! initialize constants for the morrison microphysics<a name='145'></font>
<font color=#447700>! called from stratiform.F90<a name='146'></font>
<font color=#447700>! <a name='147'></font>
<font color=#447700>! Author: Andrew Gettelman Dec 2005<a name='148'></font>
<font color=#447700>! <a name='149'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='150'></font>
<a name='151'>
   integer k<a name='152'>
<a name='153'>
   integer l,m, iaer<a name='154'>
   real(r8) surften       <font color=#447700>! surface tension of water w/respect to air (N/m)<a name='155'></font>
   real(r8) arg<a name='156'>
<a name='157'>
   character(len=16) :: eddy_scheme = ' '<a name='158'>
   logical           :: history_microphysics     <font color=#447700>! output variables for microphysics diagnostics package<a name='159'></font>
#ifndef WRF_PORT<a name='160'>
   <font color=#447700>! Query the PBL eddy scheme<a name='161'></font>
   call phys_getopts(eddy_scheme_out              = eddy_scheme,           &amp;<a name='162'>
                     history_microphysics_out     = history_microphysics   )<a name='163'>
#else<a name='164'>
   history_microphysics = .FALSE.<a name='165'>
#endif<a name='166'>
   <font color=#447700>! diagnostic precip<a name='167'></font>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_65"> ('QRAIN   ','kg/kg   ',pver, 'A','Diagnostic grid-mean rain mixing ratio'         ,phys_decomp)	<a name='168'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_66"> ('QSNOW   ','kg/kg   ',pver, 'A','Diagnostic grid-mean snow mixing ratio'         ,phys_decomp)	<a name='169'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_67"> ('NRAIN   ','m-3     ',pver, 'A','Diagnostic grid-mean rain number conc'         ,phys_decomp)	<a name='170'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_68"> ('NSNOW   ','m-3     ',pver, 'A','Diagnostic grid-mean snow number conc'         ,phys_decomp)	<a name='171'>
<a name='172'>
   <font color=#447700>! size of precip<a name='173'></font>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_69"> ('RERCLD   ','m      ',pver, 'A','Diagnostic effective radius of Liquid Cloud and Rain' ,phys_decomp)<a name='174'>
<a name='175'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_70"> ('DSNOW   ','m       ',pver, 'A','Diagnostic grid-mean snow diameter'         ,phys_decomp)	<a name='176'>
<a name='177'>
   <font color=#447700>! diagnostic radar reflectivity, cloud-averaged <a name='178'></font>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_71"> ('REFL  ','DBz  ',pver, 'A','94 GHz radar reflectivity'       ,phys_decomp)<a name='179'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_72"> ('AREFL  ','DBz  ',pver, 'A','Average 94 GHz radar reflectivity'       ,phys_decomp)<a name='180'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_73"> ('FREFL  ','fraction  ',pver, 'A','Fractional occurance of radar reflectivity'       ,phys_decomp)<a name='181'>
   <a name='182'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_74"> ('CSRFL  ','DBz  ',pver, 'A','94 GHz radar reflectivity (CloudSat thresholds)'       ,phys_decomp)<a name='183'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_75"> ('ACSRFL  ','DBz  ',pver, 'A','Average 94 GHz radar reflectivity (CloudSat thresholds)'       ,phys_decomp)<a name='184'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_76"> ('FCSRFL  ','fraction  ',pver, 'A','Fractional occurance of radar reflectivity (CloudSat thresholds)' &amp;<a name='185'>
	,phys_decomp)<a name='186'>
 <a name='187'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_77"> ('AREFLZ ','mm^6/m^3 ',pver, 'A','Average 94 GHz radar reflectivity'       ,phys_decomp)<a name='188'>
<a name='189'>
   <font color=#447700>! Aerosol information<a name='190'></font>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_78"> ('NCAL    ','#/m3   ',pver, 'A','Number Concentation Activated for Liquid',phys_decomp)<a name='191'>
    call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_79"> ('NCAI    ','#/m3   ',pver, 'A','Number Concentation Activated for Ice',phys_decomp)<a name='192'>
<a name='193'>
<a name='194'>
   <font color=#447700>! Average rain and snow mixing ratio (Q), number (N) and diameter (D), with frequency<a name='195'></font>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_80"> ('AQRAIN   ','kg/kg   ',pver, 'A','Average rain mixing ratio'         ,phys_decomp)	<a name='196'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_81"> ('AQSNOW   ','kg/kg   ',pver, 'A','Average snow mixing ratio'         ,phys_decomp)	<a name='197'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_82"> ('ANRAIN   ','m-3     ',pver, 'A','Average rain number conc'         ,phys_decomp)	<a name='198'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_83"> ('ANSNOW   ','m-3     ',pver, 'A','Average snow number conc'         ,phys_decomp)<a name='199'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_84"> ('ADRAIN   ','Micron  ',pver, 'A','Average rain effective Diameter'         ,phys_decomp)	<a name='200'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_85"> ('ADSNOW   ','Micron  ',pver, 'A','Average snow effective Diameter'         ,phys_decomp)<a name='201'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_86"> ('FREQR  ','fraction  ',pver, 'A','Fractional occurance of rain'       ,phys_decomp)<a name='202'>
   call <A href='../../html_code/phys/module_cam_support.F.html#ADDFLD'>addfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADDFLD_87"> ('FREQS  ','fraction  ',pver, 'A','Fractional occurance of snow'       ,phys_decomp)<a name='203'>
<a name='204'>
   if ( history_microphysics) then<a name='205'>
      call <A href='../../html_code/phys/module_cam_support.F.html#ADD_DEFAULT'>add_default</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_DEFAULT_1"> ('AQSNOW   ', 1, ' ')<a name='206'>
      call <A href='../../html_code/phys/module_cam_support.F.html#ADD_DEFAULT'>add_default</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_DEFAULT_2"> ('FREQR    ', 1, ' ')<a name='207'>
      call <A href='../../html_code/phys/module_cam_support.F.html#ADD_DEFAULT'>add_default</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_DEFAULT_3"> ('FREQS    ', 1, ' ')<a name='208'>
      call <A href='../../html_code/phys/module_cam_support.F.html#ADD_DEFAULT'>add_default</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_DEFAULT_4"> ('AQRAIN   ', 1, ' ')<a name='209'>
      call <A href='../../html_code/phys/module_cam_support.F.html#ADD_DEFAULT'>add_default</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_DEFAULT_5"> ('AQSNOW   ', 1, ' ')<a name='210'>
      call <A href='../../html_code/phys/module_cam_support.F.html#ADD_DEFAULT'>add_default</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_DEFAULT_6"> ('ANRAIN   ', 1, ' ')<a name='211'>
      call <A href='../../html_code/phys/module_cam_support.F.html#ADD_DEFAULT'>add_default</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_DEFAULT_7"> ('ANSNOW   ', 1, ' ')<a name='212'>
  end if<a name='213'>
<a name='214'>
<font color=#447700>!declarations for morrison codes (transforms variable names)<a name='215'></font>
<a name='216'>
   g= gravit                  <font color=#447700>!gravity<a name='217'></font>
   r= rair       	      <font color=#447700>!Dry air Gas constant: note units(phys_constants are in J/K/kmol)<a name='218'></font>
   rv= rh2o                   <font color=#447700>!water vapor gas contstant<a name='219'></font>
   cpp = cpair                 <font color=#447700>!specific heat of dry air<a name='220'></font>
   rhow = rhoh2o              <font color=#447700>!density of liquid water<a name='221'></font>
<a name='222'>
<font color=#447700>! latent heats<a name='223'></font>
<a name='224'>
   xxlv = latvap         <font color=#447700>! latent heat vaporization<a name='225'></font>
   xlf = latice          <font color=#447700>! latent heat freezing<a name='226'></font>
   xxls = xxlv + xlf     <font color=#447700>! latent heat of sublimation<a name='227'></font>
<a name='228'>
<font color=#447700>! parameters for snow/rain fraction for convective clouds<a name='229'></font>
<a name='230'>
   tmax_fsnow = tmelt<a name='231'>
   tmin_fsnow = tmelt-5._r8<a name='232'>
<a name='233'>
<font color=#447700>! parameters below from Reisner et al. (1998)<a name='234'></font>
<font color=#447700>! density parameters (kg/m3)<a name='235'></font>
<a name='236'>
      rhosn = 250._r8    <font color=#447700>! bulk density snow  (++ ceh)<a name='237'></font>
      rhoi = 500._r8     <font color=#447700>! bulk density ice<a name='238'></font>
      rhow = 1000._r8    <font color=#447700>! bulk density liquid<a name='239'></font>
<a name='240'>
<a name='241'>
<font color=#447700>! fall speed parameters, V = aD^b<a name='242'></font>
<font color=#447700>! V is in m/s<a name='243'></font>
<a name='244'>
<font color=#447700>! droplets<a name='245'></font>
	ac = 3.e7_r8<a name='246'>
	bc = 2._r8<a name='247'>
<a name='248'>
<font color=#447700>! snow<a name='249'></font>
	as = 11.72_r8<a name='250'>
	bs = 0.41_r8<a name='251'>
<a name='252'>
<font color=#447700>! cloud ice<a name='253'></font>
	ai = 700._r8<a name='254'>
	bi = 1._r8<a name='255'>
<a name='256'>
<font color=#447700>! rain<a name='257'></font>
	ar = 841.99667_r8<a name='258'>
	br = 0.8_r8<a name='259'>
<a name='260'>
<font color=#447700>! particle mass-diameter relationship<a name='261'></font>
<font color=#447700>! currently we assume spherical particles for cloud ice/snow<a name='262'></font>
<font color=#447700>! m = cD^d<a name='263'></font>
<a name='264'>
        pi= 3.1415927_r8<a name='265'>
<a name='266'>
<font color=#447700>! cloud ice mass-diameter relationship<a name='267'></font>
<a name='268'>
	ci = rhoi*pi/6._r8<a name='269'>
	di = 3._r8<a name='270'>
<a name='271'>
<font color=#447700>! snow mass-diameter relationship<a name='272'></font>
<a name='273'>
	cs = rhosn*pi/6._r8<a name='274'>
	ds = 3._r8<a name='275'>
<a name='276'>
<font color=#447700>! drop mass-diameter relationship<a name='277'></font>
<a name='278'>
	cr = rhow*pi/6._r8<a name='279'>
	dr = 3._r8<a name='280'>
<a name='281'>
<font color=#447700>! ventilation parameters for snow<a name='282'></font>
<font color=#447700>! hall and prupacher<a name='283'></font>
<a name='284'>
	f1s = 0.86_r8<a name='285'>
	f2s = 0.28_r8<a name='286'>
<a name='287'>
<font color=#447700>! collection efficiency, aggregation of cloud ice and snow<a name='288'></font>
<a name='289'>
	Eii = 0.1_r8<a name='290'>
<a name='291'>
<font color=#447700>! collection efficiency, accretion of cloud water by rain<a name='292'></font>
<a name='293'>
	Ecr = 1.0_r8<a name='294'>
<a name='295'>
<font color=#447700>! ventilation constants for rain<a name='296'></font>
<a name='297'>
	f1r = 0.78_r8<a name='298'>
	f2r = 0.32_r8<a name='299'>
<a name='300'>
<font color=#447700>! autoconversion size threshold for cloud ice to snow (m)<a name='301'></font>
<a name='302'>
       Dcs = 400.e-6_r8<a name='303'>
<a name='304'>
<font color=#447700>! smallest mixing ratio considered in microphysics<a name='305'></font>
<a name='306'>
	qsmall = 1.e-18_r8  <a name='307'>
<a name='308'>
<font color=#447700>! immersion freezing parameters, bigg 1953<a name='309'></font>
<a name='310'>
	bimm = 100._r8<a name='311'>
	aimm = 0.66_r8<a name='312'>
<a name='313'>
<font color=#447700>! typical air density at 850 mb<a name='314'></font>
<a name='315'>
	rhosu = 85000._r8/(rair * tmelt)<a name='316'>
<a name='317'>
<font color=#447700>! mass of new crystal due to aerosol freezing and growth (kg)<a name='318'></font>
<a name='319'>
	mi0 = 4._r8/3._r8*pi*rhoi*(10.e-6_r8)*(10.e-6_r8)*(10.e-6_r8)<a name='320'>
<a name='321'>
<font color=#447700>! radius of contact nuclei aerosol (m)<a name='322'></font>
<a name='323'>
        rin = 0.1e-6_r8<a name='324'>
<a name='325'>
<font color=#447700>! 1 / relative variance of sub-grid cloud water distribution<a name='326'></font>
<font color=#447700>! see morrison and gettelman, 2007, J. Climate for details<a name='327'></font>
<a name='328'>
	qcvar = 2._r8<a name='329'>
<a name='330'>
<font color=#447700>! freezing temperature<a name='331'></font>
	tt0=273.15_r8<a name='332'>
<a name='333'>
      pi=4._r8*atan(1.0_r8)<a name='334'>
<a name='335'>
      <font color=#447700>!Range of cloudsat reflectivities (dBz) for analytic simulator<a name='336'></font>
      csmin= -30._r8<a name='337'>
      csmax= 26._r8<a name='338'>
      mindbz = -99._r8<a name='339'>
      <font color=#447700>!      minrefl = 10._r8**(mindbz/10._r8)<a name='340'></font>
      minrefl = 1.26e-10_r8<a name='341'>
<a name='342'>
<font color=#447700>! Define constants to help speed up code (limit calls to gamma function)<a name='343'></font>
<a name='344'>
	cons1=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_3">(1._r8+di)<a name='345'>
	cons2=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_4">(qcvar+2.47_r8)<a name='346'>
	cons3=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_5">(qcvar)<a name='347'>
	cons4=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_6">(1._r8+br)<a name='348'>
	cons5=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_7">(4._r8+br)<a name='349'>
	cons6=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_8">(1._r8+ds)<a name='350'>
	cons7=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_9">(1._r8+bs)     <a name='351'>
	cons8=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_10">(4._r8+bs)     <a name='352'>
	cons9=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_11">(qcvar+2._r8)     <a name='353'>
	cons10=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_12">(qcvar+1._r8)<a name='354'>
	cons11=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_13">(3._r8+bs)<a name='355'>
	cons12=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_14">(qcvar+1.15_r8)<a name='356'>
	cons13=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_15">(5._r8/2._r8+br/2._r8)<a name='357'>
	cons14=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_16">(5._r8/2._r8+bs/2._r8)<a name='358'>
	cons15=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_17">(qcvar+bc/3._r8)<a name='359'>
	cons16=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_18">(1._r8+bi)<a name='360'>
	cons17=<A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_19">(4._r8+bi)<a name='361'>
	cons18=qcvar**2.47_r8<a name='362'>
	cons19=qcvar**2<a name='363'>
	cons20=qcvar**1.15_r8<a name='364'>
	cons21=qcvar**(bc/3._r8)<a name='365'>
	cons22=(4._r8/3._r8*pi*rhow*(25.e-6_r8)**3)	<a name='366'>
	cons23=dcs**3<a name='367'>
	cons24=dcs**2<a name='368'>
	cons25=dcs**bs<a name='369'>
	cons27=xxlv**2<a name='370'>
	cons28=xxls**2<a name='371'>
<a name='372'>
        lammaxi = 1._r8/10.e-6_r8<a name='373'>
        lammini = 1._r8/(2._r8*dcs)<a name='374'>
	lammaxr = 1._r8/20.e-6_r8<a name='375'>
	lamminr = 1._r8/500.e-6_r8<a name='376'>
	lammaxs = 1._r8/10.e-6_r8<a name='377'>
	lammins = 1._r8/2000.e-6_r8<a name='378'>
<a name='379'>
   return<a name='380'>
 end subroutine ini_micro<a name='381'>
<a name='382'>
<font color=#447700>!===============================================================================<a name='383'></font>
<font color=#447700>!microphysics routine for each timestep goes here...<a name='384'></font>
<a name='385'>
<A NAME='MMICRO_PCOND'><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='386'>
<font color=#993300>subroutine </font><font color=#cc0000>mmicro_pcond</font> ( sub_column,       &amp; <A href='../../call_to/MMICRO_PCOND.html' TARGET='index'>1</A>,<A href='../../call_from/MMICRO_PCOND.html' TARGET='index'>36</A><a name='387'>
   lchnk, ncol, deltatin, tn,               &amp;<a name='388'>
   qn, qc, qi,                              &amp;<a name='389'>
   nc, ni, p, pdel, cldn,                   &amp;<a name='390'>
   liqcldf, icecldf,                        &amp;<a name='391'>
   cldo,                                    &amp;<a name='392'>
   rate1ord_cw2pr_st,                       &amp;   <a name='393'>
   naai, npccnin, rndst,nacon,              &amp;<a name='394'>
   tlat, qvlat,        &amp;<a name='395'>
   qctend, qitend, nctend, nitend, effc,    &amp;<a name='396'>
   effc_fn, effi, prect, preci,             &amp;  <a name='397'>
   nevapr, evapsnow,      &amp;<a name='398'>
   prain, prodsnow, cmeout, deffi, pgamrad, &amp;<a name='399'>
   lamcrad,qsout,dsout, &amp;<a name='400'>
         rflx,sflx, qrout,reff_rain,reff_snow,  &amp;<a name='401'>
   qcsevap,qisevap,qvres,cmeiout, &amp;<a name='402'>
   vtrmc,vtrmi,qcsedten,qisedten, &amp;<a name='403'>
   prao,prco,mnuccco,mnuccto,msacwio,psacwso,&amp;<a name='404'>
   bergso,bergo,melto,homoo,qcreso,prcio,praio,qireso,&amp;<a name='405'>
   mnuccro,pracso,meltsdt,frzrdt,mnuccdo    &amp;<a name='406'>
#ifdef WRF_PORT<a name='407'>
   , nsout, nrout                           &amp;<a name='408'>
#endif<a name='409'>
                                            )<a name='410'>
<a name='411'>
<font color=#447700>!Author: Hugh Morrison, Andrew Gettelman, NCAR<a name='412'></font>
<font color=#447700>! e-mail: morrison@ucar.edu, andrew@ucar.edu<a name='413'></font>
<a name='414'>
   use <A href='../../html_code/phys/module_cam_wv_saturation.F.html#WV_SATURATION'>wv_saturation</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WV_SATURATION_6">, only: vqsatd_water<a name='415'>
<a name='416'>
   <font color=#447700>! input arguments<a name='417'></font>
   logical,  intent(in) :: sub_column  <font color=#447700>! True = configure for sub-columns  False = use w/o sub-columns (standard)<a name='418'></font>
   integer,  intent(in) :: lchnk<a name='419'>
   integer,  intent(in) :: ncol<a name='420'>
   real(r8), intent(in) :: deltatin             <font color=#447700>! time step (s)<a name='421'></font>
   real(r8), intent(in) :: tn(pcols,pver)       <font color=#447700>! input temperature (K)<a name='422'></font>
   real(r8), intent(in) :: qn(pcols,pver)       <font color=#447700>! input h20 vapor mixing ratio (kg/kg)<a name='423'></font>
<a name='424'>
   <font color=#447700>! note: all input cloud variables are grid-averaged<a name='425'></font>
   real(r8), intent(inout) :: qc(pcols,pver)    <font color=#447700>! cloud water mixing ratio (kg/kg)<a name='426'></font>
   real(r8), intent(inout) :: qi(pcols,pver)    <font color=#447700>! cloud ice mixing ratio (kg/kg)<a name='427'></font>
   real(r8), intent(inout) :: nc(pcols,pver)    <font color=#447700>! cloud water number conc (1/kg)<a name='428'></font>
   real(r8), intent(inout) :: ni(pcols,pver)    <font color=#447700>! cloud ice number conc (1/kg)<a name='429'></font>
   real(r8), intent(in) :: p(pcols,pver)        <font color=#447700>! air pressure (pa)<a name='430'></font>
   real(r8), intent(in) :: pdel(pcols,pver)     <font color=#447700>! pressure difference across level (pa)<a name='431'></font>
   real(r8), intent(in) :: cldn(pcols,pver)     <font color=#447700>! cloud fraction<a name='432'></font>
   real(r8), intent(in) :: icecldf(pcols,pver)  <font color=#447700>! ice cloud fraction   <a name='433'></font>
   real(r8), intent(in) :: liqcldf(pcols,pver)  <font color=#447700>! liquid cloud fraction<a name='434'></font>
   real(r8), intent(inout) :: cldo(pcols,pver)  <font color=#447700>! old cloud fraction<a name='435'></font>
<a name='436'>
   real(r8), intent(out) :: rate1ord_cw2pr_st(pcols,pver) <font color=#447700>! 1st order rate for direct cw to precip conversion <a name='437'></font>
                                                          <font color=#447700>! used for scavenging<a name='438'></font>
<font color=#447700>! Inputs for aerosol activation<a name='439'></font>
   real(r8), intent(in) :: naai(pcols,pver)      <font color=#447700>! ice nulceation number (from microp_aero_ts) <a name='440'></font>
   real(r8), intent(in) :: npccnin(pcols,pver)   <font color=#447700>! ccn activated number tendency (from microp_aero_ts)<a name='441'></font>
   real(r8), intent(in) :: rndst(pcols,pver,4)   <font color=#447700>! radius of 4 dust bins for contact freezing (from microp_aero_ts)<a name='442'></font>
   real(r8), intent(in) :: nacon(pcols,pver,4)   <font color=#447700>! number in 4 dust bins for contact freezing  (from microp_aero_ts)<a name='443'></font>
<a name='444'>
   <font color=#447700>! output arguments<a name='445'></font>
<a name='446'>
   real(r8), intent(out) :: tlat(pcols,pver)    <font color=#447700>! latent heating rate       (W/kg)<a name='447'></font>
   real(r8), intent(out) :: qvlat(pcols,pver)   <font color=#447700>! microphysical tendency qv (1/s)<a name='448'></font>
   real(r8), intent(out) :: qctend(pcols,pver)  <font color=#447700>! microphysical tendency qc (1/s) <a name='449'></font>
   real(r8), intent(out) :: qitend(pcols,pver)  <font color=#447700>! microphysical tendency qi (1/s)<a name='450'></font>
   real(r8), intent(out) :: nctend(pcols,pver)  <font color=#447700>! microphysical tendency nc (1/(kg*s))<a name='451'></font>
   real(r8), intent(out) :: nitend(pcols,pver)  <font color=#447700>! microphysical tendency ni (1/(kg*s))<a name='452'></font>
   real(r8), intent(out) :: effc(pcols,pver)    <font color=#447700>! droplet effective radius (micron)<a name='453'></font>
   real(r8), intent(out) :: effc_fn(pcols,pver) <font color=#447700>! droplet effective radius, assuming nc = 1.e8 kg-1<a name='454'></font>
   real(r8), intent(out) :: effi(pcols,pver)    <font color=#447700>! cloud ice effective radius (micron)<a name='455'></font>
   real(r8), intent(out) :: prect(pcols)        <font color=#447700>! surface precip rate (m/s)<a name='456'></font>
   real(r8), intent(out) :: preci(pcols)        <font color=#447700>! cloud ice/snow precip rate (m/s)<a name='457'></font>
   real(r8), intent(out) :: nevapr(pcols,pver)  <font color=#447700>! evaporation rate of rain + snow<a name='458'></font>
   real(r8), intent(out) :: evapsnow(pcols,pver)<font color=#447700>! sublimation rate of snow<a name='459'></font>
   real(r8), intent(out) :: prain(pcols,pver)   <font color=#447700>! production of rain + snow<a name='460'></font>
   real(r8), intent(out) :: prodsnow(pcols,pver)<font color=#447700>! production of snow<a name='461'></font>
   real(r8), intent(out) :: cmeout(pcols,pver)  <font color=#447700>! evap/sub of cloud<a name='462'></font>
   real(r8), intent(out) :: deffi(pcols,pver)   <font color=#447700>! ice effective diameter for optics (radiation)<a name='463'></font>
   real(r8), intent(out) :: pgamrad(pcols,pver) <font color=#447700>! ice gamma parameter for optics (radiation)<a name='464'></font>
   real(r8), intent(out) :: lamcrad(pcols,pver) <font color=#447700>! slope of droplet distribution for optics (radiation)<a name='465'></font>
   real(r8), intent(out) :: rflx(pcols,pver+1)  <font color=#447700>! grid-box average rain flux (kg m^-2 s^-1)<a name='466'></font>
   real(r8), intent(out) :: sflx(pcols,pver+1)  <font color=#447700>! grid-box average snow flux (kg m^-2 s^-1)<a name='467'></font>
   real(r8), intent(out) :: qcsevap(pcols,pver) <font color=#447700>! cloud water evaporation due to sedimentation<a name='468'></font>
   real(r8), intent(out) :: qisevap(pcols,pver) <font color=#447700>! cloud ice sublimation due to sublimation<a name='469'></font>
   real(r8), intent(out) :: qvres(pcols,pver) <font color=#447700>! residual condensation term to ensure RH &lt; 100%<a name='470'></font>
   real(r8), intent(out) :: cmeiout(pcols,pver) <font color=#447700>! grid-mean cloud ice sub/dep<a name='471'></font>
   real(r8), intent(out) :: vtrmc(pcols,pver) <font color=#447700>! mass-weighted cloud water fallspeed<a name='472'></font>
   real(r8), intent(out) :: vtrmi(pcols,pver) <font color=#447700>! mass-weighted cloud ice fallspeed<a name='473'></font>
   real(r8), intent(out) :: qcsedten(pcols,pver) <font color=#447700>! qc sedimentation tendency<a name='474'></font>
   real(r8), intent(out) :: qisedten(pcols,pver) <font color=#447700>! qi sedimentation tendency<a name='475'></font>
<font color=#447700>! microphysical process rates for output (mixing ratio tendencies)<a name='476'></font>
   real(r8), intent(out) :: prao(pcols,pver) <font color=#447700>! accretion of cloud by rain <a name='477'></font>
   real(r8), intent(out) :: prco(pcols,pver) <font color=#447700>! autoconversion of cloud to rain<a name='478'></font>
   real(r8), intent(out) :: mnuccco(pcols,pver) <font color=#447700>! mixing rat tend due to immersion freezing<a name='479'></font>
   real(r8), intent(out) :: mnuccto(pcols,pver) <font color=#447700>! mixing ratio tend due to contact freezing<a name='480'></font>
   real(r8), intent(out) :: msacwio(pcols,pver) <font color=#447700>! mixing ratio tend due to H-M splintering<a name='481'></font>
   real(r8), intent(out) :: psacwso(pcols,pver) <font color=#447700>! collection of cloud water by snow<a name='482'></font>
   real(r8), intent(out) :: bergso(pcols,pver) <font color=#447700>! bergeron process on snow<a name='483'></font>
   real(r8), intent(out) :: bergo(pcols,pver) <font color=#447700>! bergeron process on cloud ice<a name='484'></font>
   real(r8), intent(out) :: melto(pcols,pver) <font color=#447700>! melting of cloud ice<a name='485'></font>
   real(r8), intent(out) :: homoo(pcols,pver) <font color=#447700>! homogeneos freezign cloud water<a name='486'></font>
   real(r8), intent(out) :: qcreso(pcols,pver) <font color=#447700>! residual cloud condensation due to removal of excess supersat<a name='487'></font>
   real(r8), intent(out) :: prcio(pcols,pver) <font color=#447700>! autoconversion of cloud ice to snow<a name='488'></font>
   real(r8), intent(out) :: praio(pcols,pver) <font color=#447700>! accretion of cloud ice by snow<a name='489'></font>
   real(r8), intent(out) :: qireso(pcols,pver) <font color=#447700>! residual ice deposition due to removal of excess supersat<a name='490'></font>
   real(r8), intent(out) :: mnuccro(pcols,pver) <font color=#447700>! mixing ratio tendency due to heterogeneous freezing of rain to snow (1/s)<a name='491'></font>
   real(r8), intent(out) :: pracso (pcols,pver) <font color=#447700>! mixing ratio tendency due to accretion of rain by snow (1/s)<a name='492'></font>
   real(r8), intent(out) :: meltsdt(pcols,pver) <font color=#447700>! latent heating rate due to melting of snow  (W/kg)<a name='493'></font>
   real(r8), intent(out) :: frzrdt (pcols,pver) <font color=#447700>! latent heating rate due to homogeneous freezing of rain (W/kg)<a name='494'></font>
   real(r8), intent(out) :: mnuccdo(pcols,pver) <font color=#447700>! mass tendency from ice nucleation<a name='495'></font>
<a name='496'>
<font color=#447700>! local workspace<a name='497'></font>
<font color=#447700>! all units mks unless otherwise stated<a name='498'></font>
<a name='499'>
<font color=#447700>! temporary variables for sub-stepping <a name='500'></font>
	real(r8) :: t1(pcols,pver)<a name='501'>
	real(r8) :: q1(pcols,pver)<a name='502'>
	real(r8) :: qc1(pcols,pver)<a name='503'>
   	real(r8) :: qi1(pcols,pver)<a name='504'>
   	real(r8) :: nc1(pcols,pver)<a name='505'>
   	real(r8) :: ni1(pcols,pver)<a name='506'>
  	real(r8) :: tlat1(pcols,pver)<a name='507'>
   	real(r8) :: qvlat1(pcols,pver)<a name='508'>
   	real(r8) :: qctend1(pcols,pver)<a name='509'>
   	real(r8) :: qitend1(pcols,pver)<a name='510'>
   	real(r8) :: nctend1(pcols,pver)<a name='511'>
   	real(r8) :: nitend1(pcols,pver)<a name='512'>
   	real(r8) :: prect1(pcols)<a name='513'>
   	real(r8) :: preci1(pcols)<a name='514'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='515'></font>
<a name='516'>
   	real(r8) :: deltat        <font color=#447700>! sub-time step (s)<a name='517'></font>
        real(r8) :: omsm    <font color=#447700>! number near unity for round-off issues<a name='518'></font>
        real(r8) :: dto2    <font color=#447700>! dt/2 (s)<a name='519'></font>
        real(r8) :: mincld  <font color=#447700>! minimum allowed cloud fraction<a name='520'></font>
        real(r8) :: q(pcols,pver) <font color=#447700>! water vapor mixing ratio (kg/kg)<a name='521'></font>
        real(r8) :: t(pcols,pver) <font color=#447700>! temperature (K)<a name='522'></font>
        real(r8) :: rho(pcols,pver) <font color=#447700>! air density (kg m-3)<a name='523'></font>
        real(r8) :: dv(pcols,pver)  <font color=#447700>! diffusivity of water vapor in air<a name='524'></font>
        real(r8) :: mu(pcols,pver)  <font color=#447700>! viscocity of air<a name='525'></font>
        real(r8) :: sc(pcols,pver)  <font color=#447700>! schmidt number<a name='526'></font>
        real(r8) :: kap(pcols,pver) <font color=#447700>! thermal conductivity of air<a name='527'></font>
        real(r8) :: rhof(pcols,pver) <font color=#447700>! air density correction factor for fallspeed<a name='528'></font>
        real(r8) :: cldmax(pcols,pver) <font color=#447700>! precip fraction assuming maximum overlap<a name='529'></font>
        real(r8) :: cldm(pcols,pver)   <font color=#447700>! cloud fraction<a name='530'></font>
        real(r8) :: icldm(pcols,pver)   <font color=#447700>! ice cloud fraction<a name='531'></font>
        real(r8) :: lcldm(pcols,pver)   <font color=#447700>! liq cloud fraction<a name='532'></font>
        real(r8) :: icwc(pcols)    <font color=#447700>! in cloud water content (liquid+ice)<a name='533'></font>
        real(r8) :: calpha(pcols)  <font color=#447700>! parameter for cond/evap (Zhang et al. 2003)<a name='534'></font>
        real(r8) :: cbeta(pcols) <font color=#447700>! parameter for cond/evap (Zhang et al. 2003)<a name='535'></font>
        real(r8) :: cbetah(pcols) <font color=#447700>! parameter for cond/evap (Zhang et al. 2003)<a name='536'></font>
        real(r8) :: cgamma(pcols) <font color=#447700>! parameter for cond/evap (Zhang et al. 2003)<a name='537'></font>
        real(r8) :: cgamah(pcols) <font color=#447700>! parameter for cond/evap (Zhang et al. 2003)<a name='538'></font>
        real(r8) :: rcgama(pcols) <font color=#447700>! parameter for cond/evap (Zhang et al. 2003)<a name='539'></font>
        real(r8) :: cmec1(pcols) <font color=#447700>! parameter for cond/evap (Zhang et al. 2003)<a name='540'></font>
        real(r8) :: cmec2(pcols) <font color=#447700>! parameter for cond/evap (Zhang et al. 2003)<a name='541'></font>
        real(r8) :: cmec3(pcols) <font color=#447700>! parameter for cond/evap (Zhang et al. 2003)<a name='542'></font>
        real(r8) :: cmec4(pcols) <font color=#447700>! parameter for cond/evap (Zhang et al. 2003)<a name='543'></font>
        real(r8) :: qtmp <font color=#447700>! dummy qv <a name='544'></font>
        real(r8) :: dum  <font color=#447700>! temporary dummy variable<a name='545'></font>
<a name='546'>
        real(r8) :: cme(pcols,pver)  <font color=#447700>! total (liquid+ice) cond/evap rate of cloud<a name='547'></font>
<a name='548'>
        real(r8) :: cmei(pcols,pver) <font color=#447700>! dep/sublimation rate of cloud ice<a name='549'></font>
        real(r8) :: cwml(pcols,pver) <font color=#447700>! cloud water mixing ratio<a name='550'></font>
        real(r8) :: cwmi(pcols,pver) <font color=#447700>! cloud ice mixing ratio<a name='551'></font>
        real(r8) :: nnuccd(pver)   <font color=#447700>! ice nucleation rate from deposition/cond.-freezing<a name='552'></font>
        real(r8) :: mnuccd(pver)   <font color=#447700>! mass tendency from ice nucleation<a name='553'></font>
        real(r8) :: qcld              <font color=#447700>! total cloud water<a name='554'></font>
        real(r8) :: lcldn(pcols,pver) <font color=#447700>! fractional coverage of new liquid cloud<a name='555'></font>
        real(r8) :: lcldo(pcols,pver) <font color=#447700>! fractional coverage of old liquid cloud<a name='556'></font>
	real(r8) :: nctend_mixnuc(pcols,pver)<a name='557'>
	real(r8) :: arg <font color=#447700>! argument of erfc<a name='558'></font>
<a name='559'>
        <font color=#447700>! for calculation of rate1ord_cw2pr_st<a name='560'></font>
        real(r8) :: qcsinksum_rate1ord(pver)   <font color=#447700>! sum over iterations of cw to precip sink<a name='561'></font>
        real(r8) :: qcsum_rate1ord(pver)    <font color=#447700>! sum over iterations of cloud water       <a name='562'></font>
<a name='563'>
        real(r8) :: alpha<a name='564'>
<a name='565'>
        real(r8) :: dum1,dum2   <font color=#447700>!general dummy variables<a name='566'></font>
<a name='567'>
        real(r8) :: npccn(pver)     <font color=#447700>! droplet activation rate<a name='568'></font>
        real(r8) :: qcic(pcols,pver) <font color=#447700>! in-cloud cloud liquid mixing ratio<a name='569'></font>
        real(r8) :: qiic(pcols,pver) <font color=#447700>! in-cloud cloud ice mixing ratio<a name='570'></font>
        real(r8) :: qniic(pcols,pver) <font color=#447700>! in-precip snow mixing ratio<a name='571'></font>
        real(r8) :: qric(pcols,pver) <font color=#447700>! in-precip rain mixing ratio<a name='572'></font>
        real(r8) :: ncic(pcols,pver) <font color=#447700>! in-cloud droplet number conc<a name='573'></font>
        real(r8) :: niic(pcols,pver) <font color=#447700>! in-cloud cloud ice number conc<a name='574'></font>
        real(r8) :: nsic(pcols,pver) <font color=#447700>! in-precip snow number conc<a name='575'></font>
        real(r8) :: nric(pcols,pver) <font color=#447700>! in-precip rain number conc<a name='576'></font>
        real(r8) :: lami(pver) <font color=#447700>! slope of cloud ice size distr<a name='577'></font>
        real(r8) :: n0i(pver) <font color=#447700>! intercept of cloud ice size distr<a name='578'></font>
        real(r8) :: lamc(pver) <font color=#447700>! slope of cloud liquid size distr<a name='579'></font>
        real(r8) :: n0c(pver) <font color=#447700>! intercept of cloud liquid size distr<a name='580'></font>
        real(r8) :: lams(pver) <font color=#447700>! slope of snow size distr<a name='581'></font>
        real(r8) :: n0s(pver) <font color=#447700>! intercept of snow size distr<a name='582'></font>
        real(r8) :: lamr(pver) <font color=#447700>! slope of rain size distr<a name='583'></font>
        real(r8) :: n0r(pver) <font color=#447700>! intercept of rain size distr<a name='584'></font>
        real(r8) :: cdist1(pver) <font color=#447700>! size distr parameter to calculate droplet freezing<a name='585'></font>
<font color=#447700>! combined size of precip &amp; cloud drops<a name='586'></font>
        real(r8) :: rercld(pcols,pver) <font color=#447700>! effective radius calculation for rain + cloud<a name='587'></font>
        real(r8) :: arcld(pcols,pver) <font color=#447700>! averaging control flag<a name='588'></font>
        real(r8) :: Actmp  <font color=#447700>!area cross section of drops<a name='589'></font>
        real(r8) :: Artmp  <font color=#447700>!area cross section of rain<a name='590'></font>
<a name='591'>
        real(r8) :: pgam(pver) <font color=#447700>! spectral width parameter of droplet size distr<a name='592'></font>
        real(r8) :: lammax  <font color=#447700>! maximum allowed slope of size distr<a name='593'></font>
        real(r8) :: lammin  <font color=#447700>! minimum allowed slope of size distr<a name='594'></font>
        real(r8) :: nacnt   <font color=#447700>! number conc of contact ice nuclei<a name='595'></font>
        real(r8) :: mnuccc(pver) <font color=#447700>! mixing ratio tendency due to freezing of cloud water<a name='596'></font>
        real(r8) :: nnuccc(pver) <font color=#447700>! number conc tendency due to freezing of cloud water<a name='597'></font>
<a name='598'>
        real(r8) :: mnucct(pver) <font color=#447700>! mixing ratio tendency due to contact freezing of cloud water<a name='599'></font>
        real(r8) :: nnucct(pver) <font color=#447700>! number conc tendency due to contact freezing of cloud water<a name='600'></font>
        real(r8) :: msacwi(pver) <font color=#447700>! mixing ratio tendency due to HM ice multiplication<a name='601'></font>
        real(r8) :: nsacwi(pver) <font color=#447700>! number conc tendency due to HM ice multiplication<a name='602'></font>
<a name='603'>
        real(r8) :: prc(pver) <font color=#447700>! qc tendency due to autoconversion of cloud droplets<a name='604'></font>
        real(r8) :: nprc(pver) <font color=#447700>! number conc tendency due to autoconversion of cloud droplets<a name='605'></font>
        real(r8) :: nprc1(pver) <font color=#447700>! qr tendency due to autoconversion of cloud droplets<a name='606'></font>
        real(r8) :: nsagg(pver) <font color=#447700>! ns tendency due to self-aggregation of snow<a name='607'></font>
        real(r8) :: dc0  <font color=#447700>! mean size droplet size distr<a name='608'></font>
        real(r8) :: ds0  <font color=#447700>! mean size snow size distr (area weighted)<a name='609'></font>
        real(r8) :: eci  <font color=#447700>! collection efficiency for riming of snow by droplets<a name='610'></font>
        real(r8) :: psacws(pver) <font color=#447700>! mixing rat tendency due to collection of droplets by snow<a name='611'></font>
        real(r8) :: npsacws(pver) <font color=#447700>! number conc tendency due to collection of droplets by snow<a name='612'></font>
        real(r8) :: uni <font color=#447700>! number-weighted cloud ice fallspeed<a name='613'></font>
        real(r8) :: umi <font color=#447700>! mass-weighted cloud ice fallspeed<a name='614'></font>
        real(r8) :: uns(pver) <font color=#447700>! number-weighted snow fallspeed<a name='615'></font>
        real(r8) :: ums(pver) <font color=#447700>! mass-weighted snow fallspeed<a name='616'></font>
        real(r8) :: unr(pver) <font color=#447700>! number-weighted rain fallspeed<a name='617'></font>
        real(r8) :: umr(pver) <font color=#447700>! mass-weighted rain fallspeed<a name='618'></font>
        real(r8) :: unc <font color=#447700>! number-weighted cloud droplet fallspeed<a name='619'></font>
        real(r8) :: umc <font color=#447700>! mass-weighted cloud droplet fallspeed<a name='620'></font>
        real(r8) :: pracs(pver) <font color=#447700>! mixing rat tendency due to collection of rain	by snow<a name='621'></font>
        real(r8) :: npracs(pver) <font color=#447700>! number conc tendency due to collection of rain by snow<a name='622'></font>
        real(r8) :: mnuccr(pver) <font color=#447700>! mixing rat tendency due to freezing of rain<a name='623'></font>
        real(r8) :: nnuccr(pver) <font color=#447700>! number conc tendency due to freezing of rain<a name='624'></font>
        real(r8) :: pra(pver) <font color=#447700>! mixing rat tendnency due to accretion of droplets by rain<a name='625'></font>
        real(r8) :: npra(pver) <font color=#447700>! nc tendnency due to accretion of droplets by rain<a name='626'></font>
        real(r8) :: nragg(pver) <font color=#447700>! nr tendency due to self-collection of rain<a name='627'></font>
        real(r8) :: prci(pver) <font color=#447700>! mixing rat tendency due to autoconversion of cloud ice to snow<a name='628'></font>
        real(r8) :: nprci(pver) <font color=#447700>! number conc tendency due to autoconversion of cloud ice to snow<a name='629'></font>
        real(r8) :: prai(pver) <font color=#447700>! mixing rat tendency due to accretion of cloud ice by snow<a name='630'></font>
        real(r8) :: nprai(pver) <font color=#447700>! number conc tendency due to accretion of cloud ice by snow<a name='631'></font>
        real(r8) :: qvs <font color=#447700>! liquid saturation vapor mixing ratio<a name='632'></font>
        real(r8) :: qvi <font color=#447700>! ice saturation vapor mixing ratio<a name='633'></font>
        real(r8) :: dqsdt <font color=#447700>! change of sat vapor mixing ratio with temperature<a name='634'></font>
        real(r8) :: dqsidt <font color=#447700>! change of ice sat vapor mixing ratio with temperature<a name='635'></font>
        real(r8) :: ab <font color=#447700>! correction factor for rain evap to account for latent heat<a name='636'></font>
        real(r8) :: qclr <font color=#447700>! water vapor mixing ratio in clear air<a name='637'></font>
        real(r8) :: abi <font color=#447700>! correction factor for snow sublimation to account for latent heat<a name='638'></font>
        real(r8) :: epss <font color=#447700>! 1/ sat relaxation timescale for snow<a name='639'></font>
        real(r8) :: epsr <font color=#447700>! 1/ sat relaxation timescale for rain<a name='640'></font>
        real(r8) :: pre(pver) <font color=#447700>! rain mixing rat tendency due to evaporation<a name='641'></font>
        real(r8) :: prds(pver) <font color=#447700>! snow mixing rat tendency due to sublimation<a name='642'></font>
        real(r8) :: qce <font color=#447700>! dummy qc for conservation check<a name='643'></font>
        real(r8) :: qie <font color=#447700>! dummy qi for conservation check<a name='644'></font>
        real(r8) :: nce <font color=#447700>! dummy nc for conservation check<a name='645'></font>
        real(r8) :: nie <font color=#447700>! dummy ni for conservation check<a name='646'></font>
        real(r8) :: ratio <font color=#447700>! parameter for conservation check<a name='647'></font>
        real(r8) :: dumc(pcols,pver) <font color=#447700>! dummy in-cloud qc<a name='648'></font>
        real(r8) :: dumnc(pcols,pver) <font color=#447700>! dummy in-cloud nc<a name='649'></font>
        real(r8) :: dumi(pcols,pver) <font color=#447700>! dummy in-cloud qi<a name='650'></font>
        real(r8) :: dumni(pcols,pver) <font color=#447700>! dummy in-cloud ni<a name='651'></font>
        real(r8) :: dums(pcols,pver) <font color=#447700>! dummy in-cloud snow mixing rat<a name='652'></font>
        real(r8) :: dumns(pcols,pver) <font color=#447700>! dummy in-cloud snow number conc<a name='653'></font>
        real(r8) :: dumr(pcols,pver) <font color=#447700>! dummy in-cloud rain mixing rat<a name='654'></font>
        real(r8) :: dumnr(pcols,pver) <font color=#447700>! dummy in-cloud rain number conc<a name='655'></font>
<font color=#447700>! below are parameters for cloud water and cloud ice sedimentation calculations<a name='656'></font>
        real(r8) :: fr(pver)<a name='657'>
        real(r8) :: fnr(pver)<a name='658'>
        real(r8) :: fc(pver)<a name='659'>
        real(r8) :: fnc(pver)<a name='660'>
        real(r8) :: fi(pver)<a name='661'>
        real(r8) :: fni(pver)<a name='662'>
        real(r8) :: fs(pver)<a name='663'>
        real(r8) :: fns(pver)<a name='664'>
        real(r8) :: faloutr(pver)<a name='665'>
        real(r8) :: faloutnr(pver)<a name='666'>
        real(r8) :: faloutc(pver)<a name='667'>
        real(r8) :: faloutnc(pver)<a name='668'>
        real(r8) :: falouti(pver)<a name='669'>
        real(r8) :: faloutni(pver)<a name='670'>
        real(r8) :: falouts(pver)<a name='671'>
        real(r8) :: faloutns(pver)<a name='672'>
        real(r8) :: faltndr<a name='673'>
        real(r8) :: faltndnr<a name='674'>
        real(r8) :: faltndc<a name='675'>
        real(r8) :: faltndnc<a name='676'>
        real(r8) :: faltndi<a name='677'>
        real(r8) :: faltndni<a name='678'>
        real(r8) :: faltnds<a name='679'>
        real(r8) :: faltndns<a name='680'>
        real(r8) :: faltndqie<a name='681'>
        real(r8) :: faltndqce<a name='682'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='683'></font>
        real(r8) :: relhum(pcols,pver) <font color=#447700>! relative humidity<a name='684'></font>
        real(r8) :: csigma(pcols) <font color=#447700>! parameter for cond/evap of cloud water/ice<a name='685'></font>
        real(r8) :: rgvm <font color=#447700>! max fallspeed for all species<a name='686'></font>
        real(r8) :: arn(pcols,pver) <font color=#447700>! air density corrected rain fallspeed parameter<a name='687'></font>
        real(r8) :: asn(pcols,pver) <font color=#447700>! air density corrected snow fallspeed parameter<a name='688'></font>
        real(r8) :: acn(pcols,pver) <font color=#447700>! air density corrected cloud droplet fallspeed parameter<a name='689'></font>
        real(r8) :: ain(pcols,pver) <font color=#447700>! air density corrected cloud ice fallspeed parameter<a name='690'></font>
        real(r8) :: nsubi(pver) <font color=#447700>! evaporation of cloud ice number<a name='691'></font>
        real(r8) :: nsubc(pver) <font color=#447700>! evaporation of droplet number<a name='692'></font>
        real(r8) :: nsubs(pver) <font color=#447700>! evaporation of snow number<a name='693'></font>
        real(r8) :: nsubr(pver) <font color=#447700>! evaporation of rain number<a name='694'></font>
	real(r8) :: mtime <font color=#447700>! factor to account for droplet activation timescale<a name='695'></font>
	real(r8) :: dz(pcols,pver) <font color=#447700>! height difference across model vertical level<a name='696'></font>
<a name='697'>
<font color=#447700>!fice variable<a name='698'></font>
	real(r8) :: nfice(pcols,pver)<a name='699'>
<a name='700'>
	<font color=#447700>!! add precip flux variables for sub-stepping<a name='701'></font>
	real(r8) :: rflx1(pcols,pver+1)<a name='702'>
        real(r8) :: sflx1(pcols,pver+1)<a name='703'>
<a name='704'>
<font color=#447700>! returns from function/subroutine calls<a name='705'></font>
        real(r8) :: tsp(pcols,pver)      <font color=#447700>! saturation temp (K)<a name='706'></font>
        real(r8) :: qsp(pcols,pver)      <font color=#447700>! saturation mixing ratio (kg/kg)<a name='707'></font>
        real(r8) :: qsphy(pcols,pver)      <font color=#447700>! saturation mixing ratio (kg/kg): hybrid rh<a name='708'></font>
        real(r8) :: qs(pcols)            <font color=#447700>! liquid-ice weighted sat mixing rat (kg/kg)<a name='709'></font>
        real(r8) :: es(pcols)            <font color=#447700>! liquid-ice weighted sat vapor press (pa)<a name='710'></font>
        real(r8) :: esl(pcols,pver)      <font color=#447700>! liquid sat vapor pressure (pa)<a name='711'></font>
        real(r8) :: esi(pcols,pver)      <font color=#447700>! ice sat vapor pressure (pa)<a name='712'></font>
        real(r8) :: gammas(pcols)        <font color=#447700>! parameter for cond/evap of cloud water<a name='713'></font>
<a name='714'>
<font color=#447700>! sum of source/sink terms for diagnostic precip<a name='715'></font>
<a name='716'>
        real(r8) :: qnitend(pcols,pver) <font color=#447700>! snow mixing ratio source/sink term<a name='717'></font>
        real(r8) :: nstend(pcols,pver)  <font color=#447700>! snow number concentration source/sink term<a name='718'></font>
        real(r8) :: qrtend(pcols,pver) <font color=#447700>! rain mixing ratio source/sink term<a name='719'></font>
        real(r8) :: nrtend(pcols,pver)  <font color=#447700>! rain number concentration source/sink term<a name='720'></font>
	real(r8) :: qrtot <font color=#447700>! vertically-integrated rain mixing rat source/sink term<a name='721'></font>
	real(r8) :: nrtot <font color=#447700>! vertically-integrated rain number conc source/sink term<a name='722'></font>
	real(r8) :: qstot <font color=#447700>! vertically-integrated snow mixing rat source/sink term<a name='723'></font>
	real(r8) :: nstot <font color=#447700>! vertically-integrated snow number conc source/sink term<a name='724'></font>
<a name='725'>
<font color=#447700>! new terms for Bergeron process<a name='726'></font>
<a name='727'>
	real(r8) :: dumnnuc <font color=#447700>! provisional ice nucleation rate (for calculating bergeron)<a name='728'></font>
	real(r8) :: ninew  <font color=#447700>! provisional cloud ice number conc (for calculating bergeron)<a name='729'></font>
	real(r8) :: qinew <font color=#447700>! provisional cloud ice mixing ratio (for calculating bergeron)<a name='730'></font>
	real(r8) :: qvl  <font color=#447700>! liquid sat mixing ratio   <a name='731'></font>
	real(r8) :: epsi <font color=#447700>! 1/ sat relaxation timecale for cloud ice<a name='732'></font>
	real(r8) :: prd <font color=#447700>! provisional deposition rate of cloud ice at water sat <a name='733'></font>
	real(r8) :: berg(pcols,pver) <font color=#447700>! mixing rat tendency due to bergeron process for cloud ice<a name='734'></font>
	real(r8) :: bergs(pver) <font color=#447700>! mixing rat tendency due to bergeron process for snow<a name='735'></font>
<a name='736'>
<font color=#447700>!bergeron terms<a name='737'></font>
        real(r8) :: bergtsf   <font color=#447700>!bergeron timescale to remove all liquid<a name='738'></font>
        real(r8) :: rhin      <font color=#447700>!modified RH for vapor deposition<a name='739'></font>
<a name='740'>
<font color=#447700>! diagnostic rain/snow for output to history<a name='741'></font>
<font color=#447700>! values are in-precip (local) !!!!<a name='742'></font>
<a name='743'>
        real(r8), intent(out) :: qrout(pcols,pver)     <font color=#447700>! grid-box average rain mixing ratio (kg/kg)<a name='744'></font>
	real(r8), intent(out) :: reff_rain(pcols,pver) <font color=#447700>! rain effective radius (micron)<a name='745'></font>
	real(r8), intent(out) :: reff_snow(pcols,pver) <font color=#447700>! snow effective radius (micron)<a name='746'></font>
	real(r8) 	      :: drout(pcols,pver)     <font color=#447700>! rain diameter (m)<a name='747'></font>
#ifndef WRF_PORT<a name='748'>
	real(r8) :: nrout(pcols,pver) <font color=#447700>! rain number concentration (1/m3)<a name='749'></font>
	real(r8) :: nsout(pcols,pver) <font color=#447700>! snow number concentration (1/m3)<a name='750'></font>
#else<a name='751'>
        <font color=#447700>!WRF needs nrout and nsout to be the ouput variables<a name='752'></font>
        real(r8), intent(out) :: nrout(pcols,pver) <font color=#447700>! rain number concentration (1/m3)<a name='753'></font>
	real(r8), intent(out) :: nsout(pcols,pver) <font color=#447700>! snow number concentration (1/m3)<a name='754'></font>
#endif<a name='755'>
	real(r8), intent(out) :: dsout(pcols,pver) <font color=#447700>! snow diameter (m)<a name='756'></font>
	real(r8), intent(out) :: qsout(pcols,pver) <font color=#447700>! snow mixing ratio (kg/kg)<a name='757'></font>
<a name='758'>
<font color=#447700>!averageed rain/snow for history<a name='759'></font>
	real(r8) :: qrout2(pcols,pver)<a name='760'>
	real(r8) :: qsout2(pcols,pver)<a name='761'>
	real(r8) :: nrout2(pcols,pver)<a name='762'>
	real(r8) :: nsout2(pcols,pver)<a name='763'>
	real(r8) :: freqs(pcols,pver)<a name='764'>
	real(r8) :: freqr(pcols,pver)<a name='765'>
	real(r8) :: dumfice<a name='766'>
	real(r8) :: drout2(pcols,pver) <font color=#447700>! mean rain particle diameter (m)<a name='767'></font>
	real(r8) :: dsout2(pcols,pver) <font color=#447700>! mean snow particle diameter (m)<a name='768'></font>
<a name='769'>
<font color=#447700>!ice nucleation, droplet activation<a name='770'></font>
        real(r8) :: dum2i(pcols,pver) <font color=#447700>! number conc of ice nuclei available (1/kg)<a name='771'></font>
        real(r8) :: dum2l(pcols,pver) <font color=#447700>! number conc of CCN (1/kg)<a name='772'></font>
	real(r8) :: ncmax<a name='773'>
	real(r8) :: nimax<a name='774'>
<a name='775'>
<font color=#447700>!output fields for number conc<a name='776'></font>
        real(r8) :: ncai(pcols,pver) <font color=#447700>! output number conc of ice nuclei available (1/m3)<a name='777'></font>
        real(r8) :: ncal(pcols,pver) <font color=#447700>! output number conc of CCN (1/m3)<a name='778'></font>
<a name='779'>
<font color=#447700>! loop array variables<a name='780'></font>
         integer i,k,nstep,n, l<a name='781'>
	 integer ii,kk, m<a name='782'>
<a name='783'>
<font color=#447700>! loop variables for sub-step solution<a name='784'></font>
	 integer iter,it,ltrue(pcols)<a name='785'>
<a name='786'>
<font color=#447700>! used in contact freezing via dust particles<a name='787'></font>
        real(r8)  tcnt, viscosity, mfp<a name='788'>
        real(r8)  slip1, slip2, slip3, slip4<a name='789'>
<font color=#447700>!        real(r8)  dfaer1, dfaer2, dfaer3, dfaer4<a name='790'></font>
<font color=#447700>!        real(r8)  nacon1,nacon2,nacon3,nacon4<a name='791'></font>
        real(r8)  ndfaer1, ndfaer2, ndfaer3, ndfaer4<a name='792'>
        real(r8)  nslip1, nslip2, nslip3, nslip4<a name='793'>
<a name='794'>
<font color=#447700>! used in ice effective radius<a name='795'></font>
        real(r8)  bbi, cci, ak, iciwc, rvi<a name='796'>
<a name='797'>
<font color=#447700>! used in Bergeron processe and water vapor deposition<a name='798'></font>
        real(r8)  Tk, deles, Aprpr, Bprpr, Cice, qi0, Crate, qidep<a name='799'>
<a name='800'>
<font color=#447700>! mean cloud fraction over the time step<a name='801'></font>
        real(r8)  cldmw(pcols,pver)<a name='802'>
<a name='803'>
<font color=#447700>! used in secondary ice production<a name='804'></font>
        real(r8) ni_secp<a name='805'>
<a name='806'>
<font color=#447700>! variabels to check for RH after rain evap<a name='807'></font>
<a name='808'>
	real(r8) :: esn<a name='809'>
	real(r8) :: qsn<a name='810'>
	real(r8) :: ttmp<a name='811'>
<a name='812'>
<a name='813'>
        real(r8) :: refl(pcols,pver)    <font color=#447700>! analytic radar reflectivity        <a name='814'></font>
        real(r8) :: rainrt(pcols,pver)  <font color=#447700>! rain rate for reflectivity calculation<a name='815'></font>
        real(r8) :: rainrt1(pcols,pver)<a name='816'>
 	real(r8) :: csrfl(pcols,pver)	<font color=#447700>!cloudsat reflectivity <a name='817'></font>
        real(r8) :: arefl(pcols,pver)  <font color=#447700>!average reflectivity will zero points outside valid range<a name='818'></font>
  	real(r8) :: acsrfl(pcols,pver) <font color=#447700>!cloudsat average<a name='819'></font>
 	real(r8) :: frefl(pcols,pver)<a name='820'>
  	real(r8) :: fcsrfl(pcols,pver)<a name='821'>
 	real(r8) :: areflz(pcols,pver)  <font color=#447700>!average reflectivity in z.<a name='822'></font>
	real(r8) :: tmp<a name='823'>
<a name='824'>
        real(r8) dmc,ssmc,dstrn  <font color=#447700>! variables for modal scheme.<a name='825'></font>
  <a name='826'>
      real(r8), parameter :: cdnl    = 0.e6_r8    <font color=#447700>! cloud droplet number limiter<a name='827'></font>
<a name='828'>
<font color=#447700>!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='829'></font>
<a name='830'>
<font color=#447700>! initialize  output fields for number conc qand ice nucleation<a name='831'></font>
    ncai(1:ncol,1:pver)=0._r8 <a name='832'>
    ncal(1:ncol,1:pver)=0._r8  <a name='833'>
<a name='834'>
<font color=#447700>!Initialize rain size<a name='835'></font>
    rercld(1:ncol,1:pver)=0._r8<a name='836'>
    arcld(1:ncol,1:pver)=0._r8<a name='837'>
<a name='838'>
<font color=#447700>!initialize radiation output variables<a name='839'></font>
        pgamrad(1:ncol,1:pver)=0._r8 <font color=#447700>! liquid gamma parameter for optics (radiation)<a name='840'></font>
        lamcrad(1:ncol,1:pver)=0._r8 <font color=#447700>! slope of droplet distribution for optics (radiation)<a name='841'></font>
        deffi  (1:ncol,1:pver)=0._r8 <font color=#447700>! slope of droplet distribution for optics (radiation)<a name='842'></font>
<font color=#447700>!initialize radiation output variables<a name='843'></font>
<font color=#447700>!initialize water vapor tendency term output<a name='844'></font>
        qcsevap(1:ncol,1:pver)=0._r8 <a name='845'>
        qisevap(1:ncol,1:pver)=0._r8 <a name='846'>
        qvres  (1:ncol,1:pver)=0._r8 <a name='847'>
        cmeiout (1:ncol,1:pver)=0._r8<a name='848'>
        vtrmc (1:ncol,1:pver)=0._r8<a name='849'>
        vtrmi (1:ncol,1:pver)=0._r8<a name='850'>
        qcsedten (1:ncol,1:pver)=0._r8<a name='851'>
        qisedten (1:ncol,1:pver)=0._r8    <a name='852'>
<a name='853'>
        prao(1:ncol,1:pver)=0._r8 <a name='854'>
        prco(1:ncol,1:pver)=0._r8 <a name='855'>
        mnuccco(1:ncol,1:pver)=0._r8 <a name='856'>
        mnuccto(1:ncol,1:pver)=0._r8 <a name='857'>
        msacwio(1:ncol,1:pver)=0._r8 <a name='858'>
        psacwso(1:ncol,1:pver)=0._r8 <a name='859'>
        bergso(1:ncol,1:pver)=0._r8 <a name='860'>
        bergo(1:ncol,1:pver)=0._r8 <a name='861'>
        melto(1:ncol,1:pver)=0._r8 <a name='862'>
        homoo(1:ncol,1:pver)=0._r8 <a name='863'>
        qcreso(1:ncol,1:pver)=0._r8 <a name='864'>
        prcio(1:ncol,1:pver)=0._r8 <a name='865'>
        praio(1:ncol,1:pver)=0._r8 <a name='866'>
        qireso(1:ncol,1:pver)=0._r8 <a name='867'>
        mnuccro(1:ncol,1:pver)=0._r8 <a name='868'>
        pracso (1:ncol,1:pver)=0._r8 <a name='869'>
        meltsdt(1:ncol,1:pver)=0._r8<a name='870'>
        frzrdt (1:ncol,1:pver)=0._r8<a name='871'>
        mnuccdo(1:ncol,1:pver)=0._r8<a name='872'>
<a name='873'>
<font color=#447700>! assign variable deltat for sub-stepping...<a name='874'></font>
	deltat=deltatin	<a name='875'>
<a name='876'>
<font color=#447700>! parameters for scheme<a name='877'></font>
<a name='878'>
        omsm=0.99999_r8<a name='879'>
        dto2=0.5_r8*deltat<a name='880'>
	mincld=0.0001_r8<a name='881'>
 <a name='882'>
<font color=#447700>! initialize multi-level fields<a name='883'></font>
        q(1:ncol,1:pver)=qn(1:ncol,1:pver)<a name='884'>
        t(1:ncol,1:pver)=tn(1:ncol,1:pver)<a name='885'>
	<a name='886'>
<font color=#447700>! initialize time-varying parameters<a name='887'></font>
<a name='888'>
        do k=1,pver<a name='889'>
           do i=1,ncol<a name='890'>
        rho(i,k)=p(i,k)/(r*t(i,k))<a name='891'>
	dv(i,k) = 8.794E-5_r8*t(i,k)**1.81_r8/p(i,k)<a name='892'>
	mu(i,k) = 1.496E-6_r8*t(i,k)**1.5_r8/ &amp;<a name='893'>
             (t(i,k)+120._r8)	<a name='894'>
	sc(i,k) = mu(i,k)/(rho(i,k)*dv(i,k))<a name='895'>
	kap(i,k) = 1.414e3_r8*1.496e-6_r8*t(i,k)** &amp;<a name='896'>
            1.5_r8/(t(i,k)+120._r8) <a name='897'>
<a name='898'>
<font color=#447700>! air density adjustment for fallspeed parameters<a name='899'></font>
<font color=#447700>! includes air density correction factor to the<a name='900'></font>
<font color=#447700>! power of 0.54 following Heymsfield and Bansemer 2007<a name='901'></font>
<a name='902'>
	rhof(i,k)=(rhosu/rho(i,k))**0.54<a name='903'>
<a name='904'>
        arn(i,k)=ar*rhof(i,k)<a name='905'>
        asn(i,k)=as*rhof(i,k)<a name='906'>
        acn(i,k)=ac*rhof(i,k)<a name='907'>
        ain(i,k)=ai*rhof(i,k)<a name='908'>
<a name='909'>
<font color=#447700>! get dz from dp and hydrostatic approx<a name='910'></font>
<font color=#447700>! keep dz positive (define as layer k-1 - layer k)<a name='911'></font>
<a name='912'>
        dz(i,k)= pdel(i,k)/(rho(i,k)*g)<a name='913'>
<a name='914'>
        end do<a name='915'>
        end do<a name='916'>
<a name='917'>
<font color=#447700>! initialization<a name='918'></font>
        t1(1:ncol,1:pver) = t(1:ncol,1:pver)<a name='919'>
	q1(1:ncol,1:pver) = q(1:ncol,1:pver)<a name='920'>
	qc1(1:ncol,1:pver) = qc(1:ncol,1:pver)<a name='921'>
	qi1(1:ncol,1:pver) = qi(1:ncol,1:pver)<a name='922'>
	nc1(1:ncol,1:pver) = nc(1:ncol,1:pver)<a name='923'>
	ni1(1:ncol,1:pver) = ni(1:ncol,1:pver)<a name='924'>
<a name='925'>
<font color=#447700>! initialize tendencies to zero<a name='926'></font>
        tlat1(1:ncol,1:pver)=0._r8<a name='927'>
	qvlat1(1:ncol,1:pver)=0._r8<a name='928'>
	qctend1(1:ncol,1:pver)=0._r8<a name='929'>
	qitend1(1:ncol,1:pver)=0._r8<a name='930'>
	nctend1(1:ncol,1:pver)=0._r8<a name='931'>
	nitend1(1:ncol,1:pver)=0._r8<a name='932'>
<a name='933'>
<font color=#447700>! initialize precip output<a name='934'></font>
	qrout(1:ncol,1:pver)=0._r8<a name='935'>
	qsout(1:ncol,1:pver)=0._r8<a name='936'>
	nrout(1:ncol,1:pver)=0._r8<a name='937'>
	nsout(1:ncol,1:pver)=0._r8<a name='938'>
        dsout(1:ncol,1:pver)=0._r8<a name='939'>
<a name='940'>
        drout(1:ncol,1:pver)=0._r8<a name='941'>
        <font color=#447700>!! initialize as fillvalue to avoid Floating Exceptions<a name='942'></font>
	reff_rain(1:ncol,1:pver)=fillvalue<a name='943'>
        reff_snow(1:ncol,1:pver)=fillvalue<a name='944'>
<a name='945'>
<font color=#447700>! initialize variables for trop_mozart<a name='946'></font>
	nevapr(1:ncol,1:pver) = 0._r8<a name='947'>
	evapsnow(1:ncol,1:pver) = 0._r8<a name='948'>
	prain(1:ncol,1:pver) = 0._r8<a name='949'>
	prodsnow(1:ncol,1:pver) = 0._r8<a name='950'>
	cmeout(1:ncol,1:pver) = 0._r8<a name='951'>
<a name='952'>
<font color=#447700>! for refl calc<a name='953'></font>
        rainrt1(1:ncol,1:pver) = 0._r8<a name='954'>
<a name='955'>
<font color=#447700>! initialize precip fraction and output tendencies<a name='956'></font>
        cldmax(1:ncol,1:pver)=mincld<a name='957'>
<a name='958'>
<font color=#447700>!initialize aerosol number<a name='959'></font>
<font color=#447700>!        naer2(1:ncol,1:pver,:)=0._r8<a name='960'></font>
        dum2l(1:ncol,1:pver)=0._r8<a name='961'>
        dum2i(1:ncol,1:pver)=0._r8<a name='962'>
<a name='963'>
<font color=#447700>! initialize avg precip rate<a name='964'></font>
	prect1(1:ncol)=0._r8<a name='965'>
	preci1(1:ncol)=0._r8<a name='966'>
<a name='967'>
<font color=#447700>!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='968'></font>
<font color=#447700>!Get humidity and saturation vapor pressures<a name='969'></font>
<a name='970'>
        do k=1,pver<a name='971'>
<a name='972'>
<font color=#447700>! find wet bulk temperature and saturation value for provisional t and q without<a name='973'></font>
<font color=#447700>! condensation<a name='974'></font>
<a name='975'>
        call <A href='../../html_code/phys/module_cam_wv_saturation.F.html#VQSATD_WATER'>vqsatd_water</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VQSATD_WATER_1">(t(1,k),p(1,k),es,qs,gammas,ncol) <font color=#447700>! use rhw<a name='976'></font>
<a name='977'>
        do i=1,ncol<a name='978'>
<a name='979'>
	esl(i,k)=<A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_1">(t(i,k),0)<a name='980'>
	esi(i,k)=<A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_2">(t(i,k),1)<a name='981'>
<a name='982'>
<font color=#447700>! hm fix, make sure when above freezing that esi=esl, not active yet<a name='983'></font>
	if (t(i,k).gt.tmelt)esi(i,k)=esl(i,k)<a name='984'>
<a name='985'>
        relhum(i,k)=q(i,k)/qs(i)<a name='986'>
<a name='987'>
<font color=#447700>! get cloud fraction, check for minimum<a name='988'></font>
<a name='989'>
           cldm(i,k)=max(cldn(i,k),mincld)<a name='990'>
           cldmw(i,k)=max(cldn(i,k),mincld)<a name='991'>
<a name='992'>
           icldm(i,k)=max(icecldf(i,k),mincld)<a name='993'>
           lcldm(i,k)=max(liqcldf(i,k),mincld)<a name='994'>
<a name='995'>
<font color=#447700>! subcolumns, set cloud fraction variables to one<a name='996'></font>
<font color=#447700>! if cloud water or ice is present, if not present<a name='997'></font>
<font color=#447700>! set to mincld (mincld used instead of zero, to prevent<a name='998'></font>
<font color=#447700>! possible division by zero errors<a name='999'></font>
<a name='1000'>
           if (sub_column) then<a name='1001'>
<a name='1002'>
              cldm(i,k)=mincld<a name='1003'>
              cldmw(i,k)=mincld<a name='1004'>
              icldm(i,k)=mincld<a name='1005'>
              lcldm(i,k)=mincld<a name='1006'>
              <a name='1007'>
              if (qc(i,k).ge.qsmall) then<a name='1008'>
                 lcldm(i,k)=1.           <a name='1009'>
                 cldm(i,k)=1.<a name='1010'>
                 cldmw(i,k)=1.<a name='1011'>
              end if<a name='1012'>
              <a name='1013'>
              if (qi(i,k).ge.qsmall) then             <a name='1014'>
                 cldm(i,k)=1.<a name='1015'>
                 icldm(i,k)=1.<a name='1016'>
              end if<a name='1017'>
              <a name='1018'>
           end if               <font color=#447700>! sub-columns<a name='1019'></font>
<a name='1020'>
<font color=#447700>! calculate nfice based on liquid and ice mmr (no rain and snow mmr available yet)<a name='1021'></font>
<a name='1022'>
        nfice(i,k)=0._r8<a name='1023'>
        dumfice=qc(i,k)+qi(i,k)<a name='1024'>
        if (dumfice.gt.qsmall .and. qi(i,k).gt.qsmall) then<a name='1025'>
           nfice(i,k)=qi(i,k)/dumfice<a name='1026'>
        endif<a name='1027'>
<a name='1028'>
	if (t(i,k).lt.tmelt - 5._r8) then<a name='1029'>
           if (liu_in) then <a name='1030'>
<a name='1031'>
<font color=#447700>! if aerosols interact with ice set number of activated ice nuclei<a name='1032'></font>
              dum2=naai(i,k)<a name='1033'>
<a name='1034'>
           else<a name='1035'>
<font color=#447700>! cooper curve (factor of 1000 is to convert from L-1 to m-3)<a name='1036'></font>
              dum2=0.005_r8*exp(0.304_r8*(273.15_r8-t(i,k)))*1000._r8<a name='1037'>
<font color=#447700>! put limit on number of nucleated crystals, set to number at T=-30 C<a name='1038'></font>
<font color=#447700>! cooper (limit to value at -35 C)<a name='1039'></font>
              dum2=min(dum,208.9e3_r8)/rho(i,k) <font color=#447700>! convert from m-3 to kg-1<a name='1040'></font>
           endif<a name='1041'>
<a name='1042'>
           dumnnuc=(dum2-ni(i,k)/icldm(i,k))/deltat*icldm(i,k)<a name='1043'>
           dumnnuc=max(dumnnuc,0._r8)<a name='1044'>
<font color=#447700>! get provisional ni and qi after nucleation in order to calculate<a name='1045'></font>
<font color=#447700>! Bergeron process below<a name='1046'></font>
           ninew=ni(i,k)+dumnnuc*deltat<a name='1047'>
           qinew=qi(i,k)+dumnnuc*deltat*mi0<a name='1048'>
<font color=#447700>!T&gt;268<a name='1049'></font>
        else<a name='1050'>
           ninew=ni(i,k)<a name='1051'>
           qinew=qi(i,k)<a name='1052'>
        end if<a name='1053'>
<a name='1054'>
<font color=#447700>! Initialize CME components<a name='1055'></font>
<a name='1056'>
  cme(i,k) = 0._r8<a name='1057'>
  cmei(i,k)=0._r8<a name='1058'>
<a name='1059'>
<a name='1060'>
<font color=#447700>!-------------------------------------------------------------------<a name='1061'></font>
<font color=#447700>!Bergeron process<a name='1062'></font>
<a name='1063'>
<font color=#447700>! make sure to initialize bergeron process to zero<a name='1064'></font>
       berg(i,k)=0._r8<a name='1065'>
       prd = 0._r8<a name='1066'>
<a name='1067'>
<font color=#447700>!condensation loop.<a name='1068'></font>
<a name='1069'>
<font color=#447700>! get in-cloud qi and ni after nucleation<a name='1070'></font>
       if (icldm(i,k) .gt. 0._r8) then <a name='1071'>
          qiic(i,k)=qinew/icldm(i,k)<a name='1072'>
          niic(i,k)=ninew/icldm(i,k)<a name='1073'>
       else<a name='1074'>
          qiic(i,k)=0._r8<a name='1075'>
          niic(i,k)=0._r8<a name='1076'>
       endif<a name='1077'>
<a name='1078'>
<font color=#447700>!if T &lt; 0 C then bergeron.<a name='1079'></font>
           if (t(i,k).lt.273.15) then<a name='1080'>
<font color=#447700>!if ice exists<a name='1081'></font>
              if (qi(i,k).gt.qsmall) then<a name='1082'>
<a name='1083'>
                 bergtsf = 0._r8 <font color=#447700>! bergeron time scale (fraction of timestep)<a name='1084'></font>
<a name='1085'>
                    qvi=epsqs*esi(i,k)/(p(i,k)-(1._r8-epsqs)*esi(i,k))<a name='1086'>
                    qvl=epsqs*esl(i,k)/(p(i,k)-(1._r8-epsqs)*esl(i,k))<a name='1087'>
<a name='1088'>
                    dqsidt =  xxls*qvi/(rv*t(i,k)**2)<a name='1089'>
                    abi = 1._r8+dqsidt*xxls/cpp<a name='1090'>
<a name='1091'>
<font color=#447700>! get ice size distribution parameters<a name='1092'></font>
<a name='1093'>
                    if (qiic(i,k).ge.qsmall) then<a name='1094'>
                       lami(k) = (cons1*ci* &amp;<a name='1095'>
                       niic(i,k)/qiic(i,k))**(1._r8/di)<a name='1096'>
                       n0i(k) = niic(i,k)*lami(k)<a name='1097'>
<a name='1098'>
<font color=#447700>! check for slope<a name='1099'></font>
<font color=#447700>! adjust vars<a name='1100'></font>
                       if (lami(k).lt.lammini) then<a name='1101'>
<a name='1102'>
                          lami(k) = lammini<a name='1103'>
                          n0i(k) = lami(k)**(di+1._r8)*qiic(i,k)/(ci*cons1)<a name='1104'>
                       else if (lami(k).gt.lammaxi) then<a name='1105'>
                          lami(k) = lammaxi<a name='1106'>
                          n0i(k) = lami(k)**(di+1._r8)*qiic(i,k)/(ci*cons1)<a name='1107'>
                       end if<a name='1108'>
                    <a name='1109'>
                       epsi = 2._r8*pi*n0i(k)*rho(i,k)*Dv(i,k) &amp;<a name='1110'>
                       /(lami(k)*lami(k))<a name='1111'>
<a name='1112'>
<font color=#447700>!if liquid exists  <a name='1113'></font>
                 if (qc(i,k).gt. qsmall) then <a name='1114'>
<a name='1115'>
<font color=#447700>!begin bergeron process<a name='1116'></font>
<font color=#447700>!     do bergeron (vapor deposition with RHw=1)<a name='1117'></font>
<font color=#447700>!     code to find berg (a rate) goes here<a name='1118'></font>
<a name='1119'>
<font color=#447700>! calculate Bergeron process<a name='1120'></font>
<a name='1121'>
                       prd = epsi*(qvl-qvi)/abi<a name='1122'>
                    <a name='1123'>
                    else<a name='1124'>
                       prd = 0._r8<a name='1125'>
                    end if<a name='1126'>
<a name='1127'>
<font color=#447700>! multiply by cloud fraction<a name='1128'></font>
<a name='1129'>
                    prd = prd*min(icldm(i,k),lcldm(i,k))<a name='1130'>
<a name='1131'>
<font color=#447700>!     transfer of existing cloud liquid to ice<a name='1132'></font>
<a name='1133'>
                    berg(i,k)=max(0._r8,prd)<a name='1134'>
<a name='1135'>
                 end if  <font color=#447700>!end liquid exists bergeron<a name='1136'></font>
<a name='1137'>
                 if (berg(i,k).gt.0._r8) then<a name='1138'>
                    bergtsf=max(0._r8,(qc(i,k)/berg(i,k))/deltat) <a name='1139'>
<a name='1140'>
                    if(bergtsf.lt.1._r8) berg(i,k) = max(0._r8,qc(i,k)/deltat)<a name='1141'>
<a name='1142'>
                 endif<a name='1143'>
<a name='1144'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1145'></font>
<a name='1146'>
                 if (bergtsf.lt.1._r8.or.icldm(i,k).gt.lcldm(i,k)) then<a name='1147'>
<a name='1148'>
			if (qiic(i,k).ge.qsmall) then<a name='1149'>
<a name='1150'>
<font color=#447700>! first case is for case when liquid water is present, but is completely depleted in time step, i.e., bergrsf &gt; 0 but &lt; 1<a name='1151'></font>
<a name='1152'>
		if (qc(i,k).ge.qsmall) then<a name='1153'>
                       rhin  = (1.0_r8 + relhum(i,k)) / 2._r8<a name='1154'>
                       if ((rhin*esl(i,k)/esi(i,k)) &gt; 1._r8) then<a name='1155'>
                          prd = epsi*(rhin*qvl-qvi)/abi<a name='1156'>
<a name='1157'>
<font color=#447700>! multiply by cloud fraction assuming liquid/ice maximum overlap<a name='1158'></font>
                          prd = prd*min(icldm(i,k),lcldm(i,k))<a name='1159'>
<a name='1160'>
<font color=#447700>! add to cmei<a name='1161'></font>
                          cmei(i,k) = cmei(i,k) + (prd * (1._r8- bergtsf))<a name='1162'>
<a name='1163'>
	                end if <font color=#447700>! rhin <a name='1164'></font>
	        end if <font color=#447700>! qc &gt; qsmall<a name='1165'></font>
<a name='1166'>
<font color=#447700>! second case is for pure ice cloud, either no liquid, or icldm &gt; lcldm<a name='1167'></font>
<a name='1168'>
		if (qc(i,k).lt.qsmall.or.icldm(i,k).gt.lcldm(i,k)) then<a name='1169'>
<a name='1170'>
<font color=#447700>! note: for case of no liquid, need to set liquid cloud fraction to zero<a name='1171'></font>
<font color=#447700>! store liquid cloud fraction in 'dum'<a name='1172'></font>
<a name='1173'>
			if (qc(i,k).lt.qsmall) then <a name='1174'>
			dum=0._r8 <a name='1175'>
			else<a name='1176'>
			dum=lcldm(i,k)<a name='1177'>
			end if<a name='1178'>
<a name='1179'>
<font color=#447700>! set RH to grid-mean value for pure ice cloud<a name='1180'></font>
                       rhin = relhum(i,k)<a name='1181'>
<a name='1182'>
                if ((rhin*esl(i,k)/esi(i,k)) &gt; 1._r8) then<a name='1183'>
<a name='1184'>
                       prd = epsi*(rhin*qvl-qvi)/abi<a name='1185'>
<a name='1186'>
<font color=#447700>! multiply by relevant cloud fraction for pure ice cloud<a name='1187'></font>
<font color=#447700>! assuming maximum overlap of liquid/ice<a name='1188'></font>
                       prd = prd*max((icldm(i,k)-dum),0._r8)<a name='1189'>
                       cmei(i,k) = cmei(i,k) + prd<a name='1190'>
<a name='1191'>
		end if <font color=#447700>! rhin<a name='1192'></font>
		end if <font color=#447700>! qc or icldm &gt; lcldm<a name='1193'></font>
	end if <font color=#447700>! qiic<a name='1194'></font>
	end if <font color=#447700>! bergtsf or icldm &gt; lcldm<a name='1195'></font>
<a name='1196'>
<font color=#447700>!     if deposition, it should not reduce grid mean rhi below 1.0<a name='1197'></font>
                 if(cmei(i,k) &gt; 0.0_r8 .and. (relhum(i,k)*esl(i,k)/esi(i,k)) &gt; 1._r8 ) &amp;<a name='1198'>
                  cmei(i,k)=min(cmei(i,k),(q(i,k)-qs(i)*esi(i,k)/esl(i,k))/abi/deltat)<a name='1199'>
<a name='1200'>
              end if            <font color=#447700>!end ice exists loop<a name='1201'></font>
   <font color=#447700>!this ends temperature &lt; 0. loop<a name='1202'></font>
<a name='1203'>
<font color=#447700>!-------------------------------------------------------------------<a name='1204'></font>
           end if  <font color=#447700>! <a name='1205'></font>
<font color=#447700>!..............................................................<a name='1206'></font>
<a name='1207'>
<font color=#447700>! evaporation should not exceed available water<a name='1208'></font>
<a name='1209'>
           if ((-berg(i,k)).lt.-qc(i,k)/deltat) &amp;<a name='1210'>
             berg(i,k) = max(qc(i,k)/deltat,0._r8)<a name='1211'>
<a name='1212'>
<font color=#447700>!sublimation process...<a name='1213'></font>
<a name='1214'>
            if ((relhum(i,k)*esl(i,k)/esi(i,k)).lt.1._r8 .and. qiic(i,k).ge.qsmall ) then<a name='1215'>
<a name='1216'>
               qvi=epsqs*esi(i,k)/(p(i,k)-(1._r8-epsqs)*esi(i,k))<a name='1217'>
               qvl=epsqs*esl(i,k)/(p(i,k)-(1._r8-epsqs)*esl(i,k))<a name='1218'>
               dqsidt =  xxls*qvi/(rv*t(i,k)**2)<a name='1219'>
               abi = 1._r8+dqsidt*xxls/cpp<a name='1220'>
<a name='1221'>
<font color=#447700>! get ice size distribution parameters<a name='1222'></font>
<a name='1223'>
               lami(k) = (cons1*ci* &amp;<a name='1224'>
               niic(i,k)/qiic(i,k))**(1._r8/di)<a name='1225'>
               n0i(k) = niic(i,k)*lami(k)<a name='1226'>
<a name='1227'>
<font color=#447700>! check for slope<a name='1228'></font>
<font color=#447700>! adjust vars<a name='1229'></font>
               if (lami(k).lt.lammini) then<a name='1230'>
                  <a name='1231'>
                  lami(k) = lammini<a name='1232'>
                  n0i(k) = lami(k)**(di+1._r8)*qiic(i,k)/(ci*cons1)<a name='1233'>
               else if (lami(k).gt.lammaxi) then<a name='1234'>
                  lami(k) = lammaxi<a name='1235'>
                  n0i(k) = lami(k)**(di+1._r8)*qiic(i,k)/(ci*cons1)<a name='1236'>
               end if<a name='1237'>
                    <a name='1238'>
               epsi = 2._r8*pi*n0i(k)*rho(i,k)*Dv(i,k) &amp;<a name='1239'>
               /(lami(k)*lami(k))<a name='1240'>
<a name='1241'>
<font color=#447700>! modify for ice fraction below<a name='1242'></font>
               prd = epsi*(relhum(i,k)*qvl-qvi)/abi * icldm(i,k)<a name='1243'>
               cmei(i,k)=min(prd,0._r8)<a name='1244'>
<a name='1245'>
            endif<a name='1246'>
<a name='1247'>
<font color=#447700>! sublimation should not exceed available ice<a name='1248'></font>
           if (cmei(i,k).lt.-qi(i,k)/deltat) &amp;<a name='1249'>
              cmei(i,k)=-qi(i,k)/deltat<a name='1250'>
<a name='1251'>
<font color=#447700>! sublimation should not increase grid mean rhi above 1.0 <a name='1252'></font>
           if(cmei(i,k) &lt; 0.0_r8 .and. (relhum(i,k)*esl(i,k)/esi(i,k)) &lt; 1._r8 ) &amp;<a name='1253'>
              cmei(i,k)=min(0._r8,max(cmei(i,k),(q(i,k)-qs(i)*esi(i,k)/esl(i,k))/abi/deltat))<a name='1254'>
<a name='1255'>
<font color=#447700>! limit cmei due for roundoff error<a name='1256'></font>
<a name='1257'>
           cmei(i,k)=cmei(i,k)*omsm<a name='1258'>
<a name='1259'>
<font color=#447700>! conditional for ice nucleation <a name='1260'></font>
<a name='1261'>
        if (t(i,k).lt.(tmelt - 5._r8)) then <a name='1262'>
          if ( liu_in ) then <a name='1263'>
<a name='1264'>
<font color=#447700>! using Liu et al. (2007) ice nucleation with hooks into simulated aerosol<a name='1265'></font>
<font color=#447700>! ice nucleation rate (dum2) has already been calculated and read in (naai)<a name='1266'></font>
<a name='1267'>
             dum2i(i,k)=naai(i,k)<a name='1268'>
          else<a name='1269'>
<a name='1270'>
<font color=#447700>! cooper curve (factor of 1000 is to convert from L-1 to m-3)<a name='1271'></font>
              dum2i(i,k)=0.005_r8*exp(0.304_r8*(273.15_r8-t(i,k)))*1000._r8<a name='1272'>
<font color=#447700>! put limit on number of nucleated crystals, set to number at T=-30 C<a name='1273'></font>
<font color=#447700>! cooper (limit to value at -35 C)<a name='1274'></font>
              dum2i(i,k)=min(dum2i(i,k),208.9e3_r8)/rho(i,k) <font color=#447700>! convert from m-3 to kg-1<a name='1275'></font>
           endif<a name='1276'>
        else<a name='1277'>
           dum2i(i,k)=0._r8<a name='1278'>
	end if<a name='1279'>
<a name='1280'>
	end do <font color=#447700>! i loop<a name='1281'></font>
	end do <font color=#447700>! k loop<a name='1282'></font>
<a name='1283'>
 <a name='1284'>
     cldo(:ncol,:)=cldn(:ncol,:)<a name='1285'>
<a name='1286'>
<font color=#447700>!! initialize sub-step precip flux variables<a name='1287'></font>
	do i=1,ncol<a name='1288'>
	   <font color=#447700>!! flux is zero at top interface, so these should stay as 0.<a name='1289'></font>
           rflx1(i,1)=0._r8<a name='1290'>
           sflx1(i,1)=0._r8<a name='1291'>
	do k=1,pver<a name='1292'>
<a name='1293'>
	   <font color=#447700>! initialize normal and sub-step precip flux variables<a name='1294'></font>
           rflx1(i,k+1)=0._r8<a name='1295'>
           sflx1(i,k+1)=0._r8<a name='1296'>
	end do <font color=#447700>! i loop<a name='1297'></font>
	end do <font color=#447700>! k loop<a name='1298'></font>
<font color=#447700>!! initialize final precip flux variables.<a name='1299'></font>
	do i=1,ncol<a name='1300'>
	   <font color=#447700>!! flux is zero at top interface, so these should stay as 0.<a name='1301'></font>
           rflx(i,1)=0._r8<a name='1302'>
           sflx(i,1)=0._r8<a name='1303'>
	do k=1,pver<a name='1304'>
	   <font color=#447700>! initialize normal and sub-step precip flux variables<a name='1305'></font>
           rflx(i,k+1)=0._r8<a name='1306'>
           sflx(i,k+1)=0._r8<a name='1307'>
	end do <font color=#447700>! i loop<a name='1308'></font>
	end do <font color=#447700>! k loop	<a name='1309'></font>
<a name='1310'>
	do i=1,ncol<a name='1311'>
	ltrue(i)=0<a name='1312'>
	do k=1,pver<a name='1313'>
<font color=#447700>! skip microphysical calculations if no cloud water<a name='1314'></font>
<a name='1315'>
	if (qc(i,k).ge.qsmall.or.qi(i,k).ge.qsmall.or.cmei(i,k).ge.qsmall) ltrue(i)=1<a name='1316'>
	end do<a name='1317'>
	end do<a name='1318'>
<a name='1319'>
<font color=#447700>! assign number of sub-steps to iter<a name='1320'></font>
<font color=#447700>! use 2 sub-steps, following tests described in MG2008<a name='1321'></font>
	iter = 2<a name='1322'>
<a name='1323'>
<font color=#447700>! get sub-step time step<a name='1324'></font>
	deltat=deltat/real(iter)<a name='1325'>
<a name='1326'>
<font color=#447700>! since activation/nucleation processes are fast, need to take into account<a name='1327'></font>
<font color=#447700>! factor mtime = mixing timescale in cloud / model time step<a name='1328'></font>
<font color=#447700>! mixing time can be interpreted as cloud depth divided by sub-grid vertical velocity<a name='1329'></font>
<font color=#447700>! for now mixing timescale is assumed to be 1 timestep for modal aerosols, 20 min bulk<a name='1330'></font>
<a name='1331'>
<font color=#447700>!        note: mtime for bulk aerosols was set to: mtime=deltat/1200._r8<a name='1332'></font>
<a name='1333'>
        mtime=1._r8<a name='1334'>
        rate1ord_cw2pr_st(:,:)=0._r8 <font color=#447700>! rce 2010/05/01<a name='1335'></font>
<a name='1336'>
<font color=#447700>!!!! skip calculations if no cloud water<a name='1337'></font>
	do i=1,ncol<a name='1338'>
	if (ltrue(i).eq.0) then<a name='1339'>
           tlat(i,1:pver)=0._r8<a name='1340'>
           qvlat(i,1:pver)=0._r8<a name='1341'>
           qctend(i,1:pver)=0._r8<a name='1342'>
           qitend(i,1:pver)=0._r8<a name='1343'>
           qnitend(i,1:pver)=0._r8<a name='1344'>
           qrtend(i,1:pver)=0._r8<a name='1345'>
           nctend(i,1:pver)=0._r8<a name='1346'>
           nitend(i,1:pver)=0._r8<a name='1347'>
           nrtend(i,1:pver)=0._r8<a name='1348'>
           nstend(i,1:pver)=0._r8<a name='1349'>
           prect(i)=0._r8<a name='1350'>
           preci(i)=0._r8<a name='1351'>
           qniic(i,1:pver)=0._r8<a name='1352'>
           qric(i,1:pver)=0._r8<a name='1353'>
           nsic(i,1:pver)=0._r8<a name='1354'>
           nric(i,1:pver)=0._r8<a name='1355'>
           rainrt(i,1:pver)=0._r8<a name='1356'>
	goto 300<a name='1357'>
	end if<a name='1358'>
<a name='1359'>
        qcsinksum_rate1ord(1:pver)=0._r8 <a name='1360'>
        qcsum_rate1ord(1:pver)=0._r8 <a name='1361'>
<a name='1362'>
<a name='1363'>
<font color=#447700>!!!!!!!!! begin sub-step!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1364'></font>
<font color=#447700>!.....................................................................................................<a name='1365'></font>
	do it=1,iter<a name='1366'>
<a name='1367'>
<font color=#447700>! initialize sub-step microphysical tendencies<a name='1368'></font>
<a name='1369'>
	tlat(i,1:pver)=0._r8<a name='1370'>
	qvlat(i,1:pver)=0._r8<a name='1371'>
	qctend(i,1:pver)=0._r8<a name='1372'>
	qitend(i,1:pver)=0._r8<a name='1373'>
	qnitend(i,1:pver)=0._r8<a name='1374'>
	qrtend(i,1:pver)=0._r8<a name='1375'>
	nctend(i,1:pver)=0._r8<a name='1376'>
	nitend(i,1:pver)=0._r8<a name='1377'>
	nrtend(i,1:pver)=0._r8<a name='1378'>
	nstend(i,1:pver)=0._r8<a name='1379'>
<a name='1380'>
<font color=#447700>! initialize diagnostic precipitation to zero<a name='1381'></font>
<a name='1382'>
        qniic(i,1:pver)=0._r8<a name='1383'>
        qric(i,1:pver)=0._r8<a name='1384'>
        nsic(i,1:pver)=0._r8<a name='1385'>
        nric(i,1:pver)=0._r8<a name='1386'>
 <a name='1387'>
        rainrt(i,1:pver)=0._r8<a name='1388'>
<a name='1389'>
<a name='1390'>
<font color=#447700>! begin new i,k loop, calculate new cldmax after adjustment to cldm above<a name='1391'></font>
<a name='1392'>
<font color=#447700>! initialize vertically-integrated rain and snow tendencies<a name='1393'></font>
<a name='1394'>
	   qrtot = 0._r8<a name='1395'>
	   nrtot = 0._r8<a name='1396'>
	   qstot = 0._r8<a name='1397'>
	   nstot = 0._r8<a name='1398'>
<a name='1399'>
<font color=#447700>! initialize precip at surface<a name='1400'></font>
<a name='1401'>
	   prect(i)=0._r8<a name='1402'>
	   preci(i)=0._r8<a name='1403'>
<a name='1404'>
	   do k=1,pver<a name='1405'>
<a name='1406'>
<font color=#447700>! set cwml and cwmi to current qc and qi<a name='1407'></font>
<a name='1408'>
	   cwml(i,k)=qc(i,k)<a name='1409'>
	   cwmi(i,k)=qi(i,k)<a name='1410'>
<a name='1411'>
<font color=#447700>! initialize precip fallspeeds to zero<a name='1412'></font>
<a name='1413'>
	   ums(k)=0._r8 <a name='1414'>
	   uns(k)=0._r8 <a name='1415'>
	   umr(k)=0._r8 <a name='1416'>
	   unr(k)=0._r8<a name='1417'>
<a name='1418'>
<font color=#447700>! calculate precip fraction based on maximum overlap assumption<a name='1419'></font>
<a name='1420'>
<font color=#447700>! for sub-columns cldm has already been set to 1 if cloud<a name='1421'></font>
<font color=#447700>! water or ice is present, so cldmax will be correctly set below<a name='1422'></font>
<font color=#447700>! and nothing extra needs to be done here<a name='1423'></font>
<a name='1424'>
           if (k.eq.1) then<a name='1425'>
		cldmax(i,k)=cldm(i,k)<a name='1426'>
	   else<a name='1427'>
<font color=#447700>! if rain or snow mix ratio is smaller than<a name='1428'></font>
<font color=#447700>! threshold, then set cldmax to cloud fraction at current level<a name='1429'></font>
	   if (qric(i,k-1).ge.qsmall.or.qniic(i,k-1).ge.qsmall) then<a name='1430'>
                cldmax(i,k)=max(cldmax(i,k-1),cldm(i,k))<a name='1431'>
	   else<a name='1432'>
	   cldmax(i,k)=cldm(i,k)<a name='1433'>
	   end if<a name='1434'>
	   end if<a name='1435'>
<a name='1436'>
<font color=#447700>! decrease in number concentration due to sublimation/evap<a name='1437'></font>
<font color=#447700>! divide by cloud fraction to get in-cloud decrease<a name='1438'></font>
<font color=#447700>! don't reduce Nc due to bergeron process<a name='1439'></font>
<a name='1440'>
           if (cmei(i,k) &lt; 0._r8 .and. qi(i,k) &gt; qsmall .and. cldm(i,k) &gt; mincld) then<a name='1441'>
              nsubi(k)=cmei(i,k)/qi(i,k)*ni(i,k)/cldm(i,k)<a name='1442'>
	   else<a name='1443'>
              nsubi(k)=0._r8<a name='1444'>
           end if<a name='1445'>
           nsubc(k)=0._r8<a name='1446'>
<a name='1447'>
<a name='1448'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='1449'></font>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='1450'></font>
<a name='1451'>
<font color=#447700>! ice nucleation if activated nuclei exist at t&lt;-5C AND rhmini + 5%<a name='1452'></font>
<a name='1453'>
        if (dum2i(i,k).gt.0._r8.and.t(i,k).lt.(tmelt - 5._r8).and. &amp;<a name='1454'>
	   relhum(i,k)*esl(i,k)/esi(i,k).gt. rhmini+0.05_r8) then<a name='1455'>
<a name='1456'>
<font color=#447700>!if NCAI &gt; 0. then set numice = ncai (as before)<a name='1457'></font>
<font color=#447700>!note: this is gridbox averaged<a name='1458'></font>
<a name='1459'>
              nnuccd(k)=(dum2i(i,k)-ni(i,k)/icldm(i,k))/deltat*icldm(i,k)<a name='1460'>
              nnuccd(k)=max(nnuccd(k),0._r8)<a name='1461'>
              nimax = dum2i(i,k)*icldm(i,k)<a name='1462'>
<a name='1463'>
<font color=#447700>!Calc mass of new particles using new crystal mass...<a name='1464'></font>
<font color=#447700>!also this will be multiplied by mtime as nnuccd is...<a name='1465'></font>
<a name='1466'>
              mnuccd(k) = nnuccd(k) * mi0<a name='1467'>
<a name='1468'>
<font color=#447700>!  add mnuccd to cmei....<a name='1469'></font>
              cmei(i,k)= cmei(i,k) + mnuccd(k) * mtime<a name='1470'>
<a name='1471'>
<font color=#447700>!  limit cmei<a name='1472'></font>
<a name='1473'>
               qvi=epsqs*esi(i,k)/(p(i,k)-(1._r8-epsqs)*esi(i,k))<a name='1474'>
               dqsidt =  xxls*qvi/(rv*t(i,k)**2)<a name='1475'>
               abi = 1._r8+dqsidt*xxls/cpp<a name='1476'>
              cmei(i,k)=min(cmei(i,k),(q(i,k)-qvi)/abi/deltat)<a name='1477'>
<a name='1478'>
<font color=#447700>! limit for roundoff error<a name='1479'></font>
              cmei(i,k)=cmei(i,k)*omsm<a name='1480'>
<a name='1481'>
           else<a name='1482'>
              nnuccd(k)=0._r8<a name='1483'>
	      nimax = 0._r8<a name='1484'>
              mnuccd(k) = 0._r8<a name='1485'>
           end if<a name='1486'>
<a name='1487'>
<font color=#447700>!c............................................................................<a name='1488'></font>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='1489'></font>
<font color=#447700>! obtain in-cloud values of cloud water/ice mixing ratios and number concentrations<a name='1490'></font>
<font color=#447700>! for microphysical process calculations<a name='1491'></font>
<font color=#447700>! units are kg/kg for mixing ratio, 1/kg for number conc<a name='1492'></font>
<a name='1493'>
<font color=#447700>! limit in-cloud values to 0.005 kg/kg<a name='1494'></font>
<a name='1495'>
           qcic(i,k)=min(cwml(i,k)/lcldm(i,k),5.e-3_r8)<a name='1496'>
           qiic(i,k)=min(cwmi(i,k)/icldm(i,k),5.e-3_r8)<a name='1497'>
           ncic(i,k)=max(nc(i,k)/lcldm(i,k),0._r8)<a name='1498'>
           niic(i,k)=max(ni(i,k)/icldm(i,k),0._r8)<a name='1499'>
<a name='1500'>
           if (qc(i,k) - berg(i,k)*deltat.lt.qsmall) then<a name='1501'>
              qcic(i,k)=0._r8<a name='1502'>
              ncic(i,k)=0._r8<a name='1503'>
              if (qc(i,k)-berg(i,k)*deltat.lt.0._r8) then<a name='1504'>
                 berg(i,k)=qc(i,k)/deltat*omsm<a name='1505'>
              end if<a name='1506'>
	   end if<a name='1507'>
<a name='1508'>
	   if (qi(i,k)+(cmei(i,k)+berg(i,k))*deltat.lt.qsmall) then<a name='1509'>
	   qiic(i,k)=0._r8<a name='1510'>
	   niic(i,k)=0._r8<a name='1511'>
	   if (qi(i,k)+(cmei(i,k)+berg(i,k))*deltat.lt.0._r8) then<a name='1512'>
	   cmei(i,k)=(-qi(i,k)/deltat-berg(i,k))*omsm<a name='1513'>
	   end if<a name='1514'>
	   end if<a name='1515'>
<a name='1516'>
<font color=#447700>! add to cme output<a name='1517'></font>
<a name='1518'>
           cmeout(i,k) = cmeout(i,k)+cmei(i,k)<a name='1519'>
<a name='1520'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='1521'></font>
<font color=#447700>! droplet activation<a name='1522'></font>
<font color=#447700>! calculate potential for droplet activation if cloud water is present<a name='1523'></font>
<font color=#447700>! formulation from Abdul-Razzak and Ghan (2000) and Abdul-Razzak et al. (1998), AR98<a name='1524'></font>
<font color=#447700>! number tendency (npccnin) is read in from companion routine<a name='1525'></font>
<a name='1526'>
<font color=#447700>! assume aerosols already activated are equal to number of existing droplets for simplicity<a name='1527'></font>
<font color=#447700>! multiply by cloud fraction to obtain grid-average tendency<a name='1528'></font>
<a name='1529'>
           if (qcic(i,k).ge.qsmall) then   <a name='1530'>
              npccn(k) = max(0._r8,npccnin(i,k))  <a name='1531'>
	      dum2l(i,k)=(nc(i,k)+npccn(k)*deltat)/lcldm(i,k)<a name='1532'>
              dum2l(i,k)=max(dum2l(i,k),cdnl/rho(i,k)) <font color=#447700>! sghan minimum in #/cm3  <a name='1533'></font>
	      ncmax = dum2l(i,k)*lcldm(i,k)<a name='1534'>
           else<a name='1535'>
              npccn(k)=0._r8<a name='1536'>
              dum2l(i,k)=0._r8<a name='1537'>
              ncmax = 0._r8<a name='1538'>
           end if <a name='1539'>
<a name='1540'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='1541'></font>
<font color=#447700>! get size distribution parameters based on in-cloud cloud water/ice <a name='1542'></font>
<font color=#447700>! these calculations also ensure consistency between number and mixing ratio<a name='1543'></font>
<font color=#447700>!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='1544'></font>
<a name='1545'>
<font color=#447700>!......................................................................<a name='1546'></font>
<font color=#447700>! cloud ice<a name='1547'></font>
<a name='1548'>
	if (qiic(i,k).ge.qsmall) then<a name='1549'>
<a name='1550'>
<font color=#447700>! add upper limit to in-cloud number concentration to prevent numerical error<a name='1551'></font>
	niic(i,k)=min(niic(i,k),qiic(i,k)*1.e20_r8)<a name='1552'>
<a name='1553'>
	lami(k) = (cons1*ci* &amp;<a name='1554'>
              niic(i,k)/qiic(i,k))**(1._r8/di)<a name='1555'>
	n0i(k) = niic(i,k)*lami(k)<a name='1556'>
<a name='1557'>
<font color=#447700>! check for slope<a name='1558'></font>
<font color=#447700>! adjust vars<a name='1559'></font>
<a name='1560'>
	if (lami(k).lt.lammini) then<a name='1561'>
<a name='1562'>
	lami(k) = lammini<a name='1563'>
	n0i(k) = lami(k)**(di+1._r8)*qiic(i,k)/(ci*cons1)<a name='1564'>
	niic(i,k) = n0i(k)/lami(k)<a name='1565'>
	else if (lami(k).gt.lammaxi) then<a name='1566'>
	lami(k) = lammaxi<a name='1567'>
	n0i(k) = lami(k)**(di+1._r8)*qiic(i,k)/(ci*cons1)<a name='1568'>
        niic(i,k) = n0i(k)/lami(k)<a name='1569'>
	end if<a name='1570'>
<a name='1571'>
	else<a name='1572'>
	lami(k) = 0._r8<a name='1573'>
	n0i(k) = 0._r8<a name='1574'>
	end if<a name='1575'>
<a name='1576'>
	if (qcic(i,k).ge.qsmall) then<a name='1577'>
<a name='1578'>
<font color=#447700>! add upper limit to in-cloud number concentration to prevent numerical error<a name='1579'></font>
	ncic(i,k)=min(ncic(i,k),qcic(i,k)*1.e20_r8)<a name='1580'>
<a name='1581'>
        ncic(i,k)=max(ncic(i,k),cdnl/rho(i,k)) <font color=#447700>! sghan minimum in #/cm  <a name='1582'></font>
<a name='1583'>
<font color=#447700>! get pgam from fit to observations of martin et al. 1994<a name='1584'></font>
<a name='1585'>
        pgam(k)=0.0005714_r8*(ncic(i,k)/1.e6_r8*rho(i,k))+0.2714_r8<a name='1586'>
        pgam(k)=1._r8/(pgam(k)**2)-1._r8<a name='1587'>
        pgam(k)=max(pgam(k),2._r8)<a name='1588'>
        pgam(k)=min(pgam(k),15._r8)<a name='1589'>
<a name='1590'>
<font color=#447700>! calculate lamc<a name='1591'></font>
<a name='1592'>
	lamc(k) = (pi/6._r8*rhow*ncic(i,k)*gamma(pgam(k)+4._r8)/ &amp;<a name='1593'>
                 (qcic(i,k)*gamma(pgam(k)+1._r8)))**(1._r8/3._r8)<a name='1594'>
<a name='1595'>
<font color=#447700>! lammin, 50 micron diameter max mean size<a name='1596'></font>
<a name='1597'>
	lammin = (pgam(k)+1._r8)/50.e-6_r8<a name='1598'>
	lammax = (pgam(k)+1._r8)/2.e-6_r8<a name='1599'>
<a name='1600'>
	if (lamc(k).lt.lammin) then<a name='1601'>
	lamc(k) = lammin<a name='1602'>
	ncic(i,k) = 6._r8*lamc(k)**3*qcic(i,k)* &amp;<a name='1603'>
                gamma(pgam(k)+1._r8)/ &amp;<a name='1604'>
               (pi*rhow*gamma(pgam(k)+4._r8))<a name='1605'>
	else if (lamc(k).gt.lammax) then<a name='1606'>
	lamc(k) = lammax<a name='1607'>
	ncic(i,k) = 6._r8*lamc(k)**3*qcic(i,k)* &amp;<a name='1608'>
                gamma(pgam(k)+1._r8)/ &amp;<a name='1609'>
               (pi*rhow*gamma(pgam(k)+4._r8))<a name='1610'>
	end if<a name='1611'>
<a name='1612'>
<font color=#447700>! parameter to calculate droplet freezing<a name='1613'></font>
<a name='1614'>
        cdist1(k) = ncic(i,k)/gamma(pgam(k)+1._r8) <a name='1615'>
<a name='1616'>
	else<a name='1617'>
	lamc(k) = 0._r8<a name='1618'>
        cdist1(k) = 0._r8<a name='1619'>
	end if<a name='1620'>
<a name='1621'>
<font color=#447700>!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='1622'></font>
<font color=#447700>!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='1623'></font>
<font color=#447700>! begin micropysical process calculations <a name='1624'></font>
<font color=#447700>!.................................................................<a name='1625'></font>
<font color=#447700>! autoconversion of cloud liquid water to rain<a name='1626'></font>
<font color=#447700>! formula from Khrouditnov and Kogan (2000), modified for sub-grid distribution of qc<a name='1627'></font>
<font color=#447700>! minimum qc of 1 x 10^-8 prevents floating point error<a name='1628'></font>
<a name='1629'>
	if (qcic(i,k).ge.1.e-8_r8) then<a name='1630'>
<a name='1631'>
<font color=#447700>! nprc is increase in rain number conc due to autoconversion<a name='1632'></font>
<font color=#447700>! nprc1 is decrease in cloud droplet conc due to autoconversion<a name='1633'></font>
<a name='1634'>
<font color=#447700>! assume exponential sub-grid distribution of qc, resulting in additional<a name='1635'></font>
<font color=#447700>! factor related to qcvar below<a name='1636'></font>
<a name='1637'>
 <font color=#447700>! hm switch for sub-columns, don't include sub-grid qc<a name='1638'></font>
           if (sub_column) then<a name='1639'>
 <a name='1640'>
              prc(k) = 1350._r8*qcic(i,k)**2.47_r8* &amp;<a name='1641'>
              (ncic(i,k)/1.e6_r8*rho(i,k))**(-1.79_r8)<a name='1642'>
              nprc(k) = prc(k)/(4._r8/3._r8*pi*rhow*(25.e-6_r8)**3)<a name='1643'>
              nprc1(k) = prc(k)/(qcic(i,k)/ncic(i,k))<a name='1644'>
 <a name='1645'>
           else<a name='1646'>
<a name='1647'>
              prc(k) = cons2/(cons3*cons18)*1350._r8*qcic(i,k)**2.47_r8* &amp;<a name='1648'>
              (ncic(i,k)/1.e6_r8*rho(i,k))**(-1.79_r8)<a name='1649'>
              nprc(k) = prc(k)/cons22<a name='1650'>
              nprc1(k) = prc(k)/(qcic(i,k)/ncic(i,k))<a name='1651'>
 <a name='1652'>
           end if               <font color=#447700>! sub-column switch<a name='1653'></font>
<a name='1654'>
        else<a name='1655'>
           prc(k)=0._r8<a name='1656'>
           nprc(k)=0._r8<a name='1657'>
	   nprc1(k)=0._r8<a name='1658'>
	end if<a name='1659'>
 <a name='1660'>
<font color=#447700>! add autoconversion to precip from above to get provisional rain mixing ratio<a name='1661'></font>
<font color=#447700>! and number concentration (qric and nric)<a name='1662'></font>
<a name='1663'>
<font color=#447700>! 0.45 m/s is fallspeed of new rain drop (80 micron diameter)<a name='1664'></font>
<a name='1665'>
	dum=0.45_r8<a name='1666'>
	dum1=0.45_r8<a name='1667'>
<a name='1668'>
	if (k.eq.1) then<a name='1669'>
	qric(i,k)=prc(k)*lcldm(i,k)*dz(i,k)/cldmax(i,k)/dum<a name='1670'>
	nric(i,k)=nprc(k)*lcldm(i,k)*dz(i,k)/cldmax(i,k)/dum<a name='1671'>
	else<a name='1672'>
	if (qric(i,k-1).ge.qsmall) then<a name='1673'>
	dum=umr(k-1)<a name='1674'>
	dum1=unr(k-1)<a name='1675'>
	end if<a name='1676'>
<a name='1677'>
<font color=#447700>! no autoconversion of rain number if rain/snow falling from above<a name='1678'></font>
<font color=#447700>! this assumes that new drizzle drops formed by autoconversion are rapidly collected<a name='1679'></font>
<font color=#447700>! by the existing rain/snow particles from above<a name='1680'></font>
<a name='1681'>
	if (qric(i,k-1).ge.1.e-9_r8.or.qniic(i,k-1).ge.1.e-9_r8) then<a name='1682'>
	nprc(k)=0._r8<a name='1683'>
	end if<a name='1684'>
<a name='1685'>
        qric(i,k) = (rho(i,k-1)*umr(k-1)*qric(i,k-1)*cldmax(i,k-1)+ &amp;<a name='1686'>
         (rho(i,k)*dz(i,k)*((pra(k-1)+prc(k))*lcldm(i,k)+(pre(k-1)-pracs(k-1)-mnuccr(k-1))*cldmax(i,k))))&amp;<a name='1687'>
                   /(dum*rho(i,k)*cldmax(i,k))<a name='1688'>
	nric(i,k) = (rho(i,k-1)*unr(k-1)*nric(i,k-1)*cldmax(i,k-1)+ &amp;<a name='1689'>
         (rho(i,k)*dz(i,k)*(nprc(k)*lcldm(i,k)+(nsubr(k-1)-npracs(k-1)-nnuccr(k-1)+nragg(k-1))*cldmax(i,k))))&amp;<a name='1690'>
                   /(dum1*rho(i,k)*cldmax(i,k))<a name='1691'>
<a name='1692'>
	end if<a name='1693'>
<a name='1694'>
<font color=#447700>!.......................................................................<a name='1695'></font>
<font color=#447700>! Autoconversion of cloud ice to snow<a name='1696'></font>
<font color=#447700>! similar to Ferrier (1994)<a name='1697'></font>
<a name='1698'>
	if (t(i,k).le.273.15_r8.and.qiic(i,k).ge.qsmall) then<a name='1699'>
<a name='1700'>
<font color=#447700>! note: assumes autoconversion timescale of 180 sec<a name='1701'></font>
<a name='1702'>
           nprci(k) = n0i(k)/(lami(k)*180._r8)*exp(-lami(k)*dcs)<a name='1703'>
<a name='1704'>
           prci(k) = pi*rhoi*n0i(k)/(6._r8*180._r8)* &amp;<a name='1705'>
              (cons23/lami(k)+3._r8*cons24/lami(k)**2+ &amp;<a name='1706'>
          6._r8*dcs/lami(k)**3+6._r8/lami(k)**4)*exp(-lami(k)*dcs)          <a name='1707'>
<a name='1708'>
        else<a name='1709'>
              prci(k)=0._r8<a name='1710'>
              nprci(k)=0._r8<a name='1711'>
	end if<a name='1712'>
<a name='1713'>
<font color=#447700>! add autoconversion to flux from level above to get provisional snow mixing ratio<a name='1714'></font>
<font color=#447700>! and number concentration (qniic and nsic)<a name='1715'></font>
<a name='1716'>
	dum=(asn(i,k)*cons25)<a name='1717'>
	dum1=(asn(i,k)*cons25)<a name='1718'>
<a name='1719'>
	if (k.eq.1) then<a name='1720'>
           qniic(i,k)=prci(k)*icldm(i,k)*dz(i,k)/cldmax(i,k)/dum<a name='1721'>
           nsic(i,k)=nprci(k)*icldm(i,k)*dz(i,k)/cldmax(i,k)/dum<a name='1722'>
	else<a name='1723'>
	if (qniic(i,k-1).ge.qsmall) then<a name='1724'>
	dum=ums(k-1)<a name='1725'>
	dum1=uns(k-1)<a name='1726'>
	end if<a name='1727'>
<a name='1728'>
        qniic(i,k) = (rho(i,k-1)*ums(k-1)*qniic(i,k-1)*cldmax(i,k-1)+ &amp;<a name='1729'>
         (rho(i,k)*dz(i,k)*((prci(k)+prai(k-1)+psacws(k-1)+bergs(k-1))*icldm(i,k)+(prds(k-1)+ &amp;<a name='1730'>
         pracs(k-1)+mnuccr(k-1))*cldmax(i,k))))&amp;<a name='1731'>
                    /(dum*rho(i,k)*cldmax(i,k))<a name='1732'>
<a name='1733'>
	nsic(i,k) = (rho(i,k-1)*uns(k-1)*nsic(i,k-1)*cldmax(i,k-1)+ &amp;<a name='1734'>
         (rho(i,k)*dz(i,k)*(nprci(k)*icldm(i,k)+(nsubs(k-1)+nsagg(k-1)+nnuccr(k-1))*cldmax(i,k))))&amp;<a name='1735'>
                   /(dum1*rho(i,k)*cldmax(i,k))<a name='1736'>
<a name='1737'>
	end if<a name='1738'>
<a name='1739'>
<font color=#447700>! if precip mix ratio is zero so should number concentration<a name='1740'></font>
<a name='1741'>
	if (qniic(i,k).lt.qsmall) then<a name='1742'>
	qniic(i,k)=0._r8<a name='1743'>
	nsic(i,k)=0._r8<a name='1744'>
	end if<a name='1745'>
<a name='1746'>
	if (qric(i,k).lt.qsmall) then<a name='1747'>
	qric(i,k)=0._r8<a name='1748'>
	nric(i,k)=0._r8<a name='1749'>
	end if<a name='1750'>
<a name='1751'>
<font color=#447700>! make sure number concentration is a positive number to avoid <a name='1752'></font>
<font color=#447700>! taking root of negative later<a name='1753'></font>
<a name='1754'>
	nric(i,k)=max(nric(i,k),0._r8)<a name='1755'>
	nsic(i,k)=max(nsic(i,k),0._r8)<a name='1756'>
<a name='1757'>
<font color=#447700>!.......................................................................<a name='1758'></font>
<font color=#447700>! get size distribution parameters for precip<a name='1759'></font>
<font color=#447700>!......................................................................<a name='1760'></font>
<font color=#447700>! rain<a name='1761'></font>
<a name='1762'>
	if (qric(i,k).ge.qsmall) then<a name='1763'>
	lamr(k) = (pi*rhow*nric(i,k)/qric(i,k))**(1._r8/3._r8)<a name='1764'>
	n0r(k) = nric(i,k)*lamr(k)<a name='1765'>
<a name='1766'>
<font color=#447700>! check for slope<a name='1767'></font>
<font color=#447700>! adjust vars<a name='1768'></font>
<a name='1769'>
	if (lamr(k).lt.lamminr) then<a name='1770'>
<a name='1771'>
	lamr(k) = lamminr<a name='1772'>
<a name='1773'>
	n0r(k) = lamr(k)**4*qric(i,k)/(pi*rhow)<a name='1774'>
	nric(i,k) = n0r(k)/lamr(k)<a name='1775'>
	else if (lamr(k).gt.lammaxr) then<a name='1776'>
	lamr(k) = lammaxr<a name='1777'>
	n0r(k) = lamr(k)**4*qric(i,k)/(pi*rhow)<a name='1778'>
	nric(i,k) = n0r(k)/lamr(k)<a name='1779'>
	end if<a name='1780'>
<a name='1781'>
<font color=#447700>! provisional rain number and mass weighted mean fallspeed (m/s)<a name='1782'></font>
<a name='1783'>
        unr(k) = min(arn(i,k)*cons4/lamr(k)**br,9.1_r8*rhof(i,k))<a name='1784'>
        umr(k) = min(arn(i,k)*cons5/(6._r8*lamr(k)**br),9.1_r8*rhof(i,k))<a name='1785'>
<a name='1786'>
	else<a name='1787'>
	lamr(k) = 0._r8<a name='1788'>
	n0r(k) = 0._r8<a name='1789'>
	umr(k) = 0._r8<a name='1790'>
	unr(k) = 0._r8<a name='1791'>
	end if<a name='1792'>
<a name='1793'>
<font color=#447700>!......................................................................<a name='1794'></font>
<font color=#447700>! snow<a name='1795'></font>
<a name='1796'>
	if (qniic(i,k).ge.qsmall) then<a name='1797'>
	lams(k) = (cons6*cs*nsic(i,k)/ &amp;<a name='1798'>
            qniic(i,k))**(1._r8/ds)<a name='1799'>
	n0s(k) = nsic(i,k)*lams(k)<a name='1800'>
<a name='1801'>
<font color=#447700>! check for slope<a name='1802'></font>
<font color=#447700>! adjust vars<a name='1803'></font>
<a name='1804'>
	if (lams(k).lt.lammins) then<a name='1805'>
	lams(k) = lammins<a name='1806'>
	n0s(k) = lams(k)**(ds+1._r8)*qniic(i,k)/(cs*cons6)<a name='1807'>
	nsic(i,k) = n0s(k)/lams(k)<a name='1808'>
<a name='1809'>
	else if (lams(k).gt.lammaxs) then<a name='1810'>
	lams(k) = lammaxs<a name='1811'>
	n0s(k) = lams(k)**(ds+1._r8)*qniic(i,k)/(cs*cons6)<a name='1812'>
	nsic(i,k) = n0s(k)/lams(k)<a name='1813'>
	end if<a name='1814'>
<a name='1815'>
<font color=#447700>! provisional snow number and mass weighted mean fallspeed (m/s)<a name='1816'></font>
<a name='1817'>
        ums(k) = min(asn(i,k)*cons8/(6._r8*lams(k)**bs),1.2_r8*rhof(i,k))<a name='1818'>
        uns(k) = min(asn(i,k)*cons7/lams(k)**bs,1.2_r8*rhof(i,k))<a name='1819'>
<a name='1820'>
	else<a name='1821'>
	lams(k) = 0._r8<a name='1822'>
	n0s(k) = 0._r8<a name='1823'>
	ums(k) = 0._r8<a name='1824'>
	uns(k) = 0._r8<a name='1825'>
	end if<a name='1826'>
<a name='1827'>
<font color=#447700>!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='1828'></font>
<a name='1829'>
<font color=#447700>! heterogeneous freezing of cloud water<a name='1830'></font>
<a name='1831'>
	if (qcic(i,k).ge.qsmall .and. t(i,k).lt.269.15_r8) then<a name='1832'>
<a name='1833'>
<font color=#447700>! immersion freezing (Bigg, 1953)<a name='1834'></font>
<a name='1835'>
 <a name='1836'>
<font color=#447700>! subcolumns<a name='1837'></font>
           <a name='1838'>
           if (sub_column) then<a name='1839'>
 <a name='1840'>
              mnuccc(k) = &amp;<a name='1841'>
                       pi*pi/36._r8*rhow* &amp;<a name='1842'>
                   cdist1(k)*gamma(7._r8+pgam(k))* &amp;<a name='1843'>
                    bimm*(exp(aimm*(273.15_r8-t(i,k)))-1._r8)/ &amp;<a name='1844'>
                    lamc(k)**3/lamc(k)**3<a name='1845'>
 <a name='1846'>
              nnuccc(k) = &amp;<a name='1847'>
                    pi/6._r8*cdist1(k)*gamma(pgam(k)+4._r8) &amp;<a name='1848'>
                    *bimm* &amp;<a name='1849'>
                    (exp(aimm*(273.15_r8-t(i,k)))-1._r8)/lamc(k)**3<a name='1850'>
 <a name='1851'>
           else<a name='1852'>
 <a name='1853'>
              mnuccc(k) = cons9/(cons3*cons19)* &amp;<a name='1854'>
                      pi*pi/36._r8*rhow* &amp;<a name='1855'>
                  cdist1(k)*gamma(7._r8+pgam(k))* &amp;<a name='1856'>
                   bimm*(exp(aimm*(273.15_r8-t(i,k)))-1._r8)/ &amp;<a name='1857'>
                   lamc(k)**3/lamc(k)**3<a name='1858'>
<a name='1859'>
              nnuccc(k) = cons10/(cons3*qcvar)* &amp;<a name='1860'>
                  pi/6._r8*cdist1(k)*gamma(pgam(k)+4._r8) &amp;<a name='1861'>
                  *bimm* &amp;<a name='1862'>
                  (exp(aimm*(273.15_r8-t(i,k)))-1._r8)/lamc(k)**3<a name='1863'>
           end if           <font color=#447700>! sub-columns<a name='1864'></font>
<a name='1865'>
<a name='1866'>
<font color=#447700>! contact freezing (-40&lt;T&lt;-3 C) (Young, 1974) with hooks into simulated dust<a name='1867'></font>
<font color=#447700>! dust size and number in 4 bins are read in from companion routine<a name='1868'></font>
<a name='1869'>
           tcnt=(270.16_r8-t(i,k))**1.3_r8<a name='1870'>
           viscosity=1.8e-5_r8*(t(i,k)/298.0_r8)**0.85_r8    <font color=#447700>! Viscosity (kg/m/s)<a name='1871'></font>
           mfp=2.0_r8*viscosity/(p(i,k)  &amp;                   <font color=#447700>! Mean free path (m)<a name='1872'></font>
               *sqrt(8.0_r8*28.96e-3_r8/(pi*8.314409_r8*t(i,k))))           <a name='1873'>
<a name='1874'>
           nslip1=1.0_r8+(mfp/rndst(i,k,1))*(1.257_r8+(0.4_r8*Exp(-(1.1_r8*rndst(i,k,1)/mfp))))<font color=#447700>! Slip correction factor<a name='1875'></font>
           nslip2=1.0_r8+(mfp/rndst(i,k,2))*(1.257_r8+(0.4_r8*Exp(-(1.1_r8*rndst(i,k,2)/mfp))))<a name='1876'>
           nslip3=1.0_r8+(mfp/rndst(i,k,3))*(1.257_r8+(0.4_r8*Exp(-(1.1_r8*rndst(i,k,3)/mfp))))<a name='1877'>
           nslip4=1.0_r8+(mfp/rndst(i,k,4))*(1.257_r8+(0.4_r8*Exp(-(1.1_r8*rndst(i,k,4)/mfp))))<a name='1878'>
<a name='1879'>
           ndfaer1=1.381e-23_r8*t(i,k)*nslip1/(6._r8*pi*viscosity*rndst(i,k,1))  <font color=#447700>! aerosol diffusivity (m2/s)<a name='1880'></font>
           ndfaer2=1.381e-23_r8*t(i,k)*nslip2/(6._r8*pi*viscosity*rndst(i,k,2))<a name='1881'>
           ndfaer3=1.381e-23_r8*t(i,k)*nslip3/(6._r8*pi*viscosity*rndst(i,k,3))<a name='1882'>
           ndfaer4=1.381e-23_r8*t(i,k)*nslip4/(6._r8*pi*viscosity*rndst(i,k,4))<a name='1883'>
<a name='1884'>
<a name='1885'>
           if (sub_column) then<a name='1886'>
 <a name='1887'>
               mnucct(k) = &amp;<a name='1888'>
                        (ndfaer1*(nacon(i,k,1)*tcnt)+ndfaer2*(nacon(i,k,2)*tcnt)+&amp;<a name='1889'>
                                  ndfaer3*(nacon(i,k,3)*tcnt)+ndfaer4*(nacon(i,k,4)*tcnt))*pi*pi/3._r8*rhow* &amp;<a name='1890'>
                        cdist1(k)*gamma(pgam(k)+5._r8)/lamc(k)**4<a name='1891'>
 <a name='1892'>
               nnucct(k) = (ndfaer1*(nacon(i,k,1)*tcnt)+ndfaer2*(nacon(i,k,2)*tcnt)+&amp;<a name='1893'>
                                     ndfaer3*(nacon(i,k,3)*tcnt)+ndfaer4*(nacon(i,k,4)*tcnt))*2._r8*pi*  &amp;<a name='1894'>
                        cdist1(k)*gamma(pgam(k)+2._r8)/lamc(k)<a name='1895'>
 <a name='1896'>
           else<a name='1897'>
<a name='1898'>
               mnucct(k) = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_20">(qcvar+4._r8/3._r8)/(cons3*qcvar**(4._r8/3._r8))*  &amp;<a name='1899'>
                       (ndfaer1*(nacon(i,k,1)*tcnt)+ndfaer2*(nacon(i,k,2)*tcnt)+&amp;<a name='1900'>
                                 ndfaer3*(nacon(i,k,3)*tcnt)+ndfaer4*(nacon(i,k,4)*tcnt))*pi*pi/3._r8*rhow* &amp;<a name='1901'>
                       cdist1(k)*gamma(pgam(k)+5._r8)/lamc(k)**4<a name='1902'>
<a name='1903'>
                nnucct(k) =  <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_21">(qcvar+1._r8/3._r8)/(cons3*qcvar**(1._r8/3._r8))*  &amp;<a name='1904'>
                         (ndfaer1*(nacon(i,k,1)*tcnt)+ndfaer2*(nacon(i,k,2)*tcnt)+&amp;<a name='1905'>
                                   ndfaer3*(nacon(i,k,3)*tcnt)+ndfaer4*(nacon(i,k,4)*tcnt))*2._r8*pi*  &amp;<a name='1906'>
                       cdist1(k)*gamma(pgam(k)+2._r8)/lamc(k)<a name='1907'>
<a name='1908'>
           end if      <font color=#447700>! sub-column switch<a name='1909'></font>
<a name='1910'>
<font color=#447700>! make sure number of droplets frozen does not exceed available ice nuclei concentration<a name='1911'></font>
<font color=#447700>! this prevents 'runaway' droplet freezing<a name='1912'></font>
<a name='1913'>
        if (nnuccc(k)*lcldm(i,k).gt.nnuccd(k)) then<a name='1914'>
        dum=(nnuccd(k)/(nnuccc(k)*lcldm(i,k)))<a name='1915'>
<font color=#447700>! scale mixing ratio of droplet freezing with limit<a name='1916'></font>
        mnuccc(k)=mnuccc(k)*dum<a name='1917'>
        nnuccc(k)=nnuccd(k)/lcldm(i,k)<a name='1918'>
        end if<a name='1919'>
<a name='1920'>
        else<a name='1921'>
           mnuccc(k)=0._r8<a name='1922'>
           nnuccc(k)=0._r8<a name='1923'>
           mnucct(k)=0._r8<a name='1924'>
           nnucct(k)=0._r8<a name='1925'>
	end if<a name='1926'>
<a name='1927'>
<font color=#447700>!.......................................................................<a name='1928'></font>
<font color=#447700>! snow self-aggregation from passarelli, 1978, used by reisner, 1998<a name='1929'></font>
<font color=#447700>! this is hard-wired for bs = 0.4 for now<a name='1930'></font>
<font color=#447700>! ignore self-collection of cloud ice<a name='1931'></font>
<a name='1932'>
	if (qniic(i,k).ge.qsmall .and. t(i,k).le.273.15_r8) then<a name='1933'>
 	nsagg(k) = -1108._r8*asn(i,k)*Eii* &amp;<a name='1934'>
             pi**((1._r8-bs)/3._r8)*rhosn**((-2._r8-bs)/3._r8)*rho(i,k)** &amp;<a name='1935'>
            ((2._r8+bs)/3._r8)*qniic(i,k)**((2._r8+bs)/3._r8)* &amp;<a name='1936'>
            (nsic(i,k)*rho(i,k))**((4._r8-bs)/3._r8)/ &amp;<a name='1937'>
            (4._r8*720._r8*rho(i,k))<a name='1938'>
        else<a name='1939'>
        nsagg(k)=0._r8<a name='1940'>
	end if<a name='1941'>
<a name='1942'>
<font color=#447700>!.......................................................................<a name='1943'></font>
<font color=#447700>! accretion of cloud droplets onto snow/graupel<a name='1944'></font>
<font color=#447700>! here use continuous collection equation with<a name='1945'></font>
<font color=#447700>! simple gravitational collection kernel<a name='1946'></font>
<font color=#447700>! ignore collisions between droplets/cloud ice<a name='1947'></font>
<font color=#447700>! since minimum size ice particle for accretion is 50 - 150 micron<a name='1948'></font>
<a name='1949'>
<font color=#447700>! ignore collision of snow with droplets above freezing<a name='1950'></font>
<a name='1951'>
	if (qniic(i,k).ge.qsmall .and. t(i,k).le.tmelt .and. &amp;<a name='1952'>
            qcic(i,k).ge.qsmall) then<a name='1953'>
<a name='1954'>
<font color=#447700>! put in size dependent collection efficiency<a name='1955'></font>
<font color=#447700>! mean diameter of snow is area-weighted, since<a name='1956'></font>
<font color=#447700>! accretion is function of crystal geometric area<a name='1957'></font>
<font color=#447700>! collection efficiency is approximation based on stoke's law (Thompson et al. 2004)<a name='1958'></font>
<a name='1959'>
        dc0 = (pgam(k)+1._r8)/lamc(k)<a name='1960'>
        ds0 = 1._r8/lams(k)<a name='1961'>
        dum = dc0*dc0*uns(k)*rhow/(9._r8*mu(i,k)*ds0)<a name='1962'>
        eci = dum*dum/((dum+0.4_r8)*(dum+0.4_r8))<a name='1963'>
<a name='1964'>
        eci = max(eci,0._r8)<a name='1965'>
        eci = min(eci,1._r8)<a name='1966'>
<a name='1967'>
<a name='1968'>
<font color=#447700>! no impact of sub-grid distribution of qc since psacws<a name='1969'></font>
<font color=#447700>! is linear in qc<a name='1970'></font>
<a name='1971'>
	psacws(k) = pi/4._r8*asn(i,k)*qcic(i,k)*rho(i,k)* &amp;<a name='1972'>
                  n0s(k)*Eci*cons11/ &amp;<a name='1973'>
                  lams(k)**(bs+3._r8)	<a name='1974'>
	npsacws(k) = pi/4._r8*asn(i,k)*ncic(i,k)*rho(i,k)* &amp;<a name='1975'>
                  n0s(k)*Eci*cons11/ &amp;<a name='1976'>
                  lams(k)**(bs+3._r8)<a name='1977'>
        else<a name='1978'>
           psacws(k)=0._r8<a name='1979'>
           npsacws(k)=0._r8<a name='1980'>
        end if<a name='1981'>
<a name='1982'>
<font color=#447700>! add secondary ice production due to accretion of droplets by snow <a name='1983'></font>
<font color=#447700>! (Hallet-Mossop process) (from Cotton et al., 1986)<a name='1984'></font>
        if((t(i,k).lt.270.16_r8) .and. (t(i,k).ge.268.16_r8)) then<a name='1985'>
           ni_secp   = 3.5e8_r8*(270.16_r8-t(i,k))/2.0_r8*psacws(k)<a name='1986'>
           nsacwi(k) = ni_secp<a name='1987'>
           msacwi(k) = min(ni_secp*mi0,psacws(k))<a name='1988'>
        else if((t(i,k).lt.268.16_r8) .and. (t(i,k).ge.265.16_r8)) then<a name='1989'>
           ni_secp   = 3.5e8_r8*(t(i,k)-265.16_r8)/3.0_r8*psacws(k)<a name='1990'>
           nsacwi(k) = ni_secp<a name='1991'>
           msacwi(k) = min(ni_secp*mi0,psacws(k))<a name='1992'>
        else<a name='1993'>
           ni_secp   = 0.0_r8<a name='1994'>
           nsacwi(k) = 0.0_r8<a name='1995'>
           msacwi(k) = 0.0_r8<a name='1996'>
        endif<a name='1997'>
        psacws(k) = max(0.0_r8,psacws(k)-ni_secp*mi0)<a name='1998'>
<a name='1999'>
<font color=#447700>!.......................................................................<a name='2000'></font>
<font color=#447700>! accretion of rain water by snow<a name='2001'></font>
<font color=#447700>! formula from ikawa and saito, 1991, used by reisner et al., 1998<a name='2002'></font>
<a name='2003'>
	if (qric(i,k).ge.1.e-8_r8 .and. qniic(i,k).ge.1.e-8_r8 .and. &amp; <a name='2004'>
              t(i,k).le.273.15_r8) then<a name='2005'>
<a name='2006'>
	pracs(k) = pi*pi*ecr*(((1.2_r8*umr(k)-0.95_r8*ums(k))**2+ &amp;<a name='2007'>
                  0.08_r8*ums(k)*umr(k))**0.5_r8*rhow*rho(i,k)* &amp;<a name='2008'>
                 n0r(k)*n0s(k)* &amp;<a name='2009'>
                  (5._r8/(lamr(k)**6*lams(k))+ &amp;<a name='2010'>
                  2._r8/(lamr(k)**5*lams(k)**2)+ &amp;<a name='2011'>
                  0.5_r8/(lamr(k)**4*lams(k)**3)))<a name='2012'>
<a name='2013'>
	npracs(k) = pi/2._r8*rho(i,k)*ecr*(1.7_r8*(unr(k)-uns(k))**2+ &amp;<a name='2014'>
              0.3_r8*unr(k)*uns(k))**0.5_r8*n0r(k)*n0s(k)* &amp;<a name='2015'>
              (1._r8/(lamr(k)**3*lams(k))+ &amp;<a name='2016'>
              1._r8/(lamr(k)**2*lams(k)**2)+ &amp;<a name='2017'>
              1._r8/(lamr(k)*lams(k)**3))<a name='2018'>
<a name='2019'>
        else<a name='2020'>
           pracs(k)=0._r8<a name='2021'>
           npracs(k)=0._r8<a name='2022'>
	end if<a name='2023'>
<a name='2024'>
<font color=#447700>!.......................................................................<a name='2025'></font>
<font color=#447700>! heterogeneous freezing of rain drops<a name='2026'></font>
<font color=#447700>! follows from Bigg (1953)<a name='2027'></font>
<a name='2028'>
	if (t(i,k).lt.269.15_r8 .and. qric(i,k).ge.qsmall) then<a name='2029'>
<a name='2030'>
	mnuccr(k) = 20._r8*pi*pi*rhow*nric(i,k)*bimm* &amp;<a name='2031'>
                  (exp(aimm*(273.15_r8-t(i,k)))-1._r8)/lamr(k)**3 &amp;<a name='2032'>
                 /lamr(k)**3<a name='2033'>
<a name='2034'>
	nnuccr(k) = pi*nric(i,k)*bimm* &amp;<a name='2035'>
                   (exp(aimm*(273.15_r8-t(i,k)))-1._r8)/lamr(k)**3<a name='2036'>
        else<a name='2037'>
           mnuccr(k)=0._r8<a name='2038'>
           nnuccr(k)=0._r8<a name='2039'>
	end if<a name='2040'>
<a name='2041'>
<font color=#447700>!.......................................................................<a name='2042'></font>
<font color=#447700>! accretion of cloud liquid water by rain<a name='2043'></font>
<font color=#447700>! formula from Khrouditnov and Kogan (2000)<a name='2044'></font>
<font color=#447700>! gravitational collection kernel, droplet fall speed neglected<a name='2045'></font>
<a name='2046'>
	if (qric(i,k).ge.qsmall .and. qcic(i,k).ge.qsmall) then<a name='2047'>
<a name='2048'>
<font color=#447700>! include sub-grid distribution of cloud water<a name='2049'></font>
<a name='2050'>
<font color=#447700>! add sub-column switch<a name='2051'></font>
 <a name='2052'>
           if (sub_column) then<a name='2053'>
 <a name='2054'>
              pra(k) = &amp;<a name='2055'>
                       67._r8*(qcic(i,k)*qric(i,k))**1.15_r8<a name='2056'>
              npra(k) = pra(k)/(qcic(i,k)/ncic(i,k))<a name='2057'>
 <a name='2058'>
           else<a name='2059'>
<a name='2060'>
              pra(k) = cons12/(cons3*cons20)* &amp;<a name='2061'>
                      67._r8*(qcic(i,k)*qric(i,k))**1.15_r8<a name='2062'>
              npra(k) = pra(k)/(qcic(i,k)/ncic(i,k))<a name='2063'>
<a name='2064'>
           end if               <font color=#447700>! sub-column switch<a name='2065'></font>
<a name='2066'>
         else<a name='2067'>
           pra(k)=0._r8<a name='2068'>
           npra(k)=0._r8<a name='2069'>
	end if<a name='2070'>
<a name='2071'>
<font color=#447700>!.......................................................................<a name='2072'></font>
<font color=#447700>! Self-collection of rain drops<a name='2073'></font>
<font color=#447700>! from Beheng(1994)<a name='2074'></font>
<a name='2075'>
	if (qric(i,k).ge.qsmall) then<a name='2076'>
	nragg(k) = -8._r8*nric(i,k)*qric(i,k)*rho(i,k)<a name='2077'>
        else<a name='2078'>
           nragg(k)=0._r8<a name='2079'>
	end if<a name='2080'>
<a name='2081'>
<font color=#447700>!.......................................................................<a name='2082'></font>
<font color=#447700>! Accretion of cloud ice by snow<a name='2083'></font>
<font color=#447700>! For this calculation, it is assumed that the Vs &gt;&gt; Vi<a name='2084'></font>
<font color=#447700>! and Ds &gt;&gt; Di for continuous collection<a name='2085'></font>
<a name='2086'>
	if (qniic(i,k).ge.qsmall.and.qiic(i,k).ge.qsmall &amp;<a name='2087'>
            .and.t(i,k).le.273.15_r8) then<a name='2088'>
	prai(k) = pi/4._r8*asn(i,k)*qiic(i,k)*rho(i,k)* &amp;<a name='2089'>
                  n0s(k)*Eii*cons11/ &amp;<a name='2090'>
                  lams(k)**(bs+3._r8)	<a name='2091'>
	nprai(k) = pi/4._r8*asn(i,k)*niic(i,k)* &amp;<a name='2092'>
                  rho(i,k)*n0s(k)*Eii*cons11/ &amp;<a name='2093'>
                  lams(k)**(bs+3._r8)<a name='2094'>
        else<a name='2095'>
        prai(k)=0._r8<a name='2096'>
        nprai(k)=0._r8<a name='2097'>
	end if<a name='2098'>
<a name='2099'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2100'></font>
<font color=#447700>! calculate evaporation/sublimation of rain and snow<a name='2101'></font>
<font color=#447700>! note: evaporation/sublimation occurs only in cloud-free portion of grid cell<a name='2102'></font>
<font color=#447700>! in-cloud condensation/deposition of rain and snow is neglected<a name='2103'></font>
<font color=#447700>! except for transfer of cloud water to snow through bergeron process<a name='2104'></font>
<a name='2105'>
<font color=#447700>! initialize evap/sub tendncies<a name='2106'></font>
	pre(k)=0._r8<a name='2107'>
	prds(k)=0._r8<a name='2108'>
<a name='2109'>
<font color=#447700>! evaporation of rain<a name='2110'></font>
<font color=#447700>! only calculate if there is some precip fraction &gt; cloud fraction<a name='2111'></font>
<a name='2112'>
        if (qcic(i,k)+qiic(i,k).lt.1.e-6_r8.or.cldmax(i,k).gt.lcldm(i,k)) then<a name='2113'>
<a name='2114'>
<font color=#447700>! set temporary cloud fraction to zero if cloud water + ice is very small<a name='2115'></font>
<font color=#447700>! this will ensure that evaporation/sublimation of precip occurs over<a name='2116'></font>
<font color=#447700>! entire grid cell, since min cloud fraction is specified otherwise<a name='2117'></font>
        if (qcic(i,k)+qiic(i,k).lt.1.e-6_r8) then<a name='2118'>
	dum=0._r8<a name='2119'>
	else<a name='2120'>
	dum=lcldm(i,k)<a name='2121'>
	end if<a name='2122'>
<a name='2123'>
<font color=#447700>! saturation vapor pressure<a name='2124'></font>
        esn=<A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_3">(t(i,k),0)<a name='2125'>
	qsn=min(epsqs*esn/(p(i,k)-(1._r8-epsqs)*esn),1._r8)<a name='2126'>
<a name='2127'>
<font color=#447700>! recalculate saturation vapor pressure for liquid and ice<a name='2128'></font>
	esl(i,k)=esn<a name='2129'>
	esi(i,k)=<A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_4">(t(i,k),1)<a name='2130'>
<font color=#447700>! hm fix, make sure when above freezing that esi=esl, not active yet<a name='2131'></font>
	if (t(i,k).gt.tmelt)esi(i,k)=esl(i,k)<a name='2132'>
<a name='2133'>
<font color=#447700>! calculate q for out-of-cloud region<a name='2134'></font>
	qclr=(q(i,k)-dum*qsn)/(1._r8-dum)<a name='2135'>
<a name='2136'>
	if (qric(i,k).ge.qsmall) then<a name='2137'>
<a name='2138'>
        qvs=epsqs*esl(i,k)/(p(i,k)-(1._r8-epsqs)*esl(i,k))<a name='2139'>
	dqsdt = xxlv*qvs/(rv*t(i,k)**2)<a name='2140'>
        ab = 1._r8+dqsdt*xxlv/cpp<a name='2141'>
        epsr = 2._r8*pi*n0r(k)*rho(i,k)*Dv(i,k)* &amp;<a name='2142'>
                   (f1r/(lamr(k)*lamr(k))+ &amp;<a name='2143'>
                    f2r*(arn(i,k)*rho(i,k)/mu(i,k))**0.5_r8* &amp;<a name='2144'>
                    sc(i,k)**(1._r8/3._r8)*cons13/ &amp;<a name='2145'>
                (lamr(k)**(5._r8/2._r8+br/2._r8)))<a name='2146'>
<a name='2147'>
	   pre(k) = epsr*(qclr-qvs)/ab<a name='2148'>
<a name='2149'>
<font color=#447700>! only evaporate in out-of-cloud region<a name='2150'></font>
<font color=#447700>! and distribute across cldmax<a name='2151'></font>
           pre(k)=min(pre(k)*(cldmax(i,k)-dum),0._r8)<a name='2152'>
           pre(k)=pre(k)/cldmax(i,k)<a name='2153'>
	end if<a name='2154'>
<a name='2155'>
<font color=#447700>! sublimation of snow<a name='2156'></font>
	if (qniic(i,k).ge.qsmall) then<a name='2157'>
        qvi=epsqs*esi(i,k)/(p(i,k)-(1._r8-epsqs)*esi(i,k))<a name='2158'>
        dqsidt =  xxls*qvi/(rv*t(i,k)**2)<a name='2159'>
        abi = 1._r8+dqsidt*xxls/cpp<a name='2160'>
        epss = 2._r8*pi*n0s(k)*rho(i,k)*Dv(i,k)* &amp;<a name='2161'>
                   (f1s/(lams(k)*lams(k))+ &amp;<a name='2162'>
                    f2s*(asn(i,k)*rho(i,k)/mu(i,k))**0.5_r8* &amp;<a name='2163'>
                    sc(i,k)**(1._r8/3._r8)*cons14/ &amp;<a name='2164'>
               (lams(k)**(5._r8/2._r8+bs/2._r8)))<a name='2165'>
	   prds(k) = epss*(qclr-qvi)/abi	<a name='2166'>
<a name='2167'>
<font color=#447700>! only sublimate in out-of-cloud region and distribute over cldmax<a name='2168'></font>
           prds(k)=min(prds(k)*(cldmax(i,k)-dum),0._r8)<a name='2169'>
	   prds(k)=prds(k)/cldmax(i,k)<a name='2170'>
	end if<a name='2171'>
<a name='2172'>
<font color=#447700>! make sure RH not pushed above 100% due to rain evaporation/snow sublimation<a name='2173'></font>
<font color=#447700>! get updated RH at end of time step based on cloud water/ice condensation/evap<a name='2174'></font>
<a name='2175'>
	qtmp=q(i,k)-(cmei(i,k)+(pre(k)+prds(k))*cldmax(i,k))*deltat<a name='2176'>
	ttmp=t(i,k)+((pre(k)*cldmax(i,k))*xxlv+ &amp;<a name='2177'>
                (cmei(i,k)+prds(k)*cldmax(i,k))*xxls)*deltat/cpp<a name='2178'>
<a name='2179'>
<font color=#447700>!limit range of temperatures!<a name='2180'></font>
        ttmp=max(180._r8,min(ttmp,323._r8))<a name='2181'>
<a name='2182'>
        esn=<A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_5">(ttmp,0)  <font color=#447700>! use rhw to allow ice supersaturation<a name='2183'></font>
	qsn=min(epsqs*esn/(p(i,k)-(1._r8-epsqs)*esn),1._r8)<a name='2184'>
<a name='2185'>
<font color=#447700>! modify precip evaporation rate if q &gt; qsat<a name='2186'></font>
	if (qtmp.gt.qsn) then<a name='2187'>
	if (pre(k)+prds(k).lt.-1.e-20) then<a name='2188'>
	dum1=pre(k)/(pre(k)+prds(k))<a name='2189'>
<font color=#447700>! recalculate q and t after cloud water cond but without precip evap<a name='2190'></font>
	qtmp=q(i,k)-(cmei(i,k))*deltat<a name='2191'>
	ttmp=t(i,k)+(cmei(i,k)*xxls)*deltat/cpp<a name='2192'>
        esn=<A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_6">(ttmp,0) <font color=#447700>! use rhw to allow ice supersaturation<a name='2193'></font>
	qsn=min(epsqs*esn/(p(i,k)-(1._r8-epsqs)*esn),1._r8)<a name='2194'>
	dum=(qtmp-qsn)/(1._r8 + cons27*qsn/(cpp*rv*ttmp**2))<a name='2195'>
	dum=min(dum,0._r8)<a name='2196'>
<a name='2197'>
<font color=#447700>! modify rates if needed, divide by cldmax to get local (in-precip) value<a name='2198'></font>
	pre(k)=dum*dum1/deltat/cldmax(i,k)<a name='2199'>
<a name='2200'>
<font color=#447700>! do separately using RHI for prds....<a name='2201'></font>
        esn=<A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_7">(ttmp,1) <font color=#447700>! use rhi to allow ice supersaturation<a name='2202'></font>
	qsn=min(epsqs*esn/(p(i,k)-(1._r8-epsqs)*esn),1._r8)<a name='2203'>
	dum=(qtmp-qsn)/(1._r8 + cons28*qsn/(cpp*rv*ttmp**2))<a name='2204'>
	dum=min(dum,0._r8)<a name='2205'>
<a name='2206'>
<font color=#447700>! modify rates if needed, divide by cldmax to get local (in-precip) value<a name='2207'></font>
	prds(k)=dum*(1._r8-dum1)/deltat/cldmax(i,k)<a name='2208'>
	end if<a name='2209'>
	end if<a name='2210'>
<a name='2211'>
	end if<a name='2212'>
<a name='2213'>
<font color=#447700>! bergeron process - evaporation of droplets and deposition onto snow<a name='2214'></font>
<a name='2215'>
	if (qniic(i,k).ge.qsmall.and.qcic(i,k).ge.qsmall.and.t(i,k).lt.tmelt) then<a name='2216'>
        qvi=epsqs*esi(i,k)/(p(i,k)-(1._r8-epsqs)*esi(i,k))<a name='2217'>
        qvs=epsqs*esl(i,k)/(p(i,k)-(1._r8-epsqs)*esl(i,k))<a name='2218'>
        dqsidt =  xxls*qvi/(rv*t(i,k)**2)<a name='2219'>
        abi = 1._r8+dqsidt*xxls/cpp<a name='2220'>
        epss = 2._r8*pi*n0s(k)*rho(i,k)*Dv(i,k)* &amp;<a name='2221'>
                   (f1s/(lams(k)*lams(k))+ &amp;<a name='2222'>
                    f2s*(asn(i,k)*rho(i,k)/mu(i,k))**0.5_r8* &amp;<a name='2223'>
                    sc(i,k)**(1._r8/3._r8)*cons14/ &amp;<a name='2224'>
               (lams(k)**(5._r8/2._r8+bs/2._r8)))<a name='2225'>
	bergs(k)=epss*(qvs-qvi)/abi<a name='2226'>
	else<a name='2227'>
	bergs(k)=0._r8<a name='2228'>
	end if<a name='2229'>
<a name='2230'>
<font color=#447700>!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2231'></font>
<font color=#447700>! conservation to ensure no negative values of cloud water/precipitation<a name='2232'></font>
<font color=#447700>! in case microphysical process rates are large<a name='2233'></font>
<a name='2234'>
<font color=#447700>! make sure and use end-of-time step values for cloud water, ice, due<a name='2235'></font>
<font color=#447700>! condensation/deposition<a name='2236'></font>
<a name='2237'>
<font color=#447700>! note: for check on conservation, processes are multiplied by omsm<a name='2238'></font>
<font color=#447700>! to prevent problems due to round off error<a name='2239'></font>
<a name='2240'>
<font color=#447700>! include mixing timescale  (mtime)<a name='2241'></font>
<a name='2242'>
        qce=(qc(i,k) - berg(i,k)*deltat)<a name='2243'>
        nce=(nc(i,k)+npccn(k)*deltat*mtime)<a name='2244'>
        qie=(qi(i,k)+(cmei(i,k)+berg(i,k))*deltat)<a name='2245'>
        nie=(ni(i,k)+nnuccd(k)*deltat*mtime)<a name='2246'>
<a name='2247'>
<font color=#447700>! conservation of qc<a name='2248'></font>
<a name='2249'>
        dum = (prc(k)+pra(k)+mnuccc(k)+mnucct(k)+msacwi(k)+ &amp;<a name='2250'>
<a name='2251'>
              psacws(k)+bergs(k))*lcldm(i,k)*deltat<a name='2252'>
<a name='2253'>
	if (dum.gt.qce) then<a name='2254'>
<font color=#447700>!PMA<a name='2255'></font>
         if (abs(prc(k)+pra(k)+mnuccc(k)+mnucct(k)+msacwi(k)+psacws(k)+bergs(k)) &gt; 1.e-20_r8) then<a name='2256'>
          ratio = qce/deltat/lcldm(i,k)/(prc(k)+pra(k)+mnuccc(k)+mnucct(k)+msacwi(k)+psacws(k)+bergs(k))*omsm <a name='2257'>
         else<a name='2258'>
          ratio = 0.5_r8<a name='2259'>
         end if<a name='2260'>
	prc(k) = prc(k)*ratio<a name='2261'>
	pra(k) = pra(k)*ratio<a name='2262'>
	mnuccc(k) = mnuccc(k)*ratio<a name='2263'>
        mnucct(k) = mnucct(k)*ratio  <a name='2264'>
        msacwi(k) = msacwi(k)*ratio  <a name='2265'>
	psacws(k) = psacws(k)*ratio	<a name='2266'>
	bergs(k) = bergs(k)*ratio	<a name='2267'>
        end if<a name='2268'>
<a name='2269'>
<font color=#447700>! conservation of nc<a name='2270'></font>
<a name='2271'>
        dum = (nprc1(k)+npra(k)+nnuccc(k)+nnucct(k)+ &amp;<a name='2272'>
              npsacws(k)-nsubc(k))*lcldm(i,k)*deltat<a name='2273'>
<a name='2274'>
	if (dum.gt.nce) then<a name='2275'>
<font color=#447700>!PMA<a name='2276'></font>
          if (abs(nprc1(k)+npra(k)+nnuccc(k)+nnucct(k)+npsacws(k)-nsubc(k)) &gt; 1.e-20_r8) then<a name='2277'>
        ratio = nce/deltat/((nprc1(k)+npra(k)+nnuccc(k)+nnucct(k)+&amp;<a name='2278'>
            npsacws(k)-nsubc(k))*lcldm(i,k))*omsm<a name='2279'>
          else<a name='2280'>
        ratio = 0.5_r8<a name='2281'>
          end if<a name='2282'>
<a name='2283'>
	nprc1(k) = nprc1(k)*ratio<a name='2284'>
	npra(k) = npra(k)*ratio<a name='2285'>
	nnuccc(k) = nnuccc(k)*ratio<a name='2286'>
        nnucct(k) = nnucct(k)*ratio  <a name='2287'>
	npsacws(k) = npsacws(k)*ratio	<a name='2288'>
	nsubc(k)=nsubc(k)*ratio<a name='2289'>
        end if<a name='2290'>
<a name='2291'>
<font color=#447700>! conservation of qi<a name='2292'></font>
<a name='2293'>
        dum = ((-mnuccc(k)-mnucct(k)-msacwi(k))*lcldm(i,k)+(prci(k)+ &amp;<a name='2294'>
               prai(k))*icldm(i,k))*deltat<a name='2295'>
<a name='2296'>
	if (dum.gt.qie) then<a name='2297'>
<a name='2298'>
<font color=#447700>!jdf<a name='2299'></font>
        if(abs(prci(k)+prai(k)).gt.1.0e-20) then<a name='2300'>
          ratio = (qie/deltat+(mnuccc(k)+mnucct(k)+msacwi(k))*lcldm(i,k))/((prci(k)+prai(k))*icldm(i,k))*omsm<a name='2301'>
        else<a name='2302'>
          ratio=0.5<a name='2303'>
        endif<a name='2304'>
<font color=#447700>!jdf        ratio = (qie/deltat+(mnuccc(k)+mnucct(k)+msacwi(k))*lcldm(i,k))/((prci(k)+prai(k))*icldm(i,k))*omsm <a name='2305'></font>
        prci(k) = prci(k)*ratio<a name='2306'>
        prai(k) = prai(k)*ratio<a name='2307'>
        end if<a name='2308'>
<a name='2309'>
<font color=#447700>! conservation of ni<a name='2310'></font>
<a name='2311'>
        dum = ((-nnucct(k)-nsacwi(k))*lcldm(i,k)+(nprci(k)+ &amp;<a name='2312'>
               nprai(k)-nsubi(k))*icldm(i,k))*deltat<a name='2313'>
<a name='2314'>
	if (dum.gt.nie) then<a name='2315'>
<a name='2316'>
           if(abs( ((nprci(k)+nprai(k)-nsubi(k))*icldm(i,k))*omsm )  .gt. 1.0e-20_r8) then<a name='2317'>
              ratio = (nie/deltat+(nnucct(k)+nsacwi(k))*lcldm(i,k))/ &amp;  <a name='2318'>
                   ((nprci(k)+nprai(k)-nsubi(k))*icldm(i,k))*omsm<a name='2319'>
           else<a name='2320'>
              ratio = 0.5<a name='2321'>
           endif<a name='2322'>
        nprci(k) = nprci(k)*ratio<a name='2323'>
        nprai(k) = nprai(k)*ratio<a name='2324'>
	nsubi(k) = nsubi(k)*ratio<a name='2325'>
        end if<a name='2326'>
<a name='2327'>
<font color=#447700>! for preciptiation conservation, use logic that vertical integral <a name='2328'></font>
<font color=#447700>! of tendency from current level to top of model (i.e., qrtot) cannot be negative<a name='2329'></font>
<a name='2330'>
<font color=#447700>! conservation of rain mixing rat<a name='2331'></font>
<a name='2332'>
	if (((prc(k)+pra(k))*lcldm(i,k)+(-mnuccr(k)+pre(k)-pracs(k))*&amp;<a name='2333'>
               cldmax(i,k))*dz(i,k)*rho(i,k)+qrtot.lt.0._r8) then<a name='2334'>
<a name='2335'>
	if (-pre(k)+pracs(k)+mnuccr(k).ge.qsmall) then<a name='2336'>
	     <a name='2337'>
	ratio = (qrtot/(dz(i,k)*rho(i,k))+(prc(k)+pra(k))*lcldm(i,k))/&amp;<a name='2338'>
                ((-pre(k)+pracs(k)+mnuccr(k))*cldmax(i,k))*omsm <a name='2339'>
<a name='2340'>
        pre(k) = pre(k)*ratio<a name='2341'>
        pracs(k) = pracs(k)*ratio<a name='2342'>
        mnuccr(k) = mnuccr(k)*ratio<a name='2343'>
	end if<a name='2344'>
        end if<a name='2345'>
<a name='2346'>
<font color=#447700>! conservation of nr<a name='2347'></font>
<font color=#447700>! for now neglect evaporation of nr<a name='2348'></font>
       nsubr(k)=0._r8<a name='2349'>
<a name='2350'>
       if ((nprc(k)*lcldm(i,k)+(-nnuccr(k)+nsubr(k)-npracs(k)&amp;<a name='2351'>
            +nragg(k))*cldmax(i,k))*dz(i,k)*rho(i,k)+nrtot.lt.0._r8) then<a name='2352'>
<a name='2353'>
	if (-nsubr(k)-nragg(k)+npracs(k)+nnuccr(k).ge.qsmall) then<a name='2354'>
<a name='2355'>
	ratio = (nrtot/(dz(i,k)*rho(i,k))+nprc(k)*lcldm(i,k))/&amp;<a name='2356'>
               ((-nsubr(k)-nragg(k)+npracs(k)+nnuccr(k))*cldmax(i,k))*omsm<a name='2357'>
<a name='2358'>
        nsubr(k) = nsubr(k)*ratio<a name='2359'>
        npracs(k) = npracs(k)*ratio<a name='2360'>
        nnuccr(k) = nnuccr(k)*ratio<a name='2361'>
        nragg(k) = nragg(k)*ratio<a name='2362'>
	end if<a name='2363'>
        end if<a name='2364'>
<a name='2365'>
<font color=#447700>! conservation of snow mix ratio<a name='2366'></font>
<a name='2367'>
	if (((bergs(k)+psacws(k))*lcldm(i,k)+(prai(k)+prci(k))*icldm(i,k)+(pracs(k)+&amp;<a name='2368'>
            mnuccr(k)+prds(k))*cldmax(i,k))*dz(i,k)*rho(i,k)+qstot.lt.0._r8) then<a name='2369'>
<a name='2370'>
	if (-prds(k).ge.qsmall) then<a name='2371'>
<a name='2372'>
	ratio = (qstot/(dz(i,k)*rho(i,k))+(bergs(k)+psacws(k))*lcldm(i,k)+(prai(k)+prci(k))*icldm(i,k)+&amp;<a name='2373'>
                (pracs(k)+mnuccr(k))*cldmax(i,k))/(-prds(k)*cldmax(i,k))*omsm<a name='2374'>
<a name='2375'>
        prds(k) = prds(k)*ratio<a name='2376'>
	end if<a name='2377'>
       end if<a name='2378'>
<a name='2379'>
<font color=#447700>! conservation of ns<a name='2380'></font>
<a name='2381'>
<font color=#447700>! calculate loss of number due to sublimation<a name='2382'></font>
<font color=#447700>! for now neglect sublimation of ns<a name='2383'></font>
       nsubs(k)=0._r8<a name='2384'>
<a name='2385'>
       if ((nprci(k)*icldm(i,k)+(nnuccr(k)+nsubs(k)+nsagg(k))*cldmax(i,k))*&amp;<a name='2386'>
            dz(i,k)*rho(i,k)+nstot.lt.0._r8) then<a name='2387'>
<a name='2388'>
	if (-nsubs(k)-nsagg(k).ge.qsmall) then<a name='2389'>
<a name='2390'>
	ratio = (nstot/(dz(i,k)*rho(i,k))+nprci(k)*icldm(i,k)+&amp;<a name='2391'>
                nnuccr(k)*cldmax(i,k))/((-nsubs(k)-nsagg(k))*cldmax(i,k))*omsm<a name='2392'>
<a name='2393'>
        nsubs(k) = nsubs(k)*ratio<a name='2394'>
        nsagg(k) = nsagg(k)*ratio<a name='2395'>
	end if<a name='2396'>
        end if<a name='2397'>
<a name='2398'>
<font color=#447700>! get tendencies due to microphysical conversion processes<a name='2399'></font>
<font color=#447700>! note: tendencies are multiplied by appropaiate cloud/precip <a name='2400'></font>
<font color=#447700>! fraction to get grid-scale values<a name='2401'></font>
<font color=#447700>! note: cmei is already grid-average values<a name='2402'></font>
<a name='2403'>
	qvlat(i,k) = qvlat(i,k)- &amp;<a name='2404'>
       (pre(k)+prds(k))*cldmax(i,k)-cmei(i,k) <a name='2405'>
<a name='2406'>
	tlat(i,k) = tlat(i,k)+((pre(k)*cldmax(i,k)) &amp;<a name='2407'>
           *xxlv+(prds(k)*cldmax(i,k)+cmei(i,k))*xxls+ &amp;<a name='2408'>
           ((bergs(k)+psacws(k)+mnuccc(k)+mnucct(k)+msacwi(k))*lcldm(i,k)+(mnuccr(k)+ &amp;<a name='2409'>
               pracs(k))*cldmax(i,k)+berg(i,k))*xlf)<a name='2410'>
<a name='2411'>
	qctend(i,k) = qctend(i,k)+ &amp;<a name='2412'>
                 (-pra(k)-prc(k)-mnuccc(k)-mnucct(k)-msacwi(k)- &amp; <a name='2413'>
                  psacws(k)-bergs(k))*lcldm(i,k)-berg(i,k)<a name='2414'>
<a name='2415'>
	qitend(i,k) = qitend(i,k)+ &amp;<a name='2416'>
         (mnuccc(k)+mnucct(k)+msacwi(k))*lcldm(i,k)+(-prci(k)- &amp; <a name='2417'>
                  prai(k))*icldm(i,k)+cmei(i,k)+berg(i,k)<a name='2418'>
<a name='2419'>
	qrtend(i,k) = qrtend(i,k)+ &amp;<a name='2420'>
                 (pra(k)+prc(k))*lcldm(i,k)+(pre(k)-pracs(k)- &amp;<a name='2421'>
                  mnuccr(k))*cldmax(i,k)<a name='2422'>
<a name='2423'>
	qnitend(i,k) = qnitend(i,k)+ &amp;<a name='2424'>
                (prai(k)+prci(k))*icldm(i,k)+(psacws(k)+bergs(k))*lcldm(i,k)+(prds(k)+ &amp;<a name='2425'>
                   pracs(k)+mnuccr(k))*cldmax(i,k)<a name='2426'>
<a name='2427'>
<font color=#447700>! add output for cmei (accumulate)<a name='2428'></font>
	cmeiout(i,k) = cmeiout(i,k) + cmei(i,k)<a name='2429'>
<a name='2430'>
<font color=#447700>! assign variables for trop_mozart, these are grid-average<a name='2431'></font>
<font color=#447700>! evaporation/sublimation is stored here as positive term<a name='2432'></font>
<a name='2433'>
	evapsnow(i,k) = evapsnow(i,k)-prds(k)*cldmax(i,k)<a name='2434'>
	nevapr(i,k) = nevapr(i,k)-pre(k)*cldmax(i,k)<a name='2435'>
<a name='2436'>
<font color=#447700>! change to make sure prain is positive: do not remove snow from<a name='2437'></font>
<font color=#447700>! prain used for wet deposition<a name='2438'></font>
        	prain(i,k) = prain(i,k)+(pra(k)+prc(k))*lcldm(i,k)+(-pracs(k)- &amp;<a name='2439'>
                          mnuccr(k))*cldmax(i,k)<a name='2440'>
	prodsnow(i,k) = prodsnow(i,k)+(prai(k)+prci(k))*icldm(i,k)+(psacws(k)+bergs(k))*lcldm(i,k)+(&amp;<a name='2441'>
                   pracs(k)+mnuccr(k))*cldmax(i,k)<a name='2442'>
<a name='2443'>
<font color=#447700>! following are used to calculate 1st order conversion rate of cloud water<a name='2444'></font>
<font color=#447700>!    to rain and snow (1/s), for later use in aerosol wet removal routine<a name='2445'></font>
<font color=#447700>! previously, wetdepa used (prain/qc) for this, and the qc in wetdepa may be smaller than the qc<a name='2446'></font>
<font color=#447700>!    used to calculate pra, prc, ... in this routine<a name='2447'></font>
<font color=#447700>! qcsinksum_rate1ord = sum over iterations{ rate of direct transfer of cloud water to rain &amp; snow }<a name='2448'></font>
<font color=#447700>!                      (no cloud ice or bergeron terms)<a name='2449'></font>
<font color=#447700>! qcsum_rate1ord     = sum over iterations{ qc used in calculation of the transfer terms }<a name='2450'></font>
<a name='2451'>
        qcsinksum_rate1ord(k) = qcsinksum_rate1ord(k) + (pra(k)+prc(k)+psacws(k))*lcldm(i,k) <a name='2452'>
        qcsum_rate1ord(k) = qcsum_rate1ord(k) + qc(i,k) <a name='2453'>
<a name='2454'>
<font color=#447700>! microphysics output, note this is grid-averaged<a name='2455'></font>
        prao(i,k)=prao(i,k)+pra(k)*lcldm(i,k)<a name='2456'>
        prco(i,k)=prco(i,k)+prc(k)*lcldm(i,k)<a name='2457'>
        mnuccco(i,k)=mnuccco(i,k)+mnuccc(k)*lcldm(i,k)<a name='2458'>
        mnuccto(i,k)=mnuccto(i,k)+mnucct(k)*lcldm(i,k)<a name='2459'>
        mnuccdo(i,k)=mnuccdo(i,k)+mnuccd(k)*lcldm(i,k)<a name='2460'>
        msacwio(i,k)=msacwio(i,k)+msacwi(k)*lcldm(i,k)<a name='2461'>
        psacwso(i,k)=psacwso(i,k)+psacws(k)*lcldm(i,k)<a name='2462'>
        bergso(i,k)=bergso(i,k)+bergs(k)*lcldm(i,k)<a name='2463'>
        bergo(i,k)=bergo(i,k)+berg(i,k)<a name='2464'>
        prcio(i,k)=prcio(i,k)+prci(k)*icldm(i,k)<a name='2465'>
        praio(i,k)=praio(i,k)+prai(k)*icldm(i,k)<a name='2466'>
        mnuccro(i,k)=mnuccro(i,k)+mnuccr(k)*cldmax(i,k)<a name='2467'>
        pracso (i,k)=pracso (i,k)+pracs (k)*cldmax(i,k)<a name='2468'>
<a name='2469'>
<font color=#447700>! multiply activation/nucleation by mtime to account for fast timescale<a name='2470'></font>
<a name='2471'>
	nctend(i,k) = nctend(i,k)+ npccn(k)*mtime+&amp;<a name='2472'>
                  (-nnuccc(k)-nnucct(k)-npsacws(k)+nsubc(k) &amp; <a name='2473'>
                  -npra(k)-nprc1(k))*lcldm(i,k)      <a name='2474'>
<a name='2475'>
	nitend(i,k) = nitend(i,k)+ nnuccd(k)*mtime+ &amp; <a name='2476'>
                  (nnucct(k)+nsacwi(k))*lcldm(i,k)+(nsubi(k)-nprci(k)- &amp;   <a name='2477'>
                  nprai(k))*icldm(i,k)<a name='2478'>
<a name='2479'>
	nstend(i,k) = nstend(i,k)+(nsubs(k)+ &amp;<a name='2480'>
                  nsagg(k)+nnuccr(k))*cldmax(i,k)+nprci(k)*icldm(i,k)<a name='2481'>
<a name='2482'>
	nrtend(i,k) = nrtend(i,k)+ &amp;<a name='2483'>
                  nprc(k)*lcldm(i,k)+(nsubr(k)-npracs(k)-nnuccr(k) &amp;<a name='2484'>
                   +nragg(k))*cldmax(i,k)<a name='2485'>
<a name='2486'>
<font color=#447700>! make sure that nc and ni at advanced time step do not exceed<a name='2487'></font>
<font color=#447700>! maximum (existing N + source terms*dt), which is possible due to<a name='2488'></font>
<font color=#447700>! fast nucleation timescale<a name='2489'></font>
<a name='2490'>
	if (nctend(i,k).gt.0._r8.and.nc(i,k)+nctend(i,k)*deltat.gt.ncmax) then<a name='2491'>
	nctend(i,k)=max(0._r8,(ncmax-nc(i,k))/deltat)<a name='2492'>
	end if<a name='2493'>
	if (nitend(i,k).gt.0._r8.and.ni(i,k)+nitend(i,k)*deltat.gt.nimax) then<a name='2494'>
	nitend(i,k)=max(0._r8,(nimax-ni(i,k))/deltat)<a name='2495'>
	end if<a name='2496'>
<a name='2497'>
<font color=#447700>! get final values for precipitation q and N, based on<a name='2498'></font>
<font color=#447700>! flux of precip from above, source/sink term, and terminal fallspeed<a name='2499'></font>
<font color=#447700>! see eq. 15-16 in MG2008<a name='2500'></font>
<a name='2501'>
<font color=#447700>! rain<a name='2502'></font>
<a name='2503'>
        if (qric(i,k).ge.qsmall) then<a name='2504'>
	if (k.eq.1) then<a name='2505'>
	qric(i,k)=qrtend(i,k)*dz(i,k)/cldmax(i,k)/umr(k)<a name='2506'>
	nric(i,k)=nrtend(i,k)*dz(i,k)/cldmax(i,k)/unr(k)<a name='2507'>
	else<a name='2508'>
        qric(i,k) = (rho(i,k-1)*umr(k-1)*qric(i,k-1)*cldmax(i,k-1)+ &amp;<a name='2509'>
         (rho(i,k)*dz(i,k)*qrtend(i,k)))/(umr(k)*rho(i,k)*cldmax(i,k))<a name='2510'>
	nric(i,k) = (rho(i,k-1)*unr(k-1)*nric(i,k-1)*cldmax(i,k-1)+ &amp;<a name='2511'>
         (rho(i,k)*dz(i,k)*nrtend(i,k)))/(unr(k)*rho(i,k)*cldmax(i,k))<a name='2512'>
<a name='2513'>
	end if<a name='2514'>
	else<a name='2515'>
	qric(i,k)=0._r8<a name='2516'>
	nric(i,k)=0._r8<a name='2517'>
	end if<a name='2518'>
<a name='2519'>
<font color=#447700>! snow<a name='2520'></font>
<a name='2521'>
        if (qniic(i,k).ge.qsmall) then<a name='2522'>
	if (k.eq.1) then<a name='2523'>
	qniic(i,k)=qnitend(i,k)*dz(i,k)/cldmax(i,k)/ums(k)	<a name='2524'>
	nsic(i,k)=nstend(i,k)*dz(i,k)/cldmax(i,k)/uns(k)<a name='2525'>
	else<a name='2526'>
        qniic(i,k) = (rho(i,k-1)*ums(k-1)*qniic(i,k-1)*cldmax(i,k-1)+ &amp;<a name='2527'>
         (rho(i,k)*dz(i,k)*qnitend(i,k)))/(ums(k)*rho(i,k)*cldmax(i,k))<a name='2528'>
	nsic(i,k) = (rho(i,k-1)*uns(k-1)*nsic(i,k-1)*cldmax(i,k-1)+ &amp;<a name='2529'>
         (rho(i,k)*dz(i,k)*nstend(i,k)))/(uns(k)*rho(i,k)*cldmax(i,k))<a name='2530'>
	end if<a name='2531'>
	else<a name='2532'>
	qniic(i,k)=0._r8<a name='2533'>
	nsic(i,k)=0._r8<a name='2534'>
	end if<a name='2535'>
<a name='2536'>
<font color=#447700>! calculate precipitation flux at surface<a name='2537'></font>
<font color=#447700>! divide by density of water to get units of m/s<a name='2538'></font>
<a name='2539'>
	prect(i) = prect(i)+(qrtend(i,k)*dz(i,k)*rho(i,k)+&amp;<a name='2540'>
                   qnitend(i,k)*dz(i,k)*rho(i,k))/rhow<a name='2541'>
	preci(i) = preci(i)+qnitend(i,k)*dz(i,k)*rho(i,k)/rhow<a name='2542'>
<a name='2543'>
        <font color=#447700>! convert rain rate from m/s to mm/hr<a name='2544'></font>
 <a name='2545'>
         rainrt(i,k)=qric(i,k)*rho(i,k)*umr(k)/rhow*3600._r8*1000._r8<a name='2546'>
<a name='2547'>
<font color=#447700>! vertically-integrated precip source/sink terms (note: grid-averaged)<a name='2548'></font>
<a name='2549'>
	qrtot = max(qrtot+qrtend(i,k)*dz(i,k)*rho(i,k),0._r8)<a name='2550'>
	qstot = max(qstot+qnitend(i,k)*dz(i,k)*rho(i,k),0._r8)<a name='2551'>
	nrtot = max(nrtot+nrtend(i,k)*dz(i,k)*rho(i,k),0._r8)<a name='2552'>
	nstot = max(nstot+nstend(i,k)*dz(i,k)*rho(i,k),0._r8)<a name='2553'>
<a name='2554'>
<font color=#447700>! calculate melting and freezing of precip<a name='2555'></font>
<a name='2556'>
<font color=#447700>! melt snow at +2 C<a name='2557'></font>
<a name='2558'>
        if (t(i,k)+tlat(i,k)/cpp*deltat &gt; 275.15_r8) then<a name='2559'>
           if (qstot &gt; 0._r8) then<a name='2560'>
<a name='2561'>
<font color=#447700>! make sure melting snow doesn't reduce temperature below threshold<a name='2562'></font>
	      dum = -xlf/cpp*qstot/(dz(i,k)*rho(i,k))<a name='2563'>
	      if (t(i,k)+tlat(i,k)/cpp*deltat+dum.lt.275.15_r8) then<a name='2564'>
	       dum = (t(i,k)+tlat(i,k)/cpp*deltat-275.15_r8)*cpp/xlf<a name='2565'>
	       dum = dum/(xlf/cpp*qstot/(dz(i,k)*rho(i,k)))<a name='2566'>
	       dum = max(0._r8,dum)<a name='2567'>
	       dum = min(1._r8,dum)<a name='2568'>
	      else<a name='2569'>
               dum = 1._r8<a name='2570'>
              end if<a name='2571'>
<a name='2572'>
	      qric(i,k)=qric(i,k)+dum*qniic(i,k)<a name='2573'>
	      nric(i,k)=nric(i,k)+dum*nsic(i,k)<a name='2574'>
	      qniic(i,k)=(1._r8-dum)*qniic(i,k)<a name='2575'>
	      nsic(i,k)=(1._r8-dum)*nsic(i,k)<a name='2576'>
<font color=#447700>! heating tendency <a name='2577'></font>
              tmp=-xlf*dum*qstot/(dz(i,k)*rho(i,k))<a name='2578'>
              meltsdt(i,k)=meltsdt(i,k) + tmp<a name='2579'>
<a name='2580'>
	      tlat(i,k)=tlat(i,k)+tmp<a name='2581'>
	      qrtot=qrtot+dum*qstot<a name='2582'>
	      nrtot=nrtot+dum*nstot<a name='2583'>
	      qstot=(1._r8-dum)*qstot<a name='2584'>
	      nstot=(1._r8-dum)*nstot<a name='2585'>
	      preci(i)=(1._r8-dum)*preci(i)<a name='2586'>
           end if<a name='2587'>
        end if<a name='2588'>
<a name='2589'>
<font color=#447700>! freeze all rain at -5C for Arctic<a name='2590'></font>
<a name='2591'>
        if (t(i,k)+tlat(i,k)/cpp*deltat &lt; (tmelt - 5._r8)) then<a name='2592'>
<a name='2593'>
           if (qrtot &gt; 0._r8) then<a name='2594'>
<a name='2595'>
<font color=#447700>! make sure freezing rain doesn't increase temperature above threshold<a name='2596'></font>
          dum = xlf/cpp*qrtot/(dz(i,k)*rho(i,k))<a name='2597'>
          if (t(i,k)+tlat(i,k)/cpp*deltat+dum.gt.(tmelt - 5._r8)) then<a name='2598'>
           dum = -(t(i,k)+tlat(i,k)/cpp*deltat-(tmelt-5._r8))*cpp/xlf<a name='2599'>
           dum = dum/(xlf/cpp*qrtot/(dz(i,k)*rho(i,k)))<a name='2600'>
           dum = max(0._r8,dum)<a name='2601'>
           dum = min(1._r8,dum)<a name='2602'>
          else<a name='2603'>
             dum = 1._r8<a name='2604'>
          end if<a name='2605'>
            <a name='2606'>
	      qniic(i,k)=qniic(i,k)+dum*qric(i,k)<a name='2607'>
	      nsic(i,k)=nsic(i,k)+dum*nric(i,k)<a name='2608'>
	      qric(i,k)=(1._r8-dum)*qric(i,k)<a name='2609'>
	      nric(i,k)=(1._r8-dum)*nric(i,k)<a name='2610'>
<font color=#447700>! heating tendency <a name='2611'></font>
	      tmp = xlf*dum*qrtot/(dz(i,k)*rho(i,k))<a name='2612'>
	      frzrdt(i,k)=frzrdt(i,k) + tmp<a name='2613'>
<a name='2614'>
	      tlat(i,k)=tlat(i,k)+tmp<a name='2615'>
	      qstot=qstot+dum*qrtot<a name='2616'>
	      qrtot=(1._r8-dum)*qrtot<a name='2617'>
	      nstot=nstot+dum*nrtot<a name='2618'>
	      nrtot=(1._r8-dum)*nrtot<a name='2619'>
	      preci(i)=preci(i)+dum*(prect(i)-preci(i))<a name='2620'>
           end if<a name='2621'>
        end if<a name='2622'>
<a name='2623'>
<font color=#447700>! if rain/snow mix ratio is zero so should number concentration<a name='2624'></font>
<a name='2625'>
	if (qniic(i,k).lt.qsmall) then<a name='2626'>
	qniic(i,k)=0._r8<a name='2627'>
	nsic(i,k)=0._r8<a name='2628'>
	end if<a name='2629'>
<a name='2630'>
	if (qric(i,k).lt.qsmall) then<a name='2631'>
	qric(i,k)=0._r8<a name='2632'>
	nric(i,k)=0._r8<a name='2633'>
	end if<a name='2634'>
<a name='2635'>
<font color=#447700>! make sure number concentration is a positive number to avoid <a name='2636'></font>
<font color=#447700>! taking root of negative<a name='2637'></font>
<a name='2638'>
	nric(i,k)=max(nric(i,k),0._r8)<a name='2639'>
	nsic(i,k)=max(nsic(i,k),0._r8)<a name='2640'>
<a name='2641'>
<font color=#447700>!.......................................................................<a name='2642'></font>
<font color=#447700>! get size distribution parameters for fallspeed calculations<a name='2643'></font>
<font color=#447700>!......................................................................<a name='2644'></font>
<font color=#447700>! rain<a name='2645'></font>
<a name='2646'>
	if (qric(i,k).ge.qsmall) then<a name='2647'>
	lamr(k) = (pi*rhow*nric(i,k)/qric(i,k))**(1._r8/3._r8)<a name='2648'>
	n0r(k) = nric(i,k)*lamr(k)<a name='2649'>
<a name='2650'>
<font color=#447700>! check for slope<a name='2651'></font>
<font color=#447700>! change lammax and lammin for rain and snow<a name='2652'></font>
<font color=#447700>! adjust vars<a name='2653'></font>
<a name='2654'>
	if (lamr(k).lt.lamminr) then<a name='2655'>
<a name='2656'>
	lamr(k) = lamminr<a name='2657'>
<a name='2658'>
	n0r(k) = lamr(k)**4*qric(i,k)/(pi*rhow)<a name='2659'>
	nric(i,k) = n0r(k)/lamr(k)<a name='2660'>
	else if (lamr(k).gt.lammaxr) then<a name='2661'>
	lamr(k) = lammaxr<a name='2662'>
	n0r(k) = lamr(k)**4*qric(i,k)/(pi*rhow)<a name='2663'>
	nric(i,k) = n0r(k)/lamr(k)<a name='2664'>
	end if<a name='2665'>
<a name='2666'>
<a name='2667'>
<font color=#447700>! 'final' values of number and mass weighted mean fallspeed for rain (m/s)<a name='2668'></font>
<a name='2669'>
        unr(k) = min(arn(i,k)*cons4/lamr(k)**br,9.1_r8*rhof(i,k))<a name='2670'>
        umr(k) = min(arn(i,k)*cons5/(6._r8*lamr(k)**br),9.1_r8*rhof(i,k))<a name='2671'>
<a name='2672'>
	else<a name='2673'>
	lamr(k) = 0._r8<a name='2674'>
	n0r(k) = 0._r8<a name='2675'>
	umr(k)=0._r8<a name='2676'>
	unr(k)=0._r8<a name='2677'>
	end if<a name='2678'>
<a name='2679'>
<font color=#447700>!calculate mean size of combined rain and snow<a name='2680'></font>
<a name='2681'>
        if (lamr(k).gt.0._r8) then<a name='2682'>
           Artmp = n0r(k) * pi / (2 * lamr(k)**3._r8)<a name='2683'>
        else <a name='2684'>
           Artmp = 0._r8<a name='2685'>
        endif<a name='2686'>
<a name='2687'>
        if (lamc(k).gt.0._r8) then<a name='2688'>
           Actmp = cdist1(k) * pi * gamma(pgam(k)+3._r8)/(4._r8 * lamc(k)**2._r8)<a name='2689'>
        else <a name='2690'>
           Actmp = 0._r8<a name='2691'>
        endif<a name='2692'>
<a name='2693'>
        if (Actmp.gt.0_r8.or.Artmp.gt.0) then<a name='2694'>
           rercld(i,k)=rercld(i,k) + 3._r8 *(qric(i,k) + qcic(i,k)) / (4._r8 * rhow * (Actmp + Artmp))<a name='2695'>
           arcld(i,k)=arcld(i,k)+1._r8<a name='2696'>
        endif<a name='2697'>
<a name='2698'>
<font color=#447700>!......................................................................<a name='2699'></font>
<font color=#447700>! snow<a name='2700'></font>
<a name='2701'>
	if (qniic(i,k).ge.qsmall) then<a name='2702'>
	lams(k) = (cons6*cs*nsic(i,k)/ &amp;<a name='2703'>
            qniic(i,k))**(1._r8/ds)<a name='2704'>
	n0s(k) = nsic(i,k)*lams(k)<a name='2705'>
<a name='2706'>
<font color=#447700>! check for slope<a name='2707'></font>
<font color=#447700>! adjust vars<a name='2708'></font>
<a name='2709'>
	if (lams(k).lt.lammins) then<a name='2710'>
	lams(k) = lammins<a name='2711'>
	n0s(k) = lams(k)**(ds+1._r8)*qniic(i,k)/(cs*cons6)<a name='2712'>
	nsic(i,k) = n0s(k)/lams(k)<a name='2713'>
<a name='2714'>
	else if (lams(k).gt.lammaxs) then<a name='2715'>
	lams(k) = lammaxs<a name='2716'>
	n0s(k) = lams(k)**(ds+1._r8)*qniic(i,k)/(cs*cons6)<a name='2717'>
	nsic(i,k) = n0s(k)/lams(k)<a name='2718'>
	end if<a name='2719'>
<a name='2720'>
<font color=#447700>! 'final' values of number and mass weighted mean fallspeed for snow (m/s)<a name='2721'></font>
<a name='2722'>
        ums(k) = min(asn(i,k)*cons8/(6._r8*lams(k)**bs),1.2_r8*rhof(i,k))<a name='2723'>
        uns(k) = min(asn(i,k)*cons7/lams(k)**bs,1.2_r8*rhof(i,k))<a name='2724'>
<a name='2725'>
	else<a name='2726'>
	lams(k) = 0._r8<a name='2727'>
	n0s(k) = 0._r8<a name='2728'>
	ums(k) = 0._r8<a name='2729'>
	uns(k) = 0._r8<a name='2730'>
	end if<a name='2731'>
<a name='2732'>
<font color=#447700>!c........................................................................<a name='2733'></font>
<font color=#447700>! sum over sub-step for average process rates<a name='2734'></font>
<a name='2735'>
<font color=#447700>! convert rain/snow q and N for output to history, note, <a name='2736'></font>
<font color=#447700>! output is for gridbox average<a name='2737'></font>
<a name='2738'>
	qrout(i,k)=qrout(i,k)+qric(i,k)*cldmax(i,k)<a name='2739'>
	qsout(i,k)=qsout(i,k)+qniic(i,k)*cldmax(i,k)<a name='2740'>
	nrout(i,k)=nrout(i,k)+nric(i,k)*rho(i,k)*cldmax(i,k)<a name='2741'>
	nsout(i,k)=nsout(i,k)+nsic(i,k)*rho(i,k)*cldmax(i,k)<a name='2742'>
<a name='2743'>
	tlat1(i,k)=tlat1(i,k)+tlat(i,k)<a name='2744'>
	qvlat1(i,k)=qvlat1(i,k)+qvlat(i,k)<a name='2745'>
	qctend1(i,k)=qctend1(i,k)+qctend(i,k)<a name='2746'>
	qitend1(i,k)=qitend1(i,k)+qitend(i,k)<a name='2747'>
	nctend1(i,k)=nctend1(i,k)+nctend(i,k)<a name='2748'>
	nitend1(i,k)=nitend1(i,k)+nitend(i,k)<a name='2749'>
<a name='2750'>
	t(i,k)=t(i,k)+tlat(i,k)*deltat/cpp<a name='2751'>
	q(i,k)=q(i,k)+qvlat(i,k)*deltat<a name='2752'>
	qc(i,k)=qc(i,k)+qctend(i,k)*deltat<a name='2753'>
	qi(i,k)=qi(i,k)+qitend(i,k)*deltat<a name='2754'>
	nc(i,k)=nc(i,k)+nctend(i,k)*deltat<a name='2755'>
	ni(i,k)=ni(i,k)+nitend(i,k)*deltat<a name='2756'>
<a name='2757'>
        rainrt1(i,k)=rainrt1(i,k)+rainrt(i,k)<a name='2758'>
<a name='2759'>
<font color=#447700>!divide rain radius over substeps for average<a name='2760'></font>
        if (arcld(i,k) .gt. 0._r8) then<a name='2761'>
           rercld(i,k)=rercld(i,k)/arcld(i,k)<a name='2762'>
        end if<a name='2763'>
<a name='2764'>
<font color=#447700>!calculate precip fluxes and adding them to summing sub-stepping variables<a name='2765'></font>
      <font color=#447700>!! flux is zero at top interface<a name='2766'></font>
      	rflx(i,1)=0.0_r8<a name='2767'>
      	sflx(i,1)=0.0_r8<a name='2768'>
	<a name='2769'>
      <font color=#447700>!! calculating the precip flux (kg/m2/s) as mixingratio(kg/kg)*airdensity(kg/m3)*massweightedfallspeed(m/s)<a name='2770'></font>
      	rflx(i,k+1)=qrout(i,k)*rho(i,k)*umr(k)<a name='2771'>
	sflx(i,k+1)=qsout(i,k)*rho(i,k)*ums(k)<a name='2772'>
	<a name='2773'>
      <font color=#447700>!! add to summing sub-stepping variable<a name='2774'></font>
	rflx1(i,k+1)=rflx1(i,k+1)+rflx(i,k+1)<a name='2775'>
	sflx1(i,k+1)=sflx1(i,k+1)+sflx(i,k+1)	<a name='2776'>
<a name='2777'>
<font color=#447700>!c........................................................................<a name='2778'></font>
<a name='2779'>
	end do <font color=#447700>! k loop<a name='2780'></font>
<a name='2781'>
	prect1(i)=prect1(i)+prect(i)<a name='2782'>
	preci1(i)=preci1(i)+preci(i)<a name='2783'>
<a name='2784'>
	end do <font color=#447700>! it loop, sub-step<a name='2785'></font>
<a name='2786'>
        do k = 1, pver               <a name='2787'>
        rate1ord_cw2pr_st(i,k) = qcsinksum_rate1ord(k)/max(qcsum_rate1ord(k),1.0e-30_r8) <a name='2788'>
        end do                       <a name='2789'>
<a name='2790'>
 300    continue  <font color=#447700>! continue if no cloud water<a name='2791'></font>
	end do <font color=#447700>! i loop<a name='2792'></font>
<a name='2793'>
<font color=#447700>! convert dt from sub-step back to full time step<a name='2794'></font>
	deltat=deltat*real(iter)<a name='2795'>
<a name='2796'>
<font color=#447700>!c.............................................................................<a name='2797'></font>
<a name='2798'>
        do i=1,ncol<a name='2799'>
<a name='2800'>
<font color=#447700>! skip all calculations if no cloud water<a name='2801'></font>
	if (ltrue(i).eq.0) then<a name='2802'>
<a name='2803'>
	do k=1,pver<a name='2804'>
<font color=#447700>! assign default values for effective radius<a name='2805'></font>
	effc(i,k)=10._r8<a name='2806'>
	effi(i,k)=25._r8<a name='2807'>
	effc_fn(i,k)=10._r8<a name='2808'>
        lamcrad(i,k)=0._r8<a name='2809'>
        pgamrad(i,k)=0._r8<a name='2810'>
        deffi(i,k)=0._r8<a name='2811'>
	end do<a name='2812'>
	goto 500<a name='2813'>
	end if<a name='2814'>
<a name='2815'>
<font color=#447700>! initialize nstep for sedimentation sub-steps<a name='2816'></font>
	nstep = 1<a name='2817'>
<a name='2818'>
<font color=#447700>! divide precip rate by number of sub-steps to get average over time step<a name='2819'></font>
<a name='2820'>
	prect(i)=prect1(i)/real(iter)<a name='2821'>
	preci(i)=preci1(i)/real(iter)<a name='2822'>
<a name='2823'>
       do k=1,pver<a name='2824'>
<a name='2825'>
<font color=#447700>! assign variables back to start-of-timestep values before updating after sub-steps <a name='2826'></font>
<a name='2827'>
	t(i,k)=t1(i,k)<a name='2828'>
	q(i,k)=q1(i,k)<a name='2829'>
	qc(i,k)=qc1(i,k)<a name='2830'>
	qi(i,k)=qi1(i,k)<a name='2831'>
	nc(i,k)=nc1(i,k)<a name='2832'>
	ni(i,k)=ni1(i,k)<a name='2833'>
<a name='2834'>
<font color=#447700>! divide microphysical tendencies by number of sub-steps to get average over time step<a name='2835'></font>
<a name='2836'>
	tlat(i,k)=tlat1(i,k)/real(iter)<a name='2837'>
	qvlat(i,k)=qvlat1(i,k)/real(iter)<a name='2838'>
	qctend(i,k)=qctend1(i,k)/real(iter)<a name='2839'>
	qitend(i,k)=qitend1(i,k)/real(iter)<a name='2840'>
	nctend(i,k)=nctend1(i,k)/real(iter)<a name='2841'>
	nitend(i,k)=nitend1(i,k)/real(iter)<a name='2842'>
 <a name='2843'>
        rainrt(i,k)=rainrt1(i,k)/real(iter)<a name='2844'>
<a name='2845'>
<font color=#447700>! divide by number of sub-steps to find final values<a name='2846'></font>
	rflx(i,k+1)=rflx1(i,k+1)/real(iter)<a name='2847'>
	sflx(i,k+1)=sflx1(i,k+1)/real(iter)<a name='2848'>
<a name='2849'>
<font color=#447700>! divide output precip q and N by number of sub-steps to get average over time step<a name='2850'></font>
<a name='2851'>
	qrout(i,k)=qrout(i,k)/real(iter)<a name='2852'>
	qsout(i,k)=qsout(i,k)/real(iter)<a name='2853'>
	nrout(i,k)=nrout(i,k)/real(iter)<a name='2854'>
	nsout(i,k)=nsout(i,k)/real(iter)<a name='2855'>
<a name='2856'>
<font color=#447700>! divide trop_mozart variables by number of sub-steps to get average over time step <a name='2857'></font>
<a name='2858'>
	nevapr(i,k) = nevapr(i,k)/real(iter)<a name='2859'>
	evapsnow(i,k) = evapsnow(i,k)/real(iter)<a name='2860'>
	prain(i,k) = prain(i,k)/real(iter)<a name='2861'>
	prodsnow(i,k) = prodsnow(i,k)/real(iter)<a name='2862'>
	cmeout(i,k) = cmeout(i,k)/real(iter)<a name='2863'>
<a name='2864'>
	cmeiout(i,k) = cmeiout(i,k)/real(iter)<a name='2865'>
        meltsdt(i,k) = meltsdt(i,k)/real(iter)<a name='2866'>
        frzrdt (i,k) = frzrdt (i,k)/real(iter)<a name='2867'>
<a name='2868'>
<a name='2869'>
<font color=#447700>! microphysics output<a name='2870'></font>
        prao(i,k)=prao(i,k)/real(iter)<a name='2871'>
        prco(i,k)=prco(i,k)/real(iter)<a name='2872'>
        mnuccco(i,k)=mnuccco(i,k)/real(iter)<a name='2873'>
        mnuccto(i,k)=mnuccto(i,k)/real(iter)<a name='2874'>
        msacwio(i,k)=msacwio(i,k)/real(iter)<a name='2875'>
        psacwso(i,k)=psacwso(i,k)/real(iter)<a name='2876'>
        bergso(i,k)=bergso(i,k)/real(iter)<a name='2877'>
        bergo(i,k)=bergo(i,k)/real(iter)<a name='2878'>
        prcio(i,k)=prcio(i,k)/real(iter)<a name='2879'>
        praio(i,k)=praio(i,k)/real(iter)<a name='2880'>
<a name='2881'>
        mnuccro(i,k)=mnuccro(i,k)/real(iter)<a name='2882'>
        pracso (i,k)=pracso (i,k)/real(iter)<a name='2883'>
<a name='2884'>
        mnuccdo(i,k)=mnuccdo(i,k)/real(iter)<a name='2885'>
<a name='2886'>
<font color=#447700>! modify to include snow. in prain &amp; evap (diagnostic here: for wet dep)<a name='2887'></font>
        nevapr(i,k) = nevapr(i,k) + evapsnow(i,k)<a name='2888'>
        prain(i,k) = prain(i,k) + prodsnow(i,k)<a name='2889'>
<a name='2890'>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2891'></font>
<font color=#447700>! calculate sedimentation for cloud water and ice<a name='2892'></font>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='2893'></font>
<a name='2894'>
<font color=#447700>! update in-cloud cloud mixing ratio and number concentration <a name='2895'></font>
<font color=#447700>! with microphysical tendencies to calculate sedimentation, assign to dummy vars<a name='2896'></font>
<font color=#447700>! note: these are in-cloud values***, hence we divide by cloud fraction<a name='2897'></font>
<a name='2898'>
        dumc(i,k) = (qc(i,k)+qctend(i,k)*deltat)/lcldm(i,k)<a name='2899'>
        dumi(i,k) = (qi(i,k)+qitend(i,k)*deltat)/icldm(i,k)<a name='2900'>
        dumnc(i,k) = max((nc(i,k)+nctend(i,k)*deltat)/lcldm(i,k),0._r8)<a name='2901'>
        dumni(i,k) = max((ni(i,k)+nitend(i,k)*deltat)/icldm(i,k),0._r8)<a name='2902'>
<a name='2903'>
<font color=#447700>! obtain new slope parameter to avoid possible singularity<a name='2904'></font>
<a name='2905'>
	if (dumi(i,k).ge.qsmall) then<a name='2906'>
<font color=#447700>! add upper limit to in-cloud number concentration to prevent numerical error<a name='2907'></font>
	dumni(i,k)=min(dumni(i,k),dumi(i,k)*1.e20_r8)<a name='2908'>
<a name='2909'>
	lami(k) = (cons1*ci* &amp;<a name='2910'>
              dumni(i,k)/dumi(i,k))**(1._r8/di)<a name='2911'>
        lami(k)=max(lami(k),lammini)<a name='2912'>
        lami(k)=min(lami(k),lammaxi)<a name='2913'>
        else<a name='2914'>
           lami(k)=0._r8<a name='2915'>
        end if<a name='2916'>
<a name='2917'>
	if (dumc(i,k).ge.qsmall) then<a name='2918'>
<font color=#447700>! add upper limit to in-cloud number concentration to prevent numerical error<a name='2919'></font>
	dumnc(i,k)=min(dumnc(i,k),dumc(i,k)*1.e20_r8)<a name='2920'>
<font color=#447700>! add lower limit to in-cloud number concentration<a name='2921'></font>
         dumnc(i,k)=max(dumnc(i,k),cdnl/rho(i,k)) <font color=#447700>! sghan minimum in #/cm3 <a name='2922'></font>
         pgam(k)=0.0005714_r8*(ncic(i,k)/1.e6_r8*rho(i,k))+0.2714_r8<a name='2923'>
         pgam(k)=1._r8/(pgam(k)**2)-1._r8<a name='2924'>
         pgam(k)=max(pgam(k),2._r8)<a name='2925'>
         pgam(k)=min(pgam(k),15._r8)<a name='2926'>
<a name='2927'>
	lamc(k) = (pi/6._r8*rhow*dumnc(i,k)*gamma(pgam(k)+4._r8)/ &amp;<a name='2928'>
                 (dumc(i,k)*gamma(pgam(k)+1._r8)))**(1._r8/3._r8)<a name='2929'>
	lammin = (pgam(k)+1._r8)/50.e-6_r8<a name='2930'>
	lammax = (pgam(k)+1._r8)/2.e-6_r8<a name='2931'>
        lamc(k)=max(lamc(k),lammin)<a name='2932'>
        lamc(k)=min(lamc(k),lammax)<a name='2933'>
        else<a name='2934'>
           lamc(k)=0._r8<a name='2935'>
        end if<a name='2936'>
<a name='2937'>
<font color=#447700>! calculate number and mass weighted fall velocity for droplets<a name='2938'></font>
<font color=#447700>! include effects of sub-grid distribution of cloud water<a name='2939'></font>
<a name='2940'>
<a name='2941'>
	if (dumc(i,k).ge.qsmall) then<a name='2942'>
	unc = &amp;<a name='2943'>
              acn(i,k)*gamma(1._r8+bc+pgam(k))/ &amp;<a name='2944'>
               (lamc(k)**bc*gamma(pgam(k)+1._r8))<a name='2945'>
	umc = &amp;<a name='2946'>
              acn(i,k)*gamma(4._r8+bc+pgam(k))/ &amp;<a name='2947'>
             (lamc(k)**bc*gamma(pgam(k)+4._r8))<a name='2948'>
<font color=#447700>! fallspeed for output<a name='2949'></font>
	vtrmc(i,k)=umc<a name='2950'>
	else<a name='2951'>
	umc = 0._r8<a name='2952'>
	unc = 0._r8<a name='2953'>
	end if<a name='2954'>
<a name='2955'>
<font color=#447700>! calculate number and mass weighted fall velocity for cloud ice<a name='2956'></font>
<a name='2957'>
	if (dumi(i,k).ge.qsmall) then<a name='2958'>
	uni =  ain(i,k)*cons16/lami(k)**bi<a name='2959'>
	umi = ain(i,k)*cons17/(6._r8*lami(k)**bi)<a name='2960'>
        uni=min(uni,1.2_r8*rhof(i,k))<a name='2961'>
        umi=min(umi,1.2_r8*rhof(i,k))<a name='2962'>
<a name='2963'>
<font color=#447700>! fallspeed<a name='2964'></font>
	vtrmi(i,k)=umi<a name='2965'>
	else<a name='2966'>
	umi = 0._r8<a name='2967'>
	uni = 0._r8<a name='2968'>
	end if<a name='2969'>
<a name='2970'>
	fi(k) = g*rho(i,k)*umi<a name='2971'>
	fni(k) = g*rho(i,k)*uni<a name='2972'>
	fc(k) = g*rho(i,k)*umc<a name='2973'>
	fnc(k) = g*rho(i,k)*unc<a name='2974'>
<a name='2975'>
<font color=#447700>! calculate number of split time steps to ensure courant stability criteria<a name='2976'></font>
<font color=#447700>! for sedimentation calculations<a name='2977'></font>
<a name='2978'>
	rgvm = max(fi(k),fc(k),fni(k),fnc(k))<a name='2979'>
	nstep = max(int(rgvm*deltat/pdel(i,k)+1._r8),nstep)<a name='2980'>
<a name='2981'>
<font color=#447700>! redefine dummy variables - sedimentation is calculated over grid-scale<a name='2982'></font>
<font color=#447700>! quantities to ensure conservation<a name='2983'></font>
<a name='2984'>
        dumc(i,k) = (qc(i,k)+qctend(i,k)*deltat)<a name='2985'>
        dumi(i,k) = (qi(i,k)+qitend(i,k)*deltat)<a name='2986'>
        dumnc(i,k) = max((nc(i,k)+nctend(i,k)*deltat),0._r8)<a name='2987'>
        dumni(i,k) = max((ni(i,k)+nitend(i,k)*deltat),0._r8)<a name='2988'>
<a name='2989'>
	if (dumc(i,k).lt.qsmall) dumnc(i,k)=0._r8<a name='2990'>
	if (dumi(i,k).lt.qsmall) dumni(i,k)=0._r8<a name='2991'>
<a name='2992'>
	end do       <font color=#447700>!!! vertical loop<a name='2993'></font>
<a name='2994'>
	do n = 1,nstep  <font color=#447700>!! loop over sub-time step to ensure stability	<a name='2995'></font>
	<a name='2996'>
	do k = 1,pver<a name='2997'>
	falouti(k) = fi(k)*dumi(i,k)<a name='2998'>
	faloutni(k) = fni(k)*dumni(i,k)<a name='2999'>
	faloutc(k) = fc(k)*dumc(i,k)<a name='3000'>
	faloutnc(k) = fnc(k)*dumnc(i,k)<a name='3001'>
	end do<a name='3002'>
<a name='3003'>
<font color=#447700>! top of model<a name='3004'></font>
<a name='3005'>
	k = 1<a name='3006'>
	faltndi = falouti(k)/pdel(i,k)<a name='3007'>
	faltndni = faloutni(k)/pdel(i,k)<a name='3008'>
	faltndc = faloutc(k)/pdel(i,k)<a name='3009'>
        faltndnc = faloutnc(k)/pdel(i,k)<a name='3010'>
<a name='3011'>
<font color=#447700>! add fallout terms to microphysical tendencies	<a name='3012'></font>
<a name='3013'>
	qitend(i,k) = qitend(i,k)-faltndi/nstep<a name='3014'>
	nitend(i,k) = nitend(i,k)-faltndni/nstep<a name='3015'>
	qctend(i,k) = qctend(i,k)-faltndc/nstep<a name='3016'>
        nctend(i,k) = nctend(i,k)-faltndnc/nstep<a name='3017'>
<a name='3018'>
<font color=#447700>! sedimentation tendencies for output<a name='3019'></font>
	qcsedten(i,k)=qcsedten(i,k)-faltndc/nstep<a name='3020'>
	qisedten(i,k)=qisedten(i,k)-faltndi/nstep<a name='3021'>
<a name='3022'>
	dumi(i,k) = dumi(i,k)-faltndi*deltat/nstep<a name='3023'>
	dumni(i,k) = dumni(i,k)-faltndni*deltat/nstep<a name='3024'>
	dumc(i,k) = dumc(i,k)-faltndc*deltat/nstep<a name='3025'>
        dumnc(i,k) = dumnc(i,k)-faltndnc*deltat/nstep<a name='3026'>
<a name='3027'>
	do k = 2,pver<a name='3028'>
<a name='3029'>
<font color=#447700>! for cloud liquid and ice, if cloud fraction increases with height<a name='3030'></font>
<font color=#447700>! then add flux from above to both vapor and cloud water of current level<a name='3031'></font>
<font color=#447700>! this means that flux entering clear portion of cell from above evaporates<a name='3032'></font>
<font color=#447700>! instantly<a name='3033'></font>
<a name='3034'>
        dum=lcldm(i,k)/lcldm(i,k-1)<a name='3035'>
	dum=min(dum,1._r8)<a name='3036'>
        dum1=icldm(i,k)/icldm(i,k-1)<a name='3037'>
	dum1=min(dum1,1._r8)<a name='3038'>
<a name='3039'>
	faltndqie=(falouti(k)-falouti(k-1))/pdel(i,k)<a name='3040'>
	faltndi=(falouti(k)-dum1*falouti(k-1))/pdel(i,k)<a name='3041'>
	faltndni=(faloutni(k)-dum1*faloutni(k-1))/pdel(i,k)<a name='3042'>
	faltndqce=(faloutc(k)-faloutc(k-1))/pdel(i,k)<a name='3043'>
	faltndc=(faloutc(k)-dum*faloutc(k-1))/pdel(i,k)<a name='3044'>
	faltndnc=(faloutnc(k)-dum*faloutnc(k-1))/pdel(i,k)<a name='3045'>
<a name='3046'>
<font color=#447700>! add fallout terms to eulerian tendencies<a name='3047'></font>
<a name='3048'>
	qitend(i,k) = qitend(i,k)-faltndi/nstep<a name='3049'>
	nitend(i,k) = nitend(i,k)-faltndni/nstep<a name='3050'>
	qctend(i,k) = qctend(i,k)-faltndc/nstep<a name='3051'>
        nctend(i,k) = nctend(i,k)-faltndnc/nstep<a name='3052'>
<a name='3053'>
<font color=#447700>! sedimentation tendencies for output<a name='3054'></font>
	qcsedten(i,k)=qcsedten(i,k)-faltndc/nstep<a name='3055'>
	qisedten(i,k)=qisedten(i,k)-faltndi/nstep<a name='3056'>
	<a name='3057'>
<font color=#447700>! add terms to to evap/sub of cloud water<a name='3058'></font>
<a name='3059'>
        qvlat(i,k)=qvlat(i,k)-(faltndqie-faltndi)/nstep<a name='3060'>
<font color=#447700>! for output<a name='3061'></font>
        qisevap(i,k)=qisevap(i,k)-(faltndqie-faltndi)/nstep<a name='3062'>
        qvlat(i,k)=qvlat(i,k)-(faltndqce-faltndc)/nstep<a name='3063'>
<font color=#447700>! for output<a name='3064'></font>
        qcsevap(i,k)=qcsevap(i,k)-(faltndqce-faltndc)/nstep<a name='3065'>
<a name='3066'>
	tlat(i,k)=tlat(i,k)+(faltndqie-faltndi)*xxls/nstep<a name='3067'>
	tlat(i,k)=tlat(i,k)+(faltndqce-faltndc)*xxlv/nstep<a name='3068'>
<a name='3069'>
	dumi(i,k) = dumi(i,k)-faltndi*deltat/nstep<a name='3070'>
	dumni(i,k) = dumni(i,k)-faltndni*deltat/nstep<a name='3071'>
	dumc(i,k) = dumc(i,k)-faltndc*deltat/nstep<a name='3072'>
        dumnc(i,k) = dumnc(i,k)-faltndnc*deltat/nstep<a name='3073'>
<a name='3074'>
        Fni(K)=MAX(Fni(K)/pdel(i,K),Fni(K-1)/pdel(i,K-1))*pdel(i,K)<a name='3075'>
        FI(K)=MAX(FI(K)/pdel(i,K),FI(K-1)/pdel(i,K-1))*pdel(i,K)<a name='3076'>
        fnc(k)=max(fnc(k)/pdel(i,k),fnc(k-1)/pdel(i,k-1))*pdel(i,k)<a name='3077'>
        Fc(K)=MAX(Fc(K)/pdel(i,K),Fc(K-1)/pdel(i,K-1))*pdel(i,K)<a name='3078'>
<a name='3079'>
	end do   <font color=#447700>!! k loop<a name='3080'></font>
<a name='3081'>
<font color=#447700>! units below are m/s<a name='3082'></font>
<font color=#447700>! cloud water/ice sedimentation flux at surface <a name='3083'></font>
<font color=#447700>! is added to precip flux at surface to get total precip (cloud + precip water)<a name='3084'></font>
<font color=#447700>! rate<a name='3085'></font>
<a name='3086'>
	  prect(i) = prect(i)+(faloutc(pver)+falouti(pver)) &amp;<a name='3087'>
                     /g/nstep/1000._r8	<a name='3088'>
	  preci(i) = preci(i)+(falouti(pver)) &amp;<a name='3089'>
                     /g/nstep/1000._r8<a name='3090'>
<a name='3091'>
        end do   <font color=#447700>!! nstep loop<a name='3092'></font>
<a name='3093'>
<font color=#447700>! end sedimentation<a name='3094'></font>
<font color=#447700>!ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='3095'></font>
<a name='3096'>
<font color=#447700>! get new update for variables that includes sedimentation tendency<a name='3097'></font>
<font color=#447700>! note : here dum variables are grid-average, NOT in-cloud<a name='3098'></font>
<a name='3099'>
  do k=1,pver	<a name='3100'>
<a name='3101'>
        dumc(i,k) = max(qc(i,k)+qctend(i,k)*deltat,0._r8)<a name='3102'>
        dumi(i,k) = max(qi(i,k)+qitend(i,k)*deltat,0._r8)<a name='3103'>
        dumnc(i,k) = max(nc(i,k)+nctend(i,k)*deltat,0._r8)<a name='3104'>
        dumni(i,k) = max(ni(i,k)+nitend(i,k)*deltat,0._r8)<a name='3105'>
<a name='3106'>
	if (dumc(i,k).lt.qsmall) dumnc(i,k)=0._r8<a name='3107'>
	if (dumi(i,k).lt.qsmall) dumni(i,k)=0._r8<a name='3108'>
	<a name='3109'>
<font color=#447700>! calculate instantaneous processes (melting, homogeneous freezing)<a name='3110'></font>
<a name='3111'>
        if (t(i,k)+tlat(i,k)/cpp*deltat &gt; tmelt) then<a name='3112'>
           if (dumi(i,k) &gt; 0._r8) then<a name='3113'>
<a name='3114'>
<font color=#447700>! limit so that melting does not push temperature below freezing<a name='3115'></font>
	      dum = -dumi(i,k)*xlf/cpp<a name='3116'>
	      if (t(i,k)+tlat(i,k)/cpp*deltat+dum.lt.tmelt) then<a name='3117'>
	       dum = (t(i,k)+tlat(i,k)/cpp*deltat-tmelt)*cpp/xlf<a name='3118'>
	       dum = dum/dumi(i,k)*xlf/cpp <a name='3119'>
	       dum = max(0._r8,dum)<a name='3120'>
	       dum = min(1._r8,dum)<a name='3121'>
	      else<a name='3122'>
	       dum = 1._r8<a name='3123'>
	      end if<a name='3124'>
<a name='3125'>
              qctend(i,k)=qctend(i,k)+dum*dumi(i,k)/deltat<a name='3126'>
<a name='3127'>
<font color=#447700>! for output<a name='3128'></font>
              melto(i,k)=dum*dumi(i,k)/deltat<a name='3129'>
<a name='3130'>
<font color=#447700>! assume melting ice produces droplet<a name='3131'></font>
<font color=#447700>! mean volume radius of 8 micron<a name='3132'></font>
<a name='3133'>
	      nctend(i,k)=nctend(i,k)+3._r8*dum*dumi(i,k)/deltat/ &amp;<a name='3134'>
               (4._r8*pi*5.12e-16_r8*rhow)<a name='3135'>
<a name='3136'>
              qitend(i,k)=((1._r8-dum)*dumi(i,k)-qi(i,k))/deltat<a name='3137'>
              nitend(i,k)=((1._r8-dum)*dumni(i,k)-ni(i,k))/deltat<a name='3138'>
              tlat(i,k)=tlat(i,k)-xlf*dum*dumi(i,k)/deltat<a name='3139'>
           end if<a name='3140'>
        end if<a name='3141'>
<a name='3142'>
<font color=#447700>! homogeneously freeze droplets at -40 C<a name='3143'></font>
<a name='3144'>
        if (t(i,k)+tlat(i,k)/cpp*deltat &lt; 233.15_r8) then<a name='3145'>
           if (dumc(i,k) &gt; 0._r8) then<a name='3146'>
<a name='3147'>
<font color=#447700>! limit so that freezing does not push temperature above threshold<a name='3148'></font>
	      dum = dumc(i,k)*xlf/cpp<a name='3149'>
	      if (t(i,k)+tlat(i,k)/cpp*deltat+dum.gt.233.15_r8) then<a name='3150'>
	       dum = -(t(i,k)+tlat(i,k)/cpp*deltat-233.15_r8)*cpp/xlf<a name='3151'>
	       dum = dum/dumc(i,k)*xlf/cpp<a name='3152'>
	       dum = max(0._r8,dum)<a name='3153'>
	       dum = min(1._r8,dum)<a name='3154'>
	      else<a name='3155'>
	       dum = 1._r8<a name='3156'>
	      end if<a name='3157'>
<a name='3158'>
              qitend(i,k)=qitend(i,k)+dum*dumc(i,k)/deltat<a name='3159'>
<font color=#447700>! for output<a name='3160'></font>
              homoo(i,k)=dum*dumc(i,k)/deltat<a name='3161'>
<a name='3162'>
<font color=#447700>! assume 25 micron mean volume radius of homogeneously frozen droplets<a name='3163'></font>
<font color=#447700>! consistent with size of detrained ice in stratiform.F90<a name='3164'></font>
	      nitend(i,k)=nitend(i,k)+dum*3._r8*dumc(i,k)/(4._r8*3.14_r8*1.563e-14_r8* &amp;<a name='3165'>
                 500._r8)/deltat<a name='3166'>
              qctend(i,k)=((1._r8-dum)*dumc(i,k)-qc(i,k))/deltat<a name='3167'>
              nctend(i,k)=((1._r8-dum)*dumnc(i,k)-nc(i,k))/deltat<a name='3168'>
              tlat(i,k)=tlat(i,k)+xlf*dum*dumc(i,k)/deltat<a name='3169'>
           end if<a name='3170'>
        end if<a name='3171'>
<a name='3172'>
<font color=#447700>! remove any excess over-saturation, which is possible due to non-linearity when adding <a name='3173'></font>
<font color=#447700>! together all microphysical processes<a name='3174'></font>
<font color=#447700>! follow code similar to old CAM scheme<a name='3175'></font>
<a name='3176'>
	qtmp=q(i,k)+qvlat(i,k)*deltat<a name='3177'>
	ttmp=t(i,k)+tlat(i,k)/cpp*deltat<a name='3178'>
<a name='3179'>
        esn = <A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_8">(ttmp,0)  <font color=#447700>! use rhw to allow ice supersaturation<a name='3180'></font>
	qsn = min(epsqs*esn/(p(i,k)-(1._r8-epsqs)*esn),1._r8)<a name='3181'>
<a name='3182'>
	if (qtmp &gt; qsn .and. qsn &gt; 0) then<a name='3183'>
<font color=#447700>! expression below is approximate since there may be ice deposition<a name='3184'></font>
	dum = (qtmp-qsn)/(1._r8+cons27*qsn/(cpp*rv*ttmp**2))/deltat<a name='3185'>
<font color=#447700>! add to output cme<a name='3186'></font>
	cmeout(i,k) = cmeout(i,k)+dum<a name='3187'>
<font color=#447700>! now add to tendencies, partition between liquid and ice based on temperature<a name='3188'></font>
           if (ttmp &gt; 268.15_r8) then<a name='3189'>
              dum1=0.0_r8<a name='3190'>
<font color=#447700>! now add to tendencies, partition between liquid and ice based on te<a name='3191'></font>
           else if (ttmp &lt; 238.15_r8) then<a name='3192'>
              dum1=1.0_r8<a name='3193'>
           else<a name='3194'>
              dum1=(268.15_r8-ttmp)/30._r8<a name='3195'>
	   end if  <a name='3196'>
<a name='3197'>
	dum = (qtmp-qsn)/(1._r8+(xxls*dum1+xxlv*(1._r8-dum1))**2 &amp;<a name='3198'>
                     *qsn/(cpp*rv*ttmp**2))/deltat<a name='3199'>
	qctend(i,k)=qctend(i,k)+dum*(1._r8-dum1)<a name='3200'>
<font color=#447700>! for output<a name='3201'></font>
        qcreso(i,k)=dum*(1._r8-dum1)<a name='3202'>
	qitend(i,k)=qitend(i,k)+dum*dum1<a name='3203'>
	qireso(i,k)=dum*dum1<a name='3204'>
	qvlat(i,k)=qvlat(i,k)-dum<a name='3205'>
<font color=#447700>! for output<a name='3206'></font>
        qvres(i,k)=-dum<a name='3207'>
	tlat(i,k)=tlat(i,k)+dum*(1._r8-dum1)*xxlv+dum*dum1*xxls<a name='3208'>
	end if<a name='3209'>
<a name='3210'>
<font color=#447700>!...............................................................................<a name='3211'></font>
<font color=#447700>! calculate effective radius for pass to radiation code<a name='3212'></font>
<font color=#447700>! if no cloud water, default value is 10 micron for droplets,<a name='3213'></font>
<font color=#447700>! 25 micron for cloud ice<a name='3214'></font>
<a name='3215'>
<font color=#447700>! update cloud variables after instantaneous processes to get effective radius<a name='3216'></font>
<font color=#447700>! variables are in-cloud to calculate size dist parameters<a name='3217'></font>
<a name='3218'>
        dumc(i,k) = max(qc(i,k)+qctend(i,k)*deltat,0._r8)/lcldm(i,k)<a name='3219'>
        dumi(i,k) = max(qi(i,k)+qitend(i,k)*deltat,0._r8)/icldm(i,k)<a name='3220'>
        dumnc(i,k) = max(nc(i,k)+nctend(i,k)*deltat,0._r8)/lcldm(i,k)<a name='3221'>
        dumni(i,k) = max(ni(i,k)+nitend(i,k)*deltat,0._r8)/icldm(i,k)<a name='3222'>
<a name='3223'>
<font color=#447700>! limit in-cloud mixing ratio to reasonable value of 5 g kg-1<a name='3224'></font>
<a name='3225'>
	dumc(i,k)=min(dumc(i,k),5.e-3_r8)<a name='3226'>
	dumi(i,k)=min(dumi(i,k),5.e-3_r8)<a name='3227'>
<a name='3228'>
<font color=#447700>!...................<a name='3229'></font>
<font color=#447700>! cloud ice effective radius<a name='3230'></font>
<a name='3231'>
	if (dumi(i,k).ge.qsmall) then<a name='3232'>
<font color=#447700>! add upper limit to in-cloud number concentration to prevent numerical error<a name='3233'></font>
	dumni(i,k)=min(dumni(i,k),dumi(i,k)*1.e20_r8)<a name='3234'>
	lami(k) = (cons1*ci* &amp;<a name='3235'>
              dumni(i,k)/dumi(i,k))**(1._r8/di)<a name='3236'>
<a name='3237'>
	if (lami(k).lt.lammini) then<a name='3238'>
	lami(k) = lammini<a name='3239'>
	n0i(k) = lami(k)**(di+1._r8)*dumi(i,k)/(ci*cons1)<a name='3240'>
	niic(i,k) = n0i(k)/lami(k)<a name='3241'>
<font color=#447700>! adjust number conc if needed to keep mean size in reasonable range<a name='3242'></font>
	nitend(i,k)=(niic(i,k)*icldm(i,k)-ni(i,k))/deltat<a name='3243'>
	else if (lami(k).gt.lammaxi) then<a name='3244'>
	lami(k) = lammaxi<a name='3245'>
	n0i(k) = lami(k)**(di+1._r8)*dumi(i,k)/(ci*cons1)<a name='3246'>
	niic(i,k) = n0i(k)/lami(k)<a name='3247'>
<font color=#447700>! adjust number conc if needed to keep mean size in reasonable range<a name='3248'></font>
	nitend(i,k)=(niic(i,k)*icldm(i,k)-ni(i,k))/deltat<a name='3249'>
	end if<a name='3250'>
	   effi(i,k) = 1.5_r8/lami(k)*1.e6_r8<a name='3251'>
<a name='3252'>
        else<a name='3253'>
	   effi(i,k) = 25._r8<a name='3254'>
        end if<a name='3255'>
<a name='3256'>
<font color=#447700>!...................<a name='3257'></font>
<font color=#447700>! cloud droplet effective radius<a name='3258'></font>
<a name='3259'>
	if (dumc(i,k).ge.qsmall) then<a name='3260'>
<a name='3261'>
<font color=#447700>! add upper limit to in-cloud number concentration to prevent numerical error<a name='3262'></font>
           dumnc(i,k)=min(dumnc(i,k),dumc(i,k)*1.e20_r8)<a name='3263'>
<a name='3264'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='3265'></font>
<font color=#447700>! set tendency to ensure minimum droplet concentration<a name='3266'></font>
<font color=#447700>! after update by microphysics, except when lambda exceeds bounds on mean drop<a name='3267'></font>
<font color=#447700>! size or if there is no cloud water<a name='3268'></font>
           if (dumnc(i,k).lt.cdnl/rho(i,k)) then   <a name='3269'>
              nctend(i,k)=(cdnl/rho(i,k)*lcldm(i,k)-nc(i,k))/deltat   <a name='3270'>
           end if<a name='3271'>
           dumnc(i,k)=max(dumnc(i,k),cdnl/rho(i,k)) <font color=#447700>! sghan minimum in #/cm3 <a name='3272'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='3273'></font>
           pgam(k)=0.0005714_r8*(ncic(i,k)/1.e6_r8*rho(i,k))+0.2714_r8<a name='3274'>
           pgam(k)=1._r8/(pgam(k)**2)-1._r8<a name='3275'>
           pgam(k)=max(pgam(k),2._r8)<a name='3276'>
           pgam(k)=min(pgam(k),15._r8)<a name='3277'>
           <a name='3278'>
           lamc(k) = (pi/6._r8*rhow*dumnc(i,k)*gamma(pgam(k)+4._r8)/ &amp;<a name='3279'>
                     (dumc(i,k)*gamma(pgam(k)+1._r8)))**(1._r8/3._r8)<a name='3280'>
           lammin = (pgam(k)+1._r8)/50.e-6_r8<a name='3281'>
           lammax = (pgam(k)+1._r8)/2.e-6_r8<a name='3282'>
           if (lamc(k).lt.lammin) then<a name='3283'>
              lamc(k) = lammin<a name='3284'>
              ncic(i,k) = 6._r8*lamc(k)**3*dumc(i,k)* &amp;<a name='3285'>
                   gamma(pgam(k)+1._r8)/ &amp;<a name='3286'>
                   (pi*rhow*gamma(pgam(k)+4._r8))<a name='3287'>
<font color=#447700>! adjust number conc if needed to keep mean size in reasonable range<a name='3288'></font>
              nctend(i,k)=(ncic(i,k)*lcldm(i,k)-nc(i,k))/deltat<a name='3289'>
<a name='3290'>
           else if (lamc(k).gt.lammax) then<a name='3291'>
              lamc(k) = lammax<a name='3292'>
              ncic(i,k) = 6._r8*lamc(k)**3*dumc(i,k)* &amp;<a name='3293'>
                   gamma(pgam(k)+1._r8)/ &amp;<a name='3294'>
                   (pi*rhow*gamma(pgam(k)+4._r8))<a name='3295'>
<font color=#447700>! adjust number conc if needed to keep mean size in reasonable range<a name='3296'></font>
              nctend(i,k)=(ncic(i,k)*lcldm(i,k)-nc(i,k))/deltat<a name='3297'>
	end if<a name='3298'>
<a name='3299'>
        effc(i,k) = &amp;<a name='3300'>
             gamma(pgam(k)+4._r8)/ &amp;<a name='3301'>
             gamma(pgam(k)+3._r8)/lamc(k)/2._r8*1.e6_r8<a name='3302'>
<font color=#447700>!assign output fields for shape here<a name='3303'></font>
        lamcrad(i,k)=lamc(k)<a name='3304'>
        pgamrad(i,k)=pgam(k)<a name='3305'>
<a name='3306'>
        else<a name='3307'>
           effc(i,k) = 10._r8<a name='3308'>
           lamcrad(i,k)=0._r8<a name='3309'>
           pgamrad(i,k)=0._r8<a name='3310'>
        end if<a name='3311'>
<a name='3312'>
<font color=#447700>! ice effective diameter for david mitchell's optics<a name='3313'></font>
        deffi(i,k)=effi(i,k)*rhoi/917._r8*2._r8<a name='3314'>
<a name='3315'>
<a name='3316'>
<font color=#447700>!!! recalculate effective radius for constant number, in order to separate<a name='3317'></font>
<font color=#447700>! first and second indirect effects<a name='3318'></font>
<font color=#447700>! assume constant number of 10^8 kg-1<a name='3319'></font>
<a name='3320'>
	dumnc(i,k)=1.e8<a name='3321'>
<a name='3322'>
	if (dumc(i,k).ge.qsmall) then<a name='3323'>
         pgam(k)=0.0005714_r8*(ncic(i,k)/1.e6_r8*rho(i,k))+0.2714_r8<a name='3324'>
         pgam(k)=1._r8/(pgam(k)**2)-1._r8<a name='3325'>
         pgam(k)=max(pgam(k),2._r8)<a name='3326'>
         pgam(k)=min(pgam(k),15._r8)<a name='3327'>
<a name='3328'>
	lamc(k) = (pi/6._r8*rhow*dumnc(i,k)*gamma(pgam(k)+4._r8)/ &amp;<a name='3329'>
                 (dumc(i,k)*gamma(pgam(k)+1._r8)))**(1._r8/3._r8)<a name='3330'>
	lammin = (pgam(k)+1._r8)/50.e-6_r8<a name='3331'>
	lammax = (pgam(k)+1._r8)/2.e-6_r8<a name='3332'>
	if (lamc(k).lt.lammin) then<a name='3333'>
	lamc(k) = lammin<a name='3334'>
	else if (lamc(k).gt.lammax) then<a name='3335'>
	lamc(k) = lammax<a name='3336'>
	end if<a name='3337'>
	effc_fn(i,k) = &amp;<a name='3338'>
             gamma(pgam(k)+4._r8)/ &amp;<a name='3339'>
             gamma(pgam(k)+3._r8)/lamc(k)/2._r8*1.e6_r8<a name='3340'>
<a name='3341'>
        else<a name='3342'>
	effc_fn(i,k) = 10._r8<a name='3343'>
        end if<a name='3344'>
<a name='3345'>
<a name='3346'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!1!<a name='3347'></font>
<a name='3348'>
	end do <font color=#447700>! vertical k loop<a name='3349'></font>
<a name='3350'>
 500    continue<a name='3351'>
<a name='3352'>
	do k=1,pver<a name='3353'>
<font color=#447700>! if updated q (after microphysics) is zero, then ensure updated n is also zero<a name='3354'></font>
<a name='3355'>
        if (qc(i,k)+qctend(i,k)*deltat.lt.qsmall) nctend(i,k)=-nc(i,k)/deltat<a name='3356'>
        if (qi(i,k)+qitend(i,k)*deltat.lt.qsmall) nitend(i,k)=-ni(i,k)/deltat<a name='3357'>
	end do<a name='3358'>
<a name='3359'>
	end do <font color=#447700>! i loop<a name='3360'></font>
<a name='3361'>
<a name='3362'>
<font color=#447700>! hm add rain/snow mixing ratio and number concentration as diagnostic<a name='3363'></font>
<a name='3364'>
      call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_65">('QRAIN',qrout,   pcols, lchnk)<a name='3365'>
      call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_66">('QSNOW',qsout,   pcols, lchnk)<a name='3366'>
      call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_67">('NRAIN',nrout,   pcols, lchnk)<a name='3367'>
      call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_68">('NSNOW',nsout,   pcols, lchnk)<a name='3368'>
<a name='3369'>
<font color=#447700>! add snow ouptut<a name='3370'></font>
      do i = 1,ncol<a name='3371'>
         do k=1,pver<a name='3372'>
            if (qsout(i,k).gt.1.e-7_r8.and.nsout(i,k).gt.0._r8) then<a name='3373'>
               dsout(i,k)=3._r8*rhosn/917._r8*(pi * rhosn * nsout(i,k)/qsout(i,k))**(-1._r8/3._r8)<a name='3374'>
            endif<a name='3375'>
         end do<a name='3376'>
      end do<a name='3377'>
      call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_69">('DSNOW',dsout,   pcols, lchnk)<a name='3378'>
 <a name='3379'>
<font color=#447700>!calculate effective radius of rain and snow in microns for COSP using Eq. 9 of COSP v1.3 manual<a name='3380'></font>
      do i = 1,ncol<a name='3381'>
         do k=1,pver<a name='3382'>
	   <font color=#447700>!! RAIN<a name='3383'></font>
            if (qrout(i,k).gt.1.e-7_r8.and.nrout(i,k).gt.0._r8) then<a name='3384'>
		reff_rain(i,k)=1.5_r8*(pi * rhow * nrout(i,k)/qrout(i,k))**(-1._r8/3._r8)*1.e6_r8 <a name='3385'>
            endif<a name='3386'>
	    <font color=#447700>!! SNOW<a name='3387'></font>
            if (qsout(i,k).gt.1.e-7_r8.and.nsout(i,k).gt.0._r8) then<a name='3388'>
		reff_snow(i,k)=1.5_r8*(pi * rhosn * nsout(i,k)/qsout(i,k))**(-1._r8/3._r8)*1.e6_r8 <a name='3389'>
<a name='3390'>
            endif<a name='3391'>
         end do<a name='3392'>
      end do<a name='3393'>
<a name='3394'>
      <font color=#447700>! analytic radar reflectivity<a name='3395'></font>
      <font color=#447700>! formulas from Matthew Shupe, NOAA/CERES<a name='3396'></font>
      <font color=#447700>! *****note: radar reflectivity is local (in-precip average)<a name='3397'></font>
      <font color=#447700>! units of mm^6/m^3<a name='3398'></font>
 <a name='3399'>
      do i = 1,ncol<a name='3400'>
         do k=1,pver<a name='3401'>
            if (qc(i,k)+qctend(i,k)*deltat.ge.qsmall) then<a name='3402'>
               dum=((qc(i,k)+qctend(i,k)*deltat)/lcldm(i,k)*rho(i,k)*1000._r8)**2 &amp;<a name='3403'>
                  /(0.109_r8*(nc(i,k)+nctend(i,k)*deltat)/lcldm(i,k)*rho(i,k)/1.e6_r8)*lcldm(i,k)/cldmax(i,k)<a name='3404'>
            else<a name='3405'>
               dum=0._r8<a name='3406'>
            end if<a name='3407'>
            if (qi(i,k)+qitend(i,k)*deltat.ge.qsmall) then<a name='3408'>
               dum1=((qi(i,k)+qitend(i,k)*deltat)*rho(i,k)/icldm(i,k)*1000._r8/0.1_r8)**(1._r8/0.63_r8)*icldm(i,k)/cldmax(i,k)<a name='3409'>
            else <a name='3410'>
               dum1=0._r8<a name='3411'>
            end if<a name='3412'>
         <a name='3413'>
            if (qsout(i,k).ge.qsmall) then<a name='3414'>
               dum1=dum1+(qsout(i,k)*rho(i,k)*1000._r8/0.1_r8)**(1._r8/0.63_r8)<a name='3415'>
            end if<a name='3416'>
            <a name='3417'>
            refl(i,k)=dum+dum1<a name='3418'>
 <a name='3419'>
            <font color=#447700>! add rain rate, but for 37 GHz formulation instead of 94 GHz<a name='3420'></font>
            <font color=#447700>! formula approximated from data of Matrasov (2007)<a name='3421'></font>
            <font color=#447700>! rainrt is the rain rate in mm/hr<a name='3422'></font>
            <font color=#447700>! reflectivity (dum) is in DBz<a name='3423'></font>
 <a name='3424'>
            if (rainrt(i,k).ge.0.001) then<a name='3425'>
               dum=log10(rainrt(i,k)**6._r8)+16._r8<a name='3426'>
 <a name='3427'>
               <font color=#447700>! convert from DBz to mm^6/m^3<a name='3428'></font>
 <a name='3429'>
               dum = 10._r8**(dum/10._r8)<a name='3430'>
            else<a name='3431'>
               <font color=#447700>! don't include rain rate in R calculation for values less than 0.001 mm/hr<a name='3432'></font>
               dum=0.<a name='3433'>
            end if<a name='3434'>
 <a name='3435'>
            <font color=#447700>! add to refl<a name='3436'></font>
 <a name='3437'>
            refl(i,k)=refl(i,k)+dum<a name='3438'>
 <a name='3439'>
            <font color=#447700>!output reflectivity in Z.<a name='3440'></font>
            areflz(i,k)=refl(i,k)<a name='3441'>
 <a name='3442'>
            <font color=#447700>! convert back to DBz <a name='3443'></font>
 <a name='3444'>
            if (refl(i,k).gt.minrefl) then <a name='3445'>
               refl(i,k)=10._r8*log10(refl(i,k))<a name='3446'>
            else	<a name='3447'>
               refl(i,k)=-9999._r8<a name='3448'>
            end if<a name='3449'>
  <a name='3450'>
            <font color=#447700>!set averaging flag<a name='3451'></font>
            if (refl(i,k).gt.mindbz) then <a name='3452'>
               arefl(i,k)=refl(i,k)<a name='3453'>
               frefl(i,k)=1.0_r8  <a name='3454'>
            else<a name='3455'>
               arefl(i,k)=0._r8<a name='3456'>
               areflz(i,k)=0._r8<a name='3457'>
               frefl(i,k)=0._r8<a name='3458'>
            end if<a name='3459'>
 <a name='3460'>
            <font color=#447700>! bound cloudsat reflectivity<a name='3461'></font>
 <a name='3462'>
            csrfl(i,k)=min(csmax,refl(i,k))<a name='3463'>
 <a name='3464'>
            <font color=#447700>!set averaging flag<a name='3465'></font>
            if (csrfl(i,k).gt.csmin) then <a name='3466'>
               acsrfl(i,k)=refl(i,k)<a name='3467'>
               fcsrfl(i,k)=1.0_r8  <a name='3468'>
            else<a name='3469'>
               acsrfl(i,k)=0._r8<a name='3470'>
               fcsrfl(i,k)=0._r8<a name='3471'>
            end if<a name='3472'>
 <a name='3473'>
         end do<a name='3474'>
      end do<a name='3475'>
       <a name='3476'>
      call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_70">('REFL',refl,   pcols, lchnk)<a name='3477'>
      call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_71">('AREFL',arefl,   pcols, lchnk)<a name='3478'>
      call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_72">('AREFLZ',areflz,   pcols, lchnk)<a name='3479'>
      call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_73">('FREFL',frefl,   pcols, lchnk)<a name='3480'>
      call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_74">('CSRFL',csrfl,   pcols, lchnk)<a name='3481'>
      call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_75">('ACSRFL',acsrfl,   pcols, lchnk)<a name='3482'>
      call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_76">('FCSRFL',fcsrfl,   pcols, lchnk)<a name='3483'>
<a name='3484'>
      call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_77">('RERCLD',rercld,   pcols, lchnk)<a name='3485'>
<a name='3486'>
<font color=#447700>! averaging for snow and rain number and diameter<a name='3487'></font>
<a name='3488'>
  qrout2(:,:)=0._r8<a name='3489'>
  qsout2(:,:)=0._r8<a name='3490'>
  nrout2(:,:)=0._r8<a name='3491'>
  nsout2(:,:)=0._r8	<a name='3492'>
  drout2(:,:)=0._r8<a name='3493'>
  dsout2(:,:)=0._r8	<a name='3494'>
  freqs(:,:)=0._r8<a name='3495'>
  freqr(:,:)=0._r8<a name='3496'>
  do i = 1,ncol<a name='3497'>
     do k=1,pver<a name='3498'>
	if (qrout(i,k).gt.1.e-7_r8.and.nrout(i,k).gt.0._r8) then<a name='3499'>
 	   qrout2(i,k)=qrout(i,k)<a name='3500'>
	   nrout2(i,k)=nrout(i,k)<a name='3501'>
	   drout2(i,k)=(pi * rhow * nrout(i,k)/qrout(i,k))**(-1._r8/3._r8)<a name='3502'>
	   freqr(i,k)=1._r8<a name='3503'>
	endif<a name='3504'>
	if (qsout(i,k).gt.1.e-7_r8.and.nsout(i,k).gt.0._r8) then<a name='3505'>
 	   qsout2(i,k)=qsout(i,k)<a name='3506'>
	   nsout2(i,k)=nsout(i,k)<a name='3507'>
	   dsout2(i,k)=(pi * rhosn * nsout(i,k)/qsout(i,k))**(-1._r8/3._r8)<a name='3508'>
	   freqs(i,k)=1._r8<a name='3509'>
	endif<a name='3510'>
     end do<a name='3511'>
  end do<a name='3512'>
<a name='3513'>
<font color=#447700>! output activated liquid and ice (convert from #/kg -&gt; #/m3)<a name='3514'></font>
  do i = 1,ncol<a name='3515'>
     do k=1,pver<a name='3516'>
        ncai(i,k)=dum2i(i,k)*rho(i,k)<a name='3517'>
        ncal(i,k)=dum2l(i,k)*rho(i,k)<a name='3518'>
     end do<a name='3519'>
  end do<a name='3520'>
  call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_78">('NCAL',ncal,    pcols,lchnk)<a name='3521'>
  call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_79">('NCAI',ncai,    pcols,lchnk)<a name='3522'>
<a name='3523'>
<font color=#447700>!add averaged output fields.<a name='3524'></font>
  call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_80">('AQRAIN',qrout2,    pcols,lchnk)<a name='3525'>
  call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_81">('AQSNOW',qsout2,    pcols,lchnk)<a name='3526'>
  call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_82">('ANRAIN',nrout2,    pcols,lchnk)<a name='3527'>
  call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_83">('ANSNOW',nsout2,    pcols,lchnk)<a name='3528'>
  call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_84">('ADRAIN',drout2,    pcols,lchnk)<a name='3529'>
  call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_85">('ADSNOW',dsout2,    pcols,lchnk)<a name='3530'>
  call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_86">('FREQR',freqr,    pcols,lchnk)<a name='3531'>
  call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_87">('FREQS',freqs,    pcols,lchnk)<a name='3532'>
<a name='3533'>
<font color=#447700>!redefine fice here....<a name='3534'></font>
	nfice(:,:)=0._r8<a name='3535'>
	do k=1,pver<a name='3536'>
	   do i=1,ncol<a name='3537'>
        	dumc(i,k) = (qc(i,k)+qctend(i,k)*deltat)<a name='3538'>
        	dumi(i,k) = (qi(i,k)+qitend(i,k)*deltat)<a name='3539'>
		dumfice=qsout(i,k) + qrout(i,k) + dumc(i,k) + dumi(i,k)  <a name='3540'>
<a name='3541'>
                if (dumfice.gt.qsmall.and.(qsout(i,k)+dumi(i,k).gt.qsmall)) then<a name='3542'>
                  nfice(i,k)=(qsout(i,k) + dumi(i,k))/dumfice<a name='3543'>
                endif<a name='3544'>
<a name='3545'>
                if (nfice(i,k).gt.1._r8) then<a name='3546'>
                   nfice(i,k)=1._r8<a name='3547'>
                endif<a name='3548'>
<a name='3549'>
	   enddo<a name='3550'>
	enddo<a name='3551'>
<a name='3552'>
      call <A href='../../html_code/phys/module_cam_support.F.html#OUTFLD'>outfld</A><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTFLD_88">('FICE',nfice,   pcols, lchnk)<a name='3553'>
<a name='3554'>
return<a name='3555'>
end subroutine mmicro_pcond<a name='3556'>
<a name='3557'>
<font color=#447700>!<a name='3558'></font>
<font color=#447700>!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='3559'></font>
<a name='3560'>
<A NAME='GAMMA'><A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#GAMMA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3561'>
      <font color=#993300>FUNCTION </font><font color=#cc0000>GAMMA</font>(X) <A href='../../call_to/GAMMA.html' TARGET='index'>117</A><a name='3562'>
<a name='3563'>
<font color=#447700>!cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc<a name='3564'></font>
<a name='3565'>
<font color=#447700>!D    DOUBLE PRECISION FUNCTION DGAMMA(X)<a name='3566'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3567'></font>
<font color=#447700>!<a name='3568'></font>
<font color=#447700>! THIS ROUTINE CALCULATES THE GAMMA FUNCTION FOR A REAL ARGUMENT X.<a name='3569'></font>
<font color=#447700>!   COMPUTATION IS BASED ON AN ALGORITHM OUTLINED IN REFERENCE 1.<a name='3570'></font>
<font color=#447700>!   THE PROGRAM USES RATIONAL FUNCTIONS THAT APPROXIMATE THE GAMMA<a name='3571'></font>
<font color=#447700>!   FUNCTION TO AT LEAST 20 SIGNIFICANT DECIMAL DIGITS.  COEFFICIENTS<a name='3572'></font>
<font color=#447700>!   FOR THE APPROXIMATION OVER THE INTERVAL (1,2) ARE UNPUBLISHED.<a name='3573'></font>
<font color=#447700>!   THOSE FOR THE APPROXIMATION FOR X .GE. 12 ARE FROM REFERENCE 2.<a name='3574'></font>
<font color=#447700>!   THE ACCURACY ACHIEVED DEPENDS ON THE ARITHMETIC SYSTEM, THE<a name='3575'></font>
<font color=#447700>!   COMPILER, THE INTRINSIC FUNCTIONS, AND PROPER SELECTION OF THE<a name='3576'></font>
<font color=#447700>!   MACHINE-DEPENDENT CONSTANTS.<a name='3577'></font>
<font color=#447700>!<a name='3578'></font>
<font color=#447700>!<a name='3579'></font>
<font color=#447700>!*******************************************************************<a name='3580'></font>
<font color=#447700>!*******************************************************************<a name='3581'></font>
<font color=#447700>!<a name='3582'></font>
<font color=#447700>! EXPLANATION OF MACHINE-DEPENDENT CONSTANTS<a name='3583'></font>
<font color=#447700>!<a name='3584'></font>
<font color=#447700>! BETA   - RADIX FOR THE FLOATING-POINT REPRESENTATION<a name='3585'></font>
<font color=#447700>! MAXEXP - THE SMALLEST POSITIVE POWER OF BETA THAT OVERFLOWS<a name='3586'></font>
<font color=#447700>! XBIG   - THE LARGEST ARGUMENT FOR WHICH GAMMA(X) IS REPRESENTABLE<a name='3587'></font>
<font color=#447700>!          IN THE MACHINE, I.E., THE SOLUTION TO THE EQUATION<a name='3588'></font>
<font color=#447700>!                  GAMMA(XBIG) = BETA**MAXEXP<a name='3589'></font>
<font color=#447700>! XINF   - THE LARGEST MACHINE REPRESENTABLE FLOATING-POINT NUMBER;<a name='3590'></font>
<font color=#447700>!          APPROXIMATELY BETA**MAXEXP<a name='3591'></font>
<font color=#447700>! EPS    - THE SMALLEST POSITIVE FLOATING-POINT NUMBER SUCH THAT<a name='3592'></font>
<font color=#447700>!          1.0+EPS .GT. 1.0<a name='3593'></font>
<font color=#447700>! XMININ - THE SMALLEST POSITIVE FLOATING-POINT NUMBER SUCH THAT<a name='3594'></font>
<font color=#447700>!          1/XMININ IS MACHINE REPRESENTABLE<a name='3595'></font>
<font color=#447700>!<a name='3596'></font>
<font color=#447700>!     APPROXIMATE VALUES FOR SOME IMPORTANT MACHINES ARE:<a name='3597'></font>
<font color=#447700>!<a name='3598'></font>
<font color=#447700>!                            BETA       MAXEXP        XBIG<a name='3599'></font>
<font color=#447700>!<a name='3600'></font>
<font color=#447700>! CRAY-1         (S.P.)        2         8191        966.961<a name='3601'></font>
<font color=#447700>! CYBER 180/855<a name='3602'></font>
<font color=#447700>!   UNDER NOS    (S.P.)        2         1070        177.803<a name='3603'></font>
<font color=#447700>! IEEE (IBM/XT,<a name='3604'></font>
<font color=#447700>!   SUN, ETC.)   (S.P.)        2          128        35.040<a name='3605'></font>
<font color=#447700>! IEEE (IBM/XT,<a name='3606'></font>
<font color=#447700>!   SUN, ETC.)   (D.P.)        2         1024        171.624<a name='3607'></font>
<font color=#447700>! IBM 3033       (D.P.)       16           63        57.574<a name='3608'></font>
<font color=#447700>! VAX D-FORMAT   (D.P.)        2          127        34.844<a name='3609'></font>
<font color=#447700>! VAX G-FORMAT   (D.P.)        2         1023        171.489<a name='3610'></font>
<font color=#447700>!<a name='3611'></font>
<font color=#447700>!                            XINF         EPS        XMININ<a name='3612'></font>
<font color=#447700>!<a name='3613'></font>
<font color=#447700>! CRAY-1         (S.P.)   5.45E+2465   7.11E-15    1.84E-2466<a name='3614'></font>
<font color=#447700>! CYBER 180/855<a name='3615'></font>
<font color=#447700>!   UNDER NOS    (S.P.)   1.26E+322    3.55E-15    3.14E-294<a name='3616'></font>
<font color=#447700>! IEEE (IBM/XT,<a name='3617'></font>
<font color=#447700>!   SUN, ETC.)   (S.P.)   3.40E+38     1.19E-7     1.18E-38<a name='3618'></font>
<font color=#447700>! IEEE (IBM/XT,<a name='3619'></font>
<font color=#447700>!   SUN, ETC.)   (D.P.)   1.79D+308    2.22D-16    2.23D-308<a name='3620'></font>
<font color=#447700>! IBM 3033       (D.P.)   7.23D+75     2.22D-16    1.39D-76<a name='3621'></font>
<font color=#447700>! VAX D-FORMAT   (D.P.)   1.70D+38     1.39D-17    5.88D-39<a name='3622'></font>
<font color=#447700>! VAX G-FORMAT   (D.P.)   8.98D+307    1.11D-16    1.12D-308<a name='3623'></font>
<font color=#447700>!<a name='3624'></font>
<font color=#447700>!*******************************************************************<a name='3625'></font>
<font color=#447700>!*******************************************************************<a name='3626'></font>
<font color=#447700>!<a name='3627'></font>
<font color=#447700>! ERROR RETURNS<a name='3628'></font>
<font color=#447700>!<a name='3629'></font>
<font color=#447700>!  THE PROGRAM RETURNS THE VALUE XINF FOR SINGULARITIES OR<a name='3630'></font>
<font color=#447700>!     WHEN OVERFLOW WOULD OCCUR.  THE COMPUTATION IS BELIEVED<a name='3631'></font>
<font color=#447700>!     TO BE FREE OF UNDERFLOW AND OVERFLOW.<a name='3632'></font>
<font color=#447700>!<a name='3633'></font>
<font color=#447700>!<a name='3634'></font>
<font color=#447700>!  INTRINSIC FUNCTIONS REQUIRED ARE:<a name='3635'></font>
<font color=#447700>!<a name='3636'></font>
<font color=#447700>!     INT, DBLE, EXP, LOG, REAL, SIN<a name='3637'></font>
<font color=#447700>!<a name='3638'></font>
<font color=#447700>!<a name='3639'></font>
<font color=#447700>! REFERENCES:  AN OVERVIEW OF SOFTWARE DEVELOPMENT FOR SPECIAL<a name='3640'></font>
<font color=#447700>!              FUNCTIONS   W. J. CODY, LECTURE NOTES IN MATHEMATICS,<a name='3641'></font>
<font color=#447700>!              506, NUMERICAL ANALYSIS DUNDEE, 1975, G. A. WATSON<a name='3642'></font>
<font color=#447700>!              (ED.), SPRINGER VERLAG, BERLIN, 1976.<a name='3643'></font>
<font color=#447700>!<a name='3644'></font>
<font color=#447700>!              COMPUTER APPROXIMATIONS, HART, ET. AL., WILEY AND<a name='3645'></font>
<font color=#447700>!              SONS, NEW YORK, 1968.<a name='3646'></font>
<font color=#447700>!<a name='3647'></font>
<font color=#447700>!  LATEST MODIFICATION: OCTOBER 12, 1989<a name='3648'></font>
<font color=#447700>!<a name='3649'></font>
<font color=#447700>!  AUTHORS: W. J. CODY AND L. STOLTZ<a name='3650'></font>
<font color=#447700>!           APPLIED MATHEMATICS DIVISION<a name='3651'></font>
<font color=#447700>!           ARGONNE NATIONAL LABORATORY<a name='3652'></font>
<font color=#447700>!           ARGONNE, IL 60439<a name='3653'></font>
<font color=#447700>!<a name='3654'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3655'></font>
      INTEGER I,N<a name='3656'>
      LOGICAL PARITY<a name='3657'>
<a name='3658'>
      real(r8) gamma<a name='3659'>
      REAL(r8) &amp;<a name='3660'>
<font color=#447700>!D    DOUBLE PRECISION<a name='3661'></font>
         C,CONV,EPS,FACT,HALF,ONE,P,PI,Q,RES,SQRTPI,SUM,TWELVE, &amp;<a name='3662'>
         TWO,X,XBIG,XDEN,XINF,XMININ,XNUM,Y,Y1,YSQ,Z,ZERO<a name='3663'>
      DIMENSION C(7),P(8),Q(8)<a name='3664'>
<font color=#447700>!----------------------------------------------------------------------<a name='3665'></font>
<font color=#447700>!  MATHEMATICAL CONSTANTS<a name='3666'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3667'></font>
      DATA ONE,HALF,TWELVE,TWO,ZERO/1.0E0_r8,0.5E0_r8,12.0E0_r8,2.0E0_r8,0.0E0_r8/, &amp;<a name='3668'>
          SQRTPI/0.9189385332046727417803297E0_r8/, &amp;<a name='3669'>
          PI/3.1415926535897932384626434E0_r8/<a name='3670'>
<font color=#447700>!D    DATA ONE,HALF,TWELVE,TWO,ZERO/1.0D0,0.5D0,12.0D0,2.0D0,0.0D0/,<a name='3671'></font>
<font color=#447700>!D   1     SQRTPI/0.9189385332046727417803297D0/,<a name='3672'></font>
<font color=#447700>!D   2     PI/3.1415926535897932384626434D0/<a name='3673'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3674'></font>
<font color=#447700>!  MACHINE DEPENDENT PARAMETERS<a name='3675'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3676'></font>
      DATA XBIG,XMININ,EPS/35.040E0_r8,1.18E-38_r8,1.19E-7_r8/, &amp;<a name='3677'>
          XINF/3.4E38_r8/<a name='3678'>
<font color=#447700>!D    DATA XBIG,XMININ,EPS/171.624D0,2.23D-308,2.22D-16/,<a name='3679'></font>
<font color=#447700>!D   1     XINF/1.79D308/<a name='3680'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3681'></font>
<font color=#447700>!  NUMERATOR AND DENOMINATOR COEFFICIENTS FOR RATIONAL MINIMAX<a name='3682'></font>
<font color=#447700>!     APPROXIMATION OVER (1,2).<a name='3683'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3684'></font>
      DATA P/-1.71618513886549492533811E+0_r8,2.47656508055759199108314E+1_r8,&amp;<a name='3685'>
            -3.79804256470945635097577E+2_r8,6.29331155312818442661052E+2_r8,&amp;<a name='3686'>
            8.66966202790413211295064E+2_r8,-3.14512729688483675254357E+4_r8,&amp;<a name='3687'>
            -3.61444134186911729807069E+4_r8,6.64561438202405440627855E+4_r8/<a name='3688'>
      DATA Q/-3.08402300119738975254353E+1_r8,3.15350626979604161529144E+2_r8,&amp;<a name='3689'>
           -1.01515636749021914166146E+3_r8,-3.10777167157231109440444E+3_r8,&amp;<a name='3690'>
             2.25381184209801510330112E+4_r8,4.75584627752788110767815E+3_r8,&amp;<a name='3691'>
           -1.34659959864969306392456E+5_r8,-1.15132259675553483497211E+5_r8/<a name='3692'>
<font color=#447700>!D    DATA P/-1.71618513886549492533811D+0,2.47656508055759199108314D+1,<a name='3693'></font>
<font color=#447700>!D   1       -3.79804256470945635097577D+2,6.29331155312818442661052D+2,<a name='3694'></font>
<font color=#447700>!D   2       8.66966202790413211295064D+2,-3.14512729688483675254357D+4,<a name='3695'></font>
<font color=#447700>!D   3       -3.61444134186911729807069D+4,6.64561438202405440627855D+4/<a name='3696'></font>
<font color=#447700>!D    DATA Q/-3.08402300119738975254353D+1,3.15350626979604161529144D+2,<a name='3697'></font>
<font color=#447700>!D   1      -1.01515636749021914166146D+3,-3.10777167157231109440444D+3,<a name='3698'></font>
<font color=#447700>!D   2        2.25381184209801510330112D+4,4.75584627752788110767815D+3,<a name='3699'></font>
<font color=#447700>!D   3      -1.34659959864969306392456D+5,-1.15132259675553483497211D+5/<a name='3700'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3701'></font>
<font color=#447700>!  COEFFICIENTS FOR MINIMAX APPROXIMATION OVER (12, INF).<a name='3702'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3703'></font>
      DATA C/-1.910444077728E-03_r8,8.4171387781295E-04_r8, &amp;<a name='3704'>
          -5.952379913043012E-04_r8,7.93650793500350248E-04_r8,&amp;<a name='3705'>
          -2.777777777777681622553E-03_r8,8.333333333333333331554247E-02_r8,&amp;<a name='3706'>
           5.7083835261E-03_r8/<a name='3707'>
<font color=#447700>!D    DATA C/-1.910444077728D-03,8.4171387781295D-04,<a name='3708'></font>
<font color=#447700>!D   1     -5.952379913043012D-04,7.93650793500350248D-04,<a name='3709'></font>
<font color=#447700>!D   2     -2.777777777777681622553D-03,8.333333333333333331554247D-02,<a name='3710'></font>
<font color=#447700>!D   3      5.7083835261D-03/<a name='3711'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3712'></font>
<font color=#447700>!  STATEMENT FUNCTIONS FOR CONVERSION BETWEEN INTEGER AND FLOAT<a name='3713'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3714'></font>
      CONV(I) = REAL(I,r8)<a name='3715'>
<font color=#447700>!D    CONV(I) = DBLE(I)<a name='3716'></font>
      PARITY=.FALSE.<a name='3717'>
      FACT=ONE<a name='3718'>
      N=0<a name='3719'>
      Y=X<a name='3720'>
      IF(Y.LE.ZERO)THEN<a name='3721'>
<font color=#447700>!----------------------------------------------------------------------<a name='3722'></font>
<font color=#447700>!  ARGUMENT IS NEGATIVE<a name='3723'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3724'></font>
        Y=-X<a name='3725'>
        Y1=AINT(Y)<a name='3726'>
        RES=Y-Y1<a name='3727'>
        IF(RES.NE.ZERO)THEN<a name='3728'>
          IF(Y1.NE.AINT(Y1*HALF)*TWO)PARITY=.TRUE.<a name='3729'>
          FACT=-PI/SIN(PI*RES)<a name='3730'>
          Y=Y+ONE<a name='3731'>
        ELSE<a name='3732'>
          RES=XINF<a name='3733'>
          GOTO 900<a name='3734'>
        ENDIF<a name='3735'>
      ENDIF<a name='3736'>
<font color=#447700>!----------------------------------------------------------------------<a name='3737'></font>
<font color=#447700>!  ARGUMENT IS POSITIVE<a name='3738'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3739'></font>
      IF(Y.LT.EPS)THEN<a name='3740'>
<font color=#447700>!----------------------------------------------------------------------<a name='3741'></font>
<font color=#447700>!  ARGUMENT .LT. EPS<a name='3742'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3743'></font>
        IF(Y.GE.XMININ)THEN<a name='3744'>
          RES=ONE/Y<a name='3745'>
        ELSE<a name='3746'>
          RES=XINF<a name='3747'>
          GOTO 900<a name='3748'>
        ENDIF<a name='3749'>
      ELSEIF(Y.LT.TWELVE)THEN<a name='3750'>
        Y1=Y<a name='3751'>
        IF(Y.LT.ONE)THEN<a name='3752'>
<font color=#447700>!----------------------------------------------------------------------<a name='3753'></font>
<font color=#447700>!  0.0 .LT. ARGUMENT .LT. 1.0<a name='3754'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3755'></font>
          Z=Y<a name='3756'>
          Y=Y+ONE<a name='3757'>
        ELSE<a name='3758'>
<font color=#447700>!----------------------------------------------------------------------<a name='3759'></font>
<font color=#447700>!  1.0 .LT. ARGUMENT .LT. 12.0, REDUCE ARGUMENT IF NECESSARY<a name='3760'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3761'></font>
          N=INT(Y)-1<a name='3762'>
          Y=Y-CONV(N)<a name='3763'>
          Z=Y-ONE<a name='3764'>
        ENDIF<a name='3765'>
<font color=#447700>!----------------------------------------------------------------------<a name='3766'></font>
<font color=#447700>!  EVALUATE APPROXIMATION FOR 1.0 .LT. ARGUMENT .LT. 2.0<a name='3767'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3768'></font>
        XNUM=ZERO<a name='3769'>
        XDEN=ONE<a name='3770'>
        DO 260 I=1,8<a name='3771'>
          XNUM=(XNUM+P(I))*Z<a name='3772'>
          XDEN=XDEN*Z+Q(I)<a name='3773'>
  260   CONTINUE<a name='3774'>
        RES=XNUM/XDEN+ONE<a name='3775'>
        IF(Y1.LT.Y)THEN<a name='3776'>
<font color=#447700>!----------------------------------------------------------------------<a name='3777'></font>
<font color=#447700>!  ADJUST RESULT FOR CASE  0.0 .LT. ARGUMENT .LT. 1.0<a name='3778'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3779'></font>
          RES=RES/Y1<a name='3780'>
        ELSEIF(Y1.GT.Y)THEN<a name='3781'>
<font color=#447700>!----------------------------------------------------------------------<a name='3782'></font>
<font color=#447700>!  ADJUST RESULT FOR CASE  2.0 .LT. ARGUMENT .LT. 12.0<a name='3783'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3784'></font>
          DO 290 I=1,N<a name='3785'>
            RES=RES*Y<a name='3786'>
            Y=Y+ONE<a name='3787'>
  290     CONTINUE<a name='3788'>
        ENDIF<a name='3789'>
      ELSE<a name='3790'>
<font color=#447700>!----------------------------------------------------------------------<a name='3791'></font>
<font color=#447700>!  EVALUATE FOR ARGUMENT .GE. 12.0,<a name='3792'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3793'></font>
        IF(Y.LE.XBIG)THEN<a name='3794'>
          YSQ=Y*Y<a name='3795'>
          SUM=C(7)<a name='3796'>
          DO 350 I=1,6<a name='3797'>
            SUM=SUM/YSQ+C(I)<a name='3798'>
  350     CONTINUE<a name='3799'>
          SUM=SUM/Y-Y+SQRTPI<a name='3800'>
          SUM=SUM+(Y-HALF)*LOG(Y)<a name='3801'>
          RES=EXP(SUM)<a name='3802'>
        ELSE<a name='3803'>
          RES=XINF<a name='3804'>
          GOTO 900<a name='3805'>
        ENDIF<a name='3806'>
      ENDIF<a name='3807'>
<font color=#447700>!----------------------------------------------------------------------<a name='3808'></font>
<font color=#447700>!  FINAL ADJUSTMENTS AND RETURN<a name='3809'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3810'></font>
      IF(PARITY)RES=-RES<a name='3811'>
      IF(FACT.NE.ONE)RES=FACT/RES<a name='3812'>
  900 GAMMA=RES<a name='3813'>
<font color=#447700>!D900 DGAMMA = RES<a name='3814'></font>
      RETURN<a name='3815'>
<font color=#447700>! ---------- LAST LINE OF GAMMA ----------<a name='3816'></font>
      END function gamma<a name='3817'>
<a name='3818'>
<a name='3819'>
end module cldwat2m_micro<a name='3820'>
</pre></body></html>