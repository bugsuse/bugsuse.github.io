<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='NOAHMP_GLACIER_GLOBALS'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_GLACIER_GLOBALS' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>NOAHMP_GLACIER_GLOBALS</font> <A href='../../call_to/NOAHMP_GLACIER_GLOBALS.html' TARGET='index'>2</A><a name='3'>
<a name='4'>
  implicit none<a name='5'>
<a name='6'>
<font color=#447700>! ==================================================================================================<a name='7'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='8'></font>
<font color=#447700>! Physical Constants:                                                                      !<a name='9'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='10'></font>
<a name='11'>
  REAL, PARAMETER :: GRAV   = 9.80616   <font color=#447700>!acceleration due to gravity (m/s2)<a name='12'></font>
  REAL, PARAMETER :: SB     = 5.67E-08  <font color=#447700>!Stefan-Boltzmann constant (w/m2/k4)<a name='13'></font>
  REAL, PARAMETER :: VKC    = 0.40      <font color=#447700>!von Karman constant<a name='14'></font>
  REAL, PARAMETER :: TFRZ   = 273.16    <font color=#447700>!freezing/melting point (k)<a name='15'></font>
  REAL, PARAMETER :: HSUB   = 2.8440E06 <font color=#447700>!latent heat of sublimation (j/kg)<a name='16'></font>
  REAL, PARAMETER :: HVAP   = 2.5104E06 <font color=#447700>!latent heat of vaporization (j/kg)<a name='17'></font>
  REAL, PARAMETER :: HFUS   = 0.3336E06 <font color=#447700>!latent heat of fusion (j/kg)<a name='18'></font>
  REAL, PARAMETER :: CWAT   = 4.188E06  <font color=#447700>!specific heat capacity of water (j/m3/k)<a name='19'></font>
  REAL, PARAMETER :: CICE   = 2.094E06  <font color=#447700>!specific heat capacity of ice (j/m3/k)<a name='20'></font>
  REAL, PARAMETER :: CPAIR  = 1004.64   <font color=#447700>!heat capacity dry air at const pres (j/kg/k)<a name='21'></font>
  REAL, PARAMETER :: TKWAT  = 0.6       <font color=#447700>!thermal conductivity of water (w/m/k)<a name='22'></font>
  REAL, PARAMETER :: TKICE  = 2.2       <font color=#447700>!thermal conductivity of ice (w/m/k)<a name='23'></font>
  REAL, PARAMETER :: TKAIR  = 0.023     <font color=#447700>!thermal conductivity of air (w/m/k)<a name='24'></font>
  REAL, PARAMETER :: RAIR   = 287.04    <font color=#447700>!gas constant for dry air (j/kg/k)<a name='25'></font>
  REAL, PARAMETER :: RW     = 461.269   <font color=#447700>!gas constant for  water vapor (j/kg/k)<a name='26'></font>
  REAL, PARAMETER :: DENH2O = 1000.     <font color=#447700>!density of water (kg/m3)<a name='27'></font>
  REAL, PARAMETER :: DENICE = 917.      <font color=#447700>!density of ice (kg/m3)<a name='28'></font>
<a name='29'>
<font color=#447700>! =====================================options for different schemes================================<a name='30'></font>
<a name='31'>
<font color=#447700>! options for ground snow surface albedo<a name='32'></font>
<font color=#447700>! 1-&gt; BATS; 2 -&gt; CLASS<a name='33'></font>
<a name='34'>
  INTEGER :: OPT_ALB <font color=#447700>!= 2    !(suggested 2)<a name='35'></font>
<a name='36'>
<font color=#447700>! options for partitioning  precipitation into rainfall &amp; snowfall<a name='37'></font>
<font color=#447700>! 1 -&gt; Jordan (1991); 2 -&gt; BATS: when SFCTMP&lt;TFRZ+2.2 ; 3-&gt; SFCTMP&lt;TFRZ<a name='38'></font>
<a name='39'>
  INTEGER :: OPT_SNF <font color=#447700>!= 1    !(suggested 1)<a name='40'></font>
<a name='41'>
<font color=#447700>! options for lower boundary condition of soil temperature<a name='42'></font>
<font color=#447700>! 1 -&gt; zero heat flux from bottom (ZBOT and TBOT not used)<a name='43'></font>
<font color=#447700>! 2 -&gt; TBOT at ZBOT (8m) read from a file (original Noah)<a name='44'></font>
<a name='45'>
  INTEGER :: OPT_TBOT <font color=#447700>!= 2   !(suggested 2)<a name='46'></font>
<a name='47'>
<font color=#447700>! options for snow/soil temperature time scheme (only layer 1)<a name='48'></font>
<font color=#447700>! 1 -&gt; semi-implicit; 2 -&gt; full implicit (original Noah)<a name='49'></font>
<a name='50'>
  INTEGER :: OPT_STC <font color=#447700>!= 1    !(suggested 1)<a name='51'></font>
<a name='52'>
<font color=#447700>! options for glacier treatment<a name='53'></font>
<font color=#447700>! 1 -&gt; include phase change of ice; 2 -&gt; ice treatment more like original Noah<a name='54'></font>
<a name='55'>
  INTEGER :: OPT_GLA <font color=#447700>!= 1    !(suggested 1)<a name='56'></font>
<a name='57'>
<font color=#447700>! adjustable parameters for snow processes<a name='58'></font>
<a name='59'>
  REAL, PARAMETER :: Z0SNO  = 0.002  <font color=#447700>!snow surface roughness length (m) (0.002)<a name='60'></font>
  REAL, PARAMETER :: SSI    = 0.03   <font color=#447700>!liquid water holding capacity for snowpack (m3/m3) (0.03)<a name='61'></font>
  REAL, PARAMETER :: SWEMX  = 1.00   <font color=#447700>!new snow mass to fully cover old snow (mm)<a name='62'></font>
                                     <font color=#447700>!equivalent to 10mm depth (density = 100 kg/m3)<a name='63'></font>
<a name='64'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='65'></font>
END MODULE NOAHMP_GLACIER_GLOBALS<a name='66'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='67'></font>
<a name='68'>
<A NAME='NOAHMP_GLACIER_ROUTINES'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_GLACIER_ROUTINES' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='69'>
<font color=#993300>MODULE </font><font color=#cc0000>NOAHMP_GLACIER_ROUTINES</font> <A href='../../call_to/NOAHMP_GLACIER_ROUTINES.html' TARGET='index'>1</A>,<A href='../../call_from/NOAHMP_GLACIER_ROUTINES.html' TARGET='index'>1</A><a name='70'>
  USE <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_GLACIER_GLOBALS'>NOAHMP_GLACIER_GLOBALS</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_GLACIER_ROUTINES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOAHMP_GLACIER_GLOBALS_1"><a name='71'>
  IMPLICIT NONE<a name='72'>
<a name='73'>
  public  :: NOAHMP_OPTIONS_GLACIER<a name='74'>
  public  :: NOAHMP_GLACIER<a name='75'>
<a name='76'>
  private :: ATM_GLACIER<a name='77'>
  private :: ENERGY_GLACIER<a name='78'>
  private ::       THERMOPROP_GLACIER<a name='79'>
  private ::               CSNOW_GLACIER<a name='80'>
  private ::       RADIATION_GLACIER<a name='81'>
  private ::               SNOW_AGE_GLACIER<a name='82'>
  private ::               SNOWALB_BATS_GLACIER  <a name='83'>
  private ::               SNOWALB_CLASS_GLACIER<a name='84'>
  private ::       GLACIER_FLUX<a name='85'>
  private ::               SFCDIF1_GLACIER                  <a name='86'>
  private ::       TSNOSOI_GLACIER<a name='87'>
  private ::               HRT_GLACIER<a name='88'>
  private ::               HSTEP_GLACIER   <a name='89'>
  private ::                         ROSR12_GLACIER<a name='90'>
  private ::       PHASECHANGE_GLACIER<a name='91'>
<a name='92'>
  private :: WATER_GLACIER<a name='93'>
  private ::       SNOWWATER_GLACIER<a name='94'>
  private ::               SNOWFALL_GLACIER<a name='95'>
  private ::               COMBINE_GLACIER<a name='96'>
  private ::               DIVIDE_GLACIER<a name='97'>
  private ::                         COMBO_GLACIER<a name='98'>
  private ::               COMPACT_GLACIER<a name='99'>
  private ::               SNOWH2O_GLACIER<a name='100'>
<a name='101'>
  private :: ERROR_GLACIER<a name='102'>
<a name='103'>
contains<a name='104'>
<font color=#447700>!<a name='105'></font>
<font color=#447700>! ==================================================================================================<a name='106'></font>
<a name='107'>
<A NAME='NOAHMP_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='108'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>NOAHMP_GLACIER</font> (&amp; <A href='../../call_to/NOAHMP_GLACIER.html' TARGET='index'>1</A>,<A href='../../call_from/NOAHMP_GLACIER.html' TARGET='index'>5</A><a name='109'>
                   ILOC    ,JLOC    ,COSZ    ,NSNOW   ,NSOIL   ,DT      , &amp; <font color=#447700>! IN : Time/Space/Model-related<a name='110'></font>
                   SFCTMP  ,SFCPRS  ,UU      ,VV      ,Q2      ,SOLDN   , &amp; <font color=#447700>! IN : Forcing<a name='111'></font>
                   PRCP    ,LWDN    ,TBOT    ,ZLVL    ,FICEOLD ,ZSOIL   , &amp; <font color=#447700>! IN : Forcing<a name='112'></font>
                   QSNOW   ,SNEQVO  ,ALBOLD  ,CM      ,CH      ,ISNOW   , &amp; <font color=#447700>! IN/OUT : <a name='113'></font>
                   SNEQV   ,SMC     ,ZSNSO   ,SNOWH   ,SNICE   ,SNLIQ   , &amp; <font color=#447700>! IN/OUT :<a name='114'></font>
                   TG      ,STC     ,SH2O    ,TAUSS   ,QSFC    ,          &amp; <font color=#447700>! IN/OUT : <a name='115'></font>
                   FSA     ,FSR     ,FIRA    ,FSH     ,FGEV    ,SSOIL   , &amp; <font color=#447700>! OUT : <a name='116'></font>
                   TRAD    ,EDIR    ,RUNSRF  ,RUNSUB  ,SAG     ,ALBEDO  , &amp; <font color=#447700>! OUT :<a name='117'></font>
                   QSNBOT  ,PONDING ,PONDING1,PONDING2,T2M     ,Q2E     , &amp; <font color=#447700>! OUT :<a name='118'></font>
                   EMISSI,  FPICE,    CH2B                                &amp; <font color=#447700>! OUT :<a name='119'></font>
#ifdef WRF_HYDRO<a name='120'>
                   , sfcheadrt                                            &amp;<a name='121'>
#endif<a name='122'>
                   )<a name='123'>
<a name='124'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='125'></font>
<font color=#447700>! Initial code: Guo-Yue Niu, Oct. 2007<a name='126'></font>
<font color=#447700>! Modified to glacier: Michael Barlage, June 2012<a name='127'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='128'></font>
  implicit none<a name='129'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='130'></font>
<font color=#447700>! input<a name='131'></font>
  INTEGER                        , INTENT(IN)    :: ILOC   <font color=#447700>!grid index<a name='132'></font>
  INTEGER                        , INTENT(IN)    :: JLOC   <font color=#447700>!grid index<a name='133'></font>
  REAL                           , INTENT(IN)    :: COSZ   <font color=#447700>!cosine solar zenith angle [0-1]<a name='134'></font>
  INTEGER                        , INTENT(IN)    :: NSNOW  <font color=#447700>!maximum no. of snow layers        <a name='135'></font>
  INTEGER                        , INTENT(IN)    :: NSOIL  <font color=#447700>!no. of soil layers        <a name='136'></font>
  REAL                           , INTENT(IN)    :: DT     <font color=#447700>!time step [sec]<a name='137'></font>
  REAL                           , INTENT(IN)    :: SFCTMP <font color=#447700>!surface air temperature [K]<a name='138'></font>
  REAL                           , INTENT(IN)    :: SFCPRS <font color=#447700>!pressure (pa)<a name='139'></font>
  REAL                           , INTENT(IN)    :: UU     <font color=#447700>!wind speed in eastward dir (m/s)<a name='140'></font>
  REAL                           , INTENT(IN)    :: VV     <font color=#447700>!wind speed in northward dir (m/s)<a name='141'></font>
  REAL                           , INTENT(IN)    :: Q2     <font color=#447700>!mixing ratio (kg/kg) lowest model layer<a name='142'></font>
  REAL                           , INTENT(IN)    :: SOLDN  <font color=#447700>!downward shortwave radiation (w/m2)<a name='143'></font>
  REAL                           , INTENT(IN)    :: PRCP   <font color=#447700>!precipitation rate (kg m-2 s-1)<a name='144'></font>
  REAL                           , INTENT(IN)    :: LWDN   <font color=#447700>!downward longwave radiation (w/m2)<a name='145'></font>
  REAL                           , INTENT(IN)    :: TBOT   <font color=#447700>!bottom condition for soil temp. [K]<a name='146'></font>
  REAL                           , INTENT(IN)    :: ZLVL   <font color=#447700>!reference height (m)<a name='147'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(IN)    :: FICEOLD<font color=#447700>!ice fraction at last timestep<a name='148'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN)    :: ZSOIL  <font color=#447700>!layer-bottom depth from soil surf (m)<a name='149'></font>
<a name='150'>
#ifdef WRF_HYDRO<a name='151'>
  REAL                           , INTENT(INOUT)    :: sfcheadrt<a name='152'>
#endif<a name='153'>
<a name='154'>
<font color=#447700>! input/output : need arbitary intial values<a name='155'></font>
  REAL                           , INTENT(INOUT) :: QSNOW  <font color=#447700>!snowfall [mm/s]<a name='156'></font>
  REAL                           , INTENT(INOUT) :: SNEQVO <font color=#447700>!snow mass at last time step (mm)<a name='157'></font>
  REAL                           , INTENT(INOUT) :: ALBOLD <font color=#447700>!snow albedo at last time step (CLASS type)<a name='158'></font>
  REAL                           , INTENT(INOUT) :: CM     <font color=#447700>!momentum drag coefficient<a name='159'></font>
  REAL                           , INTENT(INOUT) :: CH     <font color=#447700>!sensible heat exchange coefficient<a name='160'></font>
<a name='161'>
<font color=#447700>! prognostic variables<a name='162'></font>
  INTEGER                        , INTENT(INOUT) :: ISNOW  <font color=#447700>!actual no. of snow layers [-]<a name='163'></font>
  REAL                           , INTENT(INOUT) :: SNEQV  <font color=#447700>!snow water eqv. [mm]<a name='164'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SMC    <font color=#447700>!soil moisture (ice + liq.) [m3/m3]<a name='165'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: ZSNSO  <font color=#447700>!layer-bottom depth from snow surf [m]<a name='166'></font>
  REAL                           , INTENT(INOUT) :: SNOWH  <font color=#447700>!snow height [m]<a name='167'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNICE  <font color=#447700>!snow layer ice [mm]<a name='168'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNLIQ  <font color=#447700>!snow layer liquid water [mm]<a name='169'></font>
  REAL                           , INTENT(INOUT) :: TG     <font color=#447700>!ground temperature (k)<a name='170'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC    <font color=#447700>!snow/soil temperature [k]<a name='171'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SH2O   <font color=#447700>!liquid soil moisture [m3/m3]<a name='172'></font>
  REAL                           , INTENT(INOUT) :: TAUSS  <font color=#447700>!non-dimensional snow age<a name='173'></font>
  REAL                           , INTENT(INOUT) :: QSFC   <font color=#447700>!mixing ratio at lowest model layer<a name='174'></font>
<a name='175'>
<font color=#447700>! output<a name='176'></font>
  REAL                           , INTENT(OUT)   :: FSA    <font color=#447700>!total absorbed solar radiation (w/m2)<a name='177'></font>
  REAL                           , INTENT(OUT)   :: FSR    <font color=#447700>!total reflected solar radiation (w/m2)<a name='178'></font>
  REAL                           , INTENT(OUT)   :: FIRA   <font color=#447700>!total net LW rad (w/m2)  [+ to atm]<a name='179'></font>
  REAL                           , INTENT(OUT)   :: FSH    <font color=#447700>!total sensible heat (w/m2) [+ to atm]<a name='180'></font>
  REAL                           , INTENT(OUT)   :: FGEV   <font color=#447700>!ground evap heat (w/m2) [+ to atm]<a name='181'></font>
  REAL                           , INTENT(OUT)   :: SSOIL  <font color=#447700>!ground heat flux (w/m2)   [+ to soil]<a name='182'></font>
  REAL                           , INTENT(OUT)   :: TRAD   <font color=#447700>!surface radiative temperature (k)<a name='183'></font>
  REAL                           , INTENT(OUT)   :: EDIR   <font color=#447700>!soil surface evaporation rate (mm/s]<a name='184'></font>
  REAL                           , INTENT(OUT)   :: RUNSRF <font color=#447700>!surface runoff [mm/s] <a name='185'></font>
  REAL                           , INTENT(OUT)   :: RUNSUB <font color=#447700>!baseflow (saturation excess) [mm/s]<a name='186'></font>
  REAL                           , INTENT(OUT)   :: SAG    <font color=#447700>!solar rad absorbed by ground (w/m2)<a name='187'></font>
  REAL                           , INTENT(OUT)   :: ALBEDO <font color=#447700>!surface albedo [-]<a name='188'></font>
  REAL                           , INTENT(OUT)   :: QSNBOT <font color=#447700>!snowmelt [mm/s]<a name='189'></font>
  REAL                           , INTENT(OUT)   :: PONDING<font color=#447700>!surface ponding [mm]<a name='190'></font>
  REAL                           , INTENT(OUT)   :: PONDING1<font color=#447700>!surface ponding [mm]<a name='191'></font>
  REAL                           , INTENT(OUT)   :: PONDING2<font color=#447700>!surface ponding [mm]<a name='192'></font>
  REAL                           , INTENT(OUT)   :: T2M     <font color=#447700>!2-m air temperature over bare ground part [k]<a name='193'></font>
  REAL                           , INTENT(OUT)   :: Q2E<a name='194'>
  REAL                           , INTENT(OUT)   :: EMISSI<a name='195'>
  REAL                           , INTENT(OUT)   :: FPICE<a name='196'>
  REAL                           , INTENT(OUT)   :: CH2B<a name='197'>
<a name='198'>
<font color=#447700>! local<a name='199'></font>
  INTEGER                                        :: IZ     <font color=#447700>!do-loop index<a name='200'></font>
  INTEGER, DIMENSION(-NSNOW+1:NSOIL)             :: IMELT  <font color=#447700>!phase change index [1-melt; 2-freeze]<a name='201'></font>
  REAL                                           :: RHOAIR <font color=#447700>!density air (kg/m3)<a name='202'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL)                :: DZSNSO <font color=#447700>!snow/soil layer thickness [m]<a name='203'></font>
  REAL                                           :: THAIR  <font color=#447700>!potential temperature (k)<a name='204'></font>
  REAL                                           :: QAIR   <font color=#447700>!specific humidity (kg/kg) (q2/(1+q2))<a name='205'></font>
  REAL                                           :: EAIR   <font color=#447700>!vapor pressure air (pa)<a name='206'></font>
  REAL, DIMENSION(       1:    2)                :: SOLAD  <font color=#447700>!incoming direct solar rad (w/m2)<a name='207'></font>
  REAL, DIMENSION(       1:    2)                :: SOLAI  <font color=#447700>!incoming diffuse solar rad (w/m2)<a name='208'></font>
  REAL, DIMENSION(       1:NSOIL)                :: SICE   <font color=#447700>!soil ice content (m3/m3)<a name='209'></font>
  REAL, DIMENSION(-NSNOW+1:    0)                :: SNICEV <font color=#447700>!partial volume ice of snow [m3/m3]<a name='210'></font>
  REAL, DIMENSION(-NSNOW+1:    0)                :: SNLIQV <font color=#447700>!partial volume liq of snow [m3/m3]<a name='211'></font>
  REAL, DIMENSION(-NSNOW+1:    0)                :: EPORE  <font color=#447700>!effective porosity [m3/m3]<a name='212'></font>
  REAL                                           :: QDEW   <font color=#447700>!ground surface dew rate [mm/s]<a name='213'></font>
  REAL                                           :: QVAP   <font color=#447700>!ground surface evap. rate [mm/s]<a name='214'></font>
  REAL                                           :: LATHEA <font color=#447700>!latent heat [j/kg]<a name='215'></font>
  REAL                                           :: QMELT  <font color=#447700>!internal pack melt<a name='216'></font>
  REAL                                           :: SWDOWN <font color=#447700>!downward solar [w/m2]<a name='217'></font>
  REAL                                           :: BEG_WB <font color=#447700>!beginning water for error check<a name='218'></font>
  REAL                                           :: ZBOT = -8.0 <a name='219'>
<a name='220'>
  CHARACTER*256 message<a name='221'>
<a name='222'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='223'></font>
<font color=#447700>! re-process atmospheric forcing<a name='224'></font>
<a name='225'>
   CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ATM_GLACIER'>ATM_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ATM_GLACIER_1"> (SFCPRS ,SFCTMP ,Q2     ,SOLDN  ,COSZ   ,THAIR  , &amp; <a name='226'>
                     QAIR   ,EAIR   ,RHOAIR ,SOLAD  ,SOLAI  ,SWDOWN )<a name='227'>
<a name='228'>
   BEG_WB = SNEQV<a name='229'>
<a name='230'>
<font color=#447700>! snow/soil layer thickness (m); interface depth: ZSNSO &lt; 0; layer thickness DZSNSO &gt; 0<a name='231'></font>
<a name='232'>
     DO IZ = ISNOW+1, NSOIL<a name='233'>
         IF(IZ == ISNOW+1) THEN<a name='234'>
           DZSNSO(IZ) = - ZSNSO(IZ)<a name='235'>
         ELSE<a name='236'>
           DZSNSO(IZ) = ZSNSO(IZ-1) - ZSNSO(IZ)<a name='237'>
         END IF<a name='238'>
     END DO<a name='239'>
<a name='240'>
<font color=#447700>! compute energy budget (momentum &amp; energy fluxes and phase changes) <a name='241'></font>
<a name='242'>
    CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ENERGY_GLACIER'>ENERGY_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENERGY_GLACIER_1"> (NSNOW  ,NSOIL  ,ISNOW  ,DT     ,QSNOW  ,RHOAIR , &amp; <font color=#447700>!in<a name='243'></font>
                         EAIR   ,SFCPRS ,QAIR   ,SFCTMP ,LWDN   ,UU     , &amp; <font color=#447700>!in<a name='244'></font>
                         VV     ,SOLAD  ,SOLAI  ,COSZ   ,ZLVL   ,         &amp; <font color=#447700>!in<a name='245'></font>
                         TBOT   ,ZBOT   ,ZSNSO  ,DZSNSO ,                 &amp; <font color=#447700>!in<a name='246'></font>
                         TG     ,STC    ,SNOWH  ,SNEQV  ,SNEQVO ,SH2O   , &amp; <font color=#447700>!inout<a name='247'></font>
                         SMC    ,SNICE  ,SNLIQ  ,ALBOLD ,CM     ,CH     , &amp; <font color=#447700>!inout<a name='248'></font>
                         TAUSS  ,QSFC   ,                                 &amp; <font color=#447700>!inout<a name='249'></font>
                         IMELT  ,SNICEV ,SNLIQV ,EPORE  ,QMELT  ,PONDING, &amp; <font color=#447700>!out<a name='250'></font>
		         SAG    ,FSA    ,FSR    ,FIRA   ,FSH    ,FGEV   , &amp; <font color=#447700>!out<a name='251'></font>
		         TRAD   ,T2M    ,SSOIL  ,LATHEA ,Q2E    ,EMISSI, CH2B )   <font color=#447700>!out<a name='252'></font>
<a name='253'>
    SICE = MAX(0.0, SMC - SH2O)   <a name='254'>
    SNEQVO  = SNEQV<a name='255'>
<a name='256'>
    QVAP = MAX( FGEV/LATHEA, 0.)       <font color=#447700>! positive part of fgev [mm/s] &gt; 0<a name='257'></font>
    QDEW = ABS( MIN(FGEV/LATHEA, 0.))  <font color=#447700>! negative part of fgev [mm/s] &gt; 0<a name='258'></font>
    EDIR = QVAP - QDEW<a name='259'>
<a name='260'>
<font color=#447700>! compute water budgets (water storages, ET components, and runoff)<a name='261'></font>
<a name='262'>
     CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#WATER_GLACIER'>WATER_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WATER_GLACIER_1"> (NSNOW  ,NSOIL  ,IMELT  ,DT     ,PRCP   ,SFCTMP , &amp; <font color=#447700>!in<a name='263'></font>
                         QVAP   ,QDEW   ,FICEOLD,ZSOIL  ,                 &amp; <font color=#447700>!in<a name='264'></font>
                         ISNOW  ,SNOWH  ,SNEQV  ,SNICE  ,SNLIQ  ,STC    , &amp; <font color=#447700>!inout<a name='265'></font>
                         DZSNSO ,SH2O   ,SICE   ,PONDING,ZSNSO  ,FSH    , &amp; <font color=#447700>!inout<a name='266'></font>
                         RUNSRF ,RUNSUB ,QSNOW  ,PONDING1       ,PONDING2,QSNBOT,FPICE &amp;  <font color=#447700>!out<a name='267'></font>
#ifdef WRF_HYDRO<a name='268'>
                        , sfcheadrt                     &amp;<a name='269'>
#endif<a name='270'>
                        )<a name='271'>
<a name='272'>
     IF(OPT_GLA == 2) THEN<a name='273'>
       EDIR = QVAP - QDEW<a name='274'>
       FGEV = EDIR * LATHEA<a name='275'>
     END IF<a name='276'>
<a name='277'>
     IF(MAXVAL(SICE) &lt; 0.0001) THEN<a name='278'>
       WRITE(message,*) "GLACIER HAS MELTED AT:",ILOC,JLOC," ARE YOU SURE THIS SHOULD BE A GLACIER POINT?"<a name='279'>
       CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_831">(10,TRIM(message))<a name='280'>
     END IF<a name='281'>
     <a name='282'>
<font color=#447700>! water and energy balance check<a name='283'></font>
<a name='284'>
     CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ERROR_GLACIER'>ERROR_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ERROR_GLACIER_1"> (ILOC   ,JLOC   ,SWDOWN ,FSA    ,FSR    ,FIRA   , &amp;<a name='285'>
                         FSH    ,FGEV   ,SSOIL  ,SAG    ,PRCP   ,EDIR   , &amp;<a name='286'>
		         RUNSRF ,RUNSUB ,SNEQV  ,DT     ,BEG_WB )<a name='287'>
<a name='288'>
    IF(SNOWH &lt;= 1.E-6 .OR. SNEQV &lt;= 1.E-3) THEN<a name='289'>
     SNOWH = 0.0<a name='290'>
     SNEQV = 0.0<a name='291'>
    END IF<a name='292'>
<a name='293'>
    IF(SWDOWN.NE.0.) THEN<a name='294'>
      ALBEDO = FSR / SWDOWN<a name='295'>
    ELSE<a name='296'>
      ALBEDO = -999.9<a name='297'>
    END IF<a name='298'>
    <a name='299'>
<a name='300'>
  END SUBROUTINE NOAHMP_GLACIER<a name='301'>
<font color=#447700>! ==================================================================================================<a name='302'></font>
<A NAME='ATM_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ATM_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='303'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ATM_GLACIER</font> (SFCPRS ,SFCTMP ,Q2     ,SOLDN  ,COSZ   ,THAIR  , &amp; <A href='../../call_to/ATM_GLACIER.html' TARGET='index'>1</A><a name='304'>
                          QAIR   ,EAIR   ,RHOAIR ,SOLAD  ,SOLAI  , &amp;<a name='305'>
                          SWDOWN )     <a name='306'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='307'></font>
<font color=#447700>! re-process atmospheric forcing<a name='308'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='309'></font>
  IMPLICIT NONE<a name='310'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='311'></font>
<font color=#447700>! inputs<a name='312'></font>
<a name='313'>
  REAL                          , INTENT(IN)  :: SFCPRS <font color=#447700>!pressure (pa)<a name='314'></font>
  REAL                          , INTENT(IN)  :: SFCTMP <font color=#447700>!surface air temperature [k]<a name='315'></font>
  REAL                          , INTENT(IN)  :: Q2     <font color=#447700>!mixing ratio (kg/kg)<a name='316'></font>
  REAL                          , INTENT(IN)  :: SOLDN  <font color=#447700>!downward shortwave radiation (w/m2)<a name='317'></font>
  REAL                          , INTENT(IN)  :: COSZ   <font color=#447700>!cosine solar zenith angle [0-1]<a name='318'></font>
<a name='319'>
<font color=#447700>! outputs<a name='320'></font>
<a name='321'>
  REAL                          , INTENT(OUT) :: THAIR  <font color=#447700>!potential temperature (k)<a name='322'></font>
  REAL                          , INTENT(OUT) :: QAIR   <font color=#447700>!specific humidity (kg/kg) (q2/(1+q2))<a name='323'></font>
  REAL                          , INTENT(OUT) :: EAIR   <font color=#447700>!vapor pressure air (pa)<a name='324'></font>
  REAL, DIMENSION(       1:   2), INTENT(OUT) :: SOLAD  <font color=#447700>!incoming direct solar radiation (w/m2)<a name='325'></font>
  REAL, DIMENSION(       1:   2), INTENT(OUT) :: SOLAI  <font color=#447700>!incoming diffuse solar radiation (w/m2)<a name='326'></font>
  REAL                          , INTENT(OUT) :: RHOAIR <font color=#447700>!density air (kg/m3)<a name='327'></font>
  REAL                          , INTENT(OUT) :: SWDOWN <font color=#447700>!downward solar filtered by sun angle [w/m2]<a name='328'></font>
<a name='329'>
<font color=#447700>!locals<a name='330'></font>
<a name='331'>
  REAL                                        :: PAIR   <font color=#447700>!atm bottom level pressure (pa)<a name='332'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='333'></font>
<a name='334'>
       PAIR   = SFCPRS                   <font color=#447700>! atm bottom level pressure (pa)<a name='335'></font>
       THAIR  = SFCTMP * (SFCPRS/PAIR)**(RAIR/CPAIR) <a name='336'>
<font color=#447700>!       QAIR   = Q2 / (1.0+Q2)           ! mixing ratio to specific humidity [kg/kg]<a name='337'></font>
       QAIR   = Q2                       <font color=#447700>! In WRF, driver converts to specific humidity<a name='338'></font>
<a name='339'>
       EAIR   = QAIR*SFCPRS / (0.622+0.378*QAIR)<a name='340'>
       RHOAIR = (SFCPRS-0.378*EAIR) / (RAIR*SFCTMP)<a name='341'>
<a name='342'>
       IF(COSZ &lt;= 0.) THEN <a name='343'>
          SWDOWN = 0.<a name='344'>
       ELSE<a name='345'>
          SWDOWN = SOLDN<a name='346'>
       END IF <a name='347'>
<a name='348'>
       SOLAD(1) = SWDOWN*0.7*0.5     <font color=#447700>! direct  vis<a name='349'></font>
       SOLAD(2) = SWDOWN*0.7*0.5     <font color=#447700>! direct  nir<a name='350'></font>
       SOLAI(1) = SWDOWN*0.3*0.5     <font color=#447700>! diffuse vis<a name='351'></font>
       SOLAI(2) = SWDOWN*0.3*0.5     <font color=#447700>! diffuse nir<a name='352'></font>
<a name='353'>
  END SUBROUTINE ATM_GLACIER<a name='354'>
<font color=#447700>! ==================================================================================================<a name='355'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='356'></font>
<A NAME='ENERGY_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ENERGY_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='357'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ENERGY_GLACIER</font> (NSNOW  ,NSOIL  ,ISNOW  ,DT     ,QSNOW  ,RHOAIR , &amp; <font color=#447700>!in <A href='../../call_to/ENERGY_GLACIER.html' TARGET='index'>1</A>,<A href='../../call_from/ENERGY_GLACIER.html' TARGET='index'>6</A><a name='358'></font>
                             EAIR   ,SFCPRS ,QAIR   ,SFCTMP ,LWDN   ,UU     , &amp; <font color=#447700>!in<a name='359'></font>
                             VV     ,SOLAD  ,SOLAI  ,COSZ   ,ZREF   ,         &amp; <font color=#447700>!in<a name='360'></font>
                             TBOT   ,ZBOT   ,ZSNSO  ,DZSNSO ,                 &amp; <font color=#447700>!in<a name='361'></font>
                             TG     ,STC    ,SNOWH  ,SNEQV  ,SNEQVO ,SH2O   , &amp; <font color=#447700>!inout<a name='362'></font>
                             SMC    ,SNICE  ,SNLIQ  ,ALBOLD ,CM     ,CH     , &amp; <font color=#447700>!inout<a name='363'></font>
                             TAUSS  ,QSFC   ,                                 &amp; <font color=#447700>!inout<a name='364'></font>
                             IMELT  ,SNICEV ,SNLIQV ,EPORE  ,QMELT  ,PONDING, &amp; <font color=#447700>!out<a name='365'></font>
                             SAG    ,FSA    ,FSR    ,FIRA   ,FSH    ,FGEV   , &amp; <font color=#447700>!out<a name='366'></font>
                             TRAD   ,T2M    ,SSOIL  ,LATHEA ,Q2E    ,EMISSI, CH2B )   <font color=#447700>!out<a name='367'></font>
<a name='368'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='369'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='370'></font>
<font color=#447700>!  USE NOAHMP_VEG_PARAMETERS<a name='371'></font>
<font color=#447700>!  USE NOAHMP_RAD_PARAMETERS<a name='372'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='373'></font>
  IMPLICIT NONE<a name='374'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='375'></font>
<font color=#447700>! inputs<a name='376'></font>
  INTEGER                           , INTENT(IN)    :: NSNOW  <font color=#447700>!maximum no. of snow layers        <a name='377'></font>
  INTEGER                           , INTENT(IN)    :: NSOIL  <font color=#447700>!number of soil layers<a name='378'></font>
  INTEGER                           , INTENT(IN)    :: ISNOW  <font color=#447700>!actual no. of snow layers<a name='379'></font>
  REAL                              , INTENT(IN)    :: DT     <font color=#447700>!time step [sec]<a name='380'></font>
  REAL                              , INTENT(IN)    :: QSNOW  <font color=#447700>!snowfall on the ground (mm/s)<a name='381'></font>
  REAL                              , INTENT(IN)    :: RHOAIR <font color=#447700>!density air (kg/m3)<a name='382'></font>
  REAL                              , INTENT(IN)    :: EAIR   <font color=#447700>!vapor pressure air (pa)<a name='383'></font>
  REAL                              , INTENT(IN)    :: SFCPRS <font color=#447700>!pressure (pa)<a name='384'></font>
  REAL                              , INTENT(IN)    :: QAIR   <font color=#447700>!specific humidity (kg/kg)<a name='385'></font>
  REAL                              , INTENT(IN)    :: SFCTMP <font color=#447700>!air temperature (k)<a name='386'></font>
  REAL                              , INTENT(IN)    :: LWDN   <font color=#447700>!downward longwave radiation (w/m2)<a name='387'></font>
  REAL                              , INTENT(IN)    :: UU     <font color=#447700>!wind speed in e-w dir (m/s)<a name='388'></font>
  REAL                              , INTENT(IN)    :: VV     <font color=#447700>!wind speed in n-s dir (m/s)<a name='389'></font>
  REAL   , DIMENSION(       1:    2), INTENT(IN)    :: SOLAD  <font color=#447700>!incoming direct solar rad. (w/m2)<a name='390'></font>
  REAL   , DIMENSION(       1:    2), INTENT(IN)    :: SOLAI  <font color=#447700>!incoming diffuse solar rad. (w/m2)<a name='391'></font>
  REAL                              , INTENT(IN)    :: COSZ   <font color=#447700>!cosine solar zenith angle (0-1)<a name='392'></font>
  REAL                              , INTENT(IN)    :: ZREF   <font color=#447700>!reference height (m)<a name='393'></font>
  REAL                              , INTENT(IN)    :: TBOT   <font color=#447700>!bottom condition for soil temp. (k) <a name='394'></font>
  REAL                              , INTENT(IN)    :: ZBOT   <font color=#447700>!depth for TBOT [m]<a name='395'></font>
  REAL   , DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)    :: ZSNSO  <font color=#447700>!layer-bottom depth from snow surf [m]<a name='396'></font>
  REAL   , DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)    :: DZSNSO <font color=#447700>!depth of snow &amp; soil layer-bottom [m]<a name='397'></font>
<a name='398'>
<font color=#447700>! input &amp; output<a name='399'></font>
  REAL                              , INTENT(INOUT) :: TG     <font color=#447700>!ground temperature (k)<a name='400'></font>
  REAL   , DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC    <font color=#447700>!snow/soil temperature [k]<a name='401'></font>
  REAL                              , INTENT(INOUT) :: SNOWH  <font color=#447700>!snow height [m]<a name='402'></font>
  REAL                              , INTENT(INOUT) :: SNEQV  <font color=#447700>!snow mass (mm)<a name='403'></font>
  REAL                              , INTENT(INOUT) :: SNEQVO <font color=#447700>!snow mass at last time step (mm)<a name='404'></font>
  REAL   , DIMENSION(       1:NSOIL), INTENT(INOUT) :: SH2O   <font color=#447700>!liquid soil moisture [m3/m3]<a name='405'></font>
  REAL   , DIMENSION(       1:NSOIL), INTENT(INOUT) :: SMC    <font color=#447700>!soil moisture (ice + liq.) [m3/m3]<a name='406'></font>
  REAL   , DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNICE  <font color=#447700>!snow ice mass (kg/m2)<a name='407'></font>
  REAL   , DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNLIQ  <font color=#447700>!snow liq mass (kg/m2)<a name='408'></font>
  REAL                              , INTENT(INOUT) :: ALBOLD <font color=#447700>!snow albedo at last time step(CLASS type)<a name='409'></font>
  REAL                              , INTENT(INOUT) :: CM     <font color=#447700>!momentum drag coefficient<a name='410'></font>
  REAL                              , INTENT(INOUT) :: CH     <font color=#447700>!sensible heat exchange coefficient<a name='411'></font>
  REAL                              , INTENT(INOUT) :: TAUSS  <font color=#447700>!snow aging factor<a name='412'></font>
  REAL                              , INTENT(INOUT) :: QSFC   <font color=#447700>!mixing ratio at lowest model layer<a name='413'></font>
<a name='414'>
<font color=#447700>! outputs<a name='415'></font>
  INTEGER, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT)   :: IMELT  <font color=#447700>!phase change index [1-melt; 2-freeze]<a name='416'></font>
  REAL   , DIMENSION(-NSNOW+1:    0), INTENT(OUT)   :: SNICEV <font color=#447700>!partial volume ice [m3/m3]<a name='417'></font>
  REAL   , DIMENSION(-NSNOW+1:    0), INTENT(OUT)   :: SNLIQV <font color=#447700>!partial volume liq. water [m3/m3]<a name='418'></font>
  REAL   , DIMENSION(-NSNOW+1:    0), INTENT(OUT)   :: EPORE  <font color=#447700>!effective porosity [m3/m3]<a name='419'></font>
  REAL                              , INTENT(OUT)   :: QMELT  <font color=#447700>!snowmelt [mm/s]<a name='420'></font>
  REAL                              , INTENT(OUT)   :: PONDING<font color=#447700>!pounding at ground [mm]<a name='421'></font>
  REAL                              , INTENT(OUT)   :: SAG    <font color=#447700>!solar rad. absorbed by ground (w/m2)<a name='422'></font>
  REAL                              , INTENT(OUT)   :: FSA    <font color=#447700>!tot. absorbed solar radiation (w/m2)<a name='423'></font>
  REAL                              , INTENT(OUT)   :: FSR    <font color=#447700>!tot. reflected solar radiation (w/m2)<a name='424'></font>
  REAL                              , INTENT(OUT)   :: FIRA   <font color=#447700>!total net LW. rad (w/m2)   [+ to atm]<a name='425'></font>
  REAL                              , INTENT(OUT)   :: FSH    <font color=#447700>!total sensible heat (w/m2) [+ to atm]<a name='426'></font>
  REAL                              , INTENT(OUT)   :: FGEV   <font color=#447700>!ground evaporation (w/m2)  [+ to atm]<a name='427'></font>
  REAL                              , INTENT(OUT)   :: TRAD   <font color=#447700>!radiative temperature (k)<a name='428'></font>
  REAL                              , INTENT(OUT)   :: T2M    <font color=#447700>!2 m height air temperature (k)<a name='429'></font>
  REAL                              , INTENT(OUT)   :: SSOIL  <font color=#447700>!ground heat flux (w/m2)   [+ to soil]<a name='430'></font>
  REAL                              , INTENT(OUT)   :: LATHEA <font color=#447700>!latent heat vap./sublimation (j/kg)<a name='431'></font>
  REAL                              , INTENT(OUT)   :: Q2E<a name='432'>
  REAL                              , INTENT(OUT)   :: EMISSI<a name='433'>
  REAL                              , INTENT(OUT)   :: CH2B   <font color=#447700>!sensible heat conductance, canopy air to ZLVL air (m/s)<a name='434'></font>
<a name='435'>
<a name='436'>
<font color=#447700>! local<a name='437'></font>
  REAL                                              :: UR     <font color=#447700>!wind speed at height ZLVL (m/s)<a name='438'></font>
  REAL                                              :: ZLVL   <font color=#447700>!reference height (m)<a name='439'></font>
  REAL                                              :: RSURF  <font color=#447700>!ground surface resistance (s/m)<a name='440'></font>
  REAL                                              :: ZPD    <font color=#447700>!zero plane displacement (m)<a name='441'></font>
  REAL                                              :: Z0MG   <font color=#447700>!z0 momentum, ground (m)<a name='442'></font>
  REAL                                              :: EMG    <font color=#447700>!ground emissivity<a name='443'></font>
  REAL                                              :: FIRE   <font color=#447700>!emitted IR (w/m2)<a name='444'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL)                   :: FACT   <font color=#447700>!temporary used in phase change<a name='445'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL)                   :: DF     <font color=#447700>!thermal conductivity [w/m/k]<a name='446'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL)                   :: HCPCT  <font color=#447700>!heat capacity [j/m3/k]<a name='447'></font>
  REAL                                              :: GAMMA  <font color=#447700>!psychrometric constant (pa/k)<a name='448'></font>
  REAL                                              :: RHSUR  <font color=#447700>!raltive humidity in surface soil/snow air space (-)<a name='449'></font>
<a name='450'>
<font color=#447700>! ---------------------------------------------------------------------------------------------------<a name='451'></font>
<a name='452'>
<font color=#447700>! wind speed at reference height: ur &gt;= 1<a name='453'></font>
<a name='454'>
    UR = MAX( SQRT(UU**2.+VV**2.), 1. )<a name='455'>
<a name='456'>
<font color=#447700>! roughness length and displacement height<a name='457'></font>
<a name='458'>
     Z0MG = Z0SNO<a name='459'>
     ZPD  = SNOWH<a name='460'>
<a name='461'>
     ZLVL = ZPD + ZREF<a name='462'>
<a name='463'>
<font color=#447700>! Thermal properties of soil, snow, lake, and frozen soil<a name='464'></font>
<a name='465'>
  CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#THERMOPROP_GLACIER'>THERMOPROP_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ENERGY_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THERMOPROP_GLACIER_1"> (NSOIL   ,NSNOW   ,ISNOW   ,DZSNSO  ,          &amp; <font color=#447700>!in<a name='466'></font>
                           DT      ,SNOWH   ,SNICE   ,SNLIQ   ,          &amp; <font color=#447700>!in<a name='467'></font>
                           DF      ,HCPCT   ,SNICEV  ,SNLIQV  ,EPORE   , &amp; <font color=#447700>!out<a name='468'></font>
                           FACT    )                                       <font color=#447700>!out<a name='469'></font>
<a name='470'>
<font color=#447700>! Solar radiation: absorbed &amp; reflected by the ground<a name='471'></font>
<a name='472'>
  CALL  <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#RADIATION_GLACIER'>RADIATION_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ENERGY_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADIATION_GLACIER_1"> (DT      ,TG      ,SNEQVO  ,SNEQV   ,COSZ    , &amp; <font color=#447700>!in<a name='473'></font>
                           QSNOW   ,SOLAD   ,SOLAI   ,                   &amp; <font color=#447700>!in<a name='474'></font>
                           ALBOLD  ,TAUSS   ,                            &amp; <font color=#447700>!inout<a name='475'></font>
                           SAG     ,FSR     ,FSA)                          <font color=#447700>!out<a name='476'></font>
<a name='477'>
<font color=#447700>! vegetation and ground emissivity<a name='478'></font>
<a name='479'>
     EMG = 0.98<a name='480'>
<a name='481'>
<font color=#447700>! soil surface resistance for ground evap.<a name='482'></font>
<a name='483'>
     RHSUR = 1.0<a name='484'>
     RSURF = 1.0<a name='485'>
<a name='486'>
<font color=#447700>! set psychrometric constant<a name='487'></font>
<a name='488'>
     LATHEA = HSUB<a name='489'>
     GAMMA = CPAIR*SFCPRS/(0.622*LATHEA)<a name='490'>
<a name='491'>
<font color=#447700>! Surface temperatures of the ground and energy fluxes<a name='492'></font>
<a name='493'>
    CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#GLACIER_FLUX'>GLACIER_FLUX</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ENERGY_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GLACIER_FLUX_1"> (NSOIL   ,NSNOW   ,EMG     ,ISNOW   ,DF      ,DZSNSO  ,Z0MG    , &amp; <font color=#447700>!in<a name='494'></font>
                       ZLVL    ,ZPD     ,QAIR    ,SFCTMP  ,RHOAIR  ,SFCPRS  , &amp; <font color=#447700>!in<a name='495'></font>
		       UR      ,GAMMA   ,RSURF   ,LWDN    ,RHSUR   ,SMC     , &amp; <font color=#447700>!in<a name='496'></font>
		       EAIR    ,STC     ,SAG     ,SNOWH   ,LATHEA  ,SH2O    , &amp; <font color=#447700>!in<a name='497'></font>
		       CM      ,CH      ,TG      ,QSFC    ,          &amp; <font color=#447700>!inout<a name='498'></font>
		       FIRA    ,FSH     ,FGEV    ,SSOIL   ,          &amp; <font color=#447700>!out<a name='499'></font>
		       T2M     ,Q2E     ,CH2B)                         <font color=#447700>!out <a name='500'></font>
<a name='501'>
<font color=#447700>!energy balance at surface: SAG=(IRB+SHB+EVB+GHB)<a name='502'></font>
<a name='503'>
    FIRE = LWDN + FIRA<a name='504'>
<a name='505'>
    IF(FIRE &lt;=0.) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ENERGY_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1177">("STOP in Noah-MP: emitted longwave &lt;0")<a name='506'>
<a name='507'>
    <font color=#447700>! Compute a net emissivity<a name='508'></font>
    EMISSI = EMG<a name='509'>
<a name='510'>
    <font color=#447700>! When we're computing a TRAD, subtract from the emitted IR the<a name='511'></font>
    <font color=#447700>! reflected portion of the incoming LWDN, so we're just<a name='512'></font>
    <font color=#447700>! considering the IR originating in the canopy/ground system.<a name='513'></font>
    <a name='514'>
    TRAD = ( ( FIRE - (1-EMISSI)*LWDN ) / (EMISSI*SB) ) ** 0.25<a name='515'>
<a name='516'>
<font color=#447700>! 3L snow &amp; 4L soil temperatures<a name='517'></font>
<a name='518'>
    CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#TSNOSOI_GLACIER'>TSNOSOI_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ENERGY_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TSNOSOI_GLACIER_1"> (NSOIL   ,NSNOW   ,ISNOW   ,DT      ,TBOT    , &amp; <font color=#447700>!in<a name='519'></font>
                          SSOIL   ,SNOWH   ,ZBOT    ,ZSNSO   ,DF      , &amp; <font color=#447700>!in<a name='520'></font>
		          HCPCT   ,                                     &amp; <font color=#447700>!in<a name='521'></font>
                          STC     )                                       <font color=#447700>!inout<a name='522'></font>
<a name='523'>
<font color=#447700>! adjusting snow surface temperature<a name='524'></font>
     IF(OPT_STC == 2) THEN<a name='525'>
      IF (SNOWH &gt; 0.05 .AND. TG &gt; TFRZ) TG = TFRZ<a name='526'>
     END IF<a name='527'>
<a name='528'>
<font color=#447700>! Energy released or consumed by snow &amp; ice<a name='529'></font>
<a name='530'>
 CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#PHASECHANGE_GLACIER'>PHASECHANGE_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ENERGY_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHASECHANGE_GLACIER_1"> (NSNOW   ,NSOIL   ,ISNOW   ,DT      ,FACT    , &amp; <font color=#447700>!in<a name='531'></font>
                           DZSNSO  ,                                     &amp; <font color=#447700>!in<a name='532'></font>
                           STC     ,SNICE   ,SNLIQ   ,SNEQV   ,SNOWH   , &amp; <font color=#447700>!inout<a name='533'></font>
                           SMC     ,SH2O    ,                            &amp; <font color=#447700>!inout<a name='534'></font>
                           QMELT   ,IMELT   ,PONDING )                     <font color=#447700>!out<a name='535'></font>
<a name='536'>
<a name='537'>
  END SUBROUTINE ENERGY_GLACIER<a name='538'>
<font color=#447700>! ==================================================================================================<a name='539'></font>
<A NAME='THERMOPROP_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#THERMOPROP_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='540'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>THERMOPROP_GLACIER</font> (NSOIL   ,NSNOW   ,ISNOW   ,DZSNSO  , &amp; <font color=#447700>!in <A href='../../call_to/THERMOPROP_GLACIER.html' TARGET='index'>1</A>,<A href='../../call_from/THERMOPROP_GLACIER.html' TARGET='index'>1</A><a name='541'></font>
                                 DT      ,SNOWH   ,SNICE   ,SNLIQ   , &amp; <font color=#447700>!in<a name='542'></font>
                                 DF      ,HCPCT   ,SNICEV  ,SNLIQV  ,EPORE   , &amp; <font color=#447700>!out<a name='543'></font>
                                 FACT    )                                       <font color=#447700>!out<a name='544'></font>
<font color=#447700>! ------------------------------------------------------------------------------------------------- <a name='545'></font>
<font color=#447700>! -------------------------------------------------------------------------------------------------<a name='546'></font>
  IMPLICIT NONE<a name='547'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='548'></font>
<font color=#447700>! inputs<a name='549'></font>
  INTEGER                        , INTENT(IN)  :: NSOIL   <font color=#447700>!number of soil layers<a name='550'></font>
  INTEGER                        , INTENT(IN)  :: NSNOW   <font color=#447700>!maximum no. of snow layers        <a name='551'></font>
  INTEGER                        , INTENT(IN)  :: ISNOW   <font color=#447700>!actual no. of snow layers<a name='552'></font>
  REAL                           , INTENT(IN)  :: DT      <font color=#447700>!time step [s]<a name='553'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(IN)  :: SNICE   <font color=#447700>!snow ice mass (kg/m2)<a name='554'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(IN)  :: SNLIQ   <font color=#447700>!snow liq mass (kg/m2)<a name='555'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: DZSNSO  <font color=#447700>!thickness of snow/soil layers [m]<a name='556'></font>
  REAL                           , INTENT(IN)  :: SNOWH   <font color=#447700>!snow height [m]<a name='557'></font>
<a name='558'>
<font color=#447700>! outputs<a name='559'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: DF      <font color=#447700>!thermal conductivity [w/m/k]<a name='560'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: HCPCT   <font color=#447700>!heat capacity [j/m3/k]<a name='561'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: SNICEV  <font color=#447700>!partial volume of ice [m3/m3]<a name='562'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: SNLIQV  <font color=#447700>!partial volume of liquid water [m3/m3]<a name='563'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: EPORE   <font color=#447700>!effective porosity [m3/m3]<a name='564'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: FACT    <font color=#447700>!computing energy for phase change<a name='565'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='566'></font>
<font color=#447700>! locals<a name='567'></font>
<a name='568'>
  INTEGER :: IZ, IZ2<a name='569'>
  REAL, DIMENSION(-NSNOW+1:    0)              :: CVSNO   <font color=#447700>!volumetric specific heat (j/m3/k)<a name='570'></font>
  REAL, DIMENSION(-NSNOW+1:    0)              :: TKSNO   <font color=#447700>!snow thermal conductivity (j/m3/k)<a name='571'></font>
  REAL                                         :: ZMID    <font color=#447700>!mid-point soil depth<a name='572'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='573'></font>
<a name='574'>
<font color=#447700>! compute snow thermal conductivity and heat capacity<a name='575'></font>
<a name='576'>
    CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#CSNOW_GLACIER'>CSNOW_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#THERMOPROP_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CSNOW_GLACIER_1"> (ISNOW   ,NSNOW   ,NSOIL   ,SNICE   ,SNLIQ   ,DZSNSO  , &amp; <font color=#447700>!in<a name='577'></font>
                        TKSNO   ,CVSNO   ,SNICEV  ,SNLIQV  ,EPORE   )   <font color=#447700>!out<a name='578'></font>
<a name='579'>
    DO IZ = ISNOW+1, 0<a name='580'>
      DF   (IZ) = TKSNO(IZ)<a name='581'>
      HCPCT(IZ) = CVSNO(IZ)<a name='582'>
    END DO<a name='583'>
<a name='584'>
<font color=#447700>! compute soil thermal properties (using Noah glacial ice approximations)<a name='585'></font>
<a name='586'>
    DO  IZ = 1, NSOIL<a name='587'>
       ZMID      = 0.5 * (DZSNSO(IZ))<a name='588'>
       DO IZ2 = 1, IZ-1<a name='589'>
         ZMID = ZMID + DZSNSO(IZ2)<a name='590'>
       END DO<a name='591'>
       HCPCT(IZ) = 1.E6 * ( 0.8194 + 0.1309*ZMID )<a name='592'>
       DF(IZ)    = 0.32333 + ( 0.10073 * ZMID )<a name='593'>
    END DO<a name='594'>
       <a name='595'>
<font color=#447700>! combine a temporary variable used for melting/freezing of snow and frozen soil<a name='596'></font>
<a name='597'>
    DO IZ = ISNOW+1,NSOIL<a name='598'>
     FACT(IZ) = DT/(HCPCT(IZ)*DZSNSO(IZ))<a name='599'>
    END DO<a name='600'>
<a name='601'>
<font color=#447700>! snow/soil interface<a name='602'></font>
<a name='603'>
    IF(ISNOW == 0) THEN<a name='604'>
       DF(1) = (DF(1)*DZSNSO(1)+0.35*SNOWH)      / (SNOWH    +DZSNSO(1)) <a name='605'>
    ELSE<a name='606'>
       DF(1) = (DF(1)*DZSNSO(1)+DF(0)*DZSNSO(0)) / (DZSNSO(0)+DZSNSO(1))<a name='607'>
    END IF<a name='608'>
<a name='609'>
<a name='610'>
  END SUBROUTINE THERMOPROP_GLACIER<a name='611'>
<font color=#447700>! ==================================================================================================<a name='612'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='613'></font>
<A NAME='CSNOW_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#CSNOW_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='614'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>CSNOW_GLACIER</font> (ISNOW   ,NSNOW   ,NSOIL   ,SNICE   ,SNLIQ   ,DZSNSO  , &amp; <font color=#447700>!in <A href='../../call_to/CSNOW_GLACIER.html' TARGET='index'>1</A><a name='615'></font>
                            TKSNO   ,CVSNO   ,SNICEV  ,SNLIQV  ,EPORE   )   <font color=#447700>!out<a name='616'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='617'></font>
<font color=#447700>! Snow bulk density,volumetric capacity, and thermal conductivity<a name='618'></font>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='619'></font>
  IMPLICIT NONE<a name='620'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='621'></font>
<font color=#447700>! inputs<a name='622'></font>
<a name='623'>
  INTEGER,                          INTENT(IN) :: ISNOW  <font color=#447700>!number of snow layers (-)            <a name='624'></font>
  INTEGER                        ,  INTENT(IN) :: NSNOW  <font color=#447700>!maximum no. of snow layers        <a name='625'></font>
  INTEGER                        ,  INTENT(IN) :: NSOIL  <font color=#447700>!number of soil layers<a name='626'></font>
  REAL, DIMENSION(-NSNOW+1:    0),  INTENT(IN) :: SNICE  <font color=#447700>!snow ice mass (kg/m2)<a name='627'></font>
  REAL, DIMENSION(-NSNOW+1:    0),  INTENT(IN) :: SNLIQ  <font color=#447700>!snow liq mass (kg/m2) <a name='628'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL),  INTENT(IN) :: DZSNSO <font color=#447700>!snow/soil layer thickness [m]<a name='629'></font>
<a name='630'>
<font color=#447700>! outputs<a name='631'></font>
<a name='632'>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: CVSNO  <font color=#447700>!volumetric specific heat (j/m3/k)<a name='633'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: TKSNO  <font color=#447700>!thermal conductivity (w/m/k)<a name='634'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: SNICEV <font color=#447700>!partial volume of ice [m3/m3]<a name='635'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: SNLIQV <font color=#447700>!partial volume of liquid water [m3/m3]<a name='636'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: EPORE  <font color=#447700>!effective porosity [m3/m3]<a name='637'></font>
<a name='638'>
<font color=#447700>! locals<a name='639'></font>
<a name='640'>
  INTEGER :: IZ<a name='641'>
  REAL, DIMENSION(-NSNOW+1:    0) :: BDSNOI  <font color=#447700>!bulk density of snow(kg/m3)<a name='642'></font>
<a name='643'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='644'></font>
<font color=#447700>! thermal capacity of snow<a name='645'></font>
<a name='646'>
  DO IZ = ISNOW+1, 0<a name='647'>
      SNICEV(IZ)   = MIN(1., SNICE(IZ)/(DZSNSO(IZ)*DENICE) )<a name='648'>
      EPORE(IZ)    = 1. - SNICEV(IZ)<a name='649'>
      SNLIQV(IZ)   = MIN(EPORE(IZ),SNLIQ(IZ)/(DZSNSO(IZ)*DENH2O))<a name='650'>
  ENDDO<a name='651'>
<a name='652'>
  DO IZ = ISNOW+1, 0<a name='653'>
      BDSNOI(IZ) = (SNICE(IZ)+SNLIQ(IZ))/DZSNSO(IZ)<a name='654'>
      CVSNO(IZ) = CICE*SNICEV(IZ)+CWAT*SNLIQV(IZ)<a name='655'>
<font color=#447700>!      CVSNO(IZ) = 0.525E06                          ! constant<a name='656'></font>
  enddo<a name='657'>
<a name='658'>
<font color=#447700>! thermal conductivity of snow<a name='659'></font>
<a name='660'>
  DO IZ = ISNOW+1, 0<a name='661'>
     TKSNO(IZ) = 3.2217E-6*BDSNOI(IZ)**2.           <font color=#447700>! Stieglitz(yen,1965)<a name='662'></font>
<font color=#447700>!    TKSNO(IZ) = 2E-2+2.5E-6*BDSNOI(IZ)*BDSNOI(IZ)   ! Anderson, 1976<a name='663'></font>
<font color=#447700>!    TKSNO(IZ) = 0.35                                ! constant<a name='664'></font>
<font color=#447700>!    TKSNO(IZ) = 2.576E-6*BDSNOI(IZ)**2. + 0.074    ! Verseghy (1991)<a name='665'></font>
<font color=#447700>!    TKSNO(IZ) = 2.22*(BDSNOI(IZ)/1000.)**1.88      ! Douvill(Yen, 1981)<a name='666'></font>
  ENDDO<a name='667'>
<a name='668'>
  END SUBROUTINE CSNOW_GLACIER<a name='669'>
<font color=#447700>!===================================================================================================<a name='670'></font>
<A NAME='RADIATION_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#RADIATION_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='671'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>RADIATION_GLACIER</font> (DT      ,TG      ,SNEQVO  ,SNEQV   ,COSZ    , &amp; <font color=#447700>!in <A href='../../call_to/RADIATION_GLACIER.html' TARGET='index'>1</A>,<A href='../../call_from/RADIATION_GLACIER.html' TARGET='index'>3</A><a name='672'></font>
                                QSNOW   ,SOLAD   ,SOLAI   ,                   &amp; <font color=#447700>!in<a name='673'></font>
                                ALBOLD  ,TAUSS   ,                            &amp; <font color=#447700>!inout<a name='674'></font>
                                SAG     ,FSR     ,FSA)                          <font color=#447700>!out<a name='675'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='676'></font>
  IMPLICIT NONE<a name='677'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='678'></font>
<font color=#447700>! input<a name='679'></font>
  REAL, INTENT(IN)                     :: DT     <font color=#447700>!time step [s]<a name='680'></font>
  REAL, INTENT(IN)                     :: TG     <font color=#447700>!ground temperature (k)<a name='681'></font>
  REAL, INTENT(IN)                     :: SNEQVO <font color=#447700>!snow mass at last time step(mm)<a name='682'></font>
  REAL, INTENT(IN)                     :: SNEQV  <font color=#447700>!snow mass (mm)<a name='683'></font>
  REAL, INTENT(IN)                     :: COSZ   <font color=#447700>!cosine solar zenith angle (0-1)<a name='684'></font>
  REAL, INTENT(IN)                     :: QSNOW  <font color=#447700>!snowfall (mm/s)<a name='685'></font>
  REAL, DIMENSION(1:2)    , INTENT(IN) :: SOLAD  <font color=#447700>!incoming direct solar radiation (w/m2)<a name='686'></font>
  REAL, DIMENSION(1:2)    , INTENT(IN) :: SOLAI  <font color=#447700>!incoming diffuse solar radiation (w/m2)<a name='687'></font>
<a name='688'>
<font color=#447700>! inout<a name='689'></font>
  REAL,                  INTENT(INOUT) :: ALBOLD <font color=#447700>!snow albedo at last time step (CLASS type)<a name='690'></font>
  REAL,                  INTENT(INOUT) :: TAUSS  <font color=#447700>!non-dimensional snow age<a name='691'></font>
<a name='692'>
<font color=#447700>! output<a name='693'></font>
  REAL, INTENT(OUT)                    :: SAG    <font color=#447700>!solar radiation absorbed by ground (w/m2)<a name='694'></font>
  REAL, INTENT(OUT)                    :: FSR    <font color=#447700>!total reflected solar radiation (w/m2)<a name='695'></font>
  REAL, INTENT(OUT)                    :: FSA    <font color=#447700>!total absorbed solar radiation (w/m2)<a name='696'></font>
<a name='697'>
<font color=#447700>! local<a name='698'></font>
  INTEGER                              :: IB     <font color=#447700>!number of radiation bands<a name='699'></font>
  INTEGER                              :: NBAND  <font color=#447700>!number of radiation bands<a name='700'></font>
  REAL                                 :: FAGE   <font color=#447700>!snow age function (0 - new snow)<a name='701'></font>
  REAL, DIMENSION(1:2)                 :: ALBSND <font color=#447700>!snow albedo (direct)<a name='702'></font>
  REAL, DIMENSION(1:2)                 :: ALBSNI <font color=#447700>!snow albedo (diffuse)<a name='703'></font>
  REAL                                 :: ALB    <font color=#447700>!current CLASS albedo<a name='704'></font>
  REAL                                 :: ABS    <font color=#447700>!temporary absorbed rad<a name='705'></font>
  REAL                                 :: REF    <font color=#447700>!temporary reflected rad<a name='706'></font>
  REAL                                 :: FSNO   <font color=#447700>!snow-cover fraction, = 1 if any snow<a name='707'></font>
  REAL, DIMENSION(1:2)                 :: ALBICE <font color=#447700>!albedo land ice: 1=vis, 2=nir<a name='708'></font>
<a name='709'>
  REAL,PARAMETER :: MPE = 1.E-6<a name='710'>
<a name='711'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='712'></font>
<a name='713'>
  NBAND = 2<a name='714'>
  ALBSND = 0.0<a name='715'>
  ALBSNI = 0.0<a name='716'>
  ALBICE(1) = 0.80    <font color=#447700>!albedo land ice: 1=vis, 2=nir<a name='717'></font>
  ALBICE(2) = 0.55<a name='718'>
<a name='719'>
<font color=#447700>! snow age<a name='720'></font>
<a name='721'>
  CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOW_AGE_GLACIER'>SNOW_AGE_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#RADIATION_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOW_AGE_GLACIER_1"> (DT,TG,SNEQVO,SNEQV,TAUSS,FAGE)<a name='722'>
<a name='723'>
<font color=#447700>! snow albedos: age even when sun is not present<a name='724'></font>
<a name='725'>
  IF(OPT_ALB == 1) &amp;<a name='726'>
     CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWALB_BATS_GLACIER'>SNOWALB_BATS_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#RADIATION_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWALB_BATS_GLACIER_1"> (NBAND,COSZ,FAGE,ALBSND,ALBSNI)<a name='727'>
  IF(OPT_ALB == 2) THEN<a name='728'>
     CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWALB_CLASS_GLACIER'>SNOWALB_CLASS_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#RADIATION_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWALB_CLASS_GLACIER_1">(NBAND,QSNOW,DT,ALB,ALBOLD,ALBSND,ALBSNI)<a name='729'>
     ALBOLD = ALB<a name='730'>
  END IF<a name='731'>
<a name='732'>
<font color=#447700>! zero summed solar fluxes<a name='733'></font>
<a name='734'>
   SAG = 0.<a name='735'>
   FSA = 0.<a name='736'>
   FSR = 0.<a name='737'>
   <a name='738'>
   FSNO = 0.0<a name='739'>
   IF(SNEQV &gt; 0.0) FSNO = 1.0<a name='740'>
<a name='741'>
<font color=#447700>! loop over nband wavebands<a name='742'></font>
<a name='743'>
  DO IB = 1, NBAND<a name='744'>
<a name='745'>
    ALBSND(IB) = ALBICE(IB)*(1.-FSNO) + ALBSND(IB)*FSNO<a name='746'>
    ALBSNI(IB) = ALBICE(IB)*(1.-FSNO) + ALBSNI(IB)*FSNO<a name='747'>
<a name='748'>
<font color=#447700>! solar radiation absorbed by ground surface<a name='749'></font>
<a name='750'>
    ABS = SOLAD(IB)*(1.-ALBSND(IB)) + SOLAI(IB)*(1.-ALBSNI(IB))<a name='751'>
    SAG = SAG + ABS<a name='752'>
    FSA = FSA + ABS<a name='753'>
    <a name='754'>
    REF = SOLAD(IB)*ALBSND(IB) + SOLAI(IB)*ALBSNI(IB)<a name='755'>
    FSR = FSR + REF<a name='756'>
    <a name='757'>
  END DO<a name='758'>
<a name='759'>
  END SUBROUTINE RADIATION_GLACIER<a name='760'>
<font color=#447700>! ==================================================================================================<a name='761'></font>
<A NAME='SNOW_AGE_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOW_AGE_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='762'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOW_AGE_GLACIER</font> (DT,TG,SNEQVO,SNEQV,TAUSS,FAGE) <A href='../../call_to/SNOW_AGE_GLACIER.html' TARGET='index'>1</A><a name='763'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='764'></font>
  IMPLICIT NONE<a name='765'>
<font color=#447700>! ------------------------ code history ------------------------------------------------------------<a name='766'></font>
<font color=#447700>! from BATS<a name='767'></font>
<font color=#447700>! ------------------------ input/output variables --------------------------------------------------<a name='768'></font>
<font color=#447700>!input<a name='769'></font>
   REAL, INTENT(IN) :: DT        <font color=#447700>!main time step (s)<a name='770'></font>
   REAL, INTENT(IN) :: TG        <font color=#447700>!ground temperature (k)<a name='771'></font>
   REAL, INTENT(IN) :: SNEQVO    <font color=#447700>!snow mass at last time step(mm)<a name='772'></font>
   REAL, INTENT(IN) :: SNEQV     <font color=#447700>!snow water per unit ground area (mm)<a name='773'></font>
<a name='774'>
<font color=#447700>! inout<a name='775'></font>
  REAL,  INTENT(INOUT) :: TAUSS  <font color=#447700>!non-dimensional snow age<a name='776'></font>
<a name='777'>
<font color=#447700>!output<a name='778'></font>
   REAL, INTENT(OUT) :: FAGE     <font color=#447700>!snow age<a name='779'></font>
<a name='780'>
<font color=#447700>!local<a name='781'></font>
   REAL            :: TAGE       <font color=#447700>!total aging effects<a name='782'></font>
   REAL            :: AGE1       <font color=#447700>!effects of grain growth due to vapor diffusion<a name='783'></font>
   REAL            :: AGE2       <font color=#447700>!effects of grain growth at freezing of melt water<a name='784'></font>
   REAL            :: AGE3       <font color=#447700>!effects of soot<a name='785'></font>
   REAL            :: DELA       <font color=#447700>!temporary variable<a name='786'></font>
   REAL            :: SGE        <font color=#447700>!temporary variable<a name='787'></font>
   REAL            :: DELS       <font color=#447700>!temporary variable<a name='788'></font>
   REAL            :: DELA0      <font color=#447700>!temporary variable<a name='789'></font>
   REAL            :: ARG        <font color=#447700>!temporary variable<a name='790'></font>
<font color=#447700>! See Yang et al. (1997) J.of Climate for detail.<a name='791'></font>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='792'></font>
<a name='793'>
   IF(SNEQV.LE.0.0) THEN<a name='794'>
          TAUSS = 0.<a name='795'>
   ELSE IF (SNEQV.GT.800.) THEN<a name='796'>
          TAUSS = 0.<a name='797'>
   ELSE<a name='798'>
<font color=#447700>!          TAUSS = 0.<a name='799'></font>
          DELA0 = 1.E-6*DT<a name='800'>
          ARG   = 5.E3*(1./TFRZ-1./TG)<a name='801'>
          AGE1  = EXP(ARG)<a name='802'>
          AGE2  = EXP(AMIN1(0.,10.*ARG))<a name='803'>
          AGE3  = 0.3<a name='804'>
          TAGE  = AGE1+AGE2+AGE3<a name='805'>
          DELA  = DELA0*TAGE<a name='806'>
          DELS  = AMAX1(0.0,SNEQV-SNEQVO) / SWEMX<a name='807'>
          SGE   = (TAUSS+DELA)*(1.0-DELS)<a name='808'>
          TAUSS = AMAX1(0.,SGE)<a name='809'>
   ENDIF<a name='810'>
<a name='811'>
   FAGE= TAUSS/(TAUSS+1.)<a name='812'>
<a name='813'>
  END SUBROUTINE SNOW_AGE_GLACIER<a name='814'>
<font color=#447700>! ==================================================================================================<a name='815'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='816'></font>
<A NAME='SNOWALB_BATS_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWALB_BATS_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='817'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWALB_BATS_GLACIER</font> (NBAND,COSZ,FAGE,ALBSND,ALBSNI) <A href='../../call_to/SNOWALB_BATS_GLACIER.html' TARGET='index'>1</A><a name='818'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='819'></font>
  IMPLICIT NONE<a name='820'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='821'></font>
<font color=#447700>! input<a name='822'></font>
<a name='823'>
  INTEGER,INTENT(IN) :: NBAND  <font color=#447700>!number of waveband classes<a name='824'></font>
<a name='825'>
  REAL,INTENT(IN) :: COSZ    <font color=#447700>!cosine solar zenith angle<a name='826'></font>
  REAL,INTENT(IN) :: FAGE    <font color=#447700>!snow age correction<a name='827'></font>
<a name='828'>
<font color=#447700>! output<a name='829'></font>
<a name='830'>
  REAL, DIMENSION(1:2),INTENT(OUT) :: ALBSND <font color=#447700>!snow albedo for direct(1=vis, 2=nir)<a name='831'></font>
  REAL, DIMENSION(1:2),INTENT(OUT) :: ALBSNI <font color=#447700>!snow albedo for diffuse<a name='832'></font>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='833'></font>
<a name='834'>
  REAL :: FZEN                 <font color=#447700>!zenith angle correction<a name='835'></font>
  REAL :: CF1                  <font color=#447700>!temperary variable<a name='836'></font>
  REAL :: SL2                  <font color=#447700>!2.*SL<a name='837'></font>
  REAL :: SL1                  <font color=#447700>!1/SL<a name='838'></font>
  REAL :: SL                   <font color=#447700>!adjustable parameter<a name='839'></font>
  REAL, PARAMETER :: C1 = 0.2  <font color=#447700>!default in BATS <a name='840'></font>
  REAL, PARAMETER :: C2 = 0.5  <font color=#447700>!default in BATS<a name='841'></font>
<font color=#447700>!  REAL, PARAMETER :: C1 = 0.2 * 2. ! double the default to match Sleepers River's<a name='842'></font>
<font color=#447700>!  REAL, PARAMETER :: C2 = 0.5 * 2. ! snow surface albedo (double aging effects)<a name='843'></font>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='844'></font>
<font color=#447700>! zero albedos for all points<a name='845'></font>
<a name='846'>
        ALBSND(1: NBAND) = 0.<a name='847'>
        ALBSNI(1: NBAND) = 0.<a name='848'>
<a name='849'>
<font color=#447700>! when cosz &gt; 0<a name='850'></font>
<a name='851'>
        SL=2.0<a name='852'>
        SL1=1./SL<a name='853'>
        SL2=2.*SL<a name='854'>
        CF1=((1.+SL1)/(1.+SL2*COSZ)-SL1)<a name='855'>
        FZEN=AMAX1(CF1,0.)<a name='856'>
<a name='857'>
        ALBSNI(1)=0.95*(1.-C1*FAGE)         <a name='858'>
        ALBSNI(2)=0.65*(1.-C2*FAGE)        <a name='859'>
<a name='860'>
        ALBSND(1)=ALBSNI(1)+0.4*FZEN*(1.-ALBSNI(1))    <font color=#447700>!  vis direct<a name='861'></font>
        ALBSND(2)=ALBSNI(2)+0.4*FZEN*(1.-ALBSNI(2))    <font color=#447700>!  nir direct<a name='862'></font>
<a name='863'>
  END SUBROUTINE SNOWALB_BATS_GLACIER<a name='864'>
<font color=#447700>! ==================================================================================================<a name='865'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='866'></font>
<A NAME='SNOWALB_CLASS_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWALB_CLASS_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='867'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWALB_CLASS_GLACIER</font> (NBAND,QSNOW,DT,ALB,ALBOLD,ALBSND,ALBSNI) <A href='../../call_to/SNOWALB_CLASS_GLACIER.html' TARGET='index'>1</A><a name='868'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='869'></font>
  IMPLICIT NONE<a name='870'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='871'></font>
<font color=#447700>! input<a name='872'></font>
<a name='873'>
  INTEGER,INTENT(IN) :: NBAND  <font color=#447700>!number of waveband classes<a name='874'></font>
<a name='875'>
  REAL,INTENT(IN) :: QSNOW     <font color=#447700>!snowfall (mm/s)<a name='876'></font>
  REAL,INTENT(IN) :: DT        <font color=#447700>!time step (sec)<a name='877'></font>
  REAL,INTENT(IN) :: ALBOLD    <font color=#447700>!snow albedo at last time step<a name='878'></font>
<a name='879'>
<font color=#447700>! in &amp; out<a name='880'></font>
<a name='881'>
  REAL,                INTENT(INOUT) :: ALB        <font color=#447700>! <a name='882'></font>
<font color=#447700>! output<a name='883'></font>
<a name='884'>
  REAL, DIMENSION(1:2),INTENT(OUT) :: ALBSND <font color=#447700>!snow albedo for direct(1=vis, 2=nir)<a name='885'></font>
  REAL, DIMENSION(1:2),INTENT(OUT) :: ALBSNI <font color=#447700>!snow albedo for diffuse<a name='886'></font>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='887'></font>
<a name='888'>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='889'></font>
<font color=#447700>! zero albedos for all points<a name='890'></font>
<a name='891'>
        ALBSND(1: NBAND) = 0.<a name='892'>
        ALBSNI(1: NBAND) = 0.<a name='893'>
<a name='894'>
<font color=#447700>! when cosz &gt; 0<a name='895'></font>
<a name='896'>
         ALB = 0.55 + (ALBOLD-0.55) * EXP(-0.01*DT/3600.)<a name='897'>
<a name='898'>
<font color=#447700>! 1 mm fresh snow(SWE) -- 10mm snow depth, assumed the fresh snow density 100kg/m3<a name='899'></font>
<font color=#447700>! here assume 1cm snow depth will fully cover the old snow<a name='900'></font>
<a name='901'>
         IF (QSNOW &gt; 0.) then<a name='902'>
           ALB = ALB + MIN(QSNOW*DT,SWEMX) * (0.84-ALB)/(SWEMX)<a name='903'>
         ENDIF<a name='904'>
<a name='905'>
         ALBSNI(1)= ALB         <font color=#447700>! vis diffuse<a name='906'></font>
         ALBSNI(2)= ALB         <font color=#447700>! nir diffuse<a name='907'></font>
         ALBSND(1)= ALB         <font color=#447700>! vis direct<a name='908'></font>
         ALBSND(2)= ALB         <font color=#447700>! nir direct<a name='909'></font>
<a name='910'>
  END SUBROUTINE SNOWALB_CLASS_GLACIER<a name='911'>
<font color=#447700>! ==================================================================================================<a name='912'></font>
<A NAME='GLACIER_FLUX'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#GLACIER_FLUX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='913'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>GLACIER_FLUX</font> (NSOIL   ,NSNOW   ,EMG     ,ISNOW   ,DF      ,DZSNSO  ,Z0M     , &amp; <font color=#447700>!in <A href='../../call_to/GLACIER_FLUX.html' TARGET='index'>1</A>,<A href='../../call_from/GLACIER_FLUX.html' TARGET='index'>4</A><a name='914'></font>
                           ZLVL    ,ZPD     ,QAIR    ,SFCTMP  ,RHOAIR  ,SFCPRS  , &amp; <font color=#447700>!in<a name='915'></font>
			   UR      ,GAMMA   ,RSURF   ,LWDN    ,RHSUR   ,SMC     , &amp; <font color=#447700>!in<a name='916'></font>
			   EAIR    ,STC     ,SAG     ,SNOWH   ,LATHEA  ,SH2O    , &amp; <font color=#447700>!in<a name='917'></font>
                           CM      ,CH      ,TGB     ,QSFC    ,          &amp; <font color=#447700>!inout<a name='918'></font>
                           IRB     ,SHB     ,EVB     ,GHB     ,          &amp; <font color=#447700>!out<a name='919'></font>
                           T2MB    ,Q2B     ,EHB2)                         <font color=#447700>!out <a name='920'></font>
<a name='921'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='922'></font>
<font color=#447700>! use newton-raphson iteration to solve ground (tg) temperature<a name='923'></font>
<font color=#447700>! that balances the surface energy budgets for glacier.<a name='924'></font>
<a name='925'>
<font color=#447700>! bare soil:<a name='926'></font>
<font color=#447700>! -SAB + IRB[TG] + SHB[TG] + EVB[TG] + GHB[TG] = 0<a name='927'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='928'></font>
<font color=#447700>!  USE MODULE_MODEL_CONSTANTS<a name='929'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='930'></font>
  IMPLICIT NONE<a name='931'>
<font color=#447700>! ----------------------------------------------------------------------<a name='932'></font>
<font color=#447700>! input<a name='933'></font>
  INTEGER, INTENT(IN)                         :: NSNOW  <font color=#447700>!maximum no. of snow layers        <a name='934'></font>
  INTEGER, INTENT(IN)                         :: NSOIL  <font color=#447700>!number of soil layers<a name='935'></font>
  REAL,                            INTENT(IN) :: EMG    <font color=#447700>!ground emissivity<a name='936'></font>
  INTEGER,                         INTENT(IN) :: ISNOW  <font color=#447700>!actual no. of snow layers<a name='937'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: DF     <font color=#447700>!thermal conductivity of snow/soil (w/m/k)<a name='938'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: DZSNSO <font color=#447700>!thickness of snow/soil layers (m)<a name='939'></font>
  REAL,                            INTENT(IN) :: Z0M    <font color=#447700>!roughness length, momentum, ground (m)<a name='940'></font>
  REAL,                            INTENT(IN) :: ZLVL   <font color=#447700>!reference height (m)<a name='941'></font>
  REAL,                            INTENT(IN) :: ZPD    <font color=#447700>!zero plane displacement (m)<a name='942'></font>
  REAL,                            INTENT(IN) :: QAIR   <font color=#447700>!specific humidity at height zlvl (kg/kg)<a name='943'></font>
  REAL,                            INTENT(IN) :: SFCTMP <font color=#447700>!air temperature at reference height (k)<a name='944'></font>
  REAL,                            INTENT(IN) :: RHOAIR <font color=#447700>!density air (kg/m3)<a name='945'></font>
  REAL,                            INTENT(IN) :: SFCPRS <font color=#447700>!density air (kg/m3)<a name='946'></font>
  REAL,                            INTENT(IN) :: UR     <font color=#447700>!wind speed at height zlvl (m/s)<a name='947'></font>
  REAL,                            INTENT(IN) :: GAMMA  <font color=#447700>!psychrometric constant (pa/k)<a name='948'></font>
  REAL,                            INTENT(IN) :: RSURF  <font color=#447700>!ground surface resistance (s/m)<a name='949'></font>
  REAL,                            INTENT(IN) :: LWDN   <font color=#447700>!atmospheric longwave radiation (w/m2)<a name='950'></font>
  REAL,                            INTENT(IN) :: RHSUR  <font color=#447700>!raltive humidity in surface soil/snow air space (-)<a name='951'></font>
  REAL,                            INTENT(IN) :: EAIR   <font color=#447700>!vapor pressure air at height (pa)<a name='952'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: STC    <font color=#447700>!soil/snow temperature (k)<a name='953'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN) :: SMC    <font color=#447700>!soil moisture<a name='954'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN) :: SH2O   <font color=#447700>!soil liquid water<a name='955'></font>
  REAL,                            INTENT(IN) :: SAG    <font color=#447700>!solar radiation absorbed by ground (w/m2)<a name='956'></font>
  REAL,                            INTENT(IN) :: SNOWH  <font color=#447700>!actual snow depth [m]<a name='957'></font>
  REAL,                            INTENT(IN) :: LATHEA <font color=#447700>!latent heat of vaporization/subli (j/kg)<a name='958'></font>
<a name='959'>
<font color=#447700>! input/output<a name='960'></font>
  REAL,                         INTENT(INOUT) :: CM     <font color=#447700>!momentum drag coefficient<a name='961'></font>
  REAL,                         INTENT(INOUT) :: CH     <font color=#447700>!sensible heat exchange coefficient<a name='962'></font>
  REAL,                         INTENT(INOUT) :: TGB    <font color=#447700>!ground temperature (k)<a name='963'></font>
  REAL,                         INTENT(INOUT) :: QSFC   <font color=#447700>!mixing ratio at lowest model layer<a name='964'></font>
<a name='965'>
<font color=#447700>! output<a name='966'></font>
<font color=#447700>! -SAB + IRB[TG] + SHB[TG] + EVB[TG] + GHB[TG] = 0<a name='967'></font>
  REAL,                           INTENT(OUT) :: IRB    <font color=#447700>!net longwave rad (w/m2)   [+ to atm]<a name='968'></font>
  REAL,                           INTENT(OUT) :: SHB    <font color=#447700>!sensible heat flux (w/m2) [+ to atm]<a name='969'></font>
  REAL,                           INTENT(OUT) :: EVB    <font color=#447700>!latent heat flux (w/m2)   [+ to atm]<a name='970'></font>
  REAL,                           INTENT(OUT) :: GHB    <font color=#447700>!ground heat flux (w/m2)  [+ to soil]<a name='971'></font>
  REAL,                           INTENT(OUT) :: T2MB   <font color=#447700>!2 m height air temperature (k)<a name='972'></font>
  REAL,                           INTENT(OUT) :: Q2B    <font color=#447700>!bare ground heat conductance<a name='973'></font>
  REAL,                           INTENT(OUT) :: EHB2   <font color=#447700>!sensible heat conductance for diagnostics<a name='974'></font>
<a name='975'>
<a name='976'>
<font color=#447700>! local variables <a name='977'></font>
  INTEGER :: NITERB  <font color=#447700>!number of iterations for surface temperature<a name='978'></font>
  REAL    :: MPE     <font color=#447700>!prevents overflow error if division by zero<a name='979'></font>
  REAL    :: DTG        <font color=#447700>!change in tg, last iteration (k)<a name='980'></font>
  INTEGER :: MOZSGN  <font color=#447700>!number of times MOZ changes sign<a name='981'></font>
  REAL    :: MOZOLD     <font color=#447700>!Monin-Obukhov stability parameter from prior iteration<a name='982'></font>
  REAL    :: FM2          <font color=#447700>!Monin-Obukhov momentum adjustment at 2m<a name='983'></font>
  REAL    :: FH2          <font color=#447700>!Monin-Obukhov heat adjustment at 2m<a name='984'></font>
  REAL    :: CH2          <font color=#447700>!Surface exchange at 2m<a name='985'></font>
  REAL    :: H          <font color=#447700>!temporary sensible heat flux (w/m2)<a name='986'></font>
  REAL    :: FV         <font color=#447700>!friction velocity (m/s)<a name='987'></font>
  REAL    :: CIR        <font color=#447700>!coefficients for ir as function of ts**4<a name='988'></font>
  REAL    :: CGH        <font color=#447700>!coefficients for st as function of ts<a name='989'></font>
  REAL    :: CSH        <font color=#447700>!coefficients for sh as function of ts<a name='990'></font>
  REAL    :: CEV        <font color=#447700>!coefficients for ev as function of esat[ts]<a name='991'></font>
  REAL    :: CQ2B       <font color=#447700>!<a name='992'></font>
  INTEGER :: ITER    <font color=#447700>!iteration index<a name='993'></font>
  REAL    :: Z0H        <font color=#447700>!roughness length, sensible heat, ground (m)<a name='994'></font>
  REAL    :: MOZ        <font color=#447700>!Monin-Obukhov stability parameter<a name='995'></font>
  REAL    :: FM         <font color=#447700>!momentum stability correction, weighted by prior iters<a name='996'></font>
  REAL    :: FH         <font color=#447700>!sen heat stability correction, weighted by prior iters<a name='997'></font>
  REAL    :: RAMB       <font color=#447700>!aerodynamic resistance for momentum (s/m)<a name='998'></font>
  REAL    :: RAHB       <font color=#447700>!aerodynamic resistance for sensible heat (s/m)<a name='999'></font>
  REAL    :: RAWB       <font color=#447700>!aerodynamic resistance for water vapor (s/m)<a name='1000'></font>
  REAL    :: ESTG       <font color=#447700>!saturation vapor pressure at tg (pa)<a name='1001'></font>
  REAL    :: DESTG      <font color=#447700>!d(es)/dt at tg (pa/K)<a name='1002'></font>
  REAL    :: ESATW      <font color=#447700>!es for water<a name='1003'></font>
  REAL    :: ESATI      <font color=#447700>!es for ice<a name='1004'></font>
  REAL    :: DSATW      <font color=#447700>!d(es)/dt at tg (pa/K) for water<a name='1005'></font>
  REAL    :: DSATI      <font color=#447700>!d(es)/dt at tg (pa/K) for ice<a name='1006'></font>
  REAL    :: A          <font color=#447700>!temporary calculation<a name='1007'></font>
  REAL    :: B          <font color=#447700>!temporary calculation<a name='1008'></font>
  REAL    :: T, TDC     <font color=#447700>!Kelvin to degree Celsius with limit -50 to +50<a name='1009'></font>
  REAL, DIMENSION(       1:NSOIL) :: SICE   <font color=#447700>!soil ice<a name='1010'></font>
<a name='1011'>
  TDC(T)   = MIN( 50., MAX(-50.,(T-TFRZ)) )<a name='1012'>
<a name='1013'>
<font color=#447700>! -----------------------------------------------------------------<a name='1014'></font>
<font color=#447700>! initialization variables that do not depend on stability iteration<a name='1015'></font>
<font color=#447700>! -----------------------------------------------------------------<a name='1016'></font>
        NITERB = 5<a name='1017'>
        MPE    = 1E-6<a name='1018'>
        DTG    = 0.<a name='1019'>
        MOZSGN = 0<a name='1020'>
        MOZOLD = 0.<a name='1021'>
        H      = 0.<a name='1022'>
        FV     = 0.1<a name='1023'>
<a name='1024'>
        CIR = EMG*SB<a name='1025'>
        CGH = 2.*DF(ISNOW+1)/DZSNSO(ISNOW+1)<a name='1026'>
<a name='1027'>
<font color=#447700>! -----------------------------------------------------------------<a name='1028'></font>
      loop3: DO ITER = 1, NITERB  <font color=#447700>! begin stability iteration<a name='1029'></font>
<a name='1030'>
        Z0H = Z0M <a name='1031'>
<a name='1032'>
<font color=#447700>!       For now, only allow SFCDIF1 until others can be fixed<a name='1033'></font>
<a name='1034'>
        CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SFCDIF1_GLACIER'>SFCDIF1_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#GLACIER_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIF1_GLACIER_1">(ITER   ,ZLVL   ,ZPD    ,Z0H    ,Z0M    , &amp; <font color=#447700>!in<a name='1035'></font>
                     QAIR   ,SFCTMP ,H      ,RHOAIR ,MPE    ,UR     , &amp; <font color=#447700>!in<a name='1036'></font>
       &amp;             MOZ    ,MOZSGN ,FM     ,FH     ,FM2    ,FH2    , &amp; <font color=#447700>!inout<a name='1037'></font>
       &amp;             FV     ,CM     ,CH     ,CH2)                       <font color=#447700>!out<a name='1038'></font>
<a name='1039'>
        RAMB = MAX(1.,1./(CM*UR))<a name='1040'>
        RAHB = MAX(1.,1./(CH*UR))<a name='1041'>
        RAWB = RAHB<a name='1042'>
<a name='1043'>
<font color=#447700>! es and d(es)/dt evaluated at tg<a name='1044'></font>
<a name='1045'>
        T = TDC(TGB)<a name='1046'>
        CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#ESAT'>ESAT</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#GLACIER_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESAT_1">(T, ESATW, ESATI, DSATW, DSATI)<a name='1047'>
        IF (T .GT. 0.) THEN<a name='1048'>
            ESTG  = ESATW<a name='1049'>
            DESTG = DSATW<a name='1050'>
        ELSE<a name='1051'>
            ESTG  = ESATI<a name='1052'>
            DESTG = DSATI<a name='1053'>
        END IF<a name='1054'>
<a name='1055'>
        CSH = RHOAIR*CPAIR/RAHB<a name='1056'>
	IF(SNOWH &gt; 0.0 .OR. OPT_GLA == 1) THEN<a name='1057'>
          CEV = RHOAIR*CPAIR/GAMMA/(RSURF+RAWB)<a name='1058'>
	ELSE<a name='1059'>
	  CEV = 0.0   <font color=#447700>! don't allow any sublimation of glacier in opt_gla=2<a name='1060'></font>
	END IF<a name='1061'>
<a name='1062'>
<font color=#447700>! surface fluxes and dtg<a name='1063'></font>
<a name='1064'>
        IRB   = CIR * TGB**4 - EMG*LWDN<a name='1065'>
        SHB   = CSH * (TGB        - SFCTMP      )<a name='1066'>
        EVB   = CEV * (ESTG*RHSUR - EAIR        )<a name='1067'>
        GHB   = CGH * (TGB        - STC(ISNOW+1))<a name='1068'>
<a name='1069'>
        B     = SAG-IRB-SHB-EVB-GHB<a name='1070'>
        A     = 4.*CIR*TGB**3 + CSH + CEV*DESTG + CGH<a name='1071'>
        DTG   = B/A<a name='1072'>
<a name='1073'>
        IRB = IRB + 4.*CIR*TGB**3*DTG<a name='1074'>
        SHB = SHB + CSH*DTG<a name='1075'>
        EVB = EVB + CEV*DESTG*DTG<a name='1076'>
        GHB = GHB + CGH*DTG<a name='1077'>
<a name='1078'>
<font color=#447700>! update ground surface temperature<a name='1079'></font>
        TGB = TGB + DTG<a name='1080'>
<a name='1081'>
<font color=#447700>! for M-O length<a name='1082'></font>
        H = CSH * (TGB - SFCTMP)<a name='1083'>
<a name='1084'>
        T = TDC(TGB)<a name='1085'>
        CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#ESAT'>ESAT</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#GLACIER_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESAT_2">(T, ESATW, ESATI, DSATW, DSATI)<a name='1086'>
        IF (T .GT. 0.) THEN<a name='1087'>
            ESTG  = ESATW<a name='1088'>
        ELSE<a name='1089'>
            ESTG  = ESATI<a name='1090'>
        END IF<a name='1091'>
        QSFC = 0.622*(ESTG*RHSUR)/(SFCPRS-0.378*(ESTG*RHSUR))<a name='1092'>
<a name='1093'>
     END DO loop3 <font color=#447700>! end stability iteration<a name='1094'></font>
<font color=#447700>! -----------------------------------------------------------------<a name='1095'></font>
<a name='1096'>
<font color=#447700>! if snow on ground and TG &gt; TFRZ: reset TG = TFRZ. reevaluate ground fluxes.<a name='1097'></font>
<a name='1098'>
     SICE = SMC - SH2O<a name='1099'>
     IF(OPT_STC == 1 .OR. OPT_STC ==3) THEN<a name='1100'>
     IF ((MAXVAL(SICE) &gt; 0.0 .OR. SNOWH &gt; 0.0) .AND. TGB &gt; TFRZ .AND. OPT_GLA == 1) THEN<a name='1101'>
          TGB = TFRZ<a name='1102'>
          T = TDC(TGB)                              <font color=#447700>! MB: recalculate ESTG<a name='1103'></font>
          CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#ESAT'>ESAT</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#GLACIER_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESAT_3">(T, ESATW, ESATI, DSATW, DSATI)<a name='1104'>
          ESTG  = ESATI<a name='1105'>
          QSFC = 0.622*(ESTG*RHSUR)/(SFCPRS-0.378*(ESTG*RHSUR))<a name='1106'>
          IRB = CIR * TGB**4 - EMG*LWDN<a name='1107'>
          SHB = CSH * (TGB        - SFCTMP)<a name='1108'>
          EVB = CEV * (ESTG*RHSUR - EAIR )          <font color=#447700>!ESTG reevaluate ?<a name='1109'></font>
          GHB = SAG - (IRB+SHB+EVB)<a name='1110'>
     END IF<a name='1111'>
     END IF<a name='1112'>
<a name='1113'>
<font color=#447700>! 2m air temperature<a name='1114'></font>
     EHB2  = FV*VKC/(LOG((2.+Z0H)/Z0H)-FH2)<a name='1115'>
     CQ2B  = EHB2<a name='1116'>
     IF (EHB2.lt.1.E-5 ) THEN<a name='1117'>
       T2MB  = TGB<a name='1118'>
       Q2B   = QSFC<a name='1119'>
     ELSE<a name='1120'>
       T2MB  = TGB - SHB/(RHOAIR*CPAIR) * 1./EHB2<a name='1121'>
       Q2B   = QSFC - EVB/(LATHEA*RHOAIR)*(1./CQ2B + RSURF)<a name='1122'>
     ENDIF<a name='1123'>
<a name='1124'>
<font color=#447700>! update CH <a name='1125'></font>
     CH = 1./RAHB<a name='1126'>
<a name='1127'>
  END SUBROUTINE GLACIER_FLUX<a name='1128'>
<font color=#447700>!  ==================================================================================================<a name='1129'></font>
<A NAME='ESAT'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ESAT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1130'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ESAT</font>(T, ESW, ESI, DESW, DESI) <A href='../../call_to/ESAT.html' TARGET='index'>8</A><a name='1131'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='1132'></font>
<font color=#447700>! use polynomials to calculate saturation vapor pressure and derivative with<a name='1133'></font>
<font color=#447700>! respect to temperature: over water when t &gt; 0 c and over ice when t &lt;= 0 c<a name='1134'></font>
  IMPLICIT NONE<a name='1135'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='1136'></font>
<font color=#447700>! in<a name='1137'></font>
<a name='1138'>
  REAL, intent(in)  :: T              <font color=#447700>!temperature<a name='1139'></font>
<a name='1140'>
<font color=#447700>!out<a name='1141'></font>
<a name='1142'>
  REAL, intent(out) :: ESW            <font color=#447700>!saturation vapor pressure over water (pa)<a name='1143'></font>
  REAL, intent(out) :: ESI            <font color=#447700>!saturation vapor pressure over ice (pa)<a name='1144'></font>
  REAL, intent(out) :: DESW           <font color=#447700>!d(esat)/dt over water (pa/K)<a name='1145'></font>
  REAL, intent(out) :: DESI           <font color=#447700>!d(esat)/dt over ice (pa/K)<a name='1146'></font>
<a name='1147'>
<font color=#447700>! local<a name='1148'></font>
<a name='1149'>
  REAL :: A0,A1,A2,A3,A4,A5,A6  <font color=#447700>!coefficients for esat over water<a name='1150'></font>
  REAL :: B0,B1,B2,B3,B4,B5,B6  <font color=#447700>!coefficients for esat over ice<a name='1151'></font>
  REAL :: C0,C1,C2,C3,C4,C5,C6  <font color=#447700>!coefficients for dsat over water<a name='1152'></font>
  REAL :: D0,D1,D2,D3,D4,D5,D6  <font color=#447700>!coefficients for dsat over ice<a name='1153'></font>
<a name='1154'>
  PARAMETER (A0=6.107799961    , A1=4.436518521E-01,  &amp;<a name='1155'>
             A2=1.428945805E-02, A3=2.650648471E-04,  &amp;<a name='1156'>
             A4=3.031240396E-06, A5=2.034080948E-08,  &amp;<a name='1157'>
             A6=6.136820929E-11)<a name='1158'>
<a name='1159'>
  PARAMETER (B0=6.109177956    , B1=5.034698970E-01,  &amp;<a name='1160'>
             B2=1.886013408E-02, B3=4.176223716E-04,  &amp;<a name='1161'>
             B4=5.824720280E-06, B5=4.838803174E-08,  &amp;<a name='1162'>
             B6=1.838826904E-10)<a name='1163'>
<a name='1164'>
  PARAMETER (C0= 4.438099984E-01, C1=2.857002636E-02,  &amp;<a name='1165'>
             C2= 7.938054040E-04, C3=1.215215065E-05,  &amp;<a name='1166'>
             C4= 1.036561403E-07, C5=3.532421810e-10,  &amp;<a name='1167'>
             C6=-7.090244804E-13)<a name='1168'>
<a name='1169'>
  PARAMETER (D0=5.030305237E-01, D1=3.773255020E-02,  &amp;<a name='1170'>
             D2=1.267995369E-03, D3=2.477563108E-05,  &amp;<a name='1171'>
             D4=3.005693132E-07, D5=2.158542548E-09,  &amp;<a name='1172'>
             D6=7.131097725E-12)<a name='1173'>
<a name='1174'>
  ESW  = 100.*(A0+T*(A1+T*(A2+T*(A3+T*(A4+T*(A5+T*A6))))))<a name='1175'>
  ESI  = 100.*(B0+T*(B1+T*(B2+T*(B3+T*(B4+T*(B5+T*B6))))))<a name='1176'>
  DESW = 100.*(C0+T*(C1+T*(C2+T*(C3+T*(C4+T*(C5+T*C6))))))<a name='1177'>
  DESI = 100.*(D0+T*(D1+T*(D2+T*(D3+T*(D4+T*(D5+T*D6))))))<a name='1178'>
<a name='1179'>
  END SUBROUTINE ESAT<a name='1180'>
<font color=#447700>! ==================================================================================================<a name='1181'></font>
<a name='1182'>
<A NAME='SFCDIF1_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SFCDIF1_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1183'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFCDIF1_GLACIER</font>(ITER   ,ZLVL   ,ZPD    ,Z0H    ,Z0M    , &amp; <font color=#447700>!in <A href='../../call_to/SFCDIF1_GLACIER.html' TARGET='index'>1</A>,<A href='../../call_from/SFCDIF1_GLACIER.html' TARGET='index'>1</A><a name='1184'></font>
                     QAIR   ,SFCTMP ,H      ,RHOAIR ,MPE    ,UR     , &amp; <font color=#447700>!in<a name='1185'></font>
       &amp;             MOZ    ,MOZSGN ,FM     ,FH     ,FM2    ,FH2    , &amp; <font color=#447700>!inout<a name='1186'></font>
       &amp;             FV     ,CM     ,CH     ,CH2     )                  <font color=#447700>!out<a name='1187'></font>
<font color=#447700>! -------------------------------------------------------------------------------------------------<a name='1188'></font>
<font color=#447700>! computing surface drag coefficient CM for momentum and CH for heat<a name='1189'></font>
<font color=#447700>! -------------------------------------------------------------------------------------------------<a name='1190'></font>
    IMPLICIT NONE<a name='1191'>
<font color=#447700>! -------------------------------------------------------------------------------------------------<a name='1192'></font>
<font color=#447700>! inputs<a name='1193'></font>
    INTEGER,              INTENT(IN) :: ITER   <font color=#447700>!iteration index<a name='1194'></font>
    REAL,                 INTENT(IN) :: ZLVL   <font color=#447700>!reference height  (m)<a name='1195'></font>
    REAL,                 INTENT(IN) :: ZPD    <font color=#447700>!zero plane displacement (m)<a name='1196'></font>
    REAL,                 INTENT(IN) :: Z0H    <font color=#447700>!roughness length, sensible heat, ground (m)<a name='1197'></font>
    REAL,                 INTENT(IN) :: Z0M    <font color=#447700>!roughness length, momentum, ground (m)<a name='1198'></font>
    REAL,                 INTENT(IN) :: QAIR   <font color=#447700>!specific humidity at reference height (kg/kg)<a name='1199'></font>
    REAL,                 INTENT(IN) :: SFCTMP <font color=#447700>!temperature at reference height (k)<a name='1200'></font>
    REAL,                 INTENT(IN) :: H      <font color=#447700>!sensible heat flux (w/m2) [+ to atm]<a name='1201'></font>
    REAL,                 INTENT(IN) :: RHOAIR <font color=#447700>!density air (kg/m**3)<a name='1202'></font>
    REAL,                 INTENT(IN) :: MPE    <font color=#447700>!prevents overflow error if division by zero<a name='1203'></font>
    REAL,                 INTENT(IN) :: UR     <font color=#447700>!wind speed (m/s)<a name='1204'></font>
<a name='1205'>
<font color=#447700>! in &amp; out<a name='1206'></font>
    REAL,              INTENT(INOUT) :: MOZ    <font color=#447700>!Monin-Obukhov stability (z/L)<a name='1207'></font>
    INTEGER,           INTENT(INOUT) :: MOZSGN <font color=#447700>!number of times moz changes sign<a name='1208'></font>
    REAL,              INTENT(INOUT) :: FM     <font color=#447700>!momentum stability correction, weighted by prior iters<a name='1209'></font>
    REAL,              INTENT(INOUT) :: FH     <font color=#447700>!sen heat stability correction, weighted by prior iters<a name='1210'></font>
    REAL,              INTENT(INOUT) :: FM2    <font color=#447700>!sen heat stability correction, weighted by prior iters<a name='1211'></font>
    REAL,              INTENT(INOUT) :: FH2    <font color=#447700>!sen heat stability correction, weighted by prior iters<a name='1212'></font>
<a name='1213'>
<font color=#447700>! outputs<a name='1214'></font>
    REAL,                INTENT(OUT) :: FV     <font color=#447700>!friction velocity (m/s)<a name='1215'></font>
    REAL,                INTENT(OUT) :: CM     <font color=#447700>!drag coefficient for momentum<a name='1216'></font>
    REAL,                INTENT(OUT) :: CH     <font color=#447700>!drag coefficient for heat<a name='1217'></font>
    REAL,                INTENT(OUT) :: CH2    <font color=#447700>!drag coefficient for heat<a name='1218'></font>
<a name='1219'>
<font color=#447700>! locals<a name='1220'></font>
    REAL    :: MOZOLD                   <font color=#447700>!Monin-Obukhov stability parameter from prior iteration<a name='1221'></font>
    REAL    :: TMPCM                    <font color=#447700>!temporary calculation for CM<a name='1222'></font>
    REAL    :: TMPCH                    <font color=#447700>!temporary calculation for CH<a name='1223'></font>
    REAL    :: MOL                      <font color=#447700>!Monin-Obukhov length (m)<a name='1224'></font>
    REAL    :: TVIR                     <font color=#447700>!temporary virtual temperature (k)<a name='1225'></font>
    REAL    :: TMP1,TMP2,TMP3           <font color=#447700>!temporary calculation<a name='1226'></font>
    REAL    :: FMNEW                    <font color=#447700>!stability correction factor, momentum, for current moz<a name='1227'></font>
    REAL    :: FHNEW                    <font color=#447700>!stability correction factor, sen heat, for current moz<a name='1228'></font>
    REAL    :: MOZ2                     <font color=#447700>!2/L<a name='1229'></font>
    REAL    :: TMPCM2                   <font color=#447700>!temporary calculation for CM2<a name='1230'></font>
    REAL    :: TMPCH2                   <font color=#447700>!temporary calculation for CH2<a name='1231'></font>
    REAL    :: FM2NEW                   <font color=#447700>!stability correction factor, momentum, for current moz<a name='1232'></font>
    REAL    :: FH2NEW                   <font color=#447700>!stability correction factor, sen heat, for current moz<a name='1233'></font>
    REAL    :: TMP12,TMP22,TMP32        <font color=#447700>!temporary calculation<a name='1234'></font>
<a name='1235'>
    REAL    :: CMFM, CHFH, CM2FM2, CH2FH2<a name='1236'>
<a name='1237'>
<a name='1238'>
<font color=#447700>! -------------------------------------------------------------------------------------------------<a name='1239'></font>
<font color=#447700>! Monin-Obukhov stability parameter moz for next iteration<a name='1240'></font>
<a name='1241'>
    MOZOLD = MOZ<a name='1242'>
  <a name='1243'>
    IF(ZLVL &lt;= ZPD) THEN<a name='1244'>
       write(*,*) 'critical glacier problem: ZLVL &lt;= ZPD; model stops', zlvl, zpd<a name='1245'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SFCDIF1_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1178">("STOP in Noah-MP glacier")<a name='1246'>
    ENDIF<a name='1247'>
<a name='1248'>
    TMPCM = LOG((ZLVL-ZPD) / Z0M)<a name='1249'>
    TMPCH = LOG((ZLVL-ZPD) / Z0H)<a name='1250'>
    TMPCM2 = LOG((2.0 + Z0M) / Z0M)<a name='1251'>
    TMPCH2 = LOG((2.0 + Z0H) / Z0H)<a name='1252'>
<a name='1253'>
    IF(ITER == 1) THEN<a name='1254'>
       FV   = 0.0<a name='1255'>
       MOZ  = 0.0<a name='1256'>
       MOL  = 0.0<a name='1257'>
       MOZ2 = 0.0<a name='1258'>
    ELSE<a name='1259'>
       TVIR = (1. + 0.61*QAIR) * SFCTMP<a name='1260'>
       TMP1 = VKC * (GRAV/TVIR) * H/(RHOAIR*CPAIR)<a name='1261'>
       IF (ABS(TMP1) .LE. MPE) TMP1 = MPE<a name='1262'>
       MOL  = -1. * FV**3 / TMP1<a name='1263'>
       MOZ  = MIN( (ZLVL-ZPD)/MOL, 1.)<a name='1264'>
       MOZ2  = MIN( (2.0 + Z0H)/MOL, 1.)<a name='1265'>
    ENDIF<a name='1266'>
<a name='1267'>
<font color=#447700>! accumulate number of times moz changes sign.<a name='1268'></font>
<a name='1269'>
    IF (MOZOLD*MOZ .LT. 0.) MOZSGN = MOZSGN+1<a name='1270'>
    IF (MOZSGN .GE. 2) THEN<a name='1271'>
       MOZ = 0.<a name='1272'>
       FM = 0.<a name='1273'>
       FH = 0.<a name='1274'>
       MOZ2 = 0.<a name='1275'>
       FM2 = 0.<a name='1276'>
       FH2 = 0.<a name='1277'>
    ENDIF<a name='1278'>
<a name='1279'>
<font color=#447700>! evaluate stability-dependent variables using moz from prior iteration<a name='1280'></font>
    IF (MOZ .LT. 0.) THEN<a name='1281'>
       TMP1 = (1. - 16.*MOZ)**0.25<a name='1282'>
       TMP2 = LOG((1.+TMP1*TMP1)/2.)<a name='1283'>
       TMP3 = LOG((1.+TMP1)/2.)<a name='1284'>
       FMNEW = 2.*TMP3 + TMP2 - 2.*ATAN(TMP1) + 1.5707963<a name='1285'>
       FHNEW = 2*TMP2<a name='1286'>
<a name='1287'>
<font color=#447700>! 2-meter<a name='1288'></font>
       TMP12 = (1. - 16.*MOZ2)**0.25<a name='1289'>
       TMP22 = LOG((1.+TMP12*TMP12)/2.)<a name='1290'>
       TMP32 = LOG((1.+TMP12)/2.)<a name='1291'>
       FM2NEW = 2.*TMP32 + TMP22 - 2.*ATAN(TMP12) + 1.5707963<a name='1292'>
       FH2NEW = 2*TMP22<a name='1293'>
    ELSE<a name='1294'>
       FMNEW = -5.*MOZ<a name='1295'>
       FHNEW = FMNEW<a name='1296'>
       FM2NEW = -5.*MOZ2<a name='1297'>
       FH2NEW = FM2NEW<a name='1298'>
    ENDIF<a name='1299'>
<a name='1300'>
<font color=#447700>! except for first iteration, weight stability factors for previous<a name='1301'></font>
<font color=#447700>! iteration to help avoid flip-flops from one iteration to the next<a name='1302'></font>
<a name='1303'>
    IF (ITER == 1) THEN<a name='1304'>
       FM = FMNEW<a name='1305'>
       FH = FHNEW<a name='1306'>
       FM2 = FM2NEW<a name='1307'>
       FH2 = FH2NEW<a name='1308'>
    ELSE<a name='1309'>
       FM = 0.5 * (FM+FMNEW)<a name='1310'>
       FH = 0.5 * (FH+FHNEW)<a name='1311'>
       FM2 = 0.5 * (FM2+FM2NEW)<a name='1312'>
       FH2 = 0.5 * (FH2+FH2NEW)<a name='1313'>
    ENDIF<a name='1314'>
<a name='1315'>
<font color=#447700>! exchange coefficients<a name='1316'></font>
<a name='1317'>
    FH = MIN(FH,0.9*TMPCH)<a name='1318'>
    FM = MIN(FM,0.9*TMPCM)<a name='1319'>
    FH2 = MIN(FH2,0.9*TMPCH2)<a name='1320'>
    FM2 = MIN(FM2,0.9*TMPCM2)<a name='1321'>
<a name='1322'>
    CMFM = TMPCM-FM<a name='1323'>
    CHFH = TMPCH-FH<a name='1324'>
    CM2FM2 = TMPCM2-FM2<a name='1325'>
    CH2FH2 = TMPCH2-FH2<a name='1326'>
    IF(ABS(CMFM) &lt;= MPE) CMFM = MPE<a name='1327'>
    IF(ABS(CHFH) &lt;= MPE) CHFH = MPE<a name='1328'>
    IF(ABS(CM2FM2) &lt;= MPE) CM2FM2 = MPE<a name='1329'>
    IF(ABS(CH2FH2) &lt;= MPE) CH2FH2 = MPE<a name='1330'>
    CM  = VKC*VKC/(CMFM*CMFM)<a name='1331'>
    CH  = VKC*VKC/(CMFM*CHFH)<a name='1332'>
    CH2  = VKC*VKC/(CM2FM2*CH2FH2)<a name='1333'>
        <a name='1334'>
<font color=#447700>! friction velocity<a name='1335'></font>
<a name='1336'>
    FV = UR * SQRT(CM)<a name='1337'>
    CH2  = VKC*FV/CH2FH2<a name='1338'>
<a name='1339'>
  END SUBROUTINE SFCDIF1_GLACIER<a name='1340'>
<font color=#447700>! ==================================================================================================<a name='1341'></font>
<A NAME='TSNOSOI_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#TSNOSOI_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1342'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>TSNOSOI_GLACIER</font> (NSOIL   ,NSNOW   ,ISNOW   ,DT      ,TBOT    , &amp; <font color=#447700>!in <A href='../../call_to/TSNOSOI_GLACIER.html' TARGET='index'>1</A>,<A href='../../call_from/TSNOSOI_GLACIER.html' TARGET='index'>2</A><a name='1343'></font>
                              SSOIL   ,SNOWH   ,ZBOT    ,ZSNSO   ,DF      , &amp; <font color=#447700>!in<a name='1344'></font>
			      HCPCT   ,                                     &amp; <font color=#447700>!in<a name='1345'></font>
                              STC     )                                       <font color=#447700>!inout<a name='1346'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='1347'></font>
<font color=#447700>! Compute snow (up to 3L) and soil (4L) temperature. Note that snow temperatures<a name='1348'></font>
<font color=#447700>! during melting season may exceed melting point (TFRZ) but later in PHASECHANGE<a name='1349'></font>
<font color=#447700>! subroutine the snow temperatures are reset to TFRZ for melting snow.<a name='1350'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='1351'></font>
  IMPLICIT NONE<a name='1352'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='1353'></font>
<font color=#447700>!input<a name='1354'></font>
<a name='1355'>
    INTEGER,                         INTENT(IN)  :: NSOIL  <font color=#447700>!no of soil layers (4)<a name='1356'></font>
    INTEGER,                         INTENT(IN)  :: NSNOW  <font color=#447700>!maximum no of snow layers (3)<a name='1357'></font>
    INTEGER,                         INTENT(IN)  :: ISNOW  <font color=#447700>!actual no of snow layers<a name='1358'></font>
<a name='1359'>
    REAL,                            INTENT(IN)  :: DT     <font color=#447700>!time step (s)<a name='1360'></font>
    REAL,                            INTENT(IN)  :: TBOT   <font color=#447700>!<a name='1361'></font>
    REAL,                            INTENT(IN)  :: SSOIL  <font color=#447700>!ground heat flux (w/m2)<a name='1362'></font>
    REAL,                            INTENT(IN)  :: SNOWH  <font color=#447700>!snow depth (m)<a name='1363'></font>
    REAL,                            INTENT(IN)  :: ZBOT   <font color=#447700>!from soil surface (m)<a name='1364'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: ZSNSO  <font color=#447700>!layer-bot. depth from snow surf.(m)<a name='1365'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: DF     <font color=#447700>!thermal conductivity<a name='1366'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: HCPCT  <font color=#447700>!heat capacity (J/m3/k)<a name='1367'></font>
<a name='1368'>
<font color=#447700>!input and output<a name='1369'></font>
<a name='1370'>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC<a name='1371'>
<a name='1372'>
<font color=#447700>!local<a name='1373'></font>
<a name='1374'>
    INTEGER                                      :: IZ<a name='1375'>
    REAL                                         :: ZBOTSNO   <font color=#447700>!ZBOT from snow surface<a name='1376'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL)              :: AI, BI, CI, RHSTS<a name='1377'>
    REAL                                         :: EFLXB <font color=#447700>!energy influx from soil bottom (w/m2)<a name='1378'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL)              :: PHI   <font color=#447700>!light through water (w/m2)<a name='1379'></font>
<a name='1380'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1381'></font>
<a name='1382'>
<font color=#447700>! prescribe solar penetration into ice/snow<a name='1383'></font>
<a name='1384'>
    PHI(ISNOW+1:NSOIL) = 0.<a name='1385'>
<a name='1386'>
<font color=#447700>! adjust ZBOT from soil surface to ZBOTSNO from snow surface<a name='1387'></font>
<a name='1388'>
    ZBOTSNO = ZBOT - SNOWH    <font color=#447700>!from snow surface<a name='1389'></font>
<a name='1390'>
<font color=#447700>! compute ice temperatures<a name='1391'></font>
<a name='1392'>
      CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#HRT_GLACIER'>HRT_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#TSNOSOI_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HRT_GLACIER_1">   (NSNOW     ,NSOIL     ,ISNOW     ,ZSNSO     , &amp;<a name='1393'>
                          STC       ,TBOT      ,ZBOTSNO   ,DF        , &amp;<a name='1394'>
                          HCPCT     ,SSOIL     ,PHI       ,            &amp;<a name='1395'>
                          AI        ,BI        ,CI        ,RHSTS     , &amp;<a name='1396'>
                          EFLXB     )<a name='1397'>
<a name='1398'>
      CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#HSTEP_GLACIER'>HSTEP_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#TSNOSOI_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HSTEP_GLACIER_1"> (NSNOW     ,NSOIL     ,ISNOW     ,DT        , &amp;<a name='1399'>
                          AI        ,BI        ,CI        ,RHSTS     , &amp;<a name='1400'>
                          STC       ) <a name='1401'>
<a name='1402'>
  END SUBROUTINE TSNOSOI_GLACIER<a name='1403'>
<font color=#447700>! ==================================================================================================<a name='1404'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1405'></font>
<A NAME='HRT_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#HRT_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1406'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>HRT_GLACIER</font> (NSNOW     ,NSOIL     ,ISNOW     ,ZSNSO     , &amp; <font color=#447700>!in <A href='../../call_to/HRT_GLACIER.html' TARGET='index'>1</A><a name='1407'></font>
                          STC       ,TBOT      ,ZBOT      ,DF        , &amp; <font color=#447700>!in<a name='1408'></font>
                          HCPCT     ,SSOIL     ,PHI       ,            &amp; <font color=#447700>!in<a name='1409'></font>
                          AI        ,BI        ,CI        ,RHSTS     , &amp; <font color=#447700>!out<a name='1410'></font>
                          BOTFLX    )                                    <font color=#447700>!out<a name='1411'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1412'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1413'></font>
<font color=#447700>! calculate the right hand side of the time tendency term of the soil<a name='1414'></font>
<font color=#447700>! thermal diffusion equation.  also to compute ( prepare ) the matrix<a name='1415'></font>
<font color=#447700>! coefficients for the tri-diagonal matrix of the implicit time scheme.<a name='1416'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1417'></font>
    IMPLICIT NONE<a name='1418'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1419'></font>
<font color=#447700>! input<a name='1420'></font>
<a name='1421'>
    INTEGER,                         INTENT(IN)  :: NSOIL  <font color=#447700>!no of soil layers (4)<a name='1422'></font>
    INTEGER,                         INTENT(IN)  :: NSNOW  <font color=#447700>!maximum no of snow layers (3)<a name='1423'></font>
    INTEGER,                         INTENT(IN)  :: ISNOW  <font color=#447700>!actual no of snow layers<a name='1424'></font>
    REAL,                            INTENT(IN)  :: TBOT   <font color=#447700>!bottom soil temp. at ZBOT (k)<a name='1425'></font>
    REAL,                            INTENT(IN)  :: ZBOT   <font color=#447700>!depth of lower boundary condition (m)<a name='1426'></font>
                                                           <font color=#447700>!from soil surface not snow surface<a name='1427'></font>
    REAL,                            INTENT(IN)  :: SSOIL  <font color=#447700>!ground heat flux (w/m2)<a name='1428'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: ZSNSO  <font color=#447700>!depth of layer-bottom of snow/soil (m)<a name='1429'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: STC    <font color=#447700>!snow/soil temperature (k)<a name='1430'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: DF     <font color=#447700>!thermal conductivity [w/m/k]<a name='1431'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: HCPCT  <font color=#447700>!heat capacity [j/m3/k]<a name='1432'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: PHI    <font color=#447700>!light through water (w/m2)<a name='1433'></font>
<a name='1434'>
<font color=#447700>! output<a name='1435'></font>
<a name='1436'>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: RHSTS  <font color=#447700>!right-hand side of the matrix<a name='1437'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: AI     <font color=#447700>!left-hand side coefficient<a name='1438'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: BI     <font color=#447700>!left-hand side coefficient<a name='1439'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: CI     <font color=#447700>!left-hand side coefficient<a name='1440'></font>
    REAL,                            INTENT(OUT) :: BOTFLX <font color=#447700>!energy influx from soil bottom (w/m2)<a name='1441'></font>
<a name='1442'>
<font color=#447700>! local<a name='1443'></font>
<a name='1444'>
    INTEGER                                      :: K<a name='1445'>
    REAL, DIMENSION(-NSNOW+1:NSOIL)              :: DDZ<a name='1446'>
    REAL, DIMENSION(-NSNOW+1:NSOIL)              :: DENOM<a name='1447'>
    REAL, DIMENSION(-NSNOW+1:NSOIL)              :: DTSDZ<a name='1448'>
    REAL, DIMENSION(-NSNOW+1:NSOIL)              :: EFLUX<a name='1449'>
    REAL                                         :: TEMP1<a name='1450'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1451'></font>
<a name='1452'>
    DO K = ISNOW+1, NSOIL<a name='1453'>
        IF (K == ISNOW+1) THEN<a name='1454'>
           DENOM(K)  = - ZSNSO(K) * HCPCT(K)<a name='1455'>
           TEMP1     = - ZSNSO(K+1)<a name='1456'>
           DDZ(K)    = 2.0 / TEMP1<a name='1457'>
           DTSDZ(K)  = 2.0 * (STC(K) - STC(K+1)) / TEMP1<a name='1458'>
           EFLUX(K)  = DF(K) * DTSDZ(K) - SSOIL - PHI(K)<a name='1459'>
        ELSE IF (K &lt; NSOIL) THEN<a name='1460'>
           DENOM(K)  = (ZSNSO(K-1) - ZSNSO(K)) * HCPCT(K)<a name='1461'>
           TEMP1     = ZSNSO(K-1) - ZSNSO(K+1)<a name='1462'>
           DDZ(K)    = 2.0 / TEMP1<a name='1463'>
           DTSDZ(K)  = 2.0 * (STC(K) - STC(K+1)) / TEMP1<a name='1464'>
           EFLUX(K)  = (DF(K)*DTSDZ(K) - DF(K-1)*DTSDZ(K-1)) - PHI(K)<a name='1465'>
        ELSE IF (K == NSOIL) THEN<a name='1466'>
           DENOM(K)  = (ZSNSO(K-1) - ZSNSO(K)) * HCPCT(K)<a name='1467'>
           TEMP1     =  ZSNSO(K-1) - ZSNSO(K)<a name='1468'>
           IF(OPT_TBOT == 1) THEN<a name='1469'>
               BOTFLX     = 0. <a name='1470'>
           END IF<a name='1471'>
           IF(OPT_TBOT == 2) THEN<a name='1472'>
               DTSDZ(K)  = (STC(K) - TBOT) / ( 0.5*(ZSNSO(K-1)+ZSNSO(K)) - ZBOT)<a name='1473'>
               BOTFLX    = -DF(K) * DTSDZ(K)<a name='1474'>
           END IF<a name='1475'>
           EFLUX(K)  = (-BOTFLX - DF(K-1)*DTSDZ(K-1) ) - PHI(K)<a name='1476'>
        END IF<a name='1477'>
    END DO<a name='1478'>
<a name='1479'>
    DO K = ISNOW+1, NSOIL<a name='1480'>
        IF (K == ISNOW+1) THEN<a name='1481'>
           AI(K)    =   0.0<a name='1482'>
           CI(K)    = - DF(K)   * DDZ(K) / DENOM(K)<a name='1483'>
           IF (OPT_STC == 1 .OR. OPT_STC == 3) THEN<a name='1484'>
              BI(K) = - CI(K)<a name='1485'>
           END IF                                        <a name='1486'>
           IF (OPT_STC == 2) THEN<a name='1487'>
              BI(K) = - CI(K) + DF(K)/(0.5*ZSNSO(K)*ZSNSO(K)*HCPCT(K))<a name='1488'>
           END IF<a name='1489'>
        ELSE IF (K &lt; NSOIL) THEN<a name='1490'>
           AI(K)    = - DF(K-1) * DDZ(K-1) / DENOM(K) <a name='1491'>
           CI(K)    = - DF(K  ) * DDZ(K  ) / DENOM(K) <a name='1492'>
           BI(K)    = - (AI(K) + CI (K))<a name='1493'>
        ELSE IF (K == NSOIL) THEN<a name='1494'>
           AI(K)    = - DF(K-1) * DDZ(K-1) / DENOM(K) <a name='1495'>
           CI(K)    = 0.0<a name='1496'>
           BI(K)    = - (AI(K) + CI(K))<a name='1497'>
        END IF<a name='1498'>
           RHSTS(K)  = EFLUX(K)/ (-DENOM(K))<a name='1499'>
    END DO<a name='1500'>
<a name='1501'>
  END SUBROUTINE HRT_GLACIER<a name='1502'>
<font color=#447700>! ==================================================================================================<a name='1503'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1504'></font>
<A NAME='HSTEP_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#HSTEP_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1505'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>HSTEP_GLACIER</font> (NSNOW     ,NSOIL     ,ISNOW     ,DT        ,  &amp; <font color=#447700>!in <A href='../../call_to/HSTEP_GLACIER.html' TARGET='index'>1</A>,<A href='../../call_from/HSTEP_GLACIER.html' TARGET='index'>1</A><a name='1506'></font>
                            AI        ,BI        ,CI        ,RHSTS     ,  &amp; <font color=#447700>!inout<a name='1507'></font>
                            STC       )                                     <font color=#447700>!inout<a name='1508'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1509'></font>
<font color=#447700>! CALCULATE/UPDATE THE SOIL TEMPERATURE FIELD.<a name='1510'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1511'></font>
    implicit none<a name='1512'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1513'></font>
<font color=#447700>! input<a name='1514'></font>
<a name='1515'>
    INTEGER,                         INTENT(IN)    :: NSOIL<a name='1516'>
    INTEGER,                         INTENT(IN)    :: NSNOW<a name='1517'>
    INTEGER,                         INTENT(IN)    :: ISNOW<a name='1518'>
    REAL,                            INTENT(IN)    :: DT<a name='1519'>
<a name='1520'>
<font color=#447700>! output &amp; input<a name='1521'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: AI<a name='1522'>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: BI<a name='1523'>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: CI<a name='1524'>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC<a name='1525'>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: RHSTS<a name='1526'>
<a name='1527'>
<font color=#447700>! local<a name='1528'></font>
    INTEGER                                        :: K<a name='1529'>
    REAL, DIMENSION(-NSNOW+1:NSOIL)                :: RHSTSIN<a name='1530'>
    REAL, DIMENSION(-NSNOW+1:NSOIL)                :: CIIN<a name='1531'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1532'></font>
<a name='1533'>
    DO K = ISNOW+1,NSOIL<a name='1534'>
       RHSTS(K) =   RHSTS(K) * DT<a name='1535'>
       AI(K)    =      AI(K) * DT<a name='1536'>
       BI(K)    = 1. + BI(K) * DT<a name='1537'>
       CI(K)    =      CI(K) * DT<a name='1538'>
    END DO<a name='1539'>
<a name='1540'>
<font color=#447700>! copy values for input variables before call to rosr12<a name='1541'></font>
<a name='1542'>
    DO K = ISNOW+1,NSOIL<a name='1543'>
       RHSTSIN(K) = RHSTS(K)<a name='1544'>
       CIIN(K)    = CI(K)<a name='1545'>
    END DO<a name='1546'>
<a name='1547'>
<font color=#447700>! solve the tri-diagonal matrix equation<a name='1548'></font>
<a name='1549'>
    CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ROSR12_GLACIER'>ROSR12_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#HSTEP_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROSR12_GLACIER_1"> (CI,AI,BI,CIIN,RHSTSIN,RHSTS,ISNOW+1,NSOIL,NSNOW)<a name='1550'>
<a name='1551'>
<font color=#447700>! update snow &amp; soil temperature<a name='1552'></font>
<a name='1553'>
    DO K = ISNOW+1,NSOIL<a name='1554'>
       STC (K) = STC (K) + CI (K)<a name='1555'>
    END DO<a name='1556'>
<a name='1557'>
  END SUBROUTINE HSTEP_GLACIER<a name='1558'>
<font color=#447700>! ==================================================================================================<a name='1559'></font>
<A NAME='ROSR12_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ROSR12_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1560'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ROSR12_GLACIER</font> (P,A,B,C,D,DELTA,NTOP,NSOIL,NSNOW) <A href='../../call_to/ROSR12_GLACIER.html' TARGET='index'>1</A><a name='1561'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1562'></font>
<font color=#447700>! SUBROUTINE ROSR12<a name='1563'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1564'></font>
<font color=#447700>! INVERT (SOLVE) THE TRI-DIAGONAL MATRIX PROBLEM SHOWN BELOW:<a name='1565'></font>
<font color=#447700>! ###                                            ### ###  ###   ###  ###<a name='1566'></font>
<font color=#447700>! #B(1), C(1),  0  ,  0  ,  0  ,   . . .  ,    0   # #      #   #      #<a name='1567'></font>
<font color=#447700>! #A(2), B(2), C(2),  0  ,  0  ,   . . .  ,    0   # #      #   #      #<a name='1568'></font>
<font color=#447700>! # 0  , A(3), B(3), C(3),  0  ,   . . .  ,    0   # #      #   # D(3) #<a name='1569'></font>
<font color=#447700>! # 0  ,  0  , A(4), B(4), C(4),   . . .  ,    0   # # P(4) #   # D(4) #<a name='1570'></font>
<font color=#447700>! # 0  ,  0  ,  0  , A(5), B(5),   . . .  ,    0   # # P(5) #   # D(5) #<a name='1571'></font>
<font color=#447700>! # .                                          .   # #  .   # = #   .  #<a name='1572'></font>
<font color=#447700>! # .                                          .   # #  .   #   #   .  #<a name='1573'></font>
<font color=#447700>! # .                                          .   # #  .   #   #   .  #<a name='1574'></font>
<font color=#447700>! # 0  , . . . , 0 , A(M-2), B(M-2), C(M-2),   0   # #P(M-2)#   #D(M-2)#<a name='1575'></font>
<font color=#447700>! # 0  , . . . , 0 ,   0   , A(M-1), B(M-1), C(M-1)# #P(M-1)#   #D(M-1)#<a name='1576'></font>
<font color=#447700>! # 0  , . . . , 0 ,   0   ,   0   ,  A(M) ,  B(M) # # P(M) #   # D(M) #<a name='1577'></font>
<font color=#447700>! ###                                            ### ###  ###   ###  ###<a name='1578'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1579'></font>
    IMPLICIT NONE<a name='1580'>
<a name='1581'>
    INTEGER, INTENT(IN)   :: NTOP           <a name='1582'>
    INTEGER, INTENT(IN)   :: NSOIL,NSNOW<a name='1583'>
    INTEGER               :: K, KK<a name='1584'>
<a name='1585'>
    REAL, DIMENSION(-NSNOW+1:NSOIL),INTENT(IN):: A, B, D<a name='1586'>
    REAL, DIMENSION(-NSNOW+1:NSOIL),INTENT(INOUT):: C,P,DELTA<a name='1587'>
<a name='1588'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1589'></font>
<font color=#447700>! INITIALIZE EQN COEF C FOR THE LOWEST SOIL LAYER<a name='1590'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1591'></font>
    C (NSOIL) = 0.0<a name='1592'>
    P (NTOP) = - C (NTOP) / B (NTOP)<a name='1593'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1594'></font>
<font color=#447700>! SOLVE THE COEFS FOR THE 1ST SOIL LAYER<a name='1595'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1596'></font>
    DELTA (NTOP) = D (NTOP) / B (NTOP)<a name='1597'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1598'></font>
<font color=#447700>! SOLVE THE COEFS FOR SOIL LAYERS 2 THRU NSOIL<a name='1599'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1600'></font>
    DO K = NTOP+1,NSOIL<a name='1601'>
       P (K) = - C (K) * ( 1.0 / (B (K) + A (K) * P (K -1)) )<a name='1602'>
       DELTA (K) = (D (K) - A (K)* DELTA (K -1))* (1.0/ (B (K) + A (K)&amp;<a name='1603'>
            * P (K -1)))<a name='1604'>
    END DO<a name='1605'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1606'></font>
<font color=#447700>! SET P TO DELTA FOR LOWEST SOIL LAYER<a name='1607'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1608'></font>
    P (NSOIL) = DELTA (NSOIL)<a name='1609'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1610'></font>
<font color=#447700>! ADJUST P FOR SOIL LAYERS 2 THRU NSOIL<a name='1611'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1612'></font>
    DO K = NTOP+1,NSOIL<a name='1613'>
       KK = NSOIL - K + (NTOP-1) + 1<a name='1614'>
       P (KK) = P (KK) * P (KK +1) + DELTA (KK)<a name='1615'>
    END DO<a name='1616'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1617'></font>
  END SUBROUTINE ROSR12_GLACIER<a name='1618'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1619'></font>
<font color=#447700>! ==================================================================================================<a name='1620'></font>
<A NAME='PHASECHANGE_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#PHASECHANGE_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1621'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>PHASECHANGE_GLACIER</font> (NSNOW   ,NSOIL   ,ISNOW   ,DT      ,FACT    , &amp; <font color=#447700>!in <A href='../../call_to/PHASECHANGE_GLACIER.html' TARGET='index'>1</A><a name='1622'></font>
                                  DZSNSO  ,                                     &amp; <font color=#447700>!in<a name='1623'></font>
                                  STC     ,SNICE   ,SNLIQ   ,SNEQV   ,SNOWH   , &amp; <font color=#447700>!inout<a name='1624'></font>
                                  SMC     ,SH2O    ,                            &amp; <font color=#447700>!inout<a name='1625'></font>
                                  QMELT   ,IMELT   ,PONDING )                     <font color=#447700>!out<a name='1626'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1627'></font>
<font color=#447700>! melting/freezing of snow water and soil water<a name='1628'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1629'></font>
  IMPLICIT NONE<a name='1630'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1631'></font>
<font color=#447700>! inputs<a name='1632'></font>
<a name='1633'>
  INTEGER, INTENT(IN)                             :: NSNOW  <font color=#447700>!maximum no. of snow layers [=3]<a name='1634'></font>
  INTEGER, INTENT(IN)                             :: NSOIL  <font color=#447700>!No. of soil layers [=4]<a name='1635'></font>
  INTEGER, INTENT(IN)                             :: ISNOW  <font color=#447700>!actual no. of snow layers [&lt;=3]<a name='1636'></font>
  REAL, INTENT(IN)                                :: DT     <font color=#447700>!land model time step (sec)<a name='1637'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)     :: FACT   <font color=#447700>!temporary<a name='1638'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)     :: DZSNSO <font color=#447700>!snow/soil layer thickness [m]<a name='1639'></font>
<a name='1640'>
<font color=#447700>! inputs/outputs<a name='1641'></font>
<a name='1642'>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT)  :: STC    <font color=#447700>!snow/soil layer temperature [k]<a name='1643'></font>
  REAL, DIMENSION(-NSNOW+1:0)    , INTENT(INOUT)  :: SNICE  <font color=#447700>!snow layer ice [mm]<a name='1644'></font>
  REAL, DIMENSION(-NSNOW+1:0)    , INTENT(INOUT)  :: SNLIQ  <font color=#447700>!snow layer liquid water [mm]<a name='1645'></font>
  REAL, INTENT(INOUT)                             :: SNEQV<a name='1646'>
  REAL, INTENT(INOUT)                             :: SNOWH<a name='1647'>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT)  :: SH2O   <font color=#447700>!soil liquid water [m3/m3]<a name='1648'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT)  :: SMC    <font color=#447700>!total soil water [m3/m3]<a name='1649'></font>
<a name='1650'>
<font color=#447700>! outputs<a name='1651'></font>
  REAL,                               INTENT(OUT) :: QMELT  <font color=#447700>!snowmelt rate [mm/s]<a name='1652'></font>
  INTEGER, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: IMELT  <font color=#447700>!phase change index<a name='1653'></font>
  REAL,                               INTENT(OUT) :: PONDING<font color=#447700>!snowmelt when snow has no layer [mm]<a name='1654'></font>
<a name='1655'>
<font color=#447700>! local<a name='1656'></font>
<a name='1657'>
  INTEGER                         :: J,K         <font color=#447700>!do loop index<a name='1658'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: HM        <font color=#447700>!energy residual [w/m2]<a name='1659'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: XM        <font color=#447700>!melting or freezing water [kg/m2]<a name='1660'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: WMASS0<a name='1661'>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: WICE0 <a name='1662'>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: WLIQ0 <a name='1663'>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: MICE      <font color=#447700>!soil/snow ice mass [mm]<a name='1664'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: MLIQ      <font color=#447700>!soil/snow liquid water mass [mm]<a name='1665'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: HEATR     <font color=#447700>!energy residual or loss after melting/freezing<a name='1666'></font>
  REAL                            :: TEMP1     <font color=#447700>!temporary variables [kg/m2]<a name='1667'></font>
  REAL                            :: PROPOR<a name='1668'>
  REAL                            :: XMF       <font color=#447700>!total latent heat of phase change<a name='1669'></font>
<a name='1670'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1671'></font>
<font color=#447700>! Initialization<a name='1672'></font>
<a name='1673'>
    QMELT   = 0.<a name='1674'>
    PONDING = 0.<a name='1675'>
    XMF     = 0.<a name='1676'>
<a name='1677'>
    DO J = ISNOW+1,0           <font color=#447700>! all snow layers<a name='1678'></font>
         MICE(J) = SNICE(J)<a name='1679'>
         MLIQ(J) = SNLIQ(J)<a name='1680'>
    END DO<a name='1681'>
<a name='1682'>
    DO J = ISNOW+1,0           <font color=#447700>! all snow layers; do ice later<a name='1683'></font>
         IMELT(J)    = 0<a name='1684'>
         HM(J)       = 0.<a name='1685'>
         XM(J)       = 0.<a name='1686'>
         WICE0(J)    = MICE(J)<a name='1687'>
         WLIQ0(J)    = MLIQ(J)<a name='1688'>
         WMASS0(J)   = MICE(J) + MLIQ(J)<a name='1689'>
    ENDDO<a name='1690'>
    <a name='1691'>
    DO J = ISNOW+1,0<a name='1692'>
         IF (MICE(J) &gt; 0. .AND. STC(J) &gt;= TFRZ) THEN  <font color=#447700>! melting <a name='1693'></font>
             IMELT(J) = 1<a name='1694'>
         ENDIF<a name='1695'>
         IF (MLIQ(J) &gt; 0. .AND. STC(J)  &lt; TFRZ) THEN  <font color=#447700>! freezing <a name='1696'></font>
             IMELT(J) = 2<a name='1697'>
         ENDIF<a name='1698'>
<a name='1699'>
    ENDDO<a name='1700'>
<a name='1701'>
<font color=#447700>! Calculate the energy surplus and loss for melting and freezing<a name='1702'></font>
<a name='1703'>
    DO J = ISNOW+1,0<a name='1704'>
         IF (IMELT(J) &gt; 0) THEN<a name='1705'>
             HM(J) = (STC(J)-TFRZ)/FACT(J)<a name='1706'>
             STC(J) = TFRZ<a name='1707'>
         ENDIF<a name='1708'>
<a name='1709'>
         IF (IMELT(J) == 1 .AND. HM(J) &lt; 0.) THEN<a name='1710'>
            HM(J) = 0.<a name='1711'>
            IMELT(J) = 0<a name='1712'>
         ENDIF<a name='1713'>
         IF (IMELT(J) == 2 .AND. HM(J) &gt; 0.) THEN<a name='1714'>
            HM(J) = 0.<a name='1715'>
            IMELT(J) = 0<a name='1716'>
         ENDIF<a name='1717'>
         XM(J) = HM(J)*DT/HFUS                           <a name='1718'>
    ENDDO<a name='1719'>
<a name='1720'>
<font color=#447700>! The rate of melting and freezing for snow without a layer, opt_gla==1 treated below<a name='1721'></font>
<a name='1722'>
IF (OPT_GLA == 2) THEN <a name='1723'>
<a name='1724'>
    IF (ISNOW == 0 .AND. SNEQV &gt; 0. .AND. STC(1) &gt;= TFRZ) THEN  <a name='1725'>
        HM(1)    = (STC(1)-TFRZ)/FACT(1)             <font color=#447700>! available heat<a name='1726'></font>
        STC(1)   = TFRZ                              <font color=#447700>! set T to freezing<a name='1727'></font>
        XM(1)    = HM(1)*DT/HFUS                     <font color=#447700>! total snow melt possible       <a name='1728'></font>
<a name='1729'>
        TEMP1  = SNEQV<a name='1730'>
        SNEQV  = MAX(0.,TEMP1-XM(1))                 <font color=#447700>! snow remaining<a name='1731'></font>
        PROPOR = SNEQV/TEMP1                         <font color=#447700>! fraction melted<a name='1732'></font>
        SNOWH  = MAX(0.,PROPOR * SNOWH)              <font color=#447700>! new snow height<a name='1733'></font>
        HEATR(1)  = HM(1) - HFUS*(TEMP1-SNEQV)/DT    <font color=#447700>! excess heat<a name='1734'></font>
        IF (HEATR(1) &gt; 0.) THEN<a name='1735'>
              XM(1)  = HEATR(1)*DT/HFUS             <a name='1736'>
              STC(1) = STC(1) + FACT(1)*HEATR(1)     <font color=#447700>! re-heat ice<a name='1737'></font>
        ELSE<a name='1738'>
              XM(1) = 0.                             <font color=#447700>! heat used up<a name='1739'></font>
              HM(1) = 0.<a name='1740'>
        ENDIF<a name='1741'>
        QMELT   = MAX(0.,(TEMP1-SNEQV))/DT           <font color=#447700>! melted snow rate<a name='1742'></font>
        XMF     = HFUS*QMELT                         <font color=#447700>! melted snow energy<a name='1743'></font>
        PONDING = TEMP1-SNEQV                        <font color=#447700>! melt water<a name='1744'></font>
    ENDIF<a name='1745'>
<a name='1746'>
END IF  <font color=#447700>! OPT_GLA == 2<a name='1747'></font>
<a name='1748'>
<font color=#447700>! The rate of melting and freezing for snow<a name='1749'></font>
<a name='1750'>
    DO J = ISNOW+1,0<a name='1751'>
      IF (IMELT(J) &gt; 0 .AND. ABS(HM(J)) &gt; 0.) THEN<a name='1752'>
<a name='1753'>
         HEATR(J) = 0.<a name='1754'>
         IF (XM(J) &gt; 0.) THEN                            <a name='1755'>
            MICE(J) = MAX(0., WICE0(J)-XM(J))<a name='1756'>
            HEATR(J) = HM(J) - HFUS*(WICE0(J)-MICE(J))/DT<a name='1757'>
         ELSE IF (XM(J) &lt; 0.) THEN                      <a name='1758'>
            MICE(J) = MIN(WMASS0(J), WICE0(J)-XM(J))  <a name='1759'>
            HEATR(J) = HM(J) - HFUS*(WICE0(J)-MICE(J))/DT<a name='1760'>
         ENDIF<a name='1761'>
<a name='1762'>
         MLIQ(J) = MAX(0.,WMASS0(J)-MICE(J))<a name='1763'>
<a name='1764'>
         IF (ABS(HEATR(J)) &gt; 0.) THEN<a name='1765'>
            STC(J) = STC(J) + FACT(J)*HEATR(J)<a name='1766'>
            IF (MLIQ(J)*MICE(J)&gt;0.) STC(J) = TFRZ<a name='1767'>
         ENDIF<a name='1768'>
<a name='1769'>
         QMELT = QMELT + MAX(0.,(WICE0(J)-MICE(J)))/DT<a name='1770'>
<a name='1771'>
      ENDIF<a name='1772'>
    ENDDO<a name='1773'>
<a name='1774'>
IF (OPT_GLA == 1) THEN     <font color=#447700>! operate on the ice layers<a name='1775'></font>
<a name='1776'>
    DO J = 1, NSOIL            <font color=#447700>! all soil layers<a name='1777'></font>
         MLIQ(J) =  SH2O(J)            * DZSNSO(J) * 1000.<a name='1778'>
         MICE(J) = (SMC(J) - SH2O(J))  * DZSNSO(J) * 1000.<a name='1779'>
    END DO<a name='1780'>
<a name='1781'>
    DO J = 1,NSOIL       <font color=#447700>! all layers<a name='1782'></font>
         IMELT(J)    = 0<a name='1783'>
         HM(J)       = 0.<a name='1784'>
         XM(J)       = 0.<a name='1785'>
         WICE0(J)    = MICE(J)<a name='1786'>
         WLIQ0(J)    = MLIQ(J)<a name='1787'>
         WMASS0(J)   = MICE(J) + MLIQ(J)<a name='1788'>
    ENDDO<a name='1789'>
    <a name='1790'>
    DO J = 1,NSOIL<a name='1791'>
         IF (MICE(J) &gt; 0. .AND. STC(J) &gt;= TFRZ) THEN  <font color=#447700>! melting <a name='1792'></font>
             IMELT(J) = 1<a name='1793'>
         ENDIF<a name='1794'>
         IF (MLIQ(J) &gt; 0. .AND. STC(J)  &lt; TFRZ) THEN  <font color=#447700>! freezing <a name='1795'></font>
             IMELT(J) = 2<a name='1796'>
         ENDIF<a name='1797'>
<a name='1798'>
         <font color=#447700>! If snow exists, but its thickness is not enough to create a layer<a name='1799'></font>
         IF (ISNOW == 0 .AND. SNEQV &gt; 0. .AND. J == 1) THEN<a name='1800'>
             IF (STC(J) &gt;= TFRZ) THEN<a name='1801'>
                IMELT(J) = 1<a name='1802'>
             ENDIF<a name='1803'>
         ENDIF<a name='1804'>
    ENDDO<a name='1805'>
<a name='1806'>
<font color=#447700>! Calculate the energy surplus and loss for melting and freezing<a name='1807'></font>
<a name='1808'>
    DO J = 1,NSOIL<a name='1809'>
         IF (IMELT(J) &gt; 0) THEN<a name='1810'>
             HM(J) = (STC(J)-TFRZ)/FACT(J)<a name='1811'>
             STC(J) = TFRZ<a name='1812'>
         ENDIF<a name='1813'>
<a name='1814'>
         IF (IMELT(J) == 1 .AND. HM(J) &lt; 0.) THEN<a name='1815'>
            HM(J) = 0.<a name='1816'>
            IMELT(J) = 0<a name='1817'>
         ENDIF<a name='1818'>
         IF (IMELT(J) == 2 .AND. HM(J) &gt; 0.) THEN<a name='1819'>
            HM(J) = 0.<a name='1820'>
            IMELT(J) = 0<a name='1821'>
         ENDIF<a name='1822'>
         XM(J) = HM(J)*DT/HFUS                           <a name='1823'>
    ENDDO<a name='1824'>
<a name='1825'>
<font color=#447700>! The rate of melting and freezing for snow without a layer, needs more work.<a name='1826'></font>
<a name='1827'>
    IF (ISNOW == 0 .AND. SNEQV &gt; 0. .AND. XM(1) &gt; 0.) THEN  <a name='1828'>
        TEMP1  = SNEQV<a name='1829'>
        SNEQV  = MAX(0.,TEMP1-XM(1))  <a name='1830'>
        PROPOR = SNEQV/TEMP1<a name='1831'>
        SNOWH  = MAX(0.,PROPOR * SNOWH)<a name='1832'>
        HEATR(1)  = HM(1) - HFUS*(TEMP1-SNEQV)/DT  <a name='1833'>
        IF (HEATR(1) &gt; 0.) THEN<a name='1834'>
              XM(1) = HEATR(1)*DT/HFUS             <a name='1835'>
              HM(1) = HEATR(1) <a name='1836'>
	      IMELT(1) = 1                   <a name='1837'>
        ELSE<a name='1838'>
              XM(1) = 0.<a name='1839'>
              HM(1) = 0.<a name='1840'>
	      IMELT(1) = 0                   <a name='1841'>
        ENDIF<a name='1842'>
        QMELT   = MAX(0.,(TEMP1-SNEQV))/DT<a name='1843'>
        XMF     = HFUS*QMELT<a name='1844'>
        PONDING = TEMP1-SNEQV<a name='1845'>
    ENDIF<a name='1846'>
<a name='1847'>
<font color=#447700>! The rate of melting and freezing for soil<a name='1848'></font>
<a name='1849'>
    DO J = 1,NSOIL<a name='1850'>
      IF (IMELT(J) &gt; 0 .AND. ABS(HM(J)) &gt; 0.) THEN<a name='1851'>
<a name='1852'>
         HEATR(J) = 0.<a name='1853'>
         IF (XM(J) &gt; 0.) THEN                            <a name='1854'>
            MICE(J) = MAX(0., WICE0(J)-XM(J))<a name='1855'>
            HEATR(J) = HM(J) - HFUS*(WICE0(J)-MICE(J))/DT<a name='1856'>
         ELSE IF (XM(J) &lt; 0.) THEN                      <a name='1857'>
            MICE(J) = MIN(WMASS0(J), WICE0(J)-XM(J))  <a name='1858'>
            HEATR(J) = HM(J) - HFUS*(WICE0(J)-MICE(J))/DT<a name='1859'>
         ENDIF<a name='1860'>
<a name='1861'>
         MLIQ(J) = MAX(0.,WMASS0(J)-MICE(J))<a name='1862'>
<a name='1863'>
         IF (ABS(HEATR(J)) &gt; 0.) THEN<a name='1864'>
            STC(J) = STC(J) + FACT(J)*HEATR(J)<a name='1865'>
            IF (J &lt;= 0) THEN                             <font color=#447700>! snow<a name='1866'></font>
               IF (MLIQ(J)*MICE(J)&gt;0.) STC(J) = TFRZ<a name='1867'>
            END IF<a name='1868'>
         ENDIF<a name='1869'>
<a name='1870'>
         IF (J &gt; 0) XMF = XMF + HFUS * (WICE0(J)-MICE(J))/DT<a name='1871'>
<a name='1872'>
         IF (J &lt; 1) THEN<a name='1873'>
            QMELT = QMELT + MAX(0.,(WICE0(J)-MICE(J)))/DT<a name='1874'>
         ENDIF<a name='1875'>
      ENDIF<a name='1876'>
    ENDDO<a name='1877'>
    HEATR = 0.0<a name='1878'>
    XM = 0.0<a name='1879'>
<a name='1880'>
<font color=#447700>! Deal with residuals in ice/soil<a name='1881'></font>
<a name='1882'>
<font color=#447700>! FIRST REMOVE EXCESS HEAT BY REDUCING TEMPERATURE OF LAYERS<a name='1883'></font>
<a name='1884'>
    IF (ANY(STC(1:4) &gt; TFRZ) .AND. ANY(STC(1:4) &lt; TFRZ)) THEN<a name='1885'>
      DO J = 1,NSOIL<a name='1886'>
        IF ( STC(J) &gt; TFRZ ) THEN                                       <a name='1887'>
	  HEATR(J) = (STC(J)-TFRZ)/FACT(J)<a name='1888'>
          DO K = 1,NSOIL<a name='1889'>
	    IF (J .NE. K .AND. STC(K) &lt; TFRZ .AND. HEATR(J) &gt; 0.1) THEN<a name='1890'>
	      HEATR(K) = (STC(K)-TFRZ)/FACT(K)<a name='1891'>
	      IF (ABS(HEATR(K)) &gt; HEATR(J)) THEN  <font color=#447700>! LAYER ABSORBS ALL<a name='1892'></font>
	        HEATR(K) = HEATR(K) + HEATR(J)<a name='1893'>
		STC(K) = TFRZ + HEATR(K)*FACT(K)<a name='1894'>
		HEATR(J) = 0.0<a name='1895'>
              ELSE<a name='1896'>
	        HEATR(J) = HEATR(J) + HEATR(K)<a name='1897'>
		HEATR(K) = 0.0<a name='1898'>
		STC(K) = TFRZ<a name='1899'>
              END IF<a name='1900'>
	    END IF<a name='1901'>
	  END DO<a name='1902'>
          STC(J) = TFRZ + HEATR(J)*FACT(J)<a name='1903'>
        END IF<a name='1904'>
      END DO<a name='1905'>
    END IF<a name='1906'>
<a name='1907'>
<font color=#447700>! NOW REMOVE EXCESS COLD BY INCREASING TEMPERATURE OF LAYERS (MAY NOT BE NECESSARY WITH ABOVE LOOP)<a name='1908'></font>
<a name='1909'>
    IF (ANY(STC(1:4) &gt; TFRZ) .AND. ANY(STC(1:4) &lt; TFRZ)) THEN<a name='1910'>
      DO J = 1,NSOIL<a name='1911'>
        IF ( STC(J) &lt; TFRZ ) THEN                                       <a name='1912'>
	  HEATR(J) = (STC(J)-TFRZ)/FACT(J)<a name='1913'>
          DO K = 1,NSOIL<a name='1914'>
	    IF (J .NE. K .AND. STC(K) &gt; TFRZ .AND. HEATR(J) &lt; -0.1) THEN<a name='1915'>
	      HEATR(K) = (STC(K)-TFRZ)/FACT(K)<a name='1916'>
	      IF (HEATR(K) &gt; ABS(HEATR(J))) THEN  <font color=#447700>! LAYER ABSORBS ALL<a name='1917'></font>
	        HEATR(K) = HEATR(K) + HEATR(J)<a name='1918'>
		STC(K) = TFRZ + HEATR(K)*FACT(K)<a name='1919'>
		HEATR(J) = 0.0<a name='1920'>
              ELSE<a name='1921'>
	        HEATR(J) = HEATR(J) + HEATR(K)<a name='1922'>
		HEATR(K) = 0.0<a name='1923'>
		STC(K) = TFRZ<a name='1924'>
              END IF<a name='1925'>
	    END IF<a name='1926'>
	  END DO<a name='1927'>
          STC(J) = TFRZ + HEATR(J)*FACT(J)<a name='1928'>
        END IF<a name='1929'>
      END DO<a name='1930'>
    END IF<a name='1931'>
<a name='1932'>
<font color=#447700>! NOW REMOVE EXCESS HEAT BY MELTING ICE<a name='1933'></font>
<a name='1934'>
    IF (ANY(STC(1:4) &gt; TFRZ) .AND. ANY(MICE(1:4) &gt; 0.)) THEN<a name='1935'>
      DO J = 1,NSOIL<a name='1936'>
        IF ( STC(J) &gt; TFRZ ) THEN                                       <a name='1937'>
	  HEATR(J) = (STC(J)-TFRZ)/FACT(J)<a name='1938'>
          XM(J) = HEATR(J)*DT/HFUS                           <a name='1939'>
          DO K = 1,NSOIL<a name='1940'>
	    IF (J .NE. K .AND. MICE(K) &gt; 0. .AND. XM(J) &gt; 0.1) THEN<a name='1941'>
	      IF (MICE(K) &gt; XM(J)) THEN  <font color=#447700>! LAYER ABSORBS ALL<a name='1942'></font>
	        MICE(K) = MICE(K) - XM(J)<a name='1943'>
		XMF = XMF + HFUS * XM(J)/DT<a name='1944'>
		STC(K) = TFRZ<a name='1945'>
		XM(J) = 0.0<a name='1946'>
              ELSE<a name='1947'>
	        XM(J) = XM(J) - MICE(K)<a name='1948'>
		XMF = XMF + HFUS * MICE(K)/DT<a name='1949'>
		MICE(K) = 0.0<a name='1950'>
		STC(K) = TFRZ<a name='1951'>
              END IF<a name='1952'>
              MLIQ(K) = MAX(0.,WMASS0(K)-MICE(K))<a name='1953'>
	    END IF<a name='1954'>
	  END DO<a name='1955'>
	  HEATR(J) = XM(J)*HFUS/DT<a name='1956'>
          STC(J) = TFRZ + HEATR(J)*FACT(J)<a name='1957'>
        END IF<a name='1958'>
      END DO<a name='1959'>
    END IF<a name='1960'>
<a name='1961'>
<font color=#447700>! NOW REMOVE EXCESS COLD BY FREEZING LIQUID OF LAYERS (MAY NOT BE NECESSARY WITH ABOVE LOOP)<a name='1962'></font>
<a name='1963'>
    IF (ANY(STC(1:4) &lt; TFRZ) .AND. ANY(MLIQ(1:4) &gt; 0.)) THEN<a name='1964'>
      DO J = 1,NSOIL<a name='1965'>
        IF ( STC(J) &lt; TFRZ ) THEN                                       <a name='1966'>
	  HEATR(J) = (STC(J)-TFRZ)/FACT(J)<a name='1967'>
          XM(J) = HEATR(J)*DT/HFUS                           <a name='1968'>
          DO K = 1,NSOIL<a name='1969'>
	    IF (J .NE. K .AND. MLIQ(K) &gt; 0. .AND. XM(J) &lt; -0.1) THEN<a name='1970'>
	      IF (MLIQ(K) &gt; ABS(XM(J))) THEN  <font color=#447700>! LAYER ABSORBS ALL<a name='1971'></font>
	        MICE(K) = MICE(K) - XM(J)<a name='1972'>
		XMF = XMF + HFUS * XM(J)/DT<a name='1973'>
		STC(K) = TFRZ<a name='1974'>
		XM(J) = 0.0<a name='1975'>
              ELSE<a name='1976'>
	        XM(J) = XM(J) + MLIQ(K)<a name='1977'>
		XMF = XMF - HFUS * MLIQ(K)/DT<a name='1978'>
		MICE(K) = WMASS0(K)<a name='1979'>
		STC(K) = TFRZ<a name='1980'>
              END IF<a name='1981'>
              MLIQ(K) = MAX(0.,WMASS0(K)-MICE(K))<a name='1982'>
	    END IF<a name='1983'>
	  END DO<a name='1984'>
	  HEATR(J) = XM(J)*HFUS/DT<a name='1985'>
          STC(J) = TFRZ + HEATR(J)*FACT(J)<a name='1986'>
        END IF<a name='1987'>
      END DO<a name='1988'>
    END IF<a name='1989'>
    <a name='1990'>
END IF   <font color=#447700>! OPT_GLA == 1<a name='1991'></font>
<a name='1992'>
    DO J = ISNOW+1,0             <font color=#447700>! snow<a name='1993'></font>
       SNLIQ(J) = MLIQ(J)<a name='1994'>
       SNICE(J) = MICE(J)<a name='1995'>
    END DO<a name='1996'>
<a name='1997'>
    DO J = 1, NSOIL              <font color=#447700>! soil<a name='1998'></font>
      IF(OPT_GLA == 1) THEN <a name='1999'>
       SH2O(J) =  MLIQ(J)            / (1000. * DZSNSO(J))<a name='2000'>
       SH2O(J) =  MAX(0.0,MIN(1.0,SH2O(J)))<a name='2001'>
<font color=#447700>!       SMC(J)  = (MLIQ(J) + MICE(J)) / (1000. * DZSNSO(J))<a name='2002'></font>
      ELSEIF(OPT_GLA == 2) THEN <a name='2003'>
       SH2O(J) = 0.0             <font color=#447700>! ice, assume all frozen...forever<a name='2004'></font>
      END IF<a name='2005'>
      SMC(J)  = 1.0 <a name='2006'>
    END DO<a name='2007'>
   <a name='2008'>
  END SUBROUTINE PHASECHANGE_GLACIER<a name='2009'>
<font color=#447700>! ==================================================================================================<a name='2010'></font>
<A NAME='WATER_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#WATER_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2011'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>WATER_GLACIER</font> (NSNOW  ,NSOIL  ,IMELT  ,DT     ,PRCP   ,SFCTMP , &amp; <font color=#447700>!in <A href='../../call_to/WATER_GLACIER.html' TARGET='index'>1</A>,<A href='../../call_from/WATER_GLACIER.html' TARGET='index'>1</A><a name='2012'></font>
                            QVAP   ,QDEW   ,FICEOLD,ZSOIL  ,                 &amp; <font color=#447700>!in<a name='2013'></font>
                            ISNOW  ,SNOWH  ,SNEQV  ,SNICE  ,SNLIQ  ,STC    , &amp; <font color=#447700>!inout<a name='2014'></font>
                            DZSNSO ,SH2O   ,SICE   ,PONDING,ZSNSO  ,FSH    , &amp; <font color=#447700>!inout<a name='2015'></font>
                            RUNSRF ,RUNSUB ,QSNOW  ,PONDING1 ,PONDING2,QSNBOT,FPICE     &amp;   <font color=#447700>!out<a name='2016'></font>
#ifdef WRF_HYDRO<a name='2017'>
                            , sfcheadrt                                      &amp;<a name='2018'>
#endif<a name='2019'>
                            )  <font color=#447700>!out<a name='2020'></font>
<font color=#447700>! ----------------------------------------------------------------------  <a name='2021'></font>
<font color=#447700>! Code history:<a name='2022'></font>
<font color=#447700>! Initial code: Guo-Yue Niu, Oct. 2007<a name='2023'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2024'></font>
  implicit none<a name='2025'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2026'></font>
<font color=#447700>! input<a name='2027'></font>
  INTEGER,                         INTENT(IN)    :: NSNOW   <font color=#447700>!maximum no. of snow layers<a name='2028'></font>
  INTEGER,                         INTENT(IN)    :: NSOIL   <font color=#447700>!no. of soil layers<a name='2029'></font>
  INTEGER, DIMENSION(-NSNOW+1:0) , INTENT(IN)    :: IMELT   <font color=#447700>!melting state index [1-melt; 2-freeze]<a name='2030'></font>
  REAL,                            INTENT(IN)    :: DT      <font color=#447700>!main time step (s)<a name='2031'></font>
  REAL,                            INTENT(IN)    :: PRCP    <font color=#447700>!precipitation (mm/s)<a name='2032'></font>
  REAL,                            INTENT(IN)    :: SFCTMP  <font color=#447700>!surface air temperature [k]<a name='2033'></font>
  REAL,                            INTENT(INOUT)    :: QVAP    <font color=#447700>!soil surface evaporation rate[mm/s]<a name='2034'></font>
  REAL,                            INTENT(INOUT)    :: QDEW    <font color=#447700>!soil surface dew rate[mm/s]<a name='2035'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(IN)    :: FICEOLD <font color=#447700>!ice fraction at last timestep<a name='2036'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN)    :: ZSOIL  <font color=#447700>!layer-bottom depth from soil surf (m)<a name='2037'></font>
<a name='2038'>
<font color=#447700>! input/output<a name='2039'></font>
  INTEGER,                         INTENT(INOUT) :: ISNOW   <font color=#447700>!actual no. of snow layers<a name='2040'></font>
  REAL,                            INTENT(INOUT) :: SNOWH   <font color=#447700>!snow height [m]<a name='2041'></font>
  REAL,                            INTENT(INOUT) :: SNEQV   <font color=#447700>!snow water eqv. [mm]<a name='2042'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNICE   <font color=#447700>!snow layer ice [mm]<a name='2043'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNLIQ   <font color=#447700>!snow layer liquid water [mm]<a name='2044'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC     <font color=#447700>!snow/soil layer temperature [k]<a name='2045'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: DZSNSO  <font color=#447700>!snow/soil layer thickness [m]<a name='2046'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SH2O    <font color=#447700>!soil liquid water content [m3/m3]<a name='2047'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SICE    <font color=#447700>!soil ice content [m3/m3]<a name='2048'></font>
  REAL                           , INTENT(INOUT) :: PONDING <font color=#447700>![mm]<a name='2049'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: ZSNSO   <font color=#447700>!layer-bottom depth from snow surf [m]<a name='2050'></font>
  REAL                           , INTENT(INOUT) :: FSH     <font color=#447700>!total sensible heat (w/m2) [+ to atm]<a name='2051'></font>
<a name='2052'>
<font color=#447700>! output<a name='2053'></font>
  REAL,                            INTENT(OUT)   :: RUNSRF  <font color=#447700>!surface runoff [mm/s] <a name='2054'></font>
  REAL,                            INTENT(OUT)   :: RUNSUB  <font color=#447700>!baseflow (sturation excess) [mm/s]<a name='2055'></font>
  REAL,                            INTENT(OUT)   :: QSNOW   <font color=#447700>!snow at ground srf (mm/s) [+]<a name='2056'></font>
  REAL,                            INTENT(OUT)   :: PONDING1<a name='2057'>
  REAL,                            INTENT(OUT)   :: PONDING2<a name='2058'>
  REAL,                            INTENT(OUT)   :: QSNBOT  <font color=#447700>!melting water out of snow bottom [mm/s]<a name='2059'></font>
  REAL,                            INTENT(OUT)   :: FPICE   <font color=#447700>!precipitation frozen fraction<a name='2060'></font>
<a name='2061'>
<font color=#447700>! local<a name='2062'></font>
  REAL                                           :: QRAIN   <font color=#447700>!rain at ground srf (mm) [+]<a name='2063'></font>
  REAL                                           :: QSEVA   <font color=#447700>!soil surface evap rate [mm/s]<a name='2064'></font>
  REAL                                           :: QSDEW   <font color=#447700>!soil surface dew rate [mm/s]<a name='2065'></font>
  REAL                                           :: QSNFRO  <font color=#447700>!snow surface frost rate[mm/s]<a name='2066'></font>
  REAL                                           :: QSNSUB  <font color=#447700>!snow surface sublimation rate [mm/s]<a name='2067'></font>
  REAL                                           :: SNOWHIN <font color=#447700>!snow depth increasing rate (m/s)<a name='2068'></font>
  REAL                                           :: SNOFLOW <font color=#447700>!glacier flow [mm/s]<a name='2069'></font>
  REAL                                           :: BDFALL  <font color=#447700>!density of new snow (mm water/m snow)<a name='2070'></font>
  REAL                                           :: REPLACE <font color=#447700>!replacement water due to sublimation of glacier<a name='2071'></font>
  REAL, DIMENSION(       1:NSOIL)                :: SICE_SAVE  <font color=#447700>!soil ice content [m3/m3]<a name='2072'></font>
  REAL, DIMENSION(       1:NSOIL)                :: SH2O_SAVE  <font color=#447700>!soil liquid water content [m3/m3]<a name='2073'></font>
  INTEGER :: ILEV<a name='2074'>
<a name='2075'>
#ifdef WRF_HYDRO<a name='2076'>
  REAL                           , INTENT(INOUT)    :: sfcheadrt<a name='2077'>
#endif<a name='2078'>
<a name='2079'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2080'></font>
<font color=#447700>! initialize<a name='2081'></font>
<a name='2082'>
   SNOFLOW         = 0.<a name='2083'>
   RUNSUB          = 0.<a name='2084'>
   RUNSRF          = 0.<a name='2085'>
   SICE_SAVE       = SICE<a name='2086'>
   SH2O_SAVE       = SH2O<a name='2087'>
<a name='2088'>
<font color=#447700>! --------------------------------------------------------------------<a name='2089'></font>
<font color=#447700>! partition precipitation into rain and snow (from CANWATER)<a name='2090'></font>
<a name='2091'>
<font color=#447700>! Jordan (1991)<a name='2092'></font>
<a name='2093'>
     IF(OPT_SNF == 1 .OR. OPT_SNF == 4) THEN<a name='2094'>
       IF(SFCTMP &gt; TFRZ+2.5)THEN<a name='2095'>
           FPICE = 0.<a name='2096'>
       ELSE<a name='2097'>
         IF(SFCTMP &lt;= TFRZ+0.5)THEN<a name='2098'>
           FPICE = 1.0<a name='2099'>
         ELSE IF(SFCTMP &lt;= TFRZ+2.)THEN<a name='2100'>
           FPICE = 1.-(-54.632 + 0.2*SFCTMP)<a name='2101'>
         ELSE<a name='2102'>
           FPICE = 0.6<a name='2103'>
         ENDIF<a name='2104'>
       ENDIF<a name='2105'>
     ENDIF<a name='2106'>
<a name='2107'>
     IF(OPT_SNF == 2) THEN<a name='2108'>
       IF(SFCTMP &gt;= TFRZ+2.2) THEN<a name='2109'>
           FPICE = 0.<a name='2110'>
       ELSE<a name='2111'>
           FPICE = 1.0<a name='2112'>
       ENDIF<a name='2113'>
     ENDIF<a name='2114'>
<a name='2115'>
     IF(OPT_SNF == 3) THEN<a name='2116'>
       IF(SFCTMP &gt;= TFRZ) THEN<a name='2117'>
           FPICE = 0.<a name='2118'>
       ELSE<a name='2119'>
           FPICE = 1.0<a name='2120'>
       ENDIF<a name='2121'>
     ENDIF<a name='2122'>
<font color=#447700>!     print*, 'fpice: ',fpice<a name='2123'></font>
<a name='2124'>
<font color=#447700>! Hedstrom NR and JW Pomeroy (1998), Hydrol. Processes, 12, 1611-1625<a name='2125'></font>
<font color=#447700>! fresh snow density<a name='2126'></font>
<a name='2127'>
     BDFALL = MIN(120.,67.92+51.25*EXP((SFCTMP-TFRZ)/2.59)) <font color=#447700>!MB: change to MIN v3.7<a name='2128'></font>
<a name='2129'>
     QRAIN   = PRCP * (1.-FPICE)<a name='2130'>
     QSNOW   = PRCP * FPICE<a name='2131'>
     SNOWHIN = QSNOW/BDFALL<a name='2132'>
<font color=#447700>!     print *, 'qrain, qsnow',qrain,qsnow,qrain*dt,qsnow*dt<a name='2133'></font>
<a name='2134'>
<font color=#447700>! sublimation, frost, evaporation, and dew<a name='2135'></font>
<a name='2136'>
     QSNSUB = QVAP  <font color=#447700>! send total sublimation/frost to SNOWWATER and deal with it there<a name='2137'></font>
     QSNFRO = QDEW<a name='2138'>
<a name='2139'>
     CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWWATER_GLACIER'>SNOWWATER_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#WATER_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWWATER_GLACIER_1"> (NSNOW  ,NSOIL  ,IMELT  ,DT     ,SFCTMP , &amp; <font color=#447700>!in<a name='2140'></font>
                             SNOWHIN,QSNOW  ,QSNFRO ,QSNSUB ,QRAIN  , &amp; <font color=#447700>!in<a name='2141'></font>
                             FICEOLD,ZSOIL  ,                         &amp; <font color=#447700>!in<a name='2142'></font>
                             ISNOW  ,SNOWH  ,SNEQV  ,SNICE  ,SNLIQ  , &amp; <font color=#447700>!inout<a name='2143'></font>
                             SH2O   ,SICE   ,STC    ,DZSNSO ,ZSNSO  , &amp; <font color=#447700>!inout<a name='2144'></font>
                             FSH    ,                                 &amp; <font color=#447700>!inout<a name='2145'></font>
                             QSNBOT ,SNOFLOW,PONDING1       ,PONDING2)  <font color=#447700>!out<a name='2146'></font>
<a name='2147'>
    <font color=#447700>!PONDING: melting water from snow when there is no layer<a name='2148'></font>
    <a name='2149'>
    RUNSRF = (PONDING+PONDING1+PONDING2)/DT<a name='2150'>
<a name='2151'>
    IF(ISNOW == 0) THEN<a name='2152'>
      RUNSRF = RUNSRF + QSNBOT + QRAIN<a name='2153'>
    ELSE<a name='2154'>
      RUNSRF = RUNSRF + QSNBOT<a name='2155'>
    ENDIF<a name='2156'>
<a name='2157'>
#ifdef WRF_HYDRO<a name='2158'>
      RUNSRF = RUNSRF + sfcheadrt/DT  <font color=#447700>!sfcheadrt units (mm)<a name='2159'></font>
#endif<a name='2160'>
    <a name='2161'>
    IF(OPT_GLA == 1) THEN<a name='2162'>
      REPLACE = 0.0<a name='2163'>
      DO ILEV = 1,NSOIL<a name='2164'>
       REPLACE = REPLACE + DZSNSO(ILEV)*(SICE(ILEV) - SICE_SAVE(ILEV) + SH2O(ILEV) - SH2O_SAVE(ILEV))<a name='2165'>
      END DO<a name='2166'>
      REPLACE = REPLACE * 1000.0 / DT     <font color=#447700>! convert to [mm/s]<a name='2167'></font>
    <a name='2168'>
      SICE = MIN(1.0,SICE_SAVE)<a name='2169'>
    ELSEIF(OPT_GLA == 2) THEN<a name='2170'>
      SICE = 1.0<a name='2171'>
    END IF<a name='2172'>
    SH2O = 1.0 - SICE<a name='2173'>
    <a name='2174'>
    <font color=#447700>! use RUNSUB as a water balancer, SNOFLOW is snow that disappears, REPLACE is<a name='2175'></font>
    <font color=#447700>!   water from below that replaces glacier loss<a name='2176'></font>
<a name='2177'>
    IF(OPT_GLA == 1) THEN<a name='2178'>
      RUNSUB       = SNOFLOW + REPLACE<a name='2179'>
    ELSEIF(OPT_GLA == 2) THEN<a name='2180'>
      RUNSUB       = SNOFLOW<a name='2181'>
      QVAP = QSNSUB<a name='2182'>
      QDEW = QSNFRO<a name='2183'>
    END IF<a name='2184'>
<a name='2185'>
  END SUBROUTINE WATER_GLACIER<a name='2186'>
<font color=#447700>! ==================================================================================================<a name='2187'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2188'></font>
<A NAME='SNOWWATER_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWWATER_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2189'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWWATER_GLACIER</font> (NSNOW  ,NSOIL  ,IMELT  ,DT     ,SFCTMP , &amp; <font color=#447700>!in <A href='../../call_to/SNOWWATER_GLACIER.html' TARGET='index'>1</A>,<A href='../../call_from/SNOWWATER_GLACIER.html' TARGET='index'>5</A><a name='2190'></font>
                                SNOWHIN,QSNOW  ,QSNFRO ,QSNSUB ,QRAIN  , &amp; <font color=#447700>!in<a name='2191'></font>
                                FICEOLD,ZSOIL  ,                         &amp; <font color=#447700>!in<a name='2192'></font>
                                ISNOW  ,SNOWH  ,SNEQV  ,SNICE  ,SNLIQ  , &amp; <font color=#447700>!inout<a name='2193'></font>
                                SH2O   ,SICE   ,STC    ,DZSNSO ,ZSNSO  , &amp; <font color=#447700>!inout<a name='2194'></font>
				FSH    ,                                 &amp; <font color=#447700>!inout<a name='2195'></font>
                                QSNBOT ,SNOFLOW,PONDING1       ,PONDING2)  <font color=#447700>!out<a name='2196'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2197'></font>
  IMPLICIT NONE<a name='2198'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2199'></font>
<font color=#447700>! input<a name='2200'></font>
  INTEGER,                         INTENT(IN)    :: NSNOW  <font color=#447700>!maximum no. of snow layers<a name='2201'></font>
  INTEGER,                         INTENT(IN)    :: NSOIL  <font color=#447700>!no. of soil layers<a name='2202'></font>
  INTEGER, DIMENSION(-NSNOW+1:0) , INTENT(IN)    :: IMELT  <font color=#447700>!melting state index [0-no melt;1-melt]<a name='2203'></font>
  REAL,                            INTENT(IN)    :: DT     <font color=#447700>!time step (s)<a name='2204'></font>
  REAL,                            INTENT(IN)    :: SFCTMP <font color=#447700>!surface air temperature [k]<a name='2205'></font>
  REAL,                            INTENT(IN)    :: SNOWHIN<font color=#447700>!snow depth increasing rate (m/s)<a name='2206'></font>
  REAL,                            INTENT(IN)    :: QSNOW  <font color=#447700>!snow at ground srf (mm/s) [+]<a name='2207'></font>
  REAL,                            INTENT(INOUT)    :: QSNFRO <font color=#447700>!snow surface frost rate[mm/s]<a name='2208'></font>
  REAL,                            INTENT(INOUT)    :: QSNSUB <font color=#447700>!snow surface sublimation rate[mm/s]<a name='2209'></font>
  REAL,                            INTENT(IN)    :: QRAIN  <font color=#447700>!snow surface rain rate[mm/s]<a name='2210'></font>
  REAL, DIMENSION(-NSNOW+1:0)    , INTENT(IN)    :: FICEOLD<font color=#447700>!ice fraction at last timestep<a name='2211'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN)    :: ZSOIL  <font color=#447700>!layer-bottom depth from soil surf (m)<a name='2212'></font>
<a name='2213'>
<font color=#447700>! input &amp; output<a name='2214'></font>
  INTEGER,                         INTENT(INOUT) :: ISNOW  <font color=#447700>!actual no. of snow layers<a name='2215'></font>
  REAL,                            INTENT(INOUT) :: SNOWH  <font color=#447700>!snow height [m]<a name='2216'></font>
  REAL,                            INTENT(INOUT) :: SNEQV  <font color=#447700>!snow water eqv. [mm]<a name='2217'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNICE  <font color=#447700>!snow layer ice [mm]<a name='2218'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNLIQ  <font color=#447700>!snow layer liquid water [mm]<a name='2219'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SH2O   <font color=#447700>!soil liquid moisture (m3/m3)<a name='2220'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SICE   <font color=#447700>!soil ice moisture (m3/m3)<a name='2221'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC    <font color=#447700>!snow layer temperature [k]<a name='2222'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: DZSNSO <font color=#447700>!snow/soil layer thickness [m]<a name='2223'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: ZSNSO  <font color=#447700>!layer-bottom depth from snow surf [m]<a name='2224'></font>
  REAL                           , INTENT(INOUT) :: FSH     <font color=#447700>!total sensible heat (w/m2) [+ to atm]<a name='2225'></font>
<a name='2226'>
<font color=#447700>! output<a name='2227'></font>
  REAL,                              INTENT(OUT) :: QSNBOT <font color=#447700>!melting water out of snow bottom [mm/s]<a name='2228'></font>
  REAL,                              INTENT(OUT) :: SNOFLOW<font color=#447700>!glacier flow [mm]<a name='2229'></font>
  REAL,                              INTENT(OUT) :: PONDING1<a name='2230'>
  REAL,                              INTENT(OUT) :: PONDING2<a name='2231'>
<a name='2232'>
<font color=#447700>! local<a name='2233'></font>
  INTEGER :: IZ<a name='2234'>
  REAL    :: BDSNOW  <font color=#447700>!bulk density of snow (kg/m3)<a name='2235'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2236'></font>
   SNOFLOW = 0.0<a name='2237'>
   PONDING1 = 0.0<a name='2238'>
   PONDING2 = 0.0<a name='2239'>
<a name='2240'>
   CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWFALL_GLACIER'>SNOWFALL_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWWATER_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWFALL_GLACIER_1"> (NSOIL  ,NSNOW  ,DT     ,QSNOW  ,SNOWHIN, &amp; <font color=#447700>!in<a name='2241'></font>
                          SFCTMP ,                                 &amp; <font color=#447700>!in<a name='2242'></font>
                          ISNOW  ,SNOWH  ,DZSNSO ,STC    ,SNICE  , &amp; <font color=#447700>!inout<a name='2243'></font>
                          SNLIQ  ,SNEQV  )                           <font color=#447700>!inout<a name='2244'></font>
<a name='2245'>
   IF(ISNOW &lt; 0) THEN        <font color=#447700>!WHEN MORE THAN ONE LAYER<a name='2246'></font>
     CALL  <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#COMPACT_GLACIER'>COMPACT_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWWATER_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPACT_GLACIER_1"> (NSNOW  ,NSOIL  ,DT     ,STC    ,SNICE  , &amp; <font color=#447700>!in<a name='2247'></font>
                            SNLIQ  ,IMELT  ,FICEOLD,                 &amp; <font color=#447700>!in<a name='2248'></font>
                            ISNOW  ,DZSNSO )                           <font color=#447700>!inout<a name='2249'></font>
<a name='2250'>
     CALL  <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#COMBINE_GLACIER'>COMBINE_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWWATER_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMBINE_GLACIER_1"> (NSNOW  ,NSOIL  ,                         &amp; <font color=#447700>!in<a name='2251'></font>
                            ISNOW  ,SH2O   ,STC    ,SNICE  ,SNLIQ  , &amp; <font color=#447700>!inout<a name='2252'></font>
                            DZSNSO ,SICE   ,SNOWH  ,SNEQV  ,         &amp; <font color=#447700>!inout<a name='2253'></font>
                            PONDING1       ,PONDING2)                  <font color=#447700>!out<a name='2254'></font>
<a name='2255'>
     CALL   <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#DIVIDE_GLACIER'>DIVIDE_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWWATER_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIVIDE_GLACIER_1"> (NSNOW  ,NSOIL  ,                         &amp; <font color=#447700>!in<a name='2256'></font>
                            ISNOW  ,STC    ,SNICE  ,SNLIQ  ,DZSNSO )   <font color=#447700>!inout<a name='2257'></font>
   END IF<a name='2258'>
<a name='2259'>
<font color=#447700>!SET EMPTY SNOW LAYERS TO ZERO<a name='2260'></font>
<a name='2261'>
   DO IZ = -NSNOW+1, ISNOW<a name='2262'>
        SNICE(IZ) = 0.<a name='2263'>
        SNLIQ(IZ) = 0.<a name='2264'>
        STC(IZ)   = 0.<a name='2265'>
        DZSNSO(IZ)= 0.<a name='2266'>
        ZSNSO(IZ) = 0.<a name='2267'>
   ENDDO<a name='2268'>
<a name='2269'>
   CALL  <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWH2O_GLACIER'>SNOWH2O_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWWATER_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWH2O_GLACIER_1"> (NSNOW  ,NSOIL  ,DT     ,QSNFRO ,QSNSUB , &amp; <font color=#447700>!in <a name='2270'></font>
                          QRAIN  ,                                 &amp; <font color=#447700>!in<a name='2271'></font>
                          ISNOW  ,DZSNSO ,SNOWH  ,SNEQV  ,SNICE  , &amp; <font color=#447700>!inout<a name='2272'></font>
                          SNLIQ  ,SH2O   ,SICE   ,STC    ,         &amp; <font color=#447700>!inout<a name='2273'></font>
			  PONDING1       ,PONDING2       ,FSH    , &amp; <font color=#447700>!inout<a name='2274'></font>
                          QSNBOT )                                   <font color=#447700>!out<a name='2275'></font>
<a name='2276'>
<font color=#447700>!to obtain equilibrium state of snow in glacier region<a name='2277'></font>
       <a name='2278'>
   IF(SNEQV &gt; 2000.) THEN   <font color=#447700>! 2000 mm -&gt; maximum water depth<a name='2279'></font>
      BDSNOW      = SNICE(0) / DZSNSO(0)<a name='2280'>
      SNOFLOW     = (SNEQV - 2000.)<a name='2281'>
      SNICE(0)    = SNICE(0)  - SNOFLOW <a name='2282'>
      DZSNSO(0)   = DZSNSO(0) - SNOFLOW/BDSNOW<a name='2283'>
      SNOFLOW     = SNOFLOW / DT<a name='2284'>
   END IF<a name='2285'>
<a name='2286'>
<font color=#447700>! sum up snow mass for layered snow<a name='2287'></font>
<a name='2288'>
   IF(ISNOW /= 0) THEN<a name='2289'>
       SNEQV = 0.<a name='2290'>
       DO IZ = ISNOW+1,0<a name='2291'>
             SNEQV = SNEQV + SNICE(IZ) + SNLIQ(IZ)<a name='2292'>
       ENDDO<a name='2293'>
   END IF<a name='2294'>
<a name='2295'>
<font color=#447700>! Reset ZSNSO and layer thinkness DZSNSO<a name='2296'></font>
<a name='2297'>
   DO IZ = ISNOW+1, 0<a name='2298'>
        DZSNSO(IZ) = -DZSNSO(IZ)<a name='2299'>
   END DO<a name='2300'>
<a name='2301'>
   DZSNSO(1) = ZSOIL(1)<a name='2302'>
   DO IZ = 2,NSOIL<a name='2303'>
        DZSNSO(IZ) = (ZSOIL(IZ) - ZSOIL(IZ-1))<a name='2304'>
   END DO<a name='2305'>
<a name='2306'>
   ZSNSO(ISNOW+1) = DZSNSO(ISNOW+1)<a name='2307'>
   DO IZ = ISNOW+2 ,NSOIL<a name='2308'>
       ZSNSO(IZ) = ZSNSO(IZ-1) + DZSNSO(IZ)<a name='2309'>
   ENDDO<a name='2310'>
<a name='2311'>
   DO IZ = ISNOW+1 ,NSOIL<a name='2312'>
       DZSNSO(IZ) = -DZSNSO(IZ)<a name='2313'>
   END DO<a name='2314'>
<a name='2315'>
  END SUBROUTINE SNOWWATER_GLACIER<a name='2316'>
<font color=#447700>! ==================================================================================================<a name='2317'></font>
<A NAME='SNOWFALL_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWFALL_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2318'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWFALL_GLACIER</font> (NSOIL  ,NSNOW  ,DT     ,QSNOW  ,SNOWHIN , &amp; <font color=#447700>!in <A href='../../call_to/SNOWFALL_GLACIER.html' TARGET='index'>1</A><a name='2319'></font>
                               SFCTMP ,                                  &amp; <font color=#447700>!in<a name='2320'></font>
                               ISNOW  ,SNOWH  ,DZSNSO ,STC    ,SNICE   , &amp; <font color=#447700>!inout<a name='2321'></font>
                               SNLIQ  ,SNEQV  )                            <font color=#447700>!inout<a name='2322'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2323'></font>
<font color=#447700>! snow depth and density to account for the new snowfall.<a name='2324'></font>
<font color=#447700>! new values of snow depth &amp; density returned.<a name='2325'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2326'></font>
    IMPLICIT NONE<a name='2327'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2328'></font>
<font color=#447700>! input<a name='2329'></font>
<a name='2330'>
  INTEGER,                            INTENT(IN) :: NSOIL  <font color=#447700>!no. of soil layers<a name='2331'></font>
  INTEGER,                            INTENT(IN) :: NSNOW  <font color=#447700>!maximum no. of snow layers<a name='2332'></font>
  REAL,                               INTENT(IN) :: DT     <font color=#447700>!main time step (s)<a name='2333'></font>
  REAL,                               INTENT(IN) :: QSNOW  <font color=#447700>!snow at ground srf (mm/s) [+]<a name='2334'></font>
  REAL,                               INTENT(IN) :: SNOWHIN<font color=#447700>!snow depth increasing rate (m/s)<a name='2335'></font>
  REAL,                               INTENT(IN) :: SFCTMP <font color=#447700>!surface air temperature [k]<a name='2336'></font>
<a name='2337'>
<font color=#447700>! input and output<a name='2338'></font>
<a name='2339'>
  INTEGER,                         INTENT(INOUT) :: ISNOW  <font color=#447700>!actual no. of snow layers<a name='2340'></font>
  REAL,                            INTENT(INOUT) :: SNOWH  <font color=#447700>!snow depth [m]<a name='2341'></font>
  REAL,                            INTENT(INOUT) :: SNEQV  <font color=#447700>!swow water equivalent [m]<a name='2342'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: DZSNSO <font color=#447700>!thickness of snow/soil layers (m)<a name='2343'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC    <font color=#447700>!snow layer temperature [k]<a name='2344'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNICE  <font color=#447700>!snow layer ice [mm]<a name='2345'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNLIQ  <font color=#447700>!snow layer liquid water [mm]<a name='2346'></font>
<a name='2347'>
<font color=#447700>! local<a name='2348'></font>
<a name='2349'>
  INTEGER :: NEWNODE            <font color=#447700>! 0-no new layers, 1-creating new layers<a name='2350'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2351'></font>
    NEWNODE  = 0<a name='2352'>
<a name='2353'>
<font color=#447700>! shallow snow / no layer<a name='2354'></font>
<a name='2355'>
    IF(ISNOW == 0 .and. QSNOW &gt; 0.)  THEN<a name='2356'>
      SNOWH = SNOWH + SNOWHIN * DT<a name='2357'>
      SNEQV = SNEQV + QSNOW * DT<a name='2358'>
    END IF<a name='2359'>
<a name='2360'>
<font color=#447700>! creating a new layer<a name='2361'></font>
 <a name='2362'>
    IF(ISNOW == 0  .AND. QSNOW&gt;0. .AND. SNOWH &gt;= 0.05) THEN<a name='2363'>
      ISNOW    = -1<a name='2364'>
      NEWNODE  =  1<a name='2365'>
      DZSNSO(0)= SNOWH<a name='2366'>
      SNOWH    = 0.<a name='2367'>
      STC(0)   = MIN(273.16, SFCTMP)   <font color=#447700>! temporary setup<a name='2368'></font>
      SNICE(0) = SNEQV<a name='2369'>
      SNLIQ(0) = 0.<a name='2370'>
    END IF<a name='2371'>
<a name='2372'>
<font color=#447700>! snow with layers<a name='2373'></font>
<a name='2374'>
    IF(ISNOW &lt;  0 .AND. NEWNODE == 0 .AND. QSNOW &gt; 0.) then<a name='2375'>
         SNICE(ISNOW+1)  = SNICE(ISNOW+1)   + QSNOW   * DT<a name='2376'>
         DZSNSO(ISNOW+1) = DZSNSO(ISNOW+1)  + SNOWHIN * DT<a name='2377'>
    ENDIF<a name='2378'>
<a name='2379'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2380'></font>
  END SUBROUTINE SNOWFALL_GLACIER<a name='2381'>
<font color=#447700>! ==================================================================================================<a name='2382'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2383'></font>
<A NAME='COMPACT_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#COMPACT_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2384'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>COMPACT_GLACIER</font> (NSNOW  ,NSOIL  ,DT     ,STC    ,SNICE , &amp; <font color=#447700>!in <A href='../../call_to/COMPACT_GLACIER.html' TARGET='index'>1</A><a name='2385'></font>
                              SNLIQ  ,IMELT  ,FICEOLD,                &amp; <font color=#447700>!in<a name='2386'></font>
                              ISNOW  ,DZSNSO )                          <font color=#447700>!inout<a name='2387'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2388'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2389'></font>
  IMPLICIT NONE<a name='2390'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2391'></font>
<font color=#447700>! input<a name='2392'></font>
   INTEGER,                         INTENT(IN)    :: NSOIL  <font color=#447700>!no. of soil layers [ =4]<a name='2393'></font>
   INTEGER,                         INTENT(IN)    :: NSNOW  <font color=#447700>!maximum no. of snow layers [ =3]<a name='2394'></font>
   INTEGER, DIMENSION(-NSNOW+1:0) , INTENT(IN)    :: IMELT  <font color=#447700>!melting state index [0-no melt;1-melt]<a name='2395'></font>
   REAL,                            INTENT(IN)    :: DT     <font color=#447700>!time step (sec)<a name='2396'></font>
   REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)    :: STC    <font color=#447700>!snow layer temperature [k]<a name='2397'></font>
   REAL, DIMENSION(-NSNOW+1:    0), INTENT(IN)    :: SNICE  <font color=#447700>!snow layer ice [mm]<a name='2398'></font>
   REAL, DIMENSION(-NSNOW+1:    0), INTENT(IN)    :: SNLIQ  <font color=#447700>!snow layer liquid water [mm]<a name='2399'></font>
   REAL, DIMENSION(-NSNOW+1:    0), INTENT(IN)    :: FICEOLD<font color=#447700>!ice fraction at last timestep<a name='2400'></font>
<a name='2401'>
<font color=#447700>! input and output<a name='2402'></font>
   INTEGER,                         INTENT(INOUT) :: ISNOW  <font color=#447700>! actual no. of snow layers<a name='2403'></font>
   REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: DZSNSO <font color=#447700>! snow layer thickness [m]<a name='2404'></font>
<a name='2405'>
<font color=#447700>! local<a name='2406'></font>
   REAL, PARAMETER     :: C2 = 21.e-3   <font color=#447700>![m3/kg] ! default 21.e-3<a name='2407'></font>
   REAL, PARAMETER     :: C3 = 2.5e-6   <font color=#447700>![1/s]  <a name='2408'></font>
   REAL, PARAMETER     :: C4 = 0.04     <font color=#447700>![1/k]<a name='2409'></font>
   REAL, PARAMETER     :: C5 = 2.0      <font color=#447700>!<a name='2410'></font>
   REAL, PARAMETER     :: DM = 100.0    <font color=#447700>!upper Limit on destructive metamorphism compaction [kg/m3]<a name='2411'></font>
   REAL, PARAMETER     :: ETA0 = 0.8e+6 <font color=#447700>!viscosity coefficient [kg-s/m2] <a name='2412'></font>
                                        <font color=#447700>!according to Anderson, it is between 0.52e6~1.38e6<a name='2413'></font>
   REAL :: BURDEN <font color=#447700>!pressure of overlying snow [kg/m2]<a name='2414'></font>
   REAL :: DDZ1   <font color=#447700>!rate of settling of snow pack due to destructive metamorphism.<a name='2415'></font>
   REAL :: DDZ2   <font color=#447700>!rate of compaction of snow pack due to overburden.<a name='2416'></font>
   REAL :: DDZ3   <font color=#447700>!rate of compaction of snow pack due to melt [1/s]<a name='2417'></font>
   REAL :: DEXPF  <font color=#447700>!EXPF=exp(-c4*(273.15-STC)).<a name='2418'></font>
   REAL :: TD     <font color=#447700>!STC - TFRZ [K]<a name='2419'></font>
   REAL :: PDZDTC <font color=#447700>!nodal rate of change in fractional-thickness due to compaction [fraction/s]<a name='2420'></font>
   REAL :: VOID   <font color=#447700>!void (1 - SNICE - SNLIQ)<a name='2421'></font>
   REAL :: WX     <font color=#447700>!water mass (ice + liquid) [kg/m2]<a name='2422'></font>
   REAL :: BI     <font color=#447700>!partial density of ice [kg/m3]<a name='2423'></font>
   REAL, DIMENSION(-NSNOW+1:0) :: FICE   <font color=#447700>!fraction of ice at current time step<a name='2424'></font>
<a name='2425'>
   INTEGER  :: J<a name='2426'>
<a name='2427'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2428'></font>
    BURDEN = 0.0<a name='2429'>
<a name='2430'>
    DO J = ISNOW+1, 0<a name='2431'>
<a name='2432'>
        WX      = SNICE(J) + SNLIQ(J)<a name='2433'>
        FICE(J) = SNICE(J) / WX<a name='2434'>
        VOID    = 1. - (SNICE(J)/DENICE + SNLIQ(J)/DENH2O) / DZSNSO(J)<a name='2435'>
<a name='2436'>
        <font color=#447700>! Allow compaction only for non-saturated node and higher ice lens node.<a name='2437'></font>
        IF (VOID &gt; 0.001 .AND. SNICE(J) &gt; 0.1) THEN<a name='2438'>
           BI = SNICE(J) / DZSNSO(J)<a name='2439'>
           TD = MAX(0.,TFRZ-STC(J))<a name='2440'>
           DEXPF = EXP(-C4*TD)<a name='2441'>
<a name='2442'>
           <font color=#447700>! Settling as a result of destructive metamorphism<a name='2443'></font>
<a name='2444'>
           DDZ1 = -C3*DEXPF<a name='2445'>
<a name='2446'>
           IF (BI &gt; DM) DDZ1 = DDZ1*EXP(-46.0E-3*(BI-DM))<a name='2447'>
<a name='2448'>
           <font color=#447700>! Liquid water term<a name='2449'></font>
<a name='2450'>
           IF (SNLIQ(J) &gt; 0.01*DZSNSO(J)) DDZ1=DDZ1*C5<a name='2451'>
<a name='2452'>
           <font color=#447700>! Compaction due to overburden<a name='2453'></font>
<a name='2454'>
           DDZ2 = -(BURDEN+0.5*WX)*EXP(-0.08*TD-C2*BI)/ETA0 <font color=#447700>! 0.5*WX -&gt; self-burden<a name='2455'></font>
<a name='2456'>
           <font color=#447700>! Compaction occurring during melt<a name='2457'></font>
<a name='2458'>
           IF (IMELT(J) == 1) THEN<a name='2459'>
              DDZ3 = MAX(0.,(FICEOLD(J) - FICE(J))/MAX(1.E-6,FICEOLD(J)))<a name='2460'>
              DDZ3 = - DDZ3/DT           <font color=#447700>! sometimes too large<a name='2461'></font>
           ELSE<a name='2462'>
              DDZ3 = 0.<a name='2463'>
           END IF<a name='2464'>
<a name='2465'>
           <font color=#447700>! Time rate of fractional change in DZ (units of s-1)<a name='2466'></font>
<a name='2467'>
           PDZDTC = (DDZ1 + DDZ2 + DDZ3)*DT<a name='2468'>
           PDZDTC = MAX(-0.5,PDZDTC)<a name='2469'>
<a name='2470'>
           <font color=#447700>! The change in DZ due to compaction<a name='2471'></font>
<a name='2472'>
           DZSNSO(J) = DZSNSO(J)*(1.+PDZDTC)<a name='2473'>
        END IF<a name='2474'>
<a name='2475'>
        <font color=#447700>! Pressure of overlying snow<a name='2476'></font>
<a name='2477'>
        BURDEN = BURDEN + WX<a name='2478'>
<a name='2479'>
    END DO<a name='2480'>
<a name='2481'>
  END SUBROUTINE COMPACT_GLACIER<a name='2482'>
<font color=#447700>! ==================================================================================================<a name='2483'></font>
<A NAME='COMBINE_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#COMBINE_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2484'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>COMBINE_GLACIER</font> (NSNOW  ,NSOIL  ,                         &amp; <font color=#447700>!in <A href='../../call_to/COMBINE_GLACIER.html' TARGET='index'>2</A>,<A href='../../call_from/COMBINE_GLACIER.html' TARGET='index'>1</A><a name='2485'></font>
                              ISNOW  ,SH2O   ,STC    ,SNICE  ,SNLIQ  , &amp; <font color=#447700>!inout<a name='2486'></font>
                              DZSNSO ,SICE   ,SNOWH  ,SNEQV  ,         &amp; <font color=#447700>!inout<a name='2487'></font>
                              PONDING1       ,PONDING2)                  <font color=#447700>!inout<a name='2488'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2489'></font>
    IMPLICIT NONE<a name='2490'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2491'></font>
<font color=#447700>! input<a name='2492'></font>
<a name='2493'>
    INTEGER, INTENT(IN)     :: NSNOW                        <font color=#447700>!maximum no. of snow layers<a name='2494'></font>
    INTEGER, INTENT(IN)     :: NSOIL                        <font color=#447700>!no. of soil layers<a name='2495'></font>
<a name='2496'>
<font color=#447700>! input and output<a name='2497'></font>
<a name='2498'>
    INTEGER,                         INTENT(INOUT) :: ISNOW <font color=#447700>!actual no. of snow layers<a name='2499'></font>
    REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SH2O  <font color=#447700>!soil liquid moisture (m3/m3)<a name='2500'></font>
    REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SICE  <font color=#447700>!soil ice moisture (m3/m3)<a name='2501'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC   <font color=#447700>!snow layer temperature [k]<a name='2502'></font>
    REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNICE <font color=#447700>!snow layer ice [mm]<a name='2503'></font>
    REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNLIQ <font color=#447700>!snow layer liquid water [mm]<a name='2504'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: DZSNSO<font color=#447700>!snow layer depth [m]<a name='2505'></font>
    REAL,                            INTENT(INOUT) :: SNEQV <font color=#447700>!snow water equivalent [m]<a name='2506'></font>
    REAL,                            INTENT(INOUT) :: SNOWH <font color=#447700>!snow depth [m]<a name='2507'></font>
    REAL,                            INTENT(INOUT) :: PONDING1<a name='2508'>
    REAL,                            INTENT(INOUT) :: PONDING2<a name='2509'>
<a name='2510'>
<font color=#447700>! local variables:<a name='2511'></font>
<a name='2512'>
    INTEGER :: I,J,K,L               <font color=#447700>! node indices<a name='2513'></font>
    INTEGER :: ISNOW_OLD             <font color=#447700>! number of top snow layer<a name='2514'></font>
    INTEGER :: MSSI                  <font color=#447700>! node index<a name='2515'></font>
    INTEGER :: NEIBOR                <font color=#447700>! adjacent node selected for combination<a name='2516'></font>
    REAL    :: ZWICE                 <font color=#447700>! total ice mass in snow<a name='2517'></font>
    REAL    :: ZWLIQ                 <font color=#447700>! total liquid water in snow<a name='2518'></font>
    REAL    :: DZMIN(3)              <font color=#447700>! minimum of top snow layer<a name='2519'></font>
    DATA DZMIN /0.045, 0.05, 0.2/<a name='2520'>
<font color=#447700>!    DATA DZMIN /0.025, 0.025, 0.1/  ! MB: change limit<a name='2521'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2522'></font>
<a name='2523'>
       ISNOW_OLD = ISNOW<a name='2524'>
<a name='2525'>
       DO J = ISNOW_OLD+1,0<a name='2526'>
          IF (SNICE(J) &lt;= .1) THEN<a name='2527'>
             IF(J /= 0) THEN<a name='2528'>
                SNLIQ(J+1) = SNLIQ(J+1) + SNLIQ(J)<a name='2529'>
                SNICE(J+1) = SNICE(J+1) + SNICE(J)<a name='2530'>
             ELSE<a name='2531'>
               IF (ISNOW_OLD &lt; -1) THEN<a name='2532'>
                SNLIQ(J-1) = SNLIQ(J-1) + SNLIQ(J)<a name='2533'>
                SNICE(J-1) = SNICE(J-1) + SNICE(J)<a name='2534'>
               ELSE<a name='2535'>
                PONDING1 = PONDING1 + SNLIQ(J)       <font color=#447700>! ISNOW WILL GET SET TO ZERO BELOW<a name='2536'></font>
                SNEQV = SNICE(J)                     <font color=#447700>! PONDING WILL GET ADDED TO PONDING FROM<a name='2537'></font>
                SNOWH = DZSNSO(J)                    <font color=#447700>! PHASECHANGE WHICH SHOULD BE ZERO HERE<a name='2538'></font>
                SNLIQ(J) = 0.0                       <font color=#447700>! BECAUSE THERE IT WAS ONLY CALCULATED<a name='2539'></font>
                SNICE(J) = 0.0                       <font color=#447700>! FOR THIN SNOW<a name='2540'></font>
                DZSNSO(J) = 0.0<a name='2541'>
               ENDIF<a name='2542'>
<font color=#447700>!                SH2O(1) = SH2O(1)+SNLIQ(J)/(DZSNSO(1)*1000.)<a name='2543'></font>
<font color=#447700>!                SICE(1) = SICE(1)+SNICE(J)/(DZSNSO(1)*1000.)<a name='2544'></font>
             ENDIF<a name='2545'>
<a name='2546'>
             <font color=#447700>! shift all elements above this down by one.<a name='2547'></font>
             IF (J &gt; ISNOW+1 .AND. ISNOW &lt; -1) THEN<a name='2548'>
                DO I = J, ISNOW+2, -1<a name='2549'>
                   STC(I)   = STC(I-1)<a name='2550'>
                   SNLIQ(I) = SNLIQ(I-1)<a name='2551'>
                   SNICE(I) = SNICE(I-1)<a name='2552'>
                   DZSNSO(I)= DZSNSO(I-1)<a name='2553'>
                END DO<a name='2554'>
             END IF<a name='2555'>
             ISNOW = ISNOW + 1<a name='2556'>
          END IF<a name='2557'>
       END DO<a name='2558'>
<a name='2559'>
<font color=#447700>! to conserve water in case of too large surface sublimation<a name='2560'></font>
<a name='2561'>
       IF(SICE(1) &lt; 0.) THEN<a name='2562'>
          SH2O(1) = SH2O(1) + SICE(1)<a name='2563'>
          SICE(1) = 0.<a name='2564'>
       END IF<a name='2565'>
<a name='2566'>
       IF(ISNOW ==0) RETURN   <font color=#447700>! MB: get out if no longer multi-layer<a name='2567'></font>
<a name='2568'>
       SNEQV  = 0.<a name='2569'>
       SNOWH  = 0.<a name='2570'>
       ZWICE  = 0.<a name='2571'>
       ZWLIQ  = 0.<a name='2572'>
<a name='2573'>
       DO J = ISNOW+1,0<a name='2574'>
             SNEQV = SNEQV + SNICE(J) + SNLIQ(J)<a name='2575'>
             SNOWH = SNOWH + DZSNSO(J)<a name='2576'>
             ZWICE = ZWICE + SNICE(J)<a name='2577'>
             ZWLIQ = ZWLIQ + SNLIQ(J)<a name='2578'>
       END DO<a name='2579'>
<a name='2580'>
<font color=#447700>! check the snow depth - all snow gone<a name='2581'></font>
<font color=#447700>! the liquid water assumes ponding on soil surface.<a name='2582'></font>
<a name='2583'>
<font color=#447700>!       IF (SNOWH &lt; 0.025 .AND. ISNOW &lt; 0 ) THEN ! MB: change limit<a name='2584'></font>
       IF (SNOWH &lt; 0.05 .AND. ISNOW &lt; 0 ) THEN<a name='2585'>
          ISNOW  = 0<a name='2586'>
          SNEQV = ZWICE<a name='2587'>
          PONDING2 = PONDING2 + ZWLIQ           <font color=#447700>! LIMIT OF ISNOW &lt; 0 MEANS INPUT PONDING<a name='2588'></font>
          IF(SNEQV &lt;= 0.) SNOWH = 0.            <font color=#447700>! SHOULD BE ZERO; SEE ABOVE<a name='2589'></font>
       END IF<a name='2590'>
<a name='2591'>
<font color=#447700>!       IF (SNOWH &lt; 0.05 ) THEN<a name='2592'></font>
<font color=#447700>!          ISNOW  = 0<a name='2593'></font>
<font color=#447700>!          SNEQV = ZWICE<a name='2594'></font>
<font color=#447700>!          SH2O(1) = SH2O(1) + ZWLIQ / (DZSNSO(1) * 1000.)<a name='2595'></font>
<font color=#447700>!          IF(SNEQV &lt;= 0.) SNOWH = 0.<a name='2596'></font>
<font color=#447700>!       END IF<a name='2597'></font>
<a name='2598'>
<font color=#447700>! check the snow depth - snow layers combined<a name='2599'></font>
<a name='2600'>
       IF (ISNOW &lt; -1) THEN<a name='2601'>
<a name='2602'>
          ISNOW_OLD = ISNOW<a name='2603'>
          MSSI     = 1<a name='2604'>
<a name='2605'>
          DO I = ISNOW_OLD+1,0<a name='2606'>
             IF (DZSNSO(I) &lt; DZMIN(MSSI)) THEN<a name='2607'>
<a name='2608'>
                IF (I == ISNOW+1) THEN<a name='2609'>
                   NEIBOR = I + 1<a name='2610'>
                ELSE IF (I == 0) THEN<a name='2611'>
                   NEIBOR = I - 1<a name='2612'>
                ELSE<a name='2613'>
                   NEIBOR = I + 1<a name='2614'>
                   IF ((DZSNSO(I-1)+DZSNSO(I)) &lt; (DZSNSO(I+1)+DZSNSO(I))) NEIBOR = I-1<a name='2615'>
                END IF<a name='2616'>
<a name='2617'>
                <font color=#447700>! Node l and j are combined and stored as node j.<a name='2618'></font>
                IF (NEIBOR &gt; I) THEN<a name='2619'>
                   J = NEIBOR<a name='2620'>
                   L = I<a name='2621'>
                ELSE<a name='2622'>
                   J = I<a name='2623'>
                   L = NEIBOR<a name='2624'>
                END IF<a name='2625'>
<a name='2626'>
                CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#COMBO_GLACIER'>COMBO_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#COMBINE_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMBO_GLACIER_1"> (DZSNSO(J), SNLIQ(J), SNICE(J), &amp;<a name='2627'>
                   STC(J), DZSNSO(L), SNLIQ(L), SNICE(L), STC(L) )<a name='2628'>
<a name='2629'>
                <font color=#447700>! Now shift all elements above this down one.<a name='2630'></font>
                IF (J-1 &gt; ISNOW+1) THEN<a name='2631'>
                   DO K = J-1, ISNOW+2, -1<a name='2632'>
                      STC(K)   = STC(K-1)<a name='2633'>
                      SNICE(K) = SNICE(K-1)<a name='2634'>
                      SNLIQ(K) = SNLIQ(K-1)<a name='2635'>
                      DZSNSO(K) = DZSNSO(K-1)<a name='2636'>
                   END DO<a name='2637'>
                END IF<a name='2638'>
<a name='2639'>
                <font color=#447700>! Decrease the number of snow layers<a name='2640'></font>
                ISNOW = ISNOW + 1<a name='2641'>
                IF (ISNOW &gt;= -1) EXIT<a name='2642'>
             ELSE<a name='2643'>
<a name='2644'>
                <font color=#447700>! The layer thickness is greater than the prescribed minimum value<a name='2645'></font>
                MSSI = MSSI + 1<a name='2646'>
<a name='2647'>
             END IF<a name='2648'>
          END DO<a name='2649'>
<a name='2650'>
       END IF<a name='2651'>
<a name='2652'>
  END SUBROUTINE COMBINE_GLACIER<a name='2653'>
<font color=#447700>! ==================================================================================================<a name='2654'></font>
<a name='2655'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2656'></font>
<A NAME='COMBO_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#COMBO_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2657'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>COMBO_GLACIER</font>(DZ,  WLIQ,  WICE, T, DZ2, WLIQ2, WICE2, T2) <A href='../../call_to/COMBO_GLACIER.html' TARGET='index'>3</A><a name='2658'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2659'></font>
    IMPLICIT NONE<a name='2660'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2661'></font>
<a name='2662'>
<font color=#447700>! ----------------------------------------------------------------------s<a name='2663'></font>
<font color=#447700>! input<a name='2664'></font>
<a name='2665'>
    REAL, INTENT(IN)    :: DZ2   <font color=#447700>!nodal thickness of 2 elements being combined [m]<a name='2666'></font>
    REAL, INTENT(IN)    :: WLIQ2 <font color=#447700>!liquid water of element 2 [kg/m2]<a name='2667'></font>
    REAL, INTENT(IN)    :: WICE2 <font color=#447700>!ice of element 2 [kg/m2]<a name='2668'></font>
    REAL, INTENT(IN)    :: T2    <font color=#447700>!nodal temperature of element 2 [k]<a name='2669'></font>
    REAL, INTENT(INOUT) :: DZ    <font color=#447700>!nodal thickness of 1 elements being combined [m]<a name='2670'></font>
    REAL, INTENT(INOUT) :: WLIQ  <font color=#447700>!liquid water of element 1<a name='2671'></font>
    REAL, INTENT(INOUT) :: WICE  <font color=#447700>!ice of element 1 [kg/m2]<a name='2672'></font>
    REAL, INTENT(INOUT) :: T     <font color=#447700>!node temperature of element 1 [k]<a name='2673'></font>
<a name='2674'>
<font color=#447700>! local <a name='2675'></font>
<a name='2676'>
    REAL                :: DZC   <font color=#447700>!total thickness of nodes 1 and 2 (DZC=DZ+DZ2).<a name='2677'></font>
    REAL                :: WLIQC <font color=#447700>!combined liquid water [kg/m2]<a name='2678'></font>
    REAL                :: WICEC <font color=#447700>!combined ice [kg/m2]<a name='2679'></font>
    REAL                :: TC    <font color=#447700>!combined node temperature [k]<a name='2680'></font>
    REAL                :: H     <font color=#447700>!enthalpy of element 1 [J/m2]<a name='2681'></font>
    REAL                :: H2    <font color=#447700>!enthalpy of element 2 [J/m2]<a name='2682'></font>
    REAL                :: HC    <font color=#447700>!temporary<a name='2683'></font>
<a name='2684'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2685'></font>
<a name='2686'>
    DZC = DZ+DZ2<a name='2687'>
    WICEC = (WICE+WICE2)<a name='2688'>
    WLIQC = (WLIQ+WLIQ2)<a name='2689'>
    H = (CICE*WICE+CWAT*WLIQ) * (T-TFRZ)+HFUS*WLIQ<a name='2690'>
    H2= (CICE*WICE2+CWAT*WLIQ2) * (T2-TFRZ)+HFUS*WLIQ2<a name='2691'>
<a name='2692'>
    HC = H + H2<a name='2693'>
    IF(HC &lt; 0.)THEN<a name='2694'>
       TC = TFRZ + HC/(CICE*WICEC + CWAT*WLIQC)<a name='2695'>
    ELSE IF (HC.LE.HFUS*WLIQC) THEN<a name='2696'>
       TC = TFRZ<a name='2697'>
    ELSE<a name='2698'>
       TC = TFRZ + (HC - HFUS*WLIQC) / (CICE*WICEC + CWAT*WLIQC)<a name='2699'>
    END IF<a name='2700'>
<a name='2701'>
    DZ = DZC<a name='2702'>
    WICE = WICEC<a name='2703'>
    WLIQ = WLIQC<a name='2704'>
    T = TC<a name='2705'>
<a name='2706'>
  END SUBROUTINE COMBO_GLACIER<a name='2707'>
<font color=#447700>! ==================================================================================================<a name='2708'></font>
<A NAME='DIVIDE_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#DIVIDE_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2709'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>DIVIDE_GLACIER</font> (NSNOW  ,NSOIL  ,                         &amp; <font color=#447700>!in <A href='../../call_to/DIVIDE_GLACIER.html' TARGET='index'>1</A>,<A href='../../call_from/DIVIDE_GLACIER.html' TARGET='index'>2</A><a name='2710'></font>
                             ISNOW  ,STC    ,SNICE  ,SNLIQ  ,DZSNSO  )  <font color=#447700>!inout<a name='2711'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2712'></font>
    IMPLICIT NONE<a name='2713'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2714'></font>
<font color=#447700>! input<a name='2715'></font>
<a name='2716'>
    INTEGER, INTENT(IN)                            :: NSNOW <font color=#447700>!maximum no. of snow layers [ =3]<a name='2717'></font>
    INTEGER, INTENT(IN)                            :: NSOIL <font color=#447700>!no. of soil layers [ =4]<a name='2718'></font>
<a name='2719'>
<font color=#447700>! input and output<a name='2720'></font>
<a name='2721'>
    INTEGER                        , INTENT(INOUT) :: ISNOW <font color=#447700>!actual no. of snow layers <a name='2722'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC   <font color=#447700>!snow layer temperature [k]<a name='2723'></font>
    REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNICE <font color=#447700>!snow layer ice [mm]<a name='2724'></font>
    REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNLIQ <font color=#447700>!snow layer liquid water [mm]<a name='2725'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: DZSNSO<font color=#447700>!snow layer depth [m]<a name='2726'></font>
<a name='2727'>
<font color=#447700>! local variables:<a name='2728'></font>
<a name='2729'>
    INTEGER                                        :: J     <font color=#447700>!indices<a name='2730'></font>
    INTEGER                                        :: MSNO  <font color=#447700>!number of layer (top) to MSNO (bot)<a name='2731'></font>
    REAL                                           :: DRR   <font color=#447700>!thickness of the combined [m]<a name='2732'></font>
    REAL, DIMENSION(       1:NSNOW)                :: DZ    <font color=#447700>!snow layer thickness [m]<a name='2733'></font>
    REAL, DIMENSION(       1:NSNOW)                :: SWICE <font color=#447700>!partial volume of ice [m3/m3]<a name='2734'></font>
    REAL, DIMENSION(       1:NSNOW)                :: SWLIQ <font color=#447700>!partial volume of liquid water [m3/m3]<a name='2735'></font>
    REAL, DIMENSION(       1:NSNOW)                :: TSNO  <font color=#447700>!node temperature [k]<a name='2736'></font>
    REAL                                           :: ZWICE <font color=#447700>!temporary<a name='2737'></font>
    REAL                                           :: ZWLIQ <font color=#447700>!temporary<a name='2738'></font>
    REAL                                           :: PROPOR<font color=#447700>!temporary<a name='2739'></font>
    REAL                                           :: DTDZ  <font color=#447700>!temporary<a name='2740'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2741'></font>
<a name='2742'>
    DO J = 1,NSNOW<a name='2743'>
          IF (J &lt;= ABS(ISNOW)) THEN<a name='2744'>
             DZ(J)    = DZSNSO(J+ISNOW)<a name='2745'>
             SWICE(J) = SNICE(J+ISNOW)<a name='2746'>
             SWLIQ(J) = SNLIQ(J+ISNOW)<a name='2747'>
             TSNO(J)  = STC(J+ISNOW)<a name='2748'>
          END IF<a name='2749'>
    END DO<a name='2750'>
<a name='2751'>
       MSNO = ABS(ISNOW)<a name='2752'>
<a name='2753'>
       IF (MSNO == 1) THEN<a name='2754'>
          <font color=#447700>! Specify a new snow layer<a name='2755'></font>
          IF (DZ(1) &gt; 0.05) THEN<a name='2756'>
             MSNO = 2<a name='2757'>
             DZ(1)    = DZ(1)/2.<a name='2758'>
             SWICE(1) = SWICE(1)/2.<a name='2759'>
             SWLIQ(1) = SWLIQ(1)/2.<a name='2760'>
             DZ(2)    = DZ(1)<a name='2761'>
             SWICE(2) = SWICE(1)<a name='2762'>
             SWLIQ(2) = SWLIQ(1)<a name='2763'>
             TSNO(2)  = TSNO(1)<a name='2764'>
          END IF<a name='2765'>
       END IF<a name='2766'>
<a name='2767'>
       IF (MSNO &gt; 1) THEN<a name='2768'>
          IF (DZ(1) &gt; 0.05) THEN<a name='2769'>
             DRR      = DZ(1) - 0.05<a name='2770'>
             PROPOR   = DRR/DZ(1)<a name='2771'>
             ZWICE    = PROPOR*SWICE(1)<a name='2772'>
             ZWLIQ    = PROPOR*SWLIQ(1)<a name='2773'>
             PROPOR   = 0.05/DZ(1)<a name='2774'>
             SWICE(1) = PROPOR*SWICE(1)<a name='2775'>
             SWLIQ(1) = PROPOR*SWLIQ(1)<a name='2776'>
             DZ(1)    = 0.05<a name='2777'>
<a name='2778'>
             CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#COMBO_GLACIER'>COMBO_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#DIVIDE_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMBO_GLACIER_2"> (DZ(2), SWLIQ(2), SWICE(2), TSNO(2), DRR, &amp;<a name='2779'>
                  ZWLIQ, ZWICE, TSNO(1))<a name='2780'>
<a name='2781'>
             <font color=#447700>! subdivide a new layer<a name='2782'></font>
<font color=#447700>!             IF (MSNO &lt;= 2 .AND. DZ(2) &gt; 0.20) THEN  ! MB: change limit<a name='2783'></font>
             IF (MSNO &lt;= 2 .AND. DZ(2) &gt; 0.10) THEN<a name='2784'>
                MSNO = 3<a name='2785'>
                DTDZ = (TSNO(1) - TSNO(2))/((DZ(1)+DZ(2))/2.)<a name='2786'>
                DZ(2)    = DZ(2)/2.<a name='2787'>
                SWICE(2) = SWICE(2)/2.<a name='2788'>
                SWLIQ(2) = SWLIQ(2)/2.<a name='2789'>
                DZ(3)    = DZ(2)<a name='2790'>
                SWICE(3) = SWICE(2)<a name='2791'>
                SWLIQ(3) = SWLIQ(2)<a name='2792'>
                TSNO(3) = TSNO(2) - DTDZ*DZ(2)/2.<a name='2793'>
                IF (TSNO(3) &gt;= TFRZ) THEN<a name='2794'>
                   TSNO(3)  = TSNO(2)<a name='2795'>
                ELSE<a name='2796'>
                   TSNO(2) = TSNO(2) + DTDZ*DZ(2)/2.<a name='2797'>
                ENDIF<a name='2798'>
<a name='2799'>
             END IF<a name='2800'>
          END IF<a name='2801'>
       END IF<a name='2802'>
<a name='2803'>
       IF (MSNO &gt; 2) THEN<a name='2804'>
          IF (DZ(2) &gt; 0.2) THEN<a name='2805'>
             DRR = DZ(2) - 0.2<a name='2806'>
             PROPOR   = DRR/DZ(2)<a name='2807'>
             ZWICE    = PROPOR*SWICE(2)<a name='2808'>
             ZWLIQ    = PROPOR*SWLIQ(2)<a name='2809'>
             PROPOR   = 0.2/DZ(2)<a name='2810'>
             SWICE(2) = PROPOR*SWICE(2)<a name='2811'>
             SWLIQ(2) = PROPOR*SWLIQ(2)<a name='2812'>
             DZ(2)    = 0.2<a name='2813'>
             CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#COMBO_GLACIER'>COMBO_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#DIVIDE_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMBO_GLACIER_3"> (DZ(3), SWLIQ(3), SWICE(3), TSNO(3), DRR, &amp;<a name='2814'>
                  ZWLIQ, ZWICE, TSNO(2))<a name='2815'>
          END IF<a name='2816'>
       END IF<a name='2817'>
<a name='2818'>
       ISNOW = -MSNO<a name='2819'>
<a name='2820'>
    DO J = ISNOW+1,0<a name='2821'>
             DZSNSO(J) = DZ(J-ISNOW)<a name='2822'>
             SNICE(J) = SWICE(J-ISNOW)<a name='2823'>
             SNLIQ(J) = SWLIQ(J-ISNOW)<a name='2824'>
             STC(J)   = TSNO(J-ISNOW)<a name='2825'>
    END DO<a name='2826'>
<a name='2827'>
<a name='2828'>
<font color=#447700>!    DO J = ISNOW+1,NSOIL<a name='2829'></font>
<font color=#447700>!    WRITE(*,'(I5,7F10.3)') J, DZSNSO(J), SNICE(J), SNLIQ(J),STC(J)<a name='2830'></font>
<font color=#447700>!    END DO<a name='2831'></font>
<a name='2832'>
  END SUBROUTINE DIVIDE_GLACIER<a name='2833'>
<font color=#447700>! ==================================================================================================<a name='2834'></font>
<A NAME='SNOWH2O_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWH2O_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2835'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWH2O_GLACIER</font> (NSNOW  ,NSOIL  ,DT     ,QSNFRO ,QSNSUB , &amp; <font color=#447700>!in  <A href='../../call_to/SNOWH2O_GLACIER.html' TARGET='index'>1</A>,<A href='../../call_from/SNOWH2O_GLACIER.html' TARGET='index'>1</A><a name='2836'></font>
                              QRAIN  ,                                 &amp; <font color=#447700>!in<a name='2837'></font>
                              ISNOW  ,DZSNSO ,SNOWH  ,SNEQV  ,SNICE  , &amp; <font color=#447700>!inout<a name='2838'></font>
                              SNLIQ  ,SH2O   ,SICE   ,STC    ,         &amp; <font color=#447700>!inout<a name='2839'></font>
                              PONDING1       ,PONDING2       ,FSH    , &amp; <font color=#447700>!inout<a name='2840'></font>
                              QSNBOT )                                   <font color=#447700>!out<a name='2841'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2842'></font>
<font color=#447700>! Renew the mass of ice lens (SNICE) and liquid (SNLIQ) of the<a name='2843'></font>
<font color=#447700>! surface snow layer resulting from sublimation (frost) / evaporation (dew)<a name='2844'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2845'></font>
   IMPLICIT NONE<a name='2846'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2847'></font>
<font color=#447700>! input<a name='2848'></font>
<a name='2849'>
   INTEGER,                         INTENT(IN)    :: NSNOW  <font color=#447700>!maximum no. of snow layers[=3]<a name='2850'></font>
   INTEGER,                         INTENT(IN)    :: NSOIL  <font color=#447700>!No. of soil layers[=4]<a name='2851'></font>
   REAL,                            INTENT(IN)    :: DT     <font color=#447700>!time step<a name='2852'></font>
   REAL,                            INTENT(INOUT)    :: QSNFRO <font color=#447700>!snow surface frost rate[mm/s]<a name='2853'></font>
   REAL,                            INTENT(INOUT)    :: QSNSUB <font color=#447700>!snow surface sublimation rate[mm/s]<a name='2854'></font>
   REAL,                            INTENT(IN)    :: QRAIN  <font color=#447700>!snow surface rain rate[mm/s]<a name='2855'></font>
<a name='2856'>
<font color=#447700>! output<a name='2857'></font>
<a name='2858'>
   REAL,                            INTENT(OUT)   :: QSNBOT <font color=#447700>!melting water out of snow bottom [mm/s]<a name='2859'></font>
<a name='2860'>
<font color=#447700>! input and output<a name='2861'></font>
<a name='2862'>
   INTEGER,                         INTENT(INOUT) :: ISNOW  <font color=#447700>!actual no. of snow layers<a name='2863'></font>
   REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: DZSNSO <font color=#447700>! snow layer depth [m]<a name='2864'></font>
   REAL,                            INTENT(INOUT) :: SNOWH  <font color=#447700>!snow height [m]<a name='2865'></font>
   REAL,                            INTENT(INOUT) :: SNEQV  <font color=#447700>!snow water eqv. [mm]<a name='2866'></font>
   REAL, DIMENSION(-NSNOW+1:0),     INTENT(INOUT) :: SNICE  <font color=#447700>!snow layer ice [mm]<a name='2867'></font>
   REAL, DIMENSION(-NSNOW+1:0),     INTENT(INOUT) :: SNLIQ  <font color=#447700>!snow layer liquid water [mm]<a name='2868'></font>
   REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SH2O   <font color=#447700>!soil liquid moisture (m3/m3)<a name='2869'></font>
   REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SICE   <font color=#447700>!soil ice moisture (m3/m3)<a name='2870'></font>
   REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC    <font color=#447700>!snow layer temperature [k]<a name='2871'></font>
   REAL,                            INTENT(INOUT) :: PONDING1<a name='2872'>
   REAL,                            INTENT(INOUT) :: PONDING2<a name='2873'>
   REAL,                            INTENT(INOUT) :: FSH     <font color=#447700>!total sensible heat (w/m2) [+ to atm]<a name='2874'></font>
<a name='2875'>
<font color=#447700>! local variables:<a name='2876'></font>
<a name='2877'>
   INTEGER                     :: J         <font color=#447700>!do loop/array indices<a name='2878'></font>
   REAL                        :: QIN       <font color=#447700>!water flow into the element (mm/s)<a name='2879'></font>
   REAL                        :: QOUT      <font color=#447700>!water flow out of the element (mm/s)<a name='2880'></font>
   REAL                        :: WGDIF     <font color=#447700>!ice mass after minus sublimation<a name='2881'></font>
   REAL, DIMENSION(-NSNOW+1:0) :: VOL_LIQ   <font color=#447700>!partial volume of liquid water in layer<a name='2882'></font>
   REAL, DIMENSION(-NSNOW+1:0) :: VOL_ICE   <font color=#447700>!partial volume of ice lens in layer<a name='2883'></font>
   REAL, DIMENSION(-NSNOW+1:0) :: EPORE     <font color=#447700>!effective porosity = porosity - VOL_ICE<a name='2884'></font>
   REAL :: PROPOR, TEMP<a name='2885'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2886'></font>
<a name='2887'>
<font color=#447700>!for the case when SNEQV becomes '0' after 'COMBINE'<a name='2888'></font>
<a name='2889'>
   IF(SNEQV == 0.) THEN<a name='2890'>
     IF(OPT_GLA == 1) THEN<a name='2891'>
       SICE(1) =  SICE(1) + (QSNFRO-QSNSUB)*DT/(DZSNSO(1)*1000.)<a name='2892'>
     ELSEIF(OPT_GLA == 2) THEN<a name='2893'>
       FSH = FSH - (QSNFRO-QSNSUB)*HSUB<a name='2894'>
       QSNFRO = 0.0<a name='2895'>
       QSNSUB = 0.0<a name='2896'>
     END IF<a name='2897'>
   END IF<a name='2898'>
<a name='2899'>
<font color=#447700>! for shallow snow without a layer<a name='2900'></font>
<font color=#447700>! snow surface sublimation may be larger than existing snow mass. To conserve water,<a name='2901'></font>
<font color=#447700>! excessive sublimation is used to reduce soil water. Smaller time steps would tend <a name='2902'></font>
<font color=#447700>! to aviod this problem.<a name='2903'></font>
<a name='2904'>
   IF(ISNOW == 0 .and. SNEQV &gt; 0.) THEN<a name='2905'>
      IF(OPT_GLA == 1) THEN<a name='2906'>
        TEMP   = SNEQV<a name='2907'>
        SNEQV  = SNEQV - QSNSUB*DT + QSNFRO*DT<a name='2908'>
        PROPOR = SNEQV/TEMP<a name='2909'>
        SNOWH  = MAX(0.,PROPOR * SNOWH)<a name='2910'>
      ELSEIF(OPT_GLA == 2) THEN<a name='2911'>
        FSH = FSH - (QSNFRO-QSNSUB)*HSUB<a name='2912'>
        QSNFRO = 0.0<a name='2913'>
        QSNSUB = 0.0<a name='2914'>
      END IF<a name='2915'>
<a name='2916'>
      IF(SNEQV &lt; 0.) THEN<a name='2917'>
         SICE(1) = SICE(1) + SNEQV/(DZSNSO(1)*1000.)<a name='2918'>
         SNEQV   = 0.<a name='2919'>
         SNOWH   = 0.<a name='2920'>
      END IF<a name='2921'>
      IF(SICE(1) &lt; 0.) THEN<a name='2922'>
         SH2O(1) = SH2O(1) + SICE(1)<a name='2923'>
         SICE(1) = 0.<a name='2924'>
      END IF<a name='2925'>
   END IF<a name='2926'>
<a name='2927'>
   IF(SNOWH &lt;= 1.E-8 .OR. SNEQV &lt;= 1.E-6) THEN<a name='2928'>
     SNOWH = 0.0<a name='2929'>
     SNEQV = 0.0<a name='2930'>
   END IF<a name='2931'>
<a name='2932'>
<font color=#447700>! for deep snow<a name='2933'></font>
<a name='2934'>
   IF ( ISNOW &lt; 0 ) THEN <font color=#447700>!KWM added this IF statement to prevent out-of-bounds array references<a name='2935'></font>
<a name='2936'>
      WGDIF = SNICE(ISNOW+1) - QSNSUB*DT + QSNFRO*DT<a name='2937'>
      SNICE(ISNOW+1) = WGDIF<a name='2938'>
      IF (WGDIF &lt; 1.e-6 .and. ISNOW &lt;0) THEN<a name='2939'>
         CALL  <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#COMBINE_GLACIER'>COMBINE_GLACIER</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#SNOWH2O_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMBINE_GLACIER_2"> (NSNOW  ,NSOIL  ,                         &amp; <font color=#447700>!in<a name='2940'></font>
                                ISNOW  ,SH2O   ,STC    ,SNICE  ,SNLIQ  , &amp; <font color=#447700>!inout<a name='2941'></font>
                                DZSNSO ,SICE   ,SNOWH  ,SNEQV  ,         &amp; <font color=#447700>!inout<a name='2942'></font>
                               PONDING1, PONDING2 )                        <font color=#447700>!inout<a name='2943'></font>
      ENDIF<a name='2944'>
      <font color=#447700>!KWM:  Subroutine COMBINE can change ISNOW to make it 0 again?<a name='2945'></font>
      IF ( ISNOW &lt; 0 ) THEN <font color=#447700>!KWM added this IF statement to prevent out-of-bounds array references<a name='2946'></font>
         SNLIQ(ISNOW+1) = SNLIQ(ISNOW+1) + QRAIN * DT<a name='2947'>
         SNLIQ(ISNOW+1) = MAX(0., SNLIQ(ISNOW+1))<a name='2948'>
      ENDIF<a name='2949'>
      <a name='2950'>
   ENDIF <font color=#447700>!KWM  -- Can the ENDIF be moved toward the end of the subroutine (Just set QSNBOT=0)?<a name='2951'></font>
<a name='2952'>
<font color=#447700>! Porosity and partial volume<a name='2953'></font>
<a name='2954'>
   <font color=#447700>!KWM Looks to me like loop index / IF test can be simplified.<a name='2955'></font>
<a name='2956'>
   DO J = -NSNOW+1, 0<a name='2957'>
      IF (J &gt;= ISNOW+1) THEN<a name='2958'>
         VOL_ICE(J)      = MIN(1., SNICE(J)/(DZSNSO(J)*DENICE))<a name='2959'>
         EPORE(J)        = 1. - VOL_ICE(J)<a name='2960'>
         VOL_LIQ(J)      = MIN(EPORE(J),SNLIQ(J)/(DZSNSO(J)*DENH2O))<a name='2961'>
      END IF<a name='2962'>
   END DO<a name='2963'>
<a name='2964'>
   QIN = 0.<a name='2965'>
   QOUT = 0.<a name='2966'>
<a name='2967'>
   <font color=#447700>!KWM Looks to me like loop index / IF test can be simplified.<a name='2968'></font>
<a name='2969'>
   DO J = -NSNOW+1, 0<a name='2970'>
      IF (J &gt;= ISNOW+1) THEN<a name='2971'>
         SNLIQ(J) = SNLIQ(J) + QIN<a name='2972'>
         IF (J &lt;= -1) THEN<a name='2973'>
            IF (EPORE(J) &lt; 0.05 .OR. EPORE(J+1) &lt; 0.05) THEN<a name='2974'>
               QOUT = 0.<a name='2975'>
            ELSE<a name='2976'>
               QOUT = MAX(0.,(VOL_LIQ(J)-SSI*EPORE(J))*DZSNSO(J))<a name='2977'>
               QOUT = MIN(QOUT,(1.-VOL_ICE(J+1)-VOL_LIQ(J+1))*DZSNSO(J+1))<a name='2978'>
            END IF<a name='2979'>
         ELSE<a name='2980'>
            QOUT = MAX(0.,(VOL_LIQ(J) - SSI*EPORE(J))*DZSNSO(J))<a name='2981'>
         END IF<a name='2982'>
         QOUT = QOUT*1000.<a name='2983'>
         SNLIQ(J) = SNLIQ(J) - QOUT<a name='2984'>
         QIN = QOUT<a name='2985'>
      END IF<a name='2986'>
   END DO<a name='2987'>
<a name='2988'>
<font color=#447700>! Liquid water from snow bottom to soil<a name='2989'></font>
<a name='2990'>
   QSNBOT = QOUT / DT           <font color=#447700>! mm/s<a name='2991'></font>
<a name='2992'>
  END SUBROUTINE SNOWH2O_GLACIER<a name='2993'>
<font color=#447700>! ********************* end of water subroutines ******************************************<a name='2994'></font>
<font color=#447700>! ==================================================================================================<a name='2995'></font>
<A NAME='ERROR_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ERROR_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2996'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ERROR_GLACIER</font> (ILOC   ,JLOC   ,SWDOWN ,FSA    ,FSR    ,FIRA   , &amp; <A href='../../call_to/ERROR_GLACIER.html' TARGET='index'>1</A>,<A href='../../call_from/ERROR_GLACIER.html' TARGET='index'>11</A><a name='2997'>
                            FSH    ,FGEV   ,SSOIL  ,SAG    ,PRCP   ,EDIR   , &amp;<a name='2998'>
		            RUNSRF ,RUNSUB ,SNEQV  ,DT     ,BEG_WB )<a name='2999'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='3000'></font>
<font color=#447700>! check surface energy balance and water balance<a name='3001'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='3002'></font>
  IMPLICIT NONE<a name='3003'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='3004'></font>
<font color=#447700>! inputs<a name='3005'></font>
  INTEGER                        , INTENT(IN) :: ILOC   <font color=#447700>!grid index<a name='3006'></font>
  INTEGER                        , INTENT(IN) :: JLOC   <font color=#447700>!grid index<a name='3007'></font>
  REAL                           , INTENT(IN) :: SWDOWN <font color=#447700>!downward solar filtered by sun angle [w/m2]<a name='3008'></font>
  REAL                           , INTENT(IN) :: FSA    <font color=#447700>!total absorbed solar radiation (w/m2)<a name='3009'></font>
  REAL                           , INTENT(IN) :: FSR    <font color=#447700>!total reflected solar radiation (w/m2)<a name='3010'></font>
  REAL                           , INTENT(IN) :: FIRA   <font color=#447700>!total net longwave rad (w/m2)  [+ to atm]<a name='3011'></font>
  REAL                           , INTENT(IN) :: FSH    <font color=#447700>!total sensible heat (w/m2)     [+ to atm]<a name='3012'></font>
  REAL                           , INTENT(IN) :: FGEV   <font color=#447700>!ground evaporation heat (w/m2) [+ to atm]<a name='3013'></font>
  REAL                           , INTENT(IN) :: SSOIL  <font color=#447700>!ground heat flux (w/m2)        [+ to soil]<a name='3014'></font>
  REAL                           , INTENT(IN) :: SAG<a name='3015'>
<a name='3016'>
  REAL                           , INTENT(IN) :: PRCP   <font color=#447700>!precipitation rate (kg m-2 s-1)<a name='3017'></font>
  REAL                           , INTENT(IN) :: EDIR   <font color=#447700>!soil surface evaporation rate[mm/s]<a name='3018'></font>
  REAL                           , INTENT(IN) :: RUNSRF <font color=#447700>!surface runoff [mm/s] <a name='3019'></font>
  REAL                           , INTENT(IN) :: RUNSUB <font color=#447700>!baseflow (saturation excess) [mm/s]<a name='3020'></font>
  REAL                           , INTENT(IN) :: SNEQV  <font color=#447700>!snow water eqv. [mm]<a name='3021'></font>
  REAL                           , INTENT(IN) :: DT     <font color=#447700>!time step [sec]<a name='3022'></font>
  REAL                           , INTENT(IN) :: BEG_WB <font color=#447700>!water storage at begin of a timesetp [mm]<a name='3023'></font>
<a name='3024'>
  REAL                                        :: END_WB <font color=#447700>!water storage at end of a timestep [mm]<a name='3025'></font>
  REAL                                        :: ERRWAT <font color=#447700>!error in water balance [mm/timestep]<a name='3026'></font>
  REAL                                        :: ERRENG <font color=#447700>!error in surface energy balance [w/m2]<a name='3027'></font>
  REAL                                        :: ERRSW  <font color=#447700>!error in shortwave radiation balance [w/m2]<a name='3028'></font>
  CHARACTER(len=256)                          :: message<a name='3029'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='3030'></font>
   ERRSW   = SWDOWN - (FSA + FSR)<a name='3031'>
   IF (ERRSW &gt; 0.01) THEN            <font color=#447700>! w/m2<a name='3032'></font>
     WRITE(*,*) "SAG    =",SAG<a name='3033'>
     WRITE(*,*) "FSA    =",FSA<a name='3034'>
     WRITE(*,*) "FSR    =",FSR<a name='3035'>
     WRITE(message,*) 'ERRSW =',ERRSW<a name='3036'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ERROR_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_946">(trim(message))<a name='3037'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ERROR_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1179">("Radiation budget problem in NOAHMP GLACIER")<a name='3038'>
   END IF<a name='3039'>
<a name='3040'>
   ERRENG = SAG-(FIRA+FSH+FGEV+SSOIL)<a name='3041'>
   IF(ERRENG &gt; 0.01) THEN<a name='3042'>
      write(message,*) 'ERRENG =',ERRENG<a name='3043'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ERROR_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_947">(trim(message))<a name='3044'>
      WRITE(message,'(i6,1x,i6,1x,5F10.4)')ILOC,JLOC,SAG,FIRA,FSH,FGEV,SSOIL<a name='3045'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ERROR_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_948">(trim(message))<a name='3046'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ERROR_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1180">("Energy budget problem in NOAHMP GLACIER")<a name='3047'>
   END IF<a name='3048'>
<a name='3049'>
   END_WB = SNEQV<a name='3050'>
   ERRWAT = END_WB-BEG_WB-(PRCP-EDIR-RUNSRF-RUNSUB)*DT<a name='3051'>
<a name='3052'>
#ifndef WRF_HYDRO<a name='3053'>
   IF(ABS(ERRWAT) &gt; 0.1) THEN<a name='3054'>
      if (ERRWAT &gt; 0) then<a name='3055'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ERROR_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_949"> ('The model is gaining water (ERRWAT is positive)')<a name='3056'>
      else<a name='3057'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ERROR_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_950">('The model is losing water (ERRWAT is negative)')<a name='3058'>
      endif<a name='3059'>
      write(message, *) 'ERRWAT =',ERRWAT, "kg m{-2} timestep{-1}"<a name='3060'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ERROR_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_951">(trim(message))<a name='3061'>
      WRITE(message,'("    I      J     END_WB     BEG_WB       PRCP       EDIR      RUNSRF     RUNSUB")')<a name='3062'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ERROR_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_952">(trim(message))<a name='3063'>
           WRITE(message,'(i6,1x,i6,1x,2f15.3,4f11.5)')ILOC,JLOC,END_WB,BEG_WB,PRCP*DT,&amp;<a name='3064'>
                EDIR*DT,RUNSRF*DT,RUNSUB*DT<a name='3065'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ERROR_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_953">(trim(message))<a name='3066'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#ERROR_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1181">("Water budget problem in NOAHMP GLACIER")<a name='3067'>
        END IF<a name='3068'>
#endif<a name='3069'>
<a name='3070'>
 END SUBROUTINE ERROR_GLACIER<a name='3071'>
<font color=#447700>! ==================================================================================================<a name='3072'></font>
<a name='3073'>
<A NAME='NOAHMP_OPTIONS_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_OPTIONS_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3074'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>NOAHMP_OPTIONS_GLACIER</font>(iopt_alb  ,iopt_snf  ,iopt_tbot, iopt_stc, iopt_gla ) <A href='../../call_to/NOAHMP_OPTIONS_GLACIER.html' TARGET='index'>1</A>,<A href='../../call_from/NOAHMP_OPTIONS_GLACIER.html' TARGET='index'>2</A><a name='3075'>
<a name='3076'>
  IMPLICIT NONE<a name='3077'>
<a name='3078'>
  INTEGER,  INTENT(IN) :: iopt_alb  <font color=#447700>!snow surface albedo (1-&gt;BATS; 2-&gt;CLASS)<a name='3079'></font>
  INTEGER,  INTENT(IN) :: iopt_snf  <font color=#447700>!rainfall &amp; snowfall (1-Jordan91; 2-&gt;BATS; 3-&gt;Noah)<a name='3080'></font>
  INTEGER,  INTENT(IN) :: iopt_tbot <font color=#447700>!lower boundary of soil temperature (1-&gt;zero-flux; 2-&gt;Noah)<a name='3081'></font>
  INTEGER,  INTENT(IN) :: iopt_stc  <font color=#447700>!snow/soil temperature time scheme (only layer 1)<a name='3082'></font>
                                    <font color=#447700>! 1 -&gt; semi-implicit; 2 -&gt; full implicit (original Noah)<a name='3083'></font>
  INTEGER,  INTENT(IN) :: IOPT_GLA  <font color=#447700>! glacier option (1-&gt;phase change; 2-&gt;simple)<a name='3084'></font>
<a name='3085'>
<font color=#447700>! -------------------------------------------------------------------------------------------------<a name='3086'></font>
<a name='3087'>
  opt_alb  = iopt_alb  <a name='3088'>
  opt_snf  = iopt_snf  <a name='3089'>
  opt_tbot = iopt_tbot <a name='3090'>
  opt_stc  = iopt_stc<a name='3091'>
  opt_gla  = iopt_gla<a name='3092'>
  <a name='3093'>
  end subroutine noahmp_options_glacier<a name='3094'>
 <a name='3095'>
END MODULE NOAHMP_GLACIER_ROUTINES<a name='3096'>
<font color=#447700>! ==================================================================================================<a name='3097'></font>
<a name='3098'>
<A NAME='MODULE_SF_NOAHMP_GLACIER'><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#MODULE_SF_NOAHMP_GLACIER' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='3099'>
<font color=#993300>MODULE </font><font color=#cc0000>MODULE_SF_NOAHMP_GLACIER</font> <A href='../../call_to/MODULE_SF_NOAHMP_GLACIER.html' TARGET='index'>1</A><a name='3100'>
<a name='3101'>
  USE <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_GLACIER_ROUTINES'>NOAHMP_GLACIER_ROUTINES</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_OPTIONS_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOAHMP_GLACIER_ROUTINES_1"><a name='3102'>
  USE <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_GLACIER_GLOBALS'>NOAHMP_GLACIER_GLOBALS</A><A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_OPTIONS_GLACIER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOAHMP_GLACIER_GLOBALS_2"><a name='3103'>
<a name='3104'>
END MODULE MODULE_SF_NOAHMP_GLACIER<a name='3105'>
</pre></body></html>