<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if ( RWORDSIZE == 4 )<a name='2'>
#  define VREC vsrec<a name='3'>
#  define VSQRT vssqrt<a name='4'>
#else<a name='5'>
#  define VREC vrec<a name='6'>
#  define VSQRT vsqrt<a name='7'>
#endif<a name='8'>
<A NAME='MODULE_MP_WDM6'><A href='../../html_code/phys/module_mp_wdm6.F.html#MODULE_MP_WDM6' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='9'>
<font color=#993300>MODULE </font><font color=#cc0000>module_mp_wdm6</font> <A href='../../call_to/MODULE_MP_WDM6.html' TARGET='index'>2</A><a name='10'>
<font color=#447700>!<a name='11'></font>
<font color=#447700>!<a name='12'></font>
   USE module_utility, ONLY: WRFU_Clock, WRFU_Alarm<a name='13'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/phys/module_mp_wdm6.F.html#module_mp_wdm6.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_241">, ONLY : HISTORY_ALARM, Is_alarm_tstep<a name='14'>
   USE <A href='../../html_code/phys/module_mp_radar.F.html#MODULE_MP_RADAR'>module_mp_radar</A><A href='../../html_code/phys/module_mp_wdm6.F.html#module_mp_wdm6.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MP_RADAR_8"><a name='15'>
<font color=#447700>!<a name='16'></font>
   REAL, PARAMETER, PRIVATE :: dtcldcr     = 120. <font color=#447700>! maximum time step for minor loops<a name='17'></font>
   REAL, PARAMETER, PRIVATE :: n0r = 8.e6         <font color=#447700>! intercept parameter rain<a name='18'></font>
<font color=#447700>!   REAL, PARAMETER, PRIVATE :: n0g = 4.e6         ! intercept parameter graupel ! RAS - now set in subroutine based on namelist option<a name='19'></font>
   REAL, PARAMETER, PRIVATE :: avtr = 841.9       <font color=#447700>! a constant for terminal velocity of rain<a name='20'></font>
   REAL, PARAMETER, PRIVATE :: bvtr = 0.8         <font color=#447700>! a constant for terminal velocity of rain<a name='21'></font>
   REAL, PARAMETER, PRIVATE :: r0 = .8e-5         <font color=#447700>! 8 microm  in contrast to 10 micro m<a name='22'></font>
   REAL, PARAMETER, PRIVATE :: peaut = .55        <font color=#447700>! collection efficiency<a name='23'></font>
   REAL, PARAMETER, PRIVATE :: xncr = 3.e8        <font color=#447700>! maritime cloud in contrast to 3.e8 in tc80<a name='24'></font>
   REAL, PARAMETER, PRIVATE :: xmyu = 1.718e-5    <font color=#447700>! the dynamic viscosity kgm-1s-1<a name='25'></font>
   REAL, PARAMETER, PRIVATE :: avts = 11.72       <font color=#447700>! a constant for terminal velocity of snow<a name='26'></font>
   REAL, PARAMETER, PRIVATE :: bvts = .41         <font color=#447700>! a constant for terminal velocity of snow <a name='27'></font>
<font color=#447700>!   REAL, PARAMETER, PRIVATE :: avtg = 330.        ! a constant for terminal velocity of graupel ! RAS - now set in subroutine based on namelist option<a name='28'></font>
<font color=#447700>!   REAL, PARAMETER, PRIVATE :: bvtg = 0.8         ! a constant for terminal velocity of graupel ! RAS - now set in subroutine based on namelist option<a name='29'></font>
<font color=#447700>!   REAL, PARAMETER, PRIVATE :: deng = 500.        ! density of graupel !RAS13.1 - now set in subroutine based on namelist option<a name='30'></font>
   REAL, PARAMETER, PRIVATE :: n0smax =  1.e11    <font color=#447700>! maximum n0s (t=-90C unlimited)<a name='31'></font>
   REAL, PARAMETER, PRIVATE :: lamdacmax = 5.0e5  <font color=#447700>! limited maximum value for slope parameter of cloud water<a name='32'></font>
   REAL, PARAMETER, PRIVATE :: lamdacmin = 2.0e4  <font color=#447700>! limited minimum value for slope parameter of cloud water<a name='33'></font>
   REAL, PARAMETER, PRIVATE :: lamdarmax = 5.0e4  <font color=#447700>! limited maximum value for slope parameter of rain<a name='34'></font>
   REAL, PARAMETER, PRIVATE :: lamdarmin = 2.0e3  <font color=#447700>! limited minimum value for slope parameter of rain<a name='35'></font>
   REAL, PARAMETER, PRIVATE :: lamdasmax = 1.e5   <font color=#447700>! limited maximum value for slope parameter of snow<a name='36'></font>
<font color=#447700>!   REAL, PARAMETER, PRIVATE :: lamdagmax = 6.e4   ! limited maximum value for slope parameter of graupel - now set in subroutine based on namelist option<a name='37'></font>
   REAL, PARAMETER, PRIVATE :: dicon = 11.9       <font color=#447700>! constant for the cloud-ice diamter<a name='38'></font>
   REAL, PARAMETER, PRIVATE :: dimax = 500.e-6    <font color=#447700>! limited maximum value for the cloud-ice diamter<a name='39'></font>
   REAL, PARAMETER, PRIVATE :: n0s = 2.e6         <font color=#447700>! temperature dependent intercept parameter snow <a name='40'></font>
   REAL, PARAMETER, PRIVATE :: alpha = .12        <font color=#447700>! .122 exponen factor for n0s<a name='41'></font>
   REAL, PARAMETER, PRIVATE :: pfrz1 = 100.       <font color=#447700>! constant in Biggs freezing<a name='42'></font>
   REAL, PARAMETER, PRIVATE :: pfrz2 = 0.66       <font color=#447700>! constant in Biggs freezing<a name='43'></font>
   REAL, PARAMETER, PRIVATE :: qcrmin = 1.e-9     <font color=#447700>! minimun values for qr, qs, and qg <a name='44'></font>
   REAL, PARAMETER, PRIVATE :: ncmin = 1.e1       <font color=#447700>! minimum value for Nc <a name='45'></font>
   REAL, PARAMETER, PRIVATE :: nrmin = 1.e-2      <font color=#447700>! minimum value for Nr<a name='46'></font>
   REAL, PARAMETER, PRIVATE :: eacrc = 1.0        <font color=#447700>! Snow/cloud-water collection efficiency<a name='47'></font>
   REAL, PARAMETER, PRIVATE :: dens  =  100.0     <font color=#447700>! Density of snow<a name='48'></font>
   REAL, PARAMETER, PRIVATE :: qs0   =  6.e-4     <font color=#447700>! threshold amount for aggretion to occur<a name='49'></font>
<font color=#447700>!<a name='50'></font>
   REAL, PARAMETER, PRIVATE :: satmax = 1.0048    <font color=#447700>! maximum saturation value for CCN activation <a name='51'></font>
                                                  <font color=#447700>! 1.008 for maritime /1.0048 for conti <a name='52'></font>
   REAL, PARAMETER, PRIVATE :: actk = 0.6         <font color=#447700>! parameter for the CCN activation<a name='53'></font>
   REAL, PARAMETER, PRIVATE :: actr = 1.5         <font color=#447700>! radius of activated CCN drops<a name='54'></font>
   REAL, PARAMETER, PRIVATE :: ncrk1 = 3.03e3     <font color=#447700>! Long's collection kernel coefficient<a name='55'></font>
   REAL, PARAMETER, PRIVATE :: ncrk2 = 2.59e15    <font color=#447700>! Long's collection kernel coefficient<a name='56'></font>
   REAL, PARAMETER, PRIVATE :: di100 = 1.e-4      <font color=#447700>! parameter related with accretion and collection of cloud drops<a name='57'></font>
   REAL, PARAMETER, PRIVATE :: di600 = 6.e-4      <font color=#447700>! parameter related with accretion and collection of cloud drops<a name='58'></font>
   REAL, PARAMETER, PRIVATE :: di2000 = 2000.e-6  <font color=#447700>! parameter related with accretion and collection of cloud drops <a name='59'></font>
   REAL, PARAMETER, PRIVATE :: di82    = 82.e-6   <font color=#447700>! dimater related with raindrops evaporation<a name='60'></font>
   REAL, PARAMETER, PRIVATE :: di15    = 15.e-6   <font color=#447700>! auto conversion takes place beyond this diameter <a name='61'></font>
<font color=#447700>!<a name='62'></font>
   REAL, SAVE ::                                           &amp;<a name='63'>
             qc0,qck1,pidnc,bvtr1,bvtr2,bvtr3,bvtr4,bvtr5, &amp;<a name='64'>
             bvtr6,bvtr7, bvtr2o5,bvtr3o5,                 &amp;<a name='65'>
             g1pbr,g2pbr,g3pbr,g4pbr,g5pbr,g6pbr,g7pbr,    &amp;<a name='66'>
             g5pbro2,g7pbro2,pi,                           &amp;<a name='67'>
             pvtr,pvtrn,eacrr,pacrr,pidn0r,pidnr,          &amp;<a name='68'>
             precr1,precr2,xmmax,roqimax,bvts1,bvts2,      &amp;<a name='69'>
             bvts3,bvts4,g1pbs,g3pbs,g4pbs,g5pbso2,        &amp;<a name='70'>
             pvts,pacrs,precs1,precs2,pidn0s,xlv1,pacrc,   &amp;<a name='71'>
             bvtg1,bvtg2,bvtg3,bvtg4,g1pbg,g3pbg,g4pbg,    &amp;<a name='72'>
             n0g,avtg,bvtg,deng,lamdagmax,                 &amp; <font color=#447700>!RAS13.3 - set these in wdm6init<a name='73'></font>
             g5pbgo2,pvtg,pacrg,precg1,precg2,pidn0g,      &amp;<a name='74'>
             rslopecmax,rslopec2max,rslopec3max,           &amp;<a name='75'>
             rslopermax,rslopesmax,rslopegmax,             &amp;<a name='76'>
             rsloperbmax,rslopesbmax,rslopegbmax,          &amp;<a name='77'>
             rsloper2max,rslopes2max,rslopeg2max,          &amp;<a name='78'>
             rsloper3max,rslopes3max,rslopeg3max<a name='79'>
CONTAINS<a name='80'>
<font color=#447700>!===================================================================<a name='81'></font>
<font color=#447700>!<a name='82'></font>
<A NAME='WDM6'><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='83'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>wdm6</font>(th, q, qc, qr, qi, qs, qg,               &amp; <A href='../../call_to/WDM6.html' TARGET='index'>1</A>,<A href='../../call_from/WDM6.html' TARGET='index'>3</A><a name='84'>
                    nn, nc, nr,                            &amp;<a name='85'>
                    den, pii, p, delz,                     &amp;<a name='86'>
                    delt,g, cpd, cpv, ccn0, rd, rv, t0c,   &amp;<a name='87'>
                    ep1, ep2, qmin,                        &amp;<a name='88'>
                    XLS, XLV0, XLF0, den0, denr,           &amp;<a name='89'>
                    cliq,cice,psat,                        &amp;<a name='90'>
                    rain, rainncv,                         &amp;<a name='91'>
                    snow, snowncv,                         &amp;<a name='92'>
                    sr,                                    &amp;<a name='93'>
                    refl_10cm, diagflag, do_radar_ref,     &amp;<a name='94'>
                    graupel, graupelncv,                   &amp;<a name='95'>
                    itimestep,                             &amp;<a name='96'>
                    has_reqc, has_reqi, has_reqs,          &amp;  <font color=#447700>! for radiation<a name='97'></font>
                    re_cloud, re_ice,   re_snow,           &amp;  <font color=#447700>! for radiation     <a name='98'></font>
                    ids,ide, jds,jde, kds,kde,             &amp;<a name='99'>
                    ims,ime, jms,jme, kms,kme,             &amp;<a name='100'>
                    its,ite, jts,jte, kts,kte              &amp;<a name='101'>
                                                           )<a name='102'>
<font color=#447700>!-------------------------------------------------------------------<a name='103'></font>
  IMPLICIT NONE<a name='104'>
<font color=#447700>!-------------------------------------------------------------------<a name='105'></font>
<font color=#447700>!<a name='106'></font>
<font color=#447700>!  This code is a WRF double-moment 6-class GRAUPEL phase <a name='107'></font>
<font color=#447700>!  microphyiscs scheme (WDM6). The WDM microphysics scheme predicts <a name='108'></font>
<font color=#447700>!  number concentrations for warm rain species including clouds and <a name='109'></font>
<font color=#447700>!  rain. cloud condensation nuclei (CCN) is also predicted.<a name='110'></font>
<font color=#447700>!  The cold rain species including ice, snow, graupel follow the <a name='111'></font>
<font color=#447700>!  WRF single-moment 6-class microphysics (WSM6, Hong and Lim 2006)<a name='112'></font>
<font color=#447700>!  in which theoretical background for WSM ice phase microphysics is <a name='113'></font>
<font color=#447700>!  based on Hong et al. (2004). A new mixed-phase terminal velocity<a name='114'></font>
<font color=#447700>!  for precipitating ice is introduced in WSM6 (Dudhia et al. 2008). <a name='115'></font>
<font color=#447700>!  The WDM scheme is described in Lim and Hong (2010).<a name='116'></font>
<font color=#447700>!  All units are in m.k.s. and source/sink terms in kgkg-1s-1.<a name='117'></font>
<font color=#447700>!<a name='118'></font>
<font color=#447700>!  WDM6 cloud scheme<a name='119'></font>
<font color=#447700>!<a name='120'></font>
<font color=#447700>!  Coded by Kyo-Sun Lim and Song-You Hong (Yonsei Univ.) Fall 2008<a name='121'></font>
<font color=#447700>!<a name='122'></font>
<font color=#447700>!  Implemented by Kyo-Sun Lim and Jimy Dudhia (NCAR) Winter 2008<a name='123'></font>
<font color=#447700>!<a name='124'></font>
<font color=#447700>!  further modifications :<a name='125'></font>
<font color=#447700>!        semi-lagrangian sedimentation (JH,2010),hong, aug 2009<a name='126'></font>
<font color=#447700>!        ==&gt; higher accuracy and efficient at lower resolutions<a name='127'></font>
<font color=#447700>!        reflectivity computation from greg thompson, lim, jun 2011<a name='128'></font>
<font color=#447700>!        ==&gt; only diagnostic, but with removal of too large drops<a name='129'></font>
<font color=#447700>!        add hail option from afwa, aug 2014<a name='130'></font>
<font color=#447700>!        ==&gt; switch graupel or hail by changing no, den, fall vel.<a name='131'></font>
<font color=#447700>!        effective radius of hydrometeors, bae from kiaps, jan 2015<a name='132'></font>
<font color=#447700>!        ==&gt; consistency in solar insolation of rrtmg radiation<a name='133'></font>
<font color=#447700>!        bug fix in melting terms, bae from kiaps, nov 2015<a name='134'></font>
<font color=#447700>!        ==&gt; density of air is divided, which has not been<a name='135'></font>
<font color=#447700>!<a name='136'></font>
<font color=#447700>!  Reference) Lim and Hong (LH, 2010) Mon. Wea. Rev. <a name='137'></font>
<font color=#447700>!             Juang and Hong (JH, 2010) Mon. Wea. Rev.<a name='138'></font>
<font color=#447700>!             Hong, Dudhia, Chen (HDC, 2004) Mon. Wea. Rev. <a name='139'></font>
<font color=#447700>!             Hong and Lim (HL, 2006) J. Korean Meteor. Soc. <a name='140'></font>
<font color=#447700>!             Cohard and Pinty (CP, 2000) Quart. J. Roy. Meteor. Soc.<a name='141'></font>
<font color=#447700>!             Khairoutdinov and Kogan (KK, 2000) Mon. Wea. Rev.<a name='142'></font>
<font color=#447700>!             Dudhia, Hong and Lim (DHL, 2008) J. Meteor. Soc. Japan<a name='143'></font>
<font color=#447700>!             <a name='144'></font>
<font color=#447700>!             Lin, Farley, Orville (LFO, 1983) J. Appl. Meteor.<a name='145'></font>
<font color=#447700>!             Rutledge, Hobbs (RH83, 1983) J. Atmos. Sci.<a name='146'></font>
<font color=#447700>!             Rutledge, Hobbs (RH84, 1984) J. Atmos. Sci.<a name='147'></font>
<font color=#447700>!<a name='148'></font>
  INTEGER,      INTENT(IN   )    ::   ids,ide, jds,jde, kds,kde , &amp;<a name='149'>
                                      ims,ime, jms,jme, kms,kme , &amp;<a name='150'>
                                      its,ite, jts,jte, kts,kte<a name='151'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),                 &amp;<a name='152'>
        INTENT(INOUT) ::                                          &amp;<a name='153'>
                                                              th, &amp;<a name='154'>
                                                               q, &amp;<a name='155'>
                                                              qc, &amp;<a name='156'>
                                                              qi, &amp;<a name='157'>
                                                              qr, &amp;<a name='158'>
                                                              qs, &amp;<a name='159'>
                                                              qg, &amp;<a name='160'>
                                                              nn, &amp; <a name='161'>
                                                              nc, &amp;<a name='162'>
                                                              nr<a name='163'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),                 &amp;<a name='164'>
        INTENT(IN   ) ::                                          &amp;<a name='165'>
                                                             den, &amp;<a name='166'>
                                                             pii, &amp;<a name='167'>
                                                               p, &amp;<a name='168'>
                                                            delz<a name='169'>
  REAL, INTENT(IN   ) ::                                    delt, &amp;<a name='170'>
                                                               g, &amp;<a name='171'>
                                                              rd, &amp;<a name='172'>
                                                              rv, &amp;<a name='173'>
                                                             t0c, &amp;<a name='174'>
                                                            den0, &amp;<a name='175'>
                                                             cpd, &amp;<a name='176'>
                                                             cpv, &amp;<a name='177'>
                                                            ccn0, &amp;<a name='178'>
                                                             ep1, &amp;<a name='179'>
                                                             ep2, &amp;<a name='180'>
                                                            qmin, &amp;<a name='181'>
                                                             XLS, &amp;<a name='182'>
                                                            XLV0, &amp;<a name='183'>
                                                            XLF0, &amp;<a name='184'>
                                                            cliq, &amp;<a name='185'>
                                                            cice, &amp;<a name='186'>
                                                            psat, &amp;<a name='187'>
                                                            denr<a name='188'>
  INTEGER, INTENT(IN   ) ::                            itimestep<a name='189'>
  REAL, DIMENSION( ims:ime , jms:jme ),                           &amp;<a name='190'>
        INTENT(INOUT) ::                                    rain, &amp;<a name='191'>
                                                         rainncv, &amp;<a name='192'>
                                                              sr<a name='193'>
<font color=#447700>! for radiation connecting<a name='194'></font>
  INTEGER, INTENT(IN)::                                           &amp;<a name='195'>
                                                        has_reqc, &amp;<a name='196'>
                                                        has_reqi, &amp;<a name='197'>
                                                        has_reqs<a name='198'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),                     &amp;<a name='199'>
        INTENT(INOUT)::                                           &amp;<a name='200'>
                                                        re_cloud, &amp;<a name='201'>
                                                          re_ice, &amp;<a name='202'>
                                                         re_snow   <a name='203'>
<a name='204'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='205'></font>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT)::     &amp;  <font color=#447700>! GT<a name='206'></font>
                                                       refl_10cm<a name='207'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='208'></font>
<a name='209'>
  REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL,                 &amp;<a name='210'>
        INTENT(INOUT) ::                                    snow, &amp;<a name='211'>
                                                         snowncv<a name='212'>
  REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL,                 &amp;<a name='213'>
        INTENT(INOUT) ::                                 graupel, &amp;<a name='214'>
                                                        graupelncv<a name='215'>
   <a name='216'>
<font color=#447700>! LOCAL VAR<a name='217'></font>
  REAL, DIMENSION( its:ite , kts:kte ) ::   t<a name='218'>
  REAL, DIMENSION( its:ite , kts:kte, 2 ) ::   qci<a name='219'>
  REAL, DIMENSION( its:ite , kts:kte, 3 ) ::   qrs, ncr<a name='220'>
  INTEGER ::               i,j,k<a name='221'>
<a name='222'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='223'></font>
      REAL, DIMENSION(kts:kte):: qv1d, t1d, p1d, qr1d, nr1d, qs1d, qg1d, dBZ<a name='224'>
      LOGICAL, OPTIONAL, INTENT(IN) :: diagflag<a name='225'>
      INTEGER, OPTIONAL, INTENT(IN) :: do_radar_ref<a name='226'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='227'></font>
<font color=#447700>! to calculate effective radius for radiation<a name='228'></font>
  REAL, DIMENSION( kts:kte ) :: qc1d, nc1d, den1d<a name='229'>
  REAL, DIMENSION( kts:kte ) :: qi1d<a name='230'>
  REAL, DIMENSION( kts:kte ) :: re_qc, re_qi, re_qs<a name='231'>
<a name='232'>
      IF (itimestep .eq. 1) THEN <a name='233'>
        DO j=jms,jme<a name='234'>
           DO k=kms,kme    <a name='235'>
           DO i=ims,ime<a name='236'>
              nn(i,k,j) = ccn0   <a name='237'>
           ENDDO<a name='238'>
           ENDDO<a name='239'>
        ENDDO<a name='240'>
      ENDIF<a name='241'>
<font color=#447700>!<a name='242'></font>
      DO j=jts,jte<a name='243'>
         DO k=kts,kte<a name='244'>
         DO i=its,ite<a name='245'>
            t(i,k)=th(i,k,j)*pii(i,k,j)<a name='246'>
            qci(i,k,1) = qc(i,k,j)<a name='247'>
            qci(i,k,2) = qi(i,k,j)<a name='248'>
            qrs(i,k,1) = qr(i,k,j)<a name='249'>
            qrs(i,k,2) = qs(i,k,j)<a name='250'>
            qrs(i,k,3) = qg(i,k,j)<a name='251'>
            ncr(i,k,1) = nn(i,k,j)<a name='252'>
            ncr(i,k,2) = nc(i,k,j)<a name='253'>
            ncr(i,k,3) = nr(i,k,j)     <a name='254'>
         ENDDO<a name='255'>
         ENDDO<a name='256'>
         <font color=#447700>!  Sending array starting locations of optional variables may cause<a name='257'></font>
         <font color=#447700>!  troubles, so we explicitly change the call.<a name='258'></font>
         CALL <A href='../../html_code/phys/module_mp_wdm6.F.html#WDM62D'>wdm62D</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDM62D_1">(t, q(ims,kms,j), qci, qrs, ncr               &amp;<a name='259'>
                    ,den(ims,kms,j)                               &amp;<a name='260'>
                    ,p(ims,kms,j), delz(ims,kms,j)                &amp;<a name='261'>
                    ,delt,g, cpd, cpv, ccn0, rd, rv, t0c          &amp;<a name='262'>
                    ,ep1, ep2, qmin                               &amp;<a name='263'>
                    ,XLS, XLV0, XLF0, den0, denr                  &amp;<a name='264'>
                    ,cliq,cice,psat                               &amp;<a name='265'>
                    ,j                                            &amp;<a name='266'>
                    ,rain(ims,j),rainncv(ims,j)                   &amp;<a name='267'>
                    ,sr(ims,j)                                    &amp;<a name='268'>
                    ,ids,ide, jds,jde, kds,kde                    &amp;<a name='269'>
                    ,ims,ime, jms,jme, kms,kme                    &amp;<a name='270'>
                    ,its,ite, jts,jte, kts,kte                    &amp;<a name='271'>
                    ,snow(ims,j),snowncv(ims,j)                   &amp;<a name='272'>
                    ,graupel(ims,j),graupelncv(ims,j)             &amp; <a name='273'>
                                                                   )<a name='274'>
         DO K=kts,kte<a name='275'>
         DO I=its,ite<a name='276'>
            th(i,k,j)=t(i,k)/pii(i,k,j)<a name='277'>
            qc(i,k,j) = qci(i,k,1)<a name='278'>
            qi(i,k,j) = qci(i,k,2)<a name='279'>
            qr(i,k,j) = qrs(i,k,1)<a name='280'>
            qs(i,k,j) = qrs(i,k,2)<a name='281'>
            qg(i,k,j) = qrs(i,k,3)<a name='282'>
            nn(i,k,j) = ncr(i,k,1)<a name='283'>
            nc(i,k,j) = ncr(i,k,2)<a name='284'>
            nr(i,k,j) = ncr(i,k,3)   <a name='285'>
         ENDDO<a name='286'>
         ENDDO<a name='287'>
<a name='288'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='289'></font>
         IF ( PRESENT (diagflag) ) THEN<a name='290'>
         if (diagflag .and. do_radar_ref == 1) then<a name='291'>
            DO I=its,ite<a name='292'>
               DO K=kts,kte<a name='293'>
                  t1d(k)=th(i,k,j)*pii(i,k,j)<a name='294'>
                  p1d(k)=p(i,k,j)<a name='295'>
                  qv1d(k)=q(i,k,j)<a name='296'>
                  qr1d(k)=qr(i,k,j)<a name='297'>
                  nr1d(k)=nr(i,k,j)<a name='298'>
                  qs1d(k)=qs(i,k,j)<a name='299'>
                  qg1d(k)=qg(i,k,j)<a name='300'>
               ENDDO<a name='301'>
               call <A href='../../html_code/phys/module_mp_wdm6.F.html#REFL10CM_WDM6'>refl10cm_wdm6</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REFL10CM_WDM6_1"> (qv1d, qr1d, nr1d, qs1d, qg1d,        &amp;<a name='302'>
                       t1d, p1d, dBZ, kts, kte, i, j)<a name='303'>
               do k = kts, kte<a name='304'>
                  refl_10cm(i,k,j) = MAX(-35., dBZ(k))<a name='305'>
               enddo<a name='306'>
            ENDDO<a name='307'>
         endif<a name='308'>
         ENDIF<a name='309'>
<a name='310'>
<font color=#447700>! calculate effective radius of cloud, ice, and snow <a name='311'></font>
         IF (has_reqc.ne.0 .and. has_reqi.ne.0 .and. has_reqs.ne.0) THEN<a name='312'>
           DO i=its,ite<a name='313'>
             DO k=kts,kte<a name='314'>
               re_qc(k) = 2.51E-6<a name='315'>
               re_qi(k) = 10.01E-6<a name='316'>
               re_qs(k) = 25.E-6<a name='317'>
<a name='318'>
               t1d(k)  = th(i,k,j)*pii(i,k,j)<a name='319'>
               den1d(k)= den(i,k,j)<a name='320'>
               qc1d(k) = qc(i,k,j)<a name='321'>
               qi1d(k) = qi(i,k,j)<a name='322'>
               qs1d(k) = qs(i,k,j)<a name='323'>
               nc1d(k) = nc(i,k,j)<a name='324'>
             ENDDO<a name='325'>
             call <A href='../../html_code/phys/module_mp_wdm6.F.html#EFFECTRAD_WDM6'>effectRad_wdm6</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EFFECTRAD_WDM6_1">(t1d, qc1d, nc1d, qi1d, qs1d, den1d,   &amp;<a name='326'>
                                 qmin, t0c, re_qc, re_qi, re_qs,       &amp;<a name='327'>
                                 kts, kte, i, j)<a name='328'>
             DO k=kts,kte<a name='329'>
               re_cloud(i,k,j) = max(2.51E-6,  min(re_qc(k),  50.E-6))<a name='330'>
               re_ice(i,k,j)   = max(10.01E-6, min(re_qi(k), 125.E-6))<a name='331'>
               re_snow(i,k,j)  = max(25.E-6,   min(re_qs(k), 999.E-6))<a name='332'>
             ENDDO<a name='333'>
           ENDDO<a name='334'>
         ENDIF<a name='335'>
           <a name='336'>
      ENDDO<a name='337'>
 <a name='338'>
  END SUBROUTINE wdm6<a name='339'>
<font color=#447700>!===================================================================<a name='340'></font>
<font color=#447700>!<a name='341'></font>
<A NAME='WDM62D'><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM62D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='342'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>wdm62D</font>(t, q, qci, qrs, ncr, den, p, delz             &amp; <A href='../../call_to/WDM62D.html' TARGET='index'>1</A>,<A href='../../call_from/WDM62D.html' TARGET='index'>9</A><a name='343'>
                   ,delt,g, cpd, cpv, ccn0, rd, rv, t0c           &amp;<a name='344'>
                   ,ep1, ep2, qmin                                &amp;<a name='345'>
                   ,XLS, XLV0, XLF0, den0, denr                   &amp;<a name='346'>
                   ,cliq,cice,psat                                &amp;<a name='347'>
                   ,lat                                           &amp;<a name='348'>
                   ,rain,rainncv                                  &amp;<a name='349'>
                   ,sr                                            &amp;<a name='350'>
                   ,ids,ide, jds,jde, kds,kde                     &amp;<a name='351'>
                   ,ims,ime, jms,jme, kms,kme                     &amp;<a name='352'>
                   ,its,ite, jts,jte, kts,kte                     &amp;<a name='353'>
                   ,snow,snowncv                                  &amp;<a name='354'>
                   ,graupel,graupelncv                            &amp;<a name='355'>
                                                                  )<a name='356'>
<font color=#447700>!-------------------------------------------------------------------<a name='357'></font>
  IMPLICIT NONE<a name='358'>
<font color=#447700>!-------------------------------------------------------------------<a name='359'></font>
  INTEGER,      INTENT(IN   )    ::   ids,ide, jds,jde, kds,kde , &amp;<a name='360'>
                                      ims,ime, jms,jme, kms,kme , &amp;<a name='361'>
                                      its,ite, jts,jte, kts,kte , &amp;<a name='362'>
                                      lat<a name='363'>
  REAL, DIMENSION( its:ite , kts:kte ),                           &amp;<a name='364'>
        INTENT(INOUT) ::                                          &amp;<a name='365'>
                                                               t<a name='366'>
  REAL, DIMENSION( its:ite , kts:kte, 2 ),                        &amp;<a name='367'>
        INTENT(INOUT) ::                                          &amp;<a name='368'>
                                                             qci<a name='369'>
  REAL, DIMENSION( its:ite , kts:kte, 3 ),                        &amp;<a name='370'>
        INTENT(INOUT) ::                                          &amp;<a name='371'>
                                                             qrs, &amp;<a name='372'>
                                                             ncr <a name='373'>
  REAL, DIMENSION( ims:ime , kms:kme ),                           &amp;<a name='374'>
        INTENT(INOUT) ::                                          &amp;<a name='375'>
                                                               q<a name='376'>
  REAL, DIMENSION( ims:ime , kms:kme ),                           &amp;<a name='377'>
        INTENT(IN   ) ::                                          &amp;<a name='378'>
                                                             den, &amp;<a name='379'>
                                                               p, &amp;<a name='380'>
                                                            delz<a name='381'>
  REAL, INTENT(IN   ) ::                                    delt, &amp;<a name='382'>
                                                               g, &amp;<a name='383'>
                                                             cpd, &amp;<a name='384'>
                                                             cpv, &amp;<a name='385'>
                                                            ccn0, &amp;<a name='386'>
                                                             t0c, &amp;<a name='387'>
                                                            den0, &amp;<a name='388'>
                                                              rd, &amp;<a name='389'>
                                                              rv, &amp;<a name='390'>
                                                             ep1, &amp;<a name='391'>
                                                             ep2, &amp;<a name='392'>
                                                            qmin, &amp;<a name='393'>
                                                             XLS, &amp;<a name='394'>
                                                            XLV0, &amp;<a name='395'>
                                                            XLF0, &amp;<a name='396'>
                                                            cliq, &amp;<a name='397'>
                                                            cice, &amp;<a name='398'>
                                                            psat, &amp;<a name='399'>
                                                            denr<a name='400'>
  REAL, DIMENSION( ims:ime ),                                     &amp;<a name='401'>
        INTENT(INOUT) ::                                    rain, &amp;<a name='402'>
                                                         rainncv, &amp;<a name='403'>
                                                              sr<a name='404'>
  REAL, DIMENSION( ims:ime ),     OPTIONAL,                       &amp;<a name='405'>
        INTENT(INOUT) ::                                    snow, &amp;<a name='406'>
                                                         snowncv<a name='407'>
  REAL, DIMENSION( ims:ime ),     OPTIONAL,                       &amp;<a name='408'>
        INTENT(INOUT) ::                                 graupel, &amp;<a name='409'>
                                                      graupelncv<a name='410'>
<font color=#447700>! LOCAL VAR<a name='411'></font>
  REAL, DIMENSION( its:ite , kts:kte , 3) ::                      &amp;<a name='412'>
        rh, qs, rslope, rslope2, rslope3, rslopeb,                &amp;<a name='413'>
        falk, fall, work1, qrs_tmp<a name='414'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp; <a name='415'>
        rslopec, rslopec2,rslopec3 <a name='416'>
  REAL, DIMENSION( its:ite , kts:kte,  2) ::                      &amp;<a name='417'>
        avedia <a name='418'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='419'>
        workn,falln,falkn<a name='420'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='421'>
        worka,workr<a name='422'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='423'>
        den_tmp, delz_tmp, ncr_tmp <a name='424'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='425'>
        lamdr_tmp<a name='426'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='427'>
        lamdc_tmp<a name='428'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='429'>
        falkc, work1c, work2c, fallc<a name='430'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='431'>
        pcact, prevp, psdep, pgdep, praut, psaut, pgaut,          &amp;<a name='432'>
        pracw, psacw, pgacw, pgacr, pgacs, psaci, pgmlt, praci,   &amp;<a name='433'>
        piacr, pracs, psacr, pgaci, pseml, pgeml<a name='434'>
  REAL, DIMENSION( its:ite , kts:kte ) :: paacw<a name='435'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='436'>
        nraut, nracw, ncevp, nccol, nrcol,                        &amp;<a name='437'>
        nsacw, ngacw, niacr, nsacr, ngacr, naacw,                 &amp;<a name='438'>
        nseml, ngeml, ncact <a name='439'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='440'>
        pigen, pidep, pcond, pgevp, psmlt, psevp,                 &amp;<a name='441'>
        xl, cpm, work2, denfac, n0sfac, qsum,                     &amp;<a name='442'>
        denqrs1, denqr1, denqrs2, denqrs3, denncr3, denqci, xni <a name='443'>
  REAL, DIMENSION( its:ite ) ::                                   &amp;<a name='444'>
        delqrs1, delqrs2, delqrs3, delncr3, delqi<a name='445'>
  REAL, DIMENSION( its:ite ) :: tstepsnow, tstepgraup<a name='446'>
  REAL :: gfac, sfac<a name='447'>
<font color=#447700>! variables for optimization<a name='448'></font>
  REAL, DIMENSION( its:ite )           :: tvec1<a name='449'>
  REAL :: temp<a name='450'>
  INTEGER, DIMENSION( its:ite ) :: mnstep, numndt<a name='451'>
  INTEGER, DIMENSION( its:ite ) :: mstep, numdt<a name='452'>
  LOGICAL, DIMENSION( its:ite ) :: flgcld<a name='453'>
  REAL  ::                                                        &amp;<a name='454'>
            cpmcal, xlcal, lamdac,                                &amp;<a name='455'>
            diffus,                                               &amp;<a name='456'>
            viscos, xka, venfac, conden, diffac,                  &amp;<a name='457'>
            x, y, z, a, b, c, d, e,                               &amp;<a name='458'>
            ndt, qdt, holdrr, holdrs, holdrg, supcol, supcolt,    &amp;<a name='459'>
            pvt, coeres, supsat, dtcld, xmi, eacrs, satdt,        &amp;<a name='460'>
            qimax, diameter, xni0, roqi0,                         &amp;<a name='461'>
            fallsum, fallsum_qsi, fallsum_qg,                     &amp;<a name='462'>
            vt2i,vt2r,vt2s,vt2g,acrfac,egs,egi,                   &amp;<a name='463'>
            xlwork2, factor, source, value, coecol,               &amp;<a name='464'>
            nfrzdtr, nfrzdtc,                                     &amp;<a name='465'>
            taucon, lencon, lenconcr,                       &amp;<a name='466'>
            xlf, pfrzdtc, pfrzdtr, supice, alpha2, delta2, delta3 <a name='467'>
  REAL  :: vt2ave<a name='468'>
  REAL  :: holdc, holdci<a name='469'>
<font color=#447700>!<a name='470'></font>
  INTEGER :: i, j, k, mstepmax,                                                &amp;<a name='471'>
            iprt, latd, lond, loop, loops, ifsat, n, idim, kdim<a name='472'>
<font color=#447700>! Temporaries used for inlining fpvs function<a name='473'></font>
  REAL  :: dldti, xb, xai, tr, xbi, xa, hvap, cvap, hsub, dldt, ttp<a name='474'>
<font color=#447700>!<a name='475'></font>
<font color=#447700>!=================================================================<a name='476'></font>
<font color=#447700>!   compute internal functions<a name='477'></font>
<font color=#447700>!<a name='478'></font>
      cpmcal(x) = cpd*(1.-max(x,qmin))+max(x,qmin)*cpv<a name='479'>
      xlcal(x) = xlv0-xlv1*(x-t0c)<a name='480'>
<font color=#447700>!----------------------------------------------------------------<a name='481'></font>
<font color=#447700>!     size distributions: (x=mixing ratio, y=air density):<a name='482'></font>
<font color=#447700>!     valid for mixing ratio &gt; 1.e-9 kg/kg.<a name='483'></font>
<font color=#447700>!<a name='484'></font>
<font color=#447700>! Optimizatin : A**B =&gt; exp(log(A)*(B)) <a name='485'></font>
      lamdac(x,y,z)= exp(log(((pidnc*z)/(x*y)))*((.33333333)))<a name='486'>
<font color=#447700>!----------------------------------------------------------------<a name='487'></font>
<font color=#447700>!     diffus: diffusion coefficient of the water vapor<a name='488'></font>
<font color=#447700>!     viscos: kinematic viscosity(m2s-1)<a name='489'></font>
<font color=#447700>!<a name='490'></font>
      diffus(x,y) = 8.794e-5 * exp(log(x)*(1.81)) / y   <font color=#447700>! 8.794e-5*x**1.81/y<a name='491'></font>
      viscos(x,y) = 1.496e-6 * (x*sqrt(x)) /(x+120.)/y  <font color=#447700>! 1.496e-6*x**1.5/(x+120.)/y<a name='492'></font>
      xka(x,y) = 1.414e3*viscos(x,y)*y<a name='493'>
      diffac(a,b,c,d,e) = d*a*a/(xka(c,d)*rv*c*c)+1./(e*diffus(c,b))<a name='494'>
      venfac(a,b,c) = exp(log((viscos(b,c)/diffus(b,a)))*((.3333333)))         &amp;<a name='495'>
                     /sqrt(viscos(b,c))*sqrt(sqrt(den0/c))<a name='496'>
      conden(a,b,c,d,e) = (max(b,qmin)-c)/(1.+d*d/(rv*e)*c/(a*a))<a name='497'>
<font color=#447700>!<a name='498'></font>
      idim = ite-its+1<a name='499'>
      kdim = kte-kts+1<a name='500'>
<font color=#447700>!<a name='501'></font>
<font color=#447700>!----------------------------------------------------------------<a name='502'></font>
<font color=#447700>!     paddint 0 for negative values generated by dynamics<a name='503'></font>
<font color=#447700>!<a name='504'></font>
      do k = kts, kte<a name='505'>
        do i = its, ite<a name='506'>
          qci(i,k,1) = max(qci(i,k,1),0.0)<a name='507'>
          qrs(i,k,1) = max(qrs(i,k,1),0.0)<a name='508'>
          qci(i,k,2) = max(qci(i,k,2),0.0)<a name='509'>
          qrs(i,k,2) = max(qrs(i,k,2),0.0)<a name='510'>
          qrs(i,k,3) = max(qrs(i,k,3),0.0)<a name='511'>
          ncr(i,k,1) = max(ncr(i,k,1),0.0)<a name='512'>
          ncr(i,k,2) = max(ncr(i,k,2),0.0)<a name='513'>
          ncr(i,k,3) = max(ncr(i,k,3),0.0) <a name='514'>
        enddo<a name='515'>
      enddo<a name='516'>
<font color=#447700>!<a name='517'></font>
<font color=#447700>!----------------------------------------------------------------<a name='518'></font>
<font color=#447700>!     latent heat for phase changes and heat capacity. neglect the<a name='519'></font>
<font color=#447700>!     changes during microphysical process calculation<a name='520'></font>
<font color=#447700>!     emanuel(1994)<a name='521'></font>
<font color=#447700>!<a name='522'></font>
      do k = kts, kte<a name='523'>
        do i = its, ite<a name='524'>
          cpm(i,k) = cpmcal(q(i,k))<a name='525'>
          xl(i,k) = xlcal(t(i,k))<a name='526'>
        enddo<a name='527'>
      enddo<a name='528'>
      do k = kts, kte<a name='529'>
        do i = its, ite<a name='530'>
          delz_tmp(i,k) = delz(i,k)<a name='531'>
          den_tmp(i,k) = den(i,k)<a name='532'>
        enddo<a name='533'>
      enddo<a name='534'>
<font color=#447700>!<a name='535'></font>
<font color=#447700>!----------------------------------------------------------------<a name='536'></font>
<font color=#447700>!    initialize the surface rain, snow, graupel<a name='537'></font>
<font color=#447700>!<a name='538'></font>
      do i = its, ite<a name='539'>
        rainncv(i) = 0.<a name='540'>
        if(PRESENT (snowncv) .AND. PRESENT (snow)) snowncv(i) = 0.<a name='541'>
        if(PRESENT (graupelncv) .AND. PRESENT (graupel)) graupelncv(i) = 0.<a name='542'>
        sr(i) = 0.<a name='543'>
<font color=#447700>! new local array to catch step snow and graupel<a name='544'></font>
        tstepsnow(i) = 0.<a name='545'>
        tstepgraup(i) = 0.<a name='546'>
      enddo<a name='547'>
<font color=#447700>!<a name='548'></font>
<font color=#447700>!----------------------------------------------------------------<a name='549'></font>
<font color=#447700>!     compute the minor time steps.<a name='550'></font>
<font color=#447700>!<a name='551'></font>
      loops = max(nint(delt/dtcldcr),1)<a name='552'>
      dtcld = delt/loops<a name='553'>
      if(delt.le.dtcldcr) dtcld = delt<a name='554'>
<font color=#447700>!<a name='555'></font>
      do loop = 1,loops<a name='556'>
<font color=#447700>!<a name='557'></font>
<font color=#447700>!----------------------------------------------------------------<a name='558'></font>
<font color=#447700>!     initialize the large scale variables<a name='559'></font>
<font color=#447700>!<a name='560'></font>
      do i = its, ite<a name='561'>
        mstep(i) = 1<a name='562'>
        mnstep(i) = 1<a name='563'>
        flgcld(i) = .true.<a name='564'>
      enddo<a name='565'>
<font color=#447700>!<a name='566'></font>
      do k = kts, kte<a name='567'>
        CALL <A href='../../html_code/frame/libmassv.F.html#VREC'>VREC</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM62D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VREC_2">( tvec1(its), den(its,k), ite-its+1)<a name='568'>
        do i = its, ite<a name='569'>
          tvec1(i) = tvec1(i)*den0<a name='570'>
        enddo<a name='571'>
        CALL <A href='../../html_code/frame/libmassv.F.html#VSQRT'>VSQRT</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM62D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VSQRT_2">( denfac(its,k), tvec1(its), ite-its+1)<a name='572'>
      enddo<a name='573'>
<font color=#447700>!<a name='574'></font>
<font color=#447700>! Inline expansion for fpvs<a name='575'></font>
<font color=#447700>!         qs(i,k,1) = fpvs(t(i,k),0,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='576'></font>
<font color=#447700>!         qs(i,k,2) = fpvs(t(i,k),1,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='577'></font>
      hsub = xls<a name='578'>
      hvap = xlv0<a name='579'>
      cvap = cpv<a name='580'>
      ttp=t0c+0.01<a name='581'>
      dldt=cvap-cliq<a name='582'>
      xa=-dldt/rv<a name='583'>
      xb=xa+hvap/(rv*ttp)<a name='584'>
      dldti=cvap-cice<a name='585'>
      xai=-dldti/rv<a name='586'>
      xbi=xai+hsub/(rv*ttp)<a name='587'>
      do k = kts, kte<a name='588'>
        do i = its, ite<a name='589'>
          tr=ttp/t(i,k)<a name='590'>
          qs(i,k,1)=psat*exp(log(tr)*(xa))*exp(xb*(1.-tr))<a name='591'>
          qs(i,k,1) = min(qs(i,k,1),0.99*p(i,k))<a name='592'>
          qs(i,k,1) = ep2 * qs(i,k,1) / (p(i,k) - qs(i,k,1))<a name='593'>
          qs(i,k,1) = max(qs(i,k,1),qmin)<a name='594'>
          rh(i,k,1) = max(q(i,k) / qs(i,k,1),qmin)<a name='595'>
          tr=ttp/t(i,k)<a name='596'>
          if(t(i,k).lt.ttp) then<a name='597'>
            qs(i,k,2)=psat*exp(log(tr)*(xai))*exp(xbi*(1.-tr))<a name='598'>
          else<a name='599'>
            qs(i,k,2)=psat*exp(log(tr)*(xa))*exp(xb*(1.-tr))<a name='600'>
          endif<a name='601'>
          qs(i,k,2) = min(qs(i,k,2),0.99*p(i,k))<a name='602'>
          qs(i,k,2) = ep2 * qs(i,k,2) / (p(i,k) - qs(i,k,2))<a name='603'>
          qs(i,k,2) = max(qs(i,k,2),qmin)<a name='604'>
          rh(i,k,2) = max(q(i,k) / qs(i,k,2),qmin)<a name='605'>
        enddo<a name='606'>
      enddo<a name='607'>
<font color=#447700>!<a name='608'></font>
<font color=#447700>!----------------------------------------------------------------<a name='609'></font>
<font color=#447700>!     initialize the variables for microphysical physics<a name='610'></font>
<font color=#447700>!<a name='611'></font>
<font color=#447700>!<a name='612'></font>
      do k = kts, kte<a name='613'>
        do i = its, ite<a name='614'>
          prevp(i,k) = 0.<a name='615'>
          psdep(i,k) = 0.<a name='616'>
          pgdep(i,k) = 0.<a name='617'>
          praut(i,k) = 0.<a name='618'>
          psaut(i,k) = 0.<a name='619'>
          pgaut(i,k) = 0.<a name='620'>
          pracw(i,k) = 0.<a name='621'>
          praci(i,k) = 0.<a name='622'>
          piacr(i,k) = 0.<a name='623'>
          psaci(i,k) = 0.<a name='624'>
          psacw(i,k) = 0.<a name='625'>
          pracs(i,k) = 0.<a name='626'>
          psacr(i,k) = 0.<a name='627'>
          pgacw(i,k) = 0.<a name='628'>
          paacw(i,k) = 0.<a name='629'>
          pgaci(i,k) = 0.<a name='630'>
          pgacr(i,k) = 0.<a name='631'>
          pgacs(i,k) = 0.<a name='632'>
          pigen(i,k) = 0.<a name='633'>
          pidep(i,k) = 0.<a name='634'>
          pcond(i,k) = 0.<a name='635'>
          psmlt(i,k) = 0.<a name='636'>
          pgmlt(i,k) = 0.<a name='637'>
          pseml(i,k) = 0.<a name='638'>
          pgeml(i,k) = 0.<a name='639'>
          psevp(i,k) = 0.<a name='640'>
          pgevp(i,k) = 0.<a name='641'>
          pcact(i,k) = 0.<a name='642'>
          falk(i,k,1) = 0.<a name='643'>
          falk(i,k,2) = 0.<a name='644'>
          falk(i,k,3) = 0.<a name='645'>
          fall(i,k,1) = 0.<a name='646'>
          fall(i,k,2) = 0.<a name='647'>
          fall(i,k,3) = 0.<a name='648'>
          fallc(i,k) = 0.<a name='649'>
          falkc(i,k) = 0.<a name='650'>
          falln(i,k) =0.<a name='651'>
          falkn(i,k) =0.<a name='652'>
          xni(i,k) = 1.e3<a name='653'>
          nsacw(i,k) = 0.<a name='654'>
          ngacw(i,k) = 0.<a name='655'>
          naacw(i,k) = 0.<a name='656'>
          niacr(i,k) = 0.<a name='657'>
          nsacr(i,k) = 0.<a name='658'>
          ngacr(i,k) = 0.<a name='659'>
          nseml(i,k) = 0.<a name='660'>
          ngeml(i,k) = 0.<a name='661'>
          nracw(i,k) = 0.<a name='662'>
          nccol(i,k) = 0.<a name='663'>
          nrcol(i,k) = 0.<a name='664'>
          ncact(i,k) = 0.<a name='665'>
          nraut(i,k) = 0.<a name='666'>
          ncevp(i,k) = 0.<a name='667'>
        enddo<a name='668'>
      enddo<a name='669'>
      do k = kts, kte<a name='670'>
        do i = its, ite<a name='671'>
          if(qci(i,k,1).le.qmin .or. ncr(i,k,2).le.ncmin ) then<a name='672'>
            rslopec(i,k) = rslopecmax<a name='673'>
            rslopec2(i,k) = rslopec2max<a name='674'>
            rslopec3(i,k) = rslopec3max<a name='675'>
          else<a name='676'>
            rslopec(i,k) = 1./lamdac(qci(i,k,1),den(i,k),ncr(i,k,2))<a name='677'>
            rslopec2(i,k) = rslopec(i,k)*rslopec(i,k)<a name='678'>
            rslopec3(i,k) = rslopec2(i,k)*rslopec(i,k)<a name='679'>
          endif<a name='680'>
<font color=#447700>!-------------------------------------------------------------<a name='681'></font>
<font color=#447700>! Ni: ice crystal number concentraiton   [HDC 5c]<a name='682'></font>
<font color=#447700>!-------------------------------------------------------------<a name='683'></font>
          temp = (den(i,k)*max(qci(i,k,2),qmin))<a name='684'>
          temp = sqrt(sqrt(temp*temp*temp))<a name='685'>
          xni(i,k) = min(max(5.38e7*temp,1.e3),1.e6)<a name='686'>
        enddo<a name='687'>
      enddo<a name='688'>
<font color=#447700>!----------------------------------------------------------------<a name='689'></font>
<font color=#447700>!     compute the fallout term:<a name='690'></font>
<font color=#447700>!     first, vertical terminal velosity for minor loops<a name='691'></font>
<font color=#447700>!----------------------------------------------------------------<a name='692'></font>
      do k = kts, kte<a name='693'>
        do i = its, ite<a name='694'>
          qrs_tmp(i,k,1) = qrs(i,k,1)<a name='695'>
          qrs_tmp(i,k,2) = qrs(i,k,2)<a name='696'>
          qrs_tmp(i,k,3) = qrs(i,k,3)<a name='697'>
          ncr_tmp(i,k) = ncr(i,k,3)<a name='698'>
        enddo<a name='699'>
      enddo<a name='700'>
      call <A href='../../html_code/phys/module_mp_wdm6.F.html#SLOPE_WDM6'>slope_wdm6</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM62D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_WDM6_1">(qrs_tmp,ncr_tmp,den_tmp,denfac,t,rslope,rslopeb,rslope2, &amp; <a name='701'>
                     rslope3,work1,workn,its,ite,kts,kte)<a name='702'>
<font color=#447700>!<a name='703'></font>
<font color=#447700>! vt update for qr and nr<a name='704'></font>
      mstepmax = 1<a name='705'>
      numdt = 1<a name='706'>
      do k = kte, kts, -1<a name='707'>
        do i = its, ite<a name='708'>
          work1(i,k,1) = work1(i,k,1)/delz(i,k)<a name='709'>
          workn(i,k) = workn(i,k)/delz(i,k)<a name='710'>
          numdt(i) = max(nint(max(work1(i,k,1),workn(i,k))*dtcld+.5),1)<a name='711'>
          if(numdt(i).ge.mstep(i)) mstep(i) = numdt(i)<a name='712'>
        enddo<a name='713'>
      enddo<a name='714'>
      do i = its, ite<a name='715'>
        if(mstepmax.le.mstep(i)) mstepmax = mstep(i)<a name='716'>
      enddo<a name='717'>
<font color=#447700>!<a name='718'></font>
      do n = 1, mstepmax<a name='719'>
        k = kte<a name='720'>
        do i = its, ite<a name='721'>
          if(n.le.mstep(i)) then<a name='722'>
            falk(i,k,1) = den(i,k)*qrs(i,k,1)*work1(i,k,1)/mstep(i)<a name='723'>
            falkn(i,k) = ncr(i,k,3)*workn(i,k)/mstep(i)<a name='724'>
            fall(i,k,1) = fall(i,k,1)+falk(i,k,1)<a name='725'>
            falln(i,k) = falln(i,k)+falkn(i,k)<a name='726'>
            qrs(i,k,1) = max(qrs(i,k,1)-falk(i,k,1)*dtcld/den(i,k),0.)<a name='727'>
            ncr(i,k,3) = max(ncr(i,k,3)-falkn(i,k)*dtcld,0.)<a name='728'>
          endif<a name='729'>
        enddo<a name='730'>
        do k = kte-1, kts, -1<a name='731'>
          do i = its, ite<a name='732'>
            if(n.le.mstep(i)) then<a name='733'>
              falk(i,k,1) = den(i,k)*qrs(i,k,1)*work1(i,k,1)/mstep(i)<a name='734'>
              falkn(i,k) = ncr(i,k,3)*workn(i,k)/mstep(i)<a name='735'>
              fall(i,k,1) = fall(i,k,1)+falk(i,k,1)<a name='736'>
              falln(i,k) = falln(i,k)+falkn(i,k)<a name='737'>
              qrs(i,k,1) = max(qrs(i,k,1)-(falk(i,k,1)-falk(i,k+1,1)           &amp;<a name='738'>
                          *delz(i,k+1)/delz(i,k))*dtcld/den(i,k),0.)<a name='739'>
              ncr(i,k,3) = max(ncr(i,k,3)-(falkn(i,k)-falkn(i,k+1)*delz(i,k+1) &amp;<a name='740'>
                          /delz(i,k))*dtcld,0.)<a name='741'>
            endif<a name='742'>
          enddo<a name='743'>
        enddo<a name='744'>
        do k = kts, kte<a name='745'>
          do i = its, ite<a name='746'>
            qrs_tmp(i,k,1) = qrs(i,k,1)<a name='747'>
            ncr_tmp(i,k) = ncr(i,k,3)<a name='748'>
          enddo<a name='749'>
        enddo<a name='750'>
        call <A href='../../html_code/phys/module_mp_wsm6.F.html#SLOPE_RAIN'>slope_rain</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM62D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_RAIN_2">(qrs_tmp,ncr_tmp,den_tmp,denfac,t,rslope,rslopeb,rslope2, &amp;<a name='751'>
                     rslope3,work1,workn,its,ite,kts,kte)<a name='752'>
        do k = kte, kts, -1<a name='753'>
          do i = its, ite<a name='754'>
            work1(i,k,1) = work1(i,k,1)/delz(i,k)<a name='755'>
            workn(i,k) = workn(i,k)/delz(i,k)<a name='756'>
          enddo<a name='757'>
        enddo<a name='758'>
      enddo<a name='759'>
<font color=#447700>! for semi<a name='760'></font>
      do k = kte, kts, -1<a name='761'>
        do i = its, ite<a name='762'>
          qsum(i,k) = max( (qrs(i,k,2)+qrs(i,k,3)), 1.E-15)<a name='763'>
          if(qsum(i,k) .gt. 1.e-15 ) then<a name='764'>
            worka(i,k) = (work1(i,k,2)*qrs(i,k,2) + work1(i,k,3)*qrs(i,k,3)) &amp;<a name='765'>
                      /qsum(i,k)<a name='766'>
          else<a name='767'>
            worka(i,k) = 0.<a name='768'>
          endif<a name='769'>
          denqrs2(i,k) = den(i,k)*qrs(i,k,2)<a name='770'>
          denqrs3(i,k) = den(i,k)*qrs(i,k,3)<a name='771'>
        enddo<a name='772'>
      enddo<a name='773'>
      call <A href='../../html_code/phys/module_mp_wsm6.F.html#NISLFV_RAIN_PLM6'>nislfv_rain_plm6</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM62D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NISLFV_RAIN_PLM6_1">(idim,kdim,den_tmp,denfac,t,delz_tmp,worka,         &amp;<a name='774'>
                           denqrs2,denqrs3,delqrs2,delqrs3,dtcld,1,1)<a name='775'>
      do k = kts, kte<a name='776'>
        do i = its, ite<a name='777'>
          qrs(i,k,2) = max(denqrs2(i,k)/den(i,k),0.)<a name='778'>
          qrs(i,k,3) = max(denqrs3(i,k)/den(i,k),0.)<a name='779'>
          fall(i,k,2) = denqrs2(i,k)*worka(i,k)/delz(i,k)<a name='780'>
          fall(i,k,3) = denqrs3(i,k)*worka(i,k)/delz(i,k)<a name='781'>
        enddo<a name='782'>
      enddo<a name='783'>
      do i = its, ite<a name='784'>
        fall(i,1,2) = delqrs2(i)/delz(i,1)/dtcld<a name='785'>
        fall(i,1,3) = delqrs3(i)/delz(i,1)/dtcld<a name='786'>
      enddo<a name='787'>
      do k = kts, kte<a name='788'>
        do i = its, ite<a name='789'>
          qrs_tmp(i,k,1) = qrs(i,k,1)<a name='790'>
          qrs_tmp(i,k,2) = qrs(i,k,2)<a name='791'>
          qrs_tmp(i,k,3) = qrs(i,k,3)<a name='792'>
          ncr_tmp(i,k) = ncr(i,k,3)<a name='793'>
        enddo<a name='794'>
      enddo<a name='795'>
      call <A href='../../html_code/phys/module_mp_wdm6.F.html#SLOPE_WDM6'>slope_wdm6</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM62D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_WDM6_2">(qrs_tmp,ncr_tmp,den_tmp,denfac,t,rslope,rslopeb,rslope2, &amp;<a name='796'>
                     rslope3,work1,workn,its,ite,kts,kte)<a name='797'>
<font color=#447700>!<a name='798'></font>
      do k = kte, kts, -1<a name='799'>
        do i = its, ite<a name='800'>
          supcol = t0c-t(i,k)<a name='801'>
          n0sfac(i,k) = max(min(exp(alpha*supcol),n0smax/n0s),1.)<a name='802'>
          if(t(i,k).gt.t0c) then<a name='803'>
<font color=#447700>!---------------------------------------------------------------<a name='804'></font>
<font color=#447700>! psmlt: melting of snow [HL A33] [RH83 A25]<a name='805'></font>
<font color=#447700>!       (T&gt;T0: QS-&gt;QR)<a name='806'></font>
<font color=#447700>!---------------------------------------------------------------<a name='807'></font>
            xlf = xlf0<a name='808'>
            work2(i,k) = venfac(p(i,k),t(i,k),den(i,k))<a name='809'>
            if(qrs(i,k,2).gt.0.) then<a name='810'>
              coeres = rslope2(i,k,2)*sqrt(rslope(i,k,2)*rslopeb(i,k,2))<a name='811'>
              psmlt(i,k) = xka(t(i,k),den(i,k))/xlf*(t0c-t(i,k))*pi/2.       &amp;<a name='812'>
                         *n0sfac(i,k)*(precs1*rslope2(i,k,2)                 &amp;<a name='813'>
                         +precs2*work2(i,k)*coeres)/den(i,k)                  <a name='814'>
              psmlt(i,k) = min(max(psmlt(i,k)*dtcld/mstep(i),-qrs(i,k,2)     &amp;<a name='815'>
                         /mstep(i)),0.)<a name='816'>
              qrs(i,k,2) = qrs(i,k,2) + psmlt(i,k)<a name='817'>
              qrs(i,k,1) = qrs(i,k,1) - psmlt(i,k)<a name='818'>
<font color=#447700>!-------------------------------------------------------------------<a name='819'></font>
<font color=#447700>! nsmlt: melting of snow [LH A27]<a name='820'></font>
<font color=#447700>!       (T&gt;T0: -&gt;NR)<a name='821'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='822'></font>
              if(qrs(i,k,2).gt.qcrmin) then<a name='823'>
                sfac = rslope(i,k,2)*n0s*n0sfac(i,k)/qrs(i,k,2)<a name='824'>
                ncr(i,k,3) = ncr(i,k,3) - sfac*psmlt(i,k)<a name='825'>
              endif<a name='826'>
              t(i,k) = t(i,k) + xlf/cpm(i,k)*psmlt(i,k)<a name='827'>
            endif<a name='828'>
<font color=#447700>!---------------------------------------------------------------<a name='829'></font>
<font color=#447700>! pgmlt: melting of graupel [HL A23]  [LFO 47]<a name='830'></font>
<font color=#447700>!       (T&gt;T0: QG-&gt;QR)<a name='831'></font>
<font color=#447700>!---------------------------------------------------------------<a name='832'></font>
            if(qrs(i,k,3).gt.0.) then<a name='833'>
              coeres = rslope2(i,k,3)*sqrt(rslope(i,k,3)*rslopeb(i,k,3))<a name='834'>
              pgmlt(i,k) = xka(t(i,k),den(i,k))/xlf*(t0c-t(i,k))*(precg1     &amp;<a name='835'>
                           *rslope2(i,k,3) + precg2*work2(i,k)*coeres)       &amp;<a name='836'>
                           /den(i,k)                                          <a name='837'>
              pgmlt(i,k) = min(max(pgmlt(i,k)*dtcld/mstep(i),                &amp;<a name='838'>
                          -qrs(i,k,3)/mstep(i)),0.)<a name='839'>
              qrs(i,k,3) = qrs(i,k,3) + pgmlt(i,k)<a name='840'>
              qrs(i,k,1) = qrs(i,k,1) - pgmlt(i,k)<a name='841'>
<font color=#447700>!-------------------------------------------------------------------<a name='842'></font>
<font color=#447700>! ngmlt: melting of graupel [LH A28]<a name='843'></font>
<font color=#447700>!       (T&gt;T0: -&gt;NR)<a name='844'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='845'></font>
              if(qrs(i,k,3).gt.qcrmin) then<a name='846'>
                gfac = rslope(i,k,3)*n0g/qrs(i,k,3)<a name='847'>
                ncr(i,k,3) = ncr(i,k,3) - gfac*pgmlt(i,k)<a name='848'>
              endif<a name='849'>
              t(i,k) = t(i,k) + xlf/cpm(i,k)*pgmlt(i,k)<a name='850'>
            endif<a name='851'>
          endif<a name='852'>
        enddo<a name='853'>
      enddo<a name='854'>
<font color=#447700>!---------------------------------------------------------------<a name='855'></font>
<font color=#447700>! Vice [ms-1] : fallout of ice crystal [HDC 5a]<a name='856'></font>
<font color=#447700>!---------------------------------------------------------------<a name='857'></font>
      do k = kte, kts, -1<a name='858'>
        do i = its, ite<a name='859'>
          if(qci(i,k,2).le.0.) then<a name='860'>
            work1c(i,k) = 0.<a name='861'>
          else<a name='862'>
            xmi = den(i,k)*qci(i,k,2)/xni(i,k)<a name='863'>
            diameter  = max(min(dicon * sqrt(xmi),dimax), 1.e-25)<a name='864'>
            work1c(i,k) = 1.49e4*exp(log(diameter)*(1.31))<a name='865'>
          endif<a name='866'>
        enddo<a name='867'>
      enddo<a name='868'>
<font color=#447700>!<a name='869'></font>
<font color=#447700>!  forward semi-laglangian scheme (JH), PCM (piecewise constant),  (linear)<a name='870'></font>
<font color=#447700>!<a name='871'></font>
      do k = kte, kts, -1<a name='872'>
        do i = its, ite<a name='873'>
          denqci(i,k) = den(i,k)*qci(i,k,2)<a name='874'>
        enddo<a name='875'>
      enddo<a name='876'>
      call <A href='../../html_code/phys/module_mp_wdm6.F.html#NISLFV_RAIN_PLMR'>nislfv_rain_plmr</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM62D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NISLFV_RAIN_PLMR_1">(idim,kdim,den_tmp,denfac,t,delz_tmp,work1c,denqci,denqci,  &amp;<a name='877'>
                           delqi,dtcld,1,0,0)<a name='878'>
      do k = kts, kte<a name='879'>
        do i = its, ite<a name='880'>
          qci(i,k,2) = max(denqci(i,k)/den(i,k),0.)<a name='881'>
        enddo<a name='882'>
      enddo<a name='883'>
      do i = its, ite<a name='884'>
        fallc(i,1) = delqi(i)/delz(i,1)/dtcld<a name='885'>
      enddo<a name='886'>
<font color=#447700>!<a name='887'></font>
<font color=#447700>!----------------------------------------------------------------<a name='888'></font>
<font color=#447700>!      rain (unit is mm/sec;kgm-2s-1: /1000*delt ===&gt; m)==&gt; mm for wrf<a name='889'></font>
<font color=#447700>!<a name='890'></font>
      do i = its, ite<a name='891'>
        fallsum = fall(i,kts,1)+fall(i,kts,2)+fall(i,kts,3)+fallc(i,kts)<a name='892'>
        fallsum_qsi = fall(i,kts,2)+fallc(i,kts)<a name='893'>
        fallsum_qg = fall(i,kts,3)<a name='894'>
        if(fallsum.gt.0.) then<a name='895'>
          rainncv(i) = fallsum*delz(i,kts)/denr*dtcld*1000. + rainncv(i)<a name='896'>
          rain(i) = fallsum*delz(i,kts)/denr*dtcld*1000. + rain(i)<a name='897'>
        endif<a name='898'>
        If(fallsum_qsi.gt.0.) then<a name='899'>
          tstepsnow(i) = fallsum_qsi*delz(i,kts)/denr*dtcld*1000. + tstepsnow(i)<a name='900'>
          IF( PRESENT (snowncv) .AND. PRESENT (snow)) THEN<a name='901'>
            snowncv(i) = fallsum_qsi*delz(i,kts)/denr*dtcld*1000. + snowncv(i)     <a name='902'>
            snow(i) = fallsum_qsi*delz(i,kts)/denr*dtcld*1000. + snow(i)<a name='903'>
          ENDIF<a name='904'>
        ENDIF<a name='905'>
        IF(fallsum_qg.gt.0.) then<a name='906'>
          tstepgraup(i) = fallsum_qg*delz(i,kts)/denr*dtcld*1000.              &amp;<a name='907'>
                            + tstepgraup(i)<a name='908'>
          IF( PRESENT (graupelncv) .AND. PRESENT (graupel)) THEN<a name='909'>
            graupelncv(i) = fallsum_qg*delz(i,kts)/denr*dtcld*1000.            &amp;  <a name='910'>
                            + graupelncv(i)<a name='911'>
            graupel(i) = fallsum_qg*delz(i,kts)/denr*dtcld*1000. + graupel(i)<a name='912'>
          ENDIF<a name='913'>
        ENDIF<a name='914'>
        IF ( PRESENT (snowncv)) THEN<a name='915'>
          if(fallsum.gt.0.)sr(i)=(snowncv(i) + graupelncv(i))/(rainncv(i)+1.e-12)<a name='916'>
        ELSE<a name='917'>
          if(fallsum.gt.0.)sr(i)=(tstepsnow(i) + tstepgraup(i))/(rainncv(i)+1.e-12)<a name='918'>
        ENDIF<a name='919'>
      enddo<a name='920'>
<font color=#447700>!<a name='921'></font>
<font color=#447700>!---------------------------------------------------------------<a name='922'></font>
<font color=#447700>! pimlt: instantaneous melting of cloud ice [HL A47] [RH83 A28]<a name='923'></font>
<font color=#447700>!       (T&gt;T0: QI-&gt;QC)<a name='924'></font>
<font color=#447700>!---------------------------------------------------------------<a name='925'></font>
      do k = kts, kte<a name='926'>
        do i = its, ite<a name='927'>
          supcol = t0c-t(i,k)<a name='928'>
          xlf = xls-xl(i,k)<a name='929'>
          if(supcol.lt.0.) xlf = xlf0<a name='930'>
          if(supcol.lt.0 .and. qci(i,k,2).gt.0.) then<a name='931'>
            qci(i,k,1) = qci(i,k,1) + qci(i,k,2)<a name='932'>
<font color=#447700>!---------------------------------------------------------------<a name='933'></font>
<font color=#447700>! nimlt: instantaneous melting of cloud ice  [LH A18]<a name='934'></font>
<font color=#447700>!        (T&gt;T0: -&gt;NC)<a name='935'></font>
<font color=#447700>!--------------------------------------------------------------<a name='936'></font>
            ncr(i,k,2) = ncr(i,k,2) + xni(i,k)<a name='937'>
            t(i,k) = t(i,k) - xlf/cpm(i,k)*qci(i,k,2)<a name='938'>
            qci(i,k,2) = 0.<a name='939'>
          endif<a name='940'>
<font color=#447700>!---------------------------------------------------------------<a name='941'></font>
<font color=#447700>! pihmf: homogeneous  of cloud water below -40c [HL A45]<a name='942'></font>
<font color=#447700>!        (T&lt;-40C: QC-&gt;QI)<a name='943'></font>
<font color=#447700>!---------------------------------------------------------------<a name='944'></font>
          if(supcol.gt.40. .and. qci(i,k,1).gt.0.) then<a name='945'>
            qci(i,k,2) = qci(i,k,2) + qci(i,k,1)<a name='946'>
<font color=#447700>!---------------------------------------------------------------<a name='947'></font>
<font color=#447700>! nihmf: homogeneous  of cloud water below -40c [LH A17]<a name='948'></font>
<font color=#447700>!        (T&lt;-40C: NC-&gt;) <a name='949'></font>
<font color=#447700>!---------------------------------------------------------------<a name='950'></font>
            if(ncr(i,k,2).gt.0.) ncr(i,k,2) = 0. <a name='951'>
            t(i,k) = t(i,k) + xlf/cpm(i,k)*qci(i,k,1)<a name='952'>
            qci(i,k,1) = 0.<a name='953'>
          endif<a name='954'>
<font color=#447700>!---------------------------------------------------------------<a name='955'></font>
<font color=#447700>! pihtf: heterogeneous  of cloud water [HL A44]<a name='956'></font>
<font color=#447700>!        (T0&gt;T&gt;-40C: QC-&gt;QI)<a name='957'></font>
<font color=#447700>!---------------------------------------------------------------<a name='958'></font>
          if(supcol.gt.0. .and. qci(i,k,1).gt.qmin) then<a name='959'>
            supcolt=min(supcol,70.)<a name='960'>
            pfrzdtc = min(pi*pi*pfrz1*(exp(pfrz2*supcolt)-1.)*denr/den(i,k)    &amp; <a name='961'>
                     *ncr(i,k,2)*rslopec3(i,k)*rslopec3(i,k)/18.*dtcld         &amp;<a name='962'>
                     ,qci(i,k,1))<a name='963'>
<font color=#447700>!---------------------------------------------------------------<a name='964'></font>
<font color=#447700>! nihtf: heterogeneous  of cloud water [LH A16]<a name='965'></font>
<font color=#447700>!         (T0&gt;T&gt;-40C: NC-&gt;) <a name='966'></font>
<font color=#447700>!---------------------------------------------------------------<a name='967'></font>
            if(ncr(i,k,2).gt.ncmin) then<a name='968'>
              nfrzdtc = min(pi*pfrz1*(exp(pfrz2*supcolt)-1.)*ncr(i,k,2)        &amp;<a name='969'>
                      *rslopec3(i,k)/6.*dtcld,ncr(i,k,2))<a name='970'>
              ncr(i,k,2) = ncr(i,k,2) - nfrzdtc<a name='971'>
            endif<a name='972'>
            qci(i,k,2) = qci(i,k,2) + pfrzdtc<a name='973'>
            t(i,k) = t(i,k) + xlf/cpm(i,k)*pfrzdtc<a name='974'>
            qci(i,k,1) = qci(i,k,1)-pfrzdtc<a name='975'>
          endif <a name='976'>
<font color=#447700>!---------------------------------------------------------------<a name='977'></font>
<font color=#447700>! pgfrz:  freezing of rain water [HL A20] [LFO 45]<a name='978'></font>
<font color=#447700>!        (T&lt;T0, QR-&gt;QG)<a name='979'></font>
<font color=#447700>!---------------------------------------------------------------<a name='980'></font>
          if(supcol.gt.0. .and. qrs(i,k,1).gt.0.) then<a name='981'>
            supcolt=min(supcol,70.)<a name='982'>
            pfrzdtr = min(140.*(pi*pi)*pfrz1*ncr(i,k,3)*denr/den(i,k)          &amp;<a name='983'>
                  *(exp(pfrz2*supcolt)-1.)*rslope3(i,k,1)*rslope3(i,k,1)       &amp; <a name='984'>
                  *dtcld,qrs(i,k,1))        <a name='985'>
<font color=#447700>!---------------------------------------------------------------<a name='986'></font>
<font color=#447700>! ngfrz: freezing of rain water [LH A26]<a name='987'></font>
<font color=#447700>!        (T&lt;T0, NR-&gt; ) <a name='988'></font>
<font color=#447700>!---------------------------------------------------------------<a name='989'></font>
            if(ncr(i,k,3).gt.nrmin) then<a name='990'>
              nfrzdtr = min(4.*pi*pfrz1*ncr(i,k,3)*(exp(pfrz2*supcolt)-1.)     &amp;<a name='991'>
                       *rslope3(i,k,1)*dtcld, ncr(i,k,3)) <a name='992'>
              ncr(i,k,3) = ncr(i,k,3) - nfrzdtr<a name='993'>
            endif<a name='994'>
            qrs(i,k,3) = qrs(i,k,3) + pfrzdtr<a name='995'>
            t(i,k) = t(i,k) + xlf/cpm(i,k)*pfrzdtr<a name='996'>
            qrs(i,k,1) = qrs(i,k,1) - pfrzdtr<a name='997'>
          endif<a name='998'>
        enddo<a name='999'>
      enddo<a name='1000'>
<font color=#447700>!<a name='1001'></font>
      do k = kts, kte<a name='1002'>
        do i = its, ite<a name='1003'>
          ncr(i,k,2) = max(ncr(i,k,2),0.0)<a name='1004'>
          ncr(i,k,3) = max(ncr(i,k,3),0.0)<a name='1005'>
        enddo<a name='1006'>
      enddo<a name='1007'>
<font color=#447700>!<a name='1008'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1009'></font>
<font color=#447700>!     update the slope parameters for microphysics computation<a name='1010'></font>
<font color=#447700>!<a name='1011'></font>
      do k = kts, kte<a name='1012'>
        do i = its, ite<a name='1013'>
          qrs_tmp(i,k,1) = qrs(i,k,1)<a name='1014'>
          qrs_tmp(i,k,2) = qrs(i,k,2)<a name='1015'>
          qrs_tmp(i,k,3) = qrs(i,k,3)<a name='1016'>
          ncr_tmp(i,k) = ncr(i,k,3)<a name='1017'>
        enddo<a name='1018'>
      enddo<a name='1019'>
      call <A href='../../html_code/phys/module_mp_wdm6.F.html#SLOPE_WDM6'>slope_wdm6</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM62D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_WDM6_3">(qrs_tmp,ncr_tmp,den_tmp,denfac,t,rslope,rslopeb,rslope2, &amp;<a name='1020'>
                     rslope3,work1,workn,its,ite,kts,kte)<a name='1021'>
      do k = kts, kte<a name='1022'>
        do i = its, ite<a name='1023'>
<font color=#447700>!-----------------------------------------------------------------<a name='1024'></font>
<font color=#447700>! compute the mean-volume drop diameter                  [LH A10] <a name='1025'></font>
<font color=#447700>! for raindrop distribution                          <a name='1026'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='1027'></font>
          avedia(i,k,2) = rslope(i,k,1)*((24.)**(.3333333))<a name='1028'>
<font color=#447700>!<a name='1029'></font>
          if(qci(i,k,1).le.qmin .or. ncr(i,k,2).le.ncmin) then<a name='1030'>
            rslopec(i,k) = rslopecmax<a name='1031'>
            rslopec2(i,k) = rslopec2max<a name='1032'>
            rslopec3(i,k) = rslopec3max<a name='1033'>
          else<a name='1034'>
            rslopec(i,k) = 1./lamdac(qci(i,k,1),den(i,k),ncr(i,k,2))<a name='1035'>
            rslopec2(i,k) = rslopec(i,k)*rslopec(i,k)<a name='1036'>
            rslopec3(i,k) = rslopec2(i,k)*rslopec(i,k)<a name='1037'>
          endif<a name='1038'>
<font color=#447700>!--------------------------------------------------------------------<a name='1039'></font>
<font color=#447700>! compute the mean-volume drop diameter                   [LH A7]<a name='1040'></font>
<font color=#447700>! for cloud-droplet distribution<a name='1041'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='1042'></font>
          avedia(i,k,1) = rslopec(i,k)<a name='1043'>
        enddo<a name='1044'>
      enddo<a name='1045'>
<font color=#447700>!<a name='1046'></font>
      do k = kts, kte<a name='1047'>
        do i = its, ite<a name='1048'>
          work1(i,k,1) = diffac(xl(i,k),p(i,k),t(i,k),den(i,k),qs(i,k,1))<a name='1049'>
          work1(i,k,2) = diffac(xls,p(i,k),t(i,k),den(i,k),qs(i,k,2))<a name='1050'>
          work2(i,k) = venfac(p(i,k),t(i,k),den(i,k))<a name='1051'>
        enddo<a name='1052'>
      enddo<a name='1053'>
<font color=#447700>!<a name='1054'></font>
<font color=#447700>!===============================================================<a name='1055'></font>
<font color=#447700>!<a name='1056'></font>
<font color=#447700>! warm rain processes<a name='1057'></font>
<font color=#447700>!<a name='1058'></font>
<font color=#447700>! - follows the double-moment processes in Lim and Hong<a name='1059'></font>
<font color=#447700>!<a name='1060'></font>
<font color=#447700>!===============================================================<a name='1061'></font>
<font color=#447700>!<a name='1062'></font>
      do k = kts, kte<a name='1063'>
        do i = its, ite<a name='1064'>
          supsat = max(q(i,k),qmin)-qs(i,k,1)<a name='1065'>
          satdt = supsat/dtcld<a name='1066'>
<font color=#447700>!---------------------------------------------------------------<a name='1067'></font>
<font color=#447700>! praut: auto conversion rate from cloud to rain  [LH 9] [CP 17]<a name='1068'></font>
<font color=#447700>!        (QC-&gt;QR)<a name='1069'></font>
<font color=#447700>!--------------------------------------------------------------<a name='1070'></font>
          lencon  = 2.7e-2*den(i,k)*qci(i,k,1)*(1.e20/16.*rslopec2(i,k)        &amp;<a name='1071'>
                   *rslopec2(i,k)-0.4)<a name='1072'>
          lenconcr = max(1.2*lencon, qcrmin)<a name='1073'>
          if(avedia(i,k,1).gt.di15) then<a name='1074'>
            taucon = 3.7/den(i,k)/qci(i,k,1)/(0.5e6*rslopec(i,k)-7.5)<a name='1075'>
            taucon = max(taucon, 1.e-12)<a name='1076'>
            praut(i,k) = lencon/(taucon*den(i,k))<a name='1077'>
            praut(i,k) = min(max(praut(i,k),0.),qci(i,k,1)/dtcld)<a name='1078'>
<font color=#447700>!---------------------------------------------------------------<a name='1079'></font>
<font color=#447700>! nraut: auto conversion rate from cloud to rain [LH A6] [CP 18 &amp; 19]<a name='1080'></font>
<font color=#447700>!        (NC-&gt;NR)<a name='1081'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1082'></font>
            nraut(i,k) = 3.5e9*den(i,k)*praut(i,k)<a name='1083'>
            if(qrs(i,k,1).gt.lenconcr)                                         &amp;<a name='1084'>
            nraut(i,k) = ncr(i,k,3)/qrs(i,k,1)*praut(i,k)<a name='1085'>
            nraut(i,k) = min(nraut(i,k),ncr(i,k,2)/dtcld)<a name='1086'>
          endif<a name='1087'>
<font color=#447700>!---------------------------------------------------------------<a name='1088'></font>
<font color=#447700>! pracw: accretion of cloud water by rain     [LH 10] [CP 22 &amp; 23]<a name='1089'></font>
<font color=#447700>!        (QC-&gt;QR)<a name='1090'></font>
<font color=#447700>! nracw: accretion of cloud water by rain     [LH A9]<a name='1091'></font>
<font color=#447700>!        (NC-&gt;)<a name='1092'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1093'></font>
          if(qrs(i,k,1).ge.lenconcr) then<a name='1094'>
            if(avedia(i,k,2).ge.di100) then<a name='1095'>
              nracw(i,k) = min(ncrk1*ncr(i,k,2)*ncr(i,k,3)*(rslopec3(i,k)      &amp;<a name='1096'>
                         + 24.*rslope3(i,k,1)),ncr(i,k,2)/dtcld)<a name='1097'>
              pracw(i,k) = min(pi/6.*(denr/den(i,k))*ncrk1*ncr(i,k,2)          &amp;<a name='1098'>
                         *ncr(i,k,3)*rslopec3(i,k)*(2.*rslopec3(i,k)           &amp;<a name='1099'>
                         + 24.*rslope3(i,k,1)),qci(i,k,1)/dtcld)   <a name='1100'>
            else<a name='1101'>
              nracw(i,k) = min(ncrk2*ncr(i,k,2)*ncr(i,k,3)*(2.*rslopec3(i,k)   &amp;<a name='1102'>
                         *rslopec3(i,k)+5040.*rslope3(i,k,1)                   &amp;<a name='1103'>
                         *rslope3(i,k,1)),ncr(i,k,2)/dtcld)<a name='1104'>
              pracw(i,k) = min(pi/6.*(denr/den(i,k))*ncrk2*ncr(i,k,2)          &amp;<a name='1105'>
                         *ncr(i,k,3)*rslopec3(i,k)*(6.*rslopec3(i,k)           &amp;     <a name='1106'>
                         *rslopec3(i,k)+5040.*rslope3(i,k,1)*rslope3(i,k,1))   &amp; <a name='1107'>
                         ,qci(i,k,1)/dtcld)<a name='1108'>
            endif<a name='1109'>
          endif <a name='1110'>
<font color=#447700>!----------------------------------------------------------------<a name='1111'></font>
<font color=#447700>! nccol: self collection of cloud water             [LH A8] [CP 24 &amp; 25]     <a name='1112'></font>
<font color=#447700>!        (NC-&gt;)<a name='1113'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1114'></font>
          if(avedia(i,k,1).ge.di100) then<a name='1115'>
            nccol(i,k) = ncrk1*ncr(i,k,2)*ncr(i,k,2)*rslopec3(i,k)<a name='1116'>
          else<a name='1117'>
            nccol(i,k) = 2.*ncrk2*ncr(i,k,2)*ncr(i,k,2)*rslopec3(i,k)        &amp;     <a name='1118'>
                         *rslopec3(i,k)<a name='1119'>
          endif<a name='1120'>
<font color=#447700>!----------------------------------------------------------------<a name='1121'></font>
<font color=#447700>! nrcol: self collection of rain-drops and break-up [LH A21] [CP 24 &amp; 25]<a name='1122'></font>
<font color=#447700>!        (NR-&gt;)<a name='1123'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1124'></font>
          if(qrs(i,k,1).ge.lenconcr) then<a name='1125'>
            if(avedia(i,k,2).lt.di100) then <a name='1126'>
              nrcol(i,k) = 5040.*ncrk2*ncr(i,k,3)*ncr(i,k,3)*rslope3(i,k,1)    &amp;<a name='1127'>
                          *rslope3(i,k,1)<a name='1128'>
            elseif(avedia(i,k,2).ge.di100 .and. avedia(i,k,2).lt.di600) then<a name='1129'>
              nrcol(i,k) = 24.*ncrk1*ncr(i,k,3)*ncr(i,k,3)*rslope3(i,k,1)<a name='1130'>
            elseif(avedia(i,k,2).ge.di600 .and. avedia(i,k,2).lt.di2000) then<a name='1131'>
              coecol = -2.5e3*(avedia(i,k,2)-di600) <a name='1132'>
              nrcol(i,k) = 24.*exp(coecol)*ncrk1*ncr(i,k,3)*ncr(i,k,3)         &amp;<a name='1133'>
                         *rslope3(i,k,1)<a name='1134'>
            else<a name='1135'>
              nrcol(i,k) = 0.<a name='1136'>
            endif<a name='1137'>
          endif<a name='1138'>
<font color=#447700>!---------------------------------------------------------------<a name='1139'></font>
<font color=#447700>! prevp: evaporation/condensation rate of rain   [HL A41]  <a name='1140'></font>
<font color=#447700>!        (QV-&gt;QR or QR-&gt;QV)<a name='1141'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1142'></font>
          if(qrs(i,k,1).gt.0.) then<a name='1143'>
            coeres = rslope(i,k,1)*sqrt(rslope(i,k,1)*rslopeb(i,k,1))<a name='1144'>
            prevp(i,k) = (rh(i,k,1)-1.)*ncr(i,k,3)*(precr1*rslope(i,k,1)       &amp;<a name='1145'>
                         + precr2*work2(i,k)*coeres)/work1(i,k,1)<a name='1146'>
            if(prevp(i,k).lt.0.) then<a name='1147'>
              prevp(i,k) = max(prevp(i,k),-qrs(i,k,1)/dtcld)<a name='1148'>
              prevp(i,k) = max(prevp(i,k),satdt/2)<a name='1149'>
<font color=#447700>!----------------------------------------------------------------<a name='1150'></font>
<font color=#447700>! Nrevp: evaporation/condensation rate of rain   [LH A14] <a name='1151'></font>
<font color=#447700>!        (NR-&gt;NCCN) <a name='1152'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1153'></font>
              if(prevp(i,k).eq.-qrs(i,k,1)/dtcld) then<a name='1154'>
                ncr(i,k,1) = ncr(i,k,1)+ncr(i,k,3)<a name='1155'>
                ncr(i,k,3) = 0.<a name='1156'>
              endif<a name='1157'>
            else<a name='1158'>
<font color=#447700>!<a name='1159'></font>
              prevp(i,k) = min(prevp(i,k),satdt/2)<a name='1160'>
            endif<a name='1161'>
          endif<a name='1162'>
        enddo<a name='1163'>
      enddo<a name='1164'>
<font color=#447700>!<a name='1165'></font>
<font color=#447700>!===============================================================<a name='1166'></font>
<font color=#447700>!<a name='1167'></font>
<font color=#447700>! cold rain processes<a name='1168'></font>
<font color=#447700>!<a name='1169'></font>
<font color=#447700>! - follows the revised ice microphysics processes in HDC<a name='1170'></font>
<font color=#447700>! - the processes same as in RH83 and RH84  and LFO behave<a name='1171'></font>
<font color=#447700>!   following ice crystal hapits defined in HDC, inclduing<a name='1172'></font>
<font color=#447700>!   intercept parameter for snow (n0s), ice crystal number<a name='1173'></font>
<font color=#447700>!   concentration (ni), ice nuclei number concentration<a name='1174'></font>
<font color=#447700>!   (n0i), ice diameter (d)<a name='1175'></font>
<font color=#447700>!<a name='1176'></font>
<font color=#447700>!===============================================================<a name='1177'></font>
<font color=#447700>!<a name='1178'></font>
      do k = kts, kte<a name='1179'>
        do i = its, ite<a name='1180'>
          supcol = t0c-t(i,k)<a name='1181'>
          n0sfac(i,k) = max(min(exp(alpha*supcol),n0smax/n0s),1.)<a name='1182'>
          supsat = max(q(i,k),qmin)-qs(i,k,2)<a name='1183'>
          satdt = supsat/dtcld<a name='1184'>
          ifsat = 0<a name='1185'>
<font color=#447700>!-------------------------------------------------------------<a name='1186'></font>
<font color=#447700>! Ni: ice crystal number concentraiton   [HDC 5c]<a name='1187'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1188'></font>
<font color=#447700>!         xni(i,k) = min(max(5.38e7*(den(i,k)                                  &amp;<a name='1189'></font>
<font color=#447700>!                      *max(qci(i,k,2),qmin))**0.75,1.e3),1.e6)<a name='1190'></font>
          temp = (den(i,k)*max(qci(i,k,2),qmin))<a name='1191'>
          temp = sqrt(sqrt(temp*temp*temp))<a name='1192'>
          xni(i,k) = min(max(5.38e7*temp,1.e3),1.e6)<a name='1193'>
          eacrs = exp(0.07*(-supcol))<a name='1194'>
<font color=#447700>!<a name='1195'></font>
          xmi = den(i,k)*qci(i,k,2)/xni(i,k)<a name='1196'>
          diameter  = min(dicon * sqrt(xmi),dimax)<a name='1197'>
          vt2i = 1.49e4*diameter**1.31<a name='1198'>
          vt2r=pvtr*rslopeb(i,k,1)*denfac(i,k)<a name='1199'>
          vt2s=pvts*rslopeb(i,k,2)*denfac(i,k)<a name='1200'>
          vt2g=pvtg*rslopeb(i,k,3)*denfac(i,k)<a name='1201'>
          qsum(i,k) = max((qrs(i,k,2)+qrs(i,k,3)),1.e-15)<a name='1202'>
          if(qsum(i,k) .gt. 1.e-15) then<a name='1203'>
            vt2ave=(vt2s*qrs(i,k,2)+vt2g*qrs(i,k,3))/(qsum(i,k))          <a name='1204'>
          else    <a name='1205'>
            vt2ave=0.<a name='1206'>
          endif<a name='1207'>
          if(supcol.gt.0. .and. qci(i,k,2).gt.qmin) then<a name='1208'>
            if(qrs(i,k,1).gt.qcrmin) then<a name='1209'>
<font color=#447700>!-------------------------------------------------------------<a name='1210'></font>
<font color=#447700>! praci: Accretion of cloud ice by rain [HL A15] [LFO 25]<a name='1211'></font>
<font color=#447700>!        (T&lt;T0: QI-&gt;QR)<a name='1212'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1213'></font>
              acrfac = 6.*rslope2(i,k,1)+4.*diameter*rslope(i,k,1) + diameter**2<a name='1214'>
              praci(i,k) = pi*qci(i,k,2)*ncr(i,k,3)*abs(vt2r-vt2i)*acrfac/4.<a name='1215'>
              praci(i,k) = min(praci(i,k),qci(i,k,2)/dtcld)<a name='1216'>
<font color=#447700>!-------------------------------------------------------------<a name='1217'></font>
<font color=#447700>! piacr: Accretion of rain by cloud ice [HL A19] [LFO 26]<a name='1218'></font>
<font color=#447700>!        (T&lt;T0: QR-&gt;QS or QR-&gt;QG)<a name='1219'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1220'></font>
              piacr(i,k) = pi*pi*avtr*ncr(i,k,3)*denr*xni(i,k)*denfac(i,k)     &amp;<a name='1221'>
                          *g7pbr*rslope3(i,k,1)*rslope2(i,k,1)*rslopeb(i,k,1)  &amp;<a name='1222'>
                          /24./den(i,k)<a name='1223'>
              piacr(i,k) = min(piacr(i,k),qrs(i,k,1)/dtcld)<a name='1224'>
            endif<a name='1225'>
<font color=#447700>!-------------------------------------------------------------<a name='1226'></font>
<font color=#447700>! niacr: Accretion of rain by cloud ice  [LH A25]<a name='1227'></font>
<font color=#447700>!        (T&lt;T0: NR-&gt;) <a name='1228'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1229'></font>
            if(ncr(i,k,3).gt.nrmin) then<a name='1230'>
              niacr(i,k) = pi*avtr*ncr(i,k,3)*xni(i,k)*denfac(i,k)*g4pbr       &amp;<a name='1231'>
                          *rslope2(i,k,1)*rslopeb(i,k,1)/4.<a name='1232'>
              niacr(i,k) = min(niacr(i,k),ncr(i,k,3)/dtcld)<a name='1233'>
            endif<a name='1234'>
<font color=#447700>!-------------------------------------------------------------<a name='1235'></font>
<font color=#447700>! psaci: Accretion of cloud ice by snow [HDC 10]<a name='1236'></font>
<font color=#447700>!        (T&lt;T0: QI-&gt;QS)<a name='1237'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1238'></font>
            if(qrs(i,k,2).gt.qcrmin) then<a name='1239'>
              acrfac = 2.*rslope3(i,k,2)+2.*diameter*rslope2(i,k,2)            &amp;<a name='1240'>
                      + diameter**2*rslope(i,k,2)<a name='1241'>
              psaci(i,k) = pi*qci(i,k,2)*eacrs*n0s*n0sfac(i,k)                 &amp;<a name='1242'>
                          *abs(vt2ave-vt2i)*acrfac/4.<a name='1243'>
              psaci(i,k) = min(psaci(i,k),qci(i,k,2)/dtcld)<a name='1244'>
            endif<a name='1245'>
<font color=#447700>!-------------------------------------------------------------<a name='1246'></font>
<font color=#447700>! pgaci: Accretion of cloud ice by graupel [HL A17] [LFO 41]<a name='1247'></font>
<font color=#447700>!        (T&lt;T0: QI-&gt;QG)<a name='1248'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1249'></font>
            if(qrs(i,k,3).gt.qcrmin) then<a name='1250'>
              egi = exp(0.07*(-supcol))<a name='1251'>
              acrfac = 2.*rslope3(i,k,3)+2.*diameter*rslope2(i,k,3)            &amp;<a name='1252'>
                      + diameter**2*rslope(i,k,3)<a name='1253'>
              pgaci(i,k) = pi*egi*qci(i,k,2)*n0g*abs(vt2ave-vt2i)*acrfac/4.<a name='1254'>
              pgaci(i,k) = min(pgaci(i,k),qci(i,k,2)/dtcld)<a name='1255'>
            endif<a name='1256'>
          endif<a name='1257'>
<font color=#447700>!-------------------------------------------------------------<a name='1258'></font>
<font color=#447700>! psacw: Accretion of cloud water by snow  [HL A7] [LFO 24]<a name='1259'></font>
<font color=#447700>!        (T&lt;T0: QC-&gt;QS, and T&gt;=T0: QC-&gt;QR)<a name='1260'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1261'></font>
          if(qrs(i,k,2).gt.qcrmin .and. qci(i,k,1).gt.qmin) then<a name='1262'>
            psacw(i,k) = min(pacrc*n0sfac(i,k)*rslope3(i,k,2)*rslopeb(i,k,2)   &amp;<a name='1263'>
                        *qci(i,k,1)*denfac(i,k),qci(i,k,1)/dtcld)<a name='1264'>
          endif<a name='1265'>
<font color=#447700>!-------------------------------------------------------------<a name='1266'></font>
<font color=#447700>! nsacw: Accretion of cloud water by snow  [LH A12]<a name='1267'></font>
<font color=#447700>!        (NC -&gt;) <a name='1268'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1269'></font>
         if(qrs(i,k,2).gt.qcrmin .and. ncr(i,k,2).gt.ncmin) then<a name='1270'>
           nsacw(i,k) = min(pacrc*n0sfac(i,k)*rslope3(i,k,2)*rslopeb(i,k,2)    &amp;<a name='1271'>
                       *ncr(i,k,2)*denfac(i,k),ncr(i,k,2)/dtcld)<a name='1272'>
         endif<a name='1273'>
<font color=#447700>!-------------------------------------------------------------<a name='1274'></font>
<font color=#447700>! pgacw: Accretion of cloud water by graupel [HL A6] [LFO 40]<a name='1275'></font>
<font color=#447700>!        (T&lt;T0: QC-&gt;QG, and T&gt;=T0: QC-&gt;QR)<a name='1276'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1277'></font>
          if(qrs(i,k,3).gt.qcrmin .and. qci(i,k,1).gt.qmin) then<a name='1278'>
            pgacw(i,k) = min(pacrg*rslope3(i,k,3)*rslopeb(i,k,3)*qci(i,k,1)    &amp;<a name='1279'>
                        *denfac(i,k),qci(i,k,1)/dtcld)<a name='1280'>
          endif<a name='1281'>
<font color=#447700>!-------------------------------------------------------------<a name='1282'></font>
<font color=#447700>! ngacw: Accretion of cloud water by graupel [LH A13]<a name='1283'></font>
<font color=#447700>!        (NC-&gt; <a name='1284'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1285'></font>
          if(qrs(i,k,3).gt.qcrmin .and. ncr(i,k,2).gt.ncmin) then<a name='1286'>
            ngacw(i,k) = min(pacrg*rslope3(i,k,3)*rslopeb(i,k,3)*ncr(i,k,2)    &amp;<a name='1287'>
                        *denfac(i,k),ncr(i,k,2)/dtcld)<a name='1288'>
          endif<a name='1289'>
<font color=#447700>!-------------------------------------------------------------<a name='1290'></font>
<font color=#447700>! paacw: Accretion of cloud water by averaged snow/graupel <a name='1291'></font>
<font color=#447700>!        (T&lt;T0: QC-&gt;QG or QS, and T&gt;=T0: QC-&gt;QR) <a name='1292'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1293'></font>
          if(qsum(i,k) .gt. 1.e-15) then<a name='1294'>
            paacw(i,k) = (qrs(i,k,2)*psacw(i,k)+qrs(i,k,3)*pgacw(i,k))/(qsum(i,k))<a name='1295'>
<font color=#447700>!-------------------------------------------------------------<a name='1296'></font>
<font color=#447700>! naacw: Accretion of cloud water by averaged snow/graupel<a name='1297'></font>
<font color=#447700>!        (Nc-&gt;)<a name='1298'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1299'></font>
            naacw(i,k) = (qrs(i,k,2)*nsacw(i,k)+qrs(i,k,3)*ngacw(i,k))/(qsum(i,k))<a name='1300'>
          endif      <a name='1301'>
<font color=#447700>!-------------------------------------------------------------<a name='1302'></font>
<font color=#447700>! pracs: Accretion of snow by rain [HL A11] [LFO 27]<a name='1303'></font>
<font color=#447700>!         (T&lt;T0: QS-&gt;QG)<a name='1304'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1305'></font>
          if(qrs(i,k,2).gt.qcrmin .and. qrs(i,k,1).gt.qcrmin) then<a name='1306'>
            if(supcol.gt.0) then<a name='1307'>
              acrfac = 5.*rslope3(i,k,2)*rslope3(i,k,2)                        &amp;<a name='1308'>
                      + 4.*rslope3(i,k,2)*rslope2(i,k,2)*rslope(i,k,1)         &amp;<a name='1309'>
                      + 1.5*rslope2(i,k,2)*rslope2(i,k,2)*rslope2(i,k,1)<a name='1310'>
              pracs(i,k) = pi*pi*ncr(i,k,3)*n0s*n0sfac(i,k)*abs(vt2r-vt2ave)   &amp;<a name='1311'>
                          *(dens/den(i,k))*acrfac<a name='1312'>
              pracs(i,k) = min(pracs(i,k),qrs(i,k,2)/dtcld)<a name='1313'>
            endif<a name='1314'>
<font color=#447700>!-------------------------------------------------------------<a name='1315'></font>
<font color=#447700>! psacr: Accretion of rain by snow [HL A10] [LFO 28]<a name='1316'></font>
<font color=#447700>!         (T&lt;T0:QR-&gt;QS or QR-&gt;QG) (T&gt;=T0: enhance melting of snow)<a name='1317'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1318'></font>
            acrfac = 30.*rslope3(i,k,1)*rslope2(i,k,1)*rslope(i,k,2)           &amp;<a name='1319'>
                     +10.*rslope2(i,k,1)*rslope2(i,k,1)*rslope2(i,k,2)         &amp; <a name='1320'>
                     + 2.*rslope3(i,k,1)*rslope3(i,k,2)<a name='1321'>
            psacr(i,k) = pi*pi*ncr(i,k,3)*n0s*n0sfac(i,k)*abs(vt2ave-vt2r)     &amp;<a name='1322'>
                        *(denr/den(i,k))*acrfac<a name='1323'>
            psacr(i,k) = min(psacr(i,k),qrs(i,k,1)/dtcld)<a name='1324'>
          endif<a name='1325'>
          if(qrs(i,k,2).gt.qcrmin .and. ncr(i,k,3).gt.nrmin) then<a name='1326'>
<font color=#447700>!-------------------------------------------------------------<a name='1327'></font>
<font color=#447700>! nsacr: Accretion of rain by snow  [LH A23] <a name='1328'></font>
<font color=#447700>!       (T&lt;T0:NR-&gt;)<a name='1329'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1330'></font>
            acrfac = 1.5*rslope2(i,k,1)*rslope(i,k,2)                          &amp;<a name='1331'>
                    + 1.0*rslope(i,k,1)*rslope2(i,k,2)+.5*rslope3(i,k,2)        <a name='1332'>
            nsacr(i,k) = pi*ncr(i,k,3)*n0s*n0sfac(i,k)*abs(vt2ave-vt2r)        &amp;<a name='1333'>
                        *acrfac<a name='1334'>
            nsacr(i,k) = min(nsacr(i,k),ncr(i,k,3)/dtcld)<a name='1335'>
          endif<a name='1336'>
<font color=#447700>!-------------------------------------------------------------<a name='1337'></font>
<font color=#447700>! pgacr: Accretion of rain by graupel [HL A12] [LFO 42]<a name='1338'></font>
<font color=#447700>!         (T&lt;T0: QR-&gt;QG) (T&gt;=T0: enhance melting of graupel)<a name='1339'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1340'></font>
          if(qrs(i,k,3).gt.qcrmin .and. qrs(i,k,1).gt.qcrmin) then<a name='1341'>
            acrfac = 30.*rslope3(i,k,1)*rslope2(i,k,1)*rslope(i,k,3)           &amp;<a name='1342'>
                    +10.*rslope2(i,k,1)*rslope2(i,k,1)*rslope2(i,k,3)          &amp; <a name='1343'>
                    + 2.*rslope3(i,k,1)*rslope3(i,k,3)<a name='1344'>
            pgacr(i,k) = pi*pi*ncr(i,k,3)*n0g*abs(vt2ave-vt2r)*(denr/den(i,k)) &amp;<a name='1345'>
                        *acrfac<a name='1346'>
            pgacr(i,k) = min(pgacr(i,k),qrs(i,k,1)/dtcld)<a name='1347'>
          endif<a name='1348'>
<font color=#447700>!-------------------------------------------------------------<a name='1349'></font>
<font color=#447700>! ngacr: Accretion of rain by graupel  [LH A24] <a name='1350'></font>
<font color=#447700>!        (T&lt;T0: NR-&gt;) <a name='1351'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1352'></font>
          if(qrs(i,k,3).gt.qcrmin .and. ncr(i,k,3).gt.nrmin) then<a name='1353'>
            acrfac = 1.5*rslope2(i,k,1)*rslope(i,k,3)                          &amp;<a name='1354'>
                    + 1.0*rslope(i,k,1)*rslope2(i,k,3) + .5*rslope3(i,k,3)   <a name='1355'>
            ngacr(i,k) = pi*ncr(i,k,3)*n0g*abs(vt2ave-vt2r)*acrfac<a name='1356'>
            ngacr(i,k) = min(ngacr(i,k),ncr(i,k,3)/dtcld)<a name='1357'>
          endif<a name='1358'>
<font color=#447700>!<a name='1359'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1360'></font>
<font color=#447700>! pgacs: Accretion of snow by graupel [HL A13] [LFO 29]<a name='1361'></font>
<font color=#447700>!        (QS-&gt;QG) : This process is eliminated in V3.0 with the<a name='1362'></font>
<font color=#447700>!        new combined snow/graupel fall speeds<a name='1363'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1364'></font>
          if(qrs(i,k,3).gt.qcrmin .and. qrs(i,k,2).gt.qcrmin) then<a name='1365'>
            pgacs(i,k) = 0. <a name='1366'>
          endif<a name='1367'>
          if(supcol.le.0) then<a name='1368'>
            xlf = xlf0<a name='1369'>
<font color=#447700>!-------------------------------------------------------------<a name='1370'></font>
<font color=#447700>! pseml: Enhanced melting of snow by accretion of water [HL A34]<a name='1371'></font>
<font color=#447700>!        (T&gt;=T0: QS-&gt;QR)<a name='1372'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1373'></font>
            if(qrs(i,k,2).gt.0.)                                               &amp; <a name='1374'>
              pseml(i,k) = min(max(cliq*supcol*(paacw(i,k)+psacr(i,k))         &amp;<a name='1375'>
                          /xlf,-qrs(i,k,2)/dtcld),0.)<a name='1376'>
<font color=#447700>!--------------------------------------------------------------<a name='1377'></font>
<font color=#447700>! nseml: Enhanced melting of snow by accretion of water    [LH A29]<a name='1378'></font>
<font color=#447700>!        (T&gt;=T0: -&gt;NR)<a name='1379'></font>
<font color=#447700>!--------------------------------------------------------------<a name='1380'></font>
              if  (qrs(i,k,2).gt.qcrmin) then<a name='1381'>
                sfac = rslope(i,k,2)*n0s*n0sfac(i,k)/qrs(i,k,2)<a name='1382'>
                nseml(i,k) = -sfac*pseml(i,k)<a name='1383'>
              endif<a name='1384'>
<font color=#447700>!-------------------------------------------------------------<a name='1385'></font>
<font color=#447700>! pgeml: Enhanced melting of graupel by accretion of water [HL A24] [RH84 A21-A22]<a name='1386'></font>
<font color=#447700>!        (T&gt;=T0: QG-&gt;QR)<a name='1387'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1388'></font>
            if(qrs(i,k,3).gt.0.)                                               &amp;<a name='1389'>
              pgeml(i,k) = min(max(cliq*supcol*(paacw(i,k)+pgacr(i,k))/xlf     &amp;<a name='1390'>
                          ,-qrs(i,k,3)/dtcld),0.)<a name='1391'>
<font color=#447700>!--------------------------------------------------------------<a name='1392'></font>
<font color=#447700>! ngeml: Enhanced melting of graupel by accretion of water [LH A30] <a name='1393'></font>
<font color=#447700>!         (T&gt;=T0: -&gt; NR)<a name='1394'></font>
<font color=#447700>!--------------------------------------------------------------<a name='1395'></font>
              if (qrs(i,k,3).gt.qcrmin) then<a name='1396'>
                gfac = rslope(i,k,3)*n0g/qrs(i,k,3)<a name='1397'>
                ngeml(i,k) = -gfac*pgeml(i,k)<a name='1398'>
              endif<a name='1399'>
          endif<a name='1400'>
          if(supcol.gt.0) then<a name='1401'>
<font color=#447700>!-------------------------------------------------------------<a name='1402'></font>
<font color=#447700>! pidep: Deposition/Sublimation rate of ice [HDC 9]<a name='1403'></font>
<font color=#447700>!       (T&lt;T0: QV-&gt;QI or QI-&gt;QV)<a name='1404'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1405'></font>
            if(qci(i,k,2).gt.0. .and. ifsat.ne.1) then<a name='1406'>
              pidep(i,k) = 4.*diameter*xni(i,k)*(rh(i,k,2)-1.)/work1(i,k,2)<a name='1407'>
              supice = satdt-prevp(i,k)<a name='1408'>
              if(pidep(i,k).lt.0.) then<a name='1409'>
                pidep(i,k) = max(max(pidep(i,k),satdt/2),supice)<a name='1410'>
                pidep(i,k) = max(pidep(i,k),-qci(i,k,2)/dtcld)<a name='1411'>
              else<a name='1412'>
                pidep(i,k) = min(min(pidep(i,k),satdt/2),supice)<a name='1413'>
              endif<a name='1414'>
              if(abs(prevp(i,k)+pidep(i,k)).ge.abs(satdt)) ifsat = 1<a name='1415'>
            endif<a name='1416'>
<font color=#447700>!-------------------------------------------------------------<a name='1417'></font>
<font color=#447700>! psdep: deposition/sublimation rate of snow [HDC 14]<a name='1418'></font>
<font color=#447700>!        (T&lt;T0: QV-&gt;QS or QS-&gt;QV)<a name='1419'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1420'></font>
            if(qrs(i,k,2).gt.0. .and. ifsat.ne.1) then<a name='1421'>
              coeres = rslope2(i,k,2)*sqrt(rslope(i,k,2)*rslopeb(i,k,2))<a name='1422'>
              psdep(i,k) = (rh(i,k,2)-1.)*n0sfac(i,k)*(precs1*rslope2(i,k,2)   &amp;<a name='1423'>
                           + precs2*work2(i,k)*coeres)/work1(i,k,2)<a name='1424'>
              supice = satdt-prevp(i,k)-pidep(i,k)<a name='1425'>
              if(psdep(i,k).lt.0.) then<a name='1426'>
                psdep(i,k) = max(psdep(i,k),-qrs(i,k,2)/dtcld)<a name='1427'>
                psdep(i,k) = max(max(psdep(i,k),satdt/2),supice)<a name='1428'>
              else<a name='1429'>
                psdep(i,k) = min(min(psdep(i,k),satdt/2),supice)<a name='1430'>
              endif<a name='1431'>
              if(abs(prevp(i,k)+pidep(i,k)+psdep(i,k)).ge.abs(satdt)) ifsat = 1<a name='1432'>
            endif<a name='1433'>
<font color=#447700>!-------------------------------------------------------------<a name='1434'></font>
<font color=#447700>! pgdep: deposition/sublimation rate of graupel [HL A21] [LFO 46]<a name='1435'></font>
<font color=#447700>!        (T&lt;T0: QV-&gt;QG or QG-&gt;QV)<a name='1436'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1437'></font>
            if(qrs(i,k,3).gt.0. .and. ifsat.ne.1) then<a name='1438'>
              coeres = rslope2(i,k,3)*sqrt(rslope(i,k,3)*rslopeb(i,k,3))<a name='1439'>
              pgdep(i,k) = (rh(i,k,2)-1.)*(precg1*rslope2(i,k,3)               &amp;<a name='1440'>
                          + precg2*work2(i,k)*coeres)/work1(i,k,2)<a name='1441'>
              supice = satdt-prevp(i,k)-pidep(i,k)-psdep(i,k)<a name='1442'>
              if(pgdep(i,k).lt.0.) then<a name='1443'>
                pgdep(i,k) = max(pgdep(i,k),-qrs(i,k,3)/dtcld)<a name='1444'>
                pgdep(i,k) = max(max(pgdep(i,k),satdt/2),supice)<a name='1445'>
              else<a name='1446'>
                pgdep(i,k) = min(min(pgdep(i,k),satdt/2),supice)<a name='1447'>
              endif<a name='1448'>
              if(abs(prevp(i,k)+pidep(i,k)+psdep(i,k)+pgdep(i,k)).ge.          &amp;<a name='1449'>
                abs(satdt)) ifsat = 1<a name='1450'>
            endif<a name='1451'>
<font color=#447700>!-------------------------------------------------------------<a name='1452'></font>
<font color=#447700>! pigen: generation(nucleation) of ice from vapor [HL 50] [HDC 7-8]<a name='1453'></font>
<font color=#447700>!       (T&lt;T0: QV-&gt;QI)<a name='1454'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1455'></font>
            if(supsat.gt.0. .and. ifsat.ne.1) then<a name='1456'>
              supice = satdt-prevp(i,k)-pidep(i,k)-psdep(i,k)-pgdep(i,k)<a name='1457'>
              xni0 = 1.e3*exp(0.1*supcol)<a name='1458'>
              roqi0 = 4.92e-11*xni0**1.33<a name='1459'>
              pigen(i,k) = max(0.,(roqi0/den(i,k)-max(qci(i,k,2),0.))/dtcld)<a name='1460'>
              pigen(i,k) = min(min(pigen(i,k),satdt),supice)<a name='1461'>
            endif<a name='1462'>
<font color=#447700>!<a name='1463'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1464'></font>
<font color=#447700>! psaut: conversion(aggregation) of ice to snow [HDC 12]<a name='1465'></font>
<font color=#447700>!        (T&lt;T0: QI-&gt;QS)<a name='1466'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1467'></font>
            if(qci(i,k,2).gt.0.) then<a name='1468'>
              qimax = roqimax/den(i,k)<a name='1469'>
              psaut(i,k) = max(0.,(qci(i,k,2)-qimax)/dtcld)<a name='1470'>
            endif<a name='1471'>
<font color=#447700>!<a name='1472'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1473'></font>
<font color=#447700>! pgaut: conversion(aggregation) of snow to graupel [HL A4] [LFO 37]<a name='1474'></font>
<font color=#447700>!        (T&lt;T0: QS-&gt;QG)<a name='1475'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1476'></font>
            if(qrs(i,k,2).gt.0.) then<a name='1477'>
              alpha2 = 1.e-3*exp(0.09*(-supcol))<a name='1478'>
              pgaut(i,k) = min(max(0.,alpha2*(qrs(i,k,2)-qs0)),qrs(i,k,2)/dtcld)<a name='1479'>
            endif<a name='1480'>
          endif<a name='1481'>
<font color=#447700>!<a name='1482'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1483'></font>
<font color=#447700>! psevp: Evaporation of melting snow [HL A35] [RH83 A27]<a name='1484'></font>
<font color=#447700>!       (T&gt;=T0: QS-&gt;QV)<a name='1485'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1486'></font>
          if(supcol.lt.0.) then<a name='1487'>
            if(qrs(i,k,2).gt.0. .and. rh(i,k,1).lt.1.) then<a name='1488'>
              coeres = rslope2(i,k,2)*sqrt(rslope(i,k,2)*rslopeb(i,k,2))<a name='1489'>
              psevp(i,k) = (rh(i,k,1)-1.)*n0sfac(i,k)*(precs1*rslope2(i,k,2)   &amp;<a name='1490'>
                           +precs2*work2(i,k)*coeres)/work1(i,k,1)<a name='1491'>
              psevp(i,k) = min(max(psevp(i,k),-qrs(i,k,2)/dtcld),0.)<a name='1492'>
            endif<a name='1493'>
<font color=#447700>!-------------------------------------------------------------<a name='1494'></font>
<font color=#447700>! pgevp: Evaporation of melting graupel [HL A25] [RH84 A19]<a name='1495'></font>
<font color=#447700>!       (T&gt;=T0: QG-&gt;QV)<a name='1496'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1497'></font>
            if(qrs(i,k,3).gt.0. .and. rh(i,k,1).lt.1.) then<a name='1498'>
              coeres = rslope2(i,k,3)*sqrt(rslope(i,k,3)*rslopeb(i,k,3))<a name='1499'>
              pgevp(i,k) = (rh(i,k,1)-1.)*(precg1*rslope2(i,k,3)               &amp;<a name='1500'>
                         + precg2*work2(i,k)*coeres)/work1(i,k,1)<a name='1501'>
              pgevp(i,k) = min(max(pgevp(i,k),-qrs(i,k,3)/dtcld),0.)<a name='1502'>
            endif<a name='1503'>
          endif<a name='1504'>
        enddo<a name='1505'>
      enddo<a name='1506'>
<font color=#447700>!<a name='1507'></font>
<font color=#447700>!<a name='1508'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1509'></font>
<font color=#447700>!     check mass conservation of generation terms and feedback to the<a name='1510'></font>
<font color=#447700>!     large scale<a name='1511'></font>
<font color=#447700>!<a name='1512'></font>
      do k = kts, kte<a name='1513'>
        do i = its, ite<a name='1514'>
<font color=#447700>!<a name='1515'></font>
          delta2=0.<a name='1516'>
          delta3=0.<a name='1517'>
          if(qrs(i,k,1).lt.1.e-4 .and. qrs(i,k,2).lt.1.e-4) delta2=1.<a name='1518'>
          if(qrs(i,k,1).lt.1.e-4) delta3=1.<a name='1519'>
          if(t(i,k).le.t0c) then<a name='1520'>
<font color=#447700>!<a name='1521'></font>
<font color=#447700>!     cloud water<a name='1522'></font>
<font color=#447700>!<a name='1523'></font>
            value = max(qmin,qci(i,k,1))<a name='1524'>
            source = (praut(i,k)+pracw(i,k)+paacw(i,k)+paacw(i,k))             &amp;<a name='1525'>
                    *dtcld<a name='1526'>
            if (source.gt.value) then<a name='1527'>
              factor = value/source<a name='1528'>
              praut(i,k) = praut(i,k)*factor<a name='1529'>
              pracw(i,k) = pracw(i,k)*factor<a name='1530'>
              paacw(i,k) = paacw(i,k)*factor<a name='1531'>
            endif<a name='1532'>
<font color=#447700>!<a name='1533'></font>
<font color=#447700>!     cloud ice<a name='1534'></font>
<font color=#447700>!<a name='1535'></font>
            value = max(qmin,qci(i,k,2))<a name='1536'>
            source = (psaut(i,k)-pigen(i,k)-pidep(i,k)+praci(i,k)+psaci(i,k)   &amp;<a name='1537'>
                    +pgaci(i,k))*dtcld<a name='1538'>
            if (source.gt.value) then<a name='1539'>
              factor = value/source<a name='1540'>
              psaut(i,k) = psaut(i,k)*factor<a name='1541'>
              pigen(i,k) = pigen(i,k)*factor<a name='1542'>
              pidep(i,k) = pidep(i,k)*factor<a name='1543'>
              praci(i,k) = praci(i,k)*factor<a name='1544'>
              psaci(i,k) = psaci(i,k)*factor<a name='1545'>
              pgaci(i,k) = pgaci(i,k)*factor<a name='1546'>
            endif<a name='1547'>
<font color=#447700>!<a name='1548'></font>
<font color=#447700>!     rain<a name='1549'></font>
<font color=#447700>!<a name='1550'></font>
            value = max(qmin,qrs(i,k,1))<a name='1551'>
            source = (-praut(i,k)-prevp(i,k)-pracw(i,k)+piacr(i,k)             &amp;<a name='1552'>
                    +psacr(i,k)+pgacr(i,k))*dtcld<a name='1553'>
            if (source.gt.value) then<a name='1554'>
              factor = value/source<a name='1555'>
              praut(i,k) = praut(i,k)*factor<a name='1556'>
              prevp(i,k) = prevp(i,k)*factor<a name='1557'>
              pracw(i,k) = pracw(i,k)*factor<a name='1558'>
              piacr(i,k) = piacr(i,k)*factor<a name='1559'>
              psacr(i,k) = psacr(i,k)*factor<a name='1560'>
              pgacr(i,k) = pgacr(i,k)*factor<a name='1561'>
            endif<a name='1562'>
<font color=#447700>!<a name='1563'></font>
<font color=#447700>!     snow<a name='1564'></font>
<font color=#447700>!<a name='1565'></font>
            value = max(qmin,qrs(i,k,2))<a name='1566'>
            source = -(psdep(i,k)+psaut(i,k)-pgaut(i,k)+paacw(i,k)             &amp;<a name='1567'>
                     +piacr(i,k)*delta3+praci(i,k)*delta3                      &amp;<a name='1568'>
                     -pracs(i,k)*(1.-delta2)+psacr(i,k)*delta2                 &amp;<a name='1569'>
                     +psaci(i,k)-pgacs(i,k) )*dtcld<a name='1570'>
            if (source.gt.value) then<a name='1571'>
              factor = value/source<a name='1572'>
              psdep(i,k) = psdep(i,k)*factor<a name='1573'>
              psaut(i,k) = psaut(i,k)*factor<a name='1574'>
              pgaut(i,k) = pgaut(i,k)*factor<a name='1575'>
              paacw(i,k) = paacw(i,k)*factor<a name='1576'>
              piacr(i,k) = piacr(i,k)*factor<a name='1577'>
              praci(i,k) = praci(i,k)*factor<a name='1578'>
              psaci(i,k) = psaci(i,k)*factor<a name='1579'>
              pracs(i,k) = pracs(i,k)*factor<a name='1580'>
              psacr(i,k) = psacr(i,k)*factor<a name='1581'>
              pgacs(i,k) = pgacs(i,k)*factor<a name='1582'>
            endif<a name='1583'>
<font color=#447700>!<a name='1584'></font>
<font color=#447700>!     graupel<a name='1585'></font>
<font color=#447700>!<a name='1586'></font>
            value = max(qmin,qrs(i,k,3))<a name='1587'>
            source = -(pgdep(i,k)+pgaut(i,k)                                   &amp;<a name='1588'>
                     +piacr(i,k)*(1.-delta3)+praci(i,k)*(1.-delta3)            &amp;<a name='1589'>
                     +psacr(i,k)*(1.-delta2)+pracs(i,k)*(1.-delta2)            &amp;<a name='1590'>
                     +pgaci(i,k)+paacw(i,k)+pgacr(i,k)+pgacs(i,k))*dtcld<a name='1591'>
            if (source.gt.value) then<a name='1592'>
              factor = value/source<a name='1593'>
              pgdep(i,k) = pgdep(i,k)*factor<a name='1594'>
              pgaut(i,k) = pgaut(i,k)*factor<a name='1595'>
              piacr(i,k) = piacr(i,k)*factor<a name='1596'>
              praci(i,k) = praci(i,k)*factor<a name='1597'>
              psacr(i,k) = psacr(i,k)*factor<a name='1598'>
              pracs(i,k) = pracs(i,k)*factor<a name='1599'>
              paacw(i,k) = paacw(i,k)*factor<a name='1600'>
              pgaci(i,k) = pgaci(i,k)*factor<a name='1601'>
              pgacr(i,k) = pgacr(i,k)*factor<a name='1602'>
              pgacs(i,k) = pgacs(i,k)*factor<a name='1603'>
            endif<a name='1604'>
<font color=#447700>!<a name='1605'></font>
<font color=#447700>!     cloud<a name='1606'></font>
<font color=#447700>!<a name='1607'></font>
            value = max(ncmin,ncr(i,k,2))<a name='1608'>
            source = (nraut(i,k)+nccol(i,k)+nracw(i,k)                         &amp;<a name='1609'>
                    +naacw(i,k)+naacw(i,k))*dtcld<a name='1610'>
            if (source.gt.value) then<a name='1611'>
              factor = value/source<a name='1612'>
              nraut(i,k) = nraut(i,k)*factor<a name='1613'>
              nccol(i,k) = nccol(i,k)*factor<a name='1614'>
              nracw(i,k) = nracw(i,k)*factor<a name='1615'>
              naacw(i,k) = naacw(i,k)*factor<a name='1616'>
            endif<a name='1617'>
<font color=#447700>!<a name='1618'></font>
<font color=#447700>!     rain<a name='1619'></font>
<font color=#447700>!<a name='1620'></font>
            value = max(nrmin,ncr(i,k,3))<a name='1621'>
            source = (-nraut(i,k)+nrcol(i,k)+niacr(i,k)+nsacr(i,k)+ngacr(i,k)  &amp;<a name='1622'>
                     )*dtcld<a name='1623'>
            if (source.gt.value) then<a name='1624'>
              factor = value/source<a name='1625'>
              nraut(i,k) = nraut(i,k)*factor<a name='1626'>
              nrcol(i,k) = nrcol(i,k)*factor<a name='1627'>
              niacr(i,k) = niacr(i,k)*factor<a name='1628'>
              nsacr(i,k) = nsacr(i,k)*factor<a name='1629'>
              ngacr(i,k) = ngacr(i,k)*factor<a name='1630'>
            endif<a name='1631'>
<font color=#447700>!<a name='1632'></font>
            work2(i,k)=-(prevp(i,k)+psdep(i,k)+pgdep(i,k)+pigen(i,k)+pidep(i,k))<a name='1633'>
<font color=#447700>!     update<a name='1634'></font>
            q(i,k) = q(i,k)+work2(i,k)*dtcld<a name='1635'>
            qci(i,k,1) = max(qci(i,k,1)-(praut(i,k)+pracw(i,k)                 &amp;<a name='1636'>
                           +paacw(i,k)+paacw(i,k))*dtcld,0.)<a name='1637'>
            qrs(i,k,1) = max(qrs(i,k,1)+(praut(i,k)+pracw(i,k)                 &amp;<a name='1638'>
                           +prevp(i,k)-piacr(i,k)-pgacr(i,k)                   &amp;<a name='1639'>
                           -psacr(i,k))*dtcld,0.)<a name='1640'>
            qci(i,k,2) = max(qci(i,k,2)-(psaut(i,k)+praci(i,k)                 &amp;<a name='1641'>
                           +psaci(i,k)+pgaci(i,k)-pigen(i,k)-pidep(i,k))       &amp;<a name='1642'>
                           *dtcld,0.)<a name='1643'>
            qrs(i,k,2) = max(qrs(i,k,2)+(psdep(i,k)+psaut(i,k)+paacw(i,k)      &amp;<a name='1644'>
                           -pgaut(i,k)+piacr(i,k)*delta3                       &amp;<a name='1645'>
                           +praci(i,k)*delta3+psaci(i,k)-pgacs(i,k)            &amp;<a name='1646'>
                           -pracs(i,k)*(1.-delta2)+psacr(i,k)*delta2)          &amp;<a name='1647'>
                           *dtcld,0.)<a name='1648'>
            qrs(i,k,3) = max(qrs(i,k,3)+(pgdep(i,k)+pgaut(i,k)                 &amp;<a name='1649'>
                           +piacr(i,k)*(1.-delta3)                             &amp;<a name='1650'>
                           +praci(i,k)*(1.-delta3)+psacr(i,k)*(1.-delta2)      &amp;<a name='1651'>
                           +pracs(i,k)*(1.-delta2)+pgaci(i,k)+paacw(i,k)       &amp;<a name='1652'>
                           +pgacr(i,k)+pgacs(i,k))*dtcld,0.)<a name='1653'>
            ncr(i,k,2) = max(ncr(i,k,2)+(-nraut(i,k)-nccol(i,k)-nracw(i,k)     &amp;<a name='1654'>
                           -naacw(i,k)-naacw(i,k))*dtcld,0.)<a name='1655'>
            ncr(i,k,3) = max(ncr(i,k,3)+(nraut(i,k)-nrcol(i,k)-niacr(i,k)      &amp;<a name='1656'>
                           -nsacr(i,k)-ngacr(i,k))*dtcld,0.)<a name='1657'>
            xlf = xls-xl(i,k)<a name='1658'>
            xlwork2 = -xls*(psdep(i,k)+pgdep(i,k)+pidep(i,k)+pigen(i,k))       &amp;<a name='1659'>
                      -xl(i,k)*prevp(i,k)-xlf*(piacr(i,k)+paacw(i,k)           &amp;<a name='1660'>
                      +paacw(i,k)+pgacr(i,k)+psacr(i,k))<a name='1661'>
            t(i,k) = t(i,k)-xlwork2/cpm(i,k)*dtcld<a name='1662'>
          else<a name='1663'>
<font color=#447700>!<a name='1664'></font>
<font color=#447700>!     cloud water<a name='1665'></font>
<font color=#447700>!<a name='1666'></font>
            value = max(qmin,qci(i,k,1))<a name='1667'>
            source= (praut(i,k)+pracw(i,k)+paacw(i,k)+paacw(i,k))              &amp;<a name='1668'>
                   *dtcld<a name='1669'>
            if (source.gt.value) then<a name='1670'>
              factor = value/source<a name='1671'>
              praut(i,k) = praut(i,k)*factor<a name='1672'>
              pracw(i,k) = pracw(i,k)*factor<a name='1673'>
              paacw(i,k) = paacw(i,k)*factor<a name='1674'>
            endif<a name='1675'>
<font color=#447700>!<a name='1676'></font>
<font color=#447700>!     rain<a name='1677'></font>
<font color=#447700>!<a name='1678'></font>
            value = max(qmin,qrs(i,k,1))<a name='1679'>
            source = (-paacw(i,k)-praut(i,k)+pseml(i,k)+pgeml(i,k)             &amp;<a name='1680'>
                     -pracw(i,k)-paacw(i,k)-prevp(i,k))*dtcld<a name='1681'>
            if (source.gt.value) then<a name='1682'>
              factor = value/source<a name='1683'>
              praut(i,k) = praut(i,k)*factor<a name='1684'>
              prevp(i,k) = prevp(i,k)*factor<a name='1685'>
              pracw(i,k) = pracw(i,k)*factor<a name='1686'>
              paacw(i,k) = paacw(i,k)*factor<a name='1687'>
              pseml(i,k) = pseml(i,k)*factor<a name='1688'>
              pgeml(i,k) = pgeml(i,k)*factor<a name='1689'>
            endif<a name='1690'>
<font color=#447700>!<a name='1691'></font>
<font color=#447700>!     snow<a name='1692'></font>
<font color=#447700>!<a name='1693'></font>
            value = max(qcrmin,qrs(i,k,2))<a name='1694'>
            source=(pgacs(i,k)-pseml(i,k)-psevp(i,k))*dtcld<a name='1695'>
            if (source.gt.value) then<a name='1696'>
              factor = value/source<a name='1697'>
              pgacs(i,k) = pgacs(i,k)*factor<a name='1698'>
              psevp(i,k) = psevp(i,k)*factor<a name='1699'>
              pseml(i,k) = pseml(i,k)*factor<a name='1700'>
            endif<a name='1701'>
<font color=#447700>!<a name='1702'></font>
<font color=#447700>!     graupel<a name='1703'></font>
<font color=#447700>!<a name='1704'></font>
            value = max(qcrmin,qrs(i,k,3))<a name='1705'>
            source=-(pgacs(i,k)+pgevp(i,k)+pgeml(i,k))*dtcld<a name='1706'>
            if (source.gt.value) then<a name='1707'>
              factor = value/source<a name='1708'>
              pgacs(i,k) = pgacs(i,k)*factor<a name='1709'>
              pgevp(i,k) = pgevp(i,k)*factor<a name='1710'>
              pgeml(i,k) = pgeml(i,k)*factor<a name='1711'>
            endif<a name='1712'>
<font color=#447700>!<a name='1713'></font>
<font color=#447700>!     cloud<a name='1714'></font>
<font color=#447700>!<a name='1715'></font>
            value = max(ncmin,ncr(i,k,2))<a name='1716'>
            source = (+nraut(i,k)+nccol(i,k)+nracw(i,k)+naacw(i,k)             &amp;<a name='1717'>
                     +naacw(i,k))*dtcld<a name='1718'>
            if (source.gt.value) then<a name='1719'>
              factor = value/source<a name='1720'>
              nraut(i,k) = nraut(i,k)*factor<a name='1721'>
              nccol(i,k) = nccol(i,k)*factor<a name='1722'>
              nracw(i,k) = nracw(i,k)*factor<a name='1723'>
              naacw(i,k) = naacw(i,k)*factor<a name='1724'>
            endif<a name='1725'>
<font color=#447700>!<a name='1726'></font>
<font color=#447700>!     rain<a name='1727'></font>
<font color=#447700>!<a name='1728'></font>
            value = max(nrmin,ncr(i,k,3))<a name='1729'>
            source = (-nraut(i,k)+nrcol(i,k)-nseml(i,k)-ngeml(i,k)             &amp;<a name='1730'>
                      )*dtcld<a name='1731'>
            if (source.gt.value) then<a name='1732'>
              factor = value/source<a name='1733'>
              nraut(i,k) = nraut(i,k)*factor<a name='1734'>
              nrcol(i,k) = nrcol(i,k)*factor<a name='1735'>
              nseml(i,k) = nseml(i,k)*factor<a name='1736'>
              ngeml(i,k) = ngeml(i,k)*factor<a name='1737'>
            endif<a name='1738'>
<font color=#447700>!<a name='1739'></font>
            work2(i,k)=-(prevp(i,k)+psevp(i,k)+pgevp(i,k))<a name='1740'>
<font color=#447700>!     update<a name='1741'></font>
            q(i,k) = q(i,k)+work2(i,k)*dtcld<a name='1742'>
            qci(i,k,1) = max(qci(i,k,1)-(praut(i,k)+pracw(i,k)                 &amp;<a name='1743'>
                    +paacw(i,k)+paacw(i,k))*dtcld,0.)<a name='1744'>
            qrs(i,k,1) = max(qrs(i,k,1)+(praut(i,k)+pracw(i,k)                 &amp;<a name='1745'>
                    +prevp(i,k)+paacw(i,k)+paacw(i,k)-pseml(i,k)               &amp;<a name='1746'>
                    -pgeml(i,k))*dtcld,0.)<a name='1747'>
            qrs(i,k,2) = max(qrs(i,k,2)+(psevp(i,k)-pgacs(i,k)                 &amp;<a name='1748'>
                    +pseml(i,k))*dtcld,0.)<a name='1749'>
            qrs(i,k,3) = max(qrs(i,k,3)+(pgacs(i,k)+pgevp(i,k)                 &amp;<a name='1750'>
                    +pgeml(i,k))*dtcld,0.)<a name='1751'>
            ncr(i,k,2) = max(ncr(i,k,2)+(-nraut(i,k)-nccol(i,k)-nracw(i,k)     &amp;<a name='1752'>
                   -naacw(i,k)-naacw(i,k))*dtcld,0.)<a name='1753'>
            ncr(i,k,3) = max(ncr(i,k,3)+(nraut(i,k)-nrcol(i,k)+nseml(i,k)      &amp;<a name='1754'>
                           +ngeml(i,k))*dtcld,0.)<a name='1755'>
            xlf = xls-xl(i,k)<a name='1756'>
            xlwork2 = -xl(i,k)*(prevp(i,k)+psevp(i,k)+pgevp(i,k))              &amp;<a name='1757'>
                      -xlf*(pseml(i,k)+pgeml(i,k))<a name='1758'>
            t(i,k) = t(i,k)-xlwork2/cpm(i,k)*dtcld<a name='1759'>
          endif<a name='1760'>
        enddo<a name='1761'>
      enddo<a name='1762'>
<font color=#447700>!<a name='1763'></font>
<font color=#447700>! Inline expansion for fpvs<a name='1764'></font>
<font color=#447700>!         qs(i,k,1) = fpvs(t(i,k),0,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='1765'></font>
<font color=#447700>!         qs(i,k,2) = fpvs(t(i,k),1,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='1766'></font>
      hsub = xls<a name='1767'>
      hvap = xlv0<a name='1768'>
      cvap = cpv<a name='1769'>
      ttp=t0c+0.01<a name='1770'>
      dldt=cvap-cliq<a name='1771'>
      xa=-dldt/rv<a name='1772'>
      xb=xa+hvap/(rv*ttp)<a name='1773'>
      dldti=cvap-cice<a name='1774'>
      xai=-dldti/rv<a name='1775'>
      xbi=xai+hsub/(rv*ttp)<a name='1776'>
      do k = kts, kte<a name='1777'>
        do i = its, ite<a name='1778'>
          tr=ttp/t(i,k)<a name='1779'>
          qs(i,k,1)=psat*exp(log(tr)*(xa))*exp(xb*(1.-tr))<a name='1780'>
          qs(i,k,1) = min(qs(i,k,1),0.99*p(i,k))<a name='1781'>
          qs(i,k,1) = ep2 * qs(i,k,1) / (p(i,k) - qs(i,k,1))<a name='1782'>
          qs(i,k,1) = max(qs(i,k,1),qmin)<a name='1783'>
          tr=ttp/t(i,k)<a name='1784'>
          if(t(i,k).lt.ttp) then<a name='1785'>
            qs(i,k,2)=psat*exp(log(tr)*(xai))*exp(xbi*(1.-tr))<a name='1786'>
          else<a name='1787'>
            qs(i,k,2)=psat*exp(log(tr)*(xa))*exp(xb*(1.-tr))<a name='1788'>
          endif<a name='1789'>
          qs(i,k,2) = min(qs(i,k,2),0.99*p(i,k))<a name='1790'>
          qs(i,k,2) = ep2 * qs(i,k,2) / (p(i,k) - qs(i,k,2))<a name='1791'>
          qs(i,k,2) = max(qs(i,k,2),qmin)<a name='1792'>
          rh(i,k,1) = max(q(i,k) / qs(i,k,1),qmin)<a name='1793'>
        enddo<a name='1794'>
      enddo<a name='1795'>
<font color=#447700>!<a name='1796'></font>
      call <A href='../../html_code/phys/module_mp_wdm6.F.html#SLOPE_WDM6'>slope_wdm6</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM62D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_WDM6_4">(qrs_tmp,ncr_tmp,den_tmp,denfac,t,rslope,rslopeb,rslope2, &amp;<a name='1797'>
                     rslope3,work1,workn,its,ite,kts,kte)<a name='1798'>
      do k = kts, kte<a name='1799'>
        do i = its, ite<a name='1800'>
<font color=#447700>!-----------------------------------------------------------------<a name='1801'></font>
<font color=#447700>! re-compute the mean-volume drop diameter       [LH A10]<a name='1802'></font>
<font color=#447700>! for raindrop distribution<a name='1803'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='1804'></font>
          avedia(i,k,2) = rslope(i,k,1)*((24.)**(.3333333))<a name='1805'>
<font color=#447700>!----------------------------------------------------------------<a name='1806'></font>
<font color=#447700>! Nrevp_s: evaporation/condensation rate of rain   [LH A14]<a name='1807'></font>
<font color=#447700>!        (NR-&gt;NC)<a name='1808'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1809'></font>
          if(avedia(i,k,2).le.di82) then<a name='1810'>
            ncr(i,k,2) = ncr(i,k,2)+ncr(i,k,3)<a name='1811'>
            ncr(i,k,3) = 0.<a name='1812'>
<font color=#447700>!----------------------------------------------------------------<a name='1813'></font>
<font color=#447700>! Prevp_s: evaporation/condensation rate of rain [LH A15] [KK 23]<a name='1814'></font>
<font color=#447700>!        (QR-&gt;QC)<a name='1815'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1816'></font>
            qci(i,k,1) = qci(i,k,1)+qrs(i,k,1)<a name='1817'>
            qrs(i,k,1) = 0.<a name='1818'>
          endif<a name='1819'>
        enddo<a name='1820'>
      enddo<a name='1821'>
<font color=#447700>!<a name='1822'></font>
      do k = kts, kte<a name='1823'>
        do i = its, ite<a name='1824'>
<font color=#447700>!---------------------------------------------------------------<a name='1825'></font>
<font color=#447700>! rate of change of cloud drop concentration due to CCN activation<a name='1826'></font>
<font color=#447700>! pcact: QV -&gt; QC                                 [LH 8]  [KK 14]<a name='1827'></font>
<font color=#447700>! ncact: NCCN -&gt; NC                               [LH A2] [KK 12]<a name='1828'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1829'></font>
          if(rh(i,k,1).gt.1.) then<a name='1830'>
            ncact(i,k) = max(0.,((ncr(i,k,1)+ncr(i,k,2))                       &amp;<a name='1831'>
                       *min(1.,(rh(i,k,1)/satmax)**actk) - ncr(i,k,2)))/dtcld<a name='1832'>
            ncact(i,k) =min(ncact(i,k),max(ncr(i,k,1),0.)/dtcld)<a name='1833'>
            pcact(i,k) = min(4.*pi*denr*(actr*1.E-6)**3*ncact(i,k)/            &amp;<a name='1834'>
                         (3.*den(i,k)),max(q(i,k),0.)/dtcld)<a name='1835'>
            q(i,k) = max(q(i,k)-pcact(i,k)*dtcld,0.)<a name='1836'>
            qci(i,k,1) = max(qci(i,k,1)+pcact(i,k)*dtcld,0.)<a name='1837'>
            ncr(i,k,1) = max(ncr(i,k,1)-ncact(i,k)*dtcld,0.)<a name='1838'>
            ncr(i,k,2) = max(ncr(i,k,2)+ncact(i,k)*dtcld,0.)<a name='1839'>
            t(i,k) = t(i,k)+pcact(i,k)*xl(i,k)/cpm(i,k)*dtcld<a name='1840'>
          endif  <a name='1841'>
<font color=#447700>!---------------------------------------------------------------<a name='1842'></font>
<font color=#447700>!  pcond:condensational/evaporational rate of cloud water [HL A46] [RH83 A6]<a name='1843'></font>
<font color=#447700>!     if there exists additional water vapor condensated/if<a name='1844'></font>
<font color=#447700>!     evaporation of cloud water is not enough to remove subsaturation<a name='1845'></font>
<font color=#447700>!  (QV-&gt;QC or QC-&gt;QV)     <a name='1846'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1847'></font>
          tr=ttp/t(i,k)<a name='1848'>
          qs(i,k,1)=psat*exp(log(tr)*(xa))*exp(xb*(1.-tr))<a name='1849'>
          qs(i,k,1) = min(qs(i,k,1),0.99*p(i,k))<a name='1850'>
          qs(i,k,1) = ep2 * qs(i,k,1) / (p(i,k) - qs(i,k,1))<a name='1851'>
          qs(i,k,1) = max(qs(i,k,1),qmin)<a name='1852'>
          work1(i,k,1) = conden(t(i,k),q(i,k),qs(i,k,1),xl(i,k),cpm(i,k))<a name='1853'>
          work2(i,k) = qci(i,k,1)+work1(i,k,1)<a name='1854'>
          pcond(i,k) = min(max(work1(i,k,1)/dtcld,0.),max(q(i,k),0.)/dtcld)<a name='1855'>
          if(qci(i,k,1).gt.0. .and. work1(i,k,1).lt.0.)                        &amp; <a name='1856'>
            pcond(i,k) = max(work1(i,k,1),-qci(i,k,1))/dtcld<a name='1857'>
<font color=#447700>!----------------------------------------------------------------<a name='1858'></font>
<font color=#447700>! ncevp: evpration of Cloud number concentration  [LH A3] <a name='1859'></font>
<font color=#447700>! (NC-&gt;NCCN) <a name='1860'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1861'></font>
          if(pcond(i,k).eq.-qci(i,k,1)/dtcld) then<a name='1862'>
            ncr(i,k,2) = 0.<a name='1863'>
            ncr(i,k,1) = ncr(i,k,1)+ncr(i,k,2)<a name='1864'>
          endif<a name='1865'>
<font color=#447700>!<a name='1866'></font>
          q(i,k) = q(i,k)-pcond(i,k)*dtcld<a name='1867'>
          qci(i,k,1) = max(qci(i,k,1)+pcond(i,k)*dtcld,0.)<a name='1868'>
          t(i,k) = t(i,k)+pcond(i,k)*xl(i,k)/cpm(i,k)*dtcld<a name='1869'>
        enddo<a name='1870'>
      enddo<a name='1871'>
<font color=#447700>!<a name='1872'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1873'></font>
<font color=#447700>!     padding for small values<a name='1874'></font>
<font color=#447700>!<a name='1875'></font>
      do k = kts, kte<a name='1876'>
        do i = its, ite<a name='1877'>
          if(qci(i,k,1).le.qmin) qci(i,k,1) = 0.0<a name='1878'>
          if(qci(i,k,2).le.qmin) qci(i,k,2) = 0.0<a name='1879'>
          if(qrs(i,k,1).ge.qcrmin .and. ncr(i,k,3) .ge. nrmin) then<a name='1880'>
            lamdr_tmp(i,k) = exp(log(((pidnr*ncr(i,k,3))                       &amp; <a name='1881'>
                         /(den(i,k)*qrs(i,k,1))))*((.33333333)))<a name='1882'>
            if(lamdr_tmp(i,k) .le. lamdarmin) then<a name='1883'>
              lamdr_tmp(i,k) = lamdarmin<a name='1884'>
              ncr(i,k,3) = den(i,k)*qrs(i,k,1)*lamdr_tmp(i,k)**3/pidnr<a name='1885'>
            elseif(lamdr_tmp(i,k) .ge. lamdarmax) then<a name='1886'>
              lamdr_tmp(i,k) = lamdarmax <a name='1887'>
              ncr(i,k,3) = den(i,k)*qrs(i,k,1)*lamdr_tmp(i,k)**3/pidnr<a name='1888'>
            endif<a name='1889'>
          endif  <a name='1890'>
          if(qci(i,k,1).ge.qmin .and. ncr(i,k,2) .ge. ncmin ) then<a name='1891'>
            lamdc_tmp(i,k) = exp(log(((pidnc*ncr(i,k,2))                       &amp;<a name='1892'>
                         /(den(i,k)*qci(i,k,1))))*((.33333333)))<a name='1893'>
            if(lamdc_tmp(i,k) .le. lamdacmin) then<a name='1894'>
              lamdc_tmp(i,k) = lamdacmin<a name='1895'>
              ncr(i,k,2) = den(i,k)*qci(i,k,1)*lamdc_tmp(i,k)**3/pidnc<a name='1896'>
            elseif(lamdc_tmp(i,k) .ge. lamdacmax) then<a name='1897'>
              lamdc_tmp(i,k) = lamdacmax<a name='1898'>
              ncr(i,k,2) = den(i,k)*qci(i,k,1)*lamdc_tmp(i,k)**3/pidnc<a name='1899'>
            endif<a name='1900'>
          endif<a name='1901'>
        enddo<a name='1902'>
      enddo<a name='1903'>
      enddo                  <font color=#447700>! big loops<a name='1904'></font>
  END SUBROUTINE wdm62d<a name='1905'>
<font color=#447700>! ...................................................................<a name='1906'></font>
<A NAME='RGMMA'><A href='../../html_code/phys/module_mp_wdm6.F.html#RGMMA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1907'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>rgmma</font>(x) <A href='../../call_to/RGMMA.html' TARGET='index'>76</A><a name='1908'>
<font color=#447700>!-------------------------------------------------------------------<a name='1909'></font>
  IMPLICIT NONE<a name='1910'>
<font color=#447700>!-------------------------------------------------------------------<a name='1911'></font>
<font color=#447700>!     rgmma function:  use infinite product form<a name='1912'></font>
      REAL :: euler<a name='1913'>
      PARAMETER (euler=0.577215664901532)<a name='1914'>
      REAL :: x, y<a name='1915'>
      INTEGER :: i<a name='1916'>
      if(x.eq.1.)then<a name='1917'>
        rgmma=0.<a name='1918'>
      else<a name='1919'>
        rgmma=x*exp(euler*x)<a name='1920'>
        do i=1,10000<a name='1921'>
          y=float(i)<a name='1922'>
          rgmma=rgmma*(1.000+x/y)*exp(-x/y)<a name='1923'>
        enddo<a name='1924'>
        rgmma=1./rgmma<a name='1925'>
      endif<a name='1926'>
      END FUNCTION rgmma<a name='1927'>
<font color=#447700>!<a name='1928'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='1929'></font>
<A NAME='FPVS'><A href='../../html_code/phys/module_mp_wdm6.F.html#FPVS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1930'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>fpvs</font>(t,ice,rd,rv,cvap,cliq,cice,hvap,hsub,psat,t0c) <A href='../../call_to/FPVS.html' TARGET='index'>9</A>,<A href='../../call_from/FPVS.html' TARGET='index'>1</A><a name='1931'>
<font color=#447700>!--------------------------------------------------------------------------<a name='1932'></font>
      IMPLICIT NONE<a name='1933'>
<font color=#447700>!--------------------------------------------------------------------------<a name='1934'></font>
      REAL t,rd,rv,cvap,cliq,cice,hvap,hsub,psat,t0c,dldt,xa,xb,dldti,         &amp;<a name='1935'>
           xai,xbi,ttp,tr<a name='1936'>
      INTEGER ice<a name='1937'>
<font color=#447700>! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<a name='1938'></font>
      ttp=t0c+0.01<a name='1939'>
      dldt=cvap-cliq<a name='1940'>
      xa=-dldt/rv<a name='1941'>
      xb=xa+hvap/(rv*ttp)<a name='1942'>
      dldti=cvap-cice<a name='1943'>
      xai=-dldti/rv<a name='1944'>
      xbi=xai+hsub/(rv*ttp)<a name='1945'>
      tr=ttp/t<a name='1946'>
      if(t.lt.ttp .and. ice.eq.1) then<a name='1947'>
        fpvs=psat*(tr**xai)*exp(xbi*(1.-tr))<a name='1948'>
      else<a name='1949'>
        fpvs=psat*(tr**xa)*exp(xb*(1.-tr))<a name='1950'>
      endif<a name='1951'>
<font color=#447700>! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<a name='1952'></font>
      END FUNCTION fpvs<a name='1953'>
<font color=#447700>!-------------------------------------------------------------------<a name='1954'></font>
<A NAME='WDM6INIT'><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1955'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>wdm6init</font>(den0,denr,dens,cl,cpv, ccn0, hail_opt, allowed_to_read) <font color=#447700>! RAS <A href='../../call_to/WDM6INIT.html' TARGET='index'>1</A>,<A href='../../call_from/WDM6INIT.html' TARGET='index'>18</A><a name='1956'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='1957'></font>
  IMPLICIT NONE<a name='1958'>
<font color=#447700>!-------------------------------------------------------------------<a name='1959'></font>
<font color=#447700>!.... constants which may not be tunable<a name='1960'></font>
   REAL, INTENT(IN) :: den0,denr,dens,cl,cpv,ccn0<a name='1961'>
   INTEGER, INTENT(IN) :: hail_opt  <font color=#447700>! RAS<a name='1962'></font>
   LOGICAL, INTENT(IN) :: allowed_to_read<a name='1963'>
 <a name='1964'>
<font color=#447700>! RAS13.1 define graupel parameters as graupel-like or hail-like,<a name='1965'></font>
<font color=#447700>!         depending on namelist option<a name='1966'></font>
      IF (hail_opt .eq. 1) THEN <font color=#447700>!Hail!<a name='1967'></font>
         n0g       = 4.e4<a name='1968'>
         deng      = 700.<a name='1969'>
         avtg      = 285.0<a name='1970'>
         bvtg      = 0.8<a name='1971'>
         lamdagmax = 2.e4<a name='1972'>
      ELSE <font color=#447700>!Graupel!<a name='1973'></font>
         n0g       = 4.e6<a name='1974'>
         deng      = 500<a name='1975'>
         avtg      = 330.0<a name='1976'>
         bvtg      = 0.8<a name='1977'>
         lamdagmax = 6.e4<a name='1978'>
      ENDIF<a name='1979'>
<font color=#447700>!<a name='1980'></font>
   pi = 4.*atan(1.)<a name='1981'>
   xlv1 = cl-cpv<a name='1982'>
<font color=#447700>!<a name='1983'></font>
   qc0  = 4./3.*pi*denr*r0**3*xncr/den0  <font color=#447700>! 0.419e-3 -- .61e-3<a name='1984'></font>
   qck1 = .104*9.8*peaut/(xncr*denr)**(1./3.)/xmyu*den0**(4./3.) <font color=#447700>! 7.03<a name='1985'></font>
   pidnc = pi*denr/6.<a name='1986'>
<font color=#447700>!<a name='1987'></font>
   bvtr1 = 1.+bvtr<a name='1988'>
   bvtr2 = 2.+bvtr<a name='1989'>
   bvtr3 = 3.+bvtr<a name='1990'>
   bvtr4 = 4.+bvtr<a name='1991'>
   bvtr5 = 5.+bvtr<a name='1992'>
   bvtr6 = 6.+bvtr<a name='1993'>
   bvtr7 = 7.+bvtr<a name='1994'>
   bvtr2o5 = 2.5+.5*bvtr<a name='1995'>
   bvtr3o5 = 3.5+.5*bvtr<a name='1996'>
   g1pbr = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_14">(bvtr1)<a name='1997'>
   g2pbr = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_15">(bvtr2)<a name='1998'>
   g3pbr = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_16">(bvtr3)<a name='1999'>
   g4pbr = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_17">(bvtr4)            <font color=#447700>! 17.837825<a name='2000'></font>
   g5pbr = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_18">(bvtr5)<a name='2001'>
   g6pbr = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_19">(bvtr6)<a name='2002'>
   g7pbr = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_20">(bvtr7)<a name='2003'>
   g5pbro2 = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_21">(bvtr2o5) <a name='2004'>
   g7pbro2 = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_22">(bvtr3o5)<a name='2005'>
   pvtr = avtr*g5pbr/24.<a name='2006'>
   pvtrn = avtr*g2pbr<a name='2007'>
   eacrr = 1.0<a name='2008'>
   pacrr = pi*n0r*avtr*g3pbr*.25*eacrr<a name='2009'>
   precr1 = 2.*pi*1.56<a name='2010'>
   precr2 = 2.*pi*.31*avtr**.5*g7pbro2<a name='2011'>
   pidn0r =  pi*denr*n0r<a name='2012'>
   pidnr = 4.*pi*denr<a name='2013'>
<font color=#447700>!<a name='2014'></font>
   xmmax = (dimax/dicon)**2<a name='2015'>
   roqimax = 2.08e22*dimax**8<a name='2016'>
<font color=#447700>!<a name='2017'></font>
   bvts1 = 1.+bvts<a name='2018'>
   bvts2 = 2.5+.5*bvts<a name='2019'>
   bvts3 = 3.+bvts<a name='2020'>
   bvts4 = 4.+bvts<a name='2021'>
   g1pbs = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_23">(bvts1)    <font color=#447700>!.8875<a name='2022'></font>
   g3pbs = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_24">(bvts3)<a name='2023'>
   g4pbs = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_25">(bvts4)    <font color=#447700>! 12.0786<a name='2024'></font>
   g5pbso2 = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_26">(bvts2)<a name='2025'>
   pvts = avts*g4pbs/6.<a name='2026'>
   pacrs = pi*n0s*avts*g3pbs*.25<a name='2027'>
   precs1 = 4.*n0s*.65<a name='2028'>
   precs2 = 4.*n0s*.44*avts**.5*g5pbso2<a name='2029'>
   pidn0s =  pi*dens*n0s<a name='2030'>
<font color=#447700>!<a name='2031'></font>
   pacrc = pi*n0s*avts*g3pbs*.25*eacrc<a name='2032'>
<font color=#447700>!<a name='2033'></font>
   bvtg1 = 1.+bvtg<a name='2034'>
   bvtg2 = 2.5+.5*bvtg<a name='2035'>
   bvtg3 = 3.+bvtg<a name='2036'>
   bvtg4 = 4.+bvtg<a name='2037'>
   g1pbg = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_27">(bvtg1)<a name='2038'>
   g3pbg = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_28">(bvtg3)<a name='2039'>
   g4pbg = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_29">(bvtg4)<a name='2040'>
   g5pbgo2 = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_30">(bvtg2)<a name='2041'>
   pacrg = pi*n0g*avtg*g3pbg*.25<a name='2042'>
   pvtg = avtg*g4pbg/6.<a name='2043'>
   precg1 = 2.*pi*n0g*.78<a name='2044'>
   precg2 = 2.*pi*n0g*.31*avtg**.5*g5pbgo2<a name='2045'>
   pidn0g =  pi*deng*n0g<a name='2046'>
<font color=#447700>!<a name='2047'></font>
   rslopecmax = 1./lamdacmax<a name='2048'>
   rslopermax = 1./lamdarmax<a name='2049'>
   rslopesmax = 1./lamdasmax<a name='2050'>
   rslopegmax = 1./lamdagmax<a name='2051'>
   rsloperbmax = rslopermax ** bvtr<a name='2052'>
   rslopesbmax = rslopesmax ** bvts<a name='2053'>
   rslopegbmax = rslopegmax ** bvtg<a name='2054'>
   rslopec2max = rslopecmax * rslopecmax<a name='2055'>
   rsloper2max = rslopermax * rslopermax<a name='2056'>
   rslopes2max = rslopesmax * rslopesmax<a name='2057'>
   rslopeg2max = rslopegmax * rslopegmax<a name='2058'>
   rslopec3max = rslopec2max * rslopecmax<a name='2059'>
   rsloper3max = rsloper2max * rslopermax<a name='2060'>
   rslopes3max = rslopes2max * rslopesmax<a name='2061'>
   rslopeg3max = rslopeg2max * rslopegmax<a name='2062'>
<a name='2063'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2064'></font>
<font color=#447700>!..Set these variables needed for computing radar reflectivity.  These<a name='2065'></font>
<font color=#447700>!.. get used within radar_init to create other variables used in the<a name='2066'></font>
<font color=#447700>!.. radar module.<a name='2067'></font>
   xam_r = PI*denr/6.<a name='2068'>
   xbm_r = 3.<a name='2069'>
   xmu_r = 1.<a name='2070'>
   xam_s = PI*dens/6.<a name='2071'>
   xbm_s = 3.<a name='2072'>
   xmu_s = 0.<a name='2073'>
   xam_g = PI*deng/6.<a name='2074'>
   xbm_g = 3.<a name='2075'>
   xmu_g = 0.<a name='2076'>
<a name='2077'>
   call <A href='../../html_code/phys/module_mp_radar.F.html#RADAR_INIT'>radar_init</A><A href='../../html_code/phys/module_mp_wdm6.F.html#WDM6INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADAR_INIT_8"><a name='2078'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2079'></font>
<font color=#447700>!<a name='2080'></font>
  END SUBROUTINE wdm6init<a name='2081'>
<font color=#447700>!------------------------------------------------------------------------------<a name='2082'></font>
<A NAME='SLOPE_WDM6'><A href='../../html_code/phys/module_mp_wdm6.F.html#SLOPE_WDM6' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2083'>
      <font color=#993300>subroutine </font><font color=#cc0000>slope_wdm6</font>(qrs,ncr,den,denfac,t,rslope,rslopeb,rslope2,rslope3, &amp; <A href='../../call_to/SLOPE_WDM6.html' TARGET='index'>4</A><a name='2084'>
                            vt,vtn,its,ite,kts,kte)<a name='2085'>
  IMPLICIT NONE<a name='2086'>
  INTEGER       ::               its,ite, jts,jte, kts,kte<a name='2087'>
  REAL, DIMENSION( its:ite , kts:kte,3) ::                                     &amp;<a name='2088'>
                                                                          qrs, &amp;<a name='2089'>
                                                                       rslope, &amp;<a name='2090'>
                                                                      rslopeb, &amp;<a name='2091'>
                                                                      rslope2, &amp;<a name='2092'>
                                                                      rslope3, &amp; <a name='2093'>
                                                                           vt<a name='2094'>
  REAL, DIMENSION( its:ite , kts:kte) ::                                       &amp;<a name='2095'>
                                                                          ncr, &amp; <a name='2096'>
                                                                          vtn, &amp; <a name='2097'>
                                                                          den, &amp;<a name='2098'>
                                                                       denfac, &amp;<a name='2099'>
                                                                            t<a name='2100'>
  REAL, PARAMETER  :: t0c = 273.15<a name='2101'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                                      &amp;<a name='2102'>
                                                                       n0sfac<a name='2103'>
  REAL       ::  lamdar, lamdas, lamdag, x, y, z, supcol<a name='2104'>
  integer :: i, j, k<a name='2105'>
<font color=#447700>!----------------------------------------------------------------<a name='2106'></font>
<font color=#447700>!     size distributions: (x=mixing ratio, y=air density):<a name='2107'></font>
<font color=#447700>!     valid for mixing ratio &gt; 1.e-9 kg/kg.<a name='2108'></font>
<font color=#447700>!<a name='2109'></font>
<font color=#447700>!  Optimizatin : A**B =&gt; exp(log(A)*(B))<a name='2110'></font>
      lamdar(x,y,z)= exp(log(((pidnr*z)/(x*y)))*((.33333333)))<a name='2111'>
      lamdas(x,y,z)= sqrt(sqrt(pidn0s*z/(x*y)))    <font color=#447700>! (pidn0s*z/(x*y))**.25<a name='2112'></font>
      lamdag(x,y)=   sqrt(sqrt(pidn0g/(x*y)))      <font color=#447700>! (pidn0g/(x*y))**.25<a name='2113'></font>
<font color=#447700>!<a name='2114'></font>
      do k = kts, kte<a name='2115'>
        do i = its, ite<a name='2116'>
          supcol = t0c-t(i,k)<a name='2117'>
<font color=#447700>!---------------------------------------------------------------<a name='2118'></font>
<font color=#447700>! n0s: Intercept parameter for snow [m-4] [HDC 6]<a name='2119'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2120'></font>
          n0sfac(i,k) = max(min(exp(alpha*supcol),n0smax/n0s),1.)<a name='2121'>
          if(qrs(i,k,1).le.qcrmin .or. ncr(i,k).le.nrmin ) then<a name='2122'>
            rslope(i,k,1) = rslopermax<a name='2123'>
            rslopeb(i,k,1) = rsloperbmax<a name='2124'>
            rslope2(i,k,1) = rsloper2max<a name='2125'>
            rslope3(i,k,1) = rsloper3max<a name='2126'>
          else<a name='2127'>
            rslope(i,k,1) = min(1./lamdar(qrs(i,k,1),den(i,k),ncr(i,k)),1.e-3)<a name='2128'>
            rslopeb(i,k,1) = rslope(i,k,1)**bvtr<a name='2129'>
            rslope2(i,k,1) = rslope(i,k,1)*rslope(i,k,1)<a name='2130'>
            rslope3(i,k,1) = rslope2(i,k,1)*rslope(i,k,1)<a name='2131'>
          endif<a name='2132'>
          if(qrs(i,k,2).le.qcrmin) then<a name='2133'>
            rslope(i,k,2) = rslopesmax<a name='2134'>
            rslopeb(i,k,2) = rslopesbmax<a name='2135'>
            rslope2(i,k,2) = rslopes2max<a name='2136'>
            rslope3(i,k,2) = rslopes3max<a name='2137'>
          else<a name='2138'>
            rslope(i,k,2) = 1./lamdas(qrs(i,k,2),den(i,k),n0sfac(i,k))<a name='2139'>
            rslopeb(i,k,2) = rslope(i,k,2)**bvts<a name='2140'>
            rslope2(i,k,2) = rslope(i,k,2)*rslope(i,k,2)<a name='2141'>
            rslope3(i,k,2) = rslope2(i,k,2)*rslope(i,k,2)<a name='2142'>
          endif<a name='2143'>
          if(qrs(i,k,3).le.qcrmin) then<a name='2144'>
            rslope(i,k,3) = rslopegmax<a name='2145'>
            rslopeb(i,k,3) = rslopegbmax<a name='2146'>
            rslope2(i,k,3) = rslopeg2max<a name='2147'>
            rslope3(i,k,3) = rslopeg3max<a name='2148'>
          else<a name='2149'>
            rslope(i,k,3) = 1./lamdag(qrs(i,k,3),den(i,k))<a name='2150'>
            rslopeb(i,k,3) = rslope(i,k,3)**bvtg<a name='2151'>
            rslope2(i,k,3) = rslope(i,k,3)*rslope(i,k,3)<a name='2152'>
            rslope3(i,k,3) = rslope2(i,k,3)*rslope(i,k,3)<a name='2153'>
          endif<a name='2154'>
          vt(i,k,1) = pvtr*rslopeb(i,k,1)*denfac(i,k)<a name='2155'>
          vt(i,k,2) = pvts*rslopeb(i,k,2)*denfac(i,k)<a name='2156'>
          vt(i,k,3) = pvtg*rslopeb(i,k,3)*denfac(i,k)<a name='2157'>
          vtn(i,k) = pvtrn*rslopeb(i,k,1)*denfac(i,k)<a name='2158'>
          if(qrs(i,k,1).le.0.0) vt(i,k,1) = 0.0 <a name='2159'>
          if(qrs(i,k,2).le.0.0) vt(i,k,2) = 0.0<a name='2160'>
          if(qrs(i,k,3).le.0.0) vt(i,k,3) = 0.0<a name='2161'>
          if(ncr(i,k).le.0.0) vtn(i,k) = 0.0 <a name='2162'>
        enddo<a name='2163'>
      enddo<a name='2164'>
  END subroutine slope_wdm6<a name='2165'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2166'></font>
<A NAME='SLOPE_RAIN'><A href='../../html_code/phys/module_mp_wdm6.F.html#SLOPE_RAIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2167'>
      <font color=#993300>subroutine </font><font color=#cc0000>slope_rain</font>(qrs,ncr,den,denfac,t,rslope,rslopeb,rslope2,rslope3,   &amp; <A href='../../call_to/SLOPE_RAIN.html' TARGET='index'>6</A><a name='2168'>
                            vt,vtn,its,ite,kts,kte)<a name='2169'>
  IMPLICIT NONE<a name='2170'>
  INTEGER       ::               its,ite, jts,jte, kts,kte<a name='2171'>
  REAL, DIMENSION( its:ite , kts:kte) ::                                       &amp;<a name='2172'>
                                                                          qrs, &amp;<a name='2173'>
                                                                          ncr, &amp; <a name='2174'>
                                                                       rslope, &amp;<a name='2175'>
                                                                      rslopeb, &amp;<a name='2176'>
                                                                      rslope2, &amp;<a name='2177'>
                                                                      rslope3, &amp;<a name='2178'>
                                                                           vt, &amp;<a name='2179'>
                                                                          vtn, &amp;<a name='2180'>
                                                                          den, &amp;<a name='2181'>
                                                                       denfac, &amp;<a name='2182'>
                                                                            t<a name='2183'>
  REAL, PARAMETER  :: t0c = 273.15<a name='2184'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                                      &amp;<a name='2185'>
                                                                       n0sfac<a name='2186'>
  REAL       ::  lamdar, x, y, z, supcol<a name='2187'>
  integer :: i, j, k<a name='2188'>
<font color=#447700>!----------------------------------------------------------------<a name='2189'></font>
<font color=#447700>!     size distributions: (x=mixing ratio, y=air density):<a name='2190'></font>
<font color=#447700>!     valid for mixing ratio &gt; 1.e-9 kg/kg.<a name='2191'></font>
      lamdar(x,y,z)= exp(log(((pidnr*z)/(x*y)))*((.33333333)))<a name='2192'>
<font color=#447700>!<a name='2193'></font>
      do k = kts, kte<a name='2194'>
        do i = its, ite<a name='2195'>
          if(qrs(i,k).le.qcrmin .or. ncr(i,k).le.nrmin) then<a name='2196'>
            rslope(i,k) = rslopermax<a name='2197'>
            rslopeb(i,k) = rsloperbmax<a name='2198'>
            rslope2(i,k) = rsloper2max<a name='2199'>
            rslope3(i,k) = rsloper3max<a name='2200'>
          else<a name='2201'>
            rslope(i,k) = min(1./lamdar(qrs(i,k),den(i,k),ncr(i,k)),1.e-3)<a name='2202'>
            rslopeb(i,k) = rslope(i,k)**bvtr<a name='2203'>
            rslope2(i,k) = rslope(i,k)*rslope(i,k)<a name='2204'>
            rslope3(i,k) = rslope2(i,k)*rslope(i,k)<a name='2205'>
          endif<a name='2206'>
          vt(i,k) = pvtr*rslopeb(i,k)*denfac(i,k)<a name='2207'>
          vtn(i,k) = pvtrn*rslopeb(i,k)*denfac(i,k)<a name='2208'>
          if(qrs(i,k).le.0.0) vt(i,k) = 0.0<a name='2209'>
          if(ncr(i,k).le.0.0) vtn(i,k) = 0.0 <a name='2210'>
        enddo<a name='2211'>
      enddo<a name='2212'>
  END subroutine slope_rain<a name='2213'>
<font color=#447700>!------------------------------------------------------------------------------<a name='2214'></font>
<A NAME='SLOPE_SNOW'><A href='../../html_code/phys/module_mp_wdm6.F.html#SLOPE_SNOW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2215'>
      <font color=#993300>subroutine </font><font color=#cc0000>slope_snow</font>(qrs,den,denfac,t,rslope,rslopeb,rslope2,rslope3,   &amp; <A href='../../call_to/SLOPE_SNOW.html' TARGET='index'>4</A><a name='2216'>
                            vt,its,ite,kts,kte)<a name='2217'>
  IMPLICIT NONE<a name='2218'>
  INTEGER       ::               its,ite, jts,jte, kts,kte<a name='2219'>
  REAL, DIMENSION( its:ite , kts:kte) ::                                       &amp;<a name='2220'>
                                                                          qrs, &amp;<a name='2221'>
                                                                       rslope, &amp;<a name='2222'>
                                                                      rslopeb, &amp;<a name='2223'>
                                                                      rslope2, &amp;<a name='2224'>
                                                                      rslope3, &amp;<a name='2225'>
                                                                           vt, &amp;<a name='2226'>
                                                                          den, &amp;<a name='2227'>
                                                                       denfac, &amp;<a name='2228'>
                                                                            t<a name='2229'>
  REAL, PARAMETER  :: t0c = 273.15<a name='2230'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                                      &amp;<a name='2231'>
                                                                       n0sfac<a name='2232'>
  REAL       ::  lamdas, x, y, z, supcol<a name='2233'>
  integer :: i, j, k<a name='2234'>
<font color=#447700>!----------------------------------------------------------------<a name='2235'></font>
<font color=#447700>!     size distributions: (x=mixing ratio, y=air density):<a name='2236'></font>
<font color=#447700>!     valid for mixing ratio &gt; 1.e-9 kg/kg.<a name='2237'></font>
      lamdas(x,y,z)= sqrt(sqrt(pidn0s*z/(x*y)))    <font color=#447700>! (pidn0s*z/(x*y))**.25<a name='2238'></font>
<font color=#447700>!<a name='2239'></font>
      do k = kts, kte<a name='2240'>
        do i = its, ite<a name='2241'>
          supcol = t0c-t(i,k)<a name='2242'>
<font color=#447700>!---------------------------------------------------------------<a name='2243'></font>
<font color=#447700>! n0s: Intercept parameter for snow [m-4] [HDC 6]<a name='2244'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2245'></font>
          n0sfac(i,k) = max(min(exp(alpha*supcol),n0smax/n0s),1.)<a name='2246'>
          if(qrs(i,k).le.qcrmin)then<a name='2247'>
            rslope(i,k) = rslopesmax<a name='2248'>
            rslopeb(i,k) = rslopesbmax<a name='2249'>
            rslope2(i,k) = rslopes2max<a name='2250'>
            rslope3(i,k) = rslopes3max<a name='2251'>
          else<a name='2252'>
            rslope(i,k) = 1./lamdas(qrs(i,k),den(i,k),n0sfac(i,k))<a name='2253'>
            rslopeb(i,k) = rslope(i,k)**bvts<a name='2254'>
            rslope2(i,k) = rslope(i,k)*rslope(i,k)<a name='2255'>
            rslope3(i,k) = rslope2(i,k)*rslope(i,k)<a name='2256'>
          endif<a name='2257'>
          vt(i,k) = pvts*rslopeb(i,k)*denfac(i,k)<a name='2258'>
          if(qrs(i,k).le.0.0) vt(i,k) = 0.0<a name='2259'>
        enddo<a name='2260'>
      enddo<a name='2261'>
  END subroutine slope_snow<a name='2262'>
<font color=#447700>!----------------------------------------------------------------------------------<a name='2263'></font>
<A NAME='SLOPE_GRAUP'><A href='../../html_code/phys/module_mp_wdm6.F.html#SLOPE_GRAUP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2264'>
      <font color=#993300>subroutine </font><font color=#cc0000>slope_graup</font>(qrs,den,denfac,t,rslope,rslopeb,rslope2,rslope3,   &amp; <A href='../../call_to/SLOPE_GRAUP.html' TARGET='index'>2</A><a name='2265'>
                            vt,its,ite,kts,kte)<a name='2266'>
  IMPLICIT NONE<a name='2267'>
  INTEGER       ::               its,ite, jts,jte, kts,kte<a name='2268'>
  REAL, DIMENSION( its:ite , kts:kte) ::                                       &amp;<a name='2269'>
                                                                          qrs, &amp;<a name='2270'>
                                                                       rslope, &amp;<a name='2271'>
                                                                      rslopeb, &amp;<a name='2272'>
                                                                      rslope2, &amp;<a name='2273'>
                                                                      rslope3, &amp;<a name='2274'>
                                                                           vt, &amp;<a name='2275'>
                                                                          den, &amp;<a name='2276'>
                                                                       denfac, &amp;<a name='2277'>
                                                                            t<a name='2278'>
  REAL, PARAMETER  :: t0c = 273.15<a name='2279'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                                      &amp;<a name='2280'>
                                                                       n0sfac<a name='2281'>
  REAL       ::  lamdag, x, y, z, supcol<a name='2282'>
  integer :: i, j, k<a name='2283'>
<font color=#447700>!----------------------------------------------------------------<a name='2284'></font>
<font color=#447700>!     size distributions: (x=mixing ratio, y=air density):<a name='2285'></font>
<font color=#447700>!     valid for mixing ratio &gt; 1.e-9 kg/kg.<a name='2286'></font>
      lamdag(x,y)=   sqrt(sqrt(pidn0g/(x*y)))      <font color=#447700>! (pidn0g/(x*y))**.25<a name='2287'></font>
<font color=#447700>!<a name='2288'></font>
      do k = kts, kte<a name='2289'>
        do i = its, ite<a name='2290'>
<font color=#447700>!---------------------------------------------------------------<a name='2291'></font>
<font color=#447700>! n0s: Intercept parameter for snow [m-4] [HDC 6]<a name='2292'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2293'></font>
          if(qrs(i,k).le.qcrmin)then<a name='2294'>
            rslope(i,k) = rslopegmax<a name='2295'>
            rslopeb(i,k) = rslopegbmax<a name='2296'>
            rslope2(i,k) = rslopeg2max<a name='2297'>
            rslope3(i,k) = rslopeg3max<a name='2298'>
          else<a name='2299'>
            rslope(i,k) = 1./lamdag(qrs(i,k),den(i,k))<a name='2300'>
            rslopeb(i,k) = rslope(i,k)**bvtg<a name='2301'>
            rslope2(i,k) = rslope(i,k)*rslope(i,k)<a name='2302'>
            rslope3(i,k) = rslope2(i,k)*rslope(i,k)<a name='2303'>
          endif<a name='2304'>
          vt(i,k) = pvtg*rslopeb(i,k)*denfac(i,k)<a name='2305'>
          if(qrs(i,k).le.0.0) vt(i,k) = 0.0<a name='2306'>
        enddo<a name='2307'>
      enddo<a name='2308'>
  END subroutine slope_graup<a name='2309'>
<font color=#447700>!---------------------------------------------------------------------------------<a name='2310'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='2311'></font>
<A NAME='NISLFV_RAIN_PLMR'><A href='../../html_code/phys/module_mp_wdm6.F.html#NISLFV_RAIN_PLMR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2312'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>nislfv_rain_plmr</font>(im,km,denl,denfacl,tkl,dzl,wwl,rql,rnl,precip,dt,id,iter,rid) <A href='../../call_to/NISLFV_RAIN_PLMR.html' TARGET='index'>1</A>,<A href='../../call_from/NISLFV_RAIN_PLMR.html' TARGET='index'>2</A><a name='2313'>
<font color=#447700>!-------------------------------------------------------------------<a name='2314'></font>
<font color=#447700>!<a name='2315'></font>
<font color=#447700>! for non-iteration semi-Lagrangain forward advection for cloud<a name='2316'></font>
<font color=#447700>! with mass conservation and positive definite advection<a name='2317'></font>
<font color=#447700>! 2nd order interpolation with monotonic piecewise linear method<a name='2318'></font>
<font color=#447700>! this routine is under assumption of decfl &lt; 1 for semi_Lagrangian<a name='2319'></font>
<font color=#447700>!<a name='2320'></font>
<font color=#447700>! dzl    depth of model layer in meter<a name='2321'></font>
<font color=#447700>! wwl    terminal velocity at model layer m/s<a name='2322'></font>
<font color=#447700>! rql    cloud density*mixing ration<a name='2323'></font>
<font color=#447700>! precip precipitation<a name='2324'></font>
<font color=#447700>! dt     time step<a name='2325'></font>
<font color=#447700>! id     kind of precip: 0 test case; 1 raindrop<a name='2326'></font>
<font color=#447700>! iter   how many time to guess mean terminal velocity: 0 pure forward.<a name='2327'></font>
<font color=#447700>!        0 : use departure wind for advection<a name='2328'></font>
<font color=#447700>!        1 : use mean wind for advection<a name='2329'></font>
<font color=#447700>!        &gt; 1 : use mean wind after iter-1 iterations<a name='2330'></font>
<font color=#447700>!        rid : 1 for number 0 for mixing ratio<a name='2331'></font>
<font color=#447700>!<a name='2332'></font>
<font color=#447700>! author: hann-ming henry juang &lt;henry.juang@noaa.gov&gt;<a name='2333'></font>
<font color=#447700>!         implemented by song-you hong<a name='2334'></font>
<font color=#447700>!<a name='2335'></font>
      implicit none<a name='2336'>
      integer  im,km,id<a name='2337'>
      real  dt<a name='2338'>
      real  dzl(im,km),wwl(im,km),rql(im,km),rnl(im,km),precip(im)<a name='2339'>
      real  denl(im,km),denfacl(im,km),tkl(im,km)<a name='2340'>
<font color=#447700>!<a name='2341'></font>
      integer  i,k,n,m,kk,kb,kt,iter,rid<a name='2342'>
      real  tl,tl2,qql,dql,qqd<a name='2343'>
      real  th,th2,qqh,dqh<a name='2344'>
      real  zsum,qsum,dim,dip,c1,con1,fa1,fa2<a name='2345'>
      real  allold, allnew, zz, dzamin, cflmax, decfl<a name='2346'>
      real  dz(km), ww(km), qq(km), nr(km), wd(km), wa(km), wa2(km), was(km)<a name='2347'>
      real  den(km), denfac(km), tk(km)<a name='2348'>
      real  wi(km+1), zi(km+1), za(km+1)<a name='2349'>
      real  qn(km), qr(km),tmp(km),tmp1(km),tmp2(km),tmp3(km)<a name='2350'>
      real  dza(km+1), qa(km+1), qmi(km+1), qpi(km+1)<a name='2351'>
<font color=#447700>!<a name='2352'></font>
      precip(:) = 0.0<a name='2353'>
<font color=#447700>!<a name='2354'></font>
      i_loop : do i=1,im<a name='2355'>
<font color=#447700>! -----------------------------------<a name='2356'></font>
      dz(:) = dzl(i,:)<a name='2357'>
      qq(:) = rql(i,:)<a name='2358'>
      nr(:) = rnl(i,:)<a name='2359'>
      if(rid .eq. 1) nr(:) = rnl(i,:)/denl(i,:)<a name='2360'>
      ww(:) = wwl(i,:)<a name='2361'>
      den(:) = denl(i,:)<a name='2362'>
      denfac(:) = denfacl(i,:)<a name='2363'>
      tk(:) = tkl(i,:)<a name='2364'>
<font color=#447700>! skip for no precipitation for all layers<a name='2365'></font>
      allold = 0.0<a name='2366'>
      do k=1,km<a name='2367'>
        allold = allold + qq(k)<a name='2368'>
      enddo<a name='2369'>
      if(allold.le.0.0) then<a name='2370'>
        cycle i_loop<a name='2371'>
      endif<a name='2372'>
<font color=#447700>!<a name='2373'></font>
<font color=#447700>! compute interface values<a name='2374'></font>
      zi(1)=0.0<a name='2375'>
      do k=1,km<a name='2376'>
        zi(k+1) = zi(k)+dz(k)<a name='2377'>
      enddo<a name='2378'>
<font color=#447700>!<a name='2379'></font>
<font color=#447700>! save departure wind<a name='2380'></font>
      wd(:) = ww(:)<a name='2381'>
      n=1<a name='2382'>
 100  continue<a name='2383'>
<font color=#447700>! plm is 2nd order, we can use 2nd order wi or 3rd order wi<a name='2384'></font>
<font color=#447700>! 2nd order interpolation to get wi<a name='2385'></font>
      wi(1) = ww(1)<a name='2386'>
      wi(km+1) = ww(km)<a name='2387'>
      do k=2,km<a name='2388'>
        wi(k) = (ww(k)*dz(k-1)+ww(k-1)*dz(k))/(dz(k-1)+dz(k))<a name='2389'>
      enddo<a name='2390'>
<font color=#447700>! 3rd order interpolation to get wi<a name='2391'></font>
      fa1 = 9./16.<a name='2392'>
      fa2 = 1./16.<a name='2393'>
      wi(1) = ww(1)<a name='2394'>
      wi(2) = 0.5*(ww(2)+ww(1))<a name='2395'>
      do k=3,km-1<a name='2396'>
        wi(k) = fa1*(ww(k)+ww(k-1))-fa2*(ww(k+1)+ww(k-2))<a name='2397'>
      enddo<a name='2398'>
      wi(km) = 0.5*(ww(km)+ww(km-1))<a name='2399'>
      wi(km+1) = ww(km)<a name='2400'>
<font color=#447700>!<a name='2401'></font>
<font color=#447700>! terminate of top of raingroup<a name='2402'></font>
      do k=2,km<a name='2403'>
        if( ww(k).eq.0.0 ) wi(k)=ww(k-1)<a name='2404'>
      enddo<a name='2405'>
<font color=#447700>!<a name='2406'></font>
<font color=#447700>! diffusivity of wi<a name='2407'></font>
      con1 = 0.05<a name='2408'>
      do k=km,1,-1<a name='2409'>
        decfl = (wi(k+1)-wi(k))*dt/dz(k)<a name='2410'>
        if( decfl .gt. con1 ) then<a name='2411'>
          wi(k) = wi(k+1) - con1*dz(k)/dt<a name='2412'>
        endif<a name='2413'>
      enddo<a name='2414'>
<font color=#447700>! compute arrival point<a name='2415'></font>
      do k=1,km+1<a name='2416'>
        za(k) = zi(k) - wi(k)*dt<a name='2417'>
      enddo<a name='2418'>
<font color=#447700>!<a name='2419'></font>
      do k=1,km<a name='2420'>
        dza(k) = za(k+1)-za(k)<a name='2421'>
      enddo<a name='2422'>
      dza(km+1) = zi(km+1) - za(km+1)<a name='2423'>
<font color=#447700>!     <a name='2424'></font>
<font color=#447700>! computer deformation at arrival point<a name='2425'></font>
      do k=1,km<a name='2426'>
        qa(k) = qq(k)*dz(k)/dza(k)<a name='2427'>
        qr(k) = qa(k)/den(k)<a name='2428'>
        if(rid .eq. 1) qr(k) = qa(K)<a name='2429'>
      enddo<a name='2430'>
      qa(km+1) = 0.0<a name='2431'>
<font color=#447700>!     call maxmin(km,1,qa,' arrival points ')<a name='2432'></font>
<font color=#447700>!     <a name='2433'></font>
<font color=#447700>! compute arrival terminal velocity, and estimate mean terminal velocity<a name='2434'></font>
<font color=#447700>! then back to use mean terminal velocity<a name='2435'></font>
      if( n.le.iter ) then<a name='2436'>
        if(rid.eq.1) then<a name='2437'>
        call <A href='../../html_code/phys/module_mp_wsm6.F.html#SLOPE_RAIN'>slope_rain</A><A href='../../html_code/phys/module_mp_wdm6.F.html#NISLFV_RAIN_PLMR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_RAIN_3">(nr,qr,den,denfac,tk,tmp,tmp1,tmp2,tmp3,wa,wa2,1,1,1,km)<a name='2438'>
        else<a name='2439'>
        call <A href='../../html_code/phys/module_mp_wsm6.F.html#SLOPE_RAIN'>slope_rain</A><A href='../../html_code/phys/module_mp_wdm6.F.html#NISLFV_RAIN_PLMR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_RAIN_4">(qr,nr,den,denfac,tk,tmp,tmp1,tmp2,tmp3,wa,wa2,1,1,1,km)<a name='2440'>
        endif<a name='2441'>
        if(rid.eq.1) wa(:) = wa2(:)<a name='2442'>
        if( n.ge.2 ) wa(1:km)=0.5*(wa(1:km)+was(1:km))<a name='2443'>
        do k=1,km<a name='2444'>
<font color=#447700>!#ifdef DEBUG <a name='2445'></font>
<font color=#447700>!        print*,' slope_wsm3 ',qr(k)*1000.,den(k),denfac(k),tk(k),tmp(k),tmp1(k),tmp2(k),ww(k),wa(k)<a name='2446'></font>
<font color=#447700>!#endif<a name='2447'></font>
<font color=#447700>! mean wind is average of departure and new arrival winds<a name='2448'></font>
          ww(k) = 0.5* ( wd(k)+wa(k) )<a name='2449'>
        enddo<a name='2450'>
        was(:) = wa(:)<a name='2451'>
        n=n+1<a name='2452'>
        go to 100<a name='2453'>
      endif<a name='2454'>
<font color=#447700>!     <a name='2455'></font>
<font color=#447700>! estimate values at arrival cell interface with monotone<a name='2456'></font>
      do k=2,km<a name='2457'>
        dip=(qa(k+1)-qa(k))/(dza(k+1)+dza(k))<a name='2458'>
        dim=(qa(k)-qa(k-1))/(dza(k-1)+dza(k))<a name='2459'>
        if( dip*dim.le.0.0 ) then<a name='2460'>
          qmi(k)=qa(k)<a name='2461'>
          qpi(k)=qa(k)<a name='2462'>
        else<a name='2463'>
          qpi(k)=qa(k)+0.5*(dip+dim)*dza(k)<a name='2464'>
          qmi(k)=2.0*qa(k)-qpi(k)<a name='2465'>
          if( qpi(k).lt.0.0 .or. qmi(k).lt.0.0 ) then<a name='2466'>
            qpi(k) = qa(k)<a name='2467'>
            qmi(k) = qa(k)<a name='2468'>
          endif<a name='2469'>
        endif<a name='2470'>
      enddo<a name='2471'>
      qpi(1)=qa(1)<a name='2472'>
      qmi(1)=qa(1)<a name='2473'>
      qmi(km+1)=qa(km+1)<a name='2474'>
      qpi(km+1)=qa(km+1)<a name='2475'>
<font color=#447700>!<a name='2476'></font>
<font color=#447700>! interpolation to regular point<a name='2477'></font>
      qn = 0.0<a name='2478'>
      kb=1<a name='2479'>
      kt=1<a name='2480'>
      intp : do k=1,km<a name='2481'>
             kb=max(kb-1,1)<a name='2482'>
             kt=max(kt-1,1)<a name='2483'>
<font color=#447700>! find kb and kt<a name='2484'></font>
             if( zi(k).ge.za(km+1) ) then<a name='2485'>
               exit intp<a name='2486'>
             else<a name='2487'>
               find_kb : do kk=kb,km<a name='2488'>
                         if( zi(k).le.za(kk+1) ) then<a name='2489'>
                           kb = kk<a name='2490'>
                           exit find_kb<a name='2491'>
                         else<a name='2492'>
                           cycle find_kb<a name='2493'>
                         endif<a name='2494'>
               enddo find_kb<a name='2495'>
               find_kt : do kk=kt,km<a name='2496'>
                         if( zi(k+1).le.za(kk) ) then<a name='2497'>
                           kt = kk<a name='2498'>
                           exit find_kt<a name='2499'>
                         else<a name='2500'>
                           cycle find_kt<a name='2501'>
                         endif<a name='2502'>
               enddo find_kt<a name='2503'>
               kt = kt - 1<a name='2504'>
<font color=#447700>! compute q with piecewise constant method<a name='2505'></font>
               if( kt.eq.kb ) then<a name='2506'>
                 tl=(zi(k)-za(kb))/dza(kb)<a name='2507'>
                 th=(zi(k+1)-za(kb))/dza(kb)<a name='2508'>
                 tl2=tl*tl<a name='2509'>
                 th2=th*th<a name='2510'>
                 qqd=0.5*(qpi(kb)-qmi(kb))<a name='2511'>
                 qqh=qqd*th2+qmi(kb)*th<a name='2512'>
                 qql=qqd*tl2+qmi(kb)*tl<a name='2513'>
                 qn(k) = (qqh-qql)/(th-tl)<a name='2514'>
               else if( kt.gt.kb ) then<a name='2515'>
                 tl=(zi(k)-za(kb))/dza(kb)<a name='2516'>
                 tl2=tl*tl<a name='2517'>
                 qqd=0.5*(qpi(kb)-qmi(kb))<a name='2518'>
                 qql=qqd*tl2+qmi(kb)*tl<a name='2519'>
                 dql = qa(kb)-qql<a name='2520'>
                 zsum  = (1.-tl)*dza(kb)<a name='2521'>
                 qsum  = dql*dza(kb)<a name='2522'>
                 if( kt-kb.gt.1 ) then<a name='2523'>
                 do m=kb+1,kt-1<a name='2524'>
                   zsum = zsum + dza(m)<a name='2525'>
                   qsum = qsum + qa(m) * dza(m)<a name='2526'>
                 enddo<a name='2527'>
                 endif<a name='2528'>
                 th=(zi(k+1)-za(kt))/dza(kt)<a name='2529'>
                 th2=th*th<a name='2530'>
                 qqd=0.5*(qpi(kt)-qmi(kt))<a name='2531'>
                 dqh=qqd*th2+qmi(kt)*th<a name='2532'>
                 zsum  = zsum + th*dza(kt)<a name='2533'>
                 qsum  = qsum + dqh*dza(kt)<a name='2534'>
                 qn(k) = qsum/zsum<a name='2535'>
               endif<a name='2536'>
               cycle intp<a name='2537'>
             endif<a name='2538'>
<font color=#447700>!     <a name='2539'></font>
       enddo intp<a name='2540'>
<font color=#447700>!            <a name='2541'></font>
<font color=#447700>! rain out<a name='2542'></font>
      sum_precip: do k=1,km<a name='2543'>
                    if( za(k).lt.0.0 .and. za(k+1).lt.0.0 ) then<a name='2544'>
                      precip(i) = precip(i) + qa(k)*dza(k)<a name='2545'>
                      cycle sum_precip<a name='2546'>
                    else if ( za(k).lt.0.0 .and. za(k+1).ge.0.0 ) then<a name='2547'>
                      precip(i) = precip(i) + qa(k)*(0.0-za(k))<a name='2548'>
                      exit sum_precip<a name='2549'>
                    endif<a name='2550'>
                    exit sum_precip<a name='2551'>
      enddo sum_precip<a name='2552'>
<font color=#447700>!              <a name='2553'></font>
<font color=#447700>! replace the new values <a name='2554'></font>
      rql(i,:) = qn(:)     <a name='2555'>
<font color=#447700>!                          <a name='2556'></font>
<font color=#447700>! ----------------------------------<a name='2557'></font>
      enddo i_loop         <a name='2558'>
<font color=#447700>!                        <a name='2559'></font>
  END SUBROUTINE nislfv_rain_plmr<a name='2560'>
<font color=#447700>!-------------------------------------------------------------------<a name='2561'></font>
<A NAME='NISLFV_RAIN_PLM6'><A href='../../html_code/phys/module_mp_wdm6.F.html#NISLFV_RAIN_PLM6' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2562'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>nislfv_rain_plm6</font>(im,km,denl,denfacl,tkl,dzl,wwl,rql,rql2, precip1, precip2,dt,id,iter) <A href='../../call_to/NISLFV_RAIN_PLM6.html' TARGET='index'>2</A>,<A href='../../call_from/NISLFV_RAIN_PLM6.html' TARGET='index'>4</A><a name='2563'>
<font color=#447700>!-------------------------------------------------------------------<a name='2564'></font>
<font color=#447700>!<a name='2565'></font>
<font color=#447700>! for non-iteration semi-Lagrangain forward advection for cloud<a name='2566'></font>
<font color=#447700>! with mass conservation and positive definite advection<a name='2567'></font>
<font color=#447700>! 2nd order interpolation with monotonic piecewise linear method<a name='2568'></font>
<font color=#447700>! this routine is under assumption of decfl &lt; 1 for semi_Lagrangian<a name='2569'></font>
<font color=#447700>!<a name='2570'></font>
<font color=#447700>! dzl    depth of model layer in meter<a name='2571'></font>
<font color=#447700>! wwl    terminal velocity at model layer m/s<a name='2572'></font>
<font color=#447700>! rql    cloud density*mixing ration<a name='2573'></font>
<font color=#447700>! precip precipitation<a name='2574'></font>
<font color=#447700>! dt     time step<a name='2575'></font>
<font color=#447700>! id     kind of precip: 0 test case; 1 raindrop<a name='2576'></font>
<font color=#447700>! iter   how many time to guess mean terminal velocity: 0 pure forward.<a name='2577'></font>
<font color=#447700>!        0 : use departure wind for advection<a name='2578'></font>
<font color=#447700>!        1 : use mean wind for advection<a name='2579'></font>
<font color=#447700>!        &gt; 1 : use mean wind after iter-1 iterations<a name='2580'></font>
<font color=#447700>!<a name='2581'></font>
<font color=#447700>! author: hann-ming henry juang &lt;henry.juang@noaa.gov&gt;<a name='2582'></font>
<font color=#447700>!         implemented by song-you hong<a name='2583'></font>
<font color=#447700>!<a name='2584'></font>
      implicit none<a name='2585'>
      integer  im,km,id<a name='2586'>
      real  dt<a name='2587'>
      real  dzl(im,km),wwl(im,km),rql(im,km),rql2(im,km),precip(im),precip1(im),precip2(im)<a name='2588'>
      real  denl(im,km),denfacl(im,km),tkl(im,km)<a name='2589'>
<font color=#447700>!<a name='2590'></font>
      integer  i,k,n,m,kk,kb,kt,iter,ist<a name='2591'>
      real  tl,tl2,qql,dql,qqd<a name='2592'>
      real  th,th2,qqh,dqh<a name='2593'>
      real  zsum,qsum,dim,dip,c1,con1,fa1,fa2<a name='2594'>
      real  allold, allnew, zz, dzamin, cflmax, decfl<a name='2595'>
      real  dz(km), ww(km), qq(km), qq2(km), wd(km), wa(km), wa2(km), was(km)<a name='2596'>
      real  den(km), denfac(km), tk(km)<a name='2597'>
      real  wi(km+1), zi(km+1), za(km+1)<a name='2598'>
      real  qn(km), qr(km),qr2(km),tmp(km),tmp1(km),tmp2(km),tmp3(km)<a name='2599'>
      real  dza(km+1), qa(km+1), qa2(km+1),qmi(km+1), qpi(km+1)<a name='2600'>
<font color=#447700>!<a name='2601'></font>
      precip(:) = 0.0<a name='2602'>
      precip1(:) = 0.0<a name='2603'>
      precip2(:) = 0.0<a name='2604'>
<font color=#447700>!<a name='2605'></font>
      i_loop : do i=1,im<a name='2606'>
<font color=#447700>! -----------------------------------<a name='2607'></font>
      dz(:) = dzl(i,:)<a name='2608'>
      qq(:) = rql(i,:)<a name='2609'>
      qq2(:) = rql2(i,:)<a name='2610'>
      ww(:) = wwl(i,:)<a name='2611'>
      den(:) = denl(i,:)<a name='2612'>
      denfac(:) = denfacl(i,:)<a name='2613'>
      tk(:) = tkl(i,:)<a name='2614'>
<font color=#447700>! skip for no precipitation for all layers<a name='2615'></font>
      allold = 0.0<a name='2616'>
      do k=1,km<a name='2617'>
        allold = allold + qq(k) + qq2(k)<a name='2618'>
      enddo<a name='2619'>
      if(allold.le.0.0) then<a name='2620'>
        cycle i_loop<a name='2621'>
      endif<a name='2622'>
<font color=#447700>!<a name='2623'></font>
<font color=#447700>! compute interface values<a name='2624'></font>
      zi(1)=0.0<a name='2625'>
      do k=1,km<a name='2626'>
        zi(k+1) = zi(k)+dz(k)<a name='2627'>
      enddo<a name='2628'>
<font color=#447700>!<a name='2629'></font>
<font color=#447700>! save departure wind<a name='2630'></font>
      wd(:) = ww(:)<a name='2631'>
      n=1<a name='2632'>
 100  continue<a name='2633'>
<font color=#447700>! plm is 2nd order, we can use 2nd order wi or 3rd order wi<a name='2634'></font>
<font color=#447700>! 2nd order interpolation to get wi<a name='2635'></font>
      wi(1) = ww(1)<a name='2636'>
      wi(km+1) = ww(km)<a name='2637'>
      do k=2,km<a name='2638'>
        wi(k) = (ww(k)*dz(k-1)+ww(k-1)*dz(k))/(dz(k-1)+dz(k))<a name='2639'>
      enddo<a name='2640'>
<font color=#447700>! 3rd order interpolation to get wi<a name='2641'></font>
      fa1 = 9./16.<a name='2642'>
      fa2 = 1./16.<a name='2643'>
      wi(1) = ww(1)<a name='2644'>
      wi(2) = 0.5*(ww(2)+ww(1))<a name='2645'>
      do k=3,km-1<a name='2646'>
        wi(k) = fa1*(ww(k)+ww(k-1))-fa2*(ww(k+1)+ww(k-2))<a name='2647'>
      enddo<a name='2648'>
      wi(km) = 0.5*(ww(km)+ww(km-1))<a name='2649'>
      wi(km+1) = ww(km)<a name='2650'>
<font color=#447700>!<a name='2651'></font>
<font color=#447700>! terminate of top of raingroup<a name='2652'></font>
      do k=2,km<a name='2653'>
        if( ww(k).eq.0.0 ) wi(k)=ww(k-1)<a name='2654'>
      enddo<a name='2655'>
<font color=#447700>!<a name='2656'></font>
<font color=#447700>! diffusivity of wi<a name='2657'></font>
      con1 = 0.05<a name='2658'>
      do k=km,1,-1<a name='2659'>
        decfl = (wi(k+1)-wi(k))*dt/dz(k)<a name='2660'>
        if( decfl .gt. con1 ) then<a name='2661'>
          wi(k) = wi(k+1) - con1*dz(k)/dt<a name='2662'>
        endif<a name='2663'>
      enddo<a name='2664'>
<font color=#447700>! compute arrival point<a name='2665'></font>
      do k=1,km+1<a name='2666'>
        za(k) = zi(k) - wi(k)*dt<a name='2667'>
      enddo<a name='2668'>
<font color=#447700>!<a name='2669'></font>
      do k=1,km<a name='2670'>
        dza(k) = za(k+1)-za(k)<a name='2671'>
      enddo<a name='2672'>
      dza(km+1) = zi(km+1) - za(km+1)<a name='2673'>
<font color=#447700>!<a name='2674'></font>
<font color=#447700>! computer deformation at arrival point<a name='2675'></font>
      do k=1,km<a name='2676'>
        qa(k) = qq(k)*dz(k)/dza(k)<a name='2677'>
        qa2(k) = qq2(k)*dz(k)/dza(k)<a name='2678'>
        qr(k) = qa(k)/den(k)<a name='2679'>
        qr2(k) = qa2(k)/den(k)<a name='2680'>
      enddo<a name='2681'>
      qa(km+1) = 0.0<a name='2682'>
      qa2(km+1) = 0.0<a name='2683'>
<font color=#447700>!     call maxmin(km,1,qa,' arrival points ')<a name='2684'></font>
<font color=#447700>!<a name='2685'></font>
<font color=#447700>! compute arrival terminal velocity, and estimate mean terminal velocity<a name='2686'></font>
<font color=#447700>! then back to use mean terminal velocity<a name='2687'></font>
      if( n.le.iter ) then<a name='2688'>
        call <A href='../../html_code/phys/module_mp_wsm6.F.html#SLOPE_SNOW'>slope_snow</A><A href='../../html_code/phys/module_mp_wsm6.F.html#NISLFV_RAIN_PLM6' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_SNOW_2">(qr,den,denfac,tk,tmp,tmp1,tmp2,tmp3,wa,1,1,1,km)<a name='2689'>
        call <A href='../../html_code/phys/module_mp_wsm6.F.html#SLOPE_GRAUP'>slope_graup</A><A href='../../html_code/phys/module_mp_wsm6.F.html#NISLFV_RAIN_PLM6' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLOPE_GRAUP_1">(qr2,den,denfac,tk,tmp,tmp1,tmp2,tmp3,wa2,1,1,1,km)<a name='2690'>
        do k = 1, km<a name='2691'>
          tmp(k) = max((qr(k)+qr2(k)), 1.E-15)<a name='2692'>
          IF ( tmp(k) .gt. 1.e-15 ) THEN<a name='2693'>
            wa(k) = (wa(k)*qr(k) + wa2(k)*qr2(k))/tmp(k)<a name='2694'>
          ELSE<a name='2695'>
            wa(k) = 0.<a name='2696'>
          ENDIF<a name='2697'>
        enddo<a name='2698'>
        if( n.ge.2 ) wa(1:km)=0.5*(wa(1:km)+was(1:km))<a name='2699'>
        do k=1,km<a name='2700'>
<font color=#447700>!#ifdef DEBUG<a name='2701'></font>
<font color=#447700>!        print*,' slope_wsm3 ',qr(k)*1000.,den(k),denfac(k),tk(k),tmp(k),tmp1(k),tmp2(k), &amp;<a name='2702'></font>
<font color=#447700>!           ww(k),wa(k)<a name='2703'></font>
<font color=#447700>!#endif<a name='2704'></font>
<font color=#447700>! mean wind is average of departure and new arrival winds<a name='2705'></font>
          ww(k) = 0.5* ( wd(k)+wa(k) )<a name='2706'>
        enddo<a name='2707'>
        was(:) = wa(:)<a name='2708'>
        n=n+1<a name='2709'>
        go to 100<a name='2710'>
      endif<a name='2711'>
      ist_loop : do ist = 1, 2<a name='2712'>
      if (ist.eq.2) then<a name='2713'>
       qa(:) = qa2(:)<a name='2714'>
      endif<a name='2715'>
<font color=#447700>!<a name='2716'></font>
      precip(i) = 0.<a name='2717'>
<font color=#447700>!<a name='2718'></font>
<font color=#447700>! estimate values at arrival cell interface with monotone<a name='2719'></font>
      do k=2,km<a name='2720'>
        dip=(qa(k+1)-qa(k))/(dza(k+1)+dza(k))<a name='2721'>
        dim=(qa(k)-qa(k-1))/(dza(k-1)+dza(k))<a name='2722'>
        if( dip*dim.le.0.0 ) then<a name='2723'>
          qmi(k)=qa(k)<a name='2724'>
          qpi(k)=qa(k)<a name='2725'>
        else<a name='2726'>
          qpi(k)=qa(k)+0.5*(dip+dim)*dza(k)<a name='2727'>
          qmi(k)=2.0*qa(k)-qpi(k)<a name='2728'>
          if( qpi(k).lt.0.0 .or. qmi(k).lt.0.0 ) then<a name='2729'>
            qpi(k) = qa(k)<a name='2730'>
            qmi(k) = qa(k)<a name='2731'>
          endif<a name='2732'>
        endif<a name='2733'>
      enddo<a name='2734'>
      qpi(1)=qa(1)<a name='2735'>
      qmi(1)=qa(1)<a name='2736'>
      qmi(km+1)=qa(km+1)<a name='2737'>
      qpi(km+1)=qa(km+1)<a name='2738'>
<font color=#447700>!<a name='2739'></font>
<font color=#447700>! interpolation to regular point<a name='2740'></font>
      qn = 0.0<a name='2741'>
      kb=1<a name='2742'>
      kt=1<a name='2743'>
      intp : do k=1,km<a name='2744'>
             kb=max(kb-1,1)<a name='2745'>
             kt=max(kt-1,1)<a name='2746'>
<font color=#447700>! find kb and kt<a name='2747'></font>
             if( zi(k).ge.za(km+1) ) then<a name='2748'>
               exit intp<a name='2749'>
             else<a name='2750'>
               find_kb : do kk=kb,km<a name='2751'>
                         if( zi(k).le.za(kk+1) ) then<a name='2752'>
                           kb = kk<a name='2753'>
                           exit find_kb<a name='2754'>
                         else<a name='2755'>
                           cycle find_kb<a name='2756'>
                         endif<a name='2757'>
               enddo find_kb<a name='2758'>
               find_kt : do kk=kt,km<a name='2759'>
                         if( zi(k+1).le.za(kk) ) then<a name='2760'>
                           kt = kk<a name='2761'>
                           exit find_kt<a name='2762'>
                         else<a name='2763'>
                           cycle find_kt<a name='2764'>
                         endif<a name='2765'>
               enddo find_kt<a name='2766'>
               kt = kt - 1<a name='2767'>
<font color=#447700>! compute q with piecewise constant method<a name='2768'></font>
               if( kt.eq.kb ) then<a name='2769'>
                 tl=(zi(k)-za(kb))/dza(kb)<a name='2770'>
                 th=(zi(k+1)-za(kb))/dza(kb)<a name='2771'>
                 tl2=tl*tl<a name='2772'>
                 th2=th*th<a name='2773'>
                 qqd=0.5*(qpi(kb)-qmi(kb))<a name='2774'>
                 qqh=qqd*th2+qmi(kb)*th<a name='2775'>
                 qql=qqd*tl2+qmi(kb)*tl<a name='2776'>
                 qn(k) = (qqh-qql)/(th-tl)<a name='2777'>
               else if( kt.gt.kb ) then<a name='2778'>
                 tl=(zi(k)-za(kb))/dza(kb)<a name='2779'>
                 tl2=tl*tl<a name='2780'>
                 qqd=0.5*(qpi(kb)-qmi(kb))<a name='2781'>
                 qql=qqd*tl2+qmi(kb)*tl<a name='2782'>
                 dql = qa(kb)-qql<a name='2783'>
                 zsum  = (1.-tl)*dza(kb)<a name='2784'>
                 qsum  = dql*dza(kb)<a name='2785'>
                 if( kt-kb.gt.1 ) then<a name='2786'>
                 do m=kb+1,kt-1<a name='2787'>
                   zsum = zsum + dza(m)<a name='2788'>
                   qsum = qsum + qa(m) * dza(m)<a name='2789'>
                 enddo<a name='2790'>
                 endif<a name='2791'>
                 th=(zi(k+1)-za(kt))/dza(kt)<a name='2792'>
                 th2=th*th<a name='2793'>
                 qqd=0.5*(qpi(kt)-qmi(kt))<a name='2794'>
                 dqh=qqd*th2+qmi(kt)*th<a name='2795'>
                 zsum  = zsum + th*dza(kt)<a name='2796'>
                 qsum  = qsum + dqh*dza(kt)<a name='2797'>
                 qn(k) = qsum/zsum<a name='2798'>
               endif<a name='2799'>
               cycle intp<a name='2800'>
             endif<a name='2801'>
<font color=#447700>!<a name='2802'></font>
       enddo intp<a name='2803'>
<font color=#447700>!<a name='2804'></font>
<font color=#447700>! rain out<a name='2805'></font>
      sum_precip: do k=1,km<a name='2806'>
                    if( za(k).lt.0.0 .and. za(k+1).lt.0.0 ) then<a name='2807'>
                      precip(i) = precip(i) + qa(k)*dza(k)<a name='2808'>
                      cycle sum_precip<a name='2809'>
                    else if ( za(k).lt.0.0 .and. za(k+1).ge.0.0 ) then<a name='2810'>
                      precip(i) = precip(i) + qa(k)*(0.0-za(k))<a name='2811'>
                      exit sum_precip<a name='2812'>
                    endif<a name='2813'>
                    exit sum_precip<a name='2814'>
      enddo sum_precip<a name='2815'>
<font color=#447700>!<a name='2816'></font>
<font color=#447700>! replace the new values<a name='2817'></font>
      if(ist.eq.1) then<a name='2818'>
        rql(i,:) = qn(:)<a name='2819'>
        precip1(i) = precip(i)<a name='2820'>
      else<a name='2821'>
        rql2(i,:) = qn(:)<a name='2822'>
        precip2(i) = precip(i)<a name='2823'>
      endif<a name='2824'>
      enddo ist_loop<a name='2825'>
<font color=#447700>!<a name='2826'></font>
<font color=#447700>! ----------------------------------<a name='2827'></font>
      enddo i_loop<a name='2828'>
<font color=#447700>!<a name='2829'></font>
  END SUBROUTINE nislfv_rain_plm6<a name='2830'>
<a name='2831'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2832'></font>
<A NAME='REFL10CM_WDM6'><A href='../../html_code/phys/module_mp_wdm6.F.html#REFL10CM_WDM6' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2833'>
      <font color=#993300>subroutine </font><font color=#cc0000>refl10cm_wdm6</font> (qv1d, qr1d, nr1d, qs1d, qg1d,           &amp; <A href='../../call_to/REFL10CM_WDM6.html' TARGET='index'>1</A>,<A href='../../call_from/REFL10CM_WDM6.html' TARGET='index'>2</A><a name='2834'>
                       t1d, p1d, dBZ, kts, kte, ii, jj)<a name='2835'>
<a name='2836'>
      IMPLICIT NONE<a name='2837'>
<a name='2838'>
<font color=#447700>!..Sub arguments<a name='2839'></font>
      INTEGER, INTENT(IN):: kts, kte, ii, jj<a name='2840'>
      REAL, DIMENSION(kts:kte), INTENT(IN)::                            &amp;<a name='2841'>
                      qv1d, qr1d, nr1d, qs1d, qg1d, t1d, p1d<a name='2842'>
      REAL, DIMENSION(kts:kte), INTENT(INOUT):: dBZ<a name='2843'>
<a name='2844'>
<font color=#447700>!..Local variables<a name='2845'></font>
      REAL, DIMENSION(kts:kte):: temp, pres, qv, rho<a name='2846'>
      REAL, DIMENSION(kts:kte):: rr, nr, rs, rg<a name='2847'>
      REAL:: temp_C<a name='2848'>
<a name='2849'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: ilamr, ilams, ilamg<a name='2850'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: N0_r, N0_s, N0_g<a name='2851'>
      DOUBLE PRECISION:: lamr, lams, lamg<a name='2852'>
      LOGICAL, DIMENSION(kts:kte):: L_qr, L_qs, L_qg<a name='2853'>
<a name='2854'>
      REAL, DIMENSION(kts:kte):: ze_rain, ze_snow, ze_graupel<a name='2855'>
      DOUBLE PRECISION:: fmelt_s, fmelt_g<a name='2856'>
<a name='2857'>
      INTEGER:: i, k, k_0, kbot, n<a name='2858'>
      LOGICAL:: melti<a name='2859'>
<a name='2860'>
      DOUBLE PRECISION:: cback, x, eta, f_d<a name='2861'>
      REAL, PARAMETER:: R=287.<a name='2862'>
<a name='2863'>
<font color=#447700>!+---+<a name='2864'></font>
<a name='2865'>
      do k = kts, kte<a name='2866'>
         dBZ(k) = -35.0<a name='2867'>
      enddo<a name='2868'>
<a name='2869'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2870'></font>
<font color=#447700>!..Put column of data into local arrays.<a name='2871'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2872'></font>
      do k = kts, kte<a name='2873'>
         temp(k) = t1d(k)<a name='2874'>
         temp_C = min(-0.001, temp(K)-273.15)<a name='2875'>
         qv(k) = MAX(1.E-10, qv1d(k))<a name='2876'>
         pres(k) = p1d(k)<a name='2877'>
         rho(k) = 0.622*pres(k)/(R*temp(k)*(qv(k)+0.622))<a name='2878'>
<a name='2879'>
         if (qr1d(k) .gt. 1.E-9) then<a name='2880'>
            rr(k) = qr1d(k)*rho(k)<a name='2881'>
            nr(k) = nr1d(k)*rho(k)<a name='2882'>
            lamr = (xam_r*xcrg(3)*xorg2*nr(k)/rr(k))**xobmr<a name='2883'>
            ilamr(k) = 1./lamr<a name='2884'>
            N0_r(k) = nr(k)*xorg2*lamr**xcre(2)<a name='2885'>
            L_qr(k) = .true.<a name='2886'>
         else<a name='2887'>
            rr(k) = 1.E-12<a name='2888'>
            nr(k) = 1.E-12<a name='2889'>
            L_qr(k) = .false.<a name='2890'>
         endif<a name='2891'>
<a name='2892'>
         if (qs1d(k) .gt. 1.E-9) then<a name='2893'>
            rs(k) = qs1d(k)*rho(k)<a name='2894'>
            N0_s(k) = min(n0smax, n0s*exp(-alpha*temp_C))<a name='2895'>
            lams = (xam_s*xcsg(3)*N0_s(k)/rs(k))**(1./xcse(1))<a name='2896'>
            ilams(k) = 1./lams<a name='2897'>
            L_qs(k) = .true.<a name='2898'>
         else<a name='2899'>
            rs(k) = 1.E-12<a name='2900'>
            L_qs(k) = .false.<a name='2901'>
         endif<a name='2902'>
<a name='2903'>
         if (qg1d(k) .gt. 1.E-9) then<a name='2904'>
            rg(k) = qg1d(k)*rho(k)<a name='2905'>
            N0_g(k) = n0g<a name='2906'>
            lamg = (xam_g*xcgg(3)*N0_g(k)/rg(k))**(1./xcge(1))<a name='2907'>
            ilamg(k) = 1./lamg<a name='2908'>
            L_qg(k) = .true.<a name='2909'>
         else<a name='2910'>
            rg(k) = 1.E-12<a name='2911'>
            L_qg(k) = .false.<a name='2912'>
         endif<a name='2913'>
      enddo<a name='2914'>
<a name='2915'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2916'></font>
<font color=#447700>!..Locate K-level of start of melting (k_0 is level above).<a name='2917'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2918'></font>
      melti = .false.<a name='2919'>
      k_0 = kts<a name='2920'>
      do k = kte-1, kts, -1<a name='2921'>
         if ( (temp(k).gt.273.15) .and. L_qr(k)                         &amp;<a name='2922'>
                                  .and. (L_qs(k+1).or.L_qg(k+1)) ) then<a name='2923'>
            k_0 = MAX(k+1, k_0)<a name='2924'>
            melti=.true.<a name='2925'>
            goto 195<a name='2926'>
         endif<a name='2927'>
      enddo<a name='2928'>
 195  continue<a name='2929'>
<a name='2930'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2931'></font>
<font color=#447700>!..Assume Rayleigh approximation at 10 cm wavelength. Rain (all temps)<a name='2932'></font>
<font color=#447700>!.. and non-water-coated snow and graupel when below freezing are<a name='2933'></font>
<font color=#447700>!.. simple. Integrations of m(D)*m(D)*N(D)*dD.<a name='2934'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2935'></font>
<a name='2936'>
      do k = kts, kte<a name='2937'>
         ze_rain(k) = 1.e-22<a name='2938'>
         ze_snow(k) = 1.e-22<a name='2939'>
         ze_graupel(k) = 1.e-22<a name='2940'>
         if (L_qr(k)) ze_rain(k) = N0_r(k)*xcrg(4)*ilamr(k)**xcre(4)<a name='2941'>
         if (L_qs(k)) ze_snow(k) = (0.176/0.93) * (6.0/PI)*(6.0/PI)     &amp;<a name='2942'>
                                 * (xam_s/900.0)*(xam_s/900.0)          &amp;<a name='2943'>
                                 * N0_s(k)*xcsg(4)*ilams(k)**xcse(4)<a name='2944'>
         if (L_qg(k)) ze_graupel(k) = (0.176/0.93) * (6.0/PI)*(6.0/PI)  &amp;<a name='2945'>
                                    * (xam_g/900.0)*(xam_g/900.0)       &amp;<a name='2946'>
                                    * N0_g(k)*xcgg(4)*ilamg(k)**xcge(4)<a name='2947'>
      enddo<a name='2948'>
<a name='2949'>
<a name='2950'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2951'></font>
<font color=#447700>!..Special case of melting ice (snow/graupel) particles.  Assume the<a name='2952'></font>
<font color=#447700>!.. ice is surrounded by the liquid water.  Fraction of meltwater is<a name='2953'></font>
<font color=#447700>!.. extremely simple based on amount found above the melting level.<a name='2954'></font>
<font color=#447700>!.. Uses code from Uli Blahak (rayleigh_soak_wetgraupel and supporting<a name='2955'></font>
<font color=#447700>!.. routines).<a name='2956'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2957'></font>
<a name='2958'>
      if (melti .and. k_0.ge.kts+1) then<a name='2959'>
       do k = k_0-1, kts, -1<a name='2960'>
<a name='2961'>
<font color=#447700>!..Reflectivity contributed by melting snow<a name='2962'></font>
          if (L_qs(k) .and. L_qs(k_0) ) then<a name='2963'>
           fmelt_s = MAX(0.005d0, MIN(1.0d0-rs(k)/rs(k_0), 0.99d0))<a name='2964'>
           eta = 0.d0<a name='2965'>
           lams = 1./ilams(k)<a name='2966'>
           do n = 1, nrbins<a name='2967'>
              x = xam_s * xxDs(n)**xbm_s<a name='2968'>
              call <A href='../../html_code/phys/module_mp_radar.F.html#RAYLEIGH_SOAK_WETGRAUPEL'>rayleigh_soak_wetgraupel</A><A href='../../html_code/phys/module_mp_wdm6.F.html#REFL10CM_WDM6' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAYLEIGH_SOAK_WETGRAUPEL_14"> (x,DBLE(xocms),DBLE(xobms), &amp;<a name='2969'>
                    fmelt_s, melt_outside_s, m_w_0, m_i_0, lamda_radar, &amp;<a name='2970'>
                    CBACK, mixingrulestring_s, matrixstring_s,          &amp;<a name='2971'>
                    inclusionstring_s, hoststring_s,                    &amp;<a name='2972'>
                    hostmatrixstring_s, hostinclusionstring_s)<a name='2973'>
              f_d = N0_s(k)*xxDs(n)**xmu_s * DEXP(-lams*xxDs(n))<a name='2974'>
              eta = eta + f_d * CBACK * simpson(n) * xdts(n)<a name='2975'>
           enddo<a name='2976'>
           ze_snow(k) = SNGL(lamda4 / (pi5 * K_w) * eta)<a name='2977'>
          endif<a name='2978'>
<a name='2979'>
<a name='2980'>
<font color=#447700>!..Reflectivity contributed by melting graupel<a name='2981'></font>
<a name='2982'>
          if (L_qg(k) .and. L_qg(k_0) ) then<a name='2983'>
           fmelt_g = MAX(0.005d0, MIN(1.0d0-rg(k)/rg(k_0), 0.99d0))<a name='2984'>
           eta = 0.d0<a name='2985'>
           lamg = 1./ilamg(k)<a name='2986'>
           do n = 1, nrbins<a name='2987'>
              x = xam_g * xxDg(n)**xbm_g<a name='2988'>
              call <A href='../../html_code/phys/module_mp_radar.F.html#RAYLEIGH_SOAK_WETGRAUPEL'>rayleigh_soak_wetgraupel</A><A href='../../html_code/phys/module_mp_wdm6.F.html#REFL10CM_WDM6' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAYLEIGH_SOAK_WETGRAUPEL_15"> (x,DBLE(xocmg),DBLE(xobmg), &amp;<a name='2989'>
                    fmelt_g, melt_outside_g, m_w_0, m_i_0, lamda_radar, &amp;<a name='2990'>
                    CBACK, mixingrulestring_g, matrixstring_g,          &amp;<a name='2991'>
                    inclusionstring_g, hoststring_g,                    &amp;<a name='2992'>
                    hostmatrixstring_g, hostinclusionstring_g)<a name='2993'>
              f_d = N0_g(k)*xxDg(n)**xmu_g * DEXP(-lamg*xxDg(n))<a name='2994'>
              eta = eta + f_d * CBACK * simpson(n) * xdtg(n)<a name='2995'>
           enddo<a name='2996'>
           ze_graupel(k) = SNGL(lamda4 / (pi5 * K_w) * eta)<a name='2997'>
          endif<a name='2998'>
<a name='2999'>
       enddo<a name='3000'>
      endif<a name='3001'>
<a name='3002'>
      do k = kte, kts, -1<a name='3003'>
         dBZ(k) = 10.*log10((ze_rain(k)+ze_snow(k)+ze_graupel(k))*1.d18)<a name='3004'>
      enddo<a name='3005'>
<a name='3006'>
<a name='3007'>
      end subroutine refl10cm_wdm6<a name='3008'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3009'></font>
<a name='3010'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3011'></font>
<A NAME='EFFECTRAD_WDM6'><A href='../../html_code/phys/module_mp_wdm6.F.html#EFFECTRAD_WDM6' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3012'>
     <font color=#993300>subroutine </font><font color=#cc0000>effectRad_wdm6</font> (t, qc, nc, qi, qs, rho, qmin, t0c,        &amp; <A href='../../call_to/EFFECTRAD_WDM6.html' TARGET='index'>1</A>,<A href='../../call_from/EFFECTRAD_WDM6.html' TARGET='index'>1</A><a name='3013'>
                                re_qc, re_qi, re_qs, kts, kte, ii, jj)<a name='3014'>
<a name='3015'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3016'></font>
<font color=#447700>!  Compute radiation effective radii of cloud water, ice, and snow for <a name='3017'></font>
<font color=#447700>!  double-moment microphysics..<a name='3018'></font>
<font color=#447700>!  These are entirely consistent with microphysics assumptions, not<a name='3019'></font>
<font color=#447700>!  constant or otherwise ad hoc as is internal to most radiation<a name='3020'></font>
<font color=#447700>!  schemes.  <a name='3021'></font>
<font color=#447700>!  Coded and implemented by Soo Ya Bae, KIAPS, January 2015.<a name='3022'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3023'></font>
<a name='3024'>
      implicit none<a name='3025'>
<a name='3026'>
<font color=#447700>!..Sub arguments<a name='3027'></font>
      integer, intent(in) :: kts, kte, ii, jj<a name='3028'>
      real, intent(in) :: qmin<a name='3029'>
      real, intent(in) :: t0c<a name='3030'>
      real, dimension( kts:kte ), intent(in)::  t<a name='3031'>
      real, dimension( kts:kte ), intent(in)::  qc<a name='3032'>
      real, dimension( kts:kte ), intent(in)::  nc<a name='3033'>
      real, dimension( kts:kte ), intent(in)::  qi<a name='3034'>
      real, dimension( kts:kte ), intent(in)::  qs<a name='3035'>
      real, dimension( kts:kte ), intent(in)::  rho<a name='3036'>
      real, dimension( kts:kte ), intent(inout):: re_qc<a name='3037'>
      real, dimension( kts:kte ), intent(inout):: re_qi<a name='3038'>
      real, dimension( kts:kte ), intent(inout):: re_qs<a name='3039'>
<font color=#447700>!..Local variables<a name='3040'></font>
      integer:: i,k<a name='3041'>
      integer :: inu_c<a name='3042'>
      real, dimension( kts:kte ):: ni<a name='3043'>
      real, dimension( kts:kte ):: rqc<a name='3044'>
      real, dimension( kts:kte ):: rnc<a name='3045'>
      real, dimension( kts:kte ):: rqi<a name='3046'>
      real, dimension( kts:kte ):: rni<a name='3047'>
      real, dimension( kts:kte ):: rqs<a name='3048'>
      real :: cdm2<a name='3049'>
      real :: temp<a name='3050'>
      real :: supcol, n0sfac, lamdas<a name='3051'>
      real :: diai      <font color=#447700>! diameter of ice in m<a name='3052'></font>
      double precision :: lamc<a name='3053'>
      logical :: has_qc, has_qi, has_qs<a name='3054'>
<font color=#447700>!..Minimum microphys values<a name='3055'></font>
      real, parameter :: R1 = 1.E-12<a name='3056'>
      real, parameter :: R2 = 1.E-6<a name='3057'>
      real, parameter :: pi = 3.1415926536<a name='3058'>
      real, parameter :: bm_r = 3.0<a name='3059'>
      real, parameter :: obmr = 1.0/bm_r<a name='3060'>
      real, parameter :: cdm  = 5./3.<a name='3061'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3062'></font>
      has_qc = .false.<a name='3063'>
      has_qi = .false.<a name='3064'>
      has_qs = .false.<a name='3065'>
<a name='3066'>
      cdm2 = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wdm6.F.html#EFFECTRAD_WDM6' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_31">(cdm)<a name='3067'>
<a name='3068'>
      do k=kts,kte<a name='3069'>
        <font color=#447700>! for cloud<a name='3070'></font>
        rqc(k) = max(R1, qc(k)*rho(k))<a name='3071'>
        rnc(k) = max(R2, nc(k)*rho(k))<a name='3072'>
        if (rqc(k).gt.R1 .and. rnc(k).gt.R2) has_qc = .true.<a name='3073'>
        <font color=#447700>! for ice<a name='3074'></font>
        rqi(k) = max(R1, qi(k)*rho(k))<a name='3075'>
        temp = (rho(k)*max(qi(k),qmin))<a name='3076'>
        temp = sqrt(sqrt(temp*temp*temp))<a name='3077'>
        ni(k) = min(max(5.38e7*temp,1.e3),1.e6)<a name='3078'>
        rni(k)= max(R2, ni(k)*rho(k))<a name='3079'>
        if (rqi(k).gt.R1 .and. rni(k).gt.R2) has_qi = .true.<a name='3080'>
        <font color=#447700>! for snow<a name='3081'></font>
        rqs(k) = max(R1, qs(k)*rho(k))<a name='3082'>
        if (rqs(k).gt.R1) has_qs = .true.<a name='3083'>
      enddo<a name='3084'>
<a name='3085'>
      if (has_qc) then<a name='3086'>
        do k=kts,kte<a name='3087'>
          if (rqc(k).le.R1 .or. rnc(k).le.R2) CYCLE<a name='3088'>
          lamc = 2.*cdm2*(pidnc*nc(k)/rqc(k))**obmr<a name='3089'>
          re_qc(k) =  max(2.51e-6,min(sngl(1.0d0/lamc),50.e-6))<a name='3090'>
        enddo<a name='3091'>
      endif<a name='3092'>
<a name='3093'>
      if (has_qi) then<a name='3094'>
        do k=kts,kte<a name='3095'>
          if (rqi(k).le.R1 .or. rni(k).le.R2) CYCLE<a name='3096'>
          diai = 11.9*sqrt(rqi(k)/ni(k))<a name='3097'>
          re_qi(k) = max(10.01e-6,min(0.75*0.163*diai,125.e-6))<a name='3098'>
        enddo<a name='3099'>
      endif<a name='3100'>
<a name='3101'>
      if (has_qs) then<a name='3102'>
        do k=kts,kte<a name='3103'>
          if (rqs(k).le.R1) CYCLE<a name='3104'>
          supcol = t0c-t(k)<a name='3105'>
          n0sfac = max(min(exp(alpha*supcol),n0smax/n0s),1.)<a name='3106'>
          lamdas = sqrt(sqrt(pidn0s*n0sfac/rqs(k))) <a name='3107'>
          re_qs(k) = max(25.e-6,min(0.5*(1./lamdas),999.e-6))<a name='3108'>
        enddo<a name='3109'>
      endif<a name='3110'>
<a name='3111'>
      end subroutine effectRad_wdm6<a name='3112'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3113'></font>
<a name='3114'>
END MODULE module_mp_wdm6<a name='3115'>
</pre></body></html>