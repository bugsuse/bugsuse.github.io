<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_SF_NOAHMPLSM'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#MODULE_SF_NOAHMPLSM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>MODULE_SF_NOAHMPLSM</font> <A href='../../call_to/MODULE_SF_NOAHMPLSM.html' TARGET='index'>2</A><a name='3'>
<a name='4'>
  IMPLICIT NONE<a name='5'>
<a name='6'>
  public  :: noahmp_options<a name='7'>
  public  :: NOAHMP_SFLX<a name='8'>
<a name='9'>
  private :: ATM<a name='10'>
  private :: PHENOLOGY<a name='11'>
  private :: PRECIP_HEAT<a name='12'>
  private :: ENERGY<a name='13'>
  private ::       THERMOPROP<a name='14'>
  private ::               CSNOW<a name='15'>
  private ::               TDFCND<a name='16'>
  private ::       RADIATION<a name='17'>
  private ::               ALBEDO<a name='18'>
  private ::                         SNOW_AGE<a name='19'>
  private ::                         SNOWALB_BATS  <a name='20'>
  private ::                         SNOWALB_CLASS<a name='21'>
  private ::                         GROUNDALB<a name='22'>
  private ::                         TWOSTREAM<a name='23'>
  private ::               SURRAD<a name='24'>
  private ::       VEGE_FLUX<a name='25'>
  private ::               SFCDIF1                  <a name='26'>
  private ::               SFCDIF2                <a name='27'>
  private ::               STOMATA                  <a name='28'>
  private ::               CANRES                  <a name='29'>
  private ::               ESAT<a name='30'>
  private ::               RAGRB<a name='31'>
  private ::       BARE_FLUX<a name='32'>
  private ::       TSNOSOI<a name='33'>
  private ::               HRT<a name='34'>
  private ::               HSTEP   <a name='35'>
  private ::                         ROSR12<a name='36'>
  private ::       PHASECHANGE<a name='37'>
  private ::               FRH2O           <a name='38'>
<a name='39'>
  private :: WATER<a name='40'>
  private ::       CANWATER<a name='41'>
  private ::       SNOWWATER<a name='42'>
  private ::               SNOWFALL<a name='43'>
  private ::               COMBINE<a name='44'>
  private ::               DIVIDE<a name='45'>
  private ::                         COMBO<a name='46'>
  private ::               COMPACT<a name='47'>
  private ::               SNOWH2O<a name='48'>
  private ::       SOILWATER<a name='49'>
  private ::               ZWTEQ<a name='50'>
  private ::               INFIL<a name='51'>
  private ::               SRT<a name='52'>
  private ::                         WDFCND1        <a name='53'>
  private ::                         WDFCND2       <a name='54'>
  private ::               SSTEP<a name='55'>
  private ::       GROUNDWATER<a name='56'>
  private ::       SHALLOWWATERTABLE<a name='57'>
<a name='58'>
  private :: CARBON<a name='59'>
  private ::       CO2FLUX<a name='60'>
<font color=#447700>!  private ::       BVOCFLUX<a name='61'></font>
<font color=#447700>!  private ::       CH4FLUX<a name='62'></font>
<a name='63'>
  private :: ERROR<a name='64'>
<a name='65'>
<font color=#447700>! =====================================options for different schemes================================<a name='66'></font>
<font color=#447700>! **recommended<a name='67'></font>
<a name='68'>
  INTEGER :: DVEG     <font color=#447700>! options for dynamic vegetation: <a name='69'></font>
                      <font color=#447700>!   1 -&gt; off (use table LAI; use FVEG = SHDFAC from input)<a name='70'></font>
                      <font color=#447700>!   2 -&gt; on  (together with OPT_CRS = 1)<a name='71'></font>
                      <font color=#447700>!   3 -&gt; off (use table LAI; calculate FVEG)<a name='72'></font>
                      <font color=#447700>! **4 -&gt; off (use table LAI; use maximum vegetation fraction)<a name='73'></font>
                      <font color=#447700>! **5 -&gt; on  (use maximum vegetation fraction)<a name='74'></font>
                      <font color=#447700>!   6 -&gt; on  (use FVEG = SHDFAC from input)<a name='75'></font>
                      <font color=#447700>!   7 -&gt; off (use input LAI; use FVEG = SHDFAC from input)<a name='76'></font>
                      <font color=#447700>!   8 -&gt; off (use input LAI; calculate FVEG)<a name='77'></font>
                      <font color=#447700>!   9 -&gt; off (use input LAI; use maximum vegetation fraction)<a name='78'></font>
                      <font color=#447700>!  10 -&gt; crop model on (use maximum vegetation fraction)<a name='79'></font>
<a name='80'>
  INTEGER :: OPT_CRS  <font color=#447700>! options for canopy stomatal resistance<a name='81'></font>
                      <font color=#447700>! **1 -&gt; Ball-Berry<a name='82'></font>
		      <font color=#447700>!   2 -&gt; Jarvis<a name='83'></font>
<a name='84'>
  INTEGER :: OPT_BTR  <font color=#447700>! options for soil moisture factor for stomatal resistance<a name='85'></font>
                      <font color=#447700>! **1 -&gt; Noah (soil moisture) <a name='86'></font>
                      <font color=#447700>!   2 -&gt; CLM  (matric potential)<a name='87'></font>
                      <font color=#447700>!   3 -&gt; SSiB (matric potential)<a name='88'></font>
<a name='89'>
  INTEGER :: OPT_RUN  <font color=#447700>! options for runoff and groundwater<a name='90'></font>
                      <font color=#447700>! **1 -&gt; TOPMODEL with groundwater (Niu et al. 2007 JGR) ;<a name='91'></font>
                      <font color=#447700>!   2 -&gt; TOPMODEL with an equilibrium water table (Niu et al. 2005 JGR) ;<a name='92'></font>
                      <font color=#447700>!   3 -&gt; original surface and subsurface runoff (free drainage)<a name='93'></font>
                      <font color=#447700>!   4 -&gt; BATS surface and subsurface runoff (free drainage)<a name='94'></font>
                      <font color=#447700>!   5 -&gt; Miguez-Macho&amp;Fan groundwater scheme (Miguez-Macho et al. 2007 JGR; Fan et al. 2007 JGR)<a name='95'></font>
		      <font color=#447700>!          (needs further testing for public use)<a name='96'></font>
<a name='97'>
  INTEGER :: OPT_SFC  <font color=#447700>! options for surface layer drag coeff (CH &amp; CM)<a name='98'></font>
                      <font color=#447700>! **1 -&gt; M-O<a name='99'></font>
		      <font color=#447700>! **2 -&gt; original Noah (Chen97)<a name='100'></font>
		      <font color=#447700>! **3 -&gt; MYJ consistent; 4-&gt;YSU consistent. MB: removed in v3.7 for further testing<a name='101'></font>
<a name='102'>
  INTEGER :: OPT_FRZ  <font color=#447700>! options for supercooled liquid water (or ice fraction)<a name='103'></font>
                      <font color=#447700>! **1 -&gt; no iteration (Niu and Yang, 2006 JHM)<a name='104'></font>
		      <font color=#447700>!   2 -&gt; Koren's iteration <a name='105'></font>
<a name='106'>
  INTEGER :: OPT_INF  <font color=#447700>! options for frozen soil permeability<a name='107'></font>
                      <font color=#447700>! **1 -&gt; linear effects, more permeable (Niu and Yang, 2006, JHM)<a name='108'></font>
                      <font color=#447700>!   2 -&gt; nonlinear effects, less permeable (old)<a name='109'></font>
<a name='110'>
  INTEGER :: OPT_RAD  <font color=#447700>! options for radiation transfer<a name='111'></font>
                      <font color=#447700>!   1 -&gt; modified two-stream (gap = F(solar angle, 3D structure ...)&lt;1-FVEG)<a name='112'></font>
                      <font color=#447700>!   2 -&gt; two-stream applied to grid-cell (gap = 0)<a name='113'></font>
                      <font color=#447700>! **3 -&gt; two-stream applied to vegetated fraction (gap=1-FVEG)<a name='114'></font>
<a name='115'>
  INTEGER :: OPT_ALB  <font color=#447700>! options for ground snow surface albedo<a name='116'></font>
                      <font color=#447700>!   1 -&gt; BATS<a name='117'></font>
		      <font color=#447700>! **2 -&gt; CLASS<a name='118'></font>
<a name='119'>
  INTEGER :: OPT_SNF  <font color=#447700>! options for partitioning  precipitation into rainfall &amp; snowfall<a name='120'></font>
                      <font color=#447700>! **1 -&gt; Jordan (1991)<a name='121'></font>
		      <font color=#447700>!   2 -&gt; BATS: when SFCTMP&lt;TFRZ+2.2 <a name='122'></font>
		      <font color=#447700>!   3 -&gt; SFCTMP &lt; TFRZ<a name='123'></font>
		      <font color=#447700>!   4 -&gt; Use WRF microphysics output<a name='124'></font>
<a name='125'>
  INTEGER :: OPT_TBOT <font color=#447700>! options for lower boundary condition of soil temperature<a name='126'></font>
                      <font color=#447700>!   1 -&gt; zero heat flux from bottom (ZBOT and TBOT not used)<a name='127'></font>
                      <font color=#447700>! **2 -&gt; TBOT at ZBOT (8m) read from a file (original Noah)<a name='128'></font>
<a name='129'>
  INTEGER :: OPT_STC  <font color=#447700>! options for snow/soil temperature time scheme (only layer 1)<a name='130'></font>
                      <font color=#447700>! **1 -&gt; semi-implicit; flux top boundary condition<a name='131'></font>
		      <font color=#447700>!   2 -&gt; full implicit (original Noah); temperature top boundary condition<a name='132'></font>
                      <font color=#447700>!   3 -&gt; same as 1, but FSNO for TS calculation (generally improves snow; v3.7)<a name='133'></font>
<a name='134'>
  INTEGER :: OPT_RSF  <font color=#447700>! options for surface resistent to evaporation/sublimation<a name='135'></font>
                      <font color=#447700>! **1 -&gt; Sakaguchi and Zeng, 2009<a name='136'></font>
		      <font color=#447700>!   2 -&gt; Sellers (1992)<a name='137'></font>
                      <font color=#447700>!   3 -&gt; adjusted Sellers to decrease RSURF for wet soil<a name='138'></font>
		      <font color=#447700>!   4 -&gt; option 1 for non-snow; rsurf = rsurf_snow for snow (set in MPTABLE); AD v3.8<a name='139'></font>
<a name='140'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='141'></font>
<font color=#447700>! Physical Constants:                                                                      !<a name='142'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='143'></font>
<a name='144'>
  REAL, PARAMETER :: GRAV   = 9.80616   <font color=#447700>!acceleration due to gravity (m/s2)<a name='145'></font>
  REAL, PARAMETER :: SB     = 5.67E-08  <font color=#447700>!Stefan-Boltzmann constant (w/m2/k4)<a name='146'></font>
  REAL, PARAMETER :: VKC    = 0.40      <font color=#447700>!von Karman constant<a name='147'></font>
  REAL, PARAMETER :: TFRZ   = 273.16    <font color=#447700>!freezing/melting point (k)<a name='148'></font>
  REAL, PARAMETER :: HSUB   = 2.8440E06 <font color=#447700>!latent heat of sublimation (j/kg)<a name='149'></font>
  REAL, PARAMETER :: HVAP   = 2.5104E06 <font color=#447700>!latent heat of vaporization (j/kg)<a name='150'></font>
  REAL, PARAMETER :: HFUS   = 0.3336E06 <font color=#447700>!latent heat of fusion (j/kg)<a name='151'></font>
  REAL, PARAMETER :: CWAT   = 4.188E06  <font color=#447700>!specific heat capacity of water (j/m3/k)<a name='152'></font>
  REAL, PARAMETER :: CICE   = 2.094E06  <font color=#447700>!specific heat capacity of ice (j/m3/k)<a name='153'></font>
  REAL, PARAMETER :: CPAIR  = 1004.64   <font color=#447700>!heat capacity dry air at const pres (j/kg/k)<a name='154'></font>
  REAL, PARAMETER :: TKWAT  = 0.6       <font color=#447700>!thermal conductivity of water (w/m/k)<a name='155'></font>
  REAL, PARAMETER :: TKICE  = 2.2       <font color=#447700>!thermal conductivity of ice (w/m/k)<a name='156'></font>
  REAL, PARAMETER :: TKAIR  = 0.023     <font color=#447700>!thermal conductivity of air (w/m/k) (not used MB: 20140718)<a name='157'></font>
  REAL, PARAMETER :: RAIR   = 287.04    <font color=#447700>!gas constant for dry air (j/kg/k)<a name='158'></font>
  REAL, PARAMETER :: RW     = 461.269   <font color=#447700>!gas constant for  water vapor (j/kg/k)<a name='159'></font>
  REAL, PARAMETER :: DENH2O = 1000.     <font color=#447700>!density of water (kg/m3)<a name='160'></font>
  REAL, PARAMETER :: DENICE = 917.      <font color=#447700>!density of ice (kg/m3)<a name='161'></font>
<a name='162'>
  INTEGER, PRIVATE, PARAMETER :: MBAND = 2<a name='163'>
  INTEGER, PRIVATE, PARAMETER :: NSOIL = 4<a name='164'>
  INTEGER, PRIVATE, PARAMETER :: NSTAGE = 8<a name='165'>
<a name='166'>
  TYPE noahmp_parameters <font color=#447700>! define a NoahMP parameters type<a name='167'></font>
<a name='168'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='169'></font>
<font color=#447700>! From the veg section of MPTABLE.TBL<a name='170'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='171'></font>
<a name='172'>
    LOGICAL :: URBAN_FLAG<a name='173'>
    INTEGER :: ISWATER<a name='174'>
    INTEGER :: ISBARREN<a name='175'>
    INTEGER :: ISICE<a name='176'>
    INTEGER :: ISCROP<a name='177'>
    INTEGER :: EBLFOREST<a name='178'>
<a name='179'>
    REAL :: CH2OP              <font color=#447700>!maximum intercepted h2o per unit lai+sai (mm)<a name='180'></font>
    REAL :: DLEAF              <font color=#447700>!characteristic leaf dimension (m)<a name='181'></font>
    REAL :: Z0MVT              <font color=#447700>!momentum roughness length (m)<a name='182'></font>
    REAL :: HVT                <font color=#447700>!top of canopy (m)<a name='183'></font>
    REAL :: HVB                <font color=#447700>!bottom of canopy (m)<a name='184'></font>
    REAL :: DEN                <font color=#447700>!tree density (no. of trunks per m2)<a name='185'></font>
    REAL :: RC                 <font color=#447700>!tree crown radius (m)<a name='186'></font>
    REAL :: MFSNO              <font color=#447700>!snowmelt m parameter ()<a name='187'></font>
    REAL :: SAIM(12)           <font color=#447700>!monthly stem area index, one-sided<a name='188'></font>
    REAL :: LAIM(12)           <font color=#447700>!monthly leaf area index, one-sided<a name='189'></font>
    REAL :: SLA                <font color=#447700>!single-side leaf area per Kg [m2/kg]<a name='190'></font>
    REAL :: DILEFC             <font color=#447700>!coeficient for leaf stress death [1/s]<a name='191'></font>
    REAL :: DILEFW             <font color=#447700>!coeficient for leaf stress death [1/s]<a name='192'></font>
    REAL :: FRAGR              <font color=#447700>!fraction of growth respiration  !original was 0.3 <a name='193'></font>
    REAL :: LTOVRC             <font color=#447700>!leaf turnover [1/s]<a name='194'></font>
<a name='195'>
    REAL :: C3PSN              <font color=#447700>!photosynthetic pathway: 0. = c4, 1. = c3<a name='196'></font>
    REAL :: KC25               <font color=#447700>!co2 michaelis-menten constant at 25c (pa)<a name='197'></font>
    REAL :: AKC                <font color=#447700>!q10 for kc25<a name='198'></font>
    REAL :: KO25               <font color=#447700>!o2 michaelis-menten constant at 25c (pa)<a name='199'></font>
    REAL :: AKO                <font color=#447700>!q10 for ko25<a name='200'></font>
    REAL :: VCMX25             <font color=#447700>!maximum rate of carboxylation at 25c (umol co2/m**2/s)<a name='201'></font>
    REAL :: AVCMX              <font color=#447700>!q10 for vcmx25<a name='202'></font>
    REAL :: BP                 <font color=#447700>!minimum leaf conductance (umol/m**2/s)<a name='203'></font>
    REAL :: MP                 <font color=#447700>!slope of conductance-to-photosynthesis relationship<a name='204'></font>
    REAL :: QE25               <font color=#447700>!quantum efficiency at 25c (umol co2 / umol photon)<a name='205'></font>
    REAL :: AQE                <font color=#447700>!q10 for qe25<a name='206'></font>
    REAL :: RMF25              <font color=#447700>!leaf maintenance respiration at 25c (umol co2/m**2/s)<a name='207'></font>
    REAL :: RMS25              <font color=#447700>!stem maintenance respiration at 25c (umol co2/kg bio/s)<a name='208'></font>
    REAL :: RMR25              <font color=#447700>!root maintenance respiration at 25c (umol co2/kg bio/s)<a name='209'></font>
    REAL :: ARM                <font color=#447700>!q10 for maintenance respiration<a name='210'></font>
    REAL :: FOLNMX             <font color=#447700>!foliage nitrogen concentration when f(n)=1 (%)<a name='211'></font>
    REAL :: TMIN               <font color=#447700>!minimum temperature for photosynthesis (k)<a name='212'></font>
       <a name='213'>
    REAL :: XL                 <font color=#447700>!leaf/stem orientation index<a name='214'></font>
    REAL :: RHOL(MBAND)        <font color=#447700>!leaf reflectance: 1=vis, 2=nir<a name='215'></font>
    REAL :: RHOS(MBAND)        <font color=#447700>!stem reflectance: 1=vis, 2=nir<a name='216'></font>
    REAL :: TAUL(MBAND)        <font color=#447700>!leaf transmittance: 1=vis, 2=nir<a name='217'></font>
    REAL :: TAUS(MBAND)        <font color=#447700>!stem transmittance: 1=vis, 2=nir<a name='218'></font>
<a name='219'>
    REAL :: MRP                <font color=#447700>!microbial respiration parameter (umol co2 /kg c/ s)<a name='220'></font>
    REAL :: CWPVT              <font color=#447700>!empirical canopy wind parameter<a name='221'></font>
<a name='222'>
    REAL :: WRRAT              <font color=#447700>!wood to non-wood ratio<a name='223'></font>
    REAL :: WDPOOL             <font color=#447700>!wood pool (switch 1 or 0) depending on woody or not [-]<a name='224'></font>
    REAL :: TDLEF              <font color=#447700>!characteristic T for leaf freezing [K]<a name='225'></font>
<a name='226'>
  INTEGER :: NROOT              <font color=#447700>!number of soil layers with root present<a name='227'></font>
     REAL :: RGL                <font color=#447700>!Parameter used in radiation stress function<a name='228'></font>
     REAL :: RSMIN              <font color=#447700>!Minimum stomatal resistance [s m-1]<a name='229'></font>
     REAL :: HS                 <font color=#447700>!Parameter used in vapor pressure deficit function<a name='230'></font>
     REAL :: TOPT               <font color=#447700>!Optimum transpiration air temperature [K]<a name='231'></font>
     REAL :: RSMAX              <font color=#447700>!Maximal stomatal resistance [s m-1]<a name='232'></font>
<a name='233'>
     REAL :: SLAREA<a name='234'>
     REAL :: EPS(5)<a name='235'>
<a name='236'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='237'></font>
<font color=#447700>! From the rad section of MPTABLE.TBL<a name='238'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='239'></font>
<a name='240'>
     REAL :: ALBSAT(MBAND)       <font color=#447700>!saturated soil albedos: 1=vis, 2=nir<a name='241'></font>
     REAL :: ALBDRY(MBAND)       <font color=#447700>!dry soil albedos: 1=vis, 2=nir<a name='242'></font>
     REAL :: ALBICE(MBAND)       <font color=#447700>!albedo land ice: 1=vis, 2=nir<a name='243'></font>
     REAL :: ALBLAK(MBAND)       <font color=#447700>!albedo frozen lakes: 1=vis, 2=nir<a name='244'></font>
     REAL :: OMEGAS(MBAND)       <font color=#447700>!two-stream parameter omega for snow<a name='245'></font>
     REAL :: BETADS              <font color=#447700>!two-stream parameter betad for snow<a name='246'></font>
     REAL :: BETAIS              <font color=#447700>!two-stream parameter betad for snow<a name='247'></font>
     REAL :: EG(2)               <font color=#447700>!emissivity<a name='248'></font>
<a name='249'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='250'></font>
<font color=#447700>! From the globals section of MPTABLE.TBL<a name='251'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='252'></font>
 <a name='253'>
     REAL :: CO2          <font color=#447700>!co2 partial pressure<a name='254'></font>
     REAL :: O2           <font color=#447700>!o2 partial pressure<a name='255'></font>
     REAL :: TIMEAN       <font color=#447700>!gridcell mean topgraphic index (global mean)<a name='256'></font>
     REAL :: FSATMX       <font color=#447700>!maximum surface saturated fraction (global mean)<a name='257'></font>
     REAL :: Z0SNO        <font color=#447700>!snow surface roughness length (m) (0.002)<a name='258'></font>
     REAL :: SSI          <font color=#447700>!liquid water holding capacity for snowpack (m3/m3)<a name='259'></font>
     REAL :: SWEMX        <font color=#447700>!new snow mass to fully cover old snow (mm)<a name='260'></font>
     REAL :: RSURF_SNOW   <font color=#447700>!surface resistance for snow(s/m)<a name='261'></font>
<a name='262'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='263'></font>
<font color=#447700>! From the crop section of MPTABLE.TBL<a name='264'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='265'></font>
 <a name='266'>
  INTEGER :: PLTDAY           <font color=#447700>! Planting date<a name='267'></font>
  INTEGER :: HSDAY            <font color=#447700>! Harvest date<a name='268'></font>
     REAL :: PLANTPOP         <font color=#447700>! Plant density [per ha] - used?<a name='269'></font>
     REAL :: IRRI             <font color=#447700>! Irrigation strategy 0= non-irrigation 1=irrigation (no water-stress)<a name='270'></font>
     REAL :: GDDTBASE         <font color=#447700>! Base temperature for GDD accumulation [C]<a name='271'></font>
     REAL :: GDDTCUT          <font color=#447700>! Upper temperature for GDD accumulation [C]<a name='272'></font>
     REAL :: GDDS1            <font color=#447700>! GDD from seeding to emergence<a name='273'></font>
     REAL :: GDDS2            <font color=#447700>! GDD from seeding to initial vegetative <a name='274'></font>
     REAL :: GDDS3            <font color=#447700>! GDD from seeding to post vegetative <a name='275'></font>
     REAL :: GDDS4            <font color=#447700>! GDD from seeding to intial reproductive<a name='276'></font>
     REAL :: GDDS5            <font color=#447700>! GDD from seeding to pysical maturity <a name='277'></font>
  INTEGER :: C3C4             <font color=#447700>! photosynthetic pathway:  1 = c3 2 = c4<a name='278'></font>
     REAL :: AREF             <font color=#447700>! reference maximum CO2 assimulation rate <a name='279'></font>
     REAL :: PSNRF            <font color=#447700>! CO2 assimulation reduction factor(0-1) (caused by non-modeling part,e.g.pest,weeds)<a name='280'></font>
     REAL :: I2PAR            <font color=#447700>! Fraction of incoming solar radiation to photosynthetically active radiation<a name='281'></font>
     REAL :: TASSIM0          <font color=#447700>! Minimum temperature for CO2 assimulation [C]<a name='282'></font>
     REAL :: TASSIM1          <font color=#447700>! CO2 assimulation linearly increasing until temperature reaches T1 [C]<a name='283'></font>
     REAL :: TASSIM2          <font color=#447700>! CO2 assmilation rate remain at Aref until temperature reaches T2 [C]<a name='284'></font>
     REAL :: K                <font color=#447700>! light extinction coefficient<a name='285'></font>
     REAL :: EPSI             <font color=#447700>! initial light use efficiency<a name='286'></font>
     REAL :: Q10MR            <font color=#447700>! q10 for maintainance respiration<a name='287'></font>
     REAL :: FOLN_MX          <font color=#447700>! foliage nitrogen concentration when f(n)=1 (%)<a name='288'></font>
     REAL :: LEFREEZ          <font color=#447700>! characteristic T for leaf freezing [K]<a name='289'></font>
     REAL :: DILE_FC(NSTAGE)  <font color=#447700>! coeficient for temperature leaf stress death [1/s]<a name='290'></font>
     REAL :: DILE_FW(NSTAGE)  <font color=#447700>! coeficient for water leaf stress death [1/s]<a name='291'></font>
     REAL :: FRA_GR           <font color=#447700>! fraction of growth respiration <a name='292'></font>
     REAL :: LF_OVRC(NSTAGE)  <font color=#447700>! fraction of leaf turnover  [1/s]<a name='293'></font>
     REAL :: ST_OVRC(NSTAGE)  <font color=#447700>! fraction of stem turnover  [1/s]<a name='294'></font>
     REAL :: RT_OVRC(NSTAGE)  <font color=#447700>! fraction of root tunrover  [1/s]<a name='295'></font>
     REAL :: LFMR25           <font color=#447700>! leaf maintenance respiration at 25C [umol CO2/m**2  /s]<a name='296'></font>
     REAL :: STMR25           <font color=#447700>! stem maintenance respiration at 25C [umol CO2/kg bio/s]<a name='297'></font>
     REAL :: RTMR25           <font color=#447700>! root maintenance respiration at 25C [umol CO2/kg bio/s]<a name='298'></font>
     REAL :: GRAINMR25        <font color=#447700>! grain maintenance respiration at 25C [umol CO2/kg bio/s]<a name='299'></font>
     REAL :: LFPT(NSTAGE)     <font color=#447700>! fraction of carbohydrate flux to leaf<a name='300'></font>
     REAL :: STPT(NSTAGE)     <font color=#447700>! fraction of carbohydrate flux to stem<a name='301'></font>
     REAL :: RTPT(NSTAGE)     <font color=#447700>! fraction of carbohydrate flux to root<a name='302'></font>
     REAL :: GRAINPT(NSTAGE)  <font color=#447700>! fraction of carbohydrate flux to grain<a name='303'></font>
     REAL :: BIO2LAI          <font color=#447700>! leaf are per living leaf biomass [m^2/kg]<a name='304'></font>
<a name='305'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='306'></font>
<font color=#447700>! From the SOILPARM.TBL tables, as functions of soil category.<a name='307'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='308'></font>
     REAL :: BEXP(NSOIL)   <font color=#447700>!B parameter<a name='309'></font>
     REAL :: SMCDRY(NSOIL) <font color=#447700>!dry soil moisture threshold where direct evap from top<a name='310'></font>
                           <font color=#447700>!layer ends (volumetric) (not used MB: 20140718)<a name='311'></font>
     REAL :: SMCWLT(NSOIL) <font color=#447700>!wilting point soil moisture (volumetric)<a name='312'></font>
     REAL :: SMCREF(NSOIL) <font color=#447700>!reference soil moisture (field capacity) (volumetric)<a name='313'></font>
     REAL :: SMCMAX(NSOIL) <font color=#447700>!porosity, saturated value of soil moisture (volumetric)<a name='314'></font>
     REAL :: PSISAT(NSOIL) <font color=#447700>!saturated soil matric potential<a name='315'></font>
     REAL :: DKSAT(NSOIL)  <font color=#447700>!saturated soil hydraulic conductivity<a name='316'></font>
     REAL :: DWSAT(NSOIL)  <font color=#447700>!saturated soil hydraulic diffusivity<a name='317'></font>
     REAL :: QUARTZ(NSOIL) <font color=#447700>!soil quartz content<a name='318'></font>
     REAL :: F1            <font color=#447700>!soil thermal diffusivity/conductivity coef (not used MB: 20140718)<a name='319'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='320'></font>
<font color=#447700>! From the GENPARM.TBL file<a name='321'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='322'></font>
     REAL :: SLOPE       <font color=#447700>!slope index (0 - 1)<a name='323'></font>
     REAL :: CSOIL       <font color=#447700>!vol. soil heat capacity [j/m3/K]<a name='324'></font>
     REAL :: ZBOT        <font color=#447700>!Depth (m) of lower boundary soil temperature<a name='325'></font>
     REAL :: CZIL        <font color=#447700>!Calculate roughness length of heat<a name='326'></font>
     REAL :: REFDK<a name='327'>
     REAL :: REFKDT<a name='328'>
<a name='329'>
     REAL :: KDT         <font color=#447700>!used in compute maximum infiltration rate (in INFIL)<a name='330'></font>
     REAL :: FRZX        <font color=#447700>!used in compute maximum infiltration rate (in INFIL)<a name='331'></font>
<a name='332'>
  END TYPE noahmp_parameters<a name='333'>
<a name='334'>
contains<a name='335'>
<font color=#447700>!<a name='336'></font>
<font color=#447700>!== begin noahmp_sflx ==============================================================================<a name='337'></font>
<a name='338'>
<A NAME='NOAHMP_SFLX'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_SFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='339'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>NOAHMP_SFLX</font> (parameters, &amp; <A href='../../call_to/NOAHMP_SFLX.html' TARGET='index'>1</A>,<A href='../../call_from/NOAHMP_SFLX.html' TARGET='index'>9</A><a name='340'>
                   ILOC    , JLOC    , LAT     , YEARLEN , JULIAN  , COSZ    , &amp; <font color=#447700>! IN : Time/Space-related<a name='341'></font>
                   DT      , DX      , DZ8W    , NSOIL   , ZSOIL   , NSNOW   , &amp; <font color=#447700>! IN : Model configuration <a name='342'></font>
                   SHDFAC  , SHDMAX  , VEGTYP  , ICE     , IST     , CROPTYPE, &amp; <font color=#447700>! IN : Vegetation/Soil characteristics<a name='343'></font>
                   SMCEQ   ,                                                   &amp; <font color=#447700>! IN : Vegetation/Soil characteristics<a name='344'></font>
                   SFCTMP  , SFCPRS  , PSFC    , UU      , VV      , Q2      , &amp; <font color=#447700>! IN : Forcing<a name='345'></font>
                   QC      , SOLDN   , LWDN    ,                               &amp; <font color=#447700>! IN : Forcing<a name='346'></font>
	           PRCPCONV, PRCPNONC, PRCPSHCV, PRCPSNOW, PRCPGRPL, PRCPHAIL, &amp; <font color=#447700>! IN : Forcing<a name='347'></font>
                   TBOT    , CO2AIR  , O2AIR   , FOLN    , FICEOLD , ZLVL    , &amp; <font color=#447700>! IN : Forcing<a name='348'></font>
                   ALBOLD  , SNEQVO  ,                                         &amp; <font color=#447700>! IN/OUT : <a name='349'></font>
                   STC     , SH2O    , SMC     , TAH     , EAH     , FWET    , &amp; <font color=#447700>! IN/OUT : <a name='350'></font>
                   CANLIQ  , CANICE  , TV      , TG      , QSFC    , QSNOW   , &amp; <font color=#447700>! IN/OUT : <a name='351'></font>
                   ISNOW   , ZSNSO   , SNOWH   , SNEQV   , SNICE   , SNLIQ   , &amp; <font color=#447700>! IN/OUT : <a name='352'></font>
                   ZWT     , WA      , WT      , WSLAKE  , LFMASS  , RTMASS  , &amp; <font color=#447700>! IN/OUT : <a name='353'></font>
                   STMASS  , WOOD    , STBLCP  , FASTCP  , LAI     , SAI     , &amp; <font color=#447700>! IN/OUT : <a name='354'></font>
                   CM      , CH      , TAUSS   ,                               &amp; <font color=#447700>! IN/OUT : <a name='355'></font>
                   GRAIN   , GDD     , PGS     ,                               &amp; <font color=#447700>! IN/OUT <a name='356'></font>
                   SMCWTD  ,DEEPRECH , RECH    ,                               &amp; <font color=#447700>! IN/OUT :<a name='357'></font>
		   Z0WRF   , &amp;<a name='358'>
                   FSA     , FSR     , FIRA    , FSH     , SSOIL   , FCEV    , &amp; <font color=#447700>! OUT : <a name='359'></font>
                   FGEV    , FCTR    , ECAN    , ETRAN   , EDIR    , TRAD    , &amp; <font color=#447700>! OUT :<a name='360'></font>
                   TGB     , TGV     , T2MV    , T2MB    , Q2V     , Q2B     , &amp; <font color=#447700>! OUT :<a name='361'></font>
                   RUNSRF  , RUNSUB  , APAR    , PSN     , SAV     , SAG     , &amp; <font color=#447700>! OUT :<a name='362'></font>
                   FSNO    , NEE     , GPP     , NPP     , FVEG    , ALBEDO  , &amp; <font color=#447700>! OUT :<a name='363'></font>
                   QSNBOT  , PONDING , PONDING1, PONDING2, RSSUN   , RSSHA   , &amp; <font color=#447700>! OUT :<a name='364'></font>
                   BGAP    , WGAP    , CHV     , CHB     , EMISSI  ,           &amp; <font color=#447700>! OUT :<a name='365'></font>
		   SHG     , SHC     , SHB     , EVG     , EVB     , GHV     , &amp; <font color=#447700>! OUT :<a name='366'></font>
		   GHB     , IRG     , IRC     , IRB     , TR      , EVC     , &amp; <font color=#447700>! OUT :<a name='367'></font>
		   CHLEAF  , CHUC    , CHV2    , CHB2    , FPICE   , PAHV    , &amp;<a name='368'>
                   PAHG    , PAHB    , PAH                                     &amp;<a name='369'>
#ifdef WRF_HYDRO<a name='370'>
                   ,SFCHEADRT                                                  &amp; <font color=#447700>! IN/OUT :<a name='371'></font>
#endif<a name='372'>
                   )<a name='373'>
<a name='374'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='375'></font>
<font color=#447700>! Initial code: Guo-Yue Niu, Oct. 2007<a name='376'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='377'></font>
  implicit none<a name='378'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='379'></font>
<font color=#447700>! input<a name='380'></font>
  type (noahmp_parameters), INTENT(IN) :: parameters<a name='381'>
<a name='382'>
  INTEGER                        , INTENT(IN)    :: ICE    <font color=#447700>!ice (ice = 1)<a name='383'></font>
  INTEGER                        , INTENT(IN)    :: IST    <font color=#447700>!surface type 1-&gt;soil; 2-&gt;lake<a name='384'></font>
  INTEGER                        , INTENT(IN)    :: VEGTYP <font color=#447700>!vegetation type <a name='385'></font>
  INTEGER                        , INTENT(IN)    :: CROPTYPE <font color=#447700>!crop type <a name='386'></font>
  INTEGER                        , INTENT(IN)    :: NSNOW  <font color=#447700>!maximum no. of snow layers        <a name='387'></font>
  INTEGER                        , INTENT(IN)    :: NSOIL  <font color=#447700>!no. of soil layers        <a name='388'></font>
  INTEGER                        , INTENT(IN)    :: ILOC   <font color=#447700>!grid index<a name='389'></font>
  INTEGER                        , INTENT(IN)    :: JLOC   <font color=#447700>!grid index<a name='390'></font>
  REAL                           , INTENT(IN)    :: DT     <font color=#447700>!time step [sec]<a name='391'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN)    :: ZSOIL  <font color=#447700>!layer-bottom depth from soil surf (m)<a name='392'></font>
  REAL                           , INTENT(IN)    :: Q2     <font color=#447700>!mixing ratio (kg/kg) lowest model layer<a name='393'></font>
  REAL                           , INTENT(IN)    :: SFCTMP <font color=#447700>!surface air temperature [K]<a name='394'></font>
  REAL                           , INTENT(IN)    :: UU     <font color=#447700>!wind speed in eastward dir (m/s)<a name='395'></font>
  REAL                           , INTENT(IN)    :: VV     <font color=#447700>!wind speed in northward dir (m/s)<a name='396'></font>
  REAL                           , INTENT(IN)    :: SOLDN  <font color=#447700>!downward shortwave radiation (w/m2)<a name='397'></font>
  REAL                           , INTENT(IN)    :: LWDN   <font color=#447700>!downward longwave radiation (w/m2)<a name='398'></font>
  REAL                           , INTENT(IN)    :: SFCPRS <font color=#447700>!pressure (pa)<a name='399'></font>
  REAL                           , INTENT(INOUT) :: ZLVL   <font color=#447700>!reference height (m)<a name='400'></font>
  REAL                           , INTENT(IN)    :: COSZ   <font color=#447700>!cosine solar zenith angle [0-1]<a name='401'></font>
  REAL                           , INTENT(IN)    :: TBOT   <font color=#447700>!bottom condition for soil temp. [K]<a name='402'></font>
  REAL                           , INTENT(IN)    :: FOLN   <font color=#447700>!foliage nitrogen (%) [1-saturated]<a name='403'></font>
  REAL                           , INTENT(IN)    :: SHDFAC <font color=#447700>!green vegetation fraction [0.0-1.0]<a name='404'></font>
  INTEGER                        , INTENT(IN)    :: YEARLEN<font color=#447700>!Number of days in the particular year.<a name='405'></font>
  REAL                           , INTENT(IN)    :: JULIAN <font color=#447700>!Julian day of year (floating point)<a name='406'></font>
  REAL                           , INTENT(IN)    :: LAT    <font color=#447700>!latitude (radians)<a name='407'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(IN)    :: FICEOLD<font color=#447700>!ice fraction at last timestep<a name='408'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN)    :: SMCEQ  <font color=#447700>!equilibrium soil water  content [m3/m3]<a name='409'></font>
  REAL                           , INTENT(IN)    :: PRCPCONV <font color=#447700>! convective precipitation entering  [mm/s]    ! MB/AN : v3.7<a name='410'></font>
  REAL                           , INTENT(IN)    :: PRCPNONC <font color=#447700>! non-convective precipitation entering [mm/s] ! MB/AN : v3.7<a name='411'></font>
  REAL                           , INTENT(IN)    :: PRCPSHCV <font color=#447700>! shallow convective precip entering  [mm/s]   ! MB/AN : v3.7<a name='412'></font>
  REAL                           , INTENT(IN)    :: PRCPSNOW <font color=#447700>! snow entering land model [mm/s]              ! MB/AN : v3.7<a name='413'></font>
  REAL                           , INTENT(IN)    :: PRCPGRPL <font color=#447700>! graupel entering land model [mm/s]           ! MB/AN : v3.7<a name='414'></font>
  REAL                           , INTENT(IN)    :: PRCPHAIL <font color=#447700>! hail entering land model [mm/s]              ! MB/AN : v3.7<a name='415'></font>
<a name='416'>
<font color=#447700>!jref:start; in <a name='417'></font>
  REAL                           , INTENT(IN)    :: QC     <font color=#447700>!cloud water mixing ratio<a name='418'></font>
  REAL                           , INTENT(INOUT)    :: QSFC   <font color=#447700>!mixing ratio at lowest model layer<a name='419'></font>
  REAL                           , INTENT(IN)    :: PSFC   <font color=#447700>!pressure at lowest model layer<a name='420'></font>
  REAL                           , INTENT(IN)    :: DZ8W   <font color=#447700>!thickness of lowest layer<a name='421'></font>
  REAL                           , INTENT(IN)    :: DX<a name='422'>
  REAL                           , INTENT(IN)    :: SHDMAX  <font color=#447700>!yearly max vegetation fraction<a name='423'></font>
<font color=#447700>!jref:end<a name='424'></font>
<a name='425'>
#ifdef WRF_HYDRO<a name='426'>
  REAL                           , INTENT(INOUT)    :: sfcheadrt<a name='427'>
#endif<a name='428'>
<a name='429'>
<font color=#447700>! input/output : need arbitary intial values<a name='430'></font>
  REAL                           , INTENT(INOUT) :: QSNOW  <font color=#447700>!snowfall [mm/s]<a name='431'></font>
  REAL                           , INTENT(INOUT) :: FWET   <font color=#447700>!wetted or snowed fraction of canopy (-)<a name='432'></font>
  REAL                           , INTENT(INOUT) :: SNEQVO <font color=#447700>!snow mass at last time step (mm)<a name='433'></font>
  REAL                           , INTENT(INOUT) :: EAH    <font color=#447700>!canopy air vapor pressure (pa)<a name='434'></font>
  REAL                           , INTENT(INOUT) :: TAH    <font color=#447700>!canopy air tmeperature (k)<a name='435'></font>
  REAL                           , INTENT(INOUT) :: ALBOLD <font color=#447700>!snow albedo at last time step (CLASS type)<a name='436'></font>
  REAL                           , INTENT(INOUT) :: CM     <font color=#447700>!momentum drag coefficient<a name='437'></font>
  REAL                           , INTENT(INOUT) :: CH     <font color=#447700>!sensible heat exchange coefficient<a name='438'></font>
  REAL                           , INTENT(INOUT) :: TAUSS  <font color=#447700>!non-dimensional snow age<a name='439'></font>
<a name='440'>
<font color=#447700>! prognostic variables<a name='441'></font>
  INTEGER                        , INTENT(INOUT) :: ISNOW  <font color=#447700>!actual no. of snow layers [-]<a name='442'></font>
  REAL                           , INTENT(INOUT) :: CANLIQ <font color=#447700>!intercepted liquid water (mm)<a name='443'></font>
  REAL                           , INTENT(INOUT) :: CANICE <font color=#447700>!intercepted ice mass (mm)<a name='444'></font>
  REAL                           , INTENT(INOUT) :: SNEQV  <font color=#447700>!snow water eqv. [mm]<a name='445'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SMC    <font color=#447700>!soil moisture (ice + liq.) [m3/m3]<a name='446'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: ZSNSO  <font color=#447700>!layer-bottom depth from snow surf [m]<a name='447'></font>
  REAL                           , INTENT(INOUT) :: SNOWH  <font color=#447700>!snow height [m]<a name='448'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNICE  <font color=#447700>!snow layer ice [mm]<a name='449'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNLIQ  <font color=#447700>!snow layer liquid water [mm]<a name='450'></font>
  REAL                           , INTENT(INOUT) :: TV     <font color=#447700>!vegetation temperature (k)<a name='451'></font>
  REAL                           , INTENT(INOUT) :: TG     <font color=#447700>!ground temperature (k)<a name='452'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC    <font color=#447700>!snow/soil temperature [k]<a name='453'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SH2O   <font color=#447700>!liquid soil moisture [m3/m3]<a name='454'></font>
  REAL                           , INTENT(INOUT) :: ZWT    <font color=#447700>!depth to water table [m]<a name='455'></font>
  REAL                           , INTENT(INOUT) :: WA     <font color=#447700>!water storage in aquifer [mm]<a name='456'></font>
  REAL                           , INTENT(INOUT) :: WT     <font color=#447700>!water in aquifer&amp;saturated soil [mm]<a name='457'></font>
  REAL                           , INTENT(INOUT) :: WSLAKE <font color=#447700>!lake water storage (can be neg.) (mm)<a name='458'></font>
  REAL,                            INTENT(INOUT) :: SMCWTD <font color=#447700>!soil water content between bottom of the soil and water table [m3/m3]<a name='459'></font>
  REAL,                            INTENT(INOUT) :: DEEPRECH <font color=#447700>!recharge to or from the water table when deep [m]<a name='460'></font>
  REAL,                            INTENT(INOUT) :: RECH <font color=#447700>!recharge to or from the water table when shallow [m] (diagnostic)<a name='461'></font>
<a name='462'>
<font color=#447700>! output<a name='463'></font>
  REAL                           , INTENT(OUT)   :: Z0WRF  <font color=#447700>!combined z0 sent to coupled model<a name='464'></font>
  REAL                           , INTENT(OUT)   :: FSA    <font color=#447700>!total absorbed solar radiation (w/m2)<a name='465'></font>
  REAL                           , INTENT(OUT)   :: FSR    <font color=#447700>!total reflected solar radiation (w/m2)<a name='466'></font>
  REAL                           , INTENT(OUT)   :: FIRA   <font color=#447700>!total net LW rad (w/m2)  [+ to atm]<a name='467'></font>
  REAL                           , INTENT(OUT)   :: FSH    <font color=#447700>!total sensible heat (w/m2) [+ to atm]<a name='468'></font>
  REAL                           , INTENT(OUT)   :: FCEV   <font color=#447700>!canopy evap heat (w/m2) [+ to atm]<a name='469'></font>
  REAL                           , INTENT(OUT)   :: FGEV   <font color=#447700>!ground evap heat (w/m2) [+ to atm]<a name='470'></font>
  REAL                           , INTENT(OUT)   :: FCTR   <font color=#447700>!transpiration heat (w/m2) [+ to atm]<a name='471'></font>
  REAL                           , INTENT(OUT)   :: SSOIL  <font color=#447700>!ground heat flux (w/m2)   [+ to soil]<a name='472'></font>
  REAL                           , INTENT(OUT)   :: TRAD   <font color=#447700>!surface radiative temperature (k)<a name='473'></font>
  REAL                                           :: TS     <font color=#447700>!surface temperature (k)<a name='474'></font>
  REAL                           , INTENT(OUT)   :: ECAN   <font color=#447700>!evaporation of intercepted water (mm/s)<a name='475'></font>
  REAL                           , INTENT(OUT)   :: ETRAN  <font color=#447700>!transpiration rate (mm/s)<a name='476'></font>
  REAL                           , INTENT(OUT)   :: EDIR   <font color=#447700>!soil surface evaporation rate (mm/s]<a name='477'></font>
  REAL                           , INTENT(OUT)   :: RUNSRF <font color=#447700>!surface runoff [mm/s] <a name='478'></font>
  REAL                           , INTENT(OUT)   :: RUNSUB <font color=#447700>!baseflow (saturation excess) [mm/s]<a name='479'></font>
  REAL                           , INTENT(OUT)   :: PSN    <font color=#447700>!total photosynthesis (umol co2/m2/s) [+]<a name='480'></font>
  REAL                           , INTENT(OUT)   :: APAR   <font color=#447700>!photosyn active energy by canopy (w/m2)<a name='481'></font>
  REAL                           , INTENT(OUT)   :: SAV    <font color=#447700>!solar rad absorbed by veg. (w/m2)<a name='482'></font>
  REAL                           , INTENT(OUT)   :: SAG    <font color=#447700>!solar rad absorbed by ground (w/m2)<a name='483'></font>
  REAL                           , INTENT(OUT)   :: FSNO   <font color=#447700>!snow cover fraction on the ground (-)<a name='484'></font>
  REAL                           , INTENT(OUT)   :: FVEG   <font color=#447700>!green vegetation fraction [0.0-1.0]<a name='485'></font>
  REAL                           , INTENT(OUT)   :: ALBEDO <font color=#447700>!surface albedo [-]<a name='486'></font>
  REAL                                           :: ERRWAT <font color=#447700>!water error [kg m{-2}]<a name='487'></font>
  REAL                           , INTENT(OUT)   :: QSNBOT <font color=#447700>!snowmelt out bottom of pack [mm/s]<a name='488'></font>
  REAL                           , INTENT(OUT)   :: PONDING<font color=#447700>!surface ponding [mm]<a name='489'></font>
  REAL                           , INTENT(OUT)   :: PONDING1<font color=#447700>!surface ponding [mm]<a name='490'></font>
  REAL                           , INTENT(OUT)   :: PONDING2<font color=#447700>!surface ponding [mm]<a name='491'></font>
<a name='492'>
<font color=#447700>!jref:start; output<a name='493'></font>
  REAL                           , INTENT(OUT)     :: T2MV   <font color=#447700>!2-m air temperature over vegetated part [k]<a name='494'></font>
  REAL                           , INTENT(OUT)     :: T2MB   <font color=#447700>!2-m air temperature over bare ground part [k]<a name='495'></font>
  REAL, INTENT(OUT) :: RSSUN        <font color=#447700>!sunlit leaf stomatal resistance (s/m)<a name='496'></font>
  REAL, INTENT(OUT) :: RSSHA        <font color=#447700>!shaded leaf stomatal resistance (s/m)<a name='497'></font>
  REAL, INTENT(OUT) :: BGAP<a name='498'>
  REAL, INTENT(OUT) :: WGAP<a name='499'>
  REAL, INTENT(OUT) :: TGV<a name='500'>
  REAL, INTENT(OUT) :: TGB<a name='501'>
  REAL              :: Q1<a name='502'>
  REAL, INTENT(OUT) :: EMISSI<a name='503'>
<font color=#447700>!jref:end<a name='504'></font>
<a name='505'>
<font color=#447700>! local<a name='506'></font>
  INTEGER                                        :: IZ     <font color=#447700>!do-loop index<a name='507'></font>
  INTEGER, DIMENSION(-NSNOW+1:NSOIL)             :: IMELT  <font color=#447700>!phase change index [1-melt; 2-freeze]<a name='508'></font>
  REAL                                           :: CMC    <font color=#447700>!intercepted water (CANICE+CANLIQ) (mm)<a name='509'></font>
  REAL                                           :: TAUX   <font color=#447700>!wind stress: e-w (n/m2)<a name='510'></font>
  REAL                                           :: TAUY   <font color=#447700>!wind stress: n-s (n/m2)<a name='511'></font>
  REAL                                           :: RHOAIR <font color=#447700>!density air (kg/m3)<a name='512'></font>
<font color=#447700>!  REAL, DIMENSION(       1:    5)                :: VOCFLX !voc fluxes [ug C m-2 h-1]<a name='513'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL)                :: DZSNSO <font color=#447700>!snow/soil layer thickness [m]<a name='514'></font>
  REAL                                           :: THAIR  <font color=#447700>!potential temperature (k)<a name='515'></font>
  REAL                                           :: QAIR   <font color=#447700>!specific humidity (kg/kg) (q2/(1+q2))<a name='516'></font>
  REAL                                           :: EAIR   <font color=#447700>!vapor pressure air (pa)<a name='517'></font>
  REAL, DIMENSION(       1:    2)                :: SOLAD  <font color=#447700>!incoming direct solar rad (w/m2)<a name='518'></font>
  REAL, DIMENSION(       1:    2)                :: SOLAI  <font color=#447700>!incoming diffuse solar rad (w/m2)<a name='519'></font>
  REAL                                           :: QPRECC <font color=#447700>!convective precipitation (mm/s)<a name='520'></font>
  REAL                                           :: QPRECL <font color=#447700>!large-scale precipitation (mm/s)<a name='521'></font>
  REAL                                           :: IGS    <font color=#447700>!growing season index (0=off, 1=on)<a name='522'></font>
  REAL                                           :: ELAI   <font color=#447700>!leaf area index, after burying by snow<a name='523'></font>
  REAL                                           :: ESAI   <font color=#447700>!stem area index, after burying by snow<a name='524'></font>
  REAL                                           :: BEVAP  <font color=#447700>!soil water evaporation factor (0 - 1)<a name='525'></font>
  REAL, DIMENSION(       1:NSOIL)                :: BTRANI <font color=#447700>!Soil water transpiration factor (0 - 1)<a name='526'></font>
  REAL                                           :: BTRAN  <font color=#447700>!soil water transpiration factor (0 - 1)<a name='527'></font>
  REAL                                           :: QIN    <font color=#447700>!groundwater recharge [mm/s]<a name='528'></font>
  REAL                                           :: QDIS   <font color=#447700>!groundwater discharge [mm/s]<a name='529'></font>
  REAL, DIMENSION(       1:NSOIL)                :: SICE   <font color=#447700>!soil ice content (m3/m3)<a name='530'></font>
  REAL, DIMENSION(-NSNOW+1:    0)                :: SNICEV <font color=#447700>!partial volume ice of snow [m3/m3]<a name='531'></font>
  REAL, DIMENSION(-NSNOW+1:    0)                :: SNLIQV <font color=#447700>!partial volume liq of snow [m3/m3]<a name='532'></font>
  REAL, DIMENSION(-NSNOW+1:    0)                :: EPORE  <font color=#447700>!effective porosity [m3/m3]<a name='533'></font>
  REAL                                           :: TOTSC  <font color=#447700>!total soil carbon (g/m2)<a name='534'></font>
  REAL                                           :: TOTLB  <font color=#447700>!total living carbon (g/m2)<a name='535'></font>
  REAL                                           :: T2M    <font color=#447700>!2-meter air temperature (k)<a name='536'></font>
  REAL                                           :: QDEW   <font color=#447700>!ground surface dew rate [mm/s]<a name='537'></font>
  REAL                                           :: QVAP   <font color=#447700>!ground surface evap. rate [mm/s]<a name='538'></font>
  REAL                                           :: LATHEA <font color=#447700>!latent heat [j/kg]<a name='539'></font>
  REAL                                           :: SWDOWN <font color=#447700>!downward solar [w/m2]<a name='540'></font>
  REAL                                           :: QMELT  <font color=#447700>!snowmelt [mm/s]<a name='541'></font>
  REAL                                           :: BEG_WB <font color=#447700>!water storage at begin of a step [mm]<a name='542'></font>
  REAL,INTENT(OUT)                                              :: IRC    <font color=#447700>!canopy net LW rad. [w/m2] [+ to atm]<a name='543'></font>
  REAL,INTENT(OUT)                                              :: IRG    <font color=#447700>!ground net LW rad. [w/m2] [+ to atm]<a name='544'></font>
  REAL,INTENT(OUT)                                              :: SHC    <font color=#447700>!canopy sen. heat [w/m2]   [+ to atm]<a name='545'></font>
  REAL,INTENT(OUT)                                              :: SHG    <font color=#447700>!ground sen. heat [w/m2]   [+ to atm]<a name='546'></font>
  REAL,INTENT(OUT)                                              :: EVG    <font color=#447700>!ground evap. heat [w/m2]  [+ to atm]<a name='547'></font>
  REAL,INTENT(OUT)                                              :: GHV    <font color=#447700>!ground heat flux [w/m2]  [+ to soil]<a name='548'></font>
  REAL,INTENT(OUT)                                              :: IRB    <font color=#447700>!net longwave rad. [w/m2] [+ to atm]<a name='549'></font>
  REAL,INTENT(OUT)                                              :: SHB    <font color=#447700>!sensible heat [w/m2]     [+ to atm]<a name='550'></font>
  REAL,INTENT(OUT)                                              :: EVB    <font color=#447700>!evaporation heat [w/m2]  [+ to atm]<a name='551'></font>
  REAL,INTENT(OUT)                                              :: GHB    <font color=#447700>!ground heat flux [w/m2] [+ to soil]<a name='552'></font>
  REAL,INTENT(OUT)                                              :: EVC    <font color=#447700>!canopy evap. heat [w/m2]  [+ to atm]<a name='553'></font>
  REAL,INTENT(OUT)                                              :: TR     <font color=#447700>!transpiration heat [w/m2] [+ to atm]<a name='554'></font>
  REAL, INTENT(OUT)   :: FPICE   <font color=#447700>!snow fraction in precipitation<a name='555'></font>
  REAL, INTENT(OUT)   :: PAHV    <font color=#447700>!precipitation advected heat - vegetation net (W/m2)<a name='556'></font>
  REAL, INTENT(OUT)   :: PAHG    <font color=#447700>!precipitation advected heat - under canopy net (W/m2)<a name='557'></font>
  REAL, INTENT(OUT)   :: PAHB    <font color=#447700>!precipitation advected heat - bare ground net (W/m2)<a name='558'></font>
  REAL, INTENT(OUT)                                           :: PAH     <font color=#447700>!precipitation advected heat - total (W/m2)<a name='559'></font>
<a name='560'>
<font color=#447700>!jref:start <a name='561'></font>
  REAL                                           :: FSRV<a name='562'>
  REAL                                           :: FSRG<a name='563'>
  REAL,INTENT(OUT)                               :: Q2V<a name='564'>
  REAL,INTENT(OUT)                               :: Q2B<a name='565'>
  REAL :: Q2E<a name='566'>
  REAL :: QFX<a name='567'>
  REAL,INTENT(OUT)                               :: CHV    <font color=#447700>!sensible heat exchange coefficient over vegetated fraction<a name='568'></font>
  REAL,INTENT(OUT)                               :: CHB    <font color=#447700>!sensible heat exchange coefficient over bare-ground<a name='569'></font>
  REAL,INTENT(OUT)                               :: CHLEAF <font color=#447700>!leaf exchange coefficient<a name='570'></font>
  REAL,INTENT(OUT)                               :: CHUC   <font color=#447700>!under canopy exchange coefficient<a name='571'></font>
  REAL,INTENT(OUT)                               :: CHV2    <font color=#447700>!sensible heat exchange coefficient over vegetated fraction<a name='572'></font>
  REAL,INTENT(OUT)                               :: CHB2    <font color=#447700>!sensible heat exchange coefficient over bare-ground<a name='573'></font>
<font color=#447700>!jref:end  <a name='574'></font>
<a name='575'>
<font color=#447700>! carbon<a name='576'></font>
<font color=#447700>! inputs<a name='577'></font>
  REAL                           , INTENT(IN)    :: CO2AIR <font color=#447700>!atmospheric co2 concentration (pa)<a name='578'></font>
  REAL                           , INTENT(IN)    :: O2AIR  <font color=#447700>!atmospheric o2 concentration (pa)<a name='579'></font>
<a name='580'>
<font color=#447700>! inputs and outputs : prognostic variables<a name='581'></font>
  REAL                        , INTENT(INOUT)    :: LFMASS <font color=#447700>!leaf mass [g/m2]<a name='582'></font>
  REAL                        , INTENT(INOUT)    :: RTMASS <font color=#447700>!mass of fine roots [g/m2]<a name='583'></font>
  REAL                        , INTENT(INOUT)    :: STMASS <font color=#447700>!stem mass [g/m2]<a name='584'></font>
  REAL                        , INTENT(INOUT)    :: WOOD   <font color=#447700>!mass of wood (incl. woody roots) [g/m2]<a name='585'></font>
  REAL                        , INTENT(INOUT)    :: STBLCP <font color=#447700>!stable carbon in deep soil [g/m2]<a name='586'></font>
  REAL                        , INTENT(INOUT)    :: FASTCP <font color=#447700>!short-lived carbon, shallow soil [g/m2]<a name='587'></font>
  REAL                        , INTENT(INOUT)    :: LAI    <font color=#447700>!leaf area index [-]<a name='588'></font>
  REAL                        , INTENT(INOUT)    :: SAI    <font color=#447700>!stem area index [-]<a name='589'></font>
  REAL                        , INTENT(INOUT)    :: GRAIN  <font color=#447700>!grain mass [g/m2]<a name='590'></font>
  REAL                        , INTENT(INOUT)    :: GDD    <font color=#447700>!growing degree days<a name='591'></font>
  INTEGER                     , INTENT(INOUT)    :: PGS    <font color=#447700>!plant growing stage [-]<a name='592'></font>
<a name='593'>
<font color=#447700>! outputs<a name='594'></font>
  REAL                          , INTENT(OUT)    :: NEE    <font color=#447700>!net ecosys exchange (g/m2/s CO2)<a name='595'></font>
  REAL                          , INTENT(OUT)    :: GPP    <font color=#447700>!net instantaneous assimilation [g/m2/s C]<a name='596'></font>
  REAL                          , INTENT(OUT)    :: NPP    <font color=#447700>!net primary productivity [g/m2/s C]<a name='597'></font>
  REAL                                           :: AUTORS <font color=#447700>!net ecosystem respiration (g/m2/s C)<a name='598'></font>
  REAL                                           :: HETERS <font color=#447700>!organic respiration (g/m2/s C)<a name='599'></font>
  REAL                                           :: TROOT  <font color=#447700>!root-zone averaged temperature (k)<a name='600'></font>
  REAL                                           :: BDFALL   <font color=#447700>!bulk density of new snow (kg/m3)    ! MB/AN: v3.7<a name='601'></font>
  REAL                                           :: RAIN     <font color=#447700>!rain rate                   (mm/s)  ! MB/AN: v3.7<a name='602'></font>
  REAL                                           :: SNOW     <font color=#447700>!liquid equivalent snow rate (mm/s)  ! MB/AN: v3.7<a name='603'></font>
  REAL                                           :: FP                                            <font color=#447700>! MB/AN: v3.7<a name='604'></font>
  REAL                                           :: PRCP                                          <font color=#447700>! MB/AN: v3.7<a name='605'></font>
<font color=#447700>!more local variables for precip heat MB<a name='606'></font>
  REAL                                           :: QINTR   <font color=#447700>!interception rate for rain (mm/s)<a name='607'></font>
  REAL                                           :: QDRIPR  <font color=#447700>!drip rate for rain (mm/s)<a name='608'></font>
  REAL                                           :: QTHROR  <font color=#447700>!throughfall for rain (mm/s)<a name='609'></font>
  REAL                                           :: QINTS   <font color=#447700>!interception (loading) rate for snowfall (mm/s)<a name='610'></font>
  REAL                                           :: QDRIPS  <font color=#447700>!drip (unloading) rate for intercepted snow (mm/s)<a name='611'></font>
  REAL                                           :: QTHROS  <font color=#447700>!throughfall of snowfall (mm/s)<a name='612'></font>
  REAL                                           :: QRAIN   <font color=#447700>!rain at ground srf (mm/s) [+]<a name='613'></font>
  REAL                                           :: SNOWHIN <font color=#447700>!snow depth increasing rate (m/s)<a name='614'></font>
  REAL                                 :: LATHEAV <font color=#447700>!latent heat vap./sublimation (j/kg)<a name='615'></font>
  REAL                                 :: LATHEAG <font color=#447700>!latent heat vap./sublimation (j/kg)<a name='616'></font>
  LOGICAL                             :: FROZEN_GROUND <font color=#447700>! used to define latent heat pathway<a name='617'></font>
  LOGICAL                             :: FROZEN_CANOPY <font color=#447700>! used to define latent heat pathway<a name='618'></font>
  <a name='619'>
  <font color=#447700>! INTENT (OUT) variables need to be assigned a value.  These normally get assigned values<a name='620'></font>
  <font color=#447700>! only if DVEG == 2.<a name='621'></font>
  nee = 0.0<a name='622'>
  npp = 0.0<a name='623'>
  gpp = 0.0<a name='624'>
      PAHV  = 0.<a name='625'>
      PAHG  = 0.<a name='626'>
      PAHB  = 0.<a name='627'>
      PAH  = 0.<a name='628'>
<a name='629'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='630'></font>
<font color=#447700>! re-process atmospheric forcing<a name='631'></font>
<a name='632'>
   CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#ATM'>ATM</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ATM_1"> (parameters,SFCPRS  ,SFCTMP   ,Q2      ,                            &amp;<a name='633'>
             PRCPCONV, PRCPNONC,PRCPSHCV,PRCPSNOW,PRCPGRPL,PRCPHAIL, &amp;<a name='634'>
             SOLDN   ,COSZ     ,THAIR   ,QAIR    ,                   &amp; <a name='635'>
             EAIR    ,RHOAIR   ,QPRECC  ,QPRECL  ,SOLAD   ,SOLAI   , &amp;<a name='636'>
             SWDOWN  ,BDFALL   ,RAIN    ,SNOW    ,FP      ,FPICE   , PRCP )     <a name='637'>
<a name='638'>
<font color=#447700>! snow/soil layer thickness (m)<a name='639'></font>
<a name='640'>
     DO IZ = ISNOW+1, NSOIL<a name='641'>
         IF(IZ == ISNOW+1) THEN<a name='642'>
           DZSNSO(IZ) = - ZSNSO(IZ)<a name='643'>
         ELSE<a name='644'>
           DZSNSO(IZ) = ZSNSO(IZ-1) - ZSNSO(IZ)<a name='645'>
         END IF<a name='646'>
     END DO<a name='647'>
<a name='648'>
<font color=#447700>! root-zone temperature<a name='649'></font>
<a name='650'>
     TROOT  = 0.<a name='651'>
     DO IZ=1,parameters%NROOT<a name='652'>
        TROOT = TROOT + STC(IZ)*DZSNSO(IZ)/(-ZSOIL(parameters%NROOT))<a name='653'>
     ENDDO<a name='654'>
<a name='655'>
<font color=#447700>! total water storage for water balance check<a name='656'></font>
    <a name='657'>
     IF(IST == 1) THEN<a name='658'>
     BEG_WB = CANLIQ + CANICE + SNEQV + WA<a name='659'>
     DO IZ = 1,NSOIL<a name='660'>
        BEG_WB = BEG_WB + SMC(IZ) * DZSNSO(IZ) * 1000.<a name='661'>
     END DO<a name='662'>
     END IF<a name='663'>
<a name='664'>
<font color=#447700>! vegetation phenology<a name='665'></font>
<a name='666'>
     CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#PHENOLOGY'>PHENOLOGY</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHENOLOGY_1"> (parameters,VEGTYP ,croptype, SNOWH  , TV     , LAT   , YEARLEN , JULIAN , &amp; <font color=#447700>!in<a name='667'></font>
                     LAI    , SAI    , TROOT  , ELAI    , ESAI   ,IGS, PGS)<a name='668'>
<a name='669'>
<font color=#447700>!input GVF should be consistent with LAI<a name='670'></font>
     IF(DVEG == 1 .or. DVEG == 6 .or. DVEG == 7) THEN<a name='671'>
        FVEG = SHDFAC<a name='672'>
        IF(FVEG &lt;= 0.05) FVEG = 0.05<a name='673'>
     ELSE IF (DVEG == 2 .or. DVEG == 3 .or. DVEG == 8) THEN<a name='674'>
        FVEG = 1.-EXP(-0.52*(LAI+SAI))<a name='675'>
        IF(FVEG &lt;= 0.05) FVEG = 0.05<a name='676'>
     ELSE IF (DVEG == 4 .or. DVEG == 5 .or. DVEG == 9 .or. DVEG == 10) THEN<a name='677'>
        FVEG = SHDMAX<a name='678'>
        IF(FVEG &lt;= 0.05) FVEG = 0.05<a name='679'>
     ELSE<a name='680'>
        WRITE(*,*) "-------- FATAL CALLED IN SFLX -----------"<a name='681'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1185">("Namelist parameter DVEG unknown") <a name='682'>
     ENDIF<a name='683'>
     IF(parameters%urban_flag .OR. VEGTYP == parameters%ISBARREN) FVEG = 0.0<a name='684'>
     IF(ELAI+ESAI == 0.0) FVEG = 0.0<a name='685'>
<a name='686'>
    CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#PRECIP_HEAT'>PRECIP_HEAT</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PRECIP_HEAT_1">(parameters,ILOC   ,JLOC   ,VEGTYP ,DT     ,UU     ,VV     , &amp; <font color=#447700>!in<a name='687'></font>
                     ELAI   ,ESAI   ,FVEG   ,IST    ,                 &amp; <font color=#447700>!in<a name='688'></font>
                     BDFALL ,RAIN   ,SNOW   ,FP     ,                 &amp; <font color=#447700>!in<a name='689'></font>
                     CANLIQ ,CANICE ,TV     ,SFCTMP ,TG     ,         &amp; <font color=#447700>!in<a name='690'></font>
                     QINTR  ,QDRIPR ,QTHROR ,QINTS  ,QDRIPS ,QTHROS , &amp; <font color=#447700>!out<a name='691'></font>
                     PAHV   ,PAHG   ,PAHB   ,QRAIN  ,QSNOW  ,SNOWHIN, &amp; <font color=#447700>!out<a name='692'></font>
	             FWET   ,CMC                                    )   <font color=#447700>!out<a name='693'></font>
<a name='694'>
<font color=#447700>! compute energy budget (momentum &amp; energy fluxes and phase changes) <a name='695'></font>
<a name='696'>
    CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#ENERGY'>ENERGY</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENERGY_1"> (parameters,ICE    ,VEGTYP ,IST    ,NSNOW  ,NSOIL  , &amp; <font color=#447700>!in<a name='697'></font>
                 ISNOW  ,DT     ,RHOAIR ,SFCPRS ,QAIR   , &amp; <font color=#447700>!in<a name='698'></font>
                 SFCTMP ,THAIR  ,LWDN   ,UU     ,VV     ,ZLVL   , &amp; <font color=#447700>!in<a name='699'></font>
                 CO2AIR ,O2AIR  ,SOLAD  ,SOLAI  ,COSZ   ,IGS    , &amp; <font color=#447700>!in<a name='700'></font>
                 EAIR   ,TBOT   ,ZSNSO  ,ZSOIL  , &amp; <font color=#447700>!in<a name='701'></font>
                 ELAI   ,ESAI   ,FWET   ,FOLN   ,         &amp; <font color=#447700>!in<a name='702'></font>
                 FVEG   ,PAHV   ,PAHG   ,PAHB   ,                 &amp; <font color=#447700>!in<a name='703'></font>
                 QSNOW  ,DZSNSO ,LAT    ,CANLIQ ,CANICE ,iloc, jloc , &amp; <font color=#447700>!in<a name='704'></font>
		 Z0WRF  ,                                         &amp;<a name='705'>
                 IMELT  ,SNICEV ,SNLIQV ,EPORE  ,T2M    ,FSNO   , &amp; <font color=#447700>!out<a name='706'></font>
                 SAV    ,SAG    ,QMELT  ,FSA    ,FSR    ,TAUX   , &amp; <font color=#447700>!out<a name='707'></font>
                 TAUY   ,FIRA   ,FSH    ,FCEV   ,FGEV   ,FCTR   , &amp; <font color=#447700>!out<a name='708'></font>
                 TRAD   ,PSN    ,APAR   ,SSOIL  ,BTRANI ,BTRAN  , &amp; <font color=#447700>!out<a name='709'></font>
                 PONDING,TS     ,LATHEAV , LATHEAG , frozen_canopy,frozen_ground,                         &amp; <font color=#447700>!out<a name='710'></font>
                 TV     ,TG     ,STC    ,SNOWH  ,EAH    ,TAH    , &amp; <font color=#447700>!inout<a name='711'></font>
                 SNEQVO ,SNEQV  ,SH2O   ,SMC    ,SNICE  ,SNLIQ  , &amp; <font color=#447700>!inout<a name='712'></font>
                 ALBOLD ,CM     ,CH     ,DX     ,DZ8W   ,Q2     , &amp; <font color=#447700>!inout<a name='713'></font>
                 TAUSS  ,                                         &amp; <font color=#447700>!inout<a name='714'></font>
<font color=#447700>!jref:start<a name='715'></font>
                 QC     ,QSFC   ,PSFC   , &amp; <font color=#447700>!in <a name='716'></font>
                 T2MV   ,T2MB  ,FSRV   , &amp;<a name='717'>
                 FSRG   ,RSSUN   ,RSSHA ,BGAP   ,WGAP, TGV,TGB,&amp;<a name='718'>
                 Q1     ,Q2V    ,Q2B    ,Q2E    ,CHV   ,CHB     , &amp; <font color=#447700>!out<a name='719'></font>
                 EMISSI ,PAH    ,                                 &amp;<a name='720'>
		     SHG,SHC,SHB,EVG,EVB,GHV,GHB,IRG,IRC,IRB,TR,EVC,CHLEAF,CHUC,CHV2,CHB2 )                                            <font color=#447700>!out<a name='721'></font>
<font color=#447700>!jref:end<a name='722'></font>
<a name='723'>
    SICE(:) = MAX(0.0, SMC(:) - SH2O(:))   <a name='724'>
    SNEQVO  = SNEQV<a name='725'>
<a name='726'>
    QVAP = MAX( FGEV/LATHEAG, 0.)       <font color=#447700>! positive part of fgev; Barlage change to ground v3.6<a name='727'></font>
    QDEW = ABS( MIN(FGEV/LATHEAG, 0.))  <font color=#447700>! negative part of fgev<a name='728'></font>
    EDIR = QVAP - QDEW<a name='729'>
<a name='730'>
<font color=#447700>! compute water budgets (water storages, ET components, and runoff)<a name='731'></font>
<a name='732'>
     CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#WATER'>WATER</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WATER_1"> (parameters,VEGTYP ,NSNOW  ,NSOIL  ,IMELT  ,DT     ,UU     , &amp; <font color=#447700>!in<a name='733'></font>
                 VV     ,FCEV   ,FCTR   ,QPRECC ,QPRECL ,ELAI   , &amp; <font color=#447700>!in<a name='734'></font>
                 ESAI   ,SFCTMP ,QVAP   ,QDEW   ,ZSOIL  ,BTRANI , &amp; <font color=#447700>!in<a name='735'></font>
                 FICEOLD,PONDING,TG     ,IST    ,FVEG   ,iloc,jloc , SMCEQ , &amp; <font color=#447700>!in<a name='736'></font>
                 BDFALL ,FP     ,RAIN   ,SNOW   ,                 &amp; <font color=#447700>!in  MB/AN: v3.7<a name='737'></font>
		 QSNOW  ,QRAIN  ,SNOWHIN,LATHEAV,LATHEAG,frozen_canopy,frozen_ground,  &amp; <font color=#447700>!in  MB<a name='738'></font>
                 ISNOW  ,CANLIQ ,CANICE ,TV     ,SNOWH  ,SNEQV  , &amp; <font color=#447700>!inout<a name='739'></font>
                 SNICE  ,SNLIQ  ,STC    ,ZSNSO  ,SH2O   ,SMC    , &amp; <font color=#447700>!inout<a name='740'></font>
                 SICE   ,ZWT    ,WA     ,WT     ,DZSNSO ,WSLAKE , &amp; <font color=#447700>!inout<a name='741'></font>
                 SMCWTD ,DEEPRECH,RECH                          , &amp; <font color=#447700>!inout<a name='742'></font>
                 CMC    ,ECAN   ,ETRAN  ,FWET   ,RUNSRF ,RUNSUB , &amp; <font color=#447700>!out<a name='743'></font>
                 QIN    ,QDIS   ,PONDING1       ,PONDING2,&amp;<a name='744'>
                 QSNBOT                             &amp;<a name='745'>
#ifdef WRF_HYDRO<a name='746'>
                        ,sfcheadrt                     &amp;<a name='747'>
#endif<a name='748'>
                 )  <font color=#447700>!out<a name='749'></font>
<a name='750'>
<font color=#447700>!     write(*,'(a20,10F15.5)') 'SFLX:RUNOFF=',RUNSRF*DT,RUNSUB*DT,EDIR*DT<a name='751'></font>
<a name='752'>
<font color=#447700>! compute carbon budgets (carbon storages and co2 &amp; bvoc fluxes)<a name='753'></font>
<a name='754'>
   IF (DVEG == 2 .OR. DVEG == 5 .OR. DVEG == 6 .OR. (DVEG == 10 .and. CROPTYPE == 0)) THEN<a name='755'>
    CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CARBON'>CARBON</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CARBON_1"> (parameters,NSNOW  ,NSOIL  ,VEGTYP ,DT     ,ZSOIL  , &amp; <font color=#447700>!in<a name='756'></font>
                 DZSNSO ,STC    ,SMC    ,TV     ,TG     ,PSN    , &amp; <font color=#447700>!in<a name='757'></font>
                 FOLN   ,BTRAN  ,APAR   ,FVEG   ,IGS    , &amp; <font color=#447700>!in<a name='758'></font>
                 TROOT  ,IST    ,LAT    ,iloc   ,jloc   , &amp; <font color=#447700>!in<a name='759'></font>
                 LFMASS ,RTMASS ,STMASS ,WOOD   ,STBLCP ,FASTCP , &amp; <font color=#447700>!inout<a name='760'></font>
                 GPP    ,NPP    ,NEE    ,AUTORS ,HETERS ,TOTSC  , &amp; <font color=#447700>!out<a name='761'></font>
                 TOTLB  ,LAI    ,SAI    )                   <font color=#447700>!out<a name='762'></font>
   END IF<a name='763'>
<a name='764'>
   IF (DVEG == 10 .and. CROPTYPE &gt; 0) THEN<a name='765'>
    CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CARBON_CROP'>CARBON_CROP</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CARBON_CROP_1"> (parameters,NSNOW  ,NSOIL  ,VEGTYP ,DT     ,ZSOIL  ,JULIAN , &amp; <font color=#447700>!in <a name='766'></font>
                         DZSNSO ,STC    ,SMC    ,TV     ,PSN    ,FOLN   ,BTRAN  , &amp; <font color=#447700>!in<a name='767'></font>
			 SOLDN  ,T2M    ,                                         &amp; <font color=#447700>!in<a name='768'></font>
                         LFMASS ,RTMASS ,STMASS ,WOOD   ,STBLCP ,FASTCP ,GRAIN  , &amp; <font color=#447700>!inout<a name='769'></font>
			 LAI    ,SAI    ,GDD    ,                                 &amp; <font color=#447700>!inout<a name='770'></font>
                         GPP    ,NPP    ,NEE    ,AUTORS ,HETERS ,TOTSC  ,TOTLB, PGS    ) <font color=#447700>!out<a name='771'></font>
   END IF<a name='772'>
   <a name='773'>
<a name='774'>
<font color=#447700>! water and energy balance check<a name='775'></font>
<a name='776'>
     CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR'>ERROR</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_SFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ERROR_1"> (parameters,SWDOWN ,FSA    ,FSR    ,FIRA   ,FSH    ,FCEV   , &amp; <font color=#447700>!in<a name='777'></font>
                 FGEV   ,FCTR   ,SSOIL  ,BEG_WB ,CANLIQ ,CANICE , &amp; <font color=#447700>!in<a name='778'></font>
                 SNEQV  ,WA     ,SMC    ,DZSNSO ,PRCP   ,ECAN   , &amp; <font color=#447700>!in<a name='779'></font>
                 ETRAN  ,EDIR   ,RUNSRF ,RUNSUB ,DT     ,NSOIL  , &amp; <font color=#447700>!in<a name='780'></font>
                 NSNOW  ,IST    ,ERRWAT ,ILOC   , JLOC  ,FVEG   , &amp;<a name='781'>
                 SAV    ,SAG    ,FSRV   ,FSRG   ,ZWT    ,PAH    , &amp;<a name='782'>
                 PAHV   ,PAHG   ,PAHB   )   <font color=#447700>!in ( Except ERRWAT, which is out )<a name='783'></font>
<a name='784'>
<font color=#447700>! urban - jref<a name='785'></font>
    QFX = ETRAN + ECAN + EDIR<a name='786'>
    IF ( parameters%urban_flag ) THEN<a name='787'>
       QSFC = QFX/(RHOAIR*CH) + QAIR<a name='788'>
       Q2B = QSFC<a name='789'>
    END IF<a name='790'>
<a name='791'>
    IF(SNOWH &lt;= 1.E-6 .OR. SNEQV &lt;= 1.E-3) THEN<a name='792'>
     SNOWH = 0.0<a name='793'>
     SNEQV = 0.0<a name='794'>
    END IF<a name='795'>
<a name='796'>
    IF(SWDOWN.NE.0.) THEN<a name='797'>
      ALBEDO = FSR / SWDOWN<a name='798'>
    ELSE<a name='799'>
      ALBEDO = -999.9<a name='800'>
    END IF<a name='801'>
    <a name='802'>
<a name='803'>
  END SUBROUTINE NOAHMP_SFLX<a name='804'>
<a name='805'>
<font color=#447700>!== begin atm ======================================================================================<a name='806'></font>
<a name='807'>
<A NAME='ATM'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ATM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='808'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ATM</font> (parameters,SFCPRS  ,SFCTMP   ,Q2      ,                             &amp; <A href='../../call_to/ATM.html' TARGET='index'>1</A><a name='809'>
                  PRCPCONV,PRCPNONC ,PRCPSHCV,PRCPSNOW,PRCPGRPL,PRCPHAIL , &amp;<a name='810'>
                  SOLDN   ,COSZ     ,THAIR   ,QAIR    ,                    &amp; <a name='811'>
                  EAIR    ,RHOAIR   ,QPRECC  ,QPRECL  ,SOLAD   , SOLAI   , &amp;<a name='812'>
		  SWDOWN  ,BDFALL   ,RAIN    ,SNOW    ,FP      , FPICE   ,PRCP )     <a name='813'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='814'></font>
<font color=#447700>! re-process atmospheric forcing<a name='815'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='816'></font>
  IMPLICIT NONE<a name='817'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='818'></font>
<font color=#447700>! inputs<a name='819'></font>
<a name='820'>
  type (noahmp_parameters), intent(in) :: parameters<a name='821'>
  REAL                          , INTENT(IN)  :: SFCPRS <font color=#447700>!pressure (pa)<a name='822'></font>
  REAL                          , INTENT(IN)  :: SFCTMP <font color=#447700>!surface air temperature [k]<a name='823'></font>
  REAL                          , INTENT(IN)  :: Q2     <font color=#447700>!mixing ratio (kg/kg)<a name='824'></font>
  REAL                          , INTENT(IN)  :: PRCPCONV <font color=#447700>! convective precipitation entering  [mm/s]    ! MB/AN : v3.7<a name='825'></font>
  REAL                          , INTENT(IN)  :: PRCPNONC <font color=#447700>! non-convective precipitation entering [mm/s] ! MB/AN : v3.7<a name='826'></font>
  REAL                          , INTENT(IN)  :: PRCPSHCV <font color=#447700>! shallow convective precip entering  [mm/s]   ! MB/AN : v3.7<a name='827'></font>
  REAL                          , INTENT(IN)  :: PRCPSNOW <font color=#447700>! snow entering land model [mm/s]              ! MB/AN : v3.7<a name='828'></font>
  REAL                          , INTENT(IN)  :: PRCPGRPL <font color=#447700>! graupel entering land model [mm/s]           ! MB/AN : v3.7<a name='829'></font>
  REAL                          , INTENT(IN)  :: PRCPHAIL <font color=#447700>! hail entering land model [mm/s]              ! MB/AN : v3.7<a name='830'></font>
  REAL                          , INTENT(IN)  :: SOLDN  <font color=#447700>!downward shortwave radiation (w/m2)<a name='831'></font>
  REAL                          , INTENT(IN)  :: COSZ   <font color=#447700>!cosine solar zenith angle [0-1]<a name='832'></font>
<a name='833'>
<font color=#447700>! outputs<a name='834'></font>
<a name='835'>
  REAL                          , INTENT(OUT) :: THAIR  <font color=#447700>!potential temperature (k)<a name='836'></font>
  REAL                          , INTENT(OUT) :: QAIR   <font color=#447700>!specific humidity (kg/kg) (q2/(1+q2))<a name='837'></font>
  REAL                          , INTENT(OUT) :: EAIR   <font color=#447700>!vapor pressure air (pa)<a name='838'></font>
  REAL                          , INTENT(OUT) :: RHOAIR <font color=#447700>!density air (kg/m3)<a name='839'></font>
  REAL                          , INTENT(OUT) :: QPRECC <font color=#447700>!convective precipitation (mm/s)<a name='840'></font>
  REAL                          , INTENT(OUT) :: QPRECL <font color=#447700>!large-scale precipitation (mm/s)<a name='841'></font>
  REAL, DIMENSION(       1:   2), INTENT(OUT) :: SOLAD  <font color=#447700>!incoming direct solar radiation (w/m2)<a name='842'></font>
  REAL, DIMENSION(       1:   2), INTENT(OUT) :: SOLAI  <font color=#447700>!incoming diffuse solar radiation (w/m2)<a name='843'></font>
  REAL                          , INTENT(OUT) :: SWDOWN <font color=#447700>!downward solar filtered by sun angle [w/m2]<a name='844'></font>
  REAL                          , INTENT(OUT) :: BDFALL  <font color=#447700>!!bulk density of snowfall (kg/m3) AJN<a name='845'></font>
  REAL                          , INTENT(OUT) :: RAIN    <font color=#447700>!rainfall (mm/s) AJN<a name='846'></font>
  REAL                          , INTENT(OUT) :: SNOW    <font color=#447700>!liquid equivalent snowfall (mm/s) AJN<a name='847'></font>
  REAL                          , INTENT(OUT) :: FP      <font color=#447700>!fraction of area receiving precipitation  AJN<a name='848'></font>
  REAL                          , INTENT(OUT) :: FPICE   <font color=#447700>!fraction of ice                AJN<a name='849'></font>
  REAL                          , INTENT(OUT) :: PRCP    <font color=#447700>!total precipitation [mm/s]     ! MB/AN : v3.7<a name='850'></font>
<a name='851'>
<font color=#447700>!locals<a name='852'></font>
<a name='853'>
  REAL                                        :: PAIR   <font color=#447700>!atm bottom level pressure (pa)<a name='854'></font>
  REAL                                        :: PRCP_FROZEN   <font color=#447700>!total frozen precipitation [mm/s] ! MB/AN : v3.7<a name='855'></font>
  REAL, PARAMETER                             :: RHO_GRPL = 500.0  <font color=#447700>! graupel bulk density [kg/m3] ! MB/AN : v3.7<a name='856'></font>
  REAL, PARAMETER                             :: RHO_HAIL = 917.0  <font color=#447700>! hail bulk density [kg/m3]    ! MB/AN : v3.7<a name='857'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='858'></font>
<a name='859'>
<font color=#447700>!jref: seems like PAIR should be P1000mb??<a name='860'></font>
       PAIR   = SFCPRS                   <font color=#447700>! atm bottom level pressure (pa)<a name='861'></font>
       THAIR  = SFCTMP * (SFCPRS/PAIR)**(RAIR/CPAIR) <a name='862'>
<a name='863'>
       QAIR   = Q2                       <font color=#447700>! In WRF, driver converts to specific humidity<a name='864'></font>
<a name='865'>
       EAIR   = QAIR*SFCPRS / (0.622+0.378*QAIR)<a name='866'>
       RHOAIR = (SFCPRS-0.378*EAIR) / (RAIR*SFCTMP)<a name='867'>
<a name='868'>
       IF(COSZ &lt;= 0.) THEN <a name='869'>
          SWDOWN = 0.<a name='870'>
       ELSE<a name='871'>
          SWDOWN = SOLDN<a name='872'>
       END IF <a name='873'>
<a name='874'>
       SOLAD(1) = SWDOWN*0.7*0.5     <font color=#447700>! direct  vis<a name='875'></font>
       SOLAD(2) = SWDOWN*0.7*0.5     <font color=#447700>! direct  nir<a name='876'></font>
       SOLAI(1) = SWDOWN*0.3*0.5     <font color=#447700>! diffuse vis<a name='877'></font>
       SOLAI(2) = SWDOWN*0.3*0.5     <font color=#447700>! diffuse nir<a name='878'></font>
<a name='879'>
       PRCP = PRCPCONV + PRCPNONC + PRCPSHCV<a name='880'>
<a name='881'>
       IF(OPT_SNF == 4) THEN<a name='882'>
         QPRECC = PRCPCONV + PRCPSHCV<a name='883'>
	 QPRECL = PRCPNONC<a name='884'>
       ELSE<a name='885'>
         QPRECC = 0.10 * PRCP          <font color=#447700>! should be from the atmospheric model<a name='886'></font>
         QPRECL = 0.90 * PRCP          <font color=#447700>! should be from the atmospheric model<a name='887'></font>
       END IF<a name='888'>
<a name='889'>
<font color=#447700>! fractional area that receives precipitation (see, Niu et al. 2005)<a name='890'></font>
   <a name='891'>
    FP = 0.0<a name='892'>
    IF(QPRECC + QPRECL &gt; 0.) &amp; <a name='893'>
       FP = (QPRECC + QPRECL) / (10.*QPRECC + QPRECL)<a name='894'>
<a name='895'>
<font color=#447700>! partition precipitation into rain and snow. Moved from CANWAT MB/AN: v3.7<a name='896'></font>
<a name='897'>
<font color=#447700>! Jordan (1991)<a name='898'></font>
<a name='899'>
     IF(OPT_SNF == 1) THEN<a name='900'>
       IF(SFCTMP &gt; TFRZ+2.5)THEN<a name='901'>
           FPICE = 0.<a name='902'>
       ELSE<a name='903'>
         IF(SFCTMP &lt;= TFRZ+0.5)THEN<a name='904'>
           FPICE = 1.0<a name='905'>
         ELSE IF(SFCTMP &lt;= TFRZ+2.)THEN<a name='906'>
           FPICE = 1.-(-54.632 + 0.2*SFCTMP)<a name='907'>
         ELSE<a name='908'>
           FPICE = 0.6<a name='909'>
         ENDIF<a name='910'>
       ENDIF<a name='911'>
     ENDIF<a name='912'>
<a name='913'>
     IF(OPT_SNF == 2) THEN<a name='914'>
       IF(SFCTMP &gt;= TFRZ+2.2) THEN<a name='915'>
           FPICE = 0.<a name='916'>
       ELSE<a name='917'>
           FPICE = 1.0<a name='918'>
       ENDIF<a name='919'>
     ENDIF<a name='920'>
<a name='921'>
     IF(OPT_SNF == 3) THEN<a name='922'>
       IF(SFCTMP &gt;= TFRZ) THEN<a name='923'>
           FPICE = 0.<a name='924'>
       ELSE<a name='925'>
           FPICE = 1.0<a name='926'>
       ENDIF<a name='927'>
     ENDIF<a name='928'>
<a name='929'>
<font color=#447700>! Hedstrom NR and JW Pomeroy (1998), Hydrol. Processes, 12, 1611-1625<a name='930'></font>
<font color=#447700>! fresh snow density<a name='931'></font>
<a name='932'>
     BDFALL = MIN(120.,67.92+51.25*EXP((SFCTMP-TFRZ)/2.59))       <font color=#447700>!MB/AN: change to MIN  <a name='933'></font>
     IF(OPT_SNF == 4) THEN<a name='934'>
        PRCP_FROZEN = PRCPSNOW + PRCPGRPL + PRCPHAIL<a name='935'>
        IF(PRCPNONC &gt; 0. .and. PRCP_FROZEN &gt; 0.) THEN<a name='936'>
	  FPICE = MIN(1.0,PRCP_FROZEN/PRCPNONC)<a name='937'>
	  FPICE = MAX(0.0,FPICE)<a name='938'>
	  BDFALL = BDFALL*(PRCPSNOW/PRCP_FROZEN) + RHO_GRPL*(PRCPGRPL/PRCP_FROZEN) + &amp;<a name='939'>
	             RHO_HAIL*(PRCPHAIL/PRCP_FROZEN)<a name='940'>
	ELSE<a name='941'>
	  FPICE = 0.0<a name='942'>
        ENDIF<a name='943'>
	<a name='944'>
     ENDIF<a name='945'>
<a name='946'>
     RAIN   = PRCP * (1.-FPICE)<a name='947'>
     SNOW   = PRCP * FPICE<a name='948'>
<a name='949'>
<a name='950'>
  END SUBROUTINE ATM<a name='951'>
<a name='952'>
<font color=#447700>!== begin phenology ================================================================================<a name='953'></font>
<a name='954'>
<A NAME='PHENOLOGY'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#PHENOLOGY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='955'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>PHENOLOGY</font> (parameters,VEGTYP ,croptype, SNOWH  , TV     , LAT   , YEARLEN , JULIAN , &amp; <font color=#447700>!in <A href='../../call_to/PHENOLOGY.html' TARGET='index'>1</A><a name='956'></font>
                        LAI    , SAI    , TROOT  , ELAI    , ESAI   , IGS, PGS)<a name='957'>
<a name='958'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='959'></font>
<font color=#447700>! vegetation phenology considering vegeation canopy being buries by snow and evolution in time<a name='960'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='961'></font>
  IMPLICIT NONE<a name='962'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='963'></font>
<font color=#447700>! inputs<a name='964'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='965'>
  INTEGER                , INTENT(IN   ) :: VEGTYP <font color=#447700>!vegetation type <a name='966'></font>
  INTEGER                , INTENT(IN   ) :: CROPTYPE <font color=#447700>!vegetation type <a name='967'></font>
  REAL                   , INTENT(IN   ) :: SNOWH  <font color=#447700>!snow height [m]<a name='968'></font>
  REAL                   , INTENT(IN   ) :: TV     <font color=#447700>!vegetation temperature (k)<a name='969'></font>
  REAL                   , INTENT(IN   ) :: LAT    <font color=#447700>!latitude (radians)<a name='970'></font>
  INTEGER                , INTENT(IN   ) :: YEARLEN<font color=#447700>!Number of days in the particular year<a name='971'></font>
  REAL                   , INTENT(IN   ) :: JULIAN <font color=#447700>!Julian day of year (fractional) ( 0 &lt;= JULIAN &lt; YEARLEN )<a name='972'></font>
  real                   , INTENT(IN   ) :: TROOT  <font color=#447700>!root-zone averaged temperature (k)<a name='973'></font>
  REAL                   , INTENT(INOUT) :: LAI    <font color=#447700>!LAI, unadjusted for burying by snow<a name='974'></font>
  REAL                   , INTENT(INOUT) :: SAI    <font color=#447700>!SAI, unadjusted for burying by snow<a name='975'></font>
<a name='976'>
<font color=#447700>! outputs<a name='977'></font>
  REAL                   , INTENT(OUT  ) :: ELAI   <font color=#447700>!leaf area index, after burying by snow<a name='978'></font>
  REAL                   , INTENT(OUT  ) :: ESAI   <font color=#447700>!stem area index, after burying by snow<a name='979'></font>
  REAL                   , INTENT(OUT  ) :: IGS    <font color=#447700>!growing season index (0=off, 1=on)<a name='980'></font>
  INTEGER                , INTENT(IN   ) :: PGS    <font color=#447700>!plant growing stage<a name='981'></font>
<a name='982'>
<font color=#447700>! locals<a name='983'></font>
<a name='984'>
  REAL                                   :: DB     <font color=#447700>!thickness of canopy buried by snow (m)<a name='985'></font>
  REAL                                   :: FB     <font color=#447700>!fraction of canopy buried by snow<a name='986'></font>
  REAL                                   :: SNOWHC <font color=#447700>!critical snow depth at which short vege<a name='987'></font>
                                                   <font color=#447700>!is fully covered by snow<a name='988'></font>
<a name='989'>
  INTEGER                                :: K       <font color=#447700>!index<a name='990'></font>
  INTEGER                                :: IT1,IT2 <font color=#447700>!interpolation months<a name='991'></font>
  REAL                                   :: DAY     <font color=#447700>!current day of year ( 0 &lt;= DAY &lt; YEARLEN )<a name='992'></font>
  REAL                                   :: WT1,WT2 <font color=#447700>!interpolation weights<a name='993'></font>
  REAL                                   :: T       <font color=#447700>!current month (1.00, ..., 12.00)<a name='994'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='995'></font>
<a name='996'>
  IF ( DVEG == 1 .or. DVEG == 3 .or. DVEG == 4 ) THEN<a name='997'>
<a name='998'>
     IF (LAT &gt;= 0.) THEN<a name='999'>
        <font color=#447700>! Northern Hemisphere<a name='1000'></font>
        DAY = JULIAN<a name='1001'>
     ELSE<a name='1002'>
        <font color=#447700>! Southern Hemisphere.  DAY is shifted by 1/2 year.<a name='1003'></font>
        DAY = MOD ( JULIAN + ( 0.5 * YEARLEN ) , REAL(YEARLEN) )<a name='1004'>
     ENDIF<a name='1005'>
<a name='1006'>
     T = 12. * DAY / REAL(YEARLEN)<a name='1007'>
     IT1 = T + 0.5<a name='1008'>
     IT2 = IT1 + 1<a name='1009'>
     WT1 = (IT1+0.5) - T<a name='1010'>
     WT2 = 1.-WT1<a name='1011'>
     IF (IT1 .LT.  1) IT1 = 12<a name='1012'>
     IF (IT2 .GT. 12) IT2 = 1<a name='1013'>
<a name='1014'>
     LAI = WT1*parameters%LAIM(IT1) + WT2*parameters%LAIM(IT2)<a name='1015'>
     SAI = WT1*parameters%SAIM(IT1) + WT2*parameters%SAIM(IT2)<a name='1016'>
  ENDIF<a name='1017'>
<a name='1018'>
  IF(DVEG == 7 .or. DVEG == 8 .or. DVEG == 9) THEN<a name='1019'>
    SAI = MAX(0.05,0.1 * LAI)  <font color=#447700>! when reading LAI, set SAI to 10% LAI, but not below 0.05 MB: v3.8<a name='1020'></font>
    IF (LAI &lt; 0.05) SAI = 0.0  <font color=#447700>! if LAI below minimum, make sure SAI = 0<a name='1021'></font>
  ENDIF<a name='1022'>
<a name='1023'>
  IF (SAI &lt; 0.05 .and. CROPTYPE == 0) SAI = 0.0                    <font color=#447700>! MB: SAI CHECK, change to 0.05 v3.6<a name='1024'></font>
  IF ((LAI &lt; 0.05 .OR. SAI == 0.0) .and. CROPTYPE == 0) LAI = 0.0  <font color=#447700>! MB: LAI CHECK<a name='1025'></font>
<a name='1026'>
  IF ( ( VEGTYP == parameters%iswater ) .OR. ( VEGTYP == parameters%ISBARREN ) .OR. &amp;<a name='1027'>
       ( VEGTYP == parameters%ISICE   ) .or. ( parameters%urban_flag ) ) THEN<a name='1028'>
     LAI  = 0.<a name='1029'>
     SAI  = 0.<a name='1030'>
  ENDIF<a name='1031'>
<a name='1032'>
<font color=#447700>!buried by snow<a name='1033'></font>
<a name='1034'>
     DB = MIN( MAX(SNOWH - parameters%HVB,0.), parameters%HVT-parameters%HVB )<a name='1035'>
     FB = DB / MAX(1.E-06,parameters%HVT-parameters%HVB)<a name='1036'>
<a name='1037'>
     IF(parameters%HVT&gt; 0. .AND. parameters%HVT &lt;= 1.0) THEN          <font color=#447700>!MB: change to 1.0 and 0.2 to reflect<a name='1038'></font>
       SNOWHC = parameters%HVT*EXP(-SNOWH/0.2)             <font color=#447700>!      changes to HVT in MPTABLE<a name='1039'></font>
       FB     = MIN(SNOWH,SNOWHC)/SNOWHC<a name='1040'>
     ENDIF<a name='1041'>
<a name='1042'>
     ELAI =  LAI*(1.-FB)<a name='1043'>
     ESAI =  SAI*(1.-FB)<a name='1044'>
     IF (ESAI &lt; 0.05 .and. CROPTYPE == 0) ESAI = 0.0                   <font color=#447700>! MB: ESAI CHECK, change to 0.05 v3.6<a name='1045'></font>
     IF ((ELAI &lt; 0.05 .OR. ESAI == 0.0) .and. CROPTYPE == 0) ELAI = 0.0  <font color=#447700>! MB: LAI CHECK<a name='1046'></font>
<a name='1047'>
     IF ((TV .GT. parameters%TMIN .and. CROPTYPE == 0).or.(PGS &gt; 2 .and. PGS &lt; 7 .and. CROPTYPE &gt; 0)) THEN<a name='1048'>
         IGS = 1.<a name='1049'>
     ELSE<a name='1050'>
         IGS = 0.<a name='1051'>
     ENDIF<a name='1052'>
<a name='1053'>
  END SUBROUTINE PHENOLOGY<a name='1054'>
<a name='1055'>
<font color=#447700>!== begin precip_heat ==============================================================================<a name='1056'></font>
<a name='1057'>
<A NAME='PRECIP_HEAT'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#PRECIP_HEAT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1058'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>PRECIP_HEAT</font> (parameters,ILOC   ,JLOC   ,VEGTYP ,DT     ,UU     ,VV     , &amp; <font color=#447700>!in <A href='../../call_to/PRECIP_HEAT.html' TARGET='index'>1</A><a name='1059'></font>
                          ELAI   ,ESAI   ,FVEG   ,IST    ,                 &amp; <font color=#447700>!in<a name='1060'></font>
                          BDFALL ,RAIN   ,SNOW   ,FP     ,                 &amp; <font color=#447700>!in<a name='1061'></font>
                          CANLIQ ,CANICE ,TV     ,SFCTMP ,TG     ,         &amp; <font color=#447700>!in<a name='1062'></font>
                          QINTR  ,QDRIPR ,QTHROR ,QINTS  ,QDRIPS ,QTHROS , &amp; <font color=#447700>!out<a name='1063'></font>
			  PAHV   ,PAHG   ,PAHB   ,QRAIN  ,QSNOW  ,SNOWHIN, &amp; <font color=#447700>!out<a name='1064'></font>
			  FWET   ,CMC                                    )   <font color=#447700>!out<a name='1065'></font>
<a name='1066'>
<font color=#447700>! ------------------------ code history ------------------------------<a name='1067'></font>
<font color=#447700>! Michael Barlage: Oct 2013 - split CANWATER to calculate precip movement for <a name='1068'></font>
<font color=#447700>!                             tracking of advected heat<a name='1069'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='1070'></font>
  IMPLICIT NONE<a name='1071'>
<font color=#447700>! ------------------------ input/output variables --------------------<a name='1072'></font>
<font color=#447700>! input<a name='1073'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='1074'>
  INTEGER,INTENT(IN)  :: ILOC    <font color=#447700>!grid index<a name='1075'></font>
  INTEGER,INTENT(IN)  :: JLOC    <font color=#447700>!grid index<a name='1076'></font>
  INTEGER,INTENT(IN)  :: VEGTYP  <font color=#447700>!vegetation type<a name='1077'></font>
  INTEGER,INTENT(IN)  :: IST     <font color=#447700>!surface type 1-soil; 2-lake<a name='1078'></font>
  REAL,   INTENT(IN)  :: DT      <font color=#447700>!main time step (s)<a name='1079'></font>
  REAL,   INTENT(IN)  :: UU      <font color=#447700>!u-direction wind speed [m/s]<a name='1080'></font>
  REAL,   INTENT(IN)  :: VV      <font color=#447700>!v-direction wind speed [m/s]<a name='1081'></font>
  REAL,   INTENT(IN)  :: ELAI    <font color=#447700>!leaf area index, after burying by snow<a name='1082'></font>
  REAL,   INTENT(IN)  :: ESAI    <font color=#447700>!stem area index, after burying by snow<a name='1083'></font>
  REAL,   INTENT(IN)  :: FVEG    <font color=#447700>!greeness vegetation fraction (-)<a name='1084'></font>
  REAL,   INTENT(IN)  :: BDFALL  <font color=#447700>!bulk density of snowfall (kg/m3)<a name='1085'></font>
  REAL,   INTENT(IN)  :: RAIN    <font color=#447700>!rainfall (mm/s)<a name='1086'></font>
  REAL,   INTENT(IN)  :: SNOW    <font color=#447700>!snowfall (mm/s)<a name='1087'></font>
  REAL,   INTENT(IN)  :: FP      <font color=#447700>!fraction of the gridcell that receives precipitation<a name='1088'></font>
  REAL,   INTENT(IN)  :: TV      <font color=#447700>!vegetation temperature (k)<a name='1089'></font>
  REAL,   INTENT(IN)  :: SFCTMP  <font color=#447700>!model-level temperature (k)<a name='1090'></font>
  REAL,   INTENT(IN)  :: TG      <font color=#447700>!ground temperature (k)<a name='1091'></font>
<a name='1092'>
<font color=#447700>! input &amp; output<a name='1093'></font>
  REAL, INTENT(INOUT) :: CANLIQ  <font color=#447700>!intercepted liquid water (mm)<a name='1094'></font>
  REAL, INTENT(INOUT) :: CANICE  <font color=#447700>!intercepted ice mass (mm)<a name='1095'></font>
<a name='1096'>
<font color=#447700>! output<a name='1097'></font>
  REAL, INTENT(OUT)   :: QINTR   <font color=#447700>!interception rate for rain (mm/s)<a name='1098'></font>
  REAL, INTENT(OUT)   :: QDRIPR  <font color=#447700>!drip rate for rain (mm/s)<a name='1099'></font>
  REAL, INTENT(OUT)   :: QTHROR  <font color=#447700>!throughfall for rain (mm/s)<a name='1100'></font>
  REAL, INTENT(OUT)   :: QINTS   <font color=#447700>!interception (loading) rate for snowfall (mm/s)<a name='1101'></font>
  REAL, INTENT(OUT)   :: QDRIPS  <font color=#447700>!drip (unloading) rate for intercepted snow (mm/s)<a name='1102'></font>
  REAL, INTENT(OUT)   :: QTHROS  <font color=#447700>!throughfall of snowfall (mm/s)<a name='1103'></font>
  REAL, INTENT(OUT)   :: PAHV    <font color=#447700>!precipitation advected heat - vegetation net (W/m2)<a name='1104'></font>
  REAL, INTENT(OUT)   :: PAHG    <font color=#447700>!precipitation advected heat - under canopy net (W/m2)<a name='1105'></font>
  REAL, INTENT(OUT)   :: PAHB    <font color=#447700>!precipitation advected heat - bare ground net (W/m2)<a name='1106'></font>
  REAL, INTENT(OUT)   :: QRAIN   <font color=#447700>!rain at ground srf (mm/s) [+]<a name='1107'></font>
  REAL, INTENT(OUT)   :: QSNOW   <font color=#447700>!snow at ground srf (mm/s) [+]<a name='1108'></font>
  REAL, INTENT(OUT)   :: SNOWHIN <font color=#447700>!snow depth increasing rate (m/s)<a name='1109'></font>
  REAL, INTENT(OUT)   :: FWET    <font color=#447700>!wetted or snowed fraction of the canopy (-)<a name='1110'></font>
  REAL, INTENT(OUT)   :: CMC     <font color=#447700>!intercepted water (mm)<a name='1111'></font>
<font color=#447700>! --------------------------------------------------------------------<a name='1112'></font>
<a name='1113'>
<font color=#447700>! ------------------------ local variables ---------------------------<a name='1114'></font>
  REAL                :: MAXSNO  <font color=#447700>!canopy capacity for snow interception (mm)<a name='1115'></font>
  REAL                :: MAXLIQ  <font color=#447700>!canopy capacity for rain interception (mm)<a name='1116'></font>
  REAL                :: FT      <font color=#447700>!temperature factor for unloading rate<a name='1117'></font>
  REAL                :: FV      <font color=#447700>!wind factor for unloading rate<a name='1118'></font>
  REAL                :: PAH_AC  <font color=#447700>!precipitation advected heat - air to canopy (W/m2)<a name='1119'></font>
  REAL                :: PAH_CG  <font color=#447700>!precipitation advected heat - canopy to ground (W/m2)<a name='1120'></font>
  REAL                :: PAH_AG  <font color=#447700>!precipitation advected heat - air to ground (W/m2)<a name='1121'></font>
  REAL                :: ICEDRIP <font color=#447700>!canice unloading<a name='1122'></font>
<font color=#447700>! --------------------------------------------------------------------<a name='1123'></font>
<font color=#447700>! initialization<a name='1124'></font>
<a name='1125'>
      QINTR   = 0.<a name='1126'>
      QDRIPR  = 0.<a name='1127'>
      QTHROR  = 0.<a name='1128'>
      QINTR   = 0.<a name='1129'>
      QINTS   = 0.<a name='1130'>
      QDRIPS  = 0.<a name='1131'>
      QTHROS  = 0.<a name='1132'>
      PAH_AC  = 0.<a name='1133'>
      PAH_CG  = 0.<a name='1134'>
      PAH_AG  = 0.<a name='1135'>
      PAHV    = 0.<a name='1136'>
      PAHG    = 0.<a name='1137'>
      PAHB    = 0.<a name='1138'>
      QRAIN   = 0.0<a name='1139'>
      QSNOW   = 0.0<a name='1140'>
      SNOWHIN = 0.0<a name='1141'>
      ICEDRIP = 0.0<a name='1142'>
<font color=#447700>!      print*, "precip_heat begin canopy balance:",canliq+canice+(rain+snow)*dt<a name='1143'></font>
<font color=#447700>!      print*,  "precip_heat snow*3600.0:",snow*3600.0<a name='1144'></font>
<font color=#447700>!      print*,  "precip_heat rain*3600.0:",rain*3600.0<a name='1145'></font>
<font color=#447700>!      print*,  "precip_heat canice:",canice<a name='1146'></font>
<font color=#447700>!      print*,  "precip_heat canliq:",canliq<a name='1147'></font>
<a name='1148'>
<font color=#447700>! --------------------------- liquid water ------------------------------<a name='1149'></font>
<font color=#447700>! maximum canopy water<a name='1150'></font>
<a name='1151'>
      MAXLIQ =  parameters%CH2OP * (ELAI+ ESAI)<a name='1152'>
<a name='1153'>
<font color=#447700>! average interception and throughfall<a name='1154'></font>
<a name='1155'>
      IF((ELAI+ ESAI).GT.0.) THEN<a name='1156'>
         QINTR  = FVEG * RAIN * FP  <font color=#447700>! interception capability<a name='1157'></font>
         QINTR  = MIN(QINTR, (MAXLIQ - CANLIQ)/DT * (1.-EXP(-RAIN*DT/MAXLIQ)) )<a name='1158'>
         QINTR  = MAX(QINTR, 0.)<a name='1159'>
         QDRIPR = FVEG * RAIN - QINTR<a name='1160'>
         QTHROR = (1.-FVEG) * RAIN<a name='1161'>
         CANLIQ=MAX(0.,CANLIQ+QINTR*DT)<a name='1162'>
      ELSE<a name='1163'>
         QINTR  = 0.<a name='1164'>
         QDRIPR = 0.<a name='1165'>
         QTHROR = RAIN<a name='1166'>
	 IF(CANLIQ &gt; 0.) THEN             <font color=#447700>! FOR CASE OF CANOPY GETTING BURIED<a name='1167'></font>
	   QDRIPR = QDRIPR + CANLIQ/DT<a name='1168'>
	   CANLIQ = 0.0<a name='1169'>
	 END IF<a name='1170'>
      END IF<a name='1171'>
      <a name='1172'>
<font color=#447700>! heat transported by liquid water<a name='1173'></font>
<a name='1174'>
      PAH_AC = FVEG * RAIN * (CWAT/1000.0) * (SFCTMP - TV)<a name='1175'>
      PAH_CG = QDRIPR * (CWAT/1000.0) * (TV - TG)<a name='1176'>
      PAH_AG = QTHROR * (CWAT/1000.0) * (SFCTMP - TG)<a name='1177'>
<font color=#447700>!      print*, "precip_heat PAH_AC:",PAH_AC<a name='1178'></font>
<font color=#447700>!      print*, "precip_heat PAH_CG:",PAH_CG<a name='1179'></font>
<font color=#447700>!      print*, "precip_heat PAH_AG:",PAH_AG<a name='1180'></font>
<a name='1181'>
<font color=#447700>! --------------------------- canopy ice ------------------------------<a name='1182'></font>
<font color=#447700>! for canopy ice<a name='1183'></font>
<a name='1184'>
      MAXSNO = 6.6*(0.27+46./BDFALL) * (ELAI+ ESAI)<a name='1185'>
<a name='1186'>
      IF((ELAI+ ESAI).GT.0.) THEN<a name='1187'>
         QINTS = FVEG * SNOW * FP<a name='1188'>
         QINTS = MIN(QINTS, (MAXSNO - CANICE)/DT * (1.-EXP(-SNOW*DT/MAXSNO)) )<a name='1189'>
         QINTS = MAX(QINTS, 0.)<a name='1190'>
         FT = MAX(0.0,(TV - 270.15) / 1.87E5)<a name='1191'>
         FV = SQRT(UU*UU + VV*VV) / 1.56E5<a name='1192'>
	 <font color=#447700>! MB: changed below to reflect the rain assumption that all precip gets intercepted <a name='1193'></font>
	 ICEDRIP = MAX(0.,CANICE) * (FV+FT)    <font color=#447700>!MB: removed /DT<a name='1194'></font>
         QDRIPS = (FVEG * SNOW - QINTS) + ICEDRIP<a name='1195'>
         QTHROS = (1.0-FVEG) * SNOW<a name='1196'>
         CANICE= MAX(0.,CANICE + (QINTS - ICEDRIP)*DT)<a name='1197'>
      ELSE<a name='1198'>
         QINTS  = 0.<a name='1199'>
         QDRIPS = 0.<a name='1200'>
         QTHROS = SNOW<a name='1201'>
	 IF(CANICE &gt; 0.) THEN             <font color=#447700>! FOR CASE OF CANOPY GETTING BURIED<a name='1202'></font>
	   QDRIPS = QDRIPS + CANICE/DT<a name='1203'>
	   CANICE = 0.0<a name='1204'>
	 END IF<a name='1205'>
      ENDIF<a name='1206'>
<font color=#447700>!      print*, "precip_heat canopy through:",3600.0*(FVEG * SNOW - QINTS)<a name='1207'></font>
<font color=#447700>!      print*, "precip_heat canopy drip:",3600.0*MAX(0.,CANICE) * (FV+FT)<a name='1208'></font>
<a name='1209'>
<font color=#447700>! wetted fraction of canopy<a name='1210'></font>
<a name='1211'>
      IF(CANICE.GT.0.) THEN<a name='1212'>
           FWET = MAX(0.,CANICE) / MAX(MAXSNO,1.E-06)<a name='1213'>
      ELSE<a name='1214'>
           FWET = MAX(0.,CANLIQ) / MAX(MAXLIQ,1.E-06)<a name='1215'>
      ENDIF<a name='1216'>
      FWET = MIN(FWET, 1.) ** 0.667<a name='1217'>
<a name='1218'>
<font color=#447700>! total canopy water<a name='1219'></font>
<a name='1220'>
      CMC = CANLIQ + CANICE<a name='1221'>
<a name='1222'>
<font color=#447700>! heat transported by snow/ice<a name='1223'></font>
<a name='1224'>
      PAH_AC = PAH_AC +  FVEG * SNOW * (CICE/1000.0) * (SFCTMP - TV)<a name='1225'>
      PAH_CG = PAH_CG + QDRIPS * (CICE/1000.0) * (TV - TG)<a name='1226'>
      PAH_AG = PAH_AG + QTHROS * (CICE/1000.0) * (SFCTMP - TG)<a name='1227'>
      <a name='1228'>
      PAHV = PAH_AC - PAH_CG<a name='1229'>
      PAHG = PAH_CG<a name='1230'>
      PAHB = PAH_AG<a name='1231'>
      <a name='1232'>
      IF (FVEG &gt; 0.0 .AND. FVEG &lt; 1.0) THEN<a name='1233'>
        PAHG = PAHG / FVEG         <font color=#447700>! these will be multiplied by fraction later<a name='1234'></font>
	PAHB = PAHB / (1.0-FVEG)<a name='1235'>
      ELSEIF (FVEG &lt;= 0.0) THEN<a name='1236'>
        PAHB = PAHG + PAHB         <font color=#447700>! for case of canopy getting buried<a name='1237'></font>
        PAHG = 0.0<a name='1238'>
	PAHV = 0.0<a name='1239'>
      ELSEIF (FVEG &gt;= 1.0) THEN<a name='1240'>
	PAHB = 0.0<a name='1241'>
      END IF<a name='1242'>
      <a name='1243'>
      PAHV = MAX(PAHV,-20.0)       <font color=#447700>! Put some artificial limits here for stability<a name='1244'></font>
      PAHV = MIN(PAHV,20.0)<a name='1245'>
      PAHG = MAX(PAHG,-20.0)<a name='1246'>
      PAHG = MIN(PAHG,20.0)<a name='1247'>
      PAHB = MAX(PAHB,-20.0)<a name='1248'>
      PAHB = MIN(PAHB,20.0)<a name='1249'>
      <a name='1250'>
<font color=#447700>!      print*, 'precip_heat sfctmp,tv,tg:',sfctmp,tv,tg<a name='1251'></font>
<font color=#447700>!      print*, 'precip_heat 3600.0*qints+qdrips+qthros:',3600.0*(qints+qdrips+qthros)<a name='1252'></font>
<font color=#447700>!      print*, "precip_heat maxsno:",maxsno<a name='1253'></font>
<font color=#447700>!      print*, "precip_heat PAH_AC:",PAH_AC<a name='1254'></font>
<font color=#447700>!      print*, "precip_heat PAH_CG:",PAH_CG<a name='1255'></font>
<font color=#447700>!      print*, "precip_heat PAH_AG:",PAH_AG<a name='1256'></font>
      <a name='1257'>
<font color=#447700>!      print*, "precip_heat PAHV:",PAHV<a name='1258'></font>
<font color=#447700>!      print*, "precip_heat PAHG:",PAHG<a name='1259'></font>
<font color=#447700>!      print*, "precip_heat PAHB:",PAHB<a name='1260'></font>
<font color=#447700>!      print*, "precip_heat fveg:",fveg<a name='1261'></font>
<font color=#447700>!      print*,  "precip_heat qints*3600.0:",qints*3600.0<a name='1262'></font>
<font color=#447700>!      print*,  "precip_heat qdrips*3600.0:",qdrips*3600.0<a name='1263'></font>
<font color=#447700>!      print*,  "precip_heat qthros*3600.0:",qthros*3600.0<a name='1264'></font>
      <a name='1265'>
<font color=#447700>! rain or snow on the ground<a name='1266'></font>
<a name='1267'>
      QRAIN   = QDRIPR + QTHROR<a name='1268'>
      QSNOW   = QDRIPS + QTHROS<a name='1269'>
      SNOWHIN = QSNOW/BDFALL<a name='1270'>
<a name='1271'>
      IF (IST == 2 .AND. TG &gt; TFRZ) THEN<a name='1272'>
         QSNOW   = 0.<a name='1273'>
         SNOWHIN = 0.<a name='1274'>
      END IF<a name='1275'>
<font color=#447700>!      print*,  "precip_heat qsnow*3600.0:",qsnow*3600.0<a name='1276'></font>
<font color=#447700>!      print*,  "precip_heat qrain*3600.0:",qrain*3600.0<a name='1277'></font>
<font color=#447700>!      print*,  "precip_heat SNOWHIN:",SNOWHIN<a name='1278'></font>
<font color=#447700>!      print*,  "precip_heat canice:",canice<a name='1279'></font>
<font color=#447700>!      print*,  "precip_heat canliq:",canliq<a name='1280'></font>
<font color=#447700>!      print*, "precip_heat end canopy balance:",canliq+canice+(qrain+qsnow)*dt<a name='1281'></font>
      <a name='1282'>
<a name='1283'>
  END SUBROUTINE PRECIP_HEAT<a name='1284'>
<a name='1285'>
<font color=#447700>!== begin error ====================================================================================<a name='1286'></font>
<a name='1287'>
<A NAME='ERROR'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1288'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ERROR</font> (parameters,SWDOWN ,FSA    ,FSR    ,FIRA   ,FSH    ,FCEV   , &amp; <A href='../../call_to/ERROR.html' TARGET='index'>1</A>,<A href='../../call_from/ERROR.html' TARGET='index'>20</A><a name='1289'>
                    FGEV   ,FCTR   ,SSOIL  ,BEG_WB ,CANLIQ ,CANICE , &amp;<a name='1290'>
                    SNEQV  ,WA     ,SMC    ,DZSNSO ,PRCP   ,ECAN   , &amp;<a name='1291'>
                    ETRAN  ,EDIR   ,RUNSRF ,RUNSUB ,DT     ,NSOIL  , &amp;<a name='1292'>
                    NSNOW  ,IST    ,ERRWAT, ILOC   ,JLOC   ,FVEG   , &amp;<a name='1293'>
                    SAV    ,SAG    ,FSRV   ,FSRG   ,ZWT    ,PAH    , &amp;<a name='1294'>
                    PAHV   ,PAHG   ,PAHB   )<a name='1295'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='1296'></font>
<font color=#447700>! check surface energy balance and water balance<a name='1297'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='1298'></font>
  IMPLICIT NONE<a name='1299'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='1300'></font>
<font color=#447700>! inputs<a name='1301'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='1302'>
  INTEGER                        , INTENT(IN) :: NSNOW  <font color=#447700>!maximum no. of snow layers        <a name='1303'></font>
  INTEGER                        , INTENT(IN) :: NSOIL  <font color=#447700>!number of soil layers<a name='1304'></font>
  INTEGER                        , INTENT(IN) :: IST    <font color=#447700>!surface type 1-&gt;soil; 2-&gt;lake<a name='1305'></font>
  INTEGER                        , INTENT(IN) :: ILOC   <font color=#447700>!grid index<a name='1306'></font>
  INTEGER                        , INTENT(IN) :: JLOC   <font color=#447700>!grid index<a name='1307'></font>
  REAL                           , INTENT(IN) :: SWDOWN <font color=#447700>!downward solar filtered by sun angle [w/m2]<a name='1308'></font>
  REAL                           , INTENT(IN) :: FSA    <font color=#447700>!total absorbed solar radiation (w/m2)<a name='1309'></font>
  REAL                           , INTENT(IN) :: FSR    <font color=#447700>!total reflected solar radiation (w/m2)<a name='1310'></font>
  REAL                           , INTENT(IN) :: FIRA   <font color=#447700>!total net longwave rad (w/m2)  [+ to atm]<a name='1311'></font>
  REAL                           , INTENT(IN) :: FSH    <font color=#447700>!total sensible heat (w/m2)     [+ to atm]<a name='1312'></font>
  REAL                           , INTENT(IN) :: FCEV   <font color=#447700>!canopy evaporation heat (w/m2) [+ to atm]<a name='1313'></font>
  REAL                           , INTENT(IN) :: FGEV   <font color=#447700>!ground evaporation heat (w/m2) [+ to atm]<a name='1314'></font>
  REAL                           , INTENT(IN) :: FCTR   <font color=#447700>!transpiration heat flux (w/m2) [+ to atm]<a name='1315'></font>
  REAL                           , INTENT(IN) :: SSOIL  <font color=#447700>!ground heat flux (w/m2)        [+ to soil]<a name='1316'></font>
  REAL                           , INTENT(IN) :: FVEG<a name='1317'>
  REAL                           , INTENT(IN) :: SAV<a name='1318'>
  REAL                           , INTENT(IN) :: SAG<a name='1319'>
  REAL                           , INTENT(IN) :: FSRV<a name='1320'>
  REAL                           , INTENT(IN) :: FSRG<a name='1321'>
  REAL                           , INTENT(IN) :: ZWT<a name='1322'>
<a name='1323'>
  REAL                           , INTENT(IN) :: PRCP   <font color=#447700>!precipitation rate (kg m-2 s-1)<a name='1324'></font>
  REAL                           , INTENT(IN) :: ECAN   <font color=#447700>!evaporation of intercepted water (mm/s)<a name='1325'></font>
  REAL                           , INTENT(IN) :: ETRAN  <font color=#447700>!transpiration rate (mm/s)<a name='1326'></font>
  REAL                           , INTENT(IN) :: EDIR   <font color=#447700>!soil surface evaporation rate[mm/s]<a name='1327'></font>
  REAL                           , INTENT(IN) :: RUNSRF <font color=#447700>!surface runoff [mm/s] <a name='1328'></font>
  REAL                           , INTENT(IN) :: RUNSUB <font color=#447700>!baseflow (saturation excess) [mm/s]<a name='1329'></font>
  REAL                           , INTENT(IN) :: CANLIQ <font color=#447700>!intercepted liquid water (mm)<a name='1330'></font>
  REAL                           , INTENT(IN) :: CANICE <font color=#447700>!intercepted ice mass (mm)<a name='1331'></font>
  REAL                           , INTENT(IN) :: SNEQV  <font color=#447700>!snow water eqv. [mm]<a name='1332'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN) :: SMC    <font color=#447700>!soil moisture (ice + liq.) [m3/m3]<a name='1333'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: DZSNSO <font color=#447700>!snow/soil layer thickness [m]<a name='1334'></font>
  REAL                           , INTENT(IN) :: WA     <font color=#447700>!water storage in aquifer [mm]<a name='1335'></font>
  REAL                           , INTENT(IN) :: DT     <font color=#447700>!time step [sec]<a name='1336'></font>
  REAL                           , INTENT(IN) :: BEG_WB <font color=#447700>!water storage at begin of a timesetp [mm]<a name='1337'></font>
  REAL                           , INTENT(OUT) :: ERRWAT <font color=#447700>!error in water balance [mm/timestep]<a name='1338'></font>
  REAL, INTENT(IN)   :: PAH     <font color=#447700>!precipitation advected heat - total (W/m2)<a name='1339'></font>
  REAL, INTENT(IN)   :: PAHV    <font color=#447700>!precipitation advected heat - total (W/m2)<a name='1340'></font>
  REAL, INTENT(IN)   :: PAHG    <font color=#447700>!precipitation advected heat - total (W/m2)<a name='1341'></font>
  REAL, INTENT(IN)   :: PAHB    <font color=#447700>!precipitation advected heat - total (W/m2)<a name='1342'></font>
<a name='1343'>
  INTEGER                                     :: IZ     <font color=#447700>!do-loop index<a name='1344'></font>
  REAL                                        :: END_WB <font color=#447700>!water storage at end of a timestep [mm]<a name='1345'></font>
  <font color=#447700>!KWM REAL                                        :: ERRWAT !error in water balance [mm/timestep]<a name='1346'></font>
  REAL                                        :: ERRENG <font color=#447700>!error in surface energy balance [w/m2]<a name='1347'></font>
  REAL                                        :: ERRSW  <font color=#447700>!error in shortwave radiation balance [w/m2]<a name='1348'></font>
  REAL                                        :: FSRVG<a name='1349'>
  CHARACTER(len=256)                          :: message<a name='1350'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='1351'></font>
<font color=#447700>!jref:start<a name='1352'></font>
   ERRSW   = SWDOWN - (FSA + FSR)<a name='1353'>
<font color=#447700>!   ERRSW   = SWDOWN - (SAV+SAG + FSRV+FSRG)<a name='1354'></font>
<font color=#447700>!   WRITE(*,*) "ERRSW =",ERRSW<a name='1355'></font>
   IF (ABS(ERRSW) &gt; 0.01) THEN            <font color=#447700>! w/m2<a name='1356'></font>
   WRITE(*,*) "VEGETATION<font color=#447700>!"<a name='1357'></font>
   WRITE(*,*) "SWDOWN*FVEG =",SWDOWN*FVEG<a name='1358'>
   WRITE(*,*) "FVEG*(SAV+SAG) =",FVEG*SAV + SAG<a name='1359'>
   WRITE(*,*) "FVEG*(FSRV +FSRG)=",FVEG*FSRV + FSRG<a name='1360'>
   WRITE(*,*) "GROUND<font color=#447700>!"<a name='1361'></font>
   WRITE(*,*) "(1-.FVEG)*SWDOWN =",(1.-FVEG)*SWDOWN<a name='1362'>
   WRITE(*,*) "(1.-FVEG)*SAG =",(1.-FVEG)*SAG<a name='1363'>
   WRITE(*,*) "(1.-FVEG)*FSRG=",(1.-FVEG)*FSRG<a name='1364'>
   WRITE(*,*) "FSRV   =",FSRV<a name='1365'>
   WRITE(*,*) "FSRG   =",FSRG<a name='1366'>
   WRITE(*,*) "FSR    =",FSR<a name='1367'>
   WRITE(*,*) "SAV    =",SAV<a name='1368'>
   WRITE(*,*) "SAG    =",SAG<a name='1369'>
   WRITE(*,*) "FSA    =",FSA<a name='1370'>
<font color=#447700>!jref:end   <a name='1371'></font>
      WRITE(message,*) 'ERRSW =',ERRSW<a name='1372'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_957">(trim(message))<a name='1373'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1186">("Stop in Noah-MP")<a name='1374'>
   END IF<a name='1375'>
<a name='1376'>
   ERRENG = SAV+SAG-(FIRA+FSH+FCEV+FGEV+FCTR+SSOIL) +PAH<a name='1377'>
<font color=#447700>!   ERRENG = FVEG*SAV+SAG-(FIRA+FSH+FCEV+FGEV+FCTR+SSOIL)<a name='1378'></font>
<font color=#447700>!   WRITE(*,*) "ERRENG =",ERRENG<a name='1379'></font>
   IF(ABS(ERRENG) &gt; 0.01) THEN<a name='1380'>
      write(message,*) 'ERRENG =',ERRENG,' at i,j: ',ILOC,JLOC<a name='1381'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_958">(trim(message))<a name='1382'>
      WRITE(message,'(a17,F10.4)') "Net solar:       ",FSA<a name='1383'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_959">(trim(message))<a name='1384'>
      WRITE(message,'(a17,F10.4)') "Net longwave:    ",FIRA<a name='1385'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_960">(trim(message))<a name='1386'>
      WRITE(message,'(a17,F10.4)') "Total sensible:  ",FSH<a name='1387'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_961">(trim(message))<a name='1388'>
      WRITE(message,'(a17,F10.4)') "Canopy evap:     ",FCEV<a name='1389'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_962">(trim(message))<a name='1390'>
      WRITE(message,'(a17,F10.4)') "Ground evap:     ",FGEV<a name='1391'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_963">(trim(message))<a name='1392'>
      WRITE(message,'(a17,F10.4)') "Transpiration:   ",FCTR<a name='1393'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_964">(trim(message))<a name='1394'>
      WRITE(message,'(a17,F10.4)') "Total ground:    ",SSOIL<a name='1395'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_965">(trim(message))<a name='1396'>
      WRITE(message,'(a17,4F10.4)') "Precip advected: ",PAH,PAHV,PAHG,PAHB<a name='1397'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_966">(trim(message))<a name='1398'>
      WRITE(message,'(a17,F10.4)') "Precip: ",PRCP<a name='1399'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_967">(trim(message))<a name='1400'>
      WRITE(message,'(a17,F10.4)') "Veg fraction: ",FVEG<a name='1401'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_968">(trim(message))<a name='1402'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1187">("Energy budget problem in NOAHMP LSM")<a name='1403'>
   END IF<a name='1404'>
<a name='1405'>
   IF (IST == 1) THEN                                       <font color=#447700>!soil<a name='1406'></font>
        END_WB = CANLIQ + CANICE + SNEQV + WA<a name='1407'>
        DO IZ = 1,NSOIL<a name='1408'>
          END_WB = END_WB + SMC(IZ) * DZSNSO(IZ) * 1000.<a name='1409'>
        END DO<a name='1410'>
        ERRWAT = END_WB-BEG_WB-(PRCP-ECAN-ETRAN-EDIR-RUNSRF-RUNSUB)*DT<a name='1411'>
<a name='1412'>
#ifndef WRF_HYDRO<a name='1413'>
        IF(ABS(ERRWAT) &gt; 0.1) THEN<a name='1414'>
           if (ERRWAT &gt; 0) then<a name='1415'>
              call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_969"> ('The model is gaining water (ERRWAT is positive)')<a name='1416'>
           else<a name='1417'>
              call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_970">('The model is losing water (ERRWAT is negative)')<a name='1418'>
           endif<a name='1419'>
           write(message, *) 'ERRWAT =',ERRWAT, "kg m{-2} timestep{-1}"<a name='1420'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_971">(trim(message))<a name='1421'>
           WRITE(message, &amp;<a name='1422'>
           '("    I      J     END_WB     BEG_WB       PRCP       ECAN       EDIR      ETRAN      RUNSRF     RUNSUB")')<a name='1423'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_972">(trim(message))<a name='1424'>
           WRITE(message,'(i6,1x,i6,1x,2f15.3,9f11.5)')ILOC,JLOC,END_WB,BEG_WB,PRCP*DT,ECAN*DT,&amp;<a name='1425'>
                EDIR*DT,ETRAN*DT,RUNSRF*DT,RUNSUB*DT,ZWT<a name='1426'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_973">(trim(message))<a name='1427'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ERROR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1188">("Water budget problem in NOAHMP LSM")<a name='1428'>
        END IF<a name='1429'>
#endif<a name='1430'>
   ELSE                 <font color=#447700>!KWM<a name='1431'></font>
      ERRWAT = 0.0      <font color=#447700>!KWM<a name='1432'></font>
   ENDIF<a name='1433'>
<a name='1434'>
 END SUBROUTINE ERROR<a name='1435'>
<a name='1436'>
<font color=#447700>!== begin energy ===================================================================================<a name='1437'></font>
<a name='1438'>
<A NAME='ENERGY'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ENERGY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1439'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ENERGY</font> (parameters,ICE    ,VEGTYP ,IST    ,NSNOW  ,NSOIL  , &amp; <font color=#447700>!in <A href='../../call_to/ENERGY.html' TARGET='index'>1</A>,<A href='../../call_from/ENERGY.html' TARGET='index'>7</A><a name='1440'></font>
                     ISNOW  ,DT     ,RHOAIR ,SFCPRS ,QAIR   , &amp; <font color=#447700>!in<a name='1441'></font>
                     SFCTMP ,THAIR  ,LWDN   ,UU     ,VV     ,ZREF   , &amp; <font color=#447700>!in<a name='1442'></font>
                     CO2AIR ,O2AIR  ,SOLAD  ,SOLAI  ,COSZ   ,IGS    , &amp; <font color=#447700>!in<a name='1443'></font>
                     EAIR   ,TBOT   ,ZSNSO  ,ZSOIL  , &amp; <font color=#447700>!in<a name='1444'></font>
                     ELAI   ,ESAI   ,FWET   ,FOLN   ,         &amp; <font color=#447700>!in<a name='1445'></font>
                     FVEG   ,PAHV   ,PAHG   ,PAHB   ,                 &amp; <font color=#447700>!in<a name='1446'></font>
                     QSNOW  ,DZSNSO ,LAT    ,CANLIQ ,CANICE ,ILOC   , JLOC, &amp; <font color=#447700>!in<a name='1447'></font>
		     Z0WRF  ,                                         &amp;<a name='1448'>
                     IMELT  ,SNICEV ,SNLIQV ,EPORE  ,T2M    ,FSNO   , &amp; <font color=#447700>!out<a name='1449'></font>
                     SAV    ,SAG    ,QMELT  ,FSA    ,FSR    ,TAUX   , &amp; <font color=#447700>!out<a name='1450'></font>
                     TAUY   ,FIRA   ,FSH    ,FCEV   ,FGEV   ,FCTR   , &amp; <font color=#447700>!out<a name='1451'></font>
                     TRAD   ,PSN    ,APAR   ,SSOIL  ,BTRANI ,BTRAN  , &amp; <font color=#447700>!out<a name='1452'></font>
                     PONDING,TS     ,LATHEAV , LATHEAG , frozen_canopy,frozen_ground,                       &amp; <font color=#447700>!out<a name='1453'></font>
                     TV     ,TG     ,STC    ,SNOWH  ,EAH    ,TAH    , &amp; <font color=#447700>!inout<a name='1454'></font>
                     SNEQVO ,SNEQV  ,SH2O   ,SMC    ,SNICE  ,SNLIQ  , &amp; <font color=#447700>!inout<a name='1455'></font>
                     ALBOLD ,CM     ,CH     ,DX     ,DZ8W   ,Q2     , &amp;   <font color=#447700>!inout<a name='1456'></font>
                     TAUSS  ,                                         &amp; <font color=#447700>!inout<a name='1457'></font>
<font color=#447700>!jref:start<a name='1458'></font>
                     QC     ,QSFC   ,PSFC   , &amp; <font color=#447700>!in <a name='1459'></font>
                     T2MV   ,T2MB   ,FSRV   , &amp;<a name='1460'>
                     FSRG   ,RSSUN  ,RSSHA  ,BGAP   ,WGAP,TGV,TGB,&amp;<a name='1461'>
                     Q1     ,Q2V    ,Q2B    ,Q2E    ,CHV  ,CHB, EMISSI,PAH  ,&amp;<a name='1462'>
		     SHG,SHC,SHB,EVG,EVB,GHV,GHB,IRG,IRC,IRB,TR,EVC,CHLEAF,CHUC,CHV2,CHB2 )   <font color=#447700>!out <a name='1463'></font>
<font color=#447700>!jref:end                            <a name='1464'></font>
<a name='1465'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='1466'></font>
<font color=#447700>! we use different approaches to deal with subgrid features of radiation transfer and turbulent<a name='1467'></font>
<font color=#447700>! transfer. We use 'tile' approach to compute turbulent fluxes, while we use modified two-<a name='1468'></font>
<font color=#447700>! stream to compute radiation transfer. Tile approach, assemblying vegetation canopies together,<a name='1469'></font>
<font color=#447700>! may expose too much ground surfaces (either covered by snow or grass) to solar radiation. The<a name='1470'></font>
<font color=#447700>! modified two-stream assumes vegetation covers fully the gridcell but with gaps between tree<a name='1471'></font>
<font color=#447700>! crowns.<a name='1472'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='1473'></font>
<font color=#447700>! turbulence transfer : 'tile' approach to compute energy fluxes in vegetated fraction and<a name='1474'></font>
<font color=#447700>!                         bare fraction separately and then sum them up weighted by fraction<a name='1475'></font>
<font color=#447700>!                     --------------------------------------<a name='1476'></font>
<font color=#447700>!                    / O  O  O  O  O  O  O  O  /          / <a name='1477'></font>
<font color=#447700>!                   /  |  |  |  |  |  |  |  | /          /<a name='1478'></font>
<font color=#447700>!                  / O  O  O  O  O  O  O  O  /          /<a name='1479'></font>
<font color=#447700>!                 /  |  |  |tile1|  |  |  | /  tile2   /<a name='1480'></font>
<font color=#447700>!                / O  O  O  O  O  O  O  O  /  bare    /<a name='1481'></font>
<font color=#447700>!               /  |  |  | vegetated |  | /          /<a name='1482'></font>
<font color=#447700>!              / O  O  O  O  O  O  O  O  /          /<a name='1483'></font>
<font color=#447700>!             /  |  |  |  |  |  |  |  | /          /<a name='1484'></font>
<font color=#447700>!            --------------------------------------<a name='1485'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='1486'></font>
<font color=#447700>! radiation transfer : modified two-stream (Yang and Friedl, 2003, JGR; Niu ang Yang, 2004, JGR)<a name='1487'></font>
<font color=#447700>!                     --------------------------------------  two-stream treats leaves as<a name='1488'></font>
<font color=#447700>!                    /   O   O   O   O   O   O   O   O    /  cloud over the entire grid-cell,<a name='1489'></font>
<font color=#447700>!                   /    |   |   |   |   |   |   |   |   / while the modified two-stream <a name='1490'></font>
<font color=#447700>!                  /   O   O   O   O   O   O   O   O    / aggregates cloudy leaves into  <a name='1491'></font>
<font color=#447700>!                 /    |   |   |   |   |   |   |   |   / tree crowns with gaps (as shown in<a name='1492'></font>
<font color=#447700>!                /   O   O   O   O   O   O   O   O    / the left figure). We assume these<a name='1493'></font>
<font color=#447700>!               /    |   |   |   |   |   |   |   |   / tree crowns are evenly distributed<a name='1494'></font>
<font color=#447700>!              /   O   O   O   O   O   O   O   O    / within the gridcell with 100% veg<a name='1495'></font>
<font color=#447700>!             /    |   |   |   |   |   |   |   |   / fraction, but with gaps. The 'tile'<a name='1496'></font>
<font color=#447700>!            -------------------------------------- approach overlaps too much shadows.<a name='1497'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='1498'></font>
  IMPLICIT NONE<a name='1499'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='1500'></font>
<font color=#447700>! inputs<a name='1501'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='1502'>
  integer                           , INTENT(IN)    :: ILOC<a name='1503'>
  integer                           , INTENT(IN)    :: JLOC<a name='1504'>
  INTEGER                           , INTENT(IN)    :: ICE    <font color=#447700>!ice (ice = 1)<a name='1505'></font>
  INTEGER                           , INTENT(IN)    :: VEGTYP <font color=#447700>!vegetation physiology type<a name='1506'></font>
  INTEGER                           , INTENT(IN)    :: IST    <font color=#447700>!surface type: 1-&gt;soil; 2-&gt;lake<a name='1507'></font>
  INTEGER                           , INTENT(IN)    :: NSNOW  <font color=#447700>!maximum no. of snow layers        <a name='1508'></font>
  INTEGER                           , INTENT(IN)    :: NSOIL  <font color=#447700>!number of soil layers<a name='1509'></font>
  INTEGER                           , INTENT(IN)    :: ISNOW  <font color=#447700>!actual no. of snow layers<a name='1510'></font>
  REAL                              , INTENT(IN)    :: DT     <font color=#447700>!time step [sec]<a name='1511'></font>
  REAL                              , INTENT(IN)    :: QSNOW  <font color=#447700>!snowfall on the ground (mm/s)<a name='1512'></font>
  REAL                              , INTENT(IN)    :: RHOAIR <font color=#447700>!density air (kg/m3)<a name='1513'></font>
  REAL                              , INTENT(IN)    :: EAIR   <font color=#447700>!vapor pressure air (pa)<a name='1514'></font>
  REAL                              , INTENT(IN)    :: SFCPRS <font color=#447700>!pressure (pa)<a name='1515'></font>
  REAL                              , INTENT(IN)    :: QAIR   <font color=#447700>!specific humidity (kg/kg)<a name='1516'></font>
  REAL                              , INTENT(IN)    :: SFCTMP <font color=#447700>!air temperature (k)<a name='1517'></font>
  REAL                              , INTENT(IN)    :: THAIR  <font color=#447700>!potential temperature (k)<a name='1518'></font>
  REAL                              , INTENT(IN)    :: LWDN   <font color=#447700>!downward longwave radiation (w/m2)<a name='1519'></font>
  REAL                              , INTENT(IN)    :: UU     <font color=#447700>!wind speed in e-w dir (m/s)<a name='1520'></font>
  REAL                              , INTENT(IN)    :: VV     <font color=#447700>!wind speed in n-s dir (m/s)<a name='1521'></font>
  REAL   , DIMENSION(       1:    2), INTENT(IN)    :: SOLAD  <font color=#447700>!incoming direct solar rad. (w/m2)<a name='1522'></font>
  REAL   , DIMENSION(       1:    2), INTENT(IN)    :: SOLAI  <font color=#447700>!incoming diffuse solar rad. (w/m2)<a name='1523'></font>
  REAL                              , INTENT(IN)    :: COSZ   <font color=#447700>!cosine solar zenith angle (0-1)<a name='1524'></font>
  REAL                              , INTENT(IN)    :: ELAI   <font color=#447700>!LAI adjusted for burying by snow<a name='1525'></font>
  REAL                              , INTENT(IN)    :: ESAI   <font color=#447700>!LAI adjusted for burying by snow<a name='1526'></font>
  REAL                              , INTENT(IN)    :: FWET   <font color=#447700>!fraction of canopy that is wet [-]<a name='1527'></font>
  REAL                              , INTENT(IN)    :: FVEG   <font color=#447700>!greeness vegetation fraction (-)<a name='1528'></font>
  REAL                              , INTENT(IN)    :: LAT    <font color=#447700>!latitude (radians)<a name='1529'></font>
  REAL                              , INTENT(IN)    :: CANLIQ <font color=#447700>!canopy-intercepted liquid water (mm)<a name='1530'></font>
  REAL                              , INTENT(IN)    :: CANICE <font color=#447700>!canopy-intercepted ice mass (mm)<a name='1531'></font>
  REAL                              , INTENT(IN)    :: FOLN   <font color=#447700>!foliage nitrogen (%)<a name='1532'></font>
  REAL                              , INTENT(IN)    :: CO2AIR <font color=#447700>!atmospheric co2 concentration (pa)<a name='1533'></font>
  REAL                              , INTENT(IN)    :: O2AIR  <font color=#447700>!atmospheric o2 concentration (pa)<a name='1534'></font>
  REAL                              , INTENT(IN)    :: IGS    <font color=#447700>!growing season index (0=off, 1=on)<a name='1535'></font>
<a name='1536'>
  REAL                              , INTENT(IN)    :: ZREF   <font color=#447700>!reference height (m)<a name='1537'></font>
  REAL                              , INTENT(IN)    :: TBOT   <font color=#447700>!bottom condition for soil temp. (k) <a name='1538'></font>
  REAL   , DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)    :: ZSNSO  <font color=#447700>!layer-bottom depth from snow surf [m]<a name='1539'></font>
  REAL   , DIMENSION(       1:NSOIL), INTENT(IN)    :: ZSOIL  <font color=#447700>!layer-bottom depth from soil surf [m]<a name='1540'></font>
  REAL   , DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)    :: DZSNSO <font color=#447700>!depth of snow &amp; soil layer-bottom [m]<a name='1541'></font>
  REAL, INTENT(IN)   :: PAHV    <font color=#447700>!precipitation advected heat - vegetation net (W/m2)<a name='1542'></font>
  REAL, INTENT(IN)   :: PAHG    <font color=#447700>!precipitation advected heat - under canopy net (W/m2)<a name='1543'></font>
  REAL, INTENT(IN)   :: PAHB    <font color=#447700>!precipitation advected heat - bare ground net (W/m2)<a name='1544'></font>
<a name='1545'>
<font color=#447700>!jref:start; in <a name='1546'></font>
  REAL                              , INTENT(IN)    :: QC     <font color=#447700>!cloud water mixing ratio<a name='1547'></font>
  REAL                              , INTENT(INOUT) :: QSFC   <font color=#447700>!mixing ratio at lowest model layer<a name='1548'></font>
  REAL                              , INTENT(IN)    :: PSFC   <font color=#447700>!pressure at lowest model layer<a name='1549'></font>
  REAL                              , INTENT(IN)    :: DX     <font color=#447700>!horisontal resolution<a name='1550'></font>
  REAL                              , INTENT(IN)    :: DZ8W   <font color=#447700>!thickness of lowest layer<a name='1551'></font>
  REAL                              , INTENT(IN)    :: Q2     <font color=#447700>!mixing ratio (kg/kg)<a name='1552'></font>
<font color=#447700>!jref:end<a name='1553'></font>
<a name='1554'>
<font color=#447700>! outputs<a name='1555'></font>
  REAL                              , INTENT(OUT)   :: Z0WRF  <font color=#447700>!combined z0 sent to coupled model<a name='1556'></font>
  INTEGER, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT)   :: IMELT  <font color=#447700>!phase change index [1-melt; 2-freeze]<a name='1557'></font>
  REAL   , DIMENSION(-NSNOW+1:    0), INTENT(OUT)   :: SNICEV <font color=#447700>!partial volume ice [m3/m3]<a name='1558'></font>
  REAL   , DIMENSION(-NSNOW+1:    0), INTENT(OUT)   :: SNLIQV <font color=#447700>!partial volume liq. water [m3/m3]<a name='1559'></font>
  REAL   , DIMENSION(-NSNOW+1:    0), INTENT(OUT)   :: EPORE  <font color=#447700>!effective porosity [m3/m3]<a name='1560'></font>
  REAL                              , INTENT(OUT)   :: FSNO   <font color=#447700>!snow cover fraction (-)<a name='1561'></font>
  REAL                              , INTENT(OUT)   :: QMELT  <font color=#447700>!snowmelt [mm/s]<a name='1562'></font>
  REAL                              , INTENT(OUT)   :: PONDING<font color=#447700>!pounding at ground [mm]<a name='1563'></font>
  REAL                              , INTENT(OUT)   :: SAV    <font color=#447700>!solar rad. absorbed by veg. (w/m2)<a name='1564'></font>
  REAL                              , INTENT(OUT)   :: SAG    <font color=#447700>!solar rad. absorbed by ground (w/m2)<a name='1565'></font>
  REAL                              , INTENT(OUT)   :: FSA    <font color=#447700>!tot. absorbed solar radiation (w/m2)<a name='1566'></font>
  REAL                              , INTENT(OUT)   :: FSR    <font color=#447700>!tot. reflected solar radiation (w/m2)<a name='1567'></font>
  REAL                              , INTENT(OUT)   :: TAUX   <font color=#447700>!wind stress: e-w (n/m2)<a name='1568'></font>
  REAL                              , INTENT(OUT)   :: TAUY   <font color=#447700>!wind stress: n-s (n/m2)<a name='1569'></font>
  REAL                              , INTENT(OUT)   :: FIRA   <font color=#447700>!total net LW. rad (w/m2)   [+ to atm]<a name='1570'></font>
  REAL                              , INTENT(OUT)   :: FSH    <font color=#447700>!total sensible heat (w/m2) [+ to atm]<a name='1571'></font>
  REAL                              , INTENT(OUT)   :: FCEV   <font color=#447700>!canopy evaporation (w/m2)  [+ to atm]<a name='1572'></font>
  REAL                              , INTENT(OUT)   :: FGEV   <font color=#447700>!ground evaporation (w/m2)  [+ to atm]<a name='1573'></font>
  REAL                              , INTENT(OUT)   :: FCTR   <font color=#447700>!transpiration (w/m2)       [+ to atm]<a name='1574'></font>
  REAL                              , INTENT(OUT)   :: TRAD   <font color=#447700>!radiative temperature (k)<a name='1575'></font>
  REAL                              , INTENT(OUT)   :: T2M    <font color=#447700>!2 m height air temperature (k)<a name='1576'></font>
  REAL                              , INTENT(OUT)   :: PSN    <font color=#447700>!total photosyn. (umolco2/m2/s) [+]<a name='1577'></font>
  REAL                              , INTENT(OUT)   :: APAR   <font color=#447700>!total photosyn. active energy (w/m2)<a name='1578'></font>
  REAL                              , INTENT(OUT)   :: SSOIL  <font color=#447700>!ground heat flux (w/m2)   [+ to soil]<a name='1579'></font>
  REAL   , DIMENSION(       1:NSOIL), INTENT(OUT)   :: BTRANI <font color=#447700>!soil water transpiration factor (0-1)<a name='1580'></font>
  REAL                              , INTENT(OUT)   :: BTRAN  <font color=#447700>!soil water transpiration factor (0-1)<a name='1581'></font>
<font color=#447700>!  REAL                              , INTENT(OUT)   :: LATHEA !latent heat vap./sublimation (j/kg)<a name='1582'></font>
  REAL                              , INTENT(OUT)   :: LATHEAV <font color=#447700>!latent heat vap./sublimation (j/kg)<a name='1583'></font>
  REAL                              , INTENT(OUT)   :: LATHEAG <font color=#447700>!latent heat vap./sublimation (j/kg)<a name='1584'></font>
  LOGICAL                           , INTENT(OUT)   :: FROZEN_GROUND <font color=#447700>! used to define latent heat pathway<a name='1585'></font>
  LOGICAL                           , INTENT(OUT)   :: FROZEN_CANOPY <font color=#447700>! used to define latent heat pathway<a name='1586'></font>
<a name='1587'>
<font color=#447700>!jref:start  <a name='1588'></font>
  REAL                              , INTENT(OUT)   :: FSRV    <font color=#447700>!veg. reflected solar radiation (w/m2)<a name='1589'></font>
  REAL                              , INTENT(OUT)   :: FSRG    <font color=#447700>!ground reflected solar radiation (w/m2)<a name='1590'></font>
  REAL, INTENT(OUT) :: RSSUN        <font color=#447700>!sunlit leaf stomatal resistance (s/m)<a name='1591'></font>
  REAL, INTENT(OUT) :: RSSHA        <font color=#447700>!shaded leaf stomatal resistance (s/m)<a name='1592'></font>
<font color=#447700>!jref:end - out for debug  <a name='1593'></font>
<a name='1594'>
<font color=#447700>!jref:start; output<a name='1595'></font>
  REAL                              , INTENT(OUT)   :: T2MV   <font color=#447700>!2-m air temperature over vegetated part [k]<a name='1596'></font>
  REAL                              , INTENT(OUT)   :: T2MB   <font color=#447700>!2-m air temperature over bare ground part [k]<a name='1597'></font>
  REAL                              , INTENT(OUT)   :: BGAP<a name='1598'>
  REAL                              , INTENT(OUT)   :: WGAP<a name='1599'>
<font color=#447700>!jref:end<a name='1600'></font>
<a name='1601'>
<font color=#447700>! input &amp; output<a name='1602'></font>
  REAL                              , INTENT(INOUT) :: TS     <font color=#447700>!surface temperature (k)<a name='1603'></font>
  REAL                              , INTENT(INOUT) :: TV     <font color=#447700>!vegetation temperature (k)<a name='1604'></font>
  REAL                              , INTENT(INOUT) :: TG     <font color=#447700>!ground temperature (k)<a name='1605'></font>
  REAL   , DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC    <font color=#447700>!snow/soil temperature [k]<a name='1606'></font>
  REAL                              , INTENT(INOUT) :: SNOWH  <font color=#447700>!snow height [m]<a name='1607'></font>
  REAL                              , INTENT(INOUT) :: SNEQV  <font color=#447700>!snow mass (mm)<a name='1608'></font>
  REAL                              , INTENT(INOUT) :: SNEQVO <font color=#447700>!snow mass at last time step (mm)<a name='1609'></font>
  REAL   , DIMENSION(       1:NSOIL), INTENT(INOUT) :: SH2O   <font color=#447700>!liquid soil moisture [m3/m3]<a name='1610'></font>
  REAL   , DIMENSION(       1:NSOIL), INTENT(INOUT) :: SMC    <font color=#447700>!soil moisture (ice + liq.) [m3/m3]<a name='1611'></font>
  REAL   , DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNICE  <font color=#447700>!snow ice mass (kg/m2)<a name='1612'></font>
  REAL   , DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNLIQ  <font color=#447700>!snow liq mass (kg/m2)<a name='1613'></font>
  REAL                              , INTENT(INOUT) :: EAH    <font color=#447700>!canopy air vapor pressure (pa)<a name='1614'></font>
  REAL                              , INTENT(INOUT) :: TAH    <font color=#447700>!canopy air temperature (k)<a name='1615'></font>
  REAL                              , INTENT(INOUT) :: ALBOLD <font color=#447700>!snow albedo at last time step(CLASS type)<a name='1616'></font>
  REAL                              , INTENT(INOUT) :: TAUSS  <font color=#447700>!non-dimensional snow age<a name='1617'></font>
  REAL                              , INTENT(INOUT) :: CM     <font color=#447700>!momentum drag coefficient<a name='1618'></font>
  REAL                              , INTENT(INOUT) :: CH     <font color=#447700>!sensible heat exchange coefficient<a name='1619'></font>
  REAL                              , INTENT(INOUT) :: Q1<a name='1620'>
<font color=#447700>!  REAL                                              :: Q2E<a name='1621'></font>
  REAL,                               INTENT(OUT)   :: EMISSI<a name='1622'>
  REAL,                               INTENT(OUT)   :: PAH    <font color=#447700>!precipitation advected heat - total (W/m2)<a name='1623'></font>
<a name='1624'>
<font color=#447700>! local<a name='1625'></font>
  INTEGER                                           :: IZ     <font color=#447700>!do-loop index<a name='1626'></font>
  LOGICAL                                           :: VEG    <font color=#447700>!true if vegetated surface<a name='1627'></font>
  REAL                                              :: UR     <font color=#447700>!wind speed at height ZLVL (m/s)<a name='1628'></font>
  REAL                                              :: ZLVL   <font color=#447700>!reference height (m)<a name='1629'></font>
  REAL                                              :: FSUN   <font color=#447700>!sunlit fraction of canopy [-]<a name='1630'></font>
  REAL                                              :: RB     <font color=#447700>!leaf boundary layer resistance (s/m)<a name='1631'></font>
  REAL                                              :: RSURF  <font color=#447700>!ground surface resistance (s/m)<a name='1632'></font>
  REAL                                              :: L_RSURF<font color=#447700>!Dry-layer thickness for computing RSURF (Sakaguchi and Zeng, 2009)<a name='1633'></font>
  REAL                                              :: D_RSURF<font color=#447700>!Reduced vapor diffusivity in soil for computing RSURF (SZ09)<a name='1634'></font>
  REAL                                              :: BEVAP  <font color=#447700>!soil water evaporation factor (0- 1)<a name='1635'></font>
  REAL                                              :: MOL    <font color=#447700>!Monin-Obukhov length (m)<a name='1636'></font>
  REAL                                              :: VAI    <font color=#447700>!sum of LAI  + stem area index [m2/m2]<a name='1637'></font>
  REAL                                              :: CWP    <font color=#447700>!canopy wind extinction parameter<a name='1638'></font>
  REAL                                              :: ZPD    <font color=#447700>!zero plane displacement (m)<a name='1639'></font>
  REAL                                              :: Z0M    <font color=#447700>!z0 momentum (m)<a name='1640'></font>
  REAL                                              :: ZPDG   <font color=#447700>!zero plane displacement (m)<a name='1641'></font>
  REAL                                              :: Z0MG   <font color=#447700>!z0 momentum, ground (m)<a name='1642'></font>
  REAL                                              :: EMV    <font color=#447700>!vegetation emissivity<a name='1643'></font>
  REAL                                              :: EMG    <font color=#447700>!ground emissivity<a name='1644'></font>
  REAL                                              :: FIRE   <font color=#447700>!emitted IR (w/m2)<a name='1645'></font>
<a name='1646'>
  REAL                                              :: LAISUN <font color=#447700>!sunlit leaf area index (m2/m2)<a name='1647'></font>
  REAL                                              :: LAISHA <font color=#447700>!shaded leaf area index (m2/m2)<a name='1648'></font>
  REAL                                              :: PSNSUN <font color=#447700>!sunlit photosynthesis (umolco2/m2/s)<a name='1649'></font>
  REAL                                              :: PSNSHA <font color=#447700>!shaded photosynthesis (umolco2/m2/s)<a name='1650'></font>
<font color=#447700>!jref:start - for debug  <a name='1651'></font>
<font color=#447700>!  REAL                                              :: RSSUN  !sunlit stomatal resistance (s/m)<a name='1652'></font>
<font color=#447700>!  REAL                                              :: RSSHA  !shaded stomatal resistance (s/m)<a name='1653'></font>
<font color=#447700>!jref:end - for debug<a name='1654'></font>
  REAL                                              :: PARSUN <font color=#447700>!par absorbed per sunlit LAI (w/m2)<a name='1655'></font>
  REAL                                              :: PARSHA <font color=#447700>!par absorbed per shaded LAI (w/m2)<a name='1656'></font>
<a name='1657'>
  REAL, DIMENSION(-NSNOW+1:NSOIL)                   :: FACT   <font color=#447700>!temporary used in phase change<a name='1658'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL)                   :: DF     <font color=#447700>!thermal conductivity [w/m/k]<a name='1659'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL)                   :: HCPCT  <font color=#447700>!heat capacity [j/m3/k]<a name='1660'></font>
  REAL                                              :: BDSNO  <font color=#447700>!bulk density of snow (kg/m3)<a name='1661'></font>
  REAL                                              :: FMELT  <font color=#447700>!melting factor for snow cover frac<a name='1662'></font>
  REAL                                              :: GX     <font color=#447700>!temporary variable<a name='1663'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL)                   :: PHI    <font color=#447700>!light through water (w/m2)<a name='1664'></font>
<font color=#447700>!  REAL                                              :: GAMMA  !psychrometric constant (pa/k)<a name='1665'></font>
  REAL                                              :: GAMMAV  <font color=#447700>!psychrometric constant (pa/k)<a name='1666'></font>
  REAL                                              :: GAMMAG  <font color=#447700>!psychrometric constant (pa/k)<a name='1667'></font>
  REAL                                              :: PSI    <font color=#447700>!surface layer soil matrix potential (m)<a name='1668'></font>
  REAL                                              :: RHSUR  <font color=#447700>!raltive humidity in surface soil/snow air space (-)<a name='1669'></font>
<a name='1670'>
<font color=#447700>! temperature and fluxes over vegetated fraction<a name='1671'></font>
<a name='1672'>
  REAL                                              :: TAUXV  <font color=#447700>!wind stress: e-w dir [n/m2]<a name='1673'></font>
  REAL                                              :: TAUYV  <font color=#447700>!wind stress: n-s dir [n/m2]<a name='1674'></font>
  REAL,INTENT(OUT)                                              :: IRC    <font color=#447700>!canopy net LW rad. [w/m2] [+ to atm]<a name='1675'></font>
  REAL,INTENT(OUT)                                              :: IRG    <font color=#447700>!ground net LW rad. [w/m2] [+ to atm]<a name='1676'></font>
  REAL,INTENT(OUT)                                              :: SHC    <font color=#447700>!canopy sen. heat [w/m2]   [+ to atm]<a name='1677'></font>
  REAL,INTENT(OUT)                                              :: SHG    <font color=#447700>!ground sen. heat [w/m2]   [+ to atm]<a name='1678'></font>
<font color=#447700>!jref:start  <a name='1679'></font>
  REAL,INTENT(OUT)                                  :: Q2V<a name='1680'>
  REAL,INTENT(OUT)                                  :: Q2B<a name='1681'>
  REAL,INTENT(OUT)                                  :: Q2E<a name='1682'>
<font color=#447700>!jref:end  <a name='1683'></font>
  REAL,INTENT(OUT)                                              :: EVC    <font color=#447700>!canopy evap. heat [w/m2]  [+ to atm]<a name='1684'></font>
  REAL,INTENT(OUT)                                              :: EVG    <font color=#447700>!ground evap. heat [w/m2]  [+ to atm]<a name='1685'></font>
  REAL,INTENT(OUT)                                              :: TR     <font color=#447700>!transpiration heat [w/m2] [+ to atm]<a name='1686'></font>
  REAL,INTENT(OUT)                                              :: GHV    <font color=#447700>!ground heat flux [w/m2]  [+ to soil]<a name='1687'></font>
  REAL,INTENT(OUT)                                  :: TGV    <font color=#447700>!ground surface temp. [k]<a name='1688'></font>
  REAL                                              :: CMV    <font color=#447700>!momentum drag coefficient<a name='1689'></font>
  REAL,INTENT(OUT)                                  :: CHV    <font color=#447700>!sensible heat exchange coefficient<a name='1690'></font>
<a name='1691'>
<font color=#447700>! temperature and fluxes over bare soil fraction<a name='1692'></font>
<a name='1693'>
  REAL                                              :: TAUXB  <font color=#447700>!wind stress: e-w dir [n/m2]<a name='1694'></font>
  REAL                                              :: TAUYB  <font color=#447700>!wind stress: n-s dir [n/m2]<a name='1695'></font>
  REAL,INTENT(OUT)                                              :: IRB    <font color=#447700>!net longwave rad. [w/m2] [+ to atm]<a name='1696'></font>
  REAL,INTENT(OUT)                                              :: SHB    <font color=#447700>!sensible heat [w/m2]     [+ to atm]<a name='1697'></font>
  REAL,INTENT(OUT)                                              :: EVB    <font color=#447700>!evaporation heat [w/m2]  [+ to atm]<a name='1698'></font>
  REAL,INTENT(OUT)                                              :: GHB    <font color=#447700>!ground heat flux [w/m2] [+ to soil]<a name='1699'></font>
  REAL,INTENT(OUT)                                  :: TGB    <font color=#447700>!ground surface temp. [k]<a name='1700'></font>
  REAL                                              :: CMB    <font color=#447700>!momentum drag coefficient<a name='1701'></font>
  REAL,INTENT(OUT)                                  :: CHB    <font color=#447700>!sensible heat exchange coefficient<a name='1702'></font>
  REAL,INTENT(OUT)                                  :: CHLEAF <font color=#447700>!leaf exchange coefficient<a name='1703'></font>
  REAL,INTENT(OUT)                                  :: CHUC   <font color=#447700>!under canopy exchange coefficient<a name='1704'></font>
<font color=#447700>!jref:start  <a name='1705'></font>
  REAL,INTENT(OUT)                                  :: CHV2    <font color=#447700>!sensible heat conductance, canopy air to ZLVL air (m/s)<a name='1706'></font>
  REAL,INTENT(OUT)                                  :: CHB2    <font color=#447700>!sensible heat conductance, canopy air to ZLVL air (m/s)<a name='1707'></font>
  REAL                                  :: noahmpres<a name='1708'>
<a name='1709'>
<font color=#447700>!jref:end  <a name='1710'></font>
<a name='1711'>
  REAL, PARAMETER                   :: MPE    = 1.E-6<a name='1712'>
  REAL, PARAMETER                   :: PSIWLT = -150.  <font color=#447700>!metric potential for wilting point (m)<a name='1713'></font>
  REAL, PARAMETER                   :: Z0     = 0.002  <font color=#447700>! Bare-soil roughness length (m) (i.e., under the canopy)<a name='1714'></font>
<a name='1715'>
<font color=#447700>! ---------------------------------------------------------------------------------------------------<a name='1716'></font>
<font color=#447700>! initialize fluxes from veg. fraction<a name='1717'></font>
<a name='1718'>
    TAUXV     = 0.    <a name='1719'>
    TAUYV     = 0.<a name='1720'>
    IRC       = 0.<a name='1721'>
    SHC       = 0.<a name='1722'>
    IRG       = 0.<a name='1723'>
    SHG       = 0.<a name='1724'>
    EVG       = 0.       <a name='1725'>
    EVC       = 0.<a name='1726'>
    TR        = 0.<a name='1727'>
    GHV       = 0.       <a name='1728'>
    PSNSUN    = 0.<a name='1729'>
    PSNSHA    = 0.<a name='1730'>
    T2MV      = 0.<a name='1731'>
    Q2V       = 0.<a name='1732'>
    CHV       = 0.<a name='1733'>
    CHLEAF    = 0.<a name='1734'>
    CHUC      = 0.<a name='1735'>
    CHV2      = 0.<a name='1736'>
<a name='1737'>
<font color=#447700>! wind speed at reference height: ur &gt;= 1<a name='1738'></font>
<a name='1739'>
    UR = MAX( SQRT(UU**2.+VV**2.), 1. )<a name='1740'>
<a name='1741'>
<font color=#447700>! vegetated or non-vegetated<a name='1742'></font>
<a name='1743'>
    VAI = ELAI + ESAI<a name='1744'>
    VEG = .FALSE.<a name='1745'>
    IF(VAI &gt; 0.) VEG = .TRUE.<a name='1746'>
<a name='1747'>
<font color=#447700>! ground snow cover fraction [Niu and Yang, 2007, JGR]<a name='1748'></font>
<a name='1749'>
     FSNO = 0.<a name='1750'>
     IF(SNOWH.GT.0.)  THEN<a name='1751'>
         BDSNO    = SNEQV / SNOWH<a name='1752'>
         FMELT    = (BDSNO/100.)**parameters%MFSNO<a name='1753'>
         FSNO     = TANH( SNOWH /(2.5* Z0 * FMELT))<a name='1754'>
     ENDIF<a name='1755'>
<a name='1756'>
<font color=#447700>! ground roughness length<a name='1757'></font>
<a name='1758'>
     IF(IST == 2) THEN<a name='1759'>
       IF(TG .LE. TFRZ) THEN<a name='1760'>
         Z0MG = 0.01 * (1.0-FSNO) + FSNO * parameters%Z0SNO<a name='1761'>
       ELSE<a name='1762'>
         Z0MG = 0.01  <a name='1763'>
       END IF<a name='1764'>
     ELSE<a name='1765'>
       Z0MG = Z0 * (1.0-FSNO) + FSNO * parameters%Z0SNO<a name='1766'>
     END IF<a name='1767'>
<a name='1768'>
<font color=#447700>! roughness length and displacement height<a name='1769'></font>
<a name='1770'>
     ZPDG  = SNOWH<a name='1771'>
     IF(VEG) THEN<a name='1772'>
        Z0M  = parameters%Z0MVT<a name='1773'>
        ZPD  = 0.65 * parameters%HVT<a name='1774'>
        IF(SNOWH.GT.ZPD) ZPD  = SNOWH<a name='1775'>
     ELSE<a name='1776'>
        Z0M  = Z0MG<a name='1777'>
        ZPD  = ZPDG<a name='1778'>
     END IF<a name='1779'>
<a name='1780'>
     ZLVL = MAX(ZPD,parameters%HVT) + ZREF<a name='1781'>
     IF(ZPDG &gt;= ZLVL) ZLVL = ZPDG + ZREF<a name='1782'>
<font color=#447700>!     UR   = UR*LOG(ZLVL/Z0M)/LOG(10./Z0M)       !input UR is at 10m<a name='1783'></font>
<a name='1784'>
<font color=#447700>! canopy wind absorption coeffcient<a name='1785'></font>
<a name='1786'>
     CWP = parameters%CWPVT<a name='1787'>
<a name='1788'>
<font color=#447700>! Thermal properties of soil, snow, lake, and frozen soil<a name='1789'></font>
<a name='1790'>
  CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#THERMOPROP'>THERMOPROP</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ENERGY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THERMOPROP_1"> (parameters,NSOIL   ,NSNOW   ,ISNOW   ,IST     ,DZSNSO  , &amp; <font color=#447700>!in<a name='1791'></font>
                   DT      ,SNOWH   ,SNICE   ,SNLIQ   , &amp; <font color=#447700>!in<a name='1792'></font>
                   SMC     ,SH2O    ,TG      ,STC     ,UR      , &amp; <font color=#447700>!in<a name='1793'></font>
                   LAT     ,Z0M     ,ZLVL    ,VEGTYP  , &amp; <font color=#447700>!in<a name='1794'></font>
                   DF      ,HCPCT   ,SNICEV  ,SNLIQV  ,EPORE   , &amp; <font color=#447700>!out<a name='1795'></font>
                   FACT    )                              <font color=#447700>!out<a name='1796'></font>
<a name='1797'>
<font color=#447700>! Solar radiation: absorbed &amp; reflected by the ground and canopy<a name='1798'></font>
<a name='1799'>
  CALL  <A href='../../html_code/phys/module_sf_noahmplsm.F.html#RADIATION'>RADIATION</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ENERGY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADIATION_2"> (parameters,VEGTYP  ,IST     ,ICE     ,NSOIL   , &amp; <font color=#447700>!in <a name='1800'></font>
                   SNEQVO  ,SNEQV   ,DT      ,COSZ    ,SNOWH   , &amp; <font color=#447700>!in<a name='1801'></font>
                   TG      ,TV      ,FSNO    ,QSNOW   ,FWET    , &amp; <font color=#447700>!in<a name='1802'></font>
                   ELAI    ,ESAI    ,SMC     ,SOLAD   ,SOLAI   , &amp; <font color=#447700>!in<a name='1803'></font>
                   FVEG    ,ILOC    ,JLOC    ,                   &amp; <font color=#447700>!in<a name='1804'></font>
                   ALBOLD  ,TAUSS   ,                            &amp; <font color=#447700>!inout<a name='1805'></font>
                   FSUN    ,LAISUN  ,LAISHA  ,PARSUN  ,PARSHA  , &amp; <font color=#447700>!out<a name='1806'></font>
                   SAV     ,SAG     ,FSR     ,FSA     ,FSRV    , &amp; <a name='1807'>
                   FSRG    ,BGAP    ,WGAP    )            <font color=#447700>!out<a name='1808'></font>
<a name='1809'>
<font color=#447700>! vegetation and ground emissivity<a name='1810'></font>
<a name='1811'>
     EMV = 1. - EXP(-(ELAI+ESAI)/1.0)<a name='1812'>
     IF (ICE == 1) THEN<a name='1813'>
       EMG = 0.98*(1.-FSNO) + 1.0*FSNO<a name='1814'>
     ELSE<a name='1815'>
       EMG = parameters%EG(IST)*(1.-FSNO) + 1.0*FSNO<a name='1816'>
     END IF<a name='1817'>
<a name='1818'>
<font color=#447700>! soil moisture factor controlling stomatal resistance<a name='1819'></font>
   <a name='1820'>
     BTRAN = 0.<a name='1821'>
<a name='1822'>
     IF(IST ==1 ) THEN<a name='1823'>
       DO IZ = 1, parameters%NROOT<a name='1824'>
          IF(OPT_BTR == 1) then                  <font color=#447700>! Noah<a name='1825'></font>
            GX    = (SH2O(IZ)-parameters%SMCWLT(IZ)) / (parameters%SMCREF(IZ)-parameters%SMCWLT(IZ))<a name='1826'>
          END IF<a name='1827'>
          IF(OPT_BTR == 2) then                  <font color=#447700>! CLM<a name='1828'></font>
            PSI   = MAX(PSIWLT,-parameters%PSISAT(IZ)*(MAX(0.01,SH2O(IZ))/parameters%SMCMAX(IZ))**(-parameters%BEXP(IZ)) )<a name='1829'>
            GX    = (1.-PSI/PSIWLT)/(1.+parameters%PSISAT(IZ)/PSIWLT)<a name='1830'>
          END IF<a name='1831'>
          IF(OPT_BTR == 3) then                  <font color=#447700>! SSiB<a name='1832'></font>
            PSI   = MAX(PSIWLT,-parameters%PSISAT(IZ)*(MAX(0.01,SH2O(IZ))/parameters%SMCMAX(IZ))**(-parameters%BEXP(IZ)) )<a name='1833'>
            GX    = 1.-EXP(-5.8*(LOG(PSIWLT/PSI))) <a name='1834'>
          END IF<a name='1835'>
       <a name='1836'>
          GX = MIN(1.,MAX(0.,GX))<a name='1837'>
          BTRANI(IZ) = MAX(MPE,DZSNSO(IZ) / (-ZSOIL(parameters%NROOT)) * GX)<a name='1838'>
          BTRAN      = BTRAN + BTRANI(IZ)<a name='1839'>
       END DO<a name='1840'>
       BTRAN = MAX(MPE,BTRAN)<a name='1841'>
<a name='1842'>
       BTRANI(1:parameters%NROOT) = BTRANI(1:parameters%NROOT)/BTRAN<a name='1843'>
     END IF<a name='1844'>
<a name='1845'>
<font color=#447700>! soil surface resistance for ground evap.<a name='1846'></font>
<a name='1847'>
     BEVAP = MAX(0.0,SH2O(1)/parameters%SMCMAX(1))<a name='1848'>
     IF(IST == 2) THEN<a name='1849'>
       RSURF = 1.          <font color=#447700>! avoid being divided by 0<a name='1850'></font>
       RHSUR = 1.0<a name='1851'>
     ELSE<a name='1852'>
<a name='1853'>
       IF(OPT_RSF == 1 .OR. OPT_RSF == 4) THEN<a name='1854'>
         <font color=#447700>! RSURF based on Sakaguchi and Zeng, 2009<a name='1855'></font>
         <font color=#447700>! taking the "residual water content" to be the wilting point, <a name='1856'></font>
         <font color=#447700>! and correcting the exponent on the D term (typo in SZ09 ?)<a name='1857'></font>
         L_RSURF = (-ZSOIL(1)) * ( exp ( (1.0 - MIN(1.0,SH2O(1)/parameters%SMCMAX(1))) ** 5 ) - 1.0 ) / ( 2.71828 - 1.0 ) <a name='1858'>
         D_RSURF = 2.2E-5 * parameters%SMCMAX(1) * parameters%SMCMAX(1) * ( 1.0 - parameters%SMCWLT(1) / parameters%SMCMAX(1) ) ** (2.0+3.0/parameters%BEXP(1))<a name='1859'>
         RSURF = L_RSURF / D_RSURF<a name='1860'>
       ELSEIF(OPT_RSF == 2) THEN<a name='1861'>
         RSURF = FSNO * 1. + (1.-FSNO)* EXP(8.25-4.225*BEVAP) <font color=#447700>!Sellers (1992) ! Older RSURF computations<a name='1862'></font>
       ELSEIF(OPT_RSF == 3) THEN<a name='1863'>
         RSURF = FSNO * 1. + (1.-FSNO)* EXP(8.25-6.0  *BEVAP) <font color=#447700>!adjusted to decrease RSURF for wet soil<a name='1864'></font>
       ENDIF<a name='1865'>
<a name='1866'>
       IF(OPT_RSF == 4) THEN  <font color=#447700>! AD: FSNO weighted; snow RSURF set in MPTABLE v3.8<a name='1867'></font>
         RSURF = 1. / (FSNO * (1./parameters%RSURF_SNOW) + (1.-FSNO) * (1./max(RSURF, 0.001)))<a name='1868'>
       ENDIF<a name='1869'>
<a name='1870'>
       IF(SH2O(1) &lt; 0.01 .and. SNOWH == 0.) RSURF = 1.E6<a name='1871'>
       PSI   = -parameters%PSISAT(1)*(MAX(0.01,SH2O(1))/parameters%SMCMAX(1))**(-parameters%BEXP(1))   <a name='1872'>
       RHSUR = FSNO + (1.-FSNO) * EXP(PSI*GRAV/(RW*TG)) <a name='1873'>
     END IF<a name='1874'>
<a name='1875'>
<font color=#447700>! urban - jref <a name='1876'></font>
     IF (parameters%urban_flag .and. SNOWH == 0. ) THEN<a name='1877'>
        RSURF = 1.E6<a name='1878'>
     ENDIF<a name='1879'>
<a name='1880'>
<font color=#447700>! set psychrometric constant<a name='1881'></font>
<a name='1882'>
     IF (TV .GT. TFRZ) THEN           <font color=#447700>! Barlage: add distinction between ground and <a name='1883'></font>
        LATHEAV = HVAP                <font color=#447700>! vegetation in v3.6<a name='1884'></font>
	frozen_canopy = .false.<a name='1885'>
     ELSE<a name='1886'>
        LATHEAV = HSUB<a name='1887'>
	frozen_canopy = .true.<a name='1888'>
     END IF<a name='1889'>
     GAMMAV = CPAIR*SFCPRS/(0.622*LATHEAV)<a name='1890'>
<a name='1891'>
     IF (TG .GT. TFRZ) THEN<a name='1892'>
        LATHEAG = HVAP<a name='1893'>
	frozen_ground = .false.<a name='1894'>
     ELSE<a name='1895'>
        LATHEAG = HSUB<a name='1896'>
	frozen_ground = .true.<a name='1897'>
     END IF<a name='1898'>
     GAMMAG = CPAIR*SFCPRS/(0.622*LATHEAG)<a name='1899'>
<a name='1900'>
<font color=#447700>!     IF (SFCTMP .GT. TFRZ) THEN<a name='1901'></font>
<font color=#447700>!        LATHEA = HVAP<a name='1902'></font>
<font color=#447700>!     ELSE<a name='1903'></font>
<font color=#447700>!        LATHEA = HSUB<a name='1904'></font>
<font color=#447700>!     END IF<a name='1905'></font>
<font color=#447700>!     GAMMA = CPAIR*SFCPRS/(0.622*LATHEA)<a name='1906'></font>
<a name='1907'>
<font color=#447700>! Surface temperatures of the ground and canopy and energy fluxes<a name='1908'></font>
<a name='1909'>
    IF (VEG .AND. FVEG &gt; 0) THEN <a name='1910'>
    TGV = TG<a name='1911'>
    CMV = CM<a name='1912'>
    CHV = CH<a name='1913'>
    CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX'>VEGE_FLUX</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ENERGY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VEGE_FLUX_1"> (parameters,NSNOW   ,NSOIL   ,ISNOW   ,VEGTYP  ,VEG     , &amp; <font color=#447700>!in<a name='1914'></font>
                    DT      ,SAV     ,SAG     ,LWDN    ,UR      , &amp; <font color=#447700>!in<a name='1915'></font>
                    UU      ,VV      ,SFCTMP  ,THAIR   ,QAIR    , &amp; <font color=#447700>!in<a name='1916'></font>
                    EAIR    ,RHOAIR  ,SNOWH   ,VAI     ,GAMMAV   ,GAMMAG   , &amp; <font color=#447700>!in<a name='1917'></font>
                    FWET    ,LAISUN  ,LAISHA  ,CWP     ,DZSNSO  , &amp; <font color=#447700>!in<a name='1918'></font>
                    ZLVL    ,ZPD     ,Z0M     ,FVEG    , &amp; <font color=#447700>!in<a name='1919'></font>
                    Z0MG    ,EMV     ,EMG     ,CANLIQ  ,FSNO, &amp; <font color=#447700>!in<a name='1920'></font>
                    CANICE  ,STC     ,DF      ,RSSUN   ,RSSHA   , &amp; <font color=#447700>!in<a name='1921'></font>
                    RSURF   ,LATHEAV ,LATHEAG ,PARSUN  ,PARSHA  ,IGS     , &amp; <font color=#447700>!in<a name='1922'></font>
                    FOLN    ,CO2AIR  ,O2AIR   ,BTRAN   ,SFCPRS  , &amp; <font color=#447700>!in<a name='1923'></font>
                    RHSUR   ,ILOC    ,JLOC    ,Q2      ,PAHV  ,PAHG  , &amp; <font color=#447700>!in<a name='1924'></font>
                    EAH     ,TAH     ,TV      ,TGV     ,CMV     , &amp; <font color=#447700>!inout<a name='1925'></font>
                    CHV     ,DX      ,DZ8W    ,                   &amp; <font color=#447700>!inout<a name='1926'></font>
                    TAUXV   ,TAUYV   ,IRG     ,IRC     ,SHG     , &amp; <font color=#447700>!out<a name='1927'></font>
                    SHC     ,EVG     ,EVC     ,TR      ,GHV     , &amp; <font color=#447700>!out<a name='1928'></font>
                    T2MV    ,PSNSUN  ,PSNSHA  ,                   &amp; <font color=#447700>!out<a name='1929'></font>
<font color=#447700>!jref:start<a name='1930'></font>
                    QC      ,QSFC    ,PSFC    , &amp; <font color=#447700>!in<a name='1931'></font>
                    Q2V     ,CHV2, CHLEAF, CHUC)               <font color=#447700>!inout <a name='1932'></font>
<font color=#447700>!jref:end                            <a name='1933'></font>
    END IF<a name='1934'>
<a name='1935'>
    TGB = TG<a name='1936'>
    CMB = CM<a name='1937'>
    CHB = CH<a name='1938'>
    CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#BARE_FLUX'>BARE_FLUX</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ENERGY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BARE_FLUX_1"> (parameters,NSNOW   ,NSOIL   ,ISNOW   ,DT      ,SAG     , &amp; <font color=#447700>!in<a name='1939'></font>
                    LWDN    ,UR      ,UU      ,VV      ,SFCTMP  , &amp; <font color=#447700>!in<a name='1940'></font>
                    THAIR   ,QAIR    ,EAIR    ,RHOAIR  ,SNOWH   , &amp; <font color=#447700>!in<a name='1941'></font>
                    DZSNSO  ,ZLVL    ,ZPDG    ,Z0MG    ,FSNO,          &amp; <font color=#447700>!in<a name='1942'></font>
                    EMG     ,STC     ,DF      ,RSURF   ,LATHEAG  , &amp; <font color=#447700>!in<a name='1943'></font>
                    GAMMAG   ,RHSUR   ,ILOC    ,JLOC    ,Q2      ,PAHB  , &amp; <font color=#447700>!in<a name='1944'></font>
                    TGB     ,CMB     ,CHB     ,                   &amp; <font color=#447700>!inout<a name='1945'></font>
                    TAUXB   ,TAUYB   ,IRB     ,SHB     ,EVB     , &amp; <font color=#447700>!out<a name='1946'></font>
                    GHB     ,T2MB    ,DX      ,DZ8W    ,VEGTYP  , &amp; <font color=#447700>!out<a name='1947'></font>
<font color=#447700>!jref:start<a name='1948'></font>
                    QC      ,QSFC    ,PSFC    , &amp; <font color=#447700>!in<a name='1949'></font>
                    SFCPRS  ,Q2B,   CHB2)                          <font color=#447700>!in <a name='1950'></font>
<font color=#447700>!jref:end                            <a name='1951'></font>
<a name='1952'>
<font color=#447700>!energy balance at vege canopy: SAV          =(IRC+SHC+EVC+TR)     *FVEG  at   FVEG <a name='1953'></font>
<font color=#447700>!energy balance at vege ground: SAG*    FVEG =(IRG+SHG+EVG+GHV)    *FVEG  at   FVEG<a name='1954'></font>
<font color=#447700>!energy balance at bare ground: SAG*(1.-FVEG)=(IRB+SHB+EVB+GHB)*(1.-FVEG) at 1-FVEG<a name='1955'></font>
<a name='1956'>
    IF (VEG .AND. FVEG &gt; 0) THEN <a name='1957'>
        TAUX  = FVEG * TAUXV     + (1.0 - FVEG) * TAUXB<a name='1958'>
        TAUY  = FVEG * TAUYV     + (1.0 - FVEG) * TAUYB<a name='1959'>
        FIRA  = FVEG * IRG       + (1.0 - FVEG) * IRB       + IRC<a name='1960'>
        FSH   = FVEG * SHG       + (1.0 - FVEG) * SHB       + SHC<a name='1961'>
        FGEV  = FVEG * EVG       + (1.0 - FVEG) * EVB<a name='1962'>
        SSOIL = FVEG * GHV       + (1.0 - FVEG) * GHB<a name='1963'>
        FCEV  = EVC<a name='1964'>
        FCTR  = TR<a name='1965'>
	PAH   = FVEG * PAHG      + (1.0 - FVEG) * PAHB   + PAHV<a name='1966'>
        TG    = FVEG * TGV       + (1.0 - FVEG) * TGB<a name='1967'>
        T2M   = FVEG * T2MV      + (1.0 - FVEG) * T2MB<a name='1968'>
        TS    = FVEG * TV        + (1.0 - FVEG) * TGB<a name='1969'>
        CM    = FVEG * CMV       + (1.0 - FVEG) * CMB      <font color=#447700>! better way to average?<a name='1970'></font>
        CH    = FVEG * CHV       + (1.0 - FVEG) * CHB<a name='1971'>
        Q1    = FVEG * (EAH*0.622/(SFCPRS - 0.378*EAH)) + (1.0 - FVEG)*QSFC<a name='1972'>
        Q2E   = FVEG * Q2V       + (1.0 - FVEG) * Q2B<a name='1973'>
	Z0WRF = Z0M<a name='1974'>
    ELSE<a name='1975'>
        TAUX  = TAUXB<a name='1976'>
        TAUY  = TAUYB<a name='1977'>
        FIRA  = IRB<a name='1978'>
        FSH   = SHB<a name='1979'>
        FGEV  = EVB<a name='1980'>
        SSOIL = GHB<a name='1981'>
        TG    = TGB<a name='1982'>
        T2M   = T2MB<a name='1983'>
        FCEV  = 0.<a name='1984'>
        FCTR  = 0.<a name='1985'>
	PAH   = PAHB<a name='1986'>
        TS    = TG<a name='1987'>
        CM    = CMB<a name='1988'>
        CH    = CHB<a name='1989'>
        Q1    = QSFC<a name='1990'>
        Q2E   = Q2B<a name='1991'>
        RSSUN = 0.0<a name='1992'>
        RSSHA = 0.0<a name='1993'>
        TGV   = TGB<a name='1994'>
        CHV   = CHB<a name='1995'>
	Z0WRF = Z0MG<a name='1996'>
    END IF<a name='1997'>
<a name='1998'>
    FIRE = LWDN + FIRA<a name='1999'>
<a name='2000'>
    IF(FIRE &lt;=0.) THEN<a name='2001'>
       WRITE(6,*) 'emitted longwave &lt;0; skin T may be wrong due to inconsistent'<a name='2002'>
       WRITE(6,*) 'input of SHDFAC with LAI'<a name='2003'>
       WRITE(6,*) ILOC, JLOC, 'SHDFAC=',FVEG,'VAI=',VAI,'TV=',TV,'TG=',TG<a name='2004'>
       WRITE(6,*) 'LWDN=',LWDN,'FIRA=',FIRA,'SNOWH=',SNOWH<a name='2005'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ENERGY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1189">("STOP in Noah-MP")<a name='2006'>
    END IF<a name='2007'>
<a name='2008'>
    <font color=#447700>! Compute a net emissivity<a name='2009'></font>
    EMISSI = FVEG * ( EMG*(1-EMV) + EMV + EMV*(1-EMV)*(1-EMG) ) + &amp;<a name='2010'>
         (1-FVEG) * EMG<a name='2011'>
<a name='2012'>
    <font color=#447700>! When we're computing a TRAD, subtract from the emitted IR the<a name='2013'></font>
    <font color=#447700>! reflected portion of the incoming LWDN, so we're just<a name='2014'></font>
    <font color=#447700>! considering the IR originating in the canopy/ground system.<a name='2015'></font>
    <a name='2016'>
    TRAD = ( ( FIRE - (1-EMISSI)*LWDN ) / (EMISSI*SB) ) ** 0.25<a name='2017'>
<a name='2018'>
    <font color=#447700>! Old TRAD calculation not taking into account Emissivity:<a name='2019'></font>
    <font color=#447700>! TRAD = (FIRE/SB)**0.25<a name='2020'></font>
<a name='2021'>
    APAR = PARSUN*LAISUN + PARSHA*LAISHA<a name='2022'>
    PSN  = PSNSUN*LAISUN + PSNSHA*LAISHA<a name='2023'>
<a name='2024'>
<font color=#447700>! 3L snow &amp; 4L soil temperatures<a name='2025'></font>
<a name='2026'>
    CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#TSNOSOI'>TSNOSOI</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ENERGY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TSNOSOI_1"> (parameters,ICE     ,NSOIL   ,NSNOW   ,ISNOW   ,IST     , &amp; <font color=#447700>!in<a name='2027'></font>
                  TBOT    ,ZSNSO   ,SSOIL   ,DF      ,HCPCT   , &amp; <font color=#447700>!in<a name='2028'></font>
                  SAG     ,DT      ,SNOWH   ,DZSNSO  , &amp; <font color=#447700>!in<a name='2029'></font>
                  TG      ,ILOC    ,JLOC    ,                   &amp; <font color=#447700>!in<a name='2030'></font>
                  STC     )                                       <font color=#447700>!inout<a name='2031'></font>
<a name='2032'>
<font color=#447700>! adjusting snow surface temperature<a name='2033'></font>
     IF(OPT_STC == 2) THEN<a name='2034'>
      IF (SNOWH &gt; 0.05 .AND. TG &gt; TFRZ) THEN<a name='2035'>
        TGV = TFRZ<a name='2036'>
        TGB = TFRZ<a name='2037'>
          IF (VEG .AND. FVEG &gt; 0) THEN<a name='2038'>
             TG    = FVEG * TGV       + (1.0 - FVEG) * TGB<a name='2039'>
             TS    = FVEG * TV        + (1.0 - FVEG) * TGB<a name='2040'>
          ELSE<a name='2041'>
             TG    = TGB<a name='2042'>
             TS    = TGB<a name='2043'>
          END IF<a name='2044'>
      END IF<a name='2045'>
     END IF<a name='2046'>
<a name='2047'>
<font color=#447700>! Energy released or consumed by snow &amp; frozen soil<a name='2048'></font>
<a name='2049'>
 CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#PHASECHANGE'>PHASECHANGE</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ENERGY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHASECHANGE_2"> (parameters,NSNOW   ,NSOIL   ,ISNOW   ,DT      ,FACT    , &amp; <font color=#447700>!in<a name='2050'></font>
                   DZSNSO  ,HCPCT   ,IST     ,ILOC    ,JLOC    , &amp; <font color=#447700>!in<a name='2051'></font>
                   STC     ,SNICE   ,SNLIQ   ,SNEQV   ,SNOWH   , &amp; <font color=#447700>!inout<a name='2052'></font>
                   SMC     ,SH2O    ,                            &amp; <font color=#447700>!inout<a name='2053'></font>
                   QMELT   ,IMELT   ,PONDING )                     <font color=#447700>!out<a name='2054'></font>
<a name='2055'>
<a name='2056'>
  END SUBROUTINE ENERGY<a name='2057'>
<a name='2058'>
<font color=#447700>!== begin thermoprop ===============================================================================<a name='2059'></font>
<a name='2060'>
<A NAME='THERMOPROP'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#THERMOPROP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2061'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>THERMOPROP</font> (parameters,NSOIL   ,NSNOW   ,ISNOW   ,IST     ,DZSNSO  , &amp; <font color=#447700>!in <A href='../../call_to/THERMOPROP.html' TARGET='index'>1</A>,<A href='../../call_from/THERMOPROP.html' TARGET='index'>2</A><a name='2062'></font>
                         DT      ,SNOWH   ,SNICE   ,SNLIQ   , &amp; <font color=#447700>!in<a name='2063'></font>
                         SMC     ,SH2O    ,TG      ,STC     ,UR      , &amp; <font color=#447700>!in<a name='2064'></font>
                         LAT     ,Z0M     ,ZLVL    ,VEGTYP  , &amp; <font color=#447700>!in<a name='2065'></font>
                         DF      ,HCPCT   ,SNICEV  ,SNLIQV  ,EPORE   , &amp; <font color=#447700>!out<a name='2066'></font>
                         FACT    )                                       <font color=#447700>!out<a name='2067'></font>
<font color=#447700>! ------------------------------------------------------------------------------------------------- <a name='2068'></font>
  IMPLICIT NONE<a name='2069'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2070'></font>
<font color=#447700>! inputs<a name='2071'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='2072'>
  INTEGER                        , INTENT(IN)  :: NSOIL   <font color=#447700>!number of soil layers<a name='2073'></font>
  INTEGER                        , INTENT(IN)  :: NSNOW   <font color=#447700>!maximum no. of snow layers        <a name='2074'></font>
  INTEGER                        , INTENT(IN)  :: ISNOW   <font color=#447700>!actual no. of snow layers<a name='2075'></font>
  INTEGER                        , INTENT(IN)  :: IST     <font color=#447700>!surface type<a name='2076'></font>
  REAL                           , INTENT(IN)  :: DT      <font color=#447700>!time step [s]<a name='2077'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(IN)  :: SNICE   <font color=#447700>!snow ice mass (kg/m2)<a name='2078'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(IN)  :: SNLIQ   <font color=#447700>!snow liq mass (kg/m2)<a name='2079'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: DZSNSO  <font color=#447700>!thickness of snow/soil layers [m]<a name='2080'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN)  :: SMC     <font color=#447700>!soil moisture (ice + liq.) [m3/m3]<a name='2081'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN)  :: SH2O    <font color=#447700>!liquid soil moisture [m3/m3]<a name='2082'></font>
  REAL                           , INTENT(IN)  :: SNOWH   <font color=#447700>!snow height [m]<a name='2083'></font>
  REAL,                            INTENT(IN)  :: TG      <font color=#447700>!surface temperature (k)<a name='2084'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: STC     <font color=#447700>!snow/soil/lake temp. (k)<a name='2085'></font>
  REAL,                            INTENT(IN)  :: UR      <font color=#447700>!wind speed at ZLVL (m/s)<a name='2086'></font>
  REAL,                            INTENT(IN)  :: LAT     <font color=#447700>!latitude (radians)<a name='2087'></font>
  REAL,                            INTENT(IN)  :: Z0M     <font color=#447700>!roughness length (m)<a name='2088'></font>
  REAL,                            INTENT(IN)  :: ZLVL    <font color=#447700>!reference height (m)<a name='2089'></font>
  INTEGER                        , INTENT(IN)  :: VEGTYP  <font color=#447700>!vegtyp type<a name='2090'></font>
<a name='2091'>
<font color=#447700>! outputs<a name='2092'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: DF      <font color=#447700>!thermal conductivity [w/m/k]<a name='2093'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: HCPCT   <font color=#447700>!heat capacity [j/m3/k]<a name='2094'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: SNICEV  <font color=#447700>!partial volume of ice [m3/m3]<a name='2095'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: SNLIQV  <font color=#447700>!partial volume of liquid water [m3/m3]<a name='2096'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: EPORE   <font color=#447700>!effective porosity [m3/m3]<a name='2097'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: FACT    <font color=#447700>!computing energy for phase change<a name='2098'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2099'></font>
<font color=#447700>! locals<a name='2100'></font>
<a name='2101'>
  INTEGER :: IZ<a name='2102'>
  REAL, DIMENSION(-NSNOW+1:    0)              :: CVSNO   <font color=#447700>!volumetric specific heat (j/m3/k)<a name='2103'></font>
  REAL, DIMENSION(-NSNOW+1:    0)              :: TKSNO   <font color=#447700>!snow thermal conductivity (j/m3/k)<a name='2104'></font>
  REAL, DIMENSION(       1:NSOIL)              :: SICE    <font color=#447700>!soil ice content<a name='2105'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2106'></font>
<a name='2107'>
<font color=#447700>! compute snow thermal conductivity and heat capacity<a name='2108'></font>
<a name='2109'>
    CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CSNOW'>CSNOW</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#THERMOPROP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CSNOW_7"> (parameters,ISNOW   ,NSNOW   ,NSOIL   ,SNICE   ,SNLIQ   ,DZSNSO  , &amp; <font color=#447700>!in<a name='2110'></font>
                TKSNO   ,CVSNO   ,SNICEV  ,SNLIQV  ,EPORE   )   <font color=#447700>!out<a name='2111'></font>
<a name='2112'>
    DO IZ = ISNOW+1, 0<a name='2113'>
      DF   (IZ) = TKSNO(IZ)<a name='2114'>
      HCPCT(IZ) = CVSNO(IZ)<a name='2115'>
    END DO<a name='2116'>
<a name='2117'>
<font color=#447700>! compute soil thermal properties<a name='2118'></font>
<a name='2119'>
    DO  IZ = 1, NSOIL<a name='2120'>
       SICE(IZ)  = SMC(IZ) - SH2O(IZ)<a name='2121'>
       HCPCT(IZ) = SH2O(IZ)*CWAT + (1.0-parameters%SMCMAX(IZ))*parameters%CSOIL &amp;<a name='2122'>
                + (parameters%SMCMAX(IZ)-SMC(IZ))*CPAIR + SICE(IZ)*CICE<a name='2123'>
       CALL <A href='../../html_code/phys/module_sf_urban.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#THERMOPROP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_5"> (parameters,IZ,DF(IZ), SMC(IZ), SH2O(IZ))<a name='2124'>
    END DO<a name='2125'>
       <a name='2126'>
    IF ( parameters%urban_flag ) THEN<a name='2127'>
       DO IZ = 1,NSOIL<a name='2128'>
         DF(IZ) = 3.24<a name='2129'>
       END DO<a name='2130'>
    ENDIF<a name='2131'>
<a name='2132'>
<font color=#447700>! heat flux reduction effect from the overlying green canopy, adapted from <a name='2133'></font>
<font color=#447700>! section 2.1.2 of Peters-Lidard et al. (1997, JGR, VOL 102(D4)).<a name='2134'></font>
<font color=#447700>! not in use because of the separation of the canopy layer from the ground.<a name='2135'></font>
<font color=#447700>! but this may represent the effects of leaf litter (Niu comments)<a name='2136'></font>
<font color=#447700>!       DF1 = DF1 * EXP (SBETA * SHDFAC)<a name='2137'></font>
<a name='2138'>
<font color=#447700>! compute lake thermal properties <a name='2139'></font>
<font color=#447700>! (no consideration of turbulent mixing for this version)<a name='2140'></font>
<a name='2141'>
    IF(IST == 2) THEN<a name='2142'>
       DO IZ = 1, NSOIL <a name='2143'>
         IF(STC(IZ) &gt; TFRZ) THEN<a name='2144'>
            HCPCT(IZ) = CWAT<a name='2145'>
            DF(IZ)    = TKWAT  <font color=#447700>!+ KEDDY * CWAT <a name='2146'></font>
         ELSE<a name='2147'>
            HCPCT(IZ) = CICE<a name='2148'>
            DF(IZ)    = TKICE <a name='2149'>
         END IF<a name='2150'>
       END DO<a name='2151'>
    END IF<a name='2152'>
<a name='2153'>
<font color=#447700>! combine a temporary variable used for melting/freezing of snow and frozen soil<a name='2154'></font>
<a name='2155'>
    DO IZ = ISNOW+1,NSOIL<a name='2156'>
     FACT(IZ) = DT/(HCPCT(IZ)*DZSNSO(IZ))<a name='2157'>
    END DO<a name='2158'>
<a name='2159'>
<font color=#447700>! snow/soil interface<a name='2160'></font>
<a name='2161'>
    IF(ISNOW == 0) THEN<a name='2162'>
       DF(1) = (DF(1)*DZSNSO(1)+0.35*SNOWH)      / (SNOWH    +DZSNSO(1)) <a name='2163'>
    ELSE<a name='2164'>
       DF(1) = (DF(1)*DZSNSO(1)+DF(0)*DZSNSO(0)) / (DZSNSO(0)+DZSNSO(1))<a name='2165'>
    END IF<a name='2166'>
<a name='2167'>
<a name='2168'>
  END SUBROUTINE THERMOPROP<a name='2169'>
<a name='2170'>
<font color=#447700>!== begin csnow ====================================================================================<a name='2171'></font>
<a name='2172'>
<A NAME='CSNOW'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#CSNOW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2173'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>CSNOW</font> (parameters,ISNOW   ,NSNOW   ,NSOIL   ,SNICE   ,SNLIQ   ,DZSNSO  , &amp; <font color=#447700>!in <A href='../../call_to/CSNOW.html' TARGET='index'>7</A><a name='2174'></font>
                    TKSNO   ,CVSNO   ,SNICEV  ,SNLIQV  ,EPORE   )   <font color=#447700>!out<a name='2175'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2176'></font>
<font color=#447700>! Snow bulk density,volumetric capacity, and thermal conductivity<a name='2177'></font>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='2178'></font>
  IMPLICIT NONE<a name='2179'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='2180'></font>
<font color=#447700>! inputs<a name='2181'></font>
<a name='2182'>
  type (noahmp_parameters), intent(in) :: parameters<a name='2183'>
  INTEGER,                          INTENT(IN) :: ISNOW  <font color=#447700>!number of snow layers (-)            <a name='2184'></font>
  INTEGER                        ,  INTENT(IN) :: NSNOW  <font color=#447700>!maximum no. of snow layers        <a name='2185'></font>
  INTEGER                        ,  INTENT(IN) :: NSOIL  <font color=#447700>!number of soil layers<a name='2186'></font>
  REAL, DIMENSION(-NSNOW+1:    0),  INTENT(IN) :: SNICE  <font color=#447700>!snow ice mass (kg/m2)<a name='2187'></font>
  REAL, DIMENSION(-NSNOW+1:    0),  INTENT(IN) :: SNLIQ  <font color=#447700>!snow liq mass (kg/m2) <a name='2188'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL),  INTENT(IN) :: DZSNSO <font color=#447700>!snow/soil layer thickness [m]<a name='2189'></font>
<a name='2190'>
<font color=#447700>! outputs<a name='2191'></font>
<a name='2192'>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: CVSNO  <font color=#447700>!volumetric specific heat (j/m3/k)<a name='2193'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: TKSNO  <font color=#447700>!thermal conductivity (w/m/k)<a name='2194'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: SNICEV <font color=#447700>!partial volume of ice [m3/m3]<a name='2195'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: SNLIQV <font color=#447700>!partial volume of liquid water [m3/m3]<a name='2196'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(OUT) :: EPORE  <font color=#447700>!effective porosity [m3/m3]<a name='2197'></font>
<a name='2198'>
<font color=#447700>! locals<a name='2199'></font>
<a name='2200'>
  INTEGER :: IZ<a name='2201'>
  REAL, DIMENSION(-NSNOW+1:    0) :: BDSNOI  <font color=#447700>!bulk density of snow(kg/m3)<a name='2202'></font>
<a name='2203'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='2204'></font>
<font color=#447700>! thermal capacity of snow<a name='2205'></font>
<a name='2206'>
  DO IZ = ISNOW+1, 0<a name='2207'>
      SNICEV(IZ)   = MIN(1., SNICE(IZ)/(DZSNSO(IZ)*DENICE) )<a name='2208'>
      EPORE(IZ)    = 1. - SNICEV(IZ)<a name='2209'>
      SNLIQV(IZ)   = MIN(EPORE(IZ),SNLIQ(IZ)/(DZSNSO(IZ)*DENH2O))<a name='2210'>
  ENDDO<a name='2211'>
<a name='2212'>
  DO IZ = ISNOW+1, 0<a name='2213'>
      BDSNOI(IZ) = (SNICE(IZ)+SNLIQ(IZ))/DZSNSO(IZ)<a name='2214'>
      CVSNO(IZ) = CICE*SNICEV(IZ)+CWAT*SNLIQV(IZ)<a name='2215'>
<font color=#447700>!      CVSNO(IZ) = 0.525E06                          ! constant<a name='2216'></font>
  enddo<a name='2217'>
<a name='2218'>
<font color=#447700>! thermal conductivity of snow<a name='2219'></font>
<a name='2220'>
  DO IZ = ISNOW+1, 0<a name='2221'>
     TKSNO(IZ) = 3.2217E-6*BDSNOI(IZ)**2.           <font color=#447700>! Stieglitz(yen,1965)<a name='2222'></font>
<font color=#447700>!    TKSNO(IZ) = 2E-2+2.5E-6*BDSNOI(IZ)*BDSNOI(IZ)   ! Anderson, 1976<a name='2223'></font>
<font color=#447700>!    TKSNO(IZ) = 0.35                                ! constant<a name='2224'></font>
<font color=#447700>!    TKSNO(IZ) = 2.576E-6*BDSNOI(IZ)**2. + 0.074    ! Verseghy (1991)<a name='2225'></font>
<font color=#447700>!    TKSNO(IZ) = 2.22*(BDSNOI(IZ)/1000.)**1.88      ! Douvill(Yen, 1981)<a name='2226'></font>
  ENDDO<a name='2227'>
<a name='2228'>
  END SUBROUTINE CSNOW<a name='2229'>
<a name='2230'>
<font color=#447700>!== begin tdfcnd ===================================================================================<a name='2231'></font>
<a name='2232'>
<A NAME='TDFCND'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#TDFCND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2233'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>TDFCND</font> (parameters, ISOIL, DF, SMC, SH2O) <A href='../../call_to/TDFCND.html' TARGET='index'>8</A><a name='2234'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2235'></font>
<font color=#447700>! Calculate thermal diffusivity and conductivity of the soil.<a name='2236'></font>
<font color=#447700>! Peters-Lidard approach (Peters-Lidard et al., 1998)<a name='2237'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2238'></font>
<font color=#447700>! Code history:<a name='2239'></font>
<font color=#447700>! June 2001 changes: frozen soil condition.<a name='2240'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2241'></font>
    IMPLICIT NONE<a name='2242'>
  type (noahmp_parameters), intent(in) :: parameters<a name='2243'>
    INTEGER, INTENT(IN)    :: ISOIL  <font color=#447700>! soil layer<a name='2244'></font>
    REAL, INTENT(IN)       :: SMC    <font color=#447700>! total soil water<a name='2245'></font>
    REAL, INTENT(IN)       :: SH2O   <font color=#447700>! liq. soil water<a name='2246'></font>
    REAL, INTENT(OUT)      :: DF     <font color=#447700>! thermal diffusivity<a name='2247'></font>
<a name='2248'>
<font color=#447700>! local variables<a name='2249'></font>
    REAL  :: AKE<a name='2250'>
    REAL  :: GAMMD<a name='2251'>
    REAL  :: THKDRY<a name='2252'>
    REAL  :: THKO     <font color=#447700>! thermal conductivity for other soil components         <a name='2253'></font>
    REAL  :: THKQTZ   <font color=#447700>! thermal conductivity for quartz<a name='2254'></font>
    REAL  :: THKSAT   <font color=#447700>! <a name='2255'></font>
    REAL  :: THKS     <font color=#447700>! thermal conductivity for the solids<a name='2256'></font>
    REAL  :: THKW     <font color=#447700>! water thermal conductivity<a name='2257'></font>
    REAL  :: SATRATIO<a name='2258'>
    REAL  :: XU<a name='2259'>
    REAL  :: XUNFROZ<a name='2260'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2261'></font>
<font color=#447700>! We now get quartz as an input argument (set in routine redprm):<a name='2262'></font>
<font color=#447700>!      DATA QUARTZ /0.82, 0.10, 0.25, 0.60, 0.52,<a name='2263'></font>
<font color=#447700>!     &amp;             0.35, 0.60, 0.40, 0.82/<a name='2264'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2265'></font>
<font color=#447700>! If the soil has any moisture content compute a partial sum/product<a name='2266'></font>
<font color=#447700>! otherwise use a constant value which works well with most soils<a name='2267'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2268'></font>
<font color=#447700>!  QUARTZ ....QUARTZ CONTENT (SOIL TYPE DEPENDENT)<a name='2269'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2270'></font>
<font color=#447700>! USE AS IN PETERS-LIDARD, 1998 (MODIF. FROM JOHANSEN, 1975).<a name='2271'></font>
<a name='2272'>
<font color=#447700>!                                  PABLO GRUNMANN, 08/17/98<a name='2273'></font>
<font color=#447700>! Refs.:<a name='2274'></font>
<font color=#447700>!      Farouki, O.T.,1986: Thermal properties of soils. Series on Rock<a name='2275'></font>
<font color=#447700>!              and Soil Mechanics, Vol. 11, Trans Tech, 136 pp.<a name='2276'></font>
<font color=#447700>!      Johansen, O., 1975: Thermal conductivity of soils. PH.D. Thesis,<a name='2277'></font>
<font color=#447700>!              University of Trondheim,<a name='2278'></font>
<font color=#447700>!      Peters-Lidard, C. D., et al., 1998: The effect of soil thermal<a name='2279'></font>
<font color=#447700>!              conductivity parameterization on surface energy fluxes<a name='2280'></font>
<font color=#447700>!              and temperatures. Journal of The Atmospheric Sciences,<a name='2281'></font>
<font color=#447700>!              Vol. 55, pp. 1209-1224.<a name='2282'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2283'></font>
<font color=#447700>! NEEDS PARAMETERS<a name='2284'></font>
<font color=#447700>! POROSITY(SOIL TYPE):<a name='2285'></font>
<font color=#447700>!      POROS = SMCMAX<a name='2286'></font>
<font color=#447700>! SATURATION RATIO:<a name='2287'></font>
<font color=#447700>! PARAMETERS  W/(M.K)<a name='2288'></font>
    SATRATIO = SMC / parameters%SMCMAX(ISOIL)<a name='2289'>
    THKW = 0.57<a name='2290'>
<font color=#447700>!      IF (QUARTZ .LE. 0.2) THKO = 3.0<a name='2291'></font>
    THKO = 2.0<a name='2292'>
<font color=#447700>! SOLIDS' CONDUCTIVITY<a name='2293'></font>
<font color=#447700>! QUARTZ' CONDUCTIVITY<a name='2294'></font>
    THKQTZ = 7.7<a name='2295'>
<a name='2296'>
<font color=#447700>! UNFROZEN FRACTION (FROM 1., i.e., 100%LIQUID, TO 0. (100% FROZEN))<a name='2297'></font>
    THKS = (THKQTZ ** parameters%QUARTZ(ISOIL))* (THKO ** (1. - parameters%QUARTZ(ISOIL)))<a name='2298'>
<a name='2299'>
<font color=#447700>! UNFROZEN VOLUME FOR SATURATION (POROSITY*XUNFROZ)<a name='2300'></font>
    XUNFROZ = 1.0                       <font color=#447700>! Prevent divide by zero (suggested by D. Mocko)<a name='2301'></font>
    IF(SMC &gt; 0.) XUNFROZ = SH2O / SMC<a name='2302'>
<font color=#447700>! SATURATED THERMAL CONDUCTIVITY<a name='2303'></font>
    XU = XUNFROZ * parameters%SMCMAX(ISOIL)<a name='2304'>
<a name='2305'>
<font color=#447700>! DRY DENSITY IN KG/M3<a name='2306'></font>
    THKSAT = THKS ** (1. - parameters%SMCMAX(ISOIL))* TKICE ** (parameters%SMCMAX(ISOIL) - XU)* THKW **   &amp;<a name='2307'>
         (XU)<a name='2308'>
<a name='2309'>
<font color=#447700>! DRY THERMAL CONDUCTIVITY IN W.M-1.K-1<a name='2310'></font>
    GAMMD = (1. - parameters%SMCMAX(ISOIL))*2700.<a name='2311'>
<a name='2312'>
    THKDRY = (0.135* GAMMD+ 64.7)/ (2700. - 0.947* GAMMD)<a name='2313'>
<font color=#447700>! FROZEN<a name='2314'></font>
    IF ( (SH2O + 0.0005) &lt;  SMC ) THEN<a name='2315'>
       AKE = SATRATIO<a name='2316'>
<font color=#447700>! UNFROZEN<a name='2317'></font>
<font color=#447700>! RANGE OF VALIDITY FOR THE KERSTEN NUMBER (AKE)<a name='2318'></font>
    ELSE<a name='2319'>
<a name='2320'>
<font color=#447700>! KERSTEN NUMBER (USING "FINE" FORMULA, VALID FOR SOILS CONTAINING AT<a name='2321'></font>
<font color=#447700>! LEAST 5% OF PARTICLES WITH DIAMETER LESS THAN 2.E-6 METERS.)<a name='2322'></font>
<font color=#447700>! (FOR "COARSE" FORMULA, SEE PETERS-LIDARD ET AL., 1998).<a name='2323'></font>
<a name='2324'>
       IF ( SATRATIO &gt;  0.1 ) THEN<a name='2325'>
<a name='2326'>
          AKE = LOG10 (SATRATIO) + 1.0<a name='2327'>
<a name='2328'>
<font color=#447700>! USE K = KDRY<a name='2329'></font>
       ELSE<a name='2330'>
<a name='2331'>
          AKE = 0.0<a name='2332'>
       END IF<a name='2333'>
<font color=#447700>!  THERMAL CONDUCTIVITY<a name='2334'></font>
<a name='2335'>
    END IF<a name='2336'>
<a name='2337'>
    DF = AKE * (THKSAT - THKDRY) + THKDRY<a name='2338'>
<a name='2339'>
<a name='2340'>
  end subroutine TDFCND<a name='2341'>
<a name='2342'>
<font color=#447700>!== begin radiation ================================================================================<a name='2343'></font>
<a name='2344'>
<A NAME='RADIATION'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#RADIATION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2345'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>RADIATION</font> (parameters,VEGTYP  ,IST     ,ICE     ,NSOIL   , &amp; <font color=#447700>!in <A href='../../call_to/RADIATION.html' TARGET='index'>2</A>,<A href='../../call_from/RADIATION.html' TARGET='index'>6</A><a name='2346'></font>
                        SNEQVO  ,SNEQV   ,DT      ,COSZ    ,SNOWH   , &amp; <font color=#447700>!in<a name='2347'></font>
                        TG      ,TV      ,FSNO    ,QSNOW   ,FWET    , &amp; <font color=#447700>!in<a name='2348'></font>
                        ELAI    ,ESAI    ,SMC     ,SOLAD   ,SOLAI   , &amp; <font color=#447700>!in<a name='2349'></font>
                        FVEG    ,ILOC    ,JLOC    ,                   &amp; <font color=#447700>!in<a name='2350'></font>
                        ALBOLD  ,TAUSS   ,                            &amp; <font color=#447700>!inout<a name='2351'></font>
                        FSUN    ,LAISUN  ,LAISHA  ,PARSUN  ,PARSHA  , &amp; <font color=#447700>!out<a name='2352'></font>
                        SAV     ,SAG     ,FSR     ,FSA     ,FSRV    , &amp;<a name='2353'>
                        FSRG    ,BGAP    ,WGAP)            <font color=#447700>!out<a name='2354'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2355'></font>
  IMPLICIT NONE<a name='2356'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2357'></font>
<font color=#447700>! input<a name='2358'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='2359'>
  INTEGER, INTENT(IN)                  :: ILOC<a name='2360'>
  INTEGER, INTENT(IN)                  :: JLOC<a name='2361'>
  INTEGER, INTENT(IN)                  :: VEGTYP <font color=#447700>!vegetation type<a name='2362'></font>
  INTEGER, INTENT(IN)                  :: IST    <font color=#447700>!surface type<a name='2363'></font>
  INTEGER, INTENT(IN)                  :: ICE    <font color=#447700>!ice (ice = 1)<a name='2364'></font>
  INTEGER, INTENT(IN)                  :: NSOIL  <font color=#447700>!number of soil layers<a name='2365'></font>
<a name='2366'>
  REAL, INTENT(IN)                     :: DT     <font color=#447700>!time step [s]<a name='2367'></font>
  REAL, INTENT(IN)                     :: QSNOW  <font color=#447700>!snowfall (mm/s)<a name='2368'></font>
  REAL, INTENT(IN)                     :: SNEQVO <font color=#447700>!snow mass at last time step(mm)<a name='2369'></font>
  REAL, INTENT(IN)                     :: SNEQV  <font color=#447700>!snow mass (mm)<a name='2370'></font>
  REAL, INTENT(IN)                     :: SNOWH  <font color=#447700>!snow height (mm)<a name='2371'></font>
  REAL, INTENT(IN)                     :: COSZ   <font color=#447700>!cosine solar zenith angle (0-1)<a name='2372'></font>
  REAL, INTENT(IN)                     :: TG     <font color=#447700>!ground temperature (k)<a name='2373'></font>
  REAL, INTENT(IN)                     :: TV     <font color=#447700>!vegetation temperature (k)<a name='2374'></font>
  REAL, INTENT(IN)                     :: ELAI   <font color=#447700>!LAI, one-sided, adjusted for burying by snow<a name='2375'></font>
  REAL, INTENT(IN)                     :: ESAI   <font color=#447700>!SAI, one-sided, adjusted for burying by snow<a name='2376'></font>
  REAL, INTENT(IN)                     :: FWET   <font color=#447700>!fraction of canopy that is wet<a name='2377'></font>
  REAL, DIMENSION(1:NSOIL), INTENT(IN) :: SMC    <font color=#447700>!volumetric soil water [m3/m3]<a name='2378'></font>
  REAL, DIMENSION(1:2)    , INTENT(IN) :: SOLAD  <font color=#447700>!incoming direct solar radiation (w/m2)<a name='2379'></font>
  REAL, DIMENSION(1:2)    , INTENT(IN) :: SOLAI  <font color=#447700>!incoming diffuse solar radiation (w/m2)<a name='2380'></font>
  REAL, INTENT(IN)                     :: FSNO   <font color=#447700>!snow cover fraction (-)<a name='2381'></font>
  REAL, INTENT(IN)                     :: FVEG   <font color=#447700>!green vegetation fraction [0.0-1.0]<a name='2382'></font>
<a name='2383'>
<font color=#447700>! inout<a name='2384'></font>
  REAL,                  INTENT(INOUT) :: ALBOLD <font color=#447700>!snow albedo at last time step (CLASS type)<a name='2385'></font>
  REAL,                  INTENT(INOUT) :: TAUSS  <font color=#447700>!non-dimensional snow age.<a name='2386'></font>
<a name='2387'>
<font color=#447700>! output<a name='2388'></font>
  REAL, INTENT(OUT)                    :: FSUN   <font color=#447700>!sunlit fraction of canopy (-)<a name='2389'></font>
  REAL, INTENT(OUT)                    :: LAISUN <font color=#447700>!sunlit leaf area (-)<a name='2390'></font>
  REAL, INTENT(OUT)                    :: LAISHA <font color=#447700>!shaded leaf area (-)<a name='2391'></font>
  REAL, INTENT(OUT)                    :: PARSUN <font color=#447700>!average absorbed par for sunlit leaves (w/m2)<a name='2392'></font>
  REAL, INTENT(OUT)                    :: PARSHA <font color=#447700>!average absorbed par for shaded leaves (w/m2)<a name='2393'></font>
  REAL, INTENT(OUT)                    :: SAV    <font color=#447700>!solar radiation absorbed by vegetation (w/m2)<a name='2394'></font>
  REAL, INTENT(OUT)                    :: SAG    <font color=#447700>!solar radiation absorbed by ground (w/m2)<a name='2395'></font>
  REAL, INTENT(OUT)                    :: FSA    <font color=#447700>!total absorbed solar radiation (w/m2)<a name='2396'></font>
  REAL, INTENT(OUT)                    :: FSR    <font color=#447700>!total reflected solar radiation (w/m2)<a name='2397'></font>
<a name='2398'>
<font color=#447700>!jref:start  <a name='2399'></font>
  REAL, INTENT(OUT)                    :: FSRV    <font color=#447700>!veg. reflected solar radiation (w/m2)<a name='2400'></font>
  REAL, INTENT(OUT)                    :: FSRG    <font color=#447700>!ground reflected solar radiation (w/m2)<a name='2401'></font>
  REAL, INTENT(OUT)                    :: BGAP<a name='2402'>
  REAL, INTENT(OUT)                    :: WGAP<a name='2403'>
<font color=#447700>!jref:end  <a name='2404'></font>
<a name='2405'>
<font color=#447700>! local<a name='2406'></font>
  REAL                                 :: FAGE   <font color=#447700>!snow age function (0 - new snow)<a name='2407'></font>
  REAL, DIMENSION(1:2)                 :: ALBGRD <font color=#447700>!ground albedo (direct)<a name='2408'></font>
  REAL, DIMENSION(1:2)                 :: ALBGRI <font color=#447700>!ground albedo (diffuse)<a name='2409'></font>
  REAL, DIMENSION(1:2)                 :: ALBD   <font color=#447700>!surface albedo (direct)<a name='2410'></font>
  REAL, DIMENSION(1:2)                 :: ALBI   <font color=#447700>!surface albedo (diffuse)<a name='2411'></font>
  REAL, DIMENSION(1:2)                 :: FABD   <font color=#447700>!flux abs by veg (per unit direct flux)<a name='2412'></font>
  REAL, DIMENSION(1:2)                 :: FABI   <font color=#447700>!flux abs by veg (per unit diffuse flux)<a name='2413'></font>
  REAL, DIMENSION(1:2)                 :: FTDD   <font color=#447700>!down direct flux below veg (per unit dir flux)<a name='2414'></font>
  REAL, DIMENSION(1:2)                 :: FTID   <font color=#447700>!down diffuse flux below veg (per unit dir flux)<a name='2415'></font>
  REAL, DIMENSION(1:2)                 :: FTII   <font color=#447700>!down diffuse flux below veg (per unit dif flux)<a name='2416'></font>
<font color=#447700>!jref:start  <a name='2417'></font>
  REAL, DIMENSION(1:2)                 :: FREVI<a name='2418'>
  REAL, DIMENSION(1:2)                 :: FREVD<a name='2419'>
  REAL, DIMENSION(1:2)                 :: FREGI<a name='2420'>
  REAL, DIMENSION(1:2)                 :: FREGD<a name='2421'>
<font color=#447700>!jref:end<a name='2422'></font>
<a name='2423'>
  REAL                                 :: FSHA   <font color=#447700>!shaded fraction of canopy<a name='2424'></font>
  REAL                                 :: VAI    <font color=#447700>!total LAI + stem area index, one sided<a name='2425'></font>
<a name='2426'>
  REAL,PARAMETER :: MPE = 1.E-6<a name='2427'>
  LOGICAL VEG  <font color=#447700>!true: vegetated for surface temperature calculation<a name='2428'></font>
<a name='2429'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2430'></font>
<a name='2431'>
<font color=#447700>! surface abeldo<a name='2432'></font>
<a name='2433'>
   CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#ALBEDO'>ALBEDO</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#RADIATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALBEDO_1"> (parameters,VEGTYP ,IST    ,ICE    ,NSOIL  , &amp; <font color=#447700>!in<a name='2434'></font>
                DT     ,COSZ   ,FAGE   ,ELAI   ,ESAI   , &amp; <font color=#447700>!in<a name='2435'></font>
                TG     ,TV     ,SNOWH  ,FSNO   ,FWET   , &amp; <font color=#447700>!in<a name='2436'></font>
                SMC    ,SNEQVO ,SNEQV  ,QSNOW  ,FVEG   , &amp; <font color=#447700>!in<a name='2437'></font>
                ILOC   ,JLOC   ,                         &amp; <font color=#447700>!in<a name='2438'></font>
                ALBOLD ,TAUSS                          , &amp; <font color=#447700>!inout<a name='2439'></font>
                ALBGRD ,ALBGRI ,ALBD   ,ALBI   ,FABD   , &amp; <font color=#447700>!out<a name='2440'></font>
                FABI   ,FTDD   ,FTID   ,FTII   ,FSUN   , &amp; <font color=#447700>!)   !out<a name='2441'></font>
                FREVI  ,FREVD   ,FREGD ,FREGI  ,BGAP   , &amp; <font color=#447700>!inout<a name='2442'></font>
                WGAP)<a name='2443'>
<a name='2444'>
<font color=#447700>! surface radiation<a name='2445'></font>
<a name='2446'>
     FSHA = 1.-FSUN<a name='2447'>
     LAISUN = ELAI*FSUN<a name='2448'>
     LAISHA = ELAI*FSHA<a name='2449'>
     VAI = ELAI+ ESAI<a name='2450'>
     IF (VAI .GT. 0.) THEN<a name='2451'>
        VEG = .TRUE.<a name='2452'>
     ELSE<a name='2453'>
        VEG = .FALSE.<a name='2454'>
     END IF<a name='2455'>
<a name='2456'>
   CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#SURRAD'>SURRAD</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#RADIATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURRAD_1"> (parameters,MPE    ,FSUN   ,FSHA   ,ELAI   ,VAI    , &amp; <font color=#447700>!in<a name='2457'></font>
                LAISUN ,LAISHA ,SOLAD  ,SOLAI  ,FABD   , &amp; <font color=#447700>!in<a name='2458'></font>
                FABI   ,FTDD   ,FTID   ,FTII   ,ALBGRD , &amp; <font color=#447700>!in<a name='2459'></font>
                ALBGRI ,ALBD   ,ALBI   ,ILOC   ,JLOC   , &amp; <font color=#447700>!in<a name='2460'></font>
                PARSUN ,PARSHA ,SAV    ,SAG    ,FSA    , &amp; <font color=#447700>!out<a name='2461'></font>
                FSR    ,                                 &amp; <font color=#447700>!out<a name='2462'></font>
                FREVI  ,FREVD  ,FREGD  ,FREGI  ,FSRV   , &amp; <font color=#447700>!inout<a name='2463'></font>
                FSRG)<a name='2464'>
<a name='2465'>
  END SUBROUTINE RADIATION<a name='2466'>
<a name='2467'>
<font color=#447700>!== begin albedo ===================================================================================<a name='2468'></font>
<a name='2469'>
<A NAME='ALBEDO'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ALBEDO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2470'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ALBEDO</font> (parameters,VEGTYP ,IST    ,ICE    ,NSOIL  , &amp; <font color=#447700>!in <A href='../../call_to/ALBEDO.html' TARGET='index'>1</A>,<A href='../../call_from/ALBEDO.html' TARGET='index'>6</A><a name='2471'></font>
                     DT     ,COSZ   ,FAGE   ,ELAI   ,ESAI   , &amp; <font color=#447700>!in<a name='2472'></font>
                     TG     ,TV     ,SNOWH  ,FSNO   ,FWET   , &amp; <font color=#447700>!in<a name='2473'></font>
                     SMC    ,SNEQVO ,SNEQV  ,QSNOW  ,FVEG   , &amp; <font color=#447700>!in<a name='2474'></font>
                     ILOC   ,JLOC   ,                         &amp; <font color=#447700>!in<a name='2475'></font>
                     ALBOLD ,TAUSS                          , &amp; <font color=#447700>!inout<a name='2476'></font>
                     ALBGRD ,ALBGRI ,ALBD   ,ALBI   ,FABD   , &amp; <font color=#447700>!out<a name='2477'></font>
                     FABI   ,FTDD   ,FTID   ,FTII   ,FSUN   , &amp; <font color=#447700>!out<a name='2478'></font>
                     FREVI  ,FREVD  ,FREGD  ,FREGI  ,BGAP   , &amp; <font color=#447700>!out<a name='2479'></font>
                     WGAP)<a name='2480'>
<a name='2481'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2482'></font>
<font color=#447700>! surface albedos. also fluxes (per unit incoming direct and diffuse<a name='2483'></font>
<font color=#447700>! radiation) reflected, transmitted, and absorbed by vegetation.<a name='2484'></font>
<font color=#447700>! also sunlit fraction of the canopy.<a name='2485'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2486'></font>
  IMPLICIT NONE<a name='2487'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2488'></font>
<font color=#447700>! input<a name='2489'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='2490'>
  INTEGER,                  INTENT(IN)  :: ILOC<a name='2491'>
  INTEGER,                  INTENT(IN)  :: JLOC<a name='2492'>
  INTEGER,                  INTENT(IN)  :: NSOIL  <font color=#447700>!number of soil layers<a name='2493'></font>
  INTEGER,                  INTENT(IN)  :: VEGTYP <font color=#447700>!vegetation type<a name='2494'></font>
  INTEGER,                  INTENT(IN)  :: IST    <font color=#447700>!surface type<a name='2495'></font>
  INTEGER,                  INTENT(IN)  :: ICE    <font color=#447700>!ice (ice = 1)<a name='2496'></font>
<a name='2497'>
  REAL,                     INTENT(IN)  :: DT     <font color=#447700>!time step [sec]<a name='2498'></font>
  REAL,                     INTENT(IN)  :: QSNOW  <font color=#447700>!snowfall<a name='2499'></font>
  REAL,                     INTENT(IN)  :: COSZ   <font color=#447700>!cosine solar zenith angle for next time step<a name='2500'></font>
  REAL,                     INTENT(IN)  :: SNOWH  <font color=#447700>!snow height (mm)<a name='2501'></font>
  REAL,                     INTENT(IN)  :: TG     <font color=#447700>!ground temperature (k)<a name='2502'></font>
  REAL,                     INTENT(IN)  :: TV     <font color=#447700>!vegetation temperature (k)<a name='2503'></font>
  REAL,                     INTENT(IN)  :: ELAI   <font color=#447700>!LAI, one-sided, adjusted for burying by snow<a name='2504'></font>
  REAL,                     INTENT(IN)  :: ESAI   <font color=#447700>!SAI, one-sided, adjusted for burying by snow<a name='2505'></font>
  REAL,                     INTENT(IN)  :: FSNO   <font color=#447700>!fraction of grid covered by snow<a name='2506'></font>
  REAL,                     INTENT(IN)  :: FWET   <font color=#447700>!fraction of canopy that is wet<a name='2507'></font>
  REAL,                     INTENT(IN)  :: SNEQVO <font color=#447700>!snow mass at last time step(mm)<a name='2508'></font>
  REAL,                     INTENT(IN)  :: SNEQV  <font color=#447700>!snow mass (mm)<a name='2509'></font>
  REAL,                     INTENT(IN)  :: FVEG   <font color=#447700>!green vegetation fraction [0.0-1.0]<a name='2510'></font>
  REAL, DIMENSION(1:NSOIL), INTENT(IN)  :: SMC    <font color=#447700>!volumetric soil water (m3/m3)<a name='2511'></font>
<a name='2512'>
<font color=#447700>! inout<a name='2513'></font>
  REAL,                  INTENT(INOUT)  :: ALBOLD <font color=#447700>!snow albedo at last time step (CLASS type)<a name='2514'></font>
  REAL,                  INTENT(INOUT)  :: TAUSS  <font color=#447700>!non-dimensional snow age<a name='2515'></font>
<a name='2516'>
<font color=#447700>! output<a name='2517'></font>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: ALBGRD <font color=#447700>!ground albedo (direct)<a name='2518'></font>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: ALBGRI <font color=#447700>!ground albedo (diffuse)<a name='2519'></font>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: ALBD   <font color=#447700>!surface albedo (direct)<a name='2520'></font>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: ALBI   <font color=#447700>!surface albedo (diffuse)<a name='2521'></font>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: FABD   <font color=#447700>!flux abs by veg (per unit direct flux)<a name='2522'></font>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: FABI   <font color=#447700>!flux abs by veg (per unit diffuse flux)<a name='2523'></font>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: FTDD   <font color=#447700>!down direct flux below veg (per unit dir flux)<a name='2524'></font>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: FTID   <font color=#447700>!down diffuse flux below veg (per unit dir flux)<a name='2525'></font>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: FTII   <font color=#447700>!down diffuse flux below veg (per unit dif flux)<a name='2526'></font>
  REAL,                     INTENT(OUT) :: FSUN   <font color=#447700>!sunlit fraction of canopy (-)<a name='2527'></font>
<font color=#447700>!jref:start<a name='2528'></font>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: FREVD<a name='2529'>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: FREVI<a name='2530'>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: FREGD<a name='2531'>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: FREGI<a name='2532'>
  REAL, INTENT(OUT) :: BGAP<a name='2533'>
  REAL, INTENT(OUT) :: WGAP<a name='2534'>
<font color=#447700>!jref:end<a name='2535'></font>
<a name='2536'>
<font color=#447700>! ------------------------------------------------------------------------<a name='2537'></font>
<font color=#447700>! ------------------------ local variables -------------------------------<a name='2538'></font>
<font color=#447700>! local<a name='2539'></font>
  REAL                 :: FAGE     <font color=#447700>!snow age function<a name='2540'></font>
  REAL                 :: ALB<a name='2541'>
  INTEGER              :: IB       <font color=#447700>!indices<a name='2542'></font>
  INTEGER              :: NBAND    <font color=#447700>!number of solar radiation wave bands<a name='2543'></font>
  INTEGER              :: IC       <font color=#447700>!direct beam: ic=0; diffuse: ic=1<a name='2544'></font>
<a name='2545'>
  REAL                 :: WL       <font color=#447700>!fraction of LAI+SAI that is LAI<a name='2546'></font>
  REAL                 :: WS       <font color=#447700>!fraction of LAI+SAI that is SAI<a name='2547'></font>
  REAL                 :: MPE      <font color=#447700>!prevents overflow for division by zero<a name='2548'></font>
<a name='2549'>
  REAL, DIMENSION(1:2) :: RHO      <font color=#447700>!leaf/stem reflectance weighted by fraction LAI and SAI<a name='2550'></font>
  REAL, DIMENSION(1:2) :: TAU      <font color=#447700>!leaf/stem transmittance weighted by fraction LAI and SAI<a name='2551'></font>
  REAL, DIMENSION(1:2) :: FTDI     <font color=#447700>!down direct flux below veg per unit dif flux = 0<a name='2552'></font>
  REAL, DIMENSION(1:2) :: ALBSND   <font color=#447700>!snow albedo (direct)<a name='2553'></font>
  REAL, DIMENSION(1:2) :: ALBSNI   <font color=#447700>!snow albedo (diffuse)<a name='2554'></font>
<a name='2555'>
  REAL                 :: VAI      <font color=#447700>!ELAI+ESAI<a name='2556'></font>
  REAL                 :: GDIR     <font color=#447700>!average projected leaf/stem area in solar direction<a name='2557'></font>
  REAL                 :: EXT      <font color=#447700>!optical depth direct beam per unit leaf + stem area<a name='2558'></font>
<a name='2559'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2560'></font>
<a name='2561'>
  NBAND = 2<a name='2562'>
  MPE = 1.E-06<a name='2563'>
  BGAP = 0.<a name='2564'>
  WGAP = 0.<a name='2565'>
<a name='2566'>
<font color=#447700>! initialize output because solar radiation only done if COSZ &gt; 0<a name='2567'></font>
<a name='2568'>
  DO IB = 1, NBAND<a name='2569'>
    ALBD(IB) = 0.<a name='2570'>
    ALBI(IB) = 0.<a name='2571'>
    ALBGRD(IB) = 0.<a name='2572'>
    ALBGRI(IB) = 0.<a name='2573'>
    FABD(IB) = 0.<a name='2574'>
    FABI(IB) = 0.<a name='2575'>
    FTDD(IB) = 0.<a name='2576'>
    FTID(IB) = 0.<a name='2577'>
    FTII(IB) = 0.<a name='2578'>
    IF (IB.EQ.1) FSUN = 0.<a name='2579'>
  END DO<a name='2580'>
<a name='2581'>
  IF(COSZ &lt;= 0) GOTO 100<a name='2582'>
<a name='2583'>
<font color=#447700>! weight reflectance/transmittance by LAI and SAI<a name='2584'></font>
<a name='2585'>
  DO IB = 1, NBAND<a name='2586'>
    VAI = ELAI + ESAI<a name='2587'>
    WL  = ELAI / MAX(VAI,MPE)<a name='2588'>
    WS  = ESAI / MAX(VAI,MPE)<a name='2589'>
    RHO(IB) = MAX(parameters%RHOL(IB)*WL+parameters%RHOS(IB)*WS, MPE)<a name='2590'>
    TAU(IB) = MAX(parameters%TAUL(IB)*WL+parameters%TAUS(IB)*WS, MPE)<a name='2591'>
  END DO<a name='2592'>
<a name='2593'>
<font color=#447700>! snow age<a name='2594'></font>
<a name='2595'>
   CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOW_AGE'>SNOW_AGE</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ALBEDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOW_AGE_1"> (parameters,DT,TG,SNEQVO,SNEQV,TAUSS,FAGE)<a name='2596'>
<a name='2597'>
<font color=#447700>! snow albedos: only if COSZ &gt; 0 and FSNO &gt; 0<a name='2598'></font>
<a name='2599'>
  IF(OPT_ALB == 1) &amp;<a name='2600'>
     CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWALB_BATS'>SNOWALB_BATS</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ALBEDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWALB_BATS_1"> (parameters,NBAND, FSNO,COSZ,FAGE,ALBSND,ALBSNI)<a name='2601'>
  IF(OPT_ALB == 2) THEN<a name='2602'>
     CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWALB_CLASS'>SNOWALB_CLASS</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ALBEDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWALB_CLASS_1"> (parameters,NBAND,QSNOW,DT,ALB,ALBOLD,ALBSND,ALBSNI,ILOC,JLOC)<a name='2603'>
     ALBOLD = ALB<a name='2604'>
  END IF<a name='2605'>
<a name='2606'>
<font color=#447700>! ground surface albedo<a name='2607'></font>
<a name='2608'>
  CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#GROUNDALB'>GROUNDALB</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ALBEDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GROUNDALB_1"> (parameters,NSOIL   ,NBAND   ,ICE     ,IST     , &amp; <font color=#447700>!in<a name='2609'></font>
                  FSNO    ,SMC     ,ALBSND  ,ALBSNI  ,COSZ    , &amp; <font color=#447700>!in<a name='2610'></font>
                  TG      ,ILOC    ,JLOC    ,                   &amp; <font color=#447700>!in<a name='2611'></font>
                  ALBGRD  ,ALBGRI  )                              <font color=#447700>!out<a name='2612'></font>
<a name='2613'>
<font color=#447700>! loop over NBAND wavebands to calculate surface albedos and solar<a name='2614'></font>
<font color=#447700>! fluxes for unit incoming direct (IC=0) and diffuse flux (IC=1)<a name='2615'></font>
<a name='2616'>
  DO IB = 1, NBAND<a name='2617'>
      IC = 0      <font color=#447700>! direct<a name='2618'></font>
      CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#TWOSTREAM'>TWOSTREAM</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ALBEDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TWOSTREAM_2"> (parameters,IB     ,IC      ,VEGTYP  ,COSZ    ,VAI    , &amp; <font color=#447700>!in<a name='2619'></font>
                      FWET   ,TV      ,ALBGRD  ,ALBGRI  ,RHO    , &amp; <font color=#447700>!in<a name='2620'></font>
                      TAU    ,FVEG    ,IST     ,ILOC    ,JLOC   , &amp; <font color=#447700>!in<a name='2621'></font>
                      FABD   ,ALBD    ,FTDD    ,FTID    ,GDIR   , &amp;<font color=#447700>!)   !out<a name='2622'></font>
                      FREVD  ,FREGD   ,BGAP    ,WGAP)<a name='2623'>
<a name='2624'>
      IC = 1      <font color=#447700>! diffuse<a name='2625'></font>
      CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#TWOSTREAM'>TWOSTREAM</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ALBEDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TWOSTREAM_3"> (parameters,IB     ,IC      ,VEGTYP  ,COSZ    ,VAI    , &amp; <font color=#447700>!in<a name='2626'></font>
                      FWET   ,TV      ,ALBGRD  ,ALBGRI  ,RHO    , &amp; <font color=#447700>!in<a name='2627'></font>
                      TAU    ,FVEG    ,IST     ,ILOC    ,JLOC   , &amp; <font color=#447700>!in<a name='2628'></font>
                      FABI   ,ALBI    ,FTDI    ,FTII    ,GDIR   , &amp; <font color=#447700>!)   !out<a name='2629'></font>
                      FREVI  ,FREGI   ,BGAP    ,WGAP)<a name='2630'>
<a name='2631'>
  END DO<a name='2632'>
<a name='2633'>
<font color=#447700>! sunlit fraction of canopy. set FSUN = 0 if FSUN &lt; 0.01.<a name='2634'></font>
<a name='2635'>
  EXT = GDIR/COSZ * SQRT(1.-RHO(1)-TAU(1))<a name='2636'>
  FSUN = (1.-EXP(-EXT*VAI)) / MAX(EXT*VAI,MPE)<a name='2637'>
  EXT = FSUN<a name='2638'>
<a name='2639'>
  IF (EXT .LT. 0.01) THEN<a name='2640'>
     WL = 0.<a name='2641'>
  ELSE<a name='2642'>
     WL = EXT <a name='2643'>
  END IF<a name='2644'>
  FSUN = WL<a name='2645'>
<a name='2646'>
100 CONTINUE<a name='2647'>
<a name='2648'>
  END SUBROUTINE ALBEDO<a name='2649'>
<a name='2650'>
<font color=#447700>!== begin surrad ===================================================================================<a name='2651'></font>
<a name='2652'>
<A NAME='SURRAD'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SURRAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2653'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SURRAD</font> (parameters,MPE     ,FSUN    ,FSHA    ,ELAI    ,VAI     , &amp; <font color=#447700>!in <A href='../../call_to/SURRAD.html' TARGET='index'>1</A><a name='2654'></font>
                     LAISUN  ,LAISHA  ,SOLAD   ,SOLAI   ,FABD    , &amp; <font color=#447700>!in<a name='2655'></font>
                     FABI    ,FTDD    ,FTID    ,FTII    ,ALBGRD  , &amp; <font color=#447700>!in<a name='2656'></font>
                     ALBGRI  ,ALBD    ,ALBI    ,ILOC    ,JLOC    , &amp; <font color=#447700>!in<a name='2657'></font>
                     PARSUN  ,PARSHA  ,SAV     ,SAG     ,FSA     , &amp; <font color=#447700>!out<a name='2658'></font>
                     FSR     , &amp; <font color=#447700>!)                                       !out<a name='2659'></font>
                     FREVI   ,FREVD   ,FREGD   ,FREGI   ,FSRV    , &amp;<a name='2660'>
                     FSRG) <font color=#447700>!inout<a name='2661'></font>
<a name='2662'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2663'></font>
  IMPLICIT NONE<a name='2664'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2665'></font>
<font color=#447700>! input<a name='2666'></font>
<a name='2667'>
  type (noahmp_parameters), intent(in) :: parameters<a name='2668'>
  INTEGER, INTENT(IN)              :: ILOC<a name='2669'>
  INTEGER, INTENT(IN)              :: JLOC<a name='2670'>
  REAL, INTENT(IN)                 :: MPE     <font color=#447700>!prevents underflow errors if division by zero<a name='2671'></font>
<a name='2672'>
  REAL, INTENT(IN)                 :: FSUN    <font color=#447700>!sunlit fraction of canopy<a name='2673'></font>
  REAL, INTENT(IN)                 :: FSHA    <font color=#447700>!shaded fraction of canopy<a name='2674'></font>
  REAL, INTENT(IN)                 :: ELAI    <font color=#447700>!leaf area, one-sided<a name='2675'></font>
  REAL, INTENT(IN)                 :: VAI     <font color=#447700>!leaf + stem area, one-sided<a name='2676'></font>
  REAL, INTENT(IN)                 :: LAISUN  <font color=#447700>!sunlit leaf area index, one-sided<a name='2677'></font>
  REAL, INTENT(IN)                 :: LAISHA  <font color=#447700>!shaded leaf area index, one-sided<a name='2678'></font>
<a name='2679'>
  REAL, DIMENSION(1:2), INTENT(IN) :: SOLAD   <font color=#447700>!incoming direct solar radiation (w/m2)<a name='2680'></font>
  REAL, DIMENSION(1:2), INTENT(IN) :: SOLAI   <font color=#447700>!incoming diffuse solar radiation (w/m2)<a name='2681'></font>
  REAL, DIMENSION(1:2), INTENT(IN) :: FABD    <font color=#447700>!flux abs by veg (per unit incoming direct flux)<a name='2682'></font>
  REAL, DIMENSION(1:2), INTENT(IN) :: FABI    <font color=#447700>!flux abs by veg (per unit incoming diffuse flux)<a name='2683'></font>
  REAL, DIMENSION(1:2), INTENT(IN) :: FTDD    <font color=#447700>!down dir flux below veg (per incoming dir flux)<a name='2684'></font>
  REAL, DIMENSION(1:2), INTENT(IN) :: FTID    <font color=#447700>!down dif flux below veg (per incoming dir flux)<a name='2685'></font>
  REAL, DIMENSION(1:2), INTENT(IN) :: FTII    <font color=#447700>!down dif flux below veg (per incoming dif flux)<a name='2686'></font>
  REAL, DIMENSION(1:2), INTENT(IN) :: ALBGRD  <font color=#447700>!ground albedo (direct)<a name='2687'></font>
  REAL, DIMENSION(1:2), INTENT(IN) :: ALBGRI  <font color=#447700>!ground albedo (diffuse)<a name='2688'></font>
  REAL, DIMENSION(1:2), INTENT(IN) :: ALBD    <font color=#447700>!overall surface albedo (direct)<a name='2689'></font>
  REAL, DIMENSION(1:2), INTENT(IN) :: ALBI    <font color=#447700>!overall surface albedo (diffuse)<a name='2690'></font>
<a name='2691'>
  REAL, DIMENSION(1:2), INTENT(IN) :: FREVD    <font color=#447700>!overall surface albedo veg (direct)<a name='2692'></font>
  REAL, DIMENSION(1:2), INTENT(IN) :: FREVI    <font color=#447700>!overall surface albedo veg (diffuse)<a name='2693'></font>
  REAL, DIMENSION(1:2), INTENT(IN) :: FREGD    <font color=#447700>!overall surface albedo grd (direct)<a name='2694'></font>
  REAL, DIMENSION(1:2), INTENT(IN) :: FREGI    <font color=#447700>!overall surface albedo grd (diffuse)<a name='2695'></font>
<a name='2696'>
<font color=#447700>! output<a name='2697'></font>
<a name='2698'>
  REAL, INTENT(OUT)                :: PARSUN  <font color=#447700>!average absorbed par for sunlit leaves (w/m2)<a name='2699'></font>
  REAL, INTENT(OUT)                :: PARSHA  <font color=#447700>!average absorbed par for shaded leaves (w/m2)<a name='2700'></font>
  REAL, INTENT(OUT)                :: SAV     <font color=#447700>!solar radiation absorbed by vegetation (w/m2)<a name='2701'></font>
  REAL, INTENT(OUT)                :: SAG     <font color=#447700>!solar radiation absorbed by ground (w/m2)<a name='2702'></font>
  REAL, INTENT(OUT)                :: FSA     <font color=#447700>!total absorbed solar radiation (w/m2)<a name='2703'></font>
  REAL, INTENT(OUT)                :: FSR     <font color=#447700>!total reflected solar radiation (w/m2)<a name='2704'></font>
  REAL, INTENT(OUT)                :: FSRV    <font color=#447700>!reflected solar radiation by vegetation<a name='2705'></font>
  REAL, INTENT(OUT)                :: FSRG    <font color=#447700>!reflected solar radiation by ground<a name='2706'></font>
<a name='2707'>
<font color=#447700>! ------------------------ local variables ----------------------------------------------------<a name='2708'></font>
  INTEGER                          :: IB      <font color=#447700>!waveband number (1=vis, 2=nir)<a name='2709'></font>
  INTEGER                          :: NBAND   <font color=#447700>!number of solar radiation waveband classes<a name='2710'></font>
<a name='2711'>
  REAL                             :: ABS     <font color=#447700>!absorbed solar radiation (w/m2)<a name='2712'></font>
  REAL                             :: RNIR    <font color=#447700>!reflected solar radiation [nir] (w/m2)<a name='2713'></font>
  REAL                             :: RVIS    <font color=#447700>!reflected solar radiation [vis] (w/m2)<a name='2714'></font>
  REAL                             :: LAIFRA  <font color=#447700>!leaf area fraction of canopy<a name='2715'></font>
  REAL                             :: TRD     <font color=#447700>!transmitted solar radiation: direct (w/m2)<a name='2716'></font>
  REAL                             :: TRI     <font color=#447700>!transmitted solar radiation: diffuse (w/m2)<a name='2717'></font>
  REAL, DIMENSION(1:2)             :: CAD     <font color=#447700>!direct beam absorbed by canopy (w/m2)<a name='2718'></font>
  REAL, DIMENSION(1:2)             :: CAI     <font color=#447700>!diffuse radiation absorbed by canopy (w/m2)<a name='2719'></font>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='2720'></font>
   NBAND = 2<a name='2721'>
<a name='2722'>
<font color=#447700>! zero summed solar fluxes<a name='2723'></font>
<a name='2724'>
    SAG = 0.<a name='2725'>
    SAV = 0.<a name='2726'>
    FSA = 0.<a name='2727'>
<a name='2728'>
<font color=#447700>! loop over nband wavebands<a name='2729'></font>
<a name='2730'>
  DO IB = 1, NBAND<a name='2731'>
<a name='2732'>
<font color=#447700>! absorbed by canopy<a name='2733'></font>
<a name='2734'>
    CAD(IB) = SOLAD(IB)*FABD(IB)    <a name='2735'>
    CAI(IB) = SOLAI(IB)*FABI(IB)<a name='2736'>
    SAV     = SAV + CAD(IB) + CAI(IB)<a name='2737'>
    FSA     = FSA + CAD(IB) + CAI(IB)<a name='2738'>
 <a name='2739'>
<font color=#447700>! transmitted solar fluxes incident on ground<a name='2740'></font>
<a name='2741'>
    TRD = SOLAD(IB)*FTDD(IB)<a name='2742'>
    TRI = SOLAD(IB)*FTID(IB) + SOLAI(IB)*FTII(IB)<a name='2743'>
<a name='2744'>
<font color=#447700>! solar radiation absorbed by ground surface<a name='2745'></font>
<a name='2746'>
    ABS = TRD*(1.-ALBGRD(IB)) + TRI*(1.-ALBGRI(IB))<a name='2747'>
    SAG = SAG + ABS<a name='2748'>
    FSA = FSA + ABS<a name='2749'>
  END DO<a name='2750'>
<a name='2751'>
<font color=#447700>! partition visible canopy absorption to sunlit and shaded fractions<a name='2752'></font>
<font color=#447700>! to get average absorbed par for sunlit and shaded leaves<a name='2753'></font>
<a name='2754'>
     LAIFRA = ELAI / MAX(VAI,MPE)<a name='2755'>
     IF (FSUN .GT. 0.) THEN<a name='2756'>
        PARSUN = (CAD(1)+FSUN*CAI(1)) * LAIFRA / MAX(LAISUN,MPE)<a name='2757'>
        PARSHA = (FSHA*CAI(1))*LAIFRA / MAX(LAISHA,MPE)<a name='2758'>
     ELSE<a name='2759'>
        PARSUN = 0.<a name='2760'>
        PARSHA = (CAD(1)+CAI(1))*LAIFRA /MAX(LAISHA,MPE)<a name='2761'>
     ENDIF<a name='2762'>
<a name='2763'>
<font color=#447700>! reflected solar radiation<a name='2764'></font>
<a name='2765'>
     RVIS = ALBD(1)*SOLAD(1) + ALBI(1)*SOLAI(1)<a name='2766'>
     RNIR = ALBD(2)*SOLAD(2) + ALBI(2)*SOLAI(2)<a name='2767'>
     FSR  = RVIS + RNIR<a name='2768'>
<a name='2769'>
<font color=#447700>! reflected solar radiation of veg. and ground (combined ground)<a name='2770'></font>
     FSRV = FREVD(1)*SOLAD(1)+FREVI(1)*SOLAI(1)+FREVD(2)*SOLAD(2)+FREVI(2)*SOLAI(2)<a name='2771'>
     FSRG = FREGD(1)*SOLAD(1)+FREGI(1)*SOLAI(1)+FREGD(2)*SOLAD(2)+FREGI(2)*SOLAI(2)<a name='2772'>
<a name='2773'>
<a name='2774'>
  END SUBROUTINE SURRAD<a name='2775'>
<a name='2776'>
<font color=#447700>!== begin snow_age =================================================================================<a name='2777'></font>
<a name='2778'>
<A NAME='SNOW_AGE'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOW_AGE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2779'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOW_AGE</font> (parameters,DT,TG,SNEQVO,SNEQV,TAUSS,FAGE) <A href='../../call_to/SNOW_AGE.html' TARGET='index'>1</A><a name='2780'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2781'></font>
  IMPLICIT NONE<a name='2782'>
<font color=#447700>! ------------------------ code history ------------------------------------------------------------<a name='2783'></font>
<font color=#447700>! from BATS<a name='2784'></font>
<font color=#447700>! ------------------------ input/output variables --------------------------------------------------<a name='2785'></font>
<font color=#447700>!input<a name='2786'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='2787'>
   REAL, INTENT(IN) :: DT        <font color=#447700>!main time step (s)<a name='2788'></font>
   REAL, INTENT(IN) :: TG        <font color=#447700>!ground temperature (k)<a name='2789'></font>
   REAL, INTENT(IN) :: SNEQVO    <font color=#447700>!snow mass at last time step(mm)<a name='2790'></font>
   REAL, INTENT(IN) :: SNEQV     <font color=#447700>!snow water per unit ground area (mm)<a name='2791'></font>
<a name='2792'>
<font color=#447700>!output<a name='2793'></font>
   REAL, INTENT(OUT) :: FAGE     <font color=#447700>!snow age<a name='2794'></font>
<a name='2795'>
<font color=#447700>!input/output<a name='2796'></font>
   REAL, INTENT(INOUT) :: TAUSS      <font color=#447700>!non-dimensional snow age<a name='2797'></font>
<font color=#447700>!local<a name='2798'></font>
   REAL            :: TAGE       <font color=#447700>!total aging effects<a name='2799'></font>
   REAL            :: AGE1       <font color=#447700>!effects of grain growth due to vapor diffusion<a name='2800'></font>
   REAL            :: AGE2       <font color=#447700>!effects of grain growth at freezing of melt water<a name='2801'></font>
   REAL            :: AGE3       <font color=#447700>!effects of soot<a name='2802'></font>
   REAL            :: DELA       <font color=#447700>!temporary variable<a name='2803'></font>
   REAL            :: SGE        <font color=#447700>!temporary variable<a name='2804'></font>
   REAL            :: DELS       <font color=#447700>!temporary variable<a name='2805'></font>
   REAL            :: DELA0      <font color=#447700>!temporary variable<a name='2806'></font>
   REAL            :: ARG        <font color=#447700>!temporary variable<a name='2807'></font>
<font color=#447700>! See Yang et al. (1997) J.of Climate for detail.<a name='2808'></font>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='2809'></font>
<a name='2810'>
   IF(SNEQV.LE.0.0) THEN<a name='2811'>
          TAUSS = 0.<a name='2812'>
   ELSE IF (SNEQV.GT.800.) THEN<a name='2813'>
          TAUSS = 0.<a name='2814'>
   ELSE<a name='2815'>
          DELA0 = 1.E-6*DT<a name='2816'>
          ARG   = 5.E3*(1./TFRZ-1./TG)<a name='2817'>
          AGE1  = EXP(ARG)<a name='2818'>
          AGE2  = EXP(AMIN1(0.,10.*ARG))<a name='2819'>
          AGE3  = 0.3<a name='2820'>
          TAGE  = AGE1+AGE2+AGE3<a name='2821'>
          DELA  = DELA0*TAGE<a name='2822'>
          DELS  = AMAX1(0.0,SNEQV-SNEQVO) / parameters%SWEMX<a name='2823'>
          SGE   = (TAUSS+DELA)*(1.0-DELS)<a name='2824'>
          TAUSS = AMAX1(0.,SGE)<a name='2825'>
   ENDIF<a name='2826'>
<a name='2827'>
   FAGE= TAUSS/(TAUSS+1.)<a name='2828'>
<a name='2829'>
  END SUBROUTINE SNOW_AGE<a name='2830'>
<a name='2831'>
<font color=#447700>!== begin snowalb_bats =============================================================================<a name='2832'></font>
<a name='2833'>
<A NAME='SNOWALB_BATS'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWALB_BATS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2834'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWALB_BATS</font> (parameters,NBAND,FSNO,COSZ,FAGE,ALBSND,ALBSNI) <A href='../../call_to/SNOWALB_BATS.html' TARGET='index'>1</A><a name='2835'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2836'></font>
  IMPLICIT NONE<a name='2837'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2838'></font>
<font color=#447700>! input<a name='2839'></font>
<a name='2840'>
  type (noahmp_parameters), intent(in) :: parameters<a name='2841'>
  INTEGER,INTENT(IN) :: NBAND  <font color=#447700>!number of waveband classes<a name='2842'></font>
<a name='2843'>
  REAL,INTENT(IN) :: COSZ    <font color=#447700>!cosine solar zenith angle<a name='2844'></font>
  REAL,INTENT(IN) :: FSNO    <font color=#447700>!snow cover fraction (-)<a name='2845'></font>
  REAL,INTENT(IN) :: FAGE    <font color=#447700>!snow age correction<a name='2846'></font>
<a name='2847'>
<font color=#447700>! output<a name='2848'></font>
<a name='2849'>
  REAL, DIMENSION(1:2),INTENT(OUT) :: ALBSND <font color=#447700>!snow albedo for direct(1=vis, 2=nir)<a name='2850'></font>
  REAL, DIMENSION(1:2),INTENT(OUT) :: ALBSNI <font color=#447700>!snow albedo for diffuse<a name='2851'></font>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='2852'></font>
<a name='2853'>
<font color=#447700>! ------------------------ local variables ----------------------------------------------------<a name='2854'></font>
  INTEGER :: IB          <font color=#447700>!waveband class<a name='2855'></font>
<a name='2856'>
  REAL :: FZEN                 <font color=#447700>!zenith angle correction<a name='2857'></font>
  REAL :: CF1                  <font color=#447700>!temperary variable<a name='2858'></font>
  REAL :: SL2                  <font color=#447700>!2.*SL<a name='2859'></font>
  REAL :: SL1                  <font color=#447700>!1/SL<a name='2860'></font>
  REAL :: SL                   <font color=#447700>!adjustable parameter<a name='2861'></font>
  REAL, PARAMETER :: C1 = 0.2  <font color=#447700>!default in BATS <a name='2862'></font>
  REAL, PARAMETER :: C2 = 0.5  <font color=#447700>!default in BATS<a name='2863'></font>
<font color=#447700>!  REAL, PARAMETER :: C1 = 0.2 * 2. ! double the default to match Sleepers River's<a name='2864'></font>
<font color=#447700>!  REAL, PARAMETER :: C2 = 0.5 * 2. ! snow surface albedo (double aging effects)<a name='2865'></font>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='2866'></font>
<font color=#447700>! zero albedos for all points<a name='2867'></font>
<a name='2868'>
        ALBSND(1: NBAND) = 0.<a name='2869'>
        ALBSNI(1: NBAND) = 0.<a name='2870'>
<a name='2871'>
<font color=#447700>! when cosz &gt; 0<a name='2872'></font>
<a name='2873'>
        SL=2.0<a name='2874'>
        SL1=1./SL<a name='2875'>
        SL2=2.*SL<a name='2876'>
        CF1=((1.+SL1)/(1.+SL2*COSZ)-SL1)<a name='2877'>
        FZEN=AMAX1(CF1,0.)<a name='2878'>
<a name='2879'>
        ALBSNI(1)=0.95*(1.-C1*FAGE)         <a name='2880'>
        ALBSNI(2)=0.65*(1.-C2*FAGE)        <a name='2881'>
<a name='2882'>
        ALBSND(1)=ALBSNI(1)+0.4*FZEN*(1.-ALBSNI(1))    <font color=#447700>!  vis direct<a name='2883'></font>
        ALBSND(2)=ALBSNI(2)+0.4*FZEN*(1.-ALBSNI(2))    <font color=#447700>!  nir direct<a name='2884'></font>
<a name='2885'>
  END SUBROUTINE SNOWALB_BATS<a name='2886'>
<a name='2887'>
<font color=#447700>!== begin snowalb_class ============================================================================<a name='2888'></font>
<a name='2889'>
<A NAME='SNOWALB_CLASS'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWALB_CLASS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2890'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWALB_CLASS</font> (parameters,NBAND,QSNOW,DT,ALB,ALBOLD,ALBSND,ALBSNI,ILOC,JLOC) <A href='../../call_to/SNOWALB_CLASS.html' TARGET='index'>1</A><a name='2891'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2892'></font>
  IMPLICIT NONE<a name='2893'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2894'></font>
<font color=#447700>! input<a name='2895'></font>
<a name='2896'>
  type (noahmp_parameters), intent(in) :: parameters<a name='2897'>
  INTEGER,INTENT(IN) :: ILOC <font color=#447700>!grid index<a name='2898'></font>
  INTEGER,INTENT(IN) :: JLOC <font color=#447700>!grid index<a name='2899'></font>
  INTEGER,INTENT(IN) :: NBAND  <font color=#447700>!number of waveband classes<a name='2900'></font>
<a name='2901'>
  REAL,INTENT(IN) :: QSNOW     <font color=#447700>!snowfall (mm/s)<a name='2902'></font>
  REAL,INTENT(IN) :: DT        <font color=#447700>!time step (sec)<a name='2903'></font>
  REAL,INTENT(IN) :: ALBOLD    <font color=#447700>!snow albedo at last time step<a name='2904'></font>
<a name='2905'>
<font color=#447700>! in &amp; out<a name='2906'></font>
<a name='2907'>
  REAL,                INTENT(INOUT) :: ALB        <font color=#447700>! <a name='2908'></font>
<font color=#447700>! output<a name='2909'></font>
<a name='2910'>
  REAL, DIMENSION(1:2),INTENT(OUT) :: ALBSND <font color=#447700>!snow albedo for direct(1=vis, 2=nir)<a name='2911'></font>
  REAL, DIMENSION(1:2),INTENT(OUT) :: ALBSNI <font color=#447700>!snow albedo for diffuse<a name='2912'></font>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='2913'></font>
<a name='2914'>
<font color=#447700>! ------------------------ local variables ----------------------------------------------------<a name='2915'></font>
  INTEGER :: IB          <font color=#447700>!waveband class<a name='2916'></font>
<a name='2917'>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='2918'></font>
<font color=#447700>! zero albedos for all points<a name='2919'></font>
<a name='2920'>
        ALBSND(1: NBAND) = 0.<a name='2921'>
        ALBSNI(1: NBAND) = 0.<a name='2922'>
<a name='2923'>
<font color=#447700>! when cosz &gt; 0<a name='2924'></font>
<a name='2925'>
         ALB = 0.55 + (ALBOLD-0.55) * EXP(-0.01*DT/3600.)<a name='2926'>
<a name='2927'>
<font color=#447700>! 1 mm fresh snow(SWE) -- 10mm snow depth, assumed the fresh snow density 100kg/m3<a name='2928'></font>
<font color=#447700>! here assume 1cm snow depth will fully cover the old snow<a name='2929'></font>
<a name='2930'>
         IF (QSNOW &gt; 0.) then<a name='2931'>
           ALB = ALB + MIN(QSNOW,parameters%SWEMX/DT) * (0.84-ALB)/(parameters%SWEMX/DT)<a name='2932'>
         ENDIF<a name='2933'>
<a name='2934'>
         ALBSNI(1)= ALB         <font color=#447700>! vis diffuse<a name='2935'></font>
         ALBSNI(2)= ALB         <font color=#447700>! nir diffuse<a name='2936'></font>
         ALBSND(1)= ALB         <font color=#447700>! vis direct<a name='2937'></font>
         ALBSND(2)= ALB         <font color=#447700>! nir direct<a name='2938'></font>
<a name='2939'>
  END SUBROUTINE SNOWALB_CLASS<a name='2940'>
<a name='2941'>
<font color=#447700>!== begin groundalb ================================================================================<a name='2942'></font>
<a name='2943'>
<A NAME='GROUNDALB'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#GROUNDALB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2944'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>GROUNDALB</font> (parameters,NSOIL   ,NBAND   ,ICE     ,IST     , &amp; <font color=#447700>!in <A href='../../call_to/GROUNDALB.html' TARGET='index'>1</A><a name='2945'></font>
                        FSNO    ,SMC     ,ALBSND  ,ALBSNI  ,COSZ    , &amp; <font color=#447700>!in<a name='2946'></font>
                        TG      ,ILOC    ,JLOC    ,                   &amp; <font color=#447700>!in<a name='2947'></font>
                        ALBGRD  ,ALBGRI  )                              <font color=#447700>!out<a name='2948'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2949'></font>
  IMPLICIT NONE<a name='2950'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2951'></font>
<font color=#447700>!input<a name='2952'></font>
<a name='2953'>
  type (noahmp_parameters), intent(in) :: parameters<a name='2954'>
  INTEGER,                  INTENT(IN)  :: ILOC   <font color=#447700>!grid index<a name='2955'></font>
  INTEGER,                  INTENT(IN)  :: JLOC   <font color=#447700>!grid index<a name='2956'></font>
  INTEGER,                  INTENT(IN)  :: NSOIL  <font color=#447700>!number of soil layers<a name='2957'></font>
  INTEGER,                  INTENT(IN)  :: NBAND  <font color=#447700>!number of solar radiation waveband classes<a name='2958'></font>
  INTEGER,                  INTENT(IN)  :: ICE    <font color=#447700>!value of ist for land ice<a name='2959'></font>
  INTEGER,                  INTENT(IN)  :: IST    <font color=#447700>!surface type<a name='2960'></font>
  REAL,                     INTENT(IN)  :: FSNO   <font color=#447700>!fraction of surface covered with snow (-)<a name='2961'></font>
  REAL,                     INTENT(IN)  :: TG     <font color=#447700>!ground temperature (k)<a name='2962'></font>
  REAL,                     INTENT(IN)  :: COSZ   <font color=#447700>!cosine solar zenith angle (0-1)<a name='2963'></font>
  REAL, DIMENSION(1:NSOIL), INTENT(IN)  :: SMC    <font color=#447700>!volumetric soil water content (m3/m3)<a name='2964'></font>
  REAL, DIMENSION(1:    2), INTENT(IN)  :: ALBSND <font color=#447700>!direct beam snow albedo (vis, nir)<a name='2965'></font>
  REAL, DIMENSION(1:    2), INTENT(IN)  :: ALBSNI <font color=#447700>!diffuse snow albedo (vis, nir)<a name='2966'></font>
<a name='2967'>
<font color=#447700>!output<a name='2968'></font>
<a name='2969'>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: ALBGRD <font color=#447700>!ground albedo (direct beam: vis, nir)<a name='2970'></font>
  REAL, DIMENSION(1:    2), INTENT(OUT) :: ALBGRI <font color=#447700>!ground albedo (diffuse: vis, nir)<a name='2971'></font>
<a name='2972'>
<font color=#447700>!local <a name='2973'></font>
<a name='2974'>
  INTEGER                               :: IB     <font color=#447700>!waveband number (1=vis, 2=nir)<a name='2975'></font>
  REAL                                  :: INC    <font color=#447700>!soil water correction factor for soil albedo<a name='2976'></font>
  REAL                                  :: ALBSOD <font color=#447700>!soil albedo (direct)<a name='2977'></font>
  REAL                                  :: ALBSOI <font color=#447700>!soil albedo (diffuse)<a name='2978'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='2979'></font>
<a name='2980'>
  DO IB = 1, NBAND<a name='2981'>
        INC = MAX(0.11-0.40*SMC(1), 0.)<a name='2982'>
        IF (IST .EQ. 1)  THEN                     <font color=#447700>!soil<a name='2983'></font>
           ALBSOD = MIN(parameters%ALBSAT(IB)+INC,parameters%ALBDRY(IB))<a name='2984'>
           ALBSOI = ALBSOD<a name='2985'>
        ELSE IF (TG .GT. TFRZ) THEN               <font color=#447700>!unfrozen lake, wetland<a name='2986'></font>
           ALBSOD = 0.06/(MAX(0.01,COSZ)**1.7 + 0.15)<a name='2987'>
           ALBSOI = 0.06<a name='2988'>
        ELSE                                      <font color=#447700>!frozen lake, wetland<a name='2989'></font>
           ALBSOD = parameters%ALBLAK(IB)<a name='2990'>
           ALBSOI = ALBSOD<a name='2991'>
        END IF<a name='2992'>
<a name='2993'>
<font color=#447700>! increase desert and semi-desert albedos<a name='2994'></font>
<a name='2995'>
<font color=#447700>!        IF (IST .EQ. 1 .AND. ISC .EQ. 9) THEN<a name='2996'></font>
<font color=#447700>!           ALBSOD = ALBSOD + 0.10<a name='2997'></font>
<font color=#447700>!           ALBSOI = ALBSOI + 0.10<a name='2998'></font>
<font color=#447700>!        end if<a name='2999'></font>
<a name='3000'>
        ALBGRD(IB) = ALBSOD*(1.-FSNO) + ALBSND(IB)*FSNO<a name='3001'>
        ALBGRI(IB) = ALBSOI*(1.-FSNO) + ALBSNI(IB)*FSNO<a name='3002'>
  END DO<a name='3003'>
<a name='3004'>
  END SUBROUTINE GROUNDALB<a name='3005'>
<a name='3006'>
<font color=#447700>!== begin twostream ================================================================================<a name='3007'></font>
<a name='3008'>
<A NAME='TWOSTREAM'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#TWOSTREAM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3009'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>TWOSTREAM</font> (parameters,IB     ,IC      ,VEGTYP  ,COSZ    ,VAI    , &amp; <font color=#447700>!in <A href='../../call_to/TWOSTREAM.html' TARGET='index'>3</A>,<A href='../../call_from/TWOSTREAM.html' TARGET='index'>3</A><a name='3010'></font>
                        FWET   ,T       ,ALBGRD  ,ALBGRI  ,RHO    , &amp; <font color=#447700>!in<a name='3011'></font>
                        TAU    ,FVEG    ,IST     ,ILOC    ,JLOC   , &amp; <font color=#447700>!in<a name='3012'></font>
                        FAB    ,FRE     ,FTD     ,FTI     ,GDIR   , &amp; <font color=#447700>!)   !out<a name='3013'></font>
                        FREV   ,FREG    ,BGAP    ,WGAP)<a name='3014'>
<a name='3015'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='3016'></font>
<font color=#447700>! use two-stream approximation of Dickinson (1983) Adv Geophysics<a name='3017'></font>
<font color=#447700>! 25:305-353 and Sellers (1985) Int J Remote Sensing 6:1335-1372<a name='3018'></font>
<font color=#447700>! to calculate fluxes absorbed by vegetation, reflected by vegetation,<a name='3019'></font>
<font color=#447700>! and transmitted through vegetation for unit incoming direct or diffuse<a name='3020'></font>
<font color=#447700>! flux given an underlying surface with known albedo.<a name='3021'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='3022'></font>
  IMPLICIT NONE<a name='3023'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='3024'></font>
<font color=#447700>! input<a name='3025'></font>
<a name='3026'>
  type (noahmp_parameters), intent(in) :: parameters<a name='3027'>
   INTEGER,              INTENT(IN)  :: ILOC    <font color=#447700>!grid index<a name='3028'></font>
   INTEGER,              INTENT(IN)  :: JLOC    <font color=#447700>!grid index<a name='3029'></font>
   INTEGER,              INTENT(IN)  :: IST     <font color=#447700>!surface type<a name='3030'></font>
   INTEGER,              INTENT(IN)  :: IB      <font color=#447700>!waveband number<a name='3031'></font>
   INTEGER,              INTENT(IN)  :: IC      <font color=#447700>!0=unit incoming direct; 1=unit incoming diffuse<a name='3032'></font>
   INTEGER,              INTENT(IN)  :: VEGTYP  <font color=#447700>!vegetation type<a name='3033'></font>
<a name='3034'>
   REAL,                 INTENT(IN)  :: COSZ    <font color=#447700>!cosine of direct zenith angle (0-1)<a name='3035'></font>
   REAL,                 INTENT(IN)  :: VAI     <font color=#447700>!one-sided leaf+stem area index (m2/m2)<a name='3036'></font>
   REAL,                 INTENT(IN)  :: FWET    <font color=#447700>!fraction of lai, sai that is wetted (-)<a name='3037'></font>
   REAL,                 INTENT(IN)  :: T       <font color=#447700>!surface temperature (k)<a name='3038'></font>
<a name='3039'>
   REAL, DIMENSION(1:2), INTENT(IN)  :: ALBGRD  <font color=#447700>!direct  albedo of underlying surface (-)<a name='3040'></font>
   REAL, DIMENSION(1:2), INTENT(IN)  :: ALBGRI  <font color=#447700>!diffuse albedo of underlying surface (-)<a name='3041'></font>
   REAL, DIMENSION(1:2), INTENT(IN)  :: RHO     <font color=#447700>!leaf+stem reflectance<a name='3042'></font>
   REAL, DIMENSION(1:2), INTENT(IN)  :: TAU     <font color=#447700>!leaf+stem transmittance<a name='3043'></font>
   REAL,                 INTENT(IN)  :: FVEG    <font color=#447700>!green vegetation fraction [0.0-1.0]<a name='3044'></font>
<a name='3045'>
<font color=#447700>! output<a name='3046'></font>
<a name='3047'>
   REAL, DIMENSION(1:2), INTENT(OUT) :: FAB     <font color=#447700>!flux abs by veg layer (per unit incoming flux)<a name='3048'></font>
   REAL, DIMENSION(1:2), INTENT(OUT) :: FRE     <font color=#447700>!flux refl above veg layer (per unit incoming flux)<a name='3049'></font>
   REAL, DIMENSION(1:2), INTENT(OUT) :: FTD     <font color=#447700>!down dir flux below veg layer (per unit in flux)<a name='3050'></font>
   REAL, DIMENSION(1:2), INTENT(OUT) :: FTI     <font color=#447700>!down dif flux below veg layer (per unit in flux)<a name='3051'></font>
   REAL,                 INTENT(OUT) :: GDIR    <font color=#447700>!projected leaf+stem area in solar direction<a name='3052'></font>
   REAL, DIMENSION(1:2), INTENT(OUT) :: FREV    <font color=#447700>!flux reflected by veg layer   (per unit incoming flux) <a name='3053'></font>
   REAL, DIMENSION(1:2), INTENT(OUT) :: FREG    <font color=#447700>!flux reflected by ground (per unit incoming flux)<a name='3054'></font>
<a name='3055'>
<font color=#447700>! local<a name='3056'></font>
   REAL                              :: OMEGA   <font color=#447700>!fraction of intercepted radiation that is scattered<a name='3057'></font>
   REAL                              :: OMEGAL  <font color=#447700>!omega for leaves<a name='3058'></font>
   REAL                              :: BETAI   <font color=#447700>!upscatter parameter for diffuse radiation<a name='3059'></font>
   REAL                              :: BETAIL  <font color=#447700>!betai for leaves<a name='3060'></font>
   REAL                              :: BETAD   <font color=#447700>!upscatter parameter for direct beam radiation<a name='3061'></font>
   REAL                              :: BETADL  <font color=#447700>!betad for leaves<a name='3062'></font>
   REAL                              :: EXT     <font color=#447700>!optical depth of direct beam per unit leaf area<a name='3063'></font>
   REAL                              :: AVMU    <font color=#447700>!average diffuse optical depth<a name='3064'></font>
<a name='3065'>
   REAL                              :: COSZI   <font color=#447700>!0.001 &lt;= cosz &lt;= 1.000<a name='3066'></font>
   REAL                              :: ASU     <font color=#447700>!single scattering albedo<a name='3067'></font>
   REAL                              :: CHIL    <font color=#447700>! -0.4 &lt;= xl &lt;= 0.6<a name='3068'></font>
<a name='3069'>
   REAL                              :: TMP0,TMP1,TMP2,TMP3,TMP4,TMP5,TMP6,TMP7,TMP8,TMP9<a name='3070'>
   REAL                              :: P1,P2,P3,P4,S1,S2,U1,U2,U3<a name='3071'>
   REAL                              :: B,C,D,D1,D2,F,H,H1,H2,H3,H4,H5,H6,H7,H8,H9,H10<a name='3072'>
   REAL                              :: PHI1,PHI2,SIGMA<a name='3073'>
   REAL                              :: FTDS,FTIS,FRES<a name='3074'>
   REAL                              :: DENFVEG<a name='3075'>
   REAL                              :: VAI_SPREAD<a name='3076'>
<font color=#447700>!jref:start<a name='3077'></font>
   REAL                              :: FREVEG,FREBAR,FTDVEG,FTIVEG,FTDBAR,FTIBAR<a name='3078'>
   REAL                              :: THETAZ<a name='3079'>
<font color=#447700>!jref:end   <a name='3080'></font>
<a name='3081'>
<font color=#447700>!  variables for the modified two-stream scheme<a name='3082'></font>
<font color=#447700>!  Niu and Yang (2004), JGR<a name='3083'></font>
<a name='3084'>
   REAL, PARAMETER :: PAI = 3.14159265 <a name='3085'>
   REAL :: HD       <font color=#447700>!crown depth (m)<a name='3086'></font>
   REAL :: BB       <font color=#447700>!vertical crown radius (m)<a name='3087'></font>
   REAL :: THETAP   <font color=#447700>!angle conversion from SZA <a name='3088'></font>
   REAL :: FA       <font color=#447700>!foliage volume density (m-1)<a name='3089'></font>
   REAL :: NEWVAI   <font color=#447700>!effective LSAI (-)<a name='3090'></font>
<a name='3091'>
   REAL,INTENT(INOUT) :: BGAP     <font color=#447700>!between canopy gap fraction for beam (-)<a name='3092'></font>
   REAL,INTENT(INOUT) :: WGAP     <font color=#447700>!within canopy gap fraction for beam (-)<a name='3093'></font>
<a name='3094'>
   REAL :: KOPEN    <font color=#447700>!gap fraction for diffue light (-)<a name='3095'></font>
   REAL :: GAP      <font color=#447700>!total gap fraction for beam ( &lt;=1-shafac )<a name='3096'></font>
<a name='3097'>
<font color=#447700>! -----------------------------------------------------------------<a name='3098'></font>
<font color=#447700>! compute within and between gaps<a name='3099'></font>
     VAI_SPREAD = VAI<a name='3100'>
     if(VAI == 0.0) THEN<a name='3101'>
         GAP     = 1.0<a name='3102'>
         KOPEN   = 1.0<a name='3103'>
     ELSE<a name='3104'>
         IF(OPT_RAD == 1) THEN<a name='3105'>
	   DENFVEG = -LOG(MAX(1.0-FVEG,0.01))/(PAI*parameters%RC**2)<a name='3106'>
           HD      = parameters%HVT - parameters%HVB<a name='3107'>
           BB      = 0.5 * HD           <a name='3108'>
           THETAP  = ATAN(BB/parameters%RC * TAN(ACOS(MAX(0.01,COSZ))) )<a name='3109'>
           <font color=#447700>! BGAP    = EXP(-parameters%DEN * PAI * parameters%RC**2/COS(THETAP) )<a name='3110'></font>
           BGAP    = EXP(-DENFVEG * PAI * parameters%RC**2/COS(THETAP) )<a name='3111'>
           FA      = VAI/(1.33 * PAI * parameters%RC**3.0 *(BB/parameters%RC)*DENFVEG)<a name='3112'>
           NEWVAI  = HD*FA<a name='3113'>
           WGAP    = (1.0-BGAP) * EXP(-0.5*NEWVAI/COSZ)<a name='3114'>
           GAP     = MIN(1.0-FVEG, BGAP+WGAP)<a name='3115'>
<a name='3116'>
           KOPEN   = 0.05<a name='3117'>
         END IF<a name='3118'>
<a name='3119'>
         IF(OPT_RAD == 2) THEN<a name='3120'>
           GAP     = 0.0<a name='3121'>
           KOPEN   = 0.0<a name='3122'>
         END IF<a name='3123'>
<a name='3124'>
         IF(OPT_RAD == 3) THEN<a name='3125'>
           GAP     = 1.0-FVEG<a name='3126'>
           KOPEN   = 1.0-FVEG<a name='3127'>
         END IF<a name='3128'>
     end if<a name='3129'>
<a name='3130'>
<font color=#447700>! calculate two-stream parameters OMEGA, BETAD, BETAI, AVMU, GDIR, EXT.<a name='3131'></font>
<font color=#447700>! OMEGA, BETAD, BETAI are adjusted for snow. values for OMEGA*BETAD<a name='3132'></font>
<font color=#447700>! and OMEGA*BETAI are calculated and then divided by the new OMEGA<a name='3133'></font>
<font color=#447700>! because the product OMEGA*BETAI, OMEGA*BETAD is used in solution.<a name='3134'></font>
<font color=#447700>! also, the transmittances and reflectances (TAU, RHO) are linear<a name='3135'></font>
<font color=#447700>! weights of leaf and stem values.<a name='3136'></font>
<a name='3137'>
     COSZI  = MAX(0.001, COSZ)<a name='3138'>
     CHIL   = MIN( MAX(parameters%XL, -0.4), 0.6)<a name='3139'>
     IF (ABS(CHIL) .LE. 0.01) CHIL = 0.01<a name='3140'>
     PHI1   = 0.5 - 0.633*CHIL - 0.330*CHIL*CHIL<a name='3141'>
     PHI2   = 0.877 * (1.-2.*PHI1)<a name='3142'>
     GDIR   = PHI1 + PHI2*COSZI<a name='3143'>
     EXT    = GDIR/COSZI<a name='3144'>
     AVMU   = ( 1. - PHI1/PHI2 * LOG((PHI1+PHI2)/PHI1) ) / PHI2<a name='3145'>
     OMEGAL = RHO(IB) + TAU(IB)<a name='3146'>
     TMP0   = GDIR + PHI2*COSZI<a name='3147'>
     TMP1   = PHI1*COSZI<a name='3148'>
     ASU    = 0.5*OMEGAL*GDIR/TMP0 * ( 1.-TMP1/TMP0*LOG((TMP1+TMP0)/TMP1) )<a name='3149'>
     BETADL = (1.+AVMU*EXT)/(OMEGAL*AVMU*EXT)*ASU<a name='3150'>
     BETAIL = 0.5 * ( RHO(IB)+TAU(IB) + (RHO(IB)-TAU(IB))   &amp;<a name='3151'>
            * ((1.+CHIL)/2.)**2 ) / OMEGAL<a name='3152'>
<a name='3153'>
<font color=#447700>! adjust omega, betad, and betai for intercepted snow<a name='3154'></font>
<a name='3155'>
     IF (T .GT. TFRZ) THEN                                <font color=#447700>!no snow<a name='3156'></font>
        TMP0 = OMEGAL<a name='3157'>
        TMP1 = BETADL<a name='3158'>
        TMP2 = BETAIL<a name='3159'>
     ELSE<a name='3160'>
        TMP0 =   (1.-FWET)*OMEGAL        + FWET*parameters%OMEGAS(IB)<a name='3161'>
        TMP1 = ( (1.-FWET)*OMEGAL*BETADL + FWET*parameters%OMEGAS(IB)*parameters%BETADS ) / TMP0<a name='3162'>
        TMP2 = ( (1.-FWET)*OMEGAL*BETAIL + FWET*parameters%OMEGAS(IB)*parameters%BETAIS ) / TMP0<a name='3163'>
     END IF<a name='3164'>
<a name='3165'>
     OMEGA = TMP0<a name='3166'>
     BETAD = TMP1<a name='3167'>
     BETAI = TMP2<a name='3168'>
<a name='3169'>
<font color=#447700>! absorbed, reflected, transmitted fluxes per unit incoming radiation<a name='3170'></font>
<a name='3171'>
     B = 1. - OMEGA + OMEGA*BETAI<a name='3172'>
     C = OMEGA*BETAI<a name='3173'>
     TMP0 = AVMU*EXT<a name='3174'>
     D = TMP0 * OMEGA*BETAD<a name='3175'>
     F = TMP0 * OMEGA*(1.-BETAD)<a name='3176'>
     TMP1 = B*B - C*C<a name='3177'>
     H = SQRT(TMP1) / AVMU<a name='3178'>
     SIGMA = TMP0*TMP0 - TMP1<a name='3179'>
     if ( ABS (SIGMA) &lt; 1.e-6 ) SIGMA = SIGN(1.e-6,SIGMA)<a name='3180'>
     P1 = B + AVMU*H<a name='3181'>
     P2 = B - AVMU*H<a name='3182'>
     P3 = B + TMP0<a name='3183'>
     P4 = B - TMP0<a name='3184'>
     S1 = EXP(-H*VAI)<a name='3185'>
     S2 = EXP(-EXT*VAI)<a name='3186'>
     IF (IC .EQ. 0) THEN<a name='3187'>
        U1 = B - C/ALBGRD(IB)<a name='3188'>
        U2 = B - C*ALBGRD(IB)<a name='3189'>
        U3 = F + C*ALBGRD(IB)<a name='3190'>
     ELSE<a name='3191'>
        U1 = B - C/ALBGRI(IB)<a name='3192'>
        U2 = B - C*ALBGRI(IB)<a name='3193'>
        U3 = F + C*ALBGRI(IB)<a name='3194'>
     END IF<a name='3195'>
     TMP2 = U1 - AVMU*H<a name='3196'>
     TMP3 = U1 + AVMU*H<a name='3197'>
     D1 = P1*TMP2/S1 - P2*TMP3*S1<a name='3198'>
     TMP4 = U2 + AVMU*H<a name='3199'>
     TMP5 = U2 - AVMU*H<a name='3200'>
     D2 = TMP4/S1 - TMP5*S1<a name='3201'>
     H1 = -D*P4 - C*F<a name='3202'>
     TMP6 = D - H1*P3/SIGMA<a name='3203'>
     TMP7 = ( D - C - H1/SIGMA*(U1+TMP0) ) * S2<a name='3204'>
     H2 = ( TMP6*TMP2/S1 - P2*TMP7 ) / D1<a name='3205'>
     H3 = - ( TMP6*TMP3*S1 - P1*TMP7 ) / D1<a name='3206'>
     H4 = -F*P3 - C*D<a name='3207'>
     TMP8 = H4/SIGMA<a name='3208'>
     TMP9 = ( U3 - TMP8*(U2-TMP0) ) * S2<a name='3209'>
     H5 = - ( TMP8*TMP4/S1 + TMP9 ) / D2<a name='3210'>
     H6 = ( TMP8*TMP5*S1 + TMP9 ) / D2<a name='3211'>
     H7 = (C*TMP2) / (D1*S1)<a name='3212'>
     H8 = (-C*TMP3*S1) / D1<a name='3213'>
     H9 = TMP4 / (D2*S1)<a name='3214'>
     H10 = (-TMP5*S1) / D2<a name='3215'>
<a name='3216'>
<font color=#447700>! downward direct and diffuse fluxes below vegetation<a name='3217'></font>
<font color=#447700>! Niu and Yang (2004), JGR.<a name='3218'></font>
<a name='3219'>
     IF (IC .EQ. 0) THEN<a name='3220'>
        FTDS = S2                           *(1.0-GAP) + GAP<a name='3221'>
        FTIS = (H4*S2/SIGMA + H5*S1 + H6/S1)*(1.0-GAP)<a name='3222'>
     ELSE<a name='3223'>
        FTDS = 0.<a name='3224'>
        FTIS = (H9*S1 + H10/S1)*(1.0-KOPEN) + KOPEN<a name='3225'>
     END IF<a name='3226'>
     FTD(IB) = FTDS<a name='3227'>
     FTI(IB) = FTIS<a name='3228'>
<a name='3229'>
<font color=#447700>! flux reflected by the surface (veg. and ground)<a name='3230'></font>
<a name='3231'>
     IF (IC .EQ. 0) THEN<a name='3232'>
        FRES   = (H1/SIGMA + H2 + H3)*(1.0-GAP  ) + ALBGRD(IB)*GAP        <a name='3233'>
        FREVEG = (H1/SIGMA + H2 + H3)*(1.0-GAP  ) <a name='3234'>
        FREBAR = ALBGRD(IB)*GAP                   <font color=#447700>!jref - separate veg. and ground reflection<a name='3235'></font>
     ELSE<a name='3236'>
        FRES   = (H7 + H8) *(1.0-KOPEN) + ALBGRI(IB)*KOPEN        <a name='3237'>
        FREVEG = (H7 + H8) *(1.0-KOPEN) + ALBGRI(IB)*KOPEN<a name='3238'>
        FREBAR = 0                                <font color=#447700>!jref - separate veg. and ground reflection<a name='3239'></font>
     END IF<a name='3240'>
     FRE(IB) = FRES<a name='3241'>
<a name='3242'>
     FREV(IB) = FREVEG <a name='3243'>
     FREG(IB) = FREBAR <a name='3244'>
<a name='3245'>
<font color=#447700>! flux absorbed by vegetation<a name='3246'></font>
<a name='3247'>
     FAB(IB) = 1. - FRE(IB) - (1.-ALBGRD(IB))*FTD(IB) &amp;<a name='3248'>
                            - (1.-ALBGRI(IB))*FTI(IB)<a name='3249'>
<a name='3250'>
<font color=#447700>!if(iloc == 1.and.jloc ==  2) then<a name='3251'></font>
<font color=#447700>!  write(*,'(a7,2i2,5(a6,f8.4),2(a9,f8.4))') "ib,ic: ",ib,ic," GAP: ",GAP," FTD: ",FTD(IB)," FTI: ",FTI(IB)," FRE: ", &amp;<a name='3252'></font>
<font color=#447700>!         FRE(IB)," FAB: ",FAB(IB)," ALBGRD: ",ALBGRD(IB)," ALBGRI: ",ALBGRI(IB)<a name='3253'></font>
<font color=#447700>!end if<a name='3254'></font>
<a name='3255'>
  END SUBROUTINE TWOSTREAM<a name='3256'>
<a name='3257'>
<font color=#447700>!== begin vege_flux ================================================================================<a name='3258'></font>
<a name='3259'>
<A NAME='VEGE_FLUX'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3260'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>VEGE_FLUX</font>(parameters,NSNOW   ,NSOIL   ,ISNOW   ,VEGTYP  ,VEG     , &amp; <font color=#447700>!in <A href='../../call_to/VEGE_FLUX.html' TARGET='index'>1</A>,<A href='../../call_from/VEGE_FLUX.html' TARGET='index'>16</A><a name='3261'></font>
                       DT      ,SAV     ,SAG     ,LWDN    ,UR      , &amp; <font color=#447700>!in<a name='3262'></font>
                       UU      ,VV      ,SFCTMP  ,THAIR   ,QAIR    , &amp; <font color=#447700>!in<a name='3263'></font>
                       EAIR    ,RHOAIR  ,SNOWH   ,VAI     ,GAMMAV   ,GAMMAG,  &amp; <font color=#447700>!in<a name='3264'></font>
                       FWET    ,LAISUN  ,LAISHA  ,CWP     ,DZSNSO  , &amp; <font color=#447700>!in<a name='3265'></font>
                       ZLVL    ,ZPD     ,Z0M     ,FVEG    , &amp; <font color=#447700>!in<a name='3266'></font>
                       Z0MG    ,EMV     ,EMG     ,CANLIQ  ,FSNO,          &amp; <font color=#447700>!in<a name='3267'></font>
                       CANICE  ,STC     ,DF      ,RSSUN   ,RSSHA   , &amp; <font color=#447700>!in<a name='3268'></font>
                       RSURF   ,LATHEAV ,LATHEAG  ,PARSUN  ,PARSHA  ,IGS     , &amp; <font color=#447700>!in<a name='3269'></font>
                       FOLN    ,CO2AIR  ,O2AIR   ,BTRAN   ,SFCPRS  , &amp; <font color=#447700>!in<a name='3270'></font>
                       RHSUR   ,ILOC    ,JLOC    ,Q2      ,PAHV    ,PAHG     , &amp; <font color=#447700>!in<a name='3271'></font>
                       EAH     ,TAH     ,TV      ,TG      ,CM      , &amp; <font color=#447700>!inout<a name='3272'></font>
                       CH      ,DX      ,DZ8W    ,                   &amp; <font color=#447700>!<a name='3273'></font>
                       TAUXV   ,TAUYV   ,IRG     ,IRC     ,SHG     , &amp; <font color=#447700>!out<a name='3274'></font>
                       SHC     ,EVG     ,EVC     ,TR      ,GH      , &amp; <font color=#447700>!out<a name='3275'></font>
                       T2MV    ,PSNSUN  ,PSNSHA  ,                   &amp; <font color=#447700>!out<a name='3276'></font>
                       QC      ,QSFC    ,PSFC    ,                   &amp; <font color=#447700>!in<a name='3277'></font>
                       Q2V     ,CAH2    ,CHLEAF  ,CHUC    )            <font color=#447700>!inout <a name='3278'></font>
<a name='3279'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='3280'></font>
<font color=#447700>! use newton-raphson iteration to solve for vegetation (tv) and<a name='3281'></font>
<font color=#447700>! ground (tg) temperatures that balance the surface energy budgets<a name='3282'></font>
<a name='3283'>
<font color=#447700>! vegetated:<a name='3284'></font>
<font color=#447700>! -SAV + IRC[TV] + SHC[TV] + EVC[TV] + TR[TV] = 0<a name='3285'></font>
<font color=#447700>! -SAG + IRG[TG] + SHG[TG] + EVG[TG] + GH[TG] = 0<a name='3286'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='3287'></font>
  IMPLICIT NONE<a name='3288'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='3289'></font>
<font color=#447700>! input<a name='3290'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='3291'>
  INTEGER,                         INTENT(IN) :: ILOC   <font color=#447700>!grid index<a name='3292'></font>
  INTEGER,                         INTENT(IN) :: JLOC   <font color=#447700>!grid index<a name='3293'></font>
  LOGICAL,                         INTENT(IN) :: VEG    <font color=#447700>!true if vegetated surface<a name='3294'></font>
  INTEGER,                         INTENT(IN) :: NSNOW  <font color=#447700>!maximum no. of snow layers        <a name='3295'></font>
  INTEGER,                         INTENT(IN) :: NSOIL  <font color=#447700>!number of soil layers<a name='3296'></font>
  INTEGER,                         INTENT(IN) :: ISNOW  <font color=#447700>!actual no. of snow layers<a name='3297'></font>
  INTEGER,                         INTENT(IN) :: VEGTYP <font color=#447700>!vegetation physiology type<a name='3298'></font>
  REAL,                            INTENT(IN) :: FVEG   <font color=#447700>!greeness vegetation fraction (-)<a name='3299'></font>
  REAL,                            INTENT(IN) :: SAV    <font color=#447700>!solar rad absorbed by veg (w/m2)<a name='3300'></font>
  REAL,                            INTENT(IN) :: SAG    <font color=#447700>!solar rad absorbed by ground (w/m2)<a name='3301'></font>
  REAL,                            INTENT(IN) :: LWDN   <font color=#447700>!atmospheric longwave radiation (w/m2)<a name='3302'></font>
  REAL,                            INTENT(IN) :: UR     <font color=#447700>!wind speed at height zlvl (m/s)<a name='3303'></font>
  REAL,                            INTENT(IN) :: UU     <font color=#447700>!wind speed in eastward dir (m/s)<a name='3304'></font>
  REAL,                            INTENT(IN) :: VV     <font color=#447700>!wind speed in northward dir (m/s)<a name='3305'></font>
  REAL,                            INTENT(IN) :: SFCTMP <font color=#447700>!air temperature at reference height (k)<a name='3306'></font>
  REAL,                            INTENT(IN) :: THAIR  <font color=#447700>!potential temp at reference height (k)<a name='3307'></font>
  REAL,                            INTENT(IN) :: EAIR   <font color=#447700>!vapor pressure air at zlvl (pa)<a name='3308'></font>
  REAL,                            INTENT(IN) :: QAIR   <font color=#447700>!specific humidity at zlvl (kg/kg)<a name='3309'></font>
  REAL,                            INTENT(IN) :: RHOAIR <font color=#447700>!density air (kg/m**3)<a name='3310'></font>
  REAL,                            INTENT(IN) :: DT     <font color=#447700>!time step (s)<a name='3311'></font>
  REAL,                            INTENT(IN) :: FSNO     <font color=#447700>!snow fraction<a name='3312'></font>
<a name='3313'>
  REAL,                            INTENT(IN) :: SNOWH  <font color=#447700>!actual snow depth [m]<a name='3314'></font>
  REAL,                            INTENT(IN) :: FWET   <font color=#447700>!wetted fraction of canopy<a name='3315'></font>
  REAL,                            INTENT(IN) :: CWP    <font color=#447700>!canopy wind parameter<a name='3316'></font>
<a name='3317'>
  REAL,                            INTENT(IN) :: VAI    <font color=#447700>!total leaf area index + stem area index<a name='3318'></font>
  REAL,                            INTENT(IN) :: LAISUN <font color=#447700>!sunlit leaf area index, one-sided (m2/m2)<a name='3319'></font>
  REAL,                            INTENT(IN) :: LAISHA <font color=#447700>!shaded leaf area index, one-sided (m2/m2)<a name='3320'></font>
  REAL,                            INTENT(IN) :: ZLVL   <font color=#447700>!reference height (m)<a name='3321'></font>
  REAL,                            INTENT(IN) :: ZPD    <font color=#447700>!zero plane displacement (m)<a name='3322'></font>
  REAL,                            INTENT(IN) :: Z0M    <font color=#447700>!roughness length, momentum (m)<a name='3323'></font>
  REAL,                            INTENT(IN) :: Z0MG   <font color=#447700>!roughness length, momentum, ground (m)<a name='3324'></font>
  REAL,                            INTENT(IN) :: EMV    <font color=#447700>!vegetation emissivity<a name='3325'></font>
  REAL,                            INTENT(IN) :: EMG    <font color=#447700>!ground emissivity<a name='3326'></font>
<a name='3327'>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: STC    <font color=#447700>!soil/snow temperature (k)<a name='3328'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: DF     <font color=#447700>!thermal conductivity of snow/soil (w/m/k)<a name='3329'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: DZSNSO <font color=#447700>!thinkness of snow/soil layers (m)<a name='3330'></font>
  REAL,                            INTENT(IN) :: CANLIQ <font color=#447700>!intercepted liquid water (mm)<a name='3331'></font>
  REAL,                            INTENT(IN) :: CANICE <font color=#447700>!intercepted ice mass (mm)<a name='3332'></font>
  REAL,                            INTENT(IN) :: RSURF  <font color=#447700>!ground surface resistance (s/m)<a name='3333'></font>
<font color=#447700>!  REAL,                            INTENT(IN) :: GAMMA  !psychrometric constant (pa/K)<a name='3334'></font>
<font color=#447700>!  REAL,                            INTENT(IN) :: LATHEA !latent heat of vaporization/subli (j/kg)<a name='3335'></font>
  REAL,                            INTENT(IN) :: GAMMAV  <font color=#447700>!psychrometric constant (pa/K)<a name='3336'></font>
  REAL,                            INTENT(IN) :: LATHEAV <font color=#447700>!latent heat of vaporization/subli (j/kg)<a name='3337'></font>
  REAL,                            INTENT(IN) :: GAMMAG  <font color=#447700>!psychrometric constant (pa/K)<a name='3338'></font>
  REAL,                            INTENT(IN) :: LATHEAG <font color=#447700>!latent heat of vaporization/subli (j/kg)<a name='3339'></font>
  REAL,                            INTENT(IN) :: PARSUN <font color=#447700>!par absorbed per unit sunlit lai (w/m2)<a name='3340'></font>
  REAL,                            INTENT(IN) :: PARSHA <font color=#447700>!par absorbed per unit shaded lai (w/m2)<a name='3341'></font>
  REAL,                            INTENT(IN) :: FOLN   <font color=#447700>!foliage nitrogen (%)<a name='3342'></font>
  REAL,                            INTENT(IN) :: CO2AIR <font color=#447700>!atmospheric co2 concentration (pa)<a name='3343'></font>
  REAL,                            INTENT(IN) :: O2AIR  <font color=#447700>!atmospheric o2 concentration (pa)<a name='3344'></font>
  REAL,                            INTENT(IN) :: IGS    <font color=#447700>!growing season index (0=off, 1=on)<a name='3345'></font>
  REAL,                            INTENT(IN) :: SFCPRS <font color=#447700>!pressure (pa)<a name='3346'></font>
  REAL,                            INTENT(IN) :: BTRAN  <font color=#447700>!soil water transpiration factor (0 to 1)<a name='3347'></font>
  REAL,                            INTENT(IN) :: RHSUR  <font color=#447700>!raltive humidity in surface soil/snow air space (-)<a name='3348'></font>
<a name='3349'>
  REAL                           , INTENT(IN) :: QC     <font color=#447700>!cloud water mixing ratio<a name='3350'></font>
  REAL                           , INTENT(IN) :: PSFC   <font color=#447700>!pressure at lowest model layer<a name='3351'></font>
  REAL                           , INTENT(IN) :: DX     <font color=#447700>!grid spacing<a name='3352'></font>
  REAL                           , INTENT(IN) :: Q2     <font color=#447700>!mixing ratio (kg/kg)<a name='3353'></font>
  REAL                           , INTENT(IN) :: DZ8W   <font color=#447700>!thickness of lowest layer<a name='3354'></font>
  REAL                           , INTENT(INOUT) :: QSFC   <font color=#447700>!mixing ratio at lowest model layer<a name='3355'></font>
  REAL, INTENT(IN)   :: PAHV  <font color=#447700>!precipitation advected heat - canopy net IN (W/m2)<a name='3356'></font>
  REAL, INTENT(IN)   :: PAHG  <font color=#447700>!precipitation advected heat - ground net IN (W/m2)<a name='3357'></font>
<a name='3358'>
<font color=#447700>! input/output<a name='3359'></font>
  REAL,                         INTENT(INOUT) :: EAH    <font color=#447700>!canopy air vapor pressure (pa)<a name='3360'></font>
  REAL,                         INTENT(INOUT) :: TAH    <font color=#447700>!canopy air temperature (k)<a name='3361'></font>
  REAL,                         INTENT(INOUT) :: TV     <font color=#447700>!vegetation temperature (k)<a name='3362'></font>
  REAL,                         INTENT(INOUT) :: TG     <font color=#447700>!ground temperature (k)<a name='3363'></font>
  REAL,                         INTENT(INOUT) :: CM     <font color=#447700>!momentum drag coefficient<a name='3364'></font>
  REAL,                         INTENT(INOUT) :: CH     <font color=#447700>!sensible heat exchange coefficient<a name='3365'></font>
<a name='3366'>
<font color=#447700>! output<a name='3367'></font>
<font color=#447700>! -FSA + FIRA + FSH + (FCEV + FCTR + FGEV) + FCST + SSOIL = 0<a name='3368'></font>
  REAL,                           INTENT(OUT) :: TAUXV  <font color=#447700>!wind stress: e-w (n/m2)<a name='3369'></font>
  REAL,                           INTENT(OUT) :: TAUYV  <font color=#447700>!wind stress: n-s (n/m2)<a name='3370'></font>
  REAL,                           INTENT(OUT) :: IRC    <font color=#447700>!net longwave radiation (w/m2) [+= to atm]<a name='3371'></font>
  REAL,                           INTENT(OUT) :: SHC    <font color=#447700>!sensible heat flux (w/m2)     [+= to atm]<a name='3372'></font>
  REAL,                           INTENT(OUT) :: EVC    <font color=#447700>!evaporation heat flux (w/m2)  [+= to atm]<a name='3373'></font>
  REAL,                           INTENT(OUT) :: IRG    <font color=#447700>!net longwave radiation (w/m2) [+= to atm]<a name='3374'></font>
  REAL,                           INTENT(OUT) :: SHG    <font color=#447700>!sensible heat flux (w/m2)     [+= to atm]<a name='3375'></font>
  REAL,                           INTENT(OUT) :: EVG    <font color=#447700>!evaporation heat flux (w/m2)  [+= to atm]<a name='3376'></font>
  REAL,                           INTENT(OUT) :: TR     <font color=#447700>!transpiration heat flux (w/m2)[+= to atm]<a name='3377'></font>
  REAL,                           INTENT(OUT) :: GH     <font color=#447700>!ground heat (w/m2) [+ = to soil]<a name='3378'></font>
  REAL,                           INTENT(OUT) :: T2MV   <font color=#447700>!2 m height air temperature (k)<a name='3379'></font>
  REAL,                           INTENT(OUT) :: PSNSUN <font color=#447700>!sunlit leaf photosynthesis (umolco2/m2/s)<a name='3380'></font>
  REAL,                           INTENT(OUT) :: PSNSHA <font color=#447700>!shaded leaf photosynthesis (umolco2/m2/s)<a name='3381'></font>
  REAL,                           INTENT(OUT) :: CHLEAF <font color=#447700>!leaf exchange coefficient<a name='3382'></font>
  REAL,                           INTENT(OUT) :: CHUC   <font color=#447700>!under canopy exchange coefficient<a name='3383'></font>
<a name='3384'>
  REAL,                           INTENT(OUT) :: Q2V<a name='3385'>
  REAL :: CAH    <font color=#447700>!sensible heat conductance, canopy air to ZLVL air (m/s)<a name='3386'></font>
  REAL :: U10V    <font color=#447700>!10 m wind speed in eastward dir (m/s) <a name='3387'></font>
  REAL :: V10V    <font color=#447700>!10 m wind speed in eastward dir (m/s) <a name='3388'></font>
  REAL :: WSPD<a name='3389'>
<a name='3390'>
<font color=#447700>! ------------------------ local variables ----------------------------------------------------<a name='3391'></font>
  REAL :: CW           <font color=#447700>!water vapor exchange coefficient<a name='3392'></font>
  REAL :: FV           <font color=#447700>!friction velocity (m/s)<a name='3393'></font>
  REAL :: WSTAR        <font color=#447700>!friction velocity n vertical direction (m/s) (only for SFCDIF2)<a name='3394'></font>
  REAL :: Z0H          <font color=#447700>!roughness length, sensible heat (m)<a name='3395'></font>
  REAL :: Z0HG         <font color=#447700>!roughness length, sensible heat (m)<a name='3396'></font>
  REAL :: RB           <font color=#447700>!bulk leaf boundary layer resistance (s/m)<a name='3397'></font>
  REAL :: RAMC         <font color=#447700>!aerodynamic resistance for momentum (s/m)<a name='3398'></font>
  REAL :: RAHC         <font color=#447700>!aerodynamic resistance for sensible heat (s/m)<a name='3399'></font>
  REAL :: RAWC         <font color=#447700>!aerodynamic resistance for water vapor (s/m)<a name='3400'></font>
  REAL :: RAMG         <font color=#447700>!aerodynamic resistance for momentum (s/m)<a name='3401'></font>
  REAL :: RAHG         <font color=#447700>!aerodynamic resistance for sensible heat (s/m)<a name='3402'></font>
  REAL :: RAWG         <font color=#447700>!aerodynamic resistance for water vapor (s/m)<a name='3403'></font>
<a name='3404'>
  REAL, INTENT(OUT) :: RSSUN        <font color=#447700>!sunlit leaf stomatal resistance (s/m)<a name='3405'></font>
  REAL, INTENT(OUT) :: RSSHA        <font color=#447700>!shaded leaf stomatal resistance (s/m)<a name='3406'></font>
<a name='3407'>
  REAL :: MOL          <font color=#447700>!Monin-Obukhov length (m)<a name='3408'></font>
  REAL :: DTV          <font color=#447700>!change in tv, last iteration (k)<a name='3409'></font>
  REAL :: DTG          <font color=#447700>!change in tg, last iteration (k)<a name='3410'></font>
<a name='3411'>
  REAL :: AIR,CIR      <font color=#447700>!coefficients for ir as function of ts**4<a name='3412'></font>
  REAL :: CSH          <font color=#447700>!coefficients for sh as function of ts<a name='3413'></font>
  REAL :: CEV          <font color=#447700>!coefficients for ev as function of esat[ts]<a name='3414'></font>
  REAL :: CGH          <font color=#447700>!coefficients for st as function of ts<a name='3415'></font>
  REAL :: ATR,CTR      <font color=#447700>!coefficients for tr as function of esat[ts]<a name='3416'></font>
  REAL :: ATA,BTA      <font color=#447700>!coefficients for tah as function of ts<a name='3417'></font>
  REAL :: AEA,BEA      <font color=#447700>!coefficients for eah as function of esat[ts]<a name='3418'></font>
<a name='3419'>
  REAL :: ESTV         <font color=#447700>!saturation vapor pressure at tv (pa)<a name='3420'></font>
  REAL :: ESTG         <font color=#447700>!saturation vapor pressure at tg (pa)<a name='3421'></font>
  REAL :: DESTV        <font color=#447700>!d(es)/dt at ts (pa/k)<a name='3422'></font>
  REAL :: DESTG        <font color=#447700>!d(es)/dt at tg (pa/k)<a name='3423'></font>
  REAL :: ESATW        <font color=#447700>!es for water<a name='3424'></font>
  REAL :: ESATI        <font color=#447700>!es for ice<a name='3425'></font>
  REAL :: DSATW        <font color=#447700>!d(es)/dt at tg (pa/k) for water<a name='3426'></font>
  REAL :: DSATI        <font color=#447700>!d(es)/dt at tg (pa/k) for ice<a name='3427'></font>
<a name='3428'>
  REAL :: FM           <font color=#447700>!momentum stability correction, weighted by prior iters<a name='3429'></font>
  REAL :: FH           <font color=#447700>!sen heat stability correction, weighted by prior iters<a name='3430'></font>
  REAL :: FHG          <font color=#447700>!sen heat stability correction, ground<a name='3431'></font>
  REAL :: HCAN         <font color=#447700>!canopy height (m) [note: hcan &gt;= z0mg]<a name='3432'></font>
<a name='3433'>
  REAL :: A            <font color=#447700>!temporary calculation<a name='3434'></font>
  REAL :: B            <font color=#447700>!temporary calculation<a name='3435'></font>
  REAL :: CVH          <font color=#447700>!sensible heat conductance, leaf surface to canopy air (m/s)<a name='3436'></font>
  REAL :: CAW          <font color=#447700>!latent heat conductance, canopy air ZLVL air (m/s)<a name='3437'></font>
  REAL :: CTW          <font color=#447700>!transpiration conductance, leaf to canopy air (m/s)<a name='3438'></font>
  REAL :: CEW          <font color=#447700>!evaporation conductance, leaf to canopy air (m/s)<a name='3439'></font>
  REAL :: CGW          <font color=#447700>!latent heat conductance, ground to canopy air (m/s)<a name='3440'></font>
  REAL :: COND         <font color=#447700>!sum of conductances (s/m)<a name='3441'></font>
  REAL :: UC           <font color=#447700>!wind speed at top of canopy (m/s)<a name='3442'></font>
  REAL :: KH           <font color=#447700>!turbulent transfer coefficient, sensible heat, (m2/s)<a name='3443'></font>
  REAL :: H            <font color=#447700>!temporary sensible heat flux (w/m2)<a name='3444'></font>
  REAL :: HG           <font color=#447700>!temporary sensible heat flux (w/m2)<a name='3445'></font>
  REAL :: MOZ          <font color=#447700>!Monin-Obukhov stability parameter<a name='3446'></font>
  REAL :: MOZG         <font color=#447700>!Monin-Obukhov stability parameter<a name='3447'></font>
  REAL :: MOZOLD       <font color=#447700>!Monin-Obukhov stability parameter from prior iteration<a name='3448'></font>
  REAL :: FM2          <font color=#447700>!Monin-Obukhov momentum adjustment at 2m<a name='3449'></font>
  REAL :: FH2          <font color=#447700>!Monin-Obukhov heat adjustment at 2m<a name='3450'></font>
  REAL :: CH2          <font color=#447700>!Surface exchange at 2m<a name='3451'></font>
  REAL :: THSTAR          <font color=#447700>!Surface exchange at 2m<a name='3452'></font>
<a name='3453'>
  REAL :: THVAIR<a name='3454'>
  REAL :: THAH <a name='3455'>
  REAL :: RAHC2        <font color=#447700>!aerodynamic resistance for sensible heat (s/m)<a name='3456'></font>
  REAL :: RAWC2        <font color=#447700>!aerodynamic resistance for water vapor (s/m)<a name='3457'></font>
  REAL, INTENT(OUT):: CAH2         <font color=#447700>!sensible heat conductance for diagnostics<a name='3458'></font>
  REAL :: CH2V         <font color=#447700>!exchange coefficient for 2m over vegetation. <a name='3459'></font>
  REAL :: CQ2V         <font color=#447700>!exchange coefficient for 2m over vegetation. <a name='3460'></font>
  REAL :: EAH2         <font color=#447700>!2m vapor pressure over canopy<a name='3461'></font>
  REAL :: QFX        <font color=#447700>!moisture flux<a name='3462'></font>
  REAL :: E1           <a name='3463'>
<a name='3464'>
<a name='3465'>
  REAL :: VAIE         <font color=#447700>!total leaf area index + stem area index,effective<a name='3466'></font>
  REAL :: LAISUNE      <font color=#447700>!sunlit leaf area index, one-sided (m2/m2),effective<a name='3467'></font>
  REAL :: LAISHAE      <font color=#447700>!shaded leaf area index, one-sided (m2/m2),effective<a name='3468'></font>
<a name='3469'>
  INTEGER :: K         <font color=#447700>!index<a name='3470'></font>
  INTEGER :: ITER      <font color=#447700>!iteration index<a name='3471'></font>
<a name='3472'>
<font color=#447700>!jref - NITERC test from 5 to 20  <a name='3473'></font>
  INTEGER, PARAMETER :: NITERC = 20   <font color=#447700>!number of iterations for surface temperature<a name='3474'></font>
<font color=#447700>!jref - NITERG test from 3-5<a name='3475'></font>
  INTEGER, PARAMETER :: NITERG = 5   <font color=#447700>!number of iterations for ground temperature<a name='3476'></font>
  INTEGER :: MOZSGN    <font color=#447700>!number of times MOZ changes sign<a name='3477'></font>
  REAL    :: MPE       <font color=#447700>!prevents overflow error if division by zero<a name='3478'></font>
<a name='3479'>
  INTEGER :: LITER     <font color=#447700>!Last iteration<a name='3480'></font>
<a name='3481'>
<a name='3482'>
  REAL :: T, TDC       <font color=#447700>!Kelvin to degree Celsius with limit -50 to +50<a name='3483'></font>
<a name='3484'>
  character(len=80) ::  message<a name='3485'>
<a name='3486'>
  TDC(T)   = MIN( 50., MAX(-50.,(T-TFRZ)) )<a name='3487'>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='3488'></font>
<a name='3489'>
        MPE = 1E-6<a name='3490'>
        LITER = 0<a name='3491'>
        FV = 0.1<a name='3492'>
<a name='3493'>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='3494'></font>
<font color=#447700>! initialization variables that do not depend on stability iteration<a name='3495'></font>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='3496'></font>
        DTV = 0.<a name='3497'>
        DTG = 0.<a name='3498'>
        MOZ    = 0.<a name='3499'>
        MOZSGN = 0<a name='3500'>
        MOZOLD = 0.<a name='3501'>
        FH2    = 0.<a name='3502'>
        HG     = 0.<a name='3503'>
        H      = 0.<a name='3504'>
        QFX    = 0.<a name='3505'>
<a name='3506'>
<font color=#447700>! convert grid-cell LAI to the fractional vegetated area (FVEG)<a name='3507'></font>
<a name='3508'>
        VAIE    = MIN(6.,VAI    / FVEG)<a name='3509'>
        LAISUNE = MIN(6.,LAISUN / FVEG)<a name='3510'>
        LAISHAE = MIN(6.,LAISHA / FVEG)<a name='3511'>
<a name='3512'>
<font color=#447700>! saturation vapor pressure at ground temperature<a name='3513'></font>
<a name='3514'>
        T = TDC(TG)<a name='3515'>
        CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#ESAT'>ESAT</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESAT_4">(T, ESATW, ESATI, DSATW, DSATI)<a name='3516'>
        IF (T .GT. 0.) THEN<a name='3517'>
           ESTG = ESATW<a name='3518'>
        ELSE<a name='3519'>
           ESTG = ESATI<a name='3520'>
        END IF<a name='3521'>
<a name='3522'>
<font color=#447700>!jref - consistent surface specific humidity for sfcdif3 and sfcdif4<a name='3523'></font>
<a name='3524'>
        QSFC = 0.622*EAIR/(PSFC-0.378*EAIR)  <a name='3525'>
<a name='3526'>
<font color=#447700>! canopy height<a name='3527'></font>
<a name='3528'>
        HCAN = parameters%HVT<a name='3529'>
        UC = UR*LOG(HCAN/Z0M)/LOG(ZLVL/Z0M)<a name='3530'>
        UC = UR*LOG((HCAN-ZPD+Z0M)/Z0M)/LOG(ZLVL/Z0M)   <font color=#447700>! MB: add ZPD v3.7<a name='3531'></font>
        IF((HCAN-ZPD) &lt;= 0.) THEN<a name='3532'>
          WRITE(message,*) "CRITICAL PROBLEM: HCAN &lt;= ZPD"<a name='3533'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_974"> ( message )<a name='3534'>
          WRITE(message,*) 'i,j point=',ILOC, JLOC<a name='3535'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_975"> ( message )<a name='3536'>
          WRITE(message,*) 'HCAN  =',HCAN<a name='3537'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_976"> ( message )<a name='3538'>
          WRITE(message,*) 'ZPD   =',ZPD<a name='3539'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_977"> ( message )<a name='3540'>
          write (message, *) 'SNOWH =',SNOWH<a name='3541'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_978"> ( message )<a name='3542'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1190"> ( "CRITICAL PROBLEM IN MODULE_SF_NOAHMPLSM:VEGEFLUX" )<a name='3543'>
        END IF<a name='3544'>
<a name='3545'>
<font color=#447700>! prepare for longwave rad.<a name='3546'></font>
<a name='3547'>
        AIR = -EMV*(1.+(1.-EMV)*(1.-EMG))*LWDN - EMV*EMG*SB*TG**4  <a name='3548'>
        CIR = (2.-EMV*(1.-EMG))*EMV*SB<a name='3549'>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='3550'></font>
      loop1: DO ITER = 1, NITERC    <font color=#447700>!  begin stability iteration<a name='3551'></font>
<a name='3552'>
       IF(ITER == 1) THEN<a name='3553'>
            Z0H  = Z0M  <a name='3554'>
            Z0HG = Z0MG<a name='3555'>
       ELSE<a name='3556'>
            Z0H  = Z0M    <font color=#447700>!* EXP(-CZIL*0.4*258.2*SQRT(FV*Z0M))<a name='3557'></font>
            Z0HG = Z0MG   <font color=#447700>!* EXP(-CZIL*0.4*258.2*SQRT(FV*Z0MG))<a name='3558'></font>
       END IF<a name='3559'>
<a name='3560'>
<font color=#447700>! aerodyn resistances between heights zlvl and d+z0v<a name='3561'></font>
<a name='3562'>
       IF(OPT_SFC == 1) THEN<a name='3563'>
          CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#SFCDIF1'>SFCDIF1</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIF1_1">(parameters,ITER   ,SFCTMP ,RHOAIR ,H      ,QAIR   , &amp; <font color=#447700>!in<a name='3564'></font>
                       ZLVL   ,ZPD    ,Z0M    ,Z0H    ,UR     , &amp; <font color=#447700>!in<a name='3565'></font>
                       MPE    ,ILOC   ,JLOC   ,                 &amp; <font color=#447700>!in<a name='3566'></font>
                       MOZ    ,MOZSGN ,FM     ,FH     ,FM2,FH2, &amp; <font color=#447700>!inout<a name='3567'></font>
                       CM     ,CH     ,FV     ,CH2     )          <font color=#447700>!out<a name='3568'></font>
       ENDIF<a name='3569'>
     <a name='3570'>
       IF(OPT_SFC == 2) THEN<a name='3571'>
          CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#SFCDIF2'>SFCDIF2</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIF2_1">(parameters,ITER   ,Z0M    ,TAH    ,THAIR  ,UR     , &amp; <font color=#447700>!in<a name='3572'></font>
                       ZLVL   ,ILOC   ,JLOC   ,         &amp; <font color=#447700>!in<a name='3573'></font>
                       CM     ,CH     ,MOZ    ,WSTAR  ,         &amp; <font color=#447700>!in<a name='3574'></font>
                       FV     )                                   <font color=#447700>!out<a name='3575'></font>
          <font color=#447700>! Undo the multiplication by windspeed that SFCDIF2 <a name='3576'></font>
          <font color=#447700>! applies to exchange coefficients CH and CM:<a name='3577'></font>
          CH = CH / UR<a name='3578'>
          CM = CM / UR<a name='3579'>
       ENDIF<a name='3580'>
<a name='3581'>
       RAMC = MAX(1.,1./(CM*UR))<a name='3582'>
       RAHC = MAX(1.,1./(CH*UR))<a name='3583'>
       RAWC = RAHC<a name='3584'>
<a name='3585'>
<font color=#447700>! aerodyn resistance between heights z0g and d+z0v, RAG, and leaf<a name='3586'></font>
<font color=#447700>! boundary layer resistance, RB<a name='3587'></font>
       <a name='3588'>
       CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#RAGRB'>RAGRB</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAGRB_1">(parameters,ITER   ,VAIE   ,RHOAIR ,HG     ,TAH    , &amp; <font color=#447700>!in<a name='3589'></font>
                  ZPD    ,Z0MG   ,Z0HG   ,HCAN   ,UC     , &amp; <font color=#447700>!in<a name='3590'></font>
                  Z0H    ,FV     ,CWP    ,VEGTYP ,MPE    , &amp; <font color=#447700>!in<a name='3591'></font>
                  TV     ,MOZG   ,FHG    ,ILOC   ,JLOC   , &amp; <font color=#447700>!inout<a name='3592'></font>
                  RAMG   ,RAHG   ,RAWG   ,RB     )           <font color=#447700>!out<a name='3593'></font>
<a name='3594'>
<font color=#447700>! es and d(es)/dt evaluated at tv<a name='3595'></font>
<a name='3596'>
       T = TDC(TV)<a name='3597'>
       CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#ESAT'>ESAT</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESAT_5">(T, ESATW, ESATI, DSATW, DSATI)<a name='3598'>
       IF (T .GT. 0.) THEN<a name='3599'>
          ESTV  = ESATW<a name='3600'>
          DESTV = DSATW<a name='3601'>
       ELSE<a name='3602'>
          ESTV  = ESATI<a name='3603'>
          DESTV = DSATI<a name='3604'>
       END IF<a name='3605'>
<a name='3606'>
<font color=#447700>! stomatal resistance<a name='3607'></font>
        <a name='3608'>
     IF(ITER == 1) THEN<a name='3609'>
        IF (OPT_CRS == 1) then  <font color=#447700>! Ball-Berry<a name='3610'></font>
         CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#STOMATA'>STOMATA</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STOMATA_3"> (parameters,VEGTYP,MPE   ,PARSUN ,FOLN  ,ILOC  , JLOC , &amp; <font color=#447700>!in       <a name='3611'></font>
                       TV    ,ESTV  ,EAH    ,SFCTMP,SFCPRS, &amp; <font color=#447700>!in<a name='3612'></font>
                       O2AIR ,CO2AIR,IGS    ,BTRAN ,RB    , &amp; <font color=#447700>!in<a name='3613'></font>
                       RSSUN ,PSNSUN)                         <font color=#447700>!out<a name='3614'></font>
<a name='3615'>
         CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#STOMATA'>STOMATA</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STOMATA_4"> (parameters,VEGTYP,MPE   ,PARSHA ,FOLN  ,ILOC  , JLOC , &amp; <font color=#447700>!in<a name='3616'></font>
                       TV    ,ESTV  ,EAH    ,SFCTMP,SFCPRS, &amp; <font color=#447700>!in<a name='3617'></font>
                       O2AIR ,CO2AIR,IGS    ,BTRAN ,RB    , &amp; <font color=#447700>!in<a name='3618'></font>
                       RSSHA ,PSNSHA)                         <font color=#447700>!out<a name='3619'></font>
        END IF<a name='3620'>
<a name='3621'>
        IF (OPT_CRS == 2) then  <font color=#447700>! Jarvis<a name='3622'></font>
         CALL  <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CANRES'>CANRES</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CANRES_2"> (parameters,PARSUN,TV    ,BTRAN ,EAH    ,SFCPRS, &amp; <font color=#447700>!in<a name='3623'></font>
                       RSSUN ,PSNSUN,ILOC  ,JLOC   )          <font color=#447700>!out<a name='3624'></font>
<a name='3625'>
         CALL  <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CANRES'>CANRES</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CANRES_3"> (parameters,PARSHA,TV    ,BTRAN ,EAH    ,SFCPRS, &amp; <font color=#447700>!in<a name='3626'></font>
                       RSSHA ,PSNSHA,ILOC  ,JLOC   )          <font color=#447700>!out<a name='3627'></font>
        END IF<a name='3628'>
     END IF<a name='3629'>
<a name='3630'>
<font color=#447700>! prepare for sensible heat flux above veg.<a name='3631'></font>
<a name='3632'>
        CAH  = 1./RAHC<a name='3633'>
        CVH  = 2.*VAIE/RB<a name='3634'>
        CGH  = 1./RAHG<a name='3635'>
        COND = CAH + CVH + CGH<a name='3636'>
        ATA  = (SFCTMP*CAH + TG*CGH) / COND<a name='3637'>
        BTA  = CVH/COND<a name='3638'>
        CSH  = (1.-BTA)*RHOAIR*CPAIR*CVH<a name='3639'>
<a name='3640'>
<font color=#447700>! prepare for latent heat flux above veg.<a name='3641'></font>
<a name='3642'>
        CAW  = 1./RAWC<a name='3643'>
        CEW  = FWET*VAIE/RB<a name='3644'>
        CTW  = (1.-FWET)*(LAISUNE/(RB+RSSUN) + LAISHAE/(RB+RSSHA))<a name='3645'>
        CGW  = 1./(RAWG+RSURF)<a name='3646'>
        COND = CAW + CEW + CTW + CGW<a name='3647'>
        AEA  = (EAIR*CAW + ESTG*CGW) / COND<a name='3648'>
        BEA  = (CEW+CTW)/COND<a name='3649'>
        CEV  = (1.-BEA)*CEW*RHOAIR*CPAIR/GAMMAV   <font color=#447700>! Barlage: change to vegetation v3.6<a name='3650'></font>
        CTR  = (1.-BEA)*CTW*RHOAIR*CPAIR/GAMMAV<a name='3651'>
<a name='3652'>
<font color=#447700>! evaluate surface fluxes with current temperature and solve for dts<a name='3653'></font>
<a name='3654'>
        TAH = ATA + BTA*TV               <font color=#447700>! canopy air T.<a name='3655'></font>
        EAH = AEA + BEA*ESTV             <font color=#447700>! canopy air e<a name='3656'></font>
<a name='3657'>
        IRC = FVEG*(AIR + CIR*TV**4)<a name='3658'>
        SHC = FVEG*RHOAIR*CPAIR*CVH * (  TV-TAH)<a name='3659'>
        EVC = FVEG*RHOAIR*CPAIR*CEW * (ESTV-EAH) / GAMMAV <font color=#447700>! Barlage: change to v in v3.6<a name='3660'></font>
        TR  = FVEG*RHOAIR*CPAIR*CTW * (ESTV-EAH) / GAMMAV<a name='3661'>
	IF (TV &gt; TFRZ) THEN<a name='3662'>
          EVC = MIN(CANLIQ*LATHEAV/DT,EVC)    <font color=#447700>! Barlage: add if block for canice in v3.6<a name='3663'></font>
	ELSE<a name='3664'>
          EVC = MIN(CANICE*LATHEAV/DT,EVC)<a name='3665'>
	END IF<a name='3666'>
<a name='3667'>
        B   = SAV-IRC-SHC-EVC-TR+PAHV                          <font color=#447700>!additional w/m2<a name='3668'></font>
        A   = FVEG*(4.*CIR*TV**3 + CSH + (CEV+CTR)*DESTV) <font color=#447700>!volumetric heat capacity<a name='3669'></font>
        DTV = B/A<a name='3670'>
<a name='3671'>
        IRC = IRC + FVEG*4.*CIR*TV**3*DTV<a name='3672'>
        SHC = SHC + FVEG*CSH*DTV<a name='3673'>
        EVC = EVC + FVEG*CEV*DESTV*DTV<a name='3674'>
        TR  = TR  + FVEG*CTR*DESTV*DTV                               <a name='3675'>
<a name='3676'>
<font color=#447700>! update vegetation surface temperature<a name='3677'></font>
        TV  = TV + DTV<a name='3678'>
<font color=#447700>!        TAH = ATA + BTA*TV               ! canopy air T; update here for consistency<a name='3679'></font>
<a name='3680'>
<font color=#447700>! for computing M-O length in the next iteration<a name='3681'></font>
        H  = RHOAIR*CPAIR*(TAH - SFCTMP) /RAHC        <a name='3682'>
        HG = RHOAIR*CPAIR*(TG  - TAH)   /RAHG<a name='3683'>
<a name='3684'>
<font color=#447700>! consistent specific humidity from canopy air vapor pressure<a name='3685'></font>
        QSFC = (0.622*EAH)/(SFCPRS-0.378*EAH)<a name='3686'>
<a name='3687'>
        IF (LITER == 1) THEN<a name='3688'>
           exit loop1 <a name='3689'>
        ENDIF<a name='3690'>
        IF (ITER &gt;= 5 .AND. ABS(DTV) &lt;= 0.01 .AND. LITER == 0) THEN<a name='3691'>
           LITER = 1<a name='3692'>
        ENDIF<a name='3693'>
<a name='3694'>
     END DO loop1 <font color=#447700>! end stability iteration<a name='3695'></font>
<a name='3696'>
<font color=#447700>! under-canopy fluxes and tg<a name='3697'></font>
<a name='3698'>
        AIR = - EMG*(1.-EMV)*LWDN - EMG*EMV*SB*TV**4<a name='3699'>
        CIR = EMG*SB<a name='3700'>
        CSH = RHOAIR*CPAIR/RAHG<a name='3701'>
        CEV = RHOAIR*CPAIR / (GAMMAG*(RAWG+RSURF))  <font color=#447700>! Barlage: change to ground v3.6<a name='3702'></font>
        CGH = 2.*DF(ISNOW+1)/DZSNSO(ISNOW+1)<a name='3703'>
<a name='3704'>
     loop2: DO ITER = 1, NITERG<a name='3705'>
<a name='3706'>
        T = TDC(TG)<a name='3707'>
        CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#ESAT'>ESAT</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#VEGE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESAT_6">(T, ESATW, ESATI, DSATW, DSATI)<a name='3708'>
        IF (T .GT. 0.) THEN<a name='3709'>
            ESTG  = ESATW<a name='3710'>
            DESTG = DSATW<a name='3711'>
        ELSE<a name='3712'>
            ESTG  = ESATI<a name='3713'>
            DESTG = DSATI<a name='3714'>
        END IF<a name='3715'>
<a name='3716'>
        IRG = CIR*TG**4 + AIR<a name='3717'>
        SHG = CSH * (TG         - TAH         )<a name='3718'>
        EVG = CEV * (ESTG*RHSUR - EAH         )<a name='3719'>
        GH  = CGH * (TG         - STC(ISNOW+1))<a name='3720'>
<a name='3721'>
        B = SAG-IRG-SHG-EVG-GH+PAHG<a name='3722'>
        A = 4.*CIR*TG**3+CSH+CEV*DESTG+CGH<a name='3723'>
        DTG = B/A<a name='3724'>
<a name='3725'>
        IRG = IRG + 4.*CIR*TG**3*DTG<a name='3726'>
        SHG = SHG + CSH*DTG<a name='3727'>
        EVG = EVG + CEV*DESTG*DTG<a name='3728'>
        GH  = GH  + CGH*DTG<a name='3729'>
        TG  = TG  + DTG<a name='3730'>
<a name='3731'>
     END DO loop2<a name='3732'>
     <a name='3733'>
<font color=#447700>!     TAH = (CAH*SFCTMP + CVH*TV + CGH*TG)/(CAH + CVH + CGH)<a name='3734'></font>
<a name='3735'>
<font color=#447700>! if snow on ground and TG &gt; TFRZ: reset TG = TFRZ. reevaluate ground fluxes.<a name='3736'></font>
<a name='3737'>
     IF(OPT_STC == 1 .OR. OPT_STC == 3) THEN<a name='3738'>
     IF (SNOWH &gt; 0.05 .AND. TG &gt; TFRZ) THEN<a name='3739'>
        IF(OPT_STC == 1) TG  = TFRZ<a name='3740'>
        IF(OPT_STC == 3) TG  = (1.-FSNO)*TG + FSNO*TFRZ   <font color=#447700>! MB: allow TG&gt;0C during melt v3.7<a name='3741'></font>
        IRG = CIR*TG**4 - EMG*(1.-EMV)*LWDN - EMG*EMV*SB*TV**4<a name='3742'>
        SHG = CSH * (TG         - TAH)<a name='3743'>
        EVG = CEV * (ESTG*RHSUR - EAH)<a name='3744'>
        GH  = SAG+PAHG - (IRG+SHG+EVG)<a name='3745'>
     END IF<a name='3746'>
     END IF<a name='3747'>
<a name='3748'>
<font color=#447700>! wind stresses<a name='3749'></font>
<a name='3750'>
     TAUXV = -RHOAIR*CM*UR*UU<a name='3751'>
     TAUYV = -RHOAIR*CM*UR*VV<a name='3752'>
<a name='3753'>
<font color=#447700>! consistent vegetation air temperature and vapor pressure since TG is not consistent with the TAH/EAH<a name='3754'></font>
<font color=#447700>! calculation.<a name='3755'></font>
<font color=#447700>!     TAH = SFCTMP + (SHG+SHC)/(RHOAIR*CPAIR*CAH) <a name='3756'></font>
<font color=#447700>!     TAH = SFCTMP + (SHG*FVEG+SHC)/(RHOAIR*CPAIR*CAH) ! ground flux need fveg<a name='3757'></font>
<font color=#447700>!     EAH = EAIR + (EVC+FVEG*(TR+EVG))/(RHOAIR*CAW*CPAIR/GAMMAG )<a name='3758'></font>
<font color=#447700>!     QFX = (QSFC-QAIR)*RHOAIR*CAW !*CPAIR/GAMMAG<a name='3759'></font>
<a name='3760'>
<font color=#447700>! 2m temperature over vegetation ( corrected for low CQ2V values )<a name='3761'></font>
   IF (OPT_SFC == 1 .OR. OPT_SFC == 2) THEN<a name='3762'>
<font color=#447700>!      CAH2 = FV*1./VKC*LOG((2.+Z0H)/Z0H)<a name='3763'></font>
      CAH2 = FV*VKC/LOG((2.+Z0H)/Z0H)<a name='3764'>
      CAH2 = FV*VKC/(LOG((2.+Z0H)/Z0H)-FH2)<a name='3765'>
      CQ2V = CAH2<a name='3766'>
      IF (CAH2 .LT. 1.E-5 ) THEN<a name='3767'>
         T2MV = TAH<a name='3768'>
<font color=#447700>!         Q2V  = (EAH*0.622/(SFCPRS - 0.378*EAH))<a name='3769'></font>
         Q2V  = QSFC<a name='3770'>
      ELSE<a name='3771'>
         T2MV = TAH - (SHG+SHC/FVEG)/(RHOAIR*CPAIR) * 1./CAH2<a name='3772'>
<font color=#447700>!         Q2V = (EAH*0.622/(SFCPRS - 0.378*EAH))- QFX/(RHOAIR*FV)* 1./VKC * LOG((2.+Z0H)/Z0H)<a name='3773'></font>
         Q2V = QSFC - ((EVC+TR)/FVEG+EVG)/(LATHEAV*RHOAIR) * 1./CQ2V<a name='3774'>
      ENDIF<a name='3775'>
   ENDIF<a name='3776'>
<a name='3777'>
<font color=#447700>! update CH for output<a name='3778'></font>
     CH = CAH<a name='3779'>
     CHLEAF = CVH<a name='3780'>
     CHUC = 1./RAHG<a name='3781'>
<a name='3782'>
  END SUBROUTINE VEGE_FLUX<a name='3783'>
<a name='3784'>
<font color=#447700>!== begin bare_flux ================================================================================<a name='3785'></font>
<a name='3786'>
<A NAME='BARE_FLUX'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#BARE_FLUX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3787'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>BARE_FLUX</font> (parameters,NSNOW   ,NSOIL   ,ISNOW   ,DT      ,SAG     , &amp; <font color=#447700>!in <A href='../../call_to/BARE_FLUX.html' TARGET='index'>1</A>,<A href='../../call_from/BARE_FLUX.html' TARGET='index'>4</A><a name='3788'></font>
                        LWDN    ,UR      ,UU      ,VV      ,SFCTMP  , &amp; <font color=#447700>!in<a name='3789'></font>
                        THAIR   ,QAIR    ,EAIR    ,RHOAIR  ,SNOWH   , &amp; <font color=#447700>!in<a name='3790'></font>
                        DZSNSO  ,ZLVL    ,ZPD     ,Z0M     ,FSNO    , &amp; <font color=#447700>!in<a name='3791'></font>
                        EMG     ,STC     ,DF      ,RSURF   ,LATHEA  , &amp; <font color=#447700>!in<a name='3792'></font>
                        GAMMA   ,RHSUR   ,ILOC    ,JLOC    ,Q2      ,PAHB  , &amp; <font color=#447700>!in<a name='3793'></font>
                        TGB     ,CM      ,CH      ,          &amp; <font color=#447700>!inout<a name='3794'></font>
                        TAUXB   ,TAUYB   ,IRB     ,SHB     ,EVB     , &amp; <font color=#447700>!out<a name='3795'></font>
                        GHB     ,T2MB    ,DX      ,DZ8W    ,IVGTYP  , &amp; <font color=#447700>!out<a name='3796'></font>
                        QC      ,QSFC    ,PSFC    ,                   &amp; <font color=#447700>!in<a name='3797'></font>
                        SFCPRS  ,Q2B     ,EHB2    )                     <font color=#447700>!in <a name='3798'></font>
<a name='3799'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='3800'></font>
<font color=#447700>! use newton-raphson iteration to solve ground (tg) temperature<a name='3801'></font>
<font color=#447700>! that balances the surface energy budgets for bare soil fraction.<a name='3802'></font>
<a name='3803'>
<font color=#447700>! bare soil:<a name='3804'></font>
<font color=#447700>! -SAB + IRB[TG] + SHB[TG] + EVB[TG] + GHB[TG] = 0<a name='3805'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3806'></font>
  IMPLICIT NONE<a name='3807'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3808'></font>
<font color=#447700>! input<a name='3809'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='3810'>
  integer                        , INTENT(IN) :: ILOC   <font color=#447700>!grid index<a name='3811'></font>
  integer                        , INTENT(IN) :: JLOC   <font color=#447700>!grid index<a name='3812'></font>
  INTEGER,                         INTENT(IN) :: NSNOW  <font color=#447700>!maximum no. of snow layers<a name='3813'></font>
  INTEGER,                         INTENT(IN) :: NSOIL  <font color=#447700>!number of soil layers<a name='3814'></font>
  INTEGER,                         INTENT(IN) :: ISNOW  <font color=#447700>!actual no. of snow layers<a name='3815'></font>
  REAL,                            INTENT(IN) :: DT     <font color=#447700>!time step (s)<a name='3816'></font>
  REAL,                            INTENT(IN) :: SAG    <font color=#447700>!solar radiation absorbed by ground (w/m2)<a name='3817'></font>
  REAL,                            INTENT(IN) :: LWDN   <font color=#447700>!atmospheric longwave radiation (w/m2)<a name='3818'></font>
  REAL,                            INTENT(IN) :: UR     <font color=#447700>!wind speed at height zlvl (m/s)<a name='3819'></font>
  REAL,                            INTENT(IN) :: UU     <font color=#447700>!wind speed in eastward dir (m/s)<a name='3820'></font>
  REAL,                            INTENT(IN) :: VV     <font color=#447700>!wind speed in northward dir (m/s)<a name='3821'></font>
  REAL,                            INTENT(IN) :: SFCTMP <font color=#447700>!air temperature at reference height (k)<a name='3822'></font>
  REAL,                            INTENT(IN) :: THAIR  <font color=#447700>!potential temperature at height zlvl (k)<a name='3823'></font>
  REAL,                            INTENT(IN) :: QAIR   <font color=#447700>!specific humidity at height zlvl (kg/kg)<a name='3824'></font>
  REAL,                            INTENT(IN) :: EAIR   <font color=#447700>!vapor pressure air at height (pa)<a name='3825'></font>
  REAL,                            INTENT(IN) :: RHOAIR <font color=#447700>!density air (kg/m3)<a name='3826'></font>
  REAL,                            INTENT(IN) :: SNOWH  <font color=#447700>!actual snow depth [m]<a name='3827'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: DZSNSO <font color=#447700>!thickness of snow/soil layers (m)<a name='3828'></font>
  REAL,                            INTENT(IN) :: ZLVL   <font color=#447700>!reference height (m)<a name='3829'></font>
  REAL,                            INTENT(IN) :: ZPD    <font color=#447700>!zero plane displacement (m)<a name='3830'></font>
  REAL,                            INTENT(IN) :: Z0M    <font color=#447700>!roughness length, momentum, ground (m)<a name='3831'></font>
  REAL,                            INTENT(IN) :: EMG    <font color=#447700>!ground emissivity<a name='3832'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: STC    <font color=#447700>!soil/snow temperature (k)<a name='3833'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: DF     <font color=#447700>!thermal conductivity of snow/soil (w/m/k)<a name='3834'></font>
  REAL,                            INTENT(IN) :: RSURF  <font color=#447700>!ground surface resistance (s/m)<a name='3835'></font>
  REAL,                            INTENT(IN) :: LATHEA <font color=#447700>!latent heat of vaporization/subli (j/kg)<a name='3836'></font>
  REAL,                            INTENT(IN) :: GAMMA  <font color=#447700>!psychrometric constant (pa/k)<a name='3837'></font>
  REAL,                            INTENT(IN) :: RHSUR  <font color=#447700>!raltive humidity in surface soil/snow air space (-)<a name='3838'></font>
  REAL,                            INTENT(IN) :: FSNO     <font color=#447700>!snow fraction<a name='3839'></font>
<a name='3840'>
<font color=#447700>!jref:start; in <a name='3841'></font>
  INTEGER                        , INTENT(IN) :: IVGTYP<a name='3842'>
  REAL                           , INTENT(IN) :: QC     <font color=#447700>!cloud water mixing ratio<a name='3843'></font>
  REAL                           , INTENT(INOUT) :: QSFC   <font color=#447700>!mixing ratio at lowest model layer<a name='3844'></font>
  REAL                           , INTENT(IN) :: PSFC   <font color=#447700>!pressure at lowest model layer<a name='3845'></font>
  REAL                           , INTENT(IN) :: SFCPRS <font color=#447700>!pressure at lowest model layer<a name='3846'></font>
  REAL                           , INTENT(IN) :: DX     <font color=#447700>!horisontal grid spacing<a name='3847'></font>
  REAL                           , INTENT(IN) :: Q2     <font color=#447700>!mixing ratio (kg/kg)<a name='3848'></font>
  REAL                           , INTENT(IN) :: DZ8W   <font color=#447700>!thickness of lowest layer<a name='3849'></font>
<font color=#447700>!jref:end<a name='3850'></font>
  REAL, INTENT(IN)   :: PAHB  <font color=#447700>!precipitation advected heat - ground net IN (W/m2)<a name='3851'></font>
<a name='3852'>
<font color=#447700>! input/output<a name='3853'></font>
  REAL,                         INTENT(INOUT) :: TGB    <font color=#447700>!ground temperature (k)<a name='3854'></font>
  REAL,                         INTENT(INOUT) :: CM     <font color=#447700>!momentum drag coefficient<a name='3855'></font>
  REAL,                         INTENT(INOUT) :: CH     <font color=#447700>!sensible heat exchange coefficient<a name='3856'></font>
<a name='3857'>
<font color=#447700>! output<a name='3858'></font>
<font color=#447700>! -SAB + IRB[TG] + SHB[TG] + EVB[TG] + GHB[TG] = 0<a name='3859'></font>
<a name='3860'>
  REAL,                           INTENT(OUT) :: TAUXB  <font color=#447700>!wind stress: e-w (n/m2)<a name='3861'></font>
  REAL,                           INTENT(OUT) :: TAUYB  <font color=#447700>!wind stress: n-s (n/m2)<a name='3862'></font>
  REAL,                           INTENT(OUT) :: IRB    <font color=#447700>!net longwave rad (w/m2)   [+ to atm]<a name='3863'></font>
  REAL,                           INTENT(OUT) :: SHB    <font color=#447700>!sensible heat flux (w/m2) [+ to atm]<a name='3864'></font>
  REAL,                           INTENT(OUT) :: EVB    <font color=#447700>!latent heat flux (w/m2)   [+ to atm]<a name='3865'></font>
  REAL,                           INTENT(OUT) :: GHB    <font color=#447700>!ground heat flux (w/m2)  [+ to soil]<a name='3866'></font>
  REAL,                           INTENT(OUT) :: T2MB   <font color=#447700>!2 m height air temperature (k)<a name='3867'></font>
<font color=#447700>!jref:start<a name='3868'></font>
  REAL,                           INTENT(OUT) :: Q2B    <font color=#447700>!bare ground heat conductance<a name='3869'></font>
  REAL :: EHB    <font color=#447700>!bare ground heat conductance<a name='3870'></font>
  REAL :: U10B    <font color=#447700>!10 m wind speed in eastward dir (m/s)<a name='3871'></font>
  REAL :: V10B    <font color=#447700>!10 m wind speed in eastward dir (m/s)<a name='3872'></font>
  REAL :: WSPD<a name='3873'>
<font color=#447700>!jref:end<a name='3874'></font>
<a name='3875'>
<font color=#447700>! local variables <a name='3876'></font>
<a name='3877'>
  REAL :: TAUX       <font color=#447700>!wind stress: e-w (n/m2)<a name='3878'></font>
  REAL :: TAUY       <font color=#447700>!wind stress: n-s (n/m2)<a name='3879'></font>
  REAL :: FIRA       <font color=#447700>!total net longwave rad (w/m2)      [+ to atm]<a name='3880'></font>
  REAL :: FSH        <font color=#447700>!total sensible heat flux (w/m2)    [+ to atm]<a name='3881'></font>
  REAL :: FGEV       <font color=#447700>!ground evaporation heat flux (w/m2)[+ to atm]<a name='3882'></font>
  REAL :: SSOIL      <font color=#447700>!soil heat flux (w/m2)             [+ to soil]<a name='3883'></font>
  REAL :: FIRE       <font color=#447700>!emitted ir (w/m2)<a name='3884'></font>
  REAL :: TRAD       <font color=#447700>!radiative temperature (k)<a name='3885'></font>
  REAL :: TAH        <font color=#447700>!"surface" temperature at height z0h+zpd (k)<a name='3886'></font>
<a name='3887'>
  REAL :: CW         <font color=#447700>!water vapor exchange coefficient<a name='3888'></font>
  REAL :: FV         <font color=#447700>!friction velocity (m/s)<a name='3889'></font>
  REAL :: WSTAR      <font color=#447700>!friction velocity n vertical direction (m/s) (only for SFCDIF2)<a name='3890'></font>
  REAL :: Z0H        <font color=#447700>!roughness length, sensible heat, ground (m)<a name='3891'></font>
  REAL :: RB         <font color=#447700>!bulk leaf boundary layer resistance (s/m)<a name='3892'></font>
  REAL :: RAMB       <font color=#447700>!aerodynamic resistance for momentum (s/m)<a name='3893'></font>
  REAL :: RAHB       <font color=#447700>!aerodynamic resistance for sensible heat (s/m)<a name='3894'></font>
  REAL :: RAWB       <font color=#447700>!aerodynamic resistance for water vapor (s/m)<a name='3895'></font>
  REAL :: MOL        <font color=#447700>!Monin-Obukhov length (m)<a name='3896'></font>
  REAL :: DTG        <font color=#447700>!change in tg, last iteration (k)<a name='3897'></font>
<a name='3898'>
  REAL :: CIR        <font color=#447700>!coefficients for ir as function of ts**4<a name='3899'></font>
  REAL :: CSH        <font color=#447700>!coefficients for sh as function of ts<a name='3900'></font>
  REAL :: CEV        <font color=#447700>!coefficients for ev as function of esat[ts]<a name='3901'></font>
  REAL :: CGH        <font color=#447700>!coefficients for st as function of ts<a name='3902'></font>
<a name='3903'>
<font color=#447700>!jref:start<a name='3904'></font>
  REAL :: RAHB2      <font color=#447700>!aerodynamic resistance for sensible heat 2m (s/m)<a name='3905'></font>
  REAL :: RAWB2      <font color=#447700>!aerodynamic resistance for water vapor 2m (s/m)<a name='3906'></font>
  REAL,INTENT(OUT) :: EHB2       <font color=#447700>!sensible heat conductance for diagnostics<a name='3907'></font>
  REAL :: CH2B       <font color=#447700>!exchange coefficient for 2m temp.<a name='3908'></font>
  REAL :: CQ2B       <font color=#447700>!exchange coefficient for 2m temp.<a name='3909'></font>
  REAL :: THVAIR     <font color=#447700>!virtual potential air temp<a name='3910'></font>
  REAL :: THGH       <font color=#447700>!potential ground temp<a name='3911'></font>
  REAL :: EMB        <font color=#447700>!momentum conductance<a name='3912'></font>
  REAL :: QFX        <font color=#447700>!moisture flux<a name='3913'></font>
  REAL :: ESTG2      <font color=#447700>!saturation vapor pressure at 2m (pa)<a name='3914'></font>
  INTEGER :: VEGTYP     <font color=#447700>!vegetation type set to isbarren<a name='3915'></font>
  REAL :: E1<a name='3916'>
<font color=#447700>!jref:end<a name='3917'></font>
<a name='3918'>
  REAL :: ESTG       <font color=#447700>!saturation vapor pressure at tg (pa)<a name='3919'></font>
  REAL :: DESTG      <font color=#447700>!d(es)/dt at tg (pa/K)<a name='3920'></font>
  REAL :: ESATW      <font color=#447700>!es for water<a name='3921'></font>
  REAL :: ESATI      <font color=#447700>!es for ice<a name='3922'></font>
  REAL :: DSATW      <font color=#447700>!d(es)/dt at tg (pa/K) for water<a name='3923'></font>
  REAL :: DSATI      <font color=#447700>!d(es)/dt at tg (pa/K) for ice<a name='3924'></font>
<a name='3925'>
  REAL :: A          <font color=#447700>!temporary calculation<a name='3926'></font>
  REAL :: B          <font color=#447700>!temporary calculation<a name='3927'></font>
  REAL :: H          <font color=#447700>!temporary sensible heat flux (w/m2)<a name='3928'></font>
  REAL :: MOZ        <font color=#447700>!Monin-Obukhov stability parameter<a name='3929'></font>
  REAL :: MOZOLD     <font color=#447700>!Monin-Obukhov stability parameter from prior iteration<a name='3930'></font>
  REAL :: FM         <font color=#447700>!momentum stability correction, weighted by prior iters<a name='3931'></font>
  REAL :: FH         <font color=#447700>!sen heat stability correction, weighted by prior iters<a name='3932'></font>
  INTEGER :: MOZSGN  <font color=#447700>!number of times MOZ changes sign<a name='3933'></font>
  REAL :: FM2          <font color=#447700>!Monin-Obukhov momentum adjustment at 2m<a name='3934'></font>
  REAL :: FH2          <font color=#447700>!Monin-Obukhov heat adjustment at 2m<a name='3935'></font>
  REAL :: CH2          <font color=#447700>!Surface exchange at 2m<a name='3936'></font>
<a name='3937'>
  INTEGER :: ITER    <font color=#447700>!iteration index<a name='3938'></font>
  INTEGER :: NITERB  <font color=#447700>!number of iterations for surface temperature<a name='3939'></font>
  REAL    :: MPE     <font color=#447700>!prevents overflow error if division by zero<a name='3940'></font>
<font color=#447700>!jref:start<a name='3941'></font>
<font color=#447700>!  DATA NITERB /3/<a name='3942'></font>
  DATA NITERB /5/<a name='3943'>
  SAVE NITERB<a name='3944'>
  REAL :: T, TDC     <font color=#447700>!Kelvin to degree Celsius with limit -50 to +50<a name='3945'></font>
  TDC(T)   = MIN( 50., MAX(-50.,(T-TFRZ)) )<a name='3946'>
<a name='3947'>
<font color=#447700>! -----------------------------------------------------------------<a name='3948'></font>
<font color=#447700>! initialization variables that do not depend on stability iteration<a name='3949'></font>
<font color=#447700>! -----------------------------------------------------------------<a name='3950'></font>
        MPE = 1E-6<a name='3951'>
        DTG = 0.<a name='3952'>
        MOZ    = 0.<a name='3953'>
        MOZSGN = 0<a name='3954'>
        MOZOLD = 0.<a name='3955'>
        FH2    = 0.<a name='3956'>
        H      = 0.<a name='3957'>
        QFX    = 0.<a name='3958'>
        FV     = 0.1<a name='3959'>
<a name='3960'>
        CIR = EMG*SB<a name='3961'>
        CGH = 2.*DF(ISNOW+1)/DZSNSO(ISNOW+1)<a name='3962'>
<a name='3963'>
<font color=#447700>! -----------------------------------------------------------------<a name='3964'></font>
      loop3: DO ITER = 1, NITERB  <font color=#447700>! begin stability iteration<a name='3965'></font>
<a name='3966'>
        IF(ITER == 1) THEN<a name='3967'>
            Z0H = Z0M <a name='3968'>
        ELSE<a name='3969'>
            Z0H = Z0M <font color=#447700>!* EXP(-CZIL*0.4*258.2*SQRT(FV*Z0M))<a name='3970'></font>
        END IF<a name='3971'>
<a name='3972'>
        IF(OPT_SFC == 1) THEN<a name='3973'>
          CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#SFCDIF1'>SFCDIF1</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#BARE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIF1_2">(parameters,ITER   ,SFCTMP ,RHOAIR ,H      ,QAIR   , &amp; <font color=#447700>!in<a name='3974'></font>
                       ZLVL   ,ZPD    ,Z0M    ,Z0H    ,UR     , &amp; <font color=#447700>!in<a name='3975'></font>
                       MPE    ,ILOC   ,JLOC   ,                 &amp; <font color=#447700>!in<a name='3976'></font>
                       MOZ    ,MOZSGN ,FM     ,FH     ,FM2,FH2, &amp; <font color=#447700>!inout<a name='3977'></font>
                       CM     ,CH     ,FV     ,CH2     )          <font color=#447700>!out<a name='3978'></font>
        ENDIF<a name='3979'>
<a name='3980'>
        IF(OPT_SFC == 2) THEN<a name='3981'>
          CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#SFCDIF2'>SFCDIF2</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#BARE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIF2_2">(parameters,ITER   ,Z0M    ,TGB    ,THAIR  ,UR     , &amp; <font color=#447700>!in<a name='3982'></font>
                       ZLVL   ,ILOC   ,JLOC   ,         &amp; <font color=#447700>!in<a name='3983'></font>
                       CM     ,CH     ,MOZ    ,WSTAR  ,         &amp; <font color=#447700>!in<a name='3984'></font>
                       FV     )                                   <font color=#447700>!out<a name='3985'></font>
          <font color=#447700>! Undo the multiplication by windspeed that SFCDIF2 <a name='3986'></font>
          <font color=#447700>! applies to exchange coefficients CH and CM:<a name='3987'></font>
          CH = CH / UR<a name='3988'>
          CM = CM / UR<a name='3989'>
          IF(SNOWH &gt; 0.) THEN<a name='3990'>
             CM = MIN(0.01,CM)   <font color=#447700>! CM &amp; CH are too large, causing<a name='3991'></font>
             CH = MIN(0.01,CH)   <font color=#447700>! computational instability<a name='3992'></font>
          END IF<a name='3993'>
<a name='3994'>
        ENDIF<a name='3995'>
<a name='3996'>
        RAMB = MAX(1.,1./(CM*UR))<a name='3997'>
        RAHB = MAX(1.,1./(CH*UR))<a name='3998'>
        RAWB = RAHB<a name='3999'>
<a name='4000'>
<font color=#447700>!jref - variables for diagnostics         <a name='4001'></font>
        EMB = 1./RAMB<a name='4002'>
        EHB = 1./RAHB<a name='4003'>
<a name='4004'>
<font color=#447700>! es and d(es)/dt evaluated at tg<a name='4005'></font>
<a name='4006'>
        T = TDC(TGB)<a name='4007'>
        CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#ESAT'>ESAT</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#BARE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESAT_7">(T, ESATW, ESATI, DSATW, DSATI)<a name='4008'>
        IF (T .GT. 0.) THEN<a name='4009'>
            ESTG  = ESATW<a name='4010'>
            DESTG = DSATW<a name='4011'>
        ELSE<a name='4012'>
            ESTG  = ESATI<a name='4013'>
            DESTG = DSATI<a name='4014'>
        END IF<a name='4015'>
<a name='4016'>
        CSH = RHOAIR*CPAIR/RAHB<a name='4017'>
        CEV = RHOAIR*CPAIR/GAMMA/(RSURF+RAWB)<a name='4018'>
<a name='4019'>
<font color=#447700>! surface fluxes and dtg<a name='4020'></font>
<a name='4021'>
        IRB   = CIR * TGB**4 - EMG*LWDN<a name='4022'>
        SHB   = CSH * (TGB        - SFCTMP      )<a name='4023'>
        EVB   = CEV * (ESTG*RHSUR - EAIR        )<a name='4024'>
        GHB   = CGH * (TGB        - STC(ISNOW+1))<a name='4025'>
<a name='4026'>
        B     = SAG-IRB-SHB-EVB-GHB+PAHB<a name='4027'>
        A     = 4.*CIR*TGB**3 + CSH + CEV*DESTG + CGH<a name='4028'>
        DTG   = B/A<a name='4029'>
<a name='4030'>
        IRB = IRB + 4.*CIR*TGB**3*DTG<a name='4031'>
        SHB = SHB + CSH*DTG<a name='4032'>
        EVB = EVB + CEV*DESTG*DTG<a name='4033'>
        GHB = GHB + CGH*DTG<a name='4034'>
<a name='4035'>
<font color=#447700>! update ground surface temperature<a name='4036'></font>
        TGB = TGB + DTG<a name='4037'>
<a name='4038'>
<font color=#447700>! for M-O length<a name='4039'></font>
        H = CSH * (TGB - SFCTMP)<a name='4040'>
<a name='4041'>
        T = TDC(TGB)<a name='4042'>
        CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#ESAT'>ESAT</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#BARE_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESAT_8">(T, ESATW, ESATI, DSATW, DSATI)<a name='4043'>
        IF (T .GT. 0.) THEN<a name='4044'>
            ESTG  = ESATW<a name='4045'>
        ELSE<a name='4046'>
            ESTG  = ESATI<a name='4047'>
        END IF<a name='4048'>
        QSFC = 0.622*(ESTG*RHSUR)/(PSFC-0.378*(ESTG*RHSUR))<a name='4049'>
<a name='4050'>
        QFX = (QSFC-QAIR)*CEV*GAMMA/CPAIR<a name='4051'>
<a name='4052'>
     END DO loop3 <font color=#447700>! end stability iteration<a name='4053'></font>
<font color=#447700>! -----------------------------------------------------------------<a name='4054'></font>
<a name='4055'>
<font color=#447700>! if snow on ground and TG &gt; TFRZ: reset TG = TFRZ. reevaluate ground fluxes.<a name='4056'></font>
<a name='4057'>
     IF(OPT_STC == 1 .OR. OPT_STC == 3) THEN<a name='4058'>
     IF (SNOWH &gt; 0.05 .AND. TGB &gt; TFRZ) THEN<a name='4059'>
          IF(OPT_STC == 1) TGB = TFRZ<a name='4060'>
          IF(OPT_STC == 3) TGB  = (1.-FSNO)*TGB + FSNO*TFRZ  <font color=#447700>! MB: allow TG&gt;0C during melt v3.7<a name='4061'></font>
          IRB = CIR * TGB**4 - EMG*LWDN<a name='4062'>
          SHB = CSH * (TGB        - SFCTMP)<a name='4063'>
          EVB = CEV * (ESTG*RHSUR - EAIR )          <font color=#447700>!ESTG reevaluate ?<a name='4064'></font>
          GHB = SAG+PAHB - (IRB+SHB+EVB)<a name='4065'>
     END IF<a name='4066'>
     END IF<a name='4067'>
<a name='4068'>
<font color=#447700>! wind stresses<a name='4069'></font>
         <a name='4070'>
     TAUXB = -RHOAIR*CM*UR*UU<a name='4071'>
     TAUYB = -RHOAIR*CM*UR*VV<a name='4072'>
<a name='4073'>
<font color=#447700>!jref:start; errors in original equation corrected.<a name='4074'></font>
<font color=#447700>! 2m air temperature<a name='4075'></font>
     IF(OPT_SFC == 1 .OR. OPT_SFC ==2) THEN<a name='4076'>
       EHB2  = FV*VKC/LOG((2.+Z0H)/Z0H)<a name='4077'>
       EHB2  = FV*VKC/(LOG((2.+Z0H)/Z0H)-FH2)<a name='4078'>
       CQ2B  = EHB2<a name='4079'>
       IF (EHB2.lt.1.E-5 ) THEN<a name='4080'>
         T2MB  = TGB<a name='4081'>
         Q2B   = QSFC<a name='4082'>
       ELSE<a name='4083'>
         T2MB  = TGB - SHB/(RHOAIR*CPAIR) * 1./EHB2<a name='4084'>
         Q2B   = QSFC - EVB/(LATHEA*RHOAIR)*(1./CQ2B + RSURF)<a name='4085'>
       ENDIF<a name='4086'>
       IF (parameters%urban_flag) Q2B = QSFC<a name='4087'>
     END IF<a name='4088'>
<a name='4089'>
<font color=#447700>! update CH <a name='4090'></font>
     CH = EHB<a name='4091'>
<a name='4092'>
  END SUBROUTINE BARE_FLUX<a name='4093'>
<a name='4094'>
<font color=#447700>!== begin ragrb ====================================================================================<a name='4095'></font>
<a name='4096'>
<A NAME='RAGRB'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#RAGRB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4097'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>RAGRB</font>(parameters,ITER   ,VAI    ,RHOAIR ,HG     ,TAH    , &amp; <font color=#447700>!in <A href='../../call_to/RAGRB.html' TARGET='index'>1</A><a name='4098'></font>
                   ZPD    ,Z0MG   ,Z0HG   ,HCAN   ,UC     , &amp; <font color=#447700>!in<a name='4099'></font>
                   Z0H    ,FV     ,CWP    ,VEGTYP ,MPE    , &amp; <font color=#447700>!in<a name='4100'></font>
                   TV     ,MOZG   ,FHG    ,ILOC   ,JLOC   , &amp; <font color=#447700>!inout<a name='4101'></font>
                   RAMG   ,RAHG   ,RAWG   ,RB     )           <font color=#447700>!out<a name='4102'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='4103'></font>
<font color=#447700>! compute under-canopy aerodynamic resistance RAG and leaf boundary layer<a name='4104'></font>
<font color=#447700>! resistance RB<a name='4105'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='4106'></font>
  IMPLICIT NONE<a name='4107'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='4108'></font>
<font color=#447700>! inputs<a name='4109'></font>
<a name='4110'>
  type (noahmp_parameters), intent(in) :: parameters<a name='4111'>
  INTEGER,              INTENT(IN) :: ILOC   <font color=#447700>!grid index<a name='4112'></font>
  INTEGER,              INTENT(IN) :: JLOC   <font color=#447700>!grid index<a name='4113'></font>
  INTEGER,              INTENT(IN) :: ITER   <font color=#447700>!iteration index<a name='4114'></font>
  INTEGER,              INTENT(IN) :: VEGTYP <font color=#447700>!vegetation physiology type<a name='4115'></font>
  REAL,                 INTENT(IN) :: VAI    <font color=#447700>!total LAI + stem area index, one sided<a name='4116'></font>
  REAL,                 INTENT(IN) :: RHOAIR <font color=#447700>!density air (kg/m3)<a name='4117'></font>
  REAL,                 INTENT(IN) :: HG     <font color=#447700>!ground sensible heat flux (w/m2)<a name='4118'></font>
  REAL,                 INTENT(IN) :: TV     <font color=#447700>!vegetation temperature (k)<a name='4119'></font>
  REAL,                 INTENT(IN) :: TAH    <font color=#447700>!air temperature at height z0h+zpd (k)<a name='4120'></font>
  REAL,                 INTENT(IN) :: ZPD    <font color=#447700>!zero plane displacement (m)<a name='4121'></font>
  REAL,                 INTENT(IN) :: Z0MG   <font color=#447700>!roughness length, momentum, ground (m)<a name='4122'></font>
  REAL,                 INTENT(IN) :: HCAN   <font color=#447700>!canopy height (m) [note: hcan &gt;= z0mg]<a name='4123'></font>
  REAL,                 INTENT(IN) :: UC     <font color=#447700>!wind speed at top of canopy (m/s)<a name='4124'></font>
  REAL,                 INTENT(IN) :: Z0H    <font color=#447700>!roughness length, sensible heat (m)<a name='4125'></font>
  REAL,                 INTENT(IN) :: Z0HG   <font color=#447700>!roughness length, sensible heat, ground (m)<a name='4126'></font>
  REAL,                 INTENT(IN) :: FV     <font color=#447700>!friction velocity (m/s)<a name='4127'></font>
  REAL,                 INTENT(IN) :: CWP    <font color=#447700>!canopy wind parameter<a name='4128'></font>
  REAL,                 INTENT(IN) :: MPE    <font color=#447700>!prevents overflow error if division by zero<a name='4129'></font>
<a name='4130'>
<font color=#447700>! in &amp; out<a name='4131'></font>
<a name='4132'>
  REAL,              INTENT(INOUT) :: MOZG   <font color=#447700>!Monin-Obukhov stability parameter<a name='4133'></font>
  REAL,              INTENT(INOUT) :: FHG    <font color=#447700>!stability correction<a name='4134'></font>
<a name='4135'>
<font color=#447700>! outputs<a name='4136'></font>
  REAL                             :: RAMG   <font color=#447700>!aerodynamic resistance for momentum (s/m)<a name='4137'></font>
  REAL                             :: RAHG   <font color=#447700>!aerodynamic resistance for sensible heat (s/m)<a name='4138'></font>
  REAL                             :: RAWG   <font color=#447700>!aerodynamic resistance for water vapor (s/m)<a name='4139'></font>
  REAL                             :: RB     <font color=#447700>!bulk leaf boundary layer resistance (s/m)<a name='4140'></font>
<a name='4141'>
<a name='4142'>
  REAL :: KH           <font color=#447700>!turbulent transfer coefficient, sensible heat, (m2/s)<a name='4143'></font>
  REAL :: TMP1         <font color=#447700>!temporary calculation<a name='4144'></font>
  REAL :: TMP2         <font color=#447700>!temporary calculation<a name='4145'></font>
  REAL :: TMPRAH2      <font color=#447700>!temporary calculation for aerodynamic resistances<a name='4146'></font>
  REAL :: TMPRB        <font color=#447700>!temporary calculation for rb<a name='4147'></font>
  real :: MOLG,FHGNEW,CWPC<a name='4148'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='4149'></font>
<font color=#447700>! stability correction to below canopy resistance<a name='4150'></font>
<a name='4151'>
       MOZG = 0.<a name='4152'>
       MOLG = 0.<a name='4153'>
<a name='4154'>
       IF(ITER &gt; 1) THEN<a name='4155'>
        TMP1 = VKC * (GRAV/TAH) * HG/(RHOAIR*CPAIR)<a name='4156'>
        IF (ABS(TMP1) .LE. MPE) TMP1 = MPE<a name='4157'>
        MOLG = -1. * FV**3 / TMP1<a name='4158'>
        MOZG = MIN( (ZPD-Z0MG)/MOLG, 1.)<a name='4159'>
       END IF<a name='4160'>
<a name='4161'>
       IF (MOZG &lt; 0.) THEN<a name='4162'>
          FHGNEW  = (1. - 15.*MOZG)**(-0.25)<a name='4163'>
       ELSE<a name='4164'>
          FHGNEW  = 1.+ 4.7*MOZG<a name='4165'>
       ENDIF<a name='4166'>
<a name='4167'>
       IF (ITER == 1) THEN<a name='4168'>
          FHG = FHGNEW<a name='4169'>
       ELSE<a name='4170'>
          FHG = 0.5 * (FHG+FHGNEW)<a name='4171'>
       ENDIF<a name='4172'>
<a name='4173'>
       CWPC = (CWP * VAI * HCAN * FHG)**0.5<a name='4174'>
<font color=#447700>!       CWPC = (CWP*FHG)**0.5<a name='4175'></font>
<a name='4176'>
       TMP1 = EXP( -CWPC*Z0HG/HCAN )<a name='4177'>
       TMP2 = EXP( -CWPC*(Z0H+ZPD)/HCAN )<a name='4178'>
       TMPRAH2 = HCAN*EXP(CWPC) / CWPC * (TMP1-TMP2)<a name='4179'>
<a name='4180'>
<font color=#447700>! aerodynamic resistances raw and rah between heights zpd+z0h and z0hg.<a name='4181'></font>
<a name='4182'>
       KH  = MAX ( VKC*FV*(HCAN-ZPD), MPE )<a name='4183'>
       RAMG = 0.<a name='4184'>
       RAHG = TMPRAH2 / KH<a name='4185'>
       RAWG = RAHG<a name='4186'>
<a name='4187'>
<font color=#447700>! leaf boundary layer resistance<a name='4188'></font>
<a name='4189'>
       TMPRB  = CWPC*50. / (1. - EXP(-CWPC/2.))<a name='4190'>
       RB     = TMPRB * SQRT(parameters%DLEAF/UC)<a name='4191'>
<font color=#447700>!       RB = 200<a name='4192'></font>
<a name='4193'>
  END SUBROUTINE RAGRB<a name='4194'>
<a name='4195'>
<font color=#447700>!== begin sfcdif1 ==================================================================================<a name='4196'></font>
<a name='4197'>
<A NAME='SFCDIF1'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SFCDIF1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4198'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFCDIF1</font>(parameters,ITER   ,SFCTMP ,RHOAIR ,H      ,QAIR   , &amp; <font color=#447700>!in <A href='../../call_to/SFCDIF1.html' TARGET='index'>2</A>,<A href='../../call_from/SFCDIF1.html' TARGET='index'>1</A><a name='4199'></font>
       &amp;             ZLVL   ,ZPD    ,Z0M    ,Z0H    ,UR     , &amp; <font color=#447700>!in<a name='4200'></font>
       &amp;             MPE    ,ILOC   ,JLOC   ,                 &amp; <font color=#447700>!in<a name='4201'></font>
       &amp;             MOZ    ,MOZSGN ,FM     ,FH     ,FM2,FH2, &amp; <font color=#447700>!inout<a name='4202'></font>
       &amp;             CM     ,CH     ,FV     ,CH2     )          <font color=#447700>!out<a name='4203'></font>
<font color=#447700>! -------------------------------------------------------------------------------------------------<a name='4204'></font>
<font color=#447700>! computing surface drag coefficient CM for momentum and CH for heat<a name='4205'></font>
<font color=#447700>! -------------------------------------------------------------------------------------------------<a name='4206'></font>
    IMPLICIT NONE<a name='4207'>
<font color=#447700>! -------------------------------------------------------------------------------------------------<a name='4208'></font>
<font color=#447700>! inputs<a name='4209'></font>
    <a name='4210'>
  type (noahmp_parameters), intent(in) :: parameters<a name='4211'>
    INTEGER,              INTENT(IN) :: ILOC   <font color=#447700>!grid index<a name='4212'></font>
    INTEGER,              INTENT(IN) :: JLOC   <font color=#447700>!grid index<a name='4213'></font>
    INTEGER,              INTENT(IN) :: ITER   <font color=#447700>!iteration index<a name='4214'></font>
    REAL,                 INTENT(IN) :: SFCTMP <font color=#447700>!temperature at reference height (k)<a name='4215'></font>
    REAL,                 INTENT(IN) :: RHOAIR <font color=#447700>!density air (kg/m**3)<a name='4216'></font>
    REAL,                 INTENT(IN) :: H      <font color=#447700>!sensible heat flux (w/m2) [+ to atm]<a name='4217'></font>
    REAL,                 INTENT(IN) :: QAIR   <font color=#447700>!specific humidity at reference height (kg/kg)<a name='4218'></font>
    REAL,                 INTENT(IN) :: ZLVL   <font color=#447700>!reference height  (m)<a name='4219'></font>
    REAL,                 INTENT(IN) :: ZPD    <font color=#447700>!zero plane displacement (m)<a name='4220'></font>
    REAL,                 INTENT(IN) :: Z0H    <font color=#447700>!roughness length, sensible heat, ground (m)<a name='4221'></font>
    REAL,                 INTENT(IN) :: Z0M    <font color=#447700>!roughness length, momentum, ground (m)<a name='4222'></font>
    REAL,                 INTENT(IN) :: UR     <font color=#447700>!wind speed (m/s)<a name='4223'></font>
    REAL,                 INTENT(IN) :: MPE    <font color=#447700>!prevents overflow error if division by zero<a name='4224'></font>
<font color=#447700>! in &amp; out<a name='4225'></font>
<a name='4226'>
    INTEGER,           INTENT(INOUT) :: MOZSGN <font color=#447700>!number of times moz changes sign<a name='4227'></font>
    REAL,              INTENT(INOUT) :: MOZ    <font color=#447700>!Monin-Obukhov stability (z/L)<a name='4228'></font>
    REAL,              INTENT(INOUT) :: FM     <font color=#447700>!momentum stability correction, weighted by prior iters<a name='4229'></font>
    REAL,              INTENT(INOUT) :: FH     <font color=#447700>!sen heat stability correction, weighted by prior iters<a name='4230'></font>
    REAL,              INTENT(INOUT) :: FM2    <font color=#447700>!sen heat stability correction, weighted by prior iters<a name='4231'></font>
    REAL,              INTENT(INOUT) :: FH2    <font color=#447700>!sen heat stability correction, weighted by prior iters<a name='4232'></font>
<a name='4233'>
<font color=#447700>! outputs<a name='4234'></font>
<a name='4235'>
    REAL,                INTENT(OUT) :: CM     <font color=#447700>!drag coefficient for momentum<a name='4236'></font>
    REAL,                INTENT(OUT) :: CH     <font color=#447700>!drag coefficient for heat<a name='4237'></font>
    REAL,                INTENT(OUT) :: FV     <font color=#447700>!friction velocity (m/s)<a name='4238'></font>
    REAL,                INTENT(OUT) :: CH2    <font color=#447700>!drag coefficient for heat<a name='4239'></font>
<a name='4240'>
<font color=#447700>! locals<a name='4241'></font>
    REAL    :: MOL                      <font color=#447700>!Monin-Obukhov length (m)<a name='4242'></font>
    REAL    :: TMPCM                    <font color=#447700>!temporary calculation for CM<a name='4243'></font>
    REAL    :: TMPCH                    <font color=#447700>!temporary calculation for CH<a name='4244'></font>
    REAL    :: FMNEW                    <font color=#447700>!stability correction factor, momentum, for current moz<a name='4245'></font>
    REAL    :: FHNEW                    <font color=#447700>!stability correction factor, sen heat, for current moz<a name='4246'></font>
    REAL    :: MOZOLD                   <font color=#447700>!Monin-Obukhov stability parameter from prior iteration<a name='4247'></font>
    REAL    :: TMP1,TMP2,TMP3,TMP4,TMP5 <font color=#447700>!temporary calculation<a name='4248'></font>
    REAL    :: TVIR                     <font color=#447700>!temporary virtual temperature (k)<a name='4249'></font>
    REAL    :: MOZ2                     <font color=#447700>!2/L<a name='4250'></font>
    REAL    :: TMPCM2                   <font color=#447700>!temporary calculation for CM2<a name='4251'></font>
    REAL    :: TMPCH2                   <font color=#447700>!temporary calculation for CH2<a name='4252'></font>
    REAL    :: FM2NEW                   <font color=#447700>!stability correction factor, momentum, for current moz<a name='4253'></font>
    REAL    :: FH2NEW                   <font color=#447700>!stability correction factor, sen heat, for current moz<a name='4254'></font>
    REAL    :: TMP12,TMP22,TMP32        <font color=#447700>!temporary calculation<a name='4255'></font>
<a name='4256'>
    REAL    :: CMFM, CHFH, CM2FM2, CH2FH2<a name='4257'>
<font color=#447700>! -------------------------------------------------------------------------------------------------<a name='4258'></font>
<font color=#447700>! Monin-Obukhov stability parameter moz for next iteration<a name='4259'></font>
<a name='4260'>
    MOZOLD = MOZ<a name='4261'>
  <a name='4262'>
    IF(ZLVL &lt;= ZPD) THEN<a name='4263'>
       write(*,*) 'critical problem: ZLVL &lt;= ZPD; model stops'<a name='4264'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SFCDIF1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1191">("STOP in Noah-MP")<a name='4265'>
    ENDIF<a name='4266'>
<a name='4267'>
    TMPCM = LOG((ZLVL-ZPD) / Z0M)<a name='4268'>
    TMPCH = LOG((ZLVL-ZPD) / Z0H)<a name='4269'>
    TMPCM2 = LOG((2.0 + Z0M) / Z0M)<a name='4270'>
    TMPCH2 = LOG((2.0 + Z0H) / Z0H)<a name='4271'>
<a name='4272'>
    IF(ITER == 1) THEN<a name='4273'>
       FV   = 0.0<a name='4274'>
       MOZ  = 0.0<a name='4275'>
       MOL  = 0.0<a name='4276'>
       MOZ2 = 0.0<a name='4277'>
    ELSE<a name='4278'>
       TVIR = (1. + 0.61*QAIR) * SFCTMP<a name='4279'>
       TMP1 = VKC * (GRAV/TVIR) * H/(RHOAIR*CPAIR)<a name='4280'>
       IF (ABS(TMP1) .LE. MPE) TMP1 = MPE<a name='4281'>
       MOL  = -1. * FV**3 / TMP1<a name='4282'>
       MOZ  = MIN( (ZLVL-ZPD)/MOL, 1.)<a name='4283'>
       MOZ2  = MIN( (2.0 + Z0H)/MOL, 1.)<a name='4284'>
    ENDIF<a name='4285'>
<a name='4286'>
<font color=#447700>! accumulate number of times moz changes sign.<a name='4287'></font>
<a name='4288'>
    IF (MOZOLD*MOZ .LT. 0.) MOZSGN = MOZSGN+1<a name='4289'>
    IF (MOZSGN .GE. 2) THEN<a name='4290'>
       MOZ = 0.<a name='4291'>
       FM = 0.<a name='4292'>
       FH = 0.<a name='4293'>
       MOZ2 = 0.<a name='4294'>
       FM2 = 0.<a name='4295'>
       FH2 = 0.<a name='4296'>
    ENDIF<a name='4297'>
<a name='4298'>
<font color=#447700>! evaluate stability-dependent variables using moz from prior iteration<a name='4299'></font>
    IF (MOZ .LT. 0.) THEN<a name='4300'>
       TMP1 = (1. - 16.*MOZ)**0.25<a name='4301'>
       TMP2 = LOG((1.+TMP1*TMP1)/2.)<a name='4302'>
       TMP3 = LOG((1.+TMP1)/2.)<a name='4303'>
       FMNEW = 2.*TMP3 + TMP2 - 2.*ATAN(TMP1) + 1.5707963<a name='4304'>
       FHNEW = 2*TMP2<a name='4305'>
<a name='4306'>
<font color=#447700>! 2-meter<a name='4307'></font>
       TMP12 = (1. - 16.*MOZ2)**0.25<a name='4308'>
       TMP22 = LOG((1.+TMP12*TMP12)/2.)<a name='4309'>
       TMP32 = LOG((1.+TMP12)/2.)<a name='4310'>
       FM2NEW = 2.*TMP32 + TMP22 - 2.*ATAN(TMP12) + 1.5707963<a name='4311'>
       FH2NEW = 2*TMP22<a name='4312'>
    ELSE<a name='4313'>
       FMNEW = -5.*MOZ<a name='4314'>
       FHNEW = FMNEW<a name='4315'>
       FM2NEW = -5.*MOZ2<a name='4316'>
       FH2NEW = FM2NEW<a name='4317'>
    ENDIF<a name='4318'>
<a name='4319'>
<font color=#447700>! except for first iteration, weight stability factors for previous<a name='4320'></font>
<font color=#447700>! iteration to help avoid flip-flops from one iteration to the next<a name='4321'></font>
<a name='4322'>
    IF (ITER == 1) THEN<a name='4323'>
       FM = FMNEW<a name='4324'>
       FH = FHNEW<a name='4325'>
       FM2 = FM2NEW<a name='4326'>
       FH2 = FH2NEW<a name='4327'>
    ELSE<a name='4328'>
       FM = 0.5 * (FM+FMNEW)<a name='4329'>
       FH = 0.5 * (FH+FHNEW)<a name='4330'>
       FM2 = 0.5 * (FM2+FM2NEW)<a name='4331'>
       FH2 = 0.5 * (FH2+FH2NEW)<a name='4332'>
    ENDIF<a name='4333'>
<a name='4334'>
<font color=#447700>! exchange coefficients<a name='4335'></font>
<a name='4336'>
    FH = MIN(FH,0.9*TMPCH)<a name='4337'>
    FM = MIN(FM,0.9*TMPCM)<a name='4338'>
    FH2 = MIN(FH2,0.9*TMPCH2)<a name='4339'>
    FM2 = MIN(FM2,0.9*TMPCM2)<a name='4340'>
<a name='4341'>
    CMFM = TMPCM-FM<a name='4342'>
    CHFH = TMPCH-FH<a name='4343'>
    CM2FM2 = TMPCM2-FM2<a name='4344'>
    CH2FH2 = TMPCH2-FH2<a name='4345'>
    IF(ABS(CMFM) &lt;= MPE) CMFM = MPE<a name='4346'>
    IF(ABS(CHFH) &lt;= MPE) CHFH = MPE<a name='4347'>
    IF(ABS(CM2FM2) &lt;= MPE) CM2FM2 = MPE<a name='4348'>
    IF(ABS(CH2FH2) &lt;= MPE) CH2FH2 = MPE<a name='4349'>
    CM  = VKC*VKC/(CMFM*CMFM)<a name='4350'>
    CH  = VKC*VKC/(CMFM*CHFH)<a name='4351'>
    CH2  = VKC*VKC/(CM2FM2*CH2FH2)<a name='4352'>
        <a name='4353'>
<font color=#447700>! friction velocity<a name='4354'></font>
<a name='4355'>
    FV = UR * SQRT(CM)<a name='4356'>
    CH2  = VKC*FV/CH2FH2<a name='4357'>
<a name='4358'>
  END SUBROUTINE SFCDIF1<a name='4359'>
<a name='4360'>
<font color=#447700>!== begin sfcdif2 ==================================================================================<a name='4361'></font>
<a name='4362'>
<A NAME='SFCDIF2'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SFCDIF2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4363'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFCDIF2</font>(parameters,ITER   ,Z0     ,THZ0   ,THLM   ,SFCSPD , &amp; <font color=#447700>!in <A href='../../call_to/SFCDIF2.html' TARGET='index'>2</A><a name='4364'></font>
                     ZLM    ,ILOC   ,JLOC   ,         &amp; <font color=#447700>!in<a name='4365'></font>
                     AKMS   ,AKHS   ,RLMO   ,WSTAR2 ,         &amp; <font color=#447700>!in<a name='4366'></font>
                     USTAR  )                                   <font color=#447700>!out<a name='4367'></font>
<a name='4368'>
<font color=#447700>! -------------------------------------------------------------------------------------------------<a name='4369'></font>
<font color=#447700>! SUBROUTINE SFCDIF (renamed SFCDIF_off to avoid clash with Eta PBL)<a name='4370'></font>
<font color=#447700>! -------------------------------------------------------------------------------------------------<a name='4371'></font>
<font color=#447700>! CALCULATE SURFACE LAYER EXCHANGE COEFFICIENTS VIA ITERATIVE PROCESS.<a name='4372'></font>
<font color=#447700>! SEE CHEN ET AL (1997, BLM)<a name='4373'></font>
<font color=#447700>! -------------------------------------------------------------------------------------------------<a name='4374'></font>
    IMPLICIT NONE<a name='4375'>
  type (noahmp_parameters), intent(in) :: parameters<a name='4376'>
    INTEGER, INTENT(IN) :: ILOC<a name='4377'>
    INTEGER, INTENT(IN) :: JLOC<a name='4378'>
    INTEGER, INTENT(IN) :: ITER<a name='4379'>
    REAL,    INTENT(IN) :: ZLM, Z0, THZ0, THLM, SFCSPD<a name='4380'>
    REAL, intent(INOUT) :: AKMS<a name='4381'>
    REAL, intent(INOUT) :: AKHS<a name='4382'>
    REAL, intent(INOUT) :: RLMO<a name='4383'>
    REAL, intent(INOUT) :: WSTAR2<a name='4384'>
    REAL,   intent(OUT) :: USTAR<a name='4385'>
<a name='4386'>
    REAL     ZZ, PSLMU, PSLMS, PSLHU, PSLHS<a name='4387'>
    REAL     XX, PSPMU, YY, PSPMS, PSPHU, PSPHS<a name='4388'>
    REAL     ZILFC, ZU, ZT, RDZ, CXCH<a name='4389'>
    REAL     DTHV, DU2, BTGH, ZSLU, ZSLT, RLOGU, RLOGT<a name='4390'>
    REAL     ZETALT, ZETALU, ZETAU, ZETAT, XLU4, XLT4, XU4, XT4<a name='4391'>
<a name='4392'>
    REAL     XLU, XLT, XU, XT, PSMZ, SIMM, PSHZ, SIMH, USTARK, RLMN,  &amp;<a name='4393'>
         &amp;         RLMA<a name='4394'>
<a name='4395'>
    INTEGER  ILECH, ITR<a name='4396'>
<a name='4397'>
    INTEGER, PARAMETER :: ITRMX  = 5<a name='4398'>
    REAL,    PARAMETER :: WWST   = 1.2<a name='4399'>
    REAL,    PARAMETER :: WWST2  = WWST * WWST<a name='4400'>
    REAL,    PARAMETER :: VKRM   = 0.40<a name='4401'>
    REAL,    PARAMETER :: EXCM   = 0.001<a name='4402'>
    REAL,    PARAMETER :: BETA   = 1.0 / 270.0<a name='4403'>
    REAL,    PARAMETER :: BTG    = BETA * GRAV<a name='4404'>
    REAL,    PARAMETER :: ELFC   = VKRM * BTG<a name='4405'>
    REAL,    PARAMETER :: WOLD   = 0.15<a name='4406'>
    REAL,    PARAMETER :: WNEW   = 1.0 - WOLD<a name='4407'>
    REAL,    PARAMETER :: PIHF   = 3.14159265 / 2.<a name='4408'>
    REAL,    PARAMETER :: EPSU2  = 1.E-4<a name='4409'>
    REAL,    PARAMETER :: EPSUST = 0.07<a name='4410'>
    REAL,    PARAMETER :: EPSIT  = 1.E-4<a name='4411'>
    REAL,    PARAMETER :: EPSA   = 1.E-8<a name='4412'>
    REAL,    PARAMETER :: ZTMIN  = -5.0<a name='4413'>
    REAL,    PARAMETER :: ZTMAX  = 1.0<a name='4414'>
    REAL,    PARAMETER :: HPBL   = 1000.0<a name='4415'>
    REAL,    PARAMETER :: SQVISC = 258.2<a name='4416'>
    REAL,    PARAMETER :: RIC    = 0.183<a name='4417'>
    REAL,    PARAMETER :: RRIC   = 1.0 / RIC<a name='4418'>
    REAL,    PARAMETER :: FHNEU  = 0.8<a name='4419'>
    REAL,    PARAMETER :: RFC    = 0.191<a name='4420'>
    REAL,    PARAMETER :: RFAC   = RIC / ( FHNEU * RFC * RFC )<a name='4421'>
<a name='4422'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4423'></font>
<font color=#447700>! NOTE: THE TWO CODE BLOCKS BELOW DEFINE FUNCTIONS<a name='4424'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4425'></font>
<font color=#447700>! LECH'S SURFACE FUNCTIONS<a name='4426'></font>
    PSLMU (ZZ)= -0.96* log (1.0-4.5* ZZ)<a name='4427'>
    PSLMS (ZZ)= ZZ * RRIC -2.076* (1. -1./ (ZZ +1.))<a name='4428'>
    PSLHU (ZZ)= -0.96* log (1.0-4.5* ZZ)<a name='4429'>
    PSLHS (ZZ)= ZZ * RFAC -2.076* (1. -1./ (ZZ +1.))<a name='4430'>
<font color=#447700>! PAULSON'S SURFACE FUNCTIONS<a name='4431'></font>
    PSPMU (XX)= -2.* log ( (XX +1.)*0.5) - log ( (XX * XX +1.)*0.5)   &amp;<a name='4432'>
         &amp;        +2.* ATAN (XX)                                            &amp;<a name='4433'>
         &amp;- PIHF<a name='4434'>
    PSPMS (YY)= 5.* YY<a name='4435'>
    PSPHU (XX)= -2.* log ( (XX * XX +1.)*0.5)<a name='4436'>
    PSPHS (YY)= 5.* YY<a name='4437'>
<a name='4438'>
<font color=#447700>! THIS ROUTINE SFCDIF CAN HANDLE BOTH OVER OPEN WATER (SEA, OCEAN) AND<a name='4439'></font>
<font color=#447700>! OVER SOLID SURFACE (LAND, SEA-ICE).<a name='4440'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4441'></font>
<font color=#447700>!     ZTFC: RATIO OF ZOH/ZOM  LESS OR EQUAL THAN 1<a name='4442'></font>
<font color=#447700>!     C......ZTFC=0.1<a name='4443'></font>
<font color=#447700>!     CZIL: CONSTANT C IN Zilitinkevich, S. S.1995,:NOTE ABOUT ZT<a name='4444'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4445'></font>
    ILECH = 0<a name='4446'>
<a name='4447'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4448'></font>
    ZILFC = - parameters%CZIL * VKRM * SQVISC<a name='4449'>
    ZU = Z0<a name='4450'>
    RDZ = 1./ ZLM<a name='4451'>
    CXCH = EXCM * RDZ<a name='4452'>
    DTHV = THLM - THZ0<a name='4453'>
<a name='4454'>
<font color=#447700>! BELJARS CORRECTION OF USTAR<a name='4455'></font>
    DU2 = MAX (SFCSPD * SFCSPD,EPSU2)<a name='4456'>
    BTGH = BTG * HPBL<a name='4457'>
<a name='4458'>
    IF(ITER == 1) THEN<a name='4459'>
        IF (BTGH * AKHS * DTHV .ne. 0.0) THEN<a name='4460'>
           WSTAR2 = WWST2* ABS (BTGH * AKHS * DTHV)** (2./3.)<a name='4461'>
        ELSE<a name='4462'>
           WSTAR2 = 0.0<a name='4463'>
        END IF<a name='4464'>
        USTAR = MAX (SQRT (AKMS * SQRT (DU2+ WSTAR2)),EPSUST)<a name='4465'>
        RLMO = ELFC * AKHS * DTHV / USTAR **3<a name='4466'>
    END IF<a name='4467'>
 <a name='4468'>
<font color=#447700>! ZILITINKEVITCH APPROACH FOR ZT<a name='4469'></font>
    ZT = MAX(1.E-6,EXP (ZILFC * SQRT (USTAR * Z0))* Z0)<a name='4470'>
    ZSLU = ZLM + ZU<a name='4471'>
    ZSLT = ZLM + ZT<a name='4472'>
    RLOGU = log (ZSLU / ZU)<a name='4473'>
    RLOGT = log (ZSLT / ZT)<a name='4474'>
<a name='4475'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4476'></font>
<font color=#447700>! 1./MONIN-OBUKKHOV LENGTH-SCALE<a name='4477'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4478'></font>
    ZETALT = MAX (ZSLT * RLMO,ZTMIN)<a name='4479'>
    RLMO = ZETALT / ZSLT<a name='4480'>
    ZETALU = ZSLU * RLMO<a name='4481'>
    ZETAU = ZU * RLMO<a name='4482'>
    ZETAT = ZT * RLMO<a name='4483'>
<a name='4484'>
    IF (ILECH .eq. 0) THEN<a name='4485'>
       IF (RLMO .lt. 0.)THEN<a name='4486'>
          XLU4 = 1. -16.* ZETALU<a name='4487'>
          XLT4 = 1. -16.* ZETALT<a name='4488'>
          XU4  = 1. -16.* ZETAU<a name='4489'>
          XT4  = 1. -16.* ZETAT<a name='4490'>
          XLU  = SQRT (SQRT (XLU4))<a name='4491'>
          XLT  = SQRT (SQRT (XLT4))<a name='4492'>
          XU   = SQRT (SQRT (XU4))<a name='4493'>
<a name='4494'>
          XT = SQRT (SQRT (XT4))<a name='4495'>
          PSMZ = PSPMU (XU)<a name='4496'>
          SIMM = PSPMU (XLU) - PSMZ + RLOGU<a name='4497'>
          PSHZ = PSPHU (XT)<a name='4498'>
          SIMH = PSPHU (XLT) - PSHZ + RLOGT<a name='4499'>
       ELSE<a name='4500'>
          ZETALU = MIN (ZETALU,ZTMAX)<a name='4501'>
          ZETALT = MIN (ZETALT,ZTMAX)<a name='4502'>
          ZETAU  = MIN (ZETAU,ZTMAX/(ZSLU/ZU))   <font color=#447700>! Barlage: add limit on ZETAU/ZETAT<a name='4503'></font>
          ZETAT  = MIN (ZETAT,ZTMAX/(ZSLT/ZT))   <font color=#447700>! Barlage: prevent SIMM/SIMH &lt; 0<a name='4504'></font>
          PSMZ = PSPMS (ZETAU)<a name='4505'>
          SIMM = PSPMS (ZETALU) - PSMZ + RLOGU<a name='4506'>
          PSHZ = PSPHS (ZETAT)<a name='4507'>
          SIMH = PSPHS (ZETALT) - PSHZ + RLOGT<a name='4508'>
       END IF<a name='4509'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4510'></font>
<font color=#447700>! LECH'S FUNCTIONS<a name='4511'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4512'></font>
    ELSE<a name='4513'>
       IF (RLMO .lt. 0.)THEN<a name='4514'>
          PSMZ = PSLMU (ZETAU)<a name='4515'>
          SIMM = PSLMU (ZETALU) - PSMZ + RLOGU<a name='4516'>
          PSHZ = PSLHU (ZETAT)<a name='4517'>
          SIMH = PSLHU (ZETALT) - PSHZ + RLOGT<a name='4518'>
       ELSE<a name='4519'>
          ZETALU = MIN (ZETALU,ZTMAX)<a name='4520'>
          ZETALT = MIN (ZETALT,ZTMAX)<a name='4521'>
          PSMZ = PSLMS (ZETAU)<a name='4522'>
          SIMM = PSLMS (ZETALU) - PSMZ + RLOGU<a name='4523'>
          PSHZ = PSLHS (ZETAT)<a name='4524'>
          SIMH = PSLHS (ZETALT) - PSHZ + RLOGT<a name='4525'>
       END IF<a name='4526'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4527'></font>
       END IF<a name='4528'>
<a name='4529'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4530'></font>
<font color=#447700>! BELJAARS CORRECTION FOR USTAR<a name='4531'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4532'></font>
       USTAR = MAX (SQRT (AKMS * SQRT (DU2+ WSTAR2)),EPSUST)<a name='4533'>
<a name='4534'>
<font color=#447700>! ZILITINKEVITCH FIX FOR ZT<a name='4535'></font>
       ZT = MAX(1.E-6,EXP (ZILFC * SQRT (USTAR * Z0))* Z0)<a name='4536'>
       ZSLT = ZLM + ZT<a name='4537'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4538'></font>
       RLOGT = log (ZSLT / ZT)<a name='4539'>
       USTARK = USTAR * VKRM<a name='4540'>
       IF(SIMM &lt; 1.e-6) SIMM = 1.e-6        <font color=#447700>! Limit stability function<a name='4541'></font>
       AKMS = MAX (USTARK / SIMM,CXCH)<a name='4542'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4543'></font>
<font color=#447700>! IF STATEMENTS TO AVOID TANGENT LINEAR PROBLEMS NEAR ZERO<a name='4544'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4545'></font>
       IF(SIMH &lt; 1.e-6) SIMH = 1.e-6        <font color=#447700>! Limit stability function<a name='4546'></font>
       AKHS = MAX (USTARK / SIMH,CXCH)<a name='4547'>
<a name='4548'>
       IF (BTGH * AKHS * DTHV .ne. 0.0) THEN<a name='4549'>
          WSTAR2 = WWST2* ABS (BTGH * AKHS * DTHV)** (2./3.)<a name='4550'>
       ELSE<a name='4551'>
          WSTAR2 = 0.0<a name='4552'>
       END IF<a name='4553'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4554'></font>
       RLMN = ELFC * AKHS * DTHV / USTAR **3<a name='4555'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4556'></font>
<font color=#447700>!     IF(ABS((RLMN-RLMO)/RLMA).LT.EPSIT)    GO TO 110<a name='4557'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4558'></font>
       RLMA = RLMO * WOLD+ RLMN * WNEW<a name='4559'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4560'></font>
       RLMO = RLMA<a name='4561'>
<a name='4562'>
<font color=#447700>!       write(*,'(a20,10f15.6)')'SFCDIF: RLMO=',RLMO,RLMN,ELFC , AKHS , DTHV , USTAR<a name='4563'></font>
<font color=#447700>!    END DO<a name='4564'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4565'></font>
  END SUBROUTINE SFCDIF2<a name='4566'>
<a name='4567'>
<font color=#447700>!== begin esat =====================================================================================<a name='4568'></font>
<a name='4569'>
<A NAME='ESAT'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ESAT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4570'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ESAT</font>(T, ESW, ESI, DESW, DESI) <A href='../../call_to/ESAT.html' TARGET='index'>8</A><a name='4571'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='4572'></font>
<font color=#447700>! use polynomials to calculate saturation vapor pressure and derivative with<a name='4573'></font>
<font color=#447700>! respect to temperature: over water when t &gt; 0 c and over ice when t &lt;= 0 c<a name='4574'></font>
  IMPLICIT NONE<a name='4575'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='4576'></font>
<font color=#447700>! in<a name='4577'></font>
<a name='4578'>
  REAL, intent(in)  :: T              <font color=#447700>!temperature<a name='4579'></font>
<a name='4580'>
<font color=#447700>!out<a name='4581'></font>
<a name='4582'>
  REAL, intent(out) :: ESW            <font color=#447700>!saturation vapor pressure over water (pa)<a name='4583'></font>
  REAL, intent(out) :: ESI            <font color=#447700>!saturation vapor pressure over ice (pa)<a name='4584'></font>
  REAL, intent(out) :: DESW           <font color=#447700>!d(esat)/dt over water (pa/K)<a name='4585'></font>
  REAL, intent(out) :: DESI           <font color=#447700>!d(esat)/dt over ice (pa/K)<a name='4586'></font>
<a name='4587'>
<font color=#447700>! local<a name='4588'></font>
<a name='4589'>
  REAL :: A0,A1,A2,A3,A4,A5,A6  <font color=#447700>!coefficients for esat over water<a name='4590'></font>
  REAL :: B0,B1,B2,B3,B4,B5,B6  <font color=#447700>!coefficients for esat over ice<a name='4591'></font>
  REAL :: C0,C1,C2,C3,C4,C5,C6  <font color=#447700>!coefficients for dsat over water<a name='4592'></font>
  REAL :: D0,D1,D2,D3,D4,D5,D6  <font color=#447700>!coefficients for dsat over ice<a name='4593'></font>
<a name='4594'>
  PARAMETER (A0=6.107799961    , A1=4.436518521E-01,  &amp;<a name='4595'>
             A2=1.428945805E-02, A3=2.650648471E-04,  &amp;<a name='4596'>
             A4=3.031240396E-06, A5=2.034080948E-08,  &amp;<a name='4597'>
             A6=6.136820929E-11)<a name='4598'>
<a name='4599'>
  PARAMETER (B0=6.109177956    , B1=5.034698970E-01,  &amp;<a name='4600'>
             B2=1.886013408E-02, B3=4.176223716E-04,  &amp;<a name='4601'>
             B4=5.824720280E-06, B5=4.838803174E-08,  &amp;<a name='4602'>
             B6=1.838826904E-10)<a name='4603'>
<a name='4604'>
  PARAMETER (C0= 4.438099984E-01, C1=2.857002636E-02,  &amp;<a name='4605'>
             C2= 7.938054040E-04, C3=1.215215065E-05,  &amp;<a name='4606'>
             C4= 1.036561403E-07, C5=3.532421810e-10,  &amp;<a name='4607'>
             C6=-7.090244804E-13)<a name='4608'>
<a name='4609'>
  PARAMETER (D0=5.030305237E-01, D1=3.773255020E-02,  &amp;<a name='4610'>
             D2=1.267995369E-03, D3=2.477563108E-05,  &amp;<a name='4611'>
             D4=3.005693132E-07, D5=2.158542548E-09,  &amp;<a name='4612'>
             D6=7.131097725E-12)<a name='4613'>
<a name='4614'>
  ESW  = 100.*(A0+T*(A1+T*(A2+T*(A3+T*(A4+T*(A5+T*A6))))))<a name='4615'>
  ESI  = 100.*(B0+T*(B1+T*(B2+T*(B3+T*(B4+T*(B5+T*B6))))))<a name='4616'>
  DESW = 100.*(C0+T*(C1+T*(C2+T*(C3+T*(C4+T*(C5+T*C6))))))<a name='4617'>
  DESI = 100.*(D0+T*(D1+T*(D2+T*(D3+T*(D4+T*(D5+T*D6))))))<a name='4618'>
<a name='4619'>
  END SUBROUTINE ESAT<a name='4620'>
<a name='4621'>
<font color=#447700>!== begin stomata ==================================================================================<a name='4622'></font>
<a name='4623'>
<A NAME='STOMATA'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#STOMATA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4624'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>STOMATA</font> (parameters,VEGTYP  ,MPE     ,APAR    ,FOLN    ,ILOC    , JLOC, &amp; <font color=#447700>!in <A href='../../call_to/STOMATA.html' TARGET='index'>4</A>,<A href='../../call_from/STOMATA.html' TARGET='index'>5</A><a name='4625'></font>
                      TV      ,EI      ,EA      ,SFCTMP  ,SFCPRS  , &amp; <font color=#447700>!in<a name='4626'></font>
                      O2      ,CO2     ,IGS     ,BTRAN   ,RB      , &amp; <font color=#447700>!in<a name='4627'></font>
                      RS      ,PSN     )                              <font color=#447700>!out<a name='4628'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='4629'></font>
  IMPLICIT NONE<a name='4630'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='4631'></font>
<font color=#447700>! input<a name='4632'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='4633'>
      INTEGER,INTENT(IN)  :: ILOC   <font color=#447700>!grid index<a name='4634'></font>
      INTEGER,INTENT(IN)  :: JLOC   <font color=#447700>!grid index<a name='4635'></font>
      INTEGER,INTENT(IN)  :: VEGTYP <font color=#447700>!vegetation physiology type<a name='4636'></font>
<a name='4637'>
      REAL, INTENT(IN)    :: IGS    <font color=#447700>!growing season index (0=off, 1=on)<a name='4638'></font>
      REAL, INTENT(IN)    :: MPE    <font color=#447700>!prevents division by zero errors<a name='4639'></font>
<a name='4640'>
      REAL, INTENT(IN)    :: TV     <font color=#447700>!foliage temperature (k)<a name='4641'></font>
      REAL, INTENT(IN)    :: EI     <font color=#447700>!vapor pressure inside leaf (sat vapor press at tv) (pa)<a name='4642'></font>
      REAL, INTENT(IN)    :: EA     <font color=#447700>!vapor pressure of canopy air (pa)<a name='4643'></font>
      REAL, INTENT(IN)    :: APAR   <font color=#447700>!par absorbed per unit lai (w/m2)<a name='4644'></font>
      REAL, INTENT(IN)    :: O2     <font color=#447700>!atmospheric o2 concentration (pa)<a name='4645'></font>
      REAL, INTENT(IN)    :: CO2    <font color=#447700>!atmospheric co2 concentration (pa)<a name='4646'></font>
      REAL, INTENT(IN)    :: SFCPRS <font color=#447700>!air pressure at reference height (pa)<a name='4647'></font>
      REAL, INTENT(IN)    :: SFCTMP <font color=#447700>!air temperature at reference height (k)<a name='4648'></font>
      REAL, INTENT(IN)    :: BTRAN  <font color=#447700>!soil water transpiration factor (0 to 1)<a name='4649'></font>
      REAL, INTENT(IN)    :: FOLN   <font color=#447700>!foliage nitrogen concentration (%)<a name='4650'></font>
      REAL, INTENT(IN)    :: RB     <font color=#447700>!boundary layer resistance (s/m)<a name='4651'></font>
<a name='4652'>
<font color=#447700>! output<a name='4653'></font>
      REAL, INTENT(OUT)   :: RS     <font color=#447700>!leaf stomatal resistance (s/m)<a name='4654'></font>
      REAL, INTENT(OUT)   :: PSN    <font color=#447700>!foliage photosynthesis (umol co2 /m2/ s) [always +]<a name='4655'></font>
<a name='4656'>
<font color=#447700>! in&amp;out<a name='4657'></font>
      REAL                :: RLB    <font color=#447700>!boundary layer resistance (s m2 / umol)<a name='4658'></font>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='4659'></font>
<a name='4660'>
<font color=#447700>! ------------------------ local variables ----------------------------------------------------<a name='4661'></font>
      INTEGER :: ITER     <font color=#447700>!iteration index<a name='4662'></font>
      INTEGER :: NITER    <font color=#447700>!number of iterations<a name='4663'></font>
<a name='4664'>
      DATA NITER /3/<a name='4665'>
      SAVE NITER<a name='4666'>
<a name='4667'>
      REAL :: AB          <font color=#447700>!used in statement functions<a name='4668'></font>
      REAL :: BC          <font color=#447700>!used in statement functions<a name='4669'></font>
      REAL :: F1          <font color=#447700>!generic temperature response (statement function)<a name='4670'></font>
      REAL :: F2          <font color=#447700>!generic temperature inhibition (statement function)<a name='4671'></font>
      REAL :: TC          <font color=#447700>!foliage temperature (degree Celsius)<a name='4672'></font>
      REAL :: CS          <font color=#447700>!co2 concentration at leaf surface (pa)<a name='4673'></font>
      REAL :: KC          <font color=#447700>!co2 Michaelis-Menten constant (pa)<a name='4674'></font>
      REAL :: KO          <font color=#447700>!o2 Michaelis-Menten constant (pa)<a name='4675'></font>
      REAL :: A,B,C,Q     <font color=#447700>!intermediate calculations for RS<a name='4676'></font>
      REAL :: R1,R2       <font color=#447700>!roots for RS<a name='4677'></font>
      REAL :: FNF         <font color=#447700>!foliage nitrogen adjustment factor (0 to 1)<a name='4678'></font>
      REAL :: PPF         <font color=#447700>!absorb photosynthetic photon flux (umol photons/m2/s)<a name='4679'></font>
      REAL :: WC          <font color=#447700>!Rubisco limited photosynthesis (umol co2/m2/s)<a name='4680'></font>
      REAL :: WJ          <font color=#447700>!light limited photosynthesis (umol co2/m2/s)<a name='4681'></font>
      REAL :: WE          <font color=#447700>!export limited photosynthesis (umol co2/m2/s)<a name='4682'></font>
      REAL :: CP          <font color=#447700>!co2 compensation point (pa)<a name='4683'></font>
      REAL :: CI          <font color=#447700>!internal co2 (pa)<a name='4684'></font>
      REAL :: AWC         <font color=#447700>!intermediate calculation for wc<a name='4685'></font>
      REAL :: VCMX        <font color=#447700>!maximum rate of carbonylation (umol co2/m2/s)<a name='4686'></font>
      REAL :: J           <font color=#447700>!electron transport (umol co2/m2/s)<a name='4687'></font>
      REAL :: CEA         <font color=#447700>!constrain ea or else model blows up<a name='4688'></font>
      REAL :: CF          <font color=#447700>!s m2/umol -&gt; s/m<a name='4689'></font>
<a name='4690'>
      F1(AB,BC) = AB**((BC-25.)/10.)<a name='4691'>
      F2(AB) = 1. + EXP((-2.2E05+710.*(AB+273.16))/(8.314*(AB+273.16)))<a name='4692'>
      REAL :: T<a name='4693'>
<font color=#447700>! ---------------------------------------------------------------------------------------------<a name='4694'></font>
<a name='4695'>
<font color=#447700>! initialize RS=RSMAX and PSN=0 because will only do calculations<a name='4696'></font>
<font color=#447700>! for APAR &gt; 0, in which case RS &lt;= RSMAX and PSN &gt;= 0<a name='4697'></font>
<a name='4698'>
         CF = SFCPRS/(8.314*SFCTMP)*1.e06<a name='4699'>
         RS = 1./parameters%BP * CF<a name='4700'>
         PSN = 0.<a name='4701'>
<a name='4702'>
         IF (APAR .LE. 0.) RETURN<a name='4703'>
<a name='4704'>
         FNF = MIN( FOLN/MAX(MPE,parameters%FOLNMX), 1.0 )<a name='4705'>
         TC  = TV-TFRZ<a name='4706'>
         PPF = 4.6*APAR<a name='4707'>
         J   = PPF*parameters%QE25<a name='4708'>
         KC  = parameters%KC25 * F1(parameters%AKC,TC)<a name='4709'>
         KO  = parameters%KO25 * F1(parameters%AKO,TC)<a name='4710'>
         AWC = KC * (1.+O2/KO)<a name='4711'>
         CP  = 0.5*KC/KO*O2*0.21<a name='4712'>
         VCMX = parameters%VCMX25 / F2(TC) * FNF * BTRAN * F1(parameters%AVCMX,TC)<a name='4713'>
<a name='4714'>
<font color=#447700>! first guess ci<a name='4715'></font>
<a name='4716'>
         CI = 0.7*CO2*parameters%C3PSN + 0.4*CO2*(1.-parameters%C3PSN)<a name='4717'>
<a name='4718'>
<font color=#447700>! rb: s/m -&gt; s m**2 / umol<a name='4719'></font>
<a name='4720'>
         RLB = RB/CF<a name='4721'>
<a name='4722'>
<font color=#447700>! constrain ea<a name='4723'></font>
<a name='4724'>
         CEA = MAX(0.25*EI*parameters%C3PSN+0.40*EI*(1.-parameters%C3PSN), MIN(EA,EI) )<a name='4725'>
<a name='4726'>
<font color=#447700>! ci iteration<a name='4727'></font>
<font color=#447700>!jref: C3PSN is equal to 1 for all veg types.<a name='4728'></font>
       DO ITER = 1, NITER<a name='4729'>
            WJ = MAX(CI-CP,0.)*J/(CI+2.*CP)*parameters%C3PSN  + J*(1.-parameters%C3PSN)<a name='4730'>
            WC = MAX(CI-CP,0.)*VCMX/(CI+AWC)*parameters%C3PSN + VCMX*(1.-parameters%C3PSN)<a name='4731'>
            WE = 0.5*VCMX*parameters%C3PSN + 4000.*VCMX*CI/SFCPRS*(1.-parameters%C3PSN)<a name='4732'>
            PSN = MIN(WJ,WC,WE) * IGS<a name='4733'>
<a name='4734'>
            CS = MAX( CO2-1.37*RLB*SFCPRS*PSN, MPE )<a name='4735'>
            A = parameters%MP*PSN*SFCPRS*CEA / (CS*EI) + parameters%BP<a name='4736'>
            B = ( parameters%MP*PSN*SFCPRS/CS + parameters%BP ) * RLB - 1.<a name='4737'>
            C = -RLB<a name='4738'>
            IF (B .GE. 0.) THEN<a name='4739'>
               Q = -0.5*( B + SQRT(B*B-4.*A*C) )<a name='4740'>
            ELSE<a name='4741'>
               Q = -0.5*( B - SQRT(B*B-4.*A*C) )<a name='4742'>
            END IF<a name='4743'>
            R1 = Q/A<a name='4744'>
            R2 = C/Q<a name='4745'>
            RS = MAX(R1,R2)<a name='4746'>
            CI = MAX( CS-PSN*SFCPRS*1.65*RS, 0. )<a name='4747'>
       END DO <a name='4748'>
<a name='4749'>
<font color=#447700>! rs, rb:  s m**2 / umol -&gt; s/m<a name='4750'></font>
<a name='4751'>
         RS = RS*CF<a name='4752'>
<a name='4753'>
  END SUBROUTINE STOMATA<a name='4754'>
<a name='4755'>
<font color=#447700>!== begin canres ===================================================================================<a name='4756'></font>
<a name='4757'>
<A NAME='CANRES'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#CANRES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4758'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>CANRES</font> (parameters,PAR   ,SFCTMP,RCSOIL ,EAH   ,SFCPRS , &amp; <font color=#447700>!in <A href='../../call_to/CANRES.html' TARGET='index'>3</A>,<A href='../../call_from/CANRES.html' TARGET='index'>1</A><a name='4759'></font>
                     RC    ,PSN   ,ILOC   ,JLOC  )           <font color=#447700>!out<a name='4760'></font>
<a name='4761'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='4762'></font>
<font color=#447700>! calculate canopy resistance which depends on incoming solar radiation,<a name='4763'></font>
<font color=#447700>! air temperature, atmospheric water vapor pressure deficit at the<a name='4764'></font>
<font color=#447700>! lowest model level, and soil moisture (preferably unfrozen soil<a name='4765'></font>
<font color=#447700>! moisture rather than total)<a name='4766'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='4767'></font>
<font color=#447700>! source:  Jarvis (1976), Noilhan and Planton (1989, MWR), Jacquemin and<a name='4768'></font>
<font color=#447700>! Noilhan (1990, BLM). Chen et al (1996, JGR, Vol 101(D3), 7251-7268), <a name='4769'></font>
<font color=#447700>! eqns 12-14 and table 2 of sec. 3.1.2<a name='4770'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='4771'></font>
<font color=#447700>!niu    USE module_Noahlsm_utility<a name='4772'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='4773'></font>
    IMPLICIT NONE<a name='4774'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='4775'></font>
<font color=#447700>! inputs<a name='4776'></font>
<a name='4777'>
  type (noahmp_parameters), intent(in) :: parameters<a name='4778'>
    INTEGER,                  INTENT(IN)  :: ILOC   <font color=#447700>!grid index<a name='4779'></font>
    INTEGER,                  INTENT(IN)  :: JLOC   <font color=#447700>!grid index<a name='4780'></font>
    REAL,                     INTENT(IN)  :: PAR    <font color=#447700>!par absorbed per unit sunlit lai (w/m2)<a name='4781'></font>
    REAL,                     INTENT(IN)  :: SFCTMP <font color=#447700>!canopy air temperature<a name='4782'></font>
    REAL,                     INTENT(IN)  :: SFCPRS <font color=#447700>!surface pressure (pa)<a name='4783'></font>
    REAL,                     INTENT(IN)  :: EAH    <font color=#447700>!water vapor pressure (pa)<a name='4784'></font>
    REAL,                     INTENT(IN)  :: RCSOIL <font color=#447700>!soil moisture stress factor<a name='4785'></font>
<a name='4786'>
<font color=#447700>!outputs<a name='4787'></font>
<a name='4788'>
    REAL,                     INTENT(OUT) :: RC     <font color=#447700>!canopy resistance per unit LAI<a name='4789'></font>
    REAL,                     INTENT(OUT) :: PSN    <font color=#447700>!foliage photosynthesis (umolco2/m2/s)<a name='4790'></font>
<a name='4791'>
<font color=#447700>!local<a name='4792'></font>
<a name='4793'>
    REAL                                  :: RCQ<a name='4794'>
    REAL                                  :: RCS<a name='4795'>
    REAL                                  :: RCT<a name='4796'>
    REAL                                  :: FF<a name='4797'>
    REAL                                  :: Q2     <font color=#447700>!water vapor mixing ratio (kg/kg)<a name='4798'></font>
    REAL                                  :: Q2SAT  <font color=#447700>!saturation Q2<a name='4799'></font>
    REAL                                  :: DQSDT2 <font color=#447700>!d(Q2SAT)/d(T)<a name='4800'></font>
<a name='4801'>
<font color=#447700>! RSMIN, RSMAX, TOPT, RGL, HS are canopy stress parameters set in REDPRM<a name='4802'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4803'></font>
<font color=#447700>! initialize canopy resistance multiplier terms.<a name='4804'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4805'></font>
    RC     = 0.0<a name='4806'>
    RCS    = 0.0<a name='4807'>
    RCT    = 0.0<a name='4808'>
    RCQ    = 0.0<a name='4809'>
<a name='4810'>
<font color=#447700>!  compute Q2 and Q2SAT<a name='4811'></font>
<a name='4812'>
    Q2 = 0.622 *  EAH  / (SFCPRS - 0.378 * EAH) <font color=#447700>!specific humidity [kg/kg]<a name='4813'></font>
    Q2 = Q2 / (1.0 + Q2)                        <font color=#447700>!mixing ratio [kg/kg]<a name='4814'></font>
<a name='4815'>
    CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CALHUM'>CALHUM</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#CANRES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALHUM_1">(parameters,SFCTMP, SFCPRS, Q2SAT, DQSDT2)<a name='4816'>
<a name='4817'>
<font color=#447700>! contribution due to incoming solar radiation<a name='4818'></font>
<a name='4819'>
    FF  = 2.0 * PAR / parameters%RGL                <a name='4820'>
    RCS = (FF + parameters%RSMIN / parameters%RSMAX) / (1.0+ FF)<a name='4821'>
    RCS = MAX (RCS,0.0001)<a name='4822'>
<a name='4823'>
<font color=#447700>! contribution due to air temperature<a name='4824'></font>
<a name='4825'>
    RCT = 1.0- 0.0016* ( (parameters%TOPT - SFCTMP)**2.0)<a name='4826'>
    RCT = MAX (RCT,0.0001)<a name='4827'>
<a name='4828'>
<font color=#447700>! contribution due to vapor pressure deficit<a name='4829'></font>
<a name='4830'>
    RCQ = 1.0/ (1.0+ parameters%HS * MAX(0.,Q2SAT-Q2))<a name='4831'>
    RCQ = MAX (RCQ,0.01)<a name='4832'>
<a name='4833'>
<font color=#447700>! determine canopy resistance due to all factors<a name='4834'></font>
<a name='4835'>
    RC  = parameters%RSMIN / (RCS * RCT * RCQ * RCSOIL)<a name='4836'>
    PSN = -999.99       <font color=#447700>! PSN not applied for dynamic carbon<a name='4837'></font>
<a name='4838'>
  END SUBROUTINE CANRES<a name='4839'>
<a name='4840'>
<font color=#447700>!== begin calhum ===================================================================================<a name='4841'></font>
<a name='4842'>
<A NAME='CALHUM'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#CALHUM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4843'>
        <font color=#993300>SUBROUTINE </font><font color=#cc0000>CALHUM</font>(parameters,SFCTMP, SFCPRS, Q2SAT, DQSDT2) <A href='../../call_to/CALHUM.html' TARGET='index'>1</A><a name='4844'>
<a name='4845'>
        IMPLICIT NONE<a name='4846'>
<a name='4847'>
  type (noahmp_parameters), intent(in) :: parameters<a name='4848'>
        REAL, INTENT(IN)       :: SFCTMP, SFCPRS<a name='4849'>
        REAL, INTENT(OUT)      :: Q2SAT, DQSDT2<a name='4850'>
        REAL, PARAMETER        :: A2=17.67,A3=273.15,A4=29.65, ELWV=2.501E6,         &amp;<a name='4851'>
                                  A23M4=A2*(A3-A4), E0=0.611, RV=461.0,             &amp;<a name='4852'>
                                  EPSILON=0.622<a name='4853'>
        REAL                   :: ES, SFCPRSX<a name='4854'>
<a name='4855'>
<font color=#447700>! Q2SAT: saturated mixing ratio<a name='4856'></font>
        ES = E0 * EXP ( ELWV/RV*(1./A3 - 1./SFCTMP) )<a name='4857'>
<font color=#447700>! convert SFCPRS from Pa to KPa<a name='4858'></font>
        SFCPRSX = SFCPRS*1.E-3<a name='4859'>
        Q2SAT = EPSILON * ES / (SFCPRSX-ES)<a name='4860'>
<font color=#447700>! convert from  g/g to g/kg<a name='4861'></font>
        Q2SAT = Q2SAT * 1.E3<a name='4862'>
<font color=#447700>! Q2SAT is currently a 'mixing ratio'<a name='4863'></font>
<a name='4864'>
<font color=#447700>! DQSDT2 is calculated assuming Q2SAT is a specific humidity<a name='4865'></font>
        DQSDT2=(Q2SAT/(1+Q2SAT))*A23M4/(SFCTMP-A4)**2<a name='4866'>
<a name='4867'>
<font color=#447700>! DG Q2SAT needs to be in g/g when returned for SFLX<a name='4868'></font>
        Q2SAT = Q2SAT / 1.E3<a name='4869'>
<a name='4870'>
        END SUBROUTINE CALHUM<a name='4871'>
<a name='4872'>
<font color=#447700>!== begin tsnosoi ==================================================================================<a name='4873'></font>
<a name='4874'>
<A NAME='TSNOSOI'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#TSNOSOI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4875'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>TSNOSOI</font> (parameters,ICE     ,NSOIL   ,NSNOW   ,ISNOW   ,IST     , &amp; <font color=#447700>!in <A href='../../call_to/TSNOSOI.html' TARGET='index'>1</A>,<A href='../../call_from/TSNOSOI.html' TARGET='index'>4</A><a name='4876'></font>
                      TBOT    ,ZSNSO   ,SSOIL   ,DF      ,HCPCT   , &amp; <font color=#447700>!in<a name='4877'></font>
                      SAG     ,DT      ,SNOWH   ,DZSNSO  , &amp; <font color=#447700>!in<a name='4878'></font>
                      TG      ,ILOC    ,JLOC    ,                   &amp; <font color=#447700>!in<a name='4879'></font>
                      STC     )                                       <font color=#447700>!inout<a name='4880'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='4881'></font>
<font color=#447700>! Compute snow (up to 3L) and soil (4L) temperature. Note that snow temperatures<a name='4882'></font>
<font color=#447700>! during melting season may exceed melting point (TFRZ) but later in PHASECHANGE<a name='4883'></font>
<font color=#447700>! subroutine the snow temperatures are reset to TFRZ for melting snow.<a name='4884'></font>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='4885'></font>
  IMPLICIT NONE<a name='4886'>
<font color=#447700>! --------------------------------------------------------------------------------------------------<a name='4887'></font>
<font color=#447700>!input<a name='4888'></font>
<a name='4889'>
  type (noahmp_parameters), intent(in) :: parameters<a name='4890'>
    INTEGER,                         INTENT(IN)  :: ILOC<a name='4891'>
    INTEGER,                         INTENT(IN)  :: JLOC<a name='4892'>
    INTEGER,                         INTENT(IN)  :: ICE    <font color=#447700>!<a name='4893'></font>
    INTEGER,                         INTENT(IN)  :: NSOIL  <font color=#447700>!no of soil layers (4)<a name='4894'></font>
    INTEGER,                         INTENT(IN)  :: NSNOW  <font color=#447700>!maximum no of snow layers (3)<a name='4895'></font>
    INTEGER,                         INTENT(IN)  :: ISNOW  <font color=#447700>!actual no of snow layers<a name='4896'></font>
    INTEGER,                         INTENT(IN)  :: IST    <font color=#447700>!surface type<a name='4897'></font>
<a name='4898'>
    REAL,                            INTENT(IN)  :: DT     <font color=#447700>!time step (s)<a name='4899'></font>
    REAL,                            INTENT(IN)  :: TBOT   <font color=#447700>!<a name='4900'></font>
    REAL,                            INTENT(IN)  :: SSOIL  <font color=#447700>!ground heat flux (w/m2)<a name='4901'></font>
    REAL,                            INTENT(IN)  :: SAG    <font color=#447700>!solar rad. absorbed by ground (w/m2)<a name='4902'></font>
    REAL,                            INTENT(IN)  :: SNOWH  <font color=#447700>!snow depth (m)<a name='4903'></font>
    REAL,                            INTENT(IN)  :: TG     <font color=#447700>!ground temperature (k)<a name='4904'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: ZSNSO  <font color=#447700>!layer-bot. depth from snow surf.(m)<a name='4905'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: DZSNSO <font color=#447700>!snow/soil layer thickness (m)<a name='4906'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: DF     <font color=#447700>!thermal conductivity<a name='4907'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: HCPCT  <font color=#447700>!heat capacity (J/m3/k)<a name='4908'></font>
<a name='4909'>
<font color=#447700>!input and output<a name='4910'></font>
<a name='4911'>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC<a name='4912'>
<a name='4913'>
<font color=#447700>!local<a name='4914'></font>
<a name='4915'>
    INTEGER                                      :: IZ<a name='4916'>
    REAL                                         :: ZBOTSNO   <font color=#447700>!ZBOT from snow surface<a name='4917'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL)              :: AI, BI, CI, RHSTS<a name='4918'>
    REAL                                         :: EFLXB <font color=#447700>!energy influx from soil bottom (w/m2)<a name='4919'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL)              :: PHI   <font color=#447700>!light through water (w/m2)<a name='4920'></font>
<a name='4921'>
    REAL, DIMENSION(-NSNOW+1:NSOIL) :: TBEG<a name='4922'>
    REAL                            :: ERR_EST <font color=#447700>!heat storage error  (w/m2)<a name='4923'></font>
    REAL                            :: SSOIL2  <font color=#447700>!ground heat flux (w/m2) (for energy check)<a name='4924'></font>
    REAL                            :: EFLXB2  <font color=#447700>!heat flux from the bottom (w/m2) (for energy check)<a name='4925'></font>
    character(len=256)              :: message<a name='4926'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4927'></font>
<font color=#447700>! compute solar penetration through water, needs more work<a name='4928'></font>
<a name='4929'>
    PHI(ISNOW+1:NSOIL) = 0.<a name='4930'>
<a name='4931'>
<font color=#447700>! adjust ZBOT from soil surface to ZBOTSNO from snow surface<a name='4932'></font>
<a name='4933'>
    ZBOTSNO = parameters%ZBOT - SNOWH    <font color=#447700>!from snow surface<a name='4934'></font>
<a name='4935'>
<font color=#447700>! snow/soil heat storage for energy balance check<a name='4936'></font>
<a name='4937'>
    DO IZ = ISNOW+1, NSOIL<a name='4938'>
       TBEG(IZ) = STC(IZ)<a name='4939'>
    ENDDO<a name='4940'>
<a name='4941'>
<font color=#447700>! compute soil temperatures<a name='4942'></font>
<a name='4943'>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#HRT'>HRT</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#TSNOSOI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HRT_2">   (parameters,NSNOW     ,NSOIL     ,ISNOW     ,ZSNSO     , &amp;<a name='4944'>
                  STC       ,TBOT      ,ZBOTSNO   ,DT        , &amp;<a name='4945'>
                  DF        ,HCPCT     ,SSOIL     ,PHI       , &amp;<a name='4946'>
                  AI        ,BI        ,CI        ,RHSTS     , &amp;<a name='4947'>
                  EFLXB     )<a name='4948'>
<a name='4949'>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#HSTEP'>HSTEP</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#TSNOSOI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HSTEP_4"> (parameters,NSNOW     ,NSOIL     ,ISNOW     ,DT        , &amp;<a name='4950'>
                  AI        ,BI        ,CI        ,RHSTS     , &amp;<a name='4951'>
                  STC       ) <a name='4952'>
<a name='4953'>
<font color=#447700>! update ground heat flux just for energy check, but not for final output<a name='4954'></font>
<font color=#447700>! otherwise, it would break the surface energy balance<a name='4955'></font>
<a name='4956'>
    IF(OPT_TBOT == 1) THEN<a name='4957'>
       EFLXB2  = 0.<a name='4958'>
    ELSE IF(OPT_TBOT == 2) THEN<a name='4959'>
       EFLXB2  = DF(NSOIL)*(TBOT-STC(NSOIL)) / &amp;<a name='4960'>
            (0.5*(ZSNSO(NSOIL-1)+ZSNSO(NSOIL)) - ZBOTSNO)<a name='4961'>
    END IF<a name='4962'>
<a name='4963'>
    <font color=#447700>! Skip the energy balance check for now, until we can make it work<a name='4964'></font>
    <font color=#447700>! right for small time steps.<a name='4965'></font>
    return<a name='4966'>
<a name='4967'>
<font color=#447700>! energy balance check<a name='4968'></font>
<a name='4969'>
    ERR_EST = 0.0<a name='4970'>
    DO IZ = ISNOW+1, NSOIL<a name='4971'>
       ERR_EST = ERR_EST + (STC(IZ)-TBEG(IZ)) * DZSNSO(IZ) * HCPCT(IZ) / DT<a name='4972'>
    ENDDO<a name='4973'>
<a name='4974'>
    if (OPT_STC == 1 .OR. OPT_STC == 3) THEN   <font color=#447700>! semi-implicit<a name='4975'></font>
       ERR_EST = ERR_EST - (SSOIL +EFLXB)<a name='4976'>
    ELSE                     <font color=#447700>! full-implicit<a name='4977'></font>
       SSOIL2 = DF(ISNOW+1)*(TG-STC(ISNOW+1))/(0.5*DZSNSO(ISNOW+1))   <font color=#447700>!M. Barlage<a name='4978'></font>
       ERR_EST = ERR_EST - (SSOIL2+EFLXB2)<a name='4979'>
    ENDIF<a name='4980'>
<a name='4981'>
    IF (ABS(ERR_EST) &gt; 1.) THEN    <font color=#447700>! W/m2<a name='4982'></font>
       WRITE(message,*) 'TSNOSOI is losing(-)/gaining(+) false energy',ERR_EST,' W/m2'<a name='4983'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#TSNOSOI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_979">(trim(message))<a name='4984'>
       WRITE(message,'(i6,1x,i6,1x,i3,F18.13,5F20.12)') &amp;<a name='4985'>
            ILOC, JLOC, IST,ERR_EST,SSOIL,SNOWH,TG,STC(ISNOW+1),EFLXB<a name='4986'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#TSNOSOI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_980">(trim(message))<a name='4987'>
       <font color=#447700>!niu      STOP<a name='4988'></font>
    END IF<a name='4989'>
<a name='4990'>
  END SUBROUTINE TSNOSOI<a name='4991'>
<a name='4992'>
<font color=#447700>!== begin hrt ======================================================================================<a name='4993'></font>
<a name='4994'>
<A NAME='HRT'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#HRT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4995'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>HRT</font> (parameters,NSNOW     ,NSOIL     ,ISNOW     ,ZSNSO     , &amp; <A href='../../call_to/HRT.html' TARGET='index'>3</A>,<A href='../../call_from/HRT.html' TARGET='index'>17</A><a name='4996'>
                  STC       ,TBOT      ,ZBOT      ,DT        , &amp;<a name='4997'>
                  DF        ,HCPCT     ,SSOIL     ,PHI       , &amp;<a name='4998'>
                  AI        ,BI        ,CI        ,RHSTS     , &amp;<a name='4999'>
                  BOTFLX    )<a name='5000'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5001'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5002'></font>
<font color=#447700>! calculate the right hand side of the time tendency term of the soil<a name='5003'></font>
<font color=#447700>! thermal diffusion equation.  also to compute ( prepare ) the matrix<a name='5004'></font>
<font color=#447700>! coefficients for the tri-diagonal matrix of the implicit time scheme.<a name='5005'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5006'></font>
    IMPLICIT NONE<a name='5007'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5008'></font>
<font color=#447700>! input<a name='5009'></font>
<a name='5010'>
  type (noahmp_parameters), intent(in) :: parameters<a name='5011'>
    INTEGER,                         INTENT(IN)  :: NSOIL  <font color=#447700>!no of soil layers (4)<a name='5012'></font>
    INTEGER,                         INTENT(IN)  :: NSNOW  <font color=#447700>!maximum no of snow layers (3)<a name='5013'></font>
    INTEGER,                         INTENT(IN)  :: ISNOW  <font color=#447700>!actual no of snow layers<a name='5014'></font>
    REAL,                            INTENT(IN)  :: TBOT   <font color=#447700>!bottom soil temp. at ZBOT (k)<a name='5015'></font>
    REAL,                            INTENT(IN)  :: ZBOT   <font color=#447700>!depth of lower boundary condition (m)<a name='5016'></font>
                                                           <font color=#447700>!from soil surface not snow surface<a name='5017'></font>
    REAL,                            INTENT(IN)  :: DT     <font color=#447700>!time step (s)<a name='5018'></font>
    REAL,                            INTENT(IN)  :: SSOIL  <font color=#447700>!ground heat flux (w/m2)<a name='5019'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: ZSNSO  <font color=#447700>!depth of layer-bottom of snow/soil (m)<a name='5020'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: STC    <font color=#447700>!snow/soil temperature (k)<a name='5021'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: DF     <font color=#447700>!thermal conductivity [w/m/k]<a name='5022'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: HCPCT  <font color=#447700>!heat capacity [j/m3/k]<a name='5023'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)  :: PHI    <font color=#447700>!light through water (w/m2)<a name='5024'></font>
<a name='5025'>
<font color=#447700>! output<a name='5026'></font>
<a name='5027'>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: RHSTS  <font color=#447700>!right-hand side of the matrix<a name='5028'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: AI     <font color=#447700>!left-hand side coefficient<a name='5029'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: BI     <font color=#447700>!left-hand side coefficient<a name='5030'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: CI     <font color=#447700>!left-hand side coefficient<a name='5031'></font>
    REAL,                            INTENT(OUT) :: BOTFLX <font color=#447700>!energy influx from soil bottom (w/m2)<a name='5032'></font>
<a name='5033'>
<font color=#447700>! local<a name='5034'></font>
<a name='5035'>
    INTEGER                                      :: K<a name='5036'>
    REAL, DIMENSION(-NSNOW+1:NSOIL)              :: DDZ<a name='5037'>
    REAL, DIMENSION(-NSNOW+1:NSOIL)              :: DZ<a name='5038'>
    REAL, DIMENSION(-NSNOW+1:NSOIL)              :: DENOM<a name='5039'>
    REAL, DIMENSION(-NSNOW+1:NSOIL)              :: DTSDZ<a name='5040'>
    REAL, DIMENSION(-NSNOW+1:NSOIL)              :: EFLUX<a name='5041'>
    REAL                                         :: TEMP1<a name='5042'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5043'></font>
<a name='5044'>
    DO K = ISNOW+1, NSOIL<a name='5045'>
        IF (K == ISNOW+1) THEN<a name='5046'>
           DENOM(K)  = - ZSNSO(K) * HCPCT(K)<a name='5047'>
           TEMP1     = - ZSNSO(K+1)<a name='5048'>
           DDZ(K)    = 2.0 / TEMP1<a name='5049'>
           DTSDZ(K)  = 2.0 * (STC(K) - STC(K+1)) / TEMP1<a name='5050'>
           EFLUX(K)  = DF(K) * DTSDZ(K) - SSOIL - PHI(K)<a name='5051'>
        ELSE IF (K &lt; NSOIL) THEN<a name='5052'>
           DENOM(K)  = (ZSNSO(K-1) - ZSNSO(K)) * HCPCT(K)<a name='5053'>
           TEMP1     = ZSNSO(K-1) - ZSNSO(K+1)<a name='5054'>
           DDZ(K)    = 2.0 / TEMP1<a name='5055'>
           DTSDZ(K)  = 2.0 * (STC(K) - STC(K+1)) / TEMP1<a name='5056'>
           EFLUX(K)  = (DF(K)*DTSDZ(K) - DF(K-1)*DTSDZ(K-1)) - PHI(K)<a name='5057'>
        ELSE IF (K == NSOIL) THEN<a name='5058'>
           DENOM(K)  = (ZSNSO(K-1) - ZSNSO(K)) * HCPCT(K)<a name='5059'>
           TEMP1     =  ZSNSO(K-1) - ZSNSO(K)<a name='5060'>
           IF(OPT_TBOT == 1) THEN<a name='5061'>
               BOTFLX     = 0. <a name='5062'>
           END IF<a name='5063'>
           IF(OPT_TBOT == 2) THEN<a name='5064'>
               DTSDZ(K)  = (STC(K) - TBOT) / ( 0.5*(ZSNSO(K-1)+ZSNSO(K)) - ZBOT)<a name='5065'>
               BOTFLX    = -DF(K) * DTSDZ(K)<a name='5066'>
           END IF<a name='5067'>
           EFLUX(K)  = (-BOTFLX - DF(K-1)*DTSDZ(K-1) ) - PHI(K)<a name='5068'>
        END IF<a name='5069'>
    END DO<a name='5070'>
<a name='5071'>
    DO K = ISNOW+1, NSOIL<a name='5072'>
        IF (K == ISNOW+1) THEN<a name='5073'>
           AI(K)    =   0.0<a name='5074'>
           CI(K)    = - DF(K)   * DDZ(K) / DENOM(K)<a name='5075'>
           IF (OPT_STC == 1 .OR. OPT_STC == 3 ) THEN<a name='5076'>
              BI(K) = - CI(K)<a name='5077'>
           END IF                                        <a name='5078'>
           IF (OPT_STC == 2) THEN<a name='5079'>
              BI(K) = - CI(K) + DF(K)/(0.5*ZSNSO(K)*ZSNSO(K)*HCPCT(K))<a name='5080'>
           END IF<a name='5081'>
        ELSE IF (K &lt; NSOIL) THEN<a name='5082'>
           AI(K)    = - DF(K-1) * DDZ(K-1) / DENOM(K) <a name='5083'>
           CI(K)    = - DF(K  ) * DDZ(K  ) / DENOM(K) <a name='5084'>
           BI(K)    = - (AI(K) + CI (K))<a name='5085'>
        ELSE IF (K == NSOIL) THEN<a name='5086'>
           AI(K)    = - DF(K-1) * DDZ(K-1) / DENOM(K) <a name='5087'>
           CI(K)    = 0.0<a name='5088'>
           BI(K)    = - (AI(K) + CI(K))<a name='5089'>
        END IF<a name='5090'>
           RHSTS(K)  = EFLUX(K)/ (-DENOM(K))<a name='5091'>
    END DO<a name='5092'>
<a name='5093'>
  END SUBROUTINE HRT<a name='5094'>
<a name='5095'>
<font color=#447700>!== begin hstep ====================================================================================<a name='5096'></font>
<a name='5097'>
<A NAME='HSTEP'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#HSTEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5098'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>HSTEP</font> (parameters,NSNOW     ,NSOIL     ,ISNOW     ,DT        ,  &amp; <A href='../../call_to/HSTEP.html' TARGET='index'>5</A>,<A href='../../call_from/HSTEP.html' TARGET='index'>4</A><a name='5099'>
                    AI        ,BI        ,CI        ,RHSTS     ,  &amp;<a name='5100'>
                    STC       )  <a name='5101'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5102'></font>
<font color=#447700>! CALCULATE/UPDATE THE SOIL TEMPERATURE FIELD.<a name='5103'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5104'></font>
    implicit none<a name='5105'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5106'></font>
<font color=#447700>! input<a name='5107'></font>
<a name='5108'>
  type (noahmp_parameters), intent(in) :: parameters<a name='5109'>
    INTEGER,                         INTENT(IN)    :: NSOIL<a name='5110'>
    INTEGER,                         INTENT(IN)    :: NSNOW<a name='5111'>
    INTEGER,                         INTENT(IN)    :: ISNOW<a name='5112'>
    REAL,                            INTENT(IN)    :: DT<a name='5113'>
<a name='5114'>
<font color=#447700>! output &amp; input<a name='5115'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: RHSTS<a name='5116'>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: AI<a name='5117'>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: BI<a name='5118'>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: CI<a name='5119'>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC<a name='5120'>
<a name='5121'>
<font color=#447700>! local<a name='5122'></font>
    INTEGER                                        :: K<a name='5123'>
    REAL, DIMENSION(-NSNOW+1:NSOIL)                :: RHSTSIN<a name='5124'>
    REAL, DIMENSION(-NSNOW+1:NSOIL)                :: CIIN<a name='5125'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5126'></font>
<a name='5127'>
    DO K = ISNOW+1,NSOIL<a name='5128'>
       RHSTS(K) =   RHSTS(K) * DT<a name='5129'>
       AI(K)    =      AI(K) * DT<a name='5130'>
       BI(K)    = 1. + BI(K) * DT<a name='5131'>
       CI(K)    =      CI(K) * DT<a name='5132'>
    END DO<a name='5133'>
<a name='5134'>
<font color=#447700>! copy values for input variables before call to rosr12<a name='5135'></font>
<a name='5136'>
    DO K = ISNOW+1,NSOIL<a name='5137'>
       RHSTSIN(K) = RHSTS(K)<a name='5138'>
       CIIN(K)    = CI(K)<a name='5139'>
    END DO<a name='5140'>
<a name='5141'>
<font color=#447700>! solve the tri-diagonal matrix equation<a name='5142'></font>
<a name='5143'>
    CALL <A href='../../html_code/phys/module_sf_urban.F.html#ROSR12'>ROSR12</A><A href='../../html_code/phys/module_sf_urban.F.html#HSTEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROSR12_4"> (CI,AI,BI,CIIN,RHSTSIN,RHSTS,ISNOW+1,NSOIL,NSNOW)<a name='5144'>
<a name='5145'>
<font color=#447700>! update snow &amp; soil temperature<a name='5146'></font>
<a name='5147'>
    DO K = ISNOW+1,NSOIL<a name='5148'>
       STC (K) = STC (K) + CI (K)<a name='5149'>
    END DO<a name='5150'>
<a name='5151'>
  END SUBROUTINE HSTEP<a name='5152'>
<a name='5153'>
<font color=#447700>!== begin rosr12 ===================================================================================<a name='5154'></font>
<a name='5155'>
<A NAME='ROSR12'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ROSR12' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5156'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ROSR12</font> (P,A,B,C,D,DELTA,NTOP,NSOIL,NSNOW) <A href='../../call_to/ROSR12.html' TARGET='index'>7</A><a name='5157'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5158'></font>
<font color=#447700>! SUBROUTINE ROSR12<a name='5159'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5160'></font>
<font color=#447700>! INVERT (SOLVE) THE TRI-DIAGONAL MATRIX PROBLEM SHOWN BELOW:<a name='5161'></font>
<font color=#447700>! ###                                            ### ###  ###   ###  ###<a name='5162'></font>
<font color=#447700>! #B(1), C(1),  0  ,  0  ,  0  ,   . . .  ,    0   # #      #   #      #<a name='5163'></font>
<font color=#447700>! #A(2), B(2), C(2),  0  ,  0  ,   . . .  ,    0   # #      #   #      #<a name='5164'></font>
<font color=#447700>! # 0  , A(3), B(3), C(3),  0  ,   . . .  ,    0   # #      #   # D(3) #<a name='5165'></font>
<font color=#447700>! # 0  ,  0  , A(4), B(4), C(4),   . . .  ,    0   # # P(4) #   # D(4) #<a name='5166'></font>
<font color=#447700>! # 0  ,  0  ,  0  , A(5), B(5),   . . .  ,    0   # # P(5) #   # D(5) #<a name='5167'></font>
<font color=#447700>! # .                                          .   # #  .   # = #   .  #<a name='5168'></font>
<font color=#447700>! # .                                          .   # #  .   #   #   .  #<a name='5169'></font>
<font color=#447700>! # .                                          .   # #  .   #   #   .  #<a name='5170'></font>
<font color=#447700>! # 0  , . . . , 0 , A(M-2), B(M-2), C(M-2),   0   # #P(M-2)#   #D(M-2)#<a name='5171'></font>
<font color=#447700>! # 0  , . . . , 0 ,   0   , A(M-1), B(M-1), C(M-1)# #P(M-1)#   #D(M-1)#<a name='5172'></font>
<font color=#447700>! # 0  , . . . , 0 ,   0   ,   0   ,  A(M) ,  B(M) # # P(M) #   # D(M) #<a name='5173'></font>
<font color=#447700>! ###                                            ### ###  ###   ###  ###<a name='5174'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5175'></font>
    IMPLICIT NONE<a name='5176'>
<a name='5177'>
    INTEGER, INTENT(IN)   :: NTOP           <a name='5178'>
    INTEGER, INTENT(IN)   :: NSOIL,NSNOW<a name='5179'>
    INTEGER               :: K, KK<a name='5180'>
<a name='5181'>
    REAL, DIMENSION(-NSNOW+1:NSOIL),INTENT(IN):: A, B, D<a name='5182'>
    REAL, DIMENSION(-NSNOW+1:NSOIL),INTENT(INOUT):: C,P,DELTA<a name='5183'>
<a name='5184'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5185'></font>
<font color=#447700>! INITIALIZE EQN COEF C FOR THE LOWEST SOIL LAYER<a name='5186'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5187'></font>
    C (NSOIL) = 0.0<a name='5188'>
    P (NTOP) = - C (NTOP) / B (NTOP)<a name='5189'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5190'></font>
<font color=#447700>! SOLVE THE COEFS FOR THE 1ST SOIL LAYER<a name='5191'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5192'></font>
    DELTA (NTOP) = D (NTOP) / B (NTOP)<a name='5193'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5194'></font>
<font color=#447700>! SOLVE THE COEFS FOR SOIL LAYERS 2 THRU NSOIL<a name='5195'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5196'></font>
    DO K = NTOP+1,NSOIL<a name='5197'>
       P (K) = - C (K) * ( 1.0 / (B (K) + A (K) * P (K -1)) )<a name='5198'>
       DELTA (K) = (D (K) - A (K)* DELTA (K -1))* (1.0/ (B (K) + A (K)&amp;<a name='5199'>
            * P (K -1)))<a name='5200'>
    END DO<a name='5201'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5202'></font>
<font color=#447700>! SET P TO DELTA FOR LOWEST SOIL LAYER<a name='5203'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5204'></font>
    P (NSOIL) = DELTA (NSOIL)<a name='5205'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5206'></font>
<font color=#447700>! ADJUST P FOR SOIL LAYERS 2 THRU NSOIL<a name='5207'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5208'></font>
    DO K = NTOP+1,NSOIL<a name='5209'>
       KK = NSOIL - K + (NTOP-1) + 1<a name='5210'>
       P (KK) = P (KK) * P (KK +1) + DELTA (KK)<a name='5211'>
    END DO<a name='5212'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5213'></font>
  END SUBROUTINE ROSR12<a name='5214'>
<a name='5215'>
<font color=#447700>!== begin phasechange ==============================================================================<a name='5216'></font>
<a name='5217'>
<A NAME='PHASECHANGE'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#PHASECHANGE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5218'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>PHASECHANGE</font> (parameters,NSNOW   ,NSOIL   ,ISNOW   ,DT      ,FACT    , &amp; <font color=#447700>!in <A href='../../call_to/PHASECHANGE.html' TARGET='index'>2</A>,<A href='../../call_from/PHASECHANGE.html' TARGET='index'>7</A><a name='5219'></font>
                          DZSNSO  ,HCPCT   ,IST     ,ILOC    ,JLOC    , &amp; <font color=#447700>!in<a name='5220'></font>
                          STC     ,SNICE   ,SNLIQ   ,SNEQV   ,SNOWH   , &amp; <font color=#447700>!inout<a name='5221'></font>
                          SMC     ,SH2O    ,                            &amp; <font color=#447700>!inout<a name='5222'></font>
                          QMELT   ,IMELT   ,PONDING )                     <font color=#447700>!out<a name='5223'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5224'></font>
<font color=#447700>! melting/freezing of snow water and soil water<a name='5225'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5226'></font>
  IMPLICIT NONE<a name='5227'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5228'></font>
<font color=#447700>! inputs<a name='5229'></font>
<a name='5230'>
  type (noahmp_parameters), intent(in) :: parameters<a name='5231'>
  INTEGER, INTENT(IN)                             :: ILOC   <font color=#447700>!grid index<a name='5232'></font>
  INTEGER, INTENT(IN)                             :: JLOC   <font color=#447700>!grid index<a name='5233'></font>
  INTEGER, INTENT(IN)                             :: NSNOW  <font color=#447700>!maximum no. of snow layers [=3]<a name='5234'></font>
  INTEGER, INTENT(IN)                             :: NSOIL  <font color=#447700>!No. of soil layers [=4]<a name='5235'></font>
  INTEGER, INTENT(IN)                             :: ISNOW  <font color=#447700>!actual no. of snow layers [&lt;=3]<a name='5236'></font>
  INTEGER, INTENT(IN)                             :: IST    <font color=#447700>!surface type: 1-&gt;soil; 2-&gt;lake<a name='5237'></font>
  REAL, INTENT(IN)                                :: DT     <font color=#447700>!land model time step (sec)<a name='5238'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)     :: FACT   <font color=#447700>!temporary<a name='5239'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)     :: DZSNSO <font color=#447700>!snow/soil layer thickness [m]<a name='5240'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)     :: HCPCT  <font color=#447700>!heat capacity (J/m3/k)<a name='5241'></font>
<a name='5242'>
<font color=#447700>! outputs<a name='5243'></font>
  INTEGER, DIMENSION(-NSNOW+1:NSOIL), INTENT(OUT) :: IMELT  <font color=#447700>!phase change index<a name='5244'></font>
  REAL,                               INTENT(OUT) :: QMELT  <font color=#447700>!snowmelt rate [mm/s]<a name='5245'></font>
  REAL,                               INTENT(OUT) :: PONDING<font color=#447700>!snowmelt when snow has no layer [mm]<a name='5246'></font>
<a name='5247'>
<font color=#447700>! inputs and outputs<a name='5248'></font>
<a name='5249'>
  REAL, INTENT(INOUT) :: SNEQV<a name='5250'>
  REAL, INTENT(INOUT) :: SNOWH<a name='5251'>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT)  :: STC    <font color=#447700>!snow/soil layer temperature [k]<a name='5252'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT)  :: SH2O   <font color=#447700>!soil liquid water [m3/m3]<a name='5253'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT)  :: SMC    <font color=#447700>!total soil water [m3/m3]<a name='5254'></font>
  REAL, DIMENSION(-NSNOW+1:0)    , INTENT(INOUT)  :: SNICE  <font color=#447700>!snow layer ice [mm]<a name='5255'></font>
  REAL, DIMENSION(-NSNOW+1:0)    , INTENT(INOUT)  :: SNLIQ  <font color=#447700>!snow layer liquid water [mm]<a name='5256'></font>
<a name='5257'>
<font color=#447700>! local<a name='5258'></font>
<a name='5259'>
  INTEGER                         :: J         <font color=#447700>!do loop index<a name='5260'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: HM        <font color=#447700>!energy residual [w/m2]<a name='5261'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: XM        <font color=#447700>!melting or freezing water [kg/m2]<a name='5262'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: WMASS0<a name='5263'>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: WICE0 <a name='5264'>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: WLIQ0 <a name='5265'>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: MICE      <font color=#447700>!soil/snow ice mass [mm]<a name='5266'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: MLIQ      <font color=#447700>!soil/snow liquid water mass [mm]<a name='5267'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL) :: SUPERCOOL <font color=#447700>!supercooled water in soil (kg/m2)<a name='5268'></font>
  REAL                            :: HEATR     <font color=#447700>!energy residual or loss after melting/freezing<a name='5269'></font>
  REAL                            :: TEMP1     <font color=#447700>!temporary variables [kg/m2]<a name='5270'></font>
  REAL                            :: PROPOR<a name='5271'>
  REAL                            :: SMP       <font color=#447700>!frozen water potential (mm)<a name='5272'></font>
  REAL                            :: XMF       <font color=#447700>!total latent heat of phase change<a name='5273'></font>
<a name='5274'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5275'></font>
<font color=#447700>! Initialization<a name='5276'></font>
<a name='5277'>
    QMELT   = 0.<a name='5278'>
    PONDING = 0.<a name='5279'>
    XMF     = 0.<a name='5280'>
<a name='5281'>
    DO J = -NSNOW+1, NSOIL<a name='5282'>
         SUPERCOOL(J) = 0.0<a name='5283'>
    END DO<a name='5284'>
<a name='5285'>
    DO J = ISNOW+1,0       <font color=#447700>! all layers<a name='5286'></font>
         MICE(J) = SNICE(J)<a name='5287'>
         MLIQ(J) = SNLIQ(J)<a name='5288'>
    END DO<a name='5289'>
<a name='5290'>
    DO J = 1, NSOIL               <font color=#447700>! soil<a name='5291'></font>
         MLIQ(J) =  SH2O(J)            * DZSNSO(J) * 1000.<a name='5292'>
         MICE(J) = (SMC(J) - SH2O(J))  * DZSNSO(J) * 1000.<a name='5293'>
    END DO<a name='5294'>
<a name='5295'>
    DO J = ISNOW+1,NSOIL       <font color=#447700>! all layers<a name='5296'></font>
         IMELT(J)    = 0<a name='5297'>
         HM(J)       = 0.<a name='5298'>
         XM(J)       = 0.<a name='5299'>
         WICE0(J)    = MICE(J)<a name='5300'>
         WLIQ0(J)    = MLIQ(J)<a name='5301'>
         WMASS0(J)   = MICE(J) + MLIQ(J)<a name='5302'>
    ENDDO<a name='5303'>
<a name='5304'>
    if(ist == 1) then<a name='5305'>
      DO J = 1,NSOIL<a name='5306'>
         IF (OPT_FRZ == 1) THEN<a name='5307'>
            IF(STC(J) &lt; TFRZ) THEN<a name='5308'>
               SMP = HFUS*(TFRZ-STC(J))/(GRAV*STC(J))             <font color=#447700>!(m)<a name='5309'></font>
               SUPERCOOL(J) = parameters%SMCMAX(J)*(SMP/parameters%PSISAT(J))**(-1./parameters%BEXP(J))<a name='5310'>
               SUPERCOOL(J) = SUPERCOOL(J)*DZSNSO(J)*1000.        <font color=#447700>!(mm)<a name='5311'></font>
            END IF<a name='5312'>
         END IF<a name='5313'>
         IF (OPT_FRZ == 2) THEN<a name='5314'>
               CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#FRH2O'>FRH2O</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#PHASECHANGE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FRH2O_3"> (parameters,J,SUPERCOOL(J),STC(J),SMC(J),SH2O(J))<a name='5315'>
               SUPERCOOL(J) = SUPERCOOL(J)*DZSNSO(J)*1000.        <font color=#447700>!(mm)<a name='5316'></font>
         END IF<a name='5317'>
      ENDDO<a name='5318'>
    end if<a name='5319'>
<a name='5320'>
    DO J = ISNOW+1,NSOIL<a name='5321'>
         IF (MICE(J) &gt; 0. .AND. STC(J) &gt;= TFRZ) THEN  <font color=#447700>!melting <a name='5322'></font>
             IMELT(J) = 1<a name='5323'>
         ENDIF<a name='5324'>
         IF (MLIQ(J) &gt; SUPERCOOL(J) .AND. STC(J) &lt; TFRZ) THEN<a name='5325'>
             IMELT(J) = 2<a name='5326'>
         ENDIF<a name='5327'>
<a name='5328'>
         <font color=#447700>! If snow exists, but its thickness is not enough to create a layer<a name='5329'></font>
         IF (ISNOW == 0 .AND. SNEQV &gt; 0. .AND. J == 1) THEN<a name='5330'>
             IF (STC(J) &gt;= TFRZ) THEN<a name='5331'>
                IMELT(J) = 1<a name='5332'>
             ENDIF<a name='5333'>
         ENDIF<a name='5334'>
    ENDDO<a name='5335'>
<a name='5336'>
<font color=#447700>! Calculate the energy surplus and loss for melting and freezing<a name='5337'></font>
<a name='5338'>
    DO J = ISNOW+1,NSOIL<a name='5339'>
         IF (IMELT(J) &gt; 0) THEN<a name='5340'>
             HM(J) = (STC(J)-TFRZ)/FACT(J)<a name='5341'>
             STC(J) = TFRZ<a name='5342'>
         ENDIF<a name='5343'>
<a name='5344'>
         IF (IMELT(J) == 1 .AND. HM(J) &lt; 0.) THEN<a name='5345'>
            HM(J) = 0.<a name='5346'>
            IMELT(J) = 0<a name='5347'>
         ENDIF<a name='5348'>
         IF (IMELT(J) == 2 .AND. HM(J) &gt; 0.) THEN<a name='5349'>
            HM(J) = 0.<a name='5350'>
            IMELT(J) = 0<a name='5351'>
         ENDIF<a name='5352'>
         XM(J) = HM(J)*DT/HFUS                           <a name='5353'>
    ENDDO<a name='5354'>
<a name='5355'>
<font color=#447700>! The rate of melting and freezing for snow without a layer, needs more work.<a name='5356'></font>
<a name='5357'>
    IF (ISNOW == 0 .AND. SNEQV &gt; 0. .AND. XM(1) &gt; 0.) THEN  <a name='5358'>
        TEMP1  = SNEQV<a name='5359'>
        SNEQV  = MAX(0.,TEMP1-XM(1))  <a name='5360'>
        PROPOR = SNEQV/TEMP1<a name='5361'>
        SNOWH  = MAX(0.,PROPOR * SNOWH)<a name='5362'>
        HEATR  = HM(1) - HFUS*(TEMP1-SNEQV)/DT  <a name='5363'>
        IF (HEATR &gt; 0.) THEN<a name='5364'>
              XM(1) = HEATR*DT/HFUS             <a name='5365'>
              HM(1) = HEATR                    <a name='5366'>
        ELSE<a name='5367'>
              XM(1) = 0.<a name='5368'>
              HM(1) = 0.<a name='5369'>
        ENDIF<a name='5370'>
        QMELT   = MAX(0.,(TEMP1-SNEQV))/DT<a name='5371'>
        XMF     = HFUS*QMELT<a name='5372'>
        PONDING = TEMP1-SNEQV<a name='5373'>
    ENDIF<a name='5374'>
<a name='5375'>
<font color=#447700>! The rate of melting and freezing for snow and soil<a name='5376'></font>
<a name='5377'>
    DO J = ISNOW+1,NSOIL<a name='5378'>
      IF (IMELT(J) &gt; 0 .AND. ABS(HM(J)) &gt; 0.) THEN<a name='5379'>
<a name='5380'>
         HEATR = 0.<a name='5381'>
         IF (XM(J) &gt; 0.) THEN                            <a name='5382'>
            MICE(J) = MAX(0., WICE0(J)-XM(J))<a name='5383'>
            HEATR = HM(J) - HFUS*(WICE0(J)-MICE(J))/DT<a name='5384'>
         ELSE IF (XM(J) &lt; 0.) THEN                      <a name='5385'>
            IF (J &lt;= 0) THEN                             <font color=#447700>! snow<a name='5386'></font>
               MICE(J) = MIN(WMASS0(J), WICE0(J)-XM(J))  <a name='5387'>
            ELSE                                         <font color=#447700>! soil<a name='5388'></font>
               IF (WMASS0(J) &lt; SUPERCOOL(J)) THEN<a name='5389'>
                  MICE(J) = 0.<a name='5390'>
               ELSE<a name='5391'>
                  MICE(J) = MIN(WMASS0(J) - SUPERCOOL(J),WICE0(J)-XM(J))<a name='5392'>
                  MICE(J) = MAX(MICE(J),0.0)<a name='5393'>
               ENDIF<a name='5394'>
            ENDIF<a name='5395'>
            HEATR = HM(J) - HFUS*(WICE0(J)-MICE(J))/DT<a name='5396'>
         ENDIF<a name='5397'>
<a name='5398'>
         MLIQ(J) = MAX(0.,WMASS0(J)-MICE(J))<a name='5399'>
<a name='5400'>
         IF (ABS(HEATR) &gt; 0.) THEN<a name='5401'>
            STC(J) = STC(J) + FACT(J)*HEATR<a name='5402'>
            IF (J &lt;= 0) THEN                             <font color=#447700>! snow<a name='5403'></font>
               IF (MLIQ(J)*MICE(J)&gt;0.) STC(J) = TFRZ<a name='5404'>
            END IF<a name='5405'>
         ENDIF<a name='5406'>
<a name='5407'>
         XMF = XMF + HFUS * (WICE0(J)-MICE(J))/DT<a name='5408'>
<a name='5409'>
         IF (J &lt; 1) THEN<a name='5410'>
            QMELT = QMELT + MAX(0.,(WICE0(J)-MICE(J)))/DT<a name='5411'>
         ENDIF<a name='5412'>
      ENDIF<a name='5413'>
    ENDDO<a name='5414'>
<a name='5415'>
    DO J = ISNOW+1,0             <font color=#447700>! snow<a name='5416'></font>
       SNLIQ(J) = MLIQ(J)<a name='5417'>
       SNICE(J) = MICE(J)<a name='5418'>
    END DO<a name='5419'>
<a name='5420'>
    DO J = 1, NSOIL              <font color=#447700>! soil<a name='5421'></font>
       SH2O(J) =  MLIQ(J)            / (1000. * DZSNSO(J))<a name='5422'>
       SMC(J)  = (MLIQ(J) + MICE(J)) / (1000. * DZSNSO(J))<a name='5423'>
    END DO<a name='5424'>
   <a name='5425'>
  END SUBROUTINE PHASECHANGE<a name='5426'>
<a name='5427'>
<font color=#447700>!== begin frh2o ====================================================================================<a name='5428'></font>
<a name='5429'>
<A NAME='FRH2O'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#FRH2O' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5430'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>FRH2O</font> (parameters,ISOIL,FREE,TKELV,SMC,SH2O) <A href='../../call_to/FRH2O.html' TARGET='index'>3</A>,<A href='../../call_from/FRH2O.html' TARGET='index'>1</A><a name='5431'>
<a name='5432'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5433'></font>
<font color=#447700>! SUBROUTINE FRH2O<a name='5434'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5435'></font>
<font color=#447700>! CALCULATE AMOUNT OF SUPERCOOLED LIQUID SOIL WATER CONTENT IF<a name='5436'></font>
<font color=#447700>! TEMPERATURE IS BELOW 273.15K (TFRZ).  REQUIRES NEWTON-TYPE ITERATION<a name='5437'></font>
<font color=#447700>! TO SOLVE THE NONLINEAR IMPLICIT EQUATION GIVEN IN EQN 17 OF KOREN ET AL<a name='5438'></font>
<font color=#447700>! (1999, JGR, VOL 104(D16), 19569-19585).<a name='5439'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5440'></font>
<font color=#447700>! NEW VERSION (JUNE 2001): MUCH FASTER AND MORE ACCURATE NEWTON<a name='5441'></font>
<font color=#447700>! ITERATION ACHIEVED BY FIRST TAKING LOG OF EQN CITED ABOVE -- LESS THAN<a name='5442'></font>
<font color=#447700>! 4 (TYPICALLY 1 OR 2) ITERATIONS ACHIEVES CONVERGENCE.  ALSO, EXPLICIT<a name='5443'></font>
<font color=#447700>! 1-STEP SOLUTION OPTION FOR SPECIAL CASE OF PARAMETER CK=0, WHICH<a name='5444'></font>
<font color=#447700>! REDUCES THE ORIGINAL IMPLICIT EQUATION TO A SIMPLER EXPLICIT FORM,<a name='5445'></font>
<font color=#447700>! KNOWN AS THE "FLERCHINGER EQN". IMPROVED HANDLING OF SOLUTION IN THE<a name='5446'></font>
<font color=#447700>! LIMIT OF FREEZING POINT TEMPERATURE TFRZ.<a name='5447'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5448'></font>
<font color=#447700>! INPUT:<a name='5449'></font>
<a name='5450'>
<font color=#447700>!   TKELV.........TEMPERATURE (Kelvin)<a name='5451'></font>
<font color=#447700>!   SMC...........TOTAL SOIL MOISTURE CONTENT (VOLUMETRIC)<a name='5452'></font>
<font color=#447700>!   SH2O..........LIQUID SOIL MOISTURE CONTENT (VOLUMETRIC)<a name='5453'></font>
<font color=#447700>!   B.............SOIL TYPE "B" PARAMETER (FROM REDPRM)<a name='5454'></font>
<font color=#447700>!   PSISAT........SATURATED SOIL MATRIC POTENTIAL (FROM REDPRM)<a name='5455'></font>
<a name='5456'>
<font color=#447700>! OUTPUT:<a name='5457'></font>
<font color=#447700>!   FREE..........SUPERCOOLED LIQUID WATER CONTENT [m3/m3]<a name='5458'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5459'></font>
    IMPLICIT NONE<a name='5460'>
  type (noahmp_parameters), intent(in) :: parameters<a name='5461'>
    INTEGER,INTENT(IN)   :: ISOIL<a name='5462'>
    REAL, INTENT(IN)     :: SH2O,SMC,TKELV<a name='5463'>
    REAL, INTENT(OUT)    :: FREE<a name='5464'>
    REAL                 :: BX,DENOM,DF,DSWL,FK,SWL,SWLK<a name='5465'>
    INTEGER              :: NLOG,KCOUNT<a name='5466'>
<font color=#447700>!      PARAMETER(CK = 0.0)<a name='5467'></font>
    REAL, PARAMETER      :: CK = 8.0, BLIM = 5.5, ERROR = 0.005,       &amp;<a name='5468'>
         DICE = 920.0<a name='5469'>
    CHARACTER(LEN=80)    :: message<a name='5470'>
<a name='5471'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5472'></font>
<font color=#447700>! LIMITS ON PARAMETER B: B &lt; 5.5  (use parameter BLIM)<a name='5473'></font>
<font color=#447700>! SIMULATIONS SHOWED IF B &gt; 5.5 UNFROZEN WATER CONTENT IS<a name='5474'></font>
<font color=#447700>! NON-REALISTICALLY HIGH AT VERY LOW TEMPERATURES.<a name='5475'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5476'></font>
    BX = parameters%BEXP(ISOIL)<a name='5477'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5478'></font>
<font color=#447700>! INITIALIZING ITERATIONS COUNTER AND ITERATIVE SOLUTION FLAG.<a name='5479'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5480'></font>
<a name='5481'>
    IF (parameters%BEXP(ISOIL) &gt;  BLIM) BX = BLIM<a name='5482'>
    NLOG = 0<a name='5483'>
<a name='5484'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5485'></font>
<font color=#447700>!  IF TEMPERATURE NOT SIGNIFICANTLY BELOW FREEZING (TFRZ), SH2O = SMC<a name='5486'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5487'></font>
    KCOUNT = 0<a name='5488'>
    IF (TKELV &gt; (TFRZ- 1.E-3)) THEN<a name='5489'>
       FREE = SMC<a name='5490'>
    ELSE<a name='5491'>
<a name='5492'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5493'></font>
<font color=#447700>! OPTION 1: ITERATED SOLUTION IN KOREN ET AL, JGR, 1999, EQN 17<a name='5494'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5495'></font>
<font color=#447700>! INITIAL GUESS FOR SWL (frozen content)<a name='5496'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5497'></font>
       IF (CK /= 0.0) THEN<a name='5498'>
          SWL = SMC - SH2O<a name='5499'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5500'></font>
<font color=#447700>! KEEP WITHIN BOUNDS.<a name='5501'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5502'></font>
          IF (SWL &gt; (SMC -0.02)) SWL = SMC -0.02<a name='5503'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5504'></font>
<font color=#447700>!  START OF ITERATIONS<a name='5505'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5506'></font>
          IF (SWL &lt; 0.) SWL = 0.<a name='5507'>
1001      Continue<a name='5508'>
          IF (.NOT.( (NLOG &lt; 10) .AND. (KCOUNT == 0)))   goto 1002<a name='5509'>
          NLOG = NLOG +1<a name='5510'>
          DF = ALOG ( ( parameters%PSISAT(ISOIL) * GRAV / HFUS ) * ( ( 1. + CK * SWL )**2.) * &amp;<a name='5511'>
               ( parameters%SMCMAX(ISOIL) / (SMC - SWL) )** BX) - ALOG ( - (               &amp;<a name='5512'>
               TKELV - TFRZ)/ TKELV)<a name='5513'>
          DENOM = 2. * CK / ( 1. + CK * SWL ) + BX / ( SMC - SWL )<a name='5514'>
          SWLK = SWL - DF / DENOM<a name='5515'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5516'></font>
<font color=#447700>! BOUNDS USEFUL FOR MATHEMATICAL SOLUTION.<a name='5517'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5518'></font>
          IF (SWLK &gt; (SMC -0.02)) SWLK = SMC - 0.02<a name='5519'>
          IF (SWLK &lt; 0.) SWLK = 0.<a name='5520'>
<a name='5521'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5522'></font>
<font color=#447700>! MATHEMATICAL SOLUTION BOUNDS APPLIED.<a name='5523'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5524'></font>
          DSWL = ABS (SWLK - SWL)<a name='5525'>
<font color=#447700>! IF MORE THAN 10 ITERATIONS, USE EXPLICIT METHOD (CK=0 APPROX.)<a name='5526'></font>
<font color=#447700>! WHEN DSWL LESS OR EQ. ERROR, NO MORE ITERATIONS REQUIRED.<a name='5527'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5528'></font>
          SWL = SWLK<a name='5529'>
          IF ( DSWL &lt;= ERROR ) THEN<a name='5530'>
             KCOUNT = KCOUNT +1<a name='5531'>
          END IF<a name='5532'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5533'></font>
<font color=#447700>!  END OF ITERATIONS<a name='5534'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5535'></font>
<font color=#447700>! BOUNDS APPLIED WITHIN DO-BLOCK ARE VALID FOR PHYSICAL SOLUTION.<a name='5536'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5537'></font>
          goto 1001<a name='5538'>
1002      continue<a name='5539'>
          FREE = SMC - SWL<a name='5540'>
       END IF<a name='5541'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5542'></font>
<font color=#447700>! END OPTION 1<a name='5543'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5544'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5545'></font>
<font color=#447700>! OPTION 2: EXPLICIT SOLUTION FOR FLERCHINGER EQ. i.e. CK=0<a name='5546'></font>
<font color=#447700>! IN KOREN ET AL., JGR, 1999, EQN 17<a name='5547'></font>
<font color=#447700>! APPLY PHYSICAL BOUNDS TO FLERCHINGER SOLUTION<a name='5548'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5549'></font>
       IF (KCOUNT == 0) THEN<a name='5550'>
          write(message, '("Flerchinger used in NEW version. Iterations=", I6)') NLOG<a name='5551'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#FRH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_981">(trim(message))<a name='5552'>
          FK = ( ( (HFUS / (GRAV * ( - parameters%PSISAT(ISOIL))))*                    &amp;<a name='5553'>
               ( (TKELV - TFRZ)/ TKELV))** ( -1/ BX))* parameters%SMCMAX(ISOIL)<a name='5554'>
          IF (FK &lt; 0.02) FK = 0.02<a name='5555'>
          FREE = MIN (FK, SMC)<a name='5556'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5557'></font>
<font color=#447700>! END OPTION 2<a name='5558'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5559'></font>
       END IF<a name='5560'>
    END IF<a name='5561'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5562'></font>
  END SUBROUTINE FRH2O<a name='5563'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5564'></font>
<font color=#447700>! ==================================================================================================<a name='5565'></font>
<font color=#447700>! **********************End of energy subroutines***********************<a name='5566'></font>
<font color=#447700>! ==================================================================================================<a name='5567'></font>
<a name='5568'>
<font color=#447700>!== begin water ====================================================================================<a name='5569'></font>
<a name='5570'>
<A NAME='WATER'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#WATER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5571'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>WATER</font> (parameters,VEGTYP ,NSNOW  ,NSOIL  ,IMELT  ,DT     ,UU     , &amp; <font color=#447700>!in <A href='../../call_to/WATER.html' TARGET='index'>1</A>,<A href='../../call_from/WATER.html' TARGET='index'>5</A><a name='5572'></font>
                    VV     ,FCEV   ,FCTR   ,QPRECC ,QPRECL ,ELAI   , &amp; <font color=#447700>!in<a name='5573'></font>
                    ESAI   ,SFCTMP ,QVAP   ,QDEW   ,ZSOIL  ,BTRANI , &amp; <font color=#447700>!in<a name='5574'></font>
                    FICEOLD,PONDING,TG     ,IST    ,FVEG   ,ILOC   ,JLOC ,SMCEQ , &amp; <font color=#447700>!in<a name='5575'></font>
                    BDFALL ,FP     ,RAIN   ,SNOW,                    &amp; <font color=#447700>!in  MB/AN: v3.7<a name='5576'></font>
		    QSNOW  ,QRAIN  ,SNOWHIN,LATHEAV,LATHEAG,frozen_canopy,frozen_ground,    &amp; <font color=#447700>!in  MB<a name='5577'></font>
                    ISNOW  ,CANLIQ ,CANICE ,TV     ,SNOWH  ,SNEQV  , &amp; <font color=#447700>!inout<a name='5578'></font>
                    SNICE  ,SNLIQ  ,STC    ,ZSNSO  ,SH2O   ,SMC    , &amp; <font color=#447700>!inout<a name='5579'></font>
                    SICE   ,ZWT    ,WA     ,WT     ,DZSNSO ,WSLAKE , &amp; <font color=#447700>!inout<a name='5580'></font>
                    SMCWTD ,DEEPRECH,RECH                          , &amp; <font color=#447700>!inout<a name='5581'></font>
                    CMC    ,ECAN   ,ETRAN  ,FWET   ,RUNSRF ,RUNSUB , &amp; <font color=#447700>!out<a name='5582'></font>
                    QIN    ,QDIS   ,PONDING1       ,PONDING2,        &amp;<a name='5583'>
                    QSNBOT                                           &amp;<a name='5584'>
#ifdef WRF_HYDRO<a name='5585'>
                        ,sfcheadrt                     &amp;<a name='5586'>
#endif<a name='5587'>
                    )  <font color=#447700>!out<a name='5588'></font>
<font color=#447700>! ----------------------------------------------------------------------  <a name='5589'></font>
<font color=#447700>! Code history:<a name='5590'></font>
<font color=#447700>! Initial code: Guo-Yue Niu, Oct. 2007<a name='5591'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5592'></font>
  implicit none<a name='5593'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5594'></font>
<font color=#447700>! input<a name='5595'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='5596'>
  INTEGER,                         INTENT(IN)    :: ILOC    <font color=#447700>!grid index<a name='5597'></font>
  INTEGER,                         INTENT(IN)    :: JLOC    <font color=#447700>!grid index<a name='5598'></font>
  INTEGER,                         INTENT(IN)    :: VEGTYP  <font color=#447700>!vegetation type<a name='5599'></font>
  INTEGER,                         INTENT(IN)    :: NSNOW   <font color=#447700>!maximum no. of snow layers<a name='5600'></font>
  INTEGER                        , INTENT(IN)    :: IST     <font color=#447700>!surface type 1-soil; 2-lake<a name='5601'></font>
  INTEGER,                         INTENT(IN)    :: NSOIL   <font color=#447700>!no. of soil layers<a name='5602'></font>
  INTEGER, DIMENSION(-NSNOW+1:0) , INTENT(IN)    :: IMELT   <font color=#447700>!melting state index [1-melt; 2-freeze]<a name='5603'></font>
  REAL,                            INTENT(IN)    :: DT      <font color=#447700>!main time step (s)<a name='5604'></font>
  REAL,                            INTENT(IN)    :: UU      <font color=#447700>!u-direction wind speed [m/s]<a name='5605'></font>
  REAL,                            INTENT(IN)    :: VV      <font color=#447700>!v-direction wind speed [m/s]<a name='5606'></font>
  REAL,                            INTENT(IN)    :: FCEV    <font color=#447700>!canopy evaporation (w/m2) [+ to atm ]<a name='5607'></font>
  REAL,                            INTENT(IN)    :: FCTR    <font color=#447700>!transpiration (w/m2) [+ to atm]<a name='5608'></font>
  REAL,                            INTENT(IN)    :: QPRECC  <font color=#447700>!convective precipitation (mm/s)<a name='5609'></font>
  REAL,                            INTENT(IN)    :: QPRECL  <font color=#447700>!large-scale precipitation (mm/s)<a name='5610'></font>
  REAL,                            INTENT(IN)    :: ELAI    <font color=#447700>!leaf area index, after burying by snow<a name='5611'></font>
  REAL,                            INTENT(IN)    :: ESAI    <font color=#447700>!stem area index, after burying by snow<a name='5612'></font>
  REAL,                            INTENT(IN)    :: SFCTMP  <font color=#447700>!surface air temperature [k]<a name='5613'></font>
  REAL,                            INTENT(IN)    :: QVAP    <font color=#447700>!soil surface evaporation rate[mm/s]<a name='5614'></font>
  REAL,                            INTENT(IN)    :: QDEW    <font color=#447700>!soil surface dew rate[mm/s]<a name='5615'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN)    :: ZSOIL   <font color=#447700>!depth of layer-bottom from soil surface<a name='5616'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN)    :: BTRANI  <font color=#447700>!soil water stress factor (0 to 1)<a name='5617'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(IN)    :: FICEOLD <font color=#447700>!ice fraction at last timestep<a name='5618'></font>
<font color=#447700>!  REAL                           , INTENT(IN)    :: PONDING ![mm]<a name='5619'></font>
  REAL                           , INTENT(IN)    :: TG      <font color=#447700>!ground temperature (k)<a name='5620'></font>
  REAL                           , INTENT(IN)    :: FVEG    <font color=#447700>!greeness vegetation fraction (-)<a name='5621'></font>
  REAL                           , INTENT(IN)    :: BDFALL   <font color=#447700>!bulk density of snowfall (kg/m3) ! MB/AN: v3.7<a name='5622'></font>
  REAL                           , INTENT(IN)    :: FP       <font color=#447700>!fraction of the gridcell that receives precipitation ! MB/AN: v3.7<a name='5623'></font>
  REAL                           , INTENT(IN)    :: RAIN     <font color=#447700>!rainfall (mm/s) ! MB/AN: v3.7<a name='5624'></font>
  REAL                           , INTENT(IN)    :: SNOW     <font color=#447700>!snowfall (mm/s) ! MB/AN: v3.7<a name='5625'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN)    :: SMCEQ   <font color=#447700>!equilibrium soil water content [m3/m3] (used in m-m&amp;f groundwater dynamics)<a name='5626'></font>
  REAL                           , INTENT(IN)    :: QSNOW   <font color=#447700>!snow at ground srf (mm/s) [+]<a name='5627'></font>
  REAL                           , INTENT(IN)    :: QRAIN   <font color=#447700>!rain at ground srf (mm) [+]<a name='5628'></font>
  REAL                           , INTENT(IN)    :: SNOWHIN <font color=#447700>!snow depth increasing rate (m/s)<a name='5629'></font>
<a name='5630'>
<font color=#447700>! input/output<a name='5631'></font>
  INTEGER,                         INTENT(INOUT) :: ISNOW   <font color=#447700>!actual no. of snow layers<a name='5632'></font>
  REAL,                            INTENT(INOUT) :: CANLIQ  <font color=#447700>!intercepted liquid water (mm)<a name='5633'></font>
  REAL,                            INTENT(INOUT) :: CANICE  <font color=#447700>!intercepted ice mass (mm)<a name='5634'></font>
  REAL,                            INTENT(INOUT) :: TV      <font color=#447700>!vegetation temperature (k)<a name='5635'></font>
  REAL,                            INTENT(INOUT) :: SNOWH   <font color=#447700>!snow height [m]<a name='5636'></font>
  REAL,                            INTENT(INOUT) :: SNEQV   <font color=#447700>!snow water eqv. [mm]<a name='5637'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNICE   <font color=#447700>!snow layer ice [mm]<a name='5638'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNLIQ   <font color=#447700>!snow layer liquid water [mm]<a name='5639'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC     <font color=#447700>!snow/soil layer temperature [k]<a name='5640'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: ZSNSO   <font color=#447700>!depth of snow/soil layer-bottom<a name='5641'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: DZSNSO  <font color=#447700>!snow/soil layer thickness [m]<a name='5642'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SH2O    <font color=#447700>!soil liquid water content [m3/m3]<a name='5643'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SICE    <font color=#447700>!soil ice content [m3/m3]<a name='5644'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SMC     <font color=#447700>!total soil water content [m3/m3]<a name='5645'></font>
  REAL,                            INTENT(INOUT) :: ZWT     <font color=#447700>!the depth to water table [m]<a name='5646'></font>
  REAL,                            INTENT(INOUT) :: WA      <font color=#447700>!water storage in aquifer [mm]<a name='5647'></font>
  REAL,                            INTENT(INOUT) :: WT      <font color=#447700>!water storage in aquifer <a name='5648'></font>
                                                            <font color=#447700>!+ stuarated soil [mm]<a name='5649'></font>
  REAL,                            INTENT(INOUT) :: WSLAKE  <font color=#447700>!water storage in lake (can be -) (mm)<a name='5650'></font>
  REAL                           , INTENT(INOUT) :: PONDING <font color=#447700>![mm]<a name='5651'></font>
  REAL,                            INTENT(INOUT) :: SMCWTD <font color=#447700>!soil water content between bottom of the soil and water table [m3/m3]<a name='5652'></font>
  REAL,                            INTENT(INOUT) :: DEEPRECH <font color=#447700>!recharge to or from the water table when deep [m]<a name='5653'></font>
  REAL,                            INTENT(INOUT) :: RECH <font color=#447700>!recharge to or from the water table when shallow [m] (diagnostic)<a name='5654'></font>
<a name='5655'>
<font color=#447700>! output<a name='5656'></font>
  REAL,                            INTENT(OUT)   :: CMC     <font color=#447700>!intercepted water per ground area (mm)<a name='5657'></font>
  REAL,                            INTENT(OUT)   :: ECAN    <font color=#447700>!evap of intercepted water (mm/s) [+]<a name='5658'></font>
  REAL,                            INTENT(OUT)   :: ETRAN   <font color=#447700>!transpiration rate (mm/s) [+]<a name='5659'></font>
  REAL,                            INTENT(OUT)   :: FWET    <font color=#447700>!wetted/snowed fraction of canopy (-)<a name='5660'></font>
  REAL,                            INTENT(OUT)   :: RUNSRF  <font color=#447700>!surface runoff [mm/s] <a name='5661'></font>
  REAL,                            INTENT(OUT)   :: RUNSUB  <font color=#447700>!baseflow (sturation excess) [mm/s]<a name='5662'></font>
  REAL,                            INTENT(OUT)   :: QIN     <font color=#447700>!groundwater recharge [mm/s]<a name='5663'></font>
  REAL,                            INTENT(OUT)   :: QDIS    <font color=#447700>!groundwater discharge [mm/s]<a name='5664'></font>
  REAL,                            INTENT(OUT)   :: PONDING1<a name='5665'>
  REAL,                            INTENT(OUT)   :: PONDING2<a name='5666'>
  REAL,                            INTENT(OUT)   :: QSNBOT  <font color=#447700>!melting water out of snow bottom [mm/s]<a name='5667'></font>
  REAL                              , INTENT(IN)   :: LATHEAV <font color=#447700>!latent heat vap./sublimation (j/kg)<a name='5668'></font>
  REAL                              , INTENT(IN)   :: LATHEAG <font color=#447700>!latent heat vap./sublimation (j/kg)<a name='5669'></font>
  LOGICAL                           , INTENT(IN)   :: FROZEN_GROUND <font color=#447700>! used to define latent heat pathway<a name='5670'></font>
  LOGICAL                           , INTENT(IN)   :: FROZEN_CANOPY <font color=#447700>! used to define latent heat pathway<a name='5671'></font>
<a name='5672'>
<a name='5673'>
<font color=#447700>! local<a name='5674'></font>
  INTEGER                                        :: IZ<a name='5675'>
  REAL                                           :: QINSUR  <font color=#447700>!water input on soil surface [m/s]<a name='5676'></font>
  REAL                                           :: QSEVA   <font color=#447700>!soil surface evap rate [mm/s]<a name='5677'></font>
  REAL                                           :: QSDEW   <font color=#447700>!soil surface dew rate [mm/s]<a name='5678'></font>
  REAL                                           :: QSNFRO  <font color=#447700>!snow surface frost rate[mm/s]<a name='5679'></font>
  REAL                                           :: QSNSUB  <font color=#447700>!snow surface sublimation rate [mm/s]<a name='5680'></font>
  REAL, DIMENSION(       1:NSOIL)                :: ETRANI  <font color=#447700>!transpiration rate (mm/s) [+]<a name='5681'></font>
  REAL, DIMENSION(       1:NSOIL)                :: WCND   <font color=#447700>!hydraulic conductivity (m/s)<a name='5682'></font>
  REAL                                           :: QDRAIN  <font color=#447700>!soil-bottom free drainage [mm/s] <a name='5683'></font>
  REAL                                           :: SNOFLOW <font color=#447700>!glacier flow [mm/s]<a name='5684'></font>
  REAL                                           :: FCRMAX <font color=#447700>!maximum of FCR (-)<a name='5685'></font>
<a name='5686'>
  REAL, PARAMETER ::  WSLMAX = 5000.      <font color=#447700>!maximum lake water storage (mm)<a name='5687'></font>
<a name='5688'>
#ifdef WRF_HYDRO<a name='5689'>
  REAL                           , INTENT(INOUT)    :: sfcheadrt<a name='5690'>
#endif<a name='5691'>
<a name='5692'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5693'></font>
<font color=#447700>! initialize<a name='5694'></font>
<a name='5695'>
   ETRANI(1:NSOIL) = 0.<a name='5696'>
   SNOFLOW         = 0.<a name='5697'>
   RUNSUB          = 0.<a name='5698'>
   QINSUR          = 0.<a name='5699'>
<a name='5700'>
<font color=#447700>! canopy-intercepted snowfall/rainfall, drips, and throughfall<a name='5701'></font>
<a name='5702'>
   CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CANWATER'>CANWATER</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#WATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CANWATER_1"> (parameters,VEGTYP ,DT     , &amp; <font color=#447700>!in<a name='5703'></font>
                  FCEV   ,FCTR   ,ELAI   , &amp; <font color=#447700>!in<a name='5704'></font>
                  ESAI   ,TG     ,FVEG   ,ILOC   , JLOC, &amp; <font color=#447700>!in<a name='5705'></font>
                  BDFALL ,FROZEN_CANOPY  , &amp; <font color=#447700>!in     <a name='5706'></font>
                  CANLIQ ,CANICE ,TV     ,                 &amp; <font color=#447700>!inout<a name='5707'></font>
                  CMC    ,ECAN   ,ETRAN  , &amp; <font color=#447700>!out<a name='5708'></font>
                  FWET      )                           <font color=#447700>!out<a name='5709'></font>
<a name='5710'>
<font color=#447700>! sublimation, frost, evaporation, and dew<a name='5711'></font>
<a name='5712'>
     QSNSUB = 0.<a name='5713'>
     IF (SNEQV &gt; 0.) THEN<a name='5714'>
       QSNSUB = MIN(QVAP, SNEQV/DT)<a name='5715'>
     ENDIF<a name='5716'>
     QSEVA = QVAP-QSNSUB<a name='5717'>
<a name='5718'>
     QSNFRO = 0.<a name='5719'>
     IF (SNEQV &gt; 0.) THEN<a name='5720'>
        QSNFRO = QDEW<a name='5721'>
     ENDIF<a name='5722'>
     QSDEW = QDEW - QSNFRO<a name='5723'>
<a name='5724'>
     CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWWATER'>SNOWWATER</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#WATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWWATER_3"> (parameters,NSNOW  ,NSOIL  ,IMELT  ,DT     ,ZSOIL  , &amp; <font color=#447700>!in<a name='5725'></font>
          &amp;          SFCTMP ,SNOWHIN,QSNOW  ,QSNFRO ,QSNSUB , &amp; <font color=#447700>!in<a name='5726'></font>
          &amp;          QRAIN  ,FICEOLD,ILOC   ,JLOC   ,         &amp; <font color=#447700>!in<a name='5727'></font>
          &amp;          ISNOW  ,SNOWH  ,SNEQV  ,SNICE  ,SNLIQ  , &amp; <font color=#447700>!inout<a name='5728'></font>
          &amp;          SH2O   ,SICE   ,STC    ,ZSNSO  ,DZSNSO , &amp; <font color=#447700>!inout<a name='5729'></font>
          &amp;          QSNBOT ,SNOFLOW,PONDING1       ,PONDING2)  <font color=#447700>!out<a name='5730'></font>
<a name='5731'>
   IF(FROZEN_GROUND) THEN<a name='5732'>
      SICE(1) =  SICE(1) + (QSDEW-QSEVA)*DT/(DZSNSO(1)*1000.)<a name='5733'>
      QSDEW = 0.0<a name='5734'>
      QSEVA = 0.0<a name='5735'>
      IF(SICE(1) &lt; 0.) THEN<a name='5736'>
         SH2O(1) = SH2O(1) + SICE(1)<a name='5737'>
         SICE(1) = 0.<a name='5738'>
      END IF<a name='5739'>
   END IF<a name='5740'>
<a name='5741'>
<font color=#447700>! convert units (mm/s -&gt; m/s)<a name='5742'></font>
<a name='5743'>
    <font color=#447700>!PONDING: melting water from snow when there is no layer<a name='5744'></font>
    QINSUR = (PONDING+PONDING1+PONDING2)/DT * 0.001<a name='5745'>
<font color=#447700>!    QINSUR = PONDING/DT * 0.001<a name='5746'></font>
<a name='5747'>
    IF(ISNOW == 0) THEN<a name='5748'>
       QINSUR = QINSUR+(QSNBOT + QSDEW + QRAIN) * 0.001<a name='5749'>
    ELSE<a name='5750'>
       QINSUR = QINSUR+(QSNBOT + QSDEW) * 0.001<a name='5751'>
    ENDIF<a name='5752'>
<a name='5753'>
    QSEVA  = QSEVA * 0.001 <a name='5754'>
<a name='5755'>
    DO IZ = 1, parameters%NROOT<a name='5756'>
       ETRANI(IZ) = ETRAN * BTRANI(IZ) * 0.001<a name='5757'>
    ENDDO<a name='5758'>
<a name='5759'>
#ifdef WRF_HYDRO<a name='5760'>
       QINSUR = QINSUR+sfcheadrt/DT*0.001  <font color=#447700>!sfcheadrt units (m)<a name='5761'></font>
#endif<a name='5762'>
<a name='5763'>
<font color=#447700>! lake/soil water balances<a name='5764'></font>
<a name='5765'>
    IF (IST == 2) THEN                                        <font color=#447700>! lake<a name='5766'></font>
       RUNSRF = 0.<a name='5767'>
       IF(WSLAKE &gt;= WSLMAX) RUNSRF = QINSUR*1000.             <font color=#447700>!mm/s<a name='5768'></font>
       WSLAKE = WSLAKE + (QINSUR-QSEVA)*1000.*DT -RUNSRF*DT   <font color=#447700>!mm<a name='5769'></font>
    ELSE                                                      <font color=#447700>! soil<a name='5770'></font>
       CALL      <A href='../../html_code/phys/module_sf_noahmplsm.F.html#SOILWATER'>SOILWATER</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#WATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILWATER_2"> (parameters,NSOIL  ,NSNOW  ,DT     ,ZSOIL  ,DZSNSO , &amp; <font color=#447700>!in<a name='5771'></font>
                            QINSUR ,QSEVA  ,ETRANI ,SICE   ,ILOC   , JLOC , &amp; <font color=#447700>!in<a name='5772'></font>
                            SH2O   ,SMC    ,ZWT    ,VEGTYP , &amp; <font color=#447700>!inout<a name='5773'></font>
                           SMCWTD, DEEPRECH                       , &amp; <font color=#447700>!inout<a name='5774'></font>
                            RUNSRF ,QDRAIN ,RUNSUB ,WCND   ,FCRMAX )   <font color=#447700>!out<a name='5775'></font>
 <a name='5776'>
       IF(OPT_RUN == 1) THEN <a name='5777'>
          CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#GROUNDWATER'>GROUNDWATER</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#WATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GROUNDWATER_1"> (parameters,NSNOW  ,NSOIL  ,DT     ,SICE   ,ZSOIL  , &amp; <font color=#447700>!in<a name='5778'></font>
                            STC    ,WCND   ,FCRMAX ,ILOC   ,JLOC   , &amp; <font color=#447700>!in<a name='5779'></font>
                            SH2O   ,ZWT    ,WA     ,WT     ,         &amp; <font color=#447700>!inout<a name='5780'></font>
                            QIN    ,QDIS   )                           <font color=#447700>!out<a name='5781'></font>
          RUNSUB       = QDIS          <font color=#447700>!mm/s<a name='5782'></font>
       END IF<a name='5783'>
<a name='5784'>
       IF(OPT_RUN == 3 .or. OPT_RUN == 4) THEN <a name='5785'>
          RUNSUB       = RUNSUB + QDRAIN        <font color=#447700>!mm/s<a name='5786'></font>
       END IF<a name='5787'>
<a name='5788'>
       DO IZ = 1,NSOIL<a name='5789'>
           SMC(IZ) = SH2O(IZ) + SICE(IZ)<a name='5790'>
       ENDDO<a name='5791'>
 <a name='5792'>
       IF(OPT_RUN == 5) THEN<a name='5793'>
          CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#SHALLOWWATERTABLE'>SHALLOWWATERTABLE</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#WATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHALLOWWATERTABLE_1"> (parameters,NSNOW  ,NSOIL, ZSOIL, DT       , &amp; <font color=#447700>!in<a name='5794'></font>
                         DZSNSO ,SMCEQ   ,ILOC , JLOC        , &amp; <font color=#447700>!in<a name='5795'></font>
                         SMC    ,ZWT    ,SMCWTD ,RECH, QDRAIN  ) <font color=#447700>!inout<a name='5796'></font>
<a name='5797'>
          SH2O(NSOIL) = SMC(NSOIL) - SICE(NSOIL)<a name='5798'>
          RUNSUB = RUNSUB + QDRAIN <font color=#447700>!it really comes from subroutine watertable, which is not called with the same frequency as the soil routines here<a name='5799'></font>
          WA = 0.<a name='5800'>
       ENDIF<a name='5801'>
<a name='5802'>
    ENDIF<a name='5803'>
<a name='5804'>
    RUNSUB       = RUNSUB + SNOFLOW         <font color=#447700>!mm/s<a name='5805'></font>
<a name='5806'>
  END SUBROUTINE WATER<a name='5807'>
<a name='5808'>
<font color=#447700>!== begin canwater =================================================================================<a name='5809'></font>
<a name='5810'>
<A NAME='CANWATER'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#CANWATER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5811'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>CANWATER</font> (parameters,VEGTYP ,DT     , &amp; <font color=#447700>!in <A href='../../call_to/CANWATER.html' TARGET='index'>1</A><a name='5812'></font>
                       FCEV   ,FCTR   ,ELAI   , &amp; <font color=#447700>!in<a name='5813'></font>
                       ESAI   ,TG     ,FVEG   ,ILOC   , JLOC , &amp; <font color=#447700>!in<a name='5814'></font>
                       BDFALL ,FROZEN_CANOPY  ,  &amp; <font color=#447700>!in      <a name='5815'></font>
                       CANLIQ ,CANICE ,TV     ,                 &amp; <font color=#447700>!inout<a name='5816'></font>
                       CMC    ,ECAN   ,ETRAN  , &amp; <font color=#447700>!out<a name='5817'></font>
                       FWET      )                           <font color=#447700>!out<a name='5818'></font>
<a name='5819'>
<font color=#447700>! ------------------------ code history ------------------------------<a name='5820'></font>
<font color=#447700>! canopy hydrology<a name='5821'></font>
<font color=#447700>! --------------------------------------------------------------------<a name='5822'></font>
  IMPLICIT NONE<a name='5823'>
<font color=#447700>! ------------------------ input/output variables --------------------<a name='5824'></font>
<font color=#447700>! input<a name='5825'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='5826'>
  INTEGER,INTENT(IN)  :: ILOC    <font color=#447700>!grid index<a name='5827'></font>
  INTEGER,INTENT(IN)  :: JLOC    <font color=#447700>!grid index<a name='5828'></font>
  INTEGER,INTENT(IN)  :: VEGTYP  <font color=#447700>!vegetation type<a name='5829'></font>
  REAL,   INTENT(IN)  :: DT      <font color=#447700>!main time step (s)<a name='5830'></font>
  REAL,   INTENT(IN)  :: FCEV    <font color=#447700>!canopy evaporation (w/m2) [+ = to atm]<a name='5831'></font>
  REAL,   INTENT(IN)  :: FCTR    <font color=#447700>!transpiration (w/m2) [+ = to atm]<a name='5832'></font>
  REAL,   INTENT(IN)  :: ELAI    <font color=#447700>!leaf area index, after burying by snow<a name='5833'></font>
  REAL,   INTENT(IN)  :: ESAI    <font color=#447700>!stem area index, after burying by snow<a name='5834'></font>
  REAL,   INTENT(IN)  :: TG      <font color=#447700>!ground temperature (k)<a name='5835'></font>
  REAL,   INTENT(IN)  :: FVEG    <font color=#447700>!greeness vegetation fraction (-)<a name='5836'></font>
  LOGICAL                           , INTENT(IN)   :: FROZEN_CANOPY <font color=#447700>! used to define latent heat pathway<a name='5837'></font>
  REAL                           , INTENT(IN)    :: BDFALL   <font color=#447700>!bulk density of snowfall (kg/m3) ! MB/AN: v3.7<a name='5838'></font>
<a name='5839'>
<font color=#447700>! input &amp; output<a name='5840'></font>
  REAL, INTENT(INOUT) :: CANLIQ  <font color=#447700>!intercepted liquid water (mm)<a name='5841'></font>
  REAL, INTENT(INOUT) :: CANICE  <font color=#447700>!intercepted ice mass (mm)<a name='5842'></font>
  REAL, INTENT(INOUT) :: TV      <font color=#447700>!vegetation temperature (k)<a name='5843'></font>
<a name='5844'>
<font color=#447700>! output<a name='5845'></font>
  REAL, INTENT(OUT)   :: CMC     <font color=#447700>!intercepted water (mm)<a name='5846'></font>
  REAL, INTENT(OUT)   :: ECAN    <font color=#447700>!evaporation of intercepted water (mm/s) [+]<a name='5847'></font>
  REAL, INTENT(OUT)   :: ETRAN   <font color=#447700>!transpiration rate (mm/s) [+]<a name='5848'></font>
  REAL, INTENT(OUT)   :: FWET    <font color=#447700>!wetted or snowed fraction of the canopy (-)<a name='5849'></font>
<font color=#447700>! --------------------------------------------------------------------<a name='5850'></font>
<a name='5851'>
<font color=#447700>! ------------------------ local variables ---------------------------<a name='5852'></font>
  REAL                :: MAXSNO  <font color=#447700>!canopy capacity for snow interception (mm)<a name='5853'></font>
  REAL                :: MAXLIQ  <font color=#447700>!canopy capacity for rain interception (mm)<a name='5854'></font>
  REAL                :: QEVAC   <font color=#447700>!evaporation rate (mm/s)<a name='5855'></font>
  REAL                :: QDEWC   <font color=#447700>!dew rate (mm/s)<a name='5856'></font>
  REAL                :: QFROC   <font color=#447700>!frost rate (mm/s)<a name='5857'></font>
  REAL                :: QSUBC   <font color=#447700>!sublimation rate (mm/s)<a name='5858'></font>
  REAL                :: QMELTC  <font color=#447700>!melting rate of canopy snow (mm/s)<a name='5859'></font>
  REAL                :: QFRZC   <font color=#447700>!refreezing rate of canopy liquid water (mm/s)<a name='5860'></font>
  REAL                :: CANMAS  <font color=#447700>!total canopy mass (kg/m2)<a name='5861'></font>
<font color=#447700>! --------------------------------------------------------------------<a name='5862'></font>
<font color=#447700>! initialization<a name='5863'></font>
<a name='5864'>
      ECAN    = 0.0<a name='5865'>
<a name='5866'>
<font color=#447700>! --------------------------- liquid water ------------------------------<a name='5867'></font>
<font color=#447700>! maximum canopy water<a name='5868'></font>
<a name='5869'>
      MAXLIQ =  parameters%CH2OP * (ELAI+ ESAI)<a name='5870'>
<a name='5871'>
<font color=#447700>! evaporation, transpiration, and dew<a name='5872'></font>
<a name='5873'>
      IF (.NOT.FROZEN_CANOPY) THEN             <font color=#447700>! Barlage: change to frozen_canopy<a name='5874'></font>
        ETRAN = MAX( FCTR/HVAP, 0. )<a name='5875'>
        QEVAC = MAX( FCEV/HVAP, 0. )<a name='5876'>
        QDEWC = ABS( MIN( FCEV/HVAP, 0. ) )<a name='5877'>
        QSUBC = 0.<a name='5878'>
        QFROC = 0.<a name='5879'>
      ELSE<a name='5880'>
        ETRAN = MAX( FCTR/HSUB, 0. )<a name='5881'>
        QEVAC = 0.<a name='5882'>
        QDEWC = 0.<a name='5883'>
        QSUBC = MAX( FCEV/HSUB, 0. )<a name='5884'>
        QFROC = ABS( MIN( FCEV/HSUB, 0. ) )<a name='5885'>
      ENDIF<a name='5886'>
<a name='5887'>
<font color=#447700>! canopy water balance. for convenience allow dew to bring CANLIQ above<a name='5888'></font>
<font color=#447700>! maxh2o or else would have to re-adjust drip<a name='5889'></font>
<a name='5890'>
       QEVAC = MIN(CANLIQ/DT,QEVAC)<a name='5891'>
       CANLIQ=MAX(0.,CANLIQ+(QDEWC-QEVAC)*DT)<a name='5892'>
       IF(CANLIQ &lt;= 1.E-06) CANLIQ = 0.0<a name='5893'>
<a name='5894'>
<font color=#447700>! --------------------------- canopy ice ------------------------------<a name='5895'></font>
<font color=#447700>! for canopy ice<a name='5896'></font>
<a name='5897'>
      MAXSNO = 6.6*(0.27+46./BDFALL) * (ELAI+ ESAI)<a name='5898'>
<a name='5899'>
      QSUBC = MIN(CANICE/DT,QSUBC) <a name='5900'>
      CANICE= MAX(0.,CANICE + (QFROC-QSUBC)*DT)<a name='5901'>
      IF(CANICE.LE.1.E-6) CANICE = 0.<a name='5902'>
     <a name='5903'>
<font color=#447700>! wetted fraction of canopy<a name='5904'></font>
<a name='5905'>
      IF(CANICE.GT.0.) THEN<a name='5906'>
           FWET = MAX(0.,CANICE) / MAX(MAXSNO,1.E-06)<a name='5907'>
      ELSE<a name='5908'>
           FWET = MAX(0.,CANLIQ) / MAX(MAXLIQ,1.E-06)<a name='5909'>
      ENDIF<a name='5910'>
      FWET = MIN(FWET, 1.) ** 0.667<a name='5911'>
<a name='5912'>
<font color=#447700>! phase change<a name='5913'></font>
<a name='5914'>
      QMELTC = 0.<a name='5915'>
      QFRZC = 0.<a name='5916'>
<a name='5917'>
      IF(CANICE.GT.1.E-6.AND.TV.GT.TFRZ) THEN<a name='5918'>
         QMELTC = MIN(CANICE/DT,(TV-TFRZ)*CICE*CANICE/DENICE/(DT*HFUS))<a name='5919'>
         CANICE = MAX(0.,CANICE - QMELTC*DT)<a name='5920'>
         CANLIQ = MAX(0.,CANLIQ + QMELTC*DT)<a name='5921'>
         TV     = FWET*TFRZ + (1.-FWET)*TV<a name='5922'>
      ENDIF<a name='5923'>
<a name='5924'>
      IF(CANLIQ.GT.1.E-6.AND.TV.LT.TFRZ) THEN<a name='5925'>
         QFRZC  = MIN(CANLIQ/DT,(TFRZ-TV)*CWAT*CANLIQ/DENH2O/(DT*HFUS))<a name='5926'>
         CANLIQ = MAX(0.,CANLIQ - QFRZC*DT)<a name='5927'>
         CANICE = MAX(0.,CANICE + QFRZC*DT)<a name='5928'>
         TV     = FWET*TFRZ + (1.-FWET)*TV<a name='5929'>
      ENDIF<a name='5930'>
<a name='5931'>
<font color=#447700>! total canopy water<a name='5932'></font>
<a name='5933'>
      CMC = CANLIQ + CANICE<a name='5934'>
<a name='5935'>
<font color=#447700>! total canopy evaporation<a name='5936'></font>
<a name='5937'>
      ECAN = QEVAC + QSUBC - QDEWC - QFROC<a name='5938'>
<a name='5939'>
  END SUBROUTINE CANWATER<a name='5940'>
<a name='5941'>
<font color=#447700>!== begin snowwater ================================================================================<a name='5942'></font>
<a name='5943'>
<A NAME='SNOWWATER'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWWATER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5944'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWWATER</font> (parameters,NSNOW  ,NSOIL  ,IMELT  ,DT     ,ZSOIL  , &amp; <font color=#447700>!in <A href='../../call_to/SNOWWATER.html' TARGET='index'>3</A>,<A href='../../call_from/SNOWWATER.html' TARGET='index'>9</A><a name='5945'></font>
                        SFCTMP ,SNOWHIN,QSNOW  ,QSNFRO ,QSNSUB , &amp; <font color=#447700>!in<a name='5946'></font>
                        QRAIN  ,FICEOLD,ILOC   ,JLOC   ,         &amp; <font color=#447700>!in<a name='5947'></font>
                        ISNOW  ,SNOWH  ,SNEQV  ,SNICE  ,SNLIQ  , &amp; <font color=#447700>!inout<a name='5948'></font>
                        SH2O   ,SICE   ,STC    ,ZSNSO  ,DZSNSO , &amp; <font color=#447700>!inout<a name='5949'></font>
                        QSNBOT ,SNOFLOW,PONDING1       ,PONDING2)  <font color=#447700>!out<a name='5950'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5951'></font>
  IMPLICIT NONE<a name='5952'>
<font color=#447700>! ----------------------------------------------------------------------<a name='5953'></font>
<font color=#447700>! input<a name='5954'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='5955'>
  INTEGER,                         INTENT(IN)    :: ILOC   <font color=#447700>!grid index<a name='5956'></font>
  INTEGER,                         INTENT(IN)    :: JLOC   <font color=#447700>!grid index<a name='5957'></font>
  INTEGER,                         INTENT(IN)    :: NSNOW  <font color=#447700>!maximum no. of snow layers<a name='5958'></font>
  INTEGER,                         INTENT(IN)    :: NSOIL  <font color=#447700>!no. of soil layers<a name='5959'></font>
  INTEGER, DIMENSION(-NSNOW+1:0) , INTENT(IN)    :: IMELT  <font color=#447700>!melting state index [0-no melt;1-melt]<a name='5960'></font>
  REAL,                            INTENT(IN)    :: DT     <font color=#447700>!time step (s)<a name='5961'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN)    :: ZSOIL  <font color=#447700>!depth of layer-bottom from soil surface<a name='5962'></font>
  REAL,                            INTENT(IN)    :: SFCTMP <font color=#447700>!surface air temperature [k]<a name='5963'></font>
  REAL,                            INTENT(IN)    :: SNOWHIN<font color=#447700>!snow depth increasing rate (m/s)<a name='5964'></font>
  REAL,                            INTENT(IN)    :: QSNOW  <font color=#447700>!snow at ground srf (mm/s) [+]<a name='5965'></font>
  REAL,                            INTENT(IN)    :: QSNFRO <font color=#447700>!snow surface frost rate[mm/s]<a name='5966'></font>
  REAL,                            INTENT(IN)    :: QSNSUB <font color=#447700>!snow surface sublimation rate[mm/s]<a name='5967'></font>
  REAL,                            INTENT(IN)    :: QRAIN  <font color=#447700>!snow surface rain rate[mm/s]<a name='5968'></font>
  REAL, DIMENSION(-NSNOW+1:0)    , INTENT(IN)    :: FICEOLD<font color=#447700>!ice fraction at last timestep<a name='5969'></font>
<a name='5970'>
<font color=#447700>! input &amp; output<a name='5971'></font>
  INTEGER,                         INTENT(INOUT) :: ISNOW  <font color=#447700>!actual no. of snow layers<a name='5972'></font>
  REAL,                            INTENT(INOUT) :: SNOWH  <font color=#447700>!snow height [m]<a name='5973'></font>
  REAL,                            INTENT(INOUT) :: SNEQV  <font color=#447700>!snow water eqv. [mm]<a name='5974'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNICE  <font color=#447700>!snow layer ice [mm]<a name='5975'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNLIQ  <font color=#447700>!snow layer liquid water [mm]<a name='5976'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SH2O   <font color=#447700>!soil liquid moisture (m3/m3)<a name='5977'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SICE   <font color=#447700>!soil ice moisture (m3/m3)<a name='5978'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC    <font color=#447700>!snow layer temperature [k]<a name='5979'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: ZSNSO  <font color=#447700>!depth of snow/soil layer-bottom<a name='5980'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: DZSNSO <font color=#447700>!snow/soil layer thickness [m]<a name='5981'></font>
<a name='5982'>
<font color=#447700>! output<a name='5983'></font>
  REAL,                              INTENT(OUT) :: QSNBOT <font color=#447700>!melting water out of snow bottom [mm/s]<a name='5984'></font>
  REAL,                              INTENT(OUT) :: SNOFLOW<font color=#447700>!glacier flow [mm]<a name='5985'></font>
  REAL,                              INTENT(OUT) :: PONDING1<a name='5986'>
  REAL,                              INTENT(OUT) :: PONDING2<a name='5987'>
<a name='5988'>
<font color=#447700>! local<a name='5989'></font>
  INTEGER :: IZ,i<a name='5990'>
  REAL    :: BDSNOW  <font color=#447700>!bulk density of snow (kg/m3)<a name='5991'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='5992'></font>
   SNOFLOW = 0.0<a name='5993'>
   PONDING1 = 0.0<a name='5994'>
   PONDING2 = 0.0<a name='5995'>
<a name='5996'>
   CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWFALL'>SNOWFALL</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWWATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWFALL_1"> (parameters,NSOIL  ,NSNOW  ,DT     ,QSNOW  ,SNOWHIN, &amp; <font color=#447700>!in<a name='5997'></font>
                  SFCTMP ,ILOC   ,JLOC   ,                 &amp; <font color=#447700>!in<a name='5998'></font>
                  ISNOW  ,SNOWH  ,DZSNSO ,STC    ,SNICE  , &amp; <font color=#447700>!inout<a name='5999'></font>
                  SNLIQ  ,SNEQV  )                           <font color=#447700>!inout<a name='6000'></font>
<a name='6001'>
<font color=#447700>! MB: do each if block separately<a name='6002'></font>
<a name='6003'>
   IF(ISNOW &lt; 0) &amp;        <font color=#447700>! when multi-layer<a name='6004'></font>
   CALL  <A href='../../html_code/phys/module_sf_ssib.F.html#COMPACT'>COMPACT</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWWATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPACT_1"> (parameters,NSNOW  ,NSOIL  ,DT     ,STC    ,SNICE  , &amp; <font color=#447700>!in<a name='6005'></font>
                  SNLIQ  ,ZSOIL  ,IMELT  ,FICEOLD,ILOC   , JLOC ,&amp; <font color=#447700>!in<a name='6006'></font>
                  ISNOW  ,DZSNSO ,ZSNSO  )                   <font color=#447700>!inout<a name='6007'></font>
<a name='6008'>
   IF(ISNOW &lt; 0) &amp;        <font color=#447700>!when multi-layer<a name='6009'></font>
   CALL  <A href='../../html_code/phys/module_sf_noahmplsm.F.html#COMBINE'>COMBINE</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWWATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMBINE_1"> (parameters,NSNOW  ,NSOIL  ,ILOC   ,JLOC   ,         &amp; <font color=#447700>!in<a name='6010'></font>
                  ISNOW  ,SH2O   ,STC    ,SNICE  ,SNLIQ  , &amp; <font color=#447700>!inout<a name='6011'></font>
                  DZSNSO ,SICE   ,SNOWH  ,SNEQV  ,         &amp; <font color=#447700>!inout<a name='6012'></font>
                  PONDING1       ,PONDING2)                  <font color=#447700>!out<a name='6013'></font>
<a name='6014'>
   IF(ISNOW &lt; 0) &amp;        <font color=#447700>!when multi-layer<a name='6015'></font>
   CALL   <A href='../../html_code/phys/module_sf_noahmplsm.F.html#DIVIDE'>DIVIDE</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWWATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIVIDE_1"> (parameters,NSNOW  ,NSOIL  ,                         &amp; <font color=#447700>!in<a name='6016'></font>
                  ISNOW  ,STC    ,SNICE  ,SNLIQ  ,DZSNSO )   <font color=#447700>!inout<a name='6017'></font>
<a name='6018'>
   CALL  <A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWH2O'>SNOWH2O</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWWATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWH2O_1"> (parameters,NSNOW  ,NSOIL  ,DT     ,QSNFRO ,QSNSUB , &amp; <font color=#447700>!in <a name='6019'></font>
                  QRAIN  ,ILOC   ,JLOC   ,                 &amp; <font color=#447700>!in<a name='6020'></font>
                  ISNOW  ,DZSNSO ,SNOWH  ,SNEQV  ,SNICE  , &amp; <font color=#447700>!inout<a name='6021'></font>
                  SNLIQ  ,SH2O   ,SICE   ,STC    ,         &amp; <font color=#447700>!inout<a name='6022'></font>
                  QSNBOT ,PONDING1       ,PONDING2)           <font color=#447700>!out<a name='6023'></font>
<a name='6024'>
<font color=#447700>!set empty snow layers to zero<a name='6025'></font>
<a name='6026'>
   do iz = -nsnow+1, isnow<a name='6027'>
        snice(iz) = 0.<a name='6028'>
        snliq(iz) = 0.<a name='6029'>
        stc(iz)   = 0.<a name='6030'>
        dzsnso(iz)= 0.<a name='6031'>
        zsnso(iz) = 0.<a name='6032'>
   enddo<a name='6033'>
<a name='6034'>
<font color=#447700>!to obtain equilibrium state of snow in glacier region<a name='6035'></font>
       <a name='6036'>
   IF(SNEQV &gt; 2000.) THEN   <font color=#447700>! 2000 mm -&gt; maximum water depth<a name='6037'></font>
      BDSNOW      = SNICE(0) / DZSNSO(0)<a name='6038'>
      SNOFLOW     = (SNEQV - 2000.)<a name='6039'>
      SNICE(0)    = SNICE(0)  - SNOFLOW <a name='6040'>
      DZSNSO(0)   = DZSNSO(0) - SNOFLOW/BDSNOW<a name='6041'>
      SNOFLOW     = SNOFLOW / DT<a name='6042'>
   END IF<a name='6043'>
<a name='6044'>
<font color=#447700>! sum up snow mass for layered snow<a name='6045'></font>
<a name='6046'>
   IF(ISNOW &lt; 0) THEN  <font color=#447700>! MB: only do for multi-layer<a name='6047'></font>
       SNEQV = 0.<a name='6048'>
       DO IZ = ISNOW+1,0<a name='6049'>
             SNEQV = SNEQV + SNICE(IZ) + SNLIQ(IZ)<a name='6050'>
       ENDDO<a name='6051'>
   END IF<a name='6052'>
<a name='6053'>
<font color=#447700>! Reset ZSNSO and layer thinkness DZSNSO<a name='6054'></font>
<a name='6055'>
   DO IZ = ISNOW+1, 0<a name='6056'>
        DZSNSO(IZ) = -DZSNSO(IZ)<a name='6057'>
   END DO<a name='6058'>
<a name='6059'>
   DZSNSO(1) = ZSOIL(1)<a name='6060'>
   DO IZ = 2,NSOIL<a name='6061'>
        DZSNSO(IZ) = (ZSOIL(IZ) - ZSOIL(IZ-1))<a name='6062'>
   END DO<a name='6063'>
<a name='6064'>
   ZSNSO(ISNOW+1) = DZSNSO(ISNOW+1)<a name='6065'>
   DO IZ = ISNOW+2 ,NSOIL<a name='6066'>
       ZSNSO(IZ) = ZSNSO(IZ-1) + DZSNSO(IZ)<a name='6067'>
   ENDDO<a name='6068'>
<a name='6069'>
   DO IZ = ISNOW+1 ,NSOIL<a name='6070'>
       DZSNSO(IZ) = -DZSNSO(IZ)<a name='6071'>
   END DO<a name='6072'>
<a name='6073'>
  END SUBROUTINE SNOWWATER<a name='6074'>
<a name='6075'>
<font color=#447700>!== begin snowfall =================================================================================<a name='6076'></font>
<a name='6077'>
<A NAME='SNOWFALL'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWFALL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6078'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWFALL</font> (parameters,NSOIL  ,NSNOW  ,DT     ,QSNOW  ,SNOWHIN , &amp; <font color=#447700>!in <A href='../../call_to/SNOWFALL.html' TARGET='index'>1</A><a name='6079'></font>
                       SFCTMP ,ILOC   ,JLOC   ,                  &amp; <font color=#447700>!in<a name='6080'></font>
                       ISNOW  ,SNOWH  ,DZSNSO ,STC    ,SNICE   , &amp; <font color=#447700>!inout<a name='6081'></font>
                       SNLIQ  ,SNEQV  )                            <font color=#447700>!inout<a name='6082'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='6083'></font>
<font color=#447700>! snow depth and density to account for the new snowfall.<a name='6084'></font>
<font color=#447700>! new values of snow depth &amp; density returned.<a name='6085'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='6086'></font>
    IMPLICIT NONE<a name='6087'>
<font color=#447700>! ----------------------------------------------------------------------<a name='6088'></font>
<font color=#447700>! input<a name='6089'></font>
<a name='6090'>
  type (noahmp_parameters), intent(in) :: parameters<a name='6091'>
  INTEGER,                            INTENT(IN) :: ILOC   <font color=#447700>!grid index<a name='6092'></font>
  INTEGER,                            INTENT(IN) :: JLOC   <font color=#447700>!grid index<a name='6093'></font>
  INTEGER,                            INTENT(IN) :: NSOIL  <font color=#447700>!no. of soil layers<a name='6094'></font>
  INTEGER,                            INTENT(IN) :: NSNOW  <font color=#447700>!maximum no. of snow layers<a name='6095'></font>
  REAL,                               INTENT(IN) :: DT     <font color=#447700>!main time step (s)<a name='6096'></font>
  REAL,                               INTENT(IN) :: QSNOW  <font color=#447700>!snow at ground srf (mm/s) [+]<a name='6097'></font>
  REAL,                               INTENT(IN) :: SNOWHIN<font color=#447700>!snow depth increasing rate (m/s)<a name='6098'></font>
  REAL,                               INTENT(IN) :: SFCTMP <font color=#447700>!surface air temperature [k]<a name='6099'></font>
<a name='6100'>
<font color=#447700>! input and output<a name='6101'></font>
<a name='6102'>
  INTEGER,                         INTENT(INOUT) :: ISNOW  <font color=#447700>!actual no. of snow layers<a name='6103'></font>
  REAL,                            INTENT(INOUT) :: SNOWH  <font color=#447700>!snow depth [m]<a name='6104'></font>
  REAL,                            INTENT(INOUT) :: SNEQV  <font color=#447700>!swow water equivalent [m]<a name='6105'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: DZSNSO <font color=#447700>!thickness of snow/soil layers (m)<a name='6106'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC    <font color=#447700>!snow layer temperature [k]<a name='6107'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNICE  <font color=#447700>!snow layer ice [mm]<a name='6108'></font>
  REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNLIQ  <font color=#447700>!snow layer liquid water [mm]<a name='6109'></font>
<a name='6110'>
<font color=#447700>! local<a name='6111'></font>
<a name='6112'>
  INTEGER :: NEWNODE            <font color=#447700>! 0-no new layers, 1-creating new layers<a name='6113'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='6114'></font>
    NEWNODE  = 0<a name='6115'>
<a name='6116'>
<font color=#447700>! shallow snow / no layer<a name='6117'></font>
<a name='6118'>
    IF(ISNOW == 0 .and. QSNOW &gt; 0.)  THEN<a name='6119'>
      SNOWH = SNOWH + SNOWHIN * DT<a name='6120'>
      SNEQV = SNEQV + QSNOW * DT<a name='6121'>
    END IF<a name='6122'>
<a name='6123'>
<font color=#447700>! creating a new layer<a name='6124'></font>
 <a name='6125'>
    IF(ISNOW == 0  .AND. QSNOW&gt;0. .AND. SNOWH &gt;= 0.025) THEN <font color=#447700>!MB: change limit<a name='6126'></font>
<font color=#447700>!    IF(ISNOW == 0  .AND. QSNOW&gt;0. .AND. SNOWH &gt;= 0.05) THEN<a name='6127'></font>
      ISNOW    = -1<a name='6128'>
      NEWNODE  =  1<a name='6129'>
      DZSNSO(0)= SNOWH<a name='6130'>
      SNOWH    = 0.<a name='6131'>
      STC(0)   = MIN(273.16, SFCTMP)   <font color=#447700>! temporary setup<a name='6132'></font>
      SNICE(0) = SNEQV<a name='6133'>
      SNLIQ(0) = 0.<a name='6134'>
    END IF<a name='6135'>
<a name='6136'>
<font color=#447700>! snow with layers<a name='6137'></font>
<a name='6138'>
    IF(ISNOW &lt;  0 .AND. NEWNODE == 0 .AND. QSNOW &gt; 0.) then<a name='6139'>
         SNICE(ISNOW+1)  = SNICE(ISNOW+1)   + QSNOW   * DT<a name='6140'>
         DZSNSO(ISNOW+1) = DZSNSO(ISNOW+1)  + SNOWHIN * DT<a name='6141'>
    ENDIF<a name='6142'>
<a name='6143'>
<font color=#447700>! ----------------------------------------------------------------------<a name='6144'></font>
  END SUBROUTINE SNOWFALL<a name='6145'>
<a name='6146'>
<font color=#447700>!== begin combine ==================================================================================<a name='6147'></font>
<a name='6148'>
<A NAME='COMBINE'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#COMBINE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6149'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>COMBINE</font> (parameters,NSNOW  ,NSOIL  ,ILOC   ,JLOC   ,         &amp; <font color=#447700>!in <A href='../../call_to/COMBINE.html' TARGET='index'>2</A>,<A href='../../call_from/COMBINE.html' TARGET='index'>1</A><a name='6150'></font>
                      ISNOW  ,SH2O   ,STC    ,SNICE  ,SNLIQ  , &amp; <font color=#447700>!inout<a name='6151'></font>
                      DZSNSO ,SICE   ,SNOWH  ,SNEQV  ,         &amp; <font color=#447700>!inout<a name='6152'></font>
                      PONDING1       ,PONDING2)                  <font color=#447700>!out<a name='6153'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='6154'></font>
    IMPLICIT NONE<a name='6155'>
<font color=#447700>! ----------------------------------------------------------------------<a name='6156'></font>
<font color=#447700>! input<a name='6157'></font>
<a name='6158'>
  type (noahmp_parameters), intent(in) :: parameters<a name='6159'>
    INTEGER, INTENT(IN)     :: ILOC<a name='6160'>
    INTEGER, INTENT(IN)     :: JLOC<a name='6161'>
    INTEGER, INTENT(IN)     :: NSNOW                        <font color=#447700>!maximum no. of snow layers<a name='6162'></font>
    INTEGER, INTENT(IN)     :: NSOIL                        <font color=#447700>!no. of soil layers<a name='6163'></font>
<a name='6164'>
<font color=#447700>! input and output<a name='6165'></font>
<a name='6166'>
    INTEGER,                         INTENT(INOUT) :: ISNOW <font color=#447700>!actual no. of snow layers<a name='6167'></font>
    REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SH2O  <font color=#447700>!soil liquid moisture (m3/m3)<a name='6168'></font>
    REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SICE  <font color=#447700>!soil ice moisture (m3/m3)<a name='6169'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC   <font color=#447700>!snow layer temperature [k]<a name='6170'></font>
    REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNICE <font color=#447700>!snow layer ice [mm]<a name='6171'></font>
    REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNLIQ <font color=#447700>!snow layer liquid water [mm]<a name='6172'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: DZSNSO<font color=#447700>!snow layer depth [m]<a name='6173'></font>
    REAL,                            INTENT(INOUT) :: sneqv <font color=#447700>!snow water equivalent [m]<a name='6174'></font>
    REAL,                            INTENT(INOUT) :: snowh <font color=#447700>!snow depth [m]<a name='6175'></font>
    REAL,                            INTENT(OUT) :: PONDING1<a name='6176'>
    REAL,                            INTENT(OUT) :: PONDING2<a name='6177'>
<a name='6178'>
<font color=#447700>! local variables:<a name='6179'></font>
<a name='6180'>
    INTEGER :: I,J,K,L               <font color=#447700>! node indices<a name='6181'></font>
    INTEGER :: ISNOW_OLD             <font color=#447700>! number of top snow layer<a name='6182'></font>
    INTEGER :: MSSI                  <font color=#447700>! node index<a name='6183'></font>
    INTEGER :: NEIBOR                <font color=#447700>! adjacent node selected for combination<a name='6184'></font>
    REAL    :: ZWICE                 <font color=#447700>! total ice mass in snow<a name='6185'></font>
    REAL    :: ZWLIQ                 <font color=#447700>! total liquid water in snow<a name='6186'></font>
<a name='6187'>
    REAL    :: DZMIN(3)              <font color=#447700>! minimum of top snow layer<a name='6188'></font>
<font color=#447700>!    DATA DZMIN /0.045, 0.05, 0.2/<a name='6189'></font>
    DATA DZMIN /0.025, 0.025, 0.1/  <font color=#447700>! MB: change limit<a name='6190'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6191'></font>
<a name='6192'>
       ISNOW_OLD = ISNOW<a name='6193'>
<a name='6194'>
       DO J = ISNOW_OLD+1,0<a name='6195'>
          IF (SNICE(J) &lt;= .1) THEN<a name='6196'>
             IF(J /= 0) THEN<a name='6197'>
                SNLIQ(J+1) = SNLIQ(J+1) + SNLIQ(J)<a name='6198'>
                SNICE(J+1) = SNICE(J+1) + SNICE(J)<a name='6199'>
             ELSE<a name='6200'>
               IF (ISNOW_OLD &lt; -1) THEN    <font color=#447700>! MB/KM: change to ISNOW<a name='6201'></font>
                SNLIQ(J-1) = SNLIQ(J-1) + SNLIQ(J)<a name='6202'>
                SNICE(J-1) = SNICE(J-1) + SNICE(J)<a name='6203'>
               ELSE<a name='6204'>
	         IF(SNICE(J) &gt;= 0.) THEN<a name='6205'>
                  PONDING1 = SNLIQ(J)    <font color=#447700>! ISNOW WILL GET SET TO ZERO BELOW; PONDING1 WILL GET <a name='6206'></font>
                  SNEQV = SNICE(J)       <font color=#447700>! ADDED TO PONDING FROM PHASECHANGE PONDING SHOULD BE<a name='6207'></font>
                  SNOWH = DZSNSO(J)      <font color=#447700>! ZERO HERE BECAUSE IT WAS CALCULATED FOR THIN SNOW<a name='6208'></font>
		 ELSE   <font color=#447700>! SNICE OVER-SUBLIMATED EARLIER<a name='6209'></font>
		  PONDING1 = SNLIQ(J) + SNICE(J)<a name='6210'>
		  IF(PONDING1 &lt; 0.) THEN  <font color=#447700>! IF SNICE AND SNLIQ SUBLIMATES REMOVE FROM SOIL<a name='6211'></font>
		   SICE(1) = MAX(0.0,SICE(1)+PONDING1/(DZSNSO(1)*1000.))<a name='6212'>
                   PONDING1 = 0.0<a name='6213'>
		  END IF<a name='6214'>
                  SNEQV = 0.0<a name='6215'>
                  SNOWH = 0.0<a name='6216'>
		 END IF<a name='6217'>
                 SNLIQ(J) = 0.0<a name='6218'>
                 SNICE(J) = 0.0<a name='6219'>
                 DZSNSO(J) = 0.0<a name='6220'>
               ENDIF<a name='6221'>
<font color=#447700>!                SH2O(1) = SH2O(1)+SNLIQ(J)/(DZSNSO(1)*1000.)<a name='6222'></font>
<font color=#447700>!                SICE(1) = SICE(1)+SNICE(J)/(DZSNSO(1)*1000.)<a name='6223'></font>
             ENDIF<a name='6224'>
<a name='6225'>
             <font color=#447700>! shift all elements above this down by one.<a name='6226'></font>
             IF (J &gt; ISNOW+1 .AND. ISNOW &lt; -1) THEN<a name='6227'>
                DO I = J, ISNOW+2, -1<a name='6228'>
                   STC(I)   = STC(I-1)<a name='6229'>
                   SNLIQ(I) = SNLIQ(I-1)<a name='6230'>
                   SNICE(I) = SNICE(I-1)<a name='6231'>
                   DZSNSO(I)= DZSNSO(I-1)<a name='6232'>
                END DO<a name='6233'>
             END IF<a name='6234'>
             ISNOW = ISNOW + 1<a name='6235'>
          END IF<a name='6236'>
       END DO<a name='6237'>
<a name='6238'>
<font color=#447700>! to conserve water in case of too large surface sublimation<a name='6239'></font>
<a name='6240'>
       IF(SICE(1) &lt; 0.) THEN<a name='6241'>
          SH2O(1) = SH2O(1) + SICE(1)<a name='6242'>
          SICE(1) = 0.<a name='6243'>
       END IF<a name='6244'>
<a name='6245'>
       IF(ISNOW ==0) RETURN   <font color=#447700>! MB: get out if no longer multi-layer<a name='6246'></font>
<a name='6247'>
       SNEQV  = 0.<a name='6248'>
       SNOWH  = 0.<a name='6249'>
       ZWICE  = 0.<a name='6250'>
       ZWLIQ  = 0.<a name='6251'>
<a name='6252'>
       DO J = ISNOW+1,0<a name='6253'>
             SNEQV = SNEQV + SNICE(J) + SNLIQ(J)<a name='6254'>
             SNOWH = SNOWH + DZSNSO(J)<a name='6255'>
             ZWICE = ZWICE + SNICE(J)<a name='6256'>
             ZWLIQ = ZWLIQ + SNLIQ(J)<a name='6257'>
       END DO<a name='6258'>
<a name='6259'>
<font color=#447700>! check the snow depth - all snow gone<a name='6260'></font>
<font color=#447700>! the liquid water assumes ponding on soil surface.<a name='6261'></font>
<a name='6262'>
       IF (SNOWH &lt; 0.025 .AND. ISNOW &lt; 0 ) THEN <font color=#447700>! MB: change limit<a name='6263'></font>
<font color=#447700>!       IF (SNOWH &lt; 0.05 .AND. ISNOW &lt; 0 ) THEN<a name='6264'></font>
          ISNOW  = 0<a name='6265'>
          SNEQV = ZWICE<a name='6266'>
          PONDING2 = ZWLIQ           <font color=#447700>! LIMIT OF ISNOW &lt; 0 MEANS INPUT PONDING<a name='6267'></font>
          IF(SNEQV &lt;= 0.) SNOWH = 0. <font color=#447700>! SHOULD BE ZERO; SEE ABOVE<a name='6268'></font>
       END IF<a name='6269'>
<a name='6270'>
<font color=#447700>!       IF (SNOWH &lt; 0.05 ) THEN<a name='6271'></font>
<font color=#447700>!          ISNOW  = 0<a name='6272'></font>
<font color=#447700>!          SNEQV = ZWICE<a name='6273'></font>
<font color=#447700>!          SH2O(1) = SH2O(1) + ZWLIQ / (DZSNSO(1) * 1000.)<a name='6274'></font>
<font color=#447700>!          IF(SNEQV &lt;= 0.) SNOWH = 0.<a name='6275'></font>
<font color=#447700>!       END IF<a name='6276'></font>
<a name='6277'>
<font color=#447700>! check the snow depth - snow layers combined<a name='6278'></font>
<a name='6279'>
       IF (ISNOW &lt; -1) THEN<a name='6280'>
<a name='6281'>
          ISNOW_OLD = ISNOW<a name='6282'>
          MSSI     = 1<a name='6283'>
<a name='6284'>
          DO I = ISNOW_OLD+1,0<a name='6285'>
             IF (DZSNSO(I) &lt; DZMIN(MSSI)) THEN<a name='6286'>
<a name='6287'>
                IF (I == ISNOW+1) THEN<a name='6288'>
                   NEIBOR = I + 1<a name='6289'>
                ELSE IF (I == 0) THEN<a name='6290'>
                   NEIBOR = I - 1<a name='6291'>
                ELSE<a name='6292'>
                   NEIBOR = I + 1<a name='6293'>
                   IF ((DZSNSO(I-1)+DZSNSO(I)) &lt; (DZSNSO(I+1)+DZSNSO(I))) NEIBOR = I-1<a name='6294'>
                END IF<a name='6295'>
<a name='6296'>
                <font color=#447700>! Node l and j are combined and stored as node j.<a name='6297'></font>
                IF (NEIBOR &gt; I) THEN<a name='6298'>
                   J = NEIBOR<a name='6299'>
                   L = I<a name='6300'>
                ELSE<a name='6301'>
                   J = I<a name='6302'>
                   L = NEIBOR<a name='6303'>
                END IF<a name='6304'>
<a name='6305'>
                CALL <A href='../../html_code/phys/module_sf_ssib.F.html#COMBO'>COMBO</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#COMBINE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMBO_11"> (parameters,DZSNSO(J), SNLIQ(J), SNICE(J), &amp;<a name='6306'>
                   STC(J), DZSNSO(L), SNLIQ(L), SNICE(L), STC(L) )<a name='6307'>
<a name='6308'>
                <font color=#447700>! Now shift all elements above this down one.<a name='6309'></font>
                IF (J-1 &gt; ISNOW+1) THEN<a name='6310'>
                   DO K = J-1, ISNOW+2, -1<a name='6311'>
                      STC(K)   = STC(K-1)<a name='6312'>
                      SNICE(K) = SNICE(K-1)<a name='6313'>
                      SNLIQ(K) = SNLIQ(K-1)<a name='6314'>
                      DZSNSO(K) = DZSNSO(K-1)<a name='6315'>
                   END DO<a name='6316'>
                END IF<a name='6317'>
<a name='6318'>
                <font color=#447700>! Decrease the number of snow layers<a name='6319'></font>
                ISNOW = ISNOW + 1<a name='6320'>
                IF (ISNOW &gt;= -1) EXIT<a name='6321'>
             ELSE<a name='6322'>
<a name='6323'>
                <font color=#447700>! The layer thickness is greater than the prescribed minimum value<a name='6324'></font>
                MSSI = MSSI + 1<a name='6325'>
<a name='6326'>
             END IF<a name='6327'>
          END DO<a name='6328'>
<a name='6329'>
       END IF<a name='6330'>
<a name='6331'>
  END SUBROUTINE COMBINE<a name='6332'>
<a name='6333'>
<font color=#447700>!== begin divide ===================================================================================<a name='6334'></font>
<a name='6335'>
<A NAME='DIVIDE'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#DIVIDE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6336'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>DIVIDE</font> (parameters,NSNOW  ,NSOIL  ,                         &amp; <font color=#447700>!in <A href='../../call_to/DIVIDE.html' TARGET='index'>1</A>,<A href='../../call_from/DIVIDE.html' TARGET='index'>2</A><a name='6337'></font>
                     ISNOW  ,STC    ,SNICE  ,SNLIQ  ,DZSNSO  )  <font color=#447700>!inout<a name='6338'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='6339'></font>
    IMPLICIT NONE<a name='6340'>
<font color=#447700>! ----------------------------------------------------------------------<a name='6341'></font>
<font color=#447700>! input<a name='6342'></font>
<a name='6343'>
  type (noahmp_parameters), intent(in) :: parameters<a name='6344'>
    INTEGER, INTENT(IN)                            :: NSNOW <font color=#447700>!maximum no. of snow layers [ =3]<a name='6345'></font>
    INTEGER, INTENT(IN)                            :: NSOIL <font color=#447700>!no. of soil layers [ =4]<a name='6346'></font>
<a name='6347'>
<font color=#447700>! input and output<a name='6348'></font>
<a name='6349'>
    INTEGER                        , INTENT(INOUT) :: ISNOW <font color=#447700>!actual no. of snow layers <a name='6350'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC   <font color=#447700>!snow layer temperature [k]<a name='6351'></font>
    REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNICE <font color=#447700>!snow layer ice [mm]<a name='6352'></font>
    REAL, DIMENSION(-NSNOW+1:    0), INTENT(INOUT) :: SNLIQ <font color=#447700>!snow layer liquid water [mm]<a name='6353'></font>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: DZSNSO<font color=#447700>!snow layer depth [m]<a name='6354'></font>
<a name='6355'>
<font color=#447700>! local variables:<a name='6356'></font>
<a name='6357'>
    INTEGER                                        :: J     <font color=#447700>!indices<a name='6358'></font>
    INTEGER                                        :: MSNO  <font color=#447700>!number of layer (top) to MSNO (bot)<a name='6359'></font>
    REAL                                           :: DRR   <font color=#447700>!thickness of the combined [m]<a name='6360'></font>
    REAL, DIMENSION(       1:NSNOW)                :: DZ    <font color=#447700>!snow layer thickness [m]<a name='6361'></font>
    REAL, DIMENSION(       1:NSNOW)                :: SWICE <font color=#447700>!partial volume of ice [m3/m3]<a name='6362'></font>
    REAL, DIMENSION(       1:NSNOW)                :: SWLIQ <font color=#447700>!partial volume of liquid water [m3/m3]<a name='6363'></font>
    REAL, DIMENSION(       1:NSNOW)                :: TSNO  <font color=#447700>!node temperature [k]<a name='6364'></font>
    REAL                                           :: ZWICE <font color=#447700>!temporary<a name='6365'></font>
    REAL                                           :: ZWLIQ <font color=#447700>!temporary<a name='6366'></font>
    REAL                                           :: PROPOR<font color=#447700>!temporary<a name='6367'></font>
    REAL                                           :: DTDZ  <font color=#447700>!temporary<a name='6368'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='6369'></font>
<a name='6370'>
    DO J = 1,NSNOW<a name='6371'>
          IF (J &lt;= ABS(ISNOW)) THEN<a name='6372'>
             DZ(J)    = DZSNSO(J+ISNOW)<a name='6373'>
             SWICE(J) = SNICE(J+ISNOW)<a name='6374'>
             SWLIQ(J) = SNLIQ(J+ISNOW)<a name='6375'>
             TSNO(J)  = STC(J+ISNOW)<a name='6376'>
          END IF<a name='6377'>
    END DO<a name='6378'>
<a name='6379'>
       MSNO = ABS(ISNOW)<a name='6380'>
<a name='6381'>
       IF (MSNO == 1) THEN<a name='6382'>
          <font color=#447700>! Specify a new snow layer<a name='6383'></font>
          IF (DZ(1) &gt; 0.05) THEN<a name='6384'>
             MSNO = 2<a name='6385'>
             DZ(1)    = DZ(1)/2.<a name='6386'>
             SWICE(1) = SWICE(1)/2.<a name='6387'>
             SWLIQ(1) = SWLIQ(1)/2.<a name='6388'>
             DZ(2)    = DZ(1)<a name='6389'>
             SWICE(2) = SWICE(1)<a name='6390'>
             SWLIQ(2) = SWLIQ(1)<a name='6391'>
             TSNO(2)  = TSNO(1)<a name='6392'>
          END IF<a name='6393'>
       END IF<a name='6394'>
<a name='6395'>
       IF (MSNO &gt; 1) THEN<a name='6396'>
          IF (DZ(1) &gt; 0.05) THEN<a name='6397'>
             DRR      = DZ(1) - 0.05<a name='6398'>
             PROPOR   = DRR/DZ(1)<a name='6399'>
             ZWICE    = PROPOR*SWICE(1)<a name='6400'>
             ZWLIQ    = PROPOR*SWLIQ(1)<a name='6401'>
             PROPOR   = 0.05/DZ(1)<a name='6402'>
             SWICE(1) = PROPOR*SWICE(1)<a name='6403'>
             SWLIQ(1) = PROPOR*SWLIQ(1)<a name='6404'>
             DZ(1)    = 0.05<a name='6405'>
<a name='6406'>
             CALL <A href='../../html_code/phys/module_sf_ssib.F.html#COMBO'>COMBO</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#DIVIDE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMBO_12"> (parameters,DZ(2), SWLIQ(2), SWICE(2), TSNO(2), DRR, &amp;<a name='6407'>
                  ZWLIQ, ZWICE, TSNO(1))<a name='6408'>
<a name='6409'>
             <font color=#447700>! subdivide a new layer<a name='6410'></font>
             IF (MSNO &lt;= 2 .AND. DZ(2) &gt; 0.20) THEN  <font color=#447700>! MB: change limit<a name='6411'></font>
<font color=#447700>!             IF (MSNO &lt;= 2 .AND. DZ(2) &gt; 0.10) THEN<a name='6412'></font>
                MSNO = 3<a name='6413'>
                DTDZ = (TSNO(1) - TSNO(2))/((DZ(1)+DZ(2))/2.)<a name='6414'>
                DZ(2)    = DZ(2)/2.<a name='6415'>
                SWICE(2) = SWICE(2)/2.<a name='6416'>
                SWLIQ(2) = SWLIQ(2)/2.<a name='6417'>
                DZ(3)    = DZ(2)<a name='6418'>
                SWICE(3) = SWICE(2)<a name='6419'>
                SWLIQ(3) = SWLIQ(2)<a name='6420'>
                TSNO(3) = TSNO(2) - DTDZ*DZ(2)/2.<a name='6421'>
                IF (TSNO(3) &gt;= TFRZ) THEN<a name='6422'>
                   TSNO(3)  = TSNO(2)<a name='6423'>
                ELSE<a name='6424'>
                   TSNO(2) = TSNO(2) + DTDZ*DZ(2)/2.<a name='6425'>
                ENDIF<a name='6426'>
<a name='6427'>
             END IF<a name='6428'>
          END IF<a name='6429'>
       END IF<a name='6430'>
<a name='6431'>
       IF (MSNO &gt; 2) THEN<a name='6432'>
          IF (DZ(2) &gt; 0.2) THEN<a name='6433'>
             DRR = DZ(2) - 0.2<a name='6434'>
             PROPOR   = DRR/DZ(2)<a name='6435'>
             ZWICE    = PROPOR*SWICE(2)<a name='6436'>
             ZWLIQ    = PROPOR*SWLIQ(2)<a name='6437'>
             PROPOR   = 0.2/DZ(2)<a name='6438'>
             SWICE(2) = PROPOR*SWICE(2)<a name='6439'>
             SWLIQ(2) = PROPOR*SWLIQ(2)<a name='6440'>
             DZ(2)    = 0.2<a name='6441'>
             CALL <A href='../../html_code/phys/module_sf_ssib.F.html#COMBO'>COMBO</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#DIVIDE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMBO_13"> (parameters,DZ(3), SWLIQ(3), SWICE(3), TSNO(3), DRR, &amp;<a name='6442'>
                  ZWLIQ, ZWICE, TSNO(2))<a name='6443'>
          END IF<a name='6444'>
       END IF<a name='6445'>
<a name='6446'>
       ISNOW = -MSNO<a name='6447'>
<a name='6448'>
    DO J = ISNOW+1,0<a name='6449'>
             DZSNSO(J) = DZ(J-ISNOW)<a name='6450'>
             SNICE(J) = SWICE(J-ISNOW)<a name='6451'>
             SNLIQ(J) = SWLIQ(J-ISNOW)<a name='6452'>
             STC(J)   = TSNO(J-ISNOW)<a name='6453'>
    END DO<a name='6454'>
<a name='6455'>
<a name='6456'>
<font color=#447700>!    DO J = ISNOW+1,NSOIL<a name='6457'></font>
<font color=#447700>!    WRITE(*,'(I5,7F10.3)') J, DZSNSO(J), SNICE(J), SNLIQ(J),STC(J)<a name='6458'></font>
<font color=#447700>!    END DO<a name='6459'></font>
<a name='6460'>
  END SUBROUTINE DIVIDE<a name='6461'>
<a name='6462'>
<font color=#447700>!== begin combo ====================================================================================<a name='6463'></font>
<a name='6464'>
<A NAME='COMBO'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#COMBO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6465'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>COMBO</font>(parameters,DZ,  WLIQ,  WICE, T, DZ2, WLIQ2, WICE2, T2) <A href='../../call_to/COMBO.html' TARGET='index'>17</A>,<A href='../../call_from/COMBO.html' TARGET='index'>1</A><a name='6466'>
<font color=#447700>! ----------------------------------------------------------------------<a name='6467'></font>
    IMPLICIT NONE<a name='6468'>
<font color=#447700>! ----------------------------------------------------------------------<a name='6469'></font>
<a name='6470'>
<font color=#447700>! ----------------------------------------------------------------------s<a name='6471'></font>
<font color=#447700>! input<a name='6472'></font>
<a name='6473'>
  type (noahmp_parameters), intent(in) :: parameters<a name='6474'>
    REAL, INTENT(IN)    :: DZ2   <font color=#447700>!nodal thickness of 2 elements being combined [m]<a name='6475'></font>
    REAL, INTENT(IN)    :: WLIQ2 <font color=#447700>!liquid water of element 2 [kg/m2]<a name='6476'></font>
    REAL, INTENT(IN)    :: WICE2 <font color=#447700>!ice of element 2 [kg/m2]<a name='6477'></font>
    REAL, INTENT(IN)    :: T2    <font color=#447700>!nodal temperature of element 2 [k]<a name='6478'></font>
    REAL, INTENT(INOUT) :: DZ    <font color=#447700>!nodal thickness of 1 elements being combined [m]<a name='6479'></font>
    REAL, INTENT(INOUT) :: WLIQ  <font color=#447700>!liquid water of element 1<a name='6480'></font>
    REAL, INTENT(INOUT) :: WICE  <font color=#447700>!ice of element 1 [kg/m2]<a name='6481'></font>
    REAL, INTENT(INOUT) :: T     <font color=#447700>!node temperature of element 1 [k]<a name='6482'></font>
<a name='6483'>
<font color=#447700>! local <a name='6484'></font>
<a name='6485'>
    REAL                :: DZC   <font color=#447700>!total thickness of nodes 1 and 2 (DZC=DZ+DZ2).<a name='6486'></font>
    REAL                :: WLIQC <font color=#447700>!combined liquid water [kg/m2]<a name='6487'></font>
    REAL                :: WICEC <font color=#447700>!combined ice [kg/m2]<a name='6488'></font>
    REAL                :: TC    <font color=#447700>!combined node temperature [k]<a name='6489'></font>
    REAL                :: H     <font color=#447700>!enthalpy of element 1 [J/m2]<a name='6490'></font>
    REAL                :: H2    <font color=#447700>!enthalpy of element 2 [J/m2]<a name='6491'></font>
    REAL                :: HC    <font color=#447700>!temporary<a name='6492'></font>
<a name='6493'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6494'></font>
<a name='6495'>
    DZC = DZ+DZ2<a name='6496'>
    WICEC = (WICE+WICE2)<a name='6497'>
    WLIQC = (WLIQ+WLIQ2)<a name='6498'>
    H = (CICE*WICE+CWAT*WLIQ) * (T-TFRZ)+HFUS*WLIQ<a name='6499'>
    H2= (CICE*WICE2+CWAT*WLIQ2) * (T2-TFRZ)+HFUS*WLIQ2<a name='6500'>
<a name='6501'>
    HC = H + H2<a name='6502'>
    IF(HC &lt; 0.)THEN<a name='6503'>
       TC = TFRZ + HC/(CICE*WICEC + CWAT*WLIQC)<a name='6504'>
    ELSE IF (HC.LE.HFUS*WLIQC) THEN<a name='6505'>
       TC = TFRZ<a name='6506'>
    ELSE<a name='6507'>
       TC = TFRZ + (HC - HFUS*WLIQC) / (CICE*WICEC + CWAT*WLIQC)<a name='6508'>
    END IF<a name='6509'>
<a name='6510'>
    DZ = DZC<a name='6511'>
    WICE = WICEC<a name='6512'>
    WLIQ = WLIQC<a name='6513'>
    T = TC<a name='6514'>
<a name='6515'>
  END SUBROUTINE COMBO<a name='6516'>
<a name='6517'>
<font color=#447700>!== begin compact ==================================================================================<a name='6518'></font>
<a name='6519'>
<A NAME='COMPACT'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#COMPACT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6520'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>COMPACT</font> (parameters,NSNOW  ,NSOIL  ,DT     ,STC    ,SNICE  , &amp; <font color=#447700>!in <A href='../../call_to/COMPACT.html' TARGET='index'>2</A><a name='6521'></font>
                      SNLIQ  ,ZSOIL  ,IMELT  ,FICEOLD,ILOC   , JLOC , &amp; <font color=#447700>!in<a name='6522'></font>
                      ISNOW  ,DZSNSO ,ZSNSO )                    <font color=#447700>!inout<a name='6523'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='6524'></font>
  IMPLICIT NONE<a name='6525'>
<font color=#447700>! ----------------------------------------------------------------------<a name='6526'></font>
<font color=#447700>! input<a name='6527'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='6528'>
   INTEGER,                         INTENT(IN)    :: ILOC   <font color=#447700>!grid index<a name='6529'></font>
   INTEGER,                         INTENT(IN)    :: JLOC   <font color=#447700>!grid index<a name='6530'></font>
   INTEGER,                         INTENT(IN)    :: NSOIL  <font color=#447700>!no. of soil layers [ =4]<a name='6531'></font>
   INTEGER,                         INTENT(IN)    :: NSNOW  <font color=#447700>!maximum no. of snow layers [ =3]<a name='6532'></font>
   INTEGER, DIMENSION(-NSNOW+1:0) , INTENT(IN)    :: IMELT  <font color=#447700>!melting state index [0-no melt;1-melt]<a name='6533'></font>
   REAL,                            INTENT(IN)    :: DT     <font color=#447700>!time step (sec)<a name='6534'></font>
   REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN)    :: STC    <font color=#447700>!snow layer temperature [k]<a name='6535'></font>
   REAL, DIMENSION(-NSNOW+1:    0), INTENT(IN)    :: SNICE  <font color=#447700>!snow layer ice [mm]<a name='6536'></font>
   REAL, DIMENSION(-NSNOW+1:    0), INTENT(IN)    :: SNLIQ  <font color=#447700>!snow layer liquid water [mm]<a name='6537'></font>
   REAL, DIMENSION(       1:NSOIL), INTENT(IN)    :: ZSOIL  <font color=#447700>!depth of layer-bottom from soil srf<a name='6538'></font>
   REAL, DIMENSION(-NSNOW+1:    0), INTENT(IN)    :: FICEOLD<font color=#447700>!ice fraction at last timestep<a name='6539'></font>
<a name='6540'>
<font color=#447700>! input and output<a name='6541'></font>
   INTEGER,                         INTENT(INOUT) :: ISNOW  <font color=#447700>! actual no. of snow layers<a name='6542'></font>
   REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: DZSNSO <font color=#447700>! snow layer thickness [m]<a name='6543'></font>
   REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: ZSNSO  <font color=#447700>! depth of snow/soil layer-bottom<a name='6544'></font>
<a name='6545'>
<font color=#447700>! local<a name='6546'></font>
   REAL, PARAMETER     :: C2 = 21.e-3   <font color=#447700>![m3/kg] ! default 21.e-3<a name='6547'></font>
   REAL, PARAMETER     :: C3 = 2.5e-6   <font color=#447700>![1/s]  <a name='6548'></font>
   REAL, PARAMETER     :: C4 = 0.04     <font color=#447700>![1/k]<a name='6549'></font>
   REAL, PARAMETER     :: C5 = 2.0      <font color=#447700>!<a name='6550'></font>
   REAL, PARAMETER     :: DM = 100.0    <font color=#447700>!upper Limit on destructive metamorphism compaction [kg/m3]<a name='6551'></font>
   REAL, PARAMETER     :: ETA0 = 0.8e+6 <font color=#447700>!viscosity coefficient [kg-s/m2] <a name='6552'></font>
                                        <font color=#447700>!according to Anderson, it is between 0.52e6~1.38e6<a name='6553'></font>
   REAL :: BURDEN <font color=#447700>!pressure of overlying snow [kg/m2]<a name='6554'></font>
   REAL :: DDZ1   <font color=#447700>!rate of settling of snow pack due to destructive metamorphism.<a name='6555'></font>
   REAL :: DDZ2   <font color=#447700>!rate of compaction of snow pack due to overburden.<a name='6556'></font>
   REAL :: DDZ3   <font color=#447700>!rate of compaction of snow pack due to melt [1/s]<a name='6557'></font>
   REAL :: DEXPF  <font color=#447700>!EXPF=exp(-c4*(273.15-STC)).<a name='6558'></font>
   REAL :: TD     <font color=#447700>!STC - TFRZ [K]<a name='6559'></font>
   REAL :: PDZDTC <font color=#447700>!nodal rate of change in fractional-thickness due to compaction [fraction/s]<a name='6560'></font>
   REAL :: VOID   <font color=#447700>!void (1 - SNICE - SNLIQ)<a name='6561'></font>
   REAL :: WX     <font color=#447700>!water mass (ice + liquid) [kg/m2]<a name='6562'></font>
   REAL :: BI     <font color=#447700>!partial density of ice [kg/m3]<a name='6563'></font>
   REAL, DIMENSION(-NSNOW+1:0) :: FICE   <font color=#447700>!fraction of ice at current time step<a name='6564'></font>
<a name='6565'>
   INTEGER  :: J<a name='6566'>
<a name='6567'>
<font color=#447700>! ----------------------------------------------------------------------<a name='6568'></font>
    BURDEN = 0.0<a name='6569'>
<a name='6570'>
    DO J = ISNOW+1, 0<a name='6571'>
<a name='6572'>
        WX      = SNICE(J) + SNLIQ(J)<a name='6573'>
        FICE(J) = SNICE(J) / WX<a name='6574'>
        VOID    = 1. - (SNICE(J)/DENICE + SNLIQ(J)/DENH2O) / DZSNSO(J)<a name='6575'>
<a name='6576'>
        <font color=#447700>! Allow compaction only for non-saturated node and higher ice lens node.<a name='6577'></font>
        IF (VOID &gt; 0.001 .AND. SNICE(J) &gt; 0.1) THEN<a name='6578'>
           BI = SNICE(J) / DZSNSO(J)<a name='6579'>
           TD = MAX(0.,TFRZ-STC(J))<a name='6580'>
           DEXPF = EXP(-C4*TD)<a name='6581'>
<a name='6582'>
           <font color=#447700>! Settling as a result of destructive metamorphism<a name='6583'></font>
<a name='6584'>
           DDZ1 = -C3*DEXPF<a name='6585'>
<a name='6586'>
           IF (BI &gt; DM) DDZ1 = DDZ1*EXP(-46.0E-3*(BI-DM))<a name='6587'>
<a name='6588'>
           <font color=#447700>! Liquid water term<a name='6589'></font>
<a name='6590'>
           IF (SNLIQ(J) &gt; 0.01*DZSNSO(J)) DDZ1=DDZ1*C5<a name='6591'>
<a name='6592'>
           <font color=#447700>! Compaction due to overburden<a name='6593'></font>
<a name='6594'>
           DDZ2 = -(BURDEN+0.5*WX)*EXP(-0.08*TD-C2*BI)/ETA0 <font color=#447700>! 0.5*WX -&gt; self-burden<a name='6595'></font>
<a name='6596'>
           <font color=#447700>! Compaction occurring during melt<a name='6597'></font>
<a name='6598'>
           IF (IMELT(J) == 1) THEN<a name='6599'>
              DDZ3 = MAX(0.,(FICEOLD(J) - FICE(J))/MAX(1.E-6,FICEOLD(J)))<a name='6600'>
              DDZ3 = - DDZ3/DT           <font color=#447700>! sometimes too large<a name='6601'></font>
           ELSE<a name='6602'>
              DDZ3 = 0.<a name='6603'>
           END IF<a name='6604'>
<a name='6605'>
           <font color=#447700>! Time rate of fractional change in DZ (units of s-1)<a name='6606'></font>
<a name='6607'>
           PDZDTC = (DDZ1 + DDZ2 + DDZ3)*DT<a name='6608'>
           PDZDTC = MAX(-0.5,PDZDTC)<a name='6609'>
<a name='6610'>
           <font color=#447700>! The change in DZ due to compaction<a name='6611'></font>
<a name='6612'>
           DZSNSO(J) = DZSNSO(J)*(1.+PDZDTC)<a name='6613'>
        END IF<a name='6614'>
<a name='6615'>
        <font color=#447700>! Pressure of overlying snow<a name='6616'></font>
<a name='6617'>
        BURDEN = BURDEN + WX<a name='6618'>
<a name='6619'>
    END DO<a name='6620'>
<a name='6621'>
  END SUBROUTINE COMPACT<a name='6622'>
<a name='6623'>
<font color=#447700>!== begin snowh2o ==================================================================================<a name='6624'></font>
<a name='6625'>
<A NAME='SNOWH2O'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWH2O' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6626'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWH2O</font> (parameters,NSNOW  ,NSOIL  ,DT     ,QSNFRO ,QSNSUB , &amp; <font color=#447700>!in  <A href='../../call_to/SNOWH2O.html' TARGET='index'>1</A>,<A href='../../call_from/SNOWH2O.html' TARGET='index'>1</A><a name='6627'></font>
                      QRAIN  ,ILOC   ,JLOC   ,                 &amp; <font color=#447700>!in<a name='6628'></font>
                      ISNOW  ,DZSNSO ,SNOWH  ,SNEQV  ,SNICE  , &amp; <font color=#447700>!inout<a name='6629'></font>
                      SNLIQ  ,SH2O   ,SICE   ,STC    ,         &amp; <font color=#447700>!inout<a name='6630'></font>
                      QSNBOT ,PONDING1       ,PONDING2)          <font color=#447700>!out<a name='6631'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='6632'></font>
<font color=#447700>! Renew the mass of ice lens (SNICE) and liquid (SNLIQ) of the<a name='6633'></font>
<font color=#447700>! surface snow layer resulting from sublimation (frost) / evaporation (dew)<a name='6634'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='6635'></font>
   IMPLICIT NONE<a name='6636'>
<font color=#447700>! ----------------------------------------------------------------------<a name='6637'></font>
<font color=#447700>! input<a name='6638'></font>
<a name='6639'>
  type (noahmp_parameters), intent(in) :: parameters<a name='6640'>
   INTEGER,                         INTENT(IN)    :: ILOC   <font color=#447700>!grid index<a name='6641'></font>
   INTEGER,                         INTENT(IN)    :: JLOC   <font color=#447700>!grid index<a name='6642'></font>
   INTEGER,                         INTENT(IN)    :: NSNOW  <font color=#447700>!maximum no. of snow layers[=3]<a name='6643'></font>
   INTEGER,                         INTENT(IN)    :: NSOIL  <font color=#447700>!No. of soil layers[=4]<a name='6644'></font>
   REAL,                            INTENT(IN)    :: DT     <font color=#447700>!time step<a name='6645'></font>
   REAL,                            INTENT(IN)    :: QSNFRO <font color=#447700>!snow surface frost rate[mm/s]<a name='6646'></font>
   REAL,                            INTENT(IN)    :: QSNSUB <font color=#447700>!snow surface sublimation rate[mm/s]<a name='6647'></font>
   REAL,                            INTENT(IN)    :: QRAIN  <font color=#447700>!snow surface rain rate[mm/s]<a name='6648'></font>
<a name='6649'>
<font color=#447700>! output<a name='6650'></font>
<a name='6651'>
   REAL,                            INTENT(OUT)   :: QSNBOT <font color=#447700>!melting water out of snow bottom [mm/s]<a name='6652'></font>
<a name='6653'>
<font color=#447700>! input and output<a name='6654'></font>
<a name='6655'>
   INTEGER,                         INTENT(INOUT) :: ISNOW  <font color=#447700>!actual no. of snow layers<a name='6656'></font>
   REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: DZSNSO <font color=#447700>! snow layer depth [m]<a name='6657'></font>
   REAL,                            INTENT(INOUT) :: SNOWH  <font color=#447700>!snow height [m]<a name='6658'></font>
   REAL,                            INTENT(INOUT) :: SNEQV  <font color=#447700>!snow water eqv. [mm]<a name='6659'></font>
   REAL, DIMENSION(-NSNOW+1:0),     INTENT(INOUT) :: SNICE  <font color=#447700>!snow layer ice [mm]<a name='6660'></font>
   REAL, DIMENSION(-NSNOW+1:0),     INTENT(INOUT) :: SNLIQ  <font color=#447700>!snow layer liquid water [mm]<a name='6661'></font>
   REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SH2O   <font color=#447700>!soil liquid moisture (m3/m3)<a name='6662'></font>
   REAL, DIMENSION(       1:NSOIL), INTENT(INOUT) :: SICE   <font color=#447700>!soil ice moisture (m3/m3)<a name='6663'></font>
   REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(INOUT) :: STC    <font color=#447700>!snow layer temperature [k]<a name='6664'></font>
<a name='6665'>
<font color=#447700>! local variables:<a name='6666'></font>
<a name='6667'>
   INTEGER                     :: J         <font color=#447700>!do loop/array indices<a name='6668'></font>
   REAL                        :: QIN       <font color=#447700>!water flow into the element (mm/s)<a name='6669'></font>
   REAL                        :: QOUT      <font color=#447700>!water flow out of the element (mm/s)<a name='6670'></font>
   REAL                        :: WGDIF     <font color=#447700>!ice mass after minus sublimation<a name='6671'></font>
   REAL, DIMENSION(-NSNOW+1:0) :: VOL_LIQ   <font color=#447700>!partial volume of liquid water in layer<a name='6672'></font>
   REAL, DIMENSION(-NSNOW+1:0) :: VOL_ICE   <font color=#447700>!partial volume of ice lens in layer<a name='6673'></font>
   REAL, DIMENSION(-NSNOW+1:0) :: EPORE     <font color=#447700>!effective porosity = porosity - VOL_ICE<a name='6674'></font>
   REAL :: PROPOR, TEMP<a name='6675'>
   REAL :: PONDING1, PONDING2<a name='6676'>
<font color=#447700>! ----------------------------------------------------------------------<a name='6677'></font>
<a name='6678'>
<font color=#447700>!for the case when SNEQV becomes '0' after 'COMBINE'<a name='6679'></font>
<a name='6680'>
   IF(SNEQV == 0.) THEN<a name='6681'>
      SICE(1) =  SICE(1) + (QSNFRO-QSNSUB)*DT/(DZSNSO(1)*1000.)  <font color=#447700>! Barlage: SH2O-&gt;SICE v3.6<a name='6682'></font>
      IF(SICE(1) &lt; 0.) THEN<a name='6683'>
         SH2O(1) = SH2O(1) + SICE(1)<a name='6684'>
         SICE(1) = 0.<a name='6685'>
      END IF<a name='6686'>
   END IF<a name='6687'>
<a name='6688'>
<font color=#447700>! for shallow snow without a layer<a name='6689'></font>
<font color=#447700>! snow surface sublimation may be larger than existing snow mass. To conserve water,<a name='6690'></font>
<font color=#447700>! excessive sublimation is used to reduce soil water. Smaller time steps would tend <a name='6691'></font>
<font color=#447700>! to aviod this problem.<a name='6692'></font>
<a name='6693'>
   IF(ISNOW == 0 .and. SNEQV &gt; 0.) THEN<a name='6694'>
      TEMP   = SNEQV<a name='6695'>
      SNEQV  = SNEQV - QSNSUB*DT + QSNFRO*DT<a name='6696'>
      PROPOR = SNEQV/TEMP<a name='6697'>
      SNOWH  = MAX(0.,PROPOR * SNOWH)<a name='6698'>
<a name='6699'>
      IF(SNEQV &lt; 0.) THEN<a name='6700'>
         SICE(1) = SICE(1) + SNEQV/(DZSNSO(1)*1000.)<a name='6701'>
         SNEQV   = 0.<a name='6702'>
         SNOWH   = 0.<a name='6703'>
      END IF<a name='6704'>
      IF(SICE(1) &lt; 0.) THEN<a name='6705'>
         SH2O(1) = SH2O(1) + SICE(1)<a name='6706'>
         SICE(1) = 0.<a name='6707'>
      END IF<a name='6708'>
   END IF<a name='6709'>
<a name='6710'>
   IF(SNOWH &lt;= 1.E-8 .OR. SNEQV &lt;= 1.E-6) THEN<a name='6711'>
     SNOWH = 0.0<a name='6712'>
     SNEQV = 0.0<a name='6713'>
   END IF<a name='6714'>
<a name='6715'>
<font color=#447700>! for deep snow<a name='6716'></font>
<a name='6717'>
   IF ( ISNOW &lt; 0 ) THEN <font color=#447700>!KWM added this IF statement to prevent out-of-bounds array references<a name='6718'></font>
<a name='6719'>
      WGDIF = SNICE(ISNOW+1) - QSNSUB*DT + QSNFRO*DT<a name='6720'>
      SNICE(ISNOW+1) = WGDIF<a name='6721'>
      IF (WGDIF &lt; 1.e-6 .and. ISNOW &lt;0) THEN<a name='6722'>
         CALL  <A href='../../html_code/phys/module_sf_noahmplsm.F.html#COMBINE'>COMBINE</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SNOWH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMBINE_2"> (parameters,NSNOW  ,NSOIL  ,ILOC, JLOC   , &amp; <font color=#447700>!in<a name='6723'></font>
              ISNOW  ,SH2O   ,STC    ,SNICE  ,SNLIQ  , &amp; <font color=#447700>!inout<a name='6724'></font>
              DZSNSO ,SICE   ,SNOWH  ,SNEQV  ,         &amp; <font color=#447700>!inout<a name='6725'></font>
              PONDING1, PONDING2 )                       <font color=#447700>!out<a name='6726'></font>
      ENDIF<a name='6727'>
      <font color=#447700>!KWM:  Subroutine COMBINE can change ISNOW to make it 0 again?<a name='6728'></font>
      IF ( ISNOW &lt; 0 ) THEN <font color=#447700>!KWM added this IF statement to prevent out-of-bounds array references<a name='6729'></font>
         SNLIQ(ISNOW+1) = SNLIQ(ISNOW+1) + QRAIN * DT<a name='6730'>
         SNLIQ(ISNOW+1) = MAX(0., SNLIQ(ISNOW+1))<a name='6731'>
      ENDIF<a name='6732'>
      <a name='6733'>
   ENDIF <font color=#447700>!KWM  -- Can the ENDIF be moved toward the end of the subroutine (Just set QSNBOT=0)?<a name='6734'></font>
<a name='6735'>
<font color=#447700>! Porosity and partial volume<a name='6736'></font>
<a name='6737'>
   <font color=#447700>!KWM Looks to me like loop index / IF test can be simplified.<a name='6738'></font>
<a name='6739'>
   DO J = -NSNOW+1, 0<a name='6740'>
      IF (J &gt;= ISNOW+1) THEN<a name='6741'>
         VOL_ICE(J)      = MIN(1., SNICE(J)/(DZSNSO(J)*DENICE))<a name='6742'>
         EPORE(J)        = 1. - VOL_ICE(J)<a name='6743'>
         VOL_LIQ(J)      = MIN(EPORE(J),SNLIQ(J)/(DZSNSO(J)*DENH2O))<a name='6744'>
      END IF<a name='6745'>
   END DO<a name='6746'>
<a name='6747'>
   QIN = 0.<a name='6748'>
   QOUT = 0.<a name='6749'>
<a name='6750'>
   <font color=#447700>!KWM Looks to me like loop index / IF test can be simplified.<a name='6751'></font>
<a name='6752'>
   DO J = -NSNOW+1, 0<a name='6753'>
      IF (J &gt;= ISNOW+1) THEN<a name='6754'>
         SNLIQ(J) = SNLIQ(J) + QIN<a name='6755'>
         IF (J &lt;= -1) THEN<a name='6756'>
            IF (EPORE(J) &lt; 0.05 .OR. EPORE(J+1) &lt; 0.05) THEN<a name='6757'>
               QOUT = 0.<a name='6758'>
            ELSE<a name='6759'>
               QOUT = MAX(0.,(VOL_LIQ(J)-parameters%SSI*EPORE(J))*DZSNSO(J))<a name='6760'>
               QOUT = MIN(QOUT,(1.-VOL_ICE(J+1)-VOL_LIQ(J+1))*DZSNSO(J+1))<a name='6761'>
            END IF<a name='6762'>
         ELSE<a name='6763'>
            QOUT = MAX(0.,(VOL_LIQ(J) - parameters%SSI*EPORE(J))*DZSNSO(J))<a name='6764'>
         END IF<a name='6765'>
         QOUT = QOUT*1000.<a name='6766'>
         SNLIQ(J) = SNLIQ(J) - QOUT<a name='6767'>
         QIN = QOUT<a name='6768'>
      END IF<a name='6769'>
   END DO<a name='6770'>
<a name='6771'>
<font color=#447700>! Liquid water from snow bottom to soil<a name='6772'></font>
<a name='6773'>
   QSNBOT = QOUT / DT           <font color=#447700>! mm/s<a name='6774'></font>
<a name='6775'>
  END SUBROUTINE SNOWH2O<a name='6776'>
<a name='6777'>
<font color=#447700>!== begin soilwater ================================================================================<a name='6778'></font>
<a name='6779'>
<A NAME='SOILWATER'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SOILWATER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6780'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOILWATER</font> (parameters,NSOIL  ,NSNOW  ,DT     ,ZSOIL  ,DZSNSO , &amp; <font color=#447700>!in <A href='../../call_to/SOILWATER.html' TARGET='index'>2</A>,<A href='../../call_from/SOILWATER.html' TARGET='index'>13</A><a name='6781'></font>
                        QINSUR ,QSEVA  ,ETRANI ,SICE   ,ILOC   , JLOC, &amp; <font color=#447700>!in<a name='6782'></font>
                        SH2O   ,SMC    ,ZWT    ,VEGTYP ,&amp; <font color=#447700>!inout<a name='6783'></font>
                        SMCWTD, DEEPRECH                       ,&amp; <font color=#447700>!inout<a name='6784'></font>
                        RUNSRF ,QDRAIN ,RUNSUB ,WCND   ,FCRMAX )   <font color=#447700>!out<a name='6785'></font>
<a name='6786'>
<font color=#447700>! ----------------------------------------------------------------------<a name='6787'></font>
<font color=#447700>! calculate surface runoff and soil moisture.<a name='6788'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='6789'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='6790'></font>
  IMPLICIT NONE<a name='6791'>
<font color=#447700>! ----------------------------------------------------------------------<a name='6792'></font>
<font color=#447700>! input<a name='6793'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='6794'>
  INTEGER,                     INTENT(IN) :: ILOC   <font color=#447700>!grid index<a name='6795'></font>
  INTEGER,                     INTENT(IN) :: JLOC   <font color=#447700>!grid index<a name='6796'></font>
  INTEGER,                     INTENT(IN) :: NSOIL  <font color=#447700>!no. of soil layers<a name='6797'></font>
  INTEGER,                     INTENT(IN) :: NSNOW  <font color=#447700>!maximum no. of snow layers<a name='6798'></font>
  REAL,                        INTENT(IN) :: DT     <font color=#447700>!time step (sec)<a name='6799'></font>
  REAL, INTENT(IN)                        :: QINSUR <font color=#447700>!water input on soil surface [mm/s]<a name='6800'></font>
  REAL, INTENT(IN)                        :: QSEVA  <font color=#447700>!evap from soil surface [mm/s]<a name='6801'></font>
  REAL, DIMENSION(1:NSOIL),    INTENT(IN) :: ZSOIL  <font color=#447700>!depth of soil layer-bottom [m]<a name='6802'></font>
  REAL, DIMENSION(1:NSOIL),    INTENT(IN) :: ETRANI <font color=#447700>!evapotranspiration from soil layers [mm/s]<a name='6803'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: DZSNSO <font color=#447700>!snow/soil layer depth [m]<a name='6804'></font>
  REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: SICE   <font color=#447700>!soil ice content [m3/m3]<a name='6805'></font>
<a name='6806'>
  INTEGER,                     INTENT(IN) :: VEGTYP<a name='6807'>
<a name='6808'>
<font color=#447700>! input &amp; output<a name='6809'></font>
  REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: SH2O   <font color=#447700>!soil liquid water content [m3/m3]<a name='6810'></font>
  REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: SMC    <font color=#447700>!total soil water content [m3/m3]<a name='6811'></font>
  REAL, INTENT(INOUT)                     :: ZWT    <font color=#447700>!water table depth [m]<a name='6812'></font>
  REAL,                     INTENT(INOUT) :: SMCWTD <font color=#447700>!soil moisture between bottom of the soil and the water table [m3/m3]<a name='6813'></font>
  REAL                    , INTENT(INOUT) :: DEEPRECH<a name='6814'>
<a name='6815'>
<font color=#447700>! output<a name='6816'></font>
  REAL, INTENT(OUT)                       :: QDRAIN <font color=#447700>!soil-bottom free drainage [mm/s] <a name='6817'></font>
  REAL, INTENT(OUT)                       :: RUNSRF <font color=#447700>!surface runoff [mm/s] <a name='6818'></font>
  REAL, INTENT(OUT)                       :: RUNSUB <font color=#447700>!subsurface runoff [mm/s] <a name='6819'></font>
  REAL, INTENT(OUT)                       :: FCRMAX <font color=#447700>!maximum of FCR (-)<a name='6820'></font>
  REAL, DIMENSION(1:NSOIL), INTENT(OUT)   :: WCND   <font color=#447700>!hydraulic conductivity (m/s)<a name='6821'></font>
<a name='6822'>
<font color=#447700>! local<a name='6823'></font>
  INTEGER                                 :: K,IZ   <font color=#447700>!do-loop index<a name='6824'></font>
  INTEGER                                 :: ITER   <font color=#447700>!iteration index<a name='6825'></font>
  REAl                                    :: DTFINE <font color=#447700>!fine time step (s)<a name='6826'></font>
  REAL, DIMENSION(1:NSOIL)                :: RHSTT  <font color=#447700>!right-hand side term of the matrix<a name='6827'></font>
  REAL, DIMENSION(1:NSOIL)                :: AI     <font color=#447700>!left-hand side term<a name='6828'></font>
  REAL, DIMENSION(1:NSOIL)                :: BI     <font color=#447700>!left-hand side term<a name='6829'></font>
  REAL, DIMENSION(1:NSOIL)                :: CI     <font color=#447700>!left-hand side term<a name='6830'></font>
<a name='6831'>
  REAL                                    :: FFF    <font color=#447700>!runoff decay factor (m-1)<a name='6832'></font>
  REAL                                    :: RSBMX  <font color=#447700>!baseflow coefficient [mm/s]<a name='6833'></font>
  REAL                                    :: PDDUM  <font color=#447700>!infiltration rate at surface (m/s)<a name='6834'></font>
  REAL                                    :: FICE   <font color=#447700>!ice fraction in frozen soil<a name='6835'></font>
  REAL                                    :: WPLUS  <font color=#447700>!saturation excess of the total soil [m]<a name='6836'></font>
  REAL                                    :: RSAT   <font color=#447700>!accumulation of WPLUS (saturation excess) [m]<a name='6837'></font>
  REAL                                    :: SICEMAX<font color=#447700>!maximum soil ice content (m3/m3)<a name='6838'></font>
  REAL                                    :: SH2OMIN<font color=#447700>!minimum soil liquid water content (m3/m3)<a name='6839'></font>
  REAL                                    :: WTSUB  <font color=#447700>!sum of WCND(K)*DZSNSO(K)<a name='6840'></font>
  REAL                                    :: MH2O   <font color=#447700>!water mass removal (mm)<a name='6841'></font>
  REAL                                    :: FSAT   <font color=#447700>!fractional saturated area (-)<a name='6842'></font>
  REAL, DIMENSION(1:NSOIL)                :: MLIQ   <font color=#447700>!<a name='6843'></font>
  REAL                                    :: XS     <font color=#447700>!<a name='6844'></font>
  REAL                                    :: WATMIN <font color=#447700>!<a name='6845'></font>
  REAL                                    :: QDRAIN_SAVE <font color=#447700>!<a name='6846'></font>
  REAL                                    :: RUNSRF_SAVE <font color=#447700>!<a name='6847'></font>
  REAL                                    :: EPORE  <font color=#447700>!effective porosity [m3/m3]<a name='6848'></font>
  REAL, DIMENSION(1:NSOIL)                :: FCR    <font color=#447700>!impermeable fraction due to frozen soil<a name='6849'></font>
  INTEGER                                 :: NITER  <font color=#447700>!iteration times soil moisture (-)<a name='6850'></font>
  REAL                                    :: SMCTOT <font color=#447700>!2-m averaged soil moisture (m3/m3)<a name='6851'></font>
  REAL                                    :: DZTOT  <font color=#447700>!2-m soil depth (m)<a name='6852'></font>
  REAL, PARAMETER :: A = 4.0<a name='6853'>
<font color=#447700>! ----------------------------------------------------------------------<a name='6854'></font>
    RUNSRF = 0.0<a name='6855'>
    PDDUM  = 0.0<a name='6856'>
    RSAT   = 0.0<a name='6857'>
<a name='6858'>
<font color=#447700>! for the case when snowmelt water is too large<a name='6859'></font>
<a name='6860'>
    DO K = 1,NSOIL<a name='6861'>
       EPORE   = MAX ( 1.E-4 , ( parameters%SMCMAX(K) - SICE(K) ) )<a name='6862'>
       RSAT    = RSAT + MAX(0.,SH2O(K)-EPORE)*DZSNSO(K)  <a name='6863'>
       SH2O(K) = MIN(EPORE,SH2O(K))             <a name='6864'>
    END DO<a name='6865'>
<a name='6866'>
<font color=#447700>!impermeable fraction due to frozen soil<a name='6867'></font>
<a name='6868'>
    DO K = 1,NSOIL<a name='6869'>
       FICE    = MIN(1.0,SICE(K)/parameters%SMCMAX(K))<a name='6870'>
       FCR(K)  = MAX(0.0,EXP(-A*(1.-FICE))- EXP(-A)) /  &amp;<a name='6871'>
                        (1.0              - EXP(-A))<a name='6872'>
    END DO<a name='6873'>
<a name='6874'>
<font color=#447700>! maximum soil ice content and minimum liquid water of all layers<a name='6875'></font>
<a name='6876'>
    SICEMAX = 0.0<a name='6877'>
    FCRMAX  = 0.0<a name='6878'>
    SH2OMIN = parameters%SMCMAX(1)<a name='6879'>
    DO K = 1,NSOIL<a name='6880'>
       IF (SICE(K) &gt; SICEMAX) SICEMAX = SICE(K)<a name='6881'>
       IF (FCR(K)  &gt; FCRMAX)  FCRMAX  = FCR(K)<a name='6882'>
       IF (SH2O(K) &lt; SH2OMIN) SH2OMIN = SH2O(K)<a name='6883'>
    END DO<a name='6884'>
<a name='6885'>
<font color=#447700>!subsurface runoff for runoff scheme option 2<a name='6886'></font>
<a name='6887'>
    IF(OPT_RUN == 2) THEN <a name='6888'>
        FFF   = 2.0<a name='6889'>
        RSBMX = 4.0<a name='6890'>
        CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#ZWTEQ'>ZWTEQ</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SOILWATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZWTEQ_1"> (parameters,NSOIL  ,NSNOW  ,ZSOIL  ,DZSNSO ,SH2O   ,ZWT)<a name='6891'>
        RUNSUB = (1.0-FCRMAX) * RSBMX * EXP(-parameters%TIMEAN) * EXP(-FFF*ZWT)   <font color=#447700>! mm/s<a name='6892'></font>
    END IF<a name='6893'>
<a name='6894'>
<font color=#447700>!surface runoff and infiltration rate using different schemes<a name='6895'></font>
<a name='6896'>
<font color=#447700>!jref impermable surface at urban<a name='6897'></font>
    IF ( parameters%urban_flag ) FCR(1)= 0.95<a name='6898'>
<a name='6899'>
    IF(OPT_RUN == 1) THEN<a name='6900'>
       FFF = 6.0<a name='6901'>
       FSAT   = parameters%FSATMX*EXP(-0.5*FFF*(ZWT-2.0))<a name='6902'>
       IF(QINSUR &gt; 0.) THEN<a name='6903'>
         RUNSRF = QINSUR * ( (1.0-FCR(1))*FSAT + FCR(1) )<a name='6904'>
         PDDUM  = QINSUR - RUNSRF                          <font color=#447700>! m/s <a name='6905'></font>
       END IF<a name='6906'>
    END IF<a name='6907'>
<a name='6908'>
    IF(OPT_RUN == 5) THEN<a name='6909'>
       FFF = 6.0<a name='6910'>
       FSAT   = parameters%FSATMX*EXP(-0.5*FFF*MAX(-2.0-ZWT,0.))<a name='6911'>
       IF(QINSUR &gt; 0.) THEN<a name='6912'>
         RUNSRF = QINSUR * ( (1.0-FCR(1))*FSAT + FCR(1) )<a name='6913'>
         PDDUM  = QINSUR - RUNSRF                          <font color=#447700>! m/s<a name='6914'></font>
       END IF<a name='6915'>
    END IF<a name='6916'>
<a name='6917'>
    IF(OPT_RUN == 2) THEN<a name='6918'>
       FFF   = 2.0<a name='6919'>
       FSAT   = parameters%FSATMX*EXP(-0.5*FFF*ZWT)<a name='6920'>
       IF(QINSUR &gt; 0.) THEN<a name='6921'>
         RUNSRF = QINSUR * ( (1.0-FCR(1))*FSAT + FCR(1) )<a name='6922'>
         PDDUM  = QINSUR - RUNSRF                          <font color=#447700>! m/s <a name='6923'></font>
       END IF<a name='6924'>
    END IF<a name='6925'>
<a name='6926'>
    IF(OPT_RUN == 3) THEN<a name='6927'>
       CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#INFIL'>INFIL</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SOILWATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INFIL_1"> (parameters,NSOIL  ,DT     ,ZSOIL  ,SH2O   ,SICE   , &amp; <font color=#447700>!in<a name='6928'></font>
                   SICEMAX,QINSUR ,                         &amp; <font color=#447700>!in<a name='6929'></font>
                   PDDUM  ,RUNSRF )                           <font color=#447700>!out<a name='6930'></font>
    END IF<a name='6931'>
<a name='6932'>
    IF(OPT_RUN == 4) THEN<a name='6933'>
       SMCTOT = 0.<a name='6934'>
       DZTOT  = 0.<a name='6935'>
       DO K = 1,NSOIL<a name='6936'>
          DZTOT   = DZTOT  + DZSNSO(K)  <a name='6937'>
          SMCTOT  = SMCTOT + SMC(K)/parameters%SMCMAX(K)*DZSNSO(K)<a name='6938'>
          IF(DZTOT &gt;= 2.0) EXIT<a name='6939'>
       END DO<a name='6940'>
       SMCTOT = SMCTOT/DZTOT<a name='6941'>
       FSAT   = MAX(0.01,SMCTOT) ** 4.        <font color=#447700>!BATS<a name='6942'></font>
<a name='6943'>
       IF(QINSUR &gt; 0.) THEN<a name='6944'>
         RUNSRF = QINSUR * ((1.0-FCR(1))*FSAT+FCR(1))  <a name='6945'>
         PDDUM  = QINSUR - RUNSRF                       <font color=#447700>! m/s<a name='6946'></font>
       END IF<a name='6947'>
    END IF<a name='6948'>
<a name='6949'>
<font color=#447700>! determine iteration times and finer time step<a name='6950'></font>
<a name='6951'>
    NITER = 1<a name='6952'>
<a name='6953'>
<font color=#447700>!    IF(OPT_INF == 1) THEN    !OPT_INF =2 may cause water imbalance<a name='6954'></font>
       NITER = 3<a name='6955'>
       IF (PDDUM*DT&gt;DZSNSO(1)*parameters%SMCMAX(1) ) THEN<a name='6956'>
          NITER = NITER*2<a name='6957'>
       END IF<a name='6958'>
<font color=#447700>!    END IF                 <a name='6959'></font>
<a name='6960'>
    DTFINE  = DT / NITER<a name='6961'>
<a name='6962'>
<font color=#447700>! solve soil moisture<a name='6963'></font>
<a name='6964'>
    QDRAIN_SAVE = 0.0<a name='6965'>
    RUNSRF_SAVE = 0.0<a name='6966'>
    DO ITER = 1, NITER<a name='6967'>
       IF(QINSUR &gt; 0. .and. OPT_RUN == 3) THEN<a name='6968'>
          CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#INFIL'>INFIL</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SOILWATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INFIL_2"> (parameters,NSOIL  ,DTFINE     ,ZSOIL  ,SH2O   ,SICE   , &amp; <font color=#447700>!in<a name='6969'></font>
                      SICEMAX,QINSUR ,                         &amp; <font color=#447700>!in<a name='6970'></font>
                      PDDUM  ,RUNSRF )                           <font color=#447700>!out<a name='6971'></font>
       END IF<a name='6972'>
<a name='6973'>
       CALL <A href='../../html_code/phys/module_sf_urban.F.html#SRT'>SRT</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SOILWATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SRT_4">   (parameters,NSOIL  ,ZSOIL  ,DTFINE ,PDDUM  ,ETRANI , &amp; <font color=#447700>!in<a name='6974'></font>
                   QSEVA  ,SH2O   ,SMC    ,ZWT    ,FCR    , &amp; <font color=#447700>!in<a name='6975'></font>
                   SICEMAX,FCRMAX ,ILOC   ,JLOC   ,SMCWTD ,         &amp; <font color=#447700>!in<a name='6976'></font>
                   RHSTT  ,AI     ,BI     ,CI     ,QDRAIN , &amp; <font color=#447700>!out<a name='6977'></font>
                   WCND   )                                   <font color=#447700>!out<a name='6978'></font>
  <a name='6979'>
       CALL <A href='../../html_code/phys/module_sf_urban.F.html#SSTEP'>SSTEP</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SOILWATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SSTEP_4"> (parameters,NSOIL  ,NSNOW  ,DTFINE ,ZSOIL  ,DZSNSO , &amp; <font color=#447700>!in<a name='6980'></font>
                   SICE   ,ILOC   ,JLOC   ,ZWT            ,                 &amp; <font color=#447700>!in<a name='6981'></font>
                   SH2O   ,SMC    ,AI     ,BI     ,CI     , &amp; <font color=#447700>!inout<a name='6982'></font>
                   RHSTT  ,SMCWTD ,QDRAIN ,DEEPRECH,                                 &amp; <font color=#447700>!inout<a name='6983'></font>
                   WPLUS)                                     <font color=#447700>!out<a name='6984'></font>
       RSAT =  RSAT + WPLUS<a name='6985'>
       QDRAIN_SAVE = QDRAIN_SAVE + QDRAIN<a name='6986'>
       RUNSRF_SAVE = RUNSRF_SAVE + RUNSRF<a name='6987'>
    END DO<a name='6988'>
<a name='6989'>
    QDRAIN = QDRAIN_SAVE/NITER<a name='6990'>
    RUNSRF = RUNSRF_SAVE/NITER<a name='6991'>
<a name='6992'>
    RUNSRF = RUNSRF * 1000. + RSAT * 1000./DT  <font color=#447700>! m/s -&gt; mm/s<a name='6993'></font>
    QDRAIN = QDRAIN * 1000.<a name='6994'>
<a name='6995'>
<font color=#447700>!WRF_HYDRO_DJG...<a name='6996'></font>
<font color=#447700>!yw    INFXSRT = RUNSRF * DT   !mm/s -&gt; mm<a name='6997'></font>
<a name='6998'>
<font color=#447700>! removal of soil water due to groundwater flow (option 2)<a name='6999'></font>
<a name='7000'>
    IF(OPT_RUN == 2) THEN<a name='7001'>
         WTSUB = 0.<a name='7002'>
         DO K = 1, NSOIL<a name='7003'>
           WTSUB = WTSUB + WCND(K)*DZSNSO(K)<a name='7004'>
         END DO<a name='7005'>
<a name='7006'>
         DO K = 1, NSOIL<a name='7007'>
           MH2O    = RUNSUB*DT*(WCND(K)*DZSNSO(K))/WTSUB       <font color=#447700>! mm<a name='7008'></font>
           SH2O(K) = SH2O(K) - MH2O/(DZSNSO(K)*1000.)<a name='7009'>
         END DO<a name='7010'>
    END IF<a name='7011'>
<a name='7012'>
<font color=#447700>! Limit MLIQ to be greater than or equal to watmin.<a name='7013'></font>
<font color=#447700>! Get water needed to bring MLIQ equal WATMIN from lower layer.<a name='7014'></font>
<a name='7015'>
   IF(OPT_RUN /= 1) THEN<a name='7016'>
      DO IZ = 1, NSOIL<a name='7017'>
         MLIQ(IZ) = SH2O(IZ)*DZSNSO(IZ)*1000.<a name='7018'>
      END DO<a name='7019'>
<a name='7020'>
      WATMIN = 0.01           <font color=#447700>! mm<a name='7021'></font>
      DO IZ = 1, NSOIL-1<a name='7022'>
          IF (MLIQ(IZ) .LT. 0.) THEN<a name='7023'>
             XS = WATMIN-MLIQ(IZ)<a name='7024'>
          ELSE<a name='7025'>
             XS = 0.<a name='7026'>
          END IF<a name='7027'>
          MLIQ(IZ  ) = MLIQ(IZ  ) + XS<a name='7028'>
          MLIQ(IZ+1) = MLIQ(IZ+1) - XS<a name='7029'>
      END DO<a name='7030'>
<a name='7031'>
        IZ = NSOIL<a name='7032'>
        IF (MLIQ(IZ) .LT. WATMIN) THEN<a name='7033'>
           XS = WATMIN-MLIQ(IZ)<a name='7034'>
        ELSE<a name='7035'>
           XS = 0.<a name='7036'>
        END IF<a name='7037'>
        MLIQ(IZ) = MLIQ(IZ) + XS<a name='7038'>
        RUNSUB   = RUNSUB - XS/DT<a name='7039'>
        IF(OPT_RUN == 5)DEEPRECH = DEEPRECH - XS*1.E-3<a name='7040'>
<a name='7041'>
      DO IZ = 1, NSOIL<a name='7042'>
        SH2O(IZ)     = MLIQ(IZ) / (DZSNSO(IZ)*1000.)<a name='7043'>
      END DO<a name='7044'>
   END IF<a name='7045'>
<a name='7046'>
  END SUBROUTINE SOILWATER<a name='7047'>
<a name='7048'>
<font color=#447700>!== begin zwteq ====================================================================================<a name='7049'></font>
<a name='7050'>
<A NAME='ZWTEQ'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#ZWTEQ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7051'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ZWTEQ</font> (parameters,NSOIL  ,NSNOW  ,ZSOIL  ,DZSNSO ,SH2O   ,ZWT) <A href='../../call_to/ZWTEQ.html' TARGET='index'>1</A><a name='7052'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7053'></font>
<font color=#447700>! calculate equilibrium water table depth (Niu et al., 2005)<a name='7054'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='7055'></font>
  IMPLICIT NONE<a name='7056'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7057'></font>
<font color=#447700>! input<a name='7058'></font>
<a name='7059'>
  type (noahmp_parameters), intent(in) :: parameters<a name='7060'>
  INTEGER,                         INTENT(IN) :: NSOIL  <font color=#447700>!no. of soil layers<a name='7061'></font>
  INTEGER,                         INTENT(IN) :: NSNOW  <font color=#447700>!maximum no. of snow layers<a name='7062'></font>
  REAL, DIMENSION(1:NSOIL),        INTENT(IN) :: ZSOIL  <font color=#447700>!depth of soil layer-bottom [m]<a name='7063'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: DZSNSO <font color=#447700>!snow/soil layer depth [m]<a name='7064'></font>
  REAL, DIMENSION(1:NSOIL),        INTENT(IN) :: SH2O   <font color=#447700>!soil liquid water content [m3/m3]<a name='7065'></font>
<a name='7066'>
<font color=#447700>! output<a name='7067'></font>
<a name='7068'>
  REAL,                           INTENT(OUT) :: ZWT    <font color=#447700>!water table depth [m]<a name='7069'></font>
<a name='7070'>
<font color=#447700>! locals<a name='7071'></font>
<a name='7072'>
  INTEGER :: K                      <font color=#447700>!do-loop index<a name='7073'></font>
  INTEGER, PARAMETER :: NFINE = 100 <font color=#447700>!no. of fine soil layers of 6m soil<a name='7074'></font>
  REAL    :: WD1                    <font color=#447700>!water deficit from coarse (4-L) soil moisture profile<a name='7075'></font>
  REAL    :: WD2                    <font color=#447700>!water deficit from fine (100-L) soil moisture profile<a name='7076'></font>
  REAL    :: DZFINE                 <font color=#447700>!layer thickness of the 100-L soil layers to 6.0 m<a name='7077'></font>
  REAL    :: TEMP                   <font color=#447700>!temporary variable<a name='7078'></font>
  REAL, DIMENSION(1:NFINE) :: ZFINE <font color=#447700>!layer-bottom depth of the 100-L soil layers to 6.0 m<a name='7079'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='7080'></font>
<a name='7081'>
   WD1 = 0.<a name='7082'>
   DO K = 1,NSOIL<a name='7083'>
     WD1 = WD1 + (parameters%SMCMAX(K)-SH2O(K)) * DZSNSO(K) <font color=#447700>! [m]<a name='7084'></font>
   ENDDO<a name='7085'>
<a name='7086'>
   DZFINE = 3.0 * (-ZSOIL(NSOIL)) / NFINE  <a name='7087'>
   do K =1,NFINE<a name='7088'>
      ZFINE(K) = FLOAT(K) * DZFINE<a name='7089'>
   ENDDO<a name='7090'>
<a name='7091'>
   ZWT = -3.*ZSOIL(NSOIL) - 0.001   <font color=#447700>! initial value [m]<a name='7092'></font>
<a name='7093'>
   WD2 = 0.<a name='7094'>
   DO K = 1,NFINE<a name='7095'>
     TEMP  = 1. + (ZWT-ZFINE(K))/parameters%PSISAT(K)<a name='7096'>
     WD2   = WD2 + parameters%SMCMAX(K)*(1.-TEMP**(-1./parameters%BEXP(K)))*DZFINE<a name='7097'>
     IF(ABS(WD2-WD1).LE.0.01) THEN<a name='7098'>
        ZWT = ZFINE(K)<a name='7099'>
        EXIT<a name='7100'>
     ENDIF<a name='7101'>
   ENDDO<a name='7102'>
<a name='7103'>
  END SUBROUTINE ZWTEQ<a name='7104'>
<a name='7105'>
<font color=#447700>!== begin infil ====================================================================================<a name='7106'></font>
<a name='7107'>
<A NAME='INFIL'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#INFIL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7108'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>INFIL</font> (parameters,NSOIL  ,DT     ,ZSOIL  ,SH2O   ,SICE   , &amp; <font color=#447700>!in <A href='../../call_to/INFIL.html' TARGET='index'>2</A>,<A href='../../call_from/INFIL.html' TARGET='index'>1</A><a name='7109'></font>
                    SICEMAX,QINSUR ,                         &amp; <font color=#447700>!in<a name='7110'></font>
                    PDDUM  ,RUNSRF )                           <font color=#447700>!out<a name='7111'></font>
<font color=#447700>! --------------------------------------------------------------------------------<a name='7112'></font>
<font color=#447700>! compute inflitration rate at soil surface and surface runoff<a name='7113'></font>
<font color=#447700>! --------------------------------------------------------------------------------<a name='7114'></font>
    IMPLICIT NONE<a name='7115'>
<font color=#447700>! --------------------------------------------------------------------------------<a name='7116'></font>
<font color=#447700>! inputs<a name='7117'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='7118'>
  INTEGER,                  INTENT(IN) :: NSOIL  <font color=#447700>!no. of soil layers<a name='7119'></font>
  REAL,                     INTENT(IN) :: DT     <font color=#447700>!time step (sec)<a name='7120'></font>
  REAL, DIMENSION(1:NSOIL), INTENT(IN) :: ZSOIL  <font color=#447700>!depth of soil layer-bottom [m]<a name='7121'></font>
  REAL, DIMENSION(1:NSOIL), INTENT(IN) :: SH2O   <font color=#447700>!soil liquid water content [m3/m3]<a name='7122'></font>
  REAL, DIMENSION(1:NSOIL), INTENT(IN) :: SICE   <font color=#447700>!soil ice content [m3/m3]<a name='7123'></font>
  REAL,                     INTENT(IN) :: QINSUR <font color=#447700>!water input on soil surface [mm/s]<a name='7124'></font>
  REAL,                     INTENT(IN) :: SICEMAX<font color=#447700>!maximum soil ice content (m3/m3)<a name='7125'></font>
<a name='7126'>
<font color=#447700>! outputs<a name='7127'></font>
  REAL,                    INTENT(OUT) :: RUNSRF <font color=#447700>!surface runoff [mm/s] <a name='7128'></font>
  REAL,                    INTENT(OUT) :: PDDUM  <font color=#447700>!infiltration rate at surface<a name='7129'></font>
<a name='7130'>
<font color=#447700>! locals<a name='7131'></font>
  INTEGER :: IALP1, J, JJ,  K<a name='7132'>
  REAL                     :: VAL<a name='7133'>
  REAL                     :: DDT<a name='7134'>
  REAL                     :: PX<a name='7135'>
  REAL                     :: DT1, DD, DICE<a name='7136'>
  REAL                     :: FCR<a name='7137'>
  REAL                     :: SUM<a name='7138'>
  REAL                     :: ACRT<a name='7139'>
  REAL                     :: WDF<a name='7140'>
  REAL                     :: WCND<a name='7141'>
  REAL                     :: SMCAV<a name='7142'>
  REAL                     :: INFMAX<a name='7143'>
  REAL, DIMENSION(1:NSOIL) :: DMAX<a name='7144'>
  INTEGER, PARAMETER       :: CVFRZ = 3<a name='7145'>
<font color=#447700>! --------------------------------------------------------------------------------<a name='7146'></font>
<a name='7147'>
    IF (QINSUR &gt;  0.0) THEN<a name='7148'>
       DT1 = DT /86400.<a name='7149'>
       SMCAV = parameters%SMCMAX(1) - parameters%SMCWLT(1)<a name='7150'>
<a name='7151'>
<font color=#447700>! maximum infiltration rate<a name='7152'></font>
<a name='7153'>
       DMAX(1)= -ZSOIL(1) * SMCAV<a name='7154'>
       DICE   = -ZSOIL(1) * SICE(1)<a name='7155'>
       DMAX(1)= DMAX(1)* (1.0-(SH2O(1) + SICE(1) - parameters%SMCWLT(1))/SMCAV)<a name='7156'>
<a name='7157'>
       DD = DMAX(1)<a name='7158'>
<a name='7159'>
       DO K = 2,NSOIL<a name='7160'>
          DICE    = DICE + (ZSOIL(K-1) - ZSOIL(K) ) * SICE(K)<a name='7161'>
          DMAX(K) = (ZSOIL(K-1) - ZSOIL(K)) * SMCAV<a name='7162'>
          DMAX(K) = DMAX(K) * (1.0-(SH2O(K) + SICE(K) - parameters%SMCWLT(K))/SMCAV)<a name='7163'>
          DD      = DD + DMAX(K)<a name='7164'>
       END DO<a name='7165'>
<a name='7166'>
       VAL = (1. - EXP ( - parameters%KDT * DT1))<a name='7167'>
       DDT = DD * VAL<a name='7168'>
       PX  = MAX(0.,QINSUR * DT)<a name='7169'>
       INFMAX = (PX * (DDT / (PX + DDT)))/ DT<a name='7170'>
<a name='7171'>
<font color=#447700>! impermeable fraction due to frozen soil<a name='7172'></font>
<a name='7173'>
       FCR = 1.<a name='7174'>
       IF (DICE &gt;  1.E-2) THEN<a name='7175'>
          ACRT = CVFRZ * parameters%FRZX / DICE<a name='7176'>
          SUM = 1.<a name='7177'>
          IALP1 = CVFRZ - 1<a name='7178'>
          DO J = 1,IALP1<a name='7179'>
             K = 1<a name='7180'>
             DO JJ = J +1,IALP1<a name='7181'>
                K = K * JJ<a name='7182'>
             END DO<a name='7183'>
             SUM = SUM + (ACRT ** (CVFRZ - J)) / FLOAT(K)<a name='7184'>
          END DO<a name='7185'>
          FCR = 1. - EXP (-ACRT) * SUM<a name='7186'>
       END IF<a name='7187'>
<a name='7188'>
<font color=#447700>! correction of infiltration limitation<a name='7189'></font>
<a name='7190'>
       INFMAX = INFMAX * FCR<a name='7191'>
<a name='7192'>
<font color=#447700>! jref for urban areas<a name='7193'></font>
<font color=#447700>!       IF ( parameters%urban_flag ) INFMAX == INFMAX * 0.05<a name='7194'></font>
<a name='7195'>
       CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#WDFCND2'>WDFCND2</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#INFIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND2_1"> (parameters,WDF,WCND,SH2O(1),SICEMAX,1)<a name='7196'>
       INFMAX = MAX (INFMAX,WCND)<a name='7197'>
       INFMAX = MIN (INFMAX,PX)<a name='7198'>
<a name='7199'>
       RUNSRF= MAX(0., QINSUR - INFMAX)<a name='7200'>
       PDDUM = QINSUR - RUNSRF<a name='7201'>
<a name='7202'>
    END IF<a name='7203'>
<a name='7204'>
  END SUBROUTINE INFIL<a name='7205'>
<a name='7206'>
<font color=#447700>!== begin srt ======================================================================================<a name='7207'></font>
<a name='7208'>
<A NAME='SRT'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SRT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7209'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SRT</font> (parameters,NSOIL  ,ZSOIL  ,DT     ,PDDUM  ,ETRANI , &amp; <font color=#447700>!in <A href='../../call_to/SRT.html' TARGET='index'>5</A>,<A href='../../call_from/SRT.html' TARGET='index'>10</A><a name='7210'></font>
                  QSEVA  ,SH2O   ,SMC    ,ZWT    ,FCR    , &amp; <font color=#447700>!in<a name='7211'></font>
                  SICEMAX,FCRMAX ,ILOC   ,JLOC   ,SMCWTD ,         &amp; <font color=#447700>!in<a name='7212'></font>
                  RHSTT  ,AI     ,BI     ,CI     ,QDRAIN , &amp; <font color=#447700>!out<a name='7213'></font>
                  WCND   )                                   <font color=#447700>!out<a name='7214'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='7215'></font>
<font color=#447700>! calculate the right hand side of the time tendency term of the soil<a name='7216'></font>
<font color=#447700>! water diffusion equation.  also to compute ( prepare ) the matrix<a name='7217'></font>
<font color=#447700>! coefficients for the tri-diagonal matrix of the implicit time scheme.<a name='7218'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='7219'></font>
    IMPLICIT NONE<a name='7220'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7221'></font>
<font color=#447700>!input<a name='7222'></font>
<a name='7223'>
  type (noahmp_parameters), intent(in) :: parameters<a name='7224'>
    INTEGER,                  INTENT(IN)  :: ILOC   <font color=#447700>!grid index<a name='7225'></font>
    INTEGER,                  INTENT(IN)  :: JLOC   <font color=#447700>!grid index<a name='7226'></font>
    INTEGER,                  INTENT(IN)  :: NSOIL<a name='7227'>
    REAL, DIMENSION(1:NSOIL), INTENT(IN)  :: ZSOIL<a name='7228'>
    REAL,                     INTENT(IN)  :: DT<a name='7229'>
    REAL,                     INTENT(IN)  :: PDDUM<a name='7230'>
    REAL,                     INTENT(IN)  :: QSEVA<a name='7231'>
    REAL, DIMENSION(1:NSOIL), INTENT(IN)  :: ETRANI<a name='7232'>
    REAL, DIMENSION(1:NSOIL), INTENT(IN)  :: SH2O<a name='7233'>
    REAL, DIMENSION(1:NSOIL), INTENT(IN)  :: SMC<a name='7234'>
    REAL,                     INTENT(IN)  :: ZWT    <font color=#447700>! water table depth [m]<a name='7235'></font>
    REAL, DIMENSION(1:NSOIL), INTENT(IN)  :: FCR<a name='7236'>
    REAL, INTENT(IN)                      :: FCRMAX <font color=#447700>!maximum of FCR (-)<a name='7237'></font>
    REAL,                     INTENT(IN)  :: SICEMAX<font color=#447700>!maximum soil ice content (m3/m3)<a name='7238'></font>
    REAL,                     INTENT(IN)  :: SMCWTD <font color=#447700>!soil moisture between bottom of the soil and the water table<a name='7239'></font>
<a name='7240'>
<font color=#447700>! output<a name='7241'></font>
<a name='7242'>
    REAL, DIMENSION(1:NSOIL), INTENT(OUT) :: RHSTT<a name='7243'>
    REAL, DIMENSION(1:NSOIL), INTENT(OUT) :: AI<a name='7244'>
    REAL, DIMENSION(1:NSOIL), INTENT(OUT) :: BI<a name='7245'>
    REAL, DIMENSION(1:NSOIL), INTENT(OUT) :: CI<a name='7246'>
    REAL, DIMENSION(1:NSOIL), INTENT(OUT) :: WCND    <font color=#447700>!hydraulic conductivity (m/s)<a name='7247'></font>
    REAL,                     INTENT(OUT) :: QDRAIN  <font color=#447700>!bottom drainage (m/s)<a name='7248'></font>
<a name='7249'>
<font color=#447700>! local<a name='7250'></font>
    INTEGER                               :: K<a name='7251'>
    REAL, DIMENSION(1:NSOIL)              :: DDZ<a name='7252'>
    REAL, DIMENSION(1:NSOIL)              :: DENOM<a name='7253'>
    REAL, DIMENSION(1:NSOIL)              :: DSMDZ<a name='7254'>
    REAL, DIMENSION(1:NSOIL)              :: WFLUX<a name='7255'>
    REAL, DIMENSION(1:NSOIL)              :: WDF<a name='7256'>
    REAL, DIMENSION(1:NSOIL)              :: SMX<a name='7257'>
    REAL                                  :: TEMP1<a name='7258'>
    REAL                                  :: SMXWTD <font color=#447700>!soil moisture between bottom of the soil and water table<a name='7259'></font>
    REAL                                  :: SMXBOT  <font color=#447700>!soil moisture below bottom to calculate flux<a name='7260'></font>
<a name='7261'>
<font color=#447700>! Niu and Yang (2006), J. of Hydrometeorology<a name='7262'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='7263'></font>
<a name='7264'>
    IF(OPT_INF == 1) THEN<a name='7265'>
      DO K = 1, NSOIL<a name='7266'>
        CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#WDFCND1'>WDFCND1</A><A href='../../html_code/phys/module_sf_urban.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND1_1"> (parameters,WDF(K),WCND(K),SMC(K),FCR(K),K)<a name='7267'>
        SMX(K) = SMC(K)<a name='7268'>
      END DO<a name='7269'>
        IF(OPT_RUN == 5)SMXWTD=SMCWTD<a name='7270'>
    END IF<a name='7271'>
<a name='7272'>
    IF(OPT_INF == 2) THEN<a name='7273'>
      DO K = 1, NSOIL<a name='7274'>
        CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#WDFCND2'>WDFCND2</A><A href='../../html_code/phys/module_sf_urban.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND2_2"> (parameters,WDF(K),WCND(K),SH2O(K),SICEMAX,K)<a name='7275'>
        SMX(K) = SH2O(K)<a name='7276'>
      END DO<a name='7277'>
          IF(OPT_RUN == 5)SMXWTD=SMCWTD*SH2O(NSOIL)/SMC(NSOIL)  <font color=#447700>!same liquid fraction as in the bottom layer<a name='7278'></font>
    END IF<a name='7279'>
<a name='7280'>
    DO K = 1, NSOIL<a name='7281'>
       IF(K == 1) THEN<a name='7282'>
          DENOM(K) = - ZSOIL (K)<a name='7283'>
          TEMP1    = - ZSOIL (K+1)<a name='7284'>
          DDZ(K)   = 2.0 / TEMP1<a name='7285'>
          DSMDZ(K) = 2.0 * (SMX(K) - SMX(K+1)) / TEMP1<a name='7286'>
          WFLUX(K) = WDF(K) * DSMDZ(K) + WCND(K) - PDDUM + ETRANI(K) + QSEVA<a name='7287'>
       ELSE IF (K &lt; NSOIL) THEN<a name='7288'>
          DENOM(k) = (ZSOIL(K-1) - ZSOIL(K))<a name='7289'>
          TEMP1    = (ZSOIL(K-1) - ZSOIL(K+1))<a name='7290'>
          DDZ(K)   = 2.0 / TEMP1<a name='7291'>
          DSMDZ(K) = 2.0 * (SMX(K) - SMX(K+1)) / TEMP1<a name='7292'>
          WFLUX(K) = WDF(K  ) * DSMDZ(K  ) + WCND(K  )         &amp;<a name='7293'>
                   - WDF(K-1) * DSMDZ(K-1) - WCND(K-1) + ETRANI(K)<a name='7294'>
       ELSE<a name='7295'>
          DENOM(K) = (ZSOIL(K-1) - ZSOIL(K))<a name='7296'>
          IF(OPT_RUN == 1 .or. OPT_RUN == 2) THEN<a name='7297'>
             QDRAIN   = 0.<a name='7298'>
          END IF<a name='7299'>
          IF(OPT_RUN == 3) THEN<a name='7300'>
             QDRAIN   = parameters%SLOPE*WCND(K)<a name='7301'>
          END IF<a name='7302'>
          IF(OPT_RUN == 4) THEN<a name='7303'>
             QDRAIN   = (1.0-FCRMAX)*WCND(K)<a name='7304'>
          END IF<a name='7305'>
          IF(OPT_RUN == 5) THEN   <font color=#447700>!gmm new m-m&amp;f water table dynamics formulation<a name='7306'></font>
             TEMP1    = 2.0 * DENOM(K)<a name='7307'>
             IF(ZWT &lt; ZSOIL(NSOIL)-DENOM(NSOIL))THEN<a name='7308'>
<font color=#447700>!gmm interpolate from below, midway to the water table, to the middle of the auxiliary layer below the soil bottom<a name='7309'></font>
                SMXBOT = SMX(K) - (SMX(K)-SMXWTD) *  DENOM(K) * 2./ (DENOM(K) + ZSOIL(K) - ZWT)<a name='7310'>
             ELSE<a name='7311'>
                SMXBOT = SMXWTD<a name='7312'>
             ENDIF<a name='7313'>
             DSMDZ(K) = 2.0 * (SMX(K) - SMXBOT) / TEMP1<a name='7314'>
             QDRAIN   = WDF(K  ) * DSMDZ(K  ) + WCND(K  )<a name='7315'>
          END IF   <a name='7316'>
          WFLUX(K) = -(WDF(K-1)*DSMDZ(K-1))-WCND(K-1)+ETRANI(K) + QDRAIN<a name='7317'>
       END IF<a name='7318'>
    END DO<a name='7319'>
<a name='7320'>
    DO K = 1, NSOIL<a name='7321'>
       IF(K == 1) THEN<a name='7322'>
          AI(K)    =   0.0<a name='7323'>
          BI(K)    =   WDF(K  ) * DDZ(K  ) / DENOM(K)<a name='7324'>
          CI(K)    = - BI (K)<a name='7325'>
       ELSE IF (K &lt; NSOIL) THEN<a name='7326'>
          AI(K)    = - WDF(K-1) * DDZ(K-1) / DENOM(K)<a name='7327'>
          CI(K)    = - WDF(K  ) * DDZ(K  ) / DENOM(K)<a name='7328'>
          BI(K)    = - ( AI (K) + CI (K) )<a name='7329'>
       ELSE<a name='7330'>
          AI(K)    = - WDF(K-1) * DDZ(K-1) / DENOM(K)<a name='7331'>
          CI(K)    = 0.0<a name='7332'>
          BI(K)    = - ( AI (K) + CI (K) )<a name='7333'>
       END IF<a name='7334'>
          RHSTT(K) = WFLUX(K) / (-DENOM(K))<a name='7335'>
    END DO<a name='7336'>
<a name='7337'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7338'></font>
  END SUBROUTINE SRT<a name='7339'>
<a name='7340'>
<font color=#447700>!== begin sstep ====================================================================================<a name='7341'></font>
<a name='7342'>
<A NAME='SSTEP'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SSTEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7343'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SSTEP</font> (parameters,NSOIL  ,NSNOW  ,DT     ,ZSOIL  ,DZSNSO , &amp; <font color=#447700>!in <A href='../../call_to/SSTEP.html' TARGET='index'>5</A>,<A href='../../call_from/SSTEP.html' TARGET='index'>3</A><a name='7344'></font>
                    SICE   ,ILOC   ,JLOC   ,ZWT            ,                 &amp; <font color=#447700>!in<a name='7345'></font>
                    SH2O   ,SMC    ,AI     ,BI     ,CI     , &amp; <font color=#447700>!inout<a name='7346'></font>
                    RHSTT  ,SMCWTD ,QDRAIN ,DEEPRECH,                                 &amp; <font color=#447700>!inout<a name='7347'></font>
                    WPLUS  )                                   <font color=#447700>!out<a name='7348'></font>
<a name='7349'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7350'></font>
<font color=#447700>! calculate/update soil moisture content values <a name='7351'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='7352'></font>
    IMPLICIT NONE<a name='7353'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7354'></font>
<font color=#447700>!input<a name='7355'></font>
<a name='7356'>
  type (noahmp_parameters), intent(in) :: parameters<a name='7357'>
    INTEGER,                         INTENT(IN) :: ILOC   <font color=#447700>!grid index<a name='7358'></font>
    INTEGER,                         INTENT(IN) :: JLOC   <font color=#447700>!grid index<a name='7359'></font>
    INTEGER,                         INTENT(IN) :: NSOIL  <font color=#447700>!<a name='7360'></font>
    INTEGER,                         INTENT(IN) :: NSNOW  <font color=#447700>!<a name='7361'></font>
    REAL, INTENT(IN)                            :: DT<a name='7362'>
    REAL, INTENT(IN)                            :: ZWT<a name='7363'>
    REAL, DIMENSION(       1:NSOIL), INTENT(IN) :: ZSOIL<a name='7364'>
    REAL, DIMENSION(       1:NSOIL), INTENT(IN) :: SICE<a name='7365'>
    REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: DZSNSO <font color=#447700>! snow/soil layer thickness [m]<a name='7366'></font>
<a name='7367'>
<font color=#447700>!input and output<a name='7368'></font>
    REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: SH2O<a name='7369'>
    REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: SMC<a name='7370'>
    REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: AI<a name='7371'>
    REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: BI<a name='7372'>
    REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: CI<a name='7373'>
    REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: RHSTT<a name='7374'>
    REAL                    , INTENT(INOUT) :: SMCWTD<a name='7375'>
    REAL                    , INTENT(INOUT) :: QDRAIN<a name='7376'>
    REAL                    , INTENT(INOUT) :: DEEPRECH<a name='7377'>
<a name='7378'>
<font color=#447700>!output<a name='7379'></font>
    REAL, INTENT(OUT)                       :: WPLUS     <font color=#447700>!saturation excess water (m)<a name='7380'></font>
<a name='7381'>
<font color=#447700>!local<a name='7382'></font>
    INTEGER                                 :: K<a name='7383'>
    REAL, DIMENSION(1:NSOIL)                :: RHSTTIN<a name='7384'>
    REAL, DIMENSION(1:NSOIL)                :: CIIN<a name='7385'>
    REAL                                    :: STOT<a name='7386'>
    REAL                                    :: EPORE<a name='7387'>
    REAL                                    :: WMINUS<a name='7388'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7389'></font>
    WPLUS = 0.0<a name='7390'>
<a name='7391'>
    DO K = 1,NSOIL<a name='7392'>
       RHSTT (K) =   RHSTT(K) * DT<a name='7393'>
       AI (K)    =      AI(K) * DT<a name='7394'>
       BI (K)    = 1. + BI(K) * DT<a name='7395'>
       CI (K)    =      CI(K) * DT<a name='7396'>
    END DO<a name='7397'>
<a name='7398'>
<font color=#447700>! copy values for input variables before calling rosr12<a name='7399'></font>
<a name='7400'>
    DO K = 1,NSOIL<a name='7401'>
       RHSTTIN(k) = RHSTT(K)<a name='7402'>
       CIIN(k)    = CI(K)<a name='7403'>
    END DO<a name='7404'>
<a name='7405'>
<font color=#447700>! call ROSR12 to solve the tri-diagonal matrix<a name='7406'></font>
<a name='7407'>
    CALL <A href='../../html_code/phys/module_sf_urban.F.html#ROSR12'>ROSR12</A><A href='../../html_code/phys/module_sf_urban.F.html#SSTEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROSR12_5"> (CI,AI,BI,CIIN,RHSTTIN,RHSTT,1,NSOIL,0)<a name='7408'>
<a name='7409'>
    DO K = 1,NSOIL<a name='7410'>
        SH2O(K) = SH2O(K) + CI(K)<a name='7411'>
    ENDDO<a name='7412'>
<a name='7413'>
<font color=#447700>!  excessive water above saturation in a layer is moved to<a name='7414'></font>
<font color=#447700>!  its unsaturated layer like in a bucket<a name='7415'></font>
<a name='7416'>
<font color=#447700>!gmmwith opt_run=5 there is soil moisture below nsoil, to the water table<a name='7417'></font>
  IF(OPT_RUN == 5) THEN<a name='7418'>
<a name='7419'>
<font color=#447700>!update smcwtd<a name='7420'></font>
<a name='7421'>
     IF(ZWT &lt; ZSOIL(NSOIL)-DZSNSO(NSOIL))THEN<a name='7422'>
<font color=#447700>!accumulate qdrain to update deep water table and soil moisture later<a name='7423'></font>
        DEEPRECH =  DEEPRECH + DT * QDRAIN<a name='7424'>
     ELSE<a name='7425'>
        SMCWTD = SMCWTD + DT * QDRAIN  / DZSNSO(NSOIL)<a name='7426'>
        WPLUS        = MAX((SMCWTD-parameters%SMCMAX(NSOIL)), 0.0) * DZSNSO(NSOIL)<a name='7427'>
        WMINUS       = MAX((1.E-4-SMCWTD), 0.0) * DZSNSO(NSOIL)<a name='7428'>
<a name='7429'>
        SMCWTD = MAX( MIN(SMCWTD,parameters%SMCMAX(NSOIL)) , 1.E-4)<a name='7430'>
        SH2O(NSOIL)    = SH2O(NSOIL) + WPLUS/DZSNSO(NSOIL)<a name='7431'>
<a name='7432'>
<font color=#447700>!reduce fluxes at the bottom boundaries accordingly<a name='7433'></font>
        QDRAIN = QDRAIN - WPLUS/DT<a name='7434'>
        DEEPRECH = DEEPRECH - WMINUS<a name='7435'>
     ENDIF<a name='7436'>
<a name='7437'>
  ENDIF<a name='7438'>
<a name='7439'>
    DO K = NSOIL,2,-1<a name='7440'>
      EPORE        = MAX ( 1.E-4 , ( parameters%SMCMAX(K) - SICE(K) ) )<a name='7441'>
      WPLUS        = MAX((SH2O(K)-EPORE), 0.0) * DZSNSO(K)<a name='7442'>
      SH2O(K)      = MIN(EPORE,SH2O(K))<a name='7443'>
      SH2O(K-1)    = SH2O(K-1) + WPLUS/DZSNSO(K-1)<a name='7444'>
    END DO<a name='7445'>
<a name='7446'>
    EPORE        = MAX ( 1.E-4 , ( parameters%SMCMAX(1) - SICE(1) ) )<a name='7447'>
    WPLUS        = MAX((SH2O(1)-EPORE), 0.0) * DZSNSO(1) <a name='7448'>
    SH2O(1)      = MIN(EPORE,SH2O(1))<a name='7449'>
<a name='7450'>
   IF(WPLUS &gt; 0.0) THEN<a name='7451'>
    SH2O(2)      = SH2O(2) + WPLUS/DZSNSO(2)<a name='7452'>
    DO K = 2,NSOIL-1<a name='7453'>
      EPORE        = MAX ( 1.E-4 , ( parameters%SMCMAX(K) - SICE(K) ) )<a name='7454'>
      WPLUS        = MAX((SH2O(K)-EPORE), 0.0) * DZSNSO(K)<a name='7455'>
      SH2O(K)      = MIN(EPORE,SH2O(K))<a name='7456'>
      SH2O(K+1)    = SH2O(K+1) + WPLUS/DZSNSO(K+1)<a name='7457'>
    END DO<a name='7458'>
<a name='7459'>
    EPORE        = MAX ( 1.E-4 , ( parameters%SMCMAX(NSOIL) - SICE(NSOIL) ) )<a name='7460'>
    WPLUS        = MAX((SH2O(NSOIL)-EPORE), 0.0) * DZSNSO(NSOIL) <a name='7461'>
    SH2O(NSOIL)  = MIN(EPORE,SH2O(NSOIL))<a name='7462'>
   END IF<a name='7463'>
   <a name='7464'>
    SMC = SH2O + SICE<a name='7465'>
<a name='7466'>
  END SUBROUTINE SSTEP<a name='7467'>
<a name='7468'>
<font color=#447700>!== begin wdfcnd1 ==================================================================================<a name='7469'></font>
<a name='7470'>
<A NAME='WDFCND1'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#WDFCND1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7471'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>WDFCND1</font> (parameters,WDF,WCND,SMC,FCR,ISOIL) <A href='../../call_to/WDFCND1.html' TARGET='index'>1</A><a name='7472'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7473'></font>
<font color=#447700>! calculate soil water diffusivity and soil hydraulic conductivity.<a name='7474'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='7475'></font>
    IMPLICIT NONE<a name='7476'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7477'></font>
<font color=#447700>! input <a name='7478'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='7479'>
    REAL,INTENT(IN)  :: SMC<a name='7480'>
    REAL,INTENT(IN)  :: FCR<a name='7481'>
    INTEGER,INTENT(IN)  :: ISOIL<a name='7482'>
<a name='7483'>
<font color=#447700>! output<a name='7484'></font>
    REAL,INTENT(OUT) :: WCND<a name='7485'>
    REAL,INTENT(OUT) :: WDF<a name='7486'>
<a name='7487'>
<font color=#447700>! local<a name='7488'></font>
    REAL :: EXPON<a name='7489'>
    REAL :: FACTR<a name='7490'>
    REAL :: VKWGT<a name='7491'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7492'></font>
<a name='7493'>
<font color=#447700>! soil water diffusivity<a name='7494'></font>
<a name='7495'>
    FACTR = MAX(0.01, SMC/parameters%SMCMAX(ISOIL))<a name='7496'>
    EXPON = parameters%BEXP(ISOIL) + 2.0<a name='7497'>
    WDF   = parameters%DWSAT(ISOIL) * FACTR ** EXPON<a name='7498'>
    WDF   = WDF * (1.0 - FCR)<a name='7499'>
<a name='7500'>
<font color=#447700>! hydraulic conductivity<a name='7501'></font>
<a name='7502'>
    EXPON = 2.0*parameters%BEXP(ISOIL) + 3.0<a name='7503'>
    WCND  = parameters%DKSAT(ISOIL) * FACTR ** EXPON<a name='7504'>
    WCND  = WCND * (1.0 - FCR)<a name='7505'>
<a name='7506'>
  END SUBROUTINE WDFCND1<a name='7507'>
<a name='7508'>
<font color=#447700>!== begin wdfcnd2 ==================================================================================<a name='7509'></font>
<a name='7510'>
<A NAME='WDFCND2'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#WDFCND2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7511'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>WDFCND2</font> (parameters,WDF,WCND,SMC,SICE,ISOIL) <A href='../../call_to/WDFCND2.html' TARGET='index'>2</A><a name='7512'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7513'></font>
<font color=#447700>! calculate soil water diffusivity and soil hydraulic conductivity.<a name='7514'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='7515'></font>
    IMPLICIT NONE<a name='7516'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7517'></font>
<font color=#447700>! input<a name='7518'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='7519'>
    REAL,INTENT(IN)  :: SMC<a name='7520'>
    REAL,INTENT(IN)  :: SICE<a name='7521'>
    INTEGER,INTENT(IN)  :: ISOIL<a name='7522'>
<a name='7523'>
<font color=#447700>! output<a name='7524'></font>
    REAL,INTENT(OUT) :: WCND<a name='7525'>
    REAL,INTENT(OUT) :: WDF<a name='7526'>
<a name='7527'>
<font color=#447700>! local<a name='7528'></font>
    REAL :: EXPON<a name='7529'>
    REAL :: FACTR1,FACTR2<a name='7530'>
    REAL :: VKWGT<a name='7531'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7532'></font>
<a name='7533'>
<font color=#447700>! soil water diffusivity<a name='7534'></font>
<a name='7535'>
    FACTR1 = 0.05/parameters%SMCMAX(ISOIL)<a name='7536'>
    FACTR2 = MAX(0.01, SMC/parameters%SMCMAX(ISOIL))<a name='7537'>
    FACTR1 = MIN(FACTR1,FACTR2)<a name='7538'>
    EXPON = parameters%BEXP(ISOIL) + 2.0<a name='7539'>
    WDF   = parameters%DWSAT(ISOIL) * FACTR2 ** EXPON<a name='7540'>
<a name='7541'>
    IF (SICE &gt; 0.0) THEN<a name='7542'>
    VKWGT = 1./ (1. + (500.* SICE)**3.)<a name='7543'>
    WDF   = VKWGT * WDF + (1.-VKWGT)*parameters%DWSAT(ISOIL)*(FACTR1)**EXPON<a name='7544'>
    END IF<a name='7545'>
<a name='7546'>
<font color=#447700>! hydraulic conductivity<a name='7547'></font>
<a name='7548'>
    EXPON = 2.0*parameters%BEXP(ISOIL) + 3.0<a name='7549'>
    WCND  = parameters%DKSAT(ISOIL) * FACTR2 ** EXPON<a name='7550'>
<a name='7551'>
  END SUBROUTINE WDFCND2<a name='7552'>
<a name='7553'>
<font color=#447700>!== begin groundwater ==============================================================================<a name='7554'></font>
<a name='7555'>
<A NAME='GROUNDWATER'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#GROUNDWATER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7556'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>GROUNDWATER</font>(parameters,NSNOW  ,NSOIL  ,DT     ,SICE   ,ZSOIL  , &amp; <font color=#447700>!in <A href='../../call_to/GROUNDWATER.html' TARGET='index'>1</A><a name='7557'></font>
                         STC    ,WCND   ,FCRMAX ,ILOC   ,JLOC   , &amp; <font color=#447700>!in<a name='7558'></font>
                         SH2O   ,ZWT    ,WA     ,WT     ,         &amp; <font color=#447700>!inout<a name='7559'></font>
                         QIN    ,QDIS   )                           <font color=#447700>!out<a name='7560'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='7561'></font>
  IMPLICIT NONE<a name='7562'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7563'></font>
<font color=#447700>! input<a name='7564'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='7565'>
  INTEGER,                         INTENT(IN) :: ILOC  <font color=#447700>!grid index<a name='7566'></font>
  INTEGER,                         INTENT(IN) :: JLOC  <font color=#447700>!grid index<a name='7567'></font>
  INTEGER,                         INTENT(IN) :: NSNOW <font color=#447700>!maximum no. of snow layers<a name='7568'></font>
  INTEGER,                         INTENT(IN) :: NSOIL <font color=#447700>!no. of soil layers<a name='7569'></font>
  REAL,                            INTENT(IN) :: DT    <font color=#447700>!timestep [sec]<a name='7570'></font>
  REAL,                            INTENT(IN) :: FCRMAX<font color=#447700>!maximum FCR (-)<a name='7571'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN) :: SICE  <font color=#447700>!soil ice content [m3/m3]<a name='7572'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN) :: ZSOIL <font color=#447700>!depth of soil layer-bottom [m]<a name='7573'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN) :: WCND  <font color=#447700>!hydraulic conductivity (m/s)<a name='7574'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: STC   <font color=#447700>!snow/soil temperature (k)<a name='7575'></font>
<a name='7576'>
<font color=#447700>! input and output<a name='7577'></font>
  REAL, DIMENSION(    1:NSOIL), INTENT(INOUT) :: SH2O  <font color=#447700>!liquid soil water [m3/m3]<a name='7578'></font>
  REAL,                         INTENT(INOUT) :: ZWT   <font color=#447700>!the depth to water table [m]<a name='7579'></font>
  REAL,                         INTENT(INOUT) :: WA    <font color=#447700>!water storage in aquifer [mm]<a name='7580'></font>
  REAL,                         INTENT(INOUT) :: WT    <font color=#447700>!water storage in aquifer <a name='7581'></font>
                                                           <font color=#447700>!+ saturated soil [mm]<a name='7582'></font>
<font color=#447700>! output<a name='7583'></font>
  REAL,                           INTENT(OUT) :: QIN   <font color=#447700>!groundwater recharge [mm/s]<a name='7584'></font>
  REAL,                           INTENT(OUT) :: QDIS  <font color=#447700>!groundwater discharge [mm/s]<a name='7585'></font>
<a name='7586'>
<font color=#447700>! local<a name='7587'></font>
  REAL                                        :: FFF   <font color=#447700>!runoff decay factor (m-1)<a name='7588'></font>
  REAL                                        :: RSBMX <font color=#447700>!baseflow coefficient [mm/s]<a name='7589'></font>
  INTEGER                                     :: IZ    <font color=#447700>!do-loop index<a name='7590'></font>
  INTEGER                                     :: IWT   <font color=#447700>!layer index above water table layer<a name='7591'></font>
  REAL,  DIMENSION(    1:NSOIL)               :: DZMM  <font color=#447700>!layer thickness [mm]<a name='7592'></font>
  REAL,  DIMENSION(    1:NSOIL)               :: ZNODE <font color=#447700>!node depth [m]<a name='7593'></font>
  REAL,  DIMENSION(    1:NSOIL)               :: MLIQ  <font color=#447700>!liquid water mass [kg/m2 or mm]<a name='7594'></font>
  REAL,  DIMENSION(    1:NSOIL)               :: EPORE <font color=#447700>!effective porosity [-]<a name='7595'></font>
  REAL,  DIMENSION(    1:NSOIL)               :: HK    <font color=#447700>!hydraulic conductivity [mm/s]<a name='7596'></font>
  REAL,  DIMENSION(    1:NSOIL)               :: SMC   <font color=#447700>!total soil water  content [m3/m3]<a name='7597'></font>
  REAL(KIND=8)                                :: S_NODE<font color=#447700>!degree of saturation of IWT layer<a name='7598'></font>
  REAL                                        :: DZSUM <font color=#447700>!cumulative depth above water table [m]<a name='7599'></font>
  REAL                                        :: SMPFZ <font color=#447700>!matric potential (frozen effects) [mm]<a name='7600'></font>
  REAL                                        :: KA    <font color=#447700>!aquifer hydraulic conductivity [mm/s]<a name='7601'></font>
  REAL                                        :: WH_ZWT<font color=#447700>!water head at water table [mm]<a name='7602'></font>
  REAL                                        :: WH    <font color=#447700>!water head at layer above ZWT [mm]<a name='7603'></font>
  REAL                                        :: WS    <font color=#447700>!water used to fill air pore [mm]<a name='7604'></font>
  REAL                                        :: WTSUB <font color=#447700>!sum of HK*DZMM<a name='7605'></font>
  REAL                                        :: WATMIN<font color=#447700>!minimum soil vol soil moisture [m3/m3]<a name='7606'></font>
  REAL                                        :: XS    <font color=#447700>!excessive water above saturation [mm]<a name='7607'></font>
  REAL, PARAMETER                             :: ROUS = 0.2    <font color=#447700>!specific yield [-]<a name='7608'></font>
  REAL, PARAMETER                             :: CMIC = 0.20   <font color=#447700>!microprore content (0.0-1.0)<a name='7609'></font>
                                                               <font color=#447700>!0.0-close to free drainage<a name='7610'></font>
<font color=#447700>! -------------------------------------------------------------<a name='7611'></font>
      QDIS      = 0.0<a name='7612'>
      QIN       = 0.0<a name='7613'>
<a name='7614'>
<font color=#447700>! Derive layer-bottom depth in [mm]<a name='7615'></font>
<font color=#447700>!KWM:  Derive layer thickness in mm<a name='7616'></font>
<a name='7617'>
      DZMM(1) = -ZSOIL(1)*1.E3<a name='7618'>
      DO IZ = 2, NSOIL<a name='7619'>
         DZMM(IZ)  = 1.E3 * (ZSOIL(IZ - 1) - ZSOIL(IZ))<a name='7620'>
      ENDDO<a name='7621'>
<a name='7622'>
<font color=#447700>! Derive node (middle) depth in [m]<a name='7623'></font>
<font color=#447700>!KWM:  Positive number, depth below ground surface in m<a name='7624'></font>
      ZNODE(1) = -ZSOIL(1) / 2.<a name='7625'>
      DO IZ = 2, NSOIL<a name='7626'>
         ZNODE(IZ)  = -ZSOIL(IZ-1) + 0.5 * (ZSOIL(IZ-1) - ZSOIL(IZ))<a name='7627'>
      ENDDO<a name='7628'>
<a name='7629'>
<font color=#447700>! Convert volumetric soil moisture "sh2o" to mass<a name='7630'></font>
<a name='7631'>
      DO IZ = 1, NSOIL<a name='7632'>
         SMC(IZ)      = SH2O(IZ) + SICE(IZ)<a name='7633'>
         MLIQ(IZ)     = SH2O(IZ) * DZMM(IZ)<a name='7634'>
         EPORE(IZ)    = MAX(0.01,parameters%SMCMAX(IZ) - SICE(IZ))<a name='7635'>
         HK(IZ)       = 1.E3*WCND(IZ)<a name='7636'>
      ENDDO<a name='7637'>
<a name='7638'>
<font color=#447700>! The layer index of the first unsaturated layer,<a name='7639'></font>
<font color=#447700>! i.e., the layer right above the water table<a name='7640'></font>
<a name='7641'>
      IWT = NSOIL<a name='7642'>
      DO IZ = 2,NSOIL<a name='7643'>
         IF(ZWT   .LE. -ZSOIL(IZ) ) THEN<a name='7644'>
            IWT = IZ-1<a name='7645'>
            EXIT<a name='7646'>
         END IF<a name='7647'>
      ENDDO<a name='7648'>
<a name='7649'>
<font color=#447700>! Groundwater discharge [mm/s]<a name='7650'></font>
<a name='7651'>
      FFF   = 6.0<a name='7652'>
      RSBMX = 5.0<a name='7653'>
<a name='7654'>
      QDIS = (1.0-FCRMAX)*RSBMX*EXP(-parameters%TIMEAN)*EXP(-FFF*(ZWT-2.0))<a name='7655'>
<a name='7656'>
<font color=#447700>! Matric potential at the layer above the water table<a name='7657'></font>
<a name='7658'>
      S_NODE = MIN(1.0,SMC(IWT)/parameters%SMCMAX(IWT) )<a name='7659'>
      S_NODE = MAX(S_NODE,REAL(0.01,KIND=8))<a name='7660'>
      SMPFZ  = -parameters%PSISAT(IWT)*1000.*S_NODE**(-parameters%BEXP(IWT))   <font color=#447700>! m --&gt; mm<a name='7661'></font>
      SMPFZ  = MAX(-120000.0,CMIC*SMPFZ)   <a name='7662'>
<a name='7663'>
<font color=#447700>! Recharge rate qin to groundwater<a name='7664'></font>
<a name='7665'>
      KA  = HK(IWT)<a name='7666'>
<a name='7667'>
      WH_ZWT  = - ZWT * 1.E3                          <font color=#447700>!(mm)<a name='7668'></font>
      WH      = SMPFZ  - ZNODE(IWT)*1.E3              <font color=#447700>!(mm)<a name='7669'></font>
      QIN     = - KA * (WH_ZWT-WH)  /((ZWT-ZNODE(IWT))*1.E3)<a name='7670'>
      QIN     = MAX(-10.0/DT,MIN(10./DT,QIN))<a name='7671'>
     <a name='7672'>
<font color=#447700>! Water storage in the aquifer + saturated soil<a name='7673'></font>
<a name='7674'>
      WT  = WT + (QIN - QDIS) * DT     <font color=#447700>!(mm)<a name='7675'></font>
<a name='7676'>
      IF(IWT.EQ.NSOIL) THEN<a name='7677'>
         WA          = WA + (QIN - QDIS) * DT     <font color=#447700>!(mm)<a name='7678'></font>
         WT          = WA<a name='7679'>
         ZWT         = (-ZSOIL(NSOIL) + 25.) - WA/1000./ROUS      <font color=#447700>!(m)<a name='7680'></font>
         MLIQ(NSOIL) = MLIQ(NSOIL) - QIN * DT        <font color=#447700>! [mm]<a name='7681'></font>
<a name='7682'>
         MLIQ(NSOIL) = MLIQ(NSOIL) + MAX(0.,(WA - 5000.))<a name='7683'>
         WA          = MIN(WA, 5000.)<a name='7684'>
      ELSE<a name='7685'>
         <a name='7686'>
         IF (IWT.EQ.NSOIL-1) THEN<a name='7687'>
            ZWT = -ZSOIL(NSOIL)                   &amp;<a name='7688'>
                 - (WT-ROUS*1000*25.) / (EPORE(NSOIL))/1000.<a name='7689'>
         ELSE<a name='7690'>
            WS = 0.   <font color=#447700>! water used to fill soil air pores<a name='7691'></font>
            DO IZ = IWT+2,NSOIL<a name='7692'>
               WS = WS + EPORE(IZ) * DZMM(IZ)<a name='7693'>
            ENDDO<a name='7694'>
            ZWT = -ZSOIL(IWT+1)                  &amp;<a name='7695'>
                  - (WT-ROUS*1000.*25.-WS) /(EPORE(IWT+1))/1000.<a name='7696'>
         ENDIF<a name='7697'>
<a name='7698'>
         WTSUB = 0.<a name='7699'>
         DO IZ = 1, NSOIL<a name='7700'>
           WTSUB = WTSUB + HK(IZ)*DZMM(IZ)<a name='7701'>
         END DO<a name='7702'>
<a name='7703'>
         DO IZ = 1, NSOIL           <font color=#447700>! Removing subsurface runoff<a name='7704'></font>
         MLIQ(IZ) = MLIQ(IZ) - QDIS*DT*HK(IZ)*DZMM(IZ)/WTSUB<a name='7705'>
         END DO<a name='7706'>
      END IF<a name='7707'>
<a name='7708'>
      ZWT = MAX(1.5,ZWT)<a name='7709'>
<a name='7710'>
<font color=#447700>!<a name='7711'></font>
<font color=#447700>! Limit MLIQ to be greater than or equal to watmin.<a name='7712'></font>
<font color=#447700>! Get water needed to bring MLIQ equal WATMIN from lower layer.<a name='7713'></font>
<font color=#447700>!<a name='7714'></font>
      WATMIN = 0.01<a name='7715'>
      DO IZ = 1, NSOIL-1<a name='7716'>
          IF (MLIQ(IZ) .LT. 0.) THEN<a name='7717'>
             XS = WATMIN-MLIQ(IZ)<a name='7718'>
          ELSE<a name='7719'>
             XS = 0.<a name='7720'>
          END IF<a name='7721'>
          MLIQ(IZ  ) = MLIQ(IZ  ) + XS<a name='7722'>
          MLIQ(IZ+1) = MLIQ(IZ+1) - XS<a name='7723'>
      END DO<a name='7724'>
<a name='7725'>
        IZ = NSOIL<a name='7726'>
        IF (MLIQ(IZ) .LT. WATMIN) THEN<a name='7727'>
           XS = WATMIN-MLIQ(IZ)<a name='7728'>
        ELSE<a name='7729'>
           XS = 0.<a name='7730'>
        END IF<a name='7731'>
        MLIQ(IZ) = MLIQ(IZ) + XS<a name='7732'>
        WA       = WA - XS<a name='7733'>
        WT       = WT - XS<a name='7734'>
<a name='7735'>
      DO IZ = 1, NSOIL<a name='7736'>
        SH2O(IZ)     = MLIQ(IZ) / DZMM(IZ)<a name='7737'>
      END DO<a name='7738'>
<a name='7739'>
  END SUBROUTINE GROUNDWATER<a name='7740'>
<a name='7741'>
<font color=#447700>!== begin shallowwatertable ========================================================================<a name='7742'></font>
<a name='7743'>
<A NAME='SHALLOWWATERTABLE'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#SHALLOWWATERTABLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7744'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SHALLOWWATERTABLE</font> (parameters,NSNOW  ,NSOIL  ,ZSOIL, DT    , &amp; <font color=#447700>!in <A href='../../call_to/SHALLOWWATERTABLE.html' TARGET='index'>1</A><a name='7745'></font>
                         DZSNSO ,SMCEQ ,ILOC   ,JLOC         , &amp; <font color=#447700>!in<a name='7746'></font>
                         SMC    ,WTD   ,SMCWTD ,RECH, QDRAIN  )  <font color=#447700>!inout<a name='7747'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='7748'></font>
<font color=#447700>!Diagnoses water table depth and computes recharge when the water table is within the resolved soil layers,<a name='7749'></font>
<font color=#447700>!according to the Miguez-Macho&amp;Fan scheme<a name='7750'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='7751'></font>
  IMPLICIT NONE<a name='7752'>
<font color=#447700>! ----------------------------------------------------------------------<a name='7753'></font>
<font color=#447700>! input<a name='7754'></font>
  type (noahmp_parameters), intent(in) :: parameters<a name='7755'>
  INTEGER,                         INTENT(IN) :: NSNOW <font color=#447700>!maximum no. of snow layers<a name='7756'></font>
  INTEGER,                         INTENT(IN) :: NSOIL <font color=#447700>!no. of soil layers<a name='7757'></font>
  INTEGER,                         INTENT(IN) :: ILOC,JLOC<a name='7758'>
  REAL,                            INTENT(IN) :: DT<a name='7759'>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN) :: ZSOIL <font color=#447700>!depth of soil layer-bottom [m]<a name='7760'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: DZSNSO <font color=#447700>! snow/soil layer thickness [m]<a name='7761'></font>
  REAL,  DIMENSION(      1:NSOIL), INTENT(IN) :: SMCEQ  <font color=#447700>!equilibrium soil water  content [m3/m3]<a name='7762'></font>
<a name='7763'>
<font color=#447700>! input and output<a name='7764'></font>
  REAL,  DIMENSION(      1:NSOIL), INTENT(INOUT) :: SMC   <font color=#447700>!total soil water  content [m3/m3]<a name='7765'></font>
  REAL,                         INTENT(INOUT) :: WTD   <font color=#447700>!the depth to water table [m]<a name='7766'></font>
  REAL,                         INTENT(INOUT) :: SMCWTD   <font color=#447700>!soil moisture between bottom of the soil and the water table [m3/m3]<a name='7767'></font>
  REAL,                         INTENT(OUT) :: RECH <font color=#447700>! groundwater recharge (net vertical flux across the water table), positive up<a name='7768'></font>
  REAL,                         INTENT(INOUT) :: QDRAIN<a name='7769'>
    <a name='7770'>
<font color=#447700>! local<a name='7771'></font>
  INTEGER                                     :: IZ    <font color=#447700>!do-loop index<a name='7772'></font>
  INTEGER                                     :: IWTD   <font color=#447700>!layer index above water table layer<a name='7773'></font>
  INTEGER                                     :: KWTD   <font color=#447700>!layer index where the water table layer is<a name='7774'></font>
  REAL                                        :: WTDOLD<a name='7775'>
  REAL                                        :: DZUP<a name='7776'>
  REAL                                        :: SMCEQDEEP<a name='7777'>
  REAL,  DIMENSION(       0:NSOIL)            :: ZSOIL0<a name='7778'>
<font color=#447700>! -------------------------------------------------------------<a name='7779'></font>
<a name='7780'>
<a name='7781'>
ZSOIL0(1:NSOIL) = ZSOIL(1:NSOIL)<a name='7782'>
ZSOIL0(0) = 0.         <a name='7783'>
 <a name='7784'>
<font color=#447700>!find the layer where the water table is<a name='7785'></font>
     DO IZ=NSOIL,1,-1<a name='7786'>
        IF(WTD + 1.E-6 &lt; ZSOIL0(IZ)) EXIT<a name='7787'>
     ENDDO<a name='7788'>
        IWTD=IZ<a name='7789'>
<a name='7790'>
        <a name='7791'>
        KWTD=IWTD+1  <font color=#447700>!layer where the water table is<a name='7792'></font>
        IF(KWTD.LE.NSOIL)THEN    <font color=#447700>!wtd in the resolved layers<a name='7793'></font>
           WTDOLD=WTD<a name='7794'>
           IF(SMC(KWTD).GT.SMCEQ(KWTD))THEN<a name='7795'>
        <a name='7796'>
               IF(SMC(KWTD).EQ.parameters%SMCMAX(KWTD))THEN <font color=#447700>!wtd went to the layer above<a name='7797'></font>
                      WTD=ZSOIL0(IWTD)<a name='7798'>
                      RECH=-(WTDOLD-WTD) * (parameters%SMCMAX(KWTD)-SMCEQ(KWTD))<a name='7799'>
                      IWTD=IWTD-1<a name='7800'>
                      KWTD=KWTD-1<a name='7801'>
                   IF(KWTD.GE.1)THEN<a name='7802'>
                      IF(SMC(KWTD).GT.SMCEQ(KWTD))THEN<a name='7803'>
                      WTDOLD=WTD<a name='7804'>
                      WTD = MIN( ( SMC(KWTD)*DZSNSO(KWTD) &amp;<a name='7805'>
                        - SMCEQ(KWTD)*ZSOIL0(IWTD) + parameters%SMCMAX(KWTD)*ZSOIL0(KWTD) ) / &amp;<a name='7806'>
                        ( parameters%SMCMAX(KWTD)-SMCEQ(KWTD) ), ZSOIL0(IWTD))<a name='7807'>
                      RECH=RECH-(WTDOLD-WTD) * (parameters%SMCMAX(KWTD)-SMCEQ(KWTD))<a name='7808'>
                      ENDIF<a name='7809'>
                   ENDIF<a name='7810'>
               ELSE  <font color=#447700>!wtd stays in the layer<a name='7811'></font>
                      WTD = MIN( ( SMC(KWTD)*DZSNSO(KWTD) &amp;<a name='7812'>
                        - SMCEQ(KWTD)*ZSOIL0(IWTD) + parameters%SMCMAX(KWTD)*ZSOIL0(KWTD) ) / &amp;<a name='7813'>
                        ( parameters%SMCMAX(KWTD)-SMCEQ(KWTD) ), ZSOIL0(IWTD))<a name='7814'>
                      RECH=-(WTDOLD-WTD) * (parameters%SMCMAX(KWTD)-SMCEQ(KWTD))<a name='7815'>
               ENDIF<a name='7816'>
           <a name='7817'>
           ELSE    <font color=#447700>!wtd has gone down to the layer below<a name='7818'></font>
               WTD=ZSOIL0(KWTD)<a name='7819'>
               RECH=-(WTDOLD-WTD) * (parameters%SMCMAX(KWTD)-SMCEQ(KWTD))<a name='7820'>
               KWTD=KWTD+1<a name='7821'>
               IWTD=IWTD+1<a name='7822'>
<font color=#447700>!wtd crossed to the layer below. Now adjust it there<a name='7823'></font>
               IF(KWTD.LE.NSOIL)THEN<a name='7824'>
                   WTDOLD=WTD<a name='7825'>
                   IF(SMC(KWTD).GT.SMCEQ(KWTD))THEN<a name='7826'>
                   WTD = MIN( ( SMC(KWTD)*DZSNSO(KWTD) &amp;<a name='7827'>
                   - SMCEQ(KWTD)*ZSOIL0(IWTD) + parameters%SMCMAX(KWTD)*ZSOIL0(KWTD) ) / &amp;<a name='7828'>
                       ( parameters%SMCMAX(KWTD)-SMCEQ(KWTD) ) , ZSOIL0(IWTD) )<a name='7829'>
                   ELSE<a name='7830'>
                   WTD=ZSOIL0(KWTD)<a name='7831'>
                   ENDIF<a name='7832'>
                   RECH = RECH - (WTDOLD-WTD) * &amp;<a name='7833'>
                                 (parameters%SMCMAX(KWTD)-SMCEQ(KWTD))<a name='7834'>
<a name='7835'>
                ELSE<a name='7836'>
                   WTDOLD=WTD<a name='7837'>
<font color=#447700>!restore smoi to equilibrium value with water from the ficticious layer below<a name='7838'></font>
<font color=#447700>!                   SMCWTD=SMCWTD-(SMCEQ(NSOIL)-SMC(NSOIL))<a name='7839'></font>
<font color=#447700>!                   QDRAIN = QDRAIN - 1000 * (SMCEQ(NSOIL)-SMC(NSOIL)) * DZSNSO(NSOIL) / DT<a name='7840'></font>
<font color=#447700>!                   SMC(NSOIL)=SMCEQ(NSOIL)<a name='7841'></font>
<font color=#447700>!adjust wtd in the ficticious layer below<a name='7842'></font>
                   SMCEQDEEP = parameters%SMCMAX(NSOIL) * ( -parameters%PSISAT(NSOIL) / ( -parameters%PSISAT(NSOIL) - DZSNSO(NSOIL) ) ) ** (1./parameters%BEXP(NSOIL))<a name='7843'>
                   WTD = MIN( ( SMCWTD*DZSNSO(NSOIL) &amp;<a name='7844'>
                   - SMCEQDEEP*ZSOIL0(NSOIL) + parameters%SMCMAX(NSOIL)*(ZSOIL0(NSOIL)-DZSNSO(NSOIL)) ) / &amp;<a name='7845'>
                       ( parameters%SMCMAX(NSOIL)-SMCEQDEEP ) , ZSOIL0(NSOIL) )<a name='7846'>
                   RECH = RECH - (WTDOLD-WTD) * &amp;<a name='7847'>
                                 (parameters%SMCMAX(NSOIL)-SMCEQDEEP)<a name='7848'>
                ENDIF<a name='7849'>
            <a name='7850'>
            ENDIF<a name='7851'>
        ELSEIF(WTD.GE.ZSOIL0(NSOIL)-DZSNSO(NSOIL))THEN<a name='7852'>
<font color=#447700>!if wtd was already below the bottom of the resolved soil crust<a name='7853'></font>
           WTDOLD=WTD<a name='7854'>
           SMCEQDEEP = parameters%SMCMAX(NSOIL) * ( -parameters%PSISAT(NSOIL) / ( -parameters%PSISAT(NSOIL) - DZSNSO(NSOIL) ) ) ** (1./parameters%BEXP(NSOIL))<a name='7855'>
           IF(SMCWTD.GT.SMCEQDEEP)THEN<a name='7856'>
               WTD = MIN( ( SMCWTD*DZSNSO(NSOIL) &amp;<a name='7857'>
                 - SMCEQDEEP*ZSOIL0(NSOIL) + parameters%SMCMAX(NSOIL)*(ZSOIL0(NSOIL)-DZSNSO(NSOIL)) ) / &amp;<a name='7858'>
                     ( parameters%SMCMAX(NSOIL)-SMCEQDEEP ) , ZSOIL0(NSOIL) )<a name='7859'>
               RECH = -(WTDOLD-WTD) * (parameters%SMCMAX(NSOIL)-SMCEQDEEP)<a name='7860'>
           ELSE<a name='7861'>
               RECH = -(WTDOLD-(ZSOIL0(NSOIL)-DZSNSO(NSOIL))) * (parameters%SMCMAX(NSOIL)-SMCEQDEEP)<a name='7862'>
               WTDOLD=ZSOIL0(NSOIL)-DZSNSO(NSOIL)<a name='7863'>
<font color=#447700>!and now even further down<a name='7864'></font>
               DZUP=(SMCEQDEEP-SMCWTD)*DZSNSO(NSOIL)/(parameters%SMCMAX(NSOIL)-SMCEQDEEP)<a name='7865'>
               WTD=WTDOLD-DZUP<a name='7866'>
               RECH = RECH - (parameters%SMCMAX(NSOIL)-SMCEQDEEP)*DZUP<a name='7867'>
               SMCWTD=SMCEQDEEP<a name='7868'>
           ENDIF<a name='7869'>
<a name='7870'>
         <a name='7871'>
         ENDIF<a name='7872'>
<a name='7873'>
IF(IWTD.LT.NSOIL .AND. IWTD.GT.0) THEN<a name='7874'>
  SMCWTD=parameters%SMCMAX(IWTD)<a name='7875'>
ELSEIF(IWTD.LT.NSOIL .AND. IWTD.LE.0) THEN<a name='7876'>
  SMCWTD=parameters%SMCMAX(1)<a name='7877'>
END IF<a name='7878'>
<a name='7879'>
END  SUBROUTINE SHALLOWWATERTABLE<a name='7880'>
<a name='7881'>
<font color=#447700>! ==================================================================================================<a name='7882'></font>
<font color=#447700>! ********************* end of water subroutines ******************************************<a name='7883'></font>
<font color=#447700>! ==================================================================================================<a name='7884'></font>
<a name='7885'>
<font color=#447700>!== begin carbon ===================================================================================<a name='7886'></font>
<a name='7887'>
<A NAME='CARBON'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#CARBON' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7888'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>CARBON</font> (parameters,NSNOW  ,NSOIL  ,VEGTYP ,DT     ,ZSOIL  , &amp; <font color=#447700>!in <A href='../../call_to/CARBON.html' TARGET='index'>1</A>,<A href='../../call_from/CARBON.html' TARGET='index'>1</A><a name='7889'></font>
                     DZSNSO ,STC    ,SMC    ,TV     ,TG     ,PSN    , &amp; <font color=#447700>!in<a name='7890'></font>
                     FOLN   ,BTRAN  ,APAR   ,FVEG   ,IGS    , &amp; <font color=#447700>!in<a name='7891'></font>
                     TROOT  ,IST    ,LAT    ,ILOC   ,JLOC   , &amp; <font color=#447700>!in<a name='7892'></font>
                     LFMASS ,RTMASS ,STMASS ,WOOD   ,STBLCP ,FASTCP , &amp; <font color=#447700>!inout<a name='7893'></font>
                     GPP    ,NPP    ,NEE    ,AUTORS ,HETERS ,TOTSC  , &amp; <font color=#447700>!out<a name='7894'></font>
                     TOTLB  ,XLAI   ,XSAI   )                   <font color=#447700>!out<a name='7895'></font>
<font color=#447700>! ------------------------------------------------------------------------------------------<a name='7896'></font>
      IMPLICIT NONE<a name='7897'>
<font color=#447700>! ------------------------------------------------------------------------------------------<a name='7898'></font>
<font color=#447700>! inputs (carbon)<a name='7899'></font>
<a name='7900'>
  type (noahmp_parameters), intent(in) :: parameters<a name='7901'>
  INTEGER                        , INTENT(IN) :: ILOC   <font color=#447700>!grid index<a name='7902'></font>
  INTEGER                        , INTENT(IN) :: JLOC   <font color=#447700>!grid index<a name='7903'></font>
  INTEGER                        , INTENT(IN) :: VEGTYP <font color=#447700>!vegetation type <a name='7904'></font>
  INTEGER                        , INTENT(IN) :: NSNOW  <font color=#447700>!number of snow layers<a name='7905'></font>
  INTEGER                        , INTENT(IN) :: NSOIL  <font color=#447700>!number of soil layers<a name='7906'></font>
  REAL                           , INTENT(IN) :: LAT    <font color=#447700>!latitude (radians)<a name='7907'></font>
  REAL                           , INTENT(IN) :: DT     <font color=#447700>!time step (s)<a name='7908'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN) :: ZSOIL  <font color=#447700>!depth of layer-bottom from soil surface<a name='7909'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: DZSNSO <font color=#447700>!snow/soil layer thickness [m]<a name='7910'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: STC    <font color=#447700>!snow/soil temperature [k]<a name='7911'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN) :: SMC    <font color=#447700>!soil moisture (ice + liq.) [m3/m3]<a name='7912'></font>
  REAL                           , INTENT(IN) :: TV     <font color=#447700>!vegetation temperature (k)<a name='7913'></font>
  REAL                           , INTENT(IN) :: TG     <font color=#447700>!ground temperature (k)<a name='7914'></font>
  REAL                           , INTENT(IN) :: FOLN   <font color=#447700>!foliage nitrogen (%)<a name='7915'></font>
  REAL                           , INTENT(IN) :: BTRAN  <font color=#447700>!soil water transpiration factor (0 to 1)<a name='7916'></font>
  REAL                           , INTENT(IN) :: PSN    <font color=#447700>!total leaf photosyn (umolco2/m2/s) [+]<a name='7917'></font>
  REAL                           , INTENT(IN) :: APAR   <font color=#447700>!PAR by canopy (w/m2)<a name='7918'></font>
  REAL                           , INTENT(IN) :: IGS    <font color=#447700>!growing season index (0=off, 1=on)<a name='7919'></font>
  REAL                           , INTENT(IN) :: FVEG   <font color=#447700>!vegetation greenness fraction<a name='7920'></font>
  REAL                           , INTENT(IN) :: TROOT  <font color=#447700>!root-zone averaged temperature (k)<a name='7921'></font>
  INTEGER                        , INTENT(IN) :: IST    <font color=#447700>!surface type 1-&gt;soil; 2-&gt;lake<a name='7922'></font>
<a name='7923'>
<font color=#447700>! input &amp; output (carbon)<a name='7924'></font>
<a name='7925'>
  REAL                        , INTENT(INOUT) :: LFMASS <font color=#447700>!leaf mass [g/m2]<a name='7926'></font>
  REAL                        , INTENT(INOUT) :: RTMASS <font color=#447700>!mass of fine roots [g/m2]<a name='7927'></font>
  REAL                        , INTENT(INOUT) :: STMASS <font color=#447700>!stem mass [g/m2]<a name='7928'></font>
  REAL                        , INTENT(INOUT) :: WOOD   <font color=#447700>!mass of wood (incl. woody roots) [g/m2]<a name='7929'></font>
  REAL                        , INTENT(INOUT) :: STBLCP <font color=#447700>!stable carbon in deep soil [g/m2]<a name='7930'></font>
  REAL                        , INTENT(INOUT) :: FASTCP <font color=#447700>!short-lived carbon in shallow soil [g/m2]<a name='7931'></font>
<a name='7932'>
<font color=#447700>! outputs: (carbon)<a name='7933'></font>
<a name='7934'>
  REAL                          , INTENT(OUT) :: GPP    <font color=#447700>!net instantaneous assimilation [g/m2/s C]<a name='7935'></font>
  REAL                          , INTENT(OUT) :: NPP    <font color=#447700>!net primary productivity [g/m2/s C]<a name='7936'></font>
  REAL                          , INTENT(OUT) :: NEE    <font color=#447700>!net ecosystem exchange [g/m2/s CO2]<a name='7937'></font>
  REAL                          , INTENT(OUT) :: AUTORS <font color=#447700>!net ecosystem respiration [g/m2/s C]<a name='7938'></font>
  REAL                          , INTENT(OUT) :: HETERS <font color=#447700>!organic respiration [g/m2/s C]<a name='7939'></font>
  REAL                          , INTENT(OUT) :: TOTSC  <font color=#447700>!total soil carbon [g/m2 C]<a name='7940'></font>
  REAL                          , INTENT(OUT) :: TOTLB  <font color=#447700>!total living carbon ([g/m2 C]<a name='7941'></font>
  REAL                          , INTENT(OUT) :: XLAI   <font color=#447700>!leaf area index [-]<a name='7942'></font>
  REAL                          , INTENT(OUT) :: XSAI   <font color=#447700>!stem area index [-]<a name='7943'></font>
<font color=#447700>!  REAL                          , INTENT(OUT) :: VOCFLX(5) ! voc fluxes [ug C m-2 h-1]<a name='7944'></font>
<a name='7945'>
<font color=#447700>! local variables<a name='7946'></font>
<a name='7947'>
  INTEGER :: J         <font color=#447700>!do-loop index<a name='7948'></font>
  REAL    :: WROOT     <font color=#447700>!root zone soil water [-]<a name='7949'></font>
  REAL    :: WSTRES    <font color=#447700>!water stress coeficient [-]  (1. for wilting )<a name='7950'></font>
  REAL    :: LAPM      <font color=#447700>!leaf area per unit mass [m2/g]<a name='7951'></font>
<font color=#447700>! ------------------------------------------------------------------------------------------<a name='7952'></font>
<a name='7953'>
   IF ( ( VEGTYP == parameters%iswater ) .OR. ( VEGTYP == parameters%ISBARREN ) .OR. &amp;<a name='7954'>
        ( VEGTYP == parameters%ISICE ) .or. (parameters%urban_flag) ) THEN<a name='7955'>
      XLAI   = 0.<a name='7956'>
      XSAI   = 0.<a name='7957'>
      GPP    = 0.<a name='7958'>
      NPP    = 0.<a name='7959'>
      NEE    = 0.<a name='7960'>
      AUTORS = 0.<a name='7961'>
      HETERS = 0.<a name='7962'>
      TOTSC  = 0.<a name='7963'>
      TOTLB  = 0.<a name='7964'>
      LFMASS = 0.<a name='7965'>
      RTMASS = 0.<a name='7966'>
      STMASS = 0.<a name='7967'>
      WOOD   = 0.<a name='7968'>
      STBLCP = 0.<a name='7969'>
      FASTCP = 0.<a name='7970'>
<a name='7971'>
      RETURN<a name='7972'>
   END IF<a name='7973'>
<a name='7974'>
      LAPM       = parameters%SLA / 1000.   <font color=#447700>! m2/kg -&gt; m2/g<a name='7975'></font>
<a name='7976'>
<font color=#447700>! water stress<a name='7977'></font>
<a name='7978'>
      WSTRES  = 1.- BTRAN<a name='7979'>
<a name='7980'>
      WROOT  = 0.<a name='7981'>
      DO J=1,parameters%NROOT<a name='7982'>
        WROOT = WROOT + SMC(J)/parameters%SMCMAX(J) *  DZSNSO(J) / (-ZSOIL(parameters%NROOT))<a name='7983'>
      ENDDO<a name='7984'>
<a name='7985'>
  CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CO2FLUX'>CO2FLUX</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#CARBON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CO2FLUX_1"> (parameters,NSNOW  ,NSOIL  ,VEGTYP ,IGS    ,DT     , &amp; <font color=#447700>!in<a name='7986'></font>
                DZSNSO ,STC    ,PSN    ,TROOT  ,TV     , &amp; <font color=#447700>!in<a name='7987'></font>
                WROOT  ,WSTRES ,FOLN   ,LAPM   ,         &amp; <font color=#447700>!in<a name='7988'></font>
                LAT    ,ILOC   ,JLOC   ,FVEG   ,         &amp; <font color=#447700>!in<a name='7989'></font>
                XLAI   ,XSAI   ,LFMASS ,RTMASS ,STMASS , &amp; <font color=#447700>!inout<a name='7990'></font>
                FASTCP ,STBLCP ,WOOD   ,                 &amp; <font color=#447700>!inout<a name='7991'></font>
                GPP    ,NPP    ,NEE    ,AUTORS ,HETERS , &amp; <font color=#447700>!out<a name='7992'></font>
                TOTSC  ,TOTLB  )                           <font color=#447700>!out<a name='7993'></font>
<a name='7994'>
<font color=#447700>!   CALL BVOC (parameters,VOCFLX,  VEGTYP,  VEGFAC,   APAR,   TV)<a name='7995'></font>
<font color=#447700>!   CALL CH4<a name='7996'></font>
<a name='7997'>
  END SUBROUTINE CARBON<a name='7998'>
<a name='7999'>
<font color=#447700>!== begin co2flux ==================================================================================<a name='8000'></font>
<a name='8001'>
<A NAME='CO2FLUX'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#CO2FLUX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='8002'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>CO2FLUX</font> (parameters,NSNOW  ,NSOIL  ,VEGTYP ,IGS    ,DT     , &amp; <font color=#447700>!in <A href='../../call_to/CO2FLUX.html' TARGET='index'>1</A><a name='8003'></font>
                      DZSNSO ,STC    ,PSN    ,TROOT  ,TV     , &amp; <font color=#447700>!in<a name='8004'></font>
                      WROOT  ,WSTRES ,FOLN   ,LAPM   ,         &amp; <font color=#447700>!in<a name='8005'></font>
                      LAT    ,ILOC   ,JLOC   ,FVEG   ,         &amp; <font color=#447700>!in<a name='8006'></font>
                      XLAI   ,XSAI   ,LFMASS ,RTMASS ,STMASS , &amp; <font color=#447700>!inout<a name='8007'></font>
                      FASTCP ,STBLCP ,WOOD   ,                 &amp; <font color=#447700>!inout<a name='8008'></font>
                      GPP    ,NPP    ,NEE    ,AUTORS ,HETERS , &amp; <font color=#447700>!out<a name='8009'></font>
                      TOTSC  ,TOTLB  )                           <font color=#447700>!out<a name='8010'></font>
<font color=#447700>! -----------------------------------------------------------------------------------------<a name='8011'></font>
<font color=#447700>! The original code is from RE Dickinson et al.(1998), modifed by Guo-Yue Niu, 2004<a name='8012'></font>
<font color=#447700>! -----------------------------------------------------------------------------------------<a name='8013'></font>
  IMPLICIT NONE<a name='8014'>
<font color=#447700>! -----------------------------------------------------------------------------------------<a name='8015'></font>
<a name='8016'>
<font color=#447700>! input<a name='8017'></font>
<a name='8018'>
  type (noahmp_parameters), intent(in) :: parameters<a name='8019'>
  INTEGER                        , INTENT(IN) :: ILOC   <font color=#447700>!grid index<a name='8020'></font>
  INTEGER                        , INTENT(IN) :: JLOC   <font color=#447700>!grid index<a name='8021'></font>
  INTEGER                        , INTENT(IN) :: VEGTYP <font color=#447700>!vegetation physiology type<a name='8022'></font>
  INTEGER                        , INTENT(IN) :: NSNOW  <font color=#447700>!number of snow layers<a name='8023'></font>
  INTEGER                        , INTENT(IN) :: NSOIL  <font color=#447700>!number of soil layers<a name='8024'></font>
  REAL                           , INTENT(IN) :: DT     <font color=#447700>!time step (s)<a name='8025'></font>
  REAL                           , INTENT(IN) :: LAT    <font color=#447700>!latitude (radians)<a name='8026'></font>
  REAL                           , INTENT(IN) :: IGS    <font color=#447700>!growing season index (0=off, 1=on)<a name='8027'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: DZSNSO <font color=#447700>!snow/soil layer thickness [m]<a name='8028'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: STC    <font color=#447700>!snow/soil temperature [k]<a name='8029'></font>
  REAL                           , INTENT(IN) :: PSN    <font color=#447700>!total leaf photosynthesis (umolco2/m2/s)<a name='8030'></font>
  REAL                           , INTENT(IN) :: TROOT  <font color=#447700>!root-zone averaged temperature (k)<a name='8031'></font>
  REAL                           , INTENT(IN) :: TV     <font color=#447700>!leaf temperature (k)<a name='8032'></font>
  REAL                           , INTENT(IN) :: WROOT  <font color=#447700>!root zone soil water<a name='8033'></font>
  REAL                           , INTENT(IN) :: WSTRES <font color=#447700>!soil water stress<a name='8034'></font>
  REAL                           , INTENT(IN) :: FOLN   <font color=#447700>!foliage nitrogen (%)<a name='8035'></font>
  REAL                           , INTENT(IN) :: LAPM   <font color=#447700>!leaf area per unit mass [m2/g]<a name='8036'></font>
  REAL                           , INTENT(IN) :: FVEG   <font color=#447700>!vegetation greenness fraction<a name='8037'></font>
<a name='8038'>
<font color=#447700>! input and output<a name='8039'></font>
<a name='8040'>
  REAL                        , INTENT(INOUT) :: XLAI   <font color=#447700>!leaf  area index from leaf carbon [-]<a name='8041'></font>
  REAL                        , INTENT(INOUT) :: XSAI   <font color=#447700>!stem area index from leaf carbon [-]<a name='8042'></font>
  REAL                        , INTENT(INOUT) :: LFMASS <font color=#447700>!leaf mass [g/m2]<a name='8043'></font>
  REAL                        , INTENT(INOUT) :: RTMASS <font color=#447700>!mass of fine roots [g/m2]<a name='8044'></font>
  REAL                        , INTENT(INOUT) :: STMASS <font color=#447700>!stem mass [g/m2]<a name='8045'></font>
  REAL                        , INTENT(INOUT) :: FASTCP <font color=#447700>!short lived carbon [g/m2]<a name='8046'></font>
  REAL                        , INTENT(INOUT) :: STBLCP <font color=#447700>!stable carbon pool [g/m2]<a name='8047'></font>
  REAL                        , INTENT(INOUT) :: WOOD   <font color=#447700>!mass of wood (incl. woody roots) [g/m2]<a name='8048'></font>
<a name='8049'>
<font color=#447700>! output<a name='8050'></font>
<a name='8051'>
  REAL                          , INTENT(OUT) :: GPP    <font color=#447700>!net instantaneous assimilation [g/m2/s]<a name='8052'></font>
  REAL                          , INTENT(OUT) :: NPP    <font color=#447700>!net primary productivity [g/m2]<a name='8053'></font>
  REAL                          , INTENT(OUT) :: NEE    <font color=#447700>!net ecosystem exchange (autors+heters-gpp)<a name='8054'></font>
  REAL                          , INTENT(OUT) :: AUTORS <font color=#447700>!net ecosystem resp. (maintance and growth)<a name='8055'></font>
  REAL                          , INTENT(OUT) :: HETERS <font color=#447700>!organic respiration<a name='8056'></font>
  REAL                          , INTENT(OUT) :: TOTSC  <font color=#447700>!total soil carbon (g/m2)<a name='8057'></font>
  REAL                          , INTENT(OUT) :: TOTLB  <font color=#447700>!total living carbon (g/m2)<a name='8058'></font>
<a name='8059'>
<font color=#447700>! local<a name='8060'></font>
<a name='8061'>
  REAL                   :: CFLUX    <font color=#447700>!carbon flux to atmosphere [g/m2/s]<a name='8062'></font>
  REAL                   :: LFMSMN   <font color=#447700>!minimum leaf mass [g/m2]<a name='8063'></font>
  REAL                   :: RSWOOD   <font color=#447700>!wood respiration [g/m2]<a name='8064'></font>
  REAL                   :: RSLEAF   <font color=#447700>!leaf maintenance respiration per timestep [g/m2]<a name='8065'></font>
  REAL                   :: RSROOT   <font color=#447700>!fine root respiration per time step [g/m2]<a name='8066'></font>
  REAL                   :: NPPL     <font color=#447700>!leaf net primary productivity [g/m2/s]<a name='8067'></font>
  REAL                   :: NPPR     <font color=#447700>!root net primary productivity [g/m2/s]<a name='8068'></font>
  REAL                   :: NPPW     <font color=#447700>!wood net primary productivity [g/m2/s]<a name='8069'></font>
  REAL                   :: NPPS     <font color=#447700>!wood net primary productivity [g/m2/s]<a name='8070'></font>
  REAL                   :: DIELF    <font color=#447700>!death of leaf mass per time step [g/m2]<a name='8071'></font>
<a name='8072'>
  REAL                   :: ADDNPPLF <font color=#447700>!leaf assimil after resp. losses removed [g/m2]<a name='8073'></font>
  REAL                   :: ADDNPPST <font color=#447700>!stem assimil after resp. losses removed [g/m2]<a name='8074'></font>
  REAL                   :: CARBFX   <font color=#447700>!carbon assimilated per model step [g/m2]<a name='8075'></font>
  REAL                   :: GRLEAF   <font color=#447700>!growth respiration rate for leaf [g/m2/s]<a name='8076'></font>
  REAL                   :: GRROOT   <font color=#447700>!growth respiration rate for root [g/m2/s]<a name='8077'></font>
  REAL                   :: GRWOOD   <font color=#447700>!growth respiration rate for wood [g/m2/s]<a name='8078'></font>
  REAL                   :: GRSTEM   <font color=#447700>!growth respiration rate for stem [g/m2/s]<a name='8079'></font>
  REAL                   :: LEAFPT   <font color=#447700>!fraction of carbon allocated to leaves [-]<a name='8080'></font>
  REAL                   :: LFDEL    <font color=#447700>!maximum  leaf mass  available to change [g/m2/s]<a name='8081'></font>
  REAL                   :: LFTOVR   <font color=#447700>!stem turnover per time step [g/m2]<a name='8082'></font>
  REAL                   :: STTOVR   <font color=#447700>!stem turnover per time step [g/m2]<a name='8083'></font>
  REAL                   :: WDTOVR   <font color=#447700>!wood turnover per time step [g/m2]<a name='8084'></font>
  REAL                   :: RSSOIL   <font color=#447700>!soil respiration per time step [g/m2]<a name='8085'></font>
  REAL                   :: RTTOVR   <font color=#447700>!root carbon loss per time step by turnover [g/m2]<a name='8086'></font>
  REAL                   :: STABLC   <font color=#447700>!decay rate of fast carbon to slow carbon [g/m2/s]<a name='8087'></font>
  REAL                   :: WOODF    <font color=#447700>!calculated wood to root ratio [-]<a name='8088'></font>
  REAL                   :: NONLEF   <font color=#447700>!fraction of carbon to root and wood [-]<a name='8089'></font>
  REAL                   :: ROOTPT   <font color=#447700>!fraction of carbon flux to roots [-]<a name='8090'></font>
  REAL                   :: WOODPT   <font color=#447700>!fraction of carbon flux to wood [-]<a name='8091'></font>
  REAL                   :: STEMPT   <font color=#447700>!fraction of carbon flux to stem [-]<a name='8092'></font>
  REAL                   :: RESP     <font color=#447700>!leaf respiration [umol/m2/s]<a name='8093'></font>
  REAL                   :: RSSTEM   <font color=#447700>!stem respiration [g/m2/s]<a name='8094'></font>
<a name='8095'>
  REAL                   :: FSW      <font color=#447700>!soil water factor for microbial respiration<a name='8096'></font>
  REAL                   :: FST      <font color=#447700>!soil temperature factor for microbial respiration<a name='8097'></font>
  REAL                   :: FNF      <font color=#447700>!foliage nitrogen adjustemt to respiration (&lt;= 1)<a name='8098'></font>
  REAL                   :: TF       <font color=#447700>!temperature factor<a name='8099'></font>
  REAL                   :: RF       <font color=#447700>!respiration reduction factor (&lt;= 1)<a name='8100'></font>
  REAL                   :: STDEL<a name='8101'>
  REAL                   :: STMSMN<a name='8102'>
  REAL                   :: SAPM     <font color=#447700>!stem area per unit mass (m2/g)<a name='8103'></font>
  REAL                   :: DIEST<a name='8104'>
<font color=#447700>! -------------------------- constants -------------------------------<a name='8105'></font>
  REAL                   :: BF       <font color=#447700>!parameter for present wood allocation [-]<a name='8106'></font>
  REAL                   :: RSWOODC  <font color=#447700>!wood respiration coeficient [1/s]<a name='8107'></font>
  REAL                   :: STOVRC   <font color=#447700>!stem turnover coefficient [1/s]<a name='8108'></font>
  REAL                   :: RSDRYC   <font color=#447700>!degree of drying that reduces soil respiration [-]<a name='8109'></font>
  REAL                   :: RTOVRC   <font color=#447700>!root turnover coefficient [1/s]<a name='8110'></font>
  REAL                   :: WSTRC    <font color=#447700>!water stress coeficient [-]<a name='8111'></font>
  REAL                   :: LAIMIN   <font color=#447700>!minimum leaf area index [m2/m2]<a name='8112'></font>
  REAL                   :: XSAMIN   <font color=#447700>!minimum leaf area index [m2/m2]<a name='8113'></font>
  REAL                   :: SC<a name='8114'>
  REAL                   :: SD<a name='8115'>
  REAL                   :: VEGFRAC<a name='8116'>
<a name='8117'>
<font color=#447700>! Respiration as a function of temperature<a name='8118'></font>
<a name='8119'>
  real :: r,x<a name='8120'>
          r(x) = exp(0.08*(x-298.16))<a name='8121'>
<font color=#447700>! ---------------------------------------------------------------------------------<a name='8122'></font>
<a name='8123'>
<font color=#447700>! constants<a name='8124'></font>
    RTOVRC  = 2.0E-8        <font color=#447700>!original was 2.0e-8<a name='8125'></font>
    RSDRYC  = 40.0          <font color=#447700>!original was 40.0<a name='8126'></font>
    RSWOODC = 3.0E-10       <font color=#447700>!<a name='8127'></font>
    BF      = 0.90          <font color=#447700>!original was 0.90   ! carbon to roots<a name='8128'></font>
    WSTRC   = 100.0<a name='8129'>
    LAIMIN  = 0.05   <a name='8130'>
    XSAMIN  = 0.05     <font color=#447700>! MB: change to prevent vegetation from not growing back in spring<a name='8131'></font>
<a name='8132'>
    SAPM    = 3.*0.001      <font color=#447700>! m2/kg --&gt;m2/g<a name='8133'></font>
    LFMSMN  = laimin/lapm<a name='8134'>
    STMSMN  = xsamin/sapm<a name='8135'>
<font color=#447700>! ---------------------------------------------------------------------------------<a name='8136'></font>
<a name='8137'>
<font color=#447700>! respiration<a name='8138'></font>
<a name='8139'>
     IF(IGS .EQ. 0.) THEN<a name='8140'>
       RF = 0.5<a name='8141'>
     ELSE<a name='8142'>
       RF = 1.0<a name='8143'>
     ENDIF<a name='8144'>
            <a name='8145'>
     FNF     = MIN( FOLN/MAX(1.E-06,parameters%FOLNMX), 1.0 )<a name='8146'>
     TF      = parameters%ARM**( (TV-298.16)/10. )<a name='8147'>
     RESP    = parameters%RMF25 * TF * FNF * XLAI * RF * (1.-WSTRES) <font color=#447700>! umol/m2/s<a name='8148'></font>
     RSLEAF  = MIN((LFMASS-LFMSMN)/DT,RESP*12.e-6)                         <font color=#447700>! g/m2/s<a name='8149'></font>
     <a name='8150'>
     RSROOT  = parameters%RMR25*(RTMASS*1E-3)*TF *RF* 12.e-6         <font color=#447700>! g/m2/s<a name='8151'></font>
     RSSTEM  = parameters%RMS25*((STMASS-STMSMN)*1E-3)*TF *RF* 12.e-6         <font color=#447700>! g/m2/s<a name='8152'></font>
     RSWOOD  = RSWOODC * R(TV) * WOOD*parameters%WDPOOL<a name='8153'>
<a name='8154'>
<font color=#447700>! carbon assimilation<a name='8155'></font>
<font color=#447700>! 1 mole -&gt; 12 g carbon or 44 g CO2; 1 umol -&gt; 12.e-6 g carbon;<a name='8156'></font>
<a name='8157'>
     CARBFX  = PSN * 12.e-6              <font color=#447700>! umol co2 /m2/ s -&gt; g/m2/s carbon<a name='8158'></font>
<a name='8159'>
<font color=#447700>! fraction of carbon into leaf versus nonleaf<a name='8160'></font>
<a name='8161'>
     LEAFPT = EXP(0.01*(1.-EXP(0.75*XLAI))*XLAI)<a name='8162'>
     IF(VEGTYP == parameters%EBLFOREST) LEAFPT = EXP(0.01*(1.-EXP(0.50*XLAI))*XLAI)<a name='8163'>
<a name='8164'>
     NONLEF = 1.0 - LEAFPT<a name='8165'>
     STEMPT = XLAI/10.0*LEAFPT<a name='8166'>
     LEAFPT = LEAFPT - STEMPT<a name='8167'>
<a name='8168'>
<font color=#447700>!  fraction of carbon into wood versus root<a name='8169'></font>
<a name='8170'>
     IF(WOOD &gt; 1.e-6) THEN<a name='8171'>
        WOODF = (1.-EXP(-BF*(parameters%WRRAT*RTMASS/WOOD))/BF)*parameters%WDPOOL<a name='8172'>
     ELSE<a name='8173'>
        WOODF = parameters%WDPOOL<a name='8174'>
     ENDIF<a name='8175'>
<a name='8176'>
     ROOTPT = NONLEF*(1.-WOODF)<a name='8177'>
     WOODPT = NONLEF*WOODF<a name='8178'>
<a name='8179'>
<font color=#447700>! leaf and root turnover per time step<a name='8180'></font>
<a name='8181'>
     LFTOVR = parameters%LTOVRC*5.E-7*LFMASS<a name='8182'>
     STTOVR = parameters%LTOVRC*5.E-7*STMASS<a name='8183'>
     RTTOVR = RTOVRC*RTMASS<a name='8184'>
     WDTOVR = 9.5E-10*WOOD<a name='8185'>
<a name='8186'>
<font color=#447700>! seasonal leaf die rate dependent on temp and water stress<a name='8187'></font>
<font color=#447700>! water stress is set to 1 at permanent wilting point<a name='8188'></font>
<a name='8189'>
     SC  = EXP(-0.3*MAX(0.,TV-parameters%TDLEF)) * (LFMASS/120.) <a name='8190'>
     SD  = EXP((WSTRES-1.)*WSTRC)<a name='8191'>
     DIELF = LFMASS*1.E-6*(parameters%DILEFW * SD + parameters%DILEFC*SC)<a name='8192'>
     DIEST = STMASS*1.E-6*(parameters%DILEFW * SD + parameters%DILEFC*SC)<a name='8193'>
<a name='8194'>
<font color=#447700>! calculate growth respiration for leaf, rtmass and wood<a name='8195'></font>
<a name='8196'>
     GRLEAF = MAX(0.0,parameters%FRAGR*(LEAFPT*CARBFX - RSLEAF))<a name='8197'>
     GRSTEM = MAX(0.0,parameters%FRAGR*(STEMPT*CARBFX - RSSTEM))<a name='8198'>
     GRROOT = MAX(0.0,parameters%FRAGR*(ROOTPT*CARBFX - RSROOT))<a name='8199'>
     GRWOOD = MAX(0.0,parameters%FRAGR*(WOODPT*CARBFX - RSWOOD))<a name='8200'>
<a name='8201'>
<font color=#447700>! Impose lower T limit for photosynthesis<a name='8202'></font>
<a name='8203'>
     ADDNPPLF = MAX(0.,LEAFPT*CARBFX - GRLEAF-RSLEAF)<a name='8204'>
     ADDNPPST = MAX(0.,STEMPT*CARBFX - GRSTEM-RSSTEM)<a name='8205'>
<font color=#447700>!     ADDNPPLF = LEAFPT*CARBFX - GRLEAF-RSLEAF  ! MB: test Kjetil <a name='8206'></font>
<font color=#447700>!     ADDNPPST = STEMPT*CARBFX - GRSTEM-RSSTEM  ! MB: test Kjetil <a name='8207'></font>
     IF(TV.LT.parameters%TMIN) ADDNPPLF =0.<a name='8208'>
     IF(TV.LT.parameters%TMIN) ADDNPPST =0.<a name='8209'>
<a name='8210'>
<font color=#447700>! update leaf, root, and wood carbon<a name='8211'></font>
<font color=#447700>! avoid reducing leaf mass below its minimum value but conserve mass<a name='8212'></font>
<a name='8213'>
     LFDEL = (LFMASS - LFMSMN)/DT<a name='8214'>
     STDEL = (STMASS - STMSMN)/DT<a name='8215'>
     DIELF = MIN(DIELF,LFDEL+ADDNPPLF-LFTOVR)<a name='8216'>
     DIEST = MIN(DIEST,STDEL+ADDNPPST-STTOVR)<a name='8217'>
<a name='8218'>
<font color=#447700>! net primary productivities<a name='8219'></font>
<a name='8220'>
     NPPL   = MAX(ADDNPPLF,-LFDEL)<a name='8221'>
     NPPS   = MAX(ADDNPPST,-STDEL)<a name='8222'>
     NPPR   = ROOTPT*CARBFX - RSROOT - GRROOT<a name='8223'>
     NPPW   = WOODPT*CARBFX - RSWOOD - GRWOOD<a name='8224'>
<a name='8225'>
<font color=#447700>! masses of plant components<a name='8226'></font>
<a name='8227'>
     LFMASS = LFMASS + (NPPL-LFTOVR-DIELF)*DT<a name='8228'>
     STMASS = STMASS + (NPPS-STTOVR-DIEST)*DT   <font color=#447700>! g/m2<a name='8229'></font>
     RTMASS = RTMASS + (NPPR-RTTOVR)      *DT<a name='8230'>
<a name='8231'>
     IF(RTMASS.LT.0.0) THEN<a name='8232'>
           RTTOVR = NPPR<a name='8233'>
           RTMASS = 0.0<a name='8234'>
     ENDIF<a name='8235'>
     WOOD = (WOOD+(NPPW-WDTOVR)*DT)*parameters%WDPOOL<a name='8236'>
<a name='8237'>
<font color=#447700>! soil carbon budgets<a name='8238'></font>
<a name='8239'>
     FASTCP = FASTCP + (RTTOVR+LFTOVR+STTOVR+WDTOVR+DIELF+DIEST)*DT  <font color=#447700>! MB: add DIEST v3.7<a name='8240'></font>
<a name='8241'>
     FST = 2.0**( (STC(1)-283.16)/10. )<a name='8242'>
     FSW = WROOT / (0.20+WROOT) * 0.23 / (0.23+WROOT)<a name='8243'>
     RSSOIL = FSW * FST * parameters%MRP* MAX(0.,FASTCP*1.E-3)*12.E-6<a name='8244'>
<a name='8245'>
     STABLC = 0.1*RSSOIL<a name='8246'>
     FASTCP = FASTCP - (RSSOIL + STABLC)*DT<a name='8247'>
     STBLCP = STBLCP + STABLC*DT<a name='8248'>
<a name='8249'>
<font color=#447700>!  total carbon flux<a name='8250'></font>
<a name='8251'>
     CFLUX  = - CARBFX + RSLEAF + RSROOT + RSWOOD + RSSTEM &amp;  <font color=#447700>! MB: add RSSTEM,GRSTEM,0.9*RSSOIL v3.7<a name='8252'></font>
          + 0.9*RSSOIL + GRLEAF + GRROOT + GRWOOD + GRSTEM    <font color=#447700>! g/m2/s<a name='8253'></font>
<a name='8254'>
<font color=#447700>! for outputs<a name='8255'></font>
<a name='8256'>
     GPP    = CARBFX                                             <font color=#447700>!g/m2/s C<a name='8257'></font>
     NPP    = NPPL + NPPW + NPPR +NPPS                           <font color=#447700>!g/m2/s C<a name='8258'></font>
     AUTORS = RSROOT + RSWOOD  + RSLEAF + RSSTEM + &amp;             <font color=#447700>!g/m2/s C  MB: add RSSTEM, GRSTEM v3.7<a name='8259'></font>
              GRLEAF + GRROOT + GRWOOD + GRSTEM                  <font color=#447700>!g/m2/s C  MB: add 0.9* v3.7<a name='8260'></font>
     HETERS = 0.9*RSSOIL                                         <font color=#447700>!g/m2/s C<a name='8261'></font>
     NEE    = (AUTORS + HETERS - GPP)*44./12.                    <font color=#447700>!g/m2/s CO2<a name='8262'></font>
     TOTSC  = FASTCP + STBLCP                                    <font color=#447700>!g/m2   C<a name='8263'></font>
     TOTLB  = LFMASS + RTMASS +STMASS + WOOD                     <font color=#447700>!g/m2   C  MB: add STMASS v3.7<a name='8264'></font>
<a name='8265'>
<font color=#447700>! leaf area index and stem area index<a name='8266'></font>
<a name='8267'>
     XLAI    = MAX(LFMASS*LAPM,LAIMIN)<a name='8268'>
     XSAI    = MAX(STMASS*SAPM,XSAMIN)<a name='8269'>
    <a name='8270'>
  END SUBROUTINE CO2FLUX<a name='8271'>
<a name='8272'>
<font color=#447700>!== begin carbon_crop ==============================================================================<a name='8273'></font>
<a name='8274'>
<A NAME='CARBON_CROP'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#CARBON_CROP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='8275'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>CARBON_CROP</font> (parameters,NSNOW  ,NSOIL  ,VEGTYP ,DT     ,ZSOIL  ,JULIAN , &amp; <font color=#447700>!in <A href='../../call_to/CARBON_CROP.html' TARGET='index'>1</A>,<A href='../../call_from/CARBON_CROP.html' TARGET='index'>3</A><a name='8276'></font>
                            DZSNSO ,STC    ,SMC    ,TV     ,PSN    ,FOLN   ,BTRAN  , &amp; <font color=#447700>!in<a name='8277'></font>
                            SOLDN  ,T2M    ,                                         &amp; <font color=#447700>!in<a name='8278'></font>
                            LFMASS ,RTMASS ,STMASS ,WOOD   ,STBLCP ,FASTCP ,GRAIN  , &amp; <font color=#447700>!inout<a name='8279'></font>
			    XLAI   ,XSAI   ,GDD    ,                                 &amp; <font color=#447700>!inout<a name='8280'></font>
                            GPP    ,NPP    ,NEE    ,AUTORS ,HETERS ,TOTSC  ,TOTLB, PGS    ) <font color=#447700>!out<a name='8281'></font>
<font color=#447700>! ------------------------------------------------------------------------------------------<a name='8282'></font>
<font color=#447700>! Initial crop version created by Xing Liu<a name='8283'></font>
<font color=#447700>! Initial crop version added by Barlage v3.8<a name='8284'></font>
<a name='8285'>
<font color=#447700>! ------------------------------------------------------------------------------------------<a name='8286'></font>
      IMPLICIT NONE<a name='8287'>
<font color=#447700>! ------------------------------------------------------------------------------------------<a name='8288'></font>
<font color=#447700>! inputs (carbon)<a name='8289'></font>
<a name='8290'>
  type (noahmp_parameters), intent(in) :: parameters<a name='8291'>
  INTEGER                        , INTENT(IN) :: NSNOW  <font color=#447700>!number of snow layers<a name='8292'></font>
  INTEGER                        , INTENT(IN) :: NSOIL  <font color=#447700>!number of soil layers<a name='8293'></font>
  INTEGER                        , INTENT(IN) :: VEGTYP <font color=#447700>!vegetation type <a name='8294'></font>
  REAL                           , INTENT(IN) :: DT     <font color=#447700>!time step (s)<a name='8295'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN) :: ZSOIL  <font color=#447700>!depth of layer-bottomfrom soil surface<a name='8296'></font>
  REAL                           , INTENT(IN) :: JULIAN <font color=#447700>!Julian day of year(fractional) ( 0 &lt;= JULIAN &lt; YEARLEN )<a name='8297'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: DZSNSO <font color=#447700>!snow/soil layerthickness [m]<a name='8298'></font>
  REAL, DIMENSION(-NSNOW+1:NSOIL), INTENT(IN) :: STC    <font color=#447700>!snow/soil temperature[k]<a name='8299'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN) :: SMC    <font color=#447700>!soil moisture (ice +liq.) [m3/m3]<a name='8300'></font>
  REAL                           , INTENT(IN) :: TV     <font color=#447700>!vegetation temperature(k)<a name='8301'></font>
  REAL                           , INTENT(IN) :: PSN    <font color=#447700>!total leaf photosyn(umolco2/m2/s) [+]<a name='8302'></font>
  REAL                           , INTENT(IN) :: FOLN   <font color=#447700>!foliage nitrogen (%)<a name='8303'></font>
  REAL                           , INTENT(IN) :: BTRAN  <font color=#447700>!soil watertranspiration factor (0 to 1)<a name='8304'></font>
  REAL                           , INTENT(IN) :: SOLDN  <font color=#447700>!Downward solar radiation<a name='8305'></font>
  REAL                           , INTENT(IN) :: T2M    <font color=#447700>!air temperature<a name='8306'></font>
<a name='8307'>
<font color=#447700>! input &amp; output (carbon)<a name='8308'></font>
<a name='8309'>
  REAL                        , INTENT(INOUT) :: LFMASS <font color=#447700>!leaf mass [g/m2]<a name='8310'></font>
  REAL                        , INTENT(INOUT) :: RTMASS <font color=#447700>!mass of fine roots[g/m2]<a name='8311'></font>
  REAL                        , INTENT(INOUT) :: STMASS <font color=#447700>!stem mass [g/m2]<a name='8312'></font>
  REAL                        , INTENT(INOUT) :: WOOD   <font color=#447700>!mass of wood (incl.woody roots) [g/m2]<a name='8313'></font>
  REAL                        , INTENT(INOUT) :: STBLCP <font color=#447700>!stable carbon in deepsoil [g/m2]<a name='8314'></font>
  REAL                        , INTENT(INOUT) :: FASTCP <font color=#447700>!short-lived carbon inshallow soil [g/m2]<a name='8315'></font>
  REAL                        , INTENT(INOUT) :: GRAIN  <font color=#447700>!mass of GRAIN [g/m2]<a name='8316'></font>
  REAL                        , INTENT(INOUT) :: XLAI   <font color=#447700>!leaf area index [-]<a name='8317'></font>
  REAL                        , INTENT(INOUT) :: XSAI   <font color=#447700>!stem area index [-]<a name='8318'></font>
  REAL                        , INTENT(INOUT) :: GDD    <font color=#447700>!growing degree days<a name='8319'></font>
<a name='8320'>
<font color=#447700>! outout<a name='8321'></font>
  REAL                          , INTENT(OUT) :: GPP    <font color=#447700>!net instantaneous assimilation [g/m2/s C]<a name='8322'></font>
  REAL                          , INTENT(OUT) :: NPP    <font color=#447700>!net primary productivity [g/m2/s C]<a name='8323'></font>
  REAL                          , INTENT(OUT) :: NEE    <font color=#447700>!net ecosystem exchange[g/m2/s CO2]<a name='8324'></font>
  REAL                          , INTENT(OUT) :: AUTORS <font color=#447700>!net ecosystem respiration [g/m2/s C]<a name='8325'></font>
  REAL                          , INTENT(OUT) :: HETERS <font color=#447700>!organic respiration[g/m2/s C]<a name='8326'></font>
  REAL                          , INTENT(OUT) :: TOTSC  <font color=#447700>!total soil carbon [g/m2C]<a name='8327'></font>
  REAL                          , INTENT(OUT) :: TOTLB  <font color=#447700>!total living carbon ([g/m2 C]<a name='8328'></font>
<a name='8329'>
<font color=#447700>! local variables<a name='8330'></font>
<a name='8331'>
  INTEGER :: J         <font color=#447700>!do-loop index<a name='8332'></font>
  REAL    :: WROOT     <font color=#447700>!root zone soil water [-]<a name='8333'></font>
  REAL    :: WSTRES    <font color=#447700>!water stress coeficient [-]  (1. for wilting )<a name='8334'></font>
  INTEGER :: IPA       <font color=#447700>!Planting index<a name='8335'></font>
  INTEGER :: IHA       <font color=#447700>!Havestindex(0=on,1=off)<a name='8336'></font>
  INTEGER, INTENT(OUT) :: PGS       <font color=#447700>!Plant growth stage<a name='8337'></font>
<a name='8338'>
  REAL    :: PSNCROP <a name='8339'>
<a name='8340'>
<font color=#447700>! ------------------------------------------------------------------------------------------<a name='8341'></font>
   IF ( ( VEGTYP == parameters%iswater ) .OR. ( VEGTYP == parameters%ISBARREN ) .OR. &amp;<a name='8342'>
        ( VEGTYP == parameters%ISICE ) .or. (parameters%urban_flag) ) THEN<a name='8343'>
      XLAI   = 0.<a name='8344'>
      XSAI   = 0.<a name='8345'>
      GPP    = 0.<a name='8346'>
      NPP    = 0.<a name='8347'>
      NEE    = 0.<a name='8348'>
      AUTORS = 0.<a name='8349'>
      HETERS = 0.<a name='8350'>
      TOTSC  = 0.<a name='8351'>
      TOTLB  = 0.<a name='8352'>
      LFMASS = 0.<a name='8353'>
      RTMASS = 0.<a name='8354'>
      STMASS = 0.<a name='8355'>
      WOOD   = 0.<a name='8356'>
      STBLCP = 0.<a name='8357'>
      FASTCP = 0.<a name='8358'>
      GRAIN  = 0.<a name='8359'>
      RETURN<a name='8360'>
   END IF<a name='8361'>
<a name='8362'>
<font color=#447700>! water stress<a name='8363'></font>
<a name='8364'>
<a name='8365'>
   WSTRES  = 1.- BTRAN<a name='8366'>
<a name='8367'>
   WROOT  = 0.<a name='8368'>
   DO J=1,parameters%NROOT<a name='8369'>
     WROOT = WROOT + SMC(J)/parameters%SMCMAX(J) *  DZSNSO(J) / (-ZSOIL(parameters%NROOT))<a name='8370'>
   ENDDO<a name='8371'>
<a name='8372'>
   CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#PSN_CROP'>PSN_CROP</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#CARBON_CROP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSN_CROP_1">     ( parameters,                           &amp; <font color=#447700>!in<a name='8373'></font>
                       SOLDN,   XLAI,    T2M,                &amp; <font color=#447700>!in <a name='8374'></font>
                       PSNCROP                             )   <font color=#447700>!out<a name='8375'></font>
<a name='8376'>
   CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#GROWING_GDD'>GROWING_GDD</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#CARBON_CROP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GROWING_GDD_1">  (parameters,                           &amp; <font color=#447700>!in<a name='8377'></font>
                      T2M ,   DT,  JULIAN,                  &amp; <font color=#447700>!in<a name='8378'></font>
                      GDD ,                                 &amp; <font color=#447700>!inout <a name='8379'></font>
                      IPA ,  IHA,     PGS)                    <font color=#447700>!out                        <a name='8380'></font>
<a name='8381'>
   CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CO2FLUX_CROP'>CO2FLUX_CROP</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#CARBON_CROP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CO2FLUX_CROP_1"> (parameters,                              &amp; <font color=#447700>!in<a name='8382'></font>
                      DT     ,STC(1) ,PSN    ,TV     ,WROOT  ,WSTRES ,FOLN   , &amp; <font color=#447700>!in<a name='8383'></font>
                      IPA    ,IHA    ,PGS    ,                                 &amp; <font color=#447700>!in XING<a name='8384'></font>
                      XLAI   ,XSAI   ,LFMASS ,RTMASS ,STMASS ,                 &amp; <font color=#447700>!inout<a name='8385'></font>
                      FASTCP ,STBLCP ,WOOD   ,GRAIN  ,GDD    ,                 &amp; <font color=#447700>!inout<a name='8386'></font>
                      GPP    ,NPP    ,NEE    ,AUTORS ,HETERS ,                 &amp; <font color=#447700>!out<a name='8387'></font>
                      TOTSC  ,TOTLB  )                                           <font color=#447700>!out<a name='8388'></font>
<a name='8389'>
  END SUBROUTINE CARBON_CROP<a name='8390'>
<a name='8391'>
<font color=#447700>!== begin co2flux_crop =============================================================================<a name='8392'></font>
<a name='8393'>
<A NAME='CO2FLUX_CROP'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#CO2FLUX_CROP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='8394'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>CO2FLUX_CROP</font> (parameters,                                              &amp; <font color=#447700>!in <A href='../../call_to/CO2FLUX_CROP.html' TARGET='index'>1</A><a name='8395'></font>
                           DT     ,STC    ,PSN    ,TV     ,WROOT  ,WSTRES ,FOLN   , &amp; <font color=#447700>!in<a name='8396'></font>
                           IPA    ,IHA    ,PGS    ,                                 &amp; <font color=#447700>!in XING<a name='8397'></font>
                           XLAI   ,XSAI   ,LFMASS ,RTMASS ,STMASS ,                 &amp; <font color=#447700>!inout<a name='8398'></font>
                           FASTCP ,STBLCP ,WOOD   ,GRAIN  ,GDD,                     &amp; <font color=#447700>!inout<a name='8399'></font>
                           GPP    ,NPP    ,NEE    ,AUTORS ,HETERS ,                 &amp; <font color=#447700>!out<a name='8400'></font>
                           TOTSC  ,TOTLB  )                                           <font color=#447700>!out<a name='8401'></font>
<font color=#447700>! -----------------------------------------------------------------------------------------<a name='8402'></font>
<font color=#447700>! The original code from RE Dickinson et al.(1998) and Guo-Yue Niu(2004),<a name='8403'></font>
<font color=#447700>! modified by Xing Liu, 2014.<a name='8404'></font>
<font color=#447700>! <a name='8405'></font>
<font color=#447700>! -----------------------------------------------------------------------------------------<a name='8406'></font>
  IMPLICIT NONE<a name='8407'>
<font color=#447700>! -----------------------------------------------------------------------------------------<a name='8408'></font>
<a name='8409'>
<font color=#447700>! input<a name='8410'></font>
<a name='8411'>
  type (noahmp_parameters), intent(in) :: parameters<a name='8412'>
  REAL                           , INTENT(IN) :: DT     <font color=#447700>!time step (s)<a name='8413'></font>
  REAL                           , INTENT(IN) :: STC    <font color=#447700>!soil temperature[k]<a name='8414'></font>
  REAL                           , INTENT(IN) :: PSN    <font color=#447700>!total leaf photosynthesis (umolco2/m2/s)<a name='8415'></font>
  REAL                           , INTENT(IN) :: TV     <font color=#447700>!leaf temperature (k)<a name='8416'></font>
  REAL                           , INTENT(IN) :: WROOT  <font color=#447700>!root zone soil water<a name='8417'></font>
  REAL                           , INTENT(IN) :: WSTRES <font color=#447700>!soil water stress<a name='8418'></font>
  REAL                           , INTENT(IN) :: FOLN   <font color=#447700>!foliage nitrogen (%)<a name='8419'></font>
  INTEGER                        , INTENT(IN) :: IPA<a name='8420'>
  INTEGER                        , INTENT(IN) :: IHA<a name='8421'>
  INTEGER                        , INTENT(IN) :: PGS<a name='8422'>
<a name='8423'>
<font color=#447700>! input and output<a name='8424'></font>
<a name='8425'>
  REAL                        , INTENT(INOUT) :: XLAI   <font color=#447700>!leaf  area index from leaf carbon [-]<a name='8426'></font>
  REAL                        , INTENT(INOUT) :: XSAI   <font color=#447700>!stem area index from leaf carbon [-]<a name='8427'></font>
  REAL                        , INTENT(INOUT) :: LFMASS <font color=#447700>!leaf mass [g/m2]<a name='8428'></font>
  REAL                        , INTENT(INOUT) :: RTMASS <font color=#447700>!mass of fine roots [g/m2]<a name='8429'></font>
  REAL                        , INTENT(INOUT) :: STMASS <font color=#447700>!stem mass [g/m2]<a name='8430'></font>
  REAL                        , INTENT(INOUT) :: FASTCP <font color=#447700>!short lived carbon [g/m2]<a name='8431'></font>
  REAL                        , INTENT(INOUT) :: STBLCP <font color=#447700>!stable carbon pool [g/m2]<a name='8432'></font>
  REAL                        , INTENT(INOUT) :: WOOD   <font color=#447700>!mass of wood (incl. woody roots) [g/m2]<a name='8433'></font>
  REAL                        , INTENT(INOUT) :: GRAIN  <font color=#447700>!mass of grain (XING) [g/m2]<a name='8434'></font>
  REAL                        , INTENT(INOUT) :: GDD    <font color=#447700>!growing degree days (XING)<a name='8435'></font>
<a name='8436'>
<font color=#447700>! output<a name='8437'></font>
<a name='8438'>
  REAL                          , INTENT(OUT) :: GPP    <font color=#447700>!net instantaneous assimilation [g/m2/s]<a name='8439'></font>
  REAL                          , INTENT(OUT) :: NPP    <font color=#447700>!net primary productivity [g/m2]<a name='8440'></font>
  REAL                          , INTENT(OUT) :: NEE    <font color=#447700>!net ecosystem exchange (autors+heters-gpp)<a name='8441'></font>
  REAL                          , INTENT(OUT) :: AUTORS <font color=#447700>!net ecosystem resp. (maintance and growth)<a name='8442'></font>
  REAL                          , INTENT(OUT) :: HETERS <font color=#447700>!organic respiration<a name='8443'></font>
  REAL                          , INTENT(OUT) :: TOTSC  <font color=#447700>!total soil carbon (g/m2)<a name='8444'></font>
  REAL                          , INTENT(OUT) :: TOTLB  <font color=#447700>!total living carbon (g/m2)<a name='8445'></font>
<a name='8446'>
<font color=#447700>! local<a name='8447'></font>
<a name='8448'>
  REAL                   :: CFLUX    <font color=#447700>!carbon flux to atmosphere [g/m2/s]<a name='8449'></font>
  REAL                   :: LFMSMN   <font color=#447700>!minimum leaf mass [g/m2]<a name='8450'></font>
  REAL                   :: RSWOOD   <font color=#447700>!wood respiration [g/m2]<a name='8451'></font>
  REAL                   :: RSLEAF   <font color=#447700>!leaf maintenance respiration per timestep[g/m2]<a name='8452'></font>
  REAL                   :: RSROOT   <font color=#447700>!fine root respiration per time step [g/m2]<a name='8453'></font>
  REAL                   :: RSGRAIN  <font color=#447700>!grain respiration [g/m2]  <a name='8454'></font>
  REAL                   :: NPPL     <font color=#447700>!leaf net primary productivity [g/m2/s]<a name='8455'></font>
  REAL                   :: NPPR     <font color=#447700>!root net primary productivity [g/m2/s]<a name='8456'></font>
  REAL                   :: NPPW     <font color=#447700>!wood net primary productivity [g/m2/s]<a name='8457'></font>
  REAL                   :: NPPS     <font color=#447700>!wood net primary productivity [g/m2/s]<a name='8458'></font>
  REAL                   :: NPPG     <font color=#447700>!grain net primary productivity [g/m2/s] <a name='8459'></font>
  REAL                   :: DIELF    <font color=#447700>!death of leaf mass per time step [g/m2]<a name='8460'></font>
<a name='8461'>
  REAL                   :: ADDNPPLF <font color=#447700>!leaf assimil after resp. losses removed[g/m2]<a name='8462'></font>
  REAL                   :: ADDNPPST <font color=#447700>!stem assimil after resp. losses removed[g/m2]<a name='8463'></font>
  REAL                   :: CARBFX   <font color=#447700>!carbon assimilated per model step [g/m2]<a name='8464'></font>
  REAL                   :: CBHYDRAFX<font color=#447700>!carbonhydrate assimilated per model step [g/m2]<a name='8465'></font>
  REAL                   :: GRLEAF   <font color=#447700>!growth respiration rate for leaf [g/m2/s]<a name='8466'></font>
  REAL                   :: GRROOT   <font color=#447700>!growth respiration rate for root [g/m2/s]<a name='8467'></font>
  REAL                   :: GRWOOD   <font color=#447700>!growth respiration rate for wood [g/m2/s]<a name='8468'></font>
  REAL                   :: GRSTEM   <font color=#447700>!growth respiration rate for stem [g/m2/s]<a name='8469'></font>
  REAL                   :: GRGRAIN   <font color=#447700>!growth respiration rate for stem [g/m2/s]<a name='8470'></font>
  REAL                   :: LEAFPT   <font color=#447700>!fraction of carbon allocated to leaves [-]<a name='8471'></font>
  REAL                   :: LFDEL    <font color=#447700>!maximum  leaf mass  available to change[g/m2/s]<a name='8472'></font>
  REAL                   :: LFTOVR   <font color=#447700>!stem turnover per time step [g/m2]<a name='8473'></font>
  REAL                   :: STTOVR   <font color=#447700>!stem turnover per time step [g/m2]<a name='8474'></font>
  REAL                   :: WDTOVR   <font color=#447700>!wood turnover per time step [g/m2]<a name='8475'></font>
  REAL                   :: GRTOVR   <font color=#447700>!grainturnover per time step [g/m2]<a name='8476'></font>
  REAL                   :: RSSOIL   <font color=#447700>!soil respiration per time step [g/m2]<a name='8477'></font>
  REAL                   :: RTTOVR   <font color=#447700>!root carbon loss per time step by turnover[g/m2]<a name='8478'></font>
  REAL                   :: STABLC   <font color=#447700>!decay rate of fast carbon to slow carbon[g/m2/s]<a name='8479'></font>
  REAL                   :: WOODF    <font color=#447700>!calculated wood to root ratio [-]<a name='8480'></font>
  REAL                   :: NONLEF   <font color=#447700>!fraction of carbon to root and wood [-]<a name='8481'></font>
  REAL                   :: RESP     <font color=#447700>!leaf respiration [umol/m2/s]<a name='8482'></font>
  REAL                   :: RSSTEM   <font color=#447700>!stem respiration [g/m2/s]<a name='8483'></font>
<a name='8484'>
  REAL                   :: FSW      <font color=#447700>!soil water factor for microbial respiration<a name='8485'></font>
  REAL                   :: FST      <font color=#447700>!soil temperature factor for microbialrespiration<a name='8486'></font>
  REAL                   :: FNF      <font color=#447700>!foliage nitrogen adjustemt to respiration(&lt;= 1)<a name='8487'></font>
  REAL                   :: TF       <font color=#447700>!temperature factor<a name='8488'></font>
  REAL                   :: STDEL<a name='8489'>
  REAL                   :: STMSMN<a name='8490'>
  REAL                   :: SAPM     <font color=#447700>!stem area per unit mass (m2/g)<a name='8491'></font>
  REAL                   :: DIEST<a name='8492'>
  REAL                   :: STCONVERT   <font color=#447700>!stem to grain conversion [g/m2/s]<a name='8493'></font>
  REAL                   :: RTCONVERT   <font color=#447700>!root to grain conversion [g/m2/s]<a name='8494'></font>
<font color=#447700>! -------------------------- constants -------------------------------<a name='8495'></font>
  REAL                   :: BF       <font color=#447700>!parameter for present wood allocation [-]<a name='8496'></font>
  REAL                   :: RSWOODC  <font color=#447700>!wood respiration coeficient [1/s]<a name='8497'></font>
  REAL                   :: STOVRC   <font color=#447700>!stem turnover coefficient [1/s]<a name='8498'></font>
  REAL                   :: RSDRYC   <font color=#447700>!degree of drying that reduces soilrespiration [-]<a name='8499'></font>
  REAL                   :: RTOVRC   <font color=#447700>!root turnover coefficient [1/s]<a name='8500'></font>
  REAL                   :: WSTRC    <font color=#447700>!water stress coeficient [-]<a name='8501'></font>
  REAL                   :: LAIMIN   <font color=#447700>!minimum leaf area index [m2/m2]<a name='8502'></font>
  REAL                   :: XSAMIN   <font color=#447700>!minimum leaf area index [m2/m2]<a name='8503'></font>
  REAL                   :: SC<a name='8504'>
  REAL                   :: SD<a name='8505'>
  REAL                   :: VEGFRAC<a name='8506'>
  REAL                   :: TEMP<a name='8507'>
<a name='8508'>
<font color=#447700>! Respiration as a function of temperature<a name='8509'></font>
<a name='8510'>
  real :: r,x<a name='8511'>
          r(x) = exp(0.08*(x-298.16))<a name='8512'>
<font color=#447700>! ---------------------------------------------------------------------------------<a name='8513'></font>
<a name='8514'>
<font color=#447700>! constants<a name='8515'></font>
    RSDRYC  = 40.0          <font color=#447700>!original was 40.0<a name='8516'></font>
    RSWOODC = 3.0E-10       <font color=#447700>!<a name='8517'></font>
    BF      = 0.90          <font color=#447700>!original was 0.90   ! carbon to roots<a name='8518'></font>
    WSTRC   = 100.0<a name='8519'>
    LAIMIN  = 0.05<a name='8520'>
    XSAMIN  = 0.05<a name='8521'>
<a name='8522'>
    SAPM    = 3.*0.001      <font color=#447700>! m2/kg --&gt;m2/g<a name='8523'></font>
    LFMSMN  = laimin/0.035<a name='8524'>
    STMSMN  = xsamin/sapm<a name='8525'>
<font color=#447700>! ---------------------------------------------------------------------------------<a name='8526'></font>
<a name='8527'>
<font color=#447700>! carbon assimilation<a name='8528'></font>
<font color=#447700>! 1 mole -&gt; 12 g carbon or 44 g CO2 or 30 g CH20<a name='8529'></font>
<a name='8530'>
     CARBFX     = PSN*12.e-6<font color=#447700>!*IPA   !umol co2 /m2/ s -&gt; g/m2/s C<a name='8531'></font>
     CBHYDRAFX  = PSN*30.e-6<font color=#447700>!*IPA<a name='8532'></font>
<a name='8533'>
<font color=#447700>! mainteinance respiration<a name='8534'></font>
     FNF     = MIN( FOLN/MAX(1.E-06,parameters%FOLN_MX), 1.0 )<a name='8535'>
     TF      = parameters%Q10MR**( (TV-298.16)/10. )<a name='8536'>
     RESP    = parameters%LFMR25 * TF * FNF * XLAI  * (1.-WSTRES)  <font color=#447700>! umol/m2/s<a name='8537'></font>
     RSLEAF  = MIN((LFMASS-LFMSMN)/DT,RESP*30.e-6)                       <font color=#447700>! g/m2/s<a name='8538'></font>
     RSROOT  = parameters%RTMR25*(RTMASS*1E-3)*TF * 30.e-6         <font color=#447700>! g/m2/s<a name='8539'></font>
     RSSTEM  = parameters%STMR25*(STMASS*1E-3)*TF * 30.e-6         <font color=#447700>! g/m2/s<a name='8540'></font>
     RSGRAIN = parameters%GRAINMR25*(GRAIN*1E-3)*TF * 30.e-6       <font color=#447700>! g/m2/s<a name='8541'></font>
<a name='8542'>
<font color=#447700>! calculate growth respiration for leaf, rtmass and grain<a name='8543'></font>
<a name='8544'>
     GRLEAF  = MAX(0.0,parameters%FRA_GR*(parameters%LFPT(PGS)*CBHYDRAFX  - RSLEAF))<a name='8545'>
     GRSTEM  = MAX(0.0,parameters%FRA_GR*(parameters%STPT(PGS)*CBHYDRAFX  - RSSTEM))<a name='8546'>
     GRROOT  = MAX(0.0,parameters%FRA_GR*(parameters%RTPT(PGS)*CBHYDRAFX  - RSROOT))<a name='8547'>
     GRGRAIN = MAX(0.0,parameters%FRA_GR*(parameters%GRAINPT(PGS)*CBHYDRAFX  - RSGRAIN))<a name='8548'>
<a name='8549'>
<font color=#447700>! leaf turnover, stem turnover, root turnover and leaf death caused by soil<a name='8550'></font>
<font color=#447700>! water and soil temperature stress<a name='8551'></font>
<a name='8552'>
     LFTOVR  = parameters%LF_OVRC(PGS)*1.E-6*LFMASS<a name='8553'>
     RTTOVR  = parameters%RT_OVRC(PGS)*1.E-6*RTMASS<a name='8554'>
     STTOVR  = parameters%ST_OVRC(PGS)*1.E-6*STMASS<a name='8555'>
     SC  = EXP(-0.3*MAX(0.,TV-parameters%LEFREEZ)) * (LFMASS/120.)<a name='8556'>
     SD  = EXP((WSTRES-1.)*WSTRC)<a name='8557'>
     DIELF = LFMASS*1.E-6*(parameters%DILE_FW(PGS) * SD + parameters%DILE_FC(PGS)*SC)<a name='8558'>
<a name='8559'>
<font color=#447700>! Allocation of CBHYDRAFX to leaf, stem, root and grain at each growth stage<a name='8560'></font>
<a name='8561'>
<a name='8562'>
     ADDNPPLF    = MAX(0.,parameters%LFPT(PGS)*CBHYDRAFX - GRLEAF-RSLEAF)<a name='8563'>
     ADDNPPLF    = parameters%LFPT(PGS)*CBHYDRAFX - GRLEAF-RSLEAF<a name='8564'>
     ADDNPPST    = MAX(0.,parameters%STPT(PGS)*CBHYDRAFX - GRSTEM-RSSTEM)<a name='8565'>
     ADDNPPST    = parameters%STPT(PGS)*CBHYDRAFX - GRSTEM-RSSTEM<a name='8566'>
    <a name='8567'>
<a name='8568'>
<font color=#447700>! avoid reducing leaf mass below its minimum value but conserve mass<a name='8569'></font>
<a name='8570'>
     LFDEL = (LFMASS - LFMSMN)/DT<a name='8571'>
     STDEL = (STMASS - STMSMN)/DT<a name='8572'>
     LFTOVR  = MIN(LFTOVR,LFDEL+ADDNPPLF)<a name='8573'>
     STTOVR  = MIN(STTOVR,STDEL+ADDNPPST)<a name='8574'>
     DIELF = MIN(DIELF,LFDEL+ADDNPPLF-LFTOVR)<a name='8575'>
<a name='8576'>
<font color=#447700>! net primary productivities<a name='8577'></font>
<a name='8578'>
     NPPL   = MAX(ADDNPPLF,-LFDEL)<a name='8579'>
     NPPL   = ADDNPPLF<a name='8580'>
     NPPS   = MAX(ADDNPPST,-STDEL)<a name='8581'>
     NPPS   = ADDNPPST<a name='8582'>
     NPPR   = parameters%RTPT(PGS)*CBHYDRAFX - RSROOT - GRROOT<a name='8583'>
     NPPG  =  parameters%GRAINPT(PGS)*CBHYDRAFX - RSGRAIN - GRGRAIN<a name='8584'>
<a name='8585'>
<font color=#447700>! masses of plant components<a name='8586'></font>
  <a name='8587'>
     LFMASS = LFMASS + (NPPL-LFTOVR-DIELF)*DT<a name='8588'>
     STMASS = STMASS + (NPPS-STTOVR)*DT   <font color=#447700>! g/m2<a name='8589'></font>
     RTMASS = RTMASS + (NPPR-RTTOVR)*DT<a name='8590'>
     GRAIN =  GRAIN + NPPG*DT <a name='8591'>
<a name='8592'>
     GPP = CBHYDRAFX* 0.4 <font color=#447700>!!g/m2/s C  0.4=12/30, CH20 to C<a name='8593'></font>
<a name='8594'>
     STCONVERT = 0.0<a name='8595'>
     RTCONVERT = 0.0<a name='8596'>
     IF(PGS==6) THEN<a name='8597'>
       STCONVERT = STMASS*(0.00005*DT/3600.0)<a name='8598'>
       STMASS = STMASS - STCONVERT<a name='8599'>
       RTCONVERT = RTMASS*(0.0005*DT/3600.0)<a name='8600'>
       RTMASS = RTMASS - RTCONVERT<a name='8601'>
       GRAIN  = GRAIN + STCONVERT + RTCONVERT<a name='8602'>
     END IF<a name='8603'>
    <a name='8604'>
     IF(RTMASS.LT.0.0) THEN<a name='8605'>
       RTTOVR = NPPR<a name='8606'>
       RTMASS = 0.0<a name='8607'>
     ENDIF<a name='8608'>
<a name='8609'>
     IF(GRAIN.LT.0.0) THEN<a name='8610'>
       GRAIN = 0.0<a name='8611'>
     ENDIF<a name='8612'>
<a name='8613'>
 <font color=#447700>! soil carbon budgets<a name='8614'></font>
<a name='8615'>
<font color=#447700>!     IF(PGS == 1 .OR. PGS == 2 .OR. PGS == 8) THEN<a name='8616'></font>
<font color=#447700>!       FASTCP=1000<a name='8617'></font>
<font color=#447700>!     ELSE<a name='8618'></font>
       FASTCP = FASTCP + (RTTOVR+LFTOVR+STTOVR+DIELF)*DT <a name='8619'>
<font color=#447700>!     END IF<a name='8620'></font>
     FST = 2.0**( (STC-283.16)/10. )<a name='8621'>
     FSW = WROOT / (0.20+WROOT) * 0.23 / (0.23+WROOT)<a name='8622'>
     RSSOIL = FSW * FST * parameters%MRP* MAX(0.,FASTCP*1.E-3)*12.E-6<a name='8623'>
<a name='8624'>
     STABLC = 0.1*RSSOIL<a name='8625'>
     FASTCP = FASTCP - (RSSOIL + STABLC)*DT<a name='8626'>
     STBLCP = STBLCP + STABLC*DT<a name='8627'>
<a name='8628'>
<font color=#447700>!  total carbon flux<a name='8629'></font>
<a name='8630'>
     CFLUX  = - CARBFX + RSLEAF + RSROOT  + RSSTEM &amp;<a name='8631'>
              + RSSOIL + GRLEAF + GRROOT                  <font color=#447700>! g/m2/s 0.4=12/30, CH20 to C<a name='8632'></font>
<a name='8633'>
<font color=#447700>! for outputs<a name='8634'></font>
                                                                 <font color=#447700>!g/m2/s C<a name='8635'></font>
<a name='8636'>
     NPP   = (NPPL + NPPS+ NPPR +NPPG)*0.4      <font color=#447700>!!g/m2/s C  0.4=12/30, CH20 to C<a name='8637'></font>
 <a name='8638'>
  <a name='8639'>
     AUTORS = RSROOT + RSGRAIN  + RSLEAF +  &amp;                     <font color=#447700>!g/m2/s C<a name='8640'></font>
              GRLEAF + GRROOT + GRGRAIN                           <font color=#447700>!g/m2/s C<a name='8641'></font>
<a name='8642'>
     HETERS = RSSOIL                                             <font color=#447700>!g/m2/s C<a name='8643'></font>
     NEE    = (AUTORS + HETERS - GPP)*44./30.                    <font color=#447700>!g/m2/s CO2<a name='8644'></font>
     TOTSC  = FASTCP + STBLCP                                    <font color=#447700>!g/m2   C<a name='8645'></font>
<a name='8646'>
     TOTLB  = LFMASS + RTMASS + GRAIN         <a name='8647'>
<a name='8648'>
<font color=#447700>! leaf area index and stem area index<a name='8649'></font>
  <a name='8650'>
     XLAI    = MAX(LFMASS*parameters%BIO2LAI,LAIMIN)<a name='8651'>
     XSAI    = MAX(STMASS*SAPM,XSAMIN)<a name='8652'>
<a name='8653'>
   <a name='8654'>
<font color=#447700>!After harversting<a name='8655'></font>
<font color=#447700>!     IF(PGS == 8 ) THEN<a name='8656'></font>
<font color=#447700>!       LFMASS = 0.62<a name='8657'></font>
<font color=#447700>!       STMASS = 0<a name='8658'></font>
<font color=#447700>!       GRAIN  = 0<a name='8659'></font>
<font color=#447700>!     END IF<a name='8660'></font>
<a name='8661'>
<font color=#447700>!    IF(PGS == 1 .OR. PGS == 2 .OR. PGS == 8) THEN<a name='8662'></font>
    IF(PGS == 8 .and. (GRAIN &gt; 0. .or. LFMASS &gt; 0 .or. STMASS &gt; 0 .or. RTMASS &gt; 0)) THEN<a name='8663'>
     XLAI   = 0.05<a name='8664'>
     XSAI   = 0.05<a name='8665'>
     LFMASS = LFMSMN<a name='8666'>
     STMASS = STMSMN<a name='8667'>
     RTMASS = 0<a name='8668'>
     GRAIN  = 0<a name='8669'>
    END IF <a name='8670'>
    <a name='8671'>
END SUBROUTINE CO2FLUX_CROP<a name='8672'>
<a name='8673'>
<font color=#447700>!== begin growing_gdd ==============================================================================<a name='8674'></font>
<a name='8675'>
<A NAME='GROWING_GDD'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#GROWING_GDD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='8676'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>GROWING_GDD</font> (parameters,                         &amp; <font color=#447700>!in <A href='../../call_to/GROWING_GDD.html' TARGET='index'>1</A><a name='8677'></font>
                          T2M ,   DT, JULIAN,                 &amp; <font color=#447700>!in<a name='8678'></font>
                          GDD ,                               &amp; <font color=#447700>!inout <a name='8679'></font>
                          IPA,   IHA,     PGS)                  <font color=#447700>!out  <a name='8680'></font>
<font color=#447700>!===================================================================================================<a name='8681'></font>
<a name='8682'>
<font color=#447700>! input<a name='8683'></font>
<a name='8684'>
  type (noahmp_parameters), intent(in) :: parameters<a name='8685'>
   REAL                     , INTENT(IN)        :: T2M     <font color=#447700>!Air temperature<a name='8686'></font>
   REAL                     , INTENT(IN)        :: DT      <font color=#447700>!time step (s)<a name='8687'></font>
   REAL                     , INTENT(IN)        :: JULIAN  <font color=#447700>!Julian day of year (fractional) ( 0 &lt;= JULIAN &lt; YEARLEN )<a name='8688'></font>
<a name='8689'>
<font color=#447700>! input and output<a name='8690'></font>
<a name='8691'>
   REAL                     , INTENT(INOUT)     :: GDD     <font color=#447700>!growing degress days<a name='8692'></font>
<a name='8693'>
<font color=#447700>! output<a name='8694'></font>
<a name='8695'>
   INTEGER                  , INTENT(OUT)       :: IPA     <font color=#447700>!Planting index index(0=off, 1=on)<a name='8696'></font>
   INTEGER                  , INTENT(OUT)       :: IHA     <font color=#447700>!Havestindex(0=on,1=off) <a name='8697'></font>
   INTEGER                  , INTENT(OUT)       :: PGS     <font color=#447700>!Plant growth stage(1=S1,2=S2,3=S3)<a name='8698'></font>
<a name='8699'>
<font color=#447700>!local <a name='8700'></font>
<a name='8701'>
   REAL                                         :: GDDDAY    <font color=#447700>!gap bewtween GDD and GDD8<a name='8702'></font>
   REAL                                         :: DAYOFS2   <font color=#447700>!DAYS in stage2<a name='8703'></font>
   REAL                                         :: TDIFF     <font color=#447700>!temperature difference for growing degree days calculation<a name='8704'></font>
   REAL                                         :: TC<a name='8705'>
<a name='8706'>
   TC = T2M - 273.15<a name='8707'>
<a name='8708'>
<font color=#447700>!Havestindex(0=on,1=off) <a name='8709'></font>
<a name='8710'>
   IPA = 1<a name='8711'>
   IHA = 1<a name='8712'>
<a name='8713'>
<font color=#447700>!turn on/off the planting <a name='8714'></font>
 <a name='8715'>
   IF(JULIAN &lt; parameters%PLTDAY)  IPA = 0<a name='8716'>
<a name='8717'>
<font color=#447700>!turn on/off the harvesting<a name='8718'></font>
    IF(JULIAN &gt;= parameters%HSDAY) IHA = 0<a name='8719'>
   <a name='8720'>
<font color=#447700>!Calculate the growing degree days<a name='8721'></font>
   <a name='8722'>
    IF(TC &lt;  parameters%GDDTBASE) THEN<a name='8723'>
      TDIFF = 0.0<a name='8724'>
    ELSEIF(TC &gt;= parameters%GDDTCUT) THEN<a name='8725'>
      TDIFF = parameters%GDDTCUT - parameters%GDDTBASE<a name='8726'>
    ELSE<a name='8727'>
      TDIFF = TC - parameters%GDDTBASE<a name='8728'>
    END IF<a name='8729'>
<a name='8730'>
    GDD     = (GDD + TDIFF) * IPA * IHA<a name='8731'>
<a name='8732'>
    GDDDAY  = GDD / (86400.0 / DT)<a name='8733'>
<a name='8734'>
   <font color=#447700>! Decide corn growth stage, based on Hybrid-Maize <a name='8735'></font>
   <font color=#447700>!   PGS = 1 : Before planting<a name='8736'></font>
   <font color=#447700>!   PGS = 2 : from tassel initiation to silking<a name='8737'></font>
   <font color=#447700>!   PGS = 3 : from silking to effective grain filling<a name='8738'></font>
   <font color=#447700>!   PGS = 4 : from effective grain filling to pysiological maturity <a name='8739'></font>
   <font color=#447700>!   PGS = 5 : GDDM=1389<a name='8740'></font>
   <font color=#447700>!   PGS = 6 :<a name='8741'></font>
   <font color=#447700>!   PGS = 7 :<a name='8742'></font>
   <font color=#447700>!   PGS = 8 :<a name='8743'></font>
   <font color=#447700>!  GDDM = 1389<a name='8744'></font>
   <font color=#447700>!  GDDM = 1555<a name='8745'></font>
   <font color=#447700>! GDDSK = 0.41*GDDM +145.4+150 !from hybrid-maize <a name='8746'></font>
   <font color=#447700>! GDDS1 = ((GDDSK-96)/38.9-4)*21<a name='8747'></font>
   <font color=#447700>! GDDS1 = 0.77*GDDSK<a name='8748'></font>
   <font color=#447700>! GDDS3 = GDDSK+170<a name='8749'></font>
   <font color=#447700>! GDDS3 = 170<a name='8750'></font>
<a name='8751'>
   PGS = 1                         <font color=#447700>! MB: set PGS = 1 (for initialization during growing season when no GDD)<a name='8752'></font>
<a name='8753'>
   IF(GDDDAY &gt; 0.0) PGS = 2<a name='8754'>
<a name='8755'>
   IF(GDDDAY &gt;= parameters%GDDS1)  PGS = 3<a name='8756'>
<a name='8757'>
   IF(GDDDAY &gt;= parameters%GDDS2)  PGS = 4 <a name='8758'>
<a name='8759'>
   IF(GDDDAY &gt;= parameters%GDDS3)  PGS = 5<a name='8760'>
<a name='8761'>
   IF(GDDDAY &gt;= parameters%GDDS4)  PGS = 6<a name='8762'>
<a name='8763'>
   IF(GDDDAY &gt;= parameters%GDDS5)  PGS = 7<a name='8764'>
<a name='8765'>
   IF(JULIAN &gt;= parameters%HSDAY)  PGS = 8<a name='8766'>
 <a name='8767'>
   IF(JULIAN &lt;  parameters%PLTDAY) PGS = 1   <a name='8768'>
<a name='8769'>
END SUBROUTINE GROWING_GDD<a name='8770'>
<a name='8771'>
<font color=#447700>!== begin psn_crop =================================================================================<a name='8772'></font>
<a name='8773'>
<A NAME='PSN_CROP'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#PSN_CROP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='8774'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>PSN_CROP</font> ( parameters,       &amp; <font color=#447700>!in <A href='../../call_to/PSN_CROP.html' TARGET='index'>1</A><a name='8775'></font>
                      SOLDN, XLAI,T2M,  &amp; <font color=#447700>!in<a name='8776'></font>
                      PSNCROP        )    <font color=#447700>!out<a name='8777'></font>
<font color=#447700>!===================================================================================================<a name='8778'></font>
<a name='8779'>
<font color=#447700>! input<a name='8780'></font>
<a name='8781'>
  type (noahmp_parameters), intent(in) :: parameters<a name='8782'>
  REAL     , INTENT(IN)    :: SOLDN    <font color=#447700>! downward solar radiation<a name='8783'></font>
  REAL     , INTENT(IN)    :: XLAI     <font color=#447700>! LAI<a name='8784'></font>
  REAL     , INTENT(IN)    :: T2M      <font color=#447700>! air temp<a name='8785'></font>
  REAL     , INTENT(OUT)   :: PSNCROP  <font color=#447700>!<a name='8786'></font>
<a name='8787'>
<font color=#447700>!local<a name='8788'></font>
<a name='8789'>
  REAL                     :: PAR      <font color=#447700>! photosynthetically active radiation (w/m2) 1 W m-2 = 0.0864 MJ m-2 day-1<a name='8790'></font>
  REAL                     :: Amax     <font color=#447700>! Maximum CO2 assimulation rate g/co2/s  <a name='8791'></font>
  REAL                     :: L1       <font color=#447700>! Three Gaussian method<a name='8792'></font>
  REAL                     :: L2       <font color=#447700>! Three Gaussian method<a name='8793'></font>
  REAL                     :: L3       <font color=#447700>! Three Gaussian method<a name='8794'></font>
  REAL                     :: I1       <font color=#447700>! Three Gaussian method<a name='8795'></font>
  REAL                     :: I2       <font color=#447700>! Three Gaussian method<a name='8796'></font>
  REAL                     :: I3       <font color=#447700>! Three Gaussian method<a name='8797'></font>
  REAL                     :: A1       <font color=#447700>! Three Gaussian method<a name='8798'></font>
  REAL                     :: A2       <font color=#447700>! Three Gaussian method<a name='8799'></font>
  REAL                     :: A3       <font color=#447700>! Three Gaussian method<a name='8800'></font>
  REAL                     :: A        <font color=#447700>! CO2 Assimulation <a name='8801'></font>
  REAL                     :: TC<a name='8802'>
<a name='8803'>
  TC = T2M - 273.15<a name='8804'>
<a name='8805'>
  PAR = parameters%I2PAR * SOLDN * 0.0036  <font color=#447700>!w to MJ m-2<a name='8806'></font>
<a name='8807'>
  IF(TC &lt; parameters%TASSIM0) THEN<a name='8808'>
    Amax = 1E-10<a name='8809'>
  ELSEIF(TC &gt;= parameters%TASSIM0 .and. TC &lt; parameters%TASSIM1) THEN<a name='8810'>
    Amax = (TC - parameters%TASSIM0) * parameters%Aref / (parameters%TASSIM1 - parameters%TASSIM0)<a name='8811'>
  ELSEIF(TC &gt;= parameters%TASSIM1 .and. TC &lt; parameters%TASSIM2) THEN<a name='8812'>
    Amax = parameters%Aref<a name='8813'>
  ELSE<a name='8814'>
    Amax= parameters%Aref - 0.2 * (T2M - parameters%TASSIM2)<a name='8815'>
  ENDIF <a name='8816'>
  <a name='8817'>
  Amax = max(amax,0.01)<a name='8818'>
<a name='8819'>
  IF(XLAI &lt;= 0.05) THEN<a name='8820'>
    L1 = 0.1127 * 0.05   <font color=#447700>!use initial LAI(0.05), avoid error<a name='8821'></font>
    L2 = 0.5    * 0.05<a name='8822'>
    L3 = 0.8873 * 0.05<a name='8823'>
  ELSE<a name='8824'>
    L1 = 0.1127 * XLAI<a name='8825'>
    L2 = 0.5    * XLAI<a name='8826'>
    L3 = 0.8873 * XLAI<a name='8827'>
  END IF<a name='8828'>
<a name='8829'>
  I1 = parameters%k * PAR * exp(-parameters%k * L1)<a name='8830'>
  I2 = parameters%k * PAR * exp(-parameters%k * L2)<a name='8831'>
  I3 = parameters%k * PAR * exp(-parameters%k * L3)<a name='8832'>
<a name='8833'>
  I1 = max(I1,1E-10)<a name='8834'>
  I2 = max(I2,1E-10)<a name='8835'>
  I3 = max(I3,1E-10)<a name='8836'>
<a name='8837'>
  A1 = Amax * (1 - exp(-parameters%epsi * I1 / Amax))<a name='8838'>
  A2 = Amax * (1 - exp(-parameters%epsi * I2 / Amax)) * 1.6<a name='8839'>
  A3 = Amax * (1 - exp(-parameters%epsi * I3 / Amax))<a name='8840'>
<a name='8841'>
  IF (XLAI &lt;= 0.05) THEN<a name='8842'>
    A  = (A1+A2+A3) / 3.6 * 0.05<a name='8843'>
  ELSEIF (XLAI &gt; 0.05 .and. XLAI &lt;= 4.0) THEN<a name='8844'>
    A  = (A1+A2+A3) / 3.6 * XLAI<a name='8845'>
  ELSE<a name='8846'>
    A = (A1+A2+A3) / 3.6 * 4<a name='8847'>
  END IF<a name='8848'>
<a name='8849'>
  A = A * parameters%PSNRF <font color=#447700>! Attainable <a name='8850'></font>
<a name='8851'>
  PSNCROP = 6.313 * A   <font color=#447700>! (1/44) * 1000000)/3600 = 6.313<a name='8852'></font>
<a name='8853'>
END SUBROUTINE PSN_CROP<a name='8854'>
<a name='8855'>
<font color=#447700>!== begin bvocflux =================================================================================<a name='8856'></font>
<a name='8857'>
<font color=#447700>!  SUBROUTINE BVOCFLUX(parameters,VOCFLX,  VEGTYP,  VEGFRAC,  APAR,   TV )<a name='8858'></font>
<font color=#447700>!<a name='8859'></font>
<font color=#447700>! ------------------------------------------------------------------------------------------<a name='8860'></font>
<font color=#447700>!      implicit none<a name='8861'></font>
<font color=#447700>! ------------------------------------------------------------------------------------------<a name='8862'></font>
<font color=#447700>!<a name='8863'></font>
<font color=#447700>! ------------------------ code history ---------------------------<a name='8864'></font>
<font color=#447700>! source file:       BVOC<a name='8865'></font>
<font color=#447700>! purpose:           BVOC emissions<a name='8866'></font>
<font color=#447700>! DESCRIPTION:<a name='8867'></font>
<font color=#447700>! Volatile organic compound emission <a name='8868'></font>
<font color=#447700>! This code simulates volatile organic compound emissions<a name='8869'></font>
<font color=#447700>! following the algorithm presented in Guenther, A., 1999: Modeling<a name='8870'></font>
<font color=#447700>! Biogenic Volatile Organic Compound Emissions to the Atmosphere. In<a name='8871'></font>
<font color=#447700>! Reactive Hydrocarbons in the Atmosphere, Ch. 3<a name='8872'></font>
<font color=#447700>! This model relies on the assumption that 90% of isoprene and monoterpene<a name='8873'></font>
<font color=#447700>! emissions originate from canopy foliage:<a name='8874'></font>
<font color=#447700>!    E = epsilon * gamma * density * delta<a name='8875'></font>
<font color=#447700>! The factor delta (longterm activity factor) applies to isoprene emission<a name='8876'></font>
<font color=#447700>! from deciduous plants only. We neglect this factor at the present time.<a name='8877'></font>
<font color=#447700>! This factor is discussed in Guenther (1997).<a name='8878'></font>
<font color=#447700>! Subroutine written to operate at the patch level.<a name='8879'></font>
<font color=#447700>! IN FINAL IMPLEMENTATION, REMEMBER:<a name='8880'></font>
<font color=#447700>! 1. may wish to call this routine only as freq. as rad. calculations<a name='8881'></font>
<font color=#447700>! 2. may wish to place epsilon values directly in pft-physiology file<a name='8882'></font>
<font color=#447700>! ------------------------ input/output variables -----------------<a name='8883'></font>
<font color=#447700>! input<a name='8884'></font>
<font color=#447700>!  integer                     ,INTENT(IN) :: vegtyp  !vegetation type <a name='8885'></font>
<font color=#447700>!  real                        ,INTENT(IN) :: vegfrac !green vegetation fraction [0.0-1.0]<a name='8886'></font>
<font color=#447700>!  real                        ,INTENT(IN) :: apar    !photosynthesis active energy by canopy (w/m2)<a name='8887'></font>
<font color=#447700>!  real                        ,INTENT(IN) :: tv      !vegetation canopy temperature (k)<a name='8888'></font>
<font color=#447700>!<a name='8889'></font>
<font color=#447700>! output<a name='8890'></font>
<font color=#447700>!  real                        ,INTENT(OUT) :: vocflx(5) ! voc fluxes [ug C m-2 h-1]<a name='8891'></font>
<font color=#447700>!<a name='8892'></font>
<font color=#447700>! Local Variables<a name='8893'></font>
<font color=#447700>!<a name='8894'></font>
<font color=#447700>!  real, parameter :: R      = 8.314    ! univ. gas constant [J K-1 mol-1]<a name='8895'></font>
<font color=#447700>!  real, parameter :: alpha  = 0.0027   ! empirical coefficient<a name='8896'></font>
<font color=#447700>!  real, parameter :: cl1    = 1.066    ! empirical coefficient<a name='8897'></font>
<font color=#447700>!  real, parameter :: ct1    = 95000.0  ! empirical coefficient [J mol-1]<a name='8898'></font>
<font color=#447700>!  real, parameter :: ct2    = 230000.0 ! empirical coefficient [J mol-1]<a name='8899'></font>
<font color=#447700>!  real, parameter :: ct3    = 0.961    ! empirical coefficient<a name='8900'></font>
<font color=#447700>!  real, parameter :: tm     = 314.0    ! empirical coefficient [K]<a name='8901'></font>
<font color=#447700>!  real, parameter :: tstd   = 303.0    ! std temperature [K]<a name='8902'></font>
<font color=#447700>!  real, parameter :: bet    = 0.09     ! beta empirical coefficient [K-1]<a name='8903'></font>
<font color=#447700>!<a name='8904'></font>
<font color=#447700>!  integer ivoc        ! do-loop index<a name='8905'></font>
<font color=#447700>!  integer ityp        ! do-loop index<a name='8906'></font>
<font color=#447700>!  real epsilon(5)<a name='8907'></font>
<font color=#447700>!  real gamma(5)<a name='8908'></font>
<font color=#447700>!  real density<a name='8909'></font>
<font color=#447700>!  real elai<a name='8910'></font>
<font color=#447700>!  real par,cl,reciprod,ct<a name='8911'></font>
<font color=#447700>!<a name='8912'></font>
<font color=#447700>! epsilon :<a name='8913'></font>
<font color=#447700>!<a name='8914'></font>
<font color=#447700>!    do ivoc = 1, 5<a name='8915'></font>
<font color=#447700>!    epsilon(ivoc) = parameters%eps(VEGTYP,ivoc)<a name='8916'></font>
<font color=#447700>!    end do<a name='8917'></font>
<font color=#447700>!<a name='8918'></font>
<font color=#447700>! gamma : Activity factor. Units [dimensionless]<a name='8919'></font>
<font color=#447700>!<a name='8920'></font>
<font color=#447700>!      reciprod = 1. / (R * tv * tstd)<a name='8921'></font>
<font color=#447700>!      ct = exp(ct1 * (tv - tstd) * reciprod) / &amp;<a name='8922'></font>
<font color=#447700>!           (ct3 + exp(ct2 * (tv - tm) * reciprod))<a name='8923'></font>
<font color=#447700>!<a name='8924'></font>
<font color=#447700>!      par = apar * 4.6 ! (multiply w/m2 by 4.6 to get umol/m2/s)<a name='8925'></font>
<font color=#447700>!      cl  = alpha * cl1 * par * (1. + alpha * alpha * par * par)**(-0.5)<a name='8926'></font>
<font color=#447700>!<a name='8927'></font>
<font color=#447700>!   gamma(1) = cl * ct ! for isoprenes<a name='8928'></font>
<font color=#447700>!<a name='8929'></font>
<font color=#447700>!   do ivoc = 2, 5<a name='8930'></font>
<font color=#447700>!   gamma(ivoc) = exp(bet * (tv - tstd))<a name='8931'></font>
<font color=#447700>!   end do<a name='8932'></font>
<font color=#447700>!<a name='8933'></font>
<font color=#447700>! Foliage density<a name='8934'></font>
<font color=#447700>!<a name='8935'></font>
<font color=#447700>! transform vegfrac to lai      <a name='8936'></font>
<font color=#447700>!<a name='8937'></font>
<font color=#447700>!   elai    = max(0.0,-6.5/2.5*alog((1.-vegfrac)))<a name='8938'></font>
<font color=#447700>!   density = elai / (parameters%slarea(VEGTYP) * 0.5)<a name='8939'></font>
<font color=#447700>!<a name='8940'></font>
<font color=#447700>! calculate the voc flux<a name='8941'></font>
<font color=#447700>!<a name='8942'></font>
<font color=#447700>!   do ivoc = 1, 5<a name='8943'></font>
<font color=#447700>!   vocflx(ivoc) = epsilon(ivoc) * gamma(ivoc) * density<a name='8944'></font>
<font color=#447700>!   end do<a name='8945'></font>
<font color=#447700>!<a name='8946'></font>
<font color=#447700>!   end subroutine bvocflux<a name='8947'></font>
<font color=#447700>! ==================================================================================================<a name='8948'></font>
<font color=#447700>! ********************************* end of carbon subroutines *****************************<a name='8949'></font>
<font color=#447700>! ==================================================================================================<a name='8950'></font>
<a name='8951'>
<font color=#447700>!== begin noahmp_options ===========================================================================<a name='8952'></font>
<a name='8953'>
<A NAME='NOAHMP_OPTIONS'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_OPTIONS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='8954'>
  <font color=#993300>subroutine </font><font color=#cc0000>noahmp_options</font>(idveg     ,iopt_crs  ,iopt_btr  ,iopt_run  ,iopt_sfc  ,iopt_frz , &amp;  <A href='../../call_to/NOAHMP_OPTIONS.html' TARGET='index'>1</A><a name='8955'>
                             iopt_inf  ,iopt_rad  ,iopt_alb  ,iopt_snf  ,iopt_tbot, iopt_stc, &amp;<a name='8956'>
			     iopt_rsf )<a name='8957'>
<a name='8958'>
  implicit none<a name='8959'>
<a name='8960'>
  INTEGER,  INTENT(IN) :: idveg     <font color=#447700>!dynamic vegetation (1 -&gt; off ; 2 -&gt; on) with opt_crs = 1<a name='8961'></font>
  INTEGER,  INTENT(IN) :: iopt_crs  <font color=#447700>!canopy stomatal resistance (1-&gt; Ball-Berry; 2-&gt;Jarvis)<a name='8962'></font>
  INTEGER,  INTENT(IN) :: iopt_btr  <font color=#447700>!soil moisture factor for stomatal resistance (1-&gt; Noah; 2-&gt; CLM; 3-&gt; SSiB)<a name='8963'></font>
  INTEGER,  INTENT(IN) :: iopt_run  <font color=#447700>!runoff and groundwater (1-&gt;SIMGM; 2-&gt;SIMTOP; 3-&gt;Schaake96; 4-&gt;BATS)<a name='8964'></font>
  INTEGER,  INTENT(IN) :: iopt_sfc  <font color=#447700>!surface layer drag coeff (CH &amp; CM) (1-&gt;M-O; 2-&gt;Chen97)<a name='8965'></font>
  INTEGER,  INTENT(IN) :: iopt_frz  <font color=#447700>!supercooled liquid water (1-&gt; NY06; 2-&gt;Koren99)<a name='8966'></font>
  INTEGER,  INTENT(IN) :: iopt_inf  <font color=#447700>!frozen soil permeability (1-&gt; NY06; 2-&gt;Koren99)<a name='8967'></font>
  INTEGER,  INTENT(IN) :: iopt_rad  <font color=#447700>!radiation transfer (1-&gt;gap=F(3D,cosz); 2-&gt;gap=0; 3-&gt;gap=1-Fveg)<a name='8968'></font>
  INTEGER,  INTENT(IN) :: iopt_alb  <font color=#447700>!snow surface albedo (1-&gt;BATS; 2-&gt;CLASS)<a name='8969'></font>
  INTEGER,  INTENT(IN) :: iopt_snf  <font color=#447700>!rainfall &amp; snowfall (1-Jordan91; 2-&gt;BATS; 3-&gt;Noah)<a name='8970'></font>
  INTEGER,  INTENT(IN) :: iopt_tbot <font color=#447700>!lower boundary of soil temperature (1-&gt;zero-flux; 2-&gt;Noah)<a name='8971'></font>
<a name='8972'>
  INTEGER,  INTENT(IN) :: iopt_stc  <font color=#447700>!snow/soil temperature time scheme (only layer 1)<a name='8973'></font>
                                    <font color=#447700>! 1 -&gt; semi-implicit; 2 -&gt; full implicit (original Noah)<a name='8974'></font>
  INTEGER,  INTENT(IN) :: iopt_rsf  <font color=#447700>!surface resistance (1-&gt;Sakaguchi/Zeng; 2-&gt;Seller; 3-&gt;mod Sellers; 4-&gt;1+snow)<a name='8975'></font>
<a name='8976'>
<font color=#447700>! -------------------------------------------------------------------------------------------------<a name='8977'></font>
<a name='8978'>
  dveg = idveg<a name='8979'>
  <a name='8980'>
  opt_crs  = iopt_crs  <a name='8981'>
  opt_btr  = iopt_btr  <a name='8982'>
  opt_run  = iopt_run  <a name='8983'>
  opt_sfc  = iopt_sfc  <a name='8984'>
  opt_frz  = iopt_frz  <a name='8985'>
  opt_inf  = iopt_inf  <a name='8986'>
  opt_rad  = iopt_rad  <a name='8987'>
  opt_alb  = iopt_alb  <a name='8988'>
  opt_snf  = iopt_snf  <a name='8989'>
  opt_tbot = iopt_tbot <a name='8990'>
  opt_stc  = iopt_stc<a name='8991'>
  opt_rsf  = iopt_rsf<a name='8992'>
  <a name='8993'>
  end subroutine noahmp_options<a name='8994'>
 <a name='8995'>
END MODULE MODULE_SF_NOAHMPLSM<a name='8996'>
<a name='8997'>
<A NAME='NOAHMP_TABLES'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_TABLES' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='8998'>
<font color=#993300>MODULE </font><font color=#cc0000>NOAHMP_TABLES</font> <A href='../../call_to/NOAHMP_TABLES.html' TARGET='index'>8</A><a name='8999'>
<a name='9000'>
    IMPLICIT NONE<a name='9001'>
<a name='9002'>
    INTEGER, PRIVATE, PARAMETER :: MVT   = 27<a name='9003'>
    INTEGER, PRIVATE, PARAMETER :: MBAND = 2<a name='9004'>
    INTEGER, PRIVATE, PARAMETER :: MSC   = 8<a name='9005'>
    INTEGER, PRIVATE, PARAMETER :: MAX_SOILTYP = 30<a name='9006'>
    INTEGER, PRIVATE, PARAMETER :: NCROP = 5<a name='9007'>
    INTEGER, PRIVATE, PARAMETER :: NSTAGE = 8<a name='9008'>
<a name='9009'>
<font color=#447700>! MPTABLE.TBL vegetation parameters<a name='9010'></font>
<a name='9011'>
    INTEGER :: ISURBAN_TABLE<a name='9012'>
    INTEGER :: ISWATER_TABLE<a name='9013'>
    INTEGER :: ISBARREN_TABLE<a name='9014'>
    INTEGER :: ISICE_TABLE<a name='9015'>
    INTEGER :: ISCROP_TABLE<a name='9016'>
    INTEGER :: EBLFOREST_TABLE<a name='9017'>
    INTEGER :: NATURAL_TABLE<a name='9018'>
    INTEGER :: LOW_DENSITY_RESIDENTIAL_TABLE<a name='9019'>
    INTEGER :: HIGH_DENSITY_RESIDENTIAL_TABLE<a name='9020'>
    INTEGER :: HIGH_INTENSITY_INDUSTRIAL_TABLE<a name='9021'>
<a name='9022'>
    REAL :: CH2OP_TABLE(MVT)       <font color=#447700>!maximum intercepted h2o per unit lai+sai (mm)<a name='9023'></font>
    REAL :: DLEAF_TABLE(MVT)       <font color=#447700>!characteristic leaf dimension (m)<a name='9024'></font>
    REAL :: Z0MVT_TABLE(MVT)       <font color=#447700>!momentum roughness length (m)<a name='9025'></font>
    REAL :: HVT_TABLE(MVT)         <font color=#447700>!top of canopy (m)<a name='9026'></font>
    REAL :: HVB_TABLE(MVT)         <font color=#447700>!bottom of canopy (m)<a name='9027'></font>
    REAL :: DEN_TABLE(MVT)         <font color=#447700>!tree density (no. of trunks per m2)<a name='9028'></font>
    REAL :: RC_TABLE(MVT)          <font color=#447700>!tree crown radius (m)<a name='9029'></font>
    REAL :: MFSNO_TABLE(MVT)       <font color=#447700>!snowmelt curve parameter ()<a name='9030'></font>
    REAL :: SAIM_TABLE(MVT,12)     <font color=#447700>!monthly stem area index, one-sided<a name='9031'></font>
    REAL :: LAIM_TABLE(MVT,12)     <font color=#447700>!monthly leaf area index, one-sided<a name='9032'></font>
    REAL :: SLA_TABLE(MVT)         <font color=#447700>!single-side leaf area per Kg [m2/kg]<a name='9033'></font>
    REAL :: DILEFC_TABLE(MVT)      <font color=#447700>!coeficient for leaf stress death [1/s]<a name='9034'></font>
    REAL :: DILEFW_TABLE(MVT)      <font color=#447700>!coeficient for leaf stress death [1/s]<a name='9035'></font>
    REAL :: FRAGR_TABLE(MVT)       <font color=#447700>!fraction of growth respiration  !original was 0.3 <a name='9036'></font>
    REAL :: LTOVRC_TABLE(MVT)      <font color=#447700>!leaf turnover [1/s]<a name='9037'></font>
<a name='9038'>
    REAL :: C3PSN_TABLE(MVT)       <font color=#447700>!photosynthetic pathway: 0. = c4, 1. = c3<a name='9039'></font>
    REAL :: KC25_TABLE(MVT)        <font color=#447700>!co2 michaelis-menten constant at 25c (pa)<a name='9040'></font>
    REAL :: AKC_TABLE(MVT)         <font color=#447700>!q10 for kc25<a name='9041'></font>
    REAL :: KO25_TABLE(MVT)        <font color=#447700>!o2 michaelis-menten constant at 25c (pa)<a name='9042'></font>
    REAL :: AKO_TABLE(MVT)         <font color=#447700>!q10 for ko25<a name='9043'></font>
    REAL :: VCMX25_TABLE(MVT)      <font color=#447700>!maximum rate of carboxylation at 25c (umol co2/m**2/s)<a name='9044'></font>
    REAL :: AVCMX_TABLE(MVT)       <font color=#447700>!q10 for vcmx25<a name='9045'></font>
    REAL :: BP_TABLE(MVT)          <font color=#447700>!minimum leaf conductance (umol/m**2/s)<a name='9046'></font>
    REAL :: MP_TABLE(MVT)          <font color=#447700>!slope of conductance-to-photosynthesis relationship<a name='9047'></font>
    REAL :: QE25_TABLE(MVT)        <font color=#447700>!quantum efficiency at 25c (umol co2 / umol photon)<a name='9048'></font>
    REAL :: AQE_TABLE(MVT)         <font color=#447700>!q10 for qe25<a name='9049'></font>
    REAL :: RMF25_TABLE(MVT)       <font color=#447700>!leaf maintenance respiration at 25c (umol co2/m**2/s)<a name='9050'></font>
    REAL :: RMS25_TABLE(MVT)       <font color=#447700>!stem maintenance respiration at 25c (umol co2/kg bio/s)<a name='9051'></font>
    REAL :: RMR25_TABLE(MVT)       <font color=#447700>!root maintenance respiration at 25c (umol co2/kg bio/s)<a name='9052'></font>
    REAL :: ARM_TABLE(MVT)         <font color=#447700>!q10 for maintenance respiration<a name='9053'></font>
    REAL :: FOLNMX_TABLE(MVT)      <font color=#447700>!foliage nitrogen concentration when f(n)=1 (%)<a name='9054'></font>
    REAL :: TMIN_TABLE(MVT)        <font color=#447700>!minimum temperature for photosynthesis (k)<a name='9055'></font>
<a name='9056'>
    REAL :: XL_TABLE(MVT)          <font color=#447700>!leaf/stem orientation index<a name='9057'></font>
    REAL :: RHOL_TABLE(MVT,MBAND)  <font color=#447700>!leaf reflectance: 1=vis, 2=nir<a name='9058'></font>
    REAL :: RHOS_TABLE(MVT,MBAND)  <font color=#447700>!stem reflectance: 1=vis, 2=nir<a name='9059'></font>
    REAL :: TAUL_TABLE(MVT,MBAND)  <font color=#447700>!leaf transmittance: 1=vis, 2=nir<a name='9060'></font>
    REAL :: TAUS_TABLE(MVT,MBAND)  <font color=#447700>!stem transmittance: 1=vis, 2=nir<a name='9061'></font>
<a name='9062'>
    REAL :: MRP_TABLE(MVT)         <font color=#447700>!microbial respiration parameter (umol co2 /kg c/ s)<a name='9063'></font>
    REAL :: CWPVT_TABLE(MVT)       <font color=#447700>!empirical canopy wind parameter<a name='9064'></font>
<a name='9065'>
    REAL :: WRRAT_TABLE(MVT)       <font color=#447700>!wood to non-wood ratio<a name='9066'></font>
    REAL :: WDPOOL_TABLE(MVT)      <font color=#447700>!wood pool (switch 1 or 0) depending on woody or not [-]<a name='9067'></font>
    REAL :: TDLEF_TABLE(MVT)       <font color=#447700>!characteristic T for leaf freezing [K]<a name='9068'></font>
<a name='9069'>
    REAL :: NROOT_TABLE(MVT)       <font color=#447700>!number of soil layers with root present<a name='9070'></font>
    REAL :: RGL_TABLE(MVT)         <font color=#447700>!Parameter used in radiation stress function<a name='9071'></font>
    REAL :: RS_TABLE(MVT)          <font color=#447700>!Minimum stomatal resistance [s m-1]<a name='9072'></font>
    REAL :: HS_TABLE(MVT)          <font color=#447700>!Parameter used in vapor pressure deficit function<a name='9073'></font>
    REAL :: TOPT_TABLE(MVT)        <font color=#447700>!Optimum transpiration air temperature [K]<a name='9074'></font>
    REAL :: RSMAX_TABLE(MVT)       <font color=#447700>!Maximal stomatal resistance [s m-1]<a name='9075'></font>
<a name='9076'>
<font color=#447700>! SOILPARM.TBL parameters<a name='9077'></font>
<a name='9078'>
    INTEGER            :: SLCATS<a name='9079'>
<a name='9080'>
    REAL :: BEXP_TABLE(MAX_SOILTYP)          <font color=#447700>!maximum intercepted h2o per unit lai+sai (mm)<a name='9081'></font>
    REAL :: SMCDRY_TABLE(MAX_SOILTYP)      <font color=#447700>!characteristic leaf dimension (m)<a name='9082'></font>
    REAL :: F1_TABLE(MAX_SOILTYP)         <font color=#447700>!momentum roughness length (m)<a name='9083'></font>
    REAL :: SMCMAX_TABLE(MAX_SOILTYP)      <font color=#447700>!top of canopy (m)<a name='9084'></font>
    REAL :: SMCREF_TABLE(MAX_SOILTYP)      <font color=#447700>!bottom of canopy (m)<a name='9085'></font>
    REAL :: PSISAT_TABLE(MAX_SOILTYP)      <font color=#447700>!tree density (no. of trunks per m2)<a name='9086'></font>
    REAL :: DKSAT_TABLE(MAX_SOILTYP)       <font color=#447700>!tree crown radius (m)<a name='9087'></font>
    REAL :: DWSAT_TABLE(MAX_SOILTYP)       <font color=#447700>!monthly stem area index, one-sided<a name='9088'></font>
    REAL :: SMCWLT_TABLE(MAX_SOILTYP)      <font color=#447700>!monthly leaf area index, one-sided<a name='9089'></font>
    REAL :: QUARTZ_TABLE(MAX_SOILTYP)         <font color=#447700>!single-side leaf area per Kg [m2/kg]<a name='9090'></font>
<a name='9091'>
<font color=#447700>! GENPARM.TBL parameters<a name='9092'></font>
<a name='9093'>
    REAL :: SLOPE_TABLE(9)    <font color=#447700>!slope factor for soil drainage<a name='9094'></font>
    <a name='9095'>
    REAL :: CSOIL_TABLE       <font color=#447700>!Soil heat capacity [J m-3 K-1]<a name='9096'></font>
    REAL :: REFDK_TABLE       <font color=#447700>!Parameter in the surface runoff parameterization<a name='9097'></font>
    REAL :: REFKDT_TABLE      <font color=#447700>!Parameter in the surface runoff parameterization<a name='9098'></font>
    REAL :: FRZK_TABLE        <font color=#447700>!Frozen ground parameter<a name='9099'></font>
    REAL :: ZBOT_TABLE        <font color=#447700>!Depth [m] of lower boundary soil temperature<a name='9100'></font>
    REAL :: CZIL_TABLE        <font color=#447700>!Parameter used in the calculation of the roughness length for heat<a name='9101'></font>
<a name='9102'>
<font color=#447700>! MPTABLE.TBL radiation parameters<a name='9103'></font>
<a name='9104'>
    REAL :: ALBSAT_TABLE(MSC,MBAND)   <font color=#447700>!saturated soil albedos: 1=vis, 2=nir<a name='9105'></font>
    REAL :: ALBDRY_TABLE(MSC,MBAND)   <font color=#447700>!dry soil albedos: 1=vis, 2=nir<a name='9106'></font>
    REAL :: ALBICE_TABLE(MBAND)       <font color=#447700>!albedo land ice: 1=vis, 2=nir<a name='9107'></font>
    REAL :: ALBLAK_TABLE(MBAND)       <font color=#447700>!albedo frozen lakes: 1=vis, 2=nir<a name='9108'></font>
    REAL :: OMEGAS_TABLE(MBAND)       <font color=#447700>!two-stream parameter omega for snow<a name='9109'></font>
    REAL :: BETADS_TABLE              <font color=#447700>!two-stream parameter betad for snow<a name='9110'></font>
    REAL :: BETAIS_TABLE              <font color=#447700>!two-stream parameter betad for snow<a name='9111'></font>
    REAL :: EG_TABLE(2)               <font color=#447700>!emissivity<a name='9112'></font>
<a name='9113'>
<font color=#447700>! MPTABLE.TBL global parameters<a name='9114'></font>
<a name='9115'>
    REAL :: CO2_TABLE      <font color=#447700>!co2 partial pressure<a name='9116'></font>
    REAL :: O2_TABLE       <font color=#447700>!o2 partial pressure<a name='9117'></font>
    REAL :: TIMEAN_TABLE   <font color=#447700>!gridcell mean topgraphic index (global mean)<a name='9118'></font>
    REAL :: FSATMX_TABLE   <font color=#447700>!maximum surface saturated fraction (global mean)<a name='9119'></font>
    REAL :: Z0SNO_TABLE    <font color=#447700>!snow surface roughness length (m) (0.002)<a name='9120'></font>
    REAL :: SSI_TABLE      <font color=#447700>!liquid water holding capacity for snowpack (m3/m3) (0.03)<a name='9121'></font>
    REAL :: SWEMX_TABLE    <font color=#447700>!new snow mass to fully cover old snow (mm)<a name='9122'></font>
    REAL :: RSURF_SNOW_TABLE    <font color=#447700>!surface resistance for snow(s/m)<a name='9123'></font>
<a name='9124'>
<font color=#447700>! MPTABLE.TBL crop parameters<a name='9125'></font>
<a name='9126'>
 INTEGER :: DEFAULT_CROP_TABLE          <font color=#447700>! Default crop index<a name='9127'></font>
 INTEGER :: PLTDAY_TABLE(NCROP)         <font color=#447700>! Planting date<a name='9128'></font>
 INTEGER :: HSDAY_TABLE(NCROP)          <font color=#447700>! Harvest date<a name='9129'></font>
    REAL :: PLANTPOP_TABLE(NCROP)       <font color=#447700>! Plant density [per ha] - used?<a name='9130'></font>
    REAL :: IRRI_TABLE(NCROP)           <font color=#447700>! Irrigation strategy 0= non-irrigation 1=irrigation (no water-stress)<a name='9131'></font>
<a name='9132'>
    REAL :: GDDTBASE_TABLE(NCROP)       <font color=#447700>! Base temperature for GDD accumulation [C]<a name='9133'></font>
    REAL :: GDDTCUT_TABLE(NCROP)        <font color=#447700>! Upper temperature for GDD accumulation [C]<a name='9134'></font>
    REAL :: GDDS1_TABLE(NCROP)          <font color=#447700>! GDD from seeding to emergence<a name='9135'></font>
    REAL :: GDDS2_TABLE(NCROP)          <font color=#447700>! GDD from seeding to initial vegetative <a name='9136'></font>
    REAL :: GDDS3_TABLE(NCROP)          <font color=#447700>! GDD from seeding to post vegetative <a name='9137'></font>
    REAL :: GDDS4_TABLE(NCROP)          <font color=#447700>! GDD from seeding to intial reproductive<a name='9138'></font>
    REAL :: GDDS5_TABLE(NCROP)          <font color=#447700>! GDD from seeding to pysical maturity <a name='9139'></font>
<a name='9140'>
 INTEGER :: C3C4_TABLE(NCROP)           <font color=#447700>! photosynthetic pathway:  1. = c3 2. = c4<a name='9141'></font>
    REAL :: AREF_TABLE(NCROP)           <font color=#447700>! reference maximum CO2 assimulation rate <a name='9142'></font>
    REAL :: PSNRF_TABLE(NCROP)          <font color=#447700>! CO2 assimulation reduction factor(0-1) (caused by non-modeling part,e.g.pest,weeds)<a name='9143'></font>
    REAL :: I2PAR_TABLE(NCROP)          <font color=#447700>! Fraction of incoming solar radiation to photosynthetically active radiation<a name='9144'></font>
    REAL :: TASSIM0_TABLE(NCROP)        <font color=#447700>! Minimum temperature for CO2 assimulation [C]<a name='9145'></font>
    REAL :: TASSIM1_TABLE(NCROP)        <font color=#447700>! CO2 assimulation linearly increasing until temperature reaches T1 [C]<a name='9146'></font>
    REAL :: TASSIM2_TABLE(NCROP)        <font color=#447700>! CO2 assmilation rate remain at Aref until temperature reaches T2 [C]<a name='9147'></font>
    REAL :: K_TABLE(NCROP)              <font color=#447700>! light extinction coefficient<a name='9148'></font>
    REAL :: EPSI_TABLE(NCROP)           <font color=#447700>! initial light use efficiency<a name='9149'></font>
<a name='9150'>
    REAL :: Q10MR_TABLE(NCROP)          <font color=#447700>! q10 for maintainance respiration<a name='9151'></font>
    REAL :: FOLN_MX_TABLE(NCROP)        <font color=#447700>! foliage nitrogen concentration when f(n)=1 (%)<a name='9152'></font>
    REAL :: LEFREEZ_TABLE(NCROP)        <font color=#447700>! characteristic T for leaf freezing [K]<a name='9153'></font>
<a name='9154'>
    REAL :: DILE_FC_TABLE(NCROP,NSTAGE) <font color=#447700>! coeficient for temperature leaf stress death [1/s]<a name='9155'></font>
    REAL :: DILE_FW_TABLE(NCROP,NSTAGE) <font color=#447700>! coeficient for water leaf stress death [1/s]<a name='9156'></font>
    REAL :: FRA_GR_TABLE(NCROP)         <font color=#447700>! fraction of growth respiration<a name='9157'></font>
<a name='9158'>
    REAL :: LF_OVRC_TABLE(NCROP,NSTAGE) <font color=#447700>! fraction of leaf turnover  [1/s]<a name='9159'></font>
    REAL :: ST_OVRC_TABLE(NCROP,NSTAGE) <font color=#447700>! fraction of stem turnover  [1/s]<a name='9160'></font>
    REAL :: RT_OVRC_TABLE(NCROP,NSTAGE) <font color=#447700>! fraction of root tunrover  [1/s]<a name='9161'></font>
    REAL :: LFMR25_TABLE(NCROP)         <font color=#447700>!  leaf maintenance respiration at 25C [umol CO2/m**2  /s]<a name='9162'></font>
    REAL :: STMR25_TABLE(NCROP)         <font color=#447700>!  stem maintenance respiration at 25C [umol CO2/kg bio/s]<a name='9163'></font>
    REAL :: RTMR25_TABLE(NCROP)         <font color=#447700>!  root maintenance respiration at 25C [umol CO2/kg bio/s]<a name='9164'></font>
    REAL :: GRAINMR25_TABLE(NCROP)      <font color=#447700>! grain maintenance respiration at 25C [umol CO2/kg bio/s]<a name='9165'></font>
<a name='9166'>
    REAL :: LFPT_TABLE(NCROP,NSTAGE)    <font color=#447700>! fraction of carbohydrate flux to leaf<a name='9167'></font>
    REAL :: STPT_TABLE(NCROP,NSTAGE)    <font color=#447700>! fraction of carbohydrate flux to stem<a name='9168'></font>
    REAL :: RTPT_TABLE(NCROP,NSTAGE)    <font color=#447700>! fraction of carbohydrate flux to root<a name='9169'></font>
    REAL :: GRAINPT_TABLE(NCROP,NSTAGE) <font color=#447700>! fraction of carbohydrate flux to grain<a name='9170'></font>
    REAL :: BIO2LAI_TABLE(NCROP)        <font color=#447700>! leaf are per living leaf biomass [m^2/kg]<a name='9171'></font>
<a name='9172'>
CONTAINS<a name='9173'>
<a name='9174'>
<A NAME='READ_MP_VEG_PARAMETERS'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_VEG_PARAMETERS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='9175'>
  <font color=#993300>subroutine </font><font color=#cc0000>read_mp_veg_parameters</font>(DATASET_IDENTIFIER) <A href='../../call_to/READ_MP_VEG_PARAMETERS.html' TARGET='index'>1</A>,<A href='../../call_from/READ_MP_VEG_PARAMETERS.html' TARGET='index'>2</A><a name='9176'>
    implicit none<a name='9177'>
    character(len=*), intent(in) :: DATASET_IDENTIFIER<a name='9178'>
    integer :: ierr<a name='9179'>
    INTEGER :: IK,IM<a name='9180'>
<a name='9181'>
    integer :: NVEG<a name='9182'>
    character(len=256) :: VEG_DATASET_DESCRIPTION<a name='9183'>
<a name='9184'>
    INTEGER :: ISURBAN<a name='9185'>
    INTEGER :: ISWATER<a name='9186'>
    INTEGER :: ISBARREN<a name='9187'>
    INTEGER :: ISICE<a name='9188'>
    INTEGER :: ISCROP<a name='9189'>
    INTEGER :: EBLFOREST<a name='9190'>
    INTEGER :: NATURAL<a name='9191'>
    INTEGER :: LOW_DENSITY_RESIDENTIAL<a name='9192'>
    INTEGER :: HIGH_DENSITY_RESIDENTIAL<a name='9193'>
    INTEGER :: HIGH_INTENSITY_INDUSTRIAL<a name='9194'>
<a name='9195'>
    REAL, DIMENSION(MVT) :: SAI_JAN,SAI_FEB,SAI_MAR,SAI_APR,SAI_MAY,SAI_JUN, &amp;<a name='9196'>
                                     SAI_JUL,SAI_AUG,SAI_SEP,SAI_OCT,SAI_NOV,SAI_DEC<a name='9197'>
    REAL, DIMENSION(MVT) :: LAI_JAN,LAI_FEB,LAI_MAR,LAI_APR,LAI_MAY,LAI_JUN, &amp;<a name='9198'>
                                     LAI_JUL,LAI_AUG,LAI_SEP,LAI_OCT,LAI_NOV,LAI_DEC<a name='9199'>
    REAL, DIMENSION(MVT) :: RHOL_VIS, RHOL_NIR, RHOS_VIS, RHOS_NIR, &amp;<a name='9200'>
                                     TAUL_VIS, TAUL_NIR, TAUS_VIS, TAUS_NIR<a name='9201'>
    REAL, DIMENSION(MVT) :: CH2OP, DLEAF, Z0MVT, HVT, HVB, DEN, RC, MFSNO, XL, CWPVT, C3PSN, KC25, AKC, KO25, AKO, &amp;<a name='9202'>
                     AVCMX, AQE, LTOVRC,  DILEFC,  DILEFW,  RMF25 ,  SLA   ,  FRAGR ,  TMIN  ,  VCMX25,  TDLEF ,  &amp;<a name='9203'>
                     BP, MP, QE25, RMS25, RMR25, ARM, FOLNMX, WDPOOL, WRRAT, MRP, NROOT, RGL, RS, HS, TOPT, RSMAX, &amp;<a name='9204'>
		     SLAREA, EPS1, EPS2, EPS3, EPS4, EPS5<a name='9205'>
			     <a name='9206'>
    NAMELIST / noahmp_usgs_veg_categories / VEG_DATASET_DESCRIPTION, NVEG<a name='9207'>
    NAMELIST / noahmp_usgs_parameters / ISURBAN, ISWATER, ISBARREN, ISICE, ISCROP, EBLFOREST, NATURAL, &amp;<a name='9208'>
         LOW_DENSITY_RESIDENTIAL, HIGH_DENSITY_RESIDENTIAL, HIGH_INTENSITY_INDUSTRIAL, &amp;<a name='9209'>
         CH2OP, DLEAF, Z0MVT, HVT, HVB, DEN, RC, MFSNO, XL, CWPVT, C3PSN, KC25, AKC, KO25, AKO, AVCMX, AQE, &amp;<a name='9210'>
         LTOVRC,  DILEFC,  DILEFW,  RMF25 ,  SLA   ,  FRAGR ,  TMIN  ,  VCMX25,  TDLEF ,  BP, MP, QE25, RMS25, RMR25, ARM, &amp;<a name='9211'>
         FOLNMX, WDPOOL, WRRAT, MRP, NROOT, RGL, RS, HS, TOPT, RSMAX, &amp;<a name='9212'>
         SAI_JAN, SAI_FEB, SAI_MAR, SAI_APR, SAI_MAY, SAI_JUN,SAI_JUL,SAI_AUG,SAI_SEP,SAI_OCT,SAI_NOV,SAI_DEC, &amp;<a name='9213'>
         LAI_JAN, LAI_FEB, LAI_MAR, LAI_APR, LAI_MAY, LAI_JUN,LAI_JUL,LAI_AUG,LAI_SEP,LAI_OCT,LAI_NOV,LAI_DEC, &amp;<a name='9214'>
         RHOL_VIS, RHOL_NIR, RHOS_VIS, RHOS_NIR, TAUL_VIS, TAUL_NIR, TAUS_VIS, TAUS_NIR, SLAREA, EPS1, EPS2, EPS3, EPS4, EPS5<a name='9215'>
	 <a name='9216'>
    NAMELIST / noahmp_modis_veg_categories / VEG_DATASET_DESCRIPTION, NVEG<a name='9217'>
    NAMELIST / noahmp_modis_parameters / ISURBAN, ISWATER, ISBARREN, ISICE, ISCROP, EBLFOREST, NATURAL, &amp;<a name='9218'>
         LOW_DENSITY_RESIDENTIAL, HIGH_DENSITY_RESIDENTIAL, HIGH_INTENSITY_INDUSTRIAL, &amp;<a name='9219'>
         CH2OP, DLEAF, Z0MVT, HVT, HVB, DEN, RC, MFSNO, XL, CWPVT, C3PSN, KC25, AKC, KO25, AKO, AVCMX, AQE, &amp;<a name='9220'>
         LTOVRC,  DILEFC,  DILEFW,  RMF25 ,  SLA   ,  FRAGR ,  TMIN  ,  VCMX25,  TDLEF ,  BP, MP, QE25, RMS25, RMR25, ARM, &amp;<a name='9221'>
         FOLNMX, WDPOOL, WRRAT, MRP, NROOT, RGL, RS, HS, TOPT, RSMAX, &amp;<a name='9222'>
         SAI_JAN, SAI_FEB, SAI_MAR, SAI_APR, SAI_MAY, SAI_JUN,SAI_JUL,SAI_AUG,SAI_SEP,SAI_OCT,SAI_NOV,SAI_DEC, &amp;<a name='9223'>
         LAI_JAN, LAI_FEB, LAI_MAR, LAI_APR, LAI_MAY, LAI_JUN,LAI_JUL,LAI_AUG,LAI_SEP,LAI_OCT,LAI_NOV,LAI_DEC, &amp;<a name='9224'>
         RHOL_VIS, RHOL_NIR, RHOS_VIS, RHOS_NIR, TAUL_VIS, TAUL_NIR, TAUS_VIS, TAUS_NIR, SLAREA, EPS1, EPS2, EPS3, EPS4, EPS5<a name='9225'>
<a name='9226'>
    <font color=#447700>! Initialize our variables to bad values, so that if the namelist read fails, we come to a screeching halt as soon as we try to use anything.<a name='9227'></font>
    CH2OP_TABLE  = -1.E36<a name='9228'>
    DLEAF_TABLE  = -1.E36<a name='9229'>
    Z0MVT_TABLE  = -1.E36<a name='9230'>
    HVT_TABLE    = -1.E36<a name='9231'>
    HVB_TABLE    = -1.E36<a name='9232'>
    DEN_TABLE    = -1.E36<a name='9233'>
    RC_TABLE     = -1.E36<a name='9234'>
    MFSNO_TABLE  = -1.E36<a name='9235'>
    RHOL_TABLE   = -1.E36<a name='9236'>
    RHOS_TABLE   = -1.E36<a name='9237'>
    TAUL_TABLE   = -1.E36<a name='9238'>
    TAUS_TABLE   = -1.E36<a name='9239'>
    XL_TABLE     = -1.E36<a name='9240'>
    CWPVT_TABLE  = -1.E36<a name='9241'>
    C3PSN_TABLE  = -1.E36<a name='9242'>
    KC25_TABLE   = -1.E36<a name='9243'>
    AKC_TABLE    = -1.E36<a name='9244'>
    KO25_TABLE   = -1.E36<a name='9245'>
    AKO_TABLE    = -1.E36<a name='9246'>
    AVCMX_TABLE  = -1.E36<a name='9247'>
    AQE_TABLE    = -1.E36<a name='9248'>
    LTOVRC_TABLE = -1.E36<a name='9249'>
    DILEFC_TABLE = -1.E36<a name='9250'>
    DILEFW_TABLE = -1.E36<a name='9251'>
    RMF25_TABLE  = -1.E36<a name='9252'>
    SLA_TABLE    = -1.E36<a name='9253'>
    FRAGR_TABLE  = -1.E36<a name='9254'>
    TMIN_TABLE   = -1.E36<a name='9255'>
    VCMX25_TABLE = -1.E36<a name='9256'>
    TDLEF_TABLE  = -1.E36<a name='9257'>
    BP_TABLE     = -1.E36<a name='9258'>
    MP_TABLE     = -1.E36<a name='9259'>
    QE25_TABLE   = -1.E36<a name='9260'>
    RMS25_TABLE  = -1.E36<a name='9261'>
    RMR25_TABLE  = -1.E36<a name='9262'>
    ARM_TABLE    = -1.E36<a name='9263'>
    FOLNMX_TABLE = -1.E36<a name='9264'>
    WDPOOL_TABLE = -1.E36<a name='9265'>
    WRRAT_TABLE  = -1.E36<a name='9266'>
    MRP_TABLE    = -1.E36<a name='9267'>
    SAIM_TABLE   = -1.E36<a name='9268'>
    LAIM_TABLE   = -1.E36<a name='9269'>
    NROOT_TABLE  = -1.E36<a name='9270'>
    RGL_TABLE    = -1.E36<a name='9271'>
    RS_TABLE     = -1.E36<a name='9272'>
    HS_TABLE     = -1.E36<a name='9273'>
    TOPT_TABLE   = -1.E36<a name='9274'>
    RSMAX_TABLE  = -1.E36<a name='9275'>
    ISURBAN_TABLE      = -99999<a name='9276'>
    ISWATER_TABLE      = -99999<a name='9277'>
    ISBARREN_TABLE     = -99999<a name='9278'>
    ISICE_TABLE        = -99999<a name='9279'>
    ISCROP_TABLE       = -99999<a name='9280'>
    EBLFOREST_TABLE    = -99999<a name='9281'>
    NATURAL_TABLE      = -99999<a name='9282'>
    LOW_DENSITY_RESIDENTIAL_TABLE   = -99999<a name='9283'>
    HIGH_DENSITY_RESIDENTIAL_TABLE  = -99999<a name='9284'>
    HIGH_INTENSITY_INDUSTRIAL_TABLE = -99999<a name='9285'>
<a name='9286'>
    open(15, file="MPTABLE.TBL", status='old', form='formatted', action='read', iostat=ierr)<a name='9287'>
    if (ierr /= 0) then<a name='9288'>
       write(*,'("****** Error ******************************************************")')<a name='9289'>
       write(*,'("Cannot find file MPTABLE.TBL")')<a name='9290'>
       write(*,'("STOP")')<a name='9291'>
       write(*,'("*******************************************************************")')<a name='9292'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_VEG_PARAMETERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1192">("STOP in Noah-MP read_mp_veg_parameters")<a name='9293'>
    endif<a name='9294'>
<a name='9295'>
    if ( trim(DATASET_IDENTIFIER) == "USGS" ) then<a name='9296'>
       read(15,noahmp_usgs_veg_categories)<a name='9297'>
       read(15,noahmp_usgs_parameters)<a name='9298'>
    else if ( trim(DATASET_IDENTIFIER) == "MODIFIED_IGBP_MODIS_NOAH" ) then<a name='9299'>
       read(15,noahmp_modis_veg_categories)<a name='9300'>
       read(15,noahmp_modis_parameters)<a name='9301'>
    else<a name='9302'>
       write(*,'("Unrecognized DATASET_IDENTIFIER in subroutine READ_MP_VEG_PARAMETERS")')<a name='9303'>
       write(*,'("DATASET_IDENTIFIER = ''", A, "''")') trim(DATASET_IDENTIFIER)<a name='9304'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_VEG_PARAMETERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1193">("STOP in Noah-MP read_mp_veg_parameters")<a name='9305'>
    endif<a name='9306'>
    close(15)<a name='9307'>
<a name='9308'>
                      ISURBAN_TABLE   = ISURBAN<a name='9309'>
                      ISWATER_TABLE   = ISWATER<a name='9310'>
                     ISBARREN_TABLE   = ISBARREN<a name='9311'>
                        ISICE_TABLE   = ISICE<a name='9312'>
                       ISCROP_TABLE   = ISCROP<a name='9313'>
                    EBLFOREST_TABLE   = EBLFOREST<a name='9314'>
                      NATURAL_TABLE   = NATURAL<a name='9315'>
      LOW_DENSITY_RESIDENTIAL_TABLE   = LOW_DENSITY_RESIDENTIAL<a name='9316'>
     HIGH_DENSITY_RESIDENTIAL_TABLE   = HIGH_DENSITY_RESIDENTIAL<a name='9317'>
    HIGH_INTENSITY_INDUSTRIAL_TABLE   = HIGH_INTENSITY_INDUSTRIAL<a name='9318'>
<a name='9319'>
     CH2OP_TABLE(1:NVEG)  = CH2OP(1:NVEG)<a name='9320'>
     DLEAF_TABLE(1:NVEG)  = DLEAF(1:NVEG)<a name='9321'>
     Z0MVT_TABLE(1:NVEG)  = Z0MVT(1:NVEG)<a name='9322'>
       HVT_TABLE(1:NVEG)  = HVT(1:NVEG)<a name='9323'>
       HVB_TABLE(1:NVEG)  = HVB(1:NVEG)<a name='9324'>
       DEN_TABLE(1:NVEG)  = DEN(1:NVEG)<a name='9325'>
        RC_TABLE(1:NVEG)  = RC(1:NVEG)<a name='9326'>
     MFSNO_TABLE(1:NVEG)  = MFSNO(1:NVEG)<a name='9327'>
        XL_TABLE(1:NVEG)  = XL(1:NVEG)<a name='9328'>
     CWPVT_TABLE(1:NVEG)  = CWPVT(1:NVEG)<a name='9329'>
     C3PSN_TABLE(1:NVEG)  = C3PSN(1:NVEG)<a name='9330'>
      KC25_TABLE(1:NVEG)  = KC25(1:NVEG)<a name='9331'>
       AKC_TABLE(1:NVEG)  = AKC(1:NVEG)<a name='9332'>
      KO25_TABLE(1:NVEG)  = KO25(1:NVEG)<a name='9333'>
       AKO_TABLE(1:NVEG)  = AKO(1:NVEG)<a name='9334'>
     AVCMX_TABLE(1:NVEG)  = AVCMX(1:NVEG)<a name='9335'>
       AQE_TABLE(1:NVEG)  = AQE(1:NVEG)<a name='9336'>
    LTOVRC_TABLE(1:NVEG)  = LTOVRC(1:NVEG)<a name='9337'>
    DILEFC_TABLE(1:NVEG)  = DILEFC(1:NVEG)<a name='9338'>
    DILEFW_TABLE(1:NVEG)  = DILEFW(1:NVEG)<a name='9339'>
     RMF25_TABLE(1:NVEG)  = RMF25(1:NVEG)<a name='9340'>
       SLA_TABLE(1:NVEG)  = SLA(1:NVEG)<a name='9341'>
     FRAGR_TABLE(1:NVEG)  = FRAGR(1:NVEG)<a name='9342'>
      TMIN_TABLE(1:NVEG)  = TMIN(1:NVEG)<a name='9343'>
    VCMX25_TABLE(1:NVEG)  = VCMX25(1:NVEG)<a name='9344'>
     TDLEF_TABLE(1:NVEG)  = TDLEF(1:NVEG)<a name='9345'>
        BP_TABLE(1:NVEG)  = BP(1:NVEG)<a name='9346'>
        MP_TABLE(1:NVEG)  = MP(1:NVEG)<a name='9347'>
      QE25_TABLE(1:NVEG)  = QE25(1:NVEG)<a name='9348'>
     RMS25_TABLE(1:NVEG)  = RMS25(1:NVEG)<a name='9349'>
     RMR25_TABLE(1:NVEG)  = RMR25(1:NVEG)<a name='9350'>
       ARM_TABLE(1:NVEG)  = ARM(1:NVEG)<a name='9351'>
    FOLNMX_TABLE(1:NVEG)  = FOLNMX(1:NVEG)<a name='9352'>
    WDPOOL_TABLE(1:NVEG)  = WDPOOL(1:NVEG)<a name='9353'>
     WRRAT_TABLE(1:NVEG)  = WRRAT(1:NVEG)<a name='9354'>
       MRP_TABLE(1:NVEG)  = MRP(1:NVEG)<a name='9355'>
     NROOT_TABLE(1:NVEG)  = NROOT(1:NVEG)<a name='9356'>
       RGL_TABLE(1:NVEG)  = RGL(1:NVEG)<a name='9357'>
        RS_TABLE(1:NVEG)  = RS(1:NVEG)<a name='9358'>
        HS_TABLE(1:NVEG)  = HS(1:NVEG)<a name='9359'>
      TOPT_TABLE(1:NVEG)  = TOPT(1:NVEG)<a name='9360'>
     RSMAX_TABLE(1:NVEG)  = RSMAX(1:NVEG)<a name='9361'>
    <a name='9362'>
    <font color=#447700>! Put LAI and SAI into 2d array from monthly lines in table; same for canopy radiation properties<a name='9363'></font>
<a name='9364'>
    SAIM_TABLE(1:NVEG, 1) = SAI_JAN(1:NVEG)<a name='9365'>
    SAIM_TABLE(1:NVEG, 2) = SAI_FEB(1:NVEG)<a name='9366'>
    SAIM_TABLE(1:NVEG, 3) = SAI_MAR(1:NVEG)<a name='9367'>
    SAIM_TABLE(1:NVEG, 4) = SAI_APR(1:NVEG)<a name='9368'>
    SAIM_TABLE(1:NVEG, 5) = SAI_MAY(1:NVEG)<a name='9369'>
    SAIM_TABLE(1:NVEG, 6) = SAI_JUN(1:NVEG)<a name='9370'>
    SAIM_TABLE(1:NVEG, 7) = SAI_JUL(1:NVEG)<a name='9371'>
    SAIM_TABLE(1:NVEG, 8) = SAI_AUG(1:NVEG)<a name='9372'>
    SAIM_TABLE(1:NVEG, 9) = SAI_SEP(1:NVEG)<a name='9373'>
    SAIM_TABLE(1:NVEG,10) = SAI_OCT(1:NVEG)<a name='9374'>
    SAIM_TABLE(1:NVEG,11) = SAI_NOV(1:NVEG)<a name='9375'>
    SAIM_TABLE(1:NVEG,12) = SAI_DEC(1:NVEG)<a name='9376'>
<a name='9377'>
    LAIM_TABLE(1:NVEG, 1) = LAI_JAN(1:NVEG)<a name='9378'>
    LAIM_TABLE(1:NVEG, 2) = LAI_FEB(1:NVEG)<a name='9379'>
    LAIM_TABLE(1:NVEG, 3) = LAI_MAR(1:NVEG)<a name='9380'>
    LAIM_TABLE(1:NVEG, 4) = LAI_APR(1:NVEG)<a name='9381'>
    LAIM_TABLE(1:NVEG, 5) = LAI_MAY(1:NVEG)<a name='9382'>
    LAIM_TABLE(1:NVEG, 6) = LAI_JUN(1:NVEG)<a name='9383'>
    LAIM_TABLE(1:NVEG, 7) = LAI_JUL(1:NVEG)<a name='9384'>
    LAIM_TABLE(1:NVEG, 8) = LAI_AUG(1:NVEG)<a name='9385'>
    LAIM_TABLE(1:NVEG, 9) = LAI_SEP(1:NVEG)<a name='9386'>
    LAIM_TABLE(1:NVEG,10) = LAI_OCT(1:NVEG)<a name='9387'>
    LAIM_TABLE(1:NVEG,11) = LAI_NOV(1:NVEG)<a name='9388'>
    LAIM_TABLE(1:NVEG,12) = LAI_DEC(1:NVEG)<a name='9389'>
<a name='9390'>
    RHOL_TABLE(1:NVEG,1)  = RHOL_VIS(1:NVEG) <font color=#447700>!leaf reflectance: 1=vis, 2=nir<a name='9391'></font>
    RHOL_TABLE(1:NVEG,2)  = RHOL_NIR(1:NVEG) <font color=#447700>!leaf reflectance: 1=vis, 2=nir<a name='9392'></font>
    RHOS_TABLE(1:NVEG,1)  = RHOS_VIS(1:NVEG) <font color=#447700>!stem reflectance: 1=vis, 2=nir<a name='9393'></font>
    RHOS_TABLE(1:NVEG,2)  = RHOS_NIR(1:NVEG) <font color=#447700>!stem reflectance: 1=vis, 2=nir<a name='9394'></font>
    TAUL_TABLE(1:NVEG,1)  = TAUL_VIS(1:NVEG) <font color=#447700>!leaf transmittance: 1=vis, 2=nir<a name='9395'></font>
    TAUL_TABLE(1:NVEG,2)  = TAUL_NIR(1:NVEG) <font color=#447700>!leaf transmittance: 1=vis, 2=nir<a name='9396'></font>
    TAUS_TABLE(1:NVEG,1)  = TAUS_VIS(1:NVEG) <font color=#447700>!stem transmittance: 1=vis, 2=nir<a name='9397'></font>
    TAUS_TABLE(1:NVEG,2)  = TAUS_NIR(1:NVEG) <font color=#447700>!stem transmittance: 1=vis, 2=nir<a name='9398'></font>
<a name='9399'>
  end subroutine read_mp_veg_parameters<a name='9400'>
<a name='9401'>
<A NAME='READ_MP_SOIL_PARAMETERS'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_SOIL_PARAMETERS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='9402'>
  <font color=#993300>subroutine </font><font color=#cc0000>read_mp_soil_parameters</font>() <A href='../../call_to/READ_MP_SOIL_PARAMETERS.html' TARGET='index'>1</A>,<A href='../../call_from/READ_MP_SOIL_PARAMETERS.html' TARGET='index'>3</A><a name='9403'>
    IMPLICIT NONE<a name='9404'>
    INTEGER :: IERR<a name='9405'>
    CHARACTER*4         :: SLTYPE<a name='9406'>
    INTEGER             :: ITMP, NUM_SLOPE, LC<a name='9407'>
    CHARACTER(len=256)  :: message<a name='9408'>
    <a name='9409'>
<a name='9410'>
    <font color=#447700>! Initialize our variables to bad values, so that if the namelist read fails, we come to a screeching halt as soon as we try to use anything.<a name='9411'></font>
       BEXP_TABLE = -1.E36<a name='9412'>
     SMCDRY_TABLE = -1.E36<a name='9413'>
         F1_TABLE = -1.E36<a name='9414'>
     SMCMAX_TABLE = -1.E36<a name='9415'>
     SMCREF_TABLE = -1.E36<a name='9416'>
     PSISAT_TABLE = -1.E36<a name='9417'>
      DKSAT_TABLE = -1.E36<a name='9418'>
      DWSAT_TABLE = -1.E36<a name='9419'>
     SMCWLT_TABLE = -1.E36<a name='9420'>
     QUARTZ_TABLE = -1.E36<a name='9421'>
      SLOPE_TABLE = -1.E36<a name='9422'>
      CSOIL_TABLE = -1.E36<a name='9423'>
      REFDK_TABLE = -1.E36<a name='9424'>
     REFKDT_TABLE = -1.E36<a name='9425'>
       FRZK_TABLE = -1.E36<a name='9426'>
       ZBOT_TABLE = -1.E36<a name='9427'>
       CZIL_TABLE = -1.E36<a name='9428'>
<a name='9429'>
<font color=#447700>!<a name='9430'></font>
<font color=#447700>!-----READ IN SOIL PROPERTIES FROM SOILPARM.TBL<a name='9431'></font>
<font color=#447700>!<a name='9432'></font>
    OPEN(19, FILE='SOILPARM.TBL',FORM='FORMATTED',STATUS='OLD',IOSTAT=ierr)<a name='9433'>
    IF(ierr .NE. 0 ) THEN<a name='9434'>
      WRITE(message,FMT='(A)') 'module_sf_noahmpdrv.F: read_mp_soil_parameters: failure opening SOILPARM.TBL'<a name='9435'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_SOIL_PARAMETERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1194"> ( message )<a name='9436'>
    END IF<a name='9437'>
<a name='9438'>
    READ (19,*)<a name='9439'>
    READ (19,*) SLTYPE<a name='9440'>
    READ (19,*) SLCATS<a name='9441'>
    WRITE( message , * ) 'SOIL TEXTURE CLASSIFICATION = ', TRIM ( SLTYPE ) , ' FOUND', &amp;<a name='9442'>
               SLCATS,' CATEGORIES'<a name='9443'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_SOIL_PARAMETERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_982"> ( message )<a name='9444'>
<a name='9445'>
    DO LC=1,SLCATS<a name='9446'>
      READ (19,*) ITMP,BEXP_TABLE(LC),SMCDRY_TABLE(LC),F1_TABLE(LC),SMCMAX_TABLE(LC),    &amp;<a name='9447'>
                  SMCREF_TABLE(LC),PSISAT_TABLE(LC),DKSAT_TABLE(LC), DWSAT_TABLE(LC),   &amp;<a name='9448'>
                  SMCWLT_TABLE(LC), QUARTZ_TABLE(LC)<a name='9449'>
    ENDDO<a name='9450'>
<a name='9451'>
    CLOSE (19)<a name='9452'>
<a name='9453'>
<font color=#447700>!<a name='9454'></font>
<font color=#447700>!-----READ IN GENERAL PARAMETERS FROM GENPARM.TBL<a name='9455'></font>
<font color=#447700>!<a name='9456'></font>
    OPEN(19, FILE='GENPARM.TBL',FORM='FORMATTED',STATUS='OLD',IOSTAT=ierr)<a name='9457'>
    IF(ierr .NE. 0 ) THEN<a name='9458'>
      WRITE(message,FMT='(A)') 'module_sf_noahlsm.F: read_mp_soil_parameters: failure opening GENPARM.TBL'<a name='9459'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_SOIL_PARAMETERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1195"> ( message )<a name='9460'>
    END IF<a name='9461'>
<a name='9462'>
    READ (19,*)<a name='9463'>
    READ (19,*)<a name='9464'>
    READ (19,*) NUM_SLOPE<a name='9465'>
<a name='9466'>
    DO LC=1,NUM_SLOPE<a name='9467'>
        READ (19,*) SLOPE_TABLE(LC)<a name='9468'>
    ENDDO<a name='9469'>
<a name='9470'>
    READ (19,*)<a name='9471'>
    READ (19,*)<a name='9472'>
    READ (19,*)<a name='9473'>
    READ (19,*)<a name='9474'>
    READ (19,*)<a name='9475'>
    READ (19,*) CSOIL_TABLE<a name='9476'>
    READ (19,*)<a name='9477'>
    READ (19,*)<a name='9478'>
    READ (19,*)<a name='9479'>
    READ (19,*) REFDK_TABLE<a name='9480'>
    READ (19,*)<a name='9481'>
    READ (19,*) REFKDT_TABLE<a name='9482'>
    READ (19,*)<a name='9483'>
    READ (19,*) FRZK_TABLE<a name='9484'>
    READ (19,*)<a name='9485'>
    READ (19,*) ZBOT_TABLE<a name='9486'>
    READ (19,*)<a name='9487'>
    READ (19,*) CZIL_TABLE<a name='9488'>
    READ (19,*)<a name='9489'>
    READ (19,*)<a name='9490'>
    READ (19,*)<a name='9491'>
    READ (19,*)<a name='9492'>
<a name='9493'>
    CLOSE (19)<a name='9494'>
<a name='9495'>
  end subroutine read_mp_soil_parameters<a name='9496'>
<a name='9497'>
<A NAME='READ_MP_RAD_PARAMETERS'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_RAD_PARAMETERS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='9498'>
  <font color=#993300>subroutine </font><font color=#cc0000>read_mp_rad_parameters</font>() <A href='../../call_to/READ_MP_RAD_PARAMETERS.html' TARGET='index'>1</A>,<A href='../../call_from/READ_MP_RAD_PARAMETERS.html' TARGET='index'>1</A><a name='9499'>
    implicit none<a name='9500'>
    integer :: ierr<a name='9501'>
<a name='9502'>
    REAL :: ALBICE(MBAND),ALBLAK(MBAND),OMEGAS(MBAND),BETADS,BETAIS,EG(2)<a name='9503'>
    REAL :: ALBSAT_VIS(MSC)<a name='9504'>
    REAL :: ALBSAT_NIR(MSC)<a name='9505'>
    REAL :: ALBDRY_VIS(MSC)<a name='9506'>
    REAL :: ALBDRY_NIR(MSC)<a name='9507'>
<a name='9508'>
    NAMELIST / noahmp_rad_parameters / ALBSAT_VIS,ALBSAT_NIR,ALBDRY_VIS,ALBDRY_NIR,ALBICE,ALBLAK,OMEGAS,BETADS,BETAIS,EG<a name='9509'>
<a name='9510'>
<a name='9511'>
    <font color=#447700>! Initialize our variables to bad values, so that if the namelist read fails, we come to a screeching halt as soon as we try to use anything.<a name='9512'></font>
    ALBSAT_TABLE     = -1.E36<a name='9513'>
    ALBDRY_TABLE     = -1.E36<a name='9514'>
    ALBICE_TABLE     = -1.E36<a name='9515'>
    ALBLAK_TABLE     = -1.E36<a name='9516'>
    OMEGAS_TABLE     = -1.E36<a name='9517'>
    BETADS_TABLE     = -1.E36<a name='9518'>
    BETAIS_TABLE     = -1.E36<a name='9519'>
    EG_TABLE         = -1.E36<a name='9520'>
<a name='9521'>
    open(15, file="MPTABLE.TBL", status='old', form='formatted', action='read', iostat=ierr)<a name='9522'>
    if (ierr /= 0) then<a name='9523'>
       write(*,'("****** Error ******************************************************")')<a name='9524'>
       write(*,'("Cannot find file MPTABLE.TBL")')<a name='9525'>
       write(*,'("STOP")')<a name='9526'>
       write(*,'("*******************************************************************")')<a name='9527'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_RAD_PARAMETERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1196">("STOP in Noah-MP read_mp_rad_parameters")<a name='9528'>
    endif<a name='9529'>
<a name='9530'>
    read(15,noahmp_rad_parameters)<a name='9531'>
    close(15)<a name='9532'>
<a name='9533'>
    ALBSAT_TABLE(:,1) = ALBSAT_VIS <font color=#447700>! saturated soil albedos: 1=vis, 2=nir<a name='9534'></font>
    ALBSAT_TABLE(:,2) = ALBSAT_NIR <font color=#447700>! saturated soil albedos: 1=vis, 2=nir<a name='9535'></font>
    ALBDRY_TABLE(:,1) = ALBDRY_VIS <font color=#447700>! dry soil albedos: 1=vis, 2=nir<a name='9536'></font>
    ALBDRY_TABLE(:,2) = ALBDRY_NIR <font color=#447700>! dry soil albedos: 1=vis, 2=nir<a name='9537'></font>
    ALBICE_TABLE      = ALBICE<a name='9538'>
    ALBLAK_TABLE      = ALBLAK<a name='9539'>
    OMEGAS_TABLE      = OMEGAS<a name='9540'>
    BETADS_TABLE      = BETADS<a name='9541'>
    BETAIS_TABLE      = BETAIS<a name='9542'>
    EG_TABLE          = EG<a name='9543'>
<a name='9544'>
  end subroutine read_mp_rad_parameters<a name='9545'>
<a name='9546'>
<A NAME='READ_MP_GLOBAL_PARAMETERS'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_GLOBAL_PARAMETERS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='9547'>
  <font color=#993300>subroutine </font><font color=#cc0000>read_mp_global_parameters</font>() <A href='../../call_to/READ_MP_GLOBAL_PARAMETERS.html' TARGET='index'>1</A>,<A href='../../call_from/READ_MP_GLOBAL_PARAMETERS.html' TARGET='index'>1</A><a name='9548'>
    implicit none<a name='9549'>
    integer :: ierr<a name='9550'>
<a name='9551'>
    REAL :: CO2,O2,TIMEAN,FSATMX,Z0SNO,SSI,SWEMX,RSURF_SNOW<a name='9552'>
<a name='9553'>
    NAMELIST / noahmp_global_parameters / CO2,O2,TIMEAN,FSATMX,Z0SNO,SSI,SWEMX,RSURF_SNOW<a name='9554'>
<a name='9555'>
<a name='9556'>
    <font color=#447700>! Initialize our variables to bad values, so that if the namelist read fails, we come to a screeching halt as soon as we try to use anything.<a name='9557'></font>
       CO2_TABLE     = -1.E36<a name='9558'>
        O2_TABLE     = -1.E36<a name='9559'>
    TIMEAN_TABLE     = -1.E36<a name='9560'>
    FSATMX_TABLE     = -1.E36<a name='9561'>
     Z0SNO_TABLE     = -1.E36<a name='9562'>
       SSI_TABLE     = -1.E36<a name='9563'>
     SWEMX_TABLE     = -1.E36<a name='9564'>
RSURF_SNOW_TABLE     = -1.E36<a name='9565'>
<a name='9566'>
    open(15, file="MPTABLE.TBL", status='old', form='formatted', action='read', iostat=ierr)<a name='9567'>
    if (ierr /= 0) then<a name='9568'>
       write(*,'("****** Error ******************************************************")')<a name='9569'>
       write(*,'("Cannot find file MPTABLE.TBL")')<a name='9570'>
       write(*,'("STOP")')<a name='9571'>
       write(*,'("*******************************************************************")')<a name='9572'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_GLOBAL_PARAMETERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1197">("STOP in Noah-MP read_mp_global_parameters")<a name='9573'>
    endif<a name='9574'>
<a name='9575'>
    read(15,noahmp_global_parameters)<a name='9576'>
    close(15)<a name='9577'>
<a name='9578'>
       CO2_TABLE     = CO2<a name='9579'>
        O2_TABLE     = O2<a name='9580'>
    TIMEAN_TABLE     = TIMEAN<a name='9581'>
    FSATMX_TABLE     = FSATMX<a name='9582'>
     Z0SNO_TABLE     = Z0SNO<a name='9583'>
       SSI_TABLE     = SSI<a name='9584'>
     SWEMX_TABLE     = SWEMX<a name='9585'>
RSURF_SNOW_TABLE     = RSURF_SNOW<a name='9586'>
<a name='9587'>
  end subroutine read_mp_global_parameters<a name='9588'>
<a name='9589'>
<A NAME='READ_MP_CROP_PARAMETERS'><A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_CROP_PARAMETERS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='9590'>
  <font color=#993300>subroutine </font><font color=#cc0000>read_mp_crop_parameters</font>() <A href='../../call_to/READ_MP_CROP_PARAMETERS.html' TARGET='index'>1</A>,<A href='../../call_from/READ_MP_CROP_PARAMETERS.html' TARGET='index'>1</A><a name='9591'>
    implicit none<a name='9592'>
    integer :: ierr<a name='9593'>
<a name='9594'>
 INTEGER                   :: DEFAULT_CROP<a name='9595'>
 INTEGER, DIMENSION(NCROP) :: PLTDAY<a name='9596'>
 INTEGER, DIMENSION(NCROP) :: HSDAY<a name='9597'>
    REAL, DIMENSION(NCROP) :: PLANTPOP<a name='9598'>
    REAL, DIMENSION(NCROP) :: IRRI<a name='9599'>
    REAL, DIMENSION(NCROP) :: GDDTBASE<a name='9600'>
    REAL, DIMENSION(NCROP) :: GDDTCUT<a name='9601'>
    REAL, DIMENSION(NCROP) :: GDDS1<a name='9602'>
    REAL, DIMENSION(NCROP) :: GDDS2<a name='9603'>
    REAL, DIMENSION(NCROP) :: GDDS3<a name='9604'>
    REAL, DIMENSION(NCROP) :: GDDS4<a name='9605'>
    REAL, DIMENSION(NCROP) :: GDDS5<a name='9606'>
 INTEGER, DIMENSION(NCROP) :: C3C4<a name='9607'>
    REAL, DIMENSION(NCROP) :: AREF<a name='9608'>
    REAL, DIMENSION(NCROP) :: PSNRF<a name='9609'>
    REAL, DIMENSION(NCROP) :: I2PAR<a name='9610'>
    REAL, DIMENSION(NCROP) :: TASSIM0<a name='9611'>
    REAL, DIMENSION(NCROP) :: TASSIM1<a name='9612'>
    REAL, DIMENSION(NCROP) :: TASSIM2<a name='9613'>
    REAL, DIMENSION(NCROP) :: K<a name='9614'>
    REAL, DIMENSION(NCROP) :: EPSI<a name='9615'>
    REAL, DIMENSION(NCROP) :: Q10MR<a name='9616'>
    REAL, DIMENSION(NCROP) :: FOLN_MX<a name='9617'>
    REAL, DIMENSION(NCROP) :: LEFREEZ<a name='9618'>
    REAL, DIMENSION(NCROP) :: DILE_FC_S1,DILE_FC_S2,DILE_FC_S3,DILE_FC_S4,DILE_FC_S5,DILE_FC_S6,DILE_FC_S7,DILE_FC_S8<a name='9619'>
    REAL, DIMENSION(NCROP) :: DILE_FW_S1,DILE_FW_S2,DILE_FW_S3,DILE_FW_S4,DILE_FW_S5,DILE_FW_S6,DILE_FW_S7,DILE_FW_S8<a name='9620'>
    REAL, DIMENSION(NCROP) :: FRA_GR<a name='9621'>
    REAL, DIMENSION(NCROP) :: LF_OVRC_S1,LF_OVRC_S2,LF_OVRC_S3,LF_OVRC_S4,LF_OVRC_S5,LF_OVRC_S6,LF_OVRC_S7,LF_OVRC_S8<a name='9622'>
    REAL, DIMENSION(NCROP) :: ST_OVRC_S1,ST_OVRC_S2,ST_OVRC_S3,ST_OVRC_S4,ST_OVRC_S5,ST_OVRC_S6,ST_OVRC_S7,ST_OVRC_S8<a name='9623'>
    REAL, DIMENSION(NCROP) :: RT_OVRC_S1,RT_OVRC_S2,RT_OVRC_S3,RT_OVRC_S4,RT_OVRC_S5,RT_OVRC_S6,RT_OVRC_S7,RT_OVRC_S8<a name='9624'>
    REAL, DIMENSION(NCROP) :: LFMR25<a name='9625'>
    REAL, DIMENSION(NCROP) :: STMR25<a name='9626'>
    REAL, DIMENSION(NCROP) :: RTMR25<a name='9627'>
    REAL, DIMENSION(NCROP) :: GRAINMR25<a name='9628'>
    REAL, DIMENSION(NCROP) :: LFPT_S1,LFPT_S2,LFPT_S3,LFPT_S4,LFPT_S5,LFPT_S6,LFPT_S7,LFPT_S8<a name='9629'>
    REAL, DIMENSION(NCROP) :: STPT_S1,STPT_S2,STPT_S3,STPT_S4,STPT_S5,STPT_S6,STPT_S7,STPT_S8<a name='9630'>
    REAL, DIMENSION(NCROP) :: RTPT_S1,RTPT_S2,RTPT_S3,RTPT_S4,RTPT_S5,RTPT_S6,RTPT_S7,RTPT_S8<a name='9631'>
    REAL, DIMENSION(NCROP) :: GRAINPT_S1,GRAINPT_S2,GRAINPT_S3,GRAINPT_S4,GRAINPT_S5,GRAINPT_S6,GRAINPT_S7,GRAINPT_S8<a name='9632'>
    REAL, DIMENSION(NCROP) :: BIO2LAI<a name='9633'>
<a name='9634'>
<a name='9635'>
    NAMELIST / noahmp_crop_parameters /DEFAULT_CROP,   PLTDAY,     HSDAY,  PLANTPOP,      IRRI,  GDDTBASE,   GDDTCUT,     GDDS1,     GDDS2, &amp;<a name='9636'>
                                             GDDS3,     GDDS4,     GDDS5,      C3C4,      AREF,     PSNRF,     I2PAR,   TASSIM0, &amp;<a name='9637'>
                                           TASSIM1,   TASSIM2,         K,      EPSI,     Q10MR,   FOLN_MX,   LEFREEZ,            &amp;<a name='9638'>
                                        DILE_FC_S1,DILE_FC_S2,DILE_FC_S3,DILE_FC_S4,DILE_FC_S5,DILE_FC_S6,DILE_FC_S7,DILE_FC_S8, &amp;<a name='9639'>
                                        DILE_FW_S1,DILE_FW_S2,DILE_FW_S3,DILE_FW_S4,DILE_FW_S5,DILE_FW_S6,DILE_FW_S7,DILE_FW_S8, &amp;<a name='9640'>
                                            FRA_GR,                                                                              &amp;<a name='9641'>
                                        LF_OVRC_S1,LF_OVRC_S2,LF_OVRC_S3,LF_OVRC_S4,LF_OVRC_S5,LF_OVRC_S6,LF_OVRC_S7,LF_OVRC_S8, &amp;<a name='9642'>
                                        ST_OVRC_S1,ST_OVRC_S2,ST_OVRC_S3,ST_OVRC_S4,ST_OVRC_S5,ST_OVRC_S6,ST_OVRC_S7,ST_OVRC_S8, &amp;<a name='9643'>
                                        RT_OVRC_S1,RT_OVRC_S2,RT_OVRC_S3,RT_OVRC_S4,RT_OVRC_S5,RT_OVRC_S6,RT_OVRC_S7,RT_OVRC_S8, &amp;<a name='9644'>
                                            LFMR25,    STMR25,    RTMR25, GRAINMR25,                                             &amp;<a name='9645'>
                                           LFPT_S1,   LFPT_S2,   LFPT_S3,   LFPT_S4,   LFPT_S5,   LFPT_S6,   LFPT_S7,   LFPT_S8, &amp;<a name='9646'>
                                           STPT_S1,   STPT_S2,   STPT_S3,   STPT_S4,   STPT_S5,   STPT_S6,   STPT_S7,   STPT_S8, &amp;<a name='9647'>
                                           RTPT_S1,   RTPT_S2,   RTPT_S3,   RTPT_S4,   RTPT_S5,   RTPT_S6,   RTPT_S7,   RTPT_S8, &amp;<a name='9648'>
                                        GRAINPT_S1,GRAINPT_S2,GRAINPT_S3,GRAINPT_S4,GRAINPT_S5,GRAINPT_S6,GRAINPT_S7,GRAINPT_S8, &amp;<a name='9649'>
                                           BIO2LAI<a name='9650'>
<a name='9651'>
<a name='9652'>
    <font color=#447700>! Initialize our variables to bad values, so that if the namelist read fails, we come to a screeching halt as soon as we try to use anything.<a name='9653'></font>
 DEFAULT_CROP_TABLE     = -99999<a name='9654'>
       PLTDAY_TABLE     = -99999<a name='9655'>
        HSDAY_TABLE     = -99999<a name='9656'>
     PLANTPOP_TABLE     = -1.E36<a name='9657'>
         IRRI_TABLE     = -1.E36<a name='9658'>
     GDDTBASE_TABLE     = -1.E36<a name='9659'>
      GDDTCUT_TABLE     = -1.E36<a name='9660'>
        GDDS1_TABLE     = -1.E36<a name='9661'>
        GDDS2_TABLE     = -1.E36<a name='9662'>
        GDDS3_TABLE     = -1.E36<a name='9663'>
        GDDS4_TABLE     = -1.E36<a name='9664'>
        GDDS5_TABLE     = -1.E36<a name='9665'>
         C3C4_TABLE     = -99999<a name='9666'>
         AREF_TABLE     = -1.E36<a name='9667'>
        PSNRF_TABLE     = -1.E36<a name='9668'>
        I2PAR_TABLE     = -1.E36<a name='9669'>
      TASSIM0_TABLE     = -1.E36<a name='9670'>
      TASSIM1_TABLE     = -1.E36<a name='9671'>
      TASSIM2_TABLE     = -1.E36<a name='9672'>
            K_TABLE     = -1.E36<a name='9673'>
         EPSI_TABLE     = -1.E36<a name='9674'>
        Q10MR_TABLE     = -1.E36<a name='9675'>
      FOLN_MX_TABLE     = -1.E36<a name='9676'>
      LEFREEZ_TABLE     = -1.E36<a name='9677'>
      DILE_FC_TABLE     = -1.E36<a name='9678'>
      DILE_FW_TABLE     = -1.E36<a name='9679'>
       FRA_GR_TABLE     = -1.E36<a name='9680'>
      LF_OVRC_TABLE     = -1.E36<a name='9681'>
      ST_OVRC_TABLE     = -1.E36<a name='9682'>
      RT_OVRC_TABLE     = -1.E36<a name='9683'>
       LFMR25_TABLE     = -1.E36<a name='9684'>
       STMR25_TABLE     = -1.E36<a name='9685'>
       RTMR25_TABLE     = -1.E36<a name='9686'>
    GRAINMR25_TABLE     = -1.E36<a name='9687'>
         LFPT_TABLE     = -1.E36<a name='9688'>
         STPT_TABLE     = -1.E36<a name='9689'>
         RTPT_TABLE     = -1.E36<a name='9690'>
      GRAINPT_TABLE     = -1.E36<a name='9691'>
      BIO2LAI_TABLE     = -1.E36<a name='9692'>
<a name='9693'>
<a name='9694'>
    open(15, file="MPTABLE.TBL", status='old', form='formatted', action='read', iostat=ierr)<a name='9695'>
    if (ierr /= 0) then<a name='9696'>
       write(*,'("****** Error ******************************************************")')<a name='9697'>
       write(*,'("Cannot find file MPTABLE.TBL")')<a name='9698'>
       write(*,'("STOP")')<a name='9699'>
       write(*,'("*******************************************************************")')<a name='9700'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_CROP_PARAMETERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1198">("STOP in Noah-MP read_mp_crop_parameters")<a name='9701'>
    endif<a name='9702'>
<a name='9703'>
    read(15,noahmp_crop_parameters)<a name='9704'>
    close(15)<a name='9705'>
<a name='9706'>
 DEFAULT_CROP_TABLE      = DEFAULT_CROP<a name='9707'>
       PLTDAY_TABLE      = PLTDAY<a name='9708'>
        HSDAY_TABLE      = HSDAY<a name='9709'>
     PLANTPOP_TABLE      = PLANTPOP<a name='9710'>
         IRRI_TABLE      = IRRI<a name='9711'>
     GDDTBASE_TABLE      = GDDTBASE<a name='9712'>
      GDDTCUT_TABLE      = GDDTCUT<a name='9713'>
        GDDS1_TABLE      = GDDS1<a name='9714'>
        GDDS2_TABLE      = GDDS2<a name='9715'>
        GDDS3_TABLE      = GDDS3<a name='9716'>
        GDDS4_TABLE      = GDDS4<a name='9717'>
        GDDS5_TABLE      = GDDS5<a name='9718'>
         C3C4_TABLE      = C3C4<a name='9719'>
         AREF_TABLE      = AREF<a name='9720'>
        PSNRF_TABLE      = PSNRF<a name='9721'>
        I2PAR_TABLE      = I2PAR<a name='9722'>
      TASSIM0_TABLE      = TASSIM0<a name='9723'>
      TASSIM1_TABLE      = TASSIM1<a name='9724'>
      TASSIM2_TABLE      = TASSIM2<a name='9725'>
            K_TABLE      = K<a name='9726'>
         EPSI_TABLE      = EPSI<a name='9727'>
        Q10MR_TABLE      = Q10MR<a name='9728'>
      FOLN_MX_TABLE      = FOLN_MX<a name='9729'>
      LEFREEZ_TABLE      = LEFREEZ<a name='9730'>
      DILE_FC_TABLE(:,1) = DILE_FC_S1<a name='9731'>
      DILE_FC_TABLE(:,2) = DILE_FC_S2<a name='9732'>
      DILE_FC_TABLE(:,3) = DILE_FC_S3<a name='9733'>
      DILE_FC_TABLE(:,4) = DILE_FC_S4<a name='9734'>
      DILE_FC_TABLE(:,5) = DILE_FC_S5<a name='9735'>
      DILE_FC_TABLE(:,6) = DILE_FC_S6<a name='9736'>
      DILE_FC_TABLE(:,7) = DILE_FC_S7<a name='9737'>
      DILE_FC_TABLE(:,8) = DILE_FC_S8<a name='9738'>
      DILE_FW_TABLE(:,1) = DILE_FW_S1<a name='9739'>
      DILE_FW_TABLE(:,2) = DILE_FW_S2<a name='9740'>
      DILE_FW_TABLE(:,3) = DILE_FW_S3<a name='9741'>
      DILE_FW_TABLE(:,4) = DILE_FW_S4<a name='9742'>
      DILE_FW_TABLE(:,5) = DILE_FW_S5<a name='9743'>
      DILE_FW_TABLE(:,6) = DILE_FW_S6<a name='9744'>
      DILE_FW_TABLE(:,7) = DILE_FW_S7<a name='9745'>
      DILE_FW_TABLE(:,8) = DILE_FW_S8<a name='9746'>
       FRA_GR_TABLE      = FRA_GR<a name='9747'>
      LF_OVRC_TABLE(:,1) = LF_OVRC_S1<a name='9748'>
      LF_OVRC_TABLE(:,2) = LF_OVRC_S2<a name='9749'>
      LF_OVRC_TABLE(:,3) = LF_OVRC_S3<a name='9750'>
      LF_OVRC_TABLE(:,4) = LF_OVRC_S4<a name='9751'>
      LF_OVRC_TABLE(:,5) = LF_OVRC_S5<a name='9752'>
      LF_OVRC_TABLE(:,6) = LF_OVRC_S6<a name='9753'>
      LF_OVRC_TABLE(:,7) = LF_OVRC_S7<a name='9754'>
      LF_OVRC_TABLE(:,8) = LF_OVRC_S8<a name='9755'>
      ST_OVRC_TABLE(:,1) = ST_OVRC_S1<a name='9756'>
      ST_OVRC_TABLE(:,2) = ST_OVRC_S2<a name='9757'>
      ST_OVRC_TABLE(:,3) = ST_OVRC_S3<a name='9758'>
      ST_OVRC_TABLE(:,4) = ST_OVRC_S4<a name='9759'>
      ST_OVRC_TABLE(:,5) = ST_OVRC_S5<a name='9760'>
      ST_OVRC_TABLE(:,6) = ST_OVRC_S6<a name='9761'>
      ST_OVRC_TABLE(:,7) = ST_OVRC_S7<a name='9762'>
      ST_OVRC_TABLE(:,8) = ST_OVRC_S8<a name='9763'>
      RT_OVRC_TABLE(:,1) = RT_OVRC_S1<a name='9764'>
      RT_OVRC_TABLE(:,2) = RT_OVRC_S2<a name='9765'>
      RT_OVRC_TABLE(:,3) = RT_OVRC_S3<a name='9766'>
      RT_OVRC_TABLE(:,4) = RT_OVRC_S4<a name='9767'>
      RT_OVRC_TABLE(:,5) = RT_OVRC_S5<a name='9768'>
      RT_OVRC_TABLE(:,6) = RT_OVRC_S6<a name='9769'>
      RT_OVRC_TABLE(:,7) = RT_OVRC_S7<a name='9770'>
      RT_OVRC_TABLE(:,8) = RT_OVRC_S8<a name='9771'>
       LFMR25_TABLE      = LFMR25<a name='9772'>
       STMR25_TABLE      = STMR25<a name='9773'>
       RTMR25_TABLE      = RTMR25<a name='9774'>
    GRAINMR25_TABLE      = GRAINMR25<a name='9775'>
         LFPT_TABLE(:,1) = LFPT_S1<a name='9776'>
         LFPT_TABLE(:,2) = LFPT_S2<a name='9777'>
         LFPT_TABLE(:,3) = LFPT_S3<a name='9778'>
         LFPT_TABLE(:,4) = LFPT_S4<a name='9779'>
         LFPT_TABLE(:,5) = LFPT_S5<a name='9780'>
         LFPT_TABLE(:,6) = LFPT_S6<a name='9781'>
         LFPT_TABLE(:,7) = LFPT_S7<a name='9782'>
         LFPT_TABLE(:,8) = LFPT_S8<a name='9783'>
         STPT_TABLE(:,1) = STPT_S1<a name='9784'>
         STPT_TABLE(:,2) = STPT_S2<a name='9785'>
         STPT_TABLE(:,3) = STPT_S3<a name='9786'>
         STPT_TABLE(:,4) = STPT_S4<a name='9787'>
         STPT_TABLE(:,5) = STPT_S5<a name='9788'>
         STPT_TABLE(:,6) = STPT_S6<a name='9789'>
         STPT_TABLE(:,7) = STPT_S7<a name='9790'>
         STPT_TABLE(:,8) = STPT_S8<a name='9791'>
         RTPT_TABLE(:,1) = RTPT_S1<a name='9792'>
         RTPT_TABLE(:,2) = RTPT_S2<a name='9793'>
         RTPT_TABLE(:,3) = RTPT_S3<a name='9794'>
         RTPT_TABLE(:,4) = RTPT_S4<a name='9795'>
         RTPT_TABLE(:,5) = RTPT_S5<a name='9796'>
         RTPT_TABLE(:,6) = RTPT_S6<a name='9797'>
         RTPT_TABLE(:,7) = RTPT_S7<a name='9798'>
         RTPT_TABLE(:,8) = RTPT_S8<a name='9799'>
      GRAINPT_TABLE(:,1) = GRAINPT_S1<a name='9800'>
      GRAINPT_TABLE(:,2) = GRAINPT_S2<a name='9801'>
      GRAINPT_TABLE(:,3) = GRAINPT_S3<a name='9802'>
      GRAINPT_TABLE(:,4) = GRAINPT_S4<a name='9803'>
      GRAINPT_TABLE(:,5) = GRAINPT_S5<a name='9804'>
      GRAINPT_TABLE(:,6) = GRAINPT_S6<a name='9805'>
      GRAINPT_TABLE(:,7) = GRAINPT_S7<a name='9806'>
      GRAINPT_TABLE(:,8) = GRAINPT_S8<a name='9807'>
      BIO2LAI_TABLE      = BIO2LAI<a name='9808'>
<a name='9809'>
  end subroutine read_mp_crop_parameters<a name='9810'>
<a name='9811'>
END MODULE NOAHMP_TABLES<a name='9812'>
<a name='9813'>
</pre></body></html>