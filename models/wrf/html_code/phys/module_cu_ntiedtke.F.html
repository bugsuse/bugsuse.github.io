<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>!wrf:model_layer:physics<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<font color=#447700>!####################tiedtke scheme#########################<a name='6'></font>
<font color=#447700>!    m.tiedtke      e.c.m.w.f.      1989 <a name='7'></font>
<font color=#447700>!    j.morcrette                    1992<a name='8'></font>
<font color=#447700>!--------------------------------------------    <a name='9'></font>
<font color=#447700>!    modifications<a name='10'></font>
<font color=#447700>!    C. zhang &amp; Yuqing Wang         2011-2017<a name='11'></font>
<font color=#447700>!<a name='12'></font>
<font color=#447700>!   modified from IPRC IRAM - yuqing wang, university of hawaii<a name='13'></font>
<font color=#447700>!               &amp; ICTP REGCM4.4<a name='14'></font>
<font color=#447700>!<a name='15'></font>
<font color=#447700>!   The current version is stable.  There are many updates to the old Tiedtke scheme (cu_physics=6)<a name='16'></font>
<font color=#447700>!   update notes:<a name='17'></font>
<font color=#447700>!        the new Tiedtke scheme is similar to the Tiedtke scheme used in REGCM4 and ECMWF cy40r1.<a name='18'></font>
<font color=#447700>!        the major differences to the old Tiedtke (cu_physics=6) scheme are,<a name='19'></font>
<font color=#447700>!        (a) New trigger functions for deep and shallow convections (Jakob and Siebesma 2003;<a name='20'></font>
<font color=#447700>!            Bechtold et al. 2004, 2008, 2014).<a name='21'></font>
<font color=#447700>!        (b) Non-equilibrium situations are considered in the closure for deep convection<a name='22'></font>
<font color=#447700>!            (Bechtold et al. 2014).<a name='23'></font>
<font color=#447700>!        (c) New convection time scale for the deep convection closure (Bechtold et al. 2008).<a name='24'></font>
<font color=#447700>!        (d) New entrainment and detrainment rates for all convection types (Bechtold et al. 2008).<a name='25'></font>
<font color=#447700>!        (e) New formula for the conversion from cloud water/ice to rain/snow (Sundqvist 1978).<a name='26'></font>
<font color=#447700>!        (f) Different way to include cloud scale pressure gradients (Gregory et al. 1997;<a name='27'></font>
<font color=#447700>!            Wu and Yanai 1994)<a name='28'></font>
<font color=#447700>!<a name='29'></font>
<font color=#447700>!   other refenrence: tiedtke (1989, mwr, 117, 1779-1800)<a name='30'></font>
<font color=#447700>!                     IFS documentation - cy33r1, cy37r2, cy38r1, cy40r1<a name='31'></font>
<font color=#447700>!<a name='32'></font>
<font color=#447700>!===========================================================<a name='33'></font>
<font color=#447700>!  Note for climate simulation of Tropical Cyclones<a name='34'></font>
<font color=#447700>!  This version of Tiedtke scheme was tested with YSU PBL scheme, RRTMG radation<a name='35'></font>
<font color=#447700>!  schemes, and WSM6 microphysics schemes, at horizontal resolution around 20 km<a name='36'></font>
<font color=#447700>!  Set: momtrans = 2. <a name='37'></font>
<font color=#447700>!       pgcoef   = 0.7 to 1.0 is good depends on the basin <a name='38'></font>
<font color=#447700>!       nonequil = .false.<a name='39'></font>
<font color=#447700>!===========================================================<a name='40'></font>
<font color=#447700>!  Note for the diurnal simulation of precipitaton<a name='41'></font>
<font color=#447700>!  When nonequil = .true., the CAPE is relaxed toward to a value from PBL<a name='42'></font>
<font color=#447700>!  It can improve the diurnal precipitation over land. <a name='43'></font>
<font color=#447700>!===========================================================<a name='44'></font>
<font color=#447700>!###########################################################<a name='45'></font>
<a name='46'>
<A NAME='MODULE_CU_NTIEDTKE'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#MODULE_CU_NTIEDTKE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='47'>
<font color=#993300>module </font><font color=#cc0000>module_cu_ntiedtke</font> <A href='../../call_to/MODULE_CU_NTIEDTKE.html' TARGET='index'>2</A><a name='48'>
<a name='49'>
<font color=#447700>!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<a name='50'></font>
     use <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#module_cu_ntiedtke.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_51">, only:rd=&gt;r_d, rv=&gt;r_v, &amp;<a name='51'>
   &amp;       cpd=&gt;cp, alv=&gt;xlv, als=&gt;xls, alf=&gt;xlf, t13=&gt;Prandtl, g              <a name='52'>
<a name='53'>
     implicit none<a name='54'>
     real,private :: rcpd,vtmpc1,tmelt,                &amp;<a name='55'>
             c1es,c2es,c3les,c3ies,c4les,c4ies,c5les,c5ies,zrg<a name='56'>
<a name='57'>
     real,private :: r5alvcp,r5alscp,ralvdcp,ralsdcp,ralfdcp,rtwat,rtber,rtice <a name='58'>
     real,private :: entrdd,cmfcmax,cmfcmin,cmfdeps,zdnoprc,cprcon,pgcoef<a name='59'>
     integer,private :: momtrans<a name='60'>
<a name='61'>
     parameter(         &amp;<a name='62'>
      rcpd=1.0/cpd,     &amp;<a name='63'>
      tmelt=273.16,     &amp;<a name='64'>
      zrg=1.0/g,        &amp;<a name='65'>
      c1es=610.78,      &amp;<a name='66'>
      c2es=c1es*rd/rv,  &amp;<a name='67'>
      c3les=17.2693882, &amp;<a name='68'>
      c3ies=21.875,     &amp;<a name='69'>
      c4les=35.86,      &amp;<a name='70'>
      c4ies=7.66,       &amp;<a name='71'>
      c5les=c3les*(tmelt-c4les),  &amp;<a name='72'>
      c5ies=c3ies*(tmelt-c4ies),  &amp;<a name='73'>
      r5alvcp=c5les*alv*rcpd,     &amp;<a name='74'>
      r5alscp=c5ies*als*rcpd,     &amp;<a name='75'>
      ralvdcp=alv*rcpd,           &amp;<a name='76'>
      ralsdcp=als*rcpd,           &amp;<a name='77'>
      ralfdcp=alf*rcpd,           &amp;<a name='78'>
      rtwat=tmelt,                &amp;<a name='79'>
      rtber=tmelt-5.,             &amp;<a name='80'>
      rtice=tmelt-23.,            &amp;<a name='81'>
      vtmpc1=rv/rd-1.0 )<a name='82'>
<font color=#447700>!<a name='83'></font>
<font color=#447700>!     entrdd: average entrainment &amp; detrainment rate for downdrafts<a name='84'></font>
<font color=#447700>!     ------<a name='85'></font>
<font color=#447700>!<a name='86'></font>
      parameter(entrdd = 2.0e-4)<a name='87'>
<font color=#447700>!<a name='88'></font>
<font color=#447700>!     cmfcmax:   maximum massflux value allowed for updrafts etc<a name='89'></font>
<font color=#447700>!     -------<a name='90'></font>
<font color=#447700>!<a name='91'></font>
      parameter(cmfcmax = 1.0)<a name='92'>
<font color=#447700>!<a name='93'></font>
<font color=#447700>!     cmfcmin:   minimum massflux value (for safety)<a name='94'></font>
<font color=#447700>!     -------<a name='95'></font>
<font color=#447700>!<a name='96'></font>
      parameter(cmfcmin = 1.e-10)<a name='97'>
<font color=#447700>!<a name='98'></font>
<font color=#447700>!     cmfdeps:   fractional massflux for downdrafts at lfs<a name='99'></font>
<font color=#447700>!     -------<a name='100'></font>
<font color=#447700>!<a name='101'></font>
      parameter(cmfdeps = 0.30)<a name='102'>
<a name='103'>
<font color=#447700>!     zdnoprc:   deep cloud is thicker than this height (Unit:Pa)<a name='104'></font>
<font color=#447700>!<a name='105'></font>
      parameter(zdnoprc = 2.0e4)<a name='106'>
<font color=#447700>!     -------<a name='107'></font>
<font color=#447700>!   <a name='108'></font>
<font color=#447700>!     cprcon:    coefficient from cloud water to rain water<a name='109'></font>
<font color=#447700>!   <a name='110'></font>
      parameter(cprcon = 1.4e-3)<a name='111'>
<font color=#447700>!     -------<a name='112'></font>
<font color=#447700>!<a name='113'></font>
<font color=#447700>!     momtrans: momentum transport method<a name='114'></font>
<font color=#447700>!     ( 1 = IFS40r1 method; 2 = new method )<a name='115'></font>
<font color=#447700>!<a name='116'></font>
      parameter(momtrans = 2 )<a name='117'>
<font color=#447700>!     -------<a name='118'></font>
<font color=#447700>!<a name='119'></font>
<font color=#447700>!     coefficient for pressure gradient intensity<a name='120'></font>
<font color=#447700>!     (0.7 - 1.0 is recommended in this vesion of Tiedtke scheme) <a name='121'></font>
      parameter(pgcoef=0.7)<a name='122'>
<font color=#447700>!     -------<a name='123'></font>
<font color=#447700>!<a name='124'></font>
      logical :: nonequil<a name='125'>
<font color=#447700>!     nonequil: representing equilibrium and nonequilibrium convection<a name='126'></font>
<font color=#447700>!     ( .false. [equilibrium: removing all CAPE]; .true. [nonequilibrium: relaxing CAPE toward CAPE from PBL]. <a name='127'></font>
<font color=#447700>!       Ref. Bechtold et al. 2014 JAS )<a name='128'></font>
<font color=#447700>! <a name='129'></font>
      parameter(nonequil = .true. )<a name='130'>
<font color=#447700>!<a name='131'></font>
<font color=#447700>!--------------------<a name='132'></font>
<font color=#447700>!     switches for deep, mid, shallow convections, downdraft, and momentum transport<a name='133'></font>
<font color=#447700>!     ------------------<a name='134'></font>
      logical :: lmfpen,lmfmid,lmfscv,lmfdd,lmfdudv<a name='135'>
      parameter(lmfpen=.true.,lmfmid=.true.,lmfscv=.true.,lmfdd=.true.,lmfdudv=.true.)<a name='136'>
<font color=#447700>!--------------------<a name='137'></font>
<font color=#447700>!#################### end of variables definition##########################<a name='138'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='139'></font>
<font color=#447700>!<a name='140'></font>
contains<a name='141'>
<font color=#447700>!-----------------------------------------------------------------------<a name='142'></font>
<A NAME='CU_NTIEDTKE'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CU_NTIEDTKE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='143'>
     <font color=#993300>subroutine </font><font color=#cc0000>cu_ntiedtke</font>(                                    &amp; <A href='../../call_to/CU_NTIEDTKE.html' TARGET='index'>1</A>,<A href='../../call_from/CU_NTIEDTKE.html' TARGET='index'>1</A><a name='144'>
                 dt,itimestep,stepcu                            &amp;<a name='145'>
                ,raincv,pratec,qfx,hfx                          &amp;<a name='146'>
                ,u3d,v3d,w,t3d,qv3d,qc3d,qi3d,pi3d,rho3d        &amp;<a name='147'>
                ,qvften,thften                                  &amp;<a name='148'>
                ,dz8w,pcps,p8w,xland,cu_act_flag,dx             &amp;<a name='149'>
                ,ids,ide, jds,jde, kds,kde                      &amp;<a name='150'>
                ,ims,ime, jms,jme, kms,kme                      &amp;<a name='151'>
                ,its,ite, jts,jte, kts,kte                      &amp;<a name='152'>
                ,rthcuten,rqvcuten,rqccuten,rqicuten            &amp;<a name='153'>
                ,rucuten, rvcuten                               &amp;<a name='154'>
                ,f_qv    ,f_qc    ,f_qr    ,f_qi    ,f_qs       &amp;<a name='155'>
                                                                )<a name='156'>
<font color=#447700>!-------------------------------------------------------------------<a name='157'></font>
      implicit none<a name='158'>
<font color=#447700>!-------------------------------------------------------------------<a name='159'></font>
<font color=#447700>!-- u3d         3d u-velocity interpolated to theta points (m/s)<a name='160'></font>
<font color=#447700>!-- v3d         3d v-velocity interpolated to theta points (m/s)<a name='161'></font>
<font color=#447700>!-- th3d        3d potential temperature (k)<a name='162'></font>
<font color=#447700>!-- t3d         temperature (k)<a name='163'></font>
<font color=#447700>!-- qv3d        3d water vapor mixing ratio (kg/kg)<a name='164'></font>
<font color=#447700>!-- qc3d        3d cloud mixing ratio (kg/kg)<a name='165'></font>
<font color=#447700>!-- qi3d        3d ice mixing ratio (kg/kg)<a name='166'></font>
<font color=#447700>!-- rho3d       3d air density (kg/m^3)<a name='167'></font>
<font color=#447700>!-- p8w         3d hydrostatic pressure at full levels (pa)<a name='168'></font>
<font color=#447700>!-- pcps        3d hydrostatic pressure at half levels (pa)<a name='169'></font>
<font color=#447700>!-- pi3d        3d exner function (dimensionless)<a name='170'></font>
<font color=#447700>!-- qvften      3d total advective + PBL moisture tendency (kg kg-1 s-1)<a name='171'></font>
<font color=#447700>!-- thften      3d total advective + PBL + radiative temperature tendency (k s-1)<a name='172'></font>
<font color=#447700>!-- rthcuten      theta tendency due to <a name='173'></font>
<font color=#447700>!                 cumulus scheme precipitation (k/s)<a name='174'></font>
<font color=#447700>!-- rucuten       u wind tendency due to <a name='175'></font>
<font color=#447700>!                 cumulus scheme precipitation (k/s)<a name='176'></font>
<font color=#447700>!-- rvcuten       v wind tendency due to <a name='177'></font>
<font color=#447700>!                 cumulus scheme precipitation (k/s)<a name='178'></font>
<font color=#447700>!-- rqvcuten      qv tendency due to <a name='179'></font>
<font color=#447700>!                 cumulus scheme precipitation (kg/kg/s)<a name='180'></font>
<font color=#447700>!-- rqccuten      qc tendency due to <a name='181'></font>
<font color=#447700>!                 cumulus scheme precipitation (kg/kg/s)<a name='182'></font>
<font color=#447700>!-- rqicuten      qi tendency due to <a name='183'></font>
<font color=#447700>!                 cumulus scheme precipitation (kg/kg/s)<a name='184'></font>
<font color=#447700>!-- rainc         accumulated total cumulus scheme precipitation (mm)<a name='185'></font>
<font color=#447700>!-- raincv        cumulus scheme precipitation (mm)<a name='186'></font>
<font color=#447700>!-- pratec        precipitiation rate from cumulus scheme (mm/s)<a name='187'></font>
<font color=#447700>!-- dz8w        dz between full levels (m)<a name='188'></font>
<font color=#447700>!-- qfx         upward moisture flux at the surface (kg/m^2/s)<a name='189'></font>
<font color=#447700>!-- hfx         upward heat flux at the surface (w/m^2) <a name='190'></font>
<font color=#447700>!-- dt          time step (s)<a name='191'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='192'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='193'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='194'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='195'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='196'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='197'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='198'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='199'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='200'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='201'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='202'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='203'></font>
<font color=#447700>!-- its         start index for i in tile<a name='204'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='205'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='206'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='207'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='208'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='209'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='210'></font>
      integer, intent(in) ::            ids,ide, jds,jde, kds,kde,      &amp;<a name='211'>
                                        ims,ime, jms,jme, kms,kme,      &amp;<a name='212'>
                                        its,ite, jts,jte, kts,kte,      &amp;<a name='213'>
                                        itimestep,                      &amp;<a name='214'>
                                        stepcu<a name='215'>
<a name='216'>
      real,    intent(in) ::                                            &amp;<a name='217'>
                                        dt,                             &amp;<a name='218'>
                                        dx<a name='219'>
<a name='220'>
<a name='221'>
      real,    dimension(ims:ime, jms:jme), intent(in) ::               &amp;<a name='222'>
                                        xland<a name='223'>
<a name='224'>
      real,    dimension(ims:ime, jms:jme), intent(inout) ::            &amp;<a name='225'>
                                        raincv, pratec<a name='226'>
<a name='227'>
      logical, dimension(ims:ime,jms:jme), intent(inout) ::             &amp;<a name='228'>
                                        cu_act_flag<a name='229'>
<a name='230'>
<a name='231'>
      real,    dimension(ims:ime, kms:kme, jms:jme), intent(in) ::      &amp;<a name='232'>
                                        dz8w,                           &amp;<a name='233'>
                                        pcps,                           &amp;<a name='234'>
                                        p8w,                            &amp;<a name='235'>
                                        pi3d,                           &amp;<a name='236'>
                                        qc3d,                           &amp;<a name='237'>
                                        qvften,                         &amp;<a name='238'>
                                        thften,                         &amp;<a name='239'>
                                        qi3d,                           &amp;<a name='240'>
                                        qv3d,                           &amp;<a name='241'>
                                        rho3d,                          &amp;<a name='242'>
                                        t3d,                            &amp;<a name='243'>
                                        u3d,                            &amp;<a name='244'>
                                        v3d,                            &amp;<a name='245'>
                                        w<a name='246'>
      real,    dimension(ims:ime, jms:jme) ::                           &amp;<a name='247'>
                                        qfx,                            &amp;<a name='248'>
                                        hfx                            <a name='249'>
<a name='250'>
<font color=#447700>!--------------------------- optional vars ----------------------------<a name='251'></font>
<a name='252'>
      real, dimension(ims:ime, kms:kme, jms:jme),                       &amp;<a name='253'>
               optional, intent(inout) ::                               &amp;<a name='254'>
                                        rqccuten,                       &amp;<a name='255'>
                                        rqicuten,                       &amp;<a name='256'>
                                        rqvcuten,                       &amp;<a name='257'>
                                        rthcuten,                       &amp;<a name='258'>
                                        rucuten,                        &amp;<a name='259'>
                                        rvcuten<a name='260'>
<a name='261'>
<font color=#447700>!<a name='262'></font>
<font color=#447700>! flags relating to the optional tendency arrays declared above<a name='263'></font>
<font color=#447700>! models that carry the optional tendencies will provdide the<a name='264'></font>
<font color=#447700>! optional arguments at compile time; these flags all the model<a name='265'></font>
<font color=#447700>! to determine at run-time whether a particular tracer is in<a name='266'></font>
<font color=#447700>! use or not.<a name='267'></font>
<font color=#447700>!<a name='268'></font>
     logical, optional ::                                      &amp;<a name='269'>
                                                   f_qv      &amp;<a name='270'>
                                                  ,f_qc      &amp;<a name='271'>
                                                  ,f_qr      &amp;<a name='272'>
                                                  ,f_qi      &amp;<a name='273'>
                                                  ,f_qs<a name='274'>
<a name='275'>
<font color=#447700>!--------------------------- local vars ------------------------------<a name='276'></font>
      real      ::                                      &amp;<a name='277'>
                                        delt,                           &amp;<a name='278'>
                                        rdelt<a name='279'>
<a name='280'>
      real     , dimension(its:ite) ::                  &amp;<a name='281'>
                                        rcs,                            &amp;<a name='282'>
                                        rn,                             &amp;<a name='283'>
                                        evap,                           &amp;<a name='284'>
                                        heatflux<a name='285'>
      integer  , dimension(its:ite) ::  slimsk<a name='286'>
<a name='287'>
<a name='288'>
      real     , dimension(its:ite, kts:kte+1) ::         &amp;<a name='289'>
                                        prsi,           &amp;<a name='290'>
                                        ghti,           &amp;<a name='291'>
                                          zi <a name='292'>
<a name='293'>
      real     , dimension(its:ite, kts:kte) ::         &amp;<a name='294'>
                                        dot,                            &amp;<a name='295'>
                                        prsl,                           &amp;<a name='296'>
                                        q1,                             &amp;<a name='297'>
                                        q2,                             &amp;<a name='298'>
                                        q3,                             &amp;<a name='299'>
                                        q1b,                            &amp;<a name='300'>
                                        t1b,                            &amp;<a name='301'>
                                        q11,                            &amp;<a name='302'>
                                        q12,                            &amp;<a name='303'>
                                        t1,                             &amp;<a name='304'>
                                        u1,                             &amp;<a name='305'>
                                        v1,                             &amp;<a name='306'>
                                        zl,                             &amp;<a name='307'>
                                        omg,                            &amp;<a name='308'>
                                        ghtl                           <a name='309'>
<a name='310'>
      integer, dimension(its:ite) ::                                    &amp;<a name='311'>
                                        kbot,                           &amp;<a name='312'>
                                        ktop<a name='313'>
<a name='314'>
      integer ::                                                        &amp;<a name='315'>
                                        i,                              &amp;<a name='316'>
                                        im,                             &amp;<a name='317'>
                                        j,                              &amp;<a name='318'>
                                        k,                              &amp;<a name='319'>
                                        km,                             &amp;<a name='320'>
                                        kp,                             &amp;<a name='321'>
                                        kx,                             &amp;<a name='322'>
                                        kx1<a name='323'>
<a name='324'>
<font color=#447700>!-------other local variables----<a name='325'></font>
      integer                      :: zz, pp<a name='326'>
<font color=#447700>!-----------------------------------------------------------------------<a name='327'></font>
<font color=#447700>!<a name='328'></font>
<font color=#447700>!<a name='329'></font>
<font color=#447700>!***  check to see if this is a convection timestep<a name='330'></font>
<font color=#447700>!<a name='331'></font>
<a name='332'>
<font color=#447700>!-----------------------------------------------------------------------<a name='333'></font>
      do j=jts,jte<a name='334'>
         do i=its,ite<a name='335'>
            cu_act_flag(i,j)=.true.<a name='336'>
         enddo<a name='337'>
      enddo<a name='338'>
<a name='339'>
      im=ite-its+1<a name='340'>
      kx=kte-kts+1<a name='341'>
      kx1=kx+1<a name='342'>
      delt=dt*stepcu<a name='343'>
      rdelt=1./delt<a name='344'>
<a name='345'>
<font color=#447700>!-------------  j loop (outer) --------------------------------------------------<a name='346'></font>
<a name='347'>
   do j=jts,jte<a name='348'>
<a name='349'>
<font color=#447700>! --------------- compute zi and zl -----------------------------------------<a name='350'></font>
      do i=its,ite<a name='351'>
        zi(i,kts)=0.0<a name='352'>
      enddo<a name='353'>
<font color=#447700>!<a name='354'></font>
      do k=kts,kte<a name='355'>
        do i=its,ite<a name='356'>
          zi(i,k+1)=zi(i,k)+dz8w(i,k,j)<a name='357'>
        enddo<a name='358'>
      enddo<a name='359'>
<font color=#447700>!<a name='360'></font>
      do k=kts,kte<a name='361'>
        do i=its,ite<a name='362'>
          zl(i,k)=0.5*(zi(i,k)+zi(i,k+1))<a name='363'>
        enddo<a name='364'>
      enddo<a name='365'>
<a name='366'>
<font color=#447700>! --------------- end compute zi and zl -------------------------------------<a name='367'></font>
      do i=its,ite<a name='368'>
        slimsk(i)=int(abs(xland(i,j)-2.))<a name='369'>
      enddo<a name='370'>
<a name='371'>
      do k=kts,kte<a name='372'>
        kp=k+1<a name='373'>
        do i=its,ite<a name='374'>
          dot(i,k)=-0.5*g*rho3d(i,k,j)*(w(i,k,j)+w(i,kp,j))<a name='375'>
        enddo<a name='376'>
      enddo<a name='377'>
<a name='378'>
      pp = 0<a name='379'>
      do k=kts,kte<a name='380'>
        zz = kte-pp<a name='381'>
        do i=its,ite<a name='382'>
          u1(i,zz)=u3d(i,k,j)<a name='383'>
          v1(i,zz)=v3d(i,k,j)<a name='384'>
          t1(i,zz)=t3d(i,k,j)<a name='385'>
          q1(i,zz)=qv3d(i,k,j)<a name='386'>
          if(itimestep == 1) then<a name='387'>
             q1b(i,zz)=0.<a name='388'>
             t1b(i,zz)=0.<a name='389'>
          else<a name='390'>
             q1b(i,zz)=qvften(i,k,j)<a name='391'>
             t1b(i,zz)=thften(i,k,j)<a name='392'>
          endif<a name='393'>
          q2(i,zz)=qc3d(i,k,j)<a name='394'>
          q3(i,zz)=qi3d(i,k,j)<a name='395'>
          omg(i,zz)=dot(i,k)<a name='396'>
          ghtl(i,zz)=zl(i,k)<a name='397'>
          prsl(i,zz) = pcps(i,k,j)<a name='398'>
        enddo<a name='399'>
        pp = pp + 1<a name='400'>
      enddo<a name='401'>
<a name='402'>
      pp = 0<a name='403'>
      do k=kts,kte+1<a name='404'>
        zz = kte+1-pp<a name='405'>
        do i=its,ite<a name='406'>
          ghti(i,zz) = zi(i,k)<a name='407'>
          prsi(i,zz) = p8w(i,k,j) <a name='408'>
        enddo<a name='409'>
        pp = pp + 1<a name='410'>
      enddo<a name='411'>
<font color=#447700>!<a name='412'></font>
      do i=its,ite<a name='413'>
        evap(i)    = qfx(i,j)<a name='414'>
        heatflux(i)= hfx(i,j)<a name='415'>
      enddo<a name='416'>
<font color=#447700>!<a name='417'></font>
<font color=#447700>!########################################################################<a name='418'></font>
      call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#TIECNVN'>tiecnvn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CU_NTIEDTKE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TIECNVN_1">(u1,v1,t1,q1,q2,q3,q1b,t1b,ghtl,ghti,omg,prsl,prsi,evap,heatflux,  &amp;<a name='419'>
                  rn,slimsk,im,kx,kx1,delt,dx)<a name='420'>
<a name='421'>
      do i=its,ite<a name='422'>
         raincv(i,j)=rn(i)/stepcu<a name='423'>
         pratec(i,j)=rn(i)/(stepcu * dt)<a name='424'>
      enddo<a name='425'>
<a name='426'>
      pp = 0<a name='427'>
      do k=kts,kte<a name='428'>
        zz = kte-pp<a name='429'>
        do i=its,ite<a name='430'>
          rthcuten(i,k,j)=(t1(i,zz)-t3d(i,k,j))/pi3d(i,k,j)*rdelt<a name='431'>
          rqvcuten(i,k,j)=(q1(i,zz)-qv3d(i,k,j))*rdelt<a name='432'>
          rucuten(i,k,j) =(u1(i,zz)-u3d(i,k,j))*rdelt<a name='433'>
          rvcuten(i,k,j) =(v1(i,zz)-v3d(i,k,j))*rdelt<a name='434'>
        enddo<a name='435'>
        pp = pp + 1<a name='436'>
      enddo<a name='437'>
<a name='438'>
      if(present(rqccuten))then<a name='439'>
        if ( f_qc ) then<a name='440'>
          pp = 0<a name='441'>
          do k=kts,kte<a name='442'>
            zz = kte-pp<a name='443'>
            do i=its,ite<a name='444'>
              rqccuten(i,k,j)=(q2(i,zz)-qc3d(i,k,j))*rdelt<a name='445'>
            enddo<a name='446'>
            pp = pp + 1<a name='447'>
          enddo<a name='448'>
        endif<a name='449'>
      endif<a name='450'>
<a name='451'>
      if(present(rqicuten))then<a name='452'>
        if ( f_qi ) then<a name='453'>
          pp = 0<a name='454'>
          do k=kts,kte<a name='455'>
            zz = kte-pp<a name='456'>
            do i=its,ite<a name='457'>
              rqicuten(i,k,j)=(q3(i,zz)-qi3d(i,k,j))*rdelt<a name='458'>
            enddo<a name='459'>
            pp = pp + 1<a name='460'>
          enddo<a name='461'>
        endif<a name='462'>
      endif<a name='463'>
<a name='464'>
<a name='465'>
   enddo<a name='466'>
<a name='467'>
   end subroutine cu_ntiedtke<a name='468'>
<a name='469'>
<font color=#447700>!====================================================================<a name='470'></font>
<A NAME='NTIEDTKEINIT'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#NTIEDTKEINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='471'>
   <font color=#993300>subroutine </font><font color=#cc0000>ntiedtkeinit</font>(rthcuten,rqvcuten,rqccuten,rqicuten,         &amp; <A href='../../call_to/NTIEDTKEINIT.html' TARGET='index'>1</A><a name='472'>
                     rucuten,rvcuten,rthften,rqvften,                   &amp;<a name='473'>
                     restart,p_qc,p_qi,p_first_scalar,                  &amp;<a name='474'>
                     allowed_to_read,                                   &amp;<a name='475'>
                     ids, ide, jds, jde, kds, kde,                      &amp;<a name='476'>
                     ims, ime, jms, jme, kms, kme,                      &amp;<a name='477'>
                     its, ite, jts, jte, kts, kte)<a name='478'>
<font color=#447700>!--------------------------------------------------------------------<a name='479'></font>
   implicit none<a name='480'>
<font color=#447700>!--------------------------------------------------------------------<a name='481'></font>
   logical , intent(in)           ::  allowed_to_read,restart<a name='482'>
   integer , intent(in)           ::  ids, ide, jds, jde, kds, kde, &amp;<a name='483'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='484'>
                                      its, ite, jts, jte, kts, kte<a name='485'>
   integer , intent(in)           ::  p_first_scalar, p_qi, p_qc<a name='486'>
<a name='487'>
   real,     dimension( ims:ime , kms:kme , jms:jme ) , intent(out) ::  &amp;<a name='488'>
                                                              rthcuten, &amp;<a name='489'>
                                                              rqvcuten, &amp;<a name='490'>
                                                              rqccuten, &amp;<a name='491'>
                                                              rqicuten, &amp;<a name='492'>
                                                              rucuten,rvcuten,&amp;<a name='493'>
                                                              rthften,rqvften<a name='494'>
<a name='495'>
   integer :: i, j, k, itf, jtf, ktf<a name='496'>
<a name='497'>
   jtf=min0(jte,jde-1)<a name='498'>
   ktf=min0(kte,kde-1)<a name='499'>
   itf=min0(ite,ide-1)<a name='500'>
<a name='501'>
   if(.not.restart)then<a name='502'>
     do j=jts,jtf<a name='503'>
     do k=kts,ktf<a name='504'>
     do i=its,itf<a name='505'>
       rthcuten(i,k,j)=0.<a name='506'>
       rqvcuten(i,k,j)=0.<a name='507'>
       rucuten(i,k,j)=0.<a name='508'>
       rvcuten(i,k,j)=0.<a name='509'>
     enddo<a name='510'>
     enddo<a name='511'>
     enddo<a name='512'>
<a name='513'>
     DO j=jts,jtf<a name='514'>
     DO k=kts,ktf<a name='515'>
     DO i=its,itf<a name='516'>
        rthften(i,k,j)=0.<a name='517'>
        rqvften(i,k,j)=0.<a name='518'>
     ENDDO<a name='519'>
     ENDDO<a name='520'>
     ENDDO<a name='521'>
<a name='522'>
     if (p_qc .ge. p_first_scalar) then<a name='523'>
        do j=jts,jtf<a name='524'>
        do k=kts,ktf<a name='525'>
        do i=its,itf<a name='526'>
           rqccuten(i,k,j)=0.<a name='527'>
        enddo<a name='528'>
        enddo<a name='529'>
        enddo<a name='530'>
     endif<a name='531'>
<a name='532'>
     if (p_qi .ge. p_first_scalar) then<a name='533'>
        do j=jts,jtf<a name='534'>
        do k=kts,ktf<a name='535'>
        do i=its,itf<a name='536'>
           rqicuten(i,k,j)=0.<a name='537'>
        enddo<a name='538'>
        enddo<a name='539'>
        enddo<a name='540'>
     endif<a name='541'>
   endif<a name='542'>
<a name='543'>
   end subroutine ntiedtkeinit<a name='544'>
<a name='545'>
<font color=#447700>!-----------------------------------------------------------------<a name='546'></font>
<font color=#447700>!          level 1 subroutine 'tiecnvn'<a name='547'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='548'></font>
<A NAME='TIECNVN'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#TIECNVN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='549'>
      <font color=#993300>subroutine </font><font color=#cc0000>tiecnvn</font>(pu,pv,pt,pqv,pqc,pqi,pqvf,ptf,poz,pzz,pomg, &amp; <A href='../../call_to/TIECNVN.html' TARGET='index'>1</A>,<A href='../../call_from/TIECNVN.html' TARGET='index'>5</A><a name='550'>
     &amp;         pap,paph,evap,hfx,zprecc,lndj,lq,km,km1,dt,dx)<a name='551'>
<font color=#447700>!-----------------------------------------------------------------<a name='552'></font>
<font color=#447700>!  this is the interface between the model and the mass <a name='553'></font>
<font color=#447700>!  flux convection module<a name='554'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='555'></font>
      implicit none<a name='556'>
<font color=#447700>!<a name='557'></font>
      real pu(lq,km),   pv(lq,km),   pt(lq,km),   pqv(lq,km)<a name='558'>
      real poz(lq,km),  pomg(lq,km), evap(lq),    zprecc(lq)<a name='559'>
      real pzz(lq,km1)<a name='560'>
<a name='561'>
      real pum1(lq,km),    pvm1(lq,km),  ztt(lq,km),                &amp;<a name='562'>
     &amp;     ptte(lq,km),    pqte(lq,km),  pvom(lq,km),  pvol(lq,km), &amp;<a name='563'>
     &amp;     pverv(lq,km),   pgeo(lq,km),  pap(lq,km),   paph(lq,km1)<a name='564'>
      real pqhfl(lq),      zqq(lq,km),    &amp;<a name='565'>
     &amp;     prsfc(lq),      pssfc(lq),    pcte(lq,km), &amp;<a name='566'>
     &amp;     phhfl(lq),      hfx(lq),      pgeoh(lq,km1)<a name='567'>
      real ztp1(lq,km),    zqp1(lq,km),  ztu(lq,km),   zqu(lq,km),  &amp;<a name='568'>
     &amp;     zlu(lq,km),     zlude(lq,km), zmfu(lq,km),  zmfd(lq,km), &amp;<a name='569'>
     &amp;     zqsat(lq,km),   pqc(lq,km),   pqi(lq,km),   zrain(lq)<a name='570'>
      real pqvf(lq,km),    ptf(lq,km)<a name='571'>
<a name='572'>
      integer icbot(lq),   ictop(lq),     ktype(lq),   lndj(lq)<a name='573'>
      logical locum(lq)<a name='574'>
<font color=#447700>!<a name='575'></font>
      real ztmst,fliq,fice,ztc,zalf,tt<a name='576'>
      integer i,j,k,lq,km,km1<a name='577'>
      real dt,dx,ztpp1<a name='578'>
      real zew,zqs,zcor<a name='579'>
<font color=#447700>!<a name='580'></font>
      ztmst=dt<a name='581'>
<font color=#447700>!<a name='582'></font>
<font color=#447700>!  masv flux diagnostics.<a name='583'></font>
<font color=#447700>!<a name='584'></font>
      do j=1,lq<a name='585'>
        zrain(j)=0.0<a name='586'>
        locum(j)=.false.<a name='587'>
        prsfc(j)=0.0<a name='588'>
        pssfc(j)=0.0<a name='589'>
        pqhfl(j)=evap(j)<a name='590'>
        phhfl(j)=hfx(j)<a name='591'>
        pgeoh(j,km1)=g*pzz(j,km1)<a name='592'>
      end do<a name='593'>
<font color=#447700>!<a name='594'></font>
<font color=#447700>!     convert model variables for mflux scheme<a name='595'></font>
<font color=#447700>!<a name='596'></font>
      do k=1,km<a name='597'>
        do j=1,lq<a name='598'>
          pcte(j,k)=0.0<a name='599'>
          pvom(j,k)=0.0<a name='600'>
          pvol(j,k)=0.0<a name='601'>
          ztp1(j,k)=pt(j,k)<a name='602'>
          zqp1(j,k)=pqv(j,k)/(1.0+pqv(j,k))<a name='603'>
          pum1(j,k)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PU'>pu</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#TIECNVN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PU_4">(j,k)<a name='604'>
          pvm1(j,k)=pv(j,k)<a name='605'>
          pverv(j,k)=pomg(j,k)<a name='606'>
          pgeo(j,k)=g*poz(j,k)<a name='607'>
          pgeoh(j,k)=g*pzz(j,k)<a name='608'>
          tt=ztp1(j,k)<a name='609'>
          zew  = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEEWM'>foeewm</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#TIECNVN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEEWM_1">(tt)                                      <a name='610'>
          zqs  = zew/pap(j,k)                                      <a name='611'>
          zqs  = min(0.5,zqs)                                         <a name='612'>
          zcor = 1./(1.-vtmpc1*zqs)                                    <a name='613'>
          zqsat(j,k)=zqs*zcor      <a name='614'>
          pqte(j,k)=pqvf(j,k) <a name='615'>
          zqq(j,k) =pqte(j,k)<a name='616'>
          ptte(j,k)=ptf(j,k)<a name='617'>
          ztt(j,k) =ptte(j,k)<a name='618'>
        end do<a name='619'>
      end do<a name='620'>
<font color=#447700>!<a name='621'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='622'></font>
<font color=#447700>!*    2.     call 'cumastrn'(master-routine for cumulus parameterization)<a name='623'></font>
<font color=#447700>!<a name='624'></font>
      call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUMASTRN'>cumastrn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#TIECNVN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUMASTRN_1">        &amp;<a name='625'>
     &amp;    (lq,       km,       km1,      km-1,    ztp1, &amp;<a name='626'>
     &amp;     zqp1,     pum1,     pvm1,     pverv,   zqsat,&amp;<a name='627'>
     &amp;     pqhfl,    ztmst,    pap,      paph,    pgeo, &amp;<a name='628'>
     &amp;     ptte,     pqte,     pvom,     pvol,    prsfc,&amp;<a name='629'>
     &amp;     pssfc,    locum,                             &amp;<a name='630'>
     &amp;     ktype,    icbot,    ictop,    ztu,     zqu,  &amp;<a name='631'>
     &amp;     zlu,      zlude,    zmfu,     zmfd,    zrain,&amp;<a name='632'>
     &amp;     pcte,     phhfl,    lndj,     pgeoh,   dx)<a name='633'>
<font color=#447700>!<a name='634'></font>
<font color=#447700>!     to include the cloud water and cloud ice detrained from convection<a name='635'></font>
<font color=#447700>!<a name='636'></font>
      do k=1,km<a name='637'>
      do j=1,lq<a name='638'>
      if(pcte(j,k).gt.0.) then<a name='639'>
        fliq=<A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEALFA'>foealfa</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#TIECNVN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEALFA_1">(ztp1(j,k))<a name='640'>
        fice=1.0-fliq<a name='641'>
        pqc(j,k)=pqc(j,k)+fliq*pcte(j,k)*ztmst<a name='642'>
        pqi(j,k)=pqi(j,k)+fice*pcte(j,k)*ztmst<a name='643'>
      endif<a name='644'>
      end do<a name='645'>
      end do<a name='646'>
<font color=#447700>!<a name='647'></font>
      do k=1,km<a name='648'>
        do j=1,lq<a name='649'>
          pt(j,k)=  ztp1(j,k)+(ptte(j,k)-ztt(j,k))*ztmst<a name='650'>
          zqp1(j,k)=zqp1(j,k)+(pqte(j,k)-zqq(j,k))*ztmst<a name='651'>
          pqv(j,k)=zqp1(j,k)/(1.0-zqp1(j,k))<a name='652'>
        end do<a name='653'>
      end do<a name='654'>
<a name='655'>
      do j=1,lq<a name='656'>
        zprecc(j)=amax1(0.0,(prsfc(j)+pssfc(j))*ztmst)<a name='657'>
      end do<a name='658'>
<a name='659'>
      if (lmfdudv) then<a name='660'>
        do k=1,km<a name='661'>
          do j=1,lq<a name='662'>
            pu(j,k)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PU'>pu</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#TIECNVN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PU_5">(j,k)+pvom(j,k)*ztmst<a name='663'>
            pv(j,k)=pv(j,k)+pvol(j,k)*ztmst<a name='664'>
          end do<a name='665'>
        end do<a name='666'>
      endif<a name='667'>
<font color=#447700>!<a name='668'></font>
      return<a name='669'>
      end subroutine tiecnvn<a name='670'>
<a name='671'>
<font color=#447700>!#############################################################<a name='672'></font>
<font color=#447700>!<a name='673'></font>
<font color=#447700>!             level 2 subroutines<a name='674'></font>
<font color=#447700>!<a name='675'></font>
<font color=#447700>!#############################################################<a name='676'></font>
<font color=#447700>!***********************************************************<a name='677'></font>
<font color=#447700>!           subroutine cumastrn<a name='678'></font>
<font color=#447700>!***********************************************************<a name='679'></font>
<A NAME='CUMASTRN'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUMASTRN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='680'>
      <font color=#993300>subroutine </font><font color=#cc0000>cumastrn</font>  &amp; <A href='../../call_to/CUMASTRN.html' TARGET='index'>1</A>,<A href='../../call_from/CUMASTRN.html' TARGET='index'>8</A><a name='681'>
     &amp;    (klon,     klev,     klevp1,   klevm1,   pten, &amp;<a name='682'>
     &amp;     pqen,     puen,     pven,     pverv,    pqsen,&amp;<a name='683'>
     &amp;     pqhfl,    ztmst,    pap,      paph,     pgeo, &amp;<a name='684'>
     &amp;     ptte,     pqte,     pvom,     pvol,     prsfc,&amp; <a name='685'>
     &amp;     pssfc,    ldcum,                              &amp;<a name='686'>
     &amp;     ktype,    kcbot,    kctop,    ptu,      pqu,&amp;<a name='687'>
     &amp;     plu,      plude,    pmfu,     pmfd,     prain,&amp;<a name='688'>
     &amp;     pcte,     phhfl,    lndj,     zgeoh,   dx)<a name='689'>
      implicit none<a name='690'>
<font color=#447700>!<a name='691'></font>
<font color=#447700>!***cumastrn*  master routine for cumulus massflux-scheme<a name='692'></font>
<font color=#447700>!     m.tiedtke      e.c.m.w.f.      1986/1987/1989<a name='693'></font>
<font color=#447700>!     modifications<a name='694'></font>
<font color=#447700>!     y.wang         i.p.r.c         2001<a name='695'></font>
<font color=#447700>!     c.zhang                        2012<a name='696'></font>
<font color=#447700>!***purpose<a name='697'></font>
<font color=#447700>!   -------<a name='698'></font>
<font color=#447700>!          this routine computes the physical tendencies of the<a name='699'></font>
<font color=#447700>!     prognostic variables t,q,u and v due to convective processes.<a name='700'></font>
<font color=#447700>!     processes considered are: convective fluxes, formation of<a name='701'></font>
<font color=#447700>!     precipitation, evaporation of falling rain below cloud base,<a name='702'></font>
<font color=#447700>!     saturated cumulus downdrafts.<a name='703'></font>
<font color=#447700>!***method<a name='704'></font>
<font color=#447700>!   ------<a name='705'></font>
<font color=#447700>!     parameterization is done using a massflux-scheme.<a name='706'></font>
<font color=#447700>!        (1) define constants and parameters<a name='707'></font>
<font color=#447700>!        (2) specify values (t,q,qs...) at half levels and<a name='708'></font>
<font color=#447700>!            initialize updraft- and downdraft-values in 'cuinin'<a name='709'></font>
<font color=#447700>!        (3) calculate cloud base in 'cutypen', calculate cloud types in cutypen,<a name='710'></font>
<font color=#447700>!            and specify cloud base massflux<a name='711'></font>
<font color=#447700>!        (4) do cloud ascent in 'cuascn' in absence of downdrafts<a name='712'></font>
<font color=#447700>!        (5) do downdraft calculations:<a name='713'></font>
<font color=#447700>!              (a) determine values at lfs in 'cudlfsn'<a name='714'></font>
<font color=#447700>!              (b) determine moist descent in 'cuddrafn'<a name='715'></font>
<font color=#447700>!              (c) recalculate cloud base massflux considering the<a name='716'></font>
<font color=#447700>!                  effect of cu-downdrafts<a name='717'></font>
<font color=#447700>!        (6) do final adjusments to convective fluxes in 'cuflxn',<a name='718'></font>
<font color=#447700>!            do evaporation in subcloud layer<a name='719'></font>
<font color=#447700>!        (7) calculate increments of t and q in 'cudtdqn'<a name='720'></font>
<font color=#447700>!        (8) calculate increments of u and v in 'cududvn'<a name='721'></font>
<font color=#447700>!***externals.<a name='722'></font>
<font color=#447700>!   ----------<a name='723'></font>
<font color=#447700>!       cuinin:  initializes values at vertical grid used in cu-parametr.<a name='724'></font>
<font color=#447700>!       cutypen: cloud bypes, 1: deep cumulus 2: shallow cumulus<a name='725'></font>
<font color=#447700>!       cuascn:  cloud ascent for entraining plume<a name='726'></font>
<font color=#447700>!       cudlfsn: determines values at lfs for downdrafts<a name='727'></font>
<font color=#447700>!       cuddrafn:does moist descent for cumulus downdrafts<a name='728'></font>
<font color=#447700>!       cuflxn:  final adjustments to convective fluxes (also in pbl)<a name='729'></font>
<font color=#447700>!       cudqdtn: updates tendencies for t and q<a name='730'></font>
<font color=#447700>!       cududvn: updates tendencies for u and v<a name='731'></font>
<font color=#447700>!***switches.<a name='732'></font>
<font color=#447700>!   --------<a name='733'></font>
<font color=#447700>!          lmfmid=.t.   midlevel convection is switched on<a name='734'></font>
<font color=#447700>!          lmfdd=.t.    cumulus downdrafts switched on<a name='735'></font>
<font color=#447700>!          lmfdudv=.t.  cumulus friction switched on<a name='736'></font>
<font color=#447700>!***<a name='737'></font>
<font color=#447700>!     model parameters (defined in subroutine cuparam)<a name='738'></font>
<font color=#447700>!     ------------------------------------------------<a name='739'></font>
<font color=#447700>!     entrdd     entrainment rate for cumulus downdrafts<a name='740'></font>
<font color=#447700>!     cmfcmax    maximum massflux value allowed for<a name='741'></font>
<font color=#447700>!     cmfcmin    minimum massflux value (for safety)<a name='742'></font>
<font color=#447700>!     cmfdeps    fractional massflux for downdrafts at lfs<a name='743'></font>
<font color=#447700>!     cprcon     coefficient for conversion from cloud water to rain<a name='744'></font>
<font color=#447700>!***reference.<a name='745'></font>
<font color=#447700>!   ----------<a name='746'></font>
<font color=#447700>!          paper on massflux scheme (tiedtke,1989)<a name='747'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='748'></font>
      integer  klev,klon,klevp1,klevm1<a name='749'>
      real     pten(klon,klev),        pqen(klon,klev),&amp; <a name='750'>
     &amp;         puen(klon,klev),        pven(klon,klev),&amp;<a name='751'>
     &amp;         ptte(klon,klev),        pqte(klon,klev),&amp;<a name='752'>
     &amp;         pvom(klon,klev),        pvol(klon,klev),&amp;<a name='753'>
     &amp;         pqsen(klon,klev),       pgeo(klon,klev),&amp;<a name='754'>
     &amp;         pap(klon,klev),         paph(klon,klevp1),&amp;<a name='755'>
     &amp;         pverv(klon,klev),       pqhfl(klon),&amp;<a name='756'>
     &amp;         phhfl(klon)            <a name='757'>
      real     ptu(klon,klev),         pqu(klon,klev),&amp;<a name='758'>
     &amp;         plu(klon,klev),         plude(klon,klev),&amp;<a name='759'>
     &amp;         pmfu(klon,klev),        pmfd(klon,klev),&amp;<a name='760'>
     &amp;         prain(klon),&amp;<a name='761'>
     &amp;         prsfc(klon),            pssfc(klon)<a name='762'>
      real     ztenh(klon,klev),       zqenh(klon,klev),&amp;<a name='763'>
     &amp;         zgeoh(klon,klevp1),     zqsenh(klon,klev),&amp;<a name='764'>
     &amp;         ztd(klon,klev),         zqd(klon,klev),&amp;<a name='765'>
     &amp;         zmfus(klon,klev),       zmfds(klon,klev),&amp;<a name='766'>
     &amp;         zmfuq(klon,klev),       zmfdq(klon,klev),&amp;<a name='767'>
     &amp;         zdmfup(klon,klev),      zdmfdp(klon,klev),&amp;<a name='768'>
     &amp;         zmful(klon,klev),       zrfl(klon),&amp;<a name='769'>
     &amp;         zuu(klon,klev),         zvu(klon,klev),&amp;<a name='770'>
     &amp;         zud(klon,klev),         zvd(klon,klev),&amp;<a name='771'>
     &amp;         zlglac(klon,klev)<a name='772'>
      real     pmflxr(klon,klevp1),    pmflxs(klon,klevp1)<a name='773'>
      real     zhcbase(klon),&amp; <a name='774'>
     &amp;         zmfub(klon),            zmfub1(klon),&amp;<a name='775'>
     &amp;         zdhpbl(klon)          <a name='776'>
      real     zsfl(klon),             zdpmel(klon,klev),&amp;<a name='777'>
     &amp;         pcte(klon,klev),        zcape(klon),&amp;<a name='778'>
     &amp;         zcape1(klon),           zcape2(klon),&amp;<a name='779'>
     &amp;         ztauc(klon),            ztaubl(klon),&amp;<a name='780'>
     &amp;         zheat(klon)            <a name='781'>
      real     wup(klon),              zdqcv(klon)            <a name='782'>
      real     wbase(klon),            zmfuub(klon)<a name='783'>
      real     upbl(klon)<a name='784'>
      real     dx<a name='785'>
      real     pmfude_rate(klon,klev), pmfdde_rate(klon,klev)<a name='786'>
      real     zmfuus(klon,klev),      zmfdus(klon,klev)<a name='787'>
      real     zuv2(klon,klev),ztenu(klon,klev),ztenv(klon,klev)<a name='788'>
      real     zmfuvb(klon),zsum12(klon),zsum22(klon)<a name='789'>
      integer  ilab(klon,klev),        idtop(klon),&amp;<a name='790'>
     &amp;         ictop0(klon),           ilwmin(klon)<a name='791'>
      integer  kdpl(klon)<a name='792'>
      integer  kcbot(klon),            kctop(klon),&amp;<a name='793'>
     &amp;         ktype(klon),            lndj(klon)<a name='794'>
      logical  ldcum(klon)<a name='795'>
      logical  loddraf(klon),          llo1,   llo2(klon)<a name='796'>
<a name='797'>
<font color=#447700>!  local varaiables<a name='798'></font>
      real     zcons,zcons2,zqumqe,zdqmin,zdh,zmfmax<a name='799'>
      real     zalfaw,zalv,zqalv,zc5ldcp,zc4les,zhsat,zgam,zzz,zhhat<a name='800'>
      real     zpbmpt,zro,zdz,zdp,zeps,zfac,wspeed<a name='801'>
      integer  jl,jk,ik<a name='802'>
      integer  ikb,ikt,icum,itopm2<a name='803'>
      real     ztmst,ztau,zerate,zderate,zmfa<a name='804'>
      real     zmfs(klon),pmean(klev),zlon<a name='805'>
      real     zduten,zdvten,ztdis,pgf_u,pgf_v<a name='806'>
<font color=#447700>!-------------------------------------------<a name='807'></font>
<font color=#447700>!     1.    specify constants and parameters<a name='808'></font>
<font color=#447700>!-------------------------------------------<a name='809'></font>
      zcons=1./(g*ztmst)<a name='810'>
      zcons2=3./(g*ztmst)<a name='811'>
<a name='812'>
<font color=#447700>!--------------------------------------------------------------<a name='813'></font>
<font color=#447700>!*    2.    initialize values at vertical grid points in 'cuini'<a name='814'></font>
<font color=#447700>!--------------------------------------------------------------<a name='815'></font>
      call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUININ'>cuinin</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUMASTRN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUININ_1"> &amp;<a name='816'>
     &amp;    (klon,     klev,     klevp1,   klevm1,   pten, &amp;<a name='817'>
     &amp;     pqen,     pqsen,    puen,     pven,     pverv,&amp;<a name='818'>
     &amp;     pgeo,     paph,     zgeoh,    ztenh,    zqenh,&amp;<a name='819'>
     &amp;     zqsenh,   ilwmin,   ptu,      pqu,      ztd,  &amp;<a name='820'>
     &amp;     zqd,      zuu,      zvu,      zud,      zvd,  &amp;<a name='821'>
     &amp;     pmfu,     pmfd,     zmfus,    zmfds,    zmfuq,&amp;<a name='822'>
     &amp;     zmfdq,    zdmfup,   zdmfdp,   zdpmel,   plu,  &amp;<a name='823'>
     &amp;     plude,    ilab)<a name='824'>
<a name='825'>
<font color=#447700>!----------------------------------<a name='826'></font>
<font color=#447700>!*    3.0   cloud base calculations<a name='827'></font>
<font color=#447700>!----------------------------------<a name='828'></font>
<font color=#447700>!*         (a) determine cloud base values in 'cutypen',<a name='829'></font>
<font color=#447700>!              and the cumulus type 1 or 2<a name='830'></font>
<font color=#447700>!          -------------------------------------------<a name='831'></font>
       call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUTYPEN'>cutypen</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUMASTRN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUTYPEN_1"> &amp;<a name='832'>
     &amp;     ( klon,     klev,     klevp1,   klevm1,     pqen,&amp;<a name='833'>
     &amp;      ztenh,    zqenh,     zqsenh,    zgeoh,     paph,&amp;<a name='834'>
     &amp;      phhfl,    pqhfl,       pgeo,    pqsen,      pap,&amp;<a name='835'>
     &amp;       pten,     lndj,        ptu,      pqu,     ilab,&amp;<a name='836'>
     &amp;      ldcum,    kcbot,     ictop0,    ktype,    wbase,    plu,   kdpl)<a name='837'>
<a name='838'>
<font color=#447700>!*         (b) assign the first guess mass flux at cloud base<a name='839'></font>
<font color=#447700>!              ------------------------------------------<a name='840'></font>
       do jl=1,klon<a name='841'>
         zdhpbl(jl)=0.0<a name='842'>
         upbl(jl) = 0.0<a name='843'>
         idtop(jl)=0<a name='844'>
       end do<a name='845'>
<a name='846'>
       do jk=2,klev<a name='847'>
       do jl=1,klon<a name='848'>
         if(jk.ge.kcbot(jl) .and. ldcum(jl)) then<a name='849'>
            zdhpbl(jl)=zdhpbl(jl)+(alv*pqte(jl,jk)+cpd*ptte(jl,jk))&amp;<a name='850'>
     &amp;                 *(paph(jl,jk+1)-paph(jl,jk))<a name='851'>
            if(lndj(jl) .eq. 0) then<a name='852'>
              wspeed = sqrt(puen(jl,jk)**2 + pven(jl,jk)**2) <a name='853'>
              upbl(jl) = upbl(jl) + wspeed*(paph(jl,jk+1)-paph(jl,jk))<a name='854'>
            end if<a name='855'>
         end if<a name='856'>
       end do<a name='857'>
       end do<a name='858'>
<a name='859'>
      do jl=1,klon<a name='860'>
        if(ldcum(jl)) then<a name='861'>
           ikb=kcbot(jl)<a name='862'>
           zmfmax = (paph(jl,ikb)-paph(jl,ikb-1))*zcons2<a name='863'>
           if(ktype(jl) == 1) then<a name='864'>
             zmfub(jl)= 0.1*zmfmax<a name='865'>
           else if ( ktype(jl) == 2 ) then<a name='866'>
             zqumqe = pqu(jl,ikb) + plu(jl,ikb) - zqenh(jl,ikb)<a name='867'>
             zdqmin = max(0.01*zqenh(jl,ikb),1.e-10)<a name='868'>
             zdh = cpd*(ptu(jl,ikb)-ztenh(jl,ikb)) + alv*zqumqe<a name='869'>
             zdh = g*max(zdh,1.e5*zdqmin)<a name='870'>
             if ( zdhpbl(jl) &gt; 0. ) then<a name='871'>
               zmfub(jl) = zdhpbl(jl)/zdh<a name='872'>
               zmfub(jl) = min(zmfub(jl),zmfmax)<a name='873'>
             else<a name='874'>
               zmfub(jl) = 0.1*zmfmax<a name='875'>
               ldcum(jl) = .false.<a name='876'>
             end if<a name='877'>
            end if  <a name='878'>
        else<a name='879'>
           zmfub(jl) = 0.<a name='880'>
        end if<a name='881'>
      end do<a name='882'>
<font color=#447700>!------------------------------------------------------<a name='883'></font>
<font color=#447700>!*    4.0   determine cloud ascent for entraining plume<a name='884'></font>
<font color=#447700>!------------------------------------------------------<a name='885'></font>
<font color=#447700>!*    (a) do ascent in 'cuasc'in absence of downdrafts<a name='886'></font>
<font color=#447700>!----------------------------------------------------------<a name='887'></font>
      call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUASCN'>cuascn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUMASTRN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUASCN_1"> &amp;<a name='888'>
     &amp;    (klon,     klev,     klevp1,   klevm1,   ztenh,&amp;<a name='889'>
     &amp;     zqenh,    puen,     pven,     pten,     pqen,&amp;<a name='890'>
     &amp;     pqsen,    pgeo,     zgeoh,    pap,      paph,&amp;<a name='891'>
     &amp;     pqte,     pverv,    ilwmin,   ldcum,    zhcbase,&amp;<a name='892'>
     &amp;     ktype,    ilab,     ptu,      pqu,      plu,&amp;<a name='893'>
     &amp;     zuu,      zvu,      pmfu,     zmfub,&amp;<a name='894'>
     &amp;     zmfus,    zmfuq,    zmful,    plude,    zdmfup,&amp;<a name='895'>
     &amp;     kcbot,    kctop,    ictop0,   icum,     ztmst,&amp;<a name='896'>
     &amp;     zqsenh,   zlglac,   lndj,     wup,      wbase,   kdpl,  pmfude_rate )<a name='897'>
<a name='898'>
<font color=#447700>!*     (b) check cloud depth and change entrainment rate accordingly<a name='899'></font>
<font color=#447700>!          calculate precipitation rate (for downdraft calculation)<a name='900'></font>
<font color=#447700>!------------------------------------------------------------------<a name='901'></font>
      do jl=1,klon<a name='902'>
        if ( ldcum(jl) ) then<a name='903'>
          ikb = kcbot(jl)<a name='904'>
          itopm2 = kctop(jl)<a name='905'>
          zpbmpt = paph(jl,ikb) - paph(jl,itopm2)<a name='906'>
          if ( ktype(jl) == 1 .and. zpbmpt &lt;  zdnoprc ) ktype(jl) = 2<a name='907'>
          if ( ktype(jl) == 2 .and. zpbmpt &gt;= zdnoprc ) ktype(jl) = 1<a name='908'>
          ictop0(jl) = kctop(jl)<a name='909'>
        end if<a name='910'>
        zrfl(jl)=zdmfup(jl,1)<a name='911'>
      end do<a name='912'>
<a name='913'>
      do jk=2,klev<a name='914'>
        do jl=1,klon<a name='915'>
          zrfl(jl)=zrfl(jl)+zdmfup(jl,jk)<a name='916'>
        end do<a name='917'>
      end do<a name='918'>
<a name='919'>
      do jk = 1,klev<a name='920'>
      do jl = 1,klon<a name='921'>
        pmfd(jl,jk) = 0.<a name='922'>
        zmfds(jl,jk) = 0.<a name='923'>
        zmfdq(jl,jk) = 0.<a name='924'>
        zdmfdp(jl,jk) = 0.<a name='925'>
        zdpmel(jl,jk) = 0.<a name='926'>
      end do<a name='927'>
      end do<a name='928'>
<a name='929'>
<font color=#447700>!-----------------------------------------<a name='930'></font>
<font color=#447700>!*    6.0   cumulus downdraft calculations<a name='931'></font>
<font color=#447700>!-----------------------------------------<a name='932'></font>
      if(lmfdd) then<a name='933'>
<font color=#447700>!*      (a) determine lfs in 'cudlfsn'<a name='934'></font>
<font color=#447700>!--------------------------------------<a name='935'></font>
        call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUDLFSN'>cudlfsn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUMASTRN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUDLFSN_1">    &amp;<a name='936'>
     &amp;    (klon,     klev,&amp;<a name='937'>
     &amp;     kcbot,    kctop,    lndj,   ldcum,   &amp;<a name='938'>
     &amp;     ztenh,    zqenh,    puen,     pven,   &amp;<a name='939'>
     &amp;     pten,     pqsen,    pgeo,              &amp;<a name='940'>
     &amp;     zgeoh,    paph,     ptu,      pqu,      plu,   &amp;<a name='941'>
     &amp;     zuu,      zvu,      zmfub,    zrfl,             &amp;<a name='942'>
     &amp;     ztd,      zqd,      zud,      zvd,               &amp;<a name='943'>
     &amp;     pmfd,     zmfds,    zmfdq,    zdmfdp,             &amp;<a name='944'>
     &amp;     idtop,    loddraf)<a name='945'>
<font color=#447700>!*     (b)  determine downdraft t,q and fluxes in 'cuddrafn'<a name='946'></font>
<font color=#447700>!------------------------------------------------------------<a name='947'></font>
        call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUDDRAFN'>cuddrafn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUMASTRN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUDDRAFN_1">                                         &amp;<a name='948'>
     &amp;   ( klon,     klev,     loddraf,                      &amp;<a name='949'>
     &amp;     ztenh,    zqenh,    puen,     pven,                 &amp;<a name='950'>
     &amp;     pgeo,     zgeoh,    paph,     zrfl,                  &amp;<a name='951'>
     &amp;     ztd,      zqd,      zud,      zvd,      pmfu,         &amp;<a name='952'>
     &amp;     pmfd,     zmfds,    zmfdq,    zdmfdp,   pmfdde_rate      )<a name='953'>
<font color=#447700>!-----------------------------------------------------------<a name='954'></font>
      end if<a name='955'>
<font color=#447700>!<a name='956'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='957'></font>
<font color=#447700>!* 6.0          closure and clean work<a name='958'></font>
<font color=#447700>! ------<a name='959'></font>
<font color=#447700>!-- 6.1 recalculate cloud base massflux from a cape closure<a name='960'></font>
<font color=#447700>!       for deep convection (ktype=1) <a name='961'></font>
<font color=#447700>!<a name='962'></font>
      do jl=1,klon<a name='963'>
      if(ldcum(jl) .and. ktype(jl) .eq. 1) then<a name='964'>
        ikb = kcbot(jl)<a name='965'>
        ikt = kctop(jl)<a name='966'>
        zheat(jl)=0.0<a name='967'>
        zcape(jl)=0.0<a name='968'>
        zcape1(jl)=0.0<a name='969'>
        zcape2(jl)=0.0<a name='970'>
        zmfub1(jl)=zmfub(jl)<a name='971'>
    <a name='972'>
        ztauc(jl)  = (zgeoh(jl,ikt)-zgeoh(jl,ikb)) / &amp;<a name='973'>
                   ((2.+ min(15.0,wup(jl)))*g)<a name='974'>
        if(lndj(jl) .eq. 0) then <a name='975'>
          upbl(jl) = 2.+ upbl(jl)/(paph(jl,klev+1)-paph(jl,ikb))<a name='976'>
          ztaubl(jl) = (zgeoh(jl,ikb)-zgeoh(jl,klev+1))/(g*upbl(jl))<a name='977'>
          ztaubl(jl) = min(300., ztaubl(jl))<a name='978'>
        else<a name='979'>
          ztaubl(jl) = ztauc(jl)<a name='980'>
        end if<a name='981'>
      end if    <a name='982'>
      end do<a name='983'>
<font color=#447700>!<a name='984'></font>
      do jk = 1 , klev<a name='985'>
      do jl = 1 , klon<a name='986'>
        llo1 = ldcum(jl) .and. ktype(jl) .eq. 1<a name='987'>
        if ( llo1 .and. jk &lt;= kcbot(jl) .and. jk &gt; kctop(jl) ) then<a name='988'>
          ikb = kcbot(jl)<a name='989'>
          zdz = pgeo(jl,jk-1)-pgeo(jl,jk)<a name='990'>
          zdp = pap(jl,jk)-pap(jl,jk-1)<a name='991'>
          zheat(jl) = zheat(jl) + ((pten(jl,jk-1)-pten(jl,jk)+zdz*rcpd) / &amp;<a name='992'>
                      ztenh(jl,jk)+vtmpc1*(pqen(jl,jk-1)-pqen(jl,jk))) * &amp;<a name='993'>
                      (g*(pmfu(jl,jk)+pmfd(jl,jk)))<a name='994'>
          zcape1(jl) = zcape1(jl) + ((ptu(jl,jk)-ztenh(jl,jk))/ztenh(jl,jk) + &amp;<a name='995'>
                      vtmpc1*(pqu(jl,jk)-zqenh(jl,jk))-plu(jl,jk))*zdp<a name='996'>
        end if<a name='997'>
<a name='998'>
        if ( llo1 .and. jk &gt;= kcbot(jl) ) then<a name='999'>
        if((paph(jl,klev+1)-paph(jl,kdpl(jl)))&lt;50.e2) then<a name='1000'>
          zdp = paph(jl,jk+1)-paph(jl,jk)<a name='1001'>
          zcape2(jl) = zcape2(jl) + ztaubl(jl)* &amp;<a name='1002'>
                     ((1.+vtmpc1*pqen(jl,jk))*ptte(jl,jk)+vtmpc1*pten(jl,jk)*pqte(jl,jk))*zdp <a name='1003'>
        end if<a name='1004'>
        end if<a name='1005'>
      end do<a name='1006'>
      end do<a name='1007'>
<a name='1008'>
      do jl=1,klon<a name='1009'>
       if(ldcum(jl).and.ktype(jl).eq.1) then<a name='1010'>
           ikb = kcbot(jl)<a name='1011'>
           ikt = kctop(jl)<a name='1012'>
           ztau = ztauc(jl) * (1.+1.33e-5*dx)<a name='1013'>
           ztau = max(ztmst,ztau)<a name='1014'>
           ztau = max(360.,ztau)<a name='1015'>
           ztau = min(10800.,ztau)<a name='1016'>
           if(nonequil) then<a name='1017'>
             zcape2(jl)= max(0.,zcape2(jl))<a name='1018'>
             zcape(jl) = max(0.,min(zcape1(jl)-zcape2(jl),5000.))<a name='1019'>
           else<a name='1020'>
             zcape(jl) = max(0.,min(zcape1(jl),5000.))<a name='1021'>
           end if<a name='1022'>
           zheat(jl) = max(1.e-4,zheat(jl))<a name='1023'>
           zmfub1(jl) = (zcape(jl)*zmfub(jl))/(zheat(jl)*ztau)<a name='1024'>
           zmfub1(jl) = max(zmfub1(jl),0.001)<a name='1025'>
           zmfmax=(paph(jl,ikb)-paph(jl,ikb-1))*zcons2<a name='1026'>
           zmfub1(jl)=min(zmfub1(jl),zmfmax)<a name='1027'>
       end if<a name='1028'>
      end do<a name='1029'>
<font color=#447700>!<a name='1030'></font>
<font color=#447700>!*  6.2   recalculate convective fluxes due to effect of<a name='1031'></font>
<font color=#447700>!         downdrafts on boundary layer moist static energy budget (ktype=2)<a name='1032'></font>
<font color=#447700>!--------------------------------------------------------<a name='1033'></font>
       do jl=1,klon<a name='1034'>
         if(ldcum(jl) .and. ktype(jl) .eq. 2) then<a name='1035'>
           ikb=kcbot(jl)<a name='1036'>
           if(pmfd(jl,ikb).lt.0.0 .and. loddraf(jl)) then<a name='1037'>
              zeps=-pmfd(jl,ikb)/max(zmfub(jl),cmfcmin)<a name='1038'>
           else<a name='1039'>
              zeps=0.<a name='1040'>
           endif<a name='1041'>
           zqumqe=pqu(jl,ikb)+plu(jl,ikb)-  &amp;<a name='1042'>
     &amp;            zeps*zqd(jl,ikb)-(1.-zeps)*zqenh(jl,ikb)<a name='1043'>
           zdqmin=max(0.01*zqenh(jl,ikb),cmfcmin)<a name='1044'>
           zmfmax=(paph(jl,ikb)-paph(jl,ikb-1))*zcons2<a name='1045'>
<font color=#447700>!  using moist static engergy closure instead of moisture closure<a name='1046'></font>
           zdh=cpd*(ptu(jl,ikb)-zeps*ztd(jl,ikb)- &amp;<a name='1047'>
     &amp;       (1.-zeps)*ztenh(jl,ikb))+alv*zqumqe<a name='1048'>
           zdh=g*max(zdh,1.e5*zdqmin)<a name='1049'>
           if(zdhpbl(jl).gt.0.)then<a name='1050'>
             zmfub1(jl)=zdhpbl(jl)/zdh<a name='1051'>
           else<a name='1052'>
             zmfub1(jl) = zmfub(jl)<a name='1053'>
           end if<a name='1054'>
           zmfub1(jl) = min(zmfub1(jl),zmfmax)<a name='1055'>
         end if<a name='1056'>
<a name='1057'>
<font color=#447700>!*  6.3   mid-level convection - nothing special<a name='1058'></font>
<font color=#447700>!---------------------------------------------------------<a name='1059'></font>
         if(ldcum(jl) .and. ktype(jl) .eq. 3 ) then<a name='1060'>
            zmfub1(jl) = zmfub(jl)<a name='1061'>
         end if<a name='1062'>
<a name='1063'>
       end do<a name='1064'>
<a name='1065'>
<font color=#447700>!*  6.4   scaling the downdraft mass flux<a name='1066'></font>
<font color=#447700>!---------------------------------------------------------<a name='1067'></font>
       do jk=1,klev<a name='1068'>
       do jl=1,klon<a name='1069'>
        if( ldcum(jl) ) then<a name='1070'>
           zfac=zmfub1(jl)/max(zmfub(jl),cmfcmin)<a name='1071'>
           pmfd(jl,jk)=pmfd(jl,jk)*zfac<a name='1072'>
           zmfds(jl,jk)=zmfds(jl,jk)*zfac<a name='1073'>
           zmfdq(jl,jk)=zmfdq(jl,jk)*zfac<a name='1074'>
           zdmfdp(jl,jk)=zdmfdp(jl,jk)*zfac<a name='1075'>
           pmfdde_rate(jl,jk) = pmfdde_rate(jl,jk)*zfac<a name='1076'>
        end if<a name='1077'>
       end do<a name='1078'>
       end do<a name='1079'>
<a name='1080'>
<font color=#447700>!*  6.5   scaling the updraft mass flux<a name='1081'></font>
<font color=#447700>! --------------------------------------------------------<a name='1082'></font>
    do jl = 1,klon<a name='1083'>
      if ( ldcum(jl) ) zmfs(jl) = zmfub1(jl)/max(cmfcmin,zmfub(jl))<a name='1084'>
    end do<a name='1085'>
    do jk = 2 , klev<a name='1086'>
      do jl = 1,klon<a name='1087'>
        if ( ldcum(jl) .and. jk &gt;= kctop(jl)-1 ) then<a name='1088'>
          ikb = kcbot(jl)<a name='1089'>
          if ( jk&gt;ikb ) then<a name='1090'>
            zdz = ((paph(jl,klev+1)-paph(jl,jk))/(paph(jl,klev+1)-paph(jl,ikb)))<a name='1091'>
            pmfu(jl,jk) = pmfu(jl,ikb)*zdz<a name='1092'>
          end if<a name='1093'>
          zmfmax = (paph(jl,jk)-paph(jl,jk-1))*zcons2<a name='1094'>
          if ( pmfu(jl,jk)*zmfs(jl) &gt; zmfmax ) then<a name='1095'>
            zmfs(jl) = min(zmfs(jl),zmfmax/pmfu(jl,jk))<a name='1096'>
          end if<a name='1097'>
        end if<a name='1098'>
      end do<a name='1099'>
    end do<a name='1100'>
    do jk = 2 , klev<a name='1101'>
      do jl = 1,klon<a name='1102'>
        if ( ldcum(jl) .and. jk &lt;= kcbot(jl) .and. jk &gt;= kctop(jl)-1 ) then<a name='1103'>
          pmfu(jl,jk) = pmfu(jl,jk)*zmfs(jl)<a name='1104'>
          zmfus(jl,jk) = zmfus(jl,jk)*zmfs(jl)<a name='1105'>
          zmfuq(jl,jk) = zmfuq(jl,jk)*zmfs(jl)<a name='1106'>
          zmful(jl,jk) = zmful(jl,jk)*zmfs(jl)<a name='1107'>
          zdmfup(jl,jk) = zdmfup(jl,jk)*zmfs(jl)<a name='1108'>
          plude(jl,jk) = plude(jl,jk)*zmfs(jl)<a name='1109'>
          pmfude_rate(jl,jk) = pmfude_rate(jl,jk)*zmfs(jl)<a name='1110'>
        end if<a name='1111'>
      end do<a name='1112'>
    end do<a name='1113'>
<a name='1114'>
<font color=#447700>!*    6.6  if ktype = 2, kcbot=kctop is not allowed<a name='1115'></font>
<font color=#447700>! ---------------------------------------------------<a name='1116'></font>
    do jl = 1,klon<a name='1117'>
      if ( ktype(jl) == 2 .and. &amp;<a name='1118'>
           kcbot(jl) == kctop(jl) .and. kcbot(jl) &gt;= klev-1 ) then<a name='1119'>
        ldcum(jl) = .false.<a name='1120'>
        ktype(jl) = 0<a name='1121'>
      end if<a name='1122'>
    end do<a name='1123'>
<a name='1124'>
    if ( .not. lmfscv .or. .not. lmfpen ) then<a name='1125'>
      do jl = 1,klon<a name='1126'>
        llo2(jl) = .false.<a name='1127'>
        if ( (.not. lmfscv .and. ktype(jl) == 2) .or. &amp;<a name='1128'>
             (.not. lmfpen .and. ktype(jl) == 1) ) then<a name='1129'>
          llo2(jl) = .true.<a name='1130'>
          ldcum(jl) = .false.<a name='1131'>
        end if<a name='1132'>
      end do<a name='1133'>
    end if<a name='1134'>
<a name='1135'>
<font color=#447700>!*   6.7  set downdraft mass fluxes to zero above cloud top<a name='1136'></font>
<font color=#447700>!----------------------------------------------------<a name='1137'></font>
    do jl = 1,klon<a name='1138'>
      if ( loddraf(jl) .and. idtop(jl) &lt;= kctop(jl) ) then<a name='1139'>
        idtop(jl) = kctop(jl) + 1<a name='1140'>
      end if<a name='1141'>
    end do<a name='1142'>
    do jk = 2 , klev<a name='1143'>
      do jl = 1,klon<a name='1144'>
        if ( loddraf(jl) ) then<a name='1145'>
          if ( jk &lt; idtop(jl) ) then<a name='1146'>
            pmfd(jl,jk) = 0.<a name='1147'>
            zmfds(jl,jk) = 0.<a name='1148'>
            zmfdq(jl,jk) = 0.<a name='1149'>
            pmfdde_rate(jl,jk) = 0.<a name='1150'>
            zdmfdp(jl,jk) = 0.<a name='1151'>
          else if ( jk == idtop(jl) ) then<a name='1152'>
            pmfdde_rate(jl,jk) = 0.<a name='1153'>
          end if<a name='1154'>
        end if<a name='1155'>
      end do<a name='1156'>
    end do<a name='1157'>
<font color=#447700>!----------------------------------------------------------<a name='1158'></font>
<font color=#447700>!*    7.0      determine final convective fluxes in 'cuflx'<a name='1159'></font>
<font color=#447700>!----------------------------------------------------------<a name='1160'></font>
       call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUFLXN'>cuflxn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUMASTRN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUFLXN_1">                                        &amp;                  <a name='1161'>
     &amp;  (  klon,     klev,     ztmst                       &amp;                                       <a name='1162'>
     &amp;  ,  pten,     pqen,     pqsen,    ztenh,   zqenh     &amp;                  <a name='1163'>
     &amp;  ,  paph,     pap,      zgeoh,    lndj,    ldcum      &amp;                 <a name='1164'>
     &amp;  ,  kcbot,    kctop,    idtop,    itopm2               &amp;                 <a name='1165'>
     &amp;  ,  ktype,    loddraf                                   &amp;                 <a name='1166'>
     &amp;  ,  pmfu,     pmfd,     zmfus,    zmfds                  &amp;               <a name='1167'>
     &amp;  ,  zmfuq,    zmfdq,    zmful,    plude                   &amp;              <a name='1168'>
     &amp;  ,  zdmfup,   zdmfdp,   zdpmel,   zlglac                   &amp;             <a name='1169'>
     &amp;  ,  prain,    pmfdde_rate, pmflxr, pmflxs )     <a name='1170'>
<a name='1171'>
<font color=#447700>! some adjustments needed<a name='1172'></font>
    do jl=1,klon<a name='1173'>
      zmfs(jl) = 1.<a name='1174'>
      zmfuub(jl)=0.<a name='1175'>
    end do<a name='1176'>
    do jk = 2 , klev<a name='1177'>
      do jl = 1,klon<a name='1178'>
        if ( loddraf(jl) .and. jk &gt;= idtop(jl)-1 ) then<a name='1179'>
          zmfmax = pmfu(jl,jk)*0.98<a name='1180'>
          if ( pmfd(jl,jk)+zmfmax+1.e-15 &lt; 0. ) then<a name='1181'>
            zmfs(jl) = min(zmfs(jl),-zmfmax/pmfd(jl,jk))<a name='1182'>
          end if<a name='1183'>
        end if<a name='1184'>
      end do<a name='1185'>
    end do<a name='1186'>
<a name='1187'>
    do jk = 2 , klev<a name='1188'>
      do jl = 1 , klon<a name='1189'>
        if ( zmfs(jl) &lt; 1. .and. jk &gt;= idtop(jl)-1 ) then<a name='1190'>
          pmfd(jl,jk) = pmfd(jl,jk)*zmfs(jl)<a name='1191'>
          zmfds(jl,jk) = zmfds(jl,jk)*zmfs(jl)<a name='1192'>
          zmfdq(jl,jk) = zmfdq(jl,jk)*zmfs(jl)<a name='1193'>
          pmfdde_rate(jl,jk) = pmfdde_rate(jl,jk)*zmfs(jl)<a name='1194'>
          zmfuub(jl) = zmfuub(jl) - (1.-zmfs(jl))*zdmfdp(jl,jk)<a name='1195'>
          pmflxr(jl,jk+1) = pmflxr(jl,jk+1) + zmfuub(jl)<a name='1196'>
          zdmfdp(jl,jk) = zdmfdp(jl,jk)*zmfs(jl)<a name='1197'>
        end if<a name='1198'>
      end do<a name='1199'>
    end do<a name='1200'>
<a name='1201'>
    do jk = 2 , klev - 1<a name='1202'>
      do jl = 1, klon<a name='1203'>
        if ( loddraf(jl) .and. jk &gt;= idtop(jl)-1 ) then<a name='1204'>
          zerate = -pmfd(jl,jk) + pmfd(jl,jk-1) + pmfdde_rate(jl,jk)<a name='1205'>
          if ( zerate &lt; 0. ) then<a name='1206'>
            pmfdde_rate(jl,jk) = pmfdde_rate(jl,jk) - zerate<a name='1207'>
          end if<a name='1208'>
        end if<a name='1209'>
        if ( ldcum(jl) .and. jk &gt;= kctop(jl)-1 ) then<a name='1210'>
          zerate = pmfu(jl,jk) - pmfu(jl,jk+1) + pmfude_rate(jl,jk)<a name='1211'>
          if ( zerate &lt; 0. ) then<a name='1212'>
            pmfude_rate(jl,jk) = pmfude_rate(jl,jk) - zerate<a name='1213'>
          end if<a name='1214'>
          zdmfup(jl,jk) = pmflxr(jl,jk+1) + pmflxs(jl,jk+1) - &amp;<a name='1215'>
                          pmflxr(jl,jk) - pmflxs(jl,jk)<a name='1216'>
          zdmfdp(jl,jk) = 0.<a name='1217'>
        end if<a name='1218'>
      end do<a name='1219'>
    end do<a name='1220'>
<a name='1221'>
<font color=#447700>! avoid negative humidities at ddraught top<a name='1222'></font>
    do jl = 1,klon<a name='1223'>
      if ( loddraf(jl) ) then<a name='1224'>
        jk = idtop(jl)<a name='1225'>
        ik = min(jk+1,klev)<a name='1226'>
        if ( zmfdq(jl,jk) &lt; 0.3*zmfdq(jl,ik) ) then<a name='1227'>
            zmfdq(jl,jk) = 0.3*zmfdq(jl,ik)<a name='1228'>
        end if<a name='1229'>
      end if<a name='1230'>
    end do<a name='1231'>
<a name='1232'>
<font color=#447700>! avoid negative humidities near cloud top because gradient of precip flux<a name='1233'></font>
<font color=#447700>! and detrainment / liquid water flux are too large<a name='1234'></font>
    do jk = 2 , klev<a name='1235'>
      do jl = 1, klon<a name='1236'>
        if ( ldcum(jl) .and. jk &gt;= kctop(jl)-1 .and. jk &lt; kcbot(jl) ) then<a name='1237'>
          zdz = ztmst*g/(paph(jl,jk+1)-paph(jl,jk))<a name='1238'>
          zmfa = zmfuq(jl,jk+1) + zmfdq(jl,jk+1) - &amp;<a name='1239'>
                 zmfuq(jl,jk) - zmfdq(jl,jk) + &amp;<a name='1240'>
                 zmful(jl,jk+1) - zmful(jl,jk) + zdmfup(jl,jk)<a name='1241'>
          zmfa = (zmfa-plude(jl,jk))*zdz<a name='1242'>
          if ( pqen(jl,jk)+zmfa &lt; 0. ) then<a name='1243'>
            plude(jl,jk) = plude(jl,jk) + 2.*(pqen(jl,jk)+zmfa)/zdz<a name='1244'>
          end if<a name='1245'>
          if ( plude(jl,jk) &lt; 0. ) plude(jl,jk) = 0.<a name='1246'>
        end if<a name='1247'>
        if ( .not. ldcum(jl) ) pmfude_rate(jl,jk) = 0.<a name='1248'>
        if ( abs(pmfd(jl,jk-1)) &lt; 1.0e-20 ) pmfdde_rate(jl,jk) = 0.<a name='1249'>
      end do<a name='1250'>
    end do<a name='1251'>
<a name='1252'>
    do jl=1,klon<a name='1253'>
      prsfc(jl) = pmflxr(jl,klev+1)<a name='1254'>
      pssfc(jl) = pmflxs(jl,klev+1)<a name='1255'>
    end do<a name='1256'>
<a name='1257'>
<font color=#447700>!----------------------------------------------------------------<a name='1258'></font>
<font color=#447700>!*    8.0      update tendencies for t and q in subroutine cudtdq<a name='1259'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1260'></font>
      call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUDTDQN'>cudtdqn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUMASTRN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUDTDQN_1">(klon,klev,itopm2,kctop,idtop,ldcum,loddraf, &amp;<a name='1261'>
                 ztmst,paph,zgeoh,pgeo,pten,ztenh,pqen,zqenh,pqsen,     &amp;<a name='1262'>
                 zlglac,plude,pmfu,pmfd,zmfus,zmfds,zmfuq,zmfdq,zmful,   &amp;<a name='1263'>
                 zdmfup,zdmfdp,zdpmel,ptte,pqte,pcte)<a name='1264'>
<font color=#447700>!----------------------------------------------------------------<a name='1265'></font>
<font color=#447700>!*    9.0      update tendencies for u and u in subroutine cududv<a name='1266'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1267'></font>
      if(lmfdudv) then<a name='1268'>
      do jk = klev-1 , 2 , -1<a name='1269'>
        ik = jk + 1<a name='1270'>
        do jl = 1,klon<a name='1271'>
          if ( ldcum(jl) ) then<a name='1272'>
            if ( jk == kcbot(jl) .and. ktype(jl) &lt; 3 ) then<a name='1273'>
              ikb = kdpl(jl)<a name='1274'>
              zuu(jl,jk) = puen(jl,ikb-1)<a name='1275'>
              zvu(jl,jk) = pven(jl,ikb-1)<a name='1276'>
            else if ( jk == kcbot(jl) .and. ktype(jl) == 3 ) then<a name='1277'>
              zuu(jl,jk) = puen(jl,jk-1)<a name='1278'>
              zvu(jl,jk) = pven(jl,jk-1)<a name='1279'>
            end if<a name='1280'>
            if ( jk &lt; kcbot(jl) .and. jk &gt;= kctop(jl) ) then<a name='1281'>
            if(momtrans .eq. 1)then<a name='1282'>
              zfac = 0.<a name='1283'>
              if ( ktype(jl) == 1 .or. ktype(jl) == 3 ) zfac = 2.<a name='1284'>
              if ( ktype(jl) == 1 .and. jk &lt;= kctop(jl)+2 ) zfac = 3.<a name='1285'>
              zerate = pmfu(jl,jk) - pmfu(jl,ik) + &amp;<a name='1286'>
                (1.+zfac)*pmfude_rate(jl,jk)<a name='1287'>
              zderate = (1.+zfac)*pmfude_rate(jl,jk)<a name='1288'>
              zmfa = 1./max(cmfcmin,pmfu(jl,jk))<a name='1289'>
              zuu(jl,jk) = (zuu(jl,ik)*pmfu(jl,ik) + &amp;<a name='1290'>
                zerate*puen(jl,jk)-zderate*zuu(jl,ik))*zmfa<a name='1291'>
              zvu(jl,jk) = (zvu(jl,ik)*pmfu(jl,ik) + &amp;<a name='1292'>
                zerate*pven(jl,jk)-zderate*zvu(jl,ik))*zmfa<a name='1293'>
            else<a name='1294'>
              pgf_u = -pgcoef*0.5*(pmfu(jl,ik)*(puen(jl,ik)-puen(jl,jk))+&amp;<a name='1295'>
                                   pmfu(jl,jk)*(puen(jl,jk)-puen(jl,jk-1)))<a name='1296'>
              pgf_v = -pgcoef*0.5*(pmfu(jl,ik)*(pven(jl,ik)-pven(jl,jk))+&amp;<a name='1297'>
                                   pmfu(jl,jk)*(pven(jl,jk)-pven(jl,jk-1)))<a name='1298'>
              zerate = pmfu(jl,jk) - pmfu(jl,ik) + pmfude_rate(jl,jk)<a name='1299'>
              zderate = pmfude_rate(jl,jk)<a name='1300'>
              zmfa = 1./max(cmfcmin,pmfu(jl,jk))<a name='1301'>
              zuu(jl,jk) = (zuu(jl,ik)*pmfu(jl,ik) + &amp;<a name='1302'>
                zerate*puen(jl,jk)-zderate*zuu(jl,ik)+pgf_u)*zmfa<a name='1303'>
              zvu(jl,jk) = (zvu(jl,ik)*pmfu(jl,ik) + &amp;<a name='1304'>
                zerate*pven(jl,jk)-zderate*zvu(jl,ik)+pgf_v)*zmfa<a name='1305'>
            end if<a name='1306'>
            end if<a name='1307'>
          end if<a name='1308'>
        end do<a name='1309'>
      end do<a name='1310'>
<a name='1311'>
      if(lmfdd) then<a name='1312'>
      do jk = 3 , klev<a name='1313'>
        ik = jk - 1<a name='1314'>
        do jl = 1,klon<a name='1315'>
          if ( ldcum(jl) ) then<a name='1316'>
            if ( jk == idtop(jl) ) then<a name='1317'>
              zud(jl,jk) = 0.5*(zuu(jl,jk)+puen(jl,ik))<a name='1318'>
              zvd(jl,jk) = 0.5*(zvu(jl,jk)+pven(jl,ik))<a name='1319'>
            else if ( jk &gt; idtop(jl) ) then<a name='1320'>
              zerate = -pmfd(jl,jk) + pmfd(jl,ik) + pmfdde_rate(jl,jk)<a name='1321'>
              zmfa = 1./min(-cmfcmin,pmfd(jl,jk))<a name='1322'>
              zud(jl,jk) = (zud(jl,ik)*pmfd(jl,ik) - &amp;<a name='1323'>
                zerate*puen(jl,ik)+pmfdde_rate(jl,jk)*zud(jl,ik))*zmfa<a name='1324'>
              zvd(jl,jk) = (zvd(jl,ik)*pmfd(jl,ik) - &amp;<a name='1325'>
                zerate*pven(jl,ik)+pmfdde_rate(jl,jk)*zvd(jl,ik))*zmfa<a name='1326'>
            end if<a name='1327'>
          end if<a name='1328'>
        end do<a name='1329'>
      end do<a name='1330'>
      end if<a name='1331'>
<font color=#447700>!   --------------------------------------------------<a name='1332'></font>
<font color=#447700>!   rescale massfluxes for stability in Momentum<a name='1333'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='1334'></font>
      zmfs(:) = 1.<a name='1335'>
      do jk = 2 , klev<a name='1336'>
        do jl = 1, klon<a name='1337'>
          if ( ldcum(jl) .and. jk &gt;= kctop(jl)-1 ) then<a name='1338'>
            zmfmax = (paph(jl,jk)-paph(jl,jk-1))*zcons<a name='1339'>
            if ( pmfu(jl,jk) &gt; zmfmax .and. jk &gt;= kctop(jl) ) then<a name='1340'>
              zmfs(jl) = min(zmfs(jl),zmfmax/pmfu(jl,jk))<a name='1341'>
            end if<a name='1342'>
          end if<a name='1343'>
        end do<a name='1344'>
      end do<a name='1345'>
      do jk = 1 , klev<a name='1346'>
        do jl = 1, klon<a name='1347'>
          zmfuus(jl,jk) = pmfu(jl,jk)<a name='1348'>
          zmfdus(jl,jk) = pmfd(jl,jk)<a name='1349'>
          if ( ldcum(jl) .and. jk &gt;= kctop(jl)-1 ) then<a name='1350'>
            zmfuus(jl,jk) = pmfu(jl,jk)*zmfs(jl)<a name='1351'>
            zmfdus(jl,jk) = pmfd(jl,jk)*zmfs(jl)<a name='1352'>
          end if<a name='1353'>
        end do<a name='1354'>
      end do<a name='1355'>
<font color=#447700>!*  9.1          update u and v in subroutine cududvn<a name='1356'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='1357'></font>
     do jk = 1 , klev<a name='1358'>
        do jl = 1, klon<a name='1359'>
          ztenu(jl,jk) = pvom(jl,jk)<a name='1360'>
          ztenv(jl,jk) = pvol(jl,jk)<a name='1361'>
        end do<a name='1362'>
      end do<a name='1363'>
<a name='1364'>
      call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUDUDVN'>cududvn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUMASTRN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUDUDVN_1">(klon,klev,itopm2,ktype,kcbot,kctop, &amp;<a name='1365'>
                  ldcum,ztmst,paph,puen,pven,zmfuus,zmfdus,zuu,  &amp;<a name='1366'>
                  zud,zvu,zvd,pvom,pvol)<a name='1367'>
<a name='1368'>
<font color=#447700>!  calculate KE dissipation<a name='1369'></font>
      do jl = 1, klon<a name='1370'>
        zsum12(jl) = 0.<a name='1371'>
        zsum22(jl) = 0.<a name='1372'>
      end do<a name='1373'>
        do jk = 1 , klev<a name='1374'>
          do jl = 1, klon<a name='1375'>
            zuv2(jl,jk) = 0.<a name='1376'>
            if ( ldcum(jl) .and. jk &gt;= kctop(jl)-1 ) then<a name='1377'>
              zdz = (paph(jl,jk+1)-paph(jl,jk))<a name='1378'>
              zduten = pvom(jl,jk) - ztenu(jl,jk)<a name='1379'>
              zdvten = pvol(jl,jk) - ztenv(jl,jk)<a name='1380'>
              zuv2(jl,jk) = sqrt(zduten**2+zdvten**2)<a name='1381'>
              zsum22(jl) = zsum22(jl) + zuv2(jl,jk)*zdz<a name='1382'>
              zsum12(jl) = zsum12(jl) - &amp;<a name='1383'>
                (puen(jl,jk)*zduten+pven(jl,jk)*zdvten)*zdz<a name='1384'>
            end if<a name='1385'>
          end do<a name='1386'>
        end do<a name='1387'>
        do jk = 1 , klev<a name='1388'>
          do jl = 1, klon<a name='1389'>
            if ( ldcum(jl) .and. jk&gt;=kctop(jl)-1 ) then<a name='1390'>
              ztdis = rcpd*zsum12(jl)*zuv2(jl,jk)/max(1.e-15,zsum22(jl))<a name='1391'>
              ptte(jl,jk) = ptte(jl,jk) + ztdis<a name='1392'>
            end if<a name='1393'>
          end do<a name='1394'>
        end do<a name='1395'>
<a name='1396'>
      end if<a name='1397'>
<a name='1398'>
<font color=#447700>!----------------------------------------------------------------------<a name='1399'></font>
<font color=#447700>!*   10.           IN CASE THAT EITHER DEEP OR SHALLOW IS SWITCHED OFF<a name='1400'></font>
<font color=#447700>! NEED TO SET SOME VARIABLES A POSTERIORI TO ZERO<a name='1401'></font>
<font color=#447700>! ---------------------------------------------------<a name='1402'></font>
    if ( .not. lmfscv .or. .not. lmfpen ) then<a name='1403'>
      do jk = 2 , klev<a name='1404'>
        do jl = 1, klon<a name='1405'>
          if ( llo2(jl) .and. jk &gt;= kctop(jl)-1 ) then<a name='1406'>
            ptu(jl,jk) = pten(jl,jk)<a name='1407'>
            pqu(jl,jk) = pqen(jl,jk)<a name='1408'>
            plu(jl,jk) = 0.<a name='1409'>
            pmfude_rate(jl,jk) = 0.<a name='1410'>
            pmfdde_rate(jl,jk) = 0.<a name='1411'>
          end if<a name='1412'>
        end do<a name='1413'>
      end do<a name='1414'>
      do jl = 1, klon<a name='1415'>
        if ( llo2(jl) ) then<a name='1416'>
          kctop(jl) = klev - 1<a name='1417'>
          kcbot(jl) = klev - 1<a name='1418'>
        end if<a name='1419'>
      end do<a name='1420'>
    end if<a name='1421'>
<a name='1422'>
      return<a name='1423'>
      end subroutine cumastrn<a name='1424'>
<a name='1425'>
<font color=#447700>!**********************************************<a name='1426'></font>
<font color=#447700>!    level 3  subroutine cuinin<a name='1427'></font>
<font color=#447700>!**********************************************<a name='1428'></font>
<font color=#447700>!<a name='1429'></font>
<A NAME='CUININ'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUININ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1430'>
      <font color=#993300>subroutine </font><font color=#cc0000>cuinin</font> &amp; <A href='../../call_to/CUININ.html' TARGET='index'>1</A>,<A href='../../call_from/CUININ.html' TARGET='index'>1</A><a name='1431'>
     &amp;    (klon,     klev,     klevp1,   klevm1,   pten,&amp;<a name='1432'>
     &amp;     pqen,     pqsen,    puen,     pven,     pverv,&amp;<a name='1433'>
     &amp;     pgeo,     paph,     pgeoh,    ptenh,    pqenh,&amp;<a name='1434'>
     &amp;     pqsenh,   klwmin,   ptu,      pqu,      ptd,&amp;<a name='1435'>
     &amp;     pqd,      puu,      pvu,      pud,      pvd,&amp;<a name='1436'>
     &amp;     pmfu,     pmfd,     pmfus,    pmfds,    pmfuq,&amp;<a name='1437'>
     &amp;     pmfdq,    pdmfup,   pdmfdp,   pdpmel,   plu,&amp;<a name='1438'>
     &amp;     plude,    klab)<a name='1439'>
      implicit none<a name='1440'>
<font color=#447700>!      m.tiedtke         e.c.m.w.f.     12/89<a name='1441'></font>
<font color=#447700>!***purpose<a name='1442'></font>
<font color=#447700>!   -------<a name='1443'></font>
<font color=#447700>!          this routine interpolates large-scale fields of t,q etc.<a name='1444'></font>
<font color=#447700>!          to half levels (i.e. grid for massflux scheme),<a name='1445'></font>
<font color=#447700>!          and initializes values for updrafts and downdrafts<a name='1446'></font>
<font color=#447700>!***interface<a name='1447'></font>
<font color=#447700>!   ---------<a name='1448'></font>
<font color=#447700>!          this routine is called from *cumastr*.<a name='1449'></font>
<font color=#447700>!***method.<a name='1450'></font>
<font color=#447700>!  --------<a name='1451'></font>
<font color=#447700>!          for extrapolation to half levels see tiedtke(1989)<a name='1452'></font>
<font color=#447700>!***externals<a name='1453'></font>
<font color=#447700>!   ---------<a name='1454'></font>
<font color=#447700>!          *cuadjtq* to specify qs at half levels<a name='1455'></font>
<font color=#447700>! ----------------------------------------------------------------<a name='1456'></font>
      integer  klon,klev,klevp1,klevm1<a name='1457'>
      real     pten(klon,klev),        pqen(klon,klev),&amp;<a name='1458'>
     &amp;         puen(klon,klev),        pven(klon,klev),&amp;<a name='1459'>
     &amp;         pqsen(klon,klev),       pverv(klon,klev),&amp;<a name='1460'>
     &amp;         pgeo(klon,klev),        pgeoh(klon,klevp1),&amp;<a name='1461'>
     &amp;         paph(klon,klevp1),      ptenh(klon,klev),&amp;<a name='1462'>
     &amp;         pqenh(klon,klev),       pqsenh(klon,klev)<a name='1463'>
      real     ptu(klon,klev),         pqu(klon,klev),&amp;<a name='1464'>
     &amp;         ptd(klon,klev),         pqd(klon,klev),&amp;<a name='1465'>
     &amp;         puu(klon,klev),         pud(klon,klev),&amp;<a name='1466'>
     &amp;         pvu(klon,klev),         pvd(klon,klev),&amp;<a name='1467'>
     &amp;         pmfu(klon,klev),        pmfd(klon,klev),&amp;<a name='1468'>
     &amp;         pmfus(klon,klev),       pmfds(klon,klev),&amp;<a name='1469'>
     &amp;         pmfuq(klon,klev),       pmfdq(klon,klev),&amp;<a name='1470'>
     &amp;         pdmfup(klon,klev),      pdmfdp(klon,klev),&amp;<a name='1471'>
     &amp;         plu(klon,klev),         plude(klon,klev)<a name='1472'>
      real     zwmax(klon),            zph(klon), &amp;<a name='1473'>
     &amp;         pdpmel(klon,klev)<a name='1474'>
      integer  klab(klon,klev),        klwmin(klon)<a name='1475'>
      logical  loflag(klon)<a name='1476'>
<font color=#447700>!  local variables<a name='1477'></font>
      integer  jl,jk<a name='1478'>
      integer  icall,ik<a name='1479'>
      real     zzs<a name='1480'>
<font color=#447700>!------------------------------------------------------------<a name='1481'></font>
<font color=#447700>!*    1.       specify large scale parameters at half levels<a name='1482'></font>
<font color=#447700>!*             adjust temperature fields if staticly unstable<a name='1483'></font>
<font color=#447700>!*             find level of maximum vertical velocity<a name='1484'></font>
<font color=#447700>! -----------------------------------------------------------<a name='1485'></font>
      do jk=2,klev<a name='1486'>
      do jl=1,klon<a name='1487'>
        ptenh(jl,jk)=(max(cpd*pten(jl,jk-1)+pgeo(jl,jk-1), &amp;<a name='1488'>
     &amp;             cpd*pten(jl,jk)+pgeo(jl,jk))-pgeoh(jl,jk))*rcpd<a name='1489'>
        pqenh(jl,jk) = pqen(jl,jk-1)<a name='1490'>
        pqsenh(jl,jk)= pqsen(jl,jk-1)<a name='1491'>
        zph(jl)=paph(jl,jk)<a name='1492'>
        loflag(jl)=.true.<a name='1493'>
      end do<a name='1494'>
<a name='1495'>
      if ( jk &gt;= klev-1 .or. jk &lt; 2 ) cycle<a name='1496'>
      ik=jk<a name='1497'>
      icall=0<a name='1498'>
      call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN'>cuadjtqn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUININ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUADJTQN_1">(klon,klev,ik,zph,ptenh,pqsenh,loflag,icall)<a name='1499'>
      do jl=1,klon<a name='1500'>
        pqenh(jl,jk)=min(pqen(jl,jk-1),pqsen(jl,jk-1)) &amp;<a name='1501'>
     &amp;            +(pqsenh(jl,jk)-pqsen(jl,jk-1))<a name='1502'>
        pqenh(jl,jk)=max(pqenh(jl,jk),0.)<a name='1503'>
      end do<a name='1504'>
      end do<a name='1505'>
<a name='1506'>
      do jl=1,klon<a name='1507'>
        ptenh(jl,klev)=(cpd*pten(jl,klev)+pgeo(jl,klev)- &amp;<a name='1508'>
     &amp;                pgeoh(jl,klev))*rcpd<a name='1509'>
        pqenh(jl,klev)=pqen(jl,klev)<a name='1510'>
        ptenh(jl,1)=pten(jl,1)<a name='1511'>
        pqenh(jl,1)=pqen(jl,1)<a name='1512'>
        klwmin(jl)=klev<a name='1513'>
        zwmax(jl)=0.<a name='1514'>
      end do<a name='1515'>
<a name='1516'>
      do jk=klevm1,2,-1<a name='1517'>
      do jl=1,klon<a name='1518'>
        zzs=max(cpd*ptenh(jl,jk)+pgeoh(jl,jk), &amp;<a name='1519'>
     &amp;        cpd*ptenh(jl,jk+1)+pgeoh(jl,jk+1))<a name='1520'>
        ptenh(jl,jk)=(zzs-pgeoh(jl,jk))*rcpd<a name='1521'>
      end do<a name='1522'>
      end do<a name='1523'>
<a name='1524'>
      do jk=klev,3,-1<a name='1525'>
      do jl=1,klon<a name='1526'>
        if(pverv(jl,jk).lt.zwmax(jl)) then<a name='1527'>
           zwmax(jl)=pverv(jl,jk)<a name='1528'>
           klwmin(jl)=jk<a name='1529'>
        end if<a name='1530'>
      end do<a name='1531'>
      end do<a name='1532'>
<font color=#447700>!-----------------------------------------------------------<a name='1533'></font>
<font color=#447700>!*    2.0      initialize values for updrafts and downdrafts<a name='1534'></font>
<font color=#447700>!-----------------------------------------------------------<a name='1535'></font>
      do jk=1,klev<a name='1536'>
      ik=jk-1<a name='1537'>
      if(jk.eq.1) ik=1<a name='1538'>
      do jl=1,klon<a name='1539'>
      ptu(jl,jk)=ptenh(jl,jk)<a name='1540'>
      ptd(jl,jk)=ptenh(jl,jk)<a name='1541'>
      pqu(jl,jk)=pqenh(jl,jk)<a name='1542'>
      pqd(jl,jk)=pqenh(jl,jk)<a name='1543'>
      plu(jl,jk)=0.<a name='1544'>
      puu(jl,jk)=puen(jl,ik)<a name='1545'>
      pud(jl,jk)=puen(jl,ik)<a name='1546'>
      pvu(jl,jk)=pven(jl,ik)<a name='1547'>
      pvd(jl,jk)=pven(jl,ik)<a name='1548'>
      klab(jl,jk)=0<a name='1549'>
      end do<a name='1550'>
      end do<a name='1551'>
      return<a name='1552'>
      end subroutine cuinin<a name='1553'>
<a name='1554'>
<font color=#447700>!---------------------------------------------------------<a name='1555'></font>
<font color=#447700>!  level 3 souroutines<a name='1556'></font>
<font color=#447700>!--------------------------------------------------------<a name='1557'></font>
<A NAME='CUTYPEN'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUTYPEN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1558'>
      <font color=#993300>subroutine </font><font color=#cc0000>cutypen</font> &amp;  <A href='../../call_to/CUTYPEN.html' TARGET='index'>1</A>,<A href='../../call_from/CUTYPEN.html' TARGET='index'>8</A><a name='1559'>
     &amp;   (  klon,    klev,     klevp1,   klevm1,     pqen,&amp;<a name='1560'>
     &amp;     ptenh,   pqenh,     pqsenh,    pgeoh,     paph,&amp; <a name='1561'>
     &amp;       hfx,     qfx,       pgeo,    pqsen,      pap,&amp;<a name='1562'>
     &amp;      pten,    lndj,       cutu,     cuqu,    culab,&amp;<a name='1563'>
     &amp;     ldcum,   cubot,      cutop,    ktype,    wbase,    culu,   kdpl  )<a name='1564'>
<font color=#447700>!      zhang &amp; wang      iprc           2011-2013<a name='1565'></font>
<font color=#447700>!***purpose.<a name='1566'></font>
<font color=#447700>!   --------<a name='1567'></font>
<font color=#447700>!          to produce first guess updraught for cu-parameterizations<a name='1568'></font>
<font color=#447700>!          calculates condensation level, and sets updraught base variables and<a name='1569'></font>
<font color=#447700>!          first guess cloud type<a name='1570'></font>
<font color=#447700>!***interface<a name='1571'></font>
<font color=#447700>!   ---------<a name='1572'></font>
<font color=#447700>!          this routine is called from *cumastr*.<a name='1573'></font>
<font color=#447700>!          input are environm. values of t,q,p,phi at half levels.<a name='1574'></font>
<font color=#447700>!          it returns cloud types as follows;<a name='1575'></font>
<font color=#447700>!                 ktype=1 for deep cumulus<a name='1576'></font>
<font color=#447700>!                 ktype=2 for shallow cumulus<a name='1577'></font>
<font color=#447700>!***method.<a name='1578'></font>
<font color=#447700>!  --------<a name='1579'></font>
<font color=#447700>!          based on a simplified updraught equation<a name='1580'></font>
<font color=#447700>!            partial(hup)/partial(z)=eta(h - hup)<a name='1581'></font>
<font color=#447700>!            eta is the entrainment rate for test parcel<a name='1582'></font>
<font color=#447700>!            h stands for dry static energy or the total water specific humidity<a name='1583'></font>
<font color=#447700>!            references: christian jakob, 2003: a new subcloud model for<a name='1584'></font>
<font color=#447700>!            mass-flux convection schemes<a name='1585'></font>
<font color=#447700>!                        influence on triggering, updraft properties, and model<a name='1586'></font>
<font color=#447700>!                        climate, mon.wea.rev.<a name='1587'></font>
<font color=#447700>!                        131, 2765-2778<a name='1588'></font>
<font color=#447700>!            and<a name='1589'></font>
<font color=#447700>!                        ifs documentation - cy36r1,cy38r1 <a name='1590'></font>
<font color=#447700>!***input variables:<a name='1591'></font>
<font color=#447700>!       ptenh [ztenh] - environment temperature on half levels. (cuini)<a name='1592'></font>
<font color=#447700>!       pqenh [zqenh] - env. specific humidity on half levels. (cuini)<a name='1593'></font>
<font color=#447700>!       pgeoh [zgeoh] - geopotential on half levels, (mssflx)<a name='1594'></font>
<font color=#447700>!       paph - pressure of half levels. (mssflx)<a name='1595'></font>
<font color=#447700>!       rho  - density of the lowest model level<a name='1596'></font>
<font color=#447700>!       qfx  - net upward moisture flux at the surface (kg/m^2/s)<a name='1597'></font>
<font color=#447700>!       hfx  - net upward heat flux at the surface (w/m^2)<a name='1598'></font>
<font color=#447700>!***variables output by cutype:<a name='1599'></font>
<font color=#447700>!       ktype - convection type - 1: penetrative  (cumastr)<a name='1600'></font>
<font color=#447700>!                                 2: stratocumulus (cumastr)<a name='1601'></font>
<font color=#447700>!                                 3: mid-level  (cuasc)<a name='1602'></font>
<font color=#447700>!       information for updraft parcel (ptu,pqu,plu,kcbot,klab,kdpl...)<a name='1603'></font>
<font color=#447700>! ----------------------------------------------------------------<a name='1604'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='1605'></font>
      implicit none<a name='1606'>
<font color=#447700>!-------------------------------------------------------------------<a name='1607'></font>
      integer  klon, klev, klevp1, klevm1<a name='1608'>
      real     ptenh(klon,klev),       pqenh(klon,klev),&amp; <a name='1609'>
     &amp;         pqsen(klon,klev),       pqsenh(klon,klev),&amp;<a name='1610'>
     &amp;         pgeoh(klon,klevp1),     paph(klon,klevp1),&amp;<a name='1611'>
     &amp;         pap(klon,klev),         pqen(klon,klev)<a name='1612'>
      real     pten(klon,klev)<a name='1613'>
      real     ptu(klon,klev),pqu(klon,klev),plu(klon,klev)<a name='1614'>
      real     pgeo(klon,klev)<a name='1615'>
      integer  klab(klon,klev)<a name='1616'>
      integer  kctop(klon),kcbot(klon)<a name='1617'>
<a name='1618'>
      real     qfx(klon),hfx(klon)<a name='1619'>
      real     zph(klon)<a name='1620'>
      integer  lndj(klon)<a name='1621'>
      logical  loflag(klon), deepflag(klon), resetflag(klon)<a name='1622'>
<a name='1623'>
<font color=#447700>! output variables<a name='1624'></font>
      real     cutu(klon,klev), cuqu(klon,klev), culu(klon,klev)<a name='1625'>
      integer  culab(klon,klev)<a name='1626'>
      real     wbase(klon)<a name='1627'>
      integer  ktype(klon),cubot(klon),cutop(klon),kdpl(klon)<a name='1628'>
      logical  ldcum(klon)<a name='1629'>
<a name='1630'>
<font color=#447700>! local variables<a name='1631'></font>
      real     zqold(klon)<a name='1632'>
      real     rho, part1, part2, root, conw, deltt, deltq<a name='1633'>
      real     eta(klon),dz(klon),coef(klon)<a name='1634'>
      real     dhen(klon,klev), dh(klon,klev)<a name='1635'>
      real     plude(klon,klev)<a name='1636'>
      real     kup(klon,klev)<a name='1637'>
      real     vptu(klon,klev),vten(klon,klev)<a name='1638'>
      real     zbuo(klon,klev),abuoy(klon,klev)<a name='1639'>
  <a name='1640'>
      real     zz,zdken,zdq<a name='1641'>
      real     fscale,crirh1,pp<a name='1642'>
      real     atop1,atop2,abot<a name='1643'>
      real     tmix,zmix,qmix,pmix<a name='1644'>
      real     zlglac,dp<a name='1645'>
      integer  nk,is,ikb,ikt<a name='1646'>
<a name='1647'>
      real     zqsu,zcor,zdp,zesdp,zalfaw,zfacw,zfaci,zfac,zdsdp,zdqsdt,zdtdp<a name='1648'>
      real     zpdifftop, zpdiffbot<a name='1649'>
      integer  zcbase(klon), itoppacel(klon)<a name='1650'>
      integer  jl,jk,ik,icall,levels<a name='1651'>
      logical  needreset, lldcum(klon)<a name='1652'>
<font color=#447700>!--------------------------------------------------------------<a name='1653'></font>
      do jl=1,klon<a name='1654'>
        kcbot(jl)=klev<a name='1655'>
        kctop(jl)=klev<a name='1656'>
        kdpl(jl) =klev<a name='1657'>
        ktype(jl)=0<a name='1658'>
        wbase(jl)=0.<a name='1659'>
        ldcum(jl)=.false.<a name='1660'>
      end do<a name='1661'>
<a name='1662'>
<font color=#447700>!-----------------------------------------------------------<a name='1663'></font>
<font color=#447700>! let's do test,and check the shallow convection first<a name='1664'></font>
<font color=#447700>! the first level is klev<a name='1665'></font>
<font color=#447700>! define deltat and deltaq<a name='1666'></font>
<font color=#447700>!-----------------------------------------------------------<a name='1667'></font>
      do jk=1,klev<a name='1668'>
      do jl=1,klon<a name='1669'>
          plu(jl,jk)=culu(jl,jk)  <font color=#447700>! parcel liquid water<a name='1670'></font>
          ptu(jl,jk)=cutu(jl,jk)  <font color=#447700>! parcel temperature<a name='1671'></font>
          pqu(jl,jk)=cuqu(jl,jk)  <font color=#447700>! parcel specific humidity<a name='1672'></font>
          klab(jl,jk)=culab(jl,jk)<a name='1673'>
           dh(jl,jk)=0.0  <font color=#447700>! parcel dry static energy<a name='1674'></font>
         dhen(jl,jk)=0.0  <font color=#447700>! environment dry static energy<a name='1675'></font>
          kup(jl,jk)=0.0  <font color=#447700>! updraught kinetic energy for parcel<a name='1676'></font>
         vptu(jl,jk)=0.0  <font color=#447700>! parcel virtual temperature considering water-loading<a name='1677'></font>
         vten(jl,jk)=0.0  <font color=#447700>! environment virtual temperature<a name='1678'></font>
         zbuo(jl,jk)=0.0  <font color=#447700>! parcel buoyancy<a name='1679'></font>
         abuoy(jl,jk)=0.0<a name='1680'>
      end do<a name='1681'>
      end do<a name='1682'>
<a name='1683'>
      do jl=1,klon<a name='1684'>
         zqold(jl) = 0.<a name='1685'>
         lldcum(jl) = .false.<a name='1686'>
         loflag(jl) = .true.<a name='1687'>
      end do<a name='1688'>
<a name='1689'>
<font color=#447700>! check the levels from lowest level to second top level<a name='1690'></font>
      do jk=klevm1,2,-1<a name='1691'>
<a name='1692'>
<font color=#447700>! define the variables at the first level      <a name='1693'></font>
      if(jk .eq. klevm1) then<a name='1694'>
      do jl=1,klon<a name='1695'>
        rho=pap(jl,klev)/ &amp;<a name='1696'>
     &amp;         (rd*(pten(jl,klev)*(1.+vtmpc1*pqen(jl,klev))))<a name='1697'>
        part1 = 1.5*0.4*pgeo(jl,klev)/ &amp;<a name='1698'>
     &amp;              (rho*pten(jl,klev))<a name='1699'>
        part2 = -hfx(jl)*rcpd-vtmpc1*pten(jl,klev)*qfx(jl)<a name='1700'>
        root  = 0.001-part1*part2<a name='1701'>
        if(part2 .lt. 0.) then<a name='1702'>
           conw  = 1.2*(root)**t13<a name='1703'>
           deltt = max(1.5*hfx(jl)/(rho*cpd*conw),0.)<a name='1704'>
           deltq = max(1.5*qfx(jl)/(rho*conw),0.)<a name='1705'>
           kup(jl,klev) = 0.5*(conw**2)<a name='1706'>
           pqu(jl,klev)= pqenh(jl,klev) + deltq<a name='1707'>
          dhen(jl,klev)= pgeoh(jl,klev) + ptenh(jl,klev)*cpd<a name='1708'>
           dh(jl,klev) = dhen(jl,klev)  + deltt*cpd<a name='1709'>
          ptu(jl,klev) = (dh(jl,klev)-pgeoh(jl,klev))*rcpd <a name='1710'>
          vptu(jl,klev)=ptu(jl,klev)*(1.+vtmpc1*pqu(jl,klev))<a name='1711'>
          vten(jl,klev)=ptenh(jl,klev)*(1.+vtmpc1*pqenh(jl,klev))<a name='1712'>
          zbuo(jl,klev)=(vptu(jl,klev)-vten(jl,klev))/vten(jl,klev)<a name='1713'>
          klab(jl,klev) = 1<a name='1714'>
        else<a name='1715'>
          loflag(jl) = .false.<a name='1716'>
        end if<a name='1717'>
      end do<a name='1718'>
      end if<a name='1719'>
 <a name='1720'>
      is=0<a name='1721'>
      do jl=1,klon<a name='1722'>
         if(loflag(jl))then<a name='1723'>
            is=is+1<a name='1724'>
         endif<a name='1725'>
      enddo<a name='1726'>
      if(is.eq.0) exit<a name='1727'>
<a name='1728'>
<font color=#447700>! the next levels, we use the variables at the first level as initial values<a name='1729'></font>
      do jl=1,klon<a name='1730'>
      if(loflag(jl)) then<a name='1731'>
        eta(jl) = 0.8/(pgeo(jl,jk)*zrg)+2.e-4<a name='1732'>
        dz(jl)  = (pgeoh(jl,jk)-pgeoh(jl,jk+1))*zrg<a name='1733'>
        coef(jl)= 0.5*eta(jl)*dz(jl)<a name='1734'>
        dhen(jl,jk) = pgeoh(jl,jk) + cpd*ptenh(jl,jk)<a name='1735'>
        dh(jl,jk) = (coef(jl)*(dhen(jl,jk+1)+dhen(jl,jk))&amp;<a name='1736'>
     &amp;              +(1.-coef(jl))*dh(jl,jk+1))/(1.+coef(jl))<a name='1737'>
        pqu(jl,jk) =(coef(jl)*(pqenh(jl,jk+1)+pqenh(jl,jk))&amp;<a name='1738'>
     &amp;              +(1.-coef(jl))*pqu(jl,jk+1))/(1.+coef(jl))<a name='1739'>
        ptu(jl,jk) = (dh(jl,jk)-pgeoh(jl,jk))*rcpd<a name='1740'>
        zqold(jl) = pqu(jl,jk)<a name='1741'>
        zph(jl)=paph(jl,jk)<a name='1742'>
      end if<a name='1743'>
      end do<a name='1744'>
<font color=#447700>! check if the parcel is saturated<a name='1745'></font>
      ik=jk<a name='1746'>
      icall=1<a name='1747'>
      call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN'>cuadjtqn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUTYPEN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUADJTQN_2">(klon,klev,ik,zph,ptu,pqu,loflag,icall)<a name='1748'>
      do jl=1,klon<a name='1749'>
        if( loflag(jl) ) then<a name='1750'>
          zdq = max((zqold(jl) - pqu(jl,jk)),0.)<a name='1751'>
          plu(jl,jk) = plu(jl,jk+1) + zdq<a name='1752'>
          zlglac=zdq*((1.-foealfa(ptu(jl,jk))) - &amp;<a name='1753'>
                      (1.-foealfa(ptu(jl,jk+1))))<a name='1754'>
          plu(jl,jk) = min(plu(jl,jk),5.e-3)<a name='1755'>
          dh(jl,jk) =  pgeoh(jl,jk) + cpd*(ptu(jl,jk)+ralfdcp*zlglac)<a name='1756'>
<font color=#447700>! compute the updraft speed<a name='1757'></font>
          vptu(jl,jk) = ptu(jl,jk)*(1.+vtmpc1*pqu(jl,jk)-plu(jl,jk))+&amp;<a name='1758'>
                        ralfdcp*zlglac<a name='1759'>
          vten(jl,jk) = ptenh(jl,jk)*(1.+vtmpc1*pqenh(jl,jk))<a name='1760'>
          zbuo(jl,jk) = (vptu(jl,jk) - vten(jl,jk))/vten(jl,jk)<a name='1761'>
          abuoy(jl,jk)=(zbuo(jl,jk)+zbuo(jl,jk+1))*0.5*g<a name='1762'>
          atop1 = 1.0 - 2.*coef(jl)<a name='1763'>
          atop2 = 2.0*dz(jl)*abuoy(jl,jk)<a name='1764'>
          abot =  1.0 + 2.*coef(jl)<a name='1765'>
          kup(jl,jk)  = (atop1*kup(jl,jk+1) + atop2) / abot<a name='1766'>
<a name='1767'>
<font color=#447700>! let's find the exact cloud base<a name='1768'></font>
         if ( plu(jl,jk) &gt; 0. .and. klab(jl,jk+1) == 1 ) then<a name='1769'>
              ik = jk + 1<a name='1770'>
              zqsu = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEEWM'>foeewm</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUTYPEN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEEWM_2">(ptu(jl,ik))/paph(jl,ik)<a name='1771'>
              zqsu = min(0.5,zqsu)<a name='1772'>
              zcor = 1./(1.-vtmpc1*zqsu)<a name='1773'>
              zqsu = zqsu*zcor<a name='1774'>
              zdq = min(0.,pqu(jl,ik)-zqsu)<a name='1775'>
              zalfaw = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEALFA'>foealfa</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUTYPEN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEALFA_2">(ptu(jl,ik))<a name='1776'>
              zfacw = c5les/((ptu(jl,ik)-c4les)**2)<a name='1777'>
              zfaci = c5ies/((ptu(jl,ik)-c4ies)**2)<a name='1778'>
              zfac = zalfaw*zfacw + (1.-zalfaw)*zfaci<a name='1779'>
              zesdp = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEEWM'>foeewm</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUTYPEN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEEWM_3">(ptu(jl,ik))/paph(jl,ik)<a name='1780'>
              zcor = 1./(1.-vtmpc1*zesdp)<a name='1781'>
              zdqsdt = zfac*zcor*zqsu<a name='1782'>
              zdtdp = rd*ptu(jl,ik)/(cpd*paph(jl,ik))<a name='1783'>
              zdp = zdq/(zdqsdt*zdtdp)<a name='1784'>
              zcbase(jl) = paph(jl,ik) + zdp<a name='1785'>
<font color=#447700>! chose nearest half level as cloud base (jk or jk+1)<a name='1786'></font>
              zpdifftop = zcbase(jl) - paph(jl,jk)<a name='1787'>
              zpdiffbot = paph(jl,jk+1) - zcbase(jl)<a name='1788'>
              if ( zpdifftop &gt; zpdiffbot .and. kup(jl,jk+1) &gt; 0. ) then<a name='1789'>
                ikb = min(klev-1,jk+1)<a name='1790'>
                klab(jl,ikb) = 2<a name='1791'>
                klab(jl,jk) = 2<a name='1792'>
                kcbot(jl) = ikb<a name='1793'>
                plu(jl,jk+1) = 1.0e-8<a name='1794'>
              else if ( zpdifftop &lt;= zpdiffbot .and.kup(jl,jk) &gt; 0. ) then<a name='1795'>
                klab(jl,jk) = 2<a name='1796'>
                kcbot(jl) = jk<a name='1797'>
              end if<a name='1798'>
          end if<a name='1799'>
<a name='1800'>
          if(kup(jl,jk) .lt. 0.)then<a name='1801'>
            loflag(jl) = .false.<a name='1802'>
            if(plu(jl,jk+1) .gt. 0.) then<a name='1803'>
              kctop(jl) = jk<a name='1804'>
              lldcum(jl) = .true.<a name='1805'>
            else<a name='1806'>
              lldcum(jl) = .false.<a name='1807'>
            end if<a name='1808'>
          else <a name='1809'>
            if(plu(jl,jk) .gt. 0.)then<a name='1810'>
              klab(jl,jk)=2<a name='1811'>
            else<a name='1812'>
              klab(jl,jk)=1<a name='1813'>
            end if<a name='1814'>
          end if<a name='1815'>
        end if<a name='1816'>
      end do<a name='1817'>
<a name='1818'>
      end do <font color=#447700>! end all the levels<a name='1819'></font>
<a name='1820'>
      do jl=1,klon<a name='1821'>
        ikb = kcbot(jl)<a name='1822'>
        ikt = kctop(jl)<a name='1823'>
        if(paph(jl,ikb) - paph(jl,ikt) &gt; zdnoprc) lldcum(jl) = .false.<a name='1824'>
        if(lldcum(jl)) then<a name='1825'>
            ktype(jl) = 2<a name='1826'>
            ldcum(jl) = .true.<a name='1827'>
            wbase(jl) = sqrt(max(2.*kup(jl,ikb),0.))<a name='1828'>
            cubot(jl) = ikb<a name='1829'>
            cutop(jl) = ikt<a name='1830'>
            kdpl(jl)  = klev<a name='1831'>
        else<a name='1832'>
            cutop(jl) = -1<a name='1833'>
            cubot(jl) = -1<a name='1834'>
            kdpl(jl)  = klev - 1<a name='1835'>
            ldcum(jl) = .false.<a name='1836'>
            wbase(jl) = 0.<a name='1837'>
        end if<a name='1838'>
      end do<a name='1839'>
<a name='1840'>
      do jk=klev,1,-1<a name='1841'>
       do jl=1,klon<a name='1842'>
           ikt = kctop(jl)<a name='1843'>
           if(jk .ge. ikt)then<a name='1844'>
             culab(jl,jk) = klab(jl,jk)<a name='1845'>
             cutu(jl,jk)  = ptu(jl,jk)<a name='1846'>
             cuqu(jl,jk)  = pqu(jl,jk)<a name='1847'>
             culu(jl,jk)  = plu(jl,jk)<a name='1848'>
           end if<a name='1849'>
       end do<a name='1850'>
      end do<a name='1851'>
      <a name='1852'>
<font color=#447700>!-----------------------------------------------------------<a name='1853'></font>
<font color=#447700>! next, let's check the deep convection<a name='1854'></font>
<font color=#447700>! the first level is klevm1-1<a name='1855'></font>
<font color=#447700>! define deltat and deltaq<a name='1856'></font>
<font color=#447700>!----------------------------------------------------------<a name='1857'></font>
<font color=#447700>! we check the parcel starting level by level<a name='1858'></font>
<font color=#447700>! assume the mix-layer is 60hPa<a name='1859'></font>
      deltt = 0.2<a name='1860'>
      deltq = 1.0e-4<a name='1861'>
      do jl=1,klon<a name='1862'>
        deepflag(jl) = .false.<a name='1863'>
      end do<a name='1864'>
<a name='1865'>
      do jk=klev,1,-1<a name='1866'>
       do jl=1,klon<a name='1867'>
         if((paph(jl,klev+1)-paph(jl,jk)) .lt. 350.e2) itoppacel(jl) = jk<a name='1868'>
       end do<a name='1869'>
      end do<a name='1870'>
<a name='1871'>
      do levels=klevm1-1,klev/2+1,-1 <font color=#447700>! loop starts<a name='1872'></font>
        do jk=1,klev<a name='1873'>
          do jl=1,klon<a name='1874'>
             plu(jl,jk)=0.0  <font color=#447700>! parcel liquid water<a name='1875'></font>
             ptu(jl,jk)=0.0  <font color=#447700>! parcel temperature<a name='1876'></font>
             pqu(jl,jk)=0.0  <font color=#447700>! parcel specific humidity<a name='1877'></font>
             dh(jl,jk)=0.0   <font color=#447700>! parcel dry static energy<a name='1878'></font>
             dhen(jl,jk)=0.0  <font color=#447700>! environment dry static energy<a name='1879'></font>
             kup(jl,jk)=0.0   <font color=#447700>! updraught kinetic energy for parcel<a name='1880'></font>
             vptu(jl,jk)=0.0  <font color=#447700>! parcel virtual temperature consideringwater-loading<a name='1881'></font>
             vten(jl,jk)=0.0  <font color=#447700>! environment virtual temperature<a name='1882'></font>
             abuoy(jl,jk)=0.0<a name='1883'>
             zbuo(jl,jk)=0.0<a name='1884'>
             klab(jl,jk)=0<a name='1885'>
          end do<a name='1886'>
        end do<a name='1887'>
<a name='1888'>
        do jl=1,klon<a name='1889'>
           kcbot(jl)    =  levels<a name='1890'>
           kctop(jl)    =  levels<a name='1891'>
           zqold(jl)    = 0.<a name='1892'>
           lldcum(jl)   = .false.<a name='1893'>
           resetflag(jl)= .false.<a name='1894'>
           loflag(jl)   = (.not. deepflag(jl)) .and. (levels.ge.itoppacel(jl))<a name='1895'>
        end do<a name='1896'>
<a name='1897'>
<font color=#447700>! start the inner loop to search the deep convection points<a name='1898'></font>
      do jk=levels,2,-1<a name='1899'>
        is=0<a name='1900'>
        do jl=1,klon<a name='1901'>
         if(loflag(jl))then<a name='1902'>
            is=is+1<a name='1903'>
         endif<a name='1904'>
        enddo<a name='1905'>
        if(is.eq.0) exit<a name='1906'>
<a name='1907'>
<font color=#447700>! define the variables at the departure level <a name='1908'></font>
        if(jk .eq. levels) then<a name='1909'>
          do jl=1,klon<a name='1910'>
          if(loflag(jl)) then<a name='1911'>
            if((paph(jl,klev+1)-paph(jl,jk)) &lt; 60.e2) then<a name='1912'>
              tmix=0.<a name='1913'>
              qmix=0.<a name='1914'>
              zmix=0.<a name='1915'>
              pmix=0.<a name='1916'>
              do nk=jk+2,jk,-1<a name='1917'>
              if(pmix &lt; 50.e2) then<a name='1918'>
                dp = paph(jl,nk) - paph(jl,nk-1)<a name='1919'>
                tmix=tmix+dp*ptenh(jl,nk)<a name='1920'>
                qmix=qmix+dp*pqenh(jl,nk)<a name='1921'>
                zmix=zmix+dp*pgeoh(jl,nk)<a name='1922'>
                pmix=pmix+dp<a name='1923'>
              end if<a name='1924'>
              end do<a name='1925'>
              tmix=tmix/pmix<a name='1926'>
              qmix=qmix/pmix<a name='1927'>
              zmix=zmix/pmix<a name='1928'>
            else<a name='1929'>
              tmix=ptenh(jl,jk+1)<a name='1930'>
              qmix=pqenh(jl,jk+1)<a name='1931'>
              zmix=pgeoh(jl,jk+1)<a name='1932'>
            end if<a name='1933'>
<a name='1934'>
            pqu(jl,jk+1) = qmix + deltq<a name='1935'>
            dhen(jl,jk+1)= zmix + tmix*cpd<a name='1936'>
            dh(jl,jk+1)  = dhen(jl,jk+1) + deltt*cpd<a name='1937'>
            ptu(jl,jk+1) = (dh(jl,jk+1)-pgeoh(jl,jk+1))*rcpd<a name='1938'>
            kup(jl,jk+1) = 0.5<a name='1939'>
            klab(jl,jk+1)= 1<a name='1940'>
            vptu(jl,jk+1)=ptu(jl,jk+1)*(1.+vtmpc1*pqu(jl,jk+1))<a name='1941'>
            vten(jl,jk+1)=ptenh(jl,jk+1)*(1.+vtmpc1*pqenh(jl,jk+1))<a name='1942'>
            zbuo(jl,jk+1)=(vptu(jl,jk+1)-vten(jl,jk+1))/vten(jl,jk+1)<a name='1943'>
          end if<a name='1944'>
          end do<a name='1945'>
        end if<a name='1946'>
<a name='1947'>
<font color=#447700>! the next levels, we use the variables at the first level as initial values<a name='1948'></font>
        do jl=1,klon<a name='1949'>
           if(loflag(jl)) then<a name='1950'>
<font color=#447700>! define the fscale<a name='1951'></font>
             fscale = min(1.,(pqsen(jl,jk)/pqsen(jl,levels))**3)<a name='1952'>
             eta(jl) = 1.75e-3*fscale<a name='1953'>
             dz(jl)  = (pgeoh(jl,jk)-pgeoh(jl,jk+1))*zrg<a name='1954'>
             coef(jl)= 0.5*eta(jl)*dz(jl)<a name='1955'>
             dhen(jl,jk) = pgeoh(jl,jk) + cpd*ptenh(jl,jk)<a name='1956'>
             dh(jl,jk) = (coef(jl)*(dhen(jl,jk+1)+dhen(jl,jk))&amp;<a name='1957'>
     &amp;              +(1.-coef(jl))*dh(jl,jk+1))/(1.+coef(jl))<a name='1958'>
             pqu(jl,jk) =(coef(jl)*(pqenh(jl,jk+1)+pqenh(jl,jk))&amp;<a name='1959'>
     &amp;              +(1.-coef(jl))*pqu(jl,jk+1))/(1.+coef(jl))<a name='1960'>
             ptu(jl,jk) = (dh(jl,jk)-pgeoh(jl,jk))*rcpd<a name='1961'>
             zqold(jl) = pqu(jl,jk)<a name='1962'>
             zph(jl)=paph(jl,jk)<a name='1963'>
           end if<a name='1964'>
        end do<a name='1965'>
<font color=#447700>! check if the parcel is saturated<a name='1966'></font>
        ik=jk<a name='1967'>
        icall=1<a name='1968'>
        call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN'>cuadjtqn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUTYPEN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUADJTQN_3">(klon,klev,ik,zph,ptu,pqu,loflag,icall)<a name='1969'>
 <a name='1970'>
      do jl=1,klon<a name='1971'>
        if( loflag(jl) ) then<a name='1972'>
          zdq = max((zqold(jl) - pqu(jl,jk)),0.)<a name='1973'>
          plu(jl,jk) = plu(jl,jk+1) + zdq<a name='1974'>
          zlglac=zdq*((1.-foealfa(ptu(jl,jk))) - &amp;<a name='1975'>
                      (1.-foealfa(ptu(jl,jk+1))))<a name='1976'>
          plu(jl,jk) = 0.5*plu(jl,jk)<a name='1977'>
          dh(jl,jk) =  pgeoh(jl,jk) + cpd*(ptu(jl,jk)+ralfdcp*zlglac)<a name='1978'>
<font color=#447700>! compute the updraft speed<a name='1979'></font>
          vptu(jl,jk) = ptu(jl,jk)*(1.+vtmpc1*pqu(jl,jk)-plu(jl,jk))+&amp;<a name='1980'>
                        ralfdcp*zlglac<a name='1981'>
          vten(jl,jk) = ptenh(jl,jk)*(1.+vtmpc1*pqenh(jl,jk))<a name='1982'>
          zbuo(jl,jk) = (vptu(jl,jk) - vten(jl,jk))/vten(jl,jk)<a name='1983'>
          abuoy(jl,jk)=(zbuo(jl,jk)+zbuo(jl,jk+1))*0.5*g<a name='1984'>
          atop1 = 1.0 - 2.*coef(jl)<a name='1985'>
          atop2 = 2.0*dz(jl)*abuoy(jl,jk)<a name='1986'>
          abot =  1.0 + 2.*coef(jl)<a name='1987'>
          kup(jl,jk)  = (atop1*kup(jl,jk+1) + atop2) / abot<a name='1988'>
<font color=#447700>! let's find the exact cloud base<a name='1989'></font>
          if ( plu(jl,jk) &gt; 0. .and. klab(jl,jk+1) == 1 ) then<a name='1990'>
              ik = jk + 1<a name='1991'>
              zqsu = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEEWM'>foeewm</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUTYPEN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEEWM_4">(ptu(jl,ik))/paph(jl,ik)<a name='1992'>
              zqsu = min(0.5,zqsu)<a name='1993'>
              zcor = 1./(1.-vtmpc1*zqsu)<a name='1994'>
              zqsu = zqsu*zcor<a name='1995'>
              zdq = min(0.,pqu(jl,ik)-zqsu)<a name='1996'>
              zalfaw = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEALFA'>foealfa</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUTYPEN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEALFA_3">(ptu(jl,ik))<a name='1997'>
              zfacw = c5les/((ptu(jl,ik)-c4les)**2)<a name='1998'>
              zfaci = c5ies/((ptu(jl,ik)-c4ies)**2)<a name='1999'>
              zfac = zalfaw*zfacw + (1.-zalfaw)*zfaci<a name='2000'>
              zesdp = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEEWM'>foeewm</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUTYPEN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEEWM_5">(ptu(jl,ik))/paph(jl,ik)<a name='2001'>
              zcor = 1./(1.-vtmpc1*zesdp)<a name='2002'>
              zdqsdt = zfac*zcor*zqsu<a name='2003'>
              zdtdp = rd*ptu(jl,ik)/(cpd*paph(jl,ik))<a name='2004'>
              zdp = zdq/(zdqsdt*zdtdp)<a name='2005'>
              zcbase(jl) = paph(jl,ik) + zdp<a name='2006'>
<font color=#447700>! chose nearest half level as cloud base (jk or jk+1)<a name='2007'></font>
              zpdifftop = zcbase(jl) - paph(jl,jk)<a name='2008'>
              zpdiffbot = paph(jl,jk+1) - zcbase(jl)<a name='2009'>
              if ( zpdifftop &gt; zpdiffbot .and. kup(jl,jk+1) &gt; 0. ) then<a name='2010'>
                ikb = min(klev-1,jk+1)<a name='2011'>
                klab(jl,ikb) = 2<a name='2012'>
                klab(jl,jk) = 2<a name='2013'>
                kcbot(jl) = ikb<a name='2014'>
                plu(jl,jk+1) = 1.0e-8<a name='2015'>
              else if ( zpdifftop &lt;= zpdiffbot .and.kup(jl,jk) &gt; 0. ) then<a name='2016'>
                klab(jl,jk) = 2<a name='2017'>
                kcbot(jl) = jk<a name='2018'>
              end if<a name='2019'>
          end if<a name='2020'>
<a name='2021'>
          if(kup(jl,jk) .lt. 0.)then<a name='2022'>
            loflag(jl) = .false.<a name='2023'>
            if(plu(jl,jk+1) .gt. 0.) then<a name='2024'>
              kctop(jl) = jk<a name='2025'>
              lldcum(jl) = .true.<a name='2026'>
            else<a name='2027'>
              lldcum(jl) = .false.<a name='2028'>
            end if<a name='2029'>
          else <a name='2030'>
            if(plu(jl,jk) .gt. 0.)then<a name='2031'>
              klab(jl,jk)=2<a name='2032'>
            else<a name='2033'>
              klab(jl,jk)=1<a name='2034'>
            end if<a name='2035'>
          end if<a name='2036'>
        end if<a name='2037'>
      end do<a name='2038'>
<a name='2039'>
      end do <font color=#447700>! end all the levels<a name='2040'></font>
<a name='2041'>
      needreset = .false.<a name='2042'>
      do jl=1,klon<a name='2043'>
        ikb = kcbot(jl)<a name='2044'>
        ikt = kctop(jl)<a name='2045'>
        if(paph(jl,ikb) - paph(jl,ikt) &lt; zdnoprc) lldcum(jl) = .false.<a name='2046'>
        if(lldcum(jl)) then      <a name='2047'>
         ktype(jl)    = 1<a name='2048'>
         ldcum(jl)    = .true.<a name='2049'>
         deepflag(jl) = .true.<a name='2050'>
         wbase(jl)    = sqrt(max(2.*kup(jl,ikb),0.))<a name='2051'>
         cubot(jl)    = ikb<a name='2052'>
         cutop(jl)    = ikt<a name='2053'>
         kdpl(jl)     = levels+1<a name='2054'>
         needreset    = .true.<a name='2055'>
         resetflag(jl)= .true.<a name='2056'>
        end if<a name='2057'>
      end do<a name='2058'>
<a name='2059'>
      if(needreset) then<a name='2060'>
      do jk=klev,1,-1<a name='2061'>
        do jl=1,klon<a name='2062'>
          if(resetflag(jl)) then<a name='2063'>
            ikt = kctop(jl)<a name='2064'>
            ikb = kdpl(jl)<a name='2065'>
            if(jk .le. ikb .and. jk .ge. ikt )then<a name='2066'>
             culab(jl,jk) = klab(jl,jk)<a name='2067'>
             cutu(jl,jk)  = ptu(jl,jk)<a name='2068'>
             cuqu(jl,jk)  = pqu(jl,jk)<a name='2069'>
             culu(jl,jk)  = plu(jl,jk)<a name='2070'>
            else<a name='2071'>
             culab(jl,jk) = 1<a name='2072'>
             cutu(jl,jk)  = ptenh(jl,jk)<a name='2073'>
             cuqu(jl,jk)  = pqenh(jl,jk)<a name='2074'>
             culu(jl,jk)  = 0.<a name='2075'>
            end if<a name='2076'>
            if ( jk .lt. ikt ) culab(jl,jk) = 0<a name='2077'>
          end if<a name='2078'>
        end do<a name='2079'>
      end do<a name='2080'>
      end if<a name='2081'>
<a name='2082'>
      end do <font color=#447700>! end all cycles<a name='2083'></font>
<a name='2084'>
      return<a name='2085'>
      end subroutine cutypen<a name='2086'>
<a name='2087'>
<font color=#447700>!-----------------------------------------------------------------<a name='2088'></font>
<font color=#447700>!    level 3 subroutines 'cuascn'<a name='2089'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='2090'></font>
<A NAME='CUASCN'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUASCN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2091'>
      <font color=#993300>subroutine </font><font color=#cc0000>cuascn</font> &amp; <A href='../../call_to/CUASCN.html' TARGET='index'>1</A>,<A href='../../call_from/CUASCN.html' TARGET='index'>4</A><a name='2092'>
     &amp;    (klon,     klev,     klevp1,   klevm1,   ptenh,&amp;<a name='2093'>
     &amp;     pqenh,    puen,     pven,     pten,     pqen,&amp;<a name='2094'>
     &amp;     pqsen,    pgeo,     pgeoh,    pap,      paph,&amp;<a name='2095'>
     &amp;     pqte,     pverv,    klwmin,   ldcum,    phcbase,&amp;<a name='2096'>
     &amp;     ktype,    klab,     ptu,      pqu,      plu,&amp;<a name='2097'>
     &amp;     puu,      pvu,      pmfu,     pmfub,    &amp;<a name='2098'>
     &amp;     pmfus,    pmfuq,    pmful,    plude,    pdmfup,&amp;<a name='2099'>
     &amp;     kcbot,    kctop,    kctop0,   kcum,     ztmst,&amp;<a name='2100'>
     &amp;     pqsenh,   plglac,   lndj,     wup,      wbase,   kdpl, pmfude_rate)<a name='2101'>
      implicit none<a name='2102'>
<font color=#447700>!     this routine does the calculations for cloud ascents<a name='2103'></font>
<font color=#447700>!     for cumulus parameterization<a name='2104'></font>
<font color=#447700>!     m.tiedtke         e.c.m.w.f.     7/86 modif.  12/89<a name='2105'></font>
<font color=#447700>!     y.wang            iprc           11/01 modif.<a name='2106'></font>
<font color=#447700>!     c.zhang           iprc           05/12 modif.<a name='2107'></font>
<font color=#447700>!***purpose.<a name='2108'></font>
<font color=#447700>!   --------<a name='2109'></font>
<font color=#447700>!          to produce cloud ascents for cu-parametrization<a name='2110'></font>
<font color=#447700>!          (vertical profiles of t,q,l,u and v and corresponding<a name='2111'></font>
<font color=#447700>!           fluxes as well as precipitation rates)<a name='2112'></font>
<font color=#447700>!***interface<a name='2113'></font>
<font color=#447700>!   ---------<a name='2114'></font>
<font color=#447700>!          this routine is called from *cumastr*.<a name='2115'></font>
<font color=#447700>!***method.<a name='2116'></font>
<font color=#447700>!  --------<a name='2117'></font>
<font color=#447700>!          lift surface air dry-adiabatically to cloud base<a name='2118'></font>
<font color=#447700>!          and then calculate moist ascent for<a name='2119'></font>
<font color=#447700>!          entraining/detraining plume.<a name='2120'></font>
<font color=#447700>!          entrainment and detrainment rates differ for<a name='2121'></font>
<font color=#447700>!          shallow and deep cumulus convection.<a name='2122'></font>
<font color=#447700>!          in case there is no penetrative or shallow convection<a name='2123'></font>
<font color=#447700>!          check for possibility of mid level convection<a name='2124'></font>
<font color=#447700>!          (cloud base values calculated in *cubasmc*)<a name='2125'></font>
<font color=#447700>!***externals<a name='2126'></font>
<font color=#447700>!   ---------<a name='2127'></font>
<font color=#447700>!          *cuadjtqn* adjust t and q due to condensation in ascent<a name='2128'></font>
<font color=#447700>!          *cuentrn*  calculate entrainment/detrainment rates<a name='2129'></font>
<font color=#447700>!          *cubasmcn* calculate cloud base values for midlevel convection<a name='2130'></font>
<font color=#447700>!***reference<a name='2131'></font>
<font color=#447700>!   ---------<a name='2132'></font>
<font color=#447700>!          (tiedtke,1989)<a name='2133'></font>
<font color=#447700>!***input variables:<a name='2134'></font>
<font color=#447700>!       ptenh [ztenh] - environ temperature on half levels. (cuini)<a name='2135'></font>
<font color=#447700>!       pqenh [zqenh] - env. specific humidity on half levels. (cuini)<a name='2136'></font>
<font color=#447700>!       puen - environment wind u-component. (mssflx)<a name='2137'></font>
<font color=#447700>!       pven - environment wind v-component. (mssflx)<a name='2138'></font>
<font color=#447700>!       pten - environment temperature. (mssflx)<a name='2139'></font>
<font color=#447700>!       pqen - environment specific humidity. (mssflx)<a name='2140'></font>
<font color=#447700>!       pqsen - environment saturation specific humidity. (mssflx)<a name='2141'></font>
<font color=#447700>!       pgeo - geopotential. (mssflx)<a name='2142'></font>
<font color=#447700>!       pgeoh [zgeoh] - geopotential on half levels, (mssflx)<a name='2143'></font>
<font color=#447700>!       pap - pressure in pa.  (mssflx)<a name='2144'></font>
<font color=#447700>!       paph - pressure of half levels. (mssflx)<a name='2145'></font>
<font color=#447700>!       pqte - moisture convergence (delta q/delta t). (mssflx)<a name='2146'></font>
<font color=#447700>!       pverv - large scale vertical velocity (omega). (mssflx)<a name='2147'></font>
<font color=#447700>!       klwmin [ilwmin] - level of minimum omega. (cuini)<a name='2148'></font>
<font color=#447700>!       klab [ilab] - level label - 1: sub-cloud layer.<a name='2149'></font>
<font color=#447700>!                                   2: condensation level (cloud base)<a name='2150'></font>
<font color=#447700>!       pmfub [zmfub] - updraft mass flux at cloud base. (cumastr)<a name='2151'></font>
<font color=#447700>!***variables modified by cuasc:<a name='2152'></font>
<font color=#447700>!       ldcum - logical denoting profiles. (cubase)<a name='2153'></font>
<font color=#447700>!       ktype - convection type - 1: penetrative  (cumastr)<a name='2154'></font>
<font color=#447700>!                                 2: stratocumulus (cumastr)<a name='2155'></font>
<font color=#447700>!                                 3: mid-level  (cuasc)<a name='2156'></font>
<font color=#447700>!       ptu - cloud temperature.<a name='2157'></font>
<font color=#447700>!       pqu - cloud specific humidity.<a name='2158'></font>
<font color=#447700>!       plu - cloud liquid water (moisture condensed out)<a name='2159'></font>
<font color=#447700>!       puu [zuu] - cloud momentum u-component.<a name='2160'></font>
<font color=#447700>!       pvu [zvu] - cloud momentum v-component.<a name='2161'></font>
<font color=#447700>!       pmfu - updraft mass flux.<a name='2162'></font>
<font color=#447700>!       pmfus [zmfus] - updraft flux of dry static energy. (cubasmc)<a name='2163'></font>
<font color=#447700>!       pmfuq [zmfuq] - updraft flux of specific humidity.<a name='2164'></font>
<font color=#447700>!       pmful [zmful] - updraft flux of cloud liquid water.<a name='2165'></font>
<font color=#447700>!       plude - liquid water returned to environment by detrainment.<a name='2166'></font>
<font color=#447700>!       pdmfup [zmfup] -<a name='2167'></font>
<font color=#447700>!       kcbot - cloud base level. (cubase)<a name='2168'></font>
<font color=#447700>!       kctop - cloud top level<a name='2169'></font>
<font color=#447700>!       kctop0 [ictop0] - estimate of cloud top. (cumastr)<a name='2170'></font>
<font color=#447700>!       kcum [icum] - flag to control the call<a name='2171'></font>
<a name='2172'>
      integer  klev,klon,klevp1,klevm1<a name='2173'>
      real     ptenh(klon,klev),       pqenh(klon,klev), &amp;<a name='2174'>
     &amp;         puen(klon,klev),        pven(klon,klev),&amp;<a name='2175'>
     &amp;         pten(klon,klev),        pqen(klon,klev),&amp;<a name='2176'>
     &amp;         pgeo(klon,klev),        pgeoh(klon,klevp1),&amp;<a name='2177'>
     &amp;         pap(klon,klev),         paph(klon,klevp1),&amp;<a name='2178'>
     &amp;         pqsen(klon,klev),       pqte(klon,klev),&amp;<a name='2179'>
     &amp;         pverv(klon,klev),       pqsenh(klon,klev)<a name='2180'>
      real     ptu(klon,klev),         pqu(klon,klev),&amp;<a name='2181'>
     &amp;         puu(klon,klev),         pvu(klon,klev),&amp;<a name='2182'>
     &amp;         pmfu(klon,klev),        zph(klon),&amp;<a name='2183'>
     &amp;         pmfub(klon),            &amp;<a name='2184'>
     &amp;         pmfus(klon,klev),       pmfuq(klon,klev),&amp;<a name='2185'>
     &amp;         plu(klon,klev),         plude(klon,klev),&amp;<a name='2186'>
     &amp;         pmful(klon,klev),       pdmfup(klon,klev)<a name='2187'>
      real     zdmfen(klon),           zdmfde(klon),&amp;<a name='2188'>
     &amp;         zmfuu(klon),            zmfuv(klon),&amp;<a name='2189'>
     &amp;         zpbase(klon),           zqold(klon)              <a name='2190'>
      real     phcbase(klon),          zluold(klon)<a name='2191'>
      real     zprecip(klon),          zlrain(klon,klev)<a name='2192'>
      real     zbuo(klon,klev),        kup(klon,klev)<a name='2193'>
      real     wup(klon)<a name='2194'>
      real     wbase(klon),            zodetr(klon,klev)<a name='2195'>
      real     plglac(klon,klev)<a name='2196'>
<a name='2197'>
      real     eta(klon),dz(klon)<a name='2198'>
<a name='2199'>
      integer  klwmin(klon),           ktype(klon),&amp;<a name='2200'>
     &amp;         klab(klon,klev),        kcbot(klon),&amp;<a name='2201'>
     &amp;         kctop(klon),            kctop0(klon)<a name='2202'>
      integer  lndj(klon)<a name='2203'>
      logical  ldcum(klon),            loflag(klon)<a name='2204'>
      logical  llo2,llo3,              llo1(klon)<a name='2205'>
<a name='2206'>
      integer  kdpl(klon)<a name='2207'>
      real     zoentr(klon),           zdpmean(klon)<a name='2208'>
      real     pdmfen(klon,klev),      pmfude_rate(klon,klev)<a name='2209'>
<font color=#447700>! local variables<a name='2210'></font>
      integer  jl,jk<a name='2211'>
      integer  ikb,icum,itopm2,ik,icall,is,kcum,jlm,jll<a name='2212'>
      integer  jlx(klon)<a name='2213'>
      real     ztmst,zcons2,zfacbuo,zprcdgw,z_cwdrag,z_cldmax,z_cwifrac,z_cprc2<a name='2214'>
      real     zmftest,zmfmax,zqeen,zseen,zscde,zqude<a name='2215'>
      real     zmfusk,zmfuqk,zmfulk<a name='2216'>
      real     zbc,zbe,zkedke,zmfun,zwu,zprcon,zdt,zcbf,zzco<a name='2217'>
      real     zlcrit,zdfi,zc,zd,zint,zlnew,zvw,zvi,zalfaw,zrold<a name='2218'>
      real     zrnew,zz,zdmfeu,zdmfdu,dp<a name='2219'>
      real     zfac,zbuoc,zdkbuo,zdken,zvv,zarg,zchange,zxe,zxs,zdshrd<a name='2220'>
      real     atop1,atop2,abot<a name='2221'>
<font color=#447700>!--------------------------------<a name='2222'></font>
<font color=#447700>!*    1.       specify parameters<a name='2223'></font>
<font color=#447700>!--------------------------------<a name='2224'></font>
      zcons2=3./(g*ztmst)<a name='2225'>
      zfacbuo = 0.5/(1.+0.5)<a name='2226'>
      zprcdgw = cprcon*zrg<a name='2227'>
      z_cldmax = 5.e-3<a name='2228'>
      z_cwifrac = 0.5<a name='2229'>
      z_cprc2 = 0.5<a name='2230'>
      z_cwdrag = (3.0/8.0)*0.506/0.2<a name='2231'>
<font color=#447700>!---------------------------------<a name='2232'></font>
<font color=#447700>!     2.        set default values<a name='2233'></font>
<font color=#447700>!---------------------------------<a name='2234'></font>
      llo3 = .false.<a name='2235'>
      do jl=1,klon<a name='2236'>
        zluold(jl)=0.<a name='2237'>
        wup(jl)=0.<a name='2238'>
        zdpmean(jl)=0.<a name='2239'>
        zoentr(jl)=0.<a name='2240'>
        if(.not.ldcum(jl)) then<a name='2241'>
          ktype(jl)=0<a name='2242'>
          kcbot(jl) = -1<a name='2243'>
          pmfub(jl) = 0.<a name='2244'>
          pqu(jl,klev) = 0.<a name='2245'>
        end if<a name='2246'>
      end do<a name='2247'>
<a name='2248'>
 <font color=#447700>! initialize variout quantities     <a name='2249'></font>
      do jk=1,klev<a name='2250'>
      do jl=1,klon<a name='2251'>
          if(jk.ne.kcbot(jl)) plu(jl,jk)=0.<a name='2252'>
          pmfu(jl,jk)=0.<a name='2253'>
          pmfus(jl,jk)=0.<a name='2254'>
          pmfuq(jl,jk)=0.<a name='2255'>
          pmful(jl,jk)=0.<a name='2256'>
          plude(jl,jk)=0.<a name='2257'>
          plglac(jl,jk)=0.<a name='2258'>
          pdmfup(jl,jk)=0.<a name='2259'>
          zlrain(jl,jk)=0.<a name='2260'>
          zbuo(jl,jk)=0.<a name='2261'>
          kup(jl,jk)=0.<a name='2262'>
          pdmfen(jl,jk) = 0.<a name='2263'>
          pmfude_rate(jl,jk) = 0.<a name='2264'>
          if(.not.ldcum(jl).or.ktype(jl).eq.3) klab(jl,jk)=0<a name='2265'>
          if(.not.ldcum(jl).and.paph(jl,jk).lt.4.e4) kctop0(jl)=jk<a name='2266'>
      end do<a name='2267'>
      end do<a name='2268'>
<a name='2269'>
      do jl = 1,klon<a name='2270'>
        if ( ktype(jl) == 3 ) ldcum(jl) = .false.<a name='2271'>
      end do<a name='2272'>
<font color=#447700>!------------------------------------------------<a name='2273'></font>
<font color=#447700>!     3.0      initialize values at cloud base level<a name='2274'></font>
<font color=#447700>!------------------------------------------------<a name='2275'></font>
      do jl=1,klon<a name='2276'>
        kctop(jl)=kcbot(jl)<a name='2277'>
        if(ldcum(jl)) then<a name='2278'>
          ikb = kcbot(jl)<a name='2279'>
          kup(jl,ikb) = 0.5*wbase(jl)**2<a name='2280'>
          pmfu(jl,ikb) = pmfub(jl)<a name='2281'>
          pmfus(jl,ikb) = pmfub(jl)*(cpd*ptu(jl,ikb)+pgeoh(jl,ikb))<a name='2282'>
          pmfuq(jl,ikb) = pmfub(jl)*pqu(jl,ikb)<a name='2283'>
          pmful(jl,ikb) = pmfub(jl)*plu(jl,ikb)<a name='2284'>
        end if<a name='2285'>
      end do<a name='2286'>
<font color=#447700>!<a name='2287'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='2288'></font>
<font color=#447700>!     4.       do ascent: subcloud layer (klab=1) ,clouds (klab=2)<a name='2289'></font>
<font color=#447700>!              by doing first dry-adiabatic ascent and then<a name='2290'></font>
<font color=#447700>!              by adjusting t,q and l accordingly in *cuadjtqn*,<a name='2291'></font>
<font color=#447700>!              then check for buoyancy and set flags accordingly<a name='2292'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='2293'></font>
<font color=#447700>!<a name='2294'></font>
      do jk=klevm1,3,-1<a name='2295'>
<font color=#447700>!             specify cloud base values for midlevel convection<a name='2296'></font>
<font color=#447700>!             in *cubasmc* in case there is not already convection<a name='2297'></font>
<font color=#447700>! ---------------------------------------------------------------------<a name='2298'></font>
      ik=jk<a name='2299'>
      call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUBASMCN'>cubasmcn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUASCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUBASMCN_1">&amp;<a name='2300'>
     &amp;    (klon,     klev,     klevm1,   ik,      pten,&amp;<a name='2301'>
     &amp;     pqen,     pqsen,    puen,     pven,    pverv,&amp;<a name='2302'>
     &amp;     pgeo,     pgeoh,    ldcum,   ktype,   klab,  zlrain,&amp;<a name='2303'>
     &amp;     pmfu,     pmfub,    kcbot,   ptu,&amp;<a name='2304'>
     &amp;     pqu,      plu,      puu,     pvu,      pmfus,&amp;<a name='2305'>
     &amp;     pmfuq,    pmful,    pdmfup)<a name='2306'>
      is = 0<a name='2307'>
      jlm = 0<a name='2308'>
      do jl = 1,klon<a name='2309'>
        loflag(jl) = .false.<a name='2310'>
        zprecip(jl) = 0.<a name='2311'>
        llo1(jl) = .false.<a name='2312'>
        is = is + klab(jl,jk+1)<a name='2313'>
        if ( klab(jl,jk+1) == 0 ) klab(jl,jk) = 0<a name='2314'>
        if ( (ldcum(jl) .and. klab(jl,jk+1) == 2) .or.   &amp;<a name='2315'>
             (ktype(jl) == 3 .and. klab(jl,jk+1) == 1) ) then<a name='2316'>
          loflag(jl) = .true.<a name='2317'>
          jlm = jlm + 1<a name='2318'>
          jlx(jlm) = jl<a name='2319'>
        end if<a name='2320'>
        zph(jl) = paph(jl,jk)<a name='2321'>
        if ( ktype(jl) == 3 .and. jk == kcbot(jl) ) then<a name='2322'>
          zmfmax = (paph(jl,jk)-paph(jl,jk-1))*zcons2<a name='2323'>
          if ( pmfub(jl) &gt; zmfmax ) then<a name='2324'>
            zfac = zmfmax/pmfub(jl)<a name='2325'>
            pmfu(jl,jk+1) = pmfu(jl,jk+1)*zfac<a name='2326'>
            pmfus(jl,jk+1) = pmfus(jl,jk+1)*zfac<a name='2327'>
            pmfuq(jl,jk+1) = pmfuq(jl,jk+1)*zfac<a name='2328'>
            pmfub(jl) = zmfmax<a name='2329'>
          end if<a name='2330'>
          pmfub(jl)=min(pmfub(jl),zmfmax)<a name='2331'>
        end if<a name='2332'>
      end do<a name='2333'>
<a name='2334'>
      if(is.gt.0) llo3 = .true.<a name='2335'>
<font color=#447700>!<a name='2336'></font>
<font color=#447700>!*     specify entrainment rates in *cuentr*<a name='2337'></font>
<font color=#447700>! -------------------------------------<a name='2338'></font>
      ik=jk<a name='2339'>
      call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUENTRN'>cuentrn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUASCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUENTRN_1">(klon,klev,ik,kcbot,ldcum,llo3, &amp;<a name='2340'>
                  pgeoh,pmfu,zdmfen,zdmfde)<a name='2341'>
<font color=#447700>!<a name='2342'></font>
<font color=#447700>!      do adiabatic ascent for entraining/detraining plume<a name='2343'></font>
      if(llo3) then<a name='2344'>
<font color=#447700>! -------------------------------------------------------<a name='2345'></font>
<font color=#447700>!<a name='2346'></font>
        do jl = 1,klon<a name='2347'>
          zqold(jl) = 0.<a name='2348'>
        end do<a name='2349'>
        do jll = 1 , jlm<a name='2350'>
          jl = jlx(jll)<a name='2351'>
          zdmfde(jl) = min(zdmfde(jl),0.75*pmfu(jl,jk+1))<a name='2352'>
          if ( jk == kcbot(jl) ) then<a name='2353'>
            zoentr(jl) = -1.75e-3*(min(1.,pqen(jl,jk)/pqsen(jl,jk)) - &amp;<a name='2354'>
                         1.)*(pgeoh(jl,jk)-pgeoh(jl,jk+1))*zrg<a name='2355'>
            zoentr(jl) = min(0.4,zoentr(jl))*pmfu(jl,jk+1)<a name='2356'>
          end if<a name='2357'>
          if ( jk &lt; kcbot(jl) ) then<a name='2358'>
            zmfmax = (paph(jl,jk)-paph(jl,jk-1))*zcons2<a name='2359'>
            zxs = max(pmfu(jl,jk+1)-zmfmax,0.)<a name='2360'>
            wup(jl) = wup(jl) + kup(jl,jk+1)*(pap(jl,jk+1)-pap(jl,jk))<a name='2361'>
            zdpmean(jl) = zdpmean(jl) + pap(jl,jk+1) - pap(jl,jk)<a name='2362'>
            zdmfen(jl) = zoentr(jl)<a name='2363'>
            if ( ktype(jl) &gt;= 2 ) then<a name='2364'>
              zdmfen(jl) = 2.0*zdmfen(jl)<a name='2365'>
              zdmfde(jl) = zdmfen(jl)<a name='2366'>
            end if<a name='2367'>
            zdmfde(jl) = zdmfde(jl) * &amp;<a name='2368'>
                         (1.6-min(1.,pqen(jl,jk)/pqsen(jl,jk)))<a name='2369'>
            zmftest = pmfu(jl,jk+1) + zdmfen(jl) - zdmfde(jl)<a name='2370'>
            zchange = max(zmftest-zmfmax,0.)<a name='2371'>
            zxe = max(zchange-zxs,0.)<a name='2372'>
            zdmfen(jl) = zdmfen(jl) - zxe<a name='2373'>
            zchange = zchange - zxe<a name='2374'>
            zdmfde(jl) = zdmfde(jl) + zchange<a name='2375'>
          end if<a name='2376'>
          pdmfen(jl,jk) = zdmfen(jl) - zdmfde(jl)<a name='2377'>
          pmfu(jl,jk) = pmfu(jl,jk+1) + zdmfen(jl) - zdmfde(jl)<a name='2378'>
          zqeen = pqenh(jl,jk+1)*zdmfen(jl)<a name='2379'>
          zseen = (cpd*ptenh(jl,jk+1)+pgeoh(jl,jk+1))*zdmfen(jl)<a name='2380'>
          zscde = (cpd*ptu(jl,jk+1)+pgeoh(jl,jk+1))*zdmfde(jl)<a name='2381'>
          zqude = pqu(jl,jk+1)*zdmfde(jl)<a name='2382'>
          plude(jl,jk) = plu(jl,jk+1)*zdmfde(jl)<a name='2383'>
          zmfusk = pmfus(jl,jk+1) + zseen - zscde<a name='2384'>
          zmfuqk = pmfuq(jl,jk+1) + zqeen - zqude<a name='2385'>
          zmfulk = pmful(jl,jk+1) - plude(jl,jk)<a name='2386'>
          plu(jl,jk) = zmfulk*(1./max(cmfcmin,pmfu(jl,jk)))<a name='2387'>
          pqu(jl,jk) = zmfuqk*(1./max(cmfcmin,pmfu(jl,jk)))<a name='2388'>
          ptu(jl,jk) = (zmfusk * &amp;<a name='2389'>
            (1./max(cmfcmin,pmfu(jl,jk)))-pgeoh(jl,jk))*rcpd<a name='2390'>
          ptu(jl,jk) = max(100.,ptu(jl,jk))<a name='2391'>
          ptu(jl,jk) = min(400.,ptu(jl,jk))<a name='2392'>
          zqold(jl) = pqu(jl,jk)<a name='2393'>
          zlrain(jl,jk) = zlrain(jl,jk+1)*(pmfu(jl,jk+1)-zdmfde(jl)) * &amp;<a name='2394'>
                          (1./max(cmfcmin,pmfu(jl,jk)))<a name='2395'>
          zluold(jl) = plu(jl,jk)<a name='2396'>
        end do<a name='2397'>
<font color=#447700>! reset to environmental values if below departure level<a name='2398'></font>
        do jl = 1,klon<a name='2399'>
          if ( jk &gt; kdpl(jl) ) then<a name='2400'>
            ptu(jl,jk) = ptenh(jl,jk)<a name='2401'>
            pqu(jl,jk) = pqenh(jl,jk)<a name='2402'>
            plu(jl,jk) = 0.<a name='2403'>
            zluold(jl) = plu(jl,jk)<a name='2404'>
          end if<a name='2405'>
        end do<a name='2406'>
<font color=#447700>!*             do corrections for moist ascent<a name='2407'></font>
<font color=#447700>!*             by adjusting t,q and l in *cuadjtq*<a name='2408'></font>
<font color=#447700>!------------------------------------------------<a name='2409'></font>
      ik=jk<a name='2410'>
      icall=1<a name='2411'>
<font color=#447700>!<a name='2412'></font>
      if ( jlm &gt; 0 ) then<a name='2413'>
        call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN'>cuadjtqn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUASCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUADJTQN_4">(klon,klev,ik,zph,ptu,pqu,loflag,icall)<a name='2414'>
      end if<a name='2415'>
<font color=#447700>! compute the upfraft speed in cloud layer<a name='2416'></font>
        do jll = 1 , jlm<a name='2417'>
          jl = jlx(jll)<a name='2418'>
          if ( pqu(jl,jk) /= zqold(jl) ) then<a name='2419'>
            plglac(jl,jk) = plu(jl,jk) * &amp;<a name='2420'>
                           ((1.-foealfa(ptu(jl,jk)))- &amp;<a name='2421'>
                            (1.-foealfa(ptu(jl,jk+1))))<a name='2422'>
            ptu(jl,jk) = ptu(jl,jk) + ralfdcp*plglac(jl,jk)<a name='2423'>
          end if<a name='2424'>
        end do<a name='2425'>
        do jll = 1 , jlm<a name='2426'>
          jl = jlx(jll)<a name='2427'>
          if ( pqu(jl,jk) /= zqold(jl) ) then<a name='2428'>
            klab(jl,jk) = 2<a name='2429'>
            plu(jl,jk) = plu(jl,jk) + zqold(jl) - pqu(jl,jk)<a name='2430'>
            zbc = ptu(jl,jk)*(1.+vtmpc1*pqu(jl,jk)-plu(jl,jk+1) - &amp;<a name='2431'>
              zlrain(jl,jk+1))<a name='2432'>
            zbe = ptenh(jl,jk)*(1.+vtmpc1*pqenh(jl,jk))<a name='2433'>
            zbuo(jl,jk) = zbc - zbe<a name='2434'>
<font color=#447700>! set flags for the case of midlevel convection<a name='2435'></font>
            if ( ktype(jl) == 3 .and. klab(jl,jk+1) == 1 ) then<a name='2436'>
              if ( zbuo(jl,jk) &gt; -0.5 ) then<a name='2437'>
                ldcum(jl) = .true.<a name='2438'>
                kctop(jl) = jk<a name='2439'>
                kup(jl,jk) = 0.5<a name='2440'>
              else<a name='2441'>
                klab(jl,jk) = 0<a name='2442'>
                pmfu(jl,jk) = 0.<a name='2443'>
                plude(jl,jk) = 0.<a name='2444'>
                plu(jl,jk) = 0.<a name='2445'>
              end if<a name='2446'>
            end if<a name='2447'>
            if ( klab(jl,jk+1) == 2 ) then<a name='2448'>
              if ( zbuo(jl,jk) &lt; 0. ) then<a name='2449'>
                ptenh(jl,jk) = 0.5*(pten(jl,jk)+pten(jl,jk-1))<a name='2450'>
                pqenh(jl,jk) = 0.5*(pqen(jl,jk)+pqen(jl,jk-1))<a name='2451'>
                zbuo(jl,jk) = zbc - ptenh(jl,jk)*(1.+vtmpc1*pqenh(jl,jk))<a name='2452'>
              end if<a name='2453'>
              zbuoc = (zbuo(jl,jk) / &amp;<a name='2454'>
                (ptenh(jl,jk)*(1.+vtmpc1*pqenh(jl,jk)))+zbuo(jl,jk+1) / &amp;<a name='2455'>
                (ptenh(jl,jk+1)*(1.+vtmpc1*pqenh(jl,jk+1))))*0.5<a name='2456'>
              zdkbuo = (pgeoh(jl,jk)-pgeoh(jl,jk+1))*zfacbuo*zbuoc<a name='2457'>
<font color=#447700>! mixing and "pressure" gradient term in upper troposphere<a name='2458'></font>
              if ( zdmfen(jl) &gt; 0. ) then<a name='2459'>
                zdken = min(1.,(1.+z_cwdrag)*zdmfen(jl) / &amp;<a name='2460'>
                        max(cmfcmin,pmfu(jl,jk+1)))<a name='2461'>
              else<a name='2462'>
                zdken = min(1.,(1.+z_cwdrag)*zdmfde(jl) / &amp;<a name='2463'>
                        max(cmfcmin,pmfu(jl,jk+1)))<a name='2464'>
              end if<a name='2465'>
              kup(jl,jk) = (kup(jl,jk+1)*(1.-zdken)+zdkbuo) / &amp;<a name='2466'>
                           (1.+zdken)<a name='2467'>
              if ( zbuo(jl,jk) &lt; 0. ) then<a name='2468'>
                zkedke = kup(jl,jk)/max(1.e-10,kup(jl,jk+1))<a name='2469'>
                zkedke = max(0.,min(1.,zkedke))<a name='2470'>
                zmfun = sqrt(zkedke)*pmfu(jl,jk+1)<a name='2471'>
                zdmfde(jl) = max(zdmfde(jl),pmfu(jl,jk+1)-zmfun)<a name='2472'>
                plude(jl,jk) = plu(jl,jk+1)*zdmfde(jl)<a name='2473'>
                pmfu(jl,jk) = pmfu(jl,jk+1) + zdmfen(jl) - zdmfde(jl)<a name='2474'>
              end if<a name='2475'>
              if ( zbuo(jl,jk) &gt; -0.2  ) then<a name='2476'>
                ikb = kcbot(jl)<a name='2477'>
                zoentr(jl) = 1.75e-3*(0.3-(min(1.,pqen(jl,jk-1) /    &amp;<a name='2478'>
                  pqsen(jl,jk-1))-1.))*(pgeoh(jl,jk-1)-pgeoh(jl,jk)) * &amp;<a name='2479'>
                  zrg*min(1.,pqsen(jl,jk)/pqsen(jl,ikb))**3<a name='2480'>
                zoentr(jl) = min(0.4,zoentr(jl))*pmfu(jl,jk)<a name='2481'>
              else<a name='2482'>
                zoentr(jl) = 0.<a name='2483'>
              end if<a name='2484'>
<font color=#447700>! erase values if below departure level<a name='2485'></font>
              if ( jk &gt; kdpl(jl) ) then<a name='2486'>
                pmfu(jl,jk) = pmfu(jl,jk+1)<a name='2487'>
                kup(jl,jk) = 0.5<a name='2488'>
              end if<a name='2489'>
              if ( kup(jl,jk) &gt; 0. .and. pmfu(jl,jk) &gt; 0. ) then<a name='2490'>
                kctop(jl) = jk<a name='2491'>
                llo1(jl) = .true.<a name='2492'>
              else<a name='2493'>
                klab(jl,jk) = 0<a name='2494'>
                pmfu(jl,jk) = 0.<a name='2495'>
                kup(jl,jk) = 0.<a name='2496'>
                zdmfde(jl) = pmfu(jl,jk+1)<a name='2497'>
                plude(jl,jk) = plu(jl,jk+1)*zdmfde(jl)<a name='2498'>
              end if<a name='2499'>
<font color=#447700>! save detrainment rates for updraught<a name='2500'></font>
              if ( pmfu(jl,jk+1) &gt; 0. ) pmfude_rate(jl,jk) = zdmfde(jl)<a name='2501'>
            end if<a name='2502'>
          else if ( ktype(jl) == 2 .and. pqu(jl,jk) == zqold(jl) ) then<a name='2503'>
            klab(jl,jk) = 0<a name='2504'>
            pmfu(jl,jk) = 0.<a name='2505'>
            kup(jl,jk) = 0.<a name='2506'>
            zdmfde(jl) = pmfu(jl,jk+1)<a name='2507'>
            plude(jl,jk) = plu(jl,jk+1)*zdmfde(jl)<a name='2508'>
            pmfude_rate(jl,jk) = zdmfde(jl)<a name='2509'>
          end if<a name='2510'>
        end do<a name='2511'>
<a name='2512'>
        do jl = 1,klon<a name='2513'>
          if ( llo1(jl) ) then<a name='2514'>
<font color=#447700>! conversions only proceeds if plu is greater than a threshold liquid water<a name='2515'></font>
<font color=#447700>! content of 0.3 g/kg over water and 0.5 g/kg over land to prevent precipitation<a name='2516'></font>
<font color=#447700>! generation from small water contents.<a name='2517'></font>
            if ( lndj(jl).eq.1 ) then<a name='2518'>
              zdshrd = 5.e-4<a name='2519'>
            else<a name='2520'>
              zdshrd = 3.e-4<a name='2521'>
            end if<a name='2522'>
            ikb=kcbot(jl)<a name='2523'>
            if ( plu(jl,jk) &gt; zdshrd )then<a name='2524'>
              zwu = min(15.0,sqrt(2.*max(0.1,kup(jl,jk+1))))<a name='2525'>
              zprcon = zprcdgw/(0.75*zwu)<a name='2526'>
<font color=#447700>! PARAMETERS FOR BERGERON-FINDEISEN PROCESS (T &lt; -5C)<a name='2527'></font>
              zdt = min(rtber-rtice,max(rtber-ptu(jl,jk),0.))<a name='2528'>
              zcbf = 1. + z_cprc2*sqrt(zdt)<a name='2529'>
              zzco = zprcon*zcbf<a name='2530'>
              zlcrit = zdshrd/zcbf<a name='2531'>
              zdfi = pgeoh(jl,jk) - pgeoh(jl,jk+1)<a name='2532'>
              zc = (plu(jl,jk)-zluold(jl))<a name='2533'>
              zarg = (plu(jl,jk)/zlcrit)**2<a name='2534'>
              if ( zarg &lt; 25.0 ) then<a name='2535'>
                zd = zzco*(1.-exp(-zarg))*zdfi<a name='2536'>
              else<a name='2537'>
                zd = zzco*zdfi<a name='2538'>
              end if<a name='2539'>
              zint = exp(-zd)<a name='2540'>
              zlnew = zluold(jl)*zint + zc/zd*(1.-zint)<a name='2541'>
              zlnew = max(0.,min(plu(jl,jk),zlnew))<a name='2542'>
              zlnew = min(z_cldmax,zlnew)<a name='2543'>
              zprecip(jl) = max(0.,zluold(jl)+zc-zlnew)<a name='2544'>
              pdmfup(jl,jk) = zprecip(jl)*pmfu(jl,jk)<a name='2545'>
              zlrain(jl,jk) = zlrain(jl,jk) + zprecip(jl)<a name='2546'>
              plu(jl,jk) = zlnew<a name='2547'>
            end if<a name='2548'>
          end if<a name='2549'>
        end do<a name='2550'>
        do jl = 1, klon<a name='2551'>
          if ( llo1(jl) ) then<a name='2552'>
            if ( zlrain(jl,jk) &gt; 0. ) then<a name='2553'>
              zvw = 21.18*zlrain(jl,jk)**0.2<a name='2554'>
              zvi = z_cwifrac*zvw<a name='2555'>
              zalfaw = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEALFA'>foealfa</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUASCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEALFA_4">(ptu(jl,jk))<a name='2556'>
              zvv = zalfaw*zvw + (1.-zalfaw)*zvi<a name='2557'>
              zrold = zlrain(jl,jk) - zprecip(jl)<a name='2558'>
              zc = zprecip(jl)<a name='2559'>
              zwu = min(15.0,sqrt(2.*max(0.1,kup(jl,jk))))<a name='2560'>
              zd = zvv/zwu<a name='2561'>
              zint = exp(-zd)<a name='2562'>
              zrnew = zrold*zint + zc/zd*(1.-zint)<a name='2563'>
              zrnew = max(0.,min(zlrain(jl,jk),zrnew))<a name='2564'>
              zlrain(jl,jk) = zrnew<a name='2565'>
            end if<a name='2566'>
          end if<a name='2567'>
        end do<a name='2568'>
        do jll = 1 , jlm<a name='2569'>
          jl = jlx(jll)<a name='2570'>
          pmful(jl,jk) = plu(jl,jk)*pmfu(jl,jk)<a name='2571'>
          pmfus(jl,jk) = (cpd*ptu(jl,jk)+pgeoh(jl,jk))*pmfu(jl,jk)<a name='2572'>
          pmfuq(jl,jk) = pqu(jl,jk)*pmfu(jl,jk)<a name='2573'>
        end do<a name='2574'>
      end if<a name='2575'>
    end do<a name='2576'>
<font color=#447700>!----------------------------------------------------------------------<a name='2577'></font>
<font color=#447700>! 5.       final calculations<a name='2578'></font>
<font color=#447700>! ------------------<a name='2579'></font>
      do jl = 1,klon<a name='2580'>
       if ( kctop(jl) == -1 ) ldcum(jl) = .false.<a name='2581'>
        kcbot(jl) = max(kcbot(jl),kctop(jl))<a name='2582'>
        if ( ldcum(jl) ) then<a name='2583'>
          wup(jl) = max(1.e-2,wup(jl)/max(1.,zdpmean(jl)))<a name='2584'>
          wup(jl) = sqrt(2.*wup(jl))<a name='2585'>
        end if<a name='2586'>
      end do<a name='2587'>
<a name='2588'>
      return<a name='2589'>
      end subroutine cuascn<a name='2590'>
<font color=#447700>!---------------------------------------------------------<a name='2591'></font>
<font color=#447700>!  level 3 souroutines  <a name='2592'></font>
<font color=#447700>!--------------------------------------------------------<a name='2593'></font>
<A NAME='CUDLFSN'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUDLFSN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2594'>
      <font color=#993300>subroutine </font><font color=#cc0000>cudlfsn</font>   &amp;                                                       <A href='../../call_to/CUDLFSN.html' TARGET='index'>1</A>,<A href='../../call_from/CUDLFSN.html' TARGET='index'>1</A><a name='2595'>
     &amp;    (klon,     klev,  &amp;                       <a name='2596'>
     &amp;     kcbot,    kctop,    lndj,   ldcum,   &amp;                               <a name='2597'>
     &amp;     ptenh,    pqenh,    puen,     pven,     &amp;                              <a name='2598'>
     &amp;     pten,     pqsen,    pgeo,                &amp;                             <a name='2599'>
     &amp;     pgeoh,    paph,     ptu,      pqu,      plu,&amp;                          <a name='2600'>
     &amp;     puu,      pvu,      pmfub,    prfl,          &amp;                         <a name='2601'>
     &amp;     ptd,      pqd,      pud,      pvd,            &amp;                        <a name='2602'>
     &amp;     pmfd,     pmfds,    pmfdq,    pdmfdp,          &amp;                       <a name='2603'>
     &amp;     kdtop,    lddraf)                                                     <a name='2604'>
                                                                                 <a name='2605'>
<font color=#447700>!          this routine calculates level of free sinking for                     <a name='2606'></font>
<font color=#447700>!          cumulus downdrafts and specifies t,q,u and v values                   <a name='2607'></font>
                                                                                 <a name='2608'>
<font color=#447700>!          m.tiedtke         e.c.m.w.f.    12/86 modif. 12/89                    <a name='2609'></font>
                                                                                 <a name='2610'>
<font color=#447700>!          purpose.                                                              <a name='2611'></font>
<font color=#447700>!          --------                                                              <a name='2612'></font>
<font color=#447700>!          to produce lfs-values for cumulus downdrafts                          <a name='2613'></font>
<font color=#447700>!          for massflux cumulus parameterization                                 <a name='2614'></font>
                                                                                 <a name='2615'>
<font color=#447700>!          interface                                                             <a name='2616'></font>
<font color=#447700>!          ---------                                                             <a name='2617'></font>
<font color=#447700>!          this routine is called from *cumastr*.                                <a name='2618'></font>
<font color=#447700>!          input are environmental values of t,q,u,v,p,phi                       <a name='2619'></font>
<font color=#447700>!          and updraft values t,q,u and v and also                               <a name='2620'></font>
<font color=#447700>!          cloud base massflux and cu-precipitation rate.                        <a name='2621'></font>
<font color=#447700>!          it returns t,q,u and v values and massflux at lfs.                    <a name='2622'></font>
                                                                                 <a name='2623'>
<font color=#447700>!          method.                                                               <a name='2624'></font>
                                                                                 <a name='2625'>
<font color=#447700>!          check for negative buoyancy of air of equal parts of                  <a name='2626'></font>
<font color=#447700>!          moist environmental air and cloud air.                                <a name='2627'></font>
                                                                                 <a name='2628'>
<font color=#447700>!     parameter     description                                   units          <a name='2629'></font>
<font color=#447700>!     ---------     -----------                                   -----          <a name='2630'></font>
<font color=#447700>!     input parameters (integer):                                                <a name='2631'></font>
                                                                                 <a name='2632'>
<font color=#447700>!    *klon*         number of grid points per packet                             <a name='2633'></font>
<font color=#447700>!    *klev*         number of levels                                             <a name='2634'></font>
<font color=#447700>!    *kcbot*        cloud base level                                             <a name='2635'></font>
<font color=#447700>!    *kctop*        cloud top level                                              <a name='2636'></font>
                                                                                 <a name='2637'>
<font color=#447700>!    input parameters (logical):                                                 <a name='2638'></font>
                                                                                 <a name='2639'>
<font color=#447700>!    *lndj*       land sea mask (1 for land)                              <a name='2640'></font>
<font color=#447700>!    *ldcum*        flag: .true. for convective points                           <a name='2641'></font>
                                                                                 <a name='2642'>
<font color=#447700>!    input parameters (real):                                                    <a name='2643'></font>
                                                                                 <a name='2644'>
<font color=#447700>!    *ptenh*        env. temperature (t+1) on half levels          k             <a name='2645'></font>
<font color=#447700>!    *pqenh*        env. spec. humidity (t+1) on half levels     kg/kg           <a name='2646'></font>
<font color=#447700>!    *puen*         provisional environment u-velocity (t+1)      m/s            <a name='2647'></font>
<font color=#447700>!    *pven*         provisional environment v-velocity (t+1)      m/s            <a name='2648'></font>
<font color=#447700>!    *pten*         provisional environment temperature (t+1)       k            <a name='2649'></font>
<font color=#447700>!    *pqsen*        environment spec. saturation humidity (t+1)   kg/kg          <a name='2650'></font>
<font color=#447700>!    *pgeo*         geopotential                                  m2/s2          <a name='2651'></font>
<font color=#447700>!    *pgeoh*        geopotential on half levels                  m2/s2           <a name='2652'></font>
<font color=#447700>!    *paph*         provisional pressure on half levels           pa             <a name='2653'></font>
<font color=#447700>!    *ptu*          temperature in updrafts                        k             <a name='2654'></font>
<font color=#447700>!    *pqu*          spec. humidity in updrafts                   kg/kg           <a name='2655'></font>
<font color=#447700>!    *plu*          liquid water content in updrafts             kg/kg           <a name='2656'></font>
<font color=#447700>!    *puu*          u-velocity in updrafts                        m/s            <a name='2657'></font>
<font color=#447700>!    *pvu*          v-velocity in updrafts                        m/s            <a name='2658'></font>
<font color=#447700>!    *pmfub*        massflux in updrafts at cloud base           kg/(m2*s)       <a name='2659'></font>
                                                                                 <a name='2660'>
<font color=#447700>!    updated parameters (real):                                                  <a name='2661'></font>
                                                                                 <a name='2662'>
<font color=#447700>!    *prfl*         precipitation rate                           kg/(m2*s)       <a name='2663'></font>
                                                                                 <a name='2664'>
<font color=#447700>!    output parameters (real):                                                   <a name='2665'></font>
                                                                                 <a name='2666'>
<font color=#447700>!    *ptd*          temperature in downdrafts                      k             <a name='2667'></font>
<font color=#447700>!    *pqd*          spec. humidity in downdrafts                 kg/kg           <a name='2668'></font>
<font color=#447700>!    *pud*          u-velocity in downdrafts                      m/s            <a name='2669'></font>
<font color=#447700>!    *pvd*          v-velocity in downdrafts                      m/s            <a name='2670'></font>
<font color=#447700>!    *pmfd*         massflux in downdrafts                       kg/(m2*s)       <a name='2671'></font>
<font color=#447700>!    *pmfds*        flux of dry static energy in downdrafts       j/(m2*s)       <a name='2672'></font>
<font color=#447700>!    *pmfdq*        flux of spec. humidity in downdrafts         kg/(m2*s)       <a name='2673'></font>
<font color=#447700>!    *pdmfdp*       flux difference of precip. in downdrafts     kg/(m2*s)       <a name='2674'></font>
                                                                                 <a name='2675'>
<font color=#447700>!    output parameters (integer):                                                <a name='2676'></font>
                                                                                 <a name='2677'>
<font color=#447700>!    *kdtop*        top level of downdrafts                                      <a name='2678'></font>
                                                                                 <a name='2679'>
<font color=#447700>!    output parameters (logical):                                                <a name='2680'></font>
                                                                                 <a name='2681'>
<font color=#447700>!    *lddraf*       .true. if downdrafts exist                                   <a name='2682'></font>
                                                                                 <a name='2683'>
<font color=#447700>!          externals                                                             <a name='2684'></font>
<font color=#447700>!          ---------                                                             <a name='2685'></font>
<font color=#447700>!          *cuadjtq* for calculating wet bulb t and q at lfs                     <a name='2686'></font>
<font color=#447700>!----------------------------------------------------------------------          <a name='2687'></font>
      implicit none                                                       <a name='2688'>
                   <a name='2689'>
      integer  klev,klon                                                            <a name='2690'>
      real     ptenh(klon,klev),       pqenh(klon,klev), &amp;                        <a name='2691'>
     &amp;         puen(klon,klev),        pven(klon,klev),  &amp;                        <a name='2692'>
     &amp;         pten(klon,klev),        pqsen(klon,klev),  &amp;                       <a name='2693'>
     &amp;         pgeo(klon,klev),                       &amp;                           <a name='2694'>
     &amp;         pgeoh(klon,klev+1),     paph(klon,klev+1),&amp;                        <a name='2695'>
     &amp;         ptu(klon,klev),         pqu(klon,klev),   &amp;                        <a name='2696'>
     &amp;         puu(klon,klev),         pvu(klon,klev),   &amp;                        <a name='2697'>
     &amp;         plu(klon,klev),                          &amp;                         <a name='2698'>
     &amp;         pmfub(klon),            prfl(klon)                                <a name='2699'>
                                                                                 <a name='2700'>
      real     ptd(klon,klev),         pqd(klon,klev),   &amp;                        <a name='2701'>
     &amp;         pud(klon,klev),         pvd(klon,klev),    &amp;                       <a name='2702'>
     &amp;         pmfd(klon,klev),        pmfds(klon,klev),  &amp;                       <a name='2703'>
     &amp;         pmfdq(klon,klev),       pdmfdp(klon,klev)                         <a name='2704'>
      integer  kcbot(klon),            kctop(klon),       &amp;                       <a name='2705'>
     &amp;         kdtop(klon),            ikhsmin(klon)                             <a name='2706'>
      logical  ldcum(klon),                              &amp;<a name='2707'>
     &amp;         lddraf(klon)   <a name='2708'>
      integer  lndj(klon)                                                   <a name='2709'>
                                                                                 <a name='2710'>
      real     ztenwb(klon,klev),      zqenwb(klon,klev), &amp;                       <a name='2711'>
     &amp;         zcond(klon),            zph(klon),         &amp;                       <a name='2712'>
     &amp;         zhsmin(klon)                                                      <a name='2713'>
      logical  llo2(klon)                                                        <a name='2714'>
<font color=#447700>! local variables<a name='2715'></font>
      integer  jl,jk<a name='2716'>
      integer  is,ik,icall,ike<a name='2717'>
      real     zhsk,zttest,zqtest,zbuo,zmftop<a name='2718'>
                                                                                   <a name='2719'>
<font color=#447700>!----------------------------------------------------------------------          <a name='2720'></font>
                                                                                 <a name='2721'>
<font color=#447700>!     1.           set default values for downdrafts                             <a name='2722'></font>
<font color=#447700>!                  ---------------------------------                             <a name='2723'></font>
      do jl=1,klon                                                          <a name='2724'>
        lddraf(jl)=.false.                                                       <a name='2725'>
        kdtop(jl)=klev+1      <a name='2726'>
        ikhsmin(jl)=klev+1<a name='2727'>
        zhsmin(jl)=1.e8                                                  <a name='2728'>
      enddo                                                                      <a name='2729'>
<font color=#447700>!----------------------------------------------------------------------          <a name='2730'></font>
                                                                                 <a name='2731'>
<font color=#447700>!     2.           determine level of free sinking:                              <a name='2732'></font>
<font color=#447700>!                  downdrafts shall start at model level of minimum              <a name='2733'></font>
<font color=#447700>!                  of saturation moist static energy or below                    <a name='2734'></font>
<font color=#447700>!                  respectively                                                  <a name='2735'></font>
                                                                                 <a name='2736'>
<font color=#447700>!                  for every point and proceed as follows:                       <a name='2737'></font>
                                                                                 <a name='2738'>
<font color=#447700>!                    (1) determine level of minimum of hs                        <a name='2739'></font>
<font color=#447700>!                    (2) determine wet bulb environmental t and q                <a name='2740'></font>
<font color=#447700>!                    (3) do mixing with cumulus cloud air                        <a name='2741'></font>
<font color=#447700>!                    (4) check for negative buoyancy                             <a name='2742'></font>
<font color=#447700>!                    (5) if buoyancy&gt;0 repeat (2) to (4) for next                <a name='2743'></font>
<font color=#447700>!                        level below                                             <a name='2744'></font>
                                                                                 <a name='2745'>
<font color=#447700>!                  the assumption is that air of downdrafts is mixture           <a name='2746'></font>
<font color=#447700>!                  of 50% cloud air + 50% environmental air at wet bulb          <a name='2747'></font>
<font color=#447700>!                  temperature (i.e. which became saturated due to               <a name='2748'></font>
<font color=#447700>!                  evaporation of rain and cloud water)                          <a name='2749'></font>
<font color=#447700>!                  ----------------------------------------------------          <a name='2750'></font>
      do jk=3,klev-2<a name='2751'>
         do jl=1,klon<a name='2752'>
           zhsk=cpd*pten(jl,jk)+pgeo(jl,jk) +  &amp;<a name='2753'>
     &amp;         foelhm(pten(jl,jk))*pqsen(jl,jk)<a name='2754'>
           if(zhsk .lt. zhsmin(jl)) then<a name='2755'>
              zhsmin(jl) = zhsk<a name='2756'>
              ikhsmin(jl)= jk<a name='2757'>
           end if<a name='2758'>
         end do<a name='2759'>
      end do<a name='2760'>
<a name='2761'>
<a name='2762'>
      ike=klev-3                                                                 <a name='2763'>
      do jk=3,ike                                                                <a name='2764'>
                                                                                 <a name='2765'>
<font color=#447700>!     2.1          calculate wet-bulb temperature and moisture                   <a name='2766'></font>
<font color=#447700>!                  for environmental air in *cuadjtq*                            <a name='2767'></font>
<font color=#447700>!                  -------------------------------------------                   <a name='2768'></font>
        is=0                                                                     <a name='2769'>
        do jl=1,klon                                                        <a name='2770'>
          ztenwb(jl,jk)=ptenh(jl,jk)                                             <a name='2771'>
          zqenwb(jl,jk)=pqenh(jl,jk)                                             <a name='2772'>
          zph(jl)=paph(jl,jk)                                                    <a name='2773'>
          llo2(jl)=ldcum(jl).and.prfl(jl).gt.0..and..not.lddraf(jl).and.   &amp;      <a name='2774'>
     &amp;     (jk.lt.kcbot(jl).and.jk.gt.kctop(jl)).and. jk.ge.ikhsmin(jl)                            <a name='2775'>
          if(llo2(jl))then                                                       <a name='2776'>
            is=is+1                                                              <a name='2777'>
          endif                                                                  <a name='2778'>
        enddo                                                                    <a name='2779'>
        if(is.eq.0) cycle                                                        <a name='2780'>
                                                                                 <a name='2781'>
        ik=jk                                                                    <a name='2782'>
        icall=2                                                                  <a name='2783'>
        call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN'>cuadjtqn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUDLFSN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUADJTQN_5">                                           &amp;                  <a name='2784'>
     &amp;   ( klon, klev, ik, zph, ztenwb, zqenwb, llo2, icall)                        <a name='2785'>
                                                                                 <a name='2786'>
<font color=#447700>!     2.2          do mixing of cumulus and environmental air                    <a name='2787'></font>
<font color=#447700>!                  and check for negative buoyancy.                              <a name='2788'></font>
<font color=#447700>!                  then set values for downdraft at lfs.                         <a name='2789'></font>
<font color=#447700>!                  ----------------------------------------                      <a name='2790'></font>
        do jl=1,klon                                                        <a name='2791'>
          if(llo2(jl)) then                                                      <a name='2792'>
            zttest=0.5*(ptu(jl,jk)+ztenwb(jl,jk))                                <a name='2793'>
            zqtest=0.5*(pqu(jl,jk)+zqenwb(jl,jk))                                <a name='2794'>
            zbuo=zttest*(1.+vtmpc1  *zqtest)-                    &amp;                  <a name='2795'>
     &amp;       ptenh(jl,jk)*(1.+vtmpc1  *pqenh(jl,jk))                               <a name='2796'>
            zcond(jl)=pqenh(jl,jk)-zqenwb(jl,jk)                                 <a name='2797'>
            zmftop=-cmfdeps*pmfub(jl)                                            <a name='2798'>
            if(zbuo.lt.0..and.prfl(jl).gt.10.*zmftop*zcond(jl)) then             <a name='2799'>
              kdtop(jl)=jk                                                       <a name='2800'>
              lddraf(jl)=.true.                                                  <a name='2801'>
              ptd(jl,jk)=zttest                                                  <a name='2802'>
              pqd(jl,jk)=zqtest                                                  <a name='2803'>
              pmfd(jl,jk)=zmftop                                                 <a name='2804'>
              pmfds(jl,jk)=pmfd(jl,jk)*(cpd*ptd(jl,jk)+pgeoh(jl,jk))            <a name='2805'>
              pmfdq(jl,jk)=pmfd(jl,jk)*pqd(jl,jk)                                <a name='2806'>
              pdmfdp(jl,jk-1)=-0.5*pmfd(jl,jk)*zcond(jl)                         <a name='2807'>
              prfl(jl)=prfl(jl)+pdmfdp(jl,jk-1)                                  <a name='2808'>
            endif                                                                <a name='2809'>
          endif                                                                  <a name='2810'>
        enddo                                                                    <a name='2811'>
                                                                                 <a name='2812'>
      enddo                                                                      <a name='2813'>
                                                                                 <a name='2814'>
      return                                                                     <a name='2815'>
      end subroutine cudlfsn  <a name='2816'>
<a name='2817'>
<font color=#447700>!---------------------------------------------------------<a name='2818'></font>
<font color=#447700>!  level 3 souroutines  <a name='2819'></font>
<font color=#447700>!--------------------------------------------------------<a name='2820'></font>
<font color=#447700>!**********************************************<a name='2821'></font>
<font color=#447700>!       subroutine cuddrafn<a name='2822'></font>
<font color=#447700>!**********************************************<a name='2823'></font>
<A NAME='CUDDRAFN'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUDDRAFN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2824'>
       <font color=#993300>subroutine </font><font color=#cc0000>cuddrafn</font>                                 &amp;                 <A href='../../call_to/CUDDRAFN.html' TARGET='index'>1</A>,<A href='../../call_from/CUDDRAFN.html' TARGET='index'>1</A><a name='2825'>
     &amp;   ( klon,     klev,    lddraf                      &amp;                                   <a name='2826'>
     &amp;   , ptenh,    pqenh,    puen,     pven             &amp;                <a name='2827'>
     &amp;   , pgeo,     pgeoh,    paph,     prfl             &amp;                <a name='2828'>
     &amp;   , ptd,      pqd,      pud,      pvd,      pmfu   &amp;                <a name='2829'>
     &amp;   , pmfd,     pmfds,    pmfdq,    pdmfdp,   pmfdde_rate     )                          <a name='2830'>
                                                                          <a name='2831'>
<font color=#447700>!          this routine calculates cumulus downdraft descent              <a name='2832'></font>
                                                                          <a name='2833'>
<font color=#447700>!          m.tiedtke         e.c.m.w.f.    12/86 modif. 12/89             <a name='2834'></font>
                                                                          <a name='2835'>
<font color=#447700>!          purpose.                                                       <a name='2836'></font>
<font color=#447700>!          --------                                                       <a name='2837'></font>
<font color=#447700>!          to produce the vertical profiles for cumulus downdrafts        <a name='2838'></font>
<font color=#447700>!          (i.e. t,q,u and v and fluxes)                                  <a name='2839'></font>
                                                                          <a name='2840'>
<font color=#447700>!          interface                                                      <a name='2841'></font>
<font color=#447700>!          ---------                                                      <a name='2842'></font>
                                                                          <a name='2843'>
<font color=#447700>!          this routine is called from *cumastr*.                         <a name='2844'></font>
<font color=#447700>!          input is t,q,p,phi,u,v at half levels.                         <a name='2845'></font>
<font color=#447700>!          it returns fluxes of s,q and evaporation rate                  <a name='2846'></font>
<font color=#447700>!          and u,v at levels where downdraft occurs                       <a name='2847'></font>
                                                                          <a name='2848'>
<font color=#447700>!          method.                                                        <a name='2849'></font>
<font color=#447700>!          --------                                                       <a name='2850'></font>
<font color=#447700>!          calculate moist descent for entraining/detraining plume by     <a name='2851'></font>
<font color=#447700>!          a) moving air dry-adiabatically to next level below and        <a name='2852'></font>
<font color=#447700>!          b) correcting for evaporation to obtain saturated state.       <a name='2853'></font>
                                                                          <a name='2854'>
<font color=#447700>!     parameter     description                                   units   <a name='2855'></font>
<font color=#447700>!     ---------     -----------                                   -----   <a name='2856'></font>
<font color=#447700>!     input parameters (integer):                                         <a name='2857'></font>
                                                                          <a name='2858'>
<font color=#447700>!    *klon*         number of grid points per packet                      <a name='2859'></font>
<font color=#447700>!    *klev*         number of levels                                      <a name='2860'></font>
                                                                          <a name='2861'>
<font color=#447700>!    input parameters (logical):                                          <a name='2862'></font>
                                                                          <a name='2863'>
<font color=#447700>!    *lddraf*       .true. if downdrafts exist                            <a name='2864'></font>
                                                                          <a name='2865'>
<font color=#447700>!    input parameters (real):                                             <a name='2866'></font>
                                                                          <a name='2867'>
<font color=#447700>!    *ptenh*        env. temperature (t+1) on half levels          k      <a name='2868'></font>
<font color=#447700>!    *pqenh*        env. spec. humidity (t+1) on half levels     kg/kg    <a name='2869'></font>
<font color=#447700>!    *puen*         provisional environment u-velocity (t+1)      m/s     <a name='2870'></font>
<font color=#447700>!    *pven*         provisional environment v-velocity (t+1)      m/s     <a name='2871'></font>
<font color=#447700>!    *pgeo*         geopotential                                  m2/s2   <a name='2872'></font>
<font color=#447700>!    *pgeoh*        geopotential on half levels                  m2/s2    <a name='2873'></font>
<font color=#447700>!    *paph*         provisional pressure on half levels           pa      <a name='2874'></font>
<font color=#447700>!    *pmfu*         massflux updrafts                           kg/(m2*s) <a name='2875'></font>
                                                                          <a name='2876'>
<font color=#447700>!    updated parameters (real):                                           <a name='2877'></font>
                                                                          <a name='2878'>
<font color=#447700>!    *prfl*         precipitation rate                           kg/(m2*s)<a name='2879'></font>
                                                                          <a name='2880'>
<font color=#447700>!    output parameters (real):                                            <a name='2881'></font>
                                                                          <a name='2882'>
<font color=#447700>!    *ptd*          temperature in downdrafts                      k      <a name='2883'></font>
<font color=#447700>!    *pqd*          spec. humidity in downdrafts                 kg/kg    <a name='2884'></font>
<font color=#447700>!    *pud*          u-velocity in downdrafts                      m/s     <a name='2885'></font>
<font color=#447700>!    *pvd*          v-velocity in downdrafts                      m/s     <a name='2886'></font>
<font color=#447700>!    *pmfd*         massflux in downdrafts                       kg/(m2*s)<a name='2887'></font>
<font color=#447700>!    *pmfds*        flux of dry static energy in downdrafts       j/(m2*s)<a name='2888'></font>
<font color=#447700>!    *pmfdq*        flux of spec. humidity in downdrafts         kg/(m2*s)<a name='2889'></font>
<font color=#447700>!    *pdmfdp*       flux difference of precip. in downdrafts     kg/(m2*s)<a name='2890'></font>
                                                                          <a name='2891'>
<font color=#447700>!          externals                                                      <a name='2892'></font>
<font color=#447700>!          ---------                                                      <a name='2893'></font>
<font color=#447700>!          *cuadjtq* for adjusting t and q due to evaporation in          <a name='2894'></font>
<font color=#447700>!          saturated descent                                              <a name='2895'></font>
<font color=#447700>!----------------------------------------------------------------------   <a name='2896'></font>
      implicit none<a name='2897'>
      <a name='2898'>
      integer  klev,klon                                                             <a name='2899'>
      real     ptenh(klon,klev),       pqenh(klon,klev),   &amp;               <a name='2900'>
     &amp;         puen(klon,klev),        pven(klon,klev),    &amp;               <a name='2901'>
     &amp;         pgeoh(klon,klev+1),     paph(klon,klev+1),  &amp;               <a name='2902'>
     &amp;         pgeo(klon,klev),        pmfu(klon,klev)                    <a name='2903'>
                                                                          <a name='2904'>
      real     ptd(klon,klev),         pqd(klon,klev),     &amp;               <a name='2905'>
     &amp;         pud(klon,klev),         pvd(klon,klev),     &amp;               <a name='2906'>
     &amp;         pmfd(klon,klev),        pmfds(klon,klev),   &amp;               <a name='2907'>
     &amp;         pmfdq(klon,klev),       pdmfdp(klon,klev),  &amp;               <a name='2908'>
     &amp;         prfl(klon)     <a name='2909'>
      real     pmfdde_rate(klon,klev)                                            <a name='2910'>
      logical  lddraf(klon)                                               <a name='2911'>
                                                                          <a name='2912'>
      real     zdmfen(klon),           zdmfde(klon),       &amp;               <a name='2913'>
     &amp;         zcond(klon),            zoentr(klon),       &amp;               <a name='2914'>
     &amp;         zbuoy(klon)                                                <a name='2915'>
      real     zph(klon)                         <a name='2916'>
      logical  llo2(klon)                                   <a name='2917'>
      logical  llo1<a name='2918'>
<font color=#447700>! local variables<a name='2919'></font>
      integer  jl,jk<a name='2920'>
      integer  is,ik,icall,ike, itopde(klon)<a name='2921'>
      real     zentr,zdz,zzentr,zseen,zqeen,zsdde,zqdde,zdmfdp<a name='2922'>
      real     zmfdsk,zmfdqk,zbuo,zrain,zbuoyz,zmfduk,zmfdvk<a name='2923'>
                                                                <a name='2924'>
<font color=#447700>!----------------------------------------------------------------------   <a name='2925'></font>
<font color=#447700>!     1.           calculate moist descent for cumulus downdraft by       <a name='2926'></font>
<font color=#447700>!                     (a) calculating entrainment/detrainment rates,      <a name='2927'></font>
<font color=#447700>!                         including organized entrainment dependent on    <a name='2928'></font>
<font color=#447700>!                         negative buoyancy and assuming                  <a name='2929'></font>
<font color=#447700>!                         linear decrease of massflux in pbl              <a name='2930'></font>
<font color=#447700>!                     (b) doing moist descent - evaporative cooling       <a name='2931'></font>
<font color=#447700>!                         and moistening is calculated in *cuadjtq*       <a name='2932'></font>
<font color=#447700>!                     (c) checking for negative buoyancy and              <a name='2933'></font>
<font color=#447700>!                         specifying final t,q,u,v and downward fluxes    <a name='2934'></font>
<font color=#447700>!                    -------------------------------------------------    <a name='2935'></font>
      do jl=1,klon                                                   <a name='2936'>
        zoentr(jl)=0.                                                     <a name='2937'>
        zbuoy(jl)=0.                                                      <a name='2938'>
        zdmfen(jl)=0.                                                     <a name='2939'>
        zdmfde(jl)=0.<a name='2940'>
      enddo <a name='2941'>
<a name='2942'>
      do jk=klev,1,-1<a name='2943'>
       do jl=1,klon<a name='2944'>
         pmfdde_rate(jl,jk) = 0.<a name='2945'>
         if((paph(jl,klev+1)-paph(jl,jk)).lt. 60.e2) itopde(jl) = jk<a name='2946'>
       end do<a name='2947'>
      end do                                                              <a name='2948'>
                                                                 <a name='2949'>
      do jk=3,klev                                                        <a name='2950'>
        is=0                                                              <a name='2951'>
        do jl=1,klon                                                 <a name='2952'>
          zph(jl)=paph(jl,jk)                                             <a name='2953'>
          llo2(jl)=lddraf(jl).and.pmfd(jl,jk-1).lt.0.                     <a name='2954'>
          if(llo2(jl)) then                                               <a name='2955'>
            is=is+1                                                       <a name='2956'>
          endif                                                           <a name='2957'>
        enddo                                                             <a name='2958'>
        if(is.eq.0) cycle                                                 <a name='2959'>
                                                                          <a name='2960'>
        do jl=1,klon                                                 <a name='2961'>
          if(llo2(jl)) then    <a name='2962'>
            zentr = entrdd*pmfd(jl,jk-1)*(pgeoh(jl,jk-1)-pgeoh(jl,jk))*zrg<a name='2963'>
            zdmfen(jl)=zentr                                              <a name='2964'>
            zdmfde(jl)=zentr                                              <a name='2965'>
          endif                                                           <a name='2966'>
        enddo <a name='2967'>
                                                            <a name='2968'>
        do jl=1,klon<a name='2969'>
          if(llo2(jl)) then<a name='2970'>
          if(jk.gt.itopde(jl)) then<a name='2971'>
            zdmfen(jl)=0.<a name='2972'>
            zdmfde(jl)=pmfd(jl,itopde(jl))*                    &amp;<a name='2973'>
     &amp;       (paph(jl,jk)-paph(jl,jk-1))/                  &amp;<a name='2974'>
     &amp;       (paph(jl,klev+1)-paph(jl,itopde(jl)))<a name='2975'>
          endif<a name='2976'>
          endif<a name='2977'>
        enddo<a name='2978'>
<a name='2979'>
        do jl=1,klon<a name='2980'>
          if(llo2(jl)) then<a name='2981'>
          if(jk.le.itopde(jl)) then<a name='2982'>
            zdz=-(pgeoh(jl,jk-1)-pgeoh(jl,jk))*zrg<a name='2983'>
            zzentr=zoentr(jl)*zdz*pmfd(jl,jk-1)<a name='2984'>
            zdmfen(jl)=zdmfen(jl)+zzentr<a name='2985'>
            zdmfen(jl)=max(zdmfen(jl),0.3*pmfd(jl,jk-1))<a name='2986'>
            zdmfen(jl)=max(zdmfen(jl),-0.75*pmfu(jl,jk)-   &amp;<a name='2987'>
   &amp;         (pmfd(jl,jk-1)-zdmfde(jl)))<a name='2988'>
            zdmfen(jl)=min(zdmfen(jl),0.)<a name='2989'>
          endif<a name='2990'>
          endif<a name='2991'>
        enddo<a name='2992'>
<a name='2993'>
        do jl=1,klon                                                 <a name='2994'>
          if(llo2(jl)) then                                               <a name='2995'>
            pmfd(jl,jk)=pmfd(jl,jk-1)+zdmfen(jl)-zdmfde(jl)<a name='2996'>
            zseen=(cpd*ptenh(jl,jk-1)+pgeoh(jl,jk-1))*zdmfen(jl)         <a name='2997'>
            zqeen=pqenh(jl,jk-1)*zdmfen(jl)                               <a name='2998'>
            zsdde=(cpd*ptd(jl,jk-1)+pgeoh(jl,jk-1))*zdmfde(jl)           <a name='2999'>
            zqdde=pqd(jl,jk-1)*zdmfde(jl)                                 <a name='3000'>
            zmfdsk=pmfds(jl,jk-1)+zseen-zsdde                             <a name='3001'>
            zmfdqk=pmfdq(jl,jk-1)+zqeen-zqdde                             <a name='3002'>
            pqd(jl,jk)=zmfdqk*(1./min(-cmfcmin,pmfd(jl,jk)))              <a name='3003'>
            ptd(jl,jk)=(zmfdsk*(1./min(-cmfcmin,pmfd(jl,jk)))-&amp;            <a name='3004'>
     &amp;                  pgeoh(jl,jk))*rcpd                                <a name='3005'>
            ptd(jl,jk)=min(400.,ptd(jl,jk))                               <a name='3006'>
            ptd(jl,jk)=max(100.,ptd(jl,jk))                               <a name='3007'>
            zcond(jl)=pqd(jl,jk)                                          <a name='3008'>
          endif                                                           <a name='3009'>
        enddo                                                             <a name='3010'>
                                                                          <a name='3011'>
        ik=jk                                                             <a name='3012'>
        icall=2                                                           <a name='3013'>
        call <A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN'>cuadjtqn</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUDDRAFN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUADJTQN_6">(klon, klev, ik, zph, ptd, pqd, llo2, icall )                <a name='3014'>
                                                                          <a name='3015'>
        do jl=1,klon                                                 <a name='3016'>
          if(llo2(jl)) then                                               <a name='3017'>
            zcond(jl)=zcond(jl)-pqd(jl,jk)<a name='3018'>
            zbuo=ptd(jl,jk)*(1.+vtmpc1  *pqd(jl,jk))-          &amp;             <a name='3019'>
     &amp;      ptenh(jl,jk)*(1.+vtmpc1  *pqenh(jl,jk))                         <a name='3020'>
            if(prfl(jl).gt.0..and.pmfu(jl,jk).gt.0.) then                 <a name='3021'>
              zrain=prfl(jl)/pmfu(jl,jk)                                  <a name='3022'>
              zbuo=zbuo-ptd(jl,jk)*zrain<a name='3023'>
            endif                                                         <a name='3024'>
            if(zbuo.ge.0 .or. prfl(jl).le.(pmfd(jl,jk)*zcond(jl))) then    <a name='3025'>
              pmfd(jl,jk)=0.<a name='3026'>
              zbuo=0.                                              <a name='3027'>
            endif<a name='3028'>
            pmfds(jl,jk)=(cpd*ptd(jl,jk)+pgeoh(jl,jk))*pmfd(jl,jk)       <a name='3029'>
            pmfdq(jl,jk)=pqd(jl,jk)*pmfd(jl,jk)                           <a name='3030'>
            zdmfdp=-pmfd(jl,jk)*zcond(jl)                                 <a name='3031'>
            pdmfdp(jl,jk-1)=zdmfdp                                        <a name='3032'>
            prfl(jl)=prfl(jl)+zdmfdp                                      <a name='3033'>
                                                                          <a name='3034'>
<font color=#447700>! compute organized entrainment for use at next level                     <a name='3035'></font>
            zbuoyz=zbuo/ptenh(jl,jk)                                      <a name='3036'>
            zbuoyz=min(zbuoyz,0.0)                                        <a name='3037'>
            zdz=-(pgeo(jl,jk-1)-pgeo(jl,jk))<a name='3038'>
            zbuoy(jl)=zbuoy(jl)+zbuoyz*zdz<a name='3039'>
            zoentr(jl)=g*zbuoyz*0.5/(1.+zbuoy(jl)) <a name='3040'>
            pmfdde_rate(jl,jk) = -zdmfde(jl)<a name='3041'>
          endif                                                           <a name='3042'>
        enddo<a name='3043'>
                                                             <a name='3044'>
      enddo                                                               <a name='3045'>
                                                                          <a name='3046'>
      return                                                              <a name='3047'>
      end subroutine cuddrafn<a name='3048'>
<font color=#447700>!---------------------------------------------------------<a name='3049'></font>
<font color=#447700>!  level 3 souroutines  <a name='3050'></font>
<font color=#447700>!--------------------------------------------------------<a name='3051'></font>
<A NAME='CUFLXN'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUFLXN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3052'>
       <font color=#993300>subroutine </font><font color=#cc0000>cuflxn</font>         &amp;                                                  <A href='../../call_to/CUFLXN.html' TARGET='index'>1</A>,<A href='../../call_from/CUFLXN.html' TARGET='index'>3</A><a name='3053'>
     &amp;  (  klon,     klev,     ztmst &amp;                                                             <a name='3054'>
     &amp;  ,  pten,     pqen,     pqsen,    ptenh,    pqenh   &amp;                    <a name='3055'>
     &amp;  ,  paph,     pap,      pgeoh,    lndj,   ldcum   &amp;                    <a name='3056'>
     &amp;  ,  kcbot,    kctop,    kdtop,    ktopm2            &amp;                    <a name='3057'>
     &amp;  ,  ktype,    lddraf                                &amp;                    <a name='3058'>
     &amp;  ,  pmfu,     pmfd,     pmfus,    pmfds             &amp;                    <a name='3059'>
     &amp;  ,  pmfuq,    pmfdq,    pmful,    plude             &amp;                    <a name='3060'>
     &amp;  ,  pdmfup,   pdmfdp,   pdpmel,   plglac            &amp;                    <a name='3061'>
     &amp;  ,  prain,    pmfdde_rate, pmflxr, pmflxs )                                         <a name='3062'>
                                                                               <a name='3063'>
<font color=#447700>!          m.tiedtke         e.c.m.w.f.     7/86 modif. 12/89                  <a name='3064'></font>
                                                                               <a name='3065'>
<font color=#447700>!          purpose                                                             <a name='3066'></font>
<font color=#447700>!          -------                                                             <a name='3067'></font>
                                                                               <a name='3068'>
<font color=#447700>!          this routine does the final calculation of convective               <a name='3069'></font>
<font color=#447700>!          fluxes in the cloud layer and in the subcloud layer                 <a name='3070'></font>
                                                                               <a name='3071'>
<font color=#447700>!          interface                                                           <a name='3072'></font>
<font color=#447700>!          ---------                                                           <a name='3073'></font>
<font color=#447700>!          this routine is called from *cumastr*.                              <a name='3074'></font>
                                                                               <a name='3075'>
                                                                               <a name='3076'>
<font color=#447700>!     parameter     description                                   units        <a name='3077'></font>
<font color=#447700>!     ---------     -----------                                   -----        <a name='3078'></font>
<font color=#447700>!     input parameters (integer):                                              <a name='3079'></font>
                                                                               <a name='3080'>
<font color=#447700>!    *klon*         number of grid points per packet                           <a name='3081'></font>
<font color=#447700>!    *klev*         number of levels                                           <a name='3082'></font>
<font color=#447700>!    *kcbot*        cloud base level                                           <a name='3083'></font>
<font color=#447700>!    *kctop*        cloud top level                                            <a name='3084'></font>
<font color=#447700>!    *kdtop*        top level of downdrafts                                    <a name='3085'></font>
                                                                               <a name='3086'>
<font color=#447700>!    input parameters (logical):                                               <a name='3087'></font>
                                                                               <a name='3088'>
<font color=#447700>!    *lndj*       land sea mask (1 for land)                            <a name='3089'></font>
<font color=#447700>!    *ldcum*        flag: .true. for convective points                         <a name='3090'></font>
                                                                               <a name='3091'>
<font color=#447700>!    input parameters (real):                                                  <a name='3092'></font>
                                                                               <a name='3093'>
<font color=#447700>!    *ptsphy*       time step for the physics                       s          <a name='3094'></font>
<font color=#447700>!    *pten*         provisional environment temperature (t+1)       k          <a name='3095'></font>
<font color=#447700>!    *pqen*         provisional environment spec. humidity (t+1)  kg/kg        <a name='3096'></font>
<font color=#447700>!    *pqsen*        environment spec. saturation humidity (t+1)   kg/kg        <a name='3097'></font>
<font color=#447700>!    *ptenh*        env. temperature (t+1) on half levels           k          <a name='3098'></font>
<font color=#447700>!    *pqenh*        env. spec. humidity (t+1) on half levels      kg/kg        <a name='3099'></font>
<font color=#447700>!    *paph*         provisional pressure on half levels            pa          <a name='3100'></font>
<font color=#447700>!    *pap*          provisional pressure on full levels            pa          <a name='3101'></font>
<font color=#447700>!    *pgeoh*        geopotential on half levels                   m2/s2        <a name='3102'></font>
                                                                               <a name='3103'>
<font color=#447700>!    updated parameters (integer):                                             <a name='3104'></font>
                                                                               <a name='3105'>
<font color=#447700>!    *ktype*        set to zero if ldcum=.false.                               <a name='3106'></font>
                                                                               <a name='3107'>
<font color=#447700>!    updated parameters (logical):                                             <a name='3108'></font>
                                                                               <a name='3109'>
<font color=#447700>!    *lddraf*       set to .false. if ldcum=.false. or kdtop&lt;kctop             <a name='3110'></font>
                                                                               <a name='3111'>
<font color=#447700>!    updated parameters (real):                                                <a name='3112'></font>
                                                                               <a name='3113'>
<font color=#447700>!    *pmfu*         massflux in updrafts                          kg/(m2*s)    <a name='3114'></font>
<font color=#447700>!    *pmfd*         massflux in downdrafts                        kg/(m2*s)    <a name='3115'></font>
<font color=#447700>!    *pmfus*        flux of dry static energy in updrafts          j/(m2*s)    <a name='3116'></font>
<font color=#447700>!    *pmfds*        flux of dry static energy in downdrafts        j/(m2*s)    <a name='3117'></font>
<font color=#447700>!    *pmfuq*        flux of spec. humidity in updrafts            kg/(m2*s)    <a name='3118'></font>
<font color=#447700>!    *pmfdq*        flux of spec. humidity in downdrafts          kg/(m2*s)    <a name='3119'></font>
<font color=#447700>!    *pmful*        flux of liquid water in updrafts              kg/(m2*s)    <a name='3120'></font>
<font color=#447700>!    *plude*        detrained liquid water                        kg/(m3*s)    <a name='3121'></font>
<font color=#447700>!    *pdmfup*       flux difference of precip. in updrafts        kg/(m2*s)    <a name='3122'></font>
<font color=#447700>!    *pdmfdp*       flux difference of precip. in downdrafts      kg/(m2*s)    <a name='3123'></font>
                                                                               <a name='3124'>
<font color=#447700>!    output parameters (real):                                                 <a name='3125'></font>
                                                                               <a name='3126'>
<font color=#447700>!    *pdpmel*       change in precip.-fluxes due to melting       kg/(m2*s)    <a name='3127'></font>
<font color=#447700>!    *plglac*       flux of frozen cloud water in updrafts        kg/(m2*s)    <a name='3128'></font>
<font color=#447700>!    *pmflxr*       convective rain flux                          kg/(m2*s)    <a name='3129'></font>
<font color=#447700>!    *pmflxs*       convective snow flux                          kg/(m2*s)    <a name='3130'></font>
<font color=#447700>!    *prain*        total precip. produced in conv. updrafts      kg/(m2*s)    <a name='3131'></font>
<font color=#447700>!                   (no evaporation in downdrafts)                             <a name='3132'></font>
                                                                               <a name='3133'>
<font color=#447700>!          externals                                                           <a name='3134'></font>
<font color=#447700>!          ---------                                                           <a name='3135'></font>
<font color=#447700>!          none                                                                <a name='3136'></font>
<font color=#447700>!----------------------------------------------------------------------        <a name='3137'></font>
      implicit none                                                     <a name='3138'>
<a name='3139'>
      integer  klev,klon,ktopm2                                                                         <a name='3140'>
      real     pten(klon,klev),        ptenh(klon,klev),          &amp;             <a name='3141'>
     &amp;         pqen(klon,klev),        pqsen(klon,klev),          &amp;             <a name='3142'>
     &amp;         pqenh(klon,klev),       pap(klon,klev),            &amp;             <a name='3143'>
     &amp;         paph(klon,klev+1),      pgeoh(klon,klev+1),        &amp;             <a name='3144'>
     &amp;         plglac(klon,klev)                                               <a name='3145'>
                                                                               <a name='3146'>
      real     pmfu(klon,klev),        pmfd(klon,klev),           &amp;             <a name='3147'>
     &amp;         pmfus(klon,klev),       pmfds(klon,klev),          &amp;             <a name='3148'>
     &amp;         pmfuq(klon,klev),       pmfdq(klon,klev),          &amp;             <a name='3149'>
     &amp;         pdmfup(klon,klev),      pdmfdp(klon,klev),         &amp;             <a name='3150'>
     &amp;         pdpmel(klon,klev),      prain(klon),               &amp;             <a name='3151'>
     &amp;         pmful(klon,klev),       plude(klon,klev),          &amp;             <a name='3152'>
     &amp;         pmflxr(klon,klev+1),    pmflxs(klon,klev+1)  <a name='3153'>
      real     pmfdde_rate(klon,klev)               <a name='3154'>
      integer  kcbot(klon),            kctop(klon),               &amp;             <a name='3155'>
     &amp;         kdtop(klon),            ktype(klon)                             <a name='3156'>
      logical  lddraf(klon),                                &amp;<a name='3157'>
     &amp;         ldcum(klon)  <a name='3158'>
      integer  lndj(klon)<a name='3159'>
<font color=#447700>! local variables<a name='3160'></font>
      integer  jl,jk<a name='3161'>
      integer  is,ik,icall,ike,ikb<a name='3162'>
      real     ztmst,ztaumel,zcons1a,zcons1,zcons2,zcucov,zcpecons<a name='3163'>
      real     zalfaw,zrfl,zdrfl1,zrnew,zrmin,zrfln,zdrfl,zdenom<a name='3164'>
      real     zpdr,zpds,zzp,zfac,zsnmlt<a name='3165'>
      real     rhevap(klon)<a name='3166'>
      integer  idbas(klon)<a name='3167'>
      logical  llddraf<a name='3168'>
<font color=#447700>!--------------------------------------------------------------------          <a name='3169'></font>
<font color=#447700>!*             specify constants  <a name='3170'></font>
<a name='3171'>
      ztaumel=18000.<a name='3172'>
      zcons1a=cpd/(alf*g*ztaumel)<a name='3173'>
      zcons2=3./(g*ztmst)<a name='3174'>
      zcucov=0.05<a name='3175'>
      zcpecons=5.44e-4/g<a name='3176'>
<a name='3177'>
<font color=#447700>!*    1.0          determine final convective fluxes                           <a name='3178'></font>
<font color=#447700>!                  ---------------------------------                           <a name='3179'></font>
      do jl=1,klon<a name='3180'>
        prain(jl)=0.<a name='3181'>
        if(.not.ldcum(jl).or.kdtop(jl).lt.kctop(jl)) lddraf(jl)=.false.<a name='3182'>
        if(.not.ldcum(jl)) ktype(jl)=0<a name='3183'>
        idbas(jl) = klev<a name='3184'>
        if(lndj(jl) .eq. 1) then<a name='3185'>
          rhevap(jl) = 0.7<a name='3186'>
        else<a name='3187'>
          rhevap(jl) = 0.9<a name='3188'>
        end if<a name='3189'>
      enddo<a name='3190'>
<a name='3191'>
      ktopm2= 2<a name='3192'>
      do jk=ktopm2,klev<a name='3193'>
        ikb = min(jk+1,klev)<a name='3194'>
        do jl=1,klon<a name='3195'>
          pmflxr(jl,jk) = 0.<a name='3196'>
          pmflxs(jl,jk) = 0.<a name='3197'>
          pdpmel(jl,jk) = 0.<a name='3198'>
          if(ldcum(jl).and.jk.ge.kctop(jl)) then<a name='3199'>
            pmfus(jl,jk)=pmfus(jl,jk)-pmfu(jl,jk)*           &amp;<a name='3200'>
     &amp;       (cpd*ptenh(jl,jk)+pgeoh(jl,jk))<a name='3201'>
            pmfuq(jl,jk)=pmfuq(jl,jk)-pmfu(jl,jk)*pqenh(jl,jk)<a name='3202'>
            plglac(jl,jk)=pmfu(jl,jk)*plglac(jl,jk)<a name='3203'>
            llddraf = lddraf(jl) .and. jk &gt;= kdtop(jl)<a name='3204'>
            if ( llddraf .and.jk.ge.kdtop(jl)) then<a name='3205'>
              pmfds(jl,jk) = pmfds(jl,jk)-pmfd(jl,jk) * &amp;<a name='3206'>
                           (cpd*ptenh(jl,jk)+pgeoh(jl,jk))<a name='3207'>
              pmfdq(jl,jk) = pmfdq(jl,jk)-pmfd(jl,jk)*pqenh(jl,jk)<a name='3208'>
            else<a name='3209'>
              pmfd(jl,jk) = 0.<a name='3210'>
              pmfds(jl,jk) = 0.<a name='3211'>
              pmfdq(jl,jk) = 0.<a name='3212'>
              pdmfdp(jl,jk-1) = 0.<a name='3213'>
            end if<a name='3214'>
            if ( llddraf .and. pmfd(jl,jk) &lt; 0. .and. &amp;<a name='3215'>
               abs(pmfd(jl,ikb)) &lt; 1.e-20 ) then<a name='3216'>
               idbas(jl) = jk<a name='3217'>
            end if<a name='3218'>
          else<a name='3219'>
            pmfu(jl,jk)=0.<a name='3220'>
            pmfd(jl,jk)=0.<a name='3221'>
            pmfus(jl,jk)=0.<a name='3222'>
            pmfds(jl,jk)=0.<a name='3223'>
            pmfuq(jl,jk)=0.<a name='3224'>
            pmfdq(jl,jk)=0.<a name='3225'>
            pmful(jl,jk)=0.<a name='3226'>
            plglac(jl,jk)=0.<a name='3227'>
            pdmfup(jl,jk-1)=0.<a name='3228'>
            pdmfdp(jl,jk-1)=0.<a name='3229'>
            plude(jl,jk-1)=0.<a name='3230'>
          endif<a name='3231'>
        enddo<a name='3232'>
      enddo<a name='3233'>
<a name='3234'>
      do jl=1,klon<a name='3235'>
        pmflxr(jl,klev+1) = 0.<a name='3236'>
        pmflxs(jl,klev+1) = 0.<a name='3237'>
      end do<a name='3238'>
      do jl=1,klon<a name='3239'>
        if(ldcum(jl)) then<a name='3240'>
          ikb=kcbot(jl)<a name='3241'>
          ik=ikb+1<a name='3242'>
          zzp=((paph(jl,klev+1)-paph(jl,ik))/                  &amp;<a name='3243'>
     &amp;     (paph(jl,klev+1)-paph(jl,ikb)))<a name='3244'>
          if(ktype(jl).eq.3) then<a name='3245'>
            zzp=zzp**2<a name='3246'>
          endif<a name='3247'>
          pmfu(jl,ik)=pmfu(jl,ikb)*zzp<a name='3248'>
          pmfus(jl,ik)=(pmfus(jl,ikb)-                         &amp;<a name='3249'>
     &amp;         foelhm(ptenh(jl,ikb))*pmful(jl,ikb))*zzp<a name='3250'>
          pmfuq(jl,ik)=(pmfuq(jl,ikb)+pmful(jl,ikb))*zzp<a name='3251'>
          pmful(jl,ik)=0.<a name='3252'>
        endif<a name='3253'>
      enddo<a name='3254'>
<a name='3255'>
      do jk=ktopm2,klev<a name='3256'>
        do jl=1,klon<a name='3257'>
          if(ldcum(jl).and.jk.gt.kcbot(jl)+1) then<a name='3258'>
            ikb=kcbot(jl)+1<a name='3259'>
            zzp=((paph(jl,klev+1)-paph(jl,jk))/                &amp;<a name='3260'>
     &amp;       (paph(jl,klev+1)-paph(jl,ikb)))<a name='3261'>
            if(ktype(jl).eq.3) then<a name='3262'>
              zzp=zzp**2<a name='3263'>
            endif<a name='3264'>
            pmfu(jl,jk)=pmfu(jl,ikb)*zzp<a name='3265'>
            pmfus(jl,jk)=pmfus(jl,ikb)*zzp<a name='3266'>
            pmfuq(jl,jk)=pmfuq(jl,ikb)*zzp<a name='3267'>
            pmful(jl,jk)=0.<a name='3268'>
          endif<a name='3269'>
          ik = idbas(jl)<a name='3270'>
          llddraf = lddraf(jl) .and. jk &gt; ik .and. ik &lt; klev<a name='3271'>
          if ( llddraf .and. ik == kcbot(jl)+1 ) then<a name='3272'>
           zzp = ((paph(jl,klev+1)-paph(jl,jk))/(paph(jl,klev+1)-paph(jl,ik)))<a name='3273'>
           if ( ktype(jl) == 3 ) zzp = zzp*zzp<a name='3274'>
            pmfd(jl,jk) = pmfd(jl,ik)*zzp<a name='3275'>
            pmfds(jl,jk) = pmfds(jl,ik)*zzp<a name='3276'>
            pmfdq(jl,jk) = pmfdq(jl,ik)*zzp<a name='3277'>
            pmfdde_rate(jl,jk) = -(pmfd(jl,jk-1)-pmfd(jl,jk))<a name='3278'>
           else if ( llddraf .and. ik /= kcbot(jl)+1 .and. jk == ik+1 ) then<a name='3279'>
            pmfdde_rate(jl,jk) = -(pmfd(jl,jk-1)-pmfd(jl,jk))<a name='3280'>
           end if<a name='3281'>
        enddo<a name='3282'>
      enddo<a name='3283'>
<font color=#447700>!*    2.            calculate rain/snow fall rates                             <a name='3284'></font>
<font color=#447700>!*                  calculate melting of snow                                  <a name='3285'></font>
<font color=#447700>!*                  calculate evaporation of precip                            <a name='3286'></font>
<font color=#447700>!                   -------------------------------                            <a name='3287'></font>
<a name='3288'>
        do jk=ktopm2,klev<a name='3289'>
        do jl=1,klon<a name='3290'>
          if(ldcum(jl) .and. jk &gt;=kctop(jl)-1 ) then<a name='3291'>
            prain(jl)=prain(jl)+pdmfup(jl,jk)<a name='3292'>
            if(pmflxs(jl,jk).gt.0..and.pten(jl,jk).gt.tmelt) then<a name='3293'>
              zcons1=zcons1a*(1.+0.5*(pten(jl,jk)-tmelt))<a name='3294'>
              zfac=zcons1*(paph(jl,jk+1)-paph(jl,jk))<a name='3295'>
              zsnmlt=min(pmflxs(jl,jk),zfac*(pten(jl,jk)-tmelt))<a name='3296'>
              pdpmel(jl,jk)=zsnmlt<a name='3297'>
              pqsen(jl,jk)=<A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEEWM'>foeewm</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUFLXN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEEWM_6">(pten(jl,jk)-zsnmlt/zfac)/pap(jl,jk)<a name='3298'>
            endif<a name='3299'>
            zalfaw=<A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEALFA'>foealfa</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUFLXN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEALFA_5">(pten(jl,jk))<a name='3300'>
          <font color=#447700>!<a name='3301'></font>
          <font color=#447700>! No liquid precipitation above melting level<a name='3302'></font>
          <font color=#447700>!<a name='3303'></font>
            if ( pten(jl,jk) &lt; tmelt .and. zalfaw &gt; 0. ) then<a name='3304'>
              plglac(jl,jk) = plglac(jl,jk)+zalfaw*(pdmfup(jl,jk)+pdmfdp(jl,jk))<a name='3305'>
              zalfaw = 0.<a name='3306'>
            end if<a name='3307'>
            pmflxr(jl,jk+1)=pmflxr(jl,jk)+zalfaw*               &amp;<a name='3308'>
     &amp;       (pdmfup(jl,jk)+pdmfdp(jl,jk))+pdpmel(jl,jk)<a name='3309'>
            pmflxs(jl,jk+1)=pmflxs(jl,jk)+(1.-zalfaw)*          &amp;<a name='3310'>
     &amp;       (pdmfup(jl,jk)+pdmfdp(jl,jk))-pdpmel(jl,jk)<a name='3311'>
            if(pmflxr(jl,jk+1)+pmflxs(jl,jk+1).lt.0.0) then<a name='3312'>
              pdmfdp(jl,jk)=-(pmflxr(jl,jk)+pmflxs(jl,jk)+pdmfup(jl,jk))<a name='3313'>
              pmflxr(jl,jk+1)=0.0<a name='3314'>
              pmflxs(jl,jk+1)=0.0<a name='3315'>
              pdpmel(jl,jk)  =0.0<a name='3316'>
            else if ( pmflxr(jl,jk+1) &lt; 0. ) then<a name='3317'>
              pmflxs(jl,jk+1) = pmflxs(jl,jk+1)+pmflxr(jl,jk+1)<a name='3318'>
              pmflxr(jl,jk+1) = 0.<a name='3319'>
            else if ( pmflxs(jl,jk+1) &lt; 0. ) then<a name='3320'>
              pmflxr(jl,jk+1) = pmflxr(jl,jk+1)+pmflxs(jl,jk+1)<a name='3321'>
              pmflxs(jl,jk+1) = 0.<a name='3322'>
            end if<a name='3323'>
          endif<a name='3324'>
        enddo<a name='3325'>
      enddo<a name='3326'>
      do jk=ktopm2,klev<a name='3327'>
        do jl=1,klon<a name='3328'>
          if(ldcum(jl).and.jk.ge.kcbot(jl)) then<a name='3329'>
            zrfl=pmflxr(jl,jk)+pmflxs(jl,jk)<a name='3330'>
            if(zrfl.gt.1.e-20) then<a name='3331'>
              zdrfl1=zcpecons*max(0.,pqsen(jl,jk)-pqen(jl,jk))*zcucov* &amp;<a name='3332'>
     &amp;         (sqrt(paph(jl,jk)/paph(jl,klev+1))/5.09e-3*             &amp;<a name='3333'>
     &amp;         zrfl/zcucov)**0.5777*                                   &amp;<a name='3334'>
     &amp;         (paph(jl,jk+1)-paph(jl,jk))<a name='3335'>
              zrnew=zrfl-zdrfl1<a name='3336'>
              zrmin=zrfl-zcucov*max(0.,rhevap(jl)*pqsen(jl,jk) &amp;<a name='3337'>
     &amp;              -pqen(jl,jk)) *zcons2*(paph(jl,jk+1)-paph(jl,jk))<a name='3338'>
              zrnew=max(zrnew,zrmin)<a name='3339'>
              zrfln=max(zrnew,0.)<a name='3340'>
              zdrfl=min(0.,zrfln-zrfl)<a name='3341'>
              zdenom=1./max(1.e-20,pmflxr(jl,jk)+pmflxs(jl,jk))<a name='3342'>
              zalfaw=<A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEALFA'>foealfa</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUFLXN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEALFA_6">(pten(jl,jk))<a name='3343'>
              if ( pten(jl,jk) &lt; tmelt ) zalfaw = 0.<a name='3344'>
              zpdr=zalfaw*pdmfdp(jl,jk)<a name='3345'>
              zpds=(1.-zalfaw)*pdmfdp(jl,jk)<a name='3346'>
              pmflxr(jl,jk+1)=pmflxr(jl,jk)+zpdr         &amp;<a name='3347'>
     &amp;         +pdpmel(jl,jk)+zdrfl*pmflxr(jl,jk)*zdenom<a name='3348'>
              pmflxs(jl,jk+1)=pmflxs(jl,jk)+zpds         &amp;<a name='3349'>
     &amp;         -pdpmel(jl,jk)+zdrfl*pmflxs(jl,jk)*zdenom<a name='3350'>
              pdmfup(jl,jk)=pdmfup(jl,jk)+zdrfl<a name='3351'>
              if ( pmflxr(jl,jk+1)+pmflxs(jl,jk+1) &lt; 0. ) then<a name='3352'>
                pdmfup(jl,jk) = pdmfup(jl,jk)-(pmflxr(jl,jk+1)+pmflxs(jl,jk+1))<a name='3353'>
                pmflxr(jl,jk+1) = 0.<a name='3354'>
                pmflxs(jl,jk+1) = 0.<a name='3355'>
                pdpmel(jl,jk)   = 0.<a name='3356'>
              else if ( pmflxr(jl,jk+1) &lt; 0. ) then<a name='3357'>
                pmflxs(jl,jk+1) = pmflxs(jl,jk+1)+pmflxr(jl,jk+1)<a name='3358'>
                pmflxr(jl,jk+1) = 0.<a name='3359'>
              else if ( pmflxs(jl,jk+1) &lt; 0. ) then<a name='3360'>
                pmflxr(jl,jk+1) = pmflxr(jl,jk+1)+pmflxs(jl,jk+1)<a name='3361'>
                pmflxs(jl,jk+1) = 0.<a name='3362'>
              end if<a name='3363'>
            else<a name='3364'>
              pmflxr(jl,jk+1)=0.0<a name='3365'>
              pmflxs(jl,jk+1)=0.0<a name='3366'>
              pdmfdp(jl,jk)=0.0<a name='3367'>
              pdpmel(jl,jk)=0.0<a name='3368'>
            endif<a name='3369'>
          endif<a name='3370'>
        enddo<a name='3371'>
      enddo<a name='3372'>
                                      <a name='3373'>
      return<a name='3374'>
      end subroutine cuflxn <a name='3375'>
<font color=#447700>!---------------------------------------------------------<a name='3376'></font>
<font color=#447700>!  level 3 souroutines  <a name='3377'></font>
<font color=#447700>!--------------------------------------------------------<a name='3378'></font>
<A NAME='CUDTDQN'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUDTDQN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3379'>
     <font color=#993300>subroutine </font><font color=#cc0000>cudtdqn</font>(klon,klev,ktopm2,kctop,kdtop,ldcum, &amp; <A href='../../call_to/CUDTDQN.html' TARGET='index'>1</A>,<A href='../../call_from/CUDTDQN.html' TARGET='index'>2</A><a name='3380'>
                     lddraf,ztmst,paph,pgeoh,pgeo,pten,ptenh,pqen,  &amp;<a name='3381'>
                     pqenh,pqsen,plglac,plude,pmfu,pmfd,pmfus,pmfds, &amp;<a name='3382'>
                     pmfuq,pmfdq,pmful,pdmfup,pdmfdp,pdpmel,ptent,ptenq,pcte)<a name='3383'>
    implicit none<a name='3384'>
    integer  klon,klev,ktopm2<a name='3385'>
    integer  kctop(klon),  kdtop(klon)<a name='3386'>
    logical  ldcum(klon),  lddraf(klon)<a name='3387'>
    real     ztmst<a name='3388'>
    real     paph(klon,klev+1), pgeoh(klon,klev+1)<a name='3389'>
    real     pgeo(klon,klev),   pten(klon,klev), &amp;<a name='3390'>
             pqen(klon,klev),   ptenh(klon,klev),&amp;<a name='3391'>
             pqenh(klon,klev),  pqsen(klon,klev),&amp;<a name='3392'>
             plglac(klon,klev), plude(klon,klev)<a name='3393'>
    real     pmfu(klon,klev),   pmfd(klon,klev),&amp;<a name='3394'>
             pmfus(klon,klev),  pmfds(klon,klev),&amp;<a name='3395'>
             pmfuq(klon,klev),  pmfdq(klon,klev),&amp;<a name='3396'>
             pmful(klon,klev),  pdmfup(klon,klev),&amp;<a name='3397'>
             pdpmel(klon,klev), pdmfdp(klon,klev)<a name='3398'>
    real     ptent(klon,klev),  ptenq(klon,klev)<a name='3399'>
    real     pcte(klon,klev)<a name='3400'>
<a name='3401'>
<font color=#447700>! local variables<a name='3402'></font>
    integer  jk , ik , jl<a name='3403'>
    real     zalv , zzp<a name='3404'>
    real     zdtdt(klon,klev) , zdqdt(klon,klev) , zdp(klon,klev)<a name='3405'>
    <font color=#447700>!*    1.0          SETUP AND INITIALIZATIONS<a name='3406'></font>
    <font color=#447700>! -------------------------<a name='3407'></font>
    do jk = 1 , klev<a name='3408'>
      do jl = 1, klon<a name='3409'>
        if ( ldcum(jl) ) then<a name='3410'>
          zdp(jl,jk) = g/(paph(jl,jk+1)-paph(jl,jk))<a name='3411'>
        end if<a name='3412'>
      end do<a name='3413'>
    end do<a name='3414'>
    <font color=#447700>!-----------------------------------------------------------------------<a name='3415'></font>
    <font color=#447700>!*    2.0          COMPUTE TENDENCIES<a name='3416'></font>
    <font color=#447700>! ------------------<a name='3417'></font>
    do jk = ktopm2 , klev<a name='3418'>
      if ( jk &lt; klev ) then<a name='3419'>
        do jl = 1,klon<a name='3420'>
          if ( ldcum(jl) ) then<a name='3421'>
            zalv = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOELHM'>foelhm</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUDTDQN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOELHM_1">(pten(jl,jk))<a name='3422'>
            zdtdt(jl,jk) = zdp(jl,jk)*rcpd * &amp;<a name='3423'>
              (pmfus(jl,jk+1)-pmfus(jl,jk)+pmfds(jl,jk+1) - &amp;<a name='3424'>
               pmfds(jl,jk)+alf*plglac(jl,jk)-alf*pdpmel(jl,jk) - &amp;<a name='3425'>
               zalv*(pmful(jl,jk+1)-pmful(jl,jk)-plude(jl,jk)-pdmfup(jl,jk)-pdmfdp(jl,jk)))<a name='3426'>
            zdqdt(jl,jk) = zdp(jl,jk)*(pmfuq(jl,jk+1) - &amp;<a name='3427'>
              pmfuq(jl,jk)+pmfdq(jl,jk+1)-pmfdq(jl,jk)+pmful(jl,jk+1) - &amp;<a name='3428'>
              pmful(jl,jk)-plude(jl,jk)-pdmfup(jl,jk)-pdmfdp(jl,jk))<a name='3429'>
          end if<a name='3430'>
        end do<a name='3431'>
      else<a name='3432'>
        do jl = 1,klon<a name='3433'>
          if ( ldcum(jl) ) then<a name='3434'>
            zalv = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOELHM'>foelhm</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUDTDQN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOELHM_2">(pten(jl,jk))<a name='3435'>
            zdtdt(jl,jk) = -zdp(jl,jk)*rcpd * &amp;<a name='3436'>
              (pmfus(jl,jk)+pmfds(jl,jk)+alf*pdpmel(jl,jk) - &amp;<a name='3437'>
               zalv*(pmful(jl,jk)+pdmfup(jl,jk)+pdmfdp(jl,jk)+plude(jl,jk)))<a name='3438'>
            zdqdt(jl,jk) = -zdp(jl,jk)*(pmfuq(jl,jk) + plude(jl,jk) + &amp;<a name='3439'>
              pmfdq(jl,jk)+(pmful(jl,jk)+pdmfup(jl,jk)+pdmfdp(jl,jk)))<a name='3440'>
          end if<a name='3441'>
        end do<a name='3442'>
      end if<a name='3443'>
    end do<a name='3444'>
  <font color=#447700>!---------------------------------------------------------------<a name='3445'></font>
  <font color=#447700>!*  3.0          UPDATE TENDENCIES<a name='3446'></font>
  <font color=#447700>!   -----------------<a name='3447'></font>
    do jk = ktopm2 , klev<a name='3448'>
     do jl = 1, klon<a name='3449'>
       if ( ldcum(jl) ) then<a name='3450'>
         ptent(jl,jk) = ptent(jl,jk) + zdtdt(jl,jk)<a name='3451'>
         ptenq(jl,jk) = ptenq(jl,jk) + zdqdt(jl,jk)<a name='3452'>
         pcte(jl,jk)  = zdp(jl,jk)*plude(jl,jk)<a name='3453'>
       end if<a name='3454'>
     end do<a name='3455'>
    end do<a name='3456'>
<a name='3457'>
    return<a name='3458'>
  end subroutine cudtdqn<a name='3459'>
<font color=#447700>!---------------------------------------------------------<a name='3460'></font>
<font color=#447700>!  level 3 souroutines  <a name='3461'></font>
<font color=#447700>!--------------------------------------------------------<a name='3462'></font>
<A NAME='CUDUDVN'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUDUDVN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3463'>
    <font color=#993300>subroutine </font><font color=#cc0000>cududvn</font>(klon,klev,ktopm2,ktype,kcbot,kctop,ldcum,  &amp; <A href='../../call_to/CUDUDVN.html' TARGET='index'>1</A><a name='3464'>
                    ztmst,paph,puen,pven,pmfu,pmfd,puu,pud,pvu,pvd,ptenu, &amp;<a name='3465'>
                    ptenv)<a name='3466'>
    implicit none<a name='3467'>
    integer  klon,klev,ktopm2<a name='3468'>
    integer  ktype(klon), kcbot(klon), kctop(klon)<a name='3469'>
    logical  ldcum(klon)<a name='3470'>
    real     ztmst<a name='3471'>
    real     paph(klon,klev+1)<a name='3472'>
    real     puen(klon,klev),  pven(klon,klev),&amp;<a name='3473'>
             pmfu(klon,klev),  pmfd(klon,klev),&amp;<a name='3474'>
             puu(klon,klev),   pud(klon,klev),&amp;<a name='3475'>
             pvu(klon,klev),   pvd(klon,klev)<a name='3476'>
    real     ptenu(klon,klev), ptenv(klon,klev)<a name='3477'>
<a name='3478'>
<font color=#447700>!local variables<a name='3479'></font>
    real     zuen(klon,klev) , zven(klon,klev) , zmfuu(klon,klev), &amp;<a name='3480'>
             zmfdu(klon,klev), zmfuv(klon,klev), zmfdv(klon,klev)<a name='3481'>
<a name='3482'>
    integer  ik , ikb , jk , jl<a name='3483'>
    real     zzp, zdtdt<a name='3484'>
   <a name='3485'>
    real     zdudt(klon,klev), zdvdt(klon,klev), zdp(klon,klev)<a name='3486'>
<font color=#447700>!<a name='3487'></font>
    do jk = 1 , klev<a name='3488'>
      do jl = 1, klon<a name='3489'>
        if ( ldcum(jl) ) then<a name='3490'>
          zuen(jl,jk) = puen(jl,jk)<a name='3491'>
          zven(jl,jk) = pven(jl,jk)<a name='3492'>
          zdp(jl,jk) = g/(paph(jl,jk+1)-paph(jl,jk))<a name='3493'>
        end if<a name='3494'>
      end do<a name='3495'>
    end do<a name='3496'>
<font color=#447700>!----------------------------------------------------------------------<a name='3497'></font>
<font color=#447700>!*    1.0          CALCULATE FLUXES AND UPDATE U AND V TENDENCIES<a name='3498'></font>
<font color=#447700>! ----------------------------------------------<a name='3499'></font>
    do jk = ktopm2 , klev<a name='3500'>
      ik = jk - 1<a name='3501'>
      do jl = 1,klon<a name='3502'>
        if ( ldcum(jl) ) then<a name='3503'>
          zmfuu(jl,jk) = pmfu(jl,jk)*(puu(jl,jk)-zuen(jl,ik))<a name='3504'>
          zmfuv(jl,jk) = pmfu(jl,jk)*(pvu(jl,jk)-zven(jl,ik))<a name='3505'>
          zmfdu(jl,jk) = pmfd(jl,jk)*(pud(jl,jk)-zuen(jl,ik))<a name='3506'>
          zmfdv(jl,jk) = pmfd(jl,jk)*(pvd(jl,jk)-zven(jl,ik))<a name='3507'>
        end if<a name='3508'>
      end do<a name='3509'>
    end do<a name='3510'>
    <font color=#447700>! linear fluxes below cloud<a name='3511'></font>
      do jk = ktopm2 , klev<a name='3512'>
        do jl = 1, klon<a name='3513'>
          if ( ldcum(jl) .and. jk &gt; kcbot(jl) ) then<a name='3514'>
            ikb = kcbot(jl)<a name='3515'>
            zzp = ((paph(jl,klev+1)-paph(jl,jk))/(paph(jl,klev+1)-paph(jl,ikb)))<a name='3516'>
            if ( ktype(jl) == 3 ) zzp = zzp*zzp<a name='3517'>
            zmfuu(jl,jk) = zmfuu(jl,ikb)*zzp<a name='3518'>
            zmfuv(jl,jk) = zmfuv(jl,ikb)*zzp<a name='3519'>
            zmfdu(jl,jk) = zmfdu(jl,ikb)*zzp<a name='3520'>
            zmfdv(jl,jk) = zmfdv(jl,ikb)*zzp<a name='3521'>
          end if<a name='3522'>
        end do<a name='3523'>
      end do<a name='3524'>
<font color=#447700>!----------------------------------------------------------------------<a name='3525'></font>
<font color=#447700>!*    2.0          COMPUTE TENDENCIES<a name='3526'></font>
<font color=#447700>! ------------------<a name='3527'></font>
    do jk = ktopm2 , klev<a name='3528'>
      if ( jk &lt; klev ) then<a name='3529'>
        ik = jk + 1<a name='3530'>
        do jl = 1,klon<a name='3531'>
          if ( ldcum(jl) ) then<a name='3532'>
            zdudt(jl,jk) = zdp(jl,jk) * &amp;<a name='3533'>
                          (zmfuu(jl,ik)-zmfuu(jl,jk)+zmfdu(jl,ik)-zmfdu(jl,jk))<a name='3534'>
            zdvdt(jl,jk) = zdp(jl,jk) * &amp;<a name='3535'>
                          (zmfuv(jl,ik)-zmfuv(jl,jk)+zmfdv(jl,ik)-zmfdv(jl,jk))<a name='3536'>
          end if<a name='3537'>
        end do<a name='3538'>
      else<a name='3539'>
        do jl = 1,klon<a name='3540'>
          if ( ldcum(jl) ) then<a name='3541'>
            zdudt(jl,jk) = -zdp(jl,jk)*(zmfuu(jl,jk)+zmfdu(jl,jk))<a name='3542'>
            zdvdt(jl,jk) = -zdp(jl,jk)*(zmfuv(jl,jk)+zmfdv(jl,jk))<a name='3543'>
          end if<a name='3544'>
        end do<a name='3545'>
      end if<a name='3546'>
    end do<a name='3547'>
<font color=#447700>!---------------------------------------------------------------------<a name='3548'></font>
<font color=#447700>!*  3.0        UPDATE TENDENCIES<a name='3549'></font>
<font color=#447700>!   -----------------<a name='3550'></font>
    do jk = ktopm2 , klev<a name='3551'>
      do jl = 1, klon<a name='3552'>
        if ( ldcum(jl) ) then<a name='3553'>
          ptenu(jl,jk) = ptenu(jl,jk) + zdudt(jl,jk)<a name='3554'>
          ptenv(jl,jk) = ptenv(jl,jk) + zdvdt(jl,jk)<a name='3555'>
        end if<a name='3556'>
      end do<a name='3557'>
    end do<a name='3558'>
<font color=#447700>!----------------------------------------------------------------------<a name='3559'></font>
    return<a name='3560'>
    end subroutine cududvn<a name='3561'>
<font color=#447700>!---------------------------------------------------------<a name='3562'></font>
<font color=#447700>!  level 3 souroutines  <a name='3563'></font>
<font color=#447700>!--------------------------------------------------------<a name='3564'></font>
<A NAME='CUADJTQN'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3565'>
      <font color=#993300>subroutine </font><font color=#cc0000>cuadjtqn</font>                 &amp;                                            <A href='../../call_to/CUADJTQN.html' TARGET='index'>6</A>,<A href='../../call_from/CUADJTQN.html' TARGET='index'>12</A><a name='3566'>
     &amp;    (klon, klev, kk, psp, pt, pq, ldflag,  kcall)                           <a name='3567'>
<font color=#447700>!          m.tiedtke         e.c.m.w.f.     12/89     <a name='3568'></font>
<font color=#447700>!          purpose.                                                                 <a name='3569'></font>
<font color=#447700>!          --------                                                                 <a name='3570'></font>
<font color=#447700>!          to produce t,q and l values for cloud ascent                             <a name='3571'></font>
                                                                                    <a name='3572'>
<font color=#447700>!          interface                                                                <a name='3573'></font>
<font color=#447700>!          ---------                                                                <a name='3574'></font>
<font color=#447700>!          this routine is called from subroutines:                                 <a name='3575'></font>
<font color=#447700>!              *cond*     (t and q at condensation level)                           <a name='3576'></font>
<font color=#447700>!              *cubase*   (t and q at condensation level)                           <a name='3577'></font>
<font color=#447700>!              *cuasc*    (t and q at cloud levels)                                 <a name='3578'></font>
<font color=#447700>!              *cuini*    (environmental t and qs values at half levels)            <a name='3579'></font>
<font color=#447700>!          input are unadjusted t and q values,                                     <a name='3580'></font>
<font color=#447700>!          it returns adjusted values of t and q                                    <a name='3581'></font>
                                                                                    <a name='3582'>
<font color=#447700>!     parameter     description                                   units             <a name='3583'></font>
<font color=#447700>!     ---------     -----------                                   -----             <a name='3584'></font>
<font color=#447700>!     input parameters (integer):                                                   <a name='3585'></font>
                                                                                    <a name='3586'>
<font color=#447700>!    *klon*         number of grid points per packet                                <a name='3587'></font>
<font color=#447700>!    *klev*         number of levels                                                <a name='3588'></font>
<font color=#447700>!    *kk*           level                                                           <a name='3589'></font>
<font color=#447700>!    *kcall*        defines calculation as                                          <a name='3590'></font>
<font color=#447700>!                      kcall=0  env. t and qs in*cuini*                             <a name='3591'></font>
<font color=#447700>!                      kcall=1  condensation in updrafts  (e.g. cubase, cuasc)      <a name='3592'></font>
<font color=#447700>!                      kcall=2  evaporation in downdrafts (e.g. cudlfs,cuddraf)     <a name='3593'></font>
<font color=#447700>!     input parameters (real):                                                      <a name='3594'></font>
                                                                                    <a name='3595'>
<font color=#447700>!    *psp*          pressure                                        pa              <a name='3596'></font>
                                                                                    <a name='3597'>
<font color=#447700>!     updated parameters (real):                                                    <a name='3598'></font>
                                                                                    <a name='3599'>
<font color=#447700>!    *pt*           temperature                                     k               <a name='3600'></font>
<font color=#447700>!    *pq*           specific humidity                             kg/kg             <a name='3601'></font>
<font color=#447700>!          externals                                                                <a name='3602'></font>
<font color=#447700>!          ---------                                                                <a name='3603'></font>
<font color=#447700>!          for condensation calculations.                                           <a name='3604'></font>
<font color=#447700>!          the tables are initialised in *suphec*.                                  <a name='3605'></font>
                                                                                    <a name='3606'>
<font color=#447700>!----------------------------------------------------------------------             <a name='3607'></font>
                                                                                    <a name='3608'>
      implicit none   <a name='3609'>
                 <a name='3610'>
      integer  klev,klon                                                                   <a name='3611'>
      real     pt(klon,klev),          pq(klon,klev),  &amp;                             <a name='3612'>
     &amp;         psp(klon)                                                            <a name='3613'>
      logical  ldflag(klon)                                                         <a name='3614'>
<font color=#447700>! local variables<a name='3615'></font>
      integer  jl,jk<a name='3616'>
      integer  isum,kcall,kk<a name='3617'>
      real     zqmax,zqsat,zcor,zqp,zcond,zcond1,zl,zi,zf<a name='3618'>
<font color=#447700>!----------------------------------------------------------------------             <a name='3619'></font>
<font color=#447700>!     1.           define constants                                                 <a name='3620'></font>
<font color=#447700>!                  ----------------                                                 <a name='3621'></font>
      zqmax=0.5  <a name='3622'>
                                                                                    <a name='3623'>
<font color=#447700>!     2.           calculate condensation and adjust t and q accordingly            <a name='3624'></font>
<font color=#447700>!                  -----------------------------------------------------            <a name='3625'></font>
                                                                                    <a name='3626'>
      if ( kcall == 1 ) then<a name='3627'>
      do jl = 1,klon<a name='3628'>
        if ( ldflag(jl) ) then<a name='3629'>
          zqp = 1./psp(jl)<a name='3630'>
          zl = 1./(pt(jl,kk)-c4les)<a name='3631'>
          zi = 1./(pt(jl,kk)-c4ies)<a name='3632'>
          zqsat = c2es*(foealfa(pt(jl,kk))*exp(c3les*(pt(jl,kk)-tmelt)*zl) + &amp;<a name='3633'>
                (1.-foealfa(pt(jl,kk)))*exp(c3ies*(pt(jl,kk)-tmelt)*zi))<a name='3634'>
          zqsat = zqsat*zqp<a name='3635'>
          zqsat = min(0.5,zqsat)<a name='3636'>
          zcor = 1. - vtmpc1*zqsat<a name='3637'>
          zf = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEALFA'>foealfa</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEALFA_7">(pt(jl,kk))*r5alvcp*zl**2 + &amp;<a name='3638'>
               (1.-foealfa(pt(jl,kk)))*r5alscp*zi**2<a name='3639'>
          zcond = (pq(jl,kk)*zcor**2-zqsat*zcor)/(zcor**2+zqsat*zf)<a name='3640'>
          if ( zcond &gt; 0. ) then<a name='3641'>
            pt(jl,kk) = pt(jl,kk) + foeldcpm(pt(jl,kk))*zcond<a name='3642'>
            pq(jl,kk) = <A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_4">(jl,kk) - zcond<a name='3643'>
            zl = 1./(pt(jl,kk)-c4les)<a name='3644'>
            zi = 1./(pt(jl,kk)-c4ies)<a name='3645'>
            zqsat = c2es*(foealfa(pt(jl,kk)) * &amp;<a name='3646'>
              exp(c3les*(pt(jl,kk)-tmelt)*zl)+(1.-foealfa(pt(jl,kk))) * &amp;<a name='3647'>
              exp(c3ies*(pt(jl,kk)-tmelt)*zi))<a name='3648'>
            zqsat = zqsat*zqp<a name='3649'>
            zqsat = min(0.5,zqsat)<a name='3650'>
            zcor = 1. - vtmpc1*zqsat<a name='3651'>
            zf = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEALFA'>foealfa</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEALFA_8">(pt(jl,kk))*r5alvcp*zl**2 + &amp;<a name='3652'>
                 (1.-foealfa(pt(jl,kk)))*r5alscp*zi**2<a name='3653'>
            zcond1 = (pq(jl,kk)*zcor**2-zqsat*zcor)/(zcor**2+zqsat*zf)<a name='3654'>
            if ( abs(zcond) &lt; 1.e-20 ) zcond1 = 0.<a name='3655'>
            pt(jl,kk) = pt(jl,kk) + foeldcpm(pt(jl,kk))*zcond1<a name='3656'>
            pq(jl,kk) = <A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_5">(jl,kk) - zcond1<a name='3657'>
          end if<a name='3658'>
        end if<a name='3659'>
      end do<a name='3660'>
      elseif ( kcall == 2 ) then<a name='3661'>
      do jl = 1,klon<a name='3662'>
        if ( ldflag(jl) ) then<a name='3663'>
          zqp = 1./psp(jl)<a name='3664'>
          zqsat = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEEWM'>foeewm</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEEWM_7">(pt(jl,kk))*zqp<a name='3665'>
          zqsat = min(0.5,zqsat)<a name='3666'>
          zcor = 1./(1.-vtmpc1*zqsat)<a name='3667'>
          zqsat = zqsat*zcor<a name='3668'>
          zcond = (pq(jl,kk)-zqsat)/(1.+zqsat*zcor*foedem(pt(jl,kk)))<a name='3669'>
          zcond = min(zcond,0.)<a name='3670'>
          pt(jl,kk) = pt(jl,kk) + foeldcpm(pt(jl,kk))*zcond<a name='3671'>
          pq(jl,kk) = <A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_6">(jl,kk) - zcond<a name='3672'>
          zqsat = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEEWM'>foeewm</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEEWM_8">(pt(jl,kk))*zqp<a name='3673'>
          zqsat = min(0.5,zqsat)<a name='3674'>
          zcor = 1./(1.-vtmpc1*zqsat)<a name='3675'>
          zqsat = zqsat*zcor<a name='3676'>
          zcond1 = (pq(jl,kk)-zqsat)/(1.+zqsat*zcor*foedem(pt(jl,kk)))<a name='3677'>
          if ( abs(zcond) &lt; 1.e-20 ) zcond1 = min(zcond1,0.)<a name='3678'>
          pt(jl,kk) = pt(jl,kk) + foeldcpm(pt(jl,kk))*zcond1<a name='3679'>
          pq(jl,kk) = <A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_7">(jl,kk) - zcond1<a name='3680'>
        end if<a name='3681'>
      end do<a name='3682'>
      else if ( kcall == 0 ) then<a name='3683'>
      do jl = 1,klon<a name='3684'>
        zqp = 1./psp(jl)<a name='3685'>
        zqsat = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEEWM'>foeewm</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEEWM_9">(pt(jl,kk))*zqp<a name='3686'>
        zqsat = min(0.5,zqsat)<a name='3687'>
        zcor = 1./(1.-vtmpc1*zqsat)<a name='3688'>
        zqsat = zqsat*zcor<a name='3689'>
        zcond1 = (pq(jl,kk)-zqsat)/(1.+zqsat*zcor*foedem(pt(jl,kk)))<a name='3690'>
        pt(jl,kk) = pt(jl,kk) + foeldcpm(pt(jl,kk))*zcond1<a name='3691'>
        pq(jl,kk) = <A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_8">(jl,kk) - zcond1<a name='3692'>
        zqsat = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEEWM'>foeewm</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEEWM_10">(pt(jl,kk))*zqp<a name='3693'>
        zqsat = min(0.5,zqsat)<a name='3694'>
        zcor = 1./(1.-vtmpc1*zqsat)<a name='3695'>
        zqsat = zqsat*zcor<a name='3696'>
        zcond1 = (pq(jl,kk)-zqsat)/(1.+zqsat*zcor*foedem(pt(jl,kk)))<a name='3697'>
        pt(jl,kk) = pt(jl,kk) + foeldcpm(pt(jl,kk))*zcond1<a name='3698'>
        pq(jl,kk) = <A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUADJTQN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_9">(jl,kk) - zcond1<a name='3699'>
      end do<a name='3700'>
      end if<a name='3701'>
<a name='3702'>
      return<a name='3703'>
      end subroutine cuadjtqn<a name='3704'>
<font color=#447700>!---------------------------------------------------------<a name='3705'></font>
<font color=#447700>!  level 4 souroutines  <a name='3706'></font>
<font color=#447700>!--------------------------------------------------------<a name='3707'></font>
<A NAME='CUBASMCN'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUBASMCN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3708'>
      <font color=#993300>subroutine </font><font color=#cc0000>cubasmcn</font> &amp; <A href='../../call_to/CUBASMCN.html' TARGET='index'>1</A><a name='3709'>
     &amp;    (klon,     klev,     klevm1,  kk,     pten,&amp;<a name='3710'>
     &amp;     pqen,     pqsen,    puen,    pven,   pverv,&amp;<a name='3711'>
     &amp;     pgeo,     pgeoh,    ldcum,   ktype,  klab,  plrain,&amp;<a name='3712'>
     &amp;     pmfu,     pmfub,    kcbot,   ptu,&amp;<a name='3713'>
     &amp;     pqu,      plu,      puu,     pvu,    pmfus,&amp;<a name='3714'>
     &amp;     pmfuq,    pmful,    pdmfup)<a name='3715'>
      implicit none<a name='3716'>
<font color=#447700>!      m.tiedtke         e.c.m.w.f.     12/89<a name='3717'></font>
<font color=#447700>!      c.zhang           iprc           05/2012<a name='3718'></font>
<font color=#447700>!***purpose.<a name='3719'></font>
<font color=#447700>!   --------<a name='3720'></font>
<font color=#447700>!          this routine calculates cloud base values<a name='3721'></font>
<font color=#447700>!          for midlevel convection<a name='3722'></font>
<font color=#447700>!***interface<a name='3723'></font>
<font color=#447700>!   ---------<a name='3724'></font>
<font color=#447700>!          this routine is called from *cuasc*.<a name='3725'></font>
<font color=#447700>!          input are environmental values t,q etc<a name='3726'></font>
<font color=#447700>!          it returns cloudbase values for midlevel convection<a name='3727'></font>
<font color=#447700>!***method.<a name='3728'></font>
<font color=#447700>!   -------<a name='3729'></font>
<font color=#447700>!          s. tiedtke (1989)<a name='3730'></font>
<font color=#447700>!***externals<a name='3731'></font>
<font color=#447700>!   ---------<a name='3732'></font>
<font color=#447700>!          none<a name='3733'></font>
<font color=#447700>! ----------------------------------------------------------------<a name='3734'></font>
      real     pten(klon,klev),        pqen(klon,klev),&amp;<a name='3735'>
     &amp;         puen(klon,klev),        pven(klon,klev),&amp;<a name='3736'>
     &amp;         pqsen(klon,klev),       pverv(klon,klev),&amp;<a name='3737'>
     &amp;         pgeo(klon,klev),        pgeoh(klon,klev+1)<a name='3738'>
      real     ptu(klon,klev),         pqu(klon,klev),&amp;<a name='3739'>
     &amp;         puu(klon,klev),         pvu(klon,klev),&amp;<a name='3740'>
     &amp;         plu(klon,klev),         pmfu(klon,klev),&amp;<a name='3741'>
     &amp;         pmfub(klon),   &amp;         <a name='3742'>
     &amp;         pmfus(klon,klev),       pmfuq(klon,klev),&amp;<a name='3743'>
     &amp;         pmful(klon,klev),       pdmfup(klon,klev),&amp;<a name='3744'>
     &amp;         plrain(klon,klev)<a name='3745'>
      integer  ktype(klon),            kcbot(klon),&amp;<a name='3746'>
     &amp;         klab(klon,klev)<a name='3747'>
      logical  ldcum(klon)<a name='3748'>
<font color=#447700>! local variabels<a name='3749'></font>
      integer  jl,kk,klev,klon,klevp1,klevm1<a name='3750'>
      real     zzzmb<a name='3751'>
<font color=#447700>!--------------------------------------------------------<a name='3752'></font>
<font color=#447700>!*    1.      calculate entrainment and detrainment rates<a name='3753'></font>
<font color=#447700>! -------------------------------------------------------<a name='3754'></font>
         do jl=1,klon<a name='3755'>
          if(.not.ldcum(jl) .and. klab(jl,kk+1).eq.0) then<a name='3756'>
            if(lmfmid .and. pqen(jl,kk) .gt. 0.80*pqsen(jl,kk).and. &amp;<a name='3757'>
              pgeo(jl,kk)*zrg .gt. 5.0e2  .and.  &amp;<a name='3758'>
     &amp;        pgeo(jl,kk)*zrg .lt. 1.0e4 )  then<a name='3759'>
            ptu(jl,kk+1)=(cpd*pten(jl,kk)+pgeo(jl,kk)-pgeoh(jl,kk+1))&amp;<a name='3760'>
     &amp;                          *rcpd<a name='3761'>
            pqu(jl,kk+1)=pqen(jl,kk)<a name='3762'>
            plu(jl,kk+1)=0.<a name='3763'>
            zzzmb=max(cmfcmin,-pverv(jl,kk)*zrg)<a name='3764'>
            zzzmb=min(zzzmb,cmfcmax)<a name='3765'>
            pmfub(jl)=zzzmb<a name='3766'>
            pmfu(jl,kk+1)=pmfub(jl)<a name='3767'>
            pmfus(jl,kk+1)=pmfub(jl)*(cpd*ptu(jl,kk+1)+pgeoh(jl,kk+1))<a name='3768'>
            pmfuq(jl,kk+1)=pmfub(jl)*pqu(jl,kk+1)<a name='3769'>
            pmful(jl,kk+1)=0.<a name='3770'>
            pdmfup(jl,kk+1)=0.<a name='3771'>
            kcbot(jl)=kk<a name='3772'>
            klab(jl,kk+1)=1<a name='3773'>
            plrain(jl,kk+1)=0.0<a name='3774'>
            ktype(jl)=3<a name='3775'>
          end if<a name='3776'>
         end if<a name='3777'>
        end do<a name='3778'>
      return<a name='3779'>
      end subroutine cubasmcn<a name='3780'>
<font color=#447700>!---------------------------------------------------------<a name='3781'></font>
<font color=#447700>!  level 4 souroutines  <a name='3782'></font>
<font color=#447700>!---------------------------------------------------------<a name='3783'></font>
<A NAME='CUENTRN'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#CUENTRN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3784'>
      <font color=#993300>subroutine </font><font color=#cc0000>cuentrn</font>(klon,klev,kk,kcbot,ldcum,ldwork, &amp; <A href='../../call_to/CUENTRN.html' TARGET='index'>1</A><a name='3785'>
                    pgeoh,pmfu,pdmfen,pdmfde)<a name='3786'>
       implicit none<a name='3787'>
       integer  klon,klev,kk<a name='3788'>
       integer  kcbot(klon)<a name='3789'>
       logical  ldcum(klon)<a name='3790'>
       logical  ldwork<a name='3791'>
       real  pgeoh(klon,klev+1)<a name='3792'>
       real  pmfu(klon,klev) <a name='3793'>
       real  pdmfen(klon) <a name='3794'>
       real  pdmfde(klon) <a name='3795'>
       logical  llo1<a name='3796'>
       integer  jl<a name='3797'>
       real  zdz , zmf<a name='3798'>
       real  zentr(klon)<a name='3799'>
    <font color=#447700>!<a name='3800'></font>
    <font color=#447700>!* 1. CALCULATE ENTRAINMENT AND DETRAINMENT RATES<a name='3801'></font>
    <font color=#447700>! -------------------------------------------<a name='3802'></font>
    if ( ldwork ) then<a name='3803'>
      do jl = 1,klon<a name='3804'>
        pdmfen(jl) = 0.<a name='3805'>
        pdmfde(jl) = 0.<a name='3806'>
        zentr(jl) = 0.<a name='3807'>
      end do<a name='3808'>
      <font color=#447700>!<a name='3809'></font>
      <font color=#447700>!*  1.1 SPECIFY ENTRAINMENT RATES<a name='3810'></font>
      <font color=#447700>!   -------------------------<a name='3811'></font>
      do jl = 1, klon<a name='3812'>
        if ( ldcum(jl) ) then<a name='3813'>
          zdz = (pgeoh(jl,kk)-pgeoh(jl,kk+1))*zrg<a name='3814'>
          zmf = pmfu(jl,kk+1)*zdz<a name='3815'>
          llo1 = kk &lt; kcbot(jl)<a name='3816'>
          if ( llo1 ) then<a name='3817'>
            pdmfen(jl) = zentr(jl)*zmf<a name='3818'>
            pdmfde(jl) = 0.75e-4*zmf<a name='3819'>
          end if<a name='3820'>
        end if<a name='3821'>
      end do<a name='3822'>
    end if<a name='3823'>
    end subroutine cuentrn<a name='3824'>
<font color=#447700>!--------------------------------------------------------<a name='3825'></font>
<font color=#447700>! external functions<a name='3826'></font>
<font color=#447700>!------------------------------------------------------<a name='3827'></font>
<A NAME='FOEALFA'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEALFA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3828'>
      real <font color=#993300>function </font><font color=#cc0000>foealfa</font>(tt) <A href='../../call_to/FOEALFA.html' TARGET='index'>11</A><a name='3829'>
<font color=#447700>!     foealfa is calculated to distinguish the three cases:<a name='3830'></font>
<font color=#447700>!<a name='3831'></font>
<font color=#447700>!                       foealfa=1            water phase<a name='3832'></font>
<font color=#447700>!                       foealfa=0            ice phase<a name='3833'></font>
<font color=#447700>!                       0 &lt; foealfa &lt; 1      mixed phase<a name='3834'></font>
<font color=#447700>!<a name='3835'></font>
<font color=#447700>!               input : tt = temperature<a name='3836'></font>
<font color=#447700>!<a name='3837'></font>
        implicit none<a name='3838'>
        real tt<a name='3839'>
         foealfa = min(1.,((max(rtice,min(rtwat,tt))-rtice) &amp;<a name='3840'>
     &amp;  /(rtwat-rtice))**2)<a name='3841'>
<a name='3842'>
        return<a name='3843'>
      end function foealfa<a name='3844'>
<a name='3845'>
<A NAME='FOELHM'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOELHM' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3846'>
      real <font color=#993300>function </font><font color=#cc0000>foelhm</font>(tt) <A href='../../call_to/FOELHM.html' TARGET='index'>2</A>,<A href='../../call_from/FOELHM.html' TARGET='index'>1</A><a name='3847'>
        implicit none<a name='3848'>
        real tt<a name='3849'>
        foelhm = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEALFA'>foealfa</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOELHM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEALFA_9">(tt)*alv + (1.-foealfa(tt))*als<a name='3850'>
      return<a name='3851'>
      end function foelhm<a name='3852'>
<a name='3853'>
<A NAME='FOEEWM'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEEWM' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3854'>
      real <font color=#993300>function </font><font color=#cc0000>foeewm</font>(tt) <A href='../../call_to/FOEEWM.html' TARGET='index'>10</A><a name='3855'>
        implicit none<a name='3856'>
        real tt<a name='3857'>
        foeewm  = c2es * &amp;<a name='3858'>
     &amp;     (foealfa(tt)*exp(c3les*(tt-tmelt)/(tt-c4les))+ &amp;<a name='3859'>
     &amp;     (1.-foealfa(tt))*exp(c3ies*(tt-tmelt)/(tt-c4ies)))<a name='3860'>
      return<a name='3861'>
      end function foeewm<a name='3862'>
<a name='3863'>
<A NAME='FOEDEM'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEDEM' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3864'>
      real <font color=#993300>function </font><font color=#cc0000>foedem</font>(tt),<A href='../../call_from/FOEDEM.html' TARGET='index'>1</A><a name='3865'>
        implicit none<a name='3866'>
        real tt<a name='3867'>
        foedem  = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEALFA'>foealfa</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEDEM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEALFA_10">(tt)*r5alvcp*(1./(tt-c4les)**2)+ &amp;<a name='3868'>
     &amp;              (1.-foealfa(tt))*r5alscp*(1./(tt-c4ies)**2)<a name='3869'>
      return<a name='3870'>
      end function foedem<a name='3871'>
<a name='3872'>
<A NAME='FOELDCPM'><A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOELDCPM' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3873'>
      real <font color=#993300>function </font><font color=#cc0000>foeldcpm</font>(tt),<A href='../../call_from/FOELDCPM.html' TARGET='index'>1</A><a name='3874'>
        implicit none<a name='3875'>
        real tt<a name='3876'>
        foeldcpm = <A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOEALFA'>foealfa</A><A href='../../html_code/phys/module_cu_ntiedtke.F.html#FOELDCPM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FOEALFA_11">(tt)*ralvdcp+ &amp;<a name='3877'>
     &amp;        (1.-foealfa(tt))*ralsdcp<a name='3878'>
      return<a name='3879'>
      end function  foeldcpm<a name='3880'>
<a name='3881'>
end module module_cu_ntiedtke<a name='3882'>
                                                                                         <a name='3883'>
</pre></body></html>