<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_SF_BEP'><A href='../../html_code/phys/module_sf_bep.F.html#MODULE_SF_BEP' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sf_bep</font> <A href='../../call_to/MODULE_SF_BEP.html' TARGET='index'>3</A><a name='3'>
<a name='4'>
<font color=#447700>!USE module_model_constants<a name='5'></font>
 USE <A href='../../html_code/phys/module_sf_urban.F.html#MODULE_SF_URBAN'>module_sf_urban</A><A href='../../html_code/phys/module_sf_bep.F.html#module_sf_bep.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_URBAN_2"><a name='6'>
<a name='7'>
<font color=#447700>! SGClarke 09/11/2008<a name='8'></font>
<font color=#447700>! Access urban_param.tbl values through calling urban_param_init in module_physics_init<a name='9'></font>
<font color=#447700>! for CASE (BEPSCHEME) select sf_urban_physics<a name='10'></font>
<font color=#447700>!<a name='11'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='12'></font>
<font color=#447700>!  Dimension for the array used in the BEP module<a name='13'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='14'></font>
<a name='15'>
      integer nurbm           <font color=#447700>! Maximum number of urban classes    <a name='16'></font>
      parameter (nurbm=3)<a name='17'>
<a name='18'>
      integer ndm             <font color=#447700>! Maximum number of street directions <a name='19'></font>
      parameter (ndm=2)<a name='20'>
<a name='21'>
      integer nz_um           <font color=#447700>! Maximum number of vertical levels in the urban grid<a name='22'></font>
      parameter(nz_um=18)<a name='23'>
<a name='24'>
      integer ng_u            <font color=#447700>! Number of grid levels in the ground<a name='25'></font>
      parameter (ng_u=10)<a name='26'>
      integer nwr_u            <font color=#447700>! Number of grid levels in the walls or roofs<a name='27'></font>
      parameter (nwr_u=10)<a name='28'>
<a name='29'>
      real dz_u                 <font color=#447700>! Urban grid resolution<a name='30'></font>
      parameter (dz_u=5.)<a name='31'>
<a name='32'>
<font color=#447700>! The change of ng_u, nwr_u should be done in agreement with the block data<a name='33'></font>
<font color=#447700>!  in the routine "surf_temp" <a name='34'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='35'></font>
<font color=#447700>!  Constant used in the BEP module<a name='36'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='37'></font>
           <a name='38'>
      real vk                 <font color=#447700>! von Karman constant<a name='39'></font>
      real g_u                  <font color=#447700>! Gravity acceleration<a name='40'></font>
      real pi                 <font color=#447700>!<a name='41'></font>
      real r                  <font color=#447700>! Perfect gas constant<a name='42'></font>
      real cp_u                 <font color=#447700>! Specific heat at constant pressure<a name='43'></font>
      real rcp_u                <font color=#447700>!<a name='44'></font>
      real sigma              <font color=#447700>!<a name='45'></font>
      real p0                 <font color=#447700>! Reference pressure at the sea level<a name='46'></font>
      real cdrag              <font color=#447700>! Drag force constant<a name='47'></font>
      parameter(vk=0.40,g_u=9.81,pi=3.141592653,r=287.,cp_u=1004.)        <a name='48'>
      parameter(rcp_u=r/cp_u,sigma=5.67e-08,p0=1.e+5,cdrag=0.4)<a name='49'>
<a name='50'>
<font color=#447700>! -----------------------------------------------------------------------     <a name='51'></font>
<a name='52'>
<a name='53'>
<a name='54'>
<a name='55'>
   CONTAINS<a name='56'>
 <a name='57'>
<A NAME='BEP'><A href='../../html_code/phys/module_sf_bep.F.html#BEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='58'>
      <font color=#993300>subroutine </font><font color=#cc0000>BEP</font>(FRC_URB2D,UTYPE_URB2D,itimestep,dz8w,dt,u_phy,v_phy,      &amp; <A href='../../call_to/BEP.html' TARGET='index'>2</A>,<A href='../../call_from/BEP.html' TARGET='index'>6</A><a name='59'>
                      th_phy,rho,p_phy,swdown,glw,                    &amp;<a name='60'>
                      gmt,julday,xlong,xlat,                          &amp;<a name='61'>
                      declin_urb,cosz_urb2d,omg_urb2d,                &amp;<a name='62'>
                      num_urban_layers,num_urban_hi,                  &amp;<a name='63'>
                      trb_urb4d,tw1_urb4d,tw2_urb4d,tgb_urb4d,        &amp;<a name='64'>
                      sfw1_urb3d,sfw2_urb3d,sfr_urb3d,sfg_urb3d,      &amp;<a name='65'>
                      lp_urb2d,hi_urb2d,lb_urb2d,hgt_urb2d,           &amp;<a name='66'>
                      a_u,a_v,a_t,a_e,b_u,b_v,                        &amp;<a name='67'>
                      b_t,b_e,b_q,dlg,dl_u,sf,vl,                     &amp;<a name='68'>
                      rl_up,rs_abs,emiss,grdflx_urb,                  &amp;<a name='69'>
                      ids,ide, jds,jde, kds,kde,                      &amp;<a name='70'>
                      ims,ime, jms,jme, kms,kme,                      &amp;<a name='71'>
                      its,ite, jts,jte, kts,kte)                    <a name='72'>
<a name='73'>
      implicit none<a name='74'>
<a name='75'>
<font color=#447700>!------------------------------------------------------------------------<a name='76'></font>
<font color=#447700>!     Input<a name='77'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='78'></font>
   INTEGER ::                       ids,ide, jds,jde, kds,kde,  &amp;<a name='79'>
                                    ims,ime, jms,jme, kms,kme,  &amp;<a name='80'>
                                    its,ite, jts,jte, kts,kte,  &amp;<a name='81'>
                                    itimestep<a name='82'>
 <a name='83'>
<a name='84'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   DZ8W<a name='85'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   P_PHY<a name='86'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   RHO<a name='87'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   TH_PHY<a name='88'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   T_PHY<a name='89'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   U_PHY<a name='90'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   V_PHY<a name='91'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   U<a name='92'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )::   V<a name='93'>
   REAL, DIMENSION( ims:ime , jms:jme )        ::   GLW<a name='94'>
   REAL, DIMENSION( ims:ime , jms:jme )        ::   swdown<a name='95'>
   REAL, DIMENSION( ims:ime, jms:jme )         ::   UST<a name='96'>
   INTEGER, DIMENSION( ims:ime , jms:jme ), INTENT(IN )::   UTYPE_URB2D<a name='97'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN )::   FRC_URB2D<a name='98'>
   REAL, INTENT(IN  )   ::                                   GMT <a name='99'>
   INTEGER, INTENT(IN  ) ::                               JULDAY<a name='100'>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='101'>
         INTENT(IN   )  ::                           XLAT, XLONG<a name='102'>
   REAL, INTENT(IN) :: DECLIN_URB<a name='103'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: COSZ_URB2D<a name='104'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: OMG_URB2D<a name='105'>
   INTEGER, INTENT(IN  ) :: num_urban_layers<a name='106'>
   INTEGER, INTENT(IN  ) :: num_urban_hi<a name='107'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: trb_urb4d<a name='108'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw1_urb4d<a name='109'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw2_urb4d<a name='110'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tgb_urb4d<a name='111'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfw1_urb3d<a name='112'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfw2_urb3d<a name='113'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfr_urb3d<a name='114'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfg_urb3d<a name='115'>
   REAL, DIMENSION( ims:ime, 1:num_urban_hi, jms:jme ), INTENT(IN) :: hi_urb2d<a name='116'>
   REAL, DIMENSION( ims:ime,jms:jme), INTENT(IN) :: lp_urb2d<a name='117'>
   REAL, DIMENSION( ims:ime,jms:jme), INTENT(IN) :: lb_urb2d<a name='118'>
   REAL, DIMENSION( ims:ime,jms:jme), INTENT(IN) :: hgt_urb2d<a name='119'>
<a name='120'>
<font color=#447700>!      integer nx,ny,nz              ! Number of points in the mesocsale grid<a name='121'></font>
      real z(ims:ime,kms:kme,jms:jme)            <font color=#447700>! Vertical coordinates<a name='122'></font>
      REAL, INTENT(IN )::   DT      <font color=#447700>! Time step<a name='123'></font>
<font color=#447700>!      real zr(ims:ime,jms:jme)                ! Solar zenith angle<a name='124'></font>
<font color=#447700>!      real deltar(ims:ime,jms:jme)            ! Declination of the sun<a name='125'></font>
<font color=#447700>!      real ah(ims:ime,jms:jme)                ! Hour angle<a name='126'></font>
<font color=#447700>!      real rs(ims:ime,jms:jme)                ! Solar radiation<a name='127'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='128'></font>
<font color=#447700>!     Output<a name='129'></font>
<font color=#447700>!------------------------------------------------------------------------ <a name='130'></font>
<font color=#447700>!      real tsk(ims:ime,jms:jme)           ! Average of surface temperatures (roads and roofs)<a name='131'></font>
<font color=#447700>!<a name='132'></font>
<font color=#447700>!    Implicit and explicit components of the source and sink terms at each levels,<a name='133'></font>
<font color=#447700>!     the fluxes can be computed as follow: FX = A*X + B   example: t_fluxes = a_t * pt + b_t<a name='134'></font>
      real a_u(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Implicit component for the momemtum in X-direction (center)<a name='135'></font>
      real a_v(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Implicit component for the momemtum in Y-direction (center)<a name='136'></font>
      real a_t(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Implicit component for the temperature<a name='137'></font>
      real a_e(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Implicit component for the TKE<a name='138'></font>
      real b_u(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Explicit component for the momemtum in X-direction (center)<a name='139'></font>
      real b_v(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Explicit component for the momemtum in Y-direction (center)<a name='140'></font>
      real b_t(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Explicit component for the temperature<a name='141'></font>
      real b_e(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Explicit component for the TKE<a name='142'></font>
      real b_q(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Explicit component for the humidity<a name='143'></font>
      real dlg(ims:ime,kms:kme,jms:jme)         <font color=#447700>! Height above ground (L_ground in formula (24) of the BLM paper). <a name='144'></font>
      real dl_u(ims:ime,kms:kme,jms:jme)        <font color=#447700>! Length scale (lb in formula (22) ofthe BLM paper).<a name='145'></font>
<font color=#447700>! urban surface and volumes        <a name='146'></font>
      real sf(ims:ime,kms:kme,jms:jme)           <font color=#447700>! surface of the urban grid cells<a name='147'></font>
      real vl(ims:ime,kms:kme,jms:jme)             <font color=#447700>! volume of the urban grid cells<a name='148'></font>
<font color=#447700>! urban fluxes<a name='149'></font>
      real rl_up(its:ite,jts:jte) <font color=#447700>! upward long wave radiation<a name='150'></font>
      real rs_abs(its:ite,jts:jte) <font color=#447700>! absorbed short wave radiation<a name='151'></font>
      real emiss(its:ite,jts:jte)  <font color=#447700>! emissivity averaged for urban surfaces<a name='152'></font>
      real grdflx_urb(its:ite,jts:jte)  <font color=#447700>! ground heat flux for urban areas<a name='153'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='154'></font>
<font color=#447700>!     Local<a name='155'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='156'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='157'></font>
<a name='158'>
      real hi_urb(its:ite,1:nz_um,jts:jte)    <font color=#447700>! Height histograms of buildings<a name='159'></font>
      real hi_urb1D(nz_um)                    <font color=#447700>! Height histograms of buildings<a name='160'></font>
      real hb_u(nz_um)                        <font color=#447700>! Bulding's heights<a name='161'></font>
      real ss_urb(nz_um)  <font color=#447700>! Probability that a building has an height equal to z<a name='162'></font>
      real pb_urb(nz_um)  <font color=#447700>! Probability that a building has an height greater or equal to z<a name='163'></font>
      integer nz_urb(nurbm)                   <font color=#447700>! Number of layer in the urban grid<a name='164'></font>
      integer nzurban(nurbm)                  <a name='165'>
<a name='166'>
<font color=#447700>!    Building parameters      <a name='167'></font>
      real alag_u(nurbm)                      <font color=#447700>! Ground thermal diffusivity [m^2 s^-1]<a name='168'></font>
      real alaw_u(nurbm)                      <font color=#447700>! Wall thermal diffusivity [m^2 s^-1]<a name='169'></font>
      real alar_u(nurbm)                      <font color=#447700>! Roof thermal diffusivity [m^2 s^-1]<a name='170'></font>
      real csg_u(nurbm)                       <font color=#447700>! Specific heat of the ground material [J m^3 K^-1]<a name='171'></font>
      real csw_u(nurbm)                       <font color=#447700>! Specific heat of the wall material [J m^3 K^-1]<a name='172'></font>
      real csr_u(nurbm)                       <font color=#447700>! Specific heat of the roof material [J m^3 K^-1]<a name='173'></font>
      real twini_u(nurbm)                     <font color=#447700>! Initial temperature inside the building's wall [K]<a name='174'></font>
      real trini_u(nurbm)                     <font color=#447700>! Initial temperature inside the building's roof [K]<a name='175'></font>
      real tgini_u(nurbm)                     <font color=#447700>! Initial road temperature<a name='176'></font>
<font color=#447700>!<a name='177'></font>
<font color=#447700>!   Building materials<a name='178'></font>
<font color=#447700>!<a name='179'></font>
      real csg(ng_u)                          <font color=#447700>! Specific heat of the ground material [J m^3 K^-1]<a name='180'></font>
      real csr(nwr_u)                         <font color=#447700>! Specific heat of the roof material [J m^3 K^-1]<a name='181'></font>
      real csw(nwr_u)                         <font color=#447700>! Specific heat of the wall material [J m^3 K^-1]<a name='182'></font>
      real alag(ng_u)                         <font color=#447700>! Ground thermal diffusivity [m^2 s^-1]<a name='183'></font>
      real alaw(nwr_u)                        <font color=#447700>! Wall thermal diffusivity [m^2 s^-1]<a name='184'></font>
      real alar(nwr_u)                        <font color=#447700>! Roof thermal diffusivity [m^2 s^-1]<a name='185'></font>
<font color=#447700>!<a name='186'></font>
<font color=#447700>! for twini_u, and trini_u the initial value at the deepest level is kept constant during the simulation<a name='187'></font>
<font color=#447700>!<a name='188'></font>
<font color=#447700>!    Radiation parameters<a name='189'></font>
      real albg_u(nurbm)                      <font color=#447700>! Albedo of the ground<a name='190'></font>
      real albw_u(nurbm)                      <font color=#447700>! Albedo of the wall<a name='191'></font>
      real albr_u(nurbm)                      <font color=#447700>! Albedo of the roof<a name='192'></font>
      real emg_u(nurbm)                       <font color=#447700>! Emissivity of ground<a name='193'></font>
      real emw_u(nurbm)                       <font color=#447700>! Emissivity of wall<a name='194'></font>
      real emr_u(nurbm)                       <font color=#447700>! Emissivity of roof<a name='195'></font>
<a name='196'>
<font color=#447700>!   fww_u,fwg_u,fgw_u,fsw_u,fsg_u are the view factors used to compute the long wave<a name='197'></font>
<font color=#447700>!   and the short wave radation. <a name='198'></font>
      real fww_u(nz_um,nz_um,ndm,nurbm)         <font color=#447700>!  from wall to wall<a name='199'></font>
      real fwg_u(nz_um,ndm,nurbm)               <font color=#447700>!  from wall to ground<a name='200'></font>
      real fgw_u(nz_um,ndm,nurbm)               <font color=#447700>!  from ground to wall<a name='201'></font>
      real fsw_u(nz_um,ndm,nurbm)               <font color=#447700>!  from sky to wall<a name='202'></font>
      real fws_u(nz_um,ndm,nurbm)               <font color=#447700>!  from sky to wall<a name='203'></font>
      real fsg_u(ndm,nurbm)                     <font color=#447700>!  from sky to ground<a name='204'></font>
<a name='205'>
<font color=#447700>!    Roughness parameters<a name='206'></font>
      real z0g_u(nurbm)         <font color=#447700>! The ground's roughness length<a name='207'></font>
      real z0r_u(nurbm)         <font color=#447700>! The roof's roughness length<a name='208'></font>
<a name='209'>
<font color=#447700>!    Roughness parameters<a name='210'></font>
      real z0(ndm,nz_um)           <font color=#447700>! Roughness lengths "profiles"<a name='211'></font>
<a name='212'>
<font color=#447700>!    Street parameters<a name='213'></font>
      integer nd_u(nurbm)       <font color=#447700>! Number of street direction for each urban class <a name='214'></font>
      real strd_u(ndm,nurbm)    <font color=#447700>! Street length (fix to greater value to the horizontal length of the cells)<a name='215'></font>
      real drst_u(ndm,nurbm)    <font color=#447700>! Street direction<a name='216'></font>
      real ws_u(ndm,nurbm)      <font color=#447700>! Street width<a name='217'></font>
      real bs_u(ndm,nurbm)      <font color=#447700>! Building width<a name='218'></font>
      real h_b(nz_um,nurbm)     <font color=#447700>! Bulding's heights<a name='219'></font>
      real d_b(nz_um,nurbm)     <font color=#447700>! Probability that a building has an height h_b<a name='220'></font>
      real ss_u(nz_um,nurbm)  <font color=#447700>! Probability that a building has an height equal to z<a name='221'></font>
      real pb_u(nz_um,nurbm)  <font color=#447700>! Probability that a building has an height greater or equal to z<a name='222'></font>
<font color=#447700>!<a name='223'></font>
<font color=#447700>!    Street parameters<a name='224'></font>
<font color=#447700>!<a name='225'></font>
      real bs(ndm)                 <font color=#447700>! Building width <a name='226'></font>
      real ws(ndm)                 <font color=#447700>! Street width<a name='227'></font>
      real drst(ndm)               <font color=#447700>! street directions <a name='228'></font>
      real strd(ndm)               <font color=#447700>! Street lengths <a name='229'></font>
      real ss(nz_um)               <font color=#447700>! Probability to have a building with height h<a name='230'></font>
      real pb(nz_um)               <font color=#447700>! Probability to have a building with an height equal<a name='231'></font>
<a name='232'>
<font color=#447700>!    Grid parameters<a name='233'></font>
<a name='234'>
      integer nz_u(nurbm)       <font color=#447700>! Number of layer in the urban grid<a name='235'></font>
      <a name='236'>
      real z_u(nz_um)         <font color=#447700>! Height of the urban grid levels<a name='237'></font>
<a name='238'>
<font color=#447700>! 1D array used for the input and output of the routine "urban"<a name='239'></font>
<a name='240'>
      real z1D(kms:kme)               <font color=#447700>! vertical coordinates<a name='241'></font>
      real ua1D(kms:kme)                <font color=#447700>! wind speed in the x directions<a name='242'></font>
      real va1D(kms:kme)                <font color=#447700>! wind speed in the y directions<a name='243'></font>
      real pt1D(kms:kme)                <font color=#447700>! potential temperature<a name='244'></font>
      real da1D(kms:kme)                <font color=#447700>! air density<a name='245'></font>
      real pr1D(kms:kme)                <font color=#447700>! air pressure<a name='246'></font>
      real pt01D(kms:kme)               <font color=#447700>! reference potential temperature<a name='247'></font>
      real zr1D                    <font color=#447700>! zenith angle<a name='248'></font>
      real deltar1D                <font color=#447700>! declination of the sun<a name='249'></font>
      real ah1D                    <font color=#447700>! hour angle (it should come from the radiation routine)<a name='250'></font>
      real rs1D                    <font color=#447700>! solar radiation<a name='251'></font>
      real rld1D                   <font color=#447700>! downward flux of the longwave radiation<a name='252'></font>
<a name='253'>
<a name='254'>
      real tw1D(2*ndm,nz_um,nwr_u)  <font color=#447700>! temperature in each layer of the wall<a name='255'></font>
      real tg1D(ndm,ng_u)          <font color=#447700>! temperature in each layer of the ground<a name='256'></font>
      real tr1D(ndm,nz_um,nwr_u)  <font color=#447700>! temperature in each layer of the roof<a name='257'></font>
      real sfw1D(2*ndm,nz_um)      <font color=#447700>! sensible heat flux from walls<a name='258'></font>
      real sfg1D(ndm)              <font color=#447700>! sensible heat flux from ground (road)<a name='259'></font>
      real sfr1D(ndm,nz_um)      <font color=#447700>! sensible heat flux from roofs<a name='260'></font>
      real sf1D(kms:kme)              <font color=#447700>! surface of the urban grid cells<a name='261'></font>
      real vl1D(kms:kme)                <font color=#447700>! volume of the urban grid cells<a name='262'></font>
      real a_u1D(kms:kme)               <font color=#447700>! Implicit component of the momentum sources or sinks in the X-direction<a name='263'></font>
      real a_v1D(kms:kme)               <font color=#447700>! Implicit component of the momentum sources or sinks in the Y-direction<a name='264'></font>
      real a_t1D(kms:kme)               <font color=#447700>! Implicit component of the heat sources or sinks<a name='265'></font>
      real a_e1D(kms:kme)               <font color=#447700>! Implicit component of the TKE sources or sinks<a name='266'></font>
      real b_u1D(kms:kme)               <font color=#447700>! Explicit component of the momentum sources or sinks in the X-direction<a name='267'></font>
      real b_v1D(kms:kme)               <font color=#447700>! Explicit component of the momentum sources or sinks in the Y-direction<a name='268'></font>
      real b_t1D(kms:kme)               <font color=#447700>! Explicit component of the heat sources or sinks<a name='269'></font>
      real b_e1D(kms:kme)               <font color=#447700>! Explicit component of the TKE sources or sinks<a name='270'></font>
      real dlg1D(kms:kme)               <font color=#447700>! Height above ground (L_ground in formula (24) of the BLM paper). <a name='271'></font>
      real dl_u1D(kms:kme)              <font color=#447700>! Length scale (lb in formula (22) ofthe BLM paper)<a name='272'></font>
      real time_bep<a name='273'>
<font color=#447700>! arrays used to collapse indexes<a name='274'></font>
      integer ind_zwd(nz_um,nwr_u,ndm)<a name='275'>
      integer ind_gd(ng_u,ndm)<a name='276'>
      integer ind_zd(nz_um,ndm)<a name='277'>
<font color=#447700>!<a name='278'></font>
      integer ix,iy,iz,iurb,id,iz_u,iw,ig,ir,ix1,iy1,k<a name='279'>
      integer it, nint<a name='280'>
      integer iii<a name='281'>
      real time_h,tempo<a name='282'>
      logical first<a name='283'>
      character(len=80) :: text<a name='284'>
      data first/.true./<a name='285'>
      save first,time_bep <a name='286'>
<a name='287'>
      save alag_u,alaw_u,alar_u,csg_u,csw_u,csr_u,                      &amp;<a name='288'>
           albg_u,albw_u,albr_u,emg_u,emw_u,emr_u,                      &amp;<a name='289'>
           z0g_u,z0r_u, nd_u,strd_u,drst_u,ws_u,bs_u,h_b,d_b,ss_u,pb_u, &amp;<a name='290'>
           nz_u,z_u <a name='291'>
<a name='292'>
<font color=#447700>!------------------------------------------------------------------------<a name='293'></font>
<font color=#447700>!    Calculation of the momentum, heat and turbulent kinetic fluxes<a name='294'></font>
<font color=#447700>!     produced by builgings<a name='295'></font>
<font color=#447700>!<a name='296'></font>
<font color=#447700>! Reference:<a name='297'></font>
<font color=#447700>! Martilli, A., Clappier, A., Rotach, M.W.:2002, 'AN URBAN SURFACE EXCHANGE<a name='298'></font>
<font color=#447700>! PARAMETERISATION FOR MESOSCALE MODELS', Boundary-Layer Meteorolgy 104:<a name='299'></font>
<font color=#447700>! 261-304<a name='300'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='301'></font>
<font color=#447700>!prepare the arrays to collapse indexes<a name='302'></font>
<a name='303'>
      if(num_urban_layers.lt.nz_um*ndm*nwr_u)then<a name='304'>
        write(*,*)'num_urban_layers too small, please increase to at least ', nz_um*ndm*nwr_u<a name='305'>
        stop<a name='306'>
      endif<a name='307'>
      iii=0<a name='308'>
      do iz_u=1,nz_um<a name='309'>
      do iw=1,nwr_u<a name='310'>
      do id=1,ndm<a name='311'>
       iii=iii+1<a name='312'>
       ind_zwd(iz_u,iw,id)=iii<a name='313'>
      enddo<a name='314'>
      enddo<a name='315'>
      enddo<a name='316'>
<a name='317'>
      iii=0<a name='318'>
      do ig=1,ng_u<a name='319'>
      do id=1,ndm<a name='320'>
       iii=iii+1<a name='321'>
       ind_gd(ig,id)=iii<a name='322'>
      enddo<a name='323'>
      enddo<a name='324'>
<a name='325'>
      iii=0<a name='326'>
      do iz_u=1,nz_um<a name='327'>
      do id=1,ndm<a name='328'>
       iii=iii+1<a name='329'>
       ind_zd(iz_u,id)=iii<a name='330'>
      enddo<a name='331'>
      enddo<a name='332'>
<a name='333'>
      if (num_urban_hi.ge.nz_um)then<a name='334'>
          write(*,*)'nz_um too small, please increase to at least ', num_urban_hi+1<a name='335'>
          stop         <a name='336'>
      endif<a name='337'>
<a name='338'>
      do ix=its,ite<a name='339'>
          do iy=jts,jte<a name='340'>
              do iz_u=1,nz_um<a name='341'>
                  hi_urb(ix,iz_u,iy)=0.<a name='342'>
              enddo<a name='343'>
          enddo<a name='344'>
      enddo<a name='345'>
      <a name='346'>
      do ix=its,ite<a name='347'>
      do iy=jts,jte<a name='348'>
       z(ix,kts,iy)=0.<a name='349'>
       do iz=kts+1,kte+1<a name='350'>
        z(ix,iz,iy)=z(ix,iz-1,iy)+dz8w(ix,iz-1,iy)<a name='351'>
       enddo <font color=#447700>!iz<a name='352'></font>
       do iz_u=1,num_urban_hi<a name='353'>
          hi_urb(ix,iz_u,iy)= hi_urb2d(ix,iz_u,iy)<a name='354'>
       enddo <font color=#447700>!iz_u<a name='355'></font>
      enddo<a name='356'>
      enddo<a name='357'>
<a name='358'>
<a name='359'>
      if (first) then                           <font color=#447700>! True only on first call<a name='360'></font>
         <a name='361'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INIT_PARA'>init_para</A><A href='../../html_code/phys/module_sf_bep.F.html#BEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_PARA_1">(alag_u,alaw_u,alar_u,csg_u,csw_u,csr_u,&amp;<a name='362'>
                twini_u,trini_u,tgini_u,albg_u,albw_u,albr_u,emg_u,emw_u,&amp;<a name='363'>
                emr_u,z0g_u,z0r_u,nd_u,strd_u,drst_u,ws_u,bs_u,h_b,d_b)<a name='364'>
<a name='365'>
<font color=#447700>!      Initialisation of the urban parameters and calculation of the view factors<a name='366'></font>
             <a name='367'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#ICBEP'>icBEP</A><A href='../../html_code/phys/module_sf_bep.F.html#BEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICBEP_1">(nd_u,h_b,d_b,ss_u,pb_u,nz_u,z_u)                                  <a name='368'>
          <a name='369'>
         first=.false.<a name='370'>
<a name='371'>
      endif <font color=#447700>! first<a name='372'></font>
<a name='373'>
      do ix=its,ite<a name='374'>
      do iy=jts,jte<a name='375'>
        if (FRC_URB2D(ix,iy).gt.0.) then    <font color=#447700>! Calling BEP only for existing urban classes.	<a name='376'></font>
           iurb=UTYPE_URB2D(ix,iy)<a name='377'>
<a name='378'>
           hi_urb1D=0.<a name='379'>
           do iz_u=1,nz_um<a name='380'>
              hi_urb1D(iz_u)=hi_urb(ix,iz_u,iy)<a name='381'>
           enddo<a name='382'>
<a name='383'>
           call <A href='../../html_code/phys/module_sf_bep_bem.F.html#ICBEPHI_XY'>icBEPHI_XY</A><A href='../../html_code/phys/module_sf_bep.F.html#BEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICBEPHI_XY_1">(hb_u,hi_urb1D,ss_urb,pb_urb,    &amp;<a name='384'>
                           nz_urb(iurb),z_u)<a name='385'>
           <a name='386'>
           call <A href='../../html_code/phys/module_sf_bep_bem.F.html#PARAM'>param</A><A href='../../html_code/phys/module_sf_bep.F.html#BEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PARAM_1">(iurb,nz_u(iurb),nz_urb(iurb),nzurban(iurb),    &amp;<a name='387'>
                      nd_u(iurb),csg_u,csg,alag_u,alag,csr_u,csr,    &amp;<a name='388'>
                      alar_u,alar,csw_u,csw,alaw_u,alaw,             &amp;<a name='389'>
                      ws_u,ws,bs_u,bs,z0g_u,z0r_u,z0,                &amp;<a name='390'>
                      strd_u,strd,drst_u,drst,ss_u,ss_urb,ss,pb_u,   &amp;<a name='391'>
                      pb_urb,pb,lp_urb2d(ix,iy),                     &amp;<a name='392'>
                      lb_urb2d(ix,iy),hgt_urb2d(ix,iy),FRC_URB2D(ix,iy))  <a name='393'>
<font color=#447700>!<a name='394'></font>
<font color=#447700>!We compute the view factors in the icBEP_XY routine<a name='395'></font>
<font color=#447700>!           <a name='396'></font>
         <a name='397'>
           call <A href='../../html_code/phys/module_sf_bep_bem.F.html#ICBEP_XY'>icBEP_XY</A><A href='../../html_code/phys/module_sf_bep.F.html#BEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICBEP_XY_1">(iurb,fww_u,fwg_u,fgw_u,fsw_u,fws_u,fsg_u,   &amp;<a name='398'>
                         nd_u(iurb),strd,ws,nzurban(iurb),z_u)   <a name='399'>
<a name='400'>
       do iz= kts,kte<a name='401'>
          ua1D(iz)=u_phy(ix,iz,iy)<a name='402'>
          va1D(iz)=v_phy(ix,iz,iy)<a name='403'>
	  pt1D(iz)=th_phy(ix,iz,iy)<a name='404'>
	  da1D(iz)=rho(ix,iz,iy)<a name='405'>
	  pr1D(iz)=p_phy(ix,iz,iy)<a name='406'>
<font color=#447700>!	  pt01D(iz)=th_phy(ix,iz,iy)<a name='407'></font>
	  pt01D(iz)=300.<a name='408'>
	  z1D(iz)=z(ix,iz,iy)<a name='409'>
          a_u1D(iz)=0.<a name='410'>
          a_v1D(iz)=0.<a name='411'>
          a_t1D(iz)=0.<a name='412'>
          a_e1D(iz)=0.<a name='413'>
          b_u1D(iz)=0.<a name='414'>
          b_v1D(iz)=0.<a name='415'>
          b_t1D(iz)=0.<a name='416'>
          b_e1D(iz)=0.           <a name='417'>
         enddo<a name='418'>
	 z1D(kte+1)=z(ix,kte+1,iy)<a name='419'>
<a name='420'>
         do id=1,ndm<a name='421'>
         do iz_u=1,nz_um<a name='422'>
         do iw=1,nwr_u<a name='423'>
<font color=#447700>!          tw1D(2*id-1,iz_u,iw)=tw1_u(ix,iy,ind_zwd(iz_u,iw,id))<a name='424'></font>
<font color=#447700>!          tw1D(2*id,iz_u,iw)=tw2_u(ix,iy,ind_zwd(iz_u,iw,id))<a name='425'></font>
            if(ind_zwd(iz_u,iw,id).gt.num_urban_layers)write(*,*)'ind_zwd too big w',ind_zwd(iz_u,iw,id)<a name='426'>
          tw1D(2*id-1,iz_u,iw)=tw1_urb4d(ix,ind_zwd(iz_u,iw,id),iy)<a name='427'>
          tw1D(2*id,iz_u,iw)=tw2_urb4d(ix,ind_zwd(iz_u,iw,id),iy)<a name='428'>
         enddo<a name='429'>
         enddo<a name='430'>
         enddo<a name='431'>
	<a name='432'>
         do id=1,ndm<a name='433'>
          do ig=1,ng_u<a name='434'>
<font color=#447700>!           tg1D(id,ig)=tg_u(ix,iy,ind_gd(ig,id))<a name='435'></font>
            tg1D(id,ig)=tgb_urb4d(ix,ind_gd(ig,id),iy)<a name='436'>
          enddo<a name='437'>
          do iz_u=1,nz_um<a name='438'>
          do ir=1,nwr_u<a name='439'>
<font color=#447700>!           tr1D(id,iz_u,ir)=tr_u(ix,iy,ind_zwd(iz_u,ir,id))<a name='440'></font>
            if(ind_zwd(iz_u,ir,id).gt.num_urban_layers)write(*,*)'ind_zwd too big r',ind_zwd(iz_u,ir,id)<a name='441'>
            tr1D(id,iz_u,ir)=trb_urb4d(ix,ind_zwd(iz_u,ir,id),iy)<a name='442'>
          enddo<a name='443'>
          enddo<a name='444'>
         enddo<a name='445'>
<a name='446'>
         do id=1,ndm<a name='447'>
	 do iz=1,nz_um<a name='448'>
<font color=#447700>!	  sfw1D(2*id-1,iz)=sfw1(ix,iy,ind_zd(iz,id))<a name='449'></font>
<font color=#447700>!	  sfw1D(2*id,iz)=sfw2(ix,iy,ind_zd(iz,id))<a name='450'></font>
	  sfw1D(2*id-1,iz)=sfw1_urb3d(ix,ind_zd(iz,id),iy)<a name='451'>
	  sfw1D(2*id,iz)=sfw2_urb3d(ix,ind_zd(iz,id),iy)<a name='452'>
	 enddo<a name='453'>
	 enddo<a name='454'>
	 <a name='455'>
	 do id=1,ndm<a name='456'>
<font color=#447700>!	  sfg1D(id)=sfg(ix,iy,id)<a name='457'></font>
	  sfg1D(id)=sfg_urb3d(ix,id,iy)<a name='458'>
	 enddo<a name='459'>
	 <a name='460'>
	 do id=1,ndm<a name='461'>
	 do iz=1,nz_um<a name='462'>
<font color=#447700>!	  sfr1D(id,iz)=sfr(ix,iy,ind_zd(iz,id))<a name='463'></font>
	  sfr1D(id,iz)=sfr_urb3d(ix,ind_zd(iz,id),iy)<a name='464'>
	 enddo<a name='465'>
	 enddo<a name='466'>
<a name='467'>
         <a name='468'>
         rs1D=swdown(ix,iy)<a name='469'>
         rld1D=glw(ix,iy)<a name='470'>
         time_h=(itimestep*dt)/3600.+gmt<a name='471'>
<a name='472'>
         zr1D=acos(COSZ_URB2D(ix,iy))<a name='473'>
         deltar1D=DECLIN_URB<a name='474'>
         ah1D=OMG_URB2D(ix,iy)<a name='475'>
<font color=#447700>!	 call angle(xlong(ix,iy),xlat(ix,iy),julday,time_h,zr1D,deltar1D,ah1D)<a name='476'></font>
<font color=#447700>!        write(*,*) 'entro en BEP1D'<a name='477'></font>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D'>BEP1D</A><A href='../../html_code/phys/module_sf_bep.F.html#BEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BEP1D_1">(iurb,kms,kme,kts,kte,z1D,dt,ua1D,va1D,pt1D,da1D,pr1D,pt01D,  &amp;<a name='478'>
                   zr1D,deltar1D,ah1D,rs1D,rld1D,                   &amp; <a name='479'>
                   alag,alaw,alar,csg,csw,csr,                      &amp; <a name='480'>
                   albg_u(iurb),albw_u(iurb),albr_u(iurb),          &amp;<a name='481'>
                   emg_u(iurb),emw_u(iurb),emr_u(iurb),             &amp; <a name='482'>
                   fww_u,fwg_u,fgw_u,fsw_u,                         &amp;                    <a name='483'>
                   fws_u,fsg_u,z0,                                  &amp;                               <a name='484'>
                   nd_u(iurb),strd,drst,ws,bs,ss,pb,                &amp; <a name='485'>
                   nzurban(iurb),z_u,                               &amp; <a name='486'>
                   tw1D,tg1D,tr1D,sfw1D,sfg1D,sfr1D,                &amp; <a name='487'>
                   a_u1D,a_v1D,a_t1D,a_e1D,                         &amp; <a name='488'>
                   b_u1D,b_v1D,b_t1D,b_e1D,                         &amp; <a name='489'>
                   dlg1D,dl_u1D,sf1D,vl1D,rl_up(ix,iy),             &amp;<a name='490'>
                   rs_abs(ix,iy),emiss(ix,iy),grdflx_urb(ix,iy))                            <a name='491'>
<font color=#447700>!        write(*,*) 'salgo de BEP1D'<a name='492'></font>
         do id=1,ndm<a name='493'>
	 do iz=1,nz_um<a name='494'>
	  sfw1_urb3d(ix,ind_zd(iz,id),iy)=sfw1D(2*id-1,iz) <a name='495'>
	  sfw2_urb3d(ix,ind_zd(iz,id),iy)=sfw1D(2*id,iz) <a name='496'>
	 enddo<a name='497'>
	 enddo<a name='498'>
 <a name='499'>
	 do id=1,ndm<a name='500'>
	  sfg_urb3d(ix,id,iy)=sfg1D(id) <a name='501'>
	 enddo<a name='502'>
	<a name='503'>
	 do id=1,ndm<a name='504'>
	 do iz=1,nz_um<a name='505'>
	  sfr_urb3d(ix,ind_zd(iz,id),iy)=sfr1D(id,iz)<a name='506'>
	 enddo<a name='507'>
	 enddo<a name='508'>
<font color=#447700>!<a name='509'></font>
         do id=1,ndm<a name='510'>
         do iz_u=1,nz_um<a name='511'>
         do iw=1,nwr_u<a name='512'>
          tw1_urb4d(ix,ind_zwd(iz_u,iw,id),iy)=tw1D(2*id-1,iz_u,iw)<a name='513'>
          tw2_urb4d(ix,ind_zwd(iz_u,iw,id),iy)=tw1D(2*id,iz_u,iw)<a name='514'>
         enddo<a name='515'>
         enddo<a name='516'>
         enddo<a name='517'>
        <a name='518'>
         do id=1,ndm<a name='519'>
          do ig=1,ng_u<a name='520'>
           tgb_urb4d(ix,ind_gd(ig,id),iy)=tg1D(id,ig)<a name='521'>
          enddo<a name='522'>
          do iz_u=1,nz_um<a name='523'>
          do ir=1,nwr_u<a name='524'>
           trb_urb4d(ix,ind_zwd(iz_u,ir,id),iy)=tr1D(id,iz_u,ir)<a name='525'>
          enddo<a name='526'>
          enddo<a name='527'>
         enddo<a name='528'>
        <a name='529'>
          sf(ix,kts:kte,iy)=0.<a name='530'>
          vl(ix,kts:kte,iy)=0.<a name='531'>
          a_u(ix,kts:kte,iy)=0.<a name='532'>
          a_v(ix,kts:kte,iy)=0.<a name='533'>
          a_t(ix,kts:kte,iy)=0.<a name='534'>
          a_e(ix,kts:kte,iy)=0.<a name='535'>
          b_u(ix,kts:kte,iy)=0.<a name='536'>
          b_v(ix,kts:kte,iy)=0.<a name='537'>
          b_t(ix,kts:kte,iy)=0.<a name='538'>
          b_e(ix,kts:kte,iy)=0.<a name='539'>
          b_q(ix,kts:kte,iy)=0.<a name='540'>
          dlg(ix,kts:kte,iy)=0.<a name='541'>
          dl_u(ix,kts:kte,iy)=0.<a name='542'>
<a name='543'>
        do iz= kts,kte<a name='544'>
          sf(ix,iz,iy)=sf1D(iz)<a name='545'>
          vl(ix,iz,iy)=vl1D(iz)<a name='546'>
          a_u(ix,iz,iy)=a_u1D(iz)<a name='547'>
          a_v(ix,iz,iy)=a_v1D(iz)<a name='548'>
          a_t(ix,iz,iy)=a_t1D(iz)<a name='549'>
          a_e(ix,iz,iy)=a_e1D(iz)<a name='550'>
          b_u(ix,iz,iy)=b_u1D(iz)<a name='551'>
          b_v(ix,iz,iy)=b_v1D(iz)<a name='552'>
          b_t(ix,iz,iy)=b_t1D(iz)<a name='553'>
          b_e(ix,iz,iy)=b_e1D(iz)<a name='554'>
          dlg(ix,iz,iy)=dlg1D(iz)<a name='555'>
          dl_u(ix,iz,iy)=dl_u1D(iz)<a name='556'>
         enddo<a name='557'>
         sf(ix,kte+1,iy)=sf1D(kte+1)<a name='558'>
<font color=#447700>!<a name='559'></font>
         endif <font color=#447700>! FRC_URB2D<a name='560'></font>
   <a name='561'>
      enddo  <font color=#447700>! iy<a name='562'></font>
      enddo  <font color=#447700>! ix<a name='563'></font>
<a name='564'>
<a name='565'>
        time_bep=time_bep+dt<a name='566'>
         <a name='567'>
         <a name='568'>
      return<a name='569'>
      end subroutine BEP<a name='570'>
            <a name='571'>
<font color=#447700>! ===6=8===============================================================72<a name='572'></font>
<a name='573'>
<A NAME='BEP1D'><A href='../../html_code/phys/module_sf_bep.F.html#BEP1D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='574'>
      <font color=#993300>subroutine </font><font color=#cc0000>BEP1D</font>(iurb,kms,kme,kts,kte,z,dt,ua,va,pt,da,pr,pt0,  &amp;   <A href='../../call_to/BEP1D.html' TARGET='index'>2</A>,<A href='../../call_from/BEP1D.html' TARGET='index'>27</A><a name='575'>
                      zr,deltar,ah,rs,rld,                            &amp; <a name='576'>
                      alag,alaw,alar,csg,csw,csr,                     &amp; <a name='577'>
                      albg,albw,albr,emg,emw,emr,                     &amp; <a name='578'>
                      fww,fwg,fgw,fsw,fws,fsg,z0,                     &amp;                                             <a name='579'>
                      ndu,strd,drst,ws,bs,ss,pb,                      &amp; <a name='580'>
                      nzu,z_u,                                        &amp; <a name='581'>
                      tw,tg,tr,sfw,sfg,sfr,                           &amp; <a name='582'>
                      a_u,a_v,a_t,a_e,                                &amp;<a name='583'>
                      b_u,b_v,b_t,b_e,                                &amp; <a name='584'>
                      dlg,dl_u,sf,vl,rl_up,rs_abs,emiss,grdflx_urb)                             <a name='585'>
<a name='586'>
<font color=#447700>! ----------------------------------------------------------------------<a name='587'></font>
<font color=#447700>! This routine computes the effects of buildings on momentum, heat and<a name='588'></font>
<font color=#447700>!  TKE (turbulent kinetic energy) sources or sinks and on the mixing length.<a name='589'></font>
<font color=#447700>! It provides momentum, heat and TKE sources or sinks at different levels of a<a name='590'></font>
<font color=#447700>!  mesoscale grid defined by the altitude of its cell interfaces "z" and<a name='591'></font>
<font color=#447700>!  its number of levels "nz".<a name='592'></font>
<font color=#447700>! The meteorological input parameters (wind, temperature, solar radiation)<a name='593'></font>
<font color=#447700>!  are specified on the "mesoscale grid".<a name='594'></font>
<font color=#447700>! The inputs concerning the building and street charateristics are defined<a name='595'></font>
<font color=#447700>!  on a "urban grid". The "urban grid" is defined with its number of levels<a name='596'></font>
<font color=#447700>!  "nz_u" and its space step "dz_u".<a name='597'></font>
<font color=#447700>! The input parameters are interpolated on the "urban grid". The sources or sinks<a name='598'></font>
<font color=#447700>!  are calculated on the "urban grid". Finally the sources or sinks are <a name='599'></font>
<font color=#447700>!  interpolated on the "mesoscale grid".<a name='600'></font>
 <a name='601'>
<a name='602'>
<font color=#447700>!  Mesoscale grid            Urban grid             Mesoscale grid<a name='603'></font>
<font color=#447700>!  <a name='604'></font>
<font color=#447700>! z(4)    ---                                               ---<a name='605'></font>
<font color=#447700>!          |                                                 |<a name='606'></font>
<font color=#447700>!          |                                                 |<a name='607'></font>
<font color=#447700>!          |   Interpolation                  Interpolation  |<a name='608'></font>
<font color=#447700>!          |            Sources or sinks calculation         |<a name='609'></font>
<font color=#447700>! z(3)    ---                                               ---<a name='610'></font>
<font color=#447700>!          | ua               ua_u  ---  uv_a         a_u    |<a name='611'></font>
<font color=#447700>!          | va               va_u   |   uv_b         b_u    |<a name='612'></font>
<font color=#447700>!          | pt               pt_u  ---  uh_b         a_v    |<a name='613'></font>
<font color=#447700>! z(2)    ---                        |    etc...      etc...---<a name='614'></font>
<font color=#447700>!          |                 z_u(1) ---                      |<a name='615'></font>
<font color=#447700>!          |                         |                       |<a name='616'></font>
<font color=#447700>! z(1) ------------------------------------------------------------<a name='617'></font>
<a name='618'>
<font color=#447700>!     <a name='619'></font>
<font color=#447700>! Reference:<a name='620'></font>
<font color=#447700>! Martilli, A., Clappier, A., Rotach, M.W.:2002, 'AN URBAN SURFACE EXCHANGE<a name='621'></font>
<font color=#447700>! PARAMETERISATION FOR MESOSCALE MODELS', Boundary-Layer Meteorolgy 104:<a name='622'></font>
<font color=#447700>! 261-304<a name='623'></font>
 <a name='624'>
<font color=#447700>! ----------------------------------------------------------------------<a name='625'></font>
<a name='626'>
      implicit none<a name='627'>
<a name='628'>
 <a name='629'>
<a name='630'>
<font color=#447700>! ----------------------------------------------------------------------<a name='631'></font>
<font color=#447700>! INPUT:<a name='632'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='633'></font>
<a name='634'>
<font color=#447700>! Data relative to the "mesoscale grid"<a name='635'></font>
<a name='636'>
<font color=#447700>!      integer nz                 ! Number of vertical levels<a name='637'></font>
      integer kms,kme,kts,kte<a name='638'>
      real z(kms:kme)               <font color=#447700>! Altitude above the ground of the cell interfaces.<a name='639'></font>
      real ua(kms:kme)                <font color=#447700>! Wind speed in the x direction<a name='640'></font>
      real va(kms:kme)                <font color=#447700>! Wind speed in the y direction<a name='641'></font>
      real pt(kms:kme)                <font color=#447700>! Potential temperature<a name='642'></font>
      real da(kms:kme)                <font color=#447700>! Air density<a name='643'></font>
      real pr(kms:kme)                <font color=#447700>! Air pressure<a name='644'></font>
      real pt0(kms:kme)               <font color=#447700>! Reference potential temperature (could be equal to "pt")<a name='645'></font>
      real dt                    <font color=#447700>! Time step<a name='646'></font>
      real zr                    <font color=#447700>! Zenith angle<a name='647'></font>
      real deltar                <font color=#447700>! Declination of the sun<a name='648'></font>
      real ah                    <font color=#447700>! Hour angle<a name='649'></font>
      real rs                    <font color=#447700>! Solar radiation<a name='650'></font>
      real rld                   <font color=#447700>! Downward flux of the longwave radiation<a name='651'></font>
<a name='652'>
<font color=#447700>! Data relative to the "urban grid"<a name='653'></font>
<a name='654'>
      integer iurb               <font color=#447700>! Current urban class<a name='655'></font>
<a name='656'>
<font color=#447700>!    Building parameters      <a name='657'></font>
      real alag(ng_u)            <font color=#447700>! Ground thermal diffusivity [m^2 s^-1]<a name='658'></font>
      real alaw(nwr_u)           <font color=#447700>! Wall thermal diffusivity [m^2 s^-1]<a name='659'></font>
      real alar(nwr_u)           <font color=#447700>! Roof thermal diffusivity [m^2 s^-1]<a name='660'></font>
      real csg(ng_u)             <font color=#447700>! Specific heat of the ground material [J m^3 K^-1]<a name='661'></font>
      real csw(nwr_u)            <font color=#447700>! Specific heat of the wall material [J m^3 K^-1]<a name='662'></font>
      real csr(nwr_u)            <font color=#447700>! Specific heat of the roof material [J m^3 K^-1]<a name='663'></font>
<a name='664'>
<font color=#447700>!    Radiation parameters<a name='665'></font>
      real albg                  <font color=#447700>! Albedo of the ground<a name='666'></font>
      real albw                  <font color=#447700>! Albedo of the wall<a name='667'></font>
      real albr                  <font color=#447700>! Albedo of the roof<a name='668'></font>
      real emg                   <font color=#447700>! Emissivity of ground<a name='669'></font>
      real emw                   <font color=#447700>! Emissivity of wall<a name='670'></font>
      real emr                   <font color=#447700>! Emissivity of roof<a name='671'></font>
<a name='672'>
<font color=#447700>!    fww,fwg,fgw,fsw,fsg are the view factors used to compute the long and <a name='673'></font>
<font color=#447700>!    short wave radation. <a name='674'></font>
<font color=#447700>!    The calculation of these factor is explained in the Appendix A of the BLM paper<a name='675'></font>
      real fww(nz_um,nz_um,ndm,nurbm)  <font color=#447700>!  from wall to wall<a name='676'></font>
      real fwg(nz_um,ndm,nurbm)        <font color=#447700>!  from wall to ground<a name='677'></font>
      real fgw(nz_um,ndm,nurbm)        <font color=#447700>!  from ground to wall<a name='678'></font>
      real fsw(nz_um,ndm,nurbm)        <font color=#447700>!  from sky to wall<a name='679'></font>
      real fws(nz_um,ndm,nurbm)        <font color=#447700>!  from wall to sky<a name='680'></font>
      real fsg(ndm,nurbm)              <font color=#447700>!  from sky to ground<a name='681'></font>
<a name='682'>
<font color=#447700>!    Roughness parameters<a name='683'></font>
      real z0(ndm,nz_um)           <font color=#447700>! Roughness lengths "profiles"<a name='684'></font>
      <a name='685'>
<font color=#447700>!    Street parameters<a name='686'></font>
      integer ndu                  <font color=#447700>! Number of street direction for each urban class <a name='687'></font>
      real strd(ndm)               <font color=#447700>! Street length (set to a greater value then the horizontal length of the cells)<a name='688'></font>
      real drst(ndm)               <font color=#447700>! Street direction<a name='689'></font>
      real ws(ndm)                 <font color=#447700>! Street width<a name='690'></font>
      real bs(ndm)                 <font color=#447700>! Building width<a name='691'></font>
      real ss(nz_um)               <font color=#447700>! The probability that a building has an height equal to "z"<a name='692'></font>
      real pb(nz_um)               <font color=#447700>! The probability that a building has an height greater or equal to "z"<a name='693'></font>
        <a name='694'>
<font color=#447700>!    Grid parameters<a name='695'></font>
      integer nzu                  <font color=#447700>! Number of layer in the urban grid<a name='696'></font>
      real z_u(nz_um)              <font color=#447700>! Height of the urban grid levels<a name='697'></font>
<a name='698'>
<a name='699'>
<font color=#447700>! ----------------------------------------------------------------------<a name='700'></font>
<font color=#447700>! INPUT-OUTPUT<a name='701'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='702'></font>
<a name='703'>
<font color=#447700>! Data relative to the "urban grid" which should be stored from the current time step to the next one<a name='704'></font>
<a name='705'>
      real tw(2*ndm,nz_um,nwr_u)  <font color=#447700>! Temperature in each layer of the wall [K]<a name='706'></font>
      real tr(ndm,nz_um,nwr_u)  <font color=#447700>! Temperature in each layer of the roof [K]<a name='707'></font>
      real tg(ndm,ng_u)          <font color=#447700>! Temperature in each layer of the ground [K]<a name='708'></font>
      real sfw(2*ndm,nz_um)      <font color=#447700>! Sensible heat flux from walls<a name='709'></font>
      real sfg(ndm)              <font color=#447700>! Sensible heat flux from ground (road)<a name='710'></font>
      real sfr(ndm,nz_um)      <font color=#447700>! Sensible heat flux from roofs<a name='711'></font>
      real gfg(ndm)             <font color=#447700>! Heat flux transferred from the surface of the ground (road) towards the interior<a name='712'></font>
      real gfr(ndm,nz_um)     <font color=#447700>! Heat flux transferred from the surface of the roof towards the interior<a name='713'></font>
      real gfw(2*ndm,nz_um)     <font color=#447700>! Heat flux transfered from the surface of the walls towards the interior<a name='714'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='715'></font>
<font color=#447700>! OUTPUT:<a name='716'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='717'></font>
<a name='718'>
<font color=#447700>! Data relative to the "mesoscale grid"<a name='719'></font>
<a name='720'>
      real sf(kms:kme)             <font color=#447700>! Surface of the "mesoscale grid" cells taking into account the buildings<a name='721'></font>
      real vl(kms:kme)               <font color=#447700>! Volume of the "mesoscale grid" cells taking into account the buildings<a name='722'></font>
     <a name='723'>
<font color=#447700>!    Implicit and explicit components of the source and sink terms at each levels,<a name='724'></font>
<font color=#447700>!     the fluxes can be computed as follow: FX = A*X + B   example: Heat fluxes = a_t * pt + b_t<a name='725'></font>
      real a_u(kms:kme)              <font color=#447700>! Implicit component of the momentum sources or sinks in the X-direction<a name='726'></font>
      real a_v(kms:kme)              <font color=#447700>! Implicit component of the momentum sources or sinks in the Y-direction<a name='727'></font>
      real a_t(kms:kme)              <font color=#447700>! Implicit component of the heat sources or sinks<a name='728'></font>
      real a_e(kms:kme)              <font color=#447700>! Implicit component of the TKE sources or sinks<a name='729'></font>
      real b_u(kms:kme)              <font color=#447700>! Explicit component of the momentum sources or sinks in the X-direction<a name='730'></font>
      real b_v(kms:kme)              <font color=#447700>! Explicit component of the momentum sources or sinks in the Y-direction<a name='731'></font>
      real b_t(kms:kme)              <font color=#447700>! Explicit component of the heat sources or sinks<a name='732'></font>
      real b_e(kms:kme)              <font color=#447700>! Explicit component of the TKE sources or sinks<a name='733'></font>
      real dlg(kms:kme)              <font color=#447700>! Height above ground (L_ground in formula (24) of the BLM paper). <a name='734'></font>
      real dl_u(kms:kme)             <font color=#447700>! Length scale (lb in formula (22) ofthe BLM paper).<a name='735'></font>
      <a name='736'>
<font color=#447700>! ----------------------------------------------------------------------<a name='737'></font>
<font color=#447700>! LOCAL:<a name='738'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='739'></font>
<a name='740'>
      real dz(kms:kme)               <font color=#447700>! vertical space steps of the "mesoscale grid"<a name='741'></font>
<a name='742'>
<font color=#447700>! Data interpolated from the "mesoscale grid" to the "urban grid"<a name='743'></font>
<a name='744'>
      real ua_u(nz_um)          <font color=#447700>! Wind speed in the x direction<a name='745'></font>
      real va_u(nz_um)          <font color=#447700>! Wind speed in the y direction<a name='746'></font>
      real pt_u(nz_um)          <font color=#447700>! Potential temperature<a name='747'></font>
      real da_u(nz_um)          <font color=#447700>! Air density<a name='748'></font>
      real pt0_u(nz_um)         <font color=#447700>! Reference potential temperature<a name='749'></font>
      real pr_u(nz_um)          <font color=#447700>! Air pressure<a name='750'></font>
<a name='751'>
<font color=#447700>! Solar radiation at each level of the "urban grid"<a name='752'></font>
<a name='753'>
      real rsg(ndm)             <font color=#447700>! Short wave radiation from the ground<a name='754'></font>
      real rsw(2*ndm,nz_um)     <font color=#447700>! Short wave radiation from the walls<a name='755'></font>
      real rlg(ndm)             <font color=#447700>! Long wave radiation from the ground<a name='756'></font>
      real rlw(2*ndm,nz_um)     <font color=#447700>! Long wave radiation from the walls<a name='757'></font>
<a name='758'>
<font color=#447700>! Potential temperature of the surfaces at each level of the "urban grid"<a name='759'></font>
<a name='760'>
      real ptg(ndm)             <font color=#447700>! Ground potential temperatures <a name='761'></font>
      real ptr(ndm,nz_um)     <font color=#447700>! Roof potential temperatures <a name='762'></font>
      real ptw(2*ndm,nz_um)     <font color=#447700>! Walls potential temperatures <a name='763'></font>
<a name='764'>
 <a name='765'>
<font color=#447700>! Explicit and implicit component of the momentum, temperature and TKE sources or sinks on<a name='766'></font>
<font color=#447700>!  vertical surfaces (walls) ans horizontal surfaces (roofs and street)<a name='767'></font>
<font color=#447700>! The fluxes can be computed as follow: Fluxes of X = A*X + B<a name='768'></font>
<font color=#447700>!  Example: Momentum fluxes on vertical surfaces = uva_u * ua_u + uvb_u<a name='769'></font>
<a name='770'>
      real uhb_u(ndm,nz_um)   <font color=#447700>! U (wind component) Horizontal surfaces, B (explicit) term<a name='771'></font>
      real uva_u(2*ndm,nz_um)   <font color=#447700>! U (wind component)   Vertical surfaces, A (implicit) term<a name='772'></font>
      real uvb_u(2*ndm,nz_um)   <font color=#447700>! U (wind component)   Vertical surfaces, B (explicit) term<a name='773'></font>
      real vhb_u(ndm,nz_um)   <font color=#447700>! V (wind component) Horizontal surfaces, B (explicit) term<a name='774'></font>
      real vva_u(2*ndm,nz_um)   <font color=#447700>! V (wind component)   Vertical surfaces, A (implicit) term<a name='775'></font>
      real vvb_u(2*ndm,nz_um)   <font color=#447700>! V (wind component)   Vertical surfaces, B (explicit) term<a name='776'></font>
      real thb_u(ndm,nz_um)   <font color=#447700>! Temperature        Horizontal surfaces, B (explicit) term<a name='777'></font>
      real tva_u(2*ndm,nz_um)   <font color=#447700>! Temperature          Vertical surfaces, A (implicit) term<a name='778'></font>
      real tvb_u(2*ndm,nz_um)   <font color=#447700>! Temperature          Vertical surfaces, B (explicit) term<a name='779'></font>
      real ehb_u(ndm,nz_um)   <font color=#447700>! Energy (TKE)       Horizontal surfaces, B (explicit) term<a name='780'></font>
      real evb_u(2*ndm,nz_um)   <font color=#447700>! Energy (TKE)         Vertical surfaces, B (explicit) term<a name='781'></font>
      <a name='782'>
<font color=#447700>!<a name='783'></font>
      real rs_abs <font color=#447700>! solar radiation absorbed by urban surfaces <a name='784'></font>
      real rl_up <font color=#447700>! longwave radiation emitted by urban surface to the atmosphere <a name='785'></font>
      real emiss <font color=#447700>! mean emissivity of the urban surface<a name='786'></font>
      real grdflx_urb <font color=#447700>! ground heat flux<a name='787'></font>
      integer iz,id<a name='788'>
      integer iw,ix,iy<a name='789'>
<a name='790'>
<font color=#447700>! ----------------------------------------------------------------------<a name='791'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='792'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='793'></font>
<a name='794'>
<font color=#447700>! Fix some usefull parameters for the computation of the sources or sinks<a name='795'></font>
<a name='796'>
      do iz=kts,kte<a name='797'>
         dz(iz)=z(iz+1)-z(iz)<a name='798'>
      end do<a name='799'>
<a name='800'>
<font color=#447700>! Interpolation on the "urban grid"<a name='801'></font>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERPOL'>interpol</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERPOL_1">(kms,kme,kts,kte,nzu,z,z_u,ua,ua_u)<a name='802'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERPOL'>interpol</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERPOL_2">(kms,kme,kts,kte,nzu,z,z_u,va,va_u)<a name='803'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERPOL'>interpol</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERPOL_3">(kms,kme,kts,kte,nzu,z,z_u,pt,pt_u)<a name='804'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERPOL'>interpol</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERPOL_4">(kms,kme,kts,kte,nzu,z,z_u,pt0,pt0_u)<a name='805'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERPOL'>interpol</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERPOL_5">(kms,kme,kts,kte,nzu,z,z_u,pr,pr_u)<a name='806'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERPOL'>interpol</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERPOL_6">(kms,kme,kts,kte,nzu,z,z_u,da,da_u)<a name='807'>
<a name='808'>
                   <a name='809'>
<font color=#447700>! Compute the modification of the radiation due to the buildings<a name='810'></font>
<a name='811'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#MODIF_RAD'>modif_rad</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODIF_RAD_1">(iurb,ndu,nzu,z_u,ws,               &amp;<a name='812'>
                    drst,strd,ss,pb,                    &amp;<a name='813'>
                    tw,tg,albg,albw,emw,emg,            &amp;<a name='814'>
                    fww,fwg,fgw,fsw,fsg,                &amp;<a name='815'>
                    zr,deltar,ah,                       &amp;<a name='816'>
                    rs,rld,rsw,rsg,rlw,rlg)                       <a name='817'>
 <a name='818'>
<font color=#447700>! calculation of the urban albedo and the upward long wave radiation<a name='819'></font>
       <a name='820'>
       call <A href='../../html_code/phys/module_sf_bep_bem.F.html#UPWARD_RAD'>upward_rad</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPWARD_RAD_1">(ndu,nzu,ws,bs,                   &amp;<a name='821'>
                       sigma,pb,ss,                     &amp;<a name='822'>
                       tg,emg,albg,rlg,rsg,sfg,         &amp; <a name='823'>
                       tw,emw,albw,rlw,rsw,sfw,         &amp; <a name='824'>
                       tr,emr,albr,rld,rs,sfr,          &amp; <a name='825'>
                       rs_abs,rl_up,emiss,grdflx_urb)               <a name='826'>
        <a name='827'>
<font color=#447700>! Compute the surface temperatures<a name='828'></font>
     <a name='829'>
<a name='830'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SURF_TEMP'>surf_temp</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURF_TEMP_1">(nzu,ndu,pr_u,dt,ss,                &amp; <a name='831'>
                    rs,rld,rsg,rlg,rsw,rlw,             &amp;<a name='832'>
                    tg,alag,csg,emg,albg,ptg,sfg,gfg,   &amp;<a name='833'>
                    tr,alar,csr,emr,albr,ptr,sfr,gfr,   &amp;<a name='834'>
                    tw,alaw,csw,emw,albw,ptw,sfw,gfw)  <a name='835'>
      <a name='836'>
      <a name='837'>
<font color=#447700>! Compute the implicit and explicit components of the sources or sinks on the "urban grid"<a name='838'></font>
       <a name='839'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#BUILDINGS'>buildings</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BUILDINGS_1">(ndu,nzu,z0,ua_u,va_u,                       &amp; <a name='840'>
                     pt_u,pt0_u,ptg,ptr,da_u,ptw,drst,           &amp;                      <a name='841'>
                     uva_u,vva_u,uvb_u,vvb_u,tva_u,tvb_u,evb_u,  &amp; <a name='842'>
                     uhb_u,vhb_u,thb_u,ehb_u,ss,dt)                        <a name='843'>
 <a name='844'>
         <a name='845'>
<font color=#447700>! Calculation of the sensible heat fluxes for the ground, the wall and roof<a name='846'></font>
<font color=#447700>! Sensible Heat Flux = density * Cp_U * ( A* potential temperature + B )<a name='847'></font>
<font color=#447700>! where A and B are the implicit and explicit components of the heat sources or sinks.<a name='848'></font>
<font color=#447700>!  <a name='849'></font>
<font color=#447700>! <a name='850'></font>
 <a name='851'>
      do id=1,ndu         <a name='852'>
         sfg(id)=-da_u(1)*cp_u*thb_u(id,1)<a name='853'>
         do iz=2,nzu<a name='854'>
            sfr(id,iz)=-da_u(iz)*cp_u*thb_u(id,iz)<a name='855'>
         enddo<a name='856'>
         <a name='857'>
         do iz=1,nzu<a name='858'>
            sfw(2*id-1,iz)=-da_u(iz)*cp_u*(tvb_u(2*id-1,iz)+     &amp;<a name='859'>
                tva_u(2*id-1,iz)*pt_u(iz))<a name='860'>
            sfw(2*id,iz)=-da_u(iz)*cp_u*(tvb_u(2*id,iz)+         &amp;<a name='861'>
                tva_u(2*id,iz)*pt_u(iz)) <a name='862'>
         enddo<a name='863'>
      enddo<a name='864'>
      <a name='865'>
<font color=#447700>! calculation of the urban albedo and the upward long wave radiation<a name='866'></font>
          <a name='867'>
<font color=#447700>!!       call upward_rad(ndu,nzu,ws,bs,                      &amp;<a name='868'></font>
<font color=#447700>!!                       sigma,pb,ss,                        &amp;<a name='869'></font>
<font color=#447700>!!                       tg,emg,albg,rlg,rsg,sfg,            &amp; <a name='870'></font>
<font color=#447700>!!                       tw,emw,albw,rlw,rsw,sfw,            &amp; <a name='871'></font>
<font color=#447700>!!                       tr,emr,albr,rld,rs,sfr,             &amp; <a name='872'></font>
<font color=#447700>!!                       rs_abs,rl_up,emiss,grdflx_urb)             <a name='873'></font>
<a name='874'>
<font color=#447700>! Interpolation on the "mesoscale grid"<a name='875'></font>
<a name='876'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#URBAN_MESO'>urban_meso</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="URBAN_MESO_1">(ndu,kms,kme,kts,kte,nzu,z,dz,z_u,pb,ss,bs,ws,sf, &amp; <a name='877'>
                     vl,uva_u,vva_u,uvb_u,vvb_u,tva_u,tvb_u,evb_u,     &amp;<a name='878'>
                     uhb_u,vhb_u,thb_u,ehb_u,                          &amp;<a name='879'>
                     a_u,a_v,a_t,a_e,b_u,b_v,b_t,b_e)                    <a name='880'>
       <a name='881'>
<a name='882'>
<font color=#447700>! computation of the mean road temperature tsk (this value could be used <a name='883'></font>
<font color=#447700>! to replace the surface temperature in the radiation routines, if needed).<a name='884'></font>
<a name='885'>
<font color=#447700>! Calculation of the length scale taking into account the buildings effects<a name='886'></font>
<a name='887'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INTERP_LENGTH'>interp_length</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_LENGTH_1">(ndu,kms,kme,kts,kte,nzu,z_u,z,ss,ws,bs,dlg,dl_u)<a name='888'>
<a name='889'>
      return<a name='890'>
      end subroutine BEP1D<a name='891'>
<a name='892'>
<font color=#447700>! ===6=8===============================================================72<a name='893'></font>
<font color=#447700>! ===6=8===============================================================72<a name='894'></font>
<a name='895'>
<A NAME='PARAM'><A href='../../html_code/phys/module_sf_bep.F.html#PARAM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='896'>
       <font color=#993300>subroutine </font><font color=#cc0000>param</font>(iurb,nzu,nzurb,nzurban,ndu,                   &amp; <A href='../../call_to/PARAM.html' TARGET='index'>2</A><a name='897'>
                       csg_u,csg,alag_u,alag,csr_u,csr,               &amp;<a name='898'>
                       alar_u,alar,csw_u,csw,alaw_u,alaw,             &amp;<a name='899'>
                       ws_u,ws,bs_u,bs,z0g_u,z0r_u,z0,                &amp;  <a name='900'>
                       strd_u,strd,drst_u,drst,ss_u,ss_urb,ss,pb_u,   &amp;<a name='901'>
                       pb_urb,pb,lp_urb,lb_urb,hgt_urb,frc_urb)        <a name='902'>
<a name='903'>
<font color=#447700>! ----------------------------------------------------------------------<a name='904'></font>
<font color=#447700>!    This routine prepare some usefull parameters       <a name='905'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='906'></font>
<a name='907'>
      implicit none<a name='908'>
<a name='909'>
  <a name='910'>
<font color=#447700>! ----------------------------------------------------------------------<a name='911'></font>
<font color=#447700>! INPUT:<a name='912'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='913'></font>
      integer iurb                 <font color=#447700>! Current urban class<a name='914'></font>
      integer nzu                  <font color=#447700>! Number of vertical urban levels in the current class<a name='915'></font>
      integer nzurb                <font color=#447700>! Number of vertical urban levels in the current class<a name='916'></font>
      integer ndu                  <font color=#447700>! Number of street direction for the current urban class<a name='917'></font>
      real alag_u(nurbm)           <font color=#447700>! Ground thermal diffusivity [m^2 s^-1]<a name='918'></font>
      real alar_u(nurbm)           <font color=#447700>! Roof thermal diffusivity [m^2 s^-1]<a name='919'></font>
      real alaw_u(nurbm)           <font color=#447700>! Wall thermal diffusivity [m^2 s^-1]<a name='920'></font>
      real bs_u(ndm,nurbm)         <font color=#447700>! Building width<a name='921'></font>
      real csg_u(nurbm)            <font color=#447700>! Specific heat of the ground material [J m^3 K^-1]<a name='922'></font>
      real csr_u(nurbm)            <font color=#447700>! Specific heat of the roof material [J m^3 K^-1]<a name='923'></font>
      real csw_u(nurbm)            <font color=#447700>! Specific heat of the wall material [J m^3 K^-1]<a name='924'></font>
      real drst_u(ndm,nurbm)       <font color=#447700>! Street direction<a name='925'></font>
      real strd_u(ndm,nurbm)       <font color=#447700>! Street length <a name='926'></font>
      real ws_u(ndm,nurbm)         <font color=#447700>! Street width<a name='927'></font>
      real z0g_u(nurbm)            <font color=#447700>! The ground's roughness length<a name='928'></font>
      real z0r_u(nurbm)            <font color=#447700>! The roof's roughness length<a name='929'></font>
      real ss_u(nz_um,nurbm)     <font color=#447700>! The probability that a building has an height equal to "z"<a name='930'></font>
      real pb_u(nz_um,nurbm)     <font color=#447700>! The probability that a building has an height greater or equal to "z"<a name='931'></font>
      real ss_urb(nz_um)     <font color=#447700>! The probability that a building has an height equal to "z"<a name='932'></font>
      real pb_urb(nz_um)     <font color=#447700>! The probability that a building has an height greater or equal to "z"<a name='933'></font>
      real lp_urb                <font color=#447700>! Building plan area density<a name='934'></font>
      real lb_urb                <font color=#447700>! Building surface area to plan area ratio<a name='935'></font>
      real hgt_urb               <font color=#447700>! Average building height weighted by building plan area [m]<a name='936'></font>
      real frc_urb               <font color=#447700>! Urban fraction<a name='937'></font>
     <a name='938'>
<font color=#447700>! ----------------------------------------------------------------------<a name='939'></font>
<font color=#447700>! OUTPUT:<a name='940'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='941'></font>
      real alag(ng_u)           <font color=#447700>! Ground thermal diffusivity at each ground levels<a name='942'></font>
      real alar(nwr_u)           <font color=#447700>! Roof thermal diffusivity at each roof levels<a name='943'></font>
      real alaw(nwr_u)           <font color=#447700>! Wall thermal diffusivity at each wall levels<a name='944'></font>
      real csg(ng_u)            <font color=#447700>! Specific heat of the ground material at each ground levels<a name='945'></font>
      real csr(nwr_u)            <font color=#447700>! Specific heat of the roof material at each roof levels<a name='946'></font>
      real csw(nwr_u)            <font color=#447700>! Specific heat of the wall material at each wall levels<a name='947'></font>
      real bs(ndm)              <font color=#447700>! Building width for the current urban class<a name='948'></font>
      real drst(ndm)            <font color=#447700>! street directions for the current urban class<a name='949'></font>
      real strd(ndm)            <font color=#447700>! Street lengths for the current urban class<a name='950'></font>
      real ws(ndm)              <font color=#447700>! Street widths of the current urban class<a name='951'></font>
      real z0(ndm,nz_um)      <font color=#447700>! Roughness lengths "profiles"<a name='952'></font>
      real ss(nz_um)          <font color=#447700>! Probability to have a building with height h<a name='953'></font>
      real pb(nz_um)          <font color=#447700>! Probability to have a building with an height equal<a name='954'></font>
      integer nzurban<a name='955'>
<a name='956'>
<font color=#447700>! ----------------------------------------------------------------------<a name='957'></font>
<font color=#447700>! LOCAL:<a name='958'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='959'></font>
      integer id,ig,ir,iw,iz,ihu<a name='960'>
<a name='961'>
<font color=#447700>! ----------------------------------------------------------------------<a name='962'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='963'></font>
<font color=#447700>! ----------------------------------------------------------------------     <a name='964'></font>
<font color=#447700>!<a name='965'></font>
<font color=#447700>!Initialize<a name='966'></font>
<font color=#447700>!<a name='967'></font>
      ss=0.<a name='968'>
      pb=0.<a name='969'>
      csg=0.<a name='970'>
      alag=0.<a name='971'>
      csr=0.<a name='972'>
      alar=0.<a name='973'>
      csw=0.<a name='974'>
      alaw=0.<a name='975'>
      z0=0.<a name='976'>
      ws=0.<a name='977'>
      bs=0.<a name='978'>
      strd=0.<a name='979'>
      drst=0.<a name='980'>
      nzurban=0<a name='981'>
      <a name='982'>
      ihu=0<a name='983'>
<a name='984'>
       do iz=1,nz_um<a name='985'>
          if (ss_urb(iz)/=0.) then<a name='986'>
             ihu=1<a name='987'>
             exit<a name='988'>
          else<a name='989'>
             continue<a name='990'>
          endif<a name='991'>
       enddo<a name='992'>
           <a name='993'>
       if (ihu==1) then<a name='994'>
          do iz=1,nzurb+1<a name='995'>
             ss(iz)=ss_urb(iz)<a name='996'>
             pb(iz)=pb_urb(iz)<a name='997'>
          enddo<a name='998'>
          nzurban=nzurb<a name='999'>
       else<a name='1000'>
          do iz=1,nzu+1<a name='1001'>
             ss(iz)=ss_u(iz,iurb)<a name='1002'>
             pb(iz)=pb_u(iz,iurb)<a name='1003'>
          end do <a name='1004'>
          nzurban=nzu<a name='1005'>
       endif<a name='1006'>
<a name='1007'>
       do id=1,ndu<a name='1008'>
        z0(id,1)=z0g_u(iurb)<a name='1009'>
        do iz=2,nzurban+1<a name='1010'>
           z0(id,iz)=z0r_u(iurb)<a name='1011'>
        enddo<a name='1012'>
       enddo<a name='1013'>
                 <a name='1014'>
       do ig=1,ng_u<a name='1015'>
        csg(ig)=csg_u(iurb)<a name='1016'>
        alag(ig)=alag_u(iurb)<a name='1017'>
       enddo<a name='1018'>
       <a name='1019'>
       do ir=1,nwr_u<a name='1020'>
        csr(ir)=csr_u(iurb)<a name='1021'>
        alar(ir)=alar_u(iurb)<a name='1022'>
       enddo<a name='1023'>
       <a name='1024'>
       do iw=1,nwr_u<a name='1025'>
        csw(iw)=csw_u(iurb)<a name='1026'>
        alaw(iw)=alaw_u(iurb)<a name='1027'>
       enddo<a name='1028'>
      <a name='1029'>
       do id=1,ndu<a name='1030'>
        strd(id)=strd_u(id,iurb)<a name='1031'>
        drst(id)=drst_u(id,iurb)     <a name='1032'>
       enddo<a name='1033'>
    <a name='1034'>
       do id=1,ndu<a name='1035'>
          if ((hgt_urb&lt;=0.).OR.(lp_urb&lt;=0.).OR.(lb_urb&lt;=0.)) then<a name='1036'>
             ws(id)=ws_u(id,iurb)<a name='1037'>
             bs(id)=bs_u(id,iurb)<a name='1038'>
          else if ((lp_urb/frc_urb&lt;1.).and.(lp_urb&lt;lb_urb)) then<a name='1039'>
                  bs(id)=2.*hgt_urb*lp_urb/(lb_urb-lp_urb)<a name='1040'>
                  ws(id)=2.*hgt_urb*lp_urb*((frc_urb/lp_urb)-1.)/(lb_urb-lp_urb)<a name='1041'>
               else<a name='1042'>
                  ws(id)=ws_u(id,iurb)<a name='1043'>
                  bs(id)=bs_u(id,iurb) <a name='1044'>
          endif<a name='1045'>
       enddo<a name='1046'>
       do id=1,ndu<a name='1047'>
          if ((bs(id)&lt;=1.).OR.(bs(id)&gt;=150.)) then<a name='1048'>
<font color=#447700>!            write(*,*) 'WARNING, WIDTH OF THE BUILDING WRONG',id,bs(id)<a name='1049'></font>
<font color=#447700>!            write(*,*) 'WIDTH OF THE STREET',id,ws(id)<a name='1050'></font>
             bs(id)=bs_u(id,iurb)<a name='1051'>
             ws(id)=ws_u(id,iurb)<a name='1052'>
          endif<a name='1053'>
          if ((ws(id)&lt;=1.).OR.(ws(id)&gt;=150.)) then<a name='1054'>
<font color=#447700>!            write(*,*) 'WARNING, WIDTH OF THE STREET WRONG',id,ws(id)<a name='1055'></font>
<font color=#447700>!            write(*,*) 'WIDTH OF THE BUILDING',id,bs(id)<a name='1056'></font>
             bs(id)=bs_u(id,iurb)<a name='1057'>
             ws(id)=ws_u(id,iurb)<a name='1058'>
          endif<a name='1059'>
       enddo<a name='1060'>
       return<a name='1061'>
       end subroutine param<a name='1062'>
       <a name='1063'>
<font color=#447700>! ===6=8===============================================================72<a name='1064'></font>
<font color=#447700>! ===6=8===============================================================72<a name='1065'></font>
<a name='1066'>
<A NAME='INTERPOL'><A href='../../html_code/phys/module_sf_bep.F.html#INTERPOL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1067'>
      <font color=#993300>subroutine </font><font color=#cc0000>interpol</font>(kms,kme,kts,kte,nz_u,z,z_u,c,c_u) <A href='../../call_to/INTERPOL.html' TARGET='index'>13</A><a name='1068'>
<a name='1069'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1070'></font>
<font color=#447700>!  This routine interpolate para<a name='1071'></font>
<font color=#447700>!  meters from the "mesoscale grid" to<a name='1072'></font>
<font color=#447700>!  the "urban grid".<a name='1073'></font>
<font color=#447700>!  See p300 Appendix B.1 of the BLM paper.<a name='1074'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1075'></font>
<a name='1076'>
      implicit none<a name='1077'>
<a name='1078'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1079'></font>
<font color=#447700>! INPUT:<a name='1080'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1081'></font>
<font color=#447700>! Data relative to the "mesoscale grid"<a name='1082'></font>
      integer kts,kte,kms,kme            <a name='1083'>
      real z(kms:kme)          <font color=#447700>! Altitude of the cell interface<a name='1084'></font>
      real c(kms:kme)            <font color=#447700>! Parameter which has to be interpolated<a name='1085'></font>
<font color=#447700>! Data relative to the "urban grid"<a name='1086'></font>
      integer nz_u          <font color=#447700>! Number of levels<a name='1087'></font>
<font color=#447700>!!    real z_u(nz_u+1)      ! Altitude of the cell interface<a name='1088'></font>
      real z_u(nz_um)       <font color=#447700>! Altitude of the cell interface<a name='1089'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1090'></font>
<font color=#447700>! OUTPUT:<a name='1091'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1092'></font>
<font color=#447700>!!    real c_u(nz_u)        ! Interpolated paramters in the "urban grid"<a name='1093'></font>
      real c_u(nz_um)       <font color=#447700>! Interpolated paramters in the "urban grid"<a name='1094'></font>
<a name='1095'>
       <a name='1096'>
<font color=#447700>! LOCAL:<a name='1097'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1098'></font>
      integer iz_u,iz<a name='1099'>
      real ctot,dz<a name='1100'>
<a name='1101'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1102'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='1103'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1104'></font>
<a name='1105'>
       do iz_u=1,nz_u<a name='1106'>
        ctot=0.<a name='1107'>
        do iz=kts,kte<a name='1108'>
         dz=max(min(z(iz+1),z_u(iz_u+1))-max(z(iz),z_u(iz_u)),0.)<a name='1109'>
         ctot=ctot+c(iz)*dz<a name='1110'>
        enddo<a name='1111'>
        c_u(iz_u)=ctot/(z_u(iz_u+1)-z_u(iz_u))<a name='1112'>
       enddo<a name='1113'>
       <a name='1114'>
       return<a name='1115'>
       end subroutine interpol<a name='1116'>
         <a name='1117'>
<font color=#447700>! ===6=8===============================================================72       <a name='1118'></font>
<font color=#447700>! ===6=8===============================================================72     <a name='1119'></font>
<a name='1120'>
<A NAME='MODIF_RAD'><A href='../../html_code/phys/module_sf_bep.F.html#MODIF_RAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1121'>
      <font color=#993300>subroutine </font><font color=#cc0000>modif_rad</font>(iurb,nd,nz_u,z,ws,drst,strd,ss,pb,    &amp; <A href='../../call_to/MODIF_RAD.html' TARGET='index'>2</A>,<A href='../../call_from/MODIF_RAD.html' TARGET='index'>6</A><a name='1122'>
                          tw,tg,albg,albw,emw,emg,               &amp;<a name='1123'>
                          fww,fwg,fgw,fsw,fsg,                   &amp;<a name='1124'>
                          zr,deltar,ah,                          &amp;    <a name='1125'>
                          rs,rl,rsw,rsg,rlw,rlg)                       <a name='1126'>
 <a name='1127'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1128'></font>
<font color=#447700>! This routine computes the modification of the short wave and <a name='1129'></font>
<font color=#447700>!  long wave radiation due to the buildings.<a name='1130'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1131'></font>
<a name='1132'>
      implicit none<a name='1133'>
 <a name='1134'>
 <a name='1135'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1136'></font>
<font color=#447700>! INPUT:<a name='1137'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1138'></font>
      integer iurb              <font color=#447700>! current urban class<a name='1139'></font>
      integer nd                <font color=#447700>! Number of street direction for the current urban class<a name='1140'></font>
      integer nz_u              <font color=#447700>! Number of layer in the urban grid<a name='1141'></font>
      real z(nz_um)           <font color=#447700>! Height of the urban grid levels<a name='1142'></font>
      real ws(ndm)              <font color=#447700>! Street widths of the current urban class<a name='1143'></font>
      real drst(ndm)            <font color=#447700>! street directions for the current urban class<a name='1144'></font>
      real strd(ndm)            <font color=#447700>! Street lengths for the current urban class<a name='1145'></font>
      real ss(nz_um)          <font color=#447700>! probability to have a building with height h<a name='1146'></font>
      real pb(nz_um)          <font color=#447700>! probability to have a building with an height equal<a name='1147'></font>
      real tw(2*ndm,nz_um,nwr_u) <font color=#447700>! Temperature in each layer of the wall [K]<a name='1148'></font>
      real tg(ndm,ng_u)         <font color=#447700>! Temperature in each layer of the ground [K]<a name='1149'></font>
      real albg                 <font color=#447700>! Albedo of the ground for the current urban class<a name='1150'></font>
      real albw                 <font color=#447700>! Albedo of the wall for the current urban class<a name='1151'></font>
      real emg                  <font color=#447700>! Emissivity of ground for the current urban class<a name='1152'></font>
      real emw                  <font color=#447700>! Emissivity of wall for the current urban class<a name='1153'></font>
      real fgw(nz_um,ndm,nurbm)       <font color=#447700>! View factors from ground to wall<a name='1154'></font>
      real fsg(ndm,nurbm)             <font color=#447700>! View factors from sky to ground<a name='1155'></font>
      real fsw(nz_um,ndm,nurbm)       <font color=#447700>! View factors from sky to wall<a name='1156'></font>
      real fws(nz_um,ndm,nurbm)       <font color=#447700>! View factors from wall to sky<a name='1157'></font>
      real fwg(nz_um,ndm,nurbm)       <font color=#447700>! View factors from wall to ground<a name='1158'></font>
      real fww(nz_um,nz_um,ndm,nurbm) <font color=#447700>! View factors from wall to wall<a name='1159'></font>
      real ah                   <font color=#447700>! Hour angle (it should come from the radiation routine)<a name='1160'></font>
      real zr                   <font color=#447700>! zenith angle<a name='1161'></font>
      real deltar               <font color=#447700>! Declination of the sun<a name='1162'></font>
      real rs                   <font color=#447700>! solar radiation<a name='1163'></font>
      real rl                   <font color=#447700>! downward flux of the longwave radiation<a name='1164'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1165'></font>
<font color=#447700>! OUTPUT:<a name='1166'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1167'></font>
      real rlg(ndm)             <font color=#447700>! Long wave radiation at the ground<a name='1168'></font>
      real rlw(2*ndm,nz_um)     <font color=#447700>! Long wave radiation at the walls<a name='1169'></font>
      real rsg(ndm)             <font color=#447700>! Short wave radiation at the ground<a name='1170'></font>
      real rsw(2*ndm,nz_um)     <font color=#447700>! Short wave radiation at the walls<a name='1171'></font>
<a name='1172'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1173'></font>
<font color=#447700>! LOCAL:<a name='1174'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1175'></font>
<a name='1176'>
      integer id,iz<a name='1177'>
<a name='1178'>
<font color=#447700>!  Calculation of the shadow effects<a name='1179'></font>
<a name='1180'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SHADOW_MAS'>shadow_mas</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#MODIF_RAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHADOW_MAS_1">(nd,nz_u,zr,deltar,ah,drst,ws,ss,pb,z,           &amp;<a name='1181'>
                     rs,rsw,rsg)<a name='1182'>
<a name='1183'>
<font color=#447700>! Calculation of the reflection effects          <a name='1184'></font>
      do id=1,nd<a name='1185'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#LONG_RAD'>long_rad</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#MODIF_RAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LONG_RAD_1">(iurb,nz_u,id,emw,emg,                 &amp;<a name='1186'>
                      fwg,fww,fgw,fsw,fsg,tg,tw,rlg,rlw,rl,pb)<a name='1187'>
         <a name='1188'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SHORT_RAD'>short_rad</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#MODIF_RAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHORT_RAD_1">(iurb,nz_u,id,albw,albg,fwg,fww,fgw,rsg,rsw,pb)<a name='1189'>
  <a name='1190'>
      enddo<a name='1191'>
      <a name='1192'>
      return<a name='1193'>
      end subroutine modif_rad<a name='1194'>
<a name='1195'>
<a name='1196'>
<font color=#447700>! ===6=8===============================================================72  <a name='1197'></font>
<font color=#447700>! ===6=8===============================================================72     <a name='1198'></font>
<a name='1199'>
<A NAME='SURF_TEMP'><A href='../../html_code/phys/module_sf_bep.F.html#SURF_TEMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1200'>
      <font color=#993300>subroutine </font><font color=#cc0000>surf_temp</font>(nz_u,nd,pr,dt,ss,rs,rl,rsg,rlg,rsw,rlw,     &amp; <A href='../../call_to/SURF_TEMP.html' TARGET='index'>2</A>,<A href='../../call_from/SURF_TEMP.html' TARGET='index'>5</A><a name='1201'>
                          tg,alag,csg,emg,albg,ptg,sfg,gfg,             &amp;<a name='1202'>
                          tr,alar,csr,emr,albr,ptr,sfr,gfr,             &amp;<a name='1203'>
                          tw,alaw,csw,emw,albw,ptw,sfw,gfw)             <a name='1204'>
                 <a name='1205'>
<a name='1206'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1207'></font>
<font color=#447700>! Computation of the surface temperatures for walls, ground and roofs <a name='1208'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1209'></font>
<a name='1210'>
      implicit none<a name='1211'>
      <a name='1212'>
      <a name='1213'>
      <a name='1214'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1215'></font>
<font color=#447700>! INPUT:<a name='1216'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1217'></font>
      integer nz_u              <font color=#447700>! Number of vertical layers defined in the urban grid<a name='1218'></font>
      integer nd                <font color=#447700>! Number of street direction for the current urban class<a name='1219'></font>
      real alag(ng_u)           <font color=#447700>! Ground thermal diffusivity for the current urban class [m^2 s^-1] <a name='1220'></font>
      real alar(nwr_u)           <font color=#447700>! Roof thermal diffusivity for the current urban class [m^2 s^-1]  <a name='1221'></font>
      real alaw(nwr_u)           <font color=#447700>! Wall thermal diffusivity for the current urban class [m^2 s^-1]  <a name='1222'></font>
      real albg                 <font color=#447700>! Albedo of the ground for the current urban class<a name='1223'></font>
      real albr                 <font color=#447700>! Albedo of the roof for the current urban class<a name='1224'></font>
      real albw                 <font color=#447700>! Albedo of the wall for the current urban class<a name='1225'></font>
      real csg(ng_u)            <font color=#447700>! Specific heat of the ground material of the current urban class [J m^3 K^-1]<a name='1226'></font>
      real csr(nwr_u)            <font color=#447700>! Specific heat of the roof material for the current urban class [J m^3 K^-1]<a name='1227'></font>
      real csw(nwr_u)            <font color=#447700>! Specific heat of the wall material for the current urban class [J m^3 K^-1]<a name='1228'></font>
      real dt                   <font color=#447700>! Time step<a name='1229'></font>
      real emg                  <font color=#447700>! Emissivity of ground for the current urban class<a name='1230'></font>
      real emr                  <font color=#447700>! Emissivity of roof for the current urban class<a name='1231'></font>
      real emw                  <font color=#447700>! Emissivity of wall for the current urban class<a name='1232'></font>
      real pr(nz_um)            <font color=#447700>! Air pressure<a name='1233'></font>
      real rs                   <font color=#447700>! Solar radiation<a name='1234'></font>
      real rl                   <font color=#447700>! Downward flux of the longwave radiation<a name='1235'></font>
      real rlg(ndm)             <font color=#447700>! Long wave radiation at the ground<a name='1236'></font>
      real rlw(2*ndm,nz_um)     <font color=#447700>! Long wave radiation at the walls<a name='1237'></font>
      real rsg(ndm)             <font color=#447700>! Short wave radiation at the ground<a name='1238'></font>
      real rsw(2*ndm,nz_um)     <font color=#447700>! Short wave radiation at the walls<a name='1239'></font>
      real sfg(ndm)             <font color=#447700>! Sensible heat flux from ground (road)<a name='1240'></font>
      real sfr(ndm,nz_um)     <font color=#447700>! Sensible heat flux from roofs<a name='1241'></font>
      real sfw(2*ndm,nz_um)     <font color=#447700>! Sensible heat flux from walls<a name='1242'></font>
      real gfg(ndm)             <font color=#447700>! Heat flux transferred from the surface of the ground (road) toward the interior<a name='1243'></font>
      real gfr(ndm,nz_um)     <font color=#447700>! Heat flux transferred from the surface of the roof toward the interior<a name='1244'></font>
      real gfw(2*ndm,nz_um)     <font color=#447700>! Heat flux transfered from the surface of the walls toward the interior<a name='1245'></font>
      real ss(nz_um)          <font color=#447700>! Probability to have a building with height h<a name='1246'></font>
      real tg(ndm,ng_u)         <font color=#447700>! Temperature in each layer of the ground [K]<a name='1247'></font>
      real tr(ndm,nz_um,nwr_u) <font color=#447700>! Temperature in each layer of the roof [K]<a name='1248'></font>
      real tw(2*ndm,nz_um,nwr_u) <font color=#447700>! Temperature in each layer of the wall [K]<a name='1249'></font>
      <a name='1250'>
<a name='1251'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1252'></font>
<font color=#447700>! OUTPUT:<a name='1253'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1254'></font>
      real ptg(ndm)             <font color=#447700>! Ground potential temperatures <a name='1255'></font>
      real ptr(ndm,nz_um)     <font color=#447700>! Roof potential temperatures <a name='1256'></font>
      real ptw(2*ndm,nz_um)     <font color=#447700>! Walls potential temperatures <a name='1257'></font>
<a name='1258'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1259'></font>
<font color=#447700>! LOCAL:<a name='1260'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1261'></font>
      integer id,ig,ir,iw,iz<a name='1262'>
<a name='1263'>
      real rtg(ndm)             <font color=#447700>! Total radiation at ground(road) surface (solar+incoming long+outgoing long)<a name='1264'></font>
      real rtr(ndm,nz_um)     <font color=#447700>! Total radiation at roof surface (solar+incoming long+outgoing long)<a name='1265'></font>
      real rtw(2*ndm,nz_um)     <font color=#447700>! Radiation at walls surface (solar+incoming long+outgoing long)<a name='1266'></font>
      real tg_tmp(ng_u)<a name='1267'>
      real tr_tmp(nwr_u)<a name='1268'>
      real tw_tmp(nwr_u)<a name='1269'>
<a name='1270'>
      real dzg_u(ng_u)          <font color=#447700>! Layer sizes in the ground<a name='1271'></font>
<a name='1272'>
      real dzr_u(nwr_u)          <font color=#447700>! Layers sizes in the roof<a name='1273'></font>
         <a name='1274'>
      real dzw_u(nwr_u)          <font color=#447700>! Layer sizes in the wall<a name='1275'></font>
      <a name='1276'>
<a name='1277'>
      data dzg_u /0.2,0.12,0.08,0.05,0.03,0.02,0.02,0.01,0.005,0.0025/<a name='1278'>
      data dzr_u /0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.01,0.005,0.0025/   <a name='1279'>
      data dzw_u /0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.01,0.005,0.0025/<a name='1280'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1281'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='1282'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1283'></font>
<a name='1284'>
        <a name='1285'>
   <a name='1286'>
      do id=1,nd<a name='1287'>
<a name='1288'>
<font color=#447700>!      Calculation for the ground surfaces<a name='1289'></font>
       do ig=1,ng_u<a name='1290'>
        tg_tmp(ig)=tg(id,ig)<a name='1291'>
       end do<a name='1292'>
<font color=#447700>!	        <a name='1293'></font>
       call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SOIL_TEMP'>soil_temp</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#SURF_TEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOIL_TEMP_1">(ng_u,dzg_u,tg_tmp,ptg(id),alag,csg,        &amp;<a name='1294'>
                     rsg(id),rlg(id),pr(1),                    &amp;<a name='1295'>
                     dt,emg,albg,                              &amp;<a name='1296'>
                     rtg(id),sfg(id),gfg(id))    <a name='1297'>
       do ig=1,ng_u<a name='1298'>
        tg(id,ig)=tg_tmp(ig)<a name='1299'>
       end do<a name='1300'>
<a name='1301'>
<font color=#447700>!      Calculation for the roofs surfaces<a name='1302'></font>
         <a name='1303'>
       do iz=2,nz_u<a name='1304'>
            <a name='1305'>
        if(ss(iz).gt.0.)then<a name='1306'>
         do ir=1,nwr_u        <a name='1307'>
          tr_tmp(ir)=tr(id,iz,ir)<a name='1308'>
         end do<a name='1309'>
        <a name='1310'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SOIL_TEMP'>soil_temp</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#SURF_TEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOIL_TEMP_2">(nwr_u,dzr_u,tr_tmp,ptr(id,iz),          &amp;<a name='1311'>
                       alar,csr,rs,rl,pr(iz),dt,emr,albr,    &amp;<a name='1312'>
                       rtr(id,iz),sfr(id,iz),gfr(id,iz))     <a name='1313'>
         do ir=1,nwr_u        <a name='1314'>
          tr(id,iz,ir)=tr_tmp(ir)<a name='1315'>
         end do<a name='1316'>
       <a name='1317'>
        end if<a name='1318'>
            <a name='1319'>
       end do <font color=#447700>!iz<a name='1320'></font>
<a name='1321'>
<font color=#447700>!      Calculation for the walls surfaces<a name='1322'></font>
         <a name='1323'>
       do iz=1,nz_u<a name='1324'>
            <a name='1325'>
        do iw=1,nwr_u        <a name='1326'>
         tw_tmp(iw)=tw(2*id-1,iz,iw)<a name='1327'>
        end do<a name='1328'>
        call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SOIL_TEMP'>soil_temp</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#SURF_TEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOIL_TEMP_3">(nwr_u,dzw_u,tw_tmp,ptw(2*id-1,iz),alaw,          &amp;<a name='1329'>
                      csw,                                           &amp;     <a name='1330'>
                      rsw(2*id-1,iz),rlw(2*id-1,iz),                 &amp;     <a name='1331'>
                      pr(iz),dt,emw,                                 &amp;    <a name='1332'>
                albw,rtw(2*id-1,iz),sfw(2*id-1,iz),gfw(2*id-1,iz))   <a name='1333'>
<a name='1334'>
        do iw=1,nwr_u        <a name='1335'>
         tw(2*id-1,iz,iw)=tw_tmp(iw)<a name='1336'>
        end do<a name='1337'>
            <a name='1338'>
        do iw=1,nwr_u        <a name='1339'>
         tw_tmp(iw)=tw(2*id,iz,iw)<a name='1340'>
        end do<a name='1341'>
            <a name='1342'>
        call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SOIL_TEMP'>soil_temp</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#SURF_TEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOIL_TEMP_4">(nwr_u,dzw_u,tw_tmp,ptw(2*id,iz),alaw,          &amp;      <a name='1343'>
                      csw,                                         &amp;     <a name='1344'>
                      rsw(2*id,iz),rlw(2*id,iz),                   &amp;     <a name='1345'>
                      pr(iz),dt,emw,                               &amp;     <a name='1346'>
               albw,rtw(2*id,iz),sfw(2*id,iz),gfw(2*id,iz))        <a name='1347'>
         do iw=1,nwr_u        <a name='1348'>
          tw(2*id,iz,iw)=tw_tmp(iw)<a name='1349'>
         end do<a name='1350'>
                   <a name='1351'>
        end do <font color=#447700>!iz<a name='1352'></font>
	<a name='1353'>
      end do <font color=#447700>!id<a name='1354'></font>
      <a name='1355'>
      return<a name='1356'>
      end subroutine surf_temp<a name='1357'>
     <a name='1358'>
<font color=#447700>! ===6=8===============================================================72     <a name='1359'></font>
<font color=#447700>! ===6=8===============================================================72  <a name='1360'></font>
<a name='1361'>
<A NAME='BUILDINGS'><A href='../../html_code/phys/module_sf_bep.F.html#BUILDINGS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1362'>
      <font color=#993300>subroutine </font><font color=#cc0000>buildings</font>(nd,nz,z0,ua_u,va_u,pt_u,pt0_u,         &amp; <A href='../../call_to/BUILDINGS.html' TARGET='index'>2</A>,<A href='../../call_from/BUILDINGS.html' TARGET='index'>8</A><a name='1363'>
                        ptg,ptr,da_u,ptw,                            &amp;<a name='1364'>
                        drst,uva_u,vva_u,uvb_u,vvb_u,                &amp;<a name='1365'>
                        tva_u,tvb_u,evb_u,                           &amp;<a name='1366'>
                        uhb_u,vhb_u,thb_u,ehb_u,ss,dt)                  <a name='1367'>
<a name='1368'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1369'></font>
<font color=#447700>! This routine computes the sources or sinks of the different quantities <a name='1370'></font>
<font color=#447700>! on the urban grid. The actual calculation is done in the subroutines <a name='1371'></font>
<font color=#447700>! called flux_wall, and flux_flat.<a name='1372'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1373'></font>
<a name='1374'>
      implicit none<a name='1375'>
<a name='1376'>
        <a name='1377'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1378'></font>
<font color=#447700>! INPUT:<a name='1379'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1380'></font>
      integer nd                <font color=#447700>! Number of street direction for the current urban class<a name='1381'></font>
      integer nz                <font color=#447700>! number of vertical space steps<a name='1382'></font>
      real ua_u(nz_um)          <font color=#447700>! Wind speed in the x direction on the urban grid<a name='1383'></font>
      real va_u(nz_um)          <font color=#447700>! Wind speed in the y direction on the urban grid<a name='1384'></font>
      real da_u(nz_um)          <font color=#447700>! air density on the urban grid<a name='1385'></font>
      real drst(ndm)            <font color=#447700>! Street directions for the current urban class<a name='1386'></font>
      real dz<a name='1387'>
      real pt_u(nz_um)          <font color=#447700>! Potential temperature on the urban grid<a name='1388'></font>
      real pt0_u(nz_um)         <font color=#447700>! reference potential temperature on the urban grid<a name='1389'></font>
      real ptg(ndm)             <font color=#447700>! Ground potential temperatures <a name='1390'></font>
      real ptr(ndm,nz_um)     <font color=#447700>! Roof potential temperatures <a name='1391'></font>
      real ptw(2*ndm,nz_um)     <font color=#447700>! Walls potential temperatures <a name='1392'></font>
      real ss(nz_um)          <font color=#447700>! probability to have a building with height h<a name='1393'></font>
      real z0(ndm,nz_um)      <font color=#447700>! Roughness lengths "profiles"<a name='1394'></font>
      real dt <font color=#447700>! time step<a name='1395'></font>
<a name='1396'>
<a name='1397'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1398'></font>
<font color=#447700>! OUTPUT:<a name='1399'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1400'></font>
<font color=#447700>! Explicit and implicit component of the momentum, temperature and TKE sources or sinks on<a name='1401'></font>
<font color=#447700>! vertical surfaces (walls) and horizontal surfaces (roofs and street)<a name='1402'></font>
<font color=#447700>! The fluxes can be computed as follow: Fluxes of X = A*X + B<a name='1403'></font>
<font color=#447700>!  Example: Momentum fluxes on vertical surfaces = uva_u * ua_u + uvb_u<a name='1404'></font>
<a name='1405'>
      real uhb_u(ndm,nz_um)   <font color=#447700>! U (wind component) Horizontal surfaces, B (explicit) term<a name='1406'></font>
      real uva_u(2*ndm,nz_um)   <font color=#447700>! U (wind component)   Vertical surfaces, A (implicit) term<a name='1407'></font>
      real uvb_u(2*ndm,nz_um)   <font color=#447700>! U (wind component)   Vertical surfaces, B (explicit) term<a name='1408'></font>
      real vhb_u(ndm,nz_um)   <font color=#447700>! V (wind component) Horizontal surfaces, B (explicit) term<a name='1409'></font>
      real vva_u(2*ndm,nz_um)   <font color=#447700>! V (wind component)   Vertical surfaces, A (implicit) term<a name='1410'></font>
      real vvb_u(2*ndm,nz_um)   <font color=#447700>! V (wind component)   Vertical surfaces, B (explicit) term<a name='1411'></font>
      real thb_u(ndm,nz_um)   <font color=#447700>! Temperature        Horizontal surfaces, B (explicit) term<a name='1412'></font>
      real tva_u(2*ndm,nz_um)   <font color=#447700>! Temperature          Vertical surfaces, A (implicit) term<a name='1413'></font>
      real tvb_u(2*ndm,nz_um)   <font color=#447700>! Temperature          Vertical surfaces, B (explicit) term<a name='1414'></font>
      real ehb_u(ndm,nz_um)   <font color=#447700>! Energy (TKE)       Horizontal surfaces, B (explicit) term<a name='1415'></font>
      real evb_u(2*ndm,nz_um)   <font color=#447700>! Energy (TKE)         Vertical surfaces, B (explicit) term<a name='1416'></font>
  <a name='1417'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1418'></font>
<font color=#447700>! LOCAL:<a name='1419'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1420'></font>
      integer id,iz<a name='1421'>
<a name='1422'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1423'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='1424'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1425'></font>
       dz=dz_u<a name='1426'>
<a name='1427'>
      do id=1,nd<a name='1428'>
<a name='1429'>
<font color=#447700>!        Calculation at the ground surfaces<a name='1430'></font>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FLUX_FLAT'>flux_flat</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BUILDINGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUX_FLAT_1">(dz,z0(id,1),ua_u(1),va_u(1),pt_u(1),pt0_u(1),  &amp;<a name='1431'>
                       ptg(id),uhb_u(id,1),                            &amp; <a name='1432'>
                       vhb_u(id,1),thb_u(id,1),ehb_u(id,1))            <a name='1433'>
<a name='1434'>
<font color=#447700>!        Calculation at the roof surfaces    <a name='1435'></font>
         do iz=2,nz<a name='1436'>
            if(ss(iz).gt.0)then<a name='1437'>
               call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FLUX_FLAT'>flux_flat</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BUILDINGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUX_FLAT_2">(dz,z0(id,iz),ua_u(iz),                  &amp;              <a name='1438'>
                       va_u(iz),pt_u(iz),pt0_u(iz),                   &amp;   <a name='1439'>
                       ptr(id,iz),uhb_u(id,iz),                       &amp;   <a name='1440'>
                       vhb_u(id,iz),thb_u(id,iz),ehb_u(id,iz))        <a name='1441'>
            else<a name='1442'>
               uhb_u(id,iz) = 0.0<a name='1443'>
               vhb_u(id,iz) = 0.0<a name='1444'>
               thb_u(id,iz) = 0.0<a name='1445'>
               ehb_u(id,iz) = 0.0<a name='1446'>
            endif<a name='1447'>
         end do<a name='1448'>
<a name='1449'>
<font color=#447700>!        Calculation at the wall surfaces         <a name='1450'></font>
         do iz=1,nz         <a name='1451'>
            call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FLUX_WALL'>flux_wall</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BUILDINGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUX_WALL_1">(ua_u(iz),va_u(iz),pt_u(iz),da_u(iz),     &amp;  <a name='1452'>
                        ptw(2*id-1,iz),                             &amp;   <a name='1453'>
                        uva_u(2*id-1,iz),vva_u(2*id-1,iz),          &amp;   <a name='1454'>
                        uvb_u(2*id-1,iz),vvb_u(2*id-1,iz),          &amp;   <a name='1455'>
                        tva_u(2*id-1,iz),tvb_u(2*id-1,iz),          &amp;   <a name='1456'>
                        evb_u(2*id-1,iz),drst(id),dt)                  <a name='1457'>
                    <a name='1458'>
            call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FLUX_WALL'>flux_wall</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#BUILDINGS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLUX_WALL_2">(ua_u(iz),va_u(iz),pt_u(iz),da_u(iz),    &amp;   <a name='1459'>
                        ptw(2*id,iz),                              &amp;    <a name='1460'>
                        uva_u(2*id,iz),vva_u(2*id,iz),             &amp;    <a name='1461'>
                        uvb_u(2*id,iz),vvb_u(2*id,iz),             &amp;    <a name='1462'>
                        tva_u(2*id,iz),tvb_u(2*id,iz),             &amp;   <a name='1463'>
                        evb_u(2*id,iz),drst(id),dt) <a name='1464'>
<font color=#447700>!<a name='1465'></font>
       <a name='1466'>
         end do<a name='1467'>
         <a name='1468'>
      end do<a name='1469'>
                <a name='1470'>
      return<a name='1471'>
      end subroutine buildings<a name='1472'>
      <a name='1473'>
<a name='1474'>
<font color=#447700>! ===6=8===============================================================72<a name='1475'></font>
<font color=#447700>! ===6=8===============================================================72<a name='1476'></font>
<a name='1477'>
<A NAME='URBAN_MESO'><A href='../../html_code/phys/module_sf_bep.F.html#URBAN_MESO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1478'>
        <font color=#993300>subroutine </font><font color=#cc0000>urban_meso</font>(nd,kms,kme,kts,kte,nz_u,z,dz,z_u,pb,ss,bs,ws,sf,vl,    &amp; <A href='../../call_to/URBAN_MESO.html' TARGET='index'>2</A><a name='1479'>
                             uva_u,vva_u,uvb_u,vvb_u,tva_u,tvb_u,evb_u, &amp;       <a name='1480'>
                             uhb_u,vhb_u,thb_u,ehb_u,                   &amp;      <a name='1481'>
                             a_u,a_v,a_t,a_e,b_u,b_v,b_t,b_e)           <a name='1482'>
<a name='1483'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1484'></font>
<font color=#447700>!  This routine interpolates the parameters from the "urban grid" to the<a name='1485'></font>
<font color=#447700>!  "mesoscale grid".<a name='1486'></font>
<font color=#447700>!  See p300-301 Appendix B.2 of the BLM paper.  <a name='1487'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1488'></font>
<a name='1489'>
      implicit none<a name='1490'>
<a name='1491'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1492'></font>
<font color=#447700>! INPUT:<a name='1493'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1494'></font>
<font color=#447700>! Data relative to the "mesoscale grid"<a name='1495'></font>
      integer kms,kme,kts,kte               <a name='1496'>
      real z(kms:kme)              <font color=#447700>! Altitude above the ground of the cell interface<a name='1497'></font>
      real dz(kms:kme)               <font color=#447700>! Vertical space steps<a name='1498'></font>
<a name='1499'>
<font color=#447700>! Data relative to the "uban grid"<a name='1500'></font>
      integer nz_u              <font color=#447700>! Number of layer in the urban grid<a name='1501'></font>
      integer nd                <font color=#447700>! Number of street direction for the current urban class<a name='1502'></font>
      real bs(ndm)              <font color=#447700>! Building widths of the current urban class<a name='1503'></font>
      real ws(ndm)              <font color=#447700>! Street widths of the current urban class<a name='1504'></font>
      real z_u(nz_um)         <font color=#447700>! Height of the urban grid levels<a name='1505'></font>
      real pb(nz_um)          <font color=#447700>! Probability to have a building with an height equal<a name='1506'></font>
      real ss(nz_um)          <font color=#447700>! Probability to have a building with height h<a name='1507'></font>
      real uhb_u(ndm,nz_um)   <font color=#447700>! U (x-wind component) Horizontal surfaces, B (explicit) term<a name='1508'></font>
      real uva_u(2*ndm,nz_um)   <font color=#447700>! U (x-wind component) Vertical surfaces, A (implicit) term<a name='1509'></font>
      real uvb_u(2*ndm,nz_um)   <font color=#447700>! U (x-wind component) Vertical surfaces, B (explicit) term<a name='1510'></font>
      real vhb_u(ndm,nz_um)   <font color=#447700>! V (y-wind component) Horizontal surfaces, B (explicit) term<a name='1511'></font>
      real vva_u(2*ndm,nz_um)   <font color=#447700>! V (y-wind component) Vertical surfaces, A (implicit) term<a name='1512'></font>
      real vvb_u(2*ndm,nz_um)   <font color=#447700>! V (y-wind component) Vertical surfaces, B (explicit) term<a name='1513'></font>
      real thb_u(ndm,nz_um)   <font color=#447700>! Temperature        Horizontal surfaces, B (explicit) term<a name='1514'></font>
      real tva_u(2*ndm,nz_um)   <font color=#447700>! Temperature          Vertical surfaces, A (implicit) term<a name='1515'></font>
      real tvb_u(2*ndm,nz_um)   <font color=#447700>! Temperature          Vertical surfaces, B (explicit) term<a name='1516'></font>
      real ehb_u(ndm,nz_um)   <font color=#447700>! Energy (TKE)       Horizontal surfaces, B (explicit) term<a name='1517'></font>
      real evb_u(2*ndm,nz_um)   <font color=#447700>! Energy (TKE)         Vertical surfaces, B (explicit) term<a name='1518'></font>
<a name='1519'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1520'></font>
<font color=#447700>! OUTPUT:<a name='1521'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1522'></font>
<font color=#447700>! Data relative to the "mesoscale grid"<a name='1523'></font>
      real sf(kms:kme)             <font color=#447700>! Surface of the "mesoscale grid" cells taking into account the buildings<a name='1524'></font>
      real vl(kms:kme)               <font color=#447700>! Volume of the "mesoscale grid" cells taking into account the buildings<a name='1525'></font>
      real a_u(kms:kme)              <font color=#447700>! Implicit component of the momentum sources or sinks in the X-direction<a name='1526'></font>
      real a_v(kms:kme)              <font color=#447700>! Implicit component of the momentum sources or sinks in the Y-direction<a name='1527'></font>
      real a_t(kms:kme)              <font color=#447700>! Implicit component of the heat sources or sinks<a name='1528'></font>
      real a_e(kms:kme)              <font color=#447700>! Implicit component of the TKE sources or sinks<a name='1529'></font>
      real b_u(kms:kme)              <font color=#447700>! Explicit component of the momentum sources or sinks in the X-direction<a name='1530'></font>
      real b_v(kms:kme)              <font color=#447700>! Explicit component of the momentum sources or sinks in the Y-direction<a name='1531'></font>
      real b_t(kms:kme)              <font color=#447700>! Explicit component of the heat sources or sinks<a name='1532'></font>
      real b_e(kms:kme)              <font color=#447700>! Explicit component of the TKE sources or sinks<a name='1533'></font>
      <a name='1534'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1535'></font>
<font color=#447700>! LOCAL:<a name='1536'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1537'></font>
      real dzz<a name='1538'>
      real fact<a name='1539'>
      integer id,iz,iz_u<a name='1540'>
      real se,sr,st,su,sv<a name='1541'>
      real uet(kms:kme)                <font color=#447700>! Contribution to TKE due to walls<a name='1542'></font>
      real veb,vta,vtb,vte,vtot,vua,vub,vva,vvb<a name='1543'>
<a name='1544'>
<a name='1545'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1546'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='1547'></font>
<font color=#447700>! ---------------------------------------------------------------------- <a name='1548'></font>
<a name='1549'>
<font color=#447700>! initialisation<a name='1550'></font>
<a name='1551'>
      do iz=kts,kte<a name='1552'>
         a_u(iz)=0.<a name='1553'>
         a_v(iz)=0.<a name='1554'>
         a_t(iz)=0.<a name='1555'>
         a_e(iz)=0.<a name='1556'>
         b_u(iz)=0.<a name='1557'>
         b_v(iz)=0.<a name='1558'>
         b_e(iz)=0.<a name='1559'>
         b_t(iz)=0.<a name='1560'>
         uet(iz)=0.<a name='1561'>
      end do<a name='1562'>
            <a name='1563'>
<font color=#447700>! horizontal surfaces<a name='1564'></font>
      do iz=kts,kte<a name='1565'>
         sf(iz)=0.<a name='1566'>
         vl(iz)=0.<a name='1567'>
      enddo<a name='1568'>
      sf(kte+1)=0. <a name='1569'>
      <a name='1570'>
      do id=1,nd      <a name='1571'>
         do iz=kts+1,kte+1<a name='1572'>
            sr=0.<a name='1573'>
            do iz_u=2,nz_u<a name='1574'>
               if(z(iz).lt.z_u(iz_u).and.z(iz).ge.z_u(iz_u-1))then<a name='1575'>
                  sr=pb(iz_u)<a name='1576'>
               endif<a name='1577'>
            enddo<a name='1578'>
            sf(iz)=sf(iz)+((ws(id)+(1.-sr)*bs(id))/(ws(id)+bs(id)))/nd<a name='1579'>
         enddo<a name='1580'>
      enddo<a name='1581'>
<a name='1582'>
<font color=#447700>! volume      <a name='1583'></font>
      do iz=kts,kte<a name='1584'>
         do id=1,nd<a name='1585'>
            vtot=0.<a name='1586'>
            do iz_u=1,nz_u<a name='1587'>
               dzz=max(min(z_u(iz_u+1),z(iz+1))-max(z_u(iz_u),z(iz)),0.)<a name='1588'>
               vtot=vtot+pb(iz_u+1)*dzz<a name='1589'>
            enddo<a name='1590'>
            vtot=vtot/(z(iz+1)-z(iz))<a name='1591'>
            vl(iz)=vl(iz)+(1.-vtot*bs(id)/(ws(id)+bs(id)))/nd<a name='1592'>
         enddo<a name='1593'>
      enddo<a name='1594'>
      <a name='1595'>
<font color=#447700>! horizontal surface impact  <a name='1596'></font>
<a name='1597'>
      do id=1,nd<a name='1598'>
      <a name='1599'>
         fact=1./vl(kts)/dz(kts)*ws(id)/(ws(id)+bs(id))/nd<a name='1600'>
         b_t(kts)=b_t(kts)+thb_u(id,1)*fact<a name='1601'>
         b_u(kts)=b_u(kts)+uhb_u(id,1)*fact<a name='1602'>
         b_v(kts)=b_v(kts)+vhb_u(id,1)*fact <a name='1603'>
         b_e(kts)=b_e(kts)+ehb_u(id,1)*fact*(z_u(2)-z_u(1))<a name='1604'>
         <a name='1605'>
         do iz=kts,kte<a name='1606'>
            st=0.<a name='1607'>
            su=0.<a name='1608'>
            sv=0.<a name='1609'>
            se=0.<a name='1610'>
            do iz_u=2,nz_u<a name='1611'>
               if(z(iz).le.z_u(iz_u).and.z(iz+1).gt.z_u(iz_u))then<a name='1612'>
                  st=st+ss(iz_u)*thb_u(id,iz_u)<a name='1613'>
                  su=su+ss(iz_u)*uhb_u(id,iz_u)<a name='1614'>
                  sv=sv+ss(iz_u)*vhb_u(id,iz_u)          <a name='1615'>
                  se=se+ss(iz_u)*ehb_u(id,iz_u)*(z_u(iz_u+1)-z_u(iz_u))<a name='1616'>
               endif<a name='1617'>
            enddo<a name='1618'>
      <a name='1619'>
            fact=bs(id)/(ws(id)+bs(id))/vl(iz)/dz(iz)/nd<a name='1620'>
            b_t(iz)=b_t(iz)+st*fact<a name='1621'>
            b_u(iz)=b_u(iz)+su*fact<a name='1622'>
            b_v(iz)=b_v(iz)+sv*fact<a name='1623'>
            b_e(iz)=b_e(iz)+se*fact<a name='1624'>
         enddo<a name='1625'>
      enddo              <a name='1626'>
<a name='1627'>
<font color=#447700>! vertical surface impact<a name='1628'></font>
           <a name='1629'>
      do iz=kts,kte <a name='1630'>
         uet(iz)=0.<a name='1631'>
         do id=1,nd              <a name='1632'>
            vtb=0.<a name='1633'>
            vta=0.<a name='1634'>
            vua=0.<a name='1635'>
            vub=0.<a name='1636'>
            vva=0.<a name='1637'>
            vvb=0.<a name='1638'>
            veb=0.<a name='1639'>
	    vte=0.<a name='1640'>
            do iz_u=1,nz_u<a name='1641'>
               dzz=max(min(z_u(iz_u+1),z(iz+1))-max(z_u(iz_u),z(iz)),0.)<a name='1642'>
               fact=dzz/(ws(id)+bs(id))<a name='1643'>
               vtb=vtb+pb(iz_u+1)*                                  &amp;        <a name='1644'>
                    (tvb_u(2*id-1,iz_u)+tvb_u(2*id,iz_u))*fact   <a name='1645'>
               vta=vta+pb(iz_u+1)*                                  &amp;        <a name='1646'>
                   (tva_u(2*id-1,iz_u)+tva_u(2*id,iz_u))*fact<a name='1647'>
               vua=vua+pb(iz_u+1)*                                  &amp;        <a name='1648'>
                    (uva_u(2*id-1,iz_u)+uva_u(2*id,iz_u))*fact<a name='1649'>
               vva=vva+pb(iz_u+1)*                                  &amp;        <a name='1650'>
                    (vva_u(2*id-1,iz_u)+vva_u(2*id,iz_u))*fact<a name='1651'>
               vub=vub+pb(iz_u+1)*                                  &amp;        <a name='1652'>
                    (uvb_u(2*id-1,iz_u)+uvb_u(2*id,iz_u))*fact<a name='1653'>
               vvb=vvb+pb(iz_u+1)*                                  &amp;        <a name='1654'>
                    (vvb_u(2*id-1,iz_u)+vvb_u(2*id,iz_u))*fact<a name='1655'>
               veb=veb+pb(iz_u+1)*                                  &amp;        <a name='1656'>
                    (evb_u(2*id-1,iz_u)+evb_u(2*id,iz_u))*fact<a name='1657'>
            enddo<a name='1658'>
           <a name='1659'>
            fact=1./vl(iz)/dz(iz)/nd<a name='1660'>
            b_t(iz)=b_t(iz)+vtb*fact<a name='1661'>
            a_t(iz)=a_t(iz)+vta*fact<a name='1662'>
            a_u(iz)=a_u(iz)+vua*fact<a name='1663'>
            a_v(iz)=a_v(iz)+vva*fact<a name='1664'>
            b_u(iz)=b_u(iz)+vub*fact<a name='1665'>
            b_v(iz)=b_v(iz)+vvb*fact<a name='1666'>
            b_e(iz)=b_e(iz)+veb*fact<a name='1667'>
            uet(iz)=uet(iz)+vte*fact<a name='1668'>
         enddo              <a name='1669'>
      enddo<a name='1670'>
      <a name='1671'>
<a name='1672'>
      <a name='1673'>
      return<a name='1674'>
      end subroutine urban_meso<a name='1675'>
<a name='1676'>
<font color=#447700>! ===6=8===============================================================72 <a name='1677'></font>
<a name='1678'>
<font color=#447700>! ===6=8===============================================================72 <a name='1679'></font>
<a name='1680'>
<A NAME='INTERP_LENGTH'><A href='../../html_code/phys/module_sf_bep.F.html#INTERP_LENGTH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1681'>
      <font color=#993300>subroutine </font><font color=#cc0000>interp_length</font>(nd,kms,kme,kts,kte,nz_u,z_u,z,ss,ws,bs,              &amp; <A href='../../call_to/INTERP_LENGTH.html' TARGET='index'>2</A><a name='1682'>
                             dlg,dl_u)<a name='1683'>
<a name='1684'>
<font color=#447700>! ----------------------------------------------------------------------     <a name='1685'></font>
<font color=#447700>!    Calculation of the length scales<a name='1686'></font>
<font color=#447700>!    See p272-274 formula (22) and (24) of the BLM paper    <a name='1687'></font>
<font color=#447700>! ----------------------------------------------------------------------     <a name='1688'></font>
     <a name='1689'>
      implicit none<a name='1690'>
<a name='1691'>
<a name='1692'>
<font color=#447700>! ----------------------------------------------------------------------     <a name='1693'></font>
<font color=#447700>! INPUT:<a name='1694'></font>
<font color=#447700>! ----------------------------------------------------------------------     <a name='1695'></font>
      integer kms,kme,kts,kte                <a name='1696'>
      real z(kms:kme)              <font color=#447700>! Altitude above the ground of the cell interface<a name='1697'></font>
      integer nd                <font color=#447700>! Number of street direction for the current urban class<a name='1698'></font>
      integer nz_u              <font color=#447700>! Number of levels in the "urban grid"<a name='1699'></font>
      real z_u(nz_um)         <font color=#447700>! Height of the urban grid levels<a name='1700'></font>
      real bs(ndm)              <font color=#447700>! Building widths of the current urban class<a name='1701'></font>
      real ss(nz_um)          <font color=#447700>! Probability to have a building with height h<a name='1702'></font>
      real ws(ndm)              <font color=#447700>! Street widths of the current urban class<a name='1703'></font>
<a name='1704'>
<a name='1705'>
<font color=#447700>! ----------------------------------------------------------------------     <a name='1706'></font>
<font color=#447700>! OUTPUT:<a name='1707'></font>
<font color=#447700>! ----------------------------------------------------------------------     <a name='1708'></font>
      real dlg(kms:kme)              <font color=#447700>! Height above ground (L_ground in formula (24) of the BLM paper). <a name='1709'></font>
      real dl_u(kms:kme)             <font color=#447700>! Length scale (lb in formula (22) ofthe BLM paper).<a name='1710'></font>
<a name='1711'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1712'></font>
<font color=#447700>! LOCAL:<a name='1713'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1714'></font>
      real dlgtmp<a name='1715'>
      integer id,iz,iz_u<a name='1716'>
      real sftot<a name='1717'>
      real ulu,ssl<a name='1718'>
<a name='1719'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1720'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='1721'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1722'></font>
   <a name='1723'>
        do iz=kts,kte<a name='1724'>
         ulu=0.<a name='1725'>
         ssl=0.<a name='1726'>
         do id=1,nd        <a name='1727'>
          do iz_u=2,nz_u<a name='1728'>
           if(z_u(iz_u).gt.z(iz))then<a name='1729'>
            ulu=ulu+ss(iz_u)/z_u(iz_u)/nd<a name='1730'>
            ssl=ssl+ss(iz_u)/nd<a name='1731'>
           endif<a name='1732'>
          enddo<a name='1733'>
         enddo<a name='1734'>
<a name='1735'>
        if(ulu.ne.0)then<a name='1736'>
          dl_u(iz)=ssl/ulu<a name='1737'>
         else<a name='1738'>
          dl_u(iz)=0.<a name='1739'>
         endif<a name='1740'>
        enddo<a name='1741'>
       <a name='1742'>
<a name='1743'>
        do iz=kts,kte<a name='1744'>
         dlg(iz)=0.<a name='1745'>
          do id=1,nd<a name='1746'>
           sftot=ws(id)  <a name='1747'>
           dlgtmp=ws(id)/((z(iz)+z(iz+1))/2.)<a name='1748'>
           do iz_u=1,nz_u<a name='1749'>
            if((z(iz)+z(iz+1))/2..gt.z_u(iz_u))then<a name='1750'>
             dlgtmp=dlgtmp+ss(iz_u)*bs(id)/                           &amp;                <a name='1751'>
                    ((z(iz)+z(iz+1))/2.-z_u(iz_u))<a name='1752'>
             sftot=sftot+ss(iz_u)*bs(id)<a name='1753'>
            endif<a name='1754'>
           enddo<a name='1755'>
           dlg(iz)=dlg(iz)+dlgtmp/sftot/nd<a name='1756'>
         enddo<a name='1757'>
         dlg(iz)=1./dlg(iz)<a name='1758'>
        enddo<a name='1759'>
        <a name='1760'>
       return<a name='1761'>
       end subroutine interp_length<a name='1762'>
<a name='1763'>
<font color=#447700>! ===6=8===============================================================72<a name='1764'></font>
<font color=#447700>! ===6=8===============================================================72   <a name='1765'></font>
<a name='1766'>
<A NAME='SHADOW_MAS'><A href='../../html_code/phys/module_sf_bep.F.html#SHADOW_MAS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1767'>
      <font color=#993300>subroutine </font><font color=#cc0000>shadow_mas</font>(nd,nz_u,zr,deltar,ah,drst,ws,ss,pb,z,         &amp; <A href='../../call_to/SHADOW_MAS.html' TARGET='index'>2</A>,<A href='../../call_from/SHADOW_MAS.html' TARGET='index'>4</A><a name='1768'>
                           rs,rsw,rsg)<a name='1769'>
        <a name='1770'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1771'></font>
<font color=#447700>!         Modification of short wave radiation to take into account<a name='1772'></font>
<font color=#447700>!         the shadow produced by the buildings<a name='1773'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1774'></font>
<a name='1775'>
      implicit none<a name='1776'>
     <a name='1777'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1778'></font>
<font color=#447700>! INPUT:<a name='1779'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1780'></font>
      integer nd                <font color=#447700>! Number of street direction for the current urban class<a name='1781'></font>
      integer nz_u              <font color=#447700>! number of vertical layers defined in the urban grid<a name='1782'></font>
      real ah                   <font color=#447700>! Hour angle (it should come from the radiation routine)<a name='1783'></font>
      real deltar               <font color=#447700>! Declination of the sun<a name='1784'></font>
      real drst(ndm)            <font color=#447700>! street directions for the current urban class<a name='1785'></font>
      real rs                   <font color=#447700>! solar radiation<a name='1786'></font>
      real ss(nz_um)          <font color=#447700>! probability to have a building with height h<a name='1787'></font>
      real pb(nz_um)          <font color=#447700>! Probability that a building has an height greater or equal to h<a name='1788'></font>
      real ws(ndm)              <font color=#447700>! Street width of the current urban class<a name='1789'></font>
      real z(nz_um)           <font color=#447700>! Height of the urban grid levels<a name='1790'></font>
      real zr                   <font color=#447700>! zenith angle<a name='1791'></font>
<a name='1792'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1793'></font>
<font color=#447700>! OUTPUT:<a name='1794'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1795'></font>
      real rsg(ndm)             <font color=#447700>! Short wave radiation at the ground<a name='1796'></font>
      real rsw(2*ndm,nz_um)     <font color=#447700>! Short wave radiation at the walls<a name='1797'></font>
<a name='1798'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1799'></font>
<font color=#447700>! LOCAL:<a name='1800'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1801'></font>
      integer id,iz,jz<a name='1802'>
      real aae,aaw,bbb,phix,rd,rtot,wsd<a name='1803'>
      <a name='1804'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1805'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='1806'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1807'></font>
<a name='1808'>
      if(rs.eq.0.or.sin(zr).eq.1)then<a name='1809'>
         do id=1,nd<a name='1810'>
            rsg(id)=0.<a name='1811'>
            do iz=1,nz_u<a name='1812'>
               rsw(2*id-1,iz)=0.<a name='1813'>
               rsw(2*id,iz)=0.<a name='1814'>
            enddo<a name='1815'>
         enddo<a name='1816'>
      else            <a name='1817'>
<font color=#447700>!test              <a name='1818'></font>
         if(abs(sin(zr)).gt.1.e-10)then<a name='1819'>
          if(cos(deltar)*sin(ah)/sin(zr).ge.1)then<a name='1820'>
           bbb=pi/2.<a name='1821'>
          elseif(cos(deltar)*sin(ah)/sin(zr).le.-1)then<a name='1822'>
           bbb=-pi/2.<a name='1823'>
          else<a name='1824'>
           bbb=asin(cos(deltar)*sin(ah)/sin(zr))<a name='1825'>
          endif<a name='1826'>
         else<a name='1827'>
          if(cos(deltar)*sin(ah).ge.0)then<a name='1828'>
           bbb=pi/2.<a name='1829'>
          elseif(cos(deltar)*sin(ah).lt.0)then<a name='1830'>
           bbb=-pi/2.<a name='1831'>
          endif<a name='1832'>
         endif<a name='1833'>
<a name='1834'>
         phix=zr<a name='1835'>
           <a name='1836'>
         do id=1,nd<a name='1837'>
        <a name='1838'>
            rsg(id)=0.<a name='1839'>
           <a name='1840'>
            aae=bbb-drst(id)<a name='1841'>
            aaw=bbb-drst(id)+pi<a name='1842'>
                    <a name='1843'>
            do iz=1,nz_u<a name='1844'>
               rsw(2*id-1,iz)=0.<a name='1845'>
               rsw(2*id,iz)=0.          <a name='1846'>
            if(pb(iz+1).gt.0.)then           <a name='1847'>
               do jz=1,nz_u                    <a name='1848'>
                if(abs(sin(aae)).gt.1.e-10)then<a name='1849'>
                  call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SHADE_WALL'>shade_wall</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#SHADOW_MAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHADE_WALL_1">(z(iz),z(iz+1),z(jz+1),phix,aae,   &amp;    <a name='1850'>
                      ws(id),rd)                  <a name='1851'>
                  rsw(2*id-1,iz)=rsw(2*id-1,iz)+rs*rd*ss(jz+1)/pb(iz+1)<a name='1852'>
                endif<a name='1853'>
              <a name='1854'>
                if(abs(sin(aaw)).gt.1.e-10)then<a name='1855'>
                  call <A href='../../html_code/phys/module_sf_bep_bem.F.html#SHADE_WALL'>shade_wall</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#SHADOW_MAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHADE_WALL_2">(z(iz),z(iz+1),z(jz+1),phix,aaw,   &amp;    <a name='1856'>
                      ws(id),rd)<a name='1857'>
                  rsw(2*id,iz)=rsw(2*id,iz)+rs*rd*ss(jz+1)/pb(iz+1)                  <a name='1858'>
                endif<a name='1859'>
               enddo             <a name='1860'>
            endif  <a name='1861'>
            enddo<a name='1862'>
        if(abs(sin(aae)).gt.1.e-10)then<a name='1863'>
            wsd=abs(ws(id)/sin(aae))<a name='1864'>
              <a name='1865'>
            do jz=1,nz_u           <a name='1866'>
               rd=max(0.,wsd-z(jz+1)*tan(phix))<a name='1867'>
               rsg(id)=rsg(id)+rs*rd*ss(jz+1)/wsd          <a name='1868'>
            enddo<a name='1869'>
            rtot=0.<a name='1870'>
           <a name='1871'>
            do iz=1,nz_u<a name='1872'>
               rtot=rtot+(rsw(2*id,iz)+rsw(2*id-1,iz))*            &amp;<a name='1873'>
                         (z(iz+1)-z(iz))<a name='1874'>
            enddo<a name='1875'>
            rtot=rtot+rsg(id)*ws(id)<a name='1876'>
        else<a name='1877'>
            rsg(id)=rs<a name='1878'>
        endif<a name='1879'>
            <a name='1880'>
         enddo<a name='1881'>
      endif<a name='1882'>
         <a name='1883'>
      return<a name='1884'>
      end subroutine shadow_mas<a name='1885'>
         <a name='1886'>
<font color=#447700>! ===6=8===============================================================72     <a name='1887'></font>
<font color=#447700>! ===6=8===============================================================72     <a name='1888'></font>
<a name='1889'>
<A NAME='SHADE_WALL'><A href='../../html_code/phys/module_sf_bep.F.html#SHADE_WALL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1890'>
      <font color=#993300>subroutine </font><font color=#cc0000>shade_wall</font>(z1,z2,hu,phix,aa,ws,rd) <A href='../../call_to/SHADE_WALL.html' TARGET='index'>4</A><a name='1891'>
<a name='1892'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1893'></font>
<font color=#447700>! This routine computes the effects of a shadow induced by a building of <a name='1894'></font>
<font color=#447700>! height hu, on a portion of wall between z1 and z2. See equation A10, <a name='1895'></font>
<font color=#447700>! and correction described below formula A11, and figure A1. Basically rd<a name='1896'></font>
<font color=#447700>! is the ratio between the horizontal surface illuminated and the portion<a name='1897'></font>
<font color=#447700>! of wall. Referring to figure A1, multiplying radiation flux density on <a name='1898'></font>
<font color=#447700>! a horizontal surface (rs) by x1-x2 we have the radiation energy per <a name='1899'></font>
<font color=#447700>! unit time. Dividing this by z2-z1, we obtain the radiation flux <a name='1900'></font>
<font color=#447700>! density reaching the portion of the wall between z2 and z1 <a name='1901'></font>
<font color=#447700>! (everything is assumed in 2D)<a name='1902'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1903'></font>
<a name='1904'>
      implicit none<a name='1905'>
      <a name='1906'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1907'></font>
<font color=#447700>! INPUT:<a name='1908'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1909'></font>
      real aa                   <font color=#447700>! Angle between the sun direction and the face of the wall (A12)<a name='1910'></font>
      real hu                   <font color=#447700>! Height of the building that generates the shadow<a name='1911'></font>
      real phix                 <font color=#447700>! Solar zenith angle<a name='1912'></font>
      real ws                   <font color=#447700>! Width of the street<a name='1913'></font>
      real z1                   <font color=#447700>! Height of the level z(iz)<a name='1914'></font>
      real z2                   <font color=#447700>! Height of the level z(iz+1)<a name='1915'></font>
<a name='1916'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1917'></font>
<font color=#447700>! OUTPUT:<a name='1918'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1919'></font>
      real rd                   <font color=#447700>! Ratio between (x1-x2)/(z2-z1), see Fig. 1A. <a name='1920'></font>
                                <font color=#447700>! Multiplying rd by rs (radiation flux <a name='1921'></font>
                                <font color=#447700>! density on a horizontal surface) gives <a name='1922'></font>
                                <font color=#447700>! the radiation flux density on the <a name='1923'></font>
                                <font color=#447700>! portion of wall between z1 and z2. <a name='1924'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1925'></font>
<font color=#447700>! LOCAL:<a name='1926'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1927'></font>
      real x1,x2                <font color=#447700>! x1,x2 see Fig. A1.<a name='1928'></font>
<a name='1929'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1930'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='1931'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1932'></font>
<a name='1933'>
      x1=min((hu-z1)*tan(phix),max(0.,ws/sin(aa)))<a name='1934'>
      <a name='1935'>
      x2=max((hu-z2)*tan(phix),0.)<a name='1936'>
<a name='1937'>
      rd=max(0.,sin(aa)*(max(0.,x1-x2))/(z2-z1))<a name='1938'>
      <a name='1939'>
      return<a name='1940'>
      end subroutine shade_wall<a name='1941'>
<a name='1942'>
<font color=#447700>! ===6=8===============================================================72     <a name='1943'></font>
<font color=#447700>! ===6=8===============================================================72     <a name='1944'></font>
<a name='1945'>
<A NAME='LONG_RAD'><A href='../../html_code/phys/module_sf_bep.F.html#LONG_RAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1946'>
      <font color=#993300>subroutine </font><font color=#cc0000>long_rad</font>(iurb,nz_u,id,emw,emg,                  &amp; <A href='../../call_to/LONG_RAD.html' TARGET='index'>2</A>,<A href='../../call_from/LONG_RAD.html' TARGET='index'>2</A><a name='1947'>
                         fwg,fww,fgw,fsw,fsg,tg,tw,rlg,rlw,rl,pb)<a name='1948'>
<a name='1949'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1950'></font>
<font color=#447700>! This routine computes the effects of the reflections of long-wave <a name='1951'></font>
<font color=#447700>! radiation in the street canyon by solving the system <a name='1952'></font>
<font color=#447700>! of 2*nz_u+1 eqn. in 2*nz_u+1<a name='1953'></font>
<font color=#447700>! unkonwn defined in A4, A5 and A6 of the paper (pages 295 and 296).<a name='1954'></font>
<font color=#447700>! The system is solved by solving A X= B,<a name='1955'></font>
<font color=#447700>! with A matrix B vector, and X solution. <a name='1956'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1957'></font>
<a name='1958'>
      implicit none<a name='1959'>
<a name='1960'>
  <a name='1961'>
      <a name='1962'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1963'></font>
<font color=#447700>! INPUT:<a name='1964'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1965'></font>
      real emg                        <font color=#447700>! Emissivity of ground for the current urban class<a name='1966'></font>
      real emw                        <font color=#447700>! Emissivity of wall for the current urban class<a name='1967'></font>
      real fgw(nz_um,ndm,nurbm)       <font color=#447700>! View factors from ground to wall<a name='1968'></font>
      real fsg(ndm,nurbm)             <font color=#447700>! View factors from sky to ground<a name='1969'></font>
      real fsw(nz_um,ndm,nurbm)       <font color=#447700>! View factors from sky to wall<a name='1970'></font>
      real fwg(nz_um,ndm,nurbm)       <font color=#447700>! View factors from wall to ground<a name='1971'></font>
      real fww(nz_um,nz_um,ndm,nurbm) <font color=#447700>! View factors from wall to wall<a name='1972'></font>
      integer id                      <font color=#447700>! Current street direction<a name='1973'></font>
      integer iurb                    <font color=#447700>! Current urban class<a name='1974'></font>
      integer nz_u                    <font color=#447700>! Number of layer in the urban grid<a name='1975'></font>
      real pb(nz_um)                <font color=#447700>! Probability to have a building with an height equal<a name='1976'></font>
      real rl                         <font color=#447700>! Downward flux of the longwave radiation<a name='1977'></font>
      real tg(ndm,ng_u)               <font color=#447700>! Temperature in each layer of the ground [K]<a name='1978'></font>
      real tw(2*ndm,nz_um,nwr_u)       <font color=#447700>! Temperature in each layer of the wall [K]<a name='1979'></font>
      <a name='1980'>
<a name='1981'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1982'></font>
<font color=#447700>! OUTPUT:<a name='1983'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1984'></font>
      real rlg(ndm)                   <font color=#447700>! Long wave radiation at the ground<a name='1985'></font>
      real rlw(2*ndm,nz_um)           <font color=#447700>! Long wave radiation at the walls<a name='1986'></font>
<a name='1987'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1988'></font>
<font color=#447700>! LOCAL:<a name='1989'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1990'></font>
      integer i,j<a name='1991'>
      real aaa(2*nz_um+1,2*nz_um+1)   <font color=#447700>! terms of the matrix<a name='1992'></font>
      real bbb(2*nz_um+1)             <font color=#447700>! terms of the vector<a name='1993'></font>
<a name='1994'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1995'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='1996'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1997'></font>
<a name='1998'>
<a name='1999'>
<font color=#447700>! west wall<a name='2000'></font>
       <a name='2001'>
      do i=1,nz_u<a name='2002'>
        <a name='2003'>
        do j=1,nz_u<a name='2004'>
         aaa(i,j)=0.<a name='2005'>
        enddo<a name='2006'>
        <a name='2007'>
        aaa(i,i)=1.        <a name='2008'>
       <a name='2009'>
        do j=nz_u+1,2*nz_u<a name='2010'>
         aaa(i,j)=-(1.-emw)*fww(j-nz_u,i,id,iurb)*pb(j-nz_u+1)<a name='2011'>
        enddo<a name='2012'>
        <a name='2013'>
<font color=#447700>!!      aaa(i,2*nz_u+1)=-(1.-emg)*fgw(i,id,iurb)*pb(i+1)<a name='2014'></font>
        aaa(i,2*nz_u+1)=-(1.-emg)*fgw(i,id,iurb)<a name='2015'>
        <a name='2016'>
        bbb(i)=fsw(i,id,iurb)*rl+emg*fgw(i,id,iurb)*sigma*tg(id,ng_u)**4<a name='2017'>
        do j=1,nz_u<a name='2018'>
         bbb(i)=bbb(i)+pb(j+1)*emw*sigma*fww(j,i,id,iurb)*       &amp;<a name='2019'>
               tw(2*id,j,nwr_u)**4+                              &amp;<a name='2020'>
               fww(j,i,id,iurb)*rl*(1.-pb(j+1))<a name='2021'>
        enddo<a name='2022'>
        <a name='2023'>
       enddo<a name='2024'>
       <a name='2025'>
<font color=#447700>! east wall<a name='2026'></font>
<a name='2027'>
       do i=1+nz_u,2*nz_u<a name='2028'>
        <a name='2029'>
        do j=1,nz_u<a name='2030'>
         aaa(i,j)=-(1.-emw)*fww(j,i-nz_u,id,iurb)*pb(j+1)<a name='2031'>
        enddo<a name='2032'>
        <a name='2033'>
        do j=1+nz_u,2*nz_u<a name='2034'>
         aaa(i,j)=0.<a name='2035'>
        enddo<a name='2036'>
        <a name='2037'>
        aaa(i,i)=1.<a name='2038'>
        <a name='2039'>
<font color=#447700>!!      aaa(i,2*nz_u+1)=-(1.-emg)*fgw(i-nz_u,id,iurb)*pb(i-nz_u+1)<a name='2040'></font>
        aaa(i,2*nz_u+1)=-(1.-emg)*fgw(i-nz_u,id,iurb)<a name='2041'>
        <a name='2042'>
        bbb(i)=fsw(i-nz_u,id,iurb)*rl+                           &amp;     <a name='2043'>
              emg*fgw(i-nz_u,id,iurb)*sigma*tg(id,ng_u)**4<a name='2044'>
<a name='2045'>
        do j=1,nz_u<a name='2046'>
         bbb(i)=bbb(i)+pb(j+1)*emw*sigma*fww(j,i-nz_u,id,iurb)*  &amp;   <a name='2047'>
                tw(2*id-1,j,nwr_u)**4+                           &amp;   <a name='2048'>
                fww(j,i-nz_u,id,iurb)*rl*(1.-pb(j+1))<a name='2049'>
        enddo<a name='2050'>
       <a name='2051'>
       enddo<a name='2052'>
<a name='2053'>
<font color=#447700>! ground<a name='2054'></font>
       do j=1,nz_u<a name='2055'>
        aaa(2*nz_u+1,j)=-(1.-emw)*fwg(j,id,iurb)*pb(j+1)<a name='2056'>
       enddo<a name='2057'>
       <a name='2058'>
       do j=nz_u+1,2*nz_u<a name='2059'>
        aaa(2*nz_u+1,j)=-(1.-emw)*fwg(j-nz_u,id,iurb)*pb(j-nz_u+1)<a name='2060'>
       enddo<a name='2061'>
       <a name='2062'>
       aaa(2*nz_u+1,2*nz_u+1)=1.<a name='2063'>
       <a name='2064'>
       bbb(2*nz_u+1)=fsg(id,iurb)*rl<a name='2065'>
       <a name='2066'>
       do i=1,nz_u<a name='2067'>
        bbb(2*nz_u+1)=bbb(2*nz_u+1)+emw*sigma*fwg(i,id,iurb)*pb(i+1)*    &amp;<a name='2068'>
                      (tw(2*id-1,i,nwr_u)**4+tw(2*id,i,nwr_u)**4)+       &amp;<a name='2069'>
                      2.*fwg(i,id,iurb)*(1.-pb(i+1))*rl                  <a name='2070'>
       enddo<a name='2071'>
   <a name='2072'>
<a name='2073'>
     <a name='2074'>
       call <A href='../../html_code/phys/module_sf_bep_bem.F.html#GAUSSJ'>gaussj</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#LONG_RAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAUSSJ_1">(aaa,2*nz_u+1,bbb,2*nz_um+1)<a name='2075'>
<a name='2076'>
       do i=1,nz_u<a name='2077'>
        rlw(2*id-1,i)=bbb(i)<a name='2078'>
       enddo<a name='2079'>
       <a name='2080'>
       do i=nz_u+1,2*nz_u<a name='2081'>
        rlw(2*id,i-nz_u)=bbb(i)<a name='2082'>
       enddo<a name='2083'>
       <a name='2084'>
       rlg(id)=bbb(2*nz_u+1)<a name='2085'>
  <a name='2086'>
       return<a name='2087'>
       end subroutine long_rad<a name='2088'>
             <a name='2089'>
<font color=#447700>! ===6=8===============================================================72<a name='2090'></font>
<font color=#447700>! ===6=8===============================================================72<a name='2091'></font>
<a name='2092'>
<A NAME='SHORT_RAD'><A href='../../html_code/phys/module_sf_bep.F.html#SHORT_RAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2093'>
       <font color=#993300>subroutine </font><font color=#cc0000>short_rad</font>(iurb,nz_u,id,albw,                        &amp;  <A href='../../call_to/SHORT_RAD.html' TARGET='index'>2</A>,<A href='../../call_from/SHORT_RAD.html' TARGET='index'>2</A><a name='2094'>
                           albg,fwg,fww,fgw,rsg,rsw,pb)<a name='2095'>
<a name='2096'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2097'></font>
<font color=#447700>! This routine computes the effects of the reflections of short-wave <a name='2098'></font>
<font color=#447700>! (solar) radiation in the street canyon by solving the system <a name='2099'></font>
<font color=#447700>! of 2*nz_u+1 eqn. in 2*nz_u+1<a name='2100'></font>
<font color=#447700>! unkonwn defined in A4, A5 and A6 of the paper (pages 295 and 296).<a name='2101'></font>
<font color=#447700>! The system is solved by solving A X= B,<a name='2102'></font>
<font color=#447700>! with A matrix B vector, and X solution. <a name='2103'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2104'></font>
<a name='2105'>
      implicit none<a name='2106'>
<a name='2107'>
  <a name='2108'>
      <a name='2109'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2110'></font>
<font color=#447700>! INPUT:<a name='2111'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2112'></font>
      real albg                 <font color=#447700>! Albedo of the ground for the current urban class<a name='2113'></font>
      real albw                 <font color=#447700>! Albedo of the wall for the current urban class<a name='2114'></font>
      real fgw(nz_um,ndm,nurbm)       <font color=#447700>! View factors from ground to wall<a name='2115'></font>
      real fwg(nz_um,ndm,nurbm)       <font color=#447700>! View factors from wall to ground<a name='2116'></font>
      real fww(nz_um,nz_um,ndm,nurbm) <font color=#447700>! View factors from wall to wall<a name='2117'></font>
      integer id                <font color=#447700>! current street direction <a name='2118'></font>
      integer iurb              <font color=#447700>! current urban class<a name='2119'></font>
      integer nz_u              <font color=#447700>! Number of layer in the urban grid<a name='2120'></font>
      real pb(nz_um)          <font color=#447700>! probability to have a building with an height equal<a name='2121'></font>
<a name='2122'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2123'></font>
<font color=#447700>! OUTPUT:<a name='2124'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2125'></font>
      real rsg(ndm)             <font color=#447700>! Short wave radiation at the ground<a name='2126'></font>
      real rsw(2*ndm,nz_um)     <font color=#447700>! Short wave radiation at the walls<a name='2127'></font>
<a name='2128'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2129'></font>
<font color=#447700>! LOCAL:<a name='2130'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2131'></font>
      integer i,j<a name='2132'>
      real aaa(2*nz_um+1,2*nz_um+1)  <font color=#447700>! terms of the matrix<a name='2133'></font>
      real bbb(2*nz_um+1)            <font color=#447700>! terms of the vector<a name='2134'></font>
<a name='2135'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2136'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='2137'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2138'></font>
<a name='2139'>
      <a name='2140'>
<font color=#447700>! west wall<a name='2141'></font>
       <a name='2142'>
      do i=1,nz_u<a name='2143'>
         do j=1,nz_u<a name='2144'>
            aaa(i,j)=0.<a name='2145'>
         enddo<a name='2146'>
         <a name='2147'>
         aaa(i,i)=1.        <a name='2148'>
         <a name='2149'>
         do j=nz_u+1,2*nz_u<a name='2150'>
            aaa(i,j)=-albw*fww(j-nz_u,i,id,iurb)*pb(j-nz_u+1)<a name='2151'>
         enddo<a name='2152'>
         <a name='2153'>
         aaa(i,2*nz_u+1)=-albg*fgw(i,id,iurb)<a name='2154'>
         bbb(i)=rsw(2*id-1,i)<a name='2155'>
         <a name='2156'>
      enddo<a name='2157'>
       <a name='2158'>
<font color=#447700>! east wall<a name='2159'></font>
<a name='2160'>
      do i=1+nz_u,2*nz_u<a name='2161'>
         do j=1,nz_u<a name='2162'>
            aaa(i,j)=-albw*fww(j,i-nz_u,id,iurb)*pb(j+1)<a name='2163'>
         enddo<a name='2164'>
         <a name='2165'>
         do j=1+nz_u,2*nz_u<a name='2166'>
            aaa(i,j)=0.<a name='2167'>
         enddo<a name='2168'>
         <a name='2169'>
        aaa(i,i)=1.<a name='2170'>
        aaa(i,2*nz_u+1)=-albg*fgw(i-nz_u,id,iurb)<a name='2171'>
        bbb(i)=rsw(2*id,i-nz_u)<a name='2172'>
        <a name='2173'>
      enddo<a name='2174'>
<a name='2175'>
<font color=#447700>! ground<a name='2176'></font>
<a name='2177'>
      do j=1,nz_u<a name='2178'>
         aaa(2*nz_u+1,j)=-albw*fwg(j,id,iurb)*pb(j+1)<a name='2179'>
      enddo<a name='2180'>
       <a name='2181'>
      do j=nz_u+1,2*nz_u<a name='2182'>
         aaa(2*nz_u+1,j)=-albw*fwg(j-nz_u,id,iurb)*pb(j-nz_u+1)<a name='2183'>
      enddo<a name='2184'>
       <a name='2185'>
      aaa(2*nz_u+1,2*nz_u+1)=1.<a name='2186'>
      bbb(2*nz_u+1)=rsg(id)<a name='2187'>
       <a name='2188'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#GAUSSJ'>gaussj</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#SHORT_RAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAUSSJ_2">(aaa,2*nz_u+1,bbb,2*nz_um+1)<a name='2189'>
<a name='2190'>
      do i=1,nz_u<a name='2191'>
         rsw(2*id-1,i)=bbb(i)<a name='2192'>
      enddo<a name='2193'>
       <a name='2194'>
      do i=nz_u+1,2*nz_u<a name='2195'>
         rsw(2*id,i-nz_u)=bbb(i) <a name='2196'>
      enddo<a name='2197'>
       <a name='2198'>
      rsg(id)=bbb(2*nz_u+1)<a name='2199'>
       <a name='2200'>
      return<a name='2201'>
      end subroutine short_rad<a name='2202'>
             <a name='2203'>
<a name='2204'>
<font color=#447700>! ===6=8===============================================================72     <a name='2205'></font>
<font color=#447700>! ===6=8===============================================================72     <a name='2206'></font>
      <a name='2207'>
<A NAME='GAUSSJ'><A href='../../html_code/phys/module_sf_bep.F.html#GAUSSJ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2208'>
      <font color=#993300>subroutine </font><font color=#cc0000>gaussj</font>(a,n,b,np) <A href='../../call_to/GAUSSJ.html' TARGET='index'>4</A>,<A href='../../call_from/GAUSSJ.html' TARGET='index'>4</A><a name='2209'>
<a name='2210'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2211'></font>
<font color=#447700>! This routine solve a linear system of n equations of the form<a name='2212'></font>
<font color=#447700>!              A X = B<a name='2213'></font>
<font color=#447700>!  where  A is a matrix a(i,j)<a name='2214'></font>
<font color=#447700>!         B a vector and X the solution<a name='2215'></font>
<font color=#447700>! In output b is replaced by the solution     <a name='2216'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2217'></font>
<a name='2218'>
      implicit none<a name='2219'>
<a name='2220'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2221'></font>
<font color=#447700>! INPUT:<a name='2222'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2223'></font>
      integer np<a name='2224'>
      real a(np,np)<a name='2225'>
<a name='2226'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2227'></font>
<font color=#447700>! OUTPUT:<a name='2228'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2229'></font>
      real b(np)<a name='2230'>
<a name='2231'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2232'></font>
<font color=#447700>! LOCAL:<a name='2233'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2234'></font>
      integer nmax<a name='2235'>
      parameter (nmax=150)<a name='2236'>
<a name='2237'>
      real big,dum<a name='2238'>
      integer i,icol,irow<a name='2239'>
      integer j,k,l,ll,n<a name='2240'>
      integer ipiv(nmax)<a name='2241'>
      real pivinv<a name='2242'>
<a name='2243'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2244'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='2245'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2246'></font>
       <a name='2247'>
      do j=1,n<a name='2248'>
         ipiv(j)=0.<a name='2249'>
      enddo<a name='2250'>
       <a name='2251'>
      do i=1,n<a name='2252'>
         big=0.<a name='2253'>
         do j=1,n<a name='2254'>
            if(ipiv(j).ne.1)then<a name='2255'>
               do k=1,n<a name='2256'>
                  if(ipiv(k).eq.0)then<a name='2257'>
                     if(abs(a(j,k)).ge.big)then<a name='2258'>
                        big=abs(a(j,k))<a name='2259'>
                        irow=j<a name='2260'>
                        icol=k<a name='2261'>
                     endif<a name='2262'>
                  elseif(ipiv(k).gt.1)then<a name='2263'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#GAUSSJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1134">('singular matrix in gaussj')<a name='2264'>
                  endif<a name='2265'>
               enddo<a name='2266'>
            endif<a name='2267'>
         enddo<a name='2268'>
         <a name='2269'>
         ipiv(icol)=ipiv(icol)+1<a name='2270'>
         <a name='2271'>
         if(irow.ne.icol)then<a name='2272'>
            do l=1,n<a name='2273'>
               dum=a(irow,l)<a name='2274'>
               a(irow,l)=a(icol,l)<a name='2275'>
               a(icol,l)=dum<a name='2276'>
            enddo<a name='2277'>
            <a name='2278'>
            dum=b(irow)<a name='2279'>
            b(irow)=b(icol)<a name='2280'>
            b(icol)=dum<a name='2281'>
          <a name='2282'>
         endif<a name='2283'>
         <a name='2284'>
         if(a(icol,icol).eq.0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#GAUSSJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1135">('singular matrix in gaussj')<a name='2285'>
         <a name='2286'>
         pivinv=1./a(icol,icol)<a name='2287'>
         a(icol,icol)=1<a name='2288'>
         <a name='2289'>
         do l=1,n<a name='2290'>
            a(icol,l)=a(icol,l)*pivinv<a name='2291'>
         enddo<a name='2292'>
         <a name='2293'>
         b(icol)=b(icol)*pivinv<a name='2294'>
         <a name='2295'>
         do ll=1,n<a name='2296'>
            if(ll.ne.icol)then<a name='2297'>
               dum=a(ll,icol)<a name='2298'>
               a(ll,icol)=0.<a name='2299'>
               do l=1,n<a name='2300'>
                  a(ll,l)=a(ll,l)-a(icol,l)*dum<a name='2301'>
               enddo<a name='2302'>
               <a name='2303'>
               b(ll)=b(ll)-b(icol)*dum<a name='2304'>
               <a name='2305'>
            endif<a name='2306'>
         enddo<a name='2307'>
      enddo<a name='2308'>
      <a name='2309'>
      return<a name='2310'>
      end subroutine gaussj<a name='2311'>
         <a name='2312'>
<font color=#447700>! ===6=8===============================================================72     <a name='2313'></font>
<font color=#447700>! ===6=8===============================================================72     <a name='2314'></font>
       <a name='2315'>
<A NAME='SOIL_TEMP'><A href='../../html_code/phys/module_sf_bep.F.html#SOIL_TEMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2316'>
      <font color=#993300>subroutine </font><font color=#cc0000>soil_temp</font>(nz,dz,temp,pt,ala,cs,                       &amp; <A href='../../call_to/SOIL_TEMP.html' TARGET='index'>5</A>,<A href='../../call_from/SOIL_TEMP.html' TARGET='index'>2</A><a name='2317'>
                          rs,rl,press,dt,em,alb,rt,sf,gf)<a name='2318'>
<a name='2319'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2320'></font>
<font color=#447700>! This routine solves the Fourier diffusion equation for heat in <a name='2321'></font>
<font color=#447700>! the material (wall, roof, or ground). Resolution is done implicitely.<a name='2322'></font>
<font color=#447700>! Boundary conditions are: <a name='2323'></font>
<font color=#447700>! - fixed temperature at the interior<a name='2324'></font>
<font color=#447700>! - energy budget at the surface<a name='2325'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2326'></font>
<a name='2327'>
      implicit none<a name='2328'>
<a name='2329'>
     <a name='2330'>
                <a name='2331'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2332'></font>
<font color=#447700>! INPUT:<a name='2333'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2334'></font>
      integer nz                <font color=#447700>! Number of layers<a name='2335'></font>
      real ala(nz)              <font color=#447700>! Thermal diffusivity in each layers [m^2 s^-1] <a name='2336'></font>
      real alb                  <font color=#447700>! Albedo of the surface<a name='2337'></font>
      real cs(nz)               <font color=#447700>! Specific heat of the material [J m^3 K^-1]<a name='2338'></font>
      real dt                   <font color=#447700>! Time step<a name='2339'></font>
      real em                   <font color=#447700>! Emissivity of the surface<a name='2340'></font>
      real press                <font color=#447700>! Pressure at ground level<a name='2341'></font>
      real rl                   <font color=#447700>! Downward flux of the longwave radiation<a name='2342'></font>
      real rs                   <font color=#447700>! Solar radiation<a name='2343'></font>
      real sf                   <font color=#447700>! Sensible heat flux at the surface<a name='2344'></font>
      real temp(nz)             <font color=#447700>! Temperature in each layer [K]<a name='2345'></font>
      real dz(nz)               <font color=#447700>! Layer sizes [m]<a name='2346'></font>
<a name='2347'>
<a name='2348'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2349'></font>
<font color=#447700>! OUTPUT:<a name='2350'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2351'></font>
      real gf                   <font color=#447700>! Heat flux transferred from the surface toward the interior<a name='2352'></font>
      real pt                   <font color=#447700>! Potential temperature at the surface<a name='2353'></font>
      real rt                   <font color=#447700>! Total radiation at the surface (solar+incoming long+outgoing long)<a name='2354'></font>
<a name='2355'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2356'></font>
<font color=#447700>! LOCAL:<a name='2357'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2358'></font>
      integer iz<a name='2359'>
      real a(nz,3)<a name='2360'>
      real alpha<a name='2361'>
      real c(nz)<a name='2362'>
      real cddz(nz+2)<a name='2363'>
      real tsig<a name='2364'>
<a name='2365'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2366'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='2367'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2368'></font>
       <a name='2369'>
      tsig=temp(nz)<a name='2370'>
      alpha=(1.-alb)*rs+em*rl-em*sigma*(tsig**4)+sf<a name='2371'>
<font color=#447700>! Compute cddz=2*cd/dz  <a name='2372'></font>
        <a name='2373'>
      cddz(1)=ala(1)/dz(1)<a name='2374'>
      do iz=2,nz<a name='2375'>
         cddz(iz)=2.*ala(iz)/(dz(iz)+dz(iz-1))<a name='2376'>
      enddo<a name='2377'>
<font color=#447700>!        cddz(nz+1)=ala(nz+1)/dz(nz)<a name='2378'></font>
       <a name='2379'>
      a(1,1)=0.<a name='2380'>
      a(1,2)=1.<a name='2381'>
      a(1,3)=0.<a name='2382'>
      c(1)=temp(1)<a name='2383'>
          <a name='2384'>
      do iz=2,nz-1<a name='2385'>
         a(iz,1)=-cddz(iz)*dt/dz(iz)<a name='2386'>
         a(iz,2)=1+dt*(cddz(iz)+cddz(iz+1))/dz(iz)          <a name='2387'>
         a(iz,3)=-cddz(iz+1)*dt/dz(iz)<a name='2388'>
         c(iz)=temp(iz)<a name='2389'>
      enddo          <a name='2390'>
                     <a name='2391'>
      a(nz,1)=-dt*cddz(nz)/dz(nz)<a name='2392'>
      a(nz,2)=1.+dt*cddz(nz)/dz(nz)<a name='2393'>
      a(nz,3)=0.<a name='2394'>
      c(nz)=temp(nz)+dt*alpha/cs(nz)/dz(nz)<a name='2395'>
<a name='2396'>
      <a name='2397'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#INVERT'>invert</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#SOIL_TEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INVERT_3">(nz,a,c,temp)<a name='2398'>
<a name='2399'>
           <a name='2400'>
      pt=temp(nz)*(press/1.e+5)**(-rcp_u)<a name='2401'>
<a name='2402'>
      rt=(1.-alb)*rs+em*rl-em*sigma*(tsig**4)<a name='2403'>
                        <a name='2404'>
<font color=#447700>!      gf=-cddz(nz)*(temp(nz)-temp(nz-1))*cs(nz)<a name='2405'></font>
       gf=(1.-alb)*rs+em*rl-em*sigma*(tsig**4)+sf                                   <a name='2406'>
      return<a name='2407'>
      end subroutine soil_temp<a name='2408'>
<a name='2409'>
<font color=#447700>! ===6=8===============================================================72 <a name='2410'></font>
<font color=#447700>! ===6=8===============================================================72 <a name='2411'></font>
<a name='2412'>
<A NAME='INVERT'><A href='../../html_code/phys/module_sf_bep.F.html#INVERT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2413'>
      <font color=#993300>subroutine </font><font color=#cc0000>invert</font>(n,a,c,x) <A href='../../call_to/INVERT.html' TARGET='index'>4</A><a name='2414'>
<a name='2415'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2416'></font>
<font color=#447700>!        Inversion and resolution of a tridiagonal matrix<a name='2417'></font>
<font color=#447700>!                   A X = C<a name='2418'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2419'></font>
<a name='2420'>
      implicit none<a name='2421'>
                <a name='2422'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2423'></font>
<font color=#447700>! INPUT:<a name='2424'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2425'></font>
       integer n<a name='2426'>
       real a(n,3)              <font color=#447700>!  a(*,1) lower diagonal (Ai,i-1)<a name='2427'></font>
                                <font color=#447700>!  a(*,2) principal diagonal (Ai,i)<a name='2428'></font>
                                <font color=#447700>!  a(*,3) upper diagonal (Ai,i+1)<a name='2429'></font>
       real c(n)<a name='2430'>
<a name='2431'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2432'></font>
<font color=#447700>! OUTPUT:<a name='2433'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2434'></font>
       real x(n)    <a name='2435'>
<a name='2436'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2437'></font>
<font color=#447700>! LOCAL:<a name='2438'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2439'></font>
       integer i<a name='2440'>
<a name='2441'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2442'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='2443'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2444'></font>
                     <a name='2445'>
       do i=n-1,1,-1                 <a name='2446'>
          c(i)=c(i)-a(i,3)*c(i+1)/a(i+1,2)<a name='2447'>
          a(i,2)=a(i,2)-a(i,3)*a(i+1,1)/a(i+1,2)<a name='2448'>
       enddo<a name='2449'>
       <a name='2450'>
       do i=2,n        <a name='2451'>
          c(i)=c(i)-a(i,1)*c(i-1)/a(i-1,2)<a name='2452'>
       enddo<a name='2453'>
        <a name='2454'>
       do i=1,n<a name='2455'>
          x(i)=c(i)/a(i,2)<a name='2456'>
       enddo<a name='2457'>
<a name='2458'>
       return<a name='2459'>
       end subroutine invert<a name='2460'>
  <a name='2461'>
<a name='2462'>
<font color=#447700>! ===6=8===============================================================72  <a name='2463'></font>
<font color=#447700>! ===6=8===============================================================72<a name='2464'></font>
  <a name='2465'>
<A NAME='FLUX_WALL'><A href='../../html_code/phys/module_sf_bep.F.html#FLUX_WALL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2466'>
      <font color=#993300>subroutine </font><font color=#cc0000>flux_wall</font>(ua,va,pt,da,ptw,uva,vva,uvb,vvb,            &amp; <A href='../../call_to/FLUX_WALL.html' TARGET='index'>4</A><a name='2467'>
                                  tva,tvb,evb,drst,dt)      <a name='2468'>
       <a name='2469'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2470'></font>
<font color=#447700>! This routine computes the surface sources or sinks of momentum, tke,<a name='2471'></font>
<font color=#447700>! and heat from vertical surfaces (walls).   <a name='2472'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2473'></font>
<a name='2474'>
      implicit none<a name='2475'>
<a name='2476'>
    <a name='2477'>
         <a name='2478'>
<font color=#447700>! INPUT:<a name='2479'></font>
<font color=#447700>! -----<a name='2480'></font>
      real drst                 <font color=#447700>! street directions for the current urban class<a name='2481'></font>
      real da                   <font color=#447700>! air density<a name='2482'></font>
      real pt                   <font color=#447700>! potential temperature<a name='2483'></font>
      real ptw                  <font color=#447700>! Walls potential temperatures <a name='2484'></font>
      real ua                   <font color=#447700>! wind speed<a name='2485'></font>
      real va                   <font color=#447700>! wind speed<a name='2486'></font>
<a name='2487'>
      real dt                   <font color=#447700>!time step<a name='2488'></font>
<font color=#447700>! OUTPUT:<a name='2489'></font>
<font color=#447700>! ------<a name='2490'></font>
<font color=#447700>! Explicit and implicit component of the momentum, temperature and TKE sources or sinks on<a name='2491'></font>
<font color=#447700>! vertical surfaces (walls).<a name='2492'></font>
<font color=#447700>! The fluxes can be computed as follow: Fluxes of X = A*X + B<a name='2493'></font>
<font color=#447700>!  Example: Momentum fluxes on vertical surfaces = uva_u * ua_u + uvb_u<a name='2494'></font>
      real uva                  <font color=#447700>! U (wind component)   Vertical surfaces, A (implicit) term<a name='2495'></font>
      real uvb                  <font color=#447700>! U (wind component)   Vertical surfaces, B (explicit) term<a name='2496'></font>
      real vva                  <font color=#447700>! V (wind component)   Vertical surfaces, A (implicit) term<a name='2497'></font>
      real vvb                  <font color=#447700>! V (wind component)   Vertical surfaces, B (explicit) term<a name='2498'></font>
      real tva                  <font color=#447700>! Temperature          Vertical surfaces, A (implicit) term<a name='2499'></font>
      real tvb                  <font color=#447700>! Temperature          Vertical surfaces, B (explicit) term<a name='2500'></font>
      real evb                  <font color=#447700>! Energy (TKE)         Vertical surfaces, B (explicit) term<a name='2501'></font>
<a name='2502'>
<font color=#447700>! LOCAL:<a name='2503'></font>
<font color=#447700>! -----<a name='2504'></font>
      real hc<a name='2505'>
      real u_ort<a name='2506'>
      real vett<a name='2507'>
<a name='2508'>
<font color=#447700>! -------------------------<a name='2509'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='2510'></font>
<font color=#447700>! -------------------------<a name='2511'></font>
<a name='2512'>
      vett=(ua**2+va**2)**.5         <a name='2513'>
         <a name='2514'>
      u_ort=abs((cos(drst)*ua-sin(drst)*va))<a name='2515'>
       <a name='2516'>
      uva=-cdrag*u_ort/2.*cos(drst)*cos(drst)<a name='2517'>
      vva=-cdrag*u_ort/2.*sin(drst)*sin(drst)<a name='2518'>
         <a name='2519'>
      uvb=cdrag*u_ort/2.*sin(drst)*cos(drst)*va<a name='2520'>
      vvb=cdrag*u_ort/2.*sin(drst)*cos(drst)*ua<a name='2521'>
         <a name='2522'>
      hc=5.678*(1.09+0.23*(vett/0.3048))  <a name='2523'>
<a name='2524'>
      if(hc.gt.da*cp_u/dt)then<a name='2525'>
        hc=da*cp_u/dt<a name='2526'>
      endif<a name='2527'>
         <a name='2528'>
<font color=#447700>!         tvb=hc*ptw/da/cp_u<a name='2529'></font>
<font color=#447700>!         tva=-hc/da/cp_u<a name='2530'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!<a name='2531'></font>
<font color=#447700>! explicit <a name='2532'></font>
      tvb=hc*ptw/da/cp_u-hc/da/cp_u*pt <font color=#447700>!c<a name='2533'></font>
      tva = 0.                  <font color=#447700>!c<a name='2534'></font>
         <a name='2535'>
      evb=cdrag*(abs(u_ort)**3.)/2.<a name='2536'>
              <a name='2537'>
      return<a name='2538'>
      end subroutine flux_wall<a name='2539'>
         <a name='2540'>
<font color=#447700>! ===6=8===============================================================72<a name='2541'></font>
<a name='2542'>
<font color=#447700>! ===6=8===============================================================72<a name='2543'></font>
<a name='2544'>
<A NAME='FLUX_FLAT'><A href='../../html_code/phys/module_sf_bep.F.html#FLUX_FLAT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2545'>
      <font color=#993300>subroutine </font><font color=#cc0000>flux_flat</font>(dz,z0,ua,va,pt,pt0,ptg,                     &amp; <A href='../../call_to/FLUX_FLAT.html' TARGET='index'>4</A><a name='2546'>
                          uhb,vhb,thb,ehb)<a name='2547'>
                                <a name='2548'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2549'></font>
<font color=#447700>!           Calculation of the flux at the ground <a name='2550'></font>
<font color=#447700>!           Formulation of Louis (Louis, 1979)       <a name='2551'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2552'></font>
<a name='2553'>
      implicit none<a name='2554'>
<a name='2555'>
     <a name='2556'>
<a name='2557'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2558'></font>
<font color=#447700>! INPUT:<a name='2559'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2560'></font>
      real dz                   <font color=#447700>! first vertical level<a name='2561'></font>
      real pt                   <font color=#447700>! potential temperature<a name='2562'></font>
      real pt0                  <font color=#447700>! reference potential temperature<a name='2563'></font>
      real ptg                  <font color=#447700>! ground potential temperature<a name='2564'></font>
      real ua                   <font color=#447700>! wind speed<a name='2565'></font>
      real va                   <font color=#447700>! wind speed<a name='2566'></font>
      real z0                   <font color=#447700>! Roughness length<a name='2567'></font>
<a name='2568'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2569'></font>
<font color=#447700>! OUTPUT:<a name='2570'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2571'></font>
<font color=#447700>! Explicit component of the momentum, temperature and TKE sources or sinks on horizontal <a name='2572'></font>
<font color=#447700>!  surfaces (roofs and street)<a name='2573'></font>
<font color=#447700>! The fluxes can be computed as follow: Fluxes of X = B<a name='2574'></font>
<font color=#447700>!  Example: Momentum fluxes on horizontal surfaces =  uhb_u<a name='2575'></font>
      real uhb                  <font color=#447700>! U (wind component) Horizontal surfaces, B (explicit) term<a name='2576'></font>
      real vhb                  <font color=#447700>! V (wind component) Horizontal surfaces, B (explicit) term<a name='2577'></font>
      real thb                  <font color=#447700>! Temperature        Horizontal surfaces, B (explicit) term<a name='2578'></font>
      real tva                  <font color=#447700>! Temperature          Vertical surfaces, A (implicit) term<a name='2579'></font>
      real tvb                  <font color=#447700>! Temperature          Vertical surfaces, B (explicit) term<a name='2580'></font>
      real ehb                  <font color=#447700>! Energy (TKE)       Horizontal surfaces, B (explicit) term<a name='2581'></font>
<a name='2582'>
<a name='2583'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2584'></font>
<font color=#447700>! LOCAL:<a name='2585'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2586'></font>
      real aa<a name='2587'>
      real al<a name='2588'>
      real buu<a name='2589'>
      real c<a name='2590'>
      real fbuw<a name='2591'>
      real fbpt<a name='2592'>
      real fh<a name='2593'>
      real fm<a name='2594'>
      real ric<a name='2595'>
      real tstar<a name='2596'>
      real ustar<a name='2597'>
      real utot<a name='2598'>
      real wstar<a name='2599'>
      real zz<a name='2600'>
      <a name='2601'>
      real b,cm,ch,rr,tol<a name='2602'>
      parameter(b=9.4,cm=7.4,ch=5.3,rr=0.74,tol=.001)<a name='2603'>
<a name='2604'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2605'></font>
<font color=#447700>! END VARIABLES DEFINITIONS<a name='2606'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2607'></font>
<a name='2608'>
<a name='2609'>
<font color=#447700>! computation of the ground temperature<a name='2610'></font>
         <a name='2611'>
      utot=(ua**2+va**2)**.5<a name='2612'>
        <a name='2613'>
      <a name='2614'>
<font color=#447700>!!!! Louis formulation<a name='2615'></font>
<font color=#447700>!<a name='2616'></font>
<font color=#447700>! compute the bulk Richardson Number<a name='2617'></font>
<a name='2618'>
      zz=dz/2.<a name='2619'>
   <a name='2620'>
<font color=#447700>!        if(tstar.lt.0.)then<a name='2621'></font>
<font color=#447700>!         wstar=(-ustar*tstar*g*hii/pt)**(1./3.)<a name='2622'></font>
<font color=#447700>!        else<a name='2623'></font>
<font color=#447700>!         wstar=0.<a name='2624'></font>
<font color=#447700>!        endif<a name='2625'></font>
<font color=#447700>!        <a name='2626'></font>
<font color=#447700>!      if (utot.le.0.7*wstar) utot=max(0.7*wstar,0.00001)<a name='2627'></font>
<a name='2628'>
      utot=max(utot,0.01)<a name='2629'>
          <a name='2630'>
      ric=2.*g_u*zz*(pt-ptg)/((pt+ptg)*(utot**2))<a name='2631'>
              <a name='2632'>
      aa=vk/log(zz/z0)<a name='2633'>
<a name='2634'>
<font color=#447700>! determine the parameters fm and fh for stable, neutral and unstable conditions<a name='2635'></font>
<a name='2636'>
      if(ric.gt.0)then<a name='2637'>
         fm=1/(1+0.5*b*ric)**2<a name='2638'>
         fh=fm<a name='2639'>
      else<a name='2640'>
         c=b*cm*aa*aa*(zz/z0)**.5<a name='2641'>
         fm=1-b*ric/(1+c*(-ric)**.5)<a name='2642'>
         c=c*ch/cm<a name='2643'>
         fh=1-b*ric/(1+c*(-ric)**.5)<a name='2644'>
      endif<a name='2645'>
      <a name='2646'>
      fbuw=-aa*aa*utot*utot*fm<a name='2647'>
      fbpt=-aa*aa*utot*(pt-ptg)*fh/rr<a name='2648'>
                     <a name='2649'>
      ustar=(-fbuw)**.5<a name='2650'>
      tstar=-fbpt/ustar<a name='2651'>
<a name='2652'>
      al=(vk*g_u*tstar)/(pt*ustar*ustar)                      <a name='2653'>
      <a name='2654'>
      buu=-g_u/pt0*ustar*tstar<a name='2655'>
       <a name='2656'>
      uhb=-ustar*ustar*ua/utot<a name='2657'>
      vhb=-ustar*ustar*va/utot <a name='2658'>
      thb=-ustar*tstar       <a name='2659'>
<font color=#447700>!      thb= 0.      <a name='2660'></font>
      ehb=buu<a name='2661'>
<font color=#447700>!!!!!!!!!!!!!!!<a name='2662'></font>
         <a name='2663'>
      return<a name='2664'>
      end subroutine flux_flat<a name='2665'>
<a name='2666'>
<font color=#447700>! ===6=8===============================================================72<a name='2667'></font>
<font color=#447700>! ===6=8===============================================================72<a name='2668'></font>
<a name='2669'>
<A NAME='ICBEP'><A href='../../html_code/phys/module_sf_bep.F.html#ICBEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2670'>
      <font color=#993300>subroutine </font><font color=#cc0000>icBEP</font> (nd_u,h_b,d_b,ss_u,pb_u,nz_u,z_u)                                <A href='../../call_to/ICBEP.html' TARGET='index'>2</A><a name='2671'>
<a name='2672'>
      implicit none       <a name='2673'>
        <a name='2674'>
<a name='2675'>
<font color=#447700>!    Street parameters<a name='2676'></font>
      integer nd_u(nurbm)     <font color=#447700>! Number of street direction for each urban class<a name='2677'></font>
      real h_b(nz_um,nurbm)   <font color=#447700>! Bulding's heights [m]<a name='2678'></font>
      real d_b(nz_um,nurbm)   <font color=#447700>! The probability that a building has an height h_b<a name='2679'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='2680'></font>
<font color=#447700>!     Output<a name='2681'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2682'></font>
<a name='2683'>
      real ss_u(nz_um,nurbm)     <font color=#447700>! The probability that a building has an height equal to z<a name='2684'></font>
      real pb_u(nz_um,nurbm)     <font color=#447700>! The probability that a building has an height greater or equal to z<a name='2685'></font>
        <a name='2686'>
<font color=#447700>!    Grid parameters<a name='2687'></font>
      integer nz_u(nurbm)     <font color=#447700>! Number of layer in the urban grid<a name='2688'></font>
      real z_u(nz_um)       <font color=#447700>! Height of the urban grid levels<a name='2689'></font>
<a name='2690'>
<a name='2691'>
<font color=#447700>! -----------------------------------------------------------------------<a name='2692'></font>
<font color=#447700>!     Local<a name='2693'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2694'></font>
<a name='2695'>
      integer iz_u,id,ilu,iurb<a name='2696'>
<a name='2697'>
      real dtot<a name='2698'>
      real hbmax<a name='2699'>
<a name='2700'>
<font color=#447700>!------------------------------------------------------------------------<a name='2701'></font>
     <a name='2702'>
<a name='2703'>
<font color=#447700>! -----------------------------------------------------------------------<a name='2704'></font>
<font color=#447700>!     This routine initialise the urban paramters for the BEP module<a name='2705'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2706'></font>
<font color=#447700>!<a name='2707'></font>
<font color=#447700>!Initialize variables<a name='2708'></font>
<font color=#447700>!<a name='2709'></font>
      z_u=0.<a name='2710'>
      nz_u=0<a name='2711'>
      ss_u=0.<a name='2712'>
      pb_u=0.<a name='2713'>
<a name='2714'>
<font color=#447700>! Computation of the urban levels height<a name='2715'></font>
<a name='2716'>
      z_u(1)=0.<a name='2717'>
     <a name='2718'>
      do iz_u=1,nz_um-1<a name='2719'>
         z_u(iz_u+1)=z_u(iz_u)+dz_u<a name='2720'>
      enddo<a name='2721'>
      <a name='2722'>
<font color=#447700>! Normalisation of the building density<a name='2723'></font>
<a name='2724'>
      do iurb=1,nurbm<a name='2725'>
         dtot=0.<a name='2726'>
         do ilu=1,nz_um<a name='2727'>
            dtot=dtot+d_b(ilu,iurb)<a name='2728'>
         enddo<a name='2729'>
         do ilu=1,nz_um<a name='2730'>
            d_b(ilu,iurb)=d_b(ilu,iurb)/dtot<a name='2731'>
         enddo<a name='2732'>
      enddo      <a name='2733'>
<a name='2734'>
<font color=#447700>! Compute the view factors, pb and ss <a name='2735'></font>
      <a name='2736'>
      do iurb=1,nurbm         <a name='2737'>
         hbmax=0.<a name='2738'>
         nz_u(iurb)=0<a name='2739'>
         do ilu=1,nz_um<a name='2740'>
            if(h_b(ilu,iurb).gt.hbmax)hbmax=h_b(ilu,iurb)<a name='2741'>
         enddo<a name='2742'>
         <a name='2743'>
         do iz_u=1,nz_um-1<a name='2744'>
            if(z_u(iz_u+1).gt.hbmax)go to 10<a name='2745'>
         enddo<a name='2746'>
         <a name='2747'>
 10      continue<a name='2748'>
         nz_u(iurb)=iz_u+1<a name='2749'>
<a name='2750'>
         do id=1,nd_u(iurb)<a name='2751'>
<a name='2752'>
            do iz_u=1,nz_u(iurb)<a name='2753'>
               ss_u(iz_u,iurb)=0.<a name='2754'>
               do ilu=1,nz_um<a name='2755'>
                  if(z_u(iz_u).le.h_b(ilu,iurb)                      &amp;    <a name='2756'>
                    .and.z_u(iz_u+1).gt.h_b(ilu,iurb))then            <a name='2757'>
                        ss_u(iz_u,iurb)=ss_u(iz_u,iurb)+d_b(ilu,iurb)<a name='2758'>
                  endif <a name='2759'>
               enddo<a name='2760'>
            enddo<a name='2761'>
<a name='2762'>
            pb_u(1,iurb)=1.<a name='2763'>
            do iz_u=1,nz_u(iurb)<a name='2764'>
               pb_u(iz_u+1,iurb)=max(0.,pb_u(iz_u,iurb)-ss_u(iz_u,iurb))<a name='2765'>
            enddo<a name='2766'>
<a name='2767'>
         enddo<a name='2768'>
      end do<a name='2769'>
     <a name='2770'>
                  <a name='2771'>
      return       <a name='2772'>
      end subroutine icBEP<a name='2773'>
<a name='2774'>
<font color=#447700>! ===6=8===============================================================72<a name='2775'></font>
<font color=#447700>! ===6=8===============================================================72<a name='2776'></font>
<a name='2777'>
<A NAME='VIEW_FACTORS'><A href='../../html_code/phys/module_sf_bep.F.html#VIEW_FACTORS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2778'>
      <font color=#993300>subroutine </font><font color=#cc0000>view_factors</font>(iurb,nz_u,id,dxy,z,ws,fww,fwg,fgw,fsg,fsw,fws)  <A href='../../call_to/VIEW_FACTORS.html' TARGET='index'>2</A>,<A href='../../call_from/VIEW_FACTORS.html' TARGET='index'>26</A><a name='2779'>
     <a name='2780'>
      implicit none<a name='2781'>
<a name='2782'>
 <a name='2783'>
<a name='2784'>
<font color=#447700>! -----------------------------------------------------------------------<a name='2785'></font>
<font color=#447700>!     Input<a name='2786'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2787'></font>
<a name='2788'>
      integer iurb            <font color=#447700>! Number of the urban class<a name='2789'></font>
      integer nz_u            <font color=#447700>! Number of levels in the urban grid<a name='2790'></font>
      integer id              <font color=#447700>! Street direction number<a name='2791'></font>
      real ws                 <font color=#447700>! Street width<a name='2792'></font>
      real z(nz_um)         <font color=#447700>! Height of the urban grid levels<a name='2793'></font>
      real dxy                <font color=#447700>! Street lenght<a name='2794'></font>
<a name='2795'>
<a name='2796'>
<font color=#447700>! -----------------------------------------------------------------------<a name='2797'></font>
<font color=#447700>!     Output<a name='2798'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2799'></font>
<a name='2800'>
<font color=#447700>!   fww,fwg,fgw,fsw,fsg are the view factors used to compute the long wave<a name='2801'></font>
<font color=#447700>!   and the short wave radation. They are the part of radiation from a surface<a name='2802'></font>
<font color=#447700>!   or from the sky to another surface.<a name='2803'></font>
<a name='2804'>
      real fww(nz_um,nz_um,ndm,nurbm)            <font color=#447700>!  from wall to wall<a name='2805'></font>
      real fwg(nz_um,ndm,nurbm)                  <font color=#447700>!  from wall to ground<a name='2806'></font>
      real fgw(nz_um,ndm,nurbm)                  <font color=#447700>!  from ground to wall<a name='2807'></font>
      real fsw(nz_um,ndm,nurbm)                  <font color=#447700>!  from sky to wall<a name='2808'></font>
      real fws(nz_um,ndm,nurbm)                  <font color=#447700>!  from wall to sky<a name='2809'></font>
      real fsg(ndm,nurbm)                        <font color=#447700>!  from sky to ground<a name='2810'></font>
<a name='2811'>
<a name='2812'>
<font color=#447700>! -----------------------------------------------------------------------<a name='2813'></font>
<font color=#447700>!     Local<a name='2814'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2815'></font>
<a name='2816'>
      integer jz,iz<a name='2817'>
<a name='2818'>
      real hut<a name='2819'>
      real f1,f2,f12,f23,f123,ftot<a name='2820'>
      real fprl,fnrm<a name='2821'>
      real a1,a2,a3,a4,a12,a23,a123<a name='2822'>
<a name='2823'>
<font color=#447700>! -----------------------------------------------------------------------<a name='2824'></font>
<font color=#447700>!     This routine calculates the view factors<a name='2825'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2826'></font>
        <a name='2827'>
      hut=z(nz_u+1)<a name='2828'>
        <a name='2829'>
      do jz=1,nz_u      <a name='2830'>
      <a name='2831'>
<font color=#447700>! radiation from wall to wall<a name='2832'></font>
       <a name='2833'>
         do iz=1,nz_u<a name='2834'>
     <a name='2835'>
            call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FPRLS'>fprls</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPRLS_1"> (fprl,dxy,abs(z(jz+1)-z(iz  )),ws)<a name='2836'>
            f123=fprl<a name='2837'>
            call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FPRLS'>fprls</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPRLS_2"> (fprl,dxy,abs(z(jz+1)-z(iz+1)),ws)<a name='2838'>
            f23=fprl<a name='2839'>
            call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FPRLS'>fprls</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPRLS_3"> (fprl,dxy,abs(z(jz  )-z(iz  )),ws)<a name='2840'>
            f12=fprl<a name='2841'>
            call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FPRLS'>fprls</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPRLS_4"> (fprl,dxy,abs(z(jz  )-z(iz+1)),ws)<a name='2842'>
            f2 = fprl<a name='2843'>
       <a name='2844'>
            a123=dxy*(abs(z(jz+1)-z(iz  )))<a name='2845'>
            a12 =dxy*(abs(z(jz  )-z(iz  )))<a name='2846'>
            a23 =dxy*(abs(z(jz+1)-z(iz+1)))<a name='2847'>
            a1  =dxy*(abs(z(iz+1)-z(iz  )))<a name='2848'>
            a2  =dxy*(abs(z(jz  )-z(iz+1)))<a name='2849'>
            a3  =dxy*(abs(z(jz+1)-z(jz  )))<a name='2850'>
       <a name='2851'>
            ftot=0.5*(a123*f123-a23*f23-a12*f12+a2*f2)/a1<a name='2852'>
       <a name='2853'>
            fww(iz,jz,id,iurb)=ftot*a1/a3<a name='2854'>
<a name='2855'>
         enddo <a name='2856'>
<a name='2857'>
<font color=#447700>! radiation from ground to wall<a name='2858'></font>
       <a name='2859'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_1"> (fnrm,z(jz+1),dxy,ws)<a name='2860'>
         f12=fnrm<a name='2861'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_2"> (fnrm,z(jz)  ,dxy,ws)<a name='2862'>
         f1=fnrm<a name='2863'>
       <a name='2864'>
         a1 = ws*dxy<a name='2865'>
         <a name='2866'>
         a12= ws*dxy<a name='2867'>
       <a name='2868'>
         a4=(z(jz+1)-z(jz))*dxy<a name='2869'>
       <a name='2870'>
         ftot=(a12*f12-a12*f1)/a1<a name='2871'>
                    <a name='2872'>
         fgw(jz,id,iurb)=ftot*a1/a4<a name='2873'>
     <a name='2874'>
<font color=#447700>!  radiation from sky to wall<a name='2875'></font>
     <a name='2876'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_3">(fnrm,hut-z(jz)  ,dxy,ws)<a name='2877'>
         f12 = fnrm<a name='2878'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_4"> (fnrm,hut-z(jz+1),dxy,ws)<a name='2879'>
         f1 =fnrm<a name='2880'>
       <a name='2881'>
         a1 = ws*dxy<a name='2882'>
       <a name='2883'>
         a12= ws*dxy<a name='2884'>
              <a name='2885'>
         a4 = (z(jz+1)-z(jz))*dxy<a name='2886'>
       <a name='2887'>
         ftot=(a12*f12-a12*f1)/a1<a name='2888'>
        <a name='2889'>
         fsw(jz,id,iurb)=ftot*a1/a4       <a name='2890'>
      <a name='2891'>
      enddo<a name='2892'>
<a name='2893'>
<font color=#447700>! radiation from wall to sky      <a name='2894'></font>
      do iz=1,nz_u<a name='2895'>
       call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_5">(fnrm,ws,dxy,hut-z(iz))<a name='2896'>
       f12=fnrm<a name='2897'>
       call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_6">(fnrm,ws,dxy,hut-z(iz+1))<a name='2898'>
       f1=fnrm<a name='2899'>
       a1 = (z(iz+1)-z(iz))*dxy<a name='2900'>
       a2 = (hut-z(iz+1))*dxy<a name='2901'>
       a12= (hut-z(iz))*dxy<a name='2902'>
       a4 = ws*dxy<a name='2903'>
       ftot=(a12*f12-a2*f1)/a1<a name='2904'>
       fws(iz,id,iurb)=ftot*a1/a4 <a name='2905'>
 <a name='2906'>
      enddo<a name='2907'>
<font color=#447700>!!!!!!!!!!!!!<a name='2908'></font>
<a name='2909'>
<a name='2910'>
       do iz=1,nz_u<a name='2911'>
<a name='2912'>
<font color=#447700>! radiation from wall to ground<a name='2913'></font>
      <a name='2914'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_7"> (fnrm,ws,dxy,z(iz+1))<a name='2915'>
         f12=fnrm<a name='2916'>
         call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FNRMS'>fnrms</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FNRMS_8"> (fnrm,ws,dxy,z(iz  ))<a name='2917'>
         f1 =fnrm<a name='2918'>
         <a name='2919'>
         a1= (z(iz+1)-z(iz) )*dxy<a name='2920'>
       <a name='2921'>
         a2 = z(iz)*dxy<a name='2922'>
         a12= z(iz+1)*dxy<a name='2923'>
         a4 = ws*dxy<a name='2924'>
<a name='2925'>
         ftot=(a12*f12-a2*f1)/a1        <a name='2926'>
                    <a name='2927'>
         fwg(iz,id,iurb)=ftot*a1/a4<a name='2928'>
        <a name='2929'>
      enddo<a name='2930'>
<a name='2931'>
<font color=#447700>! radiation from sky to ground<a name='2932'></font>
      <a name='2933'>
      call <A href='../../html_code/phys/module_sf_bep_bem.F.html#FPRLS'>fprls</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPRLS_5"> (fprl,dxy,ws,hut)<a name='2934'>
      fsg(id,iurb)=fprl<a name='2935'>
<a name='2936'>
      return<a name='2937'>
      end subroutine view_factors<a name='2938'>
<a name='2939'>
<font color=#447700>! ===6=8===============================================================72<a name='2940'></font>
<font color=#447700>! ===6=8===============================================================72<a name='2941'></font>
<a name='2942'>
<A NAME='FPRLS'><A href='../../html_code/phys/module_sf_bep.F.html#FPRLS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2943'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>fprls</font> (fprl,a,b,c) <A href='../../call_to/FPRLS.html' TARGET='index'>10</A><a name='2944'>
<a name='2945'>
      implicit none<a name='2946'>
<a name='2947'>
     <a name='2948'>
            <a name='2949'>
      real a,b,c<a name='2950'>
      real x,y<a name='2951'>
      real fprl<a name='2952'>
<a name='2953'>
<a name='2954'>
      x=a/c<a name='2955'>
      y=b/c<a name='2956'>
      <a name='2957'>
      if(a.eq.0.or.b.eq.0.)then<a name='2958'>
       fprl=0.<a name='2959'>
      else<a name='2960'>
       fprl=log( ( (1.+x**2)*(1.+y**2)/(1.+x**2+y**2) )**.5)+  &amp;<a name='2961'>
           y*((1.+x**2)**.5)*atan(y/((1.+x**2)**.5))+          &amp;  <a name='2962'>
           x*((1.+y**2)**.5)*atan(x/((1.+y**2)**.5))-          &amp;   <a name='2963'>
           y*atan(y)-x*atan(x)<a name='2964'>
       fprl=fprl*2./(pi*x*y)<a name='2965'>
      endif<a name='2966'>
      <a name='2967'>
      return<a name='2968'>
      end subroutine fprls<a name='2969'>
<a name='2970'>
<font color=#447700>! ===6=8===============================================================72     <a name='2971'></font>
<font color=#447700>! ===6=8===============================================================72<a name='2972'></font>
<a name='2973'>
<A NAME='FNRMS'><A href='../../html_code/phys/module_sf_bep.F.html#FNRMS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2974'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>fnrms</font> (fnrm,a,b,c) <A href='../../call_to/FNRMS.html' TARGET='index'>16</A><a name='2975'>
<a name='2976'>
      implicit none<a name='2977'>
<a name='2978'>
<a name='2979'>
<a name='2980'>
      real a,b,c<a name='2981'>
      real x,y,z,a1,a2,a3,a4,a5,a6<a name='2982'>
      real fnrm<a name='2983'>
      <a name='2984'>
      x=a/b<a name='2985'>
      y=c/b<a name='2986'>
      z=x**2+y**2<a name='2987'>
      <a name='2988'>
      if(y.eq.0.or.x.eq.0)then<a name='2989'>
       fnrm=0.<a name='2990'>
      else<a name='2991'>
       a1=log( (1.+x*x)*(1.+y*y)/(1.+z) )<a name='2992'>
       a2=y*y*log(y*y*(1.+z)/z/(1.+y*y) )<a name='2993'>
       a3=x*x*log(x*x*(1.+z)/z/(1.+x*x) )<a name='2994'>
       a4=y*atan(1./y)<a name='2995'>
       a5=x*atan(1./x)<a name='2996'>
       a6=sqrt(z)*atan(1./sqrt(z))<a name='2997'>
       fnrm=0.25*(a1+a2+a3)+a4+a5-a6<a name='2998'>
       fnrm=fnrm/(pi*y)<a name='2999'>
      endif<a name='3000'>
      <a name='3001'>
      return<a name='3002'>
      end subroutine fnrms<a name='3003'>
  <font color=#447700>! ===6=8===============================================================72  <a name='3004'></font>
     <a name='3005'>
<A NAME='INIT_PARA'><A href='../../html_code/phys/module_sf_bep.F.html#INIT_PARA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3006'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_para</font>(alag_u,alaw_u,alar_u,csg_u,csw_u,csr_u,&amp; <A href='../../call_to/INIT_PARA.html' TARGET='index'>2</A>,<A href='../../call_from/INIT_PARA.html' TARGET='index'>1</A><a name='3007'>
                twini_u,trini_u,tgini_u,albg_u,albw_u,albr_u,emg_u,emw_u,&amp;<a name='3008'>
                emr_u,z0g_u,z0r_u,nd_u,strd_u,drst_u,ws_u,bs_u,h_b,d_b)<a name='3009'>
<a name='3010'>
<font color=#447700>! initialization routine, where the variables from the table are read<a name='3011'></font>
<a name='3012'>
      implicit none<a name='3013'>
      <a name='3014'>
      integer iurb            <font color=#447700>! urban class number<a name='3015'></font>
<font color=#447700>!    Building parameters      <a name='3016'></font>
      real alag_u(nurbm)      <font color=#447700>! Ground thermal diffusivity [m^2 s^-1]<a name='3017'></font>
      real alaw_u(nurbm)      <font color=#447700>! Wall thermal diffusivity [m^2 s^-1]<a name='3018'></font>
      real alar_u(nurbm)      <font color=#447700>! Roof thermal diffusivity [m^2 s^-1]<a name='3019'></font>
      real csg_u(nurbm)       <font color=#447700>! Specific heat of the ground material [J m^3 K^-1]<a name='3020'></font>
      real csw_u(nurbm)       <font color=#447700>! Specific heat of the wall material [J m^3 K^-1]<a name='3021'></font>
      real csr_u(nurbm)       <font color=#447700>! Specific heat of the roof material [J m^3 K^-1]<a name='3022'></font>
      real twini_u(nurbm)     <font color=#447700>! Temperature inside the buildings behind the wall [K]<a name='3023'></font>
      real trini_u(nurbm)     <font color=#447700>! Temperature inside the buildings behind the roof [K]<a name='3024'></font>
      real tgini_u(nurbm)     <font color=#447700>! Initial road temperature<a name='3025'></font>
<a name='3026'>
<font color=#447700>!    Radiation parameters<a name='3027'></font>
      real albg_u(nurbm)      <font color=#447700>! Albedo of the ground<a name='3028'></font>
      real albw_u(nurbm)      <font color=#447700>! Albedo of the wall<a name='3029'></font>
      real albr_u(nurbm)      <font color=#447700>! Albedo of the roof<a name='3030'></font>
      real emg_u(nurbm)       <font color=#447700>! Emissivity of ground<a name='3031'></font>
      real emw_u(nurbm)       <font color=#447700>! Emissivity of wall<a name='3032'></font>
      real emr_u(nurbm)       <font color=#447700>! Emissivity of roof<a name='3033'></font>
<a name='3034'>
<font color=#447700>!    Roughness parameters<a name='3035'></font>
      real z0g_u(nurbm)       <font color=#447700>! The ground's roughness length      <a name='3036'></font>
      real z0r_u(nurbm)       <font color=#447700>! The roof's roughness length<a name='3037'></font>
<a name='3038'>
<font color=#447700>!    Street parameters<a name='3039'></font>
      integer nd_u(nurbm)     <font color=#447700>! Number of street direction for each urban class<a name='3040'></font>
<a name='3041'>
      real strd_u(ndm,nurbm)  <font color=#447700>! Street length (fix to greater value to the horizontal length of the cells)<a name='3042'></font>
      real drst_u(ndm,nurbm)  <font color=#447700>! Street direction [degree]<a name='3043'></font>
      real ws_u(ndm,nurbm)    <font color=#447700>! Street width [m]<a name='3044'></font>
      real bs_u(ndm,nurbm)    <font color=#447700>! Building width [m]<a name='3045'></font>
      real h_b(nz_um,nurbm)   <font color=#447700>! Bulding's heights [m]<a name='3046'></font>
      real d_b(nz_um,nurbm)   <font color=#447700>! The probability that a building has an height h_b<a name='3047'></font>
<a name='3048'>
      integer i,iu<a name='3049'>
      integer nurb <font color=#447700>! number of urban classes used<a name='3050'></font>
<a name='3051'>
<font color=#447700>!<a name='3052'></font>
<font color=#447700>!Initialize some variables<a name='3053'></font>
<font color=#447700>!<a name='3054'></font>
       <a name='3055'>
       h_b=0.<a name='3056'>
       d_b=0.<a name='3057'>
<a name='3058'>
       nurb=ICATE<a name='3059'>
       do iu=1,nurb                         <a name='3060'>
          nd_u(iu)=0<a name='3061'>
       enddo<a name='3062'>
<a name='3063'>
       csw_u=CAPB_TBL / (( 1.0 / 4.1868 ) * 1.E-6)<a name='3064'>
       csr_u=CAPR_TBL / (( 1.0 / 4.1868 ) * 1.E-6)<a name='3065'>
       csg_u=CAPG_TBL / (( 1.0 / 4.1868 ) * 1.E-6)<a name='3066'>
       do i=1,icate<a name='3067'>
         alaw_u(i)=AKSB_TBL(i) / csw_u(i) / (( 1.0 / 4.1868 ) * 1.E-2)<a name='3068'>
         alar_u(i)=AKSR_TBL(i) / csr_u(i) / (( 1.0 / 4.1868 ) * 1.E-2)<a name='3069'>
         alag_u(i)=AKSG_TBL(i) / csg_u(i) / (( 1.0 / 4.1868 ) * 1.E-2)<a name='3070'>
       enddo<a name='3071'>
       twini_u=TBLEND_TBL<a name='3072'>
       trini_u=TRLEND_TBL<a name='3073'>
       tgini_u=TGLEND_TBL<a name='3074'>
       albw_u=ALBB_TBL<a name='3075'>
       albr_u=ALBR_TBL<a name='3076'>
       albg_u=ALBG_TBL<a name='3077'>
       emw_u=EPSB_TBL<a name='3078'>
       emr_u=EPSR_TBL<a name='3079'>
       emg_u=EPSG_TBL<a name='3080'>
       z0r_u=Z0R_TBL<a name='3081'>
       z0g_u=Z0G_TBL<a name='3082'>
       nd_u=NUMDIR_TBL<a name='3083'>
       do iu=1,icate<a name='3084'>
              if(ndm.lt.nd_u(iu))then<a name='3085'>
                write(*,*)'ndm too small in module_sf_bep, please increase to at least ', nd_u(iu)<a name='3086'>
                write(*,*)'remember also that num_urban_layers should be equal or greater than nz_um*ndm*nwr-u<font color=#447700>!'<a name='3087'></font>
                stop<a name='3088'>
              endif<a name='3089'>
         do i=1,nd_u(iu)<a name='3090'>
           drst_u(i,iu)=STREET_DIRECTION_TBL(i,iu) * pi/180.<a name='3091'>
           ws_u(i,iu)=STREET_WIDTH_TBL(i,iu)<a name='3092'>
           bs_u(i,iu)=BUILDING_WIDTH_TBL(i,iu)<a name='3093'>
         enddo<a name='3094'>
       enddo<a name='3095'>
       do iu=1,ICATE<a name='3096'>
          if(nz_um.lt.numhgt_tbl(iu)+3)then<a name='3097'>
              write(*,*)'nz_um too small in module_sf_bep, please increase to at least ',numhgt_tbl(iu)+3<a name='3098'>
              write(*,*)'remember also that num_urban_layers should be equal or greater than nz_um*ndm*nwr-u<font color=#447700>!'<a name='3099'></font>
              stop<a name='3100'>
          endif<a name='3101'>
         do i=1,NUMHGT_TBL(iu)<a name='3102'>
           h_b(i,iu)=HEIGHT_BIN_TBL(i,iu)<a name='3103'>
           d_b(i,iu)=HPERCENT_BIN_TBL(i,iu)<a name='3104'>
         enddo<a name='3105'>
       enddo<a name='3106'>
<a name='3107'>
       do i=1,ndm<a name='3108'>
        do iu=1,nurbm<a name='3109'>
         strd_u(i,iu)=100000.<a name='3110'>
        enddo<a name='3111'>
       enddo<a name='3112'>
         <a name='3113'>
       return<a name='3114'>
      END SUBROUTINE init_para<a name='3115'>
<font color=#447700>!==============================================================<a name='3116'></font>
<a name='3117'>
<font color=#447700>!==============================================================<a name='3118'></font>
<A NAME='ANGLE'><A href='../../html_code/phys/module_sf_bep.F.html#ANGLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3119'>
      <font color=#993300>subroutine </font><font color=#cc0000>angle</font>(along,alat,day,realt,zr,deltar,ah)<a name='3120'>
<font color=#447700>!     ----------------     <a name='3121'></font>
<font color=#447700>!      <a name='3122'></font>
<font color=#447700>!         Computation of the solar angles<a name='3123'></font>
<font color=#447700>!         schayes (1982,atm.  env. , p1407)<a name='3124'></font>
<font color=#447700>! Inputs<a name='3125'></font>
<font color=#447700>!========================<a name='3126'></font>
<font color=#447700>! along=longitud<a name='3127'></font>
<font color=#447700>! alat=latitude<a name='3128'></font>
<font color=#447700>! day=julian day (from the beginning of the year)<a name='3129'></font>
<font color=#447700>! realt= time GMT in hours<a name='3130'></font>
<font color=#447700>! Outputs<a name='3131'></font>
<font color=#447700>!============================<a name='3132'></font>
<font color=#447700>! zr=solar zenith angle<a name='3133'></font>
<font color=#447700>! deltar=declination angle<a name='3134'></font>
<font color=#447700>! ah=hour angle<a name='3135'></font>
<font color=#447700>!===============================<a name='3136'></font>
<a name='3137'>
      implicit none<a name='3138'>
      real along,alat, realt, zr, deltar, ah, arg<a name='3139'>
      real rad,om,radh,initt, pii, drad, alongt, cphi, sphi<a name='3140'>
      real c1, c2, c3, s1, s2, s3, delta, rmsr2, cd, sid <a name='3141'>
      real et, ahor, chor, coznt <a name='3142'>
      integer day <a name='3143'>
<a name='3144'>
<a name='3145'>
      data rad,om,radh,initt/0.0174533,0.0172142,0.26179939,0/<a name='3146'>
 <a name='3147'>
       zr=0.<a name='3148'>
       deltar=0.<a name='3149'>
       ah=0.<a name='3150'>
<a name='3151'>
       pii = 3.14159265358979312<a name='3152'>
       drad = pii/180.<a name='3153'>
      <a name='3154'>
       alongt=along/15.<a name='3155'>
       cphi=cos(alat*drad)<a name='3156'>
       sphi=sin(alat*drad)<a name='3157'>
<font color=#447700>!<a name='3158'></font>
<font color=#447700>!     declination<a name='3159'></font>
<font color=#447700>!<a name='3160'></font>
       arg=om*day<a name='3161'>
       c1=cos(arg)<a name='3162'>
       c2=cos(2.*arg)<a name='3163'>
       c3=cos(3.*arg)<a name='3164'>
       s1=sin(arg)<a name='3165'>
       s2=sin(2.*arg)<a name='3166'>
       s3=sin(3.*arg)<a name='3167'>
       delta=0.33281-22.984*c1-0.3499*c2-0.1398*c3+3.7872*s1+0.03205*s2+0.07187*s3<a name='3168'>
       rmsr2=(1./(1.-0.01673*c1))**2<a name='3169'>
       deltar=delta*rad<a name='3170'>
       cd=cos(deltar)<a name='3171'>
       sid=sin(deltar)<a name='3172'>
<font color=#447700>!<a name='3173'></font>
<font color=#447700>!     time equation in hours<a name='3174'></font>
<font color=#447700>!<a name='3175'></font>
       et=0.0072*c1-0.0528*c2-0.0012*c3-0.1229*s1-0.1565*s2-0.0041*s3<a name='3176'>
<font color=#447700>!<a name='3177'></font>
<font color=#447700>!<a name='3178'></font>
<font color=#447700>!   hour angle  <a name='3179'></font>
<font color=#447700>!<a name='3180'></font>
      <a name='3181'>
<font color=#447700>!      ifh=0<a name='3182'></font>
      <a name='3183'>
 <font color=#447700>!     ahor=realt-12.+ifh+et+alongt<a name='3184'></font>
      ahor=realt-12.+et+alongt<a name='3185'>
      ah=ahor*radh<a name='3186'>
      chor=cos(ah)<a name='3187'>
<font color=#447700>!<a name='3188'></font>
<font color=#447700>!    zenith angle<a name='3189'></font>
<font color=#447700>!<a name='3190'></font>
      coznt=sphi*sid+cphi*cd*chor<a name='3191'>
      <a name='3192'>
       zr=acos(coznt)<a name='3193'>
<a name='3194'>
      return<a name='3195'>
<a name='3196'>
      END SUBROUTINE angle<a name='3197'>
<font color=#447700>!<a name='3198'></font>
<font color=#447700>!====6=8===============================================================72         <a name='3199'></font>
<font color=#447700>!====6=8===============================================================72 <a name='3200'></font>
<a name='3201'>
<A NAME='UPWARD_RAD'><A href='../../html_code/phys/module_sf_bep.F.html#UPWARD_RAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3202'>
      <font color=#993300>subroutine </font><font color=#cc0000>upward_rad</font>(ndu,nzu,ws,bs,sigma,pb,ss,                     &amp; <A href='../../call_to/UPWARD_RAD.html' TARGET='index'>2</A><a name='3203'>
                       tg,emg_u,albg_u,rlg,rsg,sfg,                        &amp; <a name='3204'>
                       tw,emw_u,albw_u,rlw,rsw,sfw,                        &amp; <a name='3205'>
                       tr,emr_u,albr_u,rld,rs, sfr,                        &amp; <a name='3206'>
                       rs_abs,rl_up,emiss,grdflx_urb)<a name='3207'>
<font color=#447700>!<a name='3208'></font>
<font color=#447700>! IN this surboutine we compute the upward longwave flux, and the albedo<a name='3209'></font>
<font color=#447700>! needed for the radiation scheme<a name='3210'></font>
<font color=#447700>!<a name='3211'></font>
                       implicit none<a name='3212'>
<a name='3213'>
<font color=#447700>!<a name='3214'></font>
<font color=#447700>!INPUT VARIABLES<a name='3215'></font>
<font color=#447700>!<a name='3216'></font>
      real rsw(2*ndm,nz_um)        <font color=#447700>! Short wave radiation at the wall for a given canyon direction [W/m2]<a name='3217'></font>
      real rlw(2*ndm,nz_um)         <font color=#447700>! Long wave radiation at the walls for a given canyon direction [W/m2]<a name='3218'></font>
      real rsg(ndm)                   <font color=#447700>! Short wave radiation at the canyon for a given canyon direction [W/m2]<a name='3219'></font>
      real rlg(ndm)                   <font color=#447700>! Long wave radiation at the ground for a given canyon direction [W/m2]<a name='3220'></font>
      real rs                        <font color=#447700>! Short wave radiation at the horizontal surface from the sun [W/m2]  <a name='3221'></font>
      real sfw(2*ndm,nz_um)      <font color=#447700>! Sensible heat flux from walls [W/m2]<a name='3222'></font>
      real sfg(ndm)              <font color=#447700>! Sensible heat flux from ground (road) [W/m2]<a name='3223'></font>
      real sfr(ndm,nz_um)      <font color=#447700>! Sensible heat flux from roofs [W/m2]                      <a name='3224'></font>
      real rld                        <font color=#447700>! Long wave radiation from the sky [W/m2]<a name='3225'></font>
      real albg_u                    <font color=#447700>! albedo of the ground/street<a name='3226'></font>
      real albw_u                    <font color=#447700>! albedo of the walls<a name='3227'></font>
      real albr_u                    <font color=#447700>! albedo of the roof <a name='3228'></font>
      real ws(ndm)                        <font color=#447700>! width of the street<a name='3229'></font>
      real bs(ndm)<a name='3230'>
                        <font color=#447700>! building size<a name='3231'></font>
      real pb(nz_um)                <font color=#447700>! Probability to have a building with an height equal or higher   <a name='3232'></font>
      integer nzu<a name='3233'>
      real ss(nz_um)                <font color=#447700>! Probability to have a building of a given height<a name='3234'></font>
      real sigma                       <a name='3235'>
      real emg_u                       <font color=#447700>! emissivity of the street<a name='3236'></font>
      real emw_u                       <font color=#447700>! emissivity of the wall<a name='3237'></font>
      real emr_u                       <font color=#447700>! emissivity of the roof<a name='3238'></font>
      real tw(2*ndm,nz_um,nwr_u)  <font color=#447700>! Temperature in each layer of the wall [K]<a name='3239'></font>
      real tr(ndm,nz_um,nwr_u)  <font color=#447700>! Temperature in each layer of the roof [K]<a name='3240'></font>
      real tg(ndm,ng_u)          <font color=#447700>! Temperature in each layer of the ground [K]<a name='3241'></font>
      integer id <font color=#447700>! street direction<a name='3242'></font>
      integer ndu <font color=#447700>! number of street directions<a name='3243'></font>
<font color=#447700>!OUTPUT/INPUT<a name='3244'></font>
      real rs_abs  <font color=#447700>! absrobed solar radiationfor this street direction<a name='3245'></font>
      real rl_up   <font color=#447700>! upward longwave radiation for this street direction<a name='3246'></font>
      real emiss <font color=#447700>! mean emissivity<a name='3247'></font>
      real grdflx_urb <font color=#447700>! ground heat flux <a name='3248'></font>
<font color=#447700>!LOCAL<a name='3249'></font>
      integer iz,iw<a name='3250'>
      real rl_inc,rl_emit<a name='3251'>
      real gfl<a name='3252'>
      integer ix,iy,iwrong<a name='3253'>
<a name='3254'>
         iwrong=1<a name='3255'>
      do iz=1,nzu+1<a name='3256'>
      do id=1,ndu<a name='3257'>
      do iw=1,nwr_u<a name='3258'>
        if(tr(id,iz,iw).lt.100.)then<a name='3259'>
              write(*,*)'in upward_rad ',iz,id,iw,tr(id,iz,iw) <a name='3260'>
              iwrong=0<a name='3261'>
        endif<a name='3262'>
        if(tw(2*id-1,iz,iw).lt.100.) then<a name='3263'>
           write(*,*)'in upward_rad ',iz,id,iw,tw(2*id-1,iz,iw) <a name='3264'>
           iwrong=0<a name='3265'>
        endif<a name='3266'>
        if(tw(2*id,iz,iw).lt.100.) then<a name='3267'>
           write(*,*)'in upward_rad ',iz,id,iw,tw(2*id,iz,iw) <a name='3268'>
           iwrong=0<a name='3269'>
        endif<a name='3270'>
      enddo<a name='3271'>
      enddo<a name='3272'>
      enddo<a name='3273'>
      do id=1,ndu<a name='3274'>
      do iw=1,ng_u<a name='3275'>
          if(tg(id,iw).lt.100.) then<a name='3276'>
            write(*,*)'in upward_rad ',id,iw,tg(id,iw) <a name='3277'>
            iwrong=0<a name='3278'>
          endif<a name='3279'>
      enddo   <a name='3280'>
      enddo<a name='3281'>
           if(iwrong.eq.0)stop<a name='3282'>
<a name='3283'>
      rl_up=0.<a name='3284'>
 <a name='3285'>
      rs_abs=0.<a name='3286'>
      rl_inc=0.<a name='3287'>
      emiss=0.<a name='3288'>
      rl_emit=0.<a name='3289'>
      grdflx_urb=0.<a name='3290'>
      do id=1,ndu          <a name='3291'>
       rl_emit=rl_emit-( emg_u*sigma*(tg(id,ng_u)**4.)+(1-emg_u)*rlg(id))*ws(id)/(ws(id)+bs(id))/ndu<a name='3292'>
       rl_inc=rl_inc+rlg(id)*ws(id)/(ws(id)+bs(id))/ndu       <a name='3293'>
       rs_abs=rs_abs+(1.-albg_u)*rsg(id)*ws(id)/(ws(id)+bs(id))/ndu<a name='3294'>
         gfl=(1.-albg_u)*rsg(id)+emg_u*rlg(id)-emg_u*sigma*(tg(id,ng_u)**4.)+sfg(id)<a name='3295'>
         grdflx_urb=grdflx_urb-gfl*ws(id)/(ws(id)+bs(id))/ndu  <a name='3296'>
 <a name='3297'>
          do iz=2,nzu<a name='3298'>
            rl_emit=rl_emit-(emr_u*sigma*(tr(id,iz,nwr_u)**4.)+(1-emr_u)*rld)*ss(iz)*bs(id)/(ws(id)+bs(id))/ndu<a name='3299'>
            rl_inc=rl_inc+rld*ss(iz)*bs(id)/(ws(id)+bs(id))/ndu            <a name='3300'>
            rs_abs=rs_abs+(1.-albr_u)*rs*ss(iz)*bs(id)/(ws(id)+bs(id))/ndu<a name='3301'>
            gfl=(1.-albr_u)*rs+emr_u*rld-emr_u*sigma*(tr(id,iz,nwr_u)**4.)+sfr(id,iz)<a name='3302'>
            grdflx_urb=grdflx_urb-gfl*ss(iz)*bs(id)/(ws(id)+bs(id))/ndu<a name='3303'>
         enddo<a name='3304'>
           <a name='3305'>
         do iz=1,nzu            <a name='3306'>
            rl_emit=rl_emit-(emw_u*sigma*( tw(2*id-1,iz,nwr_u)**4.+tw(2*id,iz,nwr_u)**4. )+          &amp;<a name='3307'>
               (1-emw_u)*( rlw(2*id-1,iz)+rlw(2*id,iz) ) )*dz_u*pb(iz+1)/(ws(id)+bs(id))/ndu<a name='3308'>
            rl_inc=rl_inc+(( rlw(2*id-1,iz)+rlw(2*id,iz) ) )*dz_u*pb(iz+1)/(ws(id)+bs(id))/ndu<a name='3309'>
            rs_abs=rs_abs+((1.-albw_u)*( rsw(2*id-1,iz)+rsw(2*id,iz) ) )*dz_u*pb(iz+1)/(ws(id)+bs(id))/ndu <a name='3310'>
            gfl=(1.-albw_u)*(rsw(2*id-1,iz)+rsw(2*id,iz)) +emw_u*( rlw(2*id-1,iz)+rlw(2*id,iz) )   &amp;<a name='3311'>
             -emw_u*sigma*( tw(2*id-1,iz,nwr_u)**4.+tw(2*id,iz,nwr_u)**4. )+(sfw(2*id-1,iz)+sfw(2*id,iz))            <a name='3312'>
            grdflx_urb=grdflx_urb-gfl*dz_u*pb(iz+1)/(ws(id)+bs(id))/ndu<a name='3313'>
         enddo<a name='3314'>
          <a name='3315'>
      enddo<a name='3316'>
        emiss=(emg_u+emw_u+emr_u)/3.<a name='3317'>
        rl_up=(rl_inc+rl_emit)-rld<a name='3318'>
       <a name='3319'>
         <a name='3320'>
      return<a name='3321'>
<a name='3322'>
      END SUBROUTINE upward_rad<a name='3323'>
<a name='3324'>
<font color=#447700>!====6=8===============================================================72         <a name='3325'></font>
<font color=#447700>!====6=8===============================================================72 <a name='3326'></font>
<font color=#447700>! ===6=8===============================================================72<a name='3327'></font>
<font color=#447700>! ===6=8===============================================================72<a name='3328'></font>
<a name='3329'>
<A NAME='ICBEP_XY'><A href='../../html_code/phys/module_sf_bep.F.html#ICBEP_XY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3330'>
      <font color=#993300>subroutine </font><font color=#cc0000>icBEP_XY</font>(iurb,fww_u,fwg_u,fgw_u,fsw_u,             &amp; <A href='../../call_to/ICBEP_XY.html' TARGET='index'>2</A>,<A href='../../call_from/ICBEP_XY.html' TARGET='index'>2</A><a name='3331'>
                          fws_u,fsg_u,ndu,strd,ws,nzu,z_u)                               <a name='3332'>
<a name='3333'>
      implicit none       <a name='3334'>
        <a name='3335'>
<font color=#447700>!    Street parameters<a name='3336'></font>
      integer ndu     <font color=#447700>! Number of street direction for each urban class<a name='3337'></font>
      integer iurb<a name='3338'>
<a name='3339'>
      real strd(ndm)        <font color=#447700>! Street length (fix to greater value to the horizontal length of the cells)<a name='3340'></font>
      real ws(ndm)          <font color=#447700>! Street width [m]<a name='3341'></font>
<a name='3342'>
<font color=#447700>!    Grid parameters<a name='3343'></font>
      integer nzu          <font color=#447700>! Number of layer in the urban grid<a name='3344'></font>
      real z_u(nz_um)       <font color=#447700>! Height of the urban grid levels<a name='3345'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='3346'></font>
<font color=#447700>!     Output<a name='3347'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3348'></font>
<a name='3349'>
<font color=#447700>!   fww_u,fwg_u,fgw_u,fsw_u,fsg_u are the view factors used to compute the long wave<a name='3350'></font>
<font color=#447700>!   and the short wave radation. They are the part of radiation from a surface<a name='3351'></font>
<font color=#447700>!   or from the sky to another surface.<a name='3352'></font>
<a name='3353'>
      real fww_u(nz_um,nz_um,ndm,nurbm)         <font color=#447700>!  from wall to wall<a name='3354'></font>
      real fwg_u(nz_um,ndm,nurbm)               <font color=#447700>!  from wall to ground<a name='3355'></font>
      real fgw_u(nz_um,ndm,nurbm)               <font color=#447700>!  from ground to wall<a name='3356'></font>
      real fsw_u(nz_um,ndm,nurbm)               <font color=#447700>!  from sky to wall<a name='3357'></font>
      real fws_u(nz_um,ndm,nurbm)               <font color=#447700>!  from sky to wall<a name='3358'></font>
      real fsg_u(ndm,nurbm)                     <font color=#447700>!  from sky to ground<a name='3359'></font>
<a name='3360'>
<font color=#447700>! -----------------------------------------------------------------------<a name='3361'></font>
<font color=#447700>!     Local<a name='3362'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3363'></font>
<a name='3364'>
      integer id<a name='3365'>
<a name='3366'>
<font color=#447700>! -----------------------------------------------------------------------<a name='3367'></font>
<font color=#447700>!     This routine compute the view factors<a name='3368'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3369'></font>
<font color=#447700>!<a name='3370'></font>
<font color=#447700>!Initialize<a name='3371'></font>
<font color=#447700>!<a name='3372'></font>
      fww_u=0.<a name='3373'>
      fwg_u=0.<a name='3374'>
      fgw_u=0.<a name='3375'>
      fsw_u=0.<a name='3376'>
      fws_u=0.<a name='3377'>
      fsg_u=0.<a name='3378'>
      <a name='3379'>
      do id=1,ndu<a name='3380'>
<a name='3381'>
            call <A href='../../html_code/phys/module_sf_bep_bem.F.html#VIEW_FACTORS'>view_factors</A><A href='../../html_code/phys/module_sf_bep_bem.F.html#ICBEP_XY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VIEW_FACTORS_1">(iurb,nzu,id,strd(id),z_u,ws(id),  &amp;    <a name='3382'>
                              fww_u,fwg_u,fgw_u,fsg_u,fsw_u,fws_u) <a name='3383'>
      <a name='3384'>
      enddo               <a name='3385'>
      return       <a name='3386'>
      end subroutine icBEP_XY<a name='3387'>
<font color=#447700>! ===6=8===============================================================72<a name='3388'></font>
<font color=#447700>! ===6=8===============================================================72<a name='3389'></font>
<a name='3390'>
<A NAME='ICBEPHI_XY'><A href='../../html_code/phys/module_sf_bep.F.html#ICBEPHI_XY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3391'>
      <font color=#993300>subroutine </font><font color=#cc0000>icBEPHI_XY</font>(hb_u,hi_urb1D,ss_u,pb_u,nzu,z_u) <A href='../../call_to/ICBEPHI_XY.html' TARGET='index'>2</A><a name='3392'>
<a name='3393'>
      implicit none   <a name='3394'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3395'></font>
<font color=#447700>!    Inputs<a name='3396'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3397'></font>
<font color=#447700>!    Street parameters<a name='3398'></font>
<font color=#447700>!<a name='3399'></font>
      real hi_urb1D(nz_um)    <font color=#447700>! The probability that a building has an height h_b<a name='3400'></font>
<font color=#447700>!<a name='3401'></font>
<font color=#447700>!     Grid parameters<a name='3402'></font>
<font color=#447700>!<a name='3403'></font>
      real z_u(nz_um)         <font color=#447700>! Height of the urban grid levels<a name='3404'></font>
<font color=#447700>! -----------------------------------------------------------------------<a name='3405'></font>
<font color=#447700>!     Output<a name='3406'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3407'></font>
<a name='3408'>
      real ss_u(nz_um)   <font color=#447700>! The probability that a building has an height equal to z<a name='3409'></font>
      real pb_u(nz_um)         <font color=#447700>! The probability that a building has an height greater or equal to z<a name='3410'></font>
<font color=#447700>!        <a name='3411'></font>
<font color=#447700>!    Grid parameters<a name='3412'></font>
<font color=#447700>!<a name='3413'></font>
      integer nzu                <font color=#447700>! Number of layer in the urban grid<a name='3414'></font>
<a name='3415'>
<font color=#447700>! -----------------------------------------------------------------------<a name='3416'></font>
<font color=#447700>!     Local<a name='3417'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3418'></font>
      real hb_u(nz_um)        <font color=#447700>! Bulding's heights [m]<a name='3419'></font>
      integer iz_u,id,ilu<a name='3420'>
<a name='3421'>
      real dtot<a name='3422'>
      real hbmax<a name='3423'>
<a name='3424'>
<font color=#447700>!------------------------------------------------------------------------<a name='3425'></font>
<a name='3426'>
<font color=#447700>!Initialize variables<a name='3427'></font>
<font color=#447700>!<a name='3428'></font>
      <a name='3429'>
      nzu=0<a name='3430'>
      ss_u=0.<a name='3431'>
      pb_u=0.<a name='3432'>
      <a name='3433'>
<font color=#447700>! Normalisation of the building density<a name='3434'></font>
<a name='3435'>
         dtot=0.<a name='3436'>
         hb_u=0.<a name='3437'>
<a name='3438'>
         do ilu=1,nz_um<a name='3439'>
            dtot=dtot+hi_urb1D(ilu)<a name='3440'>
         enddo<a name='3441'>
         <a name='3442'>
         do ilu=1,nz_um<a name='3443'>
            if (hi_urb1D(ilu)&lt;0.) then<a name='3444'>
<font color=#447700>!              write(*,*) 'WARNING, HI_URB1D(ilu) &lt; 0 IN BEP'<a name='3445'></font>
               go to 20<a name='3446'>
            endif<a name='3447'>
         enddo<a name='3448'>
<a name='3449'>
         if (dtot.gt.0.) then<a name='3450'>
            continue<a name='3451'>
         else<a name='3452'>
<font color=#447700>!           write(*,*) 'WARNING, HI_URB1D &lt;= 0 IN BEP'<a name='3453'></font>
            go to 20<a name='3454'>
         endif<a name='3455'>
<a name='3456'>
         do ilu=1,nz_um<a name='3457'>
            hi_urb1D(ilu)=hi_urb1D(ilu)/dtot<a name='3458'>
         enddo<a name='3459'>
         <a name='3460'>
         hb_u(1)=dz_u   <a name='3461'>
         do ilu=2,nz_um<a name='3462'>
            hb_u(ilu)=dz_u+hb_u(ilu-1)<a name='3463'>
         enddo<a name='3464'>
           <a name='3465'>
<a name='3466'>
<font color=#447700>! Compute pb and ss <a name='3467'></font>
      <a name='3468'>
            <a name='3469'>
         hbmax=0.<a name='3470'>
       <a name='3471'>
         do ilu=1,nz_um<a name='3472'>
            if (hi_urb1D(ilu)&gt;0.and.hi_urb1D(ilu)&lt;=1.) then<a name='3473'>
                hbmax=hb_u(ilu)<a name='3474'>
            endif<a name='3475'>
         enddo<a name='3476'>
         <a name='3477'>
         do iz_u=1,nz_um-1<a name='3478'>
            if(z_u(iz_u+1).gt.hbmax)go to 10<a name='3479'>
         enddo<a name='3480'>
<a name='3481'>
10       continue <a name='3482'>
        <a name='3483'>
         nzu=iz_u+1<a name='3484'>
<a name='3485'>
         if ((nzu+1).gt.nz_um) then <a name='3486'>
             write(*,*) 'error, nz_um has to be increased to at least',nzu+1<a name='3487'>
             stop<a name='3488'>
         endif<a name='3489'>
<a name='3490'>
            do iz_u=1,nzu<a name='3491'>
               ss_u(iz_u)=0.<a name='3492'>
               do ilu=1,nz_um<a name='3493'>
                  if(z_u(iz_u).le.hb_u(ilu)                      &amp;    <a name='3494'>
                    .and.z_u(iz_u+1).gt.hb_u(ilu))then            <a name='3495'>
                        ss_u(iz_u)=ss_u(iz_u)+hi_urb1D(ilu)<a name='3496'>
                  endif <a name='3497'>
               enddo<a name='3498'>
            enddo<a name='3499'>
<a name='3500'>
            pb_u(1)=1.<a name='3501'>
            do iz_u=1,nzu<a name='3502'>
               pb_u(iz_u+1)=max(0.,pb_u(iz_u)-ss_u(iz_u))<a name='3503'>
            enddo<a name='3504'>
<a name='3505'>
20    continue    <a name='3506'>
      return<a name='3507'>
      end subroutine icBEPHI_XY<a name='3508'>
<font color=#447700>! ===6=8===============================================================72<a name='3509'></font>
<font color=#447700>! ===6=8===============================================================72<a name='3510'></font>
END MODULE module_sf_bep<a name='3511'>
</pre></body></html>