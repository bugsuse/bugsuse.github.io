<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#define LSMRUC_DBG_LVL 3000<a name='2'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='3'></font>
<font color=#447700>!<a name='4'></font>
<A NAME='MODULE_SF_RUCLSM'><A href='../../html_code/phys/module_sf_ruclsm.F.html#MODULE_SF_RUCLSM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sf_ruclsm</font> <A href='../../call_to/MODULE_SF_RUCLSM.html' TARGET='index'>2</A><a name='6'>
<a name='7'>
<font color=#447700>! Notes for perturbations of soil properties (Judith Berner)<a name='8'></font>
<font color=#447700>! Perturbations are applied in subroutine soilprob to array hydro;<a name='9'></font>
<font color=#447700>! soilprop is called from subroutine SFCTMP which is called from subroutine LSMRUC;<a name='10'></font>
<font color=#447700>! subroutine LSMRUC had two new 3D fields: pattern_spp_lsm (in) and field_sf(inout);<a name='11'></font>
<font color=#447700>!    their vertical dimension is number of atmospheric levels (kms:kme) - (suboptimal, but easiest hack)<a name='12'></font>
<font color=#447700>!    field_sf is used to pass perturbed fields of hydrop up to model (and output) driver;<a name='13'></font>
<font color=#447700>! in argument list to SFCTMP the arrays are passed as pattern_spp_lsm(i,1:nzs,j), and exist henceforth as<a name='14'></font>
<font color=#447700>! column arrays;<a name='15'></font>
<font color=#447700>! in the subroutines below SFCTMP (SNOW and SNOWSOIL) the fields are called rstochcol,fieldcol_sf<a name='16'></font>
<font color=#447700>! to reflect their dimension rstochcol (1:nzs)<a name='17'></font>
<a name='18'>
<a name='19'>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#module_sf_ruclsm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_101"><a name='20'>
  USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#module_sf_ruclsm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_89"><a name='21'>
<a name='22'>
<font color=#447700>! VEGETATION PARAMETERS<a name='23'></font>
        INTEGER :: LUCATS , BARE, NATURAL, CROP, URBAN<a name='24'>
        integer, PARAMETER :: NLUS=50<a name='25'>
        CHARACTER*8 LUTYPE<a name='26'>
        INTEGER, DIMENSION(1:NLUS) :: IFORTBL<a name='27'>
        real, dimension(1:NLUS) ::  SNUPTBL, RSTBL, RGLTBL, HSTBL, LAITBL,         &amp;<a name='28'>
                                    ALBTBL, Z0TBL, LEMITBL, PCTBL, SHDTBL, MAXALB<a name='29'>
        REAL ::   TOPT_DATA,CMCMAX_DATA,CFACTR_DATA,RSMAX_DATA<a name='30'>
<font color=#447700>! SOIL PARAMETERS<a name='31'></font>
        INTEGER :: SLCATS<a name='32'>
        INTEGER, PARAMETER :: NSLTYPE=30<a name='33'>
        CHARACTER*8 SLTYPE<a name='34'>
        REAL, DIMENSION (1:NSLTYPE) :: BB,DRYSMC,HC,                           &amp;<a name='35'>
        MAXSMC, REFSMC,SATPSI,SATDK,SATDW, WLTSMC,QTZ<a name='36'>
<a name='37'>
<font color=#447700>! LSM GENERAL PARAMETERS<a name='38'></font>
        INTEGER :: SLPCATS<a name='39'>
        INTEGER, PARAMETER :: NSLOPE=30<a name='40'>
        REAL, DIMENSION (1:NSLOPE) :: SLOPE_DATA<a name='41'>
        REAL ::  SBETA_DATA,FXEXP_DATA,CSOIL_DATA,SALP_DATA,REFDK_DATA,           &amp;<a name='42'>
                 REFKDT_DATA,FRZK_DATA,ZBOT_DATA,  SMLOW_DATA,SMHIGH_DATA,        &amp;<a name='43'>
                        CZIL_DATA<a name='44'>
<a name='45'>
        CHARACTER*256  :: err_message<a name='46'>
<a name='47'>
<a name='48'>
CONTAINS<a name='49'>
<a name='50'>
<font color=#447700>!-----------------------------------------------------------------<a name='51'></font>
<A NAME='LSMRUC'><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='52'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>LSMRUC</font>(spp_lsm,                                   &amp; <A href='../../call_to/LSMRUC.html' TARGET='index'>1</A>,<A href='../../call_from/LSMRUC.html' TARGET='index'>9</A><a name='53'>
#if (EM_CORE==1)<a name='54'>
                   pattern_spp_lsm,field_sf,                     &amp;<a name='55'>
#endif<a name='56'>
                   DT,KTAU,NSL,                                  &amp;<a name='57'>
#if (EM_CORE==1)<a name='58'>
                   lakemodel,lakemask,                           &amp;<a name='59'>
                   graupelncv,snowncv,rainncv,                   &amp;<a name='60'>
#endif<a name='61'>
                   ZS,RAINBL,SNOW,SNOWH,SNOWC,FRZFRAC,frpcpn,    &amp;<a name='62'>
                   rhosnf,precipfr,                              &amp; <font color=#447700>! pass it out to module_diagnostics<a name='63'></font>
                   Z3D,P8W,T3D,QV3D,QC3D,RHO3D,                  &amp; <font color=#447700>!p8W in [PA]<a name='64'></font>
                   GLW,GSW,EMISS,CHKLOWQ, CHS,                   &amp; <a name='65'>
                   FLQC,FLHC,MAVAIL,CANWAT,VEGFRA,ALB,ZNT,       &amp;<a name='66'>
                   Z0,SNOALB,ALBBCK,LAI,                         &amp;  <font color=#447700>!new<a name='67'></font>
                   mminlu, landusef, nlcat, mosaic_lu,           &amp;<a name='68'>
                   mosaic_soil, soilctop, nscat,                 &amp;  <font color=#447700>!new<a name='69'></font>
                   QSFC,QSG,QVG,QCG,DEW,SOILT1,TSNAV,            &amp;<a name='70'>
                   TBOT,IVGTYP,ISLTYP,XLAND,                     &amp;<a name='71'>
                   ISWATER,ISICE,XICE,XICE_THRESHOLD,            &amp;<a name='72'>
                   CP,ROVCP,G0,LV,STBOLT,                        &amp;<a name='73'>
                   SOILMOIS,SH2O,SMAVAIL,SMMAX,                  &amp;<a name='74'>
                   TSO,SOILT,HFX,QFX,LH,                         &amp;<a name='75'>
                   SFCRUNOFF,UDRUNOFF,ACRUNOFF,SFCEXC,           &amp;<a name='76'>
                   SFCEVP,GRDFLX,SNOWFALLAC,ACSNOW,SNOM,         &amp;<a name='77'>
                   SMFR3D,KEEPFR3DFLAG,                          &amp;<a name='78'>
                   myj,shdmin,shdmax,rdlai2d,                    &amp;<a name='79'>
                   ids,ide, jds,jde, kds,kde,                    &amp;<a name='80'>
                   ims,ime, jms,jme, kms,kme,                    &amp;<a name='81'>
                   its,ite, jts,jte, kts,kte                     )<a name='82'>
<font color=#447700>!-----------------------------------------------------------------<a name='83'></font>
   IMPLICIT NONE<a name='84'>
<font color=#447700>!-----------------------------------------------------------------<a name='85'></font>
<font color=#447700>!<a name='86'></font>
<font color=#447700>! The RUC LSM model is described in:<a name='87'></font>
<font color=#447700>!  Smirnova, T.G., J.M. Brown, and S.G. Benjamin, 1997: <a name='88'></font>
<font color=#447700>!     Performance of different soil model configurations in simulating <a name='89'></font>
<font color=#447700>!     ground surface temperature and surface fluxes. <a name='90'></font>
<font color=#447700>!     Mon. Wea. Rev. 125, 1870-1884.<a name='91'></font>
<font color=#447700>!  Smirnova, T.G., J.M. Brown, and D. Kim, 2000: Parameterization of <a name='92'></font>
<font color=#447700>!     cold-season processes in the MAPS land-surface scheme. <a name='93'></font>
<font color=#447700>!     J. Geophys. Res. 105, 4077-4086.<a name='94'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='95'></font>
<font color=#447700>!-- DT            time step (second)<a name='96'></font>
<font color=#447700>!        ktau - number of time step<a name='97'></font>
<font color=#447700>!        NSL  - number of soil layers<a name='98'></font>
<font color=#447700>!        NZS  - number of levels in soil<a name='99'></font>
<font color=#447700>!        ZS   - depth of soil levels (m)<a name='100'></font>
<font color=#447700>!-- RAINBL    - accumulated rain in [mm] between the PBL calls<a name='101'></font>
<font color=#447700>!-- RAINNCV         one time step grid scale precipitation (mm/step)<a name='102'></font>
<font color=#447700>!        SNOW - snow water equivalent [mm]<a name='103'></font>
<font color=#447700>!        FRAZFRAC - fraction of frozen precipitation<a name='104'></font>
<font color=#447700>!-- PRECIPFR (mm) - time step frozen precipitation<a name='105'></font>
<font color=#447700>!-- SNOWC       flag indicating snow coverage (1 for snow cover)<a name='106'></font>
<font color=#447700>!-- Z3D         heights (m)<a name='107'></font>
<font color=#447700>!-- P8W         3D pressure (Pa)<a name='108'></font>
<font color=#447700>!-- T3D         temperature (K)<a name='109'></font>
<font color=#447700>!-- QV3D        3D water vapor mixing ratio (Kg/Kg)<a name='110'></font>
<font color=#447700>!        QC3D - 3D cloud water mixing ratio (Kg/Kg)<a name='111'></font>
<font color=#447700>!       RHO3D - 3D air density (kg/m^3)<a name='112'></font>
<font color=#447700>!-- GLW         downward long wave flux at ground surface (W/m^2)<a name='113'></font>
<font color=#447700>!-- GSW         absorbed short wave flux at ground surface (W/m^2)<a name='114'></font>
<font color=#447700>!-- EMISS       surface emissivity (between 0 and 1)<a name='115'></font>
<font color=#447700>!        FLQC - surface exchange coefficient for moisture (kg/m^2/s)<a name='116'></font>
<font color=#447700>!        FLHC - surface exchange coefficient for heat [W/m^2/s/degreeK]     <a name='117'></font>
<font color=#447700>!      SFCEXC - surface exchange coefficient for heat [m/s]<a name='118'></font>
<font color=#447700>!      CANWAT - CANOPY MOISTURE CONTENT (mm)<a name='119'></font>
<font color=#447700>!      VEGFRA - vegetation fraction (between 0 and 100)<a name='120'></font>
<font color=#447700>!         ALB - surface albedo (between 0 and 1)<a name='121'></font>
<font color=#447700>!      SNOALB - maximum snow albedo (between 0 and 1)<a name='122'></font>
<font color=#447700>!      ALBBCK - snow-free albedo (between 0 and 1)<a name='123'></font>
<font color=#447700>!         ZNT - roughness length [m]<a name='124'></font>
<font color=#447700>!-- TBOT        soil temperature at lower boundary (K)<a name='125'></font>
<font color=#447700>!      IVGTYP - USGS vegetation type (24 classes)<a name='126'></font>
<font color=#447700>!      ISLTYP - STASGO soil type (16 classes)<a name='127'></font>
<font color=#447700>!-- XLAND       land mask (1 for land, 2 for water)<a name='128'></font>
<font color=#447700>!-- CP          heat capacity at constant pressure for dry air (J/kg/K)<a name='129'></font>
<font color=#447700>!-- G0          acceleration due to gravity (m/s^2)<a name='130'></font>
<font color=#447700>!-- LV          latent heat of melting (J/kg)<a name='131'></font>
<font color=#447700>!-- STBOLT      Stefan-Boltzmann constant (W/m^2/K^4)<a name='132'></font>
<font color=#447700>!    SOILMOIS - soil moisture content (volumetric fraction)<a name='133'></font>
<font color=#447700>!         TSO - soil temp (K)<a name='134'></font>
<font color=#447700>!-- SOILT       surface temperature (K)<a name='135'></font>
<font color=#447700>!-- HFX         upward heat flux at the surface (W/m^2)<a name='136'></font>
<font color=#447700>!-- QFX         upward moisture flux at the surface (kg/m^2/s)<a name='137'></font>
<font color=#447700>!-- LH          upward latent heat flux (W/m^2)<a name='138'></font>
<font color=#447700>!   SFCRUNOFF - ground surface runoff [mm]<a name='139'></font>
<font color=#447700>!   UDRUNOFF - underground runoff [mm]<a name='140'></font>
<font color=#447700>!   ACRUNOFF - run-total surface runoff [mm]<a name='141'></font>
<font color=#447700>!   SFCEVP - total evaporation in [kg/m^2]<a name='142'></font>
<font color=#447700>!   GRDFLX - soil heat flux (W/m^2: negative, if downward from surface)<a name='143'></font>
<font color=#447700>!   SNOWFALLAC - run-total snowfall accumulation [mm]   <a name='144'></font>
<font color=#447700>!   ACSNOW - run-toral SWE of snowfall [mm]   <a name='145'></font>
<font color=#447700>!-- CHKLOWQ - is either 0 or 1 (so far set equal to 1).<a name='146'></font>
<font color=#447700>!--           used only in MYJPBL. <a name='147'></font>
<font color=#447700>!-- tice - sea ice temperture (C)<a name='148'></font>
<font color=#447700>!-- rhosice - sea ice density (kg m^-3)<a name='149'></font>
<font color=#447700>!-- capice - sea ice volumetric heat capacity (J/m^3/K)<a name='150'></font>
<font color=#447700>!-- thdifice - sea ice thermal diffusivity (m^2/s)<a name='151'></font>
<font color=#447700>!--<a name='152'></font>
<font color=#447700>!-- ims           start index for i in memory<a name='153'></font>
<font color=#447700>!-- ime           end index for i in memory<a name='154'></font>
<font color=#447700>!-- jms           start index for j in memory<a name='155'></font>
<font color=#447700>!-- jme           end index for j in memory<a name='156'></font>
<font color=#447700>!-- kms           start index for k in memory<a name='157'></font>
<font color=#447700>!-- kme           end index for k in memory<a name='158'></font>
<font color=#447700>!-------------------------------------------------------------------------<a name='159'></font>
<font color=#447700>!   INTEGER,     PARAMETER            ::     nzss=5<a name='160'></font>
<font color=#447700>!   INTEGER,     PARAMETER            ::     nddzs=2*(nzss-2)<a name='161'></font>
<a name='162'>
   INTEGER,     PARAMETER            ::     nvegclas=24+3<a name='163'>
<a name='164'>
   REAL,       INTENT(IN   )    ::     DT<a name='165'>
   LOGICAL,    INTENT(IN   )    ::     myj,frpcpn<a name='166'>
   INTEGER,    INTENT(IN   )    ::     spp_lsm<a name='167'>
   INTEGER,    INTENT(IN   )    ::     NLCAT, NSCAT, mosaic_lu, mosaic_soil<a name='168'>
   INTEGER,    INTENT(IN   )    ::     ktau, nsl, isice, iswater, &amp;<a name='169'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='170'>
                                       ids,ide, jds,jde, kds,kde, &amp;<a name='171'>
                                       its,ite, jts,jte, kts,kte<a name='172'>
<a name='173'>
#if (EM_CORE==1)<a name='174'>
   REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ),OPTIONAL::    pattern_spp_lsm<a name='175'>
   REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ),OPTIONAL::    field_sf<a name='176'>
#endif<a name='177'>
   REAL,    DIMENSION( ims:ime, 1  :nsl, jms:jme )         ::    field_sf_loc<a name='178'>
<a name='179'>
   REAL,    DIMENSION( ims:ime, kms:kme, jms:jme )            , &amp;<a name='180'>
            INTENT(IN   )    ::                           QV3D, &amp;<a name='181'>
                                                          QC3D, &amp;<a name='182'>
                                                           p8w, &amp;<a name='183'>
                                                         rho3D, &amp;<a name='184'>
                                                           T3D, &amp;<a name='185'>
                                                           z3D<a name='186'>
<a name='187'>
   REAL,       DIMENSION( ims:ime , jms:jme ),                   &amp;<a name='188'>
               INTENT(IN   )    ::                       RAINBL, &amp;<a name='189'>
                                                            GLW, &amp;<a name='190'>
                                                            GSW, &amp;<a name='191'>
                                                         ALBBCK, &amp;<a name='192'>
                                                           FLHC, &amp;<a name='193'>
                                                           FLQC, &amp;<a name='194'>
                                                           CHS , &amp;<a name='195'>
                                                           XICE, &amp;<a name='196'>
                                                          XLAND, &amp;<a name='197'>
<font color=#447700>!                                                         ALBBCK, &amp;<a name='198'></font>
                                                         VEGFRA, &amp;<a name='199'>
                                                           TBOT<a name='200'>
<a name='201'>
#if (EM_CORE==1)<a name='202'>
   REAL,       DIMENSION( ims:ime , jms:jme ),                   &amp;<a name='203'>
               INTENT(IN   )    ::                   GRAUPELNCV, &amp;<a name='204'>
                                                        SNOWNCV, &amp;<a name='205'>
                                                        RAINNCV<a name='206'>
   REAL,       DIMENSION( ims:ime , jms:jme ),                   &amp;<a name='207'>
               INTENT(IN   )    ::                     lakemask<a name='208'>
   INTEGER,    INTENT(IN   )    ::                    LakeModel<a name='209'>
#endif<a name='210'>
<a name='211'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN )::   SHDMAX<a name='212'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN )::   SHDMIN<a name='213'>
   LOGICAL, intent(in) :: rdlai2d<a name='214'>
<a name='215'>
   REAL,       DIMENSION( 1:nsl), INTENT(IN   )      ::      ZS<a name='216'>
<a name='217'>
   REAL,       DIMENSION( ims:ime , jms:jme ),                   &amp;<a name='218'>
               INTENT(INOUT)    ::                               &amp;<a name='219'>
                                                           SNOW, &amp;<a name='220'>
                                                          SNOWH, &amp;<a name='221'>
                                                          SNOWC, &amp;<a name='222'>
                                                         CANWAT, &amp; <font color=#447700>! new<a name='223'></font>
                                                         SNOALB, &amp;<a name='224'>
                                                            ALB, &amp;<a name='225'>
                                                          EMISS, &amp;<a name='226'>
                                                            LAI, &amp;<a name='227'>
                                                         MAVAIL, &amp; <a name='228'>
                                                         SFCEXC, &amp;<a name='229'>
                                                            Z0 , &amp;<a name='230'>
                                                            ZNT<a name='231'>
<a name='232'>
   REAL,       DIMENSION( ims:ime , jms:jme ),                   &amp;<a name='233'>
               INTENT(IN   )    ::                               &amp;<a name='234'>
                                                        FRZFRAC<a name='235'>
<a name='236'>
   INTEGER,    DIMENSION( ims:ime , jms:jme ),                   &amp;<a name='237'>
               INTENT(IN   )    ::                       IVGTYP, &amp;<a name='238'>
                                                         ISLTYP<a name='239'>
   CHARACTER(LEN=*), INTENT(IN   )    ::                 MMINLU<a name='240'>
   REAL,     DIMENSION( ims:ime , 1:nlcat, jms:jme ), INTENT(IN):: LANDUSEF<a name='241'>
   REAL,     DIMENSION( ims:ime , 1:nscat, jms:jme ), INTENT(IN):: SOILCTOP<a name='242'>
<a name='243'>
   REAL, INTENT(IN   )          ::         CP,ROVCP,G0,LV,STBOLT,XICE_threshold<a name='244'>
 <a name='245'>
   REAL,       DIMENSION( ims:ime , 1:nsl, jms:jme )           , &amp;<a name='246'>
               INTENT(INOUT)    ::                 SOILMOIS,SH2O,TSO<a name='247'>
<a name='248'>
   REAL,       DIMENSION( ims:ime, jms:jme )                   , &amp;<a name='249'>
               INTENT(INOUT)    ::                        SOILT, &amp;<a name='250'>
                                                            HFX, &amp;<a name='251'>
                                                            QFX, &amp;<a name='252'>
                                                             LH, &amp;<a name='253'>
                                                         SFCEVP, &amp;<a name='254'>
                                                      SFCRUNOFF, &amp;<a name='255'>
                                                       UDRUNOFF, &amp;<a name='256'>
                                                       ACRUNOFF, &amp;<a name='257'>
                                                         GRDFLX, &amp;<a name='258'>
                                                         ACSNOW, &amp;<a name='259'>
                                                           SNOM, &amp;<a name='260'>
                                                            QVG, &amp;<a name='261'>
                                                            QCG, &amp;<a name='262'>
                                                            DEW, &amp;<a name='263'>
                                                           QSFC, &amp;<a name='264'>
                                                            QSG, &amp;<a name='265'>
                                                        CHKLOWQ, &amp;<a name='266'>
                                                         SOILT1, &amp;<a name='267'>
                                                          TSNAV<a name='268'>
<a name='269'>
   REAL,       DIMENSION( ims:ime, jms:jme )                   , &amp; <a name='270'>
               INTENT(INOUT)    ::                      SMAVAIL, &amp;<a name='271'>
                                                          SMMAX<a name='272'>
<a name='273'>
   REAL,       DIMENSION( its:ite, jts:jte )    ::               &amp;<a name='274'>
                                                             PC, &amp;<a name='275'>
                                                        RUNOFF1, &amp;<a name='276'>
                                                        RUNOFF2, &amp;<a name='277'>
                                                         EMISSL, &amp;<a name='278'>
                                                           ZNTL, &amp;<a name='279'>
                                                        LMAVAIL, &amp;<a name='280'>
                                                          SMELT, &amp;<a name='281'>
                                                           SNOH, &amp;<a name='282'>
                                                          SNFLX, &amp;<a name='283'>
                                                           EDIR, &amp;<a name='284'>
                                                             EC, &amp;<a name='285'>
                                                            ETT, &amp;<a name='286'>
                                                         SUBLIM, &amp;<a name='287'>
                                                           sflx, &amp;<a name='288'>
                                                            smf, &amp;<a name='289'>
                                                          EVAPL, &amp;<a name='290'>
                                                          PRCPL, &amp;<a name='291'>
                                                         SEAICE, &amp;<a name='292'>
                                                        INFILTR<a name='293'>
<font color=#447700>! Energy and water budget variables:<a name='294'></font>
   REAL,       DIMENSION( its:ite, jts:jte )    ::               &amp;<a name='295'>
                                                         budget, &amp;<a name='296'>
                                                       acbudget, &amp;<a name='297'>
                                                    waterbudget, &amp;<a name='298'>
                                                  acwaterbudget, &amp;<a name='299'>
                                                       smtotold, &amp;<a name='300'>
                                                        snowold, &amp;<a name='301'>
                                                      canwatold<a name='302'>
<a name='303'>
<a name='304'>
   REAL,       DIMENSION( ims:ime, 1:nsl, jms:jme)               &amp;<a name='305'>
                                             ::    KEEPFR3DFLAG, &amp;<a name='306'>
                                                         SMFR3D<a name='307'>
<a name='308'>
   REAL,       DIMENSION( ims:ime, jms:jme ), INTENT(OUT)     :: &amp;<a name='309'>
                                                         RHOSNF, &amp; <font color=#447700>!RHO of snowfall<a name='310'></font>
                                                       PRECIPFR, &amp; <font color=#447700>! time-step frozen precip<a name='311'></font>
                                                     SNOWFALLAC<a name='312'>
<font color=#447700>!--- soil/snow properties<a name='313'></font>
   REAL                                                          &amp;<a name='314'>
                             ::                           RHOCS, &amp;<a name='315'>
                                                       RHONEWSN, &amp;<a name='316'>
                                                          RHOSN, &amp;<a name='317'>
                                                      RHOSNFALL, &amp;<a name='318'>
                                                           BCLH, &amp;<a name='319'>
                                                            DQM, &amp;<a name='320'>
                                                           KSAT, &amp;<a name='321'>
                                                           PSIS, &amp;<a name='322'>
                                                           QMIN, &amp;<a name='323'>
                                                          QWRTZ, &amp;<a name='324'>
                                                            REF, &amp;<a name='325'>
                                                           WILT, &amp;<a name='326'>
                                                        CANWATR, &amp;<a name='327'>
                                                       SNOWFRAC, &amp;<a name='328'>
                                                          SNHEI, &amp;<a name='329'>
                                                           SNWE<a name='330'>
<a name='331'>
   REAL                                      ::              CN, &amp;<a name='332'>
                                                         SAT,CW, &amp;<a name='333'>
                                                           C1SN, &amp;<a name='334'>
                                                           C2SN, &amp;<a name='335'>
                                                         KQWRTZ, &amp;<a name='336'>
                                                           KICE, &amp;<a name='337'>
                                                            KWT<a name='338'>
<a name='339'>
<a name='340'>
   REAL,     DIMENSION(1:NSL)                ::          ZSMAIN, &amp;<a name='341'>
                                                         ZSHALF, &amp;<a name='342'>
                                                         DTDZS2<a name='343'>
<a name='344'>
   REAL,     DIMENSION(1:2*(nsl-2))          ::           DTDZS<a name='345'>
<a name='346'>
   REAL,     DIMENSION(1:5001)               ::             TBQ<a name='347'>
<a name='348'>
<a name='349'>
   REAL,     DIMENSION( 1:nsl )              ::         SOILM1D, &amp; <a name='350'>
                                                          TSO1D, &amp;<a name='351'>
                                                        SOILICE, &amp;<a name='352'>
                                                        SOILIQW, &amp;<a name='353'>
                                                       SMFRKEEP<a name='354'>
<a name='355'>
   REAL,     DIMENSION( 1:nsl )              ::          KEEPFR<a name='356'>
                                                <a name='357'>
   REAL,     DIMENSION( 1:nlcat )            ::          lufrac<a name='358'>
   REAL,     DIMENSION( 1:nscat )            ::          soilfrac<a name='359'>
<a name='360'>
   REAL                           ::                        RSM, &amp;<a name='361'>
                                                      SNWEPRINT, &amp;<a name='362'>
                                                     SNHEIPRINT<a name='363'>
<a name='364'>
   REAL                           ::                     PRCPMS, &amp;<a name='365'>
                                                        NEWSNMS, &amp;<a name='366'>
                                                      prcpncliq, &amp;<a name='367'>
                                                       prcpncfr, &amp;<a name='368'>
                                                      prcpculiq, &amp;<a name='369'>
                                                       prcpcufr, &amp;<a name='370'>
                                                           PATM, &amp;<a name='371'>
                                                          PATMB, &amp;<a name='372'>
                                                           TABS, &amp;<a name='373'>
                                                          QVATM, &amp;<a name='374'>
                                                          QCATM, &amp;<a name='375'>
                                                          Q2SAT, &amp;<a name='376'>
                                                         CONFLX, &amp;<a name='377'>
                                                            RHO, &amp;<a name='378'>
                                                           QKMS, &amp;<a name='379'>
                                                           TKMS, &amp;<a name='380'>
                                                        snowrat, &amp;<a name='381'>
                                                       grauprat, &amp;<a name='382'>
                                                         icerat, &amp;<a name='383'>
                                                          curat, &amp;<a name='384'>
                                                       INFILTRP<a name='385'>
   REAL      ::  cq,r61,r273,arp,brp,x,evs,eis<a name='386'>
   REAL      ::  cropsm<a name='387'>
<a name='388'>
   REAL      ::  meltfactor, ac,as, wb<a name='389'>
   INTEGER   ::  NROOT<a name='390'>
   INTEGER   ::  ILAND,ISOIL,IFOREST<a name='391'>
 <a name='392'>
   INTEGER   ::  I,J,K,NZS,NZS1,NDDZS<a name='393'>
   INTEGER   ::  k1,l,k2,kp,km<a name='394'>
   CHARACTER (LEN=132) :: message<a name='395'>
<a name='396'>
   REAL,DIMENSION(ims:ime,1:nsl,jms:jme) :: rstoch <a name='397'>
<a name='398'>
<font color=#447700>!-----------------------------------------------------------------<a name='399'></font>
         NZS=NSL<a name='400'>
         NDDZS=2*(nzs-2)<a name='401'>
<a name='402'>
         rstoch=0.0<a name='403'>
         field_sf_loc=0.0<a name='404'>
<font color=#447700>!beka added<a name='405'></font>
#if (EM_CORE==1)<a name='406'>
       if (spp_lsm==1) then<a name='407'>
         do J=jts,jte<a name='408'>
           do i=its,ite<a name='409'>
             do k=1,nsl<a name='410'>
               rstoch(i,k,j) = pattern_spp_lsm(i,k,j)<a name='411'>
               field_sf_loc(i,k,j)=field_sf(i,k,j)<a name='412'>
             enddo<a name='413'>
           enddo<a name='414'>
         enddo <a name='415'>
       endif  <a name='416'>
#endif<a name='417'>
<font color=#447700>!---- table TBQ is for resolution of balance equation in VILKA<a name='418'></font>
        CQ=173.15-.05<a name='419'>
        R273=1./273.15<a name='420'>
        R61=6.1153*0.62198<a name='421'>
        ARP=77455.*41.9/461.525<a name='422'>
        BRP=64.*41.9/461.525<a name='423'>
<a name='424'>
        DO K=1,5001<a name='425'>
          CQ=CQ+.05<a name='426'>
<font color=#447700>!          TBQ(K)=R61*EXP(ARP*(R273-1./CQ)-BRP*LOG(CQ*R273))<a name='427'></font>
        EVS=EXP(17.67*(CQ-273.15)/(CQ-29.65))<a name='428'>
        EIS=EXP(22.514-6.15E3/CQ)<a name='429'>
        if(CQ.ge.273.15) then<a name='430'>
<font color=#447700>! tbq is in mb<a name='431'></font>
        tbq(k) = R61*evs<a name='432'>
        else<a name='433'>
        tbq(k) = R61*eis<a name='434'>
        endif<a name='435'>
<a name='436'>
        END DO<a name='437'>
<a name='438'>
<font color=#447700>!--- Initialize soil/vegetation parameters<a name='439'></font>
<font color=#447700>!--- This is temporary until SI is added to mass coordinate ---!!!!!<a name='440'></font>
<a name='441'>
#if ( NMM_CORE == 1 )<a name='442'>
     if(ktau+1.eq.1) then<a name='443'>
#else<a name='444'>
     if(ktau.eq.1) then<a name='445'>
#endif<a name='446'>
     DO J=jts,jte<a name='447'>
         DO i=its,ite<a name='448'>
            do k=1,nsl<a name='449'>
       keepfr3dflag(i,k,j)=0.<a name='450'>
            enddo<a name='451'>
<font color=#447700>!--- initializing snow fraction, thereshold = 32 mm of snow water <a name='452'></font>
<font color=#447700>!    or ~100 mm of snow height<a name='453'></font>
<font color=#447700>!<a name='454'></font>
           snowc(i,j) = min(1.,snow(i,j)/32.)<a name='455'>
          if(snow(i,j).le.32.) soilt1(i,j)=tso(i,1,j)<a name='456'>
<font color=#447700>!--- initializing inside snow temp if it is not defined<a name='457'></font>
        IF((soilt1(i,j) .LT. 170.) .or. (soilt1(i,j) .GT.400.)) THEN<a name='458'>
            IF(snow(i,j).gt.32.) THEN<a name='459'>
           soilt1(i,j)=0.5*(soilt(i,j)+tso(i,1,j))<a name='460'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='461'>
        WRITE ( message , FMT='(A,F8.3,2I6)' ) &amp;<a name='462'>
       'Temperature inside snow is initialized in RUCLSM ', soilt1(i,j),i,j<a name='463'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_835"> ( 0 , message )<a name='464'>
    ENDIF<a name='465'>
            ELSE<a name='466'>
           soilt1(i,j) = tso(i,1,j)<a name='467'>
            ENDIF<a name='468'>
        ENDIF<a name='469'>
           tsnav(i,j) =0.5*(soilt(i,j)+tso(i,1,j))-273.15<a name='470'>
           qcg  (i,j) =0.<a name='471'>
           patmb=P8w(i,kms,j)*1.e-2<a name='472'>
           QSG  (i,j) = <A href='../../html_code/phys/module_sf_ruclsm.F.html#QSN'>QSN</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSN_1">(SOILT(i,j),TBQ)/PATMB<a name='473'>
        IF((qvg(i,j) .LE. 0.) .or. (qvg(i,j) .GT.0.1)) THEN<a name='474'>
           qvg  (i,j) = QSG(i,j)*mavail(i,j)<a name='475'>
          IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='476'>
           WRITE ( message , FMT='(A,3F8.3,2I6)' ) &amp;<a name='477'>
          'QVG is initialized in RUCLSM ', qvg(i,j),mavail(i,j),qsg(i,j),i,j<a name='478'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_836"> ( 0 , message )<a name='479'>
          ENDIF<a name='480'>
        ENDIF<a name='481'>
           qsfc(i,j) = qvg(i,j)/(1.+qvg(i,j))<a name='482'>
           SMELT(i,j) = 0.<a name='483'>
           SNOM (i,j) = 0.<a name='484'>
           SNOWFALLAC(i,j) = 0.<a name='485'>
           PRECIPFR(i,j) = 0.<a name='486'>
           RHOSNF(i,j) = -1.e3 <font color=#447700>! non-zero flag<a name='487'></font>
           SNFLX(i,j) = 0.<a name='488'>
           DEW  (i,j) = 0.<a name='489'>
           PC   (i,j) = 0.<a name='490'>
           zntl (i,j) = 0.<a name='491'>
           RUNOFF1(i,j) = 0.<a name='492'>
           RUNOFF2(i,j) = 0.<a name='493'>
           SFCRUNOFF(i,j) = 0.<a name='494'>
           UDRUNOFF(i,j) = 0.<a name='495'>
           ACRUNOFF(i,j) = 0.<a name='496'>
           emissl (i,j) = 0.<a name='497'>
           budget(i,j) = 0.<a name='498'>
           acbudget(i,j) = 0.<a name='499'>
           waterbudget(i,j) = 0.<a name='500'>
           acwaterbudget(i,j) = 0.<a name='501'>
           smtotold(i,j)=0.<a name='502'>
           canwatold(i,j)=0.<a name='503'>
<font color=#447700>! Temporarily!!!<a name='504'></font>
<font color=#447700>!           canwat(i,j)=0.<a name='505'></font>
<a name='506'>
<font color=#447700>! For RUC LSM CHKLOWQ needed for MYJPBL should <a name='507'></font>
<font color=#447700>! 1 because is actual specific humidity at the surface, and<a name='508'></font>
<font color=#447700>! not the saturation value<a name='509'></font>
           chklowq(i,j) = 1.<a name='510'>
           infiltr(i,j) = 0.<a name='511'>
           snoh  (i,j) = 0.<a name='512'>
           edir  (i,j) = 0.<a name='513'>
           ec    (i,j) = 0.<a name='514'>
           ett   (i,j) = 0.<a name='515'>
           sublim(i,j) = 0.<a name='516'>
           sflx  (i,j) = 0.<a name='517'>
           smf   (i,j) = 0.<a name='518'>
           evapl (i,j) = 0.<a name='519'>
           prcpl (i,j) = 0.<a name='520'>
         ENDDO<a name='521'>
     ENDDO<a name='522'>
<a name='523'>
        do k=1,nsl<a name='524'>
           soilice(k)=0.<a name='525'>
           soiliqw(k)=0.<a name='526'>
        enddo<a name='527'>
     endif<a name='528'>
<a name='529'>
<font color=#447700>!-----------------------------------------------------------------<a name='530'></font>
<a name='531'>
        PRCPMS = 0.<a name='532'>
        newsnms = 0.<a name='533'>
        prcpncliq = 0.<a name='534'>
        prcpculiq = 0.<a name='535'>
        prcpncfr = 0.<a name='536'>
        prcpcufr = 0.<a name='537'>
<a name='538'>
<a name='539'>
   DO J=jts,jte<a name='540'>
<a name='541'>
      DO i=its,ite<a name='542'>
<a name='543'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='544'>
      print *,' IN LSMRUC ','ims,ime,jms,jme,its,ite,jts,jte,nzs', &amp;<a name='545'>
                ims,ime,jms,jme,its,ite,jts,jte,nzs<a name='546'>
      print *,' IVGTYP, ISLTYP ', ivgtyp(i,j),isltyp(i,j)<a name='547'>
      print *,' MAVAIL ', mavail(i,j)<a name='548'>
      print *,' SOILT,QVG,P8w',soilt(i,j),qvg(i,j),p8w(i,1,j)<a name='549'>
      print *, 'LSMRUC, I,J,xland, QFX,HFX from SFCLAY',i,j,xland(i,j), &amp;<a name='550'>
                  qfx(i,j),hfx(i,j)<a name='551'>
      print *, ' GSW, GLW =',gsw(i,j),glw(i,j)<a name='552'>
      print *, 'SOILT, TSO start of time step =',soilt(i,j),(tso(i,k,j),k=1,nsl)<a name='553'>
      print *, 'SOILMOIS start of time step =',(soilmois(i,k,j),k=1,nsl)<a name='554'>
      print *, 'SMFROZEN start of time step =',(smfr3d(i,k,j),k=1,nsl)<a name='555'>
      print *, ' I,J=, after SFCLAY CHS,FLHC ',i,j,chs(i,j),flhc(i,j)<a name='556'>
      print *, 'LSMRUC, IVGTYP,ISLTYP,ALB = ', ivgtyp(i,j),isltyp(i,j),alb(i,j),i,j<a name='557'>
      print *, 'LSMRUC  I,J,DT,RAINBL =',I,J,dt,RAINBL(i,j)<a name='558'>
      print *, 'XLAND ----&gt;, ivgtype,isoiltyp,i,j',xland(i,j),ivgtyp(i,j),isltyp(i,j),i,j<a name='559'>
    ENDIF<a name='560'>
<a name='561'>
<a name='562'>
         ILAND     = IVGTYP(i,j)<a name='563'>
         ISOIL     = ISLTYP(I,J)<a name='564'>
         TABS      = T3D(i,kms,j)<a name='565'>
         QVATM     = QV3D(i,kms,j)<a name='566'>
         QCATM     = QC3D(i,kms,j)<a name='567'>
         PATM      = P8w(i,kms,j)*1.e-5<a name='568'>
<font color=#447700>!-- Z3D(1) is thickness between first full sigma level and the surface, <a name='569'></font>
<font color=#447700>!-- but first mass level is at the half of the first sigma level <a name='570'></font>
<font color=#447700>!-- (u and v are also at the half of first sigma level)<a name='571'></font>
         CONFLX    = Z3D(i,kms,j)*0.5<a name='572'>
         RHO       = RHO3D(I,kms,J)<a name='573'>
<font color=#447700>! -- initialize snow, graupel and ice fractions in frozen precip<a name='574'></font>
         snowrat = 0.<a name='575'>
         grauprat = 0.<a name='576'>
         icerat = 0.<a name='577'>
         curat = 0.<a name='578'>
       IF(FRPCPN) THEN<a name='579'>
#if (EM_CORE==1)<a name='580'>
         prcpncliq = rainncv(i,j)*(1.-frzfrac(i,j))<a name='581'>
         prcpncfr = rainncv(i,j)*frzfrac(i,j)<a name='582'>
<font color=#447700>!- apply the same frozen precipitation fraction to convective precip<a name='583'></font>
       if(frzfrac(i,j) &gt; 0.) then<a name='584'>
         prcpculiq = max(0.,(rainbl(i,j)-rainncv(i,j))*(1.-frzfrac(i,j)))<a name='585'>
         prcpcufr = max(0.,(rainbl(i,j)-rainncv(i,j))*frzfrac(i,j))<a name='586'>
       else<a name='587'>
          if(tabs &lt; 273.) then<a name='588'>
            prcpcufr = max(0.,(rainbl(i,j)-rainncv(i,j)))<a name='589'>
            prcpculiq = 0.<a name='590'>
          else<a name='591'>
            prcpcufr = 0.<a name='592'>
            prcpculiq = max(0.,(rainbl(i,j)-rainncv(i,j)))<a name='593'>
          endif  <font color=#447700>! tabs &lt; 273.<a name='594'></font>
       endif  <font color=#447700>! frzfrac &gt; 0.<a name='595'></font>
<font color=#447700>!--- 1*e-3 is to convert from mm/s to m/s<a name='596'></font>
         PRCPMS   = (prcpncliq + prcpculiq)/DT*1.e-3<a name='597'>
         NEWSNMS  = (prcpncfr + prcpcufr)/DT*1.e-3<a name='598'>
<font color=#447700>!         PRCPMS    = (RAINBL(i,j)/DT*1.e-3)*(1-FRZFRAC(I,J))<a name='599'></font>
<font color=#447700>!         NEWSNMS  = (RAINBL(i,j)/DT*1.e-3)*FRZFRAC(I,J)<a name='600'></font>
<a name='601'>
         if((prcpncfr + prcpcufr) &gt; 0.) then<a name='602'>
<font color=#447700>! -- calculate snow, graupel and ice fractions in falling frozen precip<a name='603'></font>
         snowrat=min(1.,max(0.,snowncv(i,j)/(prcpncfr + prcpcufr)))<a name='604'>
         grauprat=min(1.,max(0.,graupelncv(i,j)/(prcpncfr + prcpcufr)))<a name='605'>
         icerat=min(1.,max(0.,(prcpncfr-snowncv(i,j)-graupelncv(i,j)) &amp;<a name='606'>
               /(prcpncfr + prcpcufr)))<a name='607'>
         curat=min(1.,max(0.,(prcpcufr/(prcpncfr + prcpcufr))))<a name='608'>
         endif<a name='609'>
#else<a name='610'>
         PRCPMS    = (RAINBL(i,j)/DT*1.e-3)*(1-FRZFRAC(I,J))<a name='611'>
         NEWSNMS  = (RAINBL(i,j)/DT*1.e-3)*FRZFRAC(I,J)<a name='612'>
       if(newsnms == 0.) then<a name='613'>
         snowrat = 0.<a name='614'>
       else<a name='615'>
         snowrat = min(1.,newsnms/(newsnms+prcpms))<a name='616'>
       endif<a name='617'>
#endif<a name='618'>
<a name='619'>
       ELSE  <font color=#447700>! .not. FRPCPN<a name='620'></font>
          if (tabs.le.273.15) then<a name='621'>
         PRCPMS    = 0.<a name='622'>
         NEWSNMS   = RAINBL(i,j)/DT*1.e-3<a name='623'>
<font color=#447700>!-- here no info about constituents of frozen precipitation,<a name='624'></font>
<font color=#447700>!-- suppose it is all snow<a name='625'></font>
         snowrat = 1.<a name='626'>
          else<a name='627'>
         PRCPMS    = RAINBL(i,j)/DT*1.e-3<a name='628'>
         NEWSNMS   = 0.<a name='629'>
          endif<a name='630'>
       ENDIF<a name='631'>
<a name='632'>
<font color=#447700>! -- save time-step water equivalent of frozen precipitation in PRECIPFR array to be used in<a name='633'></font>
<font color=#447700>!    module_diagnostics<a name='634'></font>
          precipfr(i,j) = NEWSNMS * DT *1.e3<a name='635'>
<a name='636'>
        if   (myj)   then<a name='637'>
         QKMS=CHS(i,j)<a name='638'>
         TKMS=CHS(i,j)<a name='639'>
        else<a name='640'>
<font color=#447700>!--- convert exchange coeff QKMS to [m/s]<a name='641'></font>
         QKMS=FLQC(I,J)/RHO/MAVAIL(I,J)<a name='642'>
<font color=#447700>!         TKMS=FLHC(I,J)/RHO/CP<a name='643'></font>
         TKMS=FLHC(I,J)/RHO/(CP*(1.+0.84*QVATM))  <font color=#447700>! mynnsfc uses CPM<a name='644'></font>
        endif<a name='645'>
<font color=#447700>!--- convert incoming snow and canwat from mm to m<a name='646'></font>
         SNWE=SNOW(I,J)*1.E-3<a name='647'>
         SNHEI=SNOWH(I,J)<a name='648'>
         CANWATR=CANWAT(I,J)*1.E-3<a name='649'>
<a name='650'>
         SNOWFRAC=SNOWC(I,J)<a name='651'>
         RHOSNFALL=RHOSNF(I,J)<a name='652'>
<a name='653'>
         snowold(i,j)=snwe<a name='654'>
<font color=#447700>!-----<a name='655'></font>
             zsmain(1)=0.<a name='656'>
             zshalf(1)=0.<a name='657'>
          do k=2,nzs<a name='658'>
             zsmain(k)= zs(k)<a name='659'>
             zshalf(k)=0.5*(zsmain(k-1) + zsmain(k))<a name='660'>
          enddo<a name='661'>
<a name='662'>
          do k=1,nlcat<a name='663'>
             lufrac(k) = landusef(i,k,j)<a name='664'>
          enddo<a name='665'>
          do k=1,nscat<a name='666'>
             soilfrac(k) = soilctop(i,k,j)<a name='667'>
          enddo<a name='668'>
<a name='669'>
<font color=#447700>!------------------------------------------------------------<a name='670'></font>
<font color=#447700>!-----  DDZS and DSDZ1 are for implicit solution of soil eqns.<a name='671'></font>
<font color=#447700>!-------------------------------------------------------------<a name='672'></font>
        NZS1=NZS-1<a name='673'>
<font color=#447700>!-----<a name='674'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='675'>
         print *,' DT,NZS1, ZSMAIN, ZSHALF ---&gt;', dt,nzs1,zsmain,zshalf<a name='676'>
    ENDIF<a name='677'>
<a name='678'>
        DO  K=2,NZS1<a name='679'>
          K1=2*K-3<a name='680'>
          K2=K1+1<a name='681'>
          X=DT/2./(ZSHALF(K+1)-ZSHALF(K))<a name='682'>
          DTDZS(K1)=X/(ZSMAIN(K)-ZSMAIN(K-1))<a name='683'>
          DTDZS2(K-1)=X<a name='684'>
          DTDZS(K2)=X/(ZSMAIN(K+1)-ZSMAIN(K))<a name='685'>
        END DO<a name='686'>
<a name='687'>
<font color=#447700>!27jul2011 - CN and SAT are defined in VEGPARM.TBL<a name='688'></font>
<font color=#447700>!        CN=0.5     ! exponent<a name='689'></font>
<font color=#447700>!        SAT=0.0004   ! canopy water saturated<a name='690'></font>
  <a name='691'>
        CW =4.183E6<a name='692'>
<a name='693'>
<a name='694'>
<font color=#447700>!--- Constants used in Johansen soil thermal<a name='695'></font>
<font color=#447700>!--- conductivity method<a name='696'></font>
<a name='697'>
        KQWRTZ=7.7<a name='698'>
        KICE=2.2<a name='699'>
        KWT=0.57<a name='700'>
<a name='701'>
<font color=#447700>!***********************************************************************<a name='702'></font>
<font color=#447700>!--- Constants for snow density calculations C1SN and C2SN<a name='703'></font>
<a name='704'>
        c1sn=0.026<a name='705'>
<font color=#447700>!        c1sn=0.01<a name='706'></font>
        c2sn=21.<a name='707'>
<a name='708'>
<font color=#447700>!***********************************************************************<a name='709'></font>
<a name='710'>
        NROOT= 4<a name='711'>
<font color=#447700>!           ! rooting depth<a name='712'></font>
<a name='713'>
        RHONEWSN = 200.<a name='714'>
       if(SNOW(i,j).gt.0. .and. SNOWH(i,j).gt.0.) then<a name='715'>
        RHOSN = SNOW(i,j)/SNOWH(i,j)<a name='716'>
       else<a name='717'>
        RHOSN = 300.<a name='718'>
       endif<a name='719'>
<a name='720'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='721'>
       if(ktau.eq.1 .and.(i.eq.358.and.j.eq.260)) &amp;<a name='722'>
           print *,'before SOILVEGIN - z0,znt(195,254)',z0(i,j),znt(i,j)<a name='723'>
    ENDIF<a name='724'>
<font color=#447700>!--- initializing soil and surface properties<a name='725'></font>
     CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILVEGIN'>SOILVEGIN</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILVEGIN_1">  ( mosaic_lu, mosaic_soil,soilfrac,nscat,shdmin(i,j),shdmax(i,j),&amp;<a name='726'>
                       NLCAT,ILAND,ISOIL,iswater,MYJ,IFOREST,lufrac,VEGFRA(I,J),     &amp;<a name='727'>
                       EMISSL(I,J),PC(I,J),ZNT(I,J),LAI(I,J),RDLAI2D,                &amp;<a name='728'>
                       QWRTZ,RHOCS,BCLH,DQM,KSAT,PSIS,QMIN,REF,WILT,i,j )<a name='729'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='730'>
      if(ktau.eq.1 .and.(i.eq.358.and.j.eq.260)) &amp;<a name='731'>
         print *,'after SOILVEGIN - z0,znt(375,254),lai(375,254)',z0(i,j),znt(i,j),lai(i,j)<a name='732'>
<a name='733'>
      if(ktau.eq.1 .and. (i.eq.358.and.j.eq.260)) then<a name='734'>
         print *,'NLCAT,iland,lufrac,EMISSL(I,J),PC(I,J),ZNT(I,J),LAI(I,J)', &amp;<a name='735'>
                  NLCAT,iland,lufrac,EMISSL(I,J),PC(I,J),ZNT(I,J),LAI(I,J),i,j<a name='736'>
         print *,'NSCAT,soilfrac,QWRTZ,RHOCS,BCLH,DQM,KSAT,PSIS,QMIN,REF,WILT',&amp;<a name='737'>
                 NSCAT,soilfrac,QWRTZ,RHOCS,BCLH,DQM,KSAT,PSIS,QMIN,REF,WILT,i,j<a name='738'>
      endif<a name='739'>
    ENDIF<a name='740'>
<a name='741'>
        CN=CFACTR_DATA   <font color=#447700>! exponent<a name='742'></font>
<font color=#447700>!        SAT=max(1.e-5,(min(5.e-4,(CMCMAX_DATA * (1.-exp(-0.5*lai(i,j))) * 0.01*VEGFRA(I,J))))) ! canopy water saturated<a name='743'></font>
        SAT = 5.e-4  <font color=#447700>! units [m]<a name='744'></font>
<font color=#447700>!  if(i==666.and.j==282)  print *,'second 666,282 - sat',sat<a name='745'></font>
<a name='746'>
<font color=#447700>!-- definition of number of soil levels in the rooting zone<a name='747'></font>
<font color=#447700>!     IF(iforest(ivgtyp(i,j)).ne.1) THEN<a name='748'></font>
     IF(iforest.gt.2) THEN<a name='749'>
<font color=#447700>!---- all vegetation types except evergreen and mixed forests<a name='750'></font>
<font color=#447700>!18apr08 - define meltfactor for Egglston melting limit:<a name='751'></font>
<font color=#447700>! for open areas factor is 2, and for forests - factor is 0.85<a name='752'></font>
<font color=#447700>! This will make limit on snow melting smaller and let snow stay <a name='753'></font>
<font color=#447700>! longer in the forests.<a name='754'></font>
         meltfactor = 2.0<a name='755'>
<a name='756'>
         do k=2,nzs<a name='757'>
         if(zsmain(k).ge.0.4) then<a name='758'>
            NROOT=K<a name='759'>
            goto  111<a name='760'>
         endif<a name='761'>
         enddo<a name='762'>
     ELSE<a name='763'>
<font color=#447700>!---- evergreen and mixed forests<a name='764'></font>
<font color=#447700>!18apr08 - define meltfactor<a name='765'></font>
<font color=#447700>!         meltfactor = 1.5<a name='766'></font>
<font color=#447700>! 28 March 11 - Previously used value of metfactor= 1.5 needs to be further reduced <a name='767'></font>
<font color=#447700>! to compensate for low snow albedos in the forested areas. <a name='768'></font>
<font color=#447700>! Melting rate in forests will reduce.<a name='769'></font>
         meltfactor = 0.85<a name='770'>
<a name='771'>
         do k=2,nzs<a name='772'>
         if(zsmain(k).ge.1.1) then<a name='773'>
            NROOT=K<a name='774'>
            goto  111<a name='775'>
         endif<a name='776'>
         enddo<a name='777'>
     ENDIF<a name='778'>
 111   continue<a name='779'>
<a name='780'>
<font color=#447700>!-----<a name='781'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='782'>
         print *,' ZNT, LAI, VEGFRA, SAT, EMIS, PC ---&gt;',                &amp;<a name='783'>
                   ZNT(I,J),LAI(I,J),VEGFRA(I,J),SAT,EMISSL(I,J),PC(I,J)<a name='784'>
         print *,' ZS, ZSMAIN, ZSHALF, CONFLX, CN, SAT, ---&gt;', zs,zsmain,zshalf,conflx,cn,sat<a name='785'>
         print *,'NROOT, meltfactor, iforest, ivgtyp, i,j ', nroot,meltfactor,iforest,ivgtyp(I,J),I,J<a name='786'>
<font color=#447700>!         print *,'NROOT, iforest, ivgtyp, i,j ', nroot,iforest(ivgtyp(i,j)),ivgtyp(I,J),I,J<a name='787'></font>
    ENDIF<a name='788'>
<a name='789'>
<font color=#447700>!!*** SET ZERO-VALUE FOR SOME OUTPUT DIAGNOSTIC ARRAYS<a name='790'></font>
<font color=#447700>!    if(i.eq.397.and.j.eq.562) then<a name='791'></font>
<font color=#447700>!        print *,'RUC LSM - xland(i,j),xice(i,j),snow(i,j)',i,j,xland(i,j),xice(i,j),snow(i,j)<a name='792'></font>
<font color=#447700>!    endif<a name='793'></font>
<a name='794'>
#if (EM_CORE==1)<a name='795'>
     if(lakemodel==1. .and. lakemask(i,j)==1.) goto 2999<a name='796'>
<font color=#447700>!Lakes<a name='797'></font>
#endif<a name='798'>
<a name='799'>
        IF((XLAND(I,J)-1.5).GE.0.)THEN<a name='800'>
<font color=#447700>!-- Water <a name='801'></font>
           SMAVAIL(I,J)=1.0<a name='802'>
             SMMAX(I,J)=1.0<a name='803'>
             SNOW(I,J)=0.0<a name='804'>
             SNOWH(I,J)=0.0<a name='805'>
             SNOWC(I,J)=0.0<a name='806'>
           LMAVAIL(I,J)=1.0<a name='807'>
<font color=#447700>! accumulated water equivalent of frozen precipitation over water [mm]<a name='808'></font>
<a name='809'>
           ILAND=iswater<a name='810'>
<font color=#447700>!           ILAND=16<a name='811'></font>
           ISOIL=14<a name='812'>
<a name='813'>
           patmb=P8w(i,1,j)*1.e-2<a name='814'>
           qvg  (i,j) = <A href='../../html_code/phys/module_sf_ruclsm.F.html#QSN'>QSN</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSN_2">(SOILT(i,j),TBQ)/PATMB<a name='815'>
           qsfc(i,j) = qvg(i,j)/(1.+qvg(i,j))<a name='816'>
           CHKLOWQ(I,J)=1.<a name='817'>
           Q2SAT=<A href='../../html_code/phys/module_sf_ruclsm.F.html#QSN'>QSN</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSN_3">(TABS,TBQ)/PATMB<a name='818'>
<a name='819'>
            DO K=1,NZS<a name='820'>
              SOILMOIS(I,K,J)=1.0<a name='821'>
              SH2O    (I,K,J)=1.0 <a name='822'>
              TSO(I,K,J)= SOILT(I,J)<a name='823'>
            ENDDO<a name='824'>
<a name='825'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='826'>
              PRINT*,'  water point, I=',I,                      &amp;<a name='827'>
              'J=',J, 'SOILT=', SOILT(i,j)<a name='828'>
    ENDIF<a name='829'>
<a name='830'>
           ELSE<a name='831'>
<a name='832'>
<font color=#447700>! LAND POINT OR SEA ICE<a name='833'></font>
       if(xice(i,j).ge.xice_threshold) then<a name='834'>
<font color=#447700>!       if(IVGTYP(i,j).eq.isice) then<a name='835'></font>
           SEAICE(i,j)=1.<a name='836'>
       else<a name='837'>
           SEAICE(i,j)=0.<a name='838'>
       endif<a name='839'>
<a name='840'>
         IF(SEAICE(I,J).GT.0.5)THEN<a name='841'>
<font color=#447700>!-- Sea-ice case<a name='842'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='843'>
              PRINT*,' sea-ice at water point, I=',I,            &amp;<a name='844'>
              'J=',J<a name='845'>
    ENDIF<a name='846'>
<font color=#447700>!            ILAND = 24<a name='847'></font>
            ILAND = isice<a name='848'>
            ISOIL = 16<a name='849'>
            ZNT(I,J) = 0.011<a name='850'>
            snoalb(i,j) = 0.75<a name='851'>
            dqm = 1.<a name='852'>
            ref = 1.<a name='853'>
            qmin = 0.<a name='854'>
            wilt = 0.<a name='855'>
            emissl(i,j) = 0.98 <a name='856'>
<a name='857'>
           patmb=P8w(i,1,j)*1.e-2<a name='858'>
           qvg  (i,j) = <A href='../../html_code/phys/module_sf_ruclsm.F.html#QSN'>QSN</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSN_4">(SOILT(i,j),TBQ)/PATMB<a name='859'>
           qsg  (i,j) = qvg(i,j)<a name='860'>
           qsfc(i,j) = qvg(i,j)/(1.+qvg(i,j))<a name='861'>
<a name='862'>
            DO K=1,NZS<a name='863'>
               soilmois(i,k,j) = 1.<a name='864'>
               smfr3d(i,k,j)   = 1.<a name='865'>
               sh2o(i,k,j)     = 0.<a name='866'>
               keepfr3dflag(i,k,j) = 0.<a name='867'>
               tso(i,k,j) = min(271.4,tso(i,k,j))<a name='868'>
            ENDDO<a name='869'>
          ENDIF<a name='870'>
<a name='871'>
<font color=#447700>!  Attention!!!!  RUC LSM uses soil moisture content minus residual (minimum<a name='872'></font>
<font color=#447700>!  or dry soil moisture content for a given soil type) as a state variable.<a name='873'></font>
<a name='874'>
           DO k=1,nzs<a name='875'>
<font color=#447700>! soilm1d - soil moisture content minus residual [m**3/m**3]<a name='876'></font>
              soilm1d (k) = min(max(0.,soilmois(i,k,j)-qmin),dqm)<a name='877'>
<font color=#447700>!              soilm1d (k) = min(max(0.,soilmois(i,k,j)),dqm)<a name='878'></font>
              tso1d   (k) = tso(i,k,j)<a name='879'>
              soiliqw (k) = min(max(0.,sh2o(i,k,j)-qmin),soilm1d(k))<a name='880'>
           ENDDO <a name='881'>
<a name='882'>
           do k=1,nzs<a name='883'>
              smfrkeep(k) = smfr3d(i,k,j)<a name='884'>
              keepfr  (k) = keepfr3dflag(i,k,j)<a name='885'>
           enddo<a name='886'>
<a name='887'>
              LMAVAIL(I,J)=max(0.00001,min(1.,soilm1d(1)/(REF-QMIN)))<a name='888'>
<font color=#447700>!              LMAVAIL(I,J)=max(0.00001,min(1.,soilm1d(1)/dqm))<a name='889'></font>
<a name='890'>
#if ( NMM_CORE == 1 )<a name='891'>
     if(ktau+1.gt.1) then<a name='892'>
#else<a name='893'>
     if(ktau.gt.1) then<a name='894'>
#endif<a name='895'>
<a name='896'>
<font color=#447700>! extract dew from the cloud water at the surface<a name='897'></font>
<font color=#447700>!30july13              QCG(I,J)=QCG(I,J)-DEW(I,J)/QKMS<a name='898'></font>
     endif<a name='899'>
<a name='900'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='901'>
   print *,'LAND, i,j,tso1d,soilm1d,PATM,TABS,QVATM,QCATM,RHO',  &amp;<a name='902'>
                  i,j,tso1d,soilm1d,PATM,TABS,QVATM,QCATM,RHO<a name='903'>
   print *,'CONFLX =',CONFLX <a name='904'>
   print *,'SMFRKEEP,KEEPFR   ',SMFRKEEP,KEEPFR<a name='905'>
    ENDIF<a name='906'>
<a name='907'>
        smtotold(i,j)=0.<a name='908'>
      do k=1,nzs-1<a name='909'>
        smtotold(i,j)=smtotold(i,j)+(qmin+soilm1d(k))*             &amp;<a name='910'>
                    (zshalf(k+1)-zshalf(k))<a name='911'>
      enddo<a name='912'>
<a name='913'>
        smtotold(i,j)=smtotold(i,j)+(qmin+soilm1d(nzs))*           &amp;<a name='914'>
                    (zsmain(nzs)-zshalf(nzs))<a name='915'>
<a name='916'>
        canwatold(i,j) = canwatr<a name='917'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='918'>
      print *,'before SFCTMP, spp_lsm, rstoch, field_sf_loc',      &amp;<a name='919'>
      i,j,spp_lsm,(rstoch(i,k,j),k=1,nzs),(field_sf_loc(i,k,j),k=1,nzs)<a name='920'>
    ENDIF<a name='921'>
<font color=#447700>!-----------------------------------------------------------------<a name='922'></font>
         CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SFCTMP'>SFCTMP</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCTMP_1"> (spp_lsm,rstoch(i,:,j),field_sf_loc(i,:,j), &amp; <a name='923'>
                dt,ktau,conflx,i,j,                              &amp;<a name='924'>
<font color=#447700>!--- input variables<a name='925'></font>
                nzs,nddzs,nroot,meltfactor,                      &amp;   <font color=#447700>!added meltfactor<a name='926'></font>
                iland,isoil,xland(i,j),ivgtyp(i,j),isltyp(i,j),  &amp;<a name='927'>
                PRCPMS, NEWSNMS,SNWE,SNHEI,SNOWFRAC,             &amp;<a name='928'>
                RHOSN,RHONEWSN,RHOSNFALL,                        &amp;<a name='929'>
                snowrat,grauprat,icerat,curat,                   &amp;<a name='930'>
                PATM,TABS,QVATM,QCATM,RHO,                       &amp;<a name='931'>
                GLW(I,J),GSW(I,J),EMISSL(I,J),                   &amp;<a name='932'>
                QKMS,TKMS,PC(I,J),LMAVAIL(I,J),                  &amp;<a name='933'>
                canwatr,vegfra(I,J),alb(I,J),znt(I,J),           &amp;<a name='934'>
                snoalb(i,j),albbck(i,j),lai(i,j),                &amp;   <font color=#447700>!new<a name='935'></font>
                myj,seaice(i,j),isice,                           &amp;<a name='936'>
<font color=#447700>!--- soil fixed fields<a name='937'></font>
                QWRTZ,                                           &amp;<a name='938'>
                rhocs,dqm,qmin,ref,                              &amp;<a name='939'>
                wilt,psis,bclh,ksat,                             &amp;<a name='940'>
                sat,cn,zsmain,zshalf,DTDZS,DTDZS2,tbq,           &amp;<a name='941'>
<font color=#447700>!--- constants<a name='942'></font>
                cp,rovcp,g0,lv,stbolt,cw,c1sn,c2sn,              &amp;<a name='943'>
                KQWRTZ,KICE,KWT,                                 &amp;<a name='944'>
<font color=#447700>!--- output variables<a name='945'></font>
                snweprint,snheiprint,rsm,                        &amp;<a name='946'>
                soilm1d,tso1d,smfrkeep,keepfr,                   &amp;<a name='947'>
                soilt(I,J),soilt1(i,j),tsnav(i,j),dew(I,J),      &amp;<a name='948'>
                qvg(I,J),qsg(I,J),qcg(I,J),SMELT(I,J),           &amp;<a name='949'>
                SNOH(I,J),SNFLX(I,J),SNOM(I,J),SNOWFALLAC(I,J),  &amp;<a name='950'>
                ACSNOW(I,J),edir(I,J),ec(I,J),ett(I,J),qfx(I,J), &amp;<a name='951'>
                lh(I,J),hfx(I,J),sflx(I,J),sublim(I,J),          &amp;<a name='952'>
                evapl(I,J),prcpl(I,J),budget(i,j),runoff1(i,j),  &amp;<a name='953'>
                runoff2(I,J),soilice,soiliqw,infiltrp,smf(i,j))<a name='954'>
<font color=#447700>!-----------------------------------------------------------------<a name='955'></font>
<a name='956'>
<font color=#447700>! Fraction of cropland category in the grid box should not have soil moisture below <a name='957'></font>
<font color=#447700>! wilting point during the growing season.<a name='958'></font>
<font color=#447700>! Let's keep soil moisture 20% above wilting point for the fraction of grid box under<a name='959'></font>
<font color=#447700>! croplands.<a name='960'></font>
<font color=#447700>! This change violates LSM moisture budget, but<a name='961'></font>
<font color=#447700>! can be considered as a compensation for irrigation not included into LSM. <a name='962'></font>
<a name='963'>
    IF (lufrac(crop) &gt; 0 .and. lai(i,j) &gt; 1.1) THEN<a name='964'>
<font color=#447700>!    IF (ivgtyp(i,j) == crop .and. lai(i,j) &gt; 1.1) THEN<a name='965'></font>
<font color=#447700>! cropland<a name='966'></font>
        do k=1,nroot<a name='967'>
             cropsm=1.1*wilt - qmin<a name='968'>
          if(soilm1d(k) &lt; cropsm*lufrac(crop)) then<a name='969'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='970'>
print * ,'Soil moisture is below wilting in cropland category at time step',ktau  &amp;<a name='971'>
              ,'i,j,lufrac(crop),k,soilm1d(k),wilt,cropsm',                       &amp;<a name='972'>
                i,j,lufrac(crop),k,soilm1d(k),wilt,cropsm<a name='973'>
    ENDIF<a name='974'>
             soilm1d(k) = cropsm*lufrac(crop)<a name='975'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='976'>
      print * ,'Added soil water to cropland category, i,j,k,soilm1d(k)',i,j,k,soilm1d(k)<a name='977'>
    ENDIF<a name='978'>
          endif<a name='979'>
        enddo<a name='980'>
<a name='981'>
    ELSEIF (ivgtyp(i,j) == natural .and. lai(i,j) &gt; 0.7) THEN<a name='982'>
<font color=#447700>! grassland: assume that 40% of grassland is irrigated cropland<a name='983'></font>
        do k=1,nroot<a name='984'>
             cropsm=1.2*wilt - qmin<a name='985'>
          if(soilm1d(k) &lt; cropsm*lufrac(natural)*0.4) then<a name='986'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='987'>
print * ,'Soil moisture is below wilting in mixed grassland/cropland category at time step',ktau &amp;<a name='988'>
              ,'i,j,lufrac(natural),k,soilm1d(k),wilt',                       &amp;<a name='989'>
                i,j,lufrac(natural),k,soilm1d(k),wilt<a name='990'>
    ENDIF<a name='991'>
             soilm1d(k) = cropsm * lufrac(natural)*0.4<a name='992'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='993'>
      print * ,'Added soil water to grassland category, i,j,k,soilm1d(k)',i,j,k,soilm1d(k)<a name='994'>
    ENDIF<a name='995'>
          endif<a name='996'>
        enddo<a name='997'>
    ENDIF<a name='998'>
<a name='999'>
<font color=#447700>! Fill in field_sf to pass perturbed field of hydraulic cond. up to model driver and output<a name='1000'></font>
#if (EM_CORE==1)<a name='1001'>
       if (spp_lsm==1) then<a name='1002'>
         do k=1,nsl<a name='1003'>
           field_sf(i,k,j)=field_sf_loc(i,k,j)<a name='1004'>
         enddo<a name='1005'>
       endif<a name='1006'>
#endif<a name='1007'>
<a name='1008'>
<font color=#447700>!***  DIAGNOSTICS<a name='1009'></font>
<font color=#447700>!--- available and maximum soil moisture content in the soil<a name='1010'></font>
<font color=#447700>!--- domain<a name='1011'></font>
<a name='1012'>
        smavail(i,j) = 0.<a name='1013'>
        smmax (i,j)  = 0.  <a name='1014'>
<a name='1015'>
      do k=1,nzs-1<a name='1016'>
        smavail(i,j)=smavail(i,j)+(qmin+soilm1d(k))*             &amp;<a name='1017'>
                    (zshalf(k+1)-zshalf(k))<a name='1018'>
        smmax (i,j) =smmax (i,j)+(qmin+dqm)*                     &amp;<a name='1019'>
                    (zshalf(k+1)-zshalf(k))<a name='1020'>
      enddo<a name='1021'>
<a name='1022'>
        smavail(i,j)=smavail(i,j)+(qmin+soilm1d(nzs))*           &amp;<a name='1023'>
                    (zsmain(nzs)-zshalf(nzs))<a name='1024'>
        smmax (i,j) =smmax (i,j)+(qmin+dqm)*                     &amp;<a name='1025'>
                    (zsmain(nzs)-zshalf(nzs))<a name='1026'>
<a name='1027'>
<font color=#447700>!--- Convert the water unit into mm<a name='1028'></font>
        SFCRUNOFF(I,J) = SFCRUNOFF(I,J)+RUNOFF1(I,J)*DT*1000.0<a name='1029'>
        UDRUNOFF (I,J) = UDRUNOFF(I,J)+RUNOFF2(I,J)*DT*1000.0<a name='1030'>
        ACRUNOFF(I,J)  = ACRUNOFF(I,J)+RUNOFF1(I,J)*DT*1000.0<a name='1031'>
        SMAVAIL  (I,J) = SMAVAIL(I,J) * 1000.<a name='1032'>
        SMMAX    (I,J) = SMMAX(I,J) * 1000.<a name='1033'>
        smtotold (I,J) = smtotold(I,J) * 1000.<a name='1034'>
<a name='1035'>
        do k=1,nzs<a name='1036'>
<a name='1037'>
<font color=#447700>!             soilmois(i,k,j) = soilm1d(k)<a name='1038'></font>
             soilmois(i,k,j) = soilm1d(k) + qmin<a name='1039'>
             sh2o    (i,k,j) = min(soiliqw(k) + qmin,soilmois(i,k,j))<a name='1040'>
                  tso(i,k,j) = tso1d(k)<a name='1041'>
        enddo<a name='1042'>
<a name='1043'>
        tso(i,nzs,j) = tbot(i,j)<a name='1044'>
<a name='1045'>
        do k=1,nzs<a name='1046'>
             smfr3d(i,k,j) = smfrkeep(k)<a name='1047'>
           keepfr3dflag(i,k,j) = keepfr (k)<a name='1048'>
        enddo<a name='1049'>
<a name='1050'>
<font color=#447700>!tgs add together dew and cloud at the ground surface<a name='1051'></font>
<font color=#447700>!30july13        qcg(i,j)=qcg(i,j)+dew(i,j)/qkms<a name='1052'></font>
<a name='1053'>
        Z0       (I,J) = ZNT (I,J)<a name='1054'>
        SFCEXC   (I,J) = TKMS<a name='1055'>
        patmb=P8w(i,1,j)*1.e-2<a name='1056'>
        Q2SAT=<A href='../../html_code/phys/module_sf_ruclsm.F.html#QSN'>QSN</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSN_5">(TABS,TBQ)/PATMB<a name='1057'>
        QSFC(I,J) = QVG(I,J)/(1.+QVG(I,J))<a name='1058'>
<font color=#447700>! for MYJ surface and PBL scheme<a name='1059'></font>
<font color=#447700>!      if (myj) then<a name='1060'></font>
<font color=#447700>! MYJSFC expects QSFC as actual specific humidity at the surface<a name='1061'></font>
        IF((QVATM.GE.Q2SAT*0.95).AND.QVATM.LT.qvg(I,J))THEN<a name='1062'>
          CHKLOWQ(I,J)=0.<a name='1063'>
        ELSE<a name='1064'>
          CHKLOWQ(I,J)=1.<a name='1065'>
        ENDIF<a name='1066'>
<font color=#447700>!      else<a name='1067'></font>
<font color=#447700>!          CHKLOWQ(I,J)=1.<a name='1068'></font>
<font color=#447700>!      endif<a name='1069'></font>
<a name='1070'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1071'>
      if(CHKLOWQ(I,J).eq.0.) then<a name='1072'>
   print *,'i,j,CHKLOWQ',  &amp;<a name='1073'>
                  i,j,CHKLOWQ(I,J)<a name='1074'>
      endif<a name='1075'>
    ENDIF<a name='1076'>
<a name='1077'>
        if(snow(i,j)==0.) EMISSL(i,j) = LEMITBL(IVGTYP(i,j))<a name='1078'>
        EMISS (I,J) = EMISSL(I,J)<a name='1079'>
<font color=#447700>! SNOW is in [mm], SNWE is in [m]; CANWAT is in mm, CANWATR is in m<a name='1080'></font>
        SNOW   (i,j) = SNWE*1000.<a name='1081'>
        SNOWH  (I,J) = SNHEI <a name='1082'>
        CANWAT (I,J) = CANWATR*1000.<a name='1083'>
<a name='1084'>
        INFILTR(I,J) = INFILTRP<a name='1085'>
<a name='1086'>
        MAVAIL (i,j) = LMAVAIL(I,J)  <a name='1087'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1088'>
       print *,' LAND, I=,J=, QFX, HFX after SFCTMP', i,j,lh(i,j),hfx(i,j)<a name='1089'>
    ENDIF<a name='1090'>
<font color=#447700>!!!        QFX    (I,J) = LH(I,J)/LV<a name='1091'></font>
        SFCEVP (I,J) = SFCEVP (I,J) + QFX (I,J) * DT<a name='1092'>
        GRDFLX (I,J) = -1. * sflx(I,J)<a name='1093'>
<a name='1094'>
<font color=#447700>!       if(smf(i,j) .ne.0.) then<a name='1095'></font>
<font color=#447700>!tgs - SMF.NE.0. when there is phase change in the top soil layer<a name='1096'></font>
<font color=#447700>! The heat of soil water freezing/thawing is not computed explicitly<a name='1097'></font>
<font color=#447700>! and is responsible for the residual in the energy budget.<a name='1098'></font>
<font color=#447700>!  print *,'Budget',budget(i,j),i,j,smf(i,j)<a name='1099'></font>
<font color=#447700>!       endif<a name='1100'></font>
<a name='1101'>
<font color=#447700>!--- SNOWC snow cover flag<a name='1102'></font>
       if(snowfrac &gt; 0. .and. xice(i,j).ge.xice_threshold ) then<a name='1103'>
           SNOWFRAC = SNOWFRAC*XICE(I,J)<a name='1104'>
       endif<a name='1105'>
<a name='1106'>
       SNOWC(I,J)=SNOWFRAC<a name='1107'>
<a name='1108'>
<font color=#447700>!--- RHOSNF - density of snowfall<a name='1109'></font>
       RHOSNF(I,J)=RHOSNFALL<a name='1110'>
<a name='1111'>
<font color=#447700>! Accumulated moisture flux [kg/m^2]<a name='1112'></font>
       SFCEVP (I,J) = SFCEVP (I,J) + QFX (I,J) * DT<a name='1113'>
<a name='1114'>
<font color=#447700>!TEST!!!! for test put heat budget term in GRDFLX<a name='1115'></font>
<a name='1116'>
<font color=#447700>!       acbudget(i,j)=acbudget(i,j)+budget(i,j)-smf(i,j)<a name='1117'></font>
<font color=#447700>!       GRDFLX (I,J) = acbudget(i,j)<a name='1118'></font>
<a name='1119'>
<font color=#447700>!       if(smf(i,j) .ne.0.) then<a name='1120'></font>
<font color=#447700>!tgs - SMF.NE.0. when there is phase change in the top soil layer<a name='1121'></font>
<font color=#447700>! The heat of freezing/thawing of soil water is not computed explicitly<a name='1122'></font>
<font color=#447700>! and is responsible for the residual in the energy budget.<a name='1123'></font>
<font color=#447700>!       endif<a name='1124'></font>
<font color=#447700>!        budget(i,j)=budget(i,j)-smf(i,j)<a name='1125'></font>
<a name='1126'>
       ac=0.<a name='1127'>
       as=0.<a name='1128'>
<a name='1129'>
       ac=max(0.,canwat(i,j)-canwatold(i,j))<a name='1130'>
       as=max(0.,snwe-snowold(i,j))<a name='1131'>
       wb =rainbl(i,j)+smelt(i,j)*dt*1.e3 &amp; <font color=#447700>! source<a name='1132'></font>
                      -qfx(i,j)*dt &amp;<a name='1133'>
                      -runoff1(i,j)*dt*1.e3-runoff2(i,j)*dt*1.e3 &amp;<a name='1134'>
                      -ac-as - (smavail(i,j)-smtotold(i,j))<a name='1135'>
<a name='1136'>
       waterbudget(i,j)=rainbl(i,j)+smelt(i,j)*dt*1.e3 &amp; <font color=#447700>! source<a name='1137'></font>
                      -qfx(i,j)*dt &amp;<a name='1138'>
                      -runoff1(i,j)*dt*1.e3-runoff2(i,j)*dt*1.e3 &amp;<a name='1139'>
                      -ac-as - (smavail(i,j)-smtotold(i,j))<a name='1140'>
<a name='1141'>
<a name='1142'>
<font color=#447700>!       waterbudget(i,j)=rainbl(i,j)-qfx(i,j)*dt-(smavail(i,j)-smtotold(i,j)) &amp;<a name='1143'></font>
       acwaterbudget(i,j)=acwaterbudget(i,j)+waterbudget(i,j)<a name='1144'>
<a name='1145'>
<font color=#447700>!!!!TEST use  LH to check water budget<a name='1146'></font>
<font color=#447700>!          GRDFLX (I,J) = waterbudget(i,j) <a name='1147'></font>
<a name='1148'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1149'>
  print *,'Smf=',smf(i,j),i,j<a name='1150'>
  print *,'Budget',budget(i,j),i,j<a name='1151'>
  print *,'RUNOFF2= ', i,j,runoff2(i,j)<a name='1152'>
  print *,'Water budget ', i,j,waterbudget(i,j)<a name='1153'>
  print *,'rainbl,qfx*dt,runoff1,smelt*dt*1.e3,smchange', &amp;<a name='1154'>
          i,j,rainbl(i,j),qfx(i,j)*dt,runoff1(i,j)*dt*1.e3, &amp;<a name='1155'>
          smelt(i,j)*dt*1.e3, &amp;<a name='1156'>
          (smavail(i,j)-smtotold(i,j))<a name='1157'>
<a name='1158'>
  print *,'SNOW,SNOWold',i,j,snwe,snowold(i,j)<a name='1159'>
  print *,'SNOW-SNOWold',i,j,max(0.,snwe-snowold(i,j))<a name='1160'>
  print *,'CANWATold, canwat ',i,j,canwatold(i,j),canwat(i,j)<a name='1161'>
  print *,'canwat(i,j)-canwatold(i,j)',max(0.,canwat(i,j)-canwatold(i,j))<a name='1162'>
    ENDIF<a name='1163'>
<a name='1164'>
<a name='1165'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1166'>
   print *,'LAND, i,j,tso1d,soilm1d,soilt - end of time step',         &amp;<a name='1167'>
                  i,j,tso1d,soilm1d,soilt(i,j)<a name='1168'>
   print *,'LAND, QFX, HFX after SFCTMP', i,j,lh(i,j),hfx(i,j)<a name='1169'>
    ENDIF<a name='1170'>
<a name='1171'>
<font color=#447700>!--- end of a land or sea ice point<a name='1172'></font>
        ENDIF<a name='1173'>
2999  continue <font color=#447700>! lakes<a name='1174'></font>
      ENDDO<a name='1175'>
<a name='1176'>
   ENDDO<a name='1177'>
<a name='1178'>
<font color=#447700>!-----------------------------------------------------------------<a name='1179'></font>
   END SUBROUTINE LSMRUC<a name='1180'>
<font color=#447700>!-----------------------------------------------------------------<a name='1181'></font>
<a name='1182'>
<a name='1183'>
<a name='1184'>
<A NAME='SFCTMP'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SFCTMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1185'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFCTMP</font> (spp_lsm,rstochcol,fieldcol_sf,             &amp; <A href='../../call_to/SFCTMP.html' TARGET='index'>1</A>,<A href='../../call_from/SFCTMP.html' TARGET='index'>6</A><a name='1186'>
                delt,ktau,conflx,i,j,                            &amp;<a name='1187'>
<font color=#447700>!--- input variables<a name='1188'></font>
                nzs,nddzs,nroot,meltfactor,                      &amp;<a name='1189'>
                ILAND,ISOIL,XLAND,IVGTYP,ISLTYP,PRCPMS,          &amp;<a name='1190'>
                NEWSNMS,SNWE,SNHEI,SNOWFRAC,                     &amp;<a name='1191'>
                RHOSN,RHONEWSN,RHOSNFALL,                        &amp;<a name='1192'>
                snowrat,grauprat,icerat,curat,                   &amp;<a name='1193'>
                PATM,TABS,QVATM,QCATM,rho,                       &amp;<a name='1194'>
                GLW,GSW,EMISS,QKMS,TKMS,PC,                      &amp;<a name='1195'>
                MAVAIL,CST,VEGFRA,ALB,ZNT,                       &amp;<a name='1196'>
                ALB_SNOW,ALB_SNOW_FREE,lai,                      &amp;<a name='1197'>
                MYJ,SEAICE,ISICE,                                &amp;<a name='1198'>
<font color=#447700>!--- soil fixed fields<a name='1199'></font>
                QWRTZ,rhocs,dqm,qmin,ref,wilt,psis,bclh,ksat,    &amp;<a name='1200'>
                sat,cn,zsmain,zshalf,DTDZS,DTDZS2,tbq,           &amp;<a name='1201'>
<font color=#447700>!--- constants<a name='1202'></font>
                cp,rovcp,g0,lv,stbolt,cw,c1sn,c2sn,              &amp;<a name='1203'>
                KQWRTZ,KICE,KWT,                                 &amp;<a name='1204'>
<font color=#447700>!--- output variables<a name='1205'></font>
                snweprint,snheiprint,rsm,                        &amp;<a name='1206'>
                soilm1d,ts1d,smfrkeep,keepfr,soilt,soilt1,       &amp;<a name='1207'>
                tsnav,dew,qvg,qsg,qcg,                           &amp;<a name='1208'>
                SMELT,SNOH,SNFLX,SNOM,SNOWFALLAC,ACSNOW,         &amp;<a name='1209'>
                edir1,ec1,ett1,eeta,qfx,hfx,s,sublim,            &amp;<a name='1210'>
                evapl,prcpl,fltot,runoff1,runoff2,soilice,       &amp;<a name='1211'>
                soiliqw,infiltr,smf)<a name='1212'>
<font color=#447700>!-----------------------------------------------------------------<a name='1213'></font>
       IMPLICIT NONE<a name='1214'>
<font color=#447700>!-----------------------------------------------------------------<a name='1215'></font>
<a name='1216'>
<font color=#447700>!--- input variables<a name='1217'></font>
<a name='1218'>
   INTEGER,  INTENT(IN   )   ::  isice,i,j,nroot,ktau,nzs ,      &amp;<a name='1219'>
                                 nddzs                             <font color=#447700>!nddzs=2*(nzs-2)<a name='1220'></font>
<a name='1221'>
   REAL,     INTENT(IN   )   ::  DELT,CONFLX,meltfactor<a name='1222'>
   REAL,     INTENT(IN   )   ::  C1SN,C2SN<a name='1223'>
   LOGICAL,    INTENT(IN   )    ::     myj<a name='1224'>
<font color=#447700>!--- 3-D Atmospheric variables<a name='1225'></font>
   REAL                                                        , &amp;<a name='1226'>
            INTENT(IN   )    ::                            PATM, &amp;<a name='1227'>
                                                           TABS, &amp;<a name='1228'>
                                                          QVATM, &amp;<a name='1229'>
                                                          QCATM<a name='1230'>
   REAL                                                        , &amp;<a name='1231'>
            INTENT(IN   )    ::                             GLW, &amp;<a name='1232'>
                                                            GSW, &amp;<a name='1233'>
                                                             PC, &amp;<a name='1234'>
                                                         VEGFRA, &amp;<a name='1235'>
                                                  ALB_SNOW_FREE, &amp;<a name='1236'>
                                                            lai, &amp;<a name='1237'>
                                                         SEAICE, &amp;<a name='1238'>
                                                          XLAND, &amp;<a name='1239'>
                                                            RHO, &amp;<a name='1240'>
                                                           QKMS, &amp;<a name='1241'>
                                                           TKMS<a name='1242'>
                                                             <a name='1243'>
   INTEGER,   INTENT(IN   )  ::                          IVGTYP, ISLTYP<a name='1244'>
<font color=#447700>!--- 2-D variables<a name='1245'></font>
   REAL                                                        , &amp;<a name='1246'>
            INTENT(INOUT)    ::                           EMISS, &amp;<a name='1247'>
                                                         MAVAIL, &amp;<a name='1248'>
                                                       SNOWFRAC, &amp;<a name='1249'>
                                                       ALB_SNOW, &amp;<a name='1250'>
                                                            ALB, &amp;<a name='1251'>
                                                            CST<a name='1252'>
<a name='1253'>
<font color=#447700>!--- soil properties<a name='1254'></font>
   REAL                      ::                                  &amp;<a name='1255'>
                                                          RHOCS, &amp;<a name='1256'>
                                                           BCLH, &amp;<a name='1257'>
                                                            DQM, &amp;<a name='1258'>
                                                           KSAT, &amp;<a name='1259'>
                                                           PSIS, &amp;<a name='1260'>
                                                           QMIN, &amp;<a name='1261'>
                                                          QWRTZ, &amp;<a name='1262'>
                                                            REF, &amp;<a name='1263'>
                                                            SAT, &amp;<a name='1264'>
                                                           WILT<a name='1265'>
<a name='1266'>
   REAL,     INTENT(IN   )   ::                              CN, &amp;<a name='1267'>
                                                             CW, &amp;<a name='1268'>
                                                             CP, &amp;<a name='1269'>
                                                          ROVCP, &amp;<a name='1270'>
                                                             G0, &amp;<a name='1271'>
                                                             LV, &amp;<a name='1272'>
                                                         STBOLT, &amp;<a name='1273'>
                                                         KQWRTZ, &amp;<a name='1274'>
                                                           KICE, &amp;<a name='1275'>
                                                            KWT<a name='1276'>
<a name='1277'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::            ZSMAIN, &amp;<a name='1278'>
                                                         ZSHALF, &amp;<a name='1279'>
                                                         DTDZS2 <a name='1280'>
<a name='1281'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::          rstochcol<a name='1282'>
   REAL,     DIMENSION(1:NZS), INTENT(INOUT) ::     fieldcol_sf<a name='1283'>
<a name='1284'>
<a name='1285'>
   REAL,     DIMENSION(1:NDDZS), INTENT(IN)  ::           DTDZS<a name='1286'>
<a name='1287'>
   REAL,     DIMENSION(1:5001), INTENT(IN)  ::              TBQ<a name='1288'>
<a name='1289'>
<a name='1290'>
<font color=#447700>!--- input/output variables<a name='1291'></font>
<font color=#447700>!-------- 3-d soil moisture and temperature<a name='1292'></font>
   REAL,     DIMENSION( 1:nzs )                                , &amp;<a name='1293'>
             INTENT(INOUT)   ::                            TS1D, &amp; <a name='1294'>
                                                        SOILM1D, &amp;<a name='1295'>
                                                       SMFRKEEP<a name='1296'>
   REAL,  DIMENSION( 1:nzs )                                   , &amp;<a name='1297'>
             INTENT(INOUT)   ::                          KEEPFR<a name='1298'>
<a name='1299'>
   REAL,  DIMENSION(1:NZS), INTENT(INOUT)  ::          SOILICE, &amp;<a name='1300'>
                                                       SOILIQW<a name='1301'>
          <a name='1302'>
<a name='1303'>
   INTEGER, INTENT(INOUT)    ::                     ILAND,ISOIL<a name='1304'>
   INTEGER                   ::                     ILANDs<a name='1305'>
<a name='1306'>
<font color=#447700>!-------- 2-d variables<a name='1307'></font>
   REAL                                                        , &amp;<a name='1308'>
             INTENT(INOUT)   ::                             DEW, &amp;<a name='1309'>
                                                          EDIR1, &amp;<a name='1310'>
                                                            EC1, &amp;<a name='1311'>
                                                           ETT1, &amp;<a name='1312'>
                                                           EETA, &amp;<a name='1313'>
                                                          EVAPL, &amp;<a name='1314'>
                                                        INFILTR, &amp;<a name='1315'>
                                                          RHOSN, &amp; <a name='1316'>
                                                       RHONEWSN, &amp;<a name='1317'>
                                                      rhosnfall, &amp;<a name='1318'>
                                                        snowrat, &amp;<a name='1319'>
                                                       grauprat, &amp;<a name='1320'>
                                                         icerat, &amp;<a name='1321'>
                                                          curat, &amp;<a name='1322'>
                                                         SUBLIM, &amp;<a name='1323'>
                                                          PRCPL, &amp;<a name='1324'>
                                                            QVG, &amp;<a name='1325'>
                                                            QSG, &amp;<a name='1326'>
                                                            QCG, &amp;<a name='1327'>
                                                            QFX, &amp;<a name='1328'>
                                                            HFX, &amp;<a name='1329'>
                                                          fltot, &amp;<a name='1330'>
                                                            smf, &amp;<a name='1331'>
                                                              S, &amp;  <a name='1332'>
                                                        RUNOFF1, &amp;<a name='1333'>
                                                        RUNOFF2, &amp;<a name='1334'>
                                                         ACSNOW, &amp;<a name='1335'>
                                                     SNOWFALLAC, &amp;<a name='1336'>
                                                           SNWE, &amp;<a name='1337'>
                                                          SNHEI, &amp;<a name='1338'>
                                                          SMELT, &amp;<a name='1339'>
                                                           SNOM, &amp;<a name='1340'>
                                                           SNOH, &amp;<a name='1341'>
                                                          SNFLX, &amp;<a name='1342'>
                                                          SOILT, &amp;<a name='1343'>
                                                         SOILT1, &amp;<a name='1344'>
                                                          TSNAV, &amp;<a name='1345'>
                                                            ZNT<a name='1346'>
<a name='1347'>
   REAL,     DIMENSION(1:NZS)              ::                    &amp;<a name='1348'>
                                                           tice, &amp;<a name='1349'>
                                                        rhosice, &amp;<a name='1350'>
                                                         capice, &amp;<a name='1351'>
                                                       thdifice, &amp;<a name='1352'>
                                                          TS1DS, &amp;<a name='1353'>
                                                       SOILM1DS, &amp;<a name='1354'>
                                                      SMFRKEEPS, &amp;<a name='1355'>
                                                       SOILIQWS, &amp; <a name='1356'>
                                                       SOILICES, &amp;<a name='1357'>
                                                        KEEPFRS<a name='1358'>
<font color=#447700>!-------- 1-d variables<a name='1359'></font>
   REAL :: &amp;<a name='1360'>
                                                            DEWS, &amp;<a name='1361'>
                                                        MAVAILS,  &amp;<a name='1362'>
                                                          EDIR1s, &amp;<a name='1363'>
                                                            EC1s, &amp;<a name='1364'>
                                                            csts, &amp;<a name='1365'>
                                                           ETT1s, &amp;<a name='1366'>
                                                           EETAs, &amp;<a name='1367'>
                                                          EVAPLs, &amp;<a name='1368'>
                                                        INFILTRs, &amp;<a name='1369'>
                                                          PRCPLS, &amp;<a name='1370'>
                                                            QVGS, &amp;<a name='1371'>
                                                            QSGS, &amp;<a name='1372'>
                                                            QCGS, &amp;<a name='1373'>
                                                            QFXS, &amp;<a name='1374'>
                                                            HFXS, &amp;<a name='1375'>
                                                          fltots, &amp;<a name='1376'>
                                                        RUNOFF1S, &amp;<a name='1377'>
                                                        RUNOFF2s, &amp;<a name='1378'>
                                                              SS, &amp;<a name='1379'>
                                                          SOILTs<a name='1380'>
<a name='1381'>
            <a name='1382'>
                     <a name='1383'>
<a name='1384'>
   REAL,  INTENT(INOUT)                     ::              RSM, &amp;  <a name='1385'>
                                                      SNWEPRINT, &amp;<a name='1386'>
                                                     SNHEIPRINT<a name='1387'>
   INTEGER,   INTENT(IN)                    ::     spp_lsm     <a name='1388'>
<font color=#447700>!--- Local variables<a name='1389'></font>
<a name='1390'>
   INTEGER ::  K,ILNB<a name='1391'>
<a name='1392'>
   REAL    ::  BSN, XSN                                        , &amp;<a name='1393'>
               RAINF, SNTH, NEWSN, PRCPMS, NEWSNMS             , &amp;<a name='1394'>
               T3, UPFLUX, XINET<a name='1395'>
   REAL    ::  snhei_crit, snhei_crit_newsn, keep_snow_albedo, SNOWFRACnewsn<a name='1396'>
   REAL    ::  newsnowratio, dd1<a name='1397'>
<a name='1398'>
   REAL    ::  rhonewgr,rhonewice<a name='1399'>
<a name='1400'>
   REAL    ::  RNET,GSWNEW,GSWIN,EMISSN,ZNTSN,EMISS_snowfree<a name='1401'>
   REAL    ::  VEGFRAC, snow_mosaic, snfr, vgfr<a name='1402'>
   real    ::  cice, albice, albsn, drip, dripsn, dripliq<a name='1403'>
   real    ::  interw, intersn, infwater, intwratio<a name='1404'>
<a name='1405'>
<font color=#447700>!-----------------------------------------------------------------<a name='1406'></font>
        integer,   parameter      ::      ilsnow=99 <a name='1407'>
        <a name='1408'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1409'>
        print *,' in SFCTMP',i,j,nzs,nddzs,nroot,                 &amp;<a name='1410'>
                 SNWE,RHOSN,SNOM,SMELT,TS1D<a name='1411'>
    ENDIF<a name='1412'>
<a name='1413'>
        snow_mosaic=0.<a name='1414'>
        snfr = 1.<a name='1415'>
        NEWSN=0.<a name='1416'>
        newsnowratio = 0.<a name='1417'>
        snowfracnewsn=0.<a name='1418'>
        if(snhei == 0.) snowfrac=0.<a name='1419'>
        smelt = 0.<a name='1420'>
        RAINF = 0.<a name='1421'>
        RSM=0.<a name='1422'>
        DD1=0.<a name='1423'>
        INFILTR=0.<a name='1424'>
<font color=#447700>! Jul 2016 -  Avissar and Pielke (1989)<a name='1425'></font>
<font color=#447700>! This formulation depending on LAI defines relative contribution of the vegetation to<a name='1426'></font>
<font color=#447700>! the total heat fluxes between surface and atmosphere.<a name='1427'></font>
<font color=#447700>! With VEGFRA=100% and LAI=3, VEGFRAC=0.86 meaning that vegetation contributes<a name='1428'></font>
<font color=#447700>! only 86% of the total surface fluxes.<a name='1429'></font>
<font color=#447700>!        VGFR=0.01*VEGFRA ! % --&gt; fraction<a name='1430'></font>
<font color=#447700>!        VEGFRAC=2.*lai*vgfr/(1.+2.*lai*vgfr)<a name='1431'></font>
        VEGFRAC=0.01*VEGFRA<a name='1432'>
        drip = 0.<a name='1433'>
        dripsn = 0.<a name='1434'>
        dripliq = 0.<a name='1435'>
        smf = 0.<a name='1436'>
        interw=0.<a name='1437'>
        intersn=0.<a name='1438'>
        infwater=0.<a name='1439'>
<a name='1440'>
<font color=#447700>!---initialize local arrays for sea ice<a name='1441'></font>
          do k=1,nzs<a name='1442'>
            tice(k) = 0.<a name='1443'>
            rhosice(k) = 0. <a name='1444'>
            cice = 0.<a name='1445'>
            capice(k) = 0.<a name='1446'>
            thdifice(k) = 0.<a name='1447'>
          enddo<a name='1448'>
<a name='1449'>
        GSWnew=GSW<a name='1450'>
        GSWin=GSW/(1.-alb)<a name='1451'>
        ALBice=ALB_SNOW_FREE<a name='1452'>
        ALBsn=alb_snow<a name='1453'>
        EMISSN = 0.98<a name='1454'>
        EMISS_snowfree = LEMITBL(IVGTYP)<a name='1455'>
<a name='1456'>
<font color=#447700>!--- sea ice properties<a name='1457'></font>
<font color=#447700>!--- N.N Zubov "Arctic Ice"<a name='1458'></font>
<font color=#447700>!--- no salinity dependence because we consider the ice pack<a name='1459'></font>
<font color=#447700>!--- to be old and to have low salinity (0.0002)<a name='1460'></font>
       if(SEAICE.ge.0.5) then<a name='1461'>
          do k=1,nzs<a name='1462'>
            tice(k) = ts1d(k) - 273.15<a name='1463'>
            rhosice(k) = 917.6/(1-0.000165*tice(k))<a name='1464'>
            cice = 2115.85 +7.7948*tice(k)<a name='1465'>
            capice(k) = cice*rhosice(k)<a name='1466'>
            thdifice(k) = 2.260872/capice(k)<a name='1467'>
           enddo<a name='1468'>
<font color=#447700>!-- SEA ICE ALB dependence on ice temperature. When ice temperature is<a name='1469'></font>
<font color=#447700>!-- below critical value of -10C - no change to albedo.<a name='1470'></font>
<font color=#447700>!-- If temperature is higher that -10C then albedo is decreasing.<a name='1471'></font>
<font color=#447700>!-- The minimum albedo at t=0C for ice is 0.1 less.<a name='1472'></font>
       ALBice = MIN(ALB_SNOW_FREE,MAX(ALB_SNOW_FREE - 0.05,   &amp;<a name='1473'>
               ALB_SNOW_FREE - 0.1*(tice(1)+10.)/10. ))<a name='1474'>
       endif<a name='1475'>
<a name='1476'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1477'>
<font color=#447700>!        print *,'I,J,KTAU,QKMS,TKMS', i,j,ktau,qkms,tkms<a name='1478'></font>
        print *,'alb_snow_free',ALB_SNOW_FREE<a name='1479'>
        print *,'GSW,GSWnew,GLW,SOILT,EMISS,ALB,ALBice,SNWE',&amp;<a name='1480'>
                 GSW,GSWnew,GLW,SOILT,EMISS,ALB,ALBice,SNWE<a name='1481'>
    ENDIF<a name='1482'>
<a name='1483'>
	if(snhei.gt.0.0081*1.e3/rhosn) then<a name='1484'>
<font color=#447700>!*** Update snow density for current temperature (Koren et al. 1999)<a name='1485'></font>
        BSN=delt/3600.*c1sn*exp(0.08*min(0.,tsnav)-c2sn*rhosn*1.e-3)<a name='1486'>
       if(bsn*snwe*100..lt.1.e-4) goto 777<a name='1487'>
        XSN=rhosn*(exp(bsn*snwe*100.)-1.)/(bsn*snwe*100.)<a name='1488'>
        rhosn=MIN(MAX(76.9,XSN),500.)<a name='1489'>
<font color=#447700>!        rhosn=MIN(MAX(62.5,XSN),890.)<a name='1490'></font>
<font color=#447700>!        rhosn=MIN(MAX(100.,XSN),400.)<a name='1491'></font>
<font color=#447700>!        rhosn=MIN(MAX(50.,XSN),400.)<a name='1492'></font>
 777   continue<a name='1493'>
<a name='1494'>
<font color=#447700>!      else<a name='1495'></font>
<font color=#447700>!        rhosn     =200.<a name='1496'></font>
<font color=#447700>!        rhonewsn  =200.<a name='1497'></font>
      endif<a name='1498'>
<a name='1499'>
           newsn=newsnms*delt<a name='1500'>
<font color=#447700>!---- ACSNOW - run-total snowfall water [mm]<a name='1501'></font>
<a name='1502'>
       IF(NEWSN.GT.0.) THEN<a name='1503'>
<font color=#447700>!       IF(NEWSN.GE.1.E-8) THEN<a name='1504'></font>
<a name='1505'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1506'>
      print *, 'THERE IS NEW SNOW, newsn', newsn<a name='1507'>
    ENDIF<a name='1508'>
<a name='1509'>
        newsnowratio = min(1.,newsn/(snwe+newsn))<a name='1510'>
<a name='1511'>
<font color=#447700>!*** Calculate fresh snow density (t &gt; -15C, else MIN value)<a name='1512'></font>
<font color=#447700>!*** Eq. 10 from Koren et al. (1999)<a name='1513'></font>
<font color=#447700>!--- old formulation from Koren (1999)<a name='1514'></font>
<font color=#447700>!        if(tabs.lt.258.15) then<a name='1515'></font>
<font color=#447700>!          rhonewsn=50.<a name='1516'></font>
<font color=#447700>!          rhonewsn=100.<a name='1517'></font>
<font color=#447700>!          rhonewsn=62.5<a name='1518'></font>
<a name='1519'>
<font color=#447700>!        else<a name='1520'></font>
<font color=#447700>!          rhonewsn=MIN(rhonewsn,400.)<a name='1521'></font>
<font color=#447700>!        endif<a name='1522'></font>
<font color=#447700>!--- end of old formulation<a name='1523'></font>
<a name='1524'>
<font color=#447700>!--- 27 Feb 2014 - empirical formulations from John M. Brown<a name='1525'></font>
        rhonewsn=min(250.,rhowater/max(4.179,(13.*tanh((274.15-Tabs)*0.3333))))<a name='1526'>
        rhonewgr=min(500.,rhowater/max(2.,(3.5*tanh((274.15-Tabs)*0.3333))))<a name='1527'>
        rhonewice=rhonewsn<a name='1528'>
<a name='1529'>
<font color=#447700>!--- compute density of "snowfall" from weighted contribution<a name='1530'></font>
<font color=#447700>!                 of snow, graupel and ice fractions<a name='1531'></font>
<a name='1532'>
         rhosnfall = min(500.,max(76.9,(rhonewsn*snowrat +  &amp;<a name='1533'>
                     rhonewgr*grauprat + rhonewice*icerat + rhonewgr*curat)))<a name='1534'>
<a name='1535'>
<font color=#447700>! from now on rhonewsn is the density of falling frozen precipitation<a name='1536'></font>
         rhonewsn=rhosnfall<a name='1537'>
<a name='1538'>
<font color=#447700>!*** Define average snow density of the snow pack considering<a name='1539'></font>
<font color=#447700>!*** the amount of fresh snow (eq. 9 in Koren et al.(1999) <a name='1540'></font>
<font color=#447700>!*** without snow melt )<a name='1541'></font>
         xsn=(rhosn*snwe+rhonewsn*newsn)/                         &amp;<a name='1542'>
             (snwe+newsn)<a name='1543'>
         rhosn=MIN(MAX(76.9,XSN),500.)<a name='1544'>
<font color=#447700>!         rhosn=MIN(MAX(100.,XSN),500.)<a name='1545'></font>
<font color=#447700>!         rhosn=MIN(MAX(50.,XSN),400.)<a name='1546'></font>
<a name='1547'>
<font color=#447700>!Update snow on the ground<a name='1548'></font>
<font color=#447700>!         snwe=snwe+newsn<a name='1549'></font>
<font color=#447700>!         newsnowratio = min(1.,newsn/snwe)<a name='1550'></font>
<font color=#447700>!         snhei=snwe*rhowater/rhosn<a name='1551'></font>
<font color=#447700>!         NEWSN=NEWSN*rhowater/rhonewsn<a name='1552'></font>
       ENDIF <font color=#447700>! end NEWSN &gt; 0.<a name='1553'></font>
<a name='1554'>
       IF(PRCPMS.NE.0.) THEN<a name='1555'>
<a name='1556'>
<font color=#447700>! PRCPMS is liquid precipitation rate<a name='1557'></font>
<font color=#447700>! RAINF is a flag used for calculation of rain water<a name='1558'></font>
<font color=#447700>! heat content contribution into heat budget equation. Rain's temperature<a name='1559'></font>
<font color=#447700>! is set equal to air temperature at the first atmospheric<a name='1560'></font>
<font color=#447700>! level.  <a name='1561'></font>
<a name='1562'>
           RAINF=1.<a name='1563'>
       ENDIF<a name='1564'>
<a name='1565'>
        drip = 0.<a name='1566'>
        intwratio=0.<a name='1567'>
     if(vegfrac &gt; 0.01) then<a name='1568'>
<font color=#447700>! compute intercepted precipitation - Eq. 1 Lawrence et al.,<a name='1569'></font>
<font color=#447700>! J. of Hydrometeorology, 2006, CLM.<a name='1570'></font>
         interw=0.25*DELT*PRCPMS*(1.-exp(-0.5*lai))*vegfrac<a name='1571'>
         intersn=0.25*NEWSN*(1.-exp(-0.5*lai))*vegfrac<a name='1572'>
<font color=#447700>!original - next 2 lines<a name='1573'></font>
<font color=#447700>!         interw=DELT*PRCPMS*vegfrac<a name='1574'></font>
<font color=#447700>!         intersn=NEWSN*vegfrac<a name='1575'></font>
         infwater=PRCPMS - interw/delt<a name='1576'>
    if((interw+intersn) &gt; 0.) then<a name='1577'>
       intwratio=interw/(interw+intersn)<a name='1578'>
    endif<a name='1579'>
<a name='1580'>
<font color=#447700>! Update water/snow intercepted by the canopy<a name='1581'></font>
         dd1=CST + interw + intersn<a name='1582'>
         CST=DD1<a name='1583'>
<font color=#447700>!  if(i==666.and.j==282)  print *,'666,282 - cst,sat,interw,intersn',cst,sat,interw,intersn<a name='1584'></font>
        IF(CST.GT.SAT) THEN<a name='1585'>
          CST=SAT<a name='1586'>
          DRIP=DD1-SAT<a name='1587'>
        ENDIF<a name='1588'>
     else<a name='1589'>
         CST=0.<a name='1590'>
         DRIP=0.<a name='1591'>
         interw=0.<a name='1592'>
         intersn=0.<a name='1593'>
         infwater=PRCPMS<a name='1594'>
     endif <font color=#447700>! vegfrac &gt; 0.01<a name='1595'></font>
<a name='1596'>
<font color=#447700>! SNHEI_CRIT is a threshold for fractional snow<a name='1597'></font>
         SNHEI_CRIT=0.01601*1.e3/rhosn<a name='1598'>
         SNHEI_CRIT_newsn=0.0005*1.e3/rhosn<a name='1599'>
<font color=#447700>! snowfrac from the previous time step<a name='1600'></font>
         SNOWFRAC=MIN(1.,SNHEI/(2.*SNHEI_CRIT))<a name='1601'>
        if(snowfrac &lt; 0.75) snow_mosaic = 1.<a name='1602'>
<a name='1603'>
       IF(NEWSN.GT.0.) THEN<a name='1604'>
<font color=#447700>!Update snow on the ground<a name='1605'></font>
         snwe=max(0.,snwe+newsn-intersn)<a name='1606'>
<font color=#447700>!      if(drip &gt; 0.) then<a name='1607'></font>
<font color=#447700>!       if (snow_mosaic==1.) then<a name='1608'></font>
<font color=#447700>!         dripsn = drip*snowfrac<a name='1609'></font>
<font color=#447700>!         dripnosn=drip*(1.-snowfrac)<a name='1610'></font>
<font color=#447700>!         snwe=snwe+dripsn<a name='1611'></font>
<font color=#447700>!       else<a name='1612'></font>
<font color=#447700>!         snwe=snwe+drip<a name='1613'></font>
<font color=#447700>!       endif<a name='1614'></font>
<font color=#447700>!      endif<a name='1615'></font>
<font color=#447700>! Add drip to snow on the ground<a name='1616'></font>
      if(drip &gt; 0.) then<a name='1617'>
       if (snow_mosaic==1.) then<a name='1618'>
         dripliq=drip*intwratio<a name='1619'>
         dripsn = drip - dripliq<a name='1620'>
         snwe=snwe+dripsn<a name='1621'>
         infwater=infwater+dripliq<a name='1622'>
         dripliq=0.<a name='1623'>
         dripsn = 0.<a name='1624'>
       else<a name='1625'>
         snwe=snwe+drip<a name='1626'>
       endif<a name='1627'>
      endif<a name='1628'>
         snhei=snwe*rhowater/rhosn<a name='1629'>
         NEWSN=NEWSN*rhowater/rhonewsn<a name='1630'>
       ENDIF<a name='1631'>
<a name='1632'>
   IF(SNHEI.GT.0.0) THEN<a name='1633'>
<font color=#447700>!-- SNOW on the ground<a name='1634'></font>
<font color=#447700>!--- Land-use category should be changed to snow/ice for grid points with snow&gt;0<a name='1635'></font>
         ILAND=ISICE<a name='1636'>
<font color=#447700>!24nov15 - based on field exp on Pleasant View soccer fields<a name='1637'></font>
<font color=#447700>!    if(meltfactor &gt; 1.5) then ! all veg. types, except forests<a name='1638'></font>
<font color=#447700>!         SNHEI_CRIT=0.01601*1.e3/rhosn<a name='1639'></font>
<font color=#447700>! Petzold - 1 cm of fresh snow overwrites effects from old snow.<a name='1640'></font>
<font color=#447700>! Need to test SNHEI_CRIT_newsn=0.01<a name='1641'></font>
<font color=#447700>!         SNHEI_CRIT_newsn=0.01<a name='1642'></font>
<font color=#447700>!    else  ! forests<a name='1643'></font>
<font color=#447700>!         SNHEI_CRIT=0.02*1.e3/rhosn<a name='1644'></font>
<font color=#447700>!         SNHEI_CRIT_newsn=0.001*1.e3/rhosn<a name='1645'></font>
<font color=#447700>!    endif<a name='1646'></font>
<a name='1647'>
         SNOWFRAC=MIN(1.,SNHEI/(2.*SNHEI_CRIT))<a name='1648'>
<font color=#447700>!24nov15 - SNOWFRAC for urban category &lt; 0.75 <a name='1649'></font>
      if(ivgtyp == urban) snowfrac=min(0.75,snowfrac)<a name='1650'>
<font color=#447700>!      if(meltfactor &gt; 1.5) then<a name='1651'></font>
<font color=#447700>!         if(isltyp &gt; 9 .and. isltyp &lt; 13) then<a name='1652'></font>
<font color=#447700>!24nov15 clay soil types - SNOFRAC &lt; 0.9<a name='1653'></font>
<font color=#447700>!           snowfrac=min(0.9,snowfrac)<a name='1654'></font>
<font color=#447700>!         endif<a name='1655'></font>
<font color=#447700>!      else<a name='1656'></font>
<font color=#447700>!24nov15 - SNOWFRAC for forests &lt; 0.75 <a name='1657'></font>
<font color=#447700>!         snowfrac=min(0.85,snowfrac)<a name='1658'></font>
<font color=#447700>!      endif<a name='1659'></font>
<a name='1660'>
<font color=#447700>!         SNOWFRAC=MIN(1.,SNHEI/(2.*SNHEI_CRIT))<a name='1661'></font>
<font color=#447700>!       elseif(snowfrac &lt; 0.3 .and. tabs &gt; 275.) then<a name='1662'></font>
<a name='1663'>
       if(snowfrac &lt; 0.75) snow_mosaic = 1.<a name='1664'>
<a name='1665'>
       if(newsn &gt; 0. ) SNOWFRACnewsn=MIN(1.,SNHEI/SNHEI_CRIT_newsn)<a name='1666'>
<a name='1667'>
         KEEP_SNOW_ALBEDO = 0.<a name='1668'>
      IF (NEWSN &gt; 0. .and. snowfracnewsn &gt; 0.99) THEN<a name='1669'>
<font color=#447700>! new snow<a name='1670'></font>
             KEEP_SNOW_ALBEDO = 1.<a name='1671'>
             snow_mosaic=0.  <font color=#447700>! ???<a name='1672'></font>
      ENDIF<a name='1673'>
<a name='1674'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1675'>
      print *,'SNHEI_CRIT,SNOWFRAC,SNHEI_CRIT_newsn,SNOWFRACnewsn', &amp;<a name='1676'>
               SNHEI_CRIT,SNOWFRAC,SNHEI_CRIT_newsn,SNOWFRACnewsn<a name='1677'>
    ENDIF<a name='1678'>
<a name='1679'>
<font color=#447700>!-- Set znt for snow from VEGPARM table (snow/ice landuse), except for<a name='1680'></font>
<font color=#447700>!-- land-use types with higher roughness (forests, urban).<a name='1681'></font>
<font color=#447700>!5mar12      IF(znt.lt.0.2 .and. snowfrac.gt.0.99) znt=z0tbl(iland)<a name='1682'></font>
<font color=#447700>!      IF(newsn==0. .and. znt.lt.0.2 .and. snowfrac.gt.0.99) znt=z0tbl(iland)<a name='1683'></font>
      IF(newsn.eq.0. .and. znt.le.0.2 .and. IVGTYP.ne.isice) then<a name='1684'>
         if( snhei .le. 2.*ZNT)then<a name='1685'>
           znt=0.55*znt+0.45*z0tbl(iland)<a name='1686'>
         elseif( snhei .gt. 2.*ZNT .and. snhei .le. 4.*ZNT)then<a name='1687'>
           znt=0.2*znt+0.8*z0tbl(iland)<a name='1688'>
         elseif(snhei &gt; 4.*ZNT) then<a name='1689'>
           znt=z0tbl(iland)<a name='1690'>
         endif<a name='1691'>
       ENDIF<a name='1692'>
<a name='1693'>
<a name='1694'>
<font color=#447700>!---  GSWNEW in-coming solar for snow on land or on ice<a name='1695'></font>
<font color=#447700>!         GSWNEW=GSWnew/(1.-ALB)<a name='1696'></font>
<font color=#447700>!-- Time to update snow and ice albedo<a name='1697'></font>
<a name='1698'>
    IF(SEAICE .LT. 0.5) THEN<a name='1699'>
<font color=#447700>!----- SNOW on soil<a name='1700'></font>
<font color=#447700>!-- ALB dependence on snow depth<a name='1701'></font>
<font color=#447700>! ALB_SNOW across Canada's forested areas is very low - 0.27-0.35, this<a name='1702'></font>
<font color=#447700>! causes significant warm biases. Limiting ALB in these areas to be higher than 0.4<a name='1703'></font>
<font color=#447700>! hwlps with these biases.. <a name='1704'></font>
     if( snow_mosaic == 1.) then<a name='1705'>
         ALBsn=alb_snow<a name='1706'>
<font color=#447700>!        ALBsn=max(0.4,alb_snow)<a name='1707'></font>
         Emiss= emissn<a name='1708'>
     else<a name='1709'>
         ALBsn   = MAX(keep_snow_albedo*alb_snow,               &amp;<a name='1710'>
                   MIN((alb_snow_free +                         &amp;<a name='1711'>
           (alb_snow - alb_snow_free) * snowfrac), alb_snow))<a name='1712'>
<a name='1713'>
         Emiss   = MAX(keep_snow_albedo*emissn,                 &amp;<a name='1714'>
                   MIN((emiss_snowfree +                         &amp;<a name='1715'>
           (emissn - emiss_snowfree) * snowfrac), emissn))<a name='1716'>
     endif<a name='1717'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1718'>
<font color=#447700>!     if(i.eq.279.and.j.eq.263) then<a name='1719'></font>
  print *,'Snow on soil ALBsn,emiss,snow_mosaic',i,j,ALBsn,emiss,snow_mosaic<a name='1720'>
    ENDIF<a name='1721'>
<font color=#447700>!28mar11  if canopy is covered with snow to 95% of its capacity and snow depth is<a name='1722'></font>
<font color=#447700>! higher than patchy snow treshold - then snow albedo is not less than 0.55<a name='1723'></font>
<font color=#447700>! (inspired by the flight from Fairbanks to Seatle)<a name='1724'></font>
<a name='1725'>
<font color=#447700>!test      if(cst.ge.0.95*sat .and. snowfrac .gt.0.99)then<a name='1726'></font>
<font color=#447700>!        albsn=max(alb_snow,0.55)<a name='1727'></font>
<font color=#447700>!      endif<a name='1728'></font>
<a name='1729'>
<font color=#447700>!-- ALB dependence on snow temperature. When snow temperature is<a name='1730'></font>
<font color=#447700>!-- below critical value of -10C - no change to albedo.<a name='1731'></font>
<font color=#447700>!-- If temperature is higher that -10C then albedo is decreasing.<a name='1732'></font>
<font color=#447700>!-- The minimum albedo at t=0C for snow on land is 15% less than<a name='1733'></font>
<font color=#447700>!-- albedo of temperatures below -10C.<a name='1734'></font>
     if(albsn.lt.0.4 .or. keep_snow_albedo==1) then<a name='1735'>
        ALB=ALBsn<a name='1736'>
<font color=#447700>!        ALB=max(0.4,alb_snow)<a name='1737'></font>
      else<a name='1738'>
<font color=#447700>!-- change albedo when no fresh snow and snow albedo is higher than 0.5<a name='1739'></font>
        ALB = MIN(ALBSN,MAX(ALBSN - 0.1*(soilt - 263.15)/       &amp;<a name='1740'>
                (273.15-263.15)*ALBSN, ALBSN - 0.05))<a name='1741'>
      endif<a name='1742'>
    ELSE<a name='1743'>
<font color=#447700>!----- SNOW on ice<a name='1744'></font>
     if( snow_mosaic == 1.) then<a name='1745'>
         ALBsn=alb_snow<a name='1746'>
         Emiss= emissn<a name='1747'>
     else<a name='1748'>
         ALBsn   = MAX(keep_snow_albedo*alb_snow,               &amp;<a name='1749'>
                   MIN((albice + (alb_snow - albice) * snowfrac), alb_snow))<a name='1750'>
         Emiss   = MAX(keep_snow_albedo*emissn,                 &amp;<a name='1751'>
                   MIN((emiss_snowfree +                        &amp;<a name='1752'>
           (emissn - emiss_snowfree) * snowfrac), emissn))<a name='1753'>
     endif<a name='1754'>
<a name='1755'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1756'>
  print *,'Snow on ice snow_mosaic,ALBsn,emiss',i,j,ALBsn,emiss,snow_mosaic<a name='1757'>
    ENDIF<a name='1758'>
<font color=#447700>!-- ALB dependence on snow temperature. When snow temperature is<a name='1759'></font>
<font color=#447700>!-- below critical value of -10C - no change to albedo.<a name='1760'></font>
<font color=#447700>!-- If temperature is higher that -10C then albedo is decreasing.<a name='1761'></font>
      if(albsn.lt.alb_snow .or. keep_snow_albedo .eq.1.)then<a name='1762'>
       ALB=ALBsn<a name='1763'>
      else<a name='1764'>
<font color=#447700>!-- change albedo when no fresh snow<a name='1765'></font>
       ALB = MIN(ALBSN,MAX(ALBSN - 0.15*ALBSN*(soilt - 263.15)/  &amp;<a name='1766'>
                (273.15-263.15), ALBSN - 0.1))<a name='1767'>
      endif<a name='1768'>
<a name='1769'>
    ENDIF<a name='1770'>
<a name='1771'>
    if (snow_mosaic==1.) then <a name='1772'>
<font color=#447700>!may 2014 - treat separately snow-free and snow-covered areas<a name='1773'></font>
<a name='1774'>
       if(SEAICE .LT. 0.5) then<a name='1775'>
<font color=#447700>!  LAND<a name='1776'></font>
<font color=#447700>! portion not covered with snow<a name='1777'></font>
<font color=#447700>! compute absorbed GSW for snow-free portion<a name='1778'></font>
<a name='1779'>
         gswnew=GSWin*(1.-alb_snow_free)<a name='1780'>
<font color=#447700>!--------------<a name='1781'></font>
         T3      = STBOLT*SOILT*SOILT*SOILT<a name='1782'>
         UPFLUX  = T3 *SOILT<a name='1783'>
         XINET   = EMISS_snowfree*(GLW-UPFLUX)<a name='1784'>
         RNET    = GSWnew + XINET<a name='1785'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1786'>
<font color=#447700>!     if(i.eq.442.and.j.eq.260) then<a name='1787'></font>
     print *,'Fractional snow - snowfrac=',snowfrac<a name='1788'>
     print *,'Snowfrac&lt;1 GSWin,GSWnew -',GSWin,GSWnew,'SOILT, RNET',soilt,rnet<a name='1789'>
    ENDIF<a name='1790'>
           do k=1,nzs<a name='1791'>
          soilm1ds(k) = soilm1d(k)<a name='1792'>
          ts1ds(k) = ts1d(k)<a name='1793'>
          smfrkeeps(k) = smfrkeep(k)<a name='1794'>
          keepfrs(k) = keepfr(k)<a name='1795'>
          soilices(k) = soilice(k)<a name='1796'>
          soiliqws(k) = soiliqw(k)<a name='1797'>
            enddo<a name='1798'>
          soilts = soilt<a name='1799'>
          qvgs = qvg<a name='1800'>
          qsgs = qsg<a name='1801'>
          qcgs = qcg<a name='1802'>
          csts = cst<a name='1803'>
          mavails = mavail<a name='1804'>
          smelt=0.<a name='1805'>
          runoff1s=0.<a name='1806'>
          runoff2s=0.<a name='1807'>
       <a name='1808'>
          ilands = ivgtyp<a name='1809'>
<a name='1810'>
         CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOIL'>SOIL</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SFCTMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOIL_1">(spp_lsm,rstochcol,fieldcol_sf,               &amp;<a name='1811'>
<font color=#447700>!--- input variables<a name='1812'></font>
            i,j,ilands,isoil,delt,ktau,conflx,nzs,nddzs,nroot,   &amp;<a name='1813'>
            PRCPMS,RAINF,PATM,QVATM,QCATM,GLW,GSWnew,gswin,     &amp;<a name='1814'>
            EMISS_snowfree,RNET,QKMS,TKMS,PC,csts,dripliq,      &amp;<a name='1815'>
            infwater,rho,vegfrac,lai,myj,                       &amp;<a name='1816'>
<font color=#447700>!--- soil fixed fields <a name='1817'></font>
            QWRTZ,rhocs,dqm,qmin,ref,wilt,                      &amp;<a name='1818'>
            psis,bclh,ksat,sat,cn,                              &amp;<a name='1819'>
            zsmain,zshalf,DTDZS,DTDZS2,tbq,                     &amp;<a name='1820'>
<font color=#447700>!--- constants<a name='1821'></font>
            lv,CP,rovcp,G0,cw,stbolt,tabs,                      &amp;<a name='1822'>
            KQWRTZ,KICE,KWT,                                    &amp;<a name='1823'>
<font color=#447700>!--- output variables for snow-free portion<a name='1824'></font>
            soilm1ds,ts1ds,smfrkeeps,keepfrs,                   &amp;<a name='1825'>
            dews,soilts,qvgs,qsgs,qcgs,edir1s,ec1s,             &amp;<a name='1826'>
            ett1s,eetas,qfxs,hfxs,ss,evapls,prcpls,fltots,runoff1s, &amp;<a name='1827'>
            runoff2s,mavails,soilices,soiliqws,                 &amp;<a name='1828'>
            infiltrs,smf)<a name='1829'>
        else<a name='1830'>
<font color=#447700>! SEA ICE<a name='1831'></font>
<font color=#447700>! portion not covered with snow<a name='1832'></font>
<font color=#447700>! compute absorbed GSW for snow-free portion<a name='1833'></font>
<a name='1834'>
         gswnew=GSWin*(1.-albice)<a name='1835'>
<font color=#447700>!--------------<a name='1836'></font>
         T3      = STBOLT*SOILT*SOILT*SOILT<a name='1837'>
         UPFLUX  = T3 *SOILT<a name='1838'>
         XINET   = EMISS_snowfree*(GLW-UPFLUX)<a name='1839'>
         RNET    = GSWnew + XINET<a name='1840'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1841'>
<font color=#447700>!     if(i.eq.442.and.j.eq.260) then<a name='1842'></font>
     print *,'Fractional snow - snowfrac=',snowfrac<a name='1843'>
     print *,'Snowfrac&lt;1 GSWin,GSWnew -',GSWin,GSWnew,'SOILT, RNET',soilt,rnet<a name='1844'>
    ENDIF<a name='1845'>
            do k=1,nzs<a name='1846'>
          ts1ds(k) = ts1d(k)<a name='1847'>
            enddo<a name='1848'>
          soilts = soilt<a name='1849'>
          qvgs = qvg<a name='1850'>
          qsgs = qsg<a name='1851'>
          qcgs = qcg<a name='1852'>
          smelt=0.<a name='1853'>
          runoff1s=0.<a name='1854'>
          runoff2s=0.<a name='1855'>
 <a name='1856'>
          CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SICE'>SICE</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SFCTMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SICE_1">(                                            &amp;<a name='1857'>
<font color=#447700>!--- input variables<a name='1858'></font>
            i,j,iland,isoil,delt,ktau,conflx,nzs,nddzs,nroot,   &amp;<a name='1859'>
            PRCPMS,RAINF,PATM,QVATM,QCATM,GLW,GSWnew,           &amp;<a name='1860'>
            0.98,RNET,QKMS,TKMS,rho,myj,                        &amp;<a name='1861'>
<font color=#447700>!--- sea ice parameters<a name='1862'></font>
            tice,rhosice,capice,thdifice,                       &amp;<a name='1863'>
            zsmain,zshalf,DTDZS,DTDZS2,tbq,                     &amp;<a name='1864'>
<font color=#447700>!--- constants<a name='1865'></font>
            lv,CP,rovcp,cw,stbolt,tabs,                         &amp;<a name='1866'>
<font color=#447700>!--- output variable<a name='1867'></font>
            ts1ds,dews,soilts,qvgs,qsgs,qcgs,                   &amp;<a name='1868'>
            eetas,qfxs,hfxs,ss,evapls,prcpls,fltots             &amp;<a name='1869'>
                                                                )<a name='1870'>
           edir1 = eeta*1.e-3<a name='1871'>
           ec1 = 0.<a name='1872'>
           ett1 = 0.<a name='1873'>
           runoff1 = prcpms<a name='1874'>
           runoff2 = 0.<a name='1875'>
           mavail = 1.<a name='1876'>
           infiltr=0.<a name='1877'>
           cst=0.<a name='1878'>
            do k=1,nzs<a name='1879'>
               soilm1d(k)=1.<a name='1880'>
               soiliqw(k)=0.<a name='1881'>
               soilice(k)=1.<a name='1882'>
               smfrkeep(k)=1.<a name='1883'>
               keepfr(k)=0.<a name='1884'>
            enddo<a name='1885'>
        endif <font color=#447700>! seaice &lt; 0.5<a name='1886'></font>
<a name='1887'>
<font color=#447700>!return gswnew to incoming solar<a name='1888'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1889'>
<font color=#447700>!    if(i.eq.442.and.j.eq.260) then<a name='1890'></font>
     print *,'gswnew,alb_snow_free,alb',gswnew,alb_snow_free,alb<a name='1891'>
    ENDIF<a name='1892'>
<font color=#447700>!         gswnew=gswnew/(1.-alb_snow_free)<a name='1893'></font>
<a name='1894'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1895'>
<font color=#447700>!   if(i.eq.442.and.j.eq.260) then<a name='1896'></font>
       print *,'Incoming GSWnew snowfrac&lt;1 -',gswnew<a name='1897'>
    ENDIF<a name='1898'>
    endif <font color=#447700>! snow_mosaic=1.<a name='1899'></font>
                           <a name='1900'>
<font color=#447700>!--- recompute absorbed solar radiation and net radiation<a name='1901'></font>
<font color=#447700>!--- for updated value of snow albedo - ALB<a name='1902'></font>
         gswnew=GSWin*(1.-alb)<a name='1903'>
<font color=#447700>!      print *,'SNOW fraction GSWnew',gswnew,'alb=',alb<a name='1904'></font>
<font color=#447700>!--------------<a name='1905'></font>
         T3      = STBOLT*SOILT*SOILT*SOILT<a name='1906'>
         UPFLUX  = T3 *SOILT<a name='1907'>
         XINET   = EMISS*(GLW-UPFLUX)<a name='1908'>
         RNET    = GSWnew + XINET<a name='1909'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='1910'>
<font color=#447700>!    if(i.eq.442.and.j.eq.260) then<a name='1911'></font>
<font color=#447700>!     if(i.eq.271.and.j.eq.242) then<a name='1912'></font>
        print *,'RNET=',rnet<a name='1913'>
        print *,'SNOW - I,J,newsn,snwe,snhei,GSW,GSWnew,GLW,UPFLUX,ALB',&amp;<a name='1914'>
                 i,j,newsn,snwe,snhei,GSW,GSWnew,GLW,UPFLUX,ALB<a name='1915'>
    ENDIF<a name='1916'>
<a name='1917'>
      if (SEAICE .LT. 0.5) then<a name='1918'>
<font color=#447700>! LAND<a name='1919'></font>
           if(snow_mosaic==1.)then<a name='1920'>
              snfr=1.<a name='1921'>
           else<a name='1922'>
              snfr=snowfrac<a name='1923'>
           endif<a name='1924'>
         CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSOIL'>SNOWSOIL</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SFCTMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWSOIL_1"> (spp_lsm,rstochcol,fieldcol_sf,     &amp; <font color=#447700>!--- input variables<a name='1925'></font>
            i,j,isoil,delt,ktau,conflx,nzs,nddzs,nroot,         &amp;<a name='1926'>
            meltfactor,rhonewsn,SNHEI_CRIT,                     &amp;  <font color=#447700>! new<a name='1927'></font>
            ILAND,PRCPMS,RAINF,NEWSN,snhei,SNWE,snfr,           &amp;<a name='1928'>
            RHOSN,PATM,QVATM,QCATM,                             &amp;<a name='1929'>
            GLW,GSWnew,GSWin,EMISS,RNET,IVGTYP,                 &amp;<a name='1930'>
            QKMS,TKMS,PC,CST,dripsn,infwater,                   &amp;<a name='1931'>
            RHO,VEGFRAC,ALB,ZNT,lai,                            &amp;<a name='1932'>
            MYJ,                                                &amp;<a name='1933'>
<font color=#447700>!--- soil fixed fields<a name='1934'></font>
            QWRTZ,rhocs,dqm,qmin,ref,wilt,psis,bclh,ksat,       &amp;<a name='1935'>
            sat,cn,zsmain,zshalf,DTDZS,DTDZS2,tbq,              &amp; <a name='1936'>
<font color=#447700>!--- constants<a name='1937'></font>
            lv,CP,rovcp,G0,cw,stbolt,tabs,                      &amp;<a name='1938'>
            KQWRTZ,KICE,KWT,                                    &amp;<a name='1939'>
<font color=#447700>!--- output variables<a name='1940'></font>
            ilnb,snweprint,snheiprint,rsm,                      &amp;<a name='1941'>
            soilm1d,ts1d,smfrkeep,keepfr,                       &amp;<a name='1942'>
            dew,soilt,soilt1,tsnav,qvg,qsg,qcg,                 &amp;<a name='1943'>
            SMELT,SNOH,SNFLX,SNOM,edir1,ec1,ett1,eeta,          &amp;<a name='1944'>
            qfx,hfx,s,sublim,prcpl,fltot,runoff1,runoff2,       &amp;<a name='1945'>
            mavail,soilice,soiliqw,infiltr                      )<a name='1946'>
       else<a name='1947'>
<font color=#447700>! SEA ICE<a name='1948'></font>
           if(snow_mosaic==1.)then<a name='1949'>
              snfr=1.<a name='1950'>
           else<a name='1951'>
              snfr=snowfrac<a name='1952'>
           endif<a name='1953'>
<a name='1954'>
         CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSEAICE'>SNOWSEAICE</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SFCTMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWSEAICE_1"> (                                      &amp;<a name='1955'>
            i,j,isoil,delt,ktau,conflx,nzs,nddzs,               &amp;    <a name='1956'>
            meltfactor,rhonewsn,SNHEI_CRIT,                     &amp;  <font color=#447700>! new<a name='1957'></font>
            ILAND,PRCPMS,RAINF,NEWSN,snhei,SNWE,snfr,           &amp;    <a name='1958'>
            RHOSN,PATM,QVATM,QCATM,                             &amp;    <a name='1959'>
            GLW,GSWnew,EMISS,RNET,                              &amp;    <a name='1960'>
            QKMS,TKMS,RHO,myj,                                  &amp;    <a name='1961'>
<font color=#447700>!--- sea ice parameters<a name='1962'></font>
            ALB,ZNT,                                            &amp;<a name='1963'>
            tice,rhosice,capice,thdifice,                       &amp;    <a name='1964'>
            zsmain,zshalf,DTDZS,DTDZS2,tbq,                     &amp;    <a name='1965'>
<font color=#447700>!--- constants<a name='1966'></font>
            lv,CP,rovcp,cw,stbolt,tabs,                         &amp;    <a name='1967'>
<font color=#447700>!--- output variables<a name='1968'></font>
            ilnb,snweprint,snheiprint,rsm,ts1d,                 &amp;    <a name='1969'>
            dew,soilt,soilt1,tsnav,qvg,qsg,qcg,                 &amp;    <a name='1970'>
            SMELT,SNOH,SNFLX,SNOM,eeta,                         &amp;    <a name='1971'>
            qfx,hfx,s,sublim,prcpl,fltot                        &amp;    <a name='1972'>
                                                                )    <a name='1973'>
           edir1 = eeta*1.e-3<a name='1974'>
           ec1 = 0.<a name='1975'>
           ett1 = 0.<a name='1976'>
           runoff1 = smelt<a name='1977'>
           runoff2 = 0.<a name='1978'>
           mavail = 1.<a name='1979'>
           infiltr=0.<a name='1980'>
           cst=0.<a name='1981'>
            do k=1,nzs<a name='1982'>
               soilm1d(k)=1.<a name='1983'>
               soiliqw(k)=0.<a name='1984'>
               soilice(k)=1.<a name='1985'>
               smfrkeep(k)=1.<a name='1986'>
               keepfr(k)=0.<a name='1987'>
            enddo<a name='1988'>
       endif<a name='1989'>
<a name='1990'>
<a name='1991'>
         if(snhei.eq.0.) then<a name='1992'>
<font color=#447700>!--- all snow is melted<a name='1993'></font>
         alb=alb_snow_free<a name='1994'>
         iland=ivgtyp<a name='1995'>
         endif<a name='1996'>
<a name='1997'>
     if (snow_mosaic==1.) then<a name='1998'>
<font color=#447700>! May 2014 - now combine snow covered and snow-free land fluxes, soil temp, moist,<a name='1999'></font>
<font color=#447700>! etc.<a name='2000'></font>
        if(SEAICE .LT. 0.5) then<a name='2001'>
<font color=#447700>! LAND<a name='2002'></font>
   IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2003'>
<font color=#447700>!   if(i.eq.442.and.j.eq.260) then<a name='2004'></font>
      print *,'SOILT snow on land', ktau, i,j,soilt<a name='2005'>
      print *,'SOILT on snow-free land', i,j,soilts<a name='2006'>
      print *,'ts1d,ts1ds',i,j,ts1d,ts1ds<a name='2007'>
      print *,' SNOW flux',i,j, snflx<a name='2008'>
      print *,' Ground flux on snow-covered land',i,j, s<a name='2009'>
      print *,' Ground flux on snow-free land', i,j,ss<a name='2010'>
      print *,' CSTS, CST', i,j,csts,cst<a name='2011'>
   ENDIF<a name='2012'>
            do k=1,nzs<a name='2013'>
          soilm1d(k) = soilm1ds(k)*(1.-snowfrac) + soilm1d(k)*snowfrac<a name='2014'>
          ts1d(k) = ts1ds(k)*(1.-snowfrac) + ts1d(k)*snowfrac<a name='2015'>
          smfrkeep(k) = smfrkeeps(k)*(1.-snowfrac) + smfrkeep(k)*snowfrac<a name='2016'>
       if(snowfrac &gt; 0.5) then<a name='2017'>
          keepfr(k) = keepfr(k)<a name='2018'>
       else<a name='2019'>
          keepfr(k) = keepfrs(k)<a name='2020'>
       endif<a name='2021'>
          soilice(k) = soilices(k)*(1.-snowfrac) + soilice(k)*snowfrac<a name='2022'>
          soiliqw(k) = soiliqws(k)*(1.-snowfrac) + soiliqw(k)*snowfrac<a name='2023'>
            enddo<a name='2024'>
          dew = dews*(1.-snowfrac) + dew*snowfrac<a name='2025'>
          soilt = soilts*(1.-snowfrac) + soilt*snowfrac<a name='2026'>
          qvg = qvgs*(1.-snowfrac) + qvg*snowfrac<a name='2027'>
          qsg = qsgs*(1.-snowfrac) + qsg*snowfrac<a name='2028'>
          qcg = qcgs*(1.-snowfrac) + qcg*snowfrac<a name='2029'>
          edir1 = edir1s*(1.-snowfrac) + edir1*snowfrac<a name='2030'>
          ec1 = ec1s*(1.-snowfrac) + ec1*snowfrac<a name='2031'>
          cst = csts*(1.-snowfrac) + cst*snowfrac<a name='2032'>
          ett1 = ett1s*(1.-snowfrac) + ett1*snowfrac<a name='2033'>
          eeta = eetas*(1.-snowfrac) + eeta*snowfrac<a name='2034'>
          qfx = qfxs*(1.-snowfrac) + qfx*snowfrac<a name='2035'>
          hfx = hfxs*(1.-snowfrac) + hfx*snowfrac<a name='2036'>
          s = ss*(1.-snowfrac) + s*snowfrac<a name='2037'>
          evapl = evapls*(1.-snowfrac)<a name='2038'>
          sublim = sublim*snowfrac<a name='2039'>
          prcpl = prcpls*(1.-snowfrac) + prcpl*snowfrac<a name='2040'>
          fltot = fltots*(1.-snowfrac) + fltot*snowfrac<a name='2041'>
<font color=#447700>!alb<a name='2042'></font>
          ALB   = MAX(keep_snow_albedo*alb,              &amp;<a name='2043'>
                  MIN((alb_snow_free + (alb - alb_snow_free) * snowfrac), alb))<a name='2044'>
<a name='2045'>
          Emiss = MAX(keep_snow_albedo*emissn,           &amp;<a name='2046'>
                  MIN((emiss_snowfree +                  &amp;<a name='2047'>
              (emissn - emiss_snowfree) * snowfrac), emissn))<a name='2048'>
<a name='2049'>
<font color=#447700>!          alb=alb_snow_free*(1.-snowfrac) + alb*snowfrac<a name='2050'></font>
<font color=#447700>!          emiss=emiss_snowfree*(1.-snowfrac) + emissn*snowfrac<a name='2051'></font>
<a name='2052'>
<font color=#447700>!   if(abs(fltot) &gt; 2.) then<a name='2053'></font>
<font color=#447700>!    print *,'i,j,fltot,snowfrac,fltots',fltot,snowfrac,fltots,i,j<a name='2054'></font>
<font color=#447700>!  endif<a name='2055'></font>
          runoff1 = runoff1s*(1.-snowfrac) + runoff1*snowfrac<a name='2056'>
          runoff2 = runoff2s*(1.-snowfrac) + runoff2*snowfrac<a name='2057'>
          smelt = smelt * snowfrac<a name='2058'>
          snoh = snoh * snowfrac<a name='2059'>
          snflx = snflx * snowfrac<a name='2060'>
          snom = snom * snowfrac<a name='2061'>
          mavail = mavails*(1.-snowfrac) + 1.*snowfrac<a name='2062'>
          infiltr = infiltrs*(1.-snowfrac) + infiltr*snowfrac<a name='2063'>
<a name='2064'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2065'>
      print *,' Ground flux combined', i,j, s<a name='2066'>
      print *,'SOILT combined on land', soilt<a name='2067'>
      print *,'TS combined on land', ts1d<a name='2068'>
    ENDIF<a name='2069'>
       else<a name='2070'>
<font color=#447700>! SEA ICE<a name='2071'></font>
<font color=#447700>! Now combine fluxes for snow-free sea ice and snow-covered area<a name='2072'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2073'>
      print *,'SOILT snow on ice', soilt<a name='2074'>
    ENDIF<a name='2075'>
            do k=1,nzs<a name='2076'>
          ts1d(k) = ts1ds(k)*(1.-snowfrac) + ts1d(k)*snowfrac<a name='2077'>
            enddo<a name='2078'>
          dew = dews*(1.-snowfrac) + dew*snowfrac<a name='2079'>
          soilt = soilts*(1.-snowfrac) + soilt*snowfrac<a name='2080'>
          qvg = qvgs*(1.-snowfrac) + qvg*snowfrac<a name='2081'>
          qsg = qsgs*(1.-snowfrac) + qsg*snowfrac<a name='2082'>
          qcg = qcgs*(1.-snowfrac) + qcg*snowfrac<a name='2083'>
          eeta = eetas*(1.-snowfrac) + eeta*snowfrac<a name='2084'>
          qfx = qfxs*(1.-snowfrac) + qfx*snowfrac<a name='2085'>
          hfx = hfxs*(1.-snowfrac) + hfx*snowfrac<a name='2086'>
          s = ss*(1.-snowfrac) + s*snowfrac<a name='2087'>
          sublim = eeta<a name='2088'>
          prcpl = prcpls*(1.-snowfrac) + prcpl*snowfrac<a name='2089'>
          fltot = fltots*(1.-snowfrac) + fltot*snowfrac<a name='2090'>
<font color=#447700>!alb<a name='2091'></font>
          ALB   = MAX(keep_snow_albedo*alb,              &amp;<a name='2092'>
                  MIN((albice + (alb - alb_snow_free) * snowfrac), alb))<a name='2093'>
<a name='2094'>
          Emiss = MAX(keep_snow_albedo*emissn,           &amp;<a name='2095'>
                  MIN((emiss_snowfree +                  &amp;<a name='2096'>
              (emissn - emiss_snowfree) * snowfrac), emissn))<a name='2097'>
<a name='2098'>
<font color=#447700>!          alb=alb_snow_free*(1.-snowfrac) + alb*snowfrac<a name='2099'></font>
<font color=#447700>!          emiss=1.*(1.-snowfrac) + emissn*snowfrac<a name='2100'></font>
          runoff1 = runoff1s*(1.-snowfrac) + runoff1*snowfrac<a name='2101'>
          runoff2 = runoff2s*(1.-snowfrac) + runoff2*snowfrac<a name='2102'>
          smelt = smelt * snowfrac<a name='2103'>
          snoh = snoh * snowfrac<a name='2104'>
          snflx = snflx * snowfrac<a name='2105'>
          snom = snom * snowfrac<a name='2106'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2107'>
      print *,'SOILT combined on ice', soilt<a name='2108'>
    ENDIF<a name='2109'>
       endif      <a name='2110'>
     endif <font color=#447700>! snow_mosaic = 1.<a name='2111'></font>
 <a name='2112'>
<font color=#447700>!  run-total accumulated snow based on snowfall and snowmelt in [m]<a name='2113'></font>
<a name='2114'>
      snowfallac = snowfallac + max(0.,(newsn - rhowater/rhonewsn*smelt*delt*newsnowratio))<a name='2115'>
<a name='2116'>
   ELSE<a name='2117'>
<font color=#447700>!--- no snow<a name='2118'></font>
           snheiprint=0.<a name='2119'>
           snweprint=0.<a name='2120'>
           smelt=0.<a name='2121'>
<a name='2122'>
<font color=#447700>!--------------<a name='2123'></font>
         T3      = STBOLT*SOILT*SOILT*SOILT<a name='2124'>
         UPFLUX  = T3 *SOILT<a name='2125'>
         XINET   = EMISS*(GLW-UPFLUX)<a name='2126'>
         RNET    = GSWnew + XINET<a name='2127'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2128'>
     print *,'NO snow on the ground GSWnew -',GSWnew,'RNET=',rnet<a name='2129'>
    ENDIF<a name='2130'>
<a name='2131'>
       if(SEAICE .LT. 0.5) then<a name='2132'>
<font color=#447700>!  LAND<a name='2133'></font>
         CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOIL'>SOIL</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SFCTMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOIL_2">(spp_lsm,rstochcol,fieldcol_sf,               &amp;<a name='2134'>
<font color=#447700>!--- input variables<a name='2135'></font>
            i,j,iland,isoil,delt,ktau,conflx,nzs,nddzs,nroot,   &amp;<a name='2136'>
            PRCPMS,RAINF,PATM,QVATM,QCATM,GLW,GSWnew,GSWin,     &amp;<a name='2137'>
            EMISS,RNET,QKMS,TKMS,PC,cst,drip,infwater,          &amp;<a name='2138'>
            rho,vegfrac,lai,myj,                                &amp;<a name='2139'>
<font color=#447700>!--- soil fixed fields <a name='2140'></font>
            QWRTZ,rhocs,dqm,qmin,ref,wilt,                      &amp;<a name='2141'>
            psis,bclh,ksat,sat,cn,                              &amp;<a name='2142'>
            zsmain,zshalf,DTDZS,DTDZS2,tbq,                     &amp;<a name='2143'>
<font color=#447700>!--- constants<a name='2144'></font>
            lv,CP,rovcp,G0,cw,stbolt,tabs,                      &amp;<a name='2145'>
            KQWRTZ,KICE,KWT,                                    &amp;<a name='2146'>
<font color=#447700>!--- output variables<a name='2147'></font>
            soilm1d,ts1d,smfrkeep,keepfr,                       &amp;<a name='2148'>
            dew,soilt,qvg,qsg,qcg,edir1,ec1,                    &amp;<a name='2149'>
            ett1,eeta,qfx,hfx,s,evapl,prcpl,fltot,runoff1,      &amp;<a name='2150'>
            runoff2,mavail,soilice,soiliqw,                     &amp;<a name='2151'>
            infiltr,smf)<a name='2152'>
        else<a name='2153'>
<font color=#447700>! SEA ICE<a name='2154'></font>
<font color=#447700>! If current ice albedo is not the same as from the previous time step, then<a name='2155'></font>
<font color=#447700>! update GSW, ALB and RNET for surface energy budget<a name='2156'></font>
         if(ALB.ne.ALBice) GSWnew=GSW/(1.-ALB)*(1.-ALBice)<a name='2157'>
         alb=albice<a name='2158'>
         RNET    = GSWnew + XINET<a name='2159'>
<a name='2160'>
          CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SICE'>SICE</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SFCTMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SICE_2">(                                            &amp;<a name='2161'>
<font color=#447700>!--- input variables<a name='2162'></font>
            i,j,iland,isoil,delt,ktau,conflx,nzs,nddzs,nroot,   &amp;<a name='2163'>
            PRCPMS,RAINF,PATM,QVATM,QCATM,GLW,GSWnew,           &amp;<a name='2164'>
            EMISS,RNET,QKMS,TKMS,rho,myj,                       &amp;<a name='2165'>
<font color=#447700>!--- sea ice parameters<a name='2166'></font>
            tice,rhosice,capice,thdifice,                       &amp;<a name='2167'>
            zsmain,zshalf,DTDZS,DTDZS2,tbq,                     &amp;<a name='2168'>
<font color=#447700>!--- constants<a name='2169'></font>
            lv,CP,rovcp,cw,stbolt,tabs,                         &amp;<a name='2170'>
<font color=#447700>!--- output variables<a name='2171'></font>
            ts1d,dew,soilt,qvg,qsg,qcg,                         &amp;<a name='2172'>
            eeta,qfx,hfx,s,evapl,prcpl,fltot                          &amp;<a name='2173'>
                                                                )<a name='2174'>
           edir1 = eeta<a name='2175'>
           ec1 = 0.<a name='2176'>
           ett1 = 0.<a name='2177'>
           runoff1 = prcpms<a name='2178'>
           runoff2 = 0.<a name='2179'>
           mavail = 1.<a name='2180'>
           infiltr=0.<a name='2181'>
           cst=0.<a name='2182'>
            do k=1,nzs<a name='2183'>
               soilm1d(k)=1.<a name='2184'>
               soiliqw(k)=0.<a name='2185'>
               soilice(k)=1.<a name='2186'>
               smfrkeep(k)=1.<a name='2187'>
               keepfr(k)=0.<a name='2188'>
            enddo<a name='2189'>
        endif<a name='2190'>
<a name='2191'>
        ENDIF<a name='2192'>
<a name='2193'>
<font color=#447700>!      RETURN<a name='2194'></font>
<font color=#447700>!       END<a name='2195'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2196'></font>
   END SUBROUTINE SFCTMP<a name='2197'>
<font color=#447700>!---------------------------------------------------------------<a name='2198'></font>
<a name='2199'>
<a name='2200'>
<A NAME='QSN'><A href='../../html_code/phys/module_sf_ruclsm.F.html#QSN' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2201'>
       <font color=#993300>FUNCTION </font><font color=#cc0000>QSN</font>(TN,T) <A href='../../call_to/QSN.html' TARGET='index'>7</A><a name='2202'>
<font color=#447700>!****************************************************************<a name='2203'></font>
   REAL,     DIMENSION(1:5001),  INTENT(IN   )   ::  T<a name='2204'>
   REAL,     INTENT(IN  )   ::  TN<a name='2205'>
<a name='2206'>
      REAL    QSN, R,R1,R2<a name='2207'>
      INTEGER I<a name='2208'>
<a name='2209'>
       R=(TN-173.15)/.05+1.<a name='2210'>
       I=INT(R)<a name='2211'>
       IF(I.GE.1) goto 10<a name='2212'>
       I=1<a name='2213'>
       R=1.<a name='2214'>
  10   IF(I.LE.5000) GOTO 20<a name='2215'>
       I=5000<a name='2216'>
       R=5001.<a name='2217'>
  20   R1=T(I)<a name='2218'>
       R2=R-I<a name='2219'>
       QSN=(T(I+1)-R1)*R2 + R1<a name='2220'>
<font color=#447700>!       print *,' in QSN, I,R,R1,R2,T(I+1),TN, QSN', I,R,r1,r2,t(i+1),tn,QSN<a name='2221'></font>
<font color=#447700>!       RETURN<a name='2222'></font>
<font color=#447700>!       END<a name='2223'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2224'></font>
  END FUNCTION QSN<a name='2225'>
<font color=#447700>!------------------------------------------------------------------------<a name='2226'></font>
<a name='2227'>
<a name='2228'>
<A NAME='SOIL'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOIL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2229'>
        <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOIL</font> (spp_lsm,rstochcol, fieldcol_sf,     &amp; <A href='../../call_to/SOIL.html' TARGET='index'>2</A>,<A href='../../call_from/SOIL.html' TARGET='index'>4</A><a name='2230'>
<font color=#447700>!--- input variables<a name='2231'></font>
            i,j,iland,isoil,delt,ktau,conflx,nzs,nddzs,nroot,&amp;<a name='2232'>
            PRCPMS,RAINF,PATM,QVATM,QCATM,                   &amp;<a name='2233'>
            GLW,GSW,GSWin,EMISS,RNET,                        &amp;<a name='2234'>
            QKMS,TKMS,PC,cst,drip,infwater,rho,vegfrac,lai,  &amp;<a name='2235'>
            myj,                                             &amp;<a name='2236'>
<font color=#447700>!--- soil fixed fields<a name='2237'></font>
            QWRTZ,rhocs,dqm,qmin,ref,wilt,psis,bclh,ksat,    &amp;<a name='2238'>
            sat,cn,zsmain,zshalf,DTDZS,DTDZS2,tbq,           &amp;<a name='2239'>
<font color=#447700>!--- constants<a name='2240'></font>
            xlv,CP,rovcp,G0_P,cw,stbolt,TABS,                &amp;<a name='2241'>
            KQWRTZ,KICE,KWT,                                 &amp;<a name='2242'>
<font color=#447700>!--- output variables<a name='2243'></font>
            soilmois,tso,smfrkeep,keepfr,                    &amp;<a name='2244'>
            dew,soilt,qvg,qsg,qcg,                           &amp;<a name='2245'>
            edir1,ec1,ett1,eeta,qfx,hfx,s,evapl,             &amp;<a name='2246'>
            prcpl,fltot,runoff1,runoff2,mavail,soilice,      &amp;<a name='2247'>
            soiliqw,infiltrp,smf)<a name='2248'>
<a name='2249'>
<font color=#447700>!*************************************************************<a name='2250'></font>
<font color=#447700>!   Energy and moisture budget for vegetated surfaces <a name='2251'></font>
<font color=#447700>!   without snow, heat diffusion and Richards eqns. in<a name='2252'></font>
<font color=#447700>!   soil<a name='2253'></font>
<font color=#447700>!<a name='2254'></font>
<font color=#447700>!     DELT - time step (s)<a name='2255'></font>
<font color=#447700>!     ktau - numver of time step<a name='2256'></font>
<font color=#447700>!     CONFLX - depth of constant flux layer (m)<a name='2257'></font>
<font color=#447700>!     J,I - the location of grid point<a name='2258'></font>
<font color=#447700>!     IME, JME, KME, NZS - dimensions of the domain<a name='2259'></font>
<font color=#447700>!     NROOT - number of levels within the root zone<a name='2260'></font>
<font color=#447700>!     PRCPMS - precipitation rate in m/s<a name='2261'></font>
<font color=#447700>!     PATM - pressure [bar]<a name='2262'></font>
<font color=#447700>!     QVATM,QCATM - cloud and water vapor mixing ratio (kg/kg)<a name='2263'></font>
<font color=#447700>!                   at the first atm. level<a name='2264'></font>
<font color=#447700>!     GLW, GSW - incoming longwave and absorbed shortwave<a name='2265'></font>
<font color=#447700>!                radiation at the surface (W/m^2)<a name='2266'></font>
<font color=#447700>!     EMISS,RNET - emissivity of the ground surface (0-1) and net<a name='2267'></font>
<font color=#447700>!                  radiation at the surface (W/m^2)<a name='2268'></font>
<font color=#447700>!     QKMS - exchange coefficient for water vapor in the<a name='2269'></font>
<font color=#447700>!              surface layer (m/s)<a name='2270'></font>
<font color=#447700>!     TKMS - exchange coefficient for heat in the surface<a name='2271'></font>
<font color=#447700>!              layer (m/s)<a name='2272'></font>
<font color=#447700>!     PC - plant coefficient (resistance) (0-1)<a name='2273'></font>
<font color=#447700>!     RHO - density of atmosphere near sueface (kg/m^3)<a name='2274'></font>
<font color=#447700>!     VEGFRAC - greeness fraction<a name='2275'></font>
<font color=#447700>!     RHOCS - volumetric heat capacity of dry soil<a name='2276'></font>
<font color=#447700>!     DQM, QMIN - porosity minus residual soil moisture QMIN (m^3/m^3)<a name='2277'></font>
<font color=#447700>!     REF, WILT - field capacity soil moisture and the<a name='2278'></font>
<font color=#447700>!                 wilting point (m^3/m^3)<a name='2279'></font>
<font color=#447700>!     PSIS - matrix potential at saturation (m)<a name='2280'></font>
<font color=#447700>!     BCLH - exponent for Clapp-Hornberger parameterization<a name='2281'></font>
<font color=#447700>!     KSAT - saturated hydraulic conductivity (m/s)<a name='2282'></font>
<font color=#447700>!     SAT - maximum value of water intercepted by canopy (m)<a name='2283'></font>
<font color=#447700>!     CN - exponent for calculation of canopy water<a name='2284'></font>
<font color=#447700>!     ZSMAIN - main levels in soil (m)<a name='2285'></font>
<font color=#447700>!     ZSHALF - middle of the soil layers (m)<a name='2286'></font>
<font color=#447700>!     DTDZS,DTDZS2 - dt/(2.*dzshalf*dzmain) and dt/dzshalf in soil<a name='2287'></font>
<font color=#447700>!     TBQ - table to define saturated mixing ration<a name='2288'></font>
<font color=#447700>!           of water vapor for given temperature and pressure<a name='2289'></font>
<font color=#447700>!     SOILMOIS,TSO - soil moisture (m^3/m^3) and temperature (K)<a name='2290'></font>
<font color=#447700>!     DEW -  dew in kg/m^2s<a name='2291'></font>
<font color=#447700>!     SOILT - skin temperature (K)<a name='2292'></font>
<font color=#447700>!     QSG,QVG,QCG - saturated mixing ratio, mixing ratio of<a name='2293'></font>
<font color=#447700>!                   water vapor and cloud at the ground<a name='2294'></font>
<font color=#447700>!                   surface, respectively (kg/kg)<a name='2295'></font>
<font color=#447700>!     EDIR1, EC1, ETT1, EETA - direct evaporation, evaporation of<a name='2296'></font>
<font color=#447700>!            canopy water, transpiration in kg m-2 s-1 and total<a name='2297'></font>
<font color=#447700>!            evaporation in m s-1.<a name='2298'></font>
<font color=#447700>!     QFX, HFX - latent and sensible heat fluxes (W/m^2)<a name='2299'></font>
<font color=#447700>!     S - soil heat flux in the top layer (W/m^2)<a name='2300'></font>
<font color=#447700>!     RUNOFF - surface runoff (m/s)<a name='2301'></font>
<font color=#447700>!     RUNOFF2 - underground runoff (m)<a name='2302'></font>
<font color=#447700>!     MAVAIL - moisture availability in the top soil layer (0-1)<a name='2303'></font>
<font color=#447700>!     INFILTRP - infiltration flux from the top of soil domain (m/s)<a name='2304'></font>
<font color=#447700>!<a name='2305'></font>
<font color=#447700>!*****************************************************************<a name='2306'></font>
        IMPLICIT NONE<a name='2307'>
<font color=#447700>!-----------------------------------------------------------------<a name='2308'></font>
<a name='2309'>
<font color=#447700>!--- input variables<a name='2310'></font>
<a name='2311'>
   INTEGER,  INTENT(IN   )   ::  nroot,ktau,nzs                , &amp;<a name='2312'>
                                 nddzs                    <font color=#447700>!nddzs=2*(nzs-2)<a name='2313'></font>
   INTEGER,  INTENT(IN   )   ::  i,j,iland,isoil<a name='2314'>
   REAL,     INTENT(IN   )   ::  DELT,CONFLX<a name='2315'>
   LOGICAL,  INTENT(IN   )   ::  myj<a name='2316'>
<font color=#447700>!--- 3-D Atmospheric variables<a name='2317'></font>
   REAL,                                                         &amp;<a name='2318'>
            INTENT(IN   )    ::                            PATM, &amp;<a name='2319'>
                                                          QVATM, &amp;<a name='2320'>
                                                          QCATM<a name='2321'>
<font color=#447700>!--- 2-D variables<a name='2322'></font>
   REAL,                                                         &amp;<a name='2323'>
            INTENT(IN   )    ::                             GLW, &amp;<a name='2324'>
                                                            GSW, &amp;<a name='2325'>
                                                          GSWin, &amp;<a name='2326'>
                                                          EMISS, &amp;<a name='2327'>
                                                            RHO, &amp;<a name='2328'>
                                                             PC, &amp;<a name='2329'>
                                                        VEGFRAC, &amp;<a name='2330'>
                                                            lai, &amp;<a name='2331'>
                                                       infwater, &amp;<a name='2332'>
                                                           QKMS, &amp;<a name='2333'>
                                                           TKMS<a name='2334'>
<a name='2335'>
<font color=#447700>!--- soil properties<a name='2336'></font>
   REAL,                                                         &amp;<a name='2337'>
            INTENT(IN   )    ::                           RHOCS, &amp;<a name='2338'>
                                                           BCLH, &amp;<a name='2339'>
                                                            DQM, &amp;<a name='2340'>
                                                           KSAT, &amp;<a name='2341'>
                                                           PSIS, &amp;<a name='2342'>
                                                           QMIN, &amp;<a name='2343'>
                                                          QWRTZ, &amp;<a name='2344'>
                                                            REF, &amp;<a name='2345'>
                                                           WILT<a name='2346'>
<a name='2347'>
   REAL,     INTENT(IN   )   ::                              CN, &amp;<a name='2348'>
                                                             CW, &amp;<a name='2349'>
                                                         KQWRTZ, &amp;<a name='2350'>
                                                           KICE, &amp;<a name='2351'>
                                                            KWT, &amp;<a name='2352'>
                                                            XLV, &amp;<a name='2353'>
                                                            g0_p<a name='2354'>
<a name='2355'>
<a name='2356'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::            ZSMAIN, &amp;<a name='2357'>
                                                         ZSHALF, &amp;<a name='2358'>
                                                         DTDZS2<a name='2359'>
<a name='2360'>
   REAL,     DIMENSION(1:NDDZS), INTENT(IN)  ::           DTDZS<a name='2361'>
<a name='2362'>
   REAL,     DIMENSION(1:5001), INTENT(IN)  ::              TBQ<a name='2363'>
<a name='2364'>
<a name='2365'>
<font color=#447700>!--- input/output variables<a name='2366'></font>
<font color=#447700>!-------- 3-d soil moisture and temperature<a name='2367'></font>
   REAL,     DIMENSION( 1:nzs )                                , &amp;<a name='2368'>
             INTENT(INOUT)   ::                             TSO, &amp;<a name='2369'>
                                                       SOILMOIS, &amp;<a name='2370'>
                                                       SMFRKEEP<a name='2371'>
<a name='2372'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::          rstochcol<a name='2373'>
   REAL,     DIMENSION(1:NZS), INTENT(INOUT) ::     fieldcol_sf<a name='2374'>
<a name='2375'>
<a name='2376'>
   REAL,     DIMENSION( 1:nzs )                                , &amp;<a name='2377'>
             INTENT(INOUT)   ::                          KEEPFR<a name='2378'>
<a name='2379'>
<font color=#447700>!-------- 2-d variables<a name='2380'></font>
   REAL,                                                         &amp;<a name='2381'>
             INTENT(INOUT)   ::                             DEW, &amp;<a name='2382'>
                                                            CST, &amp;<a name='2383'>
                                                           DRIP, &amp;<a name='2384'>
                                                          EDIR1, &amp;<a name='2385'>
                                                            EC1, &amp;<a name='2386'>
                                                           ETT1, &amp;<a name='2387'>
                                                           EETA, &amp;<a name='2388'>
                                                          EVAPL, &amp;<a name='2389'>
                                                          PRCPL, &amp;<a name='2390'>
                                                         MAVAIL, &amp;<a name='2391'>
                                                            QVG, &amp;<a name='2392'>
                                                            QSG, &amp;<a name='2393'>
                                                            QCG, &amp;<a name='2394'>
                                                           RNET, &amp;<a name='2395'>
                                                            QFX, &amp;<a name='2396'>
                                                            HFX, &amp;<a name='2397'>
                                                              S, &amp;<a name='2398'>
                                                            SAT, &amp;<a name='2399'>
                                                        RUNOFF1, &amp;<a name='2400'>
                                                        RUNOFF2, &amp;<a name='2401'>
                                                          SOILT<a name='2402'>
<a name='2403'>
<font color=#447700>!-------- 1-d variables<a name='2404'></font>
   INTEGER                   , INTENT(IN)  ::      spp_lsm   <a name='2405'>
   REAL,     DIMENSION(1:NZS), INTENT(OUT)  ::          SOILICE, &amp;<a name='2406'>
                                                        SOILIQW<a name='2407'>
<a name='2408'>
<font color=#447700>!--- Local variables<a name='2409'></font>
<a name='2410'>
   REAL    ::  INFILTRP, transum                               , &amp;<a name='2411'>
               RAINF,  PRCPMS                                  , &amp;<a name='2412'>
               TABS, T3, UPFLUX, XINET<a name='2413'>
   REAL    ::  CP,rovcp,G0,LV,STBOLT,xlmelt,dzstop             , &amp;<a name='2414'>
               can,epot,fac,fltot,ft,fq,hft                    , &amp;<a name='2415'>
               q1,ras,rhoice,sph                               , &amp;<a name='2416'>
               trans,zn,ci,cvw,tln,tavln,pi                    , &amp;<a name='2417'>
               DD1,CMC2MS,DRYCAN,WETCAN                        , &amp;<a name='2418'>
               INFMAX,RIW, X<a name='2419'>
   REAL,     DIMENSION(1:NZS)  ::  transp,cap,diffu,hydro      , &amp;<a name='2420'>
                                   thdif,tranf,tav,soilmoism   , &amp;<a name='2421'>
                                   soilicem,soiliqwm,detal     , &amp;<a name='2422'>
                                   fwsat,lwsat,told,smold<a name='2423'>
<a name='2424'>
   REAL                        ::  soiltold,smf<a name='2425'>
   REAL    :: soilres, alfa, fex, fex_fc, fc, psit<a name='2426'>
<a name='2427'>
   INTEGER ::  nzs1,nzs2,k<a name='2428'>
<a name='2429'>
<font color=#447700>!-----------------------------------------------------------------<a name='2430'></font>
<a name='2431'>
<font color=#447700>!-- define constants<a name='2432'></font>
<font color=#447700>!        STBOLT=5.670151E-8<a name='2433'></font>
        RHOICE=900.<a name='2434'>
        CI=RHOICE*2100.<a name='2435'>
        XLMELT=3.35E+5<a name='2436'>
        cvw=cw<a name='2437'>
<a name='2438'>
<font color=#447700>!        SAT=0.0004<a name='2439'></font>
        prcpl=prcpms<a name='2440'>
<a name='2441'>
        smf=0.<a name='2442'>
        soiltold = soilt<a name='2443'>
<a name='2444'>
        wetcan=0.<a name='2445'>
        drycan=1.<a name='2446'>
<a name='2447'>
<font color=#447700>!--- Initializing local arrays<a name='2448'></font>
        DO K=1,NZS<a name='2449'>
          TRANSP   (K)=0.<a name='2450'>
          soilmoism(k)=0.<a name='2451'>
          soilice  (k)=0.<a name='2452'>
          soiliqw  (k)=0.<a name='2453'>
          soilicem (k)=0.<a name='2454'>
          soiliqwm (k)=0.<a name='2455'>
          lwsat    (k)=0.<a name='2456'>
          fwsat    (k)=0.<a name='2457'>
          tav      (k)=0.<a name='2458'>
          cap      (k)=0.<a name='2459'>
          thdif    (k)=0.<a name='2460'>
          diffu    (k)=0.<a name='2461'>
          hydro    (k)=0.   <a name='2462'>
          tranf    (k)=0.<a name='2463'>
          detal    (k)=0.<a name='2464'>
          told     (k)=0.<a name='2465'>
          smold    (k)=0.<a name='2466'>
        ENDDO<a name='2467'>
<a name='2468'>
          NZS1=NZS-1<a name='2469'>
          NZS2=NZS-2<a name='2470'>
        dzstop=1./(zsmain(2)-zsmain(1))<a name='2471'>
        RAS=RHO*1.E-3<a name='2472'>
        RIW=rhoice*1.e-3<a name='2473'>
<a name='2474'>
<font color=#447700>!--- Computation of volumetric content of ice in soil <a name='2475'></font>
<a name='2476'>
         DO K=1,NZS<a name='2477'>
<font color=#447700>!- main levels<a name='2478'></font>
         tln=log(tso(k)/273.15)<a name='2479'>
         if(tln.lt.0.) then<a name='2480'>
           soiliqw(k)=(dqm+qmin)*(XLMELT*                        &amp;<a name='2481'>
         (tso(k)-273.15)/tso(k)/9.81/psis)                       &amp;<a name='2482'>
          **(-1./bclh)-qmin<a name='2483'>
           soiliqw(k)=max(0.,soiliqw(k))<a name='2484'>
           soiliqw(k)=min(soiliqw(k),soilmois(k))<a name='2485'>
           soilice(k)=(soilmois(k)-soiliqw(k))/RIW<a name='2486'>
<a name='2487'>
<font color=#447700>!---- melting and freezing is balanced, soil ice cannot increase<a name='2488'></font>
       if(keepfr(k).eq.1.) then<a name='2489'>
           soilice(k)=min(soilice(k),smfrkeep(k))<a name='2490'>
           soiliqw(k)=max(0.,soilmois(k)-soilice(k)*riw)<a name='2491'>
       endif<a name='2492'>
<a name='2493'>
         else<a name='2494'>
           soilice(k)=0.<a name='2495'>
           soiliqw(k)=soilmois(k)<a name='2496'>
         endif<a name='2497'>
<a name='2498'>
          ENDDO<a name='2499'>
<a name='2500'>
          DO K=1,NZS1<a name='2501'>
<font color=#447700>!- middle of soil layers<a name='2502'></font>
         tav(k)=0.5*(tso(k)+tso(k+1))<a name='2503'>
         soilmoism(k)=0.5*(soilmois(k)+soilmois(k+1))<a name='2504'>
         tavln=log(tav(k)/273.15)<a name='2505'>
<a name='2506'>
         if(tavln.lt.0.) then<a name='2507'>
           soiliqwm(k)=(dqm+qmin)*(XLMELT*                       &amp;<a name='2508'>
         (tav(k)-273.15)/tav(k)/9.81/psis)                       &amp;<a name='2509'>
          **(-1./bclh)-qmin<a name='2510'>
           fwsat(k)=dqm-soiliqwm(k)<a name='2511'>
           lwsat(k)=soiliqwm(k)+qmin<a name='2512'>
           soiliqwm(k)=max(0.,soiliqwm(k))<a name='2513'>
           soiliqwm(k)=min(soiliqwm(k), soilmoism(k))<a name='2514'>
           soilicem(k)=(soilmoism(k)-soiliqwm(k))/riw<a name='2515'>
<font color=#447700>!---- melting and freezing is balanced, soil ice cannot increase<a name='2516'></font>
       if(keepfr(k).eq.1.) then<a name='2517'>
           soilicem(k)=min(soilicem(k),                          &amp;<a name='2518'>
                   0.5*(smfrkeep(k)+smfrkeep(k+1)))<a name='2519'>
           soiliqwm(k)=max(0.,soilmoism(k)-soilicem(k)*riw)<a name='2520'>
           fwsat(k)=dqm-soiliqwm(k)<a name='2521'>
           lwsat(k)=soiliqwm(k)+qmin<a name='2522'>
       endif<a name='2523'>
<a name='2524'>
         else<a name='2525'>
           soilicem(k)=0.<a name='2526'>
           soiliqwm(k)=soilmoism(k)<a name='2527'>
           lwsat(k)=dqm+qmin<a name='2528'>
           fwsat(k)=0.<a name='2529'>
         endif<a name='2530'>
<a name='2531'>
          ENDDO<a name='2532'>
<a name='2533'>
          do k=1,nzs<a name='2534'>
           if(soilice(k).gt.0.) then<a name='2535'>
             smfrkeep(k)=soilice(k)<a name='2536'>
           else<a name='2537'>
             smfrkeep(k)=soilmois(k)/riw<a name='2538'>
           endif<a name='2539'>
          enddo<a name='2540'>
<a name='2541'>
<font color=#447700>!******************************************************************<a name='2542'></font>
<font color=#447700>! SOILPROP computes thermal diffusivity, and diffusional and<a name='2543'></font>
<font color=#447700>!          hydraulic condeuctivities<a name='2544'></font>
<font color=#447700>!******************************************************************<a name='2545'></font>
          CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILPROP'>SOILPROP</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILPROP_2">(spp_lsm,rstochcol,fieldcol_sf,       &amp;<a name='2546'>
<font color=#447700>!--- input variables<a name='2547'></font>
               nzs,fwsat,lwsat,tav,keepfr,                        &amp;<a name='2548'>
               soilmois,soiliqw,soilice,                          &amp;<a name='2549'>
               soilmoism,soiliqwm,soilicem,                       &amp;<a name='2550'>
<font color=#447700>!--- soil fixed fields<a name='2551'></font>
               QWRTZ,rhocs,dqm,qmin,psis,bclh,ksat,               &amp;<a name='2552'>
<font color=#447700>!--- constants<a name='2553'></font>
               riw,xlmelt,CP,G0_P,cvw,ci,                         &amp;<a name='2554'>
               kqwrtz,kice,kwt,                                   &amp;<a name='2555'>
<font color=#447700>!--- output variables<a name='2556'></font>
               thdif,diffu,hydro,cap)<a name='2557'>
<a name='2558'>
<font color=#447700>!********************************************************************<a name='2559'></font>
<font color=#447700>!--- CALCULATION OF CANOPY WATER (Smirnova et al., 1996, EQ.16) AND DEW <a name='2560'></font>
 <a name='2561'>
<font color=#447700>!        DRIP=0.<a name='2562'></font>
<font color=#447700>!        DD1=0.<a name='2563'></font>
<a name='2564'>
        FQ=QKMS<a name='2565'>
<a name='2566'>
        Q1=-QKMS*RAS*(QVATM - QSG)<a name='2567'>
<a name='2568'>
        DEW=0.<a name='2569'>
        IF(QVATM.GE.QSG)THEN<a name='2570'>
          DEW=FQ*(QVATM-QSG)<a name='2571'>
        ENDIF<a name='2572'>
<a name='2573'>
<font color=#447700>!        IF(DEW.NE.0.)THEN<a name='2574'></font>
<font color=#447700>!          DD1=CST+DELT*(PRCPMS +DEW*RAS)<a name='2575'></font>
<font color=#447700>!        ELSE<a name='2576'></font>
<font color=#447700>!          DD1=CST+                                          &amp;<a name='2577'></font>
<font color=#447700>!            DELT*(PRCPMS+RAS*FQ*(QVATM-QSG)                 &amp;<a name='2578'></font>
<font color=#447700>!           *(CST/SAT)**CN)<a name='2579'></font>
<font color=#447700>!        ENDIF<a name='2580'></font>
<a name='2581'>
<font color=#447700>!          DD1=CST+DELT*PRCPMS<a name='2582'></font>
<a name='2583'>
<font color=#447700>!       IF(DD1.LT.0.) DD1=0.<a name='2584'></font>
<font color=#447700>!        if(vegfrac.eq.0.)then<a name='2585'></font>
<font color=#447700>!          cst=0.<a name='2586'></font>
<font color=#447700>!          drip=0.<a name='2587'></font>
<font color=#447700>!        endif<a name='2588'></font>
<font color=#447700>!        IF (vegfrac.GT.0.) THEN<a name='2589'></font>
<font color=#447700>!          CST=DD1<a name='2590'></font>
<font color=#447700>!        IF(CST.GT.SAT) THEN<a name='2591'></font>
<font color=#447700>!          CST=SAT<a name='2592'></font>
<font color=#447700>!          DRIP=DD1-SAT<a name='2593'></font>
<font color=#447700>!        ENDIF<a name='2594'></font>
<font color=#447700>!        ENDIF<a name='2595'></font>
<font color=#447700>!<a name='2596'></font>
<font color=#447700>!--- WETCAN is the fraction of vegetated area covered by canopy<a name='2597'></font>
<font color=#447700>!--- water, and DRYCAN is the fraction of vegetated area where<a name='2598'></font>
<font color=#447700>!--- transpiration may take place.<a name='2599'></font>
<a name='2600'>
          WETCAN=min(0.25,(CST/SAT)**CN)<a name='2601'>
<font color=#447700>!          if(lai &gt; 1.) wetcan=wetcan/lai<a name='2602'></font>
          DRYCAN=1.-WETCAN<a name='2603'>
<a name='2604'>
<font color=#447700>!**************************************************************<a name='2605'></font>
<font color=#447700>!  TRANSF computes transpiration function<a name='2606'></font>
<font color=#447700>!**************************************************************<a name='2607'></font>
           CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#TRANSF'>TRANSF</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRANSF_1">(i,j,                                   &amp;<a name='2608'>
<font color=#447700>!--- input variables<a name='2609'></font>
              nzs,nroot,soiliqw,tabs,lai,gswin,               &amp;<a name='2610'>
<font color=#447700>!--- soil fixed fields<a name='2611'></font>
              dqm,qmin,ref,wilt,zshalf,pc,iland,              &amp;<a name='2612'>
<font color=#447700>!--- output variables<a name='2613'></font>
              tranf,transum)<a name='2614'>
<a name='2615'>
<a name='2616'>
<font color=#447700>!--- Save soil temp and moisture from the beginning of time step<a name='2617'></font>
          do k=1,nzs<a name='2618'>
           told(k)=tso(k)<a name='2619'>
           smold(k)=soilmois(k)<a name='2620'>
          enddo<a name='2621'>
<a name='2622'>
<font color=#447700>! Sakaguchi and Zeng (2009) - dry soil resistance to evaporation<a name='2623'></font>
<font color=#447700>!      if (vgtype==11) then   ! MODIS wetland<a name='2624'></font>
        alfa=1.<a name='2625'>
<font color=#447700>!      else<a name='2626'></font>
        fex=min(1.,soilmois(1)/dqm)<a name='2627'>
        fex=max(fex,0.01)<a name='2628'>
        psit=psis*fex ** (-bclh)<a name='2629'>
        psit = max(-1.e5, psit)<a name='2630'>
        alfa=min(1.,exp(g*psit/r_v/SOILT))<a name='2631'>
<font color=#447700>!      endif<a name='2632'></font>
        alfa=1.<a name='2633'>
<font color=#447700>! field capacity<a name='2634'></font>
        fc=max(qmin,ref*0.5)<a name='2635'>
        fex_fc=1.<a name='2636'>
      if((soilmois(1)+qmin) &gt; fc .or. (qvatm-qvg) &gt; 0.) then<a name='2637'>
        soilres = 1.<a name='2638'>
      else<a name='2639'>
        fex_fc=min(1.,(soilmois(1)+qmin)/fc)<a name='2640'>
        fex_fc=max(fex_fc,0.01)<a name='2641'>
        soilres=0.25*(1.-cos(piconst*fex_fc))**2.<a name='2642'>
      endif<a name='2643'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2644'>
<font color=#447700>!    if (i==421.and.j==280) then<a name='2645'></font>
     print *,'fex,psit,psis,bclh,g,r_v,soilt,alfa,mavail,soilmois(1),fc,ref,soilres,fex_fc', &amp;<a name='2646'>
              fex,psit,psis,bclh,g,r_v,soilt,alfa,mavail,soilmois(1),fc,ref,soilres,fex_fc<a name='2647'>
    endif<a name='2648'>
<a name='2649'>
<font color=#447700>!**************************************************************<a name='2650'></font>
<font color=#447700>!  SOILTEMP soilves heat budget and diffusion eqn. in soil<a name='2651'></font>
<font color=#447700>!**************************************************************<a name='2652'></font>
<a name='2653'>
        CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILTEMP'>SOILTEMP</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILTEMP_1">(                                        &amp;<a name='2654'>
<font color=#447700>!--- input variables<a name='2655'></font>
             i,j,iland,isoil,                                 &amp;<a name='2656'>
             delt,ktau,conflx,nzs,nddzs,nroot,                &amp;<a name='2657'>
             PRCPMS,RAINF,                                    &amp;<a name='2658'>
             PATM,TABS,QVATM,QCATM,EMISS,RNET,                &amp;<a name='2659'>
             QKMS,TKMS,PC,rho,vegfrac, lai,                   &amp;<a name='2660'>
             thdif,cap,drycan,wetcan,                         &amp; <a name='2661'>
             transum,dew,mavail,soilres,alfa,                 &amp;<a name='2662'>
<font color=#447700>!--- soil fixed fields<a name='2663'></font>
             dqm,qmin,bclh,zsmain,zshalf,DTDZS,tbq,           &amp;<a name='2664'>
<font color=#447700>!--- constants<a name='2665'></font>
             xlv,CP,G0_P,cvw,stbolt,                          &amp;<a name='2666'>
<font color=#447700>!--- output variables<a name='2667'></font>
             tso,soilt,qvg,qsg,qcg,x)<a name='2668'>
<a name='2669'>
<font color=#447700>!************************************************************************<a name='2670'></font>
<a name='2671'>
<font color=#447700>!--- CALCULATION OF DEW USING NEW VALUE OF QSG OR TRANSP IF NO DEW<a name='2672'></font>
        ETT1=0.<a name='2673'>
        DEW=0.<a name='2674'>
<a name='2675'>
        IF(QVATM.GE.QSG)THEN<a name='2676'>
          DEW=QKMS*(QVATM-QSG)<a name='2677'>
          ETT1=0.<a name='2678'>
          DO K=1,NZS<a name='2679'>
            TRANSP(K)=0.<a name='2680'>
          ENDDO<a name='2681'>
        ELSE<a name='2682'>
<a name='2683'>
          DO K=1,NROOT<a name='2684'>
            TRANSP(K)=VEGFRAC*RAS*QKMS*                       &amp;<a name='2685'>
                    (QVATM-QSG)*                              &amp;<a name='2686'>
                    TRANF(K)*DRYCAN/ZSHALF(NROOT+1)<a name='2687'>
               IF(TRANSP(K).GT.0.) TRANSP(K)=0.<a name='2688'>
            ETT1=ETT1-TRANSP(K)<a name='2689'>
          ENDDO<a name='2690'>
          DO k=nroot+1,nzs<a name='2691'>
            transp(k)=0.<a name='2692'>
          enddo<a name='2693'>
        ENDIF<a name='2694'>
<a name='2695'>
<font color=#447700>!-- Recalculate volumetric content of frozen water in soil<a name='2696'></font>
         DO K=1,NZS<a name='2697'>
<font color=#447700>!- main levels<a name='2698'></font>
           tln=log(tso(k)/273.15)<a name='2699'>
         if(tln.lt.0.) then<a name='2700'>
           soiliqw(k)=(dqm+qmin)*(XLMELT*                     &amp;<a name='2701'>
          (tso(k)-273.15)/tso(k)/9.81/psis)                   &amp; <a name='2702'>
           **(-1./bclh)-qmin<a name='2703'>
           soiliqw(k)=max(0.,soiliqw(k))<a name='2704'>
           soiliqw(k)=min(soiliqw(k),soilmois(k))<a name='2705'>
           soilice(k)=(soilmois(k)-soiliqw(k))/riw<a name='2706'>
<font color=#447700>!---- melting and freezing is balanced, soil ice cannot increase<a name='2707'></font>
       if(keepfr(k).eq.1.) then<a name='2708'>
           soilice(k)=min(soilice(k),smfrkeep(k))<a name='2709'>
           soiliqw(k)=max(0.,soilmois(k)-soilice(k)*riw)<a name='2710'>
       endif<a name='2711'>
<a name='2712'>
         else<a name='2713'>
           soilice(k)=0.<a name='2714'>
           soiliqw(k)=soilmois(k)<a name='2715'>
         endif<a name='2716'>
         ENDDO<a name='2717'>
<a name='2718'>
<font color=#447700>!*************************************************************************<a name='2719'></font>
<font color=#447700>! SOILMOIST solves moisture budget (Smirnova et al., 1996, EQ.22,28) <a name='2720'></font>
<font color=#447700>!           and Richards eqn.<a name='2721'></font>
<font color=#447700>!*************************************************************************<a name='2722'></font>
          CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILMOIST'>SOILMOIST</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILMOIST_1"> (                                     &amp;<a name='2723'>
<font color=#447700>!-- input<a name='2724'></font>
               delt,nzs,nddzs,DTDZS,DTDZS2,RIW,                &amp;<a name='2725'>
               zsmain,zshalf,diffu,hydro,                      &amp;<a name='2726'>
               QSG,QVG,QCG,QCATM,QVATM,-infwater,              &amp;<a name='2727'>
               QKMS,TRANSP,DRIP,DEW,0.,SOILICE,VEGFRAC,        &amp;<a name='2728'>
               0.,soilres,                                     &amp;<a name='2729'>
<font color=#447700>!-- soil properties<a name='2730'></font>
               DQM,QMIN,REF,KSAT,RAS,INFMAX,                   &amp;<a name='2731'>
<font color=#447700>!-- output<a name='2732'></font>
               SOILMOIS,SOILIQW,MAVAIL,RUNOFF1,                &amp;<a name='2733'>
               RUNOFF2,INFILTRP)<a name='2734'>
        <a name='2735'>
<font color=#447700>!--- KEEPFR is 1 when the temperature and moisture in soil<a name='2736'></font>
<font color=#447700>!--- are both increasing. In this case soil ice should not<a name='2737'></font>
<font color=#447700>!--- be increasing according to the freezing curve.<a name='2738'></font>
<font color=#447700>!--- Some part of ice is melted, but additional water is<a name='2739'></font>
<font color=#447700>!--- getting frozen. Thus, only structure of frozen soil is<a name='2740'></font>
<font color=#447700>!--- changed, and phase changes are not affecting the heat<a name='2741'></font>
<font color=#447700>!--- transfer. This situation may happen when it rains on the<a name='2742'></font>
<font color=#447700>!--- frozen soil.<a name='2743'></font>
 <a name='2744'>
        do k=1,nzs<a name='2745'>
       if (soilice(k).gt.0.) then<a name='2746'>
          if(tso(k).gt.told(k).and.soilmois(k).gt.smold(k)) then<a name='2747'>
              keepfr(k)=1.<a name='2748'>
          else<a name='2749'>
              keepfr(k)=0.<a name='2750'>
          endif<a name='2751'>
       endif<a name='2752'>
        enddo<a name='2753'>
<a name='2754'>
<font color=#447700>!--- THE DIAGNOSTICS OF SURFACE FLUXES <a name='2755'></font>
<a name='2756'>
          T3      = STBOLT*SOILTold*SOILTold*SOILTold<a name='2757'>
          UPFLUX  = T3 * 0.5*(SOILTold+SOILT)<a name='2758'>
          XINET   = EMISS*(GLW-UPFLUX)<a name='2759'>
<font color=#447700>!          RNET    = GSW + XINET<a name='2760'></font>
          HFT=-TKMS*CP*RHO*(TABS-SOILT)<a name='2761'>
          HFX=-TKMS*CP*RHO*(TABS-SOILT)                        &amp;<a name='2762'>
               *(P1000mb*0.00001/Patm)**ROVCP<a name='2763'>
          Q1=-QKMS*RAS*(QVATM - QSG)<a name='2764'>
<a name='2765'>
          CMC2MS = 0.<a name='2766'>
        IF (Q1.LE.0.) THEN<a name='2767'>
<font color=#447700>! ---  condensation<a name='2768'></font>
          EC1=0.<a name='2769'>
          EDIR1=0.<a name='2770'>
          ETT1=0.<a name='2771'>
     if(myj) then<a name='2772'>
<font color=#447700>!-- moisture flux for coupling with MYJ PBL<a name='2773'></font>
          EETA=-QKMS*RAS*(QVATM/(1.+QVATM) - QSG/(1.+QSG))*1.E3<a name='2774'>
          CST= CST-EETA*DELT*vegfrac<a name='2775'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2776'>
<font color=#447700>!!!    IF(i.eq.374.and.j.eq.310.or. EETA.gt.0.0004) then<a name='2777'></font>
        print *,'Cond MYJ EETA',eeta,eeta*xlv, i,j<a name='2778'>
    ENDIF<a name='2779'>
     else <font color=#447700>! myj<a name='2780'></font>
<font color=#447700>!-- actual moisture flux from RUC LSM<a name='2781'></font>
          EETA= - RHO*DEW<a name='2782'>
          CST=CST+DELT*DEW*RAS * vegfrac<a name='2783'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2784'>
<font color=#447700>!    IF(i.eq.374.and.j.eq.310.or. EETA.gt.0.0004) then<a name='2785'></font>
<font color=#447700>!    IF(i.eq.440.and.j.eq.180.or. QFX.gt.1000..or.i.eq.417.and.j.eq.540) then<a name='2786'></font>
       print *,'Cond RUC LSM EETA',EETA,eeta*xlv, i,j<a name='2787'>
    ENDIF<a name='2788'>
     endif <font color=#447700>! myj<a name='2789'></font>
          QFX= XLV*EETA<a name='2790'>
        ELSE<a name='2791'>
<font color=#447700>! ---  evaporation<a name='2792'></font>
          EDIR1 =-soilres*(1.-vegfrac)*QKMS*RAS*                      &amp;<a name='2793'>
                  (QVATM-QVG)<a name='2794'>
          CMC2MS=CST/DELT*RAS<a name='2795'>
          EC1 = Q1 * WETCAN * vegfrac<a name='2796'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2797'>
<font color=#447700>!     IF(i.eq.440.and.j.eq.180.or. QFX.gt.1000..or.i.eq.417.and.j.eq.540) then<a name='2798'></font>
       print *,'CST before update=',cst<a name='2799'>
       print *,'EC1=',EC1,'CMC2MS=',CMC2MS<a name='2800'>
     ENDIF<a name='2801'>
<font color=#447700>!    ENDIF<a name='2802'></font>
<a name='2803'>
          CST=max(0.,CST-EC1 * DELT)<a name='2804'>
<a name='2805'>
<font color=#447700>!      if (EC1 &gt; CMC2MS) then<a name='2806'></font>
<font color=#447700>!          EC1 = min(cmc2ms,ec1)<a name='2807'></font>
<font color=#447700>!          CST = 0.<a name='2808'></font>
<font color=#447700>!      endif<a name='2809'></font>
<a name='2810'>
     if (myj) then<a name='2811'>
<font color=#447700>!-- moisture flux for coupling with MYJ PBL<a name='2812'></font>
          EETA=-soilres*QKMS*RAS*(QVATM/(1.+QVATM) - QVG/(1.+QVG))*1.E3<a name='2813'>
     else <font color=#447700>! myj<a name='2814'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2815'>
<font color=#447700>!    IF(i.eq.440.and.j.eq.180.or. QFX.gt.1000..or.i.eq.417.and.j.eq.540) then<a name='2816'></font>
       print *,'QKMS,RAS,QVATM/(1.+QVATM),QVG/(1.+QVG),QSG ', &amp;<a name='2817'>
                QKMS,RAS,QVATM/(1.+QVATM),QVG/(1.+QVG),QSG<a name='2818'>
       print *,'Q1*(1.-vegfrac),EDIR1',Q1*(1.-vegfrac),EDIR1<a name='2819'>
       print *,'CST,WETCAN,DRYCAN',CST,WETCAN,DRYCAN<a name='2820'>
       print *,'EC1=',EC1,'ETT1=',ETT1,'CMC2MS=',CMC2MS,'CMC2MS*ras=',CMC2MS*ras<a name='2821'>
<font color=#447700>!       print *,'MYJ EETA',eeta,eeta*xlv<a name='2822'></font>
    ENDIF<a name='2823'>
<font color=#447700>!-- actual moisture flux from RUC LSM<a name='2824'></font>
          EETA = (EDIR1 + EC1 + ETT1)*1.E3<a name='2825'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2826'>
<font color=#447700>!    IF(i.eq.374.and.j.eq.310.or. EETA.gt.0.0004) then<a name='2827'></font>
<font color=#447700>!    IF(i.eq.440.and.j.eq.180 .or. qfx.gt.1000..or.i.eq.417.and.j.eq.540) then<a name='2828'></font>
        print *,'RUC LSM EETA',EETA,eeta*xlv<a name='2829'>
    ENDIF<a name='2830'>
     endif <font color=#447700>! myj<a name='2831'></font>
          QFX= XLV * EETA<a name='2832'>
        ENDIF<a name='2833'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2834'>
     print *,'potential temp HFT ',HFT<a name='2835'>
     print *,'abs temp HFX ',HFX<a name='2836'>
    ENDIF<a name='2837'>
<a name='2838'>
          EVAPL=EETA<a name='2839'>
          S=THDIF(1)*CAP(1)*DZSTOP*(TSO(1)-TSO(2))<a name='2840'>
<font color=#447700>! Energy budget<a name='2841'></font>
          FLTOT=RNET-HFT-XLV*EETA-S-X<a name='2842'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2843'>
<font color=#447700>!    IF(i.eq.440.and.j.eq.180 .or. qfx.gt.1000..or.i.eq.417.and.j.eq.540) then<a name='2844'></font>
       print *,'SOIL - FLTOT,RNET,HFT,QFX,S,X=',i,j,FLTOT,RNET,HFT,XLV*EETA,s,x<a name='2845'>
       print *,'edir1,ec1,ett1,mavail,qkms,qvatm,qvg,qsg,vegfrac',&amp;<a name='2846'>
                edir1,ec1,ett1,mavail,qkms,qvatm,qvg,qsg,vegfrac<a name='2847'>
    ENDIF<a name='2848'>
    if(detal(1) .ne. 0.) then<a name='2849'>
<font color=#447700>! SMF - energy of phase change in the first soil layer<a name='2850'></font>
<font color=#447700>!        smf=xlmelt*1.e3*(soiliqwm(1)-soiliqwmold(1))/delt<a name='2851'></font>
         smf=fltot<a name='2852'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='2853'>
     print *,'detal(1),xlmelt,soiliqwm(1),delt',detal(1),xlmelt,soiliqwm(1),delt<a name='2854'>
     print *,'Implicit phase change in the first layer - smf=',smf<a name='2855'>
    ENDIF<a name='2856'>
    endif<a name='2857'>
<a name='2858'>
<a name='2859'>
 222    CONTINUE<a name='2860'>
<a name='2861'>
 1123    FORMAT(I5,8F12.3)<a name='2862'>
 1133    FORMAT(I7,8E12.4)<a name='2863'>
  123   format(i6,f6.2,7f8.1)<a name='2864'>
  122   FORMAT(1X,2I3,6F8.1,F8.3,F8.2)<a name='2865'>
<font color=#447700>!-------------------------------------------------------------------<a name='2866'></font>
   END SUBROUTINE SOIL<a name='2867'>
<font color=#447700>!-------------------------------------------------------------------<a name='2868'></font>
<a name='2869'>
<A NAME='SICE'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SICE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2870'>
        <font color=#993300>SUBROUTINE </font><font color=#cc0000>SICE</font> (                                       &amp; <A href='../../call_to/SICE.html' TARGET='index'>2</A>,<A href='../../call_from/SICE.html' TARGET='index'>1</A><a name='2871'>
<font color=#447700>!--- input variables<a name='2872'></font>
            i,j,iland,isoil,delt,ktau,conflx,nzs,nddzs,nroot,   &amp;<a name='2873'>
            PRCPMS,RAINF,PATM,QVATM,QCATM,GLW,GSW,              &amp;<a name='2874'>
            EMISS,RNET,QKMS,TKMS,rho,myj,                       &amp;<a name='2875'>
<font color=#447700>!--- sea ice parameters<a name='2876'></font>
            tice,rhosice,capice,thdifice,                       &amp;<a name='2877'>
            zsmain,zshalf,DTDZS,DTDZS2,tbq,                     &amp;<a name='2878'>
<font color=#447700>!--- constants<a name='2879'></font>
            xlv,CP,rovcp,cw,stbolt,tabs,                        &amp;<a name='2880'>
<font color=#447700>!--- output variables<a name='2881'></font>
            tso,dew,soilt,qvg,qsg,qcg,                          &amp;<a name='2882'>
            eeta,qfx,hfx,s,evapl,prcpl,fltot                          &amp;<a name='2883'>
                                                                )<a name='2884'>
<a name='2885'>
<font color=#447700>!*****************************************************************<a name='2886'></font>
<font color=#447700>!   Energy budget and  heat diffusion eqns. for<a name='2887'></font>
<font color=#447700>!   sea ice<a name='2888'></font>
<font color=#447700>!*************************************************************<a name='2889'></font>
<a name='2890'>
        IMPLICIT NONE<a name='2891'>
<font color=#447700>!-----------------------------------------------------------------<a name='2892'></font>
<a name='2893'>
<font color=#447700>!--- input variables<a name='2894'></font>
<a name='2895'>
   INTEGER,  INTENT(IN   )   ::  nroot,ktau,nzs                , &amp;<a name='2896'>
                                 nddzs                    <font color=#447700>!nddzs=2*(nzs-2)<a name='2897'></font>
   INTEGER,  INTENT(IN   )   ::  i,j,iland,isoil<a name='2898'>
   REAL,     INTENT(IN   )   ::  DELT,CONFLX<a name='2899'>
   LOGICAL,  INTENT(IN   )   ::  myj<a name='2900'>
<font color=#447700>!--- 3-D Atmospheric variables<a name='2901'></font>
   REAL,                                                         &amp;<a name='2902'>
            INTENT(IN   )    ::                            PATM, &amp;<a name='2903'>
                                                          QVATM, &amp;<a name='2904'>
                                                          QCATM<a name='2905'>
<font color=#447700>!--- 2-D variables<a name='2906'></font>
   REAL,                                                         &amp;<a name='2907'>
            INTENT(IN   )    ::                             GLW, &amp;<a name='2908'>
                                                            GSW, &amp;<a name='2909'>
                                                          EMISS, &amp;<a name='2910'>
                                                            RHO, &amp;<a name='2911'>
                                                           QKMS, &amp;<a name='2912'>
                                                           TKMS<a name='2913'>
<font color=#447700>!--- sea ice properties<a name='2914'></font>
   REAL,    DIMENSION(1:NZS)                                   , &amp;<a name='2915'>
            INTENT(IN   )    ::                                  &amp;<a name='2916'>
                                                           tice, &amp;<a name='2917'>
                                                        rhosice, &amp;<a name='2918'>
                                                         capice, &amp;<a name='2919'>
                                                       thdifice<a name='2920'>
<a name='2921'>
<a name='2922'>
   REAL,     INTENT(IN   )   ::                                  &amp;<a name='2923'>
                                                             CW, &amp;<a name='2924'>
                                                            XLV<a name='2925'>
<a name='2926'>
<a name='2927'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::            ZSMAIN, &amp;<a name='2928'>
                                                         ZSHALF, &amp;<a name='2929'>
                                                         DTDZS2<a name='2930'>
<a name='2931'>
   REAL,     DIMENSION(1:NDDZS), INTENT(IN)  ::           DTDZS<a name='2932'>
<a name='2933'>
   REAL,     DIMENSION(1:5001), INTENT(IN)  ::              TBQ<a name='2934'>
<a name='2935'>
<a name='2936'>
<font color=#447700>!--- input/output variables<a name='2937'></font>
<font color=#447700>!----soil temperature<a name='2938'></font>
   REAL,     DIMENSION( 1:nzs ),  INTENT(INOUT)   ::        TSO<a name='2939'>
<font color=#447700>!-------- 2-d variables<a name='2940'></font>
   REAL,                                                         &amp;<a name='2941'>
             INTENT(INOUT)   ::                             DEW, &amp;<a name='2942'>
                                                           EETA, &amp;<a name='2943'>
                                                          EVAPL, &amp;<a name='2944'>
                                                          PRCPL, &amp;<a name='2945'>
                                                            QVG, &amp;<a name='2946'>
                                                            QSG, &amp;<a name='2947'>
                                                            QCG, &amp;<a name='2948'>
                                                           RNET, &amp;<a name='2949'>
                                                            QFX, &amp;<a name='2950'>
                                                            HFX, &amp;<a name='2951'>
                                                              S, &amp;<a name='2952'>
                                                          SOILT<a name='2953'>
<a name='2954'>
<font color=#447700>!--- Local variables<a name='2955'></font>
   REAL    ::  x,x1,x2,x4,tn,denom<a name='2956'>
   REAL    ::  RAINF,  PRCPMS                                  , &amp;<a name='2957'>
               TABS, T3, UPFLUX, XINET<a name='2958'>
<a name='2959'>
   REAL    ::  CP,rovcp,G0,LV,STBOLT,xlmelt,dzstop             , &amp;<a name='2960'>
               epot,fltot,ft,fq,hft,ras,cvw                    <a name='2961'>
<a name='2962'>
   REAL    ::  FKT,D1,D2,D9,D10,DID,R211,R21,R22,R6,R7,D11     , &amp;<a name='2963'>
               PI,H,FKQ,R210,AA,BB,PP,Q1,QS1,TS1,TQ2,TX2       , &amp;<a name='2964'>
               TDENOM,QGOLD,SNOH<a name='2965'>
<a name='2966'>
   REAL    ::  AA1,RHCS, icemelt<a name='2967'>
<a name='2968'>
<a name='2969'>
   REAL,     DIMENSION(1:NZS)  ::   cotso,rhtso<a name='2970'>
<a name='2971'>
   INTEGER ::  nzs1,nzs2,k,k1,kn,kk<a name='2972'>
<a name='2973'>
<font color=#447700>!-----------------------------------------------------------------<a name='2974'></font>
<a name='2975'>
<font color=#447700>!-- define constants<a name='2976'></font>
<font color=#447700>!        STBOLT=5.670151E-8<a name='2977'></font>
        XLMELT=3.35E+5<a name='2978'>
        cvw=cw<a name='2979'>
<a name='2980'>
        prcpl=prcpms<a name='2981'>
<a name='2982'>
          NZS1=NZS-1<a name='2983'>
          NZS2=NZS-2<a name='2984'>
        dzstop=1./(zsmain(2)-zsmain(1))<a name='2985'>
        RAS=RHO*1.E-3<a name='2986'>
<a name='2987'>
        do k=1,nzs<a name='2988'>
           cotso(k)=0.<a name='2989'>
           rhtso(k)=0.<a name='2990'>
        enddo<a name='2991'>
<a name='2992'>
        cotso(1)=0.<a name='2993'>
        rhtso(1)=TSO(NZS)<a name='2994'>
<a name='2995'>
        DO 33 K=1,NZS2<a name='2996'>
          KN=NZS-K<a name='2997'>
          K1=2*KN-3<a name='2998'>
          X1=DTDZS(K1)*THDIFICE(KN-1)<a name='2999'>
          X2=DTDZS(K1+1)*THDIFICE(KN)<a name='3000'>
          FT=TSO(KN)+X1*(TSO(KN-1)-TSO(KN))                             &amp;<a name='3001'>
             -X2*(TSO(KN)-TSO(KN+1))<a name='3002'>
          DENOM=1.+X1+X2-X2*cotso(K)<a name='3003'>
          cotso(K+1)=X1/DENOM<a name='3004'>
          rhtso(K+1)=(FT+X2*rhtso(K))/DENOM<a name='3005'>
   33  CONTINUE<a name='3006'>
<a name='3007'>
<font color=#447700>!************************************************************************<a name='3008'></font>
<font color=#447700>!--- THE HEAT BALANCE EQUATION (Smirnova et al., 1996, EQ. 21,26)<a name='3009'></font>
        RHCS=CAPICE(1)<a name='3010'>
        H=1.<a name='3011'>
        FKT=TKMS<a name='3012'>
        D1=cotso(NZS1)<a name='3013'>
        D2=rhtso(NZS1)<a name='3014'>
        TN=SOILT<a name='3015'>
        D9=THDIFICE(1)*RHCS*dzstop<a name='3016'>
        D10=TKMS*CP*RHO<a name='3017'>
        R211=.5*CONFLX/DELT<a name='3018'>
        R21=R211*CP*RHO<a name='3019'>
        R22=.5/(THDIFICE(1)*DELT*dzstop**2)<a name='3020'>
        R6=EMISS *STBOLT*.5*TN**4<a name='3021'>
        R7=R6/TN<a name='3022'>
        D11=RNET+R6<a name='3023'>
        TDENOM=D9*(1.-D1+R22)+D10+R21+R7                              &amp;<a name='3024'>
              +RAINF*CVW*PRCPMS<a name='3025'>
        FKQ=QKMS*RHO<a name='3026'>
        R210=R211*RHO<a name='3027'>
        AA=XLS*(FKQ+R210)/TDENOM<a name='3028'>
        BB=(D10*TABS+R21*TN+XLS*(QVATM*FKQ                            &amp;<a name='3029'>
        +R210*QVG)+D11+D9*(D2+R22*TN)                                 &amp;<a name='3030'>
        +RAINF*CVW*PRCPMS*max(273.15,TABS)                            &amp;<a name='3031'>
         )/TDENOM<a name='3032'>
        AA1=AA<a name='3033'>
        PP=PATM*1.E3<a name='3034'>
        AA1=AA1/PP<a name='3035'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3036'>
        PRINT *,' VILKA-SEAICE1'<a name='3037'>
        print *,'D10,TABS,R21,TN,QVATM,FKQ',                          &amp;<a name='3038'>
                 D10,TABS,R21,TN,QVATM,FKQ<a name='3039'>
        print *,'RNET, EMISS, STBOLT, SOILT',RNET, EMISS, STBOLT, SOILT<a name='3040'>
        print *,'R210,QVG,D11,D9,D2,R22,RAINF,CVW,PRCPMS,TDENOM',     &amp;<a name='3041'>
                 R210,QVG,D11,D9,D2,R22,RAINF,CVW,PRCPMS,TDENOM<a name='3042'>
        print *,'tn,aa1,bb,pp,fkq,r210',                              &amp;<a name='3043'>
                 tn,aa1,bb,pp,fkq,r210<a name='3044'>
    ENDIF<a name='3045'>
        QGOLD=QSG<a name='3046'>
        CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#VILKA'>VILKA</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SICE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VILKA_1">(TN,AA1,BB,PP,QS1,TS1,TBQ,KTAU,i,j,iland,isoil)<a name='3047'>
<font color=#447700>!--- it is saturation over sea ice<a name='3048'></font>
        QVG=QS1<a name='3049'>
        QSG=QS1<a name='3050'>
        TSO(1)=min(271.4,TS1)<a name='3051'>
        QCG=0.<a name='3052'>
<font color=#447700>!--- sea ice melting is not included in this simple approach<a name='3053'></font>
<font color=#447700>!--- SOILT - skin temperature<a name='3054'></font>
          SOILT=TSO(1)<a name='3055'>
<font color=#447700>!---- Final solution for soil temperature - TSO<a name='3056'></font>
          DO K=2,NZS<a name='3057'>
            KK=NZS-K+1<a name='3058'>
            TSO(K)=min(271.4,rhtso(KK)+cotso(KK)*TSO(K-1))<a name='3059'>
          END DO<a name='3060'>
<font color=#447700>!--- CALCULATION OF DEW USING NEW VALUE OF QSG OR TRANSP IF NO DEW<a name='3061'></font>
        DEW=0.<a name='3062'>
<a name='3063'>
<font color=#447700>!--- THE DIAGNOSTICS OF SURFACE FLUXES <a name='3064'></font>
          T3      = STBOLT*TN*TN*TN<a name='3065'>
          UPFLUX  = T3 *0.5*(TN+SOILT)<a name='3066'>
          XINET   = EMISS*(GLW-UPFLUX)<a name='3067'>
<font color=#447700>!          RNET    = GSW + XINET<a name='3068'></font>
          HFT=-TKMS*CP*RHO*(TABS-SOILT)<a name='3069'>
          HFX=-TKMS*CP*RHO*(TABS-SOILT)                        &amp;<a name='3070'>
               *(P1000mb*0.00001/Patm)**ROVCP<a name='3071'>
          Q1=-QKMS*RAS*(QVATM - QSG)<a name='3072'>
        IF (Q1.LE.0.) THEN<a name='3073'>
<font color=#447700>! ---  condensation<a name='3074'></font>
     if(myj) then<a name='3075'>
<font color=#447700>!-- moisture flux for coupling with MYJ PBL<a name='3076'></font>
          EETA=-QKMS*RAS*(QVATM/(1.+QVATM) - QSG/(1.+QSG))*1.E3<a name='3077'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3078'>
       print *,'MYJ EETA',eeta<a name='3079'>
    ENDIF<a name='3080'>
     else <font color=#447700>! myj<a name='3081'></font>
<font color=#447700>!-- actual moisture flux from RUC LSM<a name='3082'></font>
          DEW=QKMS*(QVATM-QSG)<a name='3083'>
          EETA= - RHO*DEW<a name='3084'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3085'>
       print *,'RUC LSM EETA',eeta<a name='3086'>
    ENDIF<a name='3087'>
     endif <font color=#447700>! myj<a name='3088'></font>
          QFX= XLS*EETA<a name='3089'>
        ELSE<a name='3090'>
<font color=#447700>! ---  evaporation<a name='3091'></font>
     if(myj) then<a name='3092'>
<font color=#447700>!-- moisture flux for coupling with MYJ PBL<a name='3093'></font>
          EETA=-QKMS*RAS*(QVATM/(1.+QVATM) - QVG/(1.+QVG))*1.E3<a name='3094'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3095'>
       print *,'MYJ EETA',eeta<a name='3096'>
    ENDIF<a name='3097'>
     else <font color=#447700>! myj<a name='3098'></font>
<font color=#447700>! to convert from m s-1 to kg m-2 s-1: *rho water=1.e3************<a name='3099'></font>
<font color=#447700>!-- actual moisture flux from RUC LSM<a name='3100'></font>
          EETA = Q1*1.E3<a name='3101'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3102'>
       print *,'RUC LSM EETA',eeta<a name='3103'>
    ENDIF<a name='3104'>
     endif <font color=#447700>! myj<a name='3105'></font>
          QFX= XLS * EETA<a name='3106'>
        ENDIF<a name='3107'>
          EVAPL=EETA<a name='3108'>
<a name='3109'>
          S=THDIFICE(1)*CAPICE(1)*DZSTOP*(TSO(1)-TSO(2))<a name='3110'>
<font color=#447700>! heat storage in surface layer<a name='3111'></font>
        SNOH=0.<a name='3112'>
<font color=#447700>! There is ice melt<a name='3113'></font>
         X= (cp*rho*r211+rhcs*zsmain(2)*0.5/delt)*(SOILT-TN) +   &amp;<a name='3114'>
            XLS*rho*r211*(QSG-QGOLD)<a name='3115'>
         X=X &amp;<a name='3116'>
<font color=#447700>! "heat" from rain<a name='3117'></font>
        -RAINF*CVW*PRCPMS*(max(273.15,TABS)-SOILT)<a name='3118'>
<a name='3119'>
<font color=#447700>!-- excess energy spent on sea ice melt<a name='3120'></font>
        icemelt=RNET-XLS*EETA -HFT -S -X<a name='3121'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3122'>
        print *,'icemelt=',icemelt<a name='3123'>
    ENDIF<a name='3124'>
<a name='3125'>
          FLTOT=RNET-XLS*EETA-HFT-S-X-icemelt<a name='3126'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3127'>
       print *,'SICE - FLTOT,RNET,HFT,QFX,S,SNOH,X=', &amp;<a name='3128'>
                       FLTOT,RNET,HFT,XLS*EETA,s,icemelt,X<a name='3129'>
    ENDIF<a name='3130'>
<a name='3131'>
<font color=#447700>!-------------------------------------------------------------------<a name='3132'></font>
   END SUBROUTINE SICE<a name='3133'>
<font color=#447700>!-------------------------------------------------------------------<a name='3134'></font>
<a name='3135'>
<a name='3136'>
<a name='3137'>
<A NAME='SNOWSOIL'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSOIL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3138'>
        <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWSOIL</font> (spp_lsm,rstochcol,fieldcol_sf,&amp; <A href='../../call_to/SNOWSOIL.html' TARGET='index'>1</A>,<A href='../../call_from/SNOWSOIL.html' TARGET='index'>4</A><a name='3139'>
<font color=#447700>!--- input variables<a name='3140'></font>
             i,j,isoil,delt,ktau,conflx,nzs,nddzs,nroot,       &amp;<a name='3141'>
             meltfactor,rhonewsn,SNHEI_CRIT,                   &amp; <font color=#447700>! new<a name='3142'></font>
             ILAND,PRCPMS,RAINF,NEWSNOW,snhei,SNWE,SNOWFRAC,   &amp;<a name='3143'>
             RHOSN,                                            &amp;<a name='3144'>
             PATM,QVATM,QCATM,                                 &amp;<a name='3145'>
             GLW,GSW,GSWin,EMISS,RNET,IVGTYP,                  &amp;<a name='3146'>
             QKMS,TKMS,PC,cst,drip,infwater,                   &amp;<a name='3147'>
             rho,vegfrac,alb,znt,lai,                          &amp; <a name='3148'>
             MYJ,                                              &amp;<a name='3149'>
<font color=#447700>!--- soil fixed fields<a name='3150'></font>
             QWRTZ,rhocs,dqm,qmin,ref,wilt,psis,bclh,ksat,     &amp;<a name='3151'>
             sat,cn,zsmain,zshalf,DTDZS,DTDZS2,tbq,            &amp;<a name='3152'>
<font color=#447700>!--- constants<a name='3153'></font>
             xlv,CP,rovcp,G0_P,cw,stbolt,TABS,                 &amp;<a name='3154'>
             KQWRTZ,KICE,KWT,                                  &amp;<a name='3155'>
<font color=#447700>!--- output variables<a name='3156'></font>
             ilnb,snweprint,snheiprint,rsm,                    &amp;<a name='3157'>
             soilmois,tso,smfrkeep,keepfr,                     &amp;<a name='3158'>
             dew,soilt,soilt1,tsnav,                           &amp;<a name='3159'>
             qvg,qsg,qcg,SMELT,SNOH,SNFLX,SNOM,                &amp;<a name='3160'>
             edir1,ec1,ett1,eeta,qfx,hfx,s,sublim,             &amp;<a name='3161'>
             prcpl,fltot,runoff1,runoff2,mavail,soilice,             &amp;<a name='3162'>
             soiliqw,infiltrp                                  )<a name='3163'>
<a name='3164'>
<font color=#447700>!***************************************************************<a name='3165'></font>
<font color=#447700>!   Energy and moisture budget for snow, heat diffusion eqns.<a name='3166'></font>
<font color=#447700>!   in snow and soil, Richards eqn. for soil covered with snow<a name='3167'></font>
<font color=#447700>!<a name='3168'></font>
<font color=#447700>!     DELT - time step (s)<a name='3169'></font>
<font color=#447700>!     ktau - numver of time step<a name='3170'></font>
<font color=#447700>!     CONFLX - depth of constant flux layer (m)<a name='3171'></font>
<font color=#447700>!     J,I - the location of grid point<a name='3172'></font>
<font color=#447700>!     IME, JME,  NZS - dimensions of the domain<a name='3173'></font>
<font color=#447700>!     NROOT - number of levels within the root zone<a name='3174'></font>
<font color=#447700>!     PRCPMS - precipitation rate in m/s<a name='3175'></font>
<font color=#447700>!     NEWSNOW - pcpn in soilid form (m)<a name='3176'></font>
<font color=#447700>!     SNHEI, SNWE - snow height and snow water equivalent (m)<a name='3177'></font>
<font color=#447700>!     RHOSN - snow density (kg/m-3)<a name='3178'></font>
<font color=#447700>!     PATM - pressure (bar)<a name='3179'></font>
<font color=#447700>!     QVATM,QCATM - cloud and water vapor mixing ratio<a name='3180'></font>
<font color=#447700>!                   at the first atm. level (kg/kg)<a name='3181'></font>
<font color=#447700>!     GLW, GSW - incoming longwave and absorbed shortwave<a name='3182'></font>
<font color=#447700>!                radiation at the surface (W/m^2)<a name='3183'></font>
<font color=#447700>!     EMISS,RNET - emissivity (0-1) of the ground surface and net<a name='3184'></font>
<font color=#447700>!                  radiation at the surface (W/m^2)<a name='3185'></font>
<font color=#447700>!     QKMS - exchange coefficient for water vapor in the<a name='3186'></font>
<font color=#447700>!              surface layer (m/s)<a name='3187'></font>
<font color=#447700>!     TKMS - exchange coefficient for heat in the surface<a name='3188'></font>
<font color=#447700>!              layer (m/s)<a name='3189'></font>
<font color=#447700>!     PC - plant coefficient (resistance) (0-1)<a name='3190'></font>
<font color=#447700>!     RHO - density of atmosphere near surface (kg/m^3)<a name='3191'></font>
<font color=#447700>!     VEGFRAC - greeness fraction (0-1)<a name='3192'></font>
<font color=#447700>!     RHOCS - volumetric heat capacity of dry soil (J/m^3/K)<a name='3193'></font>
<font color=#447700>!     DQM, QMIN - porosity minus residual soil moisture QMIN (m^3/m^3)<a name='3194'></font>
<font color=#447700>!     REF, WILT - field capacity soil moisture and the<a name='3195'></font>
<font color=#447700>!                 wilting point (m^3/m^3)<a name='3196'></font>
<font color=#447700>!     PSIS - matrix potential at saturation (m)<a name='3197'></font>
<font color=#447700>!     BCLH - exponent for Clapp-Hornberger parameterization<a name='3198'></font>
<font color=#447700>!     KSAT - saturated hydraulic conductivity (m/s)<a name='3199'></font>
<font color=#447700>!     SAT - maximum value of water intercepted by canopy (m)<a name='3200'></font>
<font color=#447700>!     CN - exponent for calculation of canopy water<a name='3201'></font>
<font color=#447700>!     ZSMAIN - main levels in soil (m)<a name='3202'></font>
<font color=#447700>!     ZSHALF - middle of the soil layers (m)<a name='3203'></font>
<font color=#447700>!     DTDZS,DTDZS2 - dt/(2.*dzshalf*dzmain) and dt/dzshalf in soil<a name='3204'></font>
<font color=#447700>!     TBQ - table to define saturated mixing ration<a name='3205'></font>
<font color=#447700>!           of water vapor for given temperature and pressure<a name='3206'></font>
<font color=#447700>!     ilnb - number of layers in snow<a name='3207'></font>
<font color=#447700>!     rsm - liquid water inside snow pack (m)<a name='3208'></font>
<font color=#447700>!     SOILMOIS,TSO - soil moisture (m^3/m^3) and temperature (K)<a name='3209'></font>
<font color=#447700>!     DEW -  dew in (kg/m^2 s)<a name='3210'></font>
<font color=#447700>!     SOILT - skin temperature (K)<a name='3211'></font>
<font color=#447700>!     SOILT1 - snow temperature at 7.5 cm depth (K)<a name='3212'></font>
<font color=#447700>!     TSNAV - average temperature of snow pack (C)<a name='3213'></font>
<font color=#447700>!     QSG,QVG,QCG - saturated mixing ratio, mixing ratio of<a name='3214'></font>
<font color=#447700>!                   water vapor and cloud at the ground<a name='3215'></font>
<font color=#447700>!                   surface, respectively (kg/kg)<a name='3216'></font>
<font color=#447700>!     EDIR1, EC1, ETT1, EETA - direct evaporation, evaporation of<a name='3217'></font>
<font color=#447700>!            canopy water, transpiration (kg m-2 s-1) and total<a name='3218'></font>
<font color=#447700>!            evaporation in (m s-1).<a name='3219'></font>
<font color=#447700>!     QFX, HFX - latent and sensible heat fluxes (W/m^2)<a name='3220'></font>
<font color=#447700>!     S - soil heat flux in the top layer (W/m^2)<a name='3221'></font>
<font color=#447700>!     SUBLIM - snow sublimation (kg/m^2/s)<a name='3222'></font>
<font color=#447700>!     RUNOFF1 - surface runoff (m/s)<a name='3223'></font>
<font color=#447700>!     RUNOFF2 - underground runoff (m)<a name='3224'></font>
<font color=#447700>!     MAVAIL - moisture availability in the top soil layer (0-1)<a name='3225'></font>
<font color=#447700>!     SOILICE - content of soil ice in soil layers (m^3/m^3)<a name='3226'></font>
<font color=#447700>!     SOILIQW - lliquid water in soil layers (m^3/m^3)<a name='3227'></font>
<font color=#447700>!     INFILTRP - infiltration flux from the top of soil domain (m/s)<a name='3228'></font>
<font color=#447700>!     XINET - net long-wave radiation (W/m^2)<a name='3229'></font>
<font color=#447700>!<a name='3230'></font>
<font color=#447700>!*******************************************************************<a name='3231'></font>
<a name='3232'>
        IMPLICIT NONE<a name='3233'>
<font color=#447700>!-------------------------------------------------------------------<a name='3234'></font>
<font color=#447700>!--- input variables<a name='3235'></font>
<a name='3236'>
   INTEGER,  INTENT(IN   )   ::  nroot,ktau,nzs     ,            &amp;<a name='3237'>
                                 nddzs                         <font color=#447700>!nddzs=2*(nzs-2)<a name='3238'></font>
   INTEGER,  INTENT(IN   )   ::  i,j,isoil<a name='3239'>
<a name='3240'>
   REAL,     INTENT(IN   )   ::  DELT,CONFLX,PRCPMS            , &amp;<a name='3241'>
                                 RAINF,NEWSNOW,RHONEWSN,         &amp;<a name='3242'>
                                 SNHEI_CRIT,meltfactor<a name='3243'>
<a name='3244'>
   LOGICAL,    INTENT(IN   )    ::     myj<a name='3245'>
<a name='3246'>
<font color=#447700>!--- 3-D Atmospheric variables<a name='3247'></font>
   REAL,                                                         &amp;<a name='3248'>
            INTENT(IN   )    ::                            PATM, &amp;<a name='3249'>
                                                          QVATM, &amp;<a name='3250'>
                                                          QCATM<a name='3251'>
<font color=#447700>!--- 2-D variables<a name='3252'></font>
   REAL                                                        , &amp;<a name='3253'>
            INTENT(IN   )    ::                             GLW, &amp;<a name='3254'>
                                                            GSW, &amp;<a name='3255'>
                                                          GSWin, &amp;<a name='3256'>
                                                            RHO, &amp;<a name='3257'>
                                                             PC, &amp;<a name='3258'>
                                                        VEGFRAC, &amp;<a name='3259'>
                                                            lai, &amp;<a name='3260'>
                                                       infwater, &amp;<a name='3261'>
                                                           QKMS, &amp;<a name='3262'>
                                                           TKMS<a name='3263'>
<a name='3264'>
   INTEGER,  INTENT(IN   )   ::                          IVGTYP<a name='3265'>
<font color=#447700>!--- soil properties<a name='3266'></font>
   REAL                                                        , &amp;<a name='3267'>
            INTENT(IN   )    ::                           RHOCS, &amp;<a name='3268'>
                                                           BCLH, &amp;<a name='3269'>
                                                            DQM, &amp;<a name='3270'>
                                                           KSAT, &amp;<a name='3271'>
                                                           PSIS, &amp;<a name='3272'>
                                                           QMIN, &amp;<a name='3273'>
                                                          QWRTZ, &amp;<a name='3274'>
                                                            REF, &amp;<a name='3275'>
                                                            SAT, &amp;<a name='3276'>
                                                           WILT<a name='3277'>
<a name='3278'>
   REAL,     INTENT(IN   )   ::                              CN, &amp;<a name='3279'>
                                                             CW, &amp;<a name='3280'>
                                                            XLV, &amp;<a name='3281'>
                                                           G0_P, &amp; <a name='3282'>
                                                         KQWRTZ, &amp;<a name='3283'>
                                                           KICE, &amp;<a name='3284'>
                                                            KWT <a name='3285'>
<a name='3286'>
<a name='3287'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::            ZSMAIN, &amp;<a name='3288'>
                                                         ZSHALF, &amp;<a name='3289'>
                                                         DTDZS2<a name='3290'>
<a name='3291'>
   REAL,     DIMENSION(1:NDDZS), INTENT(IN)  ::           DTDZS<a name='3292'>
<a name='3293'>
   REAL,     DIMENSION(1:5001), INTENT(IN)  ::              TBQ<a name='3294'>
<a name='3295'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::          rstochcol<a name='3296'>
   REAL,     DIMENSION(1:NZS), INTENT(INOUT) ::     fieldcol_sf<a name='3297'>
<a name='3298'>
<font color=#447700>!--- input/output variables<a name='3299'></font>
<font color=#447700>!-------- 3-d soil moisture and temperature<a name='3300'></font>
   REAL,     DIMENSION(  1:nzs )                               , &amp;<a name='3301'>
             INTENT(INOUT)   ::                             TSO, &amp;<a name='3302'>
                                                       SOILMOIS, &amp;<a name='3303'>
                                                       SMFRKEEP<a name='3304'>
<a name='3305'>
   REAL,  DIMENSION( 1:nzs )                                   , &amp;<a name='3306'>
             INTENT(INOUT)   ::                          KEEPFR<a name='3307'>
<a name='3308'>
<a name='3309'>
   INTEGER,  INTENT(INOUT)    ::                           ILAND<a name='3310'>
<a name='3311'>
<a name='3312'>
<font color=#447700>!-------- 2-d variables<a name='3313'></font>
   REAL                                                        , &amp;<a name='3314'>
             INTENT(INOUT)   ::                             DEW, &amp;<a name='3315'>
                                                            CST, &amp;<a name='3316'>
                                                           DRIP, &amp;<a name='3317'>
                                                          EDIR1, &amp;<a name='3318'>
                                                            EC1, &amp;<a name='3319'>
                                                           ETT1, &amp;<a name='3320'>
                                                           EETA, &amp;<a name='3321'>
                                                          RHOSN, &amp;<a name='3322'>
                                                         SUBLIM, &amp;<a name='3323'>
                                                          PRCPL, &amp;<a name='3324'>
                                                            ALB, &amp;<a name='3325'>
                                                          EMISS, &amp;<a name='3326'>
                                                            ZNT, &amp;<a name='3327'>
                                                         MAVAIL, &amp;<a name='3328'>
                                                            QVG, &amp;<a name='3329'>
                                                            QSG, &amp;<a name='3330'>
                                                            QCG, &amp;<a name='3331'>
                                                            QFX, &amp;<a name='3332'>
                                                            HFX, &amp;<a name='3333'>
                                                              S, &amp;<a name='3334'>
                                                        RUNOFF1, &amp;<a name='3335'>
                                                        RUNOFF2, &amp;<a name='3336'>
                                                           SNWE, &amp;<a name='3337'>
                                                          SNHEI, &amp;<a name='3338'>
                                                          SMELT, &amp;<a name='3339'>
                                                           SNOM, &amp;<a name='3340'>
                                                           SNOH, &amp;<a name='3341'>
                                                          SNFLX, &amp;<a name='3342'>
                                                          SOILT, &amp;<a name='3343'>
                                                         SOILT1, &amp;<a name='3344'>
                                                       SNOWFRAC, &amp;<a name='3345'>
                                                          TSNAV<a name='3346'>
<a name='3347'>
   INTEGER, INTENT(INOUT)    ::                            ILNB<a name='3348'>
<a name='3349'>
<font color=#447700>!-------- 1-d variables<a name='3350'></font>
   REAL,     DIMENSION(1:NZS), INTENT(OUT)  ::          SOILICE, &amp;<a name='3351'>
                                                        SOILIQW<a name='3352'>
<a name='3353'>
   REAL,     INTENT(OUT)                    ::              RSM, &amp;<a name='3354'>
                                                      SNWEPRINT, &amp;<a name='3355'>
                                                     SNHEIPRINT<a name='3356'>
   INTEGER,  INTENT(IN)                    ::       spp_lsm <a name='3357'>
<font color=#447700>!--- Local variables<a name='3358'></font>
<a name='3359'>
<a name='3360'>
   INTEGER ::  nzs1,nzs2,k<a name='3361'>
<a name='3362'>
   REAL    ::  INFILTRP, TRANSUM                               , &amp;<a name='3363'>
               SNTH, NEWSN                                     , &amp;<a name='3364'>
               TABS, T3, UPFLUX, XINET                         , &amp;<a name='3365'>
               BETA, SNWEPR,EPDT,PP<a name='3366'>
   REAL    ::  CP,rovcp,G0,LV,xlvm,STBOLT,xlmelt,dzstop        , &amp;<a name='3367'>
               can,epot,fac,fltot,ft,fq,hft                    , &amp;<a name='3368'>
               q1,ras,rhoice,sph                               , &amp;<a name='3369'>
               trans,zn,ci,cvw,tln,tavln,pi                    , &amp;<a name='3370'>
               DD1,CMC2MS,DRYCAN,WETCAN                        , &amp;<a name='3371'>
               INFMAX,RIW,DELTSN,H,UMVEG<a name='3372'>
<a name='3373'>
   REAL,     DIMENSION(1:NZS)  ::  transp,cap,diffu,hydro      , &amp;<a name='3374'>
                                   thdif,tranf,tav,soilmoism   , &amp;<a name='3375'>
                                   soilicem,soiliqwm,detal     , &amp;<a name='3376'>
                                   fwsat,lwsat,told,smold<a name='3377'>
   REAL                        ::  soiltold, qgold<a name='3378'>
<a name='3379'>
   REAL                        ::  RNET, X<a name='3380'>
<a name='3381'>
<font color=#447700>!-----------------------------------------------------------------<a name='3382'></font>
<a name='3383'>
        cvw=cw<a name='3384'>
        XLMELT=3.35E+5<a name='3385'>
<font color=#447700>!-- heat of water vapor sublimation<a name='3386'></font>
        XLVm=XLV+XLMELT<a name='3387'>
<font color=#447700>!        STBOLT=5.670151E-8<a name='3388'></font>
<a name='3389'>
<font color=#447700>!--- SNOW flag -- ISICE<a name='3390'></font>
<font color=#447700>!         ILAND=isice<a name='3391'></font>
<a name='3392'>
<font color=#447700>!--- DELTSN - is the threshold for splitting the snow layer into 2 layers.<a name='3393'></font>
<font color=#447700>!--- With snow density 400 kg/m^3, this threshold is equal to 7.5 cm,<a name='3394'></font>
<font color=#447700>!--- equivalent to 0.03 m SNWE. For other snow densities the threshold is<a name='3395'></font>
<font color=#447700>!--- computed using SNWE=0.03 m and current snow density.<a name='3396'></font>
<font color=#447700>!--- SNTH - the threshold below which the snow layer is combined with<a name='3397'></font>
<font color=#447700>!--- the top soil layer. SNTH is computed using snwe=0.016 m, and<a name='3398'></font>
<font color=#447700>!--- equals 4 cm for snow density 400 kg/m^3.<a name='3399'></font>
<a name='3400'>
<font color=#447700>!save SOILT and QVG<a name='3401'></font>
       soiltold=soilt<a name='3402'>
       qgold=qvg<a name='3403'>
<a name='3404'>
       x=0.<a name='3405'>
<a name='3406'>
<font color=#447700>! increase thinkness of top snow layer from 3 cm SWE to 5 cm SWE<a name='3407'></font>
<font color=#447700>!           DELTSN=5.*SNHEI_CRIT<a name='3408'></font>
<font color=#447700>!           snth=0.4*SNHEI_CRIT<a name='3409'></font>
<a name='3410'>
           DELTSN=0.05*1.e3/rhosn<a name='3411'>
           snth=0.01*1.e3/rhosn<a name='3412'>
<font color=#447700>!           snth=0.01601*1.e3/rhosn<a name='3413'></font>
<a name='3414'>
<font color=#447700>!   if(i.eq.442.and.j.eq.260) then<a name='3415'></font>
<font color=#447700>!      print *,'deltsn,snhei,snth',i,j,deltsn,snhei,snth<a name='3416'></font>
<font color=#447700>!    ENDIF<a name='3417'></font>
<a name='3418'>
<font color=#447700>! For 2-layer snow model when the snow depth is marginally higher than DELTSN,<a name='3419'></font>
<font color=#447700>! reset DELTSN to half of snow depth.<a name='3420'></font>
        IF(SNHEI.GE.DELTSN+SNTH) THEN<a name='3421'>
          if(snhei-deltsn-snth.lt.snth) deltsn=0.5*(snhei-snth)<a name='3422'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3423'>
      print *,'DELTSN is changed,deltsn,snhei,snth',i,j,deltsn,snhei,snth<a name='3424'>
    ENDIF<a name='3425'>
        ENDIF <a name='3426'>
<a name='3427'>
        RHOICE=900.<a name='3428'>
        CI=RHOICE*2100.<a name='3429'>
        RAS=RHO*1.E-3<a name='3430'>
        RIW=rhoice*1.e-3<a name='3431'>
<font color=#447700>!        MAVAIL=1.<a name='3432'></font>
        RSM=0.<a name='3433'>
<a name='3434'>
        DO K=1,NZS<a name='3435'>
          TRANSP     (K)=0.<a name='3436'>
          soilmoism  (k)=0.<a name='3437'>
          soiliqwm   (k)=0.<a name='3438'>
          soilice    (k)=0.<a name='3439'>
          soilicem   (k)=0.<a name='3440'>
          lwsat      (k)=0.<a name='3441'>
          fwsat      (k)=0.<a name='3442'>
          tav        (k)=0.<a name='3443'>
          cap        (k)=0.<a name='3444'>
          diffu      (k)=0.<a name='3445'>
          hydro      (k)=0.<a name='3446'>
          thdif      (k)=0.  <a name='3447'>
          tranf      (k)=0.<a name='3448'>
          detal      (k)=0.<a name='3449'>
          told       (k)=0.<a name='3450'>
          smold      (k)=0. <a name='3451'>
        ENDDO<a name='3452'>
<a name='3453'>
        snweprint=0.<a name='3454'>
        snheiprint=0.<a name='3455'>
        prcpl=prcpms<a name='3456'>
<a name='3457'>
<font color=#447700>!*** DELTSN is the depth of the top layer of snow where<a name='3458'></font>
<font color=#447700>!*** there is a temperature gradient, the rest of the snow layer<a name='3459'></font>
<font color=#447700>!*** is considered to have constant temperature<a name='3460'></font>
<a name='3461'>
<a name='3462'>
          NZS1=NZS-1<a name='3463'>
          NZS2=NZS-2<a name='3464'>
        DZSTOP=1./(zsmain(2)-zsmain(1))<a name='3465'>
<a name='3466'>
<font color=#447700>!----- THE CALCULATION OF THERMAL DIFFUSIVITY, DIFFUSIONAL AND ---<a name='3467'></font>
<font color=#447700>!----- HYDRAULIC CONDUCTIVITY (SMIRNOVA ET AL. 1996, EQ.2,5,6) ---<a name='3468'></font>
<font color=#447700>!tgs - the following loop is added to define the amount of frozen<a name='3469'></font>
<font color=#447700>!tgs - water in soil if there is any<a name='3470'></font>
         DO K=1,NZS<a name='3471'>
<a name='3472'>
         tln=log(tso(k)/273.15)<a name='3473'>
         if(tln.lt.0.) then<a name='3474'>
           soiliqw(k)=(dqm+qmin)*(XLMELT*                          &amp;<a name='3475'>
         (tso(k)-273.15)/tso(k)/9.81/psis)                         &amp;<a name='3476'>
          **(-1./bclh)-qmin<a name='3477'>
           soiliqw(k)=max(0.,soiliqw(k))<a name='3478'>
           soiliqw(k)=min(soiliqw(k),soilmois(k))<a name='3479'>
           soilice(k)=(soilmois(k)-soiliqw(k))/riw<a name='3480'>
<a name='3481'>
<font color=#447700>!---- melting and freezing is balanced, soil ice cannot increase<a name='3482'></font>
       if(keepfr(k).eq.1.) then<a name='3483'>
           soilice(k)=min(soilice(k),smfrkeep(k))<a name='3484'>
           soiliqw(k)=max(0.,soilmois(k)-soilice(k)*rhoice*1.e-3)<a name='3485'>
       endif<a name='3486'>
<a name='3487'>
         else<a name='3488'>
           soilice(k)=0.<a name='3489'>
           soiliqw(k)=soilmois(k)<a name='3490'>
         endif<a name='3491'>
<a name='3492'>
          ENDDO<a name='3493'>
<a name='3494'>
          DO K=1,NZS1<a name='3495'>
<a name='3496'>
         tav(k)=0.5*(tso(k)+tso(k+1))<a name='3497'>
         soilmoism(k)=0.5*(soilmois(k)+soilmois(k+1))<a name='3498'>
         tavln=log(tav(k)/273.15)<a name='3499'>
<a name='3500'>
         if(tavln.lt.0.) then<a name='3501'>
           soiliqwm(k)=(dqm+qmin)*(XLMELT*                         &amp;<a name='3502'>
         (tav(k)-273.15)/tav(k)/9.81/psis)                         &amp;<a name='3503'>
          **(-1./bclh)-qmin<a name='3504'>
           fwsat(k)=dqm-soiliqwm(k)<a name='3505'>
           lwsat(k)=soiliqwm(k)+qmin<a name='3506'>
           soiliqwm(k)=max(0.,soiliqwm(k))<a name='3507'>
           soiliqwm(k)=min(soiliqwm(k), soilmoism(k))<a name='3508'>
           soilicem(k)=(soilmoism(k)-soiliqwm(k))/riw<a name='3509'>
<font color=#447700>!---- melting and freezing is balanced, soil ice cannot increase<a name='3510'></font>
       if(keepfr(k).eq.1.) then<a name='3511'>
           soilicem(k)=min(soilicem(k),                            &amp;<a name='3512'>
                    0.5*(smfrkeep(k)+smfrkeep(k+1)))<a name='3513'>
           soiliqwm(k)=max(0.,soilmoism(k)-soilicem(k)*riw)<a name='3514'>
           fwsat(k)=dqm-soiliqwm(k)<a name='3515'>
           lwsat(k)=soiliqwm(k)+qmin<a name='3516'>
       endif<a name='3517'>
<a name='3518'>
         else<a name='3519'>
           soilicem(k)=0.<a name='3520'>
           soiliqwm(k)=soilmoism(k)<a name='3521'>
           lwsat(k)=dqm+qmin<a name='3522'>
           fwsat(k)=0.<a name='3523'>
<a name='3524'>
         endif<a name='3525'>
          ENDDO<a name='3526'>
<a name='3527'>
          do k=1,nzs<a name='3528'>
           if(soilice(k).gt.0.) then<a name='3529'>
             smfrkeep(k)=soilice(k)<a name='3530'>
           else<a name='3531'>
             smfrkeep(k)=soilmois(k)/riw<a name='3532'>
           endif<a name='3533'>
          enddo<a name='3534'>
<a name='3535'>
<font color=#447700>!******************************************************************<a name='3536'></font>
<font color=#447700>! SOILPROP computes thermal diffusivity, and diffusional and<a name='3537'></font>
<font color=#447700>!          hydraulic condeuctivities<a name='3538'></font>
<font color=#447700>!******************************************************************<a name='3539'></font>
          CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILPROP'>SOILPROP</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILPROP_3">(spp_lsm,rstochcol,fieldcol_sf,      &amp;<a name='3540'>
<font color=#447700>!--- input variables<a name='3541'></font>
               nzs,fwsat,lwsat,tav,keepfr,                       &amp;<a name='3542'>
               soilmois,soiliqw,soilice,                         &amp;<a name='3543'>
               soilmoism,soiliqwm,soilicem,                      &amp;<a name='3544'>
<font color=#447700>!--- soil fixed fields<a name='3545'></font>
               QWRTZ,rhocs,dqm,qmin,psis,bclh,ksat,              &amp; <a name='3546'>
<font color=#447700>!--- constants<a name='3547'></font>
               riw,xlmelt,CP,G0_P,cvw,ci,                        &amp;<a name='3548'>
               kqwrtz,kice,kwt,                                  &amp;<a name='3549'>
<font color=#447700>!--- output variables<a name='3550'></font>
               thdif,diffu,hydro,cap)<a name='3551'>
<a name='3552'>
<font color=#447700>!******************************************************************** <a name='3553'></font>
<font color=#447700>!--- CALCULATION OF CANOPY WATER (Smirnova et al., 1996, EQ.16) AND DEW <a name='3554'></font>
 <a name='3555'>
<font color=#447700>!        DRIP=0.<a name='3556'></font>
        SMELT=0.<a name='3557'>
<font color=#447700>!        DD1=0.<a name='3558'></font>
        H=1.<a name='3559'>
<a name='3560'>
        FQ=QKMS<a name='3561'>
<a name='3562'>
<a name='3563'>
<font color=#447700>!--- If vegfrac.ne.0. then part of falling snow can be<a name='3564'></font>
<font color=#447700>!--- intercepted by the canopy. <a name='3565'></font>
<a name='3566'>
        DEW=0.<a name='3567'>
        UMVEG=1.-vegfrac<a name='3568'>
        EPOT = -FQ*(QVATM-QSG) <a name='3569'>
<a name='3570'>
<font color=#447700>!     IF(vegfrac.EQ.0.) then<a name='3571'></font>
<font color=#447700>!           cst=0.<a name='3572'></font>
<font color=#447700>!           drip=0.<a name='3573'></font>
<font color=#447700>!      ELSE<a name='3574'></font>
<font color=#447700>!       IF(EPOT.GE.0.) THEN<a name='3575'></font>
<font color=#447700>!!         DD1=CST+ NEWSNOW*RHOnewSN*1.E-3  &amp;<a name='3576'></font>
<font color=#447700>!!              -DELT*RAS*EPOT*(CST/SAT)**CN<a name='3577'></font>
<font color=#447700>!    IF ( 1==2 ) THEN<a name='3578'></font>
<font color=#447700>!       print *,'DD1=',dd1,cst,sat<a name='3579'></font>
<font color=#447700>!    ENDIF<a name='3580'></font>
<font color=#447700>!        ELSE<a name='3581'></font>
<a name='3582'>
<font color=#447700>!! Sublimation<a name='3583'></font>
<font color=#447700>!         DEW = - EPOT<a name='3584'></font>
<font color=#447700>!!         DD1=CST+(NEWSNOW*RHOnewSN*1.E-3+delt*DEW*RAS)<a name='3585'></font>
<font color=#447700>!    IF ( 1==2 ) THEN<a name='3586'></font>
<font color=#447700>!       print *,'Sublimation DD1=',dd1,cst,sat<a name='3587'></font>
<font color=#447700>!    ENDIF<a name='3588'></font>
<font color=#447700>!       ENDIF<a name='3589'></font>
<a name='3590'>
<font color=#447700>!          DD1=CST+NEWSNOW*RHOnewSN*1.E-3<a name='3591'></font>
<a name='3592'>
<font color=#447700>!!        IF(DD1.LT.0.) DD1=0.<a name='3593'></font>
<font color=#447700>!      IF (vegfrac.GT.0.) THEN<a name='3594'></font>
<font color=#447700>!          CST=DD1<a name='3595'></font>
<font color=#447700>!        IF(CST.GT.SAT) THEN<a name='3596'></font>
<font color=#447700>!          CST=SAT<a name='3597'></font>
<font color=#447700>!          DRIP=DD1-SAT<a name='3598'></font>
<font color=#447700>!        ENDIF<a name='3599'></font>
<font color=#447700>!      ENDIF<a name='3600'></font>
<a name='3601'>
<a name='3602'>
<font color=#447700>!--- With vegetation part of NEWSNOW can be intercepted by canopy until<a name='3603'></font>
<font color=#447700>!--- the saturation is reached. After the canopy saturation is reached<a name='3604'></font>
<font color=#447700>!--- DRIP in the solid form will be added to SNOW cover.<a name='3605'></font>
<a name='3606'>
<font color=#447700>!   SNWE=SNWE-vegfrac*NEWSNOW*RHOnewSN*1.E-3                      &amp;<a name='3607'></font>
<font color=#447700>!   SNWE=SNHEI*RHOSN*1.e-3-vegfrac*NEWSNOW*RHOnewSN*1.E-3                      &amp;<a name='3608'></font>
<font color=#447700>!                  + DRIP                                         <a name='3609'></font>
<a name='3610'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3611'>
      print *,'SNWE after subtracting intercepted snow - snwe=',snwe,vegfrac,cst<a name='3612'>
    ENDIF<a name='3613'>
<a name='3614'>
<font color=#447700>!       ENDIF  ! vegfrac=0.<a name='3615'></font>
 <a name='3616'>
<font color=#447700>!        DRIP=0.<a name='3617'></font>
<font color=#447700>!        SNHEI=SNWE*1.e3/RHOSN<a name='3618'></font>
          SNWEPR=SNWE<a name='3619'>
<a name='3620'>
<font color=#447700>!  check if all snow can evaporate during DT<a name='3621'></font>
         BETA=1.<a name='3622'>
         EPDT = EPOT * RAS *DELT*UMVEG<a name='3623'>
         IF(EPDT.gt.0. .and. SNWEPR.LE.EPDT) THEN <a name='3624'>
            BETA=SNWEPR/max(1.e-8,EPDT)<a name='3625'>
            SNWE=0.<a name='3626'>
         ENDIF<a name='3627'>
<a name='3628'>
          WETCAN=min(0.25,(CST/SAT)**CN)<a name='3629'>
<font color=#447700>!          if(lai &gt; 1.) wetcan=wetcan/lai<a name='3630'></font>
          DRYCAN=1.-WETCAN<a name='3631'>
<a name='3632'>
<font color=#447700>!**************************************************************<a name='3633'></font>
<font color=#447700>!  TRANSF computes transpiration function<a name='3634'></font>
<font color=#447700>!**************************************************************<a name='3635'></font>
           CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#TRANSF'>TRANSF</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRANSF_2">(i,j,                                   &amp;<a name='3636'>
<font color=#447700>!--- input variables<a name='3637'></font>
              nzs,nroot,soiliqw,tabs,lai,gswin,               &amp;<a name='3638'>
<font color=#447700>!--- soil fixed fields<a name='3639'></font>
              dqm,qmin,ref,wilt,zshalf,pc,iland,              &amp; <a name='3640'>
<font color=#447700>!--- output variables<a name='3641'></font>
              tranf,transum)<a name='3642'>
<a name='3643'>
<font color=#447700>!--- Save soil temp and moisture from the beginning of time step<a name='3644'></font>
          do k=1,nzs<a name='3645'>
           told(k)=tso(k)<a name='3646'>
           smold(k)=soilmois(k)<a name='3647'>
          enddo<a name='3648'>
<a name='3649'>
<font color=#447700>!**************************************************************<a name='3650'></font>
<font color=#447700>! SNOWTEMP solves heat budget and diffusion eqn. in soil<a name='3651'></font>
<font color=#447700>!**************************************************************<a name='3652'></font>
<a name='3653'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3654'>
print *, 'TSO before calling SNOWTEMP: ', tso<a name='3655'>
    ENDIF<a name='3656'>
        CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWTEMP'>SNOWTEMP</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWTEMP_1">(                                        &amp;<a name='3657'>
<font color=#447700>!--- input variables<a name='3658'></font>
             i,j,iland,isoil,                                 &amp;<a name='3659'>
             delt,ktau,conflx,nzs,nddzs,nroot,                &amp;<a name='3660'>
             snwe,snwepr,snhei,newsnow,snowfrac,              &amp;<a name='3661'>
             beta,deltsn,snth,rhosn,rhonewsn,meltfactor,      &amp;  <font color=#447700>! add meltfactor<a name='3662'></font>
             PRCPMS,RAINF,                                    &amp;<a name='3663'>
             PATM,TABS,QVATM,QCATM,                           &amp;<a name='3664'>
             GLW,GSW,EMISS,RNET,                              &amp;<a name='3665'>
             QKMS,TKMS,PC,rho,vegfrac,                        &amp;<a name='3666'>
             thdif,cap,drycan,wetcan,cst,                     &amp;<a name='3667'>
             tranf,transum,dew,mavail,                        &amp;<a name='3668'>
<font color=#447700>!--- soil fixed fields<a name='3669'></font>
             dqm,qmin,psis,bclh,                              &amp;<a name='3670'>
             zsmain,zshalf,DTDZS,tbq,                         &amp;<a name='3671'>
<font color=#447700>!--- constants<a name='3672'></font>
             xlvm,CP,rovcp,G0_P,cvw,stbolt,                   &amp;<a name='3673'>
<font color=#447700>!--- output variables<a name='3674'></font>
             snweprint,snheiprint,rsm,                        &amp;<a name='3675'>
             tso,soilt,soilt1,tsnav,qvg,qsg,qcg,              &amp;<a name='3676'>
             smelt,snoh,snflx,s,ilnb,x)<a name='3677'>
<a name='3678'>
<font color=#447700>!************************************************************************<a name='3679'></font>
<font color=#447700>!--- RECALCULATION OF DEW USING NEW VALUE OF QSG OR TRANSP IF NO DEW<a name='3680'></font>
         DEW=0.<a name='3681'>
         ETT1=0.<a name='3682'>
         PP=PATM*1.E3<a name='3683'>
         EPOT = -FQ*(QVATM-QSG)<a name='3684'>
       IF(EPOT.GT.0.) THEN<a name='3685'>
<font color=#447700>! Evaporation<a name='3686'></font>
          DO K=1,NROOT<a name='3687'>
            TRANSP(K)=vegfrac*RAS*FQ*(QVATM-QSG)              &amp;<a name='3688'>
                     *tranf(K)*DRYCAN/zshalf(NROOT+1)<a name='3689'>
<font color=#447700>!           IF(TRANSP(K).GT.0.) TRANSP(K)=0.<a name='3690'></font>
            ETT1=ETT1-TRANSP(K)<a name='3691'>
          ENDDO<a name='3692'>
          DO k=nroot+1,nzs<a name='3693'>
            transp(k)=0.<a name='3694'>
          enddo<a name='3695'>
<a name='3696'>
        ELSE<a name='3697'>
<font color=#447700>! Sublimation<a name='3698'></font>
          DEW=-EPOT<a name='3699'>
          DO K=1,NZS<a name='3700'>
            TRANSP(K)=0.<a name='3701'>
          ENDDO<a name='3702'>
        ETT1=0.<a name='3703'>
        ENDIF<a name='3704'>
<a name='3705'>
<font color=#447700>!-- recalculating of frozen water in soil<a name='3706'></font>
         DO K=1,NZS<a name='3707'>
         tln=log(tso(k)/273.15)<a name='3708'>
         if(tln.lt.0.) then<a name='3709'>
           soiliqw(k)=(dqm+qmin)*(XLMELT*                    &amp;<a name='3710'>
         (tso(k)-273.15)/tso(k)/9.81/psis)                   &amp;<a name='3711'>
          **(-1./bclh)-qmin<a name='3712'>
           soiliqw(k)=max(0.,soiliqw(k))<a name='3713'>
           soiliqw(k)=min(soiliqw(k),soilmois(k))<a name='3714'>
           soilice(k)=(soilmois(k)-soiliqw(k))/riw<a name='3715'>
<font color=#447700>!---- melting and freezing is balanced, soil ice cannot increase<a name='3716'></font>
       if(keepfr(k).eq.1.) then<a name='3717'>
           soilice(k)=min(soilice(k),smfrkeep(k))<a name='3718'>
           soiliqw(k)=max(0.,soilmois(k)-soilice(k)*riw)<a name='3719'>
       endif<a name='3720'>
<a name='3721'>
         else<a name='3722'>
           soilice(k)=0.<a name='3723'>
           soiliqw(k)=soilmois(k)<a name='3724'>
         endif<a name='3725'>
         ENDDO<a name='3726'>
<a name='3727'>
<font color=#447700>!*************************************************************************<a name='3728'></font>
<font color=#447700>!--- TQCAN FOR SOLUTION OF MOISTURE BALANCE (Smirnova et al. 1996, EQ.22,28)<a name='3729'></font>
<font color=#447700>!    AND TSO,ETA PROFILES<a name='3730'></font>
<font color=#447700>!*************************************************************************<a name='3731'></font>
                CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILMOIST'>SOILMOIST</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILMOIST_2"> (                                   &amp;<a name='3732'>
<font color=#447700>!-- input<a name='3733'></font>
               delt,nzs,nddzs,DTDZS,DTDZS2,RIW,                    &amp;<a name='3734'>
               zsmain,zshalf,diffu,hydro,                          &amp;<a name='3735'>
               QSG,QVG,QCG,QCATM,QVATM,-INFWATER,                  &amp;<a name='3736'>
               QKMS,TRANSP,0.,                                     &amp;<a name='3737'>
               0.,SMELT,soilice,vegfrac,                           &amp;<a name='3738'>
               snowfrac,1.,                                        &amp;<a name='3739'>
<font color=#447700>!-- soil properties<a name='3740'></font>
               DQM,QMIN,REF,KSAT,RAS,INFMAX,                       &amp;<a name='3741'>
<font color=#447700>!-- output<a name='3742'></font>
               SOILMOIS,SOILIQW,MAVAIL,RUNOFF1,                    &amp;<a name='3743'>
               RUNOFF2,infiltrp) <a name='3744'>
 <a name='3745'>
<font color=#447700>!        endif<a name='3746'></font>
<a name='3747'>
<font color=#447700>!-- Restore land-use parameters if all snow is melted<a name='3748'></font>
         IF(SNHEI.EQ.0.)  then<a name='3749'>
          tsnav=soilt-273.15<a name='3750'>
         ENDIF<a name='3751'>
<a name='3752'>
<font color=#447700>! 21apr2009<a name='3753'></font>
<font color=#447700>! SNOM [mm] goes into the passed-in ACSNOM variable in the grid derived type<a name='3754'></font>
        SNOM=SNOM+SMELT*DELT*1.e3<a name='3755'>
<font color=#447700>!<a name='3756'></font>
<font color=#447700>!--- KEEPFR is 1 when the temperature and moisture in soil<a name='3757'></font>
<font color=#447700>!--- are both increasing. In this case soil ice should not<a name='3758'></font>
<font color=#447700>!--- be increasing according to the freezing curve.<a name='3759'></font>
<font color=#447700>!--- Some part of ice is melted, but additional water is<a name='3760'></font>
<font color=#447700>!--- getting frozen. Thus, only structure of frozen soil is<a name='3761'></font>
<font color=#447700>!--- changed, and phase changes are not affecting the heat<a name='3762'></font>
<font color=#447700>!--- transfer. This situation may happen when it rains on the<a name='3763'></font>
<font color=#447700>!--- frozen soil.<a name='3764'></font>
<a name='3765'>
        do k=1,nzs<a name='3766'>
       if (soilice(k).gt.0.) then<a name='3767'>
          if(tso(k).gt.told(k).and.soilmois(k).gt.smold(k)) then<a name='3768'>
              keepfr(k)=1.<a name='3769'>
          else<a name='3770'>
              keepfr(k)=0.<a name='3771'>
          endif<a name='3772'>
       endif<a name='3773'>
        enddo<a name='3774'>
<font color=#447700>!--- THE DIAGNOSTICS OF SURFACE FLUXES<a name='3775'></font>
<a name='3776'>
        T3      = STBOLT*SOILTold*SOILTold*SOILTold<a name='3777'>
        UPFLUX  = T3 *0.5*(SOILTold+SOILT)<a name='3778'>
        XINET   = EMISS*(GLW-UPFLUX)   <a name='3779'>
<font color=#447700>!        RNET    = GSW + XINET<a name='3780'></font>
        HFX=-TKMS*CP*RHO*(TABS-SOILT)                        &amp;<a name='3781'>
               *(P1000mb*0.00001/Patm)**ROVCP<a name='3782'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3783'>
      print *,'potential temp HFX',hfx<a name='3784'>
    ENDIF<a name='3785'>
        HFT=-TKMS*CP*RHO*(TABS-SOILT) <a name='3786'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3787'>
      print *,'abs temp HFX',hft<a name='3788'>
    ENDIF<a name='3789'>
        Q1 = - FQ*RAS* (QVATM - QSG)<a name='3790'>
        CMC2MS=0.<a name='3791'>
        IF (Q1.LT.0.) THEN<a name='3792'>
<font color=#447700>! ---  condensation<a name='3793'></font>
        EDIR1=0.<a name='3794'>
        EC1=0.<a name='3795'>
        ETT1=0.<a name='3796'>
<font color=#447700>! ---  condensation<a name='3797'></font>
     if(myj) then<a name='3798'>
<font color=#447700>!-- moisture flux for coupling with MYJ PBL<a name='3799'></font>
          EETA=-QKMS*RAS*(QVATM/(1.+QVATM) - QSG/(1.+QSG))*1.E3<a name='3800'>
          CST= CST-EETA*DELT*vegfrac<a name='3801'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3802'>
      print *,'MYJ EETA cond', EETA<a name='3803'>
    ENDIF<a name='3804'>
     else <font color=#447700>! myj<a name='3805'></font>
<font color=#447700>!-- actual moisture flux from RUC LSM<a name='3806'></font>
          DEW=QKMS*(QVATM-QSG)<a name='3807'>
          EETA= - RHO*DEW<a name='3808'>
          CST=CST+DELT*DEW*RAS * vegfrac<a name='3809'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3810'>
      print *,'RUC LSM EETA cond',EETA<a name='3811'>
    ENDIF<a name='3812'>
     endif <font color=#447700>! myj<a name='3813'></font>
          QFX= XLVm*EETA<a name='3814'>
        ELSE<a name='3815'>
<font color=#447700>! ---  evaporation<a name='3816'></font>
        EDIR1 = Q1*UMVEG *BETA<a name='3817'>
        CMC2MS=CST/DELT*RAS<a name='3818'>
        EC1 = Q1 * WETCAN * vegfrac<a name='3819'>
<a name='3820'>
        CST=max(0.,CST-EC1 * DELT)<a name='3821'>
<a name='3822'>
<font color=#447700>!     if(EC1 &gt; CMC2MS) then<a name='3823'></font>
<font color=#447700>!        EC1 = min(cmc2ms,ec1)<a name='3824'></font>
<font color=#447700>!        CST = 0.<a name='3825'></font>
<font color=#447700>!     endif<a name='3826'></font>
<a name='3827'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3828'>
     print*,'Q1,umveg,beta',Q1,umveg,beta<a name='3829'>
     print *,'wetcan,vegfrac',wetcan,vegfrac<a name='3830'>
     print *,'EC1,CMC2MS',EC1,CMC2MS<a name='3831'>
    ENDIF<a name='3832'>
<a name='3833'>
     if(myj) then<a name='3834'>
<font color=#447700>!-- moisture flux for coupling with MYJ PBL<a name='3835'></font>
        EETA=-(QKMS*RAS*(QVATM/(1.+QVATM) - QSG/(1.+QSG))*1.E3)*BETA<a name='3836'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3837'>
      print *,'MYJ EETA', EETA*XLVm,EETA<a name='3838'>
    ENDIF<a name='3839'>
     else <font color=#447700>! myj<a name='3840'></font>
<font color=#447700>! to convert from m s-1 to kg m-2 s-1: *rho water=1.e3************<a name='3841'></font>
<font color=#447700>!-- actual moisture flux from RUC LSM<a name='3842'></font>
        EETA = (EDIR1 + EC1 + ETT1)*1.E3<a name='3843'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3844'>
      print *,'RUC LSM EETA',EETA*XLVm,EETA<a name='3845'>
    ENDIF<a name='3846'>
     endif <font color=#447700>! myj<a name='3847'></font>
        QFX= XLVm * EETA<a name='3848'>
       ENDIF<a name='3849'>
        S=SNFLX<a name='3850'>
<font color=#447700>!        sublim=eeta<a name='3851'></font>
        sublim=EDIR1*1.E3<a name='3852'>
<font color=#447700>! Energy budget<a name='3853'></font>
        FLTOT=RNET-HFT-XLVm*EETA-S-SNOH-x<a name='3854'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='3855'>
       print *,'SNOWSOIL - FLTOT,RNET,HFT,QFX,S,SNOH,X=',FLTOT,RNET,HFT,XLVm*EETA,s,SNOH,X<a name='3856'>
       print *,'edir1,ec1,ett1,mavail,qkms,qvatm,qvg,qsg,vegfrac,beta',&amp;<a name='3857'>
                edir1,ec1,ett1,mavail,qkms,qvatm,qvg,qsg,vegfrac,beta<a name='3858'>
    ENDIF<a name='3859'>
<a name='3860'>
 222     CONTINUE<a name='3861'>
<a name='3862'>
 1123    FORMAT(I5,8F12.3)<a name='3863'>
 1133    FORMAT(I7,8E12.4)<a name='3864'>
  123   format(i6,f6.2,7f8.1)<a name='3865'>
 122    FORMAT(1X,2I3,6F8.1,F8.3,F8.2)<a name='3866'>
<a name='3867'>
<font color=#447700>!-------------------------------------------------------------------<a name='3868'></font>
   END SUBROUTINE SNOWSOIL<a name='3869'>
<font color=#447700>!-------------------------------------------------------------------<a name='3870'></font>
<a name='3871'>
<A NAME='SNOWSEAICE'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSEAICE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3872'>
           <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWSEAICE</font>(                               &amp; <A href='../../call_to/SNOWSEAICE.html' TARGET='index'>1</A>,<A href='../../call_from/SNOWSEAICE.html' TARGET='index'>3</A><a name='3873'>
            i,j,isoil,delt,ktau,conflx,nzs,nddzs,               &amp;<a name='3874'>
            meltfactor,rhonewsn,SNHEI_CRIT,                     &amp;  <font color=#447700>! new<a name='3875'></font>
            ILAND,PRCPMS,RAINF,NEWSNOW,snhei,SNWE,snowfrac,     &amp;<a name='3876'>
            RHOSN,PATM,QVATM,QCATM,                             &amp;<a name='3877'>
            GLW,GSW,EMISS,RNET,                                 &amp;<a name='3878'>
            QKMS,TKMS,RHO,myj,                                  &amp;<a name='3879'>
<font color=#447700>!--- sea ice parameters<a name='3880'></font>
            ALB,ZNT,                                            &amp;<a name='3881'>
            tice,rhosice,capice,thdifice,                       &amp;<a name='3882'>
            zsmain,zshalf,DTDZS,DTDZS2,tbq,                     &amp;<a name='3883'>
<font color=#447700>!--- constants<a name='3884'></font>
            xlv,CP,rovcp,cw,stbolt,tabs,                        &amp;<a name='3885'>
<font color=#447700>!--- output variables<a name='3886'></font>
            ilnb,snweprint,snheiprint,rsm,tso,                  &amp;<a name='3887'>
            dew,soilt,soilt1,tsnav,qvg,qsg,qcg,                 &amp;<a name='3888'>
            SMELT,SNOH,SNFLX,SNOM,eeta,                         &amp;<a name='3889'>
            qfx,hfx,s,sublim,prcpl,fltot                        &amp;<a name='3890'>
                                                                )<a name='3891'>
<font color=#447700>!***************************************************************<a name='3892'></font>
<font color=#447700>!   Solving energy budget for snow on sea ice and heat diffusion <a name='3893'></font>
<font color=#447700>!   eqns. in snow and sea ice<a name='3894'></font>
<font color=#447700>!***************************************************************<a name='3895'></font>
<a name='3896'>
<a name='3897'>
        IMPLICIT NONE<a name='3898'>
<font color=#447700>!-------------------------------------------------------------------<a name='3899'></font>
<font color=#447700>!--- input variables<a name='3900'></font>
<a name='3901'>
   INTEGER,  INTENT(IN   )   ::  ktau,nzs     ,                  &amp;<a name='3902'>
                                 nddzs                         <font color=#447700>!nddzs=2*(nzs-2)<a name='3903'></font>
   INTEGER,  INTENT(IN   )   ::  i,j,isoil<a name='3904'>
<a name='3905'>
   REAL,     INTENT(IN   )   ::  DELT,CONFLX,PRCPMS            , &amp;<a name='3906'>
                                 RAINF,NEWSNOW,RHONEWSN,         &amp;<a name='3907'>
                                 meltfactor, snhei_crit<a name='3908'>
   real                      ::  rhonewcsn<a name='3909'>
<a name='3910'>
   LOGICAL,  INTENT(IN   )   ::  myj<a name='3911'>
<font color=#447700>!--- 3-D Atmospheric variables<a name='3912'></font>
   REAL,                                                         &amp;<a name='3913'>
            INTENT(IN   )    ::                            PATM, &amp;<a name='3914'>
                                                          QVATM, &amp;<a name='3915'>
                                                          QCATM<a name='3916'>
<font color=#447700>!--- 2-D variables<a name='3917'></font>
   REAL                                                        , &amp;<a name='3918'>
            INTENT(IN   )    ::                             GLW, &amp;<a name='3919'>
                                                            GSW, &amp;<a name='3920'>
                                                            RHO, &amp;<a name='3921'>
                                                           QKMS, &amp;<a name='3922'>
                                                           TKMS<a name='3923'>
<a name='3924'>
<font color=#447700>!--- sea ice properties<a name='3925'></font>
   REAL,     DIMENSION(1:NZS)                                  , &amp;<a name='3926'>
            INTENT(IN   )    ::                                  &amp;<a name='3927'>
                                                           tice, &amp;<a name='3928'>
                                                        rhosice, &amp;<a name='3929'>
                                                         capice, &amp;<a name='3930'>
                                                       thdifice<a name='3931'>
<a name='3932'>
   REAL,     INTENT(IN   )   ::                                  &amp;<a name='3933'>
                                                             CW, &amp;<a name='3934'>
                                                            XLV<a name='3935'>
<a name='3936'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::            ZSMAIN, &amp;<a name='3937'>
                                                         ZSHALF, &amp;<a name='3938'>
                                                         DTDZS2<a name='3939'>
<a name='3940'>
   REAL,     DIMENSION(1:NDDZS), INTENT(IN)  ::           DTDZS<a name='3941'>
<a name='3942'>
   REAL,     DIMENSION(1:5001), INTENT(IN)  ::              TBQ<a name='3943'>
<a name='3944'>
<font color=#447700>!--- input/output variables<a name='3945'></font>
<font color=#447700>!-------- 3-d soil moisture and temperature<a name='3946'></font>
   REAL,     DIMENSION(  1:nzs )                               , &amp;<a name='3947'>
             INTENT(INOUT)   ::                             TSO<a name='3948'>
<a name='3949'>
   INTEGER,  INTENT(INOUT)    ::                           ILAND<a name='3950'>
<a name='3951'>
<a name='3952'>
<font color=#447700>!-------- 2-d variables<a name='3953'></font>
   REAL                                                        , &amp;<a name='3954'>
             INTENT(INOUT)   ::                             DEW, &amp;<a name='3955'>
                                                           EETA, &amp;<a name='3956'>
                                                          RHOSN, &amp;<a name='3957'>
                                                         SUBLIM, &amp;<a name='3958'>
                                                          PRCPL, &amp;<a name='3959'>
                                                            ALB, &amp;<a name='3960'>
                                                          EMISS, &amp;<a name='3961'>
                                                            ZNT, &amp;<a name='3962'>
                                                            QVG, &amp;<a name='3963'>
                                                            QSG, &amp;<a name='3964'>
                                                            QCG, &amp;<a name='3965'>
                                                            QFX, &amp;<a name='3966'>
                                                            HFX, &amp;<a name='3967'>
                                                              S, &amp;<a name='3968'>
                                                           SNWE, &amp;<a name='3969'>
                                                          SNHEI, &amp;<a name='3970'>
                                                          SMELT, &amp;<a name='3971'>
                                                           SNOM, &amp;<a name='3972'>
                                                           SNOH, &amp;<a name='3973'>
                                                          SNFLX, &amp;<a name='3974'>
                                                          SOILT, &amp;<a name='3975'>
                                                         SOILT1, &amp;<a name='3976'>
                                                       SNOWFRAC, &amp;<a name='3977'>
                                                          TSNAV<a name='3978'>
<a name='3979'>
   INTEGER, INTENT(INOUT)    ::                            ILNB<a name='3980'>
<a name='3981'>
   REAL,     INTENT(OUT)                    ::              RSM, &amp;<a name='3982'>
                                                      SNWEPRINT, &amp;<a name='3983'>
                                                     SNHEIPRINT<a name='3984'>
<font color=#447700>!--- Local variables<a name='3985'></font>
<a name='3986'>
<a name='3987'>
   INTEGER ::  nzs1,nzs2,k,k1,kn,kk<a name='3988'>
   REAL    ::  x,x1,x2,dzstop,ft,tn,denom<a name='3989'>
<a name='3990'>
   REAL    ::  SNTH, NEWSN                                     , &amp;<a name='3991'>
               TABS, T3, UPFLUX, XINET                         , &amp;<a name='3992'>
               BETA, SNWEPR,EPDT,PP<a name='3993'>
   REAL    ::  CP,rovcp,G0,LV,xlvm,STBOLT,xlmelt               , &amp;<a name='3994'>
               epot,fltot,fq,hft,q1,ras,rhoice,ci,cvw          , &amp;<a name='3995'>
               RIW,DELTSN,H<a name='3996'>
<a name='3997'>
   REAL    ::  rhocsn,thdifsn,                                   &amp;<a name='3998'>
               xsn,ddzsn,x1sn,d1sn,d2sn,d9sn,r22sn<a name='3999'>
<a name='4000'>
   REAL    ::  cotsn,rhtsn,xsn1,ddzsn1,x1sn1,ftsnow,denomsn<a name='4001'>
   REAL    ::  fso,fsn,                                          &amp;<a name='4002'>
               FKT,D1,D2,D9,D10,DID,R211,R21,R22,R6,R7,D11,      &amp;<a name='4003'>
               FKQ,R210,AA,BB,QS1,TS1,TQ2,TX2,                   &amp;<a name='4004'>
               TDENOM,AA1,RHCS,H1,TSOB, SNPRIM,                  &amp;<a name='4005'>
               SNODIF,SOH,TNOLD,QGOLD,SNOHGNEW<a name='4006'>
   REAL,     DIMENSION(1:NZS)  ::  cotso,rhtso<a name='4007'>
<a name='4008'>
   REAL                   :: RNET,rsmfrac,soiltfrac,hsn,icemelt,rr<a name='4009'>
   integer                ::      nmelt<a name='4010'>
<a name='4011'>
<a name='4012'>
<font color=#447700>!-----------------------------------------------------------------<a name='4013'></font>
        XLMELT=3.35E+5<a name='4014'>
<font color=#447700>!-- heat of sublimation of water vapor<a name='4015'></font>
        XLVm=XLV+XLMELT<a name='4016'>
<font color=#447700>!        STBOLT=5.670151E-8<a name='4017'></font>
<a name='4018'>
<font color=#447700>!--- SNOW flag -- ISICE<a name='4019'></font>
<font color=#447700>!         ILAND=isice<a name='4020'></font>
<a name='4021'>
<font color=#447700>!--- DELTSN - is the threshold for splitting the snow layer into 2 layers.<a name='4022'></font>
<font color=#447700>!--- With snow density 400 kg/m^3, this threshold is equal to 7.5 cm,<a name='4023'></font>
<font color=#447700>!--- equivalent to 0.03 m SNWE. For other snow densities the threshold is<a name='4024'></font>
<font color=#447700>!--- computed using SNWE=0.03 m and current snow density.<a name='4025'></font>
<font color=#447700>!--- SNTH - the threshold below which the snow layer is combined with<a name='4026'></font>
<font color=#447700>!--- the top sea ice layer. SNTH is computed using snwe=0.016 m, and<a name='4027'></font>
<font color=#447700>!--- equals 4 cm for snow density 400 kg/m^3.<a name='4028'></font>
<a name='4029'>
<font color=#447700>! increase thickness of top snow layer from 3 cm SWE to 5 cm SWE<a name='4030'></font>
<font color=#447700>!           DELTSN=5.*SNHEI_CRIT<a name='4031'></font>
<font color=#447700>!           snth=0.4*SNHEI_CRIT<a name='4032'></font>
<a name='4033'>
           DELTSN=0.05*1.e3/rhosn<a name='4034'>
           snth=0.01*1.e3/rhosn<a name='4035'>
<font color=#447700>!           snth=0.01601*1.e3/rhosn<a name='4036'></font>
<a name='4037'>
<font color=#447700>! For 2-layer snow model when the snow depth is marginlly higher than DELTSN,<a name='4038'></font>
<font color=#447700>! reset DELTSN to half of snow depth.<a name='4039'></font>
        IF(SNHEI.GE.DELTSN+SNTH) THEN<a name='4040'>
          if(snhei-deltsn-snth.lt.snth) deltsn=0.5*(snhei-snth)<a name='4041'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4042'>
        print *,'DELTSN ICE is changed,deltsn,snhei,snth', &amp;<a name='4043'>
                                  i,j, deltsn,snhei,snth<a name='4044'>
    ENDIF<a name='4045'>
        ENDIF<a name='4046'>
<a name='4047'>
        RHOICE=900.<a name='4048'>
        CI=RHOICE*2100.<a name='4049'>
        RAS=RHO*1.E-3<a name='4050'>
        RIW=rhoice*1.e-3<a name='4051'>
        RSM=0.<a name='4052'>
<a name='4053'>
        XLMELT=3.35E+5<a name='4054'>
        RHOCSN=2090.* RHOSN<a name='4055'>
<font color=#447700>!18apr08 - add rhonewcsn<a name='4056'></font>
        RHOnewCSN=2090.* RHOnewSN<a name='4057'>
        THDIFSN = 0.265/RHOCSN<a name='4058'>
        RAS=RHO*1.E-3<a name='4059'>
<a name='4060'>
        SOILTFRAC=SOILT<a name='4061'>
<a name='4062'>
        SMELT=0.<a name='4063'>
        SOH=0.<a name='4064'>
        SNODIF=0.<a name='4065'>
        SNOH=0.<a name='4066'>
        SNOHGNEW=0.<a name='4067'>
        RSM = 0.<a name='4068'>
        RSMFRAC = 0.<a name='4069'>
        fsn=1.<a name='4070'>
        fso=0.<a name='4071'>
        cvw=cw<a name='4072'>
<a name='4073'>
          NZS1=NZS-1<a name='4074'>
          NZS2=NZS-2<a name='4075'>
<a name='4076'>
        QGOLD=QSG<a name='4077'>
        TNOLD=SOILT<a name='4078'>
        DZSTOP=1./(ZSMAIN(2)-ZSMAIN(1))<a name='4079'>
<a name='4080'>
        snweprint=0.<a name='4081'>
        snheiprint=0.<a name='4082'>
        prcpl=prcpms<a name='4083'>
<a name='4084'>
<font color=#447700>!*** DELTSN is the depth of the top layer of snow where<a name='4085'></font>
<font color=#447700>!*** there is a temperature gradient, the rest of the snow layer<a name='4086'></font>
<font color=#447700>!*** is considered to have constant temperature<a name='4087'></font>
<a name='4088'>
<a name='4089'>
        H=1.<a name='4090'>
        SMELT=0.<a name='4091'>
<a name='4092'>
        FQ=QKMS<a name='4093'>
        SNHEI=SNWE*1.e3/RHOSN<a name='4094'>
          SNWEPR=SNWE<a name='4095'>
<a name='4096'>
<font color=#447700>!  check if all snow can evaporate during DT<a name='4097'></font>
         BETA=1.<a name='4098'>
         EPOT = -FQ*(QVATM-QSG)<a name='4099'>
         EPDT = EPOT * RAS *DELT<a name='4100'>
         IF(EPDT.GT.0. .and. SNWEPR.LE.EPDT) THEN<a name='4101'>
            BETA=SNWEPR/max(1.e-8,EPDT)<a name='4102'>
            SNWE=0.<a name='4103'>
         ENDIF<a name='4104'>
<a name='4105'>
<font color=#447700>!******************************************************************************<a name='4106'></font>
<font color=#447700>!       COEFFICIENTS FOR THOMAS ALGORITHM FOR TSO<a name='4107'></font>
<font color=#447700>!******************************************************************************<a name='4108'></font>
<a name='4109'>
        cotso(1)=0.<a name='4110'>
        rhtso(1)=TSO(NZS)<a name='4111'>
        DO 33 K=1,NZS2<a name='4112'>
          KN=NZS-K<a name='4113'>
          K1=2*KN-3<a name='4114'>
          X1=DTDZS(K1)*THDIFICE(KN-1)<a name='4115'>
          X2=DTDZS(K1+1)*THDIFICE(KN)<a name='4116'>
          FT=TSO(KN)+X1*(TSO(KN-1)-TSO(KN))                           &amp;<a name='4117'>
             -X2*(TSO(KN)-TSO(KN+1))<a name='4118'>
          DENOM=1.+X1+X2-X2*cotso(K)<a name='4119'>
          cotso(K+1)=X1/DENOM<a name='4120'>
          rhtso(K+1)=(FT+X2*rhtso(K))/DENOM<a name='4121'>
   33  CONTINUE<a name='4122'>
<font color=#447700>!--- THE NZS element in COTSO and RHTSO will be for snow<a name='4123'></font>
<font color=#447700>!--- There will be 2 layers in snow if it is deeper than DELTSN+SNTH<a name='4124'></font>
       IF(SNHEI.GE.SNTH) then<a name='4125'>
        if(snhei.le.DELTSN+SNTH) then<a name='4126'>
<font color=#447700>!-- 1-layer snow model<a name='4127'></font>
         ilnb=1<a name='4128'>
         snprim=max(snth,snhei)<a name='4129'>
         soilt1=tso(1)<a name='4130'>
         tsob=tso(1)<a name='4131'>
         XSN = DELT/2./(zshalf(2)+0.5*SNPRIM)<a name='4132'>
         DDZSN = XSN / SNPRIM<a name='4133'>
         X1SN = DDZSN * thdifsn<a name='4134'>
         X2 = DTDZS(1)*THDIFICE(1)<a name='4135'>
         FT = TSO(1)+X1SN*(SOILT-TSO(1))                              &amp;<a name='4136'>
              -X2*(TSO(1)-TSO(2))<a name='4137'>
         DENOM = 1. + X1SN + X2 -X2*cotso(NZS1)<a name='4138'>
         cotso(NZS)=X1SN/DENOM<a name='4139'>
         rhtso(NZS)=(FT+X2*rhtso(NZS1))/DENOM<a name='4140'>
         cotsn=cotso(NZS)<a name='4141'>
         rhtsn=rhtso(NZS)<a name='4142'>
<font color=#447700>!*** Average temperature of snow pack (C)<a name='4143'></font>
         tsnav=0.5*(soilt+tso(1))                                     &amp;<a name='4144'>
                     -273.15<a name='4145'>
<a name='4146'>
        else<a name='4147'>
<font color=#447700>!-- 2 layers in snow, SOILT1 is temperasture at DELTSN depth<a name='4148'></font>
         ilnb=2<a name='4149'>
         snprim=deltsn<a name='4150'>
         tsob=soilt1<a name='4151'>
         XSN = DELT/2./(0.5*SNHEI)<a name='4152'>
         XSN1= DELT/2./(zshalf(2)+0.5*(SNHEI-DELTSN))<a name='4153'>
         DDZSN = XSN / DELTSN<a name='4154'>
         DDZSN1 = XSN1 / (SNHEI-DELTSN)<a name='4155'>
         X1SN = DDZSN * thdifsn<a name='4156'>
         X1SN1 = DDZSN1 * thdifsn<a name='4157'>
         X2 = DTDZS(1)*THDIFICE(1)<a name='4158'>
         FT = TSO(1)+X1SN1*(SOILT1-TSO(1))                            &amp;<a name='4159'>
              -X2*(TSO(1)-TSO(2))<a name='4160'>
         DENOM = 1. + X1SN1 + X2 - X2*cotso(NZS1)<a name='4161'>
         cotso(nzs)=x1sn1/denom<a name='4162'>
         rhtso(nzs)=(ft+x2*rhtso(nzs1))/denom<a name='4163'>
         ftsnow = soilt1+x1sn*(soilt-soilt1)                          &amp;<a name='4164'>
               -x1sn1*(soilt1-tso(1))<a name='4165'>
         denomsn = 1. + X1SN + X1SN1 - X1SN1*cotso(NZS)<a name='4166'>
         cotsn=x1sn/denomsn<a name='4167'>
         rhtsn=(ftsnow+X1SN1*rhtso(NZS))/denomsn<a name='4168'>
<font color=#447700>!*** Average temperature of snow pack (C)<a name='4169'></font>
         tsnav=0.5/snhei*((soilt+soilt1)*deltsn                       &amp;<a name='4170'>
                     +(soilt1+tso(1))*(SNHEI-DELTSN))                 &amp;<a name='4171'>
                     -273.15<a name='4172'>
        endif<a name='4173'>
       ENDIF<a name='4174'>
<a name='4175'>
       IF(SNHEI.LT.SNTH.AND.SNHEI.GT.0.) then<a name='4176'>
<font color=#447700>!--- snow is too thin to be treated separately, therefore it<a name='4177'></font>
<font color=#447700>!--- is combined with the first sea ice layer.<a name='4178'></font>
         snprim=SNHEI+zsmain(2)<a name='4179'>
         fsn=SNHEI/snprim<a name='4180'>
         fso=1.-fsn<a name='4181'>
         soilt1=tso(1)<a name='4182'>
         tsob=tso(2)<a name='4183'>
         XSN = DELT/2./((zshalf(3)-zsmain(2))+0.5*snprim)<a name='4184'>
         DDZSN = XSN /snprim<a name='4185'>
         X1SN = DDZSN * (fsn*thdifsn+fso*thdifice(1))<a name='4186'>
         X2=DTDZS(2)*THDIFICE(2)<a name='4187'>
         FT=TSO(2)+X1SN*(SOILT-TSO(2))-                              &amp;<a name='4188'>
                       X2*(TSO(2)-TSO(3))<a name='4189'>
         denom = 1. + x1sn + x2 - x2*cotso(nzs-2)<a name='4190'>
         cotso(nzs1) = x1sn/denom<a name='4191'>
         rhtso(nzs1)=(FT+X2*rhtso(NZS-2))/denom<a name='4192'>
         tsnav=0.5*(soilt+tso(1))                                    &amp;<a name='4193'>
                     -273.15<a name='4194'>
         cotso(nzs)=cotso(NZS1)<a name='4195'>
         rhtso(nzs)=rhtso(nzs1)<a name='4196'>
         cotsn=cotso(NZS)<a name='4197'>
         rhtsn=rhtso(NZS)<a name='4198'>
       ENDIF<a name='4199'>
<a name='4200'>
<font color=#447700>!************************************************************************<a name='4201'></font>
<font color=#447700>!--- THE HEAT BALANCE EQUATION <a name='4202'></font>
<font color=#447700>!18apr08 nmelt is the flag for melting, and SNOH is heat of snow phase changes<a name='4203'></font>
       nmelt=0<a name='4204'>
       SNOH=0.<a name='4205'>
<a name='4206'>
        EPOT=-QKMS*(QVATM-QSG)<a name='4207'>
        RHCS=CAPICE(1)<a name='4208'>
        H=1.<a name='4209'>
        FKT=TKMS<a name='4210'>
        D1=cotso(NZS1)<a name='4211'>
        D2=rhtso(NZS1)<a name='4212'>
        TN=SOILT<a name='4213'>
        D9=THDIFICE(1)*RHCS*dzstop<a name='4214'>
        D10=TKMS*CP*RHO<a name='4215'>
        R211=.5*CONFLX/DELT<a name='4216'>
        R21=R211*CP*RHO<a name='4217'>
        R22=.5/(THDIFICE(1)*DELT*dzstop**2)<a name='4218'>
        R6=EMISS *STBOLT*.5*TN**4<a name='4219'>
        R7=R6/TN<a name='4220'>
        D11=RNET+R6<a name='4221'>
<a name='4222'>
      IF(SNHEI.GE.SNTH) THEN <a name='4223'>
        if(snhei.le.DELTSN+SNTH) then<a name='4224'>
<font color=#447700>!--- 1-layer snow<a name='4225'></font>
          D1SN = cotso(NZS)<a name='4226'>
          D2SN = rhtso(NZS)<a name='4227'>
        else<a name='4228'>
<font color=#447700>!--- 2-layer snow<a name='4229'></font>
          D1SN = cotsn<a name='4230'>
          D2SN = rhtsn<a name='4231'>
        endif<a name='4232'>
        D9SN= THDIFSN*RHOCSN / SNPRIM<a name='4233'>
        R22SN = SNPRIM*SNPRIM*0.5/(THDIFSN*DELT)<a name='4234'>
      ENDIF<a name='4235'>
<a name='4236'>
       IF(SNHEI.LT.SNTH.AND.SNHEI.GT.0.) then<a name='4237'>
<font color=#447700>!--- thin snow is combined with sea ice<a name='4238'></font>
         D1SN = D1<a name='4239'>
         D2SN = D2<a name='4240'>
         D9SN = (fsn*THDIFSN*RHOCSN+fso*THDIFICE(1)*RHCS)/           &amp;<a name='4241'>
                 snprim<a name='4242'>
         R22SN = snprim*snprim*0.5                                   &amp;<a name='4243'>
                 /((fsn*THDIFSN+fso*THDIFICE(1))*delt)<a name='4244'>
      ENDIF<a name='4245'>
<a name='4246'>
      IF(SNHEI.eq.0.)then<a name='4247'>
<font color=#447700>!--- all snow is sublimated<a name='4248'></font>
        D9SN = D9<a name='4249'>
        R22SN = R22<a name='4250'>
        D1SN = D1<a name='4251'>
        D2SN = D2<a name='4252'>
      ENDIF<a name='4253'>
<a name='4254'>
<a name='4255'>
<font color=#447700>!---- TDENOM for snow<a name='4256'></font>
        TDENOM = D9SN*(1.-D1SN +R22SN)+D10+R21+R7                    &amp;<a name='4257'>
              +RAINF*CVW*PRCPMS                                      &amp;<a name='4258'>
              +RHOnewCSN*NEWSNOW/DELT<a name='4259'>
<a name='4260'>
        FKQ=QKMS*RHO<a name='4261'>
        R210=R211*RHO<a name='4262'>
        AA=XLVM*(BETA*FKQ+R210)/TDENOM<a name='4263'>
        BB=(D10*TABS+R21*TN+XLVM*(QVATM*                             &amp;<a name='4264'>
        (BETA*FKQ)                                                   &amp;<a name='4265'>
        +R210*QVG)+D11+D9SN*(D2SN+R22SN*TN)                          &amp;<a name='4266'>
        +RAINF*CVW*PRCPMS*max(273.15,TABS)                           &amp;<a name='4267'>
        + RHOnewCSN*NEWSNOW/DELT*min(273.15,TABS)                    &amp;<a name='4268'>
         )/TDENOM<a name='4269'>
        AA1=AA<a name='4270'>
        PP=PATM*1.E3<a name='4271'>
        AA1=AA1/PP<a name='4272'>
<font color=#447700>!18apr08  - the iteration start point<a name='4273'></font>
 212    continue<a name='4274'>
        BB=BB-SNOH/TDENOM<a name='4275'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4276'>
        print *,'VILKA-SNOW on SEAICE'<a name='4277'>
        print *,'tn,aa1,bb,pp,fkq,r210',                             &amp;<a name='4278'>
                 tn,aa1,bb,pp,fkq,r210<a name='4279'>
        print *,'TABS,QVATM,TN,QVG=',TABS,QVATM,TN,QVG<a name='4280'>
    ENDIF<a name='4281'>
<a name='4282'>
        CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#VILKA'>VILKA</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSEAICE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VILKA_2">(TN,AA1,BB,PP,QS1,TS1,TBQ,KTAU,i,j,iland,isoil)<a name='4283'>
<font color=#447700>!--- it is saturation over snow<a name='4284'></font>
        QVG=QS1<a name='4285'>
        QSG=QS1<a name='4286'>
        QCG=0.<a name='4287'>
<a name='4288'>
<font color=#447700>!--- SOILT - skin temperature<a name='4289'></font>
        SOILT=TS1<a name='4290'>
<a name='4291'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4292'>
        print *,' AFTER VILKA-SNOW on SEAICE'<a name='4293'>
        print *,' TS1,QS1: ', ts1,qs1<a name='4294'>
    ENDIF<a name='4295'>
<font color=#447700>! Solution for temperature at 7.5 cm depth and snow-seaice interface<a name='4296'></font>
       IF(SNHEI.GE.SNTH) THEN<a name='4297'>
        if(snhei.gt.DELTSN+SNTH) then<a name='4298'>
<font color=#447700>!-- 2-layer snow model<a name='4299'></font>
          SOILT1=min(273.15,rhtsn+cotsn*SOILT)<a name='4300'>
          TSO(1)=min(271.4,(rhtso(NZS)+cotso(NZS)*SOILT1))<a name='4301'>
          tsob=soilt1<a name='4302'>
        else<a name='4303'>
<font color=#447700>!-- 1 layer in snow<a name='4304'></font>
          TSO(1)=min(271.4,(rhtso(NZS)+cotso(NZS)*SOILT))<a name='4305'>
          SOILT1=TSO(1)<a name='4306'>
          tsob=tso(1)<a name='4307'>
        endif<a name='4308'>
       ELSEIF  (SNHEI &gt; 0. .and. SNHEI &lt; SNTH) THEN<a name='4309'>
<font color=#447700>! blended<a name='4310'></font>
         TSO(2)=min(271.4,(rhtso(NZS1)+cotso(NZS1)*SOILT))<a name='4311'>
         tso(1)=min(271.4,(tso(2)+(soilt-tso(2))*fso))<a name='4312'>
         SOILT1=TSO(1)<a name='4313'>
         tsob=TSO(2)<a name='4314'>
       ELSE<a name='4315'>
<font color=#447700>! snow is melted<a name='4316'></font>
         TSO(1)=min(271.4,SOILT)<a name='4317'>
         SOILT1=min(271.4,SOILT)<a name='4318'>
         tsob=tso(1)<a name='4319'>
       ENDIF<a name='4320'>
<font color=#447700>!---- Final solution for TSO in sea ice<a name='4321'></font>
       IF (SNHEI &gt; 0. .and. SNHEI &lt; SNTH) THEN<a name='4322'>
<font color=#447700>! blended or snow is melted<a name='4323'></font>
          DO K=3,NZS<a name='4324'>
            KK=NZS-K+1<a name='4325'>
            TSO(K)=min(271.4,rhtso(KK)+cotso(KK)*TSO(K-1))<a name='4326'>
          END DO<a name='4327'>
       ELSE<a name='4328'>
          DO K=2,NZS<a name='4329'>
            KK=NZS-K+1<a name='4330'>
            TSO(K)=min(271.4,rhtso(KK)+cotso(KK)*TSO(K-1))<a name='4331'>
          END DO<a name='4332'>
       ENDIF<a name='4333'>
<font color=#447700>!--- For thin snow layer combined with the top soil layer<a name='4334'></font>
<font color=#447700>!--- TSO(i,j,1) is computed by linear interpolation between SOILT<a name='4335'></font>
<font color=#447700>!--- and TSO(i,j,2)<a name='4336'></font>
<font color=#447700>!       if(SNHEI.LT.SNTH.AND.SNHEI.GT.0.)then<a name='4337'></font>
<font color=#447700>!          tso(1)=min(271.4,tso(2)+(soilt-tso(2))*fso)<a name='4338'></font>
<font color=#447700>!          soilt1=tso(1)<a name='4339'></font>
<font color=#447700>!          tsob = tso(2)<a name='4340'></font>
<font color=#447700>!       endif<a name='4341'></font>
<a name='4342'>
      if(nmelt.eq.1) go to 220<a name='4343'>
<a name='4344'>
<font color=#447700>!--- IF SOILT &gt; 273.15 F then melting of snow can happen<a name='4345'></font>
<font color=#447700>!   IF(SOILT.GT.273.15.AND.SNWE.GT.0.) THEN<a name='4346'></font>
<font color=#447700>! if all snow can evaporate, then there is nothing to melt<a name='4347'></font>
   IF(SOILT.GT.273.15.AND.SNWEPR-BETA*EPOT*RAS*DELT.GT.0..AND.SNHEI.GT.0.) THEN<a name='4348'>
<font color=#447700>!<a name='4349'></font>
        nmelt = 1<a name='4350'>
<font color=#447700>!        soiltfrac=273.15<a name='4351'></font>
        soiltfrac=snowfrac*273.15+(1.-snowfrac)*min(271.4,SOILT)<a name='4352'>
<a name='4353'>
        QSG= <A href='../../html_code/phys/module_sf_ruclsm.F.html#QSN'>QSN</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSEAICE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSN_6">(soiltfrac,TBQ)/PP<a name='4354'>
        T3      = STBOLT*TNold*TNold*TNold<a name='4355'>
        UPFLUX  = T3 * 0.5*(TNold+SOILTfrac)<a name='4356'>
        XINET   = EMISS*(GLW-UPFLUX)<a name='4357'>
<font color=#447700>!        RNET = GSW + XINET<a name='4358'></font>
         EPOT = -QKMS*(QVATM-QSG)<a name='4359'>
         Q1=EPOT*RAS<a name='4360'>
<a name='4361'>
        IF (Q1.LE.0.) THEN<a name='4362'>
<font color=#447700>! ---  condensation<a name='4363'></font>
          DEW=-EPOT<a name='4364'>
<a name='4365'>
        QFX= XLVM*RHO*DEW<a name='4366'>
        EETA=QFX/XLVM<a name='4367'>
       ELSE<a name='4368'>
<font color=#447700>! ---  evaporation<a name='4369'></font>
        EETA = Q1 * BETA *1.E3<a name='4370'>
<font color=#447700>! to convert from kg m-2 s-1 to m s-1: 1/rho water=1.e-3************<a name='4371'></font>
        QFX= - XLVM * EETA<a name='4372'>
       ENDIF<a name='4373'>
<a name='4374'>
         HFX=D10*(TABS-soiltfrac)<a name='4375'>
<a name='4376'>
       IF(SNHEI.GE.SNTH)then<a name='4377'>
         SOH=thdifsn*RHOCSN*(soiltfrac-TSOB)/SNPRIM<a name='4378'>
         SNFLX=SOH<a name='4379'>
       ELSE<a name='4380'>
         SOH=(fsn*thdifsn*rhocsn+fso*thdifice(1)*rhcs)*                &amp;<a name='4381'>
              (soiltfrac-TSOB)/snprim<a name='4382'>
         SNFLX=SOH<a name='4383'>
       ENDIF<a name='4384'>
         X= (R21+D9SN*R22SN)*(soiltfrac-TNOLD) +                        &amp;<a name='4385'>
            XLVM*R210*(QSG-QGOLD)<a name='4386'>
<font color=#447700>!-- SNOH is energy flux of snow phase change<a name='4387'></font>
        SNOH=RNET+QFX +HFX                                              &amp;<a name='4388'>
                  +RHOnewCSN*NEWSNOW/DELT*(min(273.15,TABS)-soiltfrac)  &amp;<a name='4389'>
                  -SOH-X+RAINF*CVW*PRCPMS*                              &amp;<a name='4390'>
                  (max(273.15,TABS)-soiltfrac)<a name='4391'>
<a name='4392'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4393'>
     print *,'SNOWSEAICE melt I,J,SNOH,RNET,QFX,HFX,SOH,X',i,j,SNOH,RNET,QFX,HFX,SOH,X<a name='4394'>
     print *,'RHOnewCSN*NEWSNOW/DELT*(min(273.15,TABS)-soiltfrac)',     &amp;<a name='4395'>
              RHOnewCSN*NEWSNOW/DELT*(min(273.15,TABS)-soiltfrac)<a name='4396'>
     print *,'RAINF*CVW*PRCPMS*(max(273.15,TABS)-soiltfrac)',           &amp;<a name='4397'>
              RAINF*CVW*PRCPMS*(max(273.15,TABS)-soiltfrac)<a name='4398'>
    ENDIF<a name='4399'>
        SNOH=AMAX1(0.,SNOH)<a name='4400'>
<font color=#447700>!-- SMELT is speed of melting in M/S<a name='4401'></font>
        SMELT= SNOH /XLMELT*1.E-3<a name='4402'>
        SMELT=AMIN1(SMELT,SNWEPR/DELT-BETA*EPOT*RAS)<a name='4403'>
        SMELT=AMAX1(0.,SMELT)<a name='4404'>
<a name='4405'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4406'>
       print *,'1-SMELT i,j',smelt,i,j<a name='4407'>
    ENDIF<a name='4408'>
<font color=#447700>!18apr08 - Egglston limit<a name='4409'></font>
<font color=#447700>!        SMELT= amin1 (smelt, 5.6E-7*meltfactor*max(1.,(soilt-273.15)))<a name='4410'></font>
        SMELT= amin1 (smelt, 5.6E-8*meltfactor*max(1.,(soilt-273.15)))<a name='4411'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4412'>
       print *,'2-SMELT i,j',smelt,i,j<a name='4413'>
    ENDIF<a name='4414'>
<a name='4415'>
<font color=#447700>! rr - potential melting<a name='4416'></font>
        rr=SNWEPR/delt-BETA*EPOT*RAS<a name='4417'>
        SMELT=min(SMELT,rr)<a name='4418'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4419'>
      print *,'3- SMELT i,j,smelt,rr',i,j,smelt,rr<a name='4420'>
    ENDIF<a name='4421'>
        SNOHGNEW=SMELT*XLMELT*1.E3<a name='4422'>
        SNODIF=AMAX1(0.,(SNOH-SNOHGNEW))<a name='4423'>
<a name='4424'>
        SNOH=SNOHGNEW<a name='4425'>
<a name='4426'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4427'>
       print*,'soiltfrac,soilt,SNOHGNEW,SNODIF=', &amp;<a name='4428'>
            i,j,soiltfrac,soilt,snohgnew,snodif<a name='4429'>
       print *,'SNOH,SNODIF',SNOH,SNODIF<a name='4430'>
    ENDIF<a name='4431'>
<a name='4432'>
<font color=#447700>!*** From Koren et al. (1999) 13% of snow melt stays in the snow pack<a name='4433'></font>
        rsmfrac=min(0.18,(max(0.08,snwepr/0.10*0.13)))<a name='4434'>
       if(snhei &gt; 0.01) then<a name='4435'>
        rsm=rsmfrac*smelt*delt<a name='4436'>
       else<a name='4437'>
<font color=#447700>! do not keep melted water if snow depth is less that 1 cm<a name='4438'></font>
        rsm=0.<a name='4439'>
       endif<a name='4440'>
<font color=#447700>!18apr08 rsm is part of melted water that stays in snow as liquid<a name='4441'></font>
        SMELT=AMAX1(0.,SMELT-rsm/delt)<a name='4442'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4443'>
       print *,'4-SMELT i,j,smelt,rsm,snwepr,rsmfrac', &amp;<a name='4444'>
                    i,j,smelt,rsm,snwepr,rsmfrac<a name='4445'>
    ENDIF<a name='4446'>
<a name='4447'>
<font color=#447700>!-- update liquid equivalent of snow depth<a name='4448'></font>
<font color=#447700>!-- for evaporation and snow melt<a name='4449'></font>
        SNWE = AMAX1(0.,(SNWEPR-                                      &amp;<a name='4450'>
                    (SMELT+BETA*EPOT*RAS)*DELT                        &amp;<a name='4451'>
<font color=#447700>!                    (SMELT+BETA*EPOT*RAS)*DELT*snowfrac               &amp;<a name='4452'></font>
                                         ) )<a name='4453'>
<font color=#447700>!!!!<a name='4454'></font>
        soilt=soiltfrac<a name='4455'>
<font color=#447700>!--- If there is no snow melting then just evaporation<a name='4456'></font>
<font color=#447700>!--- or condensation changes SNWE<a name='4457'></font>
      ELSE<a name='4458'>
       if(snhei.ne.0.) then<a name='4459'>
               EPOT=-QKMS*(QVATM-QSG)<a name='4460'>
               SNWE = AMAX1(0.,(SNWEPR-                               &amp;<a name='4461'>
                    BETA*EPOT*RAS*DELT))<a name='4462'>
<font color=#447700>!                    BETA*EPOT*RAS*DELT*snowfrac))<a name='4463'></font>
       endif<a name='4464'>
<a name='4465'>
      ENDIF<a name='4466'>
<a name='4467'>
<font color=#447700>! no iteration for snow on sea ice, because it will produce<a name='4468'></font>
<font color=#447700>! skin temperature higher than it is possible with snow on sea ice<a name='4469'></font>
<font color=#447700>!      if(nmelt.eq.1) goto 212  ! second iteration<a name='4470'></font>
 220  continue<a name='4471'>
<a name='4472'>
       if(smelt &gt; 0..and.  rsm &gt; 0.) then<a name='4473'>
        if(snwe.le.rsm) then<a name='4474'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4475'>
     print *,'SEAICE SNWE&lt;RSM snwe,rsm,smelt*delt,epot*ras*delt,beta', &amp;<a name='4476'>
                              snwe,rsm,smelt*delt,epot*ras*delt,beta<a name='4477'>
    ENDIF<a name='4478'>
        else<a name='4479'>
<font color=#447700>!*** Update snow density on effect of snow melt, melted<a name='4480'></font>
<font color=#447700>!*** from the top of the snow. 13% of melted water<a name='4481'></font>
<font color=#447700>!*** remains in the pack and changes its density.<a name='4482'></font>
<font color=#447700>!*** Eq. 9 (with my correction) in Koren et al. (1999)<a name='4483'></font>
<a name='4484'>
         xsn=(rhosn*(snwe-rsm)+1.e3*rsm)/                            &amp;<a name='4485'>
             snwe<a name='4486'>
         rhosn=MIN(MAX(76.9,XSN),500.)<a name='4487'>
<a name='4488'>
        RHOCSN=2090.* RHOSN<a name='4489'>
        thdifsn = 0.265/RHOCSN<a name='4490'>
        endif<a name='4491'>
      endif<a name='4492'>
<a name='4493'>
        snweprint=snwe<a name='4494'>
<font color=#447700>!                                              &amp;<a name='4495'></font>
<font color=#447700>!--- if VEGFRAC.ne.0. then some snow stays on the canopy<a name='4496'></font>
<font color=#447700>!--- and should be added to SNWE for water conservation<a name='4497'></font>
<font color=#447700>! 4 Nov 07                    +VEGFRAC*cst<a name='4498'></font>
        snheiprint=snweprint*1.E3 / RHOSN<a name='4499'>
<a name='4500'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4501'>
print *, 'snweprint : ',snweprint<a name='4502'>
print *, 'D9SN,SOILT,TSOB : ', D9SN,SOILT,TSOB<a name='4503'>
    ENDIF<a name='4504'>
      IF(SNHEI.GT.0.) THEN<a name='4505'>
        if(ilnb.gt.1) then<a name='4506'>
          tsnav=0.5/snhei*((soilt+soilt1)*deltsn                     &amp;<a name='4507'>
                    +(soilt1+tso(1))*(SNHEI-DELTSN))                 &amp;<a name='4508'>
                       -273.15<a name='4509'>
        else<a name='4510'>
          tsnav=0.5*(soilt+tso(1)) - 273.15<a name='4511'>
        endif<a name='4512'>
      ENDIF<a name='4513'>
<font color=#447700>!--- RECALCULATION OF DEW USING NEW VALUE OF QSG<a name='4514'></font>
         DEW=0.<a name='4515'>
         PP=PATM*1.E3<a name='4516'>
         QSG= <A href='../../html_code/phys/module_sf_ruclsm.F.html#QSN'>QSN</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWSEAICE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSN_7">(SOILT,TBQ)/PP<a name='4517'>
         EPOT = -FQ*(QVATM-QSG)<a name='4518'>
       IF(EPOT.LT.0.) THEN<a name='4519'>
<font color=#447700>! Sublimation<a name='4520'></font>
          DEW=-EPOT<a name='4521'>
        ENDIF<a name='4522'>
<a name='4523'>
        SNOM=SNOM+SMELT*DELT*1.e3<a name='4524'>
<a name='4525'>
<font color=#447700>!--- THE DIAGNOSTICS OF SURFACE FLUXES<a name='4526'></font>
<a name='4527'>
        T3      = STBOLT*TNold*TNold*TNold<a name='4528'>
        UPFLUX  = T3 *0.5*(SOILT+TNold)<a name='4529'>
        XINET   = EMISS*(GLW-UPFLUX)<a name='4530'>
<font color=#447700>!        RNET    = GSW + XINET<a name='4531'></font>
        HFT=-TKMS*CP*RHO*(TABS-SOILT)<a name='4532'>
        HFX=-TKMS*CP*RHO*(TABS-SOILT)                        &amp;<a name='4533'>
               *(P1000mb*0.00001/Patm)**ROVCP<a name='4534'>
        Q1 = - FQ*RAS* (QVATM - QSG)<a name='4535'>
        IF (Q1.LT.0.) THEN<a name='4536'>
<font color=#447700>! ---  condensation<a name='4537'></font>
      if(myj) then<a name='4538'>
<font color=#447700>!-- moisture flux for coupling with MYJ PBL<a name='4539'></font>
          EETA=-QKMS*RAS*(QVATM/(1.+QVATM) - QSG/(1.+QSG))*1.E3<a name='4540'>
      else <font color=#447700>! myj<a name='4541'></font>
<font color=#447700>!-- actual moisture flux from RUC LSM<a name='4542'></font>
          DEW=QKMS*(QVATM-QSG)<a name='4543'>
          EETA= - RHO*DEW<a name='4544'>
      endif <font color=#447700>! myj<a name='4545'></font>
          QFX= XLVm*EETA<a name='4546'>
          sublim = EETA<a name='4547'>
        ELSE<a name='4548'>
<font color=#447700>! ---  evaporation<a name='4549'></font>
      if(myj) then<a name='4550'>
<font color=#447700>!-- moisture flux for coupling with MYJ PBL<a name='4551'></font>
          EETA=-QKMS*RAS*BETA*(QVATM/(1.+QVATM) - QVG/(1.+QVG))*1.E3<a name='4552'>
      else <font color=#447700>! myj<a name='4553'></font>
<font color=#447700>! to convert from m s-1 to kg m-2 s-1: *rho water=1.e3************<a name='4554'></font>
<font color=#447700>!-- actual moisture flux from RUC LSM<a name='4555'></font>
          EETA = Q1*BETA*1.E3<a name='4556'>
      endif <font color=#447700>! myj<a name='4557'></font>
          QFX= XLVm * EETA<a name='4558'>
          sublim = EETA<a name='4559'>
        ENDIF<a name='4560'>
<a name='4561'>
        icemelt=0.<a name='4562'>
      IF(SNHEI.GE.SNTH)then<a name='4563'>
         S=thdifsn*RHOCSN*(soilt-TSOB)/SNPRIM<a name='4564'>
         SNFLX=S<a name='4565'>
       ELSEIF(SNHEI.lt.SNTH.and.SNHEI.GT.0.) then<a name='4566'>
         S=(fsn*thdifsn*rhocsn+fso*thdifice(1)*rhcs)*                &amp;<a name='4567'>
              (soilt-TSOB)/snprim<a name='4568'>
         SNFLX=S<a name='4569'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4570'>
      print *,'SNOW is thin, snflx',i,j,snflx<a name='4571'>
    ENDIF<a name='4572'>
       ELSE <a name='4573'>
         SNFLX=D9SN*(SOILT-TSOB)<a name='4574'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4575'>
      print *,'SNOW is GONE, snflx',i,j,snflx<a name='4576'>
    ENDIF<a name='4577'>
       ENDIF<a name='4578'>
<a name='4579'>
        SNHEI=SNWE *1.E3 / RHOSN<a name='4580'>
<a name='4581'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4582'>
       print *,'SNHEI,SNOH',i,j,SNHEI,SNOH<a name='4583'>
    ENDIF<a name='4584'>
<font color=#447700>!<a name='4585'></font>
         X= (R21+D9SN*R22SN)*(soilt-TNOLD) +              &amp;<a name='4586'>
            XLVM*R210*(QSG-QGOLD)<a name='4587'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4588'>
     print *,'SNOWSEAICE storage ',i,j,x<a name='4589'>
     print *,'R21,D9sn,r22sn,soiltfrac,tnold,qsg,qgold,snprim', &amp;<a name='4590'>
              R21,D9sn,r22sn,soiltfrac,tnold,qsg,qgold,snprim<a name='4591'>
    ENDIF<a name='4592'>
         X=X &amp;<a name='4593'>
        -RHOnewCSN*NEWSNOW/DELT*(min(273.15,TABS)-SOILT)        &amp;<a name='4594'>
        -RAINF*CVW*PRCPMS*(max(273.15,TABS)-SOILT)<a name='4595'>
<a name='4596'>
<font color=#447700>! -- excess energy is spent on ice melt<a name='4597'></font>
        icemelt = RNET-HFT-XLVm*EETA-S-SNOH-X<a name='4598'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4599'>
        print *,'SNOWSEAICE icemelt=',icemelt<a name='4600'>
    ENDIF<a name='4601'>
<a name='4602'>
        FLTOT=RNET-HFT-XLVm*EETA-S-SNOH-x-icemelt<a name='4603'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4604'>
       print *,'i,j,snhei,qsg,soilt,soilt1,tso,TABS,QVATM', &amp;<a name='4605'>
                i,j,snhei,qsg,soilt,soilt1,tso,tabs,qvatm<a name='4606'>
       print *,'SNOWSEAICE - FLTOT,RNET,HFT,QFX,S,SNOH,icemelt,snodif,X,SOILT=' &amp;<a name='4607'>
                      ,FLTOT,RNET,HFT,XLVm*EETA,s,SNOH,icemelt,snodif,X,SOILT<a name='4608'>
    ENDIF<a name='4609'>
<font color=#447700>!-- Restore sea-ice parameters if snow is less than threshold<a name='4610'></font>
         IF(SNHEI.EQ.0.)  then<a name='4611'>
          tsnav=soilt-273.15<a name='4612'>
          emiss=0.98<a name='4613'>
          znt=0.011<a name='4614'>
          alb=0.55<a name='4615'>
         ENDIF<a name='4616'>
<a name='4617'>
<font color=#447700>!------------------------------------------------------------------------<a name='4618'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='4619'></font>
   END SUBROUTINE SNOWSEAICE<a name='4620'>
<font color=#447700>!------------------------------------------------------------------------<a name='4621'></font>
<a name='4622'>
<a name='4623'>
<A NAME='SOILTEMP'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILTEMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4624'>
           <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOILTEMP</font>(                             &amp; <A href='../../call_to/SOILTEMP.html' TARGET='index'>1</A>,<A href='../../call_from/SOILTEMP.html' TARGET='index'>2</A><a name='4625'>
<font color=#447700>!--- input variables<a name='4626'></font>
           i,j,iland,isoil,                                 &amp;<a name='4627'>
           delt,ktau,conflx,nzs,nddzs,nroot,                &amp;<a name='4628'>
           PRCPMS,RAINF,PATM,TABS,QVATM,QCATM,              &amp;<a name='4629'>
           EMISS,RNET,                                      &amp;<a name='4630'>
           QKMS,TKMS,PC,RHO,VEGFRAC,lai,                    &amp;<a name='4631'>
           THDIF,CAP,DRYCAN,WETCAN,                         &amp;<a name='4632'>
           TRANSUM,DEW,MAVAIL,soilres,alfa,                 &amp;<a name='4633'>
<font color=#447700>!--- soil fixed fields<a name='4634'></font>
           DQM,QMIN,BCLH,                                   &amp;<a name='4635'>
           ZSMAIN,ZSHALF,DTDZS,TBQ,                         &amp;<a name='4636'>
<font color=#447700>!--- constants<a name='4637'></font>
           XLV,CP,G0_P,CVW,STBOLT,                          &amp;<a name='4638'>
<font color=#447700>!--- output variables<a name='4639'></font>
           TSO,SOILT,QVG,QSG,QCG,X)<a name='4640'>
<a name='4641'>
<font color=#447700>!*************************************************************<a name='4642'></font>
<font color=#447700>!   Energy budget equation and heat diffusion eqn are <a name='4643'></font>
<font color=#447700>!   solved here and<a name='4644'></font>
<font color=#447700>!<a name='4645'></font>
<font color=#447700>!     DELT - time step (s)<a name='4646'></font>
<font color=#447700>!     ktau - numver of time step<a name='4647'></font>
<font color=#447700>!     CONFLX - depth of constant flux layer (m)<a name='4648'></font>
<font color=#447700>!     IME, JME, KME, NZS - dimensions of the domain <a name='4649'></font>
<font color=#447700>!     NROOT - number of levels within the root zone<a name='4650'></font>
<font color=#447700>!     PRCPMS - precipitation rate in m/s<a name='4651'></font>
<font color=#447700>!     COTSO, RHTSO - coefficients for implicit solution of<a name='4652'></font>
<font color=#447700>!                     heat diffusion equation<a name='4653'></font>
<font color=#447700>!     THDIF - thermal diffusivity (m^2/s)<a name='4654'></font>
<font color=#447700>!     QSG,QVG,QCG - saturated mixing ratio, mixing ratio of<a name='4655'></font>
<font color=#447700>!                   water vapor and cloud at the ground<a name='4656'></font>
<font color=#447700>!                   surface, respectively (kg/kg)<a name='4657'></font>
<font color=#447700>!     PATM -  pressure [bar]<a name='4658'></font>
<font color=#447700>!     QC3D,QV3D - cloud and water vapor mixing ratio<a name='4659'></font>
<font color=#447700>!                   at the first atm. level (kg/kg)<a name='4660'></font>
<font color=#447700>!     EMISS,RNET - emissivity (0-1) of the ground surface and net<a name='4661'></font>
<font color=#447700>!                  radiation at the surface (W/m^2)<a name='4662'></font>
<font color=#447700>!     QKMS - exchange coefficient for water vapor in the<a name='4663'></font>
<font color=#447700>!              surface layer (m/s)<a name='4664'></font>
<font color=#447700>!     TKMS - exchange coefficient for heat in the surface<a name='4665'></font>
<font color=#447700>!              layer (m/s)<a name='4666'></font>
<font color=#447700>!     PC - plant coefficient (resistance)<a name='4667'></font>
<font color=#447700>!     RHO - density of atmosphere near surface (kg/m^3)<a name='4668'></font>
<font color=#447700>!     VEGFRAC - greeness fraction (0-1)<a name='4669'></font>
<font color=#447700>!     CAP - volumetric heat capacity (J/m^3/K)<a name='4670'></font>
<font color=#447700>!     DRYCAN - dry fraction of vegetated area where<a name='4671'></font>
<font color=#447700>!              transpiration may take place (0-1)<a name='4672'></font>
<font color=#447700>!     WETCAN - fraction of vegetated area covered by canopy<a name='4673'></font>
<font color=#447700>!              water (0-1)<a name='4674'></font>
<font color=#447700>!     TRANSUM - transpiration function integrated over the <a name='4675'></font>
<font color=#447700>!               rooting zone (m)<a name='4676'></font>
<font color=#447700>!     DEW -  dew in kg/m^2s<a name='4677'></font>
<font color=#447700>!     MAVAIL - fraction of maximum soil moisture in the top<a name='4678'></font>
<font color=#447700>!               layer (0-1)<a name='4679'></font>
<font color=#447700>!     ZSMAIN - main levels in soil (m)<a name='4680'></font>
<font color=#447700>!     ZSHALF - middle of the soil layers (m)<a name='4681'></font>
<font color=#447700>!     DTDZS - dt/(2.*dzshalf*dzmain)<a name='4682'></font>
<font color=#447700>!     TBQ - table to define saturated mixing ration<a name='4683'></font>
<font color=#447700>!           of water vapor for given temperature and pressure<a name='4684'></font>
<font color=#447700>!     TSO - soil temperature (K)<a name='4685'></font>
<font color=#447700>!     SOILT - skin temperature (K)<a name='4686'></font>
<font color=#447700>!<a name='4687'></font>
<font color=#447700>!****************************************************************<a name='4688'></font>
<a name='4689'>
        IMPLICIT NONE<a name='4690'>
<font color=#447700>!-----------------------------------------------------------------<a name='4691'></font>
<a name='4692'>
<font color=#447700>!--- input variables<a name='4693'></font>
<a name='4694'>
   INTEGER,  INTENT(IN   )   ::  nroot,ktau,nzs                , &amp;<a name='4695'>
                                 nddzs                         <font color=#447700>!nddzs=2*(nzs-2)<a name='4696'></font>
   INTEGER,  INTENT(IN   )   ::  i,j,iland,isoil<a name='4697'>
   REAL,     INTENT(IN   )   ::  DELT,CONFLX,PRCPMS, RAINF<a name='4698'>
   REAL,     INTENT(INOUT)   ::  DRYCAN,WETCAN,TRANSUM<a name='4699'>
<font color=#447700>!--- 3-D Atmospheric variables<a name='4700'></font>
   REAL,                                                         &amp;<a name='4701'>
            INTENT(IN   )    ::                            PATM, &amp;<a name='4702'>
                                                          QVATM, &amp;<a name='4703'>
                                                          QCATM<a name='4704'>
<font color=#447700>!--- 2-D variables<a name='4705'></font>
   REAL                                                        , &amp;<a name='4706'>
            INTENT(IN   )    ::                                  &amp;<a name='4707'>
                                                          EMISS, &amp;<a name='4708'>
                                                            RHO, &amp;<a name='4709'>
                                                           RNET, &amp;  <a name='4710'>
                                                             PC, &amp;<a name='4711'>
                                                        VEGFRAC, &amp;<a name='4712'>
                                                            LAI, &amp;<a name='4713'>
                                                            DEW, &amp; <a name='4714'>
                                                           QKMS, &amp;<a name='4715'>
                                                           TKMS<a name='4716'>
<a name='4717'>
<font color=#447700>!--- soil properties<a name='4718'></font>
   REAL                                                        , &amp;<a name='4719'>
            INTENT(IN   )    ::                                  &amp;<a name='4720'>
                                                           BCLH, &amp;<a name='4721'>
                                                            DQM, &amp;<a name='4722'>
                                                           QMIN<a name='4723'>
   REAL                                                        , &amp;<a name='4724'>
            INTENT(IN   )    ::                                  &amp;<a name='4725'>
                                                   soilres,alfa<a name='4726'>
<a name='4727'>
<a name='4728'>
   REAL,     INTENT(IN   )   ::                              CP, &amp;<a name='4729'>
                                                            CVW, &amp;<a name='4730'>
                                                            XLV, &amp;<a name='4731'>
                                                         STBOLT, &amp;<a name='4732'>
                                                           TABS, &amp;<a name='4733'>
                                                           G0_P<a name='4734'>
<a name='4735'>
<a name='4736'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::            ZSMAIN, &amp;<a name='4737'>
                                                         ZSHALF, &amp;<a name='4738'>
                                                          THDIF, &amp;<a name='4739'>
                                                            CAP<a name='4740'>
<a name='4741'>
   REAL,     DIMENSION(1:NDDZS), INTENT(IN)  ::           DTDZS<a name='4742'>
<a name='4743'>
   REAL,     DIMENSION(1:5001), INTENT(IN)  ::              TBQ<a name='4744'>
<a name='4745'>
<a name='4746'>
<font color=#447700>!--- input/output variables<a name='4747'></font>
<font color=#447700>!-------- 3-d soil moisture and temperature<a name='4748'></font>
   REAL,     DIMENSION( 1:nzs )                                , &amp;<a name='4749'>
             INTENT(INOUT)   ::                             TSO<a name='4750'>
<a name='4751'>
<font color=#447700>!-------- 2-d variables<a name='4752'></font>
   REAL                                                        , &amp;<a name='4753'>
             INTENT(INOUT)   ::                                  &amp;<a name='4754'>
                                                         MAVAIL, &amp;<a name='4755'>
                                                            QVG, &amp;<a name='4756'>
                                                            QSG, &amp;<a name='4757'>
                                                            QCG, &amp;<a name='4758'>
                                                          SOILT<a name='4759'>
<a name='4760'>
<a name='4761'>
<font color=#447700>!--- Local variables<a name='4762'></font>
<a name='4763'>
   REAL    ::  x,x1,x2,x4,dzstop,can,ft,sph                    , &amp;<a name='4764'>
               tn,trans,umveg,denom,fex<a name='4765'>
<a name='4766'>
   REAL    ::  FKT,D1,D2,D9,D10,DID,R211,R21,R22,R6,R7,D11     , &amp;<a name='4767'>
               PI,H,FKQ,R210,AA,BB,PP,Q1,QS1,TS1,TQ2,TX2       , &amp;<a name='4768'>
               TDENOM<a name='4769'>
<a name='4770'>
   REAL    ::  C,CC,AA1,RHCS,H1, QGOLD<a name='4771'>
<a name='4772'>
   REAL,     DIMENSION(1:NZS)  ::                   cotso,rhtso<a name='4773'>
<a name='4774'>
   INTEGER ::  nzs1,nzs2,k,k1,kn,kk, iter<a name='4775'>
<a name='4776'>
<a name='4777'>
<font color=#447700>!-----------------------------------------------------------------<a name='4778'></font>
<a name='4779'>
        iter=0<a name='4780'>
<a name='4781'>
          NZS1=NZS-1<a name='4782'>
          NZS2=NZS-2<a name='4783'>
        dzstop=1./(ZSMAIN(2)-ZSMAIN(1))<a name='4784'>
<a name='4785'>
        qgold=qvg<a name='4786'>
<a name='4787'>
        do k=1,nzs<a name='4788'>
           cotso(k)=0.<a name='4789'>
           rhtso(k)=0.<a name='4790'>
        enddo<a name='4791'>
<font color=#447700>!******************************************************************************<a name='4792'></font>
<font color=#447700>!       COEFFICIENTS FOR THOMAS ALGORITHM FOR TSO<a name='4793'></font>
<font color=#447700>!******************************************************************************<a name='4794'></font>
<font color=#447700>!         did=2.*(ZSMAIN(nzs)-ZSHALF(nzs))<a name='4795'></font>
<font color=#447700>!         h1=DTDZS(8)*THDIF(nzs-1)*(ZSHALF(nzs)-ZSHALF(nzs-1))/did<a name='4796'></font>
<font color=#447700>!         cotso(1)=h1/(1.+h1)<a name='4797'></font>
<font color=#447700>!         rhtso(1)=(tso(nzs)+h1*(tso(nzs-1)-tso(nzs)))/<a name='4798'></font>
<font color=#447700>!     1         (1.+h1)<a name='4799'></font>
        cotso(1)=0.<a name='4800'>
        rhtso(1)=TSO(NZS)<a name='4801'>
        DO 33 K=1,NZS2<a name='4802'>
          KN=NZS-K<a name='4803'>
          K1=2*KN-3<a name='4804'>
          X1=DTDZS(K1)*THDIF(KN-1)<a name='4805'>
          X2=DTDZS(K1+1)*THDIF(KN)<a name='4806'>
          FT=TSO(KN)+X1*(TSO(KN-1)-TSO(KN))                             &amp;<a name='4807'>
             -X2*(TSO(KN)-TSO(KN+1))<a name='4808'>
          DENOM=1.+X1+X2-X2*cotso(K)<a name='4809'>
          cotso(K+1)=X1/DENOM<a name='4810'>
          rhtso(K+1)=(FT+X2*rhtso(K))/DENOM<a name='4811'>
   33  CONTINUE<a name='4812'>
<a name='4813'>
<font color=#447700>!************************************************************************<a name='4814'></font>
<font color=#447700>!--- THE HEAT BALANCE EQUATION (Smirnova et al., 1996, EQ. 21,26)<a name='4815'></font>
<a name='4816'>
        RHCS=CAP(1)<a name='4817'>
<a name='4818'>
        H=MAVAIL<a name='4819'>
<a name='4820'>
        TRANS=TRANSUM*DRYCAN/ZSHALF(NROOT+1)<a name='4821'>
        CAN=WETCAN+TRANS<a name='4822'>
        UMVEG=(1.-VEGFRAC) * soilres<a name='4823'>
 2111   continue<a name='4824'>
        FKT=TKMS<a name='4825'>
        D1=cotso(NZS1)<a name='4826'>
        D2=rhtso(NZS1)<a name='4827'>
        TN=SOILT<a name='4828'>
        D9=THDIF(1)*RHCS*dzstop<a name='4829'>
        D10=TKMS*CP*RHO<a name='4830'>
        R211=.5*CONFLX/DELT<a name='4831'>
        R21=R211*CP*RHO<a name='4832'>
        R22=.5/(THDIF(1)*DELT*dzstop**2)<a name='4833'>
        R6=EMISS *STBOLT*.5*TN**4<a name='4834'>
        R7=R6/TN<a name='4835'>
        D11=RNET+R6<a name='4836'>
        TDENOM=D9*(1.-D1+R22)+D10+R21+R7                              &amp;<a name='4837'>
              +RAINF*CVW*PRCPMS<a name='4838'>
        FKQ=QKMS*RHO<a name='4839'>
        R210=R211*RHO<a name='4840'>
        C=VEGFRAC*FKQ*CAN<a name='4841'>
        CC=C*XLV/TDENOM<a name='4842'>
        AA=XLV*(FKQ*UMVEG+R210)/TDENOM<a name='4843'>
        BB=(D10*TABS+R21*TN+XLV*(QVATM*                               &amp;<a name='4844'>
        (FKQ*UMVEG+C)                                                 &amp; <a name='4845'>
        +R210*QVG)+D11+D9*(D2+R22*TN)                                 &amp;<a name='4846'>
        +RAINF*CVW*PRCPMS*max(273.15,TABS)                            &amp;<a name='4847'>
         )/TDENOM<a name='4848'>
        AA1=AA+CC<a name='4849'>
<font color=#447700>!        AA1=AA*alfa+CC<a name='4850'></font>
        PP=PATM*1.E3<a name='4851'>
        AA1=AA1/PP<a name='4852'>
        CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#VILKA'>VILKA</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILTEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VILKA_3">(TN,AA1,BB,PP,QS1,TS1,TBQ,KTAU,i,j,iland,isoil)<a name='4853'>
        TQ2=QVATM<a name='4854'>
        TX2=TQ2*(1.-H)<a name='4855'>
        Q1=TX2+H*QS1<a name='4856'>
<font color=#447700>!        Q1=alfa*QS1<a name='4857'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4858'>
<font color=#447700>!    if (i==421.and.j==280) then<a name='4859'></font>
        print *,'VILKA1 - TS1,QS1,TQ2,H,TX2,Q1',TS1,QS1,TQ2,H,TX2,Q1<a name='4860'>
    ENDIF<a name='4861'>
<font color=#447700>!with alfa        go to 100<a name='4862'></font>
        IF(Q1.LT.QS1) GOTO 100<a name='4863'>
<font color=#447700>!--- if no saturation - goto 100<a name='4864'></font>
<font color=#447700>!--- if saturation - goto 90<a name='4865'></font>
   90   QVG=QS1<a name='4866'>
        QSG=QS1<a name='4867'>
        TSO(1)=TS1<a name='4868'>
        QCG=max(0.,Q1-QS1)<a name='4869'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4870'>
<font color=#447700>!    if (i==421.and.j==280) then<a name='4871'></font>
        print *,'90 QVG,QSG,QCG,TSO(1)',QVG,QSG,QCG,TSO(1)<a name='4872'>
    ENDIF<a name='4873'>
        GOTO 200<a name='4874'>
  100   BB=BB-AA*TX2<a name='4875'>
        AA=(AA*H+CC)/PP<a name='4876'>
        CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#VILKA'>VILKA</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILTEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VILKA_4">(TN,AA,BB,PP,QS1,TS1,TBQ,KTAU,i,j,iland,isoil)<a name='4877'>
        Q1=TX2+H*QS1<a name='4878'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4879'>
<font color=#447700>!     if(i.eq.279.and.j.eq.263) then<a name='4880'></font>
<font color=#447700>!    if (i==421.and.j==280) then<a name='4881'></font>
        print *,'VILKA2 - TS1,QS1,TQ2,H,TX2,Q1',TS1,QS1,TQ2,H,TX2,Q1<a name='4882'>
    ENDIF<a name='4883'>
        IF(Q1.GE.QS1) GOTO 90<a name='4884'>
<font color=#447700>!with alfa  100  continue<a name='4885'></font>
        QSG=QS1<a name='4886'>
        QVG=Q1<a name='4887'>
<font color=#447700>!   if( QS1&gt;QVATM .and. QVATM &gt; QVG) then<a name='4888'></font>
<font color=#447700>! very dry soil <a name='4889'></font>
<font color=#447700>!     print *,'very dry soils mavail,qvg,qs1,qvatm,ts1',i,j,mavail,qvg,qs1,qvatm,ts1<a name='4890'></font>
<font color=#447700>!        QVG = QVATM<a name='4891'></font>
<font color=#447700>!   endif<a name='4892'></font>
        TSO(1)=TS1<a name='4893'>
        QCG=0.<a name='4894'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4895'>
<font color=#447700>!    if (i==421.and.j==280) then<a name='4896'></font>
       print *,'q1,qsg,qvg,qvatm,alfa,h',q1,qsg,qvg,qvatm,alfa,h<a name='4897'>
    endif<a name='4898'>
  200   CONTINUE<a name='4899'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4900'>
        print *,'200 QVG,QSG,QCG,TSO(1)',QVG,QSG,QCG,TSO(1)<a name='4901'>
    ENDIF<a name='4902'>
<a name='4903'>
  if(qvatm &gt; QSG .and. iter==0) then<a name='4904'>
<font color=#447700>!condensation regime<a name='4905'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4906'>
     print *,'turn off canopy evaporation and transpiration'<a name='4907'>
     print *,' QVATM,QVG,QSG,TS1',QVATM,QVG,QSG,TS1<a name='4908'>
    ENDIF<a name='4909'>
      can=0.<a name='4910'>
      umveg=1.<a name='4911'>
      iter=1<a name='4912'>
      goto 2111<a name='4913'>
  endif<a name='4914'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4915'>
     if(iter == 1) then<a name='4916'>
      print *,'QVATM,QVG,QSG,QCG,TS1',QVATM,QVG,QSG,QCG,TS1<a name='4917'>
     endif<a name='4918'>
    ENDIF<a name='4919'>
<a name='4920'>
<font color=#447700>!--- SOILT - skin temperature<a name='4921'></font>
          SOILT=TS1<a name='4922'>
<a name='4923'>
<font color=#447700>!---- Final solution for soil temperature - TSO<a name='4924'></font>
          DO K=2,NZS<a name='4925'>
            KK=NZS-K+1<a name='4926'>
            TSO(K)=rhtso(KK)+cotso(KK)*TSO(K-1)<a name='4927'>
          END DO<a name='4928'>
<a name='4929'>
         X= (cp*rho*r211+rhcs*zsmain(2)*0.5/delt)*(SOILT-TN) + &amp;<a name='4930'>
            XLV*rho*r211*(QVG-QGOLD) <a name='4931'>
<font color=#447700>!<a name='4932'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4933'>
        print*,'SOILTEMP storage, i,j,x,soilt,tn,qvg,qvgold', &amp;<a name='4934'>
                                  i,j,x,soilt,tn,qvg,qgold<a name='4935'>
        print *,'TEMP term (cp*rho*r211+rhcs*zsmain(2)*0.5/delt)*(SOILT-TN)',&amp;<a name='4936'>
                 (cp*rho*r211+rhcs*zsmain(2)*0.5/delt)*(SOILT-TN)<a name='4937'>
        print *,'QV term XLV*rho*r211*(QVG-QGOLD)',XLV*rho*r211*(QVG-QGOLD)<a name='4938'>
    ENDIF<a name='4939'>
         X=X &amp;<a name='4940'>
<font color=#447700>! "heat" from rain<a name='4941'></font>
        -RAINF*CVW*PRCPMS*(max(273.15,TABS)-SOILT)<a name='4942'>
<a name='4943'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='4944'>
        print *,'x=',x<a name='4945'>
    ENDIF<a name='4946'>
<a name='4947'>
<font color=#447700>!--------------------------------------------------------------------<a name='4948'></font>
   END SUBROUTINE SOILTEMP<a name='4949'>
<font color=#447700>!--------------------------------------------------------------------<a name='4950'></font>
<a name='4951'>
<a name='4952'>
<A NAME='SNOWTEMP'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWTEMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4953'>
           <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWTEMP</font>(                                    &amp;  <A href='../../call_to/SNOWTEMP.html' TARGET='index'>1</A>,<A href='../../call_from/SNOWTEMP.html' TARGET='index'>2</A><a name='4954'>
<font color=#447700>!--- input variables<a name='4955'></font>
           i,j,iland,isoil,                                        &amp;<a name='4956'>
           delt,ktau,conflx,nzs,nddzs,nroot,                       &amp;<a name='4957'>
           snwe,snwepr,snhei,newsnow,snowfrac,                     &amp;<a name='4958'>
           beta,deltsn,snth,rhosn,rhonewsn,meltfactor,             &amp;  <font color=#447700>! add meltfactor<a name='4959'></font>
           PRCPMS,RAINF,                                           &amp;<a name='4960'>
           PATM,TABS,QVATM,QCATM,                                  &amp;<a name='4961'>
           GLW,GSW,EMISS,RNET,                                     &amp;<a name='4962'>
           QKMS,TKMS,PC,RHO,VEGFRAC,                               &amp;<a name='4963'>
           THDIF,CAP,DRYCAN,WETCAN,CST,                            &amp;<a name='4964'>
           TRANF,TRANSUM,DEW,MAVAIL,                               &amp;<a name='4965'>
<font color=#447700>!--- soil fixed fields<a name='4966'></font>
           DQM,QMIN,PSIS,BCLH,                                     &amp;<a name='4967'>
           ZSMAIN,ZSHALF,DTDZS,TBQ,                                &amp;<a name='4968'>
<font color=#447700>!--- constants<a name='4969'></font>
           XLVM,CP,rovcp,G0_P,CVW,STBOLT,                          &amp;<a name='4970'>
<font color=#447700>!--- output variables<a name='4971'></font>
           SNWEPRINT,SNHEIPRINT,RSM,                               &amp;<a name='4972'>
           TSO,SOILT,SOILT1,TSNAV,QVG,QSG,QCG,                     &amp;<a name='4973'>
           SMELT,SNOH,SNFLX,S,ILNB,X)<a name='4974'>
<a name='4975'>
<font color=#447700>!********************************************************************<a name='4976'></font>
<font color=#447700>!   Energy budget equation and heat diffusion eqn are <a name='4977'></font>
<font color=#447700>!   solved here to obtain snow and soil temperatures<a name='4978'></font>
<font color=#447700>!<a name='4979'></font>
<font color=#447700>!     DELT - time step (s)<a name='4980'></font>
<font color=#447700>!     ktau - numver of time step<a name='4981'></font>
<font color=#447700>!     CONFLX - depth of constant flux layer (m)<a name='4982'></font>
<font color=#447700>!     IME, JME, KME, NZS - dimensions of the domain <a name='4983'></font>
<font color=#447700>!     NROOT - number of levels within the root zone<a name='4984'></font>
<font color=#447700>!     PRCPMS - precipitation rate in m/s<a name='4985'></font>
<font color=#447700>!     COTSO, RHTSO - coefficients for implicit solution of<a name='4986'></font>
<font color=#447700>!                     heat diffusion equation<a name='4987'></font>
<font color=#447700>!     THDIF - thermal diffusivity (W/m/K)<a name='4988'></font>
<font color=#447700>!     QSG,QVG,QCG - saturated mixing ratio, mixing ratio of<a name='4989'></font>
<font color=#447700>!                   water vapor and cloud at the ground<a name='4990'></font>
<font color=#447700>!                   surface, respectively (kg/kg)<a name='4991'></font>
<font color=#447700>!     PATM - pressure [bar]<a name='4992'></font>
<font color=#447700>!     QCATM,QVATM - cloud and water vapor mixing ratio<a name='4993'></font>
<font color=#447700>!                   at the first atm. level (kg/kg)<a name='4994'></font>
<font color=#447700>!     EMISS,RNET - emissivity (0-1) of the ground surface and net<a name='4995'></font>
<font color=#447700>!                  radiation at the surface (W/m^2)<a name='4996'></font>
<font color=#447700>!     QKMS - exchange coefficient for water vapor in the<a name='4997'></font>
<font color=#447700>!              surface layer (m/s)<a name='4998'></font>
<font color=#447700>!     TKMS - exchange coefficient for heat in the surface<a name='4999'></font>
<font color=#447700>!              layer (m/s)<a name='5000'></font>
<font color=#447700>!     PC - plant coefficient (resistance)<a name='5001'></font>
<font color=#447700>!     RHO - density of atmosphere near surface (kg/m^3)<a name='5002'></font>
<font color=#447700>!     VEGFRAC - greeness fraction (0-1)<a name='5003'></font>
<font color=#447700>!     CAP - volumetric heat capacity (J/m^3/K)<a name='5004'></font>
<font color=#447700>!     DRYCAN - dry fraction of vegetated area where<a name='5005'></font>
<font color=#447700>!              transpiration may take place (0-1) <a name='5006'></font>
<font color=#447700>!     WETCAN - fraction of vegetated area covered by canopy<a name='5007'></font>
<font color=#447700>!              water (0-1)<a name='5008'></font>
<font color=#447700>!     TRANSUM - transpiration function integrated over the <a name='5009'></font>
<font color=#447700>!               rooting zone (m)<a name='5010'></font>
<font color=#447700>!     DEW -  dew in kg/m^2/s<a name='5011'></font>
<font color=#447700>!     MAVAIL - fraction of maximum soil moisture in the top<a name='5012'></font>
<font color=#447700>!               layer (0-1)<a name='5013'></font>
<font color=#447700>!     ZSMAIN - main levels in soil (m)<a name='5014'></font>
<font color=#447700>!     ZSHALF - middle of the soil layers (m)<a name='5015'></font>
<font color=#447700>!     DTDZS - dt/(2.*dzshalf*dzmain)<a name='5016'></font>
<font color=#447700>!     TBQ - table to define saturated mixing ration<a name='5017'></font>
<font color=#447700>!           of water vapor for given temperature and pressure<a name='5018'></font>
<font color=#447700>!     TSO - soil temperature (K)<a name='5019'></font>
<font color=#447700>!     SOILT - skin temperature (K)<a name='5020'></font>
<font color=#447700>!<a name='5021'></font>
<font color=#447700>!*********************************************************************<a name='5022'></font>
<a name='5023'>
        IMPLICIT NONE<a name='5024'>
<font color=#447700>!---------------------------------------------------------------------<a name='5025'></font>
<font color=#447700>!--- input variables<a name='5026'></font>
<a name='5027'>
   INTEGER,  INTENT(IN   )   ::  nroot,ktau,nzs                , &amp;<a name='5028'>
                                 nddzs                             <font color=#447700>!nddzs=2*(nzs-2)<a name='5029'></font>
<a name='5030'>
   INTEGER,  INTENT(IN   )   ::  i,j,iland,isoil<a name='5031'>
   REAL,     INTENT(IN   )   ::  DELT,CONFLX,PRCPMS            , &amp;<a name='5032'>
                                 RAINF,NEWSNOW,DELTSN,SNTH     , &amp;<a name='5033'>
                                 TABS,TRANSUM,SNWEPR           , &amp;<a name='5034'>
                                 rhonewsn,meltfactor<a name='5035'>
   real                      ::  rhonewcsn<a name='5036'>
<a name='5037'>
<font color=#447700>!--- 3-D Atmospheric variables<a name='5038'></font>
   REAL,                                                         &amp;<a name='5039'>
            INTENT(IN   )    ::                            PATM, &amp;<a name='5040'>
                                                          QVATM, &amp;<a name='5041'>
                                                          QCATM<a name='5042'>
<font color=#447700>!--- 2-D variables<a name='5043'></font>
   REAL                                                        , &amp;<a name='5044'>
            INTENT(IN   )    ::                             GLW, &amp;<a name='5045'>
                                                            GSW, &amp;<a name='5046'>
                                                            RHO, &amp;<a name='5047'>
                                                             PC, &amp;<a name='5048'>
                                                        VEGFRAC, &amp;<a name='5049'>
                                                           QKMS, &amp;<a name='5050'>
                                                           TKMS<a name='5051'>
<a name='5052'>
<font color=#447700>!--- soil properties<a name='5053'></font>
   REAL                                                        , &amp;<a name='5054'>
            INTENT(IN   )    ::                                  &amp;<a name='5055'>
                                                           BCLH, &amp;<a name='5056'>
                                                            DQM, &amp;<a name='5057'>
                                                           PSIS, &amp;<a name='5058'>
                                                           QMIN<a name='5059'>
<a name='5060'>
   REAL,     INTENT(IN   )   ::                              CP, &amp;<a name='5061'>
                                                          ROVCP, &amp;<a name='5062'>
                                                            CVW, &amp;<a name='5063'>
                                                         STBOLT, &amp;<a name='5064'>
                                                           XLVM, &amp;<a name='5065'>
                                                            G0_P<a name='5066'>
<a name='5067'>
<a name='5068'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::            ZSMAIN, &amp;<a name='5069'>
                                                         ZSHALF, &amp;<a name='5070'>
                                                          THDIF, &amp;<a name='5071'>
                                                            CAP, &amp;<a name='5072'>
                                                          TRANF <a name='5073'>
<a name='5074'>
   REAL,     DIMENSION(1:NDDZS), INTENT(IN)  ::           DTDZS<a name='5075'>
<a name='5076'>
   REAL,     DIMENSION(1:5001), INTENT(IN)  ::              TBQ<a name='5077'>
<a name='5078'>
<a name='5079'>
<font color=#447700>!--- input/output variables<a name='5080'></font>
<font color=#447700>!-------- 3-d soil moisture and temperature<a name='5081'></font>
   REAL,     DIMENSION(  1:nzs )                               , &amp;<a name='5082'>
             INTENT(INOUT)   ::                             TSO<a name='5083'>
<a name='5084'>
<a name='5085'>
<font color=#447700>!-------- 2-d variables<a name='5086'></font>
   REAL                                                        , &amp;<a name='5087'>
             INTENT(INOUT)   ::                             DEW, &amp;<a name='5088'>
                                                            CST, &amp;<a name='5089'>
                                                          RHOSN, &amp;<a name='5090'>
                                                          EMISS, &amp;<a name='5091'>
                                                         MAVAIL, &amp;<a name='5092'>
                                                            QVG, &amp;<a name='5093'>
                                                            QSG, &amp;<a name='5094'>
                                                            QCG, &amp;<a name='5095'>
                                                           SNWE, &amp;<a name='5096'>
                                                          SNHEI, &amp;<a name='5097'>
                                                       SNOWFRAC, &amp;<a name='5098'>
                                                          SMELT, &amp;<a name='5099'>
                                                           SNOH, &amp;<a name='5100'>
                                                          SNFLX, &amp;<a name='5101'>
                                                              S, &amp;<a name='5102'>
                                                          SOILT, &amp;<a name='5103'>
                                                         SOILT1, &amp;<a name='5104'>
                                                          TSNAV<a name='5105'>
<a name='5106'>
   REAL,     INTENT(INOUT)                  ::   DRYCAN, WETCAN           <a name='5107'>
<a name='5108'>
   REAL,     INTENT(OUT)                    ::              RSM, &amp;<a name='5109'>
                                                      SNWEPRINT, &amp;<a name='5110'>
                                                     SNHEIPRINT<a name='5111'>
   INTEGER,  INTENT(OUT)                    ::             ilnb<a name='5112'>
<font color=#447700>!--- Local variables<a name='5113'></font>
<a name='5114'>
<a name='5115'>
   INTEGER ::  nzs1,nzs2,k,k1,kn,kk<a name='5116'>
<a name='5117'>
   REAL    ::  x,x1,x2,x4,dzstop,can,ft,sph,                     &amp;<a name='5118'>
               tn,trans,umveg,denom<a name='5119'>
<a name='5120'>
   REAL    ::  cotsn,rhtsn,xsn1,ddzsn1,x1sn1,ftsnow,denomsn<a name='5121'>
<a name='5122'>
   REAL    ::  t3,upflux,xinet,ras,                              &amp;<a name='5123'>
               xlmelt,rhocsn,thdifsn,                            &amp;<a name='5124'>
               beta,epot,xsn,ddzsn,x1sn,d1sn,d2sn,d9sn,r22sn<a name='5125'>
<a name='5126'>
   REAL    ::  fso,fsn,                                          &amp;<a name='5127'>
               FKT,D1,D2,D9,D10,DID,R211,R21,R22,R6,R7,D11,      &amp;<a name='5128'>
               PI,H,FKQ,R210,AA,BB,PP,Q1,QS1,TS1,TQ2,TX2,        &amp;<a name='5129'>
               TDENOM,C,CC,AA1,RHCS,H1,                          &amp;<a name='5130'>
               tsob, snprim, sh1, sh2,                           &amp;<a name='5131'>
               smeltg,snohg,snodif,soh,                          &amp;<a name='5132'>
               CMC2MS,TNOLD,QGOLD,SNOHGNEW                            <a name='5133'>
<a name='5134'>
   REAL,     DIMENSION(1:NZS)  ::  transp,cotso,rhtso<a name='5135'>
   REAL                        ::                         edir1, &amp;<a name='5136'>
                                                            ec1, &amp;<a name='5137'>
                                                           ett1, &amp;<a name='5138'>
                                                           eeta, &amp;<a name='5139'>
                                                            qfx, &amp;<a name='5140'>
                                                            hfx<a name='5141'>
<a name='5142'>
   REAL                        :: RNET,rsmfrac,soiltfrac,hsn,rr<a name='5143'>
   integer                     ::      nmelt, iter<a name='5144'>
<a name='5145'>
<font color=#447700>!-----------------------------------------------------------------<a name='5146'></font>
<a name='5147'>
       iter = 0<a name='5148'>
<a name='5149'>
       do k=1,nzs<a name='5150'>
          transp   (k)=0.<a name='5151'>
          cotso    (k)=0.<a name='5152'>
          rhtso    (k)=0.<a name='5153'>
       enddo<a name='5154'>
<a name='5155'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5156'>
print *, 'SNOWTEMP: SNHEI,SNTH,SOILT1: ',SNHEI,SNTH,SOILT1,soilt <a name='5157'>
    ENDIF<a name='5158'>
        XLMELT=3.35E+5<a name='5159'>
        RHOCSN=2090.* RHOSN<a name='5160'>
<font color=#447700>!18apr08 - add rhonewcsn<a name='5161'></font>
        RHOnewCSN=2090.* RHOnewSN<a name='5162'>
        THDIFSN = 0.265/RHOCSN<a name='5163'>
        RAS=RHO*1.E-3<a name='5164'>
<a name='5165'>
        SOILTFRAC=SOILT<a name='5166'>
<a name='5167'>
        SMELT=0.<a name='5168'>
        SOH=0.<a name='5169'>
        SMELTG=0.<a name='5170'>
        SNOHG=0.<a name='5171'>
        SNODIF=0.<a name='5172'>
        RSM = 0.<a name='5173'>
        RSMFRAC = 0.<a name='5174'>
        fsn=1.<a name='5175'>
        fso=0.<a name='5176'>
<font color=#447700>!        hsn=snhei<a name='5177'></font>
<a name='5178'>
          NZS1=NZS-1<a name='5179'>
          NZS2=NZS-2<a name='5180'>
<a name='5181'>
        QGOLD=QVG<a name='5182'>
        DZSTOP=1./(ZSMAIN(2)-ZSMAIN(1))<a name='5183'>
<a name='5184'>
<font color=#447700>!******************************************************************************<a name='5185'></font>
<font color=#447700>!       COEFFICIENTS FOR THOMAS ALGORITHM FOR TSO<a name='5186'></font>
<font color=#447700>!******************************************************************************<a name='5187'></font>
<font color=#447700>!         did=2.*(ZSMAIN(nzs)-ZSHALF(nzs))<a name='5188'></font>
<font color=#447700>!         h1=DTDZS(8)*THDIF(nzs-1)*(ZSHALF(nzs)-ZSHALF(nzs-1))/did<a name='5189'></font>
<font color=#447700>!         cotso(1)=h1/(1.+h1)<a name='5190'></font>
<font color=#447700>!         rhtso(1)=(tso(nzs)+h1*(tso(nzs-1)-tso(nzs)))/<a name='5191'></font>
<font color=#447700>!     1         (1.+h1)<a name='5192'></font>
<a name='5193'>
        cotso(1)=0.<a name='5194'>
        rhtso(1)=TSO(NZS)<a name='5195'>
        DO 33 K=1,NZS2<a name='5196'>
          KN=NZS-K<a name='5197'>
          K1=2*KN-3<a name='5198'>
          X1=DTDZS(K1)*THDIF(KN-1)<a name='5199'>
          X2=DTDZS(K1+1)*THDIF(KN)<a name='5200'>
          FT=TSO(KN)+X1*(TSO(KN-1)-TSO(KN))                           &amp;<a name='5201'>
             -X2*(TSO(KN)-TSO(KN+1))<a name='5202'>
          DENOM=1.+X1+X2-X2*cotso(K)<a name='5203'>
          cotso(K+1)=X1/DENOM<a name='5204'>
          rhtso(K+1)=(FT+X2*rhtso(K))/DENOM<a name='5205'>
   33  CONTINUE<a name='5206'>
<font color=#447700>!--- THE NZS element in COTSO and RHTSO will be for snow<a name='5207'></font>
<font color=#447700>!--- There will be 2 layers in snow if it is deeper than DELTSN+SNTH<a name='5208'></font>
       IF(SNHEI.GE.SNTH) then<a name='5209'>
        if(snhei.le.DELTSN+SNTH) then<a name='5210'>
<font color=#447700>!-- 1-layer snow model<a name='5211'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5212'>
      print *,'1-layer - snth,snhei,deltsn',snth,snhei,deltsn<a name='5213'>
    ENDIF<a name='5214'>
         ilnb=1<a name='5215'>
         snprim=max(snth,snhei)<a name='5216'>
         tsob=tso(1)<a name='5217'>
         soilt1=tso(1)<a name='5218'>
         XSN = DELT/2./(zshalf(2)+0.5*SNPRIM)<a name='5219'>
         DDZSN = XSN / SNPRIM<a name='5220'>
         X1SN = DDZSN * thdifsn<a name='5221'>
         X2 = DTDZS(1)*THDIF(1)<a name='5222'>
         FT = TSO(1)+X1SN*(SOILT-TSO(1))                              &amp;<a name='5223'>
              -X2*(TSO(1)-TSO(2))<a name='5224'>
         DENOM = 1. + X1SN + X2 -X2*cotso(NZS1)<a name='5225'>
         cotso(NZS)=X1SN/DENOM<a name='5226'>
         rhtso(NZS)=(FT+X2*rhtso(NZS1))/DENOM<a name='5227'>
         cotsn=cotso(NZS)<a name='5228'>
         rhtsn=rhtso(NZS)<a name='5229'>
<font color=#447700>!*** Average temperature of snow pack (C)<a name='5230'></font>
         tsnav=0.5*(soilt+tso(1))                                     &amp;<a name='5231'>
                     -273.15<a name='5232'>
<a name='5233'>
        else<a name='5234'>
<font color=#447700>!-- 2 layers in snow, SOILT1 is temperasture at DELTSN depth<a name='5235'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5236'>
      print *,'2-layer - snth,snhei,deltsn',snth,snhei,deltsn<a name='5237'>
    ENDIF<a name='5238'>
         ilnb=2<a name='5239'>
         snprim=deltsn<a name='5240'>
         tsob=soilt1<a name='5241'>
         XSN = DELT/2./(0.5*deltsn)<a name='5242'>
         XSN1= DELT/2./(zshalf(2)+0.5*(SNHEI-DELTSN))<a name='5243'>
         DDZSN = XSN / DELTSN<a name='5244'>
         DDZSN1 = XSN1 / (SNHEI-DELTSN)<a name='5245'>
         X1SN = DDZSN * thdifsn<a name='5246'>
         X1SN1 = DDZSN1 * thdifsn<a name='5247'>
         X2 = DTDZS(1)*THDIF(1)<a name='5248'>
         FT = TSO(1)+X1SN1*(SOILT1-TSO(1))                            &amp;<a name='5249'>
              -X2*(TSO(1)-TSO(2))<a name='5250'>
         DENOM = 1. + X1SN1 + X2 - X2*cotso(NZS1)<a name='5251'>
         cotso(nzs)=x1sn1/denom<a name='5252'>
         rhtso(nzs)=(ft+x2*rhtso(nzs1))/denom<a name='5253'>
         ftsnow = soilt1+x1sn*(soilt-soilt1)                          &amp;<a name='5254'>
               -x1sn1*(soilt1-tso(1))<a name='5255'>
         denomsn = 1. + X1SN + X1SN1 - X1SN1*cotso(NZS)<a name='5256'>
         cotsn=x1sn/denomsn<a name='5257'>
         rhtsn=(ftsnow+X1SN1*rhtso(NZS))/denomsn<a name='5258'>
<font color=#447700>!*** Average temperature of snow pack (C)<a name='5259'></font>
         tsnav=0.5/snhei*((soilt+soilt1)*deltsn                       &amp;<a name='5260'>
                     +(soilt1+tso(1))*(SNHEI-DELTSN))                 &amp;<a name='5261'>
                     -273.15<a name='5262'>
        endif<a name='5263'>
       ENDIF<a name='5264'>
       IF(SNHEI.LT.SNTH.AND.SNHEI.GT.0.) then<a name='5265'>
<font color=#447700>!       IF(SNHEI.LT.SNTH.AND.SNHEI.GE.0.) then<a name='5266'></font>
<font color=#447700>!--- snow is too thin to be treated separately, therefore it<a name='5267'></font>
<font color=#447700>!--- is combined with the first soil layer.<a name='5268'></font>
         snprim=SNHEI+zsmain(2)<a name='5269'>
         fsn=SNHEI/snprim<a name='5270'>
         fso=1.-fsn<a name='5271'>
         soilt1=tso(1)<a name='5272'>
         tsob=tso(2)<a name='5273'>
         XSN = DELT/2./((zshalf(3)-zsmain(2))+0.5*snprim)<a name='5274'>
         DDZSN = XSN /snprim<a name='5275'>
         X1SN = DDZSN * (fsn*thdifsn+fso*thdif(1))<a name='5276'>
         X2=DTDZS(2)*THDIF(2)<a name='5277'>
         FT=TSO(2)+X1SN*(SOILT-TSO(2))-                              &amp;<a name='5278'>
                       X2*(TSO(2)-TSO(3))<a name='5279'>
         denom = 1. + x1sn + x2 - x2*cotso(nzs-2)<a name='5280'>
         cotso(nzs1) = x1sn/denom<a name='5281'>
         rhtso(nzs1)=(FT+X2*rhtso(NZS-2))/denom<a name='5282'>
         tsnav=0.5*(soilt+tso(1))                                    &amp;<a name='5283'>
                     -273.15<a name='5284'>
         cotso(NZS)=cotso(nzs1)<a name='5285'>
         rhtso(NZS)=rhtso(nzs1)<a name='5286'>
         cotsn=cotso(NZS)<a name='5287'>
         rhtsn=rhtso(NZS)<a name='5288'>
<a name='5289'>
       ENDIF<a name='5290'>
<a name='5291'>
<font color=#447700>!************************************************************************<a name='5292'></font>
<font color=#447700>!--- THE HEAT BALANCE EQUATION (Smirnova et al. 1996, EQ. 21,26)<a name='5293'></font>
<font color=#447700>!18apr08 nmelt is the flag for melting, and SNOH is heat of snow phase changes<a name='5294'></font>
       nmelt=0<a name='5295'>
       SNOH=0.<a name='5296'>
<a name='5297'>
        ETT1=0.<a name='5298'>
        EPOT=-QKMS*(QVATM-QGOLD)<a name='5299'>
        RHCS=CAP(1)<a name='5300'>
        H=1.<a name='5301'>
        TRANS=TRANSUM*DRYCAN/ZSHALF(NROOT+1)<a name='5302'>
        CAN=WETCAN+TRANS<a name='5303'>
        UMVEG=1.-VEGFRAC<a name='5304'>
        FKT=TKMS<a name='5305'>
        D1=cotso(NZS1)<a name='5306'>
        D2=rhtso(NZS1)<a name='5307'>
        TN=SOILT<a name='5308'>
        D9=THDIF(1)*RHCS*dzstop<a name='5309'>
        D10=TKMS*CP*RHO<a name='5310'>
        R211=.5*CONFLX/DELT<a name='5311'>
        R21=R211*CP*RHO<a name='5312'>
        R22=.5/(THDIF(1)*DELT*dzstop**2)<a name='5313'>
        R6=EMISS *STBOLT*.5*TN**4<a name='5314'>
        R7=R6/TN<a name='5315'>
        D11=RNET+R6<a name='5316'>
<a name='5317'>
      IF(SNHEI.GE.SNTH) THEN<a name='5318'>
        if(snhei.le.DELTSN+SNTH) then<a name='5319'>
<font color=#447700>!--- 1-layer snow<a name='5320'></font>
          D1SN = cotso(NZS)<a name='5321'>
          D2SN = rhtso(NZS)<a name='5322'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5323'>
      print *,'1 layer d1sn,d2sn',i,j,d1sn,d2sn<a name='5324'>
    ENDIF<a name='5325'>
        else<a name='5326'>
<font color=#447700>!--- 2-layer snow<a name='5327'></font>
          D1SN = cotsn<a name='5328'>
          D2SN = rhtsn<a name='5329'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5330'>
      print *,'2 layers d1sn,d2sn',i,j,d1sn,d2sn<a name='5331'>
    ENDIF<a name='5332'>
        endif<a name='5333'>
        D9SN= THDIFSN*RHOCSN / SNPRIM<a name='5334'>
        R22SN = SNPRIM*SNPRIM*0.5/(THDIFSN*DELT)<a name='5335'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5336'>
      print *,'1 or 2 layers D9sn,R22sn',d9sn,r22sn<a name='5337'>
    ENDIF<a name='5338'>
      ENDIF<a name='5339'>
<a name='5340'>
       IF(SNHEI.LT.SNTH.AND.SNHEI.GT.0.) then<a name='5341'>
<font color=#447700>!--- thin snow is combined with soil<a name='5342'></font>
         D1SN = D1<a name='5343'>
         D2SN = D2<a name='5344'>
         D9SN = (fsn*THDIFSN*RHOCSN+fso*THDIF(1)*RHCS)/              &amp;<a name='5345'>
                 snprim<a name='5346'>
         R22SN = snprim*snprim*0.5                                   &amp;<a name='5347'>
                 /((fsn*THDIFSN+fso*THDIF(1))*delt)<a name='5348'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5349'>
       print *,' Combined  D9SN,R22SN,D1SN,D2SN: ',D9SN,R22SN,D1SN,D2SN<a name='5350'>
    ENDIF<a name='5351'>
      ENDIF<a name='5352'>
      IF(SNHEI.eq.0.)then<a name='5353'>
<font color=#447700>!--- all snow is sublimated<a name='5354'></font>
        D9SN = D9<a name='5355'>
        R22SN = R22<a name='5356'>
        D1SN = D1<a name='5357'>
        D2SN = D2<a name='5358'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5359'>
        print *,' SNHEI = 0, D9SN,R22SN,D1SN,D2SN: ',D9SN,R22SN,D1SN,D2SN<a name='5360'>
    ENDIF<a name='5361'>
      ENDIF<a name='5362'>
<a name='5363'>
 2211   continue<a name='5364'>
<a name='5365'>
<font color=#447700>!18apr08  - the snow melt iteration start point<a name='5366'></font>
 212    continue<a name='5367'>
<a name='5368'>
<font color=#447700>!---- TDENOM for snow<a name='5369'></font>
        TDENOM = D9SN*(1.-D1SN +R22SN)+D10+R21+R7                    &amp;<a name='5370'>
              +RAINF*CVW*PRCPMS                                      &amp;<a name='5371'>
              +RHOnewCSN*NEWSNOW/DELT<a name='5372'>
<a name='5373'>
        FKQ=QKMS*RHO<a name='5374'>
        R210=R211*RHO<a name='5375'>
        C=VEGFRAC*FKQ*CAN<a name='5376'>
        CC=C*XLVM/TDENOM<a name='5377'>
        AA=XLVM*(BETA*FKQ*UMVEG+R210)/TDENOM<a name='5378'>
        BB=(D10*TABS+R21*TN+XLVM*(QVATM*                             &amp;<a name='5379'>
        (BETA*FKQ*UMVEG+C)                                           &amp;<a name='5380'>
        +R210*QGOLD)+D11+D9SN*(D2SN+R22SN*TN)                        &amp;<a name='5381'>
        +RAINF*CVW*PRCPMS*max(273.15,TABS)                           &amp;<a name='5382'>
        + RHOnewCSN*NEWSNOW/DELT*min(273.15,TABS)                    &amp;<a name='5383'>
         )/TDENOM<a name='5384'>
        AA1=AA+CC<a name='5385'>
        PP=PATM*1.E3<a name='5386'>
        AA1=AA1/PP<a name='5387'>
        BB=BB-SNOH/TDENOM<a name='5388'>
<a name='5389'>
        CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#VILKA'>VILKA</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWTEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VILKA_5">(TN,AA1,BB,PP,QS1,TS1,TBQ,KTAU,i,j,iland,isoil)<a name='5390'>
        TQ2=QVATM<a name='5391'>
        TX2=TQ2*(1.-H)<a name='5392'>
        Q1=TX2+H*QS1<a name='5393'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5394'>
     print *,'VILKA1 - TS1,QS1,TQ2,H,TX2,Q1',TS1,QS1,TQ2,H,TX2,Q1<a name='5395'>
    ENDIF<a name='5396'>
        IF(Q1.LT.QS1) GOTO 100<a name='5397'>
<font color=#447700>!--- if no saturation - goto 100<a name='5398'></font>
<font color=#447700>!--- if saturation - goto 90<a name='5399'></font>
   90   QVG=QS1<a name='5400'>
        QSG=QS1<a name='5401'>
        QCG=max(0.,Q1-QS1)<a name='5402'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5403'>
     print *,'90 QVG,QSG,QCG,TSO(1)',QVG,QSG,QCG,TSO(1)<a name='5404'>
    ENDIF<a name='5405'>
        GOTO 200<a name='5406'>
  100   BB=BB-AA*TX2<a name='5407'>
        AA=(AA*H+CC)/PP<a name='5408'>
        CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#VILKA'>VILKA</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#SNOWTEMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VILKA_6">(TN,AA,BB,PP,QS1,TS1,TBQ,KTAU,i,j,iland,isoil)<a name='5409'>
        Q1=TX2+H*QS1<a name='5410'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5411'>
     print *,'VILKA2 - TS1,QS1,H,TX2,Q1',TS1,QS1,TQ2,H,TX2,Q1<a name='5412'>
    ENDIF<a name='5413'>
        IF(Q1.GT.QS1) GOTO 90<a name='5414'>
        QSG=QS1<a name='5415'>
        QVG=Q1<a name='5416'>
        QCG=0.<a name='5417'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5418'>
     print *,'No Saturation QVG,QSG,QCG,TSO(1)',QVG,QSG,QCG,TSO(1)<a name='5419'>
    ENDIF<a name='5420'>
  200   CONTINUE<a name='5421'>
<a name='5422'>
  if(qvatm &gt; QSG .and. iter==0) then<a name='5423'>
<font color=#447700>!condensation regime<a name='5424'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5425'>
     print *,'SNOW turn off canopy evaporation and transpiration'<a name='5426'>
     print *,' QVATM,QVG,QSG,TS1',QVATM,QVG,QSG,TS1<a name='5427'>
    ENDIF<a name='5428'>
      can=0.<a name='5429'>
      umveg=1.<a name='5430'>
      iter=1<a name='5431'>
      goto 2211<a name='5432'>
  endif<a name='5433'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5434'>
     if(iter==1) then<a name='5435'>
       print *,'SNOW - QVATM,QVG,QSG,QCG,TS1',QVATM,QVG,QSG,QCG,TS1<a name='5436'>
     endif<a name='5437'>
    ENDIF<a name='5438'>
<a name='5439'>
<font color=#447700>!--- SOILT - skin temperature<a name='5440'></font>
        SOILT=TS1<a name='5441'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5442'>
     IF(i.eq.266.and.j.eq.447) then<a name='5443'>
            print *,'snwe,snhei,soilt,soilt1,tso',i,j,snwe,snhei,soilt,soilt1,tso<a name='5444'>
     endif<a name='5445'>
    ENDIF<a name='5446'>
<font color=#447700>! Solution for temperature at 7.5 cm depth and snow-soil interface<a name='5447'></font>
       IF(SNHEI.GE.SNTH) THEN<a name='5448'>
        if(snhei.gt.DELTSN+SNTH) then<a name='5449'>
<font color=#447700>!-- 2-layer snow model<a name='5450'></font>
          SOILT1=min(273.15,rhtsn+cotsn*SOILT)<a name='5451'>
          TSO(1)=rhtso(NZS)+cotso(NZS)*SOILT1<a name='5452'>
          tsob=soilt1<a name='5453'>
        else<a name='5454'>
<font color=#447700>!-- 1 layer in snow<a name='5455'></font>
          TSO(1)=rhtso(NZS)+cotso(NZS)*SOILT<a name='5456'>
          SOILT1=TSO(1)<a name='5457'>
          tsob=tso(1)<a name='5458'>
        endif<a name='5459'>
       ELSEIF (SNHEI &gt; 0. .and. SNHEI &lt; SNTH) THEN<a name='5460'>
<font color=#447700>! blended <a name='5461'></font>
         TSO(2)=rhtso(NZS1)+cotso(NZS1)*SOILT<a name='5462'>
         tso(1)=(tso(2)+(soilt-tso(2))*fso)<a name='5463'>
         SOILT1=TSO(1)<a name='5464'>
         tsob=TSO(2)<a name='5465'>
       ELSE<a name='5466'>
<font color=#447700>!-- very thin or zero snow. If snow is thin we suppose that<a name='5467'></font>
<font color=#447700>!--- tso(i,j,1)=SOILT, and later we recompute tso(i,j,1)<a name='5468'></font>
         TSO(1)=SOILT<a name='5469'>
         SOILT1=SOILT<a name='5470'>
         tsob=TSO(1)<a name='5471'>
<font color=#447700>!new         tsob=tso(2)<a name='5472'></font>
       ENDIF<a name='5473'>
<a name='5474'>
<font color=#447700>!---- Final solution for TSO<a name='5475'></font>
       IF (SNHEI &gt; 0. .and. SNHEI &lt; SNTH) THEN<a name='5476'>
<font color=#447700>! blended or snow is melted<a name='5477'></font>
          DO K=3,NZS<a name='5478'>
            KK=NZS-K+1<a name='5479'>
            TSO(K)=rhtso(KK)+cotso(KK)*TSO(K-1)<a name='5480'>
          END DO<a name='5481'>
<a name='5482'>
       ELSE<a name='5483'>
          DO K=2,NZS<a name='5484'>
            KK=NZS-K+1<a name='5485'>
            TSO(K)=rhtso(KK)+cotso(KK)*TSO(K-1)<a name='5486'>
          END DO<a name='5487'>
       ENDIF<a name='5488'>
<font color=#447700>!--- For thin snow layer combined with the top soil layer<a name='5489'></font>
<font color=#447700>!--- TSO(1) is recomputed by linear interpolation between SOILT<a name='5490'></font>
<font color=#447700>!--- and TSO(i,j,2)<a name='5491'></font>
<font color=#447700>!       if(SNHEI.LT.SNTH.AND.SNHEI.GT.0.)then<a name='5492'></font>
<font color=#447700>!          tso(1)=tso(2)+(soilt-tso(2))*fso<a name='5493'></font>
<font color=#447700>!          soilt1=tso(1)<a name='5494'></font>
<font color=#447700>!          tsob = tso(2)<a name='5495'></font>
<font color=#447700>!       endif<a name='5496'></font>
<a name='5497'>
<a name='5498'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5499'>
<font color=#447700>!    IF(i.eq.266.and.j.eq.447) then<a name='5500'></font>
   print *,'SOILT,SOILT1,tso,TSOB,QSG',i,j,SOILT,SOILT1,tso,TSOB,QSG,'nmelt=',nmelt<a name='5501'>
    ENDIF<a name='5502'>
<a name='5503'>
     if(nmelt.eq.1) go to 220<a name='5504'>
<a name='5505'>
<font color=#447700>!--- IF SOILT &gt; 273.15 F then melting of snow can happen<a name='5506'></font>
<font color=#447700>!   IF(SOILT.GT.273.15.AND.SNHEI.GT.0.) THEN<a name='5507'></font>
<font color=#447700>! if all snow can evaporate, then there is nothing to melt<a name='5508'></font>
   IF(SOILT.GT.273.15.AND.SNWEPR-BETA*EPOT*RAS*DELT.GT.0.AND.SNHEI.GT.0.) THEN<a name='5509'>
        nmelt = 1<a name='5510'>
        soiltfrac=snowfrac*273.15+(1.-snowfrac)*SOILT<a name='5511'>
        QSG=min(QSG, QSN(soiltfrac,TBQ)/PP)<a name='5512'>
        qvg=qsg<a name='5513'>
        T3      = STBOLT*TN*TN*TN<a name='5514'>
        UPFLUX  = T3 * 0.5*(TN + SOILTfrac)<a name='5515'>
        XINET   = EMISS*(GLW-UPFLUX)<a name='5516'>
<font color=#447700>!        RNET = GSW + XINET<a name='5517'></font>
         EPOT = -QKMS*(QVATM-QSG)<a name='5518'>
         Q1=EPOT*RAS<a name='5519'>
<a name='5520'>
        IF (Q1.LE.0..or.iter==1) THEN<a name='5521'>
<font color=#447700>! ---  condensation<a name='5522'></font>
          DEW=-EPOT<a name='5523'>
          DO K=1,NZS<a name='5524'>
            TRANSP(K)=0.<a name='5525'>
          ENDDO<a name='5526'>
<a name='5527'>
        QFX = -XLVM*RHO*DEW<a name='5528'>
        EETA = QFX/XLVM<a name='5529'>
       ELSE<a name='5530'>
<font color=#447700>! ---  evaporation<a name='5531'></font>
          DO K=1,NROOT<a name='5532'>
            TRANSP(K)=-VEGFRAC*q1                                     &amp;<a name='5533'>
                      *TRANF(K)*DRYCAN/zshalf(NROOT+1)<a name='5534'>
<font color=#447700>!           IF(TRANSP(K).GT.0.) TRANSP(K)=0.<a name='5535'></font>
            ETT1=ETT1-TRANSP(K)<a name='5536'>
          ENDDO<a name='5537'>
          DO k=nroot+1,nzs<a name='5538'>
            transp(k)=0.<a name='5539'>
          enddo<a name='5540'>
<a name='5541'>
        EDIR1 = Q1*UMVEG * BETA<a name='5542'>
        EC1 = Q1 * WETCAN * vegfrac<a name='5543'>
        CMC2MS=CST/DELT*RAS<a name='5544'>
<font color=#447700>!        EC1=MIN(CMC2MS,EC1)<a name='5545'></font>
        EETA = (EDIR1 + EC1 + ETT1)*1.E3<a name='5546'>
<font color=#447700>! to convert from kg m-2 s-1 to m s-1: 1/rho water=1.e-3************ <a name='5547'></font>
        QFX=  XLVM * EETA<a name='5548'>
       ENDIF<a name='5549'>
<a name='5550'>
         HFX=-D10*(TABS-soiltfrac)<a name='5551'>
<a name='5552'>
       IF(SNHEI.GE.SNTH)then<a name='5553'>
         SOH=thdifsn*RHOCSN*(soiltfrac-TSOB)/SNPRIM<a name='5554'>
         SNFLX=SOH<a name='5555'>
       ELSE<a name='5556'>
         SOH=(fsn*thdifsn*rhocsn+fso*thdif(1)*rhcs)*                   &amp;<a name='5557'>
              (soiltfrac-TSOB)/snprim<a name='5558'>
         SNFLX=SOH<a name='5559'>
       ENDIF<a name='5560'>
<a name='5561'>
<font color=#447700>!<a name='5562'></font>
         X= (R21+D9SN*R22SN)*(soiltfrac-TN) +                        &amp;<a name='5563'>
            XLVM*R210*(QVG-QGOLD)<a name='5564'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5565'>
      print *,'SNOWTEMP storage ',i,j,x<a name='5566'>
      print *,'R21,D9sn,r22sn,soiltfrac,tn,qsg,qvg,qgold,snprim', &amp;<a name='5567'>
              R21,D9sn,r22sn,soiltfrac,tn,qsg,qvg,qgold,snprim<a name='5568'>
    ENDIF<a name='5569'>
<a name='5570'>
<font color=#447700>!-- SNOH is energy flux of snow phase change<a name='5571'></font>
        SNOH=RNET-QFX -HFX - SOH - X                                    &amp; <a name='5572'>
                  +RHOnewCSN*NEWSNOW/DELT*(min(273.15,TABS)-soiltfrac)  &amp;<a name='5573'>
                  +RAINF*CVW*PRCPMS*(max(273.15,TABS)-soiltfrac) <a name='5574'>
        SNOH=AMAX1(0.,SNOH)<a name='5575'>
<font color=#447700>!-- SMELT is speed of melting in M/S<a name='5576'></font>
        SMELT= SNOH /XLMELT*1.E-3<a name='5577'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5578'>
      print *,'1- SMELT',i,j,smelt<a name='5579'>
    ENDIF<a name='5580'>
        SMELT=AMIN1(SMELT,SNWEPR/DELT-BETA*EPOT*RAS)<a name='5581'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5582'>
      print *,'2- SMELT',i,j,smelt<a name='5583'>
    ENDIF<a name='5584'>
        SMELT=AMAX1(0.,SMELT)<a name='5585'>
<a name='5586'>
<font color=#447700>!18apr08 - Egglston limit<a name='5587'></font>
<font color=#447700>!        SMELT= amin1 (smelt, 5.6E-7*meltfactor*max(1.,(soilt-273.15)))<a name='5588'></font>
        SMELT= amin1 (smelt, 5.6E-8*meltfactor*max(1.,(soilt-273.15)))<a name='5589'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5590'>
      print *,'3- SMELT',i,j,smelt<a name='5591'>
    ENDIF<a name='5592'>
<a name='5593'>
<font color=#447700>! rr - potential melting<a name='5594'></font>
        rr=max(0.,SNWEPR/delt-BETA*EPOT*RAS)<a name='5595'>
        SMELT=min(SMELT,rr)<a name='5596'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5597'>
      print *,'4- SMELT i,j,smelt,rr',i,j,smelt,rr<a name='5598'>
    ENDIF<a name='5599'>
        SNOHGNEW=SMELT*XLMELT*1.E3<a name='5600'>
        SNODIF=AMAX1(0.,(SNOH-SNOHGNEW))<a name='5601'>
<a name='5602'>
        SNOH=SNOHGNEW<a name='5603'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5604'>
      print *,'SNOH,SNODIF',SNOH,SNODIF<a name='5605'>
    ENDIF<a name='5606'>
<a name='5607'>
<font color=#447700>!*** From Koren et al. (1999) 13% of snow melt stays in the snow pack<a name='5608'></font>
        rsmfrac=min(0.18,(max(0.08,snwepr/0.10*0.13)))<a name='5609'>
       if(snhei &gt; 0.01) then<a name='5610'>
        rsm=rsmfrac*smelt*delt<a name='5611'>
       else<a name='5612'>
<font color=#447700>! do not keep melted water if snow depth is less that 1 cm<a name='5613'></font>
        rsm=0.<a name='5614'>
       endif<a name='5615'>
<font color=#447700>!18apr08 rsm is part of melted water that stays in snow as liquid<a name='5616'></font>
        SMELT=max(0.,SMELT-rsm/delt)<a name='5617'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5618'>
      print *,'5- SMELT i,j,smelt,rsm,snwepr,rsmfrac', &amp;<a name='5619'>
                        i,j,smelt,rsm,snwepr,rsmfrac<a name='5620'>
    ENDIF<a name='5621'>
<a name='5622'>
<font color=#447700>!-- update of liquid equivalent of snow depth<a name='5623'></font>
<font color=#447700>!-- due to evaporation and snow melt<a name='5624'></font>
        SNWE = AMAX1(0.,(SNWEPR-                                      &amp;<a name='5625'>
                    (SMELT+BETA*EPOT*RAS)*DELT                        &amp;<a name='5626'>
<font color=#447700>!                    (SMELT+BETA*EPOT*RAS)*DELT*snowfrac               &amp;<a name='5627'></font>
<font color=#447700>!                    (SMELT+BETA*EPOT*RAS*UMVEG)*DELT                 &amp;<a name='5628'></font>
                                         ) )<a name='5629'>
<font color=#447700>!--- If there is no snow melting then just evaporation<a name='5630'></font>
<font color=#447700>!--- or condensation cxhanges SNWE<a name='5631'></font>
      ELSE<a name='5632'>
       if(snhei.ne.0.) then<a name='5633'>
               EPOT=-QKMS*(QVATM-QSG)<a name='5634'>
               SNWE = AMAX1(0.,(SNWEPR-                               &amp;<a name='5635'>
                    BETA*EPOT*RAS*DELT))<a name='5636'>
<font color=#447700>!                    BETA*EPOT*RAS*DELT*snowfrac))<a name='5637'></font>
       endif<a name='5638'>
<a name='5639'>
      ENDIF<a name='5640'>
<font color=#447700>!18apr08 - if snow melt occurred then go into iteration for energy budget <a name='5641'></font>
<font color=#447700>!         solution <a name='5642'></font>
     if(nmelt.eq.1) goto 212  <font color=#447700>! second interation<a name='5643'></font>
 220  continue<a name='5644'>
<a name='5645'>
      if(smelt.gt.0..and.rsm.gt.0.) then<a name='5646'>
       if(snwe.le.rsm) then<a name='5647'>
    IF ( 1==1 ) THEN<a name='5648'>
     print *,'SNWE&lt;RSM snwe,rsm,smelt*delt,epot*ras*delt,beta', &amp;<a name='5649'>
                     snwe,rsm,smelt*delt,epot*ras*delt,beta<a name='5650'>
    ENDIF<a name='5651'>
       else<a name='5652'>
<font color=#447700>!*** Update snow density on effect of snow melt, melted<a name='5653'></font>
<font color=#447700>!*** from the top of the snow. 13% of melted water<a name='5654'></font>
<font color=#447700>!*** remains in the pack and changes its density.<a name='5655'></font>
<font color=#447700>!*** Eq. 9 (with my correction) in Koren et al. (1999)<a name='5656'></font>
          xsn=(rhosn*(snwe-rsm)+1.e3*rsm)/                            &amp;<a name='5657'>
              snwe<a name='5658'>
          rhosn=MIN(MAX(76.9,XSN),500.)<a name='5659'>
<a name='5660'>
          RHOCSN=2090.* RHOSN<a name='5661'>
          thdifsn = 0.265/RHOCSN<a name='5662'>
        endif  <a name='5663'>
       endif<a name='5664'>
<a name='5665'>
<font color=#447700>!--- Compute flux in the top snow layer<a name='5666'></font>
       IF(SNHEI.GE.SNTH)then<a name='5667'>
         S=thdifsn*RHOCSN*(soilt-TSOB)/SNPRIM<a name='5668'>
         SNFLX=S<a name='5669'>
         S=D9*(tso(1)-tso(2))<a name='5670'>
       ELSEIF(SNHEI.lt.SNTH.and.SNHEI.GT.0.) then<a name='5671'>
         S=(fsn*thdifsn*rhocsn+fso*thdif(1)*rhcs)*                   &amp;<a name='5672'>
              (soilt-TSOB)/snprim<a name='5673'>
         SNFLX=S<a name='5674'>
         S=D9*(tso(1)-tso(2))<a name='5675'>
       ELSE<a name='5676'>
         S=D9SN*(SOILT-TSOB)<a name='5677'>
         SNFLX=S<a name='5678'>
         S=D9*(tso(1)-tso(2))<a name='5679'>
       ENDIF<a name='5680'>
<a name='5681'>
        SNHEI=SNWE *1.E3 / RHOSN<a name='5682'>
<font color=#447700>!--  If ground surface temperature<a name='5683'></font>
<font color=#447700>!--  is above freezing snow can melt from the bottom. The following<a name='5684'></font>
<font color=#447700>!--  piece of code will check if bottom melting is possible.<a name='5685'></font>
<a name='5686'>
        IF(TSO(1).GT.273.15 .and. snhei &gt; 0.) THEN<a name='5687'>
          if (snhei.GT.deltsn+snth) then<a name='5688'>
              hsn = snhei - deltsn<a name='5689'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5690'>
       print*,'2 layer snow - snhei,hsn',snhei,hsn<a name='5691'>
    ENDIF<a name='5692'>
          else<a name='5693'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5694'>
       print*,'1 layer snow or blended - snhei',snhei<a name='5695'>
    ENDIF<a name='5696'>
              hsn = snhei<a name='5697'>
          endif<a name='5698'>
<a name='5699'>
         soiltfrac=snowfrac*273.15+(1.-snowfrac)*TSO(1)<a name='5700'>
<a name='5701'>
        SNOHG=(TSO(1)-soiltfrac)*(cap(1)*zshalf(2)+                       &amp;<a name='5702'>
               RHOCSN*0.5*hsn) / DELT<a name='5703'>
        SNOHG=AMAX1(0.,SNOHG)<a name='5704'>
        SNODIF=0.<a name='5705'>
        SMELTG=SNOHG/XLMELT*1.E-3<a name='5706'>
<font color=#447700>! Egglston - empirical limit on snow melt from the bottom of snow pack<a name='5707'></font>
        SMELTG=AMIN1(SMELTG, 5.8e-9)<a name='5708'>
<a name='5709'>
<font color=#447700>! rr - potential melting<a name='5710'></font>
        rr=SNWE/delt<a name='5711'>
        SMELTG=AMIN1(SMELTG, rr)<a name='5712'>
<a name='5713'>
        SNOHGNEW=SMELTG*XLMELT*1.e3<a name='5714'>
        SNODIF=AMAX1(0.,(SNOHG-SNOHGNEW))<a name='5715'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5716'>
<font color=#447700>!   if(i.eq.266.and.j.eq.447) then<a name='5717'></font>
       print *,'TSO(1),soiltfrac,smeltg,SNODIF',TSO(1),soiltfrac,smeltg,SNODIF<a name='5718'>
    ENDIF<a name='5719'>
<a name='5720'>
<font color=#447700>!        snwe=max(0.,snwe-smeltg*delt*snowfrac)<a name='5721'></font>
        snwe=max(0.,snwe-smeltg*delt)<a name='5722'>
        SNHEI=SNWE *1.E3 / RHOSN<a name='5723'>
      <a name='5724'>
        if(snhei &gt; 0.) TSO(1) = soiltfrac<a name='5725'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5726'>
<font color=#447700>!   if(i.eq.266.and.j.eq.447) then<a name='5727'></font>
       print *,'Melt from the bottom snwe,snhei',snwe,snhei<a name='5728'>
       if (snhei==0.) &amp;<a name='5729'>
       print *,'Snow is all melted on the warm ground'<a name='5730'>
    ENDIF<a name='5731'>
<a name='5732'>
       ENDIF<a name='5733'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5734'>
      print *,'SNHEI,SNOH',i,j,SNHEI,SNOH<a name='5735'>
    ENDIF<a name='5736'>
<font color=#447700>!                                              &amp;<a name='5737'></font>
        snweprint=snwe<a name='5738'>
        snheiprint=snweprint*1.E3 / RHOSN<a name='5739'>
<a name='5740'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5741'>
print *, 'snweprint : ',snweprint<a name='5742'>
print *, 'D9SN,SOILT,TSOB : ', D9SN,SOILT,TSOB<a name='5743'>
    ENDIF<a name='5744'>
<a name='5745'>
         X= (R21+D9SN*R22SN)*(soilt-TN) +                     &amp;<a name='5746'>
            XLVM*R210*(QSG-QGOLD)<a name='5747'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5748'>
      print *,'SNOWTEMP storage ',i,j,x<a name='5749'>
      print *,'R21,D9sn,r22sn,soiltfrac,soilt,tn,qsg,qgold,snprim', &amp;<a name='5750'>
              R21,D9sn,r22sn,soiltfrac,soilt,tn,qsg,qgold,snprim<a name='5751'>
    ENDIF<a name='5752'>
<a name='5753'>
         X=X &amp;<a name='5754'>
<font color=#447700>! "heat" from snow and rain<a name='5755'></font>
        -RHOnewCSN*NEWSNOW/DELT*(min(273.15,TABS)-SOILT)         &amp;<a name='5756'>
        -RAINF*CVW*PRCPMS*(max(273.15,TABS)-SOILT)<a name='5757'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5758'>
     print *,'x=',x<a name='5759'>
     print *,'SNHEI=',snhei<a name='5760'>
     print *,'SNFLX=',snflx<a name='5761'>
    ENDIF<a name='5762'>
<a name='5763'>
      IF(SNHEI.GT.0.) THEN<a name='5764'>
        if(ilnb.gt.1) then<a name='5765'>
          tsnav=0.5/snhei*((soilt+soilt1)*deltsn                     &amp;<a name='5766'>
                    +(soilt1+tso(1))*(SNHEI-DELTSN))                 &amp;<a name='5767'>
                       -273.15<a name='5768'>
        else<a name='5769'>
          tsnav=0.5*(soilt+tso(1)) - 273.15<a name='5770'>
        endif<a name='5771'>
      ELSE<a name='5772'>
          tsnav= soilt - 273.15<a name='5773'>
      ENDIF<a name='5774'>
<a name='5775'>
<font color=#447700>!------------------------------------------------------------------------<a name='5776'></font>
   END SUBROUTINE SNOWTEMP<a name='5777'>
<font color=#447700>!------------------------------------------------------------------------<a name='5778'></font>
<a name='5779'>
<a name='5780'>
<A NAME='SOILMOIST'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILMOIST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5781'>
        <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOILMOIST</font> (                                  &amp; <A href='../../call_to/SOILMOIST.html' TARGET='index'>2</A><a name='5782'>
<font color=#447700>!--input parameters<a name='5783'></font>
              DELT,NZS,NDDZS,DTDZS,DTDZS2,RIW,                  &amp;<a name='5784'>
              ZSMAIN,ZSHALF,DIFFU,HYDRO,                        &amp;<a name='5785'>
              QSG,QVG,QCG,QCATM,QVATM,PRCP,                     &amp;<a name='5786'>
              QKMS,TRANSP,DRIP,                                 &amp;<a name='5787'>
              DEW,SMELT,SOILICE,VEGFRAC,SNOWFRAC,soilres,       &amp;<a name='5788'>
<font color=#447700>!--soil properties<a name='5789'></font>
              DQM,QMIN,REF,KSAT,RAS,INFMAX,                     &amp;<a name='5790'>
<font color=#447700>!--output<a name='5791'></font>
              SOILMOIS,SOILIQW,MAVAIL,RUNOFF,RUNOFF2,INFILTRP)<a name='5792'>
<font color=#447700>!*************************************************************************<a name='5793'></font>
<font color=#447700>!   moisture balance equation and Richards eqn.<a name='5794'></font>
<font color=#447700>!   are solved here <a name='5795'></font>
<font color=#447700>!   <a name='5796'></font>
<font color=#447700>!     DELT - time step (s)<a name='5797'></font>
<font color=#447700>!     IME,JME,NZS - dimensions of soil domain<a name='5798'></font>
<font color=#447700>!     ZSMAIN - main levels in soil (m)<a name='5799'></font>
<font color=#447700>!     ZSHALF - middle of the soil layers (m)<a name='5800'></font>
<font color=#447700>!     DTDZS -  dt/(2.*dzshalf*dzmain)<a name='5801'></font>
<font color=#447700>!     DTDZS2 - dt/(2.*dzshalf)<a name='5802'></font>
<font color=#447700>!     DIFFU - diffusional conductivity (m^2/s)<a name='5803'></font>
<font color=#447700>!     HYDRO - hydraulic conductivity (m/s)<a name='5804'></font>
<font color=#447700>!     QSG,QVG,QCG - saturated mixing ratio, mixing ratio of<a name='5805'></font>
<font color=#447700>!                   water vapor and cloud at the ground<a name='5806'></font>
<font color=#447700>!                   surface, respectively (kg/kg)<a name='5807'></font>
<font color=#447700>!     QCATM,QVATM - cloud and water vapor mixing ratio<a name='5808'></font>
<font color=#447700>!                   at the first atm. level (kg/kg)<a name='5809'></font>
<font color=#447700>!     PRCP - precipitation rate in m/s<a name='5810'></font>
<font color=#447700>!     QKMS - exchange coefficient for water vapor in the<a name='5811'></font>
<font color=#447700>!              surface layer (m/s)<a name='5812'></font>
<font color=#447700>!     TRANSP - transpiration from the soil layers (m/s)<a name='5813'></font>
<font color=#447700>!     DRIP - liquid water dripping from the canopy to soil (m)<a name='5814'></font>
<font color=#447700>!     DEW -  dew in kg/m^2s<a name='5815'></font>
<font color=#447700>!     SMELT - melting rate in m/s<a name='5816'></font>
<font color=#447700>!     SOILICE - volumetric content of ice in soil (m^3/m^3)<a name='5817'></font>
<font color=#447700>!     SOILIQW - volumetric content of liquid water in soil (m^3/m^3)<a name='5818'></font>
<font color=#447700>!     VEGFRAC - greeness fraction (0-1)<a name='5819'></font>
<font color=#447700>!     RAS - ration of air density to soil density<a name='5820'></font>
<font color=#447700>!     INFMAX - maximum infiltration rate (kg/m^2/s)<a name='5821'></font>
<font color=#447700>!    <a name='5822'></font>
<font color=#447700>!     SOILMOIS - volumetric soil moisture, 6 levels (m^3/m^3)<a name='5823'></font>
<font color=#447700>!     MAVAIL - fraction of maximum soil moisture in the top<a name='5824'></font>
<font color=#447700>!               layer (0-1)<a name='5825'></font>
<font color=#447700>!     RUNOFF - surface runoff (m/s)<a name='5826'></font>
<font color=#447700>!     RUNOFF2 - underground runoff (m)<a name='5827'></font>
<font color=#447700>!     INFILTRP - point infiltration flux into soil (m/s)<a name='5828'></font>
<font color=#447700>!            /(snow bottom runoff) (mm/s)<a name='5829'></font>
<font color=#447700>!<a name='5830'></font>
<font color=#447700>!     COSMC, RHSMC - coefficients for implicit solution of<a name='5831'></font>
<font color=#447700>!                     Richards equation<a name='5832'></font>
<font color=#447700>!******************************************************************<a name='5833'></font>
        IMPLICIT NONE<a name='5834'>
<font color=#447700>!------------------------------------------------------------------<a name='5835'></font>
<font color=#447700>!--- input variables<a name='5836'></font>
   REAL,     INTENT(IN   )   ::  DELT<a name='5837'>
   INTEGER,  INTENT(IN   )   ::  NZS,NDDZS<a name='5838'>
<a name='5839'>
<font color=#447700>! input variables<a name='5840'></font>
<a name='5841'>
   REAL,     DIMENSION(1:NZS), INTENT(IN   )  ::         ZSMAIN, &amp;<a name='5842'>
                                                         ZSHALF, &amp;<a name='5843'>
                                                          DIFFU, &amp;<a name='5844'>
                                                          HYDRO, &amp;<a name='5845'>
                                                         TRANSP, &amp;<a name='5846'>
                                                        SOILICE, &amp;<a name='5847'>
                                                         DTDZS2<a name='5848'>
<a name='5849'>
   REAL,     DIMENSION(1:NDDZS), INTENT(IN)  ::           DTDZS<a name='5850'>
<a name='5851'>
   REAL,     INTENT(IN   )   ::    QSG,QVG,QCG,QCATM,QVATM     , &amp;<a name='5852'>
                                   QKMS,VEGFRAC,DRIP,PRCP      , &amp;<a name='5853'>
                                   DEW,SMELT,SNOWFRAC          , &amp;<a name='5854'>
                                   DQM,QMIN,REF,KSAT,RAS,RIW,SOILRES<a name='5855'>
                         <a name='5856'>
<font color=#447700>! output<a name='5857'></font>
<a name='5858'>
   REAL,     DIMENSION(  1:nzs )                               , &amp;<a name='5859'>
<a name='5860'>
             INTENT(INOUT)   ::                SOILMOIS,SOILIQW<a name='5861'>
                                                  <a name='5862'>
   REAL,     INTENT(INOUT)   ::  MAVAIL,RUNOFF,RUNOFF2,INFILTRP, &amp;<a name='5863'>
                                                        INFMAX<a name='5864'>
<a name='5865'>
<font color=#447700>! local variables<a name='5866'></font>
<a name='5867'>
   REAL,     DIMENSION( 1:nzs )  ::  COSMC,RHSMC<a name='5868'>
<a name='5869'>
   REAL    ::  DZS,R1,R2,R3,R4,R5,R6,R7,R8,R9,R10<a name='5870'>
   REAL    ::  REFKDT,REFDK,DELT1,F1MAX,F2MAX<a name='5871'>
   REAL    ::  F1,F2,FD,KDT,VAL,DDT,PX,FK,FKMAX<a name='5872'>
   REAL    ::  QQ,UMVEG,INFMAX1,TRANS<a name='5873'>
   REAL    ::  TOTLIQ,FLX,FLXSAT,QTOT<a name='5874'>
   REAL    ::  DID,X1,X2,X4,DENOM,Q2,Q4<a name='5875'>
   REAL    ::  dice,fcr,acrt,frzx,sum,cvfrz<a name='5876'>
<a name='5877'>
   INTEGER ::  NZS1,NZS2,K,KK,K1,KN,ialp1,jj,jk<a name='5878'>
<a name='5879'>
<font color=#447700>!******************************************************************************<a name='5880'></font>
<font color=#447700>!       COEFFICIENTS FOR THOMAS ALGORITHM FOR SOILMOIS<a name='5881'></font>
<font color=#447700>!******************************************************************************<a name='5882'></font>
          NZS1=NZS-1                                                            <a name='5883'>
          NZS2=NZS-2<a name='5884'>
<a name='5885'>
 118      format(6(10Pf23.19))<a name='5886'>
<a name='5887'>
           do k=1,nzs<a name='5888'>
            cosmc(k)=0.<a name='5889'>
            rhsmc(k)=0.<a name='5890'>
           enddo<a name='5891'>
 <a name='5892'>
        DID=(ZSMAIN(NZS)-ZSHALF(NZS))<a name='5893'>
        X1=ZSMAIN(NZS)-ZSMAIN(NZS1)<a name='5894'>
<a name='5895'>
<font color=#447700>!7may09        DID=(ZSMAIN(NZS)-ZSHALF(NZS))*2.<a name='5896'></font>
<font color=#447700>!        DENOM=DID/DELT+DIFFU(NZS1)/X1<a name='5897'></font>
<font color=#447700>!        COSMC(1)=DIFFU(NZS1)/X1/DENOM<a name='5898'></font>
<font color=#447700>!        RHSMC(1)=(SOILMOIS(NZS)*DID/DELT<a name='5899'></font>
<font color=#447700>!     1   +TRANSP(NZS)-(HYDRO(NZS)*SOILMOIS(NZS)<a name='5900'></font>
<font color=#447700>!     1   -HYDRO(NZS1)*SOILMOIS(NZS1))*DID<a name='5901'></font>
<font color=#447700>!     1   /X1) /DENOM<a name='5902'></font>
<a name='5903'>
        DENOM=(1.+DIFFU(nzs1)/X1/DID*DELT+HYDRO(NZS)/(2.*DID)*DELT)<a name='5904'>
        COSMC(1)=DELT*(DIFFU(nzs1)/DID/X1                                &amp;<a name='5905'>
                    +HYDRO(NZS1)/2./DID)/DENOM<a name='5906'>
        RHSMC(1)=(SOILMOIS(NZS)+TRANSP(NZS)*DELT/                         &amp;<a name='5907'>
               DID)/DENOM<a name='5908'>
<a name='5909'>
<font color=#447700>!        RHSMC(1)=(SOILMOIS(NZS)*DID/DELT  &amp;<a name='5910'></font>
<font color=#447700>!        +TRANSP(NZS)-(HYDRO(NZS)*SOILMOIS(NZS) &amp;<a name='5911'></font>
<font color=#447700>!        -HYDRO(NZS1)*SOILMOIS(NZS1))*DID &amp;<a name='5912'></font>
<font color=#447700>!        /X1) /DENOM<a name='5913'></font>
<a name='5914'>
<font color=#447700>!12 June 2014 - low boundary condition: 1 - zero diffusion below the lowest<a name='5915'></font>
<font color=#447700>! level; 2 - soil moisture at the low boundary can be lost due to the root uptake.<a name='5916'></font>
<font color=#447700>! So far - no interaction with the water table.<a name='5917'></font>
<a name='5918'>
        DENOM=1.+DIFFU(nzs1)/X1/DID*DELT<a name='5919'>
<font color=#447700>!orig        DENOM=(1.+DIFFU(nzs1)/X1/DID*DELT+HYDRO(NZS)/DID*DELT)<a name='5920'></font>
<font color=#447700>!orig        COSMC(1)=DELT*(DIFFU(nzs1)/DID/X1                                &amp;<a name='5921'></font>
<font color=#447700>!orig                    +HYDRO(NZS1)/2./DID)/DENOM<a name='5922'></font>
        COSMC(1)=DELT*(DIFFU(nzs1)/DID/X1                                &amp;  <a name='5923'>
                    +HYDRO(NZS1)/DID)/DENOM<a name='5924'>
<a name='5925'>
<font color=#447700>!        RHSMC(1)=(SOILMOIS(NZS)+TRANSP(NZS)*DELT/                        &amp;<a name='5926'></font>
<font color=#447700>!               DID)/DENOM<a name='5927'></font>
<a name='5928'>
        RHSMC(1)=(SOILMOIS(NZS)-HYDRO(NZS)*DELT/DID*soilmois(nzs) &amp; <a name='5929'>
                 +TRANSP(NZS)*DELT/DID)/DENOM<a name='5930'>
<font color=#447700>!test        RHSMC(1)=SOILMOIS(NZS)-HYDRO(NZS)*soilmois(nzs)<a name='5931'></font>
<a name='5932'>
<font color=#447700>!test!!!<a name='5933'></font>
<font color=#447700>!this test gave smoother soil moisture, ovwerall better results<a name='5934'></font>
        COSMC(1)=0.<a name='5935'>
        RHSMC(1)=SOILMOIS(NZS)<a name='5936'>
<font color=#447700>!<a name='5937'></font>
        DO 330 K=1,NZS2<a name='5938'>
          KN=NZS-K<a name='5939'>
          K1=2*KN-3<a name='5940'>
          X4=2.*DTDZS(K1)*DIFFU(KN-1)<a name='5941'>
          X2=2.*DTDZS(K1+1)*DIFFU(KN)<a name='5942'>
          Q4=X4+HYDRO(KN-1)*DTDZS2(KN-1)<a name='5943'>
          Q2=X2-HYDRO(KN+1)*DTDZS2(KN-1)<a name='5944'>
          DENOM=1.+X2+X4-Q2*COSMC(K)<a name='5945'>
          COSMC(K+1)=Q4/DENOM<a name='5946'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5947'>
          print *,'q2,soilmois(kn),DIFFU(KN),x2,HYDRO(KN+1),DTDZS2(KN-1),kn,k' &amp;<a name='5948'>
                  ,q2,soilmois(kn),DIFFU(KN),x2,HYDRO(KN+1),DTDZS2(KN-1),kn,k<a name='5949'>
    ENDIF<a name='5950'>
 330      RHSMC(K+1)=(SOILMOIS(KN)+Q2*RHSMC(K)                            &amp;<a name='5951'>
                   +TRANSP(KN)                                            &amp;<a name='5952'>
                   /(ZSHALF(KN+1)-ZSHALF(KN))                             &amp;<a name='5953'>
                   *DELT)/DENOM<a name='5954'>
<a name='5955'>
<font color=#447700>! --- MOISTURE BALANCE BEGINS HERE<a name='5956'></font>
<a name='5957'>
          TRANS=TRANSP(1)<a name='5958'>
          UMVEG=(1.-VEGFRAC)*soilres<a name='5959'>
<a name='5960'>
          RUNOFF=0.<a name='5961'>
          RUNOFF2=0.<a name='5962'>
          DZS=ZSMAIN(2)<a name='5963'>
          R1=COSMC(NZS1)<a name='5964'>
          R2= RHSMC(NZS1)<a name='5965'>
          R3=DIFFU(1)/DZS<a name='5966'>
          R4=R3+HYDRO(1)*.5          <a name='5967'>
          R5=R3-HYDRO(2)*.5<a name='5968'>
          R6=QKMS*RAS<a name='5969'>
<font color=#447700>!-- Total liquid water available on the top of soil domain<a name='5970'></font>
<font color=#447700>!-- Without snow - 3 sources of water: precipitation,<a name='5971'></font>
<font color=#447700>!--         water dripping from the canopy and dew <a name='5972'></font>
<font color=#447700>!-- With snow - only one source of water - snow melt<a name='5973'></font>
<a name='5974'>
  191   format (f23.19)<a name='5975'>
<a name='5976'>
<font color=#447700>!        TOTLIQ=UMVEG*PRCP-DRIP/DELT-UMVEG*DEW*RAS-SMELT<a name='5977'></font>
<a name='5978'>
        TOTLIQ=PRCP-DRIP/DELT-UMVEG*DEW*RAS-SMELT<a name='5979'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='5980'>
print *,'UMVEG*PRCP,DRIP/DELT,UMVEG*DEW*RAS,SMELT', &amp;<a name='5981'>
         UMVEG*PRCP,DRIP/DELT,UMVEG*DEW*RAS,SMELT<a name='5982'>
    ENDIF<a name='5983'>
<a name='5984'>
<font color=#447700>!test 16 may        TOTLIQ=UMVEG*PRCP-DRIP/DELT-UMVEG*DEW*RAS-SMELT<a name='5985'></font>
<font color=#447700>!30july13        TOTLIQ=UMVEG*PRCP-DRIP/DELT-SMELT<a name='5986'></font>
<a name='5987'>
        FLX=TOTLIQ<a name='5988'>
        INFILTRP=TOTLIQ<a name='5989'>
<a name='5990'>
<font color=#447700>! -----------     FROZEN GROUND VERSION    -------------------------<a name='5991'></font>
<font color=#447700>!   REFERENCE FROZEN GROUND PARAMETER, CVFRZ, IS A SHAPE PARAMETER OF<a name='5992'></font>
<font color=#447700>!   AREAL DISTRIBUTION FUNCTION OF SOIL ICE CONTENT WHICH EQUALS 1/CV.<a name='5993'></font>
<font color=#447700>!   CV IS A COEFFICIENT OF SPATIAL VARIATION OF SOIL ICE CONTENT.<a name='5994'></font>
<font color=#447700>!   BASED ON FIELD DATA CV DEPENDS ON AREAL MEAN OF FROZEN DEPTH, AND IT<a name='5995'></font>
<font color=#447700>!   CLOSE TO CONSTANT = 0.6 IF AREAL MEAN FROZEN DEPTH IS ABOVE 20 CM.<a name='5996'></font>
<font color=#447700>!   THAT IS WHY PARAMETER CVFRZ = 3 (INT{1/0.6*0.6})<a name='5997'></font>
<font color=#447700>!<a name='5998'></font>
<font color=#447700>!   Current logic doesn't allow CVFRZ be bigger than 3<a name='5999'></font>
         CVFRZ = 3.<a name='6000'>
<a name='6001'>
<font color=#447700>!-- SCHAAKE/KOREN EXPRESSION for calculation of max infiltration<a name='6002'></font>
         REFKDT=3.<a name='6003'>
         REFDK=3.4341E-6<a name='6004'>
         DELT1=DELT/86400.<a name='6005'>
         F1MAX=DQM*ZSHALF(2)<a name='6006'>
         F2MAX=DQM*(ZSHALF(3)-ZSHALF(2))<a name='6007'>
         F1=F1MAX*(1.-SOILMOIS(1)/DQM)<a name='6008'>
         DICE=SOILICE(1)*ZSHALF(2)<a name='6009'>
         FD=F1<a name='6010'>
        do k=2,nzs1<a name='6011'>
         DICE=DICE+(ZSHALF(k+1)-ZSHALF(k))*SOILICE(K)<a name='6012'>
         FKMAX=DQM*(ZSHALF(k+1)-ZSHALF(k))<a name='6013'>
         FK=FKMAX*(1.-SOILMOIS(k)/DQM)<a name='6014'>
         FD=FD+FK<a name='6015'>
        enddo<a name='6016'>
         KDT=REFKDT*KSAT/REFDK<a name='6017'>
         VAL=(1.-EXP(-KDT*DELT1))<a name='6018'>
         DDT = FD*VAL<a name='6019'>
         PX= - TOTLIQ * DELT<a name='6020'>
         IF(PX.LT.0.0) PX = 0.0<a name='6021'>
         IF(PX.gt.0.0) THEN<a name='6022'>
           INFMAX1 = (PX*(DDT/(PX+DDT)))/DELT<a name='6023'>
         ELSE<a name='6024'>
           INFMAX1 = 0.<a name='6025'>
         ENDIF<a name='6026'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6027'>
  print *,'INFMAX1 before frozen part',INFMAX1<a name='6028'>
    ENDIF<a name='6029'>
<a name='6030'>
<font color=#447700>! -----------     FROZEN GROUND VERSION    --------------------------<a name='6031'></font>
<font color=#447700>!    REDUCTION OF INFILTRATION BASED ON FROZEN GROUND PARAMETERS<a name='6032'></font>
<font color=#447700>!<a name='6033'></font>
<font color=#447700>! ------------------------------------------------------------------<a name='6034'></font>
<a name='6035'>
         FRZX= 0.15*((dqm+qmin)/ref) * (0.412 / 0.468)<a name='6036'>
         FCR = 1.<a name='6037'>
         IF ( DICE .GT. 1.E-2) THEN<a name='6038'>
           ACRT = CVFRZ * FRZX / DICE<a name='6039'>
           SUM = 1.<a name='6040'>
           IALP1 = CVFRZ - 1<a name='6041'>
           DO JK = 1,IALP1<a name='6042'>
              K = 1<a name='6043'>
              DO JJ = JK+1, IALP1<a name='6044'>
                K = K * JJ<a name='6045'>
              END DO<a name='6046'>
              SUM = SUM + (ACRT ** ( CVFRZ-JK)) / FLOAT (K)<a name='6047'>
           END DO<a name='6048'>
           FCR = 1. - EXP(-ACRT) * SUM<a name='6049'>
         END IF<a name='6050'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6051'>
          print *,'FCR--------',fcr<a name='6052'>
          print *,'DICE=',dice<a name='6053'>
    ENDIF<a name='6054'>
         INFMAX1 = INFMAX1* FCR<a name='6055'>
<font color=#447700>! -------------------------------------------------------------------<a name='6056'></font>
<a name='6057'>
         INFMAX = MAX(INFMAX1,HYDRO(1)*SOILMOIS(1))<a name='6058'>
         INFMAX = MIN(INFMAX, -TOTLIQ)<a name='6059'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6060'>
print *,'INFMAX,INFMAX1,HYDRO(1)*SOILIQW(1),-TOTLIQ', &amp;<a name='6061'>
         INFMAX,INFMAX1,HYDRO(1)*SOILIQW(1),-TOTLIQ<a name='6062'>
    ENDIF<a name='6063'>
<font color=#447700>!----<a name='6064'></font>
          IF (-TOTLIQ.GT.INFMAX)THEN<a name='6065'>
            RUNOFF=-TOTLIQ-INFMAX<a name='6066'>
            FLX=-INFMAX<a name='6067'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6068'>
       print *,'FLX,RUNOFF1=',flx,runoff<a name='6069'>
    ENDIF<a name='6070'>
          ENDIF<a name='6071'>
<font color=#447700>! INFILTRP is total infiltration flux in M/S<a name='6072'></font>
          INFILTRP=FLX<a name='6073'>
<font color=#447700>! Solution of moisture budget<a name='6074'></font>
          R7=.5*DZS/DELT<a name='6075'>
          R4=R4+R7<a name='6076'>
          FLX=FLX-SOILMOIS(1)*R7<a name='6077'>
<font color=#447700>! R8 is for direct evaporation from soil, which occurs<a name='6078'></font>
<font color=#447700>! only from snow-free areas<a name='6079'></font>
<font color=#447700>!          R8=UMVEG*R6<a name='6080'></font>
          R8=UMVEG*R6*(1.-snowfrac)<a name='6081'>
          QTOT=QVATM+QCATM<a name='6082'>
          R9=TRANS<a name='6083'>
          R10=QTOT-QSG<a name='6084'>
<a name='6085'>
<font color=#447700>!-- evaporation regime<a name='6086'></font>
          IF(R10.LE.0.) THEN<a name='6087'>
            QQ=(R5*R2-FLX+R9)/(R4-R5*R1-R10*R8/(REF-QMIN))<a name='6088'>
            FLXSAT=-DQM*(R4-R5*R1-R10*R8/(REF-QMIN))                &amp;<a name='6089'>
                   +R5*R2+R9<a name='6090'>
          ELSE<a name='6091'>
<font color=#447700>!-- dew formation regime<a name='6092'></font>
            QQ=(R2*R5-FLX+R8*(QTOT-QCG-QVG)+R9)/(R4-R1*R5)<a name='6093'>
            FLXSAT=-DQM*(R4-R1*R5)+R2*R5+R8*(QTOT-QVG-QCG)+R9<a name='6094'>
          END IF<a name='6095'>
<a name='6096'>
          IF(QQ.LT.0.) THEN<a name='6097'>
<font color=#447700>!  print *,'negative QQ=',qq<a name='6098'></font>
            SOILMOIS(1)=1.e-8<a name='6099'>
<a name='6100'>
          ELSE IF(QQ.GT.DQM) THEN<a name='6101'>
<font color=#447700>!-- saturation<a name='6102'></font>
            SOILMOIS(1)=DQM<a name='6103'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6104'>
   print *,'FLXSAT,FLX,DELT',FLXSAT,FLX,DELT,RUNOFF2<a name='6105'>
    ENDIF<a name='6106'>
<font color=#447700>!            RUNOFF2=(FLXSAT-FLX)<a name='6107'></font>
            RUNOFF=RUNOFF+(FLXSAT-FLX)<a name='6108'>
          ELSE<a name='6109'>
            SOILMOIS(1)=min(dqm,max(1.e-8,QQ))<a name='6110'>
          END IF<a name='6111'>
<a name='6112'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6113'>
   print *,'SOILMOIS,SOILIQW, soilice',SOILMOIS,SOILIQW,soilice*riw<a name='6114'>
   print *,'COSMC,RHSMC',COSMC,RHSMC<a name='6115'>
    ENDIF<a name='6116'>
<font color=#447700>!--- FINAL SOLUTION FOR SOILMOIS <a name='6117'></font>
<font color=#447700>!          DO K=2,NZS1<a name='6118'></font>
          DO K=2,NZS<a name='6119'>
            KK=NZS-K+1<a name='6120'>
            QQ=COSMC(KK)*SOILMOIS(K-1)+RHSMC(KK)<a name='6121'>
<font color=#447700>!            QQ=COSMC(KK)*SOILIQW(K-1)+RHSMC(KK)<a name='6122'></font>
<a name='6123'>
           IF (QQ.LT.0.) THEN<a name='6124'>
<font color=#447700>!  print *,'negative QQ=',qq<a name='6125'></font>
            SOILMOIS(K)=1.e-8 <a name='6126'>
<a name='6127'>
           ELSE IF(QQ.GT.DQM) THEN<a name='6128'>
<font color=#447700>!-- saturation<a name='6129'></font>
            SOILMOIS(K)=DQM<a name='6130'>
             IF(K.EQ.NZS)THEN<a name='6131'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6132'>
   print *,'hydro(k),QQ,DQM,k',hydro(k),QQ,DQM,k<a name='6133'>
    ENDIF<a name='6134'>
               RUNOFF2=RUNOFF2+((QQ-DQM)*(ZSMAIN(K)-ZSHALF(K)))/DELT<a name='6135'>
<font color=#447700>!              RUNOFF2=RUNOFF2+(QQ-DQM)*hydro(k)<a name='6136'></font>
<font color=#447700>!   print *,'RUNOFF2=',RUNOFF2<a name='6137'></font>
             ELSE<a name='6138'>
<font color=#447700>!   print *,'QQ,DQM,k',QQ,DQM,k<a name='6139'></font>
               RUNOFF2=RUNOFF2+((QQ-DQM)*(ZSHALF(K+1)-ZSHALF(K)))/DELT<a name='6140'>
<font color=#447700>!              RUNOFF2=RUNOFF2+(QQ-DQM)*hydro(k)<a name='6141'></font>
             ENDIF<a name='6142'>
           ELSE<a name='6143'>
            SOILMOIS(K)=min(dqm,max(1.e-8,QQ))<a name='6144'>
           END IF<a name='6145'>
          END DO<a name='6146'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6147'>
   print *,'END soilmois,soiliqw,soilice',soilmois,SOILIQW,soilice*riw<a name='6148'>
    ENDIF<a name='6149'>
<a name='6150'>
<font color=#447700>!           RUNOFF2=RUNOFF2+hydro(nzs)*SOILMOIS(NZS)<a name='6151'></font>
<font color=#447700>!           MAVAIL=max(.00001,min(1.,SOILMOIS(1)/DQM))<a name='6152'></font>
<font color=#447700>!           MAVAIL=max(.00001,min(1.,SOILMOIS(1)/(REF-QMIN)))<a name='6153'></font>
           MAVAIL=max(.00001,min(1.,(SOILMOIS(1)/(REF-QMIN)*(1.-snowfrac)+1.*snowfrac)))<a name='6154'>
<a name='6155'>
<font color=#447700>!        RETURN<a name='6156'></font>
<font color=#447700>!        END<a name='6157'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='6158'></font>
    END SUBROUTINE SOILMOIST<a name='6159'>
<font color=#447700>!-------------------------------------------------------------------<a name='6160'></font>
<a name='6161'>
<a name='6162'>
<A NAME='SOILPROP'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILPROP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6163'>
          <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOILPROP</font>(spp_lsm,rstochcol,fieldcol_sf, &amp; <A href='../../call_to/SOILPROP.html' TARGET='index'>3</A><a name='6164'>
<font color=#447700>!--- input variables<a name='6165'></font>
         nzs,fwsat,lwsat,tav,keepfr,                              &amp;<a name='6166'>
         soilmois,soiliqw,soilice,                                &amp;<a name='6167'>
         soilmoism,soiliqwm,soilicem,                             &amp;<a name='6168'>
<font color=#447700>!--- soil fixed fields<a name='6169'></font>
         QWRTZ,rhocs,dqm,qmin,psis,bclh,ksat,                     &amp;<a name='6170'>
<font color=#447700>!--- constants<a name='6171'></font>
         riw,xlmelt,CP,G0_P,cvw,ci,                               &amp; <a name='6172'>
         kqwrtz,kice,kwt,                                         &amp;<a name='6173'>
<font color=#447700>!--- output variables<a name='6174'></font>
         thdif,diffu,hydro,cap)<a name='6175'>
<a name='6176'>
<font color=#447700>!******************************************************************<a name='6177'></font>
<font color=#447700>! SOILPROP computes thermal diffusivity, and diffusional and<a name='6178'></font>
<font color=#447700>!          hydraulic condeuctivities<a name='6179'></font>
<font color=#447700>!******************************************************************<a name='6180'></font>
<font color=#447700>! NX,NY,NZS - dimensions of soil domain<a name='6181'></font>
<font color=#447700>! FWSAT, LWSAT - volumetric content of frozen and liquid water<a name='6182'></font>
<font color=#447700>!                for saturated condition at given temperatures (m^3/m^3)<a name='6183'></font>
<font color=#447700>! TAV - temperature averaged for soil layers (K)<a name='6184'></font>
<font color=#447700>! SOILMOIS - volumetric soil moisture at the main soil levels (m^3/m^3)<a name='6185'></font>
<font color=#447700>! SOILMOISM - volumetric soil moisture averaged for layers (m^3/m^3)<a name='6186'></font>
<font color=#447700>! SOILIQWM - volumetric liquid soil moisture averaged for layers (m^3/m^3)<a name='6187'></font>
<font color=#447700>! SOILICEM - volumetric content of soil ice averaged for layers (m^3/m^3)<a name='6188'></font>
<font color=#447700>! THDIF - thermal diffusivity for soil layers (W/m/K)<a name='6189'></font>
<font color=#447700>! DIFFU - diffusional conductivity (m^2/s)<a name='6190'></font>
<font color=#447700>! HYDRO - hydraulic conductivity (m/s)<a name='6191'></font>
<font color=#447700>! CAP - volumetric heat capacity (J/m^3/K)<a name='6192'></font>
<font color=#447700>!<a name='6193'></font>
<font color=#447700>!******************************************************************<a name='6194'></font>
<a name='6195'>
        IMPLICIT NONE<a name='6196'>
<font color=#447700>!-----------------------------------------------------------------<a name='6197'></font>
<a name='6198'>
<font color=#447700>!--- soil properties<a name='6199'></font>
   INTEGER, INTENT(IN   )    ::                            NZS<a name='6200'>
   REAL                                                        , &amp;<a name='6201'>
            INTENT(IN   )    ::                           RHOCS, &amp;<a name='6202'>
                                                           BCLH, &amp;<a name='6203'>
                                                            DQM, &amp;<a name='6204'>
                                                           KSAT, &amp;<a name='6205'>
                                                           PSIS, &amp;<a name='6206'>
                                                          QWRTZ, &amp;  <a name='6207'>
                                                           QMIN<a name='6208'>
<a name='6209'>
   REAL,    DIMENSION(  1:nzs )                                , &amp;<a name='6210'>
            INTENT(IN   )    ::                        SOILMOIS, &amp;<a name='6211'>
                                                         keepfr<a name='6212'>
<a name='6213'>
<a name='6214'>
   REAL,     INTENT(IN   )   ::                              CP, &amp;<a name='6215'>
                                                            CVW, &amp;<a name='6216'>
                                                            RIW, &amp;  <a name='6217'>
                                                         kqwrtz, &amp;<a name='6218'>
                                                           kice, &amp;<a name='6219'>
                                                            kwt, &amp;<a name='6220'>
                                                         XLMELT, &amp;<a name='6221'>
                                                            G0_P<a name='6222'>
<a name='6223'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::          rstochcol<a name='6224'>
   REAL,     DIMENSION(1:NZS), INTENT(INOUT) ::      fieldcol_sf<a name='6225'>
   INTEGER,  INTENT(IN   )   ::                     spp_lsm      <a name='6226'>
<a name='6227'>
<a name='6228'>
<font color=#447700>!--- output variables<a name='6229'></font>
   REAL,     DIMENSION(1:NZS)                                  , &amp;<a name='6230'>
            INTENT(INOUT)  ::      cap,diffu,hydro             , &amp;<a name='6231'>
                                   thdif,tav                   , &amp;<a name='6232'>
                                   soilmoism                   , &amp;<a name='6233'>
                                   soiliqw,soilice             , &amp;<a name='6234'>
                                   soilicem,soiliqwm           , &amp;<a name='6235'>
                                   fwsat,lwsat<a name='6236'>
<a name='6237'>
<font color=#447700>!--- local variables<a name='6238'></font>
   REAL,     DIMENSION(1:NZS)  ::  hk,detal,kasat,kjpl<a name='6239'>
<a name='6240'>
   REAL    ::  x,x1,x2,x4,ws,wd,fact,fach,facd,psif,ci<a name='6241'>
   REAL    ::  tln,tavln,tn,pf,a,am,ame,h<a name='6242'>
   INTEGER ::  nzs1,k<a name='6243'>
<a name='6244'>
<font color=#447700>!-- for Johansen thermal conductivity<a name='6245'></font>
   REAL    ::  kzero,gamd,kdry,kas,x5,sr,ke       <a name='6246'>
               <a name='6247'>
<a name='6248'>
         nzs1=nzs-1<a name='6249'>
<a name='6250'>
<font color=#447700>!-- Constants for Johansen (1975) thermal conductivity<a name='6251'></font>
         kzero =2.       <font color=#447700>! if qwrtz &gt; 0.2<a name='6252'></font>
<a name='6253'>
<a name='6254'>
         do k=1,nzs<a name='6255'>
            detal (k)=0.<a name='6256'>
            kasat (k)=0.<a name='6257'>
            kjpl  (k)=0.<a name='6258'>
            hk    (k)=0.<a name='6259'>
         enddo<a name='6260'>
<a name='6261'>
           ws=dqm+qmin<a name='6262'>
           x1=xlmelt/(g0_p*psis)<a name='6263'>
           x2=x1/bclh*ws<a name='6264'>
           x4=(bclh+1.)/bclh<a name='6265'>
<font color=#447700>!--- Next 3 lines are for Johansen thermal conduct.<a name='6266'></font>
           gamd=(1.-ws)*2700.<a name='6267'>
           kdry=(0.135*gamd+64.7)/(2700.-0.947*gamd)<a name='6268'>
           kas=kqwrtz**qwrtz*kzero**(1.-qwrtz)<a name='6269'>
<a name='6270'>
         DO K=1,NZS1<a name='6271'>
           tn=tav(k) - 273.15<a name='6272'>
           wd=ws - riw*soilicem(k)<a name='6273'>
           psif=psis*100.*(wd/(soiliqwm(k)+qmin))**bclh            &amp;<a name='6274'>
                * (ws/wd)**3.<a name='6275'>
<font color=#447700>!--- PSIF should be in [CM] to compute PF<a name='6276'></font>
           pf=log10(abs(psif))<a name='6277'>
           fact=1.+riw*soilicem(k)<a name='6278'>
<font color=#447700>!--- HK is for McCumber thermal conductivity<a name='6279'></font>
         IF(PF.LE.5.2) THEN<a name='6280'>
           HK(K)=420.*EXP(-(PF+2.7))*fact<a name='6281'>
         ELSE<a name='6282'>
           HK(K)=.1744*fact<a name='6283'>
         END IF<a name='6284'>
<a name='6285'>
           IF(soilicem(k).NE.0.AND.TN.LT.0.) then<a name='6286'>
<font color=#447700>!--- DETAL is taking care of energy spent on freezing or released from <a name='6287'></font>
<font color=#447700>!          melting of soil water<a name='6288'></font>
<a name='6289'>
              DETAL(K)=273.15*X2/(TAV(K)*TAV(K))*                  &amp;<a name='6290'>
                     (TAV(K)/(X1*TN))**X4<a name='6291'>
<a name='6292'>
              if(keepfr(k).eq.1.) then<a name='6293'>
                 detal(k)=0.<a name='6294'>
              endif<a name='6295'>
<a name='6296'>
           ENDIF<a name='6297'>
<a name='6298'>
<font color=#447700>!--- Next 10 lines calculate Johansen thermal conductivity KJPL<a name='6299'></font>
           kasat(k)=kas**(1.-ws)*kice**fwsat(k)                    &amp;<a name='6300'>
                    *kwt**lwsat(k)<a name='6301'>
<a name='6302'>
           X5=(soilmoism(k)+qmin)/ws<a name='6303'>
         if(soilicem(k).eq.0.) then<a name='6304'>
           sr=max(0.101,x5)<a name='6305'>
           ke=log10(sr)+1.<a name='6306'>
<font color=#447700>!--- next 2 lines - for coarse soils<a name='6307'></font>
<font color=#447700>!           sr=max(0.0501,x5)<a name='6308'></font>
<font color=#447700>!           ke=0.7*log10(sr)+1.<a name='6309'></font>
         else<a name='6310'>
           ke=x5<a name='6311'>
         endif<a name='6312'>
<a name='6313'>
           kjpl(k)=ke*(kasat(k)-kdry)+kdry<a name='6314'>
<a name='6315'>
<font color=#447700>!--- CAP -volumetric heat capacity<a name='6316'></font>
            CAP(K)=(1.-WS)*RHOCS                                    &amp;<a name='6317'>
                  + (soiliqwm(K)+qmin)*CVW                          &amp;<a name='6318'>
                  + soilicem(K)*CI                                  &amp;<a name='6319'>
                  + (dqm-soilmoism(k))*CP*1.2                       &amp;<a name='6320'>
            - DETAL(K)*1.e3*xlmelt<a name='6321'>
<a name='6322'>
           a=RIW*soilicem(K)<a name='6323'>
<a name='6324'>
        if((ws-a).lt.0.12)then<a name='6325'>
           diffu(K)=0.<a name='6326'>
        else<a name='6327'>
           H=max(0.,(soilmoism(K)-a)/(max(1.e-8,(dqm-a))))<a name='6328'>
           facd=1.<a name='6329'>
        if(a.ne.0.)facd=1.-a/max(1.e-8,soilmoism(K))<a name='6330'>
          ame=max(1.e-8,dqm-riw*soilicem(K))<a name='6331'>
<font color=#447700>!--- DIFFU is diffusional conductivity of soil water<a name='6332'></font>
          diffu(K)=-BCLH*KSAT*PSIS/ame*                             &amp;<a name='6333'>
                  (dqm/ame)**3.                                     &amp;<a name='6334'>
                  *H**(BCLH+2.)*facd<a name='6335'>
         endif<a name='6336'>
<a name='6337'>
<font color=#447700>!          diffu(K)=-BCLH*KSAT*PSIS/dqm                              &amp;<a name='6338'></font>
<font color=#447700>!                 *H**(BCLH+2.)<a name='6339'></font>
<a name='6340'>
<a name='6341'>
<font color=#447700>!--- thdif - thermal diffusivity<a name='6342'></font>
<font color=#447700>!           thdif(K)=HK(K)/CAP(K)<a name='6343'></font>
<font color=#447700>!--- Use thermal conductivity from Johansen (1975)<a name='6344'></font>
            thdif(K)=KJPL(K)/CAP(K)<a name='6345'>
<a name='6346'>
         END DO<a name='6347'>
<a name='6348'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6349'>
   print *,'soilice*riw,soiliqw,soilmois,ws',soilice*riw,soiliqw,soilmois,ws<a name='6350'>
    ENDIF<a name='6351'>
         DO K=1,NZS<a name='6352'>
<a name='6353'>
         if((ws-riw*soilice(k)).lt.0.12)then<a name='6354'>
            hydro(k)=0.<a name='6355'>
         else<a name='6356'>
            fach=1.<a name='6357'>
          if(soilice(k).ne.0.)                                     &amp;<a name='6358'>
             fach=1.-riw*soilice(k)/max(1.e-8,soilmois(k))<a name='6359'>
         am=max(1.e-8,dqm-riw*soilice(k))<a name='6360'>
<font color=#447700>!--- HYDRO is hydraulic conductivity of soil water<a name='6361'></font>
          hydro(K)=min(KSAT,KSAT/am*                                        &amp; <a name='6362'>
                  (soiliqw(K)/am)                                  &amp;<a name='6363'>
                  **(2.*BCLH+2.)                                   &amp;<a name='6364'>
                  * fach)<a name='6365'>
          if(hydro(k)&lt;1.e-10)hydro(k)=0.<a name='6366'>
         endif<a name='6367'>
<a name='6368'>
       ENDDO<a name='6369'>
<a name='6370'>
<font color=#447700>!        perturb hydrolic conductivity by 10-30%, not more than 50%<a name='6371'></font>
         if (spp_lsm==1) then <a name='6372'>
         DO K=1,NZS <font color=#447700>!lala<a name='6373'></font>
            fieldcol_sf(k)=hydro(k)*rstochcol(k)<a name='6374'>
            hydro(k)=hydro(k)*(1+rstochcol(k))<a name='6375'>
         ENDDO<a name='6376'>
         ENDIF<a name='6377'>
<a name='6378'>
<font color=#447700>!       RETURN<a name='6379'></font>
<font color=#447700>!       END<a name='6380'></font>
<a name='6381'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6382'></font>
   END SUBROUTINE SOILPROP<a name='6383'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6384'></font>
<a name='6385'>
<a name='6386'>
<A NAME='TRANSF'><A href='../../html_code/phys/module_sf_ruclsm.F.html#TRANSF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6387'>
           <font color=#993300>SUBROUTINE </font><font color=#cc0000>TRANSF</font>(i,j,                                &amp; <A href='../../call_to/TRANSF.html' TARGET='index'>2</A><a name='6388'>
<font color=#447700>!--- input variables<a name='6389'></font>
              nzs,nroot,soiliqw,tabs,lai,gswin,                  &amp;<a name='6390'>
<font color=#447700>!--- soil fixed fields<a name='6391'></font>
              dqm,qmin,ref,wilt,zshalf,pc,iland,                 &amp;<a name='6392'>
<font color=#447700>!--- output variables<a name='6393'></font>
              tranf,transum)<a name='6394'>
<a name='6395'>
<font color=#447700>!-------------------------------------------------------------------<a name='6396'></font>
<font color=#447700>!--- TRANF(K) - THE TRANSPIRATION FUNCTION (Smirnova et al. 1996, EQ. 18,19)<a name='6397'></font>
<font color=#447700>!*******************************************************************<a name='6398'></font>
<font color=#447700>! NX,NY,NZS - dimensions of soil domain<a name='6399'></font>
<font color=#447700>! SOILIQW - volumetric liquid soil moisture at the main levels (m^3/m^3)<a name='6400'></font>
<font color=#447700>! TRANF - the transpiration function at levels (m)<a name='6401'></font>
<font color=#447700>! TRANSUM - transpiration function integrated over the rooting zone (m)<a name='6402'></font>
<font color=#447700>!<a name='6403'></font>
<font color=#447700>!*******************************************************************<a name='6404'></font>
        IMPLICIT NONE<a name='6405'>
<font color=#447700>!-------------------------------------------------------------------<a name='6406'></font>
<a name='6407'>
<font color=#447700>!--- input variables<a name='6408'></font>
<a name='6409'>
   INTEGER,  INTENT(IN   )   ::  i,j,nroot,nzs, iland<a name='6410'>
<a name='6411'>
   REAL                                                        , &amp;<a name='6412'>
            INTENT(IN   )    ::                GSWin, TABS, lai<a name='6413'>
<font color=#447700>!--- soil properties<a name='6414'></font>
   REAL                                                        , &amp;<a name='6415'>
            INTENT(IN   )    ::                             DQM, &amp;<a name='6416'>
                                                           QMIN, &amp;<a name='6417'>
                                                            REF, &amp;<a name='6418'>
                                                             PC, &amp;<a name='6419'>
                                                           WILT<a name='6420'>
<a name='6421'>
   REAL,     DIMENSION(1:NZS), INTENT(IN)  ::          soiliqw,  &amp;<a name='6422'>
                                                         ZSHALF<a name='6423'>
<a name='6424'>
<font color=#447700>!-- output <a name='6425'></font>
   REAL,     DIMENSION(1:NZS), INTENT(OUT)  ::            TRANF<a name='6426'>
   REAL,     INTENT(OUT)  ::                            TRANSUM  <a name='6427'>
<a name='6428'>
<font color=#447700>!-- local variables<a name='6429'></font>
   REAL    ::  totliq, did<a name='6430'>
   INTEGER ::  k<a name='6431'>
<a name='6432'>
<font color=#447700>!-- for non-linear root distribution<a name='6433'></font>
   REAL    ::  gx,sm1,sm2,sm3,sm4,ap0,ap1,ap2,ap3,ap4<a name='6434'>
   REAL    ::  FTEM, PCtot, fsol, f1, cmin, cmax, totcnd<a name='6435'>
   REAL,     DIMENSION(1:NZS)   ::           PART<a name='6436'>
<font color=#447700>!--------------------------------------------------------------------<a name='6437'></font>
<a name='6438'>
        do k=1,nzs<a name='6439'>
           part(k)=0.<a name='6440'>
           tranf(k)=0.<a name='6441'>
        enddo<a name='6442'>
<a name='6443'>
        transum=0.<a name='6444'>
        totliq=soiliqw(1)+qmin<a name='6445'>
           sm1=totliq<a name='6446'>
           sm2=sm1*sm1<a name='6447'>
           sm3=sm2*sm1<a name='6448'>
           sm4=sm3*sm1<a name='6449'>
           ap0=0.299<a name='6450'>
           ap1=-8.152<a name='6451'>
           ap2=61.653<a name='6452'>
           ap3=-115.876<a name='6453'>
           ap4=59.656<a name='6454'>
           gx=ap0+ap1*sm1+ap2*sm2+ap3*sm3+ap4*sm4<a name='6455'>
          if(totliq.ge.ref) gx=1.<a name='6456'>
          if(totliq.le.0.) gx=0.<a name='6457'>
          if(gx.gt.1.) gx=1.<a name='6458'>
          if(gx.lt.0.) gx=0.<a name='6459'>
        DID=zshalf(2)<a name='6460'>
          part(1)=DID*gx<a name='6461'>
        IF(TOTLIQ.GT.REF) THEN<a name='6462'>
          TRANF(1)=DID<a name='6463'>
        ELSE IF(TOTLIQ.LE.WILT) THEN<a name='6464'>
          TRANF(1)=0.<a name='6465'>
        ELSE<a name='6466'>
          TRANF(1)=(TOTLIQ-WILT)/(REF-WILT)*DID<a name='6467'>
        ENDIF <a name='6468'>
<font color=#447700>!-- uncomment next line for non-linear root distribution<a name='6469'></font>
<font color=#447700>!          TRANF(1)=part(1)<a name='6470'></font>
<a name='6471'>
        DO K=2,NROOT<a name='6472'>
        totliq=soiliqw(k)+qmin<a name='6473'>
           sm1=totliq<a name='6474'>
           sm2=sm1*sm1<a name='6475'>
           sm3=sm2*sm1<a name='6476'>
           sm4=sm3*sm1<a name='6477'>
           gx=ap0+ap1*sm1+ap2*sm2+ap3*sm3+ap4*sm4<a name='6478'>
          if(totliq.ge.ref) gx=1.<a name='6479'>
          if(totliq.le.0.) gx=0.<a name='6480'>
          if(gx.gt.1.) gx=1.<a name='6481'>
          if(gx.lt.0.) gx=0.<a name='6482'>
          DID=zshalf(K+1)-zshalf(K)<a name='6483'>
          part(k)=did*gx<a name='6484'>
        IF(totliq.GE.REF) THEN<a name='6485'>
          TRANF(K)=DID<a name='6486'>
        ELSE IF(totliq.LE.WILT) THEN<a name='6487'>
          TRANF(K)=0.<a name='6488'>
        ELSE<a name='6489'>
          TRANF(K)=(totliq-WILT)                                &amp;<a name='6490'>
                /(REF-WILT)*DID<a name='6491'>
        ENDIF<a name='6492'>
<font color=#447700>!-- uncomment next line for non-linear root distribution<a name='6493'></font>
<font color=#447700>!          TRANF(k)=part(k)<a name='6494'></font>
        END DO<a name='6495'>
<a name='6496'>
<font color=#447700>! For LAI&gt; 3 =&gt;  transpiration at potential rate (F.Tardieu, 2013)<a name='6497'></font>
      if(lai &gt; 4.) then<a name='6498'>
        pctot=0.8<a name='6499'>
      else<a name='6500'>
        pctot=pc<a name='6501'>
<font color=#447700>!- 26aug16-  next 2 lines could lead to LH increase and higher 2-m Q during the day<a name='6502'></font>
<font color=#447700>!        pctot=min(0.8,pc*lai)<a name='6503'></font>
<font color=#447700>!        pctot=min(0.8,max(pc,pc*lai))<a name='6504'></font>
      endif<a name='6505'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6506'>
<font color=#447700>!    if (i==421.and.j==280) then<a name='6507'></font>
     print *,'i,j,pctot,lai,pc',i,j,pctot,lai,pc<a name='6508'>
    ENDIF<a name='6509'>
<font color=#447700>!---<a name='6510'></font>
<font color=#447700>!--- air temperature function<a name='6511'></font>
<font color=#447700>!     Avissar (1985) and AX 7/95<a name='6512'></font>
        IF (TABS .LE. 302.15) THEN<a name='6513'>
          FTEM = 1.0 / (1.0 + EXP(-0.41 * (TABS - 282.05)))<a name='6514'>
        ELSE<a name='6515'>
          FTEM = 1.0 / (1.0 + EXP(0.5 * (TABS - 314.0)))<a name='6516'>
        ENDIF<a name='6517'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6518'>
<font color=#447700>!    if (i==421.and.j==280) then<a name='6519'></font>
     print *,'i,j,tabs,ftem',i,j,tabs,ftem<a name='6520'>
    ENDIF<a name='6521'>
<font color=#447700>!--- incoming solar function<a name='6522'></font>
     cmin = 1./rsmax_data<a name='6523'>
     cmax = 1./rstbl(iland)<a name='6524'>
    if(lai &gt; 1.) then<a name='6525'>
     cmax = lai/rstbl(iland) <font color=#447700>! max conductance<a name='6526'></font>
    endif<a name='6527'>
<font color=#447700>! Noihlan &amp; Planton (1988)<a name='6528'></font>
       f1=0.<a name='6529'>
<font color=#447700>!    if(lai &gt; 0.01) then<a name='6530'></font>
<font color=#447700>!       f1 = 1.1/lai*gswin/rgltbl(iland)! f1=0. when GSWin=0.<a name='6531'></font>
<font color=#447700>!       fsol = (f1+cmin/cmax)/(1.+f1)<a name='6532'></font>
<font color=#447700>!       fsol=min(1.,fsol)<a name='6533'></font>
<font color=#447700>!    else<a name='6534'></font>
<font color=#447700>!       fsol=cmin/cmax<a name='6535'></font>
<font color=#447700>!    endif<a name='6536'></font>
<font color=#447700>!     totcnd = max(lai/rstbl(iland), pctot * ftem * f1) <a name='6537'></font>
<font color=#447700>! Mahrer &amp; Avissar (1982), Avissar et al. (1985)<a name='6538'></font>
     if (GSWin &lt; rgltbl(iland)) then<a name='6539'>
      fsol = 1. / (1. + exp(-0.034 * (GSWin - 3.5)))<a name='6540'>
     else<a name='6541'>
      fsol = 1.<a name='6542'>
     endif<a name='6543'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6544'>
<font color=#447700>!    if (i==421.and.j==280) then<a name='6545'></font>
     print *,'i,j,GSWin,lai,f1,fsol',i,j,gswin,lai,f1,fsol<a name='6546'>
    ENDIF<a name='6547'>
<font color=#447700>!--- total conductance<a name='6548'></font>
     totcnd =(cmin + (cmax - cmin)*pctot*ftem*fsol)/cmax<a name='6549'>
<a name='6550'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6551'>
<font color=#447700>!    if (i==421.and.j==280) then<a name='6552'></font>
     print *,'i,j,iland,RGLTBL(iland),RSTBL(iland),RSMAX_DATA,totcnd'  &amp;<a name='6553'>
             ,i,j,iland,RGLTBL(iland),RSTBL(iland),RSMAX_DATA,totcnd<a name='6554'>
    ENDIF<a name='6555'>
<a name='6556'>
<font color=#447700>!-- TRANSUM - total for the rooting zone<a name='6557'></font>
          transum=0.<a name='6558'>
        DO K=1,NROOT<a name='6559'>
<font color=#447700>! linear root distribution<a name='6560'></font>
         TRANF(k)=max(cmin,TRANF(k)*totcnd)<a name='6561'>
         transum=transum+tranf(k)<a name='6562'>
        END DO<a name='6563'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6564'>
<font color=#447700>!    if (i==421.and.j==280) then<a name='6565'></font>
      print *,'i,j,transum,TRANF',i,j,transum,tranf<a name='6566'>
    endif<a name='6567'>
<a name='6568'>
<font color=#447700>!-----------------------------------------------------------------<a name='6569'></font>
   END SUBROUTINE TRANSF<a name='6570'>
<font color=#447700>!-----------------------------------------------------------------<a name='6571'></font>
<a name='6572'>
<a name='6573'>
<A NAME='VILKA'><A href='../../html_code/phys/module_sf_ruclsm.F.html#VILKA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6574'>
       <font color=#993300>SUBROUTINE </font><font color=#cc0000>VILKA</font>(TN,D1,D2,PP,QS,TS,TT,NSTEP,ii,j,iland,isoil) <A href='../../call_to/VILKA.html' TARGET='index'>6</A>,<A href='../../call_from/VILKA.html' TARGET='index'>1</A><a name='6575'>
<font color=#447700>!--------------------------------------------------------------<a name='6576'></font>
<font color=#447700>!--- VILKA finds the solution of energy budget at the surface<a name='6577'></font>
<font color=#447700>!--- using table T,QS computed from Clausius-Klapeiron<a name='6578'></font>
<font color=#447700>!--------------------------------------------------------------<a name='6579'></font>
   REAL,     DIMENSION(1:5001),  INTENT(IN   )   ::  TT<a name='6580'>
   REAL,     INTENT(IN  )   ::  TN,D1,D2,PP<a name='6581'>
   INTEGER,  INTENT(IN  )   ::  NSTEP,ii,j,iland,isoil<a name='6582'>
<a name='6583'>
   REAL,     INTENT(OUT  )  ::  QS, TS<a name='6584'>
<a name='6585'>
   REAL    ::  F1,T1,T2,RN<a name='6586'>
   INTEGER ::  I,I1<a name='6587'>
     <a name='6588'>
       I=(TN-1.7315E2)/.05+1<a name='6589'>
       T1=173.1+FLOAT(I)*.05<a name='6590'>
       F1=T1+D1*TT(I)-D2<a name='6591'>
       I1=I-F1/(.05+D1*(TT(I+1)-TT(I)))<a name='6592'>
       I=I1<a name='6593'>
       IF(I.GT.5000.OR.I.LT.1) GOTO 1<a name='6594'>
  10   I1=I<a name='6595'>
       T1=173.1+FLOAT(I)*.05<a name='6596'>
       F1=T1+D1*TT(I)-D2<a name='6597'>
       RN=F1/(.05+D1*(TT(I+1)-TT(I)))<a name='6598'>
       I=I-INT(RN)                      <a name='6599'>
       IF(I.GT.5000.OR.I.LT.1) GOTO 1<a name='6600'>
       IF(I1.NE.I) GOTO 10<a name='6601'>
       TS=T1-.05*RN<a name='6602'>
       QS=(TT(I)+(TT(I)-TT(I+1))*RN)/PP<a name='6603'>
       GOTO 20<a name='6604'>
<font color=#447700>!   1   PRINT *,'Crash in surface energy budget - STOP'<a name='6605'></font>
   1   PRINT *,'     AVOST IN VILKA     Table index= ',I<a name='6606'>
<font color=#447700>!       PRINT *,TN,D1,D2,PP,NSTEP,I,TT(i),ii,j,iland,isoil<a name='6607'></font>
       print *,'I,J=',ii,j,'LU_index = ',iland, 'Psfc[hPa] = ',pp, 'Tsfc = ',tn<a name='6608'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#VILKA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1200"> ('  Crash in surface energy budget  ' )<a name='6609'>
   20  CONTINUE<a name='6610'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6611'></font>
   END SUBROUTINE VILKA<a name='6612'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6613'></font>
<a name='6614'>
<A NAME='SOILVEGIN'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILVEGIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6615'>
     <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOILVEGIN</font>  ( mosaic_lu,mosaic_soil,soilfrac,nscat,   &amp; <A href='../../call_to/SOILVEGIN.html' TARGET='index'>1</A><a name='6616'>
                     shdmin, shdmax,                                 &amp;<a name='6617'>
                     NLCAT,IVGTYP,ISLTYP,iswater,MYJ,                &amp;<a name='6618'>
                     IFOREST,lufrac,vegfrac,EMISS,PC,ZNT,LAI,RDLAI2D,&amp;<a name='6619'>
                     QWRTZ,RHOCS,BCLH,DQM,KSAT,PSIS,QMIN,REF,WILT,I,J)<a name='6620'>
<a name='6621'>
<font color=#447700>!************************************************************************<a name='6622'></font>
<font color=#447700>!  Set-up soil and vegetation Parameters in the case when<a name='6623'></font>
<font color=#447700>!  snow disappears during the forecast and snow parameters<a name='6624'></font>
<font color=#447700>!  shold be replaced by surface parameters according to<a name='6625'></font>
<font color=#447700>!  soil and vegetation types in this point.<a name='6626'></font>
<font color=#447700>!<a name='6627'></font>
<font color=#447700>!        Output:<a name='6628'></font>
<font color=#447700>!<a name='6629'></font>
<font color=#447700>!<a name='6630'></font>
<font color=#447700>!             Soil parameters:<a name='6631'></font>
<font color=#447700>!               DQM: MAX soil moisture content - MIN (m^3/m^3)<a name='6632'></font>
<font color=#447700>!               REF:        Reference soil moisture (m^3/m^3)<a name='6633'></font>
<font color=#447700>!               WILT: Wilting PT soil moisture contents (m^3/m^3)<a name='6634'></font>
<font color=#447700>!               QMIN: Air dry soil moist content limits (m^3/m^3)<a name='6635'></font>
<font color=#447700>!               PSIS: SAT soil potential coefs. (m)<a name='6636'></font>
<font color=#447700>!               KSAT:  SAT soil diffusivity/conductivity coefs. (m/s)<a name='6637'></font>
<font color=#447700>!               BCLH: Soil diffusivity/conductivity exponent.<a name='6638'></font>
<font color=#447700>!<a name='6639'></font>
<font color=#447700>! ************************************************************************<a name='6640'></font>
   IMPLICIT NONE<a name='6641'>
<font color=#447700>!---------------------------------------------------------------------------<a name='6642'></font>
      integer,   parameter      ::      nsoilclas=19<a name='6643'>
      integer,   parameter      ::      nvegclas=24+3<a name='6644'>
      integer,   parameter      ::      ilsnow=99<a name='6645'>
<a name='6646'>
   INTEGER,    INTENT(IN   )    ::      nlcat, nscat, iswater, i, j<a name='6647'>
<a name='6648'>
<font color=#447700>!---    soiltyp classification according to STATSGO(nclasses=16)<a name='6649'></font>
<font color=#447700>!<a name='6650'></font>
<font color=#447700>!             1          SAND                  SAND<a name='6651'></font>
<font color=#447700>!             2          LOAMY SAND            LOAMY SAND<a name='6652'></font>
<font color=#447700>!             3          SANDY LOAM            SANDY LOAM<a name='6653'></font>
<font color=#447700>!             4          SILT LOAM             SILTY LOAM<a name='6654'></font>
<font color=#447700>!             5          SILT                  SILTY LOAM<a name='6655'></font>
<font color=#447700>!             6          LOAM                  LOAM<a name='6656'></font>
<font color=#447700>!             7          SANDY CLAY LOAM       SANDY CLAY LOAM<a name='6657'></font>
<font color=#447700>!             8          SILTY CLAY LOAM       SILTY CLAY LOAM<a name='6658'></font>
<font color=#447700>!             9          CLAY LOAM             CLAY LOAM<a name='6659'></font>
<font color=#447700>!            10          SANDY CLAY            SANDY CLAY<a name='6660'></font>
<font color=#447700>!            11          SILTY CLAY            SILTY CLAY<a name='6661'></font>
<font color=#447700>!            12          CLAY                  LIGHT CLAY<a name='6662'></font>
<font color=#447700>!            13          ORGANIC MATERIALS     LOAM<a name='6663'></font>
<font color=#447700>!            14          WATER<a name='6664'></font>
<font color=#447700>!            15          BEDROCK<a name='6665'></font>
<font color=#447700>!                        Bedrock is reclassified as class 14<a name='6666'></font>
<font color=#447700>!            16          OTHER (land-ice)<a name='6667'></font>
<font color=#447700>!            17          Playa<a name='6668'></font>
<font color=#447700>!            18          Lava<a name='6669'></font>
<font color=#447700>!            19          White Sand<a name='6670'></font>
<font color=#447700>!<a name='6671'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='6672'></font>
         REAL  LQMA(nsoilclas),LRHC(nsoilclas),                       &amp;<a name='6673'>
               LPSI(nsoilclas),LQMI(nsoilclas),                       &amp;<a name='6674'>
               LBCL(nsoilclas),LKAS(nsoilclas),                       &amp;<a name='6675'>
               LWIL(nsoilclas),LREF(nsoilclas),                       &amp;<a name='6676'>
               DATQTZ(nsoilclas)<a name='6677'>
<font color=#447700>!-- LQMA Rawls et al.[1982]<a name='6678'></font>
<font color=#447700>!        DATA LQMA /0.417, 0.437, 0.453, 0.501, 0.486, 0.463, 0.398,<a name='6679'></font>
<font color=#447700>!     &amp;  0.471, 0.464, 0.430, 0.479, 0.475, 0.439, 1.0, 0.20, 0.401/<a name='6680'></font>
<font color=#447700>!---<a name='6681'></font>
<font color=#447700>!-- Clapp, R. and G. Hornberger, 1978: Empirical equations for some soil<a name='6682'></font>
<font color=#447700>!   hydraulic properties, Water Resour. Res., 14, 601-604.<a name='6683'></font>
<a name='6684'>
<font color=#447700>!-- Clapp et al. [1978]<a name='6685'></font>
     DATA LQMA /0.395, 0.410, 0.435, 0.485, 0.485, 0.451, 0.420,      &amp;<a name='6686'>
                0.477, 0.476, 0.426, 0.492, 0.482, 0.451, 1.0,        &amp;<a name='6687'>
                0.20,  0.435, 0.468, 0.200, 0.339/<a name='6688'>
<a name='6689'>
<font color=#447700>!-- LREF Rawls et al.[1982]<a name='6690'></font>
<font color=#447700>!        DATA LREF /0.091, 0.125, 0.207, 0.330, 0.360, 0.270, 0.255,<a name='6691'></font>
<font color=#447700>!     &amp;  0.366, 0.318, 0.339, 0.387, 0.396, 0.329, 1.0, 0.108, 0.283/<a name='6692'></font>
<a name='6693'>
<font color=#447700>!-- Clapp et al. [1978]<a name='6694'></font>
        DATA LREF /0.174, 0.179, 0.249, 0.369, 0.369, 0.314, 0.299,   &amp;<a name='6695'>
                   0.357, 0.391, 0.316, 0.409, 0.400, 0.314, 1.,      &amp;<a name='6696'>
                   0.1,   0.249, 0.454, 0.17,  0.236/<a name='6697'>
<a name='6698'>
<font color=#447700>!-- LWIL Rawls et al.[1982]<a name='6699'></font>
<font color=#447700>!        DATA LWIL/0.033, 0.055, 0.095, 0.133, 0.133, 0.117, 0.148,<a name='6700'></font>
<font color=#447700>!     &amp;  0.208, 0.197, 0.239, 0.250, 0.272, 0.066, 0.0, 0.006, 0.029/<a name='6701'></font>
<a name='6702'>
<font color=#447700>!-- Clapp et al. [1978]<a name='6703'></font>
        DATA LWIL/0.068, 0.075, 0.114, 0.179, 0.179, 0.155, 0.175,    &amp;<a name='6704'>
                  0.218, 0.250, 0.219, 0.283, 0.286, 0.155, 0.0,      &amp;<a name='6705'>
                  0.006, 0.114, 0.030, 0.006, 0.01/<a name='6706'>
<a name='6707'>
<font color=#447700>!        DATA LQMI/0.010, 0.028, 0.047, 0.084, 0.084, 0.066, 0.067,<a name='6708'></font>
<font color=#447700>!     &amp;  0.120, 0.103, 0.100, 0.126, 0.138, 0.066, 0.0, 0.006, 0.028/<a name='6709'></font>
<a name='6710'>
<font color=#447700>!-- Carsel and Parrish [1988]<a name='6711'></font>
        DATA LQMI/0.045, 0.057, 0.065, 0.067, 0.034, 0.078, 0.10,     &amp;<a name='6712'>
                  0.089, 0.095, 0.10,  0.070, 0.068, 0.078, 0.0,      &amp;<a name='6713'>
                  0.004, 0.065, 0.020, 0.004, 0.008/<a name='6714'>
<a name='6715'>
<font color=#447700>!-- LPSI Cosby et al[1984]<a name='6716'></font>
<font color=#447700>!        DATA LPSI/0.060, 0.036, 0.141, 0.759, 0.759, 0.355, 0.135,<a name='6717'></font>
<font color=#447700>!     &amp;  0.617, 0.263, 0.098, 0.324, 0.468, 0.355, 0.0, 0.069, 0.036/<a name='6718'></font>
<font color=#447700>!     &amp;  0.617, 0.263, 0.098, 0.324, 0.468, 0.355, 0.0, 0.069, 0.036/<a name='6719'></font>
<a name='6720'>
<font color=#447700>!-- Clapp et al. [1978]<a name='6721'></font>
       DATA LPSI/0.121, 0.090, 0.218, 0.786, 0.786, 0.478, 0.299,     &amp;<a name='6722'>
                 0.356, 0.630, 0.153, 0.490, 0.405, 0.478, 0.0,       &amp;<a name='6723'>
                 0.121, 0.218, 0.468, 0.069, 0.069/<a name='6724'>
<a name='6725'>
<font color=#447700>!-- LKAS Rawls et al.[1982]<a name='6726'></font>
<font color=#447700>!        DATA LKAS/5.83E-5, 1.70E-5, 7.19E-6, 1.89E-6, 1.89E-6,<a name='6727'></font>
<font color=#447700>!     &amp;  3.67E-6, 1.19E-6, 4.17E-7, 6.39E-7, 3.33E-7, 2.50E-7,<a name='6728'></font>
<font color=#447700>!     &amp;  1.67E-7, 3.38E-6, 0.0, 1.41E-4, 1.41E-5/<a name='6729'></font>
<a name='6730'>
<font color=#447700>!-- Clapp et al. [1978]<a name='6731'></font>
        DATA LKAS/1.76E-4, 1.56E-4, 3.47E-5, 7.20E-6, 7.20E-6,         &amp;<a name='6732'>
                  6.95E-6, 6.30E-6, 1.70E-6, 2.45E-6, 2.17E-6,         &amp;<a name='6733'>
                  1.03E-6, 1.28E-6, 6.95E-6, 0.0,     1.41E-4,         &amp;<a name='6734'>
                  3.47E-5, 1.28E-6, 1.41E-4, 1.76E-4/<a name='6735'>
<a name='6736'>
<font color=#447700>!-- LBCL Cosby et al [1984]<a name='6737'></font>
<font color=#447700>!        DATA LBCL/2.79,  4.26,  4.74,  5.33,  5.33,  5.25,  6.66,<a name='6738'></font>
<font color=#447700>!     &amp;  8.72,  8.17,  10.73, 10.39, 11.55, 5.25,  0.0, 2.79,  4.26/<a name='6739'></font>
<a name='6740'>
<font color=#447700>!-- Clapp et al. [1978]<a name='6741'></font>
        DATA LBCL/4.05,  4.38,  4.90,  5.30,  5.30,  5.39,  7.12,      &amp;<a name='6742'>
                  7.75,  8.52, 10.40, 10.40, 11.40,  5.39,  0.0,       &amp;<a name='6743'>
                  4.05,  4.90, 11.55,  2.79,  2.79/<a name='6744'>
<a name='6745'>
        DATA LRHC /1.47,1.41,1.34,1.27,1.27,1.21,1.18,1.32,1.23,       &amp;<a name='6746'>
                   1.18,1.15,1.09,1.21,4.18,2.03,2.10,1.09,2.03,1.47/<a name='6747'>
<a name='6748'>
        DATA DATQTZ/0.92,0.82,0.60,0.25,0.10,0.40,0.60,0.10,0.35,      &amp;<a name='6749'>
                    0.52,0.10,0.25,0.00,0.,0.60,0.0,0.25,0.60,0.92/<a name='6750'>
<a name='6751'>
<font color=#447700>!--------------------------------------------------------------------------<a name='6752'></font>
<font color=#447700>!<a name='6753'></font>
<font color=#447700>!     USGS Vegetation Types<a name='6754'></font>
<font color=#447700>!<a name='6755'></font>
<font color=#447700>!    1:   Urban and Built-Up Land<a name='6756'></font>
<font color=#447700>!    2:   Dryland Cropland and Pasture<a name='6757'></font>
<font color=#447700>!    3:   Irrigated Cropland and Pasture<a name='6758'></font>
<font color=#447700>!    4:   Mixed Dryland/Irrigated Cropland and Pasture<a name='6759'></font>
<font color=#447700>!    5:   Cropland/Grassland Mosaic<a name='6760'></font>
<font color=#447700>!    6:   Cropland/Woodland Mosaic<a name='6761'></font>
<font color=#447700>!    7:   Grassland<a name='6762'></font>
<font color=#447700>!    8:   Shrubland<a name='6763'></font>
<font color=#447700>!    9:   Mixed Shrubland/Grassland<a name='6764'></font>
<font color=#447700>!   10:   Savanna<a name='6765'></font>
<font color=#447700>!   11:   Deciduous Broadleaf Forest<a name='6766'></font>
<font color=#447700>!   12:   Deciduous Needleleaf Forest<a name='6767'></font>
<font color=#447700>!   13:   Evergreen Broadleaf Forest<a name='6768'></font>
<font color=#447700>!   14:   Evergreen Needleleaf Fores<a name='6769'></font>
<font color=#447700>!   15:   Mixed Forest<a name='6770'></font>
<font color=#447700>!   16:   Water Bodies<a name='6771'></font>
<font color=#447700>!   17:   Herbaceous Wetland<a name='6772'></font>
<font color=#447700>!   18:   Wooded Wetland<a name='6773'></font>
<font color=#447700>!   19:   Barren or Sparsely Vegetated<a name='6774'></font>
<font color=#447700>!   20:   Herbaceous Tundra<a name='6775'></font>
<font color=#447700>!   21:   Wooded Tundra<a name='6776'></font>
<font color=#447700>!   22:   Mixed Tundra<a name='6777'></font>
<font color=#447700>!   23:   Bare Ground Tundra<a name='6778'></font>
<font color=#447700>!   24:   Snow or Ice<a name='6779'></font>
<font color=#447700>!<a name='6780'></font>
<font color=#447700>!   25:   Playa<a name='6781'></font>
<font color=#447700>!   26:   Lava<a name='6782'></font>
<font color=#447700>!   27:   White Sand<a name='6783'></font>
<a name='6784'>
<font color=#447700>! MODIS vegetation categories from VEGPARM.TBL<a name='6785'></font>
<font color=#447700>!    1:   Evergreen Needleleaf Forest<a name='6786'></font>
<font color=#447700>!    2:   Evergreen Broadleaf Forest<a name='6787'></font>
<font color=#447700>!    3:   Deciduous Needleleaf Forest<a name='6788'></font>
<font color=#447700>!    4:   Deciduous Broadleaf Forest<a name='6789'></font>
<font color=#447700>!    5:   Mixed Forests<a name='6790'></font>
<font color=#447700>!    6:   Closed Shrublands<a name='6791'></font>
<font color=#447700>!    7:   Open Shrublands<a name='6792'></font>
<font color=#447700>!    8:   Woody Savannas<a name='6793'></font>
<font color=#447700>!    9:   Savannas<a name='6794'></font>
<font color=#447700>!   10:   Grasslands<a name='6795'></font>
<font color=#447700>!   11:   Permanent wetlands<a name='6796'></font>
<font color=#447700>!   12:   Croplands<a name='6797'></font>
<font color=#447700>!   13:   Urban and Built-Up<a name='6798'></font>
<font color=#447700>!   14:   cropland/natural vegetation mosaic<a name='6799'></font>
<font color=#447700>!   15:   Snow and Ice<a name='6800'></font>
<font color=#447700>!   16:   Barren or Sparsely Vegetated<a name='6801'></font>
<font color=#447700>!   17:   Water<a name='6802'></font>
<font color=#447700>!   18:   Wooded Tundra<a name='6803'></font>
<font color=#447700>!   19:   Mixed Tundra<a name='6804'></font>
<font color=#447700>!   20:   Barren Tundra<a name='6805'></font>
<font color=#447700>!   21:   Lakes<a name='6806'></font>
<a name='6807'>
<a name='6808'>
<font color=#447700>!----  Below are the arrays for the vegetation parameters<a name='6809'></font>
         REAL LALB(nvegclas),LMOI(nvegclas),LEMI(nvegclas),            &amp;<a name='6810'>
              LROU(nvegclas),LTHI(nvegclas),LSIG(nvegclas),            &amp;<a name='6811'>
              LPC(nvegclas)<a name='6812'>
<a name='6813'>
<font color=#447700>!************************************************************************<a name='6814'></font>
<font color=#447700>!----     vegetation parameters<a name='6815'></font>
<font color=#447700>!<a name='6816'></font>
<font color=#447700>!-- USGS model<a name='6817'></font>
<font color=#447700>!<a name='6818'></font>
        DATA  LALB/.18,.17,.18,.18,.18,.16,.19,.22,.20,.20,.16,.14,     &amp;<a name='6819'>
                   .12,.12,.13,.08,.14,.14,.25,.15,.15,.15,.25,.55,     &amp;<a name='6820'>
                   .30,.16,.60 /<a name='6821'>
        DATA LEMI/.88,4*.92,.93,.92,.88,.9,.92,.93,.94,                 &amp;<a name='6822'>
                  .95,.95,.94,.98,.95,.95,.85,.92,.93,.92,.85,.95,      &amp;<a name='6823'>
                  .85,.85,.90 /<a name='6824'>
<font color=#447700>!-- Roughness length is changed for forests and some others<a name='6825'></font>
<font color=#447700>!        DATA LROU/.5,.06,.075,.065,.05,.2,.075,.1,.11,.15,.8,.85,       &amp;<a name='6826'></font>
<font color=#447700>!                  2.0,1.0,.563,.0001,.2,.4,.05,.1,.15,.1,.065,.05/<a name='6827'></font>
         DATA LROU/.5,.06,.075,.065,.05,.2,.075,.1,.11,.15,.5,.5,       &amp; <a name='6828'>
                   .5,.5,.5,.0001,.2,.4,.05,.1,.15,.1,.065,.05,         &amp;<a name='6829'>
                   .01,.15,.01 /<a name='6830'>
<a name='6831'>
        DATA LMOI/.1,.3,.5,.25,.25,.35,.15,.1,.15,.15,.3,.3,            &amp;<a name='6832'>
                  .5,.3,.3,1.,.6,.35,.02,.5,.5,.5,.02,.95,.40,.50,.40/<a name='6833'>
<font color=#447700>!<a name='6834'></font>
<font color=#447700>!---- still needs to be corrected<a name='6835'></font>
<font color=#447700>!<a name='6836'></font>
<font color=#447700>!       DATA LPC/ 15*.8,0.,.8,.8,.5,.5,.5,.5,.5,.0/<a name='6837'></font>
       DATA LPC /0.4,0.3,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,5*0.55,0.,0.55,0.55,                   &amp;<a name='6838'>
                 0.3,0.3,0.4,0.4,0.3,0.,.3,0.,0./<a name='6839'>
<a name='6840'>
<font color=#447700>! used in RUC       DATA LPC /0.6,6*0.8,0.7,0.75,6*0.8,0.,0.8,0.8,                   &amp;<a name='6841'></font>
<font color=#447700>!                 0.5,0.7,0.6,0.7,0.5,0./<a name='6842'></font>
<a name='6843'>
<a name='6844'>
<font color=#447700>!***************************************************************************<a name='6845'></font>
<a name='6846'>
<a name='6847'>
   INTEGER      ::                &amp;<a name='6848'>
                                                         IVGTYP, &amp;<a name='6849'>
                                                         ISLTYP<a name='6850'>
   INTEGER,    INTENT(IN   )    ::     mosaic_lu, mosaic_soil<a name='6851'>
<a name='6852'>
   LOGICAL,    INTENT(IN   )    ::     myj<a name='6853'>
   REAL,       INTENT(IN )      ::   SHDMAX<a name='6854'>
   REAL,       INTENT(IN )      ::   SHDMIN<a name='6855'>
   REAL,       INTENT(IN )      ::   VEGFRAC<a name='6856'>
   REAL,     DIMENSION( 1:NLCAT ),  INTENT(IN)::         LUFRAC<a name='6857'>
   REAL,     DIMENSION( 1:NSCAT ),  INTENT(IN)::         SOILFRAC<a name='6858'>
<a name='6859'>
   REAL                                                        , &amp;<a name='6860'>
            INTENT (  OUT)            ::                     pc<a name='6861'>
<a name='6862'>
   REAL                                                        , &amp;<a name='6863'>
            INTENT (INOUT   )         ::                  emiss, &amp;<a name='6864'>
                                                            lai, &amp;<a name='6865'>
                                                            znt<a name='6866'>
  LOGICAL, intent(in) :: rdlai2d<a name='6867'>
<font color=#447700>!--- soil properties<a name='6868'></font>
   REAL                                                        , &amp;<a name='6869'>
            INTENT(  OUT)    ::                           RHOCS, &amp;<a name='6870'>
                                                           BCLH, &amp;<a name='6871'>
                                                            DQM, &amp;<a name='6872'>
                                                           KSAT, &amp;<a name='6873'>
                                                           PSIS, &amp;<a name='6874'>
                                                           QMIN, &amp;<a name='6875'>
                                                          QWRTZ, &amp;<a name='6876'>
                                                            REF, &amp;<a name='6877'>
                                                           WILT<a name='6878'>
   INTEGER, INTENT (  OUT)   ::                         iforest<a name='6879'>
<a name='6880'>
<font color=#447700>!   INTEGER, DIMENSION( 1:(lucats) )                          , &amp;<a name='6881'></font>
<font color=#447700>!            INTENT (  OUT)            ::                iforest<a name='6882'></font>
<a name='6883'>
<a name='6884'>
<font color=#447700>!   INTEGER, DIMENSION( 1:50 )   ::   if1<a name='6885'></font>
   INTEGER   ::   kstart, kfin, lstart, lfin<a name='6886'>
   INTEGER   ::   k<a name='6887'>
   REAL      ::   area,  deltalai, factor, znt1, lb<a name='6888'>
   REAL,     DIMENSION( 1:NLCAT ) :: ZNTtoday, LAItoday<a name='6889'>
<a name='6890'>
<font color=#447700>!***********************************************************************<a name='6891'></font>
<font color=#447700>!        DATA ZS1/0.0,0.05,0.20,0.40,1.6,3.0/   ! o -  levels in soil<a name='6892'></font>
<font color=#447700>!        DATA ZS2/0.0,0.025,0.125,0.30,1.,2.3/   ! x - levels in soil<a name='6893'></font>
<a name='6894'>
<font color=#447700>!        DATA IF1/12*0,1,1,1,12*0/<a name='6895'></font>
<a name='6896'>
<font color=#447700>!          do k=1,LUCATS<a name='6897'></font>
<font color=#447700>!             iforest(k)=if1(k)<a name='6898'></font>
<font color=#447700>!          enddo<a name='6899'></font>
<a name='6900'>
        iforest = IFORTBL(IVGTYP)<a name='6901'>
<a name='6902'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6903'>
      if(i.eq.375.and.j.eq.254)then<a name='6904'>
        print *,'ifortbl(ivgtyp),ivgtyp,laitbl(ivgtyp),z0tbl(ivgtyp)', &amp;<a name='6905'>
            ifortbl(ivgtyp),ivgtyp,laitbl(ivgtyp),z0tbl(ivgtyp)<a name='6906'>
      endif<a name='6907'>
    ENDIF<a name='6908'>
<a name='6909'>
        deltalai = 0.<a name='6910'>
<a name='6911'>
<font color=#447700>! 11oct2012 - seasonal correction on ZNT for crops and LAI for all veg. types<a name='6912'></font>
<font color=#447700>! factor = 1 with minimum greenness --&gt;  vegfrac = shdmin (cold season)<a name='6913'></font>
<font color=#447700>!      if((vegfrac - shdmin) .le. 0.) then<a name='6914'></font>
<font color=#447700>!        factor = 1.<a name='6915'></font>
<font color=#447700>!      else<a name='6916'></font>
<font color=#447700>!        factor = 1. - max(0.,min(1.,((vegfrac - shdmin)/(shdmax-shdmin))))<a name='6917'></font>
<font color=#447700>!      endif<a name='6918'></font>
<a name='6919'>
<font color=#447700>! 11oct2012 - seasonal correction on ZNT for crops and LAI for all veg. types<a name='6920'></font>
<font color=#447700>! factor = 1 with minimum greenness --&gt;  vegfrac = shdmin (cold season)<a name='6921'></font>
<font color=#447700>! SHDMAX, SHDMIN and VEGFRAC are in % here.<a name='6922'></font>
      if((shdmax - shdmin) .lt. 1) then<a name='6923'>
        factor = 1.<a name='6924'>
      else<a name='6925'>
        factor = 1. - max(0.,min(1.,(vegfrac - shdmin)/max(1.,(shdmax-shdmin))))<a name='6926'>
      endif<a name='6927'>
<a name='6928'>
      do k = 1,nlcat<a name='6929'>
       if(IFORTBL(k) == 1) deltalai=0.2<a name='6930'>
       if(IFORTBL(k) == 2 .or. IFORTBL(k) == 7) deltalai=0.5<a name='6931'>
       if(IFORTBL(k) == 3) deltalai=0.45<a name='6932'>
       if(IFORTBL(k) == 4) deltalai=0.75<a name='6933'>
       if(IFORTBL(k) == 5) deltalai=0.86<a name='6934'>
<a name='6935'>
       if(k.ne.iswater) then<a name='6936'>
        LAItoday(k) = LAITBL(K) * (1. - deltalai * factor)<a name='6937'>
         if(IFORTBL(k) == 7) then<a name='6938'>
<font color=#447700>!crops<a name='6939'></font>
           ZNTtoday(k) = Z0TBL(K) * (1. - 0.66 * factor)<a name='6940'>
         else<a name='6941'>
           ZNTtoday(k) = Z0TBL(K)<a name='6942'>
         endif<a name='6943'>
       else<a name='6944'>
        LAItoday(k) = LAITBL(K)<a name='6945'>
        ZNTtoday(k) = Z0TBL(K)<a name='6946'>
       endif<a name='6947'>
      enddo<a name='6948'>
<a name='6949'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6950'>
      if(i.eq.358.and.j.eq.260)then<a name='6951'>
        print *,'ivgtyp,factor,vegfrac,shdmin,shdmax,deltalai,laitoday(ivgtyp),znttoday(ivgtyp)', &amp;<a name='6952'>
         i,j,ivgtyp,factor,vegfrac,shdmin,shdmax,deltalai,laitoday(ivgtyp),znttoday(ivgtyp)<a name='6953'>
      endif<a name='6954'>
    ENDIF<a name='6955'>
<a name='6956'>
        EMISS = 0.<a name='6957'>
        ZNT   = 0.<a name='6958'>
        ZNT1  = 0.<a name='6959'>
        PC    = 0.<a name='6960'>
        if(.not.rdlai2d) LAI = 0.<a name='6961'>
        AREA  = 0.<a name='6962'>
<font color=#447700>!-- mosaic approach to landuse in the grid box<a name='6963'></font>
<font color=#447700>! Use  Mason (1988) Eq.(15) to compute effective ZNT;<a name='6964'></font>
<font color=#447700>!  Lb - blending height =  L/200., where L is the length scale<a name='6965'></font>
<font color=#447700>! of regions with varying Z0 (Lb = 5 if L=1000 m)<a name='6966'></font>
        LB = 5.<a name='6967'>
      if(mosaic_lu == 1) then<a name='6968'>
      do k = 1,nlcat<a name='6969'>
        AREA  = AREA + lufrac(k)<a name='6970'>
        EMISS = EMISS+ LEMITBL(K)*lufrac(k)<a name='6971'>
        ZNT   = ZNT  + lufrac(k)/ALOG(LB/ZNTtoday(K))**2.<a name='6972'>
<font color=#447700>! ZNT1 - weighted average in the grid box, not used, computed for comparison<a name='6973'></font>
        ZNT1  = ZNT1 + lufrac(k)*ZNTtoday(K)<a name='6974'>
        if(.not.rdlai2d) LAI = LAI  + LAItoday(K)*lufrac(k)<a name='6975'>
        PC    = PC   + PCTBL(K)*lufrac(k)<a name='6976'>
      enddo<a name='6977'>
<a name='6978'>
       if (area.gt.1.) area=1.<a name='6979'>
       if (area &lt;= 0.) then<a name='6980'>
          print *,'Bad area of grid box', area<a name='6981'>
          stop<a name='6982'>
       endif<a name='6983'>
<a name='6984'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6985'>
      if(i.eq.358.and.j.eq.260) then<a name='6986'>
        print *,'area=',area,i,j,ivgtyp,nlcat,(lufrac(k),k=1,nlcat),EMISS,ZNT,ZNT1,LAI,PC<a name='6987'>
      endif<a name='6988'>
    ENDIF<a name='6989'>
<a name='6990'>
        EMISS = EMISS/AREA<a name='6991'>
        ZNT1   = ZNT1/AREA<a name='6992'>
        ZNT = LB/EXP(SQRT(1./ZNT))<a name='6993'>
        if(.not.rdlai2d) LAI = LAI/AREA<a name='6994'>
        PC    = PC /AREA<a name='6995'>
<a name='6996'>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='6997'>
      if(i.eq.358.and.j.eq.260) then<a name='6998'>
        print *,'mosaic=',i,j,ivgtyp,nlcat,(lufrac(k),k=1,nlcat),EMISS,ZNT,ZNT1,LAI,PC<a name='6999'>
      endif<a name='7000'>
    ENDIF<a name='7001'>
<a name='7002'>
<a name='7003'>
      else<a name='7004'>
        EMISS = LEMITBL(IVGTYP)<a name='7005'>
        ZNT   = ZNTtoday(IVGTYP)<a name='7006'>
        PC    = PCTBL(IVGTYP)<a name='7007'>
        if(.not.rdlai2d) LAI = LAItoday(IVGTYP)<a name='7008'>
     endif<a name='7009'>
<a name='7010'>
<font color=#447700>! parameters from SOILPARM.TBL<a name='7011'></font>
          RHOCS  = 0.<a name='7012'>
          BCLH   = 0.<a name='7013'>
          DQM    = 0.<a name='7014'>
          KSAT   = 0.<a name='7015'>
          PSIS   = 0.<a name='7016'>
          QMIN   = 0.<a name='7017'>
          REF    = 0.<a name='7018'>
          WILT   = 0.<a name='7019'>
          QWRTZ  = 0.<a name='7020'>
          AREA   = 0.<a name='7021'>
<font color=#447700>! mosaic approach<a name='7022'></font>
       if(mosaic_soil == 1 ) then<a name='7023'>
            do k = 1, nscat<a name='7024'>
        if(k.ne.14) then<a name='7025'>
<font color=#447700>!exclude watrer points from this loop<a name='7026'></font>
          AREA   = AREA + soilfrac(k)<a name='7027'>
          RHOCS  = RHOCS + HC(k)*1.E6*soilfrac(k)<a name='7028'>
          BCLH   = BCLH + BB(K)*soilfrac(k)<a name='7029'>
          DQM    = DQM + (MAXSMC(K)-                               &amp;<a name='7030'>
                   DRYSMC(K))*soilfrac(k)<a name='7031'>
          KSAT   = KSAT + SATDK(K)*soilfrac(k)<a name='7032'>
          PSIS   = PSIS - SATPSI(K)*soilfrac(k)<a name='7033'>
          QMIN   = QMIN + DRYSMC(K)*soilfrac(k)<a name='7034'>
          REF    = REF + REFSMC(K)*soilfrac(k)<a name='7035'>
          WILT   = WILT + WLTSMC(K)*soilfrac(k)<a name='7036'>
          QWRTZ  = QWRTZ + QTZ(K)*soilfrac(k)<a name='7037'>
        endif<a name='7038'>
            enddo<a name='7039'>
       if (area.gt.1.) area=1.<a name='7040'>
       if (area &lt;= 0.) then<a name='7041'>
<font color=#447700>! area = 0. for water points<a name='7042'></font>
<font color=#447700>!          print *,'Area of a grid box', area, 'iswater = ',iswater<a name='7043'></font>
          RHOCS  = HC(ISLTYP)*1.E6<a name='7044'>
          BCLH   = BB(ISLTYP)<a name='7045'>
          DQM    = MAXSMC(ISLTYP)-                               &amp;<a name='7046'>
                   DRYSMC(ISLTYP)<a name='7047'>
          KSAT   = SATDK(ISLTYP)<a name='7048'>
          PSIS   = - SATPSI(ISLTYP)<a name='7049'>
          QMIN   = DRYSMC(ISLTYP)<a name='7050'>
          REF    = REFSMC(ISLTYP)<a name='7051'>
          WILT   = WLTSMC(ISLTYP)<a name='7052'>
          QWRTZ  = QTZ(ISLTYP)<a name='7053'>
       else<a name='7054'>
          RHOCS  = RHOCS/AREA<a name='7055'>
          BCLH   = BCLH/AREA<a name='7056'>
          DQM    = DQM/AREA<a name='7057'>
          KSAT   = KSAT/AREA<a name='7058'>
          PSIS   = PSIS/AREA<a name='7059'>
          QMIN   = QMIN/AREA<a name='7060'>
          REF    = REF/AREA<a name='7061'>
          WILT   = WILT/AREA<a name='7062'>
          QWRTZ  = QWRTZ/AREA<a name='7063'>
       endif<a name='7064'>
<a name='7065'>
<font color=#447700>! dominant category approach<a name='7066'></font>
        else<a name='7067'>
          RHOCS  = HC(ISLTYP)*1.E6<a name='7068'>
          BCLH   = BB(ISLTYP)<a name='7069'>
          DQM    = MAXSMC(ISLTYP)-                               &amp;<a name='7070'>
                   DRYSMC(ISLTYP)<a name='7071'>
          KSAT   = SATDK(ISLTYP)<a name='7072'>
          PSIS   = - SATPSI(ISLTYP)<a name='7073'>
          QMIN   = DRYSMC(ISLTYP)<a name='7074'>
          REF    = REFSMC(ISLTYP)<a name='7075'>
          WILT   = WLTSMC(ISLTYP)<a name='7076'>
          QWRTZ  = QTZ(ISLTYP)<a name='7077'>
        endif<a name='7078'>
<a name='7079'>
<font color=#447700>! parameters from the look-up tables<a name='7080'></font>
<font color=#447700>!          BCLH   = LBCL(ISLTYP)<a name='7081'></font>
<font color=#447700>!          DQM    = LQMA(ISLTYP)-                               &amp;<a name='7082'></font>
<font color=#447700>!                   LQMI(ISLTYP)<a name='7083'></font>
<font color=#447700>!          KSAT   = LKAS(ISLTYP)<a name='7084'></font>
<font color=#447700>!          PSIS   = - LPSI(ISLTYP)<a name='7085'></font>
<font color=#447700>!          QMIN   = LQMI(ISLTYP)<a name='7086'></font>
<font color=#447700>!          REF    = LREF(ISLTYP)<a name='7087'></font>
<font color=#447700>!          WILT   = LWIL(ISLTYP)<a name='7088'></font>
<font color=#447700>!          QWRTZ  = DATQTZ(ISLTYP)<a name='7089'></font>
<a name='7090'>
<font color=#447700>!--------------------------------------------------------------------------<a name='7091'></font>
   END SUBROUTINE SOILVEGIN<a name='7092'>
<font color=#447700>!--------------------------------------------------------------------------<a name='7093'></font>
<a name='7094'>
<A NAME='RUCLSMINIT'><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSMINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7095'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>RUCLSMINIT</font>( SH2O,SMFR3D,TSLB,SMOIS,ISLTYP,IVGTYP,     &amp; <A href='../../call_to/RUCLSMINIT.html' TARGET='index'>1</A>,<A href='../../call_from/RUCLSMINIT.html' TARGET='index'>5</A><a name='7096'>
                     mminlu, XICE,mavail,nzs, iswater, isice,      &amp;<a name='7097'>
                     znt, restart, allowed_to_read ,               &amp;<a name='7098'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='7099'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='7100'>
                     its,ite, jts,jte, kts,kte                     )<a name='7101'>
#if ( WRF_CHEM == 1 )<a name='7102'>
  USE <A href='../../html_code/phys/module_data_gocart_dust.F.html#MODULE_DATA_GOCART_DUST'>module_data_gocart_dust</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATA_GOCART_DUST_3"><a name='7103'>
#endif<a name='7104'>
   IMPLICIT NONE<a name='7105'>
<a name='7106'>
<a name='7107'>
   INTEGER,  INTENT(IN   )   ::     ids,ide, jds,jde, kds,kde,  &amp;<a name='7108'>
                                    ims,ime, jms,jme, kms,kme,  &amp;<a name='7109'>
                                    its,ite, jts,jte, kts,kte,  &amp;<a name='7110'>
                                    nzs, iswater, isice<a name='7111'>
   CHARACTER(LEN=*), INTENT(IN   )    ::                 MMINLU<a name='7112'>
<a name='7113'>
   REAL, DIMENSION( ims:ime, 1:nzs, jms:jme )                    , &amp;<a name='7114'>
            INTENT(IN)    ::                                 TSLB, &amp;<a name='7115'>
                                                            SMOIS<a name='7116'>
<a name='7117'>
   INTEGER, DIMENSION( ims:ime, jms:jme )                        , &amp;<a name='7118'>
            INTENT(INOUT)    ::                     ISLTYP,IVGTYP<a name='7119'>
<a name='7120'>
   REAL, DIMENSION( ims:ime, 1:nzs, jms:jme )                    , &amp;<a name='7121'>
            INTENT(INOUT)    ::                            SMFR3D, &amp;<a name='7122'>
                                                             SH2O<a name='7123'>
<a name='7124'>
   REAL, DIMENSION( ims:ime, jms:jme )                           , &amp;<a name='7125'>
            INTENT(INOUT)    ::                       XICE,MAVAIL<a name='7126'>
<a name='7127'>
   REAL, DIMENSION( ims:ime, jms:jme )                           , &amp;<a name='7128'>
            INTENT(  OUT)    ::                               znt<a name='7129'>
<a name='7130'>
   REAL, DIMENSION ( 1:nzs )  ::                           SOILIQW<a name='7131'>
<a name='7132'>
   LOGICAL , INTENT(IN) :: restart, allowed_to_read <a name='7133'>
<a name='7134'>
<font color=#447700>!<a name='7135'></font>
  INTEGER ::  I,J,L,itf,jtf<a name='7136'>
  REAL    ::  RIW,XLMELT,TLN,DQM,REF,PSIS,QMIN,BCLH<a name='7137'>
<a name='7138'>
  character*8 :: MMINLURUC, MMINSL<a name='7139'>
<a name='7140'>
   INTEGER                   :: errflag<a name='7141'>
<a name='7142'>
<font color=#447700>!   itf=min0(ite,ide-1)<a name='7143'></font>
<font color=#447700>!   jtf=min0(jte,jde-1)<a name='7144'></font>
<a name='7145'>
<a name='7146'>
        RIW=900.*1.e-3<a name='7147'>
        XLMELT=3.35E+5<a name='7148'>
<a name='7149'>
<font color=#447700>! initialize three  LSM related tables<a name='7150'></font>
   IF ( allowed_to_read ) THEN<a name='7151'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_988">( 'INITIALIZE THREE LSM RELATED TABLES' )<a name='7152'>
      if(mminlu == 'USGS') then<a name='7153'>
        MMINLURUC='USGS-RUC'<a name='7154'>
      elseif(mminlu == 'MODIS' .OR. &amp;<a name='7155'>
        &amp;    mminlu == 'MODIFIED_IGBP_MODIS_NOAH') then<a name='7156'>
        MMINLURUC='MODI-RUC'<a name='7157'>
      endif<a name='7158'>
        MMINSL='STAS-RUC'<a name='7159'>
<font color=#447700>!     CALL  RUCLSM_PARM_INIT<a name='7160'></font>
    print *,'RUCLSMINIT uses ',mminluruc<a name='7161'>
     call <A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM'>RUCLSM_SOILVEGPARM</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RUCLSM_SOILVEGPARM_1">( MMINLURUC, MMINSL)   <a name='7162'>
   ENDIF<a name='7163'>
<a name='7164'>
<font color=#447700>!#if ( WRF_CHEM == 1 )<a name='7165'></font>
<font color=#447700>!<a name='7166'></font>
<font color=#447700>! need this parameter for dust parameterization in wrf/chem<a name='7167'></font>
<font color=#447700>!<a name='7168'></font>
<font color=#447700>!   do I=1,NSLTYPE<a name='7169'></font>
<font color=#447700>!      porosity(i)=maxsmc(i)<a name='7170'></font>
<font color=#447700>!      drypoint(i)=drysmc(i)<a name='7171'></font>
<font color=#447700>!   enddo<a name='7172'></font>
<font color=#447700>!#endif<a name='7173'></font>
<font color=#447700>!<a name='7174'></font>
 IF(.not.restart)THEN<a name='7175'>
<a name='7176'>
   itf=min0(ite,ide-1)<a name='7177'>
   jtf=min0(jte,jde-1)<a name='7178'>
<a name='7179'>
   errflag = 0<a name='7180'>
   DO j = jts,jtf<a name='7181'>
     DO i = its,itf<a name='7182'>
       IF ( ISLTYP( i,j ) .LT. 1 ) THEN<a name='7183'>
         errflag = 1<a name='7184'>
         WRITE(err_message,*)"module_sf_ruclsm.F: lsminit: out of range ISLTYP ",i,j,ISLTYP( i,j )<a name='7185'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_989">(err_message)<a name='7186'>
       ENDIF<a name='7187'>
     ENDDO<a name='7188'>
   ENDDO<a name='7189'>
   IF ( errflag .EQ. 1 ) THEN<a name='7190'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1201">( "module_sf_ruclsm.F: lsminit: out of range value "// &amp;<a name='7191'>
                            "of ISLTYP. Is this field in the input?" )<a name='7192'>
   ENDIF<a name='7193'>
<a name='7194'>
   DO J=jts,jtf<a name='7195'>
       DO I=its,itf<a name='7196'>
<a name='7197'>
        ZNT(I,J)   = Z0TBL(IVGTYP(I,J))<a name='7198'>
<a name='7199'>
<font color=#447700>!     CALL SOILIN     ( ISLTYP(I,J), DQM, REF, PSIS, QMIN, BCLH )<a name='7200'></font>
<a name='7201'>
<a name='7202'>
<font color=#447700>!--- Computation of volumetric content of ice in soil<a name='7203'></font>
<font color=#447700>!--- and initialize MAVAIL<a name='7204'></font>
          DQM    = MAXSMC   (ISLTYP(I,J)) -                               &amp;<a name='7205'>
                   DRYSMC   (ISLTYP(I,J))<a name='7206'>
          REF    = REFSMC   (ISLTYP(I,J))<a name='7207'>
          PSIS   = - SATPSI (ISLTYP(I,J))<a name='7208'>
          QMIN   = DRYSMC   (ISLTYP(I,J))<a name='7209'>
          BCLH   = BB       (ISLTYP(I,J))<a name='7210'>
<a name='7211'>
<a name='7212'>
<font color=#447700>!!!     IF (.not.restart) THEN<a name='7213'></font>
<a name='7214'>
    IF(xice(i,j).gt.0.) THEN<a name='7215'>
<font color=#447700>!-- for ice<a name='7216'></font>
         DO L=1,NZS<a name='7217'>
           smfr3d(i,l,j)=1.<a name='7218'>
           sh2o(i,l,j)=0.<a name='7219'>
           mavail(i,j) = 1.<a name='7220'>
         ENDDO<a name='7221'>
    ELSE<a name='7222'>
       if(isltyp(i,j).ne.14 ) then<a name='7223'>
<font color=#447700>!-- land<a name='7224'></font>
<font color=#447700>!           mavail(i,j) = max(0.00001,min(1.,(smois(i,1,j)-qmin)/dqm))<a name='7225'></font>
           mavail(i,j) = max(0.00001,min(1.,smois(i,1,j)/(ref-qmin)))<a name='7226'>
         DO L=1,NZS<a name='7227'>
<font color=#447700>!-- for land points initialize soil ice<a name='7228'></font>
         tln=log(TSLB(i,l,j)/273.15)<a name='7229'>
          <a name='7230'>
          if(tln.lt.0.) then<a name='7231'>
           soiliqw(l)=(dqm+qmin)*(XLMELT*                        &amp;<a name='7232'>
         (tslb(i,l,j)-273.15)/tslb(i,l,j)/9.81/psis)             &amp;<a name='7233'>
          **(-1./bclh)<a name='7234'>
<font color=#447700>!          **(-1./bclh)-qmin<a name='7235'></font>
           soiliqw(l)=max(0.,soiliqw(l))<a name='7236'>
           soiliqw(l)=min(soiliqw(l),smois(i,l,j))<a name='7237'>
           sh2o(i,l,j)=soiliqw(l)<a name='7238'>
           smfr3d(i,l,j)=(smois(i,l,j)-soiliqw(l))/RIW<a name='7239'>
         <a name='7240'>
          else<a name='7241'>
           smfr3d(i,l,j)=0.<a name='7242'>
           sh2o(i,l,j)=smois(i,l,j)<a name='7243'>
          endif<a name='7244'>
         ENDDO<a name='7245'>
    <a name='7246'>
       else<a name='7247'>
<font color=#447700>!-- for water  ISLTYP=14<a name='7248'></font>
         DO L=1,NZS<a name='7249'>
           smfr3d(i,l,j)=0.<a name='7250'>
           sh2o(i,l,j)=1.<a name='7251'>
           mavail(i,j) = 1.<a name='7252'>
         ENDDO<a name='7253'>
       endif<a name='7254'>
    ENDIF<a name='7255'>
<a name='7256'>
    ENDDO<a name='7257'>
   ENDDO<a name='7258'>
<a name='7259'>
 ENDIF<a name='7260'>
<a name='7261'>
  END SUBROUTINE ruclsminit<a name='7262'>
<font color=#447700>!<a name='7263'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='7264'></font>
<font color=#447700>!        SUBROUTINE RUCLSM_PARM_INIT<a name='7265'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='7266'></font>
<a name='7267'>
<font color=#447700>!        character*9 :: MMINLU, MMINSL<a name='7268'></font>
<a name='7269'>
<font color=#447700>!        MMINLU='MODIS-RUC'<a name='7270'></font>
<font color=#447700>!        MMINLU='USGS-RUC'<a name='7271'></font>
<font color=#447700>!        MMINSL='STAS-RUC'<a name='7272'></font>
<font color=#447700>!        call RUCLSM_SOILVEGPARM( MMINLU, MMINSL)<a name='7273'></font>
<a name='7274'>
<font color=#447700>!-----------------------------------------------------------------<a name='7275'></font>
<font color=#447700>!        END SUBROUTINE RUCLSM_PARM_INIT<a name='7276'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='7277'></font>
<a name='7278'>
<font color=#447700>!-----------------------------------------------------------------<a name='7279'></font>
<A NAME='RUCLSM_SOILVEGPARM'><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7280'>
        <font color=#993300>SUBROUTINE </font><font color=#cc0000>RUCLSM_SOILVEGPARM</font>( MMINLURUC, MMINSL) <A href='../../call_to/RUCLSM_SOILVEGPARM.html' TARGET='index'>1</A>,<A href='../../call_from/RUCLSM_SOILVEGPARM.html' TARGET='index'>71</A><a name='7281'>
<font color=#447700>!-----------------------------------------------------------------<a name='7282'></font>
<a name='7283'>
        IMPLICIT NONE<a name='7284'>
<a name='7285'>
        integer :: LUMATCH, IINDEX, LC, NUM_SLOPE<a name='7286'>
        integer :: ierr<a name='7287'>
        INTEGER , PARAMETER :: OPEN_OK = 0<a name='7288'>
<a name='7289'>
        character*8 :: MMINLURUC, MMINSL<a name='7290'>
        character*128 :: mess , message, vege_parm_string<a name='7291'>
        logical, external :: wrf_dm_on_monitor<a name='7292'>
<a name='7293'>
<a name='7294'>
<font color=#447700>!-----SPECIFY VEGETATION RELATED CHARACTERISTICS :<a name='7295'></font>
<font color=#447700>!             ALBBCK: SFC albedo (in percentage)<a name='7296'></font>
<font color=#447700>!                 Z0: Roughness length (m)<a name='7297'></font>
<font color=#447700>!               LEMI: Emissivity<a name='7298'></font>
<font color=#447700>!                 PC: Plant coefficient for transpiration function<a name='7299'></font>
<font color=#447700>! -- the rest of the parameters are read in but not used currently<a name='7300'></font>
<font color=#447700>!             SHDFAC: Green vegetation fraction (in percentage)<a name='7301'></font>
<font color=#447700>!  Note: The ALBEDO, Z0, and SHDFAC values read from the following table<a name='7302'></font>
<font color=#447700>!          ALBEDO, amd Z0 are specified in LAND-USE TABLE; and SHDFAC is<a name='7303'></font>
<font color=#447700>!          the monthly green vegetation data<a name='7304'></font>
<font color=#447700>!             CMXTBL: MAX CNPY Capacity (m)<a name='7305'></font>
<font color=#447700>!              RSMIN: Mimimum stomatal resistance (s m-1)<a name='7306'></font>
<font color=#447700>!              RSMAX: Max. stomatal resistance (s m-1)<a name='7307'></font>
<font color=#447700>!                RGL: Parameters used in radiation stress function<a name='7308'></font>
<font color=#447700>!                 HS: Parameter used in vapor pressure deficit functio<a name='7309'></font>
<font color=#447700>!               TOPT: Optimum transpiration air temperature. (K)<a name='7310'></font>
<font color=#447700>!             CMCMAX: Maximum canopy water capacity<a name='7311'></font>
<font color=#447700>!             CFACTR: Parameter used in the canopy inteception calculati<a name='7312'></font>
<font color=#447700>!               SNUP: Threshold snow depth (in water equivalent m) that<a name='7313'></font>
<font color=#447700>!                     implies 100% snow cover<a name='7314'></font>
<font color=#447700>!                LAI: Leaf area index (dimensionless)<a name='7315'></font>
<font color=#447700>!             MAXALB: Upper bound on maximum albedo over deep snow<a name='7316'></font>
<font color=#447700>!<a name='7317'></font>
<font color=#447700>!-----READ IN VEGETAION PROPERTIES FROM VEGPARM.TBL <a name='7318'></font>
<font color=#447700>!                                                                       <a name='7319'></font>
<a name='7320'>
       IF ( wrf_dm_on_monitor() ) THEN<a name='7321'>
<a name='7322'>
        OPEN(19, FILE='VEGPARM.TBL',FORM='FORMATTED',STATUS='OLD',IOSTAT=ierr)<a name='7323'>
        IF(ierr .NE. OPEN_OK ) THEN<a name='7324'>
          WRITE(message,FMT='(A)') &amp;<a name='7325'>
          'module_sf_ruclsm.F: soil_veg_gen_parm: failure opening VEGPARM.TBL'<a name='7326'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1202"> ( message )<a name='7327'>
        END IF<a name='7328'>
<a name='7329'>
        WRITE ( mess, * ) 'INPUT VEGPARM FOR ',MMINLURUC<a name='7330'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_990">( mess )<a name='7331'>
<a name='7332'>
        LUMATCH=0<a name='7333'>
<a name='7334'>
 2000   FORMAT (A8)<a name='7335'>
        READ (19,'(A)') vege_parm_string<a name='7336'>
        outer : DO <a name='7337'>
           READ (19,2000,END=2002)LUTYPE<a name='7338'>
           READ (19,*)LUCATS,IINDEX<a name='7339'>
<a name='7340'>
           WRITE( mess , * ) 'VEGPARM FOR ',LUTYPE,' FOUND', LUCATS,' CATEGORIES'<a name='7341'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_991">( mess )<a name='7342'>
<a name='7343'>
           IF(LUTYPE.NE.MMINLURUC)THEN    <font color=#447700>! Skip over the undesired table<a name='7344'></font>
              write ( mess , * ) 'Skipping ', LUTYPE, ' table'<a name='7345'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_992">( mess )<a name='7346'>
              DO LC=1,LUCATS<a name='7347'>
                 READ (19,*)<a name='7348'>
              ENDDO<a name='7349'>
              inner : DO               <font color=#447700>! Find the next "Vegetation Parameters"<a name='7350'></font>
                 READ (19,'(A)',END=2002) vege_parm_string<a name='7351'>
                 IF (TRIM(vege_parm_string) .EQ. "Vegetation Parameters") THEN<a name='7352'>
                    EXIT inner<a name='7353'>
                 END IF<a name='7354'>
               ENDDO inner<a name='7355'>
           ELSE<a name='7356'>
              LUMATCH=1<a name='7357'>
              write ( mess , * ) 'Found ', LUTYPE, ' table'<a name='7358'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_993">( mess )<a name='7359'>
              EXIT outer                <font color=#447700>! Found the table, read the data<a name='7360'></font>
           END IF<a name='7361'>
<a name='7362'>
        ENDDO outer<a name='7363'>
<a name='7364'>
        IF (LUMATCH == 1) then<a name='7365'>
           write ( mess , * ) 'Reading ',LUTYPE,' table'<a name='7366'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_994">( mess )<a name='7367'>
           DO LC=1,LUCATS<a name='7368'>
              READ (19,*)IINDEX,ALBTBL(LC),Z0TBL(LC),LEMITBL(LC),PCTBL(LC), &amp;<a name='7369'>
                         SHDTBL(LC),IFORTBL(LC),RSTBL(LC),RGLTBL(LC),         &amp;<a name='7370'>
                         HSTBL(LC),SNUPTBL(LC),LAITBL(LC),MAXALB(LC)<a name='7371'>
           ENDDO<a name='7372'>
<font color=#447700>!<a name='7373'></font>
           READ (19,*)<a name='7374'>
           READ (19,*)TOPT_DATA<a name='7375'>
           READ (19,*)<a name='7376'>
           READ (19,*)CMCMAX_DATA<a name='7377'>
           READ (19,*)<a name='7378'>
           READ (19,*)CFACTR_DATA<a name='7379'>
           READ (19,*)<a name='7380'>
           READ (19,*)RSMAX_DATA<a name='7381'>
           READ (19,*)<a name='7382'>
           READ (19,*)BARE<a name='7383'>
           READ (19,*)<a name='7384'>
           READ (19,*)NATURAL<a name='7385'>
           READ (19,*)<a name='7386'>
           READ (19,*)CROP<a name='7387'>
           READ (19,*)<a name='7388'>
           READ (19,*,iostat=ierr)URBAN<a name='7389'>
           if ( ierr /= 0 ) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_995">     (  "-------- VEGPARM.TBL READ ERROR --------")<a name='7390'>
           if ( ierr /= 0 ) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_996">     (  "Problem read URBAN from VEGPARM.TBL")<a name='7391'>
           if ( ierr /= 0 ) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_997">     (  " -- Use updated version of VEGPARM.TBL  ")<a name='7392'>
           if ( ierr /= 0 ) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1203"> (  "Problem read URBAN from VEGPARM.TBL")<a name='7393'>
<a name='7394'>
        ENDIF<a name='7395'>
<a name='7396'>
 2002   CONTINUE<a name='7397'>
        CLOSE (19)<a name='7398'>
<font color=#447700>!-----<a name='7399'></font>
    IF ( wrf_at_debug_level(LSMRUC_DBG_LVL) ) THEN<a name='7400'>
         print *,' LEMITBL, PCTBL, Z0TBL, LAITBL ---&gt;', LEMITBL, PCTBL, Z0TBL, LAITBL<a name='7401'>
    ENDIF<a name='7402'>
<a name='7403'>
<a name='7404'>
        IF (LUMATCH == 0) then<a name='7405'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1204"> ("Land Use Dataset '"//MMINLURUC//"' not found in VEGPARM.TBL.")<a name='7406'>
        ENDIF<a name='7407'>
<a name='7408'>
      END IF<a name='7409'>
<a name='7410'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_STRING'>wrf_dm_bcast_string</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_STRING_16">  ( LUTYPE  , 8 )<a name='7411'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_50"> ( LUCATS  , 1 )<a name='7412'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_51"> ( IINDEX  , 1 )<a name='7413'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_52"> ( LUMATCH , 1 )<a name='7414'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_105">    ( ALBTBL  , NLUS )<a name='7415'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_106">    ( Z0TBL   , NLUS )<a name='7416'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_107">    ( LEMITBL , NLUS )<a name='7417'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_108">    ( PCTBL   , NLUS )<a name='7418'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_109">    ( SHDTBL  , NLUS )<a name='7419'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_110">    ( IFORTBL , NLUS )<a name='7420'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_111">    ( RSTBL   , NLUS )<a name='7421'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_112">    ( RGLTBL  , NLUS )<a name='7422'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_113">    ( HSTBL   , NLUS )<a name='7423'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_114">    ( SNUPTBL , NLUS )<a name='7424'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_115">    ( LAITBL  , NLUS )<a name='7425'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_116">    ( MAXALB  , NLUS )<a name='7426'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_117">    ( TOPT_DATA    , 1 )<a name='7427'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_118">    ( CMCMAX_DATA  , 1 )<a name='7428'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_119">    ( CFACTR_DATA  , 1 )<a name='7429'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_120">    ( RSMAX_DATA  , 1 )<a name='7430'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_53"> ( BARE        , 1 )<a name='7431'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_54"> ( NATURAL     , 1 )<a name='7432'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_55"> ( CROP        , 1 )<a name='7433'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_56"> ( URBAN       , 1 )<a name='7434'>
<a name='7435'>
<font color=#447700>!                                                                       <a name='7436'></font>
<font color=#447700>!-----READ IN SOIL PROPERTIES FROM SOILPARM.TBL<a name='7437'></font>
<font color=#447700>!                                                                       <a name='7438'></font>
      IF ( wrf_dm_on_monitor() ) THEN<a name='7439'>
        OPEN(19, FILE='SOILPARM.TBL',FORM='FORMATTED',STATUS='OLD',IOSTAT=ierr)<a name='7440'>
        IF(ierr .NE. OPEN_OK ) THEN<a name='7441'>
          WRITE(message,FMT='(A)') &amp;<a name='7442'>
          'module_sf_ruclsm.F: soil_veg_gen_parm: failure opening SOILPARM.TBL'<a name='7443'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1205"> ( message )<a name='7444'>
        END IF<a name='7445'>
<a name='7446'>
        WRITE(mess,*) 'INPUT SOIL TEXTURE CLASSIFICATION = ',MMINSL<a name='7447'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_998">( mess )<a name='7448'>
<a name='7449'>
        LUMATCH=0<a name='7450'>
<a name='7451'>
        READ (19,*)<a name='7452'>
        READ (19,2000,END=2003)SLTYPE<a name='7453'>
        READ (19,*)SLCATS,IINDEX<a name='7454'>
        IF(SLTYPE.NE.MMINSL)THEN<a name='7455'>
          DO LC=1,SLCATS<a name='7456'>
              READ (19,*) IINDEX,BB(LC),DRYSMC(LC),HC(LC),MAXSMC(LC),&amp;<a name='7457'>
                        REFSMC(LC),SATPSI(LC),SATDK(LC), SATDW(LC),   &amp;<a name='7458'>
                        WLTSMC(LC), QTZ(LC)<a name='7459'>
          ENDDO<a name='7460'>
        ENDIF<a name='7461'>
        READ (19,*)<a name='7462'>
        READ (19,2000,END=2003)SLTYPE<a name='7463'>
        READ (19,*)SLCATS,IINDEX<a name='7464'>
 <a name='7465'>
        IF(SLTYPE.EQ.MMINSL)THEN<a name='7466'>
            WRITE( mess , * ) 'SOIL TEXTURE CLASSIFICATION = ',SLTYPE,' FOUND', &amp;<a name='7467'>
                  SLCATS,' CATEGORIES'<a name='7468'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_999"> ( mess )<a name='7469'>
          LUMATCH=1<a name='7470'>
        ENDIF<a name='7471'>
            IF(SLTYPE.EQ.MMINSL)THEN<a name='7472'>
          DO LC=1,SLCATS<a name='7473'>
              READ (19,*) IINDEX,BB(LC),DRYSMC(LC),HC(LC),MAXSMC(LC),&amp;<a name='7474'>
                        REFSMC(LC),SATPSI(LC),SATDK(LC), SATDW(LC),   &amp;<a name='7475'>
                        WLTSMC(LC), QTZ(LC)<a name='7476'>
          ENDDO<a name='7477'>
           ENDIF<a name='7478'>
<a name='7479'>
 2003   CONTINUE<a name='7480'>
<a name='7481'>
        CLOSE (19)<a name='7482'>
      ENDIF<a name='7483'>
<a name='7484'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_57"> ( LUMATCH , 1 )<a name='7485'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_STRING'>wrf_dm_bcast_string</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_STRING_17">  ( SLTYPE  , 8 )<a name='7486'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_STRING'>wrf_dm_bcast_string</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_STRING_18">  ( MMINSL  , 8 )  <font color=#447700>! since this is reset above, see oct2 ^<a name='7487'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_58"> ( SLCATS  , 1 )<a name='7488'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_59"> ( IINDEX  , 1 )<a name='7489'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_121">    ( BB      , NSLTYPE )<a name='7490'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_122">    ( DRYSMC  , NSLTYPE )<a name='7491'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_123">    ( HC      , NSLTYPE )<a name='7492'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_124">    ( MAXSMC  , NSLTYPE )<a name='7493'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_125">    ( REFSMC  , NSLTYPE )<a name='7494'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_126">    ( SATPSI  , NSLTYPE )<a name='7495'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_127">    ( SATDK   , NSLTYPE )<a name='7496'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_128">    ( SATDW   , NSLTYPE )<a name='7497'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_129">    ( WLTSMC  , NSLTYPE )<a name='7498'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_130">    ( QTZ     , NSLTYPE )<a name='7499'>
<a name='7500'>
      IF(LUMATCH.EQ.0)THEN<a name='7501'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1000">( 'SOIl TEXTURE IN INPUT FILE DOES NOT ' )<a name='7502'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1001">( 'MATCH SOILPARM TABLE'                 )<a name='7503'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1206"> ( 'INCONSISTENT OR MISSING SOILPARM FILE' )<a name='7504'>
      ENDIF<a name='7505'>
<a name='7506'>
<font color=#447700>!<a name='7507'></font>
<font color=#447700>!-----READ IN GENERAL PARAMETERS FROM GENPARM.TBL <a name='7508'></font>
<font color=#447700>!                                                                       <a name='7509'></font>
      IF ( wrf_dm_on_monitor() ) THEN<a name='7510'>
        OPEN(19, FILE='GENPARM.TBL',FORM='FORMATTED',STATUS='OLD',IOSTAT=ierr)<a name='7511'>
        IF(ierr .NE. OPEN_OK ) THEN<a name='7512'>
          WRITE(message,FMT='(A)') &amp;<a name='7513'>
          'module_sf_ruclsm.F: soil_veg_gen_parm: failure opening GENPARM.TBL'<a name='7514'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1207"> ( message )<a name='7515'>
        END IF<a name='7516'>
<a name='7517'>
        READ (19,*)<a name='7518'>
        READ (19,*)<a name='7519'>
        READ (19,*) NUM_SLOPE<a name='7520'>
<a name='7521'>
          SLPCATS=NUM_SLOPE<a name='7522'>
<a name='7523'>
          DO LC=1,SLPCATS<a name='7524'>
              READ (19,*)SLOPE_DATA(LC)<a name='7525'>
          ENDDO<a name='7526'>
<a name='7527'>
          READ (19,*)<a name='7528'>
          READ (19,*)SBETA_DATA<a name='7529'>
          READ (19,*)<a name='7530'>
          READ (19,*)FXEXP_DATA<a name='7531'>
          READ (19,*)<a name='7532'>
          READ (19,*)CSOIL_DATA<a name='7533'>
          READ (19,*)<a name='7534'>
          READ (19,*)SALP_DATA<a name='7535'>
          READ (19,*)<a name='7536'>
          READ (19,*)REFDK_DATA<a name='7537'>
          READ (19,*)<a name='7538'>
          READ (19,*)REFKDT_DATA<a name='7539'>
          READ (19,*)<a name='7540'>
          READ (19,*)FRZK_DATA<a name='7541'>
          READ (19,*)<a name='7542'>
          READ (19,*)ZBOT_DATA<a name='7543'>
          READ (19,*)<a name='7544'>
          READ (19,*)CZIL_DATA<a name='7545'>
          READ (19,*)<a name='7546'>
          READ (19,*)SMLOW_DATA<a name='7547'>
          READ (19,*)<a name='7548'>
          READ (19,*)SMHIGH_DATA<a name='7549'>
        CLOSE (19)<a name='7550'>
      ENDIF<a name='7551'>
<a name='7552'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_60"> ( NUM_SLOPE    ,  1 )<a name='7553'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_61"> ( SLPCATS      ,  1 )<a name='7554'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_131">    ( SLOPE_DATA   ,  NSLOPE )<a name='7555'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_132">    ( SBETA_DATA   ,  1 )<a name='7556'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_133">    ( FXEXP_DATA   ,  1 )<a name='7557'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_134">    ( CSOIL_DATA   ,  1 )<a name='7558'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_135">    ( SALP_DATA    ,  1 )<a name='7559'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_136">    ( REFDK_DATA   ,  1 )<a name='7560'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_137">    ( REFKDT_DATA  ,  1 )<a name='7561'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_138">    ( FRZK_DATA    ,  1 )<a name='7562'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_139">    ( ZBOT_DATA    ,  1 )<a name='7563'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_140">    ( CZIL_DATA    ,  1 )<a name='7564'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_141">    ( SMLOW_DATA   ,  1 )<a name='7565'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_ruclsm.F.html#RUCLSM_SOILVEGPARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_142">    ( SMHIGH_DATA  ,  1 )<a name='7566'>
<a name='7567'>
<a name='7568'>
<font color=#447700>!-----------------------------------------------------------------<a name='7569'></font>
      END SUBROUTINE RUCLSM_SOILVEGPARM<a name='7570'>
<font color=#447700>!-----------------------------------------------------------------<a name='7571'></font>
<a name='7572'>
<a name='7573'>
<A NAME='SOILIN'><A href='../../html_code/phys/module_sf_ruclsm.F.html#SOILIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7574'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOILIN</font> (ISLTYP, DQM, REF, PSIS, QMIN, BCLH )<a name='7575'>
<a name='7576'>
<font color=#447700>!---    soiltyp classification according to STATSGO(nclasses=16)<a name='7577'></font>
<font color=#447700>!<a name='7578'></font>
<font color=#447700>!             1          SAND                  SAND<a name='7579'></font>
<font color=#447700>!             2          LOAMY SAND            LOAMY SAND<a name='7580'></font>
<font color=#447700>!             3          SANDY LOAM            SANDY LOAM<a name='7581'></font>
<font color=#447700>!             4          SILT LOAM             SILTY LOAM<a name='7582'></font>
<font color=#447700>!             5          SILT                  SILTY LOAM<a name='7583'></font>
<font color=#447700>!             6          LOAM                  LOAM<a name='7584'></font>
<font color=#447700>!             7          SANDY CLAY LOAM       SANDY CLAY LOAM<a name='7585'></font>
<font color=#447700>!             8          SILTY CLAY LOAM       SILTY CLAY LOAM<a name='7586'></font>
<font color=#447700>!             9          CLAY LOAM             CLAY LOAM<a name='7587'></font>
<font color=#447700>!            10          SANDY CLAY            SANDY CLAY<a name='7588'></font>
<font color=#447700>!            11          SILTY CLAY            SILTY CLAY<a name='7589'></font>
<font color=#447700>!            12          CLAY                  LIGHT CLAY<a name='7590'></font>
<font color=#447700>!            13          ORGANIC MATERIALS     LOAM<a name='7591'></font>
<font color=#447700>!            14          WATER<a name='7592'></font>
<font color=#447700>!            15          BEDROCK<a name='7593'></font>
<font color=#447700>!                        Bedrock is reclassified as class 14<a name='7594'></font>
<font color=#447700>!            16          OTHER (land-ice)<a name='7595'></font>
<font color=#447700>! extra classes from Fei Chen<a name='7596'></font>
<font color=#447700>!            17          Playa<a name='7597'></font>
<font color=#447700>!            18          Lava<a name='7598'></font>
<font color=#447700>!            19          White Sand<a name='7599'></font>
<font color=#447700>!<a name='7600'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='7601'></font>
         integer,   parameter      ::      nsoilclas=19<a name='7602'>
<a name='7603'>
         integer, intent ( in)  ::                          isltyp<a name='7604'>
         real,    intent ( out) ::               dqm,ref,qmin,psis<a name='7605'>
<a name='7606'>
         REAL  LQMA(nsoilclas),LREF(nsoilclas),LBCL(nsoilclas),       &amp;<a name='7607'>
               LPSI(nsoilclas),LQMI(nsoilclas)<a name='7608'>
<a name='7609'>
<font color=#447700>!-- LQMA Rawls et al.[1982]<a name='7610'></font>
<font color=#447700>!        DATA LQMA /0.417, 0.437, 0.453, 0.501, 0.486, 0.463, 0.398,<a name='7611'></font>
<font color=#447700>!     &amp;  0.471, 0.464, 0.430, 0.479, 0.475, 0.439, 1.0, 0.20, 0.401/<a name='7612'></font>
<font color=#447700>!---<a name='7613'></font>
<font color=#447700>!-- Clapp, R. and G. Hornberger, Empirical equations for some soil<a name='7614'></font>
<font color=#447700>!   hydraulic properties, Water Resour. Res., 14,601-604,1978.<a name='7615'></font>
<font color=#447700>!-- Clapp et al. [1978]<a name='7616'></font>
     DATA LQMA /0.395, 0.410, 0.435, 0.485, 0.485, 0.451, 0.420,      &amp;<a name='7617'>
                0.477, 0.476, 0.426, 0.492, 0.482, 0.451, 1.0,        &amp;<a name='7618'>
                0.20,  0.435, 0.468, 0.200, 0.339/<a name='7619'>
<a name='7620'>
<font color=#447700>!-- Clapp et al. [1978]<a name='7621'></font>
        DATA LREF /0.174, 0.179, 0.249, 0.369, 0.369, 0.314, 0.299,   &amp;<a name='7622'>
                   0.357, 0.391, 0.316, 0.409, 0.400, 0.314, 1.,      &amp;<a name='7623'>
                   0.1,   0.249, 0.454, 0.17,  0.236/<a name='7624'>
<a name='7625'>
<font color=#447700>!-- Carsel and Parrish [1988]<a name='7626'></font>
        DATA LQMI/0.045, 0.057, 0.065, 0.067, 0.034, 0.078, 0.10,     &amp;<a name='7627'>
                  0.089, 0.095, 0.10,  0.070, 0.068, 0.078, 0.0,      &amp;<a name='7628'>
                  0.004, 0.065, 0.020, 0.004, 0.008/<a name='7629'>
<a name='7630'>
<font color=#447700>!-- Clapp et al. [1978]<a name='7631'></font>
       DATA LPSI/0.121, 0.090, 0.218, 0.786, 0.786, 0.478, 0.299,     &amp;<a name='7632'>
                 0.356, 0.630, 0.153, 0.490, 0.405, 0.478, 0.0,       &amp;<a name='7633'>
                 0.121, 0.218, 0.468, 0.069, 0.069/<a name='7634'>
<a name='7635'>
<font color=#447700>!-- Clapp et al. [1978]<a name='7636'></font>
        DATA LBCL/4.05,  4.38,  4.90,  5.30,  5.30,  5.39,  7.12,      &amp;<a name='7637'>
                  7.75,  8.52, 10.40, 10.40, 11.40,  5.39,  0.0,       &amp;<a name='7638'>
                  4.05,  4.90, 11.55,  2.79,  2.79/<a name='7639'>
<a name='7640'>
<a name='7641'>
          DQM    = LQMA(ISLTYP)-                               &amp;<a name='7642'>
                   LQMI(ISLTYP)<a name='7643'>
          REF    = LREF(ISLTYP)<a name='7644'>
          PSIS   = - LPSI(ISLTYP)<a name='7645'>
          QMIN   = LQMI(ISLTYP)<a name='7646'>
          BCLH   = LBCL(ISLTYP)<a name='7647'>
<a name='7648'>
  END SUBROUTINE SOILIN<a name='7649'>
<a name='7650'>
END MODULE module_sf_ruclsm<a name='7651'>
</pre></body></html>