<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>!wrf:model_layer:physics<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<font color=#447700>!####################tiedtke scheme#########################<a name='6'></font>
<font color=#447700>!   taken from the IPRC IRAM - Yuqing Wang, university of hawaii<a name='7'></font>
<font color=#447700>!   added by Chunxi Zhang and Yuqing Wang to wrf3.2, may, 2010<a name='8'></font>
<font color=#447700>!   refenrence: Tiedtke (1989, mwr, 117, 1779-1800)<a name='9'></font>
<font color=#447700>!               Nordeng, t.e., (1995), cape closure and organized entrainment/detrainment<a name='10'></font>
<font color=#447700>!               Yuqing Wang et al. (2003,j. climate, 16, 1721-1738) for improvements <a name='11'></font>
<font color=#447700>!                                                  for cloud top detrainment <a name='12'></font>
<font color=#447700>!                       (2004, mon. wea. rev., 132, 274-296), improvements for pbl clouds<a name='13'></font>
<font color=#447700>!                       (2007,mon. wea. rev., 135, 567-585), diurnal cycle of precipitation<a name='14'></font>
<font color=#447700>!###########################################################<a name='15'></font>
<A NAME='MODULE_CU_TIEDTKE'><A href='../../html_code/phys/module_cu_tiedtke.F.html#MODULE_CU_TIEDTKE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='16'>
<font color=#993300>module </font><font color=#cc0000>module_cu_tiedtke</font> <A href='../../call_to/MODULE_CU_TIEDTKE.html' TARGET='index'>2</A><a name='17'>
<font color=#447700>!<a name='18'></font>
     use <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#module_cu_tiedtke.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_52">, only:rd=&gt;r_d, rv=&gt;r_v, &amp;<a name='19'>
   &amp;       cpd=&gt;cp, alv=&gt;xlv, als=&gt;xls, alf=&gt;xlf, g<a name='20'>
<a name='21'>
     implicit none<a name='22'>
<a name='23'>
     real :: rcpd,vtmpc1,t000,hgfr,rhoh2o,tmelt, &amp;<a name='24'>
             c1es,c2es,c3les,c3ies,c4les,c4ies,c5les,c5ies,zrg <a name='25'>
    <a name='26'>
     real :: entrpen,entrscv,entrmid,entrdd,cmfctop,rhm,rhc,    &amp;<a name='27'>
             cmfcmax,cmfcmin,cmfdeps,cprcon,crirh,zbuo0,  &amp;<a name='28'>
             fdbk,ztau<a name='29'>
 <a name='30'>
     real :: cevapcu1, cevapcu2, zdnoprc<a name='31'>
    <a name='32'>
     parameter(                     &amp;<a name='33'>
      rcpd=1.0/cpd,                 &amp;<a name='34'>
      rhoh2o=1.0e03,                &amp; <a name='35'>
      tmelt=273.16,                 &amp;<a name='36'>
      t000= 273.15,                 &amp;<a name='37'>
      hgfr= 233.15,                 &amp;<a name='38'>
      zrg=1.0/g,                    &amp;<a name='39'>
      c1es=610.78,                  &amp;<a name='40'>
      c2es=c1es*rd/rv,              &amp;<a name='41'>
      c3les=17.269,                 &amp;<a name='42'>
      c4les=35.86,                  &amp;<a name='43'>
      c5les=c3les*(tmelt-c4les),    &amp;<a name='44'>
      c3ies=21.875,                 &amp;<a name='45'>
      c4ies=7.66,                   &amp;<a name='46'>
      c5ies=c3ies*(tmelt-c4ies),    &amp;<a name='47'>
      vtmpc1=rv/rd-1.0,             &amp;<a name='48'>
      cevapcu1=1.93e-6*261.0*0.5/g, &amp; <a name='49'>
      cevapcu2=1.e3/(38.3*0.293) )<a name='50'>
<a name='51'>
     <a name='52'>
<font color=#447700>!                specify parameters for massflux-scheme<a name='53'></font>
<font color=#447700>!                  --------------------------------------<a name='54'></font>
<font color=#447700>!                   these are tunable parameters<a name='55'></font>
<font color=#447700>!<a name='56'></font>
<font color=#447700>!     entrpen: average entrainment rate for penetrative convection<a name='57'></font>
<font color=#447700>!     -------<a name='58'></font>
<font color=#447700>!<a name='59'></font>
      parameter(entrpen=1.0e-4)<a name='60'>
<font color=#447700>!<a name='61'></font>
<font color=#447700>!     entrscv: average entrainment rate for shallow convection<a name='62'></font>
<font color=#447700>!     -------<a name='63'></font>
<font color=#447700>!<a name='64'></font>
      parameter(entrscv=1.2e-3)<a name='65'>
<font color=#447700>!<a name='66'></font>
<font color=#447700>!     entrmid: average entrainment rate for midlevel convection<a name='67'></font>
<font color=#447700>!     -------<a name='68'></font>
<font color=#447700>!<a name='69'></font>
      parameter(entrmid=1.0e-4)<a name='70'>
<font color=#447700>!<a name='71'></font>
<font color=#447700>!     entrdd: average entrainment rate for downdrafts<a name='72'></font>
<font color=#447700>!     ------<a name='73'></font>
<font color=#447700>!<a name='74'></font>
      parameter(entrdd =2.0e-4)<a name='75'>
<font color=#447700>!<a name='76'></font>
<font color=#447700>!     cmfctop:   relative cloud massflux at level above nonbuoyancy level<a name='77'></font>
<font color=#447700>!     -------<a name='78'></font>
<font color=#447700>!<a name='79'></font>
      parameter(cmfctop=0.30)<a name='80'>
<font color=#447700>!<a name='81'></font>
<font color=#447700>!     cmfcmax:   maximum massflux value allowed for updrafts etc<a name='82'></font>
<font color=#447700>!     -------<a name='83'></font>
<font color=#447700>!<a name='84'></font>
      parameter(cmfcmax=1.0)<a name='85'>
<font color=#447700>!<a name='86'></font>
<font color=#447700>!     cmfcmin:   minimum massflux value (for safety)<a name='87'></font>
<font color=#447700>!     -------<a name='88'></font>
<font color=#447700>!<a name='89'></font>
      parameter(cmfcmin=1.e-10)<a name='90'>
<font color=#447700>!<a name='91'></font>
<font color=#447700>!     cmfdeps:   fractional massflux for downdrafts at lfs<a name='92'></font>
<font color=#447700>!     -------<a name='93'></font>
<font color=#447700>!<a name='94'></font>
      parameter(cmfdeps=0.30)<a name='95'>
<font color=#447700>!<a name='96'></font>
<font color=#447700>!     cprcon:  coefficients for determining conversion from cloud water<a name='97'></font>
<font color=#447700>!<a name='98'></font>
      parameter(cprcon = 1.1e-3/g)<a name='99'>
<font color=#447700>!<a name='100'></font>
<font color=#447700>!     zdnoprc: the pressure depth below which no precipitation<a name='101'></font>
<font color=#447700>!<a name='102'></font>
      parameter(zdnoprc = 1.5e4)<a name='103'>
<font color=#447700>!--------------------<a name='104'></font>
      parameter(rhc=0.80,rhm=1.0,zbuo0=0.50)<a name='105'>
<font color=#447700>!--------------------<a name='106'></font>
      parameter(crirh=0.70,fdbk = 1.0,ztau = 2400.0)<a name='107'>
<font color=#447700>!--------------------<a name='108'></font>
      logical :: lmfpen,lmfmid,lmfscv,lmfdd,lmfdudv<a name='109'>
      parameter(lmfpen=.true.,lmfmid=.true.,lmfscv=.true.,lmfdd=.true.,lmfdudv=.true.)<a name='110'>
<font color=#447700>!--------------------<a name='111'></font>
<font color=#447700>!#################### end of variables definition##########################<a name='112'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='113'></font>
<font color=#447700>!<a name='114'></font>
contains<a name='115'>
<font color=#447700>!-----------------------------------------------------------------------<a name='116'></font>
<A NAME='CU_TIEDTKE'><A href='../../html_code/phys/module_cu_tiedtke.F.html#CU_TIEDTKE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='117'>
      <font color=#993300>subroutine </font><font color=#cc0000>cu_tiedtke</font>(                                    &amp; <A href='../../call_to/CU_TIEDTKE.html' TARGET='index'>1</A>,<A href='../../call_from/CU_TIEDTKE.html' TARGET='index'>1</A><a name='118'>
                 dt,itimestep,stepcu                            &amp;<a name='119'>
                ,raincv,pratec,qfx,znu                          &amp;<a name='120'>
                ,u3d,v3d,w,t3d,qv3d,qc3d,qi3d,pi3d,rho3d        &amp;<a name='121'>
                ,qvften,qvpblten                                &amp;<a name='122'>
                ,dz8w,pcps,p8w,xland,cu_act_flag                &amp;<a name='123'>
                ,ids,ide, jds,jde, kds,kde                      &amp;<a name='124'>
                ,ims,ime, jms,jme, kms,kme                      &amp;<a name='125'>
                ,its,ite, jts,jte, kts,kte                      &amp;<a name='126'>
                ,rthcuten,rqvcuten,rqccuten,rqicuten            &amp;<a name='127'>
                ,rucuten, rvcuten                               &amp;<a name='128'>
                ,f_qv    ,f_qc    ,f_qr    ,f_qi    ,f_qs       &amp;<a name='129'>
                                                                )<a name='130'>
<a name='131'>
<font color=#447700>!-------------------------------------------------------------------<a name='132'></font>
      implicit none<a name='133'>
<font color=#447700>!-------------------------------------------------------------------<a name='134'></font>
<font color=#447700>!-- u3d         3d u-velocity interpolated to theta points (m/s)<a name='135'></font>
<font color=#447700>!-- v3d         3d v-velocity interpolated to theta points (m/s)<a name='136'></font>
<font color=#447700>!-- th3d        3d potential temperature (k)<a name='137'></font>
<font color=#447700>!-- t3d         temperature (k)<a name='138'></font>
<font color=#447700>!-- qv3d        3d water vapor mixing ratio (kg/kg)<a name='139'></font>
<font color=#447700>!-- qc3d        3d cloud mixing ratio (kg/kg)<a name='140'></font>
<font color=#447700>!-- qi3d        3d ice mixing ratio (kg/kg)<a name='141'></font>
<font color=#447700>!-- rho3d       3d air density (kg/m^3)<a name='142'></font>
<font color=#447700>!-- p8w         3d hydrostatic pressure at full levels (pa)<a name='143'></font>
<font color=#447700>!-- pcps        3d hydrostatic pressure at half levels (pa)<a name='144'></font>
<font color=#447700>!-- pi3d        3d exner function (dimensionless)<a name='145'></font>
<font color=#447700>!-- rthcuten      theta tendency due to <a name='146'></font>
<font color=#447700>!                 cumulus scheme precipitation (k/s)<a name='147'></font>
<font color=#447700>!-- rucuten       u wind tendency due to <a name='148'></font>
<font color=#447700>!                 cumulus scheme precipitation (k/s)<a name='149'></font>
<font color=#447700>!-- rvcuten       v wind tendency due to <a name='150'></font>
<font color=#447700>!                 cumulus scheme precipitation (k/s)<a name='151'></font>
<font color=#447700>!-- rqvcuten      qv tendency due to <a name='152'></font>
<font color=#447700>!                 cumulus scheme precipitation (kg/kg/s)<a name='153'></font>
<font color=#447700>!-- rqrcuten      qr tendency due to <a name='154'></font>
<font color=#447700>!                 cumulus scheme precipitation (kg/kg/s)<a name='155'></font>
<font color=#447700>!-- rqccuten      qc tendency due to <a name='156'></font>
<font color=#447700>!                 cumulus scheme precipitation (kg/kg/s)<a name='157'></font>
<font color=#447700>!-- rqscuten      qs tendency due to <a name='158'></font>
<font color=#447700>!                 cumulus scheme precipitation (kg/kg/s)<a name='159'></font>
<font color=#447700>!-- rqicuten      qi tendency due to <a name='160'></font>
<font color=#447700>!                 cumulus scheme precipitation (kg/kg/s)<a name='161'></font>
<font color=#447700>!-- rainc         accumulated total cumulus scheme precipitation (mm)<a name='162'></font>
<font color=#447700>!-- raincv        cumulus scheme precipitation (mm)<a name='163'></font>
<font color=#447700>!-- pratec        precipitiation rate from cumulus scheme (mm/s)<a name='164'></font>
<font color=#447700>!-- dz8w        dz between full levels (m)<a name='165'></font>
<font color=#447700>!-- qfx         upward moisture flux at the surface (kg/m^2/s)<a name='166'></font>
<font color=#447700>!-- dt          time step (s)<a name='167'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='168'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='169'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='170'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='171'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='172'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='173'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='174'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='175'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='176'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='177'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='178'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='179'></font>
<font color=#447700>!-- its         start index for i in tile<a name='180'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='181'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='182'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='183'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='184'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='185'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='186'></font>
      integer, intent(in) ::            ids,ide, jds,jde, kds,kde,      &amp;<a name='187'>
                                        ims,ime, jms,jme, kms,kme,      &amp;<a name='188'>
                                        its,ite, jts,jte, kts,kte,      &amp;<a name='189'>
                                        itimestep,                      &amp;<a name='190'>
                                        stepcu<a name='191'>
<a name='192'>
      real,    intent(in) ::                                            &amp;<a name='193'>
                                        dt<a name='194'>
<a name='195'>
<a name='196'>
      real,    dimension(ims:ime, jms:jme), intent(in) ::               &amp;<a name='197'>
                                        xland<a name='198'>
<a name='199'>
      real,    dimension(ims:ime, jms:jme), intent(inout) ::            &amp;<a name='200'>
                                        raincv, pratec<a name='201'>
<a name='202'>
      logical, dimension(ims:ime,jms:jme), intent(inout) ::             &amp;<a name='203'>
                                        cu_act_flag<a name='204'>
<a name='205'>
<a name='206'>
      real,    dimension(ims:ime, kms:kme, jms:jme), intent(in) ::      &amp;<a name='207'>
                                        dz8w,                           &amp;<a name='208'>
                                        p8w,                            &amp;<a name='209'>
                                        pcps,                           &amp;<a name='210'>
                                        pi3d,                           &amp;<a name='211'>
                                        qc3d,                           &amp;<a name='212'>
                                        qvften,                         &amp;<a name='213'>
                                        qvpblten,                       &amp;<a name='214'>
                                        qi3d,                           &amp;<a name='215'>
                                        qv3d,                           &amp;<a name='216'>
                                        rho3d,                          &amp;<a name='217'>
                                        t3d,                            &amp;<a name='218'>
                                        u3d,                            &amp;<a name='219'>
                                        v3d,                            &amp;<a name='220'>
                                        w                              <a name='221'>
<a name='222'>
<font color=#447700>!--------------------------- optional vars ----------------------------<a name='223'></font>
                                                                                                      <a name='224'>
      real, dimension(ims:ime, kms:kme, jms:jme),                       &amp;<a name='225'>
               optional, intent(inout) ::                               &amp;<a name='226'>
                                        rqccuten,                       &amp;<a name='227'>
                                        rqicuten,                       &amp;<a name='228'>
                                        rqvcuten,                       &amp;<a name='229'>
                                        rthcuten,                       &amp;<a name='230'>
                                        rucuten,                        &amp;<a name='231'>
                                        rvcuten<a name='232'>
                                                                                                      <a name='233'>
<font color=#447700>!<a name='234'></font>
<font color=#447700>! flags relating to the optional tendency arrays declared above<a name='235'></font>
<font color=#447700>! models that carry the optional tendencies will provdide the<a name='236'></font>
<font color=#447700>! optional arguments at compile time; these flags all the model<a name='237'></font>
<font color=#447700>! to determine at run-time whether a particular tracer is in<a name='238'></font>
<font color=#447700>! use or not.<a name='239'></font>
<font color=#447700>!<a name='240'></font>
     logical, optional ::                                    &amp;<a name='241'>
                                                   f_qv      &amp;<a name='242'>
                                                  ,f_qc      &amp;<a name='243'>
                                                  ,f_qr      &amp;<a name='244'>
                                                  ,f_qi      &amp;<a name='245'>
                                                  ,f_qs<a name='246'>
 <a name='247'>
<font color=#447700>!--------------------------- local vars ------------------------------<a name='248'></font>
<a name='249'>
      real,    dimension(ims:ime, jms:jme) ::                           &amp;<a name='250'>
                                        qfx     <a name='251'>
<a name='252'>
      real      ::                                      &amp;<a name='253'>
                                        delt,                           &amp;<a name='254'>
                                        rdelt                          <a name='255'>
<a name='256'>
      real     , dimension(its:ite) ::                  &amp;<a name='257'>
                                        rcs,                            &amp;<a name='258'>
                                        rn,                             &amp;<a name='259'>
                                        evap<a name='260'>
      integer  , dimension(its:ite) ::  slimsk                         <a name='261'>
      <a name='262'>
<a name='263'>
      real     , dimension(its:ite, kts:kte+1) ::       &amp;<a name='264'>
                                        prsi                            <a name='265'>
<a name='266'>
      real     , dimension(its:ite, kts:kte) ::         &amp;<a name='267'>
                                        del,                            &amp;<a name='268'>
                                        dot,                            &amp;<a name='269'>
                                        phil,                           &amp;<a name='270'>
                                        prsl,                           &amp;<a name='271'>
                                        q1,                             &amp; <a name='272'>
                                        q2,                             &amp;<a name='273'>
                                        q3,                             &amp;<a name='274'>
                                        q1b,                            &amp;<a name='275'>
                                        q1bl,                           &amp;<a name='276'>
                                        q11,                            &amp;<a name='277'>
                                        q12,                            &amp;  <a name='278'>
                                        t1,                             &amp; <a name='279'>
                                        u1,                             &amp; <a name='280'>
                                        v1,                             &amp; <a name='281'>
                                        zi,                             &amp; <a name='282'>
                                        zl,                             &amp;<a name='283'>
                                        omg,                            &amp;<a name='284'>
                                        ght <a name='285'>
<a name='286'>
      integer, dimension(its:ite) ::                                    &amp;<a name='287'>
                                        kbot,                           &amp;<a name='288'>
                                        ktop                           <a name='289'>
<a name='290'>
      integer ::                                                        &amp;<a name='291'>
                                        i,                              &amp;<a name='292'>
                                        im,                             &amp;<a name='293'>
                                        j,                              &amp;<a name='294'>
                                        k,                              &amp;<a name='295'>
                                        km,                             &amp;<a name='296'>
                                        kp,                             &amp;<a name='297'>
                                        kx<a name='298'>
<a name='299'>
<a name='300'>
      logical :: run_param , doing_adapt_dt , decided<a name='301'>
<a name='302'>
<font color=#447700>!-------other local variables----<a name='303'></font>
      integer,dimension( its:ite ) :: ktype<a name='304'>
      real, dimension( kts:kte )   :: sig1      <font color=#447700>! half sigma levels<a name='305'></font>
      real, dimension( kms:kme )   :: znu<a name='306'>
      integer                      :: zz <a name='307'>
<font color=#447700>!-----------------------------------------------------------------------<a name='308'></font>
<a name='309'>
      do j=jts,jte<a name='310'>
         do i=its,ite<a name='311'>
            cu_act_flag(i,j)=.true.<a name='312'>
         enddo<a name='313'>
      enddo<a name='314'>
 <a name='315'>
      im=ite-its+1<a name='316'>
      kx=kte-kts+1<a name='317'>
      delt=dt*stepcu<a name='318'>
      rdelt=1./delt<a name='319'>
<a name='320'>
<font color=#447700>!-------------  j loop (outer) --------------------------------------------------<a name='321'></font>
<a name='322'>
   do j=jts,jte<a name='323'>
<a name='324'>
<font color=#447700>! --------------- compute zi and zl -----------------------------------------<a name='325'></font>
      do i=its,ite<a name='326'>
        zi(i,kts)=0.0<a name='327'>
      enddo<a name='328'>
<a name='329'>
      do k=kts+1,kte<a name='330'>
        km=k-1<a name='331'>
        do i=its,ite<a name='332'>
          zi(i,k)=zi(i,km)+dz8w(i,km,j)<a name='333'>
        enddo<a name='334'>
      enddo<a name='335'>
<a name='336'>
      do k=kts+1,kte<a name='337'>
        km=k-1<a name='338'>
        do i=its,ite<a name='339'>
          zl(i,km)=(zi(i,k)+zi(i,km))*0.5<a name='340'>
        enddo<a name='341'>
      enddo<a name='342'>
<a name='343'>
      do i=its,ite<a name='344'>
        zl(i,kte)=2.*zi(i,kte)-zl(i,kte-1)<a name='345'>
      enddo<a name='346'>
<a name='347'>
<font color=#447700>! --------------- end compute zi and zl -------------------------------------<a name='348'></font>
      do i=its,ite<a name='349'>
        slimsk(i)=int(abs(xland(i,j)-2.))<a name='350'>
      enddo<a name='351'>
<a name='352'>
      do k=kts,kte<a name='353'>
        kp=k+1<a name='354'>
        do i=its,ite<a name='355'>
          dot(i,k)=-0.5*g*rho3d(i,k,j)*(w(i,k,j)+w(i,kp,j))<a name='356'>
        enddo<a name='357'>
      enddo<a name='358'>
<a name='359'>
      do k=kts,kte<a name='360'>
        zz = kte+1-k        <a name='361'>
        do i=its,ite<a name='362'>
          u1(i,zz)=u3d(i,k,j)<a name='363'>
          v1(i,zz)=v3d(i,k,j)<a name='364'>
          t1(i,zz)=t3d(i,k,j)<a name='365'>
          q1(i,zz)= qv3d(i,k,j)<a name='366'>
          if(itimestep == 1) then<a name='367'>
             q1b(i,zz)=0.<a name='368'>
             q1bl(i,zz)=0.<a name='369'>
          else<a name='370'>
             q1b(i,zz)=qvften(i,k,j)<a name='371'>
             q1bl(i,zz)=qvpblten(i,k,j)<a name='372'>
          endif<a name='373'>
          q2(i,zz)=qc3d(i,k,j)<a name='374'>
          q3(i,zz)=qi3d(i,k,j)<a name='375'>
          omg(i,zz)=dot(i,k)<a name='376'>
          ght(i,zz)=zl(i,k)<a name='377'>
          prsl(i,zz) = pcps(i,k,j)<a name='378'>
        enddo<a name='379'>
      enddo<a name='380'>
<a name='381'>
      do k=kts,kte+1<a name='382'>
        zz = kte+2-k<a name='383'>
        do i=its,ite<a name='384'>
          prsi(i,zz) = p8w(i,k,j)<a name='385'>
        enddo<a name='386'>
      enddo <a name='387'>
<a name='388'>
      do k=kts,kte<a name='389'>
         zz = kte+1-k<a name='390'>
         sig1(zz) = znu(k)<a name='391'>
      enddo<a name='392'>
<a name='393'>
<font color=#447700>!###############before call tiecnv, we need evap########################<a name='394'></font>
<font color=#447700>!       evap is the vapor flux at the surface<a name='395'></font>
<font color=#447700>!########################################################################<a name='396'></font>
<font color=#447700>!<a name='397'></font>
      do i=its,ite<a name='398'>
        evap(i) = qfx(i,j)<a name='399'>
      enddo<a name='400'>
<font color=#447700>!########################################################################<a name='401'></font>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#TIECNV'>tiecnv</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CU_TIEDTKE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TIECNV_1">(u1,v1,t1,q1,q2,q3,q1b,q1bl,ght,omg,prsl,prsi,evap,             &amp;<a name='402'>
                  rn,slimsk,ktype,im,kx,kx+1,sig1,delt)                 <a name='403'>
<a name='404'>
      do i=its,ite<a name='405'>
         raincv(i,j)=rn(i)/stepcu<a name='406'>
         pratec(i,j)=rn(i)/(stepcu * dt)<a name='407'>
      enddo<a name='408'>
<a name='409'>
      do k=kts,kte<a name='410'>
        zz = kte+1-k<a name='411'>
        do i=its,ite<a name='412'>
          rthcuten(i,k,j)=(t1(i,zz)-t3d(i,k,j))/pi3d(i,k,j)*rdelt<a name='413'>
          rqvcuten(i,k,j)=(q1(i,zz)-qv3d(i,k,j))*rdelt<a name='414'>
          rucuten(i,k,j) =(u1(i,zz)-u3d(i,k,j))*rdelt<a name='415'>
          rvcuten(i,k,j) =(v1(i,zz)-v3d(i,k,j))*rdelt <a name='416'>
        enddo<a name='417'>
      enddo<a name='418'>
<a name='419'>
      if(present(rqccuten))then<a name='420'>
        if ( f_qc ) then<a name='421'>
          do k=kts,kte<a name='422'>
            zz = kte+1-k<a name='423'>
            do i=its,ite<a name='424'>
              rqccuten(i,k,j)=(q2(i,zz)-qc3d(i,k,j))*rdelt<a name='425'>
            enddo<a name='426'>
          enddo<a name='427'>
        endif<a name='428'>
      endif<a name='429'>
<a name='430'>
      if(present(rqicuten))then<a name='431'>
        if ( f_qi ) then<a name='432'>
          do k=kts,kte<a name='433'>
            zz = kte+1-k<a name='434'>
            do i=its,ite<a name='435'>
              rqicuten(i,k,j)=(q3(i,zz)-qi3d(i,k,j))*rdelt<a name='436'>
            enddo<a name='437'>
          enddo<a name='438'>
        endif<a name='439'>
      endif<a name='440'>
<a name='441'>
<a name='442'>
   enddo<a name='443'>
<a name='444'>
   end subroutine cu_tiedtke<a name='445'>
<a name='446'>
<font color=#447700>!====================================================================<a name='447'></font>
<A NAME='TIEDTKEINIT'><A href='../../html_code/phys/module_cu_tiedtke.F.html#TIEDTKEINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='448'>
   <font color=#993300>subroutine </font><font color=#cc0000>tiedtkeinit</font>(rthcuten,rqvcuten,rqccuten,rqicuten,          &amp; <A href='../../call_to/TIEDTKEINIT.html' TARGET='index'>1</A><a name='449'>
                     rucuten,rvcuten,                                   &amp;<a name='450'>
                     restart,p_qc,p_qi,p_first_scalar,                  &amp;<a name='451'>
                     allowed_to_read,                                   &amp;<a name='452'>
                     ids, ide, jds, jde, kds, kde,                      &amp;<a name='453'>
                     ims, ime, jms, jme, kms, kme,                      &amp;<a name='454'>
                     its, ite, jts, jte, kts, kte)<a name='455'>
<font color=#447700>!--------------------------------------------------------------------<a name='456'></font>
   implicit none<a name='457'>
<font color=#447700>!--------------------------------------------------------------------<a name='458'></font>
   logical , intent(in)           ::  allowed_to_read,restart<a name='459'>
   integer , intent(in)           ::  ids, ide, jds, jde, kds, kde, &amp;<a name='460'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='461'>
                                      its, ite, jts, jte, kts, kte<a name='462'>
   integer , intent(in)           ::  p_first_scalar, p_qi, p_qc<a name='463'>
<a name='464'>
   real,     dimension( ims:ime , kms:kme , jms:jme ) , intent(out) ::  &amp;<a name='465'>
                                                              rthcuten, &amp;<a name='466'>
                                                              rqvcuten, &amp;<a name='467'>
                                                              rqccuten, &amp;<a name='468'>
                                                              rqicuten, &amp;<a name='469'>
                                                              rucuten,rvcuten <a name='470'>
<a name='471'>
   integer :: i, j, k, itf, jtf, ktf<a name='472'>
<a name='473'>
   jtf=min0(jte,jde-1)<a name='474'>
   ktf=min0(kte,kde-1)<a name='475'>
   itf=min0(ite,ide-1)<a name='476'>
<a name='477'>
   if(.not.restart)then<a name='478'>
     do j=jts,jtf<a name='479'>
     do k=kts,ktf<a name='480'>
     do i=its,itf<a name='481'>
       rthcuten(i,k,j)=0.<a name='482'>
       rqvcuten(i,k,j)=0.<a name='483'>
       rucuten(i,k,j)=0.<a name='484'>
       rvcuten(i,k,j)=0.<a name='485'>
     enddo<a name='486'>
     enddo<a name='487'>
     enddo<a name='488'>
<a name='489'>
     if (p_qc .ge. p_first_scalar) then<a name='490'>
        do j=jts,jtf<a name='491'>
        do k=kts,ktf<a name='492'>
        do i=its,itf<a name='493'>
           rqccuten(i,k,j)=0.<a name='494'>
        enddo<a name='495'>
        enddo<a name='496'>
        enddo<a name='497'>
     endif<a name='498'>
<a name='499'>
     if (p_qi .ge. p_first_scalar) then<a name='500'>
        do j=jts,jtf<a name='501'>
        do k=kts,ktf<a name='502'>
        do i=its,itf<a name='503'>
           rqicuten(i,k,j)=0.<a name='504'>
        enddo<a name='505'>
        enddo<a name='506'>
        enddo<a name='507'>
     endif<a name='508'>
   endif<a name='509'>
<a name='510'>
      end subroutine tiedtkeinit<a name='511'>
<a name='512'>
<font color=#447700>! ------------------------------------------------------------------------<a name='513'></font>
<a name='514'>
<font color=#447700>!------------this is the combined version for tiedtke---------------<a name='515'></font>
<font color=#447700>!----------------------------------------------------------------<a name='516'></font>
<font color=#447700>!  in this module only the mass flux convection scheme of the ecmwf is included<a name='517'></font>
<font color=#447700>!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<a name='518'></font>
<font color=#447700>!#############################################################<a name='519'></font>
<font color=#447700>!<a name='520'></font>
<font color=#447700>!             level 1 subroutines<a name='521'></font>
<font color=#447700>!<a name='522'></font>
<font color=#447700>!#############################################################<a name='523'></font>
<font color=#447700>!********************************************************<a name='524'></font>
<font color=#447700>!        subroutine tiecnv<a name='525'></font>
<font color=#447700>!********************************************************<a name='526'></font>
<A NAME='TIECNV'><A href='../../html_code/phys/module_cu_tiedtke.F.html#TIECNV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='527'>
      <font color=#993300>subroutine </font><font color=#cc0000>tiecnv</font>(pu,pv,pt,pqv,pqc,pqi,pqvf,pqvbl,poz,pomg,  &amp; <A href='../../call_to/TIECNV.html' TARGET='index'>1</A>,<A href='../../call_from/TIECNV.html' TARGET='index'>4</A><a name='528'>
               pap,paph,evap,zprecc,lndj,ktype,lq,km,km1,sig1,dt)<a name='529'>
<font color=#447700>!-----------------------------------------------------------------<a name='530'></font>
<font color=#447700>!  this is the interface between the meso-scale model and the mass <a name='531'></font>
<font color=#447700>!  flux convection module<a name='532'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='533'></font>
      implicit none<a name='534'>
<a name='535'>
      real pu(lq,km),pv(lq,km),pt(lq,km),pqv(lq,km),pqvf(lq,km)<a name='536'>
      real poz(lq,km),pomg(lq,km),evap(lq),zprecc(lq),pqvbl(lq,km)<a name='537'>
<a name='538'>
      real pum1(lq,km),    pvm1(lq,km),                             &amp;<a name='539'>
          ptte(lq,km),    pqte(lq,km),  pvom(lq,km),  pvol(lq,km),  &amp;<a name='540'>
          pverv(lq,km),   pgeo(lq,km),  pap(lq,km),   paph(lq,km1)<a name='541'>
      real pqhfl(lq),      zqq(lq,km),   paprc(lq),    paprs(lq),   &amp;<a name='542'>
          prsfc(lq),      pssfc(lq),    paprsm(lq),   pcte(lq,km)<a name='543'>
      real ztp1(lq,km),    zqp1(lq,km),  ztu(lq,km),   zqu(lq,km),  &amp;<a name='544'>
          zlu(lq,km),     zlude(lq,km), zmfu(lq,km),  zmfd(lq,km),  &amp;<a name='545'>
          zqsat(lq,km),   pqc(lq,km),   pqi(lq,km),   zrain(lq)<a name='546'>
<a name='547'>
      real sig(km1),sig1(km)<a name='548'>
      integer icbot(lq),   ictop(lq),     ktype(lq),   lndj(lq)<a name='549'>
      real  dt<a name='550'>
      logical locum(lq)<a name='551'>
<a name='552'>
      real psheat,psrain,psevap,psmelt,psdiss,tt<a name='553'>
      real ztmst,ztpp1,fliq,fice,ztc,zalf<a name='554'>
      integer i,j,k,lq,lp,km,km1<a name='555'>
<font color=#447700>!     real tlucua<a name='556'></font>
<font color=#447700>!     external tlucua<a name='557'></font>
<a name='558'>
      ztmst=dt<a name='559'>
<font color=#447700>!  masv flux diagnostics.<a name='560'></font>
<a name='561'>
      psheat=0.0<a name='562'>
      psrain=0.0<a name='563'>
      psevap=0.0<a name='564'>
      psmelt=0.0<a name='565'>
      psdiss=0.0<a name='566'>
      do  j=1,lq<a name='567'>
        zrain(j)=0.0<a name='568'>
        locum(j)=.false.<a name='569'>
        prsfc(j)=0.0<a name='570'>
        pssfc(j)=0.0<a name='571'>
        paprc(j)=0.0<a name='572'>
        paprs(j)=0.0<a name='573'>
        paprsm(j)=0.0<a name='574'>
        pqhfl(j)=evap(j)<a name='575'>
     end do<a name='576'>
<a name='577'>
<font color=#447700>!     convert model variables for mflux scheme<a name='578'></font>
<a name='579'>
      do  k=1,km<a name='580'>
        do  j=1,lq<a name='581'>
          ptte(j,k)=0.0<a name='582'>
          pcte(j,k)=0.0<a name='583'>
          pvom(j,k)=0.0<a name='584'>
          pvol(j,k)=0.0<a name='585'>
          ztp1(j,k)=pt(j,k)<a name='586'>
          zqp1(j,k)=pqv(j,k)/(1.0+pqv(j,k))<a name='587'>
          pum1(j,k)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PU'>pu</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#TIECNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PU_6">(j,k)<a name='588'>
          pvm1(j,k)=pv(j,k)<a name='589'>
          pverv(j,k)=pomg(j,k)<a name='590'>
          pgeo(j,k)=g*poz(j,k)<a name='591'>
          tt=ztp1(j,k)<a name='592'>
          zqsat(j,k)=<A href='../../html_code/phys/module_cu_tiedtke.F.html#TLUCUA'>tlucua</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#TIECNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TLUCUA_1">(tt)/pap(j,k)<a name='593'>
          zqsat(j,k)=min(0.5,zqsat(j,k))<a name='594'>
          zqsat(j,k)=zqsat(j,k)/(1.-vtmpc1*zqsat(j,k))<a name='595'>
          pqte(j,k)=pqvf(j,k)+pqvbl(j,k)<a name='596'>
          zqq(j,k)=pqte(j,k)<a name='597'>
        end do<a name='598'>
      end do<a name='599'>
<font color=#447700>!<a name='600'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='601'></font>
<font color=#447700>!*    2.     call 'cumastr'(master-routine for cumulus parameterization)<a name='602'></font>
<font color=#447700>!<a name='603'></font>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUMASTR_NEW'>cumastr_new</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#TIECNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUMASTR_NEW_1"> &amp;<a name='604'>
         (lq,       km,       km1,      km-1,    ztp1,   &amp;<a name='605'>
          zqp1,     pum1,     pvm1,     pverv,   zqsat,  &amp;<a name='606'>
          pqhfl,    ztmst,    pap,      paph,    pgeo,   &amp;<a name='607'>
          ptte,     pqte,     pvom,     pvol,    prsfc,  &amp; <a name='608'>
          pssfc,    paprc,    paprsm,   paprs,   locum,  &amp;<a name='609'>
          ktype,    icbot,    ictop,    ztu,     zqu,    &amp;<a name='610'>
          zlu,      zlude,    zmfu,     zmfd,    zrain,  &amp;<a name='611'>
          psrain,   psevap,   psheat,   psdiss,  psmelt, &amp;<a name='612'>
          pcte,     sig1,     lndj)<a name='613'>
<font color=#447700>!<a name='614'></font>
<font color=#447700>!     to include the cloud water and cloud ice detrained from convection<a name='615'></font>
<font color=#447700>!<a name='616'></font>
      if(fdbk.ge.1.0e-9) then<a name='617'>
      do k=1,km<a name='618'>
      do j=1,lq<a name='619'>
      if(pcte(j,k).gt.0.0) then<a name='620'>
        ztpp1=pt(j,k)+ptte(j,k)*ztmst<a name='621'>
        if(ztpp1.ge.t000) then<a name='622'>
           fliq=1.0<a name='623'>
           zalf=0.0<a name='624'>
        else if(ztpp1.le.hgfr) then<a name='625'>
           fliq=0.0<a name='626'>
           zalf=alf<a name='627'>
        else<a name='628'>
           ztc=ztpp1-t000<a name='629'>
           fliq=0.0059+0.9941*exp(-0.003102*ztc*ztc)<a name='630'>
           zalf=alf<a name='631'>
        endif<a name='632'>
        fice=1.0-fliq<a name='633'>
        pqc(j,k)=pqc(j,k)+fliq*pcte(j,k)*ztmst<a name='634'>
        pqi(j,k)=pqi(j,k)+fice*pcte(j,k)*ztmst<a name='635'>
        ptte(j,k)=ptte(j,k)-zalf*rcpd*fliq*pcte(j,k)<a name='636'>
      endif<a name='637'>
      end do<a name='638'>
      end do<a name='639'>
      endif<a name='640'>
<font color=#447700>!<a name='641'></font>
      do k=1,km<a name='642'>
        do j=1,lq<a name='643'>
          pt(j,k)=ztp1(j,k)+ptte(j,k)*ztmst<a name='644'>
          zqp1(j,k)=zqp1(j,k)+(pqte(j,k)-zqq(j,k))*ztmst<a name='645'>
          pqv(j,k)=zqp1(j,k)/(1.0-zqp1(j,k))<a name='646'>
        end do<a name='647'>
      end do<a name='648'>
      do j=1,lq<a name='649'>
        zprecc(j)=amax1(0.0,(prsfc(j)+pssfc(j))*ztmst)<a name='650'>
      end do<a name='651'>
      if (lmfdudv) then<a name='652'>
        do  k=1,km<a name='653'>
          do j=1,lq<a name='654'>
            pu(j,k)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PU'>pu</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#TIECNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PU_7">(j,k)+pvom(j,k)*ztmst<a name='655'>
            pv(j,k)=pv(j,k)+pvol(j,k)*ztmst<a name='656'>
          end do<a name='657'>
        end do<a name='658'>
      endif<a name='659'>
<font color=#447700>!<a name='660'></font>
      return<a name='661'>
      end subroutine tiecnv<a name='662'>
<a name='663'>
<font color=#447700>!#############################################################<a name='664'></font>
<font color=#447700>!<a name='665'></font>
<font color=#447700>!             level 2 subroutines<a name='666'></font>
<font color=#447700>!<a name='667'></font>
<font color=#447700>!#############################################################<a name='668'></font>
<font color=#447700>!***********************************************************<a name='669'></font>
<font color=#447700>!           subroutine cumastr_new<a name='670'></font>
<font color=#447700>!***********************************************************<a name='671'></font>
<A NAME='CUMASTR_NEW'><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUMASTR_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='672'>
      <font color=#993300>subroutine </font><font color=#cc0000>cumastr_new</font>                             &amp; <A href='../../call_to/CUMASTR_NEW.html' TARGET='index'>1</A>,<A href='../../call_from/CUMASTR_NEW.html' TARGET='index'>9</A><a name='673'>
         (klon,     klev,     klevp1,   klevm1,   pten,  &amp;<a name='674'>
          pqen,     puen,     pven,     pverv,    pqsen, &amp;<a name='675'>
          pqhfl,    ztmst,    pap,      paph,     pgeo,  &amp;<a name='676'>
          ptte,     pqte,     pvom,     pvol,     prsfc, &amp;<a name='677'>
          pssfc,    paprc,    paprsm,   paprs,    ldcum, &amp;<a name='678'>
          ktype,    kcbot,    kctop,    ptu,      pqu,   &amp;<a name='679'>
          plu,      plude,    pmfu,     pmfd,     prain, &amp;<a name='680'>
          psrain,   psevap,   psheat,   psdiss,   psmelt,&amp; <a name='681'>
          pcte,     sig1,     lndj)<a name='682'>
<font color=#447700>!<a name='683'></font>
<font color=#447700>!***cumastr*  master routine for cumulus massflux-scheme<a name='684'></font>
<font color=#447700>!     m.tiedtke      e.c.m.w.f.     1986/1987/1989<a name='685'></font>
<font color=#447700>!***purpose<a name='686'></font>
<font color=#447700>!   -------<a name='687'></font>
<font color=#447700>!          this routine computes the physical tendencies of the<a name='688'></font>
<font color=#447700>!     prognostic variables t,q,u and v due to convective processes.<a name='689'></font>
<font color=#447700>!     processes considered are: convective fluxes, formation of<a name='690'></font>
<font color=#447700>!     precipitation, evaporation of falling rain below cloud base,<a name='691'></font>
<font color=#447700>!     saturated cumulus downdrafts.<a name='692'></font>
<font color=#447700>!***interface.<a name='693'></font>
<font color=#447700>!   ----------<a name='694'></font>
<font color=#447700>!          *cumastr* is called from *mssflx*<a name='695'></font>
<font color=#447700>!     the routine takes its input from the long-term storage<a name='696'></font>
<font color=#447700>!     t,q,u,v,phi and p and moisture tendencies.<a name='697'></font>
<font color=#447700>!     it returns its output to the same space<a name='698'></font>
<font color=#447700>!      1.modified tendencies of model variables<a name='699'></font>
<font color=#447700>!      2.rates of convective precipitation<a name='700'></font>
<font color=#447700>!        (used in subroutine surf)<a name='701'></font>
<font color=#447700>!      3.cloud base, cloud top and precip for radiation<a name='702'></font>
<font color=#447700>!        (used in subroutine cloud)<a name='703'></font>
<font color=#447700>!***method<a name='704'></font>
<font color=#447700>!   ------<a name='705'></font>
<font color=#447700>!     parameterization is done using a massflux-scheme.<a name='706'></font>
<font color=#447700>!        (1) define constants and parameters<a name='707'></font>
<font color=#447700>!        (2) specify values (t,q,qs...) at half levels and<a name='708'></font>
<font color=#447700>!            initialize updraft- and downdraft-values in 'cuini'<a name='709'></font>
<font color=#447700>!        (3) calculate cloud base in 'cubase'<a name='710'></font>
<font color=#447700>!            and specify cloud base massflux from pbl moisture budget<a name='711'></font>
<font color=#447700>!        (4) do cloud ascent in 'cuasc' in absence of downdrafts<a name='712'></font>
<font color=#447700>!        (5) do downdraft calculations:<a name='713'></font>
<font color=#447700>!              (a) determine values at lfs in 'cudlfs'<a name='714'></font>
<font color=#447700>!              (b) determine moist descent in 'cuddraf'<a name='715'></font>
<font color=#447700>!              (c) recalculate cloud base massflux considering the<a name='716'></font>
<font color=#447700>!                  effect of cu-downdrafts<a name='717'></font>
<font color=#447700>!        (6) do final cloud ascent in 'cuasc'<a name='718'></font>
<font color=#447700>!        (7) do final adjusments to convective fluxes in 'cuflx',<a name='719'></font>
<font color=#447700>!            do evaporation in subcloud layer<a name='720'></font>
<font color=#447700>!        (8) calculate increments of t and q in 'cudtdq'<a name='721'></font>
<font color=#447700>!        (9) calculate increments of u and v in 'cududv'<a name='722'></font>
<font color=#447700>!***externals.<a name='723'></font>
<font color=#447700>!   ----------<a name='724'></font>
<font color=#447700>!       cuini:  initializes values at vertical grid used in cu-parametr.<a name='725'></font>
<font color=#447700>!       cubase: cloud base calculation for penetr.and shallow convection<a name='726'></font>
<font color=#447700>!       cuasc:  cloud ascent for entraining plume<a name='727'></font>
<font color=#447700>!       cudlfs: determines values at lfs for downdrafts<a name='728'></font>
<font color=#447700>!       cuddraf:does moist descent for cumulus downdrafts<a name='729'></font>
<font color=#447700>!       cuflx:  final adjustments to convective fluxes (also in pbl)<a name='730'></font>
<font color=#447700>!       cudqdt: updates tendencies for t and q<a name='731'></font>
<font color=#447700>!       cududv: updates tendencies for u and v<a name='732'></font>
<font color=#447700>!***switches.<a name='733'></font>
<font color=#447700>!   --------<a name='734'></font>
<font color=#447700>!          lmfpen=.t.   penetrative convection is switched on<a name='735'></font>
<font color=#447700>!          lmfscv=.t.   shallow convection is switched on<a name='736'></font>
<font color=#447700>!          lmfmid=.t.   midlevel convection is switched on<a name='737'></font>
<font color=#447700>!          lmfdd=.t.    cumulus downdrafts switched on<a name='738'></font>
<font color=#447700>!          lmfdudv=.t.  cumulus friction switched on<a name='739'></font>
<font color=#447700>!***<a name='740'></font>
<font color=#447700>!     model parameters (defined in subroutine cuparam)<a name='741'></font>
<font color=#447700>!     ------------------------------------------------<a name='742'></font>
<font color=#447700>!     entrpen    entrainment rate for penetrative convection<a name='743'></font>
<font color=#447700>!     entrscv    entrainment rate for shallow convection<a name='744'></font>
<font color=#447700>!     entrmid    entrainment rate for midlevel convection<a name='745'></font>
<font color=#447700>!     entrdd     entrainment rate for cumulus downdrafts<a name='746'></font>
<font color=#447700>!     cmfctop    relative cloud massflux at level above nonbuoyancy<a name='747'></font>
<font color=#447700>!                level<a name='748'></font>
<font color=#447700>!     cmfcmax    maximum massflux value allowed for<a name='749'></font>
<font color=#447700>!     cmfcmin    minimum massflux value (for safety)<a name='750'></font>
<font color=#447700>!     cmfdeps    fractional massflux for downdrafts at lfs<a name='751'></font>
<font color=#447700>!     cprcon     coefficient for conversion from cloud water to rain<a name='752'></font>
<font color=#447700>!***reference.<a name='753'></font>
<font color=#447700>!   ----------<a name='754'></font>
<font color=#447700>!          paper on massflux scheme (tiedtke,1989)<a name='755'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='756'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='757'></font>
      implicit none<a name='758'>
<font color=#447700>!-------------------------------------------------------------------<a name='759'></font>
      integer   klon, klev, klevp1<a name='760'>
      integer   klevm1<a name='761'>
      real      ztmst<a name='762'>
      real      psrain, psevap, psheat, psdiss, psmelt, zcons2<a name='763'>
      integer   jk,jl,ikb<a name='764'>
      real      zqumqe, zdqmin, zmfmax, zalvdcp, zqalv<a name='765'>
      real      zhsat, zgam, zzz, zhhat, zbi, zro, zdz, zdhdz, zdepth<a name='766'>
      real      zfac, zrh, zpbmpt, dept, zht, zeps<a name='767'>
      integer   icum, itopm2<a name='768'>
      real     pten(klon,klev),        pqen(klon,klev), &amp;<a name='769'>
              puen(klon,klev),        pven(klon,klev),  &amp;<a name='770'>
              ptte(klon,klev),        pqte(klon,klev),  &amp;<a name='771'>
              pvom(klon,klev),        pvol(klon,klev),  &amp;<a name='772'>
              pqsen(klon,klev),       pgeo(klon,klev),  &amp;<a name='773'>
              pap(klon,klev),         paph(klon,klevp1),&amp; <a name='774'>
              pverv(klon,klev),       pqhfl(klon)<a name='775'>
      real     ptu(klon,klev),         pqu(klon,klev),  &amp;<a name='776'>
              plu(klon,klev),         plude(klon,klev), &amp;<a name='777'>
              pmfu(klon,klev),        pmfd(klon,klev),  &amp;<a name='778'>
              paprc(klon),            paprs(klon),      &amp;<a name='779'>
              paprsm(klon),           prain(klon),      &amp;<a name='780'>
              prsfc(klon),            pssfc(klon)<a name='781'>
      real     ztenh(klon,klev),       zqenh(klon,klev),&amp;<a name='782'>
              zgeoh(klon,klev),       zqsenh(klon,klev),&amp;<a name='783'>
              ztd(klon,klev),         zqd(klon,klev),   &amp;<a name='784'>
              zmfus(klon,klev),       zmfds(klon,klev), &amp;<a name='785'>
              zmfuq(klon,klev),       zmfdq(klon,klev), &amp;<a name='786'>
              zdmfup(klon,klev),      zdmfdp(klon,klev),&amp; <a name='787'>
              zmful(klon,klev),       zrfl(klon),       &amp;<a name='788'>
              zuu(klon,klev),         zvu(klon,klev),   &amp;<a name='789'>
              zud(klon,klev),         zvd(klon,klev)<a name='790'>
      real     zentr(klon),            zhcbase(klon),   &amp;<a name='791'>
              zmfub(klon),            zmfub1(klon),     &amp;<a name='792'>
              zdqpbl(klon),           zdqcv(klon) <a name='793'>
      real     zsfl(klon),             zdpmel(klon,klev), &amp;<a name='794'>
              pcte(klon,klev),        zcape(klon),        &amp;<a name='795'>
              zheat(klon),            zhhatt(klon,klev),  &amp;<a name='796'>
              zhmin(klon),            zrelh(klon)<a name='797'>
      real     sig1(klev)<a name='798'>
      integer  ilab(klon,klev),        idtop(klon),   &amp;<a name='799'>
              ictop0(klon),           ilwmin(klon)    <a name='800'>
      integer  kcbot(klon),            kctop(klon),   &amp;<a name='801'>
              ktype(klon),            ihmin(klon),    &amp;<a name='802'>
              ktop0,                  lndj(klon)<a name='803'>
      logical  ldcum(klon)<a name='804'>
      logical  loddraf(klon),          llo1<a name='805'>
<font color=#447700>!-------------------------------------------<a name='806'></font>
<font color=#447700>!     1.    specify constants and parameters<a name='807'></font>
<font color=#447700>!-------------------------------------------<a name='808'></font>
      zcons2=1./(g*ztmst)<a name='809'>
<font color=#447700>!--------------------------------------------------------------<a name='810'></font>
<font color=#447700>!*    2.    initialize values at vertical grid points in 'cuini'<a name='811'></font>
<font color=#447700>!--------------------------------------------------------------<a name='812'></font>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUINI'>cuini</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUMASTR_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUINI_1"> &amp;<a name='813'>
         (klon,     klev,     klevp1,   klevm1,   pten,  &amp;<a name='814'>
          pqen,     pqsen,    puen,     pven,     pverv, &amp;<a name='815'>
          pgeo,     paph,     zgeoh,    ztenh,    zqenh,  &amp;<a name='816'>
          zqsenh,   ilwmin,   ptu,      pqu,      ztd,   &amp;<a name='817'>
          zqd,      zuu,      zvu,      zud,      zvd,   &amp;<a name='818'>
          pmfu,     pmfd,     zmfus,    zmfds,    zmfuq, &amp;<a name='819'>
          zmfdq,    zdmfup,   zdmfdp,   zdpmel,   plu,  &amp;<a name='820'>
          plude,    ilab)<a name='821'>
<font color=#447700>!----------------------------------<a name='822'></font>
<font color=#447700>!*    3.0   cloud base calculations<a name='823'></font>
<font color=#447700>!----------------------------------<a name='824'></font>
<font color=#447700>!*         (a) determine cloud base values in 'cubase'<a name='825'></font>
<font color=#447700>!          -------------------------------------------<a name='826'></font>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUBASE'>cubase</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUMASTR_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUBASE_1"> &amp;<a name='827'>
         (klon,     klev,     klevp1,   klevm1,   ztenh, &amp;<a name='828'>
          zqenh,    zgeoh,    paph,     ptu,      pqu,   &amp;<a name='829'>
          plu,      puen,     pven,     zuu,      zvu,   &amp;<a name='830'>
          ldcum,    kcbot,    ilab)<a name='831'>
<font color=#447700>!*          (b) determine total moisture convergence and<a name='832'></font>
<font color=#447700>!*              then decide on type of cumulus convection<a name='833'></font>
<font color=#447700>!               -----------------------------------------<a name='834'></font>
       jk=1<a name='835'>
       do jl=1,klon<a name='836'>
       zdqcv(jl) =pqte(jl,jk)*(paph(jl,jk+1)-paph(jl,jk))<a name='837'>
       zdqpbl(jl)=0.0<a name='838'>
       idtop(jl)=0<a name='839'>
       end do<a name='840'>
<a name='841'>
       do jk=2,klev<a name='842'>
       do jl=1,klon<a name='843'>
       zdqcv(jl)=zdqcv(jl)+pqte(jl,jk)*(paph(jl,jk+1)-paph(jl,jk))<a name='844'>
       if(jk.ge.kcbot(jl)) zdqpbl(jl)=zdqpbl(jl)+pqte(jl,jk)  &amp;<a name='845'>
                                    *(paph(jl,jk+1)-paph(jl,jk))<a name='846'>
       end do<a name='847'>
       end do<a name='848'>
<a name='849'>
      do jl=1,klon<a name='850'>
         ktype(jl)=0<a name='851'>
      if(zdqcv(jl).gt.max(0.,1.1*pqhfl(jl)*g)) then<a name='852'>
         ktype(jl)=1<a name='853'>
      else<a name='854'>
         ktype(jl)=2<a name='855'>
      endif<a name='856'>
<a name='857'>
<font color=#447700>!*         (c) determine moisture supply for boundary layer<a name='858'></font>
<font color=#447700>!*             and determine cloud base massflux ignoring<a name='859'></font>
<font color=#447700>!*             the effects of downdrafts at this stage<a name='860'></font>
<font color=#447700>!              ------------------------------------------<a name='861'></font>
      ikb=kcbot(jl)<a name='862'>
      zqumqe=pqu(jl,ikb)+plu(jl,ikb)-zqenh(jl,ikb)<a name='863'>
      zdqmin=max(0.01*zqenh(jl,ikb),1.e-10)<a name='864'>
      if(zdqpbl(jl).gt.0..and.zqumqe.gt.zdqmin.and.ldcum(jl)) then<a name='865'>
         zmfub(jl)=zdqpbl(jl)/(g*max(zqumqe,zdqmin))<a name='866'>
      else<a name='867'>
         zmfub(jl)=0.01<a name='868'>
         ldcum(jl)=.false.<a name='869'>
      endif<a name='870'>
      zmfmax=(paph(jl,ikb)-paph(jl,ikb-1))*zcons2<a name='871'>
      zmfub(jl)=min(zmfub(jl),zmfmax)<a name='872'>
<font color=#447700>!------------------------------------------------------<a name='873'></font>
<font color=#447700>!*    4.0   determine cloud ascent for entraining plume<a name='874'></font>
<font color=#447700>!------------------------------------------------------<a name='875'></font>
<font color=#447700>!*         (a) estimate cloud height for entrainment/detrainment<a name='876'></font>
<font color=#447700>!*             calculations in cuasc (max.possible cloud height<a name='877'></font>
<font color=#447700>!*             for non-entraining plume, following a.-s.,1974)<a name='878'></font>
<font color=#447700>! -------------------------------------------------------------<a name='879'></font>
      ikb=kcbot(jl)<a name='880'>
      zhcbase(jl)=cpd*ptu(jl,ikb)+zgeoh(jl,ikb)+alv*pqu(jl,ikb)<a name='881'>
      ictop0(jl)=kcbot(jl)-1<a name='882'>
      end do<a name='883'>
<a name='884'>
      zalvdcp=alv/cpd<a name='885'>
      zqalv=1./alv<a name='886'>
      do jk=klevm1,3,-1<a name='887'>
      do jl=1,klon<a name='888'>
      zhsat=cpd*ztenh(jl,jk)+zgeoh(jl,jk)+alv*zqsenh(jl,jk)<a name='889'>
      zgam=c5les*zalvdcp*zqsenh(jl,jk)/  &amp;<a name='890'>
          ((1.-vtmpc1*zqsenh(jl,jk))*(ztenh(jl,jk)-c4les)**2)<a name='891'>
      zzz=cpd*ztenh(jl,jk)*0.608<a name='892'>
      zhhat=zhsat-(zzz+zgam*zzz)/(1.+zgam*zzz*zqalv)* &amp;<a name='893'>
                 max(zqsenh(jl,jk)-zqenh(jl,jk),0.)<a name='894'>
      zhhatt(jl,jk)=zhhat<a name='895'>
      if(jk.lt.ictop0(jl).and.zhcbase(jl).gt.zhhat) ictop0(jl)=jk<a name='896'>
      end do<a name='897'>
      end do<a name='898'>
<a name='899'>
      do jl=1,klon<a name='900'>
      jk=kcbot(jl)<a name='901'>
      zhsat=cpd*ztenh(jl,jk)+zgeoh(jl,jk)+alv*zqsenh(jl,jk)<a name='902'>
      zgam=c5les*zalvdcp*zqsenh(jl,jk)/   &amp;<a name='903'>
          ((1.-vtmpc1*zqsenh(jl,jk))*(ztenh(jl,jk)-c4les)**2)<a name='904'>
      zzz=cpd*ztenh(jl,jk)*0.608<a name='905'>
      zhhat=zhsat-(zzz+zgam*zzz)/(1.+zgam*zzz*zqalv)* &amp;<a name='906'>
                 max(zqsenh(jl,jk)-zqenh(jl,jk),0.)<a name='907'>
      zhhatt(jl,jk)=zhhat<a name='908'>
      end do<a name='909'>
<font color=#447700>!<a name='910'></font>
<font color=#447700>! find lowest possible org. detrainment level<a name='911'></font>
<font color=#447700>!<a name='912'></font>
      do jl = 1, klon<a name='913'>
         zhmin(jl) = 0.<a name='914'>
         if( ldcum(jl).and.ktype(jl).eq.1 ) then<a name='915'>
            ihmin(jl) = kcbot(jl)<a name='916'>
         else<a name='917'>
            ihmin(jl) = -1<a name='918'>
         end if<a name='919'>
      end do<a name='920'>
<font color=#447700>!<a name='921'></font>
      zbi = 1./(25.*g)<a name='922'>
      do jk = klev, 1, -1<a name='923'>
      do jl = 1, klon<a name='924'>
      llo1 = ldcum(jl).and.ktype(jl).eq.1.and.ihmin(jl).eq.kcbot(jl)<a name='925'>
      if (llo1.and.jk.lt.kcbot(jl).and.jk.ge.ictop0(jl)) then<a name='926'>
        ikb = kcbot(jl)<a name='927'>
        zro = rd*ztenh(jl,jk)/(g*paph(jl,jk))<a name='928'>
        zdz = (paph(jl,jk)-paph(jl,jk-1))*zro<a name='929'>
        zdhdz=(cpd*(pten(jl,jk-1)-pten(jl,jk))+alv*(pqen(jl,jk-1)-   &amp;<a name='930'>
          pqen(jl,jk))+(pgeo(jl,jk-1)-pgeo(jl,jk)))*g/(pgeo(jl,      &amp;<a name='931'>
          jk-1)-pgeo(jl,jk))<a name='932'>
        zdepth = zgeoh(jl,jk) - zgeoh(jl,ikb)<a name='933'>
        zfac = sqrt(1.+zdepth*zbi)<a name='934'>
        zhmin(jl) = zhmin(jl) + zdhdz*zfac*zdz<a name='935'>
        zrh = -alv*(zqsenh(jl,jk)-zqenh(jl,jk))*zfac<a name='936'>
        if (zhmin(jl).gt.zrh) ihmin(jl) = jk<a name='937'>
      end if<a name='938'>
      end do<a name='939'>
      end do<a name='940'>
 <a name='941'>
      do jl = 1, klon<a name='942'>
      if (ldcum(jl).and.ktype(jl).eq.1) then<a name='943'>
        if (ihmin(jl).lt.ictop0(jl)) ihmin(jl) = ictop0(jl)<a name='944'>
      end if<a name='945'>
      if(ktype(jl).eq.1) then<a name='946'>
        zentr(jl)=entrpen<a name='947'>
      else<a name='948'>
        zentr(jl)=entrscv<a name='949'>
      endif<a name='950'>
      if(lndj(jl).eq.1) zentr(jl)=zentr(jl)*1.1<a name='951'>
      end do<a name='952'>
<font color=#447700>!*         (b) do ascent in 'cuasc'in absence of downdrafts<a name='953'></font>
<font color=#447700>!----------------------------------------------------------<a name='954'></font>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUASC_NEW'>cuasc_new</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUMASTR_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUASC_NEW_1"> &amp;<a name='955'>
         (klon,     klev,     klevp1,   klevm1,   ztenh,   &amp;<a name='956'>
          zqenh,    puen,     pven,     pten,     pqen,    &amp;<a name='957'>
          pqsen,    pgeo,     zgeoh,    pap,      paph,    &amp;<a name='958'>
          pqte,     pverv,    ilwmin,   ldcum,    zhcbase, &amp;<a name='959'>
          ktype,    ilab,     ptu,      pqu,      plu,     &amp;<a name='960'>
          zuu,      zvu,      pmfu,     zmfub,    zentr,   &amp;<a name='961'>
          zmfus,    zmfuq,    zmful,    plude,    zdmfup,  &amp;<a name='962'>
          kcbot,    kctop,    ictop0,   icum,     ztmst,   &amp;<a name='963'>
          ihmin,    zhhatt,   zqsenh)<a name='964'>
      if(icum.eq.0) return<a name='965'>
<font color=#447700>!*     (c) check cloud depth and change entrainment rate accordingly<a name='966'></font>
<font color=#447700>!          calculate precipitation rate (for downdraft calculation)<a name='967'></font>
<font color=#447700>!------------------------------------------------------------------<a name='968'></font>
      do jl=1,klon<a name='969'>
      zpbmpt=paph(jl,kcbot(jl))-paph(jl,kctop(jl))<a name='970'>
      if(ldcum(jl)) ictop0(jl)=kctop(jl)<a name='971'>
      if(ldcum(jl).and.ktype(jl).eq.1.and.zpbmpt.lt.zdnoprc) ktype(jl)=2<a name='972'>
      if(ktype(jl).eq.2) then<a name='973'>
        zentr(jl)=entrscv<a name='974'>
        if(lndj(jl).eq.1) zentr(jl)=zentr(jl)*1.1<a name='975'>
      endif<a name='976'>
      zrfl(jl)=zdmfup(jl,1)<a name='977'>
      end do<a name='978'>
<a name='979'>
      do jk=2,klev<a name='980'>
      do jl=1,klon<a name='981'>
          zrfl(jl)=zrfl(jl)+zdmfup(jl,jk)<a name='982'>
      end do<a name='983'>
      end do<a name='984'>
<font color=#447700>!-----------------------------------------<a name='985'></font>
<font color=#447700>!*    5.0   cumulus downdraft calculations<a name='986'></font>
<font color=#447700>!-----------------------------------------<a name='987'></font>
      if(lmfdd) then<a name='988'>
<font color=#447700>!*      (a) determine lfs in 'cudlfs'<a name='989'></font>
<font color=#447700>!--------------------------------------<a name='990'></font>
         call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUDLFS'>cudlfs</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUMASTR_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUDLFS_1"> &amp;<a name='991'>
         (klon,     klev,     klevp1,   ztenh,    zqenh,  &amp;<a name='992'>
          puen,     pven,     zgeoh,    paph,     ptu,    &amp;<a name='993'>
          pqu,      zuu,      zvu,      ldcum,    kcbot,  &amp;<a name='994'>
          kctop,    zmfub,    zrfl,     ztd,      zqd,    &amp;<a name='995'>
          zud,      zvd,      pmfd,     zmfds,    zmfdq,  &amp;<a name='996'>
          zdmfdp,   idtop,    loddraf)<a name='997'>
<font color=#447700>!*     (b)  determine downdraft t,q and fluxes in 'cuddraf'<a name='998'></font>
<font color=#447700>!------------------------------------------------------------<a name='999'></font>
         call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUDDRAF'>cuddraf</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUMASTR_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUDDRAF_1"> &amp;<a name='1000'>
         (klon,     klev,     klevp1,   ztenh,    zqenh,  &amp;<a name='1001'>
          puen,     pven,     zgeoh,    paph,     zrfl,   &amp;<a name='1002'>
          loddraf,  ztd,      zqd,      zud,      zvd,    &amp;<a name='1003'>
          pmfd,     zmfds,    zmfdq,    zdmfdp)<a name='1004'>
<font color=#447700>!*     (c)  recalculate convective fluxes due to effect of<a name='1005'></font>
<font color=#447700>!           downdrafts on boundary layer moisture budget<a name='1006'></font>
<font color=#447700>!-----------------------------------------------------------<a name='1007'></font>
      end if<a name='1008'>
<font color=#447700>!<a name='1009'></font>
<font color=#447700>!-- 5.1 recalculate cloud base massflux from a cape closure<a name='1010'></font>
<font color=#447700>!       for deep convection (ktype=1) and by pbl equilibrium<a name='1011'></font>
<font color=#447700>!       taking downdrafts into account for shallow convection<a name='1012'></font>
<font color=#447700>!       (ktype=2)<a name='1013'></font>
<font color=#447700>!       implemented by y. wang based on echam4 in nov. 2001.<a name='1014'></font>
<font color=#447700>!<a name='1015'></font>
      do jl=1,klon<a name='1016'>
        zheat(jl)=0.0<a name='1017'>
        zcape(jl)=0.0<a name='1018'>
        zrelh(jl)=0.0<a name='1019'>
        zmfub1(jl)=zmfub(jl)<a name='1020'>
      end do<a name='1021'>
<font color=#447700>!<a name='1022'></font>
      do jl=1,klon<a name='1023'>
      if(ldcum(jl).and.ktype(jl).eq.1) then<a name='1024'>
       ktop0=max(12,kctop(jl))<a name='1025'>
       ikb = kcbot(jl)<a name='1026'>
       do jk=2,klev<a name='1027'>
       if(jk.le.kcbot(jl).and.jk.gt.kctop(jl)) then<a name='1028'>
         zro=paph(jl,jk)/(rd*ztenh(jl,jk))<a name='1029'>
         zdz=(paph(jl,jk)-paph(jl,jk-1))/(g*zro)<a name='1030'>
         zheat(jl)=zheat(jl)+((pten(jl,jk-1)-pten(jl,jk)   &amp;<a name='1031'>
           +g*zdz/cpd)/ztenh(jl,jk)+0.608*(pqen(jl,jk-1)-  &amp;<a name='1032'>
           pqen(jl,jk)))*(pmfu(jl,jk)+pmfd(jl,jk))*g/zro<a name='1033'>
         zcape(jl)=zcape(jl)+g*((ptu(jl,jk)*(1.+.608*pqu(jl,jk) &amp;<a name='1034'>
           -plu(jl,jk)))/(ztenh(jl,jk)*(1.+.608*zqenh(jl,jk))) &amp;<a name='1035'>
           -1.0)*zdz<a name='1036'>
       endif<a name='1037'>
       if(jk.le.kcbot(jl).and.jk.gt.ktop0) then<a name='1038'>
         dept=(paph(jl,jk+1)-paph(jl,jk))/(paph(jl,ikb+1)-  &amp;<a name='1039'>
            paph(jl,ktop0+1))<a name='1040'>
         zrelh(jl)=zrelh(jl)+dept*pqen(jl,jk)/pqsen(jl,jk)<a name='1041'>
       endif<a name='1042'>
       enddo<a name='1043'>
<font color=#447700>!<a name='1044'></font>
       if(zrelh(jl).ge.crirh) then<a name='1045'>
         zht=max(0.0,(zcape(jl)-0.0))/(ztau*zheat(jl))<a name='1046'>
         zmfub1(jl)=max(zmfub(jl)*zht,0.01)<a name='1047'>
         zmfmax=(paph(jl,ikb)-paph(jl,ikb-1))*zcons2<a name='1048'>
         zmfub1(jl)=min(zmfub1(jl),zmfmax)<a name='1049'>
       else<a name='1050'>
         zmfub1(jl)=0.01<a name='1051'>
         zmfub(jl)=0.01<a name='1052'>
         ldcum(jl)=.false.<a name='1053'>
        endif<a name='1054'>
       endif<a name='1055'>
       end do<a name='1056'>
<font color=#447700>!<a name='1057'></font>
<font color=#447700>!*  5.2   recalculate convective fluxes due to effect of<a name='1058'></font>
<font color=#447700>!         downdrafts on boundary layer moisture budget<a name='1059'></font>
<font color=#447700>!--------------------------------------------------------<a name='1060'></font>
       do jl=1,klon<a name='1061'>
        if(ktype(jl).ne.1) then<a name='1062'>
           ikb=kcbot(jl)<a name='1063'>
           if(pmfd(jl,ikb).lt.0.0.and.loddraf(jl)) then<a name='1064'>
              zeps=cmfdeps<a name='1065'>
           else<a name='1066'>
              zeps=0.<a name='1067'>
           endif<a name='1068'>
           zqumqe=pqu(jl,ikb)+plu(jl,ikb)-          &amp;<a name='1069'>
                 zeps*zqd(jl,ikb)-(1.-zeps)*zqenh(jl,ikb)<a name='1070'>
           zdqmin=max(0.01*zqenh(jl,ikb),1.e-10)<a name='1071'>
           zmfmax=(paph(jl,ikb)-paph(jl,ikb-1))*zcons2<a name='1072'>
           if(zdqpbl(jl).gt.0..and.zqumqe.gt.zdqmin.and.ldcum(jl) &amp;<a name='1073'>
             .and.zmfub(jl).lt.zmfmax) then<a name='1074'>
              zmfub1(jl)=zdqpbl(jl)/(g*max(zqumqe,zdqmin))<a name='1075'>
           else<a name='1076'>
              zmfub1(jl)=zmfub(jl)<a name='1077'>
           endif<a name='1078'>
           llo1=(ktype(jl).eq.2).and.abs(zmfub1(jl)  &amp;<a name='1079'>
                -zmfub(jl)).lt.0.2*zmfub(jl)<a name='1080'>
           if(.not.llo1) zmfub1(jl)=zmfub(jl)<a name='1081'>
           zmfub1(jl)=min(zmfub1(jl),zmfmax)<a name='1082'>
        end if<a name='1083'>
        end do<a name='1084'>
<a name='1085'>
        do jk=1,klev<a name='1086'>
        do jl=1,klon<a name='1087'>
        if(ldcum(jl)) then<a name='1088'>
           zfac=zmfub1(jl)/max(zmfub(jl),1.e-10)<a name='1089'>
           pmfd(jl,jk)=pmfd(jl,jk)*zfac<a name='1090'>
           zmfds(jl,jk)=zmfds(jl,jk)*zfac<a name='1091'>
           zmfdq(jl,jk)=zmfdq(jl,jk)*zfac<a name='1092'>
           zdmfdp(jl,jk)=zdmfdp(jl,jk)*zfac<a name='1093'>
        else<a name='1094'>
           pmfd(jl,jk)=0.0<a name='1095'>
           zmfds(jl,jk)=0.0<a name='1096'>
           zmfdq(jl,jk)=0.0<a name='1097'>
           zdmfdp(jl,jk)=0.0<a name='1098'>
        endif<a name='1099'>
        end do<a name='1100'>
        end do<a name='1101'>
<a name='1102'>
        do jl=1,klon<a name='1103'>
           if(ldcum(jl)) then<a name='1104'>
              zmfub(jl)=zmfub1(jl)<a name='1105'>
           else<a name='1106'>
              zmfub(jl)=0.0<a name='1107'>
           endif<a name='1108'>
        end do<a name='1109'>
<font color=#447700>!<a name='1110'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1111'></font>
<font color=#447700>!*    6.0      determine final cloud ascent for entraining plume<a name='1112'></font>
<font color=#447700>!*             for penetrative convection (type=1),<a name='1113'></font>
<font color=#447700>!*             for shallow to medium convection (type=2)<a name='1114'></font>
<font color=#447700>!*             and for mid-level convection (type=3).<a name='1115'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1116'></font>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUASC_NEW'>cuasc_new</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUMASTR_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUASC_NEW_2"> &amp;<a name='1117'>
         (klon,     klev,     klevp1,   klevm1,   ztenh,  &amp;<a name='1118'>
          zqenh,    puen,     pven,     pten,     pqen,   &amp;<a name='1119'>
          pqsen,    pgeo,     zgeoh,    pap,      paph,   &amp;<a name='1120'>
          pqte,     pverv,    ilwmin,   ldcum,    zhcbase,&amp; <a name='1121'>
          ktype,    ilab,     ptu,      pqu,      plu,    &amp;<a name='1122'>
          zuu,      zvu,      pmfu,     zmfub,    zentr,  &amp;<a name='1123'>
          zmfus,    zmfuq,    zmful,    plude,    zdmfup, &amp;<a name='1124'>
          kcbot,    kctop,    ictop0,   icum,     ztmst,  &amp;<a name='1125'>
          ihmin,    zhhatt,   zqsenh)<a name='1126'>
<font color=#447700>!----------------------------------------------------------<a name='1127'></font>
<font color=#447700>!*    7.0      determine final convective fluxes in 'cuflx'<a name='1128'></font>
<font color=#447700>!----------------------------------------------------------<a name='1129'></font>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUFLX'>cuflx</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUMASTR_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUFLX_1"> &amp;<a name='1130'>
         (klon,     klev,     klevp1,   pqen,     pqsen,  &amp;<a name='1131'>
          ztenh,    zqenh,    paph,     zgeoh,    kcbot,  &amp;<a name='1132'>
          kctop,    idtop,    ktype,    loddraf,  ldcum,  &amp;<a name='1133'>
          pmfu,     pmfd,     zmfus,    zmfds,    zmfuq,  &amp;<a name='1134'>
          zmfdq,    zmful,    plude,    zdmfup,   zdmfdp, &amp;<a name='1135'>
          zrfl,     prain,    pten,     zsfl,     zdpmel, &amp;<a name='1136'>
          itopm2,   ztmst,    sig1)<a name='1137'>
<font color=#447700>!----------------------------------------------------------------<a name='1138'></font>
<font color=#447700>!*    8.0      update tendencies for t and q in subroutine cudtdq<a name='1139'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1140'></font>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUDTDQ'>cudtdq</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUMASTR_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUDTDQ_1">                                          &amp;<a name='1141'>
         (klon,     klev,     klevp1,   itopm2,   paph,    &amp;<a name='1142'>
          ldcum,    pten,     ptte,     pqte,     zmfus,   &amp;<a name='1143'>
          zmfds,    zmfuq,    zmfdq,    zmful,    zdmfup,  &amp;<a name='1144'>
          zdmfdp,   ztmst,    zdpmel,   prain,    zrfl,    &amp;<a name='1145'>
          zsfl,     psrain,   psevap,   psheat,   psmelt,  &amp;<a name='1146'>
          prsfc,    pssfc,    paprc,    paprsm,   paprs,   &amp;<a name='1147'>
          pqen,     pqsen,    plude,    pcte)<a name='1148'>
<font color=#447700>!----------------------------------------------------------------<a name='1149'></font>
<font color=#447700>!*    9.0      update tendencies for u and u in subroutine cududv<a name='1150'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1151'></font>
      if(lmfdudv) then<a name='1152'>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUDUDV'>cududv</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUMASTR_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUDUDV_1">  &amp;<a name='1153'>
         (klon,     klev,     klevp1,   itopm2,   ktype,   &amp;<a name='1154'>
          kcbot,    paph,     ldcum,    puen,     pven,    &amp;<a name='1155'>
          pvom,     pvol,     zuu,      zud,      zvu,     &amp;<a name='1156'>
          zvd,      pmfu,     pmfd,     psdiss)<a name='1157'>
      end if<a name='1158'>
      return<a name='1159'>
      end subroutine cumastr_new<a name='1160'>
<font color=#447700>!<a name='1161'></font>
<a name='1162'>
<font color=#447700>!#############################################################<a name='1163'></font>
<font color=#447700>!<a name='1164'></font>
<font color=#447700>!             level 3 subroutines<a name='1165'></font>
<font color=#447700>!<a name='1166'></font>
<font color=#447700>!#############################################################<a name='1167'></font>
<font color=#447700>!**********************************************<a name='1168'></font>
<font color=#447700>!       subroutine cuini<a name='1169'></font>
<font color=#447700>!**********************************************<a name='1170'></font>
<font color=#447700>!<a name='1171'></font>
<A NAME='CUINI'><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUINI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1172'>
      <font color=#993300>subroutine </font><font color=#cc0000>cuini</font>                                    &amp; <A href='../../call_to/CUINI.html' TARGET='index'>1</A>,<A href='../../call_from/CUINI.html' TARGET='index'>1</A><a name='1173'>
         (klon,     klev,     klevp1,   klevm1,   pten,   &amp;<a name='1174'>
          pqen,     pqsen,    puen,     pven,     pverv,  &amp;<a name='1175'>
          pgeo,     paph,     pgeoh,    ptenh,    pqenh,  &amp;<a name='1176'>
          pqsenh,   klwmin,   ptu,      pqu,      ptd,    &amp;<a name='1177'>
          pqd,      puu,      pvu,      pud,      pvd,    &amp;<a name='1178'>
          pmfu,     pmfd,     pmfus,    pmfds,    pmfuq,  &amp;<a name='1179'>
          pmfdq,    pdmfup,   pdmfdp,   pdpmel,   plu,    &amp;<a name='1180'>
          plude,    klab)<a name='1181'>
<font color=#447700>!      m.tiedtke         e.c.m.w.f.     12/89<a name='1182'></font>
<font color=#447700>!***purpose<a name='1183'></font>
<font color=#447700>!   -------<a name='1184'></font>
<font color=#447700>!          this routine interpolates large-scale fields of t,q etc.<a name='1185'></font>
<font color=#447700>!          to half levels (i.e. grid for massflux scheme),<a name='1186'></font>
<font color=#447700>!          and initializes values for updrafts and downdrafts<a name='1187'></font>
<font color=#447700>!***interface<a name='1188'></font>
<font color=#447700>!   ---------<a name='1189'></font>
<font color=#447700>!          this routine is called from *cumastr*.<a name='1190'></font>
<font color=#447700>!***method.<a name='1191'></font>
<font color=#447700>!  --------<a name='1192'></font>
<font color=#447700>!          for extrapolation to half levels see tiedtke(1989)<a name='1193'></font>
<font color=#447700>!***externals<a name='1194'></font>
<font color=#447700>!   ---------<a name='1195'></font>
<font color=#447700>!          *cuadjtq* to specify qs at half levels<a name='1196'></font>
<font color=#447700>! ----------------------------------------------------------------<a name='1197'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='1198'></font>
      implicit none<a name='1199'>
<font color=#447700>!-------------------------------------------------------------------<a name='1200'></font>
      integer   klon, klev, klevp1<a name='1201'>
      integer   klevm1<a name='1202'>
      integer   jk,jl,ik, icall<a name='1203'>
      real      zdp, zzs<a name='1204'>
      real     pten(klon,klev),        pqen(klon,klev),    &amp;<a name='1205'>
              puen(klon,klev),        pven(klon,klev),     &amp;<a name='1206'>
              pqsen(klon,klev),       pverv(klon,klev),    &amp;<a name='1207'>
              pgeo(klon,klev),        pgeoh(klon,klev),    &amp;<a name='1208'>
              paph(klon,klevp1),      ptenh(klon,klev),    &amp;<a name='1209'>
              pqenh(klon,klev),       pqsenh(klon,klev)<a name='1210'>
      real     ptu(klon,klev),         pqu(klon,klev),     &amp;<a name='1211'>
              ptd(klon,klev),         pqd(klon,klev),      &amp;<a name='1212'>
              puu(klon,klev),         pud(klon,klev),      &amp;<a name='1213'>
              pvu(klon,klev),         pvd(klon,klev),      &amp;<a name='1214'>
              pmfu(klon,klev),        pmfd(klon,klev),     &amp;<a name='1215'>
              pmfus(klon,klev),       pmfds(klon,klev),    &amp;<a name='1216'>
              pmfuq(klon,klev),       pmfdq(klon,klev),    &amp;<a name='1217'>
              pdmfup(klon,klev),      pdmfdp(klon,klev),   &amp; <a name='1218'>
              plu(klon,klev),         plude(klon,klev)<a name='1219'>
      real     zwmax(klon),            zph(klon),          &amp;<a name='1220'>
              pdpmel(klon,klev)<a name='1221'>
      integer  klab(klon,klev),        klwmin(klon)<a name='1222'>
      logical  loflag(klon)<a name='1223'>
<font color=#447700>!------------------------------------------------------------<a name='1224'></font>
<font color=#447700>!*    1.       specify large scale parameters at half levels<a name='1225'></font>
<font color=#447700>!*             adjust temperature fields if staticly unstable<a name='1226'></font>
<font color=#447700>!*             find level of maximum vertical velocity<a name='1227'></font>
<font color=#447700>! -----------------------------------------------------------<a name='1228'></font>
      zdp=0.5<a name='1229'>
      do jk=2,klev<a name='1230'>
      do jl=1,klon<a name='1231'>
      pgeoh(jl,jk)=pgeo(jl,jk)+(pgeo(jl,jk-1)-pgeo(jl,jk))*zdp<a name='1232'>
      ptenh(jl,jk)=(max(cpd*pten(jl,jk-1)+pgeo(jl,jk-1),   &amp;<a name='1233'>
                  cpd*pten(jl,jk)+pgeo(jl,jk))-pgeoh(jl,jk))*rcpd<a name='1234'>
      pqsenh(jl,jk)=pqsen(jl,jk-1)<a name='1235'>
      zph(jl)=paph(jl,jk)<a name='1236'>
      loflag(jl)=.true.<a name='1237'>
      end do<a name='1238'>
<a name='1239'>
      ik=jk<a name='1240'>
      icall=0<a name='1241'>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ'>cuadjtq</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUINI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUADJTQ_1">(klon,klev,ik,zph,ptenh,pqsenh,loflag,icall)<a name='1242'>
      do jl=1,klon<a name='1243'>
      pqenh(jl,jk)=min(pqen(jl,jk-1),pqsen(jl,jk-1))    &amp;<a name='1244'>
                 +(pqsenh(jl,jk)-pqsen(jl,jk-1))<a name='1245'>
      pqenh(jl,jk)=max(pqenh(jl,jk),0.)<a name='1246'>
      end do<a name='1247'>
      end do<a name='1248'>
<a name='1249'>
      do jl=1,klon<a name='1250'>
      ptenh(jl,klev)=(cpd*pten(jl,klev)+pgeo(jl,klev)-   &amp;<a name='1251'>
                     pgeoh(jl,klev))*rcpd<a name='1252'>
      pqenh(jl,klev)=pqen(jl,klev)<a name='1253'>
      ptenh(jl,1)=pten(jl,1)<a name='1254'>
      pqenh(jl,1)=pqen(jl,1)<a name='1255'>
      pgeoh(jl,1)=pgeo(jl,1)<a name='1256'>
      klwmin(jl)=klev<a name='1257'>
      zwmax(jl)=0.<a name='1258'>
      end do<a name='1259'>
<a name='1260'>
      do jk=klevm1,2,-1<a name='1261'>
      do jl=1,klon<a name='1262'>
      zzs=max(cpd*ptenh(jl,jk)+pgeoh(jl,jk),   &amp;<a name='1263'>
             cpd*ptenh(jl,jk+1)+pgeoh(jl,jk+1))<a name='1264'>
      ptenh(jl,jk)=(zzs-pgeoh(jl,jk))*rcpd<a name='1265'>
      end do<a name='1266'>
      end do<a name='1267'>
<a name='1268'>
      do jk=klev,3,-1<a name='1269'>
      do jl=1,klon<a name='1270'>
      if(pverv(jl,jk).lt.zwmax(jl)) then<a name='1271'>
         zwmax(jl)=pverv(jl,jk)<a name='1272'>
         klwmin(jl)=jk<a name='1273'>
      end if<a name='1274'>
      end do<a name='1275'>
      end do<a name='1276'>
<font color=#447700>!-----------------------------------------------------------<a name='1277'></font>
<font color=#447700>!*    2.0      initialize values for updrafts and downdrafts<a name='1278'></font>
<font color=#447700>!-----------------------------------------------------------<a name='1279'></font>
      do jk=1,klev<a name='1280'>
      ik=jk-1<a name='1281'>
      if(jk.eq.1) ik=1<a name='1282'>
      do jl=1,klon<a name='1283'>
      ptu(jl,jk)=ptenh(jl,jk)<a name='1284'>
      ptd(jl,jk)=ptenh(jl,jk)<a name='1285'>
      pqu(jl,jk)=pqenh(jl,jk)<a name='1286'>
      pqd(jl,jk)=pqenh(jl,jk)<a name='1287'>
      plu(jl,jk)=0.<a name='1288'>
      puu(jl,jk)=puen(jl,ik)<a name='1289'>
      pud(jl,jk)=puen(jl,ik)<a name='1290'>
      pvu(jl,jk)=pven(jl,ik)<a name='1291'>
      pvd(jl,jk)=pven(jl,ik)<a name='1292'>
      pmfu(jl,jk)=0.<a name='1293'>
      pmfd(jl,jk)=0.<a name='1294'>
      pmfus(jl,jk)=0.<a name='1295'>
      pmfds(jl,jk)=0.<a name='1296'>
      pmfuq(jl,jk)=0.<a name='1297'>
      pmfdq(jl,jk)=0.<a name='1298'>
      pdmfup(jl,jk)=0.<a name='1299'>
      pdmfdp(jl,jk)=0.<a name='1300'>
      pdpmel(jl,jk)=0.<a name='1301'>
      plude(jl,jk)=0.<a name='1302'>
      klab(jl,jk)=0<a name='1303'>
      end do<a name='1304'>
      end do<a name='1305'>
      return<a name='1306'>
      end subroutine cuini   <a name='1307'>
<a name='1308'>
<font color=#447700>!**********************************************<a name='1309'></font>
<font color=#447700>!       subroutine cubase<a name='1310'></font>
<font color=#447700>!********************************************** <a name='1311'></font>
<A NAME='CUBASE'><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUBASE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1312'>
      <font color=#993300>subroutine </font><font color=#cc0000>cubase</font> &amp; <A href='../../call_to/CUBASE.html' TARGET='index'>1</A>,<A href='../../call_from/CUBASE.html' TARGET='index'>1</A><a name='1313'>
         (klon,     klev,     klevp1,   klevm1,   ptenh, &amp;<a name='1314'>
          pqenh,    pgeoh,    paph,     ptu,      pqu,   &amp;<a name='1315'>
          plu,      puen,     pven,     puu,      pvu,   &amp;<a name='1316'>
          ldcum,    kcbot,    klab)<a name='1317'>
<font color=#447700>!      this routine calculates cloud base values (t and q)<a name='1318'></font>
<font color=#447700>!      for cumulus parameterization<a name='1319'></font>
<font color=#447700>!      m.tiedtke         e.c.m.w.f.     7/86 modif.  12/89<a name='1320'></font>
<font color=#447700>!***purpose.<a name='1321'></font>
<font color=#447700>!   --------<a name='1322'></font>
<font color=#447700>!          to produce cloud base values for cu-parametrization<a name='1323'></font>
<font color=#447700>!***interface<a name='1324'></font>
<font color=#447700>!   ---------<a name='1325'></font>
<font color=#447700>!          this routine is called from *cumastr*.<a name='1326'></font>
<font color=#447700>!          input are environm. values of t,q,p,phi at half levels.<a name='1327'></font>
<font color=#447700>!          it returns cloud base values and flags as follows;<a name='1328'></font>
<font color=#447700>!                 klab=1 for subcloud levels<a name='1329'></font>
<font color=#447700>!                 klab=2 for condensation level<a name='1330'></font>
<font color=#447700>!***method.<a name='1331'></font>
<font color=#447700>!  --------<a name='1332'></font>
<font color=#447700>!          lift surface air dry-adiabatically to cloud base<a name='1333'></font>
<font color=#447700>!          (non entraining plume,i.e.constant massflux)<a name='1334'></font>
<font color=#447700>!***externals<a name='1335'></font>
<font color=#447700>!   ---------<a name='1336'></font>
<font color=#447700>!          *cuadjtq* for adjusting t and q due to condensation in ascent<a name='1337'></font>
<font color=#447700>! ----------------------------------------------------------------<a name='1338'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='1339'></font>
      implicit none<a name='1340'>
<font color=#447700>!-------------------------------------------------------------------<a name='1341'></font>
      integer   klon, klev, klevp1<a name='1342'>
      integer   klevm1<a name='1343'>
      integer   jl,jk,is,ik,icall,ikb<a name='1344'>
      real      zbuo,zz<a name='1345'>
      real     ptenh(klon,klev),       pqenh(klon,klev),  &amp;<a name='1346'>
              pgeoh(klon,klev),       paph(klon,klevp1)<a name='1347'>
      real     ptu(klon,klev),         pqu(klon,klev),   &amp;<a name='1348'>
              plu(klon,klev)<a name='1349'>
      real     puen(klon,klev),        pven(klon,klev),  &amp;<a name='1350'>
              puu(klon,klev),         pvu(klon,klev) <a name='1351'>
      real     zqold(klon,klev),       zph(klon)<a name='1352'>
      integer  klab(klon,klev),        kcbot(klon)<a name='1353'>
      logical  ldcum(klon),            loflag(klon)<a name='1354'>
      logical  ldbase(klon)<a name='1355'>
      logical  llo1<a name='1356'>
<font color=#447700>!***input variables:<a name='1357'></font>
<font color=#447700>!       ptenh [ztenh] - environment temperature on half levels. (cuini)<a name='1358'></font>
<font color=#447700>!       pqenh [zqenh] - env. specific humidity on half levels. (cuini)<a name='1359'></font>
<font color=#447700>!       pgeoh [zgeoh] - geopotential on half levels, (mssflx)<a name='1360'></font>
<font color=#447700>!       paph - pressure of half levels. (mssflx)<a name='1361'></font>
<font color=#447700>!***variables modified by cubase:<a name='1362'></font>
<font color=#447700>!       ldcum - logical denoting profiles. (cubase)<a name='1363'></font>
<font color=#447700>!       ktype - convection type - 1: penetrative  (cumastr)<a name='1364'></font>
<font color=#447700>!                                 2: stratocumulus (cumastr)<a name='1365'></font>
<font color=#447700>!                                 3: mid-level  (cuasc)<a name='1366'></font>
<font color=#447700>!       ptu - cloud temperature.<a name='1367'></font>
<font color=#447700>!       pqu - cloud specific humidity.<a name='1368'></font>
<font color=#447700>!       plu - cloud liquid water (moisture condensed out)<a name='1369'></font>
<font color=#447700>!       kcbot - cloud base level. (cubase)<a name='1370'></font>
<font color=#447700>!       klab [ilab] - level label - 1: sub-cloud layer (cubase)<a name='1371'></font>
<font color=#447700>!------------------------------------------------<a name='1372'></font>
<font color=#447700>!     1.       initialize values at lifting level<a name='1373'></font>
<font color=#447700>!------------------------------------------------<a name='1374'></font>
      do jl=1,klon<a name='1375'>
        klab(jl,klev)=1<a name='1376'>
        kcbot(jl)=klevm1<a name='1377'>
        ldcum(jl)=.false.<a name='1378'>
        ldbase(jl)=.false.<a name='1379'>
        puu(jl,klev)=puen(jl,klev)*(paph(jl,klevp1)-paph(jl,klev))<a name='1380'>
        pvu(jl,klev)=pven(jl,klev)*(paph(jl,klevp1)-paph(jl,klev))<a name='1381'>
      end do<a name='1382'>
<font color=#447700>!-------------------------------------------------------<a name='1383'></font>
<font color=#447700>!     2.0      do ascent in subcloud layer,<a name='1384'></font>
<font color=#447700>!              check for existence of condensation level,<a name='1385'></font>
<font color=#447700>!              adjust t,q and l accordingly in *cuadjtq*,<a name='1386'></font>
<font color=#447700>!              check for buoyancy and set flags<a name='1387'></font>
<font color=#447700>!-------------------------------------------------------<a name='1388'></font>
      do jk=1,klev<a name='1389'>
      do jl=1,klon<a name='1390'>
        zqold(jl,jk)=0.0<a name='1391'>
      end do<a name='1392'>
      end do<a name='1393'>
<a name='1394'>
      do jk=klevm1,2,-1<a name='1395'>
        is=0<a name='1396'>
        do jl=1,klon<a name='1397'>
          if(klab(jl,jk+1).eq.1 .or.(ldcum(jl).and.kcbot(jl).eq.jk+1)) then<a name='1398'>
             is=is+1<a name='1399'>
             loflag(jl)=.true.<a name='1400'>
          else<a name='1401'>
             loflag(jl)=.false.<a name='1402'>
          endif<a name='1403'>
          zph(jl)=paph(jl,jk)<a name='1404'>
        end do<a name='1405'>
        if(is.eq.0) cycle<a name='1406'>
<a name='1407'>
<font color=#447700>!             calculate averages of u and v for subcloud area,<a name='1408'></font>
<font color=#447700>!             the values will be used to define cloud base values.<a name='1409'></font>
      <a name='1410'>
        if(lmfdudv) then<a name='1411'>
          do jl=1,klon<a name='1412'>
            if(.not.ldbase(jl)) then<a name='1413'>
              puu(jl,klev)=puu(jl,klev)+ &amp;<a name='1414'>
                  puen(jl,jk)*(paph(jl,jk+1)-paph(jl,jk))<a name='1415'>
              pvu(jl,klev)=pvu(jl,klev)+ &amp;<a name='1416'>
                  pven(jl,jk)*(paph(jl,jk+1)-paph(jl,jk))<a name='1417'>
            endif<a name='1418'>
          enddo<a name='1419'>
        endif<a name='1420'>
<a name='1421'>
        do jl=1,klon<a name='1422'>
          if(loflag(jl)) then<a name='1423'>
             pqu(jl,jk)=pqu(jl,jk+1)<a name='1424'>
             ptu(jl,jk)=(cpd*ptu(jl,jk+1)+pgeoh(jl,jk+1)  &amp;<a name='1425'>
                       -pgeoh(jl,jk))*rcpd<a name='1426'>
             zqold(jl,jk)=pqu(jl,jk)<a name='1427'>
          end if<a name='1428'>
        end do<a name='1429'>
<a name='1430'>
        ik=jk<a name='1431'>
        icall=1<a name='1432'>
        call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ'>cuadjtq</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUBASE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUADJTQ_2">(klon,klev,ik,zph,ptu,pqu,loflag,icall)<a name='1433'>
<a name='1434'>
        do jl=1,klon<a name='1435'>
          if(loflag(jl)) then<a name='1436'>
           if(pqu(jl,jk).eq.zqold(jl,jk)) then<a name='1437'>
             zbuo=ptu(jl,jk)*(1.+vtmpc1*pqu(jl,jk))-      &amp;<a name='1438'>
                 ptenh(jl,jk)*(1.+vtmpc1*pqenh(jl,jk))+zbuo0<a name='1439'>
             if(zbuo.gt.0.) klab(jl,jk)=1<a name='1440'>
           else <a name='1441'>
             klab(jl,jk)=2<a name='1442'>
             plu(jl,jk)=plu(jl,jk)+zqold(jl,jk)-pqu(jl,jk)<a name='1443'>
             zbuo=ptu(jl,jk)*(1.+vtmpc1*pqu(jl,jk))-      &amp;<a name='1444'>
                 ptenh(jl,jk)*(1.+vtmpc1*pqenh(jl,jk))+zbuo0<a name='1445'>
             llo1=zbuo.gt.0..and.klab(jl,jk+1).eq.1<a name='1446'>
             if(llo1) then<a name='1447'>
                kcbot(jl)=jk<a name='1448'>
                ldcum(jl)=.true.<a name='1449'>
                ldbase(jl)=.true.<a name='1450'>
             end if<a name='1451'>
           end if<a name='1452'>
          end if<a name='1453'>
        end do<a name='1454'>
      end do<a name='1455'>
<a name='1456'>
      if(lmfdudv) then<a name='1457'>
         do jl=1,klon<a name='1458'>
         if(ldcum(jl)) then<a name='1459'>
            ikb=kcbot(jl)<a name='1460'>
            zz=1./(paph(jl,klevp1)-paph(jl,ikb))<a name='1461'>
            puu(jl,klev)=puu(jl,klev)*zz<a name='1462'>
            pvu(jl,klev)=pvu(jl,klev)*zz<a name='1463'>
         else<a name='1464'>
            puu(jl,klev)=puen(jl,klevm1)<a name='1465'>
            pvu(jl,klev)=pven(jl,klevm1)<a name='1466'>
         end if<a name='1467'>
         end do<a name='1468'>
      end if<a name='1469'>
      return<a name='1470'>
      end subroutine cubase<a name='1471'>
<font color=#447700>!<a name='1472'></font>
<font color=#447700>!**********************************************<a name='1473'></font>
<font color=#447700>!       subroutine cuasc_new<a name='1474'></font>
<font color=#447700>!********************************************** <a name='1475'></font>
<A NAME='CUASC_NEW'><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUASC_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1476'>
      <font color=#993300>subroutine </font><font color=#cc0000>cuasc_new</font> &amp; <A href='../../call_to/CUASC_NEW.html' TARGET='index'>2</A>,<A href='../../call_from/CUASC_NEW.html' TARGET='index'>3</A><a name='1477'>
         (klon,     klev,     klevp1,   klevm1,   ptenh,  &amp;<a name='1478'>
          pqenh,    puen,     pven,     pten,     pqen,   &amp;<a name='1479'>
          pqsen,    pgeo,     pgeoh,    pap,      paph,   &amp;<a name='1480'>
          pqte,     pverv,    klwmin,   ldcum,    phcbase,&amp; <a name='1481'>
          ktype,    klab,     ptu,      pqu,      plu,    &amp;<a name='1482'>
          puu,      pvu,      pmfu,     pmfub,    pentr,  &amp;<a name='1483'>
          pmfus,    pmfuq,    pmful,    plude,    pdmfup, &amp; <a name='1484'>
          kcbot,    kctop,    kctop0,   kcum,     ztmst,  &amp;<a name='1485'>
          khmin,    phhatt,   pqsenh)<a name='1486'>
<font color=#447700>!     this routine does the calculations for cloud ascents<a name='1487'></font>
<font color=#447700>!     for cumulus parameterization<a name='1488'></font>
<font color=#447700>!     m.tiedtke         e.c.m.w.f.     7/86 modif.  12/89<a name='1489'></font>
<font color=#447700>!     y.wang            iprc           11/01 modif.<a name='1490'></font>
<font color=#447700>!***purpose.<a name='1491'></font>
<font color=#447700>!   --------<a name='1492'></font>
<font color=#447700>!          to produce cloud ascents for cu-parametrization<a name='1493'></font>
<font color=#447700>!          (vertical profiles of t,q,l,u and v and corresponding<a name='1494'></font>
<font color=#447700>!           fluxes as well as precipitation rates)<a name='1495'></font>
<font color=#447700>!***interface<a name='1496'></font>
<font color=#447700>!   ---------<a name='1497'></font>
<font color=#447700>!          this routine is called from *cumastr*.<a name='1498'></font>
<font color=#447700>!***method.<a name='1499'></font>
<font color=#447700>!  --------<a name='1500'></font>
<font color=#447700>!          lift surface air dry-adiabatically to cloud base<a name='1501'></font>
<font color=#447700>!          and then calculate moist ascent for<a name='1502'></font>
<font color=#447700>!          entraining/detraining plume.<a name='1503'></font>
<font color=#447700>!          entrainment and detrainment rates differ for<a name='1504'></font>
<font color=#447700>!          shallow and deep cumulus convection.<a name='1505'></font>
<font color=#447700>!          in case there is no penetrative or shallow convection<a name='1506'></font>
<font color=#447700>!          check for possibility of mid level convection<a name='1507'></font>
<font color=#447700>!          (cloud base values calculated in *cubasmc*)<a name='1508'></font>
<font color=#447700>!***externals<a name='1509'></font>
<font color=#447700>!   ---------<a name='1510'></font>
<font color=#447700>!          *cuadjtq* adjust t and q due to condensation in ascent<a name='1511'></font>
<font color=#447700>!          *cuentr_new*  calculate entrainment/detrainment rates<a name='1512'></font>
<font color=#447700>!          *cubasmc* calculate cloud base values for midlevel convection<a name='1513'></font>
<font color=#447700>!***reference<a name='1514'></font>
<font color=#447700>!   ---------<a name='1515'></font>
<font color=#447700>!          (tiedtke,1989)<a name='1516'></font>
<font color=#447700>!***input variables:<a name='1517'></font>
<font color=#447700>!       ptenh [ztenh] - environ temperature on half levels. (cuini)<a name='1518'></font>
<font color=#447700>!       pqenh [zqenh] - env. specific humidity on half levels. (cuini)<a name='1519'></font>
<font color=#447700>!       puen - environment wind u-component. (mssflx)<a name='1520'></font>
<font color=#447700>!       pven - environment wind v-component. (mssflx)<a name='1521'></font>
<font color=#447700>!       pten - environment temperature. (mssflx)<a name='1522'></font>
<font color=#447700>!       pqen - environment specific humidity. (mssflx)<a name='1523'></font>
<font color=#447700>!       pqsen - environment saturation specific humidity. (mssflx)<a name='1524'></font>
<font color=#447700>!       pgeo - geopotential. (mssflx)<a name='1525'></font>
<font color=#447700>!       pgeoh [zgeoh] - geopotential on half levels, (mssflx)<a name='1526'></font>
<font color=#447700>!       pap - pressure in pa.  (mssflx)<a name='1527'></font>
<font color=#447700>!       paph - pressure of half levels. (mssflx)<a name='1528'></font>
<font color=#447700>!       pqte - moisture convergence (delta q/delta t). (mssflx)<a name='1529'></font>
<font color=#447700>!       pverv - large scale vertical velocity (omega). (mssflx)<a name='1530'></font>
<font color=#447700>!       klwmin [ilwmin] - level of minimum omega. (cuini)<a name='1531'></font>
<font color=#447700>!       klab [ilab] - level label - 1: sub-cloud layer.<a name='1532'></font>
<font color=#447700>!                                   2: condensation level (cloud base)<a name='1533'></font>
<font color=#447700>!       pmfub [zmfub] - updraft mass flux at cloud base. (cumastr)<a name='1534'></font>
<font color=#447700>!***variables modified by cuasc:<a name='1535'></font>
<font color=#447700>!       ldcum - logical denoting profiles. (cubase)<a name='1536'></font>
<font color=#447700>!       ktype - convection type - 1: penetrative  (cumastr)<a name='1537'></font>
<font color=#447700>!                                 2: stratocumulus (cumastr)<a name='1538'></font>
<font color=#447700>!                                 3: mid-level  (cuasc)<a name='1539'></font>
<font color=#447700>!       ptu - cloud temperature.<a name='1540'></font>
<font color=#447700>!       pqu - cloud specific humidity.<a name='1541'></font>
<font color=#447700>!       plu - cloud liquid water (moisture condensed out)<a name='1542'></font>
<font color=#447700>!       puu [zuu] - cloud momentum u-component.<a name='1543'></font>
<font color=#447700>!       pvu [zvu] - cloud momentum v-component.<a name='1544'></font>
<font color=#447700>!       pmfu - updraft mass flux.<a name='1545'></font>
<font color=#447700>!       pentr [zentr] - entrainment rate. (cumastr ) (cubasmc)<a name='1546'></font>
<font color=#447700>!       pmfus [zmfus] - updraft flux of dry static energy. (cubasmc)<a name='1547'></font>
<font color=#447700>!       pmfuq [zmfuq] - updraft flux of specific humidity.<a name='1548'></font>
<font color=#447700>!       pmful [zmful] - updraft flux of cloud liquid water.<a name='1549'></font>
<font color=#447700>!       plude - liquid water returned to environment by detrainment.<a name='1550'></font>
<font color=#447700>!       pdmfup [zmfup] -<a name='1551'></font>
<font color=#447700>!       kcbot - cloud base level. (cubase)<a name='1552'></font>
<font color=#447700>!       kctop -<a name='1553'></font>
<font color=#447700>!       kctop0 [ictop0] - estimate of cloud top. (cumastr)<a name='1554'></font>
<font color=#447700>!       kcum [icum] -<a name='1555'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='1556'></font>
      implicit none<a name='1557'>
<font color=#447700>!-------------------------------------------------------------------<a name='1558'></font>
      integer   klon, klev, klevp1<a name='1559'>
      integer   klevm1,kcum<a name='1560'>
      real      ztmst,zcons2,zdz,zdrodz<a name='1561'>
      integer   jl,jk,ikb,ik,is,ikt,icall<a name='1562'>
      real      zmfmax,zfac,zmftest,zdprho,zmse,znevn,zodmax<a name='1563'>
      real      zqeen,zseen,zscde,zga,zdt,zscod<a name='1564'>
      real      zqude,zqcod, zmfusk, zmfuqk,zmfulk<a name='1565'>
      real      zbuo, zprcon, zlnew, zz, zdmfeu, zdmfdu<a name='1566'>
      real      zbuoyz,zzdmf<a name='1567'>
      real     ptenh(klon,klev),       pqenh(klon,klev), &amp;<a name='1568'>
              puen(klon,klev),        pven(klon,klev),   &amp;<a name='1569'>
              pten(klon,klev),        pqen(klon,klev),   &amp;<a name='1570'>
              pgeo(klon,klev),        pgeoh(klon,klev),  &amp;<a name='1571'>
              pap(klon,klev),         paph(klon,klevp1), &amp;<a name='1572'>
              pqsen(klon,klev),       pqte(klon,klev),   &amp;<a name='1573'>
              pverv(klon,klev),       pqsenh(klon,klev)  <a name='1574'>
      real     ptu(klon,klev),         pqu(klon,klev),   &amp;<a name='1575'>
              puu(klon,klev),         pvu(klon,klev),    &amp;<a name='1576'>
              pmfu(klon,klev),        zph(klon),         &amp;<a name='1577'>
              pmfub(klon),            pentr(klon),       &amp;<a name='1578'>
              pmfus(klon,klev),       pmfuq(klon,klev),  &amp;<a name='1579'>
              plu(klon,klev),         plude(klon,klev),  &amp;<a name='1580'>
              pmful(klon,klev),       pdmfup(klon,klev)<a name='1581'>
      real     zdmfen(klon),           zdmfde(klon),     &amp;<a name='1582'>
              zmfuu(klon),            zmfuv(klon),       &amp;<a name='1583'>
              zpbase(klon),           zqold(klon),       &amp;<a name='1584'>
              phhatt(klon,klev),      zodetr(klon,klev), &amp;<a name='1585'>
              zoentr(klon,klev),      zbuoy(klon)<a name='1586'>
      real     phcbase(klon)<a name='1587'>
      integer  klwmin(klon),           ktype(klon),      &amp;<a name='1588'>
              klab(klon,klev),        kcbot(klon),       &amp;<a name='1589'>
              kctop(klon),            kctop0(klon),      &amp;<a name='1590'>
              khmin(klon)<a name='1591'>
      logical  ldcum(klon),            loflag(klon)<a name='1592'>
<font color=#447700>!--------------------------------<a name='1593'></font>
<font color=#447700>!*    1.       specify parameters<a name='1594'></font>
<font color=#447700>!--------------------------------<a name='1595'></font>
      zcons2=1./(g*ztmst)<a name='1596'>
<font color=#447700>!---------------------------------<a name='1597'></font>
<font color=#447700>!     2.        set default values<a name='1598'></font>
<font color=#447700>!---------------------------------<a name='1599'></font>
      do jl=1,klon<a name='1600'>
        zmfuu(jl)=0.<a name='1601'>
        zmfuv(jl)=0.<a name='1602'>
        zbuoy(jl)=0.<a name='1603'>
        if(.not.ldcum(jl)) ktype(jl)=0<a name='1604'>
      end do<a name='1605'>
<a name='1606'>
      do jk=1,klev<a name='1607'>
      do jl=1,klon<a name='1608'>
          plu(jl,jk)=0.<a name='1609'>
          pmfu(jl,jk)=0.<a name='1610'>
          pmfus(jl,jk)=0.<a name='1611'>
          pmfuq(jl,jk)=0.<a name='1612'>
          pmful(jl,jk)=0.<a name='1613'>
          plude(jl,jk)=0.<a name='1614'>
          pdmfup(jl,jk)=0.<a name='1615'>
          zoentr(jl,jk)=0.<a name='1616'>
          zodetr(jl,jk)=0.<a name='1617'>
          if(.not.ldcum(jl).or.ktype(jl).eq.3) klab(jl,jk)=0<a name='1618'>
          if(.not.ldcum(jl).and.paph(jl,jk).lt.4.e4) kctop0(jl)=jk<a name='1619'>
      end do<a name='1620'>
      end do<a name='1621'>
<font color=#447700>!------------------------------------------------<a name='1622'></font>
<font color=#447700>!     3.0      initialize values at lifting level<a name='1623'></font>
<font color=#447700>!------------------------------------------------<a name='1624'></font>
      do jl=1,klon<a name='1625'>
        kctop(jl)=klevm1<a name='1626'>
        if(.not.ldcum(jl)) then<a name='1627'>
           kcbot(jl)=klevm1<a name='1628'>
           pmfub(jl)=0.<a name='1629'>
           pqu(jl,klev)=0.<a name='1630'>
        end if<a name='1631'>
        pmfu(jl,klev)=pmfub(jl)<a name='1632'>
        pmfus(jl,klev)=pmfub(jl)*(cpd*ptu(jl,klev)+pgeoh(jl,klev))<a name='1633'>
        pmfuq(jl,klev)=pmfub(jl)*pqu(jl,klev)<a name='1634'>
        if(lmfdudv) then<a name='1635'>
           zmfuu(jl)=pmfub(jl)*puu(jl,klev)<a name='1636'>
           zmfuv(jl)=pmfub(jl)*pvu(jl,klev)<a name='1637'>
        end if<a name='1638'>
      end do<a name='1639'>
<font color=#447700>!<a name='1640'></font>
<font color=#447700>!-- 3.1 find organized entrainment at cloud base<a name='1641'></font>
<font color=#447700>!<a name='1642'></font>
      do jl=1,klon<a name='1643'>
      ldcum(jl)=.false.<a name='1644'>
      if (ktype(jl).eq.1) then<a name='1645'>
      ikb = kcbot(jl)<a name='1646'>
      zbuoy(jl)=g*((ptu(jl,ikb)-ptenh(jl,ikb))/ptenh(jl,ikb)+ &amp;<a name='1647'>
               0.608*(pqu(jl,ikb)-pqenh(jl,ikb)))<a name='1648'>
       if (zbuoy(jl).gt.0.) then<a name='1649'>
        zdz = (pgeo(jl,ikb-1)-pgeo(jl,ikb))*zrg<a name='1650'>
        zdrodz = -log(pten(jl,ikb-1)/pten(jl,ikb))/zdz -  &amp;<a name='1651'>
                 g/(rd*ptenh(jl,ikb))<a name='1652'>
        zoentr(jl,ikb-1)=zbuoy(jl)*0.5/(1.+zbuoy(jl)*zdz) &amp;<a name='1653'>
                +zdrodz<a name='1654'>
        zoentr(jl,ikb-1) = min(zoentr(jl,ikb-1),1.e-3)<a name='1655'>
        zoentr(jl,ikb-1) = max(zoentr(jl,ikb-1),0.)<a name='1656'>
       end if<a name='1657'>
      end if<a name='1658'>
      end do<a name='1659'>
<font color=#447700>!<a name='1660'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='1661'></font>
<font color=#447700>!     4.       do ascent: subcloud layer (klab=1) ,clouds (klab=2)<a name='1662'></font>
<font color=#447700>!              by doing first dry-adiabatic ascent and then<a name='1663'></font>
<font color=#447700>!              by adjusting t,q and l accordingly in *cuadjtq*,<a name='1664'></font>
<font color=#447700>!              then check for buoyancy and set flags accordingly<a name='1665'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='1666'></font>
      do jk=klevm1,2,-1<a name='1667'>
<font color=#447700>!                  specify cloud base values for midlevel convection<a name='1668'></font>
<font color=#447700>!                  in *cubasmc* in case there is not already convection<a name='1669'></font>
<font color=#447700>! ---------------------------------------------------------------------<a name='1670'></font>
      ik=jk<a name='1671'>
      if(lmfmid.and.ik.lt.klevm1.and.ik.gt.klev-13) then<a name='1672'>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUBASMC'>cubasmc</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUASC_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUBASMC_1">  &amp;<a name='1673'>
         (klon,     klev,     klevm1,   ik,      pten,  &amp;<a name='1674'>
          pqen,     pqsen,    puen,     pven,    pverv, &amp;<a name='1675'>
          pgeo,     pgeoh,    ldcum,    ktype,   klab,  &amp;<a name='1676'>
          pmfu,     pmfub,    pentr,    kcbot,   ptu,   &amp;<a name='1677'>
          pqu,      plu,      puu,     pvu,      pmfus, &amp;<a name='1678'>
          pmfuq,    pmful,    pdmfup,  zmfuu,    zmfuv)<a name='1679'>
      endif<a name='1680'>
      is=0<a name='1681'>
      do jl=1,klon<a name='1682'>
        zqold(jl)=0.0<a name='1683'>
        is=is+klab(jl,jk+1)<a name='1684'>
        if(klab(jl,jk+1).eq.0) klab(jl,jk)=0<a name='1685'>
        loflag(jl)=klab(jl,jk+1).gt.0<a name='1686'>
        zph(jl)=paph(jl,jk)<a name='1687'>
        if(ktype(jl).eq.3.and.jk.eq.kcbot(jl)) then<a name='1688'>
           zmfmax=(paph(jl,jk)-paph(jl,jk-1))*zcons2<a name='1689'>
           if(pmfub(jl).gt.zmfmax) then<a name='1690'>
              zfac=zmfmax/pmfub(jl)<a name='1691'>
              pmfu(jl,jk+1)=pmfu(jl,jk+1)*zfac<a name='1692'>
              pmfus(jl,jk+1)=pmfus(jl,jk+1)*zfac<a name='1693'>
              pmfuq(jl,jk+1)=pmfuq(jl,jk+1)*zfac<a name='1694'>
              zmfuu(jl)=zmfuu(jl)*zfac<a name='1695'>
              zmfuv(jl)=zmfuv(jl)*zfac<a name='1696'>
              pmfub(jl)=zmfmax<a name='1697'>
           end if<a name='1698'>
        end if<a name='1699'>
      end do<a name='1700'>
<a name='1701'>
      if(is.eq.0) cycle<a name='1702'>
<font color=#447700>!<a name='1703'></font>
<font color=#447700>!*     specify entrainment rates in *cuentr_new*<a name='1704'></font>
<font color=#447700>! -------------------------------------<a name='1705'></font>
      ik=jk<a name='1706'>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUENTR_NEW'>cuentr_new</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUASC_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUENTR_NEW_1"> &amp;<a name='1707'>
         (klon,     klev,     klevp1,   ik,       ptenh,&amp;<a name='1708'>
          paph,     pap,      pgeoh,    klwmin,   ldcum,&amp;<a name='1709'>
          ktype,    kcbot,    kctop0,   zpbase,   pmfu, &amp;<a name='1710'>
          pentr,    zdmfen,   zdmfde,   zodetr,   khmin)<a name='1711'>
<font color=#447700>!<a name='1712'></font>
<font color=#447700>!      do adiabatic ascent for entraining/detraining plume<a name='1713'></font>
<font color=#447700>! -------------------------------------------------------<a name='1714'></font>
<font color=#447700>! do adiabatic ascent for entraining/detraining plume<a name='1715'></font>
<font color=#447700>! the cloud ensemble entrains environmental values<a name='1716'></font>
<font color=#447700>! in turbulent detrainment cloud ensemble values are detrained<a name='1717'></font>
<font color=#447700>! in organized detrainment the dry static energy and<a name='1718'></font>
<font color=#447700>! moisture that are neutral compared to the<a name='1719'></font>
<font color=#447700>! environmental air are detrained<a name='1720'></font>
<font color=#447700>!<a name='1721'></font>
      do jl=1,klon<a name='1722'>
      if(loflag(jl)) then<a name='1723'>
        if(jk.lt.kcbot(jl)) then<a name='1724'>
         zmftest=pmfu(jl,jk+1)+zdmfen(jl)-zdmfde(jl)<a name='1725'>
         zmfmax=min(zmftest,(paph(jl,jk)-paph(jl,jk-1))*zcons2)<a name='1726'>
         zdmfen(jl)=max(zdmfen(jl)-max(zmftest-zmfmax,0.),0.)<a name='1727'>
        end if<a name='1728'>
        zdmfde(jl)=min(zdmfde(jl),0.75*pmfu(jl,jk+1))<a name='1729'>
        pmfu(jl,jk)=pmfu(jl,jk+1)+zdmfen(jl)-zdmfde(jl)<a name='1730'>
        if (jk.lt.kcbot(jl)) then<a name='1731'>
          zdprho = (pgeoh(jl,jk)-pgeoh(jl,jk+1))*zrg<a name='1732'>
          zoentr(jl,jk) = zoentr(jl,jk)*zdprho*pmfu(jl,jk+1)<a name='1733'>
          zmftest = pmfu(jl,jk) + zoentr(jl,jk)-zodetr(jl,jk)<a name='1734'>
          zmfmax = min(zmftest,(paph(jl,jk)-paph(jl,jk-1))*zcons2)<a name='1735'>
          zoentr(jl,jk) = max(zoentr(jl,jk)-max(zmftest-zmfmax,0.),0.)<a name='1736'>
        end if<a name='1737'>
<font color=#447700>!<a name='1738'></font>
<font color=#447700>! limit organized detrainment to not allowing for too deep clouds<a name='1739'></font>
<font color=#447700>!<a name='1740'></font>
        if (ktype(jl).eq.1.and.jk.lt.kcbot(jl).and.jk.le.khmin(jl)) then<a name='1741'>
          zmse = cpd*ptu(jl,jk+1) + alv*pqu(jl,jk+1) + pgeoh(jl,jk+1)<a name='1742'>
          ikt = kctop0(jl)<a name='1743'>
          znevn=(pgeoh(jl,ikt)-pgeoh(jl,jk+1))*(zmse-phhatt(jl,  &amp;<a name='1744'>
               jk+1))*zrg<a name='1745'>
          if (znevn.le.0.) znevn = 1.<a name='1746'>
          zdprho = (pgeoh(jl,jk)-pgeoh(jl,jk+1))*zrg<a name='1747'>
          zodmax = ((phcbase(jl)-zmse)/znevn)*zdprho*pmfu(jl,jk+1)<a name='1748'>
          zodmax = max(zodmax,0.)<a name='1749'>
          zodetr(jl,jk) = min(zodetr(jl,jk),zodmax)<a name='1750'>
        end if<a name='1751'>
        zodetr(jl,jk) = min(zodetr(jl,jk),0.75*pmfu(jl,jk))<a name='1752'>
        pmfu(jl,jk) = pmfu(jl,jk) + zoentr(jl,jk) - zodetr(jl,jk)<a name='1753'>
        zqeen=pqenh(jl,jk+1)*zdmfen(jl)<a name='1754'>
        zqeen=zqeen + pqenh(jl,jk+1)*zoentr(jl,jk)<a name='1755'>
        zseen=(cpd*ptenh(jl,jk+1)+pgeoh(jl,jk+1))*zdmfen(jl)<a name='1756'>
        zseen=zseen+(cpd*ptenh(jl,jk+1)+pgeoh(jl,jk+1))*  &amp;<a name='1757'>
             zoentr(jl,jk)<a name='1758'>
        zscde=(cpd*ptu(jl,jk+1)+pgeoh(jl,jk+1))*zdmfde(jl)<a name='1759'>
<font color=#447700>! find moist static energy that give nonbuoyant air<a name='1760'></font>
        zga = alv*pqsenh(jl,jk+1)/(rv*(ptenh(jl,jk+1)**2))<a name='1761'>
        zdt = (plu(jl,jk+1)-0.608*(pqsenh(jl,jk+1)-pqenh(jl, &amp;<a name='1762'>
               jk+1)))/(1./ptenh(jl,jk+1)+0.608*zga)<a name='1763'>
        zscod = cpd*ptenh(jl,jk+1) + pgeoh(jl,jk+1) + cpd*zdt<a name='1764'>
        zscde = zscde + zodetr(jl,jk)*zscod<a name='1765'>
        zqude = pqu(jl,jk+1)*zdmfde(jl)<a name='1766'>
        zqcod = pqsenh(jl,jk+1) + zga*zdt<a name='1767'>
        zqude = zqude + zodetr(jl,jk)*zqcod<a name='1768'>
        plude(jl,jk) = plu(jl,jk+1)*zdmfde(jl)<a name='1769'>
        plude(jl,jk) = plude(jl,jk)+plu(jl,jk+1)*zodetr(jl,jk)<a name='1770'>
        zmfusk = pmfus(jl,jk+1) + zseen - zscde<a name='1771'>
        zmfuqk = pmfuq(jl,jk+1) + zqeen - zqude<a name='1772'>
        zmfulk = pmful(jl,jk+1) - plude(jl,jk)<a name='1773'>
        plu(jl,jk) = zmfulk*(1./max(cmfcmin,pmfu(jl,jk)))<a name='1774'>
        pqu(jl,jk) = zmfuqk*(1./max(cmfcmin,pmfu(jl,jk)))<a name='1775'>
        ptu(jl,jk)=(zmfusk*(1./max(cmfcmin,pmfu(jl,jk)))-  &amp;<a name='1776'>
            pgeoh(jl,jk))*rcpd<a name='1777'>
        ptu(jl,jk) = max(100.,ptu(jl,jk))<a name='1778'>
        ptu(jl,jk) = min(400.,ptu(jl,jk))<a name='1779'>
        zqold(jl) = pqu(jl,jk)<a name='1780'>
      end if<a name='1781'>
      end do<a name='1782'>
<font color=#447700>!*             do corrections for moist ascent<a name='1783'></font>
<font color=#447700>!*             by adjusting t,q and l in *cuadjtq*<a name='1784'></font>
<font color=#447700>!------------------------------------------------<a name='1785'></font>
      ik=jk<a name='1786'>
      icall=1<a name='1787'>
<font color=#447700>!<a name='1788'></font>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ'>cuadjtq</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUASC_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUADJTQ_3">(klon,klev,ik,zph,ptu,pqu,loflag,icall)<a name='1789'>
<font color=#447700>!<a name='1790'></font>
      do jl=1,klon<a name='1791'>
      if(loflag(jl).and.pqu(jl,jk).ne.zqold(jl)) then<a name='1792'>
         klab(jl,jk)=2<a name='1793'>
         plu(jl,jk)=plu(jl,jk)+zqold(jl)-pqu(jl,jk)<a name='1794'>
         zbuo=ptu(jl,jk)*(1.+vtmpc1*pqu(jl,jk)-plu(jl,jk))-  &amp;<a name='1795'>
        ptenh(jl,jk)*(1.+vtmpc1*pqenh(jl,jk))<a name='1796'>
         if(klab(jl,jk+1).eq.1) zbuo=zbuo+zbuo0<a name='1797'>
         if(zbuo.gt.0..and.pmfu(jl,jk).gt.0.01*pmfub(jl).and. &amp;<a name='1798'>
                            jk.ge.kctop0(jl)) then<a name='1799'>
            kctop(jl)=jk<a name='1800'>
            ldcum(jl)=.true.<a name='1801'>
            if(zpbase(jl)-paph(jl,jk).ge.zdnoprc) then<a name='1802'>
               zprcon=cprcon<a name='1803'>
            else<a name='1804'>
               zprcon=0.<a name='1805'>
            endif<a name='1806'>
            zlnew=plu(jl,jk)/(1.+zprcon*(pgeoh(jl,jk)-pgeoh(jl,jk+1)))<a name='1807'>
            pdmfup(jl,jk)=max(0.,(plu(jl,jk)-zlnew)*pmfu(jl,jk))<a name='1808'>
            plu(jl,jk)=zlnew<a name='1809'>
         else<a name='1810'>
            klab(jl,jk)=0<a name='1811'>
            pmfu(jl,jk)=0.<a name='1812'>
         end if<a name='1813'>
      end if<a name='1814'>
      if(loflag(jl)) then<a name='1815'>
         pmful(jl,jk)=plu(jl,jk)*pmfu(jl,jk)<a name='1816'>
         pmfus(jl,jk)=(cpd*ptu(jl,jk)+pgeoh(jl,jk))*pmfu(jl,jk)<a name='1817'>
         pmfuq(jl,jk)=pqu(jl,jk)*pmfu(jl,jk)<a name='1818'>
      end if<a name='1819'>
     end do<a name='1820'>
<font color=#447700>!<a name='1821'></font>
      if(lmfdudv) then<a name='1822'>
<font color=#447700>!<a name='1823'></font>
        do jl=1,klon<a name='1824'>
        zdmfen(jl) = zdmfen(jl) + zoentr(jl,jk)<a name='1825'>
        zdmfde(jl) = zdmfde(jl) + zodetr(jl,jk)<a name='1826'>
           if(loflag(jl)) then<a name='1827'>
              if(ktype(jl).eq.1.or.ktype(jl).eq.3) then<a name='1828'>
                 if(zdmfen(jl).le.1.e-20) then<a name='1829'>
                    zz=3.<a name='1830'>
                 else<a name='1831'>
                    zz=2.<a name='1832'>
                 endif<a name='1833'>
              else<a name='1834'>
                 if(zdmfen(jl).le.1.0e-20) then<a name='1835'>
                    zz=1.<a name='1836'>
                 else<a name='1837'>
                    zz=0.<a name='1838'>
                 endif<a name='1839'>
              end if<a name='1840'>
              zdmfeu=zdmfen(jl)+zz*zdmfde(jl)<a name='1841'>
              zdmfdu=zdmfde(jl)+zz*zdmfde(jl)<a name='1842'>
              zdmfdu=min(zdmfdu,0.75*pmfu(jl,jk+1))<a name='1843'>
              zmfuu(jl)=zmfuu(jl)+                              &amp;<a name='1844'>
                       zdmfeu*puen(jl,jk)-zdmfdu*puu(jl,jk+1)   <a name='1845'>
              zmfuv(jl)=zmfuv(jl)+                              &amp;<a name='1846'>
                       zdmfeu*pven(jl,jk)-zdmfdu*pvu(jl,jk+1)   <a name='1847'>
              if(pmfu(jl,jk).gt.0.) then<a name='1848'>
                 puu(jl,jk)=zmfuu(jl)*(1./pmfu(jl,jk))<a name='1849'>
                 pvu(jl,jk)=zmfuv(jl)*(1./pmfu(jl,jk))<a name='1850'>
              end if<a name='1851'>
           end if<a name='1852'>
        end do<a name='1853'>
<font color=#447700>!<a name='1854'></font>
        end if<a name='1855'>
<font color=#447700>!<a name='1856'></font>
<font color=#447700>! compute organized entrainment<a name='1857'></font>
<font color=#447700>! for use at next level<a name='1858'></font>
<font color=#447700>!<a name='1859'></font>
      do jl = 1, klon<a name='1860'>
       if (loflag(jl).and.ktype(jl).eq.1) then<a name='1861'>
        zbuoyz=g*((ptu(jl,jk)-ptenh(jl,jk))/ptenh(jl,jk)+  &amp;<a name='1862'>
              0.608*(pqu(jl,jk)-pqenh(jl,jk))-plu(jl,jk))<a name='1863'>
        zbuoyz = max(zbuoyz,0.0)<a name='1864'>
        zdz = (pgeo(jl,jk-1)-pgeo(jl,jk))*zrg<a name='1865'>
        zdrodz = -log(pten(jl,jk-1)/pten(jl,jk))/zdz -  &amp;<a name='1866'>
                 g/(rd*ptenh(jl,jk))<a name='1867'>
        zbuoy(jl) = zbuoy(jl) + zbuoyz*zdz<a name='1868'>
        zoentr(jl,jk-1) = zbuoyz*0.5/(1.+zbuoy(jl))+zdrodz<a name='1869'>
        zoentr(jl,jk-1) = min(zoentr(jl,jk-1),1.e-3)<a name='1870'>
        zoentr(jl,jk-1) = max(zoentr(jl,jk-1),0.)<a name='1871'>
       end if<a name='1872'>
      end do<a name='1873'>
<font color=#447700>!<a name='1874'></font>
    end do <font color=#447700>! end outer cycle<a name='1875'></font>
<font color=#447700>! -----------------------------------------------------------------<a name='1876'></font>
<font color=#447700>!     5.       determine convective fluxes above non-buoyancy level<a name='1877'></font>
<font color=#447700>! -----------------------------------------------------------------<a name='1878'></font>
<font color=#447700>!                  (note: cloud variables like t,q and l are not<a name='1879'></font>
<font color=#447700>!                         affected by detrainment and are already known<a name='1880'></font>
<font color=#447700>!                         from previous calculations above)<a name='1881'></font>
      do jl=1,klon<a name='1882'>
      if(kctop(jl).eq.klevm1) ldcum(jl)=.false.<a name='1883'>
      kcbot(jl)=max(kcbot(jl),kctop(jl))<a name='1884'>
      end do<a name='1885'>
<a name='1886'>
      is=0<a name='1887'>
      do jl=1,klon<a name='1888'>
      if(ldcum(jl)) then<a name='1889'>
         is=is+1<a name='1890'>
      endif<a name='1891'>
      end do<a name='1892'>
      kcum=is<a name='1893'>
      if(is.eq.0) return<a name='1894'>
      do jl=1,klon<a name='1895'>
      if(ldcum(jl)) then<a name='1896'>
         jk=kctop(jl)-1<a name='1897'>
         zzdmf=cmfctop<a name='1898'>
         zdmfde(jl)=(1.-zzdmf)*pmfu(jl,jk+1)<a name='1899'>
         plude(jl,jk)=zdmfde(jl)*plu(jl,jk+1)<a name='1900'>
         pmfu(jl,jk)=pmfu(jl,jk+1)-zdmfde(jl)<a name='1901'>
         pmfus(jl,jk)=(cpd*ptu(jl,jk)+pgeoh(jl,jk))*pmfu(jl,jk)<a name='1902'>
         pmfuq(jl,jk)=pqu(jl,jk)*pmfu(jl,jk)<a name='1903'>
         pmful(jl,jk)=plu(jl,jk)*pmfu(jl,jk)<a name='1904'>
         plude(jl,jk-1)=pmful(jl,jk)<a name='1905'>
         pdmfup(jl,jk)=0.<a name='1906'>
      end if<a name='1907'>
      end do<a name='1908'>
<a name='1909'>
      if(lmfdudv) then<a name='1910'>
         do jl=1,klon<a name='1911'>
         if(ldcum(jl)) then<a name='1912'>
            jk=kctop(jl)-1<a name='1913'>
            puu(jl,jk)=puu(jl,jk+1)<a name='1914'>
            pvu(jl,jk)=pvu(jl,jk+1)<a name='1915'>
         end if<a name='1916'>
         end do<a name='1917'>
      end if<a name='1918'>
      return<a name='1919'>
      end subroutine cuasc_new<a name='1920'>
<font color=#447700>!<a name='1921'></font>
<a name='1922'>
<font color=#447700>!**********************************************<a name='1923'></font>
<font color=#447700>!       subroutine cudlfs<a name='1924'></font>
<font color=#447700>!********************************************** <a name='1925'></font>
<A NAME='CUDLFS'><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUDLFS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1926'>
      <font color=#993300>subroutine </font><font color=#cc0000>cudlfs</font> &amp; <A href='../../call_to/CUDLFS.html' TARGET='index'>1</A>,<A href='../../call_from/CUDLFS.html' TARGET='index'>1</A><a name='1927'>
         (klon,     klev,     klevp1,   ptenh,    pqenh,  &amp;<a name='1928'>
          puen,     pven,     pgeoh,    paph,     ptu,    &amp;<a name='1929'>
          pqu,      puu,      pvu,      ldcum,    kcbot,  &amp;<a name='1930'>
          kctop,    pmfub,    prfl,     ptd,      pqd,    &amp;<a name='1931'>
          pud,      pvd,      pmfd,     pmfds,    pmfdq,  &amp;<a name='1932'>
          pdmfdp,   kdtop,    lddraf)<a name='1933'>
<font color=#447700>!      this routine calculates level of free sinking for<a name='1934'></font>
<font color=#447700>!      cumulus downdrafts and specifies t,q,u and v values<a name='1935'></font>
<font color=#447700>!      m.tiedtke         e.c.m.w.f.    12/86 modif.  12/89<a name='1936'></font>
<font color=#447700>!***purpose.<a name='1937'></font>
<font color=#447700>!   --------<a name='1938'></font>
<font color=#447700>!          to produce lfs-values for cumulus downdrafts<a name='1939'></font>
<font color=#447700>!          for massflux cumulus parameterization<a name='1940'></font>
<font color=#447700>!***interface<a name='1941'></font>
<font color=#447700>!   ---------<a name='1942'></font>
<font color=#447700>!          this routine is called from *cumastr*.<a name='1943'></font>
<font color=#447700>!          input are environmental values of t,q,u,v,p,phi<a name='1944'></font>
<font color=#447700>!          and updraft values t,q,u and v and also<a name='1945'></font>
<font color=#447700>!          cloud base massflux and cu-precipitation rate.<a name='1946'></font>
<font color=#447700>!          it returns t,q,u and v values and massflux at lfs.<a name='1947'></font>
<font color=#447700>!***method.<a name='1948'></font>
<font color=#447700>!  --------<a name='1949'></font>
<font color=#447700>!          check for negative buoyancy of air of equal parts of<a name='1950'></font>
<font color=#447700>!          moist environmental air and cloud air.<a name='1951'></font>
<font color=#447700>!***externals<a name='1952'></font>
<font color=#447700>!   ---------<a name='1953'></font>
<font color=#447700>!          *cuadjtq* for calculating wet bulb t and q at lfs<a name='1954'></font>
<font color=#447700>! ----------------------------------------------------------------<a name='1955'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='1956'></font>
      implicit none<a name='1957'>
<font color=#447700>!-------------------------------------------------------------------<a name='1958'></font>
      integer   klon, klev, klevp1<a name='1959'>
      integer   jl,ke,jk,is,ik,icall<a name='1960'>
      real      zttest, zqtest, zbuo, zmftop<a name='1961'>
      real     ptenh(klon,klev),       pqenh(klon,klev),   &amp;<a name='1962'>
              puen(klon,klev),        pven(klon,klev),     &amp;<a name='1963'>
              pgeoh(klon,klev),       paph(klon,klevp1),   &amp;<a name='1964'>
              ptu(klon,klev),         pqu(klon,klev),      &amp;<a name='1965'>
              puu(klon,klev),         pvu(klon,klev),      &amp;<a name='1966'>
              pmfub(klon),            prfl(klon)<a name='1967'>
      real     ptd(klon,klev),         pqd(klon,klev),     &amp;<a name='1968'>
              pud(klon,klev),         pvd(klon,klev),      &amp;<a name='1969'>
              pmfd(klon,klev),        pmfds(klon,klev),    &amp;<a name='1970'>
              pmfdq(klon,klev),       pdmfdp(klon,klev)    <a name='1971'>
      real     ztenwb(klon,klev),      zqenwb(klon,klev),  &amp;<a name='1972'>
              zcond(klon),            zph(klon)<a name='1973'>
      integer  kcbot(klon),            kctop(klon),        &amp;<a name='1974'>
              kdtop(klon)<a name='1975'>
      logical  ldcum(klon),            llo2(klon),         &amp;<a name='1976'>
              lddraf(klon)<a name='1977'>
<font color=#447700>!-----------------------------------------------<a name='1978'></font>
<font color=#447700>!     1.       set default values for downdrafts<a name='1979'></font>
<font color=#447700>!-----------------------------------------------<a name='1980'></font>
      do jl=1,klon<a name='1981'>
      lddraf(jl)=.false.<a name='1982'>
      kdtop(jl)=klevp1<a name='1983'>
      end do<a name='1984'>
      if(.not.lmfdd) return<a name='1985'>
<font color=#447700>!------------------------------------------------------------<a name='1986'></font>
<font color=#447700>!     2.       determine level of free sinking by<a name='1987'></font>
<font color=#447700>!              doing a scan from top to base of cumulus clouds<a name='1988'></font>
<font color=#447700>!              for every point and proceed as follows:<a name='1989'></font>
<font color=#447700>!                (1) detemine wet bulb environmental t and q<a name='1990'></font>
<font color=#447700>!                (2) do mixing with cumulus cloud air<a name='1991'></font>
<font color=#447700>!                (3) check for negative buoyancy<a name='1992'></font>
<font color=#447700>!              the assumption is that air of downdrafts is mixture<a name='1993'></font>
<font color=#447700>!              of 50% cloud air + 50% environmental air at wet bulb<a name='1994'></font>
<font color=#447700>!              temperature (i.e. which became saturated due to<a name='1995'></font>
<font color=#447700>!              evaporation of rain and cloud water)<a name='1996'></font>
<font color=#447700>!------------------------------------------------------------------<a name='1997'></font>
      ke=klev-3<a name='1998'>
      do jk=3,ke<a name='1999'>
<font color=#447700>!   2.1      calculate wet-bulb temperature and moisture<a name='2000'></font>
<font color=#447700>!            for environmental air in *cuadjtq*<a name='2001'></font>
<font color=#447700>! -----------------------------------------------------<a name='2002'></font>
      is=0<a name='2003'>
      do jl=1,klon<a name='2004'>
      ztenwb(jl,jk)=ptenh(jl,jk)<a name='2005'>
      zqenwb(jl,jk)=pqenh(jl,jk)<a name='2006'>
      zph(jl)=paph(jl,jk)<a name='2007'>
      llo2(jl)=ldcum(jl).and.prfl(jl).gt.0..and..not.lddraf(jl).and. &amp;<a name='2008'>
              (jk.lt.kcbot(jl).and.jk.gt.kctop(jl))<a name='2009'>
      if(llo2(jl))then<a name='2010'>
         is=is+1<a name='2011'>
      endif<a name='2012'>
      end do<a name='2013'>
<a name='2014'>
      if(is.eq.0) cycle<a name='2015'>
      ik=jk<a name='2016'>
      icall=2<a name='2017'>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ'>cuadjtq</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUDLFS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUADJTQ_4">(klon,klev,ik,zph,ztenwb,zqenwb,llo2,icall)<a name='2018'>
<font color=#447700>!   2.2      do mixing of cumulus and environmental air<a name='2019'></font>
<font color=#447700>!            and check for negative buoyancy.<a name='2020'></font>
<font color=#447700>!            then set values for downdraft at lfs.<a name='2021'></font>
<font color=#447700>! -----------------------------------------------------<a name='2022'></font>
      do jl=1,klon<a name='2023'>
      if(llo2(jl)) then<a name='2024'>
         zttest=0.5*(ptu(jl,jk)+ztenwb(jl,jk))<a name='2025'>
         zqtest=0.5*(pqu(jl,jk)+zqenwb(jl,jk))<a name='2026'>
         zbuo=zttest*(1.+vtmpc1*zqtest)-  &amp;<a name='2027'>
             ptenh(jl,jk)*(1.+vtmpc1*pqenh(jl,jk))<a name='2028'>
         zcond(jl)=pqenh(jl,jk)-zqenwb(jl,jk)<a name='2029'>
         zmftop=-cmfdeps*pmfub(jl)<a name='2030'>
         if(zbuo.lt.0..and.prfl(jl).gt.10.*zmftop*zcond(jl)) then<a name='2031'>
            kdtop(jl)=jk<a name='2032'>
            lddraf(jl)=.true.<a name='2033'>
            ptd(jl,jk)=zttest<a name='2034'>
            pqd(jl,jk)=zqtest<a name='2035'>
            pmfd(jl,jk)=zmftop<a name='2036'>
            pmfds(jl,jk)=pmfd(jl,jk)*(cpd*ptd(jl,jk)+pgeoh(jl,jk))<a name='2037'>
            pmfdq(jl,jk)=pmfd(jl,jk)*pqd(jl,jk)<a name='2038'>
            pdmfdp(jl,jk-1)=-0.5*pmfd(jl,jk)*zcond(jl)<a name='2039'>
            prfl(jl)=prfl(jl)+pdmfdp(jl,jk-1)<a name='2040'>
         end if<a name='2041'>
      end if<a name='2042'>
      end do<a name='2043'>
<a name='2044'>
      if(lmfdudv) then<a name='2045'>
          do jl=1,klon<a name='2046'>
          if(pmfd(jl,jk).lt.0.) then<a name='2047'>
             pud(jl,jk)=0.5*(puu(jl,jk)+puen(jl,jk-1))<a name='2048'>
             pvd(jl,jk)=0.5*(pvu(jl,jk)+pven(jl,jk-1))<a name='2049'>
          end if<a name='2050'>
          end do<a name='2051'>
      end if<a name='2052'>
  <a name='2053'>
      end do<a name='2054'>
      return<a name='2055'>
      end subroutine cudlfs<a name='2056'>
<font color=#447700>!<a name='2057'></font>
<a name='2058'>
<font color=#447700>!**********************************************<a name='2059'></font>
<font color=#447700>!       subroutine cuddraf<a name='2060'></font>
<font color=#447700>!********************************************** <a name='2061'></font>
<A NAME='CUDDRAF'><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUDDRAF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2062'>
      <font color=#993300>subroutine </font><font color=#cc0000>cuddraf</font> &amp; <A href='../../call_to/CUDDRAF.html' TARGET='index'>1</A>,<A href='../../call_from/CUDDRAF.html' TARGET='index'>1</A><a name='2063'>
         (klon,     klev,     klevp1,   ptenh,    pqenh, &amp;<a name='2064'>
          puen,     pven,     pgeoh,    paph,     prfl,  &amp;<a name='2065'>
          lddraf,   ptd,      pqd,      pud,      pvd,   &amp;<a name='2066'>
          pmfd,     pmfds,    pmfdq,    pdmfdp)<a name='2067'>
<font color=#447700>!     this routine calculates cumulus downdraft descent<a name='2068'></font>
<font color=#447700>!     m.tiedtke         e.c.m.w.f.    12/86 modif.  12/89<a name='2069'></font>
<font color=#447700>!***purpose.<a name='2070'></font>
<font color=#447700>!   --------<a name='2071'></font>
<font color=#447700>!          to produce the vertical profiles for cumulus downdrafts<a name='2072'></font>
<font color=#447700>!          (i.e. t,q,u and v and fluxes)<a name='2073'></font>
<font color=#447700>!***interface<a name='2074'></font>
<font color=#447700>!   ---------<a name='2075'></font>
<font color=#447700>!          this routine is called from *cumastr*.<a name='2076'></font>
<font color=#447700>!          input is t,q,p,phi,u,v at half levels.<a name='2077'></font>
<font color=#447700>!          it returns fluxes of s,q and evaporation rate<a name='2078'></font>
<font color=#447700>!          and u,v at levels where downdraft occurs<a name='2079'></font>
<font color=#447700>!***method.<a name='2080'></font>
<font color=#447700>!  --------<a name='2081'></font>
<font color=#447700>!          calculate moist descent for entraining/detraining plume by<a name='2082'></font>
<font color=#447700>!          a) moving air dry-adiabatically to next level below and<a name='2083'></font>
<font color=#447700>!          b) correcting for evaporation to obtain saturated state.<a name='2084'></font>
<font color=#447700>!***externals<a name='2085'></font>
<font color=#447700>!   ---------<a name='2086'></font>
<font color=#447700>!          *cuadjtq* for adjusting t and q due to evaporation in<a name='2087'></font>
<font color=#447700>!          saturated descent<a name='2088'></font>
<font color=#447700>!***reference<a name='2089'></font>
<font color=#447700>!   ---------<a name='2090'></font>
<font color=#447700>!          (tiedtke,1989)<a name='2091'></font>
<font color=#447700>! ----------------------------------------------------------------<a name='2092'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='2093'></font>
      implicit none<a name='2094'>
<font color=#447700>!-------------------------------------------------------------------<a name='2095'></font>
      integer   klon, klev, klevp1<a name='2096'>
      integer   jk,is,jl,itopde, ik, icall<a name='2097'>
      real      zentr,zseen, zqeen, zsdde, zqdde,zmfdsk, zmfdqk<a name='2098'>
      real      zbuo, zdmfdp, zmfduk, zmfdvk<a name='2099'>
      real     ptenh(klon,klev),       pqenh(klon,klev),  &amp;<a name='2100'>
              puen(klon,klev),        pven(klon,klev),    &amp;<a name='2101'>
              pgeoh(klon,klev),       paph(klon,klevp1) <a name='2102'>
      real     ptd(klon,klev),         pqd(klon,klev),    &amp;<a name='2103'>
              pud(klon,klev),         pvd(klon,klev),     &amp;<a name='2104'>
              pmfd(klon,klev),        pmfds(klon,klev),   &amp;<a name='2105'>
              pmfdq(klon,klev),       pdmfdp(klon,klev),  &amp;<a name='2106'>
              prfl(klon)<a name='2107'>
      real     zdmfen(klon),           zdmfde(klon),      &amp;<a name='2108'>
              zcond(klon),            zph(klon)       <a name='2109'>
      logical  lddraf(klon),           llo2(klon)<a name='2110'>
<font color=#447700>!--------------------------------------------------------------<a name='2111'></font>
<font color=#447700>!     1.       calculate moist descent for cumulus downdraft by<a name='2112'></font>
<font color=#447700>!                (a) calculating entrainment rates, assuming<a name='2113'></font>
<font color=#447700>!                     linear decrease of massflux in pbl<a name='2114'></font>
<font color=#447700>!                 (b) doing moist descent - evaporative cooling<a name='2115'></font>
<font color=#447700>!                     and moistening is calculated in *cuadjtq*<a name='2116'></font>
<font color=#447700>!                 (c) checking for negative buoyancy and<a name='2117'></font>
<font color=#447700>!                     specifying final t,q,u,v and downward fluxes<a name='2118'></font>
<font color=#447700>! ----------------------------------------------------------------<a name='2119'></font>
      do jk=3,klev<a name='2120'>
      is=0<a name='2121'>
      do jl=1,klon<a name='2122'>
      zph(jl)=paph(jl,jk)<a name='2123'>
      llo2(jl)=lddraf(jl).and.pmfd(jl,jk-1).lt.0.<a name='2124'>
      if(llo2(jl)) then<a name='2125'>
         is=is+1<a name='2126'>
      endif<a name='2127'>
      end do<a name='2128'>
<a name='2129'>
      if(is.eq.0) cycle<a name='2130'>
      do jl=1,klon<a name='2131'>
      if(llo2(jl)) then<a name='2132'>
         zentr=entrdd*pmfd(jl,jk-1)*rd*ptenh(jl,jk-1)/   &amp;<a name='2133'>
              (g*paph(jl,jk-1))*(paph(jl,jk)-paph(jl,jk-1))<a name='2134'>
         zdmfen(jl)=zentr<a name='2135'>
         zdmfde(jl)=zentr<a name='2136'>
      end if<a name='2137'>
      end do<a name='2138'>
<a name='2139'>
      itopde=klev-2<a name='2140'>
      if(jk.gt.itopde) then<a name='2141'>
         do jl=1,klon<a name='2142'>
         if(llo2(jl)) then<a name='2143'>
            zdmfen(jl)=0.<a name='2144'>
            zdmfde(jl)=pmfd(jl,itopde)*      &amp;<a name='2145'>
            (paph(jl,jk)-paph(jl,jk-1))/     &amp;<a name='2146'>
            (paph(jl,klevp1)-paph(jl,itopde))<a name='2147'>
         end if<a name='2148'>
         end do<a name='2149'>
      end if<a name='2150'>
<a name='2151'>
      do jl=1,klon<a name='2152'>
         if(llo2(jl)) then<a name='2153'>
            pmfd(jl,jk)=pmfd(jl,jk-1)+zdmfen(jl)-zdmfde(jl)<a name='2154'>
            zseen=(cpd*ptenh(jl,jk-1)+pgeoh(jl,jk-1))*zdmfen(jl)<a name='2155'>
            zqeen=pqenh(jl,jk-1)*zdmfen(jl)<a name='2156'>
            zsdde=(cpd*ptd(jl,jk-1)+pgeoh(jl,jk-1))*zdmfde(jl)<a name='2157'>
            zqdde=pqd(jl,jk-1)*zdmfde(jl)<a name='2158'>
            zmfdsk=pmfds(jl,jk-1)+zseen-zsdde<a name='2159'>
            zmfdqk=pmfdq(jl,jk-1)+zqeen-zqdde<a name='2160'>
            pqd(jl,jk)=zmfdqk*(1./min(-cmfcmin,pmfd(jl,jk)))<a name='2161'>
            ptd(jl,jk)=(zmfdsk*(1./min(-cmfcmin,pmfd(jl,jk)))- &amp;<a name='2162'>
                       pgeoh(jl,jk))*rcpd<a name='2163'>
            ptd(jl,jk)=min(400.,ptd(jl,jk))<a name='2164'>
            ptd(jl,jk)=max(100.,ptd(jl,jk))<a name='2165'>
            zcond(jl)=pqd(jl,jk)<a name='2166'>
         end if<a name='2167'>
      end do<a name='2168'>
<a name='2169'>
      ik=jk<a name='2170'>
      icall=2<a name='2171'>
      call <A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ'>cuadjtq</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUDDRAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUADJTQ_5">(klon,klev,ik,zph,ptd,pqd,llo2,icall)<a name='2172'>
      do jl=1,klon<a name='2173'>
         if(llo2(jl)) then<a name='2174'>
            zcond(jl)=zcond(jl)-pqd(jl,jk)<a name='2175'>
            zbuo=ptd(jl,jk)*(1.+vtmpc1*pqd(jl,jk))- &amp;<a name='2176'>
           ptenh(jl,jk)*(1.+vtmpc1*pqenh(jl,jk))<a name='2177'>
            if(zbuo.ge.0..or.prfl(jl).le.(pmfd(jl,jk)*zcond(jl))) then<a name='2178'>
               pmfd(jl,jk)=0.<a name='2179'>
            endif<a name='2180'>
            pmfds(jl,jk)=(cpd*ptd(jl,jk)+pgeoh(jl,jk))*pmfd(jl,jk)<a name='2181'>
            pmfdq(jl,jk)=pqd(jl,jk)*pmfd(jl,jk)<a name='2182'>
            zdmfdp=-pmfd(jl,jk)*zcond(jl)<a name='2183'>
            pdmfdp(jl,jk-1)=zdmfdp<a name='2184'>
            prfl(jl)=prfl(jl)+zdmfdp<a name='2185'>
         end if<a name='2186'>
      end do<a name='2187'>
<a name='2188'>
      if(lmfdudv) then<a name='2189'>
          do jl=1,klon<a name='2190'>
             if(llo2(jl).and.pmfd(jl,jk).lt.0.) then<a name='2191'>
                zmfduk=pmfd(jl,jk-1)*pud(jl,jk-1)+   &amp;<a name='2192'>
               zdmfen(jl)*puen(jl,jk-1)-zdmfde(jl)*pud(jl,jk-1)<a name='2193'>
                zmfdvk=pmfd(jl,jk-1)*pvd(jl,jk-1)+   &amp;<a name='2194'>
               zdmfen(jl)*pven(jl,jk-1)-zdmfde(jl)*pvd(jl,jk-1)<a name='2195'>
                pud(jl,jk)=zmfduk*(1./min(-cmfcmin,pmfd(jl,jk)))<a name='2196'>
                pvd(jl,jk)=zmfdvk*(1./min(-cmfcmin,pmfd(jl,jk)))<a name='2197'>
             end if<a name='2198'>
          end do<a name='2199'>
       end if<a name='2200'>
<a name='2201'>
      end do<a name='2202'>
      return<a name='2203'>
      end subroutine cuddraf<a name='2204'>
<font color=#447700>!<a name='2205'></font>
<a name='2206'>
<font color=#447700>!**********************************************<a name='2207'></font>
<font color=#447700>!       subroutine cuflx<a name='2208'></font>
<font color=#447700>!********************************************** <a name='2209'></font>
<A NAME='CUFLX'><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2210'>
      <font color=#993300>subroutine </font><font color=#cc0000>cuflx</font> &amp; <A href='../../call_to/CUFLX.html' TARGET='index'>1</A><a name='2211'>
         (klon,     klev,     klevp1,   pqen,    pqsen,     &amp;<a name='2212'>
          ptenh,    pqenh,    paph,     pgeoh,   kcbot,    &amp;<a name='2213'>
          kctop,    kdtop,    ktype,    lddraf,  ldcum,  &amp;<a name='2214'>
          pmfu,     pmfd,     pmfus,    pmfds,   pmfuq,  &amp;<a name='2215'>
          pmfdq,    pmful,    plude,    pdmfup,  pdmfdp, &amp;<a name='2216'>
          prfl,     prain,    pten,     psfl,    pdpmel, &amp;<a name='2217'>
          ktopm2,   ztmst,    sig1)<a name='2218'>
<font color=#447700>!      m.tiedtke         e.c.m.w.f.     7/86 modif.  12/89<a name='2219'></font>
<font color=#447700>!***purpose<a name='2220'></font>
<font color=#447700>!   -------<a name='2221'></font>
<font color=#447700>!          this routine does the final calculation of convective<a name='2222'></font>
<font color=#447700>!          fluxes in the cloud layer and in the subcloud layer<a name='2223'></font>
<font color=#447700>!***interface<a name='2224'></font>
<font color=#447700>!   ---------<a name='2225'></font>
<font color=#447700>!          this routine is called from *cumastr*.<a name='2226'></font>
<font color=#447700>!***externals<a name='2227'></font>
<font color=#447700>!   ---------<a name='2228'></font>
<font color=#447700>!          none<a name='2229'></font>
<font color=#447700>! ----------------------------------------------------------------<a name='2230'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='2231'></font>
      implicit none<a name='2232'>
<font color=#447700>!-------------------------------------------------------------------<a name='2233'></font>
      integer   klon, klev, klevp1<a name='2234'>
      integer   ktopm2, itop, jl, jk, ikb<a name='2235'>
      real      ztmst, zcons1, zcons2, zcucov, ztmelp2<a name='2236'>
      real      zzp, zfac, zsnmlt, zrfl, cevapcu, zrnew<a name='2237'>
      real      zrmin, zrfln, zdrfl, zdpevap<a name='2238'>
      real     pqen(klon,klev),        pqsen(klon,klev),  &amp;<a name='2239'>
              ptenh(klon,klev),       pqenh(klon,klev),   &amp;<a name='2240'>
              paph(klon,klevp1),      pgeoh(klon,klev)    <a name='2241'>
      real     pmfu(klon,klev),        pmfd(klon,klev),   &amp;<a name='2242'>
              pmfus(klon,klev),       pmfds(klon,klev),   &amp;<a name='2243'>
              pmfuq(klon,klev),       pmfdq(klon,klev),   &amp;<a name='2244'>
              pdmfup(klon,klev),      pdmfdp(klon,klev),  &amp;<a name='2245'>
              pmful(klon,klev),       plude(klon,klev),   &amp;<a name='2246'>
              prfl(klon),             prain(klon)<a name='2247'>
      real     pten(klon,klev),        pdpmel(klon,klev), &amp;<a name='2248'>
              psfl(klon),             zpsubcl(klon)<a name='2249'>
      real     sig1(klev)<a name='2250'>
      integer  kcbot(klon),            kctop(klon),     &amp;<a name='2251'>
              kdtop(klon),            ktype(klon)<a name='2252'>
      logical  lddraf(klon),           ldcum(klon)<a name='2253'>
<font color=#447700>!*       specify constants<a name='2254'></font>
      zcons1=cpd/(alf*g*ztmst)<a name='2255'>
      zcons2=1./(g*ztmst)<a name='2256'>
      zcucov=0.05<a name='2257'>
      ztmelp2=tmelt+2.<a name='2258'>
<font color=#447700>!*  1.0      determine final convective fluxes<a name='2259'></font>
<font color=#447700>!---------------------------------------------<a name='2260'></font>
      itop=klev<a name='2261'>
      do jl=1,klon<a name='2262'>
      prfl(jl)=0.<a name='2263'>
      psfl(jl)=0.<a name='2264'>
      prain(jl)=0.<a name='2265'>
<font color=#447700>!     switch off shallow convection<a name='2266'></font>
      if(.not.lmfscv.and.ktype(jl).eq.2)then<a name='2267'>
        ldcum(jl)=.false.<a name='2268'>
        lddraf(jl)=.false.<a name='2269'>
      endif<a name='2270'>
      itop=min(itop,kctop(jl))<a name='2271'>
      if(.not.ldcum(jl).or.kdtop(jl).lt.kctop(jl)) lddraf(jl)=.false.<a name='2272'>
      if(.not.ldcum(jl)) ktype(jl)=0<a name='2273'>
      end do<a name='2274'>
<a name='2275'>
      ktopm2=itop-2<a name='2276'>
      do jk=ktopm2,klev<a name='2277'>
      do jl=1,klon<a name='2278'>
      if(ldcum(jl).and.jk.ge.kctop(jl)-1) then<a name='2279'>
         pmfus(jl,jk)=pmfus(jl,jk)-pmfu(jl,jk)*  &amp;<a name='2280'>
                     (cpd*ptenh(jl,jk)+pgeoh(jl,jk))<a name='2281'>
         pmfuq(jl,jk)=pmfuq(jl,jk)-pmfu(jl,jk)*pqenh(jl,jk)<a name='2282'>
         if(lddraf(jl).and.jk.ge.kdtop(jl)) then<a name='2283'>
            pmfds(jl,jk)=pmfds(jl,jk)-pmfd(jl,jk)*  &amp;<a name='2284'>
                        (cpd*ptenh(jl,jk)+pgeoh(jl,jk))<a name='2285'>
            pmfdq(jl,jk)=pmfdq(jl,jk)-pmfd(jl,jk)*pqenh(jl,jk)<a name='2286'>
         else<a name='2287'>
            pmfd(jl,jk)=0.<a name='2288'>
            pmfds(jl,jk)=0.<a name='2289'>
            pmfdq(jl,jk)=0.<a name='2290'>
            pdmfdp(jl,jk-1)=0.<a name='2291'>
         end if<a name='2292'>
      else<a name='2293'>
         pmfu(jl,jk)=0.<a name='2294'>
         pmfd(jl,jk)=0.<a name='2295'>
         pmfus(jl,jk)=0.<a name='2296'>
         pmfds(jl,jk)=0.<a name='2297'>
         pmfuq(jl,jk)=0.<a name='2298'>
         pmfdq(jl,jk)=0.<a name='2299'>
         pmful(jl,jk)=0.<a name='2300'>
         pdmfup(jl,jk-1)=0.<a name='2301'>
         pdmfdp(jl,jk-1)=0.<a name='2302'>
         plude(jl,jk-1)=0.<a name='2303'>
      end if<a name='2304'>
      end do<a name='2305'>
      end do<a name='2306'>
<a name='2307'>
      do jk=ktopm2,klev<a name='2308'>
      do jl=1,klon<a name='2309'>
      if(ldcum(jl).and.jk.gt.kcbot(jl)) then<a name='2310'>
         ikb=kcbot(jl)<a name='2311'>
         zzp=((paph(jl,klevp1)-paph(jl,jk))/  &amp;<a name='2312'>
             (paph(jl,klevp1)-paph(jl,ikb)))<a name='2313'>
         if(ktype(jl).eq.3) then<a name='2314'>
            zzp=zzp**2<a name='2315'>
         endif<a name='2316'>
         pmfu(jl,jk)=pmfu(jl,ikb)*zzp<a name='2317'>
         pmfus(jl,jk)=pmfus(jl,ikb)*zzp<a name='2318'>
         pmfuq(jl,jk)=pmfuq(jl,ikb)*zzp<a name='2319'>
         pmful(jl,jk)=pmful(jl,ikb)*zzp<a name='2320'>
      end if<a name='2321'>
<font color=#447700>!*    2.        calculate rain/snow fall rates<a name='2322'></font>
<font color=#447700>!*              calculate melting of snow<a name='2323'></font>
<font color=#447700>!*              calculate evaporation of precip<a name='2324'></font>
<font color=#447700>!----------------------------------------------<a name='2325'></font>
      if(ldcum(jl)) then<a name='2326'>
         prain(jl)=prain(jl)+pdmfup(jl,jk)<a name='2327'>
         if(pten(jl,jk).gt.tmelt) then<a name='2328'>
            prfl(jl)=prfl(jl)+pdmfup(jl,jk)+pdmfdp(jl,jk)<a name='2329'>
            if(psfl(jl).gt.0..and.pten(jl,jk).gt.ztmelp2) then<a name='2330'>
               zfac=zcons1*(paph(jl,jk+1)-paph(jl,jk))<a name='2331'>
               zsnmlt=min(psfl(jl),zfac*(pten(jl,jk)-ztmelp2))<a name='2332'>
               pdpmel(jl,jk)=zsnmlt<a name='2333'>
               psfl(jl)=psfl(jl)-zsnmlt<a name='2334'>
               prfl(jl)=prfl(jl)+zsnmlt<a name='2335'>
            end if<a name='2336'>
         else<a name='2337'>
            psfl(jl)=psfl(jl)+pdmfup(jl,jk)+pdmfdp(jl,jk)<a name='2338'>
         end if<a name='2339'>
      end if<a name='2340'>
      end do<a name='2341'>
      end do<a name='2342'>
<a name='2343'>
      do jl=1,klon<a name='2344'>
        prfl(jl)=max(prfl(jl),0.)<a name='2345'>
        psfl(jl)=max(psfl(jl),0.)<a name='2346'>
        zpsubcl(jl)=prfl(jl)+psfl(jl)<a name='2347'>
      end do<a name='2348'>
<a name='2349'>
      do jk=ktopm2,klev<a name='2350'>
      do jl=1,klon<a name='2351'>
      if(ldcum(jl).and.jk.ge.kcbot(jl).and. &amp;<a name='2352'>
             zpsubcl(jl).gt.1.e-20) then<a name='2353'>
          zrfl=zpsubcl(jl)<a name='2354'>
          cevapcu=cevapcu1*sqrt(cevapcu2*sqrt(sig1(jk)))<a name='2355'>
          zrnew=(max(0.,sqrt(zrfl/zcucov)-   &amp;<a name='2356'>
                  cevapcu*(paph(jl,jk+1)-paph(jl,jk))* &amp;<a name='2357'>
                max(0.,pqsen(jl,jk)-pqen(jl,jk))))**2*zcucov<a name='2358'>
          zrmin=zrfl-zcucov*max(0.,0.8*pqsen(jl,jk)-pqen(jl,jk)) &amp;<a name='2359'>
               *zcons2*(paph(jl,jk+1)-paph(jl,jk))<a name='2360'>
          zrnew=max(zrnew,zrmin)<a name='2361'>
          zrfln=max(zrnew,0.)<a name='2362'>
          zdrfl=min(0.,zrfln-zrfl)<a name='2363'>
          pdmfup(jl,jk)=pdmfup(jl,jk)+zdrfl<a name='2364'>
          zpsubcl(jl)=zrfln<a name='2365'>
      end if<a name='2366'>
      end do<a name='2367'>
      end do<a name='2368'>
<a name='2369'>
      do jl=1,klon<a name='2370'>
        zdpevap=zpsubcl(jl)-(prfl(jl)+psfl(jl))<a name='2371'>
        prfl(jl)=prfl(jl)+zdpevap*prfl(jl)*  &amp;<a name='2372'>
                  (1./max(1.e-20,prfl(jl)+psfl(jl)))<a name='2373'>
        psfl(jl)=psfl(jl)+zdpevap*psfl(jl)*  &amp;<a name='2374'>
                  (1./max(1.e-20,prfl(jl)+psfl(jl)))<a name='2375'>
      end do<a name='2376'>
<a name='2377'>
      return<a name='2378'>
      end subroutine cuflx<a name='2379'>
<font color=#447700>!<a name='2380'></font>
<a name='2381'>
<font color=#447700>!**********************************************<a name='2382'></font>
<font color=#447700>!       subroutine cudtdq<a name='2383'></font>
<font color=#447700>!********************************************** <a name='2384'></font>
<A NAME='CUDTDQ'><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUDTDQ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2385'>
      <font color=#993300>subroutine </font><font color=#cc0000>cudtdq</font> &amp; <A href='../../call_to/CUDTDQ.html' TARGET='index'>1</A><a name='2386'>
         (klon,     klev,     klevp1,   ktopm2,   paph,   &amp;<a name='2387'>
          ldcum,    pten,     ptte,     pqte,     pmfus,  &amp;<a name='2388'>
          pmfds,    pmfuq,    pmfdq,    pmful,    pdmfup, &amp;<a name='2389'>
          pdmfdp,   ztmst,    pdpmel,   prain,    prfl,   &amp;<a name='2390'>
          psfl,     psrain,   psevap,   psheat,   psmelt, &amp;<a name='2391'>
          prsfc,    pssfc,    paprc,    paprsm,   paprs,  &amp;<a name='2392'>
          pqen,     pqsen,    plude,    pcte)<a name='2393'>
<font color=#447700>!**** *cudtdq* - updates t and q tendencies, precipitation rates<a name='2394'></font>
<font color=#447700>!                does global diagnostics<a name='2395'></font>
<font color=#447700>!      m.tiedtke         e.c.m.w.f.     7/86 modif.  12/89<a name='2396'></font>
<font color=#447700>!***interface.<a name='2397'></font>
<font color=#447700>!   ----------<a name='2398'></font>
<font color=#447700>!          *cudtdq* is called from *cumastr*<a name='2399'></font>
<font color=#447700>! ----------------------------------------------------------------<a name='2400'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='2401'></font>
      implicit none<a name='2402'>
<font color=#447700>!-------------------------------------------------------------------<a name='2403'></font>
      integer   klon, klev, klevp1<a name='2404'>
      integer   ktopm2,jl, jk<a name='2405'>
      real      ztmst, psrain, psevap, psheat, psmelt, zdiagt, zdiagw<a name='2406'>
      real      zalv, rhk, rhcoe, pldfd, zdtdt, zdqdt<a name='2407'>
      real     ptte(klon,klev),        pqte(klon,klev),  &amp;<a name='2408'>
              pten(klon,klev),        plude(klon,klev),  &amp;<a name='2409'>
              pgeo(klon,klev),        paph(klon,klevp1), &amp;<a name='2410'>
              paprc(klon),            paprs(klon),       &amp;<a name='2411'>
              paprsm(klon),           pcte(klon,klev),   &amp;<a name='2412'>
              prsfc(klon),            pssfc(klon)<a name='2413'>
      real     pmfus(klon,klev),       pmfds(klon,klev), &amp;<a name='2414'>
              pmfuq(klon,klev),       pmfdq(klon,klev), &amp;<a name='2415'>
              pmful(klon,klev),       pqsen(klon,klev), &amp;<a name='2416'>
              pdmfup(klon,klev),      pdmfdp(klon,klev),&amp; <a name='2417'>
              prfl(klon),             prain(klon),      &amp;<a name='2418'>
              pqen(klon,klev)<a name='2419'>
      real     pdpmel(klon,klev),      psfl(klon)<a name='2420'>
      real     zsheat(klon),           zmelt(klon)<a name='2421'>
      logical  ldcum(klon)<a name='2422'>
<font color=#447700>!--------------------------------<a name='2423'></font>
<font color=#447700>!*    1.0      specify parameters<a name='2424'></font>
<font color=#447700>!--------------------------------<a name='2425'></font>
      zdiagt=ztmst<a name='2426'>
      zdiagw=zdiagt/rhoh2o<a name='2427'>
<font color=#447700>!--------------------------------------------------<a name='2428'></font>
<font color=#447700>!*    2.0      incrementation of t and q tendencies<a name='2429'></font>
<font color=#447700>!--------------------------------------------------<a name='2430'></font>
      do jl=1,klon<a name='2431'>
        zmelt(jl)=0.<a name='2432'>
        zsheat(jl)=0.<a name='2433'>
      end do<a name='2434'>
<a name='2435'>
      do jk=ktopm2,klev<a name='2436'>
      if(jk.lt.klev) then<a name='2437'>
         do jl=1,klon<a name='2438'>
         if(ldcum(jl)) then<a name='2439'>
            if(pten(jl,jk).gt.tmelt) then<a name='2440'>
               zalv=alv<a name='2441'>
            else<a name='2442'>
               zalv=als<a name='2443'>
            endif<a name='2444'>
            rhk=min(1.0,pqen(jl,jk)/pqsen(jl,jk))<a name='2445'>
            rhcoe=max(0.0,(rhk-rhc)/(rhm-rhc))<a name='2446'>
            pldfd=max(0.0,rhcoe*fdbk*plude(jl,jk))<a name='2447'>
            zdtdt=(g/(paph(jl,jk+1)-paph(jl,jk)))*rcpd*      &amp;<a name='2448'>
              (pmfus(jl,jk+1)-pmfus(jl,jk)+                  &amp;<a name='2449'>
              pmfds(jl,jk+1)-pmfds(jl,jk)-alf*pdpmel(jl,jk)  &amp;<a name='2450'>
              -zalv*(pmful(jl,jk+1)-pmful(jl,jk)-pldfd-      &amp;<a name='2451'>
              (pdmfup(jl,jk)+pdmfdp(jl,jk))))<a name='2452'>
            ptte(jl,jk)=ptte(jl,jk)+zdtdt<a name='2453'>
            zdqdt=(g/(paph(jl,jk+1)-paph(jl,jk)))*&amp; <a name='2454'>
              (pmfuq(jl,jk+1)-pmfuq(jl,jk)+       &amp;<a name='2455'>
              pmfdq(jl,jk+1)-pmfdq(jl,jk)+        &amp;<a name='2456'>
              pmful(jl,jk+1)-pmful(jl,jk)-pldfd-  &amp;<a name='2457'>
              (pdmfup(jl,jk)+pdmfdp(jl,jk)))<a name='2458'>
            pqte(jl,jk)=pqte(jl,jk)+zdqdt<a name='2459'>
            pcte(jl,jk)=(g/(paph(jl,jk+1)-paph(jl,jk)))*pldfd<a name='2460'>
            zsheat(jl)=zsheat(jl)+zalv*(pdmfup(jl,jk)+pdmfdp(jl,jk))<a name='2461'>
            zmelt(jl)=zmelt(jl)+pdpmel(jl,jk)<a name='2462'>
         end if<a name='2463'>
         end do<a name='2464'>
      else<a name='2465'>
         do jl=1,klon<a name='2466'>
         if(ldcum(jl)) then<a name='2467'>
            if(pten(jl,jk).gt.tmelt) then<a name='2468'>
               zalv=alv<a name='2469'>
            else<a name='2470'>
               zalv=als<a name='2471'>
            endif<a name='2472'>
            rhk=min(1.0,pqen(jl,jk)/pqsen(jl,jk))<a name='2473'>
            rhcoe=max(0.0,(rhk-rhc)/(rhm-rhc))<a name='2474'>
            pldfd=max(0.0,rhcoe*fdbk*plude(jl,jk))<a name='2475'>
            zdtdt=-(g/(paph(jl,jk+1)-paph(jl,jk)))*rcpd*           &amp;<a name='2476'>
                (pmfus(jl,jk)+pmfds(jl,jk)+alf*pdpmel(jl,jk)-zalv* &amp;<a name='2477'>
                (pmful(jl,jk)+pdmfup(jl,jk)+pdmfdp(jl,jk)+pldfd))  <a name='2478'>
            ptte(jl,jk)=ptte(jl,jk)+zdtdt<a name='2479'>
            zdqdt=-(g/(paph(jl,jk+1)-paph(jl,jk)))*                &amp;<a name='2480'>
                     (pmfuq(jl,jk)+pmfdq(jl,jk)+pldfd+             &amp;<a name='2481'>
                     (pmful(jl,jk)+pdmfup(jl,jk)+pdmfdp(jl,jk)))   <a name='2482'>
            pqte(jl,jk)=pqte(jl,jk)+zdqdt<a name='2483'>
            pcte(jl,jk)=(g/(paph(jl,jk+1)-paph(jl,jk)))*pldfd<a name='2484'>
            zsheat(jl)=zsheat(jl)+zalv*(pdmfup(jl,jk)+pdmfdp(jl,jk))<a name='2485'>
            zmelt(jl)=zmelt(jl)+pdpmel(jl,jk)<a name='2486'>
         end if<a name='2487'>
         end do<a name='2488'>
      end if<a name='2489'>
      end do<a name='2490'>
<font color=#447700>!---------------------------------------------------------<a name='2491'></font>
<font color=#447700>!      3.      update surface fields and do global budgets<a name='2492'></font>
<font color=#447700>!---------------------------------------------------------<a name='2493'></font>
      do jl=1,klon<a name='2494'>
      prsfc(jl)=prfl(jl)<a name='2495'>
      pssfc(jl)=psfl(jl)<a name='2496'>
      paprc(jl)=paprc(jl)+zdiagw*(prfl(jl)+psfl(jl))<a name='2497'>
      paprs(jl)=paprsm(jl)+zdiagw*psfl(jl)<a name='2498'>
      psheat=psheat+zsheat(jl)<a name='2499'>
      psrain=psrain+prain(jl)<a name='2500'>
      psevap=psevap-(prfl(jl)+psfl(jl))<a name='2501'>
      psmelt=psmelt+zmelt(jl)<a name='2502'>
      end do<a name='2503'>
      psevap=psevap+psrain<a name='2504'>
      return<a name='2505'>
      end subroutine cudtdq<a name='2506'>
<a name='2507'>
<font color=#447700>!<a name='2508'></font>
<font color=#447700>!**********************************************<a name='2509'></font>
<font color=#447700>!       subroutine cududv<a name='2510'></font>
<font color=#447700>!********************************************** <a name='2511'></font>
<A NAME='CUDUDV'><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUDUDV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2512'>
      <font color=#993300>subroutine </font><font color=#cc0000>cududv</font> &amp; <A href='../../call_to/CUDUDV.html' TARGET='index'>1</A>,<A href='../../call_from/CUDUDV.html' TARGET='index'>1</A><a name='2513'>
         (klon,     klev,     klevp1,   ktopm2,   ktype,  &amp;<a name='2514'>
          kcbot,    paph,     ldcum,    puen,     pven,   &amp;<a name='2515'>
          pvom,     pvol,     puu,      pud,      pvu,    &amp;<a name='2516'>
          pvd,      pmfu,     pmfd,     psdiss)<a name='2517'>
<font color=#447700>!**** *cududv* - updates u and v tendencies,<a name='2518'></font>
<font color=#447700>!                does global diagnostic of dissipation<a name='2519'></font>
<font color=#447700>!      m.tiedtke         e.c.m.w.f.     7/86 modif.  12/89<a name='2520'></font>
<font color=#447700>!***interface.<a name='2521'></font>
<font color=#447700>!   ----------<a name='2522'></font>
<font color=#447700>!          *cududv* is called from *cumastr*<a name='2523'></font>
<font color=#447700>! ----------------------------------------------------------------<a name='2524'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='2525'></font>
      implicit none<a name='2526'>
<font color=#447700>!-------------------------------------------------------------------<a name='2527'></font>
      integer   klon, klev, klevp1<a name='2528'>
      integer   ktopm2, jk, ik, jl, ikb<a name='2529'>
      real      psdiss,zzp, zdudt ,zdvdt, zsum<a name='2530'>
      real     puen(klon,klev),        pven(klon,klev),   &amp;<a name='2531'>
              pvol(klon,klev),        pvom(klon,klev),    &amp;<a name='2532'>
              paph(klon,klevp1)<a name='2533'>
      real     puu(klon,klev),         pud(klon,klev),    &amp;<a name='2534'>
              pvu(klon,klev),         pvd(klon,klev),     &amp;<a name='2535'>
              pmfu(klon,klev),        pmfd(klon,klev)<a name='2536'>
      real     zmfuu(klon,klev),       zmfdu(klon,klev),  &amp;<a name='2537'>
              zmfuv(klon,klev),       zmfdv(klon,klev),   &amp;<a name='2538'>
              zdiss(klon)<a name='2539'>
      integer  ktype(klon),            kcbot(klon)<a name='2540'>
      logical  ldcum(klon)<a name='2541'>
<font color=#447700>!------------------------------------------------------------<a name='2542'></font>
<font color=#447700>!*    1.0      calculate fluxes and update u and v tendencies<a name='2543'></font>
<font color=#447700>! -----------------------------------------------------------<a name='2544'></font>
      do jk=ktopm2,klev<a name='2545'>
      ik=jk-1<a name='2546'>
      do jl=1,klon<a name='2547'>
      if(ldcum(jl)) then<a name='2548'>
        zmfuu(jl,jk)=pmfu(jl,jk)*(puu(jl,jk)-puen(jl,ik))<a name='2549'>
        zmfuv(jl,jk)=pmfu(jl,jk)*(pvu(jl,jk)-pven(jl,ik))<a name='2550'>
        zmfdu(jl,jk)=pmfd(jl,jk)*(pud(jl,jk)-puen(jl,ik))<a name='2551'>
        zmfdv(jl,jk)=pmfd(jl,jk)*(pvd(jl,jk)-pven(jl,ik))<a name='2552'>
      end if<a name='2553'>
      end do<a name='2554'>
      end do<a name='2555'>
<a name='2556'>
      do jk=ktopm2,klev<a name='2557'>
      do jl=1,klon<a name='2558'>
      if(ldcum(jl).and.jk.gt.kcbot(jl)) then<a name='2559'>
         ikb=kcbot(jl)<a name='2560'>
         zzp=((paph(jl,klevp1)-paph(jl,jk))/  &amp;<a name='2561'>
             (paph(jl,klevp1)-paph(jl,ikb)))<a name='2562'>
         if(ktype(jl).eq.3) then<a name='2563'>
            zzp=zzp**2<a name='2564'>
         endif<a name='2565'>
         zmfuu(jl,jk)=zmfuu(jl,ikb)*zzp<a name='2566'>
         zmfuv(jl,jk)=zmfuv(jl,ikb)*zzp<a name='2567'>
         zmfdu(jl,jk)=zmfdu(jl,ikb)*zzp<a name='2568'>
         zmfdv(jl,jk)=zmfdv(jl,ikb)*zzp<a name='2569'>
      end if<a name='2570'>
      end do<a name='2571'>
      end do<a name='2572'>
<a name='2573'>
      do jl=1,klon<a name='2574'>
      zdiss(jl)=0.<a name='2575'>
      end do<a name='2576'>
<a name='2577'>
      do jk=ktopm2,klev<a name='2578'>
      if(jk.lt.klev) then<a name='2579'>
         do jl=1,klon<a name='2580'>
            if(ldcum(jl)) then<a name='2581'>
               zdudt=(g/(paph(jl,jk+1)-paph(jl,jk)))* &amp;<a name='2582'>
                    (zmfuu(jl,jk+1)-zmfuu(jl,jk)+     &amp;<a name='2583'>
                     zmfdu(jl,jk+1)-zmfdu(jl,jk))<a name='2584'>
               zdvdt=(g/(paph(jl,jk+1)-paph(jl,jk)))* &amp;<a name='2585'>
                    (zmfuv(jl,jk+1)-zmfuv(jl,jk)+     &amp;<a name='2586'>
                     zmfdv(jl,jk+1)-zmfdv(jl,jk))<a name='2587'>
               zdiss(jl)=zdiss(jl)+        &amp;<a name='2588'>
                        puen(jl,jk)*(zmfuu(jl,jk+1)-zmfuu(jl,jk)+   &amp;<a name='2589'>
                                     zmfdu(jl,jk+1)-zmfdu(jl,jk))+  &amp;<a name='2590'>
                        pven(jl,jk)*(zmfuv(jl,jk+1)-zmfuv(jl,jk)+   &amp;<a name='2591'>
                                     zmfdv(jl,jk+1)-zmfdv(jl,jk))<a name='2592'>
               pvom(jl,jk)=pvom(jl,jk)+zdudt<a name='2593'>
               pvol(jl,jk)=pvol(jl,jk)+zdvdt<a name='2594'>
            end if<a name='2595'>
         end do<a name='2596'>
      else<a name='2597'>
         do jl=1,klon<a name='2598'>
            if(ldcum(jl)) then<a name='2599'>
               zdudt=-(g/(paph(jl,jk+1)-paph(jl,jk)))* &amp;<a name='2600'>
                        (zmfuu(jl,jk)+zmfdu(jl,jk))<a name='2601'>
               zdvdt=-(g/(paph(jl,jk+1)-paph(jl,jk)))* &amp;<a name='2602'>
                        (zmfuv(jl,jk)+zmfdv(jl,jk))<a name='2603'>
               zdiss(jl)=zdiss(jl)-        &amp;<a name='2604'>
                         (puen(jl,jk)*(zmfuu(jl,jk)+zmfdu(jl,jk))+ &amp;<a name='2605'>
                          pven(jl,jk)*(zmfuv(jl,jk)+zmfdv(jl,jk)))<a name='2606'>
               pvom(jl,jk)=pvom(jl,jk)+zdudt<a name='2607'>
               pvol(jl,jk)=pvol(jl,jk)+zdvdt<a name='2608'>
            end if<a name='2609'>
         end do<a name='2610'>
       end if<a name='2611'>
      end do<a name='2612'>
      zsum=<A href='../../html_code/phys/module_cu_tiedtke.F.html#SSUM'>ssum</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUDUDV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SSUM_1">(klon,zdiss(1),1)<a name='2613'>
      psdiss=psdiss+zsum<a name='2614'>
      return<a name='2615'>
      end subroutine cududv<a name='2616'>
<font color=#447700>!<a name='2617'></font>
<a name='2618'>
<font color=#447700>!#################################################################<a name='2619'></font>
<font color=#447700>!<a name='2620'></font>
<font color=#447700>!                 level 4 subroutines<a name='2621'></font>
<font color=#447700>!<a name='2622'></font>
<font color=#447700>!#################################################################<a name='2623'></font>
<font color=#447700>!**************************************************************<a name='2624'></font>
<font color=#447700>!             subroutine cubasmc<a name='2625'></font>
<font color=#447700>!**************************************************************<a name='2626'></font>
<A NAME='CUBASMC'><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUBASMC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2627'>
      <font color=#993300>subroutine </font><font color=#cc0000>cubasmc</font>   &amp; <A href='../../call_to/CUBASMC.html' TARGET='index'>1</A><a name='2628'>
         (klon,     klev,     klevm1,  kk,     pten,  &amp;<a name='2629'>
          pqen,     pqsen,    puen,    pven,   pverv, &amp;<a name='2630'>
          pgeo,     pgeoh,    ldcum,   ktype,  klab,  &amp;<a name='2631'>
          pmfu,     pmfub,    pentr,   kcbot,  ptu,   &amp;<a name='2632'>
          pqu,      plu,      puu,     pvu,    pmfus, &amp;<a name='2633'>
          pmfuq,    pmful,    pdmfup,  pmfuu,  pmfuv) <a name='2634'>
<font color=#447700>!      m.tiedtke         e.c.m.w.f.     12/89<a name='2635'></font>
<font color=#447700>!***purpose.<a name='2636'></font>
<font color=#447700>!   --------<a name='2637'></font>
<font color=#447700>!          this routine calculates cloud base values<a name='2638'></font>
<font color=#447700>!          for midlevel convection<a name='2639'></font>
<font color=#447700>!***interface<a name='2640'></font>
<font color=#447700>!   ---------<a name='2641'></font>
<font color=#447700>!          this routine is called from *cuasc*.<a name='2642'></font>
<font color=#447700>!          input are environmental values t,q etc<a name='2643'></font>
<font color=#447700>!          it returns cloudbase values for midlevel convection<a name='2644'></font>
<font color=#447700>!***method.<a name='2645'></font>
<font color=#447700>!   -------<a name='2646'></font>
<font color=#447700>!          s. tiedtke (1989)<a name='2647'></font>
<font color=#447700>!***externals<a name='2648'></font>
<font color=#447700>!   ---------<a name='2649'></font>
<font color=#447700>!          none<a name='2650'></font>
<font color=#447700>! ----------------------------------------------------------------<a name='2651'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='2652'></font>
      implicit none<a name='2653'>
<font color=#447700>!-------------------------------------------------------------------<a name='2654'></font>
      integer   klon, klev, klevp1<a name='2655'>
      integer   klevm1,kk, jl<a name='2656'>
      real      zzzmb<a name='2657'>
      real     pten(klon,klev),        pqen(klon,klev),  &amp;<a name='2658'>
              puen(klon,klev),        pven(klon,klev),   &amp;<a name='2659'>
              pqsen(klon,klev),       pverv(klon,klev),  &amp; <a name='2660'>
              pgeo(klon,klev),        pgeoh(klon,klev)<a name='2661'>
      real     ptu(klon,klev),         pqu(klon,klev),   &amp;<a name='2662'>
              puu(klon,klev),         pvu(klon,klev),    &amp;<a name='2663'>
              plu(klon,klev),         pmfu(klon,klev),   &amp;<a name='2664'>
              pmfub(klon),            pentr(klon),       &amp;<a name='2665'>
              pmfus(klon,klev),       pmfuq(klon,klev),  &amp;<a name='2666'>
              pmful(klon,klev),       pdmfup(klon,klev), &amp;<a name='2667'>
              pmfuu(klon),            pmfuv(klon)<a name='2668'>
      integer  ktype(klon),            kcbot(klon),      &amp;<a name='2669'>
              klab(klon,klev)<a name='2670'>
      logical  ldcum(klon)<a name='2671'>
<font color=#447700>!--------------------------------------------------------<a name='2672'></font>
<font color=#447700>!*    1.      calculate entrainment and detrainment rates<a name='2673'></font>
<font color=#447700>! -------------------------------------------------------<a name='2674'></font>
         do jl=1,klon<a name='2675'>
          if( .not. ldcum(jl).and.klab(jl,kk+1).eq.0.0.and.  &amp;<a name='2676'>
             pqen(jl,kk).gt.0.80*pqsen(jl,kk)) then<a name='2677'>
            ptu(jl,kk+1)=(cpd*pten(jl,kk)+pgeo(jl,kk)-pgeoh(jl,kk+1)) &amp;<a name='2678'>
                               *rcpd<a name='2679'>
            pqu(jl,kk+1)=pqen(jl,kk)<a name='2680'>
            plu(jl,kk+1)=0.<a name='2681'>
            zzzmb=max(cmfcmin,-pverv(jl,kk)/g)<a name='2682'>
            zzzmb=min(zzzmb,cmfcmax)<a name='2683'>
            pmfub(jl)=zzzmb<a name='2684'>
            pmfu(jl,kk+1)=pmfub(jl)<a name='2685'>
            pmfus(jl,kk+1)=pmfub(jl)*(cpd*ptu(jl,kk+1)+pgeoh(jl,kk+1))<a name='2686'>
            pmfuq(jl,kk+1)=pmfub(jl)*pqu(jl,kk+1)<a name='2687'>
            pmful(jl,kk+1)=0.<a name='2688'>
            pdmfup(jl,kk+1)=0.<a name='2689'>
            kcbot(jl)=kk<a name='2690'>
            klab(jl,kk+1)=1<a name='2691'>
            ktype(jl)=3<a name='2692'>
            pentr(jl)=entrmid<a name='2693'>
               if(lmfdudv) then<a name='2694'>
                  puu(jl,kk+1)=puen(jl,kk)<a name='2695'>
                  pvu(jl,kk+1)=pven(jl,kk)<a name='2696'>
                  pmfuu(jl)=pmfub(jl)*puu(jl,kk+1)<a name='2697'>
                  pmfuv(jl)=pmfub(jl)*pvu(jl,kk+1)<a name='2698'>
               end if<a name='2699'>
         end if<a name='2700'>
        end do<a name='2701'>
      return<a name='2702'>
      end subroutine cubasmc<a name='2703'>
<a name='2704'>
<font color=#447700>!<a name='2705'></font>
<font color=#447700>!**************************************************************<a name='2706'></font>
<font color=#447700>!             subroutine cuadjtq<a name='2707'></font>
<font color=#447700>!**************************************************************<a name='2708'></font>
<A NAME='CUADJTQ'><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2709'>
      <font color=#993300>subroutine </font><font color=#cc0000>cuadjtq</font>(klon,klev,kk,pp,pt,pq,ldflag,kcall) <A href='../../call_to/CUADJTQ.html' TARGET='index'>5</A>,<A href='../../call_from/CUADJTQ.html' TARGET='index'>16</A><a name='2710'>
<font color=#447700>!      m.tiedtke         e.c.m.w.f.     12/89<a name='2711'></font>
<font color=#447700>!      d.salmond         cray(uk))      12/8/91<a name='2712'></font>
<font color=#447700>!***purpose.<a name='2713'></font>
<font color=#447700>!   --------<a name='2714'></font>
<font color=#447700>!          to produce t,q and l values for cloud ascent<a name='2715'></font>
<font color=#447700>!***interface<a name='2716'></font>
<font color=#447700>!   ---------<a name='2717'></font>
<font color=#447700>!          this routine is called from subroutines:<a name='2718'></font>
<font color=#447700>!              *cubase*   (t and q at condenstion level)<a name='2719'></font>
<font color=#447700>!              *cuasc*    (t and q at cloud levels)<a name='2720'></font>
<font color=#447700>!              *cuini*    (environmental t and qs values at half levels)<a name='2721'></font>
<font color=#447700>!          input are unadjusted t and q values,<a name='2722'></font>
<font color=#447700>!          it returns adjusted values of t and q<a name='2723'></font>
<font color=#447700>!          note: input parameter kcall defines calculation as<a name='2724'></font>
<font color=#447700>!               kcall=0    env. t and qs in*cuini*<a name='2725'></font>
<font color=#447700>!               kcall=1  condensation in updrafts  (e.g.  cubase, cuasc)<a name='2726'></font>
<font color=#447700>!               kcall=2  evaporation in downdrafts (e.g.  cudlfs,cuddraf<a name='2727'></font>
<font color=#447700>!***externals<a name='2728'></font>
<font color=#447700>!   ---------<a name='2729'></font>
<font color=#447700>!          3 lookup tables ( tlucua, tlucub, tlucuc )<a name='2730'></font>
<font color=#447700>!          for condensation calculations.<a name='2731'></font>
<font color=#447700>!          the tables are initialised in *setphys*.<a name='2732'></font>
<font color=#447700>! ----------------------------------------------------------------<a name='2733'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='2734'></font>
      implicit none<a name='2735'>
<font color=#447700>!-------------------------------------------------------------------<a name='2736'></font>
      integer   klon, klev<a name='2737'>
      integer   kk, kcall, isum, jl<a name='2738'>
      real      zqsat, zcor, zcond1, tt<a name='2739'>
      real     pt(klon,klev),          pq(klon,klev),  &amp;<a name='2740'>
              zcond(klon),            zqp(klon),       &amp;<a name='2741'>
              pp(klon)<a name='2742'>
      logical  ldflag(klon)<a name='2743'>
<font color=#447700>!------------------------------------------------------------------<a name='2744'></font>
<font color=#447700>!     2.      calculate condensation and adjust t and q accordingly<a name='2745'></font>
<font color=#447700>!------------------------------------------------------------------<a name='2746'></font>
      if (kcall.eq.1 ) then<a name='2747'>
         isum=0<a name='2748'>
         do jl=1,klon<a name='2749'>
         zcond(jl)=0.<a name='2750'>
         if(ldflag(jl)) then<a name='2751'>
            zqp(jl)=1./pp(jl)<a name='2752'>
            tt=pt(jl,kk)<a name='2753'>
            zqsat=<A href='../../html_code/phys/module_cu_tiedtke.F.html#TLUCUA'>tlucua</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TLUCUA_2">(tt)*zqp(jl)<a name='2754'>
            zqsat=min(0.5,zqsat)<a name='2755'>
            zcor=1./(1.-vtmpc1*zqsat)<a name='2756'>
            zqsat=zqsat*zcor<a name='2757'>
            zcond(jl)=(pq(jl,kk)-zqsat)/(1.+zqsat*zcor*tlucub(tt))<a name='2758'>
            zcond(jl)=max(zcond(jl),0.)<a name='2759'>
            pt(jl,kk)=pt(jl,kk)+tlucuc(tt)*zcond(jl)<a name='2760'>
            pq(jl,kk)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_10">(jl,kk)-zcond(jl)<a name='2761'>
            if(zcond(jl).ne.0.0) isum=isum+1<a name='2762'>
         end if<a name='2763'>
         end do<a name='2764'>
<a name='2765'>
         if(isum.eq.0) return<a name='2766'>
         do jl=1,klon<a name='2767'>
         if(ldflag(jl).and.zcond(jl).ne.0.) then<a name='2768'>
            tt=pt(jl,kk)<a name='2769'>
            zqsat=<A href='../../html_code/phys/module_cu_tiedtke.F.html#TLUCUA'>tlucua</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TLUCUA_3">(tt)*zqp(jl)<a name='2770'>
            zqsat=min(0.5,zqsat)<a name='2771'>
            zcor=1./(1.-vtmpc1*zqsat)<a name='2772'>
            zqsat=zqsat*zcor<a name='2773'>
            zcond1=(pq(jl,kk)-zqsat)/(1.+zqsat*zcor*tlucub(tt))<a name='2774'>
            pt(jl,kk)=pt(jl,kk)+tlucuc(tt)*zcond1<a name='2775'>
            pq(jl,kk)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_11">(jl,kk)-zcond1<a name='2776'>
         end if<a name='2777'>
         end do<a name='2778'>
      end if<a name='2779'>
      if(kcall.eq.2) then<a name='2780'>
         isum=0<a name='2781'>
         do jl=1,klon<a name='2782'>
         zcond(jl)=0.<a name='2783'>
         if(ldflag(jl)) then<a name='2784'>
            tt=pt(jl,kk)<a name='2785'>
            zqp(jl)=1./pp(jl)<a name='2786'>
            zqsat=<A href='../../html_code/phys/module_cu_tiedtke.F.html#TLUCUA'>tlucua</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TLUCUA_4">(tt)*zqp(jl)<a name='2787'>
            zqsat=min(0.5,zqsat)<a name='2788'>
            zcor=1./(1.-vtmpc1*zqsat)<a name='2789'>
            zqsat=zqsat*zcor<a name='2790'>
            zcond(jl)=(pq(jl,kk)-zqsat)/(1.+zqsat*zcor*tlucub(tt))<a name='2791'>
            zcond(jl)=min(zcond(jl),0.)<a name='2792'>
            pt(jl,kk)=pt(jl,kk)+tlucuc(tt)*zcond(jl)<a name='2793'>
            pq(jl,kk)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_12">(jl,kk)-zcond(jl)<a name='2794'>
            if(zcond(jl).ne.0.0) isum=isum+1<a name='2795'>
         end if<a name='2796'>
         end do<a name='2797'>
<a name='2798'>
         if(isum.eq.0) return<a name='2799'>
         do jl=1,klon<a name='2800'>
         if(ldflag(jl).and.zcond(jl).ne.0.) then<a name='2801'>
            tt=pt(jl,kk)<a name='2802'>
            zqsat=<A href='../../html_code/phys/module_cu_tiedtke.F.html#TLUCUA'>tlucua</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TLUCUA_5">(tt)*zqp(jl)<a name='2803'>
            zqsat=min(0.5,zqsat)<a name='2804'>
            zcor=1./(1.-vtmpc1*zqsat)<a name='2805'>
            zqsat=zqsat*zcor<a name='2806'>
            zcond1=(pq(jl,kk)-zqsat)/(1.+zqsat*zcor*tlucub(tt))<a name='2807'>
            pt(jl,kk)=pt(jl,kk)+tlucuc(tt)*zcond1<a name='2808'>
            pq(jl,kk)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_13">(jl,kk)-zcond1<a name='2809'>
         end if<a name='2810'>
         end do<a name='2811'>
      end if<a name='2812'>
      if(kcall.eq.0) then<a name='2813'>
         isum=0<a name='2814'>
         do jl=1,klon<a name='2815'>
           tt=pt(jl,kk)<a name='2816'>
           zqp(jl)=1./pp(jl)<a name='2817'>
           zqsat=<A href='../../html_code/phys/module_cu_tiedtke.F.html#TLUCUA'>tlucua</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TLUCUA_6">(tt)*zqp(jl)<a name='2818'>
           zqsat=min(0.5,zqsat)<a name='2819'>
           zcor=1./(1.-vtmpc1*zqsat)<a name='2820'>
           zqsat=zqsat*zcor<a name='2821'>
           zcond(jl)=(pq(jl,kk)-zqsat)/(1.+zqsat*zcor*tlucub(tt))<a name='2822'>
           pt(jl,kk)=pt(jl,kk)+tlucuc(tt)*zcond(jl)<a name='2823'>
           pq(jl,kk)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_14">(jl,kk)-zcond(jl)<a name='2824'>
           if(zcond(jl).ne.0.0) isum=isum+1<a name='2825'>
         end do<a name='2826'>
<a name='2827'>
         if(isum.eq.0) return<a name='2828'>
         do jl=1,klon<a name='2829'>
           tt=pt(jl,kk)<a name='2830'>
           zqsat=<A href='../../html_code/phys/module_cu_tiedtke.F.html#TLUCUA'>tlucua</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TLUCUA_7">(tt)*zqp(jl)<a name='2831'>
           zqsat=min(0.5,zqsat)<a name='2832'>
           zcor=1./(1.-vtmpc1*zqsat)<a name='2833'>
           zqsat=zqsat*zcor<a name='2834'>
           zcond1=(pq(jl,kk)-zqsat)/(1.+zqsat*zcor*tlucub(tt))<a name='2835'>
           pt(jl,kk)=pt(jl,kk)+tlucuc(tt)*zcond1<a name='2836'>
           pq(jl,kk)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_15">(jl,kk)-zcond1<a name='2837'>
         end do<a name='2838'>
      end if<a name='2839'>
      if(kcall.eq.4) then<a name='2840'>
         do jl=1,klon<a name='2841'>
           tt=pt(jl,kk)<a name='2842'>
           zqp(jl)=1./pp(jl)<a name='2843'>
           zqsat=<A href='../../html_code/phys/module_cu_tiedtke.F.html#TLUCUA'>tlucua</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TLUCUA_8">(tt)*zqp(jl)<a name='2844'>
           zqsat=min(0.5,zqsat)<a name='2845'>
           zcor=1./(1.-vtmpc1*zqsat)<a name='2846'>
           zqsat=zqsat*zcor<a name='2847'>
           zcond(jl)=(pq(jl,kk)-zqsat)/(1.+zqsat*zcor*tlucub(tt))<a name='2848'>
           pt(jl,kk)=pt(jl,kk)+tlucuc(tt)*zcond(jl)<a name='2849'>
           pq(jl,kk)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_16">(jl,kk)-zcond(jl)<a name='2850'>
         end do<a name='2851'>
<a name='2852'>
         do jl=1,klon<a name='2853'>
           tt=pt(jl,kk)<a name='2854'>
           zqsat=<A href='../../html_code/phys/module_cu_tiedtke.F.html#TLUCUA'>tlucua</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TLUCUA_9">(tt)*zqp(jl)<a name='2855'>
           zqsat=min(0.5,zqsat)<a name='2856'>
           zcor=1./(1.-vtmpc1*zqsat)<a name='2857'>
           zqsat=zqsat*zcor<a name='2858'>
           zcond1=(pq(jl,kk)-zqsat)/(1.+zqsat*zcor*tlucub(tt))<a name='2859'>
           pt(jl,kk)=pt(jl,kk)+tlucuc(tt)*zcond1<a name='2860'>
           pq(jl,kk)=<A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUADJTQ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_17">(jl,kk)-zcond1<a name='2861'>
         end do<a name='2862'>
      end if<a name='2863'>
      return<a name='2864'>
      end subroutine cuadjtq<a name='2865'>
<a name='2866'>
<font color=#447700>!<a name='2867'></font>
<font color=#447700>!**********************************************************<a name='2868'></font>
<font color=#447700>!        subroutine cuentr_new<a name='2869'></font>
<font color=#447700>!**********************************************************<a name='2870'></font>
<A NAME='CUENTR_NEW'><A href='../../html_code/phys/module_cu_tiedtke.F.html#CUENTR_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2871'>
      <font color=#993300>subroutine </font><font color=#cc0000>cuentr_new</font>                              &amp;    <A href='../../call_to/CUENTR_NEW.html' TARGET='index'>1</A><a name='2872'>
         (klon,     klev,     klevp1,   kk,       ptenh, &amp;<a name='2873'>
          paph,     pap,      pgeoh,    klwmin,   ldcum, &amp;<a name='2874'>
          ktype,    kcbot,    kctop0,   zpbase,   pmfu,  &amp;<a name='2875'>
          pentr,    zdmfen,   zdmfde,   zodetr,   khmin)<a name='2876'>
<font color=#447700>!      m.tiedtke         e.c.m.w.f.     12/89<a name='2877'></font>
<font color=#447700>!      y.wang            iprc           11/01<a name='2878'></font>
<font color=#447700>!***purpose.<a name='2879'></font>
<font color=#447700>!   --------<a name='2880'></font>
<font color=#447700>!          this routine calculates entrainment/detrainment rates<a name='2881'></font>
<font color=#447700>!          for updrafts in cumulus parameterization<a name='2882'></font>
<font color=#447700>!***interface<a name='2883'></font>
<font color=#447700>!   ---------<a name='2884'></font>
<font color=#447700>!          this routine is called from *cuasc*.<a name='2885'></font>
<font color=#447700>!          input are environmental values t,q etc<a name='2886'></font>
<font color=#447700>!          and updraft values t,q etc<a name='2887'></font>
<font color=#447700>!          it returns entrainment/detrainment rates<a name='2888'></font>
<font color=#447700>!***method.<a name='2889'></font>
<font color=#447700>!  --------<a name='2890'></font>
<font color=#447700>!          s. tiedtke (1989), nordeng(1996)<a name='2891'></font>
<font color=#447700>!***externals<a name='2892'></font>
<font color=#447700>!   ---------<a name='2893'></font>
<font color=#447700>!          none<a name='2894'></font>
<font color=#447700>! ----------------------------------------------------------------<a name='2895'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='2896'></font>
      implicit none<a name='2897'>
<font color=#447700>!-------------------------------------------------------------------<a name='2898'></font>
      integer   klon, klev, klevp1<a name='2899'>
      integer   kk, jl, iklwmin,ikb, ikt, ikh<a name='2900'>
      real      zrrho, zdprho, zpmid, zentr, zzmzk, ztmzk, arg, zorgde<a name='2901'>
      real     ptenh(klon,klev),                           &amp;<a name='2902'>
              pap(klon,klev),         paph(klon,klevp1),   &amp;<a name='2903'>
              pmfu(klon,klev),        pgeoh(klon,klev),    &amp;<a name='2904'>
              pentr(klon),            zpbase(klon),        &amp;<a name='2905'>
              zdmfen(klon),           zdmfde(klon),        &amp;<a name='2906'>
              zodetr(klon,klev)<a name='2907'>
      integer  klwmin(klon),           ktype(klon),        &amp;<a name='2908'>
              kcbot(klon),            kctop0(klon),        &amp;<a name='2909'>
              khmin(klon)<a name='2910'>
      logical  ldcum(klon),llo1,llo2<a name='2911'>
<font color=#447700>!---------------------------------------------------------<a name='2912'></font>
<font color=#447700>!*    1.       calculate entrainment and detrainment rates<a name='2913'></font>
<font color=#447700>!---------------------------------------------------------<a name='2914'></font>
<font color=#447700>!*    1.1      specify entrainment rates for shallow clouds<a name='2915'></font>
<font color=#447700>!----------------------------------------------------------<a name='2916'></font>
<font color=#447700>!*    1.2      specify entrainment rates for deep clouds<a name='2917'></font>
<font color=#447700>!-------------------------------------------------------<a name='2918'></font>
      do jl = 1, klon<a name='2919'>
        zpbase(jl) = paph(jl,kcbot(jl))<a name='2920'>
        zrrho = (rd*ptenh(jl,kk+1))/paph(jl,kk+1)<a name='2921'>
        zdprho = (paph(jl,kk+1)-paph(jl,kk))*zrg<a name='2922'>
        zpmid = 0.5*(zpbase(jl)+paph(jl,kctop0(jl)))<a name='2923'>
        zentr = pentr(jl)*pmfu(jl,kk+1)*zdprho*zrrho<a name='2924'>
        llo1 = kk.lt.kcbot(jl).and.ldcum(jl)<a name='2925'>
        if(llo1) then<a name='2926'>
           zdmfde(jl) = zentr<a name='2927'>
        else<a name='2928'>
           zdmfde(jl) = 0.0<a name='2929'>
        endif<a name='2930'>
        llo2 = llo1.and.ktype(jl).eq.2.and.((zpbase(jl)-paph(jl,kk)) &amp;<a name='2931'>
             .lt.zdnoprc.or.paph(jl,kk).gt.zpmid)<a name='2932'>
        if(llo2) then<a name='2933'>
            zdmfen(jl) = zentr<a name='2934'>
        else<a name='2935'>
            zdmfen(jl) = 0.0<a name='2936'>
        endif<a name='2937'>
        iklwmin = max(klwmin(jl),kctop0(jl)+2)<a name='2938'>
        llo2 = llo1.and.ktype(jl).eq.3.and.(kk.ge.iklwmin.or.pap(jl,kk) &amp;<a name='2939'>
             .gt.zpmid)<a name='2940'>
        if (llo2) zdmfen(jl) = zentr<a name='2941'>
        llo2 = llo1.and.ktype(jl).eq.1<a name='2942'>
<font color=#447700>! turbulent entrainment<a name='2943'></font>
        if (llo2) zdmfen(jl) = zentr<a name='2944'>
<font color=#447700>! organized detrainment, detrainment starts at khmin<a name='2945'></font>
        ikb = kcbot(jl)<a name='2946'>
        zodetr(jl,kk) = 0.<a name='2947'>
        if (llo2.and.kk.le.khmin(jl).and.kk.ge.kctop0(jl)) then<a name='2948'>
          ikt = kctop0(jl)<a name='2949'>
          ikh = khmin(jl)<a name='2950'>
          if (ikh.gt.ikt) then<a name='2951'>
            zzmzk = -(pgeoh(jl,ikh)-pgeoh(jl,kk))*zrg<a name='2952'>
            ztmzk = -(pgeoh(jl,ikh)-pgeoh(jl,ikt))*zrg<a name='2953'>
            arg = 3.1415*(zzmzk/ztmzk)*0.5<a name='2954'>
            zorgde = tan(arg)*3.1415*0.5/ztmzk<a name='2955'>
            zdprho = (paph(jl,kk+1)-paph(jl,kk))*(zrg*zrrho)<a name='2956'>
            zodetr(jl,kk) = min(zorgde,1.e-3)*pmfu(jl,kk+1)*zdprho<a name='2957'>
          end if<a name='2958'>
        end if<a name='2959'>
      enddo<a name='2960'>
<font color=#447700>! <a name='2961'></font>
      return<a name='2962'>
      end subroutine cuentr_new<a name='2963'>
<font color=#447700>!<a name='2964'></font>
<a name='2965'>
<font color=#447700>!**********************************************************<a name='2966'></font>
<font color=#447700>!        function ssum, tlucua, tlucub, tlucuc<a name='2967'></font>
<font color=#447700>!**********************************************************<a name='2968'></font>
<A NAME='SSUM'><A href='../../html_code/phys/module_cu_tiedtke.F.html#SSUM' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2969'>
      real <font color=#993300>function </font><font color=#cc0000>ssum</font> ( n, x, ix ) <A href='../../call_to/SSUM.html' TARGET='index'>1</A><a name='2970'>
<font color=#447700>!<a name='2971'></font>
<font color=#447700>! computes ssum = sum of [x(i)]<a name='2972'></font>
<font color=#447700>!     for n elements of x with skip increment ix for vector x<a name='2973'></font>
<font color=#447700>!<a name='2974'></font>
      implicit none<a name='2975'>
      real x(*)<a name='2976'>
      real zsum<a name='2977'>
      integer n, ix, jx, jl<a name='2978'>
<font color=#447700>!<a name='2979'></font>
      jx = 1<a name='2980'>
      zsum = 0.0<a name='2981'>
      do jl = 1, n<a name='2982'>
        zsum = zsum + x(jx)<a name='2983'>
        jx = jx + ix<a name='2984'>
      enddo<a name='2985'>
<font color=#447700>!<a name='2986'></font>
      ssum=zsum<a name='2987'>
<font color=#447700>!<a name='2988'></font>
      return<a name='2989'>
      end function ssum<a name='2990'>
<a name='2991'>
<A NAME='TLUCUA'><A href='../../html_code/phys/module_cu_tiedtke.F.html#TLUCUA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2992'>
      real <font color=#993300>function </font><font color=#cc0000>tlucua</font>(tt) <A href='../../call_to/TLUCUA.html' TARGET='index'>9</A><a name='2993'>
<font color=#447700>!<a name='2994'></font>
<font color=#447700>!  set up lookup tables for cloud ascent calculations.<a name='2995'></font>
<font color=#447700>!<a name='2996'></font>
      implicit none<a name='2997'>
      real zcvm3,zcvm4,tt <font color=#447700>!,tlucua<a name='2998'></font>
<font color=#447700>!<a name='2999'></font>
      if(tt-tmelt.gt.0.) then<a name='3000'>
         zcvm3=c3les<a name='3001'>
         zcvm4=c4les<a name='3002'>
      else<a name='3003'>
         zcvm3=c3ies<a name='3004'>
         zcvm4=c4ies<a name='3005'>
      end if<a name='3006'>
      tlucua=c2es*exp(zcvm3*(tt-tmelt)*(1./(tt-zcvm4)))<a name='3007'>
<font color=#447700>!<a name='3008'></font>
      return<a name='3009'>
      end function tlucua<a name='3010'>
<font color=#447700>!<a name='3011'></font>
<A NAME='TLUCUB'><A href='../../html_code/phys/module_cu_tiedtke.F.html#TLUCUB' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3012'>
      real <font color=#993300>function </font><font color=#cc0000>tlucub</font>(tt)<a name='3013'>
<font color=#447700>!<a name='3014'></font>
<font color=#447700>!  set up lookup tables for cloud ascent calculations.<a name='3015'></font>
<font color=#447700>!<a name='3016'></font>
      implicit none<a name='3017'>
      real z5alvcp,z5alscp,zcvm4,zcvm5,tt <font color=#447700>!,tlucub<a name='3018'></font>
<font color=#447700>!<a name='3019'></font>
      z5alvcp=c5les*alv/cpd<a name='3020'>
      z5alscp=c5ies*als/cpd<a name='3021'>
      if(tt-tmelt.gt.0.) then<a name='3022'>
         zcvm4=c4les<a name='3023'>
         zcvm5=z5alvcp<a name='3024'>
      else<a name='3025'>
         zcvm4=c4ies<a name='3026'>
         zcvm5=z5alscp<a name='3027'>
      end if<a name='3028'>
      tlucub=zcvm5*(1./(tt-zcvm4))**2<a name='3029'>
<font color=#447700>!<a name='3030'></font>
      return<a name='3031'>
      end function tlucub<a name='3032'>
<font color=#447700>!<a name='3033'></font>
<A NAME='TLUCUC'><A href='../../html_code/phys/module_cu_tiedtke.F.html#TLUCUC' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3034'>
      real <font color=#993300>function </font><font color=#cc0000>tlucuc</font>(tt)<a name='3035'>
<font color=#447700>!<a name='3036'></font>
<font color=#447700>!  set up lookup tables for cloud ascent calculations.<a name='3037'></font>
<font color=#447700>!<a name='3038'></font>
      implicit none<a name='3039'>
      real zalvdcp,zalsdcp,tt,zldcp <font color=#447700>!,tlucuc<a name='3040'></font>
<font color=#447700>!<a name='3041'></font>
      zalvdcp=alv/cpd<a name='3042'>
      zalsdcp=als/cpd<a name='3043'>
      if(tt-tmelt.gt.0.) then<a name='3044'>
         zldcp=zalvdcp<a name='3045'>
      else<a name='3046'>
         zldcp=zalsdcp<a name='3047'>
      end if<a name='3048'>
      tlucuc=zldcp<a name='3049'>
<font color=#447700>!<a name='3050'></font>
      return<a name='3051'>
      end function tlucuc<a name='3052'>
<font color=#447700>!<a name='3053'></font>
<a name='3054'>
end module module_cu_tiedtke<a name='3055'>
</pre></body></html>