<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if (NMM_CORE == 1)<a name='2'>
<A NAME='MODULE_DIAG_AFWA'><A href='../../html_code/phys/module_diag_afwa.F.html#MODULE_DIAG_AFWA' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='3'>
<font color=#993300>MODULE </font><font color=#cc0000>module_diag_afwa</font> <A href='../../call_to/MODULE_DIAG_AFWA.html' TARGET='index'>1</A><a name='4'>
CONTAINS<a name='5'>
<A NAME='DIAG_AFWA_STUB'><A href='../../html_code/phys/module_diag_afwa.F.html#DIAG_AFWA_STUB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>diag_afwa_stub</font><a name='7'>
   END SUBROUTINE diag_afwa_stub<a name='8'>
END MODULE module_diag_afwa<a name='9'>
#else<a name='10'>
<a name='11'>
<font color=#447700>!WRF:MEDIATION_LAYER:PHYSICS<a name='12'></font>
<a name='13'>
<A NAME='DIAG_FUNCTIONS'><A href='../../html_code/phys/module_diag_afwa.F.html#DIAG_FUNCTIONS' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='14'>
<font color=#993300>MODULE </font><font color=#cc0000>diag_functions</font> <A href='../../call_to/DIAG_FUNCTIONS.html' TARGET='index'>1</A><a name='15'>
<a name='16'>
CONTAINS<a name='17'>
<a name='18'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='19'></font>
  <font color=#447700>!~ <a name='20'></font>
  <font color=#447700>!~ Name:<a name='21'></font>
  <font color=#447700>!~    calc_rh<a name='22'></font>
  <font color=#447700>!~<a name='23'></font>
  <font color=#447700>!~ Description:<a name='24'></font>
  <font color=#447700>!~    This function calculates relative humidity given pressure, <a name='25'></font>
  <font color=#447700>!~    temperature, and water vapor mixing ratio.<a name='26'></font>
  <font color=#447700>!~ <a name='27'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='28'></font>
<A NAME='CALC_RH'><A href='../../html_code/phys/module_diag_afwa.F.html#CALC_RH' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='29'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>calc_rh</font> ( p, t, qv ) result ( rh ) <A href='../../call_to/CALC_RH.html' TARGET='index'>3</A><a name='30'>
    <a name='31'>
    IMPLICIT NONE<a name='32'>
 <a name='33'>
    REAL, INTENT(IN) :: p, t, qv<a name='34'>
    REAL :: rh<a name='35'>
<a name='36'>
    <font color=#447700>! Local<a name='37'></font>
    <font color=#447700>! -----<a name='38'></font>
    REAL, PARAMETER :: pq0=379.90516<a name='39'>
    REAL, PARAMETER :: a2=17.2693882<a name='40'>
    REAL, PARAMETER :: a3=273.16<a name='41'>
    REAL, PARAMETER :: a4=35.86<a name='42'>
    REAL, PARAMETER :: rhmin=1.<a name='43'>
    REAL :: q, qs<a name='44'>
    INTEGER :: i,j,k<a name='45'>
  <a name='46'>
    <font color=#447700>! Following algorithms adapted from WRFPOST<a name='47'></font>
    <font color=#447700>! May want to substitute with another later<a name='48'></font>
    <font color=#447700>! -----------------------------------------<a name='49'></font>
      q=qv/(1.0+qv)<a name='50'>
      qs=pq0/p*exp(a2*(t-a3)/(t-a4))<a name='51'>
      rh=100.*q/qs<a name='52'>
      IF (rh .gt. 100.) THEN<a name='53'>
        rh=100.<a name='54'>
      ELSE IF (rh .lt. rhmin) THEN<a name='55'>
        rh=rhmin<a name='56'>
      ENDIF<a name='57'>
<a name='58'>
  END FUNCTION calc_rh<a name='59'>
<a name='60'>
<a name='61'>
<a name='62'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='63'></font>
  <font color=#447700>!~ <a name='64'></font>
  <font color=#447700>!~ Name:<a name='65'></font>
  <font color=#447700>!~    uv_wind<a name='66'></font>
  <font color=#447700>!~<a name='67'></font>
  <font color=#447700>!~ Description:<a name='68'></font>
  <font color=#447700>!~    This function calculates the wind speed given U and V wind<a name='69'></font>
  <font color=#447700>!~    components.<a name='70'></font>
  <font color=#447700>!~ <a name='71'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='72'></font>
<A NAME='UV_WIND'><A href='../../html_code/phys/module_diag_afwa.F.html#UV_WIND' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='73'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>uv_wind</font> ( u, v ) result ( wind_speed ) <A href='../../call_to/UV_WIND.html' TARGET='index'>3</A><a name='74'>
 <a name='75'>
    IMPLICIT NONE<a name='76'>
 <a name='77'>
    REAL, INTENT(IN) :: u, v<a name='78'>
    REAL :: wind_speed<a name='79'>
<a name='80'>
    wind_speed = sqrt( u*u + v*v )<a name='81'>
<a name='82'>
  END FUNCTION uv_wind<a name='83'>
<a name='84'>
<a name='85'>
  <a name='86'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='87'></font>
  <font color=#447700>!~<a name='88'></font>
  <font color=#447700>!~ Name:<a name='89'></font>
  <font color=#447700>!~    Theta<a name='90'></font>
  <font color=#447700>!~<a name='91'></font>
  <font color=#447700>!~ Description:<a name='92'></font>
  <font color=#447700>!~    This function calculates potential temperature as defined by<a name='93'></font>
  <font color=#447700>!~    Poisson's equation, given temperature and pressure ( hPa ).<a name='94'></font>
  <font color=#447700>!~<a name='95'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='96'></font>
<A NAME='THETA'><A href='../../html_code/phys/module_diag_afwa.F.html#THETA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='97'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>Theta</font> ( t, p ) <A href='../../call_to/THETA.html' TARGET='index'>26</A><a name='98'>
  IMPLICIT NONE<a name='99'>
<a name='100'>
     <font color=#447700>!~ Variable declaration<a name='101'></font>
     <font color=#447700>!  --------------------<a name='102'></font>
     REAL, INTENT ( IN ) :: t<a name='103'>
     REAL, INTENT ( IN ) :: p<a name='104'>
     REAL                :: theta<a name='105'>
<a name='106'>
     REAL :: Rd <font color=#447700>! Dry gas constant<a name='107'></font>
     REAL :: Cp <font color=#447700>! Specific heat of dry air at constant pressure<a name='108'></font>
     REAL :: p0 <font color=#447700>! Standard pressure ( 1000 hPa )<a name='109'></font>
  <a name='110'>
     Rd =  287.04<a name='111'>
     Cp = 1004.67<a name='112'>
     p0 = 1000.00<a name='113'>
<a name='114'>
     <font color=#447700>!~ Poisson's equation<a name='115'></font>
     <font color=#447700>!  ------------------<a name='116'></font>
     theta = t * ( (p0/p)**(Rd/Cp) )<a name='117'>
  <a name='118'>
  END FUNCTION Theta<a name='119'>
<a name='120'>
<a name='121'>
<a name='122'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='123'></font>
  <font color=#447700>!~<a name='124'></font>
  <font color=#447700>!~ Name:<a name='125'></font>
  <font color=#447700>!~    Thetae<a name='126'></font>
  <font color=#447700>!~<a name='127'></font>
  <font color=#447700>!~ Description:<a name='128'></font>
  <font color=#447700>!~    This function returns equivalent potential temperature using the <a name='129'></font>
  <font color=#447700>!~    method described in Bolton 1980, Monthly Weather Review, equation 43.<a name='130'></font>
  <font color=#447700>!~<a name='131'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='132'></font>
<A NAME='THETAE'><A href='../../html_code/phys/module_diag_afwa.F.html#THETAE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='133'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>Thetae</font> ( tK, p, rh, mixr ) <A href='../../call_to/THETAE.html' TARGET='index'>1</A><a name='134'>
  IMPLICIT NONE<a name='135'>
<a name='136'>
     <font color=#447700>!~ Variable Declarations<a name='137'></font>
     <font color=#447700>!  ---------------------<a name='138'></font>
     REAL :: tK        <font color=#447700>! Temperature ( K )<a name='139'></font>
     REAL :: p         <font color=#447700>! Pressure ( hPa )<a name='140'></font>
     REAL :: rh        <font color=#447700>! Relative humidity<a name='141'></font>
     REAL :: mixr      <font color=#447700>! Mixing Ratio ( kg kg^-1)<a name='142'></font>
     REAL :: te        <font color=#447700>! Equivalent temperature ( K )<a name='143'></font>
     REAL :: thetae    <font color=#447700>! Equivalent potential temperature<a name='144'></font>
  <a name='145'>
     REAL, PARAMETER :: R  = 287.04         <font color=#447700>! Universal gas constant (J/deg kg)<a name='146'></font>
     REAL, PARAMETER :: P0 = 1000.0         <font color=#447700>! Standard pressure at surface (hPa)<a name='147'></font>
     REAL, PARAMETER :: lv = 2.54*(10**6)   <font color=#447700>! Latent heat of vaporization<a name='148'></font>
                                            <font color=#447700>! (J kg^-1)<a name='149'></font>
     REAL, PARAMETER :: cp = 1004.67        <font color=#447700>! Specific heat of dry air constant<a name='150'></font>
                                            <font color=#447700>! at pressure (J/deg kg)<a name='151'></font>
     REAL :: tlc                            <font color=#447700>! LCL temperature<a name='152'></font>
  <a name='153'>
     <font color=#447700>!~ Calculate the temperature of the LCL<a name='154'></font>
     <font color=#447700>!  ------------------------------------<a name='155'></font>
     tlc = TLCL ( tK, rh )<a name='156'>
  <a name='157'>
     <font color=#447700>!~ Calculate theta-e<a name='158'></font>
     <font color=#447700>!  -----------------<a name='159'></font>
     thetae = (tK * (p0/p)**( (R/Cp)*(1.- ( (.28E-3)*mixr*1000.) ) ) )* &amp;<a name='160'>
                 exp( (((3.376/tlc)-.00254))*&amp;<a name='161'>
                    (mixr*1000.*(1.+(.81E-3)*mixr*1000.)) )<a name='162'>
  <a name='163'>
  END FUNCTION Thetae<a name='164'>
<a name='165'>
<a name='166'>
<a name='167'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='168'></font>
  <font color=#447700>!~<a name='169'></font>
  <font color=#447700>!~ Name:<a name='170'></font>
  <font color=#447700>!~    The2T.f90<a name='171'></font>
  <font color=#447700>!~<a name='172'></font>
  <font color=#447700>!~ Description:<a name='173'></font>
  <font color=#447700>!~    This function returns the temperature at any pressure level along a<a name='174'></font>
  <font color=#447700>!~    saturation adiabat by iteratively solving for it from the parcel<a name='175'></font>
  <font color=#447700>!~    thetae.<a name='176'></font>
  <font color=#447700>!~<a name='177'></font>
  <font color=#447700>!~ Dependencies:<a name='178'></font>
  <font color=#447700>!~    function thetae.f90<a name='179'></font>
  <font color=#447700>!~<a name='180'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='181'></font>
<A NAME='THE2T'><A href='../../html_code/phys/module_diag_afwa.F.html#THE2T' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='182'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>The2T</font> ( thetaeK, pres, flag ) result ( tparcel )<a name='183'>
  IMPLICIT NONE<a name='184'>
  <a name='185'>
     <font color=#447700>!~ Variable Declaration<a name='186'></font>
     <font color=#447700>!  --------------------<a name='187'></font>
     REAL,    INTENT     ( IN ) :: thetaeK<a name='188'>
     REAL,    INTENT     ( IN ) :: pres<a name='189'>
     LOGICAL, INTENT ( INOUT )  :: flag<a name='190'>
     REAL                       :: tparcel<a name='191'>
  <a name='192'>
     REAL :: thetaK<a name='193'>
     REAL :: tovtheta<a name='194'>
     REAL :: tcheck<a name='195'>
     REAL :: svpr, svpr2<a name='196'>
     REAL :: smixr, smixr2<a name='197'>
     REAL :: thetae_check, thetae_check2<a name='198'>
     REAL :: tguess_2, correction<a name='199'>
  <a name='200'>
     LOGICAL :: found<a name='201'>
     INTEGER :: iter<a name='202'>
  <a name='203'>
     REAL :: R     <font color=#447700>! Dry gas constant<a name='204'></font>
     REAL :: Cp    <font color=#447700>! Specific heat for dry air<a name='205'></font>
     REAL :: kappa <font color=#447700>! Rd / Cp<a name='206'></font>
     REAL :: Lv    <font color=#447700>! Latent heat of vaporization at 0 deg. C<a name='207'></font>
  <a name='208'>
     R     = 287.04<a name='209'>
     Cp    = 1004.67<a name='210'>
     Kappa = R/Cp<a name='211'>
     Lv    = 2.500E+6<a name='212'>
<a name='213'>
     <font color=#447700>!~ Make initial guess for temperature of the parcel<a name='214'></font>
     <font color=#447700>!  ------------------------------------------------<a name='215'></font>
     tovtheta = (pres/100000.0)**(r/cp)<a name='216'>
     tparcel  = thetaeK/exp(lv*.012/(cp*295.))*tovtheta<a name='217'>
<a name='218'>
     iter = 1<a name='219'>
     found = .false.<a name='220'>
     flag = .false.<a name='221'>
<a name='222'>
     DO<a name='223'>
        IF ( iter &gt; 105 ) EXIT<a name='224'>
<a name='225'>
        tguess_2 = tparcel + REAL ( 1 )<a name='226'>
<a name='227'>
        svpr   = 6.122 * exp ( (17.67*(tparcel-273.15)) / (tparcel-29.66) )<a name='228'>
        smixr  = ( 0.622*svpr ) / ( (pres/100.0)-svpr )<a name='229'>
        svpr2  = 6.122 * exp ( (17.67*(tguess_2-273.15)) / (tguess_2-29.66) )<a name='230'>
        smixr2 = ( 0.622*svpr2 ) / ( (pres/100.0)-svpr2 )<a name='231'>
<a name='232'>
        <font color=#447700>!  ------------------------------------------------------------------ ~!<a name='233'></font>
        <font color=#447700>!~ When this function was orinially written, the final parcel         ~!<a name='234'></font>
        <font color=#447700>!~ temperature check was based off of the parcel temperature and      ~!<a name='235'></font>
        <font color=#447700>!~ not the theta-e it produced.  As there are multiple temperature-   ~!<a name='236'></font>
        <font color=#447700>!~ mixing ratio combinations that can produce a single theta-e value, ~!<a name='237'></font>
        <font color=#447700>!~ we change the check to be based off of the resultant theta-e       ~!<a name='238'></font>
        <font color=#447700>!~ value.  This seems to be the most accurate way of backing out      ~!<a name='239'></font>
        <font color=#447700>!~ temperature from theta-e.                                          ~!<a name='240'></font>
        <font color=#447700>!~                                                                    ~!<a name='241'></font>
        <font color=#447700>!~ Rentschler, April 2010                                             ~!<a name='242'></font>
        <font color=#447700>!  ------------------------------------------------------------------  !<a name='243'></font>
<a name='244'>
        <font color=#447700>!~ Old way...<a name='245'></font>
        <font color=#447700>!thetaK = thetaeK / EXP (lv * smixr  /(cp*tparcel) )<a name='246'></font>
        <font color=#447700>!tcheck = thetaK * tovtheta<a name='247'></font>
<a name='248'>
        <font color=#447700>!~ New way<a name='249'></font>
        thetae_check  = Thetae ( tparcel,  pres/100., 100., smixr  )<a name='250'>
        thetae_check2 = Thetae ( tguess_2, pres/100., 100., smixr2 )<a name='251'>
<a name='252'>
        <font color=#447700>!~ Whew doggies - that there is some accuracy...<a name='253'></font>
        <font color=#447700>!IF ( ABS (tparcel-tcheck) &lt; .05) THEN<a name='254'></font>
        IF ( ABS (thetaeK-thetae_check) &lt; .001) THEN<a name='255'>
           found = .true.<a name='256'>
           flag  = .true.<a name='257'>
           EXIT<a name='258'>
        END IF<a name='259'>
<a name='260'>
        <font color=#447700>!~ Old<a name='261'></font>
        <font color=#447700>!tparcel = tparcel + (tcheck - tparcel)*.3<a name='262'></font>
<a name='263'>
        <font color=#447700>!~ New<a name='264'></font>
        correction = ( thetaeK-thetae_check ) / ( thetae_check2-thetae_check )<a name='265'>
        tparcel = tparcel + correction<a name='266'>
<a name='267'>
        iter = iter + 1<a name='268'>
     END DO<a name='269'>
<a name='270'>
     <font color=#447700>!IF ( .not. found ) THEN<a name='271'></font>
     <font color=#447700>!   print*, "Warning! Thetae to temperature calculation did not converge!"<a name='272'></font>
     <font color=#447700>!   print*, "Thetae ", thetaeK, "Pressure ", pres<a name='273'></font>
     <font color=#447700>!END IF<a name='274'></font>
<a name='275'>
  END FUNCTION The2T<a name='276'>
<a name='277'>
<a name='278'>
<a name='279'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='280'></font>
  <font color=#447700>!~<a name='281'></font>
  <font color=#447700>!~ Name:<a name='282'></font>
  <font color=#447700>!~    VirtualTemperature<a name='283'></font>
  <font color=#447700>!~<a name='284'></font>
  <font color=#447700>!~ Description:<a name='285'></font>
  <font color=#447700>!~    This function returns virtual temperature given temperature ( K )<a name='286'></font>
  <font color=#447700>!~    and mixing ratio.<a name='287'></font>
  <font color=#447700>!~<a name='288'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='289'></font>
<A NAME='VIRTUALTEMPERATURE'><A href='../../html_code/phys/module_diag_afwa.F.html#VIRTUALTEMPERATURE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='290'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>VirtualTemperature</font> ( tK, w ) result ( Tv )<a name='291'>
  IMPLICIT NONE<a name='292'>
<a name='293'>
     <font color=#447700>!~ Variable declaration<a name='294'></font>
     real, intent ( in ) :: tK <font color=#447700>!~ Temperature<a name='295'></font>
     real, intent ( in ) :: w  <font color=#447700>!~ Mixing ratio ( kg kg^-1 )<a name='296'></font>
     real                :: Tv <font color=#447700>!~ Virtual temperature<a name='297'></font>
<a name='298'>
     Tv = tK * ( 1.0 + (w/0.622) ) / ( 1.0 + w )<a name='299'>
<a name='300'>
  END FUNCTION VirtualTemperature<a name='301'>
<a name='302'>
<a name='303'>
<a name='304'>
<a name='305'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='306'></font>
  <font color=#447700>!~<a name='307'></font>
  <font color=#447700>!~ Name:<a name='308'></font>
  <font color=#447700>!~    SaturationMixingRatio<a name='309'></font>
  <font color=#447700>!~<a name='310'></font>
  <font color=#447700>!~ Description:<a name='311'></font>
  <font color=#447700>!~    This function calculates saturation mixing ratio given the<a name='312'></font>
  <font color=#447700>!~    temperature ( K ) and the ambient pressure ( Pa ).  Uses <a name='313'></font>
  <font color=#447700>!~    approximation of saturation vapor pressure.<a name='314'></font>
  <font color=#447700>!~<a name='315'></font>
  <font color=#447700>!~ References:<a name='316'></font>
  <font color=#447700>!~    Bolton (1980), Monthly Weather Review, pg. 1047, Eq. 10<a name='317'></font>
  <font color=#447700>!~<a name='318'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='319'></font>
<A NAME='SATURATIONMIXINGRATIO'><A href='../../html_code/phys/module_diag_afwa.F.html#SATURATIONMIXINGRATIO' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='320'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>SaturationMixingRatio</font> ( tK, p ) result ( ws )<a name='321'>
<a name='322'>
    IMPLICIT NONE<a name='323'>
<a name='324'>
    REAL, INTENT ( IN ) :: tK<a name='325'>
    REAL, INTENT ( IN ) :: p<a name='326'>
    REAL                :: ws<a name='327'>
<a name='328'>
    REAL :: es<a name='329'>
<a name='330'>
    es = 6.122 * exp ( (17.67*(tK-273.15))/ (tK-29.66) )<a name='331'>
    ws = ( 0.622*es ) / ( (p/100.0)-es )<a name='332'>
<a name='333'>
  END FUNCTION SaturationMixingRatio<a name='334'>
<a name='335'>
<a name='336'>
<a name='337'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='338'></font>
  <font color=#447700>!~                                                                     <a name='339'></font>
  <font color=#447700>!~ Name:                                                                <a name='340'></font>
  <font color=#447700>!~    tlcl                                                               <a name='341'></font>
  <font color=#447700>!~                                                                        <a name='342'></font>
  <font color=#447700>!~ Description:                                                            <a name='343'></font>
  <font color=#447700>!~    This function calculates the temperature of a parcel of air would have<a name='344'></font>
  <font color=#447700>!~    if lifed dry adiabatically to it's lifting condensation level (lcl).  <a name='345'></font>
  <font color=#447700>!~                                                                          <a name='346'></font>
  <font color=#447700>!~ References:                                                              <a name='347'></font>
  <font color=#447700>!~    Bolton (1980), Monthly Weather Review, pg. 1048, Eq. 22<a name='348'></font>
  <font color=#447700>!~                                                                          <a name='349'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='350'></font>
<A NAME='TLCL'><A href='../../html_code/phys/module_diag_afwa.F.html#TLCL' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='351'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>TLCL</font> ( tk, rh )<a name='352'>
    <a name='353'>
    IMPLICIT NONE<a name='354'>
 <a name='355'>
    REAL, INTENT ( IN ) :: tK   <font color=#447700>!~ Temperature ( K )<a name='356'></font>
    REAL, INTENT ( IN ) :: rh   <font color=#447700>!~ Relative Humidity ( % )<a name='357'></font>
    REAL                :: tlcl<a name='358'>
    <a name='359'>
    REAL :: denom, term1, term2<a name='360'>
<a name='361'>
    term1 = 1.0 / ( tK - 55.0 )<a name='362'>
    IF ( rh &gt; REAL (0) ) THEN<a name='363'>
      term2 = ( LOG (rh/100.0)  / 2840.0 )<a name='364'>
    ELSE<a name='365'>
      term2 = ( LOG (0.001/1.0) / 2840.0 )<a name='366'>
    END IF<a name='367'>
    denom = term1 - term2<a name='368'>
    tlcl = ( 1.0 / denom ) + REAL ( 55 ) <a name='369'>
<a name='370'>
  END FUNCTION TLCL<a name='371'>
<a name='372'>
<a name='373'>
<a name='374'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='375'></font>
  <font color=#447700>!~<a name='376'></font>
  <font color=#447700>!~ Name:<a name='377'></font>
  <font color=#447700>!~    PWat<a name='378'></font>
  <font color=#447700>!~<a name='379'></font>
  <font color=#447700>!~ Description:<a name='380'></font>
  <font color=#447700>!~    This function calculates precipitable water by summing up the <a name='381'></font>
  <font color=#447700>!~    water vapor in a column from the first eta layer to model top<a name='382'></font>
  <font color=#447700>!~<a name='383'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='384'></font>
<A NAME='PWAT'><A href='../../html_code/phys/module_diag_afwa.F.html#PWAT' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='385'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>Pwat</font>  ( nz, qv, qc, dz8w, rho ) <A href='../../call_to/PWAT.html' TARGET='index'>1</A><a name='386'>
<a name='387'>
    IMPLICIT NONE<a name='388'>
<a name='389'>
     <font color=#447700>!~ Variable declaration<a name='390'></font>
     <font color=#447700>!  --------------------<a name='391'></font>
     INTEGER, INTENT ( IN ) :: nz          <font color=#447700>!~ Number of vertical levels<a name='392'></font>
     REAL, INTENT ( IN )    :: qv   ( nz ) <font color=#447700>!~ Specific humidity in layer (kg/kg)<a name='393'></font>
     REAL, INTENT ( IN )    :: qc   ( nz ) <font color=#447700>!~ Cloud water in layer (kg/kg)<a name='394'></font>
     REAL, INTENT ( IN )    :: dz8w ( nz ) <font color=#447700>!~ Dist between vertical levels (m)<a name='395'></font>
     REAL, INTENT ( IN )    :: rho  ( nz ) <font color=#447700>!~ Air density (kg/m^3)<a name='396'></font>
     REAL                   :: Pwat        <font color=#447700>!~ Precipitable water (kg/m^2)<a name='397'></font>
     INTEGER                :: k           <font color=#447700>!~ Vertical index<a name='398'></font>
<a name='399'>
     <font color=#447700>!~ Precipitable water (kg/m^2)<a name='400'></font>
     <font color=#447700>!  ---------------------------<a name='401'></font>
     Pwat=0<a name='402'>
     DO k = 1, nz<a name='403'>
       Pwat = Pwat + (qv(k) + qc(k)) * dz8w(k) * rho(k)<a name='404'>
     ENDDO<a name='405'>
             <a name='406'>
  END FUNCTION Pwat<a name='407'>
 <a name='408'>
<a name='409'>
<a name='410'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='411'></font>
  <font color=#447700>!~                                                                          ~!<a name='412'></font>
  <font color=#447700>!~ Name:                                                                    ~!<a name='413'></font>
  <font color=#447700>!~    Buoyancy                                                              ~!<a name='414'></font>
  <font color=#447700>!~                                                                          ~!<a name='415'></font>
  <font color=#447700>!~ Description:                                                             ~!<a name='416'></font>
  <font color=#447700>!~    This function computes Convective Available Potential Energy (CAPE)   ~!<a name='417'></font>
  <font color=#447700>!~    with inhibition as a result of water loading given the data required  ~!<a name='418'></font>
  <font color=#447700>!~    to run up a sounding.                                                 ~!<a name='419'></font>
  <font color=#447700>!~                                                                          ~!<a name='420'></font>
  <font color=#447700>!~    Additionally, since we are running up a sounding anyways, this        ~!<a name='421'></font>
  <font color=#447700>!~    function returns the height of the Level of Free Convection (LFC) and ~!<a name='422'></font>
  <font color=#447700>!~    the pressure at the LFC.  That-a-ways, we don't have to run up a      ~!<a name='423'></font>
  <font color=#447700>!~    sounding later, saving a relatively computationally expensive         ~!<a name='424'></font>
  <font color=#447700>!~    routine.                                                              ~!<a name='425'></font>
  <font color=#447700>!~                                                                          ~!<a name='426'></font>
  <font color=#447700>!~ Usage:                                                                   ~!<a name='427'></font>
  <font color=#447700>!~    ostat = Buoyancy ( tK, rh, p, hgt, sfc, CAPE, ZLFC, PLFC, parcel )    ~!<a name='428'></font>
  <font color=#447700>!~                                                                          ~!<a name='429'></font>
  <font color=#447700>!~ Where:                                                                   ~!<a name='430'></font>
  <font color=#447700>!~                                                                          ~!<a name='431'></font>
  <font color=#447700>!~    IN                                                                    ~!<a name='432'></font>
  <font color=#447700>!~    --                                                                    ~!<a name='433'></font>
  <font color=#447700>!~    tK   = Temperature ( K )                                              ~!<a name='434'></font>
  <font color=#447700>!~    rh   = Relative Humidity ( % )                                        ~!<a name='435'></font>
  <font color=#447700>!~    p    = Pressure ( Pa )                                                ~!<a name='436'></font>
  <font color=#447700>!~    hgt  = Geopotential heights ( m )                                     ~!<a name='437'></font>
  <font color=#447700>!~    sfc  = integer rank within submitted arrays that represents the       ~!<a name='438'></font>
  <font color=#447700>!~           surface                                                        ~!<a name='439'></font>
  <font color=#447700>!~                                                                          ~!<a name='440'></font>
  <font color=#447700>!~    OUT                                                                   ~!<a name='441'></font>
  <font color=#447700>!~    ---                                                                   ~!<a name='442'></font>
  <font color=#447700>!~    ostat         INTEGER return status. Nonzero is bad.                  ~!<a name='443'></font>
  <font color=#447700>!~    CAPE ( J/kg ) Convective Available Potential Energy                   ~!<a name='444'></font>
  <font color=#447700>!~    ZLFC ( gpm )  Height at the LFC                                       ~!<a name='445'></font>
  <font color=#447700>!~    PLFC ( Pa )   Pressure at the LFC                                     ~!<a name='446'></font>
  <font color=#447700>!~                                                                          ~!<a name='447'></font>
  <font color=#447700>!~    tK, rh, p, and hgt are all REAL arrays, arranged from lower levels    ~!<a name='448'></font>
  <font color=#447700>!~    to higher levels.                                                     ~!<a name='449'></font>
  <font color=#447700>!~                                                                          ~!<a name='450'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='451'></font>
<A NAME='BUOYANCY'><A href='../../html_code/phys/module_diag_afwa.F.html#BUOYANCY' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='452'>
    <font color=#993300>FUNCTION </font><font color=#cc0000>Buoyancy</font> ( nz, tk, rh, p, hgt, sfc, cape, cin, zlfc, plfc, lidx,  &amp;<a name='453'>
                        parcel ) result (ostat)<a name='454'>
  <a name='455'>
      IMPLICIT NONE<a name='456'>
  <a name='457'>
      INTEGER, INTENT ( IN )  :: nz          <font color=#447700>!~ Number of vertical levels<a name='458'></font>
      INTEGER, INTENT ( IN )  :: sfc         <font color=#447700>!~ Surface level in the profile<a name='459'></font>
      REAL,    INTENT ( IN )  :: tk   ( nz ) <font color=#447700>!~ Temperature profile ( K )<a name='460'></font>
      REAL,    INTENT ( IN )  :: rh   ( nz ) <font color=#447700>!~ Relative Humidity profile ( % )<a name='461'></font>
      REAL,    INTENT ( IN )  :: p    ( nz ) <font color=#447700>!~ Pressure profile ( Pa )<a name='462'></font>
      REAL,    INTENT ( IN )  :: hgt  ( nz ) <font color=#447700>!~ Height profile ( gpm )<a name='463'></font>
      REAL,    INTENT ( OUT ) :: cape        <font color=#447700>!~ CAPE ( J kg^-1 )<a name='464'></font>
      REAL,    INTENT ( OUT ) :: cin         <font color=#447700>!~ CIN  ( J kg^-1 )<a name='465'></font>
      REAL,    INTENT ( OUT ) :: zlfc        <font color=#447700>!~ LFC Height ( gpm )<a name='466'></font>
      REAL,    INTENT ( OUT ) :: plfc        <font color=#447700>!~ LFC Pressure ( Pa )<a name='467'></font>
      REAL,    INTENT ( OUT ) :: lidx        <font color=#447700>!~ Lifted index<a name='468'></font>
      INTEGER                 :: ostat       <font color=#447700>!~ Function return status<a name='469'></font>
                                             <font color=#447700>!~ Nonzero is bad.<a name='470'></font>
<a name='471'>
      INTEGER, INTENT ( IN  ) :: parcel      <font color=#447700>!~ Most Unstable = 1 (default)<a name='472'></font>
                                             <font color=#447700>!~ Mean layer    = 2<a name='473'></font>
                                             <font color=#447700>!~ Surface based = 3<a name='474'></font>
  <a name='475'>
      <font color=#447700>!~ Derived profile variables<a name='476'></font>
      <font color=#447700>!  -------------------------<a name='477'></font>
      REAL                    :: ws   ( nz ) <font color=#447700>!~ Saturation mixing ratio<a name='478'></font>
      REAL                    :: w    ( nz ) <font color=#447700>!~ Mixing ratio<a name='479'></font>
      REAL                    :: dTvK ( nz ) <font color=#447700>!~ Parcel / ambient Tv difference<a name='480'></font>
      REAL                    :: buoy ( nz ) <font color=#447700>!~ Buoyancy<a name='481'></font>
      REAL                    :: tlclK       <font color=#447700>!~ LCL temperature ( K )<a name='482'></font>
      REAL                    :: plcl        <font color=#447700>!~ LCL pressure ( Pa )<a name='483'></font>
      REAL                    :: nbuoy       <font color=#447700>!~ Negative buoyancy<a name='484'></font>
      REAL                    :: pbuoy       <font color=#447700>!~ Positive buoyancy<a name='485'></font>
  <a name='486'>
      <font color=#447700>!~ Source parcel information<a name='487'></font>
      <font color=#447700>!  -------------------------<a name='488'></font>
      REAL                    :: srctK       <font color=#447700>!~ Source parcel temperature ( K )<a name='489'></font>
      REAL                    :: srcrh       <font color=#447700>!~ Source parcel rh ( % )<a name='490'></font>
      REAL                    :: srcws       <font color=#447700>!~ Source parcel sat. mixing ratio<a name='491'></font>
      REAL                    :: srcw        <font color=#447700>!~ Source parcel mixing ratio<a name='492'></font>
      REAL                    :: srcp        <font color=#447700>!~ Source parcel pressure ( Pa )<a name='493'></font>
      REAL                    :: srctheta    <font color=#447700>!~ Source parcel theta ( K )<a name='494'></font>
      REAL                    :: srcthetaeK  <font color=#447700>!~ Source parcel theta-e ( K )<a name='495'></font>
      INTEGER                 :: srclev      <font color=#447700>!~ Level of the source parcel<a name='496'></font>
      REAL                    :: spdiff      <font color=#447700>!~ Pressure difference<a name='497'></font>
   <a name='498'>
      <font color=#447700>!~ Parcel variables<a name='499'></font>
      <font color=#447700>!  ----------------<a name='500'></font>
      REAL                    :: ptK        <font color=#447700>!~ Parcel temperature ( K )<a name='501'></font>
      REAL                    :: ptvK       <font color=#447700>!~ Parcel virtual temperature ( K )<a name='502'></font>
      REAL                    :: tvK        <font color=#447700>!~ Ambient virtual temperature ( K )<a name='503'></font>
      REAL                    :: pw         <font color=#447700>!~ Parcel mixing ratio<a name='504'></font>
  <a name='505'>
      <font color=#447700>!~ Other utility variables<a name='506'></font>
      <font color=#447700>!  -----------------------<a name='507'></font>
      INTEGER                 :: i, j, k    <font color=#447700>!~ Dummy iterator<a name='508'></font>
      INTEGER                 :: lfclev     <font color=#447700>!~ Level of LFC<a name='509'></font>
      INTEGER                 :: prcl       <font color=#447700>!~ Internal parcel type indicator<a name='510'></font>
      INTEGER                 :: mlev       <font color=#447700>!~ Level for ML calculation<a name='511'></font>
      INTEGER                 :: lyrcnt     <font color=#447700>!~ Number of layers in mean layer<a name='512'></font>
      LOGICAL                 :: flag       <font color=#447700>!~ Dummy flag<a name='513'></font>
      LOGICAL                 :: wflag      <font color=#447700>!~ Saturation flag<a name='514'></font>
      REAL                    :: freeze     <font color=#447700>!~ Water loading multiplier<a name='515'></font>
      REAL                    :: pdiff      <font color=#447700>!~ Pressure difference between levs <a name='516'></font>
      REAL                    :: pm, pu, pd <font color=#447700>!~ Middle, upper, lower pressures<a name='517'></font>
      REAL                    :: lidxu      <font color=#447700>!~ Lifted index at upper level<a name='518'></font>
      REAL                    :: lidxd      <font color=#447700>!~ Lifted index at lower level<a name='519'></font>
  <a name='520'>
      <font color=#447700>!~ Thermo / dynamical constants<a name='521'></font>
      <font color=#447700>!  ----------------------------<a name='522'></font>
      REAL                    :: Rd         <font color=#447700>!~ Dry gas constant<a name='523'></font>
         PARAMETER ( Rd = 287.058 )         <font color=#447700>!~ J deg^-1 kg^-1<a name='524'></font>
      REAL                    :: Cp         <font color=#447700>!~ Specific heat constant pressure<a name='525'></font>
         PARAMETER ( Cp = 1004.67 )         <font color=#447700>!~ J deg^-1 kg^-1<a name='526'></font>
      REAL                    :: g          <font color=#447700>!~ Acceleration due to gravity<a name='527'></font>
         PARAMETER ( g  = 9.80665 )         <font color=#447700>!~ m s^-2<a name='528'></font>
      REAL                    :: RUNDEF<a name='529'>
         PARAMETER ( RUNDEF = -9.999E30 )<a name='530'>
  <a name='531'>
      <font color=#447700>!~ Initialize variables<a name='532'></font>
      <font color=#447700>!  --------------------<a name='533'></font>
      ostat  = 0<a name='534'>
      CAPE   = REAL ( 0 )<a name='535'>
      CIN    = REAL ( 0 )<a name='536'>
      ZLFC   = RUNDEF<a name='537'>
      PLFC   = RUNDEF<a name='538'>
  <a name='539'>
      <font color=#447700>!~ Look for submitted parcel definition<a name='540'></font>
      <font color=#447700>!~ 1 = Most unstable<a name='541'></font>
      <font color=#447700>!~ 2 = Mean layer<a name='542'></font>
      <font color=#447700>!~ 3 = Surface based<a name='543'></font>
      <font color=#447700>!  -------------------------------------<a name='544'></font>
      IF ( parcel &gt; 3 .or. parcel &lt; 1 ) THEN<a name='545'>
         prcl = 1<a name='546'>
      ELSE<a name='547'>
         prcl =  parcel<a name='548'>
      END IF<a name='549'>
  <a name='550'>
      <font color=#447700>!~ Initalize our parcel to be (sort of) surface based.  Because of<a name='551'></font>
      <font color=#447700>!~ issues we've been observing in the WRF model, specifically with<a name='552'></font>
      <font color=#447700>!~ excessive surface moisture values at the surface, using a true<a name='553'></font>
      <font color=#447700>!~ surface based parcel is resulting a more unstable environment<a name='554'></font>
      <font color=#447700>!~ than is actually occuring.  To address this, our surface parcel<a name='555'></font>
      <font color=#447700>!~ is now going to be defined as the parcel between 25-50 hPa<a name='556'></font>
      <font color=#447700>!~ above the surface. UPDATE - now that this routine is in WRF,<a name='557'></font>
      <font color=#447700>!~ going to trust surface info. GAC 20140415<a name='558'></font>
      <font color=#447700>!  ----------------------------------------------------------------<a name='559'></font>
  <a name='560'>
      <font color=#447700>!~ Compute mixing ratio values for the layer<a name='561'></font>
      <font color=#447700>!  -----------------------------------------<a name='562'></font>
      DO k = sfc, nz<a name='563'>
        ws  ( k )   = SaturationMixingRatio ( tK(k), p(k) )<a name='564'>
        w   ( k )   = ( rh(k)/100.0 ) * ws ( k )<a name='565'>
      END DO<a name='566'>
  <a name='567'>
      srclev      = sfc<a name='568'>
      srctK       = tK    ( sfc )<a name='569'>
      srcrh       = rh    ( sfc )<a name='570'>
      srcp        = p     ( sfc )<a name='571'>
      srcws       = ws    ( sfc )<a name='572'>
      srcw        = w     ( sfc )<a name='573'>
      srctheta    = Theta ( tK(sfc), p(sfc)/100.0 )<a name='574'>
   <a name='575'>
      <font color=#447700>!~ Compute the profile mixing ratio.  If the parcel is the MU parcel,<a name='576'></font>
      <font color=#447700>!~ define our parcel to be the most unstable parcel within the lowest<a name='577'></font>
      <font color=#447700>!~ 180 mb.<a name='578'></font>
      <font color=#447700>!  -------------------------------------------------------------------<a name='579'></font>
      mlev = sfc + 1<a name='580'>
      DO k = sfc + 1, nz<a name='581'>
   <a name='582'>
         <font color=#447700>!~ Identify the last layer within 100 hPa of the surface<a name='583'></font>
         <font color=#447700>!  -----------------------------------------------------<a name='584'></font>
         pdiff = ( p (sfc) - p (k) ) / REAL ( 100 )<a name='585'>
         IF ( pdiff &lt;= REAL (100) ) mlev = k<a name='586'>
<a name='587'>
         <font color=#447700>!~ If we've made it past the lowest 180 hPa, exit the loop<a name='588'></font>
         <font color=#447700>!  -------------------------------------------------------<a name='589'></font>
         IF ( pdiff &gt;= REAL (180) ) EXIT<a name='590'>
<a name='591'>
         IF ( prcl == 1 ) THEN<a name='592'>
            <font color=#447700>!IF ( (p(k) &gt; 70000.0) .and. (w(k) &gt; srcw) ) THEN<a name='593'></font>
            IF ( (w(k) &gt; srcw) ) THEN<a name='594'>
               srctheta = Theta ( tK(k), p(k)/100.0 )<a name='595'>
               srcw = w ( k )<a name='596'>
               srclev  = k<a name='597'>
               srctK   = tK ( k )<a name='598'>
               srcrh   = rh ( k )<a name='599'>
               srcp    = p  ( k )<a name='600'>
            END IF<a name='601'>
         END IF<a name='602'>
   <a name='603'>
      END DO<a name='604'>
   <a name='605'>
      <font color=#447700>!~ If we want the mean layer parcel, compute the mean values in the<a name='606'></font>
      <font color=#447700>!~ lowest 100 hPa.<a name='607'></font>
      <font color=#447700>!  ----------------------------------------------------------------<a name='608'></font>
      lyrcnt =  mlev - sfc + 1<a name='609'>
      IF ( prcl == 2 ) THEN<a name='610'>
   <a name='611'>
         srclev   = sfc<a name='612'>
         srctK    = SUM ( tK (sfc:mlev) ) / REAL ( lyrcnt )<a name='613'>
         srcw     = SUM ( w  (sfc:mlev) ) / REAL ( lyrcnt )<a name='614'>
         srcrh    = SUM ( rh (sfc:mlev) ) / REAL ( lyrcnt )<a name='615'>
         srcp     = SUM ( p  (sfc:mlev) ) / REAL ( lyrcnt )<a name='616'>
         srctheta = Theta ( srctK, srcp/100. )<a name='617'>
   <a name='618'>
      END IF<a name='619'>
   <a name='620'>
      srcthetaeK = Thetae ( srctK, srcp/100.0, srcrh, srcw )<a name='621'>
   <a name='622'>
      <font color=#447700>!~ Calculate temperature and pressure of the LCL<a name='623'></font>
      <font color=#447700>!  ---------------------------------------------<a name='624'></font>
      tlclK = TLCL ( tK(srclev), rh(srclev) )<a name='625'>
      plcl  = p(srclev) * ( (tlclK/tK(srclev))**(Cp/Rd) )<a name='626'>
   <a name='627'>
      <font color=#447700>!~ Now lift the parcel<a name='628'></font>
      <font color=#447700>!  -------------------<a name='629'></font>
   <a name='630'>
      buoy  = REAL ( 0 )<a name='631'>
      pw    = srcw<a name='632'>
      wflag = .false.<a name='633'>
      DO k  = srclev, nz<a name='634'>
         IF ( p (k) &lt;= plcl ) THEN<a name='635'>
   <a name='636'>
            <font color=#447700>!~ The first level after we pass the LCL, we're still going to<a name='637'></font>
            <font color=#447700>!~ lift the parcel dry adiabatically, as we haven't added the<a name='638'></font>
            <font color=#447700>!~ the required code to switch between the dry adiabatic and moist<a name='639'></font>
            <font color=#447700>!~ adiabatic cooling.  Since the dry version results in a greater<a name='640'></font>
            <font color=#447700>!~ temperature loss, doing that for the first step so we don't over<a name='641'></font>
            <font color=#447700>!~ guesstimate the instability.<a name='642'></font>
            <font color=#447700>!  ----------------------------------------------------------------<a name='643'></font>
   <a name='644'>
            IF ( wflag ) THEN<a name='645'>
               flag  = .false.<a name='646'>
   <a name='647'>
               <font color=#447700>!~ Above the LCL, our parcel is now undergoing moist adiabatic<a name='648'></font>
               <font color=#447700>!~ cooling.  Because of the latent heating being undergone as<a name='649'></font>
               <font color=#447700>!~ the parcel rises above the LFC, must iterative solve for the<a name='650'></font>
               <font color=#447700>!~ parcel temperature using equivalant potential temperature,<a name='651'></font>
               <font color=#447700>!~ which is conserved during both dry adiabatic and<a name='652'></font>
               <font color=#447700>!~ pseudoadiabatic displacements.<a name='653'></font>
               <font color=#447700>!  --------------------------------------------------------------<a name='654'></font>
               ptK   = The2T ( srcthetaeK, p(k), flag )<a name='655'>
   <a name='656'>
               <font color=#447700>!~ Calculate the parcel mixing ratio, which is now changing<a name='657'></font>
               <font color=#447700>!~ as we condense moisture out of the parcel, and is equivalent<a name='658'></font>
               <font color=#447700>!~ to the saturation mixing ratio, since we are, in theory, at<a name='659'></font>
               <font color=#447700>!~ saturation.<a name='660'></font>
               <font color=#447700>!  ------------------------------------------------------------<a name='661'></font>
               pw = SaturationMixingRatio ( ptK, p(k) )<a name='662'>
   <a name='663'>
               <font color=#447700>!~ Now we can calculate the virtual temperature of the parcel<a name='664'></font>
               <font color=#447700>!~ and the surrounding environment to assess the buoyancy.<a name='665'></font>
               <font color=#447700>!  ----------------------------------------------------------<a name='666'></font>
               ptvK  = VirtualTemperature ( ptK, pw )<a name='667'>
               tvK   = VirtualTemperature ( tK (k), w (k) )<a name='668'>
   <a name='669'>
               <font color=#447700>!~ Modification to account for water loading<a name='670'></font>
               <font color=#447700>!  -----------------------------------------<a name='671'></font>
               freeze = 0.033 * ( 263.15 - pTvK )<a name='672'>
               IF ( freeze &gt; 1.0 ) freeze = 1.0<a name='673'>
               IF ( freeze &lt; 0.0 ) freeze = 0.0<a name='674'>
   <a name='675'>
               <font color=#447700>!~ Approximate how much of the water vapor has condensed out<a name='676'></font>
               <font color=#447700>!~ of the parcel at this level<a name='677'></font>
               <font color=#447700>!  ---------------------------------------------------------<a name='678'></font>
               freeze = freeze * 333700.0 * ( srcw - pw ) / 1005.7<a name='679'>
   <a name='680'>
               pTvK = pTvK - pTvK * ( srcw - pw ) + freeze<a name='681'>
               dTvK ( k ) = ptvK - tvK<a name='682'>
               buoy ( k ) = g * ( dTvK ( k ) / tvK )<a name='683'>
   <a name='684'>
            ELSE<a name='685'>
   <a name='686'>
               <font color=#447700>!~ Since the theta remains constant whilst undergoing dry<a name='687'></font>
               <font color=#447700>!~ adiabatic processes, can back out the parcel temperature<a name='688'></font>
               <font color=#447700>!~ from potential temperature below the LCL<a name='689'></font>
               <font color=#447700>!  --------------------------------------------------------<a name='690'></font>
               ptK   = srctheta / ( 100000.0/p(k) )**(Rd/Cp)<a name='691'>
   <a name='692'>
               <font color=#447700>!~ Grab the parcel virtual temperture, can use the source<a name='693'></font>
               <font color=#447700>!~ mixing ratio since we are undergoing dry adiabatic cooling<a name='694'></font>
               <font color=#447700>!  ----------------------------------------------------------<a name='695'></font>
               ptvK  = VirtualTemperature ( ptK, srcw )<a name='696'>
   <a name='697'>
               <font color=#447700>!~ Virtual temperature of the environment<a name='698'></font>
               <font color=#447700>!  --------------------------------------<a name='699'></font>
               tvK   = VirtualTemperature ( tK (k), w (k) )<a name='700'>
   <a name='701'>
               <font color=#447700>!~ Buoyancy at this level<a name='702'></font>
               <font color=#447700>!  ----------------------<a name='703'></font>
               dTvK ( k ) = ptvK - tvK<a name='704'>
               buoy ( k ) = g * ( dtvK ( k ) / tvK )<a name='705'>
   <a name='706'>
               wflag = .true.<a name='707'>
   <a name='708'>
            END IF<a name='709'>
   <a name='710'>
         ELSE<a name='711'>
   <a name='712'>
            <font color=#447700>!~ Since the theta remains constant whilst undergoing dry<a name='713'></font>
            <font color=#447700>!~ adiabatic processes, can back out the parcel temperature<a name='714'></font>
            <font color=#447700>!~ from potential temperature below the LCL<a name='715'></font>
            <font color=#447700>!  --------------------------------------------------------<a name='716'></font>
            ptK   = srctheta / ( 100000.0/p(k) )**(Rd/Cp)<a name='717'>
   <a name='718'>
            <font color=#447700>!~ Grab the parcel virtual temperture, can use the source<a name='719'></font>
            <font color=#447700>!~ mixing ratio since we are undergoing dry adiabatic cooling<a name='720'></font>
            <font color=#447700>!  ----------------------------------------------------------<a name='721'></font>
            ptvK  = VirtualTemperature ( ptK, srcw )<a name='722'>
   <a name='723'>
            <font color=#447700>!~ Virtual temperature of the environment<a name='724'></font>
            <font color=#447700>!  --------------------------------------<a name='725'></font>
            tvK   = VirtualTemperature ( tK (k), w (k) )<a name='726'>
   <a name='727'>
            <font color=#447700>!~ Buoyancy at this level<a name='728'></font>
            <font color=#447700>!  ---------------------<a name='729'></font>
            dTvK ( k ) = ptvK - tvK<a name='730'>
            buoy ( k ) = g * ( dtvK ( k ) / tvK )<a name='731'>
   <a name='732'>
         END IF<a name='733'>
<a name='734'>
         <font color=#447700>!~ Chirp<a name='735'></font>
         <font color=#447700>!  -----<a name='736'></font>
  <font color=#447700>!          WRITE ( *,'(I15,6F15.3)' )k,p(k)/100.,ptK,pw*1000.,ptvK,tvK,buoy(k)<a name='737'></font>
   <a name='738'>
      END DO<a name='739'>
   <a name='740'>
      <font color=#447700>!~ Add up the buoyancies, find the LFC<a name='741'></font>
      <font color=#447700>!  -----------------------------------<a name='742'></font>
      flag   = .false.<a name='743'>
      lfclev = -1<a name='744'>
      nbuoy  = REAL ( 0 )<a name='745'>
      pbuoy = REAL ( 0 )<a name='746'>
      DO k = sfc + 1, nz<a name='747'>
         IF ( tK (k) &lt; 253.15 ) EXIT<a name='748'>
         CAPE = CAPE + MAX ( buoy (k), 0.0 ) * ( hgt (k) - hgt (k-1) )<a name='749'>
         CIN  = CIN  + MIN ( buoy (k), 0.0 ) * ( hgt (k) - hgt (k-1) )<a name='750'>
   <a name='751'>
         <font color=#447700>!~ If we've already passed the LFC<a name='752'></font>
         <font color=#447700>!  -------------------------------<a name='753'></font>
         IF ( flag .and. buoy (k) &gt; REAL (0) ) THEN<a name='754'>
            pbuoy = pbuoy + buoy (k)<a name='755'>
         END IF<a name='756'>
   <a name='757'>
         <font color=#447700>!~ We are buoyant now - passed the LFC<a name='758'></font>
         <font color=#447700>!  -----------------------------------<a name='759'></font>
         IF ( .not. flag .and. buoy (k) &gt; REAL (0) .and. p (k) &lt; plcl ) THEN<a name='760'>
            flag = .true.<a name='761'>
            pbuoy = pbuoy + buoy (k)<a name='762'>
            lfclev = k<a name='763'>
         END IF<a name='764'>
   <a name='765'>
         <font color=#447700>!~ If we think we've passed the LFC, but encounter a negative layer<a name='766'></font>
         <font color=#447700>!~ start adding it up.<a name='767'></font>
         <font color=#447700>!  ----------------------------------------------------------------<a name='768'></font>
         IF ( flag .and. buoy (k) &lt; REAL (0) ) THEN<a name='769'>
            nbuoy = nbuoy + buoy (k)<a name='770'>
<a name='771'>
            <font color=#447700>!~ If the accumulated negative buoyancy is greater than the<a name='772'></font>
            <font color=#447700>!~ positive buoyancy, then we are capped off.  Got to go higher<a name='773'></font>
            <font color=#447700>!~ to find the LFC. Reset positive and negative buoyancy summations<a name='774'></font>
            <font color=#447700>!  ----------------------------------------------------------------<a name='775'></font>
            IF ( ABS (nbuoy) &gt; pbuoy ) THEN<a name='776'>
               flag   = .false.<a name='777'>
               nbuoy  = REAL ( 0 )<a name='778'>
               pbuoy  = REAL ( 0 )<a name='779'>
               lfclev = -1<a name='780'>
            END IF<a name='781'>
         END IF<a name='782'>
<a name='783'>
      END DO<a name='784'>
<a name='785'>
      <font color=#447700>!~ Calculate lifted index by interpolating difference between<a name='786'></font>
      <font color=#447700>!~ parcel and ambient Tv to 500mb.<a name='787'></font>
      <font color=#447700>!  ----------------------------------------------------------<a name='788'></font>
      DO k = sfc + 1, nz<a name='789'>
<a name='790'>
         pm = 50000.<a name='791'>
         pu = p ( k )<a name='792'>
         pd = p ( k - 1 )<a name='793'>
<a name='794'>
         <font color=#447700>!~ If we're already above 500mb just set lifted index to 0.<a name='795'></font>
         <font color=#447700>!~ --------------------------------------------------------<a name='796'></font>
         IF ( pd .le. pm ) THEN<a name='797'>
            lidx = 0.<a name='798'>
            EXIT<a name='799'>
   <a name='800'>
         ELSEIF ( pu .le. pm .and. pd .gt. pm) THEN<a name='801'>
<a name='802'>
            <font color=#447700>!~ Found trapping pressure: up, middle, down.<a name='803'></font>
            <font color=#447700>!~ We are doing first order interpolation.  <a name='804'></font>
            <font color=#447700>!  ------------------------------------------<a name='805'></font>
            lidxu = -dTvK ( k ) * ( pu / 100000. ) ** (Rd/Cp)<a name='806'>
            lidxd = -dTvK ( k-1 ) * ( pd / 100000. ) ** (Rd/Cp)<a name='807'>
            lidx = ( lidxu * (pm-pd) + lidxd * (pu-pm) ) / (pu-pd)<a name='808'>
            EXIT<a name='809'>
<a name='810'>
         ENDIF<a name='811'>
<a name='812'>
      END DO<a name='813'>
   <a name='814'>
      <font color=#447700>!~ Assuming the the LFC is at a pressure level for now<a name='815'></font>
      <font color=#447700>!  ---------------------------------------------------<a name='816'></font>
      IF ( lfclev &gt; 0 ) THEN<a name='817'>
         PLFC = p   ( lfclev )<a name='818'>
         ZLFC = hgt ( lfclev )<a name='819'>
      END IF<a name='820'>
   <a name='821'>
      IF ( PLFC /= PLFC .OR. PLFC &lt; REAL (0) ) THEN<a name='822'>
         PLFC = REAL ( -1 )<a name='823'>
         ZLFC = REAL ( -1 )<a name='824'>
      END IF<a name='825'>
   <a name='826'>
      IF ( CAPE /= CAPE ) cape = REAL ( 0 )<a name='827'>
   <a name='828'>
      IF ( CIN  /= CIN  ) cin  = REAL ( 0 )<a name='829'>
<a name='830'>
      <font color=#447700>!~ Chirp<a name='831'></font>
      <font color=#447700>!  -----<a name='832'></font>
  <font color=#447700>!       WRITE ( *,* ) ' CAPE: ', cape, ' CIN:  ', cin<a name='833'></font>
  <font color=#447700>!       WRITE ( *,* ) ' LFC:  ', ZLFC, ' PLFC: ', PLFC<a name='834'></font>
  <font color=#447700>!       WRITE ( *,* ) ''<a name='835'></font>
  <font color=#447700>!       WRITE ( *,* ) ' Exiting buoyancy.'<a name='836'></font>
  <font color=#447700>!       WRITE ( *,* ) ' ==================================== '<a name='837'></font>
  <font color=#447700>!       WRITE ( *,* ) ''<a name='838'></font>
   <a name='839'>
  END FUNCTION Buoyancy <a name='840'>
<a name='841'>
<a name='842'>
<a name='843'>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='844'></font>
<font color=#447700>!                .      .    .<a name='845'></font>
<font color=#447700>! SUBPROGRAM:    NGMSLP      NMC SEA LEVEL PRESSURE REDUCTION<a name='846'></font>
<font color=#447700>!   PRGRMMR: TREADON         ORG: W/NP2      DATE: 93-02-02<a name='847'></font>
<font color=#447700>!<a name='848'></font>
<font color=#447700>! ABSTRACT:<a name='849'></font>
<font color=#447700>!<a name='850'></font>
<font color=#447700>!     THIS ROUTINE COMPUTES SEA LEVEL PRESSURE USING THE<a name='851'></font>
<font color=#447700>!     HYDROSTATIC EQUATION WITH THE SHUELL CORRECTION.  THE<a name='852'></font>
<font color=#447700>!     FOLLOWING IS BASED ON DOCUMENTATION IN SUBROUTINE<a name='853'></font>
<font color=#447700>!     OUTHYDRO OF THE NGM:<a name='854'></font>
<font color=#447700>!<a name='855'></font>
<font color=#447700>!     THE FUNDAMENTAL HYDROSTATIC EQUATION IS<a name='856'></font>
<font color=#447700>!        D(HEIGHT)<a name='857'></font>
<font color=#447700>!        ---------  =  TAU = VIRTUAL TEMPERATURE * (RGAS/GRAVITY)<a name='858'></font>
<font color=#447700>!        D (Z)<a name='859'></font>
<font color=#447700>!      WHERE<a name='860'></font>
<font color=#447700>!        Z = MINUS LOG OF PRESSURE (-LN(P)).<a name='861'></font>
<font color=#447700>!<a name='862'></font>
<font color=#447700>!     SEA-LEVEL PRESSURE IS COMPUTED FROM THE FORMULA<a name='863'></font>
<font color=#447700>!        PRESS(MSL) = PRESS(GROUND) * EXP( F)<a name='864'></font>
<font color=#447700>!     WHERE<a name='865'></font>
<font color=#447700>!        F        = HEIGHT OF GROUND / MEAN TAU<a name='866'></font>
<font color=#447700>!        MEAN TAU = ( TAU(GRND) + TAU(SL) ) / 2<a name='867'></font>
<font color=#447700>!<a name='868'></font>
<font color=#447700>!     IN THE NGM TAU(GRND) AND TAU(SL) ARE FIRST SET USING A<a name='869'></font>
<font color=#447700>!     6.5DEG/KM LAPSE RATE FROM LOWEST MDL LEVEL.  THIS IS MODIFIED<a name='870'></font>
<font color=#447700>!     BY A CORRECTION BASED ON THE CRITICAL TAU OF THE SHUELL<a name='871'></font>
<font color=#447700>!     CORRECTION:<a name='872'></font>
<font color=#447700>!                  TAUCR=(RGASD/GRAVITY) * 290.66<a name='873'></font>
<font color=#447700>!  <a name='874'></font>
<font color=#447700>!     1) WHERE ONLY TAU(SL) EXCEEDS TAUCR, CHANGE TAU(SL) TO TAUCR.<a name='875'></font>
<font color=#447700>!<a name='876'></font>
<font color=#447700>!     2) WHERE BOTH TAU(SL) AND TAU(GRND) EXCEED TAUCR,<a name='877'></font>
<font color=#447700>!        CHANGE TAU(SL) TO TAUCR-CONST*(TAU(GRND)-TAUCR  )**2<a name='878'></font>
<font color=#447700>!        WHERE CONST = .005 (GRAVITY/RGASD)<a name='879'></font>
<font color=#447700>!  <a name='880'></font>
<font color=#447700>!     THE AVERAGE OF TAU(SL) AND TAU(GRND) IS THEN USED TOGETHER<a name='881'></font>
<font color=#447700>!     WITH THE GROUND HEIGHT AND PRESSURE TO DERIVE THE PRESSURE<a name='882'></font>
<font color=#447700>!     AT SEA LEVEL.<a name='883'></font>
<font color=#447700>!    <a name='884'></font>
<font color=#447700>!     HEIGHT OF THE 1000MB SURFACE IS COMPUTED FROM THE MSL PRESSURE<a name='885'></font>
<font color=#447700>!     FIELD USING THE FORMULA:<a name='886'></font>
<font color=#447700>!    <a name='887'></font>
<font color=#447700>!       P(MSL) - P(1000MB) = MEAN DENSITY * GRAVITY * HGT(1000MBS)<a name='888'></font>
<font color=#447700>!    <a name='889'></font>
<font color=#447700>!     WHERE P(MSL) IS THE SEA LEVEL PRESSURE FIELD WE HAVE JUST<a name='890'></font>
<font color=#447700>!     COMPUTED.<a name='891'></font>
<font color=#447700>!    <a name='892'></font>
<font color=#447700>!<a name='893'></font>
<font color=#447700>!     MEB 6/13/02: THIS CODE HAS BEEN SIMPLIFIED CONSIDERABLY FROM<a name='894'></font>
<font color=#447700>!     THE ONE USED IN ETAPOST.  HORIZONTAL SMOOTHING HAS BEEN<a name='895'></font>
<font color=#447700>!     REMOVED AND THE FIRST MODEL LEVEL IS USED RATHER<a name='896'></font>
<font color=#447700>!     THAN THE MEAN OF THE VIRTUAL TEMPERATURES IN<a name='897'></font>
<font color=#447700>!     THE LOWEST 30MB ABOVE GROUND TO COMPUTE TAU(GRND).<a name='898'></font>
<font color=#447700>!    <a name='899'></font>
<font color=#447700>!   . <a name='900'></font>
<font color=#447700>!    <a name='901'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='902'></font>
<font color=#447700>!   93-02-02  RUSS TREADON<a name='903'></font>
<font color=#447700>!   98-06-08  T BLACK - CONVERSION FROM 1-D TO 2-D<a name='904'></font>
<font color=#447700>!   00-01-04  JIM TUCCILLO - MPI VERSION<a name='905'></font>
<font color=#447700>!   01-10-25  H CHUANG - MODIFIED TO PROCESS HYBRID MODEL OUTPUT<a name='906'></font>
<font color=#447700>!   01-11-02  H CHUANG - MODIFIED LINE 234 FOR COMPUTATION OF<a name='907'></font>
<font color=#447700>!                         SIGMA/HYBRID SLP<a name='908'></font>
<font color=#447700>!   01-12-18  H CHUANG - INCLUDED SMOOTHING ALONG BOUNDARIES TO BE<a name='909'></font>
<font color=#447700>!                         CONSISTENT WITH MESINGER SLP<a name='910'></font>
<font color=#447700>!   02-06-13  MIKE BALDWIN - WRF VERSION<a name='911'></font>
<font color=#447700>!   06-12-18  H CHUANG - BUG FIX TO CORRECT TAU AT SFC<a name='912'></font>
<font color=#447700>!   14-04-17  G CREIGHTON - MODIFIED TO INSERT INTO AFWA DIAGNOSTICS IN WRF<a name='913'></font>
<font color=#447700>!    <a name='914'></font>
<font color=#447700>!$$$ <a name='915'></font>
<a name='916'>
<A NAME='MSLP'><A href='../../html_code/phys/module_diag_afwa.F.html#MSLP' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='917'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>MSLP</font> ( zsfc, psfc, zlev1, qlev1, tlev1 ) <A href='../../call_to/MSLP.html' TARGET='index'>6</A><a name='918'>
<a name='919'>
      implicit none<a name='920'>
     <a name='921'>
     <a name='922'>
<font color=#447700>!     DECLARE VARIABLES<a name='923'></font>
<a name='924'>
      REAL,    INTENT ( IN )  :: zsfc         <font color=#447700>!~ Surface height ( m )<a name='925'></font>
      REAL,    INTENT ( IN )  :: psfc         <font color=#447700>!~ Surface height ( m )<a name='926'></font>
      REAL,    INTENT ( IN )  :: zlev1        <font color=#447700>!~ Level 1 height ( m )<a name='927'></font>
      REAL,    INTENT ( IN )  :: qlev1        <font color=#447700>!~ Level 1 mixing ratio ( kg/kg )<a name='928'></font>
      REAL,    INTENT ( IN )  :: tlev1        <font color=#447700>!~ Level 1 temperature ( K )<a name='929'></font>
      real,PARAMETER :: G=9.81<a name='930'>
      real,PARAMETER :: GI=1./G<a name='931'>
      real,PARAMETER :: RD=287.0<a name='932'>
      real,PARAMETER :: ZSL=0.0<a name='933'>
      real,PARAMETER :: TAUCR=RD*GI*290.66,CONST=0.005*G/RD<a name='934'>
      real,PARAMETER :: GORD=G/RD,DP=60.E2<a name='935'>
      real,PARAMETER :: GAMMA=6.5E-3<a name='936'>
<a name='937'>
      real MSLP,TVRT,TVRSFC,TAUSFC,TVRSL,TAUSL,TAUAVG<a name='938'>
<font color=#447700>!    <a name='939'></font>
<font color=#447700>!**********************************************************************<a name='940'></font>
<font color=#447700>!     START NGMSLP HERE.<a name='941'></font>
<font color=#447700>!<a name='942'></font>
         MSLP = PSFC<a name='943'>
<font color=#447700>!<a name='944'></font>
<font color=#447700>!        COMPUTE LAYER TAU (VIRTUAL TEMP*RD/G).<a name='945'></font>
         TVRT = TLEV1*(1.0+0.608*QLEV1)<a name='946'>
         <font color=#447700>!TAU  = TVRT*RD*GI<a name='947'></font>
<font color=#447700>!    <a name='948'></font>
<font color=#447700>!        COMPUTE TAU AT THE GROUND (Z=ZSFC) AND SEA LEVEL (Z=0)<a name='949'></font>
<font color=#447700>!        ASSUMING A CONSTANT LAPSE RATE OF GAMMA=6.5DEG/KM.<a name='950'></font>
         TVRSFC = TVRT + (ZLEV1 - ZSFC)*GAMMA<a name='951'>
         TAUSFC = TVRSFC*RD*GI<a name='952'>
         TVRSL  = TVRT + (ZLEV1 - ZSL)*GAMMA<a name='953'>
         TAUSL  = TVRSL*RD*GI<a name='954'>
<font color=#447700>!    <a name='955'></font>
<font color=#447700>!        IF NEED BE APPLY SHEULL CORRECTION.<a name='956'></font>
         IF ((TAUSL.GT.TAUCR).AND.(TAUSFC.LE.TAUCR)) THEN<a name='957'>
            TAUSL=TAUCR<a name='958'>
         ELSEIF ((TAUSL.GT.TAUCR).AND.(TAUSFC.GT.TAUCR)) THEN<a name='959'>
            TAUSL = TAUCR-CONST*(TAUSFC-TAUCR)**2<a name='960'>
         ENDIF<a name='961'>
<font color=#447700>!    <a name='962'></font>
<font color=#447700>!        COMPUTE MEAN TAU.<a name='963'></font>
         TAUAVG = 0.5*(TAUSL+TAUSFC)<a name='964'>
<font color=#447700>!    <a name='965'></font>
<font color=#447700>!        COMPUTE SEA LEVEL PRESSURE.<a name='966'></font>
         MSLP = PSFC*EXP(ZSFC/TAUAVG)<a name='967'>
<a name='968'>
  END FUNCTION MSLP<a name='969'>
<a name='970'>
<a name='971'>
<a name='972'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='973'></font>
  <font color=#447700>!~                                                                          ~!<a name='974'></font>
  <font color=#447700>!~ Name:                                                                    ~!<a name='975'></font>
  <font color=#447700>!~    calc_fits                                                             ~!<a name='976'></font>
  <font color=#447700>!~                                                                          ~!<a name='977'></font>
  <font color=#447700>!~ Description:                                                             ~!<a name='978'></font>
  <font color=#447700>!~    This function computes Fighter Index Thermal Stress values given      ~!<a name='979'></font>
  <font color=#447700>!~    dry bulb temperature, relative humidity, and pressure.                ~!<a name='980'></font>
  <font color=#447700>!~                                                                          ~!<a name='981'></font>
  <font color=#447700>!~ Usage:                                                                   ~!<a name='982'></font>
  <font color=#447700>!~    fitsval = calc_fits ( p, tK, rh )                                     ~!<a name='983'></font>
  <font color=#447700>!~                                                                          ~!<a name='984'></font>
  <font color=#447700>!~ Where:                                                                   ~!<a name='985'></font>
  <font color=#447700>!~    p   = Pressure ( Pa )                                                 ~!<a name='986'></font>
  <font color=#447700>!~    tK  = Temperature ( K )                                               ~!<a name='987'></font>
  <font color=#447700>!~    rh  = Relative Humidity ( % )                                         ~!<a name='988'></font>
  <font color=#447700>!~                                                                          ~!<a name='989'></font>
  <font color=#447700>!~ Reference:                                                               ~!<a name='990'></font>
  <font color=#447700>!~    Stribley, R.F., S. Nunneley, 1978: Fighter Index of Thermal Stress:   ~!<a name='991'></font>
  <font color=#447700>!~    Development of interim guidance for hot-weather USAF operations.      ~!<a name='992'></font>
  <font color=#447700>!~    SAM-TR-78-6. Eqn. 9                                                   ~!<a name='993'></font>
  <font color=#447700>!~                                                                          ~!<a name='994'></font>
  <font color=#447700>!~    Formula:                                                              ~!<a name='995'></font>
  <font color=#447700>!~       FITS = 0.8281*Twb + 0.3549*Tdb + 5.08 (degrees Celsius)            ~!<a name='996'></font>
  <font color=#447700>!~                                                                          ~!<a name='997'></font>
  <font color=#447700>!~    Where:                                                                ~!<a name='998'></font>
  <font color=#447700>!~       Twb = Wet Bulb Temperature                                         ~!<a name='999'></font>
  <font color=#447700>!~       Tdb = Dry Bulb Temperature                                         ~!<a name='1000'></font>
  <font color=#447700>!~                                                                          ~!<a name='1001'></font>
  <font color=#447700>!~ Written:                                                                 ~!<a name='1002'></font>
  <font color=#447700>!~    Scott Rentschler, Software Engineering Services                       ~!<a name='1003'></font>
  <font color=#447700>!~    Fine Scale Models Team                                                ~!<a name='1004'></font>
  <font color=#447700>!~    Air Force Weather Agency, 16WS/WXN                                    ~!<a name='1005'></font>
  <font color=#447700>!~    DSN: 271-3331 Comm: (402) 294-3331                                    ~!<a name='1006'></font>
  <font color=#447700>!~    scott.rentschler@offutt.af.mil                                        ~!<a name='1007'></font>
  <font color=#447700>!~                                                                          ~!<a name='1008'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1009'></font>
<A NAME='CALC_FITS'><A href='../../html_code/phys/module_diag_afwa.F.html#CALC_FITS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1010'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>calc_fits</font> ( p, tK, rh ) RESULT ( fits )<a name='1011'>
 <a name='1012'>
    implicit none<a name='1013'>
<a name='1014'>
    <font color=#447700>!~ Variable declaration<a name='1015'></font>
    <font color=#447700>!  --------------------<a name='1016'></font>
    real, intent ( in ) :: p               <font color=#447700>!~ Pressure ( Pa )<a name='1017'></font>
    real, intent ( in ) :: tK              <font color=#447700>!~ Temperature ( K )<a name='1018'></font>
    real, intent ( in ) :: rh              <font color=#447700>!~ Rel Humidity ( % )<a name='1019'></font>
    real                :: fits            <font color=#447700>!~ FITS index value<a name='1020'></font>
 <a name='1021'>
    <font color=#447700>!~ Utility variables<a name='1022'></font>
    <font color=#447700>!  --------------------------<a name='1023'></font>
    real                :: twb             <font color=#447700>!~ Wet bulb temperature ( C )<a name='1024'></font>
    real                :: wbt<a name='1025'>
 <a name='1026'>
    <font color=#447700>! ---------------------------------------------------------------------- !<a name='1027'></font>
    <font color=#447700>! ---------------------------------------------------------------------- !<a name='1028'></font>
<a name='1029'>
    <font color=#447700>!~ Initialize variables<a name='1030'></font>
    <font color=#447700>!  --------------------<a name='1031'></font>
    fits = REAL ( 0 )<a name='1032'>
<a name='1033'>
    <font color=#447700>!~ Get the wet bulb temperature in degrees Celsius<a name='1034'></font>
    <font color=#447700>!  -----------------------------------------------<a name='1035'></font>
    twb =  WetBulbTemp ( p, tK, rh ) - 273.15 <a name='1036'>
<a name='1037'>
    <font color=#447700>!~ Compute the FITS index<a name='1038'></font>
    <font color=#447700>!  ----------------------<a name='1039'></font>
    fits = 0.8281*twb + 0.3549*( tK - 273.15 ) + 5.08<a name='1040'>
 <a name='1041'>
    <font color=#447700>!~ Convert the index to Kelvin<a name='1042'></font>
    <font color=#447700>!  ---------------------------<a name='1043'></font>
    fits = fits + 273.15<a name='1044'>
<a name='1045'>
  END FUNCTION calc_fits<a name='1046'>
<a name='1047'>
<a name='1048'>
<a name='1049'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1050'></font>
  <font color=#447700>!~<a name='1051'></font>
  <font color=#447700>!~ Name:<a name='1052'></font>
  <font color=#447700>!~    calc_wc   <a name='1053'></font>
  <font color=#447700>!~<a name='1054'></font>
  <font color=#447700>!~ Description:<a name='1055'></font>
  <font color=#447700>!~    This function calculates wind chill given temperature ( K ) and<a name='1056'></font>
  <font color=#447700>!~    wind speed ( m/s )<a name='1057'></font>
  <font color=#447700>!~<a name='1058'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1059'></font>
<A NAME='CALC_WC'><A href='../../html_code/phys/module_diag_afwa.F.html#CALC_WC' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1060'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>calc_wc</font> ( tK, wspd ) RESULT ( wc )<a name='1061'>
<a name='1062'>
    implicit none<a name='1063'>
<a name='1064'>
    <font color=#447700>!~ Variable Declarations<a name='1065'></font>
    <font color=#447700>!  ---------------------<a name='1066'></font>
    real, intent ( in  ) :: tK<a name='1067'>
    real, intent ( in  ) :: wspd<a name='1068'>
<a name='1069'>
    real                 :: tF, wc, wspd_mph<a name='1070'>
<a name='1071'>
    wspd_mph = wspd * 2.23693629 <font color=#447700>! convert to mph<a name='1072'></font>
    tF  = (( tK - 273.15 ) * ( REAL (9) / REAL (5) ) ) + REAL ( 32 )<a name='1073'>
<a name='1074'>
    wc =    35.74                           &amp;<a name='1075'>
       +  (  0.6215 * tF                  ) &amp;<a name='1076'>
       -  ( 35.75   *      ( wspd_mph**0.16 ) ) &amp;<a name='1077'>
       +  (  0.4275 * tF * ( wspd_mph**0.16 ) )<a name='1078'>
<a name='1079'>
    wc = (( wc - REAL (32) ) * ( REAL (5) / REAL (9) ) ) + 273.15<a name='1080'>
<a name='1081'>
  END FUNCTION calc_wc<a name='1082'>
<a name='1083'>
<a name='1084'>
<a name='1085'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1086'></font>
  <font color=#447700>!~<a name='1087'></font>
  <font color=#447700>!~ Name:<a name='1088'></font>
  <font color=#447700>!~    calc_hi   <a name='1089'></font>
  <font color=#447700>!~<a name='1090'></font>
  <font color=#447700>!~ Description:<a name='1091'></font>
  <font color=#447700>!~    This subroutine calculates the heat index.  Requires temperature ( K )<a name='1092'></font>
  <font color=#447700>!~    and relative humidity ( % ).<a name='1093'></font>
  <font color=#447700>!~ <a name='1094'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1095'></font>
<A NAME='CALC_HI'><A href='../../html_code/phys/module_diag_afwa.F.html#CALC_HI' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1096'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>calc_hi</font> ( Tk, RH ) result ( HI )<a name='1097'>
<a name='1098'>
    implicit none<a name='1099'>
<a name='1100'>
    <font color=#447700>!~ Variable declarations<a name='1101'></font>
    <font color=#447700>!  ---------------------<a name='1102'></font>
    real, intent ( in  ) :: Tk<a name='1103'>
    real, intent ( in  ) :: RH<a name='1104'>
<a name='1105'>
    real :: tF, tF2, rh2, HI<a name='1106'>
<a name='1107'>
    <font color=#447700>!~ If temperature &gt; 70F then calculate heat index, else set it equal<a name='1108'></font>
    <font color=#447700>!~ to dry temperature<a name='1109'></font>
    <font color=#447700>!  -----------------------------------------------------------------<a name='1110'></font>
    IF ( Tk &gt; 294.26111 ) THEN<a name='1111'>
<a name='1112'>
      tF   = ( (Tk - 273.15) * (REAL (9)/REAL (5))  ) + REAL ( 32 )<a name='1113'>
      tF2  = tF ** 2<a name='1114'>
      rh2  = RH ** 2<a name='1115'>
<a name='1116'>
      HI =  -42.379 &amp;<a name='1117'>
         +  (  2.04901523   * tF              ) &amp;<a name='1118'>
         +  ( 10.14333127   * RH              ) &amp;<a name='1119'>
         -  (  0.22475541   * tF  * RH        ) &amp;<a name='1120'>
         -  (  6.83783E-03  * tF2             ) &amp;<a name='1121'>
         -  (  5.481717E-02 * rh2             ) &amp;<a name='1122'>
         +  (  1.22874E-03  * tF2 * RH        ) &amp;<a name='1123'>
         +  (  8.5282E-04   * tF  * rh2       ) &amp;<a name='1124'>
         -  (  1.99E-06     * tF2 * rh2       )<a name='1125'>
<a name='1126'>
      HI = ((HI - REAL (32)) * (REAL (5)/REAL (9))) + 273.15<a name='1127'>
    ELSE<a name='1128'>
      HI = Tk<a name='1129'>
    END IF<a name='1130'>
<a name='1131'>
  END FUNCTION calc_hi<a name='1132'>
<a name='1133'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1134'></font>
  <font color=#447700>!~                                                                          ~!<a name='1135'></font>
  <font color=#447700>!~ Name:                                                                    ~!<a name='1136'></font>
  <font color=#447700>!~    WetBulbTemp                                                           ~!<a name='1137'></font>
  <font color=#447700>!~                                                                          ~!<a name='1138'></font>
  <font color=#447700>!~ Description:                                                             ~!<a name='1139'></font>
  <font color=#447700>!~    This function approximates the Wet Bulb Temperature (K) provided      ~!<a name='1140'></font>
  <font color=#447700>!~    dry bulb temperature (K), relative humidity (%), and pressure (Pa).   ~!<a name='1141'></font>
  <font color=#447700>!~                                                                          ~!<a name='1142'></font>
  <font color=#447700>!~ Usage:                                                                   ~!<a name='1143'></font>
  <font color=#447700>!~    wbt = WetBulbTemperature ( p, tK, rh )                                ~!<a name='1144'></font>
  <font color=#447700>!~                                                                          ~!<a name='1145'></font>
  <font color=#447700>!~ Where:                                                                   ~!<a name='1146'></font>
  <font color=#447700>!~    p  = Pressure ( Pa )                                                  ~!<a name='1147'></font>
  <font color=#447700>!~    tK = Temperature ( K )                                                ~!<a name='1148'></font>
  <font color=#447700>!~    rh = Relative Humidity ( % )                                          ~!<a name='1149'></font>
  <font color=#447700>!~                                                                          ~!<a name='1150'></font>
  <font color=#447700>!~ Reference:                                                               ~!<a name='1151'></font>
  <font color=#447700>!~    American Society of Civil Engineers                                   ~!<a name='1152'></font>
  <font color=#447700>!~    Evapotraspiration and Irrigation Water Requirements                   ~!<a name='1153'></font>
  <font color=#447700>!~    Jensen et al (1990) ASCE Manual No. 70, pp 176-177                    ~!<a name='1154'></font>
  <font color=#447700>!~                                                                          ~!<a name='1155'></font>
  <font color=#447700>!~ Written:                                                                 ~!<a name='1156'></font>
  <font color=#447700>!~    Scott Rentschler, Software Engineering Services                       ~!<a name='1157'></font>
  <font color=#447700>!~    Fine Scale Models Team                                                ~!<a name='1158'></font>
  <font color=#447700>!~    Air Force Weather Agency                                              ~!<a name='1159'></font>
  <font color=#447700>!~    DSM: 271-3331 Comm: (402) 294-3331                                    ~!<a name='1160'></font>
  <font color=#447700>!~    scott.rentschler@offutt.af.mil                                        ~!<a name='1161'></font>
  <font color=#447700>!~                                                                          ~!<a name='1162'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1163'></font>
<A NAME='WETBULBTEMP'><A href='../../html_code/phys/module_diag_afwa.F.html#WETBULBTEMP' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1164'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>WetBulbTemp</font> ( p, tK, rh) result( wbt )<a name='1165'>
<a name='1166'>
    implicit none<a name='1167'>
<a name='1168'>
    <font color=#447700>!~ Variable delclaration<a name='1169'></font>
    <font color=#447700>!  ---------------------<a name='1170'></font>
    real, intent ( in ) :: p        <font color=#447700>!~ Pressure ( Pa )<a name='1171'></font>
    real, intent ( in ) :: tK       <font color=#447700>!~ Temperature ( K )<a name='1172'></font>
    real, intent ( in ) :: rh       <font color=#447700>!~ Relative Humidity ( % )<a name='1173'></font>
    real                :: wbt      <font color=#447700>!~ Wet Bulb Temperature ( K )<a name='1174'></font>
 <a name='1175'>
    <font color=#447700>!~ Utility variables<a name='1176'></font>
    <font color=#447700>!  -----------------<a name='1177'></font>
    real                :: tdK      <font color=#447700>!~ Dewpoint temperature ( K )<a name='1178'></font>
    real                :: tC       <font color=#447700>!~ Temperature ( C )<a name='1179'></font>
    real                :: tdC      <font color=#447700>!~ Dewpoint temperature ( K )<a name='1180'></font>
    real                :: svapr    <font color=#447700>!~ Saturation vapor pressure ( Pa )<a name='1181'></font>
    real                :: vapr     <font color=#447700>!~ Ambient vapor pressure ( Pa )<a name='1182'></font>
    real                :: gamma    <font color=#447700>!~ Dummy term<a name='1183'></font>
    real                :: delta    <font color=#447700>!~ Dummy term<a name='1184'></font>
<a name='1185'>
    <font color=#447700>! ---------------------------------------------------------------------- !<a name='1186'></font>
    <font color=#447700>! ---------------------------------------------------------------------- !          <a name='1187'></font>
    <font color=#447700>!~ Initialize variables<a name='1188'></font>
    <font color=#447700>!  --------------------<a name='1189'></font>
    wbt = REAL ( 0 )<a name='1190'>
    tC  = tK - 273.15<a name='1191'>
<a name='1192'>
    <font color=#447700>!~ Compute saturation vapor pressure ( Pa )<a name='1193'></font>
    <font color=#447700>!  ----------------------------------------<a name='1194'></font>
    svapr = calc_es ( tK ) * REAL ( 100 )<a name='1195'>
<a name='1196'>
    <font color=#447700>!~ Compute vapor pressure<a name='1197'></font>
    <font color=#447700>!  ----------------------<a name='1198'></font>
    vapr  = svapr * ( rh / REAL (100) )<a name='1199'>
<a name='1200'>
    <font color=#447700>!~ Grab the dewpoint<a name='1201'></font>
    <font color=#447700>!  -----------------<a name='1202'></font>
    tdC = calc_Dewpoint ( tC, rh )<a name='1203'>
    tdK = tdC + 273.15<a name='1204'>
<a name='1205'>
    <font color=#447700>!~ Compute dummy terms<a name='1206'></font>
    <font color=#447700>!  -------------------<a name='1207'></font>
    gamma = 0.00066 * ( p / REAL (1000) )<a name='1208'>
    delta = REAL ( 4098 ) * ( vapr / REAL(1000) )  / ( (tC+237.3)**2 )<a name='1209'>
<a name='1210'>
    <font color=#447700>!~ Compute the wet bulb temperature<a name='1211'></font>
    <font color=#447700>!  --------------------------------<a name='1212'></font>
    wbt = ( ((gamma * tC) + (delta * tdC)) / (gamma + delta) ) + 273.15<a name='1213'>
<a name='1214'>
  END FUNCTION WetBulbTemp<a name='1215'>
<a name='1216'>
<a name='1217'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1218'></font>
  <font color=#447700>!~<a name='1219'></font>
  <font color=#447700>!~ Name:<a name='1220'></font>
  <font color=#447700>!~    calc_Dewpoint<a name='1221'></font>
  <font color=#447700>!~<a name='1222'></font>
  <font color=#447700>!~ Description:<a name='1223'></font>
  <font color=#447700>!~    This function approximates dewpoint given temperature and rh.<a name='1224'></font>
  <font color=#447700>!~<a name='1225'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1226'></font>
<A NAME='CALC_DEWPOINT'><A href='../../html_code/phys/module_diag_afwa.F.html#CALC_DEWPOINT' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1227'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>calc_Dewpoint</font> ( tC, rh) result( Dewpoint )<a name='1228'>
<a name='1229'>
    implicit none<a name='1230'>
<a name='1231'>
    <font color=#447700>!~ Variable Declaration<a name='1232'></font>
    <font color=#447700>!  --------------------<a name='1233'></font>
    real, intent ( in ) :: tC<a name='1234'>
    real, intent ( in ) :: rh<a name='1235'>
    real                :: Dewpoint<a name='1236'>
 <a name='1237'>
    real :: term, es, e1, e, logs, expon<a name='1238'>
<a name='1239'>
    expon    = ( 7.5*tC ) / ( 237.7+tC )<a name='1240'>
    es       = 6.112 * ( 10**expon )     <font color=#447700>! Saturated vapor pressure<a name='1241'></font>
    e        = es * ( rh/100.0 )         <font color=#447700>! Vapor pressure<a name='1242'></font>
    logs     = LOG10 ( e/6.112 )<a name='1243'>
    Dewpoint = ( 237.7*logs ) / ( 7.5-logs )<a name='1244'>
<a name='1245'>
  END FUNCTION calc_Dewpoint<a name='1246'>
<a name='1247'>
<a name='1248'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1249'></font>
  <font color=#447700>!~<a name='1250'></font>
  <font color=#447700>!~ Name:<a name='1251'></font>
  <font color=#447700>!~    calc_es <a name='1252'></font>
  <font color=#447700>!~<a name='1253'></font>
  <font color=#447700>!~ Description:<a name='1254'></font>
  <font color=#447700>!~    This function returns the saturation vapor pressure over water ( hPa )<a name='1255'></font>
  <font color=#447700>!~    given temperature ( K ).<a name='1256'></font>
  <font color=#447700>!~<a name='1257'></font>
  <font color=#447700>!~ References:<a name='1258'></font>
  <font color=#447700>!~    The algorithm is due to Nordquist, W.S., 1973: "Numerical approximations<a name='1259'></font>
  <font color=#447700>!~    of selected meteorological parameters for cloud physics problems,"<a name='1260'></font>
  <font color=#447700>!~    ecom-5475, Atmospheric Sciences Laboratory, U.S. Army Electronics<a name='1261'></font>
  <font color=#447700>!~    Command, White Sands Missile Range, New Mexico, 88002<a name='1262'></font>
  <font color=#447700>!~<a name='1263'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1264'></font>
<A NAME='CALC_ES'><A href='../../html_code/phys/module_diag_afwa.F.html#CALC_ES' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1265'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>calc_es</font> ( tK ) result ( es )<a name='1266'>
<a name='1267'>
    implicit none<a name='1268'>
<a name='1269'>
    <font color=#447700>!~ Variable Declaration<a name='1270'></font>
    <font color=#447700>!  --------------------<a name='1271'></font>
    real, intent ( in ) :: tK<a name='1272'>
    real                :: es<a name='1273'>
 <a name='1274'>
    real                :: p1, p2, c1<a name='1275'>
<a name='1276'>
    p1 = 11.344    - 0.0303998 * tK<a name='1277'>
    p2 = 3.49149   - 1302.8844 / tK<a name='1278'>
    c1 = 23.832241 - 5.02808   * ALOG10 ( tK )<a name='1279'>
    es = 10.**(c1-1.3816E-7*10.**p1+8.1328E-3*10.**p2-2949.076/tK)<a name='1280'>
<a name='1281'>
  END FUNCTION calc_es<a name='1282'>
<a name='1283'>
<a name='1284'>
<a name='1285'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1286'></font>
  <font color=#447700>!~                                                                          ~!<a name='1287'></font>
  <font color=#447700>!~ Name:                                                                    ~!<a name='1288'></font>
  <font color=#447700>!~    CATTurbulence                                                         ~!<a name='1289'></font>
  <font color=#447700>!~                                                                          ~!<a name='1290'></font>
  <font color=#447700>!~ Description:                                                             ~!<a name='1291'></font>
  <font color=#447700>!~    This function calculates the turbulence index ( TI ) for one layer    ~!<a name='1292'></font>
  <font color=#447700>!~    in the atmosphere given the horizontal wind components and the geo-   ~!<a name='1293'></font>
  <font color=#447700>!~    potential height of two pressure levels.  The index is computed for   ~!<a name='1294'></font>
  <font color=#447700>!~    the layer between the levels using the deformation and convergence    ~!<a name='1295'></font>
  <font color=#447700>!~    of the wind field at the top and bottom of the layer and the vertical ~!<a name='1296'></font>
  <font color=#447700>!~    wind shear is calculated within the layer.  The equation used for     ~!<a name='1297'></font>
  <font color=#447700>!~    calculating TI is given by:                                           ~!<a name='1298'></font>
  <font color=#447700>!~                                                                          ~!<a name='1299'></font>
  <font color=#447700>!~                                                                          ~!<a name='1300'></font>
  <font color=#447700>!~       TI = VWS * ( DEF + CONV )                                          ~!<a name='1301'></font>
  <font color=#447700>!~                                                                          ~!<a name='1302'></font>
  <font color=#447700>!~    Where:                                                                ~!<a name='1303'></font>
  <font color=#447700>!~       VWS  = Vertical wind shear                                         ~!<a name='1304'></font>
  <font color=#447700>!~       DEF  = Deformation                                                 ~!<a name='1305'></font>
  <font color=#447700>!~       CONV = Convergence                                                 ~!<a name='1306'></font>
  <font color=#447700>!~                                                                          ~!<a name='1307'></font>
  <font color=#447700>!~ Notes:                                                                   ~!<a name='1308'></font>
  <font color=#447700>!~                                                                          ~!<a name='1309'></font>
  <font color=#447700>!~ References:                                                              ~!<a name='1310'></font>
  <font color=#447700>!~    Ellrod, G.P. and D.J. Knapp, An objective clear-air turbulence        ~!<a name='1311'></font>
  <font color=#447700>!~      forecasting technique: verification and operational use, Weather    ~!<a name='1312'></font>
  <font color=#447700>!~      and Forecasting, 7, March 1992, pp. 150-165.                        ~!<a name='1313'></font>
  <font color=#447700>!~                                                                          ~!<a name='1314'></font>
  <font color=#447700>!~ Written:                                                                 ~!<a name='1315'></font>
  <font color=#447700>!~    Scott Rentschler, Software Engineering Services                       ~!<a name='1316'></font>
  <font color=#447700>!~    Fine Scale Models Team                                                ~!<a name='1317'></font>
  <font color=#447700>!~    Air Force Weather Agency, 16WS/WXN                                    ~!<a name='1318'></font>
  <font color=#447700>!~    DSN: 271-3331 Comm: (402) 294-3331                                    ~!<a name='1319'></font>
  <font color=#447700>!~    scott.rentschler@offutt.af.mil                                        ~!<a name='1320'></font>
  <font color=#447700>!~                                                                          ~!<a name='1321'></font>
  <font color=#447700>!~ History:                                                                 ~!<a name='1322'></font>
  <font color=#447700>!~    1 February 2008 ................... Scott Rentschler, (SES), 2WG/WEA  ~!<a name='1323'></font>
  <font color=#447700>!~    INITIAL VERSION                                                       ~!<a name='1324'></font>
  <font color=#447700>!~                                                                          ~!<a name='1325'></font>
  <font color=#447700>!~    8 July 2009 ....................... Scott Rentschler, (SES), 2WG/WEA  ~!<a name='1326'></font>
  <font color=#447700>!~    Adapted for new driver.                                               ~!<a name='1327'></font>
  <font color=#447700>!~                                                                          ~!<a name='1328'></font>
  <font color=#447700>!~    1 November 2012 ......................... Scott Rentschler, 16WS/WXN  ~!<a name='1329'></font>
  <font color=#447700>!~    Modified to accept layer argument, which adds the flexibility to make ~!<a name='1330'></font>
  <font color=#447700>!~    the computation for whichever flight level is desired.  Cleaned up    ~!<a name='1331'></font>
  <font color=#447700>!~    some of the code and added a couple comments.                         ~!<a name='1332'></font>
  <font color=#447700>!~                                                                          ~!<a name='1333'></font>
  <font color=#447700>!~    28 August 2013 .................... Braedi Wickard, SEMS/NG/16WS/WXN  ~!<a name='1334'></font>
  <font color=#447700>!~    Adapted for use within the Unified Post Processor. UPP can not handle ~!<a name='1335'></font>
  <font color=#447700>!~    the layer argument for flight levels, so reverted to hardcoded levels ~!<a name='1336'></font>
  <font color=#447700>!~                                                                          ~!<a name='1337'></font>
  <font color=#447700>!~    25 April 2014 ............................. Glenn Creighton, 16WS/WXN ~!<a name='1338'></font>
  <font color=#447700>!~    Adapted for use within WRF. WRF already computes many of these terms. ~!<a name='1339'></font>
  <font color=#447700>!~    Stripped everything down to its bare bones to remove need to compute  ~!<a name='1340'></font>
  <font color=#447700>!~    horizontal terms, now using deformation variables already within WRF. ~!<a name='1341'></font>
  <font color=#447700>!~                                                                          ~!<a name='1342'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1343'></font>
<A NAME='CATTURBULENCE'><A href='../../html_code/phys/module_diag_afwa.F.html#CATTURBULENCE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1344'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>CATTurbulence</font> ( ugrdbot, ugrdtop, vgrdbot, vgrdtop &amp;<a name='1345'>
                           ,defor11bot, defor11top, defor12bot, defor12top &amp;<a name='1346'>
                           ,defor22bot, defor22top, zbot, ztop ) result ( ti )<a name='1347'>
<a name='1348'>
    IMPLICIT NONE<a name='1349'>
<a name='1350'>
    <font color=#447700>!~ Variable declarations<a name='1351'></font>
    <font color=#447700>!  ---------------------<a name='1352'></font>
    REAL,    INTENT ( IN )  :: ugrdbot       <font color=#447700>!~ U-wind bottom of layer<a name='1353'></font>
    REAL,    INTENT ( IN )  :: ugrdtop       <font color=#447700>!~ U-wind top of layer<a name='1354'></font>
    REAL,    INTENT ( IN )  :: vgrdbot       <font color=#447700>!~ V-wind bottom of layer<a name='1355'></font>
    REAL,    INTENT ( IN )  :: vgrdtop       <font color=#447700>!~ V-wind top of layer<a name='1356'></font>
    REAL,    INTENT ( IN )  :: defor11bot    <font color=#447700>!~ 2*du/dx at bottom of layer<a name='1357'></font>
    REAL,    INTENT ( IN )  :: defor11top    <font color=#447700>!~ 2*du/dx at top of layer<a name='1358'></font>
    REAL,    INTENT ( IN )  :: defor12bot    <font color=#447700>!~ du/dy+dv/dx at bottom of layer<a name='1359'></font>
    REAL,    INTENT ( IN )  :: defor12top    <font color=#447700>!~ du/dy+dv/dx at top of layer<a name='1360'></font>
    REAL,    INTENT ( IN )  :: defor22bot    <font color=#447700>!~ 2*dv/dy at bottom of layer<a name='1361'></font>
    REAL,    INTENT ( IN )  :: defor22top    <font color=#447700>!~ 2*dv/dy at top of layer<a name='1362'></font>
    REAL,    INTENT ( IN )  :: zbot          <font color=#447700>!~ Height grid bottom<a name='1363'></font>
    REAL,    INTENT ( IN )  :: ztop          <font color=#447700>!~ Height grid top<a name='1364'></font>
    REAL                    :: ti            <font color=#447700>!~ Turbulence index<a name='1365'></font>
<a name='1366'>
    <font color=#447700>!~ Function utility variables<a name='1367'></font>
    <font color=#447700>!  --------------------------<a name='1368'></font>
    REAL    :: dudx, dudx1, dudx2 <font color=#447700>!~ Wind differentials<a name='1369'></font>
    REAL    :: dvdy, dvdy1, dvdy2<a name='1370'>
    REAL    :: dudz, dvdz<a name='1371'>
<a name='1372'>
    REAL    :: depth, vws, conv    <font color=#447700>!~ Depth, vertical wind shear, convergence<a name='1373'></font>
    REAL    :: def, shear, stretch <font color=#447700>!~ Deformation, shear, stretching terms<a name='1374'></font>
<a name='1375'>
    <font color=#447700>!~ Initialize variables.<a name='1376'></font>
    <font color=#447700>!  ----------------------<a name='1377'></font>
    ti = REAL ( 0 )<a name='1378'>
<a name='1379'>
    <font color=#447700>!~ Compute vertical wind shear<a name='1380'></font>
    <font color=#447700>!  ---------------------------<a name='1381'></font>
    depth = ABS ( ztop - zbot )<a name='1382'>
    dudz  = ( ugrdbot - ugrdtop ) / depth<a name='1383'>
    dvdz  = ( vgrdbot - vgrdtop ) / depth<a name='1384'>
    vws   = SQRT ( dudz**2 + dvdz**2  )<a name='1385'>
<a name='1386'>
    dudx1 = defor11top / 2.<a name='1387'>
    dudx2 = defor11bot / 2.<a name='1388'>
    dudx  = ( dudx1 + dudx2 ) / REAL ( 2 )<a name='1389'>
<a name='1390'>
    dvdy1 = defor22top / 2.<a name='1391'>
    dvdy2 = defor22bot / 2.<a name='1392'>
    dvdy  = ( dvdy1 + dvdy2 ) / REAL ( 2 )<a name='1393'>
<a name='1394'>
    <font color=#447700>!~ Compute the deformation<a name='1395'></font>
    <font color=#447700>!  -----------------------<a name='1396'></font>
    stretch = dudx - dvdy<a name='1397'>
    shear   = ( defor12top + defor12bot ) / REAL ( 2 )<a name='1398'>
    def     = SQRT ( stretch**2 + shear**2 )<a name='1399'>
<a name='1400'>
    <font color=#447700>!~ Compute the convergence<a name='1401'></font>
    <font color=#447700>!  -----------------------<a name='1402'></font>
    conv    = - ( dudx + dvdy )<a name='1403'>
<a name='1404'>
    <font color=#447700>!~ Compute the turbulence index<a name='1405'></font>
    <font color=#447700>!  ----------------------------<a name='1406'></font>
    ti = vws * ( def + conv ) * 1.0E+07<a name='1407'>
<a name='1408'>
    IF ( ti /= ti ) ti = REAL ( 0 )<a name='1409'>
    IF ( ti &lt; 0   ) ti = REAL ( 0 )<a name='1410'>
<a name='1411'>
  END FUNCTION CATTurbulence<a name='1412'>
<a name='1413'>
<a name='1414'>
<a name='1415'>
<A NAME='LIN_INTERP'><A href='../../html_code/phys/module_diag_afwa.F.html#LIN_INTERP' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1416'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>lin_interp</font> ( x, f, y ) result ( g ),<A href='../../call_from/LIN_INTERP.html' TARGET='index'>4</A><a name='1417'>
<a name='1418'>
    <font color=#447700>! Purpose:<a name='1419'></font>
    <font color=#447700>!   interpolates f(x) to point y<a name='1420'></font>
    <font color=#447700>!   assuming f(x) = <A href='../../html_code/phys/module_mp_full_sbm.F.html#F'>f</A><A href='../../html_code/phys/module_physics_init.F.html#LIN_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="F_10">(x0) + a * (x - x0)<a name='1421'></font>
    <font color=#447700>!   where a = ( f(x1) - f(x0) ) / (x1 - x0)<a name='1422'></font>
    <font color=#447700>!   x0 &lt;= x &lt;= x1<a name='1423'></font>
    <font color=#447700>!   assumes x is monotonically increasing<a name='1424'></font>
<a name='1425'>
    <font color=#447700>! Author: D. Fillmore ::  J. Done changed from r8 to r4<a name='1426'></font>
    <font color=#447700>! Pilfered for AFWA diagnostics - G Creighton<a name='1427'></font>
<a name='1428'>
    implicit none<a name='1429'>
<a name='1430'>
    real, intent(in), dimension(:) :: x  <font color=#447700>! grid points<a name='1431'></font>
    real, intent(in), dimension(:) :: f  <font color=#447700>! grid function values<a name='1432'></font>
    real, intent(in) :: y                <font color=#447700>! interpolation point<a name='1433'></font>
    real :: g                            <font color=#447700>! interpolated function value      <a name='1434'></font>
<a name='1435'>
    integer :: k  <font color=#447700>! interpolation point index<a name='1436'></font>
    integer :: n  <font color=#447700>! length of x<a name='1437'></font>
    real    :: a<a name='1438'>
<a name='1439'>
    n = size(x)<a name='1440'>
<a name='1441'>
    <font color=#447700>! find k such that x(k) &lt; y =&lt; x(k+1)<a name='1442'></font>
    <font color=#447700>! set k = 1 if y &lt;= x(1)  and  k = n-1 if y &gt; x(n)<a name='1443'></font>
<a name='1444'>
    if (y &lt;= x(1)) then<a name='1445'>
      k = 1<a name='1446'>
    else if (y &gt;= x(n)) then<a name='1447'>
      k = n - 1<a name='1448'>
    else<a name='1449'>
      k = 1<a name='1450'>
      do while (y &gt; x(k+1) .and. k &lt; n)<a name='1451'>
        k = k + 1<a name='1452'>
      end do<a name='1453'>
    end if<a name='1454'>
    <font color=#447700>! interpolate<a name='1455'></font>
    a = (  f(k+1) - f(k) ) / ( x(k+1) - x(k) )<a name='1456'>
    g = <A href='../../html_code/phys/module_mp_full_sbm.F.html#F'>f</A><A href='../../html_code/phys/module_physics_init.F.html#LIN_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="F_11">(k) + a * (y - x(k))<a name='1457'>
<a name='1458'>
  END FUNCTION lin_interp<a name='1459'>
<a name='1460'>
<a name='1461'>
<a name='1462'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1463'></font>
  <font color=#447700>!~                                                                           ~!<a name='1464'></font>
  <font color=#447700>!~ Name:                                                                     ~!<a name='1465'></font>
  <font color=#447700>!~    LLT_Windspeed                                                          ~!<a name='1466'></font>
  <font color=#447700>!~                                                                           ~!<a name='1467'></font>
  <font color=#447700>!~ Description:                                                              ~!<a name='1468'></font>
  <font color=#447700>!~    This function computes the dynamic term for the low-level turbulence   ~!<a name='1469'></font>
  <font color=#447700>!~    algorithm.                                                             ~!<a name='1470'></font>
  <font color=#447700>!~                                                                           ~!<a name='1471'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1472'></font>
<A NAME='LLT_WINDSPEED'><A href='../../html_code/phys/module_diag_afwa.F.html#LLT_WINDSPEED' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1473'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>LLT_Windspeed</font> ( nlayer, u, v ) RESULT ( dynamic )<a name='1474'>
    IMPLICIT NONE<a name='1475'>
 <a name='1476'>
    <font color=#447700>!~ Variable Declaration<a name='1477'></font>
    <font color=#447700>!  --------------------<a name='1478'></font>
    INTEGER, INTENT ( IN )         :: nlayer<a name='1479'>
    REAL, INTENT ( IN )            :: u     ( nlayer )<a name='1480'>
    REAL, INTENT ( IN )            :: v     ( nlayer )<a name='1481'>
    REAL                           :: dynamic<a name='1482'>
 <a name='1483'>
    <font color=#447700>!~ Internal function variables<a name='1484'></font>
    <font color=#447700>!  ---------------------------<a name='1485'></font>
    INTEGER           :: i<a name='1486'>
    REAL              :: this_windspeed ( nlayer )<a name='1487'>
    REAL              :: PI<a name='1488'>
       PARAMETER ( PI = 3.14159265359 )<a name='1489'>
<a name='1490'>
    <font color=#447700>!  --------------------------------------------------------------------  !<a name='1491'></font>
    <font color=#447700>!  --------------------------------------------------------------------  !           <a name='1492'></font>
    <font color=#447700>!~ Initialize variables<a name='1493'></font>
    <font color=#447700>!  --------------------<a name='1494'></font>
    dynamic = REAL ( 0 )<a name='1495'>
<a name='1496'>
    <font color=#447700>!~ Compute the windspeed<a name='1497'></font>
    <font color=#447700>!  ---------------------<a name='1498'></font>
    DO i = 1, nlayer<a name='1499'>
       this_windspeed ( i ) = SQRT ( u(i)**2 + v(i)**2 )<a name='1500'>
    END DO<a name='1501'>
<a name='1502'>
    <font color=#447700>!~ Compute the dynamic term<a name='1503'></font>
    <font color=#447700>!  -------------------------<a name='1504'></font>
    dynamic = ( this_windspeed(1)+this_windspeed(nlayer) ) / REAL (20)<a name='1505'>
    IF ( dynamic &gt; REAL (2) ) dynamic = REAL ( 2 )<a name='1506'>
    dynamic = ( dynamic + REAL (3) ) / REAL ( 2 )<a name='1507'>
    dynamic = SIN ( dynamic*PI )<a name='1508'>
    dynamic = ( dynamic + REAL (1) ) / REAL ( 2 )<a name='1509'>
<a name='1510'>
<a name='1511'>
  END FUNCTION LLT_Windspeed<a name='1512'>
<a name='1513'>
<a name='1514'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1515'></font>
  <font color=#447700>!~                                                                           ~!<a name='1516'></font>
  <font color=#447700>!~ Name:                                                                     ~!<a name='1517'></font>
  <font color=#447700>!~    LLT_Thermodynamic                                                      ~!<a name='1518'></font>
  <font color=#447700>!~                                                                           ~!<a name='1519'></font>
  <font color=#447700>!~ Description:                                                              ~!<a name='1520'></font>
  <font color=#447700>!~    This function computes the thermodynamic term for the low-level        ~!<a name='1521'></font>
  <font color=#447700>!~    turbulence algorithm.                                                  ~!<a name='1522'></font>
  <font color=#447700>!~                                                                           ~!<a name='1523'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1524'></font>
<A NAME='LLT_THERMODYNAMIC'><A href='../../html_code/phys/module_diag_afwa.F.html#LLT_THERMODYNAMIC' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1525'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>LLT_Thermodynamic</font> ( nlayer, tK, hgt ) RESULT ( thermodynamic )<a name='1526'>
  IMPLICIT NONE<a name='1527'>
 <a name='1528'>
    <font color=#447700>!~ Variable Declaration<a name='1529'></font>
    <font color=#447700>!  --------------------<a name='1530'></font>
    INTEGER, INTENT ( IN )         :: nlayer<a name='1531'>
    REAL, INTENT ( IN )            :: tK     ( nlayer ) <font color=#447700>!~ Temperature (K)<a name='1532'></font>
    REAL, INTENT ( IN )            :: hgt    ( nlayer ) <font color=#447700>!~ Heights ( m )<a name='1533'></font>
    REAL                           :: thermodynamic<a name='1534'>
<a name='1535'>
    <font color=#447700>!~ Internal function variables<a name='1536'></font>
    <font color=#447700>!  ---------------------------<a name='1537'></font>
    INTEGER :: i<a name='1538'>
    REAL    :: lapse<a name='1539'>
    REAL    :: PI<a name='1540'>
       PARAMETER ( PI = 3.14159265359 )<a name='1541'>
<a name='1542'>
    <font color=#447700>!  --------------------------------------------------------------------  !<a name='1543'></font>
    <font color=#447700>!  --------------------------------------------------------------------  !<a name='1544'></font>
<a name='1545'>
    <font color=#447700>!~ Initialize variables<a name='1546'></font>
    <font color=#447700>!  --------------------<a name='1547'></font>
    thermodynamic = REAL ( 0 )<a name='1548'>
<a name='1549'>
    <font color=#447700>!~ Compute the lapse rate over the layer.  The sign gets goofy here,<a name='1550'></font>
    <font color=#447700>!~ but works as coded below.<a name='1551'></font>
    <font color=#447700>!  -----------------------------------------------------------------<a name='1552'></font>
    lapse = ( tk(1) - tk(nlayer) ) * REAL ( 1000 )<a name='1553'>
    lapse = lapse / ( hgt(nlayer) - hgt(1) )<a name='1554'>
<a name='1555'>
    <font color=#447700>!~ Compute the thermodynamic component<a name='1556'></font>
    <font color=#447700>!  -----------------------------------<a name='1557'></font>
    thermodynamic = lapse / REAL ( 10 )<a name='1558'>
    thermodynamic = ( thermodynamic + REAL (3) ) / REAL ( 2 )<a name='1559'>
    thermodynamic = SIN ( thermodynamic * PI )<a name='1560'>
    thermodynamic = ( thermodynamic + REAL (1) ) / REAL ( 2 )<a name='1561'>
<a name='1562'>
  END FUNCTION LLT_Thermodynamic<a name='1563'>
<a name='1564'>
<a name='1565'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1566'></font>
  <font color=#447700>!~                                                                           ~!<a name='1567'></font>
  <font color=#447700>!~ Name:                                                                     ~!<a name='1568'></font>
  <font color=#447700>!~    LLT_MountainWave                                                       ~!<a name='1569'></font>
  <font color=#447700>!~                                                                           ~!<a name='1570'></font>
  <font color=#447700>!~ Description:                                                              ~!<a name='1571'></font>
  <font color=#447700>!~    This function computes the mountain wave term for the low-level        ~!<a name='1572'></font>
  <font color=#447700>!~    turbulence algorithm.                                                  ~!<a name='1573'></font>
  <font color=#447700>!~                                                                           ~!<a name='1574'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1575'></font>
<A NAME='LLT_MOUNTAINWAVE'><A href='../../html_code/phys/module_diag_afwa.F.html#LLT_MOUNTAINWAVE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1576'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>LLT_MountainWave</font> ( nlayer, tdx, tdy, u, v, tK, hgt) &amp;<a name='1577'>
                                                         RESULT ( MountainWave )<a name='1578'>
    IMPLICIT NONE<a name='1579'>
<a name='1580'>
    <font color=#447700>!~ Variable Declaration<a name='1581'></font>
    <font color=#447700>!  --------------------<a name='1582'></font>
    INTEGER, INTENT ( IN )           :: nlayer<a name='1583'>
    REAL, INTENT ( IN )              :: tdx               <font color=#447700>!~ Terrain dx<a name='1584'></font>
    REAL, INTENT ( IN )              :: tdy               <font color=#447700>!~ Terrain dy<a name='1585'></font>
    REAL, INTENT ( IN )              :: u   ( nlayer )    <font color=#447700>!~ U components f<a name='1586'></font>
    REAL, INTENT ( IN )              :: v   ( nlayer )    <font color=#447700>!~ V components<a name='1587'></font>
    REAL, INTENT ( IN )              :: tK  ( nlayer )    <font color=#447700>!~ Temperatures (K)<a name='1588'></font>
    REAL, INTENT ( IN )              :: hgt ( nlayer )    <font color=#447700>!~ Heights ( m )<a name='1589'></font>
    REAL                             :: MountainWave      <font color=#447700>!~ Mountain wave term<a name='1590'></font>
 <a name='1591'>
    <font color=#447700>!~ Internal function variables<a name='1592'></font>
    <font color=#447700>!  ---------------------------<a name='1593'></font>
    REAL    :: u_term<a name='1594'>
    REAL    :: v_term<a name='1595'>
    REAL    :: uv_term<a name='1596'>
    REAL    :: lapse<a name='1597'>
    REAL    :: total_mw, this_total_mw<a name='1598'>
    REAL    :: this_uv_term<a name='1599'>
    REAL    :: min_uv_term, cross_terrain, max_total_mw<a name='1600'>
    INTEGER :: i, j, k<a name='1601'>
<a name='1602'>
    REAL    :: PI<a name='1603'>
       PARAMETER ( PI = 3.14159265359 )<a name='1604'>
<a name='1605'>
    <font color=#447700>!  --------------------------------------------------------------------  !<a name='1606'></font>
    <font color=#447700>!  --------------------------------------------------------------------  !<a name='1607'></font>
<a name='1608'>
    <font color=#447700>!~ Initialize variables<a name='1609'></font>
    <font color=#447700>!  --------------------<a name='1610'></font>
    MountainWave = REAL ( 0 )<a name='1611'>
<a name='1612'>
    <font color=#447700>!~ Loop through the layer<a name='1613'></font>
    <font color=#447700>!  ----------------------<a name='1614'></font>
    DO i = 2, nlayer<a name='1615'>
<a name='1616'>
      <font color=#447700>!~ Wind terrain term<a name='1617'></font>
      <font color=#447700>!  -----------------<a name='1618'></font>
      u_term       = ( (u(i-1) + u(i) ) / REAL(2) ) * tdx<a name='1619'>
      v_term       = ( (v(i-1) + v(i) ) / REAL(2) ) * tdy<a name='1620'>
      this_uv_term = ( u_term + v_term ) * REAL ( -1 )<a name='1621'>
      <font color=#447700>!IF ( uv_term &lt; REAL (0) ) uv_term = REAL ( 0 )<a name='1622'></font>
      IF ( min_uv_term &lt; REAL (0) ) min_uv_term = REAL ( 0 )<a name='1623'>
      IF ( i == 2 ) THEN<a name='1624'>
        <font color=#447700>!uv_term = this_uv_term<a name='1625'></font>
        min_uv_term = this_uv_term<a name='1626'>
      ELSE<a name='1627'>
        <font color=#447700>!IF ( this_uv_term &lt; uv_term ) uv_term = this_uv_term<a name='1628'></font>
        IF ( this_uv_term &lt; min_uv_term ) min_uv_term = this_uv_term<a name='1629'>
      END IF<a name='1630'>
<a name='1631'>
      <font color=#447700>!~ Lapse rate<a name='1632'></font>
      <font color=#447700>!  ----------<a name='1633'></font>
      lapse = ( tK (i-1) - tK (i) ) * REAL ( 1000 )<a name='1634'>
      lapse  = lapse / ABS ( hgt(i)-hgt(i-1) )<a name='1635'>
      IF ( lapse &gt; REAL (0) ) lapse = REAL ( 0 )<a name='1636'>
      lapse = lapse * REAL ( -1 )<a name='1637'>
<a name='1638'>
      this_total_mw = this_uv_term * lapse * REAL ( 40000 )<a name='1639'>
      IF ( i == 2 ) THEN<a name='1640'>
        total_mw = this_total_mw<a name='1641'>
      ELSE<a name='1642'>
        IF ( this_total_mw &gt; total_mw ) total_mw = this_total_mw<a name='1643'>
      END IF<a name='1644'>
 <a name='1645'>
    END DO<a name='1646'>
<a name='1647'>
    <font color=#447700>!min_uv_term = uv_term<a name='1648'></font>
    cross_terrain = min_uv_term * REAL ( 500 )<a name='1649'>
<a name='1650'>
    IF ( min_uv_term &lt; 0.03 ) THEN<a name='1651'>
      cross_terrain = REAL ( 0 )<a name='1652'>
    END IF<a name='1653'>
<a name='1654'>
    IF ( cross_terrain &gt; REAL (50) ) cross_terrain = REAL ( 50 )<a name='1655'>
<a name='1656'>
    <font color=#447700>!~ Multiply the lapse (inversion) array and the mountain wave array<a name='1657'></font>
    <font color=#447700>!  ----------------------------------------------------------------<a name='1658'></font>
    IF ( total_mw &gt; REAL (50) ) total_mw = REAL ( 50 )<a name='1659'>
<a name='1660'>
    <font color=#447700>!~ Add the cross terrain flow and inversion term<a name='1661'></font>
    <font color=#447700>!  ---------------------------------------------<a name='1662'></font>
    MountainWave = ( total_mw*(cross_terrain/50.) ) + cross_terrain<a name='1663'>
    MountainWave = MountainWave / REAL ( 100 )<a name='1664'>
<a name='1665'>
  END FUNCTION LLT_MountainWave<a name='1666'>
<a name='1667'>
<a name='1668'>
<a name='1669'>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1670'></font>
  <font color=#447700>!~                                                                           ~!<a name='1671'></font>
  <font color=#447700>!~ Name:                                                                     ~!<a name='1672'></font>
  <font color=#447700>!~    LLT_TrappedWave                                                        ~!<a name='1673'></font>
  <font color=#447700>!~                                                                           ~!<a name='1674'></font>
  <font color=#447700>!~ Description:                                                              ~!<a name='1675'></font>
  <font color=#447700>!~    This function computes the trapped wave term for the low-level         ~!<a name='1676'></font>
  <font color=#447700>!~    turbulence algorithm.                                                  ~!<a name='1677'></font>
  <font color=#447700>!~                                                                           ~!<a name='1678'></font>
  <font color=#447700>!!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!!!<a name='1679'></font>
<A NAME='LLT_TRAPPEDWAVE'><A href='../../html_code/phys/module_diag_afwa.F.html#LLT_TRAPPEDWAVE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1680'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>LLT_TrappedWave</font> ( nlayer, u, v, p ) RESULT ( trapped ),<A href='../../call_from/LLT_TRAPPEDWAVE.html' TARGET='index'>1</A><a name='1681'>
     IMPLICIT NONE<a name='1682'>
<a name='1683'>
     <font color=#447700>!~ Variable Declaration<a name='1684'></font>
     <font color=#447700>!  --------------------<a name='1685'></font>
     INTEGER, INTENT ( IN )         :: nlayer<a name='1686'>
     REAL, INTENT ( IN )            :: u     ( nlayer )<a name='1687'>
     REAL, INTENT ( IN )            :: v     ( nlayer )<a name='1688'>
     REAL, INTENT ( IN )            :: p     ( nlayer )<a name='1689'>
     REAL                           :: trapped<a name='1690'>
<a name='1691'>
     <font color=#447700>!~ Internal function variables<a name='1692'></font>
     <font color=#447700>!  ---------------------------<a name='1693'></font>
     INTEGER           :: i<a name='1694'>
     REAL              :: du, dv<a name='1695'>
     REAL              :: scale_fact, this_p<a name='1696'>
     REAL              :: dudv, this_dudv<a name='1697'>
     REAL              :: PI<a name='1698'>
        PARAMETER ( PI = 3.14159265359 )<a name='1699'>
<a name='1700'>
     <font color=#447700>!~ Scale parameters<a name='1701'></font>
     <font color=#447700>!  ----------------<a name='1702'></font>
     REAL, PARAMETER :: scale_950 = 0.050000  <font color=#447700>!~ 1/20<a name='1703'></font>
     REAL, PARAMETER :: scale_925 = 0.040000  <font color=#447700>!~ 1/25<a name='1704'></font>
     REAL, PARAMETER :: scale_900 = 0.025000  <font color=#447700>!~ 1/40<a name='1705'></font>
     REAL, PARAMETER :: scale_850 = 0.010000  <font color=#447700>!~ 1/100<a name='1706'></font>
     REAL, PARAMETER :: scale_800 = 0.005000  <font color=#447700>!~ 1/200<a name='1707'></font>
     REAL, PARAMETER :: scale_750 = 0.002941  <font color=#447700>!~ 1/340<a name='1708'></font>
     REAL, PARAMETER :: scale_700 = 0.001923  <font color=#447700>!~ 1/520<a name='1709'></font>
     REAL, PARAMETER :: scale_650 = 0.001351  <font color=#447700>!~ 1/740<a name='1710'></font>
     REAL, PARAMETER :: scale_600 = 0.001000  <font color=#447700>!~ 1/1000<a name='1711'></font>
     REAL, PARAMETER :: scale_550 = 0.000800  <font color=#447700>!~ 1/1250<a name='1712'></font>
<a name='1713'>
     <font color=#447700>!  --------------------------------------------------------------------  !<a name='1714'></font>
     <font color=#447700>!  --------------------------------------------------------------------  !<a name='1715'></font>
<a name='1716'>
     <font color=#447700>!~ Initialize variables<a name='1717'></font>
     <font color=#447700>!  --------------------<a name='1718'></font>
     trapped = REAL ( 0 )<a name='1719'>
<a name='1720'>
     <font color=#447700>!~ Compute the trapped wave term<a name='1721'></font>
     <font color=#447700>!  ------------------<a name='1722'></font>
     dudv = REAL ( 0 )<a name='1723'>
     DO i = 2, nlayer<a name='1724'>
<a name='1725'>
       <font color=#447700>!~ Compute dudv first<a name='1726'></font>
       <font color=#447700>!  ------------------<a name='1727'></font>
       du         = u ( i-1 ) - u ( i )<a name='1728'>
       dv         = v ( i-1 ) - v ( i )<a name='1729'>
<a name='1730'>
       <font color=#447700>!~ Scale based on pressure level<a name='1731'></font>
       <font color=#447700>!  -----------------------------<a name='1732'></font>
       this_p = p ( i ) / REAL ( 100 )<a name='1733'>
       IF ( this_p &gt; REAL (950) ) THEN<a name='1734'>
         scale_fact = scale_950<a name='1735'>
       ELSE IF ( this_p &lt;= REAL (950) .AND. this_p &gt; REAL (925) ) THEN<a name='1736'>
         scale_fact = scale_925<a name='1737'>
       ELSE IF ( this_p &lt;= REAL (925) .AND. this_p &gt; REAL (900) ) THEN<a name='1738'>
         scale_fact = scale_900<a name='1739'>
       ELSE IF ( this_p &lt;= REAL (900) .AND. this_p &gt; REAL (850) ) THEN<a name='1740'>
         scale_fact = scale_850<a name='1741'>
       ELSE IF ( this_p &lt;= REAL (850) .AND. this_p &gt; REAL (800) ) THEN<a name='1742'>
         scale_fact = scale_800<a name='1743'>
       ELSE IF ( this_p &lt;= REAL (800) .AND. this_p &gt; REAL (750) ) THEN<a name='1744'>
         scale_fact = scale_750<a name='1745'>
       ELSE IF ( this_p &lt;= REAL (750) .AND. this_p &gt; REAL (700) ) THEN<a name='1746'>
         scale_fact = scale_700<a name='1747'>
       ELSE IF ( this_p &lt;= REAL (700) .AND. this_p &gt; REAL (650) ) THEN<a name='1748'>
         scale_fact = scale_650<a name='1749'>
       ELSE IF ( this_p &lt;= REAL (650) .AND. this_p &gt; REAL (600) ) THEN<a name='1750'>
         scale_fact = scale_600<a name='1751'>
       ELSE IF ( this_p &lt;= REAL (600) ) THEN<a name='1752'>
         scale_fact = scale_550<a name='1753'>
       END IF<a name='1754'>
<a name='1755'>
       this_dudv = ( (du**2)*(dv**2) ) * scale_fact<a name='1756'>
       IF ( this_dudv &gt; dudv ) dudv = this_dudv<a name='1757'>
<a name='1758'>
    END DO<a name='1759'>
<a name='1760'>
    trapped = dudv<a name='1761'>
    IF ( trapped &gt; REAL ( 1 ) ) trapped = REAL ( 1 )<a name='1762'>
    trapped = trapped / REAL ( 4 )<a name='1763'>
<a name='1764'>
  END FUNCTION LLT_TrappedWave<a name='1765'>
<a name='1766'>
END MODULE diag_functions<a name='1767'>
<a name='1768'>
<a name='1769'>
<a name='1770'>
<A NAME='MODULE_DIAG_AFWA'><A href='../../html_code/phys/module_diag_afwa.F.html#MODULE_DIAG_AFWA' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='1771'>
<font color=#993300>MODULE </font><font color=#cc0000>module_diag_afwa</font> <A href='../../call_to/MODULE_DIAG_AFWA.html' TARGET='index'>1</A><a name='1772'>
<a name='1773'>
    USE <A href='../../html_code/phys/module_diag_afwa.F.html#DIAG_FUNCTIONS'>diag_functions</A><A href='../../html_code/phys/module_diag_afwa.F.html#LLT_TRAPPEDWAVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIAG_FUNCTIONS_1"><a name='1774'>
<a name='1775'>
CONTAINS<a name='1776'>
<a name='1777'>
<A NAME='AFWA_DIAGNOSTICS_DRIVER'><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1778'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>afwa_diagnostics_driver</font> (   grid , config_flags     &amp; <A href='../../call_to/AFWA_DIAGNOSTICS_DRIVER.html' TARGET='index'>1</A>,<A href='../../call_from/AFWA_DIAGNOSTICS_DRIVER.html' TARGET='index'>34</A><a name='1779'>
                             , moist                             &amp;<a name='1780'>
                             , scalar                            &amp;<a name='1781'>
                             , chem                              &amp;<a name='1782'>
                             , th_phy , pi_phy , p_phy           &amp;<a name='1783'>
                             , u_phy , v_phy                     &amp;<a name='1784'>
                             , dz8w , p8w , t8w , rho_phy , rho  &amp;<a name='1785'>
                             , ids, ide, jds, jde, kds, kde      &amp;<a name='1786'>
                             , ims, ime, jms, jme, kms, kme      &amp;<a name='1787'>
                             , ips, ipe, jps, jpe, kps, kpe      &amp;<a name='1788'>
                             , its, ite, jts, jte                &amp;<a name='1789'>
                             , k_start, k_end               )<a name='1790'>
<a name='1791'>
    USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_222">, ONLY : domain , domain_clock_get<a name='1792'>
    USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_144">, ONLY : grid_config_rec_type, model_config_rec<a name='1793'>
    USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_116"><a name='1794'>
    USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_54"><a name='1795'>
    USE module_utility<a name='1796'>
    USE <A href='../../html_code/frame/module_streams.F.html#MODULE_STREAMS'>module_streams</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STREAMS_5">, ONLY: history_alarm, auxhist2_alarm<a name='1797'>
#ifdef DM_PARALLEL<a name='1798'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_143">, ONLY: wrf_dm_sum_real, wrf_dm_maxval<a name='1799'>
#endif<a name='1800'>
<a name='1801'>
    IMPLICIT NONE<a name='1802'>
<a name='1803'>
    TYPE ( domain ), INTENT(INOUT) :: grid<a name='1804'>
    TYPE ( grid_config_rec_type ), INTENT(IN) :: config_flags<a name='1805'>
<a name='1806'>
    INTEGER, INTENT(IN) :: ids, ide, jds, jde, kds, kde,        &amp;<a name='1807'>
                           ims, ime, jms, jme, kms, kme,        &amp;<a name='1808'>
                           ips, ipe, jps, jpe, kps, kpe<a name='1809'>
    INTEGER             :: k_start , k_end, its, ite, jts, jte<a name='1810'>
<a name='1811'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme , num_moist),    &amp;<a name='1812'>
         INTENT(IN   ) ::                                moist<a name='1813'>
<a name='1814'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme , num_scalar),    &amp;<a name='1815'>
         INTENT(IN   ) ::                                scalar<a name='1816'>
<a name='1817'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme , num_chem),     &amp;<a name='1818'>
         INTENT(IN   ) ::                                 chem<a name='1819'>
<a name='1820'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),               &amp;<a name='1821'>
         INTENT(IN   ) ::                               th_phy  &amp;<a name='1822'>
                                              ,         pi_phy  &amp;<a name='1823'>
                                              ,          p_phy  &amp;<a name='1824'>
                                              ,          u_phy  &amp;<a name='1825'>
                                              ,          v_phy  &amp;<a name='1826'>
                                              ,           dz8w  &amp;<a name='1827'>
                                              ,            p8w  &amp;<a name='1828'>
                                              ,            t8w  &amp;<a name='1829'>
                                              ,        rho_phy  &amp;<a name='1830'>
                                              ,            rho<a name='1831'>
<a name='1832'>
    <font color=#447700>! Local<a name='1833'></font>
    <font color=#447700>! -----<a name='1834'></font>
    CHARACTER*512 :: message<a name='1835'>
    CHARACTER*256 :: timestr <a name='1836'>
    INTEGER :: i,j,k,nz,ostat<a name='1837'>
    INTEGER :: icing_opt<a name='1838'>
    REAL :: bdump<a name='1839'>
    INTEGER :: i_start, i_end, j_start, j_end<a name='1840'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ) ::      qrain  &amp;<a name='1841'>
                                              ,          qsnow  &amp;<a name='1842'>
                                              ,          qgrpl  &amp;<a name='1843'>
                                              ,          qvapr  &amp;<a name='1844'>
                                              ,         qcloud  &amp;<a name='1845'>
                                              ,           qice  &amp;<a name='1846'>
                                              ,         ncloud  &amp;<a name='1847'>
                                              ,         ngraup  &amp;<a name='1848'>
                                              ,             rh  &amp;<a name='1849'>
                                              ,         rh_cld  &amp;<a name='1850'>
                                              ,           ptot  &amp;<a name='1851'>
                                              ,            z_e  &amp;<a name='1852'>
                                              ,           zagl<a name='1853'>
<a name='1854'>
    REAL, DIMENSION( ims:ime, jms:jme, 5 ) ::            dustc<a name='1855'>
    REAL, DIMENSION( ims:ime, jms:jme ) ::                rh2m  &amp;<a name='1856'>
                                              ,          rh20m  &amp;<a name='1857'>
                                              ,           tv2m  &amp;<a name='1858'>
                                              ,          tv20m  &amp;<a name='1859'>
                                              ,        wind10m  &amp;<a name='1860'>
                                              ,       wup_mask  &amp;<a name='1861'>
                                              ,       wind125m  &amp;<a name='1862'>
                                              ,           llws  &amp;<a name='1863'>
                                              ,         pwater<a name='1864'>
<a name='1865'>
    LOGICAL :: do_buoy_calc<a name='1866'>
    REAL :: zlfc_msl, dum1, dum2, dum3, wind_vel, wind_blend<a name='1867'>
    REAL :: prate_mm_per_hr, factor<a name='1868'>
    REAL :: u1km, v1km, ublend, vblend, u2000, v2000, us, vs<a name='1869'>
    LOGICAL :: is_target_level<a name='1870'>
<a name='1871'>
    <font color=#447700>! Timing<a name='1872'></font>
    <font color=#447700>! ------<a name='1873'></font>
    TYPE(WRFU_Time) :: hist_time, aux2_time, CurrTime, StartTime<a name='1874'>
    TYPE(WRFU_TimeInterval) :: dtint, histint, aux2int<a name='1875'>
    LOGICAL :: is_after_history_dump, is_output_timestep, is_first_timestep<a name='1876'>
<a name='1877'>
    <font color=#447700>! Chirp the routine name for debugging purposes<a name='1878'></font>
    <font color=#447700>! ---------------------------------------------<a name='1879'></font>
    write ( message, * ) 'inside afwa_diagnostics_driver'<a name='1880'>
    CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_557">( 100 , message )<a name='1881'>
<a name='1882'>
    <font color=#447700>! Get timing info <a name='1883'></font>
    <font color=#447700>! Want to know if when the last history output was<a name='1884'></font>
    <font color=#447700>! Check history and auxhist2 alarms to check last ring time and how often<a name='1885'></font>
    <font color=#447700>! they are set to ring<a name='1886'></font>
    <font color=#447700>! -----------------------------------------------------------------------<a name='1887'></font>
    CALL WRFU_ALARMGET( grid%alarms( HISTORY_ALARM ), prevringtime=hist_time, &amp;<a name='1888'>
         ringinterval=histint)<a name='1889'>
    CALL WRFU_ALARMGET( grid%alarms( AUXHIST2_ALARM ), prevringtime=aux2_time, &amp;<a name='1890'>
         ringinterval=aux2int)<a name='1891'>
<a name='1892'>
    <font color=#447700>! Get domain clock<a name='1893'></font>
    <font color=#447700>! ----------------<a name='1894'></font>
    CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_36"> ( grid, current_time=CurrTime, &amp;<a name='1895'>
         simulationStartTime=StartTime, &amp;            <a name='1896'>
         current_timestr=timestr, time_step=dtint )<a name='1897'>
<a name='1898'>
    <font color=#447700>! Set some booleans for use later<a name='1899'></font>
    <font color=#447700>! Following uses an overloaded .lt.<a name='1900'></font>
    <font color=#447700>! ---------------------------------<a name='1901'></font>
    is_after_history_dump = ( Currtime .lt. hist_time + dtint )<a name='1902'>
<a name='1903'>
    <font color=#447700>! Following uses an overloaded .ge.<a name='1904'></font>
    <font color=#447700>! ---------------------------------<a name='1905'></font>
    is_output_timestep = (Currtime .ge. hist_time + histint - dtint .or. &amp;<a name='1906'>
                         Currtime .ge. aux2_time + aux2int - dtint )<a name='1907'>
    write ( message, * ) 'is output timestep? ', is_output_timestep<a name='1908'>
    CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_558">( 100 , message )<a name='1909'>
<a name='1910'>
    <font color=#447700>! Following uses an overloaded .eq.<a name='1911'></font>
    <font color=#447700>! ---------------------------------<a name='1912'></font>
    is_first_timestep = ( Currtime .eq. StartTime + dtint )<a name='1913'>
        <a name='1914'>
    <font color=#447700>! Here is an optional check for bad data in case the model has gone<a name='1915'></font>
    <font color=#447700>! off the hinges unchecked until now.  This happens under certain<a name='1916'></font>
    <font color=#447700>! configurations and can lead to very wrong data writes.  This is just<a name='1917'></font>
    <font color=#447700>! a simple check for sane winds and potential temperatures.<a name='1918'></font>
    <font color=#447700>! --------------------------------------------------------------------<a name='1919'></font>
    IF ( config_flags%afwa_bad_data_check .GT. 0 ) THEN<a name='1920'>
      IF ( ( is_output_timestep ) .AND. ( .NOT. is_first_timestep ) ) THEN      <a name='1921'>
        DO i=its, MIN( ide-1, ite )<a name='1922'>
          DO k=k_start, k_end<a name='1923'>
            DO j=jts, MIN( jde-1, jte )<a name='1924'>
              IF ( ( u_phy(i,k,j)  .GT.  300.  ) .OR. &amp;<a name='1925'>
                   ( u_phy(i,k,j)  .LT. -300.  ) .OR. &amp;<a name='1926'>
                   ( v_phy(i,k,j)  .GT.  300.  ) .OR. &amp;<a name='1927'>
                   ( v_phy(i,k,j)  .LT. -300.  ) .OR. &amp;<a name='1928'>
                   ( th_phy(i,k,j) .GT.  9999. ) .OR. &amp;<a name='1929'>
                   ( th_phy(i,k,j) .LT.  99.   ) ) THEN<a name='1930'>
                write ( message, * ) "AFWA Diagnostics: ERROR - Model winds and/or " // &amp;<a name='1931'>
                "potential temperature appear to be bad. If you do not want this check, " // &amp;<a name='1932'>
                "set afwa_bad_data_check=0. i=",i,", j=",j,", k=",k,", u_phy=",u_phy(i,k,j), &amp;<a name='1933'>
                ", v_phy=", v_phy(i,k,j),", th_phy=",th_phy(i,k,j)<a name='1934'>
                CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_626">( message )<a name='1935'>
              ENDIF<a name='1936'>
            ENDDO<a name='1937'>
          ENDDO<a name='1938'>
        ENDDO<a name='1939'>
      ENDIF<a name='1940'>
    ENDIF<a name='1941'>
<a name='1942'>
    <font color=#447700>! 3-D arrays for moisture variables<a name='1943'></font>
    <font color=#447700>! ---------------------------------<a name='1944'></font>
    DO i=ims, ime<a name='1945'>
      DO k=kms, kme<a name='1946'>
        DO j=jms, jme<a name='1947'>
          qvapr(i,k,j) = moist(i,k,j,P_QV)<a name='1948'>
          qrain(i,k,j) = moist(i,k,j,P_QR)<a name='1949'>
          qsnow(i,k,j) = moist(i,k,j,P_QS)<a name='1950'>
          qgrpl(i,k,j) = moist(i,k,j,P_QG)<a name='1951'>
          qcloud(i,k,j) = moist(i,k,j,P_QC)<a name='1952'>
          qice(i,k,j) = moist(i,k,j,P_QI)<a name='1953'>
          ncloud(i,k,j) = scalar(i,k,j,P_QNC)<a name='1954'>
        ENDDO<a name='1955'>
      ENDDO<a name='1956'>
    ENDDO<a name='1957'>
    <a name='1958'>
    <font color=#447700>! Total pressure<a name='1959'></font>
    <font color=#447700>! -------------- <a name='1960'></font>
    DO i=ims, ime<a name='1961'>
      DO k=kms, kme<a name='1962'>
        DO j=jms, jme<a name='1963'>
          ptot(i,k,j)=grid%pb(i,k,j)+grid%p(i,k,j)<a name='1964'>
        ENDDO<a name='1965'>
      ENDDO<a name='1966'>
    ENDDO<a name='1967'>
<a name='1968'>
    <font color=#447700>! ZAGL (height above ground)<a name='1969'></font>
    <font color=#447700>! --------------------------<a name='1970'></font>
    DO i=ims, ime<a name='1971'>
      DO k=kms, kme<a name='1972'>
        DO j=jms, jme<a name='1973'>
          zagl(i,k,j)=grid%z(i,k,j)-grid%ht(i,j)<a name='1974'>
        ENDDO<a name='1975'>
      ENDDO<a name='1976'>
    ENDDO<a name='1977'>
<a name='1978'>
    <font color=#447700>! Calculate relative humidity<a name='1979'></font>
    <font color=#447700>! ---------------------------<a name='1980'></font>
    DO i=ims,ime<a name='1981'>
      DO k=kms,kme    <a name='1982'>
        DO j=jms,jme<a name='1983'>
          rh(i,k,j)=<A href='../../html_code/phys/module_diag_afwa.F.html#CALC_RH'>calc_rh</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_RH_1">(ptot(i,k,j),grid%t_phy(i,k,j), qvapr(i,k,j))<a name='1984'>
          rh_cld(i,k,j)=<A href='../../html_code/phys/module_diag_afwa.F.html#CALC_RH'>calc_rh</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_RH_2">(ptot(i,k,j),grid%t_phy(i,k,j), qvapr(i,k,j)+qcloud(i,k,j)+qice(i,k,j))<a name='1985'>
        ENDDO<a name='1986'>
      ENDDO<a name='1987'>
    ENDDO<a name='1988'>
<a name='1989'>
    <font color=#447700>! Time-step precipitation (convective + nonconvective)<a name='1990'></font>
    <font color=#447700>! --------------------------------------------------------------<a name='1991'></font>
    DO i=ims,ime<a name='1992'>
      DO j=jms,jme<a name='1993'>
        grid % afwa_precip(i,j) = grid%raincv(i,j) + grid%rainncv(i,j)<a name='1994'>
        grid % afwa_totprecip(i,j) = grid%rainc(i,j) + grid%rainnc(i,j)<a name='1995'>
      ENDDO<a name='1996'>
    ENDDO<a name='1997'>
<a name='1998'>
    <font color=#447700>! Calculate precipitable water<a name='1999'></font>
    <font color=#447700>! ----------------------------<a name='2000'></font>
    nz=kme-kms+1<a name='2001'>
    DO i=ims,ime<a name='2002'>
      DO j=jms,jme<a name='2003'>
        grid % afwa_pwat ( i, j ) = <A href='../../html_code/phys/module_diag_afwa.F.html#PWAT'>Pwat</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PWAT_1">( nz,                  &amp;<a name='2004'>
                                          qvapr(i,kms:kme,j),  &amp;<a name='2005'>
                                          qcloud(i,kms:kme,j), &amp;<a name='2006'>
                                          dz8w(i,kms:kme,j),   &amp;<a name='2007'>
                                          rho(i,kms:kme,j) )<a name='2008'>
      ENDDO<a name='2009'>
    ENDDO<a name='2010'>
<a name='2011'>
    <font color=#447700>! After each history dump, reset max/min value arrays<a name='2012'></font>
    <font color=#447700>! ----------------------------------------------------------------------<a name='2013'></font>
    IF ( is_after_history_dump ) THEN<a name='2014'>
      DO j = jms, jme<a name='2015'>
        DO i = ims, ime<a name='2016'>
          grid % wspd10max(i,j) = 0.<a name='2017'>
          grid % afwa_llws(i,j) = 0.<a name='2018'>
        ENDDO<a name='2019'>
      ENDDO<a name='2020'>
    ENDIF <a name='2021'>
<a name='2022'>
    <font color=#447700>! Calculate the max 10 m wind speed between output times<a name='2023'></font>
    <font color=#447700>! ------------------------------------------------------<a name='2024'></font>
    <font color=#447700>! UPDATE 20150112 - GAC<a name='2025'></font>
    <font color=#447700>! Diagnose from model 10 m winds, and blend with 1 km AGL<a name='2026'></font>
    <font color=#447700>! winds when precipitation rate is &gt; 50 mm/hr to account<a name='2027'></font>
    <font color=#447700>! for increased surface wind gust potential when precip<a name='2028'></font>
    <font color=#447700>! is heavy and when winds aloft are strong.  Will use the<a name='2029'></font>
    <font color=#447700>! higher of the surface and the blended winds. Blending<a name='2030'></font>
    <font color=#447700>! is linear weighted between 50-150 mm/hr precip rates.<a name='2031'></font>
    <font color=#447700>! -------------------------------------------------------<a name='2032'></font>
    DO j = jms, jme<a name='2033'>
      DO i = ims, ime<a name='2034'>
        wind_vel = uv_wind ( grid % u10(i,j) , grid % v10(i,j) )<a name='2035'>
        prate_mm_per_hr = ( grid % afwa_precip(i,j) / grid % dt ) * 3600.<a name='2036'>
<a name='2037'>
        <font color=#447700>! Is this an area of heavy precip?  Calculate 1km winds to blend down<a name='2038'></font>
        <font color=#447700>! -------------------------------------------------------------------<a name='2039'></font>
        IF ( prate_mm_per_hr .GT. 50. ) THEN<a name='2040'>
          is_target_level=.false.<a name='2041'>
          DO k=kms,kme    <a name='2042'>
            IF ( ( zagl(i,k,j) &gt;= 1000. ) .and. &amp;<a name='2043'>
                 ( .NOT. is_target_level ) .and. &amp;<a name='2044'>
                 ( k .ne. kms ) ) THEN<a name='2045'>
              is_target_level = .true.<a name='2046'>
              u1km = u_phy(i,k-1,j) + (1000. - (zagl(i,k-1,j))) &amp;<a name='2047'>
                     * ((u_phy(i,k,j) - u_phy(i,k-1,j))/(zagl(i,k,j)))<a name='2048'>
              v1km = v_phy(i,k-1,j) + (1000. - (zagl(i,k-1,j))) &amp;<a name='2049'>
                     * ((v_phy(i,k,j) - v_phy(i,k-1,j))/(zagl(i,k,j)))<a name='2050'>
              EXIT <font color=#447700>! We've found our level, break the loop<a name='2051'></font>
            ENDIF<a name='2052'>
          ENDDO<a name='2053'>
          <a name='2054'>
          <font color=#447700>! Compute blended wind<a name='2055'></font>
          <font color=#447700>! --------------------<a name='2056'></font>
          factor = MAX ( ( ( 150. - prate_mm_per_hr ) / 100. ), 0. )<a name='2057'>
          ublend = grid % u10(i,j) * factor + u1km * (1. - factor)<a name='2058'>
          vblend = grid % v10(i,j) * factor + v1km * (1. - factor)<a name='2059'>
          wind_blend = uv_wind ( ublend, vblend )<a name='2060'>
<a name='2061'>
          <font color=#447700>! Set the surface wind to the blended wind if higher<a name='2062'></font>
          <font color=#447700>! --------------------------------------------------<a name='2063'></font>
          IF ( wind_blend .GT. wind_vel ) THEN<a name='2064'>
            wind_vel = wind_blend<a name='2065'>
          ENDIF<a name='2066'>
        ENDIF<a name='2067'>
<a name='2068'>
        IF ( wind_vel .GT. grid % wspd10max(i,j) ) THEN<a name='2069'>
          grid % wspd10max(i,j) = wind_vel<a name='2070'>
        ENDIF<a name='2071'>
      ENDDO<a name='2072'>
    ENDDO<a name='2073'>
<a name='2074'>
    <font color=#447700>! Calculate 0-2000 foot (0 - 609.6 meter) shear.<a name='2075'></font>
    <font color=#447700>! ----------------------------------------------<a name='2076'></font>
    DO j = jts, jte<a name='2077'>
      DO i = its, ite<a name='2078'>
        is_target_level=.false.<a name='2079'>
        DO k=kms,kme    <a name='2080'>
          IF ( ( zagl(i,k,j) &gt;= 609.6 ) .and. &amp;<a name='2081'>
               ( .NOT. is_target_level ) .and. &amp;<a name='2082'>
               ( k .ne. kms ) ) THEN<a name='2083'>
            is_target_level = .true.<a name='2084'>
            u2000 = u_phy(i,k-1,j) + (609.6 - (zagl(i,k-1,j))) &amp;<a name='2085'>
                    * ((u_phy(i,k,j) - u_phy(i,k-1,j))/(zagl(i,k,j)))<a name='2086'>
            v2000 = v_phy(i,k-1,j) + (609.6 - (zagl(i,k-1,j))) &amp;<a name='2087'>
                    * ((v_phy(i,k,j) - v_phy(i,k-1,j))/(zagl(i,k,j)))<a name='2088'>
            us = u2000 - grid % u10(i,j) <a name='2089'>
            vs = v2000 - grid % v10(i,j) <a name='2090'>
            llws(i,j) = uv_wind ( us , vs )<a name='2091'>
            IF ( llws(i,j) .gt. grid % afwa_llws(i,j) ) THEN<a name='2092'>
              grid % afwa_llws(i,j) = llws(i,j)<a name='2093'>
            ENDIF<a name='2094'>
            EXIT <font color=#447700>! We've found our level, break the loop<a name='2095'></font>
          ENDIF<a name='2096'>
        ENDDO<a name='2097'>
      ENDDO<a name='2098'>
    ENDDO<a name='2099'>
<a name='2100'>
#if ( WRF_CHEM == 1 )<a name='2101'>
    <font color=#447700>! Surface dust concentration array (ug m-3)<a name='2102'></font>
    <font color=#447700>! ----------------------------------------- <a name='2103'></font>
    DO i=ims, ime<a name='2104'>
      DO j=jms, jme<a name='2105'>
        dustc(i,j,1)=chem(i,k_start,j,p_dust_1)*rho(i,k_start,j)<a name='2106'>
        dustc(i,j,2)=chem(i,k_start,j,p_dust_2)*rho(i,k_start,j)<a name='2107'>
        dustc(i,j,3)=chem(i,k_start,j,p_dust_3)*rho(i,k_start,j)<a name='2108'>
        dustc(i,j,4)=chem(i,k_start,j,p_dust_4)*rho(i,k_start,j)<a name='2109'>
        dustc(i,j,5)=chem(i,k_start,j,p_dust_5)*rho(i,k_start,j)<a name='2110'>
      ENDDO<a name='2111'>
    ENDDO<a name='2112'>
#else<a name='2113'>
    dustc(ims:ime,jms:jme,:)=0.<a name='2114'>
#endif<a name='2115'>
   <a name='2116'>
    <font color=#447700>! Calculate severe weather diagnostics.  These variables should only be<a name='2117'></font>
    <font color=#447700>! output at highest frequency output.  (e.g. auxhist2)<a name='2118'></font>
    <font color=#447700>! ---------------------------------------------------------------------<a name='2119'></font>
    IF ( config_flags % afwa_severe_opt == 1 ) THEN<a name='2120'>
<a name='2121'>
      <font color=#447700>! After each history dump, reset max/min value arrays<a name='2122'></font>
      <font color=#447700>! Note: This resets up_heli_max which is currently calculated within<a name='2123'></font>
      <font color=#447700>! rk_first_rk_step_part2.F, may want to move to this diagnostics package<a name='2124'></font>
      <font color=#447700>! later<a name='2125'></font>
      <font color=#447700>! ----------------------------------------------------------------------<a name='2126'></font>
      IF ( is_after_history_dump ) THEN<a name='2127'>
        DO j = jms, jme<a name='2128'>
          DO i = ims, ime<a name='2129'>
<font color=#447700>!            grid%wspd10max(i,j) = 0.<a name='2130'></font>
            grid%w_up_max(i,j) = 0.<a name='2131'>
            grid%w_dn_max(i,j) = 0.<a name='2132'>
            grid%tcoli_max(i,j) = 0.<a name='2133'>
            grid%grpl_flx_max(i,j) = 0.<a name='2134'>
            grid%up_heli_max(i,j) = 0.<a name='2135'>
<font color=#447700>!            grid%refd_max(i,j) = 0.<a name='2136'></font>
            grid%afwa_tornado(i,j) = 0.<a name='2137'>
            grid%midrh_min_old(i,j) = grid%midrh_min(i,j) <font color=#447700>! Save old midrh_min<a name='2138'></font>
            grid%midrh_min(i,j) = 999.<a name='2139'>
            grid%afwa_hail(i,j) = 0.<a name='2140'>
          ENDDO<a name='2141'>
        ENDDO<a name='2142'>
      ENDIF  <font color=#447700>! is_after_history_dump<a name='2143'></font>
<a name='2144'>
      IF ( ( is_first_timestep ) .OR. ( is_output_timestep ) ) THEN<a name='2145'>
        do_buoy_calc = .true.<a name='2146'>
      ELSE<a name='2147'>
        do_buoy_calc = .false.<a name='2148'>
      ENDIF<a name='2149'>
<a name='2150'>
      <font color=#447700>!--&gt;RAS<a name='2151'></font>
      <font color=#447700>! We need to do some neighboring gridpoint comparisons in this next function;<a name='2152'></font>
      <font color=#447700>! set these values so we don't go off the edges of the domain.  Updraft<a name='2153'></font>
      <font color=#447700>! duration on domain edges will always be 0.<a name='2154'></font>
      <font color=#447700>! ----------------------------------------------------------------------<a name='2155'></font>
      i_start = its<a name='2156'>
      i_end   = ite<a name='2157'>
      j_start = jts<a name='2158'>
      j_end   = jte<a name='2159'>
<a name='2160'>
      IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='2161'>
           config_flags%nested) i_start = MAX( ids+1, its )<a name='2162'>
      IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='2163'>
           config_flags%nested) i_end   = MIN( ide-1, ite )<a name='2164'>
      IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='2165'>
           config_flags%nested) j_start = MAX( jds+1, jts )<a name='2166'>
      IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='2167'>
           config_flags%nested) j_end   = MIN( jde-1, jte )<a name='2168'>
      IF ( config_flags%periodic_x ) i_start = its<a name='2169'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='2170'>
<a name='2171'>
      CALL <A href='../../html_code/phys/module_diag_afwa.F.html#SEVERE_WX_DIAGNOSTICS'>severe_wx_diagnostics</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SEVERE_WX_DIAGNOSTICS_1"> ( grid % wspd10max             &amp;<a name='2172'>
                             , grid % w_up_max                  &amp;<a name='2173'>
                             , grid % w_dn_max                  &amp;<a name='2174'>
                             , grid % up_heli_max               &amp;<a name='2175'>
                             , grid % tcoli_max                 &amp;<a name='2176'>
                             , grid % midrh_min_old             &amp;<a name='2177'>
                             , grid % midrh_min                 &amp;<a name='2178'>
                             , grid % afwa_hail                 &amp;<a name='2179'>
                             , grid % afwa_cape                 &amp;<a name='2180'>
                             , grid % afwa_cin                  &amp;<a name='2181'>
<font color=#447700>!                             , grid % afwa_cape_mu              &amp;<a name='2182'></font>
<font color=#447700>!                             , grid % afwa_cin_mu               &amp;<a name='2183'></font>
                             , grid % afwa_zlfc                 &amp;<a name='2184'>
                             , grid % afwa_plfc                 &amp;<a name='2185'>
                             , grid % afwa_lidx                 &amp;<a name='2186'>
                             , llws                             &amp;<a name='2187'>
                             , grid % afwa_tornado              &amp;<a name='2188'>
                             , grid % grpl_flx_max              &amp;<a name='2189'>
                             , grid % u10                       &amp;<a name='2190'>
                             , grid % v10                       &amp;<a name='2191'>
                             , grid % w_2                       &amp;<a name='2192'>
                             , grid % uh                        &amp;<a name='2193'>
                             , grid % t_phy                     &amp;<a name='2194'>
                             , grid % t2                        &amp;<a name='2195'>
                             , grid % z                         &amp;<a name='2196'>
                             , grid % ht                        &amp;<a name='2197'>
                             , grid % tornado_mask              &amp;<a name='2198'>
                             , grid % tornado_dur               &amp;<a name='2199'>
                             , grid % dt                        &amp;<a name='2200'>
                             , grid % afwa_pwat                 &amp;<a name='2201'>
                             , u_phy                            &amp;<a name='2202'>
                             , v_phy                            &amp;<a name='2203'>
                             , ptot                             &amp;<a name='2204'>
                             , qice                             &amp;<a name='2205'>
                             , qsnow                            &amp;<a name='2206'>
                             , qgrpl                            &amp;<a name='2207'>
                             , ngraup                           &amp;<a name='2208'>
                             , qvapr, qrain, qcloud             &amp;<a name='2209'>
                             , rho                              &amp;<a name='2210'>
                             , dz8w                             &amp;<a name='2211'>
                             , rh                               &amp;<a name='2212'>
                             , do_buoy_calc                     &amp;<a name='2213'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='2214'>
                             , its, ite, jts, jte               &amp;<a name='2215'>
                             , k_start, k_end                   &amp;<a name='2216'>
                             , j_start, j_end, i_start, i_end   )<a name='2217'>
<a name='2218'>
    ENDIF   <font color=#447700>! afwa_severe_opt == 1<a name='2219'></font>
<a name='2220'>
    <font color=#447700>! Calculate precipitation type diagnostics<a name='2221'></font>
    <font color=#447700>! ----------------------------------------<a name='2222'></font>
    IF ( config_flags % afwa_ptype_opt == 1 ) THEN<a name='2223'>
    <a name='2224'>
      <font color=#447700>! First initialize precip buckets<a name='2225'></font>
      <font color=#447700>! -------------------------------<a name='2226'></font>
      IF ( grid % itimestep .eq. 1) THEN<a name='2227'>
        DO i=ims,ime<a name='2228'>
          DO j=jms,jme<a name='2229'>
            grid % afwa_rain(i,j)=0.<a name='2230'>
            grid % afwa_snow(i,j)=0.<a name='2231'>
            grid % afwa_ice(i,j)=0.<a name='2232'>
            grid % afwa_fzra(i,j)=0.<a name='2233'>
            grid % afwa_snowfall(i,j)=0.<a name='2234'>
          ENDDO<a name='2235'>
        ENDDO<a name='2236'>
      ENDIF<a name='2237'>
  <a name='2238'>
      <font color=#447700>! Diagnose precipitation type<a name='2239'></font>
      <font color=#447700>! ---------------------------<a name='2240'></font>
      CALL <A href='../../html_code/phys/module_diag_afwa.F.html#PRECIP_TYPE_DIAGNOSTICS'>precip_type_diagnostics</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PRECIP_TYPE_DIAGNOSTICS_1"> ( grid % t_phy               &amp;<a name='2241'>
                             , grid % t2                        &amp;<a name='2242'>
                             , rh                               &amp;<a name='2243'>
                             , grid % z                         &amp;<a name='2244'>
                             , grid % ht                        &amp;<a name='2245'>
                             , grid % afwa_precip               &amp;<a name='2246'>
                             , grid % swdown                    &amp;<a name='2247'>
                             , grid % afwa_rain                 &amp;<a name='2248'>
                             , grid % afwa_snow                 &amp;<a name='2249'>
                             , grid % afwa_ice                  &amp;<a name='2250'>
                             , grid % afwa_fzra                 &amp;<a name='2251'>
                             , grid % afwa_snowfall             &amp;<a name='2252'>
                             , grid % afwa_ptype_ccn_tmp        &amp;<a name='2253'>
                             , grid % afwa_ptype_tot_melt       &amp;<a name='2254'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='2255'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='2256'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='2257'>
    ENDIF  <font color=#447700>! afwa_ptype_opt == 1<a name='2258'></font>
  <a name='2259'>
    <font color=#447700>! --------------------------------------------------------------<a name='2260'></font>
    <font color=#447700>! The following packages are calculated only on output timesteps<a name='2261'></font>
    <font color=#447700>! --------------------------------------------------------------<a name='2262'></font>
    IF ( is_output_timestep ) THEN      <a name='2263'>
<a name='2264'>
      <font color=#447700>! Calculate mean sea level pressure<a name='2265'></font>
      <font color=#447700>! ---------------------------------<a name='2266'></font>
      DO j = jms, jme<a name='2267'>
        DO i = ims, ime<a name='2268'>
          grid % afwa_mslp  ( i, j ) =   MSLP ( grid % ht ( i, j )           &amp; <a name='2269'>
                                              , grid % psfc ( i, j )         &amp;<a name='2270'>
                                              , grid % z ( i, kms, j )       &amp; <a name='2271'>
                                              , qvapr ( i, kms, j )          &amp;  <a name='2272'>
                                              , grid % t_phy ( i, kms, j ) )<a name='2273'>
        ENDDO<a name='2274'>
      ENDDO<a name='2275'>
<a name='2276'>
      <font color=#447700>! Calculate 10 meter winds<a name='2277'></font>
      <font color=#447700>! ------------------------<a name='2278'></font>
      DO i=ims,ime<a name='2279'>
        DO j=jms,jme<a name='2280'>
          wind10m(i,j)=<A href='../../html_code/phys/module_diag_afwa.F.html#UV_WIND'>uv_wind</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UV_WIND_1">(grid%u10(i,j),grid%v10(i,j))<a name='2281'>
        ENDDO<a name='2282'>
      ENDDO<a name='2283'>
<a name='2284'>
      <font color=#447700>! Calculate 2 meter relative humidity/Tv<a name='2285'></font>
      <font color=#447700>! --------------------------------------<a name='2286'></font>
      DO i=ims,ime<a name='2287'>
        DO j=jms,jme<a name='2288'>
          rh2m(i,j)=<A href='../../html_code/phys/module_diag_afwa.F.html#CALC_RH'>calc_rh</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_RH_3">(grid%psfc(i,j), grid%t2(i,j), grid%q2(i,j))<a name='2289'>
          tv2m(i,j)=grid%t2(i,j) * (1 + 0.61 * grid%q2(i,j))<a name='2290'>
        ENDDO<a name='2291'>
      ENDDO<a name='2292'>
 <a name='2293'>
      <font color=#447700>! Calculate buoyancy parameters.<a name='2294'></font>
      <font color=#447700>! ------------------------------<a name='2295'></font>
      IF ( config_flags % afwa_buoy_opt == 1 ) THEN<a name='2296'>
        nz = k_end - k_start + 1<a name='2297'>
<a name='2298'>
        <font color=#447700>! Calculate buoyancy for surface parcel<a name='2299'></font>
        <font color=#447700>! -------------------------------------<a name='2300'></font>
        DO j = jts, jte<a name='2301'>
          DO i = its, ite<a name='2302'>
            ostat = Buoyancy (                                   nz &amp;<a name='2303'>
                                     ,      grid%t_phy(i,kms:kme,j) &amp;<a name='2304'>
                                     ,              rh(i,kms:kme,j) &amp;<a name='2305'>
                                     ,            ptot(i,kms:kme,j) &amp;<a name='2306'>
                                     ,        grid % z(i,kms:kme,j) &amp;<a name='2307'>
                                     ,                            1 &amp;<a name='2308'>
                                     ,        grid % afwa_cape(i,j) &amp;<a name='2309'>
                                     ,         grid % afwa_cin(i,j) &amp;<a name='2310'>
                                     ,                     zlfc_msl &amp;<a name='2311'>
                                     ,        grid % afwa_plfc(i,j) &amp;<a name='2312'>
                                     ,        grid % afwa_lidx(i,j) &amp;<a name='2313'>
                                     ,                        3 ) <font color=#447700>!Surface<a name='2314'></font>
        <a name='2315'>
            <font color=#447700>! Subtract terrain height to convert ZLFC from MSL to AGL<a name='2316'></font>
            <font color=#447700>! -------------------------------------------------------<a name='2317'></font>
            IF ( zlfc_msl .ge. grid % ht ( i, j ) ) THEN<a name='2318'>
              grid % afwa_zlfc ( i, j ) = zlfc_msl - grid % ht ( i, j )<a name='2319'>
            ELSE<a name='2320'>
              grid % afwa_zlfc( i, j ) = -1.<a name='2321'>
            ENDIF<a name='2322'>
<a name='2323'>
            <font color=#447700>! Add 273.15 to lifted index per some standard I don't understand<a name='2324'></font>
            <font color=#447700>! ---------------------------------------------------------------<a name='2325'></font>
            IF ( grid % afwa_lidx ( i, j ) .ne. 999. ) THEN<a name='2326'>
              grid % afwa_lidx ( i, j ) = grid % afwa_lidx ( i, j ) + 273.15<a name='2327'>
            ENDIF<a name='2328'>
 <a name='2329'>
            <font color=#447700>! Calculate buoyancy again for most unstable layer<a name='2330'></font>
            <font color=#447700>! ------------------------------------------------<a name='2331'></font>
            ostat = Buoyancy (                                   nz &amp;<a name='2332'>
                                     ,      grid%t_phy(i,kms:kme,j) &amp;<a name='2333'>
                                     ,              rh(i,kms:kme,j) &amp;<a name='2334'>
                                     ,            ptot(i,kms:kme,j) &amp;<a name='2335'>
                                     ,        grid % z(i,kms:kme,j) &amp;<a name='2336'>
                                     ,                            1 &amp;<a name='2337'>
                                     ,     grid % afwa_cape_mu(i,j) &amp;<a name='2338'>
                                     ,      grid % afwa_cin_mu(i,j) &amp;<a name='2339'>
                                     ,                         dum1 &amp;<a name='2340'>
                                     ,                         dum2 &amp;<a name='2341'>
                                     ,                         dum3 &amp;<a name='2342'>
                                     ,                        1 ) <font color=#447700>!Most unstable<a name='2343'></font>
        <a name='2344'>
          ENDDO<a name='2345'>
        ENDDO<a name='2346'>
      ENDIF  <font color=#447700>! afwa_buoy_opt == 1<a name='2347'></font>
<a name='2348'>
      IF ( config_flags % afwa_therm_opt == 1 ) THEN<a name='2349'>
        write ( message, * ) 'Calculating thermal indices'<a name='2350'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_559">( 100 , message )<a name='2351'>
        CALL <A href='../../html_code/phys/module_diag_afwa.F.html#THERMAL_DIAGNOSTICS'>thermal_diagnostics</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THERMAL_DIAGNOSTICS_1"> ( grid % t2                        &amp;<a name='2352'>
                                 , grid % psfc                      &amp;<a name='2353'>
                                 , rh2m                             &amp;<a name='2354'>
                                 , wind10m                          &amp;<a name='2355'>
                                 , grid % afwa_heatidx              &amp;<a name='2356'>
                                 , grid % afwa_wchill               &amp;<a name='2357'>
                                 , grid % afwa_fits                 &amp;<a name='2358'>
                                 , ids, ide, jds, jde, kds, kde     &amp;<a name='2359'>
                                 , ims, ime, jms, jme, kms, kme     &amp;<a name='2360'>
                                 , ips, ipe, jps, jpe, kps, kpe )<a name='2361'>
      ENDIF  <font color=#447700>! afwa_therm_opt == 1<a name='2362'></font>
<a name='2363'>
      IF ( config_flags % afwa_turb_opt == 1 ) THEN<a name='2364'>
        write ( message, * ) 'Calculating turbulence indices'<a name='2365'>
<a name='2366'>
        <font color=#447700>!~ For now, hard code turbulence layer bottom and top AGL heights<a name='2367'></font>
        <font color=#447700>!  --------------------------------------------------------------<a name='2368'></font>
        grid % afwa_tlyrbot = (/ 1500., 3000., 4600., 6100., 7600., 9100.,   &amp;<a name='2369'>
                                  10700. /)<a name='2370'>
        grid % afwa_tlyrtop = (/ 3000., 4600., 6100., 7600., 9100., 10700.,  &amp;<a name='2371'>
                                  12700. /)<a name='2372'>
        call <A href='../../html_code/phys/module_diag_afwa.F.html#TURBULENCE_DIAGNOSTICS'>turbulence_diagnostics</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TURBULENCE_DIAGNOSTICS_1"> ( u_phy                     &amp;<a name='2373'>
                             , v_phy                            &amp;<a name='2374'>
                             , grid % t_phy                     &amp;<a name='2375'>
                             , ptot                             &amp;<a name='2376'>
                             , zagl                             &amp;<a name='2377'>
                             , grid % defor11                   &amp;<a name='2378'>
                             , grid % defor12                   &amp;<a name='2379'>
                             , grid % defor22                   &amp;<a name='2380'>
                             , grid % afwa_turb                 &amp;<a name='2381'>
                             , grid % afwa_llturb               &amp;<a name='2382'>
                             , grid % afwa_llturblgt            &amp;<a name='2383'>
                             , grid % afwa_llturbmdt            &amp;<a name='2384'>
                             , grid % afwa_llturbsvr            &amp;<a name='2385'>
                             <font color=#447700>!, config_flags % num_turb_layers   &amp;<a name='2386'></font>
                             , 7                                &amp;<a name='2387'>
                             , grid % afwa_tlyrbot              &amp;<a name='2388'>
                             , grid % afwa_tlyrtop              &amp;<a name='2389'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='2390'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='2391'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='2392'>
      ENDIF  <font color=#447700>! afwa_turb_opt == 1<a name='2393'></font>
<a name='2394'>
      <font color=#447700>! Calculate equivalent radar reflectivity factor (z_e) using <a name='2395'></font>
      <font color=#447700>! old RIP code (2004) if running radar or VIL packages.<a name='2396'></font>
      <font color=#447700>! ----------------------------------------------------------<a name='2397'></font>
      IF ( config_flags % afwa_radar_opt == 1 .or. &amp;<a name='2398'>
         config_flags % afwa_vil_opt == 1 ) THEN<a name='2399'>
        write ( message, * ) 'Calculating Radar'<a name='2400'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_560">( 100 , message )<a name='2401'>
        CALL <A href='../../html_code/phys/module_diag_afwa.F.html#WRF_DBZCALC'>wrf_dbzcalc</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DBZCALC_1"> ( rho                                  &amp;<a name='2402'>
                             , grid%t_phy                       &amp;<a name='2403'>
                             , qrain                            &amp;<a name='2404'>
                             , qsnow                            &amp;<a name='2405'>
                             , qgrpl                            &amp;<a name='2406'>
                             , z_e                              &amp;<a name='2407'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='2408'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='2409'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='2410'>
      ENDIF  <font color=#447700>! afwa_radar_opt == 1 .or. afwa_vil_opt == 1<a name='2411'></font>
<a name='2412'>
      <font color=#447700>! Calculate derived radar variables<a name='2413'></font>
      <font color=#447700>! ---------------------------------<a name='2414'></font>
      <font color=#447700>! UPDATE: removed refd_max calculation, which was not working correctly.<a name='2415'></font>
      <font color=#447700>! To correctly calculate refd_max, this routine could be called every<a name='2416'></font>
      <font color=#447700>! time step, but instead, we are only going to calculate reflectivity<a name='2417'></font>
      <font color=#447700>! on output time steps and avoid cost of calculating refd_max. GAC2014<a name='2418'></font>
      <font color=#447700>! ----------------------------------------------------------------------<a name='2419'></font>
      IF ( config_flags % afwa_radar_opt == 1 ) THEN<a name='2420'>
        write ( message, * ) 'Calculating derived radar variables'<a name='2421'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_561">( 100 , message )<a name='2422'>
        CALL <A href='../../html_code/phys/module_diag_afwa.F.html#RADAR_DIAGNOSTICS'>radar_diagnostics</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADAR_DIAGNOSTICS_1"> ( grid % refd                    &amp;<a name='2423'>
                             , grid % refd_com                  &amp;<a name='2424'>
<font color=#447700>!                             , grid % refd_max                  &amp;<a name='2425'></font>
                             , grid % echotop                   &amp;<a name='2426'>
                             , grid % z                         &amp;<a name='2427'>
                             , z_e                              &amp;<a name='2428'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='2429'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='2430'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='2431'>
      ENDIF  <font color=#447700>! afwa_radar_opt == 1<a name='2432'></font>
<a name='2433'>
      <font color=#447700>! Calculate VIL and reflectivity every history output timestep<a name='2434'></font>
      <font color=#447700>! ------------------------------------------------------------<a name='2435'></font>
      IF ( config_flags % afwa_vil_opt == 1 ) THEN<a name='2436'>
        write ( message, * ) 'Calculating VIL'<a name='2437'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_562">( 100 , message )<a name='2438'>
        CALL <A href='../../html_code/phys/module_diag_afwa.F.html#VERT_INT_LIQUID_DIAGNOSTICS'>vert_int_liquid_diagnostics</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERT_INT_LIQUID_DIAGNOSTICS_1"> ( grid % vil           &amp;<a name='2439'>
                             , grid % radarvil                  &amp;<a name='2440'>
                             , grid % t_phy                     &amp;<a name='2441'>
                             , qrain                            &amp;<a name='2442'>
                             , qsnow                            &amp;<a name='2443'>
                             , qgrpl                            &amp;<a name='2444'>
                             , z_e                              &amp;<a name='2445'>
                             , dz8w                             &amp;<a name='2446'>
                             , rho                              &amp;<a name='2447'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='2448'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='2449'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='2450'>
      ENDIF  <font color=#447700>! afwa_vil_opt ==1 <a name='2451'></font>
<a name='2452'>
      <font color=#447700>! Calculate icing and freezing level<a name='2453'></font>
      <font color=#447700>! ----------------------------------<a name='2454'></font>
      IF ( config_flags % afwa_icing_opt == 1 ) THEN<a name='2455'>
<a name='2456'>
        <font color=#447700>! Determine icing option from microphysics scheme<a name='2457'></font>
        <font color=#447700>! -----------------------------------------------<a name='2458'></font>
        <a name='2459'>
        IF ( config_flags % mp_physics == GSFCGCESCHEME ) THEN<a name='2460'>
          icing_opt=1<a name='2461'>
        ELSEIF ( config_flags % mp_physics == ETAMPNEW ) THEN<a name='2462'>
          icing_opt=2<a name='2463'>
        ELSEIF ( config_flags % mp_physics == THOMPSON ) THEN<a name='2464'>
          icing_opt=3<a name='2465'>
        ELSEIF ( config_flags % mp_physics == WSM5SCHEME .OR.   &amp;<a name='2466'>
                 config_flags % mp_physics == WSM6SCHEME ) THEN<a name='2467'>
          icing_opt=4<a name='2468'>
        ELSEIF ( config_flags % mp_physics == MORR_TWO_MOMENT ) THEN<a name='2469'>
<a name='2470'>
          <font color=#447700>! Is this run with prognostic cloud droplets or no?<a name='2471'></font>
          <font color=#447700>! -------------------------------------------------<a name='2472'></font>
          IF (config_flags % progn &gt; 0) THEN<a name='2473'>
             icing_opt=6<a name='2474'>
          ELSE<a name='2475'>
             icing_opt=5<a name='2476'>
          ENDIF<a name='2477'>
        ELSEIF ( config_flags % mp_physics == WDM6SCHEME ) THEN<a name='2478'>
          icing_opt=7<a name='2479'>
        ELSE<a name='2480'>
          icing_opt=0  <font color=#447700>! Not supported<a name='2481'></font>
        ENDIF<a name='2482'>
 <a name='2483'>
        write ( message, * ) 'Calculating Icing with icing opt ',icing_opt <a name='2484'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_563">( 100 , message )<a name='2485'>
        CALL <A href='../../html_code/phys/module_diag_afwa.F.html#ICING_DIAGNOSTICS'>icing_diagnostics</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICING_DIAGNOSTICS_1"> ( icing_opt                      &amp;<a name='2486'>
                             , grid % fzlev                     &amp;<a name='2487'>
                             , grid % icing_lg                  &amp;<a name='2488'>
                             , grid % icing_sm                  &amp;<a name='2489'>
                             , grid % qicing_lg_max             &amp;<a name='2490'>
                             , grid % qicing_sm_max             &amp;<a name='2491'>
                             , grid % qicing_lg                 &amp;<a name='2492'>
                             , grid % qicing_sm                 &amp;<a name='2493'>
                             , grid % icingtop                  &amp;<a name='2494'>
                             , grid % icingbot                  &amp;<a name='2495'>
                             , grid % t_phy                     &amp;<a name='2496'>
                             , grid % z                         &amp;<a name='2497'>
                             , dz8w                             &amp;<a name='2498'>
                             , rho                              &amp;<a name='2499'>
                             , qrain                            &amp;<a name='2500'>
                             , qcloud                           &amp;<a name='2501'>
                             , ncloud                           &amp;<a name='2502'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='2503'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='2504'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='2505'>
      ENDIF  <font color=#447700>! afwa_icing_opt<a name='2506'></font>
<a name='2507'>
      <font color=#447700>! Calculate visiblility diagnostics<a name='2508'></font>
      <font color=#447700>! ---------------------------------<a name='2509'></font>
      IF ( config_flags % afwa_vis_opt == 1 ) THEN<a name='2510'>
   <a name='2511'>
        <font color=#447700>! Interpolate 20m temperature and RH<a name='2512'></font>
        <font color=#447700>! ----------------------------------<a name='2513'></font>
        DO i=ims,ime<a name='2514'>
          DO j=jms,jme<a name='2515'>
            tv20m(i,j) = -999.<a name='2516'>
            rh20m(i,j) = -999.<a name='2517'>
            DO k = kps, MIN(kpe,kde-1)<a name='2518'>
              IF (tv20m (i,j) .eq. -999. .AND. zagl (i,k,j) .ge. 20.) THEN<a name='2519'>
<a name='2520'>
                <font color=#447700>! If the lowest model level &gt; 20 m AGL, interpolate using 2-m temperature/RH<a name='2521'></font>
                <font color=#447700>! --------------------------------------------------------------------------<a name='2522'></font>
                IF (k .eq. kps) THEN<a name='2523'>
                  tv20m(i,j) = tv2m(i,j) + &amp;<a name='2524'>
                               (20. - 2.) / &amp;<a name='2525'>
                               (zagl(i,k,j) - 2.) * &amp;<a name='2526'>
                               (grid%t_phy(i,k,j) * (1 + 0.61 * qvapr(i,k,j)) - tv2m(i,j))<a name='2527'>
                  rh20m(i,j) = rh2m(i,j) + &amp;<a name='2528'>
                               (20. - 2.) / &amp;<a name='2529'>
                               (zagl(i,k,j) - 2.) * &amp;<a name='2530'>
                               (rh(i,k,j) - rh2m(i,j))<a name='2531'>
                ELSE<a name='2532'>
                  tv20m(i,j) = grid%t_phy(i,k-1,j) * (1 + 0.61 * qvapr(i,k-1,j)) + &amp;<a name='2533'>
                               ((20. - zagl(i,k-1,j)) / &amp;<a name='2534'>
                               (zagl(i,k,j) - zagl(i,k-1,j))) * &amp;<a name='2535'>
                               (grid%t_phy(i,k,j) * (1 + 0.61 * qvapr(i,k,j)) - &amp;<a name='2536'>
                               grid%t_phy(i,k-1,j) * (1 + 0.61 * qvapr(i,k-1,j)))<a name='2537'>
                  rh20m(i,j) = rh (i,k-1,j) + &amp;<a name='2538'>
                               ((20. - zagl (i,k-1,j)) / &amp;<a name='2539'>
                               (zagl (i,k,j) - zagl (i,k-1,j))) * &amp;<a name='2540'>
                               (rh (i,k,j) - rh (i,k-1,j))<a name='2541'>
                ENDIF<a name='2542'>
              ENDIF<a name='2543'>
            ENDDO<a name='2544'>
          ENDDO<a name='2545'>
        ENDDO<a name='2546'>
<a name='2547'>
        <font color=#447700>! Calculate 125 meter winds<a name='2548'></font>
        <font color=#447700>! -------------------------<a name='2549'></font>
        DO i=ims,ime<a name='2550'>
          DO j=jms,jme<a name='2551'>
            wind125m(i,j) = -999.<a name='2552'>
            DO k = kps, MIN(kpe,kde-1)<a name='2553'>
              IF (wind125m (i,j) .eq. -999. .AND. zagl (i,k,j) .ge. 125.) THEN<a name='2554'>
<a name='2555'>
                <font color=#447700>! If the lowest model level &gt; 125 m AGL, use level 1 wind<a name='2556'></font>
                <font color=#447700>! -------------------------------------------------------<a name='2557'></font>
                IF (k .eq. kps) THEN<a name='2558'>
                  wind125m(i,j) = <A href='../../html_code/phys/module_diag_afwa.F.html#UV_WIND'>uv_wind</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UV_WIND_2">(u_phy(i,k,j),v_phy(i,k,j))<a name='2559'>
                ELSE<a name='2560'>
                  wind125m(i,j) = <A href='../../html_code/phys/module_diag_afwa.F.html#UV_WIND'>uv_wind</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UV_WIND_3">(u_phy(i,k-1,j),v_phy(i,k-1,j)) + &amp;<a name='2561'>
                               ((125. - zagl(i,k-1,j)) / &amp;<a name='2562'>
                               (zagl(i,k,j) - zagl(i,k-1,j))) * &amp;<a name='2563'>
                               (uv_wind(u_phy(i,k,j),v_phy(i,k,j)) - &amp;<a name='2564'>
                               uv_wind(u_phy(i,k-1,j),v_phy(i,k-1,j)))<a name='2565'>
                ENDIF<a name='2566'>
              ENDIF<a name='2567'>
            ENDDO<a name='2568'>
          ENDDO<a name='2569'>
        ENDDO<a name='2570'>
<a name='2571'>
        write ( message, * ) 'Calculating visibility'<a name='2572'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_564">( 100 , message )<a name='2573'>
        CALL <A href='../../html_code/phys/module_diag_afwa.F.html#VIS_DIAGNOSTICS'>vis_diagnostics</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VIS_DIAGNOSTICS_1"> ( qcloud(ims:ime,k_start,jms:jme)  &amp;<a name='2574'>
                             , qrain(ims:ime,k_start,jms:jme)   &amp;<a name='2575'>
                             , qice(ims:ime,k_start,jms:jme)    &amp;<a name='2576'>
                             , qsnow(ims:ime,k_start,jms:jme)   &amp;<a name='2577'>
                             , qgrpl(ims:ime,k_start,jms:jme)   &amp;<a name='2578'>
                             , rho(ims:ime,k_start,jms:jme)     &amp;<a name='2579'>
                             , wind10m                          &amp;<a name='2580'>
                             , wind125m                         &amp;<a name='2581'>
                             , grid % afwa_pwat                 &amp;<a name='2582'>
                             , grid % q2                        &amp;<a name='2583'>
                             , rh2m                             &amp;<a name='2584'>
                             , rh20m                            &amp;<a name='2585'>
                             , tv2m                             &amp;<a name='2586'>
                             , tv20m                            &amp;<a name='2587'>
                             , dustc                            &amp;<a name='2588'>
                             , grid % afwa_vis                  &amp;<a name='2589'>
                             , grid % afwa_vis_dust             &amp;<a name='2590'>
                             , grid % afwa_vis_alpha            &amp;<a name='2591'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='2592'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='2593'>
                             , ips, ipe, jps, jpe, kps, kpe ) <a name='2594'>
      ENDIF<a name='2595'>
<a name='2596'>
      <font color=#447700>! Calculate cloud diagnostics<a name='2597'></font>
      <font color=#447700>! ---------------------------<a name='2598'></font>
      IF ( config_flags % afwa_cloud_opt == 1 ) THEN<a name='2599'>
        write ( message, * ) 'Calculating cloud'<a name='2600'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_565">( 100 , message )<a name='2601'>
        CALL <A href='../../html_code/phys/module_diag_afwa.F.html#CLOUD_DIAGNOSTICS'>cloud_diagnostics</A><A href='../../html_code/phys/module_diag_afwa.F.html#AFWA_DIAGNOSTICS_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOUD_DIAGNOSTICS_1"> (qcloud                          &amp;<a name='2602'>
                             , qice                             &amp;<a name='2603'>
                             , qsnow                            &amp;<a name='2604'>
                             , rh_cld                           &amp;<a name='2605'>
                             , dz8w                             &amp;<a name='2606'>
                             , rho                              &amp;<a name='2607'>
                             , grid % z                         &amp;<a name='2608'>
                             , grid % ht                        &amp;<a name='2609'>
                             , grid % afwa_cloud                &amp;<a name='2610'>
                             , grid % afwa_cloud_ceil           &amp;<a name='2611'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='2612'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='2613'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='2614'>
      ENDIF<a name='2615'>
<a name='2616'>
    ENDIF  <font color=#447700>! is_output_timestep<a name='2617'></font>
<a name='2618'>
  END SUBROUTINE afwa_diagnostics_driver<a name='2619'>
<a name='2620'>
<a name='2621'>
<a name='2622'>
<A NAME='SEVERE_WX_DIAGNOSTICS'><A href='../../html_code/phys/module_diag_afwa.F.html#SEVERE_WX_DIAGNOSTICS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2623'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>severe_wx_diagnostics</font> ( wspd10max                  &amp; <A href='../../call_to/SEVERE_WX_DIAGNOSTICS.html' TARGET='index'>1</A><a name='2624'>
                             , w_up_max                         &amp;<a name='2625'>
                             , w_dn_max                         &amp;<a name='2626'>
                             , up_heli_max                      &amp;<a name='2627'>
                             , tcoli_max                        &amp;<a name='2628'>
                             , midrh_min_old                    &amp;<a name='2629'>
                             , midrh_min                        &amp;<a name='2630'>
                             , afwa_hail                        &amp;<a name='2631'>
                             , cape                             &amp;<a name='2632'>
                             , cin                              &amp;<a name='2633'>
<font color=#447700>!                             , cape_mu                          &amp;<a name='2634'></font>
<font color=#447700>!                             , cin_mu                           &amp;<a name='2635'></font>
                             , zlfc                             &amp;<a name='2636'>
                             , plfc                             &amp;<a name='2637'>
                             , lidx                             &amp;<a name='2638'>
                             , llws                             &amp;<a name='2639'>
                             , afwa_tornado                     &amp;<a name='2640'>
                             , grpl_flx_max                     &amp;<a name='2641'>
                             , u10                              &amp;<a name='2642'>
                             , v10                              &amp;<a name='2643'>
                             , w_2                              &amp;<a name='2644'>
                             , uh                               &amp;<a name='2645'>
                             , t_phy                            &amp;<a name='2646'>
                             , t2                               &amp;<a name='2647'>
                             , z                                &amp;<a name='2648'>
                             , ht                               &amp;<a name='2649'>
                             , tornado_mask                     &amp;<a name='2650'>
                             , tornado_dur                      &amp;<a name='2651'>
                             , dt                               &amp;<a name='2652'>
                             , pwat                             &amp;<a name='2653'>
                             , u_phy                            &amp;<a name='2654'>
                             , v_phy                            &amp;<a name='2655'>
                             , p                                &amp;<a name='2656'>
                             , qi                               &amp;<a name='2657'>
                             , qs                               &amp;<a name='2658'>
                             , qg                               &amp;<a name='2659'>
                             , ng                               &amp;<a name='2660'>
                             , qv, qr, qc                       &amp;<a name='2661'>
                             , rho                              &amp;<a name='2662'>
                             , dz8w                             &amp;<a name='2663'>
                             , rh                               &amp;<a name='2664'>
                             , do_buoy_calc                     &amp;<a name='2665'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='2666'>
                             , its, ite, jts, jte               &amp;<a name='2667'>
                             , k_start, k_end                   &amp;<a name='2668'>
                             , j_start, j_end, i_start, i_end   )<a name='2669'>
<a name='2670'>
<a name='2671'>
    INTEGER, INTENT(IN) :: its, ite, jts, jte, k_start, k_end   &amp;<a name='2672'>
                         , ims, ime, jms, jme, kms, kme         &amp;<a name='2673'>
                         , j_start, j_end, i_start, i_end<a name='2674'>
<a name='2675'>
<a name='2676'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),               &amp;<a name='2677'>
         INTENT(IN   ) ::                                    p  &amp;<a name='2678'>
                                              ,            w_2  &amp;<a name='2679'>
                                              ,          t_phy  &amp;<a name='2680'>
                                              ,          u_phy  &amp;<a name='2681'>
                                              ,          v_phy  &amp;<a name='2682'>
                                              ,             qi  &amp;<a name='2683'>
                                              ,             qs  &amp;<a name='2684'>
                                              ,             qg  &amp;<a name='2685'>
                                              ,             ng  &amp;<a name='2686'>
                                              ,     qv, qr, qc  &amp;<a name='2687'>
                                              ,            rho  &amp;<a name='2688'>
                                              ,              z  &amp;<a name='2689'>
                                              ,           dz8w  &amp;<a name='2690'>
                                              ,             rh<a name='2691'>
<a name='2692'>
<a name='2693'>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='2694'>
         INTENT(IN   ) ::                                  u10  &amp;<a name='2695'>
                                              ,            v10  &amp;<a name='2696'>
                                              ,      wspd10max  &amp;<a name='2697'>
                                              ,             uh  &amp;<a name='2698'>
                                              ,             t2  &amp;<a name='2699'>
                                              ,             ht  &amp;<a name='2700'>
                                              ,  midrh_min_old  &amp;<a name='2701'>
                                              ,    up_heli_max  &amp;<a name='2702'>
                                              ,           llws  &amp;<a name='2703'>
                                              ,           pwat<a name='2704'>
<a name='2705'>
<a name='2706'>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='2707'>
         INTENT(INOUT) ::                             w_up_max  &amp; <a name='2708'>
                                              ,       w_dn_max  &amp;<a name='2709'>
                                              ,      tcoli_max  &amp;<a name='2710'>
                                              ,      midrh_min  &amp;<a name='2711'>
                                              ,      afwa_hail  &amp;<a name='2712'>
                                              ,   afwa_tornado  &amp;<a name='2713'>
                                              ,   grpl_flx_max  &amp;<a name='2714'>
                                              ,   tornado_mask  &amp;<a name='2715'>
                                              ,    tornado_dur <a name='2716'>
<a name='2717'>
<a name='2718'>
<font color=#447700>!    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='2719'></font>
<font color=#447700>!         INTENT(  OUT) ::                                 cape  &amp;<a name='2720'></font>
<font color=#447700>!                                              ,            cin  &amp;<a name='2721'></font>
<font color=#447700>!                                              ,        cape_mu  &amp;<a name='2722'></font>
<font color=#447700>!                                              ,         cin_mu  &amp;<a name='2723'></font>
<font color=#447700>!                                              ,           zlfc  &amp;<a name='2724'></font>
<font color=#447700>!                                              ,           plfc  &amp;<a name='2725'></font>
<font color=#447700>!                                              ,           lidx<a name='2726'></font>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='2727'>
         INTENT(INOUT) ::                                 cape  &amp;<a name='2728'>
                                              ,            cin  &amp;<a name='2729'>
                                              ,           zlfc  &amp;<a name='2730'>
                                              ,           plfc  &amp;<a name='2731'>
                                              ,           lidx<a name='2732'>
<a name='2733'>
    REAL, INTENT(IN) ::                                     dt<a name='2734'>
    LOGICAL, INTENT(IN) ::                        do_buoy_calc<a name='2735'>
<a name='2736'>
    <font color=#447700>! Local<a name='2737'></font>
    <font color=#447700>! -----<a name='2738'></font>
    INTEGER :: i,j,k<a name='2739'>
    INTEGER :: kts,kte<a name='2740'>
    REAL    :: zagl, zlfc_msl, melt_term, midrh_term, hail, midrh<a name='2741'>
    REAL    :: dum1, dum2, dum3<a name='2742'>
    REAL    :: tornado, lfc_term, shr_term, midrh2_term, uh_term<a name='2743'>
    REAL    :: wind_vel, p_tot, tcoli, grpl_flx, w_n15, qg_n15<a name='2744'>
    INTEGER :: nz, ostat<a name='2745'>
    REAL, DIMENSION( ims:ime, jms:jme ) ::                w_up  &amp;<a name='2746'>
                                              ,           w_dn  &amp;<a name='2747'>
                                           , tornado_mask_prev  &amp;<a name='2748'>
                                           ,  tornado_dur_prev<a name='2749'>
    REAL :: time_factor, time_factor_prev<a name='2750'>
    LOGICAL :: is_target_level<a name='2751'>
<a name='2752'>
    <font color=#447700>! Calculate midlevel relative humidity minimum<a name='2753'></font>
    <font color=#447700>! --------------------------------------------<a name='2754'></font>
    DO i=ims,ime<a name='2755'>
      DO j=jms,jme<a name='2756'>
        is_target_level=.false.<a name='2757'>
        DO k=kms,kme    <a name='2758'>
          zagl = z(i,k,j) - ht(i,j)<a name='2759'>
          IF ( ( zagl &gt;= 3500. ) .and. &amp;<a name='2760'>
               ( .NOT. is_target_level ) .and. &amp;<a name='2761'>
               ( k .ne. kms ) ) THEN<a name='2762'>
            is_target_level = .true.<a name='2763'>
            midrh = rh(i,k-1,j) + (3500. - (z(i,k-1,j) - ht(i,j))) &amp;<a name='2764'>
                    * ((rh(i,k,j) - rh(i,k-1,j))/(z(i,k,j) - z(i,k-1,j)))<a name='2765'>
            IF ( midrh .lt. midrh_min(i,j) ) THEN<a name='2766'>
              midrh_min(i,j) = midrh<a name='2767'>
            ENDIF<a name='2768'>
          ENDIF<a name='2769'>
        ENDDO<a name='2770'>
      ENDDO<a name='2771'>
    ENDDO<a name='2772'>
<a name='2773'>
    <font color=#447700>! Calculate the max 10 m wind speed between output times<a name='2774'></font>
    <font color=#447700>! ------------------------------------------------------<a name='2775'></font>
    <font color=#447700>!DO j = jts, jte<a name='2776'></font>
    <font color=#447700>!  DO i = its, ite<a name='2777'></font>
    <font color=#447700>!    wind_vel = uv_wind ( u10(i,j) , v10(i,j) )<a name='2778'></font>
    <font color=#447700>!    IF ( wind_vel .GT. wspd10max(i,j) ) THEN<a name='2779'></font>
    <font color=#447700>!      wspd10max(i,j) = wind_vel<a name='2780'></font>
    <font color=#447700>!    ENDIF<a name='2781'></font>
    <font color=#447700>!  ENDDO<a name='2782'></font>
    <font color=#447700>!ENDDO<a name='2783'></font>
 <a name='2784'>
    <font color=#447700>! Vertical velocity quantities between output times<a name='2785'></font>
    <font color=#447700>! -------------------------------------------------<a name='2786'></font>
    w_up=0.<a name='2787'>
    w_dn=0.<a name='2788'>
    DO j = jts, jte<a name='2789'>
      DO k = k_start, k_end<a name='2790'>
        DO i = its, ite<a name='2791'>
          p_tot = p(i,k,j) / 100.<a name='2792'>
 <a name='2793'>
          <font color=#447700>! Check vertical velocity field below 400 mb<a name='2794'></font>
          IF ( p_tot .GT. 400. .AND. w_2(i,k,j) .GT. w_up(i,j) ) THEN<a name='2795'>
            w_up(i,j) = w_2(i,k,j)<a name='2796'>
            IF ( w_up(i,j) .GT. w_up_max(i,j) ) THEN<a name='2797'>
              w_up_max(i,j) = w_up(i,j)<a name='2798'>
            ENDIF<a name='2799'>
          ENDIF<a name='2800'>
          IF ( p_tot .GT. 400. .AND. w_2(i,k,j) .LT. w_dn(i,j) ) THEN<a name='2801'>
            w_dn(i,j) = w_2(i,k,j)<a name='2802'>
            IF ( w_dn(i,j) .LT. w_dn_max(i,j) ) THEN<a name='2803'>
              w_dn_max(i,j) = w_dn(i,j)<a name='2804'>
            ENDIF<a name='2805'>
          ENDIF<a name='2806'>
        ENDDO<a name='2807'>
      ENDDO<a name='2808'>
    ENDDO<a name='2809'>
   <a name='2810'>
    <font color=#447700>! Hail diameter in millimeters (Weibull distribution)<a name='2811'></font>
    <font color=#447700>! ---------------------------------------------------<a name='2812'></font>
    DO j = jts, jte<a name='2813'>
      DO i = its, ite<a name='2814'>
        melt_term=max(t2(i,j)-288.15,0.)<a name='2815'>
        midrh_term=max(2*(min(midrh_min(i,j),midrh_min_old(i,j))-70.),0.)<a name='2816'>
        <font color=#447700>! Change exponent to 1.1 to reduce probabilities for large sizes<a name='2817'></font>
        <font color=#447700>!hail=max((w_up(i,j)/1.4)**1.25-melt_term-midrh_term,0.)<a name='2818'></font>
        hail=max((w_up(i,j)/1.4)**1.1-melt_term-midrh_term,0.)<a name='2819'>
        hail=hail*((uh(i,j)/100)+0.25)<a name='2820'>
        IF ( hail .gt. afwa_hail(i,j) ) THEN<a name='2821'>
          afwa_hail(i,j)=hail<a name='2822'>
        ENDIF<a name='2823'>
      ENDDO<a name='2824'>
    ENDDO<a name='2825'>
<a name='2826'>
    <font color=#447700>! Lightning (total column-integrated cloud ice)<a name='2827'></font>
    <font color=#447700>! Note this formula is basically stolen from the VIL calculation.<a name='2828'></font>
    <font color=#447700>! ---------------------------------------------------------------<a name='2829'></font>
    DO j = jts, jte<a name='2830'>
      DO i = its, ite<a name='2831'>
        tcoli=0.<a name='2832'>
        DO k = k_start, k_end<a name='2833'>
          tcoli =  tcoli + &amp;<a name='2834'>
          (qi (i,k,j) + &amp;<a name='2835'>
           qs (i,k,j) + &amp;<a name='2836'>
           qg (i,k,j))  &amp;<a name='2837'>
           *dz8w (i,k,j) * rho(i,k,j)<a name='2838'>
        ENDDO<a name='2839'>
        IF ( tcoli .GT. tcoli_max(i,j) ) THEN<a name='2840'>
          tcoli_max(i,j) = tcoli<a name='2841'>
        ENDIF<a name='2842'>
      ENDDO<a name='2843'>
    ENDDO<a name='2844'>
<a name='2845'>
    <font color=#447700>! Lighting (pseudo graupel flux calculation)<a name='2846'></font>
    <font color=#447700>! Model graupel mixing ration (g/kg) times w (m/s) at the -15C level<a name='2847'></font>
    <font color=#447700>! Values should range from around 25 in marginal lightning situations,<a name='2848'></font>
    <font color=#447700>! to over 400 in situations with very frequent lightning.<a name='2849'></font>
    <font color=#447700>! --------------------------------------------------------------------<a name='2850'></font>
    DO j = jts, jte<a name='2851'>
      DO i = its, ite<a name='2852'>
        grpl_flx=0<a name='2853'>
        w_n15=-999.<a name='2854'>
        DO k = k_start, k_end<a name='2855'>
          <a name='2856'>
          <font color=#447700>! Interpolate w and qg to -15C level and calculate graupel flux<a name='2857'></font>
          <font color=#447700>! as simply graupel x vertical velocity at -15C<a name='2858'></font>
          <font color=#447700>! -------------------------------------------------------------<a name='2859'></font>
          IF ( t_phy (i,k,j) .LE. 258.15 .AND. w_n15 .EQ. -999. .AND.   &amp;<a name='2860'>
               k .GT. k_start .AND. qg (i,k,j) .GT. 1.E-20 ) THEN<a name='2861'>
            w_n15 = w_2 (i,k,j)<a name='2862'>
            qg_n15 = 1000. * qg (i,k,j) <font color=#447700>! g/kg<a name='2863'></font>
            grpl_flx =  qg_n15 * w_n15   <a name='2864'>
          ENDIF<a name='2865'>
        ENDDO<a name='2866'>
        IF ( grpl_flx .GT. grpl_flx_max(i,j) ) THEN<a name='2867'>
          grpl_flx_max(i,j) = grpl_flx<a name='2868'>
        ENDIF<a name='2869'>
      ENDDO<a name='2870'>
    ENDDO<a name='2871'>
<a name='2872'>
    <font color=#447700>! Update buoyancy parameters.<a name='2873'></font>
    <font color=#447700>! ---------------------------<a name='2874'></font>
    IF ( do_buoy_calc ) THEN<a name='2875'>
      nz = k_end - k_start + 1<a name='2876'>
      DO j = jts, jte<a name='2877'>
        DO i = its, ite<a name='2878'>
          ostat = Buoyancy (                                   nz &amp;<a name='2879'>
                                       , t_phy(i,kms:kme      ,j) &amp;<a name='2880'>
                                       ,    rh(i,kms:kme      ,j) &amp;<a name='2881'>
                                       ,     p(i,kms:kme      ,j) &amp;<a name='2882'>
                                       ,     z(i,kms:kme      ,j) &amp;<a name='2883'>
                                       ,                        1 &amp;<a name='2884'>
                                       ,                cape(i,j) &amp;<a name='2885'>
                                       ,                 cin(i,j) &amp;<a name='2886'>
                                       ,                 zlfc_msl &amp;<a name='2887'>
                                       ,                plfc(i,j) &amp;<a name='2888'>
                                       ,                lidx(i,j) &amp;<a name='2889'>
                                       ,                        3 ) <font color=#447700>!Surface<a name='2890'></font>
<a name='2891'>
          <font color=#447700>! Add 273.15 to lifted index per some standard I don't understand<a name='2892'></font>
          <font color=#447700>! ---------------------------------------------------------------<a name='2893'></font>
          IF ( lidx ( i, j ) .ne. 999. ) lidx ( i, j ) = lidx ( i, j ) + 273.15<a name='2894'>
  <a name='2895'>
          <font color=#447700>! Subtract terrain height to convert ZLFC from MSL to AGL<a name='2896'></font>
          <font color=#447700>! -------------------------------------------------------<a name='2897'></font>
          IF ( zlfc_msl .ge. 0. ) THEN<a name='2898'>
            zlfc ( i, j ) = zlfc_msl - ht ( i, j )<a name='2899'>
          ELSE<a name='2900'>
            zlfc( i, j ) = -1.<a name='2901'>
          ENDIF<a name='2902'>
<a name='2903'>
        ENDDO<a name='2904'>
      ENDDO<a name='2905'>
    ENDIF<a name='2906'>
<a name='2907'>
    <font color=#447700>! Maximum tornado wind speed in ms-1.<a name='2908'></font>
    <font color=#447700>! First, save off old tornado mask and duration arrays<a name='2909'></font>
    <font color=#447700>! ----------------------------------------------------<a name='2910'></font>
    tornado_dur_prev(:,:)=tornado_dur(:,:)<a name='2911'>
    tornado_mask_prev(:,:)=tornado_mask(:,:)<a name='2912'>
<a name='2913'>
    <font color=#447700>! Initialize all tornado variables<a name='2914'></font>
    <font color=#447700>! --------------------------------<a name='2915'></font>
    tornado_mask(:,:)=0.<a name='2916'>
    tornado_dur(:,:)=0.<a name='2917'>
<a name='2918'>
    DO j = j_start, j_end<a name='2919'>
      DO i = i_start, i_end<a name='2920'>
        tornado = 0.<a name='2921'>
<a name='2922'>
        <font color=#447700>! Current tornado algorithm<a name='2923'></font>
        <font color=#447700>! -------------------------<a name='2924'></font>
        IF ( zlfc(i,j) .ge. 0. ) THEN<a name='2925'>
          uh_term = min(max((uh(i,j) - 25.) / 50., 0.), 1.)<a name='2926'>
          shr_term = min(max((llws(i,j) - 2.) / 10., 0.), 1.)<a name='2927'>
          lfc_term = min(max((3000. - zlfc(i,j)) / 1500., 0.), 1.)<a name='2928'>
          midrh2_term = min(max((90. - &amp;<a name='2929'>
                        min(midrh_min(i,j),midrh_min_old(i,j))) / 30., 0.), 1.)<a name='2930'>
          tornado = 50. * uh_term * shr_term * lfc_term * midrh2_term<a name='2931'>
        ENDIF<a name='2932'>
<a name='2933'>
        <font color=#447700>! Does tornado algorithm indicate all possible ingredients<a name='2934'></font>
        <font color=#447700>! for a minimum tornado, if so turn on mask<a name='2935'></font>
        <font color=#447700>! --------------------------------------------------------<a name='2936'></font>
        IF (tornado .GT. 0.) THEN<a name='2937'>
          tornado_mask(i,j) = 1.<a name='2938'>
        ENDIF<a name='2939'>
  <a name='2940'>
        <font color=#447700>! Update the duration of this tornado if there was previously<a name='2941'></font>
        <font color=#447700>! a tornado mask at this or an adjacent point<a name='2942'></font>
        <font color=#447700>! -----------------------------------------------------------<a name='2943'></font>
        IF ( ( tornado_mask(i,j) .GT. 0.5 )  .OR. &amp;<a name='2944'>
           ( MAXVAL(tornado_mask_prev(i-1:i+1,j-1:j+1)) .GT. 0.5 ) ) THEN<a name='2945'>
          tornado_dur(i,j) = MAXVAL(tornado_dur_prev(i-1:i+1,j-1:j+1)) + dt<a name='2946'>
        ENDIF<a name='2947'>
<a name='2948'>
        <font color=#447700>! Ramp up value of tornado beta value linearly in time until &amp;<a name='2949'></font>
        <font color=#447700>! it has been sustained 5 minutes<a name='2950'></font>
        <font color=#447700>! ------------------------------------------------------------<a name='2951'></font>
        time_factor = MIN(tornado_dur(i,j)/900.,1.)<a name='2952'>
        tornado = tornado * time_factor<a name='2953'>
<a name='2954'>
        <font color=#447700>! OPTIONAL<a name='2955'></font>
        <font color=#447700>! Adjust previous max tornado wind upward to account for longer <a name='2956'></font>
        <font color=#447700>! duration - if after 5 minutes, no adjustment made as<a name='2957'></font>
        <font color=#447700>! time_factor/time_factor_prev=1<a name='2958'></font>
        <font color=#447700>! -------------------------------------------------------------<a name='2959'></font>
        <font color=#447700>!time_factor_prev = MIN((tornado_dur(i,j) - dt)/900.,1.)<a name='2960'></font>
        <font color=#447700>!IF ( ( time_factor_prev .GT. 0. ) .AND. &amp;<a name='2961'></font>
        <font color=#447700>!   ( time_factor_prev .LT. 1. ) ) THEN<a name='2962'></font>
        <font color=#447700>!  afwa_tornado(i,j) = afwa_tornado(i,j) * time_factor/time_factor_prev<a name='2963'></font>
        <font color=#447700>!ENDIF<a name='2964'></font>
<a name='2965'>
        <font color=#447700>! Now that we are comparing apples to apples, see if current tornado<a name='2966'></font>
        <font color=#447700>! wind is higher than previous highest value for this point<a name='2967'></font>
        <font color=#447700>! ------------------------------------------------------------------<a name='2968'></font>
        IF ( tornado .GT. afwa_tornado(i,j) ) THEN<a name='2969'>
          afwa_tornado(i,j) = tornado<a name='2970'>
        ENDIF<a name='2971'>
      ENDDO<a name='2972'>
    ENDDO<a name='2973'>
<a name='2974'>
  END SUBROUTINE severe_wx_diagnostics<a name='2975'>
<a name='2976'>
<a name='2977'>
<a name='2978'>
<A NAME='VERT_INT_LIQUID_DIAGNOSTICS'><A href='../../html_code/phys/module_diag_afwa.F.html#VERT_INT_LIQUID_DIAGNOSTICS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2979'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>vert_int_liquid_diagnostics</font> ( vil                  &amp; <A href='../../call_to/VERT_INT_LIQUID_DIAGNOSTICS.html' TARGET='index'>1</A><a name='2980'>
                             , radarvil                         &amp;<a name='2981'>
                             , t_phy                            &amp;<a name='2982'>
                             , qrain                            &amp;<a name='2983'>
                             , qsnow                            &amp;<a name='2984'>
                             , qgrpl                            &amp;<a name='2985'>
                             , z_e                              &amp;<a name='2986'>
                             , dz8w                             &amp;<a name='2987'>
                             , rho                              &amp;<a name='2988'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='2989'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='2990'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='2991'>
<a name='2992'>
    INTEGER, INTENT(IN) :: ids, ide, jds, jde, kds, kde,        &amp;<a name='2993'>
                           ims, ime, jms, jme, kms, kme,        &amp;<a name='2994'>
                           ips, ipe, jps, jpe, kps, kpe<a name='2995'>
<a name='2996'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),               &amp;<a name='2997'>
         INTENT(IN) ::                                     rho  &amp;<a name='2998'>
                                              ,          qrain  &amp;<a name='2999'>
                                              ,          qsnow  &amp;<a name='3000'>
                                              ,          qgrpl  &amp; <a name='3001'>
                                              ,          t_phy  &amp;<a name='3002'>
                                              ,            z_e  &amp; <a name='3003'>
                                              ,           dz8w<a name='3004'>
<a name='3005'>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='3006'>
         INTENT(INOUT) ::                                  vil  &amp;<a name='3007'>
                                              ,       radarvil<a name='3008'>
<a name='3009'>
    <font color=#447700>! Local<a name='3010'></font>
    <font color=#447700>! -----<a name='3011'></font>
    INTEGER :: i,j,k,ktime<a name='3012'>
<a name='3013'>
    <font color=#447700>! Calculate vertically integrated liquid water (though its mostly not<a name='3014'></font>
    <font color=#447700>! "liquid" now is it?) [kg/m^2]<a name='3015'></font>
    <font color=#447700>! -------------------------------------------------------------------<a name='3016'></font>
    DO i = ips, MIN(ipe,ide-1)<a name='3017'>
    DO j = jps, MIN(jpe,jde-1)<a name='3018'>
      vil (i,j) = 0.0<a name='3019'>
      DO k = kps, MIN(kpe,kde-1)<a name='3020'>
        vil (i,j) =  vil (i,j) + &amp;<a name='3021'>
         (qrain (i,k,j) + &amp;<a name='3022'>
          qsnow (i,k,j) + &amp;<a name='3023'>
          qgrpl (i,k,j))  &amp;<a name='3024'>
          *dz8w (i,k,j) * rho(i,k,j)<a name='3025'>
      ENDDO<a name='3026'>
    ENDDO<a name='3027'>
    ENDDO<a name='3028'>
<a name='3029'>
    <font color=#447700>! Diagnose "radar-derived VIL" from equivalent radar reflectivity<a name='3030'></font>
    <font color=#447700>! radarVIL = (integral of LW*dz )/1000.0  (in kg/m^2)<a name='3031'></font>
    <font color=#447700>! LW = 0.00344 * z_e** (4/7)  in g/m^3<a name='3032'></font>
    <font color=#447700>! ---------------------------------------------------------------<a name='3033'></font>
    DO i = ips, MIN(ipe,ide-1)<a name='3034'>
    DO j = jps, MIN(jpe,jde-1)<a name='3035'>
      radarvil (i,j) = 0.0<a name='3036'>
      DO k = kps, MIN(kpe,kde-1)<a name='3037'>
        radarvil (i,j) = radarvil (i,j) + &amp;<a name='3038'>
        0.00344 * z_e(i,k,j)**0.57143 &amp;<a name='3039'>
        *dz8w (i,k,j)/1000.0<a name='3040'>
      END DO<a name='3041'>
    END DO<a name='3042'>
    END DO<a name='3043'>
<a name='3044'>
  END SUBROUTINE vert_int_liquid_diagnostics<a name='3045'>
<a name='3046'>
<a name='3047'>
<a name='3048'>
<A NAME='ICING_DIAGNOSTICS'><A href='../../html_code/phys/module_diag_afwa.F.html#ICING_DIAGNOSTICS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3049'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>icing_diagnostics</font> ( icing_opt                      &amp; <A href='../../call_to/ICING_DIAGNOSTICS.html' TARGET='index'>1</A><a name='3050'>
                             , fzlev                            &amp;<a name='3051'>
                             , icing_lg                         &amp;<a name='3052'>
                             , icing_sm                         &amp; <a name='3053'>
                             , qicing_lg_max                    &amp;<a name='3054'>
                             , qicing_sm_max                    &amp;<a name='3055'>
                             , qicing_lg                        &amp;<a name='3056'>
                             , qicing_sm                        &amp;<a name='3057'>
                             , icingtop                         &amp;<a name='3058'>
                             , icingbot                         &amp;<a name='3059'>
                             , t_phy                            &amp;<a name='3060'>
                             , z                                &amp;<a name='3061'>
                             , dz8w                             &amp;<a name='3062'>
                             , rho                              &amp;<a name='3063'>
                             , qrain                            &amp;<a name='3064'>
                             , qcloud                           &amp;<a name='3065'>
                             , ncloud                           &amp;<a name='3066'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='3067'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='3068'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='3069'>
<a name='3070'>
    INTEGER, INTENT(IN) :: ids, ide, jds, jde, kds, kde,        &amp;<a name='3071'>
                           ims, ime, jms, jme, kms, kme,        &amp;<a name='3072'>
                           ips, ipe, jps, jpe, kps, kpe<a name='3073'>
<a name='3074'>
    INTEGER, INTENT(IN) :: icing_opt<a name='3075'>
<a name='3076'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),               &amp;<a name='3077'>
         INTENT(IN) ::                                       z  &amp;<a name='3078'>
                                              ,          qrain  &amp;<a name='3079'>
                                              ,         qcloud  &amp;<a name='3080'>
                                              ,         ncloud  &amp;<a name='3081'>
                                              ,            rho  &amp;<a name='3082'>
                                              ,           dz8w  &amp;<a name='3083'>
                                              ,          t_phy<a name='3084'>
<a name='3085'>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='3086'>
         INTENT(  OUT) ::                                fzlev  &amp;<a name='3087'>
                                              ,       icing_lg  &amp;<a name='3088'>
                                              ,       icing_sm  &amp;<a name='3089'>
                                              ,  qicing_lg_max  &amp;<a name='3090'>
                                              ,  qicing_sm_max  &amp;<a name='3091'>
                                              ,       icingtop  &amp;<a name='3092'>
                                              ,       icingbot<a name='3093'>
<a name='3094'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),               &amp;<a name='3095'>
         INTENT(  OUT) ::                            qicing_lg  &amp;<a name='3096'>
                                              ,      qicing_sm<a name='3097'>
         <a name='3098'>
<a name='3099'>
    <font color=#447700>! Local<a name='3100'></font>
    <font color=#447700>! -----<a name='3101'></font>
    INTEGER :: i,j,k,ktime,ktop,kbot<a name='3102'>
    REAL    :: qcfrac_lg, qcfrac_sm, qc, qr, small, all<a name='3103'>
<a name='3104'>
    <font color=#447700>! Initializations<a name='3105'></font>
    <font color=#447700>! ---------------<a name='3106'></font>
    fzlev (ips:ipe,jps:jpe) = -999.        <font color=#447700>! Arbitrary unset/initial value<a name='3107'></font>
    icingtop (ips:ipe,jps:jpe) = -999.     <font color=#447700>! Arbitrary unset/initial value<a name='3108'></font>
    icingbot (ips:ipe,jps:jpe) = -999.     <font color=#447700>! Arbitrary unset/initial value<a name='3109'></font>
    icing_lg (ips:ipe,jps:jpe) = 0.        <a name='3110'>
    icing_sm (ips:ipe,jps:jpe) = 0.<a name='3111'>
    qicing_lg_max (ips:ipe,jps:jpe) = 0. <a name='3112'>
    qicing_sm_max (ips:ipe,jps:jpe) = 0. <a name='3113'>
    qicing_sm(ips:ipe,kps:kpe,jps:jpe)=0.<a name='3114'>
    qicing_lg(ips:ipe,kps:kpe,jps:jpe)=0.   <a name='3115'>
<a name='3116'>
    <font color=#447700>! Loop through i and j<a name='3117'></font>
    <font color=#447700>! --------------------<a name='3118'></font>
    DO i = ips, MIN(ipe,ide-1)<a name='3119'>
    DO j = jps, MIN(jpe,jde-1)<a name='3120'>
<a name='3121'>
      <font color=#447700>! Go up the column and look for sub freezing temperatures<a name='3122'></font>
      <font color=#447700>! -------------------------------------------------------<a name='3123'></font>
      ktop=-1<a name='3124'>
      kbot=-1<a name='3125'>
      DO k = kps, MIN(kpe,kde-1)<a name='3126'>
        IF (t_phy(i,k,j) .lt. 273.15) THEN<a name='3127'>
<a name='3128'>
          <font color=#447700>! Any cloud water we find will be supercooled.<a name='3129'></font>
          <font color=#447700>! Based on microphysics scheme, determine the fraction of<a name='3130'></font>
          <font color=#447700>! large (&gt;50 um) supercooled cloud water drops.<a name='3131'></font>
          <font color=#447700>! Source: Becky Selin, 16WS<a name='3132'></font>
          <font color=#447700>! -------------------------------------------------------<a name='3133'></font>
          qc = qcloud (i,k,j)<a name='3134'>
          qr = qrain (i,k,j)<a name='3135'>
          nc = ncloud(i,k,j)<a name='3136'>
          den = rho(i,k,j)<a name='3137'>
          qcfrac_lg = 0.<a name='3138'>
          qcfrac_sm = 0.<a name='3139'>
          <a name='3140'>
          <font color=#447700>! Eta (Ferrier)<a name='3141'></font>
          <font color=#447700>! -------------<a name='3142'></font>
          IF (icing_opt .eq. 2) THEN<a name='3143'>
            IF (qc .lt. 2.5E-4) THEN<a name='3144'>
              qcfrac_lg = 395000. * qc**2. + 102.9 * qc<a name='3145'>
            ELSEIF (qc .lt. 1.4E-3) THEN<a name='3146'>
              qcfrac_lg = 276.1 * qc - 0.01861<a name='3147'>
            ELSE<a name='3148'>
              qcfrac_lg = 0.3 * log(641.789 * qc) + 0.4<a name='3149'>
            ENDIF<a name='3150'>
<a name='3151'>
          <font color=#447700>! Thompson<a name='3152'></font>
          <font color=#447700>! --------<a name='3153'></font>
          <font color=#447700>! RAS Per James McCormick's stats, more large supercooled<a name='3154'></font>
          <font color=#447700>! drops are needed from the Thompson members.  Changing <a name='3155'></font>
          <font color=#447700>! calculation to be like WSM5/6 members.<a name='3156'></font>
          <font color=#447700>!ELSEIF (icing_opt .eq. 3) THEN<a name='3157'></font>
          <font color=#447700>!  IF (qc .lt. 1.0E-3) THEN<a name='3158'></font>
          <font color=#447700>!    qcfrac_lg = 2205.0 * qc**2. + 3.232 * qc<a name='3159'></font>
          <font color=#447700>!  ELSEIF (qc .lt. 3.0E-3) THEN<a name='3160'></font>
          <font color=#447700>!    qcfrac_lg = 24.1 * qc - 0.01866<a name='3161'></font>
          <font color=#447700>!  ELSE<a name='3162'></font>
          <font color=#447700>!    qcfrac_lg = 0.127063 * log(550.0 * qc) - 0.01<a name='3163'></font>
          <font color=#447700>!  ENDIF<a name='3164'></font>
<a name='3165'>
          <font color=#447700>! Thompson or WSM5/6<a name='3166'></font>
          <font color=#447700>! ------------------<a name='3167'></font>
          <font color=#447700>!ELSEIF (icing_opt .eq. 4) THEN<a name='3168'></font>
          ELSEIF ((icing_opt .eq. 3) .OR. (icing_opt .eq. 4)) THEN<a name='3169'>
            IF (qc .lt. 5.E-4) THEN<a name='3170'>
              qcfrac_lg = 50420.0 * qc**2. + 29.39 * qc<a name='3171'>
            ELSEIF (qc .lt. 1.4E-3) THEN<a name='3172'>
              qcfrac_lg = 97.65 * qc - 0.02152<a name='3173'>
            ELSE<a name='3174'>
              qcfrac_lg = 0.2 * log(646.908 * qc) + 0.135<a name='3175'>
            ENDIF<a name='3176'>
<a name='3177'>
          <font color=#447700>! Morrison 2-moment, constant CCN<a name='3178'></font>
          <font color=#447700>! -------------------------------<a name='3179'></font>
          ELSEIF (icing_opt .eq. 5) THEN<a name='3180'>
            IF (qc .lt. 1.4E-3) THEN<a name='3181'>
              qcfrac_lg = 28000. * qc**2. + 0.1 * qc <a name='3182'>
            ELSEIF (qc .lt. 2.6E-3) THEN<a name='3183'>
              qcfrac_lg = 112.351 * qc - 0.102272<a name='3184'>
            ELSE <a name='3185'>
              qcfrac_lg = 0.3 * log(654.92 * qc) * 0.301607<a name='3186'>
            ENDIF<a name='3187'>
<a name='3188'>
          <font color=#447700>! WDM6 or Morrison 2-moment w/ prognostic CCN<a name='3189'></font>
          <font color=#447700>! -------------------------------------------<a name='3190'></font>
          ELSEIF ((icing_opt .eq. 6) .OR. (icing_opt .eq. 7)) THEN<a name='3191'>
            IF ((qc .gt. 1.0E-12) .and. (nc .gt. 1.0E-12)) THEN<a name='3192'>
               small = -nc * exp(-nc*3141.59265*(5.E-5)**3./(6000.*den*qc))+nc<a name='3193'>
               all = -nc * exp(-nc*3141.59265*(2.)**3./(6000.*den*qc))+nc<a name='3194'>
               qcfrac_lg = 1. - (small / all)<a name='3195'>
            ELSE<a name='3196'>
               qcfac_lg = 0.<a name='3197'>
            ENDIF<a name='3198'>
          ENDIF<a name='3199'>
          qcfrac_lg = max(qcfrac_lg, 0.)<a name='3200'>
          <a name='3201'>
          <font color=#447700>! Small (&lt;50 um) supercooled cloud water drop fraction (1 - large).<a name='3202'></font>
          <font color=#447700>! -----------------------------------------------------------------<a name='3203'></font>
          IF (icing_opt .ne. 0 ) THEN<a name='3204'>
            qcfrac_sm = 1 - qcfrac_lg<a name='3205'>
          ENDIF<a name='3206'>
<a name='3207'>
          <font color=#447700>! Supercooled drop mixing ratio<a name='3208'></font>
          <font color=#447700>! -----------------------------<a name='3209'></font>
          qicing_lg (i,k,j) = max(qr + qcfrac_lg * qc, 0.)<a name='3210'>
          qicing_sm (i,k,j) = max(qcfrac_sm * qc, 0.)        <a name='3211'>
<a name='3212'>
          <font color=#447700>! Column integrated icing<a name='3213'></font>
          <font color=#447700>! -----------------------<a name='3214'></font>
          icing_lg (i,j) = icing_lg (i,j) + qicing_lg (i,k,j) &amp;<a name='3215'>
                            * dz8w (i,k,j) * rho(i,k,j)<a name='3216'>
          icing_sm (i,j) = icing_sm (i,j) + qicing_sm (i,k,j) &amp;<a name='3217'>
                            * dz8w (i,k,j) * rho(i,k,j)<a name='3218'>
<a name='3219'>
          <font color=#447700>! Column maximum supercooled drop mixing ratio <a name='3220'></font>
          <font color=#447700>! --------------------------------------------<a name='3221'></font>
          IF ( qicing_lg(i,k,j) .gt. qicing_lg_max(i,j) ) THEN<a name='3222'>
            qicing_lg_max (i,j) = qicing_lg(i,k,j)<a name='3223'>
          ENDIF<a name='3224'>
          IF ( qicing_sm(i,k,j) .gt. qicing_sm_max(i,j) ) THEN<a name='3225'>
            qicing_sm_max (i,j) = qicing_sm(i,k,j)<a name='3226'>
          ENDIF<a name='3227'>
           <a name='3228'>
          <font color=#447700>! Freezing level calculation<a name='3229'></font>
          <font color=#447700>! --------------------------<a name='3230'></font>
          IF (fzlev (i,j) .eq. -999.) THEN  <font color=#447700>! At freezing level<a name='3231'></font>
            IF (k .ne. kps) THEN  <font color=#447700>! If not at surface, interpolate.      <a name='3232'></font>
              fzlev (i,j) = z (i,k-1,j) + &amp;<a name='3233'>
                             ((273.15 - t_phy (i,k-1,j)) &amp;<a name='3234'>
                            /(t_phy (i,k,j) - t_phy (i,k-1,j))) &amp;<a name='3235'>
                            *(z (i,k,j) - z (i,k-1,j))<a name='3236'>
            ELSE  <font color=#447700>! If at surface, use first level.<a name='3237'></font>
              fzlev(i,j) = z (i,k,j)<a name='3238'>
            ENDIF<a name='3239'>
          ENDIF<a name='3240'>
<a name='3241'>
          <font color=#447700>! Icing layer top and bottom indices (where icing &gt; some arbitrary<a name='3242'></font>
          <font color=#447700>! small value). Set bottom index of icing layer to current k index <a name='3243'></font>
          <font color=#447700>! if not yet set. Set top index of icing layer to current k index.<a name='3244'></font>
          <font color=#447700>! ----------------------------------------------------------------<a name='3245'></font>
          IF ((qicing_lg (i,k,j) + qicing_sm (i,k,j)) .ge. 1.E-5) THEN<a name='3246'>
            IF (kbot .eq. -1) kbot = k  <a name='3247'>
            ktop=k<a name='3248'>
          ENDIF<a name='3249'>
        ENDIF<a name='3250'>
      END DO<a name='3251'>
<a name='3252'>
      <font color=#447700>! Interpolate bottom of icing layer from kbot (bottom index of icing<a name='3253'></font>
      <font color=#447700>! layer). Icing bottom should not go below freezing level.<a name='3254'></font>
      <font color=#447700>! ------------------------------------------------------------------<a name='3255'></font>
      IF (kbot .ne. -1) THEN<a name='3256'>
        IF (kbot .ne. kps) THEN <font color=#447700>! If not at surface, interpolate<a name='3257'></font>
          icingbot (i,j) = z (i,kbot-1,j) + ((1.E-5 - &amp;<a name='3258'>
                   (qicing_lg (i,kbot-1,j) + qicing_sm (i,kbot-1,j))) &amp;<a name='3259'>
                  / ((qicing_lg (i,kbot,j) + qicing_sm (i,kbot,j)) &amp;<a name='3260'>
                  - (qicing_lg (i,kbot-1,j) + qicing_sm (i,kbot-1,j)))) &amp;<a name='3261'>
                  * (z (i,kbot,j) - z (i,kbot-1,j))<a name='3262'>
          icingbot (i,j) = MAX(icingbot (i,j), fzlev (i,j))<a name='3263'>
        ELSE  <font color=#447700>! If at surface use first level.<a name='3264'></font>
          icingbot (i,j) = z(i,kbot,j)<a name='3265'>
        ENDIF<a name='3266'>
      ENDIF<a name='3267'>
<a name='3268'>
      <font color=#447700>! Interpolate top of icing layer from ktop (top index of icing layer).<a name='3269'></font>
      <font color=#447700>! Icing top should not go below icing bottom (obviously).<a name='3270'></font>
      <font color=#447700>! --------------------------------------------------------------------<a name='3271'></font>
      IF (ktop .ne. -1 .and. ktop .ne. kpe) THEN <font color=#447700>! If not undefined or model top<a name='3272'></font>
        icingtop (i,j) = z (i,ktop,j) + ((1.E-5 - &amp;<a name='3273'>
                 (qicing_lg (i,ktop,j) + qicing_sm (i,ktop,j))) &amp;<a name='3274'>
                 / ((qicing_lg (i,ktop+1,j) + qicing_sm (i,ktop+1,j)) &amp;<a name='3275'>
                 - (qicing_lg (i,ktop,j) + qicing_sm (i,ktop,j)))) &amp;<a name='3276'>
                 * (z (i,ktop+1,j) - z (i,ktop,j))<a name='3277'>
        icingtop (i,j) = MAX(icingtop (i,j), icingbot (i,j))<a name='3278'>
      ENDIF<a name='3279'>
    END DO<a name='3280'>
    END DO<a name='3281'>
<a name='3282'>
  END SUBROUTINE icing_diagnostics<a name='3283'>
<a name='3284'>
<a name='3285'>
<a name='3286'>
<A NAME='RADAR_DIAGNOSTICS'><A href='../../html_code/phys/module_diag_afwa.F.html#RADAR_DIAGNOSTICS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3287'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>radar_diagnostics</font> ( refd                           &amp; <A href='../../call_to/RADAR_DIAGNOSTICS.html' TARGET='index'>1</A><a name='3288'>
                             , refd_com                         &amp;<a name='3289'>
<font color=#447700>!                             , refd_max                         &amp;<a name='3290'></font>
                             , echotop                          &amp;<a name='3291'>
                             , z                                &amp;<a name='3292'>
                             , z_e                              &amp;<a name='3293'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='3294'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='3295'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='3296'>
<a name='3297'>
    INTEGER, INTENT(IN) :: ids, ide, jds, jde, kds, kde,        &amp;<a name='3298'>
                           ims, ime, jms, jme, kms, kme,        &amp;<a name='3299'>
                           ips, ipe, jps, jpe, kps, kpe<a name='3300'>
<a name='3301'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),               &amp;<a name='3302'>
         INTENT(IN) ::                                       z  &amp;<a name='3303'>
                                              ,            z_e<a name='3304'>
<a name='3305'>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='3306'>
         INTENT(INOUT) ::                                 refd  &amp;<a name='3307'>
                                              ,       refd_com  &amp;<a name='3308'>
<font color=#447700>!                                              ,       refd_max  &amp;<a name='3309'></font>
                                              ,        echotop<a name='3310'>
<a name='3311'>
    <font color=#447700>! Local<a name='3312'></font>
    <font color=#447700>! -----<a name='3313'></font>
    INTEGER :: i,j,k,ktime<a name='3314'>
    <a name='3315'>
    DO j = jps, MIN(jpe,jde-1)<a name='3316'>
    DO i = ips, MIN(ipe,ide-1)<a name='3317'>
      ktop = -1  <font color=#447700>! Undefined<a name='3318'></font>
      echotop (i,j) = 0.<a name='3319'>
      refd_com (i,j) = 0.<a name='3320'>
      refd (i,j) = 0.<a name='3321'>
      DO k = kps, MIN(kpe,kde-1)<a name='3322'>
        IF (z_e(i,k,j) .gt. 1.e-20) THEN<a name='3323'>
<a name='3324'>
          <font color=#447700>! Reflectivity (first level)<a name='3325'></font>
          <font color=#447700>! --------------------------<a name='3326'></font>
          IF (k == kps) refd(i,j) = MAX(10.0 * log10(z_e(i,k,j)),0.)<a name='3327'>
   <a name='3328'>
<font color=#447700>!          ! Max reflectivity over the output interval<a name='3329'></font>
<font color=#447700>!          ! -----------------------------------------<a name='3330'></font>
<font color=#447700>!          IF (refd(i,j) .gt. refd_max(i,j)) refd_max(i,j) = refd(i,j)<a name='3331'></font>
<a name='3332'>
          <font color=#447700>! Composite reflectivity calc (max reflectivity in the column)<a name='3333'></font>
          <font color=#447700>! ------------------------------------------------------------<a name='3334'></font>
          IF (10.0 * log10(z_e(i,k,j)) .gt. refd_com(i,j)) THEN<a name='3335'>
            refd_com(i,j) = 10.0 * log10(z_e(i,k,j))<a name='3336'>
          ENDIF<a name='3337'>
        ENDIF<a name='3338'>
        <a name='3339'>
        <font color=#447700>! Echo top - the highest level w/ dBZ &gt; 18 (z_e &gt; 63.0957)<a name='3340'></font>
        <font color=#447700>! --------------------------------------------------------<a name='3341'></font>
        IF ( z_e(i,k,j) .gt. 63.0957) THEN<a name='3342'>
          ktop = k<a name='3343'>
        ENDIF<a name='3344'>
      END DO<a name='3345'>
      IF ( ktop .ne. -1 ) THEN  <font color=#447700>! Interpolate to echo top height (GAC)<a name='3346'></font>
        echotop (i,j) = z (i,ktop,j) + &amp;<a name='3347'>
                          ((63.0957 - z_e (i,ktop,j)) &amp;<a name='3348'>
                         /(z_e (i,ktop+1,j) - z_e (i,ktop,j))) &amp;<a name='3349'>
                         *(z (i,ktop+1,j) - z (i,ktop,j))<a name='3350'>
      ENDIF<a name='3351'>
    END DO<a name='3352'>
    END DO<a name='3353'>
<a name='3354'>
  END SUBROUTINE radar_diagnostics<a name='3355'>
<a name='3356'>
<a name='3357'>
<a name='3358'>
<A NAME='WRF_DBZCALC'><A href='../../html_code/phys/module_diag_afwa.F.html#WRF_DBZCALC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3359'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dbzcalc</font>( rho                                   &amp; <A href='../../call_to/WRF_DBZCALC.html' TARGET='index'>1</A><a name='3360'>
                             , t_phy                            &amp;<a name='3361'>
                             , qr                               &amp;<a name='3362'>
                             , qs                               &amp;<a name='3363'>
                             , qg                               &amp;<a name='3364'>
                             , z_e                              &amp;<a name='3365'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='3366'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='3367'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='3368'>
<a name='3369'>
    INTEGER, INTENT(IN) :: ids, ide, jds, jde, kds, kde,        &amp;<a name='3370'>
                           ims, ime, jms, jme, kms, kme,        &amp;<a name='3371'>
                           ips, ipe, jps, jpe, kps, kpe<a name='3372'>
<a name='3373'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),               &amp;<a name='3374'>
         INTENT(IN   ) ::                                  rho  &amp;<a name='3375'>
                                              ,          t_phy  &amp;<a name='3376'>
                                              ,             qr  &amp;<a name='3377'>
                                              ,             qs  &amp;<a name='3378'>
                                              ,             qg<a name='3379'>
<a name='3380'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),               &amp;<a name='3381'>
         INTENT(  OUT) ::                                  z_e<a name='3382'>
<a name='3383'>
    REAL :: factor_r, factor_s, factor_g, factorb_s, factorb_g, ronv, sonv, gonv<a name='3384'>
    REAL :: temp_c, rhoair, qgr, qra, qsn<a name='3385'>
    INTEGER :: i, j, k<a name='3386'>
<a name='3387'>
    INTEGER, PARAMETER :: iBrightBand = 1<a name='3388'>
    REAL, PARAMETER :: T_0 = 273.15<a name='3389'>
    REAL, PARAMETER :: PI = 3.1415926536<a name='3390'>
    REAL, PARAMETER :: rgas=287.04, gamma_seven = 720.0, alpha2 = 0.224<a name='3391'>
<a name='3392'>
    <font color=#447700>! Densities of rain, snow, graupel, and cloud ice.<a name='3393'></font>
    <font color=#447700>! ------------------------------------------------<a name='3394'></font>
    REAL, PARAMETER :: rho_w = 1000.0, rho_r = 1000.0, rho_s = 100.0<a name='3395'>
    REAL, PARAMETER :: rho_g = 400.0, rho_i = 890.0<a name='3396'>
    REAL, PARAMETER :: ron=8.e6, son=2.e7, gon=5.e7, r1=1.e-15<a name='3397'>
    REAL, PARAMETER :: ron_min = 8.e6, ron2=1.e10<a name='3398'>
    REAL, PARAMETER :: ron_qr0 = 0.0001, ron_delqr0 = 0.25*ron_qr0<a name='3399'>
    REAL, PARAMETER :: ron_const1r = (ron2-ron_min)*0.5<a name='3400'>
    REAL, PARAMETER :: ron_const2r = (ron2+ron_min)*0.5<a name='3401'>
<a name='3402'>
    <font color=#447700>! Constant intercepts<a name='3403'></font>
    <font color=#447700>! -------------------<a name='3404'></font>
    ronv = 8.e6    <font color=#447700>! m^-4<a name='3405'></font>
    sonv = 2.e7    <font color=#447700>! m^-4<a name='3406'></font>
    gonv = 4.e6    <font color=#447700>! m^-4<a name='3407'></font>
<a name='3408'>
    factor_r = gamma_seven * 1.e18 * (1./(pi*rho_r))**1.75<a name='3409'>
    factor_s = gamma_seven * 1.e18 * (1./(pi*rho_s))**1.75  &amp;<a name='3410'>
              * (rho_s/rho_w)**2 * alpha2<a name='3411'>
    factor_g = gamma_seven * 1.e18 * (1./(pi*rho_g))**1.75  &amp;<a name='3412'>
              * (rho_g/rho_w)**2 * alpha2<a name='3413'>
<a name='3414'>
    <font color=#447700>! For each grid point<a name='3415'></font>
    <font color=#447700>! -------------------<a name='3416'></font>
    DO j = jps, jpe<a name='3417'>
    DO k = kps, kpe<a name='3418'>
    DO i = ips, ipe<a name='3419'>
<a name='3420'>
      factorb_s = factor_s<a name='3421'>
      factorb_g = factor_g<a name='3422'>
<a name='3423'>
      <font color=#447700>! In this case snow or graupel particle scatters like liquid<a name='3424'></font>
      <font color=#447700>! water because it is assumed to have a liquid skin<a name='3425'></font>
      <font color=#447700>! ----------------------------------------------------------<a name='3426'></font>
      IF( iBrightBand == 1 ) THEN<a name='3427'>
        IF (t_phy(i,k,j) &gt; T_0) THEN<a name='3428'>
          factorb_s = factor_s /alpha2<a name='3429'>
          factorb_g = factor_g /alpha2<a name='3430'>
        ENDIF<a name='3431'>
      ENDIF<a name='3432'>
 <a name='3433'>
      <font color=#447700>! Calculate variable intercept parameters<a name='3434'></font>
      <font color=#447700>! ---------------------------------------<a name='3435'></font>
      temp_c = amin1(-0.001, t_phy(i,k,j)- T_0)<a name='3436'>
      sonv = amin1(2.0e8, 2.0e6*exp(-0.12*temp_c))<a name='3437'>
      gonv = gon<a name='3438'>
      qgr = QG(i,k,j)<a name='3439'>
      qra = QR(i,k,j)<a name='3440'>
      qsn = QS(i,k,j)<a name='3441'>
      IF (qgr.gt.r1) THEN<a name='3442'>
        gonv = 2.38*(pi*rho_g/(rho(i,k,j)*qgr))**0.92<a name='3443'>
        gonv = max(1.e4, min(gonv,gon))<a name='3444'>
      ENDIF<a name='3445'>
      ronv = ron2<a name='3446'>
      IF (qra.gt. r1) THEN<a name='3447'>
        ronv = ron_const1r*tanh((ron_qr0-qra)/ron_delqr0) + ron_const2r<a name='3448'>
      ENDIF<a name='3449'>
 <a name='3450'>
      IF (qra &lt; 0.0 ) qra = 0.0<a name='3451'>
      IF (qsn &lt; 0.0 ) qsn = 0.0<a name='3452'>
      IF (qgr &lt; 0.0 ) qgr = 0.0<a name='3453'>
      z_e(i,k,j) = factor_r * (rho(i,k,j) * qra)**1.75 / ronv**.75 + &amp;<a name='3454'>
                     factorb_s * (rho(i,k,j) * qsn)**1.75 / sonv**.75 + &amp;<a name='3455'>
                     factorb_g * (rho(i,k,j) * qgr)**1.75 / gonv**.75<a name='3456'>
 <a name='3457'>
      IF ( z_e(i,k,j) &lt; 0.0 ) z_e(i,k,j) = 0.0<a name='3458'>
 <a name='3459'>
    END DO<a name='3460'>
    END DO<a name='3461'>
    END DO<a name='3462'>
<a name='3463'>
  END SUBROUTINE wrf_dbzcalc<a name='3464'>
<a name='3465'>
<a name='3466'>
<a name='3467'>
<A NAME='PRECIP_TYPE_DIAGNOSTICS'><A href='../../html_code/phys/module_diag_afwa.F.html#PRECIP_TYPE_DIAGNOSTICS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3468'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>precip_type_diagnostics</font> ( t_phy                    &amp; <A href='../../call_to/PRECIP_TYPE_DIAGNOSTICS.html' TARGET='index'>1</A><a name='3469'>
                             , t2                               &amp;<a name='3470'>
                             , rh                               &amp;<a name='3471'>
                             , z                                &amp;<a name='3472'>
                             , ht                               &amp;<a name='3473'>
                             , precip                           &amp;<a name='3474'>
                             , swdown                           &amp;<a name='3475'>
                             , rain                             &amp;<a name='3476'>
                             , snow                             &amp;<a name='3477'>
                             , ice                              &amp;<a name='3478'>
                             , frz_rain                         &amp;<a name='3479'>
                             , snowfall                         &amp;<a name='3480'>
                             , ccn_tmp                          &amp;<a name='3481'>
                             , total_melt                       &amp;<a name='3482'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='3483'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='3484'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='3485'>
<a name='3486'>
    INTEGER, INTENT(IN) :: ids, ide, jds, jde, kds, kde,        &amp;<a name='3487'>
                           ims, ime, jms, jme, kms, kme,        &amp;<a name='3488'>
                           ips, ipe, jps, jpe, kps, kpe<a name='3489'>
<a name='3490'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),               &amp;<a name='3491'>
         INTENT(IN   ) ::                                t_phy  &amp;<a name='3492'>
                                              ,             rh  &amp;<a name='3493'>
                                              ,              z<a name='3494'>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='3495'>
         INTENT(IN   ) ::                                   t2  &amp;<a name='3496'>
                                              ,             ht  &amp;<a name='3497'>
                                              ,         precip  &amp;<a name='3498'>
                                              ,         swdown<a name='3499'>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='3500'>
         INTENT(INOUT) ::                             snowfall  &amp;<a name='3501'>
                                              ,           rain  &amp;<a name='3502'>
                                              ,       frz_rain  &amp;<a name='3503'>
                                              ,           snow  &amp;<a name='3504'>
                                              ,            ice<a name='3505'>
    REAL, INTENT(IN) :: ccn_tmp<a name='3506'>
    REAL, INTENT(IN) :: total_melt<a name='3507'>
<a name='3508'>
    <font color=#447700>! Local<a name='3509'></font>
    <font color=#447700>! -----<a name='3510'></font>
    REAL, DIMENSION( ims:ime, jms:jme ) ::                      &amp;<a name='3511'>
                                     melt                       &amp;<a name='3512'>
                                   , mod_2m_tmp                 &amp;<a name='3513'>
                                   , cloud_top_tmp              &amp;<a name='3514'>
                                   , maxtmp<a name='3515'>
<a name='3516'>
    INTEGER, DIMENSION( ims:ime, jms:jme ) ::                   &amp;<a name='3517'>
                                     cloud_top_k_index          &amp;<a name='3518'>
                                   , precip_type<a name='3519'>
<a name='3520'>
    LOGICAL, DIMENSION (ims:ime, jms:jme ) ::                   &amp;<a name='3521'>
                                     saturation <a name='3522'>
<a name='3523'>
    REAL, PARAMETER :: snow_ratio=5.0<a name='3524'>
<a name='3525'>
    <font color=#447700>! Loop through all points<a name='3526'></font>
    <font color=#447700>! Search vertically twice--first to find the cloud top temperature and the <a name='3527'></font>
    <font color=#447700>! maximum temperature. Second, determine if any melting or re-freezing will<a name='3528'></font>
    <font color=#447700>! occur to make ice pellets or freezing rain<a name='3529'></font>
    <font color=#447700>! -------------------------------------------------------------------------<a name='3530'></font>
    DO i=ips,ipe<a name='3531'>
    DO j=jps,jpe<a name='3532'>
  <a name='3533'>
      saturation(i,j)=.false.<a name='3534'>
      melt(i,j)=0.0 <a name='3535'>
      precip_type(i,j)=0<a name='3536'>
        <a name='3537'>
      <font color=#447700>! Modify surface temperature for solar insolation (W/m2)<a name='3538'></font>
      <font color=#447700>! Set max temperature in the atmopshere<a name='3539'></font>
      <font color=#447700>! ------------------------------------------------------<a name='3540'></font>
      mod_2m_tmp(i,j)=t2(i,j)+(swdown(i,j)/100.0)<a name='3541'>
      maxtmp(i,j)=mod_2m_tmp(i,j)<a name='3542'>
  <a name='3543'>
      <font color=#447700>! Only look at points that have precip and are not warm at the surface<a name='3544'></font>
      <font color=#447700>! --------------------------------------------------------------------<a name='3545'></font>
      IF (precip(i,j) .gt. 0.0) THEN<a name='3546'>
        <font color=#447700>!IF (mod_2m_tmp(i,j) .gt. 277.15) THEN<a name='3547'></font>
        IF (mod_2m_tmp(i,j) .gt. 275.15) THEN<a name='3548'>
          precip_type(i,j)=1  <font color=#447700>! Rain<a name='3549'></font>
        ELSE<a name='3550'>
  <a name='3551'>
          <font color=#447700>! Check sounding from top for saturation (RH-water gt 80%)--this is <a name='3552'></font>
          <font color=#447700>! the cloud top. Erase saturation if RH lt 70% (spurious moist layer<a name='3553'></font>
          <font color=#447700>! aloft)<a name='3554'></font>
          <font color=#447700>! ------------------------------------------------------------------<a name='3555'></font>
          cloud_top_k_index(i,j)=kpe<a name='3556'>
          DO k=kpe,kps,-1<a name='3557'>
            IF ((z(i,k,j)-ht(i,j)) .gt. 0.0) THEN<a name='3558'>
              IF (t_phy(i,k,j) .gt. maxtmp(i,j)) THEN<a name='3559'>
                maxtmp(i,j)=t_phy(i,k,j)<a name='3560'>
              ENDIF<a name='3561'>
              IF (rh(i,k,j) .gt. 80 .and. saturation(i,j) .eqv. .false.) THEN<a name='3562'>
                cloud_top_tmp(i,j)=t_phy(i,k,j)<a name='3563'>
                cloud_top_k_index(i,j)=k<a name='3564'>
                saturation(i,j)=.true.<a name='3565'>
                precip_type(i,j)=2 <font color=#447700>! Snow<a name='3566'></font>
              ENDIF<a name='3567'>
              IF (rh(i,k,j) .le. 70 .and. saturation(i,j) .eqv. .true.) THEN<a name='3568'>
                saturation(i,j)=.false.<a name='3569'>
              ENDIF<a name='3570'>
            ENDIF<a name='3571'>
          ENDDO<a name='3572'>
<a name='3573'>
          <font color=#447700>! Perform simple check to assign types with no melting layer<a name='3574'></font>
          <font color=#447700>! shenanigans going on<a name='3575'></font>
          <font color=#447700>! ----------------------------------------------------------------<a name='3576'></font>
          IF (cloud_top_tmp(i,j) .le. ccn_tmp .and. &amp;<a name='3577'>
          maxtmp(i,j) .le. 273.15) THEN<a name='3578'>
            precip_type(i,j)=2  <font color=#447700>! Snow<a name='3579'></font>
          ENDIF<a name='3580'>
<a name='3581'>
          <font color=#447700>! ELSE, have to go through the profile again to see if snow melts, <a name='3582'></font>
          <font color=#447700>! and if anything re-freezes<a name='3583'></font>
          <font color=#447700>! ----------------------------------------------------------------<a name='3584'></font>
          DO k=cloud_top_k_index(i,j),kps,-1<a name='3585'>
            IF ((z(i,k,j)-ht(i,j)) .gt. 0.0) THEN<a name='3586'>
 <a name='3587'>
              <font color=#447700>! Condition 0--assign falling rain when we get to the <a name='3588'></font>
              <font color=#447700>! supercooled temperature if too warm<a name='3589'></font>
              <font color=#447700>! ---------------------------------------------------<a name='3590'></font>
              IF (cloud_top_tmp(i,j) .eq. t_phy(i,k,j) .and. &amp;<a name='3591'>
              cloud_top_tmp(i,j) .gt. ccn_tmp) THEN<a name='3592'>
                 precip_type(i,j)=1  <font color=#447700>! Rain<a name='3593'></font>
              ENDIF<a name='3594'>
<a name='3595'>
              <font color=#447700>! Condition 1--falling frozen precip that will start to melt<a name='3596'></font>
              <font color=#447700>! Add up melting energy over warm layers--if enough, turn to <a name='3597'></font>
              <font color=#447700>! liquid<a name='3598'></font>
              <font color=#447700>! ----------------------------------------------------------<a name='3599'></font>
              IF ((precip_type(i,j) .eq. 2 .or. precip_type(i,j) .eq. 3) .and. &amp;<a name='3600'>
              t_phy(i,k,j) .gt. 273.15) THEN<a name='3601'>
                melt(i,j)=melt(i,j)+9.8*(((t_phy(i,k,j)-273.15)/273.15)* &amp;<a name='3602'>
                          (z(i,k,j)-z(i,k-1,j)))<a name='3603'>
                IF (melt(i,j) .gt. total_melt) THEN<a name='3604'>
                  precip_type(i,j)=1  <font color=#447700>! Rain<a name='3605'></font>
                  melt(i,j)=0.0  <font color=#447700>! Reset melting energy in case it re-freezes<a name='3606'></font>
                ENDIF<a name='3607'>
              ENDIF<a name='3608'>
<a name='3609'>
              <font color=#447700>! Condition 2--falling partially melted precip encounters <a name='3610'></font>
              <font color=#447700>! sub-freezing air. Snow will be converted to ice pellets if <a name='3611'></font>
              <font color=#447700>! at least 1/4 of it melted. Instantaneous freeze-up, simplistic <a name='3612'></font>
              <font color=#447700>! --------------------------------------------------------------<a name='3613'></font>
              IF (t_phy(i,k,j) .le. 273.15 .and. &amp;<a name='3614'>
              melt(i,j) .gt. total_melt/4.0 .and. &amp;<a name='3615'>
              (precip_type(i,j) .eq. 2 .or. precip_type(i,j) .eq. 3)) THEN<a name='3616'>
                precip_type(i,j)=3  <font color=#447700>! Ice<a name='3617'></font>
                melt(i,j)=0.0<a name='3618'>
              ENDIF<a name='3619'>
             <a name='3620'>
              <font color=#447700>! Condition 3--falling liquid that will re-freeze--must reach <a name='3621'></font>
              <font color=#447700>! nucleation temperature<a name='3622'></font>
              <font color=#447700>! -----------------------------------------------------------<a name='3623'></font>
              IF (precip_type(i,j) .eq. 1) THEN<a name='3624'>
                IF (t_phy(i,k,j) .le. ccn_tmp) THEN<a name='3625'>
                  precip_type(i,j)=3  <font color=#447700>! Ice<a name='3626'></font>
                ENDIF<a name='3627'>
              ENDIF<a name='3628'>
            ENDIF  <font color=#447700>! End if (z-ht)&gt;0<a name='3629'></font>
          ENDDO  <font color=#447700>! End do k=kpe,kps,-1<a name='3630'></font>
        ENDIF  <font color=#447700>! End if mod_2m_tmp&gt;273.15<a name='3631'></font>
<a name='3632'>
        <font color=#447700>! Accumulate precip according to precip_type<a name='3633'></font>
        <font color=#447700>! ------------------------------------------<a name='3634'></font>
        IF (precip_type(i,j) .eq. 3) THEN <a name='3635'>
          ice(i,j)=ice(i,j)+precip(i,j)<a name='3636'>
        ENDIF<a name='3637'>
        IF (precip_type(i,j) .eq. 2) THEN<a name='3638'>
          snow(i,j)=snow(i,j)+precip(i,j)<a name='3639'>
          snowfall(i,j)=snowfall(i,j)+snow_ratio*precip(i,j) &amp;<a name='3640'>
                        *(5.-mod_2m_tmp(i,j)+273.15)**0.4<a name='3641'>
        ENDIF<a name='3642'>
        IF (precip_type(i,j) .eq. 1) THEN<a name='3643'>
          IF (mod_2m_tmp(i,j) .gt. 273.15) THEN<a name='3644'>
            rain(i,j)=rain(i,j)+precip(i,j)<a name='3645'>
          ELSE<a name='3646'>
            frz_rain(i,j)=frz_rain(i,j)+precip(i,j)<a name='3647'>
          ENDIF<a name='3648'>
        ENDIF<a name='3649'>
<a name='3650'>
      ENDIF  <font color=#447700>! End if precip&gt;0<a name='3651'></font>
<a name='3652'>
    ENDDO  <font color=#447700>! End do j=jps,jpe<a name='3653'></font>
    ENDDO  <font color=#447700>! End do i=ips,ipe<a name='3654'></font>
<a name='3655'>
  END SUBROUTINE precip_type_diagnostics<a name='3656'>
<a name='3657'>
<a name='3658'>
<a name='3659'>
<A NAME='VIS_DIAGNOSTICS'><A href='../../html_code/phys/module_diag_afwa.F.html#VIS_DIAGNOSTICS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3660'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>vis_diagnostics</font> ( qcloud                           &amp; <A href='../../call_to/VIS_DIAGNOSTICS.html' TARGET='index'>1</A><a name='3661'>
                             , qrain                            &amp;<a name='3662'>
                             , qice                             &amp;<a name='3663'>
                             , qsnow                            &amp;<a name='3664'>
                             , qgrpl                            &amp;<a name='3665'>
                             , rho                              &amp;<a name='3666'>
                             , wind10m                          &amp;<a name='3667'>
                             , wind125m                         &amp;<a name='3668'>
                             , pwater                           &amp;<a name='3669'>
                             , q2m                              &amp;<a name='3670'>
                             , rh2m                             &amp;<a name='3671'>
                             , rh20m                            &amp;<a name='3672'>
                             , tv2m                             &amp;<a name='3673'>
                             , tv20m                            &amp;<a name='3674'>
                             , dustc                            &amp;<a name='3675'>
                             , vis                              &amp;<a name='3676'>
                             , vis_dust                         &amp;<a name='3677'>
                             , vis_alpha                        &amp;<a name='3678'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='3679'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='3680'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='3681'>
<a name='3682'>
    INTEGER, INTENT(IN) :: ids, ide, jds, jde, kds, kde,        &amp;<a name='3683'>
                           ims, ime, jms, jme, kms, kme,        &amp;<a name='3684'>
                           ips, ipe, jps, jpe, kps, kpe<a name='3685'>
<a name='3686'>
    INTEGER, PARAMETER :: ndust=5<a name='3687'>
<a name='3688'>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='3689'>
         INTENT(IN   ) ::                               qcloud  &amp;<a name='3690'>
                                              ,          qrain  &amp;<a name='3691'>
                                              ,           qice  &amp; <a name='3692'>
                                              ,          qsnow  &amp; <a name='3693'>
                                              ,          qgrpl  &amp; <a name='3694'>
                                              ,            rho  &amp; <a name='3695'>
                                              ,        wind10m  &amp; <a name='3696'>
                                              ,       wind125m  &amp; <a name='3697'>
                                              ,         pwater  &amp; <a name='3698'>
                                              ,           rh2m  &amp;<a name='3699'>
                                              ,            q2m  &amp;<a name='3700'>
                                              ,          rh20m  &amp;<a name='3701'>
                                              ,           tv2m  &amp;<a name='3702'>
                                              ,          tv20m<a name='3703'>
    REAL, DIMENSION( ims:ime, jms:jme, ndust ),                 &amp;<a name='3704'>
         INTENT(IN   ) ::                                dustc<a name='3705'>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='3706'>
         INTENT(  OUT) ::                                  vis  &amp;<a name='3707'>
                                              ,       vis_dust  &amp;<a name='3708'>
                                              ,      vis_alpha<a name='3709'>
<a name='3710'>
    <font color=#447700>! Local<a name='3711'></font>
    <font color=#447700>! -----<a name='3712'></font>
    INTEGER :: i,j,k,d<a name='3713'>
    REAL, PARAMETER :: visfactor=3.912<a name='3714'>
    REAL, DIMENSION (ndust) :: dustfact<a name='3715'>
    REAL :: bc, br, bi, bs, dust_extcoeff, hydro_extcoeff, extcoeff, vis_haze<a name='3716'>
    REAL :: tvd, rh, prob_ext_coeff_gt_p29, haze_ext_coeff<a name='3717'>
    REAL :: vis_hydlith, alpha_haze<a name='3718'>
<a name='3719'>
    <font color=#447700>! Dust factor based on 5 bin AFWA dust scheme.  This is a simplification<a name='3720'></font>
    <font color=#447700>! of the scheme in WRFPOST.  More weight is applied to smaller particles.<a name='3721'></font>
    <font color=#447700>! -----------------------------------------------------------------------<a name='3722'></font>
    dustfact=(/1.470E-6,7.877E-7,4.623E-7,2.429E-7,1.387E-7/)<a name='3723'>
<a name='3724'>
    DO i=ims,ime<a name='3725'>
      DO j=jms,jme<a name='3726'>
<a name='3727'>
        <font color=#447700>! Hydrometeor extinction coefficient<a name='3728'></font>
        <font color=#447700>! For now, lump graupel in with rain<a name='3729'></font>
        <font color=#447700>! -------------------------------------------------------------------<a name='3730'></font>
        <font color=#447700>! Update: GAC 20131213  Our test results with surface cloud and ice<a name='3731'></font>
        <font color=#447700>! are very unfavorable.  Model doesn't do a great job handling clouds<a name='3732'></font>
        <font color=#447700>! at the model surface.  Therefore, we will not trust surface<a name='3733'></font>
        <font color=#447700>! cloud water/ice.  (Commented out below).<a name='3734'></font>
        <font color=#447700>! -------------------------------------------------------------------<a name='3735'></font>
        <font color=#447700>!br=2.240*qrain(i,j)**0.75<a name='3736'></font>
        <font color=#447700>!bs=10.36*qsnow(i,j)**0.78<a name='3737'></font>
        <font color=#447700>!bc=144.7*qcloud(i,j)**0.88<a name='3738'></font>
        <font color=#447700>!bi=327.8*qice(i,j)<a name='3739'></font>
        <font color=#447700>!hydro_extcoeff=bc+br+bi+bs<a name='3740'></font>
        <font color=#447700>!br=2.240*(qrain(i,j)+qgrpl(i,j))**0.75<a name='3741'></font>
        <font color=#447700>!bs=10.36*(qsnow(i,j)*rho(i,j))**0.78<a name='3742'></font>
        <font color=#447700>! Update: moisture variables should be in mass concentration (g m^-3)<a name='3743'></font>
        br=1.1*(1000.*rho(i,j)*(qrain(i,j)+qgrpl(i,j)))**0.75<a name='3744'>
        bs=10.36*(1000.*rho(i,j)*qsnow(i,j))**0.78<a name='3745'>
        hydro_extcoeff=(br+bs)/1000.   <font color=#447700>! m^-1<a name='3746'></font>
<a name='3747'>
        <font color=#447700>! Dust extinction coefficient<a name='3748'></font>
        <font color=#447700>! ---------------------------<a name='3749'></font>
        dust_extcoeff=0.<a name='3750'>
        DO d=1,ndust<a name='3751'>
          dust_extcoeff=dust_extcoeff+dustfact(d)*dustc(i,j,d)<a name='3752'>
        ENDDO<a name='3753'>
<a name='3754'>
        <font color=#447700>! UPDATE: GAC 20131213 Old algorithm commented out below<a name='3755'></font>
        <font color=#447700>!! Visibility due to haze obscuration<a name='3756'></font>
        <font color=#447700>!! -------------------------------------------------------<a name='3757'></font>
        <font color=#447700>!vis_haze=1500.*(105.-rh2m(i,j)+wind10m(i,j))<a name='3758'></font>
        <font color=#447700>!<a name='3759'></font>
        <font color=#447700>!! Calculate total visibility<a name='3760'></font>
        <font color=#447700>!! Take minimum visibility from hydro/lithometeors and haze<a name='3761'></font>
        <font color=#447700>!! Define maximum visibility as 20 km (UPDATE: 999.999 km)<a name='3762'></font>
        <font color=#447700>!! --------------------------------------------------------<a name='3763'></font>
        <font color=#447700>!extcoeff=hydro_extcoeff+dust_extcoeff<a name='3764'></font>
        <font color=#447700>!IF (extcoeff .gt. 0.) THEN<a name='3765'></font>
        <font color=#447700>!  vis(i,j)=MIN(visfactor/extcoeff,vis_haze)<a name='3766'></font>
        <font color=#447700>!ELSE<a name='3767'></font>
        <font color=#447700>!  vis(i,j)=999999.<a name='3768'></font>
        <font color=#447700>!ENDIF<a name='3769'></font>
<a name='3770'>
        <font color=#447700>! Update: GAC 20131213  New haze/fog visibility algorithm<a name='3771'></font>
        <font color=#447700>! Start with relative humidity predictor.  Increase <a name='3772'></font>
        <font color=#447700>! predicted visibility as mixing ratio decreases (as<a name='3773'></font>
        <font color=#447700>! there is less water to condense).<a name='3774'></font>
        <font color=#447700>! -------------------------------------------------------<a name='3775'></font>
        vis_haze=999999.<a name='3776'>
        IF (q2m(i,j) .gt. 0.) THEN<a name='3777'>
          <font color=#447700>!vis_haze=1500.*(105.-rh2m(i,j))*(15./(1000.*q2m(i,j)))<a name='3778'></font>
          vis_haze=1500.*(105.-rh2m(i,j))*(5./min(1000.*q2m(i,j),5.))<a name='3779'>
        ENDIF<a name='3780'>
 <a name='3781'>
        <font color=#447700>! Calculate a Weibull function "alpha" term.  This can be<a name='3782'></font>
        <font color=#447700>! used later with visibility (which acts as the "beta" term<a name='3783'></font>
        <font color=#447700>! in the Weibull function) to create a probability distribution<a name='3784'></font>
        <font color=#447700>! for visibility. Alpha can be thought of as the "level of<a name='3785'></font>
        <font color=#447700>! certainty" that beta (model visibility) is correct. Fog is<a name='3786'></font>
        <font color=#447700>! notoriously difficult to model. In the below algorithm,<a name='3787'></font>
        <font color=#447700>! the alpha value (certainty) decreases as PWAT, mixing ratio,<a name='3788'></font>
        <font color=#447700>! or winds decrease (possibly foggy conditions), but increases<a name='3789'></font>
        <font color=#447700>! if RH decreases (more certainly not foggy).  If PWAT is lower<a name='3790'></font>
        <font color=#447700>! then there is a higher chance of radiation fog because there<a name='3791'></font>
        <font color=#447700>! is less insulating cloud above.<a name='3792'></font>
        <font color=#447700>! -------------------------------------------------------------<a name='3793'></font>
        alpha_haze=3.6<a name='3794'>
        IF (q2m(i,j) .gt. 0.) THEN<a name='3795'>
          alpha_haze=0.1 + pwater(i,j)/25.     + wind125m(i,j)/3. + &amp;<a name='3796'>
                          (100.-rh2m(i,j))/10. + 1./(1000.*q2m(i,j))<a name='3797'>
          alpha_haze=min(alpha_haze,3.6)<a name='3798'>
        ENDIF<a name='3799'>
        <a name='3800'>
        <font color=#447700>! Calculate visibility from hydro/lithometeors<a name='3801'></font>
        <font color=#447700>! Maximum visibility -&gt; 999999 meters<a name='3802'></font>
        <font color=#447700>! --------------------------------------------<a name='3803'></font>
        extcoeff=hydro_extcoeff+dust_extcoeff<a name='3804'>
        IF (extcoeff .gt. 0.) THEN<a name='3805'>
          vis_hydlith=min(visfactor/extcoeff, 999999.)<a name='3806'>
        ELSE<a name='3807'>
          vis_hydlith=999999.<a name='3808'>
        ENDIF<a name='3809'>
<a name='3810'>
        <font color=#447700>! Calculate total visibility<a name='3811'></font>
        <font color=#447700>! Take minimum visibility from hydro/lithometeors and haze<a name='3812'></font>
        <font color=#447700>! Set alpha to be alpha_haze if haze dominates, or 3.6<a name='3813'></font>
        <font color=#447700>! (a Guassian distribution) when hydro/lithometeors dominate<a name='3814'></font>
        <font color=#447700>! ----------------------------------------------------------<a name='3815'></font>
        IF (vis_hydlith &lt; vis_haze) THEN<a name='3816'>
           vis(i,j)=vis_hydlith<a name='3817'>
           vis_alpha(i,j)=3.6<a name='3818'>
        ELSE<a name='3819'>
           vis(i,j)=vis_haze<a name='3820'>
           vis_alpha(i,j)=alpha_haze<a name='3821'>
        ENDIF<a name='3822'>
<a name='3823'>
        <font color=#447700>! Calculate dust visibility<a name='3824'></font>
        <font color=#447700>! Again, define maximum visibility as 20 km<a name='3825'></font>
        <font color=#447700>! -----------------------------------------<a name='3826'></font>
        IF (dust_extcoeff .gt. 0.) THEN<a name='3827'>
          vis_dust(i,j)=MIN(visfactor/dust_extcoeff,999999.)<a name='3828'>
        ELSE<a name='3829'>
          vis_dust(i,j)=999999.<a name='3830'>
        ENDIF<a name='3831'>
      ENDDO<a name='3832'>
    ENDDO<a name='3833'>
<a name='3834'>
  END SUBROUTINE vis_diagnostics<a name='3835'>
  <a name='3836'>
  <a name='3837'>
<a name='3838'>
<A NAME='CLOUD_DIAGNOSTICS'><A href='../../html_code/phys/module_diag_afwa.F.html#CLOUD_DIAGNOSTICS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3839'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>cloud_diagnostics</font> (qcloud                          &amp; <A href='../../call_to/CLOUD_DIAGNOSTICS.html' TARGET='index'>1</A><a name='3840'>
                             , qice                             &amp;<a name='3841'>
                             , qsnow                            &amp;<a name='3842'>
                             , rh                               &amp;<a name='3843'>
                             , dz8w                             &amp;<a name='3844'>
                             , rho                              &amp;<a name='3845'>
                             , z                                &amp;<a name='3846'>
                             , ht                               &amp;<a name='3847'>
                             , cloud                            &amp;<a name='3848'>
                             , cloud_ceil                       &amp;<a name='3849'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='3850'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='3851'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='3852'>
<a name='3853'>
    INTEGER, INTENT(IN) :: ids, ide, jds, jde, kds, kde,        &amp;<a name='3854'>
                           ims, ime, jms, jme, kms, kme,        &amp;<a name='3855'>
                           ips, ipe, jps, jpe, kps, kpe<a name='3856'>
<a name='3857'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),               &amp;<a name='3858'>
         INTENT(IN   ) ::                               qcloud  &amp;<a name='3859'>
                                              ,           qice  &amp; <a name='3860'>
                                              ,          qsnow  &amp; <a name='3861'>
                                              ,             rh  &amp; <a name='3862'>
                                              ,           dz8w  &amp; <a name='3863'>
                                              ,            rho  &amp;<a name='3864'>
                                              ,              z<a name='3865'>
<a name='3866'>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='3867'>
         INTENT(IN   ) ::                                   ht<a name='3868'>
<a name='3869'>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='3870'>
         INTENT(  OUT) ::                                cloud  &amp;<a name='3871'>
                                              ,     cloud_ceil<a name='3872'>
<a name='3873'>
    <font color=#447700>! Local<a name='3874'></font>
    <font color=#447700>! -----<a name='3875'></font>
    INTEGER :: i, j, k<a name='3876'>
    REAL    :: tot_cld_cond, maxrh, cld_frm_cnd, cld_frm_rh, z_maxrh<a name='3877'>
    REAL    :: snow_extcoeff, vis_snow, cloud_lo, zagl_up, zagl_lo<a name='3878'>
    REAL, PARAMETER :: min_ceil = 125.    <font color=#447700>! Minimum ceiling of 125 m<a name='3879'></font>
<a name='3880'>
    <font color=#447700>! Calculate cloud cover based on total cloud condensate, or if none<a name='3881'></font>
    <font color=#447700>! present, from maximum relative humidity in the column.<a name='3882'></font>
    <font color=#447700>! -----------------------------------------------------------------<a name='3883'></font>
    DO i=ims,ime<a name='3884'>
      DO j=jms,jme<a name='3885'>
<a name='3886'>
        <font color=#447700>! Initialize some key variables<a name='3887'></font>
        <font color=#447700>! -----------------------------<a name='3888'></font>
        tot_cld_cond = 0.<a name='3889'>
        cloud(i,j) = 0.<a name='3890'>
        maxrh = -9999.<a name='3891'>
        cloud_ceil(i,j) = -9999.<a name='3892'>
        cloud_lo = 0.<a name='3893'>
<a name='3894'>
        <font color=#447700>! Now go up the column to find our cloud base<a name='3895'></font>
        <font color=#447700>! -------------------------------------------<a name='3896'></font>
        DO k=kms,kme<a name='3897'>
<a name='3898'>
          <font color=#447700>! Total cloud condensate<a name='3899'></font>
          <font color=#447700>! Don't trust modeled cloud below 125 m.  We<a name='3900'></font>
          <font color=#447700>! let the alpha curve determine probabilities<a name='3901'></font>
          <font color=#447700>! below 125 m...<a name='3902'></font>
          <font color=#447700>! ---------------------------------------------<a name='3903'></font>
          IF ( z(i,k,j) - ht (i,j) .gt. min_ceil ) THEN<a name='3904'>
<a name='3905'>
            <font color=#447700>! Maximum column relative humidity<a name='3906'></font>
            <font color=#447700>! --------------------------------<a name='3907'></font>
            IF (rh (i,k,j) .gt. maxrh) THEN<a name='3908'>
              maxrh = rh (i,k,j)<a name='3909'>
              z_maxrh = z(i,k,j)<a name='3910'>
            ENDIF<a name='3911'>
<a name='3912'>
<font color=#447700>!            ! Cloud cover parameterization. Take maximum value<a name='3913'></font>
<font color=#447700>!            ! from condensate and relative humidity terms.<a name='3914'></font>
<font color=#447700>!            ! ------------------------------------------------<a name='3915'></font>
<font color=#447700>!            tot_cld_cond = tot_cld_cond + (qcloud (i,k,j) + qice (i,k,j) &amp;<a name='3916'></font>
<font color=#447700>!                           + qsnow (i,k,j)) * dz8w (i,k,j) * rho(i,k,j)<a name='3917'></font>
<font color=#447700>!            cld_frm_cnd = 50. * tot_cld_cond<a name='3918'></font>
<font color=#447700>!            cld_frm_rh = MAX(((maxrh - 70.) / 30.),0.)<a name='3919'></font>
<font color=#447700>!            cloud (i,j) = MAX(cld_frm_cnd,cld_frm_rh)<a name='3920'></font>
<a name='3921'>
            <font color=#447700>! Calculate cloud cover beta value by summing <a name='3922'></font>
            <font color=#447700>! relative humidity above 70% as we go up the<a name='3923'></font>
            <font color=#447700>! column.  Assume a higher probability of a<a name='3924'></font>
            <font color=#447700>! cloud if we have an accumulation of high<a name='3925'></font>
            <font color=#447700>! relative humidity over a typical cloud<a name='3926'></font>
            <font color=#447700>! depth of 500m. (Note dz8w is distance <a name='3927'></font>
            <font color=#447700>! between full eta levels. Note also that rh<a name='3928'></font>
            <font color=#447700>! is derived from the sum of qvapor, qcloud,<a name='3929'></font>
            <font color=#447700>! and qcloud, with a maximum of 100%). <a name='3930'></font>
            <font color=#447700>! -------------------------------------------<a name='3931'></font>
            cld_frm_rh = MAX(((rh (i,k,j) - 90.) / 10.),0.)<a name='3932'>
            cloud (i,j) = cloud (i,j) + ( cld_frm_rh * dz8w (i,k,j) ) / 250.<a name='3933'>
<a name='3934'>
            <font color=#447700>! Calculate cloud ceiling, the level at which<a name='3935'></font>
            <font color=#447700>! parameterization of cloud cover exceeds 80%<a name='3936'></font>
            <font color=#447700>! Once we exceed the 80% threshold, we will<a name='3937'></font>
            <font color=#447700>! interpolate downward to find the ceiling.<a name='3938'></font>
            <font color=#447700>! If this is the lowest level, then we will<a name='3939'></font>
            <font color=#447700>! simply set ceiling to that level.  After<a name='3940'></font>
            <font color=#447700>! we interpolate, if ceiling is below the <a name='3941'></font>
            <font color=#447700>! minimum we trust, we set it to the minimum.<a name='3942'></font>
            <font color=#447700>! -------------------------------------------<a name='3943'></font>
            IF ( cloud_ceil (i,j) .eq. -9999. .and. cloud (i,j) .gt. 0.8 ) THEN<a name='3944'>
              zagl_up = z (i,k,j) - ht (i,j)<a name='3945'>
              IF ( k .EQ. kps ) THEN<a name='3946'>
                cloud_ceil (i,j) = zagl_up<a name='3947'>
              ELSE<a name='3948'>
                zagl_lo = z (i,k-1,j) - ht (i,j)<a name='3949'>
                cloud_ceil (i,j) = zagl_lo + &amp;<a name='3950'>
                             ((0.8 - cloud_lo) / &amp;<a name='3951'>
                             (cloud (i,j) - cloud_lo)) * &amp;<a name='3952'>
                             (zagl_up - zagl_lo)<a name='3953'>
                cloud_ceil (i,j) = MAX(cloud_ceil (i,j),ceil_min)<a name='3954'>
              ENDIF<a name='3955'>
            ENDIF<a name='3956'>
            <a name='3957'>
            <font color=#447700>! Save cloud amount here to use for interpolation<a name='3958'></font>
            <font color=#447700>! -----------------------------------------------<a name='3959'></font>
            cloud_lo=cloud(i,j)<a name='3960'>
          ENDIF<a name='3961'>
        ENDDO<a name='3962'>
<a name='3963'>
        <font color=#447700>! If we did not encounter any definitive cloud earlier, we set<a name='3964'></font>
        <font color=#447700>! cloud ceiling to the level of maximum relative humidity. (If<a name='3965'></font>
        <font color=#447700>! there is any cloud, this is our best guess as to where it<a name='3966'></font>
        <font color=#447700>! will reside in the vertical). Height is AGL.<a name='3967'></font>
        <font color=#447700>! ------------------------------------------------------------<a name='3968'></font>
        IF (cloud_ceil (i,j) .eq. -9999.) THEN<a name='3969'>
          cloud_ceil (i,j) = z_maxrh - ht (i,j)<a name='3970'>
        ENDIF<a name='3971'>
<a name='3972'>
        <font color=#447700>! Compare cloud ceiling to surface visibility reduction due to snow<a name='3973'></font>
        <font color=#447700>! Note difference from horizontal visibility algorithm for snow<a name='3974'></font>
        <font color=#447700>! -----------------------------------------------------------------<a name='3975'></font>
        IF (qsnow (i,1,j) .GT. 0. .AND. rho (i,1,j) .GT. 0.) THEN<a name='3976'>
          snow_extcoeff = 25. * (1000. * rho(i,1,j) * qsnow (i,1,j))**0.78<a name='3977'>
          snow_extcoeff = snow_extcoeff / 1000.<a name='3978'>
          vis_snow = 3.912 / snow_extcoeff<a name='3979'>
          IF (vis_snow .LT. cloud_ceil (i,j)) cloud_ceil (i,j) = vis_snow<a name='3980'>
        ENDIF<a name='3981'>
<a name='3982'>
      ENDDO<a name='3983'>
    ENDDO<a name='3984'>
<a name='3985'>
  END SUBROUTINE cloud_diagnostics<a name='3986'>
<a name='3987'>
<a name='3988'>
<a name='3989'>
<A NAME='THERMAL_DIAGNOSTICS'><A href='../../html_code/phys/module_diag_afwa.F.html#THERMAL_DIAGNOSTICS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3990'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>thermal_diagnostics</font> ( t2                           &amp; <A href='../../call_to/THERMAL_DIAGNOSTICS.html' TARGET='index'>1</A><a name='3991'>
                             , psfc                             &amp;<a name='3992'>
                             , rh2m                             &amp;<a name='3993'>
                             , wind10m                          &amp;<a name='3994'>
                             , heatidx                          &amp;<a name='3995'>
                             , wchill                           &amp;<a name='3996'>
                             , fits                             &amp;<a name='3997'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='3998'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='3999'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='4000'>
<a name='4001'>
    INTEGER, INTENT(IN) :: ids, ide, jds, jde, kds, kde,        &amp;<a name='4002'>
                           ims, ime, jms, jme, kms, kme,        &amp;<a name='4003'>
                           ips, ipe, jps, jpe, kps, kpe<a name='4004'>
<a name='4005'>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='4006'>
         INTENT(IN   ) ::                                   t2  &amp;<a name='4007'>
                                              ,           psfc  &amp;<a name='4008'>
                                              ,           rh2m  &amp; <a name='4009'>
                                              ,        wind10m<a name='4010'>
<a name='4011'>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='4012'>
         INTENT(  OUT) ::                              heatidx  &amp;<a name='4013'>
                                              ,         wchill  &amp; <a name='4014'>
                                              ,           fits<a name='4015'>
<a name='4016'>
    <font color=#447700>! Local<a name='4017'></font>
    <font color=#447700>! -----<a name='4018'></font>
    INTEGER :: i, j<a name='4019'>
<a name='4020'>
    DO i=ims,ime<a name='4021'>
      DO j=jms,jme<a name='4022'>
       <a name='4023'>
        <font color=#447700>! Heat Index<a name='4024'></font>
        <font color=#447700>! ----------<a name='4025'></font>
        heatidx ( i, j ) = calc_hi   (   t2      ( i, j )    &amp;<a name='4026'>
                                       , rh2m    ( i, j ) )<a name='4027'>
<a name='4028'>
        <font color=#447700>! Wind Chill<a name='4029'></font>
        <font color=#447700>! ----------<a name='4030'></font>
        wchill  ( i, j ) = calc_wc   (   t2      ( i, j )    &amp;<a name='4031'>
                                       , wind10m ( i, j ) )<a name='4032'>
<a name='4033'>
        <font color=#447700>! Fighter Index of Thermal Stress<a name='4034'></font>
        <font color=#447700>! -------------------------------<a name='4035'></font>
        fits    ( i, j ) = calc_fits (   psfc    ( i, j )    &amp;<a name='4036'>
                                       , t2      ( i, j )    &amp;<a name='4037'>
                                       , rh2m    ( i, j ) )<a name='4038'>
<a name='4039'>
      ENDDO<a name='4040'>
    ENDDO<a name='4041'>
<a name='4042'>
  END SUBROUTINE thermal_diagnostics<a name='4043'>
<a name='4044'>
<a name='4045'>
<a name='4046'>
<A NAME='TURBULENCE_DIAGNOSTICS'><A href='../../html_code/phys/module_diag_afwa.F.html#TURBULENCE_DIAGNOSTICS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4047'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>turbulence_diagnostics</font> ( u_phy                     &amp; <A href='../../call_to/TURBULENCE_DIAGNOSTICS.html' TARGET='index'>1</A><a name='4048'>
                             , v_phy                            &amp;<a name='4049'>
                             , t_phy                            &amp;<a name='4050'>
                             , p                                &amp;<a name='4051'>
                             , zagl                             &amp;<a name='4052'>
                             , defor11                          &amp;<a name='4053'>
                             , defor12                          &amp;<a name='4054'>
                             , defor22                          &amp;<a name='4055'>
                             , turb                             &amp;<a name='4056'>
                             , llturb                           &amp;<a name='4057'>
                             , llturblgt                        &amp;<a name='4058'>
                             , llturbmdt                        &amp;<a name='4059'>
                             , llturbsvr                        &amp;<a name='4060'>
                             , nlyrs                            &amp;<a name='4061'>
                             , lyrbot                           &amp;<a name='4062'>
                             , lyrtop                           &amp;<a name='4063'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='4064'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='4065'>
                             , ips, ipe, jps, jpe, kps, kpe )<a name='4066'>
<a name='4067'>
    INTEGER, INTENT(IN) :: ids, ide, jds, jde, kds, kde,        &amp;<a name='4068'>
                           ims, ime, jms, jme, kms, kme,        &amp;<a name='4069'>
                           ips, ipe, jps, jpe, kps, kpe<a name='4070'>
<a name='4071'>
    INTEGER, INTENT(IN) :: nlyrs<a name='4072'>
<a name='4073'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),               &amp;<a name='4074'>
         INTENT(IN   ) ::                                u_phy  &amp;<a name='4075'>
                                              ,          v_phy  &amp;<a name='4076'>
                                              ,          t_phy  &amp; <a name='4077'>
                                              ,              p  &amp; <a name='4078'>
                                              ,           zagl  &amp;<a name='4079'>
                                              ,        defor11  &amp; <a name='4080'>
                                              ,        defor12  &amp; <a name='4081'>
                                              ,        defor22<a name='4082'>
<a name='4083'>
    REAL, DIMENSION( nlyrs ),                                   &amp;<a name='4084'>
         INTENT(IN   ) ::                               lyrtop  &amp;<a name='4085'>
                                              ,         lyrbot<a name='4086'>
<a name='4087'>
    REAL, DIMENSION( ims:ime, nlyrs, jms:jme ),                 &amp;<a name='4088'>
         INTENT(  OUT) ::                                 turb   <a name='4089'>
<a name='4090'>
    REAL, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='4091'>
         INTENT(  OUT) ::                               llturb  &amp;<a name='4092'>
                                              ,      llturblgt  &amp;<a name='4093'>
                                              ,      llturbmdt  &amp; <a name='4094'>
                                              ,      llturbsvr<a name='4095'>
<a name='4096'>
    <font color=#447700>! Local<a name='4097'></font>
    <font color=#447700>! -----<a name='4098'></font>
    INTEGER :: i, j, k, n, bot, top, nlayer<a name='4099'>
<a name='4100'>
    REAL ::                                            ugrdtop  &amp;<a name='4101'>
                                              ,        ugrdbot  &amp;<a name='4102'>
                                              ,        vgrdtop  &amp;<a name='4103'>
                                              ,        vgrdbot  &amp;<a name='4104'>
                                              ,     defor11top  &amp;<a name='4105'>
                                              ,     defor11bot  &amp;<a name='4106'>
                                              ,     defor12top  &amp;<a name='4107'>
                                              ,     defor12bot  &amp;<a name='4108'>
                                              ,     defor22top  &amp;<a name='4109'>
                                              ,     defor22bot<a name='4110'>
<a name='4111'>
    REAL, DIMENSION( kms:kme )            ::         this_zagl  &amp;<a name='4112'>
                                              ,        this_tK  &amp;<a name='4113'>
                                              ,         this_p  &amp;<a name='4114'>
                                              ,         this_u  &amp;<a name='4115'>
                                              ,         this_v<a name='4116'>
<a name='4117'>
    REAL :: wind, therm, mtn_wave, tpd_wave<a name='4118'>
<a name='4119'>
    <font color=#447700>!~ Initialize variables.<a name='4120'></font>
    <font color=#447700>!  ----------------------<a name='4121'></font>
    turb = REAL ( 0 )<a name='4122'>
    llturb = REAL ( 0 )<a name='4123'>
    llturblgt = REAL ( 0 )<a name='4124'>
    llturbsvr = REAL ( 0 )<a name='4125'>
<a name='4126'>
    <font color=#447700>!~ Loop through the grid.<a name='4127'></font>
    <font color=#447700>!  ----------------------<a name='4128'></font>
    DO i=ims,ime<a name='4129'>
      DO j=jms,jme<a name='4130'>
       <a name='4131'>
        <font color=#447700>!~ Loop through the turbulence layers<a name='4132'></font>
        <font color=#447700>!  ----------------------------------<a name='4133'></font>
        DO n = 1, nlyrs<a name='4134'>
<a name='4135'>
          <font color=#447700>!~ Interpolate relevent variables to turbulence layers<a name='4136'></font>
          <font color=#447700>!  ---------------------------------------------------<a name='4137'></font>
          ugrdtop    = lin_interp (     zagl ( i, kms:kme-1, j )  &amp;<a name='4138'>
                                   ,   u_phy ( i, kms:kme-1, j )  &amp;<a name='4139'>
                                   ,             lyrtop  ( n ) )<a name='4140'>
          ugrdbot    = lin_interp (     zagl ( i, kms:kme-1, j )  &amp;<a name='4141'>
                                   ,   u_phy ( i, kms:kme-1, j )  &amp;<a name='4142'>
                                   ,             lyrbot  ( n ) )<a name='4143'>
          vgrdtop    = lin_interp (     zagl ( i, kms:kme-1, j )  &amp;<a name='4144'>
                                   ,   v_phy ( i, kms:kme-1, j )  &amp;<a name='4145'>
                                   ,             lyrtop  ( n ) )<a name='4146'>
          vgrdbot    = lin_interp (     zagl ( i, kms:kme-1, j )  &amp;<a name='4147'>
                                   ,   v_phy ( i, kms:kme-1, j )  &amp;<a name='4148'>
                                   ,             lyrbot  ( n ) )<a name='4149'>
          defor11top = lin_interp (     zagl ( i, kms:kme-1, j )  &amp;<a name='4150'>
                                   , defor11 ( i, kms:kme-1, j )  &amp;<a name='4151'>
                                   ,             lyrtop  ( n ) )<a name='4152'>
          defor11bot = lin_interp (     zagl ( i, kms:kme-1, j )  &amp;<a name='4153'>
                                   , defor11 ( i, kms:kme-1, j )  &amp;<a name='4154'>
                                   ,             lyrbot  ( n ) )<a name='4155'>
          defor12top = lin_interp (     zagl ( i, kms:kme-1, j )  &amp;<a name='4156'>
                                   , defor12 ( i, kms:kme-1, j )  &amp;<a name='4157'>
                                   ,             lyrtop  ( n ) )<a name='4158'>
          defor12bot = lin_interp (     zagl ( i, kms:kme-1, j )  &amp;<a name='4159'>
                                   , defor12 ( i, kms:kme-1, j )  &amp;<a name='4160'>
                                   ,             lyrbot  ( n ) )<a name='4161'>
          defor22top = lin_interp (     zagl ( i, kms:kme-1, j )  &amp;<a name='4162'>
                                   , defor22 ( i, kms:kme-1, j )  &amp;<a name='4163'>
                                   ,             lyrtop  ( n ) )<a name='4164'>
          defor22bot = lin_interp (     zagl ( i, kms:kme-1, j )  &amp;<a name='4165'>
                                   , defor22 ( i, kms:kme-1, j )  &amp;<a name='4166'>
                                   ,             lyrbot  ( n ) )<a name='4167'>
<a name='4168'>
          <font color=#447700>!~ Compute Knapp-Ellrod clear air turbulence<a name='4169'></font>
          <font color=#447700>!  -----------------------------------------<a name='4170'></font>
          turb ( i, n, j ) = CATTurbulence (                       ugrdbot  &amp;<a name='4171'>
                                               ,                   ugrdtop  &amp;<a name='4172'>
                                               ,                   vgrdbot  &amp;<a name='4173'>
                                               ,                   vgrdtop  &amp;<a name='4174'>
                                               ,                defor11bot  &amp;<a name='4175'>
                                               ,                defor11top  &amp;<a name='4176'>
                                               ,                defor12bot  &amp;<a name='4177'>
                                               ,                defor12top  &amp;<a name='4178'>
                                               ,                defor22bot  &amp;<a name='4179'>
                                               ,                defor22top  &amp;<a name='4180'>
                                               ,                lyrbot (n)  &amp;<a name='4181'>
                                               ,                lyrtop (n) )<a name='4182'>
<a name='4183'>
        ENDDO<a name='4184'>
 <a name='4185'>
        <font color=#447700>!~ Get top and bottom index of 0-1500 m AGL layer<a name='4186'></font>
        <font color=#447700>!  ----------------------------------------------<a name='4187'></font>
        bot = kms<a name='4188'>
        top = kms<a name='4189'>
        DO k=kms+1,kme<a name='4190'>
          IF ( zagl ( i, k, j ) .gt. 1500. ) THEN<a name='4191'>
            top = k<a name='4192'>
            EXIT<a name='4193'>
          ENDIF<a name='4194'>
        ENDDO<a name='4195'>
        nlayer = top - bot + 1  <font color=#447700>!~ Number of layers from bottom to top<a name='4196'></font>
<a name='4197'>
        <font color=#447700>!~ Copy current column at this i,j point into working arrays<a name='4198'></font>
        <font color=#447700>!  ---------------------------------------------------------<a name='4199'></font>
        this_zagl = zagl  ( i, kms:kme, j )<a name='4200'>
        this_tK   = t_phy ( i, kms:kme, j )<a name='4201'>
        this_p    = p     ( i, kms:kme, j )<a name='4202'>
        this_u    = u_phy ( i, kms:kme, j )<a name='4203'>
        this_v    = v_phy ( i, kms:kme, j )<a name='4204'>
                           <a name='4205'>
        <font color=#447700>!~ Interpolate req'd vars to the 1500 m level<a name='4206'></font>
        <font color=#447700>!~ Overwrite the "top" index with these values<a name='4207'></font>
        <font color=#447700>!  -------------------------------------------<a name='4208'></font>
        this_zagl ( top ) = 1500.<a name='4209'>
        this_tK ( top )   = lin_interp (  zagl ( i, kms:kme-1, j )  &amp;<a name='4210'>
                                     ,   t_phy ( i, kms:kme-1, j )  &amp;<a name='4211'>
                                     ,           this_zagl (top) )<a name='4212'>
        this_p ( top )    = lin_interp (  zagl ( i, kms:kme-1, j )  &amp;<a name='4213'>
                                     ,       p ( i, kms:kme-1, j )  &amp;<a name='4214'>
                                     ,           this_zagl (top) )<a name='4215'>
        this_u ( top )    = lin_interp (  zagl ( i, kms:kme-1, j )  &amp;<a name='4216'>
                                     ,   u_phy ( i, kms:kme-1, j )  &amp;<a name='4217'>
                                     ,           this_zagl (top) )<a name='4218'>
        this_v ( top )    = lin_interp (  zagl ( i, kms:kme-1, j )  &amp;<a name='4219'>
                                     ,   v_phy ( i, kms:kme-1, j )  &amp;<a name='4220'>
                                     ,           this_zagl (top) )<a name='4221'>
<a name='4222'>
        <font color=#447700>!~ Compute the low level turbulence index (from 0 - 1500 m AGL)<a name='4223'></font>
        <font color=#447700>!~ There are four components to this index: a wind speed term,<a name='4224'></font>
        <font color=#447700>!~ thermodynamic term, mountain wave term, and trapped wave term.<a name='4225'></font>
        <font color=#447700>!~ These terms will utilize the working arrays we have just<a name='4226'></font>
        <font color=#447700>!~ defined, using only the portion of the array valid in the<a name='4227'></font>
        <font color=#447700>!~ 0-1500 m layer, e.g. this_u (bot:top).<a name='4228'></font>
        <font color=#447700>!~ The algorithm itself was developed by:<a name='4229'></font>
        <font color=#447700>!~ <a name='4230'></font>
        <font color=#447700>!~ Mr. James McCormick<a name='4231'></font>
        <font color=#447700>!~ Aviation Hazards Team<a name='4232'></font>
        <font color=#447700>!~ Air Force Weather Agency 16WS/WXN<a name='4233'></font>
        <font color=#447700>!~ DSN: 271-1689 Comm: (402) 294-1689<a name='4234'></font>
        <font color=#447700>!~ James.McCormick.ctr@offutt.af.mil<a name='4235'></font>
        <font color=#447700>!  --------------------------------------------------------------  !<a name='4236'></font>
        <font color=#447700>!~ Step 1: Compute the wind speed term                            ~!<a name='4237'></font>
        <font color=#447700>!  --------------------------------------------------------------  !<a name='4238'></font>
        wind = LLT_WindSpeed ( nlayer, this_u (bot:top) &amp;<a name='4239'>
                                , this_v (bot:top) )<a name='4240'>
<a name='4241'>
        <font color=#447700>!  --------------------------------------------------------------  !<a name='4242'></font>
        <font color=#447700>!~ Step 2: Compute the thermodynamic term                         ~!<a name='4243'></font>
        <font color=#447700>!  --------------------------------------------------------------  !<a name='4244'></font>
        therm = LLT_Thermodynamic ( nlayer, this_tK(bot:top) &amp;<a name='4245'>
                                , this_zagl(bot:top) )<a name='4246'>
<a name='4247'>
        <font color=#447700>!  --------------------------------------------------------------  !<a name='4248'></font>
        <font color=#447700>!~ Step 3: Compute the mountain wave term                         ~!<a name='4249'></font>
        <font color=#447700>!  --------------------------------------------------------------  !<a name='4250'></font>
        mtn_wave = LLT_MountainWave ( nlayer, terrain_dx, terrain_dy &amp;<a name='4251'>
                                , this_u(bot:top), this_v(bot:top)   &amp;<a name='4252'>
                                , this_tK(bot:top), this_zagl(bot:top) )<a name='4253'>
<a name='4254'>
        <font color=#447700>!  --------------------------------------------------------------  !<a name='4255'></font>
        <font color=#447700>!~ Step 4: Compute the trapped wave term                          ~!<a name='4256'></font>
        <font color=#447700>!  --------------------------------------------------------------  !<a name='4257'></font>
        tpd_wave = LLT_TrappedWave ( nlayer, this_u(bot:top) &amp;<a name='4258'>
                                , this_v(bot:top), this_p(bot:top) )<a name='4259'>
<a name='4260'>
        <font color=#447700>!  --------------------------------------------------------------  !<a name='4261'></font>
        <font color=#447700>!~ Step 5: Combine the above and arrive at the turbulence index.  ~!<a name='4262'></font>
        <font color=#447700>!  --------------------------------------------------------------  !<a name='4263'></font>
        llturb ( i,j ) = 1.-((1.-wind)*(1.-therm)*(1.-mtn_wave)*(1.-tpd_wave))<a name='4264'>
<a name='4265'>
        <font color=#447700>!~ Compute probabilities of light, moderate, and severe LLT<a name='4266'></font>
        <font color=#447700>!  --------------------------------------------------------<a name='4267'></font>
        llturblgt ( i,j ) = (((((((llturb (i,j) * REAL (100))-REAL (30)) &amp;<a name='4268'>
                                        *2.5)*.01)**2)*0.75)*REAL(100))<a name='4269'>
        IF ( llturb (i,j) &lt; 0.3   ) llturblgt ( i,j ) = REAL ( 0 )<a name='4270'>
        IF ( llturblgt (i,j) &gt; REAL (90) ) llturblgt ( i,j ) = REAL ( 90 )<a name='4271'>
<a name='4272'>
        llturbmdt ( i,j ) = (((((((llturb (i,j) * REAL (100))-REAL (35)) &amp;<a name='4273'>
                                     *2.22222)*.01)*0.75)**2)*88.88888)<a name='4274'>
        IF ( llturb (i,j) &lt; 0.35  ) llturbmdt ( i,j ) = REAL ( 0 )<a name='4275'>
        IF ( llturbmdt (i,j) &gt; REAL (70) ) llturbmdt ( i,j ) = REAL ( 70 )<a name='4276'>
<a name='4277'>
        llturbsvr ( i,j ) = (((((((llturb (i,j) * REAL (100))-REAL (40)) &amp;<a name='4278'>
                                     *REAL(2))*.01)*0.5)**2)*REAL(100))<a name='4279'>
        IF ( llturb (i,j) &lt; 0.40  ) llturbsvr ( i,j ) = REAL ( 0 )<a name='4280'>
        IF ( llturbsvr (i,j) &gt; REAL (35) ) llturbsvr ( i,j ) = REAL ( 35 )<a name='4281'>
<a name='4282'>
      ENDDO<a name='4283'>
    ENDDO<a name='4284'>
<a name='4285'>
  END SUBROUTINE turbulence_diagnostics<a name='4286'>
<a name='4287'>
END MODULE module_diag_afwa<a name='4288'>
<a name='4289'>
#endif<a name='4290'>
</pre></body></html>