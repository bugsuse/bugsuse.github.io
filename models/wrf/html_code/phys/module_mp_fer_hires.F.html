<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_MP:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>!-- Updates based on NAM changes in 2011:<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<font color=#447700>! (a) Expanded rain lookup tables from 0.45 mm to 1 mm mean diameter.<a name='6'></font>
<font color=#447700>! (b) Allow cloud ice to fall (fall speeds based on 50 micron mean diameters).<a name='7'></font>
<font color=#447700>! (c) Cloud water autoconversion to rain follows Liu et al. (JAS, 2006)<a name='8'></font>
<font color=#447700>! (d) Fix to MY_GROWTH by multiplying estimates by 1.e-3<a name='9'></font>
<font color=#447700>! (e) Added integer function GET_INDEXR<a name='10'></font>
<font color=#447700>! (f) Added warning messages when unusual conditions occur, screened for<a name='11'></font>
<font color=#447700>!     5 different types of problems, such as (1) condensate in the<a name='12'></font>
<font color=#447700>!     stratosphere, (2) temperature = NaN, (3) water supersaturation at<a name='13'></font>
<font color=#447700>!     &lt;180K, (4) too many iterations (&gt;10) in the condensation function,<a name='14'></font>
<font color=#447700>!     and (5) too many iterations (&gt;10) in the deposition function.  <a name='15'></font>
<font color=#447700>!<a name='16'></font>
<font color=#447700>!-- Updates based on jan19 2014 changes in the NMMB:<a name='17'></font>
<font color=#447700>!<a name='18'></font>
<font color=#447700>! (1) Ice nucleation: Fletcher (1962) replaces Meyers et al. (1992)<a name='19'></font>
<font color=#447700>! (2) Cloud ice is a simple function of the number concentration from (1), and it<a name='20'></font>
<font color=#447700>!     is no longer a fractional function of the large ice.  Thus, the FLARGE &amp;<a name='21'></font>
<font color=#447700>!     FSMALL parameters are no longer used.<a name='22'></font>
<font color=#447700>! (3) T_ICE_init=-12 deg C provides a slight delay in the initial onset of ice.<a name='23'></font>
<font color=#447700>! (4) NLImax is a function of rime factor (RF) and temperature.  <a name='24'></font>
<font color=#447700>!    a) For RF&gt;10, NLImax=1.e3.  Mean ice diameters can exceed the 1 mm maximum<a name='25'></font>
<font color=#447700>!       size in the tables so that NLICE=NLImax=1.e3.<a name='26'></font>
<font color=#447700>!    b) Otherwise, NLImax is 10 L-1 at 0C and increases with colder temperatures<a name='27'></font>
<font color=#447700>!       to 20 L-1 at &lt;=-40C.  Also, NLICE can be &gt;NLImax at the maximum ice <a name='28'></font>
<font color=#447700>!       diameter of 1 mm.<a name='29'></font>
<font color=#447700>! (5) Can turn off ice processes by setting T_ICE &amp; T_ICE_init to be &lt; -100 deg C<a name='30'></font>
<font color=#447700>! (6) Modified the homogeneous freezing of cloud water when T&lt;T_ICE.<a name='31'></font>
<font color=#447700>! (7) Reduce the fall speeds of rimed ice by making VEL_INC a function of <a name='32'></font>
<font color=#447700>!     VrimeF**1.5 and not VrimeF**2.<a name='33'></font>
<font color=#447700>! (8) RHgrd=0.98 (98% RH) for the onset of condensation, to match what's been<a name='34'></font>
<font color=#447700>!     tested for many months in the NAMX.<a name='35'></font>
<font color=#447700>! (9) Rime factor is *never* adjusted when NLICE&gt;NLImax.  <a name='36'></font>
<font color=#447700>! (10) Ice deposition does not change the rime factor (RF) when RF&gt;=10 &amp; T&gt;T_ICE.<a name='37'></font>
<font color=#447700>! (11) Limit GAMMAS to &lt;=1.5 (air resistance impact on ice fall speeds)<a name='38'></font>
<font color=#447700>! (12) NSImax is maximum # conc of ice crystals.  At cold temperature NSImax is<a name='39'></font>
<font color=#447700>!      calculated based on assuming 10% of total ice content is due to cloud ice.<a name='40'></font>
<font color=#447700>!<a name='41'></font>
<A NAME='MODULE_MP_FER_HIRES'><A href='../../html_code/phys/module_mp_fer_hires.F.html#MODULE_MP_FER_HIRES' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='42'>
<font color=#993300>MODULE </font><font color=#cc0000>module_mp_fer_hires</font> <A href='../../call_to/MODULE_MP_FER_HIRES.html' TARGET='index'>2</A><a name='43'>
<font color=#447700>!-----------------------------------------------------------------------<a name='44'></font>
<font color=#447700>!-- The following changes were made on 24 July 2006.<a name='45'></font>
<font color=#447700>!   (1) All known version 2.1 dependencies were removed from the <a name='46'></font>
<font color=#447700>!       operational WRF NMM model code (search for "!HWRF")<a name='47'></font>
<font color=#447700>!   (2) Incorporated code changes from the GFDL model (search for "!GFDL")<a name='48'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='49'></font>
<font color=#447700>!<a name='50'></font>
      REAL,PRIVATE,SAVE ::  ABFR, CBFR, CIACW, CIACR, C_N0r0,           &amp;<a name='51'>
     &amp;  ARAUT, BRAUT, CN0r0, CN0r_DMRmin, CN0r_DMRmax, CRACW, ESW0,     &amp;<a name='52'>
     &amp;  RFmax, RQR_DRmin, RQR_DRmax, RR_DRmin, RR_DR1, RR_DR2,          &amp;<a name='53'>
     &amp;  RR_DR3, RR_DR4, RR_DR5, RR_DRmax, BETA6, PI_E<a name='54'>
<font color=#447700>!<a name='55'></font>
      INTEGER, PRIVATE,PARAMETER :: MY_T1=1, MY_T2=35<a name='56'>
      REAL,PRIVATE,DIMENSION(MY_T1:MY_T2),SAVE :: MY_GROWTH<a name='57'>
<font color=#447700>!<a name='58'></font>
      REAL, PRIVATE,PARAMETER :: DMImin=.05e-3, DMImax=1.e-3,           &amp;<a name='59'>
     &amp;      DelDMI=1.e-6,XMImin=1.e6*DMImin,XMIexp=.0536<a name='60'>
      INTEGER, PUBLIC,PARAMETER :: XMImax=1.e6*DMImax,                  &amp;<a name='61'>
     &amp;                             MDImin=XMImin, MDImax=XMImax<a name='62'>
      REAL, PRIVATE,DIMENSION(MDImin:MDImax) ::                         &amp;<a name='63'>
     &amp;      ACCRI,VSNOWI,VENTI1,VENTI2<a name='64'>
      REAL, PUBLIC,DIMENSION(MDImin:MDImax) :: SDENS    <font color=#447700>!-- For RRTM<a name='65'></font>
<font color=#447700>!<a name='66'></font>
      REAL, PRIVATE,PARAMETER :: DMRmin=.05e-3, DMRmax=1.0e-3,           &amp;<a name='67'>
     &amp;      DelDMR=1.e-6, XMRmin=1.e6*DMRmin, XMRmax=1.e6*DMRmax<a name='68'>
      INTEGER, PUBLIC,PARAMETER :: MDRmin=XMRmin, MDRmax=XMRmax<a name='69'>
<font color=#447700>!<a name='70'></font>
      REAL, PRIVATE,DIMENSION(MDRmin:MDRmax)::                           &amp;<a name='71'>
     &amp;      ACCRR,MASSR,RRATE,VRAIN,VENTR1,VENTR2<a name='72'>
<font color=#447700>!<a name='73'></font>
      INTEGER, PRIVATE,PARAMETER :: Nrime=40<a name='74'>
      REAL, DIMENSION(2:9,0:Nrime),PRIVATE,SAVE :: VEL_RF<a name='75'>
<font color=#447700>!<a name='76'></font>
      INTEGER,PARAMETER :: NX=7501<a name='77'>
      REAL, PARAMETER :: XMIN=180.0,XMAX=330.0<a name='78'>
      REAL, DIMENSION(NX),PRIVATE,SAVE :: TBPVS,TBPVS0<a name='79'>
      REAL, PRIVATE,SAVE :: C1XPVS0,C2XPVS0,C1XPVS,C2XPVS<a name='80'>
<font color=#447700>!<a name='81'></font>
      REAL, PRIVATE,PARAMETER ::                                        &amp;<a name='82'>
<font color=#447700>!--- Physical constants follow:<a name='83'></font>
     &amp;   CP=1004.6, EPSQ=1.E-12, GRAV=9.806, RHOL=1000., RD=287.04      &amp;<a name='84'>
     &amp;  ,RV=461.5, T0C=273.15, XLS=2.834E6                              &amp;<a name='85'>
<font color=#447700>!--- Derived physical constants follow:<a name='86'></font>
     &amp;  ,EPS=RD/RV, EPS1=RV/RD-1., EPSQ1=1.001*EPSQ                     &amp;<a name='87'>
     &amp;  ,RCP=1./CP, RCPRV=RCP/RV, RGRAV=1./GRAV, RRHOL=1./RHOL          &amp;<a name='88'>
     &amp;  ,XLS1=XLS*RCP, XLS2=XLS*XLS*RCPRV, XLS3=XLS*XLS/RV              &amp;<a name='89'>
<font color=#447700>!--- Constants specific to the parameterization follow:<a name='90'></font>
<font color=#447700>!--- CLIMIT/CLIMIT1 are lower limits for treating accumulated precipitation<a name='91'></font>
     &amp;  ,CLIMIT=10.*EPSQ, CLIMIT1=-CLIMIT                               &amp;<a name='92'>
     &amp;  ,C1=1./3.                                                       &amp;<a name='93'>
     &amp;  ,DMR1=.1E-3, DMR2=.2E-3, DMR3=.32E-3, DMR4=0.45E-3              &amp;<a name='94'>
     &amp;  ,DMR5=0.67E-3                                                   &amp;<a name='95'>
     &amp;  ,XMR1=1.e6*DMR1, XMR2=1.e6*DMR2, XMR3=1.e6*DMR3                 &amp;<a name='96'>
     &amp;  ,XMR4=1.e6*DMR4, XMR5=1.e6*DMR5<a name='97'>
      INTEGER, PARAMETER :: MDR1=XMR1, MDR2=XMR2, MDR3=XMR3, MDR4=XMR4  &amp;<a name='98'>
     &amp;  , MDR5=XMR5<a name='99'>
<a name='100'>
<font color=#447700>!-- Debug 20120111<a name='101'></font>
LOGICAL, SAVE :: WARN1=.TRUE.,WARN2=.TRUE.,WARN3=.TRUE.,WARN5=.TRUE.<a name='102'>
REAL, SAVE :: Pwarn=75.E2, QTwarn=1.E-3<a name='103'>
INTEGER, PARAMETER :: MAX_ITERATIONS=10<a name='104'>
<a name='105'>
<font color=#447700>!<a name='106'></font>
<font color=#447700>! ======================================================================<a name='107'></font>
<font color=#447700>!--- Important tunable parameters that are exported to other modules<a name='108'></font>
<font color=#447700>!GFDL * RHgrd - generic reference to the threshold relative humidity for <a name='109'></font>
<font color=#447700>!GFDL           the onset of condensation<a name='110'></font>
<font color=#447700>!GFDL (new) * RHgrd_in  - "RHgrd" for the inner domain<a name='111'></font>
<font color=#447700>!GFDL (new) * RHgrd_out - "RHgrd" for the outer domain<a name='112'></font>
<font color=#447700>!HWRF 6/11/2010 mod - use lower RHgrd_out for p &lt; 850 hPa<a name='113'></font>
<font color=#447700>!  * T_ICE - temperature (C) threshold at which all remaining liquid water<a name='114'></font>
<font color=#447700>!            is glaciated to ice<a name='115'></font>
<font color=#447700>!  * T_ICE_init - maximum temperature (C) at which ice nucleation occurs<a name='116'></font>
<font color=#447700>!<a name='117'></font>
<font color=#447700>!-- To turn off ice processes, set T_ICE &amp; T_ICE_init to &lt;= -100. (i.e., -100 C)<a name='118'></font>
<font color=#447700>!<a name='119'></font>
<font color=#447700>!  * NLImax - maximum number concentrations (m**-3) of large ice (snow/graupel/sleet) <a name='120'></font>
<font color=#447700>!  * NLImin - minimum number concentrations (m**-3) of large ice (snow/graupel/sleet) <a name='121'></font>
<font color=#447700>!  * NSImax - maximum number concentrations (m**-3) of small ice crystals<a name='122'></font>
<font color=#447700>!  * N0r0 - assumed intercept (m**-4) of rain drops if drop diameters are between 0.2 and 0.45 mm<a name='123'></font>
<font color=#447700>!  * N0rmin - minimum intercept (m**-4) for rain drops <a name='124'></font>
<font color=#447700>!  * NCW - number concentrations of cloud droplets (m**-3)<a name='125'></font>
<font color=#447700>!  * PRINT_diag - for extended model diagnostics (code currently commented out)<a name='126'></font>
<font color=#447700>! ======================================================================<a name='127'></font>
      REAL, PUBLIC,PARAMETER ::                                         &amp;<a name='128'>
<font color=#447700>!     &amp;  RHgrd=1.                                                        &amp;<a name='129'></font>
     &amp;  RHgrd_in=1.                                                     &amp;  <font color=#447700>!GFDL<a name='130'></font>
     &amp; ,RHgrd_out=0.975                                                 &amp;  <font color=#447700>!GFDL<a name='131'></font>
     &amp; ,P_RHgrd_out=850.E2                                              &amp;  <font color=#447700>!HWRF 6/11/2010<a name='132'></font>
     &amp; ,T_ICE=-40.                                                      &amp;<a name='133'>
     &amp; ,T_ICEK=T0C+T_ICE                                                &amp;<a name='134'>
     &amp; ,T_ICE_init=-12.                                                 &amp;<a name='135'>
     &amp; ,NSI_max=250.E3                                                  &amp;<a name='136'>
     &amp; ,NLImin=1.E3                                                     &amp;<a name='137'>
     &amp; ,N0r0=8.E6                                                       &amp;<a name='138'>
     &amp; ,N0rmin=1.E4                                                     &amp;<a name='139'>
<font color=#447700>!!2-09-2012     &amp; ,NCW=60.E6                                                       &amp;  !GFDL<a name='140'></font>
<font color=#447700>!! based on Aligo's email,NCW is changed to 250E6<a name='141'></font>
     &amp; ,NCW=250.E6                                                         <font color=#447700>!GFDL<a name='142'></font>
<font color=#447700>!HWRF     &amp; ,NCW=100.E6                                                 &amp;<a name='143'></font>
      LOGICAL, PARAMETER :: PRINT_diag=.FALSE.  <font color=#447700>!GFDL<a name='144'></font>
<font color=#447700>!--- Other public variables passed to other routines:<a name='145'></font>
      REAL, PUBLIC,DIMENSION(MDImin:MDImax) :: MASSI<a name='146'>
<font color=#447700>!<a name='147'></font>
<font color=#447700>!<a name='148'></font>
      CONTAINS<a name='149'>
<a name='150'>
<font color=#447700>!-----------------------------------------------------------------------<a name='151'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='152'></font>
<A NAME='FER_HIRES'><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='153'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>FER_HIRES</font> (itimestep,DT,DX,DY,GID,RAINNC,RAINNCV,    &amp; <font color=#447700>!GID <A href='../../call_to/FER_HIRES.html' TARGET='index'>1</A>,<A href='../../call_from/FER_HIRES.html' TARGET='index'>2</A><a name='154'></font>
     &amp;                      dz8w,rho_phy,p_phy,pi_phy,th_phy,qv,qt,   &amp; <font color=#447700>!gopal's doing<a name='155'></font>
     &amp;                      LOWLYR,SR,                                &amp;<a name='156'>
     &amp;                      F_ICE_PHY,F_RAIN_PHY,F_RIMEF_PHY,         &amp;<a name='157'>
     &amp;                      QC,QR,QI,                                 &amp;<a name='158'>
     &amp;                      ids,ide, jds,jde, kds,kde,                &amp;<a name='159'>
     &amp;                      ims,ime, jms,jme, kms,kme,                &amp;<a name='160'>
     &amp;                      its,ite, jts,jte, kts,kte                 )<a name='161'>
<font color=#447700>!HWRF      SUBROUTINE ETAMP_NEW (itimestep,DT,DX,DY,                         &amp;<a name='162'></font>
<font color=#447700>!HWRF     &amp;                      dz8w,rho_phy,p_phy,pi_phy,th_phy,qv,qc,     &amp;<a name='163'></font>
<font color=#447700>!HWRF     &amp;                      LOWLYR,SR,                                  &amp;<a name='164'></font>
<font color=#447700>!HWRF     &amp;                      F_ICE_PHY,F_RAIN_PHY,F_RIMEF_PHY,           &amp;<a name='165'></font>
<font color=#447700>!HWRF     &amp;                      mp_restart_state,tbpvs_state,tbpvs0_state,  &amp;<a name='166'></font>
<font color=#447700>!HWRF     &amp;                      RAINNC,RAINNCV,                             &amp;<a name='167'></font>
<font color=#447700>!HWRF     &amp;                      ids,ide, jds,jde, kds,kde,		        &amp;<a name='168'></font>
<font color=#447700>!HWRF     &amp;                      ims,ime, jms,jme, kms,kme,		        &amp;<a name='169'></font>
<font color=#447700>!HWRF     &amp;                      its,ite, jts,jte, kts,kte )<a name='170'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='171'></font>
      IMPLICIT NONE<a name='172'>
<font color=#447700>!-----------------------------------------------------------------------<a name='173'></font>
      INTEGER, PARAMETER :: ITLO=-60, ITHI=40<a name='174'>
<a name='175'>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='176'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='177'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE                     &amp;<a name='178'>
     &amp;                     ,ITIMESTEP,GID  <font color=#447700>! GID gopal's doing<a name='179'></font>
<a name='180'>
      REAL, INTENT(IN) 	    :: DT,DX,DY<a name='181'>
      REAL, INTENT(IN),     DIMENSION(ims:ime, kms:kme, jms:jme)::      &amp;<a name='182'>
     &amp;                      dz8w,p_phy,pi_phy,rho_phy<a name='183'>
      REAL, INTENT(INOUT),  DIMENSION(ims:ime, kms:kme, jms:jme)::      &amp;<a name='184'>
     &amp;                      th_phy,qv,qt,qc,qr,qi<a name='185'>
      REAL, INTENT(INOUT),  DIMENSION(ims:ime, kms:kme, jms:jme ) ::    &amp;<a name='186'>
     &amp;                      F_ICE_PHY,F_RAIN_PHY,F_RIMEF_PHY<a name='187'>
      REAL, INTENT(INOUT),  DIMENSION(ims:ime,jms:jme)           ::     &amp;<a name='188'>
     &amp;                                                   RAINNC,RAINNCV<a name='189'>
      REAL, INTENT(OUT),    DIMENSION(ims:ime,jms:jme):: SR<a name='190'>
<font color=#447700>!<a name='191'></font>
<font color=#447700>!HWRF      REAL,DIMENSION(*),INTENT(INOUT) :: MP_RESTART_STATE<a name='192'></font>
<font color=#447700>!<a name='193'></font>
<font color=#447700>!HWRF      REAL,DIMENSION(nx),INTENT(INOUT) :: TBPVS_STATE,TBPVS0_STATE<a name='194'></font>
<font color=#447700>!<a name='195'></font>
      INTEGER, DIMENSION( ims:ime, jms:jme ),INTENT(INOUT) :: LOWLYR<a name='196'>
<a name='197'>
<font color=#447700>!-----------------------------------------------------------------------<a name='198'></font>
<font color=#447700>!     LOCAL VARS<a name='199'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='200'></font>
<a name='201'>
<font color=#447700>!     NSTATS,QMAX,QTOT are diagnostic vars<a name='202'></font>
<a name='203'>
      INTEGER,DIMENSION(ITLO:ITHI,4) :: NSTATS<a name='204'>
      REAL,   DIMENSION(ITLO:ITHI,5) :: QMAX<a name='205'>
      REAL,   DIMENSION(ITLO:ITHI,22):: QTOT<a name='206'>
<a name='207'>
<font color=#447700>!     SOME VARS WILL BE USED FOR DATA ASSIMILATION (DON'T NEED THEM NOW). <a name='208'></font>
<font color=#447700>!     THEY ARE TREATED AS LOCAL VARS, BUT WILL BECOME STATE VARS IN THE <a name='209'></font>
<font color=#447700>!     FUTURE. SO, WE DECLARED THEM AS MEMORY SIZES FOR THE FUTURE USE<a name='210'></font>
<a name='211'>
<font color=#447700>!     TLATGS_PHY,TRAIN_PHY,APREC,PREC,ACPREC,SR are not directly related <a name='212'></font>
<font color=#447700>!     the microphysics scheme. Instead, they will be used by Eta precip <a name='213'></font>
<font color=#447700>!     assimilation.<a name='214'></font>
<a name='215'>
      REAL,  DIMENSION( ims:ime, kms:kme, jms:jme ) ::                  &amp;<a name='216'>
     &amp;       TLATGS_PHY,TRAIN_PHY<a name='217'>
      REAL,  DIMENSION(ims:ime,jms:jme):: APREC,PREC,ACPREC<a name='218'>
      REAL,  DIMENSION(its:ite, kts:kte, jts:jte):: t_phy<a name='219'>
<a name='220'>
      INTEGER :: I,J,K,KFLIP<a name='221'>
      REAL :: WC<a name='222'>
<font color=#447700>!<a name='223'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='224'></font>
<font color=#447700>!**********************************************************************<a name='225'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='226'></font>
<font color=#447700>!<a name='227'></font>
<font color=#447700>!HWRF      MY_GROWTH(MY_T1:MY_T2)=MP_RESTART_STATE(MY_T1:MY_T2)<a name='228'></font>
<font color=#447700>!HWRF!<a name='229'></font>
<font color=#447700>!HWRF      C1XPVS0=MP_RESTART_STATE(MY_T2+1)<a name='230'></font>
<font color=#447700>!HWRF      C2XPVS0=MP_RESTART_STATE(MY_T2+2)<a name='231'></font>
<font color=#447700>!HWRF      C1XPVS =MP_RESTART_STATE(MY_T2+3)<a name='232'></font>
<font color=#447700>!HWRF      C2XPVS =MP_RESTART_STATE(MY_T2+4)<a name='233'></font>
<font color=#447700>!HWRF      CIACW  =MP_RESTART_STATE(MY_T2+5)<a name='234'></font>
<font color=#447700>!HWRF      CIACR  =MP_RESTART_STATE(MY_T2+6)<a name='235'></font>
<font color=#447700>!HWRF      CRACW  =MP_RESTART_STATE(MY_T2+7)<a name='236'></font>
<font color=#447700>!HWRF      CRAUT  =MP_RESTART_STATE(MY_T2+8)<a name='237'></font>
<font color=#447700>!HWRF!<a name='238'></font>
<font color=#447700>!HWRF      TBPVS(1:NX) =TBPVS_STATE(1:NX)<a name='239'></font>
<font color=#447700>!HWRF      TBPVS0(1:NX)=TBPVS0_STATE(1:NX)<a name='240'></font>
<font color=#447700>!<a name='241'></font>
<font color=#447700>!----------<a name='242'></font>
<font color=#447700>!2015-03-30, recalculate some constants which may depend on phy time step<a name='243'></font>
          CALL <A href='../../html_code/phys/module_mp_HWRF.F.html#MY_GROWTH_RATES'>MY_GROWTH_RATES</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MY_GROWTH_RATES_2"> (DT)<a name='244'>
<a name='245'>
<font color=#447700>!--- CIACW is used in calculating riming rates<a name='246'></font>
<font color=#447700>!      The assumed effective collection efficiency of cloud water rimed onto<a name='247'></font>
<font color=#447700>!      ice is =0.5 below:<a name='248'></font>
<font color=#447700>!<a name='249'></font>
        CIACW=DT*0.25*PI_E*0.5*(1.E5)**C1<a name='250'>
<font color=#447700>!<a name='251'></font>
<font color=#447700>!--- CIACR is used in calculating freezing of rain colliding with large ice<a name='252'></font>
<font color=#447700>!      The assumed collection efficiency is 1.0<a name='253'></font>
<font color=#447700>!<a name='254'></font>
        CIACR=PI_E*DT<a name='255'>
<font color=#447700>!<a name='256'></font>
<font color=#447700>!--- CRACW is used in calculating collection of cloud water by rain (an<a name='257'></font>
<font color=#447700>!      assumed collection efficiency of 1.0)<a name='258'></font>
<font color=#447700>!<a name='259'></font>
        CRACW=DT*0.25*PI_E*1.0<a name='260'>
<font color=#447700>!<a name='261'></font>
<font color=#447700>!-- See comments in subroutine etanewhr_init starting with variable RDIS=<a name='262'></font>
<font color=#447700>!<a name='263'></font>
        BRAUT=DT*1.1E10*BETA6/NCW<a name='264'>
<a name='265'>
<font color=#447700>!       write(*,*)'dt=',dt<a name='266'></font>
<font color=#447700>!       write(*,*)'pi_e=',pi_e<a name='267'></font>
<font color=#447700>!       write(*,*)'ciacw=',ciacw <a name='268'></font>
<font color=#447700>!       write(*,*)'ciacr=',ciacr <a name='269'></font>
<font color=#447700>!       write(*,*)'cracw=',cracw <a name='270'></font>
<font color=#447700>!       write(*,*)'araut=',araut<a name='271'></font>
<font color=#447700>!       write(*,*)'braut=',braut<a name='272'></font>
<font color=#447700>!! END OF adding, 2015-03-30<a name='273'></font>
<font color=#447700>!-----------<a name='274'></font>
<a name='275'>
      DO j = jts,jte<a name='276'>
      DO k = kts,kte<a name='277'>
      DO i = its,ite<a name='278'>
        t_phy(i,k,j) = th_phy(i,k,j)*pi_phy(i,k,j)<a name='279'>
        qv(i,k,j)=qv(i,k,j)/(1.+qv(i,k,j)) <font color=#447700>!Convert to specific humidity<a name='280'></font>
      ENDDO<a name='281'>
      ENDDO<a name='282'>
      ENDDO<a name='283'>
<a name='284'>
<font color=#447700>!     initial diagnostic variables and data assimilation vars<a name='285'></font>
<font color=#447700>!     (will need to delete this part in the future)<a name='286'></font>
<a name='287'>
      DO k = 1,4<a name='288'>
      DO i = ITLO,ITHI<a name='289'>
         NSTATS(i,k)=0. <a name='290'>
      ENDDO<a name='291'>
      ENDDO<a name='292'>
<a name='293'>
      DO k = 1,5<a name='294'>
      DO i = ITLO,ITHI<a name='295'>
         QMAX(i,k)=0.<a name='296'>
      ENDDO<a name='297'>
      ENDDO<a name='298'>
<a name='299'>
      DO k = 1,22<a name='300'>
      DO i = ITLO,ITHI<a name='301'>
         QTOT(i,k)=0.<a name='302'>
      ENDDO<a name='303'>
      ENDDO<a name='304'>
<a name='305'>
<font color=#447700>! initial data assimilation vars (will need to delete this part in the future)<a name='306'></font>
<a name='307'>
      DO j = jts,jte<a name='308'>
      DO k = kts,kte<a name='309'>
      DO i = its,ite<a name='310'>
	 TLATGS_PHY (i,k,j)=0.<a name='311'>
	 TRAIN_PHY  (i,k,j)=0.<a name='312'>
      ENDDO<a name='313'>
      ENDDO<a name='314'>
      ENDDO<a name='315'>
<a name='316'>
      DO j = jts,jte<a name='317'>
      DO i = its,ite<a name='318'>
         ACPREC(i,j)=0.<a name='319'>
         APREC (i,j)=0.<a name='320'>
         PREC  (i,j)=0.<a name='321'>
         SR    (i,j)=0.<a name='322'>
      ENDDO<a name='323'>
      ENDDO<a name='324'>
<a name='325'>
<font color=#447700>!-- 6/11/2010: Update QT, F_ice, F_rain arrays<a name='326'></font>
      DO j = jts,jte<a name='327'>
      DO k = kts,kte<a name='328'>
      DO i = its,ite<a name='329'>
         QT(I,K,J)=QC(I,K,J)+QR(I,K,J)+QI(I,K,J)<a name='330'>
         IF (QI(I,K,J) &lt;= EPSQ) THEN<a name='331'>
            F_ICE_PHY(I,K,J)=0.<a name='332'>
            IF (T_PHY(I,K,J) &lt; T_ICEK) F_ICE_PHY(I,K,J)=1.<a name='333'>
         ELSE<a name='334'>
            F_ICE_PHY(I,K,J)=MAX( 0., MIN(1., QI(I,K,J)/QT(I,K,J) ) )<a name='335'>
         ENDIF<a name='336'>
         IF (QR(I,K,J) &lt;= EPSQ) THEN<a name='337'>
            F_RAIN_PHY(I,K,J)=0.<a name='338'>
         ELSE<a name='339'>
            F_RAIN_PHY(I,K,J)=QR(I,K,J)/(QR(I,K,J)+QC(I,K,J))<a name='340'>
         ENDIF<a name='341'>
      ENDDO<a name='342'>
      ENDDO<a name='343'>
      ENDDO<a name='344'>
<a name='345'>
<font color=#447700>!-----------------------------------------------------------------------<a name='346'></font>
<a name='347'>
      CALL <A href='../../html_code/phys/module_mp_HWRF.F.html#EGCP01DRV'>EGCP01DRV</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EGCP01DRV_2">(GID,DT,LOWLYR,                                     &amp;<a name='348'>
     &amp;               APREC,PREC,ACPREC,SR,NSTATS,QMAX,QTOT,	        &amp;<a name='349'>
     &amp;               dz8w,rho_phy,qt,t_phy,qv,F_ICE_PHY,P_PHY,          &amp;<a name='350'>
     &amp;               F_RAIN_PHY,F_RIMEF_PHY,TLATGS_PHY,TRAIN_PHY,       &amp;<a name='351'>
     &amp;               ids,ide, jds,jde, kds,kde,		                &amp;<a name='352'>
     &amp;               ims,ime, jms,jme, kms,kme,		                &amp;<a name='353'>
     &amp;               its,ite, jts,jte, kts,kte		          )<a name='354'>
<font color=#447700>!-----------------------------------------------------------------------<a name='355'></font>
<a name='356'>
     DO j = jts,jte<a name='357'>
        DO k = kts,kte<a name='358'>
	DO i = its,ite<a name='359'>
  	   th_phy(i,k,j) = t_phy(i,k,j)/pi_phy(i,k,j)<a name='360'>
           qv(i,k,j)=qv(i,k,j)/(1.-qv(i,k,j))  <font color=#447700>!Convert to mixing ratio<a name='361'></font>
           WC=qt(I,K,J)<a name='362'>
           QI(I,K,J)=0.<a name='363'>
           QR(I,K,J)=0.<a name='364'>
           QC(I,K,J)=0.<a name='365'>
           IF(F_ICE_PHY(I,K,J)&gt;=1.)THEN<a name='366'>
             QI(I,K,J)=WC<a name='367'>
           ELSEIF(F_ICE_PHY(I,K,J)&lt;=0.)THEN<a name='368'>
             QC(I,K,J)=WC<a name='369'>
           ELSE<a name='370'>
             QI(I,K,J)=F_ICE_PHY(I,K,J)*WC<a name='371'>
             QC(I,K,J)=WC-QI(I,K,J)<a name='372'>
           ENDIF<a name='373'>
<font color=#447700>!<a name='374'></font>
           IF(QC(I,K,J)&gt;0..AND.F_RAIN_PHY(I,K,J)&gt;0.)THEN<a name='375'>
             IF(F_RAIN_PHY(I,K,J).GE.1.)THEN<a name='376'>
               QR(I,K,J)=QC(I,K,J)<a name='377'>
               QC(I,K,J)=0.<a name='378'>
             ELSE<a name='379'>
               QR(I,K,J)=F_RAIN_PHY(I,K,J)*QC(I,K,J)<a name='380'>
               QC(I,K,J)=QC(I,K,J)-QR(I,K,J)<a name='381'>
             ENDIF<a name='382'>
          endif<a name='383'>
	ENDDO<a name='384'>
        ENDDO<a name='385'>
     ENDDO<a name='386'>
<font color=#447700>! <a name='387'></font>
<font color=#447700>! update rain (from m to mm)<a name='388'></font>
<a name='389'>
       DO j=jts,jte<a name='390'>
       DO i=its,ite<a name='391'>
          RAINNC(i,j)=APREC(i,j)*1000.+RAINNC(i,j)<a name='392'>
          RAINNCV(i,j)=APREC(i,j)*1000.<a name='393'>
       ENDDO<a name='394'>
       ENDDO<a name='395'>
<font color=#447700>!<a name='396'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T1:MY_T2)=MY_GROWTH(MY_T1:MY_T2)<a name='397'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+1)=C1XPVS0<a name='398'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+2)=C2XPVS0<a name='399'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+3)=C1XPVS<a name='400'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+4)=C2XPVS<a name='401'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+5)=CIACW<a name='402'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+6)=CIACR<a name='403'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+7)=CRACW<a name='404'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+8)=CRAUT<a name='405'></font>
<font color=#447700>!HWRF!<a name='406'></font>
<font color=#447700>!HWRF     TBPVS_STATE(1:NX) =TBPVS(1:NX)<a name='407'></font>
<font color=#447700>!HWRF     TBPVS0_STATE(1:NX)=TBPVS0(1:NX)<a name='408'></font>
<a name='409'>
<font color=#447700>!-----------------------------------------------------------------------<a name='410'></font>
<a name='411'>
  END SUBROUTINE FER_HIRES<a name='412'>
<a name='413'>
<font color=#447700>!-----------------------------------------------------------------------<a name='414'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='415'></font>
<font color=#447700>! NOTE: The only differences between FER_HIRES and FER_HIRES_ADVECT<a name='416'></font>
<font color=#447700>! is that the QT, and F_* are all local variables in the advected<a name='417'></font>
<font color=#447700>! version, and QRIMEF is only in the advected version.  The innards<a name='418'></font>
<font color=#447700>! are all the same.<a name='419'></font>
<A NAME='FER_HIRES_ADVECT'><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_ADVECT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='420'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>FER_HIRES_ADVECT</font> (itimestep,DT,DX,DY,GID,RAINNC,RAINNCV,    &amp; <font color=#447700>!GID <A href='../../call_to/FER_HIRES_ADVECT.html' TARGET='index'>1</A>,<A href='../../call_from/FER_HIRES_ADVECT.html' TARGET='index'>2</A><a name='421'></font>
     &amp;                      dz8w,rho_phy,p_phy,pi_phy,th_phy,qv,   &amp; <font color=#447700>!gopal's doing<a name='422'></font>
     &amp;                      LOWLYR,SR,                                &amp;<a name='423'>
     &amp;                      QC,QR,QI,QRIMEF,                          &amp;<a name='424'>
     &amp;                      ids,ide, jds,jde, kds,kde,                &amp;<a name='425'>
     &amp;                      ims,ime, jms,jme, kms,kme,                &amp;<a name='426'>
     &amp;                      its,ite, jts,jte, kts,kte                 )<a name='427'>
<font color=#447700>!HWRF      SUBROUTINE ETAMP_NEW (itimestep,DT,DX,DY,                         &amp;<a name='428'></font>
<font color=#447700>!HWRF     &amp;                      dz8w,rho_phy,p_phy,pi_phy,th_phy,qv,qc,     &amp;<a name='429'></font>
<font color=#447700>!HWRF     &amp;                      LOWLYR,SR,                                  &amp;<a name='430'></font>
<font color=#447700>!HWRF     &amp;                      F_ICE_PHY,F_RAIN_PHY,F_RIMEF_PHY,           &amp;<a name='431'></font>
<font color=#447700>!HWRF     &amp;                      mp_restart_state,tbpvs_state,tbpvs0_state,  &amp;<a name='432'></font>
<font color=#447700>!HWRF     &amp;                      RAINNC,RAINNCV,                             &amp;<a name='433'></font>
<font color=#447700>!HWRF     &amp;                      ids,ide, jds,jde, kds,kde,		        &amp;<a name='434'></font>
<font color=#447700>!HWRF     &amp;                      ims,ime, jms,jme, kms,kme,		        &amp;<a name='435'></font>
<font color=#447700>!HWRF     &amp;                      its,ite, jts,jte, kts,kte )<a name='436'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='437'></font>
      IMPLICIT NONE<a name='438'>
<font color=#447700>!-----------------------------------------------------------------------<a name='439'></font>
      INTEGER, PARAMETER :: ITLO=-60, ITHI=40<a name='440'>
<a name='441'>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='442'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='443'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE                     &amp;<a name='444'>
     &amp;                     ,ITIMESTEP,GID  <font color=#447700>! GID gopal's doing<a name='445'></font>
<a name='446'>
      REAL, INTENT(IN) 	    :: DT,DX,DY<a name='447'>
      REAL, INTENT(IN),     DIMENSION(ims:ime, kms:kme, jms:jme)::      &amp;<a name='448'>
     &amp;                      dz8w,p_phy,pi_phy,rho_phy<a name='449'>
      REAL, INTENT(INOUT),  DIMENSION(ims:ime, kms:kme, jms:jme)::      &amp;<a name='450'>
     &amp;                      th_phy,qv,qc,qr,qi,qrimef<a name='451'>
      REAL, INTENT(INOUT),  DIMENSION(ims:ime,jms:jme)           ::     &amp;<a name='452'>
     &amp;                                                   RAINNC,RAINNCV<a name='453'>
      REAL, INTENT(OUT),    DIMENSION(ims:ime,jms:jme):: SR<a name='454'>
<font color=#447700>!<a name='455'></font>
<font color=#447700>!HWRF      REAL,DIMENSION(*),INTENT(INOUT) :: MP_RESTART_STATE<a name='456'></font>
<font color=#447700>!<a name='457'></font>
<font color=#447700>!HWRF      REAL,DIMENSION(nx),INTENT(INOUT) :: TBPVS_STATE,TBPVS0_STATE<a name='458'></font>
<font color=#447700>!<a name='459'></font>
      INTEGER, DIMENSION( ims:ime, jms:jme ),INTENT(INOUT) :: LOWLYR<a name='460'>
<a name='461'>
<font color=#447700>!-----------------------------------------------------------------------<a name='462'></font>
<font color=#447700>!     LOCAL VARS<a name='463'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='464'></font>
<a name='465'>
      REAL,                 DIMENSION(ims:ime, kms:kme, jms:jme ) ::    &amp;<a name='466'>
     &amp;                      F_ICE_PHY,F_RAIN_PHY,F_RIMEF_PHY, QT<a name='467'>
<font color=#447700>!     NSTATS,QMAX,QTOT are diagnostic vars<a name='468'></font>
<a name='469'>
      INTEGER,DIMENSION(ITLO:ITHI,4) :: NSTATS<a name='470'>
      REAL,   DIMENSION(ITLO:ITHI,5) :: QMAX<a name='471'>
      REAL,   DIMENSION(ITLO:ITHI,22):: QTOT<a name='472'>
<a name='473'>
<font color=#447700>!     SOME VARS WILL BE USED FOR DATA ASSIMILATION (DON'T NEED THEM NOW). <a name='474'></font>
<font color=#447700>!     THEY ARE TREATED AS LOCAL VARS, BUT WILL BECOME STATE VARS IN THE <a name='475'></font>
<font color=#447700>!     FUTURE. SO, WE DECLARED THEM AS MEMORY SIZES FOR THE FUTURE USE<a name='476'></font>
<a name='477'>
<font color=#447700>!     TLATGS_PHY,TRAIN_PHY,APREC,PREC,ACPREC,SR are not directly related <a name='478'></font>
<font color=#447700>!     the microphysics scheme. Instead, they will be used by Eta precip <a name='479'></font>
<font color=#447700>!     assimilation.<a name='480'></font>
<a name='481'>
      REAL,  DIMENSION( ims:ime, kms:kme, jms:jme ) ::                  &amp;<a name='482'>
     &amp;       TLATGS_PHY,TRAIN_PHY<a name='483'>
      REAL,  DIMENSION(ims:ime,jms:jme):: APREC,PREC,ACPREC<a name='484'>
      REAL,  DIMENSION(its:ite, kts:kte, jts:jte):: t_phy<a name='485'>
<a name='486'>
      INTEGER :: I,J,K,KFLIP<a name='487'>
      REAL :: WC<a name='488'>
<font color=#447700>!<a name='489'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='490'></font>
<font color=#447700>!**********************************************************************<a name='491'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='492'></font>
<font color=#447700>!<a name='493'></font>
<font color=#447700>!HWRF      MY_GROWTH(MY_T1:MY_T2)=MP_RESTART_STATE(MY_T1:MY_T2)<a name='494'></font>
<font color=#447700>!HWRF!<a name='495'></font>
<font color=#447700>!HWRF      C1XPVS0=MP_RESTART_STATE(MY_T2+1)<a name='496'></font>
<font color=#447700>!HWRF      C2XPVS0=MP_RESTART_STATE(MY_T2+2)<a name='497'></font>
<font color=#447700>!HWRF      C1XPVS =MP_RESTART_STATE(MY_T2+3)<a name='498'></font>
<font color=#447700>!HWRF      C2XPVS =MP_RESTART_STATE(MY_T2+4)<a name='499'></font>
<font color=#447700>!HWRF      CIACW  =MP_RESTART_STATE(MY_T2+5)<a name='500'></font>
<font color=#447700>!HWRF      CIACR  =MP_RESTART_STATE(MY_T2+6)<a name='501'></font>
<font color=#447700>!HWRF      CRACW  =MP_RESTART_STATE(MY_T2+7)<a name='502'></font>
<font color=#447700>!HWRF      CRAUT  =MP_RESTART_STATE(MY_T2+8)<a name='503'></font>
<font color=#447700>!HWRF!<a name='504'></font>
<font color=#447700>!HWRF      TBPVS(1:NX) =TBPVS_STATE(1:NX)<a name='505'></font>
<font color=#447700>!HWRF      TBPVS0(1:NX)=TBPVS0_STATE(1:NX)<a name='506'></font>
<font color=#447700>!<a name='507'></font>
<font color=#447700>!----------<a name='508'></font>
<font color=#447700>!2015-03-30, recalculate some constants which may depend on phy time step<a name='509'></font>
          CALL <A href='../../html_code/phys/module_mp_HWRF.F.html#MY_GROWTH_RATES'>MY_GROWTH_RATES</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_ADVECT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MY_GROWTH_RATES_3"> (DT)<a name='510'>
<a name='511'>
<font color=#447700>!--- CIACW is used in calculating riming rates<a name='512'></font>
<font color=#447700>!      The assumed effective collection efficiency of cloud water rimed onto<a name='513'></font>
<font color=#447700>!      ice is =0.5 below:<a name='514'></font>
<font color=#447700>!<a name='515'></font>
        CIACW=DT*0.25*PI_E*0.5*(1.E5)**C1<a name='516'>
<font color=#447700>!<a name='517'></font>
<font color=#447700>!--- CIACR is used in calculating freezing of rain colliding with large ice<a name='518'></font>
<font color=#447700>!      The assumed collection efficiency is 1.0<a name='519'></font>
<font color=#447700>!<a name='520'></font>
        CIACR=PI_E*DT<a name='521'>
<font color=#447700>!<a name='522'></font>
<font color=#447700>!--- CRACW is used in calculating collection of cloud water by rain (an<a name='523'></font>
<font color=#447700>!      assumed collection efficiency of 1.0)<a name='524'></font>
<font color=#447700>!<a name='525'></font>
        CRACW=DT*0.25*PI_E*1.0<a name='526'>
<font color=#447700>!<a name='527'></font>
<font color=#447700>!-- See comments in subroutine etanewhr_init starting with variable RDIS=<a name='528'></font>
<font color=#447700>!<a name='529'></font>
        BRAUT=DT*1.1E10*BETA6/NCW<a name='530'>
<a name='531'>
<font color=#447700>!       write(*,*)'dt=',dt<a name='532'></font>
<font color=#447700>!       write(*,*)'pi_e=',pi_e<a name='533'></font>
<font color=#447700>!       write(*,*)'ciacw=',ciacw <a name='534'></font>
<font color=#447700>!       write(*,*)'ciacr=',ciacr <a name='535'></font>
<font color=#447700>!       write(*,*)'cracw=',cracw <a name='536'></font>
<font color=#447700>!       write(*,*)'araut=',araut<a name='537'></font>
<font color=#447700>!       write(*,*)'braut=',braut<a name='538'></font>
<font color=#447700>!! END OF adding, 2015-03-30<a name='539'></font>
<font color=#447700>!-----------<a name='540'></font>
<a name='541'>
      DO j = jts,jte<a name='542'>
      DO k = kts,kte<a name='543'>
      DO i = its,ite<a name='544'>
        t_phy(i,k,j) = th_phy(i,k,j)*pi_phy(i,k,j)<a name='545'>
        qv(i,k,j)=qv(i,k,j)/(1.+qv(i,k,j)) <font color=#447700>!Convert to specific humidity<a name='546'></font>
      ENDDO<a name='547'>
      ENDDO<a name='548'>
      ENDDO<a name='549'>
<a name='550'>
<font color=#447700>!     initial diagnostic variables and data assimilation vars<a name='551'></font>
<font color=#447700>!     (will need to delete this part in the future)<a name='552'></font>
<a name='553'>
      DO k = 1,4<a name='554'>
      DO i = ITLO,ITHI<a name='555'>
         NSTATS(i,k)=0. <a name='556'>
      ENDDO<a name='557'>
      ENDDO<a name='558'>
<a name='559'>
      DO k = 1,5<a name='560'>
      DO i = ITLO,ITHI<a name='561'>
         QMAX(i,k)=0.<a name='562'>
      ENDDO<a name='563'>
      ENDDO<a name='564'>
<a name='565'>
      DO k = 1,22<a name='566'>
      DO i = ITLO,ITHI<a name='567'>
         QTOT(i,k)=0.<a name='568'>
      ENDDO<a name='569'>
      ENDDO<a name='570'>
<a name='571'>
<font color=#447700>! initial data assimilation vars (will need to delete this part in the future)<a name='572'></font>
<a name='573'>
      DO j = jts,jte<a name='574'>
      DO k = kts,kte<a name='575'>
      DO i = its,ite<a name='576'>
	 TLATGS_PHY (i,k,j)=0.<a name='577'>
	 TRAIN_PHY  (i,k,j)=0.<a name='578'>
      ENDDO<a name='579'>
      ENDDO<a name='580'>
      ENDDO<a name='581'>
<a name='582'>
      DO j = jts,jte<a name='583'>
      DO i = its,ite<a name='584'>
         ACPREC(i,j)=0.<a name='585'>
         APREC (i,j)=0.<a name='586'>
         PREC  (i,j)=0.<a name='587'>
         SR    (i,j)=0.<a name='588'>
      ENDDO<a name='589'>
      ENDDO<a name='590'>
<a name='591'>
<font color=#447700>!-- 6/11/2010: Update QT, F_ice, F_rain arrays<a name='592'></font>
<a name='593'>
      DO j = jts,jte<a name='594'>
      DO k = kts,kte<a name='595'>
      DO i = its,ite<a name='596'>
         QT(I,K,J)=QC(I,K,J)+QR(I,K,J)+QI(I,K,J)<a name='597'>
         IF (QI(I,K,J) &lt;= EPSQ) THEN<a name='598'>
            F_ICE_PHY(I,K,J)=0.<a name='599'>
            F_RIMEF_PHY(I,K,J)=1.<a name='600'>
            IF (T_PHY(I,K,J) &lt; T_ICEK) F_ICE_PHY(I,K,J)=1.<a name='601'>
         ELSE<a name='602'>
            F_ICE_PHY(I,K,J)=MAX( 0., MIN(1., QI(I,K,J)/QT(I,K,J) ) )<a name='603'>
            F_RIMEF_PHY(I,K,J)=QRIMEF(I,K,J)/QI(I,K,J)<a name='604'>
         ENDIF<a name='605'>
         IF (QR(I,K,J) &lt;= EPSQ) THEN<a name='606'>
            F_RAIN_PHY(I,K,J)=0.<a name='607'>
         ELSE<a name='608'>
            F_RAIN_PHY(I,K,J)=QR(I,K,J)/(QR(I,K,J)+QC(I,K,J))<a name='609'>
         ENDIF<a name='610'>
      ENDDO<a name='611'>
      ENDDO<a name='612'>
      ENDDO<a name='613'>
<a name='614'>
<font color=#447700>!-----------------------------------------------------------------------<a name='615'></font>
<a name='616'>
      CALL <A href='../../html_code/phys/module_mp_HWRF.F.html#EGCP01DRV'>EGCP01DRV</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_ADVECT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EGCP01DRV_3">(GID,DT,LOWLYR,                                     &amp;<a name='617'>
     &amp;               APREC,PREC,ACPREC,SR,NSTATS,QMAX,QTOT,	        &amp;<a name='618'>
     &amp;               dz8w,rho_phy,qt,t_phy,qv,F_ICE_PHY,P_PHY,          &amp;<a name='619'>
     &amp;               F_RAIN_PHY,F_RIMEF_PHY,TLATGS_PHY,TRAIN_PHY,       &amp;<a name='620'>
     &amp;               ids,ide, jds,jde, kds,kde,		                &amp;<a name='621'>
     &amp;               ims,ime, jms,jme, kms,kme,		                &amp;<a name='622'>
     &amp;               its,ite, jts,jte, kts,kte		          )<a name='623'>
<font color=#447700>!-----------------------------------------------------------------------<a name='624'></font>
<a name='625'>
     DO j = jts,jte<a name='626'>
        DO k = kts,kte<a name='627'>
	DO i = its,ite<a name='628'>
  	   th_phy(i,k,j) = t_phy(i,k,j)/pi_phy(i,k,j)<a name='629'>
           qv(i,k,j)=qv(i,k,j)/(1.-qv(i,k,j))  <font color=#447700>!Convert to mixing ratio<a name='630'></font>
           WC=qt(I,K,J)<a name='631'>
           QI(I,K,J)=0.<a name='632'>
           QR(I,K,J)=0.<a name='633'>
           QC(I,K,J)=0.<a name='634'>
           IF(F_ICE_PHY(I,K,J)&gt;=1.)THEN<a name='635'>
             QI(I,K,J)=WC<a name='636'>
           ELSEIF(F_ICE_PHY(I,K,J)&lt;=0.)THEN<a name='637'>
             QC(I,K,J)=WC<a name='638'>
           ELSE<a name='639'>
             QI(I,K,J)=F_ICE_PHY(I,K,J)*WC<a name='640'>
             QC(I,K,J)=WC-QI(I,K,J)<a name='641'>
           ENDIF<a name='642'>
<font color=#447700>!<a name='643'></font>
           IF(QC(I,K,J)&gt;0..AND.F_RAIN_PHY(I,K,J)&gt;0.)THEN<a name='644'>
             IF(F_RAIN_PHY(I,K,J).GE.1.)THEN<a name='645'>
               QR(I,K,J)=QC(I,K,J)<a name='646'>
               QC(I,K,J)=0.<a name='647'>
             ELSE<a name='648'>
               QR(I,K,J)=F_RAIN_PHY(I,K,J)*QC(I,K,J)<a name='649'>
               QC(I,K,J)=QC(I,K,J)-QR(I,K,J)<a name='650'>
             ENDIF<a name='651'>
          endif<a name='652'>
          QRIMEF(I,K,J)=QI(I,K,J)*F_RIMEF_PHY(I,K,J)<a name='653'>
	ENDDO<a name='654'>
        ENDDO<a name='655'>
     ENDDO<a name='656'>
<font color=#447700>! <a name='657'></font>
<font color=#447700>! update rain (from m to mm)<a name='658'></font>
<a name='659'>
       DO j=jts,jte<a name='660'>
       DO i=its,ite<a name='661'>
          RAINNC(i,j)=APREC(i,j)*1000.+RAINNC(i,j)<a name='662'>
          RAINNCV(i,j)=APREC(i,j)*1000.<a name='663'>
       ENDDO<a name='664'>
       ENDDO<a name='665'>
<font color=#447700>!<a name='666'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T1:MY_T2)=MY_GROWTH(MY_T1:MY_T2)<a name='667'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+1)=C1XPVS0<a name='668'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+2)=C2XPVS0<a name='669'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+3)=C1XPVS<a name='670'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+4)=C2XPVS<a name='671'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+5)=CIACW<a name='672'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+6)=CIACR<a name='673'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+7)=CRACW<a name='674'></font>
<font color=#447700>!HWRF     MP_RESTART_STATE(MY_T2+8)=CRAUT<a name='675'></font>
<font color=#447700>!HWRF!<a name='676'></font>
<font color=#447700>!HWRF     TBPVS_STATE(1:NX) =TBPVS(1:NX)<a name='677'></font>
<font color=#447700>!HWRF     TBPVS0_STATE(1:NX)=TBPVS0(1:NX)<a name='678'></font>
<a name='679'>
<font color=#447700>!-----------------------------------------------------------------------<a name='680'></font>
<a name='681'>
  END SUBROUTINE FER_HIRES_ADVECT<a name='682'>
<a name='683'>
<font color=#447700>!-----------------------------------------------------------------------<a name='684'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='685'></font>
<a name='686'>
<A NAME='EGCP01DRV'><A href='../../html_code/phys/module_mp_fer_hires.F.html#EGCP01DRV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='687'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>EGCP01DRV</font>(GID,                            &amp; <font color=#447700>!GID gopal's doing <A href='../../call_to/EGCP01DRV.html' TARGET='index'>4</A>,<A href='../../call_from/EGCP01DRV.html' TARGET='index'>3</A><a name='688'></font>
     &amp;  DTPH,LOWLYR,APREC,PREC,ACPREC,SR,                  &amp;<a name='689'>
     &amp;  NSTATS,QMAX,QTOT,                                  &amp;<a name='690'>
     &amp;  dz8w,RHO_PHY,CWM_PHY,T_PHY,Q_PHY,F_ICE_PHY,P_PHY,  &amp;<a name='691'>
     &amp;  F_RAIN_PHY,F_RIMEF_PHY,TLATGS_PHY,TRAIN_PHY,       &amp;<a name='692'>
     &amp;  ids,ide, jds,jde, kds,kde,                         &amp;<a name='693'>
     &amp;  ims,ime, jms,jme, kms,kme,                         &amp;<a name='694'>
     &amp;  its,ite, jts,jte, kts,kte)<a name='695'>
<font color=#447700>!-----------------------------------------------------------------------<a name='696'></font>
<font color=#447700>! DTPH           Physics time step (s)<a name='697'></font>
<font color=#447700>! CWM_PHY (qt)   Mixing ratio of the total condensate. kg/kg<a name='698'></font>
<font color=#447700>! Q_PHY          Mixing ratio of water vapor. kg/kg<a name='699'></font>
<font color=#447700>! F_RAIN_PHY     Fraction of rain. <a name='700'></font>
<font color=#447700>! F_ICE_PHY      Fraction of ice.<a name='701'></font>
<font color=#447700>! F_RIMEF_PHY    Mass ratio of rimed ice (rime factor).<a name='702'></font>
<font color=#447700>!<a name='703'></font>
<font color=#447700>!TLATGS_PHY,TRAIN_PHY,APREC,PREC,ACPREC,SR are not directly related the<a name='704'></font>
<font color=#447700>!micrphysics sechme. Instead, they will be used by Eta precip assimilation.<a name='705'></font>
<font color=#447700>!<a name='706'></font>
<font color=#447700>!NSTATS,QMAX,QTOT are used for diagnosis purposes.<a name='707'></font>
<font color=#447700>!<a name='708'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='709'></font>
<font color=#447700>!--- Variables APREC,PREC,ACPREC,SR are calculated for precip assimilation<a name='710'></font>
<font color=#447700>!    and/or ZHAO's scheme in Eta and are not required by this microphysics <a name='711'></font>
<font color=#447700>!    scheme itself.  <a name='712'></font>
<font color=#447700>!--- NSTATS,QMAX,QTOT are used for diagnosis purposes only.  They will be <a name='713'></font>
<font color=#447700>!    printed out when PRINT_diag is true.<a name='714'></font>
<font color=#447700>!<a name='715'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='716'></font>
      IMPLICIT NONE<a name='717'>
<font color=#447700>!-----------------------------------------------------------------------<a name='718'></font>
<font color=#447700>!<a name='719'></font>
      INTEGER, PARAMETER :: ITLO=-60, ITHI=40<a name='720'>
<font color=#447700>!     VARIABLES PASSED IN/OUT<a name='721'></font>
      INTEGER,INTENT(IN ) :: ids,ide, jds,jde, kds,kde                  &amp;<a name='722'>
     &amp;                      ,ims,ime, jms,jme, kms,kme                  &amp;<a name='723'>
     &amp;                      ,its,ite, jts,jte, kts,kte<a name='724'>
      INTEGER,INTENT(IN ) :: GID     <font color=#447700>! grid%id gopal's doing<a name='725'></font>
      REAL,INTENT(IN) :: DTPH<a name='726'>
      INTEGER, DIMENSION( ims:ime, jms:jme ),INTENT(INOUT) :: LOWLYR<a name='727'>
      INTEGER,DIMENSION(ITLO:ITHI,4),INTENT(INOUT) :: NSTATS<a name='728'>
      REAL,DIMENSION(ITLO:ITHI,5),INTENT(INOUT) :: QMAX<a name='729'>
      REAL,DIMENSION(ITLO:ITHI,22),INTENT(INOUT) :: QTOT<a name='730'>
      REAL,DIMENSION(ims:ime,jms:jme),INTENT(INOUT) ::                  &amp;<a name='731'>
     &amp;                         APREC,PREC,ACPREC,SR<a name='732'>
      REAL,DIMENSION( its:ite, kts:kte, jts:jte ),INTENT(INOUT) :: t_phy<a name='733'>
      REAL,DIMENSION( ims:ime, kms:kme, jms:jme ),INTENT(IN) ::         &amp;<a name='734'>
     &amp;                                             dz8w,P_PHY,RHO_PHY<a name='735'>
      REAL,DIMENSION( ims:ime, kms:kme, jms:jme ),INTENT(INOUT) ::      &amp;<a name='736'>
     &amp;   CWM_PHY, F_ICE_PHY,F_RAIN_PHY,F_RIMEF_PHY,TLATGS_PHY           &amp;<a name='737'>
     &amp;   ,Q_PHY,TRAIN_PHY<a name='738'>
<font color=#447700>!<a name='739'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='740'></font>
<font color=#447700>!LOCAL VARIABLES<a name='741'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='742'></font>
<font color=#447700>!<a name='743'></font>
<font color=#447700>!HWRF - Below are directives in the operational code that have been removed,<a name='744'></font>
<font color=#447700>!       where "TEMP_DEX" has been replaced with "I,J,L" and "TEMP_DIMS" has<a name='745'></font>
<font color=#447700>!       been replaced with "its:ite,jts:jte,kts:kte"<a name='746'></font>
<font color=#447700>!HWRF#define CACHE_FRIENDLY_MP_ETANEW<a name='747'></font>
<font color=#447700>!HWRF#ifdef CACHE_FRIENDLY_MP_ETANEW<a name='748'></font>
<font color=#447700>!HWRF#  define TEMP_DIMS  kts:kte,its:ite,jts:jte<a name='749'></font>
<font color=#447700>!HWRF#  define TEMP_DEX   L,I,J<a name='750'></font>
<font color=#447700>!HWRF#else<a name='751'></font>
<font color=#447700>!HWRF#  define TEMP_DIMS  its:ite,jts:jte,kts:kte<a name='752'></font>
<font color=#447700>!HWRF#  define TEMP_DEX   I,J,L<a name='753'></font>
<font color=#447700>!HWRF#endif<a name='754'></font>
<font color=#447700>!HWRF!<a name='755'></font>
      INTEGER :: LSFC,I,J,I_index,J_index,L,K,KFLIP<a name='756'>
<font color=#447700>!HWRF      REAL,DIMENSION(TEMP_DIMS) :: CWM,T,Q,TRAIN,TLATGS,P<a name='757'></font>
      REAL,DIMENSION(its:ite,jts:jte,kts:kte) ::                        &amp;<a name='758'>
     &amp;   CWM,T,Q,TRAIN,TLATGS,P<a name='759'>
      REAL,DIMENSION(kts:kte,its:ite,jts:jte) :: F_ice,F_rain,F_RimeF       <a name='760'>
      INTEGER,DIMENSION(its:ite,jts:jte) :: LMH<a name='761'>
      REAL :: TC,WC,QI,QR,QW,Fice,Frain,DUM,ASNOW,ARAIN<a name='762'>
      REAL,DIMENSION(kts:kte) :: P_col,Q_col,T_col,QV_col,WC_col,       &amp;<a name='763'>
         RimeF_col,QI_col,QR_col,QW_col, THICK_col, RHC_col, DPCOL    <font color=#447700>!GFDL<a name='764'></font>
      REAL,DIMENSION(2) :: PRECtot,PRECmax<a name='765'>
<font color=#447700>!-----------------------------------------------------------------------<a name='766'></font>
<font color=#447700>!<a name='767'></font>
        DO J=JTS,JTE    <a name='768'>
        DO I=ITS,ITE  <a name='769'>
           LMH(I,J) = KTE-LOWLYR(I,J)+1<a name='770'>
        ENDDO<a name='771'>
        ENDDO<a name='772'>
<a name='773'>
<a name='774'>
        DO 98  J=JTS,JTE    <a name='775'>
        DO 98  I=ITS,ITE  <a name='776'>
           DO L=KTS,KTE<a name='777'>
             KFLIP=KTE+1-L<a name='778'>
             CWM(I,J,L)=CWM_PHY(I,KFLIP,J)<a name='779'>
             T(I,J,L)=T_PHY(I,KFLIP,J)<a name='780'>
             Q(I,J,L)=Q_PHY(I,KFLIP,J)<a name='781'>
             P(I,J,L)=P_PHY(I,KFLIP,J)<a name='782'>
             TLATGS(I,J,L)=TLATGS_PHY(I,KFLIP,J)<a name='783'>
             TRAIN(I,J,L)=TRAIN_PHY(I,KFLIP,J)<a name='784'>
             F_ice(L,I,J)=F_ice_PHY(I,KFLIP,J)<a name='785'>
             F_rain(L,I,J)=F_rain_PHY(I,KFLIP,J)<a name='786'>
             F_RimeF(L,I,J)=F_RimeF_PHY(I,KFLIP,J)<a name='787'>
           ENDDO<a name='788'>
98      CONTINUE<a name='789'>
     <a name='790'>
       DO 100 J=JTS,JTE    <a name='791'>
        DO 100 I=ITS,ITE  <a name='792'>
          LSFC=LMH(I,J)                      <font color=#447700>! "L" of surface<a name='793'></font>
<font color=#447700>!<a name='794'></font>
          DO K=KTS,KTE<a name='795'>
            KFLIP=KTE+1-K<a name='796'>
            DPCOL(K)=RHO_PHY(I,KFLIP,J)*GRAV*dz8w(I,KFLIP,J)<a name='797'>
          ENDDO<a name='798'>
<font color=#447700>!   <a name='799'></font>
   <font color=#447700>!<a name='800'></font>
   <font color=#447700>!--- Initialize column data (1D arrays)<a name='801'></font>
   <font color=#447700>!<a name='802'></font>
          IF (CWM(I,J,1) .LE. EPSQ) CWM(I,J,1)=EPSQ<a name='803'>
          F_ice(1,I,J)=1.<a name='804'>
          F_rain(1,I,J)=0.<a name='805'>
          F_RimeF(1,I,J)=1.<a name='806'>
          DO L=1,LSFC<a name='807'>
      <font color=#447700>!<a name='808'></font>
      <font color=#447700>!--- Pressure (Pa) = (Psfc-Ptop)*(ETA/ETA_sfc)+Ptop<a name='809'></font>
      <font color=#447700>!<a name='810'></font>
            P_col(L)=P(I,J,L)<a name='811'>
      <font color=#447700>!<a name='812'></font>
      <font color=#447700>!--- Layer thickness = RHO*DZ = -DP/G = (Psfc-Ptop)*D_ETA/(G*ETA_sfc)<a name='813'></font>
      <font color=#447700>!<a name='814'></font>
            THICK_col(L)=DPCOL(L)*RGRAV<a name='815'>
            T_col(L)=T(I,J,L)<a name='816'>
            TC=T_col(L)-T0C<a name='817'>
            QV_col(L)=max(EPSQ, Q(I,J,L))<a name='818'>
            IF (CWM(I,J,L) .LE. EPSQ1) THEN<a name='819'>
              WC_col(L)=0.<a name='820'>
              IF (TC .LT. T_ICE) THEN<a name='821'>
                F_ice(L,I,J)=1.<a name='822'>
              ELSE<a name='823'>
                F_ice(L,I,J)=0.<a name='824'>
              ENDIF<a name='825'>
              F_rain(L,I,J)=0.<a name='826'>
              F_RimeF(L,I,J)=1.<a name='827'>
            ELSE<a name='828'>
              WC_col(L)=CWM(I,J,L)<a name='829'>
<a name='830'>
<font color=#447700>!-- Debug 20120111:  TC==TC will fail if NaN<a name='831'></font>
IF (WC_col(L)&gt;QTwarn .AND. P_col(L)&lt;Pwarn .AND. TC==TC) THEN<a name='832'>
   WRITE(0,*) 'WARN4: &gt;1 g/kg condensate in stratosphere; I,J,L,TC,P,QT=',   &amp;<a name='833'>
              I,J,L,TC,.01*P_col(L),1000.*WC_col(L)<a name='834'>
   QTwarn=MAX(WC_col(L),10.*QTwarn)<a name='835'>
   Pwarn=MIN(P_col(L),0.5*Pwarn)<a name='836'>
ENDIF<a name='837'>
<font color=#447700>!-- TC/=TC will pass if TC is NaN<a name='838'></font>
IF (WARN5 .AND. TC/=TC) THEN<a name='839'>
   WRITE(0,*) 'WARN5: NaN temperature; I,J,L,P=',I,J,L,.01*P_col(L)<a name='840'>
   WARN5=.FALSE.<a name='841'>
ENDIF<a name='842'>
<a name='843'>
            ENDIF<a name='844'>
      <font color=#447700>!<a name='845'></font>
      <font color=#447700>!--- Determine composition of condensate in terms of <a name='846'></font>
      <font color=#447700>!      cloud water, ice, &amp; rain<a name='847'></font>
      <font color=#447700>!<a name='848'></font>
            WC=WC_col(L)<a name='849'>
            QI=0.<a name='850'>
            QR=0.<a name='851'>
            QW=0.<a name='852'>
            Fice=F_ice(L,I,J)<a name='853'>
            Frain=F_rain(L,I,J)<a name='854'>
            IF (Fice .GE. 1.) THEN<a name='855'>
              QI=WC<a name='856'>
            ELSE IF (Fice .LE. 0.) THEN<a name='857'>
              QW=WC<a name='858'>
            ELSE<a name='859'>
              QI=Fice*WC<a name='860'>
              QW=WC-QI<a name='861'>
            ENDIF<a name='862'>
            IF (QW.GT.0. .AND. Frain.GT.0.) THEN<a name='863'>
              IF (Frain .GE. 1.) THEN<a name='864'>
                QR=QW<a name='865'>
                QW=0.<a name='866'>
              ELSE<a name='867'>
                QR=Frain*QW<a name='868'>
                QW=QW-QR<a name='869'>
              ENDIF<a name='870'>
            ENDIF<a name='871'>
            IF (QI .LE. 0.) F_RimeF(L,I,J)=1.<a name='872'>
            RimeF_col(L)=F_RimeF(L,I,J)<a name='873'>
            QI_col(L)=QI<a name='874'>
            QR_col(L)=QR<a name='875'>
            QW_col(L)=QW<a name='876'>
<font color=#447700>!GFDL =&gt; New.  Added RHC_col to allow for height- and grid-dependent values for<a name='877'></font>
<font color=#447700>!GFDL          the relative humidity threshold for condensation ("RHgrd")<a name='878'></font>
<font color=#447700>!6/11/2010 mod - Use lower RHgrd_out threshold for &lt; 850 hPa<a name='879'></font>
<font color=#447700>!------------------------------------------------------------<a name='880'></font>
            IF(GID .EQ. 1 .AND. P_col(L)&lt;P_RHgrd_out) THEN  <font color=#447700>! gopal's doing based on GFDL<a name='881'></font>
              RHC_col(L)=RHgrd_out        <a name='882'>
            ELSE<a name='883'>
              RHC_col(L)=RHgrd_in       <a name='884'>
            ENDIF<a name='885'>
<font color=#447700>!------------------------------------------------------------<a name='886'></font>
          ENDDO<a name='887'>
<font color=#447700>!<a name='888'></font>
<font color=#447700>!#######################################################################<a name='889'></font>
   <font color=#447700>!<a name='890'></font>
   <font color=#447700>!--- Perform the microphysical calculations in this column<a name='891'></font>
   <font color=#447700>!<a name='892'></font>
          I_index=I<a name='893'>
          J_index=J<a name='894'>
       CALL <A href='../../html_code/phys/module_mp_HWRF.F.html#EGCP01COLUMN'>EGCP01COLUMN</A><A href='../../html_code/phys/module_mp_HWRF.F.html#EGCP01DRV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EGCP01COLUMN_2"> ( ARAIN, ASNOW, DTPH, I_index, J_index, LSFC,  &amp;<a name='895'>
     &amp; P_col, QI_col, QR_col, QV_col, QW_col, RimeF_col, T_col,         &amp;<a name='896'>
     &amp; THICK_col, WC_col, RHC_col, KTS,KTE,NSTATS,QMAX,QTOT )   <font color=#447700>!GFDL<a name='897'></font>
<a name='898'>
<a name='899'>
   <font color=#447700>!<a name='900'></font>
<font color=#447700>!#######################################################################<a name='901'></font>
<font color=#447700>!<a name='902'></font>
   <font color=#447700>!<a name='903'></font>
   <font color=#447700>!--- Update storage arrays<a name='904'></font>
   <font color=#447700>!<a name='905'></font>
          DO L=1,LSFC<a name='906'>
            TRAIN(I,J,L)=(T_col(L)-T(I,J,L))/DTPH<a name='907'>
            TLATGS(I,J,L)=T_col(L)-T(I,J,L)<a name='908'>
            T(I,J,L)=T_col(L)<a name='909'>
            Q(I,J,L)=QV_col(L)<a name='910'>
            CWM(I,J,L)=WC_col(L)<a name='911'>
      <font color=#447700>!<a name='912'></font>
      <font color=#447700>!--- REAL*4 array storage<a name='913'></font>
      <font color=#447700>!<a name='914'></font>
            IF (QI_col(L) .LE. EPSQ) THEN<a name='915'>
              F_ice(L,I,J)=0.<a name='916'>
              IF (T_col(L) .LT. T_ICEK) F_ice(L,I,J)=1.<a name='917'>
              F_RimeF(L,I,J)=1.<a name='918'>
            ELSE<a name='919'>
              F_ice(L,I,J)=MAX( 0., MIN(1., QI_col(L)/WC_col(L)) )<a name='920'>
              F_RimeF(L,I,J)=MAX(1., RimeF_col(L))<a name='921'>
            ENDIF<a name='922'>
            IF (QR_col(L) .LE. EPSQ) THEN<a name='923'>
              DUM=0<a name='924'>
            ELSE<a name='925'>
              DUM=QR_col(L)/(QR_col(L)+QW_col(L))<a name='926'>
            ENDIF<a name='927'>
            F_rain(L,I,J)=DUM<a name='928'>
      <font color=#447700>!<a name='929'></font>
          ENDDO<a name='930'>
   <font color=#447700>!<a name='931'></font>
   <font color=#447700>!--- Update accumulated precipitation statistics<a name='932'></font>
   <font color=#447700>!<a name='933'></font>
   <font color=#447700>!--- Surface precipitation statistics; SR is fraction of surface <a name='934'></font>
   <font color=#447700>!    precipitation (if &gt;0) associated with snow<a name='935'></font>
   <font color=#447700>!<a name='936'></font>
        APREC(I,J)=(ARAIN+ASNOW)*RRHOL       <font color=#447700>! Accumulated surface precip (depth in m)  !&lt;--- Ying<a name='937'></font>
        PREC(I,J)=PREC(I,J)+APREC(I,J)<a name='938'>
        ACPREC(I,J)=ACPREC(I,J)+APREC(I,J)<a name='939'>
        IF(APREC(I,J) .LT. 1.E-8) THEN<a name='940'>
          SR(I,J)=0.<a name='941'>
        ELSE<a name='942'>
          SR(I,J)=RRHOL*ASNOW/APREC(I,J)<a name='943'>
        ENDIF<a name='944'>
<font color=#447700>!   !<a name='945'></font>
<font color=#447700>!   !--- Debug statistics <a name='946'></font>
<font color=#447700>!   !<a name='947'></font>
<font color=#447700>!        IF (PRINT_diag) THEN<a name='948'></font>
<font color=#447700>!          PRECtot(1)=PRECtot(1)+ARAIN<a name='949'></font>
<font color=#447700>!          PRECtot(2)=PRECtot(2)+ASNOW<a name='950'></font>
<font color=#447700>!          PRECmax(1)=MAX(PRECmax(1), ARAIN)<a name='951'></font>
<font color=#447700>!          PRECmax(2)=MAX(PRECmax(2), ASNOW)<a name='952'></font>
<font color=#447700>!        ENDIF<a name='953'></font>
<a name='954'>
<a name='955'>
<font color=#447700>!#######################################################################<a name='956'></font>
<font color=#447700>!#######################################################################<a name='957'></font>
<font color=#447700>!<a name='958'></font>
100   CONTINUE                          <font color=#447700>! End "I" &amp; "J" loops<a name='959'></font>
        DO 101 J=JTS,JTE    <a name='960'>
        DO 101 I=ITS,ITE  <a name='961'>
           DO L=KTS,KTE<a name='962'>
              KFLIP=KTE+1-L<a name='963'>
             CWM_PHY(I,KFLIP,J)=CWM(I,J,L)<a name='964'>
             T_PHY(I,KFLIP,J)=T(I,J,L)<a name='965'>
             Q_PHY(I,KFLIP,J)=Q(I,J,L)<a name='966'>
             TLATGS_PHY(I,KFLIP,J)=TLATGS(I,J,L)<a name='967'>
             TRAIN_PHY(I,KFLIP,J)=TRAIN(I,J,L)<a name='968'>
             F_ice_PHY(I,KFLIP,J)=F_ice(L,I,J)<a name='969'>
             F_rain_PHY(I,KFLIP,J)=F_rain(L,I,J)<a name='970'>
             F_RimeF_PHY(I,KFLIP,J)=F_RimeF(L,I,J)<a name='971'>
           ENDDO<a name='972'>
101     CONTINUE<a name='973'>
<font color=#447700>!<a name='974'></font>
      END SUBROUTINE EGCP01DRV<a name='975'>
<font color=#447700>!<a name='976'></font>
<font color=#447700>!<a name='977'></font>
<font color=#447700>!###############################################################################<a name='978'></font>
<font color=#447700>! ***** VERSION OF MICROPHYSICS DESIGNED FOR HIGHER RESOLUTION MESO ETA MODEL<a name='979'></font>
<font color=#447700>!       (1) Represents sedimentation by preserving a portion of the precipitation<a name='980'></font>
<font color=#447700>!           through top-down integration from cloud-top.  Modified procedure to<a name='981'></font>
<font color=#447700>!           Zhao and Carr (1997).<a name='982'></font>
<font color=#447700>!       (2) Microphysical equations are modified to be less sensitive to time<a name='983'></font>
<font color=#447700>!           steps by use of Clausius-Clapeyron equation to account for changes in<a name='984'></font>
<font color=#447700>!           saturation mixing ratios in response to latent heating/cooling.  <a name='985'></font>
<font color=#447700>!       (3) Prevent spurious temperature oscillations across 0C due to <a name='986'></font>
<font color=#447700>!           microphysics.<a name='987'></font>
<font color=#447700>!       (4) Uses lookup tables for: calculating two different ventilation <a name='988'></font>
<font color=#447700>!           coefficients in condensation and deposition processes; accretion of<a name='989'></font>
<font color=#447700>!           cloud water by precipitation; precipitation mass; precipitation rate<a name='990'></font>
<font color=#447700>!           (and mass-weighted precipitation fall speeds).<a name='991'></font>
<font color=#447700>!       (5) Assumes temperature-dependent variation in mean diameter of large ice<a name='992'></font>
<font color=#447700>!           (Houze et al., 1979; Ryan et al., 1996).<a name='993'></font>
<font color=#447700>!        -&gt; 8/22/01: This relationship has been extended to colder temperatures<a name='994'></font>
<font color=#447700>!           to parameterize smaller large-ice particles down to mean sizes of MDImin,<a name='995'></font>
<font color=#447700>!           which is 50 microns reached at -55.9C.<a name='996'></font>
<font color=#447700>!       (6) Attempts to differentiate growth of large and small ice, mainly for<a name='997'></font>
<font color=#447700>!           improved transition from thin cirrus to thick, precipitating ice<a name='998'></font>
<font color=#447700>!           anvils.<a name='999'></font>
<font color=#447700>!       (7) Top-down integration also attempts to treat mixed-phase processes,<a name='1000'></font>
<font color=#447700>!           allowing a mixture of ice and water.  Based on numerous observational<a name='1001'></font>
<font color=#447700>!           studies, ice growth is based on nucleation at cloud top &amp;<a name='1002'></font>
<font color=#447700>!           subsequent growth by vapor deposition and riming as the ice particles <a name='1003'></font>
<font color=#447700>!           fall through the cloud.  Nucleation rates are a function of temperature.<a name='1004'></font>
<font color=#447700>!       (8) Depositional growth of newly nucleated ice is calculated for large time<a name='1005'></font>
<font color=#447700>!           steps using Fig. 8 of Miller and Young (JAS, 1979), at 1 deg intervals<a name='1006'></font>
<font color=#447700>!           using their ice crystal masses calculated after 600 s of growth in water<a name='1007'></font>
<font color=#447700>!           saturated conditions.  The growth rates are normalized by time step<a name='1008'></font>
<font color=#447700>!           assuming 3D growth with time**1.5 following eq. (6.3) in Young (1993).<a name='1009'></font>
<font color=#447700>!       (9) Ice precipitation rates can increase due to increase in response to<a name='1010'></font>
<font color=#447700>!           cloud water riming due to (a) increased density &amp; mass of the rimed<a name='1011'></font>
<font color=#447700>!           ice, and (b) increased fall speeds of rimed ice.<a name='1012'></font>
<font color=#447700>!###############################################################################<a name='1013'></font>
<font color=#447700>!###############################################################################<a name='1014'></font>
<font color=#447700>!<a name='1015'></font>
<A NAME='EGCP01COLUMN'><A href='../../html_code/phys/module_mp_fer_hires.F.html#EGCP01COLUMN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1016'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>EGCP01COLUMN</font> ( ARAIN, ASNOW, DTPH, I_index, J_index,   &amp; <A href='../../call_to/EGCP01COLUMN.html' TARGET='index'>3</A>,<A href='../../call_from/EGCP01COLUMN.html' TARGET='index'>3</A><a name='1017'>
     &amp; LSFC, P_col, QI_col, QR_col, QV_col, QW_col, RimeF_col, T_col,   &amp;<a name='1018'>
     &amp; THICK_col, WC_col, RHC_col, KTS,KTE,NSTATS,QMAX,QTOT)   <font color=#447700>!GFDL<a name='1019'></font>
<font color=#447700>!<a name='1020'></font>
<font color=#447700>!###############################################################################<a name='1021'></font>
<font color=#447700>!###############################################################################<a name='1022'></font>
<font color=#447700>!<a name='1023'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1024'></font>
<font color=#447700>!----- NOTE:  Code is currently set up w/o threading!  <a name='1025'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1026'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='1027'></font>
<font color=#447700>!                .      .    .     <a name='1028'></font>
<font color=#447700>! SUBPROGRAM:  Grid-scale microphysical processes - condensation &amp; precipitation<a name='1029'></font>
<font color=#447700>!   PRGRMMR: Ferrier         ORG: W/NP22     DATE: 08-2001<a name='1030'></font>
<font color=#447700>!   PRGRMMR: Jin  (Modification for WRF structure)<a name='1031'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1032'></font>
<font color=#447700>! ABSTRACT:<a name='1033'></font>
<font color=#447700>!   * Merges original GSCOND &amp; PRECPD subroutines.   <a name='1034'></font>
<font color=#447700>!   * Code has been substantially streamlined and restructured.<a name='1035'></font>
<font color=#447700>!   * Exchange between water vapor &amp; small cloud condensate is calculated using<a name='1036'></font>
<font color=#447700>!     the original Asai (1965, J. Japan) algorithm.  See also references to<a name='1037'></font>
<font color=#447700>!     Yau and Austin (1979, JAS), Rutledge and Hobbs (1983, JAS), and Tao et al.<a name='1038'></font>
<font color=#447700>!     (1989, MWR).  This algorithm replaces the Sundqvist et al. (1989, MWR)<a name='1039'></font>
<font color=#447700>!     parameterization.  <a name='1040'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1041'></font>
<font color=#447700>!     <a name='1042'></font>
<font color=#447700>! USAGE: <a name='1043'></font>
<font color=#447700>!   * CALL EGCP01COLUMN FROM SUBROUTINE EGCP01DRV<a name='1044'></font>
<font color=#447700>!<a name='1045'></font>
<font color=#447700>! INPUT ARGUMENT LIST:<a name='1046'></font>
<font color=#447700>!   DTPH       - physics time step (s)<a name='1047'></font>
<font color=#447700>!   I_index    - I index<a name='1048'></font>
<font color=#447700>!   J_index    - J index<a name='1049'></font>
<font color=#447700>!   LSFC       - Eta level of level above surface, ground<a name='1050'></font>
<font color=#447700>!   P_col      - vertical column of model pressure (Pa)<a name='1051'></font>
<font color=#447700>!   QI_col     - vertical column of model ice mixing ratio (kg/kg)<a name='1052'></font>
<font color=#447700>!   QR_col     - vertical column of model rain ratio (kg/kg)<a name='1053'></font>
<font color=#447700>!   QV_col     - vertical column of model water vapor specific humidity (kg/kg)<a name='1054'></font>
<font color=#447700>!   QW_col     - vertical column of model cloud water mixing ratio (kg/kg)<a name='1055'></font>
<font color=#447700>!   RimeF_col  - vertical column of rime factor for ice in model (ratio, defined below)<a name='1056'></font>
<font color=#447700>!   T_col      - vertical column of model temperature (deg K)<a name='1057'></font>
<font color=#447700>!   THICK_col  - vertical column of model mass thickness (density*height increment)<a name='1058'></font>
<font color=#447700>!   WC_col     - vertical column of model mixing ratio of total condensate (kg/kg)<a name='1059'></font>
<font color=#447700>!   RHC_col    - vertical column of threshold relative humidity for onset of condensation (ratio)   !GFDL<a name='1060'></font>
<font color=#447700>!   <a name='1061'></font>
<font color=#447700>!<a name='1062'></font>
<font color=#447700>! OUTPUT ARGUMENT LIST: <a name='1063'></font>
<font color=#447700>!   ARAIN      - accumulated rainfall at the surface (kg)<a name='1064'></font>
<font color=#447700>!   ASNOW      - accumulated snowfall at the surface (kg)<a name='1065'></font>
<font color=#447700>!   QV_col     - vertical column of model water vapor specific humidity (kg/kg)<a name='1066'></font>
<font color=#447700>!   WC_col     - vertical column of model mixing ratio of total condensate (kg/kg)<a name='1067'></font>
<font color=#447700>!   QW_col     - vertical column of model cloud water mixing ratio (kg/kg)<a name='1068'></font>
<font color=#447700>!   QI_col     - vertical column of model ice mixing ratio (kg/kg)<a name='1069'></font>
<font color=#447700>!   QR_col     - vertical column of model rain ratio (kg/kg)<a name='1070'></font>
<font color=#447700>!   RimeF_col  - vertical column of rime factor for ice in model (ratio, defined below)<a name='1071'></font>
<font color=#447700>!   T_col      - vertical column of model temperature (deg K)<a name='1072'></font>
<font color=#447700>!     <a name='1073'></font>
<font color=#447700>! OUTPUT FILES:<a name='1074'></font>
<font color=#447700>!     NONE<a name='1075'></font>
<font color=#447700>!     <a name='1076'></font>
<font color=#447700>! Subprograms &amp; Functions called:<a name='1077'></font>
<font color=#447700>!   * Real Function CONDENSE  - cloud water condensation<a name='1078'></font>
<font color=#447700>!   * Real Function DEPOSIT   - ice deposition (not sublimation)<a name='1079'></font>
<font color=#447700>!<a name='1080'></font>
<font color=#447700>! UNIQUE: NONE<a name='1081'></font>
<font color=#447700>!  <a name='1082'></font>
<font color=#447700>! LIBRARY: NONE<a name='1083'></font>
<font color=#447700>!  <a name='1084'></font>
<font color=#447700>! COMMON BLOCKS:  <a name='1085'></font>
<font color=#447700>!     CMICRO_CONS  - key constants initialized in GSMCONST<a name='1086'></font>
<font color=#447700>!     CMICRO_STATS - accumulated and maximum statistics<a name='1087'></font>
<font color=#447700>!     CMY_GROWTH   - lookup table for growth of ice crystals in <a name='1088'></font>
<font color=#447700>!                    water saturated conditions (Miller &amp; Young, 1979)<a name='1089'></font>
<font color=#447700>!     IVENT_TABLES - lookup tables for ventilation effects of ice<a name='1090'></font>
<font color=#447700>!     IACCR_TABLES - lookup tables for accretion rates of ice<a name='1091'></font>
<font color=#447700>!     IMASS_TABLES - lookup tables for mass content of ice<a name='1092'></font>
<font color=#447700>!     IRATE_TABLES - lookup tables for precipitation rates of ice<a name='1093'></font>
<font color=#447700>!     IRIME_TABLES - lookup tables for increase in fall speed of rimed ice<a name='1094'></font>
<font color=#447700>!     RVENT_TABLES - lookup tables for ventilation effects of rain<a name='1095'></font>
<font color=#447700>!     RACCR_TABLES - lookup tables for accretion rates of rain<a name='1096'></font>
<font color=#447700>!     RMASS_TABLES - lookup tables for mass content of rain<a name='1097'></font>
<font color=#447700>!     RVELR_TABLES - lookup tables for fall speeds of rain<a name='1098'></font>
<font color=#447700>!     RRATE_TABLES - lookup tables for precipitation rates of rain<a name='1099'></font>
<font color=#447700>!   <a name='1100'></font>
<font color=#447700>! ATTRIBUTES:<a name='1101'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='1102'></font>
<font color=#447700>!   MACHINE : IBM SP<a name='1103'></font>
<font color=#447700>!<a name='1104'></font>
<font color=#447700>!<a name='1105'></font>
<font color=#447700>!------------------------------------------------------------------------- <a name='1106'></font>
<font color=#447700>!--------------- Arrays &amp; constants in argument list --------------------- <a name='1107'></font>
<font color=#447700>!------------------------------------------------------------------------- <a name='1108'></font>
<font color=#447700>!<a name='1109'></font>
      IMPLICIT NONE<a name='1110'>
<font color=#447700>!    <a name='1111'></font>
      INTEGER,INTENT(IN) :: KTS,KTE,I_index, J_index, LSFC<a name='1112'>
      REAL,INTENT(INOUT) ::  ARAIN, ASNOW<a name='1113'>
      REAL,DIMENSION(KTS:KTE),INTENT(INOUT) ::  P_col, QI_col,QR_col    &amp;<a name='1114'>
     &amp; ,QV_col ,QW_col, RimeF_col, T_col, THICK_col, WC_col, RHC_col   <font color=#447700>!GFDL<a name='1115'></font>
<font color=#447700>!<a name='1116'></font>
<font color=#447700>!------------------------------------------------------------------------- <a name='1117'></font>
<font color=#447700>!-------------- Common blocks for microphysical statistics ---------------<a name='1118'></font>
<font color=#447700>!------------------------------------------------------------------------- <a name='1119'></font>
<font color=#447700>!<a name='1120'></font>
<font color=#447700>!------------------------------------------------------------------------- <a name='1121'></font>
<font color=#447700>!--------- Common blocks for constants initialized in GSMCONST ----------<a name='1122'></font>
<font color=#447700>!<a name='1123'></font>
      INTEGER, PARAMETER :: ITLO=-60, ITHI=40<a name='1124'>
      INTEGER,INTENT(INOUT) :: NSTATS(ITLO:ITHI,4)<a name='1125'>
      REAL,INTENT(INOUT) :: QMAX(ITLO:ITHI,5),QTOT(ITLO:ITHI,22) <a name='1126'>
<font color=#447700>!<a name='1127'></font>
<font color=#447700>!------------------------------------------------------------------------- <a name='1128'></font>
<font color=#447700>!--------------- Common blocks for various lookup tables -----------------<a name='1129'></font>
<font color=#447700>!<a name='1130'></font>
<font color=#447700>!--- Discretized growth rates of small ice crystals after their nucleation <a name='1131'></font>
<font color=#447700>!     at 1 C intervals from -1 C to -35 C, based on calculations by Miller <a name='1132'></font>
<font color=#447700>!     and Young (1979, JAS) after 600 s of growth.  Resultant growth rates<a name='1133'></font>
<font color=#447700>!     are multiplied by physics time step in GSMCONST.<a name='1134'></font>
<font color=#447700>!<a name='1135'></font>
<font color=#447700>!------------------------------------------------------------------------- <a name='1136'></font>
<font color=#447700>!<a name='1137'></font>
<font color=#447700>!--- Mean ice-particle diameters varying from 50 microns to 1000 microns<a name='1138'></font>
<font color=#447700>!      (1 mm), assuming an exponential size distribution.  <a name='1139'></font>
<font color=#447700>!<a name='1140'></font>
<font color=#447700>!---- Meaning of the following arrays: <a name='1141'></font>
<font color=#447700>!        - mdiam - mean diameter (m)<a name='1142'></font>
<font color=#447700>!        - VENTI1 - integrated quantity associated w/ ventilation effects <a name='1143'></font>
<font color=#447700>!                   (capacitance only) for calculating vapor deposition onto ice<a name='1144'></font>
<font color=#447700>!        - VENTI2 - integrated quantity associated w/ ventilation effects <a name='1145'></font>
<font color=#447700>!                   (with fall speed) for calculating vapor deposition onto ice<a name='1146'></font>
<font color=#447700>!        - ACCRI  - integrated quantity associated w/ cloud water collection by ice<a name='1147'></font>
<font color=#447700>!        - MASSI  - integrated quantity associated w/ ice mass <a name='1148'></font>
<font color=#447700>!        - VSNOWI - mass-weighted fall speed of snow (large ice), used to calculate <a name='1149'></font>
<font color=#447700>!                   precipitation rates<a name='1150'></font>
<font color=#447700>!<a name='1151'></font>
<font color=#447700>!<a name='1152'></font>
<font color=#447700>!------------------------------------------------------------------------- <a name='1153'></font>
<font color=#447700>!<a name='1154'></font>
<font color=#447700>!--- VEL_RF - velocity increase of rimed particles as functions of crude<a name='1155'></font>
<font color=#447700>!      particle size categories (at 0.1 mm intervals of mean ice particle<a name='1156'></font>
<font color=#447700>!      sizes) and rime factor (different values of Rime Factor of 1.1**N, <a name='1157'></font>
<font color=#447700>!      where N=0 to Nrime).<a name='1158'></font>
<font color=#447700>!<a name='1159'></font>
<font color=#447700>!------------------------------------------------------------------------- <a name='1160'></font>
<font color=#447700>!<a name='1161'></font>
<font color=#447700>!--- Mean rain drop diameters varying from 50 microns (0.05 mm) to 1000 microns <a name='1162'></font>
<font color=#447700>!      (1.0 mm) assuming an exponential size distribution.  <a name='1163'></font>
<font color=#447700>!<a name='1164'></font>
<font color=#447700>!------------------------------------------------------------------------- <a name='1165'></font>
<font color=#447700>!------- Key parameters, local variables, &amp; important comments ---------<a name='1166'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1167'></font>
<font color=#447700>!<a name='1168'></font>
<font color=#447700>!--- TOLER =&gt; Tolerance or precision for accumulated precipitation <a name='1169'></font>
<font color=#447700>!<a name='1170'></font>
      REAL, PARAMETER :: TOLER=5.E-7, C2=1./6., RHO0=1.194, Xratio=.025                                           <a name='1171'>
<font color=#447700>!<a name='1172'></font>
<font color=#447700>!--- If BLEND=1:<a name='1173'></font>
<font color=#447700>!      precipitation (large) ice amounts are estimated at each level as a <a name='1174'></font>
<font color=#447700>!      blend of ice falling from the grid point above and the precip ice<a name='1175'></font>
<font color=#447700>!      present at the start of the time step (see TOT_ICE below).<a name='1176'></font>
<font color=#447700>!--- If BLEND=0:<a name='1177'></font>
<font color=#447700>!      precipitation (large) ice amounts are estimated to be the precip<a name='1178'></font>
<font color=#447700>!      ice present at the start of the time step.<a name='1179'></font>
<font color=#447700>!<a name='1180'></font>
<font color=#447700>!--- Extended to include sedimentation of rain on 2/5/01 <a name='1181'></font>
<font color=#447700>!<a name='1182'></font>
      REAL, PARAMETER :: BLEND=1.<a name='1183'>
<font color=#447700>!<a name='1184'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1185'></font>
<font color=#447700>!--- Local variables<a name='1186'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1187'></font>
<font color=#447700>!<a name='1188'></font>
      REAL EMAIRI, N0r, NLICE, NSmICE, NInuclei, RHgrd<a name='1189'>
      LOGICAL :: CLEAR, ICE_logical, DBG_logical, RAIN_logical,         &amp;<a name='1190'>
     &amp;   LARGE_RF, HAIL<a name='1191'>
      INTEGER :: IDR,INDEX_MY,INDEXR,INDEXR1,INDEXS,IPASS,ITDX,IXRF,    &amp;<a name='1192'>
     &amp;           IXS,LBEF,L<a name='1193'>
<font color=#447700>!<a name='1194'></font>
      REAL :: ABI,ABW,AIEVP,ARAINnew,ASNOWnew,BLDTRH,BUDGET,            &amp;<a name='1195'>
     &amp;        CREVP,DELI,DELR,DELT,DELV,DELW,DENOMF,                    &amp;<a name='1196'>
     &amp;        DENOMI,DENOMW,DENOMWI,DIDEP,                              &amp;<a name='1197'>
     &amp;        DIEVP,DIFFUS,DLI,DTPH,DTRHO,DUM,DUM1,DUM2,DUM3,           &amp;<a name='1198'>
     &amp;        DWV0,DWVI,DWVR,DYNVIS,ESI,ESW,FIR,FLARGE,FLIMASS,         &amp;<a name='1199'>
     &amp;        FSMALL,FWR,FWS,GAMMAR,GAMMAS,                             &amp;<a name='1200'>
     &amp;        PCOND,PIACR,PIACW,PIACWI,PIACWR,PICND,PIDEP,PIDEP_max,    &amp;<a name='1201'>
     &amp;        PIEVP,PILOSS,PIMLT,PINT,PP,PRACW,PRAUT,PREVP,PRLOSS,      &amp;<a name='1202'>
     &amp;        QI,QInew,QLICE,QR,QRnew,QSI,QSIgrd,QSInew,QSW,QSW0,       &amp;<a name='1203'>
     &amp;        QSWgrd,QSWnew,QT,QTICE,QTnew,QTRAIN,QV,QW,QWnew,          &amp;<a name='1204'>
     &amp;        RFACTOR,RHO,RIMEF,RIMEF1,RQR,RR,RRHO,SFACTOR,             &amp;<a name='1205'>
     &amp;        TC,TCC,TFACTOR,THERM_COND,THICK,TK,TK2,TNEW,              &amp;<a name='1206'>
     &amp;        TOT_ICE,TOT_ICEnew,TOT_RAIN,TOT_RAINnew,                  &amp;<a name='1207'>
     &amp;        VEL_INC,VENTR,VENTIL,VENTIS,VRAIN1,VRAIN2,VRIMEF,VSNOW,   &amp;<a name='1208'>
     &amp;        WC,WCnew,WSgrd,WS,WSnew,WV,WVnew,                         &amp;<a name='1209'>
     &amp;        XLF,XLF1,XLI,XLV,XLV1,XLV2,XLIMASS,XRF,                   &amp;<a name='1210'>
     &amp;        NLImax,NSImax,QRdum,QSmICE,QLgIce,RQLICE,VCI,VRabove    <font color=#447700>!-- new variables          <a name='1211'></font>
      REAL, SAVE :: Revised_LICE=1.e-3    <font color=#447700>!-- kg/m**3<a name='1212'></font>
<font color=#447700>!<a name='1213'></font>
<font color=#447700>!#######################################################################<a name='1214'></font>
<font color=#447700>!########################## Begin Execution ############################<a name='1215'></font>
<font color=#447700>!#######################################################################<a name='1216'></font>
<font color=#447700>!<a name='1217'></font>
<font color=#447700>!<a name='1218'></font>
      ARAIN=0.                <font color=#447700>! Accumulated rainfall into grid box from above (kg/m**2)<a name='1219'></font>
      ASNOW=0.                <font color=#447700>! Accumulated snowfall into grid box from above (kg/m**2)<a name='1220'></font>
      VRabove=0.              <font color=#447700>! Fall speed of rain into grid box from above (m/s)<a name='1221'></font>
<font color=#447700>!<a name='1222'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1223'></font>
<font color=#447700>!------------ Loop from top (L=1) to surface (L=LSFC) ------------------<a name='1224'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1225'></font>
<font color=#447700>!<a name='1226'></font>
      DO 10 L=1,LSFC<a name='1227'>
<font color=#447700>!--- Skip this level and go to the next lower level if no condensate <a name='1228'></font>
<font color=#447700>!      and very low specific humidities<a name='1229'></font>
<font color=#447700>!<a name='1230'></font>
        IF (QV_col(L).LE.EPSQ .AND. WC_col(L).LE.EPSQ) GO TO 10<a name='1231'>
<font color=#447700>!<a name='1232'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1233'></font>
<font color=#447700>!------------ Proceed with cloud microphysics calculations -------------<a name='1234'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1235'></font>
<font color=#447700>!<a name='1236'></font>
          TK=T_col(L)         <font color=#447700>! Temperature (deg K)<a name='1237'></font>
          TC=TK-T0C           <font color=#447700>! Temperature (deg C)<a name='1238'></font>
          PP=P_col(L)         <font color=#447700>! Pressure (Pa)<a name='1239'></font>
          QV=QV_col(L)        <font color=#447700>! Specific humidity of water vapor (kg/kg)<a name='1240'></font>
          WV=QV/(1.-QV)       <font color=#447700>! Water vapor mixing ratio (kg/kg)<a name='1241'></font>
          WC=WC_col(L)        <font color=#447700>! Grid-scale mixing ratio of total condensate (water or ice; kg/kg)<a name='1242'></font>
          RHgrd=RHC_col(L)    <font color=#447700>! Threshold relative humidity for the onset of condensation<a name='1243'></font>
<font color=#447700>!<a name='1244'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1245'></font>
<font color=#447700>!--- Moisture variables below are mixing ratios &amp; not specifc humidities<a name='1246'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1247'></font>
<font color=#447700>!<a name='1248'></font>
          CLEAR=.TRUE.<a name='1249'>
<font color=#447700>!    <a name='1250'></font>
<font color=#447700>!--- This check is to determine grid-scale saturation when no condensate is present<a name='1251'></font>
<font color=#447700>!    <a name='1252'></font>
          ESW=MIN(1000.*FPVS0(TK),0.99*PP) <font color=#447700>! Saturation vapor pressure w/r/t water<a name='1253'></font>
          QSW=EPS*ESW/(PP-ESW)             <font color=#447700>! Saturation mixing ratio w/r/t water<a name='1254'></font>
          WS=QSW                           <font color=#447700>! General saturation mixing ratio (water/ice)<a name='1255'></font>
          QSI=QSW                          <font color=#447700>! Saturation mixing ratio w/r/t ice<a name='1256'></font>
          IF (TC .LT. 0.) THEN<a name='1257'>
            ESI=MIN(1000.*FPVS(TK),0.99*PP)  <font color=#447700>! Saturation vapor pressure w/r/t ice<a name='1258'></font>
            QSI=EPS*ESI/(PP-ESI)           <font color=#447700>! Saturation mixing ratio w/r/t water<a name='1259'></font>
            WS=QSI                         <font color=#447700>! General saturation mixing ratio (water/ice)<a name='1260'></font>
          ENDIF<a name='1261'>
<font color=#447700>!<a name='1262'></font>
<font color=#447700>!--- Effective grid-scale Saturation mixing ratios<a name='1263'></font>
<font color=#447700>!<a name='1264'></font>
          QSWgrd=RHgrd*QSW<a name='1265'>
          QSIgrd=RHgrd*QSI<a name='1266'>
          WSgrd=RHgrd*WS<a name='1267'>
<font color=#447700>!<a name='1268'></font>
<font color=#447700>!--- Check if air is subsaturated and w/o condensate<a name='1269'></font>
<font color=#447700>!<a name='1270'></font>
          IF (WV.GT.WSgrd .OR. WC.GT.EPSQ) CLEAR=.FALSE.<a name='1271'>
<font color=#447700>!<a name='1272'></font>
<font color=#447700>!--- Check if any rain is falling into layer from above<a name='1273'></font>
<font color=#447700>!<a name='1274'></font>
          IF (ARAIN .GT. CLIMIT) THEN<a name='1275'>
            CLEAR=.FALSE.<a name='1276'>
          ELSE<a name='1277'>
            ARAIN=0.<a name='1278'>
            VRabove=0.<a name='1279'>
          ENDIF<a name='1280'>
<font color=#447700>!<a name='1281'></font>
<font color=#447700>!--- Check if any ice is falling into layer from above<a name='1282'></font>
<font color=#447700>!<a name='1283'></font>
<font color=#447700>!--- NOTE that "SNOW" in variable names is synonomous with <a name='1284'></font>
<font color=#447700>!    large, precipitation ice particles<a name='1285'></font>
<font color=#447700>!<a name='1286'></font>
          IF (ASNOW .GT. CLIMIT) THEN<a name='1287'>
            CLEAR=.FALSE.<a name='1288'>
          ELSE<a name='1289'>
            ASNOW=0.<a name='1290'>
          ENDIF<a name='1291'>
<font color=#447700>!<a name='1292'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1293'></font>
<font color=#447700>!-- Loop to the end if in clear, subsaturated air free of condensate ---<a name='1294'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1295'></font>
<font color=#447700>!<a name='1296'></font>
          IF (CLEAR) GO TO 10<a name='1297'>
<font color=#447700>!<a name='1298'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1299'></font>
<font color=#447700>!--------- Initialize RHO, THICK &amp; microphysical processes -------------<a name='1300'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1301'></font>
<font color=#447700>!<a name='1302'></font>
<font color=#447700>!<a name='1303'></font>
<font color=#447700>!--- Virtual temperature, TV=T*(1./EPS-1)*Q, Q is specific humidity;<a name='1304'></font>
<font color=#447700>!    (see pp. 63-65 in Fleagle &amp; Businger, 1963)<a name='1305'></font>
<font color=#447700>!<a name='1306'></font>
          RHO=PP/(RD*TK*(1.+EPS1*QV))   <font color=#447700>! Air density (kg/m**3)<a name='1307'></font>
          RRHO=1./RHO                <font color=#447700>! Reciprocal of air density<a name='1308'></font>
          DTRHO=DTPH*RHO             <font color=#447700>! Time step * air density<a name='1309'></font>
          BLDTRH=BLEND*DTRHO         <font color=#447700>! Blend parameter * time step * air density<a name='1310'></font>
          THICK=THICK_col(L)         <font color=#447700>! Layer thickness = RHO*DZ = -DP/G = (Psfc-Ptop)*D_ETA/(G*ETA_sfc)<a name='1311'></font>
<font color=#447700>!<a name='1312'></font>
          ARAINnew=0.                <font color=#447700>! Updated accumulated rainfall<a name='1313'></font>
          ASNOWnew=0.                <font color=#447700>! Updated accumulated snowfall<a name='1314'></font>
          QI=QI_col(L)               <font color=#447700>! Ice mixing ratio<a name='1315'></font>
          QInew=0.                   <font color=#447700>! Updated ice mixing ratio<a name='1316'></font>
          QR=QR_col(L)               <font color=#447700>! Rain mixing ratio<a name='1317'></font>
          QRnew=0.                   <font color=#447700>! Updated rain ratio<a name='1318'></font>
          QW=QW_col(L)               <font color=#447700>! Cloud water mixing ratio<a name='1319'></font>
          QWnew=0.                   <font color=#447700>! Updated cloud water ratio<a name='1320'></font>
<font color=#447700>!<a name='1321'></font>
          PCOND=0.                   <font color=#447700>! Condensation (&gt;0) or evaporation (&lt;0) of cloud water (kg/kg)<a name='1322'></font>
          PIDEP=0.                   <font color=#447700>! Deposition (&gt;0) or sublimation (&lt;0) of ice crystals (kg/kg)<a name='1323'></font>
          PIACW=0.                   <font color=#447700>! Cloud water collection (riming) by precipitation ice (kg/kg; &gt;0)<a name='1324'></font>
          PIACWI=0.                  <font color=#447700>! Growth of precip ice by riming (kg/kg; &gt;0)<a name='1325'></font>
          PIACWR=0.                  <font color=#447700>! Shedding of accreted cloud water to form rain (kg/kg; &gt;0)<a name='1326'></font>
          PIACR=0.                   <font color=#447700>! Freezing of rain onto large ice at supercooled temps (kg/kg; &gt;0)<a name='1327'></font>
          PICND=0.                   <font color=#447700>! Condensation (&gt;0) onto wet, melting ice (kg/kg)<a name='1328'></font>
          PIEVP=0.                   <font color=#447700>! Evaporation (&lt;0) from wet, melting ice (kg/kg)<a name='1329'></font>
          PIMLT=0.                   <font color=#447700>! Melting ice (kg/kg; &gt;0)<a name='1330'></font>
          PRAUT=0.                   <font color=#447700>! Cloud water autoconversion to rain (kg/kg; &gt;0)<a name='1331'></font>
          PRACW=0.                   <font color=#447700>! Cloud water collection (accretion) by rain (kg/kg; &gt;0)<a name='1332'></font>
          PREVP=0.                   <font color=#447700>! Rain evaporation (kg/kg; &lt;0)<a name='1333'></font>
<font color=#447700>!<a name='1334'></font>
<font color=#447700>!--- Double check input hydrometeor mixing ratios<a name='1335'></font>
<font color=#447700>!<a name='1336'></font>
<font color=#447700>!          DUM=WC-(QI+QW+QR)<a name='1337'></font>
<font color=#447700>!          DUM1=ABS(DUM)<a name='1338'></font>
<font color=#447700>!          DUM2=TOLER*MIN(WC, QI+QW+QR)<a name='1339'></font>
<font color=#447700>!          IF (DUM1 .GT. DUM2) THEN<a name='1340'></font>
<font color=#447700>!            WRITE(6,"(/2(a,i4),a,i2)") '{@ i=',I_index,' j=',J_index,<a name='1341'></font>
<font color=#447700>!     &amp;                                 ' L=',L<a name='1342'></font>
<font color=#447700>!            WRITE(6,"(4(a12,g11.4,1x))") <a name='1343'></font>
<font color=#447700>!     &amp; '{@ TCold=',TC,'P=',.01*PP,'DIFF=',DUM,'WCold=',WC,<a name='1344'></font>
<font color=#447700>!     &amp; '{@ QIold=',QI,'QWold=',QW,'QRold=',QR<a name='1345'></font>
<font color=#447700>!          ENDIF<a name='1346'></font>
<font color=#447700>!<a name='1347'></font>
<font color=#447700>!***********************************************************************<a name='1348'></font>
<font color=#447700>!*********** MAIN MICROPHYSICS CALCULATIONS NOW FOLLOW! ****************<a name='1349'></font>
<font color=#447700>!***********************************************************************<a name='1350'></font>
<font color=#447700>!<a name='1351'></font>
<font color=#447700>!--- Calculate a few variables, which are used more than once below<a name='1352'></font>
<font color=#447700>!<a name='1353'></font>
<font color=#447700>!--- Latent heat of vaporization as a function of temperature from<a name='1354'></font>
<font color=#447700>!      Bolton (1980, JAS)<a name='1355'></font>
<font color=#447700>!<a name='1356'></font>
          XLV=3.148E6-2370*TK        <font color=#447700>! Latent heat of vaporization (Lv)<a name='1357'></font>
          XLF=XLS-XLV                <font color=#447700>! Latent heat of fusion (Lf)<a name='1358'></font>
          XLV1=XLV*RCP               <font color=#447700>! Lv/Cp<a name='1359'></font>
          XLF1=XLF*RCP               <font color=#447700>! Lf/Cp<a name='1360'></font>
          TK2=1./(TK*TK)             <font color=#447700>! 1./TK**2<a name='1361'></font>
          XLV2=XLV*XLV*QSW*TK2/RV    <font color=#447700>! Lv**2*Qsw/(Rv*TK**2)<a name='1362'></font>
          DENOMW=1.+XLV2*RCP         <font color=#447700>! Denominator term, Clausius-Clapeyron correction<a name='1363'></font>
<font color=#447700>!<a name='1364'></font>
<font color=#447700>!--- Basic thermodynamic quantities<a name='1365'></font>
<font color=#447700>!      * DYNVIS - dynamic viscosity  [ kg/(m*s) ]<a name='1366'></font>
<font color=#447700>!      * THERM_COND - thermal conductivity  [ J/(m*s*K) ]<a name='1367'></font>
<font color=#447700>!      * DIFFUS - diffusivity of water vapor  [ m**2/s ]<a name='1368'></font>
<font color=#447700>!<a name='1369'></font>
          TFACTOR=SQRT(TK*TK*TK)/(TK+120.)<a name='1370'>
          DYNVIS=1.496E-6*TFACTOR<a name='1371'>
          THERM_COND=2.116E-3*TFACTOR<a name='1372'>
          DIFFUS=8.794E-5*TK**1.81/PP<a name='1373'>
<font color=#447700>!<a name='1374'></font>
<font color=#447700>!--- Air resistance term for the fall speed of ice following the<a name='1375'></font>
<font color=#447700>!      basic research by Heymsfield, Kajikawa, others <a name='1376'></font>
<font color=#447700>!<a name='1377'></font>
          GAMMAS=MIN(1.5, (1.E5/PP)**C1)    <font color=#447700>!-- limited to 1.5x<a name='1378'></font>
<font color=#447700>!<a name='1379'></font>
<font color=#447700>!--- Air resistance for rain fall speed (Beard, 1985, JAS, p.470)<a name='1380'></font>
<font color=#447700>!<a name='1381'></font>
          GAMMAR=(RHO0/RHO)**.4<a name='1382'>
<font color=#447700>!<a name='1383'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1384'></font>
<font color=#447700>!-------------  IMPORTANT MICROPHYSICS DECISION TREE  -----------------<a name='1385'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1386'></font>
<font color=#447700>!<a name='1387'></font>
<font color=#447700>!--- Determine if conditions supporting ice are present<a name='1388'></font>
<font color=#447700>!<a name='1389'></font>
          IF (TC.LT.0. .OR. QI.GT.EPSQ .OR. ASNOW.GT.CLIMIT) THEN<a name='1390'>
            ICE_logical=.TRUE.<a name='1391'>
          ELSE<a name='1392'>
            ICE_logical=.FALSE.<a name='1393'>
            QLICE=0.<a name='1394'>
            QTICE=0.<a name='1395'>
          ENDIF<a name='1396'>
          IF (T_ICE &lt;= -100.) THEN<a name='1397'>
            ICE_logical=.FALSE.<a name='1398'>
            QLICE=0.<a name='1399'>
            QTICE=0.<a name='1400'>
          ENDIF<a name='1401'>
<font color=#447700>!<a name='1402'></font>
<font color=#447700>!--- Determine if rain is present<a name='1403'></font>
<font color=#447700>!<a name='1404'></font>
          RAIN_logical=.FALSE.<a name='1405'>
          IF (ARAIN.GT.CLIMIT .OR. QR.GT.EPSQ) RAIN_logical=.TRUE.<a name='1406'>
<font color=#447700>!<a name='1407'></font>
ice_test: IF (ICE_logical) THEN<a name='1408'>
<font color=#447700>!<a name='1409'></font>
<font color=#447700>!--- IMPORTANT:  Estimate time-averaged properties.<a name='1410'></font>
<font color=#447700>!<a name='1411'></font>
<font color=#447700>!---<a name='1412'></font>
<font color=#447700>!  * FLARGE  - ratio of number of large ice to total (large &amp; small) ice<a name='1413'></font>
<font color=#447700>!  * FSMALL  - ratio of number of small ice crystals to large ice particles<a name='1414'></font>
<font color=#447700>!  -&gt;  Small ice particles are assumed to have a mean diameter of 50 microns.<a name='1415'></font>
<font color=#447700>!  * QSmICE  - estimated mixing ratio for small cloud ice<a name='1416'></font>
<font color=#447700>!---<a name='1417'></font>
<font color=#447700>!  * TOT_ICE - total mass (small &amp; large) ice before microphysics,<a name='1418'></font>
<font color=#447700>!              which is the sum of the total mass of large ice in the <a name='1419'></font>
<font color=#447700>!              current layer and the input flux of ice from above<a name='1420'></font>
<font color=#447700>!  * PILOSS  - greatest loss (&lt;0) of total (small &amp; large) ice by<a name='1421'></font>
<font color=#447700>!              sublimation, removing all of the ice falling from above<a name='1422'></font>
<font color=#447700>!              and the ice within the layer<a name='1423'></font>
<font color=#447700>!  * RimeF1  - Rime Factor, which is the mass ratio of total (unrimed &amp; rimed) <a name='1424'></font>
<font color=#447700>!              ice mass to the unrimed ice mass (&gt;=1)<a name='1425'></font>
<font color=#447700>!  * VrimeF  - the velocity increase due to rime factor or melting (ratio, &gt;=1)<a name='1426'></font>
<font color=#447700>!  * VSNOW   - Fall speed of rimed snow w/ air resistance correction<a name='1427'></font>
<font color=#447700>!  * VCI     - Fall speed of 50-micron ice crystals w/ air resistance correction<a name='1428'></font>
<font color=#447700>!  * EMAIRI  - equivalent mass of air associated layer and with fall of snow into layer<a name='1429'></font>
<font color=#447700>!  * XLIMASS - used for debugging, associated with calculating large ice mixing ratio<a name='1430'></font>
<font color=#447700>!  * FLIMASS - mass fraction of large ice<a name='1431'></font>
<font color=#447700>!  * QTICE   - time-averaged mixing ratio of total ice<a name='1432'></font>
<font color=#447700>!  * QLICE   - time-averaged mixing ratio of large ice<a name='1433'></font>
<font color=#447700>!  * NLICE   - time-averaged number concentration of large ice<a name='1434'></font>
<font color=#447700>!  * NSmICE  - number concentration of small ice crystals at current level<a name='1435'></font>
<font color=#447700>!  * QSmICE  - mixing ratio of small ice crystals at current level<a name='1436'></font>
<font color=#447700>!---<a name='1437'></font>
<font color=#447700>!--- Assumed number fraction of large ice particles to total (large &amp; small) <a name='1438'></font>
<font color=#447700>!    ice particles, which is based on a general impression of the literature.<a name='1439'></font>
<font color=#447700>!<a name='1440'></font>
            NInuclei=0.<a name='1441'>
            NSmICE=0.<a name='1442'>
            QSmICE=0. <a name='1443'>
            IF (TC&lt;0.) THEN<a name='1444'>
<font color=#447700>!<a name='1445'></font>
<font color=#447700>!--- Max # conc of small ice crystals based on 10% of total ice content<a name='1446'></font>
<font color=#447700>!    or the parameter NSI_max<a name='1447'></font>
<font color=#447700>!<a name='1448'></font>
               NSImax=MAX(NSI_max, 0.1*RHO*QI/MASSI(MDImin) )<a name='1449'>
<font color=#447700>!<a name='1450'></font>
<font color=#447700>!-- Specify Fletcher, Cooper, Meyers, etc. here for ice nuclei concentrations<a name='1451'></font>
<font color=#447700>!<a name='1452'></font>
               NInuclei=MIN(0.01*EXP(-0.6*TC), NSImax)       <font color=#447700>!- Fletcher (1962)<a name='1453'></font>
               IF (QI&gt;EPSQ) THEN<a name='1454'>
                  DUM=RRHO*MASSI(MDImin)<a name='1455'>
                  NSmICE=MIN(NInuclei, QI/DUM)<a name='1456'>
                  QSmICE=NSmICE*DUM<a name='1457'>
               ENDIF         <font color=#447700>! End IF (QI&gt;EPSQ)<a name='1458'></font>
            ENDIF            <font color=#447700>! End IF (TC&lt;0.)<a name='1459'></font>
  init_ice: IF (QI&lt;=EPSQ .AND. ASNOW&lt;=CLIMIT) THEN<a name='1460'>
              INDEXS=MDImin<a name='1461'>
              TOT_ICE=0.<a name='1462'>
              PILOSS=0.<a name='1463'>
              RimeF1=1.<a name='1464'>
              VrimeF=1.<a name='1465'>
              VEL_INC=GAMMAS<a name='1466'>
              VSNOW=0.<a name='1467'>
              VCI=0.<a name='1468'>
              EMAIRI=THICK<a name='1469'>
              XLIMASS=RimeF1*MASSI(INDEXS)<a name='1470'>
              FLIMASS=1.<a name='1471'>
              QLICE=0.<a name='1472'>
              RQLICE=0.<a name='1473'>
              QTICE=0.<a name='1474'>
              NLICE=0.<a name='1475'>
            ELSE  init_ice<a name='1476'>
   <font color=#447700>!<a name='1477'></font>
   <font color=#447700>!--- For T&lt;0C mean particle size follows Houze et al. (JAS, 1979, p. 160), <a name='1478'></font>
   <font color=#447700>!    converted from Fig. 5 plot of LAMDAs.  Similar set of relationships <a name='1479'></font>
   <font color=#447700>!    also shown in Fig. 8 of Ryan (BAMS, 1996, p. 66).<a name='1480'></font>
   <font color=#447700>!<a name='1481'></font>
              DUM=XMImax*EXP(XMIexp*TC)<a name='1482'>
              INDEXS=MIN(MDImax, MAX(MDImin, INT(DUM) ) )<a name='1483'>
              TOT_ICE=THICK*QI+BLEND*ASNOW<a name='1484'>
              PILOSS=-TOT_ICE/THICK<a name='1485'>
              LBEF=MAX(1,L-1)<a name='1486'>
              DUM1=RimeF_col(LBEF)<a name='1487'>
              DUM2=RimeF_col(L)<a name='1488'>
              QLgICE=MAX(0., QI-QSmICE)         <font color=#447700>!-- 1st-guess estimate of large ice<a name='1489'></font>
              RimeF1=(DUM2*THICK*QLgICE+DUM1*BLEND*ASNOW)/TOT_ICE<a name='1490'>
              VCI=GAMMAS*VSNOWI(MDImin)<a name='1491'>
  vel_rime:   IF (RimeF1&lt;=1.) THEN<a name='1492'>
                RimeF1=1.<a name='1493'>
                VrimeF=1.<a name='1494'>
              ELSE   vel_rime<a name='1495'>
<font color=#447700>!--- Prevent rime factor (RimeF1) from exceeding a maximum value (RFmax)<a name='1496'></font>
                RimeF1=MIN(RimeF1, RFmax)<a name='1497'>
                IXS=MAX(2, MIN(INDEXS/100, 9))<a name='1498'>
                XRF=10.492*ALOG(RimeF1)<a name='1499'>
                IXRF=MAX(0, MIN(INT(XRF), Nrime))<a name='1500'>
                IF (IXRF .GE. Nrime) THEN<a name='1501'>
                  VrimeF=VEL_RF(IXS,Nrime)<a name='1502'>
                ELSE<a name='1503'>
                  VrimeF=VEL_RF(IXS,IXRF)+(XRF-FLOAT(IXRF))*            &amp;<a name='1504'>
     &amp;                   (VEL_RF(IXS,IXRF+1)-VEL_RF(IXS,IXRF))<a name='1505'>
                ENDIF<a name='1506'>
              ENDIF   vel_rime<a name='1507'>
              VEL_INC=GAMMAS*VrimeF*SQRT(VrimeF)   <font color=#447700>!-- Faster rimed ice fall speeds<a name='1508'></font>
<font color=#447700>!<a name='1509'></font>
<font color=#447700>!-- Specify NLImax depending on presence of high density ice (rime factors &gt;10)<a name='1510'></font>
<font color=#447700>!<a name='1511'></font>
              IF (RimeF1&gt;10.) THEN<a name='1512'>
                LARGE_RF=.TRUE.        <font color=#447700>!-- Convective precipitation (and sleet)<a name='1513'></font>
                NLImax=1.E3<a name='1514'>
              ELSE<a name='1515'>
                LARGE_RF=.FALSE.       <font color=#447700>!-- Non-convective precipitation<a name='1516'></font>
<font color=#447700>!-- NLImax slowly decreases from 10 L-1 at 0C to 5 L-1 at -40C and colder.<a name='1517'></font>
                DUM=MAX(TC, T_ICE)<a name='1518'>
                NLImax=10.E3*EXP(-0.017*DUM)<a name='1519'>
<font color=#447700>! Based on Aligo's email, added on 2012-02-09<a name='1520'></font>
<font color=#447700>!-- Idea from Greg Thompson to smoothly increase the fall speed of melting snow<a name='1521'></font>
                IF (TC&gt;0.) THEN<a name='1522'>
                  VEL_INC=MAX(VEL_INC, VRabove/VSNOWI(INDEXS) )<a name='1523'>
                ENDIF<a name='1524'>
              ENDIF<a name='1525'>
              HAIL=.FALSE.<a name='1526'>
    two_pass: DO IPASS=1,2<a name='1527'>
                VSNOW=VEL_INC*VSNOWI(INDEXS)<a name='1528'>
                EMAIRI=THICK+BLDTRH*VSNOW<a name='1529'>
                QLICE=(THICK*QLgICE+BLEND*ASNOW)/EMAIRI   <font color=#447700>!-- Final estimate of large ice<a name='1530'></font>
                QTICE=QLICE+QSmICE<a name='1531'>
                FLIMASS=QLICE/QTICE<a name='1532'>
                RQLICE=RHO*QLICE<a name='1533'>
hail_mode:      IF (.NOT. HAIL) THEN<a name='1534'>
                  XLIMASS=RimeF1*MASSI(INDEXS)<a name='1535'>
                  NLICE=RQLICE/XLIMASS              <font color=#447700>!-- NLICE &gt; NLImax<a name='1536'></font>
                ELSE   hail_mode<a name='1537'>
<font color=#447700>!-- Executed only when IPASS=2, RF&gt;10, INDEX=1000, &amp; NLICE=NLImax<a name='1538'></font>
                  XLIMASS=RQLICE/NLICE              <font color=#447700>!-- for debugging only<a name='1539'></font>
                ENDIF  hail_mode<a name='1540'>
                IF (IPASS&gt;=2) THEN<a name='1541'>
                  EXIT  two_pass<a name='1542'>
                ENDIF<a name='1543'>
                DUM=RRHO*NLImin*MASSI(MDImin)    <font color=#447700>!-- Minimum large ice mixing ratio<a name='1544'></font>
                IF (QLICE&lt;=DUM) THEN<a name='1545'>
                  INDEXS=MDImin<a name='1546'>
                  RimeF1=1.<a name='1547'>
                  CYCLE  two_pass    <font color=#447700>!-- Go to top of DO IPASS with IPASS=2<a name='1548'></font>
                ENDIF<a name='1549'>
                IF (NLICE&gt;=NLImin .AND. NLICE&lt;=NLImax) THEN<a name='1550'>
                  EXIT  two_pass<a name='1551'>
                ENDIF<a name='1552'>
<font color=#447700>!<a name='1553'></font>
<font color=#447700>!--- Force NLICE to be between NLImin and NLImax when IPASS=1<a name='1554'></font>
<font color=#447700>!<a name='1555'></font>
                NLICE=MAX(NLImin, MIN(NLImax, NLICE) )<a name='1556'>
                XLI=RQLICE/(NLICE*RimeF1)<a name='1557'>
new_size:       IF (XLI&lt;=MASSI(MDImin) ) THEN<a name='1558'>
                  INDEXS=MDImin<a name='1559'>
                ELSE IF (XLI&lt;=MASSI(450) ) THEN   new_size<a name='1560'>
                  DLI=9.5885E5*XLI**.42066         <font color=#447700>! DLI in microns<a name='1561'></font>
                  INDEXS=MIN(MDImax, MAX(MDImin, INT(DLI) ) )<a name='1562'>
                ELSE IF (XLI&lt;MASSI(MDImax) ) THEN   new_size<a name='1563'>
                  DLI=3.9751E6*XLI**.49870         <font color=#447700>! DLI in microns<a name='1564'></font>
                  INDEXS=MIN(MDImax, MAX(MDImin, INT(DLI) ) )<a name='1565'>
                ELSE  new_size<a name='1566'>
                  INDEXS=MDImax<a name='1567'>
                  IF (LARGE_RF) HAIL=.TRUE.<a name='1568'>
                  IF (PRINT_diag .AND. RQLICE&gt;Revised_LICE) THEN<a name='1569'>
                    WRITE(6,"(5(a12,g11.4,1x))") '{$ RimeF1=',RimeF1,   &amp;<a name='1570'>
     &amp;                ' RHO*QLICE=',RQLICE,' TC=',TC,' NLICE=',NLICE,   &amp;<a name='1571'>
     &amp;                ' NLICEold=',DUM2<a name='1572'>
                    Revised_LICE=1.2*RQLICE<a name='1573'>
                  ENDIF<a name='1574'>
                ENDIF    new_size<a name='1575'>
              ENDDO      two_pass<a name='1576'>
            ENDIF        init_ice<a name='1577'>
          ENDIF          ice_test<a name='1578'>
<font color=#447700>!<a name='1579'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1580'></font>
<font color=#447700>!--------------- Calculate individual processes -----------------------<a name='1581'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1582'></font>
<font color=#447700>!<a name='1583'></font>
<font color=#447700>!--- Cloud water autoconversion to rain (PRAUT) and collection of cloud <a name='1584'></font>
<font color=#447700>!    water by precipitation ice (PIACW)<a name='1585'></font>
<font color=#447700>!    <a name='1586'></font>
          IF (QW.GT.EPSQ .AND. TC.GE.T_ICE) THEN<a name='1587'>
<font color=#447700>!<a name='1588'></font>
<font color=#447700>!-- July 2010 version follows Liu &amp; Daum (JAS, 2004) and Liu et al. (JAS, 2006)<a name='1589'></font>
<font color=#447700>!<a name='1590'></font>
            DUM=BRAUT*RHO*RHO*QW*QW*QW<a name='1591'>
            DUM1=ARAUT*RHO*RHO*QW*QW<a name='1592'>
            PRAUT=MIN(QW, DUM*(1.-EXP(-DUM1*DUM1)) )<a name='1593'>
            IF (QLICE .GT. EPSQ) THEN<a name='1594'>
      <font color=#447700>!<a name='1595'></font>
      <font color=#447700>!--- Collection of cloud water by large ice particles ("snow")<a name='1596'></font>
      <font color=#447700>!    PIACWI=PIACW for riming, PIACWI=0 for shedding<a name='1597'></font>
      <font color=#447700>!<a name='1598'></font>
              FWS=MIN(1., CIACW*VEL_INC*NLICE*ACCRI(INDEXS)/PP**C1)<a name='1599'>
              PIACW=FWS*QW<a name='1600'>
              IF (TC .LT. 0.) PIACWI=PIACW    <font color=#447700>! Large ice riming<a name='1601'></font>
            ENDIF           <font color=#447700>! End IF (QLICE .GT. EPSQ)<a name='1602'></font>
          ENDIF             <font color=#447700>! End IF (QW.GT.EPSQ .AND. TC.GE.T_ICE)<a name='1603'></font>
<font color=#447700>!<a name='1604'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1605'></font>
<font color=#447700>!--- Loop around some of the ice-phase processes if no ice should be present<a name='1606'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1607'></font>
<font color=#447700>!<a name='1608'></font>
          IF (ICE_logical .EQV. .FALSE.) GO TO 20<a name='1609'>
<font color=#447700>!<a name='1610'></font>
<font color=#447700>!--- Now the pretzel logic of calculating ice deposition<a name='1611'></font>
<font color=#447700>!<a name='1612'></font>
          IF (TC.LT.T_ICE .AND. (WV.GT.QSWgrd .OR. QW.GT.EPSQ)) THEN<a name='1613'>
   <font color=#447700>!<a name='1614'></font>
   <font color=#447700>!--- Adjust to ice saturation at T&lt;T_ICE (-40C) if saturated w/r/t water<a name='1615'></font>
   <font color=#447700>!    or if cloud water is present (homogeneous glaciation).<a name='1616'></font>
   <font color=#447700>!    <a name='1617'></font>
            PIACW=QW<a name='1618'>
            PIACWI=PIACW<a name='1619'>
            DUM1=TK+XLF1*PIACW                 <font color=#447700>! Updated (dummy) temperature (deg K)<a name='1620'></font>
            DUM2=WV                            <font color=#447700>! Updated (dummy) water vapor mixing ratio<a name='1621'></font>
            DUM=MIN(1000.*FPVS(DUM1),0.99*PP)  <font color=#447700>! Updated (dummy) saturation vapor pressure w/r/t ice<a name='1622'></font>
            DUM=RHgrd*EPS*DUM/(PP-DUM)         <font color=#447700>! Updated (dummy) saturation mixing ratio w/r/t ice<a name='1623'></font>
<a name='1624'>
<font color=#447700>!-- Debug 20120111<a name='1625'></font>
IF (WARN1 .AND. DUM1&lt;XMIN) THEN<a name='1626'>
   WRITE(0,*) 'WARN1: Water saturation T&lt;180K; I,J,L,TC,P=',   &amp;<a name='1627'>
              I_index,J_index,L,DUM1-T0C,.01*PP<a name='1628'>
   WARN1=.FALSE.<a name='1629'>
ENDIF<a name='1630'>
            IF (DUM2&gt;DUM) THEN<a name='1631'>
               PIDEP=<A href='../../html_code/phys/module_mp_HWRF.F.html#DEPOSIT'>DEPOSIT</A><A href='../../html_code/phys/module_mp_HWRF.F.html#EGCP01COLUMN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEPOSIT_1">(PP,DUM1,DUM2,RHgrd,I_index,J_index,L)    <font color=#447700>!GFDL<a name='1632'></font>
            ENDIF<a name='1633'>
            DWVi=0.    <font color=#447700>! Used only for debugging<a name='1634'></font>
   <font color=#447700>!<a name='1635'></font>
          ELSE IF (TC .LT. 0.) THEN<a name='1636'>
   <font color=#447700>!<a name='1637'></font>
   <font color=#447700>!--- These quantities are handy for ice deposition/sublimation<a name='1638'></font>
   <font color=#447700>!    PIDEP_max - max deposition or minimum sublimation to ice saturation<a name='1639'></font>
   <font color=#447700>!<a name='1640'></font>
            DENOMI=1.+XLS2*QSI*TK2<a name='1641'>
            DWVi=MIN(WV,QSW)-QSIgrd<a name='1642'>
            PIDEP_max=MAX(PILOSS, DWVi/DENOMI)<a name='1643'>
            DIDEP=0.     <font color=#447700>!-- Vapor deposition/sublimation onto existing ice<a name='1644'></font>
            PINT=0.      <font color=#447700>!-- Ice initiation (part of PIDEP calculation, kg/kg)<a name='1645'></font>
            IF (QTICE .GT. 0.) THEN<a name='1646'>
      <font color=#447700>!<a name='1647'></font>
      <font color=#447700>!--- Calculate ice deposition/sublimation<a name='1648'></font>
      <font color=#447700>!      * SFACTOR - [VEL_INC**.5]*[Schmidt**(1./3.)]*[(RHO/DYNVIS)**.5],<a name='1649'></font>
      <font color=#447700>!        where Schmidt (Schmidt Number) =DYNVIS/(RHO*DIFFUS)<a name='1650'></font>
      <font color=#447700>!      * Units: SFACTOR - s**.5/m ;  ABI - m**2/s ;  NLICE - m**-3 ;<a name='1651'></font>
      <font color=#447700>!               VENTIL, VENTIS - m**-2 ;  VENTI1 - m ;  <a name='1652'></font>
      <font color=#447700>!               VENTI2 - m**2/s**.5 ; DIDEP - unitless<a name='1653'></font>
      <font color=#447700>!<a name='1654'></font>
              SFACTOR=SQRT(VEL_INC)*(RHO/(DIFFUS*DIFFUS*DYNVIS))**C2<a name='1655'>
              ABI=1./(RHO*XLS3*QSI*TK2/THERM_COND+1./DIFFUS)<a name='1656'>
      <font color=#447700>!<a name='1657'></font>
      <font color=#447700>!--- VENTIL - Number concentration * ventilation factors for large ice<a name='1658'></font>
      <font color=#447700>!--- VENTIS - Number concentration * ventilation factors for small ice<a name='1659'></font>
      <font color=#447700>!<a name='1660'></font>
      <font color=#447700>!--- Variation in the number concentration of ice with time is not<a name='1661'></font>
      <font color=#447700>!      accounted for in these calculations (could be in the future).<a name='1662'></font>
      <font color=#447700>!<a name='1663'></font>
              VENTIL=(VENTI1(INDEXS)+SFACTOR*VENTI2(INDEXS))*NLICE<a name='1664'>
              VENTIS=(VENTI1(MDImin)+SFACTOR*VENTI2(MDImin))*NSmICE<a name='1665'>
              DIDEP=ABI*(VENTIL+VENTIS)*DTPH<a name='1666'>
              IF (DIDEP&gt;=Xratio) DIDEP=(1.-EXP(-DIDEP*DENOMI))/DENOMI<a name='1667'>
            ENDIF   <font color=#447700>!-- IF (QTICE .GT. 0.) THEN<a name='1668'></font>
      <font color=#447700>!<a name='1669'></font>
      <font color=#447700>!--- WARNING: the Meyers et al. stuff is not used!<a name='1670'></font>
      <font color=#447700>!--- Two modes of ice nucleation from Meyers et al. (JAM, 1992):<a name='1671'></font>
      <font color=#447700>!      (1) Deposition &amp; condensation freezing nucleation - eq. (2.4),<a name='1672'></font>
      <font color=#447700>!          requires ice supersaturation<a name='1673'></font>
      <font color=#447700>!      (2) Contact freezing nucleation - eq. (2.6), requires presence<a name='1674'></font>
      <font color=#447700>!          of cloud water<a name='1675'></font>
      <font color=#447700>!<a name='1676'></font>
      <font color=#447700>!--- Ice crystal growth during the physics time step is calculated using<a name='1677'></font>
      <font color=#447700>!    Miller &amp; Young (1979, JAS) and is represented by MY_GROWTH(INDEX_MY),<a name='1678'></font>
      <font color=#447700>!    where INDEX_MY is tabulated air temperatures between -1 and -35 C.<a name='1679'></font>
      <font color=#447700>!    The original Miller &amp; Young (MY) calculations only went down to -30C,<a name='1680'></font>
      <font color=#447700>!    so a fixed value is assumed at temperatures colder than -30C.<a name='1681'></font>
      <font color=#447700>!<a name='1682'></font>
      <font color=#447700>!--- Sensitivity test using:<a name='1683'></font>
      <font color=#447700>!    - Fletcher (1962) for ice initiation<a name='1684'></font>
      <font color=#447700>!    - Can occur only when there is water supersaturation and T&lt;-12C.<a name='1685'></font>
      <font color=#447700>!    - Maximum cloud ice number concentration of NSImax<a name='1686'></font>
      <font color=#447700>!<a name='1687'></font>
            IF (WV&gt;QSWgrd .AND. TC&lt;T_ICE_init .AND. NSmICE&lt;NInuclei) THEN<a name='1688'>
              INDEX_MY=MAX(MY_T1, MIN( INT(.5-TC), MY_T2 ) )<a name='1689'>
      <font color=#447700>!-- Only initiate small ice to get to NInuclei number concentrations<a name='1690'></font>
              DUM=MAX(0., NInuclei-NSmICE)*MY_GROWTH(INDEX_MY)*RRHO<a name='1691'>
              PINT=MAX(0., DUM)<a name='1692'>
            ENDIF<a name='1693'>
      <font color=#447700>!<a name='1694'></font>
      <font color=#447700>!--- Calculate PIDEP, but also account for limited water vapor supply<a name='1695'></font>
      <font color=#447700>!<a name='1696'></font>
            IF (DWVi&gt;0.) THEN<a name='1697'>
              PIDEP=MIN(DWVI*DIDEP+PINT, PIDEP_max)<a name='1698'>
            ELSE IF (DWVi&lt;0.) THEN<a name='1699'>
              PIDEP=MAX(DWVi*DIDEP, PIDEP_max)<a name='1700'>
            ENDIF<a name='1701'>
   <font color=#447700>!<a name='1702'></font>
          ENDIF         <font color=#447700>! End IF (TC.LT.T_ICE .AND. (WV.GT.QSWgrd .OR. QW.GT.EPSQ))<a name='1703'></font>
<font color=#447700>!<a name='1704'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='1705'></font>
<font color=#447700>!<a name='1706'></font>
20      CONTINUE     <font color=#447700>! Jump here if conditions for ice are not present<a name='1707'></font>
<font color=#447700>!<a name='1708'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='1709'></font>
<font color=#447700>!<a name='1710'></font>
<font color=#447700>!--- Cloud water condensation<a name='1711'></font>
<font color=#447700>!<a name='1712'></font>
          IF (TC.GE.T_ICE .AND. (QW.GT.EPSQ .OR. WV.GT.QSWgrd)) THEN<a name='1713'>
            IF (PIACWI.EQ.0. .AND. PIDEP.EQ.0.) THEN<a name='1714'>
              PCOND=CONDENSE (PP, QW, TK, WV, RHgrd,I_index,J_index,L)   <font color=#447700>!GFDL<a name='1715'></font>
            ELSE<a name='1716'>
   <font color=#447700>!<a name='1717'></font>
   <font color=#447700>!--- Modify cloud condensation in response to ice processes<a name='1718'></font>
   <font color=#447700>!<a name='1719'></font>
              DUM=XLV*QSWgrd*RCPRV*TK2<a name='1720'>
              DENOMWI=1.+XLS*DUM<a name='1721'>
              DENOMF=XLF*DUM<a name='1722'>
              DUM=MAX(0., PIDEP)<a name='1723'>
              PCOND=(WV-QSWgrd-DENOMWI*DUM-DENOMF*PIACWI)/DENOMW<a name='1724'>
              DUM1=-QW<a name='1725'>
              DUM2=PCOND-PIACW<a name='1726'>
              IF (DUM2 .LT. DUM1) THEN<a name='1727'>
      <font color=#447700>!<a name='1728'></font>
      <font color=#447700>!--- Limit cloud water sinks<a name='1729'></font>
      <font color=#447700>!<a name='1730'></font>
                DUM=DUM1/DUM2<a name='1731'>
                PCOND=DUM*PCOND<a name='1732'>
                PIACW=DUM*PIACW<a name='1733'>
                PIACWI=DUM*PIACWI<a name='1734'>
              ENDIF        <font color=#447700>! End IF (DUM2 .LT. DUM1)<a name='1735'></font>
            ENDIF          <font color=#447700>! End IF (PIACWI.EQ.0. .AND. PIDEP.EQ.0.)<a name='1736'></font>
          ENDIF            <font color=#447700>! End IF (TC.GE.T_ICE .AND. (QW.GT.EPSQ .OR. WV.GT.QSWgrd))<a name='1737'></font>
<font color=#447700>!<a name='1738'></font>
<font color=#447700>!--- Limit freezing of accreted rime to prevent temperature oscillations,<a name='1739'></font>
<font color=#447700>!    a crude Schumann-Ludlam limit (p. 209 of Young, 1993). <a name='1740'></font>
<font color=#447700>!<a name='1741'></font>
          TCC=TC+XLV1*PCOND+XLS1*PIDEP+XLF1*PIACWI<a name='1742'>
          IF (TCC .GT. 0.) THEN<a name='1743'>
            PIACWI=0.<a name='1744'>
            TCC=TC+XLV1*PCOND+XLS1*PIDEP<a name='1745'>
          ENDIF<a name='1746'>
          QSW0=0.<a name='1747'>
          IF (TC.GT.0. .AND. TCC.GT.0. .AND. ICE_logical) THEN<a name='1748'>
   <font color=#447700>!<a name='1749'></font>
   <font color=#447700>!--- Calculate melting and evaporation/condensation<a name='1750'></font>
   <font color=#447700>!      * Units: SFACTOR - s**.5/m ;  ABI - m**2/s ;  NLICE - m**-3 ;<a name='1751'></font>
   <font color=#447700>!               VENTIL - m**-2 ;  VENTI1 - m ;  <a name='1752'></font>
   <font color=#447700>!               VENTI2 - m**2/s**.5 ; CIEVP - /s<a name='1753'></font>
   <font color=#447700>!<a name='1754'></font>
            SFACTOR=SQRT(VEL_INC)*(RHO/(DIFFUS*DIFFUS*DYNVIS))**C2<a name='1755'>
            VENTIL=NLICE*(VENTI1(INDEXS)+SFACTOR*VENTI2(INDEXS))<a name='1756'>
            AIEVP=VENTIL*DIFFUS*DTPH<a name='1757'>
            IF (AIEVP .LT. Xratio) THEN<a name='1758'>
              DIEVP=AIEVP<a name='1759'>
            ELSE<a name='1760'>
              DIEVP=1.-EXP(-AIEVP)<a name='1761'>
            ENDIF<a name='1762'>
            QSW0=EPS*ESW0/(PP-ESW0)<a name='1763'>
            DWV0=MIN(WV,QSW)-QSW0<a name='1764'>
            DUM=QW+PCOND<a name='1765'>
            IF (WV.LT.QSW .AND. DUM.LE.EPSQ) THEN<a name='1766'>
   <font color=#447700>!<a name='1767'></font>
   <font color=#447700>!--- Evaporation from melting snow (sink of snow) or shedding<a name='1768'></font>
   <font color=#447700>!    of water condensed onto melting snow (source of rain)<a name='1769'></font>
   <font color=#447700>!<a name='1770'></font>
              DUM=DWV0*DIEVP<a name='1771'>
              PIEVP=MAX( MIN(0., DUM), PILOSS)<a name='1772'>
              PICND=MAX(0., DUM)<a name='1773'>
            ENDIF            <font color=#447700>! End IF (WV.LT.QSW .AND. DUM.LE.EPSQ)<a name='1774'></font>
            PIMLT=THERM_COND*TCC*VENTIL*RRHO*DTPH/XLF<a name='1775'>
   <font color=#447700>!<a name='1776'></font>
   <font color=#447700>!--- Limit melting to prevent temperature oscillations across 0C<a name='1777'></font>
   <font color=#447700>!<a name='1778'></font>
            DUM1=MAX( 0., (TCC+XLV1*PIEVP)/XLF1 )<a name='1779'>
            PIMLT=MIN(PIMLT, DUM1)<a name='1780'>
   <font color=#447700>!<a name='1781'></font>
   <font color=#447700>!--- Limit loss of snow by melting (&gt;0) and evaporation<a name='1782'></font>
   <font color=#447700>!<a name='1783'></font>
            DUM=PIEVP-PIMLT<a name='1784'>
            IF (DUM .LT. PILOSS) THEN<a name='1785'>
              DUM1=PILOSS/DUM<a name='1786'>
              PIMLT=PIMLT*DUM1<a name='1787'>
              PIEVP=PIEVP*DUM1<a name='1788'>
            ENDIF           <font color=#447700>! End IF (DUM .GT. QTICE)<a name='1789'></font>
          ENDIF             <font color=#447700>! End IF (TC.GT.0. .AND. TCC.GT.0. .AND. ICE_logical) <a name='1790'></font>
<font color=#447700>!<a name='1791'></font>
<font color=#447700>!--- IMPORTANT:  Estimate time-averaged properties.<a name='1792'></font>
<font color=#447700>!<a name='1793'></font>
<font color=#447700>!  * TOT_RAIN - total mass of rain before microphysics, which is the sum of<a name='1794'></font>
<font color=#447700>!               the total mass of rain in the current layer and the input <a name='1795'></font>
<font color=#447700>!               flux of rain from above<a name='1796'></font>
<font color=#447700>!  * VRAIN1   - fall speed of rain into grid from above (with air resistance correction)<a name='1797'></font>
<font color=#447700>!  * QTRAIN   - time-averaged mixing ratio of rain (kg/kg)<a name='1798'></font>
<font color=#447700>!  * PRLOSS   - greatest loss (&lt;0) of rain, removing all rain falling from<a name='1799'></font>
<font color=#447700>!               above and the rain within the layer<a name='1800'></font>
<font color=#447700>!  * RQR      - rain content (kg/m**3)<a name='1801'></font>
<font color=#447700>!  * INDEXR   - mean size of rain drops to the nearest 1 micron in size<a name='1802'></font>
<font color=#447700>!  * N0r      - intercept of rain size distribution (typically 10**6 m**-4)<a name='1803'></font>
<font color=#447700>!<a name='1804'></font>
          TOT_RAIN=0.<a name='1805'>
          VRAIN1=0.<a name='1806'>
          QTRAIN=0.<a name='1807'>
          PRLOSS=0.<a name='1808'>
          RQR=0.<a name='1809'>
          N0r=0.<a name='1810'>
          INDEXR=MDRmin<a name='1811'>
          INDEXR1=INDEXR    <font color=#447700>!-- For debugging only<a name='1812'></font>
          IF (RAIN_logical) THEN<a name='1813'>
            IF (ARAIN .LE. 0.) THEN<a name='1814'>
              INDEXR=MDRmin<a name='1815'>
              VRAIN1=0.<a name='1816'>
            ELSE<a name='1817'>
   <font color=#447700>!<a name='1818'></font>
   <font color=#447700>!--- INDEXR (related to mean diameter) &amp; N0r could be modified <a name='1819'></font>
   <font color=#447700>!      by land/sea properties, presence of convection, etc.<a name='1820'></font>
   <font color=#447700>!<a name='1821'></font>
   <font color=#447700>!--- Rain rate normalized to a density of 1.194 kg/m**3<a name='1822'></font>
   <font color=#447700>!<a name='1823'></font>
              RR=ARAIN/(DTPH*GAMMAR)<a name='1824'>
   <font color=#447700>!--- Integer function to estimate the mean size of the raindrops in microns<a name='1825'></font>
              INDEXR=<A href='../../html_code/phys/module_mp_fer_hires.F.html#GET_INDEXR'>GET_INDEXR</A><A href='../../html_code/phys/module_mp_HWRF.F.html#EGCP01COLUMN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_INDEXR_1">(RR)<a name='1826'>
              VRAIN1=GAMMAR*VRAIN(INDEXR)<a name='1827'>
            ENDIF              <font color=#447700>! End IF (ARAIN .LE. 0.)<a name='1828'></font>
            INDEXR1=INDEXR     <font color=#447700>! For debugging only<a name='1829'></font>
            TOT_RAIN=THICK*QR+BLEND*ARAIN<a name='1830'>
            QTRAIN=TOT_RAIN/(THICK+BLDTRH*VRAIN1)<a name='1831'>
            PRLOSS=-TOT_RAIN/THICK<a name='1832'>
            RQR=RHO*QTRAIN<a name='1833'>
   <font color=#447700>!<a name='1834'></font>
   <font color=#447700>!--- RQR - time-averaged rain content (kg/m**3)<a name='1835'></font>
   <font color=#447700>!<a name='1836'></font>
            IF (RQR .LE. RQR_DRmin) THEN<a name='1837'>
              N0r=MAX(N0rmin, CN0r_DMRmin*RQR)<a name='1838'>
              INDEXR=MDRmin<a name='1839'>
            ELSE IF (RQR .GE. RQR_DRmax) THEN<a name='1840'>
              N0r=CN0r_DMRmax*RQR<a name='1841'>
              INDEXR=MDRmax<a name='1842'>
            ELSE<a name='1843'>
              N0r=N0r0<a name='1844'>
              DUM=SQRT(SQRT(RQR))<a name='1845'>
              INDEXR=MAX( XMRmin, MIN(CN0r0*DUM, XMRmax) )<a name='1846'>
            ENDIF<a name='1847'>
   <font color=#447700>!<a name='1848'></font>
            IF (TC .LT. T_ICE) THEN<a name='1849'>
              PIACR=-PRLOSS<a name='1850'>
            ELSE<a name='1851'>
<font color=#447700>!GFDL              DWVr=WV-PCOND-QSW<a name='1852'></font>
              DWVr=WV-PCOND-QSWgrd   <font color=#447700>!GFDL<a name='1853'></font>
              DUM=QW+PCOND<a name='1854'>
              IF (DWVr.LT.0. .AND. DUM.LE.EPSQ) THEN<a name='1855'>
      <font color=#447700>!<a name='1856'></font>
      <font color=#447700>!--- Rain evaporation<a name='1857'></font>
      <font color=#447700>!<a name='1858'></font>
      <font color=#447700>!    * RFACTOR - [GAMMAR**.5]*[Schmidt**(1./3.)]*[(RHO/DYNVIS)**.5],<a name='1859'></font>
      <font color=#447700>!        where Schmidt (Schmidt Number) =DYNVIS/(RHO*DIFFUS)<a name='1860'></font>
      <font color=#447700>!<a name='1861'></font>
      <font color=#447700>!    * Units: RFACTOR - s**.5/m ;  ABW - m**2/s ;  VENTR - m**-2 ;  <a name='1862'></font>
      <font color=#447700>!             N0r - m**-4 ;  VENTR1 - m**2 ;  VENTR2 - m**3/s**.5 ;<a name='1863'></font>
      <font color=#447700>!             CREVP - unitless<a name='1864'></font>
      <font color=#447700>!<a name='1865'></font>
                RFACTOR=SQRT(GAMMAR)*(RHO/(DIFFUS*DIFFUS*DYNVIS))**C2<a name='1866'>
                ABW=1./(RHO*XLV2/THERM_COND+1./DIFFUS)<a name='1867'>
      <font color=#447700>!<a name='1868'></font>
      <font color=#447700>!--- Note that VENTR1, VENTR2 lookup tables do not include the <a name='1869'></font>
      <font color=#447700>!      1/Davg multiplier as in the ice tables<a name='1870'></font>
      <font color=#447700>!<a name='1871'></font>
                VENTR=N0r*(VENTR1(INDEXR)+RFACTOR*VENTR2(INDEXR))<a name='1872'>
                CREVP=ABW*VENTR*DTPH<a name='1873'>
                IF (CREVP .LT. Xratio) THEN<a name='1874'>
                  DUM=DWVr*CREVP<a name='1875'>
                ELSE<a name='1876'>
                  DUM=DWVr*(1.-EXP(-CREVP*DENOMW))/DENOMW<a name='1877'>
                ENDIF<a name='1878'>
                PREVP=MAX(DUM, PRLOSS)<a name='1879'>
              ELSE IF (QW .GT. EPSQ) THEN<a name='1880'>
                FWR=CRACW*GAMMAR*N0r*ACCRR(INDEXR)<a name='1881'>
                PRACW=MIN(1.,FWR)*QW<a name='1882'>
              ENDIF           <font color=#447700>! End IF (DWVr.LT.0. .AND. DUM.LE.EPSQ)<a name='1883'></font>
      <font color=#447700>!<a name='1884'></font>
              IF (ICE_logical .AND. TC&lt;0. .AND. TCC&lt;0.) THEN<a name='1885'>
         <font color=#447700>!<a name='1886'></font>
         <font color=#447700>!--- Biggs (1953) heteorogeneous freezing (e.g., Lin et al., 1983)<a name='1887'></font>
         <font color=#447700>!   - Rescaled mean drop diameter from microns (INDEXR) to mm (DUM) to prevent underflow<a name='1888'></font>
         <font color=#447700>!<a name='1889'></font>
                DUM=.001*FLOAT(INDEXR)<a name='1890'>
                DUM=(EXP(ABFR*TC)-1.)*DUM*DUM*DUM*DUM*DUM*DUM*DUM<a name='1891'>
                PIACR=MIN(CBFR*N0r*RRHO*DUM, QTRAIN)<a name='1892'>
                IF (QLICE .GT. EPSQ) THEN<a name='1893'>
            <font color=#447700>!<a name='1894'></font>
            <font color=#447700>!--- Freezing of rain by collisions w/ large ice<a name='1895'></font>
            <font color=#447700>!<a name='1896'></font>
                  DUM=GAMMAR*VRAIN(INDEXR)<a name='1897'>
                  DUM1=DUM-VSNOW<a name='1898'>
            <font color=#447700>!<a name='1899'></font>
            <font color=#447700>!--- DUM2 - Difference in spectral fall speeds of rain and<a name='1900'></font>
            <font color=#447700>!      large ice, parameterized following eq. (48) on p. 112 of <a name='1901'></font>
            <font color=#447700>!      Murakami (J. Meteor. Soc. Japan, 1990)<a name='1902'></font>
            <font color=#447700>!<a name='1903'></font>
                  DUM2=SQRT(DUM1*DUM1+.04*DUM*VSNOW)<a name='1904'>
                  DUM1=5.E-12*INDEXR*INDEXR+2.E-12*INDEXR*INDEXS        &amp;<a name='1905'>
     &amp;                 +.5E-12*INDEXS*INDEXS<a name='1906'>
                  FIR=MIN(1., CIACR*NLICE*DUM1*DUM2)<a name='1907'>
            <font color=#447700>!<a name='1908'></font>
            <font color=#447700>!--- Future?  Should COLLECTION BY SMALL ICE BE INCLUDED???<a name='1909'></font>
            <font color=#447700>!<a name='1910'></font>
                  PIACR=MIN(PIACR+FIR*QTRAIN, QTRAIN)<a name='1911'>
                ENDIF        <font color=#447700>! End IF (QLICE .GT. EPSQ)<a name='1912'></font>
                DUM=PREVP-PIACR<a name='1913'>
                If (DUM .LT. PRLOSS) THEN<a name='1914'>
                  DUM1=PRLOSS/DUM<a name='1915'>
                  PREVP=DUM1*PREVP<a name='1916'>
                  PIACR=DUM1*PIACR<a name='1917'>
                ENDIF        <font color=#447700>! End If (DUM .LT. PRLOSS)<a name='1918'></font>
              ENDIF          <font color=#447700>! End IF (TC.LT.0. .AND. TCC.LT.0.)<a name='1919'></font>
            ENDIF            <font color=#447700>! End IF (TC .LT. T_ICE)<a name='1920'></font>
          ENDIF              <font color=#447700>! End IF (RAIN_logical) <a name='1921'></font>
<font color=#447700>!<a name='1922'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1923'></font>
<font color=#447700>!---------------------- Main Budget Equations -------------------------<a name='1924'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1925'></font>
<font color=#447700>!<a name='1926'></font>
<font color=#447700>!<a name='1927'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1928'></font>
<font color=#447700>!--- Update fields, determine characteristics for next lower layer ----<a name='1929'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1930'></font>
<font color=#447700>!<a name='1931'></font>
<font color=#447700>!--- Carefully limit sinks of cloud water<a name='1932'></font>
<font color=#447700>!<a name='1933'></font>
          DUM1=PIACW+PRAUT+PRACW-MIN(0.,PCOND)<a name='1934'>
          IF (DUM1 .GT. QW) THEN<a name='1935'>
            DUM=QW/DUM1<a name='1936'>
            PIACW=DUM*PIACW<a name='1937'>
            PIACWI=DUM*PIACWI<a name='1938'>
            PRAUT=DUM*PRAUT<a name='1939'>
            PRACW=DUM*PRACW<a name='1940'>
            IF (PCOND .LT. 0.) PCOND=DUM*PCOND<a name='1941'>
          ENDIF<a name='1942'>
          PIACWR=PIACW-PIACWI          <font color=#447700>! TC &gt;= 0C<a name='1943'></font>
<font color=#447700>!<a name='1944'></font>
<font color=#447700>!--- QWnew - updated cloud water mixing ratio<a name='1945'></font>
<font color=#447700>!<a name='1946'></font>
          DELW=PCOND-PIACW-PRAUT-PRACW<a name='1947'>
          QWnew=QW+DELW<a name='1948'>
          IF (QWnew .LE. EPSQ) QWnew=0.<a name='1949'>
          IF (QW.GT.0. .AND. QWnew.NE.0.) THEN<a name='1950'>
            DUM=QWnew/QW<a name='1951'>
            IF (DUM .LT. TOLER) QWnew=0.<a name='1952'>
          ENDIF<a name='1953'>
<font color=#447700>!<a name='1954'></font>
<font color=#447700>!--- Update temperature and water vapor mixing ratios<a name='1955'></font>
<font color=#447700>!<a name='1956'></font>
          DELT= XLV1*(PCOND+PIEVP+PICND+PREVP)                          &amp;<a name='1957'>
     &amp;         +XLS1*PIDEP+XLF1*(PIACWI+PIACR-PIMLT)<a name='1958'>
          Tnew=TK+DELT<a name='1959'>
<font color=#447700>!<a name='1960'></font>
          DELV=-PCOND-PIDEP-PIEVP-PICND-PREVP<a name='1961'>
          WVnew=WV+DELV<a name='1962'>
<font color=#447700>!<a name='1963'></font>
<font color=#447700>!--- Update ice mixing ratios<a name='1964'></font>
<font color=#447700>!<a name='1965'></font>
<font color=#447700>!---<a name='1966'></font>
<font color=#447700>!  * TOT_ICEnew - total mass (small &amp; large) ice after microphysics,<a name='1967'></font>
<font color=#447700>!                 which is the sum of the total mass of ice in the <a name='1968'></font>
<font color=#447700>!                 layer and the flux of ice out of the grid box below<a name='1969'></font>
<font color=#447700>!  * RimeF      - Rime Factor, which is the mass ratio of total (unrimed &amp; <a name='1970'></font>
<font color=#447700>!                 rimed) ice mass to the unrimed ice mass (&gt;=1)<a name='1971'></font>
<font color=#447700>!  * QInew      - updated mixing ratio of total (large &amp; small) ice in layer<a name='1972'></font>
<font color=#447700>!  * QLICEnew=FLIMASS*QInew, an estimate of the updated large ice mixing ratio<a name='1973'></font>
<font color=#447700>!<a name='1974'></font>
<font color=#447700>!  -&gt; TOT_ICEnew=QInew*THICK+QLICEnew*BLDTRH*VSNOW+(QInew-QLICEnew)*BLDTRH*VCI<a name='1975'></font>
<font color=#447700>!               =QInew*THICK+QInew*FLIMASS*BLDTRH*VSNOW+QInew*(1.-FLIMASS)*BLDTRH*VCI<a name='1976'></font>
<font color=#447700>!               =QInew*THICK+QInew*BLDTRH*(FLIMASS*VSNOW+(1.-FLIMASS)*VCI)<a name='1977'></font>
<font color=#447700>!               =QInew*(THICK+BLDTRH*(FLIMASS*VSNOW+(1.-FLIMASS)*VCI))<a name='1978'></font>
<font color=#447700>!  -&gt; Rearranging this equation gives:<a name='1979'></font>
<font color=#447700>!     QInew=TOT_ICEnew/(THICK+BLDTRH*(FLIMASS*VSNOW+(1.-FLIMASS)*VCI))<a name='1980'></font>
<font color=#447700>!<a name='1981'></font>
<font color=#447700>!  * ASNOWnew   - updated accumulation of snow and cloud ice at bottom of grid cell<a name='1982'></font>
<font color=#447700>!      -&gt; ASNOWnew=QInew*BLDTRH*(FLIMASS+VSNOW+(1.-FLIMASS)*VCI)<a name='1983'></font>
<font color=#447700>!---<a name='1984'></font>
<font color=#447700>!<a name='1985'></font>
          DELI=0.<a name='1986'>
          RimeF=1.<a name='1987'>
          IF (ICE_logical) THEN<a name='1988'>
            DELI=PIDEP+PIEVP+PIACWI+PIACR-PIMLT<a name='1989'>
            TOT_ICEnew=TOT_ICE+THICK*DELI<a name='1990'>
            IF (TOT_ICE.GT.0. .AND. TOT_ICEnew.NE.0.) THEN<a name='1991'>
              DUM=TOT_ICEnew/TOT_ICE<a name='1992'>
              IF (DUM .LT. TOLER) TOT_ICEnew=0.<a name='1993'>
            ENDIF<a name='1994'>
            IF (TOT_ICEnew .LE. CLIMIT) THEN<a name='1995'>
              TOT_ICEnew=0.<a name='1996'>
              RimeF=1.<a name='1997'>
              QInew=0.<a name='1998'>
              ASNOWnew=0.<a name='1999'>
            ELSE<a name='2000'>
      <font color=#447700>!<a name='2001'></font>
      <font color=#447700>!--- Update rime factor if appropriate<a name='2002'></font>
      <font color=#447700>!<a name='2003'></font>
              DUM=PIACWI+PIACR<a name='2004'>
              IF (DUM.LE.EPSQ .AND. PIDEP.LE.EPSQ) THEN<a name='2005'>
                RimeF=RimeF1<a name='2006'>
              ELSE<a name='2007'>
         <font color=#447700>!<a name='2008'></font>
         <font color=#447700>!--- Rime Factor, RimeF = (Total ice mass)/(Total unrimed ice mass)<a name='2009'></font>
         <font color=#447700>!      DUM1 - Total ice mass, rimed &amp; unrimed<a name='2010'></font>
         <font color=#447700>!      DUM2 - Estimated mass of *unrimed* ice<a name='2011'></font>
         <font color=#447700>!      DUM3 - Ice deposition (&gt;0), except =0 if RF&gt;10 &amp; TC&gt;=T_ICE_init<a name='2012'></font>
         <font color=#447700>!<a name='2013'></font>
                IF (RimeF1&gt;10. .AND. TC&gt;=T_ICE) THEN<a name='2014'>
                  DUM3=0.<a name='2015'>
                ELSE<a name='2016'>
                  DUM3=MAX(0., PIDEP)<a name='2017'>
                ENDIF<a name='2018'>
                DUM1=TOT_ICE+THICK*(DUM3+DUM)<a name='2019'>
                DUM2=TOT_ICE/RimeF1+THICK*DUM3<a name='2020'>
                IF (DUM2 .LE. 0.) THEN<a name='2021'>
                  RimeF=RFmax<a name='2022'>
                ELSE<a name='2023'>
                  RimeF=MIN(RFmax, MAX(1., DUM1/DUM2) )<a name='2024'>
                ENDIF<a name='2025'>
              ENDIF       <font color=#447700>! End IF (DUM.LE.EPSQ .AND. PIDEP.LE.EPSQ)<a name='2026'></font>
              DUM1=BLDTRH*(FLIMASS*VSNOW+(1.-FLIMASS)*VCI)<a name='2027'>
              QInew=TOT_ICEnew/(THICK+DUM1)<a name='2028'>
              IF (QInew .LE. EPSQ) QInew=0.<a name='2029'>
              IF (QI.GT.0. .AND. QInew.NE.0.) THEN<a name='2030'>
                DUM=QInew/QI<a name='2031'>
                IF (DUM .LT. TOLER) QInew=0.<a name='2032'>
              ENDIF<a name='2033'>
              ASNOWnew=QInew*DUM1<a name='2034'>
              IF (ASNOW.GT.0. .AND. ASNOWnew.NE.0.) THEN<a name='2035'>
                DUM=ASNOWnew/ASNOW<a name='2036'>
                IF (DUM .LT. TOLER) ASNOWnew=0.<a name='2037'>
              ENDIF<a name='2038'>
            ENDIF         <font color=#447700>! End IF (TOT_ICEnew .LE. CLIMIT)<a name='2039'></font>
          ENDIF           <font color=#447700>! End IF (ICE_logical)<a name='2040'></font>
<a name='2041'>
<font color=#447700>!<a name='2042'></font>
<font color=#447700>!--- Update rain mixing ratios<a name='2043'></font>
<font color=#447700>!<a name='2044'></font>
<font color=#447700>!---<a name='2045'></font>
<font color=#447700>! * TOT_RAINnew - total mass of rain after microphysics<a name='2046'></font>
<font color=#447700>!                 current layer and the input flux of ice from above<a name='2047'></font>
<font color=#447700>! * VRAIN2      - time-averaged fall speed of rain in grid and below <a name='2048'></font>
<font color=#447700>!                 (with air resistance correction)<a name='2049'></font>
<font color=#447700>! * QRdum       - first-guess estimate (dummy) rain mixing ratio in layer<a name='2050'></font>
<font color=#447700>!                 (uses old rain fall speed estimate, VRAIN1)<a name='2051'></font>
<font color=#447700>! * QRnew       - updated rain mixing ratio in layer<a name='2052'></font>
<font color=#447700>!      -&gt; TOT_RAINnew=QRnew*(THICK+BLDTRH*VRAIN2)<a name='2053'></font>
<font color=#447700>!  * ARAINnew  - updated accumulation of rain at bottom of grid cell<a name='2054'></font>
<font color=#447700>!---<a name='2055'></font>
<font color=#447700>!<a name='2056'></font>
          DELR=PRAUT+PRACW+PIACWR-PIACR+PIMLT+PREVP+PICND<a name='2057'>
          TOT_RAINnew=TOT_RAIN+THICK*DELR<a name='2058'>
          IF (TOT_RAIN.GT.0. .AND. TOT_RAINnew.NE.0.) THEN<a name='2059'>
            DUM=TOT_RAINnew/TOT_RAIN<a name='2060'>
            IF (DUM .LT. TOLER) TOT_RAINnew=0.<a name='2061'>
          ENDIF<a name='2062'>
          IF (TOT_RAINnew .LE. CLIMIT) THEN<a name='2063'>
            TOT_RAINnew=0.<a name='2064'>
            VRAIN2=0.<a name='2065'>
            QRnew=0.<a name='2066'>
            ARAINnew=0.<a name='2067'>
          ELSE<a name='2068'>
   <font color=#447700>!<a name='2069'></font>
   <font color=#447700>!--- 1st guess, time-averaged rain mixing ratio and rain rate<a name='2070'></font>
   <font color=#447700>!    normalized to a density of 1.194 kg/m**3<a name='2071'></font>
   <font color=#447700>!<a name='2072'></font>
            QRdum=TOT_RAINnew/(THICK+BLDTRH*VRAIN1)<a name='2073'>
   <font color=#447700>!<a name='2074'></font>
   <font color=#447700>!--- 1st-guess estimate of rainfall through the bottom of the box<a name='2075'></font>
   <font color=#447700>!<a name='2076'></font>
            DUM=BLDTRH*VRAIN1*QRdum<a name='2077'>
   <font color=#447700>!<a name='2078'></font>
   <font color=#447700>!--- 1st-guess estimate of normalized rain rate<a name='2079'></font>
   <font color=#447700>!<a name='2080'></font>
            RR=DUM/(DTPH*GAMMAR)<a name='2081'>
   <font color=#447700>!<a name='2082'></font>
   <font color=#447700>!--- Use same algorithm as above for calculating mean drop diameter<a name='2083'></font>
   <font color=#447700>!      (IDR, in microns), which is used to estimate the time-averaged<a name='2084'></font>
   <font color=#447700>!      fall speed of rain drops at the bottom of the grid layer.<a name='2085'></font>
   <font color=#447700>!--- Integer function to estimate the mean size of the raindrops in microns<a name='2086'></font>
   <font color=#447700>!<a name='2087'></font>
            IDR=<A href='../../html_code/phys/module_mp_fer_hires.F.html#GET_INDEXR'>GET_INDEXR</A><A href='../../html_code/phys/module_mp_HWRF.F.html#EGCP01COLUMN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_INDEXR_2">(RR)<a name='2088'>
            VRAIN2=GAMMAR*VRAIN(IDR)<a name='2089'>
<font color=#447700>!!            VRAIN2=.5*(VRAIN1+GAMMAR*VRAIN(IDR))   !-- time-averaged estimate<a name='2090'></font>
            QRnew=TOT_RAINnew/(THICK+BLDTRH*VRAIN2)<a name='2091'>
            IF (QRnew .LE. EPSQ) QRnew=0.<a name='2092'>
            IF (QR.GT.0. .AND. QRnew.NE.0.) THEN<a name='2093'>
              DUM=QRnew/QR<a name='2094'>
              IF (DUM .LT. TOLER) QRnew=0.<a name='2095'>
            ENDIF<a name='2096'>
            ARAINnew=BLDTRH*VRAIN2*QRnew<a name='2097'>
            IF (ARAIN.GT.0. .AND. ARAINnew.NE.0.) THEN<a name='2098'>
              DUM=ARAINnew/ARAIN<a name='2099'>
              IF (DUM .LT. TOLER) ARAINnew=0.<a name='2100'>
            ENDIF<a name='2101'>
          ENDIF<a name='2102'>
<font color=#447700>!<a name='2103'></font>
          WCnew=QWnew+QRnew+QInew<a name='2104'>
<font color=#447700>!<a name='2105'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2106'></font>
<font color=#447700>!-------------- Begin debugging &amp; verification ------------------------<a name='2107'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2108'></font>
<font color=#447700>!<a name='2109'></font>
<font color=#447700>!--- QT, QTnew - total water (vapor &amp; condensate) before &amp; after microphysics, resp.<a name='2110'></font>
<font color=#447700>!<a name='2111'></font>
<a name='2112'>
<a name='2113'>
          QT=THICK*(WV+WC)+ARAIN+ASNOW<a name='2114'>
          QTnew=THICK*(WVnew+WCnew)+ARAINnew+ASNOWnew<a name='2115'>
          BUDGET=QT-QTnew<a name='2116'>
<font color=#447700>!<a name='2117'></font>
<font color=#447700>!--- Additional check on budget preservation, accounting for truncation effects<a name='2118'></font>
<font color=#447700>!<a name='2119'></font>
          DBG_logical=.FALSE.<a name='2120'>
          DUM=ABS(BUDGET)<a name='2121'>
          IF (DUM .GT. TOLER) THEN<a name='2122'>
            DUM=DUM/MIN(QT, QTnew)<a name='2123'>
            IF (DUM .GT. TOLER) DBG_logical=.TRUE.<a name='2124'>
          ENDIF<a name='2125'>
<font color=#447700>!<a name='2126'></font>
<font color=#447700>!          DUM=(RHgrd+.001)*QSInew<a name='2127'></font>
<font color=#447700>!          IF ( (QWnew.GT.EPSQ) .OR. QRnew.GT.EPSQ .OR. WVnew.GT.DUM)    &amp;<a name='2128'></font>
<font color=#447700>!     &amp;        .AND. TC.LT.T_ICE )  DBG_logical=.TRUE.<a name='2129'></font>
<font color=#447700>!<a name='2130'></font>
<font color=#447700>!          IF (TC.GT.5. .AND. QInew.GT.EPSQ) DBG_logical=.TRUE.<a name='2131'></font>
 <a name='2132'>
          IF ((WVnew.LT.EPSQ .OR. DBG_logical) .AND. PRINT_diag) THEN<a name='2133'>
   <font color=#447700>!<a name='2134'></font>
            WRITE(6,"(/2(a,i4),2(a,i2))") '{} i=',I_index,' j=',J_index, &amp;<a name='2135'>
     &amp;                                    ' L=',L,' LSFC=',LSFC<a name='2136'>
   <font color=#447700>!<a name='2137'></font>
            ESW=MIN(1000.*FPVS0(Tnew),0.99*PP)<a name='2138'>
            QSWnew=EPS*ESW/(PP-ESW)<a name='2139'>
            IF (TC.LT.0. .OR. Tnew .LT. 0.) THEN<a name='2140'>
              ESI=MIN(1000.*FPVS(Tnew),0.99*PP)<a name='2141'>
              QSInew=EPS*ESI/(PP-ESI)<a name='2142'>
            ELSE<a name='2143'>
              QSI=QSW<a name='2144'>
              QSInew=QSWnew<a name='2145'>
            ENDIF<a name='2146'>
            WSnew=QSInew<a name='2147'>
            WRITE(6,"(4(a12,g11.4,1x))")                                   &amp;<a name='2148'>
     &amp; '{} TCold=',TC,'TCnew=',Tnew-T0C,'P=',.01*PP,'RHO=',RHO,            &amp;<a name='2149'>
     &amp; '{} THICK=',THICK,'RHold=',WV/WS,'RHnew=',WVnew/WSnew,              &amp;<a name='2150'>
     &amp;   'RHgrd=',RHgrd,                                                   &amp;<a name='2151'>
     &amp; '{} RHWold=',WV/QSW,'RHWnew=',WVnew/QSWnew,'RHIold=',WV/QSI,        &amp;<a name='2152'>
     &amp;   'RHInew=',WVnew/QSInew,                                           &amp;<a name='2153'>
     &amp; '{} QSWold=',QSW,'QSWnew=',QSWnew,'QSIold=',QSI,'QSInew=',QSInew,   &amp;<a name='2154'>
     &amp; '{} WSold=',WS,'WSnew=',WSnew,'WVold=',WV,'WVnew=',WVnew,           &amp;<a name='2155'>
     &amp; '{} WCold=',WC,'WCnew=',WCnew,'QWold=',QW,'QWnew=',QWnew,           &amp;<a name='2156'>
     &amp; '{} QIold=',QI,'QInew=',QInew,'QRold=',QR,'QRnew=',QRnew,           &amp;<a name='2157'>
     &amp; '{} ARAINold=',ARAIN,'ARAINnew=',ARAINnew,'ASNOWold=',ASNOW,        &amp;<a name='2158'>
     &amp;   'ASNOWnew=',ASNOWnew,                                             &amp;<a name='2159'>
     &amp; '{} TOT_RAIN=',TOT_RAIN,'TOT_RAINnew=',TOT_RAINnew,                 &amp;<a name='2160'>
     &amp;   'TOT_ICE=',TOT_ICE,'TOT_ICEnew=',TOT_ICEnew,                      &amp;<a name='2161'>
     &amp; '{} BUDGET=',BUDGET,'QTold=',QT,'QTnew=',QTnew                       <a name='2162'>
   <font color=#447700>!<a name='2163'></font>
            WRITE(6,"(4(a12,g11.4,1x))")                                   &amp;<a name='2164'>
     &amp; '{} DELT=',DELT,'DELV=',DELV,'DELW=',DELW,'DELI=',DELI,             &amp;<a name='2165'>
     &amp; '{} DELR=',DELR,'PCOND=',PCOND,'PIDEP=',PIDEP,'PIEVP=',PIEVP,       &amp;<a name='2166'>
     &amp; '{} PICND=',PICND,'PREVP=',PREVP,'PRAUT=',PRAUT,'PRACW=',PRACW,     &amp;<a name='2167'>
     &amp; '{} PIACW=',PIACW,'PIACWI=',PIACWI,'PIACWR=',PIACWR,'PIMLT=',       &amp;<a name='2168'>
     &amp;    PIMLT,                                                           &amp;<a name='2169'>
     &amp; '{} PIACR=',PIACR                                                    <a name='2170'>
   <font color=#447700>!<a name='2171'></font>
            IF (ICE_logical) WRITE(6,"(4(a12,g11.4,1x))")                  &amp;<a name='2172'>
     &amp; '{} RimeF1=',RimeF1,'GAMMAS=',GAMMAS,'VrimeF=',VrimeF,              &amp;<a name='2173'>
     &amp;   'VSNOW=',VSNOW,                                                   &amp;<a name='2174'>
     &amp; '{} INDEXS=',FLOAT(INDEXS),'FLARGE=',FLARGE,'FSMALL=',FSMALL,       &amp;<a name='2175'>
     &amp;   'FLIMASS=',FLIMASS,                                               &amp;<a name='2176'>
     &amp; '{} QSmICE=',QSmICE,'XLIMASS=',XLIMASS,'RQLICE=',RQLICE,            &amp;<a name='2177'>
     &amp;   'QTICE=',QTICE,                                                   &amp;<a name='2178'>
     &amp; '{} NLICE=',NLICE,'NSmICE=',NSmICE,'PILOSS=',PILOSS,                &amp;<a name='2179'>
     &amp;   'EMAIRI=',EMAIRI,                                                 &amp;<a name='2180'>
     &amp; '{} RimeF=',RimeF,'VCI=',VCI<a name='2181'>
   <font color=#447700>!<a name='2182'></font>
            IF (TOT_RAIN.GT.0. .OR. TOT_RAINnew.GT.0.)                     &amp;<a name='2183'>
     &amp;        WRITE(6,"(4(a12,g11.4,1x))")                                 &amp;<a name='2184'>
     &amp; '{} INDEXR1=',FLOAT(INDEXR1),'INDEXR=',FLOAT(INDEXR),               &amp;<a name='2185'>
     &amp;   'GAMMAR=',GAMMAR,'N0r=',N0r,                                      &amp;<a name='2186'>
     &amp; '{} VRAIN1=',VRAIN1,'VRAIN2=',VRAIN2,'QTRAIN=',QTRAIN,'RQR=',RQR,   &amp;<a name='2187'>
     &amp; '{} PRLOSS=',PRLOSS,'VOLR1=',THICK+BLDTRH*VRAIN1,                   &amp;<a name='2188'>
     &amp;   'VOLR2=',THICK+BLDTRH*VRAIN2<a name='2189'>
   <font color=#447700>!<a name='2190'></font>
            IF (PRACW .GT. 0.) WRITE(6,"(a12,g11.4,1x)") '{} FWR=',FWR<a name='2191'>
   <font color=#447700>!<a name='2192'></font>
            IF (PIACR .GT. 0.) WRITE(6,"(a12,g11.4,1x)") '{} FIR=',FIR<a name='2193'>
   <font color=#447700>!<a name='2194'></font>
            DUM=PIMLT+PICND-PREVP-PIEVP<a name='2195'>
            IF (DUM.GT.0. .or. DWVi.NE.0.)                                 &amp;<a name='2196'>
     &amp;        WRITE(6,"(4(a12,g11.4,1x))")                                 &amp;<a name='2197'>
     &amp; '{} TFACTOR=',TFACTOR,'DYNVIS=',DYNVIS,                             &amp;<a name='2198'>
     &amp;   'THERM_CON=',THERM_COND,'DIFFUS=',DIFFUS<a name='2199'>
   <font color=#447700>!<a name='2200'></font>
            IF (PREVP .LT. 0.) WRITE(6,"(4(a12,g11.4,1x))")                &amp;<a name='2201'>
     &amp; '{} RFACTOR=',RFACTOR,'ABW=',ABW,'VENTR=',VENTR,'CREVP=',CREVP,     &amp;<a name='2202'>
     &amp; '{} DWVr=',DWVr,'DENOMW=',DENOMW<a name='2203'>
   <font color=#447700>!<a name='2204'></font>
            IF (PIDEP.NE.0. .AND. DWVi.NE.0.)                              &amp;<a name='2205'>
     &amp;        WRITE(6,"(4(a12,g11.4,1x))")                                 &amp;<a name='2206'>
     &amp; '{} DWVi=',DWVi,'DENOMI=',DENOMI,'PIDEP_max=',PIDEP_max,            &amp;<a name='2207'>
     &amp;   'SFACTOR=',SFACTOR,                                               &amp;<a name='2208'>
     &amp; '{} ABI=',ABI,'VENTIL=',VENTIL,'VENTIL1=',VENTI1(INDEXS),           &amp;<a name='2209'>
     &amp;   'VENTIL2=',SFACTOR*VENTI2(INDEXS),                                &amp;<a name='2210'>
     &amp; '{} VENTIS=',VENTIS,'DIDEP=',DIDEP<a name='2211'>
   <font color=#447700>!<a name='2212'></font>
            IF (PIDEP.GT.0. .AND. PCOND.NE.0.)                             &amp;<a name='2213'>
     &amp;        WRITE(6,"(4(a12,g11.4,1x))")                                 &amp;<a name='2214'>
     &amp; '{} DENOMW=',DENOMW,'DENOMWI=',DENOMWI,'DENOMF=',DENOMF,            &amp;<a name='2215'>
     &amp;    'DUM2=',PCOND-PIACW<a name='2216'>
   <font color=#447700>!<a name='2217'></font>
            IF (FWS .GT. 0.) WRITE(6,"(4(a12,g11.4,1x))")                  &amp;<a name='2218'>
     &amp; '{} FWS=',FWS                     <a name='2219'>
   <font color=#447700>!<a name='2220'></font>
            DUM=PIMLT+PICND-PIEVP<a name='2221'>
            IF (DUM.GT. 0.) WRITE(6,"(4(a12,g11.4,1x))")                   &amp;<a name='2222'>
     &amp; '{} SFACTOR=',SFACTOR,'VENTIL=',VENTIL,'VENTIL1=',VENTI1(INDEXS),   &amp;<a name='2223'>
     &amp;   'VENTIL2=',SFACTOR*VENTI2(INDEXS),                                &amp;<a name='2224'>
     &amp; '{} AIEVP=',AIEVP,'DIEVP=',DIEVP,'QSW0=',QSW0,'DWV0=',DWV0       <a name='2225'>
   <font color=#447700>!<a name='2226'></font>
          ENDIF<a name='2227'>
<a name='2228'>
<font color=#447700>!<a name='2229'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2230'></font>
<font color=#447700>!--------------- Water budget statistics &amp; maximum values --------------<a name='2231'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2232'></font>
<font color=#447700>!<a name='2233'></font>
<font color=#447700>!          IF (PRINT_diag) THEN<a name='2234'></font>
<font color=#447700>!            ITdx=MAX( ITLO, MIN( INT(Tnew-T0C), ITHI ) )<a name='2235'></font>
<font color=#447700>!            IF (QInew .GT. EPSQ) NSTATS(ITdx,1)=NSTATS(ITdx,1)+1<a name='2236'></font>
<font color=#447700>!            IF (QInew.GT.EPSQ  .AND.  QRnew+QWnew.GT.EPSQ)              &amp;<a name='2237'></font>
<font color=#447700>!     &amp;        NSTATS(ITdx,2)=NSTATS(ITdx,2)+1<a name='2238'></font>
<font color=#447700>!            IF (QWnew .GT. EPSQ) NSTATS(ITdx,3)=NSTATS(ITdx,3)+1 <a name='2239'></font>
<font color=#447700>!            IF (QRnew .GT. EPSQ) NSTATS(ITdx,4)=NSTATS(ITdx,4)+1<a name='2240'></font>
<font color=#447700>!  !<a name='2241'></font>
<font color=#447700>!            QMAX(ITdx,1)=MAX(QMAX(ITdx,1), QInew)<a name='2242'></font>
<font color=#447700>!            QMAX(ITdx,2)=MAX(QMAX(ITdx,2), QWnew)<a name='2243'></font>
<font color=#447700>!            QMAX(ITdx,3)=MAX(QMAX(ITdx,3), QRnew)<a name='2244'></font>
<font color=#447700>!            QMAX(ITdx,4)=MAX(QMAX(ITdx,4), ASNOWnew)<a name='2245'></font>
<font color=#447700>!            QMAX(ITdx,5)=MAX(QMAX(ITdx,5), ARAINnew)<a name='2246'></font>
<font color=#447700>!            QTOT(ITdx,1)=QTOT(ITdx,1)+QInew*THICK<a name='2247'></font>
<font color=#447700>!            QTOT(ITdx,2)=QTOT(ITdx,2)+QWnew*THICK<a name='2248'></font>
<font color=#447700>!            QTOT(ITdx,3)=QTOT(ITdx,3)+QRnew*THICK<a name='2249'></font>
<font color=#447700>!  !<a name='2250'></font>
<font color=#447700>!            QTOT(ITdx,4)=QTOT(ITdx,4)+PCOND*THICK<a name='2251'></font>
<font color=#447700>!            QTOT(ITdx,5)=QTOT(ITdx,5)+PICND*THICK<a name='2252'></font>
<font color=#447700>!            QTOT(ITdx,6)=QTOT(ITdx,6)+PIEVP*THICK<a name='2253'></font>
<font color=#447700>!            QTOT(ITdx,7)=QTOT(ITdx,7)+PIDEP*THICK<a name='2254'></font>
<font color=#447700>!            QTOT(ITdx,8)=QTOT(ITdx,8)+PREVP*THICK<a name='2255'></font>
<font color=#447700>!            QTOT(ITdx,9)=QTOT(ITdx,9)+PRAUT*THICK<a name='2256'></font>
<font color=#447700>!            QTOT(ITdx,10)=QTOT(ITdx,10)+PRACW*THICK<a name='2257'></font>
<font color=#447700>!            QTOT(ITdx,11)=QTOT(ITdx,11)+PIMLT*THICK<a name='2258'></font>
<font color=#447700>!            QTOT(ITdx,12)=QTOT(ITdx,12)+PIACW*THICK<a name='2259'></font>
<font color=#447700>!            QTOT(ITdx,13)=QTOT(ITdx,13)+PIACWI*THICK<a name='2260'></font>
<font color=#447700>!            QTOT(ITdx,14)=QTOT(ITdx,14)+PIACWR*THICK<a name='2261'></font>
<font color=#447700>!            QTOT(ITdx,15)=QTOT(ITdx,15)+PIACR*THICK<a name='2262'></font>
<font color=#447700>!  !<a name='2263'></font>
<font color=#447700>!            QTOT(ITdx,16)=QTOT(ITdx,16)+(WVnew-WV)*THICK<a name='2264'></font>
<font color=#447700>!            QTOT(ITdx,17)=QTOT(ITdx,17)+(QWnew-QW)*THICK<a name='2265'></font>
<font color=#447700>!            QTOT(ITdx,18)=QTOT(ITdx,18)+(QInew-QI)*THICK<a name='2266'></font>
<font color=#447700>!            QTOT(ITdx,19)=QTOT(ITdx,19)+(QRnew-QR)*THICK<a name='2267'></font>
<font color=#447700>!            QTOT(ITdx,20)=QTOT(ITdx,20)+(ARAINnew-ARAIN)<a name='2268'></font>
<font color=#447700>!            QTOT(ITdx,21)=QTOT(ITdx,21)+(ASNOWnew-ASNOW)<a name='2269'></font>
<font color=#447700>!            IF (QInew .GT. 0.)                                          &amp;<a name='2270'></font>
<font color=#447700>!     &amp;        QTOT(ITdx,22)=QTOT(ITdx,22)+QInew*THICK/RimeF<a name='2271'></font>
<font color=#447700>!  !<a name='2272'></font>
<font color=#447700>!          ENDIF<a name='2273'></font>
<font color=#447700>!<a name='2274'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2275'></font>
<font color=#447700>!------------------------- Update arrays ------------------------------<a name='2276'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2277'></font>
<font color=#447700>!<a name='2278'></font>
<a name='2279'>
<a name='2280'>
          T_col(L)=Tnew                           <font color=#447700>! Updated temperature<a name='2281'></font>
<font color=#447700>!<a name='2282'></font>
          QV_col(L)=max(EPSQ, WVnew/(1.+WVnew))   <font color=#447700>! Updated specific humidity<a name='2283'></font>
          WC_col(L)=max(EPSQ, WCnew)              <font color=#447700>! Updated total condensate mixing ratio<a name='2284'></font>
          QI_col(L)=max(EPSQ, QInew)              <font color=#447700>! Updated ice mixing ratio<a name='2285'></font>
          QR_col(L)=max(EPSQ, QRnew)              <font color=#447700>! Updated rain mixing ratio<a name='2286'></font>
          QW_col(L)=max(EPSQ, QWnew)              <font color=#447700>! Updated cloud water mixing ratio<a name='2287'></font>
          RimeF_col(L)=RimeF                      <font color=#447700>! Updated rime factor<a name='2288'></font>
          ASNOW=ASNOWnew                          <font color=#447700>! Updated accumulated snow<a name='2289'></font>
          ARAIN=ARAINnew                          <font color=#447700>! Updated accumulated rain<a name='2290'></font>
<font color=#447700>!! 2012-02-09 Based on Aligo's email<a name='2291'></font>
          VRabove=VRAIN2                          <font color=#447700>! Updated rain fall speed<a name='2292'></font>
<font color=#447700>!<a name='2293'></font>
<font color=#447700>!#######################################################################<a name='2294'></font>
<font color=#447700>!<a name='2295'></font>
10      CONTINUE         <font color=#447700>! ##### End "L" loop through model levels #####<a name='2296'></font>
<a name='2297'>
<font color=#447700>!!!!!!!!        write(6,*)'2012-02-09,ncw,nlimax,vrabove=',ncw,nlimax,vrabove<a name='2298'></font>
<font color=#447700>!<a name='2299'></font>
<font color=#447700>!#######################################################################<a name='2300'></font>
<font color=#447700>!<a name='2301'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2302'></font>
<font color=#447700>!--------------------------- Return to GSMDRIVE -----------------------<a name='2303'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2304'></font>
<font color=#447700>!<a name='2305'></font>
        CONTAINS<a name='2306'>
<font color=#447700>!#######################################################################<a name='2307'></font>
<font color=#447700>!--------- Produces accurate calculation of cloud condensation ---------<a name='2308'></font>
<font color=#447700>!#######################################################################<a name='2309'></font>
<font color=#447700>!<a name='2310'></font>
<A NAME='CONDENSE'><A href='../../html_code/phys/module_mp_fer_hires.F.html#CONDENSE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2311'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>CONDENSE</font> (PP,QW,TK,WV,RHgrd,I,J,L)<a name='2312'>
<font color=#447700>!<a name='2313'></font>
<font color=#447700>!---------------------------------------------------------------------------------<a name='2314'></font>
<font color=#447700>!------   The Asai (1965) algorithm takes into consideration the release of ------<a name='2315'></font>
<font color=#447700>!------   latent heat in increasing the temperature &amp; in increasing the     ------<a name='2316'></font>
<font color=#447700>!------   saturation mixing ratio (following the Clausius-Clapeyron eqn.).  ------<a name='2317'></font>
<font color=#447700>!---------------------------------------------------------------------------------<a name='2318'></font>
<font color=#447700>!<a name='2319'></font>
      IMPLICIT NONE<a name='2320'>
<font color=#447700>!<a name='2321'></font>
      INTEGER, PARAMETER :: HIGH_PRES=Selected_Real_Kind(15)<a name='2322'>
      REAL (KIND=HIGH_PRES), PARAMETER ::                               &amp;<a name='2323'>
     &amp; RHLIMIT=.001, RHLIMIT1=-RHLIMIT<a name='2324'>
      REAL (KIND=HIGH_PRES) :: COND, SSAT, WCdum<a name='2325'>
<font color=#447700>!<a name='2326'></font>
      REAL,INTENT(IN) :: PP,QW,TK,WV,RHgrd   <font color=#447700>!GFDL<a name='2327'></font>
      REAL WVdum,Tdum,XLV2,DWV,WS,ESW,XLV1,XLV<a name='2328'>
<a name='2329'>
integer,INTENT(IN) :: I,J,L     <font color=#447700>!-- Debug 20120111<a name='2330'></font>
integer :: niter<a name='2331'>
real :: DWVinp,SSATinp<a name='2332'>
<a name='2333'>
<font color=#447700>!<a name='2334'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2335'></font>
<font color=#447700>!<a name='2336'></font>
<font color=#447700>!--- LV (T) is from Bolton (JAS, 1980)<a name='2337'></font>
<font color=#447700>!<a name='2338'></font>
      XLV=3.148E6-2370.*TK<a name='2339'>
      XLV1=XLV*RCP<a name='2340'>
      XLV2=XLV*XLV*RCPRV<a name='2341'>
      Tdum=TK<a name='2342'>
      WVdum=WV<a name='2343'>
      WCdum=QW<a name='2344'>
      ESW=MIN(1000.*FPVS0(Tdum),0.99*PP)        <font color=#447700>! Saturation vapor press w/r/t water<a name='2345'></font>
      WS=RHgrd*EPS*ESW/(PP-ESW)                 <font color=#447700>! Saturation mixing ratio w/r/t water<a name='2346'></font>
      DWV=WVdum-WS                              <font color=#447700>! Deficit grid-scale water vapor mixing ratio<a name='2347'></font>
      SSAT=DWV/WS                               <font color=#447700>! Supersaturation ratio<a name='2348'></font>
      CONDENSE=0.<a name='2349'>
<a name='2350'>
DWVinp=DWV     <font color=#447700>!-- Debug 20120111<a name='2351'></font>
SSATinp=SSAT<a name='2352'>
<a name='2353'>
      DO NITER=1,MAX_ITERATIONS<a name='2354'>
        COND=DWV/(1.+XLV2*WS/(Tdum*Tdum))       <font color=#447700>! Asai (1965, J. Japan)<a name='2355'></font>
        COND=MAX(COND, -WCdum)                  <font color=#447700>! Limit cloud water evaporation<a name='2356'></font>
        Tdum=Tdum+XLV1*COND                     <font color=#447700>! Updated temperature<a name='2357'></font>
        WVdum=WVdum-COND                        <font color=#447700>! Updated water vapor mixing ratio<a name='2358'></font>
        WCdum=WCdum+COND                        <font color=#447700>! Updated cloud water mixing ratio<a name='2359'></font>
        CONDENSE=CONDENSE+COND                  <font color=#447700>! Total cloud water condensation<a name='2360'></font>
        ESW=MIN(1000.*FPVS0(Tdum),0.99*PP)      <font color=#447700>! Updated saturation vapor press w/r/t water<a name='2361'></font>
        WS=RHgrd*EPS*ESW/(PP-ESW)               <font color=#447700>! Updated saturation mixing ratio w/r/t water<a name='2362'></font>
        DWV=WVdum-WS                            <font color=#447700>! Deficit grid-scale water vapor mixing ratio<a name='2363'></font>
        SSAT=DWV/WS                             <font color=#447700>! Grid-scale supersaturation ratio<a name='2364'></font>
        IF (SSAT&gt;=RHLIMIT1 .AND. SSAT&lt;=RHLIMIT) EXIT   <font color=#447700>!-- Exit if SSAT is near 0<a name='2365'></font>
        IF (SSAT&lt;RHLIMIT1 .AND. WCdum&lt;=EPSQ) EXIT      <font color=#447700>!-- Exit if SSAT&lt;0 &amp; no cloud water<a name='2366'></font>
      ENDDO<a name='2367'>
<a name='2368'>
<font color=#447700>!-- Debug 20120111<a name='2369'></font>
IF (NITER&gt;MAX_ITERATIONS) THEN<a name='2370'>
<font color=#447700>!-- Too many iterations - indicates possible numerical instability<a name='2371'></font>
   IF (WARN3) THEN<a name='2372'>
      write(0,*) 'WARN3: Too many iterations in function CONDENSE; ', &amp;<a name='2373'>
         ' I,J,L,TC,SSAT,QW,DWV=',I,J,L,TK-T0C,SSATinp,1000.*QW,DWVinp<a name='2374'>
      WARN3=.FALSE.<a name='2375'>
   ENDIF<a name='2376'>
   SSAT=0.<a name='2377'>
   CONDENSE=DWVinp<a name='2378'>
ENDIF<a name='2379'>
<a name='2380'>
<font color=#447700>!<a name='2381'></font>
      END FUNCTION CONDENSE<a name='2382'>
<font color=#447700>!<a name='2383'></font>
<font color=#447700>!#######################################################################<a name='2384'></font>
<font color=#447700>!---------------- Calculate ice deposition at T&lt;T_ICE ------------------<a name='2385'></font>
<font color=#447700>!#######################################################################<a name='2386'></font>
<font color=#447700>!<a name='2387'></font>
<A NAME='DEPOSIT'><A href='../../html_code/phys/module_mp_fer_hires.F.html#DEPOSIT' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2388'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>DEPOSIT</font> (PP,Tdum,WVdum,RHgrd,I,J,L) <A href='../../call_to/DEPOSIT.html' TARGET='index'>1</A><a name='2389'>
<font color=#447700>!<a name='2390'></font>
<font color=#447700>!--- Also uses the Asai (1965) algorithm, but uses a different target<a name='2391'></font>
<font color=#447700>!      vapor pressure for the adjustment<a name='2392'></font>
<font color=#447700>!<a name='2393'></font>
      IMPLICIT NONE      <a name='2394'>
<font color=#447700>!<a name='2395'></font>
      INTEGER, PARAMETER :: HIGH_PRES=Selected_Real_Kind(15)<a name='2396'>
      REAL (KIND=HIGH_PRES), PARAMETER :: RHLIMIT=.001,                 &amp;<a name='2397'>
     &amp; RHLIMIT1=-RHLIMIT<a name='2398'>
      REAL (KIND=HIGH_PRES) :: DEP, SSAT<a name='2399'>
<font color=#447700>!    <a name='2400'></font>
      real,INTENT(IN) ::  PP,RHgrd   <font color=#447700>!GFDL<a name='2401'></font>
      real,INTENT(INOUT) ::  WVdum,Tdum<a name='2402'>
      real ESI,WS,DWV<a name='2403'>
<a name='2404'>
integer,INTENT(IN) :: I,J,L   <font color=#447700>!-- Debug 20120111<a name='2405'></font>
integer :: niter<a name='2406'>
real :: Tinp,DWVinp,SSATinp<a name='2407'>
<a name='2408'>
<font color=#447700>!<a name='2409'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2410'></font>
<font color=#447700>!<a name='2411'></font>
      ESI=MIN(1000.*FPVS(Tdum),0.99*PP)         <font color=#447700>! Saturation vapor press w/r/t ice<a name='2412'></font>
      WS=RHgrd*EPS*ESI/(PP-ESI)                 <font color=#447700>! Saturation mixing ratio<a name='2413'></font>
      DWV=WVdum-WS                              <font color=#447700>! Deficit grid-scale water vapor mixing ratio<a name='2414'></font>
      SSAT=DWV/WS                               <font color=#447700>! Supersaturation ratio<a name='2415'></font>
      DEPOSIT=0.<a name='2416'>
<a name='2417'>
Tinp=Tdum     <font color=#447700>!-- Debug 20120111<a name='2418'></font>
DWVinp=DWV<a name='2419'>
SSATinp=SSAT<a name='2420'>
<a name='2421'>
      DO NITER=1,MAX_ITERATIONS<a name='2422'>
   <font color=#447700>!<a name='2423'></font>
   <font color=#447700>!--- Note that XLVS2=LS*LV/(CP*RV)=LV*WS/(RV*T*T)*(LS/CP*DEP1), <a name='2424'></font>
   <font color=#447700>!     where WS is the saturation mixing ratio following Clausius-<a name='2425'></font>
   <font color=#447700>!     Clapeyron (see Asai,1965; Young,1993,p.405) <a name='2426'></font>
   <font color=#447700>!<a name='2427'></font>
        DEP=DWV/(1.+XLS2*WS/(Tdum*Tdum))        <font color=#447700>! Asai (1965, J. Japan)<a name='2428'></font>
        Tdum=Tdum+XLS1*DEP                      <font color=#447700>! Updated temperature<a name='2429'></font>
        WVdum=WVdum-DEP                         <font color=#447700>! Updated ice mixing ratio<a name='2430'></font>
        DEPOSIT=DEPOSIT+DEP                     <font color=#447700>! Total ice deposition<a name='2431'></font>
        ESI=MIN(1000.*FPVS(Tdum),0.99*PP)       <font color=#447700>! Updated saturation vapor press w/r/t ice<a name='2432'></font>
        WS=RHgrd*EPS*ESI/(PP-ESI)               <font color=#447700>! Updated saturation mixing ratio w/r/t ice<a name='2433'></font>
        DWV=WVdum-WS                            <font color=#447700>! Deficit grid-scale water vapor mixing ratio<a name='2434'></font>
        SSAT=DWV/WS                             <font color=#447700>! Grid-scale supersaturation ratio<a name='2435'></font>
        IF (SSAT&gt;=RHLIMIT1 .AND. SSAT&lt;=RHLIMIT) EXIT   <font color=#447700>!-- Exit if SSAT is near 0<a name='2436'></font>
      ENDDO<a name='2437'>
<a name='2438'>
<font color=#447700>!-- Debug 20120111<a name='2439'></font>
IF (NITER&gt;MAX_ITERATIONS) THEN<a name='2440'>
<font color=#447700>!-- Too many iterations - indicates possible numerical instability<a name='2441'></font>
   IF (WARN2) THEN<a name='2442'>
      write(0,*) 'WARN2: Too many iterations in function DEPOSIT; ', &amp;<a name='2443'>
         ' I,J,L,TC,SSAT,DWV=',I,J,L,Tinp-T0C,SSATinp,DWVinp<a name='2444'>
      WARN2=.FALSE.<a name='2445'>
   ENDIF<a name='2446'>
   SSAT=0.<a name='2447'>
   DEPOSIT=DWVinp<a name='2448'>
ENDIF<a name='2449'>
<a name='2450'>
<font color=#447700>!<a name='2451'></font>
      END FUNCTION DEPOSIT<a name='2452'>
<font color=#447700>!<a name='2453'></font>
<font color=#447700>!#######################################################################<a name='2454'></font>
<font color=#447700>!--- Used to calculate the mean size of rain drops (INDEXR) in microns<a name='2455'></font>
<font color=#447700>!#######################################################################<a name='2456'></font>
<font color=#447700>!<a name='2457'></font>
<A NAME='GET_INDEXR'><A href='../../html_code/phys/module_mp_fer_hires.F.html#GET_INDEXR' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2458'>
      INTEGER <font color=#993300>FUNCTION </font><font color=#cc0000>GET_INDEXR</font>(RR) <A href='../../call_to/GET_INDEXR.html' TARGET='index'>2</A><a name='2459'>
      IMPLICIT NONE<a name='2460'>
      REAL, INTENT(IN) :: RR<a name='2461'>
      IF (RR .LE. RR_DRmin) THEN<a name='2462'>
<font color=#447700>!<a name='2463'></font>
<font color=#447700>!--- Assume fixed mean diameter of rain (0.2 mm) for low rain rates, <a name='2464'></font>
<font color=#447700>!      instead vary N0r with rain rate<a name='2465'></font>
<font color=#447700>!<a name='2466'></font>
        GET_INDEXR=MDRmin<a name='2467'>
      ELSE IF (RR .LE. RR_DR1) THEN<a name='2468'>
<font color=#447700>!<a name='2469'></font>
<font color=#447700>!--- Best fit to mass-weighted fall speeds (V) from rain lookup tables <a name='2470'></font>
<font color=#447700>!      for mean diameters (Dr) between 0.05 and 0.10 mm:<a name='2471'></font>
<font color=#447700>!      V(Dr)=5.6023e4*Dr**1.136, V in m/s and Dr in m<a name='2472'></font>
<font color=#447700>!      RR = PI*1000.*N0r0*5.6023e4*Dr**(4+1.136) = 1.408e15*Dr**5.136,<a name='2473'></font>
<font color=#447700>!        RR in kg/(m**2*s)<a name='2474'></font>
<font color=#447700>!      Dr (m) = 1.123e-3*RR**.1947 -&gt; Dr (microns) = 1.123e3*RR**.1947<a name='2475'></font>
<font color=#447700>!<a name='2476'></font>
        GET_INDEXR=INT( 1.123E3*RR**.1947 + .5 )<a name='2477'>
        GET_INDEXR=MAX( MDRmin, MIN(GET_INDEXR, MDR1) )<a name='2478'>
      ELSE IF (RR .LE. RR_DR2) THEN<a name='2479'>
<font color=#447700>!<a name='2480'></font>
<font color=#447700>!--- Best fit to mass-weighted fall speeds (V) from rain lookup tables <a name='2481'></font>
<font color=#447700>!      for mean diameters (Dr) between 0.10 and 0.20 mm:<a name='2482'></font>
<font color=#447700>!      V(Dr)=1.0867e4*Dr**.958, V in m/s and Dr in m<a name='2483'></font>
<font color=#447700>!      RR = PI*1000.*N0r0*1.0867e4*Dr**(4+.958) = 2.731e14*Dr**4.958,<a name='2484'></font>
<font color=#447700>!        RR in kg/(m**2*s)<a name='2485'></font>
<font color=#447700>!      Dr (m) = 1.225e-3*RR**.2017 -&gt; Dr (microns) = 1.225e3*RR**.2017<a name='2486'></font>
<font color=#447700>!<a name='2487'></font>
        GET_INDEXR=INT( 1.225E3*RR**.2017 + .5 )<a name='2488'>
        GET_INDEXR=MAX( MDR1, MIN(GET_INDEXR, MDR2) )<a name='2489'>
      ELSE IF (RR .LE. RR_DR3) THEN<a name='2490'>
<font color=#447700>!<a name='2491'></font>
<font color=#447700>!--- Best fit to mass-weighted fall speeds (V) from rain lookup tables <a name='2492'></font>
<font color=#447700>!      for mean diameters (Dr) between 0.20 and 0.32 mm:<a name='2493'></font>
<font color=#447700>!      V(Dr)=2831.*Dr**.80, V in m/s and Dr in m<a name='2494'></font>
<font color=#447700>!      RR = PI*1000.*N0r0*2831.*Dr**(4+.80) = 7.115e13*Dr**4.80, <a name='2495'></font>
<font color=#447700>!        RR in kg/(m**2*s)<a name='2496'></font>
<font color=#447700>!      Dr (m) = 1.3006e-3*RR**.2083 -&gt; Dr (microns) = 1.3006e3*RR**.2083<a name='2497'></font>
<font color=#447700>!<a name='2498'></font>
        GET_INDEXR=INT( 1.3006E3*RR**.2083 + .5 )<a name='2499'>
        GET_INDEXR=MAX( MDR2, MIN(GET_INDEXR, MDR3) )<a name='2500'>
      ELSE IF (RR .LE. RR_DR4) THEN<a name='2501'>
<font color=#447700>!<a name='2502'></font>
<font color=#447700>!--- Best fit to mass-weighted fall speeds (V) from rain lookup tables<a name='2503'></font>
<font color=#447700>!      for mean diameters (Dr) between 0.32 and 0.45 mm:<a name='2504'></font>
<font color=#447700>!      V(Dr)=963.0*Dr**.666, V in m/s and Dr in m<a name='2505'></font>
<font color=#447700>!      RR = PI*1000.*N0r0*963.0*Dr**(4+.666) = 2.4205e13*Dr**4.666,<a name='2506'></font>
<font color=#447700>!        RR in kg/(m**2*s)<a name='2507'></font>
<font color=#447700>!      Dr (m) = 1.354e-3*RR**.2143 -&gt; Dr (microns) = 1.354e3*RR**.2143<a name='2508'></font>
<font color=#447700>!<a name='2509'></font>
        GET_INDEXR=INT( 1.354E3*RR**.2143 + .5 )<a name='2510'>
        GET_INDEXR=MAX( MDR3, MIN(GET_INDEXR, MDR4) )<a name='2511'>
      ELSE IF (RR .LE. RR_DR5) THEN<a name='2512'>
<font color=#447700>!<a name='2513'></font>
<font color=#447700>!--- Best fit to mass-weighted fall speeds (V) from rain lookup tables<a name='2514'></font>
<font color=#447700>!      for mean diameters (Dr) between 0.45 and 0.675 mm:<a name='2515'></font>
<font color=#447700>!      V(Dr)=309.0*Dr**.5185, V in m/s and Dr in m<a name='2516'></font>
<font color=#447700>!      RR = PI*1000.*N0r0*309.0*Dr**(4+.5185) = 7.766e12*Dr**4.5185,<a name='2517'></font>
<font color=#447700>!        RR in kg/(m**2*s)<a name='2518'></font>
<font color=#447700>!      Dr (m) = 1.404e-3*RR**.2213 -&gt; Dr (microns) = 1.404e3*RR**.2213<a name='2519'></font>
<font color=#447700>!<a name='2520'></font>
        GET_INDEXR=INT( 1.404E3*RR**.2213 + .5 )<a name='2521'>
        GET_INDEXR=MAX( MDR4, MIN(GET_INDEXR, MDR5) )<a name='2522'>
      ELSE IF (RR .LE. RR_DRmax) THEN<a name='2523'>
<font color=#447700>!<a name='2524'></font>
<font color=#447700>!--- Best fit to mass-weighted fall speeds (V) from rain lookup tables<a name='2525'></font>
<font color=#447700>!      for mean diameters (Dr) between 0.675 and 1.0 mm:<a name='2526'></font>
<font color=#447700>!      V(Dr)=85.81Dr**.343, V in m/s and Dr in m<a name='2527'></font>
<font color=#447700>!      RR = PI*1000.*N0r0*85.81*Dr**(4+.343) = 2.1566e12*Dr**4.343,<a name='2528'></font>
<font color=#447700>!        RR in kg/(m**2*s)<a name='2529'></font>
<font color=#447700>!      Dr (m) = 1.4457e-3*RR**.2303 -&gt; Dr (microns) = 1.4457e3*RR**.2303<a name='2530'></font>
<font color=#447700>!<a name='2531'></font>
        GET_INDEXR=INT( 1.4457E3*RR**.2303 + .5 )<a name='2532'>
        GET_INDEXR=MAX( MDR5, MIN(GET_INDEXR, MDRmax) )<a name='2533'>
      ELSE <a name='2534'>
<font color=#447700>!<a name='2535'></font>
<font color=#447700>!--- Assume fixed mean diameter of rain (1.0 mm) for high rain rates, <a name='2536'></font>
<font color=#447700>!      instead vary N0r with rain rate<a name='2537'></font>
<font color=#447700>!<a name='2538'></font>
        GET_INDEXR=MDRmax<a name='2539'>
      ENDIF              <font color=#447700>! End IF (RR .LE. RR_DRmin) etc. <a name='2540'></font>
<font color=#447700>!<a name='2541'></font>
      END FUNCTION GET_INDEXR<a name='2542'>
<font color=#447700>!<a name='2543'></font>
      END SUBROUTINE EGCP01COLUMN <a name='2544'>
<a name='2545'>
<font color=#447700>!#######################################################################<a name='2546'></font>
<font color=#447700>!------- Initialize constants &amp; lookup tables for microphysics ---------<a name='2547'></font>
<font color=#447700>!#######################################################################<a name='2548'></font>
<font color=#447700>!<a name='2549'></font>
<a name='2550'>
<font color=#447700>! SH 0211/2002<a name='2551'></font>
<a name='2552'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2553'></font>
<A NAME='FER_HIRES_INIT'><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2554'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>fer_hires_init</font> (GSMDT,DT,DELX,DELY,LOWLYR,restart,         &amp; <A href='../../call_to/FER_HIRES_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/FER_HIRES_INIT.html' TARGET='index'>18</A><a name='2555'>
<font color=#447700>!HWRF     &amp;   MP_RESTART_STATE,TBPVS_STATE,TBPVS0_STATE,                     &amp;<a name='2556'></font>
     &amp;   ALLOWED_TO_READ,                                               &amp;<a name='2557'>
     &amp;   IDS,IDE,JDS,JDE,KDS,KDE,                                       &amp;<a name='2558'>
     &amp;   IMS,IME,JMS,JME,KMS,KME,                                       &amp;<a name='2559'>
     &amp;   ITS,ITE,JTS,JTE,KTS,KTE,                                       &amp;<a name='2560'>
     &amp;   F_ICE_PHY,F_RAIN_PHY,F_RIMEF_PHY)<a name='2561'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2562'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2563'></font>
<font color=#447700>!---  SUBPROGRAM DOCUMENTATION BLOCK<a name='2564'></font>
<font color=#447700>!   PRGRMMR: Ferrier         ORG: W/NP22     DATE: February 2001<a name='2565'></font>
<font color=#447700>!            Jin             ORG: W/NP22     DATE: January 2002 <a name='2566'></font>
<font color=#447700>!        (Modification for WRF structure)<a name='2567'></font>
<font color=#447700>!                                               <a name='2568'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2569'></font>
<font color=#447700>! ABSTRACT:<a name='2570'></font>
<font color=#447700>!   * Reads various microphysical lookup tables used in COLUMN_MICRO<a name='2571'></font>
<font color=#447700>!   * Lookup tables were created "offline" and are read in during execution<a name='2572'></font>
<font color=#447700>!   * Creates lookup tables for saturation vapor pressure w/r/t water &amp; ice<a name='2573'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2574'></font>
<font color=#447700>!     <a name='2575'></font>
<font color=#447700>! USAGE: CALL fer_hires_init FROM SUBROUTINE GSMDRIVE AT MODEL START TIME<a name='2576'></font>
<font color=#447700>!<a name='2577'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='2578'></font>
<font color=#447700>!       DTPH - physics time step (s)<a name='2579'></font>
<font color=#447700>!  <a name='2580'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST: <a name='2581'></font>
<font color=#447700>!     NONE<a name='2582'></font>
<font color=#447700>!     <a name='2583'></font>
<font color=#447700>!   OUTPUT FILES:<a name='2584'></font>
<font color=#447700>!     NONE<a name='2585'></font>
<font color=#447700>!     <a name='2586'></font>
<font color=#447700>!   SUBROUTINES:<a name='2587'></font>
<font color=#447700>!     MY_GROWTH_RATES - lookup table for growth of nucleated ice<a name='2588'></font>
<font color=#447700>!     GPVS            - lookup tables for saturation vapor pressure (water, ice)<a name='2589'></font>
<font color=#447700>!<a name='2590'></font>
<font color=#447700>!   UNIQUE: NONE<a name='2591'></font>
<font color=#447700>!  <a name='2592'></font>
<font color=#447700>!   LIBRARY: NONE<a name='2593'></font>
<font color=#447700>!  <a name='2594'></font>
<font color=#447700>!   COMMON BLOCKS:<a name='2595'></font>
<font color=#447700>!     CMICRO_CONS - constants used in GSMCOLUMN<a name='2596'></font>
<font color=#447700>!     CMY600       - lookup table for growth of ice crystals in <a name='2597'></font>
<font color=#447700>!                    water saturated conditions (Miller &amp; Young, 1979)<a name='2598'></font>
<font color=#447700>!     IVENT_TABLES - lookup tables for ventilation effects of ice<a name='2599'></font>
<font color=#447700>!     IACCR_TABLES - lookup tables for accretion rates of ice<a name='2600'></font>
<font color=#447700>!     IMASS_TABLES - lookup tables for mass content of ice<a name='2601'></font>
<font color=#447700>!     IRATE_TABLES - lookup tables for precipitation rates of ice<a name='2602'></font>
<font color=#447700>!     IRIME_TABLES - lookup tables for increase in fall speed of rimed ice<a name='2603'></font>
<font color=#447700>!     MAPOT        - Need lat/lon grid resolution<a name='2604'></font>
<font color=#447700>!     RVENT_TABLES - lookup tables for ventilation effects of rain<a name='2605'></font>
<font color=#447700>!     RACCR_TABLES - lookup tables for accretion rates of rain<a name='2606'></font>
<font color=#447700>!     RMASS_TABLES - lookup tables for mass content of rain<a name='2607'></font>
<font color=#447700>!     RVELR_TABLES - lookup tables for fall speeds of rain<a name='2608'></font>
<font color=#447700>!     RRATE_TABLES - lookup tables for precipitation rates of rain<a name='2609'></font>
<font color=#447700>!   <a name='2610'></font>
<font color=#447700>! ATTRIBUTES:<a name='2611'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='2612'></font>
<font color=#447700>!   MACHINE : IBM SP<a name='2613'></font>
<font color=#447700>!<a name='2614'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2615'></font>
<font color=#447700>!<a name='2616'></font>
<font color=#447700>!<a name='2617'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2618'></font>
      IMPLICIT NONE<a name='2619'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2620'></font>
<font color=#447700>!------------------------------------------------------------------------- <a name='2621'></font>
<font color=#447700>!-------------- Parameters &amp; arrays for lookup tables -------------------- <a name='2622'></font>
<font color=#447700>!------------------------------------------------------------------------- <a name='2623'></font>
<font color=#447700>!<a name='2624'></font>
<font color=#447700>!--- Common block of constants used in column microphysics<a name='2625'></font>
<font color=#447700>!<a name='2626'></font>
<font color=#447700>!WRF<a name='2627'></font>
<font color=#447700>!     real DLMD,DPHD<a name='2628'></font>
<font color=#447700>!WRF<a name='2629'></font>
<font color=#447700>!<a name='2630'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2631'></font>
<font color=#447700>!--- Parameters &amp; data statement for local calculations<a name='2632'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2633'></font>
<font color=#447700>!<a name='2634'></font>
      INTEGER, PARAMETER :: MDR1=XMR1, MDR2=XMR2, MDR3=XMR3<a name='2635'>
<font color=#447700>!<a name='2636'></font>
<font color=#447700>!     VARIABLES PASSED IN<a name='2637'></font>
      integer,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='2638'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp; <a name='2639'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE       <a name='2640'>
<font color=#447700>!WRF<a name='2641'></font>
       INTEGER, DIMENSION(ims:ime,jms:jme),INTENT(INOUT) :: LOWLYR<a name='2642'>
<font color=#447700>!<a name='2643'></font>
      real, INTENT(IN) ::  DELX,DELY<a name='2644'>
<font color=#447700>!HWRF      real,DIMENSION(*), INTENT(INOUT) :: MP_RESTART_STATE<a name='2645'></font>
<font color=#447700>!HWRF      real,DIMENSION(NX), INTENT(INOUT) :: TBPVS_STATE,TBPVS0_STATE<a name='2646'></font>
      real,DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(OUT),OPTIONAL :: &amp;<a name='2647'>
     &amp;  F_ICE_PHY,F_RAIN_PHY,F_RIMEF_PHY<a name='2648'>
      INTEGER, PARAMETER :: ITLO=-60, ITHI=40<a name='2649'>
<font color=#447700>!     integer,DIMENSION(ITLO:ITHI,4),INTENT(INOUT) :: NSTATS<a name='2650'></font>
<font color=#447700>!     real,DIMENSION(ITLO:ITHI,5),INTENT(INOUT) :: QMAX<a name='2651'></font>
<font color=#447700>!     real,DIMENSION(ITLO:ITHI,22),INTENT(INOUT) :: QTOT<a name='2652'></font>
<font color=#447700>!     real,INTENT(INOUT) :: PRECtot(2),PRECmax(2)<a name='2653'></font>
      real,INTENT(IN) :: DT,GSMDT<a name='2654'>
      LOGICAL,INTENT(IN) :: allowed_to_read,restart<a name='2655'>
<font color=#447700>!<a name='2656'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2657'></font>
<font color=#447700>!     LOCAL VARIABLES<a name='2658'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2659'></font>
      REAL :: BBFR,DTPH,DX,Thour_print,RDIS<a name='2660'>
      INTEGER :: I,IM,J,L,K,JTF,KTF,ITF<a name='2661'>
      INTEGER :: etampnew_unit1<a name='2662'>
      LOGICAL :: opened<a name='2663'>
      LOGICAL , EXTERNAL      :: wrf_dm_on_monitor<a name='2664'>
      CHARACTER*80 errmess<a name='2665'>
<font color=#447700>!<a name='2666'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2667'></font>
<font color=#447700>!<a name='2668'></font>
      JTF=MIN0(JTE,JDE-1)<a name='2669'>
      KTF=MIN0(KTE,KDE-1)<a name='2670'>
      ITF=MIN0(ITE,IDE-1)<a name='2671'>
<font color=#447700>!<a name='2672'></font>
      DO J=JTS,JTF<a name='2673'>
      DO I=ITS,ITF<a name='2674'>
        LOWLYR(I,J)=1<a name='2675'>
      ENDDO<a name='2676'>
      ENDDO<a name='2677'>
<font color=#447700>!    <a name='2678'></font>
      IF(.NOT.RESTART .AND. ALLOWED_TO_READ .AND. present(F_ICE_PHY)) THEN    <font color=#447700>!HWRF<a name='2679'></font>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_644">(1,'WARNING: F_ICE_PHY,F_RAIN_PHY AND F_RIMEF_PHY IS REINITIALIZED')   <font color=#447700>!HWRF<a name='2680'></font>
        DO J = jts,jte<a name='2681'>
        DO K = kts,kte<a name='2682'>
        DO I= its,ite<a name='2683'>
          F_ICE_PHY(i,k,j)=0.<a name='2684'>
          F_RAIN_PHY(i,k,j)=0.<a name='2685'>
          F_RIMEF_PHY(i,k,j)=1.<a name='2686'>
        ENDDO<a name='2687'>
        ENDDO<a name='2688'>
        ENDDO<a name='2689'>
      ENDIF<a name='2690'>
<font color=#447700>!    <a name='2691'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2692'></font>
      IF(ALLOWED_TO_READ)THEN<a name='2693'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2694'></font>
<font color=#447700>!<a name='2695'></font>
        DX=SQRT((DELX)**2+(DELY)**2)/1000.    <font color=#447700>! Model resolution at equator (km)  !GFDL<a name='2696'></font>
        DX=MIN(100., MAX(5., DX) )<a name='2697'>
<font color=#447700>!<a name='2698'></font>
<font color=#447700>!-- Relative humidity threshold for the onset of grid-scale condensation<a name='2699'></font>
<font color=#447700>!!-- 9/1/01:  Assume the following functional dependence for 5 - 100 km resolution:<a name='2700'></font>
<font color=#447700>!!       RHgrd=0.90 for dx=100 km, 0.98 for dx=5 km, where<a name='2701'></font>
<font color=#447700>!        RHgrd=0.90+.08*((100.-DX)/95.)**.5<a name='2702'></font>
<font color=#447700>!<a name='2703'></font>
        DTPH=MAX(GSMDT*60.,DT)<a name='2704'>
        DTPH=NINT(DTPH/DT)*DT<a name='2705'>
<font color=#447700>!<a name='2706'></font>
<font color=#447700>!--- Create lookup tables for saturation vapor pressure w/r/t water &amp; ice<a name='2707'></font>
<font color=#447700>!<a name='2708'></font>
        CALL <A href='../../html_code/phys/module_mp_HWRF.F.html#GPVS'>GPVS</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GPVS_4"><a name='2709'>
<font color=#447700>!<a name='2710'></font>
<font color=#447700>!--- Read in various lookup tables<a name='2711'></font>
<font color=#447700>!<a name='2712'></font>
        IF ( wrf_dm_on_monitor() ) THEN<a name='2713'>
          DO i = 31,99<a name='2714'>
            INQUIRE ( i , OPENED = opened )<a name='2715'>
            IF ( .NOT. opened ) THEN<a name='2716'>
              etampnew_unit1 = i<a name='2717'>
              GOTO 2061<a name='2718'>
            ENDIF<a name='2719'>
          ENDDO<a name='2720'>
          etampnew_unit1 = -1<a name='2721'>
 2061     CONTINUE<a name='2722'>
        ENDIF<a name='2723'>
<font color=#447700>!<a name='2724'></font>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_199"> ( etampnew_unit1 , IWORDSIZE )<a name='2725'>
<font color=#447700>!<a name='2726'></font>
        IF ( etampnew_unit1 &lt; 0 ) THEN<a name='2727'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_771"> ( 'module_mp_fer_hires: fer_hires_init: Can not find unused fortran unit to read in lookup table.' )<a name='2728'>
        ENDIF<a name='2729'>
<font color=#447700>!<a name='2730'></font>
        IF ( wrf_dm_on_monitor() ) THEN<a name='2731'>
<font color=#447700>!!was     OPEN (UNIT=1,FILE="eta_micro_lookup.dat",FORM="UNFORMATTED")<a name='2732'></font>
<font color=#447700>!-- Use the new, expanded tables for rain (maximum mean diameter of 1 mm rather than 0.45 mm)<a name='2733'></font>
<font color=#447700>!old      OPEN(UNIT=etampnew_unit1,FILE="ETAMPNEW_DATA",                  &amp;<a name='2734'></font>
          print*,'open ETAMPNEW_DATA.expanded_rain, in fer_hires' <a name='2735'>
          OPEN(UNIT=etampnew_unit1,FILE="ETAMPNEW_DATA.expanded_rain",  &amp;<a name='2736'>
     &amp;        FORM="UNFORMATTED",STATUS="OLD",ERR=9061)<a name='2737'>
<font color=#447700>!<a name='2738'></font>
          READ(etampnew_unit1) VENTR1<a name='2739'>
          READ(etampnew_unit1) VENTR2<a name='2740'>
          READ(etampnew_unit1) ACCRR<a name='2741'>
          READ(etampnew_unit1) MASSR<a name='2742'>
          READ(etampnew_unit1) VRAIN<a name='2743'>
          READ(etampnew_unit1) RRATE<a name='2744'>
          READ(etampnew_unit1) VENTI1<a name='2745'>
          READ(etampnew_unit1) VENTI2<a name='2746'>
          READ(etampnew_unit1) ACCRI<a name='2747'>
          READ(etampnew_unit1) MASSI<a name='2748'>
          READ(etampnew_unit1) VSNOWI<a name='2749'>
          READ(etampnew_unit1) VEL_RF<a name='2750'>
<font color=#447700>!        read(etampnew_unit1) my_growth    ! Applicable only for DTPH=180 s<a name='2751'></font>
          CLOSE (etampnew_unit1)<a name='2752'>
        ENDIF<a name='2753'>
<font color=#447700>!<a name='2754'></font>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_200"> ( VENTR1 , size ( VENTR1 ) * RWORDSIZE )<a name='2755'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_201"> ( VENTR2 , size ( VENTR2 ) * RWORDSIZE )<a name='2756'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_202"> ( ACCRR , size ( ACCRR ) * RWORDSIZE )<a name='2757'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_203"> ( MASSR , size ( MASSR ) * RWORDSIZE )<a name='2758'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_204"> ( VRAIN , size ( VRAIN ) * RWORDSIZE )<a name='2759'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_205"> ( RRATE , size ( RRATE ) * RWORDSIZE )<a name='2760'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_206"> ( VENTI1 , size ( VENTI1 ) * RWORDSIZE )<a name='2761'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_207"> ( VENTI2 , size ( VENTI2 ) * RWORDSIZE )<a name='2762'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_208"> ( ACCRI , size ( ACCRI ) * RWORDSIZE )<a name='2763'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_209"> ( MASSI , size ( MASSI ) * RWORDSIZE )<a name='2764'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_210"> ( VSNOWI , size ( VSNOWI ) * RWORDSIZE )<a name='2765'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_211"> ( VEL_RF , size ( VEL_RF ) * RWORDSIZE )<a name='2766'>
<font color=#447700>!<a name='2767'></font>
<font color=#447700>!--- Calculates coefficients for growth rates of ice nucleated in water<a name='2768'></font>
<font color=#447700>!    saturated conditions, scaled by physics time step (lookup table)<a name='2769'></font>
<font color=#447700>!<a name='2770'></font>
        CALL <A href='../../html_code/phys/module_mp_HWRF.F.html#MY_GROWTH_RATES'>MY_GROWTH_RATES</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MY_GROWTH_RATES_4"> (DTPH)<a name='2771'>
<font color=#447700>!<a name='2772'></font>
        PI_E=ACOS(-1.)<a name='2773'>
<font color=#447700>!<a name='2774'></font>
<font color=#447700>!--- Constants associated with Biggs (1953) freezing of rain, as parameterized<a name='2775'></font>
<font color=#447700>!    following Lin et al. (JCAM, 1983) &amp; Reisner et al. (1998, QJRMS).<a name='2776'></font>
<font color=#447700>!<a name='2777'></font>
        ABFR=-0.66<a name='2778'>
        BBFR=100.<a name='2779'>
        CBFR=20.*PI_E*PI_E*BBFR*RHOL*1.E-21<a name='2780'>
<font color=#447700>!<a name='2781'></font>
<font color=#447700>!--- CIACW is used in calculating riming rates<a name='2782'></font>
<font color=#447700>!      The assumed effective collection efficiency of cloud water rimed onto<a name='2783'></font>
<font color=#447700>!      ice is =0.5 below:<a name='2784'></font>
<font color=#447700>!<a name='2785'></font>
        CIACW=DTPH*0.25*PI_E*0.5*(1.E5)**C1<a name='2786'>
<font color=#447700>!<a name='2787'></font>
<font color=#447700>!--- CIACR is used in calculating freezing of rain colliding with large ice<a name='2788'></font>
<font color=#447700>!      The assumed collection efficiency is 1.0<a name='2789'></font>
<font color=#447700>!<a name='2790'></font>
        CIACR=PI_E*DTPH<a name='2791'>
<font color=#447700>!<a name='2792'></font>
<font color=#447700>!--- Based on rain lookup tables for mean diameters from 0.05 to 0.45 mm<a name='2793'></font>
<font color=#447700>!    * Four different functional relationships of mean drop diameter as <a name='2794'></font>
<font color=#447700>!      a function of rain rate (RR), derived based on simple fits to <a name='2795'></font>
<font color=#447700>!      mass-weighted fall speeds of rain as functions of mean diameter<a name='2796'></font>
<font color=#447700>!      from the lookup tables.  <a name='2797'></font>
<font color=#447700>!<a name='2798'></font>
        RR_DRmin=N0r0*RRATE(MDRmin)     <font color=#447700>! RR for mean drop diameter of .05 mm<a name='2799'></font>
        RR_DR1=N0r0*RRATE(MDR1)         <font color=#447700>! RR for mean drop diameter of .10 mm<a name='2800'></font>
        RR_DR2=N0r0*RRATE(MDR2)         <font color=#447700>! RR for mean drop diameter of .20 mm<a name='2801'></font>
        RR_DR3=N0r0*RRATE(MDR3)         <font color=#447700>! RR for mean drop diameter of .32 mm<a name='2802'></font>
        RR_DR4=N0r0*RRATE(MDR4)         <font color=#447700>! RR for mean drop diameter of .45 mm<a name='2803'></font>
        RR_DR5=N0r0*RRATE(MDR5)         <font color=#447700>! RR for mean drop diameter of .675 mm<a name='2804'></font>
        RR_DRmax=N0r0*RRATE(MDRmax)     <font color=#447700>! RR for mean drop diameter of 1.0 mm<a name='2805'></font>
<font color=#447700>!<a name='2806'></font>
        RQR_DRmin=N0r0*MASSR(MDRmin)    <font color=#447700>! Rain content for mean drop diameter of .05 mm<a name='2807'></font>
        RQR_DRmax=N0r0*MASSR(MDRmax)    <font color=#447700>! Rain content for mean drop diameter of 1.0 mm<a name='2808'></font>
        C_N0r0=PI_E*RHOL*N0r0<a name='2809'>
        CN0r0=1.E6/SQRT(SQRT(C_N0r0))<a name='2810'>
        CN0r_DMRmin=1./(PI_E*RHOL*DMRmin*DMRmin*DMRmin*DMRmin)<a name='2811'>
        CN0r_DMRmax=1./(PI_E*RHOL*DMRmax*DMRmax*DMRmax*DMRmax)<a name='2812'>
<font color=#447700>!<a name='2813'></font>
<font color=#447700>!--- CRACW is used in calculating collection of cloud water by rain (an<a name='2814'></font>
<font color=#447700>!      assumed collection efficiency of 1.0)<a name='2815'></font>
<font color=#447700>!<a name='2816'></font>
        CRACW=DTPH*0.25*PI_E*1.0<a name='2817'>
<font color=#447700>!<a name='2818'></font>
        ESW0=1000.*FPVS0(T0C)     <font color=#447700>! Saturation vapor pressure at 0C<a name='2819'></font>
        RFmax=1.1**Nrime          <font color=#447700>! Maximum rime factor allowed<a name='2820'></font>
<font color=#447700>!<a name='2821'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2822'></font>
<font color=#447700>!--------------- Constants passed through argument list -----------------<a name='2823'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2824'></font>
<font color=#447700>!<a name='2825'></font>
<font color=#447700>!--- Important parameters for self collection (autoconversion) of <a name='2826'></font>
<font color=#447700>!    cloud water to rain. <a name='2827'></font>
<font color=#447700>!<a name='2828'></font>
<font color=#447700>!-- Relative dispersion == standard deviation of droplet spectrum / mean radius<a name='2829'></font>
<font color=#447700>!   (see pp 1542-1543, Liu &amp; Daum, JAS, 2004)<a name='2830'></font>
        RDIS=0.5  <font color=#447700>!-- relative dispersion of droplet spectrum<a name='2831'></font>
        BETA6=( (1.+3.*RDIS*RDIS)*(1.+4.*RDIS*RDIS)*(1.+5.*RDIS*RDIS)/  &amp;<a name='2832'>
     &amp;         ((1.+RDIS*RDIS)*(1.+2.*RDIS*RDIS) ) )<a name='2833'>
<font color=#447700>!-- Kappa=1.1e10 g^-2 cm^3 s^-1 after eq. (8b) on p.1105 of Liu et al. (JAS, 2006)<a name='2834'></font>
<font color=#447700>!   =&gt; More extensive units conversion than can be described here to go from<a name='2835'></font>
<font color=#447700>!      eq. (13) in Liu et al. (JAS, 2006) to what's programmed below.  Note that<a name='2836'></font>
<font color=#447700>!      the units used throughout the paper are in cgs units!<a name='2837'></font>
<font color=#447700>!<a name='2838'></font>
        ARAUT=1.03e19/(NCW*SQRT(NCW))<a name='2839'>
        BRAUT=DTPH*1.1E10*BETA6/NCW<a name='2840'>
<font color=#447700>!<a name='2841'></font>
<font color=#447700>!--- For calculating snow optical depths by considering bulk density of<a name='2842'></font>
<font color=#447700>!      snow based on emails from Q. Fu (6/27-28/01), where optical <a name='2843'></font>
<font color=#447700>!      depth (T) = 1.5*SWP/(Reff*DENS), SWP is snow water path, Reff <a name='2844'></font>
<font color=#447700>!      is effective radius, and DENS is the bulk density of snow.<a name='2845'></font>
<font color=#447700>!<a name='2846'></font>
<font color=#447700>!    SWP (kg/m**2)=(1.E-3 kg/g)*SWPrad, SWPrad in g/m**2 used in radiation<a name='2847'></font>
<font color=#447700>!    T = 1.5*1.E3*SWPrad/(Reff*DENS)<a name='2848'></font>
<font color=#447700>!  <a name='2849'></font>
<font color=#447700>!    See derivation for MASSI(INDEXS), note equal to RHO*QSNOW/NSNOW<a name='2850'></font>
<font color=#447700>!<a name='2851'></font>
<font color=#447700>!      SDENS=1.5e3/DENS, DENS=MASSI(INDEXS)/[PI_E*(1.E-6*INDEXS)**3]<a name='2852'></font>
<font color=#447700>!<a name='2853'></font>
        DO I=MDImin,MDImax<a name='2854'>
          SDENS(I)=PI_E*1.5E-15*FLOAT(I*I*I)/MASSI(I)<a name='2855'>
        ENDDO<a name='2856'>
<font color=#447700>!<a name='2857'></font>
        Thour_print=-DTPH/3600.<a name='2858'>
<a name='2859'>
<a name='2860'>
      ENDIF  <font color=#447700>! Allowed_to_read<a name='2861'></font>
<a name='2862'>
      RETURN<a name='2863'>
<font color=#447700>!<a name='2864'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2865'></font>
<font color=#447700>!<a name='2866'></font>
9061 CONTINUE<a name='2867'>
      WRITE( errmess , '(A,I4)' )                                        &amp;<a name='2868'>
       'module_mp_hwrf: error opening ETAMPNEW_DATA on unit '          &amp;<a name='2869'>
     &amp;, etampnew_unit1<a name='2870'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_fer_hires.F.html#FER_HIRES_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_772">(errmess)<a name='2871'>
<font color=#447700>!<a name='2872'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2873'></font>
      END SUBROUTINE fer_hires_init<a name='2874'>
<font color=#447700>!<a name='2875'></font>
<A NAME='MY_GROWTH_RATES'><A href='../../html_code/phys/module_mp_fer_hires.F.html#MY_GROWTH_RATES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2876'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>MY_GROWTH_RATES</font> (DTPH) <A href='../../call_to/MY_GROWTH_RATES.html' TARGET='index'>6</A><a name='2877'>
<font color=#447700>!<a name='2878'></font>
<font color=#447700>!--- Below are tabulated values for the predicted mass of ice crystals<a name='2879'></font>
<font color=#447700>!    after 600 s of growth in water saturated conditions, based on <a name='2880'></font>
<font color=#447700>!    calculations from Miller and Young (JAS, 1979).  These values are<a name='2881'></font>
<font color=#447700>!    crudely estimated from tabulated curves at 600 s from Fig. 6.9 of<a name='2882'></font>
<font color=#447700>!    Young (1993).  Values at temperatures colder than -27C were <a name='2883'></font>
<font color=#447700>!    assumed to be invariant with temperature.  <a name='2884'></font>
<font color=#447700>!<a name='2885'></font>
<font color=#447700>!--- Used to normalize Miller &amp; Young (1979) calculations of ice growth<a name='2886'></font>
<font color=#447700>!    over large time steps using their tabulated values at 600 s.<a name='2887'></font>
<font color=#447700>!    Assumes 3D growth with time**1.5 following eq. (6.3) in Young (1993).<a name='2888'></font>
<font color=#447700>!<a name='2889'></font>
      IMPLICIT NONE<a name='2890'>
<font color=#447700>!<a name='2891'></font>
      REAL,INTENT(IN) :: DTPH<a name='2892'>
<font color=#447700>!<a name='2893'></font>
      REAL  DT_ICE<a name='2894'>
      REAL,DIMENSION(35) :: MY_600<a name='2895'>
<font color=#447700>!WRF<a name='2896'></font>
<font color=#447700>!<a name='2897'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2898'></font>
      DATA MY_600 /                                                     &amp;<a name='2899'>
     &amp; 5.5e-8, 1.4E-7, 2.8E-7, 6.E-7, 3.3E-6,                           &amp; <a name='2900'>
     &amp; 2.E-6, 9.E-7, 8.8E-7, 8.2E-7, 9.4e-7,                            &amp; <a name='2901'>
     &amp; 1.2E-6, 1.85E-6, 5.5E-6, 1.5E-5, 1.7E-5,                         &amp; <a name='2902'>
     &amp; 1.5E-5, 1.E-5, 3.4E-6, 1.85E-6, 1.35E-6,                         &amp; <a name='2903'>
     &amp; 1.05E-6, 1.E-6, 9.5E-7, 9.0E-7, 9.5E-7,                          &amp; <a name='2904'>
     &amp; 9.5E-7, 9.E-7, 9.E-7, 9.E-7, 9.E-7,                              &amp; <a name='2905'>
     &amp; 9.E-7, 9.E-7, 9.E-7, 9.E-7, 9.E-7 /        <font color=#447700>! -31 to -35 deg C<a name='2906'></font>
<font color=#447700>!<a name='2907'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2908'></font>
<font color=#447700>!<a name='2909'></font>
      DT_ICE=(DTPH/600.)**1.5<a name='2910'>
      MY_GROWTH=DT_ICE*MY_600*1.E-3    <font color=#447700>!-- 20090714: Convert from g to kg<a name='2911'></font>
<font color=#447700>!<a name='2912'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2913'></font>
<font color=#447700>!<a name='2914'></font>
      END SUBROUTINE MY_GROWTH_RATES<a name='2915'>
<font color=#447700>!<a name='2916'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2917'></font>
<font color=#447700>!---------  Old GFS saturation vapor pressure lookup tables  -----------<a name='2918'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2919'></font>
<font color=#447700>!<a name='2920'></font>
<A NAME='GPVS'><A href='../../html_code/phys/module_mp_fer_hires.F.html#GPVS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2921'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>GPVS</font> <A href='../../call_to/GPVS.html' TARGET='index'>6</A>,<A href='../../call_from/GPVS.html' TARGET='index'>8</A><a name='2922'>
<font color=#447700>!     ******************************************************************<a name='2923'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='2924'></font>
<font color=#447700>!                .      .    .<a name='2925'></font>
<font color=#447700>! SUBPROGRAM:    GPVS        COMPUTE SATURATION VAPOR PRESSURE TABLE<a name='2926'></font>
<font color=#447700>!   AUTHOR: N PHILLIPS       W/NP2      DATE: 30 DEC 82<a name='2927'></font>
<font color=#447700>!<a name='2928'></font>
<font color=#447700>! ABSTRACT: COMPUTE SATURATION VAPOR PRESSURE TABLE AS A FUNCTION OF<a name='2929'></font>
<font color=#447700>!   TEMPERATURE FOR THE TABLE LOOKUP FUNCTION FPVS.<a name='2930'></font>
<font color=#447700>!   EXACT SATURATION VAPOR PRESSURES ARE CALCULATED IN SUBPROGRAM FPVSX.<a name='2931'></font>
<font color=#447700>!   THE CURRENT IMPLEMENTATION COMPUTES A TABLE WITH A LENGTH<a name='2932'></font>
<font color=#447700>!   OF 7501 FOR TEMPERATURES RANGING FROM 180.0 TO 330.0 KELVIN.<a name='2933'></font>
<font color=#447700>!<a name='2934'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='2935'></font>
<font color=#447700>!   91-05-07  IREDELL<a name='2936'></font>
<font color=#447700>!   94-12-30  IREDELL             EXPAND TABLE<a name='2937'></font>
<font color=#447700>!   96-02-19  HONG                ICE EFFECT<a name='2938'></font>
<font color=#447700>!   01-11-29  JIN                 MODIFIED FOR WRF<a name='2939'></font>
<font color=#447700>!<a name='2940'></font>
<font color=#447700>! USAGE:  CALL GPVS<a name='2941'></font>
<font color=#447700>!<a name='2942'></font>
<font color=#447700>! SUBPROGRAMS CALLED:<a name='2943'></font>
<font color=#447700>!   (FPVSX)  - INLINABLE FUNCTION TO COMPUTE SATURATION VAPOR PRESSURE<a name='2944'></font>
<font color=#447700>!<a name='2945'></font>
<font color=#447700>! COMMON BLOCKS:<a name='2946'></font>
<font color=#447700>!   COMPVS   - SCALING PARAMETERS AND TABLE FOR FUNCTION FPVS.<a name='2947'></font>
<font color=#447700>!<a name='2948'></font>
<font color=#447700>! ATTRIBUTES:<a name='2949'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='2950'></font>
<font color=#447700>!<a name='2951'></font>
<font color=#447700>!$$$<a name='2952'></font>
      IMPLICIT NONE<a name='2953'>
      real :: X,XINC,T<a name='2954'>
      integer :: JX<a name='2955'>
<font color=#447700>!----------------------------------------------------------------------<a name='2956'></font>
      XINC=(XMAX-XMIN)/(NX-1)<a name='2957'>
      C1XPVS=1.-XMIN/XINC<a name='2958'>
      C2XPVS=1./XINC<a name='2959'>
      C1XPVS0=1.-XMIN/XINC<a name='2960'>
      C2XPVS0=1./XINC<a name='2961'>
<font color=#447700>!<a name='2962'></font>
      DO JX=1,NX<a name='2963'>
        X=XMIN+(JX-1)*XINC<a name='2964'>
        T=X<a name='2965'>
        TBPVS(JX)=<A href='../../html_code/phys/module_shcu_grims.F.html#FPVSX'>FPVSX</A><A href='../../html_code/phys/module_mp_HWRF.F.html#GPVS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPVSX_3">(T)<a name='2966'>
        TBPVS0(JX)=<A href='../../html_code/phys/module_mp_HWRF.F.html#FPVSX0'>FPVSX0</A><A href='../../html_code/phys/module_mp_HWRF.F.html#GPVS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPVSX0_2">(T)<a name='2967'>
      ENDDO<a name='2968'>
<font color=#447700>! <a name='2969'></font>
      END SUBROUTINE GPVS<a name='2970'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2971'></font>
<font color=#447700>!***********************************************************************<a name='2972'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2973'></font>
<A NAME='FPVS'><A href='../../html_code/phys/module_mp_fer_hires.F.html#FPVS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2974'>
                     REAL   <font color=#993300>FUNCTION </font><font color=#cc0000>FPVS</font>(T) <A href='../../call_to/FPVS.html' TARGET='index'>9</A>,<A href='../../call_from/FPVS.html' TARGET='index'>1</A><a name='2975'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2976'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='2977'></font>
<font color=#447700>!                .      .    .<a name='2978'></font>
<font color=#447700>! SUBPROGRAM:    FPVS        COMPUTE SATURATION VAPOR PRESSURE<a name='2979'></font>
<font color=#447700>!   AUTHOR: N PHILLIPS            W/NP2      DATE: 30 DEC 82<a name='2980'></font>
<font color=#447700>!<a name='2981'></font>
<font color=#447700>! ABSTRACT: COMPUTE SATURATION VAPOR PRESSURE FROM THE TEMPERATURE.<a name='2982'></font>
<font color=#447700>!   A LINEAR INTERPOLATION IS DONE BETWEEN VALUES IN A LOOKUP TABLE<a name='2983'></font>
<font color=#447700>!   COMPUTED IN GPVS. SEE DOCUMENTATION FOR FPVSX FOR DETAILS.<a name='2984'></font>
<font color=#447700>!   INPUT VALUES OUTSIDE TABLE RANGE ARE RESET TO TABLE EXTREMA.<a name='2985'></font>
<font color=#447700>!   THE INTERPOLATION ACCURACY IS ALMOST 6 DECIMAL PLACES.<a name='2986'></font>
<font color=#447700>!   ON THE CRAY, FPVS IS ABOUT 4 TIMES FASTER THAN EXACT CALCULATION.<a name='2987'></font>
<font color=#447700>!   THIS FUNCTION SHOULD BE EXPANDED INLINE IN THE CALLING ROUTINE.<a name='2988'></font>
<font color=#447700>!<a name='2989'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='2990'></font>
<font color=#447700>!   91-05-07  IREDELL             MADE INTO INLINABLE FUNCTION<a name='2991'></font>
<font color=#447700>!   94-12-30  IREDELL             EXPAND TABLE<a name='2992'></font>
<font color=#447700>!   96-02-19  HONG                ICE EFFECT<a name='2993'></font>
<font color=#447700>!   01-11-29  JIN                 MODIFIED FOR WRF<a name='2994'></font>
<font color=#447700>!<a name='2995'></font>
<font color=#447700>! USAGE:   PVS=FPVS(T)<a name='2996'></font>
<font color=#447700>!<a name='2997'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='2998'></font>
<font color=#447700>!     T        - REAL TEMPERATURE IN KELVIN<a name='2999'></font>
<font color=#447700>!<a name='3000'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST:<a name='3001'></font>
<font color=#447700>!     FPVS     - REAL SATURATION VAPOR PRESSURE IN KILOPASCALS (CB)<a name='3002'></font>
<font color=#447700>!<a name='3003'></font>
<font color=#447700>! ATTRIBUTES:<a name='3004'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='3005'></font>
<font color=#447700>!$$$<a name='3006'></font>
      IMPLICIT NONE<a name='3007'>
      real,INTENT(IN) :: T<a name='3008'>
      real XJ<a name='3009'>
      integer :: JX<a name='3010'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3011'></font>
      XJ=MIN(MAX(C1XPVS+C2XPVS*T,1.),FLOAT(NX))<a name='3012'>
      JX=MIN(XJ,NX-1.)<a name='3013'>
      FPVS=TBPVS(JX)+(XJ-JX)*(TBPVS(JX+1)-TBPVS(JX))<a name='3014'>
<font color=#447700>!<a name='3015'></font>
      END FUNCTION FPVS<a name='3016'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3017'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3018'></font>
<A NAME='FPVS0'><A href='../../html_code/phys/module_mp_fer_hires.F.html#FPVS0' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3019'>
                     REAL <font color=#993300>FUNCTION </font><font color=#cc0000>FPVS0</font>(T)<a name='3020'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3021'></font>
      IMPLICIT NONE<a name='3022'>
      real,INTENT(IN) :: T<a name='3023'>
      real :: XJ1<a name='3024'>
      integer :: JX1<a name='3025'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3026'></font>
      XJ1=MIN(MAX(C1XPVS0+C2XPVS0*T,1.),FLOAT(NX))<a name='3027'>
      JX1=MIN(XJ1,NX-1.)<a name='3028'>
      FPVS0=TBPVS0(JX1)+(XJ1-JX1)*(TBPVS0(JX1+1)-TBPVS0(JX1))<a name='3029'>
<font color=#447700>!<a name='3030'></font>
      END FUNCTION FPVS0<a name='3031'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3032'></font>
<font color=#447700>!***********************************************************************<a name='3033'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3034'></font>
<A NAME='FPVSX'><A href='../../html_code/phys/module_mp_fer_hires.F.html#FPVSX' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3035'>
                    REAL <font color=#993300>FUNCTION </font><font color=#cc0000>FPVSX</font>(T) <A href='../../call_to/FPVSX.html' TARGET='index'>5</A>,<A href='../../call_from/FPVSX.html' TARGET='index'>1</A><a name='3036'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3037'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='3038'></font>
<font color=#447700>!                .      .    .<a name='3039'></font>
<font color=#447700>! SUBPROGRAM:    FPVSX       COMPUTE SATURATION VAPOR PRESSURE<a name='3040'></font>
<font color=#447700>!   AUTHOR: N PHILLIPS            W/NP2      DATE: 30 DEC 82<a name='3041'></font>
<font color=#447700>!<a name='3042'></font>
<font color=#447700>! ABSTRACT: EXACTLY COMPUTE SATURATION VAPOR PRESSURE FROM TEMPERATURE.<a name='3043'></font>
<font color=#447700>!   THE WATER MODEL ASSUMES A PERFECT GAS, CONSTANT SPECIFIC HEATS<a name='3044'></font>
<font color=#447700>!   FOR GAS AND LIQUID, AND NEGLECTS THE VOLUME OF THE LIQUID.<a name='3045'></font>
<font color=#447700>!   THE MODEL DOES ACCOUNT FOR THE VARIATION OF THE LATENT HEAT<a name='3046'></font>
<font color=#447700>!   OF CONDENSATION WITH TEMPERATURE.  THE ICE OPTION IS NOT INCLUDED.<a name='3047'></font>
<font color=#447700>!   THE CLAUSIUS-CLAPEYRON EQUATION IS INTEGRATED FROM THE TRIPLE POINT<a name='3048'></font>
<font color=#447700>!   TO GET THE FORMULA<a name='3049'></font>
<font color=#447700>!       PVS=PSATK*(TR**XA)*EXP(XB*(1.-TR))<a name='3050'></font>
<font color=#447700>!   WHERE TR IS TTP/T AND OTHER VALUES ARE PHYSICAL CONSTANTS<a name='3051'></font>
<font color=#447700>!   THIS FUNCTION SHOULD BE EXPANDED INLINE IN THE CALLING ROUTINE.<a name='3052'></font>
<font color=#447700>!<a name='3053'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='3054'></font>
<font color=#447700>!   91-05-07  IREDELL             MADE INTO INLINABLE FUNCTION<a name='3055'></font>
<font color=#447700>!   94-12-30  IREDELL             EXACT COMPUTATION<a name='3056'></font>
<font color=#447700>!   96-02-19  HONG                ICE EFFECT <a name='3057'></font>
<font color=#447700>!   01-11-29  JIN                 MODIFIED FOR WRF<a name='3058'></font>
<font color=#447700>!<a name='3059'></font>
<font color=#447700>! USAGE:   PVS=FPVSX(T)<a name='3060'></font>
<font color=#447700>! REFERENCE:   EMANUEL(1994),116-117<a name='3061'></font>
<font color=#447700>!<a name='3062'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='3063'></font>
<font color=#447700>!     T        - REAL TEMPERATURE IN KELVIN<a name='3064'></font>
<font color=#447700>!<a name='3065'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST:<a name='3066'></font>
<font color=#447700>!     FPVSX    - REAL SATURATION VAPOR PRESSURE IN KILOPASCALS (CB)<a name='3067'></font>
<font color=#447700>!<a name='3068'></font>
<font color=#447700>! ATTRIBUTES:<a name='3069'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='3070'></font>
<font color=#447700>!$$$<a name='3071'></font>
      IMPLICIT NONE<a name='3072'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3073'></font>
       real, parameter :: TTP=2.7316E+2,HVAP=2.5000E+6,PSAT=6.1078E+2   &amp;<a name='3074'>
      ,         CLIQ=4.1855E+3,CVAP= 1.8460E+3                          &amp;<a name='3075'>
      ,         CICE=2.1060E+3,HSUB=2.8340E+6<a name='3076'>
<font color=#447700>!<a name='3077'></font>
      real, parameter :: PSATK=PSAT*1.E-3<a name='3078'>
      real, parameter :: DLDT=CVAP-CLIQ,XA=-DLDT/RV,XB=XA+HVAP/(RV*TTP)<a name='3079'>
      real, parameter :: DLDTI=CVAP-CICE                                &amp;<a name='3080'>
      ,                  XAI=-DLDTI/RV,XBI=XAI+HSUB/(RV*TTP)<a name='3081'>
      real T,TR<a name='3082'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3083'></font>
      TR=TTP/T<a name='3084'>
<font color=#447700>!<a name='3085'></font>
      IF(T.GE.TTP)THEN<a name='3086'>
        FPVSX=PSATK*(TR**XA)*EXP(XB*(1.-TR))<a name='3087'>
      ELSE<a name='3088'>
        FPVSX=PSATK*(TR**XAI)*EXP(XBI*(1.-TR))<a name='3089'>
      ENDIF<a name='3090'>
<font color=#447700>! <a name='3091'></font>
      END FUNCTION FPVSX<a name='3092'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3093'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3094'></font>
<A NAME='FPVSX0'><A href='../../html_code/phys/module_mp_fer_hires.F.html#FPVSX0' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3095'>
                 REAL   <font color=#993300>FUNCTION </font><font color=#cc0000>FPVSX0</font>(T) <A href='../../call_to/FPVSX0.html' TARGET='index'>3</A><a name='3096'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3097'></font>
      IMPLICIT NONE<a name='3098'>
      real,parameter :: TTP=2.7316E+2,HVAP=2.5000E+6,PSAT=6.1078E+2     &amp;<a name='3099'>
      ,         CLIQ=4.1855E+3,CVAP=1.8460E+3                           &amp;<a name='3100'>
      ,         CICE=2.1060E+3,HSUB=2.8340E+6<a name='3101'>
      real,PARAMETER :: PSATK=PSAT*1.E-3<a name='3102'>
      real,PARAMETER :: DLDT=CVAP-CLIQ,XA=-DLDT/RV,XB=XA+HVAP/(RV*TTP)<a name='3103'>
      real,PARAMETER :: DLDTI=CVAP-CICE                                 &amp;<a name='3104'>
      ,                 XAI=-DLDT/RV,XBI=XA+HSUB/(RV*TTP)<a name='3105'>
      real :: T,TR<a name='3106'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3107'></font>
      TR=TTP/T<a name='3108'>
      FPVSX0=PSATK*(TR**XA)*EXP(XB*(1.-TR))<a name='3109'>
<font color=#447700>!<a name='3110'></font>
      END FUNCTION FPVSX0<a name='3111'>
<font color=#447700>!<a name='3112'></font>
      END MODULE module_mp_fer_hires<a name='3113'>
</pre></body></html>