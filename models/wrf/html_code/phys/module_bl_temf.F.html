<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!wrf:model_layer:physics<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>!<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<font color=#447700>!<a name='6'></font>
<A NAME='MODULE_BL_TEMF'><A href='../../html_code/phys/module_bl_temf.F.html#MODULE_BL_TEMF' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='7'>
<font color=#993300>module </font><font color=#cc0000>module_bl_temf</font> <A href='../../call_to/MODULE_BL_TEMF.html' TARGET='index'>2</A><a name='8'>
contains<a name='9'>
<font color=#447700>!<a name='10'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='11'></font>
<font color=#447700>!<a name='12'></font>
<A NAME='TEMFPBL'><A href='../../html_code/phys/module_bl_temf.F.html#TEMFPBL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='13'>
   <font color=#993300>subroutine </font><font color=#cc0000>temfpbl</font>(u3d,v3d,th3d,t3d,qv3d,qc3d,qi3d,p3d,p3di,pi3d,rho,      &amp; <A href='../../call_to/TEMFPBL.html' TARGET='index'>1</A>,<A href='../../call_from/TEMFPBL.html' TARGET='index'>1</A><a name='14'>
                  rublten,rvblten,rthblten,                                    &amp;<a name='15'>
                  rqvblten,rqcblten,rqiblten,flag_qi,                          &amp;<a name='16'>
                  g,cp,rcp,r_d,r_v,cpv,                                   &amp;<a name='17'>
                  z,xlv,psfc,                                          &amp;<a name='18'>
                  p_top,                                               &amp;<a name='19'>
                  znt,ht,ust,zol,hol,hpbl,psim,psih,                         &amp;<a name='20'>
                  xland,hfx,qfx,tsk,qsfc,gz1oz0,wspd,br,                    &amp;<a name='21'>
                  dt,dtmin,kpbl2d,                                             &amp;<a name='22'>
                  svp1,svp2,svp3,svpt0,ep1,ep2,karman,eomeg,stbolt,            &amp;<a name='23'>
                  kh_temf,km_temf,                                            &amp;<a name='24'>
                  u10,v10,t2,                                                  &amp;<a name='25'>
                  te_temf,shf_temf,qf_temf,uw_temf,vw_temf,                    &amp;<a name='26'>
                  wupd_temf,mf_temf,thup_temf,qtup_temf,qlup_temf,            &amp;<a name='27'>
                  cf3d_temf,cfm_temf,                                         &amp;<a name='28'>
                  hd_temf,lcl_temf,hct_temf,                            &amp;<a name='29'>
                  flhc,flqc,exch_temf,                                &amp;<a name='30'>
                  fCor,                                                        &amp;<a name='31'>
                  ids,ide, jds,jde, kds,kde,                                   &amp;<a name='32'>
                  ims,ime, jms,jme, kms,kme,                                   &amp;<a name='33'>
                  its,ite, jts,jte, kts,kte                                   &amp;<a name='34'>
                  )<a name='35'>
<font color=#447700>!-------------------------------------------------------------------<a name='36'></font>
      implicit none<a name='37'>
<font color=#447700>!-------------------------------------------------------------------<a name='38'></font>
<font color=#447700>! New variables for TEMF<a name='39'></font>
<font color=#447700>!-- te_temf     Total energy from this scheme<a name='40'></font>
<font color=#447700>!-- shf_temf    Sensible heat flux profile from this scheme (kinematic)<a name='41'></font>
<font color=#447700>!-- qf_temf     Moisture flux profile from this scheme (kinematic)<a name='42'></font>
<font color=#447700>!-- uw_temf     U momentum flux component from this scheme<a name='43'></font>
<font color=#447700>!-- vw_temf     V momentum flux component from this scheme<a name='44'></font>
<font color=#447700>!-- kh_temf     Exchange coefficient for heat (3D)<a name='45'></font>
<font color=#447700>!-- km_temf     Exchange coefficient for momentum (3D)<a name='46'></font>
<font color=#447700>!-- wupd_temf     Updraft velocity from TEMF BL scheme<a name='47'></font>
<font color=#447700>!-- mf_temf       Mass flux from TEMF BL scheme<a name='48'></font>
<font color=#447700>!-- thup_temf   Updraft thetal from TEMF BL scheme<a name='49'></font>
<font color=#447700>!-- qtup_temf   Updraft qt from TEMF BL scheme<a name='50'></font>
<font color=#447700>!-- qlup_temf   Updraft ql from TEMF BL scheme<a name='51'></font>
<font color=#447700>!-- cf3d_temf   3D cloud fraction from TEMF BL scheme<a name='52'></font>
<font color=#447700>!-- cfm_temf    Column cloud fraction from TEMF BL scheme<a name='53'></font>
<font color=#447700>!-- exch_temf   Surface exchange coefficient (as for moisture) from TEMF surface layer scheme<a name='54'></font>
<font color=#447700>!-- flhc        Surface exchange coefficient for heat (needed by surface scheme)<a name='55'></font>
<font color=#447700>!-- flqc        Surface exchange coefficient for moisture (including moisture availablity)<a name='56'></font>
<font color=#447700>!-- fCor        Coriolis parameter (from grid%f)<a name='57'></font>
<font color=#447700>!<a name='58'></font>
<font color=#447700>!-- u3d         3d u-velocity interpolated to theta points (m/s)<a name='59'></font>
<font color=#447700>!-- v3d         3d v-velocity interpolated to theta points (m/s)<a name='60'></font>
<font color=#447700>!-- th3d	       3d potential temperature (k)<a name='61'></font>
<font color=#447700>!-- t3d         temperature (k)<a name='62'></font>
<font color=#447700>!-- qv3d        3d water vapor mixing ratio (kg/kg)<a name='63'></font>
<font color=#447700>!-- qc3d        3d cloud mixing ratio (kg/kg)<a name='64'></font>
<font color=#447700>!-- qi3d        3d ice mixing ratio (kg/kg)<a name='65'></font>
<font color=#447700>!               (note: if P_QI&lt;PARAM_FIRST_SCALAR this should be zero filled)<a name='66'></font>
<font color=#447700>!-- p3d         3d pressure (pa)<a name='67'></font>
<font color=#447700>!-- p3di        3d pressure (pa) at interface level<a name='68'></font>
<font color=#447700>!-- pi3d	3d exner function (dimensionless)<a name='69'></font>
<font color=#447700>!-- rho 	3d dry air density (kg/m^3)<a name='70'></font>
<font color=#447700>!-- rublten     u tendency due to<a name='71'></font>
<font color=#447700>!               pbl parameterization (m/s/s)<a name='72'></font>
<font color=#447700>!-- rvblten     v tendency due to<a name='73'></font>
<font color=#447700>!               pbl parameterization (m/s/s)<a name='74'></font>
<font color=#447700>!-- rthblten    theta tendency due to<a name='75'></font>
<font color=#447700>!               pbl parameterization (K/s)<a name='76'></font>
<font color=#447700>!-- rqvblten    qv tendency due to<a name='77'></font>
<font color=#447700>!               pbl parameterization (kg/kg/s)<a name='78'></font>
<font color=#447700>!-- rqcblten    qc tendency due to<a name='79'></font>
<font color=#447700>!               pbl parameterization (kg/kg/s)<a name='80'></font>
<font color=#447700>!-- rqiblten    qi tendency due to<a name='81'></font>
<font color=#447700>!               pbl parameterization (kg/kg/s)<a name='82'></font>
<font color=#447700>!-- cp          heat capacity at constant pressure for dry air (j/kg/k)<a name='83'></font>
<font color=#447700>!-- g           acceleration due to gravity (m/s^2)<a name='84'></font>
<font color=#447700>!-- rovcp       r/cp<a name='85'></font>
<font color=#447700>!-- r_d          gas constant for dry air (j/kg/k)<a name='86'></font>
<font color=#447700>!-- rovg 	r/g<a name='87'></font>
<font color=#447700>!-- z		height above sea level (m)<a name='88'></font>
<font color=#447700>!-- xlv         latent heat of vaporization (j/kg)<a name='89'></font>
<font color=#447700>!-- r_v 		gas constant for water vapor (j/kg/k)<a name='90'></font>
<font color=#447700>!-- psfc        pressure at the surface (pa)<a name='91'></font>
<font color=#447700>!-- znt		roughness length (m)<a name='92'></font>
<font color=#447700>!-- ht          terrain height ASL (m)<a name='93'></font>
<font color=#447700>!-- ust		u* in similarity theory (m/s)<a name='94'></font>
<font color=#447700>!-- zol		z/l height over monin-obukhov length<a name='95'></font>
<font color=#447700>!-- hol		pbl height over monin-obukhov length<a name='96'></font>
<font color=#447700>!-- hpbl	pbl height (m)<a name='97'></font>
<font color=#447700>!-- psim        similarity stability function for momentum<a name='98'></font>
<font color=#447700>!-- psih        similarity stability function for heat<a name='99'></font>
<font color=#447700>!-- xland	land mask (1 for land, 2 for water)<a name='100'></font>
<font color=#447700>!-- hfx		upward heat flux at the surface (w/m^2)<a name='101'></font>
<font color=#447700>!-- qfx		upward moisture flux at the surface (kg/m^2/s)<a name='102'></font>
<font color=#447700>!-- tsk		surface temperature (k)<a name='103'></font>
<font color=#447700>!-- qsfc	surface specific humidity (kg/kg)<a name='104'></font>
<font color=#447700>!-- gz1oz0      log(z/z0) where z0 is roughness length<a name='105'></font>
<font color=#447700>!-- wspd        wind speed at lowest model level (m/s)<a name='106'></font>
<font color=#447700>!-- u10         u-wind speed at 10 m (m/s)<a name='107'></font>
<font color=#447700>!-- v10         v-wind speed at 10 m (m/s)<a name='108'></font>
<font color=#447700>!-- br          bulk richardson number in surface layer<a name='109'></font>
<font color=#447700>!-- dt		time step (s)<a name='110'></font>
<font color=#447700>!-- dtmin	time step (minute)<a name='111'></font>
<font color=#447700>!-- rvovrd      r_v divided by r_d (dimensionless)<a name='112'></font>
<font color=#447700>!-- svp1        constant for saturation vapor pressure (kpa)<a name='113'></font>
<font color=#447700>!-- svp2        constant for saturation vapor pressure (dimensionless)<a name='114'></font>
<font color=#447700>!-- svp3        constant for saturation vapor pressure (k)<a name='115'></font>
<font color=#447700>!-- svpt0       constant for saturation vapor pressure (k)<a name='116'></font>
<font color=#447700>!-- ep1         constant for virtual temperature (r_v/r_d - 1) (dimensionless)<a name='117'></font>
<font color=#447700>!-- ep2         constant for specific humidity calculation<a name='118'></font>
<font color=#447700>!-- karman      von karman constant<a name='119'></font>
<font color=#447700>!-- eomeg       angular velocity of earths rotation (rad/s)<a name='120'></font>
<font color=#447700>!-- stbolt      stefan-boltzmann constant (w/m^2/k^4)<a name='121'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='122'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='123'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='124'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='125'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='126'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='127'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='128'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='129'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='130'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='131'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='132'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='133'></font>
<font color=#447700>!-- its         start index for i in tile<a name='134'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='135'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='136'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='137'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='138'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='139'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='140'></font>
<font color=#447700>! Arguments<a name='141'></font>
<font color=#447700>!<a name='142'></font>
   integer,  intent(in   )   ::      ids,ide, jds,jde, kds,kde,                &amp;<a name='143'>
                                     ims,ime, jms,jme, kms,kme,                &amp;<a name='144'>
                                     its,ite, jts,jte, kts,kte<a name='145'>
<font color=#447700>!<a name='146'></font>
   real,     intent(in   )   ::      dt,dtmin,g,cp,rcp,r_d,r_v,xlv,cpv<a name='147'>
<font color=#447700>!<a name='148'></font>
   real,     intent(in )     ::      svp1,svp2,svp3,svpt0<a name='149'>
   real,     intent(in )     ::      ep1,ep2,karman,eomeg,stbolt<a name='150'>
<font color=#447700>!<a name='151'></font>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='152'>
             intent(in   )   ::      qv3d, qc3d, qi3d, &amp;<a name='153'>
                                     p3d, pi3d, th3d, t3d, &amp;<a name='154'>
				     z, rho<a name='155'>
<font color=#447700>!<a name='156'></font>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='157'>
             intent(inout)   ::      te_temf<a name='158'>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='159'>
             intent(  out)   ::      shf_temf, qf_temf, uw_temf, vw_temf     , &amp;<a name='160'>
                                     wupd_temf, mf_temf, thup_temf, qtup_temf, &amp;<a name='161'>
                                     qlup_temf,cf3d_temf<a name='162'>
   real,     dimension( ims:ime, jms:jme )                          , &amp;<a name='163'>
             intent(inout)   ::      flhc, flqc, exch_temf<a name='164'>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='165'>
             intent(in   )   ::      fCor<a name='166'>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='167'>
             intent(  out)   ::      hd_temf, lcl_temf, hct_temf, cfm_temf<a name='168'>
<font color=#447700>!<a name='169'></font>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='170'>
             intent(in   )   ::      p3di<a name='171'>
<font color=#447700>!<a name='172'></font>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='173'>
             intent(inout)   ::      rublten, rvblten, &amp;<a name='174'>
                                     rthblten, &amp;<a name='175'>
                                     rqvblten, rqcblten, rqiblten<a name='176'>
<font color=#447700>!<a name='177'></font>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='178'>
             intent(inout)   ::      kh_temf, km_temf<a name='179'>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='180'>
             intent(inout)   ::      u10, v10, t2<a name='181'>
<font color=#447700>!<a name='182'></font>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='183'>
             intent(in   )   ::      xland, &amp;<a name='184'>
                                     psim, psih, gz1oz0, br, &amp;<a name='185'>
                                     psfc, tsk, qsfc<a name='186'>
<font color=#447700>!<a name='187'></font>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='188'>
             intent(inout)   ::      hfx, qfx<a name='189'>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='190'>
             intent(inout)   ::      hol, ust, hpbl, znt, wspd, zol<a name='191'>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='192'>
             intent(in   )   ::      ht<a name='193'>
<font color=#447700>!<a name='194'></font>
  real,      dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='195'>
             intent(in   )   ::      u3d, v3d<a name='196'>
<font color=#447700>!<a name='197'></font>
  integer,   dimension( ims:ime, jms:jme )                                   , &amp;<a name='198'>
             intent(out  )   ::      kpbl2d<a name='199'>
<font color=#447700>!<a name='200'></font>
     logical, intent(in)        ::   flag_qi<a name='201'>
<font color=#447700>!<a name='202'></font>
<font color=#447700>!   real,     dimension( ims:ime, kms:kme, jms:jme ), &amp;<a name='203'></font>
<font color=#447700>!             optional                              , &amp;<a name='204'></font>
<font color=#447700>!             intent(inout)   ::      rqiblten<a name='205'></font>
<font color=#447700>!<a name='206'></font>
   real,     optional, intent(in   )   ::  p_top<a name='207'>
<font color=#447700>!<a name='208'></font>
<font color=#447700>!-------------------------------------------------------<a name='209'></font>
<font color=#447700>! Local variables<a name='210'></font>
   integer :: j<a name='211'>
<a name='212'>
   do j = jts,jte<a name='213'>
      call <A href='../../html_code/phys/module_bl_temf.F.html#TEMF2D'>temf2d</A><A href='../../html_code/phys/module_bl_temf.F.html#TEMFPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TEMF2D_1">(J=j,ux=u3d(ims,kms,j),vx=v3d(ims,kms,j)                      &amp;<a name='214'>
              ,tx=t3d(ims,kms,j),thx=th3d(ims,kms,j)                           &amp;<a name='215'>
              ,qvx=qv3d(ims,kms,j),qcx=qc3d(ims,kms,j)                         &amp;<a name='216'>
              ,qix=qi3d(ims,kms,j)                                             &amp;<a name='217'>
              ,p2d=p3d(ims,kms,j),p2di=p3di(ims,kms,j)                         &amp;<a name='218'>
              ,pi2d=pi3d(ims,kms,j),rho=rho(ims,kms,j)                         &amp;<a name='219'>
              ,rubltenx=rublten(ims,kms,j),rvbltenx=rvblten(ims,kms,j)         &amp;<a name='220'>
              ,rthbltenx=rthblten(ims,kms,j),rqvbltenx=rqvblten(ims,kms,j)     &amp;<a name='221'>
              ,rqcbltenx=rqcblten(ims,kms,j),rqibltenx=rqiblten(ims,kms,j)     &amp;<a name='222'>
              ,g=g,cp=cp,rcp=rcp,r_d=r_d,r_v=r_v,cpv=cpv            &amp;<a name='223'>
              ,z2d=z(ims,kms,j)                         &amp;<a name='224'>
              ,xlv=xlv                                                   &amp;<a name='225'>
              ,psfcpa=psfc(ims,j),znt=znt(ims,j),zsrf=ht(ims,j),ust=ust(ims,j) &amp;<a name='226'>
              ,zol=zol(ims,j),hol=hol(ims,j),hpbl=hpbl(ims,j)                  &amp;<a name='227'>
              ,psim=psim(ims,j)                           &amp;<a name='228'>
              ,psih=psih(ims,j),xland=xland(ims,j)                             &amp;<a name='229'>
              ,hfx=hfx(ims,j),qfx=qfx(ims,j)                                   &amp;<a name='230'>
              ,tsk=tsk(ims,j),qsfc=qsfc(ims,j),gz1oz0=gz1oz0(ims,j)           &amp;<a name='231'>
              ,wspd=wspd(ims,j),br=br(ims,j)                                   &amp;<a name='232'>
              ,dt=dt,dtmin=dtmin,kpbl1d=kpbl2d(ims,j)                          &amp;<a name='233'>
              ,svp1=svp1,svp2=svp2,svp3=svp3,svpt0=svpt0                       &amp;<a name='234'>
              ,ep1=ep1,ep2=ep2,karman=karman,eomeg=eomeg                       &amp;<a name='235'>
              ,stbolt=stbolt                                                   &amp;<a name='236'>
              ,kh_temfx=kh_temf(ims,kms,j),km_temfx=km_temf(ims,kms,j)         &amp;<a name='237'>
              ,u10=u10(ims,j),v10=v10(ims,j),t2=t2(ims,j)                      &amp;<a name='238'>
              ,te_temfx=te_temf(ims,kms,j)                                     &amp;<a name='239'>
              ,shf_temfx=shf_temf(ims,kms,j),qf_temfx=qf_temf(ims,kms,j)       &amp;<a name='240'>
              ,uw_temfx=uw_temf(ims,kms,j),vw_temfx=vw_temf(ims,kms,j)       &amp;<a name='241'>
              ,wupd_temfx=wupd_temf(ims,kms,j),mf_temfx=mf_temf(ims,kms,j)   &amp;<a name='242'>
              ,thup_temfx=thup_temf(ims,kms,j),qtup_temfx=qtup_temf(ims,kms,j) &amp;<a name='243'>
              ,qlup_temfx=qlup_temf(ims,kms,j) &amp;<a name='244'>
              ,cf3d_temfx=cf3d_temf(ims,kms,j),cfm_temfx=cfm_temf(ims,j)       &amp;<a name='245'>
              ,hd_temfx=hd_temf(ims,j),lcl_temfx=lcl_temf(ims,j)       &amp;<a name='246'>
              ,hct_temfx=hct_temf(ims,j),exch_temfx=exch_temf(ims,j)    &amp;<a name='247'>
              ,flhc=flhc(ims,j),flqc=flqc(ims,j)                     &amp;<a name='248'>
              ,fCor=fCor(ims,j)                                              &amp;<a name='249'>
              ,ids=ids,ide=ide, jds=jds,jde=jde, kds=kds,kde=kde               &amp;<a name='250'>
              ,ims=ims,ime=ime, jms=jms,jme=jme, kms=kms,kme=kme               &amp;<a name='251'>
              ,its=its,ite=ite, jts=jts,jte=jte, kts=kts,kte=kte   )<a name='252'>
   enddo<a name='253'>
<font color=#447700>!<a name='254'></font>
   end subroutine temfpbl<a name='255'>
<font color=#447700>!<a name='256'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='257'></font>
<font color=#447700>!<a name='258'></font>
<A NAME='TEMF2D'><A href='../../html_code/phys/module_bl_temf.F.html#TEMF2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='259'>
   <font color=#993300>subroutine </font><font color=#cc0000>temf2d</font>(j,ux,vx,tx,thx,qvx,qcx,qix,p2d,p2di,pi2d,rho,            &amp; <A href='../../call_to/TEMF2D.html' TARGET='index'>1</A>,<A href='../../call_from/TEMF2D.html' TARGET='index'>9</A><a name='260'>
                  rubltenx,rvbltenx,rthbltenx,                                 &amp;<a name='261'>
                  rqvbltenx,rqcbltenx,rqibltenx,                               &amp;<a name='262'>
                  g,cp,rcp,r_d,r_v,cpv,                            &amp;<a name='263'>
                  z2d,                                                  &amp;<a name='264'>
                  xlv,psfcpa,                                    &amp;<a name='265'>
                  znt,zsrf,ust,zol,hol,hpbl,psim,psih,                      &amp;<a name='266'>
                  xland,hfx,qfx,tsk,qsfc,gz1oz0,wspd,br,                   &amp;<a name='267'>
                  dt,dtmin,kpbl1d,                                             &amp;<a name='268'>
                  svp1,svp2,svp3,svpt0,ep1,ep2,karman,eomeg,stbolt,            &amp;<a name='269'>
                  kh_temfx,km_temfx,                                         &amp;<a name='270'>
                  u10,v10,t2,                                                 &amp;<a name='271'>
                  te_temfx,shf_temfx,qf_temfx,uw_temfx,vw_temfx,               &amp;<a name='272'>
                  wupd_temfx,mf_temfx,thup_temfx,qtup_temfx,qlup_temfx,       &amp;<a name='273'>
                  cf3d_temfx,cfm_temfx,                                        &amp;<a name='274'>
                  hd_temfx,lcl_temfx,hct_temfx,exch_temfx,           &amp;<a name='275'>
                  flhc,flqc,                                                 &amp;<a name='276'>
                  fCor,                                                        &amp;<a name='277'>
                  ids,ide, jds,jde, kds,kde,                                   &amp;<a name='278'>
                  ims,ime, jms,jme, kms,kme,                                   &amp;<a name='279'>
                  its,ite, jts,jte, kts,kte                                   &amp;<a name='280'>
                  )<a name='281'>
<font color=#447700>!-------------------------------------------------------------------<a name='282'></font>
   implicit none<a name='283'>
<font color=#447700>!-------------------------------------------------------------------<a name='284'></font>
<font color=#447700>!<a name='285'></font>
<font color=#447700>! This is the Total Energy - Mass Flux (TEMF) PBL scheme.<a name='286'></font>
<font color=#447700>! Initial implementation 2010 by Wayne Angevine, CIRES/NOAA ESRL.<a name='287'></font>
<font color=#447700>! References:<a name='288'></font>
<font color=#447700>!    Angevine et al., 2010, MWR<a name='289'></font>
<font color=#447700>!    Angevine, 2005, JAM<a name='290'></font>
<font color=#447700>!    Mauritsen et al., 2007, JAS<a name='291'></font>
<font color=#447700>!<a name='292'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='293'></font>
<font color=#447700>!<a name='294'></font>
   integer,  intent(in   )   ::      ids,ide, jds,jde, kds,kde,                &amp;<a name='295'>
                                     ims,ime, jms,jme, kms,kme,                &amp;<a name='296'>
                                     its,ite, jts,jte, kts,kte, j<a name='297'>
<font color=#447700>!<a name='298'></font>
   real,     intent(in   )   ::      dt,dtmin,g,cp,rcp,r_d,r_v,cpv,xlv<a name='299'>
<font color=#447700>!<a name='300'></font>
   real,     intent(in )     ::      svp1,svp2,svp3,svpt0<a name='301'>
   real,     intent(in )     ::      ep1,ep2,karman,eomeg,stbolt<a name='302'>
<font color=#447700>!<a name='303'></font>
   real,     dimension( ims:ime, kms:kme ),                                    &amp;<a name='304'>
             intent(in)      ::      z2d<a name='305'>
<font color=#447700>!<a name='306'></font>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='307'>
             intent(in   )   ::      ux, vx<a name='308'>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='309'>
             intent(inout)   ::      te_temfx<a name='310'>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='311'>
             intent(  out)   ::      shf_temfx, qf_temfx, uw_temfx, vw_temfx , &amp;<a name='312'>
                                     wupd_temfx, mf_temfx,thup_temfx,          &amp;<a name='313'>
                                     qtup_temfx, qlup_temfx, cf3d_temfx<a name='314'>
   real,     dimension( ims:ime )                                   , &amp;<a name='315'>
             intent(  out)   ::      hd_temfx, lcl_temfx, hct_temfx, cfm_temfx<a name='316'>
   real,     dimension( ims:ime )                                   , &amp;<a name='317'>
             intent(in   )   ::      fCor<a name='318'>
   real,     dimension( ims:ime )                                   , &amp;<a name='319'>
             intent(inout)   ::      flhc, flqc, exch_temfx<a name='320'>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='321'>
             intent(in   )   ::      tx, thx, qvx, qcx, qix, pi2d, rho<a name='322'>
   real,     dimension( ims:ime, kms:kme )                                 , &amp;<a name='323'>
             intent(in   )   ::      p2di, p2d<a name='324'>
<font color=#447700>!<a name='325'></font>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='326'>
             intent(inout)   ::      rubltenx, rvbltenx, rthbltenx,            &amp;<a name='327'>
                                     rqvbltenx, rqcbltenx, rqibltenx<a name='328'>
<font color=#447700>!<a name='329'></font>
   real,     dimension( ims:ime )                                            , &amp;<a name='330'>
             intent(inout)   ::      hol, ust, hpbl, znt<a name='331'>
   real,     dimension( ims:ime )                                            , &amp;<a name='332'>
             intent(in   )   ::      xland, zsrf<a name='333'>
   real,     dimension( ims:ime )                                            , &amp;<a name='334'>
             intent(inout)   ::      hfx, qfx<a name='335'>
<font color=#447700>!<a name='336'></font>
   real,     dimension( ims:ime ), intent(inout)   ::  wspd<a name='337'>
   real,     dimension( ims:ime ), intent(in  )    ::  br<a name='338'>
<font color=#447700>!<a name='339'></font>
   real,     dimension( ims:ime ), intent(in   )   ::  psim, psih<a name='340'>
   real,     dimension( ims:ime ), intent(in   )   ::  gz1oz0<a name='341'>
<font color=#447700>!<a name='342'></font>
   real,     dimension( ims:ime ), intent(in   )   ::  psfcpa<a name='343'>
   real,     dimension( ims:ime ), intent(in   )   ::  tsk, qsfc<a name='344'>
   real,     dimension( ims:ime ), intent(inout)   ::  zol<a name='345'>
   integer,  dimension( ims:ime ), intent(out  )   ::  kpbl1d<a name='346'>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='347'>
             intent(inout)   ::        kh_temfx, km_temfx<a name='348'>
<font color=#447700>!<a name='349'></font>
   real,     dimension( ims:ime )                                            , &amp;<a name='350'>
             intent(inout)    ::        u10, v10, t2<a name='351'>
<font color=#447700>!<a name='352'></font>
<font color=#447700>!<a name='353'></font>
<font color=#447700>!-----------------------------------------------------------<a name='354'></font>
<font color=#447700>! Local variables<a name='355'></font>
<font color=#447700>!<a name='356'></font>
<font color=#447700>! TE model constants<a name='357'></font>
   logical, parameter :: MFopt = .true.  <font color=#447700>! Use mass flux or not<a name='358'></font>
   real, parameter :: visc_temf = 1.57e-4   <font color=#447700>! WA TEST bigger minimum K<a name='359'></font>
   real, parameter :: conduc_temf = 1.57e-4 / 0.733<a name='360'>
   real, parameter :: Pr_temf = 0.733<a name='361'>
   real, parameter :: TEmin = 1e-3<a name='362'>
   real, parameter :: ftau0 = 0.17<a name='363'>
   real, parameter :: fth0 = 0.145<a name='364'>
   real, parameter :: critRi = 0.25<a name='365'>
   real, parameter :: Cf = 0.185<a name='366'>
   real, parameter :: CN = 2.0<a name='367'>
   real, parameter :: Ceps = 0.070<a name='368'>
   real, parameter :: Cgamma = Ceps<a name='369'>
   real, parameter :: Cphi = Ceps<a name='370'>
   real, parameter :: PrT0 = Cphi/Ceps * ftau0**2 / 2. / fth0**2<a name='371'>
<font color=#447700>! EDMF constants<a name='372'></font>
   real, parameter :: CM = 0.03      <font color=#447700>! Proportionality constant for subcloud MF<a name='373'></font>
   real, parameter :: Cdelt = 0.006  <font color=#447700>! Prefactor for detrainment rate<a name='374'></font>
   real, parameter :: Cw = 0.5       <font color=#447700>! Prefactor for surface wUPD<a name='375'></font>
   real, parameter :: Cc = 3.0       <font color=#447700>! Prefactor for convective length scale<a name='376'></font>
   real, parameter :: lasymp = 200.0 <font color=#447700>! Asymptotic length scale WA 11/20/09<a name='377'></font>
   real, parameter :: hmax = 4000.0  <font color=#447700>! Max hd,hct WA 11/20/09<a name='378'></font>
<font color=#447700>!<a name='379'></font>
   integer :: i, k, kt   <font color=#447700>! Loop variable<a name='380'></font>
   integer, dimension( its:ite) ::  h0idx<a name='381'>
   real, dimension( its:ite)    ::  h0<a name='382'>
   real, dimension( its:ite)    ::  wstr, ang, wm<a name='383'>
   real, dimension( its:ite)    ::  hd,lcl,hct,ht<a name='384'>
   real, dimension( its:ite)    ::  convection_TKE_surface_src, sfcFTE<a name='385'>
   real, dimension( its:ite)    ::  sfcTHVF<a name='386'>
   real, dimension( its:ite)    ::  z0t<a name='387'>
   integer, dimension( its:ite) ::  hdidx,lclidx,hctidx,htidx<a name='388'>
   integer, dimension( its:ite) ::  hmax_idx<a name='389'>
   integer, dimension( its:ite) ::  tval<a name='390'>
   real, dimension( its:ite, kts:kte) :: thetal, qt<a name='391'>
   real, dimension( its:ite, kts:kte) :: u_temf, v_temf<a name='392'>
   real, dimension( its:ite, kts:kte) :: rv, rl, rt<a name='393'>
   real, dimension( its:ite, kts:kte) :: chi_poisson, gam<a name='394'>
   real, dimension( its:ite, kts:kte) :: dthdz, dqtdz, dudz, dvdz<a name='395'>
   real, dimension( its:ite, kts:kte) :: lepsmin<a name='396'>
   real, dimension( its:ite, kts:kte) :: thetav<a name='397'>
   real, dimension( its:ite, kts:kte) :: MFCth, MFCq, MFCu, MFCv<a name='398'>
   real, dimension( its:ite, kts:kte) :: MFCql, MFCthv, MFCTE<a name='399'>
   real, dimension( its:ite, kts:kte) :: epsmf, deltmf, dMdz<a name='400'>
   real, dimension( its:ite, kts:kte) :: UUPD, VUPD<a name='401'>
   real, dimension( its:ite, kts:kte) :: thetavUPD, qlUPD, TEUPD<a name='402'>
   real, dimension( its:ite, kts:kte) :: thetavUPDmoist, wupd_dry<a name='403'>
   real, dimension( its:ite, kts:kte) :: B, Bmoist<a name='404'>
   real, dimension( its:ite, kts:kte) :: zm, zt, dzm, dzt<a name='405'>
   real, dimension( its:ite, kts:kte) :: dthUPDdz, dqtup_temfxdz, dwUPDdz<a name='406'>
   real, dimension( its:ite, kts:kte) :: dwUPDmoistdz<a name='407'>
   real, dimension( its:ite, kts:kte) :: dUUPDdz, dVUPDdz, dTEUPDdz<a name='408'>
   real, dimension( its:ite, kts:kte) :: TUPD, rstUPD, rUPD, rlUPD, qstUPD<a name='409'>
   real, dimension( its:ite, kts:kte) :: N2, S, Ri, beta, ftau, fth, ratio<a name='410'>
   real, dimension( its:ite, kts:kte) :: TKE, TE2<a name='411'>
   real, dimension( its:ite, kts:kte) :: ustrtilde, linv, leps<a name='412'>
   real, dimension( its:ite, kts:kte) :: km, kh<a name='413'>
   real, dimension( its:ite, kts:kte) :: Fz, QFK, uwk, vwk<a name='414'>
   real, dimension( its:ite, kts:kte) :: km_conv, kh_conv, lconv<a name='415'>
   real, dimension( its:ite, kts:kte) :: alpha2, beta2   <font color=#447700>! For thetav flux calculation<a name='416'></font>
   real, dimension( its:ite, kts:kte) :: THVF, buoy_src, srcs<a name='417'>
   real, dimension( its:ite, kts:kte) :: u_new, v_new<a name='418'>
   real, dimension( its:ite, kts:kte) :: thx_new, qvx_new, qcx_new<a name='419'>
   real, dimension( its:ite, kts:kte) :: thup_new, qvup_new<a name='420'>
   real, dimension( its:ite, kts:kte) :: beta1 <font color=#447700>! For saturation humidity calculations<a name='421'></font>
   real Cepsmf    <font color=#447700>! Prefactor for entrainment rate<a name='422'></font>
   real red_fact  <font color=#447700>! for reducing MF components<a name='423'></font>
   logical is_convective<a name='424'>
   <font color=#447700>! Vars for cloud fraction calculation<a name='425'></font>
   real, dimension( its:ite, kts:kte) :: au, sigq, qst, satdef<a name='426'>
   real sigq2, rst<a name='427'>
<a name='428'>
<font color=#447700>!----------------------------------------------------------------------<a name='429'></font>
<font color=#447700>! Grid staggering:  Matlab version has mass and turbulence levels.<a name='430'></font>
<font color=#447700>! WRF has full levels (with w) and half levels (u,v,theta,q*).  Both<a name='431'></font>
<font color=#447700>! sets of levels use the same indices (kts:kte).  See pbl_driver or<a name='432'></font>
<font color=#447700>! WRF Physics doc for (a few) details.  <a name='433'></font>
<font color=#447700>! So *mass levels correspond to half levels.*<a name='434'></font>
<font color=#447700>! WRF full levels are ignored, we define our own turbulence levels<a name='435'></font>
<font color=#447700>! in order to put the first one below the first half level.<a name='436'></font>
<font color=#447700>! Another difference is that<a name='437'></font>
<font color=#447700>! the Matlab version (and the Mauritsen et al. paper) consider the<a name='438'></font>
<font color=#447700>! first mass level to be at z0 (effectively the surface).  WRF considers<a name='439'></font>
<font color=#447700>! the first half level to be above the effective surface.  The first half<a name='440'></font>
<font color=#447700>! level, at k=1, has nonzero values of u,v for example.  Here we convert<a name='441'></font>
<font color=#447700>! all incoming variables to internal ones with the correct indexing<a name='442'></font>
<font color=#447700>! in order to make the code consistent with the Matlab version.  We<a name='443'></font>
<font color=#447700>! already had to do this for thetal and qt anyway, so the only additional<a name='444'></font>
<font color=#447700>! overhead is for u and v.<a name='445'></font>
<font color=#447700>! I use suffixes m for mass and t for turbulence as in Matlab for things<a name='446'></font>
<font color=#447700>! like indices.<a name='447'></font>
<font color=#447700>! Note that zsrf is the terrain height ASL, from Registry variable ht.<a name='448'></font>
<font color=#447700>! Translations (Matlab to WRF):<a name='449'></font>
<font color=#447700>!     dzt -&gt; calculated below<a name='450'></font>
<font color=#447700>!     dzm -&gt; not supplied, calculated below<a name='451'></font>
<font color=#447700>!     k -&gt; karman<a name='452'></font>
<font color=#447700>!     z0 -&gt; znt<a name='453'></font>
<font color=#447700>!     z0t -&gt; not in WRF, calculated below<a name='454'></font>
<font color=#447700>!     zt -&gt; calculated below<a name='455'></font>
<font color=#447700>!     zm -&gt; (z2d - zsrf) but NOTE zm(1) is now z0 (znt) and zm(2) is<a name='456'></font>
<font color=#447700>!                                 z2d(1) - zsrf<a name='457'></font>
<font color=#447700>!<a name='458'></font>
<font color=#447700>! WA I take the temperature at z0 to be<a name='459'></font>
<font color=#447700>! TSK.  This isn't exactly robust.<a name='460'></font>
<font color=#447700>! WA 2/16/11 removed calculation of flhc, flqc which are not needed here.<a name='461'></font>
<font color=#447700>! These should be removed from the calling sequence someday.<a name='462'></font>
<font color=#447700>!<a name='463'></font>
<font color=#447700>! Other notes:<a name='464'></font>
<font color=#447700>! - I have often used 1 instead of kts below, because the scheme demands<a name='465'></font>
<font color=#447700>!   to know where the surface is.  It won't work if kts .NE. 1.<a name='466'></font>
<a name='467'>
<a name='468'>
   do i = its,ite      <font color=#447700>! Main loop <a name='469'></font>
<a name='470'>
      <font color=#447700>! Get incoming surface theta from TSK (WA for now)<a name='471'></font>
      thetal(i,1) = tsk(i) / pi2d(i,1)  <font color=#447700>! WA really should use Exner func. at z0<a name='472'></font>
      qt(i,1) = qvx(i,1)<a name='473'>
      rv(i,1) = qt(i,1) / (1.-qt(i,1))   <font color=#447700>! Water vapor<a name='474'></font>
      rl(i,1) = 0.<a name='475'>
      rt(i,1) = rv(i,1) + rl(i,1)        <font color=#447700>! Total water (without ice)<a name='476'></font>
      chi_poisson(i,1) = rcp * (1.+rv(i,1)/ep2) / (1.+rv(i,1)*cpv/cp)<a name='477'>
      gam(i,1) = rv(i,1) * r_v / (cp + rv(i,1)*cpv)<a name='478'>
      thetav(i,1) = thetal(i,1) * (1. + 0.608*qt(i,1) - qcx(i,1))  <font color=#447700>! WA 4/6/10 allow environment liquid<a name='479'></font>
      z0t(i) = znt(i)<a name='480'>
<a name='481'>
      <font color=#447700>! Convert incoming theta to thetal and qv,qc to qt<a name='482'></font>
      <font color=#447700>! NOTE this is where the indexing gets changed from WRF to TEMF basis<a name='483'></font>
      do k = kts+1,kte<a name='484'>
         <font color=#447700>! Convert specific humidities to mixing ratios<a name='485'></font>
         rv(i,k) = qvx(i,k-1) / (1.-qvx(i,k-1))   <font color=#447700>! Water vapor<a name='486'></font>
         rl(i,k) = qcx(i,k-1) / (1.-qcx(i,k-1))   <font color=#447700>! Liquid water <a name='487'></font>
         rt(i,k) = rv(i,k) + rl(i,k)        <font color=#447700>! Total water (without ice)<a name='488'></font>
         chi_poisson(i,k) = rcp * (1.+rv(i,k)/ep2) / (1.+rv(i,k)*cpv/cp)<a name='489'>
         gam(i,k) = rt(i,k) * r_v / (cp + rt(i,k)*cpv)<a name='490'>
         thetal(i,k) = thx(i,k-1) * &amp;<a name='491'>
            ((ep2+rv(i,k))/(ep2+rt(i,k)))**chi_poisson(i,k) * &amp;<a name='492'>
            (rv(i,k)/rt(i,k))**(-gam(i,k)) * exp( -xlv*rl(i,k) / &amp;<a name='493'>
            ((cp + rt(i,k)*cpv) * tx(i,k)))<a name='494'>
         qt(i,k) = qvx(i,k-1) + qcx(i,k-1)<a name='495'>
         thetav(i,k) = thetal(i,k) * (1. + 0.608*qt(i,k) - qcx(i,k-1))  <font color=#447700>! WA 4/6/10 allow environment liquid<a name='496'></font>
      end do<a name='497'>
<a name='498'>
      <font color=#447700>! Convert incoming u,v to internal u_temf, v_temf<a name='499'></font>
      <font color=#447700>! NOTE this is where the indexing gets changed from WRF to TEMF basis<a name='500'></font>
      u_temf(i,1) = 0.   <font color=#447700>! zero winds at z0<a name='501'></font>
      v_temf(i,1) = 0.<a name='502'>
      do k = kts+1,kte<a name='503'>
         u_temf(i,k) = ux(i,k-1)<a name='504'>
         v_temf(i,k) = vx(i,k-1)<a name='505'>
      end do<a name='506'>
<a name='507'>
      <font color=#447700>! Get delta height at half (mass) levels<a name='508'></font>
      zm(i,1) = znt(i)<a name='509'>
      dzt(i,1) = z2d(i,1) - zsrf(i) - zm(i,1)<a name='510'>
      <font color=#447700>! Get height and delta at turbulence levels<a name='511'></font>
      zt(i,1) = (z2d(i,1) - zsrf(i) - znt(i)) / 2.<a name='512'>
      do kt = kts+1,kte<a name='513'>
         zm(i,kt) = z2d(i,kt-1) - zsrf(i) <font color=#447700>! Convert indexing from WRF to TEMF<a name='514'></font>
         zt(i,kt) = (zm(i,kt) + z2d(i,kt) - zsrf(i)) / 2.<a name='515'>
         dzm(i,kt) = zt(i,kt) - zt(i,kt-1)<a name='516'>
         dzt(i,kt) = z2d(i,kt+1) - z2d(i,kt)<a name='517'>
      end do<a name='518'>
      dzm(i,1) = dzm(i,2)  <font color=#447700>! WA why?<a name='519'></font>
      dzt(i,kte) = dzt(i,kte-1)    <font color=#447700>! WA 12/23/09<a name='520'></font>
<a name='521'>
      <font color=#447700>! Gradients at first level<a name='522'></font>
      dthdz(i,1) = (thetal(i,2)-thetal(i,1)) / (zt(i,1) * log10(zm(i,2)/z0t(i)))<a name='523'>
      dqtdz(i,1) = (qt(i,2)-qt(i,1)) / (zt(i,1) * log10(zm(i,2)/z0t(i)))<a name='524'>
      dudz(i,1) = (u_temf(i,2)-u_temf(i,1)) / (zt(i,1) * log10(zm(i,2)/znt(i)))<a name='525'>
      dvdz(i,1) = (v_temf(i,2)-v_temf(i,1)) / (zt(i,1) * log10(zm(i,2)/znt(i)))<a name='526'>
<a name='527'>
      <font color=#447700>! Surface thetaV flux from Stull p.147<a name='528'></font>
      sfcTHVF(i) = hfx(i)/(rho(i,1)*cp) * (1.+0.608*(qvx(i,1)+qcx(i,1))) + 0.608*thetav(i,1)*qf_temfx(i,1)<a name='529'>
<a name='530'>
      <font color=#447700>! WA use hd_temf to calculate w* instead of finding h0 here????<a name='531'></font>
      <font color=#447700>! Watch initialization!<a name='532'></font>
      h0idx(i) = 1<a name='533'>
      h0(i) = zm(i,1)<a name='534'>
<a name='535'>
      lepsmin(i,kts) = 0.<a name='536'>
<a name='537'>
      <font color=#447700>! WA 2/11/13 find index just above hmax for use below<a name='538'></font>
      hmax_idx(i) = kte-1<a name='539'>
<a name='540'>
      do k = kts+1,kte-1<a name='541'>
         lepsmin(i,k) = 0.<a name='542'>
<a name='543'>
         <font color=#447700>! Mean gradients<a name='544'></font>
         dthdz(i,k) = (thetal(i,k+1) - thetal(i,k)) / dzt(i,k)<a name='545'>
         dqtdz(i,k) = (qt(i,k+1) - qt(i,k)) / dzt(i,k)<a name='546'>
         dudz(i,k) = (u_temf(i,k+1) - u_temf(i,k)) / dzt(i,k)<a name='547'>
         dvdz(i,k) = (v_temf(i,k+1) - v_temf(i,k)) / dzt(i,k)<a name='548'>
<a name='549'>
         <font color=#447700>! Find h0 (should eventually be interpolated for smoothness)<a name='550'></font>
         if (thetav(i,k) &gt; thetav(i,1) .AND. h0idx(i) .EQ. 1) then<a name='551'>
         <font color=#447700>! WA 9/28/11 limit h0 as for hd and hct<a name='552'></font>
            if (zm(i,k) &lt; hmax) then<a name='553'>
               h0idx(i) = k<a name='554'>
               h0(i) = zm(i,k)<a name='555'>
            else<a name='556'>
               h0idx(i) = k<a name='557'>
               h0(i) = hmax<a name='558'>
            end if<a name='559'>
         end if<a name='560'>
         <font color=#447700>! WA 2/11/13 find index just above hmax for use below<a name='561'></font>
         if (zm(i,k) &gt; hmax) then<a name='562'>
            hmax_idx(i) = min(hmax_idx(i),k)<a name='563'>
         end if<a name='564'>
      end do<a name='565'>
<a name='566'>
      <font color=#447700>! Gradients at top level   <a name='567'></font>
<a name='568'>
      dthdz(i,kte) = dthdz(i,kte-1)<a name='569'>
      dqtdz(i,kte) = dqtdz(i,kte-1)<a name='570'>
      dudz(i,kte) = dudz(i,kte-1)<a name='571'>
      dvdz(i,kte) = dvdz(i,kte-1)<a name='572'>
<a name='573'>
      if ( hfx(i) &gt; 0.) then<a name='574'>
         <font color=#447700>! wstr(i) = (g * h0(i) / thetav(i,2) * shf_temfx(i,1) ) ** (1./3.)<a name='575'></font>
         wstr(i) = (g * h0(i) / thetav(i,2) * hfx(i)/(rho(i,1)*cp) ) ** (1./3.)<a name='576'>
      else<a name='577'>
         wstr(i) = 0.<a name='578'>
      end if<a name='579'>
      <a name='580'>
<a name='581'>
      <font color=#447700>! Set flag convective or not for use below<a name='582'></font>
      is_convective = wstr(i) &gt; 0. .AND. MFopt .AND. dthdz(i,1)&lt;0. .AND. dthdz(i,2)&lt;0.  <font color=#447700>! WA 12/16/09 require two levels of negative (unstable) gradient<a name='583'></font>
<a name='584'>
      <font color=#447700>! Find stability parameters and length scale (on turbulence levels)<a name='585'></font>
      do kt = 1,kte-1<a name='586'>
         N2(i,kt) = 2. * g / (thetav(i,kt) + thetav(i,kt+1))*dthdz(i,kt)<a name='587'>
         S(i,kt) = sqrt(dudz(i,kt)**2. + dvdz(i,kt)**2.)<a name='588'>
         Ri(i,kt) = N2(i,kt) / S(i,kt)**2.<a name='589'>
         if (S(i,kt) &lt; 1e-15) then<a name='590'>
            if (N2(i,kt) &gt;= 0) then<a name='591'>
               Ri(i,kt) = 10.<a name='592'>
            else<a name='593'>
               Ri(i,kt) = -1.<a name='594'>
            end if<a name='595'>
         end if<a name='596'>
         beta(i,kt) = 2. * g / (thetav(i,kt)+thetav(i,kt+1))<a name='597'>
         if (Ri(i,kt) &gt; 0) then<a name='598'>
            ratio(i,kt) = Ri(i,kt)/(Cphi**2.*ftau0**2./(2.*Ceps**2.*fth0**2.)+3.*Ri(i,kt))<a name='599'>
            ftau(i,kt) = ftau0 * ((3./4.) / (1.+4.*Ri(i,kt)) + 1./4.)<a name='600'>
            fth(i,kt) = fth0 / (1.+4.*Ri(i,kt))<a name='601'>
            TE2(i,kt) = 2. * te_temfx(i,kt) * ratio(i,kt) * N2(i,kt) / beta(i,kt)**2.<a name='602'>
         else<a name='603'>
            ratio(i,kt) = Ri(i,kt)/(Cphi**2.*ftau0**2./(-2.*Ceps**2.*fth0**2.)+2.*Ri(i,kt))<a name='604'>
            ftau(i,kt) = ftau0<a name='605'>
            fth(i,kt) = fth0<a name='606'>
            TE2(i,kt) = 0.<a name='607'>
         end if<a name='608'>
         TKE(i,kt) = te_temfx(i,kt) * (1. - ratio(i,kt))<a name='609'>
         ustrtilde(i,kt) = sqrt(ftau(i,kt) * TKE(i,kt))<a name='610'>
         if (N2(i,kt) &gt; 0.) then<a name='611'>
            linv(i,kt) = 1./karman / zt(i,kt) + abs(fCor(i)) / &amp;<a name='612'>
               (Cf*ustrtilde(i,kt)) + &amp;<a name='613'>
               sqrt(N2(i,kt))/(CN*ustrtilde(i,kt)) + 1./lasymp<a name='614'>
         else<a name='615'>
            linv(i,kt) = 1./karman / zt(i,kt) + abs(fCor(i)) / &amp;<a name='616'>
               (Cf*ustrtilde(i,kt)) + 1./lasymp<a name='617'>
         end if<a name='618'>
         leps(i,kt) = 1./linv(i,kt)<a name='619'>
         leps(i,kt) = max(leps(i,kt),lepsmin(i,kt))<a name='620'>
      end do <a name='621'>
      S(i,kte) = 0.0<a name='622'>
      N2(i,kte) = 0.0<a name='623'>
      TKE(i,kte) = 0.0<a name='624'>
      linv(i,kte) = linv(i,kte-1)<a name='625'>
      leps(i,kte) = leps(i,kte-1)<a name='626'>
<a name='627'>
<a name='628'>
      <font color=#447700>! Find diffusion coefficients<a name='629'></font>
      <font color=#447700>! First use basic formulae for stable and neutral cases,<a name='630'></font>
      <font color=#447700>! then for convective conditions, and finally choose the larger<a name='631'></font>
      <font color=#447700>! WA 12/23/09 use convective form up to hd/2 always<a name='632'></font>
      <font color=#447700>! WA 12/28/09 after restructuring, this block is above MF block,<a name='633'></font>
      <font color=#447700>! so hd is not yet available for this timestep, must use h0,<a name='634'></font>
      <font color=#447700>! or use hd from previous timestep but be careful about initialization.<a name='635'></font>
      do kt = 1,kte-1    <font color=#447700>! WA 12/22/09<a name='636'></font>
         <font color=#447700>! WA 4/8/10 remove beta term to avoid negative and huge values<a name='637'></font>
         <font color=#447700>! of km due to very small denominator.  This is an interim fix<a name='638'></font>
         <font color=#447700>! until we find something better (more theoretically sound).<a name='639'></font>
         <font color=#447700>! km(i,kt) = TKE(i,kt)**1.5 * ftau(i,kt)**2. / (-beta(i,kt) * fth(i,kt) * sqrt(TE2(i,kt)) + Ceps * sqrt(TKE(i,kt)*te_temfx(i,kt)) / leps(i,kt))<a name='640'></font>
         km(i,kt) = TKE(i,kt)**1.5 * ftau(i,kt)**2. / (Ceps * sqrt(TKE(i,kt)*te_temfx(i,kt)) / leps(i,kt))<a name='641'>
         kh(i,kt) = 2. * leps(i,kt) * fth(i,kt)**2. * TKE(i,kt) / sqrt(te_temfx(i,kt)) / Cphi<a name='642'>
         if ( is_convective) then<a name='643'>
            <font color=#447700>! WA 2/20/14 trap rare "equality" of h0 and zt (only when h0 = hmax)<a name='644'></font>
            if (kt &lt;= h0idx(i) .AND. h0(i)-zt(i,kt) &gt; 1e-15) then<a name='645'>
               lconv(i,kt) = 1. / (1. / (karman*zt(i,kt)) + Cc / (karman * (h0(i) - zt(i,kt))))<a name='646'>
            else<a name='647'>
               lconv(i,kt) = 0.<a name='648'>
            end if<a name='649'>
            <font color=#447700>! WA 12/15/09 use appropriate coeffs to match kh_conv and kh at neutral<a name='650'></font>
            kh_conv(i,kt) = ftau0**2. / Ceps / PrT0 * sqrt(TKE(i,kt)) * lconv(i,kt)<a name='651'>
            if (kh_conv(i,kt) &lt; 0.) then<a name='652'>
               kh_conv(i,kt) = 0.<a name='653'>
            end if<a name='654'>
            km_conv(i,kt) = PrT0 * kh_conv(i,kt)<a name='655'>
            if (zt(i,kt) &lt;= h0(i)/2.) then<a name='656'>
               km(i,kt) = km_conv(i,kt)<a name='657'>
               kh(i,kt) = kh_conv(i,kt)<a name='658'>
            end if<a name='659'>
            if (zt(i,kt) &gt; h0(i)/2. .AND. kt &lt;= h0idx(i)) then<a name='660'>
               km(i,kt) = max(km(i,kt),km_conv(i,kt),visc_temf)<a name='661'>
               kh(i,kt) = max(kh(i,kt),kh_conv(i,kt),conduc_temf)<a name='662'>
            end if<a name='663'>
         end if  <font color=#447700>! is_convective<a name='664'></font>
         km(i,kt) = max(km(i,kt),visc_temf)<a name='665'>
         kh(i,kt) = max(kh(i,kt),conduc_temf)<a name='666'>
         Fz(i,kt) = -kh(i,kt) * dthdz(i,kt)  <font color=#447700>! Diffusive heat flux<a name='667'></font>
      end do<a name='668'>
      km(i,kte) = km(i,kte-1)<a name='669'>
      kh(i,kte) = kh(i,kte-1)<a name='670'>
      Fz(i,kte) = 0.0<a name='671'>
<a name='672'>
<a name='673'>
      <font color=#447700>!*** Mass flux block starts here ***<a name='674'></font>
<a name='675'>
      if ( is_convective) then<a name='676'>
<a name='677'>
         Cepsmf = 2. / max(200.,h0(i))<a name='678'>
         Cepsmf = max(Cepsmf,0.002)<a name='679'>
         do k = kts,kte<a name='680'>
            <font color=#447700>! Calculate lateral entrainment fraction for subcloud layer<a name='681'></font>
            <font color=#447700>! epsilon and delta are defined on mass grid (half levels)<a name='682'></font>
            epsmf(i,k) = Cepsmf<a name='683'>
         end do<a name='684'>
<a name='685'>
         <font color=#447700>! Initialize updraft<a name='686'></font>
         thup_temfx(i,1) = thetal(i,1)    <font color=#447700>! No excess<a name='687'></font>
         qtup_temfx(i,1) = qt(i,1)            <font color=#447700>! No excess<a name='688'></font>
         rUPD(i,1) = qtup_temfx(i,1) / (1. - qtup_temfx(i,1))<a name='689'>
         wupd_temfx(i,1) = Cw * wstr(i)<a name='690'>
         wupd_dry(i,1) = Cw * wstr(i)<a name='691'>
         UUPD(i,1) = u_temf(i,1)<a name='692'>
         VUPD(i,1) = v_temf(i,1)<a name='693'>
         thetavUPD(i,1) = thup_temfx(i,1) * (1. + 0.608*qtup_temfx(i,1))  <font color=#447700>! WA Assumes no liquid<a name='694'></font>
         thetavUPDmoist(i,1) = thup_temfx(i,1) * (1. + 0.608*qtup_temfx(i,1))  <font color=#447700>! WA Assumes no liquid<a name='695'></font>
         TEUPD(i,1) = te_temfx(i,1) + g / thetav(i,1) * sfcTHVF(i)<a name='696'>
         qlUPD(i,1) = qcx(i,1)  <font color=#447700>! WA allow environment liquid<a name='697'></font>
         TUPD(i,1) = thup_temfx(i,1) * pi2d(i,1)   <a name='698'>
         rstUPD(i,1) = <A href='../../html_code/phys/module_bl_temf.F.html#RSAT'>rsat</A><A href='../../html_code/phys/module_bl_temf.F.html#TEMF2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSAT_1">(p2d(i,1),TUPD(i,1),ep2)  <a name='699'>
         rlUPD(i,1) = 0.<a name='700'>
<a name='701'>
         <font color=#447700>! Calculate updraft parameters counting up<a name='702'></font>
         do k = 2,kte<a name='703'>
            <font color=#447700>! WA 2/11/13 use hmax index to prevent oddness high up<a name='704'></font>
            if ( k &lt; hmax_idx(i)) then<a name='705'>
               dthUPDdz(i,k-1) = -epsmf(i,k) * (thup_temfx(i,k-1) - thetal(i,k-1))<a name='706'>
               thup_temfx(i,k) = thup_temfx(i,k-1) + dthUPDdz(i,k-1) * dzm(i,k-1)<a name='707'>
               dqtup_temfxdz(i,k-1) = -epsmf(i,k) * (qtup_temfx(i,k-1) - qt(i,k-1))<a name='708'>
               qtup_temfx(i,k) = qtup_temfx(i,k-1) + dqtup_temfxdz(i,k-1) * dzm(i,k-1)<a name='709'>
               thetavUPD(i,k) = thup_temfx(i,k) * (1. + 0.608*qtup_temfx(i,k))  <font color=#447700>! WA Assumes no liquid<a name='710'></font>
               B(i,k-1) = g * (thetavUPD(i,k) - thetav(i,k)) / thetav(i,k)<a name='711'>
               if ( wupd_dry(i,k-1) &lt; 1e-15 ) then<a name='712'>
                  wupd_dry(i,k) = 0.<a name='713'>
               else<a name='714'>
                  dwUPDdz(i,k-1) = -2. *epsmf(i,k)*wupd_dry(i,k-1) + 0.33*B(i,k-1)/wupd_dry(i,k-1)<a name='715'>
                  wupd_dry(i,k) = wupd_dry(i,k-1) + dwUPDdz(i,k-1) * dzm(i,k-1)<a name='716'>
               end if<a name='717'>
               dUUPDdz(i,k-1) = -epsmf(i,k) * (UUPD(i,k-1) - u_temf(i,k-1))<a name='718'>
               UUPD(i,k) = UUPD(i,k-1) + dUUPDdz(i,k-1) * dzm(i,k-1)<a name='719'>
               dVUPDdz(i,k-1) = -epsmf(i,k) * (VUPD(i,k-1) - v_temf(i,k-1))<a name='720'>
               VUPD(i,k) = VUPD(i,k-1) + dVUPDdz(i,k-1) * dzm(i,k-1)<a name='721'>
               dTEUPDdz(i,k-1) = -epsmf(i,k) * (TEUPD(i,k-1) - te_temfx(i,k-1))<a name='722'>
               TEUPD(i,k) = TEUPD(i,k-1) + dTEUPDdz(i,k-1) * dzm(i,k-1)<a name='723'>
               <font color=#447700>! Alternative updraft velocity based on moist thetav<a name='724'></font>
               <font color=#447700>! Need thetavUPDmoist, qlUPD<a name='725'></font>
               rUPD(i,k) = qtup_temfx(i,k) / (1. - qtup_temfx(i,k))<a name='726'>
               <font color=#447700>! WA Updraft temperature assuming no liquid<a name='727'></font>
               TUPD(i,k) = thup_temfx(i,k) * pi2d(i,k)   <a name='728'>
               <font color=#447700>! Updraft saturation mixing ratio <a name='729'></font>
               rstUPD(i,k) = <A href='../../html_code/phys/module_bl_temf.F.html#RSAT'>rsat</A><A href='../../html_code/phys/module_bl_temf.F.html#TEMF2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSAT_2">(p2d(i,k-1),TUPD(i,k),ep2)  <a name='730'>
               <font color=#447700>! Correct to actual temperature (Sommeria &amp; Deardorff 1977)<a name='731'></font>
               beta1(i,k) = 0.622 * (xlv/(r_d*TUPD(i,k))) * (xlv/(cp*TUPD(i,k)))<a name='732'>
               rstUPD(i,k) = rstUPD(i,k) * (1.0+beta1(i,k)*rUPD(i,k)) / (1.0+beta1(i,k)*rstUPD(i,k))<a name='733'>
               qstUPD(i,k) = rstUPD(i,k) / (1. + rstUPD(i,k))<a name='734'>
               if (rUPD(i,k) &gt; rstUPD(i,k)) then<a name='735'>
                  rlUPD(i,k) = rUPD(i,k) - rstUPD(i,k)<a name='736'>
                  qlUPD(i,k) = rlUPD(i,k) / (1. + rlUPD(i,k))<a name='737'>
                  thetavUPDmoist(i,k) = (thup_temfx(i,k) + ((xlv/cp)*qlUPD(i,k)/pi2d(i,k))) * &amp;<a name='738'>
                                        (1. + 0.608*qstUPD(i,k) - qlUPD(i,k))<a name='739'>
               else<a name='740'>
                  rlUPD(i,k) = 0.<a name='741'>
                  qlUPD(i,k) = qcx(i,k-1)   <font color=#447700>! WA 4/6/10 allow environment liquid<a name='742'></font>
                  thetavUPDmoist(i,k) = thup_temfx(i,k) * (1. + 0.608*qtup_temfx(i,k))<a name='743'>
               end if<a name='744'>
               Bmoist(i,k-1) = g * (thetavUPDmoist(i,k) - thetav(i,k)) / thetav(i,k)<a name='745'>
               if ( wupd_temfx(i,k-1) &lt; 1e-15 ) then<a name='746'>
                  wupd_temfx(i,k) = 0.<a name='747'>
               else<a name='748'>
                  dwUPDmoistdz(i,k-1) = -2. *epsmf(i,k)*wupd_temfx(i,k-1) + 0.33*Bmoist(i,k-1)/wupd_temfx(i,k-1)<a name='749'>
                  wupd_temfx(i,k) = wupd_temfx(i,k-1) + dwUPDmoistdz(i,k-1) * dzm(i,k-1)<a name='750'>
               end if<a name='751'>
            else<a name='752'>
               thup_temfx(i,k) = thetal(i,k)<a name='753'>
               qtup_temfx(i,k) = qt(i,k)<a name='754'>
               wupd_dry(i,k) = 0.<a name='755'>
               UUPD(i,k) = u_temf(i,k)<a name='756'>
               VUPD(i,k) = v_temf(i,k)<a name='757'>
               TEUPD(i,k) = te_temfx(i,k)<a name='758'>
               qlUPD(i,k) = qcx(i,k-1)<a name='759'>
               wupd_temfx(i,k) = 0.<a name='760'>
            end if<a name='761'>
         end do<a name='762'>
<a name='763'>
         <font color=#447700>! Find hd based on wUPD<a name='764'></font>
         if (wupd_dry(i,1) == 0.) then<a name='765'>
            hdidx(i) = 1<a name='766'>
         else<a name='767'>
            hdidx(i) = kte  <font color=#447700>! In case wUPD &lt;= 0 not found<a name='768'></font>
            do k = 2,kte<a name='769'>
               <font color=#447700>! if (wupd_dry(i,k) &lt;= 0.) then<a name='770'></font>
               if (wupd_dry(i,k) &lt;= 0. .OR. zm(i,k) &gt; hmax) then <a name='771'>
                  hdidx(i) = k<a name='772'>
                  goto 100   <font color=#447700>! FORTRAN made me do it!<a name='773'></font>
               end if<a name='774'>
            end do<a name='775'>
         end if<a name='776'>
100      hd(i) = zm(i,hdidx(i))<a name='777'>
         kpbl1d(i) = hdidx(i)<a name='778'>
         hpbl(i) = hd(i)       <font color=#447700>! WA 5/11/10 hpbl is height.  Should still be replaced by something that works whether convective or not.<a name='779'></font>
<a name='780'>
         <font color=#447700>! Find LCL, hct, and ht<a name='781'></font>
         lclidx(i) = kte   <font color=#447700>! In case LCL not found<a name='782'></font>
         do k = kts,kte<a name='783'>
            if ( k &lt; hmax_idx(i) .AND. rUPD(i,k) &gt; rstUPD(i,k)) then<a name='784'>
               lclidx(i) = k<a name='785'>
               goto 200<a name='786'>
            end if<a name='787'>
         end do<a name='788'>
200      lcl(i) = zm(i,lclidx(i))<a name='789'>
<a name='790'>
         if (hd(i) &gt; lcl(i)) then   <font color=#447700>! Forced cloud (at least) occurs<a name='791'></font>
            <font color=#447700>! Find hct based on wUPDmoist<a name='792'></font>
            if (wupd_temfx(i,1) == 0.) then<a name='793'>
               hctidx(i) = 1<a name='794'>
            else<a name='795'>
               hctidx(i) = kte  <font color=#447700>! In case wUPD &lt;= 0 not found<a name='796'></font>
               do k = 2,kte<a name='797'>
                  if (wupd_temfx(i,k) &lt;= 0. .OR. zm(i,k) &gt; hmax) then<a name='798'>
                     hctidx(i) = k<a name='799'>
                     goto 300   <font color=#447700>! FORTRAN made me do it!<a name='800'></font>
                  end if<a name='801'>
               end do<a name='802'>
            end if<a name='803'>
   300      hct(i) = zm(i,hctidx(i))<a name='804'>
            if (hctidx(i) &lt;= hdidx(i)+1) then   <font color=#447700>! No active cloud<a name='805'></font>
               hct(i) = hd(i)<a name='806'>
               hctidx(i) = hdidx(i)<a name='807'>
            else <a name='808'>
            end if<a name='809'>
         else   <font color=#447700>! No cloud<a name='810'></font>
            hct(i) = hd(i)<a name='811'>
            hctidx(i) = hdidx(i)<a name='812'>
         end if<a name='813'>
         ht(i) = max(hd(i),hct(i))<a name='814'>
         htidx(i) = max(hdidx(i),hctidx(i))<a name='815'>
<a name='816'>
         <font color=#447700>! Now truncate updraft at ht with taper<a name='817'></font>
         do k = 1,kte<a name='818'>
            if (zm(i,k) &lt; 0.9*ht(i)) then  <font color=#447700>! Below taper region<a name='819'></font>
               tval(i) = 1<a name='820'>
            else if (zm(i,k) &gt;= 0.9*ht(i) .AND. zm(i,k) &lt;= 1.0*ht(i)) then<a name='821'>
               <font color=#447700>! Within taper region<a name='822'></font>
               tval(i) = 1. - ((zm(i,k) - 0.9*ht(i)) / (1.0*ht(i) - 0.9*ht(i)))<a name='823'>
            else  <font color=#447700>! Above taper region<a name='824'></font>
               tval(i) = 0.<a name='825'>
            end if<a name='826'>
            thup_temfx(i,k) = tval(i) * thup_temfx(i,k) + (1-tval(i))*thetal(i,k)<a name='827'>
            thetavUPD(i,k) = tval(i) * thetavUPD(i,k) + (1-tval(i))*thetav(i,k)<a name='828'>
            qtup_temfx(i,k) = tval(i) * qtup_temfx(i,k) + (1-tval(i)) * qt(i,k)<a name='829'>
            <font color=#447700>! WA 6/21/13 was a subscript error when k=1<a name='830'></font>
            if (k &gt; 1) then<a name='831'>
               qlUPD(i,k) = tval(i) * qlUPD(i,k) + (1-tval(i)) * qcx(i,k-1)<a name='832'>
            end if<a name='833'>
            UUPD(i,k) = tval(i) * UUPD(i,k) + (1-tval(i)) * u_temf(i,k)<a name='834'>
            VUPD(i,k) = tval(i) * VUPD(i,k) + (1-tval(i)) * v_temf(i,k)<a name='835'>
            TEUPD(i,k) = tval(i) * TEUPD(i,k) + (1-tval(i)) * te_temfx(i,k)<a name='836'>
            if (zm(i,k) &gt; ht(i)) then  <font color=#447700>! WA this is just for cleanliness<a name='837'></font>
               wupd_temfx(i,k) = 0.<a name='838'>
               dwUPDmoistdz(i,k) = 0.<a name='839'>
               wupd_dry(i,k) = 0.<a name='840'>
               dwUPDdz(i,k) = 0.<a name='841'>
            end if<a name='842'>
         end do<a name='843'>
<a name='844'>
         <font color=#447700>! Calculate lateral detrainment rate for cloud layer<a name='845'></font>
         deltmf(i,1) = Cepsmf<a name='846'>
         do k = 2,kte-1<a name='847'>
            if (hctidx(i) &gt; hdidx(i)+1) then      <font color=#447700>! Some cloud<a name='848'></font>
               deltmf(i,k) = 0.9 * Cepsmf + Cdelt * (atan((zm(i,k)-(lcl(i)+(hct(i)-lcl(i))/1.5))/ &amp;<a name='849'>
                                                          ((hct(i)-lcl(i))/8))+(3.1415926/2))/3.1415926<a name='850'>
            else if (k &lt; hdidx(i)) then   <font color=#447700>! No cloud, below hd<a name='851'></font>
               deltmf(i,k) = Cepsmf + 0.05 * 1. / (hd(i) - zm(i,k))<a name='852'>
            else if (k &gt;= hdidx(i)) then    <font color=#447700>! No cloud, above hd<a name='853'></font>
               deltmf(i,k) = deltmf(i,k-1)<a name='854'>
            end if<a name='855'>
         end do<a name='856'>
<a name='857'>
         <font color=#447700>! Calculate mass flux (defined on turbulence levels)<a name='858'></font>
         mf_temfx(i,1) = CM * wstr(i)<a name='859'>
         do kt = 2,kte-1<a name='860'>
            dMdz(i,kt) = (epsmf(i,kt) - deltmf(i,kt)) * mf_temfx(i,kt-1) * dzt(i,kt)<a name='861'>
            mf_temfx(i,kt) = mf_temfx(i,kt-1) + dMdz(i,kt)<a name='862'>
         end do<a name='863'>
<a name='864'>
         <font color=#447700>! WA 12/28/09 If mass flux component &gt; diffusive <a name='865'></font>
         <font color=#447700>! component at second level,<a name='866'></font>
         <font color=#447700>! reduce M to prevent a stable layer<a name='867'></font>
         MFCth(i,2) = mf_temfx(i,2) * (thup_temfx(i,2)-thetal(i,2) + thup_temfx(i,3)-thetal(i,3)) / 2.<a name='868'>
         if (MFCth(i,2) &gt; Fz(i,2)) then<a name='869'>
            red_fact = Fz(i,2) / MFCth(i,2)<a name='870'>
            do kt = 1,kte<a name='871'>
               mf_temfx(i,kt) = mf_temfx(i,kt) * red_fact<a name='872'>
            end do<a name='873'>
         end if  <font color=#447700>! Reduce M to prevent stable layer at second level<a name='874'></font>
<a name='875'>
         <font color=#447700>! Calculate mass flux contributions to fluxes (defined on turb levels)<a name='876'></font>
         <font color=#447700>! Use log interpolation at first level<a name='877'></font>
         MFCth(i,1) = mf_temfx(i,1) * (thup_temfx(i,1)-thetal(i,1) &amp;<a name='878'>
            + (thup_temfx(i,2)-thetal(i,2) - &amp;<a name='879'>
            (thup_temfx(i,1)-thetal(i,1))) * log(zt(i,1)/znt(i))/log(zm(i,2)/znt(i)))<a name='880'>
         MFCq(i,1) = mf_temfx(i,1) * (qtup_temfx(i,1)-qt(i,1) &amp;<a name='881'>
            + (qtup_temfx(i,2)-qt(i,2) - &amp;<a name='882'>
            (qtup_temfx(i,1)-qt(i,1))) * log(zt(i,1)/znt(i))/log(zm(i,2)/znt(i)))<a name='883'>
         MFCu(i,1) = mf_temfx(i,1) * (UUPD(i,1)-u_temf(i,1) &amp;<a name='884'>
            + (UUPD(i,2)-u_temf(i,2) - &amp;<a name='885'>
            (UUPD(i,1)-u_temf(i,1))) * log(zt(i,1)/znt(i))/log(zm(i,2)/znt(i)))<a name='886'>
         MFCv(i,1) = mf_temfx(i,1) * (VUPD(i,1)-v_temf(i,1) &amp;<a name='887'>
            + (VUPD(i,2)-v_temf(i,2) - &amp;<a name='888'>
            (VUPD(i,1)-v_temf(i,1))) * log(zt(i,1)/znt(i))/log(zm(i,2)/znt(i)))<a name='889'>
         MFCql(i,1) = mf_temfx(i,1) * (qlUPD(i,1)-qcx(i,1) &amp;<a name='890'>
            + (qlUPD(i,2)-qcx(i,2) - &amp;<a name='891'>
            (qlUPD(i,1)-qcx(i,1))) * log(zt(i,1)/znt(i))/log(zm(i,2)/znt(i)))<a name='892'>
         MFCTE(i,1) = mf_temfx(i,1) * (TEUPD(i,1)-te_temfx(i,1) &amp;<a name='893'>
            + (TEUPD(i,2)-te_temfx(i,2) - &amp;<a name='894'>
            (TEUPD(i,1)-te_temfx(i,1))) * log(zt(i,1)/znt(i))/log(zm(i,2)/znt(i)))  <font color=#447700>! WA Check this<a name='895'></font>
         do kt = 2,kte-1<a name='896'>
            MFCth(i,kt) = mf_temfx(i,kt) * (thup_temfx(i,kt)-thetal(i,kt) + thup_temfx(i,kt+1)-thetal(i,kt+1)) / 2.<a name='897'>
            MFCq(i,kt) = mf_temfx(i,kt) * (qtup_temfx(i,kt)-qt(i,kt) + qtup_temfx(i,kt+1)-qt(i,kt+1)) / 2.<a name='898'>
            MFCu(i,kt) = mf_temfx(i,kt) * (UUPD(i,kt)-u_temf(i,kt) + UUPD(i,kt+1)-u_temf(i,kt+1)) / 2.<a name='899'>
            MFCv(i,kt) = mf_temfx(i,kt) * (VUPD(i,kt)-v_temf(i,kt) + VUPD(i,kt+1)-v_temf(i,kt+1)) / 2.<a name='900'>
            MFCql(i,kt) = mf_temfx(i,kt) * (qlUPD(i,kt)-qcx(i,kt-1) + qlUPD(i,kt+1)-qcx(i,kt)) / 2.<a name='901'>
            MFCTE(i,kt) = mf_temfx(i,kt) * (TEUPD(i,kt)-te_temfx(i,kt)) <font color=#447700>! TE is on turb levels<a name='902'></font>
         end do<a name='903'>
         MFCth(i,kte) = 0<a name='904'>
         MFCq(i,kte) = 0<a name='905'>
         MFCu(i,kte) = 0<a name='906'>
         MFCv(i,kte) = 0<a name='907'>
         MFCql(i,kte) = 0<a name='908'>
         MFCTE(i,kte) = 0<a name='909'>
<a name='910'>
         <font color=#447700>! Calculate cloud fraction (on mass levels)<a name='911'></font>
         cf3d_temfx(i,1) = 0.0<a name='912'>
         cfm_temfx(i) = 0.0<a name='913'>
         do k = 2,kte<a name='914'>
            <font color=#447700>! if (wupd_temfx(i,k-1) &gt;= 1.0e-15 .AND. wupd_temfx(i,k) &gt;= 1.0e-15 .AND. .NOT. isnan(wupd_temfx(i,k-1)) .AND. .NOT. isnan(wupd_temfx(i,k))) then<a name='915'></font>
            if (wupd_temfx(i,k-1) &gt;= 1.0e-15 .AND. wupd_temfx(i,k) &gt;= 1.0e-15) then<a name='916'>
               au(i,k) = ((mf_temfx(i,k-1)+mf_temfx(i,k))/2.0) / ((wupd_temfx(i,k-1)+wupd_temfx(i,k))/2.0)  <font color=#447700>! WA average before divide, is that best?<a name='917'></font>
            else<a name='918'>
               au(i,k) = 0.0<a name='919'>
            end if<a name='920'>
            sigq2 = au(i,k) * (qtup_temfx(i,k)-qt(i,k))<a name='921'>
            if (sigq2 &gt; 0.0) then<a name='922'>
               sigq(i,k) = sqrt(sigq2)<a name='923'>
            else<a name='924'>
               sigq(i,k) = 0.0<a name='925'>
            end if<a name='926'>
            <font color=#447700>! rst = rsat(p2d(i,k),thx(i,k)*pi2d(i,k),ep2)<a name='927'></font>
            rst = <A href='../../html_code/phys/module_bl_temf.F.html#RSAT'>rsat</A><A href='../../html_code/phys/module_bl_temf.F.html#TEMF2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSAT_3">(p2d(i,k-1),thx(i,k-1)*pi2d(i,k-1),ep2)<a name='928'>
            qst(i,k) = rst / (1. + rst)<a name='929'>
            satdef(i,k) = qt(i,k) - qst(i,k)<a name='930'>
            if (satdef(i,k) &lt;= 0.0) then<a name='931'>
               if (sigq(i,k) &gt; 1.0e-15) then<a name='932'>
                  cf3d_temfx(i,k) = max(0.5 + 0.36 * atan(1.55*(satdef(i,k)/sigq(i,k))),0.0)<a name='933'>
               else<a name='934'>
                  cf3d_temfx(i,k) = 0.0<a name='935'>
               end if<a name='936'>
            else<a name='937'>
               cf3d_temfx(i,k) = 1.0<a name='938'>
            end if<a name='939'>
            if (zm(i,k) &lt; lcl(i)) then<a name='940'>
               cf3d_temfx(i,k) = 0.0<a name='941'>
            end if<a name='942'>
            <font color=#447700>! Put max value so far into cfm<a name='943'></font>
            if (zt(i,k) &lt;= hmax) then<a name='944'>
               cfm_temfx(i) = max(cf3d_temfx(i,k),cfm_temfx(i))<a name='945'>
            end if<a name='946'>
         end do<a name='947'>
<a name='948'>
      else    <font color=#447700>! not is_convective, no MF components<a name='949'></font>
         do kt = 1,kte<a name='950'>
            MFCth(i,kt) = 0<a name='951'>
            MFCq(i,kt) = 0<a name='952'>
            MFCu(i,kt) = 0<a name='953'>
            MFCv(i,kt) = 0<a name='954'>
            MFCql(i,kt) = 0<a name='955'>
            MFCTE(i,kt) = 0<a name='956'>
         end do<a name='957'>
         lcl(i) = zm(i,kte-1)<a name='958'>
         hct(i) = zm(i,1)<a name='959'>
         hctidx(i) = 1<a name='960'>
         hd(i) = zm(i,1)<a name='961'>
         hdidx(i) = 1<a name='962'>
         ht(i) = hd(i)<a name='963'>
         <font color=#447700>! Cloud fraction calculations<a name='964'></font>
         cf3d_temfx(i,1) = 0.0<a name='965'>
         cfm_temfx(i) = 0.0<a name='966'>
         do k = 2,kte<a name='967'>
            if (qcx(i,k-1) &gt; 1.0e-15) then<a name='968'>
               cf3d_temfx(i,k) = 1.0<a name='969'>
            else<a name='970'>
               cf3d_temfx(i,k) = 0.0<a name='971'>
            end if<a name='972'>
            <font color=#447700>! Put max value so far into cfm<a name='973'></font>
            if (zt(i,k) &lt;= hmax) then<a name='974'>
               cfm_temfx(i) = max(cf3d_temfx(i,k),cfm_temfx(i))<a name='975'>
            end if<a name='976'>
         end do<a name='977'>
<a name='978'>
      end if   <font color=#447700>! MF components or not<a name='979'></font>
      cf3d_temfx(i,kte) = 0.0<a name='980'>
      <font color=#447700>! Mass flux block ends here<a name='981'></font>
<a name='982'>
      <font color=#447700>! Flux profiles<a name='983'></font>
      do kt = 2,kte<a name='984'>
         <font color=#447700>! Fz(i,kt) = -kh(i,kt) * dthdz(i,kt)<a name='985'></font>
         shf_temfx(i,kt) = Fz(i,kt) + MFCth(i,kt)<a name='986'>
         QFK(i,kt) = -kh(i,kt) * dqtdz(i,kt)<a name='987'>
         qf_temfx(i,kt) = QFK(i,kt) + MFCq(i,kt)<a name='988'>
         uwk(i,kt) = -km(i,kt) * dudz(i,kt)<a name='989'>
         uw_temfx(i,kt) = uwk(i,kt) + MFCu(i,kt)<a name='990'>
         vwk(i,kt) = -km(i,kt) * dvdz(i,kt)<a name='991'>
         vw_temfx(i,kt) = vwk(i,kt) + MFCv(i,kt)<a name='992'>
      end do<a name='993'>
<a name='994'>
      <font color=#447700>! Surface momentum fluxes<a name='995'></font>
      <font color=#447700>! WA TEST 11/7/13 use w* as a component of the mean wind inside the<a name='996'></font>
      <font color=#447700>! u* calculation instead of in the velocity scale below (Felix)<a name='997'></font>
      <font color=#447700>! ust(i) = sqrt(ftau(i,1)/ftau0) * sqrt(u_temf(i,2)**2. + v_temf(i,2)**2.) * leps(i,1) / log(zm(i,2)/znt(i)) / zt(i,1)<a name='998'></font>
      ust(i) = sqrt(ftau(i,1)/ftau0) * sqrt(u_temf(i,2)**2. + v_temf(i,2)**2. + (0.5*wstr(i))**2.) * leps(i,1) / log(zm(i,2)/znt(i)) / zt(i,1)<a name='999'>
<a name='1000'>
      ang(i) = atan2(v_temf(i,2),u_temf(i,2))<a name='1001'>
      uw_temfx(i,1) = -cos(ang(i)) * ust(i)**2.<a name='1002'>
      vw_temfx(i,1) = -sin(ang(i)) * ust(i)**2.<a name='1003'>
<a name='1004'>
      <font color=#447700>! Calculate mixed scaling velocity (Moeng &amp; Sullivan 1994 JAS p.1021)<a name='1005'></font>
      <font color=#447700>! Replaces ust everywhere<a name='1006'></font>
      <font color=#447700>! WA TEST 11/7/13 back to wm = u* but with "whole" wind in u* above<a name='1007'></font>
      wm(i) = ust(i)<a name='1008'>
      <font color=#447700>! WA 7/23/10 reduce velocity scale to fix excessive fluxes<a name='1009'></font>
      <font color=#447700>! wm(i) = 0.5 * (1./5. * (wstr(i)**3. + 5. * ust(i)**3.)) ** (1./3.) <a name='1010'></font>
<a name='1011'>
      <font color=#447700>! Specified flux versions (flux is modified by land surface)<a name='1012'></font>
      <font color=#447700>! WA 5/31/13 use whole surface flux to improve heat conservation<a name='1013'></font>
      shf_temfx(i,1) = hfx(i)/(rho(i,1)*cp)<a name='1014'>
      qf_temfx(i,1) = qfx(i)/rho(i,1)<a name='1015'>
      Fz(i,1) = shf_temfx(i,1) - MFCth(i,1)<a name='1016'>
      QFK(i,1) = qf_temfx(i,1) - MFCq(i,1)<a name='1017'>
<a name='1018'>
      <font color=#447700>! Calculate thetav and its flux<a name='1019'></font>
      <font color=#447700>! From Lewellen 2004 eq. 3<a name='1020'></font>
      <font color=#447700>! WA The constants and combinations below should probably be replaced<a name='1021'></font>
      <font color=#447700>! by something more consistent with the WRF system, but for now<a name='1022'></font>
      <font color=#447700>! I don't want to take the chance of breaking something.<a name='1023'></font>
      do kt = 2,kte-1<a name='1024'>
         alpha2(i,kt) = 0.61 * (thetal(i,kt) + thetal(i,kt+1)) / 2.<a name='1025'>
         beta2(i,kt) = (100000. / p2di(i,kt))**0.286 * 2.45e-6 / 1004.67 - 1.61 * (thetal(i,kt) + thetal(i,kt+1)) / 2.<a name='1026'>
      end do<a name='1027'>
      alpha2(i,1) = 0.61 * (thetal(i,1) + (thetal(i,2)-thetal(i,1)) * (zt(i,2) - znt(i)) / (zm(i,2) - znt(i)))<a name='1028'>
      alpha2(i,kte) = 0.61 * thetal(i,kte)<a name='1029'>
      beta2(i,1) = (100000. / p2di(i,1))**0.286 * 2.45e-6 / &amp;<a name='1030'>
         1004.67 - 1.61 * (thetal(i,1) + (thetal(i,2) - thetal(i,1)) &amp;<a name='1031'>
         * (zt(i,2) - znt(i)) / (zm(i,2) - znt(i)))<a name='1032'>
      beta2(i,kte) = (100000. / p2di(i,kte))**0.286 * 2.45e-6 / 1004.67 - 1.61 * thetal(i,kte)<a name='1033'>
      if ( is_convective ) then <font color=#447700>! Activate EDMF components<a name='1034'></font>
         do kt = 1,kte-1<a name='1035'>
            MFCthv(i,kt) = (1. + 0.61 * (qtup_temfx(i,kt)+qtup_temfx(i,kt+1))) / 2. * MFCth(i,kt) + &amp;<a name='1036'>
                           alpha2(i,kt) * MFCq(i,kt) + beta2(i,kt) * MFCql(i,kt)<a name='1037'>
         end do<a name='1038'>
         MFCthv(i,kte) = 0.<a name='1039'>
      else    <font color=#447700>! No MF components<a name='1040'></font>
         do kt = 1,kte<a name='1041'>
            MFCthv(i,kt) = 0.<a name='1042'>
         end do<a name='1043'>
      end if<a name='1044'>
<a name='1045'>
      do kt = 1,kte<a name='1046'>
         THVF(i,kt) = (1. + 0.61 * qt(i,kt)) * Fz(i,kt) + alpha2(i,kt) * QFK(i,kt) + MFCthv(i,kt)<a name='1047'>
      end do<a name='1048'>
<a name='1049'>
      <font color=#447700>! Update mean variables:<a name='1050'></font>
      <font color=#447700>! This is done with implicit solver for diffusion part followed<a name='1051'></font>
      <font color=#447700>! by explicit solution for MF terms.<a name='1052'></font>
      <font color=#447700>! Note that Coriolis terms that were source terms for u and v<a name='1053'></font>
      <font color=#447700>! in Matlab code are now handled by WRF outside this PBL context.<a name='1054'></font>
<a name='1055'>
      u_new(i,:) = u_temf(i,:)<a name='1056'>
      call <A href='../../html_code/phys/module_bl_temf.F.html#SOLVE_IMPLICIT_TEMF'>solve_implicit_temf</A><A href='../../html_code/phys/module_bl_temf.F.html#TEMF2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOLVE_IMPLICIT_TEMF_1">(km(i,kts:kte-1),u_new(i,kts+1:kte), &amp;<a name='1057'>
         uw_temfx(i,1),dzm(i,kts:kte-1),dzt(i,kts:kte-1),kts,kte-1,dt,.FALSE.)<a name='1058'>
      do k = 2,kte-1<a name='1059'>
         u_new(i,k) = u_new(i,k) + dt * (-(MFCu(i,k)-MFCu(i,k-1))) / dzm(i,k)<a name='1060'>
      end do<a name='1061'>
<a name='1062'>
      v_new(i,:) = v_temf(i,:)<a name='1063'>
      call <A href='../../html_code/phys/module_bl_temf.F.html#SOLVE_IMPLICIT_TEMF'>solve_implicit_temf</A><A href='../../html_code/phys/module_bl_temf.F.html#TEMF2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOLVE_IMPLICIT_TEMF_2">(km(i,kts:kte-1),v_new(i,kts+1:kte), &amp;<a name='1064'>
         vw_temfx(i,1),dzm(i,kts:kte-1),dzt(i,kts:kte-1),kts,kte-1,dt,.FALSE.)<a name='1065'>
      do k = 2,kte-1<a name='1066'>
         v_new(i,k) = v_new(i,k) + dt * (-(MFCv(i,k)-MFCv(i,k-1))) / dzm(i,k)<a name='1067'>
      end do<a name='1068'>
<a name='1069'>
      call <A href='../../html_code/phys/module_bl_temf.F.html#SOLVE_IMPLICIT_TEMF'>solve_implicit_temf</A><A href='../../html_code/phys/module_bl_temf.F.html#TEMF2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOLVE_IMPLICIT_TEMF_3">(kh(i,kts:kte-1),thetal(i,kts+1:kte),Fz(i,1),dzm(i,kts:kte-1),&amp;<a name='1070'>
                               dzt(i,kts:kte-1),kts,kte-1,dt,.FALSE.)<a name='1071'>
      do k = 2,kte-1<a name='1072'>
         thetal(i,k) = thetal(i,k) + dt * (-(MFCth(i,k)-MFCth(i,k-1))) / dzm(i,k)<a name='1073'>
      end do<a name='1074'>
<a name='1075'>
      call <A href='../../html_code/phys/module_bl_temf.F.html#SOLVE_IMPLICIT_TEMF'>solve_implicit_temf</A><A href='../../html_code/phys/module_bl_temf.F.html#TEMF2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOLVE_IMPLICIT_TEMF_4">(kh(i,kts:kte-1),qt(i,kts+1:kte),QFK(i,1),dzm(i,kts:kte-1),&amp;<a name='1076'>
                               dzt(i,kts:kte-1),kts,kte-1,dt,.FALSE.)<a name='1077'>
      do k = 2,kte-1<a name='1078'>
         qt(i,k) = qt(i,k) + dt * (-(MFCq(i,k)-MFCq(i,k-1))) / dzm(i,k)<a name='1079'>
      end do<a name='1080'>
<a name='1081'>
      <font color=#447700>! Stepping TE forward is a bit more complicated<a name='1082'></font>
      te_temfx(i,1) = ust(i)**2. / ftau(i,1) * (1. + ratio(i,1))<a name='1083'>
      if ( is_convective ) then<a name='1084'>
         <font color=#447700>! WA currently disabled if MFopt=false, is that right?<a name='1085'></font>
         convection_TKE_surface_src(i) = 2. * beta(i,1) * shf_temfx(i,1)<a name='1086'>
      else<a name='1087'>
         convection_TKE_surface_src(i) = 0.<a name='1088'>
      end if<a name='1089'>
      te_temfx(i,1) = max(te_temfx(i,1), &amp;<a name='1090'>
                          (leps(i,1) / Cgamma * (ust(i)**2. * S(i,1) + convection_TKE_surface_src(i)))**(2./3.))<a name='1091'>
      if (te_temfx(i,1) &gt; 20.0) then<a name='1092'>
         te_temfx(i,1) = 20.0    <font color=#447700>! WA 9/28/11 limit max TE<a name='1093'></font>
      end if<a name='1094'>
      sfcFTE(i) = -(km(i,1)+km(i,2)) / 2. * (te_temfx(i,2)-te_temfx(i,1)) / dzm(i,2)<a name='1095'>
<a name='1096'>
      do kt = 1,kte<a name='1097'>
         if (THVF(i,kt) &gt;= 0) then<a name='1098'>
            buoy_src(i,kt) = 2. * g / thetav(i,kt) * THVF(i,kt)<a name='1099'>
         else<a name='1100'>
            buoy_src(i,kt) = 0.  <font color=#447700>! Cancel buoyancy term when locally stable<a name='1101'></font>
         end if<a name='1102'>
         srcs(i,kt) = -uw_temfx(i,kt) * dudz(i,kt) - vw_temfx(i,kt) * dvdz(i,kt) - &amp;<a name='1103'>
                      Cgamma * te_temfx(i,kt)**1.5 * linv(i,kt) + buoy_src(i,kt)<a name='1104'>
      end do<a name='1105'>
      call <A href='../../html_code/phys/module_bl_temf.F.html#SOLVE_IMPLICIT_TEMF'>solve_implicit_temf</A><A href='../../html_code/phys/module_bl_temf.F.html#TEMF2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOLVE_IMPLICIT_TEMF_5">((km(i,kts:kte-1)+km(i,kts+1:kte))/2.0, &amp;<a name='1106'>
         te_temfx(i,kts+1:kte),sfcFTE(i),dzt(i,kts+1:kte),dzt(i,kts:kte-1),kts,kte-1,dt,.false.)<a name='1107'>
      do kt = 2,kte-1<a name='1108'>
         te_temfx(i,kt) = te_temfx(i,kt) + dt * srcs(i,kt)<a name='1109'>
         te_temfx(i,kt) = te_temfx(i,kt) + dt * (-(MFCTE(i,kt)-MFCTE(i,kt-1))) / dzt(i,kt)<a name='1110'>
         if (te_temfx(i,kt) &lt; TEmin) te_temfx(i,kt) = TEmin<a name='1111'>
      end do<a name='1112'>
      te_temfx(i,kte) = 0.0<a name='1113'>
      do kt = 2,kte-1<a name='1114'>
         if (te_temfx(i,kt) &gt; 20.0) then<a name='1115'>
            te_temfx(i,kt) = 20.0    <font color=#447700>! WA 9/29/11 reduce limit max TE from 30<a name='1116'></font>
         end if<a name='1117'>
      end do<a name='1118'>
<a name='1119'>
      <font color=#447700>! Done with updates, now convert internal variables back to WRF vars<a name='1120'></font>
      do k = kts,kte<a name='1121'>
         <font color=#447700>! Populate kh_temfx, km_temfx from kh, km<a name='1122'></font>
         kh_temfx(i,k) = kh(i,k)<a name='1123'>
         km_temfx(i,k) = km(i,k)<a name='1124'>
      end do<a name='1125'>
<a name='1126'>
      <font color=#447700>! Convert thetal, qt back to theta, qv, qc<a name='1127'></font>
      <font color=#447700>! See opposite conversion at top of subroutine<a name='1128'></font>
      <font color=#447700>! WA this accounts for offset of indexing between<a name='1129'></font>
      <font color=#447700>! WRF and TEMF, see notes at top of this routine.<a name='1130'></font>
      call <A href='../../html_code/phys/module_bl_temf.F.html#THLQT2THQVQC'>thlqt2thqvqc</A><A href='../../html_code/phys/module_bl_temf.F.html#TEMF2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THLQT2THQVQC_1">(thetal(i,kts+1:kte),qt(i,kts+1:kte), &amp;<a name='1131'>
         thx_new(i,kts:kte-1),qvx_new(i,kts:kte-1),qcx_new(i,kts:kte-1), &amp;<a name='1132'>
         p2d(i,kts:kte-1),pi2d(i,kts:kte-1),kts,kte-1,ep2,xlv,cp)<a name='1133'>
<a name='1134'>
      do k = kts,kte-1<a name='1135'>
         <font color=#447700>! Calculate tendency terms<a name='1136'></font>
         <font color=#447700>! WA this accounts for offset of indexing between<a name='1137'></font>
         <font color=#447700>! WRF and TEMF, see notes at top of this routine.<a name='1138'></font>
         rubltenx(i,k) = (u_new(i,k+1) - u_temf(i,k+1)) / dt<a name='1139'>
         rvbltenx(i,k) = (v_new(i,k+1) - v_temf(i,k+1)) / dt<a name='1140'>
         rthbltenx(i,k) = (thx_new(i,k) - thx(i,k)) / dt<a name='1141'>
         rqvbltenx(i,k) = (qvx_new(i,k) - qvx(i,k)) / dt<a name='1142'>
         rqcbltenx(i,k) = (qcx_new(i,k) - qcx(i,k)) / dt<a name='1143'>
      end do<a name='1144'>
      rubltenx(i,kte) = 0.<a name='1145'>
      rvbltenx(i,kte) = 0.<a name='1146'>
      rthbltenx(i,kte) = 0.<a name='1147'>
      rqvbltenx(i,kte) = 0.<a name='1148'>
      rqcbltenx(i,kte) = 0.<a name='1149'>
<a name='1150'>
      <font color=#447700>! Populate surface exchange coefficient variables to go back out<a name='1151'></font>
      <font color=#447700>! for next time step of surface scheme<a name='1152'></font>
      <font color=#447700>! WA 2/16/11 removed, not needed in BL<a name='1153'></font>
<a name='1154'>
      <font color=#447700>! Populate 10 m winds and 2 m temp<a name='1155'></font>
      <font color=#447700>! WA Note this only works if first mass level is above 10 m<a name='1156'></font>
      u10(i) = u_new(i,2) * log(10.0/znt(i)) / log(zm(i,2)/znt(i))<a name='1157'>
      v10(i) = v_new(i,2) * log(10.0/znt(i)) / log(zm(i,2)/znt(i))<a name='1158'>
      t2(i) = (tsk(i)/pi2d(i,1) + (thx_new(i,1) - tsk(i)/pi2d(i,1)) * log(2.0/z0t(i)) / log(zm(i,2)/z0t(i))) * pi2d(i,1)  <font color=#447700>! WA this should also use pi at z0<a name='1159'></font>
<a name='1160'>
      <font color=#447700>! Populate diagnostic variables<a name='1161'></font>
      hd_temfx(i) = hd(i)<a name='1162'>
      lcl_temfx(i) = lcl(i)<a name='1163'>
      hct_temfx(i) = hct(i)<a name='1164'>
<a name='1165'>
      <font color=#447700>! Send updraft liquid water back<a name='1166'></font>
      if ( is_convective) then<a name='1167'>
         do k = kts,kte-1<a name='1168'>
            qlup_temfx(i,k) = qlUPD(i,k)<a name='1169'>
         end do<a name='1170'>
      else<a name='1171'>
         qlup_temfx(i,1) = qcx(i,1)<a name='1172'>
         do k = kts+1,kte-1<a name='1173'>
            qlup_temfx(i,k) = qcx(i,k-1)<a name='1174'>
         end do<a name='1175'>
      end if<a name='1176'>
      qlup_temfx(i,kte) = qcx(i,kte)<a name='1177'>
<a name='1178'>
   end do  <font color=#447700>! Main (i) loop<a name='1179'></font>
<a name='1180'>
   end subroutine temf2d<a name='1181'>
<font color=#447700>!<a name='1182'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='1183'></font>
<font color=#447700>!<a name='1184'></font>
<A NAME='THLQT2THQVQC'><A href='../../html_code/phys/module_bl_temf.F.html#THLQT2THQVQC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1185'>
   <font color=#993300>subroutine </font><font color=#cc0000>thlqt2thqvqc</font>(thetal,qt,theta,qv,qc,p,piex,kbot,ktop,ep2,Lv,Cp) <A href='../../call_to/THLQT2THQVQC.html' TARGET='index'>1</A>,<A href='../../call_from/THLQT2THQVQC.html' TARGET='index'>1</A><a name='1186'>
<a name='1187'>
<font color=#447700>!  Calculates theta, qv, qc from thetal, qt.<a name='1188'></font>
<font color=#447700>!  Originally from RAMS (subroutine satadjst) by way of Hongli Jiang.<a name='1189'></font>
<a name='1190'>
   implicit none<a name='1191'>
   integer, intent(in   ) :: kbot, ktop<a name='1192'>
   real,    dimension( kbot:ktop ), intent(in   ) :: thetal, qt<a name='1193'>
   real,    dimension( kbot:ktop ), intent(  out) :: theta, qv, qc<a name='1194'>
   real,    dimension( kbot:ktop ), intent(in   ) :: p, piex<a name='1195'>
   real,    intent(in   ) :: ep2, Lv, Cp<a name='1196'>
<font color=#447700>!<a name='1197'></font>
<font color=#447700>!  Local variables<a name='1198'></font>
   integer :: k, iterate<a name='1199'>
   real :: T1, Tt<a name='1200'>
   real, dimension( kbot:ktop) :: rst<a name='1201'>
   real, dimension( kbot:ktop) :: Tair, rc, rt, rv<a name='1202'>
<font color=#447700>!<a name='1203'></font>
   do k = kbot,ktop<a name='1204'>
      T1 = thetal(k) * piex(k)   <font color=#447700>! First guess T is just thetal converted to T<a name='1205'></font>
      Tair(k) = T1<a name='1206'>
      rt(k) = qt(k) / (1. - qt(k))<a name='1207'>
<a name='1208'>
      do iterate = 1,20<a name='1209'>
         rst(k) = <A href='../../html_code/phys/module_bl_temf.F.html#RSAT'>rsat</A><A href='../../html_code/phys/module_bl_temf.F.html#THLQT2THQVQC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSAT_4">(p(k),Tair(k),ep2)<a name='1210'>
         rc(k) = max(rt(k) - rst(k), 0.)<a name='1211'>
         Tt = 0.7*Tair(k) + 0.3*T1 * (1.+Lv*rc(k) / (Cp*max(Tair(k),253.)))<a name='1212'>
         if ( abs(Tt - Tair(k)) &lt; 0.001) GOTO 100<a name='1213'>
         Tair(k) = Tt<a name='1214'>
      end do<a name='1215'>
100   continue<a name='1216'>
      rv(k) = rt(k) - rc(k)<a name='1217'>
      qv(k) = rv(k) / (1. + rv(k))<a name='1218'>
      qc(k) = rc(k) / (1. + rc(k))<a name='1219'>
      theta(k) = Tair(k) / piex(k)<a name='1220'>
   end do <font color=#447700>! k loop<a name='1221'></font>
   return<a name='1222'>
   end subroutine thlqt2thqvqc<a name='1223'>
<font color=#447700>!<a name='1224'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='1225'></font>
<font color=#447700>!<a name='1226'></font>
<A NAME='FINDHCT_TE'><A href='../../html_code/phys/module_bl_temf.F.html#FINDHCT_TE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1227'>
   <font color=#993300>subroutine </font><font color=#cc0000>findhct_te</font>( thetavenv,thetaparin,qpar, &amp;,<A href='../../call_from/FINDHCT_TE.html' TARGET='index'>1</A><a name='1228'>
                          rpar,hdidx,paridx,zm,hct,hctidx,p,piex,ep2,kbot,ktop)<a name='1229'>
<a name='1230'>
<font color=#447700>! Calculates the cloud top height (limit of convection) for the<a name='1231'></font>
<font color=#447700>! updraft properties.  hct is the level at which a parcel lifted<a name='1232'></font>
<font color=#447700>! at the moist adiabatic rate where it is saturated and at the dry<a name='1233'></font>
<font color=#447700>! adiabatic rate otherwise, first has thetav cooler than the environment.<a name='1234'></font>
<font color=#447700>! Loops start at LCL (paridx).<a name='1235'></font>
<a name='1236'>
   implicit none<a name='1237'>
   integer, intent(in) :: kbot, ktop<a name='1238'>
   integer, intent(in) :: paridx, hdidx<a name='1239'>
   real, intent(in)    :: ep2<a name='1240'>
   real, dimension( kbot:ktop), intent(in) :: thetavenv<a name='1241'>
   real, dimension( kbot:ktop), intent(in) :: thetaparin<a name='1242'>
   real, dimension( kbot:ktop), intent(in) :: qpar, rpar, zm, p, piex<a name='1243'>
   real, intent(out)    :: hct<a name='1244'>
   integer, intent(out) :: hctidx<a name='1245'>
<font color=#447700>! Local variables<a name='1246'></font>
   integer k<a name='1247'>
   real, dimension( kbot:ktop) :: thetapar, thetavpar, qlpar, Tpar, rsatpar<a name='1248'>
   real, dimension( kbot:ktop) :: qsatpar<a name='1249'>
   real :: gammas, TparC<a name='1250'>
<a name='1251'>
   thetapar(paridx) = thetaparin(paridx)<a name='1252'>
   Tpar(paridx) = thetapar(paridx) * piex(paridx)<a name='1253'>
   hctidx = ktop   <font color=#447700>! In case hct not found<a name='1254'></font>
   do k = paridx+1,ktop<a name='1255'>
      <font color=#447700>! Find saturation mixing ratio at parcel temperature<a name='1256'></font>
      rsatpar(k) = <A href='../../html_code/phys/module_bl_temf.F.html#RSAT'>rsat</A><A href='../../html_code/phys/module_bl_temf.F.html#FINDHCT_TE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSAT_5">(p(k-1),Tpar(k-1),ep2)<a name='1257'>
      qsatpar(k) = rsatpar(k) / (1. + rsatpar(k))<a name='1258'>
<a name='1259'>
      <font color=#447700>! When parcel is unsaturated, its temperature changes <a name='1260'></font>
      <font color=#447700>! at dry adiabatic rate (in other words, theta is constant).<a name='1261'></font>
      if (rpar(k) &lt;= rsatpar(k)) then<a name='1262'>
         thetapar(k) = thetapar(k-1)<a name='1263'>
         Tpar(k) = thetapar(k) * piex(k)<a name='1264'>
         thetavpar(k) = thetapar(k) * (1.+0.608*qpar(k))<a name='1265'>
      else<a name='1266'>
         <font color=#447700>! When parcel is saturated, its temperature changes at<a name='1267'></font>
         <font color=#447700>! moist adiabatic rate<a name='1268'></font>
         <font color=#447700>! Calculate moist adiabatic lapse rate according to Gill A4.12<a name='1269'></font>
         <font color=#447700>! Requires T in deg.C<a name='1270'></font>
         TparC = Tpar(k-1) - 273.15<a name='1271'>
         gammas = 6.4 - 0.12 * TparC + 2.5e-5 * TparC**3. + (-2.4 + 1.e-3 * (TparC-5.)**2.) * (1. - p(k-1)/100000.)<a name='1272'>
         Tpar(k) = Tpar(k-1) - gammas/1000. * (zm(k)-zm(k-1))<a name='1273'>
         thetapar(k) = Tpar(k) / piex(k)<a name='1274'>
         qlpar(k) = qpar(k) - qsatpar(k)  <font color=#447700>! Liquid water in parcel<a name='1275'></font>
         thetavpar(k) = thetapar(k) * (1. + 0.608 * qsatpar(k) - qlpar(k))<a name='1276'>
      end if<a name='1277'>
      if (thetavenv(k) &gt;= thetavpar(k)) then<a name='1278'>
         hctidx = k<a name='1279'>
         goto 1000<a name='1280'>
      end if<a name='1281'>
   end do<a name='1282'>
1000  hct = zm(hctidx)<a name='1283'>
   return<a name='1284'>
   end subroutine findhct_te<a name='1285'>
<font color=#447700>!<a name='1286'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='1287'></font>
<font color=#447700>!<a name='1288'></font>
<A NAME='RSAT'><A href='../../html_code/phys/module_bl_temf.F.html#RSAT' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1289'>
   real <font color=#993300>function </font><font color=#cc0000>rsat</font>(p,T,ep2) <A href='../../call_to/RSAT.html' TARGET='index'>5</A><a name='1290'>
<a name='1291'>
<font color=#447700>!  Calculates the saturation mixing ratio with respect to liquid water<a name='1292'></font>
<font color=#447700>!  Arguments are pressure (Pa) and absolute temperature (K)<a name='1293'></font>
<font color=#447700>!  Uses the formula from the ARM intercomparison setup.<a name='1294'></font>
<font color=#447700>!  Converted from Matlab by WA 7/28/08<a name='1295'></font>
<a name='1296'>
implicit none<a name='1297'>
real p, T, ep2<a name='1298'>
real temp, x<a name='1299'>
real, parameter :: c0 = 0.6105851e+3<a name='1300'>
real, parameter :: c1 = 0.4440316e+2<a name='1301'>
real, parameter :: c2 = 0.1430341e+1<a name='1302'>
real, parameter :: c3 = 0.2641412e-1<a name='1303'>
real, parameter :: c4 = 0.2995057e-3<a name='1304'>
real, parameter :: c5 = 0.2031998e-5<a name='1305'>
real, parameter :: c6 = 0.6936113e-8<a name='1306'>
real, parameter :: c7 = 0.2564861e-11<a name='1307'>
real, parameter :: c8 = -0.3704404e-13<a name='1308'>
<a name='1309'>
temp = T - 273.15<a name='1310'>
<a name='1311'>
x =c0+temp*(c1+temp*(c2+temp*(c3+temp*(c4+temp*(c5+temp*(c6+temp*(c7+temp*c8)))))))<a name='1312'>
rsat = ep2*x/(p-x)<a name='1313'>
<a name='1314'>
return<a name='1315'>
end function rsat<a name='1316'>
<font color=#447700>!<a name='1317'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='1318'></font>
<font color=#447700>!<a name='1319'></font>
<A NAME='SOLVE_IMPLICIT_TEMF'><A href='../../html_code/phys/module_bl_temf.F.html#SOLVE_IMPLICIT_TEMF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1320'>
   <font color=#993300>subroutine </font><font color=#cc0000>solve_implicit_temf</font>(Khlf,psi_n,srf_flux,dzm,dzt,kbot,ktop,dt,print_flag) <A href='../../call_to/SOLVE_IMPLICIT_TEMF.html' TARGET='index'>5</A>,<A href='../../call_from/SOLVE_IMPLICIT_TEMF.html' TARGET='index'>1</A><a name='1321'>
<a name='1322'>
<font color=#447700>!  Implicit solution of vertical diffusion for conserved variable<a name='1323'></font>
<font color=#447700>!  psi given diffusivity Khlf on turbulence levels,<a name='1324'></font>
<font color=#447700>!  and surface flux srf_flux.<a name='1325'></font>
<font color=#447700>!  dzm is delta_z of mass levels, dzt is delta_z of turbulence levels.<a name='1326'></font>
<font color=#447700>!  dt is timestep (s).<a name='1327'></font>
<a name='1328'>
   implicit none<a name='1329'>
   integer  :: kbot, ktop<a name='1330'>
   logical  :: print_flag<a name='1331'>
   real :: srf_flux, dt<a name='1332'>
   real,    dimension( kbot:ktop ), intent(in   ) :: Khlf<a name='1333'>
   real,    dimension( kbot:ktop ), intent(in   ) :: dzm, dzt<a name='1334'>
   real,    dimension( kbot:ktop ), intent(inout) :: psi_n<a name='1335'>
<font color=#447700>!<a name='1336'></font>
<font color=#447700>!  Local variables<a name='1337'></font>
   integer :: k<a name='1338'>
   real,    dimension( kbot:ktop ) :: AU, BU, CU, YU<a name='1339'>
<font color=#447700>!<a name='1340'></font>
   AU(kbot) = Khlf(kbot) / (dzm(kbot)*dzt(kbot))<a name='1341'>
   BU(kbot) = -1.0/dt - Khlf(kbot+1)/(dzm(kbot+1)*dzt(kbot+1))<a name='1342'>
   CU(kbot) = Khlf(kbot+1)/(dzm(kbot)*dzt(kbot+1))<a name='1343'>
   YU(kbot) = -psi_n(kbot)/dt - srf_flux/dzm(kbot)<a name='1344'>
<a name='1345'>
   do k = kbot+1,ktop-1<a name='1346'>
      <font color=#447700>! Subdiagonal (A) vector<a name='1347'></font>
      AU(k) = Khlf(k) / (dzm(k) * dzt(k))<a name='1348'>
      <font color=#447700>! Main diagonal (B) vector<a name='1349'></font>
      BU(k) = -1.0/dt - (Khlf(k)/dzt(k) + Khlf(k+1)/dzt(k+1)) / dzm(k)<a name='1350'>
      <font color=#447700>! Superdiagonal (C) vector<a name='1351'></font>
      CU(k) = Khlf(k+1) / (dzm(k)*dzt(k+1))<a name='1352'>
      <font color=#447700>! Result vector<a name='1353'></font>
      YU(k) = -psi_n(k)/dt<a name='1354'>
   end do <font color=#447700>! k loop<a name='1355'></font>
<a name='1356'>
   AU(ktop) = 0.<a name='1357'>
   BU(ktop) = -1.0 / dt<a name='1358'>
   YU(ktop) = -psi_n(ktop) / dt<a name='1359'>
<a name='1360'>
   <font color=#447700>! Compute result with tridiagonal routine<a name='1361'></font>
   psi_n = <A href='../../html_code/phys/module_bl_temf.F.html#TRID'>trid</A><A href='../../html_code/phys/module_bl_temf.F.html#SOLVE_IMPLICIT_TEMF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRID_1">(AU,BU,CU,YU,kbot,ktop)<a name='1362'>
<a name='1363'>
   return<a name='1364'>
   end subroutine solve_implicit_temf<a name='1365'>
<font color=#447700>!<a name='1366'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='1367'></font>
<font color=#447700>!<a name='1368'></font>
<A NAME='TRID'><A href='../../html_code/phys/module_bl_temf.F.html#TRID' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1369'>
   <font color=#993300>function </font><font color=#cc0000>trid</font>(a,b,c,r,kbot,ktop) <A href='../../call_to/TRID.html' TARGET='index'>1</A><a name='1370'>
<a name='1371'>
<font color=#447700>!  Solves tridiagonal linear system.<a name='1372'></font>
<font color=#447700>!  Inputs are subdiagonal vector a, main diagonal b, superdiagonal c,<a name='1373'></font>
<font color=#447700>!  result r, column top and bottom indices kbot and ktop.<a name='1374'></font>
<font color=#447700>!  Originally from Numerical Recipes section 2.4.<a name='1375'></font>
<a name='1376'>
   implicit none<a name='1377'>
   real,    dimension( kbot:ktop ) :: trid<a name='1378'>
   integer  :: kbot, ktop<a name='1379'>
   real,    dimension( kbot:ktop ), intent(in   ) :: a, b, c, r<a name='1380'>
<font color=#447700>!<a name='1381'></font>
<font color=#447700>!  Local variables<a name='1382'></font>
   integer :: k<a name='1383'>
   real    :: bet<a name='1384'>
   real,    dimension( kbot:ktop ) :: gam, u<a name='1385'>
<font color=#447700>!<a name='1386'></font>
   bet = b(kbot)<a name='1387'>
   u(kbot) = r(kbot) / bet<a name='1388'>
<a name='1389'>
   do k = kbot+1,ktop<a name='1390'>
      gam(k) = c(k-1) / bet<a name='1391'>
      bet = b(k) - a(k)*gam(k)<a name='1392'>
      u(k) = (r(k) - a(k)*u(k-1)) / bet<a name='1393'>
   end do<a name='1394'>
<a name='1395'>
   do k = ktop-1,kbot,-1<a name='1396'>
      u(k) = u(k) - gam(k+1)*u(k+1)<a name='1397'>
   end do<a name='1398'>
<a name='1399'>
   trid = u<a name='1400'>
<a name='1401'>
   return<a name='1402'>
   end function trid<a name='1403'>
<font color=#447700>!<a name='1404'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='1405'></font>
<font color=#447700>!<a name='1406'></font>
<A NAME='TEMFINIT'><A href='../../html_code/phys/module_bl_temf.F.html#TEMFINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1407'>
   <font color=#993300>subroutine </font><font color=#cc0000>temfinit</font>(rublten,rvblten,rthblten,rqvblten,                      &amp; <A href='../../call_to/TEMFINIT.html' TARGET='index'>1</A><a name='1408'>
                      rqcblten,rqiblten,p_qi,p_first_scalar,                   &amp;<a name='1409'>
                      restart, allowed_to_read,                                &amp;<a name='1410'>
                      te_temf, cf3d_temf,                                     &amp;<a name='1411'>
                      ids, ide, jds, jde, kds, kde,                            &amp;<a name='1412'>
                      ims, ime, jms, jme, kms, kme,                            &amp;<a name='1413'>
                      its, ite, jts, jte, kts, kte                 )<a name='1414'>
<font color=#447700>!-------------------------------------------------------------------<a name='1415'></font>
   implicit none<a name='1416'>
<font color=#447700>!-------------------------------------------------------------------<a name='1417'></font>
<font color=#447700>!<a name='1418'></font>
   logical , intent(in)          :: restart, allowed_to_read<a name='1419'>
   integer , intent(in)          ::  ids, ide, jds, jde, kds, kde,             &amp;<a name='1420'>
                                     ims, ime, jms, jme, kms, kme,             &amp;<a name='1421'>
                                     its, ite, jts, jte, kts, kte<a name='1422'>
   integer , intent(in)          ::  p_qi,p_first_scalar<a name='1423'>
   real , dimension( ims:ime , kms:kme , jms:jme ), intent(out) ::             &amp;<a name='1424'>
                                                                      rublten, &amp;<a name='1425'>
                                                                      rvblten, &amp;<a name='1426'>
                                                                     rthblten, &amp;<a name='1427'>
                                                                     rqvblten, &amp;<a name='1428'>
                                                                     rqcblten, &amp;<a name='1429'>
                                                                     rqiblten, &amp;<a name='1430'>
                                                                     te_temf, &amp;<a name='1431'>
                                                                     cf3d_temf<a name='1432'>
<font color=#447700>! Local variables<a name='1433'></font>
   integer :: i, j, k, itf, jtf, ktf<a name='1434'>
   real, parameter :: TEmin = 1e-3<a name='1435'>
<font color=#447700>!<a name='1436'></font>
   jtf = min0(jte,jde-1)<a name='1437'>
   ktf = min0(kte,kde-1)<a name='1438'>
   itf = min0(ite,ide-1)<a name='1439'>
<font color=#447700>!<a name='1440'></font>
   if(.not.restart)then<a name='1441'>
     do j = jts,jtf<a name='1442'>
     do k = kts,ktf<a name='1443'>
     do i = its,itf<a name='1444'>
        rublten(i,k,j) = 0.<a name='1445'>
        rvblten(i,k,j) = 0.<a name='1446'>
        rthblten(i,k,j) = 0.<a name='1447'>
        rqvblten(i,k,j) = 0.<a name='1448'>
        rqcblten(i,k,j) = 0.<a name='1449'>
        te_temf(i,k,j) = TEmin<a name='1450'>
        cf3d_temf(i,k,j) = 0.<a name='1451'>
     enddo<a name='1452'>
     enddo<a name='1453'>
     enddo<a name='1454'>
   endif<a name='1455'>
<font color=#447700>!<a name='1456'></font>
   if (p_qi .ge. p_first_scalar .and. .not.restart) then<a name='1457'>
      do j = jts,jtf<a name='1458'>
      do k = kts,ktf<a name='1459'>
      do i = its,itf<a name='1460'>
         rqiblten(i,k,j) = 0.<a name='1461'>
      enddo<a name='1462'>
      enddo<a name='1463'>
      enddo<a name='1464'>
   endif<a name='1465'>
<font color=#447700>!<a name='1466'></font>
   end subroutine temfinit<a name='1467'>
<font color=#447700>!-------------------------------------------------------------------<a name='1468'></font>
end module module_bl_temf<a name='1469'>
</pre></body></html>