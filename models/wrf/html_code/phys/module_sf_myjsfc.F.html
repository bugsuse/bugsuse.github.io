<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!----------------------------------------------------------------------<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_SF_MYJSFC'><A href='../../html_code/phys/module_sf_myjsfc.F.html#MODULE_SF_MYJSFC' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
      <font color=#993300>MODULE </font><font color=#cc0000>MODULE_SF_MYJSFC</font> <A href='../../call_to/MODULE_SF_MYJSFC.html' TARGET='index'>4</A><a name='5'>
<font color=#447700>!<a name='6'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='7'></font>
<font color=#447700>!<a name='8'></font>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/phys/module_sf_myjsfc.F.html#module_sf_myjsfc.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_93"><a name='9'>
#ifdef DM_PARALLEL<a name='10'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>MODULE_DM</A><A href='../../html_code/phys/module_sf_myjsfc.F.html#module_sf_myjsfc.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_163">, ONLY : WRF_DM_MAXVAL<a name='11'>
#endif<a name='12'>
<font color=#447700>!<a name='13'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='14'></font>
<font color=#447700>!<a name='15'></font>
<font color=#447700>! REFERENCES:  Janjic (2002), NCEP Office Note 437<a name='16'></font>
<font color=#447700>!<a name='17'></font>
<font color=#447700>! ABSTRACT:<a name='18'></font>
<font color=#447700>!     MYJSFC GENERATES THE SURFACE EXCHANGE COEFFICIENTS FOR VERTICAL<a name='19'></font>
<font color=#447700>!     TURBULENT EXCHANGE BASED UPON MONIN_OBUKHOV THEORY WITH<a name='20'></font>
<font color=#447700>!     VARIOUS REFINEMENTS.<a name='21'></font>
<font color=#447700>!<a name='22'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='23'></font>
<font color=#447700>!<a name='24'></font>
      INTEGER :: ITRMX=5 <font color=#447700>! Iteration count for sfc layer computations<a name='25'></font>
<font color=#447700>!<a name='26'></font>
      REAL,PARAMETER :: VKARMAN=0.4<a name='27'>
      REAL,PARAMETER :: CAPA=R_D/CP,ELOCP=2.72E6/CP,RCAP=1./CAPA<a name='28'>
      REAL,PARAMETER :: GOCP02=G/CP*2.,GOCP10=G/CP*10.<a name='29'>
<font color=#447700>!      REAL,PARAMETER :: EPSU2=1.E-4,EPSUST=0.07,EPSZT=1.E-5<a name='30'></font>
<font color=#447700>!	ECMWF sets lower limit on ln(Z0h)=-20 --&gt; EPSZT=2.e-9<a name='31'></font>
      REAL,PARAMETER :: EPSU2=1.E-6,EPSUST=1.e-9,EPSZT=1.E-28<a name='32'>
      REAL,PARAMETER :: A2S=17.2693882,A3S=273.16,A4S=35.86<a name='33'>
      REAL,PARAMETER :: SEAFC=0.98,PQ0SEA=PQ0*SEAFC<a name='34'>
      REAL,PARAMETER :: BETA=1./273.,EXCML=0.0001,EXCMS=0.0001  &amp;<a name='35'>
     &amp;                 ,GLKBR=10.,GLKBS=30.,PI=3.1415926               &amp;<a name='36'>
     &amp;                 ,QVISC=2.1E-5,RIC=0.505,SMALL=0.35              &amp;<a name='37'>
     &amp;                 ,SQPR=0.84,SQSC=0.84,SQVISC=258.2,TVISC=2.1E-5  &amp;<a name='38'>
     &amp;                 ,USTC=0.7,USTR=0.225,VISC=1.5E-5,FH=1.01        &amp;<a name='39'>
     &amp;                 ,WWST=1.2,ZTFC=1.,TOPOFAC=9.0e-6<a name='40'>
<font color=#447700>!<a name='41'></font>
      REAL,PARAMETER :: BTG=BETA*G,CZIV=SMALL*GLKBS                    &amp;<a name='42'>
     &amp;                 ,GRRS=GLKBR/GLKBS                               &amp;<a name='43'>
     &amp;                 ,RTVISC=1./TVISC,RVISC=1./VISC                  &amp;<a name='44'>
     &amp;                 ,ZQRZT=SQSC/SQPR                                &amp;<a name='45'>
     &amp;                 ,FZQ1=RTVISC*QVISC*ZQRZT                        &amp;<a name='46'>
     &amp;                 ,FZQ2=RTVISC*QVISC*ZQRZT                        &amp;<a name='47'>
     &amp;                 ,FZT1=RVISC *TVISC*SQPR                         &amp;<a name='48'>
     &amp;                 ,FZT2=CZIV*GRRS*TVISC*SQPR                      &amp;<a name='49'>
     &amp;                 ,FZU1=CZIV*VISC                                 &amp;<a name='50'>
     &amp;                 ,PIHF=0.5*PI                                    &amp;<a name='51'>
     &amp;                 ,RQVISC=1./QVISC                                &amp;<a name='52'>
     &amp;                 ,USTFC=0.018/G                                  &amp;<a name='53'>
     &amp;                 ,WWST2=WWST*WWST<a name='54'>
<font color=#447700>!<a name='55'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='56'></font>
      INTEGER, PARAMETER :: KZTM=10001,KZTM2=KZTM-2<a name='57'>
<font color=#447700>!<a name='58'></font>
      REAL :: DZETA1,DZETA2,FH01,FH02,ZTMAX1,ZTMAX2,ZTMIN1,ZTMIN2<a name='59'>
<font color=#447700>!<a name='60'></font>
      REAL,DIMENSION(KZTM) :: PSIH1,PSIH2,PSIM1,PSIM2<a name='61'>
<font color=#447700>!<a name='62'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='63'></font>
<font color=#447700>!<a name='64'></font>
CONTAINS<a name='65'>
<font color=#447700>!<a name='66'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='67'></font>
<A NAME='MYJSFC'><A href='../../html_code/phys/module_sf_myjsfc.F.html#MYJSFC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='68'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>MYJSFC</font>(ITIMESTEP,HT,DZ                                &amp; <A href='../../call_to/MYJSFC.html' TARGET='index'>3</A>,<A href='../../call_from/MYJSFC.html' TARGET='index'>1</A><a name='69'>
     &amp;                 ,PMID,PINT,TH,T,QV,QC,U,V,Q2                    &amp;<a name='70'>
     &amp;                 ,TSK,QSFC,THZ0,QZ0,UZ0,VZ0                      &amp;<a name='71'>
     &amp;                 ,LOWLYR,XLAND,IVGTYP,ISURBAN,IZ0TLND            &amp;<a name='72'>
     &amp;                 ,USTAR,ZNT,Z0BASE,PBLH,MAVAIL,RMOL              &amp;<a name='73'>
     &amp;                 ,AKHS,AKMS                                      &amp;<a name='74'>
     &amp;                 ,RIB                                            &amp;<a name='75'>
     &amp;                 ,CHS,CHS2,CQS2,HFX,QFX,FLX_LH,FLHC,FLQC         &amp;<a name='76'>
     &amp;                 ,QGH,CPM,CT                                     &amp;<a name='77'>
     &amp;                 ,U10,V10,T02,TH02,TSHLTR,TH10,Q02,QSHLTR,Q10,PSHLTR          &amp;<a name='78'>
     &amp;                 ,P1000mb                                        &amp;<a name='79'>
     &amp;                 ,IDS,IDE,JDS,JDE,KDS,KDE                        &amp;<a name='80'>
     &amp;                 ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='81'>
     &amp;                 ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='82'>
<font color=#447700>!----------------------------------------------------------------------<a name='83'></font>
<font color=#447700>!<a name='84'></font>
      IMPLICIT NONE<a name='85'>
<font color=#447700>!<a name='86'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='87'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='88'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='89'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='90'>
<font color=#447700>!<a name='91'></font>
      INTEGER,INTENT(IN) :: ITIMESTEP<a name='92'>
<font color=#447700>!<a name='93'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: LOWLYR<a name='94'>
<font color=#447700>!<a name='95'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: HT,MAVAIL,TSK      &amp;<a name='96'>
     &amp;                                             ,XLAND,Z0BASE<a name='97'>
<font color=#447700>!<a name='98'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: DZ         &amp;<a name='99'>
     &amp;                                                     ,PMID,PINT  &amp;<a name='100'>
     &amp;                                                     ,Q2,QC,QV   &amp;<a name='101'>
     &amp;                                                     ,T,TH       &amp;<a name='102'>
     &amp;                                                     ,U,V<a name='103'>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: IVGTYP<a name='104'>
      INTEGER,                           INTENT(IN) :: ISURBAN<a name='105'>
      INTEGER,                           INTENT(IN) :: IZ0TLND<a name='106'>
<font color=#447700>!<a name='107'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: FLX_LH,HFX,PSHLTR &amp;<a name='108'>
     &amp;                                              ,QFX,Q10,QSHLTR    &amp;<a name='109'>
     &amp;                                              ,TH10,TSHLTR,T02   &amp;<a name='110'>
     &amp;                                              ,U10,V10,TH02,Q02<a name='111'>
<font color=#447700>!<a name='112'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: AKHS,AKMS       &amp;<a name='113'>
     &amp;                                                ,PBLH,QSFC<a name='114'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT)   :: RIB<a name='115'>
<font color=#447700>!<a name='116'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: QZ0,RMOL,THZ0   &amp;<a name='117'>
     &amp;                                                ,USTAR,UZ0,VZ0   &amp;<a name='118'>
     &amp;                                                ,ZNT<a name='119'>
<font color=#447700>!<a name='120'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: CHS,CHS2,CQS2     &amp;<a name='121'>
     &amp;                                              ,CPM,CT,FLHC,FLQC  &amp;<a name='122'>
     &amp;                                              ,QGH<a name='123'>
<font color=#447700>!<a name='124'></font>
      REAL,INTENT(IN) :: P1000mb<a name='125'>
<font color=#447700>!----------------------------------------------------------------------<a name='126'></font>
<font color=#447700>!***<a name='127'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='128'></font>
<font color=#447700>!***<a name='129'></font>
      INTEGER :: I,J,K,KFLIP,LMH,LPBL,NTSD<a name='130'>
<font color=#447700>!<a name='131'></font>
      REAL :: A,APESFC,B,BTGX,CWMLOW                                   &amp;<a name='132'>
     &amp;       ,DQDT,DTDIF,DTDT,DUDT,DVDT                                &amp;<a name='133'>
     &amp;       ,FIS                                                      &amp;<a name='134'>
     &amp;       ,P02P,P10P,PLOW,PSFC,PTOP,QLOW,QS02,QS10                  &amp;<a name='135'>
     &amp;       ,RAPA,RAPA02,RAPA10,RATIOMX,RDZ,SEAMASK,SM                &amp;<a name='136'>
     &amp;       ,T02P,T10P,TEM,TH02P,TH10P,THLOW,THELOW,THM               &amp;<a name='137'>
     &amp;       ,TLOW,TZ0,ULOW,VLOW,ZSL<a name='138'>
<font color=#447700>!<a name='139'></font>
      REAL,DIMENSION(KTS:KTE) :: CWMK,PK,Q2K,QK,THEK,THK,TK,UK,VK<a name='140'>
<font color=#447700>!<a name='141'></font>
      REAL,DIMENSION(KTS:KTE-1) :: EL,ELM<a name='142'>
<font color=#447700>!<a name='143'></font>
      REAL,DIMENSION(KTS:KTE+1) :: ZHK<a name='144'>
<font color=#447700>!<a name='145'></font>
      REAL,DIMENSION(ITS:ITE,JTS:JTE) :: THSK<a name='146'>
<font color=#447700>!<a name='147'></font>
      REAL,DIMENSION(ITS:ITE,KTS:KTE+1,JTS:JTE) :: ZINT<a name='148'>
<font color=#447700>!<a name='149'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='150'></font>
<font color=#447700>!**********************************************************************<a name='151'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='152'></font>
<font color=#447700>!<a name='153'></font>
<font color=#447700>!***  MAKE PREPARATIONS<a name='154'></font>
<font color=#447700>!<a name='155'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='156'></font>
      DO J=JTS,JTE<a name='157'>
      DO K=KTS,KTE+1<a name='158'>
      DO I=ITS,ITE<a name='159'>
        ZINT(I,K,J)=0.<a name='160'>
      ENDDO<a name='161'>
      ENDDO<a name='162'>
      ENDDO<a name='163'>
<font color=#447700>!<a name='164'></font>
      DO J=JTS,JTE<a name='165'>
      DO I=ITS,ITE<a name='166'>
        ZINT(I,KTE+1,J)=HT(I,J)     <font color=#447700>! Z at bottom of lowest sigma layer<a name='167'></font>
        PBLH(I,J)=-1.<a name='168'>
<font color=#447700>!<a name='169'></font>
<font color=#447700>!!!!!!!!!<a name='170'></font>
<font color=#447700>!!!!!! UNCOMMENT THESE LINES IF USING ETA COORDINATES<a name='171'></font>
<font color=#447700>!!!!!!!!!<a name='172'></font>
<font color=#447700>!!!!!!  ZINT(I,KTE+1,J)=1.E-4       ! Z of bottom of lowest eta layer<a name='173'></font>
<font color=#447700>!!!!!!  ZHK(KTE+1)=1.E-4            ! Z of bottom of lowest eta layer<a name='174'></font>
<font color=#447700>!<a name='175'></font>
      ENDDO<a name='176'>
      ENDDO<a name='177'>
<font color=#447700>!<a name='178'></font>
      DO J=JTS,JTE<a name='179'>
      DO K=KTE,KTS,-1<a name='180'>
        KFLIP=KTE+1-K<a name='181'>
        DO I=ITS,ITE<a name='182'>
          ZINT(I,K,J)=ZINT(I,K+1,J)+DZ(I,KFLIP,J)<a name='183'>
        ENDDO<a name='184'>
      ENDDO<a name='185'>
      ENDDO<a name='186'>
<font color=#447700>!<a name='187'></font>
      NTSD=ITIMESTEP<a name='188'>
<font color=#447700>!<a name='189'></font>
#if ( NMM_CORE == 1 )<a name='190'>
     if(NTSD+1.eq.1) then<a name='191'>
#else<a name='192'>
     IF(NTSD==1)THEN<a name='193'>
#endif<a name='194'>
<font color=#447700>!tgs       IF(NTSD==1)THEN<a name='195'></font>
        DO J=JTS,JTE<a name='196'>
        DO I=ITS,ITE<a name='197'>
          USTAR(I,J)=0.1<a name='198'>
          FIS=HT(I,J)*G<a name='199'>
          SM=XLAND(I,J)-1.<a name='200'>
<font color=#447700>!!!       Z0(I,J)=SM*Z0SEA+(1.-SM)*(Z0(I,J)*Z0MAX+FIS*FCM+Z0LAND)<a name='201'></font>
<font color=#447700>!!!       ZNT(I,J)=SM*Z0SEA+(1.-SM)*(ZNT(I,J)*Z0MAX+FIS*FCM+Z0LAND)<a name='202'></font>
        ENDDO<a name='203'>
        ENDDO<a name='204'>
      ENDIF<a name='205'>
<font color=#447700>!<a name='206'></font>
<font color=#447700>!!!!  IF(NTSD==1)THEN<a name='207'></font>
        DO J=JTS,JTE<a name='208'>
        DO I=ITS,ITE<a name='209'>
          CT(I,J)=0.<a name='210'>
        ENDDO<a name='211'>
        ENDDO<a name='212'>
<font color=#447700>!!!!  ENDIF<a name='213'></font>
<font color=#447700>!<a name='214'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='215'></font>
        setup_integration:  DO J=JTS,JTE<a name='216'>
<font color=#447700>!----------------------------------------------------------------------<a name='217'></font>
<font color=#447700>!<a name='218'></font>
        DO I=ITS,ITE<a name='219'>
<font color=#447700>!<a name='220'></font>
<font color=#447700>!***  LOWEST LAYER ABOVE GROUND MUST BE FLIPPED<a name='221'></font>
<font color=#447700>!<a name='222'></font>
          LMH=KTE-LOWLYR(I,J)+1<a name='223'>
<font color=#447700>!<a name='224'></font>
          PTOP=PINT(I,KTE+1,J)      <font color=#447700>! KTE+1=KME<a name='225'></font>
          PSFC=PINT(I,LOWLYR(I,J),J)<a name='226'>
<font color=#447700>! Define THSK here (for first timestep mostly)<a name='227'></font>
<font color=#447700>!          THSK(I,J)=TSK(I,J)/(PSFC*1.E-5)**CAPA<a name='228'></font>
          THSK(I,J)=TSK(I,J)/(PSFC/P1000mb)**CAPA<a name='229'>
<font color=#447700>!<a name='230'></font>
<font color=#447700>!***  CONVERT LAND MASK (1 FOR SEA; 0 FOR LAND)<a name='231'></font>
<font color=#447700>!<a name='232'></font>
          SEAMASK=XLAND(I,J)-1.<a name='233'>
<font color=#447700>!<a name='234'></font>
<font color=#447700>!***  FILL 1-D VERTICAL ARRAYS<a name='235'></font>
<font color=#447700>!***  AND FLIP DIRECTION SINCE MYJ SCHEME<a name='236'></font>
<font color=#447700>!***  COUNTS DOWNWARD FROM THE DOMAIN'S TOP<a name='237'></font>
<font color=#447700>!<a name='238'></font>
          DO K=KTE,KTS,-1<a name='239'>
            KFLIP=KTE+1-K<a name='240'>
            THK(K)=TH(I,KFLIP,J)<a name='241'>
            TK(K)=T(I,KFLIP,J)<a name='242'>
            RATIOMX=QV(I,KFLIP,J)<a name='243'>
            QK(K)=RATIOMX/(1.+RATIOMX)<a name='244'>
            PK(K)=PMID(I,KFLIP,J)<a name='245'>
            CWMK(K)=QC(I,KFLIP,J)<a name='246'>
            THEK(K)=(CWMK(K)*(-ELOCP/TK(K))+1.)*THK(K)<a name='247'>
            Q2K(K)=2.*Q2(I,KFLIP,J)<a name='248'>
<font color=#447700>!<a name='249'></font>
<font color=#447700>!***  COMPUTE THE HEIGHTS OF THE LAYER INTERFACES<a name='250'></font>
<font color=#447700>!<a name='251'></font>
            ZHK(K)=ZINT(I,K,J)<a name='252'>
<font color=#447700>!<a name='253'></font>
          ENDDO<a name='254'>
          ZHK(KTE+1)=HT(I,J)          <font color=#447700>! Z at bottom of lowest sigma layer<a name='255'></font>
<font color=#447700>!<a name='256'></font>
          DO K=KTE,KTS,-1<a name='257'>
            KFLIP=KTE+1-K<a name='258'>
            UK(K)=U(I,KFLIP,J)<a name='259'>
            VK(K)=V(I,KFLIP,J)<a name='260'>
          ENDDO<a name='261'>
<font color=#447700>!<a name='262'></font>
<font color=#447700>!***  FIND THE HEIGHT OF THE PBL<a name='263'></font>
<font color=#447700>!<a name='264'></font>
          LPBL=LMH<a name='265'>
          DO K=LMH-1,1,-1<a name='266'>
            IF(Q2K(K)&lt;=EPSQ2*FH) THEN<a name='267'>
              LPBL=K<a name='268'>
              GO TO 110<a name='269'>
            ENDIF<a name='270'>
          ENDDO<a name='271'>
<font color=#447700>!<a name='272'></font>
          LPBL=1<a name='273'>
<font color=#447700>!<a name='274'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='275'></font>
<font color=#447700>!--------------THE HEIGHT OF THE PBL------------------------------------<a name='276'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='277'></font>
<font color=#447700>!<a name='278'></font>
 110      PBLH(I,J)=ZHK(LPBL)-ZHK(LMH+1)<a name='279'>
<font color=#447700>!<a name='280'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='281'></font>
<font color=#447700>!***<a name='282'></font>
<font color=#447700>!***  FIND THE SURFACE EXCHANGE COEFFICIENTS<a name='283'></font>
<font color=#447700>!***<a name='284'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='285'></font>
          PLOW=PK(LMH)<a name='286'>
          TLOW=TK(LMH)<a name='287'>
          THLOW=THK(LMH)<a name='288'>
          THELOW=THEK(LMH)<a name='289'>
          QLOW=QK(LMH)<a name='290'>
          CWMLOW=CWMK(LMH)<a name='291'>
          ULOW=UK(LMH)<a name='292'>
          VLOW=VK(LMH)<a name='293'>
          ZSL=(ZHK(LMH)-ZHK(LMH+1))*0.5<a name='294'>
<font color=#447700>!          APESFC=(PSFC*1.E-5)**CAPA<a name='295'></font>
          APESFC=(PSFC/P1000mb)**CAPA<a name='296'>
<font color=#447700>!tgs - in ARW THZ0 is not initialized when MYJSFC is called first time<a name='297'></font>
#if ( NMM_CORE == 1 )<a name='298'>
     if(NTSD+1.eq.1) then<a name='299'>
#else<a name='300'>
     IF(NTSD==1)THEN<a name='301'>
#endif<a name='302'>
<font color=#447700>!       if(itimestep.le.1) then<a name='303'></font>
          TZ0=TSK(I,J)<a name='304'>
       else<a name='305'>
          TZ0=THZ0(I,J)*APESFC<a name='306'>
       endif<a name='307'>
<font color=#447700>!<a name='308'></font>
          CALL <A href='../../html_code/phys/module_sf_qnsesfc.F.html#SFCDIF'>SFCDIF</A><A href='../../html_code/phys/module_sf_myjsfc.F.html#MYJSFC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIF_1">(NTSD,SEAMASK,THSK(I,J),QSFC(I,J),PSFC            &amp;<a name='309'>
     &amp;               ,UZ0(I,J),VZ0(I,J),TZ0,TSK(I,J),THZ0(I,J),QZ0(I,J)         &amp;<a name='310'>
     &amp;               ,USTAR(I,J),ZNT(I,J),Z0BASE(I,J),CT(I,J),RMOL(I,J) &amp;<a name='311'>
     &amp;               ,AKMS(I,J),AKHS(I,J),RIB(I,J),PBLH(I,J),MAVAIL(I,J) &amp;<a name='312'>
     &amp;               ,IVGTYP(I,J),ISURBAN,IZ0TLND                      &amp;<a name='313'>
     &amp;               ,CHS(I,J),CHS2(I,J),CQS2(I,J)                     &amp;<a name='314'>
     &amp;               ,HFX(I,J),QFX(I,J),FLX_LH(I,J)                    &amp;<a name='315'>
     &amp;               ,FLHC(I,J),FLQC(I,J),QGH(I,J),CPM(I,J)            &amp;<a name='316'>
     &amp;               ,ULOW,VLOW,TLOW,THLOW,THELOW,QLOW,CWMLOW          &amp;<a name='317'>
     &amp;               ,ZSL,PLOW                                         &amp;<a name='318'>
     &amp;               ,U10(I,J),V10(I,J),TSHLTR(I,J),TH10(I,J)          &amp;<a name='319'>
     &amp;               ,QSHLTR(I,J),Q10(I,J),PSHLTR(I,J)                 &amp;<a name='320'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                          &amp;<a name='321'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                          &amp;<a name='322'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE,i,j,ZHK(LMH+1))<a name='323'>
<font color=#447700>!<a name='324'></font>
<font color=#447700>!***  REMOVE SUPERATURATION AT 2M AND 10M<a name='325'></font>
<font color=#447700>!<a name='326'></font>
          RAPA=APESFC<a name='327'>
          TH02P=TSHLTR(I,J)<a name='328'>
          TH10P=TH10(I,J)<a name='329'>
          TH02(I,J)=TSHLTR(I,J)<a name='330'>
<font color=#447700>!<a name='331'></font>
          RAPA02=RAPA-GOCP02/TH02P<a name='332'>
          RAPA10=RAPA-GOCP10/TH10P<a name='333'>
<font color=#447700>!<a name='334'></font>
          T02P=TH02P*RAPA02<a name='335'>
          T10P=TH10P*RAPA10<a name='336'>
<font color=#447700>! 1 may 06 tgs         T02(I,J) = T02P<a name='337'></font>
          T02(I,J) = TH02(I,J)*APESFC<a name='338'>
<font color=#447700>!<a name='339'></font>
<font color=#447700>!          P02P=(RAPA02**RCAP)*1.E5<a name='340'></font>
<font color=#447700>!          P10P=(RAPA10**RCAP)*1.E5<a name='341'></font>
          P02P=(RAPA02**RCAP)*P1000mb<a name='342'>
          P10P=(RAPA10**RCAP)*P1000mb<a name='343'>
<font color=#447700>!<a name='344'></font>
          QS02=PQ0/P02P*EXP(A2*(T02P-A3)/(T02P-A4))<a name='345'>
          QS10=PQ0/P10P*EXP(A2*(T10P-A3)/(T10P-A4))<a name='346'>
<font color=#447700>!<a name='347'></font>
          IF(QSHLTR(I,J)&gt;QS02)QSHLTR(I,J)=QS02<a name='348'>
          IF(Q10   (I,J)&gt;QS10)Q10   (I,J)=QS10<a name='349'>
          Q02(I,J)=QSHLTR(I,J)/(1.-QSHLTR(I,J))<a name='350'>
<font color=#447700>!----------------------------------------------------------------------<a name='351'></font>
<font color=#447700>!<a name='352'></font>
        ENDDO<a name='353'>
<font color=#447700>!<a name='354'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='355'></font>
      ENDDO setup_integration<a name='356'>
<font color=#447700>!----------------------------------------------------------------------<a name='357'></font>
<a name='358'>
      END SUBROUTINE MYJSFC<a name='359'>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='360'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='361'></font>
<A NAME='SFCDIF'><A href='../../html_code/phys/module_sf_myjsfc.F.html#SFCDIF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='362'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFCDIF</font>(NTSD,SEAMASK,THS,QS,PSFC                       &amp; <A href='../../call_to/SFCDIF.html' TARGET='index'>2</A><a name='363'>
     &amp;                 ,UZ0,VZ0,TZ0,TSK,THZ0,QZ0                       &amp;<a name='364'>
     &amp;                 ,USTAR,Z0,Z0BASE,CT,RLMO,AKMS,AKHS,RIB,PBLH,WETM &amp;<a name='365'>
     &amp;                 ,VEGTYP,ISURBAN,IZ0TLND                         &amp;<a name='366'>
     &amp;                 ,CHS,CHS2,CQS2,HFX,QFX,FLX_LH,FLHC,FLQC,QGH,CPM &amp;<a name='367'>
     &amp;                 ,ULOW,VLOW,TLOW,THLOW,THELOW,QLOW,CWMLOW        &amp;<a name='368'>
     &amp;                 ,ZSL,PLOW                                       &amp;<a name='369'>
     &amp;                 ,U10,V10,TH02,TH10,Q02,Q10,PSHLTR               &amp;<a name='370'>
     &amp;                 ,IDS,IDE,JDS,JDE,KDS,KDE                        &amp;<a name='371'>
     &amp;                 ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='372'>
     &amp;                 ,ITS,ITE,JTS,JTE,KTS,KTE,i,j,ZSFC)<a name='373'>
<font color=#447700>!     ****************************************************************<a name='374'></font>
<font color=#447700>!     *                                                              *<a name='375'></font>
<font color=#447700>!     *                       SURFACE LAYER                          *<a name='376'></font>
<font color=#447700>!     *                                                              *<a name='377'></font>
<font color=#447700>!     ****************************************************************<a name='378'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='379'></font>
<font color=#447700>!<a name='380'></font>
      IMPLICIT NONE<a name='381'>
<font color=#447700>!<a name='382'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='383'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='384'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='385'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE,i,j<a name='386'>
<font color=#447700>!<a name='387'></font>
      INTEGER,INTENT(IN) :: NTSD<a name='388'>
<font color=#447700>!<a name='389'></font>
      REAL,INTENT(IN) :: CWMLOW,PBLH,PLOW,QLOW,PSFC,SEAMASK,ZSFC       &amp;<a name='390'>
     &amp;                  ,THELOW,THLOW,THS,TSK,TLOW,TZ0,ULOW,VLOW,WETM,ZSL  &amp;<a name='391'>
     &amp;                  ,Z0BASE<a name='392'>
      INTEGER, INTENT(IN) :: VEGTYP, ISURBAN, IZ0TLND<a name='393'>
<font color=#447700>!<a name='394'></font>
      REAL,INTENT(OUT) :: CHS,CHS2,CPM,CQS2,CT,FLHC,FLQC,FLX_LH,HFX    &amp;<a name='395'>
     &amp;                   ,PSHLTR,Q02,Q10,QFX,QGH,RIB,RLMO              &amp;<a name='396'>
     &amp;                   ,TH02,TH10,U10,V10<a name='397'>
<font color=#447700>!<a name='398'></font>
      REAL,INTENT(INOUT) :: AKHS,AKMS,QZ0,THZ0,USTAR,UZ0,VZ0,Z0,QS<a name='399'>
<font color=#447700>!----------------------------------------------------------------------<a name='400'></font>
<font color=#447700>!***<a name='401'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='402'></font>
<font color=#447700>!***<a name='403'></font>
      INTEGER :: ITR,K<a name='404'>
<font color=#447700>!<a name='405'></font>
      REAL :: A,B,BTGH,BTGX,CXCHL,CXCHS,CZETMAX,DTHV,DU2,ELFC,FCT      &amp;<a name='406'>
     &amp;       ,HLFLX,HSFLX,HV,PSH02,PSH10,PSHZ,PSHZL,PSM10,PSMZ,PSMZL   &amp;<a name='407'>
     &amp;       ,RDZ,RDZT,RLMA,RLMN,RLMP                                  &amp;<a name='408'>
     &amp;       ,RLOGT,RLOGU,RWGH,RZ,RZST,RZSU,SIMH,SIMM,TEM,THM          &amp;<a name='409'>
     &amp;       ,UMFLX,USTARK,VMFLX,WGHT,WGHTT,WGHTQ,WSTAR2               &amp;<a name='410'>
     &amp;       ,X,XLT,XLT4,XLU,XLU4,XT,XT4,XU,XU4,ZETALT,ZETALU          &amp;<a name='411'>
     &amp;       ,ZETAT,ZETAU,ZQ,ZSLT,ZSLU,ZT,ZU,TOPOTERM,ZZIL<a name='412'>
      REAL :: CZIL,ZILFC<a name='413'>
<font color=#447700>!<a name='414'></font>
<font color=#447700>!***  DIAGNOSTICS<a name='415'></font>
<font color=#447700>!<a name='416'></font>
      REAL :: AKHS02,AKHS10,AKMS02,AKMS10,EKMS10,QSAT10,QSAT2          &amp;<a name='417'>
     &amp;       ,RLNT02,RLNT10,RLNU10,SIMH02,SIMH10,SIMM10,T02,T10        &amp;<a name='418'>
     &amp;       ,TERM1,RLOW,U10E,V10E,WSTAR,XLT02,XLT024,XLT10            &amp;<a name='419'>
     &amp;       ,XLT104,XLU10,XLU104,XU10,XU104,ZT02,ZT10,ZTAT02,ZTAT10   &amp;<a name='420'>
     &amp;       ,ZTAU,ZTAU10,ZU10,ZUUZ<a name='421'>
<font color=#447700>!----------------------------------------------------------------------<a name='422'></font>
<font color=#447700>!**********************************************************************<a name='423'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='424'></font>
      RDZ=1./ZSL<a name='425'>
      CXCHL=EXCML*RDZ<a name='426'>
      CXCHS=EXCMS*RDZ<a name='427'>
<font color=#447700>!<a name='428'></font>
      BTGX=G/THLOW<a name='429'>
      ELFC=VKARMAN*BTGX<a name='430'>
<font color=#447700>!<a name='431'></font>
      IF(PBLH&gt;1000.)THEN<a name='432'>
        BTGH=BTGX*PBLH<a name='433'>
      ELSE<a name='434'>
        BTGH=BTGX*1000.<a name='435'>
      ENDIF<a name='436'>
<font color=#447700>!<a name='437'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='438'></font>
<font color=#447700>!<a name='439'></font>
<font color=#447700>!***  SEA POINTS<a name='440'></font>
<font color=#447700>!<a name='441'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='442'></font>
<font color=#447700>!<a name='443'></font>
      IF(SEAMASK&gt;0.5)THEN<a name='444'>
<font color=#447700>!<a name='445'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='446'></font>
        DO ITR=1,ITRMX<a name='447'>
<font color=#447700>!----------------------------------------------------------------------<a name='448'></font>
          Z0=MAX(USTFC*USTAR*USTAR,1.59E-5)<a name='449'>
<font color=#447700>!<a name='450'></font>
<font color=#447700>!***  VISCOUS SUBLAYER, JANJIC MWR 1994<a name='451'></font>
<font color=#447700>!<a name='452'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='453'></font>
          IF(USTAR&lt;USTC)THEN<a name='454'>
<font color=#447700>!----------------------------------------------------------------------<a name='455'></font>
<font color=#447700>!<a name='456'></font>
            IF(USTAR&lt;USTR)THEN<a name='457'>
<font color=#447700>!<a name='458'></font>
#if ( NMM_CORE == 1 )<a name='459'>
     if(NTSD+1.eq.1) then<a name='460'>
#else<a name='461'>
     IF(NTSD==1)THEN<a name='462'>
#endif<a name='463'>
<font color=#447700>!tgs              IF(NTSD==1)THEN<a name='464'></font>
                AKMS=CXCHS<a name='465'>
                AKHS=CXCHS<a name='466'>
                QS=QLOW<a name='467'>
              ENDIF<a name='468'>
<font color=#447700>!<a name='469'></font>
              ZU=FZU1*SQRT(SQRT(Z0*USTAR*RVISC))/USTAR<a name='470'>
              WGHT=AKMS*ZU*RVISC<a name='471'>
              RWGH=WGHT/(WGHT+1.)<a name='472'>
              UZ0=(ULOW*RWGH+UZ0)*0.5<a name='473'>
              VZ0=(VLOW*RWGH+VZ0)*0.5<a name='474'>
<font color=#447700>!<a name='475'></font>
              ZT=FZT1*ZU<a name='476'>
              ZQ=FZQ1*ZT<a name='477'>
              WGHTT=AKHS*ZT*RTVISC<a name='478'>
              WGHTQ=AKHS*ZQ*RQVISC<a name='479'>
<font color=#447700>!<a name='480'></font>
#if ( NMM_CORE == 1 )<a name='481'>
     if(NTSD+1&gt;1) then<a name='482'>
#else<a name='483'>
     IF(NTSD&gt;1)THEN<a name='484'>
#endif<a name='485'>
<font color=#447700>!tgs              IF(NTSD&gt;1)THEN<a name='486'></font>
                THZ0=((WGHTT*THLOW+THS)/(WGHTT+1.)+THZ0)*0.5<a name='487'>
                QZ0=((WGHTQ*QLOW+QS)/(WGHTQ+1.)+QZ0)*0.5<a name='488'>
              ELSE<a name='489'>
                THZ0=(WGHTT*THLOW+THS)/(WGHTT+1.)<a name='490'>
                QZ0=(WGHTQ*QLOW+QS)/(WGHTQ+1.)<a name='491'>
              ENDIF<a name='492'>
<font color=#447700>!<a name='493'></font>
            ENDIF<a name='494'>
<font color=#447700>!<a name='495'></font>
            IF(USTAR&gt;=USTR.AND.USTAR&lt;USTC)THEN<a name='496'>
              ZU=Z0<a name='497'>
              UZ0=0.<a name='498'>
              VZ0=0.<a name='499'>
<font color=#447700>!<a name='500'></font>
              ZT=FZT2*SQRT(SQRT(Z0*USTAR*RVISC))/USTAR<a name='501'>
              ZQ=FZQ2*ZT<a name='502'>
              WGHTT=AKHS*ZT*RTVISC<a name='503'>
              WGHTQ=AKHS*ZQ*RQVISC<a name='504'>
<font color=#447700>!<a name='505'></font>
#if ( NMM_CORE == 1 )<a name='506'>
     if(NTSD+1&gt;1) then<a name='507'>
#else<a name='508'>
     IF(NTSD&gt;1)THEN<a name='509'>
#endif<a name='510'>
<a name='511'>
<font color=#447700>!tgs              IF(NTSD&gt;1)THEN<a name='512'></font>
                THZ0=((WGHTT*THLOW+THS)/(WGHTT+1.)+THZ0)*0.5<a name='513'>
                QZ0=((WGHTQ*QLOW+QS)/(WGHTQ+1.)+QZ0)*0.5<a name='514'>
              ELSE<a name='515'>
                THZ0=(WGHTT*THLOW+THS)/(WGHTT+1.)<a name='516'>
                QZ0=(WGHTQ*QLOW+QS)/(WGHTQ+1.)<a name='517'>
              ENDIF<a name='518'>
<font color=#447700>!<a name='519'></font>
            ENDIF<a name='520'>
<font color=#447700>!----------------------------------------------------------------------<a name='521'></font>
          ELSE<a name='522'>
<font color=#447700>!----------------------------------------------------------------------<a name='523'></font>
            ZU=Z0<a name='524'>
            UZ0=0.<a name='525'>
            VZ0=0.<a name='526'>
<font color=#447700>!<a name='527'></font>
            ZT=Z0<a name='528'>
            THZ0=THS<a name='529'>
<font color=#447700>!<a name='530'></font>
            ZQ=Z0<a name='531'>
            QZ0=QS<a name='532'>
<font color=#447700>!----------------------------------------------------------------------<a name='533'></font>
          ENDIF<a name='534'>
<font color=#447700>!----------------------------------------------------------------------<a name='535'></font>
          TEM=(TLOW+TZ0)*0.5<a name='536'>
          THM=(THELOW+THZ0)*0.5<a name='537'>
<font color=#447700>!<a name='538'></font>
          A=THM*P608<a name='539'>
          B=(ELOCP/TEM-1.-P608)*THM<a name='540'>
<font color=#447700>!<a name='541'></font>
          DTHV=((THELOW-THZ0)*((QLOW+QZ0+CWMLOW)*(0.5*P608)+1.)        &amp;<a name='542'>
     &amp;        +(QLOW-QZ0+CWMLOW)*A+CWMLOW*B)<a name='543'>
<font color=#447700>!<a name='544'></font>
          DU2=MAX((ULOW-UZ0)**2+(VLOW-VZ0)**2,EPSU2)<a name='545'>
          RIB=BTGX*DTHV*ZSL/DU2<a name='546'>
<font color=#447700>!----------------------------------------------------------------------<a name='547'></font>
<font color=#447700>!         IF(RIB&gt;=RIC)THEN<a name='548'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='549'></font>
<font color=#447700>!           AKMS=MAX( VISC*RDZ,CXCHS)<a name='550'></font>
<font color=#447700>!           AKHS=MAX(TVISC*RDZ,CXCHS)<a name='551'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='552'></font>
<font color=#447700>!         ELSE  !  turbulent branch<a name='553'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='554'></font>
            ZSLU=ZSL+ZU<a name='555'>
            ZSLT=ZSL+ZT<a name='556'>
<font color=#447700>!<a name='557'></font>
            RZSU=ZSLU/ZU<a name='558'>
            RZST=ZSLT/ZT<a name='559'>
<font color=#447700>!<a name='560'></font>
            RLOGU=LOG(RZSU)<a name='561'>
            RLOGT=LOG(RZST)<a name='562'>
<font color=#447700>!<a name='563'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='564'></font>
<font color=#447700>!***  1./MONIN-OBUKHOV LENGTH<a name='565'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='566'></font>
<font color=#447700>!<a name='567'></font>
            RLMO=ELFC*AKHS*DTHV/USTAR**3<a name='568'>
<font color=#447700>!<a name='569'></font>
            ZETALU=ZSLU*RLMO<a name='570'>
            ZETALT=ZSLT*RLMO<a name='571'>
            ZETAU=ZU*RLMO<a name='572'>
            ZETAT=ZT*RLMO<a name='573'>
<font color=#447700>!<a name='574'></font>
            ZETALU=MIN(MAX(ZETALU,ZTMIN1),ZTMAX1)<a name='575'>
            ZETALT=MIN(MAX(ZETALT,ZTMIN1),ZTMAX1)<a name='576'>
            ZETAU=MIN(MAX(ZETAU,ZTMIN1/RZSU),ZTMAX1/RZSU)<a name='577'>
            ZETAT=MIN(MAX(ZETAT,ZTMIN1/RZST),ZTMAX1/RZST)<a name='578'>
<font color=#447700>!<a name='579'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='580'></font>
<font color=#447700>!***   WATER FUNCTIONS<a name='581'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='582'></font>
<font color=#447700>!<a name='583'></font>
            RZ=(ZETAU-ZTMIN1)/DZETA1<a name='584'>
            K=INT(RZ)<a name='585'>
            RDZT=RZ-REAL(K)<a name='586'>
            K=MIN(K,KZTM2)<a name='587'>
            K=MAX(K,0)<a name='588'>
            PSMZ=(PSIM1(K+2)-PSIM1(K+1))*RDZT+PSIM1(K+1)<a name='589'>
<font color=#447700>!<a name='590'></font>
            RZ=(ZETALU-ZTMIN1)/DZETA1<a name='591'>
            K=INT(RZ)<a name='592'>
            RDZT=RZ-REAL(K)<a name='593'>
            K=MIN(K,KZTM2)<a name='594'>
            K=MAX(K,0)<a name='595'>
            PSMZL=(PSIM1(K+2)-PSIM1(K+1))*RDZT+PSIM1(K+1)<a name='596'>
<font color=#447700>!<a name='597'></font>
            SIMM=PSMZL-PSMZ+RLOGU<a name='598'>
<font color=#447700>!<a name='599'></font>
            RZ=(ZETAT-ZTMIN1)/DZETA1<a name='600'>
            K=INT(RZ)<a name='601'>
            RDZT=RZ-REAL(K)<a name='602'>
            K=MIN(K,KZTM2)<a name='603'>
            K=MAX(K,0)<a name='604'>
            PSHZ=(PSIH1(K+2)-PSIH1(K+1))*RDZT+PSIH1(K+1)<a name='605'>
<font color=#447700>!<a name='606'></font>
            RZ=(ZETALT-ZTMIN1)/DZETA1<a name='607'>
            K=INT(RZ)<a name='608'>
            RDZT=RZ-REAL(K)<a name='609'>
            K=MIN(K,KZTM2)<a name='610'>
            K=MAX(K,0)<a name='611'>
            PSHZL=(PSIH1(K+2)-PSIH1(K+1))*RDZT+PSIH1(K+1)<a name='612'>
<font color=#447700>!<a name='613'></font>
            SIMH=(PSHZL-PSHZ+RLOGT)*FH01<a name='614'>
<a name='615'>
<font color=#447700>!----------------------------------------------------------------------<a name='616'></font>
            USTARK=USTAR*VKARMAN<a name='617'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!<a name='618'></font>
            AKMS=MAX(USTARK/SIMM,CXCHS)<a name='619'>
            AKHS=MAX(USTARK/SIMH,CXCHS)<a name='620'>
<font color=#447700>!<a name='621'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='622'></font>
<font color=#447700>!***  BELJAARS CORRECTION FOR USTAR<a name='623'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='624'></font>
<font color=#447700>!<a name='625'></font>
            IF(DTHV&lt;=0.)THEN                                           <font color=#447700>!zj<a name='626'></font>
              WSTAR2=WWST2*ABS(BTGH*AKHS*DTHV)**(2./3.)                <font color=#447700>!zj<a name='627'></font>
            ELSE                                                       <font color=#447700>!zj<a name='628'></font>
              WSTAR2=0.                                                <font color=#447700>!zj<a name='629'></font>
            ENDIF                                                      <font color=#447700>!zj<a name='630'></font>
            USTAR=MAX(SQRT(AKMS*SQRT(DU2+WSTAR2)),EPSUST)<a name='631'>
<font color=#447700>!<a name='632'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='633'></font>
<font color=#447700>!         ENDIF  !  End of turbulent branch<a name='634'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='635'></font>
<font color=#447700>!<a name='636'></font>
        ENDDO  <font color=#447700>!  End of the iteration loop over sea points<a name='637'></font>
<font color=#447700>!<a name='638'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='639'></font>
<font color=#447700>!<a name='640'></font>
<font color=#447700>!***  LAND POINTS<a name='641'></font>
<font color=#447700>!<a name='642'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='643'></font>
<font color=#447700>!<a name='644'></font>
      ELSE<a name='645'>
<font color=#447700>!<a name='646'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='647'></font>
        IF(NTSD==1)THEN<a name='648'>
          QS=QLOW<a name='649'>
        ENDIF<a name='650'>
<font color=#447700>!<a name='651'></font>
        ZU=Z0<a name='652'>
        UZ0=0.<a name='653'>
        VZ0=0.<a name='654'>
<font color=#447700>!<a name='655'></font>
        ZT=ZU*ZTFC<a name='656'>
        THZ0=THS<a name='657'>
<font color=#447700>!<a name='658'></font>
        ZQ=ZT<a name='659'>
        QZ0=QS<a name='660'>
<font color=#447700>!----------------------------------------------------------------------<a name='661'></font>
        TEM=(TLOW+TZ0)*0.5<a name='662'>
        THM=(THELOW+THZ0)*0.5<a name='663'>
<font color=#447700>!<a name='664'></font>
        A=THM*P608<a name='665'>
        B=(ELOCP/TEM-1.-P608)*THM<a name='666'>
<font color=#447700>!<a name='667'></font>
        DTHV=((THELOW-THZ0)*((QLOW+QZ0+CWMLOW)*(0.5*P608)+1.)          &amp;<a name='668'>
     &amp;        +(QLOW-QZ0+CWMLOW)*A+CWMLOW*B)<a name='669'>
<font color=#447700>!<a name='670'></font>
        DU2=MAX((ULOW-UZ0)**2+(VLOW-VZ0)**2,EPSU2)<a name='671'>
        RIB=BTGX*DTHV*ZSL/DU2<a name='672'>
<font color=#447700>!----------------------------------------------------------------------<a name='673'></font>
<font color=#447700>!       IF(RIB&gt;=RIC)THEN<a name='674'></font>
<font color=#447700>!         AKMS=MAX( VISC*RDZ,CXCHL)<a name='675'></font>
<font color=#447700>!         AKHS=MAX(TVISC*RDZ,CXCHL)<a name='676'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='677'></font>
<font color=#447700>!       ELSE  !  Turbulent branch<a name='678'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='679'></font>
          ZSLU=ZSL+ZU<a name='680'>
<font color=#447700>!<a name='681'></font>
          RZSU=ZSLU/ZU<a name='682'>
<font color=#447700>!<a name='683'></font>
          RLOGU=LOG(RZSU)<a name='684'>
<a name='685'>
          ZSLT=ZSL+ZU <font color=#447700>! u,v and t are at the same level<a name='686'></font>
<a name='687'>
<font color=#447700>!-- BSF on 10/19/2011: Added new IF-ELSE block but commented out until <a name='688'></font>
<font color=#447700>!   final matter is resolved.<a name='689'></font>
<font color=#447700>!BSF          IF ( (IZ0TLND==0) .or. (VEGTYP == ISURBAN) ) THEN<a name='690'></font>
<font color=#447700>!BSF             ! Just use the original CZIL value.<a name='691'></font>
<font color=#447700>!BSF             CZIL = 0.1<a name='692'></font>
<font color=#447700>!BSF          ELSE<a name='693'></font>
<font color=#447700>!BSF             ! Modify CZIL according to Chen &amp; Zhang, 2009<a name='694'></font>
<font color=#447700>!BSF             ! CZIL = 10 ** -0.40 H, ( where H = 10*Zo )<a name='695'></font>
<font color=#447700>!BSF             CZIL = 10.0 ** ( -0.40 * ( Z0 / 0.07 ) )<a name='696'></font>
<font color=#447700>!BSF          ENDIF<a name='697'></font>
          CZIL=0.1<a name='698'>
          ZILFC=-CZIL*VKARMAN*SQVISC<a name='699'>
          <a name='700'>
<font color=#447700>!----------------------------------------------------------------------<a name='701'></font>
<font color=#447700>!<a name='702'></font>
<font color=#447700>!mp   Topo modification of ZILFC term<a name='703'></font>
<font color=#447700>!	<a name='704'></font>
<font color=#447700>!         TOPOTERM=TOPOFAC*ZSFC**2.<a name='705'></font>
<font color=#447700>!         TOPOTERM=MAX(TOPOTERM,3.0)<a name='706'></font>
<font color=#447700>!<a name='707'></font>
<font color=#447700>!  RIB modification to ZILFC term<a name='708'></font>
<font color=#447700>!<a name='709'></font>
<font color=#447700>!         CZETMAX = 20.<a name='710'></font>
          CZETMAX = 10.<a name='711'>
<font color=#447700>! stable<a name='712'></font>
          IF(DTHV&gt;0.)THEN<a name='713'>
<font color=#447700>!            ZZIL=ZILFC*TOPOTERM<a name='714'></font>
            IF (RIB&lt;RIC) THEN<a name='715'>
              ZZIL=ZILFC*(1.0+(RIB/RIC)*(RIB/RIC)*CZETMAX)<a name='716'>
            ELSE<a name='717'>
              ZZIL=ZILFC*(1.0+CZETMAX)<a name='718'>
            ENDIF<a name='719'>
<font color=#447700>! unstable<a name='720'></font>
          ELSE<a name='721'>
            ZZIL=ZILFC<a name='722'>
          ENDIF<a name='723'>
<font color=#447700>!<a name='724'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='725'></font>
<font color=#447700>!<a name='726'></font>
          land_point_iteration: DO ITR=1,ITRMX<a name='727'>
<font color=#447700>!<a name='728'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='729'></font>
<font color=#447700>!***  ZILITINKEVITCH FIX FOR ZT<a name='730'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='731'></font>
<font color=#447700>!<a name='732'></font>
<font color=#447700>! oldform   ZT=MAX(EXP(ZZIL*SQRT(USTAR*ZU))*ZU,EPSZT)<a name='733'></font>
            ZT=MAX(EXP(ZZIL*SQRT(USTAR*Z0BASE))*Z0BASE,EPSZT)<a name='734'>
<font color=#447700>!<a name='735'></font>
            RZST=ZSLT/ZT<a name='736'>
            RLOGT=LOG(RZST)<a name='737'>
<font color=#447700>!<a name='738'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='739'></font>
<font color=#447700>!***  1./MONIN-OBUKHOV LENGTH-SCALE<a name='740'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='741'></font>
<font color=#447700>!<a name='742'></font>
            RLMO=ELFC*AKHS*DTHV/USTAR**3<a name='743'>
            ZETALU=ZSLU*RLMO<a name='744'>
            ZETALT=ZSLT*RLMO<a name='745'>
            ZETAU=ZU*RLMO<a name='746'>
            ZETAT=ZT*RLMO<a name='747'>
<font color=#447700>!<a name='748'></font>
            ZETALU=MIN(MAX(ZETALU,ZTMIN2),ZTMAX2)<a name='749'>
            ZETALT=MIN(MAX(ZETALT,ZTMIN2),ZTMAX2)<a name='750'>
            ZETAU=MIN(MAX(ZETAU,ZTMIN2/RZSU),ZTMAX2/RZSU)<a name='751'>
            ZETAT=MIN(MAX(ZETAT,ZTMIN2/RZST),ZTMAX2/RZST)<a name='752'>
<font color=#447700>!<a name='753'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='754'></font>
<font color=#447700>!***  LAND FUNCTIONS<a name='755'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='756'></font>
<font color=#447700>!<a name='757'></font>
            RZ=(ZETAU-ZTMIN2)/DZETA2<a name='758'>
            K=INT(RZ)<a name='759'>
            RDZT=RZ-REAL(K)<a name='760'>
            K=MIN(K,KZTM2)<a name='761'>
            K=MAX(K,0)<a name='762'>
            PSMZ=(PSIM2(K+2)-PSIM2(K+1))*RDZT+PSIM2(K+1)<a name='763'>
<font color=#447700>!<a name='764'></font>
            RZ=(ZETALU-ZTMIN2)/DZETA2<a name='765'>
            K=INT(RZ)<a name='766'>
            RDZT=RZ-REAL(K)<a name='767'>
            K=MIN(K,KZTM2)<a name='768'>
            K=MAX(K,0)<a name='769'>
            PSMZL=(PSIM2(K+2)-PSIM2(K+1))*RDZT+PSIM2(K+1)<a name='770'>
<font color=#447700>!<a name='771'></font>
            SIMM=PSMZL-PSMZ+RLOGU<a name='772'>
<font color=#447700>!<a name='773'></font>
            RZ=(ZETAT-ZTMIN2)/DZETA2<a name='774'>
            K=INT(RZ)<a name='775'>
            RDZT=RZ-REAL(K)<a name='776'>
            K=MIN(K,KZTM2)<a name='777'>
            K=MAX(K,0)<a name='778'>
            PSHZ=(PSIH2(K+2)-PSIH2(K+1))*RDZT+PSIH2(K+1)<a name='779'>
<font color=#447700>!<a name='780'></font>
            RZ=(ZETALT-ZTMIN2)/DZETA2<a name='781'>
            K=INT(RZ)<a name='782'>
            RDZT=RZ-REAL(K)<a name='783'>
            K=MIN(K,KZTM2)<a name='784'>
            K=MAX(K,0)<a name='785'>
            PSHZL=(PSIH2(K+2)-PSIH2(K+1))*RDZT+PSIH2(K+1)<a name='786'>
<font color=#447700>!<a name='787'></font>
            SIMH=(PSHZL-PSHZ+RLOGT)*FH02<a name='788'>
<font color=#447700>!----------------------------------------------------------------------<a name='789'></font>
            USTARK=USTAR*VKARMAN<a name='790'>
            AKMS=MAX(USTARK/SIMM,CXCHL)<a name='791'>
            AKHS=MAX(USTARK/SIMH,CXCHL)<a name='792'>
<font color=#447700>!<a name='793'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='794'></font>
<font color=#447700>!***  BELJAARS CORRECTION FOR USTAR<a name='795'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='796'></font>
<font color=#447700>!<a name='797'></font>
            IF(DTHV&lt;=0.)THEN                                           <font color=#447700>!zj<a name='798'></font>
              WSTAR2=WWST2*ABS(BTGH*AKHS*DTHV)**(2./3.)                <font color=#447700>!zj<a name='799'></font>
            ELSE                                                       <font color=#447700>!zj<a name='800'></font>
              WSTAR2=0.                                                <font color=#447700>!zj<a name='801'></font>
            ENDIF                                                      <font color=#447700>!zj<a name='802'></font>
<font color=#447700>!<a name='803'></font>
            USTAR=MAX(SQRT(AKMS*SQRT(DU2+WSTAR2)),EPSUST)<a name='804'>
<font color=#447700>!<a name='805'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='806'></font>
          ENDDO land_point_iteration<a name='807'>
<font color=#447700>!----------------------------------------------------------------------<a name='808'></font>
<font color=#447700>!<a name='809'></font>
<font color=#447700>!       ENDIF  !  End of turbulant branch over land<a name='810'></font>
<font color=#447700>!<a name='811'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='812'></font>
<font color=#447700>!<a name='813'></font>
      ENDIF  <font color=#447700>!  End of land/sea branch<a name='814'></font>
<font color=#447700>!<a name='815'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='816'></font>
<font color=#447700>!***  COUNTERGRADIENT FIX<a name='817'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='818'></font>
<font color=#447700>!<a name='819'></font>
<font color=#447700>!     HV=-AKHS*DTHV<a name='820'></font>
<font color=#447700>!     IF(HV&gt;0.)THEN<a name='821'></font>
<font color=#447700>!       FCT=-10.*(BTGX)**(-1./3.)<a name='822'></font>
<font color=#447700>!       CT=FCT*(HV/(PBLH*PBLH))**(2./3.)<a name='823'></font>
<font color=#447700>!     ELSE<a name='824'></font>
       CT=0.<a name='825'>
<font color=#447700>!     ENDIF<a name='826'></font>
<font color=#447700>!<a name='827'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='828'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='829'></font>
<font color=#447700>!***  THE FOLLOWING DIAGNOSTIC BLOCK PRODUCES 2-m and 10-m VALUES<a name='830'></font>
<font color=#447700>!***  FOR TEMPERATURE, MOISTURE, AND WINDS.  IT IS DONE HERE SINCE<a name='831'></font>
<font color=#447700>!***  THE VARIOUS QUANTITIES NEEDED FOR THE COMPUTATION ARE LOST<a name='832'></font>
<font color=#447700>!***  UPON EXIT FROM THE ROTUINE.<a name='833'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='834'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='835'></font>
<font color=#447700>!<a name='836'></font>
      WSTAR=SQRT(WSTAR2)/WWST<a name='837'>
<font color=#447700>!<a name='838'></font>
      UMFLX=AKMS*(ULOW -UZ0 )<a name='839'>
      VMFLX=AKMS*(VLOW -VZ0 )<a name='840'>
      HSFLX=AKHS*(THLOW-THZ0)<a name='841'>
      HLFLX=AKHS*(QLOW -QZ0 )<a name='842'>
<font color=#447700>!----------------------------------------------------------------------<a name='843'></font>
<font color=#447700>!     IF(RIB&gt;=RIC)THEN<a name='844'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='845'></font>
<font color=#447700>!       IF(SEAMASK&gt;0.5)THEN<a name='846'></font>
<font color=#447700>!         AKMS10=MAX( VISC/10.,CXCHS)<a name='847'></font>
<font color=#447700>!         AKHS02=MAX(TVISC/02.,CXCHS)<a name='848'></font>
<font color=#447700>!         AKHS10=MAX(TVISC/10.,CXCHS)<a name='849'></font>
<font color=#447700>!       ELSE<a name='850'></font>
<font color=#447700>!         AKMS10=MAX( VISC/10.,CXCHL)<a name='851'></font>
<font color=#447700>!         AKHS02=MAX(TVISC/02.,CXCHL)<a name='852'></font>
<font color=#447700>!         AKHS10=MAX(TVISC/10.,CXCHL)<a name='853'></font>
<font color=#447700>!       ENDIF<a name='854'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='855'></font>
<font color=#447700>!     ELSE<a name='856'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='857'></font>
        ZU10=ZU+10.<a name='858'>
        ZT02=ZT+02.<a name='859'>
        ZT10=ZT+10.<a name='860'>
<font color=#447700>!<a name='861'></font>
        RLNU10=LOG(ZU10/ZU)<a name='862'>
        RLNT02=LOG(ZT02/ZT)<a name='863'>
        RLNT10=LOG(ZT10/ZT)<a name='864'>
<font color=#447700>!<a name='865'></font>
        ZTAU10=ZU10*RLMO<a name='866'>
        ZTAT02=ZT02*RLMO<a name='867'>
        ZTAT10=ZT10*RLMO<a name='868'>
<font color=#447700>!<a name='869'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='870'></font>
<font color=#447700>!***  SEA<a name='871'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='872'></font>
<font color=#447700>!<a name='873'></font>
        IF(SEAMASK&gt;0.5)THEN<a name='874'>
<font color=#447700>!<a name='875'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='876'></font>
          ZTAU10=MIN(MAX(ZTAU10,ZTMIN1),ZTMAX1)<a name='877'>
          ZTAT02=MIN(MAX(ZTAT02,ZTMIN1),ZTMAX1)<a name='878'>
          ZTAT10=MIN(MAX(ZTAT10,ZTMIN1),ZTMAX1)<a name='879'>
<font color=#447700>!----------------------------------------------------------------------<a name='880'></font>
          RZ=(ZTAU10-ZTMIN1)/DZETA1<a name='881'>
          K=INT(RZ)<a name='882'>
          RDZT=RZ-REAL(K)<a name='883'>
          K=MIN(K,KZTM2)<a name='884'>
          K=MAX(K,0)<a name='885'>
          PSM10=(PSIM1(K+2)-PSIM1(K+1))*RDZT+PSIM1(K+1)<a name='886'>
<font color=#447700>!<a name='887'></font>
          SIMM10=PSM10-PSMZ+RLNU10<a name='888'>
<font color=#447700>!<a name='889'></font>
          RZ=(ZTAT02-ZTMIN1)/DZETA1<a name='890'>
          K=INT(RZ)<a name='891'>
          RDZT=RZ-REAL(K)<a name='892'>
          K=MIN(K,KZTM2)<a name='893'>
          K=MAX(K,0)<a name='894'>
          PSH02=(PSIH1(K+2)-PSIH1(K+1))*RDZT+PSIH1(K+1)<a name='895'>
<font color=#447700>!<a name='896'></font>
          SIMH02=(PSH02-PSHZ+RLNT02)*FH01<a name='897'>
<font color=#447700>!<a name='898'></font>
          RZ=(ZTAT10-ZTMIN1)/DZETA1<a name='899'>
          K=INT(RZ)<a name='900'>
          RDZT=RZ-REAL(K)<a name='901'>
          K=MIN(K,KZTM2)<a name='902'>
          K=MAX(K,0)<a name='903'>
          PSH10=(PSIH1(K+2)-PSIH1(K+1))*RDZT+PSIH1(K+1)<a name='904'>
<font color=#447700>!<a name='905'></font>
          SIMH10=(PSH10-PSHZ+RLNT10)*FH01<a name='906'>
<font color=#447700>!<a name='907'></font>
          AKMS10=MAX(USTARK/SIMM10,CXCHS)<a name='908'>
          AKHS02=MAX(USTARK/SIMH02,CXCHS)<a name='909'>
          AKHS10=MAX(USTARK/SIMH10,CXCHS)<a name='910'>
<font color=#447700>!<a name='911'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='912'></font>
<font color=#447700>!***  LAND<a name='913'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='914'></font>
<font color=#447700>!<a name='915'></font>
        ELSE<a name='916'>
<font color=#447700>!<a name='917'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='918'></font>
          ZTAU10=MIN(MAX(ZTAU10,ZTMIN2),ZTMAX2)<a name='919'>
          ZTAT02=MIN(MAX(ZTAT02,ZTMIN2),ZTMAX2)<a name='920'>
          ZTAT10=MIN(MAX(ZTAT10,ZTMIN2),ZTMAX2)<a name='921'>
<font color=#447700>!----------------------------------------------------------------------<a name='922'></font>
          RZ=(ZTAU10-ZTMIN2)/DZETA2<a name='923'>
          K=INT(RZ)<a name='924'>
          RDZT=RZ-REAL(K)<a name='925'>
          K=MIN(K,KZTM2)<a name='926'>
          K=MAX(K,0)<a name='927'>
          PSM10=(PSIM2(K+2)-PSIM2(K+1))*RDZT+PSIM2(K+1)<a name='928'>
<font color=#447700>!<a name='929'></font>
          SIMM10=PSM10-PSMZ+RLNU10<a name='930'>
<font color=#447700>!<a name='931'></font>
          RZ=(ZTAT02-ZTMIN2)/DZETA2<a name='932'>
          K=INT(RZ)<a name='933'>
          RDZT=RZ-REAL(K)<a name='934'>
          K=MIN(K,KZTM2)<a name='935'>
          K=MAX(K,0)<a name='936'>
          PSH02=(PSIH2(K+2)-PSIH2(K+1))*RDZT+PSIH2(K+1)<a name='937'>
<font color=#447700>!<a name='938'></font>
          SIMH02=(PSH02-PSHZ+RLNT02)*FH02<a name='939'>
<font color=#447700>!<a name='940'></font>
          RZ=(ZTAT10-ZTMIN2)/DZETA2<a name='941'>
          K=INT(RZ)<a name='942'>
          RDZT=RZ-REAL(K)<a name='943'>
          K=MIN(K,KZTM2)<a name='944'>
          K=MAX(K,0)<a name='945'>
          PSH10=(PSIH2(K+2)-PSIH2(K+1))*RDZT+PSIH2(K+1)<a name='946'>
<font color=#447700>!<a name='947'></font>
          SIMH10=(PSH10-PSHZ+RLNT10)*FH02<a name='948'>
<font color=#447700>!<a name='949'></font>
          AKMS10=MAX(USTARK/SIMM10,CXCHL)<a name='950'>
          AKHS02=MAX(USTARK/SIMH02,CXCHL)<a name='951'>
          AKHS10=MAX(USTARK/SIMH10,CXCHL)<a name='952'>
<font color=#447700>!----------------------------------------------------------------------<a name='953'></font>
        ENDIF<a name='954'>
<font color=#447700>!----------------------------------------------------------------------<a name='955'></font>
<font color=#447700>!     ENDIF<a name='956'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='957'></font>
      U10 =UMFLX/AKMS10+UZ0<a name='958'>
      V10 =VMFLX/AKMS10+VZ0<a name='959'>
      TH02=HSFLX/AKHS02+THZ0<a name='960'>
<font color=#447700>!<a name='961'></font>
<font color=#447700>!***  BE CERTAIN THAT THE 2-M THETA AND 10-M THETA ARE BRACKETED BY<a name='962'></font>
<font color=#447700>!***  THE VALUES OF THZ0 AND THLOW.<a name='963'></font>
<font color=#447700>!<a name='964'></font>
      IF(THLOW&gt;THZ0.AND.(TH02&lt;THZ0.OR.TH02&gt;THLOW).OR.                  &amp;<a name='965'>
         THLOW&lt;THZ0.AND.(TH02&gt;THZ0.OR.TH02&lt;THLOW))THEN<a name='966'>
           TH02=THZ0+2.*RDZ*(THLOW-THZ0)<a name='967'>
      ENDIF<a name='968'>
<font color=#447700>!<a name='969'></font>
      TH10=HSFLX/AKHS10+THZ0<a name='970'>
<font color=#447700>!<a name='971'></font>
      IF(THLOW&gt;THZ0.AND.(TH10&lt;THZ0.OR.TH10&gt;THLOW).OR.                  &amp;<a name='972'>
         THLOW&lt;THZ0.AND.(TH10&gt;THZ0.OR.TH10&lt;THLOW))THEN<a name='973'>
           TH10=THZ0+10.*RDZ*(THLOW-THZ0)<a name='974'>
      ENDIF<a name='975'>
<font color=#447700>!<a name='976'></font>
      Q02 =HLFLX/AKHS02+QZ0<a name='977'>
      Q10 =HLFLX/AKHS10+QZ0<a name='978'>
      TERM1=-0.068283/TLOW<a name='979'>
      PSHLTR=PSFC*EXP(TERM1)<a name='980'>
<font color=#447700>!<a name='981'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='982'></font>
<font color=#447700>!***  COMPUTE "EQUIVALENT" Z0 TO APPROXIMATE LOCAL SHELTER READINGS.<a name='983'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='984'></font>
<font color=#447700>!<a name='985'></font>
      U10E=U10<a name='986'>
      V10E=V10<a name='987'>
<font color=#447700>!<a name='988'></font>
      IF(SEAMASK&lt;0.5)THEN<a name='989'>
<a name='990'>
<font color=#447700>!1st        ZUUZ=MIN(0.5*ZU,0.1)<a name='991'></font>
<font color=#447700>!1st        ZU=MAX(0.1*ZU,ZUUZ)<a name='992'></font>
<font color=#447700>!tst        ZUUZ=amin1(ZU*0.50,0.3)<a name='993'></font>
<font color=#447700>!tst        ZU=amax1(ZU*0.3,ZUUZ)<a name='994'></font>
<a name='995'>
        ZUUZ=AMIN1(ZU*0.50,0.18)<a name='996'>
        ZU=AMAX1(ZU*0.35,ZUUZ)<a name='997'>
<font color=#447700>!<a name='998'></font>
        ZU10=ZU+10.<a name='999'>
        RZSU=ZU10/ZU<a name='1000'>
        RLNU10=LOG(RZSU)<a name='1001'>
<a name='1002'>
        ZETAU=ZU*RLMO<a name='1003'>
        ZTAU10=ZU10*RLMO<a name='1004'>
<a name='1005'>
        ZTAU10=MIN(MAX(ZTAU10,ZTMIN2),ZTMAX2)<a name='1006'>
        ZETAU=MIN(MAX(ZETAU,ZTMIN2/RZSU),ZTMAX2/RZSU)<a name='1007'>
<a name='1008'>
        RZ=(ZTAU10-ZTMIN2)/DZETA2<a name='1009'>
        K=INT(RZ)<a name='1010'>
        RDZT=RZ-REAL(K)<a name='1011'>
        K=MIN(K,KZTM2)<a name='1012'>
        K=MAX(K,0)<a name='1013'>
        PSM10=(PSIM2(K+2)-PSIM2(K+1))*RDZT+PSIM2(K+1)<a name='1014'>
        SIMM10=PSM10-PSMZ+RLNU10<a name='1015'>
        EKMS10=MAX(USTARK/SIMM10,CXCHL)<a name='1016'>
<a name='1017'>
        U10E=UMFLX/EKMS10+UZ0<a name='1018'>
        V10E=VMFLX/EKMS10+VZ0<a name='1019'>
<a name='1020'>
      ENDIF<a name='1021'>
<font color=#447700>!<a name='1022'></font>
      U10=U10E<a name='1023'>
      V10=V10E<a name='1024'>
<font color=#447700>!<a name='1025'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1026'></font>
<font color=#447700>!***  SET OTHER WRF DRIVER ARRAYS<a name='1027'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1028'></font>
<font color=#447700>!<a name='1029'></font>
      RLOW=PLOW/(R_D*TLOW)<a name='1030'>
      CHS=AKHS<a name='1031'>
      CHS2=AKHS02<a name='1032'>
      CQS2=AKHS02<a name='1033'>
      HFX=-RLOW*CP*HSFLX<a name='1034'>
      QFX=-RLOW*HLFLX*WETM<a name='1035'>
      FLX_LH=XLV*QFX<a name='1036'>
      FLHC=RLOW*CP*AKHS<a name='1037'>
      FLQC=RLOW*AKHS*WETM<a name='1038'>
<font color=#447700>!!!   QGH=PQ0/PSHLTR*EXP(A2S*(TSK-A3S)/(TSK-A4S))<a name='1039'></font>
      QGH=((1.-SEAMASK)*PQ0+SEAMASK*PQ0SEA)                            &amp;<a name='1040'>
     &amp;     /PLOW*EXP(A2S*(TLOW-A3S)/(TLOW-A4S))<a name='1041'>
      QGH=QGH/(1.-QGH)    <font color=#447700>!Convert to mixing ratio<a name='1042'></font>
      CPM=CP*(1.+0.8*QLOW)<a name='1043'>
<font color=#447700>!<a name='1044'></font>
<font color=#447700>!***  DO NOT COMPUTE QS OVER LAND POINTS HERE SINCE IT IS<a name='1045'></font>
<font color=#447700>!***  A PROGNOSTIC VARIABLE THERE.  IT IS OKAY TO USE IT<a name='1046'></font>
<font color=#447700>!***  AS A DIAGNOSTIC OVER WATER SINCE IT WILL CAUSE NO<a name='1047'></font>
<font color=#447700>!***  INTERFERENCE BEFORE BEING RECOMPUTED IN MYJPBL.<a name='1048'></font>
<font color=#447700>!<a name='1049'></font>
      IF(SEAMASK&gt;0.5)THEN<a name='1050'>
          QS=PQ0SEA/PSFC                                      &amp;<a name='1051'>
     &amp;         *EXP(A2S*(TSK-A3S)/(TSK-A4S)) <a name='1052'>
        QS=QS/(1.-QS)<a name='1053'>
      ENDIF<a name='1054'>
<font color=#447700>!----------------------------------------------------------------------<a name='1055'></font>
<font color=#447700>!<a name='1056'></font>
      END SUBROUTINE SFCDIF<a name='1057'>
<font color=#447700>!<a name='1058'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1059'></font>
<A NAME='MYJSFCINIT'><A href='../../html_code/phys/module_sf_myjsfc.F.html#MYJSFCINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1060'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>MYJSFCINIT</font>(LOWLYR,USTAR,Z0                            &amp; <A href='../../call_to/MYJSFCINIT.html' TARGET='index'>3</A>,<A href='../../call_from/MYJSFCINIT.html' TARGET='index'>1</A><a name='1061'>
     &amp;                     ,SEAMASK,XICE,IVGTYP,RESTART                &amp;<a name='1062'>
     &amp;                     ,ALLOWED_TO_READ                            &amp;<a name='1063'>
     &amp;                     ,IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='1064'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='1065'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1066'>
<font color=#447700>!----------------------------------------------------------------------<a name='1067'></font>
      IMPLICIT NONE<a name='1068'>
<font color=#447700>!----------------------------------------------------------------------<a name='1069'></font>
      LOGICAL,INTENT(IN) :: RESTART,ALLOWED_TO_READ<a name='1070'>
<font color=#447700>!<a name='1071'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='1072'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='1073'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='1074'>
<font color=#447700>!<a name='1075'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: IVGTYP<a name='1076'>
<font color=#447700>!<a name='1077'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: LOWLYR<a name='1078'>
<font color=#447700>!<a name='1079'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: SEAMASK,XICE<a name='1080'>
<font color=#447700>!<a name='1081'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: USTAR,Z0<a name='1082'>
<font color=#447700>!<a name='1083'></font>
      REAL,DIMENSION(0:30) :: VZ0TBL<a name='1084'>
      REAL,DIMENSION(0:30) :: VZ0TBL_24<a name='1085'>
<font color=#447700>!<a name='1086'></font>
      INTEGER :: I,IDUM,IRECV,J,JDUM,K,ITF,JTF,KTF,MAXGBL_IVGTYP       &amp;<a name='1087'>
     &amp;,          MAXLOC_IVGTYP,MPI_COMM_COMP<a name='1088'>
<font color=#447700>!<a name='1089'></font>
<font color=#447700>!     INTEGER :: MPI_INTEGER,MPI_MAX<a name='1090'></font>
<font color=#447700>!<a name='1091'></font>
      REAL :: SM,X,ZETA1,ZETA2,ZRNG1,ZRNG2<a name='1092'>
<font color=#447700>!<a name='1093'></font>
      REAL :: PIHF=3.1415926/2.,EPS=1.E-6<a name='1094'>
<font color=#447700>!----------------------------------------------------------------------<a name='1095'></font>
      VZ0TBL=                                                          &amp;<a name='1096'>
     &amp;  (/0.,                                                          &amp;<a name='1097'>
     &amp;    2.653,0.826,0.563,1.089,0.854,0.856,0.035,0.238,0.065,0.076  &amp;<a name='1098'>
     &amp;   ,0.011,0.035,0.011,0.000,0.000,0.000,0.000,0.000,0.000,0.000  &amp;<a name='1099'>
     &amp;   ,0.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000/)<a name='1100'>
<a name='1101'>
      VZ0TBL_24= (/0.,                                                 &amp;<a name='1102'>
     &amp;            1.00,  0.07,  0.07,  0.07,  0.07,  0.15,             &amp;<a name='1103'>
     &amp;            0.08,  0.03,  0.05,  0.86,  0.80,  0.85,             &amp;<a name='1104'>
     &amp;            2.65,  1.09,  0.80,  0.001, 0.04,  0.05,             &amp;<a name='1105'>
     &amp;            0.01,  0.04,  0.06,  0.05,  0.03,  0.001,            &amp;<a name='1106'>
     &amp;            0.000, 0.000, 0.000, 0.000, 0.000, 0.000 /)<a name='1107'>
<a name='1108'>
<font color=#447700>!----------------------------------------------------------------------<a name='1109'></font>
<font color=#447700>!<a name='1110'></font>
      JTF=MIN0(JTE,JDE-1)<a name='1111'>
      KTF=MIN0(KTE,KDE-1)<a name='1112'>
      ITF=MIN0(ITE,IDE-1)<a name='1113'>
<font color=#447700>!<a name='1114'></font>
<font color=#447700>!<a name='1115'></font>
<font color=#447700>!***  FOR NOW, ASSUME SIGMA MODE FOR LOWEST MODEL LAYER<a name='1116'></font>
<font color=#447700>!<a name='1117'></font>
      DO J=JTS,JTF<a name='1118'>
      DO I=ITS,ITF<a name='1119'>
        LOWLYR(I,J)=1<a name='1120'>
<font color=#447700>!       USTAR(I,J)=EPSUST<a name='1121'></font>
      ENDDO<a name='1122'>
      ENDDO<a name='1123'>
<font color=#447700>!----------------------------------------------------------------------<a name='1124'></font>
#if (NMM_CORE == 1)<a name='1125'>
<font color=#447700>!<a name='1126'></font>
      IF(.NOT.RESTART)THEN<a name='1127'>
<font color=#447700>!       CALL WRF_GET_DM_COMMUNICATOR(MPI_COMM_COMP)<a name='1128'></font>
<font color=#447700>!       MAXLOC_IVGTYP=MAXVAL(IVGTYP)<a name='1129'></font>
<font color=#447700>!       CALL MPI_ALLREDUCE(MAXLOC_IVGTYP,MAXGBL_IVGTYP,1,MPI_INTEGER   &amp;<a name='1130'></font>
<font color=#447700>!    &amp;,                    MPI_MAX,MPI_COMM_COMP,IRECV)<a name='1131'></font>
        MAXGBL_IVGTYP=MAXVAL(IVGTYP)<a name='1132'>
#ifdef DM_PARALLEL<a name='1133'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAXVAL'>WRF_DM_MAXVAL</A><A href='../../html_code/phys/module_sf_myjsfc.F.html#MYJSFCINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAXVAL_11">(MAXGBL_IVGTYP,IDUM,JDUM)<a name='1134'>
#endif<a name='1135'>
<font color=#447700>!<a name='1136'></font>
        IF (MAXGBL_IVGTYP&lt;13) THEN<a name='1137'>
          DO J=JTS,JTE<a name='1138'>
          DO I=ITS,ITE<a name='1139'>
            SM=SEAMASK(I,J)-1.<a name='1140'>
            IF(SM+XICE(I,J)&lt;0.5)THEN<a name='1141'>
              Z0(I,J)=VZ0TBL(IVGTYP(I,J))<a name='1142'>
            ENDIF<a name='1143'>
          ENDDO<a name='1144'>
          ENDDO<a name='1145'>
<font color=#447700>!<a name='1146'></font>
        ELSE<a name='1147'>
<font color=#447700>!<a name='1148'></font>
          DO J=JTS,JTE<a name='1149'>
          DO I=ITS,ITE<a name='1150'>
            SM=SEAMASK(I,J)-1.<a name='1151'>
            IF(SM+XICE(I,J)&lt;0.5)THEN<a name='1152'>
              Z0(I,J)=VZ0TBL_24(IVGTYP(I,J))<a name='1153'>
            ENDIF<a name='1154'>
          ENDDO<a name='1155'>
          ENDDO<a name='1156'>
<font color=#447700>!<a name='1157'></font>
        ENDIF <font color=#447700>! Vegtype check<a name='1158'></font>
<font color=#447700>!<a name='1159'></font>
      ENDIF <font color=#447700>! Restart check<a name='1160'></font>
<a name='1161'>
#endif<a name='1162'>
<font color=#447700>!----------------------------------------------------------------------<a name='1163'></font>
      IF(.NOT.RESTART)THEN<a name='1164'>
        DO J=JTS,JTE<a name='1165'>
        DO I=ITS,ITF<a name='1166'>
          USTAR(I,J)=0.1<a name='1167'>
        ENDDO<a name='1168'>
        ENDDO<a name='1169'>
      ENDIF<a name='1170'>
<font color=#447700>!----------------------------------------------------------------------<a name='1171'></font>
<font color=#447700>!<a name='1172'></font>
<font color=#447700>!***  COMPUTE SURFACE LAYER INTEGRAL FUNCTIONS<a name='1173'></font>
<font color=#447700>!<a name='1174'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1175'></font>
      FH01=1.<a name='1176'>
      FH02=1.<a name='1177'>
<font color=#447700>!<a name='1178'></font>
<font color=#447700>!      ZTMIN1=-10.0<a name='1179'></font>
<font color=#447700>!      ZTMAX1=2.0<a name='1180'></font>
<font color=#447700>!      ZTMIN2=-10.0<a name='1181'></font>
<font color=#447700>!      ZTMAX2=2.0<a name='1182'></font>
      ZTMIN1=-5.0<a name='1183'>
      ZTMAX1=1.0<a name='1184'>
      ZTMIN2=-5.0<a name='1185'>
      ZTMAX2=1.0<a name='1186'>
<font color=#447700>!<a name='1187'></font>
      ZRNG1=ZTMAX1-ZTMIN1<a name='1188'>
      ZRNG2=ZTMAX2-ZTMIN2<a name='1189'>
<font color=#447700>!<a name='1190'></font>
      DZETA1=ZRNG1/(KZTM-1)<a name='1191'>
      DZETA2=ZRNG2/(KZTM-1)<a name='1192'>
<font color=#447700>!<a name='1193'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1194'></font>
<font color=#447700>!***  FUNCTION DEFINITION LOOP<a name='1195'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1196'></font>
<font color=#447700>!<a name='1197'></font>
      ZETA1=ZTMIN1<a name='1198'>
      ZETA2=ZTMIN2<a name='1199'>
<font color=#447700>!<a name='1200'></font>
      DO K=1,KZTM<a name='1201'>
<font color=#447700>!<a name='1202'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1203'></font>
<font color=#447700>!***  UNSTABLE RANGE<a name='1204'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1205'></font>
<font color=#447700>!<a name='1206'></font>
        IF(ZETA1&lt;0.)THEN<a name='1207'>
<font color=#447700>!<a name='1208'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1209'></font>
<font color=#447700>!***  PAULSON 1970 FUNCTIONS<a name='1210'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1211'></font>
          X=SQRT(SQRT(1.-16.*ZETA1))<a name='1212'>
<font color=#447700>!<a name='1213'></font>
          PSIM1(K)=-2.*LOG((X+1.)/2.)-LOG((X*X+1.)/2.)+2.*ATAN(X)-PIHF<a name='1214'>
          PSIH1(K)=-2.*LOG((X*X+1.)/2.)<a name='1215'>
<font color=#447700>!<a name='1216'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1217'></font>
<font color=#447700>!***  STABLE RANGE<a name='1218'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1219'></font>
<font color=#447700>!<a name='1220'></font>
        ELSE<a name='1221'>
<font color=#447700>!<a name='1222'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1223'></font>
<font color=#447700>!***  PAULSON 1970 FUNCTIONS<a name='1224'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1225'></font>
<font color=#447700>!<a name='1226'></font>
<font color=#447700>!         PSIM1(K)=5.*ZETA1<a name='1227'></font>
<font color=#447700>!         PSIH1(K)=5.*ZETA1<a name='1228'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1229'></font>
<font color=#447700>!***   HOLTSLAG AND DE BRUIN 1988<a name='1230'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1231'></font>
<font color=#447700>!<a name='1232'></font>
          PSIM1(K)=0.7*ZETA1+0.75*ZETA1*(6.-0.35*ZETA1)*EXP(-0.35*ZETA1)<a name='1233'>
          PSIH1(K)=0.7*ZETA1+0.75*ZETA1*(6.-0.35*ZETA1)*EXP(-0.35*ZETA1)<a name='1234'>
<font color=#447700>!----------------------------------------------------------------------<a name='1235'></font>
<font color=#447700>!<a name='1236'></font>
        ENDIF<a name='1237'>
<font color=#447700>!<a name='1238'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1239'></font>
<font color=#447700>!***  UNSTABLE RANGE<a name='1240'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1241'></font>
<font color=#447700>!<a name='1242'></font>
        IF(ZETA2&lt;0.)THEN<a name='1243'>
<font color=#447700>!<a name='1244'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1245'></font>
<font color=#447700>!***  PAULSON 1970 FUNCTIONS<a name='1246'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1247'></font>
<font color=#447700>!<a name='1248'></font>
          X=SQRT(SQRT(1.-16.*ZETA2))<a name='1249'>
<font color=#447700>!<a name='1250'></font>
          PSIM2(K)=-2.*LOG((X+1.)/2.)-LOG((X*X+1.)/2.)+2.*ATAN(X)-PIHF<a name='1251'>
          PSIH2(K)=-2.*LOG((X*X+1.)/2.)<a name='1252'>
<font color=#447700>!----------------------------------------------------------------------<a name='1253'></font>
<font color=#447700>!***  STABLE RANGE<a name='1254'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1255'></font>
<font color=#447700>!<a name='1256'></font>
        ELSE<a name='1257'>
<font color=#447700>!<a name='1258'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1259'></font>
<font color=#447700>!***  PAULSON 1970 FUNCTIONS<a name='1260'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1261'></font>
<font color=#447700>!<a name='1262'></font>
<font color=#447700>!         PSIM2(K)=5.*ZETA2<a name='1263'></font>
<font color=#447700>!         PSIH2(K)=5.*ZETA2<a name='1264'></font>
<font color=#447700>!<a name='1265'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1266'></font>
<font color=#447700>!***  HOLTSLAG AND DE BRUIN 1988<a name='1267'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1268'></font>
<font color=#447700>!<a name='1269'></font>
          PSIM2(K)=0.7*ZETA2+0.75*ZETA2*(6.-0.35*ZETA2)*EXP(-0.35*ZETA2)<a name='1270'>
          PSIH2(K)=0.7*ZETA2+0.75*ZETA2*(6.-0.35*ZETA2)*EXP(-0.35*ZETA2)<a name='1271'>
<font color=#447700>!----------------------------------------------------------------------<a name='1272'></font>
<font color=#447700>!<a name='1273'></font>
        ENDIF<a name='1274'>
<font color=#447700>!<a name='1275'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1276'></font>
        IF(K==KZTM)THEN<a name='1277'>
          ZTMAX1=ZETA1<a name='1278'>
          ZTMAX2=ZETA2<a name='1279'>
        ENDIF<a name='1280'>
<font color=#447700>!<a name='1281'></font>
        ZETA1=ZETA1+DZETA1<a name='1282'>
        ZETA2=ZETA2+DZETA2<a name='1283'>
<font color=#447700>!----------------------------------------------------------------------<a name='1284'></font>
      ENDDO<a name='1285'>
<font color=#447700>!----------------------------------------------------------------------<a name='1286'></font>
      ZTMAX1=ZTMAX1-EPS<a name='1287'>
      ZTMAX2=ZTMAX2-EPS<a name='1288'>
<font color=#447700>!----------------------------------------------------------------------<a name='1289'></font>
<font color=#447700>!<a name='1290'></font>
      END SUBROUTINE MYJSFCINIT<a name='1291'>
<font color=#447700>!<a name='1292'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1293'></font>
<font color=#447700>!<a name='1294'></font>
      END MODULE MODULE_SF_MYJSFC<a name='1295'>
<font color=#447700>!<a name='1296'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1297'></font>
</pre></body></html>