<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#define MYNN_DBG_LVL 3000<a name='2'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='3'></font>
<font color=#447700>!<a name='4'></font>
<font color=#447700>! translated from NN f77 to F90 and put into WRF by Mariusz Pagowski<a name='5'></font>
<font color=#447700>! NOAA/GSD &amp; CIRA/CSU, Feb 2008<a name='6'></font>
<font color=#447700>! changes to original code:<a name='7'></font>
<font color=#447700>! 1. code is 1d (in z)<a name='8'></font>
<font color=#447700>! 2. no advection of TKE, covariances and variances <a name='9'></font>
<font color=#447700>! 3. Cranck-Nicholson replaced with the implicit scheme<a name='10'></font>
<font color=#447700>! 4. removed terrain dependent grid since input in WRF in actual<a name='11'></font>
<font color=#447700>!    distances in z[m]<a name='12'></font>
<font color=#447700>! 5. cosmetic changes to adhere to WRF standard (remove common blocks, <a name='13'></font>
<font color=#447700>!            intent etc)<a name='14'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='15'></font>
<font color=#447700>!Modifications implemented by Joseph Olson NOAA/GSD/AMB - CU/CIRES<a name='16'></font>
<font color=#447700>! (approved by Mikio Nakanishi or under consideration or do not<a name='17'></font>
<font color=#447700>! significantly alter the general behavior of the MYNN as documented.):<a name='18'></font>
<font color=#447700>!<a name='19'></font>
<font color=#447700>! 1. Addition of BouLac mixing length in the free atmosphere.<a name='20'></font>
<font color=#447700>! 2. Changed the turbulent mixing length to be integrated from the<a name='21'></font>
<font color=#447700>!    surface to the top of the BL + a transition layer depth.<a name='22'></font>
<font color=#447700>! 3. v3.4.1: Option to use Kitamura/Canuto modification which removes <a name='23'></font>
<font color=#447700>!            the critical Richardson number and negative TKE (default).<a name='24'></font>
<font color=#447700>!            Hybrid PBL height diagnostic, which blends a theta-v-based<a name='25'></font>
<font color=#447700>!            definition in neutral/convective BL and a TKE-based definition<a name='26'></font>
<font color=#447700>!            in stable conditions.<a name='27'></font>
<font color=#447700>!            TKE budget output option (bl_mynn_tkebudget)<a name='28'></font>
<font color=#447700>! 4. v3.5.0: TKE advection option (bl_mynn_tkeadvect)<a name='29'></font>
<font color=#447700>! 5. v3.5.1: Fog deposition related changes.<a name='30'></font>
<font color=#447700>! 6. v3.6.0: Removed fog deposition from the calculation of tendencies<a name='31'></font>
<font color=#447700>!            Added mixing of qc, qi, qni<a name='32'></font>
<font color=#447700>!            Added output for wstar, delta, TKE_PBL, &amp; KPBL for correct <a name='33'></font>
<font color=#447700>!                   coupling to shcu schemes  <a name='34'></font>
<font color=#447700>! 7. v3.8.0: Added subgrid scale cloud output for coupling to radiation<a name='35'></font>
<font color=#447700>!            schemes (activated by setting icloud_bl =1 in phys namelist).<a name='36'></font>
<font color=#447700>!            Added WRF_DEBUG prints (at level 3000)<a name='37'></font>
<font color=#447700>!            Added Tripoli and Cotton (1981) correction.<a name='38'></font>
<font color=#447700>!            Added namelist option bl_mynn_cloudmix to test effect of mixing<a name='39'></font>
<font color=#447700>!                cloud species (default = 1: on). <a name='40'></font>
<font color=#447700>!            Added mass-flux option (bl_mynn_edmf, = 1 for StEM, 2 for TEMF).<a name='41'></font>
<font color=#447700>!                This option is off by default (=0).<a name='42'></font>
<font color=#447700>!                Related (hidden) options: <a name='43'></font>
<font color=#447700>!                 bl_mynn_edmf_mom = 1 : activate momentum transport in MF scheme<a name='44'></font>
<font color=#447700>!                 bl_mynn_edmf_tke = 1 : activate TKE transport in MF scheme<a name='45'></font>
<font color=#447700>!                 bl_mynn_edmf_part= 1 : activate areal partitioning of ED &amp; MF<a name='46'></font>
<font color=#447700>!            Added mixing length option (bl_mynn_mixlength, see notes below)<a name='47'></font>
<font color=#447700>!            Added more sophisticated saturation checks, following Thompson scheme<a name='48'></font>
<font color=#447700>!            Added new cloud PDF option (bl_mynn_cloudpdf = 2) from Chaboureau<a name='49'></font>
<font color=#447700>!                and Bechtold (2002, JAS, with mods) <a name='50'></font>
<font color=#447700>!            Added capability to mix chemical species when env variable<a name='51'></font>
<font color=#447700>!                WRF_CHEM = 1, thanks to Wayne Angevine.<a name='52'></font>
<font color=#447700>!            Added scale-aware mixing length, following Junshi Ito's work<a name='53'></font>
<font color=#447700>!                Ito et al. (2015, BLM).<a name='54'></font>
<font color=#447700>! 8. v3.9.0  Improvement to the mass-flux scheme (dynamic number of plumes,<a name='55'></font>
<font color=#447700>!                better plume/cloud depth, significant speed up, better cloud<a name='56'></font>
<font color=#447700>!                fraction). <a name='57'></font>
<font color=#447700>!            Added Stochastic Parameter Perturbation (SPP) implementation.<a name='58'></font>
<font color=#447700>!            Many miscellaneous tweaks to the mixing lengths and stratus<a name='59'></font>
<font color=#447700>!                component of the subgrid clouds.<a name='60'></font>
<font color=#447700>! <a name='61'></font>
<font color=#447700>! For changes 1, 3, and 6, see "JOE's mods" below:<a name='62'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='63'></font>
<a name='64'>
<A NAME='MODULE_BL_MYNN'><A href='../../html_code/phys/module_bl_mynn.F.html#MODULE_BL_MYNN' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='65'>
<font color=#993300>MODULE </font><font color=#cc0000>module_bl_mynn</font> <A href='../../call_to/MODULE_BL_MYNN.html' TARGET='index'>5</A><a name='66'>
<a name='67'>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_bl_mynn.F.html#module_bl_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_44">, only: &amp;<a name='68'>
       &amp;karman, g, p1000mb, &amp;<a name='69'>
       &amp;cp, r_d, r_v, rcp, xlv, xlf, xls, &amp;<a name='70'>
       &amp;svp1, svp2, svp3, svpt0, ep_1, ep_2, rvovrd, &amp;<a name='71'>
       &amp;cpv, cliq, cice<a name='72'>
<a name='73'>
  USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_bl_mynn.F.html#module_bl_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_108">, only: param_first_scalar, &amp;<a name='74'>
       &amp;p_qc, p_qr, p_qi, p_qs, p_qg, p_qnc, p_qni<a name='75'>
<a name='76'>
  USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_bl_mynn.F.html#module_bl_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_42"><a name='77'>
<font color=#447700>!-------------------------------------------------------------------<a name='78'></font>
  IMPLICIT NONE<a name='79'>
<font color=#447700>!-------------------------------------------------------------------<a name='80'></font>
<a name='81'>
<font color=#447700>! The parameters below depend on stability functions of module_sf_mynn.<a name='82'></font>
  REAL, PARAMETER :: cphm_st=5.0, cphm_unst=16.0, &amp;<a name='83'>
                     cphh_st=5.0, cphh_unst=16.0<a name='84'>
<a name='85'>
  REAL, PARAMETER :: xlvcp=xlv/cp, xlscp=(xlv+xlf)/cp, ev=xlv, rd=r_d, &amp;<a name='86'>
       &amp;rk=cp/rd, svp11=svp1*1.e3, p608=ep_1, ep_3=1.-ep_2<a name='87'>
<a name='88'>
  REAL, PARAMETER :: tref=300.0     <font color=#447700>! reference temperature (K)<a name='89'></font>
  REAL, PARAMETER :: TKmin=253.0    <font color=#447700>! for total water conversion, Tripoli and Cotton (1981)<a name='90'></font>
  REAL, PARAMETER :: tv0=p608*tref, tv1=(1.+p608)*tref, gtr=g/tref<a name='91'>
<a name='92'>
<font color=#447700>! Closure constants<a name='93'></font>
  REAL, PARAMETER :: &amp;<a name='94'>
       &amp;vk  = karman, &amp;<a name='95'>
       &amp;pr  =  0.74,  &amp;<a name='96'>
       &amp;g1  =  0.235, &amp;  <font color=#447700>! NN2009 = 0.235<a name='97'></font>
       &amp;b1  = 24.0, &amp;<a name='98'>
       &amp;b2  = 15.0, &amp;    <font color=#447700>! CKmod     NN2009<a name='99'></font>
       &amp;c2  =  0.729, &amp;  <font color=#447700>! 0.729, &amp; !0.75, &amp;<a name='100'></font>
       &amp;c3  =  0.340, &amp;  <font color=#447700>! 0.340, &amp; !0.352, &amp;<a name='101'></font>
       &amp;c4  =  0.0, &amp;<a name='102'>
       &amp;c5  =  0.2, &amp;<a name='103'>
       &amp;a1  = b1*( 1.0-3.0*g1 )/6.0, &amp;<a name='104'>
<font color=#447700>!       &amp;c1  = g1 -1.0/( 3.0*a1*b1**(1.0/3.0) ), &amp;<a name='105'></font>
       &amp;c1  = g1 -1.0/( 3.0*a1*2.88449914061481660), &amp;<a name='106'>
       &amp;a2  = a1*( g1-c1 )/( g1*pr ), &amp;<a name='107'>
       &amp;g2  = b2/b1*( 1.0-c3 ) +2.0*a1/b1*( 3.0-2.0*c2 )<a name='108'>
<a name='109'>
  REAL, PARAMETER :: &amp;<a name='110'>
       &amp;cc2 =  1.0-c2, &amp;<a name='111'>
       &amp;cc3 =  1.0-c3, &amp;<a name='112'>
       &amp;e1c =  3.0*a2*b2*cc3, &amp;<a name='113'>
       &amp;e2c =  9.0*a1*a2*cc2, &amp;<a name='114'>
       &amp;e3c =  9.0*a2*a2*cc2*( 1.0-c5 ), &amp;<a name='115'>
       &amp;e4c = 12.0*a1*a2*cc2, &amp;<a name='116'>
       &amp;e5c =  6.0*a1*a1<a name='117'>
<a name='118'>
<font color=#447700>! Constants for min tke in elt integration (qmin), max z/L in els (zmax), <a name='119'></font>
<font color=#447700>! and factor for eddy viscosity for TKE (Kq = Sqfac*Km):<a name='120'></font>
  REAL, PARAMETER :: qmin=0.0, zmax=1.0, Sqfac=3.0<a name='121'>
<font color=#447700>! Note that the following mixing-length constants are now specified in mym_length<a name='122'></font>
<font color=#447700>!      &amp;cns=3.5, alp1=0.23, alp2=0.3, alp3=3.0, alp4=10.0, alp5=0.4<a name='123'></font>
<a name='124'>
<font color=#447700>! Constants for gravitational settling<a name='125'></font>
<font color=#447700>!  REAL, PARAMETER :: gno=1.e6/(1.e8)**(2./3.), gpw=5./3., qcgmin=1.e-8<a name='126'></font>
  REAL, PARAMETER :: gno=1.0  <font color=#447700>!original value seems too agressive: 4.64158883361278196<a name='127'></font>
  REAL, PARAMETER :: gpw=5./3., qcgmin=1.e-8, qkemin=1.e-12<a name='128'>
<a name='129'>
<font color=#447700>! Constants for cloud PDF (mym_condensation)<a name='130'></font>
  REAL, PARAMETER :: rr2=0.7071068, rrp=0.3989423<a name='131'>
<a name='132'>
<font color=#447700>! 'parameters' for Poisson distribution (StEM EDMF scheme)<a name='133'></font>
  REAL, PARAMETER  :: zero = 0.0, half = 0.5, one = 1.0, two = 2.0<a name='134'>
<a name='135'>
  <font color=#447700>!Use Canuto/Kitamura mod (remove Ric and negative TKE) (1:yes, 0:no)<a name='136'></font>
  <font color=#447700>!For more info, see Canuto et al. (2008 JAS) and Kitamura (Journal of the <a name='137'></font>
  <font color=#447700>!Meteorological Society of Japan, Vol. 88, No. 5, pp. 857-864, 2010).<a name='138'></font>
  <font color=#447700>!Note that this change required further modification of other parameters<a name='139'></font>
  <font color=#447700>!above (c2, c3). If you want to remove this option, set c2 and c3 constants <a name='140'></font>
  <font color=#447700>!(above) back to NN2009 values (see commented out lines next to the<a name='141'></font>
  <font color=#447700>!parameters above). This only removes the negative TKE problem<a name='142'></font>
  <font color=#447700>!but does not necessarily improve performance - neutral impact.<a name='143'></font>
  REAL, PARAMETER :: CKmod=1.<a name='144'>
<a name='145'>
  <font color=#447700>!Use Ito et al. (2015, BLM) scale-aware (0: no, 1: yes). Note that this also has impacts<a name='146'></font>
  <font color=#447700>!on the cloud PDF and mass-flux scheme, using Honnert et al. (2011) similarity function<a name='147'></font>
  <font color=#447700>!for TKE in the upper PBL/cloud layer.<a name='148'></font>
  REAL, PARAMETER :: scaleaware=1.<a name='149'>
<a name='150'>
<a name='151'>
  <font color=#447700>!Temporary switch to deactivate the mixing of chemical species (already done when WRF_CHEM = 1)<a name='152'></font>
  INTEGER, PARAMETER :: bl_mynn_mixchem = 0<a name='153'>
<a name='154'>
<font color=#447700>! JAYMES-<a name='155'></font>
<font color=#447700>! Constants used for empirical calculations of saturation<a name='156'></font>
<font color=#447700>! vapor pressures (in function "esat") and saturation mixing ratios<a name='157'></font>
<font color=#447700>! (in function "qsat"), reproduced from module_mp_thompson.F, <a name='158'></font>
<font color=#447700>! v3.6 <a name='159'></font>
  REAL, PARAMETER:: J0= .611583699E03<a name='160'>
  REAL, PARAMETER:: J1= .444606896E02<a name='161'>
  REAL, PARAMETER:: J2= .143177157E01<a name='162'>
  REAL, PARAMETER:: J3= .264224321E-1<a name='163'>
  REAL, PARAMETER:: J4= .299291081E-3<a name='164'>
  REAL, PARAMETER:: J5= .203154182E-5<a name='165'>
  REAL, PARAMETER:: J6= .702620698E-8<a name='166'>
  REAL, PARAMETER:: J7= .379534310E-11<a name='167'>
  REAL, PARAMETER:: J8=-.321582393E-13<a name='168'>
<a name='169'>
  REAL, PARAMETER:: K0= .609868993E03<a name='170'>
  REAL, PARAMETER:: K1= .499320233E02<a name='171'>
  REAL, PARAMETER:: K2= .184672631E01<a name='172'>
  REAL, PARAMETER:: K3= .402737184E-1<a name='173'>
  REAL, PARAMETER:: K4= .565392987E-3<a name='174'>
  REAL, PARAMETER:: K5= .521693933E-5<a name='175'>
  REAL, PARAMETER:: K6= .307839583E-7<a name='176'>
  REAL, PARAMETER:: K7= .105785160E-9<a name='177'>
  REAL, PARAMETER:: K8= .161444444E-12<a name='178'>
<font color=#447700>! end-<a name='179'></font>
<a name='180'>
<font color=#447700>!JOE &amp; JAYMES'S mods<a name='181'></font>
<font color=#447700>!<a name='182'></font>
<font color=#447700>! Mixing Length Options <a name='183'></font>
<font color=#447700>!   specifed through namelist:  bl_mynn_mixlength<a name='184'></font>
<font color=#447700>!   added:  16 Apr 2015<a name='185'></font>
<font color=#447700>!<a name='186'></font>
<font color=#447700>! 0: Uses original MYNN mixing length formulation (except elt is calculated from <a name='187'></font>
<font color=#447700>!    a 10-km vertical integration).  No scale-awareness is applied to the master<a name='188'></font>
<font color=#447700>!    mixing length (el), regardless of "scaleaware" setting. <a name='189'></font>
<font color=#447700>!<a name='190'></font>
<font color=#447700>! 1 (*DEFAULT*): Instead of (0), uses BouLac mixing length in free atmosphere.  <a name='191'></font>
<font color=#447700>!    This helps remove excessively large mixing in unstable layers aloft.  Scale-<a name='192'></font>
<font color=#447700>!    awareness in dx is available via the "scaleaware" setting.  As of Apr 2015, <a name='193'></font>
<font color=#447700>!    this mixing length formulation option is used in the ESRL RAP/HRRR configuration.<a name='194'></font>
<font color=#447700>!<a name='195'></font>
<font color=#447700>! 2: As in (1), but elb is lengthened using separate cloud mixing length functions <a name='196'></font>
<font color=#447700>!    for statically stable and unstable regimes.  This elb adjustment is only <a name='197'></font>
<font color=#447700>!    possible for nonzero cloud fractions, such that cloud-free cells are treated <a name='198'></font>
<font color=#447700>!    as in (1), but BouLac calculation is used more sparingly - when elb &gt; 500 m. <a name='199'></font>
<font color=#447700>!    This is to reduce the computational expense that comes with the BouLac calculation.<a name='200'></font>
<font color=#447700>!    Also, This option is  scale-aware in dx if "scaleaware" = 1. (Following Ito et al. 2015). <a name='201'></font>
<font color=#447700>!<a name='202'></font>
<font color=#447700>!JOE &amp; JAYMES- end<a name='203'></font>
<a name='204'>
<a name='205'>
<a name='206'>
  INTEGER :: mynn_level<a name='207'>
<a name='208'>
  CHARACTER*128 :: mynn_message<a name='209'>
<a name='210'>
  INTEGER, PARAMETER :: kdebug=27<a name='211'>
<a name='212'>
CONTAINS<a name='213'>
<a name='214'>
<font color=#447700>! **********************************************************************<a name='215'></font>
<font color=#447700>! *   An improved Mellor-Yamada turbulence closure model               *<a name='216'></font>
<font color=#447700>! *                                                                    *<a name='217'></font>
<font color=#447700>! *                                   Aug/2005  M. Nakanishi (N.D.A)   *<a name='218'></font>
<font color=#447700>! *                        Modified:  Dec/2005  M. Nakanishi (N.D.A)   *<a name='219'></font>
<font color=#447700>! *                                             naka@nda.ac.jp         *<a name='220'></font>
<font color=#447700>! *                                                                    *<a name='221'></font>
<font color=#447700>! *   Contents:                                                        *<a name='222'></font>
<font color=#447700>! *     1. mym_initialize  (to be called once initially)               *<a name='223'></font>
<font color=#447700>! *        gives the closure constants and initializes the turbulent   *<a name='224'></font>
<font color=#447700>! *        quantities.                                                 *<a name='225'></font>
<font color=#447700>! *    (2) mym_level2      (called in the other subroutines)           *<a name='226'></font>
<font color=#447700>! *        calculates the stability functions at Level 2.              *<a name='227'></font>
<font color=#447700>! *    (3) mym_length      (called in the other subroutines)           *<a name='228'></font>
<font color=#447700>! *        calculates the master length scale.                         *<a name='229'></font>
<font color=#447700>! *     4. mym_turbulence                                              *<a name='230'></font>
<font color=#447700>! *        calculates the vertical diffusivity coefficients and the    *<a name='231'></font>
<font color=#447700>! *        production terms for the turbulent quantities.              *<a name='232'></font>
<font color=#447700>! *     5. mym_predict                                                 *<a name='233'></font>
<font color=#447700>! *        predicts the turbulent quantities at the next step.         *<a name='234'></font>
<font color=#447700>! *     6. mym_condensation                                            *<a name='235'></font>
<font color=#447700>! *        determines the liquid water content and the cloud fraction  *<a name='236'></font>
<font color=#447700>! *        diagnostically.                                             *<a name='237'></font>
<font color=#447700>! *                                                                    *<a name='238'></font>
<font color=#447700>! *             call mym_initialize                                    *<a name='239'></font>
<font color=#447700>! *                  |                                                 *<a name='240'></font>
<font color=#447700>! *                  |&lt;----------------+                               *<a name='241'></font>
<font color=#447700>! *                  |                 |                               *<a name='242'></font>
<font color=#447700>! *             call mym_condensation  |                               *<a name='243'></font>
<font color=#447700>! *             call mym_turbulence    |                               *<a name='244'></font>
<font color=#447700>! *             call mym_predict       |                               *<a name='245'></font>
<font color=#447700>! *                  |                 |                               *<a name='246'></font>
<font color=#447700>! *                  |-----------------+                               *<a name='247'></font>
<font color=#447700>! *                  |                                                 *<a name='248'></font>
<font color=#447700>! *                 end                                                *<a name='249'></font>
<font color=#447700>! *                                                                    *<a name='250'></font>
<font color=#447700>! *   Variables worthy of special mention:                             *<a name='251'></font>
<font color=#447700>! *     tref   : Reference temperature                                 *<a name='252'></font>
<font color=#447700>! *     thl     : Liquid water potential temperature               *<a name='253'></font>
<font color=#447700>! *     qw     : Total water (water vapor+liquid water) content        *<a name='254'></font>
<font color=#447700>! *     ql     : Liquid water content                                  *<a name='255'></font>
<font color=#447700>! *     vt, vq : Functions for computing the buoyancy flux             *<a name='256'></font>
<font color=#447700>! *                                                                    *<a name='257'></font>
<font color=#447700>! *     If the water contents are unnecessary, e.g., in the case of    *<a name='258'></font>
<font color=#447700>! *     ocean models, thl is the potential temperature and qw, ql, vt   *<a name='259'></font>
<font color=#447700>! *     and vq are all zero.                                           *<a name='260'></font>
<font color=#447700>! *                                                                    *<a name='261'></font>
<font color=#447700>! *   Grid arrangement:                                                *<a name='262'></font>
<font color=#447700>! *             k+1 +---------+                                        *<a name='263'></font>
<font color=#447700>! *                 |         |     i = 1 - nx                         *<a name='264'></font>
<font color=#447700>! *             (k) |    *    |     j = 1 - ny                         *<a name='265'></font>
<font color=#447700>! *                 |         |     k = 1 - nz                         *<a name='266'></font>
<font color=#447700>! *              k  +---------+                                        *<a name='267'></font>
<font color=#447700>! *                 i   (i)  i+1                                       *<a name='268'></font>
<font color=#447700>! *                                                                    *<a name='269'></font>
<font color=#447700>! *     All the predicted variables are defined at the center (*) of   *<a name='270'></font>
<font color=#447700>! *     the grid boxes. The diffusivity coefficients are, however,     *<a name='271'></font>
<font color=#447700>! *     defined on the walls of the grid boxes.                        *<a name='272'></font>
<font color=#447700>! *     # Upper boundary values are given at k=nz.                   *<a name='273'></font>
<font color=#447700>! *                                                                    *<a name='274'></font>
<font color=#447700>! *   References:                                                      *<a name='275'></font>
<font color=#447700>! *     1. Nakanishi, M., 2001:                                        *<a name='276'></font>
<font color=#447700>! *        Boundary-Layer Meteor., 99, 349-378.                        *<a name='277'></font>
<font color=#447700>! *     2. Nakanishi, M. and H. Niino, 2004:                           *<a name='278'></font>
<font color=#447700>! *        Boundary-Layer Meteor., 112, 1-31.                          *<a name='279'></font>
<font color=#447700>! *     3. Nakanishi, M. and H. Niino, 2006:                           *<a name='280'></font>
<font color=#447700>! *        Boundary-Layer Meteor., (in press).                         *<a name='281'></font>
<font color=#447700>! *     4. Nakanishi, M. and H. Niino, 2009:                           *<a name='282'></font>
<font color=#447700>! *        Jour. Meteor. Soc. Japan, 87, 895-912.                      *<a name='283'></font>
<font color=#447700>! **********************************************************************<a name='284'></font>
<font color=#447700>!<a name='285'></font>
<font color=#447700>!     SUBROUTINE  mym_initialize:<a name='286'></font>
<font color=#447700>!<a name='287'></font>
<font color=#447700>!     Input variables:<a name='288'></font>
<font color=#447700>!       iniflag         : &lt;&gt;0; turbulent quantities will be initialized<a name='289'></font>
<font color=#447700>!                         = 0; turbulent quantities have been already<a name='290'></font>
<font color=#447700>!                              given, i.e., they will not be initialized<a name='291'></font>
<font color=#447700>!       nx, ny, nz      : Dimension sizes of the<a name='292'></font>
<font color=#447700>!                         x, y and z directions, respectively<a name='293'></font>
<font color=#447700>!       tref            : Reference temperature                      (K)<a name='294'></font>
<font color=#447700>!       dz(nz)        : Vertical grid spacings                     (m)<a name='295'></font>
<font color=#447700>!                         # dz(nz)=dz(nz-1)<a name='296'></font>
<font color=#447700>!       zw(nz+1)        : Heights of the walls of the grid boxes     (m)<a name='297'></font>
<font color=#447700>!                         # zw(1)=0.0 and zw(k)=zw(k-1)+dz(k-1)<a name='298'></font>
<font color=#447700>!       h(nx,ny)        : G^(1/2) in the terrain-following coordinate<a name='299'></font>
<font color=#447700>!                         # h=1-zg/zt, where zg is the height of the<a name='300'></font>
<font color=#447700>!                           terrain and zt the top of the model domain<a name='301'></font>
<font color=#447700>!       pi0(nx,my,nz) : Exner function at zw*h+zg             (J/kg K)<a name='302'></font>
<font color=#447700>!                         defined by c_p*( p_basic/1000hPa )^kappa<a name='303'></font>
<font color=#447700>!                         This is usually computed by integrating<a name='304'></font>
<font color=#447700>!                         d(pi0)/dz = -h*g/tref.<a name='305'></font>
<font color=#447700>!       rmo(nx,ny)      : Inverse of the Obukhov length         (m^(-1))<a name='306'></font>
<font color=#447700>!       flt, flq(nx,ny) : Turbulent fluxes of sensible and latent heat,<a name='307'></font>
<font color=#447700>!                         respectively, e.g., flt=-u_*Theta_* (K m/s)<a name='308'></font>
<font color=#447700>!! flt - liquid water potential temperature surface flux<a name='309'></font>
<font color=#447700>!! flq - total water flux surface flux<a name='310'></font>
<font color=#447700>!       ust(nx,ny)      : Friction velocity                        (m/s)<a name='311'></font>
<font color=#447700>!       pmz(nx,ny)      : phi_m-zeta at z1*h+z0, where z1 (=0.5*dz(1))<a name='312'></font>
<font color=#447700>!                         is the first grid point above the surafce, z0<a name='313'></font>
<font color=#447700>!                         the roughness length and zeta=(z1*h+z0)*rmo<a name='314'></font>
<font color=#447700>!       phh(nx,ny)      : phi_h at z1*h+z0<a name='315'></font>
<font color=#447700>!       u, v(nx,nz,ny): Components of the horizontal wind        (m/s)<a name='316'></font>
<font color=#447700>!       thl(nx,nz,ny)  : Liquid water potential temperature<a name='317'></font>
<font color=#447700>!                                                                    (K)<a name='318'></font>
<font color=#447700>!       qw(nx,nz,ny)  : Total water content Q_w                (kg/kg)<a name='319'></font>
<font color=#447700>!<a name='320'></font>
<font color=#447700>!     Output variables:<a name='321'></font>
<font color=#447700>!       ql(nx,nz,ny)  : Liquid water content                   (kg/kg)<a name='322'></font>
<font color=#447700>!       v?(nx,nz,ny)  : Functions for computing the buoyancy flux<a name='323'></font>
<font color=#447700>!       qke(nx,nz,ny) : Twice the turbulent kinetic energy q^2<a name='324'></font>
<font color=#447700>!                                                              (m^2/s^2)<a name='325'></font>
<font color=#447700>!       tsq(nx,nz,ny) : Variance of Theta_l                      (K^2)<a name='326'></font>
<font color=#447700>!       qsq(nx,nz,ny) : Variance of Q_w<a name='327'></font>
<font color=#447700>!       cov(nx,nz,ny) : Covariance of Theta_l and Q_w              (K)<a name='328'></font>
<font color=#447700>!       el(nx,nz,ny)  : Master length scale L                      (m)<a name='329'></font>
<font color=#447700>!                         defined on the walls of the grid boxes<a name='330'></font>
<font color=#447700>!<a name='331'></font>
<font color=#447700>!     Work arrays:        see subroutine mym_level2<a name='332'></font>
<font color=#447700>!       pd?(nx,nz,ny) : Half of the production terms at Level 2<a name='333'></font>
<font color=#447700>!                         defined on the walls of the grid boxes<a name='334'></font>
<font color=#447700>!       qkw(nx,nz,ny) : q on the walls of the grid boxes         (m/s)<a name='335'></font>
<font color=#447700>!<a name='336'></font>
<font color=#447700>!     # As to dtl, ...gh, see subroutine mym_turbulence.<a name='337'></font>
<font color=#447700>!<a name='338'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='339'></font>
<A NAME='MYM_INITIALIZE'><A href='../../html_code/phys/module_bl_mynn.F.html#MYM_INITIALIZE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='340'>
  <font color=#993300>SUBROUTINE  </font><font color=#cc0000>mym_initialize</font> (                                &amp;  <A href='../../call_to/MYM_INITIALIZE.html' TARGET='index'>1</A><a name='341'>
       &amp;            kts,kte,                                  &amp;<a name='342'>
       &amp;            dz, zw,                                   &amp;<a name='343'>
       &amp;            u, v, thl, qw,                            &amp;<a name='344'>
<font color=#447700>!       &amp;            ust, rmo, pmz, phh, flt, flq,             &amp;<a name='345'></font>
       &amp;            zi, theta, sh,                            &amp;<a name='346'>
       &amp;            ust, rmo, el,                             &amp;<a name='347'>
       &amp;            Qke, Tsq, Qsq, Cov, Psig_bl, cldfra_bl1D, &amp;<a name='348'>
       &amp;            bl_mynn_mixlength,                        &amp;<a name='349'>
       &amp;            edmf_a1,edmf_qc1,bl_mynn_edmf,            &amp;<a name='350'>
       &amp;            spp_pbl,rstoch_col)<a name='351'>
<font color=#447700>!<a name='352'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='353'></font>
    <a name='354'>
    INTEGER, INTENT(IN)   :: kts,kte<a name='355'>
    INTEGER, INTENT(IN)   :: bl_mynn_mixlength,bl_mynn_edmf<a name='356'>
<font color=#447700>!    REAL, INTENT(IN)   :: ust, rmo, pmz, phh, flt, flq<a name='357'></font>
    REAL, INTENT(IN)   :: ust, rmo, Psig_bl<a name='358'>
    REAL, DIMENSION(kts:kte), INTENT(in) :: dz<a name='359'>
    REAL, DIMENSION(kts:kte+1), INTENT(in) :: zw<a name='360'>
    REAL, DIMENSION(kts:kte), INTENT(in) :: u,v,thl,qw,cldfra_bl1D,&amp;<a name='361'>
                                            edmf_a1,edmf_qc1<a name='362'>
    REAL, DIMENSION(kts:kte), INTENT(out) :: tsq,qsq,cov<a name='363'>
    REAL, DIMENSION(kts:kte), INTENT(inout) :: el,qke<a name='364'>
<a name='365'>
    REAL, DIMENSION(kts:kte) :: &amp;<a name='366'>
         &amp;ql,pdk,pdt,pdq,pdc,dtl,dqw,dtv,&amp;<a name='367'>
         &amp;gm,gh,sm,sh,qkw,vt,vq<a name='368'>
    INTEGER :: k,l,lmax<a name='369'>
    REAL :: phm,vkz,elq,elv,b1l,b2l,pmz=1.,phh=1.,flt=0.,flq=0.,tmpq<a name='370'>
    REAL :: zi<a name='371'>
    REAL, DIMENSION(kts:kte) :: theta<a name='372'>
<a name='373'>
    REAL, DIMENSION(kts:kte) :: rstoch_col<a name='374'>
    INTEGER ::spp_pbl<a name='375'>
<a name='376'>
<font color=#447700>!   **  At first ql, vt and vq are set to zero.  **<a name='377'></font>
    DO k = kts,kte<a name='378'>
       ql(k) = 0.0<a name='379'>
       vt(k) = 0.0<a name='380'>
       vq(k) = 0.0<a name='381'>
    END DO<a name='382'>
<font color=#447700>!<a name='383'></font>
    CALL <A href='../../html_code/phys/module_bl_mynn.F.html#MYM_LEVEL2'>mym_level2</A><A href='../../html_code/phys/module_bl_mynn.F.html#module_bl_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYM_LEVEL2_1"> ( kts,kte,&amp;<a name='384'>
         &amp;            dz,  &amp;<a name='385'>
         &amp;            u, v, thl, qw, &amp;<a name='386'>
         &amp;            ql, vt, vq, &amp;<a name='387'>
         &amp;            dtl, dqw, dtv, gm, gh, sm, sh )<a name='388'>
<font color=#447700>!<a name='389'></font>
<font color=#447700>!   **  Preliminary setting  **<a name='390'></font>
<a name='391'>
    el (kts) = 0.0<a name='392'>
    qke(kts) = ust**2 * ( b1*pmz )**(2.0/3.0)<a name='393'>
<font color=#447700>!<a name='394'></font>
    phm      = phh*b2 / ( b1*pmz )**(1.0/3.0)<a name='395'>
    tsq(kts) = phm*( flt/ust )**2<a name='396'>
    qsq(kts) = phm*( flq/ust )**2<a name='397'>
    cov(kts) = phm*( flt/ust )*( flq/ust )<a name='398'>
<font color=#447700>!<a name='399'></font>
    DO k = kts+1,kte<a name='400'>
       vkz = vk*zw(k)<a name='401'>
       el (k) = vkz/( 1.0 + vkz/100.0 )<a name='402'>
       qke(k) = 0.0<a name='403'>
<font color=#447700>!<a name='404'></font>
       tsq(k) = 0.0<a name='405'>
       qsq(k) = 0.0<a name='406'>
       cov(k) = 0.0<a name='407'>
    END DO<a name='408'>
<font color=#447700>!<a name='409'></font>
<font color=#447700>!   **  Initialization with an iterative manner          **<a name='410'></font>
<font color=#447700>!   **  lmax is the iteration count. This is arbitrary.  **<a name='411'></font>
    lmax = 5 <a name='412'>
<font color=#447700>!<a name='413'></font>
    DO l = 1,lmax<a name='414'>
<font color=#447700>!<a name='415'></font>
       CALL <A href='../../html_code/phys/module_bl_mynn.F.html#MYM_LENGTH'>mym_length</A><A href='../../html_code/phys/module_bl_mynn.F.html#module_bl_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYM_LENGTH_1"> (                     &amp;<a name='416'>
            &amp;            kts,kte,            &amp;<a name='417'>
            &amp;            dz, zw,             &amp;<a name='418'>
            &amp;            rmo, flt, flq,      &amp;<a name='419'>
            &amp;            vt, vq,             &amp;<a name='420'>
            &amp;            qke,                &amp;<a name='421'>
            &amp;            dtv,                &amp;<a name='422'>
            &amp;            el,                 &amp;<a name='423'>
            &amp;            zi,theta,           &amp;<a name='424'>
            &amp;            qkw,Psig_bl,cldfra_bl1D,bl_mynn_mixlength,&amp;<a name='425'>
            &amp;            edmf_a1,edmf_qc1,bl_mynn_edmf,&amp;<a name='426'>
            &amp;            spp_pbl,rstoch_col)<a name='427'>
<font color=#447700>!<a name='428'></font>
       DO k = kts+1,kte<a name='429'>
          elq = el(k)*qkw(k)<a name='430'>
          pdk(k) = elq*( sm(k)*gm (k)+&amp;<a name='431'>
               &amp;sh(k)*gh (k) )<a name='432'>
          pdt(k) = elq*  sh(k)*dtl(k)**2<a name='433'>
          pdq(k) = elq*  sh(k)*dqw(k)**2<a name='434'>
          pdc(k) = elq*  sh(k)*dtl(k)*dqw(k)<a name='435'>
       END DO<a name='436'>
<font color=#447700>!<a name='437'></font>
<font color=#447700>!   **  Strictly, vkz*h(i,j) -&gt; vk*( 0.5*dz(1)*h(i,j)+z0 )  **<a name='438'></font>
       vkz = vk*0.5*dz(kts)<a name='439'>
<font color=#447700>!<a name='440'></font>
       elv = 0.5*( el(kts+1)+el(kts) ) /  vkz <a name='441'>
       qke(kts) = ust**2 * ( b1*pmz*elv    )**(2.0/3.0)<a name='442'>
<font color=#447700>!<a name='443'></font>
       phm      = phh*b2 / ( b1*pmz/elv**2 )**(1.0/3.0)<a name='444'>
       tsq(kts) = phm*( flt/ust )**2<a name='445'>
       qsq(kts) = phm*( flq/ust )**2<a name='446'>
       cov(kts) = phm*( flt/ust )*( flq/ust )<a name='447'>
<font color=#447700>!<a name='448'></font>
       DO k = kts+1,kte-1<a name='449'>
          b1l = b1*0.25*( el(k+1)+el(k) )<a name='450'>
          tmpq=MAX(b1l*( pdk(k+1)+pdk(k) ),qkemin)<a name='451'>
<font color=#447700>!          PRINT *,'tmpqqqqq',tmpq,pdk(k+1),pdk(k)<a name='452'></font>
          qke(k) = tmpq**(2.0/3.0)<a name='453'>
<a name='454'>
<font color=#447700>!<a name='455'></font>
          IF ( qke(k) .LE. 0.0 ) THEN<a name='456'>
             b2l = 0.0<a name='457'>
          ELSE<a name='458'>
             b2l = b2*( b1l/b1 ) / SQRT( qke(k) )<a name='459'>
          END IF<a name='460'>
<font color=#447700>!<a name='461'></font>
          tsq(k) = b2l*( pdt(k+1)+pdt(k) )<a name='462'>
          qsq(k) = b2l*( pdq(k+1)+pdq(k) )<a name='463'>
          cov(k) = b2l*( pdc(k+1)+pdc(k) )<a name='464'>
       END DO<a name='465'>
<a name='466'>
<font color=#447700>!<a name='467'></font>
    END DO<a name='468'>
<a name='469'>
<font color=#447700>!!    qke(kts)=qke(kts+1)<a name='470'></font>
<font color=#447700>!!    tsq(kts)=tsq(kts+1)<a name='471'></font>
<font color=#447700>!!    qsq(kts)=qsq(kts+1)<a name='472'></font>
<font color=#447700>!!    cov(kts)=cov(kts+1)<a name='473'></font>
<a name='474'>
    qke(kte)=qke(kte-1)<a name='475'>
    tsq(kte)=tsq(kte-1)<a name='476'>
    qsq(kte)=qsq(kte-1)<a name='477'>
    cov(kte)=cov(kte-1)<a name='478'>
<a name='479'>
<font color=#447700>!<a name='480'></font>
<font color=#447700>!    RETURN<a name='481'></font>
<a name='482'>
  END SUBROUTINE mym_initialize<a name='483'>
  <a name='484'>
<font color=#447700>!<a name='485'></font>
<font color=#447700>! ==================================================================<a name='486'></font>
<font color=#447700>!     SUBROUTINE  mym_level2:<a name='487'></font>
<font color=#447700>!<a name='488'></font>
<font color=#447700>!     Input variables:    see subroutine mym_initialize<a name='489'></font>
<font color=#447700>!<a name='490'></font>
<font color=#447700>!     Output variables:<a name='491'></font>
<font color=#447700>!       dtl(nx,nz,ny) : Vertical gradient of Theta_l             (K/m)<a name='492'></font>
<font color=#447700>!       dqw(nx,nz,ny) : Vertical gradient of Q_w<a name='493'></font>
<font color=#447700>!       dtv(nx,nz,ny) : Vertical gradient of Theta_V             (K/m)<a name='494'></font>
<font color=#447700>!       gm (nx,nz,ny) : G_M divided by L^2/q^2                (s^(-2))<a name='495'></font>
<font color=#447700>!       gh (nx,nz,ny) : G_H divided by L^2/q^2                (s^(-2))<a name='496'></font>
<font color=#447700>!       sm (nx,nz,ny) : Stability function for momentum, at Level 2<a name='497'></font>
<font color=#447700>!       sh (nx,nz,ny) : Stability function for heat, at Level 2<a name='498'></font>
<font color=#447700>!<a name='499'></font>
<font color=#447700>!       These are defined on the walls of the grid boxes.<a name='500'></font>
<font color=#447700>!<a name='501'></font>
<A NAME='MYM_LEVEL2'><A href='../../html_code/phys/module_bl_mynn.F.html#MYM_LEVEL2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='502'>
  <font color=#993300>SUBROUTINE  </font><font color=#cc0000>mym_level2</font> (kts,kte,&amp; <A href='../../call_to/MYM_LEVEL2.html' TARGET='index'>2</A><a name='503'>
       &amp;            dz, &amp;<a name='504'>
       &amp;            u, v, thl, qw, &amp;<a name='505'>
       &amp;            ql, vt, vq, &amp;<a name='506'>
       &amp;            dtl, dqw, dtv, gm, gh, sm, sh )<a name='507'>
<font color=#447700>!<a name='508'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='509'></font>
<a name='510'>
    INTEGER, INTENT(IN)   :: kts,kte<a name='511'>
    REAL, DIMENSION(kts:kte), INTENT(in) :: dz<a name='512'>
    REAL, DIMENSION(kts:kte), INTENT(in) :: u,v,thl,qw,ql,vt,vq<a name='513'>
<a name='514'>
    REAL, DIMENSION(kts:kte), INTENT(out) :: &amp;<a name='515'>
         &amp;dtl,dqw,dtv,gm,gh,sm,sh<a name='516'>
<a name='517'>
    INTEGER :: k<a name='518'>
<a name='519'>
    REAL :: rfc,f1,f2,rf1,rf2,smc,shc,&amp;<a name='520'>
         &amp;ri1,ri2,ri3,ri4,duz,dtz,dqz,vtt,vqq,dtq,dzk,afk,abk,ri,rf<a name='521'>
<a name='522'>
<font color=#447700>!JOE-Canuto/Kitamura mod<a name='523'></font>
    REAL ::   a2den<a name='524'>
<font color=#447700>!JOE-end<a name='525'></font>
<a name='526'>
<font color=#447700>!    ev  = 2.5e6<a name='527'></font>
<font color=#447700>!    tv0 = 0.61*tref<a name='528'></font>
<font color=#447700>!    tv1 = 1.61*tref<a name='529'></font>
<font color=#447700>!    gtr = 9.81/tref<a name='530'></font>
<font color=#447700>!<a name='531'></font>
    rfc = g1/( g1+g2 )<a name='532'>
    f1  = b1*( g1-c1 ) +3.0*a2*( 1.0    -c2 )*( 1.0-c5 ) &amp;<a name='533'>
    &amp;                   +2.0*a1*( 3.0-2.0*c2 )<a name='534'>
    f2  = b1*( g1+g2 ) -3.0*a1*( 1.0    -c2 )<a name='535'>
    rf1 = b1*( g1-c1 )/f1<a name='536'>
    rf2 = b1*  g1     /f2<a name='537'>
    smc = a1 /a2*  f1/f2<a name='538'>
    shc = 3.0*a2*( g1+g2 )<a name='539'>
<font color=#447700>!<a name='540'></font>
    ri1 = 0.5/smc<a name='541'>
    ri2 = rf1*smc<a name='542'>
    ri3 = 4.0*rf2*smc -2.0*ri2<a name='543'>
    ri4 = ri2**2<a name='544'>
<font color=#447700>!<a name='545'></font>
    DO k = kts+1,kte<a name='546'>
       dzk = 0.5  *( dz(k)+dz(k-1) )<a name='547'>
       afk = dz(k)/( dz(k)+dz(k-1) )<a name='548'>
       abk = 1.0 -afk<a name='549'>
       duz = ( u(k)-u(k-1) )**2 +( v(k)-v(k-1) )**2<a name='550'>
       duz =   duz                    /dzk**2<a name='551'>
       dtz = ( thl(k)-thl(k-1) )/( dzk )<a name='552'>
       dqz = ( qw(k)-qw(k-1) )/( dzk )<a name='553'>
<font color=#447700>!<a name='554'></font>
       vtt =  1.0 +vt(k)*abk +vt(k-1)*afk  <font color=#447700>! Beta-theta in NN09, Eq. 39<a name='555'></font>
       vqq =  tv0 +vq(k)*abk +vq(k-1)*afk  <font color=#447700>! Beta-q<a name='556'></font>
       dtq =  vtt*dtz +vqq*dqz<a name='557'>
<font color=#447700>!<a name='558'></font>
       dtl(k) =  dtz<a name='559'>
       dqw(k) =  dqz<a name='560'>
       dtv(k) =  dtq<a name='561'>
<font color=#447700>!?      dtv(i,j,k) =  dtz +tv0*dqz<a name='562'></font>
<font color=#447700>!?   :              +( ev/pi0(i,j,k)-tv1 )<a name='563'></font>
<font color=#447700>!?   :              *( ql(i,j,k)-ql(i,j,k-1) )/( dzk*h(i,j) )<a name='564'></font>
<font color=#447700>!<a name='565'></font>
       gm (k) =  duz<a name='566'>
       gh (k) = -dtq*gtr<a name='567'>
<font color=#447700>!<a name='568'></font>
<font color=#447700>!   **  Gradient Richardson number  **<a name='569'></font>
       ri = -gh(k)/MAX( duz, 1.0e-10 )<a name='570'>
<a name='571'>
<font color=#447700>!JOE-Canuto/Kitamura mod<a name='572'></font>
    IF (CKmod .eq. 1) THEN<a name='573'>
       a2den = 1. + MAX(ri,0.0)<a name='574'>
    ELSE<a name='575'>
       a2den = 1. + 0.0<a name='576'>
    ENDIF<a name='577'>
<a name='578'>
       rfc = g1/( g1+g2 )<a name='579'>
       f1  = b1*( g1-c1 ) +3.0*(a2/a2den)*( 1.0    -c2 )*( 1.0-c5 ) &amp;<a name='580'>
    &amp;                     +2.0*a1*( 3.0-2.0*c2 )<a name='581'>
       f2  = b1*( g1+g2 ) -3.0*a1*( 1.0    -c2 )<a name='582'>
       rf1 = b1*( g1-c1 )/f1<a name='583'>
       rf2 = b1*  g1     /f2<a name='584'>
       smc = a1 /(a2/a2den)*  f1/f2<a name='585'>
       shc = 3.0*(a2/a2den)*( g1+g2 )<a name='586'>
<a name='587'>
       ri1 = 0.5/smc<a name='588'>
       ri2 = rf1*smc<a name='589'>
       ri3 = 4.0*rf2*smc -2.0*ri2<a name='590'>
       ri4 = ri2**2<a name='591'>
<font color=#447700>!JOE-end<a name='592'></font>
<a name='593'>
<font color=#447700>!   **  Flux Richardson number  **<a name='594'></font>
       rf = MIN( ri1*( ri+ri2-SQRT(ri**2-ri3*ri+ri4) ), rfc )<a name='595'>
<font color=#447700>!<a name='596'></font>
       sh (k) = shc*( rfc-rf )/( 1.0-rf )<a name='597'>
       sm (k) = smc*( rf1-rf )/( rf2-rf ) * sh(k)<a name='598'>
    END DO<a name='599'>
<font color=#447700>!<a name='600'></font>
    RETURN<a name='601'>
<a name='602'>
  END SUBROUTINE mym_level2<a name='603'>
<a name='604'>
<font color=#447700>! ==================================================================<a name='605'></font>
<font color=#447700>!     SUBROUTINE  mym_length:<a name='606'></font>
<font color=#447700>!<a name='607'></font>
<font color=#447700>!     Input variables:    see subroutine mym_initialize<a name='608'></font>
<font color=#447700>!<a name='609'></font>
<font color=#447700>!     Output variables:   see subroutine mym_initialize<a name='610'></font>
<font color=#447700>!<a name='611'></font>
<font color=#447700>!     Work arrays:<a name='612'></font>
<font color=#447700>!       elt(nx,ny)      : Length scale depending on the PBL depth    (m)<a name='613'></font>
<font color=#447700>!       vsc(nx,ny)      : Velocity scale q_c                       (m/s)<a name='614'></font>
<font color=#447700>!                         at first, used for computing elt<a name='615'></font>
<font color=#447700>!<a name='616'></font>
<font color=#447700>!     NOTE: the mixing lengths are meant to be calculated at the full-<a name='617'></font>
<font color=#447700>!           sigmal levels (or interfaces beween the model layers).<a name='618'></font>
<font color=#447700>!<a name='619'></font>
<A NAME='MYM_LENGTH'><A href='../../html_code/phys/module_bl_mynn.F.html#MYM_LENGTH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='620'>
  <font color=#993300>SUBROUTINE  </font><font color=#cc0000>mym_length</font> (                     &amp;  <A href='../../call_to/MYM_LENGTH.html' TARGET='index'>2</A><a name='621'>
    &amp;            kts,kte,                      &amp;<a name='622'>
    &amp;            dz, zw,                       &amp;<a name='623'>
    &amp;            rmo, flt, flq,                &amp;<a name='624'>
    &amp;            vt, vq,                       &amp;<a name='625'>
    &amp;            qke,                          &amp;<a name='626'>
    &amp;            dtv,                          &amp;<a name='627'>
    &amp;            el,                           &amp;<a name='628'>
    &amp;            zi,theta,                     &amp;<a name='629'>
    &amp;            qkw,Psig_bl,cldfra_bl1D,bl_mynn_mixlength,&amp;<a name='630'>
    &amp;            edmf_a1,edmf_qc1,bl_mynn_edmf,&amp;<a name='631'>
    &amp;            spp_pbl,rstoch_col)<a name='632'>
    <a name='633'>
<font color=#447700>!-------------------------------------------------------------------<a name='634'></font>
<a name='635'>
    INTEGER, INTENT(IN)   :: kts,kte<a name='636'>
    INTEGER, INTENT(IN)   :: bl_mynn_mixlength,bl_mynn_edmf<a name='637'>
    REAL, DIMENSION(kts:kte), INTENT(in)   :: dz<a name='638'>
    REAL, DIMENSION(kts:kte+1), INTENT(in) :: zw<a name='639'>
    REAL, INTENT(in) :: rmo,flt,flq,Psig_bl<a name='640'>
    REAL, DIMENSION(kts:kte), INTENT(IN)   :: qke,vt,vq,cldfra_bl1D,&amp;<a name='641'>
                                              edmf_a1,edmf_qc1<a name='642'>
    REAL, DIMENSION(kts:kte), INTENT(out)  :: qkw, el<a name='643'>
    REAL, DIMENSION(kts:kte), INTENT(in)   :: dtv<a name='644'>
<a name='645'>
    REAL :: elt,vsc<a name='646'>
<a name='647'>
    REAL, DIMENSION(kts:kte), INTENT(IN) :: theta<a name='648'>
    REAL, DIMENSION(kts:kte) :: qtke,elBLmin,elBLavg,thetaw<a name='649'>
    REAL :: wt,wt2,zi,zi2,h1,h2,hs,elBLmin0,elBLavg0<a name='650'>
<a name='651'>
    <font color=#447700>! THE FOLLOWING CONSTANTS ARE IMPORTANT FOR REGULATING THE<a name='652'></font>
    <font color=#447700>! MIXING LENGTHS:<a name='653'></font>
    REAL :: cns,   &amp;   <font color=#447700>! for surface layer (els) in stable conditions<a name='654'></font>
            alp1,  &amp;   <font color=#447700>! for turbulent length scale (elt)<a name='655'></font>
            alp2,  &amp;   <font color=#447700>! for buoyancy length scale (elb)<a name='656'></font>
            alp3,  &amp;   <font color=#447700>! for buoyancy enhancement factor of elb<a name='657'></font>
            alp4,  &amp;   <font color=#447700>! for surface layer (els) in unstable conditions<a name='658'></font>
            alp5       <font color=#447700>! for BouLac mixing length<a name='659'></font>
<a name='660'>
    <font color=#447700>!THE FOLLOWING LIMITS DO NOT DIRECTLY AFFECT THE ACTUAL PBLH.<a name='661'></font>
    <font color=#447700>!THEY ONLY IMPOSE LIMITS ON THE CALCULATION OF THE MIXING LENGTH <a name='662'></font>
    <font color=#447700>!SCALES SO THAT THE BOULAC MIXING LENGTH (IN FREE ATMOS) DOES<a name='663'></font>
    <font color=#447700>!NOT ENCROACH UPON THE BOUNDARY LAYER MIXING LENGTH (els, elb &amp; elt).<a name='664'></font>
    REAL, PARAMETER :: minzi = 300.  <font color=#447700>!min mixed-layer height<a name='665'></font>
    REAL, PARAMETER :: maxdz = 750.  <font color=#447700>!max (half) transition layer depth<a name='666'></font>
                                     <font color=#447700>!=0.3*2500 m PBLH, so the transition<a name='667'></font>
                                     <font color=#447700>!layer stops growing for PBLHs &gt; 2.5 km.<a name='668'></font>
    REAL, PARAMETER :: mindz = 300.  <font color=#447700>!300  !min (half) transition layer depth<a name='669'></font>
<a name='670'>
    <font color=#447700>!SURFACE LAYER LENGTH SCALE MODS TO REDUCE IMPACT IN UPPER BOUNDARY LAYER<a name='671'></font>
    REAL, PARAMETER :: ZSLH = 100. <font color=#447700>! Max height correlated to surface conditions (m)<a name='672'></font>
    REAL, PARAMETER :: CSL = 2.    <font color=#447700>! CSL = constant of proportionality to L O(1)<a name='673'></font>
    REAL :: z_m<a name='674'>
<a name='675'>
<a name='676'>
    INTEGER :: i,j,k<a name='677'>
    REAL :: afk,abk,zwk,zwk1,dzk,qdz,vflx,bv,tau_cloud,elb,els,els1,elf, &amp;<a name='678'>
            &amp; el_stab,el_unstab,el_mf,el_stab_mf,elb_mf,PBLH_PLUS_ENT<a name='679'>
<a name='680'>
    INTEGER, INTENT(IN)   :: spp_pbl<a name='681'>
    REAL, DIMENSION(kts:kte), INTENT(in)   :: rstoch_col<a name='682'>
<a name='683'>
    IF ( bl_mynn_mixlength .EQ. 0 ) THEN<a name='684'>
       cns  = 2.7<a name='685'>
       alp1 = 0.23<a name='686'>
       alp2 = 1.0<a name='687'>
       alp3 = 5.0<a name='688'>
       alp4 = 100.<a name='689'>
       alp5 = 0.4<a name='690'>
    ELSEIF ( bl_mynn_mixlength .EQ. 1 ) THEN<a name='691'>
       cns  = 2.3<a name='692'>
       alp1 = 0.23<a name='693'>
       alp2 = 0.6<a name='694'>
       alp3 = 3.0<a name='695'>
       alp4 = 20.<a name='696'>
       alp5 = 0.4<a name='697'>
    ELSEIF ( bl_mynn_mixlength .GE. 2 ) THEN<a name='698'>
       cns  = 3.5<a name='699'>
       alp1 = 0.23<a name='700'>
       alp2 = 0.25<a name='701'>
       alp3 = 3.0<a name='702'>
       alp4 = 10.<a name='703'>
       alp5 = 0.3<a name='704'>
    ENDIF<a name='705'>
<a name='706'>
<font color=#447700>!    tv0 = 0.61*tref<a name='707'></font>
<font color=#447700>!    gtr = 9.81/tref<a name='708'></font>
<font color=#447700>!<a name='709'></font>
<font color=#447700>!   Impose limits on the height integration for elt as well <a name='710'></font>
<font color=#447700>!   as the transition layer depth<a name='711'></font>
    IF ( bl_mynn_mixlength .EQ. 0 ) THEN<a name='712'>
       zi2=10000.  <font color=#447700>!originally integrated to model top, not just 10 km.<a name='713'></font>
    ELSE<a name='714'>
       zi2=MAX(zi,minzi)<a name='715'>
    ENDIF<a name='716'>
    h1=MAX(0.3*zi2,mindz)<a name='717'>
    h1=MIN(h1,maxdz)         <font color=#447700>! 1/2 transition layer depth<a name='718'></font>
    h2=h1/2.0                <font color=#447700>! 1/4 transition layer depth<a name='719'></font>
<a name='720'>
    qtke(kts)=MAX(qke(kts)/2.,0.01) <font color=#447700>!tke at full sigma levels<a name='721'></font>
    thetaw(kts)=<A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_bl_mynn.F.html#module_bl_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_13">(kts)          <font color=#447700>!theta at full-sigma levels<a name='722'></font>
    qkw(kts) = SQRT(MAX(qke(kts),1.0e-10))<a name='723'>
<a name='724'>
    DO k = kts+1,kte<a name='725'>
       afk = dz(k)/( dz(k)+dz(k-1) )<a name='726'>
       abk = 1.0 -afk<a name='727'>
       qkw(k) = SQRT(MAX(qke(k)*abk+qke(k-1)*afk,1.0e-3))<a name='728'>
       qtke(k) = (qkw(k)**2.)/2.    <font color=#447700>! q -&gt; TKE<a name='729'></font>
       thetaw(k)= <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_bl_mynn.F.html#module_bl_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_14">(k)*abk + theta(k-1)*afk<a name='730'>
    END DO<a name='731'>
<font color=#447700>!<a name='732'></font>
    elt = 1.0e-5<a name='733'>
    vsc = 1.0e-5<a name='734'>
<font color=#447700>!<a name='735'></font>
<font color=#447700>!   **  Strictly, zwk*h(i,j) -&gt; ( zwk*h(i,j)+z0 )  **<a name='736'></font>
<font color=#447700>!   Only integrate to top of PBL (+ transition/entrainment layer),<a name='737'></font>
<font color=#447700>!   since TKE aloft is not relevant. <a name='738'></font>
<font color=#447700>!<a name='739'></font>
    IF ( bl_mynn_mixlength .EQ. 2 ) THEN<a name='740'>
       PBLH_PLUS_ENT = MAX(zi, 100.)<a name='741'>
    ELSE<a name='742'>
       PBLH_PLUS_ENT = zi2+h1<a name='743'>
    ENDIF<a name='744'>
    k = kts+1<a name='745'>
    zwk = zw(k)<a name='746'>
    DO WHILE (zwk .LE. PBLH_PLUS_ENT)<a name='747'>
       dzk = 0.5*( dz(k)+dz(k-1) )<a name='748'>
       qdz = MAX( qkw(k)-qmin, 0.03 )*dzk<a name='749'>
             elt = elt +qdz*zwk<a name='750'>
             vsc = vsc +qdz<a name='751'>
       k   = k+1<a name='752'>
       zwk = zw(k)<a name='753'>
    END DO<a name='754'>
<font color=#447700>!<a name='755'></font>
    elt =  MAX(alp1*elt/vsc, 10.)<a name='756'>
    vflx = ( vt(kts)+1.0 )*flt +( vq(kts)+tv0 )*flq<a name='757'>
    vsc = ( gtr*elt*MAX( vflx, 0.0 ) )**(1.0/3.0)<a name='758'>
<font color=#447700>!<a name='759'></font>
<font color=#447700>!   **  Strictly, el(i,j,1) is not zero.  **<a name='760'></font>
    el(kts) = 0.0<a name='761'>
<font color=#447700>!<a name='762'></font>
    IF ( bl_mynn_mixlength .EQ. 1 ) THEN<a name='763'>
       <font color=#447700>! COMPUTE BouLac mixing length<a name='764'></font>
       CALL <A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH'>boulac_length</A><A href='../../html_code/phys/module_bl_mynn.F.html#module_bl_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BOULAC_LENGTH_1">(kts,kte,zw,dz,qtke,thetaw,elBLmin,elBLavg)<a name='765'>
    ENDIF<a name='766'>
<a name='767'>
    DO k = kts+1,kte<a name='768'>
       zwk = zw(k)              <font color=#447700>!full-sigma levels<a name='769'></font>
       IF (k .EQ. kts+1) zwk1=zwk <a name='770'>
<a name='771'>
       <font color=#447700>!   **  Length scale limited by the buoyancy effect  **<a name='772'></font>
<a name='773'>
       IF ( dtv(k) .GT. 0.0 ) THEN<a name='774'>
         bv  = SQRT( gtr*dtv(k) )<a name='775'>
<a name='776'>
         IF ( bl_mynn_mixlength .EQ. 0 ) THEN <font color=#447700>! use default elb formulation<a name='777'></font>
           elb = alp2*qkw(k) / bv &amp;     <a name='778'>
                &amp;       *( 1.0 + alp3/alp2*&amp;<a name='779'>
                &amp;SQRT( vsc/( bv*elt ) ) )<a name='780'>
           elf = alp2 * qkw(k)/bv<a name='781'>
<a name='782'>
         ELSE IF ( bl_mynn_mixlength .EQ. 1 ) THEN <font color=#447700>! use default elb<a name='783'></font>
           elb = alp2*qkw(k) / bv &amp;                <font color=#447700>! formulation,<a name='784'></font>
                &amp;       *( 1.0 + alp3/alp2*&amp;       <font color=#447700>! except keep<a name='785'></font>
                &amp;SQRT( vsc/( bv*elt ) ) )          <font color=#447700>! elb bounded by<a name='786'></font>
           elb = MIN(elb, zwk)                     <font color=#447700>! zwk<a name='787'></font>
           elf = alp2 * qkw(k)/bv                  <a name='788'>
<a name='789'>
         ELSE IF ( bl_mynn_mixlength .GE. 2 ) THEN <font color=#447700>! use new elb formulation<a name='790'></font>
           elb_mf = alp2*qkw(k) / bv &amp;<a name='791'>
                &amp;       *( 1.0 + alp3/alp2*&amp;<a name='792'>
                &amp;SQRT( vsc/( bv*elt ) ) )<a name='793'>
           elb = MIN(alp2*qkw(k)/bv, zwk)<a name='794'>
           elf = elb<a name='795'>
           IF (zwk &gt; zi .AND. elf &gt; 500.) THEN<a name='796'>
             <font color=#447700>! COMPUTE BouLac mixing length<a name='797'></font>
             CALL <A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH0'>boulac_length0</A><A href='../../html_code/phys/module_bl_mynn.F.html#module_bl_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BOULAC_LENGTH0_1">(k,kts,kte,zw,dz,qtke,thetaw,elBLmin0,elBLavg0)<a name='798'>
             elf = alp5*elBLavg0<a name='799'>
           ENDIF<a name='800'>
<a name='801'>
         END IF <a name='802'>
<a name='803'>
       ELSE<a name='804'>
<a name='805'>
         IF ( bl_mynn_mixlength .LE. 1 ) THEN <font color=#447700>! use default elb formulation<a name='806'></font>
           elb = 1.0e10<a name='807'>
           elf = elb<a name='808'>
<a name='809'>
         ELSE IF ( bl_mynn_mixlength .GE. 2 ) THEN<a name='810'>
           <font color=#447700>! use version in development for RAP/HRRR 2016<a name='811'></font>
           <font color=#447700>! JAYMES-<a name='812'></font>
           <font color=#447700>! tau_cloud is an eddy turnover timescale;<a name='813'></font>
           <font color=#447700>! see Teixeira and Cheinet (2004), Eq. 1, and<a name='814'></font>
           <font color=#447700>! Cheinet and Teixeira (2003), Eq. 7.  The<a name='815'></font>
           <font color=#447700>! coefficient 0.5 is tuneable. Expression in<a name='816'></font>
           <font color=#447700>! denominator is identical to vsc (a convective<a name='817'></font>
           <font color=#447700>! velocity scale), except that elt is relpaced<a name='818'></font>
           <font color=#447700>! by zi, and zero is replaced by 1.0e-4 to<a name='819'></font>
           <font color=#447700>! prevent division by zero.<a name='820'></font>
<a name='821'>
           tau_cloud = MIN(MAX(0.5*zi/((gtr*zi*MAX(flt,1.0e-4))**(1.0/3.0)),10.),100.)<a name='822'>
           <font color=#447700>!minimize influence of surface heat flux on tau far away from the PBLH.<a name='823'></font>
           wt=.5*TANH((zwk - (zi2+h1))/h2) + .5<a name='824'>
           tau_cloud = tau_cloud*(1.-wt) + 50.*wt<a name='825'>
<a name='826'>
           elb = MIN(tau_cloud*SQRT(MIN(qtke(k),20.)), zwk)<a name='827'>
           elf = elb<a name='828'>
           elb_mf = elb<a name='829'>
           IF (zwk &gt; zi .AND. elf &gt; 500.) THEN<a name='830'>
             <font color=#447700>! COMPUTE BouLac mixing length for dry conditions in free atmosphere<a name='831'></font>
             CALL <A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH0'>boulac_length0</A><A href='../../html_code/phys/module_bl_mynn.F.html#module_bl_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BOULAC_LENGTH0_2">(k,kts,kte,zw,dz,qtke,thetaw,elBLmin0,elBLavg0)<a name='832'>
             elf = alp5*elBLavg0*(1.-cldfra_bl1D(k)) + elf*cldfra_bl1D(k)<a name='833'>
           END IF<a name='834'>
           elf = elf*(1.-cldfra_bl1D(k)) + elb*cldfra_bl1D(k)<a name='835'>
<a name='836'>
         END IF<a name='837'>
       END IF<a name='838'>
<a name='839'>
       z_m = MAX(0.,zwk - 4.)<a name='840'>
<a name='841'>
<font color=#447700>!   **  Length scale in the surface layer  **<a name='842'></font>
       IF ( rmo .GT. 0.0 ) THEN<a name='843'>
          els  = vk*zwk/(1.0+cns*MIN( zwk*rmo, zmax ))<a name='844'>
          els1 = vk*z_m/(1.0+cns*MIN( zwk*rmo, zmax ))<a name='845'>
       ELSE<a name='846'>
          els  =  vk*zwk*( 1.0 - alp4* zwk*rmo )**0.2<a name='847'>
          els1 =  vk*z_m*( 1.0 - alp4* zwk*rmo )**0.2<a name='848'>
       END IF<a name='849'>
<a name='850'>
<font color=#447700>!<a name='851'></font>
<font color=#447700>!   ** HARMONC AVERGING OF MIXING LENGTH SCALES: <a name='852'></font>
<font color=#447700>!       el(k) =      MIN(elb/( elb/elt+elb/els+1.0 ),elf)<a name='853'></font>
<font color=#447700>!       el(k) =      elb/( elb/elt+elb/els+1.0 )<a name='854'></font>
<a name='855'>
       wt=.5*TANH((zwk - (zi2+h1))/h2) + .5<a name='856'>
<a name='857'>
       IF ( bl_mynn_mixlength .EQ. 0 ) THEN<a name='858'>
          el(k) = MIN(elb/( elb/elt+elb/els+1.0 ),elf)<a name='859'>
<a name='860'>
       ELSE IF ( bl_mynn_mixlength .EQ. 1 ) THEN <a name='861'>
          <font color=#447700>!add blending to use BouLac mixing length in free atmos;<a name='862'></font>
          <font color=#447700>!defined relative to the PBLH (zi) + transition layer (h1)<a name='863'></font>
          el(k) = MIN(elb/( elb/elt+elb/els+1.0 ),elf)<a name='864'>
          el(k) = el(k)*(1.-wt) + alp5*elBLmin(k)*wt<a name='865'>
<a name='866'>
       <font color=#447700>!JAYMES- el_stab &amp; el_unstab blending begin ( bl_mynn_mixlength opt)<a name='867'></font>
       ELSE IF ( bl_mynn_mixlength .GE. 2 ) THEN<a name='868'>
          el_unstab = els/(1. + (els1/elt))<a name='869'>
<a name='870'>
          el_stab    = MIN(el_unstab, elb) <a name='871'>
          el_stab_mf = MIN(el_unstab, elb_mf)<a name='872'>
<a name='873'>
          IF (bl_mynn_edmf &gt; 0 .AND. edmf_a1(kts)&gt;0.0) THEN<a name='874'>
             <font color=#447700>!Force version of buiyncay mixing length with the enhancement factor to be used <a name='875'></font>
             <font color=#447700>!when the mass-flux scheme is active.<a name='876'></font>
              el(k) = el_stab_mf<a name='877'>
          ELSE<a name='878'>
              el(k) = el_stab<a name='879'>
          ENDIF<a name='880'>
          el(k) = el(k)*(1.-wt) + elf*wt<a name='881'>
       END IF<a name='882'>
<a name='883'>
       IF ( bl_mynn_mixlength .GE. 1 ) THEN <font color=#447700>! include scale-awareness, except for original MYNN<a name='884'></font>
         el(k) = el(k)*Psig_bl<a name='885'>
       END IF<a name='886'>
<a name='887'>
<font color=#447700>!      Stochastic perturbations of turbulent mixing length<a name='888'></font>
       if (spp_pbl==1) then<a name='889'>
          if (k.lt.25) then<a name='890'>
             el(k)= el(k) + el(k)* rstoch_col(k) * 1.5 * MAX(exp(-MAX(zwk-3000.,0.0)/2000.),0.01)<a name='891'>
          endif<a name='892'>
       endif<a name='893'>
<a name='894'>
<a name='895'>
       IF ( wrf_at_debug_level(MYNN_DBG_LVL) ) THEN<a name='896'>
         IF (el(k) &gt; 1000.) THEN<a name='897'>
           WRITE ( mynn_message , FMT='(A,F7.0,I5,4F7.0)' ) &amp;<a name='898'>
           ' MYNN; mym_length; LARGE el,k,elb,elt,elf,tau:'&amp;<a name='899'>
                                , el(k),k,elb,elt,elf,tau_cloud<a name='900'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#module_bl_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_502"> ( 0 , mynn_message )<a name='901'>
         ENDIF<a name='902'>
       ENDIF<a name='903'>
<a name='904'>
    END DO<a name='905'>
<font color=#447700>!<a name='906'></font>
    RETURN<a name='907'>
<a name='908'>
  END SUBROUTINE mym_length<a name='909'>
<a name='910'>
<font color=#447700>!JOE- BouLac Code Start -<a name='911'></font>
<a name='912'>
<font color=#447700>! ==================================================================<a name='913'></font>
<A NAME='BOULAC_LENGTH0'><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH0' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='914'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>boulac_length0</font>(k,kts,kte,zw,dz,qtke,theta,lb1,lb2) <A href='../../call_to/BOULAC_LENGTH0.html' TARGET='index'>2</A><a name='915'>
<font color=#447700>!<a name='916'></font>
<font color=#447700>!    NOTE: This subroutine was taken from the BouLac scheme in WRF-ARW<a name='917'></font>
<font color=#447700>!          and modified for integration into the MYNN PBL scheme.<a name='918'></font>
<font color=#447700>!          WHILE loops were added to reduce the computational expense.<a name='919'></font>
<font color=#447700>!          This subroutine computes the length scales up and down<a name='920'></font>
<font color=#447700>!          and then computes the min, average of the up/down<a name='921'></font>
<font color=#447700>!          length scales, and also considers the distance to the<a name='922'></font>
<font color=#447700>!          surface.<a name='923'></font>
<font color=#447700>!<a name='924'></font>
<font color=#447700>!      dlu = the distance a parcel can be lifted upwards give a finite<a name='925'></font>
<font color=#447700>!            amount of TKE.<a name='926'></font>
<font color=#447700>!      dld = the distance a parcel can be displaced downwards given a<a name='927'></font>
<font color=#447700>!            finite amount of TKE.<a name='928'></font>
<font color=#447700>!      lb1 = the minimum of the length up and length down<a name='929'></font>
<font color=#447700>!      lb2 = the average of the length up and length down<a name='930'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='931'></font>
<a name='932'>
     INTEGER, INTENT(IN) :: k,kts,kte<a name='933'>
     REAL, DIMENSION(kts:kte), INTENT(IN) :: qtke,dz,theta<a name='934'>
     REAL, INTENT(OUT) :: lb1,lb2<a name='935'>
     REAL, DIMENSION(kts:kte+1), INTENT(IN) :: zw<a name='936'>
<a name='937'>
     <font color=#447700>!LOCAL VARS<a name='938'></font>
     INTEGER :: izz, found<a name='939'>
     REAL :: dlu,dld<a name='940'>
     REAL :: dzt, zup, beta, zup_inf, bbb, tl, zdo, zdo_sup, zzz<a name='941'>
<a name='942'>
<a name='943'>
     <font color=#447700>!----------------------------------<a name='944'></font>
     <font color=#447700>! FIND DISTANCE UPWARD             <a name='945'></font>
     <font color=#447700>!----------------------------------<a name='946'></font>
     zup=0.<a name='947'>
     dlu=zw(kte+1)-zw(k)-dz(k)/2.<a name='948'>
     zzz=0.<a name='949'>
     zup_inf=0.<a name='950'>
     beta=g/theta(k)           <font color=#447700>!Buoyancy coefficient<a name='951'></font>
<a name='952'>
     <font color=#447700>!print*,"FINDING Dup, k=",k," zw=",zw(k)<a name='953'></font>
<a name='954'>
     if (k .lt. kte) then      <font color=#447700>!cant integrate upwards from highest level<a name='955'></font>
        found = 0<a name='956'>
        izz=k<a name='957'>
        DO WHILE (found .EQ. 0)<a name='958'>
<a name='959'>
           if (izz .lt. kte) then<a name='960'>
              dzt=dz(izz)                    <font color=#447700>! layer depth above<a name='961'></font>
              zup=zup-beta*theta(k)*dzt     <font color=#447700>! initial PE the parcel has at k<a name='962'></font>
              <font color=#447700>!print*,"  ",k,izz,theta(izz),dz(izz)<a name='963'></font>
              zup=zup+beta*(theta(izz+1)+theta(izz))*dzt/2. <font color=#447700>! PE gained by lifting a parcel to izz+1<a name='964'></font>
              zzz=zzz+dzt                   <font color=#447700>! depth of layer k to izz+1<a name='965'></font>
              <font color=#447700>!print*,"  PE=",zup," TKE=",qtke(k)," z=",zw(izz)<a name='966'></font>
              if (qtke(k).lt.zup .and. qtke(k).ge.zup_inf) then<a name='967'>
                 bbb=(theta(izz+1)-theta(izz))/dzt<a name='968'>
                 if (bbb .ne. 0.) then<a name='969'>
                    <font color=#447700>!fractional distance up into the layer where TKE becomes &lt; PE<a name='970'></font>
                    tl=(-beta*(theta(izz)-theta(k)) + &amp;<a name='971'>
                      &amp; sqrt( max(0.,(beta*(theta(izz)-theta(k)))**2. + &amp;<a name='972'>
                      &amp;       2.*bbb*beta*(qtke(k)-zup_inf))))/bbb/beta<a name='973'>
                 else<a name='974'>
                    if (theta(izz) .ne. theta(k))then<a name='975'>
                       tl=(qtke(k)-zup_inf)/(beta*(theta(izz)-theta(k)))<a name='976'>
                    else<a name='977'>
                       tl=0.<a name='978'>
                    endif<a name='979'>
                 endif<a name='980'>
                 dlu=zzz-dzt+tl<a name='981'>
                 <font color=#447700>!print*,"  FOUND Dup:",dlu," z=",zw(izz)," tl=",tl<a name='982'></font>
                 found =1<a name='983'>
              endif<a name='984'>
              zup_inf=zup<a name='985'>
              izz=izz+1<a name='986'>
           ELSE<a name='987'>
              found = 1<a name='988'>
           ENDIF<a name='989'>
<a name='990'>
        ENDDO<a name='991'>
<a name='992'>
     endif<a name='993'>
<a name='994'>
     <font color=#447700>!----------------------------------<a name='995'></font>
     <font color=#447700>! FIND DISTANCE DOWN               <a name='996'></font>
     <font color=#447700>!----------------------------------<a name='997'></font>
     zdo=0.<a name='998'>
     zdo_sup=0.<a name='999'>
     dld=zw(k)<a name='1000'>
     zzz=0.<a name='1001'>
<a name='1002'>
     <font color=#447700>!print*,"FINDING Ddown, k=",k," zwk=",zw(k)<a name='1003'></font>
     if (k .gt. kts) then  <font color=#447700>!cant integrate downwards from lowest level<a name='1004'></font>
<a name='1005'>
        found = 0<a name='1006'>
        izz=k<a name='1007'>
        DO WHILE (found .EQ. 0)<a name='1008'>
<a name='1009'>
           if (izz .gt. kts) then<a name='1010'>
              dzt=dz(izz-1)<a name='1011'>
              zdo=zdo+beta*theta(k)*dzt<a name='1012'>
              <font color=#447700>!print*,"  ",k,izz,theta(izz),dz(izz-1)<a name='1013'></font>
              zdo=zdo-beta*(theta(izz-1)+theta(izz))*dzt/2.<a name='1014'>
              zzz=zzz+dzt<a name='1015'>
              <font color=#447700>!print*,"  PE=",zdo," TKE=",qtke(k)," z=",zw(izz)<a name='1016'></font>
              if (qtke(k).lt.zdo .and. qtke(k).ge.zdo_sup) then<a name='1017'>
                 bbb=(theta(izz)-theta(izz-1))/dzt<a name='1018'>
                 if (bbb .ne. 0.) then<a name='1019'>
                    tl=(beta*(theta(izz)-theta(k))+ &amp;<a name='1020'>
                      &amp; sqrt( max(0.,(beta*(theta(izz)-theta(k)))**2. + &amp;<a name='1021'>
                      &amp;       2.*bbb*beta*(qtke(k)-zdo_sup))))/bbb/beta<a name='1022'>
                 else<a name='1023'>
                    if (theta(izz) .ne. theta(k)) then<a name='1024'>
                       tl=(qtke(k)-zdo_sup)/(beta*(theta(izz)-theta(k)))<a name='1025'>
                    else<a name='1026'>
                       tl=0.<a name='1027'>
                    endif<a name='1028'>
                 endif<a name='1029'>
                 dld=zzz-dzt+tl<a name='1030'>
                 <font color=#447700>!print*,"  FOUND Ddown:",dld," z=",zw(izz)," tl=",tl<a name='1031'></font>
                 found = 1<a name='1032'>
              endif<a name='1033'>
              zdo_sup=zdo<a name='1034'>
              izz=izz-1<a name='1035'>
           ELSE<a name='1036'>
              found = 1<a name='1037'>
           ENDIF<a name='1038'>
        ENDDO<a name='1039'>
<a name='1040'>
     endif<a name='1041'>
<a name='1042'>
     <font color=#447700>!----------------------------------<a name='1043'></font>
     <font color=#447700>! GET MINIMUM (OR AVERAGE)         <a name='1044'></font>
     <font color=#447700>!----------------------------------<a name='1045'></font>
     <font color=#447700>!The surface layer length scale can exceed z for large z/L,<a name='1046'></font>
     <font color=#447700>!so keep maximum distance down &gt; z.<a name='1047'></font>
     dld = min(dld,zw(k+1))<font color=#447700>!not used in PBL anyway, only free atmos<a name='1048'></font>
     lb1 = min(dlu,dld)     <font color=#447700>!minimum<a name='1049'></font>
     <font color=#447700>!JOE-fight floating point errors<a name='1050'></font>
     dlu=MAX(0.1,MIN(dlu,1000.))<a name='1051'>
     dld=MAX(0.1,MIN(dld,1000.))<a name='1052'>
     lb2 = sqrt(dlu*dld)    <font color=#447700>!average - biased towards smallest<a name='1053'></font>
     <font color=#447700>!lb2 = 0.5*(dlu+dld)   !average<a name='1054'></font>
<a name='1055'>
     if (k .eq. kte) then<a name='1056'>
        lb1 = 0.<a name='1057'>
        lb2 = 0.<a name='1058'>
     endif<a name='1059'>
     <font color=#447700>!print*,"IN MYNN-BouLac",k,lb1<a name='1060'></font>
     <font color=#447700>!print*,"IN MYNN-BouLac",k,dld,dlu<a name='1061'></font>
<a name='1062'>
  END SUBROUTINE boulac_length0<a name='1063'>
<a name='1064'>
<font color=#447700>! ==================================================================<a name='1065'></font>
<A NAME='BOULAC_LENGTH'><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1066'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>boulac_length</font>(kts,kte,zw,dz,qtke,theta,lb1,lb2) <A href='../../call_to/BOULAC_LENGTH.html' TARGET='index'>1</A>,<A href='../../call_from/BOULAC_LENGTH.html' TARGET='index'>29</A><a name='1067'>
<font color=#447700>!<a name='1068'></font>
<font color=#447700>!    NOTE: This subroutine was taken from the BouLac scheme in WRF-ARW<a name='1069'></font>
<font color=#447700>!          and modified for integration into the MYNN PBL scheme.<a name='1070'></font>
<font color=#447700>!          WHILE loops were added to reduce the computational expense.<a name='1071'></font>
<font color=#447700>!          This subroutine computes the length scales up and down<a name='1072'></font>
<font color=#447700>!          and then computes the min, average of the up/down<a name='1073'></font>
<font color=#447700>!          length scales, and also considers the distance to the<a name='1074'></font>
<font color=#447700>!          surface.<a name='1075'></font>
<font color=#447700>!<a name='1076'></font>
<font color=#447700>!      dlu = the distance a parcel can be lifted upwards give a finite <a name='1077'></font>
<font color=#447700>!            amount of TKE.<a name='1078'></font>
<font color=#447700>!      dld = the distance a parcel can be displaced downwards given a<a name='1079'></font>
<font color=#447700>!            finite amount of TKE.<a name='1080'></font>
<font color=#447700>!      lb1 = the minimum of the length up and length down<a name='1081'></font>
<font color=#447700>!      lb2 = the average of the length up and length down<a name='1082'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='1083'></font>
<a name='1084'>
     INTEGER, INTENT(IN) :: kts,kte<a name='1085'>
     REAL, DIMENSION(kts:kte), INTENT(IN) :: qtke,dz,theta<a name='1086'>
     REAL, DIMENSION(kts:kte), INTENT(OUT) :: lb1,lb2<a name='1087'>
     REAL, DIMENSION(kts:kte+1), INTENT(IN) :: zw<a name='1088'>
<a name='1089'>
     <font color=#447700>!LOCAL VARS<a name='1090'></font>
     INTEGER :: iz, izz, found<a name='1091'>
     REAL, DIMENSION(kts:kte) :: dlu,dld<a name='1092'>
     REAL, PARAMETER :: Lmax=2000.  <font color=#447700>!soft limit<a name='1093'></font>
     REAL :: dzt, zup, beta, zup_inf, bbb, tl, zdo, zdo_sup, zzz<a name='1094'>
<a name='1095'>
     <font color=#447700>!print*,"IN MYNN-BouLac",kts, kte<a name='1096'></font>
<a name='1097'>
     do iz=kts,kte<a name='1098'>
<a name='1099'>
        <font color=#447700>!----------------------------------<a name='1100'></font>
        <font color=#447700>! FIND DISTANCE UPWARD<a name='1101'></font>
        <font color=#447700>!----------------------------------<a name='1102'></font>
        zup=0.<a name='1103'>
        dlu(iz)=zw(kte+1)-zw(iz)-dz(iz)/2.<a name='1104'>
        zzz=0.<a name='1105'>
        zup_inf=0.<a name='1106'>
        beta=g/theta(iz)           <font color=#447700>!Buoyancy coefficient<a name='1107'></font>
<a name='1108'>
        <font color=#447700>!print*,"FINDING Dup, k=",iz," zw=",zw(iz)<a name='1109'></font>
<a name='1110'>
        if (iz .lt. kte) then      <font color=#447700>!cant integrate upwards from highest level<a name='1111'></font>
<a name='1112'>
          found = 0<a name='1113'>
          izz=iz       <a name='1114'>
          DO WHILE (found .EQ. 0) <a name='1115'>
<a name='1116'>
            if (izz .lt. kte) then<a name='1117'>
              dzt=dz(izz)                    <font color=#447700>! layer depth above <a name='1118'></font>
              zup=zup-beta*theta(iz)*dzt     <font color=#447700>! initial PE the parcel has at iz<a name='1119'></font>
              <font color=#447700>!print*,"  ",iz,izz,theta(izz),dz(izz)<a name='1120'></font>
              zup=zup+beta*(theta(izz+1)+theta(izz))*dzt/2. <font color=#447700>! PE gained by lifting a parcel to izz+1<a name='1121'></font>
              zzz=zzz+dzt                   <font color=#447700>! depth of layer iz to izz+1<a name='1122'></font>
              <font color=#447700>!print*,"  PE=",zup," TKE=",qtke(iz)," z=",zw(izz)<a name='1123'></font>
              if (qtke(iz).lt.zup .and. qtke(iz).ge.zup_inf) then<a name='1124'>
                 bbb=(theta(izz+1)-theta(izz))/dzt<a name='1125'>
                 if (bbb .ne. 0.) then<a name='1126'>
                    <font color=#447700>!fractional distance up into the layer where TKE becomes &lt; PE<a name='1127'></font>
                    tl=(-beta*(theta(izz)-theta(iz)) + &amp;<a name='1128'>
                      &amp; sqrt( max(0.,(beta*(theta(izz)-theta(iz)))**2. + &amp;<a name='1129'>
                      &amp;       2.*bbb*beta*(qtke(iz)-zup_inf))))/bbb/beta<a name='1130'>
                 else<a name='1131'>
                    if (theta(izz) .ne. theta(iz))then<a name='1132'>
                       tl=(qtke(iz)-zup_inf)/(beta*(theta(izz)-theta(iz)))<a name='1133'>
                    else<a name='1134'>
                       tl=0.<a name='1135'>
                    endif<a name='1136'>
                 endif            <a name='1137'>
                 dlu(iz)=zzz-dzt+tl<a name='1138'>
                 <font color=#447700>!print*,"  FOUND Dup:",dlu(iz)," z=",zw(izz)," tl=",tl<a name='1139'></font>
                 found =1<a name='1140'>
              endif<a name='1141'>
              zup_inf=zup<a name='1142'>
              izz=izz+1<a name='1143'>
             ELSE<a name='1144'>
              found = 1<a name='1145'>
            ENDIF<a name='1146'>
<a name='1147'>
          ENDDO<a name='1148'>
<a name='1149'>
        endif<a name='1150'>
                   <a name='1151'>
        <font color=#447700>!----------------------------------<a name='1152'></font>
        <font color=#447700>! FIND DISTANCE DOWN<a name='1153'></font>
        <font color=#447700>!----------------------------------<a name='1154'></font>
        zdo=0.<a name='1155'>
        zdo_sup=0.<a name='1156'>
        dld(iz)=zw(iz)<a name='1157'>
        zzz=0.<a name='1158'>
<a name='1159'>
        <font color=#447700>!print*,"FINDING Ddown, k=",iz," zwk=",zw(iz)<a name='1160'></font>
        if (iz .gt. kts) then  <font color=#447700>!cant integrate downwards from lowest level<a name='1161'></font>
<a name='1162'>
          found = 0<a name='1163'>
          izz=iz       <a name='1164'>
          DO WHILE (found .EQ. 0) <a name='1165'>
<a name='1166'>
            if (izz .gt. kts) then<a name='1167'>
              dzt=dz(izz-1)<a name='1168'>
              zdo=zdo+beta*theta(iz)*dzt<a name='1169'>
              <font color=#447700>!print*,"  ",iz,izz,theta(izz),dz(izz-1)<a name='1170'></font>
              zdo=zdo-beta*(theta(izz-1)+theta(izz))*dzt/2.<a name='1171'>
              zzz=zzz+dzt<a name='1172'>
              <font color=#447700>!print*,"  PE=",zdo," TKE=",qtke(iz)," z=",zw(izz)<a name='1173'></font>
              if (qtke(iz).lt.zdo .and. qtke(iz).ge.zdo_sup) then<a name='1174'>
                 bbb=(theta(izz)-theta(izz-1))/dzt<a name='1175'>
                 if (bbb .ne. 0.) then<a name='1176'>
                    tl=(beta*(theta(izz)-theta(iz))+ &amp;<a name='1177'>
                      &amp; sqrt( max(0.,(beta*(theta(izz)-theta(iz)))**2. + &amp;<a name='1178'>
                      &amp;       2.*bbb*beta*(qtke(iz)-zdo_sup))))/bbb/beta<a name='1179'>
                 else<a name='1180'>
                    if (theta(izz) .ne. theta(iz)) then<a name='1181'>
                       tl=(qtke(iz)-zdo_sup)/(beta*(theta(izz)-theta(iz)))<a name='1182'>
                    else<a name='1183'>
                       tl=0.<a name='1184'>
                    endif<a name='1185'>
                 endif            <a name='1186'>
                 dld(iz)=zzz-dzt+tl<a name='1187'>
                 <font color=#447700>!print*,"  FOUND Ddown:",dld(iz)," z=",zw(izz)," tl=",tl<a name='1188'></font>
                 found = 1<a name='1189'>
              endif<a name='1190'>
              zdo_sup=zdo<a name='1191'>
              izz=izz-1<a name='1192'>
            ELSE<a name='1193'>
              found = 1<a name='1194'>
            ENDIF<a name='1195'>
          ENDDO<a name='1196'>
<a name='1197'>
        endif<a name='1198'>
<a name='1199'>
        <font color=#447700>!----------------------------------<a name='1200'></font>
        <font color=#447700>! GET MINIMUM (OR AVERAGE)<a name='1201'></font>
        <font color=#447700>!----------------------------------<a name='1202'></font>
        <font color=#447700>!The surface layer length scale can exceed z for large z/L,<a name='1203'></font>
        <font color=#447700>!so keep maximum distance down &gt; z.<a name='1204'></font>
        dld(iz) = min(dld(iz),zw(iz+1))<font color=#447700>!not used in PBL anyway, only free atmos<a name='1205'></font>
        lb1(iz) = min(dlu(iz),dld(iz))     <font color=#447700>!minimum<a name='1206'></font>
        <font color=#447700>!JOE-fight floating point errors<a name='1207'></font>
        dlu(iz)=MAX(0.1,MIN(dlu(iz),1000.))<a name='1208'>
        dld(iz)=MAX(0.1,MIN(dld(iz),1000.))<a name='1209'>
        lb2(iz) = sqrt(dlu(iz)*dld(iz))    <font color=#447700>!average - biased towards smallest<a name='1210'></font>
        <font color=#447700>!lb2(iz) = 0.5*(dlu(iz)+dld(iz))   !average<a name='1211'></font>
<a name='1212'>
        <font color=#447700>!Apply soft limit (only impacts very large lb; lb=100 by 5%, lb=500 by 20%).<a name='1213'></font>
        lb1(iz) = lb1(iz)/(1. + (lb1(iz)/Lmax))<a name='1214'>
        lb2(iz) = lb2(iz)/(1. + (lb2(iz)/Lmax))<a name='1215'>
 <a name='1216'>
        if (iz .eq. kte) then<a name='1217'>
           lb1(kte) = lb1(kte-1)<a name='1218'>
           lb2(kte) = lb2(kte-1)<a name='1219'>
        endif<a name='1220'>
        <font color=#447700>!print*,"IN MYNN-BouLac",kts, kte,lb1(iz)<a name='1221'></font>
        <font color=#447700>!print*,"IN MYNN-BouLac",iz,dld(iz),dlu(iz)<a name='1222'></font>
<a name='1223'>
     ENDDO<a name='1224'>
                   <a name='1225'>
  END SUBROUTINE boulac_length<a name='1226'>
<font color=#447700>!<a name='1227'></font>
<font color=#447700>!JOE-END BOULAC CODE<a name='1228'></font>
<a name='1229'>
<font color=#447700>! ==================================================================<a name='1230'></font>
<font color=#447700>!     SUBROUTINE  mym_turbulence:<a name='1231'></font>
<font color=#447700>!<a name='1232'></font>
<font color=#447700>!     Input variables:    see subroutine mym_initialize<a name='1233'></font>
<font color=#447700>!       levflag         : &lt;&gt;3;  Level 2.5<a name='1234'></font>
<font color=#447700>!                         = 3;  Level 3<a name='1235'></font>
<font color=#447700>!<a name='1236'></font>
<font color=#447700>!     # ql, vt, vq, qke, tsq, qsq and cov are changed to input variables.<a name='1237'></font>
<font color=#447700>!<a name='1238'></font>
<font color=#447700>!     Output variables:   see subroutine mym_initialize<a name='1239'></font>
<font color=#447700>!       dfm(nx,nz,ny) : Diffusivity coefficient for momentum,<a name='1240'></font>
<font color=#447700>!                         divided by dz (not dz*h(i,j))            (m/s)<a name='1241'></font>
<font color=#447700>!       dfh(nx,nz,ny) : Diffusivity coefficient for heat,<a name='1242'></font>
<font color=#447700>!                         divided by dz (not dz*h(i,j))            (m/s)<a name='1243'></font>
<font color=#447700>!       dfq(nx,nz,ny) : Diffusivity coefficient for q^2,<a name='1244'></font>
<font color=#447700>!                         divided by dz (not dz*h(i,j))            (m/s)<a name='1245'></font>
<font color=#447700>!       tcd(nx,nz,ny)   : Countergradient diffusion term for Theta_l<a name='1246'></font>
<font color=#447700>!                                                                  (K/s)<a name='1247'></font>
<font color=#447700>!       qcd(nx,nz,ny)   : Countergradient diffusion term for Q_w<a name='1248'></font>
<font color=#447700>!                                                              (kg/kg s)<a name='1249'></font>
<font color=#447700>!       pd?(nx,nz,ny) : Half of the production terms<a name='1250'></font>
<font color=#447700>!<a name='1251'></font>
<font color=#447700>!       Only tcd and qcd are defined at the center of the grid boxes<a name='1252'></font>
<font color=#447700>!<a name='1253'></font>
<font color=#447700>!     # DO NOT forget that tcd and qcd are added on the right-hand side<a name='1254'></font>
<font color=#447700>!       of the equations for Theta_l and Q_w, respectively.<a name='1255'></font>
<font color=#447700>!<a name='1256'></font>
<font color=#447700>!     Work arrays:        see subroutine mym_initialize and level2<a name='1257'></font>
<font color=#447700>!<a name='1258'></font>
<font color=#447700>!     # dtl, dqw, dtv, gm and gh are allowed to share storage units with<a name='1259'></font>
<font color=#447700>!       dfm, dfh, dfq, tcd and qcd, respectively, for saving memory.<a name='1260'></font>
<font color=#447700>!<a name='1261'></font>
<A NAME='MYM_TURBULENCE'><A href='../../html_code/phys/module_bl_mynn.F.html#MYM_TURBULENCE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1262'>
  <font color=#993300>SUBROUTINE  </font><font color=#cc0000>mym_turbulence</font> (                                &amp; <A href='../../call_to/MYM_TURBULENCE.html' TARGET='index'>1</A><a name='1263'>
    &amp;            kts,kte,                                     &amp;<a name='1264'>
    &amp;            levflag,                                     &amp;<a name='1265'>
    &amp;            dz, zw,                                      &amp;<a name='1266'>
    &amp;            u, v, thl, ql, qw,                           &amp;<a name='1267'>
    &amp;            qke, tsq, qsq, cov,                          &amp;<a name='1268'>
    &amp;            vt, vq,                                      &amp;<a name='1269'>
    &amp;            rmo, flt, flq,                               &amp;<a name='1270'>
    &amp;            zi,theta,                                    &amp;<a name='1271'>
    &amp;            sh,                                          &amp;<a name='1272'>
    &amp;            El,                                          &amp;<a name='1273'>
    &amp;            Dfm, Dfh, Dfq, Tcd, Qcd, Pdk, Pdt, Pdq, Pdc, &amp;<a name='1274'>
    &amp;		 qWT1D,qSHEAR1D,qBUOY1D,qDISS1D,              &amp;<a name='1275'>
    &amp;            bl_mynn_tkebudget,                           &amp;<a name='1276'>
    &amp;            Psig_bl,Psig_shcu,cldfra_bl1D,bl_mynn_mixlength,&amp;<a name='1277'>
    &amp;            edmf_a1,edmf_qc1,bl_mynn_edmf,&amp;<a name='1278'>
    &amp;            spp_pbl,rstoch_col)<a name='1279'>
<a name='1280'>
<font color=#447700>!-------------------------------------------------------------------<a name='1281'></font>
<font color=#447700>!<a name='1282'></font>
    INTEGER, INTENT(IN)   :: kts,kte<a name='1283'>
    INTEGER, INTENT(IN)   :: levflag,bl_mynn_mixlength,bl_mynn_edmf<a name='1284'>
    REAL, DIMENSION(kts:kte), INTENT(in) :: dz<a name='1285'>
    REAL, DIMENSION(kts:kte+1), INTENT(in) :: zw<a name='1286'>
    REAL, INTENT(in) :: rmo,flt,flq,Psig_bl,Psig_shcu<a name='1287'>
    REAL, DIMENSION(kts:kte), INTENT(in) :: u,v,thl,qw,&amp; <a name='1288'>
         &amp;ql,vt,vq,qke,tsq,qsq,cov,cldfra_bl1D,edmf_a1,edmf_qc1<a name='1289'>
<a name='1290'>
    REAL, DIMENSION(kts:kte), INTENT(out) :: dfm,dfh,dfq,&amp;<a name='1291'>
         &amp;pdk,pdt,pdq,pdc,tcd,qcd,el<a name='1292'>
<a name='1293'>
<font color=#447700>!JOE-TKE BUDGET<a name='1294'></font>
    REAL, DIMENSION(kts:kte), INTENT(inout) :: &amp;<a name='1295'>
         qWT1D,qSHEAR1D,qBUOY1D,qDISS1D<a name='1296'>
    REAL :: q3sq_old,dlsq1,qWTP_old,qWTP_new<a name='1297'>
    REAL :: dudz,dvdz,dTdz,&amp;<a name='1298'>
            upwp,vpwp,Tpwp<a name='1299'>
    INTEGER, INTENT(in) :: bl_mynn_tkebudget<a name='1300'>
<font color=#447700>!JOE-end<a name='1301'></font>
<a name='1302'>
    REAL, DIMENSION(kts:kte) :: qkw,dtl,dqw,dtv,gm,gh,sm,sh<a name='1303'>
<a name='1304'>
    INTEGER :: k<a name='1305'>
<font color=#447700>!    REAL :: cc2,cc3,e1c,e2c,e3c,e4c,e5c<a name='1306'></font>
    REAL :: e6c,dzk,afk,abk,vtt,vqq,&amp;<a name='1307'>
         &amp;cw25,clow,cupp,gamt,gamq,smd,gamv,elq,elh<a name='1308'>
<a name='1309'>
    REAL :: zi<a name='1310'>
    REAL, DIMENSION(kts:kte), INTENT(in) :: theta<a name='1311'>
<a name='1312'>
    REAL ::  a2den, duz, ri, HLmod  <font color=#447700>!JOE-Canuto/Kitamura mod<a name='1313'></font>
<font color=#447700>!JOE-stability criteria for cw<a name='1314'></font>
    REAL:: auh,aum,adh,adm,aeh,aem,Req,Rsl,Rsl2<a name='1315'>
<font color=#447700>!JOE-end<a name='1316'></font>
<a name='1317'>
    DOUBLE PRECISION  q2sq, t2sq, r2sq, c2sq, elsq, gmel, ghel<a name='1318'>
    DOUBLE PRECISION  q3sq, t3sq, r3sq, c3sq, dlsq, qdiv<a name='1319'>
    DOUBLE PRECISION  e1, e2, e3, e4, enum, eden, wden<a name='1320'>
<a name='1321'>
<font color=#447700>!   Stochastic<a name='1322'></font>
    INTEGER,  INTENT(IN)                          ::    spp_pbl<a name='1323'>
    REAL, DIMENSION(KTS:KTE)                      ::    rstoch_col<a name='1324'>
    REAL :: prlimit<a name='1325'>
<a name='1326'>
<a name='1327'>
<font color=#447700>!<a name='1328'></font>
<font color=#447700>!    tv0 = 0.61*tref<a name='1329'></font>
<font color=#447700>!    gtr = 9.81/tref<a name='1330'></font>
<font color=#447700>!<a name='1331'></font>
<font color=#447700>!    cc2 =  1.0-c2<a name='1332'></font>
<font color=#447700>!    cc3 =  1.0-c3<a name='1333'></font>
<font color=#447700>!    e1c =  3.0*a2*b2*cc3<a name='1334'></font>
<font color=#447700>!    e2c =  9.0*a1*a2*cc2<a name='1335'></font>
<font color=#447700>!    e3c =  9.0*a2*a2*cc2*( 1.0-c5 )<a name='1336'></font>
<font color=#447700>!    e4c = 12.0*a1*a2*cc2<a name='1337'></font>
<font color=#447700>!    e5c =  6.0*a1*a1<a name='1338'></font>
<font color=#447700>!<a name='1339'></font>
<a name='1340'>
    CALL <A href='../../html_code/phys/module_bl_mynn.F.html#MYM_LEVEL2'>mym_level2</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYM_LEVEL2_2"> (kts,kte,&amp;<a name='1341'>
    &amp;            dz, &amp;<a name='1342'>
    &amp;            u, v, thl, qw, &amp;<a name='1343'>
    &amp;            ql, vt, vq, &amp;<a name='1344'>
    &amp;            dtl, dqw, dtv, gm, gh, sm, sh )<a name='1345'>
<font color=#447700>!<a name='1346'></font>
    CALL <A href='../../html_code/phys/module_bl_mynn.F.html#MYM_LENGTH'>mym_length</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYM_LENGTH_2"> (                           &amp;<a name='1347'>
    &amp;            kts,kte,                       &amp;<a name='1348'>
    &amp;            dz, zw,                        &amp;<a name='1349'>
    &amp;            rmo, flt, flq,                 &amp;<a name='1350'>
    &amp;            vt, vq,                        &amp;<a name='1351'>
    &amp;            qke,                           &amp;<a name='1352'>
    &amp;            dtv,                           &amp;<a name='1353'>
    &amp;            el,                            &amp;<a name='1354'>
    &amp;            zi,theta,                      &amp;<a name='1355'>
    &amp;            qkw,Psig_bl,cldfra_bl1D,bl_mynn_mixlength, &amp;<a name='1356'>
    &amp;            edmf_a1,edmf_qc1,bl_mynn_edmf, &amp;<a name='1357'>
    &amp;            spp_pbl,rstoch_col)<a name='1358'>
<font color=#447700>!<a name='1359'></font>
<a name='1360'>
    DO k = kts+1,kte<a name='1361'>
       dzk = 0.5  *( dz(k)+dz(k-1) )<a name='1362'>
       afk = dz(k)/( dz(k)+dz(k-1) )<a name='1363'>
       abk = 1.0 -afk<a name='1364'>
       elsq = el (k)**2<a name='1365'>
       q2sq = b1*elsq*( sm(k)*gm(k)+sh(k)*gh(k) )<a name='1366'>
       q3sq = qkw(k)**2<a name='1367'>
<a name='1368'>
<font color=#447700>!JOE-Canuto/Kitamura mod<a name='1369'></font>
       duz = ( u(k)-u(k-1) )**2 +( v(k)-v(k-1) )**2<a name='1370'>
       duz =   duz                    /dzk**2<a name='1371'>
       <font color=#447700>!   **  Gradient Richardson number  **<a name='1372'></font>
       ri = -gh(k)/MAX( duz, 1.0e-10 )<a name='1373'>
       IF (CKmod .eq. 1) THEN<a name='1374'>
          a2den = 1. + MAX(ri,0.0)<a name='1375'>
       ELSE<a name='1376'>
          a2den = 1. + 0.0<a name='1377'>
       ENDIF<a name='1378'>
<font color=#447700>!JOE-end<a name='1379'></font>
<font color=#447700>!<a name='1380'></font>
<font color=#447700>!  Modified: Dec/22/2005, from here, (dlsq -&gt; elsq)<a name='1381'></font>
       gmel = gm (k)*elsq<a name='1382'>
       ghel = gh (k)*elsq<a name='1383'>
<font color=#447700>!  Modified: Dec/22/2005, up to here<a name='1384'></font>
<a name='1385'>
       <font color=#447700>! Level 2.0 debug prints<a name='1386'></font>
       IF ( wrf_at_debug_level(MYNN_DBG_LVL) ) THEN<a name='1387'>
         IF (sh(k)&lt;0.0 .OR. sm(k)&lt;0.0) THEN<a name='1388'>
           WRITE ( mynn_message , FMT='(A,F8.1,A,I6)' ) &amp;<a name='1389'>
           " MYNN; mym_turbulence2.0; sh=",sh(k)," k=",k<a name='1390'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_503"> ( 0 , mynn_message )<a name='1391'>
           WRITE ( mynn_message , FMT='(A,F6.1,A,F6.1,A,F6.1)' ) &amp;<a name='1392'>
           " gm=",gm(k)," gh=",gh(k)," sm=",sm(k)<a name='1393'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_504"> ( 0 , mynn_message )<a name='1394'>
           WRITE ( mynn_message , FMT='(A,F6.1,A,F6.1,A,F6.1)' ) &amp;<a name='1395'>
           " q2sq=",q2sq," q3sq=",q3sq," q3/q2=",q3sq/q2sq<a name='1396'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_505"> ( 0 , mynn_message )<a name='1397'>
           WRITE ( mynn_message , FMT='(A,F6.1,A,F6.1,A,F6.1)' ) &amp;<a name='1398'>
           " qke=",qke(k)," el=",el(k)," ri=",ri<a name='1399'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_506"> ( 0 , mynn_message )<a name='1400'>
           WRITE ( mynn_message , FMT='(A,F6.1,A,F6.1,A,F6.1)' ) &amp;<a name='1401'>
           " PBLH=",zi," u=",u(k)," v=",v(k)<a name='1402'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_507"> ( 0 , mynn_message )<a name='1403'>
         ENDIF<a name='1404'>
       ENDIF<a name='1405'>
<a name='1406'>
<font color=#447700>!JOE-Apply Helfand &amp; Labraga stability check for all Ric<a name='1407'></font>
<font color=#447700>!      when CKmod == 1. (currently not forced below)<a name='1408'></font>
       IF (CKmod .eq. 1) THEN<a name='1409'>
          HLmod = q2sq -1.<a name='1410'>
       ELSE<a name='1411'>
          HLmod = q3sq<a name='1412'>
       ENDIF<a name='1413'>
<a name='1414'>
<font color=#447700>!     **  Since qkw is set to more than 0.0, q3sq &gt; 0.0.  **<a name='1415'></font>
<a name='1416'>
<font color=#447700>!JOE-test new stability criteria in level 2.5 (as well as level 3) - little/no impact<a name='1417'></font>
<font color=#447700>!     **  Limitation on q, instead of L/q  **<a name='1418'></font>
          dlsq =  elsq<a name='1419'>
          IF ( q3sq/dlsq .LT. -gh(k) ) q3sq = -dlsq*gh(k)<a name='1420'>
<font color=#447700>!JOE-end<a name='1421'></font>
<a name='1422'>
       IF ( q3sq .LT. q2sq ) THEN<a name='1423'>
       <font color=#447700>!IF ( HLmod .LT. q2sq ) THEN<a name='1424'></font>
          <font color=#447700>!Apply Helfand &amp; Labraga mod<a name='1425'></font>
          qdiv = SQRT( q3sq/q2sq )   <font color=#447700>!HL89: (1-alfa)<a name='1426'></font>
          sm(k) = sm(k) * qdiv<a name='1427'>
          sh(k) = sh(k) * qdiv<a name='1428'>
<font color=#447700>!<a name='1429'></font>
          <font color=#447700>!JOE-Canuto/Kitamura mod<a name='1430'></font>
          <font color=#447700>!e1   = q3sq - e1c*ghel * qdiv**2<a name='1431'></font>
          <font color=#447700>!e2   = q3sq - e2c*ghel * qdiv**2<a name='1432'></font>
          <font color=#447700>!e3   = e1   + e3c*ghel * qdiv**2<a name='1433'></font>
          <font color=#447700>!e4   = e1   - e4c*ghel * qdiv**2<a name='1434'></font>
          e1   = q3sq - e1c*ghel/a2den * qdiv**2<a name='1435'>
          e2   = q3sq - e2c*ghel/a2den * qdiv**2<a name='1436'>
          e3   = e1   + e3c*ghel/(a2den**2) * qdiv**2<a name='1437'>
          e4   = e1   - e4c*ghel/a2den * qdiv**2<a name='1438'>
          eden = e2*e4 + e3*e5c*gmel * qdiv**2<a name='1439'>
          eden = MAX( eden, 1.0d-20 )<a name='1440'>
       ELSE<a name='1441'>
          <font color=#447700>!JOE-Canuto/Kitamura mod<a name='1442'></font>
          <font color=#447700>!e1   = q3sq - e1c*ghel<a name='1443'></font>
          <font color=#447700>!e2   = q3sq - e2c*ghel<a name='1444'></font>
          <font color=#447700>!e3   = e1   + e3c*ghel<a name='1445'></font>
          <font color=#447700>!e4   = e1   - e4c*ghel<a name='1446'></font>
          e1   = q3sq - e1c*ghel/a2den<a name='1447'>
          e2   = q3sq - e2c*ghel/a2den<a name='1448'>
          e3   = e1   + e3c*ghel/(a2den**2)<a name='1449'>
          e4   = e1   - e4c*ghel/a2den<a name='1450'>
          eden = e2*e4 + e3*e5c*gmel<a name='1451'>
          eden = MAX( eden, 1.0d-20 )<a name='1452'>
<a name='1453'>
          qdiv = 1.0<a name='1454'>
          sm(k) = q3sq*a1*( e3-3.0*c1*e4       )/eden<a name='1455'>
          <font color=#447700>!JOE-Canuto/Kitamura mod<a name='1456'></font>
          <font color=#447700>!sh(k) = q3sq*a2*( e2+3.0*c1*e5c*gmel )/eden<a name='1457'></font>
          sh(k) = q3sq*(a2/a2den)*( e2+3.0*c1*e5c*gmel )/eden<a name='1458'>
       END IF <font color=#447700>!end Helfand &amp; Labraga check<a name='1459'></font>
<a name='1460'>
       <font color=#447700>!JOE: Level 2.5 debug prints<a name='1461'></font>
       <font color=#447700>! HL88 , lev2.5 criteria from eqs. 3.17, 3.19, &amp; 3.20<a name='1462'></font>
       IF ( wrf_at_debug_level(MYNN_DBG_LVL) ) THEN<a name='1463'>
         IF (sh(k)&lt;0.0 .OR. sm(k)&lt;0.0 .OR. &amp;<a name='1464'>
           sh(k) &gt; 0.76*b2 .or. (sm(k)**2*gm(k) .gt. .44**2)) THEN<a name='1465'>
           WRITE ( mynn_message , FMT='(A,F8.1,A,I6)' ) &amp;<a name='1466'>
           " MYNN; mym_turbulence2.5; sh=",sh(k)," k=",k<a name='1467'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_508"> ( 0 , mynn_message )<a name='1468'>
           WRITE ( mynn_message , FMT='(A,F6.1,A,F6.1,A,F6.1)' ) &amp;<a name='1469'>
           " gm=",gm(k)," gh=",gh(k)," sm=",sm(k)<a name='1470'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_509"> ( 0 , mynn_message )<a name='1471'>
           WRITE ( mynn_message , FMT='(A,F6.1,A,F6.1,A,F6.1)' ) &amp;<a name='1472'>
           " q2sq=",q2sq," q3sq=",q3sq," q3/q2=",q3sq/q2sq<a name='1473'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_510"> ( 0 , mynn_message )<a name='1474'>
           WRITE ( mynn_message , FMT='(A,F6.1,A,F6.1,A,F6.1)' ) &amp;<a name='1475'>
           " qke=",qke(k)," el=",el(k)," ri=",ri<a name='1476'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_511"> ( 0 , mynn_message )<a name='1477'>
           WRITE ( mynn_message , FMT='(A,F6.1,A,F6.1,A,F6.1)' ) &amp;<a name='1478'>
           " PBLH=",zi," u=",u(k)," v=",v(k)<a name='1479'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_512"> ( 0 , mynn_message )<a name='1480'>
         ENDIF<a name='1481'>
       ENDIF<a name='1482'>
<a name='1483'>
<font color=#447700>!   **  Level 3 : start  **<a name='1484'></font>
       IF ( levflag .EQ. 3 ) THEN<a name='1485'>
          t2sq = qdiv*b2*elsq*sh(k)*dtl(k)**2<a name='1486'>
          r2sq = qdiv*b2*elsq*sh(k)*dqw(k)**2<a name='1487'>
          c2sq = qdiv*b2*elsq*sh(k)*dtl(k)*dqw(k)<a name='1488'>
          t3sq = MAX( tsq(k)*abk+tsq(k-1)*afk, 0.0 )<a name='1489'>
          r3sq = MAX( qsq(k)*abk+qsq(k-1)*afk, 0.0 )<a name='1490'>
          c3sq =      cov(k)*abk+cov(k-1)*afk<a name='1491'>
<a name='1492'>
<font color=#447700>!  Modified: Dec/22/2005, from here<a name='1493'></font>
          c3sq = SIGN( MIN( ABS(c3sq), SQRT(t3sq*r3sq) ), c3sq )<a name='1494'>
<font color=#447700>!<a name='1495'></font>
          vtt  = 1.0 +vt(k)*abk +vt(k-1)*afk<a name='1496'>
          vqq  = tv0 +vq(k)*abk +vq(k-1)*afk<a name='1497'>
          t2sq = vtt*t2sq +vqq*c2sq<a name='1498'>
          r2sq = vtt*c2sq +vqq*r2sq<a name='1499'>
          c2sq = MAX( vtt*t2sq+vqq*r2sq, 0.0d0 )<a name='1500'>
          t3sq = vtt*t3sq +vqq*c3sq<a name='1501'>
          r3sq = vtt*c3sq +vqq*r3sq<a name='1502'>
          c3sq = MAX( vtt*t3sq+vqq*r3sq, 0.0d0 )<a name='1503'>
<font color=#447700>!<a name='1504'></font>
          cw25 = e1*( e2 + 3.0*c1*e5c*gmel*qdiv**2 )/( 3.0*eden )<a name='1505'>
<font color=#447700>!<a name='1506'></font>
<font color=#447700>!     **  Limitation on q, instead of L/q  **<a name='1507'></font>
          dlsq =  elsq<a name='1508'>
          IF ( q3sq/dlsq .LT. -gh(k) ) q3sq = -dlsq*gh(k)<a name='1509'>
<font color=#447700>!<a name='1510'></font>
<font color=#447700>!     **  Limitation on c3sq (0.12 =&lt; cw =&lt; 0.76) **<a name='1511'></font>
          <font color=#447700>!JOE: use Janjic's (2001; p 13-17) methodology (eqs 4.11-414 and 5.7-5.10)<a name='1512'></font>
          <font color=#447700>! to calculate an exact limit for c3sq:<a name='1513'></font>
          auh = 27.*a1*((a2/a2den)**2)*b2*(g/tref)**2<a name='1514'>
          aum = 54.*(a1**2)*(a2/a2den)*b2*c1*(g/tref)<a name='1515'>
          adh = 9.*a1*((a2/a2den)**2)*(12.*a1 + 3.*b2)*(g/tref)**2<a name='1516'>
          adm = 18.*(a1**2)*(a2/a2den)*(b2 - 3.*(a2/a2den))*(g/tref)<a name='1517'>
<a name='1518'>
          aeh = (9.*a1*((a2/a2den)**2)*b1 +9.*a1*((a2/a2den)**2)* &amp;<a name='1519'>
                (12.*a1 + 3.*b2))*(g/tref)<a name='1520'>
          aem = 3.*a1*(a2/a2den)*b1*(3.*(a2/a2den) + 3.*b2*c1 + &amp;<a name='1521'>
                (18.*a1*c1 - b2)) + &amp;<a name='1522'>
                (18.)*(a1**2)*(a2/a2den)*(b2 - 3.*(a2/a2den))<a name='1523'>
<a name='1524'>
          Req = -aeh/aem<a name='1525'>
          Rsl = (auh + aum*Req)/(3.*adh + 3.*adm*Req)<a name='1526'>
          <font color=#447700>!For now, use default values, since tests showed little/no sensitivity<a name='1527'></font>
          Rsl = .12             <font color=#447700>!lower limit<a name='1528'></font>
          Rsl2= 1.0 - 2.*Rsl    <font color=#447700>!upper limit<a name='1529'></font>
          <font color=#447700>!IF (k==2)print*,"Dynamic limit RSL=",Rsl<a name='1530'></font>
          <font color=#447700>!IF (Rsl &lt; 0.10 .OR. Rsl &gt; 0.18) THEN<a name='1531'></font>
          <font color=#447700>!   wrf_err_message = '--- ERROR: MYNN: Dynamic Cw '// &amp;<a name='1532'></font>
          <font color=#447700>!        'limit exceeds reasonable limits'<a name='1533'></font>
          <font color=#447700>!   CALL wrf_message ( wrf_err_message )<a name='1534'></font>
          <font color=#447700>!   WRITE ( mynn_message , FMT='(A,F8.3)' ) &amp;<a name='1535'></font>
          <font color=#447700>!   " MYNN: Dynamic Cw limit needs attention=",Rsl<a name='1536'></font>
          <font color=#447700>!   CALL wrf_debug ( 0 , mynn_message )<a name='1537'></font>
          <font color=#447700>!ENDIF<a name='1538'></font>
<a name='1539'>
          <font color=#447700>!JOE-Canuto/Kitamura mod<a name='1540'></font>
          <font color=#447700>!e2   = q3sq - e2c*ghel * qdiv**2<a name='1541'></font>
          <font color=#447700>!e3   = q3sq + e3c*ghel * qdiv**2<a name='1542'></font>
          <font color=#447700>!e4   = q3sq - e4c*ghel * qdiv**2<a name='1543'></font>
          e2   = q3sq - e2c*ghel/a2den * qdiv**2<a name='1544'>
          e3   = q3sq + e3c*ghel/(a2den**2) * qdiv**2<a name='1545'>
          e4   = q3sq - e4c*ghel/a2den * qdiv**2<a name='1546'>
          eden = e2*e4  + e3 *e5c*gmel * qdiv**2<a name='1547'>
<a name='1548'>
          <font color=#447700>!JOE-Canuto/Kitamura mod<a name='1549'></font>
          <font color=#447700>!wden = cc3*gtr**2 * dlsq**2/elsq * qdiv**2 &amp;<a name='1550'></font>
          <font color=#447700>!     &amp;        *( e2*e4c - e3c*e5c*gmel * qdiv**2 )<a name='1551'></font>
          wden = cc3*gtr**2 * dlsq**2/elsq * qdiv**2 &amp;<a name='1552'>
               &amp;        *( e2*e4c/a2den - e3c*e5c*gmel/(a2den**2) * qdiv**2 )<a name='1553'>
<a name='1554'>
          IF ( wden .NE. 0.0 ) THEN<a name='1555'>
             <font color=#447700>!JOE: test dynamic limits<a name='1556'></font>
             <font color=#447700>!clow = q3sq*( 0.12-cw25 )*eden/wden<a name='1557'></font>
             <font color=#447700>!cupp = q3sq*( 0.76-cw25 )*eden/wden<a name='1558'></font>
             clow = q3sq*( Rsl -cw25 )*eden/wden<a name='1559'>
             cupp = q3sq*( Rsl2-cw25 )*eden/wden<a name='1560'>
<font color=#447700>!<a name='1561'></font>
             IF ( wden .GT. 0.0 ) THEN<a name='1562'>
                c3sq  = MIN( MAX( c3sq, c2sq+clow ), c2sq+cupp )<a name='1563'>
             ELSE<a name='1564'>
                c3sq  = MAX( MIN( c3sq, c2sq+clow ), c2sq+cupp )<a name='1565'>
             END IF<a name='1566'>
          END IF<a name='1567'>
<font color=#447700>!<a name='1568'></font>
          e1   = e2 + e5c*gmel * qdiv**2<a name='1569'>
          eden = MAX( eden, 1.0d-20 )<a name='1570'>
<font color=#447700>!  Modified: Dec/22/2005, up to here<a name='1571'></font>
<a name='1572'>
          <font color=#447700>!JOE-Canuto/Kitamura mod<a name='1573'></font>
          <font color=#447700>!e6c  = 3.0*a2*cc3*gtr * dlsq/elsq<a name='1574'></font>
          e6c  = 3.0*(a2/a2den)*cc3*gtr * dlsq/elsq<a name='1575'>
<a name='1576'>
          <font color=#447700>!============================<a name='1577'></font>
          <font color=#447700>!     **  for Gamma_theta  **<a name='1578'></font>
          <font color=#447700>!!          enum = qdiv*e6c*( t3sq-t2sq )<a name='1579'></font>
          IF ( t2sq .GE. 0.0 ) THEN<a name='1580'>
             enum = MAX( qdiv*e6c*( t3sq-t2sq ), 0.0d0 )<a name='1581'>
          ELSE<a name='1582'>
             enum = MIN( qdiv*e6c*( t3sq-t2sq ), 0.0d0 )<a name='1583'>
          ENDIF<a name='1584'>
          gamt =-e1  *enum    /eden<a name='1585'>
<a name='1586'>
          <font color=#447700>!============================<a name='1587'></font>
          <font color=#447700>!     **  for Gamma_q  **<a name='1588'></font>
          <font color=#447700>!!          enum = qdiv*e6c*( r3sq-r2sq )<a name='1589'></font>
          IF ( r2sq .GE. 0.0 ) THEN<a name='1590'>
             enum = MAX( qdiv*e6c*( r3sq-r2sq ), 0.0d0 )<a name='1591'>
          ELSE<a name='1592'>
             enum = MIN( qdiv*e6c*( r3sq-r2sq ), 0.0d0 )<a name='1593'>
          ENDIF<a name='1594'>
          gamq =-e1  *enum    /eden<a name='1595'>
<a name='1596'>
          <font color=#447700>!============================<a name='1597'></font>
          <font color=#447700>!     **  for Sm' and Sh'd(Theta_V)/dz  **<a name='1598'></font>
          <font color=#447700>!!          enum = qdiv*e6c*( c3sq-c2sq )<a name='1599'></font>
          enum = MAX( qdiv*e6c*( c3sq-c2sq ), 0.0d0)<a name='1600'>
<a name='1601'>
          <font color=#447700>!JOE-Canuto/Kitamura mod<a name='1602'></font>
          <font color=#447700>!smd  = dlsq*enum*gtr/eden * qdiv**2 * (e3c+e4c)*a1/a2<a name='1603'></font>
          smd  = dlsq*enum*gtr/eden * qdiv**2 * (e3c/(a2den**2) + &amp;<a name='1604'>
               &amp; e4c/a2den)*a1/(a2/a2den)<a name='1605'>
<a name='1606'>
          gamv = e1  *enum*gtr/eden<a name='1607'>
          sm(k) = sm(k) +smd<a name='1608'>
<a name='1609'>
          <font color=#447700>!============================<a name='1610'></font>
          <font color=#447700>!     **  For elh (see below), qdiv at Level 3 is reset to 1.0.  **<a name='1611'></font>
          qdiv = 1.0<a name='1612'>
<a name='1613'>
          <font color=#447700>! Level 3 debug prints<a name='1614'></font>
          IF ( wrf_at_debug_level(MYNN_DBG_LVL) ) THEN<a name='1615'>
            IF (sh(k)&lt;-0.3 .OR. sm(k)&lt;-0.3 .OR. &amp;<a name='1616'>
              qke(k) &lt; -0.1 .or. ABS(smd) .gt. 2.0) THEN<a name='1617'>
              WRITE ( mynn_message , FMT='(A,F8.1,A,I6)' ) &amp;<a name='1618'>
              " MYNN; mym_turbulence3.0; sh=",sh(k)," k=",k<a name='1619'>
              CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_513"> ( 0 , mynn_message )<a name='1620'>
              WRITE ( mynn_message , FMT='(A,F6.1,A,F6.1,A,F6.1)' ) &amp;<a name='1621'>
              " gm=",gm(k)," gh=",gh(k)," sm=",sm(k)<a name='1622'>
              CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_514"> ( 0 , mynn_message )<a name='1623'>
              WRITE ( mynn_message , FMT='(A,F6.1,A,F6.1,A,F6.1)' ) &amp;<a name='1624'>
              " q2sq=",q2sq," q3sq=",q3sq," q3/q2=",q3sq/q2sq<a name='1625'>
              CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_515"> ( 0 , mynn_message )<a name='1626'>
              WRITE ( mynn_message , FMT='(A,F6.1,A,F6.1,A,F6.1)' ) &amp;<a name='1627'>
              " qke=",qke(k)," el=",el(k)," ri=",ri<a name='1628'>
              CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_516"> ( 0 , mynn_message )<a name='1629'>
              WRITE ( mynn_message , FMT='(A,F6.1,A,F6.1,A,F6.1)' ) &amp;<a name='1630'>
              " PBLH=",zi," u=",u(k)," v=",v(k)<a name='1631'>
              CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_517"> ( 0 , mynn_message )<a name='1632'>
            ENDIF<a name='1633'>
          ENDIF<a name='1634'>
<a name='1635'>
<font color=#447700>!   **  Level 3 : end  **<a name='1636'></font>
<a name='1637'>
       ELSE<a name='1638'>
<font color=#447700>!     **  At Level 2.5, qdiv is not reset.  **<a name='1639'></font>
          gamt = 0.0<a name='1640'>
          gamq = 0.0<a name='1641'>
          gamv = 0.0<a name='1642'>
       END IF<a name='1643'>
<font color=#447700>!<a name='1644'></font>
<font color=#447700>!      Add stochastic perturbation of prandtl number limit<a name='1645'></font>
       if (spp_pbl==1) then<a name='1646'>
          prlimit = MIN(MAX(1.,2.5 + 5.0*rstoch_col(k)), 10.)<a name='1647'>
          IF(sm(k) &gt; sh(k)*Prlimit) THEN<a name='1648'>
             sm(k) = sh(k)*Prlimit<a name='1649'>
          ENDIF<a name='1650'>
       ENDIF<a name='1651'>
<font color=#447700>!<a name='1652'></font>
       elq = el(k)*qkw(k)<a name='1653'>
       elh = elq*qdiv<a name='1654'>
<a name='1655'>
       <font color=#447700>! Production of TKE (pdk), T-variance (pdt),<a name='1656'></font>
       <font color=#447700>! q-variance (pdq), and covariance (pdc)<a name='1657'></font>
       pdk(k) = elq*( sm(k)*gm(k) &amp;<a name='1658'>
            &amp;                    +sh(k)*gh(k)+gamv ) <font color=#447700>! JAYMES TKE<a name='1659'></font>
       pdt(k) = elh*( sh(k)*dtl(k)+gamt )*dtl(k)<a name='1660'>
       pdq(k) = elh*( sh(k)*dqw(k)+gamq )*dqw(k)<a name='1661'>
       pdc(k) = elh*( sh(k)*dtl(k)+gamt )&amp;<a name='1662'>
            &amp;*dqw(k)*0.5 &amp;<a name='1663'>
                  &amp;+elh*( sh(k)*dqw(k)+gamq )*dtl(k)*0.5<a name='1664'>
<a name='1665'>
       <font color=#447700>! Contergradient terms<a name='1666'></font>
       tcd(k) = elq*gamt<a name='1667'>
       qcd(k) = elq*gamq<a name='1668'>
<a name='1669'>
       <font color=#447700>! Eddy Diffusivity/Viscosity divided by dz<a name='1670'></font>
       dfm(k) = elq*sm(k) / dzk<a name='1671'>
       dfh(k) = elq*sh(k) / dzk<a name='1672'>
<font color=#447700>!  Modified: Dec/22/2005, from here<a name='1673'></font>
<font color=#447700>!   **  In sub.mym_predict, dfq for the TKE and scalar variance **<a name='1674'></font>
<font color=#447700>!   **  are set to 3.0*dfm and 1.0*dfm, respectively. (Sqfac)   **<a name='1675'></font>
       dfq(k) =     dfm(k)<a name='1676'>
<font color=#447700>!  Modified: Dec/22/2005, up to here<a name='1677'></font>
<a name='1678'>
   IF ( bl_mynn_tkebudget == 1) THEN<a name='1679'>
       <font color=#447700>!TKE BUDGET<a name='1680'></font>
       dudz = ( u(k)-u(k-1) )/dzk<a name='1681'>
       dvdz = ( v(k)-v(k-1) )/dzk<a name='1682'>
       dTdz = ( thl(k)-thl(k-1) )/dzk<a name='1683'>
<a name='1684'>
       upwp = -elq*sm(k)*dudz<a name='1685'>
       vpwp = -elq*sm(k)*dvdz<a name='1686'>
       Tpwp = -elq*sh(k)*dTdz<a name='1687'>
       Tpwp = SIGN(MAX(ABS(Tpwp),1.E-6),Tpwp)<a name='1688'>
<a name='1689'>
       IF ( k .EQ. kts+1 ) THEN<a name='1690'>
          qWT1D(kts)=0.<a name='1691'>
          q3sq_old =0.<a name='1692'>
          qWTP_old =0.<a name='1693'>
          <font color=#447700>!**  Limitation on q, instead of L/q  **<a name='1694'></font>
          dlsq1 = MAX(el(kts)**2,1.0)<a name='1695'>
          IF ( q3sq_old/dlsq1 .LT. -gh(k) ) q3sq_old = -dlsq1*gh(k)<a name='1696'>
       ENDIF<a name='1697'>
<a name='1698'>
       <font color=#447700>!!!Vertical Transport Term<a name='1699'></font>
       qWTP_new = elq*Sqfac*sm(k)*(q3sq - q3sq_old)/dzk<a name='1700'>
       qWT1D(k) = 0.5*(qWTP_new - qWTP_old)/dzk<a name='1701'>
       qWTP_old = elq*Sqfac*sm(k)*(q3sq - q3sq_old)/dzk<a name='1702'>
       q3sq_old = q3sq<a name='1703'>
<a name='1704'>
       <font color=#447700>!!!Shear Term<a name='1705'></font>
       <font color=#447700>!!!qSHEAR1D(k)=-(upwp*dudz + vpwp*dvdz)<a name='1706'></font>
       qSHEAR1D(k) = elq*sm(k)*gm(k)<a name='1707'>
<a name='1708'>
       <font color=#447700>!!!Buoyancy Term    <a name='1709'></font>
       <font color=#447700>!!!qBUOY1D(k)=g*Tpwp/thl(k)<a name='1710'></font>
       <font color=#447700>!qBUOY1D(k)= elq*(sh(k)*gh(k) + gamv)<a name='1711'></font>
       qBUOY1D(k) = elq*(sh(k)*(-dTdz*g/thl(k)) + gamv)<a name='1712'>
<a name='1713'>
       <font color=#447700>!!!Dissipation Term<a name='1714'></font>
       qDISS1D(k) = (q3sq**(3./2.))/(b1*MAX(el(k),1.))<a name='1715'>
    ENDIF<a name='1716'>
<a name='1717'>
    END DO<a name='1718'>
<font color=#447700>!<a name='1719'></font>
<a name='1720'>
    dfm(kts) = 0.0<a name='1721'>
    dfh(kts) = 0.0<a name='1722'>
    dfq(kts) = 0.0<a name='1723'>
    tcd(kts) = 0.0<a name='1724'>
    qcd(kts) = 0.0<a name='1725'>
<a name='1726'>
    tcd(kte) = 0.0<a name='1727'>
    qcd(kte) = 0.0<a name='1728'>
<a name='1729'>
<font color=#447700>!<a name='1730'></font>
    DO k = kts,kte-1<a name='1731'>
       dzk = dz(k)<a name='1732'>
       tcd(k) = ( tcd(k+1)-tcd(k) )/( dzk )<a name='1733'>
       qcd(k) = ( qcd(k+1)-qcd(k) )/( dzk )<a name='1734'>
    END DO<a name='1735'>
<font color=#447700>!<a name='1736'></font>
<a name='1737'>
   IF ( bl_mynn_tkebudget == 1) THEN<a name='1738'>
      <font color=#447700>!JOE-TKE BUDGET<a name='1739'></font>
      qWT1D(kts)=0.<a name='1740'>
      qSHEAR1D(kts)=qSHEAR1D(kts+1)<a name='1741'>
      qBUOY1D(kts)=qBUOY1D(kts+1)<a name='1742'>
      qDISS1D(kts)=qDISS1D(kts+1)<a name='1743'>
   ENDIF<a name='1744'>
<a name='1745'>
    RETURN<a name='1746'>
<a name='1747'>
  END SUBROUTINE mym_turbulence<a name='1748'>
<a name='1749'>
<font color=#447700>! ==================================================================<a name='1750'></font>
<font color=#447700>!     SUBROUTINE  mym_predict:<a name='1751'></font>
<font color=#447700>!<a name='1752'></font>
<font color=#447700>!     Input variables:    see subroutine mym_initialize and turbulence<a name='1753'></font>
<font color=#447700>!       qke(nx,nz,ny) : qke at (n)th time level<a name='1754'></font>
<font color=#447700>!       tsq, ...cov     : ditto<a name='1755'></font>
<font color=#447700>!<a name='1756'></font>
<font color=#447700>!     Output variables:<a name='1757'></font>
<font color=#447700>!       qke(nx,nz,ny) : qke at (n+1)th time level<a name='1758'></font>
<font color=#447700>!       tsq, ...cov     : ditto<a name='1759'></font>
<font color=#447700>!<a name='1760'></font>
<font color=#447700>!     Work arrays:<a name='1761'></font>
<font color=#447700>!       qkw(nx,nz,ny)   : q at the center of the grid boxes        (m/s)<a name='1762'></font>
<font color=#447700>!       bp (nx,nz,ny)   : = 1/2*F,     see below<a name='1763'></font>
<font color=#447700>!       rp (nx,nz,ny)   : = P-1/2*F*Q, see below<a name='1764'></font>
<font color=#447700>!<a name='1765'></font>
<font color=#447700>!     # The equation for a turbulent quantity Q can be expressed as<a name='1766'></font>
<font color=#447700>!          dQ/dt + Ah + Av = Dh + Dv + P - F*Q,                      (1)<a name='1767'></font>
<font color=#447700>!       where A is the advection, D the diffusion, P the production,<a name='1768'></font>
<font color=#447700>!       F*Q the dissipation and h and v denote horizontal and vertical,<a name='1769'></font>
<font color=#447700>!       respectively. If Q is q^2, F is 2q/B_1L.<a name='1770'></font>
<font color=#447700>!       Using the Crank-Nicholson scheme for Av, Dv and F*Q, a finite<a name='1771'></font>
<font color=#447700>!       difference equation is written as<a name='1772'></font>
<font color=#447700>!          Q{n+1} - Q{n} = dt  *( Dh{n}   - Ah{n}   + P{n} )<a name='1773'></font>
<font color=#447700>!                        + dt/2*( Dv{n}   - Av{n}   - F*Q{n}   )<a name='1774'></font>
<font color=#447700>!                        + dt/2*( Dv{n+1} - Av{n+1} - F*Q{n+1} ),    (2)<a name='1775'></font>
<font color=#447700>!       where n denotes the time level.<a name='1776'></font>
<font color=#447700>!       When the advection and diffusion terms are discretized as<a name='1777'></font>
<font color=#447700>!          dt/2*( Dv - Av ) = a(k)Q(k+1) - b(k)Q(k) + c(k)Q(k-1),    (3)<a name='1778'></font>
<font color=#447700>!       Eq.(2) can be rewritten as<a name='1779'></font>
<font color=#447700>!          - a(k)Q(k+1) + [ 1 + b(k) + dt/2*F ]Q(k) - c(k)Q(k-1)<a name='1780'></font>
<font color=#447700>!                 = Q{n} + dt  *( Dh{n}   - Ah{n}   + P{n} )<a name='1781'></font>
<font color=#447700>!                        + dt/2*( Dv{n}   - Av{n}   - F*Q{n}   ),    (4)<a name='1782'></font>
<font color=#447700>!       where Q on the left-hand side is at (n+1)th time level.<a name='1783'></font>
<font color=#447700>!<a name='1784'></font>
<font color=#447700>!       In this subroutine, a(k), b(k) and c(k) are obtained from<a name='1785'></font>
<font color=#447700>!       subprogram coefvu and are passed to subprogram tinteg via<a name='1786'></font>
<font color=#447700>!       common. 1/2*F and P-1/2*F*Q are stored in bp and rp,<a name='1787'></font>
<font color=#447700>!       respectively. Subprogram tinteg solves Eq.(4).<a name='1788'></font>
<font color=#447700>!<a name='1789'></font>
<font color=#447700>!       Modify this subroutine according to your numerical integration<a name='1790'></font>
<font color=#447700>!       scheme (program).<a name='1791'></font>
<font color=#447700>!<a name='1792'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='1793'></font>
<A NAME='MYM_PREDICT'><A href='../../html_code/phys/module_bl_mynn.F.html#MYM_PREDICT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1794'>
  <font color=#993300>SUBROUTINE  </font><font color=#cc0000>mym_predict</font> (kts,kte,&amp; <A href='../../call_to/MYM_PREDICT.html' TARGET='index'>1</A><a name='1795'>
       &amp;            levflag,  &amp;<a name='1796'>
       &amp;            delt,&amp;<a name='1797'>
       &amp;            dz, &amp;<a name='1798'>
       &amp;            ust, flt, flq, pmz, phh, &amp;<a name='1799'>
       &amp;            el, dfq, &amp;<a name='1800'>
       &amp;            pdk, pdt, pdq, pdc,&amp;<a name='1801'>
       &amp;            qke, tsq, qsq, cov, &amp;<a name='1802'>
       &amp;            s_aw,s_awqke,bl_mynn_edmf_tke &amp;<a name='1803'>
       &amp;)<a name='1804'>
<a name='1805'>
<font color=#447700>!-------------------------------------------------------------------<a name='1806'></font>
    INTEGER, INTENT(IN) :: kts,kte    <a name='1807'>
    INTEGER, INTENT(IN) :: levflag<a name='1808'>
    INTEGER, INTENT(IN) :: bl_mynn_edmf_tke<a name='1809'>
    REAL, INTENT(IN)    :: delt<a name='1810'>
    REAL, DIMENSION(kts:kte), INTENT(IN) :: dz, dfq,el<a name='1811'>
    REAL, DIMENSION(kts:kte), INTENT(INOUT) :: pdk, pdt, pdq, pdc<a name='1812'>
    REAL, INTENT(IN)    ::  flt, flq, ust, pmz, phh<a name='1813'>
    REAL, DIMENSION(kts:kte), INTENT(INOUT) :: qke,tsq, qsq, cov<a name='1814'>
<font color=#447700>! WA 8/3/15<a name='1815'></font>
    REAL, DIMENSION(kts:kte+1), INTENT(INOUT) :: s_awqke,s_aw<a name='1816'>
<a name='1817'>
    INTEGER :: k,nz<a name='1818'>
    REAL, DIMENSION(kts:kte) :: qkw, bp, rp, df3q<a name='1819'>
    REAL :: vkz,pdk1,phm,pdt1,pdq1,pdc1,b1l,b2l,onoff<a name='1820'>
    REAL, DIMENSION(kts:kte) :: dtz<a name='1821'>
    REAL, DIMENSION(1:kte-kts+1) :: a,b,c,d<a name='1822'>
<a name='1823'>
    nz=kte-kts+1<a name='1824'>
<a name='1825'>
    <font color=#447700>! REGULATE THE MOMENTUM MIXING FROM THE MASS-FLUX SCHEME (on or off)<a name='1826'></font>
    IF (bl_mynn_edmf_tke == 0) THEN<a name='1827'>
       onoff=0.0<a name='1828'>
    ELSE<a name='1829'>
       onoff=1.0<a name='1830'>
    ENDIF<a name='1831'>
<a name='1832'>
<font color=#447700>!   **  Strictly, vkz*h(i,j) -&gt; vk*( 0.5*dz(1)*h(i,j)+z0 )  **<a name='1833'></font>
    vkz = vk*0.5*dz(kts)<a name='1834'>
<font color=#447700>!<a name='1835'></font>
<font color=#447700>!   **  dfq for the TKE is 3.0*dfm.  **<a name='1836'></font>
<font color=#447700>!<a name='1837'></font>
    DO k = kts,kte<a name='1838'>
<font color=#447700>!!       qke(k) = MAX(qke(k), 0.0)<a name='1839'></font>
       qkw(k) = SQRT( MAX( qke(k), 0.0 ) )<a name='1840'>
       df3q(k)=Sqfac*dfq(k)<a name='1841'>
       dtz(k)=delt/dz(k)<a name='1842'>
    END DO<a name='1843'>
<font color=#447700>!<a name='1844'></font>
    pdk1 = 2.0*ust**3*pmz/( vkz )<a name='1845'>
    phm  = 2.0/ust   *phh/( vkz )<a name='1846'>
    pdt1 = phm*flt**2<a name='1847'>
    pdq1 = phm*flq**2<a name='1848'>
    pdc1 = phm*flt*flq<a name='1849'>
<font color=#447700>!<a name='1850'></font>
<font color=#447700>!   **  pdk(i,j,1)+pdk(i,j,2) corresponds to pdk1.  **<a name='1851'></font>
    pdk(kts) = pdk1 -pdk(kts+1)<a name='1852'>
<a name='1853'>
<font color=#447700>!!    pdt(kts) = pdt1 -pdt(kts+1)<a name='1854'></font>
<font color=#447700>!!    pdq(kts) = pdq1 -pdq(kts+1)<a name='1855'></font>
<font color=#447700>!!    pdc(kts) = pdc1 -pdc(kts+1)<a name='1856'></font>
    pdt(kts) = pdt(kts+1)<a name='1857'>
    pdq(kts) = pdq(kts+1)<a name='1858'>
    pdc(kts) = pdc(kts+1)<a name='1859'>
<font color=#447700>!<a name='1860'></font>
<font color=#447700>!   **  Prediction of twice the turbulent kinetic energy  **<a name='1861'></font>
<font color=#447700>!!    DO k = kts+1,kte-1<a name='1862'></font>
    DO k = kts,kte-1<a name='1863'>
       b1l = b1*0.5*( el(k+1)+el(k) )<a name='1864'>
       bp(k) = 2.*qkw(k) / b1l<a name='1865'>
       rp(k) = pdk(k+1) + pdk(k)<a name='1866'>
    END DO<a name='1867'>
<a name='1868'>
<font color=#447700>!!    a(1)=0.<a name='1869'></font>
<font color=#447700>!!    b(1)=1.<a name='1870'></font>
<font color=#447700>!!    c(1)=-1.<a name='1871'></font>
<font color=#447700>!!    d(1)=0.<a name='1872'></font>
<a name='1873'>
<font color=#447700>! Since df3q(kts)=0.0, a(1)=0.0 and b(1)=1.+dtz(k)*df3q(k+1)+bp(k)*delt.<a name='1874'></font>
    DO k=kts,kte-1<a name='1875'>
<font color=#447700>!       a(k-kts+1)=-dtz(k)*df3q(k)<a name='1876'></font>
<font color=#447700>!       b(k-kts+1)=1.+dtz(k)*(df3q(k)+df3q(k+1))+bp(k)*delt<a name='1877'></font>
<font color=#447700>!       c(k-kts+1)=-dtz(k)*df3q(k+1)<a name='1878'></font>
<font color=#447700>!       d(k-kts+1)=rp(k)*delt + qke(k)<a name='1879'></font>
<font color=#447700>! WA 8/3/15 add EDMF contribution<a name='1880'></font>
       a(k-kts+1)=-dtz(k)*df3q(k) + 0.5*dtz(k)*s_aw(k)*onoff<a name='1881'>
       b(k-kts+1)=1. + dtz(k)*(df3q(k)+df3q(k+1)) &amp;<a name='1882'>
                     + 0.5*dtz(k)*(s_aw(k)-s_aw(k+1))*onoff + bp(k)*delt<a name='1883'>
       c(k-kts+1)=-dtz(k)*df3q(k+1) - 0.5*dtz(k)*s_aw(k+1)*onoff<a name='1884'>
       d(k-kts+1)=rp(k)*delt + qke(k) + dtz(k)*(s_awqke(k)-s_awqke(k+1))*onoff<a name='1885'>
    ENDDO<a name='1886'>
<a name='1887'>
<font color=#447700>!!    DO k=kts+1,kte-1<a name='1888'></font>
<font color=#447700>!!       a(k-kts+1)=-dtz(k)*df3q(k)<a name='1889'></font>
<font color=#447700>!!       b(k-kts+1)=1.+dtz(k)*(df3q(k)+df3q(k+1))<a name='1890'></font>
<font color=#447700>!!       c(k-kts+1)=-dtz(k)*df3q(k+1)<a name='1891'></font>
<font color=#447700>!!       d(k-kts+1)=rp(k)*delt + qke(k) - qke(k)*bp(k)*delt<a name='1892'></font>
<font color=#447700>!!    ENDDO<a name='1893'></font>
<a name='1894'>
    a(nz)=-1. <font color=#447700>!0.<a name='1895'></font>
    b(nz)=1.<a name='1896'>
    c(nz)=0.<a name='1897'>
    d(nz)=0.<a name='1898'>
<a name='1899'>
    CALL <A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG'>tridiag</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_1">(nz,a,b,c,d)<a name='1900'>
<a name='1901'>
    DO k=kts,kte   <a name='1902'>
       qke(k)=<A href='../../html_code/share/dfi.F.html#D'>d</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_7">(k-kts+1)<a name='1903'>
    ENDDO<a name='1904'>
      <a name='1905'>
<a name='1906'>
    IF ( levflag .EQ. 3 ) THEN<a name='1907'>
<font color=#447700>!<a name='1908'></font>
<font color=#447700>!  Modified: Dec/22/2005, from here<a name='1909'></font>
<font color=#447700>!   **  dfq for the scalar variance is 1.0*dfm.  **<a name='1910'></font>
<font color=#447700>!       CALL coefvu ( dfq, 1.0 ) make change here <a name='1911'></font>
<font color=#447700>!  Modified: Dec/22/2005, up to here<a name='1912'></font>
<font color=#447700>!<a name='1913'></font>
<font color=#447700>!   **  Prediction of the temperature variance  **<a name='1914'></font>
<font color=#447700>!!       DO k = kts+1,kte-1<a name='1915'></font>
       DO k = kts,kte-1<a name='1916'>
          b2l = b2*0.5*( el(k+1)+el(k) )<a name='1917'>
          bp(k) = 2.*qkw(k) / b2l<a name='1918'>
          rp(k) = pdt(k+1) + pdt(k) <a name='1919'>
       END DO<a name='1920'>
       <a name='1921'>
<font color=#447700>!zero gradient for tsq at bottom and top<a name='1922'></font>
       <a name='1923'>
<font color=#447700>!!       a(1)=0.<a name='1924'></font>
<font color=#447700>!!       b(1)=1.<a name='1925'></font>
<font color=#447700>!!       c(1)=-1.<a name='1926'></font>
<font color=#447700>!!       d(1)=0.<a name='1927'></font>
<a name='1928'>
<font color=#447700>! Since dfq(kts)=0.0, a(1)=0.0 and b(1)=1.+dtz(k)*dfq(k+1)+bp(k)*delt.<a name='1929'></font>
       DO k=kts,kte-1<a name='1930'>
          a(k-kts+1)=-dtz(k)*dfq(k)<a name='1931'>
          b(k-kts+1)=1.+dtz(k)*(dfq(k)+dfq(k+1))+bp(k)*delt<a name='1932'>
          c(k-kts+1)=-dtz(k)*dfq(k+1)<a name='1933'>
          d(k-kts+1)=rp(k)*delt + tsq(k)<a name='1934'>
       ENDDO<a name='1935'>
<a name='1936'>
<font color=#447700>!!       DO k=kts+1,kte-1<a name='1937'></font>
<font color=#447700>!!          a(k-kts+1)=-dtz(k)*dfq(k)<a name='1938'></font>
<font color=#447700>!!          b(k-kts+1)=1.+dtz(k)*(dfq(k)+dfq(k+1))<a name='1939'></font>
<font color=#447700>!!          c(k-kts+1)=-dtz(k)*dfq(k+1)<a name='1940'></font>
<font color=#447700>!!          d(k-kts+1)=rp(k)*delt + tsq(k) - tsq(k)*bp(k)*delt<a name='1941'></font>
<font color=#447700>!!       ENDDO<a name='1942'></font>
<a name='1943'>
       a(nz)=-1. <font color=#447700>!0.<a name='1944'></font>
       b(nz)=1.<a name='1945'>
       c(nz)=0.<a name='1946'>
       d(nz)=0.<a name='1947'>
       <a name='1948'>
       CALL <A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG'>tridiag</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_2">(nz,a,b,c,d)<a name='1949'>
       <a name='1950'>
       DO k=kts,kte<a name='1951'>
          tsq(k)=<A href='../../html_code/share/dfi.F.html#D'>d</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_8">(k-kts+1)<a name='1952'>
       ENDDO<a name='1953'>
       <a name='1954'>
<font color=#447700>!   **  Prediction of the moisture variance  **<a name='1955'></font>
<font color=#447700>!!       DO k = kts+1,kte-1<a name='1956'></font>
       DO k = kts,kte-1<a name='1957'>
          b2l = b2*0.5*( el(k+1)+el(k) )<a name='1958'>
          bp(k) = 2.*qkw(k) / b2l<a name='1959'>
          rp(k) = pdq(k+1) +pdq(k) <a name='1960'>
       END DO<a name='1961'>
       <a name='1962'>
<font color=#447700>!zero gradient for qsq at bottom and top<a name='1963'></font>
       <a name='1964'>
<font color=#447700>!!       a(1)=0.<a name='1965'></font>
<font color=#447700>!!       b(1)=1.<a name='1966'></font>
<font color=#447700>!!       c(1)=-1.<a name='1967'></font>
<font color=#447700>!!       d(1)=0.<a name='1968'></font>
<a name='1969'>
<font color=#447700>! Since dfq(kts)=0.0, a(1)=0.0 and b(1)=1.+dtz(k)*dfq(k+1)+bp(k)*delt.<a name='1970'></font>
       DO k=kts,kte-1<a name='1971'>
          a(k-kts+1)=-dtz(k)*dfq(k)<a name='1972'>
          b(k-kts+1)=1.+dtz(k)*(dfq(k)+dfq(k+1))+bp(k)*delt<a name='1973'>
          c(k-kts+1)=-dtz(k)*dfq(k+1)<a name='1974'>
          d(k-kts+1)=rp(k)*delt + qsq(k)<a name='1975'>
       ENDDO<a name='1976'>
<a name='1977'>
<font color=#447700>!!       DO k=kts+1,kte-1<a name='1978'></font>
<font color=#447700>!!          a(k-kts+1)=-dtz(k)*dfq(k)<a name='1979'></font>
<font color=#447700>!!          b(k-kts+1)=1.+dtz(k)*(dfq(k)+dfq(k+1))<a name='1980'></font>
<font color=#447700>!!          c(k-kts+1)=-dtz(k)*dfq(k+1)<a name='1981'></font>
<font color=#447700>!!          d(k-kts+1)=rp(k)*delt + qsq(k) -qsq(k)*bp(k)*delt<a name='1982'></font>
<font color=#447700>!!       ENDDO<a name='1983'></font>
<a name='1984'>
       a(nz)=-1. <font color=#447700>!0.<a name='1985'></font>
       b(nz)=1.<a name='1986'>
       c(nz)=0.<a name='1987'>
       d(nz)=0.<a name='1988'>
       <a name='1989'>
       CALL <A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG'>tridiag</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_3">(nz,a,b,c,d)<a name='1990'>
       <a name='1991'>
       DO k=kts,kte<a name='1992'>
          qsq(k)=<A href='../../html_code/share/dfi.F.html#D'>d</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_9">(k-kts+1)<a name='1993'>
       ENDDO<a name='1994'>
       <a name='1995'>
<font color=#447700>!   **  Prediction of the temperature-moisture covariance  **<a name='1996'></font>
<font color=#447700>!!       DO k = kts+1,kte-1<a name='1997'></font>
       DO k = kts,kte-1<a name='1998'>
          b2l = b2*0.5*( el(k+1)+el(k) )<a name='1999'>
          bp(k) = 2.*qkw(k) / b2l<a name='2000'>
          rp(k) = pdc(k+1) + pdc(k) <a name='2001'>
       END DO<a name='2002'>
       <a name='2003'>
<font color=#447700>!zero gradient for tqcov at bottom and top<a name='2004'></font>
       <a name='2005'>
<font color=#447700>!!       a(1)=0.<a name='2006'></font>
<font color=#447700>!!       b(1)=1.<a name='2007'></font>
<font color=#447700>!!       c(1)=-1.<a name='2008'></font>
<font color=#447700>!!       d(1)=0.<a name='2009'></font>
<a name='2010'>
<font color=#447700>! Since dfq(kts)=0.0, a(1)=0.0 and b(1)=1.+dtz(k)*dfq(k+1)+bp(k)*delt.<a name='2011'></font>
       DO k=kts,kte-1<a name='2012'>
          a(k-kts+1)=-dtz(k)*dfq(k)<a name='2013'>
          b(k-kts+1)=1.+dtz(k)*(dfq(k)+dfq(k+1))+bp(k)*delt<a name='2014'>
          c(k-kts+1)=-dtz(k)*dfq(k+1)<a name='2015'>
          d(k-kts+1)=rp(k)*delt + cov(k)<a name='2016'>
       ENDDO<a name='2017'>
<a name='2018'>
<font color=#447700>!!       DO k=kts+1,kte-1<a name='2019'></font>
<font color=#447700>!!          a(k-kts+1)=-dtz(k)*dfq(k)<a name='2020'></font>
<font color=#447700>!!          b(k-kts+1)=1.+dtz(k)*(dfq(k)+dfq(k+1))<a name='2021'></font>
<font color=#447700>!!          c(k-kts+1)=-dtz(k)*dfq(k+1)<a name='2022'></font>
<font color=#447700>!!          d(k-kts+1)=rp(k)*delt + cov(k) - cov(k)*bp(k)*delt<a name='2023'></font>
<font color=#447700>!!       ENDDO<a name='2024'></font>
<a name='2025'>
       a(nz)=-1. <font color=#447700>!0.<a name='2026'></font>
       b(nz)=1.<a name='2027'>
       c(nz)=0.<a name='2028'>
       d(nz)=0.<a name='2029'>
       <a name='2030'>
       CALL <A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG'>tridiag</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_4">(nz,a,b,c,d)<a name='2031'>
       <a name='2032'>
       DO k=kts,kte<a name='2033'>
          cov(k)=<A href='../../html_code/share/dfi.F.html#D'>d</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_10">(k-kts+1)<a name='2034'>
       ENDDO<a name='2035'>
       <a name='2036'>
    ELSE<a name='2037'>
<font color=#447700>!!       DO k = kts+1,kte-1<a name='2038'></font>
       DO k = kts,kte-1<a name='2039'>
          IF ( qkw(k) .LE. 0.0 ) THEN<a name='2040'>
             b2l = 0.0<a name='2041'>
          ELSE<a name='2042'>
             b2l = b2*0.25*( el(k+1)+el(k) )/qkw(k)<a name='2043'>
          END IF<a name='2044'>
<font color=#447700>!<a name='2045'></font>
          tsq(k) = b2l*( pdt(k+1)+pdt(k) )<a name='2046'>
          qsq(k) = b2l*( pdq(k+1)+pdq(k) )<a name='2047'>
          cov(k) = b2l*( pdc(k+1)+pdc(k) )<a name='2048'>
       END DO<a name='2049'>
       <a name='2050'>
<font color=#447700>!!       tsq(kts)=tsq(kts+1)<a name='2051'></font>
<font color=#447700>!!       qsq(kts)=qsq(kts+1)<a name='2052'></font>
<font color=#447700>!!       cov(kts)=cov(kts+1)<a name='2053'></font>
<a name='2054'>
       tsq(kte)=tsq(kte-1)<a name='2055'>
       qsq(kte)=qsq(kte-1)<a name='2056'>
       cov(kte)=cov(kte-1)<a name='2057'>
      <a name='2058'>
    END IF<a name='2059'>
<a name='2060'>
  END SUBROUTINE mym_predict<a name='2061'>
  <a name='2062'>
<font color=#447700>! ==================================================================<a name='2063'></font>
<font color=#447700>!     SUBROUTINE  mym_condensation:<a name='2064'></font>
<font color=#447700>!<a name='2065'></font>
<font color=#447700>!     Input variables:    see subroutine mym_initialize and turbulence<a name='2066'></font>
<font color=#447700>!       exner(nz)    : Perturbation of the Exner function    (J/kg K)<a name='2067'></font>
<font color=#447700>!                         defined on the walls of the grid boxes<a name='2068'></font>
<font color=#447700>!                         This is usually computed by integrating<a name='2069'></font>
<font color=#447700>!                         d(pi)/dz = h*g*tv/tref**2<a name='2070'></font>
<font color=#447700>!                         from the upper boundary, where tv is the<a name='2071'></font>
<font color=#447700>!                         virtual potential temperature minus tref.<a name='2072'></font>
<font color=#447700>!<a name='2073'></font>
<font color=#447700>!     Output variables:   see subroutine mym_initialize<a name='2074'></font>
<font color=#447700>!       cld(nx,nz,ny)   : Cloud fraction<a name='2075'></font>
<font color=#447700>!<a name='2076'></font>
<font color=#447700>!     Work arrays:<a name='2077'></font>
<font color=#447700>!       qmq(nx,nz,ny)   : Q_w-Q_{sl}, where Q_{sl} is the saturation<a name='2078'></font>
<font color=#447700>!                         specific humidity at T=Tl<a name='2079'></font>
<font color=#447700>!       alp(nx,nz,ny)   : Functions in the condensation process<a name='2080'></font>
<font color=#447700>!       bet(nx,nz,ny)   : ditto<a name='2081'></font>
<font color=#447700>!       sgm(nx,nz,ny)   : Combined standard deviation sigma_s<a name='2082'></font>
<font color=#447700>!                         multiplied by 2/alp<a name='2083'></font>
<font color=#447700>!<a name='2084'></font>
<font color=#447700>!     # qmq, alp, bet and sgm are allowed to share storage units with<a name='2085'></font>
<font color=#447700>!       any four of other work arrays for saving memory.<a name='2086'></font>
<font color=#447700>!<a name='2087'></font>
<font color=#447700>!     # Results are sensitive particularly to values of cp and rd.<a name='2088'></font>
<font color=#447700>!       Set these values to those adopted by you.<a name='2089'></font>
<font color=#447700>!<a name='2090'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='2091'></font>
<A NAME='MYM_CONDENSATION'><A href='../../html_code/phys/module_bl_mynn.F.html#MYM_CONDENSATION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2092'>
  <font color=#993300>SUBROUTINE  </font><font color=#cc0000>mym_condensation</font> (kts,kte,  &amp; <A href='../../call_to/MYM_CONDENSATION.html' TARGET='index'>2</A><a name='2093'>
    &amp;            dx, dz,                  &amp;<a name='2094'>
    &amp;            thl, qw,                 &amp;<a name='2095'>
    &amp;            p,exner,                 &amp;<a name='2096'>
    &amp;            tsq, qsq, cov,           &amp;<a name='2097'>
    &amp;            Sh, el, bl_mynn_cloudpdf,&amp;<a name='2098'>
    &amp;            qc_bl1D, cldfra_bl1D,    &amp;<a name='2099'>
    &amp;            PBLH1,HFX1,              &amp;<a name='2100'>
    &amp;            Vt, Vq, th, sgm)<a name='2101'>
<a name='2102'>
<font color=#447700>!-------------------------------------------------------------------<a name='2103'></font>
<a name='2104'>
    INTEGER, INTENT(IN)   :: kts,kte, bl_mynn_cloudpdf<a name='2105'>
    REAL, INTENT(IN)      :: dx,PBLH1,HFX1<a name='2106'>
    REAL, DIMENSION(kts:kte), INTENT(IN) :: dz<a name='2107'>
    REAL, DIMENSION(kts:kte), INTENT(IN) :: p,exner, thl, qw, &amp;<a name='2108'>
         &amp;tsq, qsq, cov, th<a name='2109'>
<a name='2110'>
    REAL, DIMENSION(kts:kte), INTENT(INOUT) :: vt,vq,sgm<a name='2111'>
<a name='2112'>
    REAL, DIMENSION(kts:kte) :: qmq,alp,a,bet,b,ql,q1,cld,RH<a name='2113'>
    REAL, DIMENSION(kts:kte), INTENT(OUT) :: qc_bl1D,cldfra_bl1D<a name='2114'>
    DOUBLE PRECISION :: t3sq, r3sq, c3sq<a name='2115'>
<a name='2116'>
    REAL :: p2a,qsl,esat,qsat,tlk,qsat_tl,dqsl,cld0,q1k,eq1,qll,&amp;<a name='2117'>
         &amp;q2p,pt,rac,qt,t,xl,rsl,cpm,cdhdz,Fng,qww,alpha,beta,bb,ls_min,ls,wt<a name='2118'>
    INTEGER :: i,j,k<a name='2119'>
<a name='2120'>
    REAL :: erf<a name='2121'>
<a name='2122'>
    <font color=#447700>!JOE: NEW VARIABLES FOR ALTERNATE SIGMA<a name='2123'></font>
    REAL::dth,dtl,dqw,dzk<a name='2124'>
    REAL, DIMENSION(kts:kte), INTENT(IN) :: Sh,el<a name='2125'>
<a name='2126'>
    <font color=#447700>!JOE: variables for BL clouds<a name='2127'></font>
    REAL::zagl,cld9,damp,edown,RHcrit,RHmean,RHsum,RHnum,Hshcu,PBLH2,ql_limit<a name='2128'>
    REAL, PARAMETER :: Hfac = 3.0     <font color=#447700>!cloud depth factor for HFX (m^3/W)<a name='2129'></font>
    REAL, PARAMETER :: HFXmin = 50.0  <font color=#447700>!min W/m^2 for BL clouds<a name='2130'></font>
    REAL            :: RH_00L, RH_00O, phi_dz, lfac<a name='2131'>
    REAL, PARAMETER :: cdz = 2.0<a name='2132'>
    REAL, PARAMETER :: mdz = 1.5<a name='2133'>
<a name='2134'>
    <font color=#447700>!JAYMES:  variables for tropopause-height estimation<a name='2135'></font>
    REAL            :: theta1, theta2, ht1, ht2<a name='2136'>
    INTEGER         :: k_tropo<a name='2137'>
<a name='2138'>
<font color=#447700>! First, obtain an estimate for the tropopause height (k), using the method employed in the<a name='2139'></font>
<font color=#447700>! Thompson subgrid-cloud scheme.  This height will be a consideration later when determining <a name='2140'></font>
<font color=#447700>! the "final" subgrid-cloud properties.<a name='2141'></font>
<font color=#447700>! JAYMES:  added 3 Nov 2016, adapted from G. Thompson<a name='2142'></font>
<a name='2143'>
      DO k = kte-3, kts, -1<a name='2144'>
         theta1 = th(k)<a name='2145'>
         theta2 = th(k+2)<a name='2146'>
         ht1 = 44307.692 * (1.0 - (p(k)/101325.)**0.190)<a name='2147'>
         ht2 = 44307.692 * (1.0 - (p(k+2)/101325.)**0.190)<a name='2148'>
         if ( (((theta2-theta1)/(ht2-ht1)) .lt. 10./1500. ) .AND.       &amp;<a name='2149'>
     &amp;                       (ht1.lt.19000.) .and. (ht1.gt.4000.) ) then <a name='2150'>
            goto 86<a name='2151'>
         endif<a name='2152'>
      ENDDO<a name='2153'>
 86   continue<a name='2154'>
      k_tropo = MAX(kts+2, k+2)<a name='2155'>
<a name='2156'>
<font color=#447700>! WA TEST 8/6/15 save incoming qc and cldfra (from EDMF?)<a name='2157'></font>
 <font color=#447700>!   qc_prev = qc_bl1D<a name='2158'></font>
 <font color=#447700>!   cldfra_prev = cldfra_bl1D<a name='2159'></font>
<a name='2160'>
    zagl = 0.<a name='2161'>
<font color=#447700>! Note: kte needs to be larger than kts, i.e., kte &gt;= kts+1.<a name='2162'></font>
    DO k = kts,kte-1<a name='2163'>
       t  = th(k)*exner(k)<a name='2164'>
<a name='2165'>
<font color=#447700>!x      if ( ct .gt. 0.0 ) then<a name='2166'></font>
<font color=#447700>!       a  =  17.27<a name='2167'></font>
<font color=#447700>!       b  = 237.3<a name='2168'></font>
<font color=#447700>!x      else<a name='2169'></font>
<font color=#447700>!x        a  =  21.87<a name='2170'></font>
<font color=#447700>!x        b  = 265.5<a name='2171'></font>
<font color=#447700>!x      end if<a name='2172'></font>
<font color=#447700>!<a name='2173'></font>
<font color=#447700>!   **  3.8 = 0.622*6.11 (hPa)  **<a name='2174'></font>
<a name='2175'>
       <font color=#447700>!SATURATED VAPOR PRESSURE<a name='2176'></font>
       esat = <A href='../../html_code/phys/module_bl_mynn.F.html#ESAT_BLEND'>esat_blend</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESAT_BLEND_1">(t)<a name='2177'>
       <font color=#447700>!SATURATED SPECIFIC HUMIDITY<a name='2178'></font>
       qsl=ep_2*esat/(p(k)-ep_3*esat)<a name='2179'>
       <font color=#447700>!dqw/dT: Clausius-Clapeyron<a name='2180'></font>
       dqsl = qsl*ep_2*ev/( rd*t**2 )<a name='2181'>
       <font color=#447700>!RH (0 to 1.0)<a name='2182'></font>
       RH(k)=MAX(MIN(1.0,qw(k)/MAX(1.E-8,qsl)),0.001)<a name='2183'>
<a name='2184'>
       alp(k) = 1.0/( 1.0+dqsl*xlvcp )<a name='2185'>
       bet(k) = dqsl*p2a<a name='2186'>
<a name='2187'>
       IF (bl_mynn_cloudpdf == 0) THEN<a name='2188'>
          <font color=#447700>!NOTE: negative bl_mynn_cloudpdf will zero-out the stratus subgrid clouds<a name='2189'></font>
          <font color=#447700>!      at the end of this subroutine. <a name='2190'></font>
          <font color=#447700>!Sommeria and Deardorff (1977) scheme, as implemented<a name='2191'></font>
          <font color=#447700>!in Nakanishi and Niino (2009), Appendix B<a name='2192'></font>
          t3sq = MAX( tsq(k), 0.0 )<a name='2193'>
          r3sq = MAX( qsq(k), 0.0 )<a name='2194'>
          c3sq =      cov(k)<a name='2195'>
          c3sq = SIGN( MIN( ABS(c3sq), SQRT(t3sq*r3sq) ), c3sq )<a name='2196'>
          r3sq = r3sq +bet(k)**2*t3sq -2.0*bet(k)*c3sq<a name='2197'>
          <font color=#447700>!DEFICIT/EXCESS WATER CONTENT<a name='2198'></font>
          qmq(k) = qw(k) -qsl<a name='2199'>
          <font color=#447700>!ORIGINAL STANDARD DEVIATION: limit e-6 produces ~10% more BL clouds<a name='2200'></font>
          <font color=#447700>!than e-10<a name='2201'></font>
          sgm(k) = SQRT( MAX( r3sq, 1.0d-10 ))<a name='2202'>
          <font color=#447700>!NORMALIZED DEPARTURE FROM SATURATION<a name='2203'></font>
          q1(k)   = qmq(k) / sgm(k)<a name='2204'>
          <font color=#447700>!CLOUD FRACTION. rr2 = 1/SQRT(2) = 0.707<a name='2205'></font>
          cld(k) = 0.5*( 1.0+erf( q1(k)*rr2 ) )<a name='2206'>
<a name='2207'>
       ELSE IF (bl_mynn_cloudpdf == 1 .OR. bl_mynn_cloudpdf == -1) THEN<a name='2208'>
          <font color=#447700>!ALTERNATIVE FORM (Nakanishi &amp; Niino 2004 BLM, eq. B6, and <a name='2209'></font>
          <font color=#447700>!Kuwano-Yoshida et al. 2010 QJRMS, eq. 7):<a name='2210'></font>
          if (k .eq. kts) then <a name='2211'>
             dzk = 0.5*dz(k)<a name='2212'>
          else<a name='2213'>
             dzk = 0.5*( dz(k) + dz(k-1) )<a name='2214'>
          end if<a name='2215'>
          dth = 0.5*(thl(k+1)+thl(k)) - 0.5*(thl(k)+thl(MAX(k-1,kts)))<a name='2216'>
          dqw = 0.5*(qw(k+1) + qw(k)) - 0.5*(qw(k) + qw(MAX(k-1,kts)))<a name='2217'>
          sgm(k) = SQRT( MAX( (alp(k)**2 * MAX(el(k)**2,0.1) * &amp;<a name='2218'>
                             b2 * MAX(Sh(k),0.03))/4. * &amp;<a name='2219'>
                      (dqw/dzk - bet(k)*(dth/dzk ))**2 , 1.0e-10) )<a name='2220'>
          qmq(k) = qw(k) -qsl<a name='2221'>
          q1(k)   = qmq(k) / sgm(k)<a name='2222'>
          cld(k) = 0.5*( 1.0+erf( q1(k)*rr2 ) )<a name='2223'>
<a name='2224'>
       ELSE IF (bl_mynn_cloudpdf == 2 .OR. bl_mynn_cloudpdf == -2) THEN<a name='2225'>
          <font color=#447700>!Diagnostic statistical scheme of Chaboureau and Bechtold (2002), JAS<a name='2226'></font>
          <font color=#447700>!JAYMES- this added 27 Apr 2015<a name='2227'></font>
          xl = <A href='../../html_code/phys/module_bl_mynn.F.html#XL_BLEND'>xl_blend</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="XL_BLEND_1">(t)                    <font color=#447700>! obtain latent heat<a name='2228'></font>
<a name='2229'>
          tlk = thl(k)*(p(k)/p1000mb)**rcp    <font color=#447700>! recover liquid temp (tl) from thl<a name='2230'></font>
<a name='2231'>
          qsat_tl = <A href='../../html_code/phys/module_bl_mynn.F.html#QSAT_BLEND'>qsat_blend</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_BLEND_1">(tlk,p(k))      <font color=#447700>! get saturation water vapor mixing ratio<a name='2232'></font>
                                              <font color=#447700>!   at tl and p<a name='2233'></font>
<a name='2234'>
          rsl = xl*qsat_tl / (r_v*tlk**2)     <font color=#447700>! slope of C-C curve at t = tl<a name='2235'></font>
                                              <font color=#447700>! CB02, Eqn. 4<a name='2236'></font>
 <a name='2237'>
          cpm = cp + qw(k)*cpv                <font color=#447700>! CB02, sec. 2, para. 1<a name='2238'></font>
     <a name='2239'>
          a(k) = 1./(1. + xl*rsl/cpm)         <font color=#447700>! CB02 variable "a"<a name='2240'></font>
<a name='2241'>
          qmq(k) = a(k) * (qw(k) - qsat_tl) <font color=#447700>! saturation deficit/excess;<a name='2242'></font>
                                              <font color=#447700>!   the numerator of Q1<a name='2243'></font>
<a name='2244'>
          b(k) = a(k)*rsl                     <font color=#447700>! CB02 variable "b"<a name='2245'></font>
<a name='2246'>
          dtl =    0.5*(thl(k+1)*(p(k+1)/p1000mb)**rcp + tlk) &amp;<a name='2247'>
               &amp; - 0.5*(tlk + thl(MAX(k-1,kts))*(p(MAX(k-1,kts))/p1000mb)**rcp)<a name='2248'>
<a name='2249'>
          dqw = 0.5*(qw(k+1) + qw(k)) - 0.5*(qw(k) + qw(MAX(k-1,kts)))<a name='2250'>
<a name='2251'>
          if (k .eq. kts) then<a name='2252'>
             dzk = 0.5*dz(k)<a name='2253'>
          else<a name='2254'>
             dzk = 0.5*( dz(k) + dz(k-1) )<a name='2255'>
          end if<a name='2256'>
<a name='2257'>
          cdhdz = dtl/dzk + (g/cpm)*(1.+qw(k))  <font color=#447700>! expression below Eq. 9<a name='2258'></font>
                                                <font color=#447700>! in CB02<a name='2259'></font>
<a name='2260'>
          zagl = zagl + dz(k)<a name='2261'>
          ls_min = MIN(MAX(zagl,25.),300.) <font color=#447700>! Let this be the minimum possible length scale:<a name='2262'></font>
                                       <font color=#447700>!   25 m &lt; ls_min(=zagl) &lt; 300 m<a name='2263'></font>
          lfac=MIN(4.25+dx/4000.,6.)   <font color=#447700>! A dx-dependent multiplier for the master length scale:<a name='2264'></font>
                                       <font color=#447700>!   lfac(750 m) = 4.4<a name='2265'></font>
                                       <font color=#447700>!   lfac(3 km)  = 5.0<a name='2266'></font>
                                       <font color=#447700>!   lfac(13 km) = 6.0<a name='2267'></font>
<a name='2268'>
          ls = MAX(MIN(lfac*el(k),900.),ls_min)  <font color=#447700>! Bounded:  ls_min &lt; ls &lt; 900 m<a name='2269'></font>
                  <font color=#447700>! Note: CB02 use 900 m as a constant free-atmosphere length scale. <a name='2270'></font>
<a name='2271'>
                  <font color=#447700>! Above 300 m AGL, ls_min remains 300 m.  For dx = 3 km, the <a name='2272'></font>
                  <font color=#447700>! MYNN master length scale (el) must exceed 60 m before ls<a name='2273'></font>
                  <font color=#447700>! becomes responsive to el, otherwise ls = ls_min = 300 m.<a name='2274'></font>
<a name='2275'>
          sgm(k) = MAX(1.e-10, 0.225*ls*SQRT(MAX(0., &amp; <font color=#447700>! Eq. 9 in CB02:<a name='2276'></font>
                  &amp; (a(k)*dqw/dzk)**2              &amp; <font color=#447700>! &lt; 1st term in brackets,<a name='2277'></font>
                  &amp; -2*a(k)*b(k)*cdhdz*dqw/dzk     &amp; <font color=#447700>! &lt; 2nd term,<a name='2278'></font>
                  &amp; +b(k)**2 * cdhdz**2)))           <font color=#447700>! &lt; 3rd term<a name='2279'></font>
                  <font color=#447700>! CB02 use a multiplier of 0.2, but 0.225 is chosen<a name='2280'></font>
                  <font color=#447700>! based on tests<a name='2281'></font>
<a name='2282'>
          q1(k) = qmq(k) / sgm(k)  <font color=#447700>! Q1, the normalized saturation<a name='2283'></font>
<a name='2284'>
          cld(k) = MAX(0., MIN(1., 0.5+0.36*ATAN(1.55*q1(k)))) <font color=#447700>! Eq. 7 in CB02<a name='2285'></font>
<a name='2286'>
       ENDIF<a name='2287'>
    END DO<a name='2288'>
<a name='2289'>
    zagl = 0.<a name='2290'>
    RHsum=0.<a name='2291'>
    RHnum=0.<a name='2292'>
    RHmean=0.1 <font color=#447700>!initialize with small value for small PBLH cases<a name='2293'></font>
    damp =0<a name='2294'>
    PBLH2=MAX(10.,PBLH1)<a name='2295'>
<a name='2296'>
    DO k = kts,kte-1<a name='2297'>
         t    = th(k)*exner(k)<a name='2298'>
         q1k  = q1(k)<a name='2299'>
         zagl = zagl + dz(k)<a name='2300'>
         <font color=#447700>!q1=0.<a name='2301'></font>
         <font color=#447700>!cld(k)=0.<a name='2302'></font>
<a name='2303'>
         IF ( bl_mynn_cloudpdf &lt;= 1 .AND. bl_mynn_cloudpdf &gt;= -1) THEN<a name='2304'>
<a name='2305'>
              <font color=#447700>!COMPUTE MEAN RH IN PBL (NOT PRESSURE WEIGHTED).<a name='2306'></font>
              IF (zagl &lt; PBLH2 .AND. PBLH2 &gt; 400.) THEN<a name='2307'>
                 RHsum=RHsum+RH(k)<a name='2308'>
                 RHnum=RHnum+1.0<a name='2309'>
                 RHmean=RHsum/RHnum<a name='2310'>
              ENDIF<a name='2311'>
<a name='2312'>
              RHcrit = 1. - 0.35*(1.0 - (MAX(250.- MAX(HFX1,HFXmin),0.0)/200.)**2)<a name='2313'>
              if(HFX1 &gt; HFXmin)then<a name='2314'>
                 cld9=MIN(MAX(0., (rh(k)-RHcrit)/(1.1-RHcrit)), 1.)**2<a name='2315'>
              else<a name='2316'>
                 cld9=0.0<a name='2317'>
              endif<a name='2318'>
       <a name='2319'>
              edown=PBLH2*.1<a name='2320'>
              <font color=#447700>!Vary BL cloud depth (Hshcu) by mean RH in PBL and HFX <a name='2321'></font>
              <font color=#447700>!(somewhat following results from Zhang and Klein (2013, JAS))<a name='2322'></font>
              Hshcu=200. + (RHmean+0.5)**1.5*MAX(HFX1,0.)*Hfac<a name='2323'>
              if(zagl &lt; PBLH2-edown)then<a name='2324'>
                 damp=MIN(1.0,exp(-ABS(((PBLH2-edown)-zagl)/edown)))<a name='2325'>
              elseif(zagl &gt;= PBLH2-edown .AND. zagl &lt; PBLH2+Hshcu)then<a name='2326'>
                 damp=1.<a name='2327'>
              elseif (zagl &gt;= PBLH2+Hshcu)then<a name='2328'>
                 damp=MIN(1.0,exp(-ABS((zagl-(PBLH2+Hshcu))/500.)))<a name='2329'>
              endif<a name='2330'>
              cldfra_bl1D(k)=cld9*damp<a name='2331'>
              <font color=#447700>!cldfra_bl1D(k)=cld(k) ! JAYMES: use this form to retain the Sommeria-Deardorff value<a name='2332'></font>
       <a name='2333'>
              <font color=#447700>!use alternate cloud fraction to estimate qc for use in BL clouds-radiation<a name='2334'></font>
              eq1  = rrp*EXP( -0.5*q1k*q1k )<a name='2335'>
              qll  = MAX( cldfra_bl1D(k)*q1k + eq1, 0.0 )<a name='2336'>
              <font color=#447700>!ESTIMATED LIQUID WATER CONTENT (UNNORMALIZED)<a name='2337'></font>
              ql (k) = alp(k)*sgm(k)*qll<a name='2338'>
              if(cldfra_bl1D(k)&gt;0.01 .and. ql(k)&lt;1.E-6)ql(k)=1.E-6<a name='2339'>
              qc_bl1D(k)=ql(k)*damp<a name='2340'>
              <font color=#447700>!qc_bl1D(k)=ql(k) ! JAYMES: use this form to retain the Sommeria-Deardorff value<a name='2341'></font>
       <a name='2342'>
              <font color=#447700>!now recompute estimated lwc for PBL scheme's use<a name='2343'></font>
              <font color=#447700>!qll IS THE NORMALIZED LIQUID WATER CONTENT (Sommeria and<a name='2344'></font>
              <font color=#447700>!Deardorff (1977, eq 29a). rrp = 1/(sqrt(2*pi)) = 0.3989<a name='2345'></font>
              eq1  = rrp*EXP( -0.5*q1k*q1k )<a name='2346'>
              qll  = MAX( cld(k)*q1k + eq1, 0.0 )<a name='2347'>
              <font color=#447700>!ESTIMATED LIQUID WATER CONTENT (UNNORMALIZED)<a name='2348'></font>
              ql (k) = alp(k)*sgm(k)*qll<a name='2349'>
       <a name='2350'>
              q2p = xlvcp/exner(k)<a name='2351'>
              pt = thl(k) +q2p*ql(k) <font color=#447700>! potential temp<a name='2352'></font>
       <a name='2353'>
              <font color=#447700>!qt is a THETA-V CONVERSION FOR TOTAL WATER (i.e., THETA-V = qt*THETA)<a name='2354'></font>
              qt   = 1.0 +p608*qw(k) -(1.+p608)*ql(k)<a name='2355'>
              rac  = alp(k)*( cld(k)-qll*eq1 )*( q2p*qt-(1.+p608)*pt )<a name='2356'>
       <a name='2357'>
              <font color=#447700>!BUOYANCY FACTORS: wherever vt and vq are used, there is a<a name='2358'></font>
              <font color=#447700>!"+1" and "+tv0", respectively, so these are subtracted out here.<a name='2359'></font>
              <font color=#447700>!vt is unitless and vq has units of K.<a name='2360'></font>
              vt(k) =      qt-1.0 -rac*bet(k)<a name='2361'>
              vq(k) = p608*pt-tv0 +rac<a name='2362'>
       <a name='2363'>
         ELSE IF ( bl_mynn_cloudpdf == 2 .OR.  bl_mynn_cloudpdf == -2) THEN<a name='2364'>
         <font color=#447700>! JAYMES- this option added 8 May 2015<a name='2365'></font>
         <font color=#447700>! The cloud water formulations are taken from CB02, Eq. 8.<a name='2366'></font>
         <font color=#447700>! "fng" represents the non-Gaussian contribution to the liquid<a name='2367'></font>
         <font color=#447700>! water flux; these formulations are from Cuijpers and Bechtold<a name='2368'></font>
         <font color=#447700>! (1995), Eq. 7.  CB95 also draws from Bechtold et al. 1995,<a name='2369'></font>
         <font color=#447700>! hereafter BCMT95<a name='2370'></font>
              IF (q1k &lt; 0.) THEN                 <a name='2371'>
                ql (k) = sgm(k)*EXP(1.2*q1k-1)<a name='2372'>
              ELSE IF (q1k &gt; 2.) THEN<a name='2373'>
                ql (k) = sgm(k)*q1k<a name='2374'>
              ELSE<a name='2375'>
                ql (k) = sgm(k)*(EXP(-1.) + 0.66*q1k + 0.086*q1k**2)<a name='2376'>
              ENDIF<a name='2377'>
  <a name='2378'>
              <font color=#447700>!Next, adjust our initial estimates of cldfra and ql based<a name='2379'></font>
              <font color=#447700>!on tropopause-height and PBLH considerations<a name='2380'></font>
              <font color=#447700>!JAYMES:  added 4 Nov 2016<a name='2381'></font>
              if ((cld(k) .gt. 0.) .or. (ql(k) .gt. 0.))  then<a name='2382'>
                 if (k .le. k_tropo) then<a name='2383'>
                   <font color=#447700>!At and below tropopause: impose an upper limit on ql; assume that<a name='2384'></font>
                   <font color=#447700>!a maximum of 0.5 percent supersaturation in water vapor can be<a name='2385'></font>
                   <font color=#447700>!available for cloud production<a name='2386'></font>
                    ql_limit = 0.005 * qsat_blend( th(k)*exner(k), p(k) )<a name='2387'>
                    ql(k) = MIN( ql(k), ql_limit )<a name='2388'>
                 else<a name='2389'>
                   <font color=#447700>!Above tropopause:  eliminate subgrid clouds from CB scheme<a name='2390'></font>
                    cld(k) = 0.<a name='2391'>
                    ql(k) = 0.<a name='2392'>
                 endif <a name='2393'>
              endif<a name='2394'>
       <a name='2395'>
              <font color=#447700>!Buoyancy-flux-related calculations follow...<a name='2396'></font>
              <font color=#447700>! "Fng" represents the non-Gaussian transport factor<a name='2397'></font>
              <font color=#447700>! (non-dimensional) from from Bechtold et al. 1995 <a name='2398'></font>
              <font color=#447700>! (hereafter BCMT95), section 3(c).  Their suggested <a name='2399'></font>
              <font color=#447700>! forms for Fng (from their Eq. 20) are:<a name='2400'></font>
              <font color=#447700>!IF (q1k &lt; -2.) THEN<a name='2401'></font>
              <font color=#447700>!  Fng = 2.-q1k<a name='2402'></font>
              <font color=#447700>!ELSE IF (q1k &gt; 0.) THEN<a name='2403'></font>
              <font color=#447700>!  Fng = 1.<a name='2404'></font>
              <font color=#447700>!ELSE<a name='2405'></font>
              <font color=#447700>!  Fng = 1.-1.5*q1k<a name='2406'></font>
              <font color=#447700>!ENDIF<a name='2407'></font>
              <font color=#447700>! For purposes of the buoyancy flux in stratus, we will use Fng = 1<a name='2408'></font>
              Fng = 1.<a name='2409'>
<a name='2410'>
              xl    = <A href='../../html_code/phys/module_bl_mynn.F.html#XL_BLEND'>xl_blend</A><A href='../../html_code/phys/module_bl_mynn.F.html#BOULAC_LENGTH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="XL_BLEND_2">(t)<a name='2411'>
              bb = b(k)*t/th(k) <font color=#447700>! bb is "b" in BCMT95.  Their "b" differs from<a name='2412'></font>
                                <font color=#447700>! "b" in CB02 (i.e., b(k) above) by a factor<a name='2413'></font>
                                <font color=#447700>! of T/theta.  Strictly, b(k) above is formulated in<a name='2414'></font>
                                <font color=#447700>! terms of sat. mixing ratio, but bb in BCMT95 is<a name='2415'></font>
                                <font color=#447700>! cast in terms of sat. specific humidity.  The<a name='2416'></font>
                                <font color=#447700>! conversion is neglected here.<a name='2417'></font>
              qww   = 1.+0.61*qw(k)<a name='2418'>
              alpha = 0.61*th(k)<a name='2419'>
              beta  = (th(k)/t)*(xl/cp) - 1.61*th(k)<a name='2420'>
<a name='2421'>
              vt(k) = qww   - cld(k)*beta*bb*Fng   - 1.<a name='2422'>
              vq(k) = alpha + cld(k)*beta*a(k)*Fng - tv0<a name='2423'>
              <font color=#447700>! vt and vq correspond to beta-theta and beta-q, respectively,<a name='2424'></font>
              <font color=#447700>! in NN09, Eq. B8.  They also correspond to the bracketed<a name='2425'></font>
              <font color=#447700>! expressions in BCMT95, Eq. 15, since (s*ql/sigma^2) = cldfra*Fng<a name='2426'></font>
              <font color=#447700>! The "-1" and "-tv0" terms are included for consistency with<a name='2427'></font>
              <font color=#447700>! the legacy vt and vq formulations (above).<a name='2428'></font>
<a name='2429'>
              <font color=#447700>! increase the cloud fraction estimate below PBLH+1km<a name='2430'></font>
              if (zagl .lt. PBLH2+1000.) cld(k) = MIN( 1., 1.8*cld(k) )<a name='2431'>
              <font color=#447700>!return a cloud condensate and cloud fraction for icloud_bl option:<a name='2432'></font>
              cldfra_bl1D(k) = cld(k)<a name='2433'>
              qc_bl1D(k) = ql(k)<a name='2434'>
       <a name='2435'>
         ENDIF <font color=#447700>!end cloudPDF option<a name='2436'></font>
<a name='2437'>
         <font color=#447700>!FOR TESTING PURPOSES ONLY, ISOLATE ON THE MASS-CLOUDS.<a name='2438'></font>
         IF (bl_mynn_cloudpdf .LT. 0) THEN<a name='2439'>
              cldfra_bl1D(k) = 0.0<a name='2440'>
              qc_bl1D(k) = 0.0<a name='2441'>
         ENDIF<a name='2442'>
         <font color=#447700>!To avoid FPE in radiation driver, when these two quantities are multiplied by eachother,<a name='2443'></font>
         <font color=#447700>! add limit to qc_bl and cldfra_bl:<a name='2444'></font>
         IF (QC_BL1D(k) &lt; 1E-6 .AND. ABS(CLDFRA_BL1D(k)) &gt; 0.01) QC_BL1D(k)= 1E-6<a name='2445'>
         IF (CLDFRA_BL1D(k) &lt; 1E-2)THEN<a name='2446'>
            CLDFRA_BL1D(k)=0.<a name='2447'>
            QC_BL1D(k)=0.<a name='2448'>
         ENDIF<a name='2449'>
<a name='2450'>
    END DO<a name='2451'>
<font color=#447700>!<a name='2452'></font>
<a name='2453'>
    cld(kte) = cld(kte-1)<a name='2454'>
    ql(kte) = ql(kte-1)<a name='2455'>
    vt(kte) = vt(kte-1)<a name='2456'>
    vq(kte) = vq(kte-1)<a name='2457'>
    qc_bl1D(kte)=0.<a name='2458'>
    cldfra_bl1D(kte)=0.<a name='2459'>
<a name='2460'>
    RETURN<a name='2461'>
<a name='2462'>
  END SUBROUTINE mym_condensation<a name='2463'>
<a name='2464'>
<font color=#447700>! ==================================================================<a name='2465'></font>
<A NAME='MYNN_TENDENCIES'><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2466'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>mynn_tendencies</font>(kts,kte,      &amp; <A href='../../call_to/MYNN_TENDENCIES.html' TARGET='index'>1</A>,<A href='../../call_from/MYNN_TENDENCIES.html' TARGET='index'>13</A><a name='2467'>
       &amp;levflag,grav_settling,             &amp;<a name='2468'>
       &amp;delt,dz,                           &amp;<a name='2469'>
       &amp;u,v,th,tk,qv,qc,qi,qni,qnc,        &amp;<a name='2470'>
       &amp;p,exner,                           &amp;<a name='2471'>
       &amp;thl,sqv,sqc,sqi,sqw,               &amp;<a name='2472'>
       &amp;ust,flt,flq,flqv,flqc,wspd,qcg,    &amp;<a name='2473'>
       &amp;uoce,voce,                         &amp;<a name='2474'>
       &amp;tsq,qsq,cov,                       &amp;<a name='2475'>
       &amp;tcd,qcd,                           &amp;<a name='2476'>
       &amp;dfm,dfh,dfq,                       &amp;<a name='2477'>
       &amp;Du,Dv,Dth,Dqv,Dqc,Dqi,Dqni,        &amp;<font color=#447700>!Dqnc,   &amp;<a name='2478'></font>
       &amp;vdfg1,                             &amp;<a name='2479'>
       &amp;s_aw,s_awthl,s_awqt,s_awqv,s_awqc, &amp;<a name='2480'>
       &amp;s_awu,s_awv,                       &amp;<a name='2481'>
       &amp;FLAG_QI,FLAG_QNI,FLAG_QC,FLAG_QNC, &amp;<a name='2482'>
       &amp;cldfra_bl1d,                       &amp;<a name='2483'>
       &amp;bl_mynn_cloudmix,                  &amp;<a name='2484'>
       &amp;bl_mynn_mixqt,                     &amp;<a name='2485'>
       &amp;bl_mynn_edmf,                      &amp;<a name='2486'>
       &amp;bl_mynn_edmf_mom                  )<a name='2487'>
<a name='2488'>
<font color=#447700>!-------------------------------------------------------------------<a name='2489'></font>
    INTEGER, INTENT(in) :: kts,kte<a name='2490'>
    INTEGER, INTENT(in) :: grav_settling,levflag<a name='2491'>
    INTEGER, INTENT(in) :: bl_mynn_cloudmix,bl_mynn_mixqt,&amp;<a name='2492'>
                           bl_mynn_edmf,bl_mynn_edmf_mom<a name='2493'>
    LOGICAL, INTENT(IN) :: FLAG_QI,FLAG_QNI,FLAG_QC,FLAG_QNC<a name='2494'>
<a name='2495'>
<font color=#447700>!! grav_settling = 1 or 2 for gravitational settling of droplets<a name='2496'></font>
<font color=#447700>!! grav_settling = 0 otherwise<a name='2497'></font>
<font color=#447700>! thl - liquid water potential temperature<a name='2498'></font>
<font color=#447700>! qw - total water<a name='2499'></font>
<font color=#447700>! dfm,dfh,dfq - as above<a name='2500'></font>
<font color=#447700>! flt - surface flux of thl<a name='2501'></font>
<font color=#447700>! flq - surface flux of qw<a name='2502'></font>
<a name='2503'>
    REAL,DIMENSION(kts:kte+1), INTENT(in) :: s_aw,s_awthl,s_awqt,&amp;<a name='2504'>
                             s_awqv,s_awqc,s_awu,s_awv<a name='2505'>
    REAL, DIMENSION(kts:kte), INTENT(in) :: u,v,th,tk,qv,qc,qi,qni,qnc,&amp;<a name='2506'>
         &amp;p,exner,dfq,dz,tsq,qsq,cov,tcd,qcd,cldfra_bl1d<a name='2507'>
    REAL, DIMENSION(kts:kte), INTENT(inout) :: thl,sqw,sqv,sqc,sqi,&amp;<a name='2508'>
         &amp;dfm,dfh<a name='2509'>
    REAL, DIMENSION(kts:kte), INTENT(inout) :: du,dv,dth,dqv,dqc,dqi,&amp;<a name='2510'>
         &amp;dqni <font color=#447700>!,dqnc<a name='2511'></font>
    REAL, INTENT(IN) :: delt,ust,flt,flq,flqv,flqc,wspd,uoce,voce,qcg<a name='2512'>
<a name='2513'>
<font color=#447700>!    REAL, INTENT(IN) :: delt,ust,flt,flq,qcg,&amp;<a name='2514'></font>
<font color=#447700>!         &amp;gradu_top,gradv_top,gradth_top,gradqv_top<a name='2515'></font>
<a name='2516'>
<font color=#447700>!local vars<a name='2517'></font>
<a name='2518'>
    REAL, DIMENSION(kts:kte) :: dtz,vt,vq,dfhc,dfmc <font color=#447700>!Kh for clouds (Pr &lt; 2)<a name='2519'></font>
    REAL, DIMENSION(kts:kte) :: sqv2,sqc2,sqi2,sqw2,qni2 <font color=#447700>!,qnc2 !AFTER MIXING<a name='2520'></font>
<a name='2521'>
    REAL, DIMENSION(1:kte-kts+1) :: a,b,c,d<a name='2522'>
<a name='2523'>
    REAL :: rhs,gfluxm,gfluxp,dztop,maxdfh,mindfh<a name='2524'>
    REAL :: grav_settling2,vdfg1    <font color=#447700>!Katata-fogdes<a name='2525'></font>
    REAL :: t,esat,qsl,onoff<a name='2526'>
    INTEGER :: k,kk,nz<a name='2527'>
<a name='2528'>
    nz=kte-kts+1<a name='2529'>
<a name='2530'>
    dztop=.5*(dz(kte)+dz(kte-1))<a name='2531'>
<a name='2532'>
    <font color=#447700>! REGULATE THE MOMENTUM MIXING FROM THE MASS-FLUX SCHEME (on or off)<a name='2533'></font>
    IF (bl_mynn_edmf_mom == 0) THEN<a name='2534'>
       onoff=0.0<a name='2535'>
    ELSE<a name='2536'>
       onoff=1.0<a name='2537'>
    ENDIF<a name='2538'>
    <font color=#447700>! Note that s_awu and s_awv already come in as 0.0 if bl_mynn_edmf_mom == 0, so<a name='2539'></font>
    <font color=#447700>! we only need to zero-out the MF diffusivity term<a name='2540'></font>
    maxdfh=maxval(dfh(1:15))<a name='2541'>
    mindfh=maxdfh*0.01<a name='2542'>
    DO k=kts,kte<a name='2543'>
       dtz(k)=delt/dz(k)<a name='2544'>
       IF (dfm(k) &gt; dfh(k)) THEN <a name='2545'>
         <font color=#447700>!in stable regime only, limit Prandtl number to &lt; 2 within clouds<a name='2546'></font>
         IF (qc(k) &gt; 1.e-6 .OR. &amp;<a name='2547'>
             qi(k) &gt; 1.e-6 .OR. &amp;<a name='2548'>
             cldfra_bl1D(k) &gt; 0.05 ) THEN<a name='2549'>
             dfh(k)= MAX(dfh(k),dfm(k)*0.5)<a name='2550'>
         ENDIF<a name='2551'>
       ENDIF<a name='2552'>
       <font color=#447700>!add small minimum Km &amp; Kh in MF updrafts for edmf2<a name='2553'></font>
       IF(bl_mynn_edmf==2 .AND. k &gt; 1 .AND. s_aw(k)&gt;0.0) THEN<a name='2554'>
           dfh(k)=MAX(mindfh,dfh(k))<a name='2555'>
           dfm(k)=MAX(mindfh,dfm(k))<a name='2556'>
       ENDIF<a name='2557'>
    ENDDO<a name='2558'>
<a name='2559'>
<font color=#447700>!!============================================<a name='2560'></font>
<font color=#447700>!! u<a name='2561'></font>
<font color=#447700>!!============================================<a name='2562'></font>
<a name='2563'>
    k=kts<a name='2564'>
<a name='2565'>
    a(1)=0.<a name='2566'>
    b(1)=1. + dtz(k)*(dfm(k+1)+ust**2/wspd) - 0.5*dtz(k)*s_aw(k+1)*onoff<a name='2567'>
    c(1)=-dtz(k)*dfm(k+1) - 0.5*dtz(k)*s_aw(k+1)*onoff<a name='2568'>
    d(1)=u(k) + dtz(k)*uoce*ust**2/wspd - dtz(k)*s_awu(k+1)*onoff<a name='2569'>
<a name='2570'>
<font color=#447700>!!    a(1)=0.<a name='2571'></font>
<font color=#447700>!!    b(1)=1.+dtz(k)*dfm(k+1)<a name='2572'></font>
<font color=#447700>!!    c(1)=-dtz(k)*dfm(k+1)<a name='2573'></font>
<font color=#447700>!!    d(1)=u(k)*(1.-ust**2/wspd*dtz(k))<a name='2574'></font>
<a name='2575'>
    DO k=kts+1,kte-1<a name='2576'>
       kk=k-kts+1<a name='2577'>
       a(kk)=-dtz(k)*dfm(k) + 0.5*dtz(k)*s_aw(k)*onoff<a name='2578'>
       b(kk)=1. + dtz(k)*(dfm(k)+dfm(k+1)) + 0.5*dtz(k)*(s_aw(k)-s_aw(k+1))*onoff<a name='2579'>
       c(kk)=-dtz(k)*dfm(k+1) - 0.5*dtz(k)*s_aw(k+1)*onoff<a name='2580'>
       d(kk)=u(k) + dtz(k)*(s_awu(k)-s_awu(k+1))*onoff<a name='2581'>
    ENDDO<a name='2582'>
<a name='2583'>
<font color=#447700>!! no flux at the top<a name='2584'></font>
<font color=#447700>!    a(nz)=-1.<a name='2585'></font>
<font color=#447700>!    b(nz)=1.<a name='2586'></font>
<font color=#447700>!    c(nz)=0.<a name='2587'></font>
<font color=#447700>!    d(nz)=0.<a name='2588'></font>
<a name='2589'>
<font color=#447700>!! specified gradient at the top <a name='2590'></font>
<font color=#447700>!    a(nz)=-1.<a name='2591'></font>
<font color=#447700>!    b(nz)=1.<a name='2592'></font>
<font color=#447700>!    c(nz)=0.<a name='2593'></font>
<font color=#447700>!    d(nz)=gradu_top*dztop<a name='2594'></font>
<a name='2595'>
<font color=#447700>!! prescribed value<a name='2596'></font>
    a(nz)=0<a name='2597'>
    b(nz)=1.<a name='2598'>
    c(nz)=0.<a name='2599'>
    d(nz)=u(kte)<a name='2600'>
<a name='2601'>
    CALL <A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG'>tridiag</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_5">(nz,a,b,c,d)<a name='2602'>
<a name='2603'>
    DO k=kts,kte<a name='2604'>
       du(k)=(d(k-kts+1)-u(k))/delt<a name='2605'>
    ENDDO<a name='2606'>
<a name='2607'>
<font color=#447700>!!============================================<a name='2608'></font>
<font color=#447700>!! v<a name='2609'></font>
<font color=#447700>!!============================================<a name='2610'></font>
<a name='2611'>
    k=kts<a name='2612'>
<a name='2613'>
    a(1)=0.<a name='2614'>
    b(1)=1. + dtz(k)*(dfm(k+1)+ust**2/wspd) - 0.5*dtz(k)*s_aw(k+1)*onoff<a name='2615'>
    c(1)=-dtz(k)*dfm(k+1) - 0.5*dtz(k)*s_aw(k+1)*onoff<a name='2616'>
<font color=#447700>!    d(1)=v(k)<a name='2617'></font>
    d(1)=v(k) + dtz(k)*voce*ust**2/wspd - dtz(k)*s_awv(k+1)*onoff<a name='2618'>
<a name='2619'>
<font color=#447700>!!    a(1)=0.<a name='2620'></font>
<font color=#447700>!!    b(1)=1.+dtz(k)*dfm(k+1)<a name='2621'></font>
<font color=#447700>!!    c(1)=-dtz(k)*dfm(k+1)<a name='2622'></font>
<font color=#447700>!!    d(1)=v(k)*(1.-ust**2/wspd*dtz(k))<a name='2623'></font>
<a name='2624'>
    DO k=kts+1,kte-1<a name='2625'>
       kk=k-kts+1<a name='2626'>
       a(kk)=-dtz(k)*dfm(k) + 0.5*dtz(k)*s_aw(k)*onoff<a name='2627'>
       b(kk)=1. + dtz(k)*(dfm(k)+dfm(k+1)) + 0.5*dtz(k)*(s_aw(k)-s_aw(k+1))*onoff<a name='2628'>
       c(kk)=-dtz(k)*dfm(k+1) - 0.5*dtz(k)*s_aw(k+1)*onoff<a name='2629'>
       d(kk)=v(k) + dtz(k)*(s_awv(k)-s_awv(k+1))*onoff<a name='2630'>
    ENDDO<a name='2631'>
<a name='2632'>
<font color=#447700>!! no flux at the top<a name='2633'></font>
<font color=#447700>!    a(nz)=-1.<a name='2634'></font>
<font color=#447700>!    b(nz)=1.<a name='2635'></font>
<font color=#447700>!    c(nz)=0.<a name='2636'></font>
<font color=#447700>!    d(nz)=0.<a name='2637'></font>
<a name='2638'>
<font color=#447700>!! specified gradient at the top<a name='2639'></font>
<font color=#447700>!    a(nz)=-1.<a name='2640'></font>
<font color=#447700>!    b(nz)=1.<a name='2641'></font>
<font color=#447700>!    c(nz)=0.<a name='2642'></font>
<font color=#447700>!    d(nz)=gradv_top*dztop<a name='2643'></font>
<a name='2644'>
<font color=#447700>!! prescribed value<a name='2645'></font>
    a(nz)=0<a name='2646'>
    b(nz)=1.<a name='2647'>
    c(nz)=0.<a name='2648'>
    d(nz)=v(kte)<a name='2649'>
<a name='2650'>
    CALL <A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG'>tridiag</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_6">(nz,a,b,c,d)<a name='2651'>
<a name='2652'>
    DO k=kts,kte<a name='2653'>
       dv(k)=(d(k-kts+1)-v(k))/delt<a name='2654'>
    ENDDO<a name='2655'>
<a name='2656'>
<font color=#447700>!!============================================<a name='2657'></font>
<font color=#447700>!! thl <a name='2658'></font>
<font color=#447700>!! NOTE: currently, gravitational settling is removed<a name='2659'></font>
<font color=#447700>!!============================================<a name='2660'></font>
    k=kts<a name='2661'>
<a name='2662'>
    a(1)=0.<a name='2663'>
    b(1)=1.+dtz(k)*dfh(k+1) - 0.5*dtz(k)*s_aw(k+1)<a name='2664'>
    c(1)=-dtz(k)*(dfh(k+1) + 0.5*s_aw(k+1))<a name='2665'>
<a name='2666'>
    rhs= tcd(k)<a name='2667'>
<a name='2668'>
    d(1)=thl(k) + dtz(k)*flt + rhs*delt -dtz(1)*s_awthl(kts+1)<a name='2669'>
<a name='2670'>
    DO k=kts+1,kte-1<a name='2671'>
       kk=k-kts+1<a name='2672'>
       a(kk)=-dtz(k)*(dfh(k) - 0.5*s_aw(k))<a name='2673'>
       b(kk)=1.+dtz(k)*(dfh(k)+dfh(k+1) + 0.5*(s_aw(k)-s_aw(k+1)))<a name='2674'>
       c(kk)=-dtz(k)*(dfh(k+1) + 0.5*s_aw(k+1))<a name='2675'>
<a name='2676'>
       rhs= tcd(k)<a name='2677'>
<a name='2678'>
       d(kk)=thl(k) + rhs*delt + dtz(k)*(s_awthl(k)-s_awthl(k+1))<a name='2679'>
    ENDDO<a name='2680'>
<a name='2681'>
<font color=#447700>!! no flux at the top<a name='2682'></font>
<font color=#447700>!    a(nz)=-1.<a name='2683'></font>
<font color=#447700>!    b(nz)=1.<a name='2684'></font>
<font color=#447700>!    c(nz)=0.<a name='2685'></font>
<font color=#447700>!    d(nz)=0.<a name='2686'></font>
<a name='2687'>
<font color=#447700>!! specified gradient at the top<a name='2688'></font>
<font color=#447700>!assume gradthl_top=gradth_top<a name='2689'></font>
<font color=#447700>!    a(nz)=-1.<a name='2690'></font>
<font color=#447700>!    b(nz)=1.<a name='2691'></font>
<font color=#447700>!    c(nz)=0.<a name='2692'></font>
<font color=#447700>!    d(nz)=gradth_top*dztop<a name='2693'></font>
<a name='2694'>
<font color=#447700>!! prescribed value<a name='2695'></font>
    a(nz)=0.<a name='2696'>
    b(nz)=1.<a name='2697'>
    c(nz)=0.<a name='2698'>
    d(nz)=thl(kte)<a name='2699'>
<a name='2700'>
    CALL <A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG'>tridiag</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_7">(nz,a,b,c,d)<a name='2701'>
<a name='2702'>
    DO k=kts,kte<a name='2703'>
       thl(k)=<A href='../../html_code/share/dfi.F.html#D'>d</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_11">(k-kts+1)<a name='2704'>
    ENDDO<a name='2705'>
<a name='2706'>
IF (bl_mynn_mixqt &gt; 0) THEN<a name='2707'>
 <font color=#447700>!============================================<a name='2708'></font>
 <font color=#447700>! MIX total water (sqw = sqc + sqv + sqi)<a name='2709'></font>
 <font color=#447700>! NOTE: no total water tendency is output; instead, we must calculate<a name='2710'></font>
 <font color=#447700>!       the saturation specific humidity and then <a name='2711'></font>
 <font color=#447700>!       subtract out the moisture excess (sqc &amp; sqi)<a name='2712'></font>
 <font color=#447700>!============================================<a name='2713'></font>
<a name='2714'>
    k=kts<a name='2715'>
<a name='2716'>
    a(1)=0.<a name='2717'>
    b(1)=1.+dtz(k)*dfh(k+1)  - 0.5*dtz(k)*s_aw(k+1)<a name='2718'>
    c(1)=  -dtz(k)*(dfh(k+1) + 0.5*s_aw(k+1))<a name='2719'>
<a name='2720'>
    rhs= qcd(k) <font color=#447700>!+ (gfluxp - gfluxm)/dz(k)&amp; <a name='2721'></font>
<a name='2722'>
    d(1)=sqw(k) + dtz(k)*flq + rhs*delt - dtz(k)*s_awqt(k+1)<a name='2723'>
<a name='2724'>
    DO k=kts+1,kte-1<a name='2725'>
       kk=k-kts+1<a name='2726'>
       a(kk)=-dtz(k)*(dfh(k) - 0.5*s_aw(k))<a name='2727'>
       b(kk)=1.+dtz(k)*(dfh(k)+dfh(k+1) + 0.5*(s_aw(k)-s_aw(k+1)))<a name='2728'>
       c(kk)=-dtz(k)*(dfh(k+1) + 0.5*s_aw(k+1))<a name='2729'>
<a name='2730'>
       rhs= qcd(k)<a name='2731'>
<a name='2732'>
       d(kk)=sqw(k) + rhs*delt + dtz(k)*(s_awqt(k)-s_awqt(k+1))<a name='2733'>
    ENDDO<a name='2734'>
<a name='2735'>
<font color=#447700>!! no flux at the top<a name='2736'></font>
<font color=#447700>!    a(nz)=-1.<a name='2737'></font>
<font color=#447700>!    b(nz)=1.<a name='2738'></font>
<font color=#447700>!    c(nz)=0.<a name='2739'></font>
<font color=#447700>!    d(nz)=0.<a name='2740'></font>
<font color=#447700>!! specified gradient at the top<a name='2741'></font>
<font color=#447700>!assume gradqw_top=gradqv_top<a name='2742'></font>
<font color=#447700>!    a(nz)=-1.<a name='2743'></font>
<font color=#447700>!    b(nz)=1.<a name='2744'></font>
<font color=#447700>!    c(nz)=0.<a name='2745'></font>
<font color=#447700>!    d(nz)=gradqv_top*dztop<a name='2746'></font>
<font color=#447700>!! prescribed value<a name='2747'></font>
    a(nz)=0.<a name='2748'>
    b(nz)=1.<a name='2749'>
    c(nz)=0.<a name='2750'>
    d(nz)=sqw(kte)<a name='2751'>
<a name='2752'>
    CALL <A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG'>tridiag</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_8">(nz,a,b,c,d)<a name='2753'>
<a name='2754'>
    DO k=kts,kte<a name='2755'>
       sqw2(k)=<A href='../../html_code/share/dfi.F.html#D'>d</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_12">(k-kts+1)<a name='2756'>
    ENDDO<a name='2757'>
ELSE<a name='2758'>
    sqw2=sqw<a name='2759'>
ENDIF<a name='2760'>
<a name='2761'>
IF (bl_mynn_mixqt == 0) THEN<a name='2762'>
<font color=#447700>!============================================<a name='2763'></font>
<font color=#447700>! cloud water ( sqc ). If mixing total water (bl_mynn_mixqt &gt; 0),<a name='2764'></font>
<font color=#447700>! then sqc will be backed out of saturation check (below).<a name='2765'></font>
<font color=#447700>!============================================<a name='2766'></font>
  IF (bl_mynn_cloudmix &gt; 0 .AND. FLAG_QC) THEN<a name='2767'>
<a name='2768'>
    k=kts<a name='2769'>
<a name='2770'>
    a(1)=0.<a name='2771'>
    b(1)=1.+dtz(k)*dfh(k+1) - 0.5*dtz(k)*s_aw(k+1)<a name='2772'>
    c(1)=-dtz(k)*dfh(k+1)   - 0.5*dtz(k)*s_aw(k+1)<a name='2773'>
<a name='2774'>
    rhs   =  qcd(k)<a name='2775'>
    d(1)=sqc(k) + dtz(k)*flqc + rhs*delt -dtz(k)*s_awqc(k+1)<a name='2776'>
<a name='2777'>
    DO k=kts+1,kte-1<a name='2778'>
       kk=k-kts+1<a name='2779'>
       a(kk)=-dtz(k)*dfh(k) + 0.5*dtz(k)*s_aw(k)<a name='2780'>
       b(kk)=1.+dtz(k)*(dfh(k)+dfh(k+1)) + 0.5*dtz(k)*(s_aw(k)-s_aw(k+1))<a name='2781'>
       c(kk)=-dtz(k)*dfh(k+1) - 0.5*dtz(k)*s_aw(k+1)<a name='2782'>
<a name='2783'>
       rhs = qcd(k)<a name='2784'>
       d(kk)=sqc(k) + rhs*delt + dtz(k)*(s_awqc(k)-s_awqc(k+1))<a name='2785'>
    ENDDO<a name='2786'>
<a name='2787'>
<font color=#447700>! prescribed value<a name='2788'></font>
    a(nz)=0.<a name='2789'>
    b(nz)=1.<a name='2790'>
    c(nz)=0.<a name='2791'>
    d(nz)=sqc(kte)<a name='2792'>
<a name='2793'>
    CALL <A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG'>tridiag</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_9">(nz,a,b,c,d)<a name='2794'>
<a name='2795'>
    DO k=kts,kte<a name='2796'>
       sqc2(k)=<A href='../../html_code/share/dfi.F.html#D'>d</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_13">(k-kts+1)<a name='2797'>
    ENDDO<a name='2798'>
  ELSE<a name='2799'>
    <font color=#447700>!If not mixing clouds, set "updated" array equal to original array<a name='2800'></font>
    sqc2=sqc<a name='2801'>
  ENDIF<a name='2802'>
ENDIF<a name='2803'>
<a name='2804'>
IF (bl_mynn_mixqt == 0) THEN<a name='2805'>
  <font color=#447700>!============================================<a name='2806'></font>
  <font color=#447700>! MIX WATER VAPOR ONLY ( sqv ). If mixing total water (bl_mynn_mixqt &gt; 0),<a name='2807'></font>
  <font color=#447700>! then sqv will be backed out of saturation check (below).<a name='2808'></font>
  <font color=#447700>!============================================<a name='2809'></font>
<a name='2810'>
    k=kts<a name='2811'>
<a name='2812'>
    a(1)=0.<a name='2813'>
    b(1)=1.+dtz(k)*dfh(k+1) - 0.5*dtz(k)*s_aw(k+1)<a name='2814'>
    c(1)=-dtz(k)*dfh(k+1)   - 0.5*dtz(k)*s_aw(k+1)<a name='2815'>
    d(1)=sqv(k) + dtz(k)*flqv + qcd(k)*delt - dtz(k)*s_awqv(k+1)  <font color=#447700>!note: using qt, not qv...<a name='2816'></font>
<a name='2817'>
    DO k=kts+1,kte-1<a name='2818'>
       kk=k-kts+1<a name='2819'>
       a(kk)=-dtz(k)*dfh(k) + 0.5*dtz(k)*s_aw(k)<a name='2820'>
       b(kk)=1.+dtz(k)*(dfh(k)+dfh(k+1)) + 0.5*dtz(k)*(s_aw(k)-s_aw(k+1))<a name='2821'>
       c(kk)=-dtz(k)*dfh(k+1)  - 0.5*dtz(k)*s_aw(k+1)<a name='2822'>
       d(kk)=sqv(k) + qcd(k)*delt + dtz(k)*(s_awqv(k)-s_awqv(k+1))<a name='2823'>
    ENDDO<a name='2824'>
<a name='2825'>
<font color=#447700>! no flux at the top<a name='2826'></font>
<font color=#447700>!    a(nz)=-1.<a name='2827'></font>
<font color=#447700>!    b(nz)=1.<a name='2828'></font>
<font color=#447700>!    c(nz)=0.<a name='2829'></font>
<font color=#447700>!    d(nz)=0.<a name='2830'></font>
<a name='2831'>
<font color=#447700>! specified gradient at the top<a name='2832'></font>
<font color=#447700>! assume gradqw_top=gradqv_top<a name='2833'></font>
<font color=#447700>!    a(nz)=-1.<a name='2834'></font>
<font color=#447700>!    b(nz)=1.<a name='2835'></font>
<font color=#447700>!    c(nz)=0.<a name='2836'></font>
<font color=#447700>!    d(nz)=gradqv_top*dztop<a name='2837'></font>
<a name='2838'>
<font color=#447700>! prescribed value<a name='2839'></font>
    a(nz)=0.<a name='2840'>
    b(nz)=1.<a name='2841'>
    c(nz)=0.<a name='2842'>
    d(nz)=sqv(kte)<a name='2843'>
<a name='2844'>
    CALL <A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG'>tridiag</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_10">(nz,a,b,c,d)<a name='2845'>
<a name='2846'>
    DO k=kts,kte<a name='2847'>
       sqv2(k)=<A href='../../html_code/share/dfi.F.html#D'>d</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_14">(k-kts+1)<a name='2848'>
    ENDDO<a name='2849'>
ELSE<a name='2850'>
    sqv2=sqv<a name='2851'>
ENDIF<a name='2852'>
<a name='2853'>
<font color=#447700>!============================================<a name='2854'></font>
<font color=#447700>! MIX CLOUD ICE ( sqi )                      <a name='2855'></font>
<font color=#447700>!============================================<a name='2856'></font>
IF (bl_mynn_cloudmix &gt; 0 .AND. FLAG_QI) THEN<a name='2857'>
<a name='2858'>
    k=kts<a name='2859'>
<a name='2860'>
    a(1)=0.<a name='2861'>
    b(1)=1.+dtz(k)*dfh(k+1)<a name='2862'>
    c(1)=-dtz(k)*dfh(k+1)<a name='2863'>
    d(1)=sqi(k) <font color=#447700>!+ qcd(k)*delt !should we have qcd for ice???<a name='2864'></font>
<a name='2865'>
    DO k=kts+1,kte-1<a name='2866'>
       kk=k-kts+1<a name='2867'>
       a(kk)=-dtz(k)*dfh(k)<a name='2868'>
       b(kk)=1.+dtz(k)*(dfh(k)+dfh(k+1))<a name='2869'>
       c(kk)=-dtz(k)*dfh(k+1)<a name='2870'>
       d(kk)=sqi(k) <font color=#447700>!+ qcd(k)*delt<a name='2871'></font>
    ENDDO<a name='2872'>
<a name='2873'>
<font color=#447700>!! no flux at the top<a name='2874'></font>
<font color=#447700>!    a(nz)=-1.       <a name='2875'></font>
<font color=#447700>!    b(nz)=1.        <a name='2876'></font>
<font color=#447700>!    c(nz)=0.        <a name='2877'></font>
<font color=#447700>!    d(nz)=0.        <a name='2878'></font>
<a name='2879'>
<font color=#447700>!! specified gradient at the top<a name='2880'></font>
<font color=#447700>!assume gradqw_top=gradqv_top<a name='2881'></font>
<font color=#447700>!    a(nz)=-1.<a name='2882'></font>
<font color=#447700>!    b(nz)=1.<a name='2883'></font>
<font color=#447700>!    c(nz)=0.<a name='2884'></font>
<font color=#447700>!    d(nz)=gradqv_top*dztop<a name='2885'></font>
<a name='2886'>
<font color=#447700>!! prescribed value<a name='2887'></font>
    a(nz)=0.<a name='2888'>
    b(nz)=1.<a name='2889'>
    c(nz)=0.<a name='2890'>
    d(nz)=sqi(kte)<a name='2891'>
<a name='2892'>
    CALL <A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG'>tridiag</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_11">(nz,a,b,c,d)<a name='2893'>
<a name='2894'>
    DO k=kts,kte<a name='2895'>
       sqi2(k)=<A href='../../html_code/share/dfi.F.html#D'>d</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_15">(k-kts+1)<a name='2896'>
    ENDDO<a name='2897'>
ELSE<a name='2898'>
   sqi2=sqi<a name='2899'>
ENDIF<a name='2900'>
<a name='2901'>
<font color=#447700>!!============================================<a name='2902'></font>
<font color=#447700>!! cloud ice number concentration (qni)<a name='2903'></font>
<font color=#447700>!!============================================<a name='2904'></font>
<font color=#447700>! diasbled this since scalar_pblmix option can be invoked instead<a name='2905'></font>
<font color=#447700>!IF (bl_mynn_cloudmix &gt; 0 .AND. FLAG_QNI) THEN<a name='2906'></font>
<font color=#447700>!<a name='2907'></font>
<font color=#447700>!    k=kts<a name='2908'></font>
<font color=#447700>!<a name='2909'></font>
<font color=#447700>!    a(1)=0.<a name='2910'></font>
<font color=#447700>!    b(1)=1.+dtz(k)*dfh(k+1)<a name='2911'></font>
<font color=#447700>!    c(1)=-dtz(k)*dfh(k+1)<a name='2912'></font>
<font color=#447700>!<a name='2913'></font>
<font color=#447700>!    rhs = qcd(k)<a name='2914'></font>
<font color=#447700>!<a name='2915'></font>
<font color=#447700>!    d(1)=qni(k) !+ dtz(k)*flqc + rhs*delt<a name='2916'></font>
<font color=#447700>!<a name='2917'></font>
<font color=#447700>!    DO k=kts+1,kte-1<a name='2918'></font>
<font color=#447700>!       kk=k-kts+1<a name='2919'></font>
<font color=#447700>!       a(kk)=-dtz(k)*dfh(k)<a name='2920'></font>
<font color=#447700>!       b(kk)=1.+dtz(k)*(dfh(k)+dfh(k+1))<a name='2921'></font>
<font color=#447700>!       c(kk)=-dtz(k)*dfh(k+1)<a name='2922'></font>
<font color=#447700>!<a name='2923'></font>
<font color=#447700>!       rhs = qcd(k)<a name='2924'></font>
<font color=#447700>!       d(kk)=qni(k) !+ rhs*delt<a name='2925'></font>
<font color=#447700>!<a name='2926'></font>
<font color=#447700>!    ENDDO<a name='2927'></font>
<font color=#447700>!<a name='2928'></font>
<font color=#447700>!! prescribed value<a name='2929'></font>
<font color=#447700>!    a(nz)=0.<a name='2930'></font>
<font color=#447700>!    b(nz)=1.<a name='2931'></font>
<font color=#447700>!    c(nz)=0.<a name='2932'></font>
<font color=#447700>!    d(nz)=qni(kte)<a name='2933'></font>
<font color=#447700>!<a name='2934'></font>
<font color=#447700>!    CALL tridiag(nz,a,b,c,d)<a name='2935'></font>
<font color=#447700>!<a name='2936'></font>
<font color=#447700>!    DO k=kts,kte<a name='2937'></font>
<font color=#447700>!       qni2(k)=d(k-kts+1)<a name='2938'></font>
<font color=#447700>!    ENDDO<a name='2939'></font>
<font color=#447700>!ELSE<a name='2940'></font>
    qni2=qni<a name='2941'>
<font color=#447700>!ENDIF<a name='2942'></font>
<a name='2943'>
<font color=#447700>!!============================================<a name='2944'></font>
<font color=#447700>!! Compute tendencies and convert to mixing ratios for WRF.<a name='2945'></font>
<font color=#447700>!! Note that the momentum tendencies are calculated above.<a name='2946'></font>
<font color=#447700>!!============================================<a name='2947'></font>
<a name='2948'>
    DO k=kts,kte<a name='2949'>
<a name='2950'>
       IF (bl_mynn_mixqt &gt; 0) THEN<a name='2951'>
         t  = th(k)*exner(k)<a name='2952'>
         <font color=#447700>!SATURATED VAPOR PRESSURE<a name='2953'></font>
         esat=<A href='../../html_code/phys/module_bl_mynn.F.html#ESAT_BLEND'>esat_blend</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESAT_BLEND_2">(t)<a name='2954'>
         <font color=#447700>!SATURATED SPECIFIC HUMIDITY<a name='2955'></font>
         qsl=ep_2*esat/(p(k)-ep_3*esat)<a name='2956'>
<a name='2957'>
         <font color=#447700>!IF (qsl &gt;= sqw2(k)) THEN !unsaturated<a name='2958'></font>
         <font color=#447700>!   sqv2(k) = MAX(0.0,sqw2(k))<a name='2959'></font>
         <font color=#447700>!   sqi2(k) = MAX(0.0,sqi2(k))<a name='2960'></font>
         <font color=#447700>!   sqc2(k) = MAX(0.0,sqw2(k) - sqv2(k) - sqi2(k))<a name='2961'></font>
         <font color=#447700>!ELSE                     !saturated<a name='2962'></font>
            IF (FLAG_QI) THEN<a name='2963'>
              <font color=#447700>!sqv2(k) = qsl<a name='2964'></font>
              sqi2(k) = MAX(0., sqi2(k))<a name='2965'>
              sqc2(k) = MAX(0., sqw2(k) - sqi2(k) - qsl)      <font color=#447700>!updated cloud water<a name='2966'></font>
              sqv2(k) = MAX(0., sqw2(k) - sqc2(k) - sqi2(k))  <font color=#447700>!updated water vapor<a name='2967'></font>
            ELSE<a name='2968'>
              <font color=#447700>!sqv2(k) = qsl<a name='2969'></font>
              sqi2(k) = 0.0<a name='2970'>
              sqc2(k) = MAX(0., sqw2(k) - qsl)         <font color=#447700>!updated cloud water<a name='2971'></font>
              sqv2(k) = MAX(0., sqw2(k) - sqc2(k))     <font color=#447700>! updated water vapor<a name='2972'></font>
            ENDIF<a name='2973'>
         <font color=#447700>!ENDIF<a name='2974'></font>
       ENDIF<a name='2975'>
<a name='2976'>
       <font color=#447700>!=====================<a name='2977'></font>
       <font color=#447700>! WATER VAPOR TENDENCY<a name='2978'></font>
       <font color=#447700>!=====================<a name='2979'></font>
       Dqv(k)=(sqv2(k)/(1.-sqv2(k)) - qv(k))/delt<a name='2980'>
       <font color=#447700>!IF(-Dqv(k) &gt; qv(k)) Dqv(k)=-qv(k)<a name='2981'></font>
<a name='2982'>
       <font color=#447700>!=====================<a name='2983'></font>
       <font color=#447700>! CLOUD WATER TENDENCY<a name='2984'></font>
       <font color=#447700>!=====================<a name='2985'></font>
       <font color=#447700>!qc fog settling tendency is now computed in module_bl_fogdes.F, so<a name='2986'></font>
       <font color=#447700>!sqc should only be changed by eddy diffusion or mass-flux.<a name='2987'></font>
       <font color=#447700>!print*,"FLAG_QC:",FLAG_QC<a name='2988'></font>
       IF (bl_mynn_cloudmix &gt; 0 .AND. FLAG_QC) THEN<a name='2989'>
         Dqc(k)=(sqc2(k)/(1.-sqc2(k)) - qc(k))/delt<a name='2990'>
         IF(Dqc(k)*delt + qc(k) &lt; 0.) THEN<a name='2991'>
           <font color=#447700>!WRITE ( mynn_message , FMT='(A,5(F8.6,A1),F6.1)' ) &amp;<a name='2992'></font>
           <font color=#447700>!' MYNN; neg qc: ',qsl,' ',sqw2(k),' ',sqi2(k),' ',sqc2(k),' ',qc(k),' ',tk(k)<a name='2993'></font>
           <font color=#447700>!CALL wrf_debug ( 0 , mynn_message )<a name='2994'></font>
           Dqc(k)=-qc(k)/delt <a name='2995'>
         ENDIF<a name='2996'>
<a name='2997'>
         <font color=#447700>!REMOVED MIXING OF QNC - PERFORMED IN THE SCALAR_PBLMIX OPTION<a name='2998'></font>
         <font color=#447700>!IF (FLAG_QNC) THEN<a name='2999'></font>
         <font color=#447700>!  IF(sqc2(k)&gt;1.e-9)qnc2(k)=MAX(qnc2(k),1.e6)<a name='3000'></font>
         <font color=#447700>!  Dqnc(k) = (qnc2(k)-qnc(k))/delt<a name='3001'></font>
         <font color=#447700>!  IF(Dqnc(k)*delt + qnc(k) &lt; 0.)Dqnc(k)=-qnc(k)/delt <a name='3002'></font>
         <font color=#447700>!ELSE<a name='3003'></font>
         <font color=#447700>!  Dqnc(k) = 0.<a name='3004'></font>
         <font color=#447700>!ENDIF<a name='3005'></font>
       ELSE<a name='3006'>
         Dqc(k)=0.<a name='3007'>
         <font color=#447700>!Dqnc(k)=0.<a name='3008'></font>
       ENDIF<a name='3009'>
<a name='3010'>
       <font color=#447700>!===================<a name='3011'></font>
       <font color=#447700>! CLOUD ICE TENDENCY<a name='3012'></font>
       <font color=#447700>!===================<a name='3013'></font>
       IF (bl_mynn_cloudmix &gt; 0 .AND. FLAG_QI) THEN<a name='3014'>
         Dqi(k)=(sqi2(k)/(1.-sqi2(k)) - qi(k))/delt<a name='3015'>
         IF(Dqi(k)*delt + qi(k) &lt; 0.) THEN<a name='3016'>
           <font color=#447700>!WRITE ( mynn_message , FMT='(A,5(F8.6,A1),F6.1)' ) &amp;<a name='3017'></font>
           <font color=#447700>!' MYNN; neg qi; ',qsl,' ',sqw2(k),' ',sqi2(k),' ',sqc2(k),' ',qi(k),' ',tk(k)<a name='3018'></font>
           <font color=#447700>!CALL wrf_debug ( 0 , mynn_message )<a name='3019'></font>
           Dqi(k)=-qi(k)/delt<a name='3020'>
         ENDIF<a name='3021'>
<a name='3022'>
         <font color=#447700>!REMOVED MIXING OF QNI - PERFORMED IN THE SCALAR_PBLMIX OPTION<a name='3023'></font>
         <font color=#447700>!SET qni2 = qni above, so all tendencies are zero<a name='3024'></font>
         IF (FLAG_QNI) THEN<a name='3025'>
           Dqni(k)=(qni2(k)-qni(k))/delt<a name='3026'>
           IF(Dqni(k)*delt + qni(k) &lt; 0.)Dqni(k)=-qni(k)/delt<a name='3027'>
         ELSE<a name='3028'>
           Dqni(k)=0.<a name='3029'>
         ENDIF<a name='3030'>
       ELSE<a name='3031'>
         Dqi(k)=0.<a name='3032'>
         Dqni(k)=0.<a name='3033'>
       ENDIF<a name='3034'>
<a name='3035'>
       <font color=#447700>!===================<a name='3036'></font>
       <font color=#447700>! THETA TENDENCY<a name='3037'></font>
       <font color=#447700>!===================<a name='3038'></font>
       IF (FLAG_QI) THEN<a name='3039'>
         Dth(k)=(thl(k) + xlvcp/exner(k)*sqc(k) &amp;<a name='3040'>
           &amp;            + xlscp/exner(k)*sqi(k) &amp;<a name='3041'>
           &amp;            - th(k))/delt<a name='3042'>
         <font color=#447700>!Use form from Tripoli and Cotton (1981) with their<a name='3043'></font>
         <font color=#447700>!suggested min temperature to improve accuracy:<a name='3044'></font>
         <font color=#447700>!Dth(k)=(thl(k)*(1.+ xlvcp/MAX(tk(k),TKmin)*sqc2(k)  &amp;<a name='3045'></font>
         <font color=#447700>!  &amp;               + xlscp/MAX(tk(k),TKmin)*sqi2(k)) &amp;<a name='3046'></font>
         <font color=#447700>!  &amp;               - th(k))/delt<a name='3047'></font>
       ELSE<a name='3048'>
         Dth(k)=(thl(k)+xlvcp/exner(k)*sqc2(k) - th(k))/delt<a name='3049'>
         <font color=#447700>!Use form from Tripoli and Cotton (1981) with their<a name='3050'></font>
         <font color=#447700>!suggested min temperature to improve accuracy.<a name='3051'></font>
         <font color=#447700>!Dth(k)=(thl(k)*(1.+ xlvcp/MAX(tk(k),TKmin)*sqc2(k))  &amp;<a name='3052'></font>
         <font color=#447700>!&amp;               - th(k))/delt<a name='3053'></font>
       ENDIF<a name='3054'>
<a name='3055'>
    ENDDO<a name='3056'>
<a name='3057'>
  END SUBROUTINE mynn_tendencies<a name='3058'>
<a name='3059'>
<font color=#447700>! ==================================================================<a name='3060'></font>
#if (WRF_CHEM == 1)<a name='3061'>
<A NAME='MYNN_MIX_CHEM'><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_MIX_CHEM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3062'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>mynn_mix_chem</font>(kts,kte,      &amp; <A href='../../call_to/MYNN_MIX_CHEM.html' TARGET='index'>1</A>,<A href='../../call_from/MYNN_MIX_CHEM.html' TARGET='index'>2</A><a name='3063'>
       levflag,grav_settling,             &amp;<a name='3064'>
       delt,dz,                           &amp;<a name='3065'>
       nchem, kdvel, ndvel, num_vert_mix, &amp;<a name='3066'>
       chem1, vd1,                        &amp;<a name='3067'>
       qni,qnc,        &amp;<a name='3068'>
       p,exner,                           &amp;<a name='3069'>
       thl,sqv,sqc,sqi,sqw,               &amp;<a name='3070'>
       ust,flt,flq,flqv,flqc,wspd,qcg,    &amp;<a name='3071'>
       uoce,voce,                         &amp;<a name='3072'>
       tsq,qsq,cov,                       &amp;<a name='3073'>
       tcd,qcd,                           &amp;<a name='3074'>
       dfm,dfh,dfq,                       &amp;<a name='3075'>
       s_awchem,                          &amp;<a name='3076'>
       bl_mynn_cloudmix)<a name='3077'>
<a name='3078'>
<font color=#447700>!-------------------------------------------------------------------<a name='3079'></font>
    INTEGER, INTENT(in) :: kts,kte<a name='3080'>
    INTEGER, INTENT(in) :: grav_settling,levflag<a name='3081'>
    INTEGER, INTENT(in) :: bl_mynn_cloudmix<a name='3082'>
<a name='3083'>
    REAL, DIMENSION(kts:kte), INTENT(IN) :: qni,qnc,&amp;<a name='3084'>
         &amp;p,exner,dfm,dfh,dfq,dz,tsq,qsq,cov,tcd,qcd<a name='3085'>
    REAL, DIMENSION(kts:kte), INTENT(INOUT) :: thl,sqw,sqv,sqc,sqi<a name='3086'>
    REAL, INTENT(IN) :: delt,ust,flt,flq,flqv,flqc,wspd,uoce,voce,qcg<a name='3087'>
    INTEGER, INTENT(IN   )   ::   nchem, kdvel, ndvel, num_vert_mix<a name='3088'>
    REAL, DIMENSION( kts:kte, nchem ), INTENT(INOUT) :: chem1<a name='3089'>
    REAL, DIMENSION( kts:kte+1,nchem), INTENT(IN) :: s_awchem<a name='3090'>
    REAL, DIMENSION( ndvel ), INTENT(INOUT) :: vd1<a name='3091'>
<a name='3092'>
<font color=#447700>!local vars<a name='3093'></font>
<a name='3094'>
    REAL, DIMENSION(kts:kte) :: dtz,vt,vq<a name='3095'>
    REAL, DIMENSION(1:kte-kts+1) :: a,b,c,d<a name='3096'>
    REAL :: rhs,gfluxm,gfluxp,dztop<a name='3097'>
    REAL :: t,esl,qsl<a name='3098'>
    INTEGER :: k,kk,nz<a name='3099'>
    INTEGER :: ic  <font color=#447700>! Chemical array loop index<a name='3100'></font>
    REAL, DIMENSION( kts:kte, nchem ) :: chem_new<a name='3101'>
<a name='3102'>
    nz=kte-kts+1<a name='3103'>
<a name='3104'>
    dztop=.5*(dz(kte)+dz(kte-1))<a name='3105'>
<a name='3106'>
    DO k=kts,kte<a name='3107'>
       dtz(k)=delt/dz(k)<a name='3108'>
    ENDDO<a name='3109'>
<a name='3110'>
  <font color=#447700>!============================================<a name='3111'></font>
  <font color=#447700>! Patterned after mixing of water vapor in mynn_tendencies.<a name='3112'></font>
  <font color=#447700>!============================================<a name='3113'></font>
<a name='3114'>
    DO ic = 1,nchem<a name='3115'>
       k=kts<a name='3116'>
<a name='3117'>
       a(1)=0.<a name='3118'>
       b(1)=1.+dtz(k)*dfh(k+1)<a name='3119'>
       c(1)=-dtz(k)*dfh(k+1)<a name='3120'>
       <font color=#447700>! d(1)=sqv(k) + dtz(k)*flqv + qcd(k)*delt<a name='3121'></font>
       d(1)=chem1(k,ic) + dtz(k) * (-1.0) * vd1(ic) * chem1(1,ic)<a name='3122'>
<a name='3123'>
       DO k=kts+1,kte-1<a name='3124'>
          kk=k-kts+1<a name='3125'>
          a(kk)=-dtz(k)*dfh(k)<a name='3126'>
          b(kk)=1.+dtz(k)*(dfh(k)+dfh(k+1))<a name='3127'>
          c(kk)=-dtz(k)*dfh(k+1)<a name='3128'>
          <font color=#447700>! d(kk)=chem1(k,ic) + qcd(k)*delt<a name='3129'></font>
          d(kk)=chem1(k,ic) + rhs*delt + dtz(k)*(s_awchem(k,ic)-s_awchem(k+1,ic))<a name='3130'>
       ENDDO<a name='3131'>
<a name='3132'>
      <font color=#447700>! prescribed value at top<a name='3133'></font>
       a(nz)=0.<a name='3134'>
       b(nz)=1.<a name='3135'>
       c(nz)=0.<a name='3136'>
       d(nz)=chem1(kte,ic)<a name='3137'>
<a name='3138'>
       CALL <A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG'>tridiag</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_MIX_CHEM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIAG_12">(nz,a,b,c,d)<a name='3139'>
<a name='3140'>
       DO k=kts,kte<a name='3141'>
          chem_new(k,ic)=<A href='../../html_code/share/dfi.F.html#D'>d</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_MIX_CHEM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_16">(k-kts+1)<a name='3142'>
       ENDDO<a name='3143'>
    ENDDO<a name='3144'>
<a name='3145'>
  END SUBROUTINE mynn_mix_chem<a name='3146'>
#endif<a name='3147'>
<a name='3148'>
<font color=#447700>! ==================================================================<a name='3149'></font>
<A NAME='RETRIEVE_EXCHANGE_COEFFS'><A href='../../html_code/phys/module_bl_mynn.F.html#RETRIEVE_EXCHANGE_COEFFS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3150'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>retrieve_exchange_coeffs</font>(kts,kte,&amp; <A href='../../call_to/RETRIEVE_EXCHANGE_COEFFS.html' TARGET='index'>1</A><a name='3151'>
       &amp;dfm,dfh,dfq,dz,&amp;<a name='3152'>
       &amp;K_m,K_h,K_q)<a name='3153'>
<a name='3154'>
<font color=#447700>!-------------------------------------------------------------------<a name='3155'></font>
<a name='3156'>
    INTEGER , INTENT(in) :: kts,kte<a name='3157'>
<a name='3158'>
    REAL, DIMENSION(KtS:KtE), INTENT(in) :: dz,dfm,dfh,dfq<a name='3159'>
<a name='3160'>
    REAL, DIMENSION(KtS:KtE), INTENT(out) :: &amp;<a name='3161'>
         &amp;K_m, K_h, K_q<a name='3162'>
<a name='3163'>
<a name='3164'>
    INTEGER :: k<a name='3165'>
    REAL :: dzk<a name='3166'>
<a name='3167'>
    K_m(kts)=0.<a name='3168'>
    K_h(kts)=0.<a name='3169'>
    K_q(kts)=0.<a name='3170'>
<a name='3171'>
    DO k=kts+1,kte<a name='3172'>
       dzk = 0.5  *( dz(k)+dz(k-1) )<a name='3173'>
       K_m(k)=dfm(k)*dzk<a name='3174'>
       K_h(k)=dfh(k)*dzk<a name='3175'>
       K_q(k)=Sqfac*dfq(k)*dzk<a name='3176'>
    ENDDO<a name='3177'>
<a name='3178'>
  END SUBROUTINE retrieve_exchange_coeffs<a name='3179'>
<a name='3180'>
<font color=#447700>! ==================================================================<a name='3181'></font>
<A NAME='TRIDIAG'><A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3182'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>tridiag</font>(n,a,b,c,d) <A href='../../call_to/TRIDIAG.html' TARGET='index'>12</A>,<A href='../../call_from/TRIDIAG.html' TARGET='index'>2</A><a name='3183'>
<a name='3184'>
<font color=#447700>!! to solve system of linear eqs on tridiagonal matrix n times n<a name='3185'></font>
<font color=#447700>!! after Peaceman and Rachford, 1955<a name='3186'></font>
<font color=#447700>!! a,b,c,d - are vectors of order n <a name='3187'></font>
<font color=#447700>!! a,b,c - are coefficients on the LHS<a name='3188'></font>
<font color=#447700>!! d - is initially RHS on the output becomes a solution vector<a name='3189'></font>
    <a name='3190'>
<font color=#447700>!-------------------------------------------------------------------<a name='3191'></font>
<a name='3192'>
    INTEGER, INTENT(in):: n<a name='3193'>
    REAL, DIMENSION(n), INTENT(in) :: a,b<a name='3194'>
    REAL, DIMENSION(n), INTENT(inout) :: c,d<a name='3195'>
    <a name='3196'>
    INTEGER :: i<a name='3197'>
    REAL :: p<a name='3198'>
    REAL, DIMENSION(n) :: q<a name='3199'>
    <a name='3200'>
    c(n)=0.<a name='3201'>
    q(1)=-c(1)/b(1)<a name='3202'>
    d(1)=<A href='../../html_code/share/dfi.F.html#D'>d</A><A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_17">(1)/b(1)<a name='3203'>
    <a name='3204'>
    DO i=2,n<a name='3205'>
       p=1./(b(i)+a(i)*q(i-1))<a name='3206'>
       q(i)=-c(i)*p<a name='3207'>
       d(i)=(d(i)-a(i)*d(i-1))*p<a name='3208'>
    ENDDO<a name='3209'>
    <a name='3210'>
    DO i=n-1,1,-1<a name='3211'>
       d(i)=<A href='../../html_code/share/dfi.F.html#D'>d</A><A href='../../html_code/phys/module_bl_mynn.F.html#TRIDIAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_18">(i)+q(i)*d(i+1)<a name='3212'>
    ENDDO<a name='3213'>
<a name='3214'>
  END SUBROUTINE tridiag<a name='3215'>
<a name='3216'>
<font color=#447700>! ==================================================================<a name='3217'></font>
<A NAME='MYNN_BL_DRIVER'><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3218'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>mynn_bl_driver</font>(            &amp; <A href='../../call_to/MYNN_BL_DRIVER.html' TARGET='index'>1</A>,<A href='../../call_from/MYNN_BL_DRIVER.html' TARGET='index'>14</A><a name='3219'>
       &amp;initflag,grav_settling,         &amp;<a name='3220'>
       &amp;delt,dz,dx,znt,                 &amp;<a name='3221'>
       &amp;u,v,w,th,qv,qc,qi,qni,qnc,      &amp;<a name='3222'>
       &amp;p,exner,rho,T3D,                &amp;<a name='3223'>
       &amp;xland,ts,qsfc,qcg,ps,           &amp;<a name='3224'>
       &amp;ust,ch,hfx,qfx,rmol,wspd,       &amp;<a name='3225'>
       &amp;uoce,voce,                      &amp; <font color=#447700>!ocean current<a name='3226'></font>
       &amp;vdfg,                           &amp; <font color=#447700>!Katata-added for fog dep<a name='3227'></font>
       &amp;Qke,tke_pbl,                    &amp;<a name='3228'>
       &amp;qke_adv,bl_mynn_tkeadvect,      &amp; <font color=#447700>!ACF for QKE advection<a name='3229'></font>
#if (WRF_CHEM == 1)<a name='3230'>
       chem3d, vd3d, nchem,             &amp; <font color=#447700>! WA 7/29/15 For WRF-Chem<a name='3231'></font>
       kdvel, ndvel, num_vert_mix,      &amp;<a name='3232'>
#endif<a name='3233'>
       &amp;Tsq,Qsq,Cov,                    &amp;<a name='3234'>
       &amp;RUBLTEN,RVBLTEN,RTHBLTEN,       &amp;<a name='3235'>
       &amp;RQVBLTEN,RQCBLTEN,RQIBLTEN,     &amp;<a name='3236'>
       &amp;RQNIBLTEN,                      &amp;<a name='3237'>
       &amp;exch_h,exch_m,                  &amp;<a name='3238'>
       &amp;Pblh,kpbl,                      &amp; <a name='3239'>
       &amp;el_pbl,                         &amp;<a name='3240'>
       &amp;dqke,qWT,qSHEAR,qBUOY,qDISS,    &amp; <font color=#447700>!JOE-TKE BUDGET<a name='3241'></font>
       &amp;wstar,delta,                    &amp; <font color=#447700>!JOE-added for grims<a name='3242'></font>
       &amp;bl_mynn_tkebudget,              &amp;<a name='3243'>
       &amp;bl_mynn_cloudpdf,Sh3D,          &amp;<a name='3244'>
       &amp;bl_mynn_mixlength,              &amp;<a name='3245'>
       &amp;icloud_bl,qc_bl,cldfra_bl,      &amp;<a name='3246'>
       &amp;bl_mynn_edmf,                   &amp;<a name='3247'>
       &amp;bl_mynn_edmf_mom,bl_mynn_edmf_tke, &amp;<a name='3248'>
       &amp;bl_mynn_edmf_part,              &amp;<a name='3249'>
       &amp;bl_mynn_cloudmix,bl_mynn_mixqt, &amp;<a name='3250'>
       &amp;edmf_a,edmf_w,edmf_qt,          &amp;<a name='3251'>
       &amp;edmf_thl,edmf_ent,edmf_qc,      &amp;<a name='3252'>
       &amp;spp_pbl,pattern_spp_pbl,        &amp;<a name='3253'>
       &amp;FLAG_QI,FLAG_QNI,FLAG_QC,FLAG_QNC &amp;<a name='3254'>
       &amp;,IDS,IDE,JDS,JDE,KDS,KDE        &amp;<a name='3255'>
       &amp;,IMS,IME,JMS,JME,KMS,KME        &amp;<a name='3256'>
       &amp;,ITS,ITE,JTS,JTE,KTS,KTE)<a name='3257'>
    <a name='3258'>
<font color=#447700>!-------------------------------------------------------------------<a name='3259'></font>
<a name='3260'>
    INTEGER, INTENT(in) :: initflag<a name='3261'>
    <font color=#447700>!INPUT NAMELIST OPTIONS:<a name='3262'></font>
    INTEGER, INTENT(in) :: grav_settling<a name='3263'>
    INTEGER, INTENT(in) :: bl_mynn_tkebudget<a name='3264'>
    INTEGER, INTENT(in) :: bl_mynn_cloudpdf<a name='3265'>
    INTEGER, INTENT(in) :: bl_mynn_mixlength<a name='3266'>
    INTEGER, INTENT(in) :: bl_mynn_edmf<a name='3267'>
    LOGICAL, INTENT(IN) :: bl_mynn_tkeadvect<a name='3268'>
    INTEGER, INTENT(in) :: bl_mynn_edmf_mom<a name='3269'>
    INTEGER, INTENT(in) :: bl_mynn_edmf_tke<a name='3270'>
    INTEGER, INTENT(in) :: bl_mynn_edmf_part<a name='3271'>
    INTEGER, INTENT(in) :: bl_mynn_cloudmix<a name='3272'>
    INTEGER, INTENT(in) :: bl_mynn_mixqt<a name='3273'>
    INTEGER, INTENT(in) :: icloud_bl<a name='3274'>
<a name='3275'>
    LOGICAL, INTENT(IN) :: FLAG_QI,FLAG_QNI,FLAG_QC,FLAG_QNC<a name='3276'>
    <a name='3277'>
    INTEGER,INTENT(IN) :: &amp;<a name='3278'>
         &amp; IDS,IDE,JDS,JDE,KDS,KDE &amp;<a name='3279'>
         &amp;,IMS,IME,JMS,JME,KMS,KME &amp;<a name='3280'>
         &amp;,ITS,ITE,JTS,JTE,KTS,KTE<a name='3281'>
    <a name='3282'>
<a name='3283'>
<font color=#447700>! initflag &gt; 0  for TRUE<a name='3284'></font>
<font color=#447700>! else        for FALSE<a name='3285'></font>
<font color=#447700>!       levflag         : &lt;&gt;3;  Level 2.5<a name='3286'></font>
<font color=#447700>!                         = 3;  Level 3<a name='3287'></font>
<font color=#447700>! grav_settling = 1 when gravitational settling accounted for<a name='3288'></font>
<font color=#447700>! grav_settling = 0 when gravitational settling NOT accounted for<a name='3289'></font>
    <a name='3290'>
    REAL, INTENT(in) :: delt,dx<a name='3291'>
    REAL, DIMENSION(IMS:IME,KMS:KME,JMS:JME), INTENT(in) :: dz,&amp;<a name='3292'>
         &amp;u,v,w,th,qv,p,exner,rho,T3D<a name='3293'>
    REAL, DIMENSION(IMS:IME,KMS:KME,JMS:JME), OPTIONAL, INTENT(in)::&amp;<a name='3294'>
         &amp;qc,qi,qni,qnc<a name='3295'>
    REAL, DIMENSION(IMS:IME,JMS:JME), INTENT(in) :: xland,ust,&amp;<a name='3296'>
         &amp;ch,rmol,ts,qsfc,qcg,ps,hfx,qfx, wspd,uoce,voce, vdfg,znt<a name='3297'>
<a name='3298'>
    REAL, DIMENSION(IMS:IME,KMS:KME,JMS:JME), INTENT(inout) :: &amp;<a name='3299'>
         &amp;Qke,Tsq,Qsq,Cov, &amp;<a name='3300'>
         &amp;tke_pbl, &amp; <font color=#447700>!JOE-added for coupling (TKE_PBL = QKE/2)<a name='3301'></font>
         &amp;qke_adv    <font color=#447700>!ACF for QKE advection<a name='3302'></font>
<a name='3303'>
    REAL, DIMENSION(IMS:IME,KMS:KME,JMS:JME), INTENT(inout) :: &amp;<a name='3304'>
         &amp;RUBLTEN,RVBLTEN,RTHBLTEN,RQVBLTEN,RQCBLTEN,&amp;<a name='3305'>
         &amp;RQIBLTEN,RQNIBLTEN <font color=#447700>!,RQNCBLTEN<a name='3306'></font>
<a name='3307'>
    REAL, DIMENSION(IMS:IME,KMS:KME,JMS:JME), INTENT(out) :: &amp;<a name='3308'>
         &amp;exch_h,exch_m<a name='3309'>
<a name='3310'>
   REAL, DIMENSION(IMS:IME,KMS:KME,JMS:JME), OPTIONAL, INTENT(inout) :: &amp;<a name='3311'>
         &amp; edmf_a,edmf_w,edmf_qt,edmf_thl,edmf_ent,edmf_qc<a name='3312'>
<a name='3313'>
    REAL, DIMENSION(IMS:IME,JMS:JME), INTENT(inout) :: &amp;<a name='3314'>
         &amp;Pblh,wstar,delta  <font color=#447700>!JOE-added for GRIMS<a name='3315'></font>
<a name='3316'>
    REAL, DIMENSION(IMS:IME,JMS:JME) :: &amp;<a name='3317'>
         &amp;Psig_bl,Psig_shcu<a name='3318'>
<a name='3319'>
    INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: &amp; <a name='3320'>
         &amp;KPBL<a name='3321'>
<a name='3322'>
    REAL, DIMENSION(IMS:IME,KMS:KME,JMS:JME), INTENT(inout) :: &amp;<a name='3323'>
         &amp;el_pbl<a name='3324'>
<a name='3325'>
    REAL, DIMENSION(IMS:IME,KMS:KME,JMS:JME), INTENT(out) :: &amp;<a name='3326'>
         &amp;qWT,qSHEAR,qBUOY,qDISS,dqke<a name='3327'>
    <font color=#447700>! 3D budget arrays are not allocated when bl_mynn_tkebudget == 0.<a name='3328'></font>
    <font color=#447700>! 1D (local) budget arrays are used for passing between subroutines.<a name='3329'></font>
    REAL, DIMENSION(KTS:KTE) :: qWT1,qSHEAR1,qBUOY1,qDISS1,dqke1<a name='3330'>
<a name='3331'>
    REAL, DIMENSION(IMS:IME,KMS:KME,JMS:JME) :: K_q,Sh3D<a name='3332'>
<a name='3333'>
    REAL, DIMENSION(IMS:IME,KMS:KME,JMS:JME), INTENT(inout) :: &amp;<a name='3334'>
         &amp;qc_bl,cldfra_bl<a name='3335'>
    REAL, DIMENSION(KTS:KTE) :: qc_bl1D,cldfra_bl1D,&amp;<a name='3336'>
                            qc_bl1D_old,cldfra_bl1D_old<a name='3337'>
<a name='3338'>
<font color=#447700>! WA 7/29/15 Mix chemical arrays<a name='3339'></font>
#if (WRF_CHEM == 1)<a name='3340'>
    INTEGER, INTENT(IN   )   ::   nchem, kdvel, ndvel, num_vert_mix<a name='3341'>
    REAL,    DIMENSION( ims:ime, kms:kme, jms:jme, nchem ), INTENT(INOUT) :: chem3d<a name='3342'>
    REAL,    DIMENSION( ims:ime, kdvel, jms:jme, ndvel ), INTENT(IN) :: vd3d<a name='3343'>
    REAL,    DIMENSION( kts:kte, nchem ) :: chem1<a name='3344'>
    REAL,    DIMENSION( kts:kte+1, nchem ) :: s_awchem1<a name='3345'>
    REAL,    DIMENSION( ndvel ) :: vd1<a name='3346'>
    INTEGER ic<a name='3347'>
#endif<a name='3348'>
<a name='3349'>
<font color=#447700>!local vars<a name='3350'></font>
    INTEGER :: ITF,JTF,KTF, IMD,JMD<a name='3351'>
    INTEGER :: i,j,k<a name='3352'>
    REAL, DIMENSION(KTS:KTE) :: thl,tl,sqv,sqc,sqi,sqw,&amp;<a name='3353'>
         &amp;El, Dfm, Dfh, Dfq, Tcd, Qcd, Pdk, Pdt, Pdq, Pdc, &amp;<a name='3354'>
         &amp;Vt, Vq, sgm<a name='3355'>
<a name='3356'>
    REAL, DIMENSION(KTS:KTE) :: thetav,sh,u1,v1,w1,p1,ex1,dz1,th1,tk1,rho1,&amp;<a name='3357'>
           &amp; qke1,tsq1,qsq1,cov1,qv1,qi1,qc1,du1,dv1,dth1,dqv1,dqc1,dqi1, &amp;<a name='3358'>
           &amp; k_m1,k_h1,k_q1,qni1,dqni1,qnc1 <font color=#447700>!,dqnc1<a name='3359'></font>
<a name='3360'>
<font color=#447700>!JOE: mass-flux variables<a name='3361'></font>
    REAL, DIMENSION(KTS:KTE) :: dth1mf,dqv1mf,dqc1mf,du1mf,dv1mf<a name='3362'>
    REAL, DIMENSION(KTS:KTE) :: edmf_a1,edmf_w1,edmf_qt1,edmf_thl1,&amp;<a name='3363'>
                                edmf_ent1,edmf_qc1<a name='3364'>
    REAL,DIMENSION(KTS:KTE+1) :: s_aw1,s_awthl1,s_awqt1,&amp;<a name='3365'>
                  s_awqv1,s_awqc1,s_awu1,s_awv1,s_awqke1<a name='3366'>
<a name='3367'>
    REAL, DIMENSION(KTS:KTE+1) :: zw<a name='3368'>
    REAL :: cpm,sqcg,flt,flq,flqv,flqc,pmz,phh,exnerg,zet,&amp; <a name='3369'>
              &amp;afk,abk,ts_decay,th_sfc<a name='3370'>
<a name='3371'>
<font color=#447700>!JOE-add GRIMS parameters &amp; variables<a name='3372'></font>
   real,parameter    ::  d1 = 0.02, d2 = 0.05, d3 = 0.001<a name='3373'>
   real,parameter    ::  h1 = 0.33333335, h2 = 0.6666667<a name='3374'>
   REAL :: govrth, sflux, bfx0, wstar3, wm2, wm3, delb<a name='3375'>
<font color=#447700>!JOE-end GRIMS<a name='3376'></font>
    INTEGER, SAVE :: levflag<a name='3377'>
<a name='3378'>
<font color=#447700>! Stochastic fields <a name='3379'></font>
     INTEGER,  INTENT(IN)                                               ::spp_pbl<a name='3380'>
     REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN),OPTIONAL  ::pattern_spp_pbl<a name='3381'>
     REAL, DIMENSION(KTS:KTE)                         ::    rstoch_col<a name='3382'>
<a name='3383'>
<a name='3384'>
    IF ( wrf_at_debug_level(MYNN_DBG_LVL) ) THEN<a name='3385'>
        WRITE ( mynn_message , FMT='(A)' ) &amp;<a name='3386'>
           'in MYNN driver; at beginning'<a name='3387'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_518"> ( 0 , mynn_message )<a name='3388'>
    ENDIF<a name='3389'>
<a name='3390'>
<font color=#447700>!***  Begin debugging<a name='3391'></font>
    IMD=(IMS+IME)/2<a name='3392'>
    JMD=(JMS+JME)/2<a name='3393'>
<font color=#447700>!***  End debugging <a name='3394'></font>
<a name='3395'>
    JTF=MIN0(JTE,JDE-1)<a name='3396'>
    ITF=MIN0(ITE,IDE-1)<a name='3397'>
    KTF=MIN0(KTE,KDE-1)<a name='3398'>
<a name='3399'>
    levflag=mynn_level<a name='3400'>
<a name='3401'>
    IF (bl_mynn_edmf &gt; 0) THEN<a name='3402'>
      <font color=#447700>! setup random seed<a name='3403'></font>
      <font color=#447700>!call init_random_seed<a name='3404'></font>
<a name='3405'>
      edmf_a(its:ite,kts:kte,jts:jte)=0.<a name='3406'>
      edmf_w(its:ite,kts:kte,jts:jte)=0.<a name='3407'>
      edmf_qt(its:ite,kts:kte,jts:jte)=0.<a name='3408'>
      edmf_thl(its:ite,kts:kte,jts:jte)=0.<a name='3409'>
      edmf_ent(its:ite,kts:kte,jts:jte)=0.<a name='3410'>
      edmf_qc(its:ite,kts:kte,jts:jte)=0.<a name='3411'>
    ENDIF<a name='3412'>
<a name='3413'>
    IF (initflag &gt; 0) THEN<a name='3414'>
 <a name='3415'>
       Sh3D(its:ite,kts:kte,jts:jte)=0.<a name='3416'>
       el_pbl(its:ite,kts:kte,jts:jte)=0.<a name='3417'>
       tsq(its:ite,kts:kte,jts:jte)=0.<a name='3418'>
       qsq(its:ite,kts:kte,jts:jte)=0.<a name='3419'>
       cov(its:ite,kts:kte,jts:jte)=0.<a name='3420'>
       dqc1(kts:kte)=0.0<a name='3421'>
       dqi1(kts:kte)=0.0<a name='3422'>
       dqni1(kts:kte)=0.0<a name='3423'>
       <font color=#447700>!dqnc1(kts:kte)=0.0<a name='3424'></font>
       qc_bl1D(kts:kte)=0.0<a name='3425'>
       cldfra_bl1D(kts:kte)=0.0<a name='3426'>
       qc_bl1D_old(kts:kte)=0.0<a name='3427'>
       cldfra_bl1D_old(kts:kte)=0.0<a name='3428'>
       edmf_a1(kts:kte)=0.0<a name='3429'>
       edmf_qc1(kts:kte)=0.0<a name='3430'>
       sgm(kts:kte)=0.0<a name='3431'>
       vt(kts:kte)=0.0<a name='3432'>
       vq(kts:kte)=0.0<a name='3433'>
<a name='3434'>
       DO j=JTS,JTF<a name='3435'>
          DO i=ITS,ITF<a name='3436'>
             DO k=KTS,KTF<a name='3437'>
                dz1(k)=dz(i,k,j)<a name='3438'>
                u1(k) = u(i,k,j)<a name='3439'>
                v1(k) = v(i,k,j)<a name='3440'>
                w1(k) = w(i,k,j)<a name='3441'>
                th1(k)=th(i,k,j)<a name='3442'>
                tk1(k)=T3D(i,k,j)<a name='3443'>
                rho1(k)=rho(i,k,j)<a name='3444'>
                sqc(k)=qc(i,k,j)/(1.+qc(i,k,j))<a name='3445'>
                sqv(k)=qv(i,k,j)/(1.+qv(i,k,j))<a name='3446'>
                thetav(k)=th(i,k,j)*(1.+0.61*sqv(k))<a name='3447'>
                IF (PRESENT(qi) .AND. FLAG_QI ) THEN<a name='3448'>
                   sqi(k)=qi(i,k,j)/(1.+qi(i,k,j))<a name='3449'>
                   sqw(k)=sqv(k)+sqc(k)+sqi(k)<a name='3450'>
                   thl(k)=th(i,k,j)- xlvcp/exner(i,k,j)*sqc(k) &amp;<a name='3451'>
                       &amp;           - xlscp/exner(i,k,j)*sqi(k)<a name='3452'>
                   <font color=#447700>!Use form from Tripoli and Cotton (1981) with their<a name='3453'></font>
                   <font color=#447700>!suggested min temperature to improve accuracy.<a name='3454'></font>
                   <font color=#447700>!thl(k)=th(i,k,j)*(1.- xlvcp/MAX(tk1(k),TKmin)*sqc(k) &amp;<a name='3455'></font>
                   <font color=#447700>!    &amp;               - xlscp/MAX(tk1(k),TKmin)*sqi(k))<a name='3456'></font>
                ELSE<a name='3457'>
                   sqi(k)=0.0<a name='3458'>
                   sqw(k)=sqv(k)+sqc(k)<a name='3459'>
                   thl(k)=th(i,k,j)-xlvcp/exner(i,k,j)*sqc(k)<a name='3460'>
                   <font color=#447700>!Use form from Tripoli and Cotton (1981) with their <a name='3461'></font>
                   <font color=#447700>!suggested min temperature to improve accuracy.      <a name='3462'></font>
                   <font color=#447700>!thl(k)=th(i,k,j)*(1.- xlvcp/MAX(tk1(k),TKmin)*sqc(k))<a name='3463'></font>
                ENDIF<a name='3464'>
<a name='3465'>
                IF (k==kts) THEN<a name='3466'>
                   zw(k)=0.<a name='3467'>
                ELSE<a name='3468'>
                   zw(k)=zw(k-1)+dz(i,k-1,j)<a name='3469'>
                ENDIF<a name='3470'>
<a name='3471'>
                exch_m(i,k,j)=0.<a name='3472'>
                exch_h(i,k,j)=0.<a name='3473'>
                K_q(i,k,j)=0.<a name='3474'>
                qke(i,k,j)=0.1-MIN(zw(k)*0.001, 0.0) <font color=#447700>!for initial PBLH calc only<a name='3475'></font>
                qke1(k)=qke(i,k,j)<a name='3476'>
                el(k)=el_pbl(i,k,j)<a name='3477'>
                sh(k)=Sh3D(i,k,j)<a name='3478'>
                tsq1(k)=tsq(i,k,j)<a name='3479'>
                qsq1(k)=qsq(i,k,j)<a name='3480'>
                cov1(k)=cov(i,k,j)<a name='3481'>
                if (spp_pbl==1) then<a name='3482'>
                    rstoch_col(k)=pattern_spp_pbl(i,k,j)<a name='3483'>
                else<a name='3484'>
                    rstoch_col(k)=0.0<a name='3485'>
                endif<a name='3486'>
<a name='3487'>
<a name='3488'>
                IF ( bl_mynn_tkebudget == 1) THEN<a name='3489'>
                   <font color=#447700>!TKE BUDGET VARIABLES<a name='3490'></font>
                   qWT(i,k,j)=0.<a name='3491'>
                   qSHEAR(i,k,j)=0.<a name='3492'>
                   qBUOY(i,k,j)=0.<a name='3493'>
                   qDISS(i,k,j)=0.<a name='3494'>
                   dqke(i,k,j)=0.<a name='3495'>
                ENDIF<a name='3496'>
             ENDDO<a name='3497'>
<a name='3498'>
             zw(kte+1)=zw(kte)+dz(i,kte,j)<a name='3499'>
<a name='3500'>
             CALL <A href='../../html_code/phys/module_bl_ysu.F.html#GET_PBLH'>GET_PBLH</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_PBLH_1">(KTS,KTE,PBLH(i,j),thetav,&amp;<a name='3501'>
               &amp;  Qke1,zw,dz1,xland(i,j),KPBL(i,j))<a name='3502'>
             <a name='3503'>
             IF (scaleaware &gt; 0.) THEN<a name='3504'>
                CALL <A href='../../html_code/phys/module_bl_mynn.F.html#SCALE_AWARE'>SCALE_AWARE</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCALE_AWARE_1">(dx,PBLH(i,j),Psig_bl(i,j),Psig_shcu(i,j))<a name='3505'>
             ELSE<a name='3506'>
                Psig_bl(i,j)=1.0<a name='3507'>
                Psig_shcu(i,j)=1.0<a name='3508'>
             ENDIF<a name='3509'>
<a name='3510'>
             CALL <A href='../../html_code/phys/module_bl_mynn.F.html#MYM_INITIALIZE'>mym_initialize</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYM_INITIALIZE_1"> (             &amp; <a name='3511'>
                  &amp;kts,kte,                    &amp;<a name='3512'>
                  &amp;dz1, zw, u1, v1, thl, sqv,  &amp;<a name='3513'>
                  &amp;PBLH(i,j), th1, sh,         &amp;<a name='3514'>
                  &amp;ust(i,j), rmol(i,j),        &amp;<a name='3515'>
                  &amp;el, Qke1, Tsq1, Qsq1, Cov1, &amp;<a name='3516'>
                  &amp;Psig_bl(i,j), cldfra_bl1D,  &amp;<a name='3517'>
                  &amp;bl_mynn_mixlength,          &amp;<a name='3518'>
                  &amp;edmf_a1,edmf_qc1,bl_mynn_edmf,&amp;<a name='3519'>
                  &amp;spp_pbl,rstoch_col )<a name='3520'>
<a name='3521'>
             <font color=#447700>!UPDATE 3D VARIABLES<a name='3522'></font>
             DO k=KTS,KTE <font color=#447700>!KTF<a name='3523'></font>
                el_pbl(i,k,j)=el(k)<a name='3524'>
                sh3d(i,k,j)=sh(k)<a name='3525'>
                qke(i,k,j)=qke1(k)<a name='3526'>
                tsq(i,k,j)=tsq1(k)<a name='3527'>
                qsq(i,k,j)=qsq1(k)<a name='3528'>
                cov(i,k,j)=cov1(k)<a name='3529'>
                <font color=#447700>!ACF,JOE- initialize qke_adv array if using advection<a name='3530'></font>
                IF (bl_mynn_tkeadvect) THEN<a name='3531'>
                   qke_adv(i,k,j)=qke1(k)<a name='3532'>
                ENDIF<a name='3533'>
             ENDDO<a name='3534'>
<a name='3535'>
<font color=#447700>!***  Begin debugging<a name='3536'></font>
<font color=#447700>!             k=kdebug<a name='3537'></font>
<font color=#447700>!             IF(I==IMD .AND. J==JMD)THEN<a name='3538'></font>
<font color=#447700>!               PRINT*,"MYNN DRIVER INIT: k=",1," sh=",sh(k)<a name='3539'></font>
<font color=#447700>!               PRINT*," sqw=",sqw(k)," thl=",thl(k)," k_m=",exch_m(i,k,j)<a name='3540'></font>
<font color=#447700>!               PRINT*," xland=",xland(i,j)," rmol=",rmol(i,j)," ust=",ust(i,j)<a name='3541'></font>
<font color=#447700>!               PRINT*," qke=",qke(i,k,j)," el=",el_pbl(i,k,j)," tsq=",Tsq(i,k,j)<a name='3542'></font>
<font color=#447700>!               PRINT*," PBLH=",PBLH(i,j)," u=",u(i,k,j)," v=",v(i,k,j)<a name='3543'></font>
<font color=#447700>!             ENDIF<a name='3544'></font>
<font color=#447700>!***  End debugging<a name='3545'></font>
<a name='3546'>
          ENDDO<a name='3547'>
       ENDDO<a name='3548'>
<a name='3549'>
    ENDIF <font color=#447700>! end initflag<a name='3550'></font>
<a name='3551'>
    <font color=#447700>!ACF- copy qke_adv array into qke if using advection<a name='3552'></font>
    IF (bl_mynn_tkeadvect) THEN<a name='3553'>
       qke=qke_adv<a name='3554'>
    ENDIF<a name='3555'>
<a name='3556'>
    DO j=JTS,JTF<a name='3557'>
       DO i=ITS,ITF<a name='3558'>
          DO k=KTS,KTF<a name='3559'>
             <font color=#447700>!JOE-TKE BUDGET<a name='3560'></font>
             IF ( bl_mynn_tkebudget == 1) THEN<a name='3561'>
                dqke(i,k,j)=qke(i,k,j)<a name='3562'>
             END IF<a name='3563'>
             dz1(k)= dz(i,k,j)<a name='3564'>
             u1(k) = u(i,k,j)<a name='3565'>
             v1(k) = v(i,k,j)<a name='3566'>
             w1(k) = w(i,k,j)<a name='3567'>
             th1(k)= th(i,k,j)<a name='3568'>
             tk1(k)=T3D(i,k,j)<a name='3569'>
             rho1(k)=rho(i,k,j)<a name='3570'>
             qv1(k)= qv(i,k,j)<a name='3571'>
             qc1(k)= qc(i,k,j)<a name='3572'>
             sqv(k)= qv(i,k,j)/(1.+qv(i,k,j))<a name='3573'>
             sqc(k)= qc(i,k,j)/(1.+qc(i,k,j))<a name='3574'>
             IF(icloud_bl &gt; 0)cldfra_bl1D_old(k)=cldfra_bl(i,k,j)<a name='3575'>
             IF(icloud_bl &gt; 0)qc_bl1D_old(k)=qc_bl(i,k,j)<a name='3576'>
             dqc1(k)=0.0<a name='3577'>
             dqi1(k)=0.0<a name='3578'>
             dqni1(k)=0.0<a name='3579'>
             <font color=#447700>!dqnc1(k)=0.0<a name='3580'></font>
             IF(PRESENT(qi) .AND. FLAG_QI)THEN<a name='3581'>
                qi1(k)= qi(i,k,j)<a name='3582'>
                sqi(k)= qi(i,k,j)/(1.+qi(i,k,j))<a name='3583'>
                sqw(k)= sqv(k)+sqc(k)+sqi(k)<a name='3584'>
                thl(k)= th(i,k,j) - xlvcp/exner(i,k,j)*sqc(k) &amp;<a name='3585'>
                     &amp;            - xlscp/exner(i,k,j)*sqi(k)<a name='3586'>
                <font color=#447700>!Use form from Tripoli and Cotton (1981) with their<a name='3587'></font>
                <font color=#447700>!suggested min temperature to improve accuracy.    <a name='3588'></font>
                <font color=#447700>!thl(k)=th(i,k,j)*(1.- xlvcp/MAX(tk1(k),TKmin)*sqc(k) &amp;<a name='3589'></font>
                <font color=#447700>!    &amp;               - xlscp/MAX(tk1(k),TKmin)*sqi(k))<a name='3590'></font>
             ELSE<a name='3591'>
                qi1(k)=0.0<a name='3592'>
                sqi(k)=0.0<a name='3593'>
                sqw(k)= sqv(k)+sqc(k)<a name='3594'>
                thl(k)= th(i,k,j)-xlvcp/exner(i,k,j)*sqc(k)<a name='3595'>
                <font color=#447700>!Use form from Tripoli and Cotton (1981) with their<a name='3596'></font>
                <font color=#447700>!suggested min temperature to improve accuracy.    <a name='3597'></font>
                <font color=#447700>!thl(k)=th(i,k,j)*(1.- xlvcp/MAX(tk1(k),TKmin)*sqc(k))<a name='3598'></font>
             ENDIF<a name='3599'>
<a name='3600'>
             IF (PRESENT(qni) .AND. FLAG_QNI ) THEN<a name='3601'>
                qni1(k)=qni(i,k,j)<a name='3602'>
                <font color=#447700>!print*,"MYNN: Flag_qni=",FLAG_QNI,qni(i,k,j)<a name='3603'></font>
             ELSE<a name='3604'>
                qni1(k)=0.0<a name='3605'>
             ENDIF<a name='3606'>
             IF (PRESENT(qnc) .AND. FLAG_QNC ) THEN<a name='3607'>
                qnc1(k)=qnc(i,k,j)<a name='3608'>
                <font color=#447700>!print*,"MYNN: Flag_qnc=",FLAG_QNC,qnc(i,k,j)<a name='3609'></font>
             ELSE<a name='3610'>
                qnc1(k)=0.0<a name='3611'>
             ENDIF<a name='3612'>
             thetav(k)=th(i,k,j)*(1.+0.608*sqv(k))<a name='3613'>
             p1(k) = p(i,k,j)<a name='3614'>
             ex1(k)= exner(i,k,j)<a name='3615'>
             el(k) = el_pbl(i,k,j)<a name='3616'>
             qke1(k)=qke(i,k,j)<a name='3617'>
             sh(k) = sh3d(i,k,j)<a name='3618'>
             tsq1(k)=tsq(i,k,j)<a name='3619'>
             qsq1(k)=qsq(i,k,j)<a name='3620'>
             cov1(k)=cov(i,k,j)<a name='3621'>
             if (spp_pbl==1) then<a name='3622'>
                rstoch_col(k)=pattern_spp_pbl(i,k,j)<a name='3623'>
             else<a name='3624'>
                rstoch_col(k)=0.0<a name='3625'>
             endif<a name='3626'>
<a name='3627'>
<a name='3628'>
             <font color=#447700>!edmf<a name='3629'></font>
             edmf_a1(k)=0.0<a name='3630'>
             edmf_qc1(k)=0.0<a name='3631'>
             s_aw1(k)=0.<a name='3632'>
             s_awthl1(k)=0.<a name='3633'>
             s_awqt1(k)=0.<a name='3634'>
             s_awqv1(k)=0.<a name='3635'>
             s_awqc1(k)=0.<a name='3636'>
             s_awu1(k)=0.<a name='3637'>
             s_awv1(k)=0.<a name='3638'>
             s_awqke1(k)=0.<a name='3639'>
<a name='3640'>
#if (WRF_CHEM == 1)<a name='3641'>
             <font color=#447700>! WA 7/29/15 Set up chemical arrays<a name='3642'></font>
             DO ic = 1,nchem<a name='3643'>
                chem1(k,ic) = chem3d(i,k,j,ic)<a name='3644'>
                s_awchem1(k,ic)=0.<a name='3645'>
             ENDDO<a name='3646'>
             DO ic = 1,ndvel<a name='3647'>
                IF (k == KTS) THEN<a name='3648'>
                   vd1(ic) = vd3d(i,1,j,ic)<a name='3649'>
                ENDIF<a name='3650'>
             ENDDO<a name='3651'>
#endif<a name='3652'>
<a name='3653'>
             IF (k==kts) THEN<a name='3654'>
                zw(k)=0.<a name='3655'>
             ELSE<a name='3656'>
                zw(k)=zw(k-1)+dz(i,k-1,j)<a name='3657'>
             ENDIF<a name='3658'>
          ENDDO<a name='3659'>
<a name='3660'>
          zw(kte+1)=zw(kte)+dz(i,kte,j)<a name='3661'>
          <font color=#447700>!EDMF<a name='3662'></font>
          s_aw1(kte+1)=0.<a name='3663'>
          s_awthl1(kte+1)=0.<a name='3664'>
          s_awqt1(kte+1)=0.<a name='3665'>
          s_awqv1(kte+1)=0.<a name='3666'>
          s_awqc1(kte+1)=0.<a name='3667'>
          s_awu1(kte+1)=0.<a name='3668'>
          s_awv1(kte+1)=0.<a name='3669'>
          s_awqke1(kte+1)=0.<a name='3670'>
#if (WRF_CHEM == 1)<a name='3671'>
          DO ic = 1,nchem<a name='3672'>
            s_awchem1(kte+1,ic)=0.<a name='3673'>
          ENDDO<a name='3674'>
#endif<a name='3675'>
<a name='3676'>
          CALL <A href='../../html_code/phys/module_bl_ysu.F.html#GET_PBLH'>GET_PBLH</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_PBLH_2">(KTS,KTE,PBLH(i,j),thetav,&amp;<a name='3677'>
          &amp; Qke1,zw,dz1,xland(i,j),KPBL(i,j))<a name='3678'>
<a name='3679'>
          IF (scaleaware &gt; 0.) THEN<a name='3680'>
             CALL <A href='../../html_code/phys/module_bl_mynn.F.html#SCALE_AWARE'>SCALE_AWARE</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCALE_AWARE_2">(dx,PBLH(i,j),Psig_bl(i,j),Psig_shcu(i,j))<a name='3681'>
          ELSE<a name='3682'>
             Psig_bl(i,j)=1.0<a name='3683'>
             Psig_shcu(i,j)=1.0<a name='3684'>
          ENDIF<a name='3685'>
<a name='3686'>
          sqcg= 0.0   <font color=#447700>!JOE, it was: qcg(i,j)/(1.+qcg(i,j))<a name='3687'></font>
          cpm=cp*(1.+0.84*qv(i,kts,j))<a name='3688'>
          exnerg=(ps(i,j)/p1000mb)**rcp<a name='3689'>
<a name='3690'>
          <font color=#447700>!-----------------------------------------------------<a name='3691'></font>
          <font color=#447700>!ORIGINAL CODE<a name='3692'></font>
          <font color=#447700>!flt = hfx(i,j)/( rho(i,kts,j)*cpm ) &amp;<a name='3693'></font>
          <font color=#447700>! +xlvcp*ch(i,j)*(sqc(kts)/exner(i,kts,j) -sqcg/exnerg)<a name='3694'></font>
          <font color=#447700>!flq = qfx(i,j)/  rho(i,kts,j)       &amp;<a name='3695'></font>
          <font color=#447700>!    -ch(i,j)*(sqc(kts)   -sqcg )<a name='3696'></font>
          <font color=#447700>!-----------------------------------------------------<a name='3697'></font>
          <font color=#447700>! Katata-added - The deposition velocity of cloud (fog)<a name='3698'></font>
          <font color=#447700>! water is used instead of CH.<a name='3699'></font>
          flt = hfx(i,j)/( rho(i,kts,j)*cpm ) &amp;<a name='3700'>
            &amp; +xlvcp*vdfg(i,j)*(sqc(kts)/exner(i,kts,j)- sqcg/exnerg)<a name='3701'>
          flq = qfx(i,j)/  rho(i,kts,j)       &amp;<a name='3702'>
            &amp; -vdfg(i,j)*(sqc(kts) - sqcg )<a name='3703'>
          flqv = qfx(i,j)/rho(i,kts,j)<a name='3704'>
          flqc = -vdfg(i,j)*(sqc(kts) - sqcg )<a name='3705'>
          th_sfc = ts(i,j)/ex1(kts)<a name='3706'>
<a name='3707'>
          zet = 0.5*dz(i,kts,j)*rmol(i,j)<a name='3708'>
          if ( zet &gt;= 0.0 ) then<a name='3709'>
            pmz = 1.0 + (cphm_st-1.0) * zet<a name='3710'>
            phh = 1.0 +  cphh_st      * zet<a name='3711'>
          else<a name='3712'>
            pmz = 1.0/    (1.0-cphm_unst*zet)**0.25 - zet<a name='3713'>
            phh = 1.0/SQRT(1.0-cphh_unst*zet)<a name='3714'>
          end if<a name='3715'>
<a name='3716'>
          <font color=#447700>!-- Estimate wstar &amp; delta for GRIMS shallow-cu-------<a name='3717'></font>
          govrth = g/th1(kts)<a name='3718'>
          sflux = hfx(i,j)/rho(i,kts,j)/cpm + &amp;<a name='3719'>
                  qfx(i,j)/rho(i,kts,j)*ep_1*th1(kts)<a name='3720'>
          bfx0 = max(sflux,0.)<a name='3721'>
          wstar3     = (govrth*bfx0*pblh(i,j))<a name='3722'>
          wstar(i,j) = wstar3**h1<a name='3723'>
          wm3        = wstar3 + 5.*ust(i,j)**3.<a name='3724'>
          wm2        = wm3**h2<a name='3725'>
          delb       = govrth*d3*pblh(i,j)<a name='3726'>
          delta(i,j) = min(d1*pblh(i,j) + d2*wm2/delb, 100.)<a name='3727'>
          <font color=#447700>!-- End GRIMS-----------------------------------------<a name='3728'></font>
<a name='3729'>
          CALL  <A href='../../html_code/phys/module_bl_mynn.F.html#MYM_CONDENSATION'>mym_condensation</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYM_CONDENSATION_1"> ( kts,kte,      &amp;<a name='3730'>
               &amp;dx,dz1,thl,sqw,p1,ex1,           &amp;<a name='3731'>
               &amp;tsq1, qsq1, cov1,                &amp;<a name='3732'>
               &amp;Sh,el,bl_mynn_cloudpdf,          &amp;<a name='3733'>
               &amp;qc_bl1D,cldfra_bl1D,             &amp;<a name='3734'>
               &amp;PBLH(i,j),HFX(i,j),              &amp;<a name='3735'>
               &amp;Vt, Vq, th1, sgm )<a name='3736'>
<a name='3737'>
          IF (bl_mynn_edmf == 1) THEN<a name='3738'>
            <font color=#447700>!PRINT*,"Calling StEM Mass-Flux: i= ",i," j=",j<a name='3739'></font>
            CALL <A href='../../html_code/phys/module_bl_mynn.F.html#STEM_MF'>StEM_mf</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STEM_MF_1">(                         &amp;<a name='3740'>
               &amp;kts,kte,delt,zw,dz1,p1,           &amp;<a name='3741'>
               &amp;bl_mynn_edmf_mom,                 &amp;<a name='3742'>
               &amp;bl_mynn_edmf_tke,                 &amp;<a name='3743'>
               &amp;u1,v1,w1,th1,thl,thetav,tk1,      &amp;<a name='3744'>
               &amp;sqw,sqv,sqc,qke1,                 &amp;<a name='3745'>
               &amp;ex1,Vt,Vq,sgm,                    &amp;<a name='3746'>
               &amp;ust(i,j),flt,flq,flqv,flqc,       &amp;<a name='3747'>
               &amp;PBLH(i,j),KPBL(i,j),DX,           &amp;<a name='3748'>
               &amp;xland(i,j),th_sfc,                &amp;<a name='3749'>
            <font color=#447700>! now outputs - tendencies<a name='3750'></font>
            <font color=#447700>! &amp;,dth1mf,dqv1mf,dqc1mf,du1mf,dv1mf &amp;<a name='3751'></font>
            <font color=#447700>! outputs - updraft properties<a name='3752'></font>
               &amp; edmf_a1,edmf_w1,edmf_qt1,        &amp;<a name='3753'>
               &amp; edmf_thl1,edmf_ent1,edmf_qc1,    &amp;<a name='3754'>
            <font color=#447700>! for the solver<a name='3755'></font>
               &amp; s_aw1,s_awthl1,s_awqt1,          &amp;<a name='3756'>
               &amp; s_awqv1,s_awqc1,s_awu1,s_awv1,   &amp;<a name='3757'>
               &amp; s_awqke1,                        &amp;<a name='3758'>
#if (WRF_CHEM == 1)<a name='3759'>
               &amp; nchem,chem1,s_awchem1,           &amp;<a name='3760'>
#endif<a name='3761'>
               &amp; qc_bl1D,cldfra_bl1D,             &amp;<a name='3762'>
               &amp; FLAG_QI,FLAG_QC,                 &amp;<a name='3763'>
               &amp; Psig_shcu(i,j),                  &amp;<a name='3764'>
               &amp; spp_pbl,rstoch_col               &amp;<a name='3765'>
            )<a name='3766'>
<a name='3767'>
          ELSEIF (bl_mynn_edmf == 2) THEN<a name='3768'>
            CALL <A href='../../html_code/phys/module_bl_mynn.F.html#TEMF_MF'>temf_mf</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TEMF_MF_1">(                         &amp;<a name='3769'>
               &amp;kts,kte,delt,zw,p1,ex1,           &amp;<a name='3770'>
               &amp;u1,v1,w1,th1,thl,thetav,          &amp;<a name='3771'>
               &amp;sqw,sqv,sqc,qke1,                 &amp;<a name='3772'>
               &amp;ust(i,j),flt,flq,flqv,flqc,       &amp;<a name='3773'>
               &amp;hfx(i,j),qfx(i,j),ts(i,j),        &amp;<a name='3774'>
               &amp;pblh(i,j),rho1,dfh,dx,znt(i,j),ep_2,   &amp;<a name='3775'>
            <font color=#447700>! outputs - updraft properties<a name='3776'></font>
               &amp; edmf_a1,edmf_w1,edmf_qt1,        &amp;<a name='3777'>
               &amp; edmf_thl1,edmf_ent1,edmf_qc1,    &amp;<a name='3778'>
            <font color=#447700>! for the solver<a name='3779'></font>
               &amp; s_aw1,s_awthl1,s_awqt1,          &amp;<a name='3780'>
               &amp; s_awqv1,s_awqc1,                 &amp;<a name='3781'>
               &amp; s_awu1,s_awv1,s_awqke1,          &amp;<a name='3782'>
#if (WRF_CHEM == 1)<a name='3783'>
               &amp; nchem,chem1,s_awchem1,           &amp;<a name='3784'>
#endif<a name='3785'>
               &amp; qc_bl1D,cldfra_bl1D              &amp;<a name='3786'>
               &amp;,FLAG_QI,FLAG_QC                  &amp;<a name='3787'>
               &amp;,Psig_shcu(i,j)                   &amp;<a name='3788'>
               &amp;,spp_pbl,rstoch_col               &amp;<a name='3789'>
               &amp;,i,j,ids,ide,jds,jde              &amp;<a name='3790'>
             )<a name='3791'>
          ENDIF<a name='3792'>
<a name='3793'>
          CALL <A href='../../html_code/phys/module_bl_mynn.F.html#MYM_TURBULENCE'>mym_turbulence</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYM_TURBULENCE_1"> (                  &amp; <a name='3794'>
               &amp;kts,kte,levflag,                 &amp;<a name='3795'>
               &amp;dz1, zw, u1, v1, thl, sqc, sqw,  &amp;<a name='3796'>
               &amp;qke1, tsq1, qsq1, cov1,          &amp;<a name='3797'>
               &amp;vt, vq,                          &amp;<a name='3798'>
               &amp;rmol(i,j), flt, flq,             &amp;<a name='3799'>
               &amp;PBLH(i,j),th1,                   &amp;<a name='3800'>
               &amp;Sh,el,                           &amp;<a name='3801'>
               &amp;Dfm,Dfh,Dfq,                     &amp;<a name='3802'>
               &amp;Tcd,Qcd,Pdk,                     &amp;<a name='3803'>
               &amp;Pdt,Pdq,Pdc,                     &amp;<a name='3804'>
               &amp;qWT1,qSHEAR1,qBUOY1,qDISS1,      &amp;<a name='3805'>
               &amp;bl_mynn_tkebudget,               &amp;<a name='3806'>
               &amp;Psig_bl(i,j),Psig_shcu(i,j),     &amp;     <a name='3807'>
               &amp;cldfra_bl1D,bl_mynn_mixlength,   &amp;<a name='3808'>
               &amp;edmf_a1,edmf_qc1,bl_mynn_edmf,   &amp;<a name='3809'>
               &amp;spp_pbl,rstoch_col)<a name='3810'>
<a name='3811'>
<a name='3812'>
<font color=#447700>!          IF (bl_mynn_edmf &gt; 0) THEN<a name='3813'></font>
<font color=#447700>!            !DEBUG<a name='3814'></font>
<font color=#447700>!             DO k=kts,kte<a name='3815'></font>
<font color=#447700>!               IF (s_aw1(k)&lt;0. .OR. s_aw1(k)&gt;0.5) THEN<a name='3816'></font>
<font color=#447700>!                  PRINT*,"After Mass-Flux: i= ",i," j=",j," k=",k<a name='3817'></font>
<font color=#447700>!                  PRINT*," s_aw1=",s_aw1(k)," s_awthl1=",s_awthl1(k)," s_awqt1=",s_awqt1(k)<a name='3818'></font>
<font color=#447700>!                  PRINT*," s_awu1=",s_awu1(k)," s_awv1=",s_awu1(k)<a name='3819'></font>
<font color=#447700>!               ENDIF<a name='3820'></font>
<font color=#447700>!             ENDDO<a name='3821'></font>
<font color=#447700>!          ENDIF<a name='3822'></font>
<a name='3823'>
          IF (bl_mynn_edmf_part &gt; 0 .AND. bl_mynn_edmf &gt; 0) THEN<a name='3824'>
             <font color=#447700>!Partition the fluxes from each component (ed &amp; mf).<a name='3825'></font>
             <font color=#447700>!Assume overlap of 50%: Reduce eddy diffusivities by 50% of the estimated<a name='3826'></font>
             <font color=#447700>!area fraction of mass-flux scheme's updraft.<a name='3827'></font>
             DO k=kts,kte<a name='3828'>
                dfm(k)=dfm(k) * (1. - 0.5*edmf_a1(k))<a name='3829'>
                dfh(k)=dfh(k) * (1. - 0.5*edmf_a1(k))<a name='3830'>
                dfq(k)=dfq(k) * (1. - 0.5*edmf_a1(k))<a name='3831'>
             ENDDO<a name='3832'>
          ENDIF<a name='3833'>
<a name='3834'>
          CALL <A href='../../html_code/phys/module_bl_mynn.F.html#MYM_PREDICT'>mym_predict</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYM_PREDICT_1"> (kts,kte,levflag,     &amp;<a name='3835'>
               &amp;delt, dz1,                       &amp;<a name='3836'>
               &amp;ust(i,j), flt, flq, pmz, phh,    &amp;<a name='3837'>
               &amp;el, dfq, pdk, pdt, pdq, pdc,     &amp;<a name='3838'>
               &amp;Qke1, Tsq1, Qsq1, Cov1,          &amp;<a name='3839'>
               &amp;s_aw1, s_awqke1, bl_mynn_edmf_tke)<a name='3840'>
<a name='3841'>
          CALL <A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_TENDENCIES'>mynn_tendencies</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYNN_TENDENCIES_1">(kts,kte,          &amp;<a name='3842'>
               &amp;levflag,grav_settling,           &amp;<a name='3843'>
               &amp;delt, dz1,                       &amp;<a name='3844'>
               &amp;u1, v1, th1, tk1, qv1, qc1, qi1, &amp;<a name='3845'>
               &amp;qni1,qnc1,                       &amp;<a name='3846'>
               &amp;p1, ex1, thl, sqv, sqc, sqi, sqw,&amp;<a name='3847'>
               &amp;ust(i,j),flt,flq,flqv,flqc,      &amp;<a name='3848'>
               &amp;wspd(i,j),qcg(i,j),              &amp;<a name='3849'>
               &amp;uoce(i,j),voce(i,j),             &amp;<a name='3850'>
               &amp;tsq1, qsq1, cov1,                &amp;<a name='3851'>
               &amp;tcd, qcd,                        &amp;<a name='3852'>
               &amp;dfm, dfh, dfq,                   &amp;<a name='3853'>
               &amp;Du1, Dv1, Dth1, Dqv1,            &amp;<a name='3854'>
               &amp;Dqc1, Dqi1, Dqni1,               &amp; <font color=#447700>!Dqnc1,        &amp;<a name='3855'></font>
               &amp;vdfg(i,j),                       &amp; <font color=#447700>!JOE/Katata- fog deposition<a name='3856'></font>
               <font color=#447700>! mass flux components<a name='3857'></font>
               &amp;s_aw1,s_awthl1,s_awqt1,          &amp;<a name='3858'>
               &amp;s_awqv1,s_awqc1,s_awu1,s_awv1,   &amp;<a name='3859'>
               &amp;FLAG_QI,FLAG_QNI,FLAG_QC,FLAG_QNC,&amp;<a name='3860'>
               &amp;cldfra_bl1d,                     &amp;<a name='3861'>
               &amp;bl_mynn_cloudmix,                &amp;<a name='3862'>
               &amp;bl_mynn_mixqt,                   &amp;<a name='3863'>
               &amp;bl_mynn_edmf,                    &amp;<a name='3864'>
               &amp;bl_mynn_edmf_mom)<a name='3865'>
<a name='3866'>
#if (WRF_CHEM == 1)<a name='3867'>
    IF (bl_mynn_mixchem == 1) THEN<a name='3868'>
          CALL <A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_MIX_CHEM'>mynn_mix_chem</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYNN_MIX_CHEM_1">(kts,kte,          &amp;<a name='3869'>
               levflag,grav_settling,           &amp;<a name='3870'>
               delt, dz1,                       &amp;<a name='3871'>
               nchem, kdvel, ndvel, num_vert_mix, &amp;<a name='3872'>
               chem1, vd1,                      &amp;<a name='3873'>
               qni1,qnc1,                       &amp;<a name='3874'>
               p1, ex1, thl, sqv, sqc, sqi, sqw,&amp;<a name='3875'>
               ust(i,j),flt,flq,flqv,flqc,      &amp;<a name='3876'>
               wspd(i,j),qcg(i,j),              &amp;<a name='3877'>
               uoce(i,j),voce(i,j),             &amp;<a name='3878'>
               tsq1, qsq1, cov1,                &amp;<a name='3879'>
               tcd, qcd,                        &amp;<a name='3880'>
               &amp;dfm, dfh, dfq,                  &amp;<a name='3881'>
               <font color=#447700>! mass flux components<a name='3882'></font>
               &amp; s_awchem1,                      &amp;<a name='3883'>
               &amp;bl_mynn_cloudmix)<a name='3884'>
    ENDIF<a name='3885'>
#endif<a name='3886'>
<a name='3887'>
<font color=#447700>!<a name='3888'></font>
<font color=#447700>! add mass flux tendencies and calculate the new variables. <a name='3889'></font>
<font color=#447700>! Now done implicitly in the mynn_tendencies subroutine<a name='3890'></font>
<font color=#447700>!           do k=kts,kte<a name='3891'></font>
<font color=#447700>!             du1(k)=du1(k)+du1mf(k)<a name='3892'></font>
<font color=#447700>!             dv1(k)=dv1(k)+dv1mf(k)<a name='3893'></font>
<font color=#447700>!             dth1(k)=dth1(k)+dth1mf(k)<a name='3894'></font>
<font color=#447700>!             dqv1(k)=dqv1(k)+dqv1mf(k)<a name='3895'></font>
<font color=#447700>! that is supposed to be done by bl_fogdes<a name='3896'></font>
<font color=#447700>!             dqc1(k)=dqc1(k)+dqc1mf(k) <a name='3897'></font>
<font color=#447700>!           enddo<a name='3898'></font>
 <a name='3899'>
<a name='3900'>
          CALL <A href='../../html_code/phys/module_bl_mynn.F.html#RETRIEVE_EXCHANGE_COEFFS'>retrieve_exchange_coeffs</A><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RETRIEVE_EXCHANGE_COEFFS_1">(kts,kte,&amp;<a name='3901'>
               &amp;dfm, dfh, dfq, dz1,&amp;<a name='3902'>
               &amp;K_m1, K_h1, K_q1)<a name='3903'>
<a name='3904'>
          <font color=#447700>!UPDATE 3D ARRAYS<a name='3905'></font>
          DO k=KTS,KTF<a name='3906'>
             exch_m(i,k,j)=K_m1(k)<a name='3907'>
             exch_h(i,k,j)=K_h1(k)<a name='3908'>
             K_q(i,k,j)=K_q1(k)<a name='3909'>
             RUBLTEN(i,k,j)=du1(k)<a name='3910'>
             RVBLTEN(i,k,j)=dv1(k)<a name='3911'>
             RTHBLTEN(i,k,j)=dth1(k)<a name='3912'>
             RQVBLTEN(i,k,j)=dqv1(k)<a name='3913'>
             IF(bl_mynn_cloudmix &gt; 0)THEN<a name='3914'>
               IF (PRESENT(qc) .AND. FLAG_QC) RQCBLTEN(i,k,j)=dqc1(k)<a name='3915'>
               IF (PRESENT(qi) .AND. FLAG_QI) RQIBLTEN(i,k,j)=dqi1(k)<a name='3916'>
               <font color=#447700>!IF (PRESENT(qnc) .AND. FLAG_QNC) RQNCBLTEN(i,k,j)=dqnc1(k)<a name='3917'></font>
               IF (PRESENT(qni) .AND. FLAG_QNI) RQNIBLTEN(i,k,j)=dqni1(k)<a name='3918'>
             ELSE<a name='3919'>
               IF (PRESENT(qc) .AND. FLAG_QC) RQCBLTEN(i,k,j)=0.<a name='3920'>
               IF (PRESENT(qi) .AND. FLAG_QI) RQIBLTEN(i,k,j)=0.<a name='3921'>
               <font color=#447700>!IF (PRESENT(qnc) .AND. FLAG_QNC) RQNCBLTEN(i,k,j)=0.<a name='3922'></font>
               IF (PRESENT(qni) .AND. FLAG_QNI) RQNIBLTEN(i,k,j)=0.<a name='3923'>
             ENDIF<a name='3924'>
<a name='3925'>
             IF(icloud_bl &gt; 0)THEN<a name='3926'>
               <font color=#447700>!make BL clouds scale aware - may already be done in mym_condensation<a name='3927'></font>
               qc_bl(i,k,j)=qc_bl1D(k) <font color=#447700>!*Psig_shcu(i,j)<a name='3928'></font>
               cldfra_bl(i,k,j)=cldfra_bl1D(k) <font color=#447700>!*Psig_shcu(i,j)<a name='3929'></font>
<a name='3930'>
               <font color=#447700>!DIAGNOSTIC-DECAY FOR SUBGRID-SCALE CLOUDS<a name='3931'></font>
               IF (CLDFRA_BL(i,k,j) &gt; cldfra_bl1D_old(k)) THEN<a name='3932'>
                  <font color=#447700>!KEEP UPDATED CLOUD FRACTION &amp; MIXING RATIO<a name='3933'></font>
               ELSE<a name='3934'>
                  <font color=#447700>!DECAY TIMESCALE FOR CALM CONDITION IS THE EDDY TURNOVER TIMESCALE, BUT FOR<a name='3935'></font>
                  <font color=#447700>!WINDY CONDITIONS, IT IS THE ADVECTIVE TIMESCALE. USE THE MINIMUM OF THE TWO.<a name='3936'></font>
                  ts_decay = MIN( 1800., 3.*dx/MAX(SQRT(u1(k)**2 + v1(k)**2), 1.0) )<a name='3937'>
                  cldfra_bl(i,k,j)= MAX(cldfra_bl1D(k), cldfra_bl1D_old(k)-(0.25*delt/ts_decay))<a name='3938'>
                  IF (cldfra_bl(i,k,j) &gt; 0.1) THEN<a name='3939'>
                     IF (QC_BL(i,k,j) &lt; 1E-5)QC_BL(i,k,j)= MAX(qc_bl1D_old(k), 1E-5)<a name='3940'>
                  ELSE<a name='3941'>
                     CLDFRA_BL(i,k,j)= 0.<a name='3942'>
                     QC_BL(i,k,j)    = 0.<a name='3943'>
                  ENDIF<a name='3944'>
               ENDIF<a name='3945'>
<a name='3946'>
               <font color=#447700>!Stochastic perturbations to cldfra_bl and qc_bl<a name='3947'></font>
               if (spp_pbl==1) then<a name='3948'>
                   cldfra_bl(i,k,j)= cldfra_bl(i,k,j)*(1.0-rstoch_col(k))<a name='3949'>
                  IF ((cldfra_bl(i,k,j) &gt; 1.0) .or. (cldfra_bl(i,k,j) &lt; 0.0)) then<a name='3950'>
                     cldfra_bl(i,k,j)=MAX(MIN(cldfra_bl(i,k,j),1.0),0.0)<a name='3951'>
                  ENDIF<a name='3952'>
               ENDIF<a name='3953'>
<a name='3954'>
               <font color=#447700>!Reapply checks on cldfra_bl and qc_bl to avoid FPEs in radiation driver<a name='3955'></font>
               <font color=#447700>! when these two quantities are multiplied by eachother (they may have changed<a name='3956'></font>
               <font color=#447700>! in the MF scheme:<a name='3957'></font>
               IF (icloud_bl &gt; 0) THEN<a name='3958'>
                 IF (QC_BL(i,k,j) &lt; 1E-6 .AND. ABS(CLDFRA_BL(i,k,j)) &gt; 0.1)QC_BL(i,k,j)= 1E-6<a name='3959'>
                 IF (CLDFRA_BL(i,k,j) &lt; 1E-2)CLDFRA_BL(i,k,j)= 0.<a name='3960'>
               ENDIF<a name='3961'>
             ENDIF<a name='3962'>
             el_pbl(i,k,j)=el(k)<a name='3963'>
             qke(i,k,j)=qke1(k)<a name='3964'>
             tsq(i,k,j)=tsq1(k)<a name='3965'>
             qsq(i,k,j)=qsq1(k)<a name='3966'>
             cov(i,k,j)=cov1(k)<a name='3967'>
             sh3d(i,k,j)=sh(k)<a name='3968'>
<a name='3969'>
             IF ( bl_mynn_tkebudget == 1) THEN<a name='3970'>
                dqke(i,k,j)  = (qke1(k)-dqke(i,k,j))*0.5  <font color=#447700>!qke-&gt;tke<a name='3971'></font>
                qWT(i,k,j)   = qWT1(k)*delt<a name='3972'>
                qSHEAR(i,k,j)= qSHEAR1(k)*delt<a name='3973'>
                qBUOY(i,k,j) = qBUOY1(k)*delt<a name='3974'>
                qDISS(i,k,j) = qDISS1(k)*delt<a name='3975'>
             ENDIF<a name='3976'>
<a name='3977'>
             <font color=#447700>!update updraft properties<a name='3978'></font>
             IF (bl_mynn_edmf &gt; 0) THEN<a name='3979'>
               edmf_a(i,k,j)=edmf_a1(k)<a name='3980'>
               edmf_w(i,k,j)=edmf_w1(k)<a name='3981'>
               edmf_qt(i,k,j)=edmf_qt1(k)<a name='3982'>
               edmf_thl(i,k,j)=edmf_thl1(k)<a name='3983'>
               edmf_ent(i,k,j)=edmf_ent1(k)<a name='3984'>
               edmf_qc(i,k,j)=edmf_qc1(k)<a name='3985'>
             ENDIF<a name='3986'>
<a name='3987'>
             <font color=#447700>!***  Begin debug prints<a name='3988'></font>
             IF ( wrf_at_debug_level(3000) ) THEN<a name='3989'>
               IF ( sh(k) &lt; 0. .OR. sh(k)&gt; 200.)print*,"**SUSPICIOUS VALUES AT: i,j,k=",i,j,k," sh=",sh(k)<a name='3990'>
               IF ( qke(i,k,j) &lt; -1. .OR. qke(i,k,j)&gt; 200.)print*,"**SUSPICIOUS VALUES AT: i,j,k=",i,j,k," qke=",qke(i,k,j)<a name='3991'>
               IF ( el_pbl(i,k,j) &lt; 0. .OR. el_pbl(i,k,j)&gt; 2000.)print*,"**SUSPICIOUS VALUES AT: i,j,k=",i,j,k," el_pbl=",el_pbl(i,k,j)<a name='3992'>
               IF ( ABS(vt(k)) &gt; 0.8 )print*,"**SUSPICIOUS VALUES AT: i,j,k=",i,j,k," vt=",vt(k)<a name='3993'>
               IF ( ABS(vq(k)) &gt; 6000.)print*,"**SUSPICIOUS VALUES AT: i,j,k=",i,j,k," vq=",vq(k) <a name='3994'>
               IF ( exch_m(i,k,j) &lt; 0. .OR. exch_m(i,k,j)&gt; 2000.)print*,"**SUSPICIOUS VALUES AT: i,j,k=",i,j,k," exxch_m=",exch_m(i,k,j)<a name='3995'>
               IF ( vdfg(i,j) &lt; 0. .OR. vdfg(i,j)&gt;5. )print*,"**SUSPICIOUS VALUES AT: i,j,k=",i,j,k," vdfg=",vdfg(i,j)<a name='3996'>
               IF ( ABS(QFX(i,j))&gt;.001)print*, "**SUSPICIOUS VALUES AT: i,j=",i,j," QFX=",QFX(i,j)<a name='3997'>
               IF ( ABS(HFX(i,j))&gt;1000.)print*, "**SUSPICIOUS VALUES AT: i,j=",i,j," HFX=",HFX(i,j)<a name='3998'>
               IF (icloud_bl &gt; 0) then<a name='3999'>
                  IF( cldfra_bl(i,k,j) &lt; 0.0 .OR. cldfra_bl(i,k,j)&gt; 1.)THEN<a name='4000'>
                  PRINT*,"**SUSPICIOUS VALUES: CLDFRA_BL=",cldfra_bl(i,k,j)," qc_bl=",QC_BL(i,k,j)<a name='4001'>
                  ENDIF<a name='4002'>
               ENDIF<a name='4003'>
             ENDIF<a name='4004'>
             <font color=#447700>!***  End debug prints<a name='4005'></font>
          ENDDO<a name='4006'>
<a name='4007'>
          <font color=#447700>!JOE-add tke_pbl for coupling w/shallow-cu schemes (TKE_PBL = QKE/2.)<a name='4008'></font>
          <font color=#447700>!    TKE_PBL is defined on interfaces, while QKE is at middle of layer.<a name='4009'></font>
          tke_pbl(i,kts,j) = 0.5*MAX(qke(i,kts,j),1.0e-10)<a name='4010'>
          DO k = kts+1,kte<a name='4011'>
             afk = dz1(k)/( dz1(k)+dz1(k-1) )<a name='4012'>
             abk = 1.0 -afk<a name='4013'>
             tke_pbl(i,k,j) = 0.5*MAX(qke(i,k,j)*abk+qke(i,k-1,j)*afk,1.0e-3)<a name='4014'>
          ENDDO<a name='4015'>
<a name='4016'>
<font color=#447700>!***  Begin debugging<a name='4017'></font>
<font color=#447700>!          IF(I==IMD .AND. J==JMD)THEN<a name='4018'></font>
<font color=#447700>!             k=kdebug<a name='4019'></font>
<font color=#447700>!             PRINT*,"MYNN DRIVER END: k=",1," sh=",sh(k)<a name='4020'></font>
<font color=#447700>!             PRINT*," sqw=",sqw(k)," thl=",thl(k)," k_m=",k_m(i,k,j)<a name='4021'></font>
<font color=#447700>!             PRINT*," xland=",xland(i,j)," rmol=",rmol(i,j)," ust=",ust(i,j)<a name='4022'></font>
<font color=#447700>!             PRINT*," qke=",qke(i,k,j)," el=",el_pbl(i,k,j)," tsq=",tsq(i,k,j)<a name='4023'></font>
<font color=#447700>!             PRINT*," PBLH=",PBLH(i,j)," u=",u(i,k,j)," v=",v(i,k,j)<a name='4024'></font>
<font color=#447700>!             PRINT*," vq=",vq(k)," vt=",vt(k)," vdfg=",vdfg(i,j)<a name='4025'></font>
<font color=#447700>!          ENDIF<a name='4026'></font>
<font color=#447700>!***  End debugging<a name='4027'></font>
<a name='4028'>
       ENDDO<a name='4029'>
    ENDDO<a name='4030'>
<a name='4031'>
<font color=#447700>!ACF copy qke into qke_adv if using advection<a name='4032'></font>
    IF (bl_mynn_tkeadvect) THEN<a name='4033'>
       qke_adv=qke<a name='4034'>
    ENDIF<a name='4035'>
<font color=#447700>!ACF-end<a name='4036'></font>
    <a name='4037'>
  END SUBROUTINE mynn_bl_driver<a name='4038'>
<a name='4039'>
<font color=#447700>! ==================================================================<a name='4040'></font>
<A NAME='MYNN_BL_INIT_DRIVER'><A href='../../html_code/phys/module_bl_mynn.F.html#MYNN_BL_INIT_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4041'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>mynn_bl_init_driver</font>(                   &amp; <A href='../../call_to/MYNN_BL_INIT_DRIVER.html' TARGET='index'>1</A><a name='4042'>
       &amp;RUBLTEN,RVBLTEN,RTHBLTEN,RQVBLTEN,          &amp;<a name='4043'>
       &amp;RQCBLTEN,RQIBLTEN &amp; <font color=#447700>!,RQNIBLTEN,RQNCBLTEN       &amp;<a name='4044'></font>
       &amp;,QKE,TKE_PBL,EXCH_H                         &amp;<a name='4045'>
<font color=#447700>!       &amp;,icloud_bl,qc_bl,cldfra_bl                 &amp; !JOE-subgrid bl clouds <a name='4046'></font>
       &amp;,RESTART,ALLOWED_TO_READ,LEVEL              &amp;<a name='4047'>
       &amp;,IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='4048'>
       &amp;,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='4049'>
       &amp;,ITS,ITE,JTS,JTE,KTS,KTE)<a name='4050'>
<a name='4051'>
    <font color=#447700>!---------------------------------------------------------------<a name='4052'></font>
    LOGICAL,INTENT(IN) :: ALLOWED_TO_READ,RESTART<a name='4053'>
    INTEGER,INTENT(IN) :: LEVEL <font color=#447700>!,icloud_bl<a name='4054'></font>
<a name='4055'>
    INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE,                    &amp;<a name='4056'>
         &amp;                IMS,IME,JMS,JME,KMS,KME,                    &amp;<a name='4057'>
         &amp;                ITS,ITE,JTS,JTE,KTS,KTE<a name='4058'>
    <a name='4059'>
    <a name='4060'>
    REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(INOUT) :: &amp;<a name='4061'>
         &amp;RUBLTEN,RVBLTEN,RTHBLTEN,RQVBLTEN,                 &amp;<a name='4062'>
         &amp;RQCBLTEN,RQIBLTEN,&amp; <font color=#447700>!RQNIBLTEN,RQNCBLTEN       &amp;<a name='4063'></font>
         &amp;QKE,TKE_PBL,EXCH_H<a name='4064'>
<a name='4065'>
<font color=#447700>!    REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(INOUT) :: &amp;<a name='4066'></font>
<font color=#447700>!         &amp;qc_bl,cldfra_bl<a name='4067'></font>
<a name='4068'>
    INTEGER :: I,J,K,ITF,JTF,KTF<a name='4069'>
    <a name='4070'>
    JTF=MIN0(JTE,JDE-1)<a name='4071'>
    KTF=MIN0(KTE,KDE-1)<a name='4072'>
    ITF=MIN0(ITE,IDE-1)<a name='4073'>
    <a name='4074'>
    IF(.NOT.RESTART)THEN<a name='4075'>
       DO J=JTS,JTF<a name='4076'>
          DO K=KTS,KTF<a name='4077'>
             DO I=ITS,ITF<a name='4078'>
                RUBLTEN(i,k,j)=0.<a name='4079'>
                RVBLTEN(i,k,j)=0.<a name='4080'>
                RTHBLTEN(i,k,j)=0.<a name='4081'>
                RQVBLTEN(i,k,j)=0.<a name='4082'>
                if( p_qc &gt;= param_first_scalar ) RQCBLTEN(i,k,j)=0.<a name='4083'>
                if( p_qi &gt;= param_first_scalar ) RQIBLTEN(i,k,j)=0.<a name='4084'>
                <font color=#447700>!if( p_qnc &gt;= param_first_scalar ) RQNCBLTEN(i,k,j)=0.<a name='4085'></font>
                <font color=#447700>!if( p_qni &gt;= param_first_scalar ) RQNIBLTEN(i,k,j)=0.<a name='4086'></font>
                <font color=#447700>!QKE(i,k,j)=0.<a name='4087'></font>
                TKE_PBL(i,k,j)=0.<a name='4088'>
                EXCH_H(i,k,j)=0.<a name='4089'>
<font color=#447700>!                if(icloud_bl &gt; 0) qc_bl(i,k,j)=0.<a name='4090'></font>
<font color=#447700>!                if(icloud_bl &gt; 0) cldfra_bl(i,k,j)=0.<a name='4091'></font>
             ENDDO<a name='4092'>
          ENDDO<a name='4093'>
       ENDDO<a name='4094'>
    ENDIF<a name='4095'>
<a name='4096'>
    mynn_level=level<a name='4097'>
<a name='4098'>
  END SUBROUTINE mynn_bl_init_driver<a name='4099'>
<a name='4100'>
<font color=#447700>! ==================================================================<a name='4101'></font>
<a name='4102'>
<A NAME='GET_PBLH'><A href='../../html_code/phys/module_bl_mynn.F.html#GET_PBLH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4103'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>GET_PBLH</font>(KTS,KTE,zi,thetav1D,qke1D,zw1D,dz1D,landsea,kzi) <A href='../../call_to/GET_PBLH.html' TARGET='index'>3</A><a name='4104'>
<a name='4105'>
    <font color=#447700>!---------------------------------------------------------------<a name='4106'></font>
    <font color=#447700>!             NOTES ON THE PBLH FORMULATION<a name='4107'></font>
    <font color=#447700>!<a name='4108'></font>
    <font color=#447700>!The 1.5-theta-increase method defines PBL heights as the level at <a name='4109'></font>
    <font color=#447700>!which the potential temperature first exceeds the minimum potential <a name='4110'></font>
    <font color=#447700>!temperature within the boundary layer by 1.5 K. When applied to <a name='4111'></font>
    <font color=#447700>!observed temperatures, this method has been shown to produce PBL-<a name='4112'></font>
    <font color=#447700>!height estimates that are unbiased relative to profiler-based <a name='4113'></font>
    <font color=#447700>!estimates (Nielsen-Gammon et al. 2008). However, their study did not<a name='4114'></font>
    <font color=#447700>!include LLJs. Banta and Pichugina (2008) show that a TKE-based <a name='4115'></font>
    <font color=#447700>!threshold is a good estimate of the PBL height in LLJs. Therefore,<a name='4116'></font>
    <font color=#447700>!a hybrid definition is implemented that uses both methods, weighting<a name='4117'></font>
    <font color=#447700>!the TKE-method more during stable conditions (PBLH &lt; 400 m).<a name='4118'></font>
    <font color=#447700>!A variable tke threshold (TKEeps) is used since no hard-wired<a name='4119'></font>
    <font color=#447700>!value could be found to work best in all conditions.<a name='4120'></font>
    <font color=#447700>!---------------------------------------------------------------<a name='4121'></font>
<a name='4122'>
    INTEGER,INTENT(IN) :: KTS,KTE<a name='4123'>
    REAL, INTENT(OUT) :: zi<a name='4124'>
    REAL, INTENT(IN) :: landsea<a name='4125'>
    REAL, DIMENSION(KTS:KTE), INTENT(IN) :: thetav1D, qke1D, dz1D<a name='4126'>
    REAL, DIMENSION(KTS:KTE+1), INTENT(IN) :: zw1D<a name='4127'>
    <font color=#447700>!LOCAL VARS<a name='4128'></font>
    REAL ::  PBLH_TKE,qtke,qtkem1,wt,maxqke,TKEeps,minthv<a name='4129'>
    REAL :: delt_thv   <font color=#447700>!delta theta-v; dependent on land/sea point<a name='4130'></font>
    REAL, PARAMETER :: sbl_lim  = 250. <font color=#447700>!200. !upper limit of stable BL height (m).<a name='4131'></font>
    REAL, PARAMETER :: sbl_damp = 500. <font color=#447700>!400. !transition length for blending (m).<a name='4132'></font>
    INTEGER :: I,J,K,kthv,ktke,kzi,kzi2<a name='4133'>
<a name='4134'>
    <font color=#447700>!ADD KPBL (kzi) for coupling to some Cu schemes, initialize at k=2                                  <a name='4135'></font>
    <font color=#447700>!kzi2 is the TKE-based part of the hybrid KPBL                                                      <a name='4136'></font>
    kzi = 2<a name='4137'>
    kzi2= 2<a name='4138'>
<a name='4139'>
    <font color=#447700>!FIND MAX TKE AND MIN THETAV IN THE LOWEST 250 M<a name='4140'></font>
    k = kts+1<a name='4141'>
    kthv = 1<a name='4142'>
    ktke = 1<a name='4143'>
    maxqke = 0.<a name='4144'>
    minthv = 9.E9<a name='4145'>
    DO WHILE (zw1D(k) .LE. sbl_lim)<a name='4146'>
       qtke  =MAX(Qke1D(k),0.)   <font color=#447700>! maximum QKE<a name='4147'></font>
       IF (maxqke &lt; qtke) then<a name='4148'>
           maxqke = qtke<a name='4149'>
           ktke = k<a name='4150'>
       ENDIF<a name='4151'>
       IF (minthv &gt; thetav1D(k)) then<a name='4152'>
           minthv = thetav1D(k)<a name='4153'>
           kthv = k<a name='4154'>
       ENDIF<a name='4155'>
       k = k+1<a name='4156'>
    ENDDO<a name='4157'>
<a name='4158'>
    <font color=#447700>!Use 5% of tke max (Kosovic and Curry, 2000; JAS)<a name='4159'></font>
    <font color=#447700>!TKEeps = maxtke/20. = maxqke/40.<a name='4160'></font>
    TKEeps = maxqke/40.<a name='4161'>
    TKEeps = MAX(TKEeps,0.02) <font color=#447700>!0.010) !0.025)<a name='4162'></font>
<a name='4163'>
    <font color=#447700>!FIND THETAV-BASED PBLH (BEST FOR DAYTIME).<a name='4164'></font>
    zi=0.<a name='4165'>
    k = kthv+1<a name='4166'>
    IF((landsea-1.5).GE.0)THEN<a name='4167'>
        <font color=#447700>! WATER<a name='4168'></font>
        delt_thv = 0.75<a name='4169'>
    ELSE<a name='4170'>
        <font color=#447700>! LAND<a name='4171'></font>
        delt_thv = 1.25<a name='4172'>
    ENDIF<a name='4173'>
<a name='4174'>
    zi=0.<a name='4175'>
    k = kthv+1<a name='4176'>
    DO WHILE (zi .EQ. 0.) <a name='4177'>
       IF (thetav1D(k) .GE. (minthv + delt_thv))THEN<a name='4178'>
          kzi = MAX(k-1,1)<a name='4179'>
          zi = zw1D(k) - dz1D(k-1)* &amp;<a name='4180'>
             &amp; MIN((thetav1D(k)-(minthv + delt_thv))/ &amp;<a name='4181'>
             &amp; MAX(thetav1D(k)-thetav1D(k-1),1E-6),1.0)<a name='4182'>
       ENDIF<a name='4183'>
       k = k+1<a name='4184'>
       IF (k .EQ. kte-1) zi = zw1D(kts+1) <font color=#447700>!EXIT SAFEGUARD<a name='4185'></font>
    ENDDO<a name='4186'>
    <font color=#447700>!print*,"IN GET_PBLH:",thsfc,zi<a name='4187'></font>
<a name='4188'>
    <font color=#447700>!FOR STABLE BOUNDARY LAYERS, USE TKE METHOD TO COMPLEMENT THE<a name='4189'></font>
    <font color=#447700>!THETAV-BASED DEFINITION (WHEN THE THETA-V BASED PBLH IS BELOW ~0.5 KM).<a name='4190'></font>
    <font color=#447700>!THE TANH WEIGHTING FUNCTION WILL MAKE THE TKE-BASED DEFINITION NEGLIGIBLE <a name='4191'></font>
    <font color=#447700>!WHEN THE THETA-V-BASED DEFINITION IS ABOVE ~1 KM.<a name='4192'></font>
<a name='4193'>
    PBLH_TKE=0.<a name='4194'>
    k = ktke+1<a name='4195'>
    DO WHILE (PBLH_TKE .EQ. 0.) <a name='4196'>
       <font color=#447700>!QKE CAN BE NEGATIVE (IF CKmod == 0)... MAKE TKE NON-NEGATIVE.<a name='4197'></font>
       qtke  =MAX(Qke1D(k)/2.,0.)      <font color=#447700>! maximum TKE<a name='4198'></font>
       qtkem1=MAX(Qke1D(k-1)/2.,0.)<a name='4199'>
       IF (qtke .LE. TKEeps) THEN<a name='4200'>
           kzi2 = MAX(k-1,1)<a name='4201'>
           PBLH_TKE = zw1D(k) - dz1D(k-1)* &amp;<a name='4202'>
             &amp; MIN((TKEeps-qtke)/MAX(qtkem1-qtke, 1E-6), 1.0)<a name='4203'>
           <font color=#447700>!IN CASE OF NEAR ZERO TKE, SET PBLH = LOWEST LEVEL.<a name='4204'></font>
           PBLH_TKE = MAX(PBLH_TKE,zw1D(kts+1))<a name='4205'>
           <font color=#447700>!print *,"PBLH_TKE:",i,j,PBLH_TKE, Qke1D(k)/2., zw1D(kts+1)<a name='4206'></font>
       ENDIF<a name='4207'>
       k = k+1<a name='4208'>
       IF (k .EQ. kte-1) PBLH_TKE = zw1D(kts+1) <font color=#447700>!EXIT SAFEGUARD<a name='4209'></font>
    ENDDO<a name='4210'>
<a name='4211'>
    <font color=#447700>!With TKE advection turned on, the TKE-based PBLH can be very large <a name='4212'></font>
    <font color=#447700>!in grid points with convective precipitation (&gt; 8 km!),<a name='4213'></font>
    <font color=#447700>!so an artificial limit is imposed to not let PBLH_TKE exceed the<a name='4214'></font>
    <font color=#447700>!theta_v-based PBL height +/- 500 m.<a name='4215'></font>
    <font color=#447700>!This has no impact on 98-99% of the domain, but is the simplest patch<a name='4216'></font>
    <font color=#447700>!that adequately addresses these extremely large PBLHs.<a name='4217'></font>
    PBLH_TKE = MIN(PBLH_TKE,zi+500.)<a name='4218'>
    PBLH_TKE = MAX(PBLH_TKE,MAX(zi-500.,10.))<a name='4219'>
<a name='4220'>
    wt=.5*TANH((zi - sbl_lim)/sbl_damp) + .5<a name='4221'>
    IF (maxqke &lt;= 0.05) THEN<a name='4222'>
       <font color=#447700>!Cold pool situation - default to theta_v-based def<a name='4223'></font>
    ELSE<a name='4224'>
       <font color=#447700>!BLEND THE TWO PBLH TYPES HERE: <a name='4225'></font>
       zi=PBLH_TKE*(1.-wt) + zi*wt<a name='4226'>
    ENDIF<a name='4227'>
<a name='4228'>
    <font color=#447700>!ADD KPBL (kzi) for coupling to some Cu schemes<a name='4229'></font>
     kzi = MAX(INT(kzi2*(1.-wt) + kzi*wt),1)<a name='4230'>
<a name='4231'>
  END SUBROUTINE GET_PBLH<a name='4232'>
  <a name='4233'>
<font color=#447700>! ==================================================================<a name='4234'></font>
<font color=#447700>! Much thanks to Kay Suslj of NASA-JPL for contributing the original version<a name='4235'></font>
<font color=#447700>! of this mass-flux scheme. Considerable changes have been made from it's<a name='4236'></font>
<font color=#447700>! original form. Some additions include:<a name='4237'></font>
<font color=#447700>!  1) scale-aware tapering as dx -&gt; 0<a name='4238'></font>
<font color=#447700>!  2) transport of TKE (extra namelist option)<a name='4239'></font>
<font color=#447700>!  3) Chaboureau-Bechtold cloud fraction &amp; coupling to radiation (when icloud_bl &gt; 0)<a name='4240'></font>
<font color=#447700>!  4) some extra limits for numerical stability<a name='4241'></font>
<font color=#447700>! This scheme remains under development, so consider it experimental code. <a name='4242'></font>
<font color=#447700>!<a name='4243'></font>
<A NAME='STEM_MF'><A href='../../html_code/phys/module_bl_mynn.F.html#STEM_MF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4244'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>StEM_mf</font>(                       &amp; <A href='../../call_to/STEM_MF.html' TARGET='index'>1</A>,<A href='../../call_from/STEM_MF.html' TARGET='index'>3</A><a name='4245'>
                 &amp; kts,kte,dt,zw,dz,p,      &amp;<a name='4246'>
                 &amp; momentum_opt,            &amp;<a name='4247'>
                 &amp; tke_opt,                 &amp;<a name='4248'>
                 &amp; u,v,w,th,thl,thv,tk,     &amp;<a name='4249'>
                 &amp; qt,qv,qc,qke,            &amp;<a name='4250'>
                 &amp; exner,vt,vq,sgm,         &amp;<a name='4251'>
                 &amp; ust,flt,flq,flqv,flqc,   &amp;<a name='4252'>
                 &amp; pblh,kpbl,DX,landsea,ts, &amp;<a name='4253'>
            <font color=#447700>! outputs - tendencies<a name='4254'></font>
            <font color=#447700>!  &amp;dth,dqv,dqc,du,dv,&amp;<a name='4255'></font>
            <font color=#447700>! outputs - updraft properties   <a name='4256'></font>
                 &amp; edmf_a,edmf_w,           &amp;<a name='4257'>
                 &amp; edmf_qt,edmf_thl,        &amp;<a name='4258'>
                 &amp; edmf_ent,edmf_qc,        &amp;<a name='4259'>
            <font color=#447700>! outputs - variables needed for solver <a name='4260'></font>
                 &amp; s_aw,s_awthl,s_awqt,     &amp;<a name='4261'>
                 &amp; s_awqv,s_awqc,           &amp;<a name='4262'>
                 &amp; s_awu,s_awv,s_awqke,     &amp;<a name='4263'>
#if (WRF_CHEM == 1)<a name='4264'>
                 &amp; nchem,chem,s_awchem,      &amp;<a name='4265'>
#endif<a name='4266'>
            <font color=#447700>! in/outputs - subgrid scale clouds<a name='4267'></font>
                 &amp; qc_bl1d,cldfra_bl1d,     &amp;<a name='4268'>
            <font color=#447700>! inputs - flags for moist arrays<a name='4269'></font>
                 &amp;F_QC,F_QI,                &amp;<a name='4270'>
                 &amp;Psig_shcu,                &amp;<a name='4271'>
            <font color=#447700>! unputs for stochastic perturbations<a name='4272'></font>
                 &amp;spp_pbl,rstoch_col) <a name='4273'>
<a name='4274'>
<font color=#447700>! Stochastic  <a name='4275'></font>
     INTEGER,  INTENT(IN)          :: spp_pbl<a name='4276'>
     REAL, DIMENSION(KTS:KTE)      :: rstoch_col<a name='4277'>
  <font color=#447700>! inputs:<a name='4278'></font>
     INTEGER, INTENT(IN) :: KTS,KTE,momentum_opt,tke_opt,kpbl<a name='4279'>
     REAL,DIMENSION(KTS:KTE), INTENT(IN) :: U,V,W,TH,THL,TK,QT,QV,QC,&amp;<a name='4280'>
                                            THV,P,qke,exner,dz<a name='4281'>
     REAL,DIMENSION(KTS:KTE+1), INTENT(IN) :: ZW  <font color=#447700>!height at full-sigma<a name='4282'></font>
     REAL, INTENT(IN) :: DT,UST,FLT,FLQ,FLQV,FLQC,PBLH,&amp;<a name='4283'>
                         DX,Psig_shcu,landsea,ts<a name='4284'>
     LOGICAL, OPTIONAL :: F_QC,F_QI<a name='4285'>
<a name='4286'>
  <font color=#447700>! outputs - tendencies<a name='4287'></font>
  <font color=#447700>!   REAL,DIMENSION(KTS:KTE), INTENT(OUT) :: DTH,DQV,DQC,DU,DV<a name='4288'></font>
  <font color=#447700>! outputs - updraft properties<a name='4289'></font>
     REAL,DIMENSION(KTS:KTE), INTENT(OUT) :: edmf_a,edmf_w,        &amp;<a name='4290'>
                      &amp; edmf_qt,edmf_thl, edmf_ent,edmf_qc<a name='4291'>
  <font color=#447700>! output<a name='4292'></font>
     INTEGER :: nup2,ktop<a name='4293'>
     REAL    :: maxmf<a name='4294'>
  <font color=#447700>! outputs - variables needed for solver<a name='4295'></font>
     REAL,DIMENSION(KTS:KTE+1) :: s_aw,      &amp; <font color=#447700>!sum ai*wis_awphi<a name='4296'></font>
                               s_awthl,      &amp; <font color=#447700>!sum ai*wi*phii<a name='4297'></font>
                                s_awqt,      &amp;<a name='4298'>
                                s_awqv,      &amp;<a name='4299'>
                                s_awqc,      &amp;<a name='4300'>
                                 s_awu,      &amp;<a name='4301'>
                                 s_awv,      &amp;<a name='4302'>
                               s_awqke<a name='4303'>
<a name='4304'>
     REAL,DIMENSION(KTS:KTE), INTENT(INOUT) :: qc_bl1d,cldfra_bl1d<a name='4305'>
<a name='4306'>
    INTEGER, PARAMETER :: NUP=10<a name='4307'>
  <font color=#447700>! local variables<a name='4308'></font>
  <font color=#447700>! updraft properties<a name='4309'></font>
     REAL,DIMENSION(KTS:KTE+1,1:NUP) :: UPW,UPTHL,UPQT,UPQC,UPQV,  &amp;<a name='4310'>
                                        UPA,UPU,UPV,UPTHV,UPQKE<a name='4311'>
  <font color=#447700>! entrainment variables<a name='4312'></font>
     REAL,DIMENSION(KTS:KTE,1:NUP) :: ENT,ENTf<a name='4313'>
     INTEGER,DIMENSION(KTS:KTE,1:NUP) :: ENTi<a name='4314'>
  <font color=#447700>! internal variables<a name='4315'></font>
     INTEGER :: K,I,k50<a name='4316'>
     REAL :: fltv,wstar,qstar,thstar,sigmaW,sigmaQT,sigmaTH,z0,    &amp;<a name='4317'>
             pwmin,pwmax,wmin,wmax,wlv,wtv,Psig_w,maxw,maxqc,wpbl<a name='4318'>
     REAL :: B,QTn,THLn,THVn,QCn,Un,Vn,QKEn,Wn2,EntEXP,EntW<a name='4319'>
<a name='4320'>
  <font color=#447700>! w parameters<a name='4321'></font>
     REAL,PARAMETER :: &amp;<a name='4322'>
          &amp;Wa=2./3., &amp;<a name='4323'>
          &amp;Wb=0.002,&amp;<a name='4324'>
          &amp;Wc=1.5 <a name='4325'>
        <a name='4326'>
  <font color=#447700>! Lateral entrainment parameters ( L0=100 and ENT0=0.1) were taken from<a name='4327'></font>
  <font color=#447700>! Suselj et al (2013, jas). Note that Suselj et al (2014,waf) use L0=200 and ENT0=0.2.<a name='4328'></font>
     REAL,PARAMETER :: &amp;<a name='4329'>
         &amp; L0=100.,&amp;<a name='4330'>
         &amp; ENT0=0.1<a name='4331'>
<a name='4332'>
  <font color=#447700>! Implement ideas from Neggers (2016, JAMES):<a name='4333'></font>
     REAL, PARAMETER :: Atot = 0.1  <font color=#447700>!0125! Maximum total fractional area of all updrafts<a name='4334'></font>
     REAL, PARAMETER :: lmax = 1000.<font color=#447700>! diameter of largest plume<a name='4335'></font>
     REAL, PARAMETER :: dl   = 100. <font color=#447700>! diff size of each plume - the differential multiplied by the integrand<a name='4336'></font>
     REAL, PARAMETER :: dcut = 1.0  <font color=#447700>! max diameter of plume to parameterize relative to dx (km)<a name='4337'></font>
     REAL ::  d            <font color=#447700>!= -2.3 to -1.7  ;=-1.9 in Neggers paper; power law exponent for number density (N=Cl^d).<a name='4338'></font>
          <font color=#447700>! Note that changing d to -2.0 makes each size plume equally contribute to the total coverage of all plumes.<a name='4339'></font>
          <font color=#447700>! Note that changing d to -1.7 doubles the area coverage of the largest plumes relative to the smallest plumes.<a name='4340'></font>
     REAL :: cn,c,l,n,an2,hux,maxwidth,wspd_pbl,cloud_base,width_flx<a name='4341'>
<a name='4342'>
#if (WRF_CHEM == 1)<a name='4343'>
     INTEGER, INTENT(IN) :: nchem<a name='4344'>
     REAL,DIMENSION(kts:kte, nchem) :: chem<a name='4345'>
     REAL,DIMENSION(kts:kte+1, nchem) :: s_awchem<a name='4346'>
     REAL,DIMENSION(nchem) :: chemn<a name='4347'>
     REAL,DIMENSION(KTS:KTE+1,1:NUP, nchem) :: UPCHEM<a name='4348'>
     INTEGER :: ic<a name='4349'>
     REAL,DIMENSION(KTS:KTE+1, nchem) :: edmf_chem<a name='4350'>
#endif<a name='4351'>
<a name='4352'>
  <font color=#447700>!JOE: add declaration of ERF<a name='4353'></font>
   REAL :: ERF<a name='4354'>
<a name='4355'>
  <font color=#447700>!JOE: add option to switch cloud fraction calculations:<a name='4356'></font>
   INTEGER, PARAMETER :: cldfra_opt = 0  <font color=#447700>! 0: Chaboureau and Bechtold (2005, JGR)<a name='4357'></font>
                                         <font color=#447700>! 1: Xu &amp; Randall (1994)<a name='4358'></font>
  <font color=#447700>!JOE:add for cldfra<a name='4359'></font>
   REAL :: xcldfra, UMF_new, dcf, ktop_dcf, kbcon_dcf<a name='4360'>
  <font color=#447700>! PARAMETERS FOR RANDALL AND XU (1996) CLOUD FRACTION<a name='4361'></font>
   REAL, PARAMETER  ::  coef_p = 0.25, coef_gamm = 0.49, coef_alph = 100.<a name='4362'>
   REAL :: satvp,rhgrid,h2oliq<a name='4363'>
   LOGICAL :: superadiabatic<a name='4364'>
<a name='4365'>
  <font color=#447700>! VARIABLES FOR CHABOUREAU-BECHTOLD CLOUD FRACTION<a name='4366'></font>
   REAL,DIMENSION(KTS:KTE), INTENT(INOUT) :: vt, vq, sgm<a name='4367'>
   REAL :: sigq,xl,tlk,qsat_tl,rsl,cpm,a,qmq,mf_cf,diffqt,&amp;<a name='4368'>
           Fng,qww,alpha,beta,bb,f,pt,t,q2p,b9<a name='4369'>
<a name='4370'>
   <font color=#447700>! WA TEST 11/9/15 for consistent reduction of updraft params<a name='4371'></font>
   REAL :: csigma,acfac<a name='4372'>
<a name='4373'>
   <font color=#447700>!JOE- plume overshoot<a name='4374'></font>
   INTEGER :: overshoot<a name='4375'>
   REAL :: bvf, Frz<a name='4376'>
<a name='4377'>
<font color=#447700>! check the inputs<a name='4378'></font>
<font color=#447700>!     print *,'dt',dt<a name='4379'></font>
<font color=#447700>!     print *,'dz',dz<a name='4380'></font>
<font color=#447700>!     print *,'u',u<a name='4381'></font>
<font color=#447700>!     print *,'v',v<a name='4382'></font>
<font color=#447700>!     print *,'thl',thl<a name='4383'></font>
<font color=#447700>!     print *,'qt',qt<a name='4384'></font>
<font color=#447700>!     print *,'ust',ust<a name='4385'></font>
<font color=#447700>!     print *,'flt',flt<a name='4386'></font>
<font color=#447700>!     print *,'flq',flq<a name='4387'></font>
<font color=#447700>!     print *,'pblh',pblh<a name='4388'></font>
<a name='4389'>
<font color=#447700>! Initialize individual updraft properties<a name='4390'></font>
  UPW=0.<a name='4391'>
  UPTHL=0.<a name='4392'>
  UPTHV=0.<a name='4393'>
  UPQT=0.<a name='4394'>
  UPA=0.<a name='4395'>
  UPU=0.<a name='4396'>
  UPV=0.<a name='4397'>
  UPQC=0.<a name='4398'>
  UPQV=0.<a name='4399'>
  UPQKE=0.<a name='4400'>
#if (WRF_CHEM == 1)<a name='4401'>
  UPCHEM(KTS:KTE+1,1:NUP,1:nchem)=0.0<a name='4402'>
#endif<a name='4403'>
  ENT=0.001<a name='4404'>
<font color=#447700>! Initialize mean updraft properties<a name='4405'></font>
  edmf_a  =0.<a name='4406'>
  edmf_w  =0.<a name='4407'>
  edmf_qt =0.<a name='4408'>
  edmf_thl=0.<a name='4409'>
  edmf_ent=0.<a name='4410'>
  edmf_qc =0.<a name='4411'>
#if (WRF_CHEM == 1)<a name='4412'>
  edmf_chem(kts:kte+1,1:nchem) = 0.0<a name='4413'>
#endif<a name='4414'>
<font color=#447700>! Initialize the variables needed for implicit solver<a name='4415'></font>
  s_aw=0.<a name='4416'>
  s_awthl=0.<a name='4417'>
  s_awqt=0.<a name='4418'>
  s_awqv=0.<a name='4419'>
  s_awqc=0.<a name='4420'>
  s_awu=0.<a name='4421'>
  s_awv=0.<a name='4422'>
  s_awqke=0.<a name='4423'>
#if (WRF_CHEM == 1)<a name='4424'>
  s_awchem(kts:kte+1,1:nchem) = 0.0<a name='4425'>
#endif<a name='4426'>
<a name='4427'>
<a name='4428'>
  <font color=#447700>!taper off MF scheme when significant resolved-scale motions are present<a name='4429'></font>
  <font color=#447700>!This function needs to be asymetric...<a name='4430'></font>
  k      = 1<a name='4431'>
  maxw   = 0.0<a name='4432'>
  cloud_base  = 9000.0<a name='4433'>
  DO WHILE (ZW(k) &lt; pblh + 500.)<a name='4434'>
     wpbl = w(k)<a name='4435'>
     IF(w(k) &lt; 0.)wpbl = 2.*w(k)<a name='4436'>
     maxw = MAX(maxw,ABS(wpbl))<a name='4437'>
<a name='4438'>
     <font color=#447700>!Find highest k-level below 50m AGL<a name='4439'></font>
     IF(ZW(k)&lt;=50.)k50=k<a name='4440'>
<a name='4441'>
     <font color=#447700>!Search for cloud base<a name='4442'></font>
     IF(qc(k)&gt;1E-5 .AND. cloud_base == 9000.0)THEN<a name='4443'>
       cloud_base = 0.5*(ZW(k)+ZW(k+1))<a name='4444'>
     ENDIF<a name='4445'>
<a name='4446'>
     k = k + 1<a name='4447'>
  ENDDO<a name='4448'>
  <font color=#447700>!print*," maxw before manipulation=", maxw<a name='4449'></font>
  maxw = MAX(0.,maxw - 0.5)         <font color=#447700>! do nothing for small w, but<a name='4450'></font>
  Psig_w = MAX(0.0, 1.0 - maxw/0.5) <font color=#447700>! linearly taper off for w &gt; 0.5 m/s<a name='4451'></font>
  Psig_w = MIN(Psig_w, Psig_shcu)<a name='4452'>
  <font color=#447700>!print*," maxw=", maxw," Psig_w=",Psig_w," Psig_shcu=",Psig_shcu<a name='4453'></font>
<a name='4454'>
  fltv = flt + svp1*flq<a name='4455'>
  <font color=#447700>!PRINT*," fltv=",fltv," zi=",pblh <a name='4456'></font>
<a name='4457'>
  <font color=#447700>!Completely shut off MF scheme for strong resolved-scale vertical velocities.<a name='4458'></font>
  IF(Psig_w == 0.0 .and. fltv &gt; 0.0) fltv = -1.*fltv<a name='4459'>
<a name='4460'>
<font color=#447700>! if surface buoyancy is positive we do integration, otherwise not, and make sure that <a name='4461'></font>
<font color=#447700>! PBLH &gt; twice the height of the surface layer (set at z0 = 50m)<a name='4462'></font>
<font color=#447700>! Also, ensure that it is at least slightly superadiabatic up through 50 m<a name='4463'></font>
  superadiabatic = .false.<a name='4464'>
  IF((landsea-1.5).GE.0)THEN<a name='4465'>
     hux = -0.002   <font color=#447700>! WATER  ! dT/dz must be &lt; - 0.2 K per 100 m.<a name='4466'></font>
  ELSE<a name='4467'>
     hux = -0.005  <font color=#447700>! LAND    ! dT/dz must be &lt; - 0.5 K per 100 m.<a name='4468'></font>
  ENDIF<a name='4469'>
  DO k=1,MAX(1,k50-1)<a name='4470'>
    IF (k == 1) then<a name='4471'>
      IF ((th(k)-ts)/(0.5*dz(k)) &lt; hux) THEN<a name='4472'>
        superadiabatic = .true.<a name='4473'>
      ELSE<a name='4474'>
        superadiabatic = .false.<a name='4475'>
        exit<a name='4476'>
      ENDIF<a name='4477'>
    ELSE<a name='4478'>
      IF ((th(k)-th(k-1))/(0.5*(dz(k)+dz(k-1))) &lt; hux) THEN<a name='4479'>
        superadiabatic = .true.<a name='4480'>
      ELSE<a name='4481'>
        superadiabatic = .false.<a name='4482'>
        exit<a name='4483'>
      ENDIF<a name='4484'>
    ENDIF<a name='4485'>
  ENDDO<a name='4486'>
<a name='4487'>
  <font color=#447700>! Determine the numer of updrafts/plumes in the grid column:<a name='4488'></font>
  <font color=#447700>! Some of these criteria may be a little redundant but useful for bullet-proofing.<a name='4489'></font>
  <font color=#447700>!   (1) largest plume = 0.75 * dx.<a name='4490'></font>
  <font color=#447700>!   (2) Apply a scale-break, assuming no plumes with diameter larger than PBLH can exist.<a name='4491'></font>
  <font color=#447700>!   (3) max plume size beneath clouds deck approx = 0.5 * cloud_base.<a name='4492'></font>
  <font color=#447700>!   (4) add shear-dependent limit, when plume model breaks down.<a name='4493'></font>
  <font color=#447700>!   (5) land-only limit to reduce plume sizes in weakly forced conditions<a name='4494'></font>
  <font color=#447700>! Criteria (1)<a name='4495'></font>
  NUP2 = max(1,min(NUP,INT(dx*dcut/dl)))<a name='4496'>
  <font color=#447700>! Criteria (2) and (4)<a name='4497'></font>
  wspd_pbl=SQRT(MAX(u(kpbl)**2 + v(kpbl)**2, 0.01))<a name='4498'>
  maxwidth = 0.9*PBLH - MIN(15.*MAX(wspd_pbl - 7.5, 0.), 0.3*PBLH)<a name='4499'>
  <font color=#447700>! Criteria (3)<a name='4500'></font>
  maxwidth = MIN(maxwidth,0.5*cloud_base)<a name='4501'>
  <font color=#447700>! Criteria (5)<a name='4502'></font>
  IF((landsea-1.5).LT.0)THEN<a name='4503'>
    IF (cloud_base .LT. 2000.) THEN<a name='4504'>
      width_flx = MAX(MIN(1000.*(0.6*tanh((flt - 0.120)/0.03) + .5),1000.), 0.)<a name='4505'>
    ELSE<a name='4506'>
      width_flx = MAX(MIN(1000.*(0.6*tanh((flt - 0.085)/0.04) + .5),1000.), 0.)<a name='4507'>
    ENDIF<a name='4508'>
    maxwidth = MIN(maxwidth,width_flx)<a name='4509'>
  ENDIF<a name='4510'>
  <font color=#447700>! Convert maxwidth to number of plumes<a name='4511'></font>
  NUP2 = MIN(MAX(INT((maxwidth - MOD(maxwidth,100.))/100), 0), NUP2)<a name='4512'>
<a name='4513'>
  <font color=#447700>!Initialize values:<a name='4514'></font>
  ktop = 0<a name='4515'>
  maxmf= 0.0<a name='4516'>
<a name='4517'>
  IF ( fltv &gt; 0.002 .AND. NUP2 .GE. 1 .AND. superadiabatic) then<a name='4518'>
    <font color=#447700>!PRINT*," Conditions met to run mass-flux scheme",fltv,pblh<a name='4519'></font>
<a name='4520'>
    <font color=#447700>! Find coef C for number size density N<a name='4521'></font>
    cn = 0.<a name='4522'>
    d=-1.9  <font color=#447700>!set d to value suggested by Neggers 2015 (JAMES).<a name='4523'></font>
    <font color=#447700>!d=-1.9 + .2*tanh((fltv - 0.05)/0.15) <a name='4524'></font>
    do I=1,NUP2<a name='4525'>
       l  = dl*I                            <font color=#447700>! diameter of plume<a name='4526'></font>
       cn = cn + l**d * (l*l)/(dx*dx) * dl  <font color=#447700>! sum fractional area of each plume<a name='4527'></font>
    enddo<a name='4528'>
    C = Atot/cn   <font color=#447700>!Normalize C according to the defined total fraction (Atot)<a name='4529'></font>
<a name='4530'>
    <font color=#447700>! Find the portion of the total fraction (Atot) of each plume size:<a name='4531'></font>
    An2 = 0.<a name='4532'>
    do I=1,NUP2<a name='4533'>
       l  = dl*I                            <font color=#447700>! diameter of plume<a name='4534'></font>
       N = C*l**d                           <font color=#447700>! number density of plume n<a name='4535'></font>
       UPA(1,I) = N*l*l/(dx*dx) * dl        <font color=#447700>! fractional area of plume n<a name='4536'></font>
       <font color=#447700>! Make updraft area (UPA) a function of the buoyancy flux<a name='4537'></font>
<font color=#447700>!       acfac = .5*tanh((fltv - 0.05)/0.2) + .5<a name='4538'></font>
       acfac = .5*tanh((fltv - 0.07)/0.09) + .5 <a name='4539'>
       UPA(1,I)=UPA(1,I)*acfac<a name='4540'>
       An2 = An2 + UPA(1,I)                 <font color=#447700>! total fractional area of all plumes<a name='4541'></font>
       <font color=#447700>!print*," plume size=",l,"; area=",An,"; total=",An2<a name='4542'></font>
    end do<a name='4543'>
<a name='4544'>
    <font color=#447700>! get entrainment coefficient<a name='4545'></font>
    <font color=#447700>! get dz/L0<a name='4546'></font>
    <font color=#447700>!ENTf(kts:kte,1:Nup)=0.1<a name='4547'></font>
    <font color=#447700>!ENTi(kts:kte,1:Nup)=0.1<a name='4548'></font>
    <font color=#447700>!ENT(kts:kte,1:Nup)=0.001<a name='4549'></font>
    <font color=#447700>!do i=1,Nup2<a name='4550'></font>
    <font color=#447700>!  do k=kts+1,kte<a name='4551'></font>
    <font color=#447700>!    ENTf(k,i)=(ZW(k)-ZW(k-1))/L0    ! input into Poisson<a name='4552'></font>
    <font color=#447700>!    ENTf(k,i)=MIN(ENTf(k,i),9.9) !JOE: test avoiding FPE<a name='4553'></font>
    <font color=#447700>!    ENTf(k,i)=MAX(ENTf(k,i),0.05) !JOE: test avoiding FPE<a name='4554'></font>
    <font color=#447700>!  enddo<a name='4555'></font>
    <font color=#447700>!enddo<a name='4556'></font>
    <font color=#447700>! get Poisson P(dz/L0)<a name='4557'></font>
    <font color=#447700>!call Poisson(1,Nup2,kts+1,kte,ENTf,ENTi)<a name='4558'></font>
    <font color=#447700>! entrainent: Ent=Ent0/dz*P(dz/L0)             <a name='4559'></font>
<a name='4560'>
    <font color=#447700>! set initial conditions for updrafts<a name='4561'></font>
    z0=50.<a name='4562'>
    pwmin=0.1       <font color=#447700>! was 0.5<a name='4563'></font>
    pwmax=0.5       <font color=#447700>! was 3.0<a name='4564'></font>
<a name='4565'>
    wstar=max(1.E-2,(g/thv(1)*fltv*pblh)**(1./3.))<a name='4566'>
    qstar=max(flq,1.0E-5)/wstar<a name='4567'>
    thstar=flt/wstar<a name='4568'>
<a name='4569'>
    IF((landsea-1.5).GE.0)THEN<a name='4570'>
       csigma = 1.34   <font color=#447700>! WATER<a name='4571'></font>
    ELSE<a name='4572'>
       csigma = 1.34   <font color=#447700>! LAND<a name='4573'></font>
    ENDIF<a name='4574'>
    sigmaW =1.34*wstar*(z0/pblh)**(1./3.)*(1 - 0.8*z0/pblh)<a name='4575'>
    sigmaQT=csigma*qstar*(z0/pblh)**(-1./3.)<a name='4576'>
    sigmaTH=csigma*thstar*(z0/pblh)**(-1./3.)<a name='4577'>
<a name='4578'>
    wmin=sigmaW*pwmin<a name='4579'>
    wmax=sigmaW*pwmax<a name='4580'>
<a name='4581'>
    <font color=#447700>!recompute acfac for plume excess<a name='4582'></font>
    acfac = .5*tanh((fltv - 0.08)/0.07) + .5<a name='4583'>
<a name='4584'>
    <font color=#447700>!SPECIFY SURFACE UPDRAFT PROPERTIES<a name='4585'></font>
    DO I=1,NUP2<a name='4586'>
       wlv=wmin+(wmax-wmin)/NUP2*(i-1)<a name='4587'>
       wtv=wmin+(wmax-wmin)/NUP2*i<a name='4588'>
<a name='4589'>
       <font color=#447700>!SURFACE UPDRAFT VERTICAL VELOCITY<a name='4590'></font>
       <font color=#447700>!UPW(1,I)=0.5*(wlv+wtv)<a name='4591'></font>
       UPW(1,I)=wmin + REAL(i)/REAL(NUP)*(wmax-wmin)<a name='4592'>
       <font color=#447700>!IF (UPW(1,I) &gt; 0.5*ZW(2)/dt) UPW(1,I) = 0.5*ZW(2)/dt<a name='4593'></font>
<a name='4594'>
       <font color=#447700>!SURFACE UPDRAFT AREA<a name='4595'></font>
       <font color=#447700>!UPA(1,I)=0.5*ERF(wtv/(sqrt(2.)*sigmaW)) - 0.5*ERF(wlv/(sqrt(2.)*sigmaW))<a name='4596'></font>
       <font color=#447700>!UPA(1,I)=0.25*ERF(wtv/(sqrt(2.)*sigmaW)) - 0.25*ERF(wlv/(sqrt(2.)*sigmaW))  !12.0<a name='4597'></font>
<a name='4598'>
       UPU(1,I)=U(1)<a name='4599'>
       UPV(1,I)=V(1)<a name='4600'>
       UPQC(1,I)=0<a name='4601'>
       <font color=#447700>!UPQT(1,I) =QT(1) +0.58*UPW(1,I)*sigmaQT/sigmaW       <a name='4602'></font>
       <font color=#447700>!UPTHV(1,I)=THV(1)+0.58*UPW(1,I)*sigmaTH/sigmaW<a name='4603'></font>
       <font color=#447700>!Alternatively, initialize parcel over lowest 50m<a name='4604'></font>
       UPQT(1,I) = 0.<a name='4605'>
       UPTHV(1,I)= 0.<a name='4606'>
       UPTHL(1,I)= 0.<a name='4607'>
       k50=1 <font color=#447700>!for now, keep at lowest model layer...<a name='4608'></font>
       DO k=1,k50<a name='4609'>
         UPQT(1,I) = UPQT(1,I) +QT(k) +0.58*UPW(1,I)*sigmaQT/sigmaW *acfac<a name='4610'>
         UPTHV(1,I)= UPTHV(1,I)+THV(k)+0.58*UPW(1,I)*sigmaTH/sigmaW *acfac<a name='4611'>
         UPTHL(1,I)= UPTHL(1,I)+THL(k)+0.58*UPW(1,I)*sigmaTH/sigmaW *acfac<a name='4612'>
       ENDDO<a name='4613'>
       UPQT(1,I) = UPQT(1,I)/REAL(k50)<a name='4614'>
       UPTHV(1,I)= UPTHV(1,I)/REAL(k50)<a name='4615'>
<font color=#447700>!was       UPTHL(1,I)= UPTHV(1,I)/(1.+svp1*UPQT(1,I))  !assume no saturated parcel at surface<a name='4616'></font>
       UPTHL(1,I)= UPTHL(1,I)/REAL(k50)             <font color=#447700>! now, if the lowest layer is saturated, it will be counted for.<a name='4617'></font>
       UPQKE(1,I)= QKE(1)<a name='4618'>
#if (WRF_CHEM == 1)<a name='4619'>
       do ic = 1,nchem<a name='4620'>
          UPCHEM(1,I,ic)= CHEM(1,ic)<a name='4621'>
       enddo<a name='4622'>
#endif<a name='4623'>
<a name='4624'>
<font color=#447700>!       !DEBUG<a name='4625'></font>
<font color=#447700>!       IF (UPA(1,I)&lt;0. .OR. UPA(1,I)&gt;0.5 .OR. wstar&lt;0. .OR. wstar&gt;4.0 .OR. &amp;<a name='4626'></font>
<font color=#447700>!           ABS(thstar)&gt; 5. .OR. sigmaW&gt;1.5) THEN<a name='4627'></font>
<font color=#447700>!          PRINT*,"IN Mass-Flux: UPA(1,i)=",UPA(1,i)<a name='4628'></font>
<font color=#447700>!          PRINT*," wstar=",wstar," qstar=",qstar<a name='4629'></font>
<font color=#447700>!          PRINT*," thstar=",thstar," sigmaW=",sigmaW<a name='4630'></font>
<font color=#447700>!       ENDIF<a name='4631'></font>
<a name='4632'>
    ENDDO<a name='4633'>
<a name='4634'>
  <font color=#447700>!QCn = 0.<a name='4635'></font>
  <font color=#447700>! do integration  updraft<a name='4636'></font>
    DO I=1,NUP2<a name='4637'>
       QCn = 0.<a name='4638'>
       overshoot = 0<a name='4639'>
       l  = dl*I                            <font color=#447700>! diameter of plume<a name='4640'></font>
       DO k=KTS+1,KTE<a name='4641'>
<a name='4642'>
          <font color=#447700>!w-dependency for entrainment a la Tian and Kuang (2016)<a name='4643'></font>
          ENT(k,i) = 0.75/(MIN(MAX(UPW(K-1,I),0.75),1.25)*l)<a name='4644'>
          <font color=#447700>!Entrainment from Negggers (2015, JAMES)<a name='4645'></font>
          <font color=#447700>!ENT(k,i) = 0.02*l**-0.35 - 0.0009<a name='4646'></font>
          <font color=#447700>!JOE - implement minimum background entrainment <a name='4647'></font>
          ENT(k,i) = max(ENT(k,i),0.0006)<a name='4648'>
          ENT(k,i) = max(ENT(k,i),0.05/ZW(k))<a name='4649'>
          <font color=#447700>!JOE - increase entrainment for plumes extending very high.<a name='4650'></font>
          IF(ZW(k) &gt;= pblh+1000.) ENT(k,i) =ENT(k,i) + (ZW(k)-(pblh+1000.)) * 5.0E-6<a name='4651'>
          IF(UPW(K-1,I) &gt; 1.5) ENT(k,i) = ENT(k,i) + 0.004*(UPW(K-1,I) - 1.5)<a name='4652'>
          ENT(k,i) = min(ENT(k,i),0.9/(ZW(k)-ZW(k-1)))<a name='4653'>
<a name='4654'>
          <font color=#447700>! Linear entrainment:<a name='4655'></font>
          EntExp= ENT(K,I)*(ZW(k)-ZW(k-1))<a name='4656'>
          QTn =UPQT(k-1,I) *(1.-EntExp) + QT(k-1)*EntExp<a name='4657'>
          THLn=UPTHL(k-1,I)*(1.-EntExp) + THL(k-1)*EntExp<a name='4658'>
          Un  =UPU(k-1,I)  *(1.-EntExp) + U(k-1)*EntExp<a name='4659'>
          Vn  =UPV(k-1,I)  *(1.-EntExp) + V(k-1)*EntExp<a name='4660'>
          QKEn=UPQKE(k-1,I)*(1.-EntExp) + QKE(k-1)*EntExp<a name='4661'>
<a name='4662'>
          <font color=#447700>! Exponential Entrainment:<a name='4663'></font>
          <font color=#447700>!EntExp= exp(-ENT(K,I)*(ZW(k)-ZW(k-1)))<a name='4664'></font>
          <font color=#447700>!QTn =QT(K) *(1-EntExp)+UPQT(K-1,I)*EntExp<a name='4665'></font>
          <font color=#447700>!THLn=THL(K)*(1-EntExp)+UPTHL(K-1,I)*EntExp<a name='4666'></font>
          <font color=#447700>!Un  =U(K)  *(1-EntExp)+UPU(K-1,I)*EntExp<a name='4667'></font>
          <font color=#447700>!Vn  =V(K)  *(1-EntExp)+UPV(K-1,I)*EntExp<a name='4668'></font>
          <font color=#447700>!QKEn=QKE(k)*(1-EntExp)+UPQKE(K-1,I)*EntExp<a name='4669'></font>
<a name='4670'>
#if (WRF_CHEM == 1)<a name='4671'>
          do ic = 1,nchem<a name='4672'>
             <font color=#447700>! Exponential Entrainment:<a name='4673'></font>
             <font color=#447700>!chemn(ic) = chem(k,ic)*(1-EntExp)+UPCHEM(K-1,I,ic)*EntExp<a name='4674'></font>
             <font color=#447700>! Linear entrainment:<a name='4675'></font>
             chemn(ic)=UPCHEM(k-1,I,ic)*(1.-EntExp) + chem(k-1,ic)*EntExp<a name='4676'>
         enddo<a name='4677'>
#endif<a name='4678'>
<a name='4679'>
          <font color=#447700>! get thvn,qcn<a name='4680'></font>
          call <A href='../../html_code/phys/module_bl_mynn.F.html#CONDENSATION_EDMF'>condensation_edmf</A><A href='../../html_code/phys/module_bl_mynn.F.html#STEM_MF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDENSATION_EDMF_1">(QTn,THLn,(P(K)+P(K-1))/2.,ZW(k),THVn,QCn)<a name='4681'>
<a name='4682'>
          B=g*(0.5*(THVn+UPTHV(k-1,I))/THV(k-1) - 1.0)<a name='4683'>
<a name='4684'>
          EntW=exp(-2.*(Wb+Wc*ENT(K,I))*(ZW(k)-ZW(k-1)))<a name='4685'>
          Wn2=UPW(K-1,I)**2*EntW + (1.-EntW)*0.5*Wa*B/(Wb+Wc*ENT(K,I))<a name='4686'>
          Wn2=MAX(Wn2,0.0)<a name='4687'>
<a name='4688'>
          <font color=#447700>!Allow strongly forced plumes to overshoot if KE is sufficient<a name='4689'></font>
          IF (fltv &gt; 0.05 .AND. Wn2 &lt;= 0 .AND. overshoot == 0) THEN<a name='4690'>
             overshoot = 1<a name='4691'>
             IF ( THV(k)-THV(k-1) .GT. 0.0 ) THEN<a name='4692'>
                bvf = SQRT( gtr*(THV(k)-THV(k-1))/(0.5*(dz(k)+dz(k-1))) )<a name='4693'>
                <font color=#447700>!vertical Froude number<a name='4694'></font>
                Frz = UPW(K-1,I)/(bvf*0.5*(dz(k)+dz(k-1)))<a name='4695'>
                IF ( Frz &gt;= 0.5 ) Wn2 =  MIN(Frz,1.0)*(UPW(K-1,I)**2) <a name='4696'>
             ENDIF<a name='4697'>
          ELSEIF (fltv &gt; 0.05 .AND. overshoot == 1) THEN<a name='4698'>
             <font color=#447700>!Do not let overshooting parcel go more than 1 layer up<a name='4699'></font>
             Wn2 = 0.0<a name='4700'>
          ENDIF<a name='4701'>
<a name='4702'>
          <font color=#447700>!Limit very tall plumes<a name='4703'></font>
          Wn2=Wn2*EXP(-MAX(ZW(k)-(pblh+1500.),0.0)/1000.)<a name='4704'>
          IF(ZW(k) &gt;= pblh+3000.)Wn2=0.<a name='4705'>
 <a name='4706'>
          <font color=#447700>!JOE- minimize the plume penetratration in stratocu-topped PBL<a name='4707'></font>
          IF (fltv &lt; 0.06) THEN<a name='4708'>
             IF(ZW(k) &gt;= pblh-200. .AND. qc(k) &gt; 1e-5 .AND. I &gt; 2) Wn2=0.<a name='4709'>
          ENDIF<a name='4710'>
<a name='4711'>
          IF (Wn2 &gt; 0.) THEN<a name='4712'>
             UPW(K,I)=sqrt(Wn2)<a name='4713'>
             UPTHV(K,I)=THVn<a name='4714'>
             UPTHL(K,I)=THLn<a name='4715'>
             UPQT(K,I)=QTn<a name='4716'>
             UPQC(K,I)=QCn<a name='4717'>
             UPU(K,I)=Un<a name='4718'>
             UPV(K,I)=Vn<a name='4719'>
             UPQKE(K,I)=QKEn<a name='4720'>
             UPA(K,I)=UPA(K-1,I)<a name='4721'>
#if (WRF_CHEM == 1)<a name='4722'>
             do ic = 1,nchem<a name='4723'>
                UPCHEM(k,I,ic) = chemn(ic)<a name='4724'>
             enddo<a name='4725'>
#endif<a name='4726'>
             ktop = MAX(ktop,k)<a name='4727'>
          ELSE<a name='4728'>
             exit<a name='4729'>
          END IF<a name='4730'>
       ENDDO<a name='4731'>
    ENDDO<a name='4732'>
  ELSE<a name='4733'>
    <font color=#447700>!At least one of the conditions was not met for activating the MF scheme.<a name='4734'></font>
    NUP2=0. <a name='4735'>
  END IF <font color=#447700>!end criteria for mass-flux scheme<a name='4736'></font>
<a name='4737'>
  ktop=MIN(ktop,KTE-1)  <font color=#447700>!  Just to be safe...<a name='4738'></font>
<font color=#447700>!        <a name='4739'></font>
<font color=#447700>!  get updraft properties, for saving<a name='4740'></font>
<font color=#447700>!<a name='4741'></font>
  IF(nup2 &gt; 0) THEN<a name='4742'>
<a name='4743'>
    DO k=KTS,ktop <font color=#447700>!KTE-1<a name='4744'></font>
      DO I=1,NUP2<a name='4745'>
        edmf_a(K)=edmf_a(K)+UPA(K+1,I)<a name='4746'>
        edmf_w(K)=edmf_w(K)+UPA(K+1,I)*UPW(K+1,I)<a name='4747'>
        edmf_qt(K)=edmf_qt(K)+UPA(K+1,I)*UPQT(K+1,I)<a name='4748'>
        edmf_thl(K)=edmf_thl(K)+UPA(K+1,I)*UPTHL(K+1,I)<a name='4749'>
        edmf_ent(K)=edmf_ent(K)+UPA(K+1,I)*ENT(K+1,I)<a name='4750'>
        edmf_qc(K)=edmf_qc(K)+UPA(K+1,I)*UPQC(K+1,I)<a name='4751'>
#if (WRF_CHEM == 1)<a name='4752'>
        do ic = 1,nchem<a name='4753'>
          edmf_chem(k,ic) = edmf_chem(k,ic) + UPA(K+1,I)*UPCHEM(k,I,ic)<a name='4754'>
        enddo<a name='4755'>
#endif<a name='4756'>
      ENDDO <a name='4757'>
<a name='4758'>
      IF (edmf_a(k)&gt;0.) THEN<a name='4759'>
        edmf_w(k)=edmf_w(k)/edmf_a(k)<a name='4760'>
        edmf_qt(k)=edmf_qt(k)/edmf_a(k)<a name='4761'>
        edmf_thl(k)=edmf_thl(k)/edmf_a(k)<a name='4762'>
        edmf_ent(k)=edmf_ent(k)/edmf_a(k)<a name='4763'>
        edmf_qc(k)=edmf_qc(k)/edmf_a(k)<a name='4764'>
#if (WRF_CHEM == 1)<a name='4765'>
        do ic = 1,nchem<a name='4766'>
          edmf_chem(k,ic) = edmf_chem(k,ic)/edmf_a(k)<a name='4767'>
        enddo<a name='4768'>
#endif<a name='4769'>
        edmf_a(k)=edmf_a(k)*Psig_w<a name='4770'>
<a name='4771'>
        <font color=#447700>!FIND MAXIMUM MASS-FLUX IN THE COLUMN:<a name='4772'></font>
        IF(edmf_a(k)*edmf_w(k) &gt; maxmf) maxmf = edmf_a(k)*edmf_w(k)<a name='4773'>
      ENDIF<a name='4774'>
    ENDDO<a name='4775'>
<a name='4776'>
    DO k=KTS,ktop <font color=#447700>!KTE<a name='4777'></font>
      DO I=1,NUP2<a name='4778'>
        s_aw(k)   = s_aw(K)    + UPA(K,I)*UPW(K,I)*Psig_w * (1.0+rstoch_col(k))<a name='4779'>
        s_awthl(k)= s_awthl(K) + UPA(K,i)*UPW(K,I)*UPTHL(K,I)*Psig_w * (1.0+rstoch_col(k))<a name='4780'>
        s_awqt(k) = s_awqt(K)  + UPA(K,i)*UPW(K,I)*UPQT(K,I)*Psig_w * (1.0+rstoch_col(k))<a name='4781'>
        s_awqc(k) = s_awqc(K)  + UPA(K,i)*UPW(K,I)*UPQC(K,I)*Psig_w * (1.0+rstoch_col(k))<a name='4782'>
        IF (momentum_opt &gt; 0) THEN<a name='4783'>
          s_awu(k)  = s_awu(K)   + UPA(K,i)*UPW(K,I)*UPU(K,I)*Psig_w * (1.0+rstoch_col(k))<a name='4784'>
          s_awv(k)  = s_awv(K)   + UPA(K,i)*UPW(K,I)*UPV(K,I)*Psig_w * (1.0+rstoch_col(k))<a name='4785'>
        ENDIF<a name='4786'>
        IF (tke_opt &gt; 0) THEN<a name='4787'>
          s_awqke(k)= s_awqke(K) + UPA(K,i)*UPW(K,I)*UPQKE(K,I)*Psig_w * (1.0+rstoch_col(k))<a name='4788'>
        ENDIF<a name='4789'>
#if (WRF_CHEM == 1)<a name='4790'>
        do ic = 1,nchem<a name='4791'>
          s_awchem(k,ic) = s_awchem(k,ic) + UPA(K,i)*UPW(K,I)*UPCHEM(K,I,ic)*Psig_w * (1.0+rstoch_col(k))<a name='4792'>
        enddo<a name='4793'>
#endif<a name='4794'>
      ENDDO<a name='4795'>
      s_awqv(k) = s_awqt(k)  - s_awqc(k)<a name='4796'>
    ENDDO<a name='4797'>
<a name='4798'>
<font color=#447700>!JOE: ADD CLDFRA_bl1d, qc_bl1d. Note that they have already been defined in<a name='4799'></font>
<font color=#447700>!     mym_condensation. Here, a shallow-cu component is added.  <a name='4800'></font>
     DO K=KTS,ktop <font color=#447700>!KTE<a name='4801'></font>
<a name='4802'>
       IF (cldfra_opt == 0) THEN<a name='4803'>
         IF(edmf_qc(k)&gt;0.0)THEN<a name='4804'>
            satvp = 3.80*exp(17.27*(th(k)-273.)/ &amp;<a name='4805'>
                   (th(k)-36.))/(.01*p(k))<a name='4806'>
            rhgrid = max(.01,MIN( 1., qv(k) /satvp))<a name='4807'>
<a name='4808'>
            <font color=#447700>!COMPUTE CLDFRA &amp; QC_BL FROM MASS-FLUX SCHEME and recompute vt &amp; vq<a name='4809'></font>
<a name='4810'>
            xl = <A href='../../html_code/phys/module_bl_mynn.F.html#XL_BLEND'>xl_blend</A><A href='../../html_code/phys/module_bl_mynn.F.html#STEM_MF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="XL_BLEND_3">(tk(k))                <font color=#447700>! obtain blended heat capacity <a name='4811'></font>
            tlk = thl(k)*(p(k)/p1000mb)**rcp    <font color=#447700>! recover liquid temp (tl) from thl<a name='4812'></font>
            qsat_tl = <A href='../../html_code/phys/module_bl_mynn.F.html#QSAT_BLEND'>qsat_blend</A><A href='../../html_code/phys/module_bl_mynn.F.html#STEM_MF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_BLEND_2">(tlk,p(k))      <font color=#447700>! get saturation water vapor mixing ratio<a name='4813'></font>
                                                <font color=#447700>!   at tl and p<a name='4814'></font>
            rsl = xl*qsat_tl / (r_v*tlk**2)     <font color=#447700>! slope of C-C curve at t = tl<a name='4815'></font>
                                                <font color=#447700>! CB02, Eqn. 4<a name='4816'></font>
            cpm = cp + qt(k)*cpv                <font color=#447700>! CB02, sec. 2, para. 1<a name='4817'></font>
            a   = 1./(1. + xl*rsl/cpm)          <font color=#447700>! CB02 variable "a"<a name='4818'></font>
            b9  = a*rsl                         <font color=#447700>! CB02 variable "b" <a name='4819'></font>
<a name='4820'>
            q2p  = xlvcp/exner(k)<a name='4821'>
            pt = thl(k) +q2p*edmf_qc(k) <font color=#447700>! potential temp<a name='4822'></font>
            bb = b9*tk(k)/pt <font color=#447700>! bb is "b9" in BCMT95.  Their "b9" differs from<a name='4823'></font>
                           <font color=#447700>! "b9" in CB02 by a factor<a name='4824'></font>
                           <font color=#447700>! of T/theta.  Strictly, b9 above is formulated in<a name='4825'></font>
                           <font color=#447700>! terms of sat. mixing ratio, but bb in BCMT95 is<a name='4826'></font>
                           <font color=#447700>! cast in terms of sat. specific humidity.  The<a name='4827'></font>
                           <font color=#447700>! conversion is neglected here.<a name='4828'></font>
            qww   = 1.+0.61*qt(k)<a name='4829'>
            alpha = 0.61*pt<a name='4830'>
            t     = th(k)*exner(k)<a name='4831'>
            beta  = pt*xl/(t*cp) - 1.61*pt<a name='4832'>
            <font color=#447700>!Buoyancy flux terms have been moved to the end of this section...<a name='4833'></font>
<a name='4834'>
            <font color=#447700>!Now calculate convective component of the cloud fraction:<a name='4835'></font>
            if (a &gt; 0.0) then<a name='4836'>
               f = MIN(1.0/a, 4.0)              <font color=#447700>! f is vertical profile scaling function (CB2005)<a name='4837'></font>
            else<a name='4838'>
               f = 1.0<a name='4839'>
            endif<a name='4840'>
            sigq = 6.E-3 * edmf_a(k) * edmf_w(k) * f <font color=#447700>! convective component of sigma (CB2005)<a name='4841'></font>
            <font color=#447700>!sigq = MAX(sigq, 1.0E-4)         <a name='4842'></font>
            sigq = SQRT(sigq**2 + sgm(k)**2)    <font color=#447700>! combined conv + stratus components<a name='4843'></font>
<a name='4844'>
            qmq = a * (qt(k) - qsat_tl)         <font color=#447700>! saturation deficit/excess;<a name='4845'></font>
                                                <font color=#447700>!   the numerator of Q1<a name='4846'></font>
            mf_cf = min(max(0.5 + 0.36 * atan(1.55*(qmq/sigq)),0.01),1.0)<a name='4847'>
            <font color=#447700>!IF ( wrf_at_debug_level(MYNN_DBG_LVL) ) THEN<a name='4848'></font>
            <font color=#447700>!   print*,"In MYNN, StEM edmf"<a name='4849'></font>
            <font color=#447700>!   print*,"  CB: qt=",qt(k)," qsat=",qsat_tl," satdef=",qt(k) - qsat_tl<a name='4850'></font>
            <font color=#447700>!   print*,"  CB: sigq=",sigq," qmq=",qmq," tlk=",tlk<a name='4851'></font>
            <font color=#447700>!   print*,"  CB: mf_cf=",mf_cf," cldfra_bl=",cldfra_bl1d(k)," edmf_a=",edmf_a(k)<a name='4852'></font>
            <font color=#447700>!ENDIF<a name='4853'></font>
            IF (rhgrid &gt;= .93) THEN<a name='4854'>
               <font color=#447700>!IN high RH, defer to stratus component if &gt; convective component<a name='4855'></font>
               cldfra_bl1d(k) = MAX(mf_cf, cldfra_bl1d(k))<a name='4856'>
               IF (cldfra_bl1d(k) &gt; edmf_a(k)) THEN<a name='4857'>
                  qc_bl1d(k) = edmf_qc(k)*edmf_a(k)/cldfra_bl1d(k)<a name='4858'>
               ELSE<a name='4859'>
                 cldfra_bl1d(k)=edmf_a(k)<a name='4860'>
                 qc_bl1d(k) = edmf_qc(k)<a name='4861'>
               ENDIF<a name='4862'>
            ELSE<a name='4863'>
               IF (mf_cf &gt; edmf_a(k)) THEN<a name='4864'>
                  cldfra_bl1d(k) = mf_cf<a name='4865'>
                  qc_bl1d(k) = edmf_qc(k)*edmf_a(k)/mf_cf<a name='4866'>
               ELSE<a name='4867'>
                  cldfra_bl1d(k)=edmf_a(k)<a name='4868'>
                  qc_bl1d(k) = edmf_qc(k)<a name='4869'>
               ENDIF<a name='4870'>
            ENDIF<a name='4871'>
            <font color=#447700>!Now recalculate the terms for the buoyancy flux for mass-flux clouds:<a name='4872'></font>
            <font color=#447700>!See mym_condensation for details on these formulations.  The<a name='4873'></font>
            <font color=#447700>!cloud-fraction bounding was added to improve cloud retention,<a name='4874'></font>
            <font color=#447700>!following RAP and HRRR testing.<a name='4875'></font>
              Fng = 2.05 <font color=#447700>! the non-Gaussian transport factor (assumed constant)<a name='4876'></font>
            vt(k) = qww   - MIN(0.3,cldfra_bl1D(k))*beta*bb*Fng - 1.<a name='4877'>
            vq(k) = alpha + MIN(0.3,cldfra_bl1D(k))*beta*a*Fng  - tv0<a name='4878'>
          ENDIF<a name='4879'>
        ELSEIF(cldfra_opt == 1) THEN<a name='4880'>
          <font color=#447700>!Randall and Xu<a name='4881'></font>
          qc_bl1d(k) = MAX(qc_bl1d(k), edmf_qc(k))<a name='4882'>
          if(F_qc .and. .not. F_qi)then<a name='4883'>
            satvp = 3.80*exp(17.27*(th(k)-273.)/ &amp;<a name='4884'>
                   (th(k)-36.))/(.01*p(k))<a name='4885'>
            rhgrid = max(.1,MIN( .95, qv(k) /satvp))<a name='4886'>
            h2oliq=1000.*qc_bl1d(k)<a name='4887'>
            satvp=1000.*satvp<a name='4888'>
            cldfra_bl1d(k)=(1.-exp(-coef_alph*h2oliq/&amp;<a name='4889'>
                   ((1.-rhgrid)*satvp)**coef_gamm))*(rhgrid**coef_p)<a name='4890'>
            cldfra_bl1d(k)=max(0.0,MIN(1.,cldfra_bl1d(k)))<a name='4891'>
          elseif(F_qc .and. F_qi)then<a name='4892'>
            satvp = 3.80*exp(17.27*(th(k)-273.)/ &amp;<a name='4893'>
                   (th(k)-36.))/(.01*p(k))<a name='4894'>
            rhgrid = max(.1,MIN( .95, qv(k) /satvp))<a name='4895'>
            h2oliq=1000.*qc_bl1d(k)<a name='4896'>
            satvp=1000.*satvp<a name='4897'>
            cldfra_bl1d(k)=(1.-exp(-coef_alph*h2oliq/&amp;<a name='4898'>
                    ((1.-rhgrid)*satvp)**coef_gamm))*(rhgrid**coef_p)<a name='4899'>
            cldfra_bl1d(k)=max(0.0,MIN(1.,cldfra_bl1d(k)))<a name='4900'>
          endif<a name='4901'>
        ENDIF<a name='4902'>
      ENDDO<a name='4903'>
<a name='4904'>
    ENDIF  <font color=#447700>!end nup2 &gt; 0<a name='4905'></font>
<a name='4906'>
    <font color=#447700>!modify output (negative: dry plume, positive: moist plume)<a name='4907'></font>
    IF (ktop &gt; 0) THEN<a name='4908'>
      maxqc = maxval(edmf_qc(1:ktop)) <a name='4909'>
      IF ( maxqc &lt; 1.E-8) maxmf = -1.0*maxmf<a name='4910'>
    ENDIF<a name='4911'>
       <a name='4912'>
<font color=#447700>!       <a name='4913'></font>
<font color=#447700>! debugging   <a name='4914'></font>
<font color=#447700>!<a name='4915'></font>
IF (edmf_w(1) &gt; 4.0) THEN <a name='4916'>
<font color=#447700>! surface values<a name='4917'></font>
    print *,'flq:',flq,' fltv:',fltv<a name='4918'>
    print *,'pblh:',pblh,' wstar:',wstar<a name='4919'>
    print *,'sigmaW=',sigmaW,' sigmaTH=',sigmaTH,' sigmaQT=',sigmaQT<a name='4920'>
<font color=#447700>! means<a name='4921'></font>
<font color=#447700>!   print *,'u:',u<a name='4922'></font>
<font color=#447700>!   print *,'v:',v  <a name='4923'></font>
<font color=#447700>!   print *,'thl:',thl<a name='4924'></font>
<font color=#447700>!   print *,'thv:',thv<a name='4925'></font>
<font color=#447700>!   print *,'qt:',qt<a name='4926'></font>
<font color=#447700>!   print *,'p:',p<a name='4927'></font>
 <a name='4928'>
<font color=#447700>! updrafts<a name='4929'></font>
<font color=#447700>! DO I=1,NUP   <a name='4930'></font>
<font color=#447700>!   print *,'up:A',i<a name='4931'></font>
<font color=#447700>!   print *,UPA(:,i)<a name='4932'></font>
<font color=#447700>!   print *,'up:W',i<a name='4933'></font>
<font color=#447700>!   print*,UPW(:,i)<a name='4934'></font>
<font color=#447700>!   print *,'up:thv',i<a name='4935'></font>
<font color=#447700>!   print *,UPTHV(:,i)<a name='4936'></font>
<font color=#447700>!   print *,'up:thl',i <a name='4937'></font>
<font color=#447700>!   print *,UPTHL(:,i)<a name='4938'></font>
<font color=#447700>!   print *,'up:qt',i<a name='4939'></font>
<font color=#447700>!   print *,UPQT(:,i)<a name='4940'></font>
<font color=#447700>!   print *,'up:tQC',i<a name='4941'></font>
<font color=#447700>!   print *,UPQC(:,i)<a name='4942'></font>
<font color=#447700>!   print *,'up:ent',i<a name='4943'></font>
<font color=#447700>!   print *,ENT(:,i)   <a name='4944'></font>
<font color=#447700>! ENDDO<a name='4945'></font>
 <a name='4946'>
<font color=#447700>! mean updrafts<a name='4947'></font>
   print *,' edmf_a',edmf_a(1:14)<a name='4948'>
   print *,' edmf_w',edmf_w(1:14)<a name='4949'>
   print *,' edmf_qt:',edmf_qt(1:14)<a name='4950'>
   print *,' edmf_thl:',edmf_thl(1:14)<a name='4951'>
 <a name='4952'>
ENDIF <font color=#447700>!END Debugging<a name='4953'></font>
<a name='4954'>
<font color=#447700>! initialization of deltas<a name='4955'></font>
<font color=#447700>!  DO k=kts,kte <a name='4956'></font>
<font color=#447700>!    dth(k)=0.<a name='4957'></font>
<font color=#447700>!    dqv(k)=0.<a name='4958'></font>
<font color=#447700>!    dqc(k)=0.<a name='4959'></font>
<font color=#447700>!    du(k)=0.<a name='4960'></font>
<font color=#447700>!    dv(k)=0.<a name='4961'></font>
<font color=#447700>!  ENDDO        <a name='4962'></font>
<a name='4963'>
END SUBROUTINE StEM_MF<a name='4964'>
<font color=#447700>!=================================================================<a name='4965'></font>
<A NAME='POISSON'><A href='../../html_code/phys/module_bl_mynn.F.html#POISSON' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4966'>
<font color=#993300>subroutine </font><font color=#cc0000>Poisson</font>(istart,iend,jstart,jend,mu,POI),<A href='../../call_from/POISSON.html' TARGET='index'>1</A><a name='4967'>
<a name='4968'>
  integer, intent(in) :: istart,iend,jstart,jend <a name='4969'>
  real,dimension(istart:iend,jstart:jend),intent(in) :: MU<a name='4970'>
  integer, dimension(istart:iend,jstart:jend), intent(out) :: POI<a name='4971'>
  integer :: i,j<a name='4972'>
  <font color=#447700>!<a name='4973'></font>
  <font color=#447700>! do this only once<a name='4974'></font>
  <font color=#447700>! call init_random_seed<a name='4975'></font>
<a name='4976'>
  do i=istart,iend<a name='4977'>
    do j=jstart,jend<a name='4978'>
      call   <A href='../../html_code/phys/module_bl_mynn.F.html#RANDOM_POISSON'>random_Poisson</A><A href='../../html_code/phys/module_bl_mynn.F.html#POISSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RANDOM_POISSON_1">(mu(i,j),.true.,POI(i,j))<a name='4979'>
    enddo<a name='4980'>
  enddo<a name='4981'>
<a name='4982'>
end subroutine Poisson<a name='4983'>
<font color=#447700>!=================================================================  <a name='4984'></font>
<A NAME='INIT_RANDOM_SEED'><A href='../../html_code/phys/module_bl_mynn.F.html#INIT_RANDOM_SEED' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4985'>
<font color=#993300>subroutine </font><font color=#cc0000>init_random_seed</font>() <A href='../../call_to/INIT_RANDOM_SEED.html' TARGET='index'>1</A>,<A href='../../call_from/INIT_RANDOM_SEED.html' TARGET='index'>1</A><a name='4986'>
   <font color=#447700>!JOE: PGI had problem! use iso_fortran_env, only: int64<a name='4987'></font>
   <font color=#447700>!JOE: PGI had problem! use ifport, only: getpid <a name='4988'></font>
   implicit none<a name='4989'>
   integer, allocatable :: seed(:)<a name='4990'>
   integer :: i, n, un, istat, dt(8), pid<a name='4991'>
   <font color=#447700>!JOE: PGI had problem! integer(int64) :: t<a name='4992'></font>
   integer :: t<a name='4993'>
<a name='4994'>
   call random_seed(size = n)<a name='4995'>
   allocate(seed(n))<a name='4996'>
<a name='4997'>
   <font color=#447700>! First try if the OS provides a random number generator<a name='4998'></font>
   <font color=#447700>!JOE: PGI had problem! open(newunit=un, file="/dev/urandom", access="stream", &amp;<a name='4999'></font>
   un=191<a name='5000'>
   open(unit=un, file="/dev/urandom", access="stream", &amp;<a name='5001'>
   form="unformatted", action="read", status="old", iostat=istat)<a name='5002'>
<a name='5003'>
   if (istat == 0) then<a name='5004'>
      read(un) seed<a name='5005'>
      close(un)<a name='5006'>
   else<a name='5007'>
      <font color=#447700>! Fallback to XOR:ing the current time and pid. The PID is<a name='5008'></font>
      <font color=#447700>! useful in case one launches multiple instances of the same<a name='5009'></font>
      <font color=#447700>! program in parallel.<a name='5010'></font>
      call system_clock(t)<a name='5011'>
      if (t == 0) then<a name='5012'>
         call date_and_time(values=dt)<a name='5013'>
         <font color=#447700>!t = (dt(1) - 1970) * 365_int64 * 24 * 60 * 60 * 1000 &amp;<a name='5014'></font>
         <font color=#447700>!   + dt(2) * 31_int64 * 24 * 60 * 60 * 1000 &amp;<a name='5015'></font>
         <font color=#447700>!   + dt(3) * 24_int64 * 60 * 60 * 1000 &amp;<a name='5016'></font>
         <font color=#447700>!   + dt(5) * 60 * 60 * 1000 &amp;<a name='5017'></font>
         <font color=#447700>!   + dt(6) * 60 * 1000 + dt(7) * 1000 &amp;<a name='5018'></font>
         <font color=#447700>!   + dt(8)<a name='5019'></font>
         t = dt(6) * 60 &amp;  <font color=#447700>! only return seconds for smaller t<a name='5020'></font>
           + dt(7)<a name='5021'>
      end if<a name='5022'>
<a name='5023'>
      <font color=#447700>!JOE: PGI had problem!pid = getpid()<a name='5024'></font>
      <font color=#447700>! for distributed memory jobs we need to fix this<a name='5025'></font>
      <font color=#447700>!pid=1<a name='5026'></font>
      pid = 666 + MOD(t,10)  <font color=#447700>!JOE: doesn't work for PG compilers: getpid()<a name='5027'></font>
 <a name='5028'>
      t = ieor(t, int(pid, kind(t)))<a name='5029'>
      do i = 1, n<a name='5030'>
         seed(i) = <A href='../../html_code/phys/module_bl_mynn.F.html#LCG'>lcg</A><A href='../../html_code/phys/module_cu_osas.F.html#INIT_RANDOM_SEED' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LCG_1">(t)<a name='5031'>
      end do<a name='5032'>
   end if<a name='5033'>
   call random_seed(put=seed)<a name='5034'>
<a name='5035'>
  contains<a name='5036'>
<a name='5037'>
  <font color=#447700>! Pseudo-random number generator (PRNG) <a name='5038'></font>
  <font color=#447700>! This simple PRNG might not be good enough for real work, but is<a name='5039'></font>
  <font color=#447700>! sufficient for seeding a better PRNG.<a name='5040'></font>
<A NAME='LCG'><A href='../../html_code/phys/module_bl_mynn.F.html#LCG' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='5041'>
  <font color=#993300>function </font><font color=#cc0000>lcg</font>(s) <A href='../../call_to/LCG.html' TARGET='index'>1</A><a name='5042'>
<a name='5043'>
   integer :: lcg<a name='5044'>
   <font color=#447700>!JOE: PGI had problem! integer(int64) :: s<a name='5045'></font>
   integer :: s<a name='5046'>
<a name='5047'>
   if (s == 0) then<a name='5048'>
      <font color=#447700>!s = 104729<a name='5049'></font>
      s = 1047<a name='5050'>
   else<a name='5051'>
      <font color=#447700>!s = mod(s, 4294967296_int64)<a name='5052'></font>
      s = mod(s, 71)<a name='5053'>
   end if<a name='5054'>
   <font color=#447700>!s = mod(s * 279470273_int64, 4294967291_int64)<a name='5055'></font>
   s = mod(s * 23, 17)<a name='5056'>
   <font color=#447700>!lcg = int(mod(s, int(huge(0), int64)), kind(0))<a name='5057'></font>
   lcg = int(mod(s, int(s/3.5)))<a name='5058'>
<a name='5059'>
  end function lcg<a name='5060'>
<a name='5061'>
  end subroutine init_random_seed<a name='5062'>
<a name='5063'>
<a name='5064'>
<A NAME='RANDOM_POISSON'><A href='../../html_code/phys/module_bl_mynn.F.html#RANDOM_POISSON' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5065'>
<font color=#993300>subroutine </font><font color=#cc0000>random_Poisson</font>(mu,first,ival)  <A href='../../call_to/RANDOM_POISSON.html' TARGET='index'>1</A>,<A href='../../call_from/RANDOM_POISSON.html' TARGET='index'>1</A><a name='5066'>
<font color=#447700>!**********************************************************************<a name='5067'></font>
<font color=#447700>!     Translated to Fortran 90 by Alan Miller from:  RANLIB<a name='5068'></font>
<font color=#447700>!<a name='5069'></font>
<font color=#447700>!     Library of Fortran Routines for Random Number Generation<a name='5070'></font>
<font color=#447700>!<a name='5071'></font>
<font color=#447700>!                    Compiled and Written by:<a name='5072'></font>
<font color=#447700>!<a name='5073'></font>
<font color=#447700>!                         Barry W. Brown<a name='5074'></font>
<font color=#447700>!                          James Lovato<a name='5075'></font>
<font color=#447700>!<a name='5076'></font>
<font color=#447700>!             Department of Biomathematics, Box 237<a name='5077'></font>
<font color=#447700>!             The University of Texas, M.D. Anderson Cancer Center<a name='5078'></font>
<font color=#447700>!             1515 Holcombe Boulevard<a name='5079'></font>
<font color=#447700>!             Houston, TX      77030<a name='5080'></font>
<font color=#447700>!<a name='5081'></font>
<font color=#447700>! Generates a single random deviate from a Poisson distribution with mean mu.<a name='5082'></font>
<font color=#447700>! Scalar Arguments:<a name='5083'></font>
	REAL, INTENT(IN)    :: mu  <font color=#447700>!The mean of the Poisson distribution from which<a name='5084'></font>
                                   <font color=#447700>!a random deviate is to be generated.<a name='5085'></font>
	LOGICAL, INTENT(IN) :: first<a name='5086'>
        INTEGER             :: ival<a name='5087'>
<a name='5088'>
<font color=#447700>!     TABLES: COEFFICIENTS A0-A7 FOR STEP F. FACTORIALS FACT<a name='5089'></font>
<font color=#447700>!     COEFFICIENTS A(K) - FOR PX = FK*V*V*SUM(A(K)*V**K)-DEL<a name='5090'></font>
<font color=#447700>!     SEPARATION OF CASES A AND B<a name='5091'></font>
<font color=#447700>!<a name='5092'></font>
<font color=#447700>!     .. Local Scalars ..<a name='5093'></font>
<font color=#447700>!JOE: since many of these scalars conflict with globally declared closure constants (above),<a name='5094'></font>
<font color=#447700>!     need to change XX to XX_s<a name='5095'></font>
<font color=#447700>!	REAL          :: b1, b2, c, c0, c1, c2, c3, del, difmuk, e, fk, fx, fy, g,  &amp;<a name='5096'></font>
<font color=#447700>!                    omega, px, py, t, u, v, x, xx<a name='5097'></font>
	REAL          :: b1_s, b2_s, c, c0, c1_s, c2_s, c3_s, del, difmuk, e, fk, fx, fy, g_s,  &amp;<a name='5098'>
                    omega, px, py, t, u, v, x, xx<a name='5099'>
	REAL, SAVE    :: s, d, p, q, p0<a name='5100'>
        INTEGER       :: j, k, kflag<a name='5101'>
	LOGICAL, SAVE :: full_init<a name='5102'>
        INTEGER, SAVE :: l, m<a name='5103'>
<font color=#447700>!     ..<a name='5104'></font>
<font color=#447700>!     .. Local Arrays ..<a name='5105'></font>
	REAL, SAVE    :: pp(35)<a name='5106'>
<font color=#447700>!     ..<a name='5107'></font>
<font color=#447700>!     .. Data statements ..<a name='5108'></font>
<font color=#447700>!JOE: since many of these scalars conflict with globally declared closure constants (above),<a name='5109'></font>
<font color=#447700>!     need to change XX to XX_s<a name='5110'></font>
<font color=#447700>!	REAL, PARAMETER :: a0 = -.5, a1 = .3333333, a2 = -.2500068, a3 = .2000118,  &amp;<a name='5111'></font>
	REAL, PARAMETER :: a0 = -.5, a1_s = .3333333, a2_s = -.2500068, a3 = .2000118,  &amp;<a name='5112'>
                           a4 = -.1661269, a5 = .1421878, a6 = -0.1384794,  &amp;<a name='5113'>
                           a7 = .1250060<a name='5114'>
<a name='5115'>
	REAL, PARAMETER :: fact(10) = (/ 1., 1., 2., 6., 24., 120., 720., 5040.,  &amp;<a name='5116'>
                 40320., 362880. /)<a name='5117'>
<a name='5118'>
<font color=#447700>!JOE: difmuk,fk,u errors - undefined<a name='5119'></font>
   difmuk = 0.<a name='5120'>
   fk = 1.0<a name='5121'>
   u = 0.<a name='5122'>
<a name='5123'>
<font color=#447700>!     ..<a name='5124'></font>
<font color=#447700>!     .. Executable Statements ..<a name='5125'></font>
   IF (mu &gt; 10.0) THEN<a name='5126'>
<font color=#447700>!     C A S E  A. (RECALCULATION OF S, D, L IF MU HAS CHANGED)<a name='5127'></font>
<a name='5128'>
      IF (first) THEN<a name='5129'>
         s = SQRT(mu)<a name='5130'>
         d = 6.0*mu*mu<a name='5131'>
<a name='5132'>
<font color=#447700>!             THE POISSON PROBABILITIES PK EXCEED THE DISCRETE NORMAL<a name='5133'></font>
<font color=#447700>!             PROBABILITIES FK WHENEVER K &gt;= M(MU). L=IFIX(MU-1.1484)<a name='5134'></font>
<font color=#447700>!             IS AN UPPER BOUND TO M(MU) FOR ALL MU &gt;= 10 .<a name='5135'></font>
<a name='5136'>
         l = mu - 1.1484<a name='5137'>
         full_init = .false.<a name='5138'>
      END IF<a name='5139'>
<a name='5140'>
<font color=#447700>!     STEP N. NORMAL SAMPLE - random_normal() FOR STANDARD NORMAL DEVIATE<a name='5141'></font>
      g_s = mu + s*random_normal()<a name='5142'>
      IF (g_s &gt; 0.0) THEN<a name='5143'>
         ival = g_s<a name='5144'>
<a name='5145'>
 	 <font color=#447700>!     STEP I. IMMEDIATE ACCEPTANCE IF ival IS LARGE ENOUGH<a name='5146'></font>
         IF (ival&gt;=l) RETURN<a name='5147'>
<a name='5148'>
	 <font color=#447700>!     STEP S. SQUEEZE ACCEPTANCE - SAMPLE U<a name='5149'></font>
		fk = ival<a name='5150'>
		difmuk = mu - fk<a name='5151'>
		CALL RANDOM_NUMBER(u)<a name='5152'>
		IF (d*u &gt;= difmuk*difmuk*difmuk) RETURN<a name='5153'>
      END IF<a name='5154'>
<a name='5155'>
      <font color=#447700>!     STEP P. PREPARATIONS FOR STEPS Q AND H.<a name='5156'></font>
      <font color=#447700>!             (RECALCULATIONS OF PARAMETERS IF NECESSARY)<a name='5157'></font>
      <font color=#447700>!             .3989423=(2*PI)**(-.5)  .416667E-1=1./24.  .1428571=1./7.<a name='5158'></font>
      <font color=#447700>!             THE QUANTITIES B1_S, B2_S, C3_S, C2_S, C1_S, C0 ARE FOR THE HERMITE<a name='5159'></font>
      <font color=#447700>!             APPROXIMATIONS TO THE DISCRETE NORMAL PROBABILITIES FK.<a name='5160'></font>
      <font color=#447700>!             C=.1069/MU GUARANTEES MAJORIZATION BY THE 'HAT'-FUNCTION.<a name='5161'></font>
<a name='5162'>
      IF (.NOT. full_init) THEN<a name='5163'>
         omega = .3989423/s<a name='5164'>
		b1_s = .4166667E-1/mu<a name='5165'>
		b2_s = .3*b1_s*b1_s<a name='5166'>
		c3_s = .1428571*b1_s*b2_s<a name='5167'>
		c2_s = b2_s - 15.*c3_s<a name='5168'>
		c1_s = b1_s - 6.*b2_s + 45.*c3_s<a name='5169'>
		c0 = 1. - b1_s + 3.*b2_s - 15.*c3_s<a name='5170'>
		c = .1069/mu<a name='5171'>
		full_init = .true.<a name='5172'>
      END IF<a name='5173'>
<a name='5174'>
	  IF (g_s &lt; 0.0) GO TO 50<a name='5175'>
<a name='5176'>
	<font color=#447700>!             'SUBROUTINE' F IS CALLED (KFLAG=0 FOR CORRECT RETURN)<a name='5177'></font>
<a name='5178'>
	  kflag = 0<a name='5179'>
	  GO TO 70<a name='5180'>
<a name='5181'>
	<font color=#447700>!     STEP Q. QUOTIENT ACCEPTANCE (RARE CASE)<a name='5182'></font>
<a name='5183'>
	  40 IF (fy-u*fy &lt;= py*EXP(px-fx)) RETURN<a name='5184'>
<a name='5185'>
	<font color=#447700>!     STEP E. EXPONENTIAL SAMPLE - random_exponential() FOR STANDARD EXPONENTIAL<a name='5186'></font>
	<font color=#447700>!             DEVIATE E AND SAMPLE T FROM THE LAPLACE 'HAT'<a name='5187'></font>
	<font color=#447700>!             (IF T &lt;= -.6744 THEN PK &lt; FK FOR ALL MU &gt;= 10.)<a name='5188'></font>
<a name='5189'>
	  50 e = <A href='../../html_code/phys/module_bl_mynn.F.html#RANDOM_EXPONENTIAL'>random_exponential</A><A href='../../html_code/phys/module_bl_mynn.F.html#RANDOM_POISSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RANDOM_EXPONENTIAL_1">()<a name='5190'>
	  CALL RANDOM_NUMBER(u)<a name='5191'>
	  u = u + u - one<a name='5192'>
	  t = 1.8 + SIGN(e, u)<a name='5193'>
	  IF (t &lt;= (-.6744)) GO TO 50<a name='5194'>
	  ival = mu + s*t<a name='5195'>
	  fk = ival<a name='5196'>
	  difmuk = mu - fk<a name='5197'>
<a name='5198'>
	<font color=#447700>!             'SUBROUTINE' F IS CALLED (KFLAG=1 FOR CORRECT RETURN)<a name='5199'></font>
<a name='5200'>
	  kflag = 1<a name='5201'>
	  GO TO 70<a name='5202'>
<a name='5203'>
	<font color=#447700>!     STEP H. HAT ACCEPTANCE (E IS REPEATED ON REJECTION)<a name='5204'></font>
<a name='5205'>
	  60 IF (c*ABS(u) &gt; py*EXP(px+e) - fy*EXP(fx+e)) GO TO 50<a name='5206'>
	  RETURN<a name='5207'>
<a name='5208'>
	<font color=#447700>!     STEP F. 'SUBROUTINE' F. CALCULATION OF PX, PY, FX, FY.<a name='5209'></font>
	<font color=#447700>!             CASE ival &lt; 10 USES FACTORIALS FROM TABLE FACT<a name='5210'></font>
<a name='5211'>
	  70 IF (ival&gt;=10) GO TO 80<a name='5212'>
	  px = -mu<a name='5213'>
<font color=#447700>!JOE: had error " Subscript #1 of FACT has value -858993459"; shouldn't be &lt; 1.<a name='5214'></font>
         <font color=#447700>!py = mu**ival/fact(ival+1)<a name='5215'></font>
	  py = mu**ival/fact(MAX(ival+1,1))<a name='5216'>
	  GO TO 110<a name='5217'>
<a name='5218'>
	<font color=#447700>!             CASE ival &gt;= 10 USES POLYNOMIAL APPROXIMATION<a name='5219'></font>
	<font color=#447700>!             A0-A7 FOR ACCURACY WHEN ADVISABLE<a name='5220'></font>
	<font color=#447700>!             .8333333E-1=1./12.  .3989423=(2*PI)**(-.5)<a name='5221'></font>
<a name='5222'>
	  80 del = .8333333E-1/fk<a name='5223'>
	  del = del - 4.8*del*del*del<a name='5224'>
	  v = difmuk/fk<a name='5225'>
	  IF (ABS(v)&gt;0.25) THEN<a name='5226'>
		px = fk*LOG(one + v) - difmuk - del<a name='5227'>
	  ELSE<a name='5228'>
		px = fk*v*v* (((((((a7*v+a6)*v+a5)*v+a4)*v+a3)*v+a2_s)*v+a1_s)*v+a0) - del<a name='5229'>
	  END IF<a name='5230'>
	  py = .3989423/SQRT(fk)<a name='5231'>
	  110 x = (half - difmuk)/s<a name='5232'>
	  xx = x*x<a name='5233'>
	  fx = -half*xx<a name='5234'>
	  fy = omega* (((c3_s*xx + c2_s)*xx + c1_s)*xx + c0)<a name='5235'>
	  IF (kflag &lt;= 0) GO TO 40<a name='5236'>
	  GO TO 60<a name='5237'>
<a name='5238'>
	<font color=#447700>!---------------------------------------------------------------------------<a name='5239'></font>
	<font color=#447700>!     C A S E  B.    mu &lt; 10<a name='5240'></font>
	<font color=#447700>!     START NEW TABLE AND CALCULATE P0 IF NECESSARY<a name='5241'></font>
      ELSE<a name='5242'>
<a name='5243'>
	  IF (first) THEN<a name='5244'>
		m = MAX(1, INT(mu))<a name='5245'>
		l = 0<a name='5246'>
                <font color=#447700>!print*,"mu=",mu<a name='5247'></font>
                <font color=#447700>!print*," mu=",mu," p=",EXP(-mu)<a name='5248'></font>
		p = EXP(-mu)<a name='5249'>
		q = p<a name='5250'>
		p0 = p<a name='5251'>
	  END IF<a name='5252'>
<a name='5253'>
	<font color=#447700>!     STEP U. UNIFORM SAMPLE FOR INVERSION METHOD<a name='5254'></font>
<a name='5255'>
	  DO<a name='5256'>
		CALL RANDOM_NUMBER(u)<a name='5257'>
		ival = 0<a name='5258'>
		IF (u &lt;= p0) RETURN<a name='5259'>
<a name='5260'>
	<font color=#447700>!     STEP T. TABLE COMPARISON UNTIL THE END PP(L) OF THE<a name='5261'></font>
	<font color=#447700>!             PP-TABLE OF CUMULATIVE POISSON PROBABILITIES<a name='5262'></font>
	<font color=#447700>!             (0.458=PP(9) FOR MU=10)<a name='5263'></font>
<a name='5264'>
		IF (l == 0) GO TO 150<a name='5265'>
		j = 1<a name='5266'>
		IF (u &gt; 0.458) j = MIN(l, m)<a name='5267'>
		DO k = j, l<a name='5268'>
		  IF (u &lt;= pp(k)) GO TO 180<a name='5269'>
		END DO<a name='5270'>
		IF (l == 35) CYCLE<a name='5271'>
<a name='5272'>
	<font color=#447700>!     STEP C. CREATION OF NEW POISSON PROBABILITIES P<a name='5273'></font>
	<font color=#447700>!             AND THEIR CUMULATIVES Q=PP(K)<a name='5274'></font>
<a name='5275'>
		150 l = l + 1<a name='5276'>
		DO k = l, 35<a name='5277'>
		  p = p*mu / k<a name='5278'>
		  q = q + p<a name='5279'>
		  pp(k) = q<a name='5280'>
		  IF (u &lt;= q) GO TO 170<a name='5281'>
		END DO<a name='5282'>
		l = 35<a name='5283'>
	  END DO<a name='5284'>
<a name='5285'>
	  170 l = k<a name='5286'>
	  180 ival = k<a name='5287'>
	  RETURN<a name='5288'>
	END IF<a name='5289'>
<a name='5290'>
	RETURN<a name='5291'>
	END subroutine random_Poisson<a name='5292'>
<a name='5293'>
<font color=#447700>!==================================================================<a name='5294'></font>
<a name='5295'>
<A NAME='RANDOM_NORMAL'><A href='../../html_code/phys/module_bl_mynn.F.html#RANDOM_NORMAL' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='5296'>
	<font color=#993300>FUNCTION </font><font color=#cc0000>random_normal</font>() RESULT(fn_val)<a name='5297'>
<a name='5298'>
	<font color=#447700>! Adapted from the following Fortran 77 code<a name='5299'></font>
	<font color=#447700>!      ALGORITHM 712, COLLECTED ALGORITHMS FROM ACM.<a name='5300'></font>
	<font color=#447700>!      THIS WORK PUBLISHED IN TRANSACTIONS ON MATHEMATICAL SOFTWARE,<a name='5301'></font>
	<font color=#447700>!      VOL. 18, NO. 4, DECEMBER, 1992, PP. 434-435.<a name='5302'></font>
<a name='5303'>
	<font color=#447700>!  The function random_normal() returns a normally distributed pseudo-random<a name='5304'></font>
	<font color=#447700>!  number with zero mean and unit variance.<a name='5305'></font>
<a name='5306'>
	<font color=#447700>!  The algorithm uses the ratio of uniforms method of A.J. Kinderman<a name='5307'></font>
	<font color=#447700>!  and J.F. Monahan augmented with quadratic bounding curves.<a name='5308'></font>
<a name='5309'>
	REAL :: fn_val<a name='5310'>
<a name='5311'>
	<font color=#447700>!     Local variables<a name='5312'></font>
	REAL     :: s = 0.449871, t = -0.386595, a = 0.19600, b = 0.25472,           &amp;<a name='5313'>
				r1 = 0.27597, r2 = 0.27846, u, v, x, y, q<a name='5314'>
<a name='5315'>
	<font color=#447700>!     Generate P = (u,v) uniform in rectangle enclosing acceptance region<a name='5316'></font>
<a name='5317'>
	DO<a name='5318'>
	  CALL RANDOM_NUMBER(u)<a name='5319'>
	  CALL RANDOM_NUMBER(v)<a name='5320'>
	  v = 1.7156 * (v - half)<a name='5321'>
<a name='5322'>
	<font color=#447700>!     Evaluate the quadratic form<a name='5323'></font>
	  x = u - s<a name='5324'>
	  y = ABS(v) - t<a name='5325'>
	  q = x**2 + y*(a*y - b*x)<a name='5326'>
<a name='5327'>
	<font color=#447700>!     Accept P if inside inner ellipse<a name='5328'></font>
	  IF (q &lt; r1) EXIT<a name='5329'>
	<font color=#447700>!     Reject P if outside outer ellipse<a name='5330'></font>
	  IF (q &gt; r2) CYCLE<a name='5331'>
	<font color=#447700>!     Reject P if outside acceptance region<a name='5332'></font>
	  IF (v**2 &lt; -4.0*LOG(u)*u**2) EXIT<a name='5333'>
	END DO<a name='5334'>
<a name='5335'>
	<font color=#447700>!     Return ratio of P's coordinates as the normal deviate<a name='5336'></font>
	fn_val = v/u<a name='5337'>
	RETURN<a name='5338'>
<a name='5339'>
	END FUNCTION random_normal<a name='5340'>
<a name='5341'>
<font color=#447700>!===============================================================<a name='5342'></font>
<a name='5343'>
<A NAME='RANDOM_EXPONENTIAL'><A href='../../html_code/phys/module_bl_mynn.F.html#RANDOM_EXPONENTIAL' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='5344'>
	<font color=#993300>FUNCTION </font><font color=#cc0000>random_exponential</font>() RESULT(fn_val) <A href='../../call_to/RANDOM_EXPONENTIAL.html' TARGET='index'>1</A><a name='5345'>
<a name='5346'>
	<font color=#447700>! Adapted from Fortran 77 code from the book:<a name='5347'></font>
	<font color=#447700>!     Dagpunar, J. 'Principles of random variate generation'<a name='5348'></font>
	<font color=#447700>!     Clarendon Press, Oxford, 1988.   ISBN 0-19-852202-9<a name='5349'></font>
<a name='5350'>
	<font color=#447700>! FUNCTION GENERATES A RANDOM VARIATE IN [0,INFINITY) FROM<a name='5351'></font>
	<font color=#447700>! A NEGATIVE EXPONENTIAL DlSTRIBUTION WlTH DENSITY PROPORTIONAL<a name='5352'></font>
	<font color=#447700>! TO EXP(-random_exponential), USING INVERSION.<a name='5353'></font>
<a name='5354'>
	REAL  :: fn_val<a name='5355'>
<a name='5356'>
	<font color=#447700>!     Local variable<a name='5357'></font>
	REAL  :: r<a name='5358'>
<a name='5359'>
	DO<a name='5360'>
	  CALL RANDOM_NUMBER(r)<a name='5361'>
	  IF (r &gt; zero) EXIT<a name='5362'>
	END DO<a name='5363'>
<a name='5364'>
	fn_val = -LOG(r)<a name='5365'>
	RETURN<a name='5366'>
<a name='5367'>
	END FUNCTION random_exponential<a name='5368'>
<a name='5369'>
<font color=#447700>!===============================================================<a name='5370'></font>
<a name='5371'>
<A NAME='CONDENSATION_EDMF'><A href='../../html_code/phys/module_bl_mynn.F.html#CONDENSATION_EDMF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5372'>
<font color=#993300>subroutine </font><font color=#cc0000>condensation_edmf</font>(QT,THL,P,zagl,THV,QC) <A href='../../call_to/CONDENSATION_EDMF.html' TARGET='index'>1</A>,<A href='../../call_from/CONDENSATION_EDMF.html' TARGET='index'>2</A><a name='5373'>
<font color=#447700>!<a name='5374'></font>
<font color=#447700>! zero or one condensation for edmf: calculates THV and QC<a name='5375'></font>
<font color=#447700>!<a name='5376'></font>
real,intent(in)   :: QT,THL,P,zagl<a name='5377'>
real,intent(out)  :: THV<a name='5378'>
real,intent(inout):: QC<a name='5379'>
<a name='5380'>
integer :: niter,i<a name='5381'>
real :: diff,exn,t,th,qs,qcold<a name='5382'>
<a name='5383'>
<font color=#447700>! constants used from module_model_constants.F<a name='5384'></font>
<font color=#447700>! p1000mb<a name='5385'></font>
<font color=#447700>! rcp ... Rd/cp<a name='5386'></font>
<font color=#447700>! xlv ... latent heat for water (2.5e6)<a name='5387'></font>
<font color=#447700>! cp<a name='5388'></font>
<font color=#447700>! rvord .. rv/rd  (1.6) <a name='5389'></font>
<a name='5390'>
<a name='5391'>
<font color=#447700>! number of iterations<a name='5392'></font>
  niter=50<a name='5393'>
<font color=#447700>! minimum difference<a name='5394'></font>
  diff=2.e-5<a name='5395'>
<a name='5396'>
  EXN=(P/p1000mb)**rcp<a name='5397'>
  <font color=#447700>!QC=0.  !better first guess QC is incoming from lower level, do not set to zero<a name='5398'></font>
  do i=1,NITER<a name='5399'>
     T=EXN*THL + xlv/cp*QC        <a name='5400'>
     QS=<A href='../../html_code/phys/module_bl_mynn.F.html#QSAT_BLEND'>qsat_blend</A><A href='../../html_code/phys/module_bl_mynn.F.html#CONDENSATION_EDMF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_BLEND_3">(T,P)<a name='5401'>
     QCOLD=QC<a name='5402'>
     QC=0.5*QC + 0.5*MAX((QT-QS),0.)<a name='5403'>
     if (abs(QC-QCOLD)&lt;Diff) exit<a name='5404'>
  enddo<a name='5405'>
<a name='5406'>
  T=EXN*THL + xlv/cp*QC<a name='5407'>
  QS=<A href='../../html_code/phys/module_bl_mynn.F.html#QSAT_BLEND'>qsat_blend</A><A href='../../html_code/phys/module_bl_mynn.F.html#CONDENSATION_EDMF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_BLEND_4">(T,P)<a name='5408'>
  QC=max(QT-QS,0.)<a name='5409'>
<a name='5410'>
  <font color=#447700>!Do not allow saturation below 100 m<a name='5411'></font>
  if(zagl &lt; 100.)QC=0.<a name='5412'>
<a name='5413'>
  <font color=#447700>!THV=(THL+xlv/cp*QC).*(1+(1-rvovrd)*(QT-QC)-QC);<a name='5414'></font>
  THV=(THL+xlv/cp*QC)*(1.+QT*(rvovrd-1.)-rvovrd*QC)<a name='5415'>
  <font color=#447700>!THIS BASICALLY GIVE THE SAME RESULT AS THE PREVIOUS LINE<a name='5416'></font>
  <font color=#447700>!TH = THL + xlv/cp/EXN*QC<a name='5417'></font>
  <font color=#447700>!THV= TH*(1. + 0.608*QT)<a name='5418'></font>
<a name='5419'>
  <font color=#447700>!print *,'t,p,qt,qs,qc'<a name='5420'></font>
  <font color=#447700>!print *,t,p,qt,qs,qc <a name='5421'></font>
<a name='5422'>
<a name='5423'>
end subroutine condensation_edmf<a name='5424'>
<a name='5425'>
<font color=#447700>!===============================================================<a name='5426'></font>
<a name='5427'>
<A NAME='SCALE_AWARE'><A href='../../html_code/phys/module_bl_mynn.F.html#SCALE_AWARE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5428'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>SCALE_AWARE</font>(dx,PBL1,Psig_bl,Psig_shcu) <A href='../../call_to/SCALE_AWARE.html' TARGET='index'>2</A><a name='5429'>
<a name='5430'>
    <font color=#447700>!---------------------------------------------------------------<a name='5431'></font>
    <font color=#447700>!             NOTES ON SCALE-AWARE FORMULATION<a name='5432'></font>
    <font color=#447700>!<a name='5433'></font>
    <font color=#447700>!JOE: add scale-aware factor (Psig) here, taken from Honnert et al. (2011,<a name='5434'></font>
    <font color=#447700>!     JAS) and/or from Hyeyum Hailey Shin and Song-You Hong (2013, JAS)<a name='5435'></font>
    <font color=#447700>!<a name='5436'></font>
    <font color=#447700>! Psig_bl tapers local mixing<a name='5437'></font>
    <font color=#447700>! Psig_shcu tapers nonlocal mixing<a name='5438'></font>
<a name='5439'>
    REAL,INTENT(IN) :: dx,PBL1<a name='5440'>
    REAL, INTENT(OUT) :: Psig_bl,Psig_shcu<a name='5441'>
    REAL :: dxdh<a name='5442'>
<a name='5443'>
    Psig_bl=1.0<a name='5444'>
    Psig_shcu=1.0<a name='5445'>
    dxdh=MAX(dx,10.)/MIN(PBL1,3000.)<a name='5446'>
    <font color=#447700>! Honnert et al. 2011, TKE in PBL  *** original form used until 201605<a name='5447'></font>
    <font color=#447700>!Psig_bl= ((dxdh**2) + 0.07*(dxdh**0.667))/((dxdh**2) + &amp;<a name='5448'></font>
    <font color=#447700>!         (3./21.)*(dxdh**0.67) + (3./42.))<a name='5449'></font>
    <font color=#447700>! Honnert et al. 2011, TKE in entrainment layer<a name='5450'></font>
    <font color=#447700>!Psig_bl= ((dxdh**2) + (4./21.)*(dxdh**0.667))/((dxdh**2) + &amp;<a name='5451'></font>
     <font color=#447700>!        (3./20.)*(dxdh**0.67) + (7./21.))<a name='5452'></font>
    <font color=#447700>! New form to preseve parameterized mixing - only down 5% at dx = 750 m<a name='5453'></font>
     Psig_bl= ((dxdh**2) + 0.106*(dxdh**0.667))/((dxdh**2) +0.066*(dxdh**0.667) + 0.071)<a name='5454'>
<a name='5455'>
    <font color=#447700>!assume a 500 m cloud depth for shallow-cu clods<a name='5456'></font>
    dxdh=MAX(dx,10.)/MIN(PBL1+500.,3500.)<a name='5457'>
    <font color=#447700>! Honnert et al. 2011, TKE in entrainment layer *** original form used until 201605<a name='5458'></font>
    <font color=#447700>!Psig_shcu= ((dxdh**2) + (4./21.)*(dxdh**0.667))/((dxdh**2) + &amp;<a name='5459'></font>
    <font color=#447700>!         (3./20.)*(dxdh**0.67) + (7./21.))<a name='5460'></font>
<a name='5461'>
    <font color=#447700>! Honnert et al. 2011, TKE in cumulus<a name='5462'></font>
    <font color=#447700>!Psig(i)= ((dxdh**2) + 1.67*(dxdh**1.4))/((dxdh**2) +1.66*(dxdh**1.4) +<a name='5463'></font>
    <font color=#447700>!0.2)<a name='5464'></font>
<a name='5465'>
    <font color=#447700>! Honnert et al. 2011, w'q' in PBL<a name='5466'></font>
    <font color=#447700>!Psig(i)= 0.5 + 0.5*((dxdh**2) + 0.03*(dxdh**1.4) -<a name='5467'></font>
    <font color=#447700>!(4./13.))/((dxdh**2) + 0.03*(dxdh**1.4) + (4./13.))<a name='5468'></font>
    <font color=#447700>! Honnert et al. 2011, w'q' in cumulus<a name='5469'></font>
    <font color=#447700>!Psig(i)= ((dxdh**2) - 0.07*(dxdh**1.4))/((dxdh**2) -0.07*(dxdh**1.4) +<a name='5470'></font>
    <font color=#447700>!0.02)<a name='5471'></font>
<a name='5472'>
    <font color=#447700>! Honnert et al. 2011, q'q' in PBL<a name='5473'></font>
    <font color=#447700>!Psig(i)= 0.5 + 0.5*((dxdh**2) + 0.25*(dxdh**0.667) -0.73)/((dxdh**2)<a name='5474'></font>
    <font color=#447700>!-0.03*(dxdh**0.667) + 0.73)<a name='5475'></font>
    <font color=#447700>! Honnert et al. 2011, q'q' in cumulus<a name='5476'></font>
    <font color=#447700>!Psig(i)= ((dxdh**2) - 0.34*(dxdh**1.4))/((dxdh**2) - 0.35*(dxdh**1.4)<a name='5477'></font>
    <font color=#447700>!+ 0.37)<a name='5478'></font>
<a name='5479'>
    <font color=#447700>! Hyeyum Hailey Shin and Song-You Hong 2013, TKE in PBL (same as Honnert's above)<a name='5480'></font>
    <font color=#447700>!Psig_shcu= ((dxdh**2) + 0.070*(dxdh**0.667))/((dxdh**2)<a name='5481'></font>
    <font color=#447700>!+0.142*(dxdh**0.667) + 0.071)<a name='5482'></font>
    <font color=#447700>! Hyeyum Hailey Shin and Song-You Hong 2013, TKE in entrainment zone  *** switch to this form 201605<a name='5483'></font>
    Psig_shcu= ((dxdh**2) + 0.145*(dxdh**0.667))/((dxdh**2) +0.172*(dxdh**0.667) + 0.170)<a name='5484'>
<a name='5485'>
    <font color=#447700>! Hyeyum Hailey Shin and Song-You Hong 2013, w'theta' in PBL<a name='5486'></font>
    <font color=#447700>!Psig(i)= 0.5 + 0.5*((dxdh**2) -0.098)/((dxdh**2) + 0.106) <a name='5487'></font>
    <font color=#447700>! Hyeyum Hailey Shin and Song-You Hong 2013, w'theta' in entrainment zone<a name='5488'></font>
    <font color=#447700>!Psig(i)= 0.5 + 0.5*((dxdh**2) - 0.112*(dxdh**0.25) -0.071)/((dxdh**2)<a name='5489'></font>
    <font color=#447700>!+ 0.054*(dxdh**0.25) + 0.10)<a name='5490'></font>
<a name='5491'>
    <font color=#447700>!print*,"in shcu_gf; dx, dxdh, Psig(i)=",dx,dxdh,Psig(i)<a name='5492'></font>
    <font color=#447700>!If(Psig(i) &lt; 0.000001 .OR. Psig(i) &gt; 0.99999999)print*,"in shcu_gf;<a name='5493'></font>
    <font color=#447700>!dx, dxdh, Psig(i)=",dx,dxdh,Psig(i) <a name='5494'></font>
    If(Psig_bl &gt; 1.0) Psig_bl=1.0<a name='5495'>
    If(Psig_bl &lt; 0.0) Psig_bl=0.0<a name='5496'>
<a name='5497'>
    If(Psig_shcu &gt; 1.0) Psig_shcu=1.0<a name='5498'>
    If(Psig_shcu &lt; 0.0) Psig_shcu=0.0<a name='5499'>
<a name='5500'>
  END SUBROUTINE SCALE_AWARE<a name='5501'>
<a name='5502'>
<font color=#447700>! =====================================================================<a name='5503'></font>
<a name='5504'>
<A NAME='ESAT_BLEND'><A href='../../html_code/phys/module_bl_mynn.F.html#ESAT_BLEND' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='5505'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>esat_blend</font>(t)  <A href='../../call_to/ESAT_BLEND.html' TARGET='index'>2</A><a name='5506'>
<font color=#447700>! JAYMES- added 22 Apr 2015<a name='5507'></font>
<font color=#447700>! <a name='5508'></font>
<font color=#447700>! This calculates saturation vapor pressure.  Separate ice and liquid functions <a name='5509'></font>
<font color=#447700>! are used (identical to those in module_mp_thompson.F, v3.6).  Then, the <a name='5510'></font>
<font color=#447700>! final returned value is a temperature-dependant "blend".  Because the final <a name='5511'></font>
<font color=#447700>! value is "phase-aware", this formulation may be preferred for use throughout <a name='5512'></font>
<font color=#447700>! the module (replacing "svp").<a name='5513'></font>
<a name='5514'>
      IMPLICIT NONE<a name='5515'>
      <a name='5516'>
      REAL, INTENT(IN):: t<a name='5517'>
      REAL :: esat_blend,XC,ESL,ESI,chi<a name='5518'>
<a name='5519'>
      XC=MAX(-80.,t-273.16)<a name='5520'>
<a name='5521'>
<font color=#447700>! For 253 &lt; t &lt; 273.16 K, the vapor pressures are "blended" as a function of temperature, <a name='5522'></font>
<font color=#447700>! using the approach of Chaboureau and Bechtold (2002), JAS, p. 2363.  The resulting <a name='5523'></font>
<font color=#447700>! values are returned from the function.<a name='5524'></font>
      IF (t .GE. 273.16) THEN<a name='5525'>
          esat_blend = J0+XC*(J1+XC*(J2+XC*(J3+XC*(J4+XC*(J5+XC*(J6+XC*(J7+XC*J8))))))) <a name='5526'>
      ELSE IF (t .LE. 253.) THEN<a name='5527'>
          esat_blend = K0+XC*(K1+XC*(K2+XC*(K3+XC*(K4+XC*(K5+XC*(K6+XC*(K7+XC*K8)))))))<a name='5528'>
      ELSE<a name='5529'>
          ESL  = J0+XC*(J1+XC*(J2+XC*(J3+XC*(J4+XC*(J5+XC*(J6+XC*(J7+XC*J8)))))))<a name='5530'>
          ESI  = K0+XC*(K1+XC*(K2+XC*(K3+XC*(K4+XC*(K5+XC*(K6+XC*(K7+XC*K8)))))))<a name='5531'>
          chi  = (273.16-t)/20.16<a name='5532'>
          esat_blend = (1.-chi)*ESL  + chi*ESI<a name='5533'>
      END IF<a name='5534'>
<a name='5535'>
  END FUNCTION esat_blend<a name='5536'>
<a name='5537'>
<font color=#447700>! ====================================================================<a name='5538'></font>
<a name='5539'>
<A NAME='QSAT_BLEND'><A href='../../html_code/phys/module_bl_mynn.F.html#QSAT_BLEND' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='5540'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>qsat_blend</font>(t, P) <A href='../../call_to/QSAT_BLEND.html' TARGET='index'>7</A><a name='5541'>
<font color=#447700>! JAYMES- this function extends function "esat" and returns a "blended"<a name='5542'></font>
<font color=#447700>! saturation mixing ratio.<a name='5543'></font>
<a name='5544'>
      IMPLICIT NONE<a name='5545'>
<a name='5546'>
      REAL, INTENT(IN):: t, P<a name='5547'>
      REAL :: qsat_blend,XC,ESL,ESI,RSLF,RSIF,chi<a name='5548'>
<a name='5549'>
      XC=MAX(-80.,t-273.16)<a name='5550'>
<a name='5551'>
      IF (t .GE. 273.16) THEN<a name='5552'>
          ESL  = J0+XC*(J1+XC*(J2+XC*(J3+XC*(J4+XC*(J5+XC*(J6+XC*(J7+XC*J8))))))) <a name='5553'>
          qsat_blend = 0.622*ESL/(P-ESL) <a name='5554'>
      ELSE IF (t .LE. 253.) THEN<a name='5555'>
          ESI  = K0+XC*(K1+XC*(K2+XC*(K3+XC*(K4+XC*(K5+XC*(K6+XC*(K7+XC*K8)))))))<a name='5556'>
          qsat_blend = 0.622*ESI/(P-ESI)<a name='5557'>
      ELSE<a name='5558'>
          ESL  = J0+XC*(J1+XC*(J2+XC*(J3+XC*(J4+XC*(J5+XC*(J6+XC*(J7+XC*J8)))))))<a name='5559'>
          ESI  = K0+XC*(K1+XC*(K2+XC*(K3+XC*(K4+XC*(K5+XC*(K6+XC*(K7+XC*K8)))))))<a name='5560'>
          RSLF = 0.622*ESL/(P-ESL)<a name='5561'>
          RSIF = 0.622*ESI/(P-ESI)<a name='5562'>
          chi  = (273.16-t)/20.16<a name='5563'>
          qsat_blend = (1.-chi)*RSLF + chi*RSIF<a name='5564'>
      END IF<a name='5565'>
<a name='5566'>
  END FUNCTION qsat_blend<a name='5567'>
<a name='5568'>
<font color=#447700>! ===================================================================<a name='5569'></font>
<a name='5570'>
<A NAME='XL_BLEND'><A href='../../html_code/phys/module_bl_mynn.F.html#XL_BLEND' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='5571'>
  <font color=#993300>FUNCTION </font><font color=#cc0000>xl_blend</font>(t) <A href='../../call_to/XL_BLEND.html' TARGET='index'>3</A><a name='5572'>
<font color=#447700>! JAYMES- this function interpolates the latent heats of vaporization and<a name='5573'></font>
<font color=#447700>! sublimation into a single, temperature-dependant, "blended" value, following<a name='5574'></font>
<font color=#447700>! Chaboureau and Bechtold (2002), Appendix.<a name='5575'></font>
<a name='5576'>
      IMPLICIT NONE<a name='5577'>
<a name='5578'>
      REAL, INTENT(IN):: t<a name='5579'>
      REAL :: xl_blend,xlvt,xlst,chi<a name='5580'>
<a name='5581'>
      IF (t .GE. 273.16) THEN<a name='5582'>
          xl_blend = xlv + (cpv-cliq)*(t-273.16)  <font color=#447700>!vaporization/condensation<a name='5583'></font>
      ELSE IF (t .LE. 253.) THEN<a name='5584'>
          xl_blend = xls + (cpv-cice)*(t-273.16)  <font color=#447700>!sublimation/deposition<a name='5585'></font>
      ELSE<a name='5586'>
          xlvt = xlv + (cpv-cliq)*(t-273.16)  <font color=#447700>!vaporization/condensation<a name='5587'></font>
          xlst = xls + (cpv-cice)*(t-273.16)  <font color=#447700>!sublimation/deposition<a name='5588'></font>
          chi  = (273.16-t)/20.16<a name='5589'>
          xl_blend = (1.-chi)*xlvt + chi*xlst     <font color=#447700>!blended<a name='5590'></font>
      END IF<a name='5591'>
<a name='5592'>
  END FUNCTION xl_blend<a name='5593'>
<a name='5594'>
<font color=#447700>! ===================================================================<a name='5595'></font>
<font color=#447700>! ===================================================================<a name='5596'></font>
<font color=#447700>! This is the mass flux part of the TEMF scheme from module_bl_temf.F,<a name='5597'></font>
<font color=#447700>! adapted for the MYNN context by Wayne Angevine June 2015.<a name='5598'></font>
<font color=#447700>! Variable strategy:  TEMF external variables that have semantically<a name='5599'></font>
<font color=#447700>! comfortable counterparts in the MYNN-EDMF context have been changed to<a name='5600'></font>
<font color=#447700>! use those names.  Otherwise the TEMF variable names have been kept but<a name='5601'></font>
<font color=#447700>! redefined as local variables.  Only "moist" vars are used, whether<a name='5602'></font>
<font color=#447700>! updraft condenses or not.  Some former local vars are replaced with<a name='5603'></font>
<font color=#447700>! externals.<a name='5604'></font>
<font color=#447700>!<a name='5605'></font>
<font color=#447700>! (Partial) list of conversions:<a name='5606'></font>
<font color=#447700>!    wupd_temfx -&gt; moist_w<a name='5607'></font>
<font color=#447700>!    thup_temfx -&gt; moist_thl<a name='5608'></font>
<font color=#447700>!    qtup_temfx -&gt; moist_qt<a name='5609'></font>
<font color=#447700>!    qlup_temfx -&gt; moist_qc<a name='5610'></font>
<font color=#447700>!    cf3d_temfx -&gt; cldfra_bl1d<a name='5611'></font>
<font color=#447700>!    au -&gt; moist_a<a name='5612'></font>
<a name='5613'>
<A NAME='TEMF_MF'><A href='../../html_code/phys/module_bl_mynn.F.html#TEMF_MF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5614'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>temf_mf</font>(                        &amp; <A href='../../call_to/TEMF_MF.html' TARGET='index'>1</A>,<A href='../../call_from/TEMF_MF.html' TARGET='index'>10</A><a name='5615'>
                 &amp; kts,kte,dt,zw,p,pi1d,     &amp;<a name='5616'>
                 &amp; u,v,w,th,thl,thv,qt,qv,qc,&amp;<a name='5617'>
                 &amp; qke,ust,flt,flq,flqv,flqc,&amp;<a name='5618'>
                 &amp; hfx,qfx,tsk,              &amp;<a name='5619'>
                 &amp; pblh,rho,dfh,dx,znt,ep_2, &amp;<a name='5620'>
            <font color=#447700>! outputs - updraft properties<a name='5621'></font>
                 &amp; edmf_a,edmf_w,edmf_qt,    &amp;<a name='5622'>
                 &amp; edmf_thl,edmf_ent,edmf_qc,&amp;<a name='5623'>
            <font color=#447700>! outputs - variables needed for solver<a name='5624'></font>
                 &amp; s_aw,s_awthl,s_awqt,      &amp;<a name='5625'>
                 &amp; s_awqv,s_awqc,            &amp;<a name='5626'>
                 &amp; s_awu,s_awv,s_awqke,      &amp;<a name='5627'>
#if (WRF_CHEM == 1)<a name='5628'>
                 &amp; nchem,chem,s_awchem,      &amp;<a name='5629'>
#endif<a name='5630'>
            <font color=#447700>! in/outputs - subgrid scale clouds<a name='5631'></font>
                 &amp; qc_bl1d,cldfra_bl1d,      &amp;<a name='5632'>
            <font color=#447700>! inputs - flags for moist arrays<a name='5633'></font>
                 &amp;F_QC,F_QI,psig,            &amp;<a name='5634'>
                 &amp;spp_pbl,rstoch_col,        &amp;<a name='5635'>
                 &amp;ii,jj,ids,ide,jds,jde)<a name='5636'>
<a name='5637'>
  <font color=#447700>! Stochastic<a name='5638'></font>
     INTEGER, INTENT(IN)   :: spp_pbl<a name='5639'>
     REAL, DIMENSION(kts:kte), INTENT(in)   :: rstoch_col <a name='5640'>
  <font color=#447700>! inputs:<a name='5641'></font>
     INTEGER, INTENT(IN) :: kts,kte,ii,jj,ids,ide,jds,jde<a name='5642'>
     REAL,DIMENSION(kts:kte), INTENT(IN) :: u,v,w,th,thl,qt,qv,qc,thv,p,pi1d<a name='5643'>
     REAL,DIMENSION(kts:kte), INTENT(IN) :: qke<a name='5644'>
     REAL,DIMENSION(kts:kte+1), INTENT(IN) :: zw  <font color=#447700>!height at full-sigma<a name='5645'></font>
     REAL,DIMENSION(kts:kte), INTENT(IN) :: rho  <font color=#447700>!density<a name='5646'></font>
     REAL,DIMENSION(kts:kte), INTENT(IN) :: dfh  <font color=#447700>!diffusivity for heat<a name='5647'></font>
     REAL, INTENT(IN) :: dt,ust,flt,flq,flqv,flqc,hfx,qfx,tsk,pblh,dx,znt,ep_2,psig<a name='5648'>
     LOGICAL, OPTIONAL :: f_qc,f_qi<a name='5649'>
<a name='5650'>
  <font color=#447700>! outputs - updraft properties<a name='5651'></font>
     REAL,DIMENSION(kts:kte), INTENT(OUT) :: &amp;<a name='5652'>
                 &amp; edmf_a,edmf_w,edmf_qt,    &amp;<a name='5653'>
                 &amp; edmf_thl,edmf_ent,edmf_qc<a name='5654'>
<a name='5655'>
  <font color=#447700>! outputs - variables needed for solver<a name='5656'></font>
     REAL,DIMENSION(kts:kte+1) :: s_aw,      &amp; <font color=#447700>!sum ai*wis_awphi<a name='5657'></font>
                               s_awthl,      &amp; <font color=#447700>!sum ai*wi*phii<a name='5658'></font>
                                s_awqt,      &amp;<a name='5659'>
                                s_awqv,      &amp;<a name='5660'>
                                s_awqc,      &amp;<a name='5661'>
                                 s_awu,      &amp;<a name='5662'>
                                 s_awv,      &amp;<a name='5663'>
                                 s_awqke<a name='5664'>
#if (WRF_CHEM == 1)<a name='5665'>
     INTEGER, INTENT(IN) :: nchem<a name='5666'>
     REAL,DIMENSION(kts:kte+1, nchem) :: chem<a name='5667'>
     REAL,DIMENSION(kts:kte+1, nchem) :: s_awchem<a name='5668'>
     INTEGER :: ic<a name='5669'>
#endif<a name='5670'>
<a name='5671'>
     REAL,DIMENSION(kts:kte), INTENT(INOUT) :: qc_bl1d,cldfra_bl1d<a name='5672'>
<a name='5673'>
<font color=#447700>! Local variables<a name='5674'></font>
<font color=#447700>!<a name='5675'></font>
<font color=#447700>! EDMF constants<a name='5676'></font>
   real, parameter :: CM = 0.03      <font color=#447700>! Proportionality constant for subcloud MF<a name='5677'></font>
   real, parameter :: Cdelt = 0.006  <font color=#447700>! Prefactor for detrainment rate<a name='5678'></font>
   real, parameter :: Cw = 0.5       <font color=#447700>! Prefactor for surface wUPD<a name='5679'></font>
   real, parameter :: Cc = 3.0       <font color=#447700>! Prefactor for convective length scale<a name='5680'></font>
   real, parameter :: lasymp = 200.0 <font color=#447700>! Asymptotic length scale WA 11/20/09<a name='5681'></font>
   real, parameter :: hmax = 4000.0  <font color=#447700>! Max hd,hct WA 11/20/09<a name='5682'></font>
   integer, parameter :: Nupd = 8    <font color=#447700>! Number of updrafts<a name='5683'></font>
<font color=#447700>!<a name='5684'></font>
   integer :: i, k, kt, nu   <font color=#447700>! Loop variable<a name='5685'></font>
   integer::  h0idx<a name='5686'>
   real::  h0<a name='5687'>
   real::  wstr, ang, wm<a name='5688'>
   real, dimension( Nupd) ::  hd,lcl,hct,ht<a name='5689'>
   real::  convection_TKE_surface_src, sfcFTE<a name='5690'>
   real::  sfcTHVF<a name='5691'>
   real::  z0t<a name='5692'>
   integer, dimension( Nupd) ::  hdidx,lclidx,hctidx,htidx<a name='5693'>
   integer::  hmax_idx<a name='5694'>
   integer::  tval<a name='5695'>
   real, dimension( kts:kte) :: zm, zt, dzm, dzt<a name='5696'>
   real, dimension( kts:kte) :: thetal, qtot<a name='5697'>
   real, dimension( kts:kte) :: u_temf, v_temf<a name='5698'>
   real, dimension( kts:kte) :: rv, rl, rt<a name='5699'>
   real, dimension( kts:kte) :: chi_poisson, gam<a name='5700'>
   real, dimension( kts:kte) :: dthdz<a name='5701'>
   real, dimension( kts:kte) :: lepsmin<a name='5702'>
   real, dimension( kts:kte) :: thetav<a name='5703'>
   real, dimension( kts:kte) :: dmoist_qtdz<a name='5704'>
   real, dimension( kts:kte) :: B, Bmoist<a name='5705'>
   real, dimension( kts:kte, Nupd) :: epsmf, deltmf, dMdz<a name='5706'>
   real, dimension( kts:kte, Nupd) :: UUPD, VUPD<a name='5707'>
   real, dimension( kts:kte, Nupd) :: thetavUPD, qlUPD, TEUPD<a name='5708'>
   real, dimension( kts:kte, Nupd) :: thetavUPDmoist, wUPD_dry<a name='5709'>
   real, dimension( kts:kte, Nupd) :: dthUPDdz, dwUPDdz<a name='5710'>
   real, dimension( kts:kte, Nupd) :: dwUPDmoistdz<a name='5711'>
   real, dimension( kts:kte, Nupd) :: dUUPDdz, dVUPDdz, dTEUPDdz<a name='5712'>
   real, dimension( kts:kte, Nupd) :: TUPD, rstUPD, rUPD, rlUPD, qstUPD<a name='5713'>
   real, dimension( kts:kte, Nupd) :: MUPD, wUPD, qtUPD, thlUPD, qcUPD<a name='5714'>
   real, dimension( kts:kte, Nupd) :: aUPD, cldfraUPD, aUPDt<a name='5715'>
   real, dimension( kts:kte) :: N2, S, Ri, beta, ftau, fth, ratio<a name='5716'>
   real, dimension( kts:kte) :: TKE, TE2<a name='5717'>
   real, dimension( kts:kte) :: ustrtilde, linv, leps<a name='5718'>
   real, dimension( kts:kte) :: km, kh<a name='5719'>
   real, dimension( kts:kte) :: Fz, QFK, uwk, vwk<a name='5720'>
   real, dimension( kts:kte) :: km_conv, kh_conv, lconv<a name='5721'>
   real, dimension( kts:kte) :: alpha2, beta2   <font color=#447700>! For thetav flux calculation<a name='5722'></font>
   real, dimension( kts:kte) :: THVF, buoy_src, srcs<a name='5723'>
   real, dimension( kts:kte) :: beta1 <font color=#447700>! For saturation humidity calculations<a name='5724'></font>
   real, dimension( kts:kte) :: MFCth<a name='5725'>
   real Cepsmf    <font color=#447700>! Prefactor for entrainment rate<a name='5726'></font>
   real red_fact  <font color=#447700>! for reducing MF components<a name='5727'></font>
   real, dimension( kts:kte) :: edmf_u, edmf_v, edmf_qke <font color=#447700>! Same format as registry vars, but not passed out<a name='5728'></font>
   integer:: bdy_dist,taper_dist<a name='5729'>
   real:: taper<a name='5730'>
<a name='5731'>
#if (WRF_CHEM == 1)<a name='5732'>
   real,dimension( kts:kte+1, nchem, Nupd) :: chemUPD, dchemUPDdz<a name='5733'>
   real,dimension( kts:kte+1, nchem)       :: edmf_chem<a name='5734'>
#endif<a name='5735'>
<a name='5736'>
   <font color=#447700>! Used to be TEMF external variables, now local<a name='5737'></font>
   real, dimension( kts:kte, Nupd) :: &amp;<a name='5738'>
             shf_temfx, qf_temfx, uw_temfx, vw_temfx , &amp;<a name='5739'>
             mf_temfx<a name='5740'>
   real, dimension( Nupd) :: hd_temfx, lcl_temfx, hct_temfx, cfm_temfx<a name='5741'>
   logical is_convective<a name='5742'>
   <font color=#447700>! Vars for cloud fraction calculation<a name='5743'></font>
   real, dimension( kts:kte) :: sigq, qst, satdef<a name='5744'>
   real :: sigq2, rst, cldfra_sum, psig_w, maxw<a name='5745'>
<a name='5746'>
<font color=#447700>!----------------------------------------------------------------------<a name='5747'></font>
<font color=#447700>! Grid staggering:  Matlab version has mass and turbulence levels.<a name='5748'></font>
<font color=#447700>! WRF has full levels (with w) and half levels (u,v,theta,q*).  Both<a name='5749'></font>
<font color=#447700>! sets of levels use the same indices (kts:kte).  See pbl_driver or<a name='5750'></font>
<font color=#447700>! WRF Physics doc for (a few) details.<a name='5751'></font>
<font color=#447700>! So *mass levels correspond to half levels.*<a name='5752'></font>
<font color=#447700>! WRF full levels are ignored, we define our own turbulence levels<a name='5753'></font>
<font color=#447700>! in order to put the first one below the first half level.<a name='5754'></font>
<font color=#447700>! Another difference is that<a name='5755'></font>
<font color=#447700>! the Matlab version (and the Mauritsen et al. paper) consider the<a name='5756'></font>
<font color=#447700>! first mass level to be at z0 (effectively the surface).  WRF considers<a name='5757'></font>
<font color=#447700>! the first half level to be above the effective surface.  The first half<a name='5758'></font>
<font color=#447700>! level, at k=1, has nonzero values of u,v for example.  Here we convert<a name='5759'></font>
<font color=#447700>! all incoming variables to internal ones with the correct indexing<a name='5760'></font>
<font color=#447700>! in order to make the code consistent with the Matlab version.  We<a name='5761'></font>
<font color=#447700>! already had to do this for thetal and qt anyway, so the only additional<a name='5762'></font>
<font color=#447700>! overhead is for u and v.<a name='5763'></font>
<font color=#447700>! I use suffixes m for mass and t for turbulence as in Matlab for things<a name='5764'></font>
<font color=#447700>! like indices.<a name='5765'></font>
<font color=#447700>! Note that zsrf is the terrain height ASL, from Registry variable ht.<a name='5766'></font>
<font color=#447700>! Translations (Matlab to WRF):<a name='5767'></font>
<font color=#447700>!     dzt -&gt; calculated below<a name='5768'></font>
<font color=#447700>!     dzm -&gt; not supplied, calculated below<a name='5769'></font>
<font color=#447700>!     k -&gt; karman<a name='5770'></font>
<font color=#447700>!     z0 -&gt; znt<a name='5771'></font>
<font color=#447700>!     z0t -&gt; not in WRF, calculated below<a name='5772'></font>
<font color=#447700>!     zt -&gt; calculated below<a name='5773'></font>
<font color=#447700>!     zm -&gt; zw but NOTE zm(1) is now z0 (znt) and zm(2) is zw(1)<a name='5774'></font>
<font color=#447700>!<a name='5775'></font>
<font color=#447700>! Other notes:<a name='5776'></font>
<font color=#447700>! - I have often used 1 instead of kts below, because the scheme demands<a name='5777'></font>
<font color=#447700>!   to know where the surface is.  It won't work if kts .NE. 1.<a name='5778'></font>
<a name='5779'>
      IF ( wrf_at_debug_level(MYNN_DBG_LVL) ) THEN<a name='5780'>
           WRITE ( mynn_message , FMT='(A)' ) &amp;<a name='5781'>
           ' MYNN; in TEMF_MF, beginning'<a name='5782'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#TEMF_MF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_519"> ( 0 , mynn_message )<a name='5783'>
      ENDIF<a name='5784'>
<a name='5785'>
      <font color=#447700>!JOE-initialize s_aw* variables<a name='5786'></font>
      s_aw   = 0.<a name='5787'>
      s_awthl= 0.<a name='5788'>
      s_awqt = 0.<a name='5789'>
      s_awqv = 0.<a name='5790'>
      s_awqc = 0.<a name='5791'>
      s_awu  = 0.<a name='5792'>
      s_awv  = 0.<a name='5793'>
      s_awqke= 0.<a name='5794'>
      edmf_a = 0.<a name='5795'>
      edmf_w = 0.<a name='5796'>
      edmf_qt= 0. <font color=#447700>!qt<a name='5797'></font>
      edmf_thl=0. <font color=#447700>!thl<a name='5798'></font>
      edmf_ent=0.<a name='5799'>
      edmf_qc= 0. <font color=#447700>!qc<a name='5800'></font>
      edmf_u=0.<a name='5801'>
      edmf_v=0.<a name='5802'>
      edmf_qke=0.<a name='5803'>
 <a name='5804'>
      z0t = znt<a name='5805'>
<a name='5806'>
      do k = kts,kte<a name='5807'>
         rv(k) = qv(k) / (1.-qv(k))   <font color=#447700>! Water vapor<a name='5808'></font>
         rl(k) = qc(k) / (1.-qc(k))   <font color=#447700>! Liquid water<a name='5809'></font>
         rt(k) = qt(k)                <font color=#447700>! Total water (without ice)<a name='5810'></font>
         thetal(k) = thl(k)<a name='5811'>
         qtot(k) = qt(k)<a name='5812'>
         thetav(k) = thv(k)<a name='5813'>
      end do<a name='5814'>
<a name='5815'>
      do k = kts,kte<a name='5816'>
         u_temf(k) = u(k)<a name='5817'>
         v_temf(k) = v(k)<a name='5818'>
      end do<a name='5819'>
<a name='5820'>
      <font color=#447700>!taper off MF scheme when significant resolved-scale motions are present<a name='5821'></font>
      <font color=#447700>!This function needs to be asymetric...<a name='5822'></font>
      k      = 1<a name='5823'>
      maxw   = 0.0<a name='5824'>
      DO WHILE (ZW(k) &lt; pblh + 500.)<a name='5825'>
         maxw = MAX(maxw,ABS(W(k)))<a name='5826'>
         k = k+1<a name='5827'>
      ENDDO<a name='5828'>
      maxw = MAX(0.,maxw - 0.5)         <font color=#447700>! do nothing for small w, but<a name='5829'></font>
      Psig_w = MAX(0.0, 1.0 - maxw/0.5) <font color=#447700>! linearly taper off for w &gt; 0.5 m/s<a name='5830'></font>
      Psig_w = MIN(Psig_w, Psig)<a name='5831'>
      <font color=#447700>!print*," maxw=", maxw," Psig_w=",Psig_w," Psig_shcu=",Psig_shcu<a name='5832'></font>
<a name='5833'>
      <font color=#447700>! Get delta height at half (mass) levels<a name='5834'></font>
      zm(1) = znt<a name='5835'>
      dzt(1) = zw(2) - zm(1)<a name='5836'>
      <font color=#447700>! Get height and delta at turbulence levels<a name='5837'></font>
      zt(1) = (zw(2) - znt) / 2.<a name='5838'>
      do kt = kts+1,kte<a name='5839'>
         zm(kt) = zw(kt) <font color=#447700>! Convert indexing from WRF to TEMF<a name='5840'></font>
         zt(kt) = (zm(kt) + zw(kt+1)) / 2.<a name='5841'>
         dzm(kt) = zt(kt) - zt(kt-1)<a name='5842'>
         dzt(kt) = zw(kt+1) - zw(kt)<a name='5843'>
      end do<a name='5844'>
      dzm(1) = dzm(2)<a name='5845'>
<a name='5846'>
      <font color=#447700>!print *,"In TEMF_MF zw = ", zw<a name='5847'></font>
      <font color=#447700>!print *,"zm = ", zm<a name='5848'></font>
      <font color=#447700>!print *,"zt = ", zt<a name='5849'></font>
      <font color=#447700>!print *,"dzm = ", dzm<a name='5850'></font>
      <font color=#447700>!print *,"dzt = ", dzt<a name='5851'></font>
<a name='5852'>
      <font color=#447700>! Gradients at first level<a name='5853'></font>
      dthdz(1) = (thetal(2)-thetal(1)) / (zt(1) * log10(zm(2)/z0t))<a name='5854'>
<a name='5855'>
      <font color=#447700>!print *,"In TEMF_MF dthdz(1),thetal(2,1),tsk,zt(1),zm(2),z0t = ", &amp;<a name='5856'></font>
      <font color=#447700>!             dthdz(1),thetal(2),thetal(1),tsk,zt(1),zm(2),z0t       <a name='5857'></font>
<a name='5858'>
      <font color=#447700>! Surface thetaV flux from Stull p.147<a name='5859'></font>
      sfcTHVF = hfx/(rho(1)*cp) * (1.+0.608*(qv(1)+qc(1))) + 0.608*thetav(1)*qfx<a name='5860'>
<a name='5861'>
      <font color=#447700>! WA use hd_temf to calculate w* instead of finding h0 here????<a name='5862'></font>
      <font color=#447700>! Watch initialization!<a name='5863'></font>
      h0idx = 1<a name='5864'>
      h0 = zm(1)<a name='5865'>
<a name='5866'>
      lepsmin(kts) = 0.<a name='5867'>
<a name='5868'>
      <font color=#447700>! WA 2/11/13 find index just above hmax for use below<a name='5869'></font>
      hmax_idx = kte-1<a name='5870'>
<a name='5871'>
      do k = kts+1,kte-1<a name='5872'>
         lepsmin(k) = 0.<a name='5873'>
<a name='5874'>
         <font color=#447700>! Mean gradients<a name='5875'></font>
         dthdz(k) = (thetal(k+1) - thetal(k)) / dzt(k)<a name='5876'>
<a name='5877'>
         <font color=#447700>! Find h0 (should eventually be interpolated for smoothness)<a name='5878'></font>
         if (thetav(k) &gt; thetav(1) .AND. h0idx .EQ. 1) then<a name='5879'>
         <font color=#447700>! WA 9/28/11 limit h0 as for hd and hct<a name='5880'></font>
            if (zm(k) &lt; hmax) then<a name='5881'>
               h0idx = k<a name='5882'>
               h0 = zm(k)<a name='5883'>
            else<a name='5884'>
               h0idx = k<a name='5885'>
               h0 = hmax<a name='5886'>
            end if<a name='5887'>
         end if<a name='5888'>
         <font color=#447700>! WA 2/11/13 find index just above hmax for use below<a name='5889'></font>
         if (zm(k) &gt; hmax) then<a name='5890'>
            hmax_idx = min(hmax_idx,k)<a name='5891'>
         end if<a name='5892'>
      end do<a name='5893'>
<a name='5894'>
      <font color=#447700>! Gradients at top level<a name='5895'></font>
<a name='5896'>
      dthdz(kte) = dthdz(kte-1)<a name='5897'>
<a name='5898'>
      if ( hfx &gt; 0.) then<a name='5899'>
         wstr = (g * h0 / thetav(2) * hfx/(rho(1)*cp) ) ** (1./3.)<a name='5900'>
         bdy_dist = min( min((ii-ids),(ide-ii)) , min((jj-jds),(jde-jj)) )<a name='5901'>
         taper_dist = 5<a name='5902'>
         <font color=#447700>! JSK - linearly taper w-star near lateral boundaries (within 5 grid columns)<a name='5903'></font>
         if (bdy_dist .LE. taper_dist) then<a name='5904'>
            taper = max(0., min( 1., real(bdy_dist) / real(taper_dist) ) )<a name='5905'>
            wstr  = wstr * taper<a name='5906'>
         end if<a name='5907'>
      else<a name='5908'>
         wstr = 0.<a name='5909'>
      end if<a name='5910'>
<a name='5911'>
      <font color=#447700>!print *,"In TEMF_MF wstr,hfx,dthdz(1:2),h0 = ", wstr,hfx,dthdz(1),dthdz(2),h0<a name='5912'></font>
      IF ( wrf_at_debug_level(MYNN_DBG_LVL) ) THEN<a name='5913'>
         WRITE ( mynn_message , FMT='(A,F5.1,F6.1,F5.1,F5.1,F5.1)' ) &amp;<a name='5914'>
         ' MYNN; in TEMF_MF: wstr,hfx,dtdz1,dtdz2,h0:', wstr,hfx,dthdz(1),dthdz(2),h0<a name='5915'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#TEMF_MF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_520"> ( 0 , mynn_message )<a name='5916'>
      ENDIF<a name='5917'>
<a name='5918'>
      <font color=#447700>! Set flag convective or not for use below<a name='5919'></font>
      is_convective = wstr &gt; 0. .AND. dthdz(1)&lt;0. .AND. dthdz(2)&lt;0.  <a name='5920'>
      <font color=#447700>! WA 12/16/09 require two levels of negative (unstable) gradient<a name='5921'></font>
<a name='5922'>
      <font color=#447700>!*** Mass flux block starts here ***<a name='5923'></font>
      <font color=#447700>! WA WFIP 11/13/15 allow multiple updrafts, deterministic for now<a name='5924'></font>
<a name='5925'>
      if ( is_convective) then<a name='5926'>
<a name='5927'>
         <font color=#447700>!print *,"In TEMF_MF is_convective, wstr = ", wstr<a name='5928'></font>
         IF ( wrf_at_debug_level(MYNN_DBG_LVL) ) THEN<a name='5929'>
            WRITE ( mynn_message , FMT='(A)' ) &amp;<a name='5930'>
            ' MYNN; in TEMF_MF: inconvective branch'<a name='5931'>
            CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#TEMF_MF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_521"> ( 0 , mynn_message )<a name='5932'>
         ENDIF<a name='5933'>
<a name='5934'>
         <font color=#447700>!Cepsmf = 2. / max(200.,h0)<a name='5935'></font>
         Cepsmf = 1.0 / max(200.,h0) <font color=#447700>! WA TEST reduce entrainment <a name='5936'></font>
         <font color=#447700>! Cepsmf = max(Cepsmf,0.002)<a name='5937'></font>
         <font color=#447700>! Cepsmf = max(Cepsmf,0.0015)  ! WA TEST reduce max entrainment<a name='5938'></font>
         <font color=#447700>! Cepsmf = max(Cepsmf,0.0005)  ! WA TEST reduce min entrainment<a name='5939'></font>
         Cepsmf = max(Cepsmf,0.0010)  <font color=#447700>! WA TEST reduce min entrainment<a name='5940'></font>
<a name='5941'>
         do nu = 1,Nupd<a name='5942'>
            do k = kts,kte<a name='5943'>
               <font color=#447700>! Calculate lateral entrainment fraction for subcloud layer<a name='5944'></font>
               <font color=#447700>! epsilon and delta are defined on mass grid (half levels)<a name='5945'></font>
               <font color=#447700>! epsmf(k,nu) = Cepsmf * (1+0.2*(floor(nu - Nupd/2.))) ! WA for three updrafts<a name='5946'></font>
               <font color=#447700>! epsmf(k,nu) = Cepsmf * (1+0.05*(floor(nu - Nupd/2.))) ! WA for ten updrafts<a name='5947'></font>
               <font color=#447700>! epsmf(k,nu) = Cepsmf * (1+0.0625*(floor(nu - Nupd/2.))) ! WA for eight updrafts<a name='5948'></font>
               <font color=#447700>! epsmf(k,nu) = Cepsmf * (1+0.03*(floor(nu - Nupd/2.))) ! WA for eight updrafts, less spread<a name='5949'></font>
               epsmf(k,nu) = Cepsmf * (1+0.25*(nu-1)) <font color=#447700>! WA for eight updrafts, much more eps for some plumes, per Neggers 2015 fig. 15 <a name='5950'></font>
            end do<a name='5951'>
            <font color=#447700>!print *,"In TEMF_MF Cepsmf, epsmf = ", Cepsmf, epsmf(1,:)<a name='5952'></font>
            <font color=#447700>!IF ( wrf_at_debug_level(MYNN_DBG_LVL) ) THEN<a name='5953'></font>
            <font color=#447700>!   WRITE ( mynn_message , FMT='(A,F8.4)' ) &amp;<a name='5954'></font>
            <font color=#447700>!   ' MYNN; in TEMF_MF, Cepsmf, epsmf(1:13,nu)=', Cepsmf<a name='5955'></font>
            <font color=#447700>!   CALL wrf_debug ( 0 , mynn_message )<a name='5956'></font>
            <font color=#447700>!   print*,"    epsmf(1:13,nu)=",epsmf(1:13,nu)<a name='5957'></font>
            <font color=#447700>!ENDIF<a name='5958'></font>
<a name='5959'>
            <font color=#447700>! Initialize updraft<a name='5960'></font>
            thlUPD(1,nu) = thetal(1) + Cw*wstr<a name='5961'>
            qtUPD(1,nu) = qtot(1) + 0.0*qfx/wstr<a name='5962'>
            rUPD(1,nu) = qtUPD(1,nu) / (1. - qtUPD(1,nu))<a name='5963'>
            wUPD(1,nu) = Cw * wstr<a name='5964'>
            wUPD_dry(1,nu) = Cw * wstr<a name='5965'>
            UUPD(1,nu) = u_temf(1)<a name='5966'>
            VUPD(1,nu) = v_temf(1)<a name='5967'>
            thetavUPD(1,nu) = thlUPD(1,nu) * (1. + 0.608*qtUPD(1,nu))  <font color=#447700>! WA Assumes no liquid<a name='5968'></font>
            thetavUPDmoist(1,nu) = thetavUPD(1,nu)<a name='5969'>
            TEUPD(1,nu) = qke(1) + g / thetav(1) * sfcTHVF<a name='5970'>
            qlUPD(1,nu) = qc(1)  <font color=#447700>! WA allow environment liquid<a name='5971'></font>
            TUPD(1,nu) = thlUPD(1,nu) * pi1d(1)<a name='5972'>
            <font color=#447700>!rstUPD(1,nu) = <A href='../../html_code/phys/module_bl_mynn.F.html#RSAT_TEMF'>rsat_temf</A><A href='../../html_code/phys/module_bl_mynn.F.html#TEMF_MF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSAT_TEMF_1">(p(1),TUPD(1,nu),ep_2)<a name='5973'></font>
            rstUPD(1,nu) = <A href='../../html_code/phys/module_bl_mynn.F.html#QSAT_BLEND'>qsat_blend</A><A href='../../html_code/phys/module_bl_mynn.F.html#TEMF_MF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_BLEND_5">(TUPD(1,nu),p(1)) <font color=#447700>! get saturation water vapor mixing ratio at tl and p<a name='5974'></font>
            rlUPD(1,nu) = 0.<a name='5975'>
#if (WRF_CHEM == 1)<a name='5976'>
            do ic = 1,nchem<a name='5977'>
               chemUPD(1,ic,nu) = chem(1,ic)<a name='5978'>
            enddo<a name='5979'>
#endif<a name='5980'>
<a name='5981'>
            <font color=#447700>! Calculate updraft parameters counting up<a name='5982'></font>
            do k = 2,kte<a name='5983'>
               <font color=#447700>! WA 2/11/13 use hmax index to prevent oddness high up<a name='5984'></font>
               if ( k &lt; hmax_idx) then<a name='5985'>
                  dthUPDdz(k-1,nu) = -epsmf(k,nu) * (thlUPD(k-1,nu) - thetal(k-1))<a name='5986'>
                  thlUPD(k,nu) = thlUPD(k-1,nu) + dthUPDdz(k-1,nu) * dzm(k-1)<a name='5987'>
                  dmoist_qtdz(k-1) = -epsmf(k,nu) * (qtUPD(k-1,nu) - qtot(k-1))<a name='5988'>
                  qtUPD(k,nu) = qtUPD(k-1,nu) + dmoist_qtdz(k-1) * dzm(k-1)<a name='5989'>
                  thetavUPD(k,nu) = thlUPD(k,nu) * (1. + 0.608*qtUPD(k,nu))  <font color=#447700>! WA Assumes no liquid<a name='5990'></font>
                  B(k-1) = g * (thetavUPD(k,nu) - thetav(k)) / thetav(k)<a name='5991'>
                  if ( wUPD_dry(k-1,nu) &lt; 1e-15 ) then<a name='5992'>
                     wUPD_dry(k,nu) = 0.<a name='5993'>
                  else<a name='5994'>
                     dwUPDdz(k-1,nu) = -2. *epsmf(k,nu)*wUPD_dry(k-1,nu) + 0.33*B(k-1)/wUPD_dry(k-1,nu)<a name='5995'>
                     wUPD_dry(k,nu) = wUPD_dry(k-1,nu) + dwUPDdz(k-1,nu) * dzm(k-1)<a name='5996'>
                  end if<a name='5997'>
                  dUUPDdz(k-1,nu) = -epsmf(k,nu) * (UUPD(k-1,nu) - u_temf(k-1))<a name='5998'>
                  UUPD(k,nu) = UUPD(k-1,nu) + dUUPDdz(k-1,nu) * dzm(k-1)<a name='5999'>
                  dVUPDdz(k-1,nu) = -epsmf(k,nu) * (VUPD(k-1,nu) - v_temf(k-1))<a name='6000'>
                  VUPD(k,nu) = VUPD(k-1,nu) + dVUPDdz(k-1,nu) * dzm(k-1)<a name='6001'>
                  dTEUPDdz(k-1,nu) = -epsmf(k,nu) * (TEUPD(k-1,nu) - qke(k-1))<a name='6002'>
                  TEUPD(k,nu) = TEUPD(k-1,nu) + dTEUPDdz(k-1,nu) * dzm(k-1)<a name='6003'>
                  <font color=#447700>! Alternative updraft velocity based on moist thetav<a name='6004'></font>
                  <font color=#447700>! Need thetavUPDmoist, qlUPD<a name='6005'></font>
                  rUPD(k,nu) = qtUPD(k,nu) / (1. - qtUPD(k,nu))<a name='6006'>
                  <font color=#447700>! WA Updraft temperature assuming no liquid<a name='6007'></font>
                  TUPD(k,nu) = thlUPD(k,nu) * pi1d(k)<a name='6008'>
                  <font color=#447700>! Updraft saturation mixing ratio<a name='6009'></font>
                  <font color=#447700>!rstUPD(k,nu) = <A href='../../html_code/phys/module_bl_mynn.F.html#RSAT_TEMF'>rsat_temf</A><A href='../../html_code/phys/module_bl_mynn.F.html#TEMF_MF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSAT_TEMF_2">(p(k-1),TUPD(k,nu),ep_2)<a name='6010'></font>
                  rstUPD(k,nu) = <A href='../../html_code/phys/module_bl_mynn.F.html#QSAT_BLEND'>qsat_blend</A><A href='../../html_code/phys/module_bl_mynn.F.html#TEMF_MF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_BLEND_6">(TUPD(k,nu),p(k-1))<a name='6011'>
                  <font color=#447700>! Correct to actual temperature (Sommeria &amp; Deardorff 1977)<a name='6012'></font>
                  beta1(k) = 0.622 * (xlv/(r_d*TUPD(k,nu))) * (xlv/(cp*TUPD(k,nu)))<a name='6013'>
                  rstUPD(k,nu) = rstUPD(k,nu) * (1.0+beta1(k)*rUPD(k,nu)) / (1.0+beta1(k)*rstUPD(k,nu))<a name='6014'>
                  qstUPD(k,nu) = rstUPD(k,nu) / (1. + rstUPD(k,nu))<a name='6015'>
                  if (rUPD(k,nu) &gt; rstUPD(k,nu)) then<a name='6016'>
                     rlUPD(k,nu) = rUPD(k,nu) - rstUPD(k,nu)<a name='6017'>
                     qlUPD(k,nu) = rlUPD(k,nu) / (1. + rlUPD(k,nu))<a name='6018'>
                     thetavUPDmoist(k,nu) = (thlUPD(k,nu) + ((xlv/cp)*qlUPD(k,nu)/pi1d(k))) * &amp;<a name='6019'>
                                        (1. + 0.608*qstUPD(k,nu) - qlUPD(k,nu))<a name='6020'>
                  else<a name='6021'>
                     rlUPD(k,nu) = 0.<a name='6022'>
                     qlUPD(k,nu) = qc(k-1)   <font color=#447700>! WA 4/6/10 allow environment liquid<a name='6023'></font>
                     thetavUPDmoist(k,nu) = thlUPD(k,nu) * (1. + 0.608*qtUPD(k,nu))<a name='6024'>
                  end if<a name='6025'>
                  Bmoist(k-1) = g * (thetavUPDmoist(k,nu) - thetav(k)) / thetav(k)<a name='6026'>
                  if ( wUPD(k-1,nu) &lt; 1e-15 ) then<a name='6027'>
                     wUPD(k,nu) = 0.<a name='6028'>
                  else<a name='6029'>
                     dwUPDmoistdz(k-1,nu) = -2. *epsmf(k,nu)*wUPD(k-1,nu) + 0.33*Bmoist(k-1)/wUPD(k-1,nu)<a name='6030'>
                     wUPD(k,nu) = wUPD(k-1,nu) + dwUPDmoistdz(k-1,nu) * dzm(k-1)<a name='6031'>
                  end if<a name='6032'>
#if (WRF_CHEM == 1)<a name='6033'>
                  do ic = 1,nchem<a name='6034'>
                     dchemUPDdz(k-1,ic,nu) = -epsmf(k,nu) * (chemUPD(k-1,ic,nu) - chem(k-1,ic))<a name='6035'>
                     chemUPD(k,ic,nu) = chemUPD(k-1,ic,nu) + dchemUPDdz(k-1,ic,nu) * dzm(k-1)<a name='6036'>
                  enddo<a name='6037'>
#endif<a name='6038'>
               else <font color=#447700>! above hmax<a name='6039'></font>
                  thlUPD(k,nu) = thetal(k)<a name='6040'>
                  qtUPD(k,nu) = qtot(k)<a name='6041'>
                  wUPD_dry(k,nu) = 0.<a name='6042'>
                  UUPD(k,nu) = u_temf(k)<a name='6043'>
                  VUPD(k,nu) = v_temf(k)<a name='6044'>
                  TEUPD(k,nu) = qke(k)<a name='6045'>
                  qlUPD(k,nu) = qc(k-1)<a name='6046'>
                  wUPD(k,nu) = 0.<a name='6047'>
#if (WRF_CHEM == 1)<a name='6048'>
                  do ic = 1,nchem<a name='6049'>
                     chemUPD(k,ic,nu) = chem(k-1,ic)<a name='6050'>
                  enddo<a name='6051'>
#endif<a name='6052'>
               end if<a name='6053'>
<a name='6054'>
               IF ( wrf_at_debug_level(MYNN_DBG_LVL) ) THEN<a name='6055'>
                 IF ( ABS(wUPD(k,nu))&gt;10. ) THEN<a name='6056'>
                   WRITE ( mynn_message , FMT='(A,2I3)' ) &amp;<a name='6057'>
                   ' MYNN, in TEMF_MF, huge w at (nu,k):', nu,k<a name='6058'>
                   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#TEMF_MF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_522"> ( 0 , mynn_message )<a name='6059'>
                   print *,"     thlUPD(1:k,nu) = ", thlUPD(1:k,nu)<a name='6060'>
                   print *,"     wUPD(1:k,nu)   = ", wUPD(1:k,nu)<a name='6061'>
                   print *,"     Bmoist(1:k-1)  = ", Bmoist(1:k-1)<a name='6062'>
                   print *,"     epsmf(1:k,nu)  = ", epsmf(1:k,nu)<a name='6063'>
                 ENDIF<a name='6064'>
               ENDIF<a name='6065'>
<a name='6066'>
            ENDDO <font color=#447700>!end-k<a name='6067'></font>
<a name='6068'>
            <font color=#447700>! Find hd based on wUPD<a name='6069'></font>
            if (wUPD_dry(1,nu) == 0.) then<a name='6070'>
               hdidx(nu) = 1<a name='6071'>
            else<a name='6072'>
               hdidx(nu) = kte  <font color=#447700>! In case wUPD &lt;= 0 not found<a name='6073'></font>
               do k = 2,kte<a name='6074'>
                  if (wUPD_dry(k,nu) &lt;= 0. .OR. zm(k) &gt; hmax) then<a name='6075'>
                     hdidx(nu) = k<a name='6076'>
                     <font color=#447700>! goto 100   ! FORTRAN made me do it!<a name='6077'></font>
                     exit<a name='6078'>
                  end if<a name='6079'>
               end do<a name='6080'>
            end if<a name='6081'>
 100                   hd(nu) = zm(hdidx(nu))<a name='6082'>
<a name='6083'>
            <font color=#447700>! Find LCL, hct, and ht<a name='6084'></font>
            lclidx(nu) = kte   <font color=#447700>! In case LCL not found<a name='6085'></font>
            do k = kts,kte<a name='6086'>
               if ( k &lt; hmax_idx .AND. rUPD(k,nu) &gt; rstUPD(k,nu)) then<a name='6087'>
                  lclidx(nu) = k<a name='6088'>
                  <font color=#447700>! goto 200<a name='6089'></font>
                  exit<a name='6090'>
               end if<a name='6091'>
            end do<a name='6092'>
 200                   lcl(nu) = zm(lclidx(nu))<a name='6093'>
<a name='6094'>
            if (hd(nu) &gt; lcl(nu)) then   <font color=#447700>! Forced cloud (at least) occurs<a name='6095'></font>
               <font color=#447700>! Find hct based on wUPDmoist<a name='6096'></font>
               if (wUPD(1,nu) == 0.) then<a name='6097'>
                  hctidx(nu) = 1<a name='6098'>
               else<a name='6099'>
                  hctidx(nu) = kte  <font color=#447700>! In case wUPD &lt;= 0 not found<a name='6100'></font>
                  do k = 2,kte<a name='6101'>
                     if (wUPD(k,nu) &lt;= 0. .OR. zm(k) &gt; hmax) then<a name='6102'>
                        hctidx(nu) = k<a name='6103'>
                        <font color=#447700>! goto 300   ! FORTRAN made me do it!<a name='6104'></font>
                        exit<a name='6105'>
                     end if<a name='6106'>
                  end do<a name='6107'>
               end if<a name='6108'>
 300                         hct(nu) = zm(hctidx(nu))<a name='6109'>
               if (hctidx(nu) &lt;= hdidx(nu)+1) then   <font color=#447700>! No active cloud<a name='6110'></font>
                  hct(nu) = hd(nu)<a name='6111'>
                  hctidx(nu) = hdidx(nu)<a name='6112'>
               else<a name='6113'>
               end if<a name='6114'>
            else   <font color=#447700>! No cloud<a name='6115'></font>
               hct(nu) = hd(nu)<a name='6116'>
               hctidx(nu) = hdidx(nu)<a name='6117'>
            end if<a name='6118'>
            ht(nu) = max(hd(nu),hct(nu))<a name='6119'>
            htidx(nu) = max(hdidx(nu),hctidx(nu))<a name='6120'>
<a name='6121'>
            <font color=#447700>! Now truncate updraft at ht with taper<a name='6122'></font>
            do k = 1,kte<a name='6123'>
               if (zm(k) &lt; 0.9*ht(nu)) then  <font color=#447700>! Below taper region<a name='6124'></font>
                   tval = 1<a name='6125'>
               else if (zm(k) &gt;= 0.9*ht(nu) .AND. zm(k) &lt;= 1.0*ht(nu)) then<a name='6126'>
                  <font color=#447700>! Within taper region<a name='6127'></font>
                  tval = 1. - ((zm(k) - 0.9*ht(nu)) / (1.0*ht(nu) - 0.9*ht(nu)))<a name='6128'>
               else  <font color=#447700>! Above taper region<a name='6129'></font>
                  tval = 0.<a name='6130'>
               end if<a name='6131'>
               thlUPD(k,nu) = tval * thlUPD(k,nu) + (1-tval)*thetal(k)<a name='6132'>
               thetavUPD(k,nu) = tval * thetavUPD(k,nu) + (1-tval)*thetav(k)<a name='6133'>
               qtUPD(k,nu) = tval * qtUPD(k,nu) + (1-tval) * qtot(k)<a name='6134'>
               if (k &gt; 1) then<a name='6135'>
                  qlUPD(k,nu) = tval * qlUPD(k,nu) + (1-tval) * qc(k-1)<a name='6136'>
               end if<a name='6137'>
               UUPD(k,nu) = tval * UUPD(k,nu) + (1-tval) * u_temf(k)<a name='6138'>
               VUPD(k,nu) = tval * VUPD(k,nu) + (1-tval) * v_temf(k)<a name='6139'>
               TEUPD(k,nu) = tval * TEUPD(k,nu) + (1-tval) * qke(k)<a name='6140'>
               if (zm(k) &gt; ht(nu)) then  <font color=#447700>! WA this is just for cleanliness<a name='6141'></font>
                  wUPD(k,nu) = 0.<a name='6142'>
                  dwUPDmoistdz(k,nu) = 0.<a name='6143'>
                  wUPD_dry(k,nu) = 0.<a name='6144'>
                  dwUPDdz(k,nu) = 0.<a name='6145'>
               end if<a name='6146'>
#if (WRF_CHEM == 1)<a name='6147'>
               do ic = 1,nchem<a name='6148'>
                  chemUPD(k,ic,nu) = tval * chemUPD(k,ic,nu) + (1-tval) * chem(k,ic)<a name='6149'>
               enddo<a name='6150'>
#endif<a name='6151'>
            end do<a name='6152'>
<a name='6153'>
            <font color=#447700>! Calculate lateral detrainment rate for cloud layer<a name='6154'></font>
            <font color=#447700>! WA 8/5/15 constant detrainment<a name='6155'></font>
            <font color=#447700>! deltmf(1,nu) = Cepsmf<a name='6156'></font>
            <font color=#447700>! do k = 2,kte-1<a name='6157'></font>
            <font color=#447700>!    deltmf(k,nu) = deltmf(k-1,nu)<a name='6158'></font>
            <font color=#447700>! end do<a name='6159'></font>
            <font color=#447700>! deltmf(kte,nu) = Cepsmf<a name='6160'></font>
            deltmf(:,nu) = epsmf(:,nu)  <font color=#447700>! WA TEST delt = eps everywhere <a name='6161'></font>
<a name='6162'>
            <font color=#447700>! Calculate mass flux (defined on turbulence levels)<a name='6163'></font>
            mf_temfx(1,nu) = CM * wstr / Nupd<a name='6164'>
            <font color=#447700>! WA 3/2/16 limit max MF for stability<a name='6165'></font>
            <font color=#447700>! WA reduce the constant for improved numerical stability?<a name='6166'></font>
            mf_temfx(1,nu) = min(mf_temfx(1,nu),0.2/Nupd)<a name='6167'>
            do kt = 2,kte-1<a name='6168'>
               dMdz(kt,nu) = (epsmf(kt,nu) - deltmf(kt,nu)) * mf_temfx(kt-1,nu) * dzt(kt)<a name='6169'>
               mf_temfx(kt,nu) = mf_temfx(kt-1,nu) + dMdz(kt,nu)<a name='6170'>
               <font color=#447700>! WA TEST 6/14/16 don't allow &lt;0<a name='6171'></font>
               mf_temfx(kt,nu) = max(mf_temfx(kt,nu),0.0)<a name='6172'>
               IF ( wrf_at_debug_level(MYNN_DBG_LVL) ) THEN<a name='6173'>
                  IF ( mf_temfx(kt,nu)&gt;=0.2/NUPD ) THEN<a name='6174'>
                     WRITE ( mynn_message , FMT='(A,2I3)' ) &amp;<a name='6175'>
                     ' MYNN, in TEMF_MF, huge MF at (nu,k):', nu,kt<a name='6176'>
                     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_bl_mynn.F.html#TEMF_MF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_523"> ( 0 , mynn_message )<a name='6177'>
                     print *,"     mf_temfx(1:kt,nu)  = ", mf_temfx(1:kt,nu)<a name='6178'>
                  ENDIF<a name='6179'>
               ENDIF<a name='6180'>
            end do<a name='6181'>
            mf_temfx(kte,nu) = 0.<a name='6182'>
<a name='6183'>
            <font color=#447700>! Calculate cloud fraction (on mass levels)<a name='6184'></font>
            <font color=#447700>! WA eventually replace this with the same saturation calculation<a name='6185'></font>
            <font color=#447700>! used in the MYNN code above for consistency.<a name='6186'></font>
            <font color=#447700>! WA TEST 6/14/16 make sure aUPD(1) is reasonable<a name='6187'></font>
            aUPD(1,nu) = 0.06 / Nupd<a name='6188'>
            do k = 2,kte<a name='6189'>
               <font color=#447700>! WA TEST 6/14/16 increase epsilon in test<a name='6190'></font>
               <font color=#447700>! if (wUPD(k-1,nu) &gt;= 1.0e-15 .AND. wUPD(k,nu) &gt;= 1.0e-15) then<a name='6191'></font>
               if (wUPD(k-1,nu) &gt;= 1.0e-5 .AND. wUPD(k,nu) &gt;= 1.0e-5) then<a name='6192'>
                  aUPD(k,nu) = ((mf_temfx(k-1,nu)+mf_temfx(k,nu))/2.0) / &amp;<a name='6193'>
                         ((wUPD(k-1,nu)+wUPD(k,nu))/2.0)  <font color=#447700>! WA average before divide, is that best?<a name='6194'></font>
               else<a name='6195'>
                  aUPD(k,nu) = 0.0<a name='6196'>
               end if<a name='6197'>
               sigq2 = aUPD(k,nu) * (qtUPD(k,nu)-qtot(k))<a name='6198'>
               if (sigq2 &gt; 0.0) then<a name='6199'>
                  sigq(k) = sqrt(sigq2)<a name='6200'>
               else<a name='6201'>
                  sigq(k) = 0.0<a name='6202'>
               end if<a name='6203'>
               <font color=#447700>!rst = rsat_temf(p(k-1),th(k-1)*pi1d(k-1),ep_2)<a name='6204'></font>
               rst = <A href='../../html_code/phys/module_bl_mynn.F.html#QSAT_BLEND'>qsat_blend</A><A href='../../html_code/phys/module_bl_mynn.F.html#TEMF_MF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_BLEND_7">(th(k-1)*pi1d(k-1),p(k-1))<a name='6205'>
               qst(k) = rst / (1. + rst)<a name='6206'>
               satdef(k) = qtot(k) - qst(k)<a name='6207'>
               if (satdef(k) &lt;= 0.0) then<a name='6208'>
                  if (sigq(k) &gt; 1.0e-15) then<a name='6209'>
                     cldfraUPD(k,nu) = max(0.5 + 0.36 * atan(1.55*(satdef(k)/sigq(k))),0.0) / Nupd<a name='6210'>
                  else<a name='6211'>
                     cldfraUPD(k,nu) = 0.0<a name='6212'>
                  end if<a name='6213'>
               else<a name='6214'>
                  cldfraUPD(k,nu) = 1.0 / Nupd<a name='6215'>
               end if<a name='6216'>
               if (zm(k) &lt; lcl(nu)) then<a name='6217'>
                  cldfraUPD(k,nu) = 0.0<a name='6218'>
               end if<a name='6219'>
            end do<a name='6220'>
<a name='6221'>
         end do  <font color=#447700>! loop over nu updrafts<a name='6222'></font>
<a name='6223'>
         <font color=#447700>! Add updraft areas into edmf_a, etc.<a name='6224'></font>
         <font color=#447700>! Add cloud fractions into cldfra_bl1d<a name='6225'></font>
         <font color=#447700>!cldfra_bl1d(1) = 0.0<a name='6226'></font>
         cfm_temfx = 0.0<a name='6227'>
         do k = 2,kte<a name='6228'>
            <font color=#447700>!cldfra_bl1d(k) = 0.0<a name='6229'></font>
            cldfra_sum = 0.0<a name='6230'>
            edmf_a(k) = 0.0<a name='6231'>
            edmf_w(k) = 0.0<a name='6232'>
            edmf_thl(k) = 0.0<a name='6233'>
            edmf_qt(k) = 0.0<a name='6234'>
            edmf_qc(k) = 0.0<a name='6235'>
            edmf_u(k) = 0.0<a name='6236'>
            edmf_v(k) = 0.0<a name='6237'>
            edmf_qke(k) = 0.0<a name='6238'>
            edmf_ent(k) = 0.0<a name='6239'>
#if (WRF_CHEM == 1)<a name='6240'>
            do ic = 1,nchem<a name='6241'>
               edmf_chem(k,ic) = 0.0<a name='6242'>
            enddo<a name='6243'>
#endif<a name='6244'>
            do nu = 1,Nupd<a name='6245'>
               <font color=#447700>! WA 7/5/16 put area on turbulence levels for consistency<a name='6246'></font>
               aUPDt(k,nu) = mf_temfx(k,nu) / wUPD(k,nu)<a name='6247'>
               if (aUPDt(k,nu) &gt;= 1.0e-3 .AND. wUPD(k,nu) &gt;= 1.0e-5) then<a name='6248'>
                  edmf_a(k) = edmf_a(k) + aUPDt(k,nu)<a name='6249'>
                  edmf_w(k) = edmf_w(k) + aUPDt(k,nu)*wUPD(k,nu)<a name='6250'>
                  edmf_thl(k) = edmf_thl(k) + aUPDt(k,nu)*thlUPD(k,nu)<a name='6251'>
                  edmf_qt(k) = edmf_qt(k) + aUPDt(k,nu)*qtUPD(k,nu)<a name='6252'>
                  edmf_qc(k) = edmf_qc(k) + aUPDt(k,nu)*qlUPD(k,nu)<a name='6253'>
                  edmf_u(k) = edmf_u(k) + aUPDt(k,nu)*UUPD(k,nu)<a name='6254'>
                  edmf_v(k) = edmf_v(k) + aUPDt(k,nu)*VUPD(k,nu)<a name='6255'>
                  edmf_qke(k) = edmf_qke(k) + aUPDt(k,nu)*TEUPD(k,nu)<a name='6256'>
                  edmf_ent(k) = edmf_ent(k) + aUPDt(k,nu)*epsmf(k,nu)<a name='6257'>
                  cldfra_sum = cldfra_sum + cldfraUPD(k,nu)<a name='6258'>
#if (WRF_CHEM == 1)<a name='6259'>
                  do ic = 1,nchem<a name='6260'>
                     edmf_chem(k,ic) = edmf_chem(k,ic) + aUPDt(k,nu)*chemUPD(k,ic,nu)<a name='6261'>
                  enddo<a name='6262'>
#endif<a name='6263'>
               end if<a name='6264'>
            end do<a name='6265'>
<a name='6266'>
            IF ( wrf_at_debug_level(MYNN_DBG_LVL) ) THEN<a name='6267'>
            <font color=#447700>!   print *,"In TEMF_MF edmf_w = ", edmf_w(1:10)<a name='6268'></font>
            <font color=#447700>!   print *,"In TEMF_MF edmf_a = ", edmf_a(1:10)<a name='6269'></font>
            <font color=#447700>!   print *,"In TEMF_MF edmf_thl = ", edmf_thl(1:10)<a name='6270'></font>
            <font color=#447700>!   print *,"In TEMF_MF aUPD(2,:) = ", aUPD(2,:)<a name='6271'></font>
            <font color=#447700>!   print *,"In TEMF_MF wUPD(2,:) = ", wUPD(2,:)<a name='6272'></font>
            <font color=#447700>!   print *,"In TEMF_MF thlUPD(2,:) = ", thlUPD(2,:)<a name='6273'></font>
            ENDIF<a name='6274'>
<a name='6275'>
            <font color=#447700>! WA TEST 6/14/16 don't divide by very small updrafts<a name='6276'></font>
            <font color=#447700>!if (edmf_a(k)&gt;0.) then<a name='6277'></font>
            if (edmf_a(k)&gt;1.e-3) then<a name='6278'>
               edmf_w(k)=edmf_w(k)/edmf_a(k)<a name='6279'>
               edmf_qt(k)=edmf_qt(k)/edmf_a(k)<a name='6280'>
               edmf_thl(k)=edmf_thl(k)/edmf_a(k)<a name='6281'>
               edmf_ent(k)=edmf_ent(k)/edmf_a(k)<a name='6282'>
               edmf_qc(k)=edmf_qc(k)/edmf_a(k)<a name='6283'>
               edmf_u(k)=edmf_u(k)/edmf_a(k)<a name='6284'>
               edmf_v(k)=edmf_v(k)/edmf_a(k)<a name='6285'>
               edmf_qke(k)=edmf_qke(k)/edmf_a(k)<a name='6286'>
#if (WRF_CHEM == 1)<a name='6287'>
               do ic = 1,nchem<a name='6288'>
                  edmf_chem(k,ic) = edmf_chem(k,ic)/edmf_a(k)<a name='6289'>
               enddo<a name='6290'>
#endif<a name='6291'>
<a name='6292'>
               if (edmf_qc(k) &gt; 0.0) then<a name='6293'>
                 IF (cldfra_sum &gt; edmf_a(k)) THEN<a name='6294'>
                   cldfra_bl1d(k) = cldfra_sum<a name='6295'>
                   qc_bl1d(k) = edmf_qc(k)*edmf_a(k)/cldfra_sum<a name='6296'>
                 ELSE<a name='6297'>
                   cldfra_bl1d(k)=edmf_a(k)<a name='6298'>
                   qc_bl1d(k) = edmf_qc(k)<a name='6299'>
                 ENDIF<a name='6300'>
               endif<a name='6301'>
            endif<a name='6302'>
<a name='6303'>
            <font color=#447700>! Put max value so far into cfm<a name='6304'></font>
            if (zt(k) &lt;= hmax) then<a name='6305'>
               cfm_temfx = max(cldfra_bl1d(k),cfm_temfx)<a name='6306'>
            end if<a name='6307'>
         end do<a name='6308'>
<a name='6309'>
         <font color=#447700>!cldfra_bl1d(kte) = 0.0<a name='6310'></font>
<a name='6311'>
         <font color=#447700>! Computing variables needed for solver<a name='6312'></font>
<a name='6313'>
         do k=kts,kte  <font color=#447700>! do these in loop above<a name='6314'></font>
            <font color=#447700>! WA TEST 6/14/16 don't use very small updrafts to be consistent<a name='6315'></font>
            <font color=#447700>! with block above<a name='6316'></font>
            if (edmf_a(k)&gt;1.0e-3) then<a name='6317'>
            s_aw(k)   = edmf_a(k)*edmf_w(k)*psig_w * (1.0+rstoch_col(k))<a name='6318'>
            s_awthl(k)= edmf_a(k)*edmf_w(k)*edmf_thl(k)*psig_w * (1.0+rstoch_col(k)) <a name='6319'>
            s_awqt(k) = edmf_a(k)*edmf_w(k)*edmf_qt(k)*psig_w * (1.0+rstoch_col(k))<a name='6320'>
            s_awqc(k) = edmf_a(k)*edmf_w(k)*edmf_qc(k)*psig_w * (1.0+rstoch_col(k))<a name='6321'>
            s_awqv(k) = s_awqt(k) - s_awqc(k)<a name='6322'>
            s_awu(k)  = edmf_a(k)*edmf_w(k)*edmf_u(k)*psig_w * (1.0+rstoch_col(k)) <a name='6323'>
            s_awv(k)  = edmf_a(k)*edmf_w(k)*edmf_v(k)*psig_w * (1.0+rstoch_col(k))<a name='6324'>
            s_awqke(k) = edmf_a(k)*edmf_w(k)*edmf_qke(k)*psig_w * (1.0+rstoch_col(k))<a name='6325'>
#if (WRF_CHEM == 1)<a name='6326'>
            do ic = 1,nchem<a name='6327'>
               s_awchem(k,ic) = edmf_w(k)*edmf_chem(k,ic)*psig_w * (1.0+rstoch_col(k))<a name='6328'>
            enddo<a name='6329'>
#endif<a name='6330'>
            endif<a name='6331'>
            <font color=#447700>!now reduce diagnostic output array by psig<a name='6332'></font>
             edmf_a(k)=edmf_a(k)*psig_w <a name='6333'>
         enddo<a name='6334'>
<a name='6335'>
      <font color=#447700>! end if   ! is_convective<a name='6336'></font>
      <font color=#447700>! Mass flux block ends here<a name='6337'></font>
      else<a name='6338'>
         edmf_a = 0.<a name='6339'>
         edmf_w = 0.<a name='6340'>
         edmf_qt = 0.<a name='6341'>
         edmf_thl = 0.<a name='6342'>
         edmf_ent = 0.<a name='6343'>
         edmf_u = 0.<a name='6344'>
         edmf_v = 0.<a name='6345'>
         edmf_qke = 0.<a name='6346'>
         s_aw   = 0.<a name='6347'>
         s_awthl= 0.<a name='6348'>
         s_awqt = 0.<a name='6349'>
         s_awqv = 0.<a name='6350'>
         s_awqc = 0.<a name='6351'>
         s_awu  = 0.<a name='6352'>
         s_awv  = 0.<a name='6353'>
         s_awqke= 0.<a name='6354'>
         edmf_qc(1) = qc(1)<a name='6355'>
         <font color=#447700>!qc_bl1d(1) = qc(1)<a name='6356'></font>
         do k = kts+1,kte-1<a name='6357'>
            edmf_qc(k) = qc(k-1)<a name='6358'>
            <font color=#447700>!qc_bl1d(k) = qc(k-1)<a name='6359'></font>
         end do<a name='6360'>
#if (WRF_CHEM == 1)<a name='6361'>
         do ic = 1,nchem<a name='6362'>
            s_awchem(:,ic) = 0.<a name='6363'>
         enddo<a name='6364'>
#endif<a name='6365'>
      end if<a name='6366'>
      <font color=#447700>!edmf_qc(kte) = qc(kte)<a name='6367'></font>
      <font color=#447700>!qc_bl1d(kte) = qc(kte)<a name='6368'></font>
<a name='6369'>
      <font color=#447700>!IF ( wrf_at_debug_level(MYNN_DBG_LVL) ) THEN<a name='6370'></font>
      <font color=#447700>!   print *,"After TEMF_MF, s_aw = ", s_aw(1:5)<a name='6371'></font>
      <font color=#447700>!   print *,"After TEMF_MF, s_awthl = ", s_awthl(1:5)<a name='6372'></font>
      <font color=#447700>!   print *,"After TEMF_MF, s_awqt = ", s_awqt(1:5)<a name='6373'></font>
      <font color=#447700>!   print *,"After TEMF_MF, s_awqc = ", s_awqc(1:5)<a name='6374'></font>
      <font color=#447700>!   print *,"After TEMF_MF, s_awqv = ", s_awqv(1:5)<a name='6375'></font>
      <font color=#447700>!   print *,"After TEMF_MF, s_awu = ", s_awu(1:5)<a name='6376'></font>
      <font color=#447700>!   print *,"After TEMF_MF, s_awv = ", s_awv(1:5)<a name='6377'></font>
      <font color=#447700>!   print *,"After TEMF_MF, s_awqke = ", s_awqke(1:5)<a name='6378'></font>
      <font color=#447700>!ENDIF<a name='6379'></font>
<a name='6380'>
END SUBROUTINE temf_mf<a name='6381'>
<a name='6382'>
<font color=#447700>!--------------------------------------------------------------------<a name='6383'></font>
<font color=#447700>!<a name='6384'></font>
<A NAME='RSAT_TEMF'><A href='../../html_code/phys/module_bl_mynn.F.html#RSAT_TEMF' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='6385'>
   real <font color=#993300>function </font><font color=#cc0000>rsat_temf</font>(p,T,ep2) <A href='../../call_to/RSAT_TEMF.html' TARGET='index'>2</A><a name='6386'>
<a name='6387'>
<font color=#447700>!  Calculates the saturation mixing ratio with respect to liquid water<a name='6388'></font>
<font color=#447700>!  Arguments are pressure (Pa) and absolute temperature (K)<a name='6389'></font>
<font color=#447700>!  Uses the formula from the ARM intercomparison setup.<a name='6390'></font>
<font color=#447700>!  Converted from Matlab by WA 7/28/08<a name='6391'></font>
<a name='6392'>
implicit none<a name='6393'>
real p, T, ep2<a name='6394'>
real temp, x<a name='6395'>
real, parameter :: c0 = 0.6105851e+3<a name='6396'>
real, parameter :: c1 = 0.4440316e+2<a name='6397'>
real, parameter :: c2 = 0.1430341e+1<a name='6398'>
real, parameter :: c3 = 0.2641412e-1<a name='6399'>
real, parameter :: c4 = 0.2995057e-3<a name='6400'>
real, parameter :: c5 = 0.2031998e-5<a name='6401'>
real, parameter :: c6 = 0.6936113e-8<a name='6402'>
real, parameter :: c7 = 0.2564861e-11<a name='6403'>
real, parameter :: c8 = -0.3704404e-13<a name='6404'>
<a name='6405'>
temp = T - 273.15<a name='6406'>
<a name='6407'>
x =c0+temp*(c1+temp*(c2+temp*(c3+temp*(c4+temp*(c5+temp*(c6+temp*(c7+temp*c8)))))))<a name='6408'>
rsat_temf = ep2*x/(p-x)<a name='6409'>
<a name='6410'>
return<a name='6411'>
end function rsat_temf<a name='6412'>
<a name='6413'>
<font color=#447700>!=================================================================<a name='6414'></font>
<a name='6415'>
END MODULE module_bl_mynn<a name='6416'>
</pre></body></html>