<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MEDIATION_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_RADIATION_DRIVER'><A href='../../html_code/phys/module_radiation_driver.F.html#MODULE_RADIATION_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
<font color=#993300>MODULE </font><font color=#cc0000>module_radiation_driver</font> <A href='../../call_to/MODULE_RADIATION_DRIVER.html' TARGET='index'>3</A><a name='5'>
CONTAINS<a name='6'>
<font color=#447700>!BOP<a name='7'></font>
<font color=#447700>! !IROUTINE: radiation_driver - interface to radiation physics options<a name='8'></font>
<a name='9'>
<font color=#447700>! !INTERFACE:<a name='10'></font>
<A NAME='RADIATION_DRIVER'><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='11'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>radiation_driver</font> (                                  &amp; <A href='../../call_to/RADIATION_DRIVER.html' TARGET='index'>2</A>,<A href='../../call_from/RADIATION_DRIVER.html' TARGET='index'>96</A><a name='12'>
               ACFRCV ,ACFRST ,ALBEDO  &amp;<a name='13'>
              ,CFRACH ,CFRACL ,CFRACM  &amp;<a name='14'>
              ,CUPPT  ,CZMEAN ,DT      &amp;<a name='15'>
              ,DZ8W   ,EMISS  ,GLW     &amp;<a name='16'>
              ,GMT    ,GSW    ,HBOT    &amp;<a name='17'>
              ,HTOP   ,HBOTR  ,HTOPR   &amp;<a name='18'>
              ,ICLOUD                  &amp;<a name='19'>
              ,ITIMESTEP,JULDAY, JULIAN &amp;<a name='20'>
              ,JULYR  ,LW_PHYSICS       &amp;<a name='21'>
              ,NCFRCV ,NCFRST ,NPHS     &amp;<a name='22'>
              ,O3INPUT, O3RAD           &amp;<a name='23'>
              ,AER_OPT, aerod           &amp;<a name='24'>
              ,swint_opt                &amp;<a name='25'>
              ,P8W    ,P ,PI            &amp;<a name='26'>
              ,p_top                    &amp;<a name='27'>
              ,RADT   ,RA_CALL_OFFSET   &amp;<a name='28'>
              ,RHO    ,RLWTOA           &amp;<a name='29'>
              ,RSWTOA ,RTHRATEN         &amp;<a name='30'>
              ,RTHRATENLW      ,RTHRATENSW    &amp;<a name='31'>
              ,SNOW   ,STEPRA ,SWDOWN  &amp;<a name='32'>
              ,SWDOWNC ,SW_PHYSICS     &amp;<a name='33'>
              ,T8W     ,T ,TAUCLDC &amp;<a name='34'>
              ,TAUCLDI ,TSK ,VEGFRA  &amp;<a name='35'>
              ,WARM_RAIN ,XICE ,XLAND   &amp;<a name='36'>
              ,XLAT ,XLONG ,YR          &amp;<a name='37'>
<font color=#447700>!Optional solar variables<a name='38'></font>
              ,DECLINX ,SOLCONX ,COSZEN ,HRANG    &amp;<a name='39'>
              , CEN_LAT                                      &amp;<a name='40'>
              ,Z                                             &amp;<a name='41'>
              ,ALEVSIZ, no_src_types               &amp;<a name='42'>
              ,LEVSIZ, N_OZMIXM                    &amp;<a name='43'>
              ,N_AEROSOLC                                    &amp;<a name='44'>
              ,PAERLEV   ,ID                                 &amp;<a name='45'>
              ,CAM_ABS_DIM1, CAM_ABS_DIM2 &amp;<a name='46'>
              ,CAM_ABS_FREQ_S                         &amp;<a name='47'>
              ,XTIME                                           &amp;<a name='48'>
              ,CURR_SECS, ADAPT_STEP_FLAG       &amp;<a name='49'>
              <font color=#447700>!BSINGH - For WRFCuP scheme (optional args)<a name='50'></font>
              ,cu_physics,shallowcu_forced_ra   &amp; <font color=#447700>!CuP, wig 1-Oct-2006<a name='51'></font>
              ,cubot,cutop,cldfra_cup           &amp; <font color=#447700>!CuP, wig 1-Oct-2006<a name='52'></font>
              ,shall                            &amp; <font color=#447700>!CuP, wig 4-Feb-2008<a name='53'></font>
              <font color=#447700>!BSINGH - ENDS<a name='54'></font>
            <font color=#447700>! indexes<a name='55'></font>
              ,IDS,IDE, JDS,JDE, KDS,KDE          &amp;<a name='56'>
              ,IMS,IME, JMS,JME, KMS,KME          &amp;<a name='57'>
              ,i_start,i_end          &amp;<a name='58'>
              ,j_start,j_end          &amp;<a name='59'>
              ,kts, kte                          &amp;<a name='60'>
              ,num_tiles                                   &amp;<a name='61'>
            <font color=#447700>! Optional<a name='62'></font>
              , TLWDN, TLWUP                        &amp; <font color=#447700>! goddard schemes<a name='63'></font>
              , SLWDN, SLWUP                        &amp; <font color=#447700>! goddard schemes<a name='64'></font>
              , TSWDN, TSWUP                        &amp; <font color=#447700>! goddard schemes<a name='65'></font>
              , SSWDN, SSWUP                        &amp; <font color=#447700>! goddard schemes<a name='66'></font>
              , CLDFRA,CLDFRA_MP_ALL,CLDT,ZNU       &amp;<a name='67'>
#if (EM_CORE == 1)<a name='68'>
              , lradius,iradius                     &amp;<a name='69'>
#endif<a name='70'>
              , cldfra_dp, cldfra_sh                &amp; <font color=#447700>! ckay for sub-grid cloud fraction<a name='71'></font>
              , re_cloud, re_ice, re_snow           &amp; <font color=#447700>! G. Thompson<a name='72'></font>
              , has_reqc, has_reqi, has_reqs        &amp; <font color=#447700>! G. Thompson<a name='73'></font>
              , PB                                                &amp;<a name='74'>
              , F_ICE_PHY,F_RAIN_PHY       &amp;<a name='75'>
              , QV, F_QV                     &amp;<a name='76'>
              , QC, F_QC                     &amp;<a name='77'>
              , QR, F_QR                     &amp;<a name='78'>
              , QI, F_QI                     &amp;<a name='79'>
              , QS, F_QS                     &amp;<a name='80'>
              , QG, F_QG                     &amp;<a name='81'>
              , QNDROP, F_QNDROP    &amp;<a name='82'>
              ,QNIFA,F_QNIFA                  &amp;   <font color=#447700>! trude<a name='83'></font>
              ,QNWFA,F_QNWFA                  &amp;   <font color=#447700>! trude<a name='84'></font>
              ,ACSWUPT   ,ACSWUPTC            &amp;<a name='85'>
              ,ACSWDNT   ,ACSWDNTC            &amp;<a name='86'>
              ,ACSWUPB   ,ACSWUPBC            &amp;<a name='87'>
              ,ACSWDNB   ,ACSWDNBC            &amp;<a name='88'>
              ,ACLWUPT   ,ACLWUPTC            &amp;<a name='89'>
              ,ACLWDNT   ,ACLWDNTC            &amp;<a name='90'>
              ,ACLWUPB   ,ACLWUPBC            &amp;<a name='91'>
              ,ACLWDNB   ,ACLWDNBC            &amp;<a name='92'>
              ,SWUPT ,SWUPTC                  &amp;<a name='93'>
              ,SWDNT ,SWDNTC                  &amp;<a name='94'>
              ,SWUPB ,SWUPBC                  &amp;<a name='95'>
              ,SWDNB ,SWDNBC                  &amp;<a name='96'>
              ,LWUPT ,LWUPTC                  &amp;<a name='97'>
              ,LWDNT ,LWDNTC                  &amp;<a name='98'>
              ,LWUPB ,LWUPBC                  &amp;<a name='99'>
              ,LWDNB ,LWDNBC                  &amp;<a name='100'>
              ,LWCF                           &amp;<a name='101'>
              ,SWCF                           &amp;<a name='102'>
              ,OLR                            &amp;<a name='103'>
              ,aerodm, PINA, aodtot           &amp;<a name='104'>
              ,OZMIXM, PIN                    &amp;<a name='105'>
              ,M_PS_1, M_PS_2, AEROSOLC_1     &amp;<a name='106'>
              ,AEROSOLC_2, M_HYBI0            &amp;<a name='107'>
              ,ABSTOT, ABSNXT, EMSTOT         &amp;<a name='108'>
              ,ICLOUD_CU                      &amp;<a name='109'>
              ,AER_RA_FEEDBACK                &amp;<a name='110'>
              ,QC_CU , QI_CU                  &amp;<a name='111'>
              ,icloud_bl,qc_bl,cldfra_bl     &amp; <font color=#447700>!JOE-subgrid bl clouds<a name='112'></font>
              ,PM2_5_DRY, PM2_5_WATER         &amp;<a name='113'>
              ,PM2_5_DRY_EC                   &amp;<a name='114'>
              ,TAUAER300, TAUAER400 &amp; <font color=#447700>! jcb<a name='115'></font>
              ,TAUAER600, TAUAER999 &amp; <font color=#447700>! jcb<a name='116'></font>
              ,GAER300, GAER400, GAER600, GAER999 &amp; <font color=#447700>! jcb<a name='117'></font>
              ,WAER300, WAER400, WAER600, WAER999 &amp; <font color=#447700>! jcb<a name='118'></font>
              ,TAUAERlw1,  TAUAERlw2  &amp;<a name='119'>
              ,TAUAERlw3,  TAUAERlw4  &amp;<a name='120'>
              ,TAUAERlw5,  TAUAERlw6  &amp;<a name='121'>
              ,TAUAERlw7,  TAUAERlw8  &amp;<a name='122'>
              ,TAUAERlw9,  TAUAERlw10   &amp;<a name='123'>
              ,TAUAERlw11, TAUAERlw12   &amp;<a name='124'>
              ,TAUAERlw13, TAUAERlw14   &amp;<a name='125'>
              ,TAUAERlw15, TAUAERlw16  &amp;<a name='126'>
              ,progn                                            &amp;<a name='127'>
              ,slope_rad,topo_shading     &amp;<a name='128'>
              ,shadowmask,ht,dx,dy                 &amp;<a name='129'>
              ,dxkm                                                       &amp;<a name='130'>
              ,diffuse_frac               &amp;<a name='131'>
              ,SWUPFLX,SWUPFLXC,SWDNFLX,SWDNFLXC                          &amp; <font color=#447700>! Optional<a name='132'></font>
              ,LWUPFLX,LWUPFLXC,LWDNFLX,LWDNFLXC                          &amp; <font color=#447700>! Optional<a name='133'></font>
              ,radtacttime                                                &amp;<a name='134'>
              ,ALSWVISDIR, ALSWVISDIF, ALSWNIRDIR, ALSWNIRDIF             &amp; <font color=#447700>!fds ssib alb comp (06/2010)<a name='135'></font>
              ,SWVISDIR, SWVISDIF, SWNIRDIR, SWNIRDIF                     &amp; <font color=#447700>!fds ssib swr comp (06/2010)<a name='136'></font>
              ,SF_SURFACE_PHYSICS, IS_CAMMGMP_USED                        &amp; <font color=#447700>!fds<a name='137'></font>
              ,EXPLICIT_CONVECTION                                        &amp; <font color=#447700>! .true.=no conv. scheme<a name='138'></font>
              ,swddir,swddni,swddif                                       &amp; <font color=#447700>! jararias 2013/08<a name='139'></font>
              ,swdown_ref,swddir_ref,coszen_ref,Gx,gg,Bx,bb               &amp;<a name='140'>
              ,aer_type                                                   &amp; <font color=#447700>! jararias 2013/11<a name='141'></font>
              ,aer_aod550_opt, aer_aod550_val                             &amp;<a name='142'>
              ,aer_angexp_opt, aer_angexp_val                             &amp;<a name='143'>
              ,aer_ssa_opt, aer_ssa_val                                   &amp;<a name='144'>
              ,aer_asy_opt, aer_asy_val                                   &amp;<a name='145'>
              ,aod5502d, angexp2d, aerssa2d, aerasy2d                     &amp;<a name='146'>
              ,aod5503d                                                   &amp;<a name='147'>
              ,taod5502d, taod5503d                                       &amp; <font color=#447700>!  Trude<a name='148'></font>
              ,mp_physics                                                 &amp;<a name='149'>
                                                                          )<a name='150'>
<a name='151'>
<a name='152'>
<font color=#447700>!-------------------------------------------------------------------------<a name='153'></font>
<a name='154'>
<font color=#447700>! !USES:<a name='155'></font>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_148">, ONLY : RRTMSCHEME, GFDLLWSCHEME        &amp;<a name='156'>
                                       ,RRTMG_LWSCHEME, RRTMG_SWSCHEME  &amp;<a name='157'>
                                       ,RRTMG_LWSCHEME_FAST, RRTMG_SWSCHEME_FAST  &amp;<a name='158'>
                                       ,SWRADSCHEME, GSFCSWSCHEME       &amp;<a name='159'>
                                       ,GFDLSWSCHEME, CAMLWSCHEME, CAMSWSCHEME &amp;<a name='160'>
                                       ,HELDSUAREZ                      &amp;<a name='161'>
#if ( HWRF == 1 )<a name='162'>
                                       ,HWRFSWSCHEME, HWRFLWSCHEME  &amp;<a name='163'>
#endif<a name='164'>
                                       ,goddardlwscheme                 &amp; <a name='165'>
                                       ,goddardswscheme                 &amp;  <a name='166'>
                                       ,KFCUPSCHEME                     &amp; <font color=#447700>!BSINGH - Added KFCUPSCHEME for WRFCuP scheme<a name='167'></font>
                                       ,FLGLWSCHEME, FLGSWSCHEME<a name='168'>
<a name='169'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_87"><a name='170'>
#ifndef HWRF<a name='171'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_82"> , ONLY : wrf_err_message<a name='172'>
#endif<a name='173'>
<a name='174'>
<font color=#447700>! *** add new modules of schemes here<a name='175'></font>
<a name='176'>
   USE <A href='../../html_code/phys/module_ra_sw.F.html#MODULE_RA_SW'>module_ra_sw</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_SW_2">         , ONLY : swrad<a name='177'>
   USE <A href='../../html_code/phys/module_ra_gsfcsw.F.html#MODULE_RA_GSFCSW'>module_ra_gsfcsw</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_GSFCSW_2">     , ONLY : gsfcswrad<a name='178'>
   USE <A href='../../html_code/phys/module_ra_rrtm.F.html#MODULE_RA_RRTM'>module_ra_rrtm</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_RRTM_2">       , ONLY : rrtmlwrad<a name='179'>
   USE <A href='../../html_code/phys/module_ra_rrtmg_lw.F.html#MODULE_RA_RRTMG_LW'>module_ra_rrtmg_lw</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_RRTMG_LW_3">   , ONLY : rrtmg_lwrad<a name='180'>
   USE <A href='../../html_code/phys/module_ra_rrtmg_sw.F.html#MODULE_RA_RRTMG_SW'>module_ra_rrtmg_sw</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_RRTMG_SW_2">   , ONLY : rrtmg_swrad<a name='181'>
   USE <A href='../../html_code/phys/module_ra_rrtmg_lwf.F.html#MODULE_RA_RRTMG_LWF'>module_ra_rrtmg_lwf</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_RRTMG_LWF_3">  , ONLY : rrtmg_lwrad_fast<a name='182'>
   USE <A href='../../html_code/phys/module_ra_rrtmg_swf.F.html#MODULE_RA_RRTMG_SWF'>module_ra_rrtmg_swf</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_RRTMG_SWF_2">  , ONLY : rrtmg_swrad_fast<a name='183'>
   USE <A href='../../html_code/phys/module_ra_cam.F.html#MODULE_RA_CAM'>module_ra_cam</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_CAM_2">        , ONLY : camrad<a name='184'>
   USE <A href='../../html_code/phys/module_ra_gfdleta.F.html#MODULE_RA_GFDLETA'>module_ra_gfdleta</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_GFDLETA_4">    , ONLY : etara<a name='185'>
#if ( HWRF == 1 )<a name='186'>
   USE <A href='../../html_code/phys/module_ra_HWRF.F.html#MODULE_RA_HWRF'>module_ra_hwrf</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_HWRF_2"><a name='187'>
#endif<a name='188'>
   USE <A href='../../html_code/phys/module_ra_hs.F.html#MODULE_RA_HS'>module_ra_hs</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_HS_2">         , ONLY : hsrad<a name='189'>
<a name='190'>
   USE <A href='../../html_code/phys/module_ra_goddard.F.html#MODULE_RA_GODDARD'>module_ra_goddard</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_GODDARD_1">    , ONLY : goddardrad<a name='191'>
   USE <A href='../../html_code/phys/module_ra_flg.F.html#MODULE_RA_FLG'>module_ra_flg</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_FLG_1">        , ONLY : RAD_FLG<a name='192'>
<a name='193'>
   USE <A href='../../html_code/phys/module_ra_aerosol.F.html#MODULE_RA_AEROSOL'>module_ra_aerosol</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_AEROSOL_1">    , ONLY : calc_aerosol_goddard_sw, &amp;<a name='194'>
                                     calc_aerosol_rrtmg_sw<a name='195'>
<a name='196'>
   <font color=#447700>!  This driver calls subroutines for the radiation parameterizations.<a name='197'></font>
   <font color=#447700>!<a name='198'></font>
   <font color=#447700>!  short wave radiation choices:<a name='199'></font>
   <font color=#447700>!  1. swrad (19??)<a name='200'></font>
   <font color=#447700>!  4. rrtmg_sw - Added November 2008, MJIacono, AER, Inc.<a name='201'></font>
   <font color=#447700>!<a name='202'></font>
   <font color=#447700>!  long wave radiation choices:<a name='203'></font>
   <font color=#447700>!  1. rrtmlwrad<a name='204'></font>
   <font color=#447700>!  4. rrtmg_lw - Added November 2008, MJIacono, AER, Inc.<a name='205'></font>
   <font color=#447700>!<a name='206'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='207'></font>
   IMPLICIT NONE<a name='208'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='209'></font>
<font color=#447700>!<a name='210'></font>
<font color=#447700>! Radiation_driver is the WRF mediation layer routine that provides the interface to<a name='211'></font>
<font color=#447700>! to radiation physics packages in the WRF model layer. The radiation<a name='212'></font>
<font color=#447700>! physics packages to call are chosen by setting the namelist variable<a name='213'></font>
<font color=#447700>! (Rconfig entry in Registry) to the integer value assigned to the <a name='214'></font>
<font color=#447700>! particular package (package entry in Registry). For example, if the<a name='215'></font>
<font color=#447700>! namelist variable ra_lw_physics is set to 1, this corresponds to the<a name='216'></font>
<font color=#447700>! Registry Package entry for swradscheme.  Note that the Package<a name='217'></font>
<font color=#447700>! names in the Registry are defined constants (frame/module_state_description.F)<a name='218'></font>
<font color=#447700>! in the CASE statements in this routine.<a name='219'></font>
<font color=#447700>!<a name='220'></font>
<font color=#447700>! Among the arguments is moist, a four-dimensional scalar array storing<a name='221'></font>
<font color=#447700>! a variable number of moisture tracers, depending on the physics <a name='222'></font>
<font color=#447700>! configuration for the WRF run, as determined in the namelist.  The<a name='223'></font>
<font color=#447700>! highest numbered index of active moisture tracers the integer argument<a name='224'></font>
<font color=#447700>! n_moist (note: the number of tracers at run time is the quantity<a name='225'></font>
<font color=#447700>! &lt;tt&gt;n_moist - PARAM_FIRST_SCALAR + 1&lt;/tt&gt; , not n_moist. Individual tracers<a name='226'></font>
<font color=#447700>! may be indexed from moist by the Registry name of the tracer prepended<a name='227'></font>
<font color=#447700>! with P_; for example P_QC is the index of cloud water. An index <a name='228'></font>
<font color=#447700>! represents a valid, active field only if the index is greater than<a name='229'></font>
<font color=#447700>! or equal to PARAM_FIRST_SCALAR.  PARAM_FIRST_SCALAR and the individual<a name='230'></font>
<font color=#447700>! indices for each tracer is defined in module_state_description and<a name='231'></font>
<font color=#447700>! set in &lt;a href=set_scalar_indices_from_config.html&gt;set_scalar_indices_from_config&lt;/a&gt; defined in frame/module_configure.F.<a name='232'></font>
<font color=#447700>!<a name='233'></font>
<font color=#447700>! Physics drivers in WRF 2.0 and higher, originally model-layer <a name='234'></font>
<font color=#447700>! routines, have been promoted to mediation layer routines and they<a name='235'></font>
<font color=#447700>! contain OpenMP threaded loops over tiles.  Thus, physics drivers<a name='236'></font>
<font color=#447700>! are called from single-threaded regions in the solver. The physics<a name='237'></font>
<font color=#447700>! routines that are called from the physics drivers are model-layer<a name='238'></font>
<font color=#447700>! routines and fully tile-callable and thread-safe.<a name='239'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='240'></font>
<font color=#447700>! <a name='241'></font>
<font color=#447700>!======================================================================<a name='242'></font>
<font color=#447700>! Grid structure in physics part of WRF<a name='243'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='244'></font>
<font color=#447700>! The horizontal velocities used in the physics are unstaggered<a name='245'></font>
<font color=#447700>! relative to temperature/moisture variables. All predicted<a name='246'></font>
<font color=#447700>! variables are carried at half levels except w, which is at full<a name='247'></font>
<font color=#447700>! levels. Some arrays with names (*8w) are at w (full) levels.<a name='248'></font>
<font color=#447700>!<a name='249'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='250'></font>
<font color=#447700>! In WRF, kms (smallest number) is the bottom level and kme (largest<a name='251'></font>
<font color=#447700>! number) is the top level.  In your scheme, if 1 is at the top level,<a name='252'></font>
<font color=#447700>! then you have to reverse the order in the k direction.<a name='253'></font>
<font color=#447700>!<a name='254'></font>
<font color=#447700>!         kme      -   half level (no data at this level)<a name='255'></font>
<font color=#447700>!         kme    ----- full level<a name='256'></font>
<font color=#447700>!         kme-1    -   half level<a name='257'></font>
<font color=#447700>!         kme-1  ----- full level<a name='258'></font>
<font color=#447700>!         .<a name='259'></font>
<font color=#447700>!         .<a name='260'></font>
<font color=#447700>!         .<a name='261'></font>
<font color=#447700>!         kms+2    -   half level<a name='262'></font>
<font color=#447700>!         kms+2  ----- full level<a name='263'></font>
<font color=#447700>!         kms+1    -   half level<a name='264'></font>
<font color=#447700>!         kms+1  ----- full level<a name='265'></font>
<font color=#447700>!         kms      -   half level<a name='266'></font>
<font color=#447700>!         kms    ----- full level<a name='267'></font>
<font color=#447700>!<a name='268'></font>
<font color=#447700>!======================================================================<a name='269'></font>
<font color=#447700>! Grid structure in physics part of WRF<a name='270'></font>
<font color=#447700>! <a name='271'></font>
<font color=#447700>!-------------------------------------<a name='272'></font>
<font color=#447700>! The horizontal velocities used in the physics are unstaggered <a name='273'></font>
<font color=#447700>! relative to temperature/moisture variables. All predicted <a name='274'></font>
<font color=#447700>! variables are carried at half levels except w, which is at full <a name='275'></font>
<font color=#447700>! levels. Some arrays with names (*8w) are at w (full) levels.<a name='276'></font>
<font color=#447700>!<a name='277'></font>
<font color=#447700>!==================================================================<a name='278'></font>
<font color=#447700>! Definitions<a name='279'></font>
<font color=#447700>!-----------<a name='280'></font>
<font color=#447700>! Theta      potential temperature (K)<a name='281'></font>
<font color=#447700>! Qv         water vapor mixing ratio (kg/kg)<a name='282'></font>
<font color=#447700>! Qc         cloud water mixing ratio (kg/kg)<a name='283'></font>
<font color=#447700>! Qr         rain water mixing ratio (kg/kg)<a name='284'></font>
<font color=#447700>! Qi         cloud ice mixing ratio (kg/kg)<a name='285'></font>
<font color=#447700>! Qs         snow mixing ratio (kg/kg)<a name='286'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='287'></font>
<font color=#447700>!-- PM2_5_DRY     Dry PM2.5 aerosol mass for all species (ug m^-3)<a name='288'></font>
<font color=#447700>!-- PM2_5_WATER   PM2.5 water mass (ug m^-3)<a name='289'></font>
<font color=#447700>!-- PM2_5_DRY_EC  Dry PM2.5 elemental carbon aersol mass (ug m^-3)<a name='290'></font>
<font color=#447700>!-- RTHRATEN      Theta tendency <a name='291'></font>
<font color=#447700>!                 due to radiation (K/s)<a name='292'></font>
<font color=#447700>!-- RTHRATENLW    Theta tendency <a name='293'></font>
<font color=#447700>!                 due to long wave radiation (K/s)<a name='294'></font>
<font color=#447700>!-- RTHRATENSW    Theta temperature tendency <a name='295'></font>
<font color=#447700>!                 due to short wave radiation (K/s)<a name='296'></font>
<font color=#447700>!-- dt            time step (s)<a name='297'></font>
<font color=#447700>!-- itimestep     number of time steps<a name='298'></font>
<font color=#447700>!-- GLW           downward long wave flux at ground surface (W/m^2)<a name='299'></font>
<font color=#447700>!-- GSW           net short wave flux at ground surface (W/m^2)<a name='300'></font>
<font color=#447700>!-- SWDOWN        downward short wave flux at ground surface (W/m^2)<a name='301'></font>
<font color=#447700>!-- SWDOWNC       clear-sky downward short wave flux at ground surface (W/m^2; optional; for AQ)<a name='302'></font>
<font color=#447700>!-- RLWTOA        upward long wave at top of atmosphere (w/m2)<a name='303'></font>
<font color=#447700>!-- RSWTOA        upward short wave at top of atmosphere (w/m2)<a name='304'></font>
<font color=#447700>!-- XLAT          latitude, south is negative (degree)<a name='305'></font>
<font color=#447700>!-- XLONG         longitude, west is negative (degree)<a name='306'></font>
<font color=#447700>!-- ALBEDO        albedo (between 0 and 1)<a name='307'></font>
<font color=#447700>!-- CLDFRA        cloud fraction (between 0 and 1)<a name='308'></font>
<font color=#447700>!-- CLDFRA_DP     cloud fraction from deep cloud in a cumulus scheme<a name='309'></font>
<font color=#447700>!-- CLDFRA_SH     cloud fraction from shallow cloud in a cumulus scheme<a name='310'></font>
<font color=#447700>!-- CLDFRA_MP_ALL cloud fraction from CAMMGMP microphysics scheme<a name='311'></font>
<font color=#447700>!-- EMISS         surface emissivity (between 0 and 1)<a name='312'></font>
<font color=#447700>!-- rho_phy       density (kg/m^3)<a name='313'></font>
<font color=#447700>!-- rr            dry air density (kg/m^3)<a name='314'></font>
<font color=#447700>!-- moist         moisture array (4D - last index is species) (kg/kg)<a name='315'></font>
<font color=#447700>!-- n_moist       number of moisture species<a name='316'></font>
<font color=#447700>!-- qndrop        Cloud droplet number (#/kg)<a name='317'></font>
<font color=#447700>!-- p8w           pressure at full levels (Pa)<a name='318'></font>
<font color=#447700>!-- p_phy         pressure (Pa)<a name='319'></font>
<font color=#447700>!-- Pb            base-state pressure (Pa)<a name='320'></font>
<font color=#447700>!-- pi_phy        exner function (dimensionless)<a name='321'></font>
<font color=#447700>!-- dz8w          dz between full levels (m)<a name='322'></font>
<font color=#447700>!-- t_phy         temperature (K)<a name='323'></font>
<font color=#447700>!-- t8w           temperature at full levels (K)<a name='324'></font>
<font color=#447700>!-- GMT           Greenwich Mean Time Hour of model start (hour)<a name='325'></font>
<font color=#447700>!-- JULDAY        the initial day (Julian day)<a name='326'></font>
<font color=#447700>!-- RADT          time for calling radiation (min)<a name='327'></font>
<font color=#447700>!-- ra_call_offset -1 (old) means usually just before output, 0 after<a name='328'></font>
<font color=#447700>!-- DEGRAD        conversion factor for <a name='329'></font>
<font color=#447700>!                 degrees to radians (pi/180.) (rad/deg)<a name='330'></font>
<font color=#447700>!-- DPD           degrees per day for earth's <a name='331'></font>
<font color=#447700>!                 orbital position (deg/day)<a name='332'></font>
<font color=#447700>!-- R_d           gas constant for dry air (J/kg/K)<a name='333'></font>
<font color=#447700>!-- CP            heat capacity at constant pressure for dry air (J/kg/K)<a name='334'></font>
<font color=#447700>!-- G             acceleration due to gravity (m/s^2)<a name='335'></font>
<font color=#447700>!-- rvovrd        R_v divided by R_d (dimensionless)<a name='336'></font>
<font color=#447700>!-- XTIME         time since simulation start (min)<a name='337'></font>
<font color=#447700>!-- DECLIN        solar declination angle (rad)<a name='338'></font>
<font color=#447700>!-- SOLCON        solar constant (W/m^2)<a name='339'></font>
<font color=#447700>!-- ids           start index for i in domain<a name='340'></font>
<font color=#447700>!-- ide           end index for i in domain<a name='341'></font>
<font color=#447700>!-- jds           start index for j in domain<a name='342'></font>
<font color=#447700>!-- jde           end index for j in domain<a name='343'></font>
<font color=#447700>!-- kds           start index for k in domain<a name='344'></font>
<font color=#447700>!-- kde           end index for k in domain<a name='345'></font>
<font color=#447700>!-- ims           start index for i in memory<a name='346'></font>
<font color=#447700>!-- ime           end index for i in memory<a name='347'></font>
<font color=#447700>!-- jms           start index for j in memory<a name='348'></font>
<font color=#447700>!-- jme           end index for j in memory<a name='349'></font>
<font color=#447700>!-- kms           start index for k in memory<a name='350'></font>
<font color=#447700>!-- kme           end index for k in memory<a name='351'></font>
<font color=#447700>!-- i_start       start indices for i in tile<a name='352'></font>
<font color=#447700>!-- i_end         end indices for i in tile<a name='353'></font>
<font color=#447700>!-- j_start       start indices for j in tile<a name='354'></font>
<font color=#447700>!-- j_end         end indices for j in tile<a name='355'></font>
<font color=#447700>!-- kts           start index for k in tile<a name='356'></font>
<font color=#447700>!-- kte           end index for k in tile<a name='357'></font>
<font color=#447700>!-- num_tiles     number of tiles<a name='358'></font>
<font color=#447700>!<a name='359'></font>
<font color=#447700>!==================================================================<a name='360'></font>
<font color=#447700>!<a name='361'></font>
   LOGICAL, OPTIONAL, INTENT(IN) :: explicit_convection<a name='362'>
   LOGICAL :: expl_conv<a name='363'>
   INTEGER,      INTENT(IN   )    ::   ids,ide, jds,jde, kds,kde, &amp;<a name='364'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='365'>
                                                         kts,kte, &amp;<a name='366'>
                                       num_tiles<a name='367'>
<a name='368'>
   INTEGER, INTENT(IN)            :: lw_physics, sw_physics, mp_physics<a name='369'>
   INTEGER, INTENT(IN)            :: o3input, aer_opt<a name='370'>
   INTEGER, INTENT(IN)            :: id<a name='371'>
   integer, intent(in)            :: swint_opt<a name='372'>
<a name='373'>
   INTEGER, DIMENSION(num_tiles), INTENT(IN) ::                       &amp;<a name='374'>
                i_start,i_end,j_start,j_end<a name='375'>
<a name='376'>
   INTEGER,      INTENT(IN   )    ::   STEPRA,ICLOUD,ra_call_offset<a name='377'>
   INTEGER,      INTENT(IN   )    ::   alevsiz, no_src_types<a name='378'>
   INTEGER,      INTENT(IN   )    ::   levsiz, n_ozmixm<a name='379'>
   INTEGER,      INTENT(IN   )    ::   paerlev, n_aerosolc, cam_abs_dim1, cam_abs_dim2<a name='380'>
   REAL,      INTENT(IN   )       ::   cam_abs_freq_s<a name='381'>
<a name='382'>
   LOGICAL,      INTENT(IN   )    ::   warm_rain<a name='383'>
   INTEGER,      INTENT(IN   )    ::   cu_physics                <font color=#447700>!CuP, wig 5-Oct-2006 !BSINGH - For WRFCuP scheme<a name='384'></font>
   <font color=#447700>!BSINGH - For WRFCuP scheme<a name='385'></font>
   LOGICAL, OPTIONAL, INTENT(IN)  :: shallowcu_forced_ra          <font color=#447700>!CuP, wig<a name='386'></font>
   <font color=#447700>!BSINGH -ENDS<a name='387'></font>
   LOGICAL,      INTENT(IN   )    ::   is_CAMMGMP_used <font color=#447700>!BSINGH:01/31/2013: Added for CAM5 RRTMG<a name='388'></font>
<a name='389'>
   REAL,      INTENT(IN   )       ::   RADT<a name='390'>
<a name='391'>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='392'>
         INTENT(IN   )  ::                                 XLAND, &amp;<a name='393'>
                                                            XICE, &amp;<a name='394'>
                                                             TSK, &amp;<a name='395'>
                                                          VEGFRA, &amp;<a name='396'>
                                                            SNOW <a name='397'>
   REAL,  DIMENSION( ims:ime, levsiz, jms:jme, n_ozmixm ),  OPTIONAL,    &amp;<a name='398'>
          INTENT(IN   ) ::                                  OZMIXM<a name='399'>
   REAL,  DIMENSION( ims:ime, alevsiz, jms:jme, no_src_types, n_ozmixm-1 ),  OPTIONAL,    &amp;<a name='400'>
          INTENT(IN   ) ::                                  AERODM<a name='401'>
   REAL,  DIMENSION( ims:ime, kms:kme, jms:jme, no_src_types ),  OPTIONAL,    &amp;<a name='402'>
          INTENT(INOUT) ::                                  AEROD<a name='403'>
   REAL,  DIMENSION( ims:ime, jms:jme ), OPTIONAL,                &amp;<a name='404'>
          INTENT(INOUT) ::                                  AODTOT<a name='405'>
<a name='406'>
   REAL,  DIMENSION( ims:ime, levsiz, jms:jme, n_ozmixm ) :: OZFLG<a name='407'>
<a name='408'>
   REAL,  DIMENSION(levsiz), OPTIONAL, INTENT(IN )  ::     PIN<a name='409'>
   REAL,  DIMENSION(alevsiz), OPTIONAL, INTENT(IN )  ::     PINA<a name='410'>
<a name='411'>
   REAL,  DIMENSION(ims:ime,jms:jme), OPTIONAL, INTENT(IN )  ::      m_ps_1,m_ps_2<a name='412'>
   REAL,  DIMENSION( ims:ime, paerlev, jms:jme, n_aerosolc ), OPTIONAL, &amp;<a name='413'>
          INTENT(IN   ) ::                       aerosolc_1, aerosolc_2<a name='414'>
   REAL,  DIMENSION(paerlev), OPTIONAL, &amp;<a name='415'>
          INTENT(IN   ) ::                           m_hybi0<a name='416'>
<a name='417'>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='418'>
         INTENT(INOUT)  ::                                  HTOP, &amp;<a name='419'>
                                                            HBOT, &amp;<a name='420'>
                                                           HTOPR, &amp;<a name='421'>
                                                           HBOTR, &amp;<a name='422'>
                                                           CUPPT<a name='423'>
   <font color=#447700>!BSINGH - For WRFCuP scheme<a name='424'></font>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL,                 &amp;<a name='425'>
        INTENT(INOUT)  ::                                         &amp;<a name='426'>
                                                           cutop, &amp; <font color=#447700>!CuP, wig 1-Oct-2006<a name='427'></font>
                                                           cubot, &amp; <font color=#447700>!CuP, wig 1-Oct-2006<a name='428'></font>
                                                           shall    <font color=#447700>!CuP, wig 4-Feb-2008<a name='429'></font>
   <font color=#447700>!BSINGH -ENDS<a name='430'></font>
<a name='431'>
<a name='432'>
   INTEGER, INTENT(IN   )  ::   julyr<a name='433'>
<font color=#447700>!<a name='434'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &amp;<a name='435'>
         INTENT(IN ) ::                                     dz8w, &amp;<a name='436'>
                                                               z, &amp;<a name='437'>
                                                             p8w, &amp;<a name='438'>
                                                               p, &amp;<a name='439'>
                                                              pi, &amp;<a name='440'>
                                                               t, &amp;<a name='441'>
                                                             t8w, &amp;<a name='442'>
                                                             rho<a name='443'>
<a name='444'>
   <font color=#447700>!BSINGH - For WRFCuP scheme<a name='445'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), OPTIONAL,        &amp;<a name='446'>
        INTENT(INOUT ) ::                            cldfra_cup     <font color=#447700>!CuP, wig 1-Oct-2006<a name='447'></font>
<a name='448'>
<a name='449'>
      <font color=#447700>!BSINGH -ENDS<a name='450'></font>
<a name='451'>
<font color=#447700>!<a name='452'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), OPTIONAL ,       &amp;<a name='453'>
         INTENT(IN ) ::  tauaer300,tauaer400,tauaer600,tauaer999, &amp; <font color=#447700>! jcb<a name='454'></font>
                                 gaer300,gaer400,gaer600,gaer999, &amp; <font color=#447700>! jcb<a name='455'></font>
                                 waer300,waer400,waer600,waer999<a name='456'>
<a name='457'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), OPTIONAL ,       &amp;<a name='458'>
         INTENT(IN ) ::          qc_cu, qi_cu, qc_bl<a name='459'>
<a name='460'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), OPTIONAL ,       &amp;<a name='461'>
         INTENT(IN ) ::  tauaerlw1,tauaerlw2,tauaerlw3,tauaerlw4, &amp; <font color=#447700>! czhao <a name='462'></font>
                         tauaerlw5,tauaerlw6,tauaerlw7,tauaerlw8, &amp; <font color=#447700>! czhao <a name='463'></font>
                         tauaerlw9,tauaerlw10,tauaerlw11,tauaerlw12, &amp; <font color=#447700>! czhao <a name='464'></font>
                         tauaerlw13,tauaerlw14,tauaerlw15,tauaerlw16<a name='465'>
<a name='466'>
   INTEGER, INTENT(IN) :: icloud_cu<a name='467'>
<a name='468'>
   INTEGER, INTENT(IN   ), OPTIONAL  ::   icloud_bl<a name='469'>
   INTEGER, INTENT(IN   ), OPTIONAL  ::   aer_ra_feedback<a name='470'>
<a name='471'>
<font color=#447700>!jdfcz   INTEGER, OPTIONAL, INTENT(IN   )    :: progn,prescribe<a name='472'></font>
   INTEGER, OPTIONAL, INTENT(IN   )    :: progn<a name='473'>
<font color=#447700>!<a name='474'></font>
<font color=#447700>! variables for aerosols (only if running with chemistry)<a name='475'></font>
<font color=#447700>!<a name='476'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), OPTIONAL ,       &amp;<a name='477'>
         INTENT(IN ) ::                                pm2_5_dry, &amp;<a name='478'>
                                                     pm2_5_water, &amp;<a name='479'>
                                                    pm2_5_dry_ec<a name='480'>
<font color=#447700>!<a name='481'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &amp;<a name='482'>
         INTENT(INOUT)  ::                              RTHRATEN, &amp;<a name='483'>
                                                      RTHRATENLW, &amp;<a name='484'>
                                                      RTHRATENSW<a name='485'>
<a name='486'>
<font color=#447700>!  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), OPTIONAL ,       &amp;<a name='487'></font>
<font color=#447700>!        INTENT(INOUT)  ::                                  SWUP, &amp;<a name='488'></font>
<font color=#447700>!                                                           SWDN, &amp;<a name='489'></font>
<font color=#447700>!                                                      SWUPCLEAR, &amp;<a name='490'></font>
<font color=#447700>!                                                      SWDNCLEAR, &amp;<a name='491'></font>
<font color=#447700>!                                                           LWUP, &amp;<a name='492'></font>
<font color=#447700>!                                                           LWDN, &amp;<a name='493'></font>
<font color=#447700>!                                                      LWUPCLEAR, &amp;<a name='494'></font>
<font color=#447700>!                                                      LWDNCLEAR<a name='495'></font>
<a name='496'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT) ::&amp;<a name='497'>
                      ACSWUPT,ACSWUPTC,ACSWDNT,ACSWDNTC,          &amp;<a name='498'>
                      ACSWUPB,ACSWUPBC,ACSWDNB,ACSWDNBC,          &amp;<a name='499'>
                      ACLWUPT,ACLWUPTC,ACLWDNT,ACLWDNTC,          &amp;<a name='500'>
                      ACLWUPB,ACLWUPBC,ACLWDNB,ACLWDNBC<a name='501'>
<a name='502'>
<font color=#447700>! TOA and surface, upward and downward, total and clear fluxes<a name='503'></font>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT) ::&amp;<a name='504'>
                        SWUPT,  SWUPTC,  SWDNT,  SWDNTC,          &amp;<a name='505'>
                        SWUPB,  SWUPBC,  SWDNB,  SWDNBC,          &amp;<a name='506'>
                        LWUPT,  LWUPTC,  LWDNT,  LWDNTC,          &amp;<a name='507'>
                        LWUPB,  LWUPBC,  LWDNB,  LWDNBC<a name='508'>
<a name='509'>
<font color=#447700>! Upward and downward, total and clear sky layer fluxes (W m-2)<a name='510'></font>
   REAL, DIMENSION( ims:ime, kms:kme+2, jms:jme ),                &amp;<a name='511'>
         OPTIONAL, INTENT(INOUT) ::                               &amp;<a name='512'>
                               SWUPFLX,SWUPFLXC,SWDNFLX,SWDNFLXC, &amp;<a name='513'>
                               LWUPFLX,LWUPFLXC,LWDNFLX,LWDNFLXC<a name='514'>
<a name='515'>
   REAL, DIMENSION( ims:ime, jms:jme ),          OPTIONAL ,       &amp;<a name='516'>
         INTENT(INOUT)  ::                                  SWCF, &amp;<a name='517'>
                                                            LWCF, &amp;<a name='518'>
                                                             OLR<a name='519'>
<font color=#447700>! ---- fds (06/2010) ssib alb components ------------<a name='520'></font>
   REAL, DIMENSION( ims:ime, jms:jme ),          OPTIONAL ,       &amp;<a name='521'>
         INTENT(IN   )  ::                            ALSWVISDIR, &amp;<a name='522'>
                                                      ALSWVISDIF, &amp;<a name='523'>
                                                      ALSWNIRDIR, &amp;<a name='524'>
                                                      ALSWNIRDIF<a name='525'>
<font color=#447700>! ---- fds (06/2010) ssib swr components ------------<a name='526'></font>
   REAL, DIMENSION( ims:ime, jms:jme ),          OPTIONAL ,       &amp;<a name='527'>
         INTENT(OUT  )  ::                              SWVISDIR, &amp;<a name='528'>
                                                        SWVISDIF, &amp;<a name='529'>
                                                        SWNIRDIR, &amp;<a name='530'>
                                                        SWNIRDIF<a name='531'>
   INTEGER,    OPTIONAL, INTENT(IN   )    ::  sf_surface_physics<a name='532'>
<font color=#447700>!<a name='533'></font>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='534'>
         INTENT(IN   )  ::                                  XLAT, &amp;<a name='535'>
                                                           XLONG, &amp;<a name='536'>
                                                          ALBEDO, &amp;<a name='537'>
                                                           EMISS<a name='538'>
<font color=#447700>!<a name='539'></font>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='540'>
         INTENT(INOUT)  ::                                   GSW, &amp;<a name='541'>
                                                             GLW<a name='542'>
<a name='543'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)  ::   SWDOWN<a name='544'>
<a name='545'>
<font color=#447700>! ------------------------------------------------------------------------------ jararias 2013/08/10 -----------<a name='546'></font>
   REAL, DIMENSION( ims:ime, jms:jme ),  INTENT(OUT) :: swddir, &amp; <font color=#447700>! All-sky SW broadband surface direct irradiance<a name='547'></font>
                                                        swddni, &amp; <font color=#447700>! All-sky SW broadband surface direct normal irradiance<a name='548'></font>
                                                        swddif    <font color=#447700>! All-sky SW broadband surface diffuse irradiance<a name='549'></font>
   REAL, DIMENSION( ims:ime, jms:jme ),  INTENT(INOUT) :: Gx,Bx,gg,bb, &amp; <font color=#447700>! For SW sza-interpolation<a name='550'></font>
                                                          swdown_ref,  &amp;<a name='551'>
                                                          swddir_ref,  &amp;<a name='552'>
                                                          coszen_ref<a name='553'>
<font color=#447700>! ------------------------------------------------------------------------------ jararias 2013/11    -----------<a name='554'></font>
    INTEGER,                             INTENT(IN)    :: aer_type,       &amp; <font color=#447700>! rural, urban, maritime, ...<a name='555'></font>
                                                          aer_aod550_opt, &amp; <font color=#447700>! input option for AOD at 550 nm<a name='556'></font>
                                                          aer_angexp_opt, &amp; <font color=#447700>! input option for aerosol Angstrom exponent<a name='557'></font>
                                                          aer_ssa_opt,    &amp; <font color=#447700>! input option for aerosol ssa<a name='558'></font>
                                                          aer_asy_opt       <font color=#447700>! input option for aerosol asy<a name='559'></font>
    REAL,                                INTENT(IN)    :: aer_aod550_val, &amp; <font color=#447700>! AOD at 550 nm if aer_aod550_opt=1<a name='560'></font>
                                                          aer_angexp_val, &amp; <font color=#447700>! aerosol Angstrom exponent if aer_angexp_opt=1<a name='561'></font>
                                                          aer_ssa_val,    &amp; <font color=#447700>! aerosol ssa if aer_ssa_opt=1<a name='562'></font>
                                                          aer_asy_val       <font color=#447700>! aerosol asy if aer_asy_opt=1<a name='563'></font>
    REAL, DIMENSION( ims:ime, jms:jme ),          OPTIONAL,               &amp;<a name='564'>
          INTENT(INOUT)                                :: aod5502d,       &amp; <font color=#447700>! gridded AOD at 550 nm from auxinput<a name='565'></font>
                                                          angexp2d,       &amp; <font color=#447700>! gridded aerosol Angstrom exponent from auxinput<a name='566'></font>
                                                          aerssa2d,       &amp; <font color=#447700>! gridded aerosol ssa from auxinput<a name='567'></font>
                                                          aerasy2d          <font color=#447700>! gridded aerosol asy from auxinput<a name='568'></font>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), OPTIONAL,               &amp;<a name='569'>
          INTENT(OUT)                                  :: aod5503d   <font color=#447700>! 3D AOD at 550 nm<a name='570'></font>
<a name='571'>
    REAL, DIMENSION(ims:ime,kms:kme,jms:jme), OPTIONAL:: taod5503d         <font color=#447700>!  Trude<a name='572'></font>
    REAL, DIMENSION(ims:ime,jms:jme), OPTIONAL:: taod5502d                 <font color=#447700>!  Trude<a name='573'></font>
<font color=#447700>!<a name='574'></font>
   REAL, INTENT(IN  )   ::                                GMT,dt, &amp;<a name='575'>
                                                   julian, xtime<a name='576'>
   INTEGER, INTENT(IN  ),OPTIONAL ::                          YR<a name='577'>
<font color=#447700>!<a name='578'></font>
   INTEGER, INTENT(IN  ) ::                    JULDAY, itimestep<a name='579'>
   REAL, INTENT(IN ),OPTIONAL     ::                    CURR_SECS<a name='580'>
   LOGICAL, INTENT(IN ),OPTIONAL  ::              ADAPT_STEP_FLAG<a name='581'>
<a name='582'>
   INTEGER,INTENT(IN)                                       :: NPHS<a name='583'>
   REAL, DIMENSION( ims:ime, jms:jme ),INTENT(OUT)          ::    &amp;<a name='584'>
                                                      CFRACH,     &amp; <font color=#447700>!Added<a name='585'></font>
                                                      CFRACL,     &amp; <font color=#447700>!Added<a name='586'></font>
                                                      CFRACM,     &amp; <font color=#447700>!Added<a name='587'></font>
                                                      CZMEAN        <font color=#447700>!Added<a name='588'></font>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='589'>
         INTENT(INOUT)  ::                                        &amp;<a name='590'>
                                                      RLWTOA,     &amp; <font color=#447700>!Added<a name='591'></font>
                                                      RSWTOA,     &amp; <font color=#447700>!Added<a name='592'></font>
                                                      ACFRST,     &amp; <font color=#447700>!Added<a name='593'></font>
                                                      ACFRCV        <font color=#447700>!Added<a name='594'></font>
<a name='595'>
   INTEGER,DIMENSION( ims:ime, jms:jme ),INTENT(INOUT)        ::  &amp;<a name='596'>
                                                          NCFRST, &amp;  <font color=#447700>!Added<a name='597'></font>
                                                          NCFRCV     <font color=#447700>!Added<a name='598'></font>
<a name='599'>
<font color=#447700>! Optional, only for Goddard LW and SW<a name='600'></font>
   REAL, DIMENSION(IMS:IME, JMS:JME, 1:8)       :: ERBE_out  <font color=#447700>!extra output for SDSU<a name='601'></font>
   REAL, DIMENSION(IMS:IME, JMS:JME), OPTIONAL, INTENT(INOUT) ::   &amp; <font color=#447700>!BSINGH(PNNL)- Lahey compiler forced this specification to be intent-inout<a name='602'></font>
                                               TLWDN, TLWUP,     &amp;<a name='603'>
                                               SLWDN, SLWUP,     &amp;<a name='604'>
                                               TSWDN, TSWUP,     &amp;<a name='605'>
                                               SSWDN, SSWUP        <font color=#447700>! for Goddard schemes<a name='606'></font>
<a name='607'>
<font color=#447700>! Added by ZCX for low and total cloud fraction<a name='608'></font>
   REAL, DIMENSION( kms:kme ), OPTIONAL, INTENT(IN)   :: znu      <font color=#447700>! eta values on half (mass)levels<a name='609'></font>
   REAL, DIMENSION( ims:ime, jms:jme ),  OPTIONAL, INTENT(INOUT) ::         &amp;<a name='610'>
                                                         cldt<a name='611'>
<a name='612'>
<font color=#447700>! Optional (only used by CAM lw scheme)<a name='613'></font>
<a name='614'>
   REAL, DIMENSION( ims:ime, kms:kme, cam_abs_dim2, jms:jme ), OPTIONAL ,&amp;<a name='615'>
         INTENT(INOUT)  ::                                  abstot<a name='616'>
   REAL, DIMENSION( ims:ime, kms:kme, cam_abs_dim1, jms:jme ), OPTIONAL ,&amp;<a name='617'>
         INTENT(INOUT)  ::                                  absnxt<a name='618'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),               OPTIONAL ,&amp;<a name='619'>
         INTENT(INOUT)  ::                                  emstot<a name='620'>
<a name='621'>
<font color=#447700>!<a name='622'></font>
<font color=#447700>! Optional <a name='623'></font>
<font color=#447700>!<a name='624'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &amp;<a name='625'>
         OPTIONAL,                                                &amp;<a name='626'>
         INTENT(INOUT) ::                                 CLDFRA   <a name='627'>
<a name='628'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &amp; <font color=#447700>! ckay for sub-grid cloud fraction<a name='629'></font>
         OPTIONAL,                                                &amp;<a name='630'>
         INTENT(INOUT) ::                              cldfra_dp, &amp;<a name='631'>
                                                       cldfra_sh, &amp;<a name='632'>
                                                       cldfra_bl<a name='633'>
<a name='634'>
<font color=#447700>!..G. Thompson<a name='635'></font>
   REAL, DIMENSION(ims:ime,kms:kme,jms:jme), INTENT(IN):: re_cloud, re_ice, re_snow<a name='636'>
   INTEGER, INTENT(IN):: has_reqc, has_reqi, has_reqs<a name='637'>
<a name='638'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                     &amp;<a name='639'>
         OPTIONAL,                                                   &amp;<a name='640'>
         INTENT(IN   ) ::                                            &amp;<a name='641'>
                                                          F_ICE_PHY, &amp;<a name='642'>
                                                         F_RAIN_PHY, &amp;<a name='643'>
                                                      CLDFRA_MP_ALL<a name='644'>
<a name='645'>
#if (EM_CORE == 1)<a name='646'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                     &amp;<a name='647'>
         OPTIONAL,                                                   &amp;<a name='648'>
         INTENT(IN   ) ::                                            &amp;<a name='649'>
                                                            LRADIUS, &amp;<a name='650'>
                                                            IRADIUS<a name='651'>
#endif<a name='652'>
<a name='653'>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='654'>
         OPTIONAL,                                                &amp;<a name='655'>
         INTENT(OUT) ::                                   SWDOWNC<a name='656'>
<font color=#447700>!<a name='657'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &amp;<a name='658'>
         OPTIONAL,                                                &amp;<a name='659'>
         INTENT(INOUT ) ::                                        &amp;<a name='660'>
                                                               pb &amp;<a name='661'>
                                        ,qv,qc,qr,qi,qs,qg,qndrop,      &amp;<a name='662'>
                                                      qnifa,qnwfa        <font color=#447700>! Trude<a name='663'></font>
<a name='664'>
   LOGICAL, OPTIONAL ::     f_qv,f_qc,f_qr,f_qi,f_qs,f_qg,f_qndrop,     &amp;<a name='665'>
                                                f_qnifa,f_qnwfa          <font color=#447700>! trude<a name='666'></font>
<font color=#447700>!<a name='667'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &amp;<a name='668'>
         OPTIONAL,                                                &amp;<a name='669'>
         INTENT(INOUT)  ::                       taucldi,taucldc<a name='670'>
<a name='671'>
     REAL, OPTIONAL, INTENT(IN) :: dxkm<a name='672'>
<a name='673'>
<font color=#447700>! Variables for slope-dependent radiation<a name='674'></font>
<a name='675'>
     REAL, OPTIONAL, INTENT(IN) :: dx,dy<a name='676'>
     INTEGER, OPTIONAL, INTENT(IN) :: slope_rad,topo_shading<a name='677'>
     REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(IN)  :: ht<a name='678'>
     INTEGER, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(IN) :: shadowmask<a name='679'>
     REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(OUT) :: diffuse_frac<a name='680'>
<a name='681'>
   REAL , OPTIONAL, INTENT(INOUT) ::    radtacttime <font color=#447700>! Storing the time in s when radiation is called next<a name='682'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &amp;<a name='683'>
         INTENT(INOUT)  ::                       o3rad<a name='684'>
<a name='685'>
   <font color=#447700>! vert nesting<a name='686'></font>
   REAL, OPTIONAL , INTENT(IN   ) :: p_top<a name='687'>
   REAL                           :: p_top_dummy<a name='688'>
<a name='689'>
<font color=#447700>! LOCAL  VAR<a name='690'></font>
   INTEGER, DIMENSION( ims:ime, kms:kme, jms:jme ) ::    cldfra1_flag<a name='691'>
   REAL, DIMENSION( ims:ime, jms:jme ) ::             GLAT,GLON<a name='692'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ) ::    CEMISS<a name='693'>
   REAL, DIMENSION( ims:ime, jms:jme ) ::             coszr<a name='694'>
   REAL, DIMENSION( ims:ime, levsiz, jms:jme )  ::    ozmixt<a name='695'>
   REAL, DIMENSION( ims:ime, alevsiz, jms:jme, 1:no_src_types )  ::    aerodt<a name='696'>
<a name='697'>
   REAL    ::    DECLIN,SOLCON,XXLAT,TLOCTM,XT24, CEN_LAT, cldfra_cup_mod<a name='698'>
   INTEGER ::    i,j,k,its,ite,jts,jte,ij<a name='699'>
   INTEGER ::    STEPABS<a name='700'>
   LOGICAL ::    gfdl_lw,gfdl_sw, compute_cldfra_cup<a name='701'>
   LOGICAL ::    doabsems<a name='702'>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='703'>
   INTEGER ::    s<a name='704'>
<a name='705'>
   REAL    ::    OBECL,SINOB,SXLONG,ARG,DECDEG,                  &amp;<a name='706'>
                 DJUL,RJUL,ECCFAC<a name='707'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ) :: qc_temp<a name='708'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ) :: qi_save,qc_save<a name='709'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ) :: qs_save<a name='710'>
<a name='711'>
   REAL    ::    gridkm, Wice,Wh2o<a name='712'>
<a name='713'>
   REAL    ::    next_rad_time, DTaccum<a name='714'>
   LOGICAL ::    run_param , doing_adapt_dt , decided<a name='715'>
   LOGICAL ::    flg_lw, flg_sw<a name='716'>
<font color=#447700>!ZCX<a name='717'></font>
   REAL    ::    cldji,cldlji<a name='718'>
<font color=#447700>!ckay<a name='719'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ) ::    cldfra_cu<a name='720'>
<font color=#447700>!------------------------------------------------------------------<a name='721'></font>
<font color=#447700>! solar related variables are added to declaration<a name='722'></font>
<font color=#447700>!-------------------------------------------------<a name='723'></font>
   REAL, OPTIONAL, INTENT(OUT) :: DECLINX,SOLCONX<a name='724'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme), INTENT(OUT) :: COSZEN<a name='725'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme), INTENT(OUT) :: HRANG<a name='726'>
<font color=#447700>!------------------------------------------------------------------<a name='727'></font>
<a name='728'>
<font color=#447700>! jararias, 2013/08/10<a name='729'></font>
   real :: ioh,kt,airmass,kd<a name='730'>
   real, dimension(ims:ime,jms:jme) :: coszen_loc,hrang_loc<a name='731'>
<font color=#447700>! jararias 2013/11 but modified on 2016/2/10<a name='732'></font>
<font color=#447700>!  the following three arrays may be dimensioned by (ims,ime,kms,kme,jms,jme,aerosol_vars)<a name='733'></font>
   real, dimension(:,:,:,:), pointer :: tauaer_sw=&gt;null(), ssaaer_sw=&gt;null(), asyaer_sw=&gt;null()<a name='734'>
<a name='735'>
<font color=#447700>! Trude AOD variables<a name='736'></font>
     INTEGER, PARAMETER:: taer_type = 1                                  <font color=#447700>!  rural, urban, maritime, ...<a name='737'></font>
     INTEGER, PARAMETER:: taer_aod550_opt = 2                            <font color=#447700>!  input option for AOD at 550 nm<a name='738'></font>
     INTEGER, PARAMETER:: taer_angexp_opt = 3                            <font color=#447700>!  input option for aerosol Angstrom exponent<a name='739'></font>
     INTEGER, PARAMETER:: taer_ssa_opt = 3                               <font color=#447700>!  input option for aerosol ssa<a name='740'></font>
     INTEGER, PARAMETER:: taer_asy_opt = 3                               <font color=#447700>!  input option for aerosol asy<a name='741'></font>
<a name='742'>
<a name='743'>
#if ( HWRF == 1 )<a name='744'>
   CHARACTER(len=255) :: wrf_err_message<a name='745'>
#endif<a name='746'>
<a name='747'>
   <font color=#447700>! This allows radiation schemes (mainly HWRF) to correctly<a name='748'></font>
   <font color=#447700>! interface with the convection scheme when convection is only<a name='749'></font>
   <font color=#447700>! enabled in some domains:<a name='750'></font>
   if(present(explicit_convection)) then<a name='751'>
      expl_conv=explicit_convection<a name='752'>
   else<a name='753'>
      expl_conv=.true. <font color=#447700>! backward compatibility for ARW<a name='754'></font>
   endif<a name='755'>
<a name='756'>
   IF ( ICLOUD == 3 ) THEN<a name='757'>
      IF (PRESENT(dxkm)) then<a name='758'>
         gridkm = 1.414*SQRT(dxkm*dxkm + dy*0.001*dy*0.001)<a name='759'>
      ELSE IF (PRESENT(dx)) then<a name='760'>
         gridkm = SQRT(dx*0.001*dx*0.001 + dy*0.001*dy*0.001)<a name='761'>
      endif<a name='762'>
<a name='763'>
      if (itimestep .LE. 100) then<a name='764'>
        WRITE ( wrf_err_message , * ) 'Grid spacing in km ', dx, dy, gridkm<a name='765'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_796"> (100, wrf_err_message)<a name='766'>
      endif<a name='767'>
   END IF<a name='768'>
<a name='769'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_797"> (1, 'Top of Radiation Driver')<a name='770'>
<font color=#447700>!  WRITE ( wrf_err_message , * ) 'itimestep = ',itimestep,', dt = ',dt,', lw and sw options = ',lw_physics,sw_physics<a name='771'></font>
<font color=#447700>!  CALL wrf_debug (1, wrf_err_message )<a name='772'></font>
   if (lw_physics .eq. 0 .and. sw_physics .eq. 0)         return<a name='773'>
<a name='774'>
<font color=#447700>! amontornes-bcodina (2014-05-02) :: improving the namelist settings consistency for the FLG scheme<a name='775'></font>
<font color=#447700>!  if (lw_physics .ne. FLGLWSCHEME .and. sw_physics .eq. FLGSWSCHEME)  then<a name='776'></font>
<font color=#447700>!      call wrf_error_fatal('SW and LW schemes are in conflict. SW is FLG and LW is a different scheme!')<a name='777'></font>
<font color=#447700>!  end if<a name='778'></font>
<font color=#447700>!  if (lw_physics .eq. FLGLWSCHEME .and. sw_physics .ne. FLGSWSCHEME) then<a name='779'></font>
<font color=#447700>!      call wrf_error_fatal('SW and LW schemes are in conflict. LW is FLG and SW is a different scheme!')<a name='780'></font>
<font color=#447700>!  end if<a name='781'></font>
<a name='782'>
<font color=#447700>! ra_call_offset = -1 gives old method where radiation may be called just before output<a name='783'></font>
<font color=#447700>! ra_call_offset =  0 gives new method where radiation may be called just after output<a name='784'></font>
<font color=#447700>!                     and is also consistent with removal of offset in new XTIME<a name='785'></font>
<font color=#447700>! also need to account for stepra=1 which always has zero modulo output<a name='786'></font>
<a name='787'>
   doing_adapt_dt = .FALSE.<a name='788'>
   IF ( PRESENT(adapt_step_flag) ) THEN<a name='789'>
      IF ( adapt_step_flag ) THEN<a name='790'>
         doing_adapt_dt = .TRUE.<a name='791'>
         IF ( radtacttime .eq. 0. ) THEN<a name='792'>
            radtacttime = CURR_SECS + radt*60.<a name='793'>
         END IF<a name='794'>
      END IF<a name='795'>
   END IF<a name='796'>
<a name='797'>
<font color=#447700>!  Do we run through this scheme or not?<a name='798'></font>
<a name='799'>
<font color=#447700>!    Test 1:  If this is the initial model time, then yes.<a name='800'></font>
<font color=#447700>!                ITIMESTEP=1<a name='801'></font>
<font color=#447700>!    Test 2:  If the user asked for the radiation to be run every time step, then yes.<a name='802'></font>
<font color=#447700>!                RADT=0 or STEPRA=1<a name='803'></font>
<font color=#447700>!    Test 3:  If not adaptive dt, and this is on the requested radiation frequency, then yes.<a name='804'></font>
<font color=#447700>!                MOD(ITIMESTEP,STEPRA)=0 (or 1, depending on the offset setting)<a name='805'></font>
<font color=#447700>!    Test 4:  If using adaptive dt and the current time is past the last requested activate radiation time, then yes.<a name='806'></font>
<font color=#447700>!                CURR_SECS &gt;= RADTACTTIME<a name='807'></font>
<a name='808'>
<font color=#447700>!  If we do run through the scheme, we set the flag run_param to TRUE and we set the decided flag<a name='809'></font>
<font color=#447700>!  to TRUE.  The decided flag says that one of these tests was able to say "yes", run the scheme.<a name='810'></font>
<font color=#447700>!  We only proceed to other tests if the previous tests all have left decided as FALSE.<a name='811'></font>
<a name='812'>
<font color=#447700>!  If we set run_param to TRUE and this is adaptive time stepping, we set the time to the next<a name='813'></font>
<font color=#447700>!  radiation run.<a name='814'></font>
<a name='815'>
   run_param = .FALSE.<a name='816'>
   decided = .FALSE.<a name='817'>
   IF ( ( .NOT. decided ) .AND. &amp;<a name='818'>
        ( itimestep .EQ. 1 ) ) THEN<a name='819'>
      run_param   = .TRUE.<a name='820'>
      decided     = .TRUE.<a name='821'>
   END IF<a name='822'>
<a name='823'>
   IF ( ( .NOT. decided ) .AND. &amp;<a name='824'>
        ( ( radt .EQ. 0. ) .OR. ( stepra .EQ. 1 ) ) ) THEN<a name='825'>
      run_param   = .TRUE.<a name='826'>
      decided     = .TRUE.<a name='827'>
   END IF<a name='828'>
<a name='829'>
   IF ( ( .NOT. decided ) .AND. &amp;<a name='830'>
        ( .NOT. doing_adapt_dt ) .AND. &amp;<a name='831'>
        ( MOD(itimestep,stepra) .EQ. 1+ra_call_offset ) ) THEN<a name='832'>
      run_param   = .TRUE.<a name='833'>
      decided     = .TRUE.<a name='834'>
   END IF<a name='835'>
<a name='836'>
   IF ( ( .NOT. decided ) .AND. &amp;<a name='837'>
        ( doing_adapt_dt ) .AND. &amp;<a name='838'>
        ( curr_secs .GE. radtacttime ) ) THEN<a name='839'>
      run_param   = .TRUE.<a name='840'>
      decided     = .TRUE.<a name='841'>
      radtacttime = curr_secs + radt*60<a name='842'>
   END IF<a name='843'>
<a name='844'>
   if(swint_opt.eq.1) then<a name='845'>
      DO ij = 1 , num_tiles<a name='846'>
         its = i_start(ij)<a name='847'>
         ite = i_end(ij)<a name='848'>
         jts = j_start(ij)<a name='849'>
         jte = j_end(ij)<a name='850'>
         CALL <A href='../../html_code/phys/module_radiation_driver.F.html#RADCONST'>radconst</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADCONST_1">(XTIME,DECLIN,SOLCON,JULIAN,               &amp;<a name='851'>
                       DEGRAD,DPD                                )<a name='852'>
         call <A href='../../html_code/phys/module_radiation_driver.F.html#CALC_COSZEN'>calc_coszen</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_COSZEN_1">(ims,ime,jms,jme,its,ite,jts,jte, &amp;<a name='853'>
                          julian,xtime,gmt,declin,degrad,  &amp;<a name='854'>
                          xlong,xlat,coszen_loc,hrang_loc)<a name='855'>
      end do<a name='856'>
   end if<a name='857'>
<a name='858'>
   Radiation_step: IF ( run_param ) then<a name='859'>
<a name='860'>
<font color=#447700>! CAM-specific additional radiation frequency - cam_abs_freq_s (=21600s by default)<a name='861'></font>
     STEPABS = nint(cam_abs_freq_s/(dt*STEPRA))*STEPRA<a name='862'>
     IF (itimestep .eq. 1 .or. mod(itimestep,STEPABS) .eq. 1 + ra_call_offset &amp;<a name='863'>
                                        .or. STEPABS .eq. 1 ) THEN<a name='864'>
       doabsems = .true.<a name='865'>
     ELSE<a name='866'>
       doabsems = .false.<a name='867'>
     ENDIF<a name='868'>
   IF (PRESENT(adapt_step_flag)) THEN<a name='869'>
     IF ((adapt_step_flag)) THEN<a name='870'>
       IF ( (itimestep .EQ. 1) .OR. (cam_abs_freq_s .EQ. 0) .OR. &amp;<a name='871'>
           ( CURR_SECS + dt &gt;= ( INT( CURR_SECS / ( cam_abs_freq_s ) + 1 ) * cam_abs_freq_s) ) ) THEN<a name='872'>
         doabsems = .true.<a name='873'>
       ELSE<a name='874'>
         doabsems = .false.<a name='875'>
       ENDIF<a name='876'>
     ENDIF<a name='877'>
   ENDIF<a name='878'>
<a name='879'>
   gfdl_lw = .false.<a name='880'>
   gfdl_sw = .false.<a name='881'>
   flg_lw = .false.<a name='882'>
   flg_sw = .false.<a name='883'>
<a name='884'>
<font color=#447700>! Allocate aerosol arrays used by aer_opt = 2 option<a name='885'></font>
   IF ( PRESENT( AOD5502D ) ) THEN<a name='886'>
     <font color=#447700>! jararias, 2013/11<a name='887'></font>
     IF ( aer_opt .EQ. 2 ) THEN<a name='888'>
        swrad_aerosol_select: select case(sw_physics)<a name='889'>
<a name='890'>
           case(GODDARDSWSCHEME)<a name='891'>
              allocate(tauaer_sw(ims:ime, kms:kme, jms:jme, 1:11))<a name='892'>
              allocate(ssaaer_sw(ims:ime, kms:kme, jms:jme, 1:11))<a name='893'>
              allocate(asyaer_sw(ims:ime, kms:kme, jms:jme, 1:11))<a name='894'>
<a name='895'>
           case(RRTMG_SWSCHEME,RRTMG_SWSCHEME_FAST)<a name='896'>
              allocate(tauaer_sw(ims:ime, kms:kme, jms:jme, 1:14))<a name='897'>
              allocate(ssaaer_sw(ims:ime, kms:kme, jms:jme, 1:14))<a name='898'>
              allocate(asyaer_sw(ims:ime, kms:kme, jms:jme, 1:14))<a name='899'>
<a name='900'>
        end select swrad_aerosol_select<a name='901'>
     ENDIF<a name='902'>
   ENDIF<a name='903'>
<a name='904'>
<font color=#447700>! Allocate aerosol arrays used by aer_opt = 3 option, and explicit AOD from QNWFA+QNIFA   (Trude)<a name='905'></font>
   IF (PRESENT(f_qnwfa) .AND. PRESENT(f_qnifa) .AND. PRESENT(taod5503d) .AND.  PRESENT(taod5502d)) THEN<a name='906'>
      IF (F_QNWFA .AND. aer_opt.eq.3 .AND.                              &amp;<a name='907'>
                 (sw_physics.eq.RRTMG_SWSCHEME .OR.                     &amp;<a name='908'>
                  sw_physics.eq.RRTMG_SWSCHEME_FAST)) THEN<a name='909'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_798"> (150, 'DEBUG-GT:  computing 3D AOD from QNWFA+QNIFA')<a name='910'>
<a name='911'>
         allocate(tauaer_sw(ims:ime, kms:kme, jms:jme, 1:14))<a name='912'>
         allocate(ssaaer_sw(ims:ime, kms:kme, jms:jme, 1:14))<a name='913'>
         allocate(asyaer_sw(ims:ime, kms:kme, jms:jme, 1:14))<a name='914'>
<a name='915'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='916'></font>
         <font color=#447700>!$OMP PRIVATE ( ij ,i,j,k,its,ite,jts,jte)<a name='917'></font>
         DO ij = 1 , num_tiles<a name='918'>
           its = i_start(ij)<a name='919'>
           ite = i_end(ij)<a name='920'>
           jts = j_start(ij)<a name='921'>
           jte = j_end(ij)<a name='922'>
<a name='923'>
           do j=jts,jte<a name='924'>
              do i=its,ite<a name='925'>
                 taod5502d(i,j) = 0.0<a name='926'>
              end do<a name='927'>
           end do<a name='928'>
<a name='929'>
           call <A href='../../html_code/phys/module_radiation_driver.F.html#GT_AOD'>gt_aod</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GT_AOD_1"> (p, DZ8W, t, qv, qnwfa, qnifa, taod5503d,        &amp;<a name='930'>
                    ims,ime, jms,jme, kms,kme,its,ite, jts,jte, kts,kte) <a name='931'>
<a name='932'>
           do j=jts,jte<a name='933'>
              do i=its,ite<a name='934'>
                 do k=kts,kte<a name='935'>
                    taod5502d(i,j) = taod5502d(i,j) + taod5503d(i,k,j)<a name='936'>
                 end do<a name='937'>
              end do<a name='938'>
           end do<a name='939'>
         ENDDO<a name='940'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='941'></font>
      ENDIF<a name='942'>
   ENDIF<a name='943'>
<a name='944'>
<font color=#447700>!---------------<a name='945'></font>
<font color=#447700>! Calculate constant for short wave radiation<a name='946'></font>
<font color=#447700>! moved up and out of OMP loop because it only needs to be computed once<a name='947'></font>
<font color=#447700>! and because it is not entirely thread-safe (XT24, TOLOCTM and XXLAT need<a name='948'></font>
<font color=#447700>! their thread-privacy)  JM 20100217<a name='949'></font>
   DO ij = 1 , num_tiles<a name='950'>
     its = i_start(ij)<a name='951'>
     ite = i_end(ij)<a name='952'>
     jts = j_start(ij)<a name='953'>
     jte = j_end(ij)<a name='954'>
     CALL <A href='../../html_code/phys/module_radiation_driver.F.html#RADCONST'>radconst</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADCONST_2">(XTIME,DECLIN,SOLCON,JULIAN,               &amp;<a name='955'>
                   DEGRAD,DPD                                )<a name='956'>
<a name='957'>
     IF(PRESENT(declinx).AND.PRESENT(solconx))THEN<a name='958'>
<font color=#447700>! saved to state arrays used in surface driver<a name='959'></font>
       declinx=declin<a name='960'>
       solconx=solcon<a name='961'>
     ENDIF<a name='962'>
<a name='963'>
<font color=#447700>! added coszen subroutine : jararias, 2013/08/10<a name='964'></font>
<font color=#447700>!   outputs: coszen, hrang<a name='965'></font>
     call <A href='../../html_code/phys/module_radiation_driver.F.html#CALC_COSZEN'>calc_coszen</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_COSZEN_2">(ims,ime,jms,jme,its,ite,jts,jte,  &amp;<a name='966'>
                      julian,xtime+radt*0.5,gmt, &amp;<a name='967'>
                      declin,degrad,xlong,xlat,coszen,hrang)<a name='968'>
   ENDDO<a name='969'>
<a name='970'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='971'></font>
   <font color=#447700>!$OMP PRIVATE ( ij ,i,j,k,its,ite,jts,jte)<a name='972'></font>
<a name='973'>
   DO ij = 1 , num_tiles<a name='974'>
     its = i_start(ij)<a name='975'>
     ite = i_end(ij)<a name='976'>
     jts = j_start(ij)<a name='977'>
     jte = j_end(ij)<a name='978'>
<a name='979'>
<font color=#447700>! initialize data<a name='980'></font>
<a name='981'>
     if ((itimestep.eq.1).and.(swint_opt.eq.1)) then<a name='982'>
        do j=jts,jte<a name='983'>
           do i=its,ite<a name='984'>
              Bx(i,j)=0.<a name='985'>
              bb(i,j)=0.<a name='986'>
              Gx(i,j)=0.<a name='987'>
              gg(i,j)=0.<a name='988'>
           end do<a name='989'>
        end do<a name='990'>
     end if<a name='991'>
<a name='992'>
     DO j=jts,jte<a name='993'>
     DO i=its,ite<a name='994'>
        GSW(I,J)=0.<a name='995'>
        GLW(I,J)=0.<a name='996'>
        SWDOWN(I,J)=0.<a name='997'>
        swddir(i,j)=0.  <font color=#447700>! jararias, 2013/08/10<a name='998'></font>
        swddni(i,j)=0.  <font color=#447700>! jararias, 2013/08/10<a name='999'></font>
        swddif(i,j)=0.  <font color=#447700>! jararias, 2013/08/10<a name='1000'></font>
        GLAT(I,J)=XLAT(I,J)*DEGRAD<a name='1001'>
        GLON(I,J)=XLONG(I,J)*DEGRAD<a name='1002'>
     ENDDO<a name='1003'>
     ENDDO<a name='1004'>
<a name='1005'>
     DO j=jts,jte<a name='1006'>
     DO k=kts,kte+1<a name='1007'>
     DO i=its,ite<a name='1008'>
        RTHRATEN(I,K,J)=0.<a name='1009'>
        RTHRATENLW(I,K,J)=0.<a name='1010'>
        RTHRATENSW(I,K,J)=0.<a name='1011'>
<font color=#447700>!        SWUP(I,K,J) = 0.0<a name='1012'></font>
<font color=#447700>!        SWDN(I,K,J) = 0.0<a name='1013'></font>
<font color=#447700>!        SWUPCLEAR(I,K,J) = 0.0<a name='1014'></font>
<font color=#447700>!        SWDNCLEAR(I,K,J) = 0.0<a name='1015'></font>
<font color=#447700>!        LWUP(I,K,J) = 0.0<a name='1016'></font>
<font color=#447700>!        LWDN(I,K,J) = 0.0<a name='1017'></font>
<font color=#447700>!        LWUPCLEAR(I,K,J) = 0.0<a name='1018'></font>
<font color=#447700>!        LWDNCLEAR(I,K,J) = 0.0<a name='1019'></font>
        CEMISS(I,K,J)=0.0<a name='1020'>
     ENDDO<a name='1021'>
     ENDDO<a name='1022'>
     ENDDO<a name='1023'>
<a name='1024'>
     IF ( PRESENT( SWUPFLX ) ) THEN<a name='1025'>
        DO j=jts,jte<a name='1026'>
        DO k=kts,kte+2<a name='1027'>
        DO i=its,ite<a name='1028'>
           SWUPFLX(I,K,J) = 0.0<a name='1029'>
           SWDNFLX(I,K,J) = 0.0<a name='1030'>
           SWUPFLXC(I,K,J) = 0.0<a name='1031'>
           SWDNFLXC(I,K,J) = 0.0<a name='1032'>
           LWUPFLX(I,K,J) = 0.0<a name='1033'>
           LWDNFLX(I,K,J) = 0.0<a name='1034'>
           LWUPFLXC(I,K,J) = 0.0<a name='1035'>
           LWDNFLXC(I,K,J) = 0.0<a name='1036'>
        ENDDO<a name='1037'>
        ENDDO<a name='1038'>
        ENDDO<a name='1039'>
     ENDIF<a name='1040'>
<a name='1041'>
<font color=#447700>! backup the incoming hydrometeors<a name='1042'></font>
<a name='1043'>
     IF ( F_QC ) THEN<a name='1044'>
          DO j=jts,jte<a name='1045'>
          DO k=kts,kte<a name='1046'>
          DO i=its,ite<a name='1047'>
             qc_save(i,k,j) = qc(i,k,j)<a name='1048'>
          ENDDO<a name='1049'>
          ENDDO<a name='1050'>
          ENDDO<a name='1051'>
     ENDIF<a name='1052'>
     IF ( F_QI ) THEN<a name='1053'>
          DO j=jts,jte<a name='1054'>
          DO k=kts,kte<a name='1055'>
          DO i=its,ite<a name='1056'>
             qi_save(i,k,j) = qi(i,k,j)<a name='1057'>
          ENDDO<a name='1058'>
          ENDDO<a name='1059'>
          ENDDO<a name='1060'>
     ENDIF<a name='1061'>
<a name='1062'>
<font color=#447700>! Fill temporary water variable depending on micro package (tgs 25 Apr 2006)<a name='1063'></font>
     if( F_QC ) then<a name='1064'>
        DO j=jts,jte<a name='1065'>
        DO k=kts,kte<a name='1066'>
        DO i=its,ite<a name='1067'>
           qc_temp(I,K,J)=qc(I,K,J)<a name='1068'>
        ENDDO<a name='1069'>
        ENDDO<a name='1070'>
        ENDDO<a name='1071'>
     else<a name='1072'>
        DO j=jts,jte<a name='1073'>
        DO k=kts,kte<a name='1074'>
        DO i=its,ite<a name='1075'>
           qc_temp(I,K,J)=0.<a name='1076'>
        ENDDO<a name='1077'>
        ENDDO<a name='1078'>
        ENDDO<a name='1079'>
     endif<a name='1080'>
<font color=#447700>! Remove this - to match NAM operational (affects GFDL and HWRF schemes)<a name='1081'></font>
<font color=#447700>!    if( F_QR ) then<a name='1082'></font>
<font color=#447700>!       DO j=jts,jte<a name='1083'></font>
<font color=#447700>!       DO k=kts,kte<a name='1084'></font>
<font color=#447700>!       DO i=its,ite<a name='1085'></font>
<font color=#447700>!          qc_temp(I,K,J) = qc_temp(I,K,J) + qr(I,K,J)<a name='1086'></font>
<font color=#447700>!       ENDDO<a name='1087'></font>
<font color=#447700>!       ENDDO<a name='1088'></font>
<font color=#447700>!       ENDDO<a name='1089'></font>
<font color=#447700>!    endif<a name='1090'></font>
<font color=#447700>!<a name='1091'></font>
<font color=#447700>! temporarily modify hydrometeors (this is for GD scheme and WRF-Chem)<a name='1092'></font>
<font color=#447700>!<a name='1093'></font>
     IF ( F_QC .AND. icloud_cu .EQ. 1 ) THEN<a name='1094'>
          DO j=jts,jte<a name='1095'>
          DO k=kts,kte<a name='1096'>
          DO i=its,ite<a name='1097'>
             qc(i,k,j) = qc(i,k,j) + qc_cu(i,k,j)<a name='1098'>
          ENDDO<a name='1099'>
          ENDDO<a name='1100'>
          ENDDO<a name='1101'>
     ENDIF<a name='1102'>
     IF ( F_QI .AND. icloud_cu .EQ. 1 ) THEN<a name='1103'>
          DO j=jts,jte<a name='1104'>
          DO k=kts,kte<a name='1105'>
          DO i=its,ite<a name='1106'>
             qi(i,k,j) = qi(i,k,j) + qi_cu(i,k,j)<a name='1107'>
          ENDDO<a name='1108'>
          ENDDO<a name='1109'>
          ENDDO<a name='1110'>
     ENDIF<a name='1111'>
<a name='1112'>
<font color=#447700>! Choose how to compute cloud fraction (since 3.6)<a name='1113'></font>
<font color=#447700>! Initialize to zero <a name='1114'></font>
     DO j=jts,jte<a name='1115'>
     DO k=kts,kte<a name='1116'>
     DO i=its,ite<a name='1117'>
        CLDFRA(i,k,j) = 0.<a name='1118'>
     END DO<a name='1119'>
     END DO<a name='1120'>
     END DO<a name='1121'>
<a name='1122'>
     IF ( ICLOUD == 1 ) THEN<a name='1123'>
<a name='1124'>
     IF ( F_QC .OR. F_QI ) THEN<a name='1125'>
<font color=#447700>! Call to cloud fraction routine based on Randall 1994 (Hong Pan 1998)<a name='1126'></font>
<a name='1127'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_799"> (1, 'CALL cldfra1')<a name='1128'>
        CALL <A href='../../html_code/phys/module_radiation_driver.F.html#CAL_CLDFRA1'>cal_cldfra1</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_CLDFRA1_1">(CLDFRA,qv,qc,qi,qs,               &amp;<a name='1129'>
                   F_QV,F_QC,F_QI,F_QS,t,p,                &amp;<a name='1130'>
                   F_ICE_PHY,F_RAIN_PHY,                   &amp;<a name='1131'>
                   mp_physics,cldfra1_flag,                &amp;<a name='1132'>
                   ids,ide, jds,jde, kds,kde,              &amp;<a name='1133'>
                   ims,ime, jms,jme, kms,kme,              &amp;<a name='1134'>
                   its,ite, jts,jte, kts,kte               )<a name='1135'>
<a name='1136'>
        IF ( PRESENT ( CLDFRA_DP ) ) THEN<a name='1137'>
<font color=#447700>! this is for Kain-Fritsch scheme<a name='1138'></font>
          IF ( icloud_cu .EQ. 2 ) THEN<a name='1139'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_800"> (1, 'use kf cldfra')<a name='1140'>
             DO j = jts,jte<a name='1141'>
             DO k = kts,kte<a name='1142'>
             DO i = its,ite<a name='1143'>
                cldfra_cu(i,k,j)=cldfra_dp(i,k,j)+cldfra_sh(i,k,j) <font color=#447700>! Cu cloud fraction<a name='1144'></font>
                CLDFRA(i,k,j)=(1.-cldfra_cu(i,k,j))*CLDFRA(i,k,j)  <font color=#447700>! Update resolved cloud fraction for Cu punch-through<a name='1145'></font>
                CLDFRA(i,k,j)=CLDFRA(i,k,j)+cldfra_cu(i,k,j)       <font color=#447700>! New total cloud fraction<a name='1146'></font>
                CLDFRA(i,k,j)=AMIN1(1.0,CLDFRA(i,k,j))<a name='1147'>
                qc(i,k,j) = qc(i,k,j)+qc_cu(i,k,j)*cldfra_cu(i,k,j)<a name='1148'>
                qi(i,k,j) = qi(i,k,j)+qi_cu(i,k,j)*cldfra_cu(i,k,j)<a name='1149'>
             ENDDO<a name='1150'>
             ENDDO<a name='1151'>
             ENDDO<a name='1152'>
          ENDIF<a name='1153'>
        ENDIF<a name='1154'>
<a name='1155'>
        IF ( PRESENT ( CLDFRA_BL ) .AND.  PRESENT ( QC_BL ) ) THEN<a name='1156'>
           IF ( icloud_bl &gt; 0 ) THEN<a name='1157'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_801"> (1, 'in rad driver; use BL clouds')<a name='1158'>
           DO j = jts,jte<a name='1159'>
           DO i = its,ite<a name='1160'>
           DO k = kts,kte<a name='1161'>
              IF (qc(i,k,j) &lt; 1.E-6 .AND. qi(i,k,j) &lt; 1.E-6 .AND. CLDFRA_BL(i,k,j)&gt;0.001) THEN<a name='1162'>
               <font color=#447700>!Partition the BL clouds into water &amp; ice according to a linear<a name='1163'></font>
               <font color=#447700>!approximation of Hobbs et al. (1974). This allows us to only use<a name='1164'></font>
               <font color=#447700>!one 3D array for both cloud water &amp; ice.<a name='1165'></font>
<font color=#447700>!              Wice = 1. - MIN(1., MAX(0., (t(i,k,j)-254.)/15.))<a name='1166'></font>
<font color=#447700>!              Wh2o = 1. - Wice<a name='1167'></font>
               CLDFRA(i,k,j)=MAX(CLDFRA(i,k,j),CLDFRA_BL(i,k,j))<a name='1168'>
               CLDFRA(i,k,j)=MAX(0.0,MIN(1.0,CLDFRA(i,k,j)))<a name='1169'>
               qc(i,k,j)=qc(i,k,j) + QC_BL(i,k,j)*(MIN(1., MAX(0., (t(i,k,j)-254.)/15.)))*CLDFRA_BL(i,k,j)<a name='1170'>
               qi(i,k,j)=qi(i,k,j) + QC_BL(i,k,j)*(1. - MIN(1., MAX(0., (t(i,k,j)-254.)/15.)))*CLDFRA_BL(i,k,j)<a name='1171'>
              ENDIF<a name='1172'>
           ENDDO<a name='1173'>
           ENDDO<a name='1174'>
           ENDDO<a name='1175'>
           ENDIF<a name='1176'>
        ENDIF<a name='1177'>
<a name='1178'>
        IF ( PRESENT (cldfra_mp_all) ) THEN<a name='1179'>
          IF (is_CAMMGMP_used) THEN<a name='1180'>
            <font color=#447700>!BSINGH: cloud fraction from CAMMGMP is being used (Mods by Po-Lun)<a name='1181'></font>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_802"> (1, 'use cammgmp')<a name='1182'>
            IF (itimestep .NE. 1) THEN<a name='1183'>
               DO j=jts,jte<a name='1184'>
               DO k=kts,kte<a name='1185'>
               DO i=its,ite<a name='1186'>
                  CLDFRA(i,k,j) = CLDFRA_MP_ALL(I,K,J) <font color=#447700>!PMA<a name='1187'></font>
                  if (CLDFRA(i,k,j) .lt. 0.01) CLDFRA(i,k,j) = 0.<a name='1188'>
               ENDDO<a name='1189'>
               ENDDO<a name='1190'>
               ENDDO<a name='1191'>
            ENDIF <a name='1192'>
          ENDIF<a name='1193'>
        ENDIF<a name='1194'>
     ENDIF<a name='1195'>
 <a name='1196'>
     ELSE IF ( ICLOUD == 2 ) THEN<a name='1197'>
<a name='1198'>
     IF ( F_QC .OR. F_QI ) THEN<a name='1199'>
       CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_803"> (1, 'CALL cldfra2')<a name='1200'>
       CALL <A href='../../html_code/phys/module_radiation_driver.F.html#CAL_CLDFRA2'>cal_cldfra2</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_CLDFRA2_2">(CLDFRA,qc,qi,F_QC,F_QI,              &amp;<a name='1201'>
                       ids,ide, jds,jde, kds,kde,            &amp;<a name='1202'>
                       ims,ime, jms,jme, kms,kme,            &amp;<a name='1203'>
                       its,ite, jts,jte, kts,kte             )<a name='1204'>
     ENDIF<a name='1205'>
<a name='1206'>
<font color=#447700>!+---+-----------------------------------------------------------------+ <a name='1207'></font>
<font color=#447700>!..New cloud fraction scheme added by G. Thompson (2014Oct31)<a name='1208'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+ <a name='1209'></font>
<a name='1210'>
     ELSEIF (ICLOUD == 3) THEN<a name='1211'>
        IF ( F_QC .AND. F_QI ) THEN<a name='1212'>
           IF ( F_QS ) THEN<a name='1213'>
              DO j = jts,jte<a name='1214'>
              DO k = kts,kte<a name='1215'>
              DO i = its,ite<a name='1216'>
                 qs_save(i,k,j) = qs(i,k,j)<a name='1217'>
              ENDDO<a name='1218'>
              ENDDO<a name='1219'>
              ENDDO<a name='1220'>
           ENDIF<a name='1221'>
<a name='1222'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_804"> (150, 'DEBUG: using gthompsn cloud fraction scheme')<a name='1223'>
           CALL <A href='../../html_code/phys/module_radiation_driver.F.html#CAL_CLDFRA3'>cal_cldfra3</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_CLDFRA3_1">(CLDFRA, qv, qc, qi, qs,                     &amp;<a name='1224'>
     &amp;                 p,t,rho, XLAND, gridkm,                          &amp;<a name='1225'>
     &amp;                 ids,ide, jds,jde, kds,kde,                       &amp;<a name='1226'>
     &amp;                 ims,ime, jms,jme, kms,kme,                       &amp;<a name='1227'>
     &amp;                 its,ite, jts,jte, kts,kte)<a name='1228'>
<a name='1229'>
        ELSE<a name='1230'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1122">('Can not use icloud = 3 option, missing QC or QI field.')<a name='1231'>
        ENDIF<a name='1232'>
<a name='1233'>
     END IF<a name='1234'>
<a name='1235'>
<font color=#447700>!     Interpolating climatological ozone and aerosol to model time and levels<a name='1236'></font>
<font color=#447700>!     Adapted from camrad code<a name='1237'></font>
     IF ( o3input .EQ. 2 ) THEN<a name='1238'>
<font color=#447700>!       ! Find the current month (adapted from Cavallo)<a name='1239'></font>
<font color=#447700>!       CALL cam_time_interp( ozmixm, pin, levsiz, date_str, &amp;<a name='1240'></font>
<font color=#447700>!                             ids , ide , jds , jde , kds , kde , &amp;<a name='1241'></font>
<font color=#447700>!                             ims , ime , jms , jme , kms , kme , &amp;<a name='1242'></font>
<font color=#447700>!                             its , ite , jts , jte , kts , kte )<a name='1243'></font>
<font color=#447700>! this is the CAM version<a name='1244'></font>
<font color=#447700>! interpolate to model time-step<a name='1245'></font>
        call <A href='../../html_code/phys/module_radiation_driver.F.html#OZN_TIME_INT'>ozn_time_int</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OZN_TIME_INT_1">(julday,julian,ozmixm,ozmixt,levsiz,n_ozmixm,    &amp;<a name='1246'>
                              ids , ide , jds , jde , kds , kde ,     &amp;<a name='1247'>
                              ims , ime , jms , jme , kms , kme ,     &amp;<a name='1248'>
                              its , ite , jts , jte , kts , kte )<a name='1249'>
<a name='1250'>
<font color=#447700>! interpolate to model model levels<a name='1251'></font>
        call <A href='../../html_code/phys/module_radiation_driver.F.html#OZN_P_INT'>ozn_p_int</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OZN_P_INT_1">(p ,pin, levsiz, ozmixt, o3rad, &amp;<a name='1252'>
                              ids , ide , jds , jde , kds , kde ,     &amp;<a name='1253'>
                              ims , ime , jms , jme , kms , kme ,     &amp;<a name='1254'>
                              its , ite , jts , jte , kts , kte )<a name='1255'>
     ENDIF<a name='1256'>
<a name='1257'>
     IF ( PRESENT( AEROD ) ) THEN<a name='1258'>
     IF ( aer_opt .EQ. 1 .AND. id .EQ. 1 ) THEN<a name='1259'>
        call <A href='../../html_code/phys/module_radiation_driver.F.html#AER_TIME_INT'>aer_time_int</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AER_TIME_INT_1">(julday,julian,aerodm,aerodt,alevsiz,n_ozmixm-1,no_src_types,    &amp;<a name='1260'>
                              ids , ide , jds , jde , kds , kde ,     &amp;<a name='1261'>
                              ims , ime , jms , jme , kms , kme ,     &amp;<a name='1262'>
                              its , ite , jts , jte , kts , kte )<a name='1263'>
<a name='1264'>
        call <A href='../../html_code/phys/module_radiation_driver.F.html#AER_P_INT'>aer_p_int</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AER_P_INT_1">(p ,pina, alevsiz, aerodt, aerod, no_src_types, p8w, AODTOT, &amp;<a name='1265'>
                              ids , ide , jds , jde , kds , kde ,     &amp;<a name='1266'>
                              ims , ime , jms , jme , kms , kme ,     &amp;<a name='1267'>
                              its , ite , jts , jte , kts , kte )<a name='1268'>
     ENDIF<a name='1269'>
     ENDIF<a name='1270'>
<a name='1271'>
     <font color=#447700>!Modify CLDFRA and QC for kfcupscheme cumulus scheme<a name='1272'></font>
     if(present(cldfra_cup)) then<a name='1273'>
        <font color=#447700>!BSINGH - overwrite cldfra with the cloud fraction computed in module_cu_kfcup.F        <a name='1274'></font>
        <font color=#447700>!Force cloud fraction if cumulus triggered.<a name='1275'></font>
        if( cu_physics == KFCUPSCHEME ) then<a name='1276'>
           do j = jts,jte<a name='1277'>
              do k = kts,kte<a name='1278'>
                 do i = its,ite<a name='1279'>
<a name='1280'>
                    <font color=#447700>!Find whether to overwrite cldfra or not (ONLY if ICLOUD == 1)<a name='1281'></font>
                    compute_cldfra_cup = .true. <a name='1282'>
                    if (icloud == 1 ) then<a name='1283'>
                       compute_cldfra_cup = .false.  <font color=#447700>!-- LK Berg, 4/26/17     <a name='1284'></font>
                       if(cldfra1_flag(i,k,j) == 1 .and. shall(i,j) .gt. 1) then<a name='1285'>
                          CLDFRA(i,k,j)=0.<a name='1286'>
                       elseif(cldfra1_flag(i,k,j) == 1 .and. shall(i,j) .le. 1) then<a name='1287'>
                          CLDFRA(i,k,j)=0.<a name='1288'>
                          compute_cldfra_cup = .true.    <font color=#447700>! No resolved clouds, but check of shallow clouds.  -- LK Berg, 4/26/17<a name='1289'></font>
                       elseif(cldfra1_flag(i,k,j) == 2 .and. shall(i,j) .gt. 1) then<a name='1290'>
                          CLDFRA(i,k,j)=1.<a name='1291'>
                       elseif(cldfra1_flag(i,k,j) == 3) then<a name='1292'>
                          compute_cldfra_cup = .true.<a name='1293'>
                       endif<a name='1294'>
                    endif<a name='1295'>
<a name='1296'>
<a name='1297'>
                    if(compute_cldfra_cup) then<a name='1298'>
                       if( (int(shall(i,j)) .le.1) .and. k &gt;= int(cubot(i,j)) .and. k &lt;= int(cutop(i,j)) ) then  <font color=#447700>! LD Mar232012<a name='1299'></font>
                          CLDFRA(i,k,j) = cldfra_cup(i,k,j)<a name='1300'>
                       else if( shall(i,j) .gt. 1) then       <font color=#447700>!!LD<a name='1301'></font>
                          cldfra_cup(i,k,j) = 0.0<a name='1302'>
                       end if<a name='1303'>
                    endif<a name='1304'>
                    if( shall(i,j) &lt;= 1 .and. k &gt;= cubot(i,j)  .and. k &lt;= cutop(i,j)  ) then  <font color=#447700>! 1=Shallow Cu  -- Changed to use for both deep and shallow  -- LK Berg 4/26/17<a name='1305'></font>
                       <font color=#447700>! Begin: wig, 4-Feb-2008<a name='1306'></font>
                       <font color=#447700>!<a name='1307'></font>
                       <font color=#447700>! Override the cloud condensate values if shallow convection triggered.<a name='1308'></font>
                       <font color=#447700>! For shallow convection, use a representative condensate value based on<a name='1309'></font>
                       <font color=#447700>! observations from CHAPS (Oklahoma area) and Florida (Blyth et al. 2005)<a name='1310'></font>
                       <font color=#447700>! or the predicted value if it is greater.<a name='1311'></font>
<a name='1312'>
                       cldfra_cup_mod = cldfra_cup(i,k,j) * 1.0e-3 <font color=#447700>!modified cloud fraction, assume QCLOUD is 1 g/kg -- LK Berg 4/26/17                       <a name='1313'></font>
                       qc(i,k,j) = max(cldfra_cup_mod, qc(i,k,j) )<font color=#447700>!DE+LB 2012-Feb<a name='1314'></font>
<a name='1315'>
                       <font color=#447700>! Override the cloud fraction values calculated above if shallow<a name='1316'></font>
                       <font color=#447700>! convection triggered. For shallow convection, use a representative<a name='1317'></font>
                       <font color=#447700>! cloud fraction. In this case, the median value for shallow Cu cases<a name='1318'></font>
                       <font color=#447700>! at the ARM SGP site, 36%, Berg et al. 2008, J. Clim.<a name='1319'></font>
                       if( shallowcu_forced_ra )cldfra(i,k,j) = max(0.36, cldfra(i,k,j)) <font color=#447700>! Median shallow Cu frac at ARM SGP<a name='1320'></font>
                    endif<a name='1321'>
                 ENDDO<a name='1322'>
              ENDDO<a name='1323'>
           ENDDO<a name='1324'>
        end if<a name='1325'>
     endif<a name='1326'>
        <a name='1327'>
<a name='1328'>
     lwrad_select: SELECT CASE(lw_physics)<a name='1329'>
<a name='1330'>
        CASE (RRTMSCHEME)<a name='1331'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_805"> (100, 'CALL rrtm')<a name='1332'>
<a name='1333'>
             IF ( PRESENT(p_top) ) THEN<a name='1334'>
                p_top_dummy = p_top<a name='1335'>
             ELSE<a name='1336'>
                p_top_dummy = -1. <font color=#447700>! not used by NMM<a name='1337'></font>
             END IF<a name='1338'>
             CALL <A href='../../html_code/phys/module_ra_rrtm.F.html#RRTMLWRAD'>RRTMLWRAD</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RRTMLWRAD_1">(                                        &amp;<a name='1339'>
                  P_TOP=p_top_dummy                                 &amp; <a name='1340'>
                 ,RTHRATEN=RTHRATEN,GLW=GLW,OLR=RLWTOA,EMISS=EMISS  &amp;<a name='1341'>
                 ,QV3D=QV                                           &amp;<a name='1342'>
                 ,QC3D=QC                                           &amp;<a name='1343'>
                 ,QR3D=QR                                           &amp;<a name='1344'>
                 ,QI3D=QI                                           &amp;<a name='1345'>
                 ,QS3D=QS                                           &amp;<a name='1346'>
                 ,QG3D=QG                                           &amp;<a name='1347'>
                 ,P8W=p8w,P3D=p,PI3D=pi,DZ8W=dz8w,TSK=tsk,T3D=t     &amp;<a name='1348'>
                 ,T8W=t8w,RHO3D=rho, CLDFRA3D=CLDFRA,R=R_d,G=G      &amp;<a name='1349'>
                 ,F_QV=F_QV,F_QC=F_QC,F_QR=F_QR                     &amp;<a name='1350'>
                 ,F_QI=F_QI,F_QS=F_QS,F_QG=F_QG                     &amp;<a name='1351'>
                 ,ICLOUD=icloud,WARM_RAIN=warm_rain                 &amp;<a name='1352'>
<font color=#447700>!ccc Added for time-varying trace gases.<a name='1353'></font>
                 ,YR=YR,JULIAN=JULIAN                               &amp;<a name='1354'>
<font color=#447700>!ccc<a name='1355'></font>
                 ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde &amp;     <a name='1356'>
                 ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme &amp;<a name='1357'>
                 ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte &amp;<a name='1358'>
                                                                    )<a name='1359'>
<a name='1360'>
        CASE (goddardlwscheme)<a name='1361'>
<a name='1362'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_806"> (100, 'CALL goddard longwave radiation scheme ')<a name='1363'>
             IF (itimestep.eq.1) then<a name='1364'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_888">('running goddard lw radiation')<a name='1365'>
             ENDIF<a name='1366'>
             CALL <A href='../../html_code/phys/module_ra_goddard.F.html#GODDARDRAD'>goddardrad</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GODDARDRAD_1">(sw_or_lw='lw'                             &amp;<a name='1367'>
                    ,rthraten=rthraten,gsf=glw,xlat=xlat,xlong=xlong   &amp;<a name='1368'>
                    ,alb=albedo,t3d=t,p3d=p,p8w3d=p8w,pi3d=pi          &amp;<a name='1369'>
                    ,dz8w=dz8w,rho_phy=rho,emiss=emiss                 &amp;<a name='1370'>
                    ,cldfra3d=cldfra                                   &amp;<a name='1371'>
                    ,gmt=gmt,cp=cp,g=g,t8w=t8w                         &amp;<a name='1372'>
                    ,julday=julday,xtime=xtime                         &amp;<a name='1373'>
                    ,declin=declin,solcon=solcon                       &amp;<a name='1374'>
                    , center_lat = cen_lat                             &amp;<a name='1375'>
                    ,radfrq=radt,degrad=degrad                         &amp;<a name='1376'>
                    ,taucldi=taucldi,taucldc=taucldc                   &amp;<a name='1377'>
                    ,warm_rain=warm_rain                               &amp;<a name='1378'>
                    ,ids=ids,ide=ide, jds=jds,jde=jde, kds=kds,kde=kde &amp;<a name='1379'>
                    ,ims=ims,ime=ime, jms=jms,jme=jme, kms=kms,kme=kme &amp;<a name='1380'>
                    ,its=its,ite=ite, jts=jts,jte=jte, kts=kts,kte=kte &amp;<a name='1381'>
<font color=#447700>!                    ,cosz_urb2d=cosz_urb2d ,omg_urb2d=omg_urb2d        &amp; !urban<a name='1382'></font>
                    ,qv3d=qv                                           &amp;<a name='1383'>
                    ,qc3d=qc                                           &amp;<a name='1384'>
                    ,qr3d=qr                                           &amp;<a name='1385'>
                    ,qi3d=qi                                           &amp;<a name='1386'>
                    ,qs3d=qs                                           &amp;<a name='1387'>
                    ,qg3d=qg                                           &amp;<a name='1388'>
                    ,f_qv=f_qv,f_qc=f_qc,f_qr=f_qr                     &amp;<a name='1389'>
                    ,f_qi=f_qi,f_qs=f_qs,f_qg=f_qg                     &amp;<a name='1390'>
                    ,erbe_out=erbe_out                                 &amp; <font color=#447700>!optional<a name='1391'></font>
                    ,aer_opt=aer_opt                                   &amp;<a name='1392'>
                    ,tauaer3d_sw=tauaer_sw                             &amp; <font color=#447700>! jararias, 2013/11<a name='1393'></font>
                    ,ssaaer3d_sw=ssaaer_sw                             &amp; <font color=#447700>! jararias, 2013/11<a name='1394'></font>
                    ,asyaer3d_sw=asyaer_sw                             &amp; <font color=#447700>! jararias, 2012/11<a name='1395'></font>
                                                                       )<a name='1396'>
<a name='1397'>
        CASE (GFDLLWSCHEME)<a name='1398'>
<a name='1399'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_807"> (100, 'CALL gfdllw')<a name='1400'>
<a name='1401'>
             IF ( PRESENT(F_QV) .AND. PRESENT(F_QC) .AND.                     &amp;<a name='1402'>
                  PRESENT(F_QI) .AND. (PRESENT(qi) .OR. PRESENT(qs))  .AND.                     &amp;<a name='1403'>
                  PRESENT(qv)   .AND. PRESENT(qc)   ) THEN<a name='1404'>
               IF ( F_QV .AND. F_QC .AND. (F_QI .OR. F_QS)) THEN<a name='1405'>
                 gfdl_lw  = .true.<a name='1406'>
                 CALL <A href='../../html_code/phys/module_ra_gfdleta.F.html#ETARA'>ETARA</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ETARA_1">(                                        &amp;<a name='1407'>
                  DT=dt,XLAND=xland                                 &amp;<a name='1408'>
                 ,P8W=p8w,DZ8W=dz8w,RHO_PHY=rho,P_PHY=p,T=t         &amp;<a name='1409'>
                 ,QV=qv,QW=qc_temp,QI=qi,QS=qs                      &amp;<a name='1410'>
                 ,TSK2D=tsk,GLW=GLW,RSWIN=SWDOWN,GSW=GSW            &amp;<a name='1411'>
                 ,RSWINC=SWDOWNC,CLDFRA=CLDFRA,PI3D=pi              &amp;<a name='1412'>
                 ,GLAT=glat,GLON=glon,HTOP=htop,HBOT=hbot           &amp;<a name='1413'>
                 ,HBOTR=hbotr, HTOPR=htopr                          &amp;<a name='1414'>
                 ,ALBEDO=albedo,CUPPT=cuppt                         &amp;<a name='1415'>
                 ,VEGFRA=vegfra,SNOW=snow,G=g,GMT=gmt               &amp;<a name='1416'>
                 ,NSTEPRA=stepra,NPHS=nphs,ITIMESTEP=itimestep      &amp;<a name='1417'>
                 ,XTIME=xtime,JULIAN=julian                         &amp;<a name='1418'>
                 ,JULYR=julyr,JULDAY=julday                         &amp;<a name='1419'>
                 ,GFDL_LW=gfdl_lw,GFDL_SW=gfdl_sw                   &amp;<a name='1420'>
                 ,CFRACL=cfracl,CFRACM=cfracm,CFRACH=cfrach         &amp;<a name='1421'>
                 ,ACFRST=acfrst,NCFRST=ncfrst                       &amp;<a name='1422'>
                 ,ACFRCV=acfrcv,NCFRCV=ncfrcv                       &amp;<a name='1423'>
                 ,RSWTOA=rswtoa,RLWTOA=rlwtoa,CZMEAN=czmean         &amp;<a name='1424'>
                 ,THRATEN=rthraten,THRATENLW=rthratenlw             &amp;<a name='1425'>
                 ,THRATENSW=rthratensw                              &amp;<a name='1426'>
                 ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde &amp;     <a name='1427'>
                 ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme &amp;<a name='1428'>
                 ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte &amp;<a name='1429'>
                                                                    )<a name='1430'>
               ELSE<a name='1431'>
                 CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1123">('Can not call <A href='../../html_code/phys/module_ra_gfdleta.F.html#ETARA'>ETARA</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ETARA_2"> (1a). Missing moisture fields.')<a name='1432'>
               ENDIF<a name='1433'>
             ELSE<a name='1434'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1124">('Can not call <A href='../../html_code/phys/module_ra_gfdleta.F.html#ETARA'>ETARA</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ETARA_3"> (1b). Missing moisture fields.')<a name='1435'>
             ENDIF<a name='1436'>
<a name='1437'>
#if ( HWRF == 1 )<a name='1438'>
       CASE (HWRFLWSCHEME)<a name='1439'>
<a name='1440'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_808"> (100, 'CALL hwrflw')<a name='1441'>
<a name='1442'>
             gfdl_lw  = .true.<a name='1443'>
<a name='1444'>
               CALL <A href='../../html_code/phys/module_ra_HWRF.F.html#HWRFRA'>HWRFRA</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HWRFRA_1">(explicit_convection=expl_conv, &amp;<a name='1445'>
                    DT=dt,thraten=RTHRATEN,thratenlw=RTHRATENLW,thratensw=RTHRATENSW,pi3d=pi, &amp;<a name='1446'>
                        XLAND=xland,P8w=p8w,DZ8w=dz8w,RHO_PHY=rho,P_PHY=p,T=t,          &amp;<a name='1447'>
                        QV=qv,QW=qc_temp,QI=Qi,                      &amp;<a name='1448'>
                        TSK2D=tsk,GLW=GLW,GSW=GSW,                                 &amp;<a name='1449'>
                        TOTSWDN=swdown,TOTLWDN=glw,RSWTOA=rswtoa,RLWTOA=rlwtoa,CZMEAN=czmean,        &amp; <font color=#447700>!Added<a name='1450'></font>
                        GLAT=glat,GLON=glon,HTOP=htop,HBOT=hbot,htopr=htopr,hbotr=hbotr,ALBEDO=albedo,CUPPT=cuppt,&amp;<a name='1451'>
                        VEGFRA=vegfra,SNOW=snow,G=g,GMT=gmt,                           &amp; <font color=#447700>!Modified<a name='1452'></font>
                        NSTEPRA=stepra,NPHS=nphs,itimestep=itimestep,                       &amp; <font color=#447700>!Modified<a name='1453'></font>
                        julyr=julyr,julday=julday,gfdl_lw=gfdl_lw,gfdl_sw=gfdl_sw,                &amp;<a name='1454'>
                        CFRACL=cfracl,CFRACM=cfracm,CFRACH=cfrach,                        &amp; <font color=#447700>!Added<a name='1455'></font>
                        ACFRST=acfrst,NCFRST=ncfrst,ACFRCV=acfrcv,NCFRCV=ncfrcv,                 &amp; <font color=#447700>!Added<a name='1456'></font>
                        ids=ids,ide=ide, jds=jds,jde=jde, kds=kds,kde=kde,                   &amp;<a name='1457'>
                        ims=ims,ime=ime, jms=jms,jme=jme, kms=kms,kme=kme,                   &amp;<a name='1458'>
                        its=its,ite=ite, jts=jts,jte=jte, kts=kts,kte=kte                    )<a name='1459'>
<a name='1460'>
<a name='1461'>
#endif<a name='1462'>
<a name='1463'>
        CASE (CAMLWSCHEME)<a name='1464'>
<a name='1465'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_809">(100, 'CALL camrad lw')<a name='1466'>
<a name='1467'>
             IF ( PRESENT( OZMIXM ) .AND. PRESENT( PIN ) .AND. &amp;<a name='1468'>
                  PRESENT(M_PS_1) .AND. PRESENT(M_PS_2) .AND.  &amp;<a name='1469'>
                  PRESENT(M_HYBI0) .AND. PRESENT(AEROSOLC_1)    &amp;<a name='1470'>
                  .AND. PRESENT(AEROSOLC_2).AND. PRESENT(ALSWVISDIR) ) THEN<a name='1471'>
             CALL <A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD'>CAMRAD</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAMRAD_1">(RTHRATENLW=RTHRATEN,RTHRATENSW=RTHRATENSW,    &amp;<a name='1472'>
                     dolw=.true.,dosw=.false.,                         &amp;<a name='1473'>
                     SWUPT=SWUPT,SWUPTC=SWUPTC,                        &amp;<a name='1474'>
                     SWDNT=SWDNT,SWDNTC=SWDNTC,                        &amp;<a name='1475'>
                     LWUPT=LWUPT,LWUPTC=LWUPTC,                        &amp;<a name='1476'>
                     LWDNT=LWDNT,LWDNTC=LWDNTC,                        &amp;<a name='1477'>
                     SWUPB=SWUPB,SWUPBC=SWUPBC,                        &amp;<a name='1478'>
                     SWDNB=SWDNB,SWDNBC=SWDNBC,                        &amp;<a name='1479'>
                     LWUPB=LWUPB,LWUPBC=LWUPBC,                        &amp;<a name='1480'>
                     LWDNB=LWDNB,LWDNBC=LWDNBC,                        &amp;<a name='1481'>
                     SWCF=SWCF,LWCF=LWCF,OLR=RLWTOA,CEMISS=CEMISS,     &amp;<a name='1482'>
                     TAUCLDC=TAUCLDC,TAUCLDI=TAUCLDI,COSZR=COSZR,      &amp;<a name='1483'>
                     GSW=GSW,GLW=GLW,XLAT=XLAT,XLONG=XLONG,            &amp;<a name='1484'>
                     ALBEDO=ALBEDO,t_phy=t,TSK=TSK,EMISS=EMISS         &amp;<a name='1485'>
                    ,QV3D=qv                                           &amp;<a name='1486'>
                    ,QC3D=qc                                           &amp;<a name='1487'>
                    ,QR3D=qr                                           &amp;<a name='1488'>
                    ,QI3D=qi                                           &amp;<a name='1489'>
                    ,QS3D=qs                                           &amp;<a name='1490'>
                    ,QG3D=qg                                           &amp;<a name='1491'>
                    ,ALSWVISDIR=alswvisdir ,ALSWVISDIF=alswvisdif      &amp;  <font color=#447700>!fds ssib alb comp (06/2010)<a name='1492'></font>
                    ,ALSWNIRDIR=alswnirdir ,ALSWNIRDIF=alswnirdif      &amp;  <font color=#447700>!fds ssib alb comp (06/2010)<a name='1493'></font>
                    ,SWVISDIR=swvisdir ,SWVISDIF=swvisdif              &amp;  <font color=#447700>!fds ssib swr comp (06/2010)<a name='1494'></font>
                    ,SWNIRDIR=swnirdir ,SWNIRDIF=swnirdif              &amp;  <font color=#447700>!fds ssib swr comp (06/2010)<a name='1495'></font>
                    ,SF_SURFACE_PHYSICS=sf_surface_physics             &amp;  <font color=#447700>!fds<a name='1496'></font>
                    ,SWDDIR=swddir,SWDDIF=swddif,SWDDNI=swddni         &amp;  <font color=#447700>!amontornes-bcodina (2014-04-20)<a name='1497'></font>
                    ,F_QV=f_qv,F_QC=f_qc,F_QR=f_qr                     &amp;<a name='1498'>
                    ,F_QI=f_qi,F_QS=f_qs,F_QG=f_qg                     &amp;<a name='1499'>
                    ,f_ice_phy=f_ice_phy,f_rain_phy=f_rain_phy         &amp;<a name='1500'>
                    ,p_phy=p,p8w=p8w,z=z,pi_phy=pi,rho_phy=rho,        &amp;<a name='1501'>
                     dz8w=dz8w,                                        &amp;<a name='1502'>
                     CLDFRA=CLDFRA,XLAND=XLAND,XICE=XICE,SNOW=SNOW,    &amp;<a name='1503'>
                     ozmixm=ozmixm,pin0=pin,levsiz=levsiz,             &amp;<a name='1504'>
                     num_months=n_ozmixm,                              &amp;<a name='1505'>
                     m_psp=m_ps_1,m_psn=m_ps_2,aerosolcp=aerosolc_1,   &amp;<a name='1506'>
                     aerosolcn=aerosolc_2,m_hybi0=m_hybi0,             &amp;<a name='1507'>
                     paerlev=paerlev, naer_c=n_aerosolc,               &amp;<a name='1508'>
                     cam_abs_dim1=cam_abs_dim1, cam_abs_dim2=cam_abs_dim2, &amp;<a name='1509'>
                     GMT=GMT,JULDAY=JULDAY,JULIAN=JULIAN,YR=YR,DT=DT,XTIME=XTIME,DECLIN=DECLIN,  &amp;<a name='1510'>
                     SOLCON=SOLCON,RADT=RADT,DEGRAD=DEGRAD,n_cldadv=3  &amp;<a name='1511'>
                   ,abstot_3d=abstot,absnxt_3d=absnxt,emstot_3d=emstot &amp;<a name='1512'>
                   ,doabsems=doabsems                               &amp;<a name='1513'>
                 ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde &amp;     <a name='1514'>
                 ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme &amp;<a name='1515'>
                 ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte &amp;<a name='1516'>
                 ,coszen=coszen                                     )<a name='1517'>
             ELSE<a name='1518'>
                CALL wrf_error_fatal ( 'arguments not present for calling cam radiation' )<a name='1519'>
             ENDIF<a name='1520'>
<a name='1521'>
        CASE (RRTMG_LWSCHEME)<a name='1522'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_810"> (100, 'CALL rrtmg_lw')<a name='1523'>
             CALL <A href='../../html_code/phys/module_ra_rrtmg_lw.F.html#RRTMG_LWRAD'>RRTMG_LWRAD</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RRTMG_LWRAD_1">(                                      &amp;<a name='1524'>
                  RTHRATENLW=RTHRATEN,                              &amp;<a name='1525'>
                  LWUPT=LWUPT,LWUPTC=LWUPTC,                        &amp;<a name='1526'>
                  LWDNT=LWDNT,LWDNTC=LWDNTC,                        &amp;<a name='1527'>
                  LWUPB=LWUPB,LWUPBC=LWUPBC,                        &amp;<a name='1528'>
                  LWDNB=LWDNB,LWDNBC=LWDNBC,                        &amp;<a name='1529'>
                  GLW=GLW,OLR=RLWTOA,LWCF=LWCF,                     &amp;<a name='1530'>
                  EMISS=EMISS,                                      &amp;<a name='1531'>
                  P8W=p8w,P3D=p,PI3D=pi,DZ8W=dz8w,TSK=tsk,T3D=t,    &amp;<a name='1532'>
                  T8W=t8w,RHO3D=rho,R=R_d,G=G,                      &amp;<a name='1533'>
                  ICLOUD=icloud,WARM_RAIN=warm_rain,CLDFRA3D=CLDFRA,&amp;<a name='1534'>
#if (EM_CORE == 1)<a name='1535'>
                  LRADIUS=lradius, IRADIUS=iradius,                 &amp;<a name='1536'>
#endif<a name='1537'>
                  IS_CAMMGMP_USED=is_cammgmp_used,                  &amp;<a name='1538'>
<a name='1539'>
<font color=#447700>!ckay<a name='1540'></font>
<font color=#447700>!                 CLDFRA_KF3D=cldfra_KF,QC_KF3D=qc_KF,QI_KF3D=qi_KF,&amp;<a name='1541'></font>
                  F_ICE_PHY=F_ICE_PHY,F_RAIN_PHY=F_RAIN_PHY,        &amp;<a name='1542'>
                  XLAND=XLAND,XICE=XICE,SNOW=SNOW,                  &amp;<a name='1543'>
                  QV3D=QV,QC3D=QC,QR3D=QR,                          &amp;<a name='1544'>
                  QI3D=QI,QS3D=QS,QG3D=QG,                          &amp;<a name='1545'>
                  O3INPUT=O3INPUT,O33D=O3RAD,                       &amp;<a name='1546'>
                  F_QV=F_QV,F_QC=F_QC,F_QR=F_QR,                    &amp;<a name='1547'>
                  F_QI=F_QI,F_QS=F_QS,F_QG=F_QG,                    &amp;<a name='1548'>
                  RE_CLOUD=re_cloud,RE_ICE=re_ice,RE_SNOW=re_snow,  &amp; <font color=#447700>! G. Thompson<a name='1549'></font>
                  has_reqc=has_reqc,has_reqi=has_reqi,has_reqs=has_reqs, &amp; <font color=#447700>! G. Thompson<a name='1550'></font>
#if ( WRF_CHEM == 1 )<a name='1551'>
                  TAUAERLW1=tauaerlw1,TAUAERLW2=tauaerlw2,          &amp; <font color=#447700>! jcb<a name='1552'></font>
                  TAUAERLW3=tauaerlw3,TAUAERLW4=tauaerlw4,          &amp; <font color=#447700>! jcb<a name='1553'></font>
                  TAUAERLW5=tauaerlw5,TAUAERLW6=tauaerlw6,          &amp; <font color=#447700>! jcb<a name='1554'></font>
                  TAUAERLW7=tauaerlw7,TAUAERLW8=tauaerlw8,          &amp; <font color=#447700>! jcb<a name='1555'></font>
                  TAUAERLW9=tauaerlw9,TAUAERLW10=tauaerlw10,        &amp; <font color=#447700>! jcb<a name='1556'></font>
                  TAUAERLW11=tauaerlw11,TAUAERLW12=tauaerlw12,      &amp; <font color=#447700>! jcb<a name='1557'></font>
                  TAUAERLW13=tauaerlw13,TAUAERLW14=tauaerlw14,      &amp; <font color=#447700>! jcb<a name='1558'></font>
                  TAUAERLW15=tauaerlw15,TAUAERLW16=tauaerlw16,      &amp; <font color=#447700>! jcb<a name='1559'></font>
                  aer_ra_feedback=aer_ra_feedback,                  &amp;<a name='1560'>
<font color=#447700>!jdfcz            progn=progn,prescribe=prescribe,                   &amp;<a name='1561'></font>
                  progn=progn,                                      &amp;<a name='1562'>
#endif<a name='1563'>
                  QNDROP3D=qndrop,F_QNDROP=f_qndrop,                &amp;<a name='1564'>
<font color=#447700>!ccc Added for time-varying trace gases.<a name='1565'></font>
                  YR=YR,JULIAN=JULIAN,                              &amp;<a name='1566'>
<font color=#447700>!ccc<a name='1567'></font>
                  IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde,&amp;<a name='1568'>
                  IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme,&amp;<a name='1569'>
                  ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte,&amp;<a name='1570'>
                  LWUPFLX=LWUPFLX,LWUPFLXC=LWUPFLXC,                &amp;<a name='1571'>
                  LWDNFLX=LWDNFLX,LWDNFLXC=LWDNFLXC,                &amp;<a name='1572'>
                  mp_physics=mp_physics                             )<a name='1573'>
<a name='1574'>
        CASE (RRTMG_LWSCHEME_FAST)<a name='1575'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_811"> (100, 'CALL rrtmg_lw')<a name='1576'>
<a name='1577'>
             CALL <A href='../../html_code/phys/module_ra_rrtmg_lwf.F.html#RRTMG_LWRAD_FAST'>RRTMG_LWRAD_FAST</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RRTMG_LWRAD_FAST_1">(                                 &amp;<a name='1578'>
                  RTHRATENLW=RTHRATEN,                              &amp;<a name='1579'>
                  LWUPT=LWUPT,LWUPTC=LWUPTC,                        &amp;<a name='1580'>
                  LWDNT=LWDNT,LWDNTC=LWDNTC,                        &amp;<a name='1581'>
                  LWUPB=LWUPB,LWUPBC=LWUPBC,                        &amp;<a name='1582'>
                  LWDNB=LWDNB,LWDNBC=LWDNBC,                        &amp;<a name='1583'>
                  GLW=GLW,OLR=RLWTOA,LWCF=LWCF,                     &amp;<a name='1584'>
                  EMISS=EMISS,                                      &amp;<a name='1585'>
                  P8W=p8w,P3D=p,PI3D=pi,DZ8W=dz8w,TSK=tsk,T3D=t,    &amp;<a name='1586'>
                  T8W=t8w,RHO3D=rho,R=R_d,G=G,                      &amp;<a name='1587'>
                  ICLOUD=icloud,WARM_RAIN=warm_rain,CLDFRA3D=CLDFRA,&amp;<a name='1588'>
#if (EM_CORE == 1)<a name='1589'>
                  LRADIUS=lradius, IRADIUS=iradius,                 &amp;<a name='1590'>
#endif<a name='1591'>
                  IS_CAMMGMP_USED=is_cammgmp_used,                  &amp;<a name='1592'>
<a name='1593'>
<font color=#447700>!ckay<a name='1594'></font>
<font color=#447700>!                 CLDFRA_KF3D=cldfra_KF,QC_KF3D=qc_KF,QI_KF3D=qi_KF,&amp;<a name='1595'></font>
                  F_ICE_PHY=F_ICE_PHY,F_RAIN_PHY=F_RAIN_PHY,        &amp;<a name='1596'>
                  XLAND=XLAND,XICE=XICE,SNOW=SNOW,                  &amp;<a name='1597'>
                  QV3D=QV,QC3D=QC,QR3D=QR,                          &amp;<a name='1598'>
                  QI3D=QI,QS3D=QS,QG3D=QG,                          &amp;<a name='1599'>
                  O3INPUT=O3INPUT,O33D=O3RAD,                       &amp;<a name='1600'>
                  F_QV=F_QV,F_QC=F_QC,F_QR=F_QR,                    &amp;<a name='1601'>
                  F_QI=F_QI,F_QS=F_QS,F_QG=F_QG,                    &amp;<a name='1602'>
                  RE_CLOUD=re_cloud,RE_ICE=re_ice,RE_SNOW=re_snow,  &amp; <font color=#447700>! G. Thompson<a name='1603'></font>
                  has_reqc=has_reqc,has_reqi=has_reqi,has_reqs=has_reqs, &amp; <font color=#447700>! G. Thompson<a name='1604'></font>
#if ( WRF_CHEM == 1 )<a name='1605'>
                  TAUAERLW1=tauaerlw1,TAUAERLW2=tauaerlw2,          &amp; <font color=#447700>! jcb<a name='1606'></font>
                  TAUAERLW3=tauaerlw3,TAUAERLW4=tauaerlw4,          &amp; <font color=#447700>! jcb<a name='1607'></font>
                  TAUAERLW5=tauaerlw5,TAUAERLW6=tauaerlw6,          &amp; <font color=#447700>! jcb<a name='1608'></font>
                  TAUAERLW7=tauaerlw7,TAUAERLW8=tauaerlw8,          &amp; <font color=#447700>! jcb<a name='1609'></font>
                  TAUAERLW9=tauaerlw9,TAUAERLW10=tauaerlw10,        &amp; <font color=#447700>! jcb<a name='1610'></font>
                  TAUAERLW11=tauaerlw11,TAUAERLW12=tauaerlw12,      &amp; <font color=#447700>! jcb<a name='1611'></font>
                  TAUAERLW13=tauaerlw13,TAUAERLW14=tauaerlw14,      &amp; <font color=#447700>! jcb<a name='1612'></font>
                  TAUAERLW15=tauaerlw15,TAUAERLW16=tauaerlw16,      &amp; <font color=#447700>! jcb<a name='1613'></font>
                  aer_ra_feedback=aer_ra_feedback,                  &amp;<a name='1614'>
<font color=#447700>!jdfcz            progn=progn,prescribe=prescribe,                   &amp;<a name='1615'></font>
                  progn=progn,                                      &amp;<a name='1616'>
#endif<a name='1617'>
                  QNDROP3D=qndrop,F_QNDROP=f_qndrop,                &amp;<a name='1618'>
<font color=#447700>!ccc Added for time-varying trace gases.<a name='1619'></font>
                  YR=YR,JULIAN=JULIAN,                              &amp;<a name='1620'>
<font color=#447700>!ccc<a name='1621'></font>
                  IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde,&amp;<a name='1622'>
                  IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme,&amp;<a name='1623'>
                  ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte,&amp;<a name='1624'>
                  LWUPFLX=LWUPFLX,LWUPFLXC=LWUPFLXC,                &amp;<a name='1625'>
                  LWDNFLX=LWDNFLX,LWDNFLXC=LWDNFLXC                 &amp;<a name='1626'>
                                                                    )<a name='1627'>
<a name='1628'>
        CASE (HELDSUAREZ)<a name='1629'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_812"> (100, 'CALL heldsuarez')<a name='1630'>
<a name='1631'>
             CALL <A href='../../html_code/phys/module_ra_hs.F.html#HSRAD'>HSRAD</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HSRAD_1">(RTHRATEN,p8w,p,pi,dz8w,t,          &amp;<a name='1632'>
                     t8w, rho, R_d,G,CP, dt, xlat, degrad, &amp;<a name='1633'>
                     ids,ide, jds,jde, kds,kde,            &amp;<a name='1634'>
                     ims,ime, jms,jme, kms,kme,            &amp;<a name='1635'>
                     its,ite, jts,jte, kts,kte            )<a name='1636'>
<a name='1637'>
<font color=#447700>! -- add by Jin Kong 10/2011<a name='1638'></font>
        CASE (FLGLWSCHEME)<a name='1639'>
          CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_813"> (100, 'CALL Fu-Liou-Gu')<a name='1640'>
          flg_lw  = .true.<a name='1641'>
<font color=#447700>!test Jin Kong 11/01/2011 for ozone<a name='1642'></font>
          ozflg = 0.<a name='1643'>
<font color=#447700>!test over<a name='1644'></font>
          CALL <A href='../../html_code/phys/module_ra_flg.F.html#RAD_FLG'>RAD_FLG</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAD_FLG_1">(                               &amp;<a name='1645'>
               peven=p8w,podd=p,t8w=t8w,degrees=t     &amp;<a name='1646'>
              ,pi3d=pi,o3=ozflg                       &amp;<a name='1647'>
              ,G=G,CP=CP                              &amp;<a name='1648'>
              ,albedo=ALBEDO,tskin=tsk                &amp;<a name='1649'>
              ,h2o=QV,cld_iccld=QI,cld_wlcld=QC       &amp;<a name='1650'>
              ,cld_prwc=QR,cld_pgwc=QG,cld_snow=QS    &amp;<a name='1651'>
              ,F_QV=F_QV,F_QC=F_QC,F_QR=F_QR          &amp;<a name='1652'>
              ,F_QI=F_QI,F_QS=F_QS,F_QG=F_QG          &amp;<a name='1653'>
              ,warm_rain=warm_rain                    &amp;<a name='1654'>
              ,cloudstrf=CLDFRA                       &amp;<a name='1655'>
              ,emiss=EMISS                            &amp;<a name='1656'>
              ,air_den=rho                            &amp;<a name='1657'>
              ,dz3d=dz8w                              &amp;<a name='1658'>
              ,SOLCON=SOLCON                          &amp;<a name='1659'>
              ,declin=DECLIN                          &amp;<a name='1660'>
              ,xtime=xtime, xlong=xlong, xlat=xlat    &amp;<a name='1661'>
              ,JULDAY=JULDAY                          &amp;<a name='1662'>
              ,gmt=gmt, radt=radt, degrad=degrad      &amp;<a name='1663'>
              ,dtcolumn=dt                            &amp;<a name='1664'>
              ,ids=ids,ide=ide,jds=jds,jde=jde        &amp;<a name='1665'>
              ,kds=kds,kde=kde                        &amp;     <a name='1666'>
              ,ims=ims,idim=ime,jms=jms,jdim=jme      &amp;<a name='1667'>
              ,kms=kms,kmax=kme                       &amp;<a name='1668'>
              ,its=its,ite=ite,jts=jts,jte=jte        &amp;<a name='1669'>
              ,kts=kts,kte=kte                        &amp;<a name='1670'>
	      ,uswtop=RSWTOA,ulwtop=RLWTOA            &amp;<a name='1671'>
	      ,NETSWBOT=GSW,DLWBOT=GLW                &amp;<a name='1672'>
	      ,DSWBOT=SWDOWN,deltat=RTHRATEN          &amp;<a name='1673'>
	      ,dtshort=RTHRATENSW,dtlongwv=RTHRATENLW &amp;<a name='1674'>
              ,SWDDIR=swddir,SWDDIF=swddif,SWDDNI=swddni &amp;  <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='1675'></font>
              )<a name='1676'>
<a name='1677'>
          CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_814">(100, 'a4 Fu_Liou-Gu')<a name='1678'>
<font color=#447700>! -- end <a name='1679'></font>
<a name='1680'>
        CASE DEFAULT<a name='1681'>
  <a name='1682'>
             WRITE( wrf_err_message , * ) 'The longwave option does not exist: lw_physics = ', lw_physics<a name='1683'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1125"> ( wrf_err_message )<a name='1684'>
           <a name='1685'>
     END SELECT lwrad_select    <a name='1686'>
<a name='1687'>
     IF (lw_physics .gt. 0 .and. .not.gfdl_lw .and. .not.flg_lw) THEN<a name='1688'>
        DO j=jts,jte<a name='1689'>
        DO k=kts,kte<a name='1690'>
        DO i=its,ite<a name='1691'>
           RTHRATENLW(I,K,J)=RTHRATEN(I,K,J)<a name='1692'>
<font color=#447700>! OLR ALSO WILL CONTAIN OUTGOING LONGWAVE FOR RRTM (NMM HAS NO OLR ARRAY)<a name='1693'></font>
           IF(PRESENT(OLR) .AND. K .EQ. 1)OLR(I,J)=RLWTOA(I,J)<a name='1694'>
        ENDDO<a name='1695'>
        ENDDO<a name='1696'>
        ENDDO<a name='1697'>
     ENDIF<a name='1698'>
<a name='1699'>
     IF (lw_physics .eq. goddardlwscheme) THEN<a name='1700'>
          IF ( PRESENT (tlwdn) ) THEN<a name='1701'>
        DO j=jts,jte<a name='1702'>
        DO i=its,ite<a name='1703'>
           tlwdn(i,j) = erbe_out(i,j,1)    <font color=#447700>! TOA LW downwelling flux [W/m2]<a name='1704'></font>
           tlwup(i,j) = erbe_out(i,j,2)    <font color=#447700>! TOA LW upwelling flux [W/m2]<a name='1705'></font>
           slwdn(i,j) = erbe_out(i,j,3)    <font color=#447700>! surface LW downwelling flux [W/m2]<a name='1706'></font>
           slwup(i,j) = erbe_out(i,j,4)    <font color=#447700>! surface LW upwelling flux [W/m2]<a name='1707'></font>
        ENDDO    <a name='1708'>
        ENDDO    <a name='1709'>
          ENDIF<a name='1710'>
     ENDIF       <a name='1711'>
<a name='1712'>
     IF ( PRESENT( AOD5502D ) ) THEN<a name='1713'>
     <font color=#447700>! jararias, 2013/11<a name='1714'></font>
     IF ( aer_opt .EQ. 2 ) THEN<a name='1715'>
     swrad_aerosol_select2: select case(sw_physics)<a name='1716'>
        case(GODDARDSWSCHEME)<a name='1717'>
           call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_815">(100, 'call calc_aerosol_goddard_sw')<a name='1718'>
           call <A href='../../html_code/phys/module_ra_aerosol.F.html#CALC_AEROSOL_GODDARD_SW'>calc_aerosol_goddard_sw</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_AEROSOL_GODDARD_SW_1">(ht,dz8w,p,t,qv,aer_type,aer_aod550_opt,aer_angexp_opt,    &amp;<a name='1719'>
                                        aer_ssa_opt,aer_asy_opt,aer_aod550_val,aer_angexp_val,    &amp;<a name='1720'>
                                        aer_ssa_val,aer_asy_val,aod5502d,angexp2d,aerssa2d,       &amp;<a name='1721'>
                                        aerasy2d,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte, &amp;<a name='1722'>
                                        tauaer_sw,ssaaer_sw,asyaer_sw                             )<a name='1723'>
           do j=jts,jte<a name='1724'>
              do i=its,ite<a name='1725'>
                 do k=kts,kte<a name='1726'>
                    aod5503d(i,k,j)=tauaer_sw(i,k,j,8) <font color=#447700>! band at 550 nm<a name='1727'></font>
                 end do<a name='1728'>
              end do<a name='1729'>
           end do<a name='1730'>
<a name='1731'>
        case(RRTMG_SWSCHEME,RRTMG_SWSCHEME_FAST)<a name='1732'>
           call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_816">(100, 'call calc_aerosol_rrtmg_sw')<a name='1733'>
           call <A href='../../html_code/phys/module_ra_aerosol.F.html#CALC_AEROSOL_RRTMG_SW'>calc_aerosol_rrtmg_sw</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_AEROSOL_RRTMG_SW_1">(ht,dz8w,p,t,qv,aer_type,aer_aod550_opt,aer_angexp_opt,    &amp;<a name='1734'>
                                      aer_ssa_opt,aer_asy_opt,aer_aod550_val,aer_angexp_val,    &amp;<a name='1735'>
                                      aer_ssa_val,aer_asy_val,aod5502d,angexp2d,aerssa2d,       &amp;<a name='1736'>
                                      aerasy2d,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte, &amp;<a name='1737'>
                                      tauaer_sw,ssaaer_sw,asyaer_sw                             )<a name='1738'>
           do j=jts,jte<a name='1739'>
              do i=its,ite<a name='1740'>
                 do k=kts,kte<a name='1741'>
                    aod5503d(i,k,j)=tauaer_sw(i,k,j,10) <font color=#447700>! band at 550 nm<a name='1742'></font>
                 end do<a name='1743'>
              end do<a name='1744'>
           end do<a name='1745'>
<a name='1746'>
        case default<a name='1747'>
     end select swrad_aerosol_select2<a name='1748'>
     ENDIF<a name='1749'>
     ENDIF<a name='1750'>
<a name='1751'>
     <font color=#447700>!..Different treatment for aer_opt=3 using QNWFA+QNIFA aerosol species (Trude)<a name='1752'></font>
<a name='1753'>
     IF (PRESENT(f_qnwfa) .AND. PRESENT(f_qnifa)) THEN<a name='1754'>
       IF (F_QNWFA .AND. aer_opt.eq.3 .AND.                             &amp;<a name='1755'>
                             (sw_physics.eq.RRTMG_SWSCHEME .OR.         &amp;<a name='1756'>
                              sw_physics.eq.RRTMG_SWSCHEME_FAST)) THEN<a name='1757'>
         call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_817">(100, 'call calc_aerosol_rrtmg_sw with 3D AOD values')<a name='1758'>
         call <A href='../../html_code/phys/module_ra_aerosol.F.html#CALC_AEROSOL_RRTMG_SW'>calc_aerosol_rrtmg_sw</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_AEROSOL_RRTMG_SW_2">(ht,dz8w,p,t,qv,taer_type,taer_aod550_opt,taer_angexp_opt,  &amp;<a name='1759'>
                                    taer_ssa_opt,taer_asy_opt,aer_aod550_val,aer_angexp_val,   &amp;<a name='1760'>
                                    aer_ssa_val,aer_asy_val,taod5502d,angexp2d,aerssa2d,       &amp;<a name='1761'>
                                    aerasy2d,ims,ime,jms,jme,kms,kme,its,ite,jts,jte,kts,kte,  &amp;<a name='1762'>
                                    tauaer_sw,ssaaer_sw,asyaer_sw, taod5503d)<a name='1763'>
       ENDIF<a name='1764'>
     ENDIF<a name='1765'>
<a name='1766'>
     swrad_select: SELECT CASE(sw_physics)<a name='1767'>
<a name='1768'>
        CASE (SWRADSCHEME)<a name='1769'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_818">(100, 'CALL swrad')<a name='1770'>
             CALL <A href='../../html_code/phys/module_ra_sw.F.html#SWRAD'>SWRAD</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SWRAD_2">(                                               &amp;<a name='1771'>
                     DT=dt,RTHRATEN=rthraten,GSW=gsw                   &amp;<a name='1772'>
                    ,XLAT=xlat,XLONG=xlong,ALBEDO=albedo               &amp;<a name='1773'>
#if ( WRF_CHEM == 1 )<a name='1774'>
                    ,PM2_5_DRY=pm2_5_dry,PM2_5_WATER=pm2_5_water       &amp;<a name='1775'>
                    ,PM2_5_DRY_EC=pm2_5_dry_ec                         &amp;<a name='1776'>
#endif<a name='1777'>
                    ,RHO_PHY=rho,T3D=t                                 &amp;<a name='1778'>
                    ,P3D=p,PI3D=pi,DZ8W=dz8w,GMT=gmt                   &amp;<a name='1779'>
                    ,R=r_d,CP=cp,G=g,JULDAY=julday                     &amp;<a name='1780'>
                    ,XTIME=xtime,DECLIN=declin,SOLCON=solcon           &amp;<a name='1781'>
                    ,RADFRQ=radt,ICLOUD=icloud,DEGRAD=degrad           &amp;<a name='1782'>
                    ,warm_rain=warm_rain                               &amp;<a name='1783'>
                    ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde &amp;     <a name='1784'>
                    ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme &amp;<a name='1785'>
                    ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte &amp;<a name='1786'>
                    ,QV3D=qv                                           &amp;<a name='1787'>
                    ,QC3D=qc                                           &amp;<a name='1788'>
                    ,QR3D=qr                                           &amp;<a name='1789'>
                    ,QI3D=qi                                           &amp;<a name='1790'>
                    ,QS3D=qs                                           &amp;<a name='1791'>
                    ,QG3D=qg                                           &amp;<a name='1792'>
                    ,F_QV=f_qv,F_QC=f_qc,F_QR=f_qr                     &amp;<a name='1793'>
                    ,F_QI=f_qi,F_QS=f_qs,F_QG=f_qg                     &amp;<a name='1794'>
                    ,coszen=coszen,julian=julian                       )<a name='1795'>
<a name='1796'>
        CASE (GSFCSWSCHEME)<a name='1797'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_819">(100, 'CALL gsfcswrad')<a name='1798'>
             CALL <A href='../../html_code/phys/module_ra_gsfcsw.F.html#GSFCSWRAD'>GSFCSWRAD</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GSFCSWRAD_1">(                                           &amp;<a name='1799'>
                     RTHRATEN=rthraten,GSW=gsw                         &amp; <font color=#447700>! PAJ: xlat and xlong removed.<a name='1800'></font>
                    ,ALB=albedo,T3D=t,P3D=p,P8W3D=p8w,pi3D=pi          &amp;<a name='1801'>
                    ,DZ8W=dz8w,RHO_PHY=rho                             &amp;<a name='1802'>
                    ,CLDFRA3D=cldfra,RSWTOA=rswtoa                     &amp;<a name='1803'>
                    ,CP=cp,G=g                                         &amp; <font color=#447700>! PAJ: GMT removed.<a name='1804'></font>
                    ,JULDAY=julday                                     &amp; <font color=#447700>! PAJ: XTIME removed.<a name='1805'></font>
                    ,SOLCON=solcon                                     &amp; <font color=#447700>! PAJ: declin removed<a name='1806'></font>
<font color=#447700>!                    ,RADFRQ=radt,DEGRAD=degrad                         &amp; ! PAJ: degrad and radfrq removed<a name='1807'></font>
                    ,TAUCLDI=taucldi,TAUCLDC=taucldc                   &amp;<a name='1808'>
                    ,WARM_RAIN=warm_rain                               &amp;<a name='1809'>
<a name='1810'>
#if ( WRF_CHEM == 1 )<a name='1811'>
                    ,TAUAER300=tauaer300,TAUAER400=tauaer400           &amp; <font color=#447700>! jcb<a name='1812'></font>
                    ,TAUAER600=tauaer600,TAUAER999=tauaer999           &amp; <font color=#447700>! jcb<a name='1813'></font>
                    ,GAER300=gaer300,GAER400=gaer400                   &amp; <font color=#447700>! jcb<a name='1814'></font>
                    ,GAER600=gaer600,GAER999=gaer999                   &amp; <font color=#447700>! jcb<a name='1815'></font>
                    ,WAER300=waer300,WAER400=waer400                   &amp; <font color=#447700>! jcb<a name='1816'></font>
                    ,WAER600=waer600,WAER999=waer999                   &amp; <font color=#447700>! jcb<a name='1817'></font>
                    ,aer_ra_feedback=aer_ra_feedback                   &amp;<a name='1818'>
#endif<a name='1819'>
                    ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde &amp;     <a name='1820'>
                    ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme &amp;<a name='1821'>
                    ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte &amp;<a name='1822'>
                    ,QV3D=qv                                           &amp;<a name='1823'>
                    ,QC3D=qc                                           &amp;<a name='1824'>
                    ,QR3D=qr                                           &amp;<a name='1825'>
                    ,QI3D=qi                                           &amp;<a name='1826'>
                    ,QS3D=qs                                           &amp;<a name='1827'>
                    ,QG3D=qg                                           &amp;<a name='1828'>
                    ,QNDROP3D=qndrop                                   &amp;<a name='1829'>
                    ,F_QV=f_qv,F_QC=f_qc,F_QR=f_qr                     &amp;<a name='1830'>
                    ,F_QI=f_qi,F_QS=f_qs,F_QG=f_qg                     &amp;<a name='1831'>
                    ,F_QNDROP=f_qndrop                                 &amp;<a name='1832'>
                    ,COSZEN=coszen                                     &amp;<a name='1833'>
                                                                       )<a name='1834'>
<a name='1835'>
        CASE (goddardswscheme)<a name='1836'>
<a name='1837'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_820">(100, 'CALL goddard shortwave radiation scheme ')<a name='1838'>
             IF (itimestep.eq.1) then<a name='1839'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_889">('running goddard sw radiation')<a name='1840'>
             ENDIF<a name='1841'>
             CALL <A href='../../html_code/phys/module_ra_goddard.F.html#GODDARDRAD'>goddardrad</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GODDARDRAD_2">(sw_or_lw='sw'                             &amp;<a name='1842'>
                    ,rthraten=rthraten,gsf=gsw,xlat=xlat,xlong=xlong   &amp;<a name='1843'>
                    ,alb=albedo,t3d=t,p3d=p,p8w3d=p8w,pi3d=pi          &amp;<a name='1844'>
                    ,dz8w=dz8w,rho_phy=rho,emiss=emiss                 &amp;<a name='1845'>
                    ,cldfra3d=cldfra                                   &amp;<a name='1846'>
                    ,gmt=gmt,cp=cp,g=g,t8w=t8w                         &amp;<a name='1847'>
                    ,julday=julday,xtime=xtime                         &amp;<a name='1848'>
                    ,declin=declin,solcon=solcon                       &amp;<a name='1849'>
                    ,center_lat = cen_lat                              &amp;<a name='1850'>
                    ,radfrq=radt,degrad=degrad                         &amp;<a name='1851'>
                    ,taucldi=taucldi,taucldc=taucldc                   &amp;<a name='1852'>
                    ,warm_rain=warm_rain                               &amp;<a name='1853'>
                    ,ids=ids,ide=ide, jds=jds,jde=jde, kds=kds,kde=kde &amp;<a name='1854'>
                    ,ims=ims,ime=ime, jms=jms,jme=jme, kms=kms,kme=kme &amp;<a name='1855'>
                    ,its=its,ite=ite, jts=jts,jte=jte, kts=kts,kte=kte &amp;<a name='1856'>
<font color=#447700>!                    ,cosz_urb2d=cosz_urb2d ,omg_urb2d=omg_urb2d        &amp; !urban<a name='1857'></font>
                    ,qv3d=qv                                           &amp;<a name='1858'>
                    ,qc3d=qc                                           &amp;<a name='1859'>
                    ,qr3d=qr                                           &amp;<a name='1860'>
                    ,qi3d=qi                                           &amp;<a name='1861'>
                    ,qs3d=qs                                           &amp;<a name='1862'>
                    ,qg3d=qg                                           &amp;<a name='1863'>
                    ,f_qv=f_qv,f_qc=f_qc,f_qr=f_qr                     &amp;<a name='1864'>
                    ,f_qi=f_qi,f_qs=f_qs,f_qg=f_qg                     &amp;<a name='1865'>
                    ,erbe_out=erbe_out                                 &amp; <font color=#447700>!optional<a name='1866'></font>
                    ,swddir=swddir,swddni=swddni,swddif=swddif         &amp; <font color=#447700>! jararias, 14/08/2013<a name='1867'></font>
                    ,coszen=coszen,julian=julian                       &amp; <font color=#447700>! jararias, 14/08/2013<a name='1868'></font>
                    ,tauaer3d_sw=tauaer_sw                             &amp; <font color=#447700>! jararias, 2013/11<a name='1869'></font>
                    ,ssaaer3d_sw=ssaaer_sw                             &amp; <font color=#447700>! jararias, 2013/11<a name='1870'></font>
                    ,asyaer3d_sw=asyaer_sw                             &amp; <font color=#447700>! jararias, 2012/11<a name='1871'></font>
                    ,aer_opt=aer_opt                                   &amp;<a name='1872'>
                                                                       )<a name='1873'>
<a name='1874'>
        CASE (CAMSWSCHEME)<a name='1875'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_821">(100, 'CALL camrad sw')<a name='1876'>
             IF ( PRESENT( OZMIXM ) .AND. PRESENT( PIN ) .AND. &amp;<a name='1877'>
                  PRESENT(M_PS_1) .AND. PRESENT(M_PS_2) .AND.  &amp;<a name='1878'>
                  PRESENT(M_HYBI0) .AND. PRESENT(AEROSOLC_1)    &amp;<a name='1879'>
                  .AND. PRESENT(AEROSOLC_2) .AND. PRESENT(ALSWVISDIR)) THEN<a name='1880'>
             CALL <A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD'>CAMRAD</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAMRAD_2">(RTHRATENLW=RTHRATEN,RTHRATENSW=RTHRATENSW,    &amp;<a name='1881'>
                     dolw=.false.,dosw=.true.,                         &amp;<a name='1882'>
                     SWUPT=SWUPT,SWUPTC=SWUPTC,                        &amp;<a name='1883'>
                     SWDNT=SWDNT,SWDNTC=SWDNTC,                        &amp;<a name='1884'>
                     LWUPT=LWUPT,LWUPTC=LWUPTC,                        &amp;<a name='1885'>
                     LWDNT=LWDNT,LWDNTC=LWDNTC,                        &amp;<a name='1886'>
                     SWUPB=SWUPB,SWUPBC=SWUPBC,                        &amp;<a name='1887'>
                     SWDNB=SWDNB,SWDNBC=SWDNBC,                        &amp;<a name='1888'>
                     LWUPB=LWUPB,LWUPBC=LWUPBC,                        &amp;<a name='1889'>
                     LWDNB=LWDNB,LWDNBC=LWDNBC,                        &amp;<a name='1890'>
                     SWCF=SWCF,LWCF=LWCF,OLR=RLWTOA,CEMISS=CEMISS,     &amp;<a name='1891'>
                     TAUCLDC=TAUCLDC,TAUCLDI=TAUCLDI,COSZR=COSZR,      &amp;<a name='1892'>
                     GSW=GSW,GLW=GLW,XLAT=XLAT,XLONG=XLONG,            &amp;<a name='1893'>
                     ALBEDO=ALBEDO,t_phy=t,TSK=TSK,EMISS=EMISS         &amp;<a name='1894'>
                    ,QV3D=qv                                           &amp;<a name='1895'>
                    ,QC3D=qc                                           &amp;<a name='1896'>
                    ,QR3D=qr                                           &amp;<a name='1897'>
                    ,QI3D=qi                                           &amp;<a name='1898'>
                    ,QS3D=qs                                           &amp;<a name='1899'>
                    ,QG3D=qg                                           &amp;<a name='1900'>
                    ,ALSWVISDIR=alswvisdir ,ALSWVISDIF=alswvisdif      &amp;  <font color=#447700>!fds ssib alb comp (06/2010)<a name='1901'></font>
                    ,ALSWNIRDIR=alswnirdir ,ALSWNIRDIF=alswnirdif      &amp;  <font color=#447700>!fds ssib alb comp (06/2010)<a name='1902'></font>
                    ,SWVISDIR=swvisdir ,SWVISDIF=swvisdif              &amp;  <font color=#447700>!fds ssib swr comp (06/2010)<a name='1903'></font>
                    ,SWNIRDIR=swnirdir ,SWNIRDIF=swnirdif              &amp;  <font color=#447700>!fds ssib swr comp (06/2010)<a name='1904'></font>
                    ,SF_SURFACE_PHYSICS=sf_surface_physics             &amp;  <font color=#447700>!fds<a name='1905'></font>
                    ,SWDDIR=swddir,SWDDIF=swddif,SWDDNI=swddni         &amp;  <font color=#447700>!amontornes-bcodina (2014-04-20)<a name='1906'></font>
                    ,F_QV=f_qv,F_QC=f_qc,F_QR=f_qr                     &amp;<a name='1907'>
                    ,F_QI=f_qi,F_QS=f_qs,F_QG=f_qg                     &amp;<a name='1908'>
                    ,f_ice_phy=f_ice_phy,f_rain_phy=f_rain_phy         &amp;<a name='1909'>
                    ,p_phy=p,p8w=p8w,z=z,pi_phy=pi,rho_phy=rho,        &amp;<a name='1910'>
                     dz8w=dz8w,                                        &amp;<a name='1911'>
                     CLDFRA=CLDFRA,XLAND=XLAND,XICE=XICE,SNOW=SNOW,    &amp;<a name='1912'>
                     ozmixm=ozmixm,pin0=pin,levsiz=levsiz,             &amp;<a name='1913'>
                     num_months=n_ozmixm,                              &amp;<a name='1914'>
                     m_psp=m_ps_1,m_psn=m_ps_2,aerosolcp=aerosolc_1,   &amp;<a name='1915'>
                     aerosolcn=aerosolc_2,m_hybi0=m_hybi0,             &amp;<a name='1916'>
                     paerlev=paerlev, naer_c=n_aerosolc,               &amp;<a name='1917'>
                     cam_abs_dim1=cam_abs_dim1, cam_abs_dim2=cam_abs_dim2, &amp;<a name='1918'>
                     GMT=GMT,JULDAY=JULDAY,JULIAN=JULIAN,YR=YR,DT=DT,XTIME=XTIME,DECLIN=DECLIN,  &amp;<a name='1919'>
                     SOLCON=SOLCON,RADT=RADT,DEGRAD=DEGRAD,n_cldadv=3  &amp;<a name='1920'>
                   ,abstot_3d=abstot,absnxt_3d=absnxt,emstot_3d=emstot &amp;<a name='1921'>
                   ,doabsems=doabsems                               &amp;<a name='1922'>
                 ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde &amp;     <a name='1923'>
                 ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme &amp;<a name='1924'>
                 ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte &amp;<a name='1925'>
                 ,coszen=coszen                                     )<a name='1926'>
             ELSE<a name='1927'>
                CALL wrf_error_fatal ( 'arguments not present for calling cam radiation' )<a name='1928'>
             ENDIF<a name='1929'>
             DO j=jts,jte<a name='1930'>
             DO k=kts,kte<a name='1931'>
             DO i=its,ite<a name='1932'>
                RTHRATEN(I,K,J)=RTHRATEN(I,K,J)+RTHRATENSW(I,K,J)<a name='1933'>
             ENDDO<a name='1934'>
             ENDDO<a name='1935'>
             ENDDO<a name='1936'>
<a name='1937'>
        CASE (RRTMG_SWSCHEME)<a name='1938'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_822">(100, 'CALL rrtmg_sw')<a name='1939'>
             CALL <A href='../../html_code/phys/module_ra_rrtmg_sw.F.html#RRTMG_SWRAD'>RRTMG_SWRAD</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RRTMG_SWRAD_1">(                                         &amp;<a name='1940'>
                     RTHRATENSW=RTHRATENSW,                            &amp;<a name='1941'>
                     SWUPT=SWUPT,SWUPTC=SWUPTC,                        &amp;<a name='1942'>
                     SWDNT=SWDNT,SWDNTC=SWDNTC,                        &amp;<a name='1943'>
                     SWUPB=SWUPB,SWUPBC=SWUPBC,                        &amp;<a name='1944'>
                     SWDNB=SWDNB,SWDNBC=SWDNBC,                        &amp;<a name='1945'>
                     SWCF=SWCF,GSW=GSW,                                &amp;<a name='1946'>
                     XTIME=XTIME,GMT=GMT,XLAT=XLAT,XLONG=XLONG,        &amp;<a name='1947'>
                     RADT=RADT,DEGRAD=DEGRAD,DECLIN=DECLIN,            &amp;<a name='1948'>
                     COSZR=COSZR,JULDAY=JULDAY,SOLCON=SOLCON,          &amp;<a name='1949'>
                     ALBEDO=ALBEDO,t3d=t,t8w=t8w,TSK=TSK,              &amp;<a name='1950'>
                     p3d=p,p8w=p8w,pi3d=pi,rho3d=rho,                  &amp;<a name='1951'>
                     dz8w=dz8w,CLDFRA3D=CLDFRA,                        &amp;<a name='1952'>
#if (EM_CORE == 1)<a name='1953'>
                     LRADIUS=lradius, IRADIUS=iradius,                 &amp;<a name='1954'>
#endif<a name='1955'>
                     IS_CAMMGMP_USED=is_cammgmp_used,                  &amp;<a name='1956'>
                     R=R_D,G=G,              &amp;<a name='1957'>
<font color=#447700>!ckay<a name='1958'></font>
<font color=#447700>!                    CLDFRA_KF3D=cldfra_KF,QC_KF3D=qc_KF,QI_KF3D=qi_KF,&amp;<a name='1959'></font>
                     ICLOUD=icloud,WARM_RAIN=warm_rain,                &amp;<a name='1960'>
                     F_ICE_PHY=F_ICE_PHY,F_RAIN_PHY=F_RAIN_PHY,        &amp;<a name='1961'>
                     XLAND=XLAND,XICE=XICE,SNOW=SNOW,                  &amp;<a name='1962'>
                     QV3D=qv,QC3D=qc,QR3D=qr,                          &amp;<a name='1963'>
                     QI3D=qi,QS3D=qs,QG3D=qg,                          &amp;<a name='1964'>
                     O3INPUT=O3INPUT,O33D=O3RAD,                       &amp;<a name='1965'>
                     AER_OPT=AER_OPT,aerod=aerod,no_src=no_src_types,  &amp;<a name='1966'>
                     ALSWVISDIR=alswvisdir ,ALSWVISDIF=alswvisdif,     &amp;  <font color=#447700>!Zhenxin ssib alb comp (06/2010)<a name='1967'></font>
                     ALSWNIRDIR=alswnirdir ,ALSWNIRDIF=alswnirdif,     &amp;  <font color=#447700>!Zhenxin ssib alb comp (06/2010)<a name='1968'></font>
                     SWVISDIR=swvisdir ,SWVISDIF=swvisdif,             &amp;  <font color=#447700>!Zhenxin ssib swr comp (06/2010)<a name='1969'></font>
                     SWNIRDIR=swnirdir ,SWNIRDIF=swnirdif,             &amp;  <font color=#447700>!Zhenxin ssib swr comp (06/2010)<a name='1970'></font>
                     SF_SURFACE_PHYSICS=sf_surface_physics,            &amp;  <font color=#447700>!Zhenxin ssib sw_phy   (06/2010)<a name='1971'></font>
                     F_QV=f_qv,F_QC=f_qc,F_QR=f_qr,                    &amp;<a name='1972'>
                     F_QI=f_qi,F_QS=f_qs,F_QG=f_qg,                    &amp;<a name='1973'>
                     RE_CLOUD=re_cloud,RE_ICE=re_ice,RE_SNOW=re_snow,  &amp; <font color=#447700>! G. Thompson<a name='1974'></font>
                     has_reqc=has_reqc,has_reqi=has_reqi,has_reqs=has_reqs, &amp; <font color=#447700>! G. Thompson<a name='1975'></font>
#if ( WRF_CHEM == 1 )<a name='1976'>
                     TAUAER300=tauaer300,TAUAER400=tauaer400,          &amp; <font color=#447700>! jcb<a name='1977'></font>
                     TAUAER600=tauaer600,TAUAER999=tauaer999,          &amp; <font color=#447700>! jcb<a name='1978'></font>
                     GAER300=gaer300,GAER400=gaer400,                  &amp; <font color=#447700>! jcb<a name='1979'></font>
                     GAER600=gaer600,GAER999=gaer999,                  &amp; <font color=#447700>! jcb<a name='1980'></font>
                     WAER300=waer300,WAER400=waer400,                  &amp; <font color=#447700>! jcb<a name='1981'></font>
                     WAER600=waer600,WAER999=waer999,                  &amp; <font color=#447700>! jcb<a name='1982'></font>
                     aer_ra_feedback=aer_ra_feedback,                  &amp;<a name='1983'>
<font color=#447700>!jdfcz               progn=progn,prescribe=prescribe,                  &amp;<a name='1984'></font>
                     progn=progn,                                      &amp;<a name='1985'>
#endif<a name='1986'>
                     QNDROP3D=qndrop,F_QNDROP=f_qndrop,                &amp;<a name='1987'>
                     IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde,&amp;<a name='1988'>
                     IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme,&amp;<a name='1989'>
                     ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte,&amp;<a name='1990'>
                     SWUPFLX=SWUPFLX,SWUPFLXC=SWUPFLXC,                &amp;<a name='1991'>
                     SWDNFLX=SWDNFLX,SWDNFLXC=SWDNFLXC,                &amp;<a name='1992'>
                     tauaer3d_sw=tauaer_sw,                             &amp; <font color=#447700>! jararias 2013/11<a name='1993'></font>
                     ssaaer3d_sw=ssaaer_sw,                             &amp; <font color=#447700>! jararias 2013/11<a name='1994'></font>
                     asyaer3d_sw=asyaer_sw,                             &amp; <font color=#447700>! jararias 2013/11<a name='1995'></font>
                     swddir=swddir,swddni=swddni,swddif=swddif,         &amp; <font color=#447700>! jararias 2013/08/10<a name='1996'></font>
                     xcoszen=coszen,julian=julian,mp_physics=mp_physics ) <font color=#447700>! jararias 2013/08/14<a name='1997'></font>
<a name='1998'>
             DO j=jts,jte<a name='1999'>
             DO k=kts,kte<a name='2000'>
             DO i=its,ite<a name='2001'>
                RTHRATEN(I,K,J)=RTHRATEN(I,K,J)+RTHRATENSW(I,K,J)<a name='2002'>
             ENDDO<a name='2003'>
             ENDDO<a name='2004'>
             ENDDO<a name='2005'>
<a name='2006'>
        CASE (RRTMG_SWSCHEME_FAST)<a name='2007'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_823">(100, 'CALL rrtmg_sw_fast')<a name='2008'>
             CALL <A href='../../html_code/phys/module_ra_rrtmg_swf.F.html#RRTMG_SWRAD_FAST'>RRTMG_SWRAD_FAST</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RRTMG_SWRAD_FAST_1">(                                    &amp;<a name='2009'>
                     RTHRATENSW=RTHRATENSW,                            &amp;<a name='2010'>
                     SWUPT=SWUPT,SWUPTC=SWUPTC,                        &amp;<a name='2011'>
                     SWDNT=SWDNT,SWDNTC=SWDNTC,                        &amp;<a name='2012'>
                     SWUPB=SWUPB,SWUPBC=SWUPBC,                        &amp;<a name='2013'>
                     SWDNB=SWDNB,SWDNBC=SWDNBC,                        &amp;<a name='2014'>
                     SWCF=SWCF,GSW=GSW,                                &amp;<a name='2015'>
                     XTIME=XTIME,GMT=GMT,XLAT=XLAT,XLONG=XLONG,        &amp;<a name='2016'>
                     RADT=RADT,DEGRAD=DEGRAD,DECLIN=DECLIN,            &amp;<a name='2017'>
                     COSZR=COSZR,JULDAY=JULDAY,SOLCON=SOLCON,          &amp;<a name='2018'>
                     ALBEDO=ALBEDO,t3d=t,t8w=t8w,TSK=TSK,              &amp;<a name='2019'>
                     p3d=p,p8w=p8w,pi3d=pi,rho3d=rho,                  &amp;<a name='2020'>
                     dz8w=dz8w,CLDFRA3D=CLDFRA,                        &amp;<a name='2021'>
#if (EM_CORE == 1)<a name='2022'>
                     LRADIUS=lradius, IRADIUS=iradius,                 &amp;<a name='2023'>
#endif<a name='2024'>
                     IS_CAMMGMP_USED=is_cammgmp_used,                  &amp;<a name='2025'>
                     R=R_D,G=G,              &amp;<a name='2026'>
<font color=#447700>!ckay<a name='2027'></font>
<font color=#447700>!                    CLDFRA_KF3D=cldfra_KF,QC_KF3D=qc_KF,QI_KF3D=qi_KF,&amp;<a name='2028'></font>
                     ICLOUD=icloud,WARM_RAIN=warm_rain,                &amp;<a name='2029'>
                     F_ICE_PHY=F_ICE_PHY,F_RAIN_PHY=F_RAIN_PHY,        &amp;<a name='2030'>
                     XLAND=XLAND,XICE=XICE,SNOW=SNOW,                  &amp;<a name='2031'>
                     QV3D=qv,QC3D=qc,QR3D=qr,                          &amp;<a name='2032'>
                     QI3D=qi,QS3D=qs,QG3D=qg,                          &amp;<a name='2033'>
                     O3INPUT=O3INPUT,O33D=O3RAD,                       &amp;<a name='2034'>
                     AER_OPT=AER_OPT,aerod=aerod,no_src=no_src_types,  &amp;<a name='2035'>
                     ALSWVISDIR=alswvisdir ,ALSWVISDIF=alswvisdif,     &amp;  <font color=#447700>!Zhenxin ssib alb comp (06/2010)<a name='2036'></font>
                     ALSWNIRDIR=alswnirdir ,ALSWNIRDIF=alswnirdif,     &amp;  <font color=#447700>!Zhenxin ssib alb comp (06/2010)<a name='2037'></font>
                     SWVISDIR=swvisdir ,SWVISDIF=swvisdif,             &amp;  <font color=#447700>!Zhenxin ssib swr comp (06/2010)<a name='2038'></font>
                     SWNIRDIR=swnirdir ,SWNIRDIF=swnirdif,             &amp;  <font color=#447700>!Zhenxin ssib swr comp (06/2010)<a name='2039'></font>
                     SF_SURFACE_PHYSICS=sf_surface_physics,            &amp;  <font color=#447700>!Zhenxin ssib sw_phy   (06/2010)<a name='2040'></font>
                     F_QV=f_qv,F_QC=f_qc,F_QR=f_qr,                    &amp;<a name='2041'>
                     F_QI=f_qi,F_QS=f_qs,F_QG=f_qg,                    &amp;<a name='2042'>
                     RE_CLOUD=re_cloud,RE_ICE=re_ice,RE_SNOW=re_snow,  &amp; <font color=#447700>! G. Thompson<a name='2043'></font>
                     has_reqc=has_reqc,has_reqi=has_reqi,has_reqs=has_reqs, &amp; <font color=#447700>! G. Thompson<a name='2044'></font>
#if ( WRF_CHEM == 1 )<a name='2045'>
                     TAUAER300=tauaer300,TAUAER400=tauaer400,          &amp; <font color=#447700>! jcb<a name='2046'></font>
                     TAUAER600=tauaer600,TAUAER999=tauaer999,          &amp; <font color=#447700>! jcb<a name='2047'></font>
                     GAER300=gaer300,GAER400=gaer400,                  &amp; <font color=#447700>! jcb<a name='2048'></font>
                     GAER600=gaer600,GAER999=gaer999,                  &amp; <font color=#447700>! jcb<a name='2049'></font>
                     WAER300=waer300,WAER400=waer400,                  &amp; <font color=#447700>! jcb<a name='2050'></font>
                     WAER600=waer600,WAER999=waer999,                  &amp; <font color=#447700>! jcb<a name='2051'></font>
                     aer_ra_feedback=aer_ra_feedback,                  &amp;<a name='2052'>
<font color=#447700>!jdfcz               progn=progn,prescribe=prescribe,                  &amp;<a name='2053'></font>
                     progn=progn,                                      &amp;<a name='2054'>
#endif<a name='2055'>
                     QNDROP3D=qndrop,F_QNDROP=f_qndrop,                &amp;<a name='2056'>
                     IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde,&amp;<a name='2057'>
                     IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme,&amp;<a name='2058'>
                     ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte,&amp;<a name='2059'>
                     SWUPFLX=SWUPFLX,SWUPFLXC=SWUPFLXC,                &amp;<a name='2060'>
                     SWDNFLX=SWDNFLX,SWDNFLXC=SWDNFLXC,                &amp;<a name='2061'>
                     tauaer3d_sw=tauaer_sw,                             &amp; <font color=#447700>! jararias 2013/11<a name='2062'></font>
                     ssaaer3d_sw=ssaaer_sw,                             &amp; <font color=#447700>! jararias 2013/11<a name='2063'></font>
                     asyaer3d_sw=asyaer_sw,                             &amp; <font color=#447700>! jararias 2013/11<a name='2064'></font>
                     swddir=swddir,swddni=swddni,swddif=swddif,         &amp; <font color=#447700>! jararias 2013/08/10<a name='2065'></font>
                     xcoszen=coszen,julian=julian                       ) <font color=#447700>! jararias 2013/08/14<a name='2066'></font>
<a name='2067'>
             DO j=jts,jte<a name='2068'>
             DO k=kts,kte<a name='2069'>
             DO i=its,ite<a name='2070'>
                RTHRATEN(I,K,J)=RTHRATEN(I,K,J)+RTHRATENSW(I,K,J)<a name='2071'>
             ENDDO<a name='2072'>
             ENDDO<a name='2073'>
             ENDDO<a name='2074'>
<a name='2075'>
        CASE (GFDLSWSCHEME)<a name='2076'>
<a name='2077'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_824"> (100, 'CALL gfdlsw')<a name='2078'>
<a name='2079'>
             IF ( PRESENT(F_QV) .AND. PRESENT(F_QC) .AND.                     &amp;<a name='2080'>
                  PRESENT(F_QI) .AND. (PRESENT(qi) .OR. PRESENT(qs))  .AND.                     &amp;<a name='2081'>
                  PRESENT(qv)   .AND. PRESENT(qc)   ) THEN<a name='2082'>
               IF ( F_QV .AND. F_QC .AND. (F_QI .OR. F_QS)) THEN<a name='2083'>
                 gfdl_sw = .true.<a name='2084'>
                 CALL <A href='../../html_code/phys/module_ra_gfdleta.F.html#ETARA'>ETARA</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ETARA_4">(                                        &amp;<a name='2085'>
                  DT=dt,XLAND=xland                                 &amp;<a name='2086'>
                 ,P8W=p8w,DZ8W=dz8w,RHO_PHY=rho,P_PHY=p,T=t         &amp;<a name='2087'>
                 ,QV=qv,QW=qc_temp,QI=qi,QS=qs                      &amp;<a name='2088'>
                 ,TSK2D=tsk,GLW=GLW,RSWIN=SWDOWN,GSW=GSW            &amp;<a name='2089'>
                 ,RSWINC=SWDOWNC,CLDFRA=CLDFRA,PI3D=pi              &amp;<a name='2090'>
                 ,GLAT=glat,GLON=glon,HTOP=htop,HBOT=hbot           &amp;<a name='2091'>
                 ,HBOTR=hbotr, HTOPR=htopr                          &amp;<a name='2092'>
                 ,ALBEDO=albedo,CUPPT=cuppt                         &amp;<a name='2093'>
                 ,VEGFRA=vegfra,SNOW=snow,G=g,GMT=gmt               &amp;<a name='2094'>
                 ,NSTEPRA=stepra,NPHS=nphs,ITIMESTEP=itimestep      &amp;<a name='2095'>
                 ,XTIME=xtime,JULIAN=julian                         &amp;<a name='2096'>
                 ,JULYR=julyr,JULDAY=julday                         &amp;<a name='2097'>
                 ,GFDL_LW=gfdl_lw,GFDL_SW=gfdl_sw                   &amp;<a name='2098'>
                 ,CFRACL=cfracl,CFRACM=cfracm,CFRACH=cfrach         &amp;<a name='2099'>
                 ,ACFRST=acfrst,NCFRST=ncfrst                       &amp;<a name='2100'>
                 ,ACFRCV=acfrcv,NCFRCV=ncfrcv                       &amp;<a name='2101'>
                 ,RSWTOA=rswtoa,RLWTOA=rlwtoa,CZMEAN=czmean         &amp;<a name='2102'>
                 ,THRATEN=rthraten,THRATENLW=rthratenlw             &amp;<a name='2103'>
                 ,THRATENSW=rthratensw                              &amp;<a name='2104'>
                 ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde &amp;     <a name='2105'>
                 ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme &amp;<a name='2106'>
                 ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte &amp;<a name='2107'>
                                                                    )<a name='2108'>
               ELSE<a name='2109'>
                 CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1126">('Can not call <A href='../../html_code/phys/module_ra_gfdleta.F.html#ETARA'>ETARA</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ETARA_5"> (2a). Missing moisture fields.')<a name='2110'>
               ENDIF<a name='2111'>
             ELSE<a name='2112'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1127">('Can not call <A href='../../html_code/phys/module_ra_gfdleta.F.html#ETARA'>ETARA</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ETARA_6"> (2b). Missing moisture fields.')<a name='2113'>
             ENDIF<a name='2114'>
<a name='2115'>
#if ( HWRF == 1 )<a name='2116'>
      CASE (HWRFSWSCHEME)<a name='2117'>
<a name='2118'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_825"> (100, 'CALL hwrfsw')<a name='2119'>
<a name='2120'>
             gfdl_sw = .true.<a name='2121'>
               CALL <A href='../../html_code/phys/module_ra_HWRF.F.html#HWRFRA'>HWRFRA</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HWRFRA_2">(explicit_convection=expl_conv, &amp;<a name='2122'>
                        DT=dt,thraten=RTHRATEN,thratenlw=RTHRATENLW,thratensw=RTHRATENSW,pi3d=pi, &amp;<a name='2123'>
                        XLAND=xland,P8w=p8w,DZ8w=dz8w,RHO_PHY=rho,P_PHY=p,T=t,          &amp;<a name='2124'>
                        QV=qv,QW=qc_temp,QI=Qi,                      &amp;<a name='2125'>
                        TSK2D=tsk,GLW=GLW,GSW=GSW,                                 &amp;<a name='2126'>
                        TOTSWDN=swdown,TOTLWDN=glw,RSWTOA=rswtoa,RLWTOA=rlwtoa,CZMEAN=czmean,        &amp; <font color=#447700>!Added<a name='2127'></font>
                        GLAT=glat,GLON=glon,HTOP=htop,HBOT=hbot,htopr=htopr,hbotr=hbotr,ALBEDO=albedo,CUPPT=cuppt,            &amp;<a name='2128'>
                        VEGFRA=vegfra,SNOW=snow,G=g,GMT=gmt,                           &amp; <font color=#447700>!Modified<a name='2129'></font>
                        NSTEPRA=stepra,NPHS=nphs,itimestep=itimestep,                       &amp; <font color=#447700>!Modified<a name='2130'></font>
                        julyr=julyr,julday=julday,gfdl_lw=gfdl_lw,gfdl_sw=gfdl_sw,                &amp;<a name='2131'>
                        CFRACL=cfracl,CFRACM=cfracm,CFRACH=cfrach,                        &amp; <font color=#447700>!Added<a name='2132'></font>
                        ACFRST=acfrst,NCFRST=ncfrst,ACFRCV=acfrcv,NCFRCV=ncfrcv,                 &amp; <font color=#447700>!Added<a name='2133'></font>
                        ids=ids,ide=ide, jds=jds,jde=jde, kds=kds,kde=kde,                   &amp;<a name='2134'>
                        ims=ims,ime=ime, jms=jms,jme=jme, kms=kms,kme=kme,                   &amp;<a name='2135'>
                        its=its,ite=ite, jts=jts,jte=jte, kts=kts,kte=kte                    )<a name='2136'>
#endif<a name='2137'>
<a name='2138'>
        CASE (0)<a name='2139'>
<a name='2140'>
           <font color=#447700>! Here in case we don't want to call a sw radiation scheme<a name='2141'></font>
           <font color=#447700>! For example, the Held-Suarez idealized test case<a name='2142'></font>
           IF (lw_physics /= HELDSUAREZ) THEN<a name='2143'>
             WRITE( wrf_err_message , * ) &amp;<a name='2144'>
'You have selected a longwave radiation option, but not a shortwave option (sw_physics = 0, lw_physics = ',lw_physics,')'<a name='2145'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1128"> ( wrf_err_message )<a name='2146'>
           END IF<a name='2147'>
<a name='2148'>
<font color=#447700>! -- add by Jin Kong 10/2011<a name='2149'></font>
<font color=#447700>!--- the following FLGSWSCHEME is for testing only<a name='2150'></font>
        CASE (FLGSWSCHEME)<a name='2151'>
          flg_sw = .true.<a name='2152'>
<font color=#447700>!--- No need to do anything since the short and long wave is calculted in one program<a name='2153'></font>
<font color=#447700>! -- end <a name='2154'></font>
<a name='2155'>
        CASE DEFAULT<a name='2156'>
<a name='2157'>
             WRITE( wrf_err_message , * ) 'The shortwave option does not exist: sw_physics = ', sw_physics<a name='2158'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1129"> ( wrf_err_message )<a name='2159'>
<a name='2160'>
     END SELECT swrad_select    <a name='2161'>
<a name='2162'>
     IF (sw_physics .eq. goddardswscheme) THEN<a name='2163'>
          IF ( PRESENT (tswdn) ) THEN<a name='2164'>
        DO j=jts,jte<a name='2165'>
        DO i=its,ite<a name='2166'>
           tswdn(i,j) = erbe_out(i,j,5)    <font color=#447700>! TOA SW downwelling flux [W/m2]<a name='2167'></font>
           tswup(i,j) = erbe_out(i,j,6)    <font color=#447700>! TOA SW upwelling flux [W/m2]<a name='2168'></font>
           sswdn(i,j) = erbe_out(i,j,7)    <font color=#447700>! surface SW downwelling flux [W/m2]<a name='2169'></font>
           sswup(i,j) = erbe_out(i,j,8)    <font color=#447700>! surface SW upwelling flux [W/m2]<a name='2170'></font>
        ENDDO<a name='2171'>
        ENDDO<a name='2172'>
          ENDIF<a name='2173'>
     ENDIF<a name='2174'>
<a name='2175'>
     IF (sw_physics .gt. 0 .and. .not.gfdl_sw .and. .not.flg_sw) THEN<a name='2176'>
        DO j=jts,jte<a name='2177'>
        DO k=kts,kte<a name='2178'>
        DO i=its,ite<a name='2179'>
           RTHRATENSW(I,K,J)=RTHRATEN(I,K,J)-RTHRATENLW(I,K,J)<a name='2180'>
        ENDDO<a name='2181'>
        ENDDO<a name='2182'>
        ENDDO<a name='2183'>
<a name='2184'>
        DO j=jts,jte<a name='2185'>
        DO i=its,ite<a name='2186'>
           SWDOWN(I,J)=GSW(I,J)/(1.-ALBEDO(I,J))<a name='2187'>
        ENDDO<a name='2188'>
        ENDDO<a name='2189'>
     ENDIF<a name='2190'>
<a name='2191'>
<font color=#447700>! jararias, 14/08/2013<a name='2192'></font>
     <font color=#447700>! surface direct and diffuse SW fluxes computation. Only for schemes other than RRTMG and Goddard<a name='2193'></font>
     <font color=#447700>! Backup method in case sw scheme in use does not provide surface SW direct and diffuse irradiances<a name='2194'></font>
     IF ((sw_physics .NE. RRTMG_SWSCHEME) .AND. (sw_physics .NE. RRTMG_SWSCHEME_FAST) &amp;<a name='2195'>
           .AND. (sw_physics .NE. FLGSWSCHEME) .AND. (sw_physics .NE. CAMSWSCHEME) &amp;  <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='2196'></font>
           .AND. (sw_physics .ne. GODDARDSWSCHEME)) THEN<a name='2197'>
        DO j=jts,jte<a name='2198'>
           DO i=its,ite<a name='2199'>
              IF (coszen(i,j).GT.1e-3) THEN<a name='2200'>
                 ioh=solcon*coszen(i,j) <font color=#447700>! TOA irradiance<a name='2201'></font>
                 kt=swdown(i,j)/max(ioh,1e-3) <font color=#447700>! clearness index<a name='2202'></font>
                 <font color=#447700>! Optical air mass: Rigollier et al. (2000) doi:<a name='2203'></font>
                 <font color=#447700>! 10.1016/S0038-092X(99)00055-9<a name='2204'></font>
                 airmass=exp(-ht(i,j)/8434.5)/(coszen(i,j)+ &amp;<a name='2205'>
                        0.50572*(asin(coszen(i,j))*57.295779513082323+6.07995)**(-1.6364))<a name='2206'>
                 <font color=#447700>! kt correction for air-mass at large sza: Perez et al. (1990)<a name='2207'></font>
                 <font color=#447700>! doi: 10.1016/0038-092X(90)90036-C<a name='2208'></font>
                 kt=kt/(0.1+1.031*exp(-1.4/(0.9+(9.4/max(airmass,1e-3)))))<a name='2209'>
                 <font color=#447700>! Diffuse fraction: Ruiz-Arias et al. (2010) (Eq 33) doi:<a name='2210'></font>
                 <font color=#447700>! 10.1016/j.enconman.2009.11.024<a name='2211'></font>
                 kd=0.952-1.041*exp(-exp(2.300-4.702*kt))<a name='2212'>
                 swddif(i,j)=kd*swdown(i,j)<a name='2213'>
                 swddir(i,j)=(1.-kd)*swdown(i,j)<a name='2214'>
                 swddni(i,j)=swddir(i,j)/max(coszen(i,j),1e-4)<a name='2215'>
              ENDIF<a name='2216'>
           ENDDO<a name='2217'>
        ENDDO<a name='2218'>
     ENDIF<a name='2219'>
<a name='2220'>
     IF ( PRESENT( diffuse_frac ) ) THEN <a name='2221'>
         DO j=jts,jte<a name='2222'>
         DO i=its,ite<a name='2223'>
           if (swdown(i,j).gt.0.001) then<a name='2224'>
              diffuse_frac(i,j) = swddif(i,j)/swdown(i,j)<a name='2225'>
              diffuse_frac(i,j) = min(diffuse_frac(i,j),1.0)<a name='2226'>
           else<a name='2227'>
              diffuse_frac(i,j) = 0.<a name='2228'>
           endif<a name='2229'>
         ENDDO<a name='2230'>
         ENDDO<a name='2231'>
     ENDIF<a name='2232'>
<a name='2233'>
 <font color=#447700>! Restore qc &amp; qi for any model physics configuration<a name='2234'></font>
      IF ( F_QC ) THEN<a name='2235'>
         DO j=jts,jte<a name='2236'>
         DO k=kts,kte<a name='2237'>
         DO i=its,ite<a name='2238'>
           qc(i,k,j) = qc_save(i,k,j)<a name='2239'>
         ENDDO<a name='2240'>
         ENDDO<a name='2241'>
         ENDDO<a name='2242'>
      ENDIF<a name='2243'>
      IF ( F_QI ) THEN<a name='2244'>
         DO j=jts,jte<a name='2245'>
         DO k=kts,kte<a name='2246'>
         DO i=its,ite<a name='2247'>
           qi(i,k,j) = qi_save(i,k,j)<a name='2248'>
         ENDDO<a name='2249'>
         ENDDO<a name='2250'>
         ENDDO<a name='2251'>
      ENDIF<a name='2252'>
<a name='2253'>
      IF (ICLOUD == 3 .AND. F_QS ) THEN<a name='2254'>
          DO j = jts,jte<a name='2255'>
          DO k = kts,kte<a name='2256'>
          DO i = its,ite<a name='2257'>
             qs(i,k,j) = qs_save(i,k,j)<a name='2258'>
          ENDDO<a name='2259'>
          ENDDO<a name='2260'>
          ENDDO<a name='2261'>
      ENDIF<a name='2262'>
<a name='2263'>
      <font color=#447700>! jararias, aug 2013, updated 2013/11<a name='2264'></font>
      <font color=#447700>! parameters update for SW surface fluxes interpolation<a name='2265'></font>
      IF (swint_opt.EQ.1) THEN<a name='2266'>
         <font color=#447700>! interpolation applies on all-sky fluxes (swddir, swdown)<a name='2267'></font>
         CALL <A href='../../html_code/phys/module_radiation_driver.F.html#UPDATE_SWINTERP_PARAMETERS'>update_swinterp_parameters</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPDATE_SWINTERP_PARAMETERS_1">(ims,ime,jms,jme,its,ite,jts,jte,   &amp;<a name='2268'>
                                         coszen,coszen_loc,swddir,swdown,   &amp;<a name='2269'>
                                         swddir_ref,bb,Bx,swdown_ref,gg,Gx, &amp;<a name='2270'>
                                         coszen_ref                         )<a name='2271'>
      ENDIF<a name='2272'>
<a name='2273'>
   ENDDO<a name='2274'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2275'></font>
<a name='2276'>
   IF ( associated(tauaer_sw) ) deallocate(tauaer_sw)<a name='2277'>
   IF ( associated(ssaaer_sw) ) deallocate(ssaaer_sw)<a name='2278'>
   IF ( associated(asyaer_sw) ) deallocate(asyaer_sw)<a name='2279'>
<a name='2280'>
   ENDIF Radiation_step<a name='2281'>
<a name='2282'>
 <font color=#447700>! jararias, aug 2013<a name='2283'></font>
 <font color=#447700>! SW surface fluxes interpolation (meaningful when not in a Radiation_step)<a name='2284'></font>
 if (swint_opt .eq. 1) then<a name='2285'>
    call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_826">(100,'SW surface irradiance interpolation')<a name='2286'>
<a name='2287'>
    <font color=#447700>!---------------<a name='2288'></font>
    <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2289'></font>
    <font color=#447700>!$OMP PRIVATE ( ij ,i,j,k,its,ite,jts,jte)<a name='2290'></font>
    do ij = 1,num_tiles<a name='2291'>
      its = i_start(ij)<a name='2292'>
      ite = i_end(ij)<a name='2293'>
      jts = j_start(ij)<a name='2294'>
      jte = j_end(ij)<a name='2295'>
      call <A href='../../html_code/phys/module_radiation_driver.F.html#INTERP_SW_RADIATION'>interp_sw_radiation</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_SW_RADIATION_1">(ims,ime,jms,jme,its,ite,jts,jte,  &amp;<a name='2296'>
                               coszen_ref,coszen_loc,swddir_ref, &amp;<a name='2297'>
                               bb,Bx,swdown_ref,gg,Gx,albedo,    &amp;<a name='2298'>
                               swdown,swddir,swddni,swddif,gsw   )<a name='2299'>
    enddo<a name='2300'>
    <font color=#447700>!$OMP END PARALLEL DO<a name='2301'></font>
 end if<a name='2302'>
<a name='2303'>
     accumulate_lw_select: SELECT CASE(lw_physics)<a name='2304'>
<a name='2305'>
     CASE (CAMLWSCHEME,RRTMG_LWSCHEME,RRTMG_LWSCHEME_FAST)<a name='2306'>
   IF(PRESENT(LWUPTC))THEN<a name='2307'>
<font color=#447700>!  NMM calls the driver every RADT time steps, EM calls every DT<a name='2308'></font>
#if (EM_CORE == 1)<a name='2309'>
   DTaccum = DT<a name='2310'>
#else<a name='2311'>
   DTaccum = RADT*60<a name='2312'>
#endif<a name='2313'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2314'></font>
   <font color=#447700>!$OMP PRIVATE ( ij ,i,j,k,its,ite,jts,jte)<a name='2315'></font>
<a name='2316'>
   DO ij = 1 , num_tiles<a name='2317'>
     its = i_start(ij)<a name='2318'>
     ite = i_end(ij)<a name='2319'>
     jts = j_start(ij)<a name='2320'>
     jte = j_end(ij)<a name='2321'>
<a name='2322'>
        DO j=jts,jte<a name='2323'>
        DO i=its,ite<a name='2324'>
           ACLWUPT(I,J) = ACLWUPT(I,J) + LWUPT(I,J)*DTaccum<a name='2325'>
           ACLWUPTC(I,J) = ACLWUPTC(I,J) + LWUPTC(I,J)*DTaccum<a name='2326'>
           ACLWDNT(I,J) = ACLWDNT(I,J) + LWDNT(I,J)*DTaccum<a name='2327'>
           ACLWDNTC(I,J) = ACLWDNTC(I,J) + LWDNTC(I,J)*DTaccum<a name='2328'>
           ACLWUPB(I,J) = ACLWUPB(I,J) + LWUPB(I,J)*DTaccum<a name='2329'>
           ACLWUPBC(I,J) = ACLWUPBC(I,J) + LWUPBC(I,J)*DTaccum<a name='2330'>
           ACLWDNB(I,J) = ACLWDNB(I,J) + LWDNB(I,J)*DTaccum<a name='2331'>
           ACLWDNBC(I,J) = ACLWDNBC(I,J) + LWDNBC(I,J)*DTaccum<a name='2332'>
        ENDDO<a name='2333'>
        ENDDO<a name='2334'>
   ENDDO<a name='2335'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2336'></font>
   ENDIF<a name='2337'>
     CASE DEFAULT<a name='2338'>
     END SELECT accumulate_lw_select<a name='2339'>
<a name='2340'>
     accumulate_sw_select: SELECT CASE(sw_physics)<a name='2341'>
<a name='2342'>
     CASE (CAMSWSCHEME,RRTMG_SWSCHEME,RRTMG_SWSCHEME_FAST)<a name='2343'>
   IF(PRESENT(SWUPTC))THEN<a name='2344'>
<font color=#447700>!  NMM calls the driver every RADT time steps, EM calls every DT<a name='2345'></font>
#if (EM_CORE == 1)<a name='2346'>
   DTaccum = DT<a name='2347'>
#else<a name='2348'>
   DTaccum = RADT*60<a name='2349'>
#endif<a name='2350'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2351'></font>
   <font color=#447700>!$OMP PRIVATE ( ij ,i,j,k,its,ite,jts,jte)<a name='2352'></font>
<a name='2353'>
   DO ij = 1 , num_tiles<a name='2354'>
     its = i_start(ij)<a name='2355'>
     ite = i_end(ij)<a name='2356'>
     jts = j_start(ij)<a name='2357'>
     jte = j_end(ij)<a name='2358'>
<a name='2359'>
        DO j=jts,jte<a name='2360'>
        DO i=its,ite<a name='2361'>
           ACSWUPT(I,J) = ACSWUPT(I,J) + SWUPT(I,J)*DTaccum<a name='2362'>
           ACSWUPTC(I,J) = ACSWUPTC(I,J) + SWUPTC(I,J)*DTaccum<a name='2363'>
           ACSWDNT(I,J) = ACSWDNT(I,J) + SWDNT(I,J)*DTaccum<a name='2364'>
           ACSWDNTC(I,J) = ACSWDNTC(I,J) + SWDNTC(I,J)*DTaccum<a name='2365'>
           ACSWUPB(I,J) = ACSWUPB(I,J) + SWUPB(I,J)*DTaccum<a name='2366'>
           ACSWUPBC(I,J) = ACSWUPBC(I,J) + SWUPBC(I,J)*DTaccum<a name='2367'>
           ACSWDNB(I,J) = ACSWDNB(I,J) + SWDNB(I,J)*DTaccum<a name='2368'>
           ACSWDNBC(I,J) = ACSWDNBC(I,J) + SWDNBC(I,J)*DTaccum<a name='2369'>
        ENDDO<a name='2370'>
        ENDDO<a name='2371'>
   ENDDO<a name='2372'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2373'></font>
   ENDIF<a name='2374'>
<a name='2375'>
     CASE DEFAULT<a name='2376'>
     END SELECT accumulate_sw_select<a name='2377'>
<a name='2378'>
<font color=#447700>! compute cloud diagnosis (random overlapping)<a name='2379'></font>
<font color=#447700>! by ZCX<a name='2380'></font>
 IF ( PRESENT ( CLDFRA ) .AND. PRESENT ( CLDT ) .AND.        &amp;<a name='2381'>
      PRESENT ( F_QC ) .AND. PRESENT ( F_QI ) ) THEN<a name='2382'>
<a name='2383'>
   DO ij = 1 , num_tiles<a name='2384'>
     its = i_start(ij)<a name='2385'>
     ite = i_end(ij)<a name='2386'>
     jts = j_start(ij)<a name='2387'>
     jte = j_end(ij)<a name='2388'>
<a name='2389'>
        DO j=jts,jte<a name='2390'>
        DO i=its,ite<a name='2391'>
          cldji=1.0<a name='2392'>
          do k=kte-1,kts,-1<a name='2393'>
            cldji=cldji*(1.0-cldfra(i,k,j))<a name='2394'>
          enddo<a name='2395'>
          cldt(i,j)=1.0-cldji<a name='2396'>
<font color=#447700>!         cldlji=1.0<a name='2397'></font>
<font color=#447700>!         do k=kte-1,kts,-1<a name='2398'></font>
<font color=#447700>!         if(znu(k).ge.0.69) then<a name='2399'></font>
<font color=#447700>!           cldlji=cldlji*(1.0-cldfra(i,k,j))<a name='2400'></font>
<font color=#447700>!         endif<a name='2401'></font>
<font color=#447700>!         enddo<a name='2402'></font>
<font color=#447700>!         cldl(i,j)=1.0-cldlji<a name='2403'></font>
        END DO<a name='2404'>
        END DO<a name='2405'>
    END DO<a name='2406'>
 END IF<a name='2407'>
<a name='2408'>
   END SUBROUTINE radiation_driver<a name='2409'>
<a name='2410'>
<A NAME='PRE_RADIATION_DRIVER'><A href='../../html_code/phys/module_radiation_driver.F.html#PRE_RADIATION_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2411'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>pre_radiation_driver</font> ( grid, config_flags                   &amp; <A href='../../call_to/PRE_RADIATION_DRIVER.html' TARGET='index'>1</A>,<A href='../../call_from/PRE_RADIATION_DRIVER.html' TARGET='index'>11</A><a name='2412'>
              ,itimestep, ra_call_offset                                  &amp;<a name='2413'>
              ,XLAT, XLONG, GMT, julian, xtime, RADT, STEPRA              &amp;<a name='2414'>
              ,ht,dx,dy,sina,cosa,shadowmask,slope_rad ,topo_shading      &amp;<a name='2415'>
              ,shadlen,ht_shad,ht_loc                                     &amp;<a name='2416'>
              ,ht_shad_bxs, ht_shad_bxe                                   &amp;<a name='2417'>
              ,ht_shad_bys, ht_shad_bye                                   &amp;<a name='2418'>
              ,nested, min_ptchsz                                         &amp;<a name='2419'>
              ,spec_bdy_width                                             &amp;<a name='2420'>
              ,ids, ide, jds, jde, kds, kde                               &amp;<a name='2421'>
              ,ims, ime, jms, jme, kms, kme                               &amp;<a name='2422'>
              ,ips, ipe, jps, jpe, kps, kpe                               &amp;<a name='2423'>
              ,i_start, i_end                                             &amp;<a name='2424'>
              ,j_start, j_end                                             &amp;<a name='2425'>
              ,kts, kte                                                   &amp;<a name='2426'>
              ,num_tiles                                                  )<a name='2427'>
<a name='2428'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/phys/module_radiation_driver.F.html#PRE_RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_247">  , ONLY : domain<a name='2429'>
#ifdef DM_PARALLEL<a name='2430'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/phys/module_radiation_driver.F.html#PRE_RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_162">        , ONLY : ntasks_x,ntasks_y,local_communicator,mytask,ntasks,wrf_dm_minval_integer<a name='2431'>
# if (EM_CORE == 1)<a name='2432'>
   USE <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>module_comm_dm</A><A href='../../html_code/phys/module_radiation_driver.F.html#PRE_RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_32">   , ONLY : halo_toposhad_sub<a name='2433'>
# endif<a name='2434'>
#endif<a name='2435'>
   USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/phys/module_radiation_driver.F.html#PRE_RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_18"><a name='2436'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_radiation_driver.F.html#PRE_RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_88"><a name='2437'>
<a name='2438'>
   IMPLICIT NONE<a name='2439'>
<a name='2440'>
   INTEGER,      INTENT(IN   )    ::   ids,ide, jds,jde, kds,kde, &amp;<a name='2441'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='2442'>
                                       ips,ipe, jps,jpe, kps,kpe, &amp;<a name='2443'>
                                                         kts,kte, &amp;<a name='2444'>
                                       num_tiles<a name='2445'>
<a name='2446'>
   TYPE(domain)                   , INTENT(INOUT)  :: grid<a name='2447'>
   TYPE(grid_config_rec_type   ) ,   INTENT(IN   ) :: config_flags<a name='2448'>
<a name='2449'>
   INTEGER, INTENT(IN  ) :: itimestep, ra_call_offset, stepra,    &amp;<a name='2450'>
                            slope_rad, topo_shading,              &amp;<a name='2451'>
                            spec_bdy_width<a name='2452'>
<a name='2453'>
   INTEGER, INTENT(INOUT) :: min_ptchsz<a name='2454'>
<a name='2455'>
   INTEGER, DIMENSION(num_tiles), INTENT(IN) ::                   &amp;<a name='2456'>
                i_start,i_end,j_start,j_end<a name='2457'>
<a name='2458'>
   REAL, INTENT(IN  )   :: GMT, radt, julian, xtime, dx, dy, shadlen<a name='2459'>
<a name='2460'>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='2461'>
         INTENT(IN   )  ::                                  XLAT, &amp;<a name='2462'>
                                                           XLONG, &amp;<a name='2463'>
                                                              HT, &amp;<a name='2464'>
                                                            SINA, &amp;<a name='2465'>
                                                            COSA<a name='2466'>
<a name='2467'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)  ::  ht_shad,ht_loc<a name='2468'>
<a name='2469'>
   REAL,  DIMENSION( jms:jme , kds:kde , spec_bdy_width ),        &amp;<a name='2470'>
                      INTENT(IN   ) :: ht_shad_bxs, ht_shad_bxe<a name='2471'>
   REAL,  DIMENSION( ims:ime , kds:kde , spec_bdy_width ),        &amp;<a name='2472'>
                      INTENT(IN   ) :: ht_shad_bys, ht_shad_bye<a name='2473'>
<a name='2474'>
   INTEGER, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='2475'>
         INTENT(INOUT)  ::                            shadowmask<a name='2476'>
<a name='2477'>
   LOGICAL,      INTENT(IN   )    :: nested<a name='2478'>
<a name='2479'>
<font color=#447700>!Local<a name='2480'></font>
<font color=#447700>! For orographic shading<a name='2481'></font>
   INTEGER :: niter,ni,psx,psy,idum,jdum,i,j,ij<a name='2482'>
   REAL :: DECLIN,SOLCON<a name='2483'>
<a name='2484'>
<font color=#447700>! Determine minimum patch size for slope-dependent radiation<a name='2485'></font>
   if (itimestep .eq. 1) then<a name='2486'>
     psx = ipe-ips+1<a name='2487'>
     psy = jpe-jps+1<a name='2488'>
     min_ptchsz = min(psx,psy)<a name='2489'>
     idum = 0<a name='2490'>
     jdum = 0<a name='2491'>
   endif<a name='2492'>
<a name='2493'>
# ifdef DM_PARALLEL<a name='2494'>
   if (itimestep .eq. 1) then<a name='2495'>
     call <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL_INTEGER'>wrf_dm_minval_integer</A><A href='../../html_code/phys/module_radiation_driver.F.html#PRE_RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MINVAL_INTEGER_3"> (psx,idum,jdum)<a name='2496'>
     call <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL_INTEGER'>wrf_dm_minval_integer</A><A href='../../html_code/phys/module_radiation_driver.F.html#PRE_RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MINVAL_INTEGER_4"> (psy,idum,jdum)<a name='2497'>
     min_ptchsz = min(psx,psy)<a name='2498'>
   endif<a name='2499'>
# endif<a name='2500'>
<a name='2501'>
<font color=#447700>! Topographic shading<a name='2502'></font>
   <a name='2503'>
   if ((topo_shading.eq.1).and.(itimestep .eq. 1 .or. &amp;<a name='2504'>
        mod(itimestep,STEPRA) .eq. 1 + ra_call_offset))  then<a name='2505'>
<a name='2506'>
<font color=#447700>!---------------<a name='2507'></font>
<font color=#447700>! Calculate constants for short wave radiation<a name='2508'></font>
   <a name='2509'>
   CALL <A href='../../html_code/phys/module_radiation_driver.F.html#RADCONST'>radconst</A><A href='../../html_code/phys/module_radiation_driver.F.html#PRE_RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADCONST_3">(XTIME,DECLIN,SOLCON,JULIAN,DEGRAD,DPD)<a name='2510'>
   <a name='2511'>
<font color=#447700>! Make a local copy of terrain height field<a name='2512'></font>
     do j=jms,jme<a name='2513'>
     do i=ims,ime<a name='2514'>
       ht_loc(i,j) = ht(i,j)<a name='2515'>
     enddo<a name='2516'>
     enddo<a name='2517'>
<font color=#447700>! Determine if iterations are necessary for shadows to propagate from one patch to another<a name='2518'></font>
     if ((ids.eq.ips).and.(ide.eq.ipe).and.(jds.eq.jps).and.(jde.eq.jpe)) then<a name='2519'>
       niter = 1<a name='2520'>
     else<a name='2521'>
       niter = int(shadlen/(dx*min_ptchsz)+3)<a name='2522'>
     endif<a name='2523'>
<a name='2524'>
<a name='2525'>
    IF( nested ) THEN<a name='2526'>
<a name='2527'>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2528'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='2529'></font>
<a name='2530'>
      DO ij = 1 , num_tiles<a name='2531'>
<a name='2532'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYFIELD'>spec_bdyfield</A><A href='../../html_code/phys/module_radiation_driver.F.html#PRE_RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYFIELD_1">(ht_shad,                         &amp;<a name='2533'>
                               ht_shad_bxs, ht_shad_bxe,       &amp;<a name='2534'>
                               ht_shad_bys, ht_shad_bye,       &amp;<a name='2535'>
                               'm', config_flags, spec_bdy_width, 2,&amp;<a name='2536'>
                               ids,ide, jds,jde, 1  ,1  ,  &amp; <font color=#447700>! domain dims<a name='2537'></font>
                               ims,ime, jms,jme, 1  ,1  ,  &amp; <font color=#447700>! memory dims<a name='2538'></font>
                               ips,ipe, jps,jpe, 1  ,1  ,  &amp; <font color=#447700>! patch  dims<a name='2539'></font>
                               i_start(ij), i_end(ij),         &amp;<a name='2540'>
                               j_start(ij), j_end(ij),         &amp;<a name='2541'>
                               1    , 1             )<a name='2542'>
      ENDDO<a name='2543'>
    ENDIF<a name='2544'>
<a name='2545'>
     do ni = 1, niter<a name='2546'>
<a name='2547'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2548'></font>
   <font color=#447700>!$OMP PRIVATE ( ij,i,j )<a name='2549'></font>
         do ij = 1 , num_tiles<a name='2550'>
<a name='2551'>
         call <A href='../../html_code/phys/module_radiation_driver.F.html#TOPOSHAD_INIT'>toposhad_init</A><A href='../../html_code/phys/module_radiation_driver.F.html#PRE_RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TOPOSHAD_INIT_1"> (ht_shad,ht_loc,                         &amp;<a name='2552'>
                       shadowmask,nested,ni,                         &amp;<a name='2553'>
                       ids,ide, jds,jde, kds,kde,                    &amp;<a name='2554'>
                       ims,ime, jms,jme, kms,kme,                    &amp;<a name='2555'>
                       ips,min(ipe,ide-1), jps,min(jpe,jde-1), kps,kpe,      &amp;<a name='2556'>
                       i_start(ij),min(i_end(ij), ide-1),j_start(ij),&amp;<a name='2557'>
                       min(j_end(ij), jde-1), kts, kte               )<a name='2558'>
<a name='2559'>
         enddo<a name='2560'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2561'></font>
<a name='2562'>
<a name='2563'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2564'></font>
   <font color=#447700>!$OMP PRIVATE ( ij,i,j )<a name='2565'></font>
       do ij = 1 , num_tiles<a name='2566'>
<a name='2567'>
       call <A href='../../html_code/phys/module_radiation_driver.F.html#TOPOSHAD'>toposhad</A><A href='../../html_code/phys/module_radiation_driver.F.html#PRE_RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TOPOSHAD_1"> (xlat,xlong,sina,cosa,xtime,gmt,radt,declin,    &amp;<a name='2568'>
                       dx,dy,ht_shad,ht_loc,ni,                      &amp;<a name='2569'>
                       shadowmask,shadlen,                           &amp;<a name='2570'>
                       ids,ide, jds,jde, kds,kde,                    &amp;<a name='2571'>
                       ims,ime, jms,jme, kms,kme,                    &amp;<a name='2572'>
                       ips,min(ipe,ide-1), jps,min(jpe,jde-1), kps,kpe,        &amp;<a name='2573'>
                       i_start(ij),min(i_end(ij), ide-1),j_start(ij),&amp;<a name='2574'>
                       min(j_end(ij), jde-1), kts, kte               )<a name='2575'>
<a name='2576'>
       enddo<a name='2577'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2578'></font>
<a name='2579'>
#if defined( DM_PARALLEL ) &amp;&amp; (EM_CORE == 1)<a name='2580'>
#     include "<A href='../../html_code/include/HALO_TOPOSHAD.inc.html'>HALO_TOPOSHAD.inc</A>"<A NAME="HALO_TOPOSHAD.inc_1"><A href='../../html_code/phys/module_radiation_driver.F.html#PRE_RADIATION_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2581'>
#endif<a name='2582'>
     enddo<a name='2583'>
   endif<a name='2584'>
<a name='2585'>
   END SUBROUTINE pre_radiation_driver<a name='2586'>
<a name='2587'>
<font color=#447700>!---------------------------------------------------------------------<a name='2588'></font>
<font color=#447700>!BOP<a name='2589'></font>
<font color=#447700>! !IROUTINE: radconst - compute radiation terms<a name='2590'></font>
<font color=#447700>! !INTERFAC:<a name='2591'></font>
<A NAME='RADCONST'><A href='../../html_code/phys/module_radiation_driver.F.html#RADCONST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2592'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>radconst</font>(XTIME,DECLIN,SOLCON,JULIAN,                   &amp; <A href='../../call_to/RADCONST.html' TARGET='index'>3</A>,<A href='../../call_from/RADCONST.html' TARGET='index'>1</A><a name='2593'>
                       DEGRAD,DPD                                    )<a name='2594'>
<font color=#447700>!---------------------------------------------------------------------<a name='2595'></font>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_radiation_driver.F.html#RADCONST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_83"><a name='2596'>
   IMPLICIT NONE<a name='2597'>
<font color=#447700>!---------------------------------------------------------------------<a name='2598'></font>
<a name='2599'>
<font color=#447700>! !ARGUMENTS:<a name='2600'></font>
   REAL, INTENT(IN   )      ::       DEGRAD,DPD,XTIME,JULIAN<a name='2601'>
   REAL, INTENT(OUT  )      ::       DECLIN,SOLCON<a name='2602'>
   REAL                     ::       OBECL,SINOB,SXLONG,ARG,  &amp;<a name='2603'>
                                     DECDEG,DJUL,RJUL,ECCFAC<a name='2604'>
<font color=#447700>!<a name='2605'></font>
<font color=#447700>! !DESCRIPTION:<a name='2606'></font>
<font color=#447700>! Compute terms used in radiation physics <a name='2607'></font>
<font color=#447700>!EOP<a name='2608'></font>
<a name='2609'>
<font color=#447700>! for short wave radiation<a name='2610'></font>
<a name='2611'>
   DECLIN=0.<a name='2612'>
   SOLCON=0.<a name='2613'>
<a name='2614'>
<font color=#447700>!-----OBECL : OBLIQUITY = 23.5 DEGREE.<a name='2615'></font>
        <a name='2616'>
   OBECL=23.5*DEGRAD<a name='2617'>
   SINOB=SIN(OBECL)<a name='2618'>
        <a name='2619'>
<font color=#447700>!-----CALCULATE LONGITUDE OF THE SUN FROM VERNAL EQUINOX:<a name='2620'></font>
        <a name='2621'>
   IF(JULIAN.GE.80.)SXLONG=DPD*(JULIAN-80.)<a name='2622'>
   IF(JULIAN.LT.80.)SXLONG=DPD*(JULIAN+285.)<a name='2623'>
   SXLONG=SXLONG*DEGRAD<a name='2624'>
   ARG=SINOB*SIN(SXLONG)<a name='2625'>
   DECLIN=ASIN(ARG)<a name='2626'>
   DECDEG=DECLIN/DEGRAD<a name='2627'>
<font color=#447700>!----SOLAR CONSTANT ECCENTRICITY FACTOR (PALTRIDGE AND PLATT 1976)<a name='2628'></font>
   DJUL=JULIAN*360./365.<a name='2629'>
   RJUL=DJUL*DEGRAD<a name='2630'>
   ECCFAC=1.000110+0.034221*COS(RJUL)+0.001280*SIN(RJUL)+0.000719*  &amp;<a name='2631'>
          COS(2*RJUL)+0.000077*SIN(2*RJUL)<a name='2632'>
   SOLCON=1370.*ECCFAC<a name='2633'>
   <a name='2634'>
   END SUBROUTINE radconst<a name='2635'>
<a name='2636'>
<a name='2637'>
<A NAME='CALC_COSZEN'><A href='../../html_code/phys/module_radiation_driver.F.html#CALC_COSZEN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2638'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_coszen</font>(ims,ime,jms,jme,its,ite,jts,jte,  &amp; <A href='../../call_to/CALC_COSZEN.html' TARGET='index'>2</A><a name='2639'>
                          julian,xtime,gmt, &amp;<a name='2640'>
                          declin,degrad,xlon,xlat,coszen,hrang)<a name='2641'>
       <font color=#447700>! Added Equation of Time correction : jararias, 2013/08/10<a name='2642'></font>
       implicit none<a name='2643'>
       integer, intent(in) :: ims,ime,jms,jme,its,ite,jts,jte<a name='2644'>
       real, intent(in)    :: julian,declin,xtime,gmt,degrad<a name='2645'>
       real, dimension(ims:ime,jms:jme), intent(in)    :: xlat,xlon<a name='2646'>
       real, dimension(ims:ime,jms:jme), intent(inout) :: coszen,hrang<a name='2647'>
<a name='2648'>
       integer :: i,j<a name='2649'>
       real    :: da,eot,xt24,tloctm,xxlat<a name='2650'>
<a name='2651'>
       da=6.2831853071795862*(julian-1)/365.<a name='2652'>
       eot=(0.000075+0.001868*cos(da)-0.032077*sin(da) &amp;<a name='2653'>
            -0.014615*cos(2*da)-0.04089*sin(2*da))*(229.18)<a name='2654'>
       xt24=mod(xtime,1440.)+eot<a name='2655'>
       do j=jts,jte<a name='2656'>
          do i=its,ite<a name='2657'>
             tloctm=gmt+xt24/60.+xlon(i,j)/15.<a name='2658'>
             hrang(i,j)=15.*(tloctm-12.)*degrad<a name='2659'>
             xxlat=xlat(i,j)*degrad<a name='2660'>
             coszen(i,j)=sin(xxlat)*sin(declin) &amp;<a name='2661'>
                        +cos(xxlat)*cos(declin) *cos(hrang(i,j))<a name='2662'>
          enddo<a name='2663'>
       enddo<a name='2664'>
   END SUBROUTINE calc_coszen<a name='2665'>
<a name='2666'>
<A NAME='UPDATE_SWINTERP_PARAMETERS'><A href='../../html_code/phys/module_radiation_driver.F.html#UPDATE_SWINTERP_PARAMETERS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2667'>
   <font color=#993300>subroutine </font><font color=#cc0000>update_swinterp_parameters</font>(ims,ime,jms,jme,its,ite,jts,jte, &amp; <A href='../../call_to/UPDATE_SWINTERP_PARAMETERS.html' TARGET='index'>1</A><a name='2668'>
                                         coszen,coszen_loc,swddir,swdown, &amp;<a name='2669'>
                                         swddir_ref,bb,Bx,                &amp;<a name='2670'>
                                         swdown_ref,gg,Gx,                &amp;<a name='2671'>
                                         coszen_ref                       )<a name='2672'>
      <font color=#447700>! Author: jararias 2013/11<a name='2673'></font>
      implicit None<a name='2674'>
      integer, intent(in) :: ims,ime,jms,jme,its,ite,jts,jte<a name='2675'>
      real, dimension(ims:ime,jms:jme), intent(in)    :: coszen,coszen_loc,swddir,swdown<a name='2676'>
      real, dimension(ims:ime,jms:jme), intent(inout) :: swddir_ref,bb,Bx, &amp;<a name='2677'>
                                                         swdown_ref,gg,Gx, &amp;<a name='2678'>
                                                         coszen_ref<a name='2679'>
<a name='2680'>
      integer :: i,j<a name='2681'>
      real :: swddir_0,swdown_0,coszen_0<a name='2682'>
      real, parameter :: coszen_min=1e-4<a name='2683'>
<a name='2684'>
      do j=jts,jte<a name='2685'>
         do i=its,ite<a name='2686'>
            if ((coszen(i,j).gt.coszen_min) .and. (coszen_loc(i,j).gt.coszen_min)) then<a name='2687'>
               <font color=#447700>! parameters update for DIR<a name='2688'></font>
               if (Bx(i,j).le.0) then<a name='2689'>
                  swddir_0 =(coszen_loc(i,j)/coszen(i,j))*swddir(i,j) <font color=#447700>! linear first guess estimation<a name='2690'></font>
                  coszen_0 =coszen_loc(i,j)<a name='2691'>
               else<a name='2692'>
                  swddir_0 =swddir_ref(i,j)<a name='2693'>
                  coszen_0 =coszen_ref(i,j)<a name='2694'>
               end if<a name='2695'>
               if ((coszen(i,j)/coszen_0).lt.1.) then<a name='2696'>
                  bb(i,j) =log(max(1.,swddir(i,j))/max(1.,swddir_0)) / log(min(1.-1e-4,coszen(i,j)/coszen_0))<a name='2697'>
               elseif ((coszen(i,j)/coszen_0).gt.1) then<a name='2698'>
                  bb(i,j) =log(max(1.,swddir(i,j))/max(1.,swddir_0)) / log(max(1.+1e-4,coszen(i,j)/coszen_0))<a name='2699'>
               else<a name='2700'>
                  bb(i,j) =0.<a name='2701'>
               end if<a name='2702'>
               bb(i,j) =max(-.5,min(2.5,bb(i,j)))<a name='2703'>
               Bx(i,j) =swddir(i,j)/(coszen(i,j)**bb(i,j))<a name='2704'>
<a name='2705'>
               <font color=#447700>!write(wrf_err_message,*) 'XXX I=',i,' J=',j,'  Bx=',Bx(i,j),'  bb=',bb(i,j),'  swddir=',swddir(i,j), &amp;<a name='2706'></font>
               <font color=#447700>!                         '  swddir_0=',swddir_0,'  coszen=',coszen(i,j),'  coszen_0=',coszen_0<a name='2707'></font>
               <font color=#447700>!call wrf_debug(1,wrf_err_message)<a name='2708'></font>
<a name='2709'>
               <font color=#447700>! parameters update for GHI<a name='2710'></font>
               if (Gx(i,j).le.0) then<a name='2711'>
                  swdown_0 =(coszen_loc(i,j)/coszen(i,j))*swdown(i,j) <font color=#447700>! linear first guess estimation<a name='2712'></font>
                  coszen_0 =coszen_loc(i,j)<a name='2713'>
               else<a name='2714'>
                  swdown_0 =swdown_ref(i,j)<a name='2715'>
                  coszen_0 =coszen_ref(i,j)<a name='2716'>
               end if<a name='2717'>
               if ((coszen(i,j)/coszen_0).lt.1.) then<a name='2718'>
                  gg(i,j) =log(max(1.,swdown(i,j))/max(1.,swdown_0)) / log(min(1.-1e-4,coszen(i,j)/coszen_0))<a name='2719'>
               elseif ((coszen(i,j)/coszen_0).gt.1) then<a name='2720'>
                  gg(i,j) =log(max(1.,swdown(i,j))/max(1.,swdown_0)) / log(max(1.+1e-4,coszen(i,j)/coszen_0))<a name='2721'>
               else<a name='2722'>
                  gg(i,j) =0.<a name='2723'>
               end if<a name='2724'>
               gg(i,j) =max(-.5,min(2.5,gg(i,j)))<a name='2725'>
               Gx(i,j) =swdown(i,j)/(coszen(i,j)**gg(i,j))<a name='2726'>
            else<a name='2727'>
               Bx(i,j) =0.<a name='2728'>
               bb(i,j) =0.<a name='2729'>
               Gx(i,j) =0.<a name='2730'>
               gg(i,j) =0.<a name='2731'>
            end if<a name='2732'>
<a name='2733'>
            <font color=#447700>! saving last SW run in state variables<a name='2734'></font>
            coszen_ref(i,j) =coszen(i,j)<a name='2735'>
            swdown_ref(i,j) =swdown(i,j)<a name='2736'>
            swddir_ref(i,j) =swddir(i,j)<a name='2737'>
<a name='2738'>
            <font color=#447700>!if ((i.eq.20).and.(j.eq.20)) then<a name='2739'></font>
            <font color=#447700>!   write(wrf_err_message,'("   RADSTEP : tn=",I4," csz_0=",F9.6," csz=",F9.6," csz_1=",F9.6," Gx=",F14.2," gg=",F9.5,  &amp;<a name='2740'></font>
            <font color=#447700>!                           " Bx=",F14.2," bb=",F9.5)') itimestep,coszen_0,coszen_loc(i,j),coszen(i,j),Gx(i,j),gg(i,j), &amp;<a name='2741'></font>
            <font color=#447700>!                           Bx(i,j),bb(i,j)<a name='2742'></font>
            <font color=#447700>!   call wrf_debug(1,wrf_err_message)<a name='2743'></font>
            <font color=#447700>!end if<a name='2744'></font>
<a name='2745'>
         end do<a name='2746'>
      end do<a name='2747'>
<a name='2748'>
   end subroutine update_swinterp_parameters<a name='2749'>
<a name='2750'>
<A NAME='INTERP_SW_RADIATION'><A href='../../html_code/phys/module_radiation_driver.F.html#INTERP_SW_RADIATION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2751'>
   <font color=#993300>subroutine </font><font color=#cc0000>interp_sw_radiation</font>(ims,ime,jms,jme,its,ite,jts,jte,  &amp; <A href='../../call_to/INTERP_SW_RADIATION.html' TARGET='index'>1</A><a name='2752'>
                                  coszen_ref,coszen_loc,swddir_ref, &amp;<a name='2753'>
                                  bb,Bx,swdown_ref,gg,Gx,albedo,    &amp;<a name='2754'>
                                  swdown,swddir,swddni,swddif,gsw   )<a name='2755'>
      <font color=#447700>! Author: jararias 2013/11<a name='2756'></font>
      implicit None<a name='2757'>
      integer, intent(in) :: ims,ime,jms,jme,its,ite,jts,jte<a name='2758'>
      real, dimension(ims:ime,jms:jme), intent(in) :: coszen_ref,coszen_loc, &amp;<a name='2759'>
                                                      swddir_ref,Bx,bb,      &amp;<a name='2760'>
                                                      swdown_ref,Gx,gg,      &amp;<a name='2761'>
                                                      albedo<a name='2762'>
<a name='2763'>
      real, dimension(ims:ime,jms:jme), intent(inout) :: swddir,swdown, &amp;<a name='2764'>
                                                         swddif,swddni, gsw<a name='2765'>
<a name='2766'>
      integer :: i,j<a name='2767'>
      real, parameter :: coszen_min=1e-4<a name='2768'>
<a name='2769'>
      do j=jts,jte<a name='2770'>
         do i=its,ite<a name='2771'>
            <font color=#447700>! sza interpolation of surface fluxes<a name='2772'></font>
            if ((coszen_ref(i,j).gt.coszen_min) .and. (coszen_loc(i,j).gt.coszen_min)) then<a name='2773'>
               if ((bb(i,j).eq.-0.5).or.(bb(i,j).eq.2.5).or.(bb(i,j).eq.0.0)) then<a name='2774'>
                  swddir(i,j) =(coszen_loc(i,j)/coszen_ref(i,j))*swddir_ref(i,j)<a name='2775'>
               else<a name='2776'>
                  swddir(i,j) =Bx(i,j)*(coszen_loc(i,j)**bb(i,j))<a name='2777'>
               end if<a name='2778'>
               if ((gg(i,j).eq.-0.5).or.(gg(i,j).eq.2.5).or.(gg(i,j).eq.0.0)) then<a name='2779'>
                  swdown(i,j) =(coszen_loc(i,j)/coszen_ref(i,j))*swdown_ref(i,j)<a name='2780'>
               else<a name='2781'>
                  swdown(i,j) =Gx(i,j)*(coszen_loc(i,j)**gg(i,j))<a name='2782'>
               end if<a name='2783'>
               swddif(i,j) =swdown(i,j)-swddir(i,j)<a name='2784'>
               swddni(i,j) =swddir(i,j)/coszen_loc(i,j)<a name='2785'>
               gsw(i,j)    =swdown(i,j)*(1.-albedo(i,j))<a name='2786'>
            else<a name='2787'>
               swddir(i,j) =0.<a name='2788'>
               swdown(i,j) =0.<a name='2789'>
               swddif(i,j) =0.<a name='2790'>
               swddni(i,j) =0.<a name='2791'>
               gsw(i,j)    =0.<a name='2792'>
            end if<a name='2793'>
         end do<a name='2794'>
      end do<a name='2795'>
   end subroutine interp_sw_radiation<a name='2796'>
<a name='2797'>
<font color=#447700>!---------------------------------------------------------------------<a name='2798'></font>
<font color=#447700>!BOP<a name='2799'></font>
<font color=#447700>! !IROUTINE: cal_cldfra2 - Compute cloud fraction<a name='2800'></font>
<font color=#447700>! !INTERFACE:<a name='2801'></font>
<A NAME='CAL_CLDFRA2'><A href='../../html_code/phys/module_radiation_driver.F.html#CAL_CLDFRA2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2802'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_cldfra2</font>(CLDFRA,QC,QI,F_QC,F_QI,                    &amp; <A href='../../call_to/CAL_CLDFRA2.html' TARGET='index'>2</A>,<A href='../../call_from/CAL_CLDFRA2.html' TARGET='index'>1</A><a name='2803'>
          ids,ide, jds,jde, kds,kde,                                 &amp;<a name='2804'>
          ims,ime, jms,jme, kms,kme,                                 &amp;<a name='2805'>
          its,ite, jts,jte, kts,kte                                  )<a name='2806'>
     USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_radiation_driver.F.html#CAL_CLDFRA2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_149">, ONLY : KFCUPSCHEME, KFETASCHEME       <font color=#447700>!CuP, wig 5-Oct-2006  !BSINGH - For WRFCuP scheme <a name='2807'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='2808'></font>
   IMPLICIT NONE<a name='2809'>
<font color=#447700>!---------------------------------------------------------------------<a name='2810'></font>
   INTEGER,  INTENT(IN   )   ::           ids,ide, jds,jde, kds,kde, &amp;<a name='2811'>
                                          ims,ime, jms,jme, kms,kme, &amp;<a name='2812'>
                                          its,ite, jts,jte, kts,kte<a name='2813'>
<a name='2814'>
<font color=#447700>!<a name='2815'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(OUT  ) ::    &amp;<a name='2816'>
                                                             CLDFRA<a name='2817'>
<a name='2818'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::    &amp;<a name='2819'>
                                                                 QI, &amp;<a name='2820'>
                                                                 QC<a name='2821'>
   LOGICAL,INTENT(IN) :: F_QC,F_QI<a name='2822'>
<a name='2823'>
   REAL thresh<a name='2824'>
   INTEGER:: i,j,k<a name='2825'>
<font color=#447700>! !DESCRIPTION:<a name='2826'></font>
<font color=#447700>! Compute cloud fraction from input ice and cloud water fields<a name='2827'></font>
<font color=#447700>! if provided.<a name='2828'></font>
<font color=#447700>!<a name='2829'></font>
<font color=#447700>! Whether QI or QC is active or not is determined from the indices of<a name='2830'></font>
<font color=#447700>! the fields into the 4D scalar arrays in WRF. These indices are<a name='2831'></font>
<font color=#447700>! P_QI and P_QC, respectively, and they are passed in to the routine<a name='2832'></font>
<font color=#447700>! to enable testing to see if QI and QC represent active fields in<a name='2833'></font>
<font color=#447700>! the moisture 4D scalar array carried by WRF.<a name='2834'></font>
<font color=#447700>!<a name='2835'></font>
<font color=#447700>! If a field is active its index will have a value greater than or<a name='2836'></font>
<font color=#447700>! equal to PARAM_FIRST_SCALAR, which is also an input argument to<a name='2837'></font>
<font color=#447700>! this routine.<a name='2838'></font>
<font color=#447700>!EOP<a name='2839'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='2840'></font>
     thresh=1.0e-6<a name='2841'>
<a name='2842'>
     IF ( f_qi .AND. f_qc ) THEN<a name='2843'>
        DO j = jts,jte<a name='2844'>
        DO k = kts,kte<a name='2845'>
        DO i = its,ite<a name='2846'>
           IF ( QC(i,k,j)+QI(I,k,j) .gt. thresh) THEN<a name='2847'>
              CLDFRA(i,k,j)=1.<a name='2848'>
           ELSE<a name='2849'>
              CLDFRA(i,k,j)=0.<a name='2850'>
           ENDIF<a name='2851'>
        ENDDO<a name='2852'>
        ENDDO<a name='2853'>
        ENDDO<a name='2854'>
     ELSE IF ( f_qc ) THEN<a name='2855'>
        DO j = jts,jte<a name='2856'>
        DO k = kts,kte<a name='2857'>
        DO i = its,ite<a name='2858'>
           IF ( QC(i,k,j) .gt. thresh) THEN<a name='2859'>
              CLDFRA(i,k,j)=1.<a name='2860'>
           ELSE<a name='2861'>
              CLDFRA(i,k,j)=0.<a name='2862'>
           ENDIF<a name='2863'>
        ENDDO<a name='2864'>
        ENDDO<a name='2865'>
        ENDDO<a name='2866'>
     ELSE<a name='2867'>
        DO j = jts,jte<a name='2868'>
        DO k = kts,kte<a name='2869'>
        DO i = its,ite<a name='2870'>
           CLDFRA(i,k,j)=0.<a name='2871'>
        ENDDO<a name='2872'>
        ENDDO<a name='2873'>
        ENDDO<a name='2874'>
     ENDIF<a name='2875'>
   END SUBROUTINE cal_cldfra2<a name='2876'>
<a name='2877'>
<font color=#447700>!BOP<a name='2878'></font>
<font color=#447700>! !IROUTINE: cal_cldfra1 - Compute cloud fraction<a name='2879'></font>
<font color=#447700>! !INTERFACE:<a name='2880'></font>
<font color=#447700>! cal_cldfra_xr - Compute cloud fraction.<a name='2881'></font>
<font color=#447700>! Code adapted from that in module_ra_gfdleta.F in WRF_v2.0.3 by James Done<a name='2882'></font>
<font color=#447700>!!<a name='2883'></font>
<font color=#447700>!!---  Cloud fraction parameterization follows Xu and Randall (JAS), 1996<a name='2884'></font>
<font color=#447700>!!     (see Hong et al., 1998)<a name='2885'></font>
<font color=#447700>!!     (modified by Ferrier, Feb '02)<a name='2886'></font>
<font color=#447700>!<a name='2887'></font>
<A NAME='CAL_CLDFRA1'><A href='../../html_code/phys/module_radiation_driver.F.html#CAL_CLDFRA1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2888'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_cldfra1</font>(CLDFRA, QV, QC, QI, QS,                    &amp; <A href='../../call_to/CAL_CLDFRA1.html' TARGET='index'>1</A>,<A href='../../call_from/CAL_CLDFRA1.html' TARGET='index'>3</A><a name='2889'>
                         F_QV, F_QC, F_QI, F_QS, t_phy, p_phy,       &amp;<a name='2890'>
                         F_ICE_PHY,F_RAIN_PHY,                       &amp;<a name='2891'>
                         mp_physics, cldfra1_flag,                   &amp;<a name='2892'>
          ids,ide, jds,jde, kds,kde,                                 &amp;<a name='2893'>
          ims,ime, jms,jme, kms,kme,                                 &amp;<a name='2894'>
          its,ite, jts,jte, kts,kte                                  )<a name='2895'>
     USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_radiation_driver.F.html#CAL_CLDFRA1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_150">, ONLY : KFCUPSCHEME, KFETASCHEME       <font color=#447700>!wig, CuP 4-Fb-2008 !BSINGH - For WRFCuP scheme<a name='2896'></font>
<a name='2897'>
#if (HWRF == 1)<a name='2898'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_radiation_driver.F.html#CAL_CLDFRA1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_151">, ONLY : FER_MP_HIRES, FER_MP_HIRES_ADVECT, ETAMP_HWRF <a name='2899'>
#else<a name='2900'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_radiation_driver.F.html#CAL_CLDFRA1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_152">, ONLY : FER_MP_HIRES, FER_MP_HIRES_ADVECT<a name='2901'>
#endif<a name='2902'>
<font color=#447700>!---------------------------------------------------------------------<a name='2903'></font>
   IMPLICIT NONE<a name='2904'>
<font color=#447700>!---------------------------------------------------------------------<a name='2905'></font>
   INTEGER,  INTENT(IN   )   ::           ids,ide, jds,jde, kds,kde, &amp;<a name='2906'>
                                          ims,ime, jms,jme, kms,kme, &amp;<a name='2907'>
                                          its,ite, jts,jte, kts,kte<a name='2908'>
<a name='2909'>
<font color=#447700>!<a name='2910'></font>
   INTEGER, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(OUT  ) :: cldfra1_flag<a name='2911'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(OUT  ) ::    &amp;<a name='2912'>
                                                             CLDFRA<a name='2913'>
<a name='2914'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::    &amp;<a name='2915'>
                                                                 QV, &amp;<a name='2916'>
                                                                 QI, &amp;<a name='2917'>
                                                                 QC, &amp;<a name='2918'>
                                                                 QS, &amp;<a name='2919'>
                                                              t_phy, &amp;<a name='2920'>
                                                              p_phy<a name='2921'>
<font color=#447700>!                                                              p_phy, &amp;<a name='2922'></font>
<font color=#447700>!                                                          F_ICE_PHY, &amp;<a name='2923'></font>
<font color=#447700>!                                                         F_RAIN_PHY<a name='2924'></font>
<a name='2925'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                     &amp;<a name='2926'>
         OPTIONAL,                                                   &amp;<a name='2927'>
         INTENT(IN   ) ::                                            &amp;<a name='2928'>
                                                          F_ICE_PHY, &amp;<a name='2929'>
                                                         F_RAIN_PHY<a name='2930'>
   LOGICAL,OPTIONAL,INTENT(IN) :: F_QC,F_QI,F_QV,F_QS<a name='2931'>
   INTEGER :: mp_physics<a name='2932'>
<a name='2933'>
<font color=#447700>!  REAL thresh<a name='2934'></font>
   INTEGER:: i,j,k<a name='2935'>
   REAL    :: RHUM, tc, esw, esi, weight, qvsw, qvsi, qvs_weight, QIMID, QWMID, QCLD, DENOM, ARG, SUBSAT<a name='2936'>
<a name='2937'>
   REAL    ,PARAMETER :: ALPHA0=100., GAMMA=0.49, QCLDMIN=1.E-12,    &amp;<a name='2938'>
                                        PEXP=0.25, RHGRID=1.0<a name='2939'>
   REAL    , PARAMETER ::  SVP1=0.61078<a name='2940'>
   REAL    , PARAMETER ::  SVP2=17.2693882<a name='2941'>
   REAL    , PARAMETER ::  SVPI2=21.8745584<a name='2942'>
   REAL    , PARAMETER ::  SVP3=35.86<a name='2943'>
   REAL    , PARAMETER ::  SVPI3=7.66<a name='2944'>
   REAL    , PARAMETER ::  SVPT0=273.15<a name='2945'>
   REAL    , PARAMETER ::  r_d = 287.<a name='2946'>
   REAL    , PARAMETER ::  r_v = 461.6<a name='2947'>
   REAL    , PARAMETER ::  ep_2=r_d/r_v<a name='2948'>
<font color=#447700>! !DESCRIPTION:<a name='2949'></font>
<font color=#447700>! Compute cloud fraction from input ice and cloud water fields<a name='2950'></font>
<font color=#447700>! if provided.<a name='2951'></font>
<font color=#447700>!<a name='2952'></font>
<font color=#447700>! Whether QI or QC is active or not is determined from the indices of<a name='2953'></font>
<font color=#447700>! the fields into the 4D scalar arrays in WRF. These indices are <a name='2954'></font>
<font color=#447700>! P_QI and P_QC, respectively, and they are passed in to the routine<a name='2955'></font>
<font color=#447700>! to enable testing to see if QI and QC represent active fields in<a name='2956'></font>
<font color=#447700>! the moisture 4D scalar array carried by WRF.<a name='2957'></font>
<font color=#447700>! <a name='2958'></font>
<font color=#447700>! If a field is active its index will have a value greater than or<a name='2959'></font>
<font color=#447700>! equal to PARAM_FIRST_SCALAR, which is also an input argument to <a name='2960'></font>
<font color=#447700>! this routine.<a name='2961'></font>
<font color=#447700>!EOP<a name='2962'></font>
<a name='2963'>
<a name='2964'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2965'></font>
<font color=#447700>!---  COMPUTE GRID-SCALE CLOUD COVER FOR RADIATION<a name='2966'></font>
<font color=#447700>!     (modified by Ferrier, Feb '02)<a name='2967'></font>
<font color=#447700>!<a name='2968'></font>
<font color=#447700>!---  Cloud fraction parameterization follows Randall, 1994<a name='2969'></font>
<font color=#447700>!     (see Hong et al., 1998)<a name='2970'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2971'></font>
<font color=#447700>! Note: ep_2=287./461.6 Rd/Rv<a name='2972'></font>
<font color=#447700>! Note: R_D=287.<a name='2973'></font>
<a name='2974'>
<font color=#447700>! Alternative calculation for critical RH for grid saturation<a name='2975'></font>
<font color=#447700>!     RHGRID=0.90+.08*((100.-DX)/95.)**.5<a name='2976'></font>
<a name='2977'>
<font color=#447700>! Calculate saturation mixing ratio weighted according to the fractions of<a name='2978'></font>
<font color=#447700>! water and ice.<a name='2979'></font>
<font color=#447700>! Following:<a name='2980'></font>
<font color=#447700>! Murray, F.W. 1966. ``On the computation of Saturation Vapor Pressure''  J. Appl. Meteor.  6 p.204<a name='2981'></font>
<font color=#447700>!    es (in mb) = 6.1078 . exp[ a . (T-273.16)/ (T-b) ]<a name='2982'></font>
<font color=#447700>!<a name='2983'></font>
<font color=#447700>!       over ice        over water<a name='2984'></font>
<font color=#447700>! a =   21.8745584      17.2693882<a name='2985'></font>
<font color=#447700>! b =   7.66            35.86<a name='2986'></font>
<a name='2987'>
<font color=#447700>!---------------------------------------------------------------------<a name='2988'></font>
<a name='2989'>
    DO j = jts,jte<a name='2990'>
    DO k = kts,kte<a name='2991'>
    DO i = its,ite<a name='2992'>
      tc         = t_phy(i,k,j) - SVPT0<a name='2993'>
      esw     = 1000.0 * SVP1 * EXP( SVP2  * tc / ( t_phy(i,k,j) - SVP3  ) )<a name='2994'>
      esi     = 1000.0 * SVP1 * EXP( SVPI2 * tc / ( t_phy(i,k,j) - SVPI3 ) )<a name='2995'>
      QVSW = EP_2 * esw / ( p_phy(i,k,j) - esw )<a name='2996'>
      QVSI = EP_2 * esi / ( p_phy(i,k,j) - esi )<a name='2997'>
<a name='2998'>
      ifouter: IF ( PRESENT(F_QI) .and. PRESENT(F_QC) .and. PRESENT(F_QS) ) THEN<a name='2999'>
<a name='3000'>
<font color=#447700>! mji - For MP options 2, 4, 6, 7, 8, etc. (qc = liquid, qi = ice, qs = snow)<a name='3001'></font>
         IF ( F_QI .and. F_QC .and. F_QS) THEN<a name='3002'>
            QCLD = QI(i,k,j)+QC(i,k,j)+QS(i,k,j)<a name='3003'>
            IF (QCLD .LT. QCLDMIN) THEN<a name='3004'>
               weight = 0.<a name='3005'>
            ELSE<a name='3006'>
               weight = (QI(i,k,j)+QS(i,k,j)) / QCLD<a name='3007'>
            ENDIF<a name='3008'>
         ENDIF<a name='3009'>
<a name='3010'>
<font color=#447700>! for P3, mp option 50 or 51<a name='3011'></font>
         IF ( F_QI .and. F_QC .and. .not. F_QS) THEN<a name='3012'>
            QCLD = QI(i,k,j)+QC(i,k,j)<a name='3013'>
            IF (QCLD .LT. QCLDMIN) THEN<a name='3014'>
               weight = 0.<a name='3015'>
            ELSE<a name='3016'>
               weight = (QI(i,k,j)) / QCLD<a name='3017'>
            ENDIF<a name='3018'>
         ENDIF<a name='3019'>
<a name='3020'>
<font color=#447700>! mji - For MP options 1 and 3, (qc only)<a name='3021'></font>
<font color=#447700>!  For MP=1, qc = liquid, for MP=3, qc = liquid or ice depending on temperature<a name='3022'></font>
         IF ( F_QC .and. .not. F_QI .and. .not. F_QS ) THEN<a name='3023'>
            QCLD = QC(i,k,j)<a name='3024'>
            IF (QCLD .LT. QCLDMIN) THEN<a name='3025'>
               weight = 0.<a name='3026'>
            ELSE<a name='3027'>
               if (t_phy(i,k,j) .gt. 273.15) weight = 0.<a name='3028'>
               if (t_phy(i,k,j) .le. 273.15) weight = 1.<a name='3029'>
            ENDIF<a name='3030'>
         ENDIF<a name='3031'>
<a name='3032'>
<font color=#447700>! mji - For MP option 5; (qc = liquid, qs = ice)<a name='3033'></font>
         IF ( F_QC .and. .not. F_QI .and. F_QS .and. PRESENT(F_ICE_PHY) ) THEN<a name='3034'>
<a name='3035'>
<font color=#447700>! Mixing ratios of cloud water &amp; total ice (cloud ice + snow).<a name='3036'></font>
<font color=#447700>! Mixing ratios of rain are not considered in this scheme.<a name='3037'></font>
<font color=#447700>! F_ICE is fraction of ice<a name='3038'></font>
<font color=#447700>! F_RAIN is fraction of rain<a name='3039'></font>
<a name='3040'>
           QIMID = QS(i,k,j)<a name='3041'>
           QWMID = QC(i,k,j)<a name='3042'>
<font color=#447700>! old method<a name='3043'></font>
<font color=#447700>!           QIMID = QC(i,k,j)*F_ICE_PHY(i,k,j)<a name='3044'></font>
<font color=#447700>!           QWMID = (QC(i,k,j)-QIMID)*(1.-F_RAIN_PHY(i,k,j))<a name='3045'></font>
<font color=#447700>!<a name='3046'></font>
<font color=#447700>!--- Total "cloud" mixing ratio, QCLD.  Rain is not part of cloud,<a name='3047'></font>
<font color=#447700>!    only cloud water + cloud ice + snow<a name='3048'></font>
<font color=#447700>!<a name='3049'></font>
           QCLD=QWMID+QIMID<a name='3050'>
           IF (QCLD .LT. QCLDMIN) THEN<a name='3051'>
              weight = 0.<a name='3052'>
           ELSE<a name='3053'>
              weight = F_ICE_PHY(i,k,j)<a name='3054'>
           ENDIF<a name='3055'>
         ENDIF<a name='3056'>
<font color=#447700>!BSF - For HWRF MP option; (qc = liquid, qi = cloud ice+snow)<a name='3057'></font>
<font color=#447700>!         IF ( F_QC .and. F_QI .and. .not. F_QS ) THEN<a name='3058'></font>
#if (HWRF == 1)<a name='3059'>
         IF ( mp_physics .eq. FER_MP_HIRES .or. &amp;<a name='3060'>
	      mp_physics .eq. FER_MP_HIRES_ADVECT .or. &amp;<a name='3061'>
	      mp_physics .eq. ETAMP_HWRF) THEN<a name='3062'>
#else<a name='3063'>
         IF ( mp_physics .eq. FER_MP_HIRES .or. &amp;<a name='3064'>
              mp_physics==fer_mp_hires_advect) THEN<a name='3065'>
#endif<a name='3066'>
           QIMID = QI(i,k,j)     <font color=#447700>!- total ice (cloud ice + snow)<a name='3067'></font>
           QWMID = QC(i,k,j)     <font color=#447700>!- cloud water<a name='3068'></font>
           QCLD=QWMID+QIMID      <font color=#447700>!- cloud water + total ice<a name='3069'></font>
           IF (QCLD .LT. QCLDMIN) THEN<a name='3070'>
              weight = 0.<a name='3071'>
           ELSE<a name='3072'>
              weight = QIMID/QCLD<a name='3073'>
              if (tc&lt;-40.) weight=1.<a name='3074'>
           ENDIF<a name='3075'>
         ENDIF<a name='3076'>
<a name='3077'>
      ELSE<a name='3078'>
         CLDFRA(i,k,j)=0.<a name='3079'>
<a name='3080'>
      ENDIF ifouter <font color=#447700>!  IF ( F_QI .and. F_QC .and. F_QS)<a name='3081'></font>
<a name='3082'>
<a name='3083'>
      QVS_WEIGHT = (1-weight)*QVSW + weight*QVSI<a name='3084'>
      RHUM=QV(i,k,j)/QVS_WEIGHT   <font color=#447700>!--- Relative humidity<a name='3085'></font>
<font color=#447700>!<a name='3086'></font>
<font color=#447700>!--- Determine cloud fraction (modified from original algorithm)<a name='3087'></font>
<font color=#447700>!<a name='3088'></font>
      cldfra1_flag(i,k,j) = 0<a name='3089'>
      IF (QCLD .LT. QCLDMIN) THEN<a name='3090'>
<font color=#447700>!<a name='3091'></font>
<font color=#447700>!--- Assume zero cloud fraction if there is no cloud mixing ratio<a name='3092'></font>
<font color=#447700>!<a name='3093'></font>
        CLDFRA(i,k,j)=0.<a name='3094'>
        cldfra1_flag(i,k,j) = 1<a name='3095'>
      ELSEIF(RHUM.GE.RHGRID)THEN<a name='3096'>
<font color=#447700>!<a name='3097'></font>
<font color=#447700>!--- Assume cloud fraction of unity if near saturation and the cloud<a name='3098'></font>
<font color=#447700>!    mixing ratio is at or above the minimum threshold<a name='3099'></font>
<font color=#447700>!<a name='3100'></font>
        CLDFRA(i,k,j)=1.<a name='3101'>
        cldfra1_flag(i,k,j) = 2<a name='3102'>
      ELSE<a name='3103'>
         cldfra1_flag(i,k,j) = 3<a name='3104'>
<font color=#447700>!<a name='3105'></font>
<font color=#447700>!--- Adaptation of original algorithm (Randall, 1994; Zhao, 1995)<a name='3106'></font>
<font color=#447700>!    modified based on assumed grid-scale saturation at RH=RHgrid.<a name='3107'></font>
<font color=#447700>!<a name='3108'></font>
        SUBSAT=MAX(1.E-10,RHGRID*QVS_WEIGHT-QV(i,k,j))<a name='3109'>
        DENOM=(SUBSAT)**GAMMA<a name='3110'>
        ARG=MAX(-6.9, -ALPHA0*QCLD/DENOM)    <font color=#447700>! &lt;-- EXP(-6.9)=.001<a name='3111'></font>
<font color=#447700>! prevent negative values  (new)<a name='3112'></font>
        RHUM=MAX(1.E-10, RHUM)<a name='3113'>
        CLDFRA(i,k,j)=(RHUM/RHGRID)**PEXP*(1.-EXP(ARG))<a name='3114'>
<font color=#447700>!!              ARG=-1000*QCLD/(RHUM-RHGRID)<a name='3115'></font>
<font color=#447700>!!              ARG=MAX(ARG, ARGMIN)<a name='3116'></font>
<font color=#447700>!!              CLDFRA(i,k,j)=(RHUM/RHGRID)*(1.-EXP(ARG))<a name='3117'></font>
        IF (CLDFRA(i,k,j) .LT. .01) CLDFRA(i,k,j)=0.<a name='3118'>
           <a name='3119'>
     ENDIF          <font color=#447700>!--- End IF (QCLD .LT. QCLDMIN) ...     <a name='3120'></font>
    ENDDO          <font color=#447700>!--- End DO i<a name='3121'></font>
    ENDDO          <font color=#447700>!--- End DO k<a name='3122'></font>
    ENDDO          <font color=#447700>!--- End DO j<a name='3123'></font>
<a name='3124'>
   END SUBROUTINE cal_cldfra1<a name='3125'>
<a name='3126'>
<a name='3127'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3128'></font>
<font color=#447700>!..Cloud fraction scheme by G. Thompson (NCAR-RAL), not intended for<a name='3129'></font>
<font color=#447700>!.. combining with any cumulus or shallow cumulus parameterization<a name='3130'></font>
<font color=#447700>!.. scheme cloud fractions.  This is intended as a stand-alone for<a name='3131'></font>
<font color=#447700>!.. cloud fraction and is relatively good at getting widespread stratus<a name='3132'></font>
<font color=#447700>!.. and stratoCu without caring whether any deep/shallow Cu param schemes<a name='3133'></font>
<font color=#447700>!.. is making sub-grid-spacing clouds/precip.  Under the hood, this<a name='3134'></font>
<font color=#447700>!.. scheme follows Mocko and Cotton (1995) in applicaiton of the<a name='3135'></font>
<font color=#447700>!.. Sundqvist et al (1989) scheme but using a grid-scale dependent<a name='3136'></font>
<font color=#447700>!.. RH threshold, one each for land v. ocean points based on<a name='3137'></font>
<font color=#447700>!.. experiences with HWRF testing.<a name='3138'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3139'></font>
<font color=#447700>!<a name='3140'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3141'></font>
<a name='3142'>
<A NAME='CAL_CLDFRA3'><A href='../../html_code/phys/module_radiation_driver.F.html#CAL_CLDFRA3' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3143'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_cldfra3</font>(CLDFRA, qv, qc, qi, qs,                    &amp; <A href='../../call_to/CAL_CLDFRA3.html' TARGET='index'>1</A>,<A href='../../call_from/CAL_CLDFRA3.html' TARGET='index'>4</A><a name='3144'>
     &amp;                 p,t,rho, XLAND, gridkm,                          &amp;<a name='3145'>
<font color=#447700>!    &amp;                 rand_perturb_on, kme_stoch, rand_pert,           &amp;<a name='3146'></font>
     &amp;                 ids,ide, jds,jde, kds,kde,                       &amp;<a name='3147'>
     &amp;                 ims,ime, jms,jme, kms,kme,                       &amp;<a name='3148'>
     &amp;                 its,ite, jts,jte, kts,kte)<a name='3149'>
<font color=#447700>!<a name='3150'></font>
      USE <A href='../../html_code/phys/module_mp_thompson.F.html#MODULE_MP_THOMPSON'>module_mp_thompson</A><A href='../../html_code/phys/module_radiation_driver.F.html#CAL_CLDFRA3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MP_THOMPSON_3">   , ONLY : rsif, rslf<a name='3151'>
      IMPLICIT NONE<a name='3152'>
<font color=#447700>!<a name='3153'></font>
      INTEGER, INTENT(IN):: ids,ide, jds,jde, kds,kde,                  &amp;<a name='3154'>
     &amp;                      ims,ime, jms,jme, kms,kme,                  &amp;<a name='3155'>
<font color=#447700>!    &amp;                      kme_stoch,                                  &amp;<a name='3156'></font>
     &amp;                      its,ite, jts,jte, kts,kte<a name='3157'>
<a name='3158'>
<font color=#447700>!     INTEGER, INTENT(IN):: rand_perturb_on<a name='3159'></font>
      REAL, DIMENSION(ims:ime,kms:kme,jms:jme), INTENT(IN):: qv,p,t,rho<a name='3160'>
      REAL, DIMENSION(ims:ime,kms:kme,jms:jme), INTENT(INOUT):: qc,qi,qs<a name='3161'>
<font color=#447700>!     REAL, DIMENSION(ims:ime,kms:kme_stoch,jms:jme), INTENT(IN):: rand_pert<a name='3162'></font>
      REAL, DIMENSION(ims:ime,jms:jme), INTENT(IN):: XLAND<a name='3163'>
<a name='3164'>
      REAL, DIMENSION(ims:ime,kms:kme,jms:jme), INTENT(INOUT):: cldfra<a name='3165'>
      REAL, INTENT(IN):: gridkm<a name='3166'>
<a name='3167'>
<font color=#447700>!..Local vars.<a name='3168'></font>
      REAL:: RH_00L, RH_00O, RH_00, RHI_max, entrmnt<a name='3169'>
      REAL, DIMENSION(ims:ime,kms:kme,jms:jme):: qvsat<a name='3170'>
      INTEGER:: i,j,k<a name='3171'>
      REAL:: TK, TC, qvsi, qvsw, RHUM, xx, yy<a name='3172'>
      REAL, DIMENSION(kts:kte):: qvs1d, cfr1d, T1d,                     &amp;<a name='3173'>
     &amp;                           P1d, R1d, qc1d, qi1d, qs1d<a name='3174'>
<a name='3175'>
      character*512 dbg_msg<a name='3176'>
      LOGICAL:: debug_flag<a name='3177'>
<a name='3178'>
<font color=#447700>!+---+<a name='3179'></font>
<a name='3180'>
<font color=#447700>!..First cut scale-aware. Higher resolution should require closer to<a name='3181'></font>
<font color=#447700>!.. saturated grid box for higher cloud fraction.  Simple functions<a name='3182'></font>
<font color=#447700>!.. chosen based on Mocko and Cotton (1995) starting point and desire<a name='3183'></font>
<font color=#447700>!.. to get near 100% RH as grid spacing moves toward 1.0km, but higher<a name='3184'></font>
<font color=#447700>!.. RH over ocean required as compared to over land.<a name='3185'></font>
<a name='3186'>
      RH_00L = 0.7  + SQRT(1./(25.0+gridkm*gridkm*gridkm))<a name='3187'>
      RH_00O = 0.81 + SQRT(1./(50.0+gridkm*gridkm*gridkm))<a name='3188'>
<a name='3189'>
      DO j = jts,jte<a name='3190'>
      DO k = kts,kte<a name='3191'>
      DO i = its,ite<a name='3192'>
<a name='3193'>
         CLDFRA(I,K,J) = 0.0<a name='3194'>
<a name='3195'>
         if (qc(i,k,j).gt.1.E-6 .or. qi(i,k,j).ge.1.E-7 .or. qs(i,k,j).gt.1.E-5) then<a name='3196'>
            CLDFRA(I,K,J) = 1.0<a name='3197'>
            qvsat(i,k,j) = qv(i,k,j)<a name='3198'>
         else<a name='3199'>
            TK   = t(i,k,j)<a name='3200'>
            TC   = TK - 273.16<a name='3201'>
<a name='3202'>
            qvsw = <A href='../../html_code/share/dfi.F.html#RSLF'>rslf</A><A href='../../html_code/phys/module_radiation_driver.F.html#CAL_CLDFRA3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSLF_4">(P(i,k,j), TK)<a name='3203'>
            qvsi = <A href='../../html_code/share/dfi.F.html#RSIF'>rsif</A><A href='../../html_code/phys/module_radiation_driver.F.html#CAL_CLDFRA3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSIF_2">(P(i,k,j), TK)<a name='3204'>
<a name='3205'>
            if (tc .ge. -12.0) then<a name='3206'>
               qvsat(i,k,j) = qvsw<a name='3207'>
            elseif (tc .lt. -20.0) then<a name='3208'>
               qvsat(i,k,j) = qvsi<a name='3209'>
            else<a name='3210'>
               qvsat(i,k,j) = qvsw - (qvsw-qvsi)*(-12.0-tc)/(-12.0+20.)<a name='3211'>
            endif<a name='3212'>
            RHUM = MAX(0.01, MIN(qv(i,k,j)/qvsat(i,k,j), 0.9999))<a name='3213'>
<a name='3214'>
            IF ((XLAND(I,J)-1.5).GT.0.) THEN                             <font color=#447700>!--- Ocean<a name='3215'></font>
               RH_00 = RH_00O<a name='3216'>
            ELSE                                                         <font color=#447700>!--- Land<a name='3217'></font>
               RH_00 = RH_00L<a name='3218'>
            ENDIF<a name='3219'>
<a name='3220'>
            if (tc .ge. -12.0) then<a name='3221'>
               RHUM = MIN(0.999, RHUM)<a name='3222'>
               CLDFRA(I,K,J) = MAX(0.0, 1.0-SQRT((1.0-RHUM)/(1.-RH_00)))<a name='3223'>
            elseif (tc.lt.-12..and.tc.gt.-70. .and. RHUM.gt.RH_00L) then<a name='3224'>
               RHUM = MAX(0.01, MIN(qv(i,k,j)/qvsat(i,k,j), 1.0 - 1.E-6))<a name='3225'>
               CLDFRA(I,K,J) = MAX(0., 1.0-SQRT((1.0-RHUM)/(1.0-RH_00L)))<a name='3226'>
            endif<a name='3227'>
            CLDFRA(I,K,J) = MIN(0.90, CLDFRA(I,K,J))<a name='3228'>
<a name='3229'>
         endif<a name='3230'>
      ENDDO<a name='3231'>
      ENDDO<a name='3232'>
      ENDDO<a name='3233'>
<a name='3234'>
<font color=#447700>!..Prepare for a 1-D column to find various cloud layers.<a name='3235'></font>
<a name='3236'>
      DO j = jts,jte<a name='3237'>
      DO i = its,ite<a name='3238'>
<font color=#447700>!        if (i.gt.10.and.i.le.20 .and. j.gt.10.and.j.le.20) then<a name='3239'></font>
<font color=#447700>!          debug_flag = .true.<a name='3240'></font>
<font color=#447700>!        else<a name='3241'></font>
<font color=#447700>!           debug_flag = .false.<a name='3242'></font>
<font color=#447700>!        endif<a name='3243'></font>
<a name='3244'>
<font color=#447700>!        if (rand_perturb_on .eq. 1) then<a name='3245'></font>
<font color=#447700>!           entrmnt = MAX(0.01, MIN(0.99, 0.5 + rand_pert(i,1,j)*0.5))<a name='3246'></font>
<font color=#447700>!        else<a name='3247'></font>
            entrmnt = 0.5<a name='3248'>
<font color=#447700>!        endif<a name='3249'></font>
<a name='3250'>
         DO k = kts,kte<a name='3251'>
            qvs1d(k) = qvsat(i,k,j)<a name='3252'>
            cfr1d(k) = cldfra(i,k,j)<a name='3253'>
            T1d(k) = t(i,k,j)<a name='3254'>
            P1d(k) = p(i,k,j)<a name='3255'>
            R1d(k) = rho(i,k,j)<a name='3256'>
            qc1d(k) = qc(i,k,j)<a name='3257'>
            qi1d(k) = qi(i,k,j)<a name='3258'>
            qs1d(k) = qs(i,k,j)<a name='3259'>
         ENDDO<a name='3260'>
<a name='3261'>
<font color=#447700>!     if (debug_flag) then<a name='3262'></font>
<font color=#447700>!       WRITE (dbg_msg,*) 'DEBUG-GT: finding cloud layers at point  (', i, ', ', j, ')'<a name='3263'></font>
<font color=#447700>!       CALL wrf_debug (150, dbg_msg)<a name='3264'></font>
<font color=#447700>!     endif<a name='3265'></font>
         call <A href='../../html_code/phys/module_radiation_driver.F.html#FIND_CLOUDLAYERS'>find_cloudLayers</A><A href='../../html_code/phys/module_radiation_driver.F.html#CAL_CLDFRA3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_CLOUDLAYERS_1">(qvs1d, cfr1d, T1d, P1d, R1d, entrmnt,    &amp;<a name='3266'>
     &amp;                         debug_flag, qc1d, qi1d, qs1d, kts,kte)<a name='3267'>
<a name='3268'>
         DO k = kts,kte<a name='3269'>
            cldfra(i,k,j) = cfr1d(k)<a name='3270'>
            qc(i,k,j) = qc1d(k)<a name='3271'>
            qi(i,k,j) = qi1d(k)<a name='3272'>
         ENDDO<a name='3273'>
      ENDDO<a name='3274'>
      ENDDO<a name='3275'>
<a name='3276'>
<a name='3277'>
      END SUBROUTINE cal_cldfra3<a name='3278'>
<a name='3279'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3280'></font>
<font color=#447700>!..From cloud fraction array, find clouds of multi-level depth and compute<a name='3281'></font>
<font color=#447700>!.. a reasonable value of LWP or IWP that might be contained in that depth,<a name='3282'></font>
<font color=#447700>!.. unless existing LWC/IWC is already there.<a name='3283'></font>
<a name='3284'>
<A NAME='FIND_CLOUDLAYERS'><A href='../../html_code/phys/module_radiation_driver.F.html#FIND_CLOUDLAYERS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3285'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>find_cloudLayers</font>(qvs1d, cfr1d, T1d, P1d, R1d, entrmnt, &amp; <A href='../../call_to/FIND_CLOUDLAYERS.html' TARGET='index'>1</A>,<A href='../../call_from/FIND_CLOUDLAYERS.html' TARGET='index'>5</A><a name='3286'>
     &amp;                            debugfl, qc1d, qi1d, qs1d, kts,kte)<a name='3287'>
<font color=#447700>!<a name='3288'></font>
      IMPLICIT NONE<a name='3289'>
<font color=#447700>!<a name='3290'></font>
      INTEGER, INTENT(IN):: kts, kte<a name='3291'>
      LOGICAL, INTENT(IN):: debugfl<a name='3292'>
      REAL, INTENT(IN):: entrmnt<a name='3293'>
      REAL, DIMENSION(kts:kte), INTENT(IN):: qvs1d,T1d,P1d,R1d<a name='3294'>
      REAL, DIMENSION(kts:kte), INTENT(INOUT):: cfr1d<a name='3295'>
      REAL, DIMENSION(kts:kte), INTENT(INOUT):: qc1d, qi1d, qs1d<a name='3296'>
<a name='3297'>
<font color=#447700>!..Local vars.<a name='3298'></font>
      REAL, DIMENSION(kts:kte):: theta, dz<a name='3299'>
      REAL:: Z1, Z2, theta1, theta2, ht1, ht2<a name='3300'>
      INTEGER:: k, k2, k_tropo, k_m12C, k_m40C, k_cldb, k_cldt, kbot<a name='3301'>
      LOGICAL:: in_cloud<a name='3302'>
      character*512 dbg_msg<a name='3303'>
<a name='3304'>
<font color=#447700>!+---+<a name='3305'></font>
<a name='3306'>
      k_m12C = 0<a name='3307'>
      k_m40C = 0<a name='3308'>
      DO k = kte, kts, -1<a name='3309'>
         theta(k) = T1d(k)*((100000.0/P1d(k))**(287.05/1004.))<a name='3310'>
         if (T1d(k)-273.16 .gt. -40.0 .and. P1d(k).gt.7000.0) k_m40C = MAX(k_m40C, k)<a name='3311'>
         if (T1d(k)-273.16 .gt. -12.0 .and. P1d(k).gt.10000.0) k_m12C = MAX(k_m12C, k)<a name='3312'>
      ENDDO<a name='3313'>
      if (k_m40C .le. kts) k_m40C = kts<a name='3314'>
      if (k_m12C .le. kts) k_m12C = kts<a name='3315'>
<a name='3316'>
      Z2 = 44307.692 * (1.0 - (P1d(kte)/101325.)**0.190)<a name='3317'>
      DO k = kte-1, kts, -1<a name='3318'>
         Z1 = 44307.692 * (1.0 - (P1d(k)/101325.)**0.190)<a name='3319'>
         dz(k+1) = Z2 - Z1<a name='3320'>
         Z2 = Z1<a name='3321'>
      ENDDO<a name='3322'>
      dz(kts) = dz(kts+1)<a name='3323'>
<a name='3324'>
<font color=#447700>!..Find tropopause height, best surrogate, because we would not really<a name='3325'></font>
<font color=#447700>!.. wish to put fake clouds into the stratosphere.  The 10/1500 ratio<a name='3326'></font>
<font color=#447700>!.. d(Theta)/d(Z) approximates a vertical line on typical SkewT chart<a name='3327'></font>
<font color=#447700>!.. near typical (mid-latitude) tropopause height.  Since messy data<a name='3328'></font>
<font color=#447700>!.. could give us a false signal of such a transition, do the check over <a name='3329'></font>
<font color=#447700>!.. three K-level change, not just a level-to-level check.  This method<a name='3330'></font>
<font color=#447700>!.. has potential failure in arctic-like conditions with extremely low<a name='3331'></font>
<font color=#447700>!.. tropopause height, as would any other diagnostic, so ensure resulting<a name='3332'></font>
<font color=#447700>!.. k_tropo level is above 4km.<a name='3333'></font>
<a name='3334'>
      DO k = kte-3, kts, -1<a name='3335'>
         theta1 = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_radiation_driver.F.html#FIND_CLOUDLAYERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_23">(k)<a name='3336'>
         theta2 = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_radiation_driver.F.html#FIND_CLOUDLAYERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_24">(k+2)<a name='3337'>
         ht1 = 44307.692 * (1.0 - (P1d(k)/101325.)**0.190)<a name='3338'>
         ht2 = 44307.692 * (1.0 - (P1d(k+2)/101325.)**0.190)<a name='3339'>
         if ( (((theta2-theta1)/(ht2-ht1)) .lt. 10./1500. ) .AND.       &amp;<a name='3340'>
     &amp;                       (ht1.lt.19000.) .and. (ht1.gt.4000.) ) then <a name='3341'>
            goto 86<a name='3342'>
         endif<a name='3343'>
      ENDDO<a name='3344'>
 86   continue<a name='3345'>
      k_tropo = MAX(kts+2, k+2)<a name='3346'>
<a name='3347'>
<font color=#447700>!     if (debugfl) then<a name='3348'></font>
<font color=#447700>!     print*, ' FOUND TROPOPAUSE ', k_tropo, ' near ', ht2, ' m'<a name='3349'></font>
<font color=#447700>!       WRITE (dbg_msg,*) 'DEBUG-GT: FOUND TROPOPAUSE ', k_tropo, ' near ', ht2, ' m'<a name='3350'></font>
<font color=#447700>!       CALL wrf_debug (150, dbg_msg)<a name='3351'></font>
<font color=#447700>!     endif<a name='3352'></font>
<a name='3353'>
<font color=#447700>!..Eliminate possible fractional clouds above supposed tropopause.<a name='3354'></font>
      DO k = k_tropo+1, kte<a name='3355'>
         if (cfr1d(k).gt.0.0 .and. cfr1d(k).lt.0.999) then<a name='3356'>
            cfr1d(k) = 0.<a name='3357'>
         endif<a name='3358'>
      ENDDO<a name='3359'>
<a name='3360'>
<font color=#447700>!..We would like to prevent fractional clouds below LCL in idealized<a name='3361'></font>
<font color=#447700>!.. situation with deep well-mixed convective PBL, that otherwise is<a name='3362'></font>
<font color=#447700>!.. likely to get clouds in more realistic capping inversion layer.<a name='3363'></font>
<a name='3364'>
      kbot = kts+2<a name='3365'>
      DO k = kbot, k_m12C<a name='3366'>
         if ( (theta(k)-theta(k-1)) .gt. 0.05E-3*dz(k)) EXIT<a name='3367'>
      ENDDO<a name='3368'>
      kbot = MAX(kts+1, k-2)<a name='3369'>
      DO k = kts, kbot<a name='3370'>
         if (cfr1d(k).gt.0.0 .and. cfr1d(k).lt.0.999) cfr1d(k) = 0.<a name='3371'>
      ENDDO<a name='3372'>
<a name='3373'>
<a name='3374'>
<font color=#447700>!..Starting below tropo height, if cloud fraction greater than 1 percent,<a name='3375'></font>
<font color=#447700>!.. compute an approximate total layer depth of cloud, determine a total <a name='3376'></font>
<font color=#447700>!.. liquid water/ice path (LWP/IWP), then reduce that amount with tuning <a name='3377'></font>
<font color=#447700>!.. parameter to represent entrainment factor, then divide up LWP/IWP<a name='3378'></font>
<font color=#447700>!.. into delta-Z weighted amounts for individual levels per cloud layer. <a name='3379'></font>
<a name='3380'>
      k_cldb = k_tropo<a name='3381'>
      in_cloud = .false.<a name='3382'>
      k = k_tropo<a name='3383'>
      DO WHILE (.not. in_cloud .AND. k.gt.k_m12C)<a name='3384'>
         k_cldt = 0<a name='3385'>
         if (cfr1d(k).ge.0.01) then<a name='3386'>
            in_cloud = .true.<a name='3387'>
            k_cldt = MAX(k_cldt, k)<a name='3388'>
         endif<a name='3389'>
         if (in_cloud) then<a name='3390'>
            DO k2 = k_cldt-1, k_m12C, -1<a name='3391'>
               if (cfr1d(k2).lt.0.01 .or. k2.eq.k_m12C) then<a name='3392'>
                  k_cldb = k2+1<a name='3393'>
                  goto 87<a name='3394'>
               endif<a name='3395'>
            ENDDO<a name='3396'>
 87         continue<a name='3397'>
            in_cloud = .false.<a name='3398'>
         endif<a name='3399'>
         if ((k_cldt - k_cldb + 1) .ge. 2) then<a name='3400'>
<font color=#447700>!     if (debugfl) then<a name='3401'></font>
<font color=#447700>!           print*, 'An ice cloud layer is found between ', k_cldt, k_cldb, P1d(k_cldt)*0.01, P1d(k_cldb)*0.01<a name='3402'></font>
<font color=#447700>!       WRITE (dbg_msg,*) 'DEBUG-GT: An ice cloud layer is found between ', k_cldt, k_cldb, P1d(k_cldt)*0.01, P1d(k_cldb)*0.01<a name='3403'></font>
<font color=#447700>!       CALL wrf_debug (150, dbg_msg)<a name='3404'></font>
<font color=#447700>!     endif<a name='3405'></font>
            call <A href='../../html_code/phys/module_radiation_driver.F.html#ADJUST_CLOUDICE'>adjust_cloudIce</A><A href='../../html_code/phys/module_radiation_driver.F.html#FIND_CLOUDLAYERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_CLOUDICE_1">(cfr1d, qi1d, qs1d, qvs1d, T1d,R1d,dz,  &amp;<a name='3406'>
     &amp;                           entrmnt, k_cldb,k_cldt,kts,kte)<a name='3407'>
            k = k_cldb<a name='3408'>
         else<a name='3409'>
            if (cfr1d(k_cldb).gt.0.and.qi1d(k_cldb).lt.1.E-6)           &amp;<a name='3410'>
     &amp;               qi1d(k_cldb)=1.E-5*cfr1d(k_cldb)<a name='3411'>
         endif<a name='3412'>
         k = k - 1<a name='3413'>
      ENDDO<a name='3414'>
<a name='3415'>
<a name='3416'>
      k_cldb = k_tropo<a name='3417'>
      in_cloud = .false.<a name='3418'>
      k = k_m12C + 2<a name='3419'>
      DO WHILE (.not. in_cloud .AND. k.gt.kbot)<a name='3420'>
         k_cldt = 0<a name='3421'>
         if (cfr1d(k).ge.0.01) then<a name='3422'>
            in_cloud = .true.<a name='3423'>
            k_cldt = MAX(k_cldt, k)<a name='3424'>
         endif<a name='3425'>
         if (in_cloud) then<a name='3426'>
            DO k2 = k_cldt-1, kbot, -1<a name='3427'>
               if (cfr1d(k2).lt.0.01 .or. k2.eq.kbot) then<a name='3428'>
                  k_cldb = k2+1<a name='3429'>
                  goto 88<a name='3430'>
               endif<a name='3431'>
            ENDDO<a name='3432'>
 88         continue<a name='3433'>
            in_cloud = .false.<a name='3434'>
         endif<a name='3435'>
         if ((k_cldt - k_cldb + 1) .ge. 2) then<a name='3436'>
<font color=#447700>!     if (debugfl) then<a name='3437'></font>
<font color=#447700>!           print*, 'A water cloud layer is found between ', k_cldt, k_cldb, P1d(k_cldt)*0.01, P1d(k_cldb)*0.01<a name='3438'></font>
<font color=#447700>!       WRITE (dbg_msg,*) 'DEBUG-GT: A water cloud layer is found between ', k_cldt, k_cldb, P1d(k_cldt)*0.01, P1d(k_cldb)*0.01<a name='3439'></font>
<font color=#447700>!       CALL wrf_debug (150, dbg_msg)<a name='3440'></font>
<font color=#447700>!     endif<a name='3441'></font>
            call <A href='../../html_code/phys/module_radiation_driver.F.html#ADJUST_CLOUDH2O'>adjust_cloudH2O</A><A href='../../html_code/phys/module_radiation_driver.F.html#FIND_CLOUDLAYERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_CLOUDH2O_1">(cfr1d, qc1d, qvs1d, T1d,R1d,dz,        &amp;<a name='3442'>
     &amp;                           entrmnt, k_cldb,k_cldt,kts,kte)<a name='3443'>
            k = k_cldb<a name='3444'>
         else<a name='3445'>
            if (cfr1d(k_cldb).gt.0.and.qc1d(k_cldb).lt.1.E-6)           &amp;<a name='3446'>
     &amp;               qc1d(k_cldb)=1.E-5*cfr1d(k_cldb)<a name='3447'>
         endif<a name='3448'>
         k = k - 1<a name='3449'>
      ENDDO<a name='3450'>
<a name='3451'>
<font color=#447700>!..Do a final total column adjustment since we may have added more than 1mm<a name='3452'></font>
<font color=#447700>!.. LWP/IWP for multiple cloud decks.<a name='3453'></font>
<a name='3454'>
      call <A href='../../html_code/phys/module_radiation_driver.F.html#ADJUST_CLOUDFINAL'>adjust_cloudFinal</A><A href='../../html_code/phys/module_radiation_driver.F.html#FIND_CLOUDLAYERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_CLOUDFINAL_1">(cfr1d, qc1d, qi1d, R1d,dz, kts,kte,k_tropo)<a name='3455'>
<a name='3456'>
<font color=#447700>!     if (debugfl) then<a name='3457'></font>
<font color=#447700>!     print*, ' Made-up fake profile of clouds'<a name='3458'></font>
<font color=#447700>!     do k = kte, kts, -1<a name='3459'></font>
<font color=#447700>!        write(*,'(i3, 2x, f8.2, 2x, f9.2, 2x, f6.2, 2x,  f15.7, 2x, f15.7)') &amp;<a name='3460'></font>
<font color=#447700>!    &amp;        K, T1d(k)-273.15, P1d(k)*0.01, cfr1d(k)*100., qc1d(k)*1000.,qi1d(k)*1000.<a name='3461'></font>
<font color=#447700>!     enddo<a name='3462'></font>
<font color=#447700>!       WRITE (dbg_msg,*) 'DEBUG-GT:  Made-up fake profile of clouds'<a name='3463'></font>
<font color=#447700>!       CALL wrf_debug (150, dbg_msg)<a name='3464'></font>
<font color=#447700>!       do k = kte, kts, -1<a name='3465'></font>
<font color=#447700>!          write(dbg_msg,'(f8.2, 2x, f9.2, 2x, f6.2, 2x,  f15.7, 2x, f15.7)') &amp;<a name='3466'></font>
<font color=#447700>!    &amp;          T1d(k)-273.15, P1d(k)*0.01, cfr1d(k)*100., qc1d(k)*1000.,qi1d(k)*1000.<a name='3467'></font>
<font color=#447700>!          CALL wrf_debug (150, dbg_msg)<a name='3468'></font>
<font color=#447700>!       enddo<a name='3469'></font>
<font color=#447700>!     endif<a name='3470'></font>
<a name='3471'>
<a name='3472'>
      END SUBROUTINE find_cloudLayers<a name='3473'>
<a name='3474'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3475'></font>
<a name='3476'>
<A NAME='ADJUST_CLOUDICE'><A href='../../html_code/phys/module_radiation_driver.F.html#ADJUST_CLOUDICE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3477'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_cloudIce</font>(cfr,qi,qs,qvs, T,Rho,dz, entr, k1,k2,kts,kte) <A href='../../call_to/ADJUST_CLOUDICE.html' TARGET='index'>1</A><a name='3478'>
<font color=#447700>!<a name='3479'></font>
      IMPLICIT NONE<a name='3480'>
<font color=#447700>!<a name='3481'></font>
      INTEGER, INTENT(IN):: k1,k2, kts,kte<a name='3482'>
      REAL, INTENT(IN):: entr<a name='3483'>
      REAL, DIMENSION(kts:kte), INTENT(IN):: cfr, qvs, T, Rho, dz<a name='3484'>
      REAL, DIMENSION(kts:kte), INTENT(INOUT):: qi, qs<a name='3485'>
      REAL:: iwc, max_iwc, tdz, this_iwc, this_dz, iwp_exists<a name='3486'>
      INTEGER:: k, kmid<a name='3487'>
<a name='3488'>
      tdz = 0.<a name='3489'>
      do k = k1, k2<a name='3490'>
         tdz = tdz + dz(k)<a name='3491'>
      enddo<a name='3492'>
      kmid = NINT(0.5*(k1+k2))<a name='3493'>
      max_iwc = ABS(qvs(k2-1)-qvs(k1))<a name='3494'>
<font color=#447700>!     print*, ' max_iwc = ', max_iwc, ' over DZ=',tdz<a name='3495'></font>
<a name='3496'>
      iwp_exists = 0.<a name='3497'>
      do k = k1, k2<a name='3498'>
         iwp_exists = iwp_exists + (qi(k)+qs(k))*Rho(k)*dz(k)<a name='3499'>
      enddo<a name='3500'>
<a name='3501'>
      this_dz = 0.0<a name='3502'>
      do k = k1, k2<a name='3503'>
         if (k.eq.k1) then<a name='3504'>
            this_dz = this_dz + 0.5*dz(k)<a name='3505'>
         else<a name='3506'>
            this_dz = this_dz + dz(k)<a name='3507'>
         endif<a name='3508'>
         this_iwc = max_iwc*this_dz/tdz<a name='3509'>
         iwc = MAX(1.E-6, this_iwc*(1.-entr))<a name='3510'>
         if (cfr(k).gt.0.01.and.cfr(k).lt.0.99.and.T(k).ge.203.16) then<a name='3511'>
            qi(k) = qi(k) + 0.1*cfr(k)*iwc<a name='3512'>
         elseif (qi(k).lt.1.E-5.and.cfr(k).ge.0.99.and.T(k).ge.203.16) then<a name='3513'>
            qi(k) = qi(k) + 0.01*iwc<a name='3514'>
         endif<a name='3515'>
      enddo<a name='3516'>
<a name='3517'>
      END SUBROUTINE adjust_cloudIce<a name='3518'>
<a name='3519'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3520'></font>
<a name='3521'>
<A NAME='ADJUST_CLOUDH2O'><A href='../../html_code/phys/module_radiation_driver.F.html#ADJUST_CLOUDH2O' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3522'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_cloudH2O</font>(cfr, qc, qvs, T,Rho,dz, entr, k1,k2,kts,kte) <A href='../../call_to/ADJUST_CLOUDH2O.html' TARGET='index'>1</A><a name='3523'>
<font color=#447700>!<a name='3524'></font>
      IMPLICIT NONE<a name='3525'>
<font color=#447700>!<a name='3526'></font>
      INTEGER, INTENT(IN):: k1,k2, kts,kte<a name='3527'>
      REAL, INTENT(IN):: entr<a name='3528'>
      REAL, DIMENSION(kts:kte):: cfr, qc, qvs, T, Rho, dz<a name='3529'>
      REAL:: lwc, max_lwc, tdz, this_lwc, this_dz, lwp_exists<a name='3530'>
      INTEGER:: k, kmid<a name='3531'>
<a name='3532'>
      tdz = 0.<a name='3533'>
      do k = k1, k2<a name='3534'>
         tdz = tdz + dz(k)<a name='3535'>
      enddo<a name='3536'>
      kmid = NINT(0.5*(k1+k2))<a name='3537'>
      max_lwc = ABS(qvs(k2-1)-qvs(k1))<a name='3538'>
<font color=#447700>!     print*, ' max_lwc = ', max_lwc, ' over DZ=',tdz<a name='3539'></font>
<a name='3540'>
      lwp_exists = 0.<a name='3541'>
      do k = k1, k2<a name='3542'>
         lwp_exists = lwp_exists + qc(k)*Rho(k)*dz(k)<a name='3543'>
      enddo<a name='3544'>
<a name='3545'>
      this_dz = 0.0<a name='3546'>
      do k = k1, k2<a name='3547'>
         if (k.eq.k1) then<a name='3548'>
            this_dz = this_dz + 0.5*dz(k)<a name='3549'>
         else<a name='3550'>
            this_dz = this_dz + dz(k)<a name='3551'>
         endif<a name='3552'>
         this_lwc = max_lwc*this_dz/tdz<a name='3553'>
         lwc = MAX(1.E-6, this_lwc*(1.-entr))<a name='3554'>
         if (cfr(k).gt.0.01.and.cfr(k).lt.0.99.and.T(k).lt.298.16.and.T(k).ge.253.16) then<a name='3555'>
            qc(k) = qc(k) + cfr(k)*cfr(k)*lwc<a name='3556'>
         elseif (cfr(k).ge.0.99.and.qc(k).lt.1.E-5.and.T(k).lt.298.16.and.T(k).ge.253.16) then<a name='3557'>
            qc(k) = qc(k) + 0.1*lwc<a name='3558'>
         endif<a name='3559'>
      enddo<a name='3560'>
<a name='3561'>
      END SUBROUTINE adjust_cloudH2O<a name='3562'>
<a name='3563'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3564'></font>
<a name='3565'>
<font color=#447700>!..Do not alter any grid-explicitly resolved hydrometeors, rather only<a name='3566'></font>
<font color=#447700>!.. the supposed amounts due to the cloud fraction scheme.<a name='3567'></font>
<a name='3568'>
<A NAME='ADJUST_CLOUDFINAL'><A href='../../html_code/phys/module_radiation_driver.F.html#ADJUST_CLOUDFINAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3569'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_cloudFinal</font>(cfr, qc, qi, Rho,dz, kts,kte,k_tropo) <A href='../../call_to/ADJUST_CLOUDFINAL.html' TARGET='index'>1</A><a name='3570'>
<font color=#447700>!<a name='3571'></font>
      IMPLICIT NONE<a name='3572'>
<font color=#447700>!<a name='3573'></font>
      INTEGER, INTENT(IN):: kts,kte,k_tropo<a name='3574'>
      REAL, DIMENSION(kts:kte), INTENT(IN):: cfr, Rho, dz<a name='3575'>
      REAL, DIMENSION(kts:kte), INTENT(INOUT):: qc, qi<a name='3576'>
      REAL:: lwp, iwp, xfac<a name='3577'>
      INTEGER:: k<a name='3578'>
<a name='3579'>
      lwp = 0.<a name='3580'>
      iwp = 0.<a name='3581'>
      do k = kts, k_tropo<a name='3582'>
         if (cfr(k).gt.0.0) then<a name='3583'>
            lwp = lwp + qc(k)*Rho(k)*dz(k)<a name='3584'>
            iwp = iwp + qi(k)*Rho(k)*dz(k)<a name='3585'>
         endif<a name='3586'>
      enddo<a name='3587'>
<a name='3588'>
      if (lwp .gt. 1.5) then<a name='3589'>
         xfac = 1./lwp<a name='3590'>
         do k = kts, k_tropo<a name='3591'>
            if (cfr(k).gt.0.01 .and. cfr(k).lt.0.99) then<a name='3592'>
               qc(k) = qc(k)*xfac<a name='3593'>
            endif<a name='3594'>
         enddo<a name='3595'>
      endif<a name='3596'>
<a name='3597'>
      if (iwp .gt. 1.5) then<a name='3598'>
         xfac = 1./iwp<a name='3599'>
         do k = kts, k_tropo<a name='3600'>
            if (cfr(k).gt.0.01 .and. cfr(k).lt.0.99) then<a name='3601'>
               qi(k) = qi(k)*xfac<a name='3602'>
            endif<a name='3603'>
         enddo<a name='3604'>
      endif<a name='3605'>
<a name='3606'>
      END SUBROUTINE adjust_cloudFinal<a name='3607'>
<a name='3608'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3609'></font>
<a name='3610'>
<A NAME='TOPOSHAD_INIT'><A href='../../html_code/phys/module_radiation_driver.F.html#TOPOSHAD_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3611'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>toposhad_init</font>(ht_shad,ht_loc,shadowmask,nested,iter,   &amp; <A href='../../call_to/TOPOSHAD_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/TOPOSHAD_INIT.html' TARGET='index'>1</A><a name='3612'>
                       ids,ide, jds,jde, kds,kde,                    &amp; <a name='3613'>
                       ims,ime, jms,jme, kms,kme,                    &amp;<a name='3614'>
                       ips,ipe, jps,jpe, kps,kpe,                    &amp;<a name='3615'>
                       its,ite, jts,jte, kts,kte                     )<a name='3616'>
<a name='3617'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_radiation_driver.F.html#TOPOSHAD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_89"><a name='3618'>
<a name='3619'>
 implicit none<a name='3620'>
<a name='3621'>
   INTEGER,    INTENT(IN) ::           ids,ide, jds,jde, kds,kde, &amp;<a name='3622'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='3623'>
                                       ips,ipe, jps,jpe, kps,kpe, &amp;<a name='3624'>
                                       its,ite, jts,jte, kts,kte<a name='3625'>
<a name='3626'>
   LOGICAL, INTENT(IN)      :: nested<a name='3627'>
<a name='3628'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)  ::  ht_shad, ht_loc<a name='3629'>
<a name='3630'>
   INTEGER, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)  :: shadowmask<a name='3631'>
   INTEGER, INTENT(IN)      :: iter<a name='3632'>
<a name='3633'>
<font color=#447700>! Local variables<a name='3634'></font>
<a name='3635'>
   INTEGER :: i, j<a name='3636'>
<a name='3637'>
 if (iter.eq.1) then<a name='3638'>
<a name='3639'>
<font color=#447700>! Initialize shadow mask<a name='3640'></font>
   do j=jts,jte<a name='3641'>
   do i=its,ite<a name='3642'>
     shadowmask(i,j) = 0<a name='3643'>
   ENDDO<a name='3644'>
   ENDDO<a name='3645'>
<a name='3646'>
<font color=#447700>! Initialize shading height <a name='3647'></font>
<a name='3648'>
   IF ( nested ) THEN  <font color=#447700>! Do not overwrite input from parent domain<a name='3649'></font>
     do j=max(jts,jds+2),min(jte,jde-3)<a name='3650'>
     do i=max(its,ids+2),min(ite,ide-3)<a name='3651'>
       ht_shad(i,j) = ht_loc(i,j)-0.001<a name='3652'>
     ENDDO<a name='3653'>
     ENDDO<a name='3654'>
   ELSE<a name='3655'>
     do j=jts,jte<a name='3656'>
     do i=its,ite<a name='3657'>
       ht_shad(i,j) = ht_loc(i,j)-0.001<a name='3658'>
     ENDDO<a name='3659'>
     ENDDO<a name='3660'>
   ENDIF<a name='3661'>
<a name='3662'>
   IF ( nested ) THEN  <font color=#447700>! Check if a shadow exceeding the topography height is available at the lateral domain edge from nesting<a name='3663'></font>
     if (its.eq.ids) then<a name='3664'>
       do j=jts,jte<a name='3665'>
         if (ht_shad(its,j) .gt. ht_loc(its,j)) then<a name='3666'>
           shadowmask(its,j) = 1<a name='3667'>
           ht_loc(its,j) = ht_shad(its,j)<a name='3668'>
         endif<a name='3669'>
         if (ht_shad(its+1,j) .gt. ht_loc(its+1,j)) then<a name='3670'>
           shadowmask(its+1,j) = 1<a name='3671'>
           ht_loc(its+1,j) = ht_shad(its+1,j)<a name='3672'>
         endif<a name='3673'>
       enddo<a name='3674'>
     endif<a name='3675'>
     if (ite.eq.ide-1) then<a name='3676'>
       do j=jts,jte<a name='3677'>
         if (ht_shad(ite,j) .gt. ht_loc(ite,j)) then<a name='3678'>
           shadowmask(ite,j) = 1<a name='3679'>
           ht_loc(ite,j) = ht_shad(ite,j)<a name='3680'>
         endif<a name='3681'>
         if (ht_shad(ite-1,j) .gt. ht_loc(ite-1,j)) then<a name='3682'>
           shadowmask(ite-1,j) = 1<a name='3683'>
           ht_loc(ite-1,j) = ht_shad(ite-1,j)<a name='3684'>
         endif<a name='3685'>
       enddo<a name='3686'>
     endif<a name='3687'>
     if (jts.eq.jds) then<a name='3688'>
       do i=its,ite<a name='3689'>
         if (ht_shad(i,jts) .gt. ht_loc(i,jts)) then<a name='3690'>
           shadowmask(i,jts) = 1<a name='3691'>
           ht_loc(i,jts) = ht_shad(i,jts)<a name='3692'>
         endif<a name='3693'>
         if (ht_shad(i,jts+1) .gt. ht_loc(i,jts+1)) then<a name='3694'>
           shadowmask(i,jts+1) = 1<a name='3695'>
           ht_loc(i,jts+1) = ht_shad(i,jts+1)<a name='3696'>
         endif<a name='3697'>
       enddo<a name='3698'>
     endif<a name='3699'>
     if (jte.eq.jde-1) then<a name='3700'>
       do i=its,ite<a name='3701'>
         if (ht_shad(i,jte) .gt. ht_loc(i,jte)) then<a name='3702'>
           shadowmask(i,jte) = 1<a name='3703'>
           ht_loc(i,jte) = ht_shad(i,jte)<a name='3704'>
         endif<a name='3705'>
         if (ht_shad(i,jte-1) .gt. ht_loc(i,jte-1)) then<a name='3706'>
           shadowmask(i,jte-1) = 1<a name='3707'>
           ht_loc(i,jte-1) = ht_shad(i,jte-1)<a name='3708'>
         endif<a name='3709'>
       enddo<a name='3710'>
     endif<a name='3711'>
   ENDIF<a name='3712'>
<a name='3713'>
 else<a name='3714'>
<a name='3715'>
<font color=#447700>! Fill the local topography field at the points next to internal tile boundaries with ht_shad values<a name='3716'></font>
<font color=#447700>! A 2-pt halo has been applied to the ht_shad before the repeated call of this subroutine<a name='3717'></font>
<a name='3718'>
   if ((its.ne.ids).and.(its.eq.ips)) then<a name='3719'>
     do j=jts-2,jte+2<a name='3720'>
       ht_loc(its-1,j) = max(ht_loc(its-1,j),ht_shad(its-1,j))<a name='3721'>
       ht_loc(its-2,j) = max(ht_loc(its-2,j),ht_shad(its-2,j))<a name='3722'>
     enddo<a name='3723'>
   endif<a name='3724'>
   if ((ite.ne.ide-1).and.(ite.eq.ipe)) then<a name='3725'>
     do j=jts-2,jte+2<a name='3726'>
       ht_loc(ite+1,j) = max(ht_loc(ite+1,j),ht_shad(ite+1,j))<a name='3727'>
       ht_loc(ite+2,j) = max(ht_loc(ite+2,j),ht_shad(ite+2,j))<a name='3728'>
     enddo<a name='3729'>
   endif<a name='3730'>
   if ((jts.ne.jds).and.(jts.eq.jps)) then<a name='3731'>
     do i=its-2,ite+2<a name='3732'>
       ht_loc(i,jts-1) = max(ht_loc(i,jts-1),ht_shad(i,jts-1))<a name='3733'>
       ht_loc(i,jts-2) = max(ht_loc(i,jts-2),ht_shad(i,jts-2))<a name='3734'>
     enddo<a name='3735'>
   endif<a name='3736'>
   if ((jte.ne.jde-1).and.(jte.eq.jpe)) then<a name='3737'>
     do i=its-2,ite+2<a name='3738'>
       ht_loc(i,jte+1) = max(ht_loc(i,jte+1),ht_shad(i,jte+1))<a name='3739'>
       ht_loc(i,jte+2) = max(ht_loc(i,jte+2),ht_shad(i,jte+2))<a name='3740'>
     enddo<a name='3741'>
   endif<a name='3742'>
<a name='3743'>
 endif<a name='3744'>
<a name='3745'>
   END SUBROUTINE toposhad_init<a name='3746'>
<a name='3747'>
<A NAME='TOPOSHAD'><A href='../../html_code/phys/module_radiation_driver.F.html#TOPOSHAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3748'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>toposhad</font>(xlat,xlong,sina,cosa,xtime,gmt,radfrq,declin, &amp; <A href='../../call_to/TOPOSHAD.html' TARGET='index'>1</A>,<A href='../../call_from/TOPOSHAD.html' TARGET='index'>1</A><a name='3749'>
                       dx,dy,ht_shad,ht_loc,iter,                    &amp;<a name='3750'>
                       shadowmask,shadlen,                    &amp;<a name='3751'>
                       ids,ide, jds,jde, kds,kde,                    &amp; <a name='3752'>
                       ims,ime, jms,jme, kms,kme,                    &amp;<a name='3753'>
                       ips,ipe, jps,jpe, kps,kpe,                    &amp;<a name='3754'>
                       its,ite, jts,jte, kts,kte                     )<a name='3755'>
<a name='3756'>
<a name='3757'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_radiation_driver.F.html#TOPOSHAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_90"><a name='3758'>
<a name='3759'>
 implicit none<a name='3760'>
<a name='3761'>
   INTEGER,    INTENT(IN) ::           ids,ide, jds,jde, kds,kde, &amp;<a name='3762'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='3763'>
                                       ips,ipe, jps,jpe, kps,kpe, &amp;<a name='3764'>
                                       its,ite, jts,jte, kts,kte<a name='3765'>
<a name='3766'>
   INTEGER,   INTENT(IN) ::      iter<a name='3767'>
<a name='3768'>
   REAL, INTENT(IN)      ::        RADFRQ,XTIME,DECLIN,dx,dy,gmt,shadlen<a name='3769'>
<a name='3770'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN)  :: XLAT, XLONG, sina, cosa<a name='3771'>
<a name='3772'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)  ::  ht_shad,ht_loc<a name='3773'>
<a name='3774'>
   INTEGER, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)  :: shadowmask<a name='3775'>
<a name='3776'>
<font color=#447700>! Local variables<a name='3777'></font>
<a name='3778'>
   REAL :: pi, xt24, wgt, ri, rj, argu, sol_azi, topoelev, dxabs, tloctm, hrang, xxlat, csza<a name='3779'>
   INTEGER :: gpshad, ii, jj, i1, i2, j1, j2, i, j<a name='3780'>
<a name='3781'>
<a name='3782'>
<a name='3783'>
 XT24=MOD(XTIME+RADFRQ*0.5,1440.)<a name='3784'>
 pi = 4.*atan(1.)<a name='3785'>
 gpshad = int(shadlen/dx+1.)<a name='3786'>
<a name='3787'>
 if (iter.eq.1) then  <a name='3788'>
<a name='3789'>
<a name='3790'>
   j_loop1: DO J=jts,jte<a name='3791'>
   i_loop1: DO I=its,ite<a name='3792'>
<a name='3793'>
     TLOCTM=GMT+XT24/60.+XLONG(i,j)/15.<a name='3794'>
     HRANG=15.*(TLOCTM-12.)*DEGRAD<a name='3795'>
     XXLAT=XLAT(i,j)*DEGRAD<a name='3796'>
     CSZA=SIN(XXLAT)*SIN(DECLIN)+COS(XXLAT)*COS(DECLIN)*COS(HRANG)<a name='3797'>
<a name='3798'>
     if (csza.lt.1.e-2) then   <font color=#447700>! shadow mask does not need to be computed<a name='3799'></font>
     shadowmask(i,j) = 0<a name='3800'>
     ht_shad(i,j) = ht_loc(i,j)-0.001<a name='3801'>
     goto 120<a name='3802'>
     endif<a name='3803'>
<a name='3804'>
<font color=#447700>! Solar azimuth angle<a name='3805'></font>
<a name='3806'>
     argu=(csza*sin(XXLAT)-sin(DECLIN))/(sin(acos(csza))*cos(XXLAT))<a name='3807'>
     if (argu.gt.1) argu = 1<a name='3808'>
     if (argu.lt.-1) argu = -1<a name='3809'>
     sol_azi = sign(acos(argu),sin(HRANG))+pi  <font color=#447700>! azimuth angle of the sun<a name='3810'></font>
     if (cosa(i,j).ge.0) then<a name='3811'>
       sol_azi = sol_azi + asin(sina(i,j))  <font color=#447700>! rotation towards WRF grid <a name='3812'></font>
     else<a name='3813'>
       sol_azi = sol_azi + pi - asin(sina(i,j)) <a name='3814'>
     endif<a name='3815'>
<a name='3816'>
<font color=#447700>! Scan for higher surrounding topography<a name='3817'></font>
<a name='3818'>
          if ((sol_azi.gt.1.75*pi).or.(sol_azi.lt.0.25*pi)) then <font color=#447700>! sun is in the northern quarter<a name='3819'></font>
<a name='3820'>
            do jj = j+1,j+gpshad<a name='3821'>
              ri = i + (jj-j)*tan(sol_azi)<a name='3822'>
              i1 = int(ri) <a name='3823'>
              i2 = i1+1<a name='3824'>
              wgt = ri-i1<a name='3825'>
              dxabs = sqrt((dy*(jj-j))**2+(dx*(ri-i))**2)<a name='3826'>
              if ((jj.ge.jpe+3).or.(i1.le.ips-3).or.(i2.ge.ipe+3)) then<a name='3827'>
<font color=#447700>!               if (shadowmask(i,j).eq.0) shadowmask(i,j) = -1<a name='3828'></font>
                goto 120<a name='3829'>
              endif<a name='3830'>
              topoelev=atan((wgt*ht_loc(i2,jj)+(1.-wgt)*ht_loc(i1,jj)-ht_loc(i,j))/dxabs)<a name='3831'>
              if (sin(topoelev).ge.csza) then<a name='3832'>
                shadowmask(i,j) = 1<a name='3833'>
                ht_shad(i,j) = max(ht_shad(i,j),ht_loc(i,j)+dxabs*(tan(topoelev)-tan(asin(csza))))<a name='3834'>
              endif<a name='3835'>
            enddo<a name='3836'>
<a name='3837'>
          else if (sol_azi.lt.0.75*pi) then  <font color=#447700>! sun is in the eastern quarter<a name='3838'></font>
            do ii = i+1,i+gpshad<a name='3839'>
              rj = j - (ii-i)*tan(pi/2.+sol_azi)<a name='3840'>
              j1 = int(rj)<a name='3841'>
              j2 = j1+1<a name='3842'>
              wgt = rj-j1<a name='3843'>
              dxabs = sqrt((dx*(ii-i))**2+(dy*(rj-j))**2)<a name='3844'>
              if ((ii.ge.ipe+3).or.(j1.le.jps-3).or.(j2.ge.jpe+3)) then<a name='3845'>
<font color=#447700>!               if (shadowmask(i,j).eq.0) shadowmask(i,j) = -1<a name='3846'></font>
                goto 120<a name='3847'>
              endif<a name='3848'>
              topoelev=atan((wgt*ht_loc(ii,j2)+(1.-wgt)*ht_loc(ii,j1)-ht_loc(i,j))/dxabs)<a name='3849'>
              if (sin(topoelev).ge.csza) then<a name='3850'>
                shadowmask(i,j) = 1<a name='3851'>
                ht_shad(i,j) = max(ht_shad(i,j),ht_loc(i,j)+dxabs*(tan(topoelev)-tan(asin(csza))))<a name='3852'>
              endif<a name='3853'>
            enddo<a name='3854'>
<a name='3855'>
          else if (sol_azi.lt.1.25*pi) then <font color=#447700>! sun is in the southern quarter<a name='3856'></font>
            do jj = j-1,j-gpshad,-1<a name='3857'>
              ri = i + (jj-j)*tan(sol_azi)<a name='3858'>
              i1 = int(ri)<a name='3859'>
              i2 = i1+1<a name='3860'>
              wgt = ri-i1<a name='3861'>
              dxabs = sqrt((dy*(jj-j))**2+(dx*(ri-i))**2)<a name='3862'>
              if ((jj.le.jps-3).or.(i1.le.ips-3).or.(i2.ge.ipe+3)) then<a name='3863'>
<font color=#447700>!               if (shadowmask(i,j).eq.0) shadowmask(i,j) = -1<a name='3864'></font>
                goto 120<a name='3865'>
              endif<a name='3866'>
              topoelev=atan((wgt*ht_loc(i2,jj)+(1.-wgt)*ht_loc(i1,jj)-ht_loc(i,j))/dxabs)<a name='3867'>
              if (sin(topoelev).ge.csza) then<a name='3868'>
                shadowmask(i,j) = 1<a name='3869'>
                ht_shad(i,j) = max(ht_shad(i,j),ht_loc(i,j)+dxabs*(tan(topoelev)-tan(asin(csza))))<a name='3870'>
              endif<a name='3871'>
            enddo<a name='3872'>
<a name='3873'>
          else                          <font color=#447700>! sun is in the western quarter<a name='3874'></font>
            do ii = i-1,i-gpshad,-1<a name='3875'>
              rj = j - (ii-i)*tan(pi/2.+sol_azi)<a name='3876'>
              j1 = int(rj)<a name='3877'>
              j2 = j1+1<a name='3878'>
              wgt = rj-j1<a name='3879'>
              dxabs = sqrt((dx*(ii-i))**2+(dy*(rj-j))**2)<a name='3880'>
              if ((ii.le.ips-3).or.(j1.le.jps-3).or.(j2.ge.jpe+3)) then<a name='3881'>
<font color=#447700>!               if (shadowmask(i,j).eq.0) shadowmask(i,j) = -1<a name='3882'></font>
                goto 120<a name='3883'>
              endif<a name='3884'>
              topoelev=atan((wgt*ht_loc(ii,j2)+(1.-wgt)*ht_loc(ii,j1)-ht_loc(i,j))/dxabs)<a name='3885'>
              if (sin(topoelev).ge.csza) then<a name='3886'>
                shadowmask(i,j) = 1<a name='3887'>
                ht_shad(i,j) = max(ht_shad(i,j),ht_loc(i,j)+dxabs*(tan(topoelev)-tan(asin(csza))))<a name='3888'>
              endif<a name='3889'>
            enddo<a name='3890'>
          endif<a name='3891'>
<a name='3892'>
 120      continue<a name='3893'>
<a name='3894'>
   ENDDO i_loop1<a name='3895'>
   ENDDO j_loop1<a name='3896'>
<a name='3897'>
 else   <font color=#447700>! iteration &gt; 1<a name='3898'></font>
<a name='3899'>
<a name='3900'>
   j_loop2: DO J=jts,jte<a name='3901'>
   i_loop2: DO I=its,ite<a name='3902'>
<a name='3903'>
<font color=#447700>!     if (shadowmask(i,j).eq.-1) then  ! this indicates that the search ended at a lateral boundary during iteration 1<a name='3904'></font>
<a name='3905'>
       TLOCTM=GMT+XT24/60.+XLONG(i,j)/15.<a name='3906'>
       HRANG=15.*(TLOCTM-12.)*DEGRAD<a name='3907'>
       XXLAT=XLAT(i,j)*DEGRAD<a name='3908'>
       CSZA=SIN(XXLAT)*SIN(DECLIN)+COS(XXLAT)*COS(DECLIN)*COS(HRANG)<a name='3909'>
<a name='3910'>
       if (csza.lt.1.e-2) then   <font color=#447700>! shadow mask does not need to be computed<a name='3911'></font>
       shadowmask(i,j) = 0<a name='3912'>
       ht_shad(i,j) = ht_loc(i,j)-0.001<a name='3913'>
       goto 220<a name='3914'>
       endif<a name='3915'>
<a name='3916'>
<font color=#447700>! Solar azimuth angle<a name='3917'></font>
<a name='3918'>
       argu=(csza*sin(XXLAT)-sin(DECLIN))/(sin(acos(csza))*cos(XXLAT))<a name='3919'>
       if (argu.gt.1) argu = 1<a name='3920'>
       if (argu.lt.-1) argu = -1<a name='3921'>
       sol_azi = sign(acos(argu),sin(HRANG))+pi  <font color=#447700>! azimuth angle of the sun<a name='3922'></font>
       if (cosa(i,j).ge.0) then<a name='3923'>
         sol_azi = sol_azi + asin(sina(i,j))  <font color=#447700>! rotation towards WRF grid <a name='3924'></font>
       else<a name='3925'>
         sol_azi = sol_azi + pi - asin(sina(i,j)) <a name='3926'>
       endif<a name='3927'>
<a name='3928'>
<font color=#447700>! Scan for higher surrounding topography<a name='3929'></font>
<a name='3930'>
          if ((sol_azi.gt.1.75*pi).or.(sol_azi.lt.0.25*pi)) then <font color=#447700>! sun is in the northern quarter<a name='3931'></font>
<a name='3932'>
            do jj = j+1,j+gpshad<a name='3933'>
              ri = i + (jj-j)*tan(sol_azi)<a name='3934'>
              i1 = int(ri) <a name='3935'>
              i2 = i1+1<a name='3936'>
              wgt = ri-i1<a name='3937'>
              dxabs = sqrt((dy*(jj-j))**2+(dx*(ri-i))**2)<a name='3938'>
              if ((jj.ge.min(jde,jpe+3)).or.(i1.le.max(ids-1,ips-3)).or.(i2.ge.min(ide,ipe+3))) goto 220<a name='3939'>
              topoelev=atan((wgt*ht_loc(i2,jj)+(1.-wgt)*ht_loc(i1,jj)-ht_loc(i,j))/dxabs)<a name='3940'>
              if (sin(topoelev).ge.csza) then<a name='3941'>
                shadowmask(i,j) = 1<a name='3942'>
                ht_shad(i,j) = max(ht_shad(i,j),ht_loc(i,j)+dxabs*(tan(topoelev)-tan(asin(csza))))<a name='3943'>
              endif<a name='3944'>
            enddo<a name='3945'>
<a name='3946'>
          else if (sol_azi.lt.0.75*pi) then  <font color=#447700>! sun is in the eastern quarter<a name='3947'></font>
            do ii = i+1,i+gpshad<a name='3948'>
              rj = j - (ii-i)*tan(pi/2.+sol_azi)<a name='3949'>
              j1 = int(rj)<a name='3950'>
              j2 = j1+1<a name='3951'>
              wgt = rj-j1<a name='3952'>
              dxabs = sqrt((dx*(ii-i))**2+(dy*(rj-j))**2)<a name='3953'>
              if ((ii.ge.min(ide,ipe+3)).or.(j1.le.max(jds-1,jps-3)).or.(j2.ge.min(jde,jpe+3))) goto 220<a name='3954'>
              topoelev=atan((wgt*ht_loc(ii,j2)+(1.-wgt)*ht_loc(ii,j1)-ht_loc(i,j))/dxabs)<a name='3955'>
              if (sin(topoelev).ge.csza) then<a name='3956'>
                shadowmask(i,j) = 1<a name='3957'>
                ht_shad(i,j) = max(ht_shad(i,j),ht_loc(i,j)+dxabs*(tan(topoelev)-tan(asin(csza))))<a name='3958'>
              endif<a name='3959'>
            enddo<a name='3960'>
<a name='3961'>
          else if (sol_azi.lt.1.25*pi) then <font color=#447700>! sun is in the southern quarter<a name='3962'></font>
            do jj = j-1,j-gpshad,-1<a name='3963'>
              ri = i + (jj-j)*tan(sol_azi)<a name='3964'>
              i1 = int(ri)<a name='3965'>
              i2 = i1+1<a name='3966'>
              wgt = ri-i1<a name='3967'>
              dxabs = sqrt((dy*(jj-j))**2+(dx*(ri-i))**2)<a name='3968'>
              if ((jj.le.max(jds-1,jps-3)).or.(i1.le.max(ids-1,ips-3)).or.(i2.ge.min(ide,ipe+3))) goto 220<a name='3969'>
              topoelev=atan((wgt*ht_loc(i2,jj)+(1.-wgt)*ht_loc(i1,jj)-ht_loc(i,j))/dxabs)<a name='3970'>
              if (sin(topoelev).ge.csza) then<a name='3971'>
                shadowmask(i,j) = 1<a name='3972'>
                ht_shad(i,j) = max(ht_shad(i,j),ht_loc(i,j)+dxabs*(tan(topoelev)-tan(asin(csza))))<a name='3973'>
              endif<a name='3974'>
            enddo<a name='3975'>
<a name='3976'>
          else                          <font color=#447700>! sun is in the western quarter<a name='3977'></font>
            do ii = i-1,i-gpshad,-1<a name='3978'>
              rj = j - (ii-i)*tan(pi/2.+sol_azi)<a name='3979'>
              j1 = int(rj)<a name='3980'>
              j2 = j1+1<a name='3981'>
              wgt = rj-j1<a name='3982'>
              dxabs = sqrt((dx*(ii-i))**2+(dy*(rj-j))**2)<a name='3983'>
              if ((ii.le.max(ids-1,ips-3)).or.(j1.le.max(jds-1,jps-3)).or.(j2.ge.min(jde,jpe+3))) goto 220<a name='3984'>
              topoelev=atan((wgt*ht_loc(ii,j2)+(1.-wgt)*ht_loc(ii,j1)-ht_loc(i,j))/dxabs)<a name='3985'>
              if (sin(topoelev).ge.csza) then<a name='3986'>
                shadowmask(i,j) = 1<a name='3987'>
                ht_shad(i,j) = max(ht_shad(i,j),ht_loc(i,j)+dxabs*(tan(topoelev)-tan(asin(csza))))<a name='3988'>
              endif<a name='3989'>
            enddo<a name='3990'>
          endif<a name='3991'>
<a name='3992'>
 220      continue<a name='3993'>
<font color=#447700>!     endif<a name='3994'></font>
<a name='3995'>
   ENDDO i_loop2<a name='3996'>
   ENDDO j_loop2<a name='3997'>
<a name='3998'>
 endif <font color=#447700>! iteration<a name='3999'></font>
<a name='4000'>
   END SUBROUTINE toposhad<a name='4001'>
<a name='4002'>
<A NAME='OZN_TIME_INT'><A href='../../html_code/phys/module_radiation_driver.F.html#OZN_TIME_INT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4003'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>ozn_time_int</font>(julday,julian,ozmixm,ozmixt,levsiz,num_months,  &amp; <A href='../../call_to/OZN_TIME_INT.html' TARGET='index'>1</A><a name='4004'>
                              ids , ide , jds , jde , kds , kde ,     &amp;<a name='4005'>
                              ims , ime , jms , jme , kms , kme ,     &amp;<a name='4006'>
                              its , ite , jts , jte , kts , kte )<a name='4007'>
<a name='4008'>
<font color=#447700>! adapted from oznint from CAM module<a name='4009'></font>
<font color=#447700>!  input: ozmixm - read from physics_init<a name='4010'></font>
<font color=#447700>! output: ozmixt - time interpolated<a name='4011'></font>
<a name='4012'>
<font color=#447700>!  USE module_ra_cam_support, ONLY : getfactors<a name='4013'></font>
<a name='4014'>
   IMPLICIT NONE<a name='4015'>
<a name='4016'>
   INTEGER,    INTENT(IN) ::           ids,ide, jds,jde, kds,kde, &amp;<a name='4017'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='4018'>
                                       its,ite, jts,jte, kts,kte<a name='4019'>
<a name='4020'>
   INTEGER,      INTENT(IN   )    ::   levsiz, num_months<a name='4021'>
<a name='4022'>
   REAL,  DIMENSION( ims:ime, levsiz, jms:jme, num_months ),      &amp;<a name='4023'>
          INTENT(IN   ) ::                                  ozmixm<a name='4024'>
<a name='4025'>
   INTEGER, INTENT(IN )      ::        JULDAY<a name='4026'>
   REAL,    INTENT(IN )      ::        JULIAN<a name='4027'>
<a name='4028'>
   REAL,  DIMENSION( ims:ime, levsiz, jms:jme ),      &amp;<a name='4029'>
          INTENT(OUT  ) ::                                  ozmixt<a name='4030'>
<a name='4031'>
   <font color=#447700>!Local<a name='4032'></font>
   REAL      :: intJULIAN<a name='4033'>
   integer   :: np1,np,nm,m,k,i,j<a name='4034'>
   integer   :: IJUL<a name='4035'>
   integer, dimension(12) ::  date_oz<a name='4036'>
   data date_oz/16, 45, 75, 105, 136, 166, 197, 228, 258, 289, 319, 350/<a name='4037'>
   real, parameter :: daysperyear = 365.  <font color=#447700>! number of days in a year<a name='4038'></font>
   real      :: cdayozp, cdayozm<a name='4039'>
   real      :: fact1, fact2, deltat<a name='4040'>
   logical   :: finddate<a name='4041'>
   logical   :: ozncyc<a name='4042'>
   CHARACTER(LEN=256) :: msgstr<a name='4043'>
<a name='4044'>
   ozncyc = .true.<a name='4045'>
   <font color=#447700>! JULIAN starts from 0.0 at 0Z on 1 Jan.<a name='4046'></font>
   intJULIAN = JULIAN + 1.0       <font color=#447700>! offset by one day<a name='4047'></font>
<font color=#447700>! jan 1st 00z is julian=1.0 here<a name='4048'></font>
   IJUL=INT(intJULIAN)<a name='4049'>
<font color=#447700>!  Note that following will drift.<a name='4050'></font>
<font color=#447700>!    Need to use actual month/day info to compute julian.<a name='4051'></font>
   intJULIAN=intJULIAN-FLOAT(IJUL)<a name='4052'>
   IJUL=MOD(IJUL,365)<a name='4053'>
   IF(IJUL.EQ.0)IJUL=365<a name='4054'>
   intJULIAN=intJULIAN+IJUL<a name='4055'>
   np1=1<a name='4056'>
   finddate=.false.<a name='4057'>
<a name='4058'>
<font color=#447700>!  do m=1,num_months<a name='4059'></font>
   do m=1,12<a name='4060'>
      if(date_oz(m).gt.intjulian.and..not.finddate) then<a name='4061'>
        np1=m<a name='4062'>
        finddate=.true.<a name='4063'>
      endif<a name='4064'>
   enddo<a name='4065'>
   cdayozp=date_oz(np1)<a name='4066'>
<a name='4067'>
   if(np1.gt.1) then<a name='4068'>
      cdayozm=date_oz(np1-1)<a name='4069'>
      np=np1<a name='4070'>
      nm=np-1<a name='4071'>
   else<a name='4072'>
      cdayozm=date_oz(12)<a name='4073'>
      np=np1<a name='4074'>
      nm=12<a name='4075'>
   endif<a name='4076'>
<a name='4077'>
<font color=#447700>!  call getfactors(ozncyc,np1, cdayozm, cdayozp,intjulian, &amp;<a name='4078'></font>
<font color=#447700>!                   fact1, fact2)<a name='4079'></font>
<font color=#447700>!<a name='4080'></font>
<font color=#447700>! Determine time interpolation factors.  Account for December-January<a name='4081'></font>
<font color=#447700>! interpolation if dataset is being cycled yearly.<a name='4082'></font>
<font color=#447700>!<a name='4083'></font>
   if (ozncyc .and. np1 == 1) then                      <font color=#447700>! Dec-Jan interpolation<a name='4084'></font>
      deltat = cdayozp + daysperyear - cdayozm<a name='4085'>
      if (intjulian &gt; cdayozp) then                     <font color=#447700>! We are in December<a name='4086'></font>
         fact1 = (cdayozp + daysperyear - intjulian)/deltat<a name='4087'>
         fact2 = (intjulian - cdayozm)/deltat<a name='4088'>
      else                                              <font color=#447700>! We are in January<a name='4089'></font>
         fact1 = (cdayozp - intjulian)/deltat<a name='4090'>
         fact2 = (intjulian + daysperyear - cdayozm)/deltat<a name='4091'>
      end if<a name='4092'>
   else<a name='4093'>
      deltat = cdayozp - cdayozm<a name='4094'>
      fact1 = (cdayozp - intjulian)/deltat<a name='4095'>
      fact2 = (intjulian - cdayozm)/deltat<a name='4096'>
   end if<a name='4097'>
<font color=#447700>!<a name='4098'></font>
<font color=#447700>! Time interpolation.<a name='4099'></font>
<font color=#447700>!<a name='4100'></font>
      do j=jts,jte<a name='4101'>
      do k=1,levsiz<a name='4102'>
      do i=its,ite<a name='4103'>
            ozmixt(i,k,j) = ozmixm(i,k,j,nm)*fact1 + ozmixm(i,k,j,np)*fact2<a name='4104'>
      end do<a name='4105'>
      end do<a name='4106'>
      end do<a name='4107'>
<a name='4108'>
END SUBROUTINE ozn_time_int<a name='4109'>
<a name='4110'>
<A NAME='OZN_P_INT'><A href='../../html_code/phys/module_radiation_driver.F.html#OZN_P_INT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4111'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>ozn_p_int</font>(p ,pin, levsiz, ozmixt, o3vmr, &amp; <A href='../../call_to/OZN_P_INT.html' TARGET='index'>1</A>,<A href='../../call_from/OZN_P_INT.html' TARGET='index'>1</A><a name='4112'>
                              ids , ide , jds , jde , kds , kde ,     &amp;<a name='4113'>
                              ims , ime , jms , jme , kms , kme ,     &amp;<a name='4114'>
                              its , ite , jts , jte , kts , kte )<a name='4115'>
<a name='4116'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4117'></font>
<font color=#447700>!<a name='4118'></font>
<font color=#447700>! Purpose: Interpolate ozone from current time-interpolated values to model levels<a name='4119'></font>
<font color=#447700>!<a name='4120'></font>
<font color=#447700>! Method: Use pressure values to determine interpolation levels<a name='4121'></font>
<font color=#447700>!<a name='4122'></font>
<font color=#447700>! Author: Bruce Briegleb<a name='4123'></font>
<font color=#447700>! WW: Adapted for general use<a name='4124'></font>
<font color=#447700>!<a name='4125'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='4126'></font>
   implicit none<a name='4127'>
<font color=#447700>!--------------------------------------------------------------------------<a name='4128'></font>
<font color=#447700>!<a name='4129'></font>
<font color=#447700>! Arguments<a name='4130'></font>
<font color=#447700>!<a name='4131'></font>
   INTEGER,    INTENT(IN) ::           ids,ide, jds,jde, kds,kde, &amp;<a name='4132'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='4133'>
                                       its,ite, jts,jte, kts,kte<a name='4134'>
<a name='4135'>
   integer, intent(in) :: levsiz              <font color=#447700>! number of ozone layers<a name='4136'></font>
<a name='4137'>
   real, intent(in) :: p(ims:ime,kms:kme,jms:jme)   <font color=#447700>! level pressures (mks, bottom-up)<a name='4138'></font>
   real, intent(in) :: pin(levsiz)        <font color=#447700>! ozone data level pressures (mks, top-down)<a name='4139'></font>
   real, intent(in) :: ozmixt(ims:ime,levsiz,jms:jme) <font color=#447700>! ozone mixing ratio<a name='4140'></font>
<a name='4141'>
   real, intent(out) :: o3vmr(ims:ime,kms:kme,jms:jme) <font color=#447700>! ozone volume mixing ratio<a name='4142'></font>
<font color=#447700>!<a name='4143'></font>
<font color=#447700>! local storage<a name='4144'></font>
<font color=#447700>!<a name='4145'></font>
   real    pmid(its:ite,kts:kte)<a name='4146'>
   integer i,j                 <font color=#447700>! longitude index<a name='4147'></font>
   integer k, kk, kkstart, kout<font color=#447700>! level indices<a name='4148'></font>
   integer kupper(its:ite)     <font color=#447700>! Level indices for interpolation<a name='4149'></font>
   integer kount               <font color=#447700>! Counter<a name='4150'></font>
   integer ncol, pver<a name='4151'>
<a name='4152'>
   real    dpu                 <font color=#447700>! upper level pressure difference<a name='4153'></font>
   real    dpl                 <font color=#447700>! lower level pressure difference<a name='4154'></font>
<a name='4155'>
   ncol = ite - its + 1<a name='4156'>
   pver = kte - kts + 1<a name='4157'>
<a name='4158'>
   do j=jts,jte<a name='4159'>
<font color=#447700>!<a name='4160'></font>
<font color=#447700>! Initialize index array<a name='4161'></font>
<font color=#447700>!<a name='4162'></font>
<font color=#447700>!  do i=1, ncol<a name='4163'></font>
   do i=its, ite<a name='4164'>
      kupper(i) = 1<a name='4165'>
   end do<a name='4166'>
<font color=#447700>!<a name='4167'></font>
<font color=#447700>! Reverse the pressure array, and pin is in Pa, the same as model pmid<a name='4168'></font>
<font color=#447700>!<a name='4169'></font>
      do k = kts,kte<a name='4170'>
         kk = kte - k + kts<a name='4171'>
      do i = its,ite<a name='4172'>
         pmid(i,kk) = p(i,k,j)<a name='4173'>
      enddo<a name='4174'>
      enddo<a name='4175'>
<a name='4176'>
   do k=1,pver<a name='4177'>
<a name='4178'>
      kout = pver - k + 1<a name='4179'>
<font color=#447700>!     kout = k<a name='4180'></font>
<font color=#447700>!<a name='4181'></font>
<font color=#447700>! Top level we need to start looking is the top level for the previous k<a name='4182'></font>
<font color=#447700>! for all longitude points<a name='4183'></font>
<font color=#447700>!<a name='4184'></font>
      kkstart = levsiz<a name='4185'>
<font color=#447700>!     do i=1,ncol<a name='4186'></font>
      do i=its,ite<a name='4187'>
         kkstart = min0(kkstart,kupper(i))<a name='4188'>
      end do<a name='4189'>
      kount = 0<a name='4190'>
<font color=#447700>!<a name='4191'></font>
<font color=#447700>! Store level indices for interpolation<a name='4192'></font>
<font color=#447700>!<a name='4193'></font>
      do kk=kkstart,levsiz-1<a name='4194'>
<font color=#447700>!        do i=1,ncol<a name='4195'></font>
         do i=its,ite<a name='4196'>
            if (pin(kk).lt.pmid(i,k) .and. pmid(i,k).le.pin(kk+1)) then<a name='4197'>
               kupper(i) = kk<a name='4198'>
               kount = kount + 1<a name='4199'>
            end if<a name='4200'>
         end do<a name='4201'>
<font color=#447700>!<a name='4202'></font>
<font color=#447700>! If all indices for this level have been found, do the interpolation and<a name='4203'></font>
<font color=#447700>! go to the next level<a name='4204'></font>
<font color=#447700>!<a name='4205'></font>
         if (kount.eq.ncol) then<a name='4206'>
<font color=#447700>!           do i=1,ncol<a name='4207'></font>
            do i=its,ite<a name='4208'>
               dpu = pmid(i,k) - pin(kupper(i))<a name='4209'>
               dpl = pin(kupper(i)+1) - pmid(i,k)<a name='4210'>
               o3vmr(i,kout,j) = (ozmixt(i,kupper(i),j)*dpl + &amp;<a name='4211'>
                             ozmixt(i,kupper(i)+1,j)*dpu)/(dpl + dpu)<a name='4212'>
            end do<a name='4213'>
            goto 35<a name='4214'>
         end if<a name='4215'>
      end do<a name='4216'>
<font color=#447700>!<a name='4217'></font>
<font color=#447700>! If we've fallen through the kk=1,levsiz-1 loop, we cannot interpolate and<a name='4218'></font>
<font color=#447700>! must extrapolate from the bottom or top ozone data level for at least some<a name='4219'></font>
<font color=#447700>! of the longitude points.<a name='4220'></font>
<font color=#447700>!<a name='4221'></font>
<font color=#447700>!     do i=1,ncol<a name='4222'></font>
      do i=its,ite<a name='4223'>
         if (pmid(i,k) .lt. pin(1)) then<a name='4224'>
            o3vmr(i,kout,j) = ozmixt(i,1,j)*pmid(i,k)/pin(1)<a name='4225'>
         else if (pmid(i,k) .gt. pin(levsiz)) then<a name='4226'>
            o3vmr(i,kout,j) = ozmixt(i,levsiz,j)<a name='4227'>
         else<a name='4228'>
            dpu = pmid(i,k) - pin(kupper(i))<a name='4229'>
            dpl = pin(kupper(i)+1) - pmid(i,k)<a name='4230'>
            o3vmr(i,kout,j) = (ozmixt(i,kupper(i),j)*dpl + &amp;<a name='4231'>
                          ozmixt(i,kupper(i)+1,j)*dpu)/(dpl + dpu)<a name='4232'>
         end if<a name='4233'>
      end do<a name='4234'>
<a name='4235'>
      if (kount.gt.ncol) then<a name='4236'>
<font color=#447700>!        call endrun ('OZN_P_INT: Bad ozone data: non-monotonicity suspected')<a name='4237'></font>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_radiation_driver.F.html#OZN_P_INT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1130"> ('OZN_P_INT: Bad ozone data: non-monotonicity suspected')<a name='4238'>
      end if<a name='4239'>
35    continue<a name='4240'>
<a name='4241'>
   end do<a name='4242'>
   end do<a name='4243'>
<a name='4244'>
   return<a name='4245'>
END SUBROUTINE ozn_p_int<a name='4246'>
<a name='4247'>
<A NAME='AER_TIME_INT'><A href='../../html_code/phys/module_radiation_driver.F.html#AER_TIME_INT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4248'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>aer_time_int</font>(julday,julian,aerodm,aerodt,levsiz,num_months,no_src,  &amp; <A href='../../call_to/AER_TIME_INT.html' TARGET='index'>1</A><a name='4249'>
                              ids , ide , jds , jde , kds , kde ,     &amp;<a name='4250'>
                              ims , ime , jms , jme , kms , kme ,     &amp;<a name='4251'>
                              its , ite , jts , jte , kts , kte )<a name='4252'>
<a name='4253'>
<font color=#447700>! adapted from oznint from CAM module<a name='4254'></font>
<font color=#447700>!  input: aerodm - read from physics_init<a name='4255'></font>
<font color=#447700>! output: aerodt - time interpolated<a name='4256'></font>
<a name='4257'>
<font color=#447700>!  USE module_ra_cam_support, ONLY : getfactors<a name='4258'></font>
<a name='4259'>
   IMPLICIT NONE<a name='4260'>
<a name='4261'>
   INTEGER,    INTENT(IN) ::           ids,ide, jds,jde, kds,kde, &amp;<a name='4262'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='4263'>
                                       its,ite, jts,jte, kts,kte<a name='4264'>
<a name='4265'>
   INTEGER,      INTENT(IN   )    ::   levsiz, num_months, no_src<a name='4266'>
<a name='4267'>
   REAL,  DIMENSION( ims:ime, levsiz, jms:jme, num_months, no_src ),      &amp;<a name='4268'>
          INTENT(IN   ) ::                                  aerodm<a name='4269'>
<a name='4270'>
   INTEGER, INTENT(IN )      ::        JULDAY<a name='4271'>
   REAL,    INTENT(IN )      ::        JULIAN<a name='4272'>
<a name='4273'>
   REAL,  DIMENSION( ims:ime, levsiz, jms:jme, no_src ),      &amp;<a name='4274'>
          INTENT(OUT  ) ::                                  aerodt<a name='4275'>
<a name='4276'>
   <font color=#447700>!Local<a name='4277'></font>
   REAL      :: intJULIAN<a name='4278'>
   integer   :: np1,np,nm,m,k,i,j,s<a name='4279'>
   integer   :: IJUL<a name='4280'>
   integer, dimension(12) ::  date_oz<a name='4281'>
   data date_oz/16, 45, 75, 105, 136, 166, 197, 228, 258, 289, 319, 350/<a name='4282'>
   real, parameter :: daysperyear = 365.  <font color=#447700>! number of days in a year<a name='4283'></font>
   real      :: cdayozp, cdayozm<a name='4284'>
   real      :: fact1, fact2, deltat<a name='4285'>
   logical   :: finddate<a name='4286'>
   logical   :: ozncyc<a name='4287'>
   CHARACTER(LEN=256) :: msgstr<a name='4288'>
<a name='4289'>
   ozncyc = .true.<a name='4290'>
   <font color=#447700>! JULIAN starts from 0.0 at 0Z on 1 Jan.<a name='4291'></font>
   intJULIAN = JULIAN + 1.0       <font color=#447700>! offset by one day<a name='4292'></font>
<font color=#447700>! jan 1st 00z is julian=1.0 here<a name='4293'></font>
   IJUL=INT(intJULIAN)<a name='4294'>
<font color=#447700>!  Note that following will drift.<a name='4295'></font>
<font color=#447700>!    Need to use actual month/day info to compute julian.<a name='4296'></font>
   intJULIAN=intJULIAN-FLOAT(IJUL)<a name='4297'>
   IJUL=MOD(IJUL,365)<a name='4298'>
   IF(IJUL.EQ.0)IJUL=365<a name='4299'>
   intJULIAN=intJULIAN+IJUL<a name='4300'>
   np1=1<a name='4301'>
   finddate=.false.<a name='4302'>
<a name='4303'>
<font color=#447700>!  do m=1,num_months<a name='4304'></font>
   do m=1,12<a name='4305'>
      if(date_oz(m).gt.intjulian.and..not.finddate) then<a name='4306'>
        np1=m<a name='4307'>
        finddate=.true.<a name='4308'>
      endif<a name='4309'>
   enddo<a name='4310'>
   cdayozp=date_oz(np1)<a name='4311'>
<a name='4312'>
   if(np1.gt.1) then<a name='4313'>
      cdayozm=date_oz(np1-1)<a name='4314'>
      np=np1<a name='4315'>
      nm=np-1<a name='4316'>
   else<a name='4317'>
      cdayozm=date_oz(12)<a name='4318'>
      np=np1<a name='4319'>
      nm=12<a name='4320'>
   endif<a name='4321'>
<a name='4322'>
<font color=#447700>!  call getfactors(ozncyc,np1, cdayozm, cdayozp,intjulian, &amp;<a name='4323'></font>
<font color=#447700>!                   fact1, fact2)<a name='4324'></font>
<font color=#447700>!<a name='4325'></font>
<font color=#447700>! Determine time interpolation factors.  Account for December-January<a name='4326'></font>
<font color=#447700>! interpolation if dataset is being cycled yearly.<a name='4327'></font>
<font color=#447700>!<a name='4328'></font>
   if (ozncyc .and. np1 == 1) then                      <font color=#447700>! Dec-Jan interpolation<a name='4329'></font>
      deltat = cdayozp + daysperyear - cdayozm<a name='4330'>
      if (intjulian &gt; cdayozp) then                     <font color=#447700>! We are in December<a name='4331'></font>
         fact1 = (cdayozp + daysperyear - intjulian)/deltat<a name='4332'>
         fact2 = (intjulian - cdayozm)/deltat<a name='4333'>
      else                                              <font color=#447700>! We are in January<a name='4334'></font>
         fact1 = (cdayozp - intjulian)/deltat<a name='4335'>
         fact2 = (intjulian + daysperyear - cdayozm)/deltat<a name='4336'>
      end if<a name='4337'>
   else<a name='4338'>
      deltat = cdayozp - cdayozm<a name='4339'>
      fact1 = (cdayozp - intjulian)/deltat<a name='4340'>
      fact2 = (intjulian - cdayozm)/deltat<a name='4341'>
   end if<a name='4342'>
<font color=#447700>!<a name='4343'></font>
<font color=#447700>! Time interpolation.<a name='4344'></font>
<font color=#447700>!<a name='4345'></font>
      do s=1, no_src<a name='4346'>
      do j=jts,jte<a name='4347'>
      do k=1,levsiz<a name='4348'>
      do i=its,ite<a name='4349'>
            aerodt(i,k,j,s) = aerodm(i,k,j,nm,s)*fact1 + aerodm(i,k,j,np,s)*fact2<a name='4350'>
      end do<a name='4351'>
      end do<a name='4352'>
      end do<a name='4353'>
      end do<a name='4354'>
<a name='4355'>
END SUBROUTINE aer_time_int<a name='4356'>
<a name='4357'>
<A NAME='AER_P_INT'><A href='../../html_code/phys/module_radiation_driver.F.html#AER_P_INT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4358'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>aer_p_int</font>(p ,pin, levsiz, aerodt, aerod, no_src, pf, totaod,   &amp; <A href='../../call_to/AER_P_INT.html' TARGET='index'>1</A>,<A href='../../call_from/AER_P_INT.html' TARGET='index'>1</A><a name='4359'>
                     ids , ide , jds , jde , kds , kde ,     &amp;<a name='4360'>
                     ims , ime , jms , jme , kms , kme ,     &amp;<a name='4361'>
                     its , ite , jts , jte , kts , kte )<a name='4362'>
<a name='4363'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4364'></font>
<font color=#447700>!<a name='4365'></font>
<font color=#447700>! Purpose: Interpolate aerosol from current time-interpolated values to model levels<a name='4366'></font>
<font color=#447700>!<a name='4367'></font>
<font color=#447700>! Method: Use pressure values to determine interpolation levels<a name='4368'></font>
<font color=#447700>!<a name='4369'></font>
<font color=#447700>! Author: Bruce Briegleb<a name='4370'></font>
<font color=#447700>! WW: Adapted for general use<a name='4371'></font>
<font color=#447700>!<a name='4372'></font>
<font color=#447700>!   p:  model level pressure at half levels (Pa, bottom-up)<a name='4373'></font>
<font color=#447700>!   pf: model level pressure at full levles (Pa, bottom-up)<a name='4374'></font>
<font color=#447700>!<a name='4375'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='4376'></font>
   implicit none<a name='4377'>
<font color=#447700>!--------------------------------------------------------------------------<a name='4378'></font>
<font color=#447700>!<a name='4379'></font>
<font color=#447700>! Arguments<a name='4380'></font>
<font color=#447700>!<a name='4381'></font>
   INTEGER,    INTENT(IN) ::           ids,ide, jds,jde, kds,kde, &amp;<a name='4382'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='4383'>
                                       its,ite, jts,jte, kts,kte<a name='4384'>
<a name='4385'>
   integer, intent(in) :: levsiz              <font color=#447700>! number of aerosol layers<a name='4386'></font>
   integer, intent(in) :: no_src              <font color=#447700>! types of aerosol <a name='4387'></font>
<a name='4388'>
   real, intent(in) :: p(ims:ime,kms:kme,jms:jme)<a name='4389'>
   real, intent(in) :: pf(ims:ime,kms:kme,jms:jme)<a name='4390'>
   real, intent(in) :: pin(levsiz)        <font color=#447700>! aerosol data level pressures (mks, top-down)<a name='4391'></font>
   real, intent(in) :: aerodt(ims:ime,levsiz,jms:jme,1:no_src) <font color=#447700>! aerosol optical depth<a name='4392'></font>
<a name='4393'>
   real, intent(out) :: aerod(ims:ime,kms:kme,jms:jme,1:no_src) <font color=#447700>! aerosol optical depth<a name='4394'></font>
   real, intent(out) :: totaod(ims:ime,jms:jme)                 <font color=#447700>! total aerosol optical depth<a name='4395'></font>
<font color=#447700>!<a name='4396'></font>
<font color=#447700>! local storage<a name='4397'></font>
<font color=#447700>!<a name='4398'></font>
   real    pmid(its:ite,kts:kte)<a name='4399'>
   integer i,j                 <font color=#447700>! longitude index<a name='4400'></font>
   integer k, kk, kkstart, kout<font color=#447700>! level indices<a name='4401'></font>
   integer kupper(its:ite)     <font color=#447700>! Level indices for interpolation<a name='4402'></font>
   integer kount               <font color=#447700>! Counter<a name='4403'></font>
   integer ncol, pver, s<a name='4404'>
<a name='4405'>
   real    dpu                 <font color=#447700>! upper level pressure difference<a name='4406'></font>
   real    dpl                 <font color=#447700>! lower level pressure difference<a name='4407'></font>
   real    dpm                 <font color=#447700>! pressure difference in a model layer surrounding half p<a name='4408'></font>
<a name='4409'>
   ncol = ite - its + 1<a name='4410'>
   pver = kte - kts + 1<a name='4411'>
<a name='4412'>
   do s=1,no_src<a name='4413'>
   do j=jts,jte<a name='4414'>
<font color=#447700>!<a name='4415'></font>
<font color=#447700>! Initialize index array<a name='4416'></font>
<font color=#447700>!<a name='4417'></font>
   do i=its, ite<a name='4418'>
      kupper(i) = 1<a name='4419'>
   end do<a name='4420'>
<font color=#447700>!<a name='4421'></font>
<font color=#447700>! The pressure from incoming data is in hPa and top-down, <a name='4422'></font>
<font color=#447700>!     while model pressure is in Pa and bottom-up<a name='4423'></font>
<font color=#447700>!<a name='4424'></font>
      do k = kts,kte<a name='4425'>
         kk = kte - k + kts<a name='4426'>
      do i = its,ite<a name='4427'>
         pmid(i,kk) = p(i,k,j)*0.01<a name='4428'>
      enddo<a name='4429'>
      enddo<a name='4430'>
<a name='4431'>
   do k=1,pver<a name='4432'>
<a name='4433'>
      kout = pver - k + 1<a name='4434'>
<font color=#447700>!<a name='4435'></font>
<font color=#447700>! Top level we need to start looking is the top level for the previous k<a name='4436'></font>
<font color=#447700>! for all longitude points<a name='4437'></font>
<font color=#447700>!<a name='4438'></font>
      kkstart = levsiz<a name='4439'>
      do i=its,ite<a name='4440'>
         kkstart = min0(kkstart,kupper(i))<a name='4441'>
      end do<a name='4442'>
      kount = 0<a name='4443'>
<font color=#447700>!<a name='4444'></font>
<font color=#447700>! Store level indices for interpolation<a name='4445'></font>
<font color=#447700>!<a name='4446'></font>
      do kk=kkstart,levsiz-1<a name='4447'>
         do i=its,ite<a name='4448'>
            if (pin(kk).lt.pmid(i,k) .and. pmid(i,k).le.pin(kk+1)) then<a name='4449'>
               kupper(i) = kk<a name='4450'>
               kount = kount + 1<a name='4451'>
            end if<a name='4452'>
         end do<a name='4453'>
<font color=#447700>!<a name='4454'></font>
<font color=#447700>! If all indices for this level have been found, do the interpolation and<a name='4455'></font>
<font color=#447700>! go to the next level<a name='4456'></font>
<font color=#447700>!<a name='4457'></font>
         if (kount.eq.ncol) then<a name='4458'>
            do i=its,ite<a name='4459'>
               dpu = pmid(i,k) - pin(kupper(i))<a name='4460'>
               dpl = pin(kupper(i)+1) - pmid(i,k)<a name='4461'>
               dpm = pf(i,kout,j) - pf(i,kout+1,j)<a name='4462'>
               aerod(i,kout,j,s) = (aerodt(i,kupper(i),j,s)*dpl + &amp;<a name='4463'>
                             aerodt(i,kupper(i)+1,j,s)*dpu)/(dpl + dpu)<a name='4464'>
               aerod(i,kout,j,s) = aerod(i,kout,j,s)*dpm<a name='4465'>
            end do<a name='4466'>
            goto 35<a name='4467'>
         end if<a name='4468'>
      end do<a name='4469'>
<font color=#447700>!<a name='4470'></font>
<font color=#447700>! If we've fallen through the kk=1,levsiz-1 loop, we cannot interpolate and<a name='4471'></font>
<font color=#447700>! must extrapolate from the bottom or top aerosol data level for at least some<a name='4472'></font>
<font color=#447700>! of the longitude points.<a name='4473'></font>
<font color=#447700>!<a name='4474'></font>
      do i=its,ite<a name='4475'>
         if (pmid(i,k) .lt. pin(1)) then<a name='4476'>
            dpm = pf(i,kout,j) - pf(i,kout+1,j)<a name='4477'>
            aerod(i,kout,j,s) = aerodt(i,1,j,s)*pmid(i,k)/pin(1)<a name='4478'>
            aerod(i,kout,j,s) = aerod(i,kout,j,s)*dpm<a name='4479'>
         else if (pmid(i,k) .gt. pin(levsiz)) then<a name='4480'>
            dpm = pf(i,kout,j) - pf(i,kout+1,j)<a name='4481'>
            aerod(i,kout,j,s) = aerodt(i,levsiz,j,s)<a name='4482'>
            aerod(i,kout,j,s) = aerod(i,kout,j,s)*dpm<a name='4483'>
         else<a name='4484'>
            dpu = pmid(i,k) - pin(kupper(i))<a name='4485'>
            dpl = pin(kupper(i)+1) - pmid(i,k)<a name='4486'>
            dpm = pf(i,kout,j) - pf(i,kout+1,j)<a name='4487'>
            aerod(i,kout,j,s) = (aerodt(i,kupper(i),j,s)*dpl + &amp;<a name='4488'>
                          aerodt(i,kupper(i)+1,j,s)*dpu)/(dpl + dpu)<a name='4489'>
            aerod(i,kout,j,s) = aerod(i,kout,j,s)*dpm<a name='4490'>
         end if<a name='4491'>
      end do<a name='4492'>
<a name='4493'>
      if (kount.gt.ncol) then<a name='4494'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_radiation_driver.F.html#AER_P_INT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1131"> ('AER_P_INT: Bad aerosol data: non-monotonicity suspected')<a name='4495'>
      end if<a name='4496'>
35    continue<a name='4497'>
<a name='4498'>
   end do<a name='4499'>
   end do<a name='4500'>
   end do<a name='4501'>
<a name='4502'>
   do j=jts,jte<a name='4503'>
   do i=its,ite<a name='4504'>
      totaod(i,j) = 0.<a name='4505'>
   end do<a name='4506'>
   end do<a name='4507'>
<a name='4508'>
   do s=1,no_src<a name='4509'>
   do j=jts,jte<a name='4510'>
   do k=1,pver<a name='4511'>
   do i=its,ite<a name='4512'>
      totaod(i,j) = totaod(i,j) + aerod(i,k,j,s)<a name='4513'>
   end do<a name='4514'>
   end do<a name='4515'>
   end do<a name='4516'>
   end do<a name='4517'>
<a name='4518'>
   return<a name='4519'>
END SUBROUTINE aer_p_int<a name='4520'>
<a name='4521'>
<a name='4522'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4523'></font>
<a name='4524'>
<A NAME='GT_AOD'><A href='../../html_code/phys/module_radiation_driver.F.html#GT_AOD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4525'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>gt_aod</font>(p_phy,DZ8W,t_phy,qvapor, nwfa,nifa, taod5503d,  &amp; <A href='../../call_to/GT_AOD.html' TARGET='index'>1</A>,<A href='../../call_from/GT_AOD.html' TARGET='index'>2</A><a name='4526'>
     &amp;             ims,ime, jms,jme, kms,kme, its,ite, jts,jte, kts,kte)<a name='4527'>
<a name='4528'>
      USE <A href='../../html_code/phys/module_mp_thompson.F.html#MODULE_MP_THOMPSON'>module_mp_thompson</A><A href='../../html_code/phys/module_radiation_driver.F.html#GT_AOD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MP_THOMPSON_4">, only: RSLF<a name='4529'>
<a name='4530'>
      IMPLICIT NONE<a name='4531'>
<a name='4532'>
      INTEGER,  INTENT(IN):: ims,ime, jms,jme, kms,kme,                 &amp;<a name='4533'>
     &amp;                       its,ite, jts,jte, kts,kte<a name='4534'>
<a name='4535'>
      REAL, DIMENSION(ims:ime,kms:kme,jms:jme), INTENT(IN) ::           &amp;<a name='4536'>
     &amp;                                            t_phy,p_phy, DZ8W,    &amp;<a name='4537'>
     &amp;                                            qvapor, nifa, nwfa<a name='4538'>
      REAL,DIMENSION(ims:ime,kms:kme,jms:jme),INTENT(INOUT):: taod5503d<a name='4539'>
                                                              <a name='4540'>
      <font color=#447700>!..Local variables. <a name='4541'></font>
<a name='4542'>
      REAL, DIMENSION(its:ite,kts:kte,jts:jte):: AOD_wfa, AOD_ifa<a name='4543'>
      REAL:: RH, a_RH,b_RH, rh_d,rh_f, rhoa,qvsat, unit_bext1,unit_bext3<a name='4544'>
      REAL:: ntemp<a name='4545'>
      INTEGER :: i, k, j, RH_idx, RH_idx1, RH_idx2, t_idx<a name='4546'>
      INTEGER, PARAMETER:: rind=8<a name='4547'>
      REAL, DIMENSION(rind), PARAMETER:: rh_arr =                       &amp;<a name='4548'>
     &amp;                      (/10., 60., 70., 80., 85., 90., 95., 99.8/)<a name='4549'>
      REAL, DIMENSION(rind,4,2) :: lookup_tabl                           <font color=#447700>! RH, temp, water-friendly, ice-friendly<a name='4550'></font>
<a name='4551'>
      lookup_tabl(1,1,1) =  5.73936E-15  <a name='4552'>
      lookup_tabl(1,1,2) =  2.63577E-12<a name='4553'>
      lookup_tabl(1,2,1) =  5.73936E-15  <a name='4554'>
      lookup_tabl(1,2,2) =  2.63577E-12<a name='4555'>
      lookup_tabl(1,3,1) =  5.73936E-15  <a name='4556'>
      lookup_tabl(1,3,2) =  2.63577E-12<a name='4557'>
      lookup_tabl(1,4,1) =  5.73936E-15  <a name='4558'>
      lookup_tabl(1,4,2) =  2.63577E-12<a name='4559'>
<a name='4560'>
      lookup_tabl(2,1,1) = 6.93515E-15  <a name='4561'>
      lookup_tabl(2,1,2) = 2.72095E-12<a name='4562'>
      lookup_tabl(2,2,1) = 6.93168E-15  <a name='4563'>
      lookup_tabl(2,2,2) = 2.72092E-12  <a name='4564'>
      lookup_tabl(2,3,1) = 6.92570E-15  <a name='4565'>
      lookup_tabl(2,3,2) = 2.72091E-12 <a name='4566'>
      lookup_tabl(2,4,1) = 6.91833E-15  <a name='4567'>
      lookup_tabl(2,4,2) = 2.72087E-12<a name='4568'>
<a name='4569'>
      lookup_tabl(3,1,1) = 7.24707E-15  <a name='4570'>
      lookup_tabl(3,1,2) = 2.77219E-12<a name='4571'>
      lookup_tabl(3,2,1) = 7.23809E-15  <a name='4572'>
      lookup_tabl(3,2,2) = 2.77222E-12<a name='4573'>
      lookup_tabl(3,3,1) = 7.23108E-15  <a name='4574'>
      lookup_tabl(3,3,2) = 2.77201E-12<a name='4575'>
      lookup_tabl(3,4,1) = 7.21800E-15  <a name='4576'>
      lookup_tabl(3,4,2) = 2.77111E-12<a name='4577'>
<a name='4578'>
      lookup_tabl(4,1,1) = 8.95130E-15  <a name='4579'>
      lookup_tabl(4,1,2) = 2.87263E-12<a name='4580'>
      lookup_tabl(4,2,1) = 9.01582E-15  <a name='4581'>
      lookup_tabl(4,2,2) = 2.87252E-12<a name='4582'>
      lookup_tabl(4,3,1) = 9.13216E-15  <a name='4583'>
      lookup_tabl(4,3,2) = 2.87241E-12<a name='4584'>
      lookup_tabl(4,4,1) = 9.16219E-15  <a name='4585'>
      lookup_tabl(4,4,2) = 2.87211E-12<a name='4586'>
<a name='4587'>
      lookup_tabl(5,1,1) = 1.06695E-14  <a name='4588'>
      lookup_tabl(5,1,2) = 2.96752E-12<a name='4589'>
      lookup_tabl(5,2,1) = 1.06370E-14  <a name='4590'>
      lookup_tabl(5,2,2) = 2.96726E-12<a name='4591'>
      lookup_tabl(5,3,1) = 1.05999E-14  <a name='4592'>
      lookup_tabl(5,3,2) = 2.96702E-12<a name='4593'>
      lookup_tabl(5,4,1) = 1.05443E-14  <a name='4594'>
      lookup_tabl(5,4,2) = 2.96603E-12<a name='4595'>
<a name='4596'>
      lookup_tabl(6,1,1) = 1.37908E-14  <a name='4597'>
      lookup_tabl(6,1,2) = 3.15081E-12<a name='4598'>
      lookup_tabl(6,2,1) = 1.37172E-14  <a name='4599'>
      lookup_tabl(6,2,2) = 3.15020E-12<a name='4600'>
      lookup_tabl(6,3,1) = 1.36362E-14  <a name='4601'>
      lookup_tabl(6,3,2) = 3.14927E-12<a name='4602'>
      lookup_tabl(6,4,1) = 1.35287E-14  <a name='4603'>
      lookup_tabl(6,4,2) = 3.14817E-12<a name='4604'>
<a name='4605'>
      lookup_tabl(7,1,1) = 2.26019E-14  <a name='4606'>
      lookup_tabl(7,1,2) = 3.66798E-12<a name='4607'>
      lookup_tabl(7,2,1) = 2.24435E-14  <a name='4608'>
      lookup_tabl(7,2,2) = 3.66540E-12<a name='4609'>
      lookup_tabl(7,3,1) = 2.23254E-14  <a name='4610'>
      lookup_tabl(7,3,2) = 3.66173E-12<a name='4611'>
      lookup_tabl(7,4,1) = 2.20496E-14  <a name='4612'>
      lookup_tabl(7,4,2) = 3.65796E-12<a name='4613'>
<a name='4614'>
      lookup_tabl(8,1,1) = 4.41983E-13  <a name='4615'>
      lookup_tabl(8,1,2) = 7.50091E-11<a name='4616'>
      lookup_tabl(8,2,1) = 3.93335E-13  <a name='4617'>
      lookup_tabl(8,2,2) = 6.79097E-11<a name='4618'>
      lookup_tabl(8,3,1) = 3.45569E-13  <a name='4619'>
      lookup_tabl(8,3,2) = 6.07845E-11<a name='4620'>
      lookup_tabl(8,4,1) = 2.96971E-13  <a name='4621'>
      lookup_tabl(8,4,2) = 5.36085E-11     <a name='4622'>
<a name='4623'>
      DO j=jts,jte<a name='4624'>
         DO k=kts,kte<a name='4625'>
            DO i=its,ite<a name='4626'>
               AOD_wfa(i,k,j) = 0.<a name='4627'>
               AOD_ifa(i,k,j) = 0.<a name='4628'>
            END DO<a name='4629'>
         END DO<a name='4630'>
      END DO<a name='4631'>
<a name='4632'>
      DO j=jts,jte<a name='4633'>
         DO k=kts,kte<a name='4634'>
            DO i=its,ite<a name='4635'>
               rhoa = p_phy(i,k,j)/(287.*t_phy(i,k,j))<a name='4636'>
               t_idx = MAX(1, MIN(nint(10.999-0.0333*t_phy(i,k,j)),4))<a name='4637'>
               qvsat = <A href='../../html_code/share/dfi.F.html#RSLF'>rslf</A><A href='../../html_code/phys/module_radiation_driver.F.html#GT_AOD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSLF_5">(p_phy(i,k,j),t_phy(i,k,j))<a name='4638'>
               RH = MIN(98., MAX(10.1, qvapor(i,k,j)/qvsat*100.))<a name='4639'>
<a name='4640'>
               <font color=#447700>!..Get the index for the RH array element<a name='4641'></font>
<a name='4642'>
               if (RH .lt. 60) then<a name='4643'>
                  RH_idx1 = 1<a name='4644'>
                  RH_idx2 = 2<a name='4645'>
               elseif (RH .ge. 60 .AND. RH.lt.80) then<a name='4646'>
                  a_RH = 0.1<a name='4647'>
                  b_RH = -4<a name='4648'>
                  RH_idx = nint(a_RH*RH+b_RH)<a name='4649'>
                  rh_d = rh-rh_arr(rh_idx)<a name='4650'>
                  if (rh_d .lt. 0) then<a name='4651'>
                     RH_idx1 = RH_idx-1<a name='4652'>
                     RH_idx2 = RH_idx<a name='4653'>
                  else<a name='4654'>
                     RH_idx1 = RH_idx<a name='4655'>
                     RH_idx2 = RH_idx+1<a name='4656'>
                     if (RH_idx2.gt.rind) then<a name='4657'>
                        RH_idx2 = rind<a name='4658'>
                        RH_idx1 = rind-1<a name='4659'>
                     endif<a name='4660'>
                  endif<a name='4661'>
               else<a name='4662'>
                  a_RH = 0.2<a name='4663'>
                  b_RH = -12.<a name='4664'>
                  RH_idx = MIN(rind, nint(a_RH*RH+b_RH))<a name='4665'>
                  rh_d = rh-rh_arr(rh_idx)<a name='4666'>
                  if (rh_d .lt. 0) then<a name='4667'>
                     RH_idx1 = RH_idx-1<a name='4668'>
                     RH_idx2 = RH_idx<a name='4669'>
                  else<a name='4670'>
                     RH_idx1 = RH_idx<a name='4671'>
                     RH_idx2 = RH_idx+1<a name='4672'>
                     if (RH_idx2.gt.rind) then<a name='4673'>
                        RH_idx2 = rind<a name='4674'>
                        RH_idx1 = rind-1<a name='4675'>
                     endif<a name='4676'>
                  endif<a name='4677'>
               endif<a name='4678'>
<a name='4679'>
               <font color=#447700>!..RH fraction to be used<a name='4680'></font>
<a name='4681'>
               rh_f = MAX(0., MIN(1.0, (rh/(100-rh)-rh_arr(rh_idx1)     &amp;<a name='4682'>
     &amp;                                  /(100-rh_arr(rh_idx1)))         &amp;<a name='4683'>
     &amp;                        /(rh_arr(rh_idx2)/(100-rh_arr(rh_idx2))   &amp;<a name='4684'>
     &amp;                        -rh_arr(rh_idx1)/(100-rh_arr(rh_idx1))) ))<a name='4685'>
<a name='4686'>
      <a name='4687'>
               unit_bext1 = lookup_tabl(RH_idx1,t_idx,1)                &amp;<a name='4688'>
     &amp;                    + (lookup_tabl(RH_idx2,t_idx,1)               &amp;<a name='4689'>
     &amp;                    - lookup_tabl(RH_idx1,t_idx,1))*rh_f<a name='4690'>
               unit_bext3 = lookup_tabl(RH_idx1,t_idx,2)                &amp;<a name='4691'>
     &amp;                    + (lookup_tabl(RH_idx2,t_idx,2)               &amp;<a name='4692'>
     &amp;                    - lookup_tabl(RH_idx1,t_idx,2))*rh_f<a name='4693'>
<a name='4694'>
               ntemp = MAX(1., MIN(99999.E6, nwfa(i,k,j)))<a name='4695'>
               AOD_wfa(i,k,j) = unit_bext1*ntemp*dz8w(i,k,j)*rhoa<a name='4696'>
<a name='4697'>
               ntemp = MAX(0.01, MIN(9999.E6, nifa(i,k,j)))<a name='4698'>
               AOD_ifa(i,k,j) = unit_bext3*ntemp*dz8w(i,k,j)*rhoa<a name='4699'>
<a name='4700'>
            END DO<a name='4701'>
         END DO<a name='4702'>
      END DO<a name='4703'>
<a name='4704'>
      DO j=jts,jte<a name='4705'>
         DO k=kts,kte<a name='4706'>
            DO i=its,ite<a name='4707'>
               taod5503d(i,k,j) = aod_wfa(i,k,j) + aod_ifa(i,k,j)<a name='4708'>
            END DO<a name='4709'>
         END DO<a name='4710'>
      END DO<a name='4711'>
<a name='4712'>
      END SUBROUTINE gt_aod<a name='4713'>
<a name='4714'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4715'></font>
<a name='4716'>
END MODULE module_radiation_driver<a name='4717'>
</pre></body></html>