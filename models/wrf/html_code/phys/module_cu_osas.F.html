<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!!<a name='2'></font>
<A NAME='MODULE_CU_OSAS'><A href='../../html_code/phys/module_cu_osas.F.html#MODULE_CU_OSAS' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='3'>
<font color=#993300>MODULE </font><font color=#cc0000>module_cu_osas</font>  <A href='../../call_to/MODULE_CU_OSAS.html' TARGET='index'>2</A><a name='4'>
<a name='5'>
CONTAINS<a name='6'>
<a name='7'>
<font color=#447700>!-----------------------------------------------------------------<a name='8'></font>
<A NAME='CU_OSAS'><A href='../../html_code/phys/module_cu_osas.F.html#CU_OSAS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='9'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>CU_OSAS</font>(DT,ITIMESTEP,STEPCU,                        &amp; <A href='../../call_to/CU_OSAS.html' TARGET='index'>1</A>,<A href='../../call_from/CU_OSAS.html' TARGET='index'>7</A><a name='10'>
                 RTHCUTEN,RQVCUTEN,RQCCUTEN,RQICUTEN,               &amp;<a name='11'>
                 RUCUTEN,RVCUTEN,                                   &amp; <font color=#447700>! gopal's doing for SAS<a name='12'></font>
                 RAINCV,PRATEC,HTOP,HBOT,                           &amp;<a name='13'>
                 U3D,V3D,W,T3D,QV3D,QC3D,QI3D,PI3D,RHO3D,           &amp;<a name='14'>
                 DZ8W,PCPS,P8W,XLAND,CU_ACT_FLAG,                   &amp;<a name='15'>
                 P_QC,                                              &amp; <a name='16'>
                 STORE_RAND,MOMMIX, &amp; <font color=#447700>! gopal's doing<a name='17'></font>
                 P_QI,P_FIRST_SCALAR,                               &amp; <a name='18'>
                 ids,ide, jds,jde, kds,kde,                         &amp;<a name='19'>
                 ims,ime, jms,jme, kms,kme,                         &amp;<a name='20'>
                 its,ite, jts,jte, kts,kte                          )<a name='21'>
<a name='22'>
<font color=#447700>!-------------------------------------------------------------------<a name='23'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_cu_osas.F.html#CU_OSAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_11"> , ONLY : kind_phys<a name='24'>
      USE <A href='../../html_code/phys/module_gfs_funcphys.F.html#MODULE_GFS_FUNCPHYS'>MODULE_GFS_FUNCPHYS</A><A href='../../html_code/phys/module_cu_osas.F.html#CU_OSAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_FUNCPHYS_1"> , ONLY : gfuncphys<a name='25'>
      USE <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_PHYSCONS</A><A href='../../html_code/phys/module_cu_osas.F.html#CU_OSAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_5">, grav =&gt; con_g, CP =&gt; con_CP, HVAP =&gt; con_HVAP  &amp;<a name='26'>
     &amp;,             RV =&gt; con_RV, FV =&gt; con_fvirt, T0C =&gt; con_T0C       &amp;<a name='27'>
     &amp;,             CVAP =&gt; con_CVAP, CLIQ =&gt; con_CLIQ                  &amp; <a name='28'>
     &amp;,             EPS =&gt; con_eps, EPSM1 =&gt; con_epsm1                  &amp;<a name='29'>
     &amp;,             ROVCP =&gt; con_rocp, RD =&gt; con_rd<a name='30'>
<font color=#447700>!-------------------------------------------------------------------<a name='31'></font>
      IMPLICIT NONE<a name='32'>
<font color=#447700>!-------------------------------------------------------------------<a name='33'></font>
<font color=#447700>!-- U3D         3D u-velocity interpolated to theta points (m/s)<a name='34'></font>
<font color=#447700>!-- V3D         3D v-velocity interpolated to theta points (m/s)<a name='35'></font>
<font color=#447700>!-- TH3D	3D potential temperature (K)<a name='36'></font>
<font color=#447700>!-- T3D         temperature (K)<a name='37'></font>
<font color=#447700>!-- QV3D        3D water vapor mixing ratio (Kg/Kg)<a name='38'></font>
<font color=#447700>!-- QC3D        3D cloud mixing ratio (Kg/Kg)<a name='39'></font>
<font color=#447700>!-- QI3D        3D ice mixing ratio (Kg/Kg)<a name='40'></font>
<font color=#447700>!-- P8w         3D pressure at full levels (Pa)<a name='41'></font>
<font color=#447700>!-- Pcps        3D pressure (Pa)<a name='42'></font>
<font color=#447700>!-- PI3D	3D exner function (dimensionless)<a name='43'></font>
<font color=#447700>!-- rr3D	3D dry air density (kg/m^3)<a name='44'></font>
<font color=#447700>!-- RUBLTEN     U tendency due to<a name='45'></font>
<font color=#447700>!               PBL parameterization (m/s^2)<a name='46'></font>
<font color=#447700>!-- RVBLTEN     V tendency due to<a name='47'></font>
<font color=#447700>!               PBL parameterization (m/s^2)<a name='48'></font>
<font color=#447700>!-- RTHBLTEN    Theta tendency due to<a name='49'></font>
<font color=#447700>!               PBL parameterization (K/s)<a name='50'></font>
<font color=#447700>!-- RQVBLTEN    Qv tendency due to<a name='51'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='52'></font>
<font color=#447700>!-- RQCBLTEN    Qc tendency due to<a name='53'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='54'></font>
<font color=#447700>!-- RQIBLTEN    Qi tendency due to<a name='55'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='56'></font>
<font color=#447700>!<a name='57'></font>
<font color=#447700>!-- MOMMIX      MOMENTUM MIXING COEFFICIENT (can be set in the namelist)<a name='58'></font>
<font color=#447700>!-- RUCUTEN     U tendency due to Cumulus Momentum Mixing (gopal's doing for SAS)<a name='59'></font>
<font color=#447700>!-- RVCUTEN     V tendency due to Cumulus Momentum Mixing (gopal's doing for SAS)<a name='60'></font>
<font color=#447700>!<a name='61'></font>
<font color=#447700>!-- CP          heat capacity at constant pressure for dry air (J/kg/K)<a name='62'></font>
<font color=#447700>!-- GRAV        acceleration due to gravity (m/s^2)<a name='63'></font>
<font color=#447700>!-- ROVCP       R/CP<a name='64'></font>
<font color=#447700>!-- RD          gas constant for dry air (J/kg/K)<a name='65'></font>
<font color=#447700>!-- ROVG 	R/G<a name='66'></font>
<font color=#447700>!-- P_QI	species index for cloud ice<a name='67'></font>
<font color=#447700>!-- dz8w	dz between full levels (m)<a name='68'></font>
<font color=#447700>!-- z		height above sea level (m)<a name='69'></font>
<font color=#447700>!-- PSFC        pressure at the surface (Pa)<a name='70'></font>
<font color=#447700>!-- UST		u* in similarity theory (m/s)<a name='71'></font>
<font color=#447700>!-- PBL		PBL height (m)<a name='72'></font>
<font color=#447700>!-- PSIM        similarity stability function for momentum<a name='73'></font>
<font color=#447700>!-- PSIH        similarity stability function for heat<a name='74'></font>
<font color=#447700>!-- HFX		upward heat flux at the surface (W/m^2)<a name='75'></font>
<font color=#447700>!-- QFX		upward moisture flux at the surface (kg/m^2/s)<a name='76'></font>
<font color=#447700>!-- TSK		surface temperature (K)<a name='77'></font>
<font color=#447700>!-- GZ1OZ0      log(z/z0) where z0 is roughness length<a name='78'></font>
<font color=#447700>!-- WSPD        wind speed at lowest model level (m/s)<a name='79'></font>
<font color=#447700>!-- BR          bulk Richardson number in surface layer<a name='80'></font>
<font color=#447700>!-- DT		time step (s)<a name='81'></font>
<font color=#447700>!-- rvovrd      R_v divided by R_d (dimensionless)<a name='82'></font>
<font color=#447700>!-- EP1         constant for virtual temperature (R_v/R_d - 1) (dimensionless)<a name='83'></font>
<font color=#447700>!-- KARMAN      Von Karman constant<a name='84'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='85'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='86'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='87'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='88'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='89'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='90'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='91'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='92'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='93'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='94'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='95'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='96'></font>
<font color=#447700>!-- its         start index for i in tile<a name='97'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='98'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='99'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='100'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='101'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='102'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='103'></font>
<a name='104'>
      INTEGER ::                        ICLDCK<a name='105'>
<a name='106'>
      INTEGER, INTENT(IN) ::            ids,ide, jds,jde, kds,kde,      &amp;<a name='107'>
                                        ims,ime, jms,jme, kms,kme,      &amp;<a name='108'>
                                        its,ite, jts,jte, kts,kte,      &amp;<a name='109'>
                                        ITIMESTEP,                      &amp;     <font color=#447700>!NSTD<a name='110'></font>
                                        P_FIRST_SCALAR,                 &amp;<a name='111'>
                                        P_QC,                           &amp;<a name='112'>
                                        P_QI,                           &amp;<a name='113'>
                                        STEPCU<a name='114'>
<a name='115'>
      REAL,    INTENT(IN) ::                                            &amp;<a name='116'>
                                        DT<a name='117'>
<a name='118'>
<a name='119'>
      REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::      &amp;<a name='120'>
                                        RQCCUTEN,                       &amp;<a name='121'>
                                        RQICUTEN,                       &amp;<a name='122'>
                                        RQVCUTEN,                       &amp;<a name='123'>
                                        RTHCUTEN<a name='124'>
      REAL, DIMENSION(ims:ime, jms:jme, kms:kme), INTENT(INOUT) ::      &amp;<a name='125'>
                                        RUCUTEN,                        &amp;  <font color=#447700>! gopal's doing for SAS<a name='126'></font>
                                        RVCUTEN                            <font color=#447700>! gopal's doing for SAS <a name='127'></font>
      REAL, OPTIONAL,   INTENT(IN) ::    MOMMIX<a name='128'>
      REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL,                   &amp;<a name='129'>
                         INTENT(IN) :: STORE_RAND<a name='130'>
<a name='131'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(IN) ::               &amp;<a name='132'>
                                        XLAND<a name='133'>
<a name='134'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(INOUT) ::            &amp;<a name='135'>
                                        RAINCV, PRATEC<a name='136'>
<a name='137'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(OUT) ::              &amp;<a name='138'>
                                        HBOT,                           &amp;<a name='139'>
                                        HTOP<a name='140'>
<a name='141'>
      LOGICAL, DIMENSION(IMS:IME,JMS:JME), INTENT(INOUT) ::             &amp;<a name='142'>
                                        CU_ACT_FLAG<a name='143'>
<a name='144'>
<a name='145'>
      REAL,    DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN) ::      &amp;<a name='146'>
                                        DZ8W,                           &amp;<a name='147'>
                                        P8w,                            &amp;<a name='148'>
                                        Pcps,                           &amp;<a name='149'>
                                        PI3D,                           &amp;<a name='150'>
                                        QC3D,                           &amp;<a name='151'>
                                        QI3D,                           &amp;<a name='152'>
                                        QV3D,                           &amp;<a name='153'>
                                        RHO3D,                          &amp;<a name='154'>
                                        T3D,                            &amp;<a name='155'>
                                        U3D,                            &amp;<a name='156'>
                                        V3D,                            &amp;<a name='157'>
                                        W<a name='158'>
<a name='159'>
<font color=#447700>!--------------------------- LOCAL VARS ------------------------------<a name='160'></font>
<a name='161'>
      REAL,    DIMENSION(ims:ime, jms:jme) ::                           &amp;<a name='162'>
                                        PSFC<a name='163'>
<a name='164'>
<a name='165'>
      REAL     (kind=kind_phys) ::                                      &amp;<a name='166'>
                                        DELT,                           &amp;<a name='167'>
                                        DPSHC,                          &amp;<a name='168'>
                                        RDELT,                          &amp;<a name='169'>
                                        RSEED<a name='170'>
<a name='171'>
      REAL     (kind=kind_phys), DIMENSION(its:ite) ::                  &amp;<a name='172'>
                                        CLDWRK,                         &amp;<a name='173'>
                                        PS,                             &amp;<a name='174'>
                                        RCS,                            &amp;<a name='175'>
                                        RN,                             &amp;<a name='176'>
                                        SLIMSK,                         &amp;<a name='177'>
                                        XKT2<a name='178'>
<a name='179'>
      REAL     (kind=kind_phys), DIMENSION(its:ite, kts:kte+1) ::       &amp;<a name='180'>
                                        PRSI                            <a name='181'>
<a name='182'>
      REAL     (kind=kind_phys), DIMENSION(its:ite, kts:kte) ::         &amp;<a name='183'>
                                        DEL,                            &amp;<a name='184'>
                                        DOT,                            &amp;<a name='185'>
                                        PHIL,                           &amp;<a name='186'>
                                        PRSL,                           &amp;<a name='187'>
                                        PRSLK,                          &amp;<a name='188'>
                                        Q1,                             &amp; <a name='189'>
                                        T1,                             &amp; <a name='190'>
                                        U1,                             &amp; <a name='191'>
                                        V1,                             &amp; <a name='192'>
                                        ZI,                             &amp; <a name='193'>
                                        ZL <a name='194'>
<a name='195'>
      REAL     (kind=kind_phys), DIMENSION(its:ite, kts:kte, 2) ::      &amp;<a name='196'>
                                        QL <a name='197'>
<a name='198'>
      INTEGER, DIMENSION(its:ite) ::                                    &amp;<a name='199'>
                                        KBOT,                           &amp;<a name='200'>
                                        KTOP,                           &amp;<a name='201'>
                                        KUO<a name='202'>
<a name='203'>
      INTEGER ::                                                        &amp;<a name='204'>
                                        I,                              &amp;<a name='205'>
                                        IGPVS,                          &amp;<a name='206'>
                                        IM,                             &amp;<a name='207'>
                                        J,                              &amp;<a name='208'>
                                        JCAP,                           &amp;<a name='209'>
                                        K,                              &amp;<a name='210'>
                                        KM,                             &amp;<a name='211'>
                                        KP,                             &amp;<a name='212'>
                                        KX,                             &amp;<a name='213'>
                                        NCLOUD <a name='214'>
<a name='215'>
      DATA IGPVS/0/<a name='216'>
<a name='217'>
<font color=#447700>!-----------------------------------------------------------------------<a name='218'></font>
<font color=#447700>!<a name='219'></font>
<a name='220'>
      DO J=JTS,JTE<a name='221'>
         DO I=ITS,ITE<a name='222'>
            CU_ACT_FLAG(I,J)=.TRUE.<a name='223'>
         ENDDO<a name='224'>
      ENDDO<a name='225'>
 <a name='226'>
      IM=ITE-ITS+1<a name='227'>
      KX=KTE-KTS+1<a name='228'>
      JCAP=126<a name='229'>
      DPSHC=30_kind_phys<a name='230'>
      DELT=DT*STEPCU<a name='231'>
      RDELT=1./DELT<a name='232'>
      NCLOUD=1<a name='233'>
<a name='234'>
<a name='235'>
   DO J=jms,jme<a name='236'>
     DO I=ims,ime<a name='237'>
       PSFC(i,j)=P8w(i,kms,j)<a name='238'>
     ENDDO<a name='239'>
   ENDDO<a name='240'>
<a name='241'>
   if(igpvs.eq.0) CALL <A href='../../html_code/phys/module_gfs_funcphys.F.html#GFUNCPHYS'>GFUNCPHYS</A><A href='../../html_code/phys/module_cu_osas.F.html#CU_OSAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GFUNCPHYS_1"><a name='242'>
   igpvs=1<a name='243'>
<a name='244'>
<font color=#447700>!-------------  J LOOP (OUTER) --------------------------------------------------<a name='245'></font>
<a name='246'>
   DO J=jts,jte<a name='247'>
<a name='248'>
<font color=#447700>! --------------- compute zi and zl -----------------------------------------<a name='249'></font>
      DO i=its,ite<a name='250'>
        ZI(I,KTS)=0.0<a name='251'>
      ENDDO<a name='252'>
<a name='253'>
      DO k=kts+1,kte<a name='254'>
        KM=K-1<a name='255'>
        DO i=its,ite<a name='256'>
          ZI(I,K)=ZI(I,KM)+dz8w(i,km,j)<a name='257'>
        ENDDO<a name='258'>
      ENDDO<a name='259'>
<a name='260'>
      DO k=kts+1,kte<a name='261'>
        KM=K-1<a name='262'>
        DO i=its,ite<a name='263'>
          ZL(I,KM)=(ZI(I,K)+ZI(I,KM))*0.5<a name='264'>
        ENDDO<a name='265'>
      ENDDO<a name='266'>
<a name='267'>
      DO i=its,ite<a name='268'>
        ZL(I,KTE)=2.*ZI(I,KTE)-ZL(I,KTE-1)<a name='269'>
      ENDDO<a name='270'>
<a name='271'>
<font color=#447700>! --------------- end compute zi and zl -------------------------------------<a name='272'></font>
<a name='273'>
<font color=#447700>!    Based on some important findings from Morris Bender, XKT2 was defined in<a name='274'></font>
<font color=#447700>!    terms of random number instead of random number based cloud tops<a name='275'></font>
<font color=#447700>!    Also, these random numbers are stored and are changed only once in<a name='276'></font>
<font color=#447700>!    approximately 5 minutes interval now. This is gopal's doing for HWRF.<a name='277'></font>
<a name='278'>
<font color=#447700>!     call random_number(XKT2)<a name='279'></font>
<a name='280'>
#if (EM_CORE == 1)<a name='281'>
<font color=#447700>!    XKT2 was defined in terms of random number instead of random number based cloud tops<a name='282'></font>
<font color=#447700>!    ZCX   <a name='283'></font>
     call <A href='../../html_code/phys/module_cu_osas.F.html#INIT_RANDOM_SEED'>init_random_seed</A><A href='../../html_code/phys/module_cu_osas.F.html#CU_OSAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_RANDOM_SEED_1">()<a name='284'>
     call random_number(XKT2)<a name='285'>
#ifdef REGTEST<a name='286'>
<font color=#447700>! for regtest only<a name='287'></font>
     xkt2 = 0.1<a name='288'>
#endif<a name='289'>
#endif<a name='290'>
<font color=#447700>!   <a name='291'></font>
#if (NMM_CORE == 1)<a name='292'>
      DO i=its,ite<a name='293'>
         XKT2(i) = STORE_RAND(i,j)<a name='294'>
      ENDDO<a name='295'>
#endif<a name='296'>
<a name='297'>
      DO i=its,ite<a name='298'>
        PS(i)=PSFC(i,j)*.001<a name='299'>
        RCS(i)=1.<a name='300'>
        SLIMSK(i)=ABS(XLAND(i,j)-2.)<a name='301'>
      ENDDO<a name='302'>
<a name='303'>
      DO i=its,ite<a name='304'>
        PRSI(i,kts)=PS(i)<a name='305'>
      ENDDO<a name='306'>
<a name='307'>
      DO k=kts,kte<a name='308'>
        kp=k+1<a name='309'>
        DO i=its,ite<a name='310'>
          PRSL(I,K)=Pcps(i,k,j)*.001<a name='311'>
          PHIL(I,K)=ZL(I,K)*GRAV<a name='312'>
          DOT(i,k)=-5.0E-4*GRAV*rho3d(i,k,j)*(w(i,k,j)+w(i,kp,j))<a name='313'>
        ENDDO<a name='314'>
      ENDDO<a name='315'>
<a name='316'>
      DO k=kts,kte<a name='317'>
        DO i=its,ite<a name='318'>
          DEL(i,k)=PRSL(i,k)*GRAV/RD*dz8w(i,k,j)/T3D(i,k,j)<a name='319'>
          U1(i,k)=U3D(i,k,j)<a name='320'>
          V1(i,k)=V3D(i,k,j)<a name='321'>
          Q1(i,k)=QV3D(i,k,j)/(1.+QV3D(i,k,j))<a name='322'>
          T1(i,k)=T3D(i,k,j)<a name='323'>
          QL(i,k,1)=QI3D(i,k,j)/(1.+QI3D(i,k,j))<a name='324'>
          QL(i,k,2)=QC3D(i,k,j)/(1.+QC3D(i,k,j))<a name='325'>
          PRSLK(I,K)=(PRSL(i,k)*.01)**ROVCP<a name='326'>
        ENDDO<a name='327'>
      ENDDO<a name='328'>
<a name='329'>
      DO k=kts+1,kte+1<a name='330'>
        km=k-1<a name='331'>
        DO i=its,ite<a name='332'>
          PRSI(i,k)=PRSI(i,km)-del(i,km) <a name='333'>
        ENDDO<a name='334'>
      ENDDO<a name='335'>
<a name='336'>
<a name='337'>
      CALL <A href='../../html_code/phys/module_cu_osas.F.html#OSASCNV'>OSASCNV</A><A href='../../html_code/phys/module_cu_osas.F.html#CU_OSAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OSASCNV_1">(IM,IM,KX,JCAP,DELT,DEL,PRSL,PS,PHIL,                  &amp;<a name='338'>
                  QL,Q1,T1,U1,V1,RCS,CLDWRK,RN,KBOT,                    &amp;<a name='339'>
                  KTOP,KUO,SLIMSK,DOT,XKT2,NCLOUD) <a name='340'>
<a name='341'>
<font color=#447700>!!!   make more like GFDL ... eliminate shallow convection.....<a name='342'></font>
<font color=#447700>!!!   CALL SHALCV(IM,IM,KX,DELT,DEL,PRSI,PRSL,PRSLK,KUO,Q1,T1,DPSHC)<a name='343'></font>
#if (EM_CORE == 1)<a name='344'>
      CALL <A href='../../html_code/phys/module_cu_osas.F.html#SHALCV'>SHALCV</A><A href='../../html_code/phys/module_cu_osas.F.html#CU_OSAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHALCV_1">(IM,IM,KX,DELT,DEL,PRSI,PRSL,PRSLK,KUO,Q1,T1,DPSHC)<a name='345'>
#endif<a name='346'>
<a name='347'>
      DO I=ITS,ITE<a name='348'>
        RAINCV(I,J)=RN(I)*1000./STEPCU<a name='349'>
        PRATEC(I,J)=RN(I)*1000./(STEPCU * DT)<a name='350'>
        HBOT(I,J)=KBOT(I)<a name='351'>
        HTOP(I,J)=KTOP(I)<a name='352'>
      ENDDO<a name='353'>
<a name='354'>
      DO K=KTS,KTE<a name='355'>
        DO I=ITS,ITE<a name='356'>
          RTHCUTEN(I,K,J)=(T1(I,K)-T3D(I,K,J))/PI3D(I,K,J)*RDELT<a name='357'>
          RQVCUTEN(I,K,J)=(Q1(I,K)/(1.-q1(i,k))-QV3D(I,K,J))*RDELT<a name='358'>
        ENDDO<a name='359'>
      ENDDO<a name='360'>
<a name='361'>
<font color=#447700>!===============================================================================<a name='362'></font>
<font color=#447700>!     ADD MOMENTUM MIXING TERM AS TENDENCIES. This is gopal's doing for SAS<a name='363'></font>
<font color=#447700>!     MOMMIX is the reduction factor set to 0.7 by default. Because NMM has <a name='364'></font>
<font color=#447700>!     divergence damping term, a reducion factor for cumulum mixing may be<a name='365'></font>
<font color=#447700>!     required otherwise storms were too weak.<a name='366'></font>
<font color=#447700>!===============================================================================<a name='367'></font>
<font color=#447700>!<a name='368'></font>
#if (NMM_CORE == 1)<a name='369'>
      DO K=KTS,KTE<a name='370'>
        DO I=ITS,ITE<a name='371'>
         RUCUTEN(I,J,K)=MOMMIX*(U1(I,K)-U3D(I,K,J))*RDELT<a name='372'>
         RVCUTEN(I,J,K)=MOMMIX*(V1(I,K)-V3D(I,K,J))*RDELT<a name='373'>
        ENDDO<a name='374'>
      ENDDO<a name='375'>
#endif<a name='376'>
<a name='377'>
<a name='378'>
      IF(P_QC .ge. P_FIRST_SCALAR)THEN<a name='379'>
        DO K=KTS,KTE<a name='380'>
          DO I=ITS,ITE<a name='381'>
            RQCCUTEN(I,K,J)=(QL(I,K,2)/(1.-ql(i,k,2))-QC3D(I,K,J))*RDELT<a name='382'>
          ENDDO<a name='383'>
        ENDDO<a name='384'>
      ENDIF<a name='385'>
<a name='386'>
      IF(P_QI .ge. P_FIRST_SCALAR)THEN<a name='387'>
        DO K=KTS,KTE<a name='388'>
          DO I=ITS,ITE<a name='389'>
            RQICUTEN(I,K,J)=(QL(I,K,1)/(1.-ql(i,k,1))-QI3D(I,K,J))*RDELT<a name='390'>
          ENDDO<a name='391'>
        ENDDO<a name='392'>
      ENDIF<a name='393'>
<a name='394'>
   ENDDO    <font color=#447700>! Outer most J loop<a name='395'></font>
<a name='396'>
   END SUBROUTINE CU_OSAS<a name='397'>
<a name='398'>
<font color=#447700>!====================================================================<a name='399'></font>
<A NAME='OSASINIT'><A href='../../html_code/phys/module_cu_osas.F.html#OSASINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='400'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>osasinit</font>(RTHCUTEN,RQVCUTEN,RQCCUTEN,RQICUTEN,          &amp; <A href='../../call_to/OSASINIT.html' TARGET='index'>1</A><a name='401'>
                      RUCUTEN,RVCUTEN,                              &amp;   <font color=#447700>! gopal's doing for SAS<a name='402'></font>
                      RESTART,P_QC,P_QI,P_FIRST_SCALAR,             &amp;<a name='403'>
                      allowed_to_read,                              &amp;<a name='404'>
                      ids, ide, jds, jde, kds, kde,                 &amp;<a name='405'>
                      ims, ime, jms, jme, kms, kme,                 &amp;<a name='406'>
                      its, ite, jts, jte, kts, kte                  )<a name='407'>
<font color=#447700>!--------------------------------------------------------------------<a name='408'></font>
   IMPLICIT NONE<a name='409'>
<font color=#447700>!--------------------------------------------------------------------<a name='410'></font>
   LOGICAL , INTENT(IN)           ::  allowed_to_read,restart<a name='411'>
   INTEGER , INTENT(IN)           ::  ids, ide, jds, jde, kds, kde, &amp;<a name='412'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='413'>
                                      its, ite, jts, jte, kts, kte<a name='414'>
   INTEGER , INTENT(IN)           ::  P_FIRST_SCALAR, P_QI, P_QC<a name='415'>
<a name='416'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::  &amp;<a name='417'>
                                                              RTHCUTEN, &amp;<a name='418'>
                                                              RQVCUTEN, &amp;<a name='419'>
                                                              RQCCUTEN, &amp;<a name='420'>
                                                              RQICUTEN<a name='421'>
   REAL,     DIMENSION( ims:ime , jms:jme , kms:kme ) , INTENT(OUT) ::  &amp;<a name='422'>
                                                              RUCUTEN,  &amp; <font color=#447700>! gopal's doing for SAS<a name='423'></font>
                                                              RVCUTEN   <a name='424'>
<a name='425'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='426'>
<a name='427'>
   jtf=min0(jte,jde-1)<a name='428'>
   ktf=min0(kte,kde-1)<a name='429'>
   itf=min0(ite,ide-1)<a name='430'>
<a name='431'>
#if ( HWRF == 1 )<a name='432'>
<font color=#447700>!zhang's doing<a name='433'></font>
   IF(.not.restart .or. .not.allowed_to_read)THEN<a name='434'>
<font color=#447700>!end of zhang's doing<a name='435'></font>
#else<a name='436'>
   IF(.not.restart)THEN<a name='437'>
#endif<a name='438'>
     DO j=jts,jtf<a name='439'>
     DO k=kts,ktf<a name='440'>
     DO i=its,itf<a name='441'>
       RTHCUTEN(i,k,j)=0.<a name='442'>
       RQVCUTEN(i,k,j)=0.<a name='443'>
       RUCUTEN(i,j,k)=0.   <font color=#447700>! gopal's doing for SAS<a name='444'></font>
       RVCUTEN(i,j,k)=0.    <font color=#447700>! gopal's doing for SAS<a name='445'></font>
     ENDDO<a name='446'>
     ENDDO<a name='447'>
     ENDDO<a name='448'>
<a name='449'>
     IF (P_QC .ge. P_FIRST_SCALAR) THEN<a name='450'>
        DO j=jts,jtf<a name='451'>
        DO k=kts,ktf<a name='452'>
        DO i=its,itf<a name='453'>
           RQCCUTEN(i,k,j)=0.<a name='454'>
        ENDDO<a name='455'>
        ENDDO<a name='456'>
        ENDDO<a name='457'>
     ENDIF<a name='458'>
<a name='459'>
     IF (P_QI .ge. P_FIRST_SCALAR) THEN<a name='460'>
        DO j=jts,jtf<a name='461'>
        DO k=kts,ktf<a name='462'>
        DO i=its,itf<a name='463'>
           RQICUTEN(i,k,j)=0.<a name='464'>
        ENDDO<a name='465'>
        ENDDO<a name='466'>
        ENDDO<a name='467'>
     ENDIF<a name='468'>
   ENDIF<a name='469'>
<a name='470'>
      END SUBROUTINE osasinit<a name='471'>
<a name='472'>
<font color=#447700>! ------------------------------------------------------------------------<a name='473'></font>
<a name='474'>
<A NAME='OSASCNV'><A href='../../html_code/phys/module_cu_osas.F.html#OSASCNV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='475'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>OSASCNV</font>(IM,IX,KM,JCAP,DELT,DEL,PRSL,PS,PHIL,QL,         &amp; <A href='../../call_to/OSASCNV.html' TARGET='index'>1</A>,<A href='../../call_from/OSASCNV.html' TARGET='index'>3</A><a name='476'>
     &amp;       Q1,T1,U1,V1,RCS,CLDWRK,RN,KBOT,KTOP,KUO,SLIMSK,            &amp;<a name='477'>
     &amp;       DOT,XKT2,ncloud)<a name='478'>
<font color=#447700>!  for cloud water version<a name='479'></font>
<font color=#447700>!     parameter(ncloud=0)<a name='480'></font>
<font color=#447700>!     SUBROUTINE OSASCNV(KM,JCAP,DELT,DEL,SL,SLK,PS,QL,<a name='481'></font>
<font color=#447700>!    &amp;       Q1,T1,U1,V1,RCS,CLDWRK,RN,KBOT,KTOP,KUO,SLIMSK,<a name='482'></font>
<font color=#447700>!    &amp;       DOT,xkt2,ncloud)<a name='483'></font>
<font color=#447700>!<a name='484'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_cu_osas.F.html#OSASCNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_12"> , ONLY : kind_phys<a name='485'>
      USE <A href='../../html_code/phys/module_gfs_funcphys.F.html#MODULE_GFS_FUNCPHYS'>MODULE_GFS_FUNCPHYS</A><A href='../../html_code/phys/module_cu_osas.F.html#OSASCNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_FUNCPHYS_2"> ,ONLY : fpvs<a name='486'>
      USE <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_PHYSCONS</A><A href='../../html_code/phys/module_cu_osas.F.html#OSASCNV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_6">, grav =&gt; con_g, CP =&gt; con_CP, HVAP =&gt; con_HVAP &amp;<a name='487'>
     &amp;,             RV =&gt; con_RV, FV =&gt; con_fvirt, T0C =&gt; con_T0C       &amp;<a name='488'>
     &amp;,             CVAP =&gt; con_CVAP, CLIQ =&gt; con_CLIQ                  &amp;<a name='489'>
     &amp;,             EPS =&gt; con_eps, EPSM1 =&gt; con_epsm1<a name='490'>
<a name='491'>
      implicit none<a name='492'>
<font color=#447700>!<a name='493'></font>
<font color=#447700>!     include 'constant.h'<a name='494'></font>
<font color=#447700>!<a name='495'></font>
      integer            IM, IX,  KM, JCAP, ncloud,                     &amp;<a name='496'>
     &amp;                   KBOT(IM), KTOP(IM), KUO(IM), J<a name='497'>
      real(kind=kind_phys) DELT<a name='498'>
      real(kind=kind_phys) PS(IM),      DEL(IX,KM),  PRSL(IX,KM),       &amp;<a name='499'>
<font color=#447700>!     real(kind=kind_phys)              DEL(IX,KM),  PRSL(IX,KM),<a name='500'></font>
     &amp;                     QL(IX,KM,2), Q1(IX,KM),   T1(IX,KM),         &amp;<a name='501'>
     &amp;                     U1(IX,KM),   V1(IX,KM),   RCS(IM),           &amp;<a name='502'>
     &amp;                     CLDWRK(IM),  RN(IM),      SLIMSK(IM),        &amp;<a name='503'>
     &amp;                     DOT(IX,KM),  XKT2(IM),    PHIL(IX,KM)<a name='504'>
<font color=#447700>!<a name='505'></font>
      integer              I, INDX, jmn, k, knumb, latd, lond, km1<a name='506'>
<font color=#447700>!<a name='507'></font>
      real(kind=kind_phys) adw,     alpha,   alphal,  alphas,           &amp;<a name='508'>
     &amp;                     aup,     beta,    betal,   betas,            &amp;<a name='509'>
     &amp;                     c0,      cpoel,   dellat,  delta,            &amp;<a name='510'>
     &amp;                     desdt,   deta,    detad,   dg,               &amp;<a name='511'>
     &amp;                     dh,      dhh,     dlnsig,  dp,               &amp;<a name='512'>
     &amp;                     dq,      dqsdp,   dqsdt,   dt,               &amp;<a name='513'>
     &amp;                     dt2,     dtmax,   dtmin,   dv1,              &amp;<a name='514'>
     &amp;                     dv1q,    dv2,     dv2q,    dv1u,             &amp;<a name='515'>
     &amp;                     dv1v,    dv2u,    dv2v,    dv3u,             &amp;<a name='516'>
     &amp;                     dv3v,    dv3,     dv3q,    dvq1,             &amp;<a name='517'>
     &amp;                     dz,      dz1,     e1,      edtmax,           &amp;<a name='518'>
     &amp;                     edtmaxl, edtmaxs, el2orc,  elocp,            &amp;<a name='519'>
     &amp;                     es,      etah,                               &amp;<a name='520'>
     &amp;                     evef,    evfact,  evfactl, fact1,            &amp;<a name='521'>
     &amp;                     fact2,   factor,  fjcap,   fkm,              &amp;<a name='522'>
     &amp;                     fuv,     g,       gamma,   onemf,            &amp;<a name='523'>
     &amp;                     onemfu,  pdetrn,  pdpdwn,  pprime,           &amp;<a name='524'>
     &amp;                     qc,      qlk,     qrch,    qs,               &amp;<a name='525'>
     &amp;                     rain,    rfact,   shear,   tem1,             &amp;<a name='526'>
     &amp;                     tem2,    terr,    val,     val1,             &amp;<a name='527'>
     &amp;                     val2,    w1,      w1l,     w1s,              &amp;<a name='528'>
     &amp;                     w2,      w2l,     w2s,     w3,               &amp;<a name='529'>
     &amp;                     w3l,     w3s,     w4,      w4l,              &amp; <a name='530'>
     &amp;                     w4s,     xdby,    xpw,     xpwd,             &amp; <a name='531'>
     &amp;                     xqc,     xqrch,   xlambu,  mbdt,             &amp;<a name='532'>
     &amp;                     tem<a name='533'>
<font color=#447700>!<a name='534'></font>
<font color=#447700>!<a name='535'></font>
      integer              JMIN(IM), KB(IM), KBCON(IM), KBDTR(IM),      &amp; <a name='536'>
     &amp;                     KT2(IM),  KTCON(IM), LMIN(IM),               &amp;<a name='537'>
     &amp;                     kbm(IM),  kbmax(IM), kmax(IM)<a name='538'>
<font color=#447700>!<a name='539'></font>
      real(kind=kind_phys) AA1(IM),     ACRT(IM),   ACRTFCT(IM),        &amp; <a name='540'>
     &amp;                     DELHBAR(IM), DELQ(IM),   DELQ2(IM),          &amp;<a name='541'>
     &amp;                     DELQBAR(IM), DELQEV(IM), DELTBAR(IM),        &amp;<a name='542'>
     &amp;                     DELTV(IM),   DTCONV(IM), EDT(IM),            &amp;<a name='543'>
     &amp;                     EDTO(IM),    EDTX(IM),   FLD(IM),            &amp;<a name='544'>
     &amp;                     HCDO(IM),    HKBO(IM),   HMAX(IM),           &amp;<a name='545'>
     &amp;                     HMIN(IM),    HSBAR(IM),  UCDO(IM),           &amp;<a name='546'>
     &amp;                     UKBO(IM),    VCDO(IM),   VKBO(IM),           &amp;<a name='547'>
     &amp;                     PBCDIF(IM),  PDOT(IM),   PO(IM,KM),          &amp;<a name='548'>
     &amp;                                  PWAVO(IM),  PWEVO(IM),          &amp;<a name='549'>
<font color=#447700>!    &amp;                     PSFC(IM),    PWAVO(IM),  PWEVO(IM),          &amp;<a name='550'></font>
     &amp;                     QCDO(IM),    QCOND(IM),  QEVAP(IM),          &amp;<a name='551'>
     &amp;                     QKBO(IM),    RNTOT(IM),  VSHEAR(IM),         &amp;<a name='552'>
     &amp;                     XAA0(IM),    XHCD(IM),   XHKB(IM),           &amp; <a name='553'>
     &amp;                     XK(IM),      XLAMB(IM),  XLAMD(IM),          &amp;<a name='554'>
     &amp;                     XMB(IM),     XMBMAX(IM), XPWAV(IM),          &amp;<a name='555'>
     &amp;                     XPWEV(IM),   XQCD(IM),   XQKB(IM)<a name='556'>
<font color=#447700>!<a name='557'></font>
<font color=#447700>!  PHYSICAL PARAMETERS<a name='558'></font>
      PARAMETER(G=grav)<a name='559'>
      PARAMETER(CPOEL=CP/HVAP,ELOCP=HVAP/CP,                            &amp;<a name='560'>
     &amp;          EL2ORC=HVAP*HVAP/(RV*CP))<a name='561'>
      PARAMETER(TERR=0.,C0=.002,DELTA=fv)<a name='562'>
      PARAMETER(FACT1=(CVAP-CLIQ)/RV,FACT2=HVAP/RV-FACT1*T0C)<a name='563'>
<font color=#447700>!  LOCAL VARIABLES AND ARRAYS<a name='564'></font>
      real(kind=kind_phys) PFLD(IM,KM),    TO(IM,KM),     QO(IM,KM),    &amp;<a name='565'>
     &amp;                     UO(IM,KM),      VO(IM,KM),     QESO(IM,KM)<a name='566'>
<font color=#447700>!  cloud water<a name='567'></font>
      real(kind=kind_phys) QLKO_KTCON(IM), DELLAL(IM),    TVO(IM,KM),   &amp;<a name='568'>
     &amp;                     DBYO(IM,KM),    ZO(IM,KM),     SUMZ(IM,KM),  &amp;<a name='569'>
     &amp;                     SUMH(IM,KM),    HEO(IM,KM),    HESO(IM,KM),  &amp;<a name='570'>
     &amp;                     QRCD(IM,KM),    DELLAH(IM,KM), DELLAQ(IM,KM),&amp;<a name='571'>
     &amp;                     DELLAU(IM,KM),  DELLAV(IM,KM), HCKO(IM,KM),  &amp;<a name='572'>
     &amp;                     UCKO(IM,KM),    VCKO(IM,KM),   QCKO(IM,KM),  &amp;<a name='573'>
     &amp;                     ETA(IM,KM),     ETAU(IM,KM),   ETAD(IM,KM),  &amp;<a name='574'>
     &amp;                     QRCDO(IM,KM),   PWO(IM,KM),    PWDO(IM,KM),  &amp;<a name='575'>
     &amp;                     RHBAR(IM),      TX1(IM)<a name='576'>
<font color=#447700>!<a name='577'></font>
      LOGICAL TOTFLG, CNVFLG(IM), DWNFLG(IM), DWNFLG2(IM), FLG(IM)<a name='578'>
<font color=#447700>!<a name='579'></font>
      real(kind=kind_phys) PCRIT(15), ACRITT(15), ACRIT(15)<a name='580'>
<font color=#447700>!     SAVE PCRIT, ACRITT<a name='581'></font>
      DATA PCRIT/850.,800.,750.,700.,650.,600.,550.,500.,450.,400.,     &amp;<a name='582'>
     &amp;           350.,300.,250.,200.,150./<a name='583'>
      DATA ACRITT/.0633,.0445,.0553,.0664,.075,.1082,.1521,.2216,       &amp;<a name='584'>
     &amp;           .3151,.3677,.41,.5255,.7663,1.1686,1.6851/<a name='585'>
<font color=#447700>!  GDAS DERIVED ACRIT<a name='586'></font>
<font color=#447700>!     DATA ACRITT/.203,.515,.521,.566,.625,.665,.659,.688,              &amp; <a name='587'></font>
<font color=#447700>!    &amp;            .743,.813,.886,.947,1.138,1.377,1.896/<a name='588'></font>
<font color=#447700>!<a name='589'></font>
      real(kind=kind_phys) TF, TCR, TCRF, RZERO, RONE<a name='590'>
      parameter (TF=233.16, TCR=263.16, TCRF=1.0/(TCR-TF))<a name='591'>
      parameter (RZERO=0.0,RONE=1.0)<a name='592'>
<font color=#447700>!-----------------------------------------------------------------------<a name='593'></font>
<font color=#447700>!<a name='594'></font>
      km1 = km - 1<a name='595'>
<font color=#447700>!  INITIALIZE ARRAYS<a name='596'></font>
<font color=#447700>!<a name='597'></font>
      DO I=1,IM<a name='598'>
        RN(I)=0.<a name='599'>
        KBOT(I)=KM+1<a name='600'>
        KTOP(I)=0<a name='601'>
        KUO(I)=0<a name='602'>
        CNVFLG(I) = .TRUE.<a name='603'>
        DTCONV(I) = 3600.<a name='604'>
        CLDWRK(I) = 0.<a name='605'>
        PDOT(I) = 0.<a name='606'>
        KT2(I) = 0<a name='607'>
        QLKO_KTCON(I) = 0.<a name='608'>
        DELLAL(I) = 0.<a name='609'>
      ENDDO<a name='610'>
<font color=#447700>!!<a name='611'></font>
      DO K = 1, 15<a name='612'>
        ACRIT(K) = ACRITT(K) * (975. - PCRIT(K))<a name='613'>
      ENDDO<a name='614'>
      DT2 = DELT<a name='615'>
<font color=#447700>!cmr  dtmin = max(dt2,1200.)<a name='616'></font>
      val   =         1200.<a name='617'>
      dtmin = max(dt2, val )<a name='618'>
<font color=#447700>!cmr  dtmax = max(dt2,3600.)<a name='619'></font>
      val   =         3600.<a name='620'>
      dtmax = max(dt2, val )<a name='621'>
<font color=#447700>!  MODEL TUNABLE PARAMETERS ARE ALL HERE<a name='622'></font>
      MBDT    = 10.<a name='623'>
      EDTMAXl = .3<a name='624'>
      EDTMAXs = .3<a name='625'>
      ALPHAl  = .5<a name='626'>
      ALPHAs  = .5<a name='627'>
      BETAl   = .15<a name='628'>
      betas   = .15<a name='629'>
      BETAl   = .05<a name='630'>
      betas   = .05<a name='631'>
<font color=#447700>!     change for hurricane model<a name='632'></font>
        BETAl = .5<a name='633'>
        betas = .5<a name='634'>
<font color=#447700>!     EVEF    = 0.07<a name='635'></font>
      evfact  = 0.3<a name='636'>
      evfactl = 0.3<a name='637'>
<font color=#447700>!     change for hurricane model<a name='638'></font>
         evfact = 0.6<a name='639'>
         evfactl = .6<a name='640'>
#if ( EM_CORE == 1 )<a name='641'>
<font color=#447700>!  HAWAII TEST - ZCX<a name='642'></font>
      ALPHAl  = .5<a name='643'>
      ALPHAs  = .75<a name='644'>
      BETAl   = .05<a name='645'>
      betas   = .05<a name='646'>
      evfact  = 0.5<a name='647'>
      evfactl = 0.5<a name='648'>
#endif<a name='649'>
      PDPDWN  = 0.<a name='650'>
      PDETRN  = 200.<a name='651'>
      xlambu  = 1.e-4<a name='652'>
      fjcap   = (float(jcap) / 126.) ** 2<a name='653'>
<font color=#447700>!cmr  fjcap   = max(fjcap,1.)<a name='654'></font>
      val     =           1.<a name='655'>
      fjcap   = max(fjcap,val)<a name='656'>
      fkm     = (float(km) / 28.) ** 2<a name='657'>
<font color=#447700>!cmr  fkm     = max(fkm,1.)<a name='658'></font>
      fkm     = max(fkm,val)<a name='659'>
      W1l     = -8.E-3 <a name='660'>
      W2l     = -4.E-2<a name='661'>
      W3l     = -5.E-3 <a name='662'>
      W4l     = -5.E-4<a name='663'>
      W1s     = -2.E-4<a name='664'>
      W2s     = -2.E-3<a name='665'>
      W3s     = -1.E-3<a name='666'>
      W4s     = -2.E-5<a name='667'>
<font color=#447700>!CCCC IF(IM.EQ.384) THEN<a name='668'></font>
        LATD  = 92<a name='669'>
        lond  = 189<a name='670'>
<font color=#447700>!CCCC ELSEIF(IM.EQ.768) THEN<a name='671'></font>
<font color=#447700>!CCCC   LATD = 80<a name='672'></font>
<font color=#447700>!CCCC ELSE<a name='673'></font>
<font color=#447700>!CCCC   LATD = 0<a name='674'></font>
<font color=#447700>!CCCC ENDIF<a name='675'></font>
<font color=#447700>!<a name='676'></font>
<font color=#447700>!  DEFINE TOP LAYER FOR SEARCH OF THE DOWNDRAFT ORIGINATING LAYER<a name='677'></font>
<font color=#447700>!  AND THE MAXIMUM THETAE FOR UPDRAFT<a name='678'></font>
<font color=#447700>!<a name='679'></font>
      DO I=1,IM<a name='680'>
        KBMAX(I) = KM<a name='681'>
        KBM(I)   = KM<a name='682'>
        KMAX(I)  = KM<a name='683'>
        TX1(I)   = 1.0 / PS(I)<a name='684'>
      ENDDO<a name='685'>
<font color=#447700>!     <a name='686'></font>
      DO K = 1, KM<a name='687'>
        DO I=1,IM<a name='688'>
          IF (prSL(I,K)*tx1(I) .GT. 0.45) KBMAX(I) = K + 1<a name='689'>
          IF (prSL(I,K)*tx1(I) .GT. 0.70) KBM(I)   = K + 1<a name='690'>
          IF (prSL(I,K)*tx1(I) .GT. 0.04) KMAX(I)  = MIN(KM,K + 1)<a name='691'>
        ENDDO<a name='692'>
      ENDDO<a name='693'>
      DO I=1,IM<a name='694'>
        KBMAX(I) = MIN(KBMAX(I),KMAX(I))<a name='695'>
        KBM(I)   = MIN(KBM(I),KMAX(I))<a name='696'>
      ENDDO<a name='697'>
<font color=#447700>!<a name='698'></font>
<font color=#447700>!   CONVERT SURFACE PRESSURE TO MB FROM CB<a name='699'></font>
<font color=#447700>!<a name='700'></font>
<font color=#447700>!!<a name='701'></font>
      DO K = 1, KM<a name='702'>
        DO I=1,IM<a name='703'>
          if (K .le. kmax(i)) then<a name='704'>
            PFLD(I,k) = PRSL(I,K) * 10.0<a name='705'>
            PWO(I,k)  = 0.<a name='706'>
            PWDO(I,k) = 0.<a name='707'>
            TO(I,k)   = T1(I,k)<a name='708'>
            QO(I,k)   = Q1(I,k)<a name='709'>
            UO(I,k)   = U1(I,k)<a name='710'>
            VO(I,k)   = V1(I,k)<a name='711'>
            DBYO(I,k) = 0.<a name='712'>
            SUMZ(I,k) = 0.<a name='713'>
            SUMH(I,k) = 0.<a name='714'>
          endif<a name='715'>
        ENDDO<a name='716'>
      ENDDO<a name='717'>
<a name='718'>
<font color=#447700>!<a name='719'></font>
<font color=#447700>!  COLUMN VARIABLES<a name='720'></font>
<font color=#447700>!  P IS PRESSURE OF THE LAYER (MB)<a name='721'></font>
<font color=#447700>!  T IS TEMPERATURE AT T-DT (K)..TN<a name='722'></font>
<font color=#447700>!  Q IS MIXING RATIO AT T-DT (KG/KG)..QN<a name='723'></font>
<font color=#447700>!  TO IS TEMPERATURE AT T+DT (K)... THIS IS AFTER ADVECTION AND TURBULAN<a name='724'></font>
<font color=#447700>!  QO IS MIXING RATIO AT T+DT (KG/KG)..Q1<a name='725'></font>
<font color=#447700>!<a name='726'></font>
      DO K = 1, KM<a name='727'>
        DO I=1,IM<a name='728'>
          if (k .le. kmax(i)) then<a name='729'>
         <font color=#447700>!jfe        QESO(I,k) = 10. * FPVS(T1(I,k))<a name='730'></font>
         <font color=#447700>!<a name='731'></font>
            QESO(I,k) = 0.01 * fpvs(T1(I,K))      <font color=#447700>! fpvs is in Pa<a name='732'></font>
         <font color=#447700>!<a name='733'></font>
            QESO(I,k) = EPS * QESO(I,k) / (PFLD(I,k) + EPSM1*QESO(I,k))<a name='734'>
         <font color=#447700>!cmr        QESO(I,k) = MAX(QESO(I,k),1.E-8)<a name='735'></font>
            val1      =             1.E-8<a name='736'>
            QESO(I,k) = MAX(QESO(I,k), val1)<a name='737'>
         <font color=#447700>!cmr        QO(I,k)   = max(QO(I,k),1.e-10)<a name='738'></font>
            val2      =           1.e-10<a name='739'>
            QO(I,k)   = max(QO(I,k), val2 )<a name='740'>
         <font color=#447700>!           QO(I,k)   = MIN(QO(I,k),QESO(I,k))<a name='741'></font>
            TVO(I,k)  = TO(I,k) + DELTA * TO(I,k) * QO(I,k)<a name='742'>
          endif<a name='743'>
        ENDDO<a name='744'>
      ENDDO<a name='745'>
<a name='746'>
<font color=#447700>!<a name='747'></font>
<font color=#447700>!  HYDROSTATIC HEIGHT ASSUME ZERO TERR<a name='748'></font>
<font color=#447700>!<a name='749'></font>
      DO K = 1, KM<a name='750'>
        DO I=1,IM<a name='751'>
          ZO(I,k) = PHIL(I,k) / G<a name='752'>
        ENDDO<a name='753'>
      ENDDO<a name='754'>
<font color=#447700>!  COMPUTE MOIST STATIC ENERGY<a name='755'></font>
      DO K = 1, KM<a name='756'>
        DO I=1,IM<a name='757'>
          if (K .le. kmax(i)) then<a name='758'>
<font color=#447700>!           tem       = G * ZO(I,k) + CP * TO(I,k)<a name='759'></font>
            tem       = PHIL(I,k) + CP * TO(I,k)<a name='760'>
            HEO(I,k)  = tem  + HVAP * QO(I,k)<a name='761'>
            HESO(I,k) = tem  + HVAP * QESO(I,k)<a name='762'>
<font color=#447700>!           HEO(I,k)  = MIN(HEO(I,k),HESO(I,k))<a name='763'></font>
          endif<a name='764'>
        ENDDO<a name='765'>
      ENDDO<a name='766'>
<font color=#447700>!<a name='767'></font>
<font color=#447700>!  DETERMINE LEVEL WITH LARGEST MOIST STATIC ENERGY<a name='768'></font>
<font color=#447700>!  THIS IS THE LEVEL WHERE UPDRAFT STARTS<a name='769'></font>
<font color=#447700>!<a name='770'></font>
      DO I=1,IM<a name='771'>
        HMAX(I) = HEO(I,1)<a name='772'>
        KB(I) = 1<a name='773'>
      ENDDO<a name='774'>
<font color=#447700>!!<a name='775'></font>
      DO K = 2, KM<a name='776'>
        DO I=1,IM<a name='777'>
          if (k .le. kbm(i)) then<a name='778'>
            IF(HEO(I,k).GT.HMAX(I).AND.CNVFLG(I)) THEN<a name='779'>
              KB(I)   = K<a name='780'>
              HMAX(I) = HEO(I,k)<a name='781'>
            ENDIF<a name='782'>
          endif<a name='783'>
        ENDDO<a name='784'>
      ENDDO<a name='785'>
<font color=#447700>!     DO K = 1, KMAX - 1<a name='786'></font>
<font color=#447700>!         TOL(k) = .5 * (TO(I,k) + TO(I,k+1))<a name='787'></font>
<font color=#447700>!         QOL(k) = .5 * (QO(I,k) + QO(I,k+1))<a name='788'></font>
<font color=#447700>!         QESOL(I,k) = .5 * (QESO(I,k) + QESO(I,k+1))<a name='789'></font>
<font color=#447700>!         HEOL(I,k) = .5 * (HEO(I,k) + HEO(I,k+1))<a name='790'></font>
<font color=#447700>!         HESOL(I,k) = .5 * (HESO(I,k) + HESO(I,k+1))<a name='791'></font>
<font color=#447700>!     ENDDO<a name='792'></font>
      DO K = 1, KM1<a name='793'>
        DO I=1,IM<a name='794'>
          if (k .le. kmax(i)-1) then<a name='795'>
            DZ      = .5 * (ZO(I,k+1) - ZO(I,k))<a name='796'>
            DP      = .5 * (PFLD(I,k+1) - PFLD(I,k))<a name='797'>
<font color=#447700>!jfe        ES      = 10. * FPVS(TO(I,k+1))<a name='798'></font>
<font color=#447700>!<a name='799'></font>
            ES      = 0.01 * fpvs(TO(I,K+1))      <font color=#447700>! fpvs is in Pa<a name='800'></font>
<font color=#447700>!<a name='801'></font>
            PPRIME  = PFLD(I,k+1) + EPSM1 * ES<a name='802'>
            QS      = EPS * ES / PPRIME<a name='803'>
            DQSDP   = - QS / PPRIME<a name='804'>
            DESDT   = ES * (FACT1 / TO(I,k+1) + FACT2 / (TO(I,k+1)**2))<a name='805'>
            DQSDT   = QS * PFLD(I,k+1) * DESDT / (ES * PPRIME)<a name='806'>
            GAMMA   = EL2ORC * QESO(I,k+1) / (TO(I,k+1)**2)<a name='807'>
            DT      = (G * DZ + HVAP * DQSDP * DP) / (CP * (1. + GAMMA))<a name='808'>
            DQ      = DQSDT * DT + DQSDP * DP<a name='809'>
            TO(I,k) = TO(I,k+1) + DT<a name='810'>
            QO(I,k) = QO(I,k+1) + DQ<a name='811'>
            PO(I,k) = .5 * (PFLD(I,k) + PFLD(I,k+1))<a name='812'>
          endif<a name='813'>
        ENDDO<a name='814'>
      ENDDO<a name='815'>
<font color=#447700>!<a name='816'></font>
      DO K = 1, KM1<a name='817'>
        DO I=1,IM<a name='818'>
          if (k .le. kmax(I)-1) then<a name='819'>
<font color=#447700>!jfe        QESO(I,k) = 10. * FPVS(TO(I,k))<a name='820'></font>
<font color=#447700>!<a name='821'></font>
            QESO(I,k) = 0.01 * fpvs(TO(I,K))      <font color=#447700>! fpvs is in Pa<a name='822'></font>
<font color=#447700>!<a name='823'></font>
            QESO(I,k) = EPS * QESO(I,k) / (PO(I,k) + EPSM1*QESO(I,k))<a name='824'>
<font color=#447700>!cmr        QESO(I,k) = MAX(QESO(I,k),1.E-8)<a name='825'></font>
            val1      =             1.E-8<a name='826'>
            QESO(I,k) = MAX(QESO(I,k), val1)<a name='827'>
<font color=#447700>!cmr        QO(I,k)   = max(QO(I,k),1.e-10)<a name='828'></font>
            val2      =           1.e-10<a name='829'>
            QO(I,k)   = max(QO(I,k), val2 )<a name='830'>
<font color=#447700>!           QO(I,k)   = MIN(QO(I,k),QESO(I,k))<a name='831'></font>
            HEO(I,k)  = .5 * G * (ZO(I,k) + ZO(I,k+1)) +                &amp;<a name='832'>
     &amp;                  CP * TO(I,k) + HVAP * QO(I,k)<a name='833'>
            HESO(I,k) = .5 * G * (ZO(I,k) + ZO(I,k+1)) +                &amp; <a name='834'>
     &amp;                  CP * TO(I,k) + HVAP * QESO(I,k)<a name='835'>
            UO(I,k)   = .5 * (UO(I,k) + UO(I,k+1))<a name='836'>
            VO(I,k)   = .5 * (VO(I,k) + VO(I,k+1))<a name='837'>
          endif<a name='838'>
        ENDDO<a name='839'>
      ENDDO<a name='840'>
<font color=#447700>!     k = kmax<a name='841'></font>
<font color=#447700>!       HEO(I,k) = HEO(I,k)<a name='842'></font>
<font color=#447700>!       hesol(k) = HESO(I,k)<a name='843'></font>
<font color=#447700>!      IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I)) THEN<a name='844'></font>
<font color=#447700>!        PRINT *, '   HEO ='<a name='845'></font>
<font color=#447700>!        PRINT 6001, (HEO(I,K),K=1,KMAX)<a name='846'></font>
<font color=#447700>!        PRINT *, '   HESO ='<a name='847'></font>
<font color=#447700>!        PRINT 6001, (HESO(I,K),K=1,KMAX)<a name='848'></font>
<font color=#447700>!        PRINT *, '   TO ='<a name='849'></font>
<font color=#447700>!        PRINT 6002, (TO(I,K)-273.16,K=1,KMAX)<a name='850'></font>
<font color=#447700>!        PRINT *, '   QO ='<a name='851'></font>
<font color=#447700>!        PRINT 6003, (QO(I,K),K=1,KMAX)<a name='852'></font>
<font color=#447700>!        PRINT *, '   QSO ='<a name='853'></font>
<font color=#447700>!        PRINT 6003, (QESO(I,K),K=1,KMAX)<a name='854'></font>
<font color=#447700>!      ENDIF<a name='855'></font>
<font color=#447700>!<a name='856'></font>
<font color=#447700>!  LOOK FOR CONVECTIVE CLOUD BASE AS THE LEVEL OF FREE CONVECTION<a name='857'></font>
<font color=#447700>!<a name='858'></font>
      DO I=1,IM<a name='859'>
        IF(CNVFLG(I)) THEN<a name='860'>
          INDX    = KB(I)<a name='861'>
          HKBO(I) = HEO(I,INDX)<a name='862'>
          QKBO(I) = QO(I,INDX)<a name='863'>
          UKBO(I) = UO(I,INDX)<a name='864'>
          VKBO(I) = VO(I,INDX)<a name='865'>
        ENDIF<a name='866'>
        FLG(I)    = CNVFLG(I)<a name='867'>
        KBCON(I)  = KMAX(I)<a name='868'>
      ENDDO<a name='869'>
<font color=#447700>!!<a name='870'></font>
      DO K = 1, KM<a name='871'>
        DO I=1,IM<a name='872'>
          if (k .le. kbmax(i)) then<a name='873'>
            IF(FLG(I).AND.K.GT.KB(I)) THEN<a name='874'>
              HSBAR(I)   = HESO(I,k)<a name='875'>
              IF(HKBO(I).GT.HSBAR(I)) THEN<a name='876'>
                FLG(I)   = .FALSE.<a name='877'>
                KBCON(I) = K<a name='878'>
              ENDIF<a name='879'>
            ENDIF<a name='880'>
          endif<a name='881'>
        ENDDO<a name='882'>
      ENDDO<a name='883'>
      DO I=1,IM<a name='884'>
        IF(CNVFLG(I)) THEN<a name='885'>
          PBCDIF(I) = -PFLD(I,KBCON(I)) + PFLD(I,KB(I))<a name='886'>
          PDOT(I)   = 10.* DOT(I,KBCON(I))<a name='887'>
          IF(PBCDIF(I).GT.150.)    CNVFLG(I) = .FALSE.<a name='888'>
          IF(KBCON(I).EQ.KMAX(I))  CNVFLG(I) = .FALSE.<a name='889'>
        ENDIF<a name='890'>
      ENDDO<a name='891'>
<font color=#447700>!!<a name='892'></font>
      TOTFLG = .TRUE.<a name='893'>
      DO I=1,IM<a name='894'>
        TOTFLG = TOTFLG .AND. (.NOT. CNVFLG(I))<a name='895'>
      ENDDO<a name='896'>
      IF(TOTFLG) RETURN<a name='897'>
<font color=#447700>!  FOUND LFC, CAN DEFINE REST OF VARIABLES<a name='898'></font>
 6001 FORMAT(2X,-2P10F12.2)<a name='899'>
 6002 FORMAT(2X,10F12.2)<a name='900'>
 6003 FORMAT(2X,3P10F12.2)<a name='901'>
<a name='902'>
<font color=#447700>!<a name='903'></font>
<font color=#447700>!  DETERMINE ENTRAINMENT RATE BETWEEN KB AND KBCON<a name='904'></font>
<font color=#447700>!<a name='905'></font>
      DO I = 1, IM<a name='906'>
        alpha = alphas<a name='907'>
        if(SLIMSK(I).eq.1.) alpha = alphal<a name='908'>
        IF(CNVFLG(I)) THEN<a name='909'>
          IF(KB(I).EQ.1) THEN<a name='910'>
            DZ = .5 * (ZO(I,KBCON(I)) + ZO(I,KBCON(I)-1)) - ZO(I,1)<a name='911'>
          ELSE<a name='912'>
            DZ = .5 * (ZO(I,KBCON(I)) + ZO(I,KBCON(I)-1))               &amp;<a name='913'>
     &amp;         - .5 * (ZO(I,KB(I)) + ZO(I,KB(I)-1))<a name='914'>
          ENDIF<a name='915'>
          IF(KBCON(I).NE.KB(I)) THEN<a name='916'>
<font color=#447700>!cmr        XLAMB(I) = -ALOG(ALPHA) / DZ<a name='917'></font>
            XLAMB(I) = - LOG(ALPHA) / DZ<a name='918'>
          ELSE<a name='919'>
            XLAMB(I) = 0.<a name='920'>
          ENDIF<a name='921'>
        ENDIF<a name='922'>
      ENDDO<a name='923'>
<font color=#447700>!  DETERMINE UPDRAFT MASS FLUX<a name='924'></font>
      DO K = 1, KM<a name='925'>
        DO I = 1, IM<a name='926'>
          if (k .le. kmax(i) .and. CNVFLG(I)) then<a name='927'>
            ETA(I,k)  = 1.<a name='928'>
            ETAU(I,k) = 1.<a name='929'>
          ENDIF<a name='930'>
        ENDDO<a name='931'>
      ENDDO<a name='932'>
      DO K = KM1, 2, -1<a name='933'>
        DO I = 1, IM<a name='934'>
          if (k .le. kbmax(i)) then<a name='935'>
            IF(CNVFLG(I).AND.K.LT.KBCON(I).AND.K.GE.KB(I)) THEN<a name='936'>
              DZ        = .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='937'>
              ETA(I,k)  = ETA(I,k+1) * EXP(-XLAMB(I) * DZ)<a name='938'>
              ETAU(I,k) = ETA(I,k)<a name='939'>
            ENDIF<a name='940'>
          endif<a name='941'>
        ENDDO<a name='942'>
      ENDDO<a name='943'>
      DO I = 1, IM<a name='944'>
        IF(CNVFLG(I).AND.KB(I).EQ.1.AND.KBCON(I).GT.1) THEN<a name='945'>
          DZ = .5 * (ZO(I,2) - ZO(I,1))<a name='946'>
          ETA(I,1) = ETA(I,2) * EXP(-XLAMB(I) * DZ)<a name='947'>
          ETAU(I,1) = ETA(I,1)<a name='948'>
        ENDIF<a name='949'>
      ENDDO<a name='950'>
<font color=#447700>!<a name='951'></font>
<font color=#447700>!  WORK UP UPDRAFT CLOUD PROPERTIES<a name='952'></font>
<font color=#447700>!<a name='953'></font>
      DO I = 1, IM<a name='954'>
        IF(CNVFLG(I)) THEN<a name='955'>
          INDX         = KB(I)<a name='956'>
          HCKO(I,INDX) = HKBO(I)<a name='957'>
          QCKO(I,INDX) = QKBO(I)<a name='958'>
          UCKO(I,INDX) = UKBO(I)<a name='959'>
          VCKO(I,INDX) = VKBO(I)<a name='960'>
          PWAVO(I)     = 0.<a name='961'>
        ENDIF<a name='962'>
      ENDDO<a name='963'>
<font color=#447700>!<a name='964'></font>
<font color=#447700>!  CLOUD PROPERTY BELOW CLOUD BASE IS MODIFIED BY THE ENTRAINMENT PROCES<a name='965'></font>
<font color=#447700>!<a name='966'></font>
      DO K = 2, KM1<a name='967'>
        DO I = 1, IM<a name='968'>
          if (k .le. kmax(i)-1) then<a name='969'>
            IF(CNVFLG(I).AND.K.GT.KB(I).AND.K.LE.KBCON(I)) THEN<a name='970'>
              FACTOR = ETA(I,k-1) / ETA(I,k)<a name='971'>
              ONEMF = 1. - FACTOR<a name='972'>
              HCKO(I,k) = FACTOR * HCKO(I,k-1) + ONEMF *                &amp;<a name='973'>
     &amp;                    .5 * (HEO(I,k) + HEO(I,k+1))<a name='974'>
              UCKO(I,k) = FACTOR * UCKO(I,k-1) + ONEMF *                &amp; <a name='975'>
     &amp;                    .5 * (UO(I,k) + UO(I,k+1))<a name='976'>
              VCKO(I,k) = FACTOR * VCKO(I,k-1) + ONEMF *                &amp;<a name='977'>
     &amp;                    .5 * (VO(I,k) + VO(I,k+1))<a name='978'>
              DBYO(I,k) = HCKO(I,k) - HESO(I,k)<a name='979'>
            ENDIF<a name='980'>
            IF(CNVFLG(I).AND.K.GT.KBCON(I)) THEN<a name='981'>
              HCKO(I,k) = HCKO(I,k-1)<a name='982'>
              UCKO(I,k) = UCKO(I,k-1)<a name='983'>
              VCKO(I,k) = VCKO(I,k-1)<a name='984'>
              DBYO(I,k) = HCKO(I,k) - HESO(I,k)<a name='985'>
            ENDIF<a name='986'>
          endif<a name='987'>
        ENDDO<a name='988'>
      ENDDO<a name='989'>
<font color=#447700>!  DETERMINE CLOUD TOP<a name='990'></font>
      DO I = 1, IM<a name='991'>
        FLG(I) = CNVFLG(I)<a name='992'>
        KTCON(I) = 1<a name='993'>
      ENDDO<a name='994'>
<font color=#447700>!     DO K = 2, KMAX<a name='995'></font>
<font color=#447700>!       KK = KMAX - K + 1<a name='996'></font>
<font color=#447700>!         IF(DBYO(I,kK).GE.0..AND.FLG(I).AND.KK.GT.KBCON(I)) THEN<a name='997'></font>
<font color=#447700>!           KTCON(I) = KK + 1<a name='998'></font>
<font color=#447700>!           FLG(I) = .FALSE.<a name='999'></font>
<font color=#447700>!         ENDIF<a name='1000'></font>
<font color=#447700>!     ENDDO<a name='1001'></font>
      DO K = 2, KM<a name='1002'>
        DO I = 1, IM<a name='1003'>
          if (k .le. kmax(i)) then<a name='1004'>
            IF(DBYO(I,k).LT.0..AND.FLG(I).AND.K.GT.KBCON(I)) THEN<a name='1005'>
              KTCON(I) = K<a name='1006'>
              FLG(I) = .FALSE.<a name='1007'>
            ENDIF<a name='1008'>
          endif<a name='1009'>
        ENDDO<a name='1010'>
      ENDDO<a name='1011'>
      DO I = 1, IM<a name='1012'>
        IF(CNVFLG(I).AND.(PFLD(I,KBCON(I)) - PFLD(I,KTCON(I))).LT.150.) &amp;<a name='1013'>
     &amp;  CNVFLG(I) = .FALSE.<a name='1014'>
      ENDDO<a name='1015'>
      TOTFLG = .TRUE.<a name='1016'>
      DO I = 1, IM<a name='1017'>
        TOTFLG = TOTFLG .AND. (.NOT. CNVFLG(I))<a name='1018'>
      ENDDO<a name='1019'>
      IF(TOTFLG) RETURN<a name='1020'>
<font color=#447700>!<a name='1021'></font>
<font color=#447700>!  SEARCH FOR DOWNDRAFT ORIGINATING LEVEL ABOVE THETA-E MINIMUM<a name='1022'></font>
<font color=#447700>!<a name='1023'></font>
      DO I = 1, IM<a name='1024'>
        HMIN(I) = HEO(I,KBCON(I))<a name='1025'>
        LMIN(I) = KBMAX(I)<a name='1026'>
        JMIN(I) = KBMAX(I)<a name='1027'>
      ENDDO<a name='1028'>
      DO I = 1, IM<a name='1029'>
        DO K = KBCON(I), KBMAX(I)<a name='1030'>
          IF(HEO(I,k).LT.HMIN(I).AND.CNVFLG(I)) THEN<a name='1031'>
            LMIN(I) = K + 1<a name='1032'>
            HMIN(I) = HEO(I,k)<a name='1033'>
          ENDIF<a name='1034'>
        ENDDO<a name='1035'>
      ENDDO<a name='1036'>
<font color=#447700>!<a name='1037'></font>
<font color=#447700>!  Make sure that JMIN(I) is within the cloud<a name='1038'></font>
<font color=#447700>!<a name='1039'></font>
      DO I = 1, IM<a name='1040'>
        IF(CNVFLG(I)) THEN<a name='1041'>
          JMIN(I) = MIN(LMIN(I),KTCON(I)-1)<a name='1042'>
          XMBMAX(I) = .1<a name='1043'>
          JMIN(I) = MAX(JMIN(I),KBCON(I)+1)<a name='1044'>
        ENDIF<a name='1045'>
      ENDDO<a name='1046'>
<font color=#447700>!<a name='1047'></font>
<font color=#447700>!  ENTRAINING CLOUD<a name='1048'></font>
<font color=#447700>!<a name='1049'></font>
      do k = 2, km1<a name='1050'>
        DO I = 1, IM<a name='1051'>
          if (k .le. kmax(i)-1) then<a name='1052'>
            if(CNVFLG(I).and.k.gt.JMIN(I).and.k.le.KTCON(I)) THEN<a name='1053'>
              SUMZ(I,k) = SUMZ(I,k-1) + .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1054'>
              SUMH(I,k) = SUMH(I,k-1) + .5 * (ZO(I,k+1) - ZO(I,k-1))    &amp;<a name='1055'>
     &amp;                  * HEO(I,k)<a name='1056'>
            ENDIF<a name='1057'>
          endif<a name='1058'>
        enddo<a name='1059'>
      enddo<a name='1060'>
<font color=#447700>!!<a name='1061'></font>
      DO I = 1, IM<a name='1062'>
        IF(CNVFLG(I)) THEN<a name='1063'>
<font color=#447700>!         call random_number(XKT2)<a name='1064'></font>
<font color=#447700>!         call srand(fhour)<a name='1065'></font>
<font color=#447700>!         XKT2(I) = rand()<a name='1066'></font>
          KT2(I) = nint(XKT2(I)*float(KTCON(I)-JMIN(I))-.5)+JMIN(I)+1<a name='1067'>
<font color=#447700>!         KT2(I) = nint(sqrt(XKT2(I))*float(KTCON(I)-JMIN(I))-.5) + JMIN(I) + 1<a name='1068'></font>
<font color=#447700>!         KT2(I) = nint(ranf() *float(KTCON(I)-JMIN(I))-.5) + JMIN(I) + 1<a name='1069'></font>
          tem1 = (HCKO(I,JMIN(I)) - HESO(I,KT2(I)))<a name='1070'>
          tem2 = (SUMZ(I,KT2(I)) * HESO(I,KT2(I)) - SUMH(I,KT2(I)))<a name='1071'>
          if (abs(tem2) .gt. 0.000001) THEN<a name='1072'>
            XLAMB(I) = tem1 / tem2<a name='1073'>
          else<a name='1074'>
            CNVFLG(I) = .false.<a name='1075'>
          ENDIF<a name='1076'>
<font color=#447700>!         XLAMB(I) = (HCKO(I,JMIN(I)) - HESO(I,KT2(I)))<a name='1077'></font>
<font color=#447700>!    &amp;          / (SUMZ(I,KT2(I)) * HESO(I,KT2(I)) - SUMH(I,KT2(I)))<a name='1078'></font>
          XLAMB(I) = max(XLAMB(I),RZERO)<a name='1079'>
          XLAMB(I) = min(XLAMB(I),2.3/SUMZ(I,KT2(I)))<a name='1080'>
        ENDIF<a name='1081'>
      ENDDO<a name='1082'>
<font color=#447700>!!<a name='1083'></font>
      DO I = 1, IM<a name='1084'>
       DWNFLG(I)  = CNVFLG(I)<a name='1085'>
       DWNFLG2(I) = CNVFLG(I)<a name='1086'>
       IF(CNVFLG(I)) THEN<a name='1087'>
        if(KT2(I).ge.KTCON(I)) DWNFLG(I) = .false.<a name='1088'>
      if(XLAMB(I).le.1.e-30.or.HCKO(I,JMIN(I))-HESO(I,KT2(I)).le.1.e-30)&amp;<a name='1089'>
     &amp;  DWNFLG(I) = .false.<a name='1090'>
        do k = JMIN(I), KT2(I)<a name='1091'>
          if(DWNFLG(I).and.HEO(I,k).gt.HESO(I,KT2(I))) DWNFLG(I)=.false.<a name='1092'>
        enddo<a name='1093'>
<font color=#447700>!       IF(CNVFLG(I).AND.(PFLD(KBCON(I))-PFLD(KTCON(I))).GT.PDETRN)<a name='1094'></font>
<font color=#447700>!    &amp;     DWNFLG(I)=.FALSE.<a name='1095'></font>
        IF(CNVFLG(I).AND.(PFLD(I,KBCON(I))-PFLD(I,KTCON(I))).LT.PDPDWN) &amp;<a name='1096'>
     &amp;     DWNFLG2(I)=.FALSE.<a name='1097'>
       ENDIF<a name='1098'>
      ENDDO<a name='1099'>
<font color=#447700>!!<a name='1100'></font>
      DO K = 2, KM1<a name='1101'>
        DO I = 1, IM<a name='1102'>
          if (k .le. kmax(i)-1) then<a name='1103'>
            IF(DWNFLG(I).AND.K.GT.JMIN(I).AND.K.LE.KT2(I)) THEN<a name='1104'>
              DZ        = .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1105'>
<font color=#447700>!             ETA(I,k)  = ETA(I,k-1) * EXP( XLAMB(I) * DZ)<a name='1106'></font>
<font color=#447700>!  to simplify matter, we will take the linear approach here<a name='1107'></font>
<font color=#447700>!<a name='1108'></font>
              ETA(I,k)  = ETA(I,k-1) * (1. + XLAMB(I) * dz)<a name='1109'>
              ETAU(I,k) = ETAU(I,k-1) * (1. + (XLAMB(I)+xlambu) * dz)<a name='1110'>
            ENDIF<a name='1111'>
          endif<a name='1112'>
        ENDDO<a name='1113'>
      ENDDO<a name='1114'>
<font color=#447700>!!<a name='1115'></font>
      DO K = 2, KM1<a name='1116'>
        DO I = 1, IM<a name='1117'>
          if (k .le. kmax(i)-1) then<a name='1118'>
<font color=#447700>!           IF(.NOT.DWNFLG(I).AND.K.GT.JMIN(I).AND.K.LE.KT2(I)) THEN<a name='1119'></font>
            IF(.NOT.DWNFLG(I).AND.K.GT.JMIN(I).AND.K.LE.KTCON(I)) THEN<a name='1120'>
              DZ        = .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1121'>
              ETAU(I,k) = ETAU(I,k-1) * (1. + xlambu * dz)<a name='1122'>
            ENDIF<a name='1123'>
          endif<a name='1124'>
        ENDDO<a name='1125'>
      ENDDO<a name='1126'>
<font color=#447700>!      IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I)) THEN<a name='1127'></font>
<font color=#447700>!        PRINT *, ' LMIN(I), KT2(I)=', LMIN(I), KT2(I)<a name='1128'></font>
<font color=#447700>!        PRINT *, ' KBOT, KTOP, JMIN(I) =', KBCON(I), KTCON(I), JMIN(I)<a name='1129'></font>
<font color=#447700>!      ENDIF<a name='1130'></font>
<font color=#447700>!     IF(LAT.EQ.LATD.AND.lon.eq.lond) THEN<a name='1131'></font>
<font color=#447700>!       print *, ' xlamb =', xlamb<a name='1132'></font>
<font color=#447700>!       print *, ' eta =', (eta(k),k=1,KT2(I))<a name='1133'></font>
<font color=#447700>!       print *, ' ETAU =', (ETAU(I,k),k=1,KT2(I))<a name='1134'></font>
<font color=#447700>!       print *, ' HCKO =', (HCKO(I,k),k=1,KT2(I))<a name='1135'></font>
<font color=#447700>!       print *, ' SUMZ =', (SUMZ(I,k),k=1,KT2(I))<a name='1136'></font>
<font color=#447700>!       print *, ' SUMH =', (SUMH(I,k),k=1,KT2(I))<a name='1137'></font>
<font color=#447700>!     ENDIF<a name='1138'></font>
      DO I = 1, IM<a name='1139'>
        if(DWNFLG(I)) THEN<a name='1140'>
          KTCON(I) = KT2(I)<a name='1141'>
        ENDIF<a name='1142'>
      ENDDO<a name='1143'>
<font color=#447700>!<a name='1144'></font>
<font color=#447700>!  CLOUD PROPERTY ABOVE CLOUD Base IS MODIFIED BY THE DETRAINMENT PROCESS<a name='1145'></font>
<font color=#447700>!<a name='1146'></font>
      DO K = 2, KM1<a name='1147'>
        DO I = 1, IM<a name='1148'>
          if (k .le. kmax(i)-1) then<a name='1149'>
<font color=#447700>!jfe<a name='1150'></font>
            IF(CNVFLG(I).AND.K.GT.KBCON(I).AND.K.LE.KTCON(I)) THEN<a name='1151'>
<font color=#447700>!jfe      IF(K.GT.KBCON(I).AND.K.LE.KTCON(I)) THEN<a name='1152'></font>
              FACTOR    = ETA(I,k-1) / ETA(I,k)<a name='1153'>
              ONEMF     = 1. - FACTOR<a name='1154'>
              fuv       = ETAU(I,k-1) / ETAU(I,k)<a name='1155'>
              onemfu    = 1. - fuv<a name='1156'>
              HCKO(I,k) = FACTOR * HCKO(I,k-1) + ONEMF *                &amp;<a name='1157'>
     &amp;                    .5 * (HEO(I,k) + HEO(I,k+1))<a name='1158'>
              UCKO(I,k) = fuv * UCKO(I,k-1) + ONEMFu *                  &amp;<a name='1159'>
     &amp;                    .5 * (UO(I,k) + UO(I,k+1))<a name='1160'>
              VCKO(I,k) = fuv * VCKO(I,k-1) + ONEMFu *                  &amp;<a name='1161'>
     &amp;                    .5 * (VO(I,k) + VO(I,k+1))<a name='1162'>
              DBYO(I,k) = HCKO(I,k) - HESO(I,k)<a name='1163'>
            ENDIF<a name='1164'>
          endif<a name='1165'>
        ENDDO<a name='1166'>
      ENDDO<a name='1167'>
<font color=#447700>!      IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I)) THEN<a name='1168'></font>
<font color=#447700>!        PRINT *, ' UCKO=', (UCKO(I,k),k=KBCON(I)+1,KTCON(I))<a name='1169'></font>
<font color=#447700>!        PRINT *, ' uenv=', (.5*(UO(I,k)+UO(I,k-1)),k=KBCON(I)+1,KTCON(I))<a name='1170'></font>
<font color=#447700>!      ENDIF<a name='1171'></font>
      DO I = 1, IM<a name='1172'>
        if(CNVFLG(I).and.DWNFLG2(I).and.JMIN(I).le.KBCON(I))            &amp;<a name='1173'>
     &amp;     THEN<a name='1174'>
          CNVFLG(I) = .false.<a name='1175'>
          DWNFLG(I) = .false.<a name='1176'>
          DWNFLG2(I) = .false.<a name='1177'>
        ENDIF<a name='1178'>
      ENDDO<a name='1179'>
<font color=#447700>!!<a name='1180'></font>
      TOTFLG = .TRUE.<a name='1181'>
      DO I = 1, IM<a name='1182'>
        TOTFLG = TOTFLG .AND. (.NOT. CNVFLG(I))<a name='1183'>
      ENDDO<a name='1184'>
      IF(TOTFLG) RETURN<a name='1185'>
<font color=#447700>!!<a name='1186'></font>
<font color=#447700>!<a name='1187'></font>
<font color=#447700>!  COMPUTE CLOUD MOISTURE PROPERTY AND PRECIPITATION<a name='1188'></font>
<font color=#447700>!<a name='1189'></font>
      DO I = 1, IM<a name='1190'>
          AA1(I) = 0.<a name='1191'>
          RHBAR(I) = 0.<a name='1192'>
      ENDDO<a name='1193'>
      DO K = 1, KM<a name='1194'>
        DO I = 1, IM<a name='1195'>
          if (k .le. kmax(i)) then<a name='1196'>
            IF(CNVFLG(I).AND.K.GT.KB(I).AND.K.LT.KTCON(I)) THEN<a name='1197'>
              DZ = .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1198'>
              DZ1 = (ZO(I,k) - ZO(I,k-1))<a name='1199'>
              GAMMA = EL2ORC * QESO(I,k) / (TO(I,k)**2)<a name='1200'>
              QRCH = QESO(I,k)                                          &amp;<a name='1201'>
     &amp;             + GAMMA * DBYO(I,k) / (HVAP * (1. + GAMMA))<a name='1202'>
              FACTOR = ETA(I,k-1) / ETA(I,k)<a name='1203'>
              ONEMF = 1. - FACTOR<a name='1204'>
              QCKO(I,k) = FACTOR * QCKO(I,k-1) + ONEMF *                &amp;<a name='1205'>
     &amp;                    .5 * (QO(I,k) + QO(I,k+1))<a name='1206'>
              DQ = ETA(I,k) * QCKO(I,k) - ETA(I,k) * QRCH<a name='1207'>
              RHBAR(I) = RHBAR(I) + QO(I,k) / QESO(I,k)<a name='1208'>
<font color=#447700>!<a name='1209'></font>
<font color=#447700>!  BELOW LFC CHECK IF THERE IS EXCESS MOISTURE TO RELEASE LATENT HEAT<a name='1210'></font>
<font color=#447700>!<a name='1211'></font>
              IF(DQ.GT.0.) THEN<a name='1212'>
                ETAH = .5 * (ETA(I,k) + ETA(I,k-1))<a name='1213'>
                QLK = DQ / (ETA(I,k) + ETAH * C0 * DZ)<a name='1214'>
                AA1(I) = AA1(I) - DZ1 * G * QLK<a name='1215'>
                QC = QLK + QRCH<a name='1216'>
                PWO(I,k) = ETAH * C0 * DZ * QLK<a name='1217'>
                QCKO(I,k) = QC<a name='1218'>
                PWAVO(I) = PWAVO(I) + PWO(I,k)<a name='1219'>
              ENDIF<a name='1220'>
            ENDIF<a name='1221'>
          endif<a name='1222'>
        ENDDO<a name='1223'>
      ENDDO<a name='1224'>
      DO I = 1, IM<a name='1225'>
        RHBAR(I) = RHBAR(I) / float(KTCON(I) - KB(I) - 1)<a name='1226'>
      ENDDO<a name='1227'>
<font color=#447700>!<a name='1228'></font>
<font color=#447700>!  this section is ready for cloud water<a name='1229'></font>
<font color=#447700>!<a name='1230'></font>
      if(ncloud.gt.0) THEN<a name='1231'>
<font color=#447700>!<a name='1232'></font>
<font color=#447700>!  compute liquid and vapor separation at cloud top<a name='1233'></font>
<font color=#447700>!<a name='1234'></font>
      DO I = 1, IM<a name='1235'>
        k = KTCON(I)<a name='1236'>
        IF(CNVFLG(I)) THEN<a name='1237'>
          GAMMA = EL2ORC * QESO(I,K) / (TO(I,K)**2)<a name='1238'>
          QRCH = QESO(I,K)                                              &amp;<a name='1239'>
     &amp;         + GAMMA * DBYO(I,K) / (HVAP * (1. + GAMMA))<a name='1240'>
          DQ = QCKO(I,K-1) - QRCH<a name='1241'>
<font color=#447700>!<a name='1242'></font>
<font color=#447700>!  CHECK IF THERE IS EXCESS MOISTURE TO RELEASE LATENT HEAT<a name='1243'></font>
<font color=#447700>!<a name='1244'></font>
          IF(DQ.GT.0.) THEN<a name='1245'>
            QLKO_KTCON(I) = dq<a name='1246'>
            QCKO(I,K-1) = QRCH<a name='1247'>
          ENDIF<a name='1248'>
        ENDIF<a name='1249'>
      ENDDO<a name='1250'>
      ENDIF<a name='1251'>
<font color=#447700>!<a name='1252'></font>
<font color=#447700>!  CALCULATE CLOUD WORK FUNCTION AT T+DT<a name='1253'></font>
<font color=#447700>!<a name='1254'></font>
      DO K = 1, KM<a name='1255'>
        DO I = 1, IM<a name='1256'>
          if (k .le. kmax(i)) then<a name='1257'>
            IF(CNVFLG(I).AND.K.GT.KBCON(I).AND.K.LE.KTCON(I)) THEN<a name='1258'>
              DZ1 = ZO(I,k) - ZO(I,k-1)<a name='1259'>
              GAMMA = EL2ORC * QESO(I,k-1) / (TO(I,k-1)**2)<a name='1260'>
              RFACT =  1. + DELTA * CP * GAMMA                          &amp;<a name='1261'>
     &amp;                 * TO(I,k-1) / HVAP<a name='1262'>
              AA1(I) = AA1(I) +                                         &amp;<a name='1263'>
     &amp;                 DZ1 * (G / (CP * TO(I,k-1)))                     &amp;<a name='1264'>
     &amp;                 * DBYO(I,k-1) / (1. + GAMMA)                     &amp;<a name='1265'>
     &amp;                 * RFACT<a name='1266'>
              val = 0.<a name='1267'>
              AA1(I)=AA1(I)+                                            &amp;<a name='1268'>
     &amp;                 DZ1 * G * DELTA *                                &amp;<a name='1269'>
<font color=#447700>!cmr &amp;                 MAX( 0.,(QESO(I,k-1) - QO(I,k-1)))               &amp; <a name='1270'></font>
     &amp;                 MAX(val,(QESO(I,k-1) - QO(I,k-1)))<a name='1271'>
            ENDIF<a name='1272'>
          endif<a name='1273'>
        ENDDO<a name='1274'>
      ENDDO<a name='1275'>
      DO I = 1, IM<a name='1276'>
        IF(CNVFLG(I).AND.AA1(I).LE.0.) DWNFLG(I)  = .FALSE.<a name='1277'>
        IF(CNVFLG(I).AND.AA1(I).LE.0.) DWNFLG2(I) = .FALSE.<a name='1278'>
        IF(CNVFLG(I).AND.AA1(I).LE.0.) CNVFLG(I)  = .FALSE.<a name='1279'>
      ENDDO<a name='1280'>
<font color=#447700>!!<a name='1281'></font>
      TOTFLG = .TRUE.<a name='1282'>
      DO I = 1, IM<a name='1283'>
        TOTFLG = TOTFLG .AND. (.NOT. CNVFLG(I))<a name='1284'>
      ENDDO<a name='1285'>
      IF(TOTFLG) RETURN<a name='1286'>
<font color=#447700>!!<a name='1287'></font>
<font color=#447700>!cccc IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I)) THEN<a name='1288'></font>
<font color=#447700>!cccc   PRINT *, ' AA1(I) BEFORE DWNDRFT =', AA1(I)<a name='1289'></font>
<font color=#447700>!cccc ENDIF<a name='1290'></font>
<font color=#447700>!<a name='1291'></font>
<font color=#447700>!------- DOWNDRAFT CALCULATIONS<a name='1292'></font>
<font color=#447700>!<a name='1293'></font>
<font color=#447700>!<a name='1294'></font>
<font color=#447700>!--- DETERMINE DOWNDRAFT STRENGTH IN TERMS OF WINDSHEAR<a name='1295'></font>
<font color=#447700>!<a name='1296'></font>
      DO I = 1, IM<a name='1297'>
        IF(CNVFLG(I)) THEN<a name='1298'>
          VSHEAR(I) = 0.<a name='1299'>
        ENDIF<a name='1300'>
      ENDDO<a name='1301'>
      DO K = 1, KM<a name='1302'>
        DO I = 1, IM<a name='1303'>
          if (k .le. kmax(i)) then<a name='1304'>
            IF(K.GE.KB(I).AND.K.LE.KTCON(I).AND.CNVFLG(I)) THEN<a name='1305'>
              shear=rcs(I) * sqrt((UO(I,k+1)-UO(I,k)) ** 2              &amp;<a name='1306'>
     &amp;                          + (VO(I,k+1)-VO(I,k)) ** 2)<a name='1307'>
              VSHEAR(I) = VSHEAR(I) + SHEAR<a name='1308'>
            ENDIF<a name='1309'>
          endif<a name='1310'>
        ENDDO<a name='1311'>
      ENDDO<a name='1312'>
      DO I = 1, IM<a name='1313'>
        EDT(I) = 0.<a name='1314'>
        IF(CNVFLG(I)) THEN<a name='1315'>
          KNUMB = KTCON(I) - KB(I) + 1<a name='1316'>
          KNUMB = MAX(KNUMB,1)<a name='1317'>
          VSHEAR(I) = 1.E3 * VSHEAR(I) / (ZO(I,KTCON(I))-ZO(I,KB(I)))<a name='1318'>
          E1=1.591-.639*VSHEAR(I)                                       &amp;<a name='1319'>
     &amp;       +.0953*(VSHEAR(I)**2)-.00496*(VSHEAR(I)**3)<a name='1320'>
          EDT(I)=1.-E1<a name='1321'>
<font color=#447700>!cmr      EDT(I) = MIN(EDT(I),.9)<a name='1322'></font>
          val =         .9<a name='1323'>
          EDT(I) = MIN(EDT(I),val)<a name='1324'>
<font color=#447700>!cmr      EDT(I) = MAX(EDT(I),.0)<a name='1325'></font>
          val =         .0<a name='1326'>
          EDT(I) = MAX(EDT(I),val)<a name='1327'>
          EDTO(I)=EDT(I)<a name='1328'>
          EDTX(I)=EDT(I)<a name='1329'>
        ENDIF<a name='1330'>
      ENDDO<a name='1331'>
<font color=#447700>!  DETERMINE DETRAINMENT RATE BETWEEN 1 AND KBDTR<a name='1332'></font>
      DO I = 1, IM<a name='1333'>
        KBDTR(I) = KBCON(I)<a name='1334'>
        beta = betas<a name='1335'>
        if(SLIMSK(I).eq.1.) beta = betal<a name='1336'>
        IF(CNVFLG(I)) THEN<a name='1337'>
          KBDTR(I) = KBCON(I)<a name='1338'>
          KBDTR(I) = MAX(KBDTR(I),1)<a name='1339'>
          XLAMD(I) = 0.<a name='1340'>
          IF(KBDTR(I).GT.1) THEN<a name='1341'>
            DZ = .5 * ZO(I,KBDTR(I)) + .5 * ZO(I,KBDTR(I)-1)            &amp;<a name='1342'>
     &amp;         - ZO(I,1)<a name='1343'>
            XLAMD(I) =  LOG(BETA) / DZ<a name='1344'>
          ENDIF<a name='1345'>
        ENDIF<a name='1346'>
      ENDDO<a name='1347'>
<font color=#447700>!  DETERMINE DOWNDRAFT MASS FLUX<a name='1348'></font>
      DO K = 1, KM<a name='1349'>
        DO I = 1, IM<a name='1350'>
          IF(k .le. kmax(i)) then<a name='1351'>
            IF(CNVFLG(I)) THEN<a name='1352'>
              ETAD(I,k) = 1.<a name='1353'>
            ENDIF<a name='1354'>
            QRCDO(I,k) = 0.<a name='1355'>
          endif<a name='1356'>
        ENDDO<a name='1357'>
      ENDDO<a name='1358'>
      DO K = KM1, 2, -1<a name='1359'>
        DO I = 1, IM<a name='1360'>
          if (k .le. kbmax(i)) then<a name='1361'>
            IF(CNVFLG(I).AND.K.LT.KBDTR(I)) THEN<a name='1362'>
              DZ        = .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1363'>
              ETAD(I,k) = ETAD(I,k+1) * EXP(XLAMD(I) * DZ)<a name='1364'>
            ENDIF<a name='1365'>
          endif<a name='1366'>
        ENDDO<a name='1367'>
      ENDDO<a name='1368'>
      K = 1<a name='1369'>
      DO I = 1, IM<a name='1370'>
        IF(CNVFLG(I).AND.KBDTR(I).GT.1) THEN<a name='1371'>
          DZ = .5 * (ZO(I,2) - ZO(I,1))<a name='1372'>
          ETAD(I,k) = ETAD(I,k+1) * EXP(XLAMD(I) * DZ)<a name='1373'>
        ENDIF<a name='1374'>
      ENDDO<a name='1375'>
<font color=#447700>!<a name='1376'></font>
<font color=#447700>!--- DOWNDRAFT MOISTURE PROPERTIES<a name='1377'></font>
<font color=#447700>!<a name='1378'></font>
      DO I = 1, IM<a name='1379'>
        PWEVO(I) = 0.<a name='1380'>
        FLG(I) = CNVFLG(I)<a name='1381'>
      ENDDO<a name='1382'>
      DO I = 1, IM<a name='1383'>
        IF(CNVFLG(I)) THEN<a name='1384'>
          JMN = JMIN(I)<a name='1385'>
          HCDO(I) = HEO(I,JMN)<a name='1386'>
          QCDO(I) = QO(I,JMN)<a name='1387'>
          QRCDO(I,JMN) = QESO(I,JMN)<a name='1388'>
          UCDO(I) = UO(I,JMN)<a name='1389'>
          VCDO(I) = VO(I,JMN)<a name='1390'>
        ENDIF<a name='1391'>
      ENDDO<a name='1392'>
      DO K = KM1, 1, -1<a name='1393'>
        DO I = 1, IM<a name='1394'>
          if (k .le. kmax(i)-1) then<a name='1395'>
            IF(CNVFLG(I).AND.K.LT.JMIN(I)) THEN<a name='1396'>
              DQ = QESO(I,k)<a name='1397'>
              DT = TO(I,k)<a name='1398'>
              GAMMA      = EL2ORC * DQ / DT**2<a name='1399'>
              DH         = HCDO(I) - HESO(I,k)<a name='1400'>
              QRCDO(I,k) = DQ+(1./HVAP)*(GAMMA/(1.+GAMMA))*DH<a name='1401'>
              DETAD      = ETAD(I,k+1) - ETAD(I,k)<a name='1402'>
              PWDO(I,k)  = ETAD(I,k+1) * QCDO(I) -                      &amp;<a name='1403'>
     &amp;                     ETAD(I,k) * QRCDO(I,k)<a name='1404'>
              PWDO(I,k)  = PWDO(I,k) - DETAD *                          &amp;<a name='1405'>
     &amp;                    .5 * (QRCDO(I,k) + QRCDO(I,k+1))<a name='1406'>
              QCDO(I)    = QRCDO(I,k)<a name='1407'>
              PWEVO(I)   = PWEVO(I) + PWDO(I,k)<a name='1408'>
            ENDIF<a name='1409'>
          endif<a name='1410'>
        ENDDO<a name='1411'>
      ENDDO<a name='1412'>
<font color=#447700>!     IF(LAT.EQ.LATD.AND.lon.eq.lond.and.DWNFLG(I)) THEN<a name='1413'></font>
<font color=#447700>!       PRINT *, ' PWAVO(I), PWEVO(I) =', PWAVO(I), PWEVO(I)<a name='1414'></font>
<font color=#447700>!     ENDIF<a name='1415'></font>
<font color=#447700>!<a name='1416'></font>
<font color=#447700>!--- FINAL DOWNDRAFT STRENGTH DEPENDENT ON PRECIP<a name='1417'></font>
<font color=#447700>!--- EFFICIENCY (EDT), NORMALIZED CONDENSATE (PWAV), AND<a name='1418'></font>
<font color=#447700>!--- EVAPORATE (PWEV)<a name='1419'></font>
<font color=#447700>!<a name='1420'></font>
      DO I = 1, IM<a name='1421'>
        edtmax = edtmaxl<a name='1422'>
        if(SLIMSK(I).eq.0.) edtmax = edtmaxs<a name='1423'>
        IF(DWNFLG2(I)) THEN<a name='1424'>
          IF(PWEVO(I).LT.0.) THEN<a name='1425'>
            EDTO(I) = -EDTO(I) * PWAVO(I) / PWEVO(I)<a name='1426'>
            EDTO(I) = MIN(EDTO(I),EDTMAX)<a name='1427'>
          ELSE<a name='1428'>
            EDTO(I) = 0.<a name='1429'>
          ENDIF<a name='1430'>
        ELSE<a name='1431'>
          EDTO(I) = 0.<a name='1432'>
        ENDIF<a name='1433'>
      ENDDO<a name='1434'>
<font color=#447700>!<a name='1435'></font>
<font color=#447700>!<a name='1436'></font>
<font color=#447700>!--- DOWNDRAFT CLOUDWORK FUNCTIONS<a name='1437'></font>
<font color=#447700>!<a name='1438'></font>
<font color=#447700>!<a name='1439'></font>
      DO K = KM1, 1, -1<a name='1440'>
        DO I = 1, IM<a name='1441'>
          if (k .le. kmax(i)-1) then<a name='1442'>
            IF(DWNFLG2(I).AND.K.LT.JMIN(I)) THEN<a name='1443'>
              GAMMA = EL2ORC * QESO(I,k+1) / TO(I,k+1)**2<a name='1444'>
              DHH=HCDO(I)<a name='1445'>
              DT=TO(I,k+1)<a name='1446'>
              DG=GAMMA<a name='1447'>
              DH=HESO(I,k+1)<a name='1448'>
              DZ=-1.*(ZO(I,k+1)-ZO(I,k))<a name='1449'>
              AA1(I)=AA1(I)+EDTO(I)*DZ*(G/(CP*DT))*((DHH-DH)/(1.+DG))   &amp;<a name='1450'>
     &amp;               *(1.+DELTA*CP*DG*DT/HVAP)<a name='1451'>
              val=0.<a name='1452'>
              AA1(I)=AA1(I)+EDTO(I)*                                    &amp; <a name='1453'>
<font color=#447700>!cmr &amp;        DZ*G*DELTA*MAX( 0.,(QESO(I,k+1)-QO(I,k+1)))               &amp;<a name='1454'></font>
     &amp;        DZ*G*DELTA*MAX(val,(QESO(I,k+1)-QO(I,k+1)))<a name='1455'>
            ENDIF<a name='1456'>
          endif<a name='1457'>
        ENDDO<a name='1458'>
      ENDDO<a name='1459'>
<font color=#447700>!cccc IF(LAT.EQ.LATD.AND.lon.eq.lond.and.DWNFLG2(I)) THEN<a name='1460'></font>
<font color=#447700>!cccc   PRINT *, '  AA1(I) AFTER DWNDRFT =', AA1(I)<a name='1461'></font>
<font color=#447700>!cccc ENDIF<a name='1462'></font>
      DO I = 1, IM<a name='1463'>
        IF(AA1(I).LE.0.) CNVFLG(I)  = .FALSE.<a name='1464'>
        IF(AA1(I).LE.0.) DWNFLG(I)  = .FALSE.<a name='1465'>
        IF(AA1(I).LE.0.) DWNFLG2(I) = .FALSE.<a name='1466'>
      ENDDO<a name='1467'>
<font color=#447700>!!<a name='1468'></font>
      TOTFLG = .TRUE.<a name='1469'>
      DO I = 1, IM<a name='1470'>
        TOTFLG = TOTFLG .AND. (.NOT. CNVFLG(I))<a name='1471'>
      ENDDO<a name='1472'>
      IF(TOTFLG) RETURN<a name='1473'>
<font color=#447700>!!<a name='1474'></font>
<font color=#447700>!<a name='1475'></font>
<font color=#447700>!<a name='1476'></font>
<font color=#447700>!--- WHAT WOULD THE CHANGE BE, THAT A CLOUD WITH UNIT MASS<a name='1477'></font>
<font color=#447700>!--- WILL DO TO THE ENVIRONMENT?<a name='1478'></font>
<font color=#447700>!<a name='1479'></font>
      DO K = 1, KM<a name='1480'>
        DO I = 1, IM<a name='1481'>
          IF(k .le. kmax(i) .and. CNVFLG(I)) THEN<a name='1482'>
            DELLAH(I,k) = 0.<a name='1483'>
            DELLAQ(I,k) = 0.<a name='1484'>
            DELLAU(I,k) = 0.<a name='1485'>
            DELLAV(I,k) = 0.<a name='1486'>
          ENDIF<a name='1487'>
        ENDDO<a name='1488'>
      ENDDO<a name='1489'>
      DO I = 1, IM<a name='1490'>
        IF(CNVFLG(I)) THEN<a name='1491'>
          DP = 1000. * DEL(I,1)<a name='1492'>
          DELLAH(I,1) = EDTO(I) * ETAD(I,1) * (HCDO(I)                  &amp;<a name='1493'>
     &amp;                - HEO(I,1)) * G / DP<a name='1494'>
          DELLAQ(I,1) = EDTO(I) * ETAD(I,1) * (QCDO(I)                  &amp;<a name='1495'>
     &amp;                - QO(I,1)) * G / DP<a name='1496'>
          DELLAU(I,1) = EDTO(I) * ETAD(I,1) * (UCDO(I)                  &amp;<a name='1497'>
     &amp;                - UO(I,1)) * G / DP<a name='1498'>
          DELLAV(I,1) = EDTO(I) * ETAD(I,1) * (VCDO(I)                  &amp;<a name='1499'>
     &amp;                - VO(I,1)) * G / DP<a name='1500'>
        ENDIF<a name='1501'>
      ENDDO<a name='1502'>
<font color=#447700>!<a name='1503'></font>
<font color=#447700>!--- CHANGED DUE TO SUBSIDENCE AND ENTRAINMENT<a name='1504'></font>
<font color=#447700>!<a name='1505'></font>
      DO K = 2, KM1<a name='1506'>
        DO I = 1, IM<a name='1507'>
          if (k .le. kmax(i)-1) then<a name='1508'>
            IF(CNVFLG(I).AND.K.LT.KTCON(I)) THEN<a name='1509'>
              AUP = 1.<a name='1510'>
              IF(K.LE.KB(I)) AUP = 0.<a name='1511'>
              ADW = 1.<a name='1512'>
              IF(K.GT.JMIN(I)) ADW = 0.<a name='1513'>
              DV1= HEO(I,k)<a name='1514'>
              DV2 = .5 * (HEO(I,k) + HEO(I,k+1))<a name='1515'>
              DV3= HEO(I,k-1)<a name='1516'>
              DV1Q= QO(I,k)<a name='1517'>
              DV2Q = .5 * (QO(I,k) + QO(I,k+1))<a name='1518'>
              DV3Q= QO(I,k-1)<a name='1519'>
              DV1U= UO(I,k)<a name='1520'>
              DV2U = .5 * (UO(I,k) + UO(I,k+1))<a name='1521'>
              DV3U= UO(I,k-1)<a name='1522'>
              DV1V= VO(I,k)<a name='1523'>
              DV2V = .5 * (VO(I,k) + VO(I,k+1))<a name='1524'>
              DV3V= VO(I,k-1)<a name='1525'>
              DP = 1000. * DEL(I,K)<a name='1526'>
              DZ = .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1527'>
              DETA = ETA(I,k) - ETA(I,k-1)<a name='1528'>
              DETAD = ETAD(I,k) - ETAD(I,k-1)<a name='1529'>
              DELLAH(I,k) = DELLAH(I,k) +                               &amp;<a name='1530'>
     &amp;            ((AUP * ETA(I,k) - ADW * EDTO(I) * ETAD(I,k)) * DV1   &amp;<a name='1531'>
     &amp;        - (AUP * ETA(I,k-1) - ADW * EDTO(I) * ETAD(I,k-1))* DV3   &amp;<a name='1532'>
     &amp;                    - AUP * DETA * DV2                            &amp;<a name='1533'>
     &amp;                    + ADW * EDTO(I) * DETAD * HCDO(I)) * G / DP<a name='1534'>
              DELLAQ(I,k) = DELLAQ(I,k) +                               &amp;<a name='1535'>
     &amp;            ((AUP * ETA(I,k) - ADW * EDTO(I) * ETAD(I,k)) * DV1Q  &amp;<a name='1536'>
     &amp;        - (AUP * ETA(I,k-1) - ADW * EDTO(I) * ETAD(I,k-1))* DV3Q  &amp;<a name='1537'>
     &amp;                    - AUP * DETA * DV2Q                           &amp;<a name='1538'>
     &amp;       +ADW*EDTO(I)*DETAD*.5*(QRCDO(I,k)+QRCDO(I,k-1))) * G / DP<a name='1539'>
              DELLAU(I,k) = DELLAU(I,k) +                               &amp;<a name='1540'>
     &amp;            ((AUP * ETA(I,k) - ADW * EDTO(I) * ETAD(I,k)) * DV1U  &amp;<a name='1541'>
     &amp;        - (AUP * ETA(I,k-1) - ADW * EDTO(I) * ETAD(I,k-1))* DV3U  &amp;<a name='1542'>
     &amp;                     - AUP * DETA * DV2U                          &amp;<a name='1543'>
     &amp;                    + ADW * EDTO(I) * DETAD * UCDO(I)             &amp; <a name='1544'>
     &amp;                    ) * G / DP<a name='1545'>
              DELLAV(I,k) = DELLAV(I,k) +                               &amp;<a name='1546'>
     &amp;            ((AUP * ETA(I,k) - ADW * EDTO(I) * ETAD(I,k)) * DV1V  &amp;<a name='1547'>
     &amp;        - (AUP * ETA(I,k-1) - ADW * EDTO(I) * ETAD(I,k-1))* DV3V  &amp;<a name='1548'>
     &amp;                     - AUP * DETA * DV2V                          &amp;<a name='1549'>
     &amp;                    + ADW * EDTO(I) * DETAD * VCDO(I)             &amp;<a name='1550'>
     &amp;                    ) * G / DP<a name='1551'>
            ENDIF<a name='1552'>
          endif<a name='1553'>
        ENDDO<a name='1554'>
      ENDDO<a name='1555'>
<font color=#447700>!<a name='1556'></font>
<font color=#447700>!------- CLOUD TOP<a name='1557'></font>
<font color=#447700>!<a name='1558'></font>
      DO I = 1, IM<a name='1559'>
        IF(CNVFLG(I)) THEN<a name='1560'>
          INDX = KTCON(I)<a name='1561'>
          DP = 1000. * DEL(I,INDX)<a name='1562'>
          DV1 = HEO(I,INDX-1)<a name='1563'>
          DELLAH(I,INDX) = ETA(I,INDX-1) *                              &amp;<a name='1564'>
     &amp;                     (HCKO(I,INDX-1) - DV1) * G / DP<a name='1565'>
          DVQ1 = QO(I,INDX-1) <a name='1566'>
          DELLAQ(I,INDX) = ETA(I,INDX-1) *                              &amp;<a name='1567'>
     &amp;                     (QCKO(I,INDX-1) - DVQ1) * G / DP<a name='1568'>
          DV1U = UO(I,INDX-1)<a name='1569'>
          DELLAU(I,INDX) = ETA(I,INDX-1) *                              &amp;<a name='1570'>
     &amp;                     (UCKO(I,INDX-1) - DV1U) * G / DP<a name='1571'>
          DV1V = VO(I,INDX-1)<a name='1572'>
          DELLAV(I,INDX) = ETA(I,INDX-1) *                              &amp;<a name='1573'>
     &amp;                     (VCKO(I,INDX-1) - DV1V) * G / DP<a name='1574'>
<font color=#447700>!<a name='1575'></font>
<font color=#447700>!  cloud water<a name='1576'></font>
<font color=#447700>!<a name='1577'></font>
          DELLAL(I) = ETA(I,INDX-1) * QLKO_KTCON(I) * g / dp<a name='1578'>
        ENDIF<a name='1579'>
      ENDDO<a name='1580'>
<font color=#447700>!<a name='1581'></font>
<font color=#447700>!------- FINAL CHANGED VARIABLE PER UNIT MASS FLUX<a name='1582'></font>
<font color=#447700>!<a name='1583'></font>
      DO K = 1, KM<a name='1584'>
        DO I = 1, IM<a name='1585'>
          if (k .le. kmax(i)) then<a name='1586'>
            IF(CNVFLG(I).and.k.gt.KTCON(I)) THEN<a name='1587'>
              QO(I,k) = Q1(I,k)<a name='1588'>
              TO(I,k) = T1(I,k)<a name='1589'>
              UO(I,k) = U1(I,k)<a name='1590'>
              VO(I,k) = V1(I,k)<a name='1591'>
            ENDIF<a name='1592'>
            IF(CNVFLG(I).AND.K.LE.KTCON(I)) THEN<a name='1593'>
              QO(I,k) = DELLAQ(I,k) * MBDT + Q1(I,k)<a name='1594'>
              DELLAT = (DELLAH(I,k) - HVAP * DELLAQ(I,k)) / CP<a name='1595'>
              TO(I,k) = DELLAT * MBDT + T1(I,k)<a name='1596'>
<font color=#447700>!cmr          QO(I,k) = max(QO(I,k),1.e-10)<a name='1597'></font>
              val   =           1.e-10<a name='1598'>
              QO(I,k) = max(QO(I,k), val  )<a name='1599'>
            ENDIF<a name='1600'>
          endif<a name='1601'>
        ENDDO<a name='1602'>
      ENDDO<a name='1603'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1604'></font>
<font color=#447700>!<a name='1605'></font>
<font color=#447700>!--- THE ABOVE CHANGED ENVIRONMENT IS NOW USED TO CALULATE THE<a name='1606'></font>
<font color=#447700>!--- EFFECT THE ARBITRARY CLOUD (WITH UNIT MASS FLUX)<a name='1607'></font>
<font color=#447700>!--- WOULD HAVE ON THE STABILITY,<a name='1608'></font>
<font color=#447700>!--- WHICH THEN IS USED TO CALCULATE THE REAL MASS FLUX,<a name='1609'></font>
<font color=#447700>!--- NECESSARY TO KEEP THIS CHANGE IN BALANCE WITH THE LARGE-SCALE<a name='1610'></font>
<font color=#447700>!--- DESTABILIZATION.<a name='1611'></font>
<font color=#447700>!<a name='1612'></font>
<font color=#447700>!--- ENVIRONMENTAL CONDITIONS AGAIN, FIRST HEIGHTS<a name='1613'></font>
<font color=#447700>!<a name='1614'></font>
      DO K = 1, KM<a name='1615'>
        DO I = 1, IM<a name='1616'>
          IF(k .le. kmax(i) .and. CNVFLG(I)) THEN<a name='1617'>
<font color=#447700>!jfe        QESO(I,k) = 10. * FPVS(TO(I,k))<a name='1618'></font>
<font color=#447700>!<a name='1619'></font>
            QESO(I,k) = 0.01 * fpvs(TO(I,K))      <font color=#447700>! fpvs is in Pa<a name='1620'></font>
<font color=#447700>!<a name='1621'></font>
            QESO(I,k) = EPS * QESO(I,k) / (PFLD(I,k)+EPSM1*QESO(I,k))<a name='1622'>
<font color=#447700>!cmr        QESO(I,k) = MAX(QESO(I,k),1.E-8)<a name='1623'></font>
            val       =             1.E-8<a name='1624'>
            QESO(I,k) = MAX(QESO(I,k), val )<a name='1625'>
            TVO(I,k)  = TO(I,k) + DELTA * TO(I,k) * QO(I,k)<a name='1626'>
          ENDIF<a name='1627'>
        ENDDO<a name='1628'>
      ENDDO<a name='1629'>
      DO I = 1, IM<a name='1630'>
        IF(CNVFLG(I)) THEN<a name='1631'>
          XAA0(I) = 0.<a name='1632'>
          XPWAV(I) = 0.<a name='1633'>
        ENDIF<a name='1634'>
      ENDDO<a name='1635'>
<font color=#447700>!<a name='1636'></font>
<font color=#447700>!  HYDROSTATIC HEIGHT ASSUME ZERO TERR<a name='1637'></font>
<font color=#447700>!<a name='1638'></font>
<font color=#447700>!     DO I = 1, IM<a name='1639'></font>
<font color=#447700>!       IF(CNVFLG(I)) THEN<a name='1640'></font>
<font color=#447700>!         DLNSIG =  LOG(PRSL(I,1)/PS(I))<a name='1641'></font>
<font color=#447700>!         ZO(I,1) = TERR - DLNSIG * RD / G * TVO(I,1)<a name='1642'></font>
<font color=#447700>!       ENDIF<a name='1643'></font>
<font color=#447700>!     ENDDO<a name='1644'></font>
<font color=#447700>!     DO K = 2, KM<a name='1645'></font>
<font color=#447700>!       DO I = 1, IM<a name='1646'></font>
<font color=#447700>!         IF(k .le. kmax(i) .and. CNVFLG(I)) THEN<a name='1647'></font>
<font color=#447700>!           DLNSIG =  LOG(PRSL(I,K) / PRSL(I,K-1))<a name='1648'></font>
<font color=#447700>!           ZO(I,k) = ZO(I,k-1) - DLNSIG * RD / G<a name='1649'></font>
<font color=#447700>!    &amp;             * .5 * (TVO(I,k) + TVO(I,k-1))<a name='1650'></font>
<font color=#447700>!         ENDIF<a name='1651'></font>
<font color=#447700>!       ENDDO<a name='1652'></font>
<font color=#447700>!     ENDDO<a name='1653'></font>
<font color=#447700>!<a name='1654'></font>
<font color=#447700>!--- MOIST STATIC ENERGY<a name='1655'></font>
<font color=#447700>!<a name='1656'></font>
      DO K = 1, KM1<a name='1657'>
        DO I = 1, IM<a name='1658'>
          IF(k .le. kmax(i)-1 .and. CNVFLG(I)) THEN<a name='1659'>
            DZ = .5 * (ZO(I,k+1) - ZO(I,k))<a name='1660'>
            DP = .5 * (PFLD(I,k+1) - PFLD(I,k))<a name='1661'>
<font color=#447700>!jfe        ES = 10. * FPVS(TO(I,k+1))<a name='1662'></font>
<font color=#447700>!<a name='1663'></font>
            ES = 0.01 * fpvs(TO(I,K+1))      <font color=#447700>! fpvs is in Pa<a name='1664'></font>
<font color=#447700>!<a name='1665'></font>
            PPRIME = PFLD(I,k+1) + EPSM1 * ES<a name='1666'>
            QS = EPS * ES / PPRIME<a name='1667'>
            DQSDP = - QS / PPRIME<a name='1668'>
            DESDT = ES * (FACT1 / TO(I,k+1) + FACT2 / (TO(I,k+1)**2))<a name='1669'>
            DQSDT = QS * PFLD(I,k+1) * DESDT / (ES * PPRIME)<a name='1670'>
            GAMMA = EL2ORC * QESO(I,k+1) / (TO(I,k+1)**2)<a name='1671'>
            DT = (G * DZ + HVAP * DQSDP * DP) / (CP * (1. + GAMMA))<a name='1672'>
            DQ = DQSDT * DT + DQSDP * DP<a name='1673'>
            TO(I,k) = TO(I,k+1) + DT<a name='1674'>
            QO(I,k) = QO(I,k+1) + DQ<a name='1675'>
            PO(I,k) = .5 * (PFLD(I,k) + PFLD(I,k+1))<a name='1676'>
          ENDIF<a name='1677'>
        ENDDO<a name='1678'>
      ENDDO<a name='1679'>
      DO K = 1, KM1<a name='1680'>
        DO I = 1, IM<a name='1681'>
          IF(k .le. kmax(i)-1 .and. CNVFLG(I)) THEN<a name='1682'>
<font color=#447700>!jfe        QESO(I,k) = 10. * FPVS(TO(I,k))<a name='1683'></font>
<font color=#447700>!<a name='1684'></font>
            QESO(I,k) = 0.01 * fpvs(TO(I,K))      <font color=#447700>! fpvs is in Pa<a name='1685'></font>
<font color=#447700>!<a name='1686'></font>
            QESO(I,k) = EPS * QESO(I,k) / (PO(I,k) + EPSM1 * QESO(I,k))<a name='1687'>
<font color=#447700>!cmr        QESO(I,k) = MAX(QESO(I,k),1.E-8)<a name='1688'></font>
            val1      =             1.E-8<a name='1689'>
            QESO(I,k) = MAX(QESO(I,k), val1)<a name='1690'>
<font color=#447700>!cmr        QO(I,k)   = max(QO(I,k),1.e-10)<a name='1691'></font>
            val2      =           1.e-10<a name='1692'>
            QO(I,k)   = max(QO(I,k), val2 )<a name='1693'>
<font color=#447700>!           QO(I,k)   = MIN(QO(I,k),QESO(I,k))<a name='1694'></font>
            HEO(I,k)   = .5 * G * (ZO(I,k) + ZO(I,k+1)) +               &amp;<a name='1695'>
     &amp;                    CP * TO(I,k) + HVAP * QO(I,k)<a name='1696'>
            HESO(I,k) = .5 * G * (ZO(I,k) + ZO(I,k+1)) +                &amp;<a name='1697'>
     &amp;                  CP * TO(I,k) + HVAP * QESO(I,k)<a name='1698'>
          ENDIF<a name='1699'>
        ENDDO<a name='1700'>
      ENDDO<a name='1701'>
      DO I = 1, IM<a name='1702'>
        k = kmax(i)<a name='1703'>
        IF(CNVFLG(I)) THEN<a name='1704'>
          HEO(I,k) = G * ZO(I,k) + CP * TO(I,k) + HVAP * QO(I,k)<a name='1705'>
          HESO(I,k) = G * ZO(I,k) + CP * TO(I,k) + HVAP * QESO(I,k)<a name='1706'>
<font color=#447700>!         HEO(I,k) = MIN(HEO(I,k),HESO(I,k))<a name='1707'></font>
        ENDIF<a name='1708'>
      ENDDO<a name='1709'>
      DO I = 1, IM<a name='1710'>
        IF(CNVFLG(I)) THEN<a name='1711'>
          INDX = KB(I)<a name='1712'>
          XHKB(I) = HEO(I,INDX)<a name='1713'>
          XQKB(I) = QO(I,INDX)<a name='1714'>
          HCKO(I,INDX) = XHKB(I)<a name='1715'>
          QCKO(I,INDX) = XQKB(I)<a name='1716'>
        ENDIF<a name='1717'>
      ENDDO<a name='1718'>
<font color=#447700>!<a name='1719'></font>
<font color=#447700>!<a name='1720'></font>
<font color=#447700>!**************************** STATIC CONTROL<a name='1721'></font>
<font color=#447700>!<a name='1722'></font>
<font color=#447700>!<a name='1723'></font>
<font color=#447700>!------- MOISTURE AND CLOUD WORK FUNCTIONS<a name='1724'></font>
<font color=#447700>!<a name='1725'></font>
      DO K = 2, KM1<a name='1726'>
        DO I = 1, IM<a name='1727'>
          if (k .le. kmax(i)-1) then<a name='1728'>
<font color=#447700>!           IF(CNVFLG(I).AND.K.GT.KB(I).AND.K.LE.KBCON(I)) THEN<a name='1729'></font>
            IF(CNVFLG(I).AND.K.GT.KB(I).AND.K.LE.KTCON(I)) THEN<a name='1730'>
              FACTOR = ETA(I,k-1) / ETA(I,k)<a name='1731'>
              ONEMF = 1. - FACTOR<a name='1732'>
              HCKO(I,k) = FACTOR * HCKO(I,k-1) + ONEMF *                &amp;<a name='1733'>
     &amp;                    .5 * (HEO(I,k) + HEO(I,k+1))<a name='1734'>
            ENDIF<a name='1735'>
<font color=#447700>!           IF(CNVFLG(I).AND.K.GT.KBCON(I)) THEN<a name='1736'></font>
<font color=#447700>!             HEO(I,k) = HEO(I,k-1)<a name='1737'></font>
<font color=#447700>!           ENDIF<a name='1738'></font>
          endif<a name='1739'>
        ENDDO<a name='1740'>
      ENDDO<a name='1741'>
      DO K = 2, KM1<a name='1742'>
        DO I = 1, IM<a name='1743'>
          if (k .le. kmax(i)-1) then<a name='1744'>
            IF(CNVFLG(I).AND.K.GT.KB(I).AND.K.LT.KTCON(I)) THEN<a name='1745'>
              DZ = .5 * (ZO(I,k+1) - ZO(I,k-1))<a name='1746'>
              GAMMA = EL2ORC * QESO(I,k) / (TO(I,k)**2)<a name='1747'>
              XDBY = HCKO(I,k) - HESO(I,k)<a name='1748'>
<font color=#447700>!cmr          XDBY = MAX(XDBY,0.)<a name='1749'></font>
              val  =          0.<a name='1750'>
              XDBY = MAX(XDBY,val)<a name='1751'>
              XQRCH = QESO(I,k)                                         &amp;<a name='1752'>
     &amp;              + GAMMA * XDBY / (HVAP * (1. + GAMMA))<a name='1753'>
              FACTOR = ETA(I,k-1) / ETA(I,k)<a name='1754'>
              ONEMF = 1. - FACTOR<a name='1755'>
              QCKO(I,k) = FACTOR * QCKO(I,k-1) + ONEMF *                &amp;<a name='1756'>
     &amp;                    .5 * (QO(I,k) + QO(I,k+1))<a name='1757'>
              DQ = ETA(I,k) * QCKO(I,k) - ETA(I,k) * XQRCH<a name='1758'>
              IF(DQ.GT.0.) THEN<a name='1759'>
                ETAH = .5 * (ETA(I,k) + ETA(I,k-1))<a name='1760'>
                QLK = DQ / (ETA(I,k) + ETAH * C0 * DZ)<a name='1761'>
                XAA0(I) = XAA0(I) - (ZO(I,k) - ZO(I,k-1)) * G * QLK<a name='1762'>
                XQC = QLK + XQRCH<a name='1763'>
                XPW = ETAH * C0 * DZ * QLK<a name='1764'>
                QCKO(I,k) = XQC<a name='1765'>
                XPWAV(I) = XPWAV(I) + XPW<a name='1766'>
              ENDIF<a name='1767'>
            ENDIF<a name='1768'>
<font color=#447700>!           IF(CNVFLG(I).AND.K.GT.KBCON(I).AND.K.LT.KTCON(I)) THEN<a name='1769'></font>
            IF(CNVFLG(I).AND.K.GT.KBCON(I).AND.K.LE.KTCON(I)) THEN<a name='1770'>
              DZ1 = ZO(I,k) - ZO(I,k-1)<a name='1771'>
              GAMMA = EL2ORC * QESO(I,k-1) / (TO(I,k-1)**2)<a name='1772'>
              RFACT =  1. + DELTA * CP * GAMMA                          &amp;<a name='1773'>
     &amp;                 * TO(I,k-1) / HVAP<a name='1774'>
              XDBY = HCKO(I,k-1) - HESO(I,k-1)<a name='1775'>
              XAA0(I) = XAA0(I)                                         &amp; <a name='1776'>
     &amp;                + DZ1 * (G / (CP * TO(I,k-1)))                    &amp;<a name='1777'>
     &amp;                * XDBY / (1. + GAMMA)                             &amp;<a name='1778'>
     &amp;                * RFACT<a name='1779'>
              val=0.<a name='1780'>
              XAA0(I)=XAA0(I)+                                          &amp;<a name='1781'>
     &amp;                 DZ1 * G * DELTA *                                &amp;<a name='1782'>
<font color=#447700>!cmr &amp;                 MAX( 0.,(QESO(I,k-1) - QO(I,k-1)))               &amp; <a name='1783'></font>
     &amp;                 MAX(val,(QESO(I,k-1) - QO(I,k-1)))<a name='1784'>
            ENDIF<a name='1785'>
          endif<a name='1786'>
        ENDDO<a name='1787'>
      ENDDO<a name='1788'>
<font color=#447700>!cccc IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I)) THEN<a name='1789'></font>
<font color=#447700>!cccc   PRINT *, ' XAA BEFORE DWNDRFT =', XAA0(I)<a name='1790'></font>
<font color=#447700>!cccc ENDIF<a name='1791'></font>
<font color=#447700>!<a name='1792'></font>
<font color=#447700>!------- DOWNDRAFT CALCULATIONS<a name='1793'></font>
<font color=#447700>!<a name='1794'></font>
<font color=#447700>!<a name='1795'></font>
<font color=#447700>!--- DOWNDRAFT MOISTURE PROPERTIES<a name='1796'></font>
<font color=#447700>!<a name='1797'></font>
      DO I = 1, IM<a name='1798'>
        XPWEV(I) = 0.<a name='1799'>
      ENDDO<a name='1800'>
      DO I = 1, IM<a name='1801'>
        IF(DWNFLG2(I)) THEN<a name='1802'>
          JMN = JMIN(I)<a name='1803'>
          XHCD(I) = HEO(I,JMN)<a name='1804'>
          XQCD(I) = QO(I,JMN)<a name='1805'>
          QRCD(I,JMN) = QESO(I,JMN)<a name='1806'>
        ENDIF<a name='1807'>
      ENDDO<a name='1808'>
      DO K = KM1, 1, -1<a name='1809'>
        DO I = 1, IM<a name='1810'>
          if (k .le. kmax(i)-1) then<a name='1811'>
            IF(DWNFLG2(I).AND.K.LT.JMIN(I)) THEN<a name='1812'>
              DQ = QESO(I,k)<a name='1813'>
              DT = TO(I,k)<a name='1814'>
              GAMMA    = EL2ORC * DQ / DT**2<a name='1815'>
              DH       = XHCD(I) - HESO(I,k)<a name='1816'>
              QRCD(I,k)=DQ+(1./HVAP)*(GAMMA/(1.+GAMMA))*DH<a name='1817'>
              DETAD    = ETAD(I,k+1) - ETAD(I,k)<a name='1818'>
              XPWD     = ETAD(I,k+1) * QRCD(I,k+1) -                    &amp;<a name='1819'>
     &amp;                   ETAD(I,k) * QRCD(I,k)<a name='1820'>
              XPWD     = XPWD - DETAD *                                 &amp; <a name='1821'>
     &amp;                 .5 * (QRCD(I,k) + QRCD(I,k+1))<a name='1822'>
              XPWEV(I) = XPWEV(I) + XPWD<a name='1823'>
            ENDIF<a name='1824'>
          endif<a name='1825'>
        ENDDO<a name='1826'>
      ENDDO<a name='1827'>
<font color=#447700>!<a name='1828'></font>
      DO I = 1, IM<a name='1829'>
        edtmax = edtmaxl<a name='1830'>
        if(SLIMSK(I).eq.0.) edtmax = edtmaxs<a name='1831'>
        IF(DWNFLG2(I)) THEN<a name='1832'>
          IF(XPWEV(I).GE.0.) THEN<a name='1833'>
            EDTX(I) = 0.<a name='1834'>
          ELSE<a name='1835'>
            EDTX(I) = -EDTX(I) * XPWAV(I) / XPWEV(I)<a name='1836'>
            EDTX(I) = MIN(EDTX(I),EDTMAX)<a name='1837'>
          ENDIF<a name='1838'>
        ELSE<a name='1839'>
          EDTX(I) = 0.<a name='1840'>
        ENDIF<a name='1841'>
      ENDDO<a name='1842'>
<font color=#447700>!<a name='1843'></font>
<font color=#447700>!<a name='1844'></font>
<font color=#447700>!<a name='1845'></font>
<font color=#447700>!--- DOWNDRAFT CLOUDWORK FUNCTIONS<a name='1846'></font>
<font color=#447700>!<a name='1847'></font>
<font color=#447700>!<a name='1848'></font>
      DO K = KM1, 1, -1<a name='1849'>
        DO I = 1, IM<a name='1850'>
          if (k .le. kmax(i)-1) then<a name='1851'>
            IF(DWNFLG2(I).AND.K.LT.JMIN(I)) THEN<a name='1852'>
              GAMMA = EL2ORC * QESO(I,k+1) / TO(I,k+1)**2<a name='1853'>
              DHH=XHCD(I)<a name='1854'>
              DT= TO(I,k+1)<a name='1855'>
              DG= GAMMA<a name='1856'>
              DH= HESO(I,k+1)<a name='1857'>
              DZ=-1.*(ZO(I,k+1)-ZO(I,k))<a name='1858'>
              XAA0(I)=XAA0(I)+EDTX(I)*DZ*(G/(CP*DT))*((DHH-DH)/(1.+DG)) &amp;<a name='1859'>
     &amp;                *(1.+DELTA*CP*DG*DT/HVAP)<a name='1860'>
              val=0.<a name='1861'>
              XAA0(I)=XAA0(I)+EDTX(I)*                                  &amp;<a name='1862'>
<font color=#447700>!cmr &amp;        DZ*G*DELTA*MAX( 0.,(QESO(I,k+1)-QO(I,k+1)))               &amp;<a name='1863'></font>
     &amp;        DZ*G*DELTA*MAX(val,(QESO(I,k+1)-QO(I,k+1)))<a name='1864'>
            ENDIF<a name='1865'>
          endif<a name='1866'>
        ENDDO<a name='1867'>
      ENDDO<a name='1868'>
<font color=#447700>!cccc IF(LAT.EQ.LATD.AND.lon.eq.lond.and.DWNFLG2(I)) THEN<a name='1869'></font>
<font color=#447700>!cccc   PRINT *, '  XAA AFTER DWNDRFT =', XAA0(I)<a name='1870'></font>
<font color=#447700>!cccc ENDIF<a name='1871'></font>
<font color=#447700>!<a name='1872'></font>
<font color=#447700>!  CALCULATE CRITICAL CLOUD WORK FUNCTION<a name='1873'></font>
<font color=#447700>!<a name='1874'></font>
      DO I = 1, IM<a name='1875'>
        ACRT(I) = 0.<a name='1876'>
        IF(CNVFLG(I)) THEN<a name='1877'>
<font color=#447700>!       IF(CNVFLG(I).AND.SLIMSK(I).NE.1.) THEN<a name='1878'></font>
          IF(PFLD(I,KTCON(I)).LT.PCRIT(15))THEN<a name='1879'>
            ACRT(I)=ACRIT(15)*(975.-PFLD(I,KTCON(I)))                   &amp;    <a name='1880'>
     &amp;              /(975.-PCRIT(15))<a name='1881'>
          ELSE IF(PFLD(I,KTCON(I)).GT.PCRIT(1))THEN<a name='1882'>
            ACRT(I)=ACRIT(1)<a name='1883'>
          ELSE<a name='1884'>
<font color=#447700>!cmr        K = IFIX((850. - PFLD(I,KTCON(I)))/50.) + 2<a name='1885'></font>
            K =  int((850. - PFLD(I,KTCON(I)))/50.) + 2<a name='1886'>
            K = MIN(K,15)<a name='1887'>
            K = MAX(K,2)<a name='1888'>
            ACRT(I)=ACRIT(K)+(ACRIT(K-1)-ACRIT(K))*                     &amp;<a name='1889'>
     &amp;           (PFLD(I,KTCON(I))-PCRIT(K))/(PCRIT(K-1)-PCRIT(K))<a name='1890'>
           ENDIF<a name='1891'>
<font color=#447700>!        ELSE<a name='1892'></font>
<font color=#447700>!          ACRT(I) = .5 * (PFLD(I,KBCON(I)) - PFLD(I,KTCON(I)))<a name='1893'></font>
         ENDIF<a name='1894'>
      ENDDO<a name='1895'>
      DO I = 1, IM<a name='1896'>
        ACRTFCT(I) = 1.<a name='1897'>
        IF(CNVFLG(I)) THEN<a name='1898'>
          if(SLIMSK(I).eq.1.) THEN<a name='1899'>
            w1 = w1l<a name='1900'>
            w2 = w2l<a name='1901'>
            w3 = w3l<a name='1902'>
            w4 = w4l<a name='1903'>
          else<a name='1904'>
            w1 = w1s<a name='1905'>
            w2 = w2s<a name='1906'>
            w3 = w3s<a name='1907'>
            w4 = w4s<a name='1908'>
          ENDIF<a name='1909'>
<font color=#447700>!C       IF(CNVFLG(I).AND.SLIMSK(I).EQ.1.) THEN<a name='1910'></font>
<font color=#447700>!         ACRTFCT(I) = PDOT(I) / W3<a name='1911'></font>
<font color=#447700>!<a name='1912'></font>
<font color=#447700>!  modify critical cloud workfunction by cloud base vertical velocity<a name='1913'></font>
<font color=#447700>!<a name='1914'></font>
          IF(PDOT(I).LE.W4) THEN<a name='1915'>
            ACRTFCT(I) = (PDOT(I) - W4) / (W3 - W4)<a name='1916'>
          ELSEIF(PDOT(I).GE.-W4) THEN<a name='1917'>
            ACRTFCT(I) = - (PDOT(I) + W4) / (W4 - W3)<a name='1918'>
          ELSE<a name='1919'>
            ACRTFCT(I) = 0.<a name='1920'>
          ENDIF<a name='1921'>
<font color=#447700>!cmr      ACRTFCT(I) = MAX(ACRTFCT(I),-1.)<a name='1922'></font>
          val1    =             -1.<a name='1923'>
          ACRTFCT(I) = MAX(ACRTFCT(I),val1)<a name='1924'>
<font color=#447700>!cmr      ACRTFCT(I) = MIN(ACRTFCT(I),1.)<a name='1925'></font>
          val2    =             1.<a name='1926'>
          ACRTFCT(I) = MIN(ACRTFCT(I),val2)<a name='1927'>
          ACRTFCT(I) = 1. - ACRTFCT(I)<a name='1928'>
<font color=#447700>!<a name='1929'></font>
<font color=#447700>!  modify ACRTFCT(I) by colume mean rh if RHBAR(I) is greater than 80 percent<a name='1930'></font>
<font color=#447700>!<a name='1931'></font>
<font color=#447700>!         if(RHBAR(I).ge..8) THEN<a name='1932'></font>
<font color=#447700>!           ACRTFCT(I) = ACRTFCT(I) * (.9 - min(RHBAR(I),.9)) * 10.<a name='1933'></font>
<font color=#447700>!         ENDIF<a name='1934'></font>
<font color=#447700>!<a name='1935'></font>
<font color=#447700>!  modify adjustment time scale by cloud base vertical velocity<a name='1936'></font>
<font color=#447700>!<a name='1937'></font>
          DTCONV(I) = DT2 + max((1800. - DT2),RZERO) *                  &amp;<a name='1938'>
     &amp;                (PDOT(I) - W2) / (W1 - W2)<a name='1939'>
<font color=#447700>!         DTCONV(I) = MAX(DTCONV(I), DT2)<a name='1940'></font>
<font color=#447700>!         DTCONV(I) = 1800. * (PDOT(I) - w2) / (w1 - w2)<a name='1941'></font>
          DTCONV(I) = max(DTCONV(I),dtmin)<a name='1942'>
          DTCONV(I) = min(DTCONV(I),dtmax)<a name='1943'>
<a name='1944'>
        ENDIF<a name='1945'>
      ENDDO<a name='1946'>
<font color=#447700>!<a name='1947'></font>
<font color=#447700>!--- LARGE SCALE FORCING<a name='1948'></font>
<font color=#447700>!<a name='1949'></font>
      DO I= 1, IM<a name='1950'>
        FLG(I) = CNVFLG(I)<a name='1951'>
        IF(CNVFLG(I)) THEN<a name='1952'>
<font color=#447700>!         F = AA1(I) / DTCONV(I)<a name='1953'></font>
          FLD(I) = (AA1(I) - ACRT(I) * ACRTFCT(I)) / DTCONV(I)<a name='1954'>
          IF(FLD(I).LE.0.) FLG(I) = .FALSE.<a name='1955'>
        ENDIF<a name='1956'>
        CNVFLG(I) = FLG(I)<a name='1957'>
        IF(CNVFLG(I)) THEN<a name='1958'>
<font color=#447700>!         XAA0(I) = MAX(XAA0(I),0.)<a name='1959'></font>
          XK(I) = (XAA0(I) - AA1(I)) / MBDT<a name='1960'>
          IF(XK(I).GE.0.) FLG(I) = .FALSE.<a name='1961'>
        ENDIF<a name='1962'>
<font color=#447700>!<a name='1963'></font>
<font color=#447700>!--- KERNEL, CLOUD BASE MASS FLUX<a name='1964'></font>
<font color=#447700>!<a name='1965'></font>
        CNVFLG(I) = FLG(I)<a name='1966'>
        IF(CNVFLG(I)) THEN<a name='1967'>
          XMB(I) = -FLD(I) / XK(I)<a name='1968'>
          XMB(I) = MIN(XMB(I),XMBMAX(I))<a name='1969'>
        ENDIF<a name='1970'>
      ENDDO<a name='1971'>
<font color=#447700>!      IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I)) THEN<a name='1972'></font>
<font color=#447700>!        print *, ' RHBAR(I), ACRTFCT(I) =', RHBAR(I), ACRTFCT(I)<a name='1973'></font>
<font color=#447700>!        PRINT *, '  A1, XA =', AA1(I), XAA0(I)<a name='1974'></font>
<font color=#447700>!        PRINT *, ' XMB(I), ACRT =', XMB(I), ACRT<a name='1975'></font>
<font color=#447700>!      ENDIF<a name='1976'></font>
      TOTFLG = .TRUE.<a name='1977'>
      DO I = 1, IM<a name='1978'>
        TOTFLG = TOTFLG .AND. (.NOT. CNVFLG(I))<a name='1979'>
      ENDDO<a name='1980'>
      IF(TOTFLG) RETURN<a name='1981'>
<font color=#447700>!<a name='1982'></font>
<font color=#447700>!  restore t0 and QO to t1 and q1 in case convection stops<a name='1983'></font>
<font color=#447700>!<a name='1984'></font>
      do k = 1, km<a name='1985'>
        DO I = 1, IM<a name='1986'>
          if (k .le. kmax(i)) then<a name='1987'>
            TO(I,k) = T1(I,k)<a name='1988'>
            QO(I,k) = Q1(I,k)<a name='1989'>
<font color=#447700>!jfe        QESO(I,k) = 10. * FPVS(T1(I,k))<a name='1990'></font>
<font color=#447700>!<a name='1991'></font>
            QESO(I,k) = 0.01 * fpvs(T1(I,K))      <font color=#447700>! fpvs is in Pa<a name='1992'></font>
<font color=#447700>!<a name='1993'></font>
            QESO(I,k) = EPS * QESO(I,k) / (PFLD(I,k) + EPSM1*QESO(I,k))<a name='1994'>
<font color=#447700>!cmr        QESO(I,k) = MAX(QESO(I,k),1.E-8)<a name='1995'></font>
            val     =             1.E-8<a name='1996'>
            QESO(I,k) = MAX(QESO(I,k), val )<a name='1997'>
          endif<a name='1998'>
        enddo<a name='1999'>
      enddo<a name='2000'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2001'></font>
<font color=#447700>!<a name='2002'></font>
<font color=#447700>!--- FEEDBACK: SIMPLY THE CHANGES FROM THE CLOUD WITH UNIT MASS FLUX<a name='2003'></font>
<font color=#447700>!---           MULTIPLIED BY  THE MASS FLUX NECESSARY TO KEEP THE<a name='2004'></font>
<font color=#447700>!---           EQUILIBRIUM WITH THE LARGER-SCALE.<a name='2005'></font>
<font color=#447700>!<a name='2006'></font>
      DO I = 1, IM<a name='2007'>
        DELHBAR(I) = 0.<a name='2008'>
        DELQBAR(I) = 0.<a name='2009'>
        DELTBAR(I) = 0.<a name='2010'>
        QCOND(I) = 0.<a name='2011'>
      ENDDO<a name='2012'>
      DO K = 1, KM<a name='2013'>
        DO I = 1, IM<a name='2014'>
          if (k .le. kmax(i)) then<a name='2015'>
            IF(CNVFLG(I).AND.K.LE.KTCON(I)) THEN<a name='2016'>
              AUP = 1.<a name='2017'>
              IF(K.Le.KB(I)) AUP = 0.<a name='2018'>
              ADW = 1.<a name='2019'>
              IF(K.GT.JMIN(I)) ADW = 0.<a name='2020'>
              DELLAT = (DELLAH(I,k) - HVAP * DELLAQ(I,k)) / CP<a name='2021'>
              T1(I,k) = T1(I,k) + DELLAT * XMB(I) * DT2<a name='2022'>
              Q1(I,k) = Q1(I,k) + DELLAQ(I,k) * XMB(I) * DT2<a name='2023'>
              U1(I,k) = U1(I,k) + DELLAU(I,k) * XMB(I) * DT2<a name='2024'>
              V1(I,k) = V1(I,k) + DELLAV(I,k) * XMB(I) * DT2<a name='2025'>
              DP = 1000. * DEL(I,K)<a name='2026'>
              DELHBAR(I) = DELHBAR(I) + DELLAH(I,k)*XMB(I)*DP/G<a name='2027'>
              DELQBAR(I) = DELQBAR(I) + DELLAQ(I,k)*XMB(I)*DP/G<a name='2028'>
              DELTBAR(I) = DELTBAR(I) + DELLAT*XMB(I)*DP/G<a name='2029'>
            ENDIF<a name='2030'>
          endif<a name='2031'>
        ENDDO<a name='2032'>
      ENDDO<a name='2033'>
      DO K = 1, KM<a name='2034'>
        DO I = 1, IM<a name='2035'>
          if (k .le. kmax(i)) then<a name='2036'>
            IF(CNVFLG(I).AND.K.LE.KTCON(I)) THEN<a name='2037'>
<font color=#447700>!jfe          QESO(I,k) = 10. * FPVS(T1(I,k))<a name='2038'></font>
<font color=#447700>!<a name='2039'></font>
              QESO(I,k) = 0.01 * fpvs(T1(I,K))      <font color=#447700>! fpvs is in Pa<a name='2040'></font>
<font color=#447700>!<a name='2041'></font>
              QESO(I,k) = EPS * QESO(I,k)/(PFLD(I,k) + EPSM1*QESO(I,k))<a name='2042'>
<font color=#447700>!cmr          QESO(I,k) = MAX(QESO(I,k),1.E-8)<a name='2043'></font>
              val     =             1.E-8<a name='2044'>
              QESO(I,k) = MAX(QESO(I,k), val )<a name='2045'>
<font color=#447700>!<a name='2046'></font>
<font color=#447700>!  cloud water<a name='2047'></font>
<font color=#447700>!<a name='2048'></font>
              if(ncloud.gt.0.and.CNVFLG(I).and.k.eq.KTCON(I)) THEN<a name='2049'>
                tem  = DELLAL(I) * XMB(I) * dt2<a name='2050'>
                tem1 = MAX(RZERO, MIN(RONE, (TCR-t1(I,K))*TCRF))<a name='2051'>
                if (QL(I,k,2) .gt. -999.0) then<a name='2052'>
                  QL(I,k,1) = QL(I,k,1) + tem * tem1            <font color=#447700>! Ice<a name='2053'></font>
                  QL(I,k,2) = QL(I,k,2) + tem *(1.0-tem1)       <font color=#447700>! Water<a name='2054'></font>
                else<a name='2055'>
                  tem2      = QL(I,k,1) + tem<a name='2056'>
                  QL(I,k,1) = tem2 * tem1                       <font color=#447700>! Ice<a name='2057'></font>
                  QL(I,k,2) = tem2 - QL(I,k,1)                  <font color=#447700>! Water<a name='2058'></font>
                endif<a name='2059'>
<font color=#447700>!               QL(I,k) = QL(I,k) + DELLAL(I) * XMB(I) * dt2<a name='2060'></font>
                dp = 1000. * del(i,k)<a name='2061'>
                DELLAL(I) = DELLAL(I) * XMB(I) * dp / g<a name='2062'>
              ENDIF<a name='2063'>
            ENDIF<a name='2064'>
          endif<a name='2065'>
        ENDDO<a name='2066'>
      ENDDO<a name='2067'>
<font color=#447700>!     IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I) ) THEN<a name='2068'></font>
<font color=#447700>!       PRINT *, ' DELHBAR, DELQBAR, DELTBAR ='<a name='2069'></font>
<font color=#447700>!       PRINT *, DELHBAR, HVAP*DELQBAR, CP*DELTBAR<a name='2070'></font>
<font color=#447700>!       PRINT *, '   DELLBAR ='<a name='2071'></font>
<font color=#447700>!       PRINT 6003,  HVAP*DELLbar<a name='2072'></font>
<font color=#447700>!       PRINT *, '   DELLAQ ='<a name='2073'></font>
<font color=#447700>!       PRINT 6003, (HVAP*DELLAQ(I,k)*XMB(I),K=1,KMAX)<a name='2074'></font>
<font color=#447700>!       PRINT *, '   DELLAT ='<a name='2075'></font>
<font color=#447700>!       PRINT 6003, (DELLAH(i,k)*XMB(I)-HVAP*DELLAQ(I,k)*XMB(I),         &amp;<a name='2076'></font>
<font color=#447700>!    &amp;               K=1,KMAX)<a name='2077'></font>
<font color=#447700>!     ENDIF<a name='2078'></font>
      DO I = 1, IM<a name='2079'>
        RNTOT(I) = 0.<a name='2080'>
        DELQEV(I) = 0.<a name='2081'>
        DELQ2(I) = 0.<a name='2082'>
        FLG(I) = CNVFLG(I)<a name='2083'>
      ENDDO<a name='2084'>
      DO K = KM, 1, -1<a name='2085'>
        DO I = 1, IM<a name='2086'>
          if (k .le. kmax(i)) then<a name='2087'>
            IF(CNVFLG(I).AND.K.LE.KTCON(I)) THEN<a name='2088'>
              AUP = 1.<a name='2089'>
              IF(K.Le.KB(I)) AUP = 0.<a name='2090'>
              ADW = 1.<a name='2091'>
              IF(K.GT.JMIN(I)) ADW = 0.<a name='2092'>
              rain =  AUP * PWO(I,k) + ADW * EDTO(I) * PWDO(I,k)<a name='2093'>
              RNTOT(I) = RNTOT(I) + rain * XMB(I) * .001 * dt2<a name='2094'>
            ENDIF<a name='2095'>
          endif<a name='2096'>
        ENDDO<a name='2097'>
      ENDDO<a name='2098'>
      DO K = KM, 1, -1<a name='2099'>
        DO I = 1, IM<a name='2100'>
          if (k .le. kmax(i)) then<a name='2101'>
            DELTV(I) = 0.<a name='2102'>
            DELQ(I) = 0.<a name='2103'>
            QEVAP(I) = 0.<a name='2104'>
            IF(CNVFLG(I).AND.K.LE.KTCON(I)) THEN<a name='2105'>
              AUP = 1.<a name='2106'>
              IF(K.Le.KB(I)) AUP = 0.<a name='2107'>
              ADW = 1.<a name='2108'>
              IF(K.GT.JMIN(I)) ADW = 0.<a name='2109'>
              rain =  AUP * PWO(I,k) + ADW * EDTO(I) * PWDO(I,k)<a name='2110'>
              RN(I) = RN(I) + rain * XMB(I) * .001 * dt2<a name='2111'>
            ENDIF<a name='2112'>
            IF(FLG(I).AND.K.LE.KTCON(I)) THEN<a name='2113'>
              evef = EDT(I) * evfact<a name='2114'>
              if(SLIMSK(I).eq.1.) evef=EDT(I) * evfactl<a name='2115'>
<font color=#447700>!             if(SLIMSK(I).eq.1.) evef=.07<a name='2116'></font>
<font color=#447700>!             if(SLIMSK(I).ne.1.) evef = 0.<a name='2117'></font>
              QCOND(I) = EVEF * (Q1(I,k) - QESO(I,k))                   &amp;<a name='2118'>
     &amp;                 / (1. + EL2ORC * QESO(I,k) / T1(I,k)**2)<a name='2119'>
              DP = 1000. * DEL(I,K)<a name='2120'>
              IF(RN(I).GT.0..AND.QCOND(I).LT.0.) THEN<a name='2121'>
                QEVAP(I) = -QCOND(I) * (1.-EXP(-.32*SQRT(DT2*RN(I))))<a name='2122'>
                QEVAP(I) = MIN(QEVAP(I), RN(I)*1000.*G/DP)<a name='2123'>
                DELQ2(I) = DELQEV(I) + .001 * QEVAP(I) * dp / g<a name='2124'>
              ENDIF<a name='2125'>
              if(RN(I).gt.0..and.QCOND(I).LT.0..and.                    &amp;<a name='2126'>
     &amp;           DELQ2(I).gt.RNTOT(I)) THEN<a name='2127'>
                QEVAP(I) = 1000.* g * (RNTOT(I) - DELQEV(I)) / dp<a name='2128'>
                FLG(I) = .false.<a name='2129'>
              ENDIF<a name='2130'>
              IF(RN(I).GT.0..AND.QEVAP(I).gt.0.) THEN<a name='2131'>
                Q1(I,k) = Q1(I,k) + QEVAP(I)<a name='2132'>
                T1(I,k) = T1(I,k) - ELOCP * QEVAP(I)<a name='2133'>
                RN(I) = RN(I) - .001 * QEVAP(I) * DP / G<a name='2134'>
                DELTV(I) = - ELOCP*QEVAP(I)/DT2<a name='2135'>
                DELQ(I) =  + QEVAP(I)/DT2<a name='2136'>
                DELQEV(I) = DELQEV(I) + .001*dp*QEVAP(I)/g<a name='2137'>
              ENDIF<a name='2138'>
              DELLAQ(I,k) = DELLAQ(I,k) + DELQ(I) / XMB(I)<a name='2139'>
              DELQBAR(I) = DELQBAR(I) + DELQ(I)*DP/G<a name='2140'>
              DELTBAR(I) = DELTBAR(I) + DELTV(I)*DP/G<a name='2141'>
            ENDIF<a name='2142'>
          endif<a name='2143'>
        ENDDO<a name='2144'>
      ENDDO<a name='2145'>
<font color=#447700>!      IF(LAT.EQ.LATD.AND.lon.eq.lond.and.CNVFLG(I) ) THEN<a name='2146'></font>
<font color=#447700>!        PRINT *, '   DELLAH ='<a name='2147'></font>
<font color=#447700>!        PRINT 6003, (DELLAH(k)*XMB(I),K=1,KMAX)<a name='2148'></font>
<font color=#447700>!        PRINT *, '   DELLAQ ='<a name='2149'></font>
<font color=#447700>!        PRINT 6003, (HVAP*DELLAQ(I,k)*XMB(I),K=1,KMAX)<a name='2150'></font>
<font color=#447700>!        PRINT *, ' DELHBAR, DELQBAR, DELTBAR ='<a name='2151'></font>
<font color=#447700>!        PRINT *, DELHBAR, HVAP*DELQBAR, CP*DELTBAR<a name='2152'></font>
<font color=#447700>!        PRINT *, ' PRECIP =', HVAP*RN(I)*1000./DT2<a name='2153'></font>
<font color=#447700>!CCCC   PRINT *, '   DELLBAR ='<a name='2154'></font>
<font color=#447700>!CCCC   PRINT *,  HVAP*DELLbar<a name='2155'></font>
<font color=#447700>!      ENDIF<a name='2156'></font>
<font color=#447700>!<a name='2157'></font>
<font color=#447700>!  PRECIPITATION RATE CONVERTED TO ACTUAL PRECIP<a name='2158'></font>
<font color=#447700>!  IN UNIT OF M INSTEAD OF KG<a name='2159'></font>
<font color=#447700>!<a name='2160'></font>
      DO I = 1, IM<a name='2161'>
        IF(CNVFLG(I)) THEN<a name='2162'>
<font color=#447700>!<a name='2163'></font>
<font color=#447700>!  IN THE EVENT OF UPPER LEVEL RAIN EVAPORATION AND LOWER LEVEL DOWNDRAF<a name='2164'></font>
<font color=#447700>!    MOISTENING, RN CAN BECOME NEGATIVE, IN THIS CASE, WE BACK OUT OF TH<a name='2165'></font>
<font color=#447700>!    HEATING AND THE MOISTENING<a name='2166'></font>
<font color=#447700>!<a name='2167'></font>
          if(RN(I).lt.0..and..not.FLG(I)) RN(I) = 0.<a name='2168'>
          IF(RN(I).LE.0.) THEN<a name='2169'>
            RN(I) = 0.<a name='2170'>
          ELSE<a name='2171'>
            KTOP(I) = KTCON(I)<a name='2172'>
            KBOT(I) = KBCON(I)<a name='2173'>
            KUO(I) = 1<a name='2174'>
            CLDWRK(I) = AA1(I)<a name='2175'>
          ENDIF<a name='2176'>
        ENDIF<a name='2177'>
      ENDDO<a name='2178'>
      DO K = 1, KM<a name='2179'>
        DO I = 1, IM<a name='2180'>
          if (k .le. kmax(i)) then<a name='2181'>
            IF(CNVFLG(I).AND.RN(I).LE.0.) THEN<a name='2182'>
              T1(I,k) = TO(I,k)<a name='2183'>
              Q1(I,k) = QO(I,k)<a name='2184'>
            ENDIF<a name='2185'>
          endif<a name='2186'>
        ENDDO<a name='2187'>
      ENDDO<a name='2188'>
<font color=#447700>!!<a name='2189'></font>
      RETURN<a name='2190'>
   END SUBROUTINE OSASCNV<a name='2191'>
<a name='2192'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2193'></font>
<a name='2194'>
<A NAME='SHALCV'><A href='../../html_code/phys/module_cu_osas.F.html#SHALCV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2195'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SHALCV</font>(IM,IX,KM,DT,DEL,PRSI,PRSL,PRSLK,KUO,Q,T,DPSHC) <A href='../../call_to/SHALCV.html' TARGET='index'>1</A>,<A href='../../call_from/SHALCV.html' TARGET='index'>4</A><a name='2196'>
<font color=#447700>!<a name='2197'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_cu_osas.F.html#SHALCV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_13"> , ONLY : kind_phys<a name='2198'>
      USE <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_PHYSCONS</A><A href='../../html_code/phys/module_cu_osas.F.html#SHALCV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_7">, grav =&gt; con_g, CP =&gt; con_CP, HVAP =&gt; con_HVAP &amp;<a name='2199'>
     &amp;,             RD =&gt; con_RD<a name='2200'>
<a name='2201'>
      implicit none<a name='2202'>
<font color=#447700>!<a name='2203'></font>
<font color=#447700>!     include 'constant.h'<a name='2204'></font>
<font color=#447700>!<a name='2205'></font>
      integer              IM, IX, KM, KUO(IM)<a name='2206'>
      real(kind=kind_phys) DEL(IX,KM),   PRSI(IX,KM+1), PRSL(IX,KM),    &amp;<a name='2207'>
     &amp;                     PRSLK(IX,KM),                                &amp;<a name='2208'>
     &amp;                     Q(IX,KM),     T(IX,KM),      DT, DPSHC<a name='2209'>
<font color=#447700>!<a name='2210'></font>
<font color=#447700>!     Locals<a name='2211'></font>
<font color=#447700>!<a name='2212'></font>
      real(kind=kind_phys) ck,    cpdt,   dmse,   dsdz1, dsdz2,         &amp;<a name='2213'>
     &amp;                     dsig,  dtodsl, dtodsu, eldq,  g,             &amp;<a name='2214'>
     &amp;                     gocp,  rtdls<a name='2215'>
<font color=#447700>!<a name='2216'></font>
      integer              k,k1,k2,kliftl,kliftu,kt,N2,I,iku,ik1,ik,ii<a name='2217'>
      integer              INDEX2(IM), KLCL(IM), KBOT(IM), KTOP(IM),kk  &amp;<a name='2218'>
     &amp;,                    KTOPM(IM)<a name='2219'>
<font color=#447700>!!<a name='2220'></font>
<font color=#447700>!  PHYSICAL PARAMETERS<a name='2221'></font>
      PARAMETER(G=GRAV, GOCP=G/CP)<a name='2222'>
<font color=#447700>!  BOUNDS OF PARCEL ORIGIN<a name='2223'></font>
      PARAMETER(KLIFTL=2,KLIFTU=2)<a name='2224'>
      LOGICAL   LSHC(IM)<a name='2225'>
      real(kind=kind_phys) Q2(IM*KM),     T2(IM*KM),                    &amp;<a name='2226'>
     &amp;                     PRSL2(IM*KM),  PRSLK2(IM*KM),                &amp;<a name='2227'>
     &amp;                     AL(IM*(KM-1)), AD(IM*KM), AU(IM*(KM-1))<a name='2228'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2229'></font>
<font color=#447700>!  COMPRESS FIELDS TO POINTS WITH NO DEEP CONVECTION<a name='2230'></font>
<font color=#447700>!  AND MOIST STATIC INSTABILITY.<a name='2231'></font>
      DO I=1,IM<a name='2232'>
        LSHC(I)=.FALSE.<a name='2233'>
      ENDDO<a name='2234'>
      DO K=1,KM-1<a name='2235'>
        DO I=1,IM<a name='2236'>
          IF(KUO(I).EQ.0) THEN<a name='2237'>
            ELDQ    = HVAP*(Q(I,K)-Q(I,K+1))<a name='2238'>
            CPDT    = CP*(T(I,K)-T(I,K+1))<a name='2239'>
            RTDLS   = (PRSL(I,K)-PRSL(I,K+1)) /                         &amp;<a name='2240'>
     &amp;                 PRSI(I,K+1)*RD*0.5*(T(I,K)+T(I,K+1))<a name='2241'>
            DMSE    = ELDQ+CPDT-RTDLS<a name='2242'>
            LSHC(I) = LSHC(I).OR.DMSE.GT.0.<a name='2243'>
          ENDIF<a name='2244'>
        ENDDO<a name='2245'>
      ENDDO<a name='2246'>
      N2 = 0<a name='2247'>
      DO I=1,IM<a name='2248'>
        IF(LSHC(I)) THEN<a name='2249'>
          N2         = N2 + 1<a name='2250'>
          INDEX2(N2) = I<a name='2251'>
        ENDIF<a name='2252'>
      ENDDO<a name='2253'>
      IF(N2.EQ.0) RETURN<a name='2254'>
      DO K=1,KM<a name='2255'>
        KK = (K-1)*N2<a name='2256'>
        DO I=1,N2<a name='2257'>
          IK         = KK + I<a name='2258'>
          ii         = index2(i)<a name='2259'>
          Q2(IK)     = Q(II,K)<a name='2260'>
          T2(IK)     = T(II,K)<a name='2261'>
          PRSL2(IK)  = PRSL(II,K)<a name='2262'>
          PRSLK2(IK) = PRSLK(II,K)<a name='2263'>
        ENDDO<a name='2264'>
      ENDDO<a name='2265'>
      do i=1,N2<a name='2266'>
        ktopm(i) = KM<a name='2267'>
      enddo<a name='2268'>
      do k=2,KM<a name='2269'>
        do i=1,N2<a name='2270'>
          ii = index2(i)<a name='2271'>
          if (prsi(ii,1)-prsi(ii,k) .le. dpshc) ktopm(i) = k<a name='2272'>
        enddo<a name='2273'>
      enddo<a name='2274'>
<a name='2275'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2276'></font>
<font color=#447700>!  COMPUTE MOIST ADIABAT AND DETERMINE LIMITS OF SHALLOW CONVECTION.<a name='2277'></font>
<font color=#447700>!  CHECK FOR MOIST STATIC INSTABILITY AGAIN WITHIN CLOUD.<a name='2278'></font>
      CALL <A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3'>MSTADBT3</A><A href='../../html_code/phys/module_cu_osas.F.html#SHALCV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MSTADBT3_1">(N2,KM-1,KLIFTL,KLIFTU,PRSL2,PRSLK2,T2,Q2,           &amp;<a name='2279'>
     &amp;            KLCL,KBOT,KTOP,AL,AU)<a name='2280'>
      DO I=1,N2<a name='2281'>
        KBOT(I) = min(KLCL(I)-1, ktopm(i)-1)<a name='2282'>
        KTOP(I) = min(KTOP(I)+1, ktopm(i))<a name='2283'>
        LSHC(I) = .FALSE.<a name='2284'>
      ENDDO<a name='2285'>
      DO K=1,KM-1<a name='2286'>
        KK = (K-1)*N2<a name='2287'>
        DO I=1,N2<a name='2288'>
          IF(K.GE.KBOT(I).AND.K.LT.KTOP(I)) THEN<a name='2289'>
            IK      = KK + I<a name='2290'>
            IKU     = IK + N2<a name='2291'>
            ELDQ    = HVAP * (Q2(IK)-Q2(IKU))<a name='2292'>
            CPDT    = CP   * (T2(IK)-T2(IKU))<a name='2293'>
            RTDLS   = (PRSL2(IK)-PRSL2(IKU)) /                          &amp;<a name='2294'>
     &amp;                 PRSI(index2(i),K+1)*RD*0.5*(T2(IK)+T2(IKU))<a name='2295'>
            DMSE    = ELDQ + CPDT - RTDLS<a name='2296'>
            LSHC(I) = LSHC(I).OR.DMSE.GT.0.<a name='2297'>
            AU(IK)  = G/RTDLS<a name='2298'>
          ENDIF<a name='2299'>
        ENDDO<a name='2300'>
      ENDDO<a name='2301'>
      K1=KM+1<a name='2302'>
      K2=0<a name='2303'>
      DO I=1,N2<a name='2304'>
        IF(.NOT.LSHC(I)) THEN<a name='2305'>
          KBOT(I) = KM+1<a name='2306'>
          KTOP(I) = 0<a name='2307'>
        ENDIF<a name='2308'>
        K1 = MIN(K1,KBOT(I))<a name='2309'>
        K2 = MAX(K2,KTOP(I))<a name='2310'>
      ENDDO<a name='2311'>
      KT = K2-K1+1<a name='2312'>
      IF(KT.LT.2) RETURN<a name='2313'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2314'></font>
<font color=#447700>!  SET EDDY VISCOSITY COEFFICIENT CKU AT SIGMA INTERFACES.<a name='2315'></font>
<font color=#447700>!  COMPUTE DIAGONALS AND RHS FOR TRIDIAGONAL MATRIX SOLVER.<a name='2316'></font>
<font color=#447700>!  EXPAND FINAL FIELDS.<a name='2317'></font>
      KK = (K1-1) * N2<a name='2318'>
      DO I=1,N2<a name='2319'>
        IK     = KK + I<a name='2320'>
        AD(IK) = 1.<a name='2321'>
      ENDDO<a name='2322'>
<font color=#447700>!<a name='2323'></font>
<font color=#447700>!     DTODSU=DT/DEL(K1)<a name='2324'></font>
      DO K=K1,K2-1<a name='2325'>
<font color=#447700>!       DTODSL=DTODSU<a name='2326'></font>
<font color=#447700>!       DTODSU=   DT/DEL(K+1)<a name='2327'></font>
<font color=#447700>!       DSIG=SL(K)-SL(K+1)<a name='2328'></font>
        KK = (K-1) * N2<a name='2329'>
        DO I=1,N2<a name='2330'>
          ii     = index2(i)<a name='2331'>
          DTODSL = DT/DEL(II,K)<a name='2332'>
          DTODSU = DT/DEL(II,K+1)<a name='2333'>
          DSIG   = PRSL(II,K) - PRSL(II,K+1)<a name='2334'>
          IK     = KK + I<a name='2335'>
          IKU    = IK + N2<a name='2336'>
          IF(K.EQ.KBOT(I)) THEN<a name='2337'>
            CK=1.5<a name='2338'>
          ELSEIF(K.EQ.KTOP(I)-1) THEN<a name='2339'>
            CK=1.<a name='2340'>
          ELSEIF(K.EQ.KTOP(I)-2) THEN<a name='2341'>
            CK=3.<a name='2342'>
          ELSEIF(K.GT.KBOT(I).AND.K.LT.KTOP(I)-2) THEN<a name='2343'>
            CK=5.<a name='2344'>
          ELSE<a name='2345'>
            CK=0.<a name='2346'>
          ENDIF<a name='2347'>
          DSDZ1   = CK*DSIG*AU(IK)*GOCP<a name='2348'>
          DSDZ2   = CK*DSIG*AU(IK)*AU(IK)<a name='2349'>
          AU(IK)  = -DTODSL*DSDZ2<a name='2350'>
          AL(IK)  = -DTODSU*DSDZ2<a name='2351'>
          AD(IK)  = AD(IK)-AU(IK)<a name='2352'>
          AD(IKU) = 1.-AL(IK)<a name='2353'>
          T2(IK)  = T2(IK)+DTODSL*DSDZ1<a name='2354'>
          T2(IKU) = T2(IKU)-DTODSU*DSDZ1<a name='2355'>
        ENDDO<a name='2356'>
      ENDDO<a name='2357'>
      IK1=(K1-1)*N2+1<a name='2358'>
      CALL <A href='../../html_code/phys/module_cu_sas.F.html#TRIDI2T3'>TRIDI2T3</A><A href='../../html_code/phys/module_cu_osas.F.html#SHALCV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDI2T3_1">(N2,KT,AL(IK1),AD(IK1),AU(IK1),Q2(IK1),T2(IK1),      &amp;<a name='2359'>
     &amp;                                  AU(IK1),Q2(IK1),T2(IK1))<a name='2360'>
      DO K=K1,K2<a name='2361'>
        KK = (K-1)*N2<a name='2362'>
        DO I=1,N2<a name='2363'>
          IK = KK + I<a name='2364'>
          Q(INDEX2(I),K) = Q2(IK)<a name='2365'>
          T(INDEX2(I),K) = T2(IK)<a name='2366'>
        ENDDO<a name='2367'>
      ENDDO<a name='2368'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2369'></font>
      RETURN<a name='2370'>
      END SUBROUTINE SHALCV<a name='2371'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2372'></font>
<A NAME='TRIDI2T3'><A href='../../html_code/phys/module_cu_osas.F.html#TRIDI2T3' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2373'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TRIDI2T3</font>(L,N,CL,CM,CU,R1,R2,AU,A1,A2) <A href='../../call_to/TRIDI2T3.html' TARGET='index'>2</A>,<A href='../../call_from/TRIDI2T3.html' TARGET='index'>2</A><a name='2374'>
<font color=#447700>!yt      INCLUDE DBTRIDI2;<a name='2375'></font>
<font color=#447700>!!<a name='2376'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_cu_sas.F.html#TRIDI2T3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_14"> , ONLY : kind_phys<a name='2377'>
      implicit none<a name='2378'>
      integer             k,n,l,i<a name='2379'>
      real(kind=kind_phys) fk<a name='2380'>
<font color=#447700>!!<a name='2381'></font>
      real(kind=kind_phys)                                              &amp;<a name='2382'>
     &amp;          CL(L,2:N),CM(L,N),CU(L,N-1),R1(L,N),R2(L,N),            &amp;<a name='2383'>
     &amp;          AU(L,N-1),A1(L,N),A2(L,N)<a name='2384'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2385'></font>
      DO I=1,L<a name='2386'>
        FK=1./CM(I,1)<a name='2387'>
        AU(I,1)=FK*CU(I,1)<a name='2388'>
        A1(I,1)=FK*R1(I,1)<a name='2389'>
        A2(I,1)=FK*R2(I,1)<a name='2390'>
      ENDDO<a name='2391'>
      DO K=2,N-1<a name='2392'>
        DO I=1,L<a name='2393'>
          FK=1./(CM(I,K)-CL(I,K)*AU(I,K-1))<a name='2394'>
          AU(I,K)=FK*CU(I,K)<a name='2395'>
          A1(I,K)=FK*(R1(I,K)-CL(I,K)*A1(I,K-1))<a name='2396'>
          A2(I,K)=FK*(R2(I,K)-CL(I,K)*A2(I,K-1))<a name='2397'>
        ENDDO<a name='2398'>
      ENDDO<a name='2399'>
      DO I=1,L<a name='2400'>
        FK=1./(CM(I,N)-CL(I,N)*AU(I,N-1))<a name='2401'>
        A1(I,N)=FK*(R1(I,N)-CL(I,N)*A1(I,N-1))<a name='2402'>
        A2(I,N)=FK*(R2(I,N)-CL(I,N)*A2(I,N-1))<a name='2403'>
      ENDDO<a name='2404'>
      DO K=N-1,1,-1<a name='2405'>
        DO I=1,L<a name='2406'>
          A1(I,K)=A1(I,K)-AU(I,K)*A1(I,K+1)<a name='2407'>
          A2(I,K)=A2(I,K)-AU(I,K)*A2(I,K+1)<a name='2408'>
        ENDDO<a name='2409'>
      ENDDO<a name='2410'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2411'></font>
      RETURN<a name='2412'>
      END SUBROUTINE TRIDI2T3<a name='2413'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2414'></font>
<a name='2415'>
<A NAME='MSTADBT3'><A href='../../html_code/phys/module_cu_osas.F.html#MSTADBT3' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2416'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>MSTADBT3</font>(IM,KM,K1,K2,PRSL,PRSLK,TENV,QENV,             &amp; <A href='../../call_to/MSTADBT3.html' TARGET='index'>2</A>,<A href='../../call_from/MSTADBT3.html' TARGET='index'>12</A><a name='2417'>
     &amp;                  KLCL,KBOT,KTOP,TCLD,QCLD)<a name='2418'>
<font color=#447700>!yt      INCLUDE DBMSTADB;<a name='2419'></font>
<font color=#447700>!!<a name='2420'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_15">, ONLY : kind_phys<a name='2421'>
      USE <A href='../../html_code/phys/module_gfs_funcphys.F.html#MODULE_GFS_FUNCPHYS'>MODULE_GFS_FUNCPHYS</A><A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_FUNCPHYS_3">, ONLY : FTDP, FTHE, FTLCL, STMA<a name='2422'>
      USE <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_PHYSCONS</A><A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_8">, EPS =&gt; con_eps, EPSM1 =&gt; con_epsm1, FV =&gt; con_FVirt<a name='2423'>
<a name='2424'>
      implicit none<a name='2425'>
<font color=#447700>!!<a name='2426'></font>
<font color=#447700>!     include 'constant.h'<a name='2427'></font>
<font color=#447700>!!<a name='2428'></font>
      integer              k,k1,k2,km,i,im<a name='2429'>
      real(kind=kind_phys) pv,qma,slklcl,tdpd,thelcl,tlcl<a name='2430'>
      real(kind=kind_phys) tma,tvcld,tvenv<a name='2431'>
<font color=#447700>!!<a name='2432'></font>
      real(kind=kind_phys) PRSL(IM,KM), PRSLK(IM,KM), TENV(IM,KM),      &amp;<a name='2433'>
     &amp;                     QENV(IM,KM), TCLD(IM,KM),  QCLD(IM,KM)<a name='2434'>
      INTEGER              KLCL(IM),    KBOT(IM),      KTOP(IM)<a name='2435'>
<font color=#447700>!  LOCAL ARRAYS<a name='2436'></font>
      real(kind=kind_phys) SLKMA(IM), THEMA(IM)<a name='2437'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2438'></font>
<font color=#447700>!  DETERMINE WARMEST POTENTIAL WET-BULB TEMPERATURE BETWEEN K1 AND K2.<a name='2439'></font>
<font color=#447700>!  COMPUTE ITS LIFTING CONDENSATION LEVEL.<a name='2440'></font>
<font color=#447700>!<a name='2441'></font>
      DO I=1,IM<a name='2442'>
        SLKMA(I) = 0.<a name='2443'>
        THEMA(I) = 0.<a name='2444'>
      ENDDO<a name='2445'>
      DO K=K1,K2<a name='2446'>
        DO I=1,IM<a name='2447'>
          PV   = 1000.0 * PRSL(I,K)*QENV(I,K)/(EPS-EPSM1*QENV(I,K))<a name='2448'>
          TDPD = TENV(I,K)-FTDP(PV)<a name='2449'>
          IF(TDPD.GT.0.) THEN<a name='2450'>
            TLCL   = <A href='../../html_code/phys/module_shcu_grims.F.html#FTLCL'>FTLCL</A><A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FTLCL_1">(TENV(I,K),TDPD)<a name='2451'>
            SLKLCL = PRSLK(I,K)*TLCL/TENV(I,K)<a name='2452'>
          ELSE<a name='2453'>
            TLCL   = TENV(I,K)<a name='2454'>
            SLKLCL = PRSLK(I,K)<a name='2455'>
          ENDIF<a name='2456'>
          THELCL=<A href='../../html_code/phys/module_shcu_grims.F.html#FTHE'>FTHE</A><A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FTHE_1">(TLCL,SLKLCL)<a name='2457'>
          IF(THELCL.GT.THEMA(I)) THEN<a name='2458'>
            SLKMA(I) = SLKLCL<a name='2459'>
            THEMA(I) = THELCL<a name='2460'>
          ENDIF<a name='2461'>
        ENDDO<a name='2462'>
      ENDDO<a name='2463'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2464'></font>
<font color=#447700>!  SET CLOUD TEMPERATURES AND HUMIDITIES WHEREVER THE PARCEL LIFTED UP<a name='2465'></font>
<font color=#447700>!  THE MOIST ADIABAT IS BUOYANT WITH RESPECT TO THE ENVIRONMENT.<a name='2466'></font>
      DO I=1,IM<a name='2467'>
        KLCL(I)=KM+1<a name='2468'>
        KBOT(I)=KM+1<a name='2469'>
        KTOP(I)=0<a name='2470'>
      ENDDO<a name='2471'>
      DO K=1,KM<a name='2472'>
        DO I=1,IM<a name='2473'>
          TCLD(I,K)=0.<a name='2474'>
          QCLD(I,K)=0.<a name='2475'>
        ENDDO<a name='2476'>
      ENDDO<a name='2477'>
      DO K=K1,KM<a name='2478'>
        DO I=1,IM<a name='2479'>
          IF(PRSLK(I,K).LE.SLKMA(I)) THEN<a name='2480'>
            KLCL(I)=MIN(KLCL(I),K)<a name='2481'>
            CALL <A href='../../html_code/phys/module_gfs_funcphys.F.html#STMA'>STMA</A><A href='../../html_code/phys/module_cu_sas.F.html#MSTADBT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STMA_1">(THEMA(I),PRSLK(I,K),TMA,QMA)<a name='2482'>
<font color=#447700>!           TMA=FTMA(THEMA(I),PRSLK(I,K),QMA)<a name='2483'></font>
            TVCLD=TMA*(1.+FV*QMA)<a name='2484'>
            TVENV=TENV(I,K)*(1.+FV*QENV(I,K))<a name='2485'>
            IF(TVCLD.GT.TVENV) THEN<a name='2486'>
              KBOT(I)=MIN(KBOT(I),K)<a name='2487'>
              KTOP(I)=MAX(KTOP(I),K)<a name='2488'>
              TCLD(I,K)=TMA-TENV(I,K)<a name='2489'>
              QCLD(I,K)=QMA-QENV(I,K)<a name='2490'>
            ENDIF<a name='2491'>
          ENDIF<a name='2492'>
        ENDDO<a name='2493'>
      ENDDO<a name='2494'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2495'></font>
      RETURN<a name='2496'>
      END SUBROUTINE MSTADBT3<a name='2497'>
<a name='2498'>
#if (EM_CORE == 1)<a name='2499'>
<font color=#447700>!   random seeds - ZCX    <a name='2500'></font>
<A NAME='INIT_RANDOM_SEED'><A href='../../html_code/phys/module_cu_osas.F.html#INIT_RANDOM_SEED' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2501'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_random_seed</font>() <A href='../../call_to/INIT_RANDOM_SEED.html' TARGET='index'>1</A>,<A href='../../call_from/INIT_RANDOM_SEED.html' TARGET='index'>1</A><a name='2502'>
            INTEGER :: i, n, clock<a name='2503'>
            INTEGER, DIMENSION(:), ALLOCATABLE :: seed<a name='2504'>
<a name='2505'>
            CALL RANDOM_SEED(size = n)<a name='2506'>
            ALLOCATE(seed(n))<a name='2507'>
<a name='2508'>
            CALL SYSTEM_CLOCK(COUNT=clock)<a name='2509'>
<a name='2510'>
            seed = clock + 37 * (/ (i - 1, i = 1, n) /)<a name='2511'>
            CALL RANDOM_SEED(PUT = seed)<a name='2512'>
<a name='2513'>
            DEALLOCATE(seed)<a name='2514'>
      END SUBROUTINE <a name='2515'>
#endif<a name='2516'>
      END MODULE module_cu_osas<a name='2517'>
</pre></body></html>