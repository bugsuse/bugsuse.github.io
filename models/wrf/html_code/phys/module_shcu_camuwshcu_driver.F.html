<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_SHCU_CAMUWSHCU_DRIVER'><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#MODULE_SHCU_CAMUWSHCU_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_shcu_camuwshcu_driver</font> <A href='../../call_to/MODULE_SHCU_CAMUWSHCU_DRIVER.html' TARGET='index'>1</A><a name='3'>
  USE <A href='../../html_code/phys/module_cam_shr_kind_mod.F.html#SHR_KIND_MOD'>shr_kind_mod</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#module_shcu_camuwshcu_driver.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHR_KIND_MOD_118">,    only: r8 =&gt; shr_kind_r8<a name='4'>
<a name='5'>
<font color=#447700>! Roughly based on convect_shallow_tend in convect_shallow.F90 from CAM<a name='6'></font>
<font color=#447700>! but tailored for the UW shallow cumulus scheme.<a name='7'></font>
<a name='8'>
  <font color=#447700>!-------------------------------------------<a name='9'></font>
  <font color=#447700>!Future modifications and important warnings (BSINGH:02/01/2013- Notes from WIG):<a name='10'></font>
  <font color=#447700>!===========================================<a name='11'></font>
  <font color=#447700>!1. UWShCu is hard-wired for certain moisture variables that could cause trouble <a name='12'></font>
  <font color=#447700>!   depending on which MP is used <a name='13'></font>
  <font color=#447700>!2. Mixing for rain, snow, and graupel moist vars is commented out. <a name='14'></font>
  <font color=#447700>!   For other MP routines that treat this prognostically, we need to implement <a name='15'></font>
  <font color=#447700>!   ShCu mixing of these (and other possible) moist species.<a name='16'></font>
  <font color=#447700>!3. Fractional occurrence of shallow convection is currently not calculated.<a name='17'></font>
  <font color=#447700>!-------------------------------------------<a name='18'></font>
<a name='19'>
<a name='20'>
<a name='21'>
<a name='22'>
  IMPLICIT NONE<a name='23'>
<a name='24'>
  PRIVATE                  <font color=#447700>!Default to private<a name='25'></font>
  PUBLIC :: &amp;              <font color=#447700>!Public entities<a name='26'></font>
       camuwshcu_driver<a name='27'>
<a name='28'>
CONTAINS<a name='29'>
<a name='30'>
<font color=#447700>!------------------------------------------------------------------------<a name='31'></font>
<A NAME='CAMUWSHCU_DRIVER'><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='32'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>camuwshcu_driver</font>(                                  &amp; <A href='../../call_to/CAMUWSHCU_DRIVER.html' TARGET='index'>1</A>,<A href='../../call_from/CAMUWSHCU_DRIVER.html' TARGET='index'>19</A><a name='33'>
              ids,ide, jds,jde, kds,kde                       &amp;<a name='34'>
             ,ims,ime, jms,jme, kms,kme                       &amp;<a name='35'>
             ,its,ite, jts,jte, kts,kte                       &amp;<a name='36'>
             ,num_moist, dt                                   &amp;<a name='37'>
             ,p, p8w, pi_phy, z, z_at_w, dz8w                 &amp;<a name='38'>
             ,t_phy, u_phy, v_phy                             &amp;<a name='39'>
             ,moist, qv, qc, qi, qnc, qni                     &amp;<a name='40'>
#if ( WRF_CHEM == 1 )<a name='41'>
             ,chem, chem_opt                                  &amp;<a name='42'>
#endif<a name='43'>
             ,pblh_in, tke_pbl, cldfra, cldfra_old            &amp;<a name='44'>
             ,cldfra_old_mp,cldfra_conv, is_CAMMGMP_used      &amp;<a name='45'>
             ,cldfrash                                        &amp;<a name='46'>
             ,cush_inout, pratesh, snowsh, icwmrsh    &amp;<a name='47'>
             ,cmfmc, cmfmc2_inout, rprdsh_inout, cbmf_inout   &amp;<a name='48'>
             ,cmfsl, cmflq, dlf, dlf2, evapcsh_inout          &amp;<a name='49'>
             ,rliq, rliq2_inout, cubot, cutop                 &amp;<a name='50'>
             ,rushten, rvshten, rthshten                      &amp;<a name='51'>
             ,rqvshten, rqcshten, rqrshten                    &amp;<a name='52'>
             ,rqishten, rqsshten, rqgshten                    &amp;<a name='53'>
             ,rqcnshten,rqinshten                             &amp;<a name='54'>
             ,ht, shfrc3d,itimestep                           &amp;<a name='55'>
                                                              )<a name='56'>
<font color=#447700>! This routine is based on convect_shallow_tend in CAM. It handles the<a name='57'></font>
<font color=#447700>! mapping of variables from the WRF to the CAM framework for the UW<a name='58'></font>
<font color=#447700>! shallow convective parameterization.<a name='59'></font>
<font color=#447700>!<a name='60'></font>
<font color=#447700>! Author: William.Gustafson@pnl.gov, Jan. 2010<a name='61'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='62'></font>
  USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_161">, only: param_first_scalar, &amp;<a name='63'>
                                      p_qc, p_qr, p_qi, p_qs, p_qg, p_qnc, p_qni<a name='64'>
  USE <A href='../../html_code/phys/module_cam_support.F.html#MODULE_CAM_SUPPORT'>module_cam_support</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CAM_SUPPORT_77">,       only: pcols, pver, pcnst =&gt;pcnst_runtime<a name='65'>
#if ( WRF_CHEM == 1 )<a name='66'>
  USE <A href='../../html_code/phys/module_cam_support.F.html#MODULE_CAM_SUPPORT'>module_cam_support</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CAM_SUPPORT_78">,       only:  cam_mam_aerosols<a name='67'>
#endif<a name='68'>
  USE <A href='../../html_code/phys/module_cam_constituents.F.html#CONSTITUENTS'>constituents</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTITUENTS_23">,             only: cnst_get_ind<a name='69'>
  USE <A href='../../html_code/phys/module_cam_physconst.F.html#PHYSCONST'>physconst</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSCONST_25">,                only: latice,cpair, gravit, latvap<a name='70'>
  USE <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#UWSHCU'>uwshcu</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UWSHCU_2">,                   only: compute_uwshcu_inv<a name='71'>
  USE <A href='../../html_code/phys/module_cam_wv_saturation.F.html#WV_SATURATION'>wv_saturation</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WV_SATURATION_19">,            only: fqsatd<a name='72'>
#if ( WRF_CHEM == 1 )<a name='73'>
  use <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_162">,  only: num_chem, param_first_scalar,CBMZ_CAM_MAM3_NOAQ, &amp;<a name='74'>
       CBMZ_CAM_MAM3_AQ,CBMZ_CAM_MAM7_NOAQ,CBMZ_CAM_MAM7_AQ<a name='75'>
  use <A href='../../html_code/phys/module_data_cam_mam_asect.F.html#MODULE_DATA_CAM_MAM_ASECT'>module_data_cam_mam_asect</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATA_CAM_MAM_ASECT_3">, only: lptr_chem_to_q, factconv_chem_to_q<a name='76'>
  use <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MODULE_MP_CAMMGMP_DRIVER'>module_mp_cammgmp_driver</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MP_CAMMGMP_DRIVER_4">,  only: physics_update, physics_ptend_init<a name='77'>
#endif<a name='78'>
<a name='79'>
<font color=#447700>! Subroutine arguments...<a name='80'></font>
  LOGICAL, INTENT(IN) :: is_CAMMGMP_used<a name='81'>
  INTEGER, INTENT(IN   ) ::    ids,ide, jds,jde, kds,kde,  &amp;<a name='82'>
                               ims,ime, jms,jme, kms,kme,  &amp;<a name='83'>
                               its,ite, jts,jte, kts,kte,  &amp;<a name='84'>
                               num_moist,itimestep<a name='85'>
#if ( WRF_CHEM == 1 )<a name='86'>
  INTEGER, INTENT(IN   ) ::    chem_opt<a name='87'>
#endif<a name='88'>
<a name='89'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme, num_moist ), INTENT(IN) :: &amp;<a name='90'>
                              moist    <font color=#447700>!moist tracer array<a name='91'></font>
#if ( WRF_CHEM == 1 )<a name='92'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme, num_chem ), INTENT(INOUT) :: &amp;<a name='93'>
                              chem    <font color=#447700>!moist tracer array<a name='94'></font>
#endif<a name='95'>
<a name='96'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN) :: &amp;<a name='97'>
                             cldfra, &amp; <font color=#447700>!cloud fraction<a name='98'></font>
                         cldfra_old, &amp; <font color=#447700>!previous time step cloud fraction<a name='99'></font>
                      cldfra_old_mp, &amp;<a name='100'>
                        cldfra_conv, &amp;<a name='101'>
                               dz8w, &amp; <font color=#447700>!height between layer interface (m)<a name='102'></font>
                                  p, &amp; <font color=#447700>!pressure at mid-level (Pa)<a name='103'></font>
                                p8w, &amp; <font color=#447700>!pressure at level interface (Pa)<a name='104'></font>
                             pi_phy, &amp; <font color=#447700>!exner function, (p0/p)^(R/cpair) (none)<a name='105'></font>
                                 qv, &amp; <font color=#447700>!water vapor mixing ratio (kg/kg-dry air)<a name='106'></font>
                              t_phy, &amp; <font color=#447700>!temperature (K)<a name='107'></font>
                            tke_pbl, &amp; <font color=#447700>!turbulent kinetic energy from PBL (m2/s2)<a name='108'></font>
                              u_phy, &amp; <font color=#447700>!zonal wind component on T points (m/s)<a name='109'></font>
                              v_phy, &amp; <font color=#447700>!meridional wind component on T points (m/s)<a name='110'></font>
                                  z, &amp; <font color=#447700>!height above sea level at mid-level (m)<a name='111'></font>
                             z_at_w    <font color=#447700>!height above sea level at interface (m)<a name='112'></font>
<a name='113'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN), OPTIONAL :: &amp;<a name='114'>
                                 qc, &amp; <font color=#447700>!cloud droplet mixing ratio (kg/kg-dry air)<a name='115'></font>
                                 qi, &amp; <font color=#447700>!cloud ice crystal mixing ratio (kg/kg-dry air)<a name='116'></font>
                                qnc, &amp; <font color=#447700>!cloud water  number concentration (#/kg)<a name='117'></font>
                                qni    <font color=#447700>!cloud ice number concentration (#/kg)<a name='118'></font>
<a name='119'>
  REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: &amp;<a name='120'>
                            pblh_in, &amp; <font color=#447700>!height of PBL (m)<a name='121'></font>
                            ht         <font color=#447700>!Terrain height (m)<a name='122'></font>
<a name='123'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) :: &amp;<a name='124'>
                           cldfrash, &amp; <font color=#447700>!shallow convective cloud fraction<a name='125'></font>
                              cmfmc, &amp; <font color=#447700>!deep+shalow cloud fraction (already contains deep part from ZM)<a name='126'></font>
                       cmfmc2_inout, &amp; <font color=#447700>!shallow cloud fraction<a name='127'></font>
                              cmflq, &amp; <font color=#447700>!convective flux of total water in energy unit (~units)<a name='128'></font>
                              cmfsl, &amp; <font color=#447700>!convective flux of liquid water static energy (~units)<a name='129'></font>
                                dlf, &amp; <font color=#447700>!dq/dt due to export of cloud water (input=deep from ZM, output=deep+shallow)<a name='130'></font>
                      evapcsh_inout, &amp; <font color=#447700>!output array for evaporation of shallow convection precipitation (kg/kg/s)<a name='131'></font>
                            icwmrsh, &amp; <font color=#447700>!shallow cumulus in-cloud water mixing ratio (kg/m2)<a name='132'></font>
                       rprdsh_inout, &amp; <font color=#447700>!dq/dt due to deep(~?) &amp; shallow convective rainout (~units?)<a name='133'></font>
                            rushten, &amp; <font color=#447700>!UNcoupled zonal wind tend from shallow Cu scheme (m/s2)<a name='134'></font>
                            rvshten, &amp; <font color=#447700>!UNcoupled meridional wind tend from shallow Cu scheme (m/s2)<a name='135'></font>
                           rthshten, &amp; <font color=#447700>!UNcoupled potential temperature tendendcy from shallow cu scheme (K/s)<a name='136'></font>
                           rqvshten, &amp; <font color=#447700>!UNcoupled water vapor mixing ratio tend from shallow Cu scheme (kg/kg/s)<a name='137'></font>
                           rqcshten, &amp; <font color=#447700>!UNcoupled clod droplet mixing ratio tend from shallow Cu scheme (kg/kg/s)<a name='138'></font>
                           rqrshten, &amp; <font color=#447700>!UNcoupled raindrop mixing ratio tend from shallow Cu scheme (kg/kg/s)<a name='139'></font>
                           rqishten, &amp; <font color=#447700>!UNcoupled ice crystal mixing ratio tend from shallow Cu scheme (kg/kg/s)<a name='140'></font>
                           rqsshten, &amp; <font color=#447700>!UNcoupled snow mixing ratio tend from shallow Cu scheme (kg/kg/s)<a name='141'></font>
                           rqgshten, &amp; <font color=#447700>!UNcoupled graupel mixing ratio tend from shallow Cu scheme (kg/kg/s)<a name='142'></font>
                          rqcnshten, &amp; <font color=#447700>!PMA<a name='143'></font>
                          rqinshten<a name='144'>
<a name='145'>
<a name='146'>
  REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: &amp;<a name='147'>
                         cbmf_inout, &amp; <font color=#447700>!cloud base mass flux (kg/m2/s)<a name='148'></font>
                              cubot, &amp; <font color=#447700>!level number of base of convection<a name='149'></font>
                              cutop, &amp; <font color=#447700>!level number of top of convection<a name='150'></font>
                         cush_inout, &amp; <font color=#447700>!convective scale height (~units?)<a name='151'></font>
                            pratesh, &amp; <font color=#447700>!time-step shallow cumulus precip rate at surface (mm/s)<a name='152'></font>
                               rliq, &amp; <font color=#447700>!vertically-integrated reserved cloud condensate (m/s)<a name='153'></font>
                        rliq2_inout, &amp; <font color=#447700>!vertically-integrated reserved cloud condensate for shallow (m/s)<a name='154'></font>
                             snowsh    <font color=#447700>!accumulated convective snow rate at surface for shallow Cu (m/s) ~are these the units we should use for WRF?<a name='155'></font>
<a name='156'>
  REAL, INTENT(IN) :: &amp;<a name='157'>
                                 dt    <font color=#447700>!time step (s)<a name='158'></font>
<a name='159'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(OUT) ::   &amp;<a name='160'>
                        dlf2           <font color=#447700>! Required by CAMMGMP Microphysics                            <a name='161'></font>
 REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(OUT) ::   &amp;<a name='162'>
                           shfrc3d     <font color=#447700>!Shallow cloud fraction<a name='163'></font>
<a name='164'>
<font color=#447700>! Local variables...<a name='165'></font>
  <font color=#447700>!Variables dimensioned for input to CAM routines<a name='166'></font>
  REAL(r8), DIMENSION(pcols, kte, pcnst) ::  &amp;<a name='167'>
                             moist8, &amp; <font color=#447700>!tracer array for CAM routines<a name='168'></font>
                         tnd_tracer    <font color=#447700>!tracer tendency<a name='169'></font>
<a name='170'>
  REAL(r8), DIMENSION(pcols, kte+1) ::  &amp;<a name='171'>
                              pint8, &amp; <font color=#447700>!pressure at layer interface (Pa)<a name='172'></font>
                                zi8, &amp; <font color=#447700>!height above the ground at interfaces (m)<a name='173'></font>
                               tke8, &amp; <font color=#447700>!turbulent kinetic energy at level interfaces (m2/s2)<a name='174'></font>
                              slflx, &amp; <font color=#447700>!convective liquid water static energy flux (~units?)<a name='175'></font>
                              qtflx, &amp; <font color=#447700>!convective total water flux (~units?)<a name='176'></font>
                            flxprec, &amp; <font color=#447700>! Shallow convective-scale flux of precip (rain+snow) at interfaces [ kg/m2/s ]<a name='177'></font>
                            flxsnow, &amp; <font color=#447700>! Shallow convective-scale flux of snow at interfaces [ kg/m2/s ]<a name='178'></font>
                            cmfmc2     <font color=#447700>!cloud fraction<a name='179'></font>
<a name='180'>
                                                            <a name='181'>
<a name='182'>
<a name='183'>
  REAL(r8), DIMENSION(pcols, kte) ::  &amp;<a name='184'>
                               cld8, &amp; <font color=#447700>!cloud fraction<a name='185'></font>
                            cldold8, &amp; <font color=#447700>!previous time step cloud fraction ~should this be just the convective part?<a name='186'></font>
                             cmfdqs, &amp; <font color=#447700>!convective snow production (~units?)<a name='187'></font>
                            evapcsh, &amp; <font color=#447700>!evaporation of shallow convection precipitation &gt;= 0. (kg/kg/s)<a name='188'></font>
                           iccmr_uw, &amp; <font color=#447700>!in-cloud cumulus LWC+IWC (kg/m2)<a name='189'></font>
                           icwmr_uw, &amp; <font color=#447700>!in-cloud cumulus LWC (kg/m2)<a name='190'></font>
                           icimr_uw, &amp; <font color=#447700>!in-cloud cumulus IWC (kg/m2)<a name='191'></font>
                              pdel8, &amp; <font color=#447700>!pressure difference between layer interfaces (Pa)<a name='192'></font>
                           pdeldry8, &amp; <font color=#447700>!pressure difference between layer interfaces for dry atm (Pa)<a name='193'></font>
                              pmid8, &amp; <font color=#447700>!pressure at layer middle (Pa)<a name='194'></font>
                                qc2, &amp; <font color=#447700>!dq/dt due to export of cloud water<a name='195'></font>
                                qh8, &amp; <font color=#447700>!specific humidity (kg/kg-moist air)<a name='196'></font>
                                qc8, &amp; <font color=#447700>!cloud liquid water (~units?)<a name='197'></font>
                                qi8, &amp; <font color=#447700>!cloud ice (~units?)<a name='198'></font>
                              qhtnd, &amp; <font color=#447700>!specific humidity tendency (kg/kg/s)<a name='199'></font>
                              qctnd, &amp; <font color=#447700>!cloud water mixing ratio tendency<a name='200'></font>
                              qitnd, &amp; <font color=#447700>!cloud ice mixing ratio tendency<a name='201'></font>
                             rprdsh, &amp; <font color=#447700>!dq/dt due to deep(~?) &amp; shallow convective rainout (~units?)<a name='202'></font>
                                 s8, &amp; <font color=#447700>!dry static energy (J/kg)<a name='203'></font>
                              shfrc, &amp; <font color=#447700>!shallow cloud fraction<a name='204'></font>
                               stnd, &amp; <font color=#447700>!heating rate (dry static energy tendency, W/kg)<a name='205'></font>
                                 t8, &amp; <font color=#447700>!temperature (K)<a name='206'></font>
                                 u8, &amp; <font color=#447700>!environment zonal wind (m/s)<a name='207'></font>
                               utnd, &amp; <font color=#447700>!zonal wind tendency (m/s2)<a name='208'></font>
                                 v8, &amp; <font color=#447700>!environment meridional wind (m/s)<a name='209'></font>
                               vtnd, &amp; <font color=#447700>!meridional wind tendency (m/s2)<a name='210'></font>
                                zm8    <font color=#447700>!height between interfaces (m)<a name='211'></font>
<a name='212'>
  REAL(r8), DIMENSION(pcols, kte) ::  &amp;<a name='213'>
                           qcten_det, &amp;<a name='214'>
                           qiten_det, &amp;<a name='215'>
                          qcnten_det, &amp;<a name='216'>
                          qinten_det, &amp;<a name='217'>
                           qsten_det<a name='218'>
<a name='219'>
  REAL(r8), DIMENSION(pcols) ::  &amp;<a name='220'>
                               cbmf, &amp; <font color=#447700>!cloud base mass flux (kg/m2/s)<a name='221'></font>
                               cnb2, &amp; <font color=#447700>!bottom level of convective activity<a name='222'></font>
                               cnt2, &amp; <font color=#447700>!top level of convective activity<a name='223'></font>
                               cush, &amp; <font color=#447700>!convective scale height (~units?)<a name='224'></font>
                               pblh, &amp; <font color=#447700>!pblh height (m)<a name='225'></font>
                              precc, &amp; <font color=#447700>!convective precip (rain+snow) at surface for shallow Cu (m/s)<a name='226'></font>
                              rliq2, &amp; <font color=#447700>!vertically-integrated reserved cloud condensate for shallow (m/s)<a name='227'></font>
                               snow    <font color=#447700>!convective snow rate at surface (m/s)<a name='228'></font>
<a name='229'>
  <font color=#447700>!Other local vars<a name='230'></font>
  REAL(r8) :: ztodt,dum1<a name='231'>
  INTEGER :: i, j, k, kflip, m, mp1<a name='232'>
  INTEGER :: cnb, cnt      <font color=#447700>!index of cloud base and top in CAM world (indices decrease with height)<a name='233'></font>
  INTEGER :: lchnk         <font color=#447700>!chunk identifier, used to map 2-D to 1-D arrays in WRF<a name='234'></font>
  INTEGER :: ncnst         <font color=#447700>!number of tracers<a name='235'></font>
  INTEGER :: ncol          <font color=#447700>!number of atmospheric columns in chunk<a name='236'></font>
  CHARACTER(LEN=1000) :: msg<a name='237'>
<a name='238'>
  character*24 :: ptend_name            <font color=#447700>!ptend%name in CAM5 - used in parameterization<a name='239'></font>
  logical      :: ptend_ls              <font color=#447700>!ptend%ls   in CAM5 - used for calling physics_update subroutine<a name='240'></font>
  logical      :: ptend_lq(pcnst)       <font color=#447700>!ptend%lq   in CAM5<a name='241'></font>
<a name='242'>
  integer :: l, l2<a name='243'>
  real(r8) :: state_s(pcols,kte)<a name='244'>
  real(r8) :: ptend_s(pcols,kte)                   <font color=#447700>!Dummy arguments for physics_update call<a name='245'></font>
<a name='246'>
#if ( WRF_CHEM == 1 )<a name='247'>
  <font color=#447700>!BSINGH:02/01/2013: Sanity check for Non-MAM simulations<a name='248'></font>
  if(.NOT.cam_mam_aerosols .AND. chem_opt .NE. 0) then<a name='249'>
     write(msg,*)'CAMUWSHACU DRIVER - camuwshcu_driver is valid for only MAM aerosols ', &amp;<a name='250'>
          '(chem_opts:',CBMZ_CAM_MAM3_NOAQ,CBMZ_CAM_MAM3_AQ,CBMZ_CAM_MAM7_NOAQ,CBMZ_CAM_MAM7_AQ ,')'<a name='251'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1276">( msg )<a name='252'>
  endif<a name='253'>
#endif<a name='254'>
<a name='255'>
<a name='256'>
<font color=#447700>!<a name='257'></font>
<font color=#447700>! Initialize...<a name='258'></font>
<font color=#447700>!<a name='259'></font>
  ncol  = 1     <font color=#447700>!chunk size in WRF is 1 since we loop over all columns in a tile<a name='260'></font>
  ncnst = pcnst <font color=#447700>!Balwinder.Singh@pnnl.gov<a name='261'></font>
  ztodt = dt<a name='262'>
<font color=#447700>!<a name='263'></font>
<font color=#447700>! Map variables to inputs for zm_convr and call it...<a name='264'></font>
<font color=#447700>! Loop over the points in the tile and treat them each as a CAM chunk.<a name='265'></font>
<font color=#447700>!<a name='266'></font>
  ij_loops : do j = jts,jte<a name='267'>
     do i = its,ite<a name='268'>
        lchnk = (j-jts)*(ite-its+1) + (i-its+1) <font color=#447700>!1-D index location from the 2-D tile<a name='269'></font>
<a name='270'>
        <font color=#447700>!Flip variables on the layer interfaces<a name='271'></font>
        do k = kts,kte+1<a name='272'>
           kflip = kte-k+2<a name='273'>
<a name='274'>
           pint8(1,kflip) = p8w(i,k,j)<a name='275'>
           zi8(1,kflip)   = z_at_w(i,k,j) - ht(i,j) <font color=#447700>! height above the ground at interfaces<a name='276'></font>
        end do<a name='277'>
<a name='278'>
        <font color=#447700>!Flip variables on the layer middles<a name='279'></font>
        do k = kts,kte<a name='280'>
           kflip = kte-k+1<a name='281'>
           if(is_CAMMGMP_used) then<a name='282'>
              cld8(1,kflip)    = cldfra_old_mp(i,k,j)<a name='283'>
              cldold8(1,kflip) = cldfra_conv(i,k,j)<a name='284'>
           else<a name='285'>
              cld8(1,kflip)    = cldfra(i,k,j)<a name='286'>
              cldold8(1,kflip) = cldfra_old(i,k,j)<a name='287'>
           endif<a name='288'>
           if (itimestep .eq. 1) then<a name='289'>
             cld8(1,kflip)    = 0._r8<a name='290'>
             cldold8(1,kflip) = 0._r8<a name='291'>
           end if<a name='292'>
           cld8(1,kflip) = min(max((cld8(1,kflip) + cldold8(1,kflip)),0._r8),1._r8)<a name='293'>
<a name='294'>
           pdel8(1,kflip)   = p8w(i,k,j) - p8w(i,k+1,j)<a name='295'>
           pmid8(1,kflip)   = p(i,k,j)<a name='296'>
           qh8(1,kflip)     = max( qv(i,k,j)/(1. + qv(i,k,j)), 1e-30 ) <font color=#447700>!values of 0 cause a crash in entropy<a name='297'></font>
           if( present(qc) ) then<a name='298'>
              qc8(1,kflip)  = qc(i,k,j)/(1. + qv(i,k,j)) <font color=#447700>!Convert to moist mix ratio<a name='299'></font>
           else<a name='300'>
              qc8(1,kflip)  = 0.<a name='301'>
           end if<a name='302'>
           if( present(qi) ) then<a name='303'>
              qi8(1,kflip)  = qi(i,k,j)/(1. + qv(i,k,j)) <font color=#447700>!Used in convtran, ditto for conversion<a name='304'></font>
           else<a name='305'>
              qi8(1,kflip)  = 0.<a name='306'>
           end if<a name='307'>
           pdeldry8(1,kflip)= pdel8(1,kflip)*(1._r8 - qh8(1,kflip))<a name='308'>
           t8(1,kflip)      = t_phy(i,k,j)<a name='309'>
           s8(1,kflip)      = cpair*t8(1,kflip) + gravit*(z(i,k,j)-ht(i,j))<a name='310'>
           u8(1,kflip)      = u_phy(i,k,j)<a name='311'>
           v8(1,kflip)      = v_phy(i,k,j)<a name='312'>
           zm8(1,kflip)     = z(i,k,j)-ht(i,j)<a name='313'>
        end do<a name='314'>
<a name='315'>
        <font color=#447700>!BSINGH - TKE at the interfaces<a name='316'></font>
        do k = kts, kte+1<a name='317'>
           kflip = kte - k + 2<a name='318'>
           <a name='319'>
           tke8(1,kflip) = tke_pbl(i,k,j)  <font color=#447700>!Turbulent kinetic energy            <a name='320'></font>
        end do<a name='321'>
<a name='322'>
        <font color=#447700>!Flip the tracer array -<a name='323'></font>
        <font color=#447700>!shift tracer dimension down one to remove "blank" index and<a name='324'></font>
        <font color=#447700>!convert to wet instead of dry mixing ratios.<a name='325'></font>
        do k = kts,kte<a name='326'>
           kflip = kte-k+1<a name='327'>
<a name='328'>
           moist8(1,kflip,1:ncnst) = 0.<a name='329'>
<a name='330'>
           moist8(1,kflip,1) = max(0.0,qv(i,k,j)/(1. + qv(i,k,j)))<a name='331'>
<a name='332'>
           call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_17">( 'CLDLIQ', m )<a name='333'>
           moist8(1,kflip,m) = max(0.0,qc(i,k,j)/(1. + qv(i,k,j)))<a name='334'>
<a name='335'>
           call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_18">( 'CLDICE', m )<a name='336'>
           moist8(1,kflip,m) = max(0.0,qi(i,k,j)/(1. + qv(i,k,j)))<a name='337'>
<a name='338'>
           call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_19">( 'NUMLIQ', m )<a name='339'>
           moist8(1,kflip,m) = max(0.0,qnc(i,k,j)/(1. + qv(i,k,j)))<a name='340'>
<a name='341'>
           call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_20">( 'NUMICE', m )<a name='342'>
           moist8(1,kflip,m) = max(0.0,qni(i,k,j)/(1. + qv(i,k,j)))<a name='343'>
<a name='344'>
#if ( WRF_CHEM == 1 )<a name='345'>
           <font color=#447700>!Following Do-Loop is obtained from chem/module_cam_mam_aerchem_driver.F <a name='346'></font>
           do l = param_first_scalar, num_chem<a name='347'>
              l2 = lptr_chem_to_q(l)<a name='348'>
              if ((l2 &gt;= 1) .and. (l2 &lt;= pcnst)) then<a name='349'>
                 moist8(1,kflip,l2) = max(0.0,chem(i,k,j,l)*factconv_chem_to_q(l))<a name='350'>
              end if<a name='351'>
           end do <font color=#447700>! l             <a name='352'></font>
#endif           <a name='353'>
<a name='354'>
        end do<a name='355'>
<a name='356'>
        <font color=#447700>!Some remapping to get arrays to pass into the routine<a name='357'></font>
        pblh(1) = pblh_in(i,j)<a name='358'>
        cush(1) = cush_inout(i,j)<a name='359'>
<font color=#447700>!<a name='360'></font>
<font color=#447700>! Main guts of the routine...<a name='361'></font>
<font color=#447700>! This is a bit inefficient because we are flippling the arrays and they<a name='362'></font>
<font color=#447700>! will then get flipped back again by compute_uwshcu_inv. We are doing<a name='363'></font>
<font color=#447700>! this to preserve the CAM code as much as possible for maintenance.<a name='364'></font>
<font color=#447700>!<a name='365'></font>
        call <A href='../../html_code/phys/module_shcu_camuwshcu.F.html#COMPUTE_UWSHCU_INV'>compute_uwshcu_inv</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_UWSHCU_INV_1">(                        &amp;<a name='366'>
             pcols, pver, ncol, ncnst, ztodt,           &amp;<a name='367'>
             pint8, zi8, pmid8, zm8, pdel8,             &amp;<a name='368'>
             u8, v8, qh8, qc8, qi8,                     &amp;<a name='369'>
             t8, s8, moist8,                            &amp;<a name='370'>
             tke8, cld8, cldold8, pblh, cush,           &amp;<a name='371'>
             cmfmc2, slflx, qtflx,                      &amp;<a name='372'>
             flxprec, flxsnow,                          &amp;<a name='373'>
             qhtnd, qctnd, qitnd,                       &amp;<a name='374'>
             stnd, utnd, vtnd, tnd_tracer,              &amp;<a name='375'>
             rprdsh, cmfdqs, precc, snow,               &amp;<a name='376'>
             evapcsh, shfrc, iccmr_UW, icwmr_UW,        &amp;<a name='377'>
             icimr_UW, cbmf, qc2, rliq2,                &amp;<a name='378'>
             cnt2, cnb2, fqsatd, lchnk, pdeldry8        )<a name='379'>
<font color=#447700>!<a name='380'></font>
<font color=#447700>! Map output into WRF-dimensioned arrays...<a name='381'></font>
<font color=#447700>!<a name='382'></font>
        cush_inout(i,j) = cush(1)<a name='383'>
<font color=#447700>!PMA&gt;<a name='384'></font>
       do k = kts,kte<a name='385'>
           kflip = kte-k+1<a name='386'>
           qc2(1,kflip)=max(0._r8,min(1.e-6_r8,qc2(1,kflip)))<a name='387'>
            if( t8(1,kflip) &gt; 268.15_r8 ) then<a name='388'>
              dum1 = 0.0_r8<a name='389'>
            elseif( t8(1,kflip) &lt; 238.15_r8 ) then<a name='390'>
              dum1 = 1.0_r8<a name='391'>
            else<a name='392'>
              dum1 = ( 268.15_r8 - t8(1,kflip) ) / 30._r8<a name='393'>
            endif<a name='394'>
           qcten_det(1,kflip) = qc2(1,kflip) * ( 1._r8 - dum1 )<a name='395'>
           qiten_det(1,kflip) = qc2(1,kflip) * dum1 <a name='396'>
           qcnten_det(1,kflip) = 3._r8 * (qc2(1,kflip)    * ( 1._r8 - dum1 ) ) / (4._r8*3.14159_r8*(10.e-6_r8**3)*997._r8) <a name='397'>
           qinten_det(1,kflip) = 3._r8 * (qc2(1,kflip)    *  dum1 ) / (4._r8*3.14159_r8*(50.e-6_r8**3)*500._r8)  <a name='398'>
           qsten_det(1,kflip)      =  qc2(1,kflip) * dum1 * latice                    <font color=#447700>! liquid to ice heating<a name='399'></font>
        end do<a name='400'>
        do k = kts,kte<a name='401'>
           kflip = kte-k+1<a name='402'>
           dlf2(i,k,j)         = qc2(1,kflip)<a name='403'>
           shfrc3d(i,k,j)      = shfrc(1,kflip)   <font color=#447700>! Required by CAM's wet scavenging - Balwinder.Singh@pnnl.gov<a name='404'></font>
<a name='405'>
           <font color=#447700>!Add shallow reserved cloud condensate to deep reserved cloud condensate<a name='406'></font>
           <font color=#447700>! dlf (kg/kg/s, qc in CAM),  rliq done below<a name='407'></font>
           dlf(i,k,j)          = dlf(i,k,j) + qc2(1,kflip)<a name='408'>
<a name='409'>
           evapcsh_inout(i,k,j)= evapcsh(1,kflip)<a name='410'>
           icwmrsh(i,k,j)      = icwmr_uw(1,kflip)<a name='411'>
<a name='412'>
           rprdsh(1,kflip)     = rprdsh(1,kflip) + cmfdqs(1,kflip)<a name='413'>
           rprdsh_inout(i,k,j) = rprdsh(1,kflip)<a name='414'>
           <font color=#447700>!Not doing rprdtot for now since not yet used by other CAM routines in WRF<a name='415'></font>
<a name='416'>
           <font color=#447700>!Tendencies of winds, potential temperature, and moisture<a name='417'></font>
           <font color=#447700>!fields treated specifically by UW scheme<a name='418'></font>
           rushten(i,k,j)  = utnd(1,kflip)<a name='419'>
           rvshten(i,k,j)  = vtnd(1,kflip)<a name='420'>
           rthshten(i,k,j) = (stnd(1,kflip)+qsten_det(1,kflip))/cpair/pi_phy(i,k,j)<a name='421'>
           rqvshten(i,k,j) = qhtnd(1,kflip)*(1. + qv(i,k,j))**2<a name='422'>
           if( p_qc &gt;= param_first_scalar ) &amp;<a name='423'>
                rqcshten(i,k,j) = (qctnd(1,kflip)+qcten_det(1,kflip))*(1. + qv(i,k,j))<a name='424'>
           if( p_qi &gt;= param_first_scalar ) &amp;<a name='425'>
                rqishten(i,k,j) = (qitnd(1,kflip)+qiten_det(1,kflip))*(1. + qv(i,k,j))<a name='426'>
<a name='427'>
           if( p_qnc &gt;= param_first_scalar ) then<a name='428'>
              call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_21">( 'NUMLIQ', m )<a name='429'>
              rqcnshten(i,k,j) = (tnd_tracer(1,kflip,m)+qcnten_det(1,kflip))*(1. + qv(i,k,j))<a name='430'>
           endif<a name='431'>
           if( p_qni &gt;= param_first_scalar ) then<a name='432'>
              call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_22">( 'NUMICE', m )<a name='433'>
              rqinshten(i,k,j) = (tnd_tracer(1,kflip,m)+qinten_det(1,kflip))*(1. + qv(i,k,j))<a name='434'>
           endif<a name='435'>
        end do <font color=#447700>!k-loop to kte              <a name='436'></font>
<font color=#447700>!PMA&lt;<a name='437'></font>
           <a name='438'>
#if ( WRF_CHEM == 1 )<a name='439'>
           <font color=#447700>!BSINGH - update moist8 by physics update call<a name='440'></font>
           <font color=#447700>!Update chem array and state constituents<a name='441'></font>
           <font color=#447700>!populate state_s, ptend_s, ptend_ls with dummy values (zeros) for physics update call<a name='442'></font>
           state_s(:,:)  = 0.0_r8<a name='443'>
           ptend_s(:,:)  = 0.0_r8<a name='444'>
           ptend_ls      = .FALSE.<a name='445'>
           ptend_lq(:)   = .TRUE.<a name='446'>
           ptend_lq(1:5) = .FALSE.<a name='447'>
           ptend_name    = 'convect_shallow'<a name='448'>
<a name='449'>
        <a name='450'>
           call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_UPDATE'>physics_update</A><A href='../../html_code/phys/module_shcu_camuwshcu_driver.F.html#CAMUWSHCU_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_UPDATE_7">(lchnk,ztodt,moist8,tnd_tracer,state_s,ptend_s,ptend_name,ptend_lq,ptend_ls,pcnst)<a name='451'>
           do k = kts,kte<a name='452'>
              kflip = kte-k+1<a name='453'>
              do l = param_first_scalar, num_chem<a name='454'>
                 l2 = lptr_chem_to_q(l)<a name='455'>
                 if ((l2 &gt;= 1) .and. (l2 &lt;= pcnst)) then<a name='456'>
                    chem(i,k,j,l) = moist8(1,kflip,l2)/factconv_chem_to_q(l)<a name='457'>
                 end if<a name='458'>
              end do <font color=#447700>! l<a name='459'></font>
           end do <font color=#447700>!k-loop to kte              <a name='460'></font>
#endif          <a name='461'>
<a name='462'>
<a name='463'>
        do k = kts,kte+1<a name='464'>
           kflip = kte-k+2<a name='465'>
<a name='466'>
           <font color=#447700>!Convective fluxes of 'sl' and 'qt' in energy unit<a name='467'></font>
           cmfsl(i,k,j) = slflx(1,kflip)<a name='468'>
           cmflq(i,k,j) = qtflx(1,kflip)*latvap<a name='469'>
           <font color=#447700>!BSINGH - Storing CMFMC and CMFMC2 at the interfaces<a name='470'></font>
           cmfmc2_inout(i,k,j) = cmfmc2(1,kflip)<a name='471'>
           cmfmc(i,k,j)        = cmfmc(i,k,j) + cmfmc2(1,kflip)<a name='472'>
        end do <font color=#447700>!k-loop to kte+1<a name='473'></font>
<a name='474'>
        <font color=#447700>!Calculate fractional occurance of shallow convection<a name='475'></font>
        <font color=#447700>!~Not doing this since it would require adding time averaging ability across output times<a name='476'></font>
<a name='477'>
        <font color=#447700>!Rain rate for shallow convection<a name='478'></font>
        pratesh(i,j) = precc(1)*1e3/dt <font color=#447700>!~this will need changing for adaptive time steps and cudt<a name='479'></font>
<a name='480'>
        <font color=#447700>!Get indices of convection top and bottom based on deep+shallow<a name='481'></font>
        <font color=#447700>!Note: cnt2 and cnb2 have indices decreasing with height, but<a name='482'></font>
        <font color=#447700>!      cutop and cubot have indicies increasing with height<a name='483'></font>
        kflip = kte - cutop(i,j) + 1<a name='484'>
        cnt = kflip<a name='485'>
        if( cnt2(1) &lt; kflip ) cnt = cnt2(1)<a name='486'>
        cutop(i,j) = kte - cnt + 1<a name='487'>
<a name='488'>
        kflip = kte - cubot(i,j) + 1<a name='489'>
        cnb = kflip<a name='490'>
        if( cnb2(1) &gt; kflip ) cnb = cnb2(1)<a name='491'>
        cubot(i,j) = kte - cnb + 1<a name='492'>
<a name='493'>
        <font color=#447700>!Add shallow reserved cloud condensate to deep reserved cloud condensate<a name='494'></font>
        <font color=#447700>!dlf done above, rliq (m/s)<a name='495'></font>
        rliq2_inout(i,j) = rliq2(1)<a name='496'>
        rliq(i,j)        = rliq(i,j) + rliq2(1)<a name='497'>
<a name='498'>
     end do<a name='499'>
  end do ij_loops<a name='500'>
END SUBROUTINE camuwshcu_driver<a name='501'>
<a name='502'>
END MODULE module_shcu_camuwshcu_driver<a name='503'>
</pre></body></html>