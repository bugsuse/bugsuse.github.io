<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MEDIATION_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>! Contains initialization subroutine lightning_init and driver subroutine<a name='4'></font>
<font color=#447700>! lightning_driver.<a name='5'></font>
<font color=#447700>!<a name='6'></font>
<font color=#447700>! History:<a name='7'></font>
<font color=#447700>!   3.5?  - rewritten and added init, separate out flash rate<a name='8'></font>
<font color=#447700>!           parameterization from emission<a name='9'></font>
<font color=#447700>!   3.4.0 - Added cpm option<a name='10'></font>
<font color=#447700>!   3.3.x - lightning_driver written by M. Barth called in<a name='11'></font>
<font color=#447700>!           emission_driver in chem<a name='12'></font>
<font color=#447700>!<a name='13'></font>
<font color=#447700>! Contact: J. Wong &lt;johnwong@ucar.edu&gt;<a name='14'></font>
<font color=#447700>!<a name='15'></font>
<font color=#447700>!**********************************************************************<a name='16'></font>
<a name='17'>
<A NAME='MODULE_LIGHTNING_DRIVER'><A href='../../html_code/phys/module_lightning_driver.F.html#MODULE_LIGHTNING_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='18'>
 <font color=#993300>MODULE </font><font color=#cc0000>module_lightning_driver</font> <A href='../../call_to/MODULE_LIGHTNING_DRIVER.html' TARGET='index'>2</A><a name='19'>
 CONTAINS<a name='20'>
<a name='21'>
<font color=#447700>!**********************************************************************<a name='22'></font>
<font color=#447700>!<a name='23'></font>
<font color=#447700>! SUBROUTINE lightning_init<a name='24'></font>
<font color=#447700>!<a name='25'></font>
<font color=#447700>! Performs compatibility checks and zero out flash arrays at first timestep.<a name='26'></font>
<font color=#447700>!<a name='27'></font>
<font color=#447700>!**********************************************************************<a name='28'></font>
<a name='29'>
<A NAME='LIGHTNING_INIT'><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='30'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>lightning_init</font> ( &amp; <A href='../../call_to/LIGHTNING_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/LIGHTNING_INIT.html' TARGET='index'>18</A><a name='31'>
                              itimestep, restart, dt, dx               &amp;<a name='32'>
                            <font color=#447700>! Namelist control options<a name='33'></font>
                             ,cu_physics,mp_physics,do_radar_ref       &amp;<a name='34'>
                             ,lightning_option, lightning_dt           &amp;<a name='35'>
                             ,lightning_start_seconds                  &amp;<a name='36'>
                             ,iccg_prescribed_num, iccg_prescribed_den &amp;<a name='37'>
                             ,cellcount_method                         &amp;<a name='38'>
                            <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='39'></font>
                             ,ids, ide, jds, jde, kds, kde             &amp;<a name='40'>
                             ,ims, ime, jms, jme, kms, kme             &amp;<a name='41'>
                             ,its, ite, jts, jte, kts, kte             &amp;<a name='42'>
                            <font color=#447700>! IC and CG flash rates and accumulated flash count<a name='43'></font>
                             ,ic_flashcount, ic_flashrate              &amp;<a name='44'>
                             ,cg_flashcount, cg_flashrate              &amp;<a name='45'>
#if ( WRF_CHEM == 1 )<a name='46'>
                             ,lnox_opt,lnox_passive                    &amp;<a name='47'>
                            <font color=#447700>! LNOx tracers (chemistry only)<a name='48'></font>
                             ,lnox_total, lnox_ic, lnox_cg             &amp;<a name='49'>
#endif<a name='50'>
                            )<a name='51'>
<font color=#447700>!-----------------------------------------------------------------<a name='52'></font>
 USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_123"><a name='53'>
 USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_52"><a name='54'>
 IMPLICIT NONE<a name='55'>
<font color=#447700>!-----------------------------------------------------------------<a name='56'></font>
<a name='57'>
 INTEGER,  INTENT(IN)        :: itimestep<a name='58'>
 LOGICAL,  INTENT(IN)        :: restart<a name='59'>
 REAL,     INTENT(IN)        :: dt,dx<a name='60'>
 INTEGER,  INTENT(IN)        :: cu_physics,mp_physics,do_radar_ref,lightning_option<a name='61'>
<font color=#447700>!REAL,     INTENT(IN)        :: lightning_dt, lightning_start_seconds<a name='62'></font>
 REAL,     INTENT(IN)        :: lightning_start_seconds<a name='63'>
 REAL,     INTENT(INOUT)     :: lightning_dt<a name='64'>
 REAL,     INTENT(IN)        :: iccg_prescribed_num, iccg_prescribed_den<a name='65'>
 INTEGER,  INTENT(INOUT)     :: cellcount_method<a name='66'>
 INTEGER , INTENT(IN)        :: ids, ide, jds, jde, kds, kde,  &amp;<a name='67'>
                                ims, ime, jms, jme, kms, kme,  &amp;<a name='68'>
                                its, ite, jts, jte, kts, kte<a name='69'>
<a name='70'>
<font color=#447700>! Making these optional just in case qualitative lightning indices get implemented<a name='71'></font>
 REAL, OPTIONAL, DIMENSION( ims:ime,jms:jme ), &amp;<a name='72'>
                 INTENT(OUT) :: ic_flashcount, ic_flashrate, &amp;<a name='73'>
                                cg_flashcount, cg_flashrate<a name='74'>
<a name='75'>
#if ( WRF_CHEM == 1 )<a name='76'>
 INTEGER, INTENT(IN)         :: lnox_opt<a name='77'>
 LOGICAL, INTENT(IN)         :: lnox_passive<a name='78'>
 REAL, OPTIONAL, DIMENSION( ims:ime,kms:kme,jms:jme ), &amp;<a name='79'>
                 INTENT(OUT) :: lnox_total, lnox_ic, lnox_cg<a name='80'>
#endif<a name='81'>
<a name='82'>
 CHARACTER (LEN=80) :: message<a name='83'>
<a name='84'>
<font color=#447700>!-----------------------------------------------------------------<a name='85'></font>
<a name='86'>
<font color=#447700>!-- do not reset unless it is the first timestep or lightning_option is on<a name='87'></font>
 IF (itimestep .gt. 0 .or. lightning_option .eq. 0) return<a name='88'>
<a name='89'>
<font color=#447700>!-- check to see if lightning_dt is a proper multiple of dt<a name='90'></font>
 IF ( lightning_dt == 0. ) THEN<a name='91'>
    lightning_dt = dt<a name='92'>
 ELSEIF ( ABS(1.-(1./NINT(lightning_dt/dt)) * (lightning_dt/dt)) .GT. 0.001 ) THEN<a name='93'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_695"> (' lightning_init: lightning_dt needs to be a multiple of model time step dt')<a name='94'>
 ENDIF<a name='95'>
<a name='96'>
<font color=#447700>!--  check to see if the prescribed IC:CG ratio is valid (0/0 and -1 are not allowed)<a name='97'></font>
 IF (iccg_prescribed_den .eq. 0. .and. iccg_prescribed_num .eq. 0.) THEN<a name='98'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_696"> (' lightning_init: iccg_prescribed cannot be 0.0/0.0')<a name='99'>
 ENDIF<a name='100'>
 IF (iccg_prescribed_den .ne. 0.) THEN<a name='101'>
    IF (iccg_prescribed_num/iccg_prescribed_den .eq. -1.) THEN<a name='102'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_697"> (' lightning_init: iccg_prescribed cannot be -1')<a name='103'>
    ENDIF<a name='104'>
 ENDIF<a name='105'>
<a name='106'>
<font color=#447700>!<a name='107'></font>
<font color=#447700>!-- check to see if lightning_option is valid<a name='108'></font>
<font color=#447700>!<a name='109'></font>
<font color=#447700>!   Add new schemes here so it is recognized and proper checks are performed<a name='110'></font>
<font color=#447700>!<a name='111'></font>
 ltng_select: SELECT CASE(lightning_option)<a name='112'>
<a name='113'>
    <font color=#447700>! Convective resolved/permitted<a name='114'></font>
    CASE (ltng_crm_PR92w,ltng_crm_PR92z)<a name='115'>
        IF ( do_radar_ref .eq. 0 .or. mp_physics .eq. 0) THEN<a name='116'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_698">( ' lightning_init: Selected lightning option requires microphysics and do_radar_ref=1' )<a name='117'>
        ENDIF<a name='118'>
<a name='119'>
        WRITE(message, * ) ' lightning_init: CRM lightning option used: ', lightning_option<a name='120'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_611"> ( 100 , message )<a name='121'>
<a name='122'>
    <font color=#447700>! Convective parameterized<a name='123'></font>
    CASE (ltng_cpm_PR92z)<a name='124'>
        IF ( cu_physics .ne. GDSCHEME .and. cu_physics .ne. G3SCHEME  ) THEN<a name='125'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_699">( ' lightning_init: Selected lightning option requires GD or G3 convective parameterization' )<a name='126'>
        ENDIF<a name='127'>
<a name='128'>
        WRITE(message, * ) ' lightning_init: CPM lightning option selected: ', lightning_option<a name='129'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_612"> ( 100 , message )<a name='130'>
<a name='131'>
#if (EM_CORE==1)<a name='132'>
    CASE (ltng_lpi)<a name='133'>
<a name='134'>
        WRITE(message, * ) ' lightning_init: LPIM lightning option selected: ', lightning_option<a name='135'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_613"> ( 100 , message )<a name='136'>
#endif<a name='137'>
    <font color=#447700>! Non-existing options<a name='138'></font>
    CASE DEFAULT<a name='139'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_700"> ( ' lightning_init: invalid lightning_option')<a name='140'>
 END SELECT ltng_select<a name='141'>
<a name='142'>
<font color=#447700>!-- do not re-initialize for restarts<a name='143'></font>
 IF (restart) return<a name='144'>
<a name='145'>
<font color=#447700>!-- zero out arrays<a name='146'></font>
 IF ( PRESENT( ic_flashcount ) .and. PRESENT( ic_flashrate ) .and. &amp;<a name='147'>
      PRESENT( cg_flashcount ) .and. PRESENT( cg_flashrate ) ) THEN<a name='148'>
    CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_614"> ( 100 , ' lightning_init: flash initializing lightning flash arrays' )<a name='149'>
<a name='150'>
    ic_flashrate(:,:)  = 0.<a name='151'>
    ic_flashcount(:,:) = 0.<a name='152'>
    cg_flashrate(:,:)  = 0.<a name='153'>
    cg_flashcount(:,:) = 0.<a name='154'>
 ELSE<a name='155'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_701"> ( ' lightning_init: flash arrays not present' )<a name='156'>
 ENDIF<a name='157'>
<a name='158'>
<font color=#447700>!-- Resolve auto-cellcount method option (cellcount_method=0)<a name='159'></font>
 IF ( ( cellcount_method .eq. 0 ) .and. (lightning_option .eq. ltng_crm_PR92w )) THEN<a name='160'>
   IF ( (ime-ims+1)*dx .gt. 1E4 ) THEN <font color=#447700>! use patch only if path size &gt; 10 km<a name='161'></font>
     cellcount_method = 1<a name='162'>
     WRITE(message, * ) ' lightning_init: setting auto cellcount_method to patch (cellcount_method=1'<a name='163'>
   ELSE<a name='164'>
     cellcount_method = 2<a name='165'>
     WRITE(message, * ) ' lightning_init: setting auto cellcount_method to domain (cellcount_method=2'<a name='166'>
   ENDIF<a name='167'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_615">( 100, message )<a name='168'>
 ENDIF<a name='169'>
<a name='170'>
#if ( WRF_CHEM == 1 )<a name='171'>
<a name='172'>
 CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_616">( 100, ' lightning_init: initializing and validating WRF-Chem only arrays and settings')<a name='173'>
<a name='174'>
 IF ( lnox_opt .ne. lnox_opt_none .and. lightning_option .eq. 0 ) THEN<a name='175'>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_702"> ( ' lightning_init: cannot set LNOx without lightning_option')<a name='176'>
 ENDIF<a name='177'>
<a name='178'>
 IF ( lnox_opt .eq. lnox_opt_decaria .and. ( do_radar_ref .eq. 0 .or. mp_physics .eq. 0 ) ) THEN<a name='179'>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_703"> ( ' lightning_init: lnox_opt_decaria requires microphysics and do_radar_ref' )<a name='180'>
 ENDIF<a name='181'>
<a name='182'>
 IF (PRESENT( lnox_total )) lnox_total(:,:,:) = 0.<a name='183'>
 IF (PRESENT( lnox_cg    )) lnox_cg(:,:,:)    = 0.<a name='184'>
 IF (PRESENT( lnox_ic    )) lnox_ic(:,:,:)    = 0.<a name='185'>
<a name='186'>
#endif<a name='187'>
<a name='188'>
 CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_617">( 200, ' lightning_init: finishing')<a name='189'>
<a name='190'>
 END SUBROUTINE lightning_init<a name='191'>
<a name='192'>
<a name='193'>
<font color=#447700>!**********************************************************************<a name='194'></font>
<font color=#447700>!<a name='195'></font>
<font color=#447700>! SUBROUTINE lightning_driver<a name='196'></font>
<font color=#447700>!<a name='197'></font>
<font color=#447700>! Redirect to the appropriate lightning subroutine.<a name='198'></font>
<font color=#447700>!<a name='199'></font>
<font color=#447700>!**********************************************************************<a name='200'></font>
<a name='201'>
<A NAME='LIGHTNING_DRIVER'><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='202'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>lightning_driver</font> ( &amp; <A href='../../call_to/LIGHTNING_DRIVER.html' TARGET='index'>1</A>,<A href='../../call_from/LIGHTNING_DRIVER.html' TARGET='index'>35</A><a name='203'>
                          <font color=#447700>! Frequently used prognostics<a name='204'></font>
                            itimestep, dt, dx, dy,                &amp;<a name='205'>
                            xlat, xlon, xland, ht,                &amp;<a name='206'>
                            t_phy, p_phy, rho, u, v, w,           &amp;<a name='207'>
                            th_phy, pi_phy,dz8w,                  &amp;  <a name='208'>
                            z, moist,                             &amp;<a name='209'>
                          <font color=#447700>! Scheme specific prognostics<a name='210'></font>
                            ktop_deep,                            &amp;<a name='211'>
                            refl,                                 &amp;<a name='212'>
                            current_time,                         &amp;<a name='213'>
                          <font color=#447700>! Mandatory namelist inputs<a name='214'></font>
                            lightning_option,                     &amp;<a name='215'>
                            lightning_dt,                         &amp;<a name='216'>
                            lightning_start_seconds,              &amp;<a name='217'>
                            flashrate_factor,                     &amp;<a name='218'>
                          <font color=#447700>! IC:CG namelist settings<a name='219'></font>
                            iccg_method,                          &amp;<a name='220'>
                            iccg_prescribed_num,                  &amp;<a name='221'>
                            iccg_prescribed_den,                  &amp;<a name='222'>
                          <font color=#447700>! IC:CG inputs<a name='223'></font>
                            iccg_in_num, iccg_in_den,             &amp;<a name='224'>
                          <font color=#447700>! Scheme specific namelist inputs<a name='225'></font>
                            cellcount_method,                     &amp;<a name='226'>
                            cldtop_adjustment,                    &amp;<a name='227'>
                          <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='228'></font>
                            ids, ide, jds, jde, kds, kde,         &amp;<a name='229'>
                            ims, ime, jms, jme, kms, kme,         &amp;<a name='230'>
                            its, ite, jts, jte, kts, kte,         &amp;<a name='231'>
                          <font color=#447700>! Mandatory outputs for all quantitative schemes<a name='232'></font>
                            ic_flashcount, ic_flashrate,          &amp;<a name='233'>
                            cg_flashcount, cg_flashrate,           &amp;<a name='234'>
                            lpi                                   &amp;<a name='235'>
                          )<a name='236'>
<font color=#447700>!-----------------------------------------------------------------<a name='237'></font>
<font color=#447700>! Framework<a name='238'></font>
 USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_124"><a name='239'>
 USE module_utility<a name='240'>
<a name='241'>
<font color=#447700>! Model layer<a name='242'></font>
 USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_71"><a name='243'>
 USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_53"><a name='244'>
<a name='245'>
<font color=#447700>! Parameterization options<a name='246'></font>
 USE <A href='../../html_code/phys/module_ltng_crmpr92.F.html#MODULE_LTNG_CRMPR92'>module_ltng_crmpr92</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_LTNG_CRMPR92_1">       <font color=#447700>! lightning_option == 1,   ltng_crm_PR92w<a name='247'></font>
                               <font color=#447700>! lightning_option == 2,   ltng_crm_PR92z<a name='248'></font>
 USE <A href='../../html_code/phys/module_ltng_cpmpr92z.F.html#MODULE_LTNG_CPMPR92Z'>module_ltng_cpmpr92z</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_LTNG_CPMPR92Z_1">      <font color=#447700>! lightning_option == 11,  ltng_cpm_PR92z<a name='249'></font>
<a name='250'>
<font color=#447700>! IC:CG methods<a name='251'></font>
 USE <A href='../../html_code/phys/module_ltng_iccg.F.html#MODULE_LTNG_ICCG'>module_ltng_iccg</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_LTNG_ICCG_1"><a name='252'>
<a name='253'>
<font color=#447700>! LPI <a name='254'></font>
#if (EM_CORE==1)<a name='255'>
  USE <A href='../../html_code/phys/module_ltng_lpi.F.html#MODULE_LTNG_LPI'>module_ltng_lpi</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_LTNG_LPI_1"><a name='256'>
#endif<a name='257'>
<a name='258'>
 IMPLICIT NONE<a name='259'>
<font color=#447700>!-----------------------------------------------------------------<a name='260'></font>
<a name='261'>
<font color=#447700>! Frequently used prognostics<a name='262'></font>
 INTEGER, INTENT(IN   )    ::       itimestep<a name='263'>
 REAL,    INTENT(IN   )    ::       dt, dx, dy<a name='264'>
<a name='265'>
 REAL,    DIMENSION( ims:ime,          jms:jme ),           INTENT(IN   ) :: xlat, xlon, xland, ht<a name='266'>
 REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ),           INTENT(IN   ) :: t_phy, p_phy, rho<a name='267'>
 REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ),           INTENT(IN   ) :: th_phy, pi_phy, dz8w  <a name='268'>
 REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ),           INTENT(IN   ) :: u, v, w, z<a name='269'>
 REAL,    DIMENSION( ims:ime, kms:kme, jms:jme, num_moist), INTENT(IN   ) :: moist<a name='270'>
<a name='271'>
<font color=#447700>! Scheme specific prognostics<a name='272'></font>
 INTEGER, DIMENSION( ims:ime,          jms:jme ),           INTENT(IN   ) :: ktop_deep     <font color=#447700>! model LNB from cu_physics<a name='273'></font>
 REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ),           INTENT(IN   ) :: refl          <font color=#447700>! reflectivity from mp_physics<a name='274'></font>
 TYPE(WRFU_Time),                                           INTENT(IN   ) :: current_time  <font color=#447700>! For use of IC:CG input<a name='275'></font>
<a name='276'>
 REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT), OPTIONAL :: LPI<a name='277'>
<font color=#447700>! Mandatory namelist inputs<a name='278'></font>
 INTEGER, INTENT(IN   )    ::       lightning_option<a name='279'>
 REAL,    INTENT(IN   )    ::       lightning_dt, lightning_start_seconds, flashrate_factor<a name='280'>
<a name='281'>
<font color=#447700>! IC:CG namelist settings<a name='282'></font>
 INTEGER, INTENT(IN   )    ::       iccg_method<a name='283'>
 REAL,    INTENT(IN   )    ::       iccg_prescribed_num, iccg_prescribed_den<a name='284'>
 REAL,    DIMENSION( ims:ime, jms:jme, 12), INTENT(IN   ) :: iccg_in_num, iccg_in_den<a name='285'>
<a name='286'>
<font color=#447700>! Scheme specific namelist inputs<a name='287'></font>
 INTEGER, INTENT(IN   )    ::       cellcount_method                    <font color=#447700>! used in CRM<a name='288'></font>
 REAL,    INTENT(IN   )    ::       cldtop_adjustment                   <font color=#447700>! used in CPM<a name='289'></font>
<a name='290'>
<font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='291'></font>
 INTEGER, INTENT(IN   )    ::       ids,ide, jds,jde, kds,kde<a name='292'>
 INTEGER, INTENT(IN   )    ::       ims,ime, jms,jme, kms,kme<a name='293'>
 INTEGER, INTENT(IN   )    ::       its,ite, jts,jte, kts,kte<a name='294'>
<a name='295'>
<font color=#447700>! Mandatory outputs for all quantitative schemes<a name='296'></font>
 REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: ic_flashcount , cg_flashcount<a name='297'>
 REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(  OUT) :: ic_flashrate  , cg_flashrate<a name='298'>
<a name='299'>
<a name='300'>
<font color=#447700>! Local variables<a name='301'></font>
 REAL, DIMENSION( ims:ime, jms:jme ) :: total_flashrate<a name='302'>
 CHARACTER (LEN=80) :: message<a name='303'>
<a name='304'>
 REAL, PARAMETER            :: reflthreshold = 20. <font color=#447700>! reflectivity threshold for CRM schemes<a name='305'></font>
 REAL, DIMENSION( kms:kme ) :: cellcount<a name='306'>
<a name='307'>
<font color=#447700>!-----------------------------------------------------------------<a name='308'></font>
<a name='309'>
 IF ( lightning_option .eq. 0 ) RETURN<a name='310'>
<a name='311'>
 IF ( itimestep * dt .lt. lightning_start_seconds ) RETURN<a name='312'>
<a name='313'>
 IF ( MOD((itimestep * dt - lightning_start_seconds), lightning_dt ) .ne. 0 ) RETURN<a name='314'>
<a name='315'>
<font color=#447700>!-----------------------------------------------------------------<a name='316'></font>
<font color=#447700>! This driver performs several steps in order to produce lightning<a name='317'></font>
<font color=#447700>! flash rate and flash count diagnostics:<a name='318'></font>
<font color=#447700>!<a name='319'></font>
<font color=#447700>! 1. Determine cloud extents for specific CRM schemes<a name='320'></font>
<font color=#447700>! 2. Total flash rate assignment to 2D array<a name='321'></font>
<font color=#447700>! 3. Partitioning of total lightning into IC &amp; CG<a name='322'></font>
<font color=#447700>! 4. Scale flash rate by flashrate_factor and lightning_dt<a name='323'></font>
<font color=#447700>!<a name='324'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='325'></font>
<a name='326'>
 IF ( lightning_option .eq. ltng_crm_PR92w .or. &amp;<a name='327'>
      lightning_option .eq. ltng_crm_PR92z ) THEN<a name='328'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_618"> ( 100, ' lightning_driver: determining cloud extents for CRM' )<a name='329'>
   CALL <A href='../../html_code/phys/module_lightning_driver.F.html#COUNTCELLS'>countCells</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUNTCELLS_1">( &amp;<a name='330'>
          <font color=#447700>! Inputs<a name='331'></font>
            refl, reflthreshold, cellcount_method,     &amp;<a name='332'>
          <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='333'></font>
            ids, ide, jds, jde, kds, kde,              &amp;<a name='334'>
            ims, ime, jms, jme, kms, kme,              &amp;<a name='335'>
            its, ite, jts, jte, kts, kte,              &amp;<a name='336'>
          <font color=#447700>! Outputs<a name='337'></font>
            cellcount )<a name='338'>
   WRITE(message, * ) ' lightning_driver: Max cell count = ', maxval(cellcount)<a name='339'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_619"> ( 100, message )<a name='340'>
 ENDIF<a name='341'>
<a name='342'>
<font color=#447700>!-----------------------------------------------------------------<a name='343'></font>
<a name='344'>
 CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_620"> ( 100, ' lightning_driver: calculating flash rate' )<a name='345'>
 flashrate_select: SELECT CASE(lightning_option)<a name='346'>
<a name='347'>
    <font color=#447700>! CRM lightning options<a name='348'></font>
    CASE( ltng_crm_PR92w )<a name='349'>
        CALL wrf_debug ( 100, ' lightning_driver: calling Price and Rind 1992 (w_max, CRM)' )<a name='350'>
<a name='351'>
        CALL <A href='../../html_code/phys/module_ltng_crmpr92.F.html#LTNG_CRMPR92W'>ltng_crmpr92w</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LTNG_CRMPR92W_1"> ( &amp;<a name='352'>
                  <font color=#447700>! Frequently used prognostics<a name='353'></font>
                    dx, dy, xland, ht, z, t_phy,          &amp;<a name='354'>
                  <font color=#447700>! Scheme specific prognostics<a name='355'></font>
                    w, refl, reflthreshold, cellcount,    &amp;<a name='356'>
                  <font color=#447700>! Scheme specific namelist inputs<a name='357'></font>
                    cellcount_method,                     &amp;<a name='358'>
                  <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='359'></font>
                    ids, ide, jds, jde, kds, kde,         &amp;<a name='360'>
                    ims, ime, jms, jme, kms, kme,         &amp;<a name='361'>
                    its, ite, jts, jte, kts, kte,         &amp;<a name='362'>
                  <font color=#447700>! Mandatory output for all quantitative schemes<a name='363'></font>
                    total_flashrate                       &amp;<a name='364'>
                  )<a name='365'>
    CASE( ltng_crm_PR92z )<a name='366'>
        CALL wrf_debug ( 100, ' lightning_driver: calling Price and Rind 1992 (z_top, CRM)' )<a name='367'>
        CALL <A href='../../html_code/phys/module_ltng_crmpr92.F.html#LTNG_CRMPR92Z'>ltng_crmpr92z</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LTNG_CRMPR92Z_1"> ( &amp;<a name='368'>
                  <font color=#447700>! Frequently used prognostics<a name='369'></font>
                    dx, dy, xland, ht, z, t_phy,          &amp;<a name='370'>
                  <font color=#447700>! Scheme specific prognostics<a name='371'></font>
                    refl, reflthreshold, cellcount,       &amp;<a name='372'>
                  <font color=#447700>! Scheme specific namelist inputs<a name='373'></font>
                    cellcount_method,                     &amp;<a name='374'>
                  <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='375'></font>
                    ids, ide, jds, jde, kds, kde,         &amp;<a name='376'>
                    ims, ime, jms, jme, kms, kme,         &amp;<a name='377'>
                    its, ite, jts, jte, kts, kte,         &amp;<a name='378'>
                  <font color=#447700>! Mandatory output for all quantitative schemes<a name='379'></font>
                    total_flashrate                       &amp;<a name='380'>
                  )<a name='381'>
<font color=#447700>!   CASE ( another_crm_option)<a name='382'></font>
<font color=#447700>!       CALL ...<a name='383'></font>
<a name='384'>
    <font color=#447700>! CPM lightning options<a name='385'></font>
    CASE( ltng_cpm_PR92z )<a name='386'>
        CALL wrf_debug ( 100, ' lightning_driver: calling Price and Rind 1992 (z_top, CPM)' )<a name='387'>
<a name='388'>
        CALL <A href='../../html_code/phys/module_ltng_cpmpr92z.F.html#LTNG_CPMPR92Z'>ltng_cpmpr92z</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LTNG_CPMPR92Z_1"> ( &amp;<a name='389'>
                  <font color=#447700>! Frequently used prognostics<a name='390'></font>
                    dx, dy, xland, ht, z, t_phy,      &amp;<a name='391'>
                    ktop_deep, cldtop_adjustment,     &amp;<a name='392'>
                  <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='393'></font>
                    ids, ide, jds, jde, kds, kde,     &amp;<a name='394'>
                    ims, ime, jms, jme, kms, kme,     &amp;<a name='395'>
                    its, ite, jts, jte, kts, kte,     &amp;<a name='396'>
                  <font color=#447700>! Mandatory output for all quantitative schemes<a name='397'></font>
                    total_flashrate                   &amp;<a name='398'>
                  )<a name='399'>
<a name='400'>
    <font color=#447700>! LPI lightning options<a name='401'></font>
#if (EM_CORE==1)<a name='402'>
    CASE( ltng_lpi )<a name='403'>
        CALL wrf_debug ( 100, ' lightning_driver: calling Light Potential Index' )<a name='404'>
        IF(F_QG) THEN<a name='405'>
        CALL   <A href='../../html_code/phys/module_ltng_lpi.F.html#CALCLPI'>calclpi</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCLPI_1">(W=w,                              &amp;<a name='406'>
                     Z=z,                              &amp;<a name='407'>
                     PI_PHY=pi_phy, RHO_PHY=rho,             &amp;<a name='408'>
                     TH_PHY=TH_PHY,P_PHY=p_phy,                  &amp;<a name='409'>
                     DZ8w=dz8w,                          &amp;<a name='410'>
                     QV=moist(ims,kms,jms,P_QV),         &amp;   <font color=#447700>!Qv=qv_curr,                         &amp;<a name='411'></font>
                     QC=moist(ims,kms,jms,P_QC),         &amp;   <font color=#447700>!Qc=qc_curr,                         &amp;<a name='412'></font>
                     QR=moist(ims,kms,jms,P_QR),         &amp;   <font color=#447700>!QR=qr_curr,                         &amp;<a name='413'></font>
                     QI=moist(ims,kms,jms,P_QI),         &amp;   <font color=#447700>!QI=qi_curr,                         &amp;<a name='414'></font>
                     QS=moist(ims,kms,jms,P_QS),         &amp;   <font color=#447700>!qs_curr,                         &amp;<a name='415'></font>
                     QG=moist(ims,kms,jms,P_QG),         &amp;   <font color=#447700>!qg_curr,                         &amp;<a name='416'></font>
                     QH=moist(ims,kms,jms,P_QH),         &amp;   <font color=#447700>!qh_curr,                         &amp;<a name='417'></font>
                  lpi=lpi &amp;<a name='418'>
                 ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde &amp;<a name='419'>
                 ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme &amp;<a name='420'>
                 ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte)<a name='421'>
        ELSE<a name='422'>
        WRITE(wrf_err_message, * ) ' lightning_driver: LPI option needs Microphysics Option with Graupel '<a name='423'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_704"> ( wrf_err_message )<a name='424'>
        ENDIF<a name='425'>
#endif<a name='426'>
<font color=#447700>!   CASE ( another_cpm_option)<a name='427'></font>
<a name='428'>
    <font color=#447700>! Invalid lightning options<a name='429'></font>
    CASE DEFAULT<a name='430'>
        WRITE(wrf_err_message, * ) ' lightning_driver: The lightning option does not exist: lightning_opt = ', lightning_option<a name='431'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_705"> ( wrf_err_message )<a name='432'>
<a name='433'>
 END SELECT flashrate_select<a name='434'>
<a name='435'>
<font color=#447700>!-----------------------------------------------------------------<a name='436'></font>
<a name='437'>
 CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_621"> ( 100, ' lightning_driver: partitioning IC:CG')<a name='438'>
 iccg_select: SELECT CASE(iccg_method)<a name='439'>
    <font color=#447700>! Flash rate option defaults<a name='440'></font>
    CASE( 0 ) iccg_select<a name='441'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_622">( 100, ' lightning_driver: using option-default IC:CG method' )<a name='442'>
        iccg_method_default: SELECT CASE(lightning_option)<a name='443'>
<a name='444'>
            CASE( ltng_crm_PR92w, ltng_crm_PR92z, ltng_cpm_PR92z ) iccg_method_default<a name='445'>
                CALL <A href='../../html_code/phys/module_ltng_iccg.F.html#ICCG_BOCCIPPIO'>iccg_boccippio</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICCG_BOCCIPPIO_1">( &amp;<a name='446'>
                            xlat, xlon,                                &amp;<a name='447'>
                            iccg_prescribed_num, iccg_prescribed_den,  &amp;<a name='448'>
                          <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='449'></font>
                            ids, ide, jds, jde, kds, kde,              &amp;<a name='450'>
                            ims, ime, jms, jme, kms, kme,              &amp;<a name='451'>
                            its, ite, jts, jte, kts, kte,              &amp;<a name='452'>
                          <font color=#447700>! Input<a name='453'></font>
                            total_flashrate,                           &amp;<a name='454'>
                          <font color=#447700>! Output<a name='455'></font>
                            ic_flashrate, cg_flashrate                 &amp;<a name='456'>
                          )<a name='457'>
<a name='458'>
            CASE DEFAULT iccg_method_default<a name='459'>
                CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_623"> ( 100, ' lightning_driver: no method-default IC:CG implemented, using user-prescribed constant')<a name='460'>
                CALL <A href='../../html_code/phys/module_ltng_iccg.F.html#ICCG_USER_PRESCRIBED'>iccg_user_prescribed</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICCG_USER_PRESCRIBED_1">( &amp;<a name='461'>
                            iccg_prescribed_num,                  &amp;<a name='462'>
                            iccg_prescribed_den,                  &amp;<a name='463'>
                          <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='464'></font>
                            ids, ide, jds, jde, kds, kde,         &amp;<a name='465'>
                            ims, ime, jms, jme, kms, kme,         &amp;<a name='466'>
                            its, ite, jts, jte, kts, kte,         &amp;<a name='467'>
                          <font color=#447700>! Input<a name='468'></font>
                            total_flashrate,                      &amp;<a name='469'>
                          <font color=#447700>! Output<a name='470'></font>
                            ic_flashrate, cg_flashrate            &amp;<a name='471'>
                          )<a name='472'>
<a name='473'>
        END SELECT iccg_method_default<a name='474'>
<a name='475'>
    <font color=#447700>! Used-prescribed constant<a name='476'></font>
    CASE( 1 ) iccg_select<a name='477'>
        WRITE(message, * ) ' lightning_driver: using user-prescribed IC:CG ratio = ', iccg_prescribed_num, iccg_prescribed_den<a name='478'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_624"> ( 100, message )<a name='479'>
        CALL <A href='../../html_code/phys/module_ltng_iccg.F.html#ICCG_USER_PRESCRIBED'>iccg_user_prescribed</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICCG_USER_PRESCRIBED_2">( &amp;<a name='480'>
                    iccg_prescribed_num,                  &amp;<a name='481'>
                    iccg_prescribed_den,                  &amp;<a name='482'>
                  <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='483'></font>
                    ids, ide, jds, jde, kds, kde,         &amp;<a name='484'>
                    ims, ime, jms, jme, kms, kme,         &amp;<a name='485'>
                    its, ite, jts, jte, kts, kte,         &amp;<a name='486'>
                  <font color=#447700>! Input<a name='487'></font>
                    total_flashrate,                      &amp;<a name='488'>
                  <font color=#447700>! Output<a name='489'></font>
                    ic_flashrate, cg_flashrate            &amp;<a name='490'>
                  )<a name='491'>
<a name='492'>
    <font color=#447700>! Boccippio et al, 2001<a name='493'></font>
    CASE( 2 ) iccg_select<a name='494'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_625"> ( 100, ' lightning_driver: using Boccippio 2001 IC:CG climatology')<a name='495'>
        CALL <A href='../../html_code/phys/module_ltng_iccg.F.html#ICCG_BOCCIPPIO'>iccg_boccippio</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICCG_BOCCIPPIO_2">( &amp;<a name='496'>
                    xlat, xlon,                                &amp;<a name='497'>
                    iccg_prescribed_num, iccg_prescribed_den,  &amp;<a name='498'>
                  <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='499'></font>
                    ids, ide, jds, jde, kds, kde,              &amp;<a name='500'>
                    ims, ime, jms, jme, kms, kme,              &amp;<a name='501'>
                    its, ite, jts, jte, kts, kte,              &amp;<a name='502'>
                  <font color=#447700>! Input<a name='503'></font>
                    total_flashrate,                           &amp;<a name='504'>
                  <font color=#447700>! Output<a name='505'></font>
                    ic_flashrate, cg_flashrate                 &amp;<a name='506'>
                  )<a name='507'>
<a name='508'>
    <font color=#447700>! Price and Rind, 1993<a name='509'></font>
    CASE( 3 ) iccg_select<a name='510'>
        iccg_pr93_select: SELECT CASE(lightning_option)<a name='511'>
        CASE( ltng_crm_PR92w, ltng_crm_PR92z ) iccg_pr93_select<a name='512'>
            CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_626"> ( 100, ' lightning_driver: using Price and Rind 1993 IC:CG ratio (CRM)')<a name='513'>
            CALL <A href='../../html_code/phys/module_ltng_crmpr92.F.html#ICCG_CRM_PR93'>iccg_crm_pr93</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICCG_CRM_PR93_1">( &amp;<a name='514'>
                    refl, reflthreshold, t_phy, z,             &amp;<a name='515'>
                  <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='516'></font>
                    ids, ide, jds, jde, kds, kde,              &amp;<a name='517'>
                    ims, ime, jms, jme, kms, kme,              &amp;<a name='518'>
                    its, ite, jts, jte, kts, kte,              &amp;<a name='519'>
                  <font color=#447700>! Input<a name='520'></font>
                    total_flashrate,                           &amp;<a name='521'>
                  <font color=#447700>! Output<a name='522'></font>
                    ic_flashrate, cg_flashrate                 &amp;<a name='523'>
                )<a name='524'>
<a name='525'>
        CASE DEFAULT iccg_pr93_select<a name='526'>
            CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_627"> ( 100, ' lightning_driver: using Price and Rind 1993 IC:CG ratio (CPM)')<a name='527'>
            CALL <A href='../../html_code/phys/module_ltng_iccg.F.html#ICCG_PR93'>iccg_pr93</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICCG_PR93_1">( &amp;<a name='528'>
                    ktop_deep, cldtop_adjustment, t_phy, z,    &amp;<a name='529'>
                  <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='530'></font>
                    ids, ide, jds, jde, kds, kde,              &amp;<a name='531'>
                    ims, ime, jms, jme, kms, kme,              &amp;<a name='532'>
                    its, ite, jts, jte, kts, kte,              &amp;<a name='533'>
                  <font color=#447700>! Input<a name='534'></font>
                    total_flashrate,                           &amp;<a name='535'>
                  <font color=#447700>! Output<a name='536'></font>
                    ic_flashrate, cg_flashrate                 &amp;<a name='537'>
                )<a name='538'>
        END SELECT iccg_pr93_select<a name='539'>
<a name='540'>
    CASE( 4 ) iccg_select<a name='541'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_628"> ( 100, ' lightning_driver: using input IC:CG ratio from iccg_in_(num|den)' )<a name='542'>
        CALL <A href='../../html_code/phys/module_ltng_iccg.F.html#ICCG_INPUT'>iccg_input</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICCG_INPUT_1">( &amp;<a name='543'>
                    iccg_prescribed_num, iccg_prescribed_den,  &amp;<a name='544'>
                    iccg_in_num, iccg_in_den, current_time,    &amp;<a name='545'>
                  <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='546'></font>
                    ids, ide, jds, jde, kds, kde,              &amp;<a name='547'>
                    ims, ime, jms, jme, kms, kme,              &amp;<a name='548'>
                    its, ite, jts, jte, kts, kte,              &amp;<a name='549'>
                  <font color=#447700>! Input<a name='550'></font>
                    total_flashrate,                           &amp;<a name='551'>
                  <font color=#447700>! Output<a name='552'></font>
                    ic_flashrate, cg_flashrate                 &amp;<a name='553'>
                  )<a name='554'>
<a name='555'>
    <font color=#447700>! Invalid IC:CG method<a name='556'></font>
    CASE DEFAULT iccg_select<a name='557'>
        WRITE(wrf_err_message, * ) ' lightning_driver: Invalid IC:CG method (iccg_method) = ', lightning_option<a name='558'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_706"> ( wrf_err_message )<a name='559'>
<a name='560'>
 END SELECT iccg_select<a name='561'>
<a name='562'>
<font color=#447700>!-----------------------------------------------------------------<a name='563'></font>
<a name='564'>
 CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_629">( 200, ' lightning_driver: converting flash rates to flash counts')<a name='565'>
<a name='566'>
 ic_flashrate(its:ite,jts:jte) = ic_flashrate(its:ite,jts:jte) * flashrate_factor<a name='567'>
 cg_flashrate(its:ite,jts:jte) = cg_flashrate(its:ite,jts:jte) * flashrate_factor<a name='568'>
<a name='569'>
 ic_flashcount(its:ite,jts:jte) = ic_flashcount(its:ite,jts:jte) + ic_flashrate(its:ite,jts:jte) * lightning_dt<a name='570'>
 cg_flashcount(its:ite,jts:jte) = cg_flashcount(its:ite,jts:jte) + cg_flashrate(its:ite,jts:jte) * lightning_dt<a name='571'>
<a name='572'>
<font color=#447700>!-----------------------------------------------------------------<a name='573'></font>
<a name='574'>
 CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_630"> ( 100, ' lightning_driver: returning from')<a name='575'>
<a name='576'>
 END SUBROUTINE lightning_driver<a name='577'>
<a name='578'>
<a name='579'>
<font color=#447700>!**********************************************************************<a name='580'></font>
<font color=#447700>!<a name='581'></font>
<font color=#447700>! SUBROUTINE countCells<a name='582'></font>
<font color=#447700>!<a name='583'></font>
<font color=#447700>! For counting number of cells where reflectivity exceeds a certain<a name='584'></font>
<font color=#447700>! threshold. Typically used by CRM schemes to redistribute lightning<a name='585'></font>
<font color=#447700>! within convective cores.<a name='586'></font>
<font color=#447700>!<a name='587'></font>
<font color=#447700>! Departure from original implementation:<a name='588'></font>
<font color=#447700>! Output includes domain-wide cellcounts if cellcount_method = 2<a name='589'></font>
<font color=#447700>!<a name='590'></font>
<font color=#447700>!**********************************************************************<a name='591'></font>
<a name='592'>
<A NAME='COUNTCELLS'><A href='../../html_code/phys/module_lightning_driver.F.html#COUNTCELLS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='593'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>countCells</font>( &amp; <A href='../../call_to/COUNTCELLS.html' TARGET='index'>1</A>,<A href='../../call_from/COUNTCELLS.html' TARGET='index'>2</A><a name='594'>
          <font color=#447700>! Inputs<a name='595'></font>
            refl, reflthreshold, cellcount_method,     &amp;<a name='596'>
          <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='597'></font>
            ids, ide, jds, jde, kds, kde,              &amp;<a name='598'>
            ims, ime, jms, jme, kms, kme,              &amp;<a name='599'>
            its, ite, jts, jte, kts, kte,              &amp;<a name='600'>
          <font color=#447700>! Outputs<a name='601'></font>
            cellcount )<a name='602'>
<a name='603'>
 USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/phys/module_lightning_driver.F.html#COUNTCELLS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_155">, only: wrf_dm_sum_real<a name='604'>
<a name='605'>
 IMPLICIT NONE<a name='606'>
<font color=#447700>!-----------------------------------------------------------------<a name='607'></font>
<a name='608'>
<font color=#447700>! Inputs<a name='609'></font>
 REAL,    DIMENSION( ims:ime,kms:kme,jms:jme ), INTENT(IN   ) :: refl<a name='610'>
 REAL,    INTENT(IN   ) :: reflthreshold<a name='611'>
 INTEGER, INTENT(IN   ) :: cellcount_method<a name='612'>
<a name='613'>
<font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='614'></font>
 INTEGER, INTENT(IN   )    ::       ids,ide, jds,jde, kds,kde<a name='615'>
 INTEGER, INTENT(IN   )    ::       ims,ime, jms,jme, kms,kme<a name='616'>
 INTEGER, INTENT(IN   )    ::       its,ite, jts,jte, kts,kte<a name='617'>
<a name='618'>
<a name='619'>
<font color=#447700>! Outputs<a name='620'></font>
 REAL,    DIMENSION( kms:kme ), INTENT(  OUT) :: cellcount<a name='621'>
<a name='622'>
<font color=#447700>! Local vars<a name='623'></font>
 INTEGER :: i,k,j<a name='624'>
<a name='625'>
<font color=#447700>!-----------------------------------------------------------------<a name='626'></font>
<a name='627'>
 cellcount(kts:kte) = 0.<a name='628'>
 DO j=jts,jte<a name='629'>
   DO k=kts,kte<a name='630'>
     DO i=its,ite<a name='631'>
       IF ( refl(i,k,j) .gt. reflthreshold ) THEN<a name='632'>
         cellcount(k) = cellcount(k) + 1<a name='633'>
       ENDIF<a name='634'>
     ENDDO<a name='635'>
   ENDDO<a name='636'>
 ENDDO<a name='637'>
<a name='638'>
 IF ( cellcount_method .eq. 2 ) THEN<a name='639'>
   DO k=kts,kte<a name='640'>
     cellcount(k) = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_SUM_REAL'>wrf_dm_sum_real</A><A href='../../html_code/phys/module_lightning_driver.F.html#COUNTCELLS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_SUM_REAL_11">(cellcount(k))<a name='641'>
   ENDDO<a name='642'>
 ENDIF<a name='643'>
<a name='644'>
 END SUBROUTINE<a name='645'>
<a name='646'>
 END MODULE module_lightning_driver<a name='647'>
</pre></body></html>