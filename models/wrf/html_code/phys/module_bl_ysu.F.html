<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:model_layer:physics<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>!<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<font color=#447700>!<a name='6'></font>
<font color=#447700>!<a name='7'></font>
<font color=#447700>!<a name='8'></font>
<font color=#447700>!<a name='9'></font>
<A NAME='MODULE_BL_YSU'><A href='../../html_code/phys/module_bl_ysu.F.html#MODULE_BL_YSU' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='10'>
<font color=#993300>module </font><font color=#cc0000>module_bl_ysu</font> <A href='../../call_to/MODULE_BL_YSU.html' TARGET='index'>2</A><a name='11'>
contains<a name='12'>
<font color=#447700>!<a name='13'></font>
<font color=#447700>!<a name='14'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='15'></font>
<font color=#447700>!<a name='16'></font>
<A NAME='YSU'><A href='../../html_code/phys/module_bl_ysu.F.html#YSU' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='17'>
   <font color=#993300>subroutine </font><font color=#cc0000>ysu</font>(u3d,v3d,th3d,t3d,qv3d,qc3d,qi3d,p3d,p3di,pi3d,               &amp; <A href='../../call_to/YSU.html' TARGET='index'>1</A>,<A href='../../call_from/YSU.html' TARGET='index'>1</A><a name='18'>
                  rublten,rvblten,rthblten,                                    &amp;<a name='19'>
                  rqvblten,rqcblten,rqiblten,flag_qi,                          &amp;<a name='20'>
                  cp,g,rovcp,rd,rovg,ep1,ep2,karman,xlv,rv,                    &amp;<a name='21'>
                  dz8w,psfc,                                                   &amp;<a name='22'>
                  znu,znw,p_top,                                               &amp;<a name='23'>
                  znt,ust,hpbl,psim,psih,                                      &amp;<a name='24'>
                  xland,hfx,qfx,wspd,br,                                       &amp;<a name='25'>
                  dt,kpbl2d,                                                   &amp;<a name='26'>
                  exch_h,                                                      &amp;<a name='27'>
                  wstar,delta,                                                 &amp;<a name='28'>
                  u10,v10,                                                     &amp;<a name='29'>
                  uoce,voce,                                                   &amp;<a name='30'>
                  rthraten,ysu_topdown_pblmix,                                 &amp;<a name='31'>
                  ctopo,ctopo2,                                                &amp;<a name='32'>
                  ids,ide, jds,jde, kds,kde,                                   &amp;<a name='33'>
                  ims,ime, jms,jme, kms,kme,                                   &amp;<a name='34'>
                  its,ite, jts,jte, kts,kte,                                   &amp;<a name='35'>
                <font color=#447700>!optional<a name='36'></font>
                  regime                                           )<a name='37'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='38'></font>
   implicit none<a name='39'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='40'></font>
<font color=#447700>!-- u3d         3d u-velocity interpolated to theta points (m/s)<a name='41'></font>
<font color=#447700>!-- v3d         3d v-velocity interpolated to theta points (m/s)<a name='42'></font>
<font color=#447700>!-- th3d        3d potential temperature (k)<a name='43'></font>
<font color=#447700>!-- t3d         temperature (k)<a name='44'></font>
<font color=#447700>!-- qv3d        3d water vapor mixing ratio (kg/kg)<a name='45'></font>
<font color=#447700>!-- qc3d        3d cloud mixing ratio (kg/kg)<a name='46'></font>
<font color=#447700>!-- qi3d        3d ice mixing ratio (kg/kg)<a name='47'></font>
<font color=#447700>!               (note: if P_QI&lt;PARAM_FIRST_SCALAR this should be zero filled)<a name='48'></font>
<font color=#447700>!-- p3d         3d pressure (pa)<a name='49'></font>
<font color=#447700>!-- p3di        3d pressure (pa) at interface level<a name='50'></font>
<font color=#447700>!-- pi3d        3d exner function (dimensionless)<a name='51'></font>
<font color=#447700>!-- rr3d        3d dry air density (kg/m^3)<a name='52'></font>
<font color=#447700>!-- rublten     u tendency due to<a name='53'></font>
<font color=#447700>!               pbl parameterization (m/s/s)<a name='54'></font>
<font color=#447700>!-- rvblten     v tendency due to<a name='55'></font>
<font color=#447700>!               pbl parameterization (m/s/s)<a name='56'></font>
<font color=#447700>!-- rthblten    theta tendency due to<a name='57'></font>
<font color=#447700>!               pbl parameterization (K/s)<a name='58'></font>
<font color=#447700>!-- rqvblten    qv tendency due to<a name='59'></font>
<font color=#447700>!               pbl parameterization (kg/kg/s)<a name='60'></font>
<font color=#447700>!-- rqcblten    qc tendency due to<a name='61'></font>
<font color=#447700>!               pbl parameterization (kg/kg/s)<a name='62'></font>
<font color=#447700>!-- rqiblten    qi tendency due to<a name='63'></font>
<font color=#447700>!               pbl parameterization (kg/kg/s)<a name='64'></font>
<font color=#447700>!-- cp          heat capacity at constant pressure for dry air (j/kg/k)<a name='65'></font>
<font color=#447700>!-- g           acceleration due to gravity (m/s^2)<a name='66'></font>
<font color=#447700>!-- rovcp       r/cp<a name='67'></font>
<font color=#447700>!-- rd          gas constant for dry air (j/kg/k)<a name='68'></font>
<font color=#447700>!-- rovg        r/g<a name='69'></font>
<font color=#447700>!-- dz8w        dz between full levels (m)<a name='70'></font>
<font color=#447700>!-- xlv         latent heat of vaporization (j/kg)<a name='71'></font>
<font color=#447700>!-- rv          gas constant for water vapor (j/kg/k)<a name='72'></font>
<font color=#447700>!-- psfc        pressure at the surface (pa)<a name='73'></font>
<font color=#447700>!-- znt         roughness length (m)<a name='74'></font>
<font color=#447700>!-- ust         u* in similarity theory (m/s)<a name='75'></font>
<font color=#447700>!-- hpbl        pbl height (m)<a name='76'></font>
<font color=#447700>!-- psim        similarity stability function for momentum<a name='77'></font>
<font color=#447700>!-- psih        similarity stability function for heat<a name='78'></font>
<font color=#447700>!-- xland       land mask (1 for land, 2 for water)<a name='79'></font>
<font color=#447700>!-- hfx         upward heat flux at the surface (w/m^2)<a name='80'></font>
<font color=#447700>!-- qfx         upward moisture flux at the surface (kg/m^2/s)<a name='81'></font>
<font color=#447700>!-- wspd        wind speed at lowest model level (m/s)<a name='82'></font>
<font color=#447700>!-- u10         u-wind speed at 10 m (m/s)<a name='83'></font>
<font color=#447700>!-- v10         v-wind speed at 10 m (m/s)<a name='84'></font>
<font color=#447700>!-- uoce        sea surface zonal currents (m s-1)<a name='85'></font>
<font color=#447700>!-- voce        sea surface meridional currents (m s-1)<a name='86'></font>
<font color=#447700>!-- br          bulk richardson number in surface layer<a name='87'></font>
<font color=#447700>!-- dt          time step (s)<a name='88'></font>
<font color=#447700>!-- rvovrd      r_v divided by r_d (dimensionless)<a name='89'></font>
<font color=#447700>!-- ep1         constant for virtual temperature (r_v/r_d - 1)<a name='90'></font>
<font color=#447700>!-- ep2         constant for specific humidity calculation<a name='91'></font>
<font color=#447700>!-- karman      von karman constant<a name='92'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='93'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='94'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='95'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='96'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='97'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='98'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='99'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='100'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='101'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='102'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='103'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='104'></font>
<font color=#447700>!-- its         start index for i in tile<a name='105'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='106'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='107'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='108'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='109'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='110'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='111'></font>
<font color=#447700>!<a name='112'></font>
   integer,parameter ::  ndiff = 3<a name='113'>
   real,parameter    ::  rcl = 1.0<a name='114'>
<font color=#447700>!<a name='115'></font>
   integer,  intent(in   )   ::      ids,ide, jds,jde, kds,kde,                &amp;<a name='116'>
                                     ims,ime, jms,jme, kms,kme,                &amp;<a name='117'>
                                     its,ite, jts,jte, kts,kte<a name='118'>
<a name='119'>
   integer,  intent(in)      ::      ysu_topdown_pblmix<a name='120'>
<font color=#447700>!<a name='121'></font>
   real,     intent(in   )   ::      dt,cp,g,rovcp,rovg,rd,xlv,rv<a name='122'>
<font color=#447700>!<a name='123'></font>
   real,     intent(in )     ::      ep1,ep2,karman<a name='124'>
<font color=#447700>!<a name='125'></font>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='126'>
             intent(in   )   ::                                          qv3d, &amp;<a name='127'>
                                                                         qc3d, &amp;<a name='128'>
                                                                         qi3d, &amp;<a name='129'>
                                                                          p3d, &amp;<a name='130'>
                                                                         pi3d, &amp;<a name='131'>
                                                                         th3d, &amp;<a name='132'>
                                                                          t3d, &amp;<a name='133'>
                                                                         dz8w, &amp;<a name='134'>
                                                                     rthraten<a name='135'>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='136'>
             intent(in   )   ::                                          p3di<a name='137'>
<font color=#447700>!<a name='138'></font>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='139'>
             intent(inout)   ::                                       rublten, &amp;<a name='140'>
                                                                      rvblten, &amp;<a name='141'>
                                                                     rthblten, &amp;<a name='142'>
                                                                     rqvblten, &amp;<a name='143'>
                                                                     rqcblten<a name='144'>
<font color=#447700>!<a name='145'></font>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='146'>
             intent(inout)   ::                                        exch_h<a name='147'>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='148'>
             intent(inout)   ::                                         wstar<a name='149'>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='150'>
             intent(inout)   ::                                         delta<a name='151'>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='152'>
             intent(inout)   ::                                           u10, &amp;<a name='153'>
                                                                          v10<a name='154'>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='155'>
             intent(in   )   ::                                          uoce, &amp;<a name='156'>
                                                                         voce<a name='157'>
<font color=#447700>!<a name='158'></font>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='159'>
             intent(in   )   ::                                         xland, &amp;<a name='160'>
                                                                          hfx, &amp;<a name='161'>
                                                                          qfx, &amp;<a name='162'>
                                                                           br, &amp;<a name='163'>
                                                                         psfc<a name='164'>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='165'>
             intent(in   )   ::                                                &amp;<a name='166'>
                                                                         psim, &amp;<a name='167'>
                                                                         psih<a name='168'>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='169'>
             intent(inout)   ::                                           znt, &amp;<a name='170'>
                                                                          ust, &amp;<a name='171'>
                                                                         hpbl, &amp;<a name='172'>
                                                                          wspd<a name='173'>
<font color=#447700>!<a name='174'></font>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='175'>
             intent(in   )   ::                                           u3d, &amp;<a name='176'>
                                                                          v3d<a name='177'>
<font color=#447700>!<a name='178'></font>
   integer,  dimension( ims:ime, jms:jme )                                   , &amp;<a name='179'>
             intent(out  )   ::                                        kpbl2d<a name='180'>
   logical,  intent(in)      ::                                       flag_qi<a name='181'>
<font color=#447700>!<a name='182'></font>
<font color=#447700>!optional<a name='183'></font>
<font color=#447700>!<a name='184'></font>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='185'>
             optional                                                        , &amp;<a name='186'>
             intent(inout)   ::                                        regime<a name='187'>
<font color=#447700>!<a name='188'></font>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='189'>
             optional                                                        , &amp;<a name='190'>
             intent(inout)   ::                                       rqiblten<a name='191'>
<font color=#447700>!<a name='192'></font>
   real,     dimension( kms:kme )                                            , &amp;<a name='193'>
             optional                                                        , &amp;<a name='194'>
             intent(in   )   ::                                           znu, &amp;<a name='195'>
                                                                          znw<a name='196'>
<font color=#447700>!<a name='197'></font>
<font color=#447700>!<a name='198'></font>
   real,     optional, intent(in   )   ::                               p_top<a name='199'>
<font color=#447700>!<a name='200'></font>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='201'>
             optional                                                        , &amp;<a name='202'>
             intent(in   )   ::                                         ctopo, &amp;<a name='203'>
                                                                       ctopo2<a name='204'>
<font color=#447700>!local<a name='205'></font>
   integer ::  i,j,k<a name='206'>
   real,     dimension( its:ite, kts:kte*ndiff )  ::                 rqvbl2dt, &amp;<a name='207'>
                                                                         qv2d<a name='208'>
   real,     dimension( its:ite, kts:kte )  ::                            pdh<a name='209'>
   real,     dimension( its:ite, kts:kte+1 )  ::                         pdhi<a name='210'>
   real,     dimension( its:ite )  ::                                          &amp;<a name='211'>
                                                                        dusfc, &amp;<a name='212'>
                                                                        dvsfc, &amp;<a name='213'>
                                                                        dtsfc, &amp;<a name='214'>
                                                                        dqsfc<a name='215'>
<font color=#447700>!<a name='216'></font>
   qv2d(its:ite,:) = 0.0<a name='217'>
<font color=#447700>!<a name='218'></font>
   do j = jts,jte<a name='219'>
      do k = kts,kte+1<a name='220'>
        do i = its,ite<a name='221'>
          if(k.le.kte)pdh(i,k) = p3d(i,k,j)<a name='222'>
          pdhi(i,k) = p3di(i,k,j)<a name='223'>
        enddo<a name='224'>
      enddo<a name='225'>
      do k = kts,kte<a name='226'>
        do i = its,ite<a name='227'>
          qv2d(i,k) = qv3d(i,k,j)<a name='228'>
          qv2d(i,k+kte) = qc3d(i,k,j)<a name='229'>
          if(present(rqiblten)) qv2d(i,k+kte+kte) = qi3d(i,k,j)<a name='230'>
        enddo<a name='231'>
      enddo<a name='232'>
<font color=#447700>!<a name='233'></font>
      call <A href='../../html_code/phys/module_bl_ysu.F.html#YSU2D'>ysu2d</A><A href='../../html_code/phys/module_bl_ysu.F.html#YSU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="YSU2D_1">(J=j,ux=u3d(ims,kms,j),vx=v3d(ims,kms,j)                       &amp;<a name='234'>
              ,tx=t3d(ims,kms,j)                                               &amp;<a name='235'>
              ,qx=qv2d(its,kts)                                                &amp;<a name='236'>
              ,p2d=pdh(its,kts),p2di=pdhi(its,kts)                             &amp;<a name='237'>
              ,pi2d=pi3d(ims,kms,j)                                            &amp;<a name='238'>
              ,utnp=rublten(ims,kms,j),vtnp=rvblten(ims,kms,j)                 &amp;<a name='239'>
              ,ttnp=rthblten(ims,kms,j),qtnp=rqvbl2dt(its,kts),ndiff=ndiff     &amp;<a name='240'>
              ,cp=cp,g=g,rovcp=rovcp,rd=rd,rovg=rovg                           &amp;    <a name='241'>
              ,xlv=xlv,rv=rv                                                   &amp;<a name='242'>
              ,ep1=ep1,ep2=ep2,karman=karman                                   &amp;<a name='243'>
              ,dz8w2d=dz8w(ims,kms,j)                                          &amp;<a name='244'>
              ,psfcpa=psfc(ims,j),znt=znt(ims,j),ust=ust(ims,j)                &amp;<a name='245'>
              ,hpbl=hpbl(ims,j)                                                &amp;<a name='246'>
              ,regime=regime(ims,j),psim=psim(ims,j)                           &amp;<a name='247'>
              ,psih=psih(ims,j),xland=xland(ims,j)                             &amp;<a name='248'>
              ,hfx=hfx(ims,j),qfx=qfx(ims,j)                                   &amp;<a name='249'>
              ,wspd=wspd(ims,j),br=br(ims,j)                                   &amp;<a name='250'>
              ,dusfc=dusfc,dvsfc=dvsfc,dtsfc=dtsfc,dqsfc=dqsfc                 &amp;<a name='251'>
              ,dt=dt,rcl=1.0,kpbl1d=kpbl2d(ims,j)                              &amp;<a name='252'>
              ,exch_hx=exch_h(ims,kms,j)                                       &amp;<a name='253'>
              ,wstar=wstar(ims,j)                                              &amp;<a name='254'>
              ,delta=delta(ims,j)                                              &amp;<a name='255'>
              ,u10=u10(ims,j),v10=v10(ims,j)                                   &amp;<a name='256'>
              ,uox=uoce(ims,j),vox=voce(ims,j)                                 &amp;<a name='257'>
              ,rthraten=rthraten(ims,kms,j),p2diORG=p3di(ims,kms,j)            &amp;<a name='258'>
              ,ysu_topdown_pblmix=ysu_topdown_pblmix                           &amp;<a name='259'>
              ,ctopo=ctopo(ims,j),ctopo2=ctopo2(ims,j)                         &amp;<a name='260'>
              ,ids=ids,ide=ide, jds=jds,jde=jde, kds=kds,kde=kde               &amp;<a name='261'>
              ,ims=ims,ime=ime, jms=jms,jme=jme, kms=kms,kme=kme               &amp;<a name='262'>
              ,its=its,ite=ite, jts=jts,jte=jte, kts=kts,kte=kte   )<a name='263'>
<font color=#447700>!<a name='264'></font>
     do k = kts,kte<a name='265'>
       do i = its,ite<a name='266'>
         rthblten(i,k,j) = rthblten(i,k,j)/pi3d(i,k,j)<a name='267'>
         rqvblten(i,k,j) = rqvbl2dt(i,k)<a name='268'>
         rqcblten(i,k,j) = rqvbl2dt(i,k+kte)<a name='269'>
         if(present(rqiblten)) rqiblten(i,k,j) = rqvbl2dt(i,k+kte+kte)<a name='270'>
       enddo<a name='271'>
     enddo<a name='272'>
<font color=#447700>!<a name='273'></font>
   enddo<a name='274'>
<font color=#447700>!<a name='275'></font>
   end subroutine ysu<a name='276'>
<font color=#447700>!<a name='277'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='278'></font>
<font color=#447700>!<a name='279'></font>
<A NAME='YSU2D'><A href='../../html_code/phys/module_bl_ysu.F.html#YSU2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='280'>
   <font color=#993300>subroutine </font><font color=#cc0000>ysu2d</font>(j,ux,vx,tx,qx,p2d,p2di,pi2d,                               &amp; <A href='../../call_to/YSU2D.html' TARGET='index'>1</A>,<A href='../../call_from/YSU2D.html' TARGET='index'>4</A><a name='281'>
                  utnp,vtnp,ttnp,qtnp,ndiff,                                   &amp;<a name='282'>
                  cp,g,rovcp,rd,rovg,ep1,ep2,karman,xlv,rv,                    &amp;<a name='283'>
                  dz8w2d,psfcpa,                                               &amp;<a name='284'>
                  znt,ust,hpbl,psim,psih,                                      &amp;<a name='285'>
                  xland,hfx,qfx,wspd,br,                                       &amp;<a name='286'>
                  dusfc,dvsfc,dtsfc,dqsfc,                                     &amp;<a name='287'>
                  dt,rcl,kpbl1d,                                               &amp;<a name='288'>
                  exch_hx,                                                     &amp;<a name='289'>
                  wstar,delta,                                                 &amp;<a name='290'>
                  u10,v10,                                                     &amp;<a name='291'>
                  uox,vox,                                                     &amp;<a name='292'>
                  rthraten,p2diORG,                                            &amp;<a name='293'>
                  ysu_topdown_pblmix,                                          &amp;<a name='294'>
                  ctopo,ctopo2,                                                &amp;<a name='295'>
                  ids,ide, jds,jde, kds,kde,                                   &amp;<a name='296'>
                  ims,ime, jms,jme, kms,kme,                                   &amp;<a name='297'>
                  its,ite, jts,jte, kts,kte,                                   &amp;<a name='298'>
                <font color=#447700>!optional<a name='299'></font>
                  regime )<a name='300'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='301'></font>
   implicit none<a name='302'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='303'></font>
<font color=#447700>!<a name='304'></font>
<font color=#447700>!     this code is a revised vertical diffusion package ("ysupbl")<a name='305'></font>
<font color=#447700>!     with a nonlocal turbulent mixing in the pbl after "mrfpbl".<a name='306'></font>
<font color=#447700>!     the ysupbl (hong et al. 2006) is based on the study of noh<a name='307'></font>
<font color=#447700>!     et al.(2003) and accumulated realism of the behavior of the<a name='308'></font>
<font color=#447700>!     troen and mahrt (1986) concept implemented by hong and pan(1996).<a name='309'></font>
<font color=#447700>!     the major ingredient of the ysupbl is the inclusion of an explicit<a name='310'></font>
<font color=#447700>!     treatment of the entrainment processes at the entrainment layer.<a name='311'></font>
<font color=#447700>!     this routine uses an implicit approach for vertical flux<a name='312'></font>
<font color=#447700>!     divergence and does not require "miter" timesteps.<a name='313'></font>
<font color=#447700>!     it includes vertical diffusion in the stable atmosphere<a name='314'></font>
<font color=#447700>!     and moist vertical diffusion in clouds.<a name='315'></font>
<font color=#447700>!<a name='316'></font>
<font color=#447700>!     mrfpbl:<a name='317'></font>
<font color=#447700>!     coded by song-you hong (ncep), implemented by jimy dudhia (ncar)<a name='318'></font>
<font color=#447700>!              fall 1996<a name='319'></font>
<font color=#447700>!<a name='320'></font>
<font color=#447700>!     ysupbl:<a name='321'></font>
<font color=#447700>!     coded by song-you hong (yonsei university) and implemented by<a name='322'></font>
<font color=#447700>!              song-you hong (yonsei university) and jimy dudhia (ncar)<a name='323'></font>
<font color=#447700>!              summer 2002<a name='324'></font>
<font color=#447700>!<a name='325'></font>
<font color=#447700>!     further modifications :<a name='326'></font>
<font color=#447700>!              an enhanced stable layer mixing, april 2008<a name='327'></font>
<font color=#447700>!              ==&gt; increase pbl height when sfc is stable (hong 2010)<a name='328'></font>
<font color=#447700>!              pressure-level diffusion, april 2009<a name='329'></font>
<font color=#447700>!              ==&gt; negligible differences<a name='330'></font>
<font color=#447700>!              implicit forcing for momentum with clean up, july 2009<a name='331'></font>
<font color=#447700>!              ==&gt; prevents model blowup when sfc layer is too low<a name='332'></font>
<font color=#447700>!              incresea of lamda, maximum (30, 0.1 x del z) feb 2010<a name='333'></font>
<font color=#447700>!              ==&gt; prevents model blowup when delz is extremely large<a name='334'></font>
<font color=#447700>!              revised prandtl number at surface, peggy lemone, feb 2010<a name='335'></font>
<font color=#447700>!              ==&gt; increase kh, decrease mixing due to counter-gradient term<a name='336'></font>
<font color=#447700>!              revised thermal, shin et al. mon. wea. rev. , songyou hong, aug 2011<a name='337'></font>
<font color=#447700>!              ==&gt; reduce the thermal strength when z1 &lt; 0.1 h<a name='338'></font>
<font color=#447700>!              revised prandtl number for free convection, dudhia, mar 2012<a name='339'></font>
<font color=#447700>!              ==&gt; pr0 = 1 + bke (=0.272) when neutral, kh is reduced<a name='340'></font>
<font color=#447700>!              minimum kzo = 0.01, lo = min (30m,delz), hong, mar 2012<a name='341'></font>
<font color=#447700>!              ==&gt; weaker mixing when stable, and les resolution in vertical<a name='342'></font>
<font color=#447700>!              gz1oz0 is removed, and psim psih are ln(z1/z0)-psim,h, hong, mar 2012<a name='343'></font>
<font color=#447700>!              ==&gt; consider thermal z0 when differs from mechanical z0<a name='344'></font>
<font color=#447700>!              a bug fix in wscale computation in stable bl, sukanta basu, jun 2012<a name='345'></font>
<font color=#447700>!              ==&gt; wscale becomes small with height, and less mixing in stable bl<a name='346'></font>
<font color=#447700>!              revision in background diffusion (kzo), jan 2016<a name='347'></font>
<font color=#447700>!              ==&gt; kzo = 0.1 for momentum and = 0.01 for mass to account for<a name='348'></font>
<font color=#447700>!                  internal wave mixing of large et al. (1994), songyou hong, feb 2016<a name='349'></font>
<font color=#447700>!              ==&gt; alleviate superious excessive mixing when delz is large<a name='350'></font>
<font color=#447700>!<a name='351'></font>
<font color=#447700>!     references:<a name='352'></font>
<font color=#447700>!<a name='353'></font>
<font color=#447700>!        hong (2010) quart. j. roy. met. soc<a name='354'></font>
<font color=#447700>!        hong, noh, and dudhia (2006), mon. wea. rev.<a name='355'></font>
<font color=#447700>!        hong and pan (1996), mon. wea. rev.<a name='356'></font>
<font color=#447700>!        noh, chun, hong, and raasch (2003), boundary layer met.<a name='357'></font>
<font color=#447700>!        troen and mahrt (1986), boundary layer met.<a name='358'></font>
<font color=#447700>!<a name='359'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='360'></font>
<font color=#447700>!<a name='361'></font>
   real,parameter    ::  xkzminm = 0.1,xkzminh = 0.01<a name='362'>
   real,parameter    ::  xkzmin = 0.01,xkzmax = 1000.,rimin = -100.<a name='363'>
   real,parameter    ::  rlam = 30.,prmin = 0.25,prmax = 4.<a name='364'>
   real,parameter    ::  brcr_ub = 0.0,brcr_sb = 0.25,cori = 1.e-4<a name='365'>
   real,parameter    ::  afac = 6.8,bfac = 6.8,pfac = 2.0,pfac_q = 2.0<a name='366'>
   real,parameter    ::  phifac = 8.,sfcfrac = 0.1<a name='367'>
   real,parameter    ::  d1 = 0.02, d2 = 0.05, d3 = 0.001<a name='368'>
   real,parameter    ::  h1 = 0.33333335, h2 = 0.6666667<a name='369'>
   real,parameter    ::  zfmin = 1.e-8,aphi5 = 5.,aphi16 = 16.<a name='370'>
   real,parameter    ::  tmin=1.e-2<a name='371'>
   real,parameter    ::  gamcrt = 3.,gamcrq = 2.e-3<a name='372'>
   real,parameter    ::  xka = 2.4e-5<a name='373'>
   integer,parameter ::  imvdif = 1<a name='374'>
<font color=#447700>!<a name='375'></font>
   integer,  intent(in   )   ::     ids,ide, jds,jde, kds,kde,                 &amp;<a name='376'>
                                    ims,ime, jms,jme, kms,kme,                 &amp;<a name='377'>
                                    its,ite, jts,jte, kts,kte,                 &amp;<a name='378'>
                                    j,ndiff<a name='379'>
<a name='380'>
   integer,  intent(in)      ::     ysu_topdown_pblmix <a name='381'>
<font color=#447700>!<a name='382'></font>
   real,     intent(in   )   ::     dt,rcl,cp,g,rovcp,rovg,rd,xlv,rv<a name='383'>
<font color=#447700>!<a name='384'></font>
   real,     intent(in )     ::     ep1,ep2,karman<a name='385'>
<font color=#447700>!<a name='386'></font>
   real,     dimension( ims:ime, kms:kme ),                                    &amp;<a name='387'>
             intent(in)      ::                                        dz8w2d, &amp;<a name='388'>
                                                                         pi2d, &amp;<a name='389'>
                                                                      p2diorg<a name='390'>
<font color=#447700>!<a name='391'></font>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='392'>
             intent(in   )   ::                                            tx<a name='393'>
   real,     dimension( its:ite, kts:kte*ndiff )                             , &amp;<a name='394'>
             intent(in   )   ::                                            qx<a name='395'>
<font color=#447700>!<a name='396'></font>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='397'>
             intent(inout)   ::                                          utnp, &amp;<a name='398'>
                                                                         vtnp, &amp;<a name='399'>
                                                                         ttnp<a name='400'>
   real,     dimension( its:ite, kts:kte*ndiff )                             , &amp;<a name='401'>
             intent(inout)   ::                                          qtnp<a name='402'>
<font color=#447700>!<a name='403'></font>
   real,     dimension( its:ite, kts:kte+1 )                                 , &amp;<a name='404'>
             intent(in   )   ::                                          p2di<a name='405'>
<font color=#447700>!<a name='406'></font>
   real,     dimension( its:ite, kts:kte )                                   , &amp;<a name='407'>
             intent(in   )   ::                                           p2d<a name='408'>
<font color=#447700>!<a name='409'></font>
   real,     dimension( ims:ime )                                            , &amp;<a name='410'>
             intent(inout)   ::                                           ust, &amp;<a name='411'>
                                                                         hpbl, &amp;<a name='412'>
                                                                          znt<a name='413'>
   real,     dimension( ims:ime )                                            , &amp;<a name='414'>
             intent(in   )   ::                                         xland, &amp;<a name='415'>
                                                                          hfx, &amp;<a name='416'>
                                                                          qfx<a name='417'>
<font color=#447700>!<a name='418'></font>
   real,     dimension( ims:ime ), intent(inout)   ::                    wspd<a name='419'>
   real,     dimension( ims:ime ), intent(in  )    ::                      br<a name='420'>
<font color=#447700>!<a name='421'></font>
   real,     dimension( ims:ime ), intent(in   )   ::                    psim, &amp;<a name='422'>
                                                                         psih<a name='423'>
<font color=#447700>!<a name='424'></font>
   real,     dimension( ims:ime ), intent(in   )   ::                  psfcpa<a name='425'>
   integer,  dimension( ims:ime ), intent(out  )   ::                  kpbl1d<a name='426'>
<font color=#447700>!<a name='427'></font>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='428'>
             intent(in   )   ::                                            ux, &amp;<a name='429'>
                                                                           vx, &amp;<a name='430'>
                                                                      rthraten<a name='431'>
   real,     dimension( ims:ime )                                            , &amp;<a name='432'>
             optional                                                        , &amp;<a name='433'>
             intent(in   )   ::                                         ctopo, &amp;<a name='434'>
                                                                       ctopo2<a name='435'>
   real,     dimension( ims:ime )                                            , &amp;<a name='436'>
             optional                                                        , &amp;<a name='437'>
             intent(inout)   ::                                        regime<a name='438'>
<font color=#447700>!<a name='439'></font>
<font color=#447700>! local vars<a name='440'></font>
<font color=#447700>!<a name='441'></font>
   real,     dimension( its:ite )            ::                           hol<a name='442'>
   real,     dimension( its:ite, kts:kte+1 ) ::                            zq<a name='443'>
<font color=#447700>!<a name='444'></font>
   real,     dimension( its:ite, kts:kte )   ::                                &amp;<a name='445'>
                                                               thx,thvx,thlix, &amp;<a name='446'>
                                                                          del, &amp;<a name='447'>
                                                                          dza, &amp;<a name='448'>
                                                                          dzq, &amp;<a name='449'>
                                                                        xkzom, &amp;<a name='450'>
                                                                        xkzoh, &amp;<a name='451'>
                                                                           za<a name='452'>
<font color=#447700>!<a name='453'></font>
   real,    dimension( its:ite )             ::                                &amp;<a name='454'>
                                                                         rhox, &amp;<a name='455'>
                                                                       govrth, &amp;<a name='456'>
                                                                  zl1,thermal, &amp;<a name='457'>
                                                                       wscale, &amp;<a name='458'>
                                                                  hgamt,hgamq, &amp;<a name='459'>
                                                                    brdn,brup, &amp;<a name='460'>
                                                                    phim,phih, &amp;<a name='461'>
                                                                  dusfc,dvsfc, &amp;<a name='462'>
                                                                  dtsfc,dqsfc, &amp;<a name='463'>
                                                                        prpbl, &amp;<a name='464'>
                                                              wspd1,thermalli<a name='465'>
<font color=#447700>!<a name='466'></font>
   real,    dimension( its:ite, kts:kte )    ::                     xkzm,xkzh, &amp;<a name='467'>
                                                                        f1,f2, &amp;<a name='468'>
                                                                        r1,r2, &amp;<a name='469'>
                                                                        ad,au, &amp;<a name='470'>
                                                                           cu, &amp;<a name='471'>
                                                                           al, &amp;<a name='472'>
                                                                         xkzq, &amp;<a name='473'>
                                                                         zfac, &amp;<a name='474'>
                                                                        rhox2, &amp;<a name='475'>
                                                                       hgamt2<a name='476'>
<font color=#447700>!<a name='477'></font>
<font color=#447700>!jdf added exch_hx<a name='478'></font>
<font color=#447700>!<a name='479'></font>
   real,    dimension( ims:ime, kms:kme )                                    , &amp;<a name='480'>
            intent(inout)   ::                                        exch_hx<a name='481'>
<font color=#447700>!<a name='482'></font>
   real,    dimension( ims:ime )                                             , &amp;<a name='483'>
            intent(inout)    ::                                           u10, &amp;<a name='484'>
                                                                          v10<a name='485'>
   real,    dimension( ims:ime )                                             , &amp;<a name='486'>
            intent(in  )    ::                                            uox, &amp;<a name='487'>
                                                                          vox<a name='488'>
   real,    dimension( its:ite )    ::                                         &amp;<a name='489'>
                                                                         brcr, &amp;<a name='490'>
                                                                        sflux, &amp;<a name='491'>
                                                                         zol1, &amp;<a name='492'>
                                                                    brcr_sbro<a name='493'>
<font color=#447700>!<a name='494'></font>
   real,    dimension( its:ite, kts:kte, ndiff)  ::                     r3,f3<a name='495'>
   integer, dimension( its:ite )             ::                  kpbl,kpblold<a name='496'>
<font color=#447700>!<a name='497'></font>
   logical, dimension( its:ite )             ::                        pblflg, &amp;<a name='498'>
                                                                       sfcflg, &amp;<a name='499'>
                                                                       stable, &amp;<a name='500'>
                                                                     cloudflg<a name='501'>
<a name='502'>
   logical                                   ::                     definebrup<a name='503'>
<font color=#447700>!<a name='504'></font>
   integer ::  n,i,k,l,ic,is,kk<a name='505'>
   integer ::  klpbl, ktrace1, ktrace2, ktrace3<a name='506'>
<font color=#447700>!<a name='507'></font>
<font color=#447700>!<a name='508'></font>
   real    ::  dt2,rdt,spdk2,fm,fh,hol1,gamfac,vpert,prnum,prnum0<a name='509'>
   real    ::  ss,ri,qmean,tmean,alph,chi,zk,rl2,dk,sri<a name='510'>
   real    ::  brint,dtodsd,dtodsu,rdz,dsdzt,dsdzq,dsdz2,rlamdz<a name='511'>
   real    ::  utend,vtend,ttend,qtend<a name='512'>
   real    ::  dtstep,govrthv<a name='513'>
   real    ::  cont, conq, conw, conwrc<a name='514'>
<font color=#447700>!<a name='515'></font>
<a name='516'>
   real, dimension( its:ite, kts:kte )     ::                wscalek,wscalek2<a name='517'>
   real, dimension( ims:ime )              ::                           wstar<a name='518'>
   real, dimension( ims:ime )              ::                           delta<a name='519'>
   real, dimension( its:ite, kts:kte )     ::                     xkzml,xkzhl, &amp;<a name='520'>
                                                               zfacent,entfac<a name='521'>
   real, dimension( its:ite )              ::                            ust3, &amp;<a name='522'>
                                                                       wstar3, &amp;<a name='523'>
                                                                     wstar3_2, &amp;<a name='524'>
                                                                  hgamu,hgamv, &amp;<a name='525'>
                                                                      wm2, we, &amp;<a name='526'>
                                                                       bfxpbl, &amp;<a name='527'>
                                                                hfxpbl,qfxpbl, &amp;<a name='528'>
                                                                ufxpbl,vfxpbl, &amp;<a name='529'>
                                                                        dthvx<a name='530'>
   real    ::  prnumfac,bfx0,hfx0,qfx0,delb,dux,dvx,                           &amp;<a name='531'>
               dsdzu,dsdzv,wm3,dthx,dqx,wspd10,ross,tem1,dsig,tvcon,conpr,     &amp;<a name='532'>
               prfac,prfac2,phim8z,radsum,tmp1,templ,rvls,temps,ent_eff,    &amp;<a name='533'>
               rcldb,bruptmp,radflux,vconvlim,vconvnew,fluxc,vconvc,vconv<a name='534'>
<font color=#447700>!topo-corr<a name='535'></font>
   real,    dimension( ims:ime, kms:kme )    ::                          fric, &amp;<a name='536'>
                                                                       tke_ysu,&amp;<a name='537'>
                                                                        el_ysu,&amp;<a name='538'>
                                                                     shear_ysu,&amp;<a name='539'>
                                                                     buoy_ysu<a name='540'>
   real,    dimension( ims:ime )             ::                       pblh_ysu,&amp;<a name='541'>
                                                                      vconvfx<a name='542'>
<font color=#447700>!<a name='543'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='544'></font>
<font color=#447700>!<a name='545'></font>
   klpbl = kte<a name='546'>
<font color=#447700>!<a name='547'></font>
   cont=cp/g<a name='548'>
   conq=xlv/g<a name='549'>
   conw=1./g<a name='550'>
   conwrc = conw*sqrt(rcl)<a name='551'>
   conpr = bfac*karman*sfcfrac<a name='552'>
<font color=#447700>!<a name='553'></font>
<font color=#447700>!  k-start index for tracer diffusion<a name='554'></font>
<font color=#447700>!<a name='555'></font>
   ktrace1 = 0<a name='556'>
   ktrace2 = 0 + kte<a name='557'>
   ktrace3 = 0 + kte*2<a name='558'>
<font color=#447700>!<a name='559'></font>
   do k = kts,kte<a name='560'>
     do i = its,ite<a name='561'>
       thx(i,k) = tx(i,k)/pi2d(i,k)<a name='562'>
       thlix(i,k) = (tx(i,k)-xlv*qx(i,ktrace2+k)/cp-2.834E6*qx(i,ktrace3+k)/cp)/pi2d(i,k)<a name='563'>
     enddo<a name='564'>
   enddo<a name='565'>
<font color=#447700>!<a name='566'></font>
   do k = kts,kte<a name='567'>
     do i = its,ite<a name='568'>
       tvcon = (1.+ep1*qx(i,k))<a name='569'>
       thvx(i,k) = thx(i,k)*tvcon<a name='570'>
     enddo<a name='571'>
   enddo<a name='572'>
<font color=#447700>!<a name='573'></font>
   do i = its,ite<a name='574'>
     tvcon = (1.+ep1*qx(i,1))<a name='575'>
     rhox(i) = psfcpa(i)/(rd*tx(i,1)*tvcon)<a name='576'>
     govrth(i) = g/thx(i,1)<a name='577'>
   enddo<a name='578'>
<font color=#447700>!<a name='579'></font>
<font color=#447700>!-----compute the height of full- and half-sigma levels above ground<a name='580'></font>
<font color=#447700>!     level, and the layer thicknesses.<a name='581'></font>
<font color=#447700>!<a name='582'></font>
   do i = its,ite<a name='583'>
     zq(i,1) = 0.<a name='584'>
   enddo<a name='585'>
<font color=#447700>!<a name='586'></font>
   do k = kts,kte<a name='587'>
     do i = its,ite<a name='588'>
       zq(i,k+1) = dz8w2d(i,k)+zq(i,k)<a name='589'>
       tvcon = (1.+ep1*qx(i,k))<a name='590'>
       rhox2(i,k) = p2d(i,k)/(rd*tx(i,k)*tvcon)<a name='591'>
     enddo<a name='592'>
   enddo<a name='593'>
<font color=#447700>!<a name='594'></font>
   do k = kts,kte<a name='595'>
     do i = its,ite<a name='596'>
       za(i,k) = 0.5*(zq(i,k)+zq(i,k+1))<a name='597'>
       dzq(i,k) = zq(i,k+1)-zq(i,k)<a name='598'>
       del(i,k) = p2di(i,k)-p2di(i,k+1)<a name='599'>
     enddo<a name='600'>
   enddo<a name='601'>
<font color=#447700>!<a name='602'></font>
   do i = its,ite<a name='603'>
     dza(i,1) = za(i,1)<a name='604'>
   enddo<a name='605'>
<font color=#447700>!<a name='606'></font>
   do k = kts+1,kte<a name='607'>
     do i = its,ite<a name='608'>
       dza(i,k) = za(i,k)-za(i,k-1)<a name='609'>
     enddo<a name='610'>
   enddo<a name='611'>
<font color=#447700>!<a name='612'></font>
<font color=#447700>!<a name='613'></font>
<font color=#447700>!-----initialize vertical tendencies and<a name='614'></font>
<font color=#447700>!<a name='615'></font>
   utnp(its:ite,:) = 0.<a name='616'>
   vtnp(its:ite,:) = 0.<a name='617'>
   ttnp(its:ite,:) = 0.<a name='618'>
   qtnp(its:ite,:) = 0.<a name='619'>
<font color=#447700>!<a name='620'></font>
   do i = its,ite<a name='621'>
     wspd1(i) = sqrt( (ux(i,1)-uox(i))*(ux(i,1)-uox(i)) + (vx(i,1)-vox(i))*(vx(i,1)-vox(i)) )+1.e-9<a name='622'>
   enddo<a name='623'>
<font color=#447700>!<a name='624'></font>
<font color=#447700>!---- compute vertical diffusion<a name='625'></font>
<font color=#447700>!<a name='626'></font>
<font color=#447700>! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<a name='627'></font>
<font color=#447700>!     compute preliminary variables<a name='628'></font>
<font color=#447700>!<a name='629'></font>
   dtstep = dt<a name='630'>
   dt2 = 2.*dtstep<a name='631'>
   rdt = 1./dt2<a name='632'>
<font color=#447700>!<a name='633'></font>
   do i = its,ite<a name='634'>
     bfxpbl(i) = 0.0<a name='635'>
     hfxpbl(i) = 0.0<a name='636'>
     qfxpbl(i) = 0.0<a name='637'>
     ufxpbl(i) = 0.0<a name='638'>
     vfxpbl(i) = 0.0<a name='639'>
     hgamu(i)  = 0.0<a name='640'>
     hgamv(i)  = 0.0<a name='641'>
     delta(i)  = 0.0<a name='642'>
     wstar3_2(i) =  0.0<a name='643'>
   enddo<a name='644'>
<font color=#447700>!<a name='645'></font>
   do k = kts,klpbl<a name='646'>
     do i = its,ite<a name='647'>
       wscalek(i,k) = 0.0<a name='648'>
       wscalek2(i,k) = 0.0<a name='649'>
     enddo<a name='650'>
   enddo<a name='651'>
<font color=#447700>!<a name='652'></font>
   do k = kts,klpbl<a name='653'>
     do i = its,ite<a name='654'>
       zfac(i,k) = 0.0<a name='655'>
     enddo<a name='656'>
   enddo<a name='657'>
   do k = kts,klpbl-1<a name='658'>
     do i = its,ite<a name='659'>
       xkzom(i,k) = xkzminm<a name='660'>
       xkzoh(i,k) = xkzminh<a name='661'>
     enddo<a name='662'>
   enddo<a name='663'>
<font color=#447700>!<a name='664'></font>
   do i = its,ite<a name='665'>
     dusfc(i) = 0.<a name='666'>
     dvsfc(i) = 0.<a name='667'>
     dtsfc(i) = 0.<a name='668'>
     dqsfc(i) = 0.<a name='669'>
   enddo<a name='670'>
<font color=#447700>!<a name='671'></font>
   do i = its,ite<a name='672'>
     hgamt(i)  = 0.<a name='673'>
     hgamq(i)  = 0.<a name='674'>
     wscale(i) = 0.<a name='675'>
     kpbl(i)   = 1<a name='676'>
     hpbl(i)   = zq(i,1)<a name='677'>
     zl1(i)    = za(i,1)<a name='678'>
     thermal(i)= thvx(i,1)<a name='679'>
     thermalli(i) = thlix(i,1)<a name='680'>
     pblflg(i) = .true.<a name='681'>
     sfcflg(i) = .true.<a name='682'>
     sflux(i) = hfx(i)/rhox(i)/cp + qfx(i)/rhox(i)*ep1*thx(i,1)<a name='683'>
     if(br(i).gt.0.0) sfcflg(i) = .false.<a name='684'>
   enddo<a name='685'>
<font color=#447700>!<a name='686'></font>
<font color=#447700>!     compute the first guess of pbl height<a name='687'></font>
<font color=#447700>!<a name='688'></font>
   do i = its,ite<a name='689'>
     stable(i) = .false.<a name='690'>
     brup(i) = br(i)<a name='691'>
     brcr(i) = brcr_ub<a name='692'>
   enddo<a name='693'>
<font color=#447700>!<a name='694'></font>
   do k = 2,klpbl<a name='695'>
     do i = its,ite<a name='696'>
       if(.not.stable(i))then<a name='697'>
         brdn(i) = brup(i)<a name='698'>
         spdk2   = max(ux(i,k)**2+vx(i,k)**2,1.)<a name='699'>
         brup(i) = (thvx(i,k)-thermal(i))*(g*za(i,k)/thvx(i,1))/spdk2<a name='700'>
         kpbl(i) = k<a name='701'>
         stable(i) = brup(i).gt.brcr(i)<a name='702'>
       endif<a name='703'>
     enddo<a name='704'>
   enddo<a name='705'>
<font color=#447700>!<a name='706'></font>
   do i = its,ite<a name='707'>
     k = kpbl(i)<a name='708'>
     if(brdn(i).ge.brcr(i))then<a name='709'>
       brint = 0.<a name='710'>
     elseif(brup(i).le.brcr(i))then<a name='711'>
       brint = 1.<a name='712'>
     else<a name='713'>
       brint = (brcr(i)-brdn(i))/(brup(i)-brdn(i))<a name='714'>
     endif<a name='715'>
     hpbl(i) = za(i,k-1)+brint*(za(i,k)-za(i,k-1))<a name='716'>
     if(hpbl(i).lt.zq(i,2)) kpbl(i) = 1<a name='717'>
     if(kpbl(i).le.1) pblflg(i) = .false.<a name='718'>
   enddo<a name='719'>
<font color=#447700>!<a name='720'></font>
   do i = its,ite<a name='721'>
     fm = psim(i)<a name='722'>
     fh = psih(i)<a name='723'>
     zol1(i) = max(br(i)*fm*fm/fh,rimin)<a name='724'>
     if(sfcflg(i))then<a name='725'>
       zol1(i) = min(zol1(i),-zfmin)<a name='726'>
     else<a name='727'>
       zol1(i) = max(zol1(i),zfmin)<a name='728'>
     endif<a name='729'>
     hol1 = zol1(i)*hpbl(i)/zl1(i)*sfcfrac<a name='730'>
     if(sfcflg(i))then<a name='731'>
       phim(i) = (1.-aphi16*hol1)**(-1./4.)<a name='732'>
       phih(i) = (1.-aphi16*hol1)**(-1./2.)<a name='733'>
       bfx0 = max(sflux(i),0.)<a name='734'>
       hfx0 = max(hfx(i)/rhox(i)/cp,0.)<a name='735'>
       qfx0 = max(ep1*thx(i,1)*qfx(i)/rhox(i),0.)<a name='736'>
       wstar3(i) = (govrth(i)*bfx0*hpbl(i))<a name='737'>
       wstar(i) = (wstar3(i))**h1<a name='738'>
     else<a name='739'>
       phim(i) = (1.+aphi5*hol1)<a name='740'>
       phih(i) = phim(i)<a name='741'>
       wstar(i)  = 0.<a name='742'>
       wstar3(i) = 0.<a name='743'>
     endif<a name='744'>
     ust3(i)   = ust(i)**3.<a name='745'>
     wscale(i) = (ust3(i)+phifac*karman*wstar3(i)*0.5)**h1<a name='746'>
     wscale(i) = min(wscale(i),ust(i)*aphi16)<a name='747'>
     wscale(i) = max(wscale(i),ust(i)/aphi5)<a name='748'>
   enddo<a name='749'>
<font color=#447700>!<a name='750'></font>
<font color=#447700>!     compute the surface variables for pbl height estimation<a name='751'></font>
<font color=#447700>!     under unstable conditions<a name='752'></font>
<font color=#447700>!<a name='753'></font>
   do i = its,ite<a name='754'>
     if(sfcflg(i).and.sflux(i).gt.0.0)then<a name='755'>
       gamfac   = bfac/rhox(i)/wscale(i)<a name='756'>
       hgamt(i) = min(gamfac*hfx(i)/cp,gamcrt)<a name='757'>
       hgamq(i) = min(gamfac*qfx(i),gamcrq)<a name='758'>
       vpert = (hgamt(i)+ep1*thx(i,1)*hgamq(i))/bfac*afac<a name='759'>
       thermal(i) = thermal(i)+max(vpert,0.)*min(za(i,1)/(sfcfrac*hpbl(i)),1.0)<a name='760'>
       thermalli(i)= thermalli(i)+max(vpert,0.)*min(za(i,1)/(sfcfrac*hpbl(i)),1.0)<a name='761'>
       hgamt(i) = max(hgamt(i),0.0)<a name='762'>
       hgamq(i) = max(hgamq(i),0.0)<a name='763'>
       brint    = -15.9*ust(i)*ust(i)/wspd(i)*wstar3(i)/(wscale(i)**4.)<a name='764'>
       hgamu(i) = brint*ux(i,1)<a name='765'>
       hgamv(i) = brint*vx(i,1)<a name='766'>
     else<a name='767'>
       pblflg(i) = .false.<a name='768'>
     endif<a name='769'>
   enddo<a name='770'>
<font color=#447700>!<a name='771'></font>
<font color=#447700>!     enhance the pbl height by considering the thermal<a name='772'></font>
<font color=#447700>!<a name='773'></font>
   do i = its,ite<a name='774'>
     if(pblflg(i))then<a name='775'>
       kpbl(i) = 1<a name='776'>
       hpbl(i) = zq(i,1)<a name='777'>
     endif<a name='778'>
   enddo<a name='779'>
<font color=#447700>!<a name='780'></font>
   do i = its,ite<a name='781'>
     if(pblflg(i))then<a name='782'>
       stable(i) = .false.<a name='783'>
       brup(i) = br(i)<a name='784'>
       brcr(i) = brcr_ub<a name='785'>
     endif<a name='786'>
   enddo<a name='787'>
<font color=#447700>!<a name='788'></font>
   do k = 2,klpbl<a name='789'>
     do i = its,ite<a name='790'>
       if(.not.stable(i).and.pblflg(i))then<a name='791'>
         brdn(i) = brup(i)<a name='792'>
         spdk2   = max(ux(i,k)**2+vx(i,k)**2,1.)<a name='793'>
         brup(i) = (thvx(i,k)-thermal(i))*(g*za(i,k)/thvx(i,1))/spdk2<a name='794'>
         kpbl(i) = k<a name='795'>
         stable(i) = brup(i).gt.brcr(i)<a name='796'>
       endif<a name='797'>
     enddo<a name='798'>
   enddo<a name='799'>
<font color=#447700>!<a name='800'></font>
<font color=#447700>!     enhance pbl by theta-li<a name='801'></font>
<font color=#447700>!<a name='802'></font>
   if (ysu_topdown_pblmix.eq.1)then<a name='803'>
     do i = its,ite<a name='804'>
        kpblold(i) = kpbl(i)<a name='805'>
        definebrup=.false.<a name='806'>
        do k = kpblold(i), kte-1<a name='807'>
           spdk2   = max(ux(i,k)**2+vx(i,k)**2,1.)<a name='808'>
           bruptmp = (thlix(i,k)-thermalli(i))*(g*za(i,k)/thlix(i,1))/spdk2<a name='809'>
           stable(i) = bruptmp.ge.brcr(i)<a name='810'>
           if (definebrup) then<a name='811'>
           kpbl(i) = k<a name='812'>
           brup(i) = bruptmp<a name='813'>
           definebrup=.false.<a name='814'>
           endif<a name='815'>
           if (.not.stable(i)) then <font color=#447700>!overwrite brup brdn values<a name='816'></font>
           brdn(i)=bruptmp<a name='817'>
           definebrup=.true.<a name='818'>
           pblflg(i)=.true.<a name='819'>
           endif<a name='820'>
        enddo<a name='821'>
     enddo<a name='822'>
   endif<a name='823'>
<a name='824'>
   do i = its,ite<a name='825'>
     if(pblflg(i)) then<a name='826'>
       k = kpbl(i)<a name='827'>
       if(brdn(i).ge.brcr(i))then<a name='828'>
         brint = 0.<a name='829'>
       elseif(brup(i).le.brcr(i))then<a name='830'>
         brint = 1.<a name='831'>
       else<a name='832'>
         brint = (brcr(i)-brdn(i))/(brup(i)-brdn(i))<a name='833'>
       endif<a name='834'>
       hpbl(i) = za(i,k-1)+brint*(za(i,k)-za(i,k-1))<a name='835'>
       if(hpbl(i).lt.zq(i,2)) kpbl(i) = 1<a name='836'>
       if(kpbl(i).le.1) pblflg(i) = .false.<a name='837'>
     endif<a name='838'>
   enddo<a name='839'>
<font color=#447700>!<a name='840'></font>
<font color=#447700>!     stable boundary layer<a name='841'></font>
<font color=#447700>!<a name='842'></font>
   do i = its,ite<a name='843'>
     if((.not.sfcflg(i)).and.hpbl(i).lt.zq(i,2)) then<a name='844'>
       brup(i) = br(i)<a name='845'>
       stable(i) = .false.<a name='846'>
     else<a name='847'>
       stable(i) = .true.<a name='848'>
     endif<a name='849'>
   enddo<a name='850'>
<font color=#447700>!<a name='851'></font>
   do i = its,ite<a name='852'>
     if((.not.stable(i)).and.((xland(i)-1.5).ge.0))then<a name='853'>
       wspd10 = u10(i)*u10(i) + v10(i)*v10(i)<a name='854'>
       wspd10 = sqrt(wspd10)<a name='855'>
       ross = wspd10 / (cori*znt(i))<a name='856'>
       brcr_sbro(i) = min(0.16*(1.e-7*ross)**(-0.18),.3)<a name='857'>
     endif<a name='858'>
   enddo<a name='859'>
<font color=#447700>!<a name='860'></font>
   do i = its,ite<a name='861'>
     if(.not.stable(i))then<a name='862'>
       if((xland(i)-1.5).ge.0)then<a name='863'>
         brcr(i) = brcr_sbro(i)<a name='864'>
       else<a name='865'>
         brcr(i) = brcr_sb<a name='866'>
       endif<a name='867'>
     endif<a name='868'>
   enddo<a name='869'>
<font color=#447700>!<a name='870'></font>
   do k = 2,klpbl<a name='871'>
     do i = its,ite<a name='872'>
       if(.not.stable(i))then<a name='873'>
         brdn(i) = brup(i)<a name='874'>
         spdk2   = max(ux(i,k)**2+vx(i,k)**2,1.)<a name='875'>
         brup(i) = (thvx(i,k)-thermal(i))*(g*za(i,k)/thvx(i,1))/spdk2<a name='876'>
         kpbl(i) = k<a name='877'>
         stable(i) = brup(i).gt.brcr(i)<a name='878'>
       endif<a name='879'>
     enddo<a name='880'>
   enddo<a name='881'>
<font color=#447700>!<a name='882'></font>
   do i = its,ite<a name='883'>
     if((.not.sfcflg(i)).and.hpbl(i).lt.zq(i,2)) then<a name='884'>
       k = kpbl(i)<a name='885'>
       if(brdn(i).ge.brcr(i))then<a name='886'>
         brint = 0.<a name='887'>
       elseif(brup(i).le.brcr(i))then<a name='888'>
         brint = 1.<a name='889'>
       else<a name='890'>
         brint = (brcr(i)-brdn(i))/(brup(i)-brdn(i))<a name='891'>
       endif<a name='892'>
       hpbl(i) = za(i,k-1)+brint*(za(i,k)-za(i,k-1))<a name='893'>
       if(hpbl(i).lt.zq(i,2)) kpbl(i) = 1<a name='894'>
       if(kpbl(i).le.1) pblflg(i) = .false.<a name='895'>
     endif<a name='896'>
   enddo<a name='897'>
<font color=#447700>!<a name='898'></font>
<font color=#447700>!     estimate the entrainment parameters<a name='899'></font>
<font color=#447700>!<a name='900'></font>
   do i = its,ite<a name='901'>
     cloudflg(i)=.false. <a name='902'>
     if(pblflg(i)) then<a name='903'>
       k = kpbl(i) - 1<a name='904'>
       wm3       = wstar3(i) + 5. * ust3(i)<a name='905'>
       wm2(i)    = wm3**h2<a name='906'>
       bfxpbl(i) = -0.15*thvx(i,1)/g*wm3/hpbl(i)<a name='907'>
       dthvx(i)  = max(thvx(i,k+1)-thvx(i,k),tmin)<a name='908'>
       we(i) = max(bfxpbl(i)/dthvx(i),-sqrt(wm2(i)))<a name='909'>
       if((qx(i,ktrace2+k)+qx(i,ktrace3+k)).gt.0.01e-3.and.ysu_topdown_pblmix.eq.1)then<a name='910'>
           if ( kpbl(i) .ge. 2) then<a name='911'>
                cloudflg(i)=.true. <a name='912'>
                templ=thlix(i,k)*(p2di(i,k+1)/100000)**rovcp<a name='913'>
                <font color=#447700>!rvls is ws at full level<a name='914'></font>
                rvls=100.*6.112*EXP(17.67*(templ-273.16)/(templ-29.65))*(ep2/p2di(i,k+1))<a name='915'>
                temps=templ + ((qx(i,k)+qx(i,ktrace2+k))-rvls)/(cp/xlv  + &amp;<a name='916'>
                ep2*xlv*rvls/(rd*templ**2))<a name='917'>
                rvls=100.*6.112*EXP(17.67*(temps-273.15)/(temps-29.65))*(ep2/p2di(i,k+1))<a name='918'>
                rcldb=max((qx(i,k)+qx(i,ktrace2+k))-rvls,0.)<a name='919'>
                <font color=#447700>!entrainment efficiency<a name='920'></font>
                dthvx(i)  = (thlix(i,k+2)+thx(i,k+2)*ep1*(qx(i,k+2)+qx(i,ktrace2+k+2))) &amp;<a name='921'>
                          - (thlix(i,k) + thx(i,k)  *ep1*(qx(i,k)  +qx(i,ktrace2+k)))<a name='922'>
                dthvx(i)  = max(dthvx(i),0.1)<a name='923'>
                tmp1      = xlv/cp * rcldb/(pi2d(i,k)*dthvx(i))<a name='924'>
                ent_eff   = 0.2 * 8. * tmp1 +0.2<a name='925'>
<a name='926'>
                radsum=0.<a name='927'>
                do kk = 1,kpbl(i)-1<a name='928'>
                   radflux=rthraten(i,kk)*pi2d(i,kk) <font color=#447700>!converts theta/s to temp/s<a name='929'></font>
                   radflux=radflux*cp/g*(p2diORG(i,kk)-p2diORG(i,kk+1)) <font color=#447700>! converts temp/s to W/m^2<a name='930'></font>
                   if (radflux &lt; 0.0 ) radsum=abs(radflux)+radsum<a name='931'>
                enddo<a name='932'>
                radsum=max(radsum,0.0)<a name='933'>
<a name='934'>
                <font color=#447700>!recompute entrainment from sfc thermals<a name='935'></font>
                bfx0 = max(max(sflux(i),0.0)-radsum/rhox2(i,k)/cp,0.)<a name='936'>
                bfx0 = max(sflux(i),0.0)<a name='937'>
                wm3 = (govrth(i)*bfx0*hpbl(i))+5. * ust3(i)<a name='938'>
                wm2(i)    = wm3**h2<a name='939'>
                bfxpbl(i) = -0.15*thvx(i,1)/g*wm3/hpbl(i)<a name='940'>
                dthvx(i)  = max(thvx(i,k+1)-thvx(i,k),tmin)<a name='941'>
                we(i) = max(bfxpbl(i)/dthvx(i),-sqrt(wm2(i)))<a name='942'>
<a name='943'>
                <font color=#447700>!entrainment from PBL top thermals<a name='944'></font>
                bfx0 = max(radsum/rhox2(i,k)/cp-max(sflux(i),0.0),0.)<a name='945'>
                bfx0 = max(radsum/rhox2(i,k)/cp,0.)<a name='946'>
                wm3       = (g/thvx(i,k)*bfx0*hpbl(i)) <font color=#447700>! this is wstar3(i)<a name='947'></font>
                wm2(i)    = wm2(i)+wm3**h2<a name='948'>
                bfxpbl(i) = - ent_eff * bfx0<a name='949'>
                dthvx(i)  = max(thvx(i,k+1)-thvx(i,k),0.1)<a name='950'>
                we(i) = we(i) + max(bfxpbl(i)/dthvx(i),-sqrt(wm3**h2))<a name='951'>
<a name='952'>
                <font color=#447700>!wstar3_2<a name='953'></font>
                bfx0 = max(radsum/rhox2(i,k)/cp,0.)<a name='954'>
                wstar3_2(i) =  (g/thvx(i,k)*bfx0*hpbl(i))<a name='955'>
                <font color=#447700>!recompute hgamt <a name='956'></font>
                wscale(i) = (ust3(i)+phifac*karman*(wstar3(i)+wstar3_2(i))*0.5)**h1<a name='957'>
                wscale(i) = min(wscale(i),ust(i)*aphi16)<a name='958'>
                wscale(i) = max(wscale(i),ust(i)/aphi5)<a name='959'>
                gamfac   = bfac/rhox(i)/wscale(i)<a name='960'>
                hgamt(i) = min(gamfac*hfx(i)/cp,gamcrt)<a name='961'>
                hgamq(i) = min(gamfac*qfx(i),gamcrq)<a name='962'>
                gamfac   = bfac/rhox2(i,k)/wscale(i)<a name='963'>
                hgamt2(i,k) = min(gamfac*radsum/cp,gamcrt)<a name='964'>
                hgamt(i) = max(hgamt(i),0.0) + max(hgamt2(i,k),0.0)<a name='965'>
                brint    = -15.9*ust(i)*ust(i)/wspd(i)*(wstar3(i)+wstar3_2(i))/(wscale(i)**4.)<a name='966'>
                hgamu(i) = brint*ux(i,1)<a name='967'>
                hgamv(i) = brint*vx(i,1)<a name='968'>
           endif<a name='969'>
       endif<a name='970'>
       prpbl(i) = 1.0<a name='971'>
       dthx  = max(thx(i,k+1)-thx(i,k),tmin)<a name='972'>
       dqx   = min(qx(i,k+1)-qx(i,k),0.0)<a name='973'>
       hfxpbl(i) = we(i)*dthx<a name='974'>
       qfxpbl(i) = we(i)*dqx<a name='975'>
<font color=#447700>!<a name='976'></font>
       dux = ux(i,k+1)-ux(i,k)<a name='977'>
       dvx = vx(i,k+1)-vx(i,k)<a name='978'>
       if(dux.gt.tmin) then<a name='979'>
         ufxpbl(i) = max(prpbl(i)*we(i)*dux,-ust(i)*ust(i))<a name='980'>
       elseif(dux.lt.-tmin) then<a name='981'>
         ufxpbl(i) = min(prpbl(i)*we(i)*dux,ust(i)*ust(i))<a name='982'>
       else<a name='983'>
         ufxpbl(i) = 0.0<a name='984'>
       endif<a name='985'>
       if(dvx.gt.tmin) then<a name='986'>
         vfxpbl(i) = max(prpbl(i)*we(i)*dvx,-ust(i)*ust(i))<a name='987'>
       elseif(dvx.lt.-tmin) then<a name='988'>
         vfxpbl(i) = min(prpbl(i)*we(i)*dvx,ust(i)*ust(i))<a name='989'>
       else<a name='990'>
         vfxpbl(i) = 0.0<a name='991'>
       endif<a name='992'>
       delb  = govrth(i)*d3*hpbl(i)<a name='993'>
       delta(i) = min(d1*hpbl(i) + d2*wm2(i)/delb,100.)<a name='994'>
     endif<a name='995'>
   enddo<a name='996'>
<font color=#447700>!<a name='997'></font>
   do k = kts,klpbl<a name='998'>
     do i = its,ite<a name='999'>
       if(pblflg(i).and.k.ge.kpbl(i))then<a name='1000'>
         entfac(i,k) = ((zq(i,k+1)-hpbl(i))/delta(i))**2.<a name='1001'>
       else<a name='1002'>
         entfac(i,k) = 1.e30<a name='1003'>
       endif<a name='1004'>
     enddo<a name='1005'>
   enddo<a name='1006'>
<font color=#447700>!<a name='1007'></font>
<font color=#447700>!     compute diffusion coefficients below pbl<a name='1008'></font>
<font color=#447700>!<a name='1009'></font>
   do k = kts,klpbl<a name='1010'>
     do i = its,ite<a name='1011'>
       if(k.lt.kpbl(i)) then<a name='1012'>
         zfac(i,k) = min(max((1.-(zq(i,k+1)-zl1(i))/(hpbl(i)-zl1(i))),zfmin),1.)<a name='1013'>
         zfacent(i,k) = (1.-zfac(i,k))**3.<a name='1014'>
         wscalek(i,k) = (ust3(i)+phifac*karman*wstar3(i)*(1.-zfac(i,k)))**h1<a name='1015'>
         wscalek2(i,k) = (phifac*karman*wstar3_2(i)*(zfac(i,k)))**h1<a name='1016'>
         if(sfcflg(i)) then<a name='1017'>
           prfac = conpr<a name='1018'>
           prfac2 = 15.9*(wstar3(i)+wstar3_2(i))/ust3(i)/(1.+4.*karman*(wstar3(i)+wstar3_2(i))/ust3(i))<a name='1019'>
           prnumfac = -3.*(max(zq(i,k+1)-sfcfrac*hpbl(i),0.))**2./hpbl(i)**2.<a name='1020'>
         else<a name='1021'>
           prfac = 0.<a name='1022'>
           prfac2 = 0.<a name='1023'>
           prnumfac = 0.<a name='1024'>
           phim8z = 1.+aphi5*zol1(i)*zq(i,k+1)/zl1(i)<a name='1025'>
           wscalek(i,k) = ust(i)/phim8z<a name='1026'>
           wscalek(i,k) = max(wscalek(i,k),0.001)<a name='1027'>
         endif<a name='1028'>
         prnum0 = (phih(i)/phim(i)+prfac)<a name='1029'>
         prnum0 = max(min(prnum0,prmax),prmin)<a name='1030'>
           xkzm(i,k) = wscalek(i,k) *karman*    zq(i,k+1)      *    zfac(i,k)**pfac+ &amp;<a name='1031'>
                       wscalek2(i,k)*karman*(hpbl(i)-zq(i,k+1))*(1-zfac(i,k))**pfac<a name='1032'>
         <font color=#447700>!Do not include xkzm at kpbl-1 since it changes entrainment<a name='1033'></font>
         if (k.eq.kpbl(i)-1.and.cloudflg(i).and.we(i).lt.0.0) then<a name='1034'>
           xkzm(i,k) = 0.0<a name='1035'>
         endif<a name='1036'>
         prnum =  1. + (prnum0-1.)*exp(prnumfac)<a name='1037'>
         xkzq(i,k) = xkzm(i,k)/prnum*zfac(i,k)**(pfac_q-pfac)<a name='1038'>
         prnum0 = prnum0/(1.+prfac2*karman*sfcfrac)<a name='1039'>
         prnum =  1. + (prnum0-1.)*exp(prnumfac)<a name='1040'>
         xkzh(i,k) = xkzm(i,k)/prnum<a name='1041'>
         xkzm(i,k) = xkzm(i,k)+xkzom(i,k)<a name='1042'>
         xkzh(i,k) = xkzh(i,k)+xkzoh(i,k)<a name='1043'>
         xkzq(i,k) = xkzq(i,k)+xkzoh(i,k)<a name='1044'>
         xkzm(i,k) = min(xkzm(i,k),xkzmax)<a name='1045'>
         xkzh(i,k) = min(xkzh(i,k),xkzmax)<a name='1046'>
         xkzq(i,k) = min(xkzq(i,k),xkzmax)<a name='1047'>
       endif<a name='1048'>
     enddo<a name='1049'>
   enddo<a name='1050'>
<font color=#447700>!<a name='1051'></font>
<font color=#447700>!     compute diffusion coefficients over pbl (free atmosphere)<a name='1052'></font>
<font color=#447700>!<a name='1053'></font>
   do k = kts,kte-1<a name='1054'>
     do i = its,ite<a name='1055'>
       if(k.ge.kpbl(i)) then<a name='1056'>
         ss = ((ux(i,k+1)-ux(i,k))*(ux(i,k+1)-ux(i,k))                         &amp;<a name='1057'>
              +(vx(i,k+1)-vx(i,k))*(vx(i,k+1)-vx(i,k)))                        &amp;<a name='1058'>
              /(dza(i,k+1)*dza(i,k+1))+1.e-9<a name='1059'>
         govrthv = g/(0.5*(thvx(i,k+1)+thvx(i,k)))<a name='1060'>
         ri = govrthv*(thvx(i,k+1)-thvx(i,k))/(ss*dza(i,k+1))<a name='1061'>
         if(imvdif.eq.1.and.ndiff.ge.3)then<a name='1062'>
           if((qx(i,ktrace2+k)+qx(i,ktrace3+k)).gt.0.01e-3.and.(qx(i           &amp;<a name='1063'>
             ,ktrace2+k+1)+qx(i,ktrace3+k+1)).gt.0.01e-3)then<a name='1064'>
<font color=#447700>!      in cloud<a name='1065'></font>
             qmean = 0.5*(qx(i,k)+qx(i,k+1))<a name='1066'>
             tmean = 0.5*(tx(i,k)+tx(i,k+1))<a name='1067'>
             alph  = xlv*qmean/rd/tmean<a name='1068'>
             chi   = xlv*xlv*qmean/cp/rv/tmean/tmean<a name='1069'>
             ri    = (1.+alph)*(ri-g*g/ss/tmean/cp*((chi-alph)/(1.+chi)))<a name='1070'>
           endif<a name='1071'>
         endif<a name='1072'>
         zk = karman*zq(i,k+1)<a name='1073'>
         rlamdz = min(max(0.1*dza(i,k+1),rlam),300.)<a name='1074'>
         rlamdz = min(dza(i,k+1),rlamdz)<a name='1075'>
         rl2 = (zk*rlamdz/(rlamdz+zk))**2<a name='1076'>
         dk = rl2*sqrt(ss)<a name='1077'>
         if(ri.lt.0.)then<a name='1078'>
<font color=#447700>! unstable regime<a name='1079'></font>
           ri = max(ri, rimin)<a name='1080'>
           sri = sqrt(-ri)<a name='1081'>
           xkzm(i,k) = dk*(1+8.*(-ri)/(1+1.746*sri))<a name='1082'>
           xkzh(i,k) = dk*(1+8.*(-ri)/(1+1.286*sri))<a name='1083'>
         else<a name='1084'>
<font color=#447700>! stable regime<a name='1085'></font>
           xkzh(i,k) = dk/(1+5.*ri)**2<a name='1086'>
           prnum = 1.0+2.1*ri<a name='1087'>
           prnum = min(prnum,prmax)<a name='1088'>
           xkzm(i,k) = xkzh(i,k)*prnum<a name='1089'>
         endif<a name='1090'>
<font color=#447700>!<a name='1091'></font>
         xkzm(i,k) = xkzm(i,k)+xkzom(i,k)<a name='1092'>
         xkzh(i,k) = xkzh(i,k)+xkzoh(i,k)<a name='1093'>
         xkzm(i,k) = min(xkzm(i,k),xkzmax)<a name='1094'>
         xkzh(i,k) = min(xkzh(i,k),xkzmax)<a name='1095'>
         xkzml(i,k) = xkzm(i,k)<a name='1096'>
         xkzhl(i,k) = xkzh(i,k)<a name='1097'>
       endif<a name='1098'>
     enddo<a name='1099'>
   enddo<a name='1100'>
<font color=#447700>!<a name='1101'></font>
<font color=#447700>!     compute tridiagonal matrix elements for heat<a name='1102'></font>
<font color=#447700>!<a name='1103'></font>
   do k = kts,kte<a name='1104'>
     do i = its,ite<a name='1105'>
       au(i,k) = 0.<a name='1106'>
       al(i,k) = 0.<a name='1107'>
       ad(i,k) = 0.<a name='1108'>
       f1(i,k) = 0.<a name='1109'>
     enddo<a name='1110'>
   enddo<a name='1111'>
<font color=#447700>!<a name='1112'></font>
   do i = its,ite<a name='1113'>
     ad(i,1) = 1.<a name='1114'>
     f1(i,1) = thx(i,1)-300.+hfx(i)/cont/del(i,1)*dt2<a name='1115'>
   enddo<a name='1116'>
<font color=#447700>!<a name='1117'></font>
   do k = kts,kte-1<a name='1118'>
     do i = its,ite<a name='1119'>
       dtodsd = dt2/del(i,k)<a name='1120'>
       dtodsu = dt2/del(i,k+1)<a name='1121'>
       dsig   = p2d(i,k)-p2d(i,k+1)<a name='1122'>
       rdz    = 1./dza(i,k+1)<a name='1123'>
       tem1   = dsig*xkzh(i,k)*rdz<a name='1124'>
       if(pblflg(i).and.k.lt.kpbl(i)) then<a name='1125'>
         dsdzt = tem1*(-hgamt(i)/hpbl(i)-hfxpbl(i)*zfacent(i,k)/xkzh(i,k))<a name='1126'>
         f1(i,k)   = f1(i,k)+dtodsd*dsdzt<a name='1127'>
         f1(i,k+1) = thx(i,k+1)-300.-dtodsu*dsdzt<a name='1128'>
       elseif(pblflg(i).and.k.ge.kpbl(i).and.entfac(i,k).lt.4.6) then<a name='1129'>
         xkzh(i,k) = -we(i)*dza(i,kpbl(i))*exp(-entfac(i,k))<a name='1130'>
         xkzh(i,k) = sqrt(xkzh(i,k)*xkzhl(i,k))<a name='1131'>
         xkzh(i,k) = max(xkzh(i,k),xkzoh(i,k))<a name='1132'>
         xkzh(i,k) = min(xkzh(i,k),xkzmax)<a name='1133'>
         f1(i,k+1) = thx(i,k+1)-300.<a name='1134'>
       else<a name='1135'>
         f1(i,k+1) = thx(i,k+1)-300.<a name='1136'>
       endif<a name='1137'>
       tem1   = dsig*xkzh(i,k)*rdz<a name='1138'>
       dsdz2     = tem1*rdz<a name='1139'>
       au(i,k)   = -dtodsd*dsdz2<a name='1140'>
       al(i,k)   = -dtodsu*dsdz2<a name='1141'>
       ad(i,k)   = ad(i,k)-au(i,k)<a name='1142'>
       ad(i,k+1) = 1.-al(i,k)<a name='1143'>
       exch_hx(i,k+1) = xkzh(i,k)<a name='1144'>
     enddo<a name='1145'>
   enddo<a name='1146'>
<font color=#447700>!<a name='1147'></font>
<font color=#447700>! copies here to avoid duplicate input args for tridin<a name='1148'></font>
<font color=#447700>!<a name='1149'></font>
   do k = kts,kte<a name='1150'>
     do i = its,ite<a name='1151'>
       cu(i,k) = au(i,k)<a name='1152'>
       r1(i,k) = f1(i,k)<a name='1153'>
     enddo<a name='1154'>
   enddo<a name='1155'>
<font color=#447700>!<a name='1156'></font>
   call <A href='../../html_code/phys/module_bl_ysu.F.html#TRIDIN_YSU'>tridin_ysu</A><A href='../../html_code/phys/module_bl_ysu.F.html#YSU2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIN_YSU_3">(al,ad,cu,r1,au,f1,its,ite,kts,kte,1)<a name='1157'>
<font color=#447700>!<a name='1158'></font>
<font color=#447700>!     recover tendencies of heat<a name='1159'></font>
<font color=#447700>!<a name='1160'></font>
   do k = kte,kts,-1<a name='1161'>
     do i = its,ite<a name='1162'>
       ttend = (f1(i,k)-thx(i,k)+300.)*rdt*pi2d(i,k)<a name='1163'>
       ttnp(i,k) = ttnp(i,k)+ttend<a name='1164'>
       dtsfc(i) = dtsfc(i)+ttend*cont*del(i,k)/pi2d(i,k)<a name='1165'>
     enddo<a name='1166'>
   enddo<a name='1167'>
<font color=#447700>!<a name='1168'></font>
<font color=#447700>!     compute tridiagonal matrix elements for moisture, clouds, and gases<a name='1169'></font>
<font color=#447700>!<a name='1170'></font>
   do k = kts,kte<a name='1171'>
     do i = its,ite<a name='1172'>
       au(i,k) = 0.<a name='1173'>
       al(i,k) = 0.<a name='1174'>
       ad(i,k) = 0.<a name='1175'>
     enddo<a name='1176'>
   enddo<a name='1177'>
<font color=#447700>!<a name='1178'></font>
   do ic = 1,ndiff<a name='1179'>
     do i = its,ite<a name='1180'>
       do k = kts,kte<a name='1181'>
         f3(i,k,ic) = 0.<a name='1182'>
       enddo<a name='1183'>
     enddo<a name='1184'>
   enddo<a name='1185'>
<font color=#447700>!<a name='1186'></font>
   do i = its,ite<a name='1187'>
     ad(i,1) = 1.<a name='1188'>
     f3(i,1,1) = qx(i,1)+qfx(i)*g/del(i,1)*dt2<a name='1189'>
   enddo<a name='1190'>
<font color=#447700>!<a name='1191'></font>
   if(ndiff.ge.2) then<a name='1192'>
     do ic = 2,ndiff<a name='1193'>
       is = (ic-1) * kte<a name='1194'>
       do i = its,ite<a name='1195'>
         f3(i,1,ic) = qx(i,1+is)<a name='1196'>
       enddo<a name='1197'>
     enddo<a name='1198'>
   endif<a name='1199'>
<font color=#447700>!<a name='1200'></font>
   do k = kts,kte-1<a name='1201'>
     do i = its,ite<a name='1202'>
       if(k.ge.kpbl(i)) then<a name='1203'>
         xkzq(i,k) = xkzh(i,k)<a name='1204'>
       endif<a name='1205'>
     enddo<a name='1206'>
   enddo<a name='1207'>
<font color=#447700>!<a name='1208'></font>
   do k = kts,kte-1<a name='1209'>
     do i = its,ite<a name='1210'>
       dtodsd = dt2/del(i,k)<a name='1211'>
       dtodsu = dt2/del(i,k+1)<a name='1212'>
       dsig   = p2d(i,k)-p2d(i,k+1)<a name='1213'>
       rdz    = 1./dza(i,k+1)<a name='1214'>
       tem1   = dsig*xkzq(i,k)*rdz<a name='1215'>
       if(pblflg(i).and.k.lt.kpbl(i)) then<a name='1216'>
         dsdzq = tem1*(-qfxpbl(i)*zfacent(i,k)/xkzq(i,k))<a name='1217'>
         f3(i,k,1) = f3(i,k,1)+dtodsd*dsdzq<a name='1218'>
         f3(i,k+1,1) = qx(i,k+1)-dtodsu*dsdzq<a name='1219'>
       elseif(pblflg(i).and.k.ge.kpbl(i).and.entfac(i,k).lt.4.6) then<a name='1220'>
         xkzq(i,k) = -we(i)*dza(i,kpbl(i))*exp(-entfac(i,k))<a name='1221'>
         xkzq(i,k) = sqrt(xkzq(i,k)*xkzhl(i,k))<a name='1222'>
         xkzq(i,k) = max(xkzq(i,k),xkzoh(i,k))<a name='1223'>
         xkzq(i,k) = min(xkzq(i,k),xkzmax)<a name='1224'>
         f3(i,k+1,1) = qx(i,k+1)<a name='1225'>
       else<a name='1226'>
         f3(i,k+1,1) = qx(i,k+1)<a name='1227'>
       endif<a name='1228'>
       tem1   = dsig*xkzq(i,k)*rdz<a name='1229'>
       dsdz2     = tem1*rdz<a name='1230'>
       au(i,k)   = -dtodsd*dsdz2<a name='1231'>
       al(i,k)   = -dtodsu*dsdz2<a name='1232'>
       ad(i,k)   = ad(i,k)-au(i,k)<a name='1233'>
       ad(i,k+1) = 1.-al(i,k)<a name='1234'>
<font color=#447700>!      exch_hx(i,k+1) = xkzh(i,k)<a name='1235'></font>
     enddo<a name='1236'>
   enddo<a name='1237'>
<font color=#447700>!<a name='1238'></font>
   if(ndiff.ge.2) then<a name='1239'>
     do ic = 2,ndiff<a name='1240'>
       is = (ic-1) * kte<a name='1241'>
       do k = kts,kte-1<a name='1242'>
         do i = its,ite<a name='1243'>
           f3(i,k+1,ic) = qx(i,k+1+is)<a name='1244'>
         enddo<a name='1245'>
       enddo<a name='1246'>
     enddo<a name='1247'>
   endif<a name='1248'>
<font color=#447700>!<a name='1249'></font>
<font color=#447700>! copies here to avoid duplicate input args for tridin<a name='1250'></font>
<font color=#447700>!<a name='1251'></font>
   do k = kts,kte<a name='1252'>
     do i = its,ite<a name='1253'>
       cu(i,k) = au(i,k)<a name='1254'>
     enddo<a name='1255'>
   enddo<a name='1256'>
<font color=#447700>!<a name='1257'></font>
   do ic = 1,ndiff<a name='1258'>
     do k = kts,kte<a name='1259'>
       do i = its,ite<a name='1260'>
         r3(i,k,ic) = f3(i,k,ic)<a name='1261'>
       enddo<a name='1262'>
     enddo<a name='1263'>
   enddo<a name='1264'>
<font color=#447700>!<a name='1265'></font>
<font color=#447700>!     solve tridiagonal problem for moisture, clouds, and gases<a name='1266'></font>
<font color=#447700>!<a name='1267'></font>
   call <A href='../../html_code/phys/module_bl_ysu.F.html#TRIDIN_YSU'>tridin_ysu</A><A href='../../html_code/phys/module_bl_ysu.F.html#YSU2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIN_YSU_4">(al,ad,cu,r3,au,f3,its,ite,kts,kte,ndiff)<a name='1268'>
<font color=#447700>!<a name='1269'></font>
<font color=#447700>!     recover tendencies of heat and moisture<a name='1270'></font>
<font color=#447700>!<a name='1271'></font>
   do k = kte,kts,-1<a name='1272'>
     do i = its,ite<a name='1273'>
       qtend = (f3(i,k,1)-qx(i,k))*rdt<a name='1274'>
       qtnp(i,k) = qtnp(i,k)+qtend<a name='1275'>
       dqsfc(i) = dqsfc(i)+qtend*conq*del(i,k)<a name='1276'>
     enddo<a name='1277'>
   enddo<a name='1278'>
<font color=#447700>!<a name='1279'></font>
   if(ndiff.ge.2) then<a name='1280'>
     do ic = 2,ndiff<a name='1281'>
       is = (ic-1) * kte<a name='1282'>
       do k = kte,kts,-1<a name='1283'>
         do i = its,ite<a name='1284'>
           qtend = (f3(i,k,ic)-qx(i,k+is))*rdt<a name='1285'>
           qtnp(i,k+is) = qtnp(i,k+is)+qtend<a name='1286'>
         enddo<a name='1287'>
       enddo<a name='1288'>
     enddo<a name='1289'>
   endif<a name='1290'>
<font color=#447700>!<a name='1291'></font>
<font color=#447700>!     compute tridiagonal matrix elements for momentum<a name='1292'></font>
<font color=#447700>!<a name='1293'></font>
   do i = its,ite<a name='1294'>
     do k = kts,kte<a name='1295'>
       au(i,k) = 0.<a name='1296'>
       al(i,k) = 0.<a name='1297'>
       ad(i,k) = 0.<a name='1298'>
       f1(i,k) = 0.<a name='1299'>
       f2(i,k) = 0.<a name='1300'>
     enddo<a name='1301'>
   enddo<a name='1302'>
<font color=#447700>!<a name='1303'></font>
<font color=#447700>! paj: ctopo=1 if topo_wind=0 (default)<a name='1304'></font>
<font color=#447700>!raquel---paj tke code (could be replaced with shin-hong tke in future<a name='1305'></font>
   do i = its,ite<a name='1306'>
      do k= kts, kte-1<a name='1307'>
        shear_ysu(i,k)=xkzm(i,k)*((-hgamu(i)/hpbl(i)+(ux(i,k+1)-ux(i,k))/dza(i,k+1))*(ux(i,k+1)-ux(i,k))/dza(i,k+1) &amp;<a name='1308'>
        + (-hgamv(i)/hpbl(i)+(vx(i,k+1)-vx(i,k))/dza(i,k+1))*(vx(i,k+1)-vx(i,k))/dza(i,k+1))<a name='1309'>
         buoy_ysu(i,k)=xkzh(i,k)*g*(1.0/thx(i,k))*(-hgamt(i)/hpbl(i)+(thx(i,k+1)-thx(i,k))/dza(i,k+1))<a name='1310'>
<a name='1311'>
       zk = karman*zq(i,k+1)<a name='1312'>
 <font color=#447700>!over pbl<a name='1313'></font>
       if (k.ge.kpbl(i)) then<a name='1314'>
        rlamdz = min(max(0.1*dza(i,k+1),rlam),300.)<a name='1315'>
        rlamdz = min(dza(i,k+1),rlamdz)<a name='1316'>
       else<a name='1317'>
 <font color=#447700>!in pbl<a name='1318'></font>
        rlamdz = 150.0<a name='1319'>
       endif<a name='1320'>
       el_ysu(i,k) = zk*rlamdz/(rlamdz+zk)<a name='1321'>
       tke_ysu(i,k)=16.6*el_ysu(i,k)*(shear_ysu(i,k)-buoy_ysu(i,k))<a name='1322'>
 <font color=#447700>!q2 when q3 positive<a name='1323'></font>
       if(tke_ysu(i,k).le.0) then<a name='1324'>
        tke_ysu(i,k)=0.0<a name='1325'>
       else<a name='1326'>
        tke_ysu(i,k)=(tke_ysu(i,k))**0.66<a name='1327'>
       endif<a name='1328'>
      enddo<a name='1329'>
 <font color=#447700>!Hybrid pblh of MYNN<a name='1330'></font>
 <font color=#447700>!tke is q2<a name='1331'></font>
      CALL <A href='../../html_code/phys/module_bl_ysu.F.html#GET_PBLH'>GET_PBLH</A><A href='../../html_code/phys/module_bl_ysu.F.html#YSU2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_PBLH_3">(KTS,KTE,pblh_ysu(i),thvx(i,kts:kte),&amp;<a name='1332'>
      &amp;    tke_ysu(i,kts:kte),zq(i,kts:kte+1),dzq(i,kts:kte),xland(i))<a name='1333'>
<a name='1334'>
<font color=#447700>!--- end of paj tke<a name='1335'></font>
<font color=#447700>! compute vconv<a name='1336'></font>
<font color=#447700>!      Use Beljaars over land<a name='1337'></font>
        if (xland(i).lt.1.5) then<a name='1338'>
        fluxc = max(sflux(i),0.0)<a name='1339'>
        vconvc=1.<a name='1340'>
        VCONV = vconvc*(g/thvx(i,1)*pblh_ysu(i)*fluxc)**.33<a name='1341'>
        else<a name='1342'>
<font color=#447700>! for water there is no topo effect so vconv not needed<a name='1343'></font>
        VCONV = 0.<a name='1344'>
        endif<a name='1345'>
        vconvfx(i) = vconv<a name='1346'>
<font color=#447700>!raquel<a name='1347'></font>
<font color=#447700>!ctopo stability correction<a name='1348'></font>
      fric(i,1)=ust(i)**2/wspd1(i)*rhox(i)*g/del(i,1)*dt2         &amp;<a name='1349'>
        *(wspd1(i)/wspd(i))**2<a name='1350'>
      if(present(ctopo)) then<a name='1351'>
        vconvnew=0.9*vconvfx(i)+1.5*(max((pblh_ysu(i)-500)/1000.0,0.0))<a name='1352'>
        vconvlim = min(vconvnew,1.0)<a name='1353'>
        ad(i,1) = 1.+fric(i,1)*vconvlim+ctopo(i)*fric(i,1)*(1-vconvlim)<a name='1354'>
      else<a name='1355'>
       ad(i,1) = 1.+fric(i,1)<a name='1356'>
      endif<a name='1357'>
     f1(i,1) = ux(i,1)+uox(i)*ust(i)**2*rhox(i)*g/del(i,1)*dt2/wspd1(i)*(wspd1(i)/wspd(i))**2<a name='1358'>
     f2(i,1) = vx(i,1)+vox(i)*ust(i)**2*rhox(i)*g/del(i,1)*dt2/wspd1(i)*(wspd1(i)/wspd(i))**2<a name='1359'>
   enddo<a name='1360'>
<font color=#447700>!<a name='1361'></font>
   do k = kts,kte-1<a name='1362'>
     do i = its,ite<a name='1363'>
       dtodsd = dt2/del(i,k)<a name='1364'>
       dtodsu = dt2/del(i,k+1)<a name='1365'>
       dsig   = p2d(i,k)-p2d(i,k+1)<a name='1366'>
       rdz    = 1./dza(i,k+1)<a name='1367'>
       tem1   = dsig*xkzm(i,k)*rdz<a name='1368'>
       if(pblflg(i).and.k.lt.kpbl(i))then<a name='1369'>
         dsdzu     = tem1*(-hgamu(i)/hpbl(i)-ufxpbl(i)*zfacent(i,k)/xkzm(i,k))<a name='1370'>
         dsdzv     = tem1*(-hgamv(i)/hpbl(i)-vfxpbl(i)*zfacent(i,k)/xkzm(i,k))<a name='1371'>
         f1(i,k)   = f1(i,k)+dtodsd*dsdzu<a name='1372'>
         f1(i,k+1) = ux(i,k+1)-dtodsu*dsdzu<a name='1373'>
         f2(i,k)   = f2(i,k)+dtodsd*dsdzv<a name='1374'>
         f2(i,k+1) = vx(i,k+1)-dtodsu*dsdzv<a name='1375'>
       elseif(pblflg(i).and.k.ge.kpbl(i).and.entfac(i,k).lt.4.6) then<a name='1376'>
         xkzm(i,k) = prpbl(i)*xkzh(i,k)<a name='1377'>
         xkzm(i,k) = sqrt(xkzm(i,k)*xkzml(i,k))<a name='1378'>
         xkzm(i,k) = max(xkzm(i,k),xkzom(i,k))<a name='1379'>
         xkzm(i,k) = min(xkzm(i,k),xkzmax)<a name='1380'>
         f1(i,k+1) = ux(i,k+1)<a name='1381'>
         f2(i,k+1) = vx(i,k+1)<a name='1382'>
       else<a name='1383'>
         f1(i,k+1) = ux(i,k+1)<a name='1384'>
         f2(i,k+1) = vx(i,k+1)<a name='1385'>
       endif<a name='1386'>
       tem1   = dsig*xkzm(i,k)*rdz<a name='1387'>
       dsdz2     = tem1*rdz<a name='1388'>
       au(i,k)   = -dtodsd*dsdz2<a name='1389'>
       al(i,k)   = -dtodsu*dsdz2<a name='1390'>
       ad(i,k)   = ad(i,k)-au(i,k)<a name='1391'>
       ad(i,k+1) = 1.-al(i,k)<a name='1392'>
     enddo<a name='1393'>
   enddo<a name='1394'>
<font color=#447700>!<a name='1395'></font>
<font color=#447700>! copies here to avoid duplicate input args for tridin<a name='1396'></font>
<font color=#447700>!<a name='1397'></font>
   do k = kts,kte<a name='1398'>
     do i = its,ite<a name='1399'>
       cu(i,k) = au(i,k)<a name='1400'>
       r1(i,k) = f1(i,k)<a name='1401'>
       r2(i,k) = f2(i,k)<a name='1402'>
     enddo<a name='1403'>
   enddo<a name='1404'>
<font color=#447700>!<a name='1405'></font>
<font color=#447700>!     solve tridiagonal problem for momentum<a name='1406'></font>
<font color=#447700>!<a name='1407'></font>
   call <A href='../../html_code/phys/module_bl_ysu.F.html#TRIDI1N'>tridi1n</A><A href='../../html_code/phys/module_bl_ysu.F.html#YSU2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDI1N_2">(al,ad,cu,r1,r2,au,f1,f2,its,ite,kts,kte,1)<a name='1408'>
<font color=#447700>!<a name='1409'></font>
<font color=#447700>!     recover tendencies of momentum<a name='1410'></font>
<font color=#447700>!<a name='1411'></font>
   do k = kte,kts,-1<a name='1412'>
     do i = its,ite<a name='1413'>
       utend = (f1(i,k)-ux(i,k))*rdt<a name='1414'>
       vtend = (f2(i,k)-vx(i,k))*rdt<a name='1415'>
       utnp(i,k) = utnp(i,k)+utend<a name='1416'>
       vtnp(i,k) = vtnp(i,k)+vtend<a name='1417'>
       dusfc(i) = dusfc(i) + utend*conwrc*del(i,k)<a name='1418'>
       dvsfc(i) = dvsfc(i) + vtend*conwrc*del(i,k)<a name='1419'>
     enddo<a name='1420'>
   enddo<a name='1421'>
<font color=#447700>!<a name='1422'></font>
<font color=#447700>! paj: ctopo2=1 if topo_wind=0 (default)<a name='1423'></font>
<font color=#447700>!<a name='1424'></font>
   do i = its,ite<a name='1425'>
     if(present(ctopo).and.present(ctopo2)) then <font color=#447700>! mchen for NMM<a name='1426'></font>
       u10(i) = ctopo2(i)*u10(i)+(1-ctopo2(i))*ux(i,1)<a name='1427'>
       v10(i) = ctopo2(i)*v10(i)+(1-ctopo2(i))*vx(i,1)<a name='1428'>
     endif <font color=#447700>!mchen<a name='1429'></font>
   enddo<a name='1430'>
<font color=#447700>!<a name='1431'></font>
<font color=#447700>!---- end of vertical diffusion<a name='1432'></font>
<font color=#447700>!<a name='1433'></font>
   do i = its,ite<a name='1434'>
     kpbl1d(i) = kpbl(i)<a name='1435'>
   enddo<a name='1436'>
<font color=#447700>!<a name='1437'></font>
<font color=#447700>!<a name='1438'></font>
   end subroutine ysu2d<a name='1439'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1440'></font>
<font color=#447700>!<a name='1441'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1442'></font>
<A NAME='TRIDI1N'><A href='../../html_code/phys/module_bl_ysu.F.html#TRIDI1N' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1443'>
   <font color=#993300>subroutine </font><font color=#cc0000>tridi1n</font>(cl,cm,cu,r1,r2,au,f1,f2,its,ite,kts,kte,nt) <A href='../../call_to/TRIDI1N.html' TARGET='index'>2</A><a name='1444'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1445'></font>
   implicit none<a name='1446'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1447'></font>
<font color=#447700>!<a name='1448'></font>
   integer, intent(in )      ::     its,ite, kts,kte, nt<a name='1449'>
<font color=#447700>!<a name='1450'></font>
   real, dimension( its:ite, kts+1:kte+1 )                                   , &amp;<a name='1451'>
         intent(in   )  ::                                                 cl<a name='1452'>
<font color=#447700>!<a name='1453'></font>
   real, dimension( its:ite, kts:kte )                                       , &amp;<a name='1454'>
         intent(in   )  ::                                                 cm, &amp;<a name='1455'>
                                                                           r1<a name='1456'>
   real, dimension( its:ite, kts:kte,nt )                                    , &amp;<a name='1457'>
         intent(in   )  ::                                                 r2<a name='1458'>
<font color=#447700>!<a name='1459'></font>
   real, dimension( its:ite, kts:kte )                                       , &amp;<a name='1460'>
         intent(inout)  ::                                                 au, &amp;<a name='1461'>
                                                                           cu, &amp;<a name='1462'>
                                                                           f1<a name='1463'>
   real, dimension( its:ite, kts:kte,nt )                                    , &amp;<a name='1464'>
         intent(inout)  ::                                                 f2<a name='1465'>
<font color=#447700>!<a name='1466'></font>
   real    :: fk<a name='1467'>
   integer :: i,k,l,n,it<a name='1468'>
<font color=#447700>!<a name='1469'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1470'></font>
<font color=#447700>!<a name='1471'></font>
   l = ite<a name='1472'>
   n = kte<a name='1473'>
<font color=#447700>!<a name='1474'></font>
   do i = its,l<a name='1475'>
     fk = 1./cm(i,1)<a name='1476'>
     au(i,1) = fk*cu(i,1)<a name='1477'>
     f1(i,1) = fk*r1(i,1)<a name='1478'>
   enddo<a name='1479'>
<font color=#447700>!<a name='1480'></font>
   do it = 1,nt<a name='1481'>
     do i = its,l<a name='1482'>
       fk = 1./cm(i,1)<a name='1483'>
       f2(i,1,it) = fk*r2(i,1,it)<a name='1484'>
     enddo<a name='1485'>
   enddo<a name='1486'>
<font color=#447700>!<a name='1487'></font>
   do k = kts+1,n-1<a name='1488'>
     do i = its,l<a name='1489'>
       fk = 1./(cm(i,k)-cl(i,k)*au(i,k-1))<a name='1490'>
       au(i,k) = fk*cu(i,k)<a name='1491'>
       f1(i,k) = fk*(r1(i,k)-cl(i,k)*f1(i,k-1))<a name='1492'>
     enddo<a name='1493'>
   enddo<a name='1494'>
<font color=#447700>!<a name='1495'></font>
   do it = 1,nt<a name='1496'>
     do k = kts+1,n-1<a name='1497'>
       do i = its,l<a name='1498'>
         fk = 1./(cm(i,k)-cl(i,k)*au(i,k-1))<a name='1499'>
         f2(i,k,it) = fk*(r2(i,k,it)-cl(i,k)*f2(i,k-1,it))<a name='1500'>
       enddo<a name='1501'>
     enddo<a name='1502'>
   enddo<a name='1503'>
<font color=#447700>!<a name='1504'></font>
   do i = its,l<a name='1505'>
     fk = 1./(cm(i,n)-cl(i,n)*au(i,n-1))<a name='1506'>
     f1(i,n) = fk*(r1(i,n)-cl(i,n)*f1(i,n-1))<a name='1507'>
   enddo<a name='1508'>
<font color=#447700>!<a name='1509'></font>
   do it = 1,nt<a name='1510'>
     do i = its,l<a name='1511'>
       fk = 1./(cm(i,n)-cl(i,n)*au(i,n-1))<a name='1512'>
       f2(i,n,it) = fk*(r2(i,n,it)-cl(i,n)*f2(i,n-1,it))<a name='1513'>
     enddo<a name='1514'>
   enddo<a name='1515'>
<font color=#447700>!<a name='1516'></font>
   do k = n-1,kts,-1<a name='1517'>
     do i = its,l<a name='1518'>
       f1(i,k) = f1(i,k)-au(i,k)*f1(i,k+1)<a name='1519'>
     enddo<a name='1520'>
   enddo<a name='1521'>
<font color=#447700>!<a name='1522'></font>
   do it = 1,nt<a name='1523'>
     do k = n-1,kts,-1<a name='1524'>
       do i = its,l<a name='1525'>
         f2(i,k,it) = f2(i,k,it)-au(i,k)*f2(i,k+1,it)<a name='1526'>
       enddo<a name='1527'>
     enddo<a name='1528'>
   enddo<a name='1529'>
<font color=#447700>!<a name='1530'></font>
   end subroutine tridi1n<a name='1531'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1532'></font>
<font color=#447700>!<a name='1533'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1534'></font>
<A NAME='TRIDIN_YSU'><A href='../../html_code/phys/module_bl_ysu.F.html#TRIDIN_YSU' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1535'>
   <font color=#993300>subroutine </font><font color=#cc0000>tridin_ysu</font>(cl,cm,cu,r2,au,f2,its,ite,kts,kte,nt) <A href='../../call_to/TRIDIN_YSU.html' TARGET='index'>4</A><a name='1536'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1537'></font>
   implicit none<a name='1538'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1539'></font>
<font color=#447700>!<a name='1540'></font>
   integer, intent(in )      ::     its,ite, kts,kte, nt<a name='1541'>
<font color=#447700>!<a name='1542'></font>
   real, dimension( its:ite, kts+1:kte+1 )                                   , &amp;<a name='1543'>
         intent(in   )  ::                                                 cl<a name='1544'>
<font color=#447700>!<a name='1545'></font>
   real, dimension( its:ite, kts:kte )                                       , &amp;<a name='1546'>
         intent(in   )  ::                                                 cm<a name='1547'>
   real, dimension( its:ite, kts:kte,nt )                                    , &amp;<a name='1548'>
         intent(in   )  ::                                                 r2<a name='1549'>
<font color=#447700>!<a name='1550'></font>
   real, dimension( its:ite, kts:kte )                                       , &amp;<a name='1551'>
         intent(inout)  ::                                                 au, &amp;<a name='1552'>
                                                                           cu<a name='1553'>
   real, dimension( its:ite, kts:kte,nt )                                    , &amp;<a name='1554'>
         intent(inout)  ::                                                 f2<a name='1555'>
<font color=#447700>!<a name='1556'></font>
   real    :: fk<a name='1557'>
   integer :: i,k,l,n,it<a name='1558'>
<font color=#447700>!<a name='1559'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1560'></font>
<font color=#447700>!<a name='1561'></font>
   l = ite<a name='1562'>
   n = kte<a name='1563'>
<font color=#447700>!<a name='1564'></font>
   do it = 1,nt<a name='1565'>
     do i = its,l<a name='1566'>
       fk = 1./cm(i,1)<a name='1567'>
       au(i,1) = fk*cu(i,1)<a name='1568'>
       f2(i,1,it) = fk*r2(i,1,it)<a name='1569'>
     enddo<a name='1570'>
   enddo<a name='1571'>
<font color=#447700>!<a name='1572'></font>
   do it = 1,nt<a name='1573'>
     do k = kts+1,n-1<a name='1574'>
       do i = its,l<a name='1575'>
         fk = 1./(cm(i,k)-cl(i,k)*au(i,k-1))<a name='1576'>
         au(i,k) = fk*cu(i,k)<a name='1577'>
         f2(i,k,it) = fk*(r2(i,k,it)-cl(i,k)*f2(i,k-1,it))<a name='1578'>
       enddo<a name='1579'>
     enddo<a name='1580'>
   enddo<a name='1581'>
<font color=#447700>!<a name='1582'></font>
   do it = 1,nt<a name='1583'>
     do i = its,l<a name='1584'>
       fk = 1./(cm(i,n)-cl(i,n)*au(i,n-1))<a name='1585'>
       f2(i,n,it) = fk*(r2(i,n,it)-cl(i,n)*f2(i,n-1,it))<a name='1586'>
     enddo<a name='1587'>
   enddo<a name='1588'>
<font color=#447700>!<a name='1589'></font>
   do it = 1,nt<a name='1590'>
     do k = n-1,kts,-1<a name='1591'>
       do i = its,l<a name='1592'>
         f2(i,k,it) = f2(i,k,it)-au(i,k)*f2(i,k+1,it)<a name='1593'>
       enddo<a name='1594'>
     enddo<a name='1595'>
   enddo<a name='1596'>
<font color=#447700>!<a name='1597'></font>
   end subroutine tridin_ysu<a name='1598'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1599'></font>
<font color=#447700>!<a name='1600'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1601'></font>
<A NAME='YSUINIT'><A href='../../html_code/phys/module_bl_ysu.F.html#YSUINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1602'>
   <font color=#993300>subroutine </font><font color=#cc0000>ysuinit</font>(rublten,rvblten,rthblten,rqvblten,                       &amp; <A href='../../call_to/YSUINIT.html' TARGET='index'>1</A><a name='1603'>
                      rqcblten,rqiblten,p_qi,p_first_scalar,                   &amp;<a name='1604'>
                      restart, allowed_to_read,                                &amp;<a name='1605'>
                      ids, ide, jds, jde, kds, kde,                            &amp;<a name='1606'>
                      ims, ime, jms, jme, kms, kme,                            &amp;<a name='1607'>
                      its, ite, jts, jte, kts, kte                 )<a name='1608'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1609'></font>
   implicit none<a name='1610'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1611'></font>
<font color=#447700>!<a name='1612'></font>
   logical , intent(in)          :: restart, allowed_to_read<a name='1613'>
   integer , intent(in)          ::  ids, ide, jds, jde, kds, kde,             &amp;<a name='1614'>
                                     ims, ime, jms, jme, kms, kme,             &amp;<a name='1615'>
                                     its, ite, jts, jte, kts, kte<a name='1616'>
   integer , intent(in)          ::  p_qi,p_first_scalar<a name='1617'>
   real , dimension( ims:ime , kms:kme , jms:jme ), intent(out) ::             &amp;<a name='1618'>
                                                                      rublten, &amp;<a name='1619'>
                                                                      rvblten, &amp;<a name='1620'>
                                                                     rthblten, &amp;<a name='1621'>
                                                                     rqvblten, &amp;<a name='1622'>
                                                                     rqcblten, &amp;<a name='1623'>
                                                                     rqiblten<a name='1624'>
   integer :: i, j, k, itf, jtf, ktf<a name='1625'>
<font color=#447700>!<a name='1626'></font>
   jtf = min0(jte,jde-1)<a name='1627'>
   ktf = min0(kte,kde-1)<a name='1628'>
   itf = min0(ite,ide-1)<a name='1629'>
<font color=#447700>!<a name='1630'></font>
   if(.not.restart)then<a name='1631'>
     do j = jts,jtf<a name='1632'>
       do k = kts,ktf<a name='1633'>
         do i = its,itf<a name='1634'>
            rublten(i,k,j) = 0.<a name='1635'>
            rvblten(i,k,j) = 0.<a name='1636'>
            rthblten(i,k,j) = 0.<a name='1637'>
            rqvblten(i,k,j) = 0.<a name='1638'>
            rqcblten(i,k,j) = 0.<a name='1639'>
         enddo<a name='1640'>
       enddo<a name='1641'>
     enddo<a name='1642'>
   endif<a name='1643'>
<font color=#447700>!<a name='1644'></font>
   if (p_qi .ge. p_first_scalar .and. .not.restart) then<a name='1645'>
     do j = jts,jtf<a name='1646'>
       do k = kts,ktf<a name='1647'>
         do i = its,itf<a name='1648'>
           rqiblten(i,k,j) = 0.<a name='1649'>
         enddo<a name='1650'>
       enddo<a name='1651'>
     enddo<a name='1652'>
   endif<a name='1653'>
<font color=#447700>!<a name='1654'></font>
   end subroutine ysuinit<a name='1655'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1656'></font>
<font color=#447700>! ==================================================================<a name='1657'></font>
<a name='1658'>
<A NAME='GET_PBLH'><A href='../../html_code/phys/module_bl_ysu.F.html#GET_PBLH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1659'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>GET_PBLH</font>(KTS,KTE,zi,thetav1D,qke1D,zw1D,dz1D,landsea) <A href='../../call_to/GET_PBLH.html' TARGET='index'>3</A><a name='1660'>
<font color=#447700>! Copied from MYNN PBL<a name='1661'></font>
<a name='1662'>
      <font color=#447700>!---------------------------------------------------------------<a name='1663'></font>
      <font color=#447700>!             NOTES ON THE PBLH FORMULATION<a name='1664'></font>
      <font color=#447700>!<a name='1665'></font>
      <font color=#447700>!The 1.5-theta-increase method defines PBL heights as the level at<a name='1666'></font>
      <font color=#447700>!which the potential temperature first exceeds the minimum potential<a name='1667'></font>
      <font color=#447700>!temperature within the boundary layer by 1.5 K. When applied to<a name='1668'></font>
      <font color=#447700>!observed temperatures, this method has been shown to produce PBL-<a name='1669'></font>
      <font color=#447700>!height estimates that are unbiased relative to profiler-based<a name='1670'></font>
      <font color=#447700>!estimates (Nielsen-Gammon et al. 2008). However, their study did not<a name='1671'></font>
      <font color=#447700>!include LLJs. Banta and Pichugina (2008) show that a TKE-based<a name='1672'></font>
      <font color=#447700>!threshold is a good estimate of the PBL height in LLJs. Therefore,<a name='1673'></font>
      <font color=#447700>!a hybrid definition is implemented that uses both methods, weighting<a name='1674'></font>
      <font color=#447700>!the TKE-method more during stable conditions (PBLH &lt; 400 m).<a name='1675'></font>
      <font color=#447700>!A variable tke threshold (TKEeps) is used since no hard-wired<a name='1676'></font>
      <font color=#447700>!value could be found to work best in all conditions.<a name='1677'></font>
      <font color=#447700>!---------------------------------------------------------------<a name='1678'></font>
<a name='1679'>
      INTEGER,INTENT(IN) :: KTS,KTE<a name='1680'>
      REAL, INTENT(OUT) :: zi<a name='1681'>
      REAL, INTENT(IN) :: landsea<a name='1682'>
      REAL, DIMENSION(KTS:KTE), INTENT(IN) :: thetav1D, qke1D, dz1D<a name='1683'>
      REAL, DIMENSION(KTS:KTE+1), INTENT(IN) :: zw1D<a name='1684'>
      <font color=#447700>!LOCAL VARS<a name='1685'></font>
      REAL ::  PBLH_TKE,qtke,qtkem1,wt,maxqke,TKEeps,minthv<a name='1686'>
      REAL :: delt_thv   <font color=#447700>!delta theta-v; dependent on land/sea point<a name='1687'></font>
      REAL, PARAMETER :: sbl_lim  = 200. <font color=#447700>!Theta-v PBL lower limit of trust (m).<a name='1688'></font>
      REAL, PARAMETER :: sbl_damp = 400. <font color=#447700>!Damping range for averaging with TKE-based PBLH (m).<a name='1689'></font>
      INTEGER :: I,J,K,kthv,ktke<a name='1690'>
<a name='1691'>
      <font color=#447700>!FIND MAX TKE AND MIN THETAV IN THE LOWEST 500 M<a name='1692'></font>
      k = kts+1<a name='1693'>
      kthv = 1<a name='1694'>
      ktke = 1<a name='1695'>
      maxqke = 0.<a name='1696'>
      minthv = 9.E9<a name='1697'>
<a name='1698'>
      DO WHILE (zw1D(k) .LE. 500.)<a name='1699'>
        qtke  =MAX(Qke1D(k),0.)   <font color=#447700>! maximum QKE<a name='1700'></font>
         IF (maxqke &lt; qtke) then<a name='1701'>
            maxqke = qtke<a name='1702'>
            ktke = k<a name='1703'>
         ENDIF<a name='1704'>
         IF (minthv &gt; thetav1D(k)) then<a name='1705'>
             minthv = thetav1D(k)<a name='1706'>
             kthv = k<a name='1707'>
         ENDIF<a name='1708'>
         k = k+1<a name='1709'>
      ENDDO<a name='1710'>
      <font color=#447700>!TKEeps = maxtke/20. = maxqke/40.<a name='1711'></font>
      TKEeps = maxqke/40.<a name='1712'>
      TKEeps = MAX(TKEeps,0.025)<a name='1713'>
      TKEeps = MIN(TKEeps,0.25)<a name='1714'>
<a name='1715'>
      <font color=#447700>!FIND THETAV-BASED PBLH (BEST FOR DAYTIME).<a name='1716'></font>
      zi=0.<a name='1717'>
      k = kthv+1<a name='1718'>
      IF((landsea-1.5).GE.0)THEN<a name='1719'>
      <font color=#447700>! WATER<a name='1720'></font>
          delt_thv = 0.75<a name='1721'>
      ELSE<a name='1722'>
      <font color=#447700>! LAND<a name='1723'></font>
          delt_thv = 1.5<a name='1724'>
      ENDIF<a name='1725'>
<a name='1726'>
      zi=0.<a name='1727'>
      k = kthv+1<a name='1728'>
      DO WHILE (zi .EQ. 0.)<a name='1729'>
         IF (thetav1D(k) .GE. (minthv + delt_thv))THEN<a name='1730'>
            zi = zw1D(k) - dz1D(k-1)* &amp;<a name='1731'>
              &amp; MIN((thetav1D(k)-(minthv + delt_thv))/MAX(thetav1D(k)-thetav1D(k-1),1E-6),1.0)<a name='1732'>
        ENDIF<a name='1733'>
        k = k+1<a name='1734'>
         IF (k .EQ. kte-1) zi = zw1D(kts+1) <font color=#447700>!EXIT SAFEGUARD<a name='1735'></font>
      ENDDO<a name='1736'>
<a name='1737'>
      <font color=#447700>!print*,"IN GET_PBLH:",thsfc,zi<a name='1738'></font>
      <font color=#447700>!FOR STABLE BOUNDARY LAYERS, USE TKE METHOD TO COMPLEMENT THE<a name='1739'></font>
      <font color=#447700>!THETAV-BASED DEFINITION (WHEN THE THETA-V BASED PBLH IS BELOW ~0.5 KM).<a name='1740'></font>
      <font color=#447700>!THE TANH WEIGHTING FUNCTION WILL MAKE THE TKE-BASED DEFINITION NEGLIGIBLE<a name='1741'></font>
      <font color=#447700>!WHEN THE THETA-V-BASED DEFINITION IS ABOVE ~1 KM.<a name='1742'></font>
      <font color=#447700>!FIND TKE-BASED PBLH (BEST FOR NOCTURNAL/STABLE CONDITIONS).<a name='1743'></font>
<a name='1744'>
      PBLH_TKE=0.<a name='1745'>
      k = ktke+1<a name='1746'>
     DO WHILE (PBLH_TKE .EQ. 0.)<a name='1747'>
        <font color=#447700>!QKE CAN BE NEGATIVE (IF CKmod == 0)... MAKE TKE NON-NEGATIVE.<a name='1748'></font>
         qtke  =MAX(Qke1D(k)/2.,0.)      <font color=#447700>! maximum TKE<a name='1749'></font>
         qtkem1=MAX(Qke1D(k-1)/2.,0.)<a name='1750'>
         IF (qtke .LE. TKEeps) THEN<a name='1751'>
               PBLH_TKE = zw1D(k) - dz1D(k-1)* &amp;<a name='1752'>
               &amp; MIN((TKEeps-qtke)/MAX(qtkem1-qtke, 1E-6), 1.0)<a name='1753'>
             <font color=#447700>!IN CASE OF NEAR ZERO TKE, SET PBLH = LOWEST LEVEL.<a name='1754'></font>
             PBLH_TKE = MAX(PBLH_TKE,zw1D(kts+1))<a name='1755'>
             <font color=#447700>!print *,"PBLH_TKE:",i,j,PBLH_TKE, Qke1D(k)/2., zw1D(kts+1)<a name='1756'></font>
         ENDIF<a name='1757'>
         k = k+1<a name='1758'>
         IF (k .EQ. kte-1) PBLH_TKE = zw1D(kts+1) <font color=#447700>!EXIT SAFEGUARD<a name='1759'></font>
      ENDDO<a name='1760'>
<a name='1761'>
    <font color=#447700>!BLEND THE TWO PBLH TYPES HERE:<a name='1762'></font>
<a name='1763'>
      wt=.5*TANH((zi - sbl_lim)/sbl_damp) + .5<a name='1764'>
      zi=PBLH_TKE*(1.-wt) + zi*wt<a name='1765'>
<a name='1766'>
   END SUBROUTINE GET_PBLH<a name='1767'>
<font color=#447700>! ==================================================================<a name='1768'></font>
<a name='1769'>
end module module_bl_ysu<a name='1770'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1771'></font>
</pre></body></html>