<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<A NAME='MODULE_CU_KF'><A href='../../html_code/phys/module_cu_kf.F.html#MODULE_CU_KF' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
<font color=#993300>MODULE </font><font color=#cc0000>module_cu_kf</font> <A href='../../call_to/MODULE_CU_KF.html' TARGET='index'>3</A><a name='6'>
<a name='7'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_cu_kf.F.html#module_cu_kf.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_45"><a name='8'>
<a name='9'>
   REAL    , PARAMETER :: RAD          = 1500.<a name='10'>
<a name='11'>
CONTAINS<a name='12'>
<a name='13'>
<font color=#447700>!-------------------------------------------------------------<a name='14'></font>
<A NAME='KFCPS'><A href='../../html_code/phys/module_cu_kf.F.html#KFCPS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='15'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>KFCPS</font>(                                         &amp; <A href='../../call_to/KFCPS.html' TARGET='index'>1</A>,<A href='../../call_from/KFCPS.html' TARGET='index'>1</A><a name='16'>
               ids,ide, jds,jde, kds,kde                     &amp;<a name='17'>
              ,ims,ime, jms,jme, kms,kme                     &amp;<a name='18'>
              ,its,ite, jts,jte, kts,kte                     &amp;<a name='19'>
              ,DT,KTAU,DX,CUDT,ADAPT_STEP_FLAG               &amp;<a name='20'>
              ,rho                                           &amp;<a name='21'>
              ,RAINCV,PRATEC,NCA                             &amp;<a name='22'>
              ,U,V,TH,T,W,QV,dz8w,Pcps,pi                    &amp;<a name='23'>
              ,W0AVG,XLV0,XLV1,XLS0,XLS1,CP,R,G,EP1          &amp;<a name='24'>
              ,EP2,SVP1,SVP2,SVP3,SVPT0                      &amp;<a name='25'>
              ,STEPCU,CU_ACT_FLAG,warm_rain                  &amp;<a name='26'>
            <font color=#447700>! optional arguments<a name='27'></font>
              ,F_QV    ,F_QC    ,F_QR    ,F_QI    ,F_QS      &amp;<a name='28'>
              ,RQVCUTEN,RQCCUTEN,RQRCUTEN,RQICUTEN,RQSCUTEN  &amp;<a name='29'>
              ,RTHCUTEN                                      &amp;<a name='30'>
<font color=#447700>!kf_edrates<a name='31'></font>
              ,UDR_KF,DDR_KF                                 &amp;<a name='32'>
              ,UER_KF,DER_KF                                 &amp;<a name='33'>
              ,TIMEC_KF,KF_EDRATES                           &amp;<a name='34'>
                                                             )<a name='35'>
<font color=#447700>!-------------------------------------------------------------<a name='36'></font>
   IMPLICIT NONE<a name='37'>
<font color=#447700>!-------------------------------------------------------------<a name='38'></font>
   INTEGER,      INTENT(IN   ) ::                            &amp;<a name='39'>
                                  ids,ide, jds,jde, kds,kde, &amp; <a name='40'>
                                  ims,ime, jms,jme, kms,kme, &amp; <a name='41'>
                                  its,ite, jts,jte, kts,kte<a name='42'>
<a name='43'>
   INTEGER,      INTENT(IN   ) :: STEPCU<a name='44'>
   LOGICAL,      INTENT(IN   ) :: warm_rain<a name='45'>
<a name='46'>
   REAL,         INTENT(IN   ) :: XLV0,XLV1,XLS0,XLS1<a name='47'>
   REAL,         INTENT(IN   ) :: CP,R,G,EP1,EP2<a name='48'>
   REAL,         INTENT(IN   ) :: SVP1,SVP2,SVP3,SVPT0<a name='49'>
<a name='50'>
   INTEGER,      INTENT(IN   ) :: KTAU                   <a name='51'>
<a name='52'>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         , &amp;<a name='53'>
          INTENT(IN   ) ::                                   &amp;<a name='54'>
                                                          U, &amp;<a name='55'>
                                                          V, &amp;<a name='56'>
                                                          W, &amp;<a name='57'>
                                                         TH, &amp;<a name='58'>
                                                         QV, &amp;<a name='59'>
                                                          T, &amp;<a name='60'>
                                                       dz8w, &amp;<a name='61'>
                                                       Pcps, &amp;<a name='62'>
                                                        rho, &amp;<a name='63'>
                                                         pi<a name='64'>
<font color=#447700>!<a name='65'></font>
   REAL,  INTENT(IN   ) :: DT, DX<a name='66'>
   REAL,  INTENT(IN   ) :: CUDT<a name='67'>
   LOGICAL,OPTIONAL, INTENT(IN  ) :: ADAPT_STEP_FLAG<a name='68'>
<a name='69'>
   REAL, DIMENSION( ims:ime , jms:jme ),                     &amp;<a name='70'>
          INTENT(INOUT) ::                                   &amp;<a name='71'>
                                                     RAINCV  &amp;<a name='72'>
                                                    ,PRATEC  &amp;<a name='73'>
                                                    ,   NCA<a name='74'>
<a name='75'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),           &amp;<a name='76'>
          INTENT(INOUT) ::                                   &amp;<a name='77'>
                                                      W0AVG<a name='78'>
<a name='79'>
   LOGICAL, DIMENSION( ims:ime , jms:jme ),                  &amp;<a name='80'>
          INTENT(INOUT) :: CU_ACT_FLAG<a name='81'>
<a name='82'>
<font color=#447700>!<a name='83'></font>
<font color=#447700>! Optional arguments<a name='84'></font>
<font color=#447700>!<a name='85'></font>
<a name='86'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),           &amp;<a name='87'>
         OPTIONAL,                                           &amp;<a name='88'>
         INTENT(INOUT) ::                                    &amp;<a name='89'>
                                                   RTHCUTEN  &amp;<a name='90'>
                                                  ,RQVCUTEN  &amp;<a name='91'>
                                                  ,RQCCUTEN  &amp;<a name='92'>
                                                  ,RQRCUTEN  &amp;<a name='93'>
                                                  ,RQICUTEN  &amp;<a name='94'>
                                                  ,RQSCUTEN<a name='95'>
<a name='96'>
<font color=#447700>!<a name='97'></font>
<font color=#447700>! Flags relating to the optional tendency arrays declared above<a name='98'></font>
<font color=#447700>! Models that carry the optional tendencies will provdide the<a name='99'></font>
<font color=#447700>! optional arguments at compile time; these flags all the model<a name='100'></font>
<font color=#447700>! to determine at run-time whether a particular tracer is in <a name='101'></font>
<font color=#447700>! use or not. <a name='102'></font>
<font color=#447700>!<a name='103'></font>
<a name='104'>
   LOGICAL, OPTIONAL ::                                      &amp;<a name='105'>
                                                   F_QV      &amp;<a name='106'>
                                                  ,F_QC      &amp;<a name='107'>
                                                  ,F_QR      &amp;<a name='108'>
                                                  ,F_QI      &amp;<a name='109'>
                                                  ,F_QS<a name='110'>
<a name='111'>
<font color=#447700>!kf_edrates<a name='112'></font>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         , &amp;<a name='113'>
          INTENT(INOUT) ::                         &amp;<a name='114'>
                                                     UDR_KF, &amp;<a name='115'>
                                                     DDR_KF, &amp;<a name='116'>
                                                     UER_KF, &amp;<a name='117'>
                                                     DER_KF<a name='118'>
<a name='119'>
   REAL,  DIMENSION( ims:ime , jms:jme )                   , &amp;<a name='120'>
          INTENT(INOUT) ::                         &amp;<a name='121'>
                                                   TIMEC_KF<a name='122'>
<a name='123'>
   INTEGER, INTENT(IN) ::              KF_EDRATES<a name='124'>
<a name='125'>
<font color=#447700>! LOCAL VARS<a name='126'></font>
<a name='127'>
   REAL, DIMENSION( kts:kte ) ::                             &amp;<a name='128'>
                                                        U1D, &amp;<a name='129'>
                                                        V1D, &amp;<a name='130'>
                                                        T1D, &amp;<a name='131'>
                                                       DZ1D, &amp;<a name='132'>
                                                       QV1D, &amp;<a name='133'>
                                                        P1D, &amp;<a name='134'>
                                                      RHO1D, &amp;<a name='135'>
                                                    W0AVG1D<a name='136'>
<a name='137'>
   REAL, DIMENSION( kts:kte )::                              &amp;<a name='138'>
                                                       DQDT, &amp;<a name='139'>
                                                      DQIDT, &amp;<a name='140'>
                                                      DQCDT, &amp;<a name='141'>
                                                      DQRDT, &amp;<a name='142'>
                                                      DQSDT, &amp;<a name='143'>
                                                       DTDT<a name='144'>
<a name='145'>
   REAL    ::         TST,tv,PRS,RHOE,W0,SCR1,DXSQ,tmp<a name='146'>
<a name='147'>
   INTEGER :: i,j,k,NTST,ICLDCK<a name='148'>
<a name='149'>
   LOGICAL :: qi_flag , qs_flag<a name='150'>
<font color=#447700>! adjustable time step changes<a name='151'></font>
   REAL    :: lastdt = -1.0<a name='152'>
   REAL    :: W0AVGfctr, W0fctr, W0den<a name='153'>
<a name='154'>
<font color=#447700>!----------------------------------------------------------------------<a name='155'></font>
<a name='156'>
<font color=#447700>!--- CALL CUMULUS PARAMETERIZATION                                        <a name='157'></font>
<font color=#447700>!                                                                        <a name='158'></font>
<font color=#447700>!...TST IS THE NUMBER OF TIME STEPS IN 10 MINUTES...W0AVG IS CLOSE TO A    <a name='159'></font>
<font color=#447700>!...RUNNING MEAN VERTICAL VELOCITY...NOTE THAT IF YOU CHANGE TST, IT WIL  <a name='160'></font>
<font color=#447700>!...CHANGE THE FREQUENCY OF THE CONVECTIVE INTITIATION CHECK (SEE BELOW) <a name='161'></font>
<font color=#447700>!...NOTE THAT THE ORDERING OF VERTICAL LAYERS MUST BE REVERSED FOR W0AVG<a name='162'></font>
<font color=#447700>!...BECAUSE THE ORDERING IS REVERSED IN KFPARA...                         <a name='163'></font>
<font color=#447700>!                                                                           <a name='164'></font>
   DXSQ=DX*DX<a name='165'>
   qi_flag = .FALSE.<a name='166'>
   qs_flag = .FALSE.<a name='167'>
   IF ( PRESENT( F_QI ) ) qi_flag = f_qi<a name='168'>
   IF ( PRESENT( F_QS ) ) qs_flag = f_qs<a name='169'>
<a name='170'>
<font color=#447700>!----------------------<a name='171'></font>
   NTST=STEPCU<a name='172'>
   TST=float(NTST*2)                                                         <a name='173'>
<font color=#447700>!----------------------<a name='174'></font>
<font color=#447700>!  NTST=NINT(1200./(DT*2.))                                                 <a name='175'></font>
<font color=#447700>!  TST=float(NTST)                                                         <a name='176'></font>
<font color=#447700>!  NTST=NINT(0.5*TST)                                                   <a name='177'></font>
<font color=#447700>!  NTST=MAX0(NTST,1)                                                   <a name='178'></font>
<font color=#447700>!----------------------<a name='179'></font>
<font color=#447700>!  ICLDCK=MOD(KTAU,NTST)                                              <a name='180'></font>
<font color=#447700>!----------------------<a name='181'></font>
<font color=#447700>!  write(0,*) 'DT = ',DT,'  KTAU = ',KTAU,' DX = ',DX<a name='182'></font>
<font color=#447700>!  write(0,*) 'CUDT = ',CUDT<a name='183'></font>
<font color=#447700>!  write(0,*) 'ADAPT_STEP_FLAG = ',ADAPT_STEP_FLAG,' IDS = ',IDS<a name='184'></font>
<font color=#447700>!  write(0,*) 'STEPCU = ',STEPCU,' warm_rain = ',warm_rain<a name='185'></font>
<font color=#447700>!  write(0,*) 'F_QV = ',F_QV,' F_QC = ',F_QV<a name='186'></font>
<font color=#447700>!  write(0,*) 'F_QI = ',F_QI,' F_QS = ',F_QS<a name='187'></font>
<font color=#447700>!  write(0,*) 'F_QR = ',F_QR<a name='188'></font>
<font color=#447700>!  stop<a name='189'></font>
   if (lastdt &lt; 0) then<a name='190'>
      lastdt = dt<a name='191'>
   endif<a name='192'>
<a name='193'>
   if (ADAPT_STEP_FLAG) then<a name='194'>
      W0AVGfctr = 2 * MAX(CUDT*60,dt) - dt<a name='195'>
      W0fctr = dt<a name='196'>
      W0den = 2 * MAX(CUDT*60,dt)<a name='197'>
   else<a name='198'>
      W0AVGfctr = (TST-1.)<a name='199'>
      W0fctr = 1.<a name='200'>
      W0den = TST<a name='201'>
   endif<a name='202'>
<a name='203'>
   DO J = jts,jte  <a name='204'>
      DO K=kts,kte<a name='205'>
         DO I= its,ite<a name='206'>
<font color=#447700>!           SCR1=-5.0E-4*G*rho(I,K,J)*(w(I,K,J)+w(I,K+1,J))<a name='207'></font>
<font color=#447700>!           TV=T(I,K,J)*(1.+EP1*QV(I,K,J))<a name='208'></font>
<font color=#447700>!           RHOE=Pcps(I,K,J)/(R*TV)<a name='209'></font>
<font color=#447700>!           W0=-101.9368*SCR1/RHOE<a name='210'></font>
            W0=0.5*(w(I,K,J)+w(I,K+1,J))<a name='211'>
<a name='212'>
<font color=#447700>!           Old:<a name='213'></font>
<font color=#447700>!<a name='214'></font>
<font color=#447700>!           W0AVG(I,K,J)=(W0AVG(I,K,J)*(TST-1.)+W0)/TST<a name='215'></font>
<font color=#447700>!           New, to support adaptive time step:<a name='216'></font>
<font color=#447700>!<a name='217'></font>
            W0AVG(I,K,J) = ( W0AVG(I,K,J) * W0AVGfctr + W0 * W0fctr ) / W0den<a name='218'>
<a name='219'>
         ENDDO<a name='220'>
      ENDDO<a name='221'>
   ENDDO<a name='222'>
   lastdt = dt<a name='223'>
<a name='224'>
     DO J = jts,jte  <a name='225'>
     DO I= its,ite<a name='226'>
        CU_ACT_FLAG(i,j) = .true.<a name='227'>
     ENDDO<a name='228'>
     ENDDO<a name='229'>
<a name='230'>
     DO J = jts,jte  <a name='231'>
        DO I=its,ite<a name='232'>
<font color=#447700>! if (i.eq. 110 .and. j .eq. 59 ) then<a name='233'></font>
<font color=#447700>!   write(0,*) 'nca = ',nca(i,j),' CU_ACT_FLAG = ',CU_ACT_FLAG(i,j)<a name='234'></font>
<font color=#447700>!   write(0,*) 'dt = ',dt,' ADAPT_STEP_FLAG = ',ADAPT_STEP_FLAG<a name='235'></font>
<font color=#447700>! endif<a name='236'></font>
<font color=#447700>!        IF ( NINT(NCA(I,J)) .gt. 0 ) then<a name='237'></font>
         IF ( NCA(I,J) .gt. 0.5*DT ) then<a name='238'>
            CU_ACT_FLAG(i,j) = .false. <a name='239'>
         ELSE<a name='240'>
<a name='241'>
            DO k=kts,kte<a name='242'>
               DQDT(k)=0.<a name='243'>
               DQIDT(k)=0.      <a name='244'>
               DQCDT(k)=0.      <a name='245'>
               DQRDT(k)=0.      <a name='246'>
               DQSDT(k)=0.      <a name='247'>
               DTDT(k)=0.<a name='248'>
            ENDDO<a name='249'>
<font color=#447700>!kf_edrates<a name='250'></font>
            IF (KF_EDRATES == 1) THEN<a name='251'>
               DO k=kts,kte<a name='252'>
                  UDR_KF(I,k,J)=0.<a name='253'>
                  DDR_KF(I,k,J)=0.<a name='254'>
                  UER_KF(I,k,J)=0.<a name='255'>
                  DER_KF(I,k,J)=0.<a name='256'>
               ENDDO<a name='257'>
               TIMEC_KF(I,J)=0.<a name='258'>
            ENDIF<a name='259'>
            RAINCV(I,J)=0.<a name='260'>
	    PRATEC(I,J)=0.<a name='261'>
<font color=#447700>!<a name='262'></font>
<font color=#447700>! assign vars from 3D to 1D<a name='263'></font>
<a name='264'>
            DO K=kts,kte<a name='265'>
               U1D(K) =U(I,K,J)<a name='266'>
               V1D(K) =V(I,K,J)<a name='267'>
               T1D(K) =T(I,K,J)<a name='268'>
               RHO1D(K) =rho(I,K,J)<a name='269'>
               QV1D(K)=QV(I,K,J)<a name='270'>
               P1D(K) =Pcps(I,K,J)<a name='271'>
               W0AVG1D(K) =W0AVG(I,K,J)<a name='272'>
               DZ1D(k)=dz8w(I,K,J)<a name='273'>
            ENDDO<a name='274'>
<a name='275'>
<font color=#447700>!<a name='276'></font>
            CALL <A href='../../html_code/phys/module_cu_kf.F.html#KFPARA'>KFPARA</A><A href='../../html_code/phys/module_cu_kf.F.html#KFCPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="KFPARA_1">(I, J,                       &amp;<a name='277'>
                 U1D,V1D,T1D,QV1D,P1D,DZ1D,         &amp;<a name='278'>
                 W0AVG1D,DT,DX,DXSQ,RHO1D,          &amp;<a name='279'>
                 XLV0,XLV1,XLS0,XLS1,CP,R,G,        &amp;<a name='280'>
                 EP2,SVP1,SVP2,SVP3,SVPT0,          &amp;<a name='281'>
                 DQDT,DQIDT,DQCDT,DQRDT,DQSDT,DTDT, &amp;<a name='282'>
                 RAINCV,PRATEC,NCA,                 &amp;<a name='283'>
                 warm_rain,qi_flag,qs_flag,         &amp;<a name='284'>
                 ids,ide, jds,jde, kds,kde,         &amp;        <a name='285'>
                 ims,ime, jms,jme, kms,kme,         &amp;<a name='286'>
                 its,ite, jts,jte, kts,kte,         &amp;<a name='287'>
<font color=#447700>!kf_edrates<a name='288'></font>
                 UDR_KF,DDR_KF,                     &amp;<a name='289'>
                 UER_KF,DER_KF,                     &amp;<a name='290'>
                 TIMEC_KF,KF_EDRATES                )<a name='291'>
 <a name='292'>
            IF ( PRESENT( RTHCUTEN ) .AND. PRESENT( RQVCUTEN ) ) THEN<a name='293'>
              DO K=kts,kte<a name='294'>
                 RTHCUTEN(I,K,J)=DTDT(K)/pi(I,K,J)<a name='295'>
                 RQVCUTEN(I,K,J)=DQDT(K)<a name='296'>
              ENDDO<a name='297'>
            ENDIF<a name='298'>
<a name='299'>
            IF( PRESENT(RQRCUTEN) .AND. PRESENT(RQCCUTEN) .AND. &amp;<a name='300'>
                PRESENT(F_QR)                                    ) THEN<a name='301'>
              IF ( F_QR            ) THEN<a name='302'>
                 DO K=kts,kte<a name='303'>
                    RQRCUTEN(I,K,J)=DQRDT(K)<a name='304'>
                    RQCCUTEN(I,K,J)=DQCDT(K)<a name='305'>
                 ENDDO<a name='306'>
               ELSE<a name='307'>
<font color=#447700>! This is the case for Eta microphysics without 3d rain field<a name='308'></font>
                 DO K=kts,kte<a name='309'>
                    RQRCUTEN(I,K,J)=0.<a name='310'>
                    RQCCUTEN(I,K,J)=DQRDT(K)+DQCDT(K)<a name='311'>
                 ENDDO<a name='312'>
              ENDIF<a name='313'>
            ENDIF<a name='314'>
<a name='315'>
<font color=#447700>!......     QSTEN STORES GRAUPEL TENDENCY IF IT EXISTS, OTHERISE SNOW (V2)     <a name='316'></font>
<a name='317'>
            IF( PRESENT( RQICUTEN ) .AND. qi_flag )THEN<a name='318'>
              DO K=kts,kte<a name='319'>
                 RQICUTEN(I,K,J)=DQIDT(K)<a name='320'>
              ENDDO<a name='321'>
            ENDIF<a name='322'>
<a name='323'>
            IF( PRESENT ( RQSCUTEN ) .AND. qs_flag )THEN<a name='324'>
              DO K=kts,kte<a name='325'>
                 RQSCUTEN(I,K,J)=DQSDT(K)<a name='326'>
              ENDDO<a name='327'>
            ENDIF                                                         <a name='328'>
<font color=#447700>!<a name='329'></font>
         ENDIF                                                         <a name='330'>
       ENDDO<a name='331'>
     ENDDO<a name='332'>
<a name='333'>
   END SUBROUTINE KFCPS<a name='334'>
   <a name='335'>
<font color=#447700>!-----------------------------------------------------------<a name='336'></font>
<A NAME='KFPARA'><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='337'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>KFPARA</font> (I, J,                                &amp; <A href='../../call_to/KFPARA.html' TARGET='index'>1</A>,<A href='../../call_from/KFPARA.html' TARGET='index'>15</A><a name='338'>
                      U0,V0,T0,QV0,P0,DZQ,W0AVG1D,         &amp;<a name='339'>
                      DT,DX,DXSQ,rho,                      &amp;<a name='340'>
                      XLV0,XLV1,XLS0,XLS1,CP,R,G,          &amp;<a name='341'>
                      EP2,SVP1,SVP2,SVP3,SVPT0,            &amp;<a name='342'>
                      DQDT,DQIDT,DQCDT,DQRDT,DQSDT,DTDT,   &amp;<a name='343'>
                      RAINCV,PRATEC,NCA,                   &amp;<a name='344'>
                      warm_rain,qi_flag,qs_flag,           &amp;<a name='345'>
                      ids,ide, jds,jde, kds,kde,           &amp; <a name='346'>
                      ims,ime, jms,jme, kms,kme,           &amp;<a name='347'>
                      its,ite, jts,jte, kts,kte,           &amp;<a name='348'>
<font color=#447700>!kf_edrates<a name='349'></font>
                      UDR_KF,DDR_KF,                       &amp;<a name='350'>
                      UER_KF,DER_KF,                       &amp;<a name='351'>
                      TIMEC_KF,KF_EDRATES                  )<a name='352'>
<font color=#447700>!-----------------------------------------------------------<a name='353'></font>
      IMPLICIT NONE<a name='354'>
<font color=#447700>!-----------------------------------------------------------<a name='355'></font>
      INTEGER, INTENT(IN   ) :: ids,ide, jds,jde, kds,kde, &amp;<a name='356'>
                                ims,ime, jms,jme, kms,kme, &amp;<a name='357'>
                                its,ite, jts,jte, kts,kte, &amp;<a name='358'>
                                I,J<a name='359'>
      LOGICAL, INTENT(IN   ) :: warm_rain<a name='360'>
      LOGICAL           :: qi_flag, qs_flag<a name='361'>
<a name='362'>
<font color=#447700>!<a name='363'></font>
      REAL, DIMENSION( kts:kte ),                          &amp;<a name='364'>
            INTENT(IN   ) ::                           U0, &amp;<a name='365'>
                                                       V0, &amp;<a name='366'>
                                                       T0, &amp;<a name='367'>
                                                      QV0, &amp;<a name='368'>
                                                       P0, &amp;<a name='369'>
                                                      rho, &amp;<a name='370'>
                                                      DZQ, &amp;<a name='371'>
                                                  W0AVG1D<a name='372'>
<font color=#447700>!<a name='373'></font>
      REAL,  INTENT(IN   ) :: DT,DX,DXSQ<a name='374'>
<font color=#447700>!<a name='375'></font>
<a name='376'>
      REAL,  INTENT(IN   ) :: XLV0,XLV1,XLS0,XLS1,CP,R,G<a name='377'>
      REAL,  INTENT(IN   ) :: EP2,SVP1,SVP2,SVP3,SVPT0<a name='378'>
<font color=#447700>!<a name='379'></font>
      REAL, DIMENSION( kts:kte ), INTENT(INOUT) ::         &amp;<a name='380'>
                                                     DQDT, &amp;<a name='381'>
                                                    DQIDT, &amp;<a name='382'>
                                                    DQCDT, &amp;<a name='383'>
                                                    DQRDT, &amp;<a name='384'>
                                                    DQSDT, &amp;<a name='385'>
                                                     DTDT<a name='386'>
<a name='387'>
      REAL, DIMENSION( ims:ime , jms:jme ),                &amp;<a name='388'>
            INTENT(INOUT) ::                       RAINCV, &amp;<a name='389'>
                                                   PRATEC, &amp;<a name='390'>
                                                      NCA<a name='391'>
<a name='392'>
<font color=#447700>!kf_edrates<a name='393'></font>
      REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),      &amp;<a name='394'>
            INTENT(INOUT) ::       UDR_KF,       &amp;<a name='395'>
                                             DDR_KF,       &amp;<a name='396'>
                                             UER_KF,       &amp;<a name='397'>
                                             DER_KF<a name='398'>
<a name='399'>
      REAL, DIMENSION( ims:ime , jms:jme ),                &amp;<a name='400'>
            INTENT(INOUT) ::     TIMEC_KF<a name='401'>
<a name='402'>
      INTEGER, INTENT(IN) ::         KF_EDRATES<a name='403'>
<a name='404'>
<font color=#447700>!<a name='405'></font>
<font color=#447700>!...DEFINE LOCAL VARIABLES...                                <a name='406'></font>
<font color=#447700>!                                                            <a name='407'></font>
      REAL, DIMENSION( kts:kte ) ::                        &amp;<a name='408'>
            Q0,Z0,TV0,TU,TVU,QU,TZ,TVD,                    &amp;<a name='409'>
            QD,QES,THTES,TG,TVG,QG,WU,WD,W0,EMS,EMSD,      &amp;<a name='410'>
            UMF,UER,UDR,DMF,DER,DDR,UMF2,UER2,             &amp;<a name='411'>
            UDR2,DMF2,DER2,DDR2,DZA,THTA0,THETEE,          &amp;<a name='412'>
            THTAU,THETEU,THTAD,THETED,QLIQ,QICE,           &amp;<a name='413'>
            QLQOUT,QICOUT,PPTLIQ,PPTICE,DETLQ,DETIC,       &amp;<a name='414'>
            DETLQ2,DETIC2,RATIO,RATIO2<a name='415'>
<a name='416'>
      REAL, DIMENSION( kts:kte ) ::                        &amp;<a name='417'>
            DOMGDP,EXN,RHOE,TVQU,DP,RH,EQFRC,WSPD,         &amp;<a name='418'>
            QDT,FXM,THTAG,THTESG,THPA,THFXTOP,             &amp;<a name='419'>
            THFXBOT,QPA,QFXTOP,QFXBOT,QLPA,QLFXIN,         &amp;<a name='420'>
            QLFXOUT,QIPA,QIFXIN,QIFXOUT,QRPA,              &amp;<a name='421'>
            QRFXIN,QRFXOUT,QSPA,QSFXIN,QSFXOUT,            &amp;<a name='422'>
            QL0,QLG,QI0,QIG,QR0,QRG,QS0,QSG<a name='423'>
                                         <a name='424'>
      REAL, DIMENSION( kts:kte+1 ) :: OMG<a name='425'>
      REAL, DIMENSION( kts:kte ) :: RAINFB,SNOWFB<a name='426'>
<a name='427'>
<font color=#447700>! LOCAL VARS<a name='428'></font>
<a name='429'>
      REAL    :: P00,T00,CV,B61,RLF,RHIC,RHBC,PIE,         &amp;<a name='430'>
                 TTFRZ,TBFRZ,C5,RATE<a name='431'>
      REAL    :: GDRY,ROCP,ALIQ,BLIQ,                      &amp; <a name='432'>
                 CLIQ,DLIQ,AICE,BICE,CICE,DICE<a name='433'>
      REAL    :: FBFRC,P300,DPTHMX,THMIX,QMIX,ZMIX,PMIX,   &amp;<a name='434'>
                 ROCPQ,TMIX,EMIX,TLOG,TDPT,TLCL,TVLCL,     &amp;<a name='435'>
                 CPORQ,PLCL,ES,DLP,TENV,QENV,TVEN,TVBAR,   &amp;<a name='436'>
                 ZLCL,WKL,WABS,TRPPT,WSIGNE,DTLCL,GDT,WLCL,&amp;<a name='437'>
                 TVAVG,QESE,WTW,RHOLCL,AU0,VMFLCL,UPOLD,   &amp;<a name='438'>
                 UPNEW,ABE,WKLCL,THTUDL,TUDL,TTEMP,FRC1,   &amp;<a name='439'>
                 QNEWIC,RL,R1,QNWFRZ,EFFQ,BE,BOTERM,ENTERM,&amp;<a name='440'>
                 DZZ,WSQ,UDLBE,REI,EE2,UD2,TTMP,F1,F2,     &amp;<a name='441'>
                 THTTMP,QTMP,TMPLIQ,TMPICE,TU95,TU10,EE1,  &amp;<a name='442'>
                 UD1,CLDHGT,DPTT,QNEWLQ,DUMFDP,EE,TSAT,    &amp;<a name='443'>
                 THTA,P150,USR,VCONV,TIMEC,SHSIGN,VWS,PEF, &amp;<a name='444'>
                 CBH,RCBH,PEFCBH,PEFF,PEFF2,TDER,THTMIN,   &amp;<a name='445'>
                 DTMLTD,QS,TADVEC,DPDD,FRC,DPT,RDD,A1,     &amp;<a name='446'>
                 DSSDT,DTMP,T1RH,QSRH,PPTFLX,CPR,CNDTNF,   &amp;<a name='447'>
                 UPDINC,AINCM2,DEVDMF,PPR,RCED,DPPTDF,     &amp;<a name='448'>
                 DMFLFS,DMFLFS2,RCED2,DDINC,AINCMX,AINCM1, &amp;<a name='449'>
                 AINC,TDER2,PPTFL2,FABE,STAB,DTT,DTT1,     &amp;<a name='450'>
                 DTIME,TMA,TMB,TMM,BCOEFF,ACOEFF,QVDIFF,   &amp;<a name='451'>
                 TOPOMG,CPM,DQ,ABEG,DABE,DFDA,FRC2,DR,     &amp;<a name='452'>
                 UDFRC,TUC,QGS,RH0,RHG,QINIT,QFNL,ERR2,    &amp;<a name='453'>
                 RELERR,RLC,RLS,RNC,FABEOLD,AINCOLD,UEFRC, &amp;<a name='454'>
                 DDFRC,TDC,DEFRC         <a name='455'>
<a name='456'>
      INTEGER :: KX,K,KL<a name='457'>
<font color=#447700>!                                                    <a name='458'></font>
      INTEGER :: ISTOP,ML,L5,L4,KMIX,LOW,                  &amp;<a name='459'>
                 LC,MXLAYR,LLFC,NLAYRS,NK,                 &amp;<a name='460'>
                 KPBL,KLCL,LCL,LET,IFLAG,                  &amp;<a name='461'>
                 KFRZ,NK1,LTOP,NJ,LTOP1,                   &amp;<a name='462'>
                 LTOPM1,LVF,KSTART,KMIN,LFS,               &amp;<a name='463'>
                 ND,NIC,LDB,LDT,ND1,NDK,                   &amp;<a name='464'>
                 NM,LMAX,NCOUNT,NOITR,                     &amp;<a name='465'>
                 NSTEP,NTC<a name='466'>
<font color=#447700>!                                                    <a name='467'></font>
      DATA P00,T00/1.E5,273.16/                     <a name='468'>
      DATA CV,B61,RLF/717.,0.608,3.339E5/          <a name='469'>
      DATA RHIC,RHBC/1.,0.90/                                    <a name='470'>
      DATA PIE,TTFRZ,TBFRZ,C5/3.141592654,268.16,248.16,1.0723E-3/<a name='471'>
      DATA RATE/0.01/                                           <a name='472'>
<font color=#447700>!-----------------------------------------------------------<a name='473'></font>
      GDRY=-G/CP                                               <a name='474'>
      ROCP=R/CP<a name='475'>
      KL=kte<a name='476'>
      KX=kte<a name='477'>
<font color=#447700>!<a name='478'></font>
<font color=#447700>!     ALIQ = 613.3   <a name='479'></font>
<font color=#447700>!     BLIQ = 17.502                                                   <a name='480'></font>
<font color=#447700>!     CLIQ = 4780.8                                                  <a name='481'></font>
<font color=#447700>!     DLIQ = 32.19                                                  <a name='482'></font>
      ALIQ = SVP1*1000.<a name='483'>
      BLIQ = SVP2<a name='484'>
      CLIQ = SVP2*SVPT0<a name='485'>
      DLIQ = SVP3<a name='486'>
      AICE = 613.2  <a name='487'>
      BICE = 22.452                                         <a name='488'>
      CICE = 6133.0                                        <a name='489'>
      DICE = 0.61                                         <a name='490'>
<font color=#447700>!<a name='491'></font>
<a name='492'>
<font color=#447700>!...OPTION TO FEED CONVECTIVELY GENERATED RAINWATER      <a name='493'></font>
<font color=#447700>!...INTO GRID-RESOLVED RAINWATER (OR SNOW/GRAUPEL)      <a name='494'></font>
<font color=#447700>!...FIELD.  'FBFRC' IS THE FRACTION OF AVAILABLE       <a name='495'></font>
<font color=#447700>!...PRECIPITATION TO BE FED BACK (0.0 - 1.0)...      <a name='496'></font>
<font color=#447700>!                                                   <a name='497'></font>
      FBFRC=0.0                                    <a name='498'>
<font color=#447700>!                                                                       <a name='499'></font>
<font color=#447700>!...SCHEME IS CALLED ONCE  ON EACH NORTH-SOUTH SLICE, THE LOOP BELOW   <a name='500'></font>
<font color=#447700>!...CHECKS FOR THE POSSIBILITY OF INITIATING PARAMETERIZED            <a name='501'></font>
<font color=#447700>!...CONVECTION AT EACH POINT WITHIN THE SLICE                        <a name='502'></font>
<font color=#447700>!                                                                   <a name='503'></font>
<font color=#447700>!...SEE IF IT IS NECESSARY TO CHECK FOR CONVECTIVE TRIGGERING AT THIS <a name='504'></font>
<font color=#447700>!...GRID POINT. IF NCA&gt;0, CONVECTION IS ALREADY ACTIVE AT THIS POINT,<a name='505'></font>
<font color=#447700>!...JUST FEED BACK THE TENDENCIES SAVED FROM THE TIME WHEN CONVECTION  <a name='506'></font>
<font color=#447700>!...WAS INITIATED.  IF NCA&lt;0, CONVECTION IS NOT ACTIVE                <a name='507'></font>
<font color=#447700>!...AND YOU MAY WANT TO CHECK TO SEE IF IT CAN BE ACTIVATED FOR THE  <a name='508'></font>
<font color=#447700>!...CURRENT CONDITIONS.  IN PREVIOUS APLICATIONS OF THIS SCHEME,    <a name='509'></font>
<font color=#447700>!...THE VARIABLE ICLDCK WAS USED BELOW TO SAVE TIME BY ONLY CHECKING   <a name='510'></font>
<font color=#447700>!...FOR THE POSSIBILITY OF CONVECTIVE INITIATION EVERY 5 OR 10        <a name='511'></font>
<font color=#447700>!...MINUTES...                                                       <a name='512'></font>
<font color=#447700>!                                                                   <a name='513'></font>
<a name='514'>
<font color=#447700>!  10 CONTINUE                                                 <a name='515'></font>
<font color=#447700>!SUE  P300=1000.*(PSB(I,J)*A(KL)+PTOP-30.)+PP3D(I,J,KL)              <a name='516'></font>
<a name='517'>
      P300=P0(1)-30000.<a name='518'>
<font color=#447700>!                                                                     <a name='519'></font>
<font color=#447700>!...PRESSURE PERTURBATION TERM IS ONLY DEFINED AT MID-POINT OF       <a name='520'></font>
<font color=#447700>!...VERTICAL LAYERS...SINCE TOTAL PRESSURE IS NEEDED AT THE TOP AND <a name='521'></font>
<font color=#447700>!...BOTTOM OF LAYERS BELOW, DO AN INTERPOLATION...                       <a name='522'></font>
<font color=#447700>!                                                                       <a name='523'></font>
<font color=#447700>!...INPUT A VERTICAL SOUNDING ... NOTE THAT MODEL LAYERS ARE NUMBERED  <a name='524'></font>
<font color=#447700>!...FROM BOTTOM-UP IN THE KF SCHEME...                                <a name='525'></font>
<font color=#447700>!                                                                    <a name='526'></font>
      ML=0                                                        <a name='527'>
<font color=#447700>!SUE  tmprpsb=1./PSB(I,J)<a name='528'></font>
<font color=#447700>!SUE  CELL=PTOP*tmprpsb<a name='529'></font>
<a name='530'>
      DO 15 K=1,KX                                               <a name='531'>
<font color=#447700>!SUE     P0(K)=1.E3*(A(NK)*PSB(I,J)+PTOP)+PP3D(I,J,NK)          <a name='532'></font>
<font color=#447700>!                                                                        <a name='533'></font>
<font color=#447700>!...IF Q0 IS ABOVE SATURATION VALUE, REDUCE IT TO SATURATION LEVEL...   <a name='534'></font>
<font color=#447700>!                                                                      <a name='535'></font>
         ES=ALIQ*EXP((BLIQ*T0(K)-CLIQ)/(T0(K)-DLIQ))                 <a name='536'>
         QES(K)=EP2*ES/(P0(K)-ES)                                 <a name='537'>
         Q0(K)=AMIN1(QES(K),QV0(K))                                 <a name='538'>
         Q0(K)=AMAX1(0.000001,Q0(K))                                 <a name='539'>
         QL0(K)=0.                                                <a name='540'>
         QI0(K)=0.                                               <a name='541'>
         QR0(K)=0.                                              <a name='542'>
         QS0(K)=0.                                             <a name='543'>
<a name='544'>
         TV0(K)=T0(K)*(1.+B61*Q0(K))                                 <a name='545'>
         RHOE(K)=P0(K)/(R*TV0(K))                                  <a name='546'>
<a name='547'>
         DP(K)=rho(k)*g*DZQ(k)<a name='548'>
<font color=#447700>!                                                                         <a name='549'></font>
<font color=#447700>!...DZQ IS DZ BETWEEN SIGMA SURFACES, DZA IS DZ BETWEEN MODEL HALF LEVEL <a name='550'></font>
<font color=#447700>!   DP IS THE PRESSURE INTERVAL BETWEEN FULL SIGMA LEVELS...            <a name='551'></font>
<font color=#447700>!                                                                      <a name='552'></font>
         IF(P0(K).GE.500E2)L5=K                                       <a name='553'>
         IF(P0(K).GE.400E2)L4=K                                      <a name='554'>
         IF(P0(K).GE.P300)LLFC=K                                    <a name='555'>
         IF(T0(K).GT.T00)ML=K                                      <a name='556'>
   15   CONTINUE                                                   <a name='557'>
<a name='558'>
        Z0(1)=.5*DZQ(1)   <a name='559'>
        DO 20 K=2,KL                                              <a name='560'>
          Z0(K)=Z0(K-1)+.5*(DZQ(K)+DZQ(K-1))   <a name='561'>
          DZA(K-1)=Z0(K)-Z0(K-1)                                 <a name='562'>
   20   CONTINUE                                                       <a name='563'>
        DZA(KL)=0.                                                    <a name='564'>
        KMIX=1                                                       <a name='565'>
   25   LOW=KMIX                                                    <a name='566'>
<a name='567'>
        IF(LOW.GT.LLFC)GOTO 325                                    <a name='568'>
<a name='569'>
        LC=LOW                                                    <a name='570'>
        MXLAYR=0                                                 <a name='571'>
<font color=#447700>!                                                                        <a name='572'></font>
<font color=#447700>!...ASSUME THAT IN ORDER TO SUPPORT A DEEP UPDRAFT YOU NEED A LAYER OF <a name='573'></font>
<font color=#447700>!...UNSTABLE AIR 50 TO 100 mb DEEP...TO APPROXIMATE THIS, ISOLATE A      <a name='574'></font>
<font color=#447700>!...GROUP OF ADJACENT INDIVIDUAL MODEL LAYERS, WITH THE BASE AT LEVEL   <a name='575'></font>
<font color=#447700>!...LC, SUCH THAT THE COMBINED DEPTH OF THESE LAYERS IS AT LEAST 60 mb..  <a name='576'></font>
<font color=#447700>!                                                                        <a name='577'></font>
        NLAYRS=0                                                        <a name='578'>
        DPTHMX=0.                                                      <a name='579'>
        DO 63 NK=LC,KX                                                <a name='580'>
          DPTHMX=DPTHMX+DP(NK)                                            <a name='581'>
          NLAYRS=NLAYRS+1                                                <a name='582'>
   63   IF(DPTHMX.GT.6.E3)GOTO 64                                       <a name='583'>
        GOTO 325                                                       <a name='584'>
   64   KPBL=LC+NLAYRS-1                                              <a name='585'>
        KMIX=LC+1                                                        <a name='586'>
   18   THMIX=0.                                                        <a name='587'>
        QMIX=0.                                                        <a name='588'>
        ZMIX=0.                                                       <a name='589'>
        PMIX=0.                                                             <a name='590'>
        DPTHMX=0.                                                          <a name='591'>
<font color=#447700>!                                                                         <a name='592'></font>
<font color=#447700>!...FIND THE THERMODYNAMIC CHARACTERISTICS OF THE LAYER BY              <a name='593'></font>
<font color=#447700>!...MASS-WEIGHTING THE CHARACTERISTICS OF THE INDIVIDUAL MODEL         <a name='594'></font>
<font color=#447700>!...LAYERS...                                                         <a name='595'></font>
<font color=#447700>!                                                                    <a name='596'></font>
        DO 17 NK=LC,KPBL                                            <a name='597'>
          DPTHMX=DPTHMX+DP(NK)                                     <a name='598'>
          ROCPQ=0.2854*(1.-0.28*Q0(NK))                           <a name='599'>
          THMIX=THMIX+DP(NK)*T0(NK)*(P00/P0(NK))**ROCPQ          <a name='600'>
          QMIX=QMIX+DP(NK)*Q0(NK)                               <a name='601'>
          ZMIX=ZMIX+DP(NK)*Z0(NK)                              <a name='602'>
   17   PMIX=PMIX+DP(NK)*P0(NK)                               <a name='603'>
        THMIX=THMIX/DPTHMX                                   <a name='604'>
        QMIX=QMIX/DPTHMX                                    <a name='605'>
        ZMIX=ZMIX/DPTHMX                                   <a name='606'>
        PMIX=PMIX/DPTHMX                                  <a name='607'>
        ROCPQ=0.2854*(1.-0.28*QMIX)                               <a name='608'>
        TMIX=THMIX*(PMIX/P00)**ROCPQ                             <a name='609'>
        EMIX=QMIX*PMIX/(EP2+QMIX)                             <a name='610'>
<font color=#447700>!                                                              <a name='611'></font>
<font color=#447700>!...FIND THE TEMPERATURE OF THE MIXTURE AT ITS LCL, PRESSURE       <a name='612'></font>
<font color=#447700>!...LEVEL OF LCL...                                               <a name='613'></font>
<font color=#447700>!                                                                <a name='614'></font>
        TLOG=ALOG(EMIX/ALIQ)                                    <a name='615'>
        TDPT=(CLIQ-DLIQ*TLOG)/(BLIQ-TLOG)                             <a name='616'>
        TLCL=TDPT-(.212+1.571E-3*(TDPT-T00)-4.36E-4*(TMIX-T00))*(TMIX-  &amp;<a name='617'>
             TDPT)                                                    <a name='618'>
        TLCL=AMIN1(TLCL,TMIX)                                       <a name='619'>
        TVLCL=TLCL*(1.+0.608*QMIX)                                 <a name='620'>
        CPORQ=1./ROCPQ                                            <a name='621'>
        PLCL=P00*(TLCL/THMIX)**CPORQ                             <a name='622'>
        DO 29 NK=LC,KL                                          <a name='623'>
          KLCL=NK                                              <a name='624'>
          IF(PLCL.GE.P0(NK))GOTO 35                           <a name='625'>
   29   CONTINUE                                            <a name='626'>
        GOTO 325                                                       <a name='627'>
   35   K=KLCL-1                                                      <a name='628'>
        DLP=ALOG(PLCL/P0(K))/ALOG(P0(KLCL)/P0(K))                    <a name='629'>
<font color=#447700>!                                                                   <a name='630'></font>
<font color=#447700>!...ESTIMATE ENVIRONMENTAL TEMPERATURE AND MIXING RATIO AT THE LCL...<a name='631'></font>
<font color=#447700>!                                                                   <a name='632'></font>
        TENV=T0(K)+(T0(KLCL)-T0(K))*DLP                            <a name='633'>
        QENV=Q0(K)+(Q0(KLCL)-Q0(K))*DLP                           <a name='634'>
        TVEN=TENV*(1.+0.608*QENV)                                <a name='635'>
        TVBAR=0.5*(TV0(K)+TVEN)                                 <a name='636'>
<font color=#447700>!        ZLCL=Z0(K)+R*TVBAR*ALOG(P0(K)/PLCL)/G                 <a name='637'></font>
        ZLCL=Z0(K)+(Z0(KLCL)-Z0(K))*DLP                                 <a name='638'>
<font color=#447700>!                                                                      <a name='639'></font>
<font color=#447700>!...CHECK TO SEE IF CLOUD IS BUOYANT USING FRITSCH-CHAPPELL TRIGGER  <a name='640'></font>
<font color=#447700>!...FUNCTION DESCRIBED IN KAIN AND FRITSCH (1992)...W0AVG IS AN     <a name='641'></font>
<font color=#447700>!...APROXIMATE VALUE FOR THE RUNNING-MEAN GRID-SCALE VERTICAL      <a name='642'></font>
<font color=#447700>!...VELOCITY, WHICH GIVES SMOOTHER FIELDS OF CONVECTIVE INITIATION <a name='643'></font>
<font color=#447700>!...THAN THE INSTANTANEOUS VALUE...FORMULA RELATING TEMPERATURE            <a name='644'></font>
<font color=#447700>!...PERTURBATION TO VERTICAL VELOCITY HAS BEEN USED WITH THE MOST         <a name='645'></font>
<font color=#447700>!...SUCCESS AT GRID LENGTHS NEAR 25 km.  FOR DIFFERENT GRID-LENGTHS,     <a name='646'></font>
<font color=#447700>!...ADJUST VERTICAL VELOCITY TO EQUIVALENT VALUE FOR 25 KM GRID         <a name='647'></font>
<font color=#447700>!...LENGTH, ASSUMING LINEAR DEPENDENCE OF W ON GRID LENGTH...          <a name='648'></font>
<font color=#447700>!                                                                     <a name='649'></font>
        WKLCL=0.02*ZLCL/2.5E3                                             <a name='650'>
        WKL=(W0AVG1D(K)+(W0AVG1D(KLCL)-W0AVG1D(K))*DLP)*DX/25.E3- &amp; <a name='651'>
            WKLCL                                                           <a name='652'>
        WABS=ABS(WKL)+1.E-10                                               <a name='653'>
        WSIGNE=WKL/WABS                                                   <a name='654'>
        DTLCL=4.64*WSIGNE*WABS**0.33                                     <a name='655'>
        GDT=G*DTLCL*(ZLCL-Z0(LC))/(TV0(LC)+TVEN)                        <a name='656'>
        WLCL=1.+.5*WSIGNE*SQRT(ABS(GDT)+1.E-10)                        <a name='657'>
        IF(TLCL+DTLCL.GT.TENV)GOTO 45                                 <a name='658'>
        IF(KPBL.GE.LLFC)GOTO 325                                     <a name='659'>
        GOTO 25                                                     <a name='660'>
<font color=#447700>!                                                                       <a name='661'></font>
<font color=#447700>!...CONVECTIVE TRIGGERING CRITERIA HAS BEEN SATISFIED...COMPUTE           <a name='662'></font>
<font color=#447700>!...EQUIVALENT POTENTIAL TEMPERATURE                                     <a name='663'></font>
<font color=#447700>!...(THETEU) AND VERTICAL VELOCITY OF THE RISING PARCEL AT THE LCL...    <a name='664'></font>
<font color=#447700>!                                                                       <a name='665'></font>
   45   THETEU(K)=TMIX*(1.E5/PMIX)**(0.2854*(1.-0.28*QMIX))* &amp; <a name='666'>
                  EXP((3374.6525/TLCL-2.5403)*QMIX*(1.+0.81*QMIX))     <a name='667'>
        ES=ALIQ*EXP((TENV*BLIQ-CLIQ)/(TENV-DLIQ))                     <a name='668'>
        TVAVG=0.5*(TV0(KLCL)+TENV*(1.+0.608*QENV))                   <a name='669'>
        PLCL=P0(KLCL)*EXP(G/(R*TVAVG)*(Z0(KLCL)-ZLCL))              <a name='670'>
        QESE=EP2*ES/(PLCL-ES)                                    <a name='671'>
        GDT=G*DTLCL*(ZLCL-Z0(LC))/(TV0(LC)+TVEN)                  <a name='672'>
        WLCL=1.+.5*WSIGNE*SQRT(ABS(GDT)+1.E-10)                      <a name='673'>
        THTES(K)=TENV*(1.E5/PLCL)**(0.2854*(1.-0.28*QESE))* &amp;    <a name='674'>
                 EXP((3374.6525/TENV-2.5403)*QESE*(1.+0.81*QESE))           <a name='675'>
        WTW=WLCL*WLCL                                                      <a name='676'>
        IF(WLCL.LT.0.)GOTO 25                                             <a name='677'>
        TVLCL=TLCL*(1.+0.608*QMIX)                                       <a name='678'>
        RHOLCL=PLCL/(R*TVLCL)                                           <a name='679'>
<font color=#447700>!                                                                      <a name='680'></font>
        LCL=KLCL                                                      <a name='681'>
        LET=LCL                                                            <a name='682'>
<font color=#447700>!                                                                         <a name='683'></font>
<font color=#447700>!*******************************************************************     <a name='684'></font>
<font color=#447700>!                                                                  *    <a name='685'></font>
<font color=#447700>!                 COMPUTE UPDRAFT PROPERTIES                       *   <a name='686'></font>
<font color=#447700>!                                                                  *  <a name='687'></font>
<font color=#447700>!******************************************************************* <a name='688'></font>
<font color=#447700>!                                                                   <a name='689'></font>
<font color=#447700>!                                                                  <a name='690'></font>
<font color=#447700>!...ESTIMATE INITIAL UPDRAFT MASS FLUX (UMF(K))...                <a name='691'></font>
<font color=#447700>!                                                                <a name='692'></font>
        WU(K)=WLCL                                                          <a name='693'>
        AU0=PIE*RAD*RAD                                                    <a name='694'>
        UMF(K)=RHOLCL*AU0                                                 <a name='695'>
        VMFLCL=UMF(K)                                                    <a name='696'>
        UPOLD=VMFLCL                                                    <a name='697'>
        UPNEW=UPOLD                                                    <a name='698'>
<font color=#447700>!                                                                     <a name='699'></font>
<font color=#447700>!...RATIO2 IS THE DEGREE OF GLACIATION IN THE CLOUD (0 TO 1),        <a name='700'></font>
<font color=#447700>!...UER IS THE ENVIR ENTRAINMENT RATE, ABE IS AVAILABLE BUOYANT ENERGY,   <a name='701'></font>
<font color=#447700>!   TRPPT IS THE TOTAL RATE OF PRECIPITATION PRODUCTION...               <a name='702'></font>
<font color=#447700>!                                                                         <a name='703'></font>
        RATIO2(K)=0.                                                    <a name='704'>
        UER(K)=0.                                                      <a name='705'>
        ABE=0.                                                        <a name='706'>
        TRPPT=0.                                                     <a name='707'>
        TU(K)=TLCL                                                  <a name='708'>
        TVU(K)=TVLCL                                               <a name='709'>
        QU(K)=QMIX                                                <a name='710'>
        EQFRC(K)=1.                                              <a name='711'>
        QLIQ(K)=0.                                              <a name='712'>
        QICE(K)=0.                                             <a name='713'>
        QLQOUT(K)=0.                                          <a name='714'>
        QICOUT(K)=0.                                         <a name='715'>
        DETLQ(K)=0.                                         <a name='716'>
        DETIC(K)=0.                                        <a name='717'>
        PPTLIQ(K)=0.                                     <a name='718'>
        PPTICE(K)=0.                                    <a name='719'>
        IFLAG=0                                        <a name='720'>
        KFRZ=LC                                       <a name='721'>
<font color=#447700>!                                                    <a name='722'></font>
<font color=#447700>!...THE AMOUNT OF CONV AVAIL POT ENERGY (CAPE) IS CALCULATED WITH   <a name='723'></font>
<font color=#447700>!   RESPECT TO UNDILUTE PARCEL ASCENT; EQ POT TEMP OF UNDILUTE     <a name='724'></font>
<font color=#447700>!   PARCEL IS THTUDL, UNDILUTE TEMPERATURE IS GIVEN BY TUDL...    <a name='725'></font>
<font color=#447700>!                                                                <a name='726'></font>
        THTUDL=THETEU(K)                                        <a name='727'>
        TUDL=TLCL                                              <a name='728'>
<font color=#447700>!                                                             <a name='729'></font>
<font color=#447700>!...TTEMP IS USED DURING CALCULATION OF THE LINEAR GLACIATION        <a name='730'></font>
<font color=#447700>!   PROCESS; IT IS INITIALLY SET TO THE TEMPERATURE AT WHICH        <a name='731'></font>
<font color=#447700>!   FREEZING IS SPECIFIED TO BEGIN.  WITHIN THE GLACIATION         <a name='732'></font>
<font color=#447700>!   INTERVAL, IT IS SET EQUAL TO THE UPDRAFT TEMP AT THE          <a name='733'></font>
<font color=#447700>!   PREVIOUS MODEL LEVEL...                                      <a name='734'></font>
<font color=#447700>!                                                               <a name='735'></font>
        TTEMP=TTFRZ                                                   <a name='736'>
<font color=#447700>!                                                                    <a name='737'></font>
<font color=#447700>!...ENTER THE LOOP FOR UPDRAFT CALCULATIONS...CALCULATE UPDRAFT TEMP,    <a name='738'></font>
<font color=#447700>!   MIXING RATIO, VERTICAL MASS FLUX, LATERAL DETRAINMENT OF MASS AND   <a name='739'></font>
<font color=#447700>!   MOISTURE, PRECIPITATION RATES AT EACH MODEL LEVEL...               <a name='740'></font>
<font color=#447700>!                                                                     <a name='741'></font>
        DO 60 NK=K,KL-1<a name='742'>
          NK1=NK+1                                                         <a name='743'>
          RATIO2(NK1)=RATIO2(NK)                                          <a name='744'>
<font color=#447700>!                                                                        <a name='745'></font>
<font color=#447700>!...UPDATE UPDRAFT PROPERTIES AT THE NEXT MODEL LVL TO REFLECT          <a name='746'></font>
<font color=#447700>!   ENTRAINMENT OF ENVIRONMENTAL AIR...                                     <a name='747'></font>
<font color=#447700>!                                                                          <a name='748'></font>
          FRC1=0.                                                         <a name='749'>
          TU(NK1)=T0(NK1)                                                <a name='750'>
          THETEU(NK1)=THETEU(NK)                                        <a name='751'>
          QU(NK1)=QU(NK)                                               <a name='752'>
          QLIQ(NK1)=QLIQ(NK)                                          <a name='753'>
          QICE(NK1)=QICE(NK)                                         <a name='754'>
<a name='755'>
          CALL <A href='../../html_code/phys/module_cu_kf.F.html#TPMIX'>TPMIX</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX_1">(P0(NK1),THETEU(NK1),TU(NK1),QU(NK1),QLIQ(NK1), &amp; <a name='756'>
               QICE(NK1),QNEWLQ,QNEWIC,RATIO2(NK1),RL,XLV0,XLV1,XLS0, &amp;<a name='757'>
               XLS1,EP2,ALIQ,BLIQ,CLIQ,DLIQ,AICE,BICE,CICE,DICE)        <a name='758'>
          TVU(NK1)=TU(NK1)*(1.+0.608*QU(NK1))                      <a name='759'>
<font color=#447700>!                                                                 <a name='760'></font>
<font color=#447700>!...CHECK TO SEE IF UPDRAFT TEMP IS WITHIN THE FREEZING INTERVAL,<a name='761'></font>
<font color=#447700>!   IF IT IS, CALCULATE THE FRACTIONAL CONVERSION TO GLACIATION     <a name='762'></font>
<font color=#447700>!   AND ADJUST QNEWLQ TO REFLECT THE GRADUAL CHANGE IN THETAU      <a name='763'></font>
<font color=#447700>!   SINCE THE LAST MODEL LEVEL...THE GLACIATION EFFECTS WILL BE   <a name='764'></font>
<font color=#447700>!   DETERMINED AFTER THE AMOUNT OF CONDENSATE AVAILABLE AFTER    <a name='765'></font>
<font color=#447700>!   PRECIP FALLOUT IS DETERMINED...TTFRZ IS THE TEMP AT WHICH   <a name='766'></font>
<font color=#447700>!   GLACIATION BEGINS, TBFRZ THE TEMP AT WHICH IT ENDS...     <a name='767'></font>
<font color=#447700>!                                                            <a name='768'></font>
          IF(TU(NK1).LE.TTFRZ.AND.IFLAG.LT.1)THEN                    <a name='769'>
            IF(TU(NK1).GT.TBFRZ)THEN                                <a name='770'>
              IF(TTEMP.GT.TTFRZ)TTEMP=TTFRZ                        <a name='771'>
              FRC1=(TTEMP-TU(NK1))/(TTFRZ-TBFRZ)                  <a name='772'>
              R1=(TTEMP-TU(NK1))/(TTEMP-TBFRZ)                   <a name='773'>
            ELSE                                                <a name='774'>
              FRC1=(TTEMP-TBFRZ)/(TTFRZ-TBFRZ)                <a name='775'>
              R1=1.                                          <a name='776'>
              IFLAG=1                                       <a name='777'>
            ENDIF                                          <a name='778'>
            QNWFRZ=QNEWLQ                                 <a name='779'>
            QNEWIC=QNEWIC+QNEWLQ*R1*0.5                  <a name='780'>
            QNEWLQ=QNEWLQ-QNEWLQ*R1*0.5                 <a name='781'>
            EFFQ=(TTFRZ-TBFRZ)/(TTEMP-TBFRZ)           <a name='782'>
            TTEMP=TU(NK1)                             <a name='783'>
          ENDIF                                      <a name='784'>
<font color=#447700>!                                                  <a name='785'></font>
<font color=#447700>!  CALCULATE UPDRAFT VERTICAL VELOCITY AND PRECIPITATION FALLOUT...  <a name='786'></font>
<font color=#447700>!                                                                   <a name='787'></font>
          IF(NK.EQ.K)THEN                                          <a name='788'>
            BE=(TVLCL+TVU(NK1))/(TVEN+TV0(NK1))-1.                <a name='789'>
            BOTERM=2.*(Z0(NK1)-ZLCL)*G*BE/1.5                    <a name='790'>
            ENTERM=0.                                           <a name='791'>
            DZZ=Z0(NK1)-ZLCL                                   <a name='792'>
          ELSE                                                <a name='793'>
            BE=(TVU(NK)+TVU(NK1))/(TV0(NK)+TV0(NK1))-1.      <a name='794'>
            BOTERM=2.*DZA(NK)*G*BE/1.5                                        <a name='795'>
            ENTERM=2.*UER(NK)*WTW/UPOLD                                      <a name='796'>
            DZZ=DZA(NK)                                                     <a name='797'>
          ENDIF                                                            <a name='798'>
          WSQ=WTW                                                         <a name='799'>
          CALL <A href='../../html_code/phys/module_cu_mskf.F.html#CONDLOAD'>CONDLOAD</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDLOAD_1">(QLIQ(NK1),QICE(NK1),WTW,DZZ,BOTERM,ENTERM,RATE, &amp; <a name='800'>
               QNEWLQ,QNEWIC,QLQOUT(NK1),QICOUT(NK1), G)                    <a name='801'>
                                                              <a name='802'>
<font color=#447700>!...IF VERT VELOCITY IS LESS THAN ZERO, EXIT THE UPDRAFT LOOP AND,     <a name='803'></font>
<font color=#447700>!   IF CLOUD IS TALL ENOUGH, FINALIZE UPDRAFT CALCULATIONS...         <a name='804'></font>
<font color=#447700>!                                                                    <a name='805'></font>
          IF(WTW.LE.0.)GOTO 65                                      <a name='806'>
          WABS=SQRT(ABS(WTW))                                      <a name='807'>
          WU(NK1)=WTW/WABS                                        <a name='808'>
<font color=#447700>!                                                                <a name='809'></font>
<font color=#447700>!  UPDATE THE ABE FOR UNDILUTE ASCENT...                        <a name='810'></font>
<font color=#447700>!                                                                         <a name='811'></font>
          THTES(NK1)=T0(NK1)*(1.E5/P0(NK1))**(0.2854*(1.-0.28*QES(NK1))) &amp; <a name='812'>
                     *                                                   &amp;<a name='813'>
                     EXP((3374.6525/T0(NK1)-2.5403)*QES(NK1)*(1.+0.81*   &amp;<a name='814'>
                     QES(NK1)))                                          <a name='815'>
          UDLBE=((2.*THTUDL)/(THTES(NK)+THTES(NK1))-1.)*DZZ             <a name='816'>
          IF(UDLBE.GT.0.)ABE=ABE+UDLBE*G                               <a name='817'>
<font color=#447700>!                                                                     <a name='818'></font>
<font color=#447700>!  DETERMINE THE EFFECTS OF CLOUD GLACIATION IF WITHIN THE SPECIFIED <a name='819'></font>
<font color=#447700>!  TEMP INTERVAL...                                                 <a name='820'></font>
<font color=#447700>!                                                                  <a name='821'></font>
          IF(FRC1.GT.1.E-6)THEN                                   <a name='822'>
            CALL <A href='../../html_code/phys/module_cu_mskf.F.html#DTFRZNEW'>DTFRZNEW</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DTFRZNEW_1">(TU(NK1),P0(NK1),THETEU(NK1),QU(NK1),QLIQ(NK1), &amp; <a name='823'>
                 QICE(NK1),RATIO2(NK1),TTFRZ,TBFRZ,QNWFRZ,RL,FRC1,EFFQ,  &amp;<a name='824'>
                 IFLAG,XLV0,XLV1,XLS0,XLS1,EP2,ALIQ,BLIQ,CLIQ,DLIQ,AICE,BICE &amp;  <a name='825'>
                 ,CICE,DICE)                                     <a name='826'>
          ENDIF                                                 <a name='827'>
<font color=#447700>!                                                              <a name='828'></font>
<font color=#447700>!  CALL SUBROUTINE TO CALCULATE ENVIRONMENTAL EQUIVALENT POTENTIAL TEMP.      <a name='829'></font>
<font color=#447700>!  WITHIN GLACIATION INTERVAL, THETAE MUST BE CALCULATED WITH RESPECT TO     <a name='830'></font>
<font color=#447700>!  SAME DEGREE OF GLACIATION FOR ALL ENTRAINING AIR...                      <a name='831'></font>
<font color=#447700>!                                                                          <a name='832'></font>
          CALL <A href='../../html_code/phys/module_cu_mskf.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_1">(P0(NK1),T0(NK1),Q0(NK1),THETEE(NK1),RATIO2(NK1), &amp;<a name='833'>
               RL,EP2,ALIQ,BLIQ,CLIQ,DLIQ,AICE,BICE,CICE,DICE)                <a name='834'>
                                                                         <a name='835'>
<font color=#447700>!...REI IS THE RATE OF ENVIRONMENTAL INFLOW...                          <a name='836'></font>
<font color=#447700>!                                                                      <a name='837'></font>
          REI=VMFLCL*DP(NK1)*0.03/RAD                                 <a name='838'>
          TVQU(NK1)=TU(NK1)*(1.+0.608*QU(NK1)-QLIQ(NK1)-QICE(NK1))   <a name='839'>
<font color=#447700>!                                                                   <a name='840'></font>
<font color=#447700>!...IF CLOUD PARCELS ARE VIRTUALLY COLDER THAN THE ENVIRONMENT, NO <a name='841'></font>
<font color=#447700>!   ENTRAINMENT IS ALLOWED AT THIS LEVEL...                               <a name='842'></font>
<font color=#447700>!                                                                        <a name='843'></font>
          IF(TVQU(NK1).LE.TV0(NK1))THEN                                 <a name='844'>
            UER(NK1)=0.0                                               <a name='845'>
            UDR(NK1)=REI                                              <a name='846'>
            EE2=0.                                                   <a name='847'>
            UD2=1.                                                  <a name='848'>
            EQFRC(NK1)=0.                                          <a name='849'>
            GOTO 55                                                        <a name='850'>
          ENDIF                                                          <a name='851'>
          LET=NK1                                                       <a name='852'>
          TTMP=TVQU(NK1)                                               <a name='853'>
<font color=#447700>!                                                                          <a name='854'></font>
<font color=#447700>!...DETERMINE THE CRITICAL MIXED FRACTION OF UPDRAFT AND ENVIRONMENTAL    <a name='855'></font>
<font color=#447700>!   AIR FOR ESTIMATION OF ENTRAINMENT AND DETRAINMENT RATES...           <a name='856'></font>
<font color=#447700>!                                                                       <a name='857'></font>
          F1=0.95                                                      <a name='858'>
          F2=1.-F1                                                    <a name='859'>
          THTTMP=F1*THETEE(NK1)+F2*THETEU(NK1)                       <a name='860'>
          QTMP=F1*Q0(NK1)+F2*QU(NK1)                                <a name='861'>
          TMPLIQ=F2*QLIQ(NK1)                                      <a name='862'>
          TMPICE=F2*QICE(NK1)                                                <a name='863'>
          CALL <A href='../../html_code/phys/module_cu_kf.F.html#TPMIX'>TPMIX</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX_2">(P0(NK1),THTTMP,TTMP,QTMP,TMPLIQ,TMPICE,QNEWLQ,      &amp; <a name='864'>
               QNEWIC,RATIO2(NK1),RL,XLV0,XLV1,XLS0,XLS1,EP2,ALIQ,BLIQ,CLIQ, &amp;<a name='865'>
               DLIQ,AICE,BICE,CICE,DICE)                                    <a name='866'>
          TU95=TTMP*(1.+0.608*QTMP-TMPLIQ-TMPICE)                          <a name='867'>
          IF(TU95.GT.TV0(NK1))THEN                                        <a name='868'>
            EE2=1.                                                       <a name='869'>
            UD2=0.                                                      <a name='870'>
            EQFRC(NK1)=1.0                                             <a name='871'>
            GOTO 50                                                   <a name='872'>
          ENDIF                                                              <a name='873'>
          F1=0.10                                                           <a name='874'>
          F2=1.-F1                                                         <a name='875'>
          THTTMP=F1*THETEE(NK1)+F2*THETEU(NK1)                            <a name='876'>
          QTMP=F1*Q0(NK1)+F2*QU(NK1)                                    <a name='877'>
          TMPLIQ=F2*QLIQ(NK1)                                            <a name='878'>
          TMPICE=F2*QICE(NK1)                                               <a name='879'>
          CALL <A href='../../html_code/phys/module_cu_kf.F.html#TPMIX'>TPMIX</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX_3">(P0(NK1),THTTMP,TTMP,QTMP,TMPLIQ,TMPICE,QNEWLQ,      &amp; <a name='880'>
               QNEWIC,RATIO2(NK1),RL,XLV0,XLV1,XLS0,XLS1,EP2,ALIQ,BLIQ,CLIQ, &amp;<a name='881'>
               DLIQ,AICE,BICE,CICE,DICE)                                   <a name='882'>
          TU10=TTMP*(1.+0.608*QTMP-TMPLIQ-TMPICE)                         <a name='883'>
          IF(TU10.EQ.TVQU(NK1))THEN                                      <a name='884'>
            EE2=1.                                                      <a name='885'>
            UD2=0.                                                     <a name='886'>
            EQFRC(NK1)=1.0                                            <a name='887'>
            GOTO 50                                                  <a name='888'>
          ENDIF                                                     <a name='889'>
          EQFRC(NK1)=(TV0(NK1)-TVQU(NK1))*F1/(TU10-TVQU(NK1))      <a name='890'>
          EQFRC(NK1)=AMAX1(0.0,EQFRC(NK1))                        <a name='891'>
          EQFRC(NK1)=AMIN1(1.0,EQFRC(NK1))                       <a name='892'>
          IF(EQFRC(NK1).EQ.1)THEN                               <a name='893'>
            EE2=1.                                             <a name='894'>
            UD2=0.                                            <a name='895'>
            GOTO 50                                          <a name='896'>
          ELSEIF(EQFRC(NK1).EQ.0.)THEN                                       <a name='897'>
            EE2=0.                                                          <a name='898'>
            UD2=1.                                                         <a name='899'>
            GOTO 50                                                       <a name='900'>
          ELSE                                                           <a name='901'>
<font color=#447700>!                                                                       <a name='902'></font>
<font color=#447700>!...SUBROUTINE PROF5 INTEGRATES OVER THE GAUSSIAN DIST TO DETERMINE THE<a name='903'></font>
<font color=#447700>!   FRACTIONAL ENTRAINMENT AND DETRAINMENT RATES...                   <a name='904'></font>
<font color=#447700>!                                                                    <a name='905'></font>
            CALL <A href='../../html_code/phys/module_cu_mskf.F.html#PROF5'>PROF5</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PROF5_1">(EQFRC(NK1),EE2,UD2)                          <a name='906'>
          ENDIF                                                    <a name='907'>
<font color=#447700>!                                                                 <a name='908'></font>
   50     IF(NK.EQ.K)THEN                                        <a name='909'>
            EE1=1.                                              <a name='910'>
            UD1=0.                                             <a name='911'>
          ENDIF                                               <a name='912'>
<font color=#447700>!                                                            <a name='913'></font>
<font color=#447700>!...NET ENTRAINMENT AND DETRAINMENT RATES ARE GIVEN BY THE AVERAGE         <a name='914'></font>
<font color=#447700>!   FRACTIONAL VALUES IN THE LAYER...                                     <a name='915'></font>
<font color=#447700>!                                                                        <a name='916'></font>
          UER(NK1)=0.5*REI*(EE1+EE2)                                    <a name='917'>
          UDR(NK1)=0.5*REI*(UD1+UD2)                                   <a name='918'>
<font color=#447700>!                                                                     <a name='919'></font>
<font color=#447700>!...IF THE CALCULATED UPDRAFT DETRAINMENT RATE IS GREATER THAN THE TOTAL  <a name='920'></font>
<font color=#447700>!   UPDRAFT MASS FLUX, ALL CLOUD MASS DETRAINS, EXIT UPDRAFT CALCULATION    <a name='921'></font>
<font color=#447700>!                                                                          <a name='922'></font>
   55     IF(UMF(NK)-UDR(NK1).LT.10.)THEN                                <a name='923'>
<font color=#447700>!                                                                       <a name='924'></font>
<font color=#447700>!...IF THE CALCULATED DETRAINED MASS FLUX IS GREATER THAN THE TOTAL    <a name='925'></font>
<font color=#447700>!   UPDRAFT FLUX, IMPOSE TOTAL DETRAINMENT OF UPDRAFT MASS AT THE     <a name='926'></font>
<font color=#447700>!   PREVIOUS MODEL                                                   <a name='927'></font>
<font color=#447700>!                                                                   <a name='928'></font>
            IF(UDLBE.GT.0.)ABE=ABE-UDLBE*G                         <a name='929'>
            LET=NK                                                <a name='930'>
<font color=#447700>!         WRITE(98,1015)P0(NK1)/100.                                 <a name='931'></font>
            GOTO 65                                                 <a name='932'>
          ENDIF                                                    <a name='933'>
          EE1=EE2                                                 <a name='934'>
          UD1=UD2                                                <a name='935'>
          UPOLD=UMF(NK)-UDR(NK1)                                <a name='936'>
          UPNEW=UPOLD+UER(NK1)                                 <a name='937'>
          UMF(NK1)=UPNEW                                      <a name='938'>
<font color=#447700>!                                                            <a name='939'></font>
<font color=#447700>!...DETLQ AND DETIC ARE THE RATES OF DETRAINMENT OF LIQUID AND ICE IN <a name='940'></font>
<font color=#447700>!   THE DETRAINING UPDRAFT MASS...                                   <a name='941'></font>
<font color=#447700>!                                                                   <a name='942'></font>
          DETLQ(NK1)=QLIQ(NK1)*UDR(NK1)                            <a name='943'>
          DETIC(NK1)=QICE(NK1)*UDR(NK1)                           <a name='944'>
          QDT(NK1)=QU(NK1)                                       <a name='945'>
          QU(NK1)=(UPOLD*QU(NK1)+UER(NK1)*Q0(NK1))/UPNEW        <a name='946'>
          THETEU(NK1)=(THETEU(NK1)*UPOLD+THETEE(NK1)*UER(NK1))/UPNEW  <a name='947'>
          QLIQ(NK1)=QLIQ(NK1)*UPOLD/UPNEW                            <a name='948'>
          QICE(NK1)=QICE(NK1)*UPOLD/UPNEW                           <a name='949'>
<font color=#447700>!                                                                  <a name='950'></font>
<font color=#447700>!...KFRZ IS THE HIGHEST MODEL LEVEL AT WHICH LIQUID CONDENSATE IS <a name='951'></font>
<font color=#447700>!   GENERATING PPTLIQ IS THE RATE OF GENERATION (FALLOUT) OF LIQUID     <a name='952'></font>
<font color=#447700>!   PRECIP AT A GIVING MODEL LVL, PPTICE THE SAME FOR ICE, TRPPT IS    <a name='953'></font>
<font color=#447700>!   THE TOTAL RATE OF PRODUCTION OF PRECIP UP TO THE CURRENT MODEL LEVEL <a name='954'></font>
<font color=#447700>!                                                                       <a name='955'></font>
          IF(ABS(RATIO2(NK1)-1.).GT.1.E-6)KFRZ=NK1                     <a name='956'>
          PPTLIQ(NK1)=QLQOUT(NK1)*(UMF(NK)-UDR(NK1))                  <a name='957'>
          PPTICE(NK1)=QICOUT(NK1)*(UMF(NK)-UDR(NK1))                 <a name='958'>
          TRPPT=TRPPT+PPTLIQ(NK1)+PPTICE(NK1)                       <a name='959'>
          IF(NK1.LE.KPBL)UER(NK1)=UER(NK1)+VMFLCL*DP(NK1)/DPTHMX   <a name='960'>
   60   CONTINUE                                                  <a name='961'>
<font color=#447700>!                                                                <a name='962'></font>
<font color=#447700>!...CHECK CLOUD DEPTH...IF CLOUD IS TALL ENOUGH, ESTIMATE THE EQUILIBRIU<a name='963'></font>
<font color=#447700>!   TEMPERATURE LEVEL (LET) AND ADJUST MASS FLUX PROFILE AT CLOUD TOP SO<a name='964'></font>
<font color=#447700>!   THAT MASS FLUX DECREASES TO ZERO AS A LINEAR FUNCTION OF PRESSURE  <a name='965'></font>
<font color=#447700>!   BETWEEN THE LET AND CLOUD TOP...                                  <a name='966'></font>
<font color=#447700>!                                                                    <a name='967'></font>
<font color=#447700>!...LTOP IS THE MODEL LEVEL JUST BELOW THE LEVEL AT WHICH VERTICAL  <a name='968'></font>
<font color=#447700>!   VELOCITY FIRST BECOMES NEGATIVE...                             <a name='969'></font>
<font color=#447700>!                                                                 <a name='970'></font>
   65   LTOP=NK                                                  <a name='971'>
        CLDHGT=Z0(LTOP)-ZLCL                                    <a name='972'>
<font color=#447700>!                                                              <a name='973'></font>
<font color=#447700>!...IF CLOUD TOP HGT IS LESS THAN SPECIFIED MINIMUM HEIGHT, GO BACK AND <a name='974'></font>
<font color=#447700>!   THE NEXT HIGHEST 60MB LAYER TO SEE IF A BIGGER CLOUD CAN BE OBTAINED<a name='975'></font>
<font color=#447700>!   THAT SOURCE AIR...                                                 <a name='976'></font>
<font color=#447700>!                                                                     <a name='977'></font>
<font color=#447700>!       IF(CLDHGT.LT.4.E3.OR.ABE.LT.1.)THEN                          <a name='978'></font>
        IF(CLDHGT.LT.3.E3.OR.ABE.LT.1.)THEN                         <a name='979'>
          DO 70 NK=K,LTOP                                          <a name='980'>
            UMF(NK)=0.                                            <a name='981'>
            UDR(NK)=0.                                           <a name='982'>
            UER(NK)=0.                                          <a name='983'>
            DETLQ(NK)=0.                                       <a name='984'>
            DETIC(NK)=0.                                      <a name='985'>
            PPTLIQ(NK)=0.                                    <a name='986'>
   70     PPTICE(NK)=0.                                     <a name='987'>
          GOTO 25                                          <a name='988'>
        ENDIF                                             <a name='989'>
<font color=#447700>!                                                                    <a name='990'></font>
<font color=#447700>!...IF THE LET AND LTOP ARE THE SAME, DETRAIN ALL OF THE UPDRAFT MASS <a name='991'></font>
<font color=#447700>!   FLUX THIS LEVEL...                                               <a name='992'></font>
<font color=#447700>!                                                                   <a name='993'></font>
        IF(LET.EQ.LTOP)THEN                                        <a name='994'>
          UDR(LTOP)=UMF(LTOP)+UDR(LTOP)-UER(LTOP)                 <a name='995'>
          DETLQ(LTOP)=QLIQ(LTOP)*UDR(LTOP)*UPNEW/UPOLD           <a name='996'>
          DETIC(LTOP)=QICE(LTOP)*UDR(LTOP)*UPNEW/UPOLD          <a name='997'>
          TRPPT=TRPPT-(PPTLIQ(LTOP)+PPTICE(LTOP))              <a name='998'>
          UER(LTOP)=0.                                        <a name='999'>
          UMF(LTOP)=0.                                       <a name='1000'>
          GOTO 85                                           <a name='1001'>
        ENDIF                                              <a name='1002'>
<font color=#447700>!                                                         <a name='1003'></font>
<font color=#447700>!   BEGIN TOTAL DETRAINMENT AT THE LEVEL ABOVE THE LET...<a name='1004'></font>
<font color=#447700>!                                                       <a name='1005'></font>
        DPTT=0.                                        <a name='1006'>
        DO 71 NJ=LET+1,LTOP                           <a name='1007'>
   71   DPTT=DPTT+DP(NJ)                             <a name='1008'>
        DUMFDP=UMF(LET)/DPTT                        <a name='1009'>
<font color=#447700>!                                                  <a name='1010'></font>
<font color=#447700>!...ADJUST MASS FLUX PROFILES, DETRAINMENT RATES, AND PRECIPITATION FALL <a name='1011'></font>
<font color=#447700>!   RATES TO REFLECT THE LINEAR DECREASE IN MASS FLX BETWEEN THE LET AND <a name='1012'></font>
<font color=#447700>!   PTOP                                                                <a name='1013'></font>
<font color=#447700>!                                                                      <a name='1014'></font>
        DO 75 NK=LET+1,LTOP                                           <a name='1015'>
          UDR(NK)=DP(NK)*DUMFDP                                      <a name='1016'>
          UMF(NK)=UMF(NK-1)-UDR(NK)                                 <a name='1017'>
          DETLQ(NK)=QLIQ(NK)*UDR(NK)                               <a name='1018'>
          DETIC(NK)=QICE(NK)*UDR(NK)                              <a name='1019'>
          TRPPT=TRPPT-PPTLIQ(NK)-PPTICE(NK)                      <a name='1020'>
          PPTLIQ(NK)=(UMF(NK-1)-UDR(NK))*QLQOUT(NK)             <a name='1021'>
          PPTICE(NK)=(UMF(NK-1)-UDR(NK))*QICOUT(NK)            <a name='1022'>
          TRPPT=TRPPT+PPTLIQ(NK)+PPTICE(NK)                   <a name='1023'>
   75   CONTINUE                                             <a name='1024'>
<font color=#447700>!                                                           <a name='1025'></font>
<font color=#447700>!...SEND UPDRAFT CHARACTERISTICS TO OUTPUT FILES...        <a name='1026'></font>
<font color=#447700>!                                                         <a name='1027'></font>
   85   CONTINUE                                         <a name='1028'>
<font color=#447700>!                                                       <a name='1029'></font>
<font color=#447700>!...EXTEND THE UPDRAFT MASS FLUX PROFILE DOWN TO THE SOURCE LAYER FOR <a name='1030'></font>
<font color=#447700>!   THE UPDRAFT AIR...ALSO, DEFINE THETAE FOR LEVELS BELOW THE LCL...<a name='1031'></font>
<font color=#447700>!                                                                   <a name='1032'></font>
        DO 90 NK=1,K                                               <a name='1033'>
          IF(NK.GE.LC)THEN                                        <a name='1034'>
            IF(NK.EQ.LC)THEN                                     <a name='1035'>
              UMF(NK)=VMFLCL*DP(NK)/DPTHMX                      <a name='1036'>
              UER(NK)=VMFLCL*DP(NK)/DPTHMX                     <a name='1037'>
            ELSEIF(NK.LE.KPBL)THEN                            <a name='1038'>
              UER(NK)=VMFLCL*DP(NK)/DPTHMX                   <a name='1039'>
              UMF(NK)=UMF(NK-1)+UER(NK)                     <a name='1040'>
            ELSE                                         <a name='1041'>
              UMF(NK)=VMFLCL                               <a name='1042'>
              UER(NK)=0.                                <a name='1043'>
            ENDIF                                         <a name='1044'>
            TU(NK)=TMIX+(Z0(NK)-ZMIX)*GDRY             <a name='1045'>
            QU(NK)=QMIX                               <a name='1046'>
            WU(NK)=WLCL                              <a name='1047'>
          ELSE                                      <a name='1048'>
            TU(NK)=0.                              <a name='1049'>
            QU(NK)=0.                                                      <a name='1050'>
            UMF(NK)=0.                                                    <a name='1051'>
            WU(NK)=0.                                                    <a name='1052'>
            UER(NK)=0.                                                  <a name='1053'>
          ENDIF                                                        <a name='1054'>
          UDR(NK)=0.                                                  <a name='1055'>
          QDT(NK)=0.                                                 <a name='1056'>
          QLIQ(NK)=0.                                               <a name='1057'>
          QICE(NK)=0.                                              <a name='1058'>
          QLQOUT(NK)=0.                                           <a name='1059'>
          QICOUT(NK)=0.                                          <a name='1060'>
          PPTLIQ(NK)=0.                                         <a name='1061'>
          PPTICE(NK)=0.                                        <a name='1062'>
          DETLQ(NK)=0.                                        <a name='1063'>
          DETIC(NK)=0.                                       <a name='1064'>
          RATIO2(NK)=0.                                    <a name='1065'>
          EE=Q0(NK)*P0(NK)/(EP2+Q0(NK))                 <a name='1066'>
          TLOG=ALOG(EE/ALIQ)                             <a name='1067'>
          TDPT=(CLIQ-DLIQ*TLOG)/(BLIQ-TLOG)             <a name='1068'>
          TSAT=TDPT-(.212+1.571E-3*(TDPT-T00)-4.36E-4*(T0(NK)-T00))*( &amp; <a name='1069'>
               T0(NK)-TDPT)                                                <a name='1070'>
          THTA=T0(NK)*(1.E5/P0(NK))**(0.2854*(1.-0.28*Q0(NK)))            <a name='1071'>
          THETEE(NK)=THTA*                                               &amp; <a name='1072'>
                     EXP((3374.6525/TSAT-2.5403)*Q0(NK)*(1.+0.81*Q0(NK)) &amp;<a name='1073'>
                     )                                                   <a name='1074'>
          THTES(NK)=THTA*                                                &amp;<a name='1075'>
                    EXP((3374.6525/T0(NK)-2.5403)*QES(NK)*(1.+0.81*      &amp;<a name='1076'>
                    QES(NK)))                          <a name='1077'>
          EQFRC(NK)=1.0                               <a name='1078'>
   90   CONTINUE                                     <a name='1079'>
<font color=#447700>!                                                   <a name='1080'></font>
        LTOP1=LTOP+1                               <a name='1081'>
        LTOPM1=LTOP-1                              <a name='1082'>
<font color=#447700>!                                                  <a name='1083'></font>
<font color=#447700>!...DEFINE VARIABLES ABOVE CLOUD TOP...            <a name='1084'></font>
<font color=#447700>!                                                             <a name='1085'></font>
        DO 95 NK=LTOP1,KX                                    <a name='1086'>
          UMF(NK)=0.                                        <a name='1087'>
          UDR(NK)=0.                                       <a name='1088'>
          UER(NK)=0.                                      <a name='1089'>
          QDT(NK)=0.                                     <a name='1090'>
          QLIQ(NK)=0.                                                     <a name='1091'>
          QICE(NK)=0.                                                    <a name='1092'>
          QLQOUT(NK)=0.                                                 <a name='1093'>
          QICOUT(NK)=0.                                                <a name='1094'>
          DETLQ(NK)=0.                                                <a name='1095'>
          DETIC(NK)=0.                                               <a name='1096'>
          PPTLIQ(NK)=0.                                             <a name='1097'>
          PPTICE(NK)=0.                                            <a name='1098'>
          IF(NK.GT.LTOP1)THEN                                     <a name='1099'>
            TU(NK)=0.                                            <a name='1100'>
            QU(NK)=0.                                           <a name='1101'>
            WU(NK)=0.                                          <a name='1102'>
          ENDIF                                              <a name='1103'>
          THTA0(NK)=0.                                      <a name='1104'>
          THTAU(NK)=0.                                     <a name='1105'>
          EMS(NK)=DP(NK)*DXSQ/G                           <a name='1106'>
          EMSD(NK)=1./EMS(NK)                            <a name='1107'>
          TG(NK)=T0(NK)                                 <a name='1108'>
          QG(NK)=Q0(NK)                                <a name='1109'>
          QLG(NK)=0.                                  <a name='1110'>
          QIG(NK)=0.                                 <a name='1111'>
          QRG(NK)=0.                                <a name='1112'>
          QSG(NK)=0.                               <a name='1113'>
   95   OMG(NK)=0.                                 <a name='1114'>
        OMG(KL+1)=0.                               <a name='1115'>
        P150=P0(KLCL)-1.50E4                       <a name='1116'>
        DO 100 NK=1,LTOP                           <a name='1117'>
          THTAD(NK)=0.                             <a name='1118'>
          EMS(NK)=DP(NK)*DXSQ/G                   <a name='1119'>
          EMSD(NK)=1./EMS(NK)                      <a name='1120'>
<font color=#447700>!                                                  <a name='1121'></font>
<font color=#447700>!...INITIALIZE SOME VARIABLES TO BE USED LATER IN THE VERT ADVECTION <a name='1122'></font>
<font color=#447700>!   SCHEME                                                          <a name='1123'></font>
<font color=#447700>!                                                                  <a name='1124'></font>
          EXN(NK)=(P00/P0(NK))**(0.2854*(1.-0.28*QDT(NK)))        <a name='1125'>
          THTAU(NK)=TU(NK)*EXN(NK)                               <a name='1126'>
          EXN(NK)=(P00/P0(NK))**(0.2854*(1.-0.28*Q0(NK)))       <a name='1127'>
          THTA0(NK)=T0(NK)*EXN(NK)                             <a name='1128'>
<font color=#447700>!                                                             <a name='1129'></font>
<font color=#447700>!...LVF IS THE LEVEL AT WHICH MOISTURE FLUX IS ESTIMATED AS THE BASIS <a name='1130'></font>
<font color=#447700>!...FOR PRECIPITATION EFFICIENCY CALCULATIONS...                     <a name='1131'></font>
<font color=#447700>!                                                                        <a name='1132'></font>
          IF(P0(NK).GT.P150)LVF=NK                                      <a name='1133'>
  100   OMG(NK)=0.                                                     <a name='1134'>
        LVF=MIN0(LVF,LET)                                             <a name='1135'>
        USR=UMF(LVF+1)*(QU(LVF+1)+QLIQ(LVF+1)+QICE(LVF+1))           <a name='1136'>
        USR=AMIN1(USR,TRPPT)                                        <a name='1137'>
        IF(USR.LT.1.E-8)USR=TRPPT<a name='1138'>
<font color=#447700>!                                                                  <a name='1139'></font>
<font color=#447700>!     WRITE(98,1025)KLCL,ZLCL,DTLCL,LTOP,P0(LTOP),IFLAG,          <a name='1140'></font>
<font color=#447700>!    * TMIX-T00,PMIX,QMIX,ABE                                    <a name='1141'></font>
<font color=#447700>!     WRITE(98,1030)P0(LET)/100.,P0(LTOP)/100.,VMFLCL,PLCL/100.,<a name='1142'></font>
<font color=#447700>!    * WLCL,CLDHGT                                             <a name='1143'></font>
<font color=#447700>!                                                             <a name='1144'></font>
<font color=#447700>!...COMPUTE CONVECTIVE TIME SCALE(TIMEC). THE MEAN WIND AT THE LCL     <a name='1145'></font>
<font color=#447700>!...AND MIDTROPOSPHERE IS USED.                                       <a name='1146'></font>
<font color=#447700>!                                                                    <a name='1147'></font>
        WSPD(KLCL)=SQRT(U0(KLCL)*U0(KLCL)+V0(KLCL)*V0(KLCL))        <a name='1148'>
        WSPD(L5)=SQRT(U0(L5)*U0(L5)+V0(L5)*V0(L5))                 <a name='1149'>
        WSPD(LTOP)=SQRT(U0(LTOP)*U0(LTOP)+V0(LTOP)*V0(LTOP))      <a name='1150'>
        VCONV=.5*(WSPD(KLCL)+WSPD(L5))                           <a name='1151'>
        if (VCONV .gt. 0.) then<a name='1152'>
           TIMEC=DX/VCONV<a name='1153'>
        else<a name='1154'>
           TIMEC=3600.<a name='1155'>
        endif<a name='1156'>
<font color=#447700>!       TIMEC=DX/VCONV<a name='1157'></font>
        TADVEC=TIMEC                                           <a name='1158'>
        TIMEC=AMAX1(1800.,TIMEC)                              <a name='1159'>
        TIMEC=AMIN1(3600.,TIMEC)                             <a name='1160'>
        NIC=NINT(TIMEC/DT)                            <a name='1161'>
        TIMEC=FLOAT(NIC)*DT                            <a name='1162'>
<font color=#447700>!                                                         <a name='1163'></font>
<font color=#447700>!...COMPUTE WIND SHEAR AND PRECIPITATION EFFICIENCY.     <a name='1164'></font>
<font color=#447700>!                                                       <a name='1165'></font>
<font color=#447700>!        SHSIGN = CVMGT(1.,-1.,WSPD(LTOP).GT.WSPD(KLCL))<a name='1166'></font>
        IF(WSPD(LTOP).GT.WSPD(KLCL))THEN               <a name='1167'>
          SHSIGN=1.                                   <a name='1168'>
        ELSE                                         <a name='1169'>
          SHSIGN=-1.                                <a name='1170'>
        ENDIF                                      <a name='1171'>
        VWS=(U0(LTOP)-U0(KLCL))*(U0(LTOP)-U0(KLCL))+(V0(LTOP)-V0(KLCL))* &amp; <a name='1172'>
            (V0(LTOP)-V0(KLCL))                                         <a name='1173'>
        VWS=1.E3*SHSIGN*SQRT(VWS)/(Z0(LTOP)-Z0(LCL))                   <a name='1174'>
        PEF=1.591+VWS*(-.639+VWS*(9.53E-2-VWS*4.96E-3))               <a name='1175'>
        PEF=AMAX1(PEF,.2)                                            <a name='1176'>
        PEF=AMIN1(PEF,.9)                                           <a name='1177'>
<font color=#447700>!                                                                  <a name='1178'></font>
<font color=#447700>!...PRECIPITATION EFFICIENCY IS A FUNCTION OF THE HEIGHT OF CLOUD BASE. <a name='1179'></font>
<font color=#447700>!                                                                      <a name='1180'></font>
        CBH=(ZLCL-Z0(1))*3.281E-3                                     <a name='1181'>
        IF(CBH.LT.3.)THEN                                            <a name='1182'>
          RCBH=.02                                                  <a name='1183'>
        ELSE                                                       <a name='1184'>
          RCBH=.96729352+CBH*(-.70034167+CBH*(.162179896+CBH*(-  &amp; <a name='1185'>
               1.2569798E-2+CBH*(4.2772E-4-CBH*5.44E-6))))    <a name='1186'>
        ENDIF                                                <a name='1187'>
        IF(CBH.GT.25)RCBH=2.4                               <a name='1188'>
        PEFCBH=1./(1.+RCBH)                                <a name='1189'>
        PEFCBH=AMIN1(PEFCBH,.9)                           <a name='1190'>
<font color=#447700>!                                                        <a name='1191'></font>
<font color=#447700>!... MEAN PEF. IS USED TO COMPUTE RAINFALL.                           <a name='1192'></font>
<font color=#447700>!                                                                    <a name='1193'></font>
        PEFF=.5*(PEF+PEFCBH)                                        <a name='1194'>
        PEFF2=PEFF                                                 <a name='1195'>
<font color=#447700>!        WRITE(98,1035)PEF,PEFCBH,LC,LET,WKL,VWS                  <a name='1196'></font>
<font color=#447700>!                                                                <a name='1197'></font>
<font color=#447700>!*****************************************************************   <a name='1198'></font>
<font color=#447700>!                                                                *  <a name='1199'></font>
<font color=#447700>!                  COMPUTE DOWNDRAFT PROPERTIES                  * <a name='1200'></font>
<font color=#447700>!                                                                *<a name='1201'></font>
<font color=#447700>!*****************************************************************         <a name='1202'></font>
<font color=#447700>!                                                                         <a name='1203'></font>
<font color=#447700>!...LET DOWNDRAFT ORIGINATE AT THE LEVEL OF MINIMUM SATURATION EQUIVALEN <a name='1204'></font>
<font color=#447700>!...POTENTIAL TEMPERATURE (SEQT) IN THE CLOUD LAYER, EXTEND DOWNWARD TO <a name='1205'></font>
<font color=#447700>!...SURFACE, OR TO THE LAYER BELOW CLOUD BASE AT WHICH ENVIR SEQT IS LES    <a name='1206'></font>
<font color=#447700>!...THAN MIN SEQT IN THE CLOUD LAYER...LET DOWNDRAFT DETRAIN OVER A LAYE   <a name='1207'></font>
<font color=#447700>!...OF SPECIFIED PRESSURE-DEPTH (DPDD)...                                 <a name='1208'></font>
<font color=#447700>!                                                                       <a name='1209'></font>
        TDER=0.                                                        <a name='1210'>
        KSTART=MAX0(KPBL,KLCL)                                        <a name='1211'>
        THTMIN=THTES(KSTART+1)                                       <a name='1212'>
        KMIN=KSTART+1                                               <a name='1213'>
        DO 104 NK=KSTART+2,LTOP-1                                  <a name='1214'>
          THTMIN=AMIN1(THTMIN,THTES(NK))                          <a name='1215'>
          IF(THTMIN.EQ.THTES(NK))KMIN=NK                         <a name='1216'>
  104   CONTINUE                                                <a name='1217'>
        LFS=KMIN                                               <a name='1218'>
        IF(RATIO2(LFS).GT.0.)CALL <A href='../../html_code/phys/module_cu_mskf.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_2">(P0(LFS),T0(LFS),Q0(LFS),     &amp;<a name='1219'>
          THETEE(LFS),0.,RL,EP2,ALIQ,BLIQ,CLIQ,DLIQ,AICE,BICE,CICE,DICE)   <a name='1220'>
        EQFRC(LFS)=(THTES(LFS)-THETEU(LFS))/(THETEE(LFS)-THETEU(LFS)) <a name='1221'>
        EQFRC(LFS)=AMAX1(EQFRC(LFS),0.)                              <a name='1222'>
        EQFRC(LFS)=AMIN1(EQFRC(LFS),1.)                             <a name='1223'>
        THETED(LFS)=THTES(LFS)                                     <a name='1224'>
<font color=#447700>!                                                                 <a name='1225'></font>
<font color=#447700>!...ESTIMATE THE EFFECT OF MELTING PRECIPITATION IN THE DOWNDRAFT...   <a name='1226'></font>
<font color=#447700>!                                                                            <a name='1227'></font>
        IF(ML.GT.0)THEN                                                    <a name='1228'>
          DTMLTD=0.5*(QU(KLCL)-QU(LTOP))*RLF/CP                          <a name='1229'>
        ELSE                                                            <a name='1230'>
          DTMLTD=0.                                                    <a name='1231'>
        ENDIF                                                         <a name='1232'>
        TZ(LFS)=T0(LFS)-DTMLTD                                       <a name='1233'>
        ES=ALIQ*EXP((TZ(LFS)*BLIQ-CLIQ)/(TZ(LFS)-DLIQ))             <a name='1234'>
        QS=EP2*ES/(P0(LFS)-ES)                                   <a name='1235'>
        QD(LFS)=EQFRC(LFS)*Q0(LFS)+(1.-EQFRC(LFS))*QU(LFS)             <a name='1236'>
        THTAD(LFS)=TZ(LFS)*(P00/P0(LFS))**(0.2854*(1.-0.28*QD(LFS)))     <a name='1237'>
        IF(QD(LFS).GE.QS)THEN                                           <a name='1238'>
          THETED(LFS)=THTAD(LFS)*                                       &amp; <a name='1239'>
                      EXP((3374.6525/TZ(LFS)-2.5403)*QS*(1.+0.81*QS))  <a name='1240'>
        ELSE                                                          <a name='1241'>
          CALL <A href='../../html_code/phys/module_cu_mskf.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_3">(P0(LFS),TZ(LFS),QD(LFS),THETED(LFS),0.,RL,EP2,ALIQ, &amp; <a name='1242'>
               BLIQ,CLIQ,DLIQ,AICE,BICE,CICE,DICE)                   <a name='1243'>
        ENDIF                                                       <a name='1244'>
        DO 107 NK=1,LFS                                            <a name='1245'>
          ND=LFS-NK                                             <a name='1246'>
          IF(THETED(LFS).GT.THTES(ND).OR.ND.EQ.1)THEN          <a name='1247'>
            LDB=ND                                            <a name='1248'>
<font color=#447700>!                                                            <a name='1249'></font>
<font color=#447700>!...IF DOWNDRAFT NEVER BECOMES NEGATIVELY BUOYANT OR IF IT  <a name='1250'></font>
<font color=#447700>!...IS SHALLOWER 50 mb, DON'T ALLOW IT TO OCCUR AT ALL...             <a name='1251'></font>
<font color=#447700>!                                                                    <a name='1252'></font>
            IF(NK.EQ.1.OR.(P0(LDB)-P0(LFS)).LT.50.E2)GOTO 141       <a name='1253'>
<font color=#447700>! testing ---- no downdraft<a name='1254'></font>
<font color=#447700>!           GOTO 141       <a name='1255'></font>
            GOTO 110                                               <a name='1256'>
          ENDIF                                                   <a name='1257'>
  107   CONTINUE                                                 <a name='1258'>
<font color=#447700>!                                                               <a name='1259'></font>
<font color=#447700>!...ALLOW DOWNDRAFT TO DETRAIN IN A SINGLE LAYER, BUT WITH DOWNDRAFT AIR <a name='1260'></font>
<font color=#447700>!...TYPICALLY FLUSHED UP INTO HIGHER LAYERS AS ALLOWED IN THE TOTAL     <a name='1261'></font>
<font color=#447700>!...VERTICAL ADVECTION CALCULATIONS FARTHER DOWN IN THE CODE...        <a name='1262'></font>
<font color=#447700>!                                                                     <a name='1263'></font>
  110   DPDD=DP(LDB)                                                 <a name='1264'>
        LDT=LDB                                                     <a name='1265'>
        FRC=1.                                                     <a name='1266'>
        DPT=0.                                                              <a name='1267'>
<font color=#447700>!      DO 115 NK=LDB,LFS                                                   <a name='1268'></font>
<font color=#447700>!        DPT=DPT+DP(NK)                                                   <a name='1269'></font>
<font color=#447700>!        IF(DPT.GT.DPDD)THEN                                             <a name='1270'></font>
<font color=#447700>!          LDT=NK                                                       <a name='1271'></font>
<font color=#447700>!          FRC=(DPDD+DP(NK)-DPT)/DP(NK)                                <a name='1272'></font>
<font color=#447700>!          GOTO 120                                                   <a name='1273'></font>
<font color=#447700>!        ENDIF                                                       <a name='1274'></font>
<font color=#447700>!        IF(NK.EQ.LFS-1)THEN                                        <a name='1275'></font>
<font color=#447700>!         LDT=NK                                                   <a name='1276'></font>
<font color=#447700>!        FRC=1.                                                   <a name='1277'></font>
<font color=#447700>!        DPDD=DPT                                                <a name='1278'></font>
<font color=#447700>!        GOTO 120                                               <a name='1279'></font>
<font color=#447700>!        ENDIF                                                 <a name='1280'></font>
<font color=#447700>!115   CONTINUE                                               <a name='1281'></font>
  120   CONTINUE                                             <a name='1282'>
<font color=#447700>!                                                           <a name='1283'></font>
<font color=#447700>!...TAKE A FIRST GUESS AT THE INITIAL DOWNDRAFT MASS FLUX..<a name='1284'></font>
<font color=#447700>!                                                         <a name='1285'></font>
        TVD(LFS)=T0(LFS)*(1.+0.608*QES(LFS))             <a name='1286'>
        RDD=P0(LFS)/(R*TVD(LFS))                        <a name='1287'>
        A1=(1.-PEFF)*AU0                               <a name='1288'>
        DMF(LFS)=-A1*RDD                              <a name='1289'>
        DER(LFS)=EQFRC(LFS)*DMF(LFS)                 <a name='1290'>
        DDR(LFS)=0.                                 <a name='1291'>
        DO 140 ND=LFS-1,LDB,-1                     <a name='1292'>
          ND1=ND+1                                 <a name='1293'>
          IF(ND.LE.LDT)THEN                        <a name='1294'>
            DER(ND)=0.                                              <a name='1295'>
            DDR(ND)=-DMF(LDT+1)*DP(ND)*FRC/DPDD                    <a name='1296'>
            DMF(ND)=DMF(ND1)+DDR(ND)                              <a name='1297'>
            FRC=1.                                               <a name='1298'>
            THETED(ND)=THETED(ND1)                              <a name='1299'>
            QD(ND)=QD(ND1)                                     <a name='1300'>
          ELSE                                                <a name='1301'>
            DER(ND)=DMF(LFS)*0.03*DP(ND)/RAD                 <a name='1302'>
            DDR(ND)=0.                                      <a name='1303'>
            DMF(ND)=DMF(ND1)+DER(ND)                       <a name='1304'>
            IF(RATIO2(ND).GT.0.)CALL <A href='../../html_code/phys/module_cu_mskf.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_4">(P0(ND),T0(ND),Q0(ND),      &amp; <a name='1305'>
              THETEE(ND),0.,RL,EP2,ALIQ,BLIQ,CLIQ,DLIQ,AICE,BICE,CICE,DICE)   <a name='1306'>
            THETED(ND)=(THETED(ND1)*DMF(ND1)+THETEE(ND)*DER(ND))/DMF(ND) <a name='1307'>
            QD(ND)=(QD(ND1)*DMF(ND1)+Q0(ND)*DER(ND))/DMF(ND)            <a name='1308'>
          ENDIF                                                        <a name='1309'>
  140   CONTINUE                                                      <a name='1310'>
        TDER=0.                                                      <a name='1311'>
<font color=#447700>!                                                                   <a name='1312'></font>
<font color=#447700>!...CALCULATION AN EVAPORATION RATE FOR GIVEN MASS FLUX...        <a name='1313'></font>
<font color=#447700>!                                                                <a name='1314'></font>
        DO 135 ND=LDB,LDT                                       <a name='1315'>
          TZ(ND)=                                                        &amp; <a name='1316'>
                 TPDD(P0(ND),THETED(LDT),T0(ND),QS,QD(ND),1.0,XLV0,XLV1, &amp;<a name='1317'>
                 EP2,ALIQ,BLIQ,CLIQ,DLIQ,AICE,BICE,CICE,DICE)      <a name='1318'>
          ES=ALIQ*EXP((TZ(ND)*BLIQ-CLIQ)/(TZ(ND)-DLIQ))        <a name='1319'>
          QS=EP2*ES/(P0(ND)-ES)                             <a name='1320'>
          DSSDT=(CLIQ-BLIQ*DLIQ)/((TZ(ND)-DLIQ)*(TZ(ND)-DLIQ))                <a name='1321'>
          RL=XLV0-XLV1*TZ(ND)                                                <a name='1322'>
          DTMP=RL*QS*(1.-RHBC)/(CP+RL*RHBC*QS*DSSDT)                        <a name='1323'>
          T1RH=TZ(ND)+DTMP                                                 <a name='1324'>
          ES=RHBC*ALIQ*EXP((BLIQ*T1RH-CLIQ)/(T1RH-DLIQ))                  <a name='1325'>
          QSRH=EP2*ES/(P0(ND)-ES)                                      <a name='1326'>
<font color=#447700>!                                                                       <a name='1327'></font>
<font color=#447700>!...CHECK TO SEE IF MIXING RATIO AT SPECIFIED RH IS LESS THAN ACTUAL   <a name='1328'></font>
<font color=#447700>!...MIXING RATIO...IF SO, ADJUST TO GIVE ZERO EVAPORATION...          <a name='1329'></font>
<font color=#447700>!                                                                    <a name='1330'></font>
          IF(QSRH.LT.QD(ND))THEN                                    <a name='1331'>
            QSRH=QD(ND)                                            <a name='1332'>
<font color=#447700>!          T1RH=T1+(QS-QSRH)*RL/CP                                <a name='1333'></font>
            T1RH=TZ(ND)                                          <a name='1334'>
          ENDIF                                                 <a name='1335'>
          TZ(ND)=T1RH                                          <a name='1336'>
          QS=QSRH                                             <a name='1337'>
          TDER=TDER+(QS-QD(ND))*DDR(ND)                     <a name='1338'>
          QD(ND)=QS                                                   <a name='1339'>
  135   THTAD(ND)=TZ(ND)*(P00/P0(ND))**(0.2854*(1.-0.28*QD(ND)))         <a name='1340'>
<font color=#447700>!                                                                       <a name='1341'></font>
<font color=#447700>!...IF DOWNDRAFT DOES NOT EVAPORATE ANY WATER FOR SPECIFIED RELATIVE   <a name='1342'></font>
<font color=#447700>!...HUMIDITY, NO DOWNDRAFT IS ALLOWED...                             <a name='1343'></font>
<font color=#447700>!                                                                   <a name='1344'></font>
  141   IF(TDER.LT.1.)THEN                                         <a name='1345'>
<font color=#447700>!          WRITE(98,3004)I,J                                      <a name='1346'></font>
 3004       FORMAT(' ','I=',I3,2X,'J=',I3)                       <a name='1347'>
          PPTFLX=TRPPT                                          <a name='1348'>
          CPR=TRPPT                                            <a name='1349'>
          TDER=0.                                             <a name='1350'>
          CNDTNF=0.                                          <a name='1351'>
          UPDINC=1.                                         <a name='1352'>
          LDB=LFS                                          <a name='1353'>
          DO 117 NDK=1,LTOP                               <a name='1354'>
            DMF(NDK)=0.                                                    <a name='1355'>
            DER(NDK)=0.                                  <a name='1356'>
            DDR(NDK)=0.                                 <a name='1357'>
            THTAD(NDK)=0.                              <a name='1358'>
            WD(NDK)=0.                                <a name='1359'>
            TZ(NDK)=0.                               <a name='1360'>
  117     QD(NDK)=0.                                <a name='1361'>
          AINCM2=100.                                                      <a name='1362'>
          GOTO 165                                                        <a name='1363'>
        ENDIF                                                            <a name='1364'>
<font color=#447700>!                                                                       <a name='1365'></font>
<font color=#447700>!...ADJUST DOWNDRAFT MASS FLUX SO THAT EVAPORATION RATE IN DOWNDRAFT IS<a name='1366'></font>
<font color=#447700>!...CONSISTENT WITH PRECIPITATION EFFICIENCY RELATIONSHIP...          <a name='1367'></font>
<font color=#447700>!                                                                    <a name='1368'></font>
        DEVDMF=TDER/DMF(LFS)                                        <a name='1369'>
        PPR=0.                                                     <a name='1370'>
        PPTFLX=PEFF*USR                                           <a name='1371'>
        RCED=TRPPT-PPTFLX                                        <a name='1372'>
<font color=#447700>!                                                               <a name='1373'></font>
<font color=#447700>!...PPR IS THE TOTAL AMOUNT OF PRECIPITATION THAT FALLS  OUT OF THE  <a name='1374'></font>
<font color=#447700>!...UPDRAFT FROM CLOUD BASE TO THE LFS...UPDRAFT MASS FLUX WILL BE  <a name='1375'></font>
<font color=#447700>!...INCREASED UP TO THE LFS TO ACCOUNT FOR UPDRAFT AIR MIXING WITH <a name='1376'></font>
<font color=#447700>!...ENVIRONMENTAL AIR TO THE UPDRAFT, SO PPR WILL INCREASE        <a name='1377'></font>
<font color=#447700>!...PROPORTIONATELY...                                           <a name='1378'></font>
<font color=#447700>!                                                               <a name='1379'></font>
        DO 132 NM=KLCL,LFS                                     <a name='1380'>
  132   PPR=PPR+PPTLIQ(NM)+PPTICE(NM)                         <a name='1381'>
        IF(LFS.GE.KLCL)THEN                                  <a name='1382'>
          DPPTDF=(1.-PEFF)*PPR*(1.-EQFRC(LFS))/UMF(LFS)     <a name='1383'>
        ELSE                                               <a name='1384'>
          DPPTDF=0.                                       <a name='1385'>
        ENDIF                                            <a name='1386'>
<font color=#447700>!                                                       <a name='1387'></font>
<font color=#447700>!...CNDTNF IS THE AMOUNT OF CONDENSATE TRANSFERRED ALONG WITH UPDRAFT      <a name='1388'></font>
<font color=#447700>!...MASS THE DOWNDRAFT AT THE LFS...                                      <a name='1389'></font>
<font color=#447700>!                                                                        <a name='1390'></font>
        CNDTNF=(QLIQ(LFS)+QICE(LFS))*(1.-EQFRC(LFS))                    <a name='1391'>
        DMFLFS=RCED/(DEVDMF+DPPTDF+CNDTNF)                             <a name='1392'>
        IF(DMFLFS.GT.0.)THEN                                         <a name='1393'>
          TDER=0.                                                   <a name='1394'>
          GOTO 141                                                 <a name='1395'>
        ENDIF                                                     <a name='1396'>
<font color=#447700>!                                                                <a name='1397'></font>
<font color=#447700>!...DDINC IS THE FACTOR BY WHICH TO INCREASE THE FIRST-GUESS DOWNDRAFT    <a name='1398'></font>
<font color=#447700>!...MASS FLUX TO SATISFY THE PRECIP EFFICIENCY RELATIONSHIP, UPDINC IS T <a name='1399'></font>
<font color=#447700>!...WHICH TO INCREASE THE UPDRAFT MASS FLUX BELOW THE LFS TO ACCOUNT FOR<a name='1400'></font>
<font color=#447700>!...TRANSFER OF MASS FROM UPDRAFT TO DOWNDRAFT...                     <a name='1401'></font>
<font color=#447700>!                                                                      <a name='1402'></font>
<font color=#447700>!       DDINC=DMFLFS/DMF(LFS)                                        <a name='1403'></font>
        IF(LFS.GE.KLCL)THEN                                         <a name='1404'>
          UPDINC=(UMF(LFS)-(1.-EQFRC(LFS))*DMFLFS)/UMF(LFS)        <a name='1405'>
<font color=#447700>!                                                                 <a name='1406'></font>
<font color=#447700>!...LIMIT UPDINC TO LESS THAN OR EQUAL TO 1.5...                 <a name='1407'></font>
<font color=#447700>!                                                                         <a name='1408'></font>
          IF(UPDINC.GT.1.5)THEN                                          <a name='1409'>
            UPDINC=1.5                                                  <a name='1410'>
            DMFLFS2=UMF(LFS)*(UPDINC-1.)/(EQFRC(LFS)-1.)               <a name='1411'>
            RCED2=DMFLFS2*(DEVDMF+DPPTDF+CNDTNF)                      <a name='1412'>
            PPTFLX=PPTFLX+(RCED-RCED2)                               <a name='1413'>
            PEFF2=PPTFLX/USR                                        <a name='1414'>
            RCED=RCED2                                             <a name='1415'>
            DMFLFS=DMFLFS2                                        <a name='1416'>
          ENDIF                                                  <a name='1417'>
        ELSE                                                    <a name='1418'>
          UPDINC=1.                                            <a name='1419'>
        ENDIF                                                 <a name='1420'>
        DDINC=DMFLFS/DMF(LFS)                                <a name='1421'>
        DO 149 NK=LDB,LFS                                   <a name='1422'>
          DMF(NK)=DMF(NK)*DDINC                            <a name='1423'>
          DER(NK)=DER(NK)*DDINC                           <a name='1424'>
          DDR(NK)=DDR(NK)*DDINC                          <a name='1425'>
  149   CONTINUE                                        <a name='1426'>
        CPR=TRPPT+PPR*(UPDINC-1.)                      <a name='1427'>
        PPTFLX=PPTFLX+PEFF*PPR*(UPDINC-1.)            <a name='1428'>
        PEFF=PEFF2                                   <a name='1429'>
        TDER=TDER*DDINC                             <a name='1430'>
<font color=#447700>!                                                                          <a name='1431'></font>
<font color=#447700>!...ADJUST UPDRAFT MASS FLUX, MASS DETRAINMENT RATE, AND LIQUID WATER AN  <a name='1432'></font>
<font color=#447700>!   DETRAINMENT RATES TO BE CONSISTENT WITH THE TRANSFER OF THE ESTIMATE <a name='1433'></font>
<font color=#447700>!   FROM THE UPDRAFT TO THE DOWNDRAFT AT THE LFS...                    <a name='1434'></font>
<font color=#447700>!                                                                     <a name='1435'></font>
        DO 155 NK=LC,LFS                                             <a name='1436'>
          UMF(NK)=UMF(NK)*UPDINC                                    <a name='1437'>
          UDR(NK)=UDR(NK)*UPDINC                                   <a name='1438'>
          UER(NK)=UER(NK)*UPDINC                                 <a name='1439'>
          PPTLIQ(NK)=PPTLIQ(NK)*UPDINC                          <a name='1440'>
          PPTICE(NK)=PPTICE(NK)*UPDINC                         <a name='1441'>
          DETLQ(NK)=DETLQ(NK)*UPDINC                          <a name='1442'>
  155   DETIC(NK)=DETIC(NK)*UPDINC                           <a name='1443'>
<font color=#447700>!                                                           <a name='1444'></font>
<font color=#447700>!...ZERO OUT THE ARRAYS FOR DOWNDRAFT DATA AT LEVELS ABOVE AND BELOW THE <a name='1445'></font>
<font color=#447700>!...DOWNDRAFT...                                                        <a name='1446'></font>
<font color=#447700>!                                                                           <a name='1447'></font>
        IF(LDB.GT.1)THEN                                                   <a name='1448'>
          DO 156 NK=1,LDB-1                                               <a name='1449'>
            DMF(NK)=0.                                                   <a name='1450'>
            DER(NK)=0.                                                  <a name='1451'>
            DDR(NK)=0.                                                 <a name='1452'>
            WD(NK)=0.                                                 <a name='1453'>
            TZ(NK)=0.                                                <a name='1454'>
            QD(NK)=0.                                               <a name='1455'>
            THTAD(NK)=0.                                           <a name='1456'>
  156     CONTINUE                                                <a name='1457'>
        ENDIF                                                    <a name='1458'>
        DO 157 NK=LFS+1,KX                                      <a name='1459'>
          DMF(NK)=0.                                           <a name='1460'>
          DER(NK)=0.                                          <a name='1461'>
          DDR(NK)=0.                                         <a name='1462'>
          WD(NK)=0.                                         <a name='1463'>
          TZ(NK)=0.                                        <a name='1464'>
          QD(NK)=0.                                      <a name='1465'>
          THTAD(NK)=0.                                  <a name='1466'>
  157   CONTINUE                                       <a name='1467'>
        DO 158 NK=LDT+1,LFS-1                         <a name='1468'>
          TZ(NK)=0.                                  <a name='1469'>
          QD(NK)=0.                                 <a name='1470'>
  158   CONTINUE                                    <a name='1471'>
<font color=#447700>!                                                                          <a name='1472'></font>
<font color=#447700>!                                                                      <a name='1473'></font>
<font color=#447700>!...SET LIMITS ON THE UPDRAFT AND DOWNDRAFT MASS FLUXES SO THAT THE   <a name='1474'></font>
<font color=#447700>!   INFLOW INTO CONVECTIVE DRAFTS FROM A GIVEN LAYER IS NO MORE THAN <a name='1475'></font>
<font color=#447700>!   IS AVAILABLE IN THAT LAYER INITIALLY...                         <a name='1476'></font>
<font color=#447700>!                                                                  <a name='1477'></font>
  165   AINCMX=1000.                                              <a name='1478'>
        LMAX=MAX0(KLCL,LFS)                                      <a name='1479'>
        DO 166 NK=LC,LMAX                                       <a name='1480'>
          IF((UER(NK)-DER(NK)).GT.0.)AINCM1=EMS(NK)/((UER(NK)-DER(NK))* &amp; <a name='1481'>
            TIMEC)                                             <a name='1482'>
          AINCMX=AMIN1(AINCMX,AINCM1)                         <a name='1483'>
  166   CONTINUE                                             <a name='1484'>
        AINC=1.                                             <a name='1485'>
        IF(AINCMX.LT.AINC)AINC=AINCMX                      <a name='1486'>
<font color=#447700>!                                                         <a name='1487'></font>
<font color=#447700>!...SAVE THE RELEVENT VARIABLES FOR A UNIT UPDRFT AND DOWNDRFT...THEY    <a name='1488'></font>
<font color=#447700>!...WILL ITERATIVELY ADJUSTED BY THE FACTOR AINC TO SATISFY THE         <a name='1489'></font>
<font color=#447700>!...STABILIZATION CLOSURE...                                           <a name='1490'></font>
<font color=#447700>!                                                                         <a name='1491'></font>
        NCOUNT=0                                                         <a name='1492'>
        TDER2=TDER                                                      <a name='1493'>
        PPTFL2=PPTFLX                                                  <a name='1494'>
        DO 170 NK=1,LTOP                                              <a name='1495'>
          DETLQ2(NK)=DETLQ(NK)                                       <a name='1496'>
          DETIC2(NK)=DETIC(NK)                                      <a name='1497'>
          UDR2(NK)=UDR(NK)                                         <a name='1498'>
          UER2(NK)=UER(NK)                                        <a name='1499'>
          DDR2(NK)=DDR(NK)                                       <a name='1500'>
          DER2(NK)=DER(NK)                                      <a name='1501'>
          UMF2(NK)=UMF(NK)                                     <a name='1502'>
          DMF2(NK)=DMF(NK)                                    <a name='1503'>
  170   CONTINUE                                             <a name='1504'>
        FABE=1.                                             <a name='1505'>
        STAB=0.95                                          <a name='1506'>
        NOITR=0                                           <a name='1507'>
        IF(AINC/AINCMX.GT.0.999)THEN                     <a name='1508'>
          NCOUNT=0                                      <a name='1509'>
          GOTO 255                                     <a name='1510'>
        ENDIF                                        <a name='1511'>
        ISTOP=0                                     <a name='1512'>
  175   NCOUNT=NCOUNT+1                             <a name='1513'>
<font color=#447700>!                                                   <a name='1514'></font>
<font color=#447700>!*****************************************************************         <a name='1515'></font>
<font color=#447700>!                                                                *        <a name='1516'></font>
<font color=#447700>!           COMPUTE PROPERTIES FOR COMPENSATIONAL SUBSIDENCE     *       <a name='1517'></font>
<font color=#447700>!                                                                *      <a name='1518'></font>
<font color=#447700>!*****************************************************************     <a name='1519'></font>
<font color=#447700>!                                                                     <a name='1520'></font>
<font color=#447700>!...DETERMINE OMEGA VALUE NECESSARY AT TOP AND BOTTOM OF EACH LAYER TO    <a name='1521'></font>
<font color=#447700>!...SATISFY MASS CONTINUITY...                                           <a name='1522'></font>
<font color=#447700>!                                                                       <a name='1523'></font>
  185   CONTINUE                                                       <a name='1524'>
        DTT=TIMEC                                                     <a name='1525'>
        DO 200 NK=1,LTOP                                             <a name='1526'>
          DOMGDP(NK)=-(UER(NK)-DER(NK)-UDR(NK)-DDR(NK))*EMSD(NK)    <a name='1527'>
          IF(NK.GT.1)THEN                                          <a name='1528'>
            OMG(NK)=OMG(NK-1)-DP(NK-1)*DOMGDP(NK-1)               <a name='1529'>
            DTT1=0.75*DP(NK-1)/(ABS(OMG(NK))+1.E-10)             <a name='1530'>
            DTT=AMIN1(DTT,DTT1)                                 <a name='1531'>
          ENDIF                                                        <a name='1532'>
  200   CONTINUE                                                      <a name='1533'>
        DO 488 NK=1,LTOP                                             <a name='1534'>
          THPA(NK)=THTA0(NK)                                        <a name='1535'>
          QPA(NK)=Q0(NK)                                           <a name='1536'>
          NSTEP=NINT(TIMEC/DTT+1)                                 <a name='1537'>
          DTIME=TIMEC/FLOAT(NSTEP)                              <a name='1538'>
          FXM(NK)=OMG(NK)*DXSQ/G                               <a name='1539'>
  488   CONTINUE                                              <a name='1540'>
<font color=#447700>!                                                            <a name='1541'></font>
<font color=#447700>!...DO AN UPSTREAM/FORWARD-IN-TIME ADVECTION OF THETA, QV...<a name='1542'></font>
<font color=#447700>!                                                          <a name='1543'></font>
        DO 495 NTC=1,NSTEP                                <a name='1544'>
<font color=#447700>!                                                        <a name='1545'></font>
<font color=#447700>!...ASSIGN THETA AND Q VALUES AT THE TOP AND BOTTOM OF EACH LAYER BASED   <a name='1546'></font>
<font color=#447700>!...SIGN OF OMEGA...                                                     <a name='1547'></font>
<font color=#447700>!                                                                       <a name='1548'></font>
          DO 493 NK=1,LTOP                                             <a name='1549'>
            THFXTOP(NK)=0.                                             <a name='1550'>
            THFXBOT(NK)=0.                                           <a name='1551'>
            QFXTOP(NK)=0.                                            <a name='1552'>
  493     QFXBOT(NK)=0.                                            <a name='1553'>
          DO 494 NK=2,LTOP<a name='1554'>
            IF(OMG(NK).LE.0.)THEN<a name='1555'>
              THFXBOT(NK)=-FXM(NK)*THPA(NK-1)<a name='1556'>
              QFXBOT(NK)=-FXM(NK)*QPA(NK-1)<a name='1557'>
              THFXTOP(NK-1)=THFXTOP(NK-1)-THFXBOT(NK)<a name='1558'>
              QFXTOP(NK-1)=QFXTOP(NK-1)-QFXBOT(NK)<a name='1559'>
            ELSE<a name='1560'>
              THFXBOT(NK)=-FXM(NK)*THPA(NK)<a name='1561'>
              QFXBOT(NK)=-FXM(NK)*QPA(NK)<a name='1562'>
              THFXTOP(NK-1)=THFXTOP(NK-1)-THFXBOT(NK)<a name='1563'>
              QFXTOP(NK-1)=QFXTOP(NK-1)-QFXBOT(NK)<a name='1564'>
            ENDIF<a name='1565'>
  494     CONTINUE<a name='1566'>
<font color=#447700>!                                                   <a name='1567'></font>
<font color=#447700>!...UPDATE THE THETA AND QV VALUES AT EACH LEVEL..  <a name='1568'></font>
<font color=#447700>!                                                       <a name='1569'></font>
          DO 492 NK=1,LTOP                             <a name='1570'>
            THPA(NK)=THPA(NK)+(THFXBOT(NK)+UDR(NK)*THTAU(NK)+DDR(NK)*     &amp; <a name='1571'>
                     THTAD(NK)+THFXTOP(NK)-(UER(NK)-DER(NK))*THTA0(NK))* &amp;<a name='1572'>
                     DTIME*EMSD(NK)                                     <a name='1573'>
            QPA(NK)=QPA(NK)+(QFXBOT(NK)+UDR(NK)*QDT(NK)+DDR(NK)*QD(NK)+   &amp; <a name='1574'>
                    QFXTOP(NK)-(UER(NK)-DER(NK))*Q0(NK))*DTIME*EMSD(NK)  <a name='1575'>
<a name='1576'>
  492     CONTINUE                                                     <a name='1577'>
  495   CONTINUE                                                      <a name='1578'>
        DO 498 NK=1,LTOP                                             <a name='1579'>
          THTAG(NK)=THPA(NK)                                        <a name='1580'>
          QG(NK)=QPA(NK)                                           <a name='1581'>
  498   CONTINUE                                                  <a name='1582'>
<font color=#447700>!                                                                <a name='1583'></font>
<font color=#447700>!...CHECK TO SEE IF MIXING RATIO DIPS BELOW ZERO ANYWHERE;  IF SO,        <a name='1584'></font>
<font color=#447700>!...BORROW MOISTURE FROM ADJACENT LAYERS TO BRING IT BACK UP ABOVE ZERO. <a name='1585'></font>
<font color=#447700>!                                                                       <a name='1586'></font>
        DO 499 NK=1,LTOP                                               <a name='1587'>
          IF(QG(NK).LT.0.)THEN                                        <a name='1588'>
            IF(NK.EQ.1)THEN                                          <a name='1589'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_602"> ( 'module_cu_kf.F: problem with kf scheme:  qg = 0 at the surface' )<a name='1590'>
            ENDIF                                                <a name='1591'>
            NK1=NK+1                                            <a name='1592'>
            IF(NK.EQ.LTOP)NK1=KLCL                             <a name='1593'>
            TMA=QG(NK1)*EMS(NK1)                              <a name='1594'>
            TMB=QG(NK-1)*EMS(NK-1)                           <a name='1595'>
            TMM=(QG(NK)-1.E-9)*EMS(NK)                      <a name='1596'>
            BCOEFF=-TMM/((TMA*TMA)/TMB+TMB)                <a name='1597'>
            ACOEFF=BCOEFF*TMA/TMB                         <a name='1598'>
            TMB=TMB*(1.-BCOEFF)                          <a name='1599'>
            TMA=TMA*(1.-ACOEFF)                         <a name='1600'>
            IF(NK.EQ.LTOP)THEN                                  <a name='1601'>
              QVDIFF=(QG(NK1)-TMA*EMSD(NK1))*100./QG(NK1)     <a name='1602'>
              IF(ABS(QVDIFF).GT.1.)THEN                        <a name='1603'>
            PRINT *,'--WARNING-- CLOUD BASE WATER VAPOR CHANGES BY ',    &amp; <a name='1604'>
            QVDIFF,                                                      &amp;<a name='1605'>
             ' PERCENT WHEN MOISTURE IS BORROWED TO PREVENT NEG VALUES', &amp;   <a name='1606'>
             ' IN KAIN-FRITSCH'                                             <a name='1607'>
              ENDIF                                                         <a name='1608'>
            ENDIF                                                          <a name='1609'>
            QG(NK)=1.E-9                                                  <a name='1610'>
            QG(NK1)=TMA*EMSD(NK1)                                        <a name='1611'>
            QG(NK-1)=TMB*EMSD(NK-1)                                     <a name='1612'>
          ENDIF                                                           <a name='1613'>
  499   CONTINUE                                                         <a name='1614'>
        TOPOMG=(UDR(LTOP)-UER(LTOP))*DP(LTOP)*EMSD(LTOP)                <a name='1615'>
        IF(ABS(TOPOMG-OMG(LTOP)).GT.1.E-3)THEN                         <a name='1616'>
<font color=#447700>!       WRITE(98,*)'ERROR:  MASS DOES NOT BALANCE IN KF SCHEME;'      <a name='1617'></font>
<font color=#447700>!    * ,'TOPOMG, OMG =',TOPOMG,OMG(LTOP)                             <a name='1618'></font>
        WRITE(6,*)'ERROR:  MASS DOES NOT BALANCE IN KF SCHEME;'        &amp; <a name='1619'>
       ,'TOPOMG, OMG =',TOPOMG,OMG(LTOP)                            <a name='1620'>
          ISTOP=1                                                  <a name='1621'>
          GOTO 265                                                <a name='1622'>
        ENDIF                                                    <a name='1623'>
<font color=#447700>!                                                               <a name='1624'></font>
<font color=#447700>!...CONVERT THETA TO T...                                      <a name='1625'></font>
<font color=#447700>!                                                             <a name='1626'></font>
<font color=#447700>! PAY ATTENTION ...<a name='1627'></font>
<font color=#447700>!<a name='1628'></font>
        DO 230 NK=1,LTOP                                     <a name='1629'>
          EXN(NK)=(P00/P0(NK))**(0.2854*(1.-0.28*QG(NK)))   <a name='1630'>
          TG(NK)=THTAG(NK)/EXN(NK)                         <a name='1631'>
          TVG(NK)=TG(NK)*(1.+0.608*QG(NK))                <a name='1632'>
  230   CONTINUE                                         <a name='1633'>
<font color=#447700>!                                                       <a name='1634'></font>
<font color=#447700>!*******************************************************************    <a name='1635'></font>
<font color=#447700>!                                                                  *   <a name='1636'></font>
<font color=#447700>!     COMPUTE NEW CLOUD AND CHANGE IN AVAILABLE BUOYANT ENERGY.    *  <a name='1637'></font>
<font color=#447700>!                                                                  * <a name='1638'></font>
<font color=#447700>!*******************************************************************<a name='1639'></font>
<font color=#447700>!                                                                  <a name='1640'></font>
<font color=#447700>!...THE FOLLOWING COMPUTATIONS ARE SIMILAR TO THAT FOR UPDRAFT    <a name='1641'></font>
<font color=#447700>!                                                                <a name='1642'></font>
        THMIX=0.                                                <a name='1643'>
        QMIX=0.                                                <a name='1644'>
        PMIX=0.                                               <a name='1645'>
        DO 217 NK=LC,KPBL                                    <a name='1646'>
          ROCPQ=0.2854*(1.-0.28*QG(NK))                     <a name='1647'>
          THMIX=THMIX+DP(NK)*TG(NK)*(P00/P0(NK))**ROCPQ    <a name='1648'>
          QMIX=QMIX+DP(NK)*QG(NK)                         <a name='1649'>
  217   PMIX=PMIX+DP(NK)*P0(NK)                          <a name='1650'>
        THMIX=THMIX/DPTHMX                              <a name='1651'>
        QMIX=QMIX/DPTHMX                              <a name='1652'>
        PMIX=PMIX/DPTHMX                             <a name='1653'>
        ROCPQ=0.2854*(1.-0.28*QMIX)                 <a name='1654'>
        TMIX=THMIX*(PMIX/P00)**ROCPQ                <a name='1655'>
        ES=ALIQ*EXP((TMIX*BLIQ-CLIQ)/(TMIX-DLIQ))                           <a name='1656'>
        QS=EP2*ES/(PMIX-ES)                                              <a name='1657'>
<font color=#447700>!                                                                         <a name='1658'></font>
<font color=#447700>!...REMOVE SUPERSATURATION FOR DIAGNOSTIC PURPOSES, IF NECESSARY...      <a name='1659'></font>
<font color=#447700>!                                                                       <a name='1660'></font>
        IF(QMIX.GT.QS)THEN                                             <a name='1661'>
          RL=XLV0-XLV1*TMIX                                          <a name='1662'>
          CPM=CP*(1.+0.887*QMIX)                                    <a name='1663'>
          DSSDT=QS*(CLIQ-BLIQ*DLIQ)/((TMIX-DLIQ)*(TMIX-DLIQ))      <a name='1664'>
          DQ=(QMIX-QS)/(1.+RL*DSSDT/CPM)                          <a name='1665'>
          TMIX=TMIX+RL/CP*DQ                                     <a name='1666'>
          QMIX=QMIX-DQ                                          <a name='1667'>
          ROCPQ=0.2854*(1.-0.28*QMIX)                          <a name='1668'>
          THMIX=TMIX*(P00/PMIX)**ROCPQ                        <a name='1669'>
          TLCL=TMIX                                          <a name='1670'>
          PLCL=PMIX                                         <a name='1671'>
        ELSE                                               <a name='1672'>
          QMIX=AMAX1(QMIX,0.)                             <a name='1673'>
          EMIX=QMIX*PMIX/(EP2+QMIX)                    <a name='1674'>
          TLOG=ALOG(EMIX/ALIQ)                          <a name='1675'>
          TDPT=(CLIQ-DLIQ*TLOG)/(BLIQ-TLOG)            <a name='1676'>
          TLCL=TDPT-(.212+1.571E-3*(TDPT-T00)-4.36E-4*(TMIX-T00))*(TMIX-  &amp; <a name='1677'>
               TDPT)                                                      <a name='1678'>
          TLCL=AMIN1(TLCL,TMIX)                                          <a name='1679'>
          CPORQ=1./ROCPQ                                                <a name='1680'>
          PLCL=P00*(TLCL/THMIX)**CPORQ                                 <a name='1681'>
        ENDIF                                                         <a name='1682'>
        TVLCL=TLCL*(1.+0.608*QMIX)                                   <a name='1683'>
        DO 235 NK=LC,KL                                             <a name='1684'>
          KLCL=NK                                                 <a name='1685'>
  235   IF(PLCL.GE.P0(NK))GOTO 240                               <a name='1686'>
  240   K=KLCL-1                                                <a name='1687'>
        DLP=ALOG(PLCL/P0(K))/ALOG(P0(KLCL)/P0(K))              <a name='1688'>
<font color=#447700>!                                                             <a name='1689'></font>
<font color=#447700>!...ESTIMATE ENVIRONMENTAL TEMPERATURE AND MIXING RATIO AT THE LCL...<a name='1690'></font>
<font color=#447700>!                                                                          <a name='1691'></font>
        TENV=TG(K)+(TG(KLCL)-TG(K))*DLP                                   <a name='1692'>
        QENV=QG(K)+(QG(KLCL)-QG(K))*DLP                                  <a name='1693'>
        TVEN=TENV*(1.+0.608*QENV)                                       <a name='1694'>
        TVBAR=0.5*(TVG(K)+TVEN)                                        <a name='1695'>
<font color=#447700>!        ZLCL=Z0(K)+R*TVBAR*ALOG(P0(K)/PLCL)/G                        <a name='1696'></font>
        ZLCL=Z0(K)+(Z0(KLCL)-Z0(K))*DLP                                     <a name='1697'>
        TVAVG=0.5*(TVEN+TG(KLCL)*(1.+0.608*QG(KLCL)))                      <a name='1698'>
        PLCL=P0(KLCL)*EXP(G/(R*TVAVG)*(Z0(KLCL)-ZLCL))                    <a name='1699'>
        THETEU(K)=TMIX*(1.E5/PMIX)**(0.2854*(1.-0.28*QMIX))*            &amp; <a name='1700'>
                  EXP((3374.6525/TLCL-2.5403)*QMIX*(1.+0.81*QMIX))      <a name='1701'>
        ES=ALIQ*EXP((TENV*BLIQ-CLIQ)/(TENV-DLIQ))                        <a name='1702'>
        QESE=EP2*ES/(PLCL-ES)                                              <a name='1703'>
        THTESG(K)=TENV*(1.E5/PLCL)**(0.2854*(1.-0.28*QESE))*            &amp;<a name='1704'>
                  EXP((3374.6525/TENV-2.5403)*QESE*(1.+0.81*QESE))       <a name='1705'>
<font color=#447700>!                                                                           <a name='1706'></font>
<font color=#447700>!...COMPUTE ADJUSTED ABE(ABEG).                                            <a name='1707'></font>
<font color=#447700>!                                                                         <a name='1708'></font>
        ABEG=0.                                                         <a name='1709'>
        THTUDL=THETEU(K)                                               <a name='1710'>
        DO 245 NK=K,LTOPM1                                            <a name='1711'>
          NK1=NK+1                                                   <a name='1712'>
          ES=ALIQ*EXP((TG(NK1)*BLIQ-CLIQ)/(TG(NK1)-DLIQ))                    <a name='1713'>
          QESE=EP2*ES/(P0(NK1)-ES)                                        <a name='1714'>
          THTESG(NK1)=TG(NK1)*(1.E5/P0(NK1))**(0.2854*(1.-0.28*QESE))*    &amp; <a name='1715'>
                      EXP((3374.6525/TG(NK1)-2.5403)*QESE*(1.+0.81*QESE)  &amp; <a name='1716'>
                      )                                                     <a name='1717'>
<font color=#447700>!         DZZ=CVMGT(Z0(KLCL)-ZLCL,DZA(NK),NK.EQ.K)                         <a name='1718'></font>
          IF(NK.EQ.K)THEN                                                 <a name='1719'>
            DZZ=Z0(KLCL)-ZLCL                                            <a name='1720'>
          ELSE                                                          <a name='1721'>
            DZZ=DZA(NK)                                                <a name='1722'>
          ENDIF                                                       <a name='1723'>
          BE=((2.*THTUDL)/(THTESG(NK1)+THTESG(NK))-1.)*DZZ           <a name='1724'>
  245   IF(BE.GT.0.)ABEG=ABEG+BE*G                                  <a name='1725'>
<font color=#447700>!                                                                  <a name='1726'></font>
<font color=#447700>!...ASSUME AT LEAST 90% OF CAPE (ABE) IS REMOVED BY CONVECTION DURING     <a name='1727'></font>
<font color=#447700>!...THE PERIOD TIMEC...                                                  <a name='1728'></font>
<font color=#447700>!                                                                       <a name='1729'></font>
        IF(NOITR.EQ.1)THEN                                             <a name='1730'>
<font color=#447700>!        WRITE(98,1060)FABE                                           <a name='1731'></font>
          GOTO 265                                                   <a name='1732'>
        ENDIF                                                       <a name='1733'>
        DABE=AMAX1(ABE-ABEG,0.1*ABE)                               <a name='1734'>
        FABE=ABEG/(ABE+1.E-8)                                    <a name='1735'>
        IF(FABE.GT.1.)THEN                                                <a name='1736'>
<font color=#447700>!       WRITE(98,*)'UPDRAFT/DOWNDRAFT COUPLET INCREASES CAPE AT THIS '   <a name='1737'></font>
<font color=#447700>!    *,'GRID POINT; NO CONVECTION ALLOWED!'                             <a name='1738'></font>
          GOTO 325                                                     <a name='1739'>
        ENDIF                                                         <a name='1740'>
        IF(NCOUNT.NE.1)THEN                                          <a name='1741'>
          DFDA=(FABE-FABEOLD)/(AINC-AINCOLD)                        <a name='1742'>
          IF(DFDA.GT.0.)THEN                                       <a name='1743'>
            NOITR=1                                               <a name='1744'>
            AINC=AINCOLD                                         <a name='1745'>
            GOTO 255                                            <a name='1746'>
          ENDIF                                                <a name='1747'>
        ENDIF                                                 <a name='1748'>
        AINCOLD=AINC                                         <a name='1749'>
        FABEOLD=FABE                                        <a name='1750'>
        IF(AINC/AINCMX.GT.0.999.AND.FABE.GT.1.05-STAB)THEN <a name='1751'>
<font color=#447700>!      WRITE(98,1055)FABE                                             <a name='1752'></font>
          GOTO 265                                                   <a name='1753'>
        ENDIF                                                       <a name='1754'>
        IF(FABE.LE.1.05-STAB.AND.FABE.GE.0.95-STAB)GOTO 265        <a name='1755'>
        IF(NCOUNT.GT.10)THEN                                      <a name='1756'>
<font color=#447700>!       WRITE(98,1060)FABE                                       <a name='1757'></font>
          GOTO 265                                              <a name='1758'>
        ENDIF                                                  <a name='1759'>
<font color=#447700>!                                                                             <a name='1760'></font>
<font color=#447700>!...IF MORE THAN 10% OF THE ORIGINAL CAPE REMAINS, INCREASE THE              <a name='1761'></font>
<font color=#447700>!...CONVECTIVE MASS FLUX BY THE FACTOR AINC:                                <a name='1762'></font>
<font color=#447700>!                                                                          <a name='1763'></font>
        IF(FABE.EQ.0.)THEN                                               <a name='1764'>
          AINC=AINC*0.5                                                 <a name='1765'>
        ELSE                                                           <a name='1766'>
          AINC=AINC*STAB*ABE/(DABE+1.E-8)                             <a name='1767'>
        ENDIF                                                        <a name='1768'>
  255   AINC=AMIN1(AINCMX,AINC)                                     <a name='1769'>
<font color=#447700>!...IF AINC BECOMES VERY SMALL, EFFECTS OF CONVECTION              <a name='1770'></font>
<font color=#447700>!...WILL BE MINIMAL SO JUST IGNORE IT...                          <a name='1771'></font>
        IF(AINC.LT.0.05)GOTO 325                                 <a name='1772'>
<font color=#447700>!       AINC=AMAX1(AINC,0.05)                                   <a name='1773'></font>
        TDER=TDER2*AINC                                        <a name='1774'>
        PPTFLX=PPTFL2*AINC                                    <a name='1775'>
<font color=#447700>!     WRITE(98,1080)LFS,LDB,LDT,TIMEC,NSTEP,NCOUNT,FABEOLD,AINCOLD     <a name='1776'></font>
        DO 260 NK=1,LTOP                                              <a name='1777'>
          UMF(NK)=UMF2(NK)*AINC                                      <a name='1778'>
          DMF(NK)=DMF2(NK)*AINC                                     <a name='1779'>
          DETLQ(NK)=DETLQ2(NK)*AINC                                <a name='1780'>
          DETIC(NK)=DETIC2(NK)*AINC                               <a name='1781'>
          UDR(NK)=UDR2(NK)*AINC                                  <a name='1782'>
          UER(NK)=UER2(NK)*AINC                                 <a name='1783'>
          DER(NK)=DER2(NK)*AINC                                <a name='1784'>
          DDR(NK)=DDR2(NK)*AINC                               <a name='1785'>
  260   CONTINUE                                             <a name='1786'>
<font color=#447700>!                                                           <a name='1787'></font>
<font color=#447700>!...GO BACK UP FOR ANOTHER ITERATION...                    <a name='1788'></font>
<font color=#447700>!                                                         <a name='1789'></font>
        GOTO 175                                         <a name='1790'>
  265   CONTINUE                                        <a name='1791'>
<a name='1792'>
<font color=#447700>!kf_edrates<a name='1793'></font>
<font color=#447700>!Save up/down entrainment/detrainment rates as 3D variables<a name='1794'></font>
        IF (KF_EDRATES == 1) THEN<a name='1795'>
           DO NK=1,LTOP<a name='1796'>
             UDR_KF(I,NK,J)=UDR(NK)<a name='1797'>
             DDR_KF(I,NK,J)=DDR(NK)<a name='1798'>
             UER_KF(I,NK,J)=UER(NK)<a name='1799'>
             DER_KF(I,NK,J)=DER(NK)<a name='1800'>
           ENDDO<a name='1801'>
        ENDIF<a name='1802'>
<a name='1803'>
<font color=#447700>!                                                      <a name='1804'></font>
<font color=#447700>!...CLEAN THINGS UP, CALCULATE CONVECTIVE FEEDBACK TENDENCIES FOR THIS    <a name='1805'></font>
<font color=#447700>!...GRID POINT...                                                        <a name='1806'></font>
<font color=#447700>!                                                                       <a name='1807'></font>
<font color=#447700>!...COMPUTE HYDROMETEOR TENDENCIES AS IS DONE FOR T, QV...             <a name='1808'></font>
<font color=#447700>!                                                                     <a name='1809'></font>
<font color=#447700>!...FRC2 IS THE FRACTION OF TOTAL CONDENSATE                         <a name='1810'></font>
<font color=#447700>!...GENERATED THAT GOES INTO PRECIPITIATION                         <a name='1811'></font>
        FRC2=PPTFLX/(CPR*AINC)                                     <a name='1812'>
        DO 270 NK=1,LTOP                                          <a name='1813'>
          QLPA(NK)=QL0(NK)                                       <a name='1814'>
          QIPA(NK)=QI0(NK)                                      <a name='1815'>
          QRPA(NK)=QR0(NK)                                     <a name='1816'>
          QSPA(NK)=QS0(NK)                                    <a name='1817'>
          RAINFB(NK)=PPTLIQ(NK)*AINC*FBFRC*FRC2                         <a name='1818'>
          SNOWFB(NK)=PPTICE(NK)*AINC*FBFRC*FRC2                        <a name='1819'>
  270   CONTINUE                                                      <a name='1820'>
        DO 290 NTC=1,NSTEP                                           <a name='1821'>
<font color=#447700>!                                                                   <a name='1822'></font>
<font color=#447700>!...ASSIGN HYDROMETEORS CONCENTRATIONS AT THE TOP AND BOTTOM OF EACH <a name='1823'></font>
<font color=#447700>!...LAYER BASED ON THE SIGN OF OMEGA...                             <a name='1824'></font>
<font color=#447700>!                                                                  <a name='1825'></font>
          DO 275 NK=1,LTOP                                        <a name='1826'>
            QLFXIN(NK)=0.                                        <a name='1827'>
            QLFXOUT(NK)=0.                                      <a name='1828'>
            QIFXIN(NK)=0.                                      <a name='1829'>
            QIFXOUT(NK)=0.                                    <a name='1830'>
            QRFXIN(NK)=0.                                    <a name='1831'>
            QRFXOUT(NK)=0.                                  <a name='1832'>
            QSFXIN(NK)=0.                                  <a name='1833'>
            QSFXOUT(NK)=0.                               <a name='1834'>
  275     CONTINUE                                                     <a name='1835'>
          DO 280 NK=2,LTOP                                            <a name='1836'>
            IF(OMG(NK).LE.0.)THEN                                    <a name='1837'>
              QLFXIN(NK)=-FXM(NK)*QLPA(NK-1)                        <a name='1838'>
              QIFXIN(NK)=-FXM(NK)*QIPA(NK-1)                       <a name='1839'>
              QRFXIN(NK)=-FXM(NK)*QRPA(NK-1)                      <a name='1840'>
              QSFXIN(NK)=-FXM(NK)*QSPA(NK-1)                     <a name='1841'>
              QLFXOUT(NK-1)=QLFXOUT(NK-1)+QLFXIN(NK)            <a name='1842'>
              QIFXOUT(NK-1)=QIFXOUT(NK-1)+QIFXIN(NK)           <a name='1843'>
              QRFXOUT(NK-1)=QRFXOUT(NK-1)+QRFXIN(NK)          <a name='1844'>
              QSFXOUT(NK-1)=QSFXOUT(NK-1)+QSFXIN(NK)         <a name='1845'>
            ELSE                                            <a name='1846'>
              QLFXOUT(NK)=FXM(NK)*QLPA(NK)                 <a name='1847'>
              QIFXOUT(NK)=FXM(NK)*QIPA(NK)                <a name='1848'>
              QRFXOUT(NK)=FXM(NK)*QRPA(NK)               <a name='1849'>
              QSFXOUT(NK)=FXM(NK)*QSPA(NK)             <a name='1850'>
              QLFXIN(NK-1)=QLFXIN(NK-1)+QLFXOUT(NK)   <a name='1851'>
              QIFXIN(NK-1)=QIFXIN(NK-1)+QIFXOUT(NK)                      <a name='1852'>
              QRFXIN(NK-1)=QRFXIN(NK-1)+QRFXOUT(NK)                     <a name='1853'>
              QSFXIN(NK-1)=QSFXIN(NK-1)+QSFXOUT(NK)                    <a name='1854'>
            ENDIF                                                     <a name='1855'>
  280     CONTINUE                                                  <a name='1856'>
<font color=#447700>!                                                                  <a name='1857'></font>
<font color=#447700>!...UPDATE THE HYDROMETEOR CONCENTRATION VALUES AT EACH LEVEL...  <a name='1858'></font>
<font color=#447700>!                                                                <a name='1859'></font>
          DO 285 NK=1,LTOP                                                 <a name='1860'>
            QLPA(NK)=QLPA(NK)+(QLFXIN(NK)+DETLQ(NK)-QLFXOUT(NK))*DTIME*  &amp; <a name='1861'>
                     EMSD(NK)                                               <a name='1862'>
            QIPA(NK)=QIPA(NK)+(QIFXIN(NK)+DETIC(NK)-QIFXOUT(NK))*DTIME*  &amp; <a name='1863'>
                     EMSD(NK)                                             <a name='1864'>
            QRPA(NK)=QRPA(NK)+(QRFXIN(NK)+QLQOUT(NK)*UDR(NK)-QRFXOUT(NK) &amp; <a name='1865'>
                     +RAINFB(NK))*DTIME*EMSD(NK)                          <a name='1866'>
            QSPA(NK)=QSPA(NK)+(QSFXIN(NK)+QICOUT(NK)*UDR(NK)-QSFXOUT(NK) &amp;  <a name='1867'>
                     +SNOWFB(NK))*DTIME*EMSD(NK)                           <a name='1868'>
  285     CONTINUE                                                        <a name='1869'>
  290   CONTINUE                                                         <a name='1870'>
        DO 295 NK=1,LTOP                                                <a name='1871'>
          QLG(NK)=QLPA(NK)                                             <a name='1872'>
          QIG(NK)=QIPA(NK)                                            <a name='1873'>
          QRG(NK)=QRPA(NK)                                           <a name='1874'>
          QSG(NK)=QSPA(NK)                                          <a name='1875'>
  295   CONTINUE                                                  <a name='1876'>
<a name='1877'>
<font color=#447700>!kf_edrates<a name='1878'></font>
<font color=#447700>!Save convective timescale (TIMEC) as 2D variable<a name='1879'></font>
        IF (KF_EDRATES == 1) THEN<a name='1880'>
           TIMEC_KF(I,J)=TIMEC<a name='1881'>
        ENDIF<a name='1882'>
<a name='1883'>
<font color=#447700>!     WRITE(98,1080)LFS,LDB,LDT,TIMEC,NSTEP,NCOUNT,FABE,AINC     <a name='1884'></font>
<font color=#447700>!                                                               <a name='1885'></font>
<font color=#447700>!...SEND FINAL PARAMETERIZED VALUES TO OUTPUT FILES...         <a name='1886'></font>
<font color=#447700>!                                                             <a name='1887'></font>
        IF(ISTOP.EQ.1)THEN                                   <a name='1888'>
        WRITE(6,1070)'  P  ','   DP ',' DT K/D ',' DR K/D ','   OMG  ',  &amp; <a name='1889'>
      ' DOMGDP ','   UMF  ','   UER  ','   UDR  ','   DMF  ','   DER  '  &amp; <a name='1890'>
      ,'   DDR  ','   EMS  ','    W0  ','  DETLQ ',' DETIC '              <a name='1891'>
          DO 300 K=LTOP,1,-1                                                   <a name='1892'>
            DTT=(TG(K)-T0(K))*86400./TIMEC                                 <a name='1893'>
            RL=XLV0-XLV1*TG(K)                                            <a name='1894'>
            DR=-(QG(K)-Q0(K))*RL*86400./(TIMEC*CP)                       <a name='1895'>
            UDFRC=UDR(K)*TIMEC*EMSD(K)                                  <a name='1896'>
            UEFRC=UER(K)*TIMEC*EMSD(K)                                 <a name='1897'>
            DDFRC=DDR(K)*TIMEC*EMSD(K)                                <a name='1898'>
            DEFRC=-DER(K)*TIMEC*EMSD(K)                              <a name='1899'>
            WRITE (6,1075)P0(K)/100.,DP(K)/100.,DTT,DR,OMG(K),DOMGDP(K)* &amp;  <a name='1900'>
                          1.E4,UMF(K)/1.E6,UEFRC,UDFRC,DMF(K)/1.E6,DEFRC &amp; <a name='1901'>
                          ,DDFRC,EMS(K)/1.E11,W0AVG1D(K)*1.E2,DETLQ(K) &amp;<a name='1902'>
                          *TIMEC*EMSD(K)*1.E3,DETIC(K)*TIMEC*EMSD(K)*    &amp; <a name='1903'>
                          1.E3                                            <a name='1904'>
  300     CONTINUE                                                       <a name='1905'>
        WRITE(6,1085)'K','P','Z','T0','TG','DT','TU','TD','Q0','QG',     &amp; <a name='1906'>
                  'DQ','QU','QD','QLG','QIG','QRG','QSG','RH0','RHG'    <a name='1907'>
          DO 305 K=KX,1,-1                                               <a name='1908'>
            DTT=TG(K)-T0(K)                                          <a name='1909'>
            TUC=TU(K)-T00                                                    <a name='1910'>
            IF(K.LT.LC.OR.K.GT.LTOP)TUC=0.                                  <a name='1911'>
            TDC=TZ(K)-T00                                                  <a name='1912'>
            IF((K.LT.LDB.OR.K.GT.LDT).AND.K.NE.LFS)TDC=0.                 <a name='1913'>
            ES=ALIQ*EXP((BLIQ*TG(K)-CLIQ)/(TG(K)-DLIQ))                  <a name='1914'>
            QGS=ES*EP2/(P0(K)-ES)                                     <a name='1915'>
            RH0=Q0(K)/QES(K)                                              <a name='1916'>
            RHG=QG(K)/QGS                                                <a name='1917'>
            WRITE (6,1090)K,P0(K)/100.,Z0(K),T0(K)-T00,TG(K)-T00,DTT,TUC &amp;<a name='1918'>
                          ,TDC,Q0(K)*1000.,QG(K)*1000.,(QG(K)-Q0(K))*    &amp;   <a name='1919'>
                          1000.,QU(K)*1000.,QD(K)*1000.,QLG(K)*1000.,    &amp;  <a name='1920'>
                          QIG(K)*1000.,QRG(K)*1000.,QSG(K)*1000.,RH0,RHG   <a name='1921'>
  305     CONTINUE                                                        <a name='1922'>
<font color=#447700>!                                                                        <a name='1923'></font>
<font color=#447700>!...IF CALCULATIONS ABOVE SHOW AN ERROR IN THE MASS BUDGET, PRINT OUT A <a name='1924'></font>
<font color=#447700>!...TO BE USED LATER FOR DIAGNOSTIC PURPOSES, THEN ABORT RUN...        <a name='1925'></font>
<font color=#447700>!                                                                     <a name='1926'></font>
          IF(ISTOP.EQ.1)THEN                                         <a name='1927'>
            DO 310 K=1,KX                                           <a name='1928'>
              WRITE ( wrf_err_message , 1115 )                         &amp;<a name='1929'>
                            Z0(K),P0(K)/100.,T0(K)-273.16,Q0(K)*1000.,   &amp;<a name='1930'>
                            U0(K),V0(K),DP(K)/100.,W0AVG1D(K)         <a name='1931'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_627"> ( TRIM( wrf_err_message ) )<a name='1932'>
  310       CONTINUE                                                   <a name='1933'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_603"> ( 'module_cu_kf.F: KAIN-FRITSCH' )<a name='1934'>
          ENDIF                                                      <a name='1935'>
        ENDIF                                                       <a name='1936'>
        CNDTNF=(1.-EQFRC(LFS))*(QLIQ(LFS)+QICE(LFS))*DMF(LFS)            <a name='1937'>
<font color=#447700>!     WRITE(98,1095)CPR*AINC,TDER+PPTFLX+CNDTNF                            <a name='1938'></font>
<font color=#447700>!                                                                       <a name='1939'></font>
<font color=#447700>!  EVALUATE MOISTURE BUDGET...                                         <a name='1940'></font>
<font color=#447700>!                                                                     <a name='1941'></font>
        QINIT=0.                                                     <a name='1942'>
        QFNL=0.                                                     <a name='1943'>
        DPT=0.                                                     <a name='1944'>
        DO 315 NK=1,LTOP                                                    <a name='1945'>
          DPT=DPT+DP(NK)                                                     <a name='1946'>
          QINIT=QINIT+Q0(NK)*EMS(NK)                                       <a name='1947'>
          QFNL=QFNL+QG(NK)*EMS(NK)                                        <a name='1948'>
          QFNL=QFNL+(QLG(NK)+QIG(NK)+QRG(NK)+QSG(NK))*EMS(NK)            <a name='1949'>
  315   CONTINUE                                                        <a name='1950'>
        QFNL=QFNL+PPTFLX*TIMEC*(1.-FBFRC)                              <a name='1951'>
        ERR2=(QFNL-QINIT)*100./QINIT                                  <a name='1952'>
<font color=#447700>!     WRITE(98,1110)QINIT,QFNL,ERR2                                  <a name='1953'></font>
<font color=#447700>!        IF(ABS(ERR2).GT.0.05)STOP 'QVERR'                           <a name='1954'></font>
        IF(ABS(ERR2).GT.0.05)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_604">( 'module_cu_kf.F: QVERR' )<a name='1955'>
        RELERR=ERR2*QINIT/(PPTFLX*TIMEC+1.E-10)                   <a name='1956'>
<font color=#447700>!     WRITE(98,1120)RELERR                                       <a name='1957'></font>
<font color=#447700>!     WRITE(98,*)'TDER, CPR, USR, TRPPT =',                     <a name='1958'></font>
<font color=#447700>!    *TDER,CPR*AINC,USR*AINC,TRPPT*AINC                        <a name='1959'></font>
<font color=#447700>!                                                             <a name='1960'></font>
<font color=#447700>!...FEEDBACK TO RESOLVABLE SCALE TENDENCIES.                 <a name='1961'></font>
<font color=#447700>!                                                           <a name='1962'></font>
<font color=#447700>!...IF THE ADVECTIVE TIME PERIOD (TADVEC) IS LESS THAN SPECIFIED MINIMUM  <a name='1963'></font>
<font color=#447700>!...TIMEC, ALLOW FEEDBACK TO OCCUR ONLY DURING TADVEC...                 <a name='1964'></font>
<font color=#447700>!                                                                       <a name='1965'></font>
        IF(TADVEC.LT.TIMEC)NIC=NINT(TADVEC/DT)                  <a name='1966'>
        NCA(I,J)=FLOAT(NIC)*DT<a name='1967'>
        DO 320 K=1,KX                                                <a name='1968'>
<font color=#447700>!         IF(IMOIST.NE.2)THEN<a name='1969'></font>
<font color=#447700>!                                                                            <a name='1970'></font>
<font color=#447700>!...IF HYDROMETEORS ARE NOT ALLOWED, THEY MUST BE EVAPORATED OR SUBLIMAT    <a name='1971'></font>
<font color=#447700>!...AND FED BACK AS VAPOR, ALONG WITH ASSOCIATED CHANGES IN TEMPERATURE.   <a name='1972'></font>
<font color=#447700>!...NOTE:  THIS WILL INTRODUCE CHANGES IN THE CONVECTIVE TEMPERATURE AND  <a name='1973'></font>
<font color=#447700>!...WATER VAPOR FEEDBACK TENDENCIES AND MAY LEAD TO SUPERSATURATED VALUE <a name='1974'></font>
<font color=#447700>!...OF QG...                                                           <a name='1975'></font>
<font color=#447700>!                                                                     <a name='1976'></font>
<font color=#447700>!           RLC=XLV0-XLV1*TG(K)                                      <a name='1977'></font>
<font color=#447700>!           RLS=XLS0-XLS1*TG(K)                                     <a name='1978'></font>
<font color=#447700>!           CPM=CP*(1.+0.887*QG(K))                                <a name='1979'></font>
<font color=#447700>!           TG(K)=TG(K)-(RLC*(QLG(K)+QRG(K))+RLS*(QIG(K)+QSG(K)))/CPM    <a name='1980'></font>
<font color=#447700>!           QG(K)=QG(K)+(QLG(K)+QRG(K)+QIG(K)+QSG(K))                   <a name='1981'></font>
<font color=#447700>!           DQCDT(K)=0.                                           <a name='1982'></font>
<font color=#447700>!           DQIDT(K)=0.                                          <a name='1983'></font>
<font color=#447700>!           DQRDT(K)=0.                                         <a name='1984'></font>
<font color=#447700>!           DQSDT(K)=0.                                        <a name='1985'></font>
<font color=#447700>!         ELSE                                                     <a name='1986'></font>
            IF(.NOT. qi_flag .and. warm_rain)THEN                                          <a name='1987'>
<font color=#447700>!                                                                         <a name='1988'></font>
<font color=#447700>!...IF ICE PHASE IS NOT ALLOWED, MELT ALL FROZEN HYDROMETEORS...         <a name='1989'></font>
<font color=#447700>!                                                                       <a name='1990'></font>
              CPM=CP*(1.+0.887*QG(K))                                  <a name='1991'>
              TG(K)=TG(K)-(QIG(K)+QSG(K))*RLF/CPM                     <a name='1992'>
              DQCDT(K)=(QLG(K)+QIG(K)-QL0(K)-QI0(K))/TIMEC      <a name='1993'>
              DQIDT(K)=0.                                      <a name='1994'>
              DQRDT(K)=(QRG(K)+QSG(K)-QR0(K)-QS0(K))/TIMEC    <a name='1995'>
              DQSDT(K)=0.                                    <a name='1996'>
            ELSEIF(.NOT. qi_flag .and. .not. warm_rain)THEN                                          <a name='1997'>
<font color=#447700>!                                                                      <a name='1998'></font>
<font color=#447700>!...IF ICE PHASE IS ALLOWED, BUT MIXED PHASE IS NOT, MELT FROZEN HYDROME   <a name='1999'></font>
<font color=#447700>!...BELOW THE MELTING LEVEL, FREEZE LIQUID WATER ABOVE THE MELTING LEVEL  <a name='2000'></font>
<font color=#447700>!                                                                        <a name='2001'></font>
              CPM=CP*(1.+0.887*QG(K))                                   <a name='2002'>
              IF(K.LE.ML)THEN                                         <a name='2003'>
                TG(K)=TG(K)-(QIG(K)+QSG(K))*RLF/CPM                  <a name='2004'>
              ELSEIF(K.GT.ML)THEN                                              <a name='2005'>
                TG(K)=TG(K)+(QLG(K)+QRG(K))*RLF/CPM                           <a name='2006'>
              ENDIF                                                          <a name='2007'>
              DQCDT(K)=(QLG(K)+QIG(K)-QL0(K)-QI0(K))/TIMEC             <a name='2008'>
              DQIDT(K)=0.                                             <a name='2009'>
              DQRDT(K)=(QRG(K)+QSG(K)-QR0(K)-QS0(K))/TIMEC           <a name='2010'>
              DQSDT(K)=0.                                           <a name='2011'>
            ELSEIF(qi_flag) THEN<a name='2012'>
<font color=#447700>!                                                                           <a name='2013'></font>
<font color=#447700>!...IF MIXED PHASE HYDROMETEORS ARE ALLOWED, FEED BACK CONVECTIVE          <a name='2014'></font>
<font color=#447700>!...TENDENCY OF HYDROMETEORS DIRECTLY...                                  <a name='2015'></font>
<font color=#447700>!                                                                        <a name='2016'></font>
              DQCDT(K)=(QLG(K)-QL0(K))/TIMEC                       <a name='2017'>
              DQIDT(K)=(QIG(K)-QI0(K))/TIMEC                      <a name='2018'>
              DQRDT(K)=(QRG(K)-QR0(K))/TIMEC                     <a name='2019'>
              IF (qs_flag ) THEN<a name='2020'>
                 DQSDT(K)=(QSG(K)-QS0(K))/TIMEC                    <a name='2021'>
              ELSE<a name='2022'>
                 DQIDT(K)=DQIDT(K)+(QSG(K)-QS0(K))/TIMEC<a name='2023'>
              ENDIF<a name='2024'>
            ELSE                                                    <a name='2025'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_kf.F.html#KFPARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_605"> ( 'module_cu_kf: THIS COMBINATION OF IMOIST,  IICE NOT ALLOWED' )<a name='2026'>
            ENDIF                                                 <a name='2027'>
<font color=#447700>!         ENDIF                                                  <a name='2028'></font>
          DTDT(K)=(TG(K)-T0(K))/TIMEC                      <a name='2029'>
          DQDT(K)=(QG(K)-Q0(K))/TIMEC                                   <a name='2030'>
  320   CONTINUE                                                            <a name='2031'>
<a name='2032'>
<font color=#447700>! RAINCV is in the unit of mm<a name='2033'></font>
<a name='2034'>
        PRATEC(I,J)=PPTFLX*(1.-FBFRC)/DXSQ                       <a name='2035'>
        RAINCV(I,J)=DT*PRATEC(I,J)<a name='2036'>
        RNC=RAINCV(I,J)*NIC                                              <a name='2037'>
<font color=#447700>!        WRITE(98,909)RNC                                               <a name='2038'></font>
 909     FORMAT(' CONVECTIVE RAINFALL =',F8.4,' CM')                   <a name='2039'>
<a name='2040'>
  325 CONTINUE                                                        <a name='2041'>
<a name='2042'>
1000  FORMAT(' ',10A8)                                                     <a name='2043'>
1005  FORMAT(' ',F6.0,2X,F6.4,2X,F7.3,1X,F6.4,2X,4(F6.3,2X),2(F7.3,1X))   <a name='2044'>
1010  FORMAT(' ',' VERTICAL VELOCITY IS NEGATIVE AT ',F4.0,' MB')        <a name='2045'>
1015   FORMAT(' ','ALL REMAINING MASS DETRAINS BELOW ',F4.0,' MB')          <a name='2046'>
1025   FORMAT(5X,' KLCL=',I2,' ZLCL=',F7.1,'M',                          &amp;<a name='2047'>
        ' DTLCL=',F5.2,' LTOP=',I2,' P0(LTOP)=',-2PF5.1,'MB FRZ LV=',    &amp; <a name='2048'>
        I2,' TMIX=',0PF4.1,1X,'PMIX=',-2PF6.1,' QMIX=',3PF5.1,           &amp;<a name='2049'>
        ' CAPE=',0PF7.1)                                                    <a name='2050'>
1030   FORMAT(' ',' P0(LET) = ',F6.1,' P0(LTOP) = ',F6.1,' VMFLCL =',    &amp;   <a name='2051'>
      E12.3,' PLCL =',F6.1,' WLCL =',F6.3,' CLDHGT =',                   &amp; <a name='2052'>
      F8.1)                                                               <a name='2053'>
1035  FORMAT(1X,'PEF(WS)=',F4.2,'(CB)=',F4.2,'LC,LET=',2I3,'WKL='        &amp;<a name='2054'>
      ,F6.3,'VWS=',F5.2)                                                    <a name='2055'>
1040          FORMAT(' ','PRECIP EFF = 100%, ENVIR CANNOT SUPPORT DOWND' &amp; <a name='2056'>
      ,'RAFTS')                                                          <a name='2057'>
<font color=#447700>!1045  FORMAT('NUMBER OF DOWNDRAFT ITERATIONS EXCEEDS 10...PPTFLX'       &amp; <a name='2058'></font>
<font color=#447700>!      ' IS DIFFERENT FROM THAT GIVEN BY PRECIP EFF RELATION')            <a name='2059'></font>
<font color=#447700>! FLIC HAS TROUBLE WITH THIS ONE.                                         <a name='2060'></font>
1045  FORMAT('NUMBER OF DOWNDRAFT ITERATIONS EXCEEDS 10')                <a name='2061'>
1050  FORMAT(' ','LCOUNT= ',I3,' PPTFLX/CPR, PEFF= ',F5.3,1X,F5.3,       &amp;  <a name='2062'>
      'DMF(LFS)/UMF(LCL)= ',F5.3)                                          <a name='2063'>
1055     FORMAT(/'*** DEGREE OF STABILIZATION =',F5.3,', NO MORE MASS F' &amp;<a name='2064'>
      ,'LUX IS ALLOWED')                                                <a name='2065'>
<font color=#447700>!1060     FORMAT(/' ITERATION DOES NOT CONVERGE TO GIVE THE SPECIFIED '  &amp; <a name='2066'></font>
<font color=#447700>!      'DEGREE OF STABILIZATION!  FABE= ',F6.4)                             <a name='2067'></font>
1060  FORMAT(/' ITERATION DOES NOT CONVERGE.  FABE= ',F6.4)                <a name='2068'>
 1070 FORMAT (16A8)                                                       <a name='2069'>
 1075 FORMAT (F8.2,3(F8.2),2(F8.3),F8.2,2F8.3,F8.2,6F8.3)                <a name='2070'>
1080   FORMAT(2X,'LFS,LDB,LDT =',3I3,' TIMEC, NSTEP=',F5.0,I3,           &amp; <a name='2071'>
      'NCOUNT, FABE, AINC=',I2,1X,F5.3,F6.2)                              <a name='2072'>
 1085 FORMAT (A3,16A7,2A8)                                               <a name='2073'>
 1090 FORMAT (I3,F7.2,F7.0,10F7.2,4F7.3,2F8.3)                          <a name='2074'>
1095   FORMAT(' ','  PPT PRODUCTION RATE= ',F10.0,' TOTAL EVAP+PPT= ',   &amp;  <a name='2075'>
       F10.0)                                                           <a name='2076'>
1105   FORMAT(' ','NET LATENT HEAT RELEASE =',E12.5,' ACTUAL HEATING =', &amp; <a name='2077'>
       E12.5,' J/KG-S, DIFFERENCE = ',F9.3,'PERCENT')                    <a name='2078'>
1110   FORMAT(' ','INITIAL WATER =',E12.5,' FINAL WATER =',E12.5,        &amp; <a name='2079'>
       ' TOTAL WATER CHANGE =',F8.2,'PERCENT')                              <a name='2080'>
 1115 FORMAT (2X,F6.0,2X,F7.2,2X,F5.1,2X,F6.3,2(2X,F5.1),2X,F7.2,2X,F7.4 &amp;  <a name='2081'>
             )                                                            <a name='2082'>
1120   FORMAT(' ','MOISTURE ERROR AS FUNCTION OF TOTAL PPT =',F9.3,      &amp; <a name='2083'>
            'PERCENT')                                                  <a name='2084'>
<a name='2085'>
   END SUBROUTINE KFPARA <a name='2086'>
<a name='2087'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2088'></font>
<A NAME='CONDLOAD'><A href='../../html_code/phys/module_cu_kf.F.html#CONDLOAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2089'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>CONDLOAD</font>(QLIQ,QICE,WTW,DZ,BOTERM,ENTERM,RATE,QNEWLQ,     &amp;  <A href='../../call_to/CONDLOAD.html' TARGET='index'>3</A><a name='2090'>
                       QNEWIC,QLQOUT,QICOUT,G)                           <a name='2091'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2092'></font>
   IMPLICIT NONE<a name='2093'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2094'></font>
<font color=#447700>!  9/18/88...THIS PRECIPITATION FALLOUT SCHEME IS BASED ON THE SCHEME US    <a name='2095'></font>
<font color=#447700>!  BY OGURA AND CHO (1973).  LIQUID WATER FALLOUT FROM A PARCEL IS CAL-    <a name='2096'></font>
<font color=#447700>!  CULATED USING THE EQUATION DQ=-RATE*Q*DT, BUT TO SIMULATE A QUASI-     <a name='2097'></font>
<font color=#447700>!  CONTINUOUS PROCESS, AND TO ELIMINATE A DEPENDENCY ON VERTICAL         <a name='2098'></font>
<font color=#447700>!  RESOLUTION THIS IS EXPRESSED AS Q=Q*EXP(-RATE*DZ).                   <a name='2099'></font>
<a name='2100'>
      REAL, INTENT(IN   )   :: G<a name='2101'>
      REAL, INTENT(IN   )   :: DZ,BOTERM,ENTERM,RATE<a name='2102'>
      REAL, INTENT(INOUT)   :: QLQOUT,QICOUT,WTW,QLIQ,QICE,QNEWLQ,QNEWIC<a name='2103'>
<a name='2104'>
      REAL :: QTOT,QNEW,QEST,G1,WAVG,CONV,RATIO3,OLDQ,RATIO4,DQ,PPTDRG<a name='2105'>
<a name='2106'>
      QTOT=QLIQ+QICE                                                  <a name='2107'>
      QNEW=QNEWLQ+QNEWIC                                            <a name='2108'>
<font color=#447700>!                                                                  <a name='2109'></font>
<font color=#447700>!  ESTIMATE THE VERTICAL VELOCITY SO THAT AN AVERAGE VERTICAL VELOCITY C<a name='2110'></font>
<font color=#447700>!  BE CALCULATED TO ESTIMATE THE TIME REQUIRED FOR ASCENT BETWEEN MODEL<a name='2111'></font>
<font color=#447700>!  LEVELS...                                                          <a name='2112'></font>
<font color=#447700>!                                                                    <a name='2113'></font>
      QEST=0.5*(QTOT+QNEW)                                          <a name='2114'>
      G1=WTW+BOTERM-ENTERM-2.*G*DZ*QEST/1.5                        <a name='2115'>
      IF(G1.LT.0.0)G1=0.                                          <a name='2116'>
      WAVG=(SQRT(WTW)+SQRT(G1))/2.                               <a name='2117'>
      CONV=RATE*DZ/WAVG                                         <a name='2118'>
<font color=#447700>!                                                              <a name='2119'></font>
<font color=#447700>!  RATIO3 IS THE FRACTION OF LIQUID WATER IN FRESH CONDENSATE, RATIO4 IS  <a name='2120'></font>
<font color=#447700>!  THE FRACTION OF LIQUID WATER IN THE TOTAL AMOUNT OF CONDENSATE INVOLV <a name='2121'></font>
<font color=#447700>!  IN THE PRECIPITATION PROCESS - NOTE THAT ONLY 60% OF THE FRESH CONDEN<a name='2122'></font>
<font color=#447700>!  SATE IS IS ALLOWED TO PARTICIPATE IN THE CONVERSION PROCESS...      <a name='2123'></font>
<font color=#447700>!                                                                     <a name='2124'></font>
      RATIO3=QNEWLQ/(QNEW+1.E-10)                                    <a name='2125'>
<font color=#447700>!     OLDQ=QTOT                                                     <a name='2126'></font>
      QTOT=QTOT+0.6*QNEW                                           <a name='2127'>
      OLDQ=QTOT                                                   <a name='2128'>
      RATIO4=(0.6*QNEWLQ+QLIQ)/(QTOT+1.E-10)                     <a name='2129'>
      QTOT=QTOT*EXP(-CONV)                                      <a name='2130'>
<font color=#447700>!                                                              <a name='2131'></font>
<font color=#447700>!  DETERMINE THE AMOUNT OF PRECIPITATION THAT FALLS OUT OF THE UPDRAFT   <a name='2132'></font>
<font color=#447700>!  PARCEL AT THIS LEVEL...                                              <a name='2133'></font>
<font color=#447700>!                                                                      <a name='2134'></font>
      DQ=OLDQ-QTOT                                                    <a name='2135'>
      QLQOUT=RATIO4*DQ                                               <a name='2136'>
      QICOUT=(1.-RATIO4)*DQ                                         <a name='2137'>
<font color=#447700>!                                                                  <a name='2138'></font>
<font color=#447700>!  ESTIMATE THE MEAN LOAD OF CONDENSATE ON THE UPDRAFT IN THE LAYER, CAL <a name='2139'></font>
<font color=#447700>!  LATE VERTICAL VELOCITY                                               <a name='2140'></font>
<font color=#447700>!                                                                      <a name='2141'></font>
      PPTDRG=0.5*(OLDQ+QTOT-0.2*QNEW)                                 <a name='2142'>
      WTW=WTW+BOTERM-ENTERM-2.*G*DZ*PPTDRG/1.5                       <a name='2143'>
<font color=#447700>!                                                                   <a name='2144'></font>
<font color=#447700>!  DETERMINE THE NEW LIQUID WATER AND ICE CONCENTRATIONS INCLUDING LOSSE  <a name='2145'></font>
<font color=#447700>!  DUE TO PRECIPITATION AND GAINS FROM CONDENSATION...                   <a name='2146'></font>
<font color=#447700>!                                                                       <a name='2147'></font>
      QLIQ=RATIO4*QTOT+RATIO3*0.4*QNEW                                 <a name='2148'>
      QICE=(1.-RATIO4)*QTOT+(1.-RATIO3)*0.4*QNEW                      <a name='2149'>
      QNEWLQ=0.                                                      <a name='2150'>
      QNEWIC=0.                                                     <a name='2151'>
<a name='2152'>
   END SUBROUTINE CONDLOAD<a name='2153'>
<a name='2154'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2155'></font>
<A NAME='DTFRZNEW'><A href='../../html_code/phys/module_cu_kf.F.html#DTFRZNEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2156'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>DTFRZNEW</font>(TU,P,THTEU,QVAP,QLIQ,QICE,RATIO2,TTFRZ,TBFRZ,   &amp;  <A href='../../call_to/DTFRZNEW.html' TARGET='index'>3</A><a name='2157'>
                       QNWFRZ,RL,FRC1,EFFQ,IFLAG,XLV0,XLV1,XLS0,XLS1,  &amp; <a name='2158'>
                       EP2,ALIQ,BLIQ,CLIQ,DLIQ,AICE,BICE,CICE,DICE     )        <a name='2159'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2160'></font>
   IMPLICIT NONE<a name='2161'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2162'></font>
   REAL,         INTENT(IN   )   :: XLV0,XLV1<a name='2163'>
   REAL,         INTENT(IN   )   :: P,TTFRZ,TBFRZ,EFFQ,XLS0,XLS1,EP2,ALIQ, &amp;<a name='2164'>
                                    BLIQ,CLIQ,DLIQ,AICE,BICE,CICE,DICE<a name='2165'>
   REAL,         INTENT(INOUT)   :: TU,THTEU,QVAP,QLIQ,QICE,RATIO2,    &amp;<a name='2166'>
                                    FRC1,RL,QNWFRZ<a name='2167'>
   INTEGER,      INTENT(INOUT)   :: IFLAG<a name='2168'>
<a name='2169'>
   REAL ::       CCP,RV,C5,QLQFRZ,QNEW,ESLIQ,ESICE,RLC,RLS,PI,ES,RLF,A, &amp;<a name='2170'>
                 B,C,DQVAP,DTFRZ,TU1,QVAP1<a name='2171'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2172'></font>
<font color=#447700>!                                                                          <a name='2173'></font>
<font color=#447700>!...ALLOW GLACIATION OF THE UPDRAFT TO OCCUR AS AN APPROXIMATELY LINEAR   <a name='2174'></font>
<font color=#447700>!   FUNCTION OF TEMPERATURE IN THE TEMPERATURE RANGE TTFRZ TO TBFRZ...   <a name='2175'></font>
<font color=#447700>!                                                                       <a name='2176'></font>
<a name='2177'>
      RV=461.5                                                         <a name='2178'>
      C5=1.0723E-3                                                    <a name='2179'>
<font color=#447700>!                                                                          <a name='2180'></font>
<font color=#447700>!...ADJUST THE LIQUID WATER CONCENTRATIONS FROM FRESH CONDENSATE AND THA  <a name='2181'></font>
<font color=#447700>!   BROUGHT UP FROM LOWER LEVELS TO AN AMOUNT THAT WOULD BE PRESENT IF N <a name='2182'></font>
<font color=#447700>!   LIQUID WATER HAD FROZEN THUS FAR...THIS IS NECESSARY BECAUSE THE    <a name='2183'></font>
<font color=#447700>!   EXPRESSION FOR TEMP CHANGE IS MULTIPLIED BY THE FRACTION EQUAL TO TH       <a name='2184'></font>
<font color=#447700>!   PARCEL TEMP DECREASE SINCE THE LAST MODEL LEVEL DIVIDED BY THE TOTAL      <a name='2185'></font>
<font color=#447700>!   GLACIATION INTERVAL, SO THAT EFFECTIVELY THIS APPROXIMATELY ALLOWS A     <a name='2186'></font>
<font color=#447700>!   AMOUNT OF LIQUID WATER TO FREEZE WHICH IS EQUAL TO THIS SAME FRACTIO    <a name='2187'></font>
<font color=#447700>!   OF THE LIQUID WATER THAT WAS PRESENT BEFORE THE GLACIATION PROCESS W   <a name='2188'></font>
<font color=#447700>!   INITIATED...ALSO, TO ALLOW THETAU TO CONVERT APPROXIMATELY LINEARLY   <a name='2189'></font>
<font color=#447700>!   ITS VALUE WITH RESPECT TO ICE, WE NEED TO ALLOW A PORTION OF THE FRE <a name='2190'></font>
<font color=#447700>!   CONDENSATE TO CONTRIBUTE TO THE GLACIATION PROCESS; THE FRACTIONAL  <a name='2191'></font>
<font color=#447700>!   AMOUNT THAT APPLIES TO THIS PORTION IS 1/2 OF THE FRACTIONAL AMOUNT     <a name='2192'></font>
<font color=#447700>!   FROZEN OF THE "OLD" CONDENSATE BECAUSE THIS FRESH CONDENSATE IS ONLY   <a name='2193'></font>
<font color=#447700>!   PRODUCED GRADUALLY OVER THE LAYER...NOTE THAT IN TERMS OF THE DYNAMI  <a name='2194'></font>
<font color=#447700>!   OF THE PRECIPITATION PROCESS, IE. PRECIPITATION FALLOUT, THIS FRACTI <a name='2195'></font>
<font color=#447700>!   AMNT OF FRESH CONDENSATE HAS ALREADY BEEN INCLUDED IN THE ICE CATEGO<a name='2196'></font>
<font color=#447700>!                                                                      <a name='2197'></font>
      QLQFRZ=QLIQ*EFFQ                                                <a name='2198'>
      QNEW=QNWFRZ*EFFQ*0.5                                           <a name='2199'>
      ESLIQ=ALIQ*EXP((BLIQ*TU-CLIQ)/(TU-DLIQ))                      <a name='2200'>
      ESICE=AICE*EXP((BICE*TU-CICE)/(TU-DICE))                     <a name='2201'>
      RLC=2.5E6-2369.276*(TU-273.16)                              <a name='2202'>
      RLS=2833922.-259.532*(TU-273.16)                           <a name='2203'>
      RLF=RLS-RLC                                               <a name='2204'>
      CCP=1005.7*(1.+0.89*QVAP)                                 <a name='2205'>
<font color=#447700>!                                                             <a name='2206'></font>
<font color=#447700>!  A = D(ES)/DT IS THAT CALCULATED FROM BUCK`S (1981) EMPIRICAL FORMULAS<a name='2207'></font>
<font color=#447700>!  FOR SATURATION VAPOR PRESSURE...                                    <a name='2208'></font>
<font color=#447700>!                                                                     <a name='2209'></font>
      A=(CICE-BICE*DICE)/((TU-DICE)*(TU-DICE))                       <a name='2210'>
      B=RLS*EP2/P                                                 <a name='2211'>
      C=A*B*ESICE/CCP                                               <a name='2212'>
      DQVAP=B*(ESLIQ-ESICE)/(RLS+RLS*C)-RLF*(QLQFRZ+QNEW)/(RLS+RLS/C)  <a name='2213'>
      DTFRZ=(RLF*(QLQFRZ+QNEW)+B*(ESLIQ-ESICE))/(CCP+A*B*ESICE)        <a name='2214'>
      TU1=TU                                                         <a name='2215'>
      QVAP1=QVAP                                                    <a name='2216'>
      TU=TU+FRC1*DTFRZ                                             <a name='2217'>
      QVAP=QVAP-FRC1*DQVAP                                        <a name='2218'>
      ES=QVAP*P/(EP2+QVAP)                                     <a name='2219'>
      ESLIQ=ALIQ*EXP((BLIQ*TU-CLIQ)/(TU-DLIQ))                           <a name='2220'>
      ESICE=AICE*EXP((BICE*TU-CICE)/(TU-DICE))                          <a name='2221'>
      RATIO2=(ESLIQ-ES)/(ESLIQ-ESICE)                                  <a name='2222'>
<font color=#447700>!                                                                     <a name='2223'></font>
<font color=#447700>!  TYPICALLY, RATIO2 IS VERY CLOSE TO (TTFRZ-TU)/(TTFRZ-TBFRZ), USUALLY    <a name='2224'></font>
<font color=#447700>!  WITHIN 1% (USING TU BEFORE GALCIATION EFFECTS ARE APPLIED);  IF THE    <a name='2225'></font>
<font color=#447700>!  INITIAL UPDRAFT TEMP IS BELOW TBFRZ AND RATIO2 IS STILL LESS THAN 1,  <a name='2226'></font>
<font color=#447700>!  AN ADJUSTMENT TO FRC1 AND RATIO2 IS INTRODUCED SO THAT GLACIATION    <a name='2227'></font>
<font color=#447700>!  EFFECTS ARE NOT UNDERESTIMATED; CONVERSELY, IF RATIO2 IS GREATER THAN    <a name='2228'></font>
<font color=#447700>!  FRC1 IS ADJUSTED SO THAT GLACIATION EFFECTS ARE NOT OVERESTIMATED...    <a name='2229'></font>
<font color=#447700>!                                                                        <a name='2230'></font>
      IF(IFLAG.GT.0.AND.RATIO2.LT.1)THEN                                <a name='2231'>
        FRC1=FRC1+(1.-RATIO2)                                          <a name='2232'>
        TU=TU1+FRC1*DTFRZ                                             <a name='2233'>
        QVAP=QVAP1-FRC1*DQVAP                                        <a name='2234'>
        RATIO2=1.                                                   <a name='2235'>
        IFLAG=1                                                    <a name='2236'>
        GOTO 20                                                   <a name='2237'>
      ENDIF                                                                  <a name='2238'>
      IF(RATIO2.GT.1.)THEN                                                  <a name='2239'>
        FRC1=FRC1-(RATIO2-1.)                                              <a name='2240'>
        FRC1=AMAX1(0.0,FRC1)                                              <a name='2241'>
        TU=TU1+FRC1*DTFRZ                                                <a name='2242'>
        QVAP=QVAP1-FRC1*DQVAP                                           <a name='2243'>
        RATIO2=1.                                                      <a name='2244'>
        IFLAG=1                                                       <a name='2245'>
      ENDIF                                                                   <a name='2246'>
<font color=#447700>!                                                                            <a name='2247'></font>
<font color=#447700>!  CALCULATE A HYBRID VALUE OF THETAU, ASSUMING THAT THE LATENT HEAT OF     <a name='2248'></font>
<font color=#447700>!  VAPORIZATION/SUBLIMATION CAN BE ESTIMATED USING THE SAME WEIGHTING      <a name='2249'></font>
<font color=#447700>!  FUNCTION AS THAT USED TO CALCULATE SATURATION VAPOR PRESSURE, CALCU-   <a name='2250'></font>
<font color=#447700>!  LATE NEW LIQUID WATER AND ICE CONCENTRATIONS...                       <a name='2251'></font>
<font color=#447700>!                                                                       <a name='2252'></font>
   20 RLC=XLV0-XLV1*TU                                                 <a name='2253'>
      RLS=XLS0-XLS1*TU                                                <a name='2254'>
      RL=RATIO2*RLS+(1.-RATIO2)*RLC                                  <a name='2255'>
      PI=(1.E5/P)**(0.2854*(1.-0.28*QVAP))                          <a name='2256'>
      THTEU=TU*PI*EXP(RL*QVAP*C5/TU*(1.+0.81*QVAP))               <a name='2257'>
      IF(IFLAG.EQ.1)THEN                                           <a name='2258'>
        QICE=QICE+FRC1*DQVAP+QLIQ                                <a name='2259'>
        QLIQ=0.                                                             <a name='2260'>
      ELSE                                                                   <a name='2261'>
        QICE=QICE+FRC1*(DQVAP+QLQFRZ)                                      <a name='2262'>
        QLIQ=QLIQ-FRC1*QLQFRZ                                             <a name='2263'>
      ENDIF                                                              <a name='2264'>
      QNWFRZ=0.                                                         <a name='2265'>
                                                                    <a name='2266'>
   END SUBROUTINE DTFRZNEW<a name='2267'>
<a name='2268'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2269'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC    <a name='2270'></font>
<font color=#447700>!  THIS SUBROUTINE INTEGRATES THE AREA UNDER THE CURVE IN THE GAUSSIAN     <a name='2271'></font>
<font color=#447700>!  DISTRIBUTION...THE NUMERICAL APPROXIMATION TO THE INTEGRAL IS TAKEN F  <a name='2272'></font>
<font color=#447700>!   HANDBOOK OF MATHEMATICAL FUNCTIONS WITH FORMULAS, GRAPHS AND MATHEMA <a name='2273'></font>
<font color=#447700>!  TABLES  ED. BY ABRAMOWITZ AND STEGUN, NAT L BUREAU OF STANDARDS APPLI<a name='2274'></font>
<font color=#447700>!  MATHEMATICS SERIES.  JUNE, 1964., MAY, 1968.                        <a name='2275'></font>
<font color=#447700>!                                     JACK KAIN                       <a name='2276'></font>
<font color=#447700>!                                     7/6/89                         <a name='2277'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC     <a name='2278'></font>
<font color=#447700>!***********************************************************************    <a name='2279'></font>
<font color=#447700>!*****    GAUSSIAN TYPE MIXING PROFILE....******************************   <a name='2280'></font>
<A NAME='PROF5'><A href='../../html_code/phys/module_cu_kf.F.html#PROF5' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2281'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>PROF5</font>(EQ,EE,UD)                                           <A href='../../call_to/PROF5.html' TARGET='index'>3</A><a name='2282'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2283'></font>
   IMPLICIT NONE<a name='2284'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2285'></font>
   REAL,         INTENT(IN   )   :: EQ<a name='2286'>
   REAL,         INTENT(INOUT)   :: EE,UD<a name='2287'>
   REAL ::       SQRT2P,A1,A2,A3,P,SIGMA,FE,X,Y,EY,E45,T1,T2,C1,C2<a name='2288'>
<a name='2289'>
      DATA SQRT2P,A1,A2,A3,P,SIGMA,FE/2.506628,0.4361836,-0.1201676,    &amp; <a name='2290'>
      0.9372980,0.33267,0.166666667,0.202765151/                        <a name='2291'>
      X=(EQ-0.5)/SIGMA                                                 <a name='2292'>
      Y=6.*EQ-3.                                                      <a name='2293'>
      EY=EXP(Y*Y/(-2))                                               <a name='2294'>
      E45=EXP(-4.5)                                                 <a name='2295'>
      T2=1./(1.+P*ABS(Y))                                          <a name='2296'>
      T1=0.500498                                                 <a name='2297'>
      C1=A1*T1+A2*T1*T1+A3*T1*T1*T1                              <a name='2298'>
      C2=A1*T2+A2*T2*T2+A3*T2*T2*T2                             <a name='2299'>
      IF(Y.GE.0.)THEN                                                    <a name='2300'>
        EE=SIGMA*(0.5*(SQRT2P-E45*C1-EY*C2)+SIGMA*(E45-EY))-E45*EQ*EQ/2.<a name='2301'>
        UD=SIGMA*(0.5*(EY*C2-E45*C1)+SIGMA*(E45-EY))-E45*(0.5+EQ*EQ/2.-  &amp;<a name='2302'>
           EQ)                                                         <a name='2303'>
      ELSE                                                            <a name='2304'>
        EE=SIGMA*(0.5*(EY*C2-E45*C1)+SIGMA*(E45-EY))-E45*EQ*EQ/2.    <a name='2305'>
        UD=SIGMA*(0.5*(SQRT2P-E45*C1-EY*C2)+SIGMA*(E45-EY))-E45*(0.5+EQ* &amp; <a name='2306'>
           EQ/2.-EQ)                                                     <a name='2307'>
      ENDIF                                                             <a name='2308'>
      EE=EE/FE                                                         <a name='2309'>
      UD=UD/FE                                                        <a name='2310'>
<a name='2311'>
   END SUBROUTINE PROF5<a name='2312'>
<a name='2313'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2314'></font>
<A NAME='TPMIX'><A href='../../html_code/phys/module_cu_kf.F.html#TPMIX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2315'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>TPMIX</font>(P,THTU,TU,QU,QLIQ,QICE,QNEWLQ,QNEWIC,RATIO2,RL,    &amp;  <A href='../../call_to/TPMIX.html' TARGET='index'>3</A><a name='2316'>
                    XLV0,XLV1,XLS0,XLS1,                               &amp;<a name='2317'>
                    EP2,ALIQ,BLIQ,CLIQ,DLIQ,AICE,BICE,CICE,DICE        )      <a name='2318'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2319'></font>
   IMPLICIT NONE<a name='2320'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2321'></font>
   REAL,         INTENT(IN   )   :: XLV0,XLV1<a name='2322'>
   REAL,         INTENT(IN   )   :: P,THTU,RATIO2,RL,XLS0,             &amp;<a name='2323'>
                                    XLS1,EP2,ALIQ,BLIQ,CLIQ,DLIQ,AICE,BICE,&amp;<a name='2324'>
                                    CICE,DICE<a name='2325'>
   REAL,         INTENT(INOUT)   :: QU,QLIQ,QICE,TU,QNEWLQ,QNEWIC<a name='2326'>
   REAL    ::    ES,QS,PI,THTGS,F0,T1,T0,C5,RV,ESLIQ,ESICE,F1,DT,QNEW, &amp;<a name='2327'>
                 DQ, QTOT,DQICE,DQLIQ,RLL,CCP<a name='2328'>
   INTEGER ::    ITCNT<a name='2329'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2330'></font>
<font color=#447700>!                                                                       <a name='2331'></font>
<font color=#447700>!...THIS SUBROUTINE ITERATIVELY EXTRACTS WET-BULB TEMPERATURE FROM EQUIV<a name='2332'></font>
<font color=#447700>!   POTENTIAL TEMPERATURE, THEN CHECKS TO SEE IF SUFFICIENT MOISTURE IS<a name='2333'></font>
<font color=#447700>!   AVAILABLE TO ACHIEVE SATURATION...IF NOT, TEMPERATURE IS ADJUSTED <a name='2334'></font>
<font color=#447700>!   ACCORDINGLY, IF SO, THE RESIDUAL LIQUID WATER/ICE CONCENTRATION IS<a name='2335'></font>
<font color=#447700>!   DETERMINED...                                                    <a name='2336'></font>
<font color=#447700>!                                                                   <a name='2337'></font>
      C5=1.0723E-3                                                 <a name='2338'>
      RV=461.5                                                    <a name='2339'>
<font color=#447700>!                                                                <a name='2340'></font>
<font color=#447700>!   ITERATE TO FIND WET BULB TEMPERATURE AS A FUNCTION OF EQUIVALENT POT <a name='2341'></font>
<font color=#447700>!   TEMP AND PRS, ASSUMING SATURATION VAPOR PRESSURE...RATIO2 IS THE DEG<a name='2342'></font>
<font color=#447700>!   OF GLACIATION...                                                   <a name='2343'></font>
<font color=#447700>!                                                                     <a name='2344'></font>
      IF(RATIO2.LT.1.E-6)THEN                                        <a name='2345'>
        ES=ALIQ*EXP((BLIQ*TU-CLIQ)/(TU-DLIQ))                       <a name='2346'>
        QS=EP2*ES/(P-ES)                                         <a name='2347'>
        PI=(1.E5/P)**(0.2854*(1.-0.28*QS))                        <a name='2348'>
        THTGS=TU*PI*EXP((3374.6525/TU-2.5403)*QS*(1.+0.81*QS))   <a name='2349'>
      ELSEIF(ABS(RATIO2-1.).LT.1.E-6)THEN                       <a name='2350'>
        ES=AICE*EXP((BICE*TU-CICE)/(TU-DICE))                  <a name='2351'>
        QS=EP2*ES/(P-ES)                                    <a name='2352'>
        PI=(1.E5/P)**(0.2854*(1.-0.28*QS))                   <a name='2353'>
        THTGS=TU*PI*EXP((3114.834/TU-0.278296)*QS*(1.+0.81*QS))          <a name='2354'>
      ELSE                                                              <a name='2355'>
        ESLIQ=ALIQ*EXP((BLIQ*TU-CLIQ)/(TU-DLIQ))                       <a name='2356'>
        ESICE=AICE*EXP((BICE*TU-CICE)/(TU-DICE))                      <a name='2357'>
        ES=(1.-RATIO2)*ESLIQ+RATIO2*ESICE                            <a name='2358'>
        QS=EP2*ES/(P-ES)                                          <a name='2359'>
        PI=(1.E5/P)**(0.2854*(1.-0.28*QS))                         <a name='2360'>
        THTGS=TU*PI*EXP(RL*QS*C5/TU*(1.+0.81*QS))                 <a name='2361'>
      ENDIF                                                      <a name='2362'>
      F0=THTGS-THTU                                             <a name='2363'>
      T1=TU-0.5*F0                                             <a name='2364'>
      T0=TU                                                   <a name='2365'>
      ITCNT=0                                                <a name='2366'>
   90 IF(RATIO2.LT.1.E-6)THEN                               <a name='2367'>
        ES=ALIQ*EXP((BLIQ*T1-CLIQ)/(T1-DLIQ))              <a name='2368'>
        QS=EP2*ES/(P-ES)                                 <a name='2369'>
        PI=(1.E5/P)**(0.2854*(1.-0.28*QS))                 <a name='2370'>
        THTGS=T1*PI*EXP((3374.6525/T1-2.5403)*QS*(1.+0.81*QS))    <a name='2371'>
      ELSEIF(ABS(RATIO2-1.).LT.1.E-6)THEN                        <a name='2372'>
        ES=AICE*EXP((BICE*T1-CICE)/(T1-DICE))                  <a name='2373'>
        QS=EP2*ES/(P-ES)                                    <a name='2374'>
        PI=(1.E5/P)**(0.2854*(1.-0.28*QS))                   <a name='2375'>
        THTGS=T1*PI*EXP((3114.834/T1-0.278296)*QS*(1.+0.81*QS))     <a name='2376'>
      ELSE                                                         <a name='2377'>
        ESLIQ=ALIQ*EXP((BLIQ*T1-CLIQ)/(T1-DLIQ))                  <a name='2378'>
        ESICE=AICE*EXP((BICE*T1-CICE)/(T1-DICE))                 <a name='2379'>
        ES=(1.-RATIO2)*ESLIQ+RATIO2*ESICE                       <a name='2380'>
        QS=EP2*ES/(P-ES)                                     <a name='2381'>
        PI=(1.E5/P)**(0.2854*(1.-0.28*QS))                    <a name='2382'>
        THTGS=T1*PI*EXP(RL*QS*C5/T1*(1.+0.81*QS))            <a name='2383'>
      ENDIF                                                 <a name='2384'>
      F1=THTGS-THTU                                        <a name='2385'>
      IF(ABS(F1).LT.0.01)GOTO 50         <a name='2386'>
      ITCNT=ITCNT+1                                               <a name='2387'>
      IF(ITCNT.GT.10)GOTO 50                                     <a name='2388'>
      DT=F1*(T1-T0)/(F1-F0)                                     <a name='2389'>
      T0=T1                                                   <a name='2390'>
      F0=F1                                                  <a name='2391'>
      T1=T1-DT                                              <a name='2392'>
      GOTO 90                                              <a name='2393'>
<font color=#447700>!                                                         <a name='2394'></font>
<font color=#447700>!   IF THE PARCEL IS SUPERSATURATED, CALCULATE CONCENTRATION OF FRESH    <a name='2395'></font>
<font color=#447700>!   CONDENSATE...                                                       <a name='2396'></font>
<font color=#447700>!                                                                      <a name='2397'></font>
   50 IF(QS.LE.QU)THEN                                                <a name='2398'>
        QNEW=QU-QS                                                   <a name='2399'>
        QU=QS                                                       <a name='2400'>
        GOTO 96                                                          <a name='2401'>
      ENDIF                                                             <a name='2402'>
<font color=#447700>!                                                                      <a name='2403'></font>
<font color=#447700>!   IF THE PARCEL IS SUBSATURATED, TEMPERATURE AND MIXING RATIO MUST BE  <a name='2404'></font>
<font color=#447700>!   ADJUSTED...IF LIQUID WATER OR ICE IS PRESENT, IT IS ALLOWED TO EVAPO<a name='2405'></font>
<font color=#447700>!   SUBLIMATE.                                                         <a name='2406'></font>
<font color=#447700>!                                                                     <a name='2407'></font>
      QNEW=0.                                                        <a name='2408'>
      DQ=QS-QU                                                      <a name='2409'>
      QTOT=QLIQ+QICE                                               <a name='2410'>
<font color=#447700>!                                                                 <a name='2411'></font>
<font color=#447700>!   IF THERE IS ENOUGH LIQUID OR ICE TO SATURATE THE PARCEL, TEMP STAYS   <a name='2412'></font>
<font color=#447700>!   WET BULB VALUE, VAPOR MIXING RATIO IS AT SATURATED LEVEL, AND THE MI <a name='2413'></font>
<font color=#447700>!   RATIOS OF LIQUID AND ICE ARE ADJUSTED TO MAKE UP THE ORIGINAL SATURA<a name='2414'></font>
<font color=#447700>!   DEFICIT... OTHERWISE, ANY AVAILABLE LIQ OR ICE VAPORIZES AND APPROPR  <a name='2415'></font>
<font color=#447700>!   ADJUSTMENTS TO PARCEL TEMP; VAPOR, LIQUID, AND ICE MIXING RATIOS ARE <a name='2416'></font>
<font color=#447700>!                                                                       <a name='2417'></font>
<font color=#447700>!...NOTE THAT THE LIQ AND ICE MAY BE PRESENT IN PROPORTIONS SLIGHTLY DIF <a name='2418'></font>
<font color=#447700>!   THAN SUGGESTED BY THE VALUE OF RATIO2...CHECK TO MAKE SURE THAT LIQ <a name='2419'></font>
<font color=#447700>!   ICE CONCENTRATIONS ARE NOT REDUCED TO BELOW ZERO WHEN EVAPORATION/<a name='2420'></font>
<font color=#447700>!   SUBLIMATION OCCURS...                                            <a name='2421'></font>
<font color=#447700>!                                                                   <a name='2422'></font>
      IF(QTOT.GE.DQ)THEN                                           <a name='2423'>
        DQICE=0.0                                                 <a name='2424'>
        DQLIQ=0.0                                                <a name='2425'>
        QLIQ=QLIQ-(1.-RATIO2)*DQ                                <a name='2426'>
        IF(QLIQ.LT.0.)THEN                                     <a name='2427'>
          DQICE=0.0-QLIQ                                      <a name='2428'>
          QLIQ=0.0                                                   <a name='2429'>
        ENDIF                                                       <a name='2430'>
        QICE=QICE-RATIO2*DQ+DQICE                                  <a name='2431'>
        IF(QICE.LT.0.)THEN                                        <a name='2432'>
          DQLIQ=0.0-QICE                                         <a name='2433'>
          QICE=0.0                                              <a name='2434'>
        ENDIF                                                  <a name='2435'>
        QLIQ=QLIQ+DQLIQ                                       <a name='2436'>
        QU=QS                                                <a name='2437'>
        GOTO 96                                             <a name='2438'>
      ELSE                                                  <a name='2439'>
        IF(RATIO2.LT.1.E-6)THEN                             <a name='2440'>
          RLL=XLV0-XLV1*T1                                             <a name='2441'>
        ELSEIF(ABS(RATIO2-1.).LT.1.E-6)THEN                           <a name='2442'>
          RLL=XLS0-XLS1*T1                                           <a name='2443'>
        ELSE                                                        <a name='2444'>
          RLL=RL                                                   <a name='2445'>
        ENDIF                                                     <a name='2446'>
        CCP=1005.7*(1.+0.89*QU)                                            <a name='2447'>
        IF(QTOT.LT.1.E-10)THEN                                           <a name='2448'>
<font color=#447700>!                                                                       <a name='2449'></font>
<font color=#447700>!...IF NO LIQUID WATER OR ICE IS AVAILABLE, TEMPERATURE IS GIVEN BY:   <a name='2450'></font>
          T1=T1+RLL*(DQ/(1.+DQ))/CCP                                   <a name='2451'>
          GOTO 96                                                    <a name='2452'>
        ELSE                                                        <a name='2453'>
<font color=#447700>!                                                                  <a name='2454'></font>
<font color=#447700>!...IF SOME LIQ WATER/ICE IS AVAILABLE, BUT NOT ENOUGH TO ACHIEVE SATURA <a name='2455'></font>
<font color=#447700>!   THE TEMPERATURE IS GIVEN BY:                                        <a name='2456'></font>
          T1=T1+RLL*((DQ-QTOT)/(1+DQ-QTOT))/CCP                             <a name='2457'>
          QU=QU+QTOT                                                      <a name='2458'>
          QTOT=0.                                                        <a name='2459'>
        ENDIF                                                           <a name='2460'>
        QLIQ=0                                                         <a name='2461'>
        QICE=0.                                                       <a name='2462'>
      ENDIF                                                          <a name='2463'>
   96 TU=T1                                                             <a name='2464'>
      QNEWLQ=(1.-RATIO2)*QNEW                                          <a name='2465'>
      QNEWIC=RATIO2*QNEW                                             <a name='2466'>
      IF(ITCNT.GT.10)PRINT*,'***** NUMBER OF ITERATIONS IN TPMIX =',   &amp; <a name='2467'>
        ITCNT                                                       <a name='2468'>
<a name='2469'>
   END SUBROUTINE TPMIX<a name='2470'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2471'></font>
<A NAME='ENVIRTHT'><A href='../../html_code/phys/module_cu_kf.F.html#ENVIRTHT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2472'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>ENVIRTHT</font>(P1,T1,Q1,THT1,R1,RL,                            &amp;  <A href='../../call_to/ENVIRTHT.html' TARGET='index'>12</A><a name='2473'>
                       EP2,ALIQ,BLIQ,CLIQ,DLIQ,AICE,BICE,CICE,DICE     )<a name='2474'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2475'></font>
   IMPLICIT NONE<a name='2476'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2477'></font>
   REAL,  INTENT(IN   ) :: P1,T1,Q1,R1,RL,EP2,ALIQ,BLIQ,CLIQ,DLIQ,AICE,&amp;<a name='2478'>
                           BICE,CICE,DICE      <a name='2479'>
   REAL,  INTENT(INOUT) :: THT1<a name='2480'>
   REAL:: T00,P00,C1,C2,C3,C4,C5,EE,TLOG,TDPT,TSAT,THT,TFPT,TLOGIC,    &amp;<a name='2481'>
          TSATLQ,TSATIC<a name='2482'>
<a name='2483'>
      DATA T00,P00,C1,C2,C3,C4,C5/273.16,1.E5,3374.6525,2.5403,3114.834,&amp;<a name='2484'>
           0.278296,1.0723E-3/                                       <a name='2485'>
<font color=#447700>!                                                                   <a name='2486'></font>
<font color=#447700>!  CALCULATE ENVIRONMENTAL EQUIVALENT POTENTIAL TEMPERATURE...     <a name='2487'></font>
<font color=#447700>!                                                                 <a name='2488'></font>
<a name='2489'>
      IF(R1.LT.1.E-6)THEN                                        <a name='2490'>
        EE=Q1*P1/(EP2+Q1)                                     <a name='2491'>
        TLOG=ALOG(EE/ALIQ)                                     <a name='2492'>
        TDPT=(CLIQ-DLIQ*TLOG)/(BLIQ-TLOG)                     <a name='2493'>
        TSAT=TDPT-(.212+1.571E-3*(TDPT-T00)-4.36E-4*(T1-T00))*(T1-TDPT)<a name='2494'>
        THT=T1*(P00/P1)**(0.2854*(1.-0.28*Q1))                        <a name='2495'>
        THT1=THT*EXP((C1/TSAT-C2)*Q1*(1.+0.81*Q1))                   <a name='2496'>
      ELSEIF(ABS(R1-1.).LT.1.E-6)THEN                               <a name='2497'>
        EE=Q1*P1/(EP2+Q1)                                        <a name='2498'>
        TLOG=ALOG(EE/AICE)                                        <a name='2499'>
        TFPT=(CICE-DICE*TLOG)/(BICE-TLOG)                        <a name='2500'>
        THT=T1*(P00/P1)**(0.2854*(1.-0.28*Q1))                  <a name='2501'>
        TSAT=TFPT-(.182+1.13E-3*(TFPT-T00)-3.58E-4*(T1-T00))*(T1-TFPT)<a name='2502'>
        THT1=THT*EXP((C3/TSAT-C4)*Q1*(1.+0.81*Q1))                   <a name='2503'>
      ELSE                                                          <a name='2504'>
        EE=Q1*P1/(EP2+Q1)                                        <a name='2505'>
        TLOG=ALOG(EE/ALIQ)                                        <a name='2506'>
        TDPT=(CLIQ-DLIQ*TLOG)/(BLIQ-TLOG)                        <a name='2507'>
        TLOGIC=ALOG(EE/AICE)                                    <a name='2508'>
        TFPT=(CICE-DICE*TLOGIC)/(BICE-TLOGIC)                  <a name='2509'>
        THT=T1*(P00/P1)**(0.2854*(1.-0.28*Q1))                <a name='2510'>
        TSATLQ=TDPT-(.212+1.571E-3*(TDPT-T00)-4.36E-4*(T1-T00))*(T1-TDPT)                                                       <a name='2511'>
        TSATIC=TFPT-(.182+1.13E-3*(TFPT-T00)-3.58E-4*(T1-T00))*(T1-TFPT) <a name='2512'>
        TSAT=R1*TSATIC+(1.-R1)*TSATLQ                                   <a name='2513'>
        THT1=THT*EXP(RL*Q1*C5/TSAT*(1.+0.81*Q1))                       <a name='2514'>
      ENDIF                                                           <a name='2515'>
<a name='2516'>
   END SUBROUTINE ENVIRTHT<a name='2517'>
<a name='2518'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2519'></font>
<font color=#447700>!************************* TPDD.FOR ************************************  <a name='2520'></font>
<font color=#447700>!   THIS SUBROUTINE ITERATIVELY EXTRACTS TEMPERATURE FROM EQUIVALENT   * <a name='2521'></font>
<font color=#447700>!   POTENTIAL TEMP.  IT IS DESIGNED FOR USE WITH DOWNDRAFT CALCULATIONS.<a name='2522'></font>
<font color=#447700>!   IF RELATIVE HUMIDITY IS SPECIFIED TO BE LESS THAN 100%, PARCEL     * <a name='2523'></font>
<font color=#447700>!   TEMP, SPECIFIC HUMIDITY, AND LIQUID WATER CONTENT ARE ITERATIVELY  *<a name='2524'></font>
<font color=#447700>!   CALCULATED.                                                        * <a name='2525'></font>
<font color=#447700>!***********************************************************************<a name='2526'></font>
<A NAME='TPDD'><A href='../../html_code/phys/module_cu_kf.F.html#TPDD' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2527'>
      <font color=#993300>FUNCTION </font><font color=#cc0000>TPDD</font>(P,THTED,TGS,RS,RD,RH,XLV0,XLV1,                    &amp;        <a name='2528'>
                    EP2,ALIQ,BLIQ,CLIQ,DLIQ,AICE,BICE,CICE,DICE        ) <a name='2529'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2530'></font>
   IMPLICIT NONE<a name='2531'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2532'></font>
   REAL,   INTENT(IN   )   :: XLV0,XLV1<a name='2533'>
   REAL,   INTENT(IN   )   :: P,THTED,TGS,RD,RH,EP2,ALIQ,BLIQ,         &amp;<a name='2534'>
                              CLIQ,DLIQ,AICE,BICE,CICE,DICE <a name='2535'>
   REAL,   INTENT(INOUT)   :: RS<a name='2536'>
   REAL    :: TPDD,ES,PI,THTGS,F0,T1,T0,CCP,F1,DT,RL,DSSDT,T1RH,RSRH<a name='2537'>
   INTEGER :: ITCNT<a name='2538'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2539'></font>
      ES=ALIQ*EXP((BLIQ*TGS-CLIQ)/(TGS-DLIQ))                        <a name='2540'>
      RS=EP2*ES/(P-ES)                                            <a name='2541'>
      PI=(1.E5/P)**(0.2854*(1.-0.28*RS))                           <a name='2542'>
      THTGS=TGS*PI*EXP((3374.6525/TGS-2.5403)*RS*(1.+0.81*RS))    <a name='2543'>
      F0=THTGS-THTED                                             <a name='2544'>
      T1=TGS-0.5*F0                                             <a name='2545'>
      T0=TGS                                                   <a name='2546'>
      CCP=1005.7                                               <a name='2547'>
<font color=#447700>!                                                                          <a name='2548'></font>
<font color=#447700>!...ITERATE TO FIND WET-BULB TEMPERATURE...                               <a name='2549'></font>
<font color=#447700>!                                                                        <a name='2550'></font>
      ITCNT=0                                                           <a name='2551'>
   90 ES=ALIQ*EXP((BLIQ*T1-CLIQ)/(T1-DLIQ))                            <a name='2552'>
      RS=EP2*ES/(P-ES)                                              <a name='2553'>
      PI=(1.E5/P)**(0.2854*(1.-0.28*RS))                             <a name='2554'>
      THTGS=T1*PI*EXP((3374.6525/T1-2.5403)*RS*(1.+0.81*RS))        <a name='2555'>
      F1=THTGS-THTED                                               <a name='2556'>
      IF(ABS(F1).LT.0.05)GOTO 50                                  <a name='2557'>
      ITCNT=ITCNT+1                                              <a name='2558'>
      IF(ITCNT.GT.10)GOTO 50                                    <a name='2559'>
      DT=F1*(T1-T0)/(F1-F0)                                    <a name='2560'>
      T0=T1                                                <a name='2561'>
      F0=F1                                                   <a name='2562'>
      T1=T1-DT                                               <a name='2563'>
      GOTO 90                                               <a name='2564'>
   50 RL=XLV0-XLV1*T1                                        <a name='2565'>
<font color=#447700>!                                                           <a name='2566'></font>
<font color=#447700>!...IF RELATIVE HUMIDITY IS SPECIFIED TO BE LESS THAN 100%, ESTIMATE THE  <a name='2567'></font>
<font color=#447700>!   TEMPERATURE AND MIXING RATIO WHICH WILL YIELD THE APPROPRIATE VALUE. <a name='2568'></font>
<font color=#447700>!                                                                       <a name='2569'></font>
      IF(RH.EQ.1.)GOTO 110                                             <a name='2570'>
      DSSDT=(CLIQ-BLIQ*DLIQ)/((T1-DLIQ)*(T1-DLIQ))                    <a name='2571'>
      DT=RL*RS*(1.-RH)/(CCP+RL*RH*RS*DSSDT)                           <a name='2572'>
      T1RH=T1+DT                                                    <a name='2573'>
      ES=RH*ALIQ*EXP((BLIQ*T1RH-CLIQ)/(T1RH-DLIQ))                        <a name='2574'>
      RSRH=EP2*ES/(P-ES)                                               <a name='2575'>
<font color=#447700>!                                                                       <a name='2576'></font>
<font color=#447700>!...CHECK TO SEE IF MIXING RATIO AT SPECIFIED RH IS LESS THAN ACTUAL   <a name='2577'></font>
<font color=#447700>!...MIXING RATIO...IF SO, ADJUST TO GIVE ZERO EVAPORATION...          <a name='2578'></font>
<font color=#447700>!                                                                    <a name='2579'></font>
      IF(RSRH.LT.RD)THEN                                            <a name='2580'>
        RSRH=RD                                                    <a name='2581'>
        T1RH=T1+(RS-RSRH)*RL/CCP                                   <a name='2582'>
      ENDIF                                                      <a name='2583'>
      T1=T1RH                                                   <a name='2584'>
      RS=RSRH                                                  <a name='2585'>
  110 TPDD=T1                                                 <a name='2586'>
      IF(ITCNT.GT.10)PRINT*,'***** NUMBER OF ITERATIONS IN TPDD = ',  &amp; <a name='2587'>
        ITCNT                                                         <a name='2588'>
<a name='2589'>
   END FUNCTION TPDD<a name='2590'>
<a name='2591'>
<font color=#447700>!====================================================================<a name='2592'></font>
<A NAME='KFINIT'><A href='../../html_code/phys/module_cu_kf.F.html#KFINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2593'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>kfinit</font>(RTHCUTEN,RQVCUTEN,RQCCUTEN,RQRCUTEN,           &amp; <A href='../../call_to/KFINIT.html' TARGET='index'>1</A><a name='2594'>
                     RQICUTEN,RQSCUTEN,NCA,W0AVG,P_QI,P_QS,         &amp;<a name='2595'>
                     P_FIRST_SCALAR,restart,allowed_to_read,        &amp;<a name='2596'>
                     ids, ide, jds, jde, kds, kde,                  &amp;<a name='2597'>
                     ims, ime, jms, jme, kms, kme,                  &amp;<a name='2598'>
                     its, ite, jts, jte, kts, kte                   )<a name='2599'>
<font color=#447700>!--------------------------------------------------------------------   <a name='2600'></font>
   IMPLICIT NONE<a name='2601'>
<font color=#447700>!--------------------------------------------------------------------<a name='2602'></font>
   LOGICAL , INTENT(IN)           ::  restart, allowed_to_read<a name='2603'>
   INTEGER , INTENT(IN)           ::  ids, ide, jds, jde, kds, kde, &amp;<a name='2604'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='2605'>
                                      its, ite, jts, jte, kts, kte<a name='2606'>
   INTEGER , INTENT(IN)           ::  P_QI,P_QS,P_FIRST_SCALAR<a name='2607'>
<a name='2608'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::       &amp;<a name='2609'>
                                                          RTHCUTEN, &amp;<a name='2610'>
                                                          RQVCUTEN, &amp;<a name='2611'>
                                                          RQCCUTEN, &amp;<a name='2612'>
                                                          RQRCUTEN, &amp;<a name='2613'>
                                                          RQICUTEN, &amp;<a name='2614'>
                                                          RQSCUTEN<a name='2615'>
<a name='2616'>
   REAL ,   DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) :: W0AVG<a name='2617'>
<a name='2618'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT):: NCA<a name='2619'>
<a name='2620'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='2621'>
 <a name='2622'>
   jtf=min0(jte,jde-1)<a name='2623'>
   ktf=min0(kte,kde-1)<a name='2624'>
   itf=min0(ite,ide-1)<a name='2625'>
 <a name='2626'>
   IF(.not.restart)THEN<a name='2627'>
     DO j=jts,jtf<a name='2628'>
     DO k=kts,ktf<a name='2629'>
     DO i=its,itf<a name='2630'>
        RTHCUTEN(i,k,j)=0.<a name='2631'>
        RQVCUTEN(i,k,j)=0.<a name='2632'>
        RQCCUTEN(i,k,j)=0.<a name='2633'>
        RQRCUTEN(i,k,j)=0.<a name='2634'>
     ENDDO<a name='2635'>
     ENDDO<a name='2636'>
     ENDDO<a name='2637'>
<a name='2638'>
     IF (P_QI .ge. P_FIRST_SCALAR) THEN<a name='2639'>
        DO j=jts,jtf<a name='2640'>
        DO k=kts,ktf<a name='2641'>
        DO i=its,itf<a name='2642'>
           RQICUTEN(i,k,j)=0.<a name='2643'>
        ENDDO<a name='2644'>
        ENDDO<a name='2645'>
        ENDDO<a name='2646'>
     ENDIF<a name='2647'>
<a name='2648'>
     IF (P_QS .ge. P_FIRST_SCALAR) THEN<a name='2649'>
        DO j=jts,jtf<a name='2650'>
        DO k=kts,ktf<a name='2651'>
        DO i=its,itf<a name='2652'>
           RQSCUTEN(i,k,j)=0.<a name='2653'>
        ENDDO<a name='2654'>
        ENDDO<a name='2655'>
        ENDDO<a name='2656'>
     ENDIF<a name='2657'>
<a name='2658'>
     DO j=jts,jtf<a name='2659'>
     DO i=its,itf<a name='2660'>
        NCA(i,j)=-100.<a name='2661'>
     ENDDO<a name='2662'>
     ENDDO<a name='2663'>
<a name='2664'>
     DO j=jts,jtf<a name='2665'>
     DO k=kts,ktf<a name='2666'>
     DO i=its,itf<a name='2667'>
        W0AVG(i,k,j)=0.<a name='2668'>
     ENDDO<a name='2669'>
     ENDDO<a name='2670'>
     ENDDO<a name='2671'>
<a name='2672'>
   ENDIF<a name='2673'>
<a name='2674'>
   END SUBROUTINE kfinit<a name='2675'>
<a name='2676'>
<font color=#447700>!-------------------------------------------------------<a name='2677'></font>
<a name='2678'>
END MODULE module_cu_kf<a name='2679'>
<a name='2680'>
</pre></body></html>