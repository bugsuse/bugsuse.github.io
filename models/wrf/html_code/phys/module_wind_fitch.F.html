<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='2'></font>
<a name='3'>
<A NAME='MODULE_WIND_FITCH'><A href='../../html_code/phys/module_wind_fitch.F.html#MODULE_WIND_FITCH' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
<font color=#993300>MODULE </font><font color=#cc0000>module_wind_fitch</font> <A href='../../call_to/MODULE_WIND_FITCH.html' TARGET='index'>2</A><a name='5'>
<font color=#447700>!<a name='6'></font>
<font color=#447700>!Represents kinetic energy extracted by wind turbines and turbulence<a name='7'></font>
<font color=#447700>! (TKE) they produce at model levels within the rotor area.<a name='8'></font>
<font color=#447700>!<a name='9'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='10'></font>
<font color=#447700>!! NOTICE<a name='11'></font>
<font color=#447700>!! The following paper should be cited whenever presenting results using this scheme<a name='12'></font>
<font color=#447700>!! (using either the original version or any modified versions of the scheme):<a name='13'></font>
<font color=#447700>!! Fitch, A. C. et al. 2012: Local and Mesoscale Impacts of Wind Farms as Parameterized in a<a name='14'></font>
<font color=#447700>!! Mesoscale NWP Model. Monthly Weather Review, doi:http://dx.doi.org/10.1175/MWR-D-11-00352.1<a name='15'></font>
<font color=#447700>!!<a name='16'></font>
<font color=#447700>!! Anna C. Fitch, National Center for Atmospheric Research (formerly University of Bergen)<a name='17'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='18'></font>
<font color=#447700>!<a name='19'></font>
<font color=#447700>! History of changes:<a name='20'></font>
<font color=#447700>!<a name='21'></font>
<font color=#447700>! WRFV3.5.1: <a name='22'></font>
<font color=#447700>! WRFV3.6:   Modified by Pedro A. Jimenez to include:<a name='23'></font>
<font color=#447700>!             - Initialize the wind turbines in this module.<a name='24'></font>
<font color=#447700>!             - Introduce z_at_walls to avoid instabilities due to neglecting<a name='25'></font>
<font color=#447700>!                the perturbation of the geopotential height.<a name='26'></font>
<font color=#447700>!             - User friendly interface to introduce the technical characteritics of<a name='27'></font>
<font color=#447700>!                the wind turbines.<a name='28'></font>
<font color=#447700>!             - Only uses one set of turbine coefficients using the wind speed at hub height<a name='29'></font>
<font color=#447700>!             - Two standing coefficients.<a name='30'></font>
<font color=#447700>!             - Calculates the power produced by the wind turbines.<a name='31'></font>
<font color=#447700>!<a name='32'></font>
<font color=#447700>! References:<a name='33'></font>
<font color=#447700>!<a name='34'></font>
<font color=#447700>! Fitch, A. C. et al. 2012: Local and Mesoscale Impacts of Wind Farms as Parameterized in a<a name='35'></font>
<font color=#447700>!    Mesoscale NWP Model. Monthly Weather Review, doi:http://dx.doi.org/10.1175/MWR-D-11-00352.1<a name='36'></font>
<font color=#447700>! Fitch, A. C. et al. 2013: Mesoscale Influences of Wind Farms Throughout a Diurnal Cycle.<a name='37'></font>
<font color=#447700>!    Monthly Weather Review, doi:http://dx.doi.org/10.1175/MWR-D-12-00185.1<a name='38'></font>
<font color=#447700>! Fitch, A. C. et al. 2013: Parameterization of Wind Farms in Climate Models.<a name='39'></font>
<font color=#447700>!    Journal of Climate, doi:http://dx.doi.org/10.1175/JCLI-D-12-00376.1<a name='40'></font>
<font color=#447700>! Jimenez, P.A., J. Navarro, A.M. Palomares and J. Dudhia:  Mesoscale modeling of offshore wind turbines<a name='41'></font>
<font color=#447700>!    wakes at the wind farm resolving scale: a composite-based analysis with the WRF model over Horns Rev. <a name='42'></font>
<font color=#447700>!    Wind Energy, (In Press.).<a name='43'></font>
<font color=#447700>!<a name='44'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='45'></font>
<font color=#447700>!<a name='46'></font>
  USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/phys/module_wind_fitch.F.html#module_wind_fitch.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_55">, ONLY : max_domains<a name='47'>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_wind_fitch.F.html#module_wind_fitch.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_104">, ONLY :  piconst<a name='48'>
<font color=#447700>!<a name='49'></font>
  USE <A href='../../html_code/share/module_llxy.F.html#MODULE_LLXY'>module_llxy</A><A href='../../html_code/phys/module_wind_fitch.F.html#module_wind_fitch.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_LLXY_7"><a name='50'>
  USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/phys/module_wind_fitch.F.html#module_wind_fitch.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_166">, ONLY : wrf_dm_min_real<a name='51'>
  USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/phys/module_wind_fitch.F.html#module_wind_fitch.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_163">, ONLY : grid_config_rec_type<a name='52'>
<a name='53'>
  IMPLICIT NONE<a name='54'>
<a name='55'>
  INTEGER, PARAMETER :: MAXVALS  = 100   <a name='56'>
  INTEGER, PARAMETER :: MAXVALS2 = 100     <a name='57'>
<font color=#447700>!<a name='58'></font>
  INTEGER           :: nt<a name='59'>
  INTEGER, DIMENSION(:), ALLOCATABLE :: NKIND<a name='60'>
  INTEGER, DIMENSION(:,:), ALLOCATABLE :: ival,jval<a name='61'>
  REAL, DIMENSION(:), ALLOCATABLE :: hubheight,diameter,stc,stc2,cutin,cutout,npower<a name='62'>
<font color=#447700>!<a name='63'></font>
  REAL :: turbws(maxvals,maxvals2),turbtc(maxvals,maxvals2),turbpw(maxvals,maxvals2)<a name='64'>
<font color=#447700>!<a name='65'></font>
CONTAINS<a name='66'>
<a name='67'>
<A NAME='DRAGFORCE'><A href='../../html_code/phys/module_wind_fitch.F.html#DRAGFORCE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='68'>
  <font color=#993300>SUBROUTINE  </font><font color=#cc0000>dragforce</font>(                      &amp; <A href='../../call_to/DRAGFORCE.html' TARGET='index'>1</A><a name='69'>
       &amp; id                                      &amp;<a name='70'>
       &amp;,z_at_w,u,v                 &amp;<a name='71'>
       &amp;,dx,dz,dt,qke                            &amp;<a name='72'>
       &amp;,du,dv                                   &amp;<a name='73'>
       &amp;,windfarm_opt,power                      &amp;<a name='74'>
       &amp;,ids,ide,jds,jde,kds,kde                 &amp;<a name='75'>
       &amp;,ims,ime,jms,jme,kms,kme                 &amp;<a name='76'>
       &amp;,its,ite,jts,jte,kts,kte                 &amp;<a name='77'>
       &amp;)  <a name='78'>
<font color=#447700>!<a name='79'></font>
<font color=#447700>!<a name='80'></font>
<font color=#447700>!<a name='81'></font>
  INTEGER, INTENT(IN) :: id,windfarm_opt <a name='82'>
  INTEGER, INTENT(IN) :: its,ite,jts,jte,kts,kte<a name='83'>
  INTEGER, INTENT(IN) :: ims,ime,jms,jme,kms,kme<a name='84'>
  INTEGER, INTENT(IN) :: ids,ide,jds,jde,kds,kde<a name='85'>
  REAL, INTENT(IN) :: dx,dt<a name='86'>
  REAL, DIMENSION(ims:ime,kms:kme,jms:jme), INTENT(IN) :: dz,u,v,z_at_w<a name='87'>
  REAL, DIMENSION(ims:ime,kms:kme,jms:jme), INTENT(INOUT) :: du,dv,qke<a name='88'>
  REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: power<a name='89'>
<font color=#447700>!<a name='90'></font>
<font color=#447700>! Local<a name='91'></font>
<font color=#447700>!<a name='92'></font>
  REAL     blade_l_point,blade_u_point,zheightl,zheightu,z1,z2,tarea<a name='93'>
  REAL     speed,tkecof,powcof,thrcof,wfdensity<a name='94'>
  INTEGER  itf,jtf,ktf<a name='95'>
  INTEGER  i,j,k,n<a name='96'>
  INTEGER  k_turbine_bot, k_turbine_top<a name='97'>
<a name='98'>
  LOGICAL :: kfound<a name='99'>
<font color=#447700>!<a name='100'></font>
<font color=#447700>! ... PAJ: more variables ...<a name='101'></font>
<font color=#447700>!<a name='102'></font>
  REAL :: speedhub,speed1,speed2<a name='103'>
  real :: power1,power2,area,ec<a name='104'>
  INTEGER :: kbot,ktop,kt<a name='105'>
<a name='106'>
  itf=MIN0(ite,ide-1)<a name='107'>
  jtf=MIN0(jte,jde-1)<a name='108'>
  ktf=MIN0(kte,kde-1)<a name='109'>
<a name='110'>
    wfdensity = 1.0/(dx*dx)   <font color=#447700>!  per turbine, so numerator is 1<a name='111'></font>
    power=0.<a name='112'>
<a name='113'>
    DO kt = 1,nt  <a name='114'>
      IF ( windfarm_opt .eq. 1 ) THEN<a name='115'>
<font color=#447700>!<a name='116'></font>
<font color=#447700>! vertical layers cut by turbine blades<a name='117'></font>
<font color=#447700>!<a name='118'></font>
        k_turbine_bot=0      <font color=#447700>!bottom level<a name='119'></font>
        k_turbine_top=-1     <font color=#447700>!top level<a name='120'></font>
        i = ival(kt,id)<a name='121'>
        j = jval(kt,id)<a name='122'>
<font color=#447700>!<a name='123'></font>
         if (i.ne.-9999.and.j.ne.-9999) then<a name='124'>
        IF (( its .LE. i .AND. i .LE. itf ) .AND. &amp;<a name='125'>
            ( jts .LE. j .AND. j .LE. jtf )  ) THEN<a name='126'>
<font color=#447700>!<a name='127'></font>
          blade_l_point=hubheight(kt)-diameter(kt)/2. <font color=#447700>! height of lower blade tip above ground (m)<a name='128'></font>
          blade_u_point=hubheight(kt)+diameter(kt)/2. <font color=#447700>! height of upper blade tip above ground (m)<a name='129'></font>
<font color=#447700>!<a name='130'></font>
          kfound = .false.<a name='131'>
          zheightl=0.0<a name='132'>
          <font color=#447700>! find vertical levels cut by turbine blades<a name='133'></font>
          DO k=kts,ktf<a name='134'>
            IF(.NOT. kfound) THEN<a name='135'>
              zheightu = zheightl + dz(i,k,j) <font color=#447700>! increment height<a name='136'></font>
<a name='137'>
              IF(blade_l_point .GE. zheightl .AND. blade_l_point .LE. zheightu) THEN<a name='138'>
                k_turbine_bot=k <font color=#447700>! lower blade tip cuts this level<a name='139'></font>
              ENDIF<a name='140'>
<a name='141'>
              IF(blade_u_point .GE. zheightl .AND. blade_u_point .LE. zheightu) THEN<a name='142'>
                k_turbine_top=k <font color=#447700>! upper blade tip cuts this level<a name='143'></font>
                kfound = .TRUE.<a name='144'>
              ENDIF<a name='145'>
<a name='146'>
              zheightl = zheightu<a name='147'>
            ENDIF<a name='148'>
          ENDDO<a name='149'>
          IF ( kfound ) THEN<a name='150'>
<font color=#447700>!<a name='151'></font>
<font color=#447700>! ... PAJ: Changes introduced to compute only one set of turbine coefficients ...<a name='152'></font>
<font color=#447700>!          First computes the wind speed at the hub height.<a name='153'></font>
<font color=#447700>!<a name='154'></font>
          kfound = .false.<a name='155'>
          zheightl=0.<a name='156'>
          <font color=#447700>! find vertical levels (half levels) within the hub height<a name='157'></font>
          DO k=kts,ktf<a name='158'>
            IF(.NOT. kfound) THEN<a name='159'>
              z2 = zheightl + 0.5*dz(i,k,j) <a name='160'>
<font color=#447700>!<a name='161'></font>
              IF(hubheight(kt) .GE. z2 ) THEN<a name='162'>
                kbot=k <a name='163'>
              ELSE<a name='164'>
                ktop=k<a name='165'>
                kfound = .TRUE.<a name='166'>
              ENDIF<a name='167'>
<font color=#447700>!<a name='168'></font>
              if (.NOT. kfound) z1=z2<a name='169'>
              zheightl = z2 + 0.5*dz(i,k,j)<a name='170'>
            ENDIF<a name='171'>
          ENDDO<a name='172'>
<font color=#447700>!<a name='173'></font>
          speed1=0.<a name='174'>
          speed2=0.<a name='175'>
          if (ktop.eq.1) then<a name='176'>
           speedhub=sqrt(u(i,1,j)**2.+v(i,1,j)**2.)*hubheight(kt)/z1<a name='177'>
          else<a name='178'>
           speed1=sqrt(u(i,kbot,j)**2.+v(i,kbot,j)**2.)<a name='179'>
           speed2=sqrt(u(i,ktop,j)**2.+v(i,ktop,j)**2.)<a name='180'>
           speedhub=speed1+((speed2-speed1)/(z2-z1))*(hubheight(kt)-z1)<a name='181'>
          endif<a name='182'>
<font color=#447700>!<a name='183'></font>
<font color=#447700>! ... calculate TKE, power and thrust coeffs<a name='184'></font>
<font color=#447700>!<a name='185'></font>
              CALL <A href='../../html_code/phys/module_wind_fitch.F.html#DRAGCOF'>dragcof</A><A href='../../html_code/phys/module_wind_fitch.F.html#module_wind_fitch.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DRAGCOF_1">(tkecof,powcof,thrcof,               &amp;<a name='186'>
                           speedhub,cutin(kt),cutout(kt),   &amp;<a name='187'>
                           npower(kt),diameter(kt),stc(kt),stc2(kt),nkind(kt))<a name='188'>
<font color=#447700>!<a name='189'></font>
<font color=#447700>! ... PAJ: Computation of power generated by the wind turbine ...<a name='190'></font>
<font color=#447700>!<a name='191'></font>
          area=piconst/4.*diameter(kt)**2.          <font color=#447700>! area swept by turbine blades<a name='192'></font>
          power1=0.5*1.23*speedhub**3.*area*powcof<a name='193'>
          power(i,j)=power1+power(i,j)<a name='194'>
          power2=0.<a name='195'>
<font color=#447700>!<a name='196'></font>
            DO k=k_turbine_bot,k_turbine_top <font color=#447700>! loop over turbine blade levels<a name='197'></font>
              z1=z_at_w(i,k,j)-blade_l_point-z_at_w(i,1,j)  <font color=#447700>! distance between k level and lower blade tip<a name='198'></font>
              z2=z_at_w(i,k+1,j)-blade_l_point-z_at_w(i,1,j) <font color=#447700>! distance between k+1 level and lower blade tip<a name='199'></font>
              IF(z1 .LT. 0.) z1=0.0 <font color=#447700>! k level lower than lower blade tip<a name='200'></font>
              IF(z2 .GT. diameter(kt)) z2=diameter(kt) <font color=#447700>! k+1 level higher than turbine upper blade tip<a name='201'></font>
              CALL <A href='../../html_code/phys/module_wind_fitch.F.html#TURBINE_AREA'>turbine_area</A><A href='../../html_code/phys/module_wind_fitch.F.html#module_wind_fitch.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TURBINE_AREA_1">(z1,z2,diameter(kt),wfdensity,tarea)<a name='202'>
<font color=#447700>!<a name='203'></font>
              speed=sqrt(u(i,k,j)**2.+v(i,k,j)**2.)<a name='204'>
              power2=power2+0.5*powcof*1.23*(speed**3.)*tarea/wfdensity<a name='205'>
            ENDDO<a name='206'>
<font color=#447700>!<a name='207'></font>
<font color=#447700>! ... PAJ: Computes the tendencies of TKE and momentum ...<a name='208'></font>
<font color=#447700>!<a name='209'></font>
            DO k=k_turbine_bot,k_turbine_top <font color=#447700>! loop over turbine blade levels<a name='210'></font>
              z1=z_at_w(i,k,j)-blade_l_point-z_at_w(i,1,j)  <font color=#447700>! distance between k lev and lower blade tip<a name='211'></font>
              z2=z_at_w(i,k+1,j)-blade_l_point-z_at_w(i,1,j) <font color=#447700>!distance between k+1 lev and lower blade tip<a name='212'></font>
              IF(z1 .LT. 0.) z1=0.0 <font color=#447700>! k level lower than lower blade tip<a name='213'></font>
              IF(z2 .GT. diameter(kt)) z2=diameter(kt) <font color=#447700>! k+1 level higher than turbine upper blade tip<a name='214'></font>
<font color=#447700>!<a name='215'></font>
              CALL <A href='../../html_code/phys/module_wind_fitch.F.html#TURBINE_AREA'>turbine_area</A><A href='../../html_code/phys/module_wind_fitch.F.html#module_wind_fitch.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TURBINE_AREA_2">(z1,z2,diameter(kt),wfdensity,tarea)<a name='216'>
<font color=#447700>!<a name='217'></font>
              speed=sqrt(u(i,k,j)**2.+v(i,k,j)**2.)<a name='218'>
<font color=#447700>!`<a name='219'></font>
<font color=#447700>! ... PAJ: normalization introduced to conserve energy ...<a name='220'></font>
<font color=#447700>!<a name='221'></font>
              if (power1.eq.0.or.power2.eq.0) then<a name='222'>
              ec=1.<a name='223'>
              else<a name='224'>
              ec=power1/power2<a name='225'>
              endif<a name='226'>
<font color=#447700>!<a name='227'></font>
              <font color=#447700>! output TKE<a name='228'></font>
              qke(i,k,j) = qke(i,k,j)+speed**3.*tarea*tkecof*dt/dz(i,k,j)*ec<a name='229'>
              <font color=#447700>! output u tendency<a name='230'></font>
              du(i,k,j) = du(i,k,j)-.5*u(i,k,j)*thrcof*speed*tarea/dz(i,k,j)*ec<a name='231'>
              <font color=#447700>! output v tendency<a name='232'></font>
              dv(i,k,j) = dv(i,k,j)-.5*v(i,k,j)*thrcof*speed*tarea/dz(i,k,j)*ec<a name='233'>
            ENDDO<a name='234'>
          ENDIF<a name='235'>
        ENDIF<a name='236'>
        endif<a name='237'>
      ENDIF<a name='238'>
    ENDDO<a name='239'>
<a name='240'>
  END SUBROUTINE dragforce<a name='241'>
<a name='242'>
<font color=#447700>! This subroutine calculates area of turbine between two vertical levels<a name='243'></font>
<font color=#447700>! Input variables : <a name='244'></font>
<font color=#447700>!            z1 = distance between k level and lower blade tip<a name='245'></font>
<font color=#447700>!            z2 = distance between k+1 level and lower blade tip<a name='246'></font>
<font color=#447700>!            wfdensity = wind farm density in m^-2<a name='247'></font>
<font color=#447700>!     tdiameter = turbine diameter<a name='248'></font>
<font color=#447700>! Output variable :<a name='249'></font>
<font color=#447700>!         tarea = area of turbine between two levels * wfdensity<a name='250'></font>
<A NAME='TURBINE_AREA'><A href='../../html_code/phys/module_wind_fitch.F.html#TURBINE_AREA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='251'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>turbine_area</font>(z1,z2,tdiameter,wfdensity,tarea) <A href='../../call_to/TURBINE_AREA.html' TARGET='index'>2</A><a name='252'>
<a name='253'>
  REAL, INTENT(IN) ::tdiameter,wfdensity<a name='254'>
  REAL, INTENT(INOUT) ::z1,z2<a name='255'>
  REAL, INTENT(OUT):: tarea<a name='256'>
  REAL r,zc1,zc2<a name='257'>
<a name='258'>
  r=tdiameter/2.              <font color=#447700>!r = turbine radius<a name='259'></font>
  z1=r-z1                   <font color=#447700>!distance of kth level from turbine center <a name='260'></font>
  z2=r-z2                   <font color=#447700>!distance of k+1 th level from turbine center<a name='261'></font>
  zc1=abs(z1)<a name='262'>
  zc2=abs(z2)<a name='263'>
  <font color=#447700>!turbine area between z1 and z2<a name='264'></font>
  IF(z1 .GT. 0. .AND. z2 .GT. 0.) THEN<a name='265'>
     tarea=zc1*sqrt(r*r-zc1*zc1)+r*r*asin(zc1/r)- &amp;<a name='266'>
     (zc2*sqrt(r*r-zc2*zc2)+r*r*asin(zc2/r))<a name='267'>
  ELSE IF(z1 .LT. 0. .AND. z2 .LT. 0.) THEN<a name='268'>
     tarea=zc2*sqrt(r*r-zc2*zc2)+r*r*asin(zc2/r)- &amp;<a name='269'>
     (zc1*sqrt(r*r-zc1*zc1)+r*r*asin(zc1/r))<a name='270'>
  ELSE<a name='271'>
     tarea=zc2*sqrt(r*r-zc2*zc2)+r*r*asin(zc2/r)+ &amp;<a name='272'>
     zc1*sqrt(r*r-zc1*zc1)+r*r*asin(zc1/r)<a name='273'>
  ENDIF<a name='274'>
  tarea=tarea*wfdensity      <font color=#447700>!turbine area * wind farm density <a name='275'></font>
<a name='276'>
  END SUBROUTINE turbine_area<a name='277'>
<a name='278'>
<a name='279'>
<A NAME='DRAGCOF'><A href='../../html_code/phys/module_wind_fitch.F.html#DRAGCOF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='280'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>dragcof</font>(tkecof,powcof,thrcof,speed,cispeed,cospeed, &amp; <A href='../../call_to/DRAGCOF.html' TARGET='index'>1</A><a name='281'>
                     tpower,tdiameter,stdthrcoef,stdthrcoef2,nkind)<a name='282'>
<a name='283'>
<a name='284'>
  REAL, INTENT(IN):: speed, cispeed, cospeed, tpower,tdiameter,stdthrcoef,stdthrcoef2<a name='285'>
  REAL, INTENT(OUT):: tkecof,powcof,thrcof<a name='286'>
  REAL :: power,area,mspeed,hspeed<a name='287'>
<font color=#447700>!<a name='288'></font>
<font color=#447700>! ... PAJ ...<a name='289'></font>
<font color=#447700>!<a name='290'></font>
   INTEGER :: nkind,k,nu,nb<a name='291'>
   LOGICAL :: vfound<a name='292'>
   REAL :: fac1,fac2<a name='293'>
<a name='294'>
  area=piconst/4.*tdiameter**2.          <font color=#447700>! area swept by turbine blades<a name='295'></font>
<a name='296'>
      vfound=.false.<a name='297'>
      DO k=1,maxvals2<a name='298'>
            IF(.NOT. vfound) THEN<a name='299'>
              IF(turbws(nkind,k).GT.speed) THEN<a name='300'>
                nu=k <a name='301'>
                nb=k-1<a name='302'>
                vfound=.true.<a name='303'>
              ENDIF<a name='304'>
            ENDIF<a name='305'>
      ENDDO<a name='306'>
<font color=#447700>!<a name='307'></font>
  IF (speed .LE. cispeed) THEN<a name='308'>
     thrcof = stdthrcoef<a name='309'>
  ELSE<a name='310'>
    IF (speed .GE. cospeed) THEN<a name='311'>
     thrcof = stdthrcoef2<a name='312'>
     ELSE<a name='313'>
     thrcof = turbtc(nkind,nb)+(turbtc(nkind,nu)-turbtc(nkind,nb))/(turbws(nkind,nu)-turbws(nkind,nb))*(speed-turbws(nkind,nb))<a name='314'>
    ENDIF<a name='315'>
  ENDIF<a name='316'>
<font color=#447700>!<a name='317'></font>
<font color=#447700>! ... power coeficient ...<a name='318'></font>
<font color=#447700>!<a name='319'></font>
  IF(speed .LE. cispeed .OR. speed .GE. cospeed) THEN<a name='320'>
     power=0.<a name='321'>
     powcof=0.<a name='322'>
  ELSE<a name='323'>
      fac1=1000./(0.5*1.23*turbws(nkind,nb)**3.*area)<a name='324'>
      fac2=1000./(0.5*1.23*turbws(nkind,nu)**3.*area)<a name='325'>
      power = turbpw(nkind,nb)+(turbpw(nkind,nu)-turbpw(nkind,nb))/(turbws(nkind,nu)-turbws(nkind,nb)) &amp;<a name='326'>
                               *(speed-turbws(nkind,nb))<a name='327'>
      powcof = turbpw(nkind,nb)*fac1+(turbpw(nkind,nu)*fac2-turbpw(nkind,nb)*fac1)/(turbws(nkind,nu)-turbws(nkind,nb)) &amp;<a name='328'>
                                     *(speed-turbws(nkind,nb))<a name='329'>
  ENDIF<a name='330'>
<font color=#447700>!<a name='331'></font>
  <font color=#447700>! tke coefficient calculation <a name='332'></font>
<a name='333'>
  tkecof=thrcof-powcof<a name='334'>
  IF(tkecof .LT. 0.) tkecof=0.<a name='335'>
<font color=#447700>!<a name='336'></font>
  END SUBROUTINE dragcof<a name='337'>
<font color=#447700>!<a name='338'></font>
<A NAME='INIT_MODULE_WIND_FITCH'><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='339'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_module_wind_fitch</font>(id,config_flags,xlong,xlat,windfarm_initialized,&amp; <A href='../../call_to/INIT_MODULE_WIND_FITCH.html' TARGET='index'>1</A>,<A href='../../call_from/INIT_MODULE_WIND_FITCH.html' TARGET='index'>21</A><a name='340'>
                                            ims,ime,jms,jme,its,ite,jts,jte,ids,ide,jds,jde)<a name='341'>
<font color=#447700>!<a name='342'></font>
  IMPLICIT NONE<a name='343'>
<font color=#447700>!<a name='344'></font>
   integer ims,ime,jms,jme,ids,ide,jds,jde<a name='345'>
   integer its,ite,jts,jte<a name='346'>
   REAL,     DIMENSION( ims:ime , jms:jme ) , INTENT(IN) :: xlong,xlat<a name='347'>
   TYPE (grid_config_rec_type) :: config_flags<a name='348'>
   TYPE (PROJ_INFO) :: ts_proj<a name='349'>
   logical :: windfarm_initialized<a name='350'>
<font color=#447700>! <a name='351'></font>
   CHARACTER*256 num,input,message_wind<a name='352'>
   real lat,lon,ts_rx,ts_ry<a name='353'>
   REAL :: known_lat, known_lon<a name='354'>
   INTEGER i,j,nval,k,id<a name='355'>
<a name='356'>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='357'>
<font color=#447700>!<a name='358'></font>
      IF ( wrf_dm_on_monitor() ) THEN<a name='359'>
<font color=#447700>!<a name='360'></font>
<font color=#447700>! ... PAJ: Opens the file with the location of the wind turbines ...<a name='361'></font>
<font color=#447700>!<a name='362'></font>
        if ( config_flags%windfarm_ij .eq. 1 ) then<a name='363'>
          open(70,file='windturbines-ij.txt',form='formatted',status='old')<a name='364'>
        else<a name='365'>
          open(70,file='windturbines.txt',form='formatted',status='old')<a name='366'>
        end if<a name='367'>
<font color=#447700>!<a name='368'></font>
<font color=#447700>! ... PAJ: Counts the turbines ...<a name='369'></font>
<font color=#447700>!<a name='370'></font>
       nt=0<a name='371'>
 10    read(70,*,end=100) <a name='372'>
       nt=nt+1<a name='373'>
       goto 10<a name='374'>
<font color=#447700>!<a name='375'></font>
 100   continue<a name='376'>
       rewind (70)<a name='377'>
     END IF<a name='378'>
<font color=#447700>!<a name='379'></font>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_62">(nt,1)<a name='380'>
<font color=#447700>!<a name='381'></font>
<font color=#447700>! ... PAJ: Initializes the configuration of the wind farm(s) ...<a name='382'></font>
<font color=#447700>!<a name='383'></font>
     if (.not. windfarm_initialized) then<a name='384'>
       allocate (nkind(nt),ival(nt,max_domains),jval(nt,max_domains))<a name='385'>
       allocate (hubheight(nt),stc(nt),stc2(nt),cutin(nt),cutout(nt),diameter(nt),npower(nt))<a name='386'>
       ival=-9999<a name='387'>
       jval=-9999<a name='388'>
       windfarm_initialized=.true.<a name='389'>
     endif<a name='390'>
<font color=#447700>!<a name='391'></font>
     IF ( wrf_dm_on_monitor() ) THEN<a name='392'>
     do k=1,nt<a name='393'>
       if ( config_flags%windfarm_ij .eq. 1 ) then<a name='394'>
         read(70,*) ival(k,id), jval(k,id), nkind(k)<a name='395'>
         write(message_wind,*)'WINDFARM Turbine #',k,': I, J = ',ival(k,id), jval(k,id),'; Type = ',nkind(k)<a name='396'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1075">(message_wind)<a name='397'>
<a name='398'>
       else<a name='399'>
<a name='400'>
         read(70,*)lat,lon,nkind(k)<a name='401'>
         write(message_wind,*)'WINDFARM Turbine #',k,': Lat, lon = ',lat,lon,'; Type = ',nkind(k)<a name='402'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1076">(message_wind)<a name='403'>
<a name='404'>
         CALL <A href='../../html_code/share/module_llxy.F.html#MAP_INIT'>map_init</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_INIT_2">(ts_proj)<a name='405'>
<a name='406'>
         known_lat = xlat(its,jts)<a name='407'>
         known_lon = xlong(its,jts)<a name='408'>
<a name='409'>
      <font color=#447700>! Mercator<a name='410'></font>
      IF (config_flags%map_proj == PROJ_MERC) THEN<a name='411'>
         CALL <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_9">(PROJ_MERC, ts_proj,               &amp;<a name='412'>
                      truelat1 = config_flags%truelat1, &amp;<a name='413'>
                      lat1     = known_lat,             &amp;<a name='414'>
                      lon1     = known_lon,             &amp;<a name='415'>
                      knowni   = REAL(its),             &amp;<a name='416'>
                      knownj   = REAL(jts),             &amp;<a name='417'>
                      dx       = config_flags%dx)<a name='418'>
<a name='419'>
      <font color=#447700>! Lambert conformal<a name='420'></font>
      ELSE IF (config_flags%map_proj == PROJ_LC) THEN<a name='421'>
         CALL <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_10">(PROJ_LC, ts_proj,                  &amp;<a name='422'>
                      truelat1 = config_flags%truelat1,  &amp;<a name='423'>
                      truelat2 = config_flags%truelat2,  &amp;<a name='424'>
                      stdlon   = config_flags%stand_lon, &amp;<a name='425'>
                      lat1     = known_lat,              &amp;<a name='426'>
                      lon1     = known_lon,              &amp;<a name='427'>
                      knowni   = REAL(its),              &amp;<a name='428'>
                      knownj   = REAL(jts),              &amp;<a name='429'>
                      dx       = config_flags%dx)<a name='430'>
<font color=#447700>!      ! Polar stereographic<a name='431'></font>
      ELSE IF (config_flags%map_proj == PROJ_PS) THEN<a name='432'>
         CALL <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_11">(PROJ_PS, ts_proj,                  &amp;<a name='433'>
                      truelat1 = config_flags%truelat1,  &amp;<a name='434'>
                      stdlon   = config_flags%stand_lon, &amp;<a name='435'>
                      lat1     = known_lat,              &amp;<a name='436'>
                      lon1     = known_lon,              &amp;<a name='437'>
                      knowni   = REAL(its),              &amp;<a name='438'>
                      knownj   = REAL(jts),              &amp;<a name='439'>
                      dx       = config_flags%dx)<a name='440'>
<font color=#447700>!#if (EM_CORE == 1)<a name='441'></font>
<font color=#447700>!      ! Cassini (global ARW)<a name='442'></font>
<font color=#447700>!      ELSE IF (config_flags%map_proj == PROJ_CASSINI) THEN<a name='443'></font>
<font color=#447700>!         CALL map_set(PROJ_CASSINI, ts_proj,                            &amp;<a name='444'></font>
<font color=#447700>!                      latinc   = grid%dy*360.0/(2.0*EARTH_RADIUS_M*PI), &amp;<a name='445'></font>
<font color=#447700>!                      loninc   = grid%dx*360.0/(2.0*EARTH_RADIUS_M*PI), &amp;<a name='446'></font>
<font color=#447700>!                      lat1     = known_lat,                             &amp;<a name='447'></font>
<font color=#447700>!                      lon1     = known_lon,                             &amp;<a name='448'></font>
<font color=#447700>!                      lat0     = config_flags%pole_lat,                 &amp;<a name='449'></font>
<font color=#447700>!                      lon0     = config_flags%pole_lon,                 &amp;<a name='450'></font>
<font color=#447700>!                      knowni   = 1.,                                    &amp;<a name='451'></font>
<font color=#447700>!                      knownj   = 1.,                                    &amp;<a name='452'></font>
<font color=#447700>!                      stdlon   = config_flags%stand_lon)<a name='453'></font>
<font color=#447700>!#endif<a name='454'></font>
<font color=#447700>!<a name='455'></font>
<font color=#447700>!      ! Rotated latitude-longitude<a name='456'></font>
<font color=#447700>!      ELSE IF (config_flags%map_proj == PROJ_ROTLL) THEN<a name='457'></font>
<font color=#447700>!         CALL map_set(PROJ_ROTLL, ts_proj,                      &amp;<a name='458'></font>
<font color=#447700>!! I have no idea how this should work for NMM nested domains<a name='459'></font>
<font color=#447700>!                      ixdim    = grid%e_we-1,                   &amp;<a name='460'></font>
<font color=#447700>!                      jydim    = grid%e_sn-1,                   &amp;<a name='461'></font>
<font color=#447700>!                      phi      = real(grid%e_sn-2)*grid%dy/2.0, &amp;<a name='462'></font>
<font color=#447700>!                      lambda   = real(grid%e_we-2)*grid%dx,     &amp;<a name='463'></font>
<font color=#447700>!                      lat1     = config_flags%cen_lat,          &amp;<a name='464'></font>
<font color=#447700>!                      lon1     = config_flags%cen_lon,          &amp;<a name='465'></font>
<font color=#447700>!                      latinc   = grid%dy,                       &amp;<a name='466'></font>
<font color=#447700>!                      loninc   = grid%dx,                       &amp;<a name='467'></font>
<font color=#447700>!                      stagger  = HH)<a name='468'></font>
<font color=#447700>!<a name='469'></font>
      END IF<a name='470'>
<font color=#447700>!<a name='471'></font>
         CALL <A href='../../html_code/share/module_llxy.F.html#LATLON_TO_IJ'>latlon_to_ij</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LATLON_TO_IJ_3">(ts_proj, lat, lon, ts_rx, ts_ry)<a name='472'>
<font color=#447700>!<a name='473'></font>
          ival(k,id)=nint(ts_rx)<a name='474'>
          jval(k,id)=nint(ts_ry)<a name='475'>
          if (ival(k,id).lt.ids.and.ival(k,id).gt.ide) then<a name='476'>
            ival(k,id)=-9999<a name='477'>
            jval(k,id)=-9999<a name='478'>
          endif<a name='479'>
<font color=#447700>!<a name='480'></font>
<font color=#447700>!         write(73,*) k,id,ival(k,id),jval(k,id)<a name='481'></font>
          write(message_wind,*)'WINDFARM Turbine #',k,': Lat, lon = ',lat,lon, &amp;<a name='482'>
                               ', (i,j) = (',ival(k,id),',',jval(k,id),'); Type = ',nkind(k)<a name='483'>
          CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_867">(0,message_wind)<a name='484'>
<font color=#447700>!<a name='485'></font>
     end if<a name='486'>
<font color=#447700>!<a name='487'></font>
     enddo<a name='488'>
      close(70)<a name='489'>
<font color=#447700>!<a name='490'></font>
<font color=#447700>! ... PAJ: Read the tables with the turbine's characteristics ...<a name='491'></font>
<font color=#447700>!<a name='492'></font>
         turbws=0.<a name='493'>
         turbtc=0.<a name='494'>
         turbpw=0.<a name='495'>
         DO i=1,nt<a name='496'>
          write(num,*) nkind(i)<a name='497'>
          num=adjustl(num)<a name='498'>
          input="wind-turbine-"//trim(num)//".tbl"<a name='499'>
          OPEN(file=TRIM(input),unit=19,FORM='FORMATTED',STATUS='OLD')<a name='500'>
          READ (19,*,ERR=132)nval<a name='501'>
          READ(19,*,ERR=132)hubheight(i),diameter(i),stc(i),npower(i)<a name='502'>
            DO k=1,nval<a name='503'>
              READ(19,*,ERR=132)turbws(nkind(i),k),turbtc(nkind(i),k),turbpw(nkind(i),k)<a name='504'>
            ENDDO<a name='505'>
          cutin(i)  = turbws(nkind(i),1)<a name='506'>
          cutout(i) = turbws(nkind(i),nval)<a name='507'>
          stc2(i) = turbtc(nkind(i),nval)<a name='508'>
          close (19)<a name='509'>
         ENDDO<a name='510'>
<a name='511'>
 132   continue<a name='512'>
<font color=#447700>!<a name='513'></font>
<font color=#447700>! ... ...<a name='514'></font>
<font color=#447700>!<a name='515'></font>
      endif<a name='516'>
<a name='517'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_63">(ival,nt*max_domains)<a name='518'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_64">(jval,nt*max_domains)<a name='519'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_143">(hubheight,nt)<a name='520'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_144">(diameter,nt)<a name='521'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_145">(stc,nt)<a name='522'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_146">(npower,nt)<a name='523'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_147">(cutin,nt)<a name='524'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_148">(cutout,nt)<a name='525'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_65">(nkind,nt) <a name='526'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_149">(turbws,maxvals*maxvals2) <a name='527'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_150">(turbtc,maxvals*maxvals2) <a name='528'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_wind_fitch.F.html#INIT_MODULE_WIND_FITCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_151">(turbpw,maxvals*maxvals2) <a name='529'>
<a name='530'>
  END SUBROUTINE init_module_wind_fitch<a name='531'>
  <a name='532'>
END MODULE module_wind_fitch<a name='533'>
</pre></body></html>