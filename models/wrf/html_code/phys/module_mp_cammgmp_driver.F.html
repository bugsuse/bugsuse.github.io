<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>! Note: Comments starting with "!!" are directly taken from CAM's driver routine for the micro-physics (stratiform.F90)<a name='2'></font>
<font color=#447700>! Updated to CESM1.0.3 (CAM5.1.01) by Balwinder.Singh@pnnl.gov<a name='3'></font>
<a name='4'>
<font color=#447700>!----------------------------------------------------------------------------------------------------------<a name='5'></font>
<font color=#447700>!Possible future Modifications:<a name='6'></font>
<font color=#447700>!1. *** IMPORTANT-WARNING *** conv_water_in_rad is hardwired to be equal to 1. It should be a namelist variable<a name='7'></font>
<font color=#447700>!2. QME3D computation is WRONG as it doesn't include CMELIQ contribution as CMELIQ is <a name='8'></font>
<font color=#447700>!   computed in macrophysics, which is not ported into WRF yet<a name='9'></font>
<font color=#447700>!3. Computations such as cldfsnow,icswp etc. are not correct as CONCLD (convective <a name='10'></font>
<font color=#447700>!   cloud fraction) variable is not avaible to microphysics<a name='11'></font>
<font color=#447700>!4. The code ouputs variables which can be used in RRTMG radiation but RRTMG radiation doesn't <a name='12'></font>
<font color=#447700>!   use these variables as of now<a name='13'></font>
<font color=#447700>!5. More robust cloud fraction calculation can be included in the future versions<a name='14'></font>
<font color=#447700>!----------------------------------------------------------------------------------------------------------<a name='15'></font>
<a name='16'>
<font color=#447700>!----------------------------------------------------------------------------------------------------------<a name='17'></font>
<font color=#447700>!Important Notes:<a name='18'></font>
<font color=#447700>!1. New cloud fraction computations are added by Po-Lun Ma (PMA)<a name='19'></font>
<font color=#447700>!2. Macrophysics processes are added by PMA into this driver<a name='20'></font>
<font color=#447700>!----------------------------------------------------------------------------------------------------------<a name='21'></font>
<a name='22'>
#define MODAL_AERO<a name='23'>
<A NAME='MODULE_MP_CAMMGMP_DRIVER'><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MODULE_MP_CAMMGMP_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='24'>
<font color=#993300>module </font><font color=#cc0000>module_mp_cammgmp_driver</font> <A href='../../call_to/MODULE_MP_CAMMGMP_DRIVER.html' TARGET='index'>4</A><a name='25'>
  <a name='26'>
  <font color=#447700>!!-------------------------------------------------------------------------------------------------------<a name='27'></font>
  <font color=#447700>!! Purpose:<a name='28'></font>
  <font color=#447700>!!<a name='29'></font>
  <font color=#447700>!! Provides the CAM interface to the prognostic cloud microphysics<a name='30'></font>
  <font color=#447700>!!<a name='31'></font>
  <font color=#447700>!! Author: Andrew Gettelman, Cheryl Craig, October 2010<a name='32'></font>
  <font color=#447700>!! Origin: modified from stratiform.F90 <a name='33'></font>
  <font color=#447700>!!         (Boville 2002, Coleman 2004, Park 2009, Kay 2010)<a name='34'></font>
  <font color=#447700>! Ported to WRF by Balwinder.Singh@pnnl.gov<a name='35'></font>
  <font color=#447700>!!-------------------------------------------------------------------------------------------------------<a name='36'></font>
  <a name='37'>
  use <A href='../../html_code/phys/module_cam_shr_kind_mod.F.html#SHR_KIND_MOD'>shr_kind_mod</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#module_mp_cammgmp_driver.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHR_KIND_MOD_28">,  only: r8=&gt;shr_kind_r8<a name='38'>
  use <A href='../../html_code/phys/module_cam_physconst.F.html#PHYSCONST'>physconst</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#module_mp_cammgmp_driver.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSCONST_19">,     only: gravit  <a name='39'>
  use <A href='../../html_code/phys/module_cam_support.F.html#MODULE_CAM_SUPPORT'>module_cam_support</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#module_mp_cammgmp_driver.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CAM_SUPPORT_45">,  only: pcnst =&gt;pcnst_mp, pcols, pver, pverp<a name='40'>
#if ( WRF_CHEM == 1 )<a name='41'>
   use <A href='../../html_code/phys/module_cam_support.F.html#MODULE_CAM_SUPPORT'>module_cam_support</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#module_mp_cammgmp_driver.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CAM_SUPPORT_46">, only: cam_mam_aerosols<a name='42'>
#endif<a name='43'>
  use <A href='../../html_code/phys/module_cam_constituents.F.html#CONSTITUENTS'>constituents</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#module_mp_cammgmp_driver.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTITUENTS_19">,  only: cnst_get_ind, cnst_name, qmin<a name='44'>
<a name='45'>
#if ( WRF_CHEM == 1 )<a name='46'>
  use <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#module_mp_cammgmp_driver.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_133">,  only: num_chem, param_first_scalar, &amp;<a name='47'>
         CBMZ_CAM_MAM7_NOAQ, CBMZ_CAM_MAM7_AQ, CBMZ_CAM_MAM3_NOAQ,     &amp;<a name='48'>
         CBMZ_CAM_MAM3_AQ<a name='49'>
#endif<a name='50'>
<a name='51'>
  <a name='52'>
  implicit none<a name='53'>
  private<a name='54'>
  save<a name='55'>
  <a name='56'>
  public :: CAMMGMP_INIT<a name='57'>
  public :: CAMMGMP<a name='58'>
#if ( WRF_CHEM == 1 )<a name='59'>
  public :: physics_ptend_init <font color=#447700>! Mimics CAM's physics ptend init. Also used in wet scavaging code in WRF_CHEM<a name='60'></font>
  public :: physics_update     <font color=#447700>! Mimics CAM's physics update. Also used in wet scavaging code in WRF_CHEM <a name='61'></font>
#endif<a name='62'>
  <a name='63'>
  <font color=#447700>!! ------------------------- !<a name='64'></font>
  <font color=#447700>!! Private Module Parameters !<a name='65'></font>
  <font color=#447700>!! ------------------------- !<a name='66'></font>
  <a name='67'>
  <font color=#447700>!! Choose either 'intermediate' ('inter') or complete ('compl') cloud microphysics <a name='68'></font>
  <font color=#447700>!! inter : Microphysics assumes 'liquid stratus frac = ice stratus frac = max( liquid stratus frac, ice stratus frac )'.<a name='69'></font>
  <font color=#447700>!! compl : Microphysics explicitly treats 'liquid stratus frac .ne. ice stratus frac'  <a name='70'></font>
  <font color=#447700>!! for CAM5, only 'inter' is functional<a name='71'></font>
  <a name='72'>
  character(len=5), private, parameter :: micro_treatment = 'inter' <a name='73'>
  <a name='74'>
  logical, private :: sub_column = .false. <font color=#447700>! True = configure microphysics for sub-columns <a name='75'></font>
  <font color=#447700>!! False = use in regular mode w/o sub-columns<a name='76'></font>
  <a name='77'>
  <font color=#447700>!! -------------------------------- !<a name='78'></font>
  <font color=#447700>!! End of Private Module Parameters !<a name='79'></font>
  <font color=#447700>!! -------------------------------- !<a name='80'></font>
  <a name='81'>
  integer :: &amp;<a name='82'>
       ixcldliq,     &amp;<font color=#447700>! cloud liquid amount index<a name='83'></font>
       ixcldice,     &amp;<font color=#447700>! cloud ice amount index<a name='84'></font>
       ixnumliq,     &amp;<font color=#447700>! cloud liquid number index<a name='85'></font>
       ixnumice       <font color=#447700>! cloud ice water index<a name='86'></font>
  integer  :: chem_opt, ptend_top_level, ptend_bot_level<a name='87'>
<a name='88'>
  real(r8), parameter :: qthresh_mass = 1.0e-11 <font color=#447700>! Typical val: 1e-6 kg/kg ; Negligible val: 1e-11 kg/kg<a name='89'></font>
  real(r8), parameter :: qthresh_numl = 5.0e2   <font color=#447700>! Typical val: 5E7  #/kg  ; Negligible val: 5e2  #/kg<a name='90'></font>
  real(r8), parameter :: qthresh_numi = 1.0e-1  <font color=#447700>! Typical val: 1E4  #/kg  ; Negligible val: 1e-1 #/kg<a name='91'></font>
<a name='92'>
  <font color=#447700>!Following constants (dp1 and dp2) are  obtained from cloud_fraction.F90 of CAM for highest resolution(0.23x0.31)<a name='93'></font>
  real(r8), parameter :: dp1 = 0.10_r8 <a name='94'>
  real(r8), parameter :: dp2 = 500.0_r8<a name='95'>
<a name='96'>
contains<a name='97'>
  <a name='98'>
<A NAME='CAMMGMP'><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='99'>
  <font color=#993300>subroutine </font><font color=#cc0000>CAMMGMP</font>(itimestep, dt, p8w, p_hyd   &amp; <A href='../../call_to/CAMMGMP.html' TARGET='index'>1</A>,<A href='../../call_from/CAMMGMP.html' TARGET='index'>26</A><a name='100'>
       , t_phy, pi_phy, z_at_w, qfx              &amp;<a name='101'>
       , tke_pbl, turbtype3d, smaw3d             &amp;<a name='102'>
       , dlf3d, dlf2_3d, rliq2d, z_sea_level     &amp;<a name='103'>
       , kvh3d, ht, alt, accum_mode              &amp;<a name='104'>
       , aitken_mode, coarse_mode, icwmrsh3d     &amp;<a name='105'>
       , icwmrdp3d, shfrc3d, cmfmc3d, cmfmc2_3d  &amp;<a name='106'>
       , config_flags, f_ice_phy, f_rain_phy     &amp;<a name='107'>
#if ( WRF_CHEM == 1 )                     <a name='108'>
       , dgnum4d, dgnumwet4d                     &amp;<a name='109'>
#endif<a name='110'>
       , ids, ide,  jds, jde,  kds, kde          &amp;<a name='111'>
       , ims, ime,  jms, jme,  kms, kme          &amp;<a name='112'>
       , its, ite,  jts, jte,  kts, kte          &amp;<a name='113'>
       <font color=#447700>!Output variables from CAMMGMP<a name='114'></font>
       , th, cldfra_old_mp, cldfra_mp            &amp;<a name='115'>
       ,cldfra_mp_all, lradius, iradius, cldfrai &amp;<a name='116'>
       , cldfral, cldfra_conv,wsedl3d, rainnc    &amp;<a name='117'>
       , rainncv, snownc, snowncv,sr             &amp;<a name='118'>
       , qv_curr, qc_curr, qi_curr,qs_curr       &amp;<a name='119'>
       , qr_curr, nc3d, ni3d,ns3d,nr3d,qndrop    &amp;<a name='120'>
       , rh_old_mp,lcd_old_mp                    &amp; <font color=#447700>!PMA- added for macrophysics<a name='121'></font>
#if ( WRF_CHEM == 1 )                     <a name='122'>
       , chem                                    &amp;<a name='123'>
       , qme3d,prain3d,nevapr3d                  &amp;<a name='124'>
       , rate1ord_cw2pr_st3d                     &amp;<a name='125'>
#endif<a name='126'>
       , xland,snowh                            )<a name='127'>
    <a name='128'>
    <font color=#447700>!!-------------------------------------------------------- !  <a name='129'></font>
    <font color=#447700>!!                                                         ! <a name='130'></font>
    <font color=#447700>!! Purpose:                                                !<a name='131'></font>
    <font color=#447700>!!                                                         !<a name='132'></font>
    <font color=#447700>!! Interface to sedimentation, detrain, cloud fraction and !<a name='133'></font>
    <font color=#447700>!!        cloud macro - microphysics subroutines           !<a name='134'></font>
    <font color=#447700>!!                                                         ! <a name='135'></font>
    <font color=#447700>!! Author: D.B. Coleman                                    !<a name='136'></font>
    <font color=#447700>!! Date: Apr 2004                                          !<a name='137'></font>
    <font color=#447700>!!                                                         !<a name='138'></font>
    <font color=#447700>!  Polun Ma added simple macrophysics scheme<a name='139'></font>
    <font color=#447700>!!-------------------------------------------------------- !<a name='140'></font>
    use <A href='../../html_code/phys/module_cam_shr_kind_mod.F.html#SHR_KIND_MOD'>shr_kind_mod</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHR_KIND_MOD_29">,             only: r8 =&gt; shr_kind_r8<a name='141'>
    use <A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#CLDWAT2M_MICRO'>cldwat2m_micro</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLDWAT2M_MICRO_1">,           only: mmicro_pcond<a name='142'>
    use <A href='../../html_code/phys/module_cam_mp_microp_aero.F.html#MICROP_AERO'>microp_aero</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROP_AERO_1">,              only: microp_aero_ts <a name='143'>
    use <A href='../../html_code/phys/module_cam_physconst.F.html#PHYSCONST'>physconst</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSCONST_20">,                only: cpair, tmelt <font color=#447700>! tmelt is added for computing saturation specific humidity for ice and liquid<a name='144'></font>
    <a name='145'>
#ifdef MODAL_AERO<a name='146'>
    use <A href='../../html_code/phys/module_data_cam_mam_aero.F.html#MODAL_AERO_DATA'>modal_aero_data</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODAL_AERO_DATA_22">,          only: modeptr_accum =&gt; modeptr_accum_mp, &amp;<a name='147'>
         numptr_amode   =&gt; numptr_amode_mp  , lspectype_amode =&gt; lspectype_amode_mp, &amp;<a name='148'>
         specdens_amode =&gt; specdens_amode_mp, voltonumb_amode =&gt; voltonumb_amode_mp, &amp;<a name='149'>
         lmassptr_amode =&gt; lmassptr_amode_mp, modeptr_aitken  =&gt; modeptr_aitken_mp,  &amp;<a name='150'>
         modeptr_coarse =&gt; modeptr_coarse_mp, ntot_amode      =&gt; ntot_amode_mp,      &amp;<a name='151'>
         nspec_amode    =&gt; nspec_amode_mp<a name='152'>
#endif<a name='153'>
    <a name='154'>
#if ( WRF_CHEM == 1 )       <a name='155'>
    use <A href='../../html_code/phys/module_data_cam_mam_asect.F.html#MODULE_DATA_CAM_MAM_ASECT'>module_data_cam_mam_asect</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATA_CAM_MAM_ASECT_2">, only: lptr_chem_to_q, lptr_chem_to_qqcw, factconv_chem_to_q<a name='156'>
#endif<a name='157'>
    <a name='158'>
    use <A href='../../html_code/phys/module_cam_wv_saturation.F.html#WV_SATURATION'>wv_saturation</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WV_SATURATION_14">,             only: epsqs, polysvp <font color=#447700>! Added for computing saturation specific humidity for ice and liquid<a name='159'></font>
    use <A href='../../html_code/phys/module_cam_mp_conv_water.F.html#CONV_WATER'>conv_water</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONV_WATER_1">,                only: conv_water_4rad<a name='160'>
    use <A href='../../html_code/phys/module_cam_cldwat.F.html#CLDWAT'>cldwat</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLDWAT_2">,                    only: cldwat_fice<a name='161'>
    use <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_134">,  only: CAMZMSCHEME, CAMUWSHCUSCHEME,F_QV, F_QC, F_QI, F_QS<a name='162'>
    use <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_157">,          only: grid_config_rec_type<a name='163'>
    <a name='164'>
    implicit none    <a name='165'>
    <font color=#447700>!<a name='166'></font>
    <font color=#447700>! Input arguments<a name='167'></font>
    <font color=#447700>!<a name='168'></font>
    TYPE(grid_config_rec_type),  INTENT(IN   )    :: config_flags<a name='169'>
    integer, intent(in) :: itimestep       <font color=#447700>!Timestep count<a name='170'></font>
    <a name='171'>
    integer, intent(in) :: ids,ide, jds,jde, kds,kde<a name='172'>
    integer, intent(in) :: ims,ime, jms,jme, kms,kme<a name='173'>
    integer, intent(in) :: its,ite, jts,jte, kts,kte<a name='174'>
    <a name='175'>
    real,    intent(in) :: dt              <font color=#447700>!Timestep<a name='176'></font>
    <a name='177'>
    real,    intent(in) :: accum_mode, aitken_mode, coarse_mode     <a name='178'>
    <a name='179'>
    real, dimension( ims:ime, jms:jme ), intent(in) :: ht     <font color=#447700>!Terrain height (m)<a name='180'></font>
    real, dimension( ims:ime, jms:jme ), intent(in) :: qfx    <font color=#447700>!Upward moisture flux at the surface(kg m-2 s-1)<a name='181'></font>
    real, dimension( ims:ime, jms:jme ), intent(in) :: rliq2d <font color=#447700>!Vertically-integrated reserved cloud condensate(m s-1)<a name='182'></font>
    real, dimension( ims:ime, jms:jme ), intent(in) :: xland<a name='183'>
    real, dimension( ims:ime, jms:jme ), intent(in) :: snowh<a name='184'>
    <a name='185'>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: dlf3d       <font color=#447700>!Detraining cloud water tendency from convection<a name='186'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: dlf2_3d     <font color=#447700>!dq/dt due to export of cloud water into environment by shallow convection(kg/kg/s)<a name='187'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: p8w         <font color=#447700>!Hydrostatic Pressure at level interface (Pa)<a name='188'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: p_hyd       <font color=#447700>!Hydrostatic pressure(Pa)<a name='189'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: z_sea_level <font color=#447700>!Height above sea level at mid-level (m) <a name='190'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: t_phy       <font color=#447700>!Temperature (K)<a name='191'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: z_at_w      <font color=#447700>!Height above sea level at layer interfaces (m) <a name='192'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: pi_phy      <font color=#447700>!Dimensionless pressure [unitless]<a name='193'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: tke_pbl     <font color=#447700>!Turbulence kinetic energy from Mellor-Yamada-Janjic (MYJ) (m^2/s^2)<a name='194'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: kvh3d       <font color=#447700>!Eddy diffusivity for heat(m^2/s)<a name='195'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: turbtype3d  <font color=#447700>!Turbulent interface types [ no unit ]<a name='196'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: smaw3d      <font color=#447700>!Normalized Galperin instability function for momentum  ( 0&lt;= &lt;=4.964 and 1 at neutral ) [no units]<a name='197'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: alt         <font color=#447700>!inverse density(m3/kg)<a name='198'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: F_ICE_PHY   <font color=#447700>!Fraction of ice<a name='199'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in)    :: F_RAIN_PHY  <font color=#447700>!Fraction of rain<a name='200'></font>
    <font color=#447700>!For conv_water_4rad<a name='201'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in) :: shfrc3d        <font color=#447700>!Shallow cloud fraction<a name='202'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in) :: cmfmc3d        <font color=#447700>!Deep + Shallow Convective mass flux [ kg /s/m^2 ]<a name='203'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in) :: cmfmc2_3d      <font color=#447700>!Shallow convective mass flux [ kg/s/m^2 ]<a name='204'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in) :: icwmrsh3d      <font color=#447700>!Shallow cumulus in-cloud water mixing ratio (kg/m2)<a name='205'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(in) :: icwmrdp3d      <font color=#447700>!Deep Convection in-cloud water mixing ratio (kg/m2)<a name='206'></font>
<a name='207'>
#if ( WRF_CHEM == 1 ) <a name='208'>
    real, dimension( ims:ime, kms:kme, jms:jme, ntot_amode ), intent(in) :: dgnum4d, dgnumwet4d <font color=#447700>! 4-dimensional Number mode diameters<a name='209'></font>
#endif<a name='210'>
    <font color=#447700>!2d in-outs<a name='211'></font>
    real, dimension( ims:ime , jms:jme ), intent(inout) :: rainnc              <font color=#447700>!grid scale precipitation (mm)<a name='212'></font>
    real, dimension( ims:ime , jms:jme ), intent(inout) :: rainncv             <font color=#447700>!one time step grid scale precipitation (mm/step)<a name='213'></font>
    real, dimension( ims:ime , jms:jme ), intent(inout) :: snownc              <font color=#447700>!grid scale snow and ice (mm)<a name='214'></font>
    real, dimension( ims:ime , jms:jme ), intent(inout) :: snowncv             <font color=#447700>!one time step grid scale snow and ice (mm/step)<a name='215'></font>
    <a name='216'>
    <font color=#447700>!3d in-outs<a name='217'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: cldfra_old_mp  <font color=#447700>!Old Cloud fraction <a name='218'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: rh_old_mp      <font color=#447700>!Old RH<a name='219'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: lcd_old_mp     <font color=#447700>!Old liquid cloud fraction<a name='220'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: qv_curr        <font color=#447700>!Water vapor mixing ratio - Moisture  (kg/kg)<a name='221'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: qc_curr        <font color=#447700>!Cloud water mixing ratio - Cloud liq (kg/kg)<a name='222'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: qi_curr        <font color=#447700>!Ice mixing ratio         -Cloud ice  (kg/kg)<a name='223'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: qs_curr        <font color=#447700>!Snow mixing ratio         -Cloud ice  (kg/kg)<a name='224'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: qr_curr        <font color=#447700>!Rain mixing ratio         -Cloud ice  (kg/kg)<a name='225'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: ni3d           <font color=#447700>!Cloud ice number concentration (#/kg)<a name='226'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: nc3d           <font color=#447700>!Cloud water  number concentration (#/kg)<a name='227'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: ns3d           <font color=#447700>!Snow number concentration (#/kg)<a name='228'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: nr3d           <font color=#447700>!rain number concentration (#/kg)<a name='229'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: qndrop         <font color=#447700>!droplet number mixing ratio (#/kg)<a name='230'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: th             <font color=#447700>!Potential temperature (K)<a name='231'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: wsedl3d        <font color=#447700>!Sedimentation velocity of stratiform liquid cloud droplet (m/s)<a name='232'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: cldfra_mp      <font color=#447700>!New Cloud fraction <a name='233'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: cldfra_conv    <font color=#447700>!New Cloud fraction <a name='234'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: cldfra_mp_all  <font color=#447700>!New Cloud fraction <a name='235'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: lradius<a name='236'>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: iradius<a name='237'>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: cldfrai<a name='238'>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: cldfral<a name='239'>
#if ( WRF_CHEM == 1 )<a name='240'>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: qme3d          <font color=#447700>!Net condensation rate (kg/kg/s)<a name='241'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: prain3d        <font color=#447700>!Rate of conversion of condensate to precipitation (kg/kg/s)<a name='242'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: nevapr3d       <font color=#447700>!Evaporation rate of rain + snow (kg/kg/s)<a name='243'></font>
    real, dimension( ims:ime, kms:kme, jms:jme ), intent(inout) :: rate1ord_cw2pr_st3d <font color=#447700>!1st order rate for direct conversion of strat. cloud water to precip (1/s)<a name='244'></font>
#endif<a name='245'>
<a name='246'>
#if ( WRF_CHEM == 1 )    <a name='247'>
    <font color=#447700>!4d in-outs<a name='248'></font>
    real, dimension( ims:ime, kms:kme, jms:jme, num_chem ), intent(inout) :: chem <font color=#447700>!Chem array<a name='249'></font>
#endif<a name='250'>
    <font color=#447700>!2d outs<a name='251'></font>
    real, dimension( ims:ime , jms:jme ), intent(  out) :: sr                     <font color=#447700>!one time step mass ratio of snow to total precip    <a name='252'></font>
    <a name='253'>
    <a name='254'>
    <font color=#447700>!<a name='255'></font>
    <font color=#447700>! Local variables<a name='256'></font>
    <font color=#447700>!<a name='257'></font>
    <a name='258'>
    <font color=#447700>!Other variables<a name='259'></font>
    character*250 :: wrfmessage<a name='260'>
    logical  :: is_first_step                             <font color=#447700>!Flag to know if this a first time step<a name='261'></font>
    logical  :: ptend_loc_ls, ptend_all_ls                <font color=#447700>!Flag for updating tendencies<a name='262'></font>
    logical  :: ptend_loc_lq(pcnst),ptend_all_lq(pcnst)   <font color=#447700>!Flag for updating tendencies<a name='263'></font>
    integer   :: i,k,m,n,iw,jw,kw,imode,itsm1,itile_len,ktep1,kflip,ips,kcam<a name='264'>
#if ( WRF_CHEM == 1 )<a name='265'>
    integer  :: p1st,l2                                   <font color=#447700>!For iterating loop of NUM_CHEM for CHEM array<a name='266'></font>
#endif<a name='267'>
    integer   :: lchnk                                    <font color=#447700>!Chunk identifier<a name='268'></font>
    integer   :: ncol                                     <font color=#447700>!Number of atmospheric columns<a name='269'></font>
    integer   :: conv_water_in_rad                        <a name='270'>
    real (r8) :: multFrc<a name='271'>
    real(r8)  :: dtime                                    <font color=#447700>!Timestep in real(8) format<a name='272'></font>
    real(r8)  :: dp<a name='273'>
<a name='274'>
    real(r8) :: phis(pcols)                               <font color=#447700>!Geopotential at terrain height (m2/s2)<a name='275'></font>
    real(r8) :: state_t(pcols,kte)<a name='276'>
    real(r8) :: state_q(pcols,kte,pcnst)<a name='277'>
    real(r8) :: state_s(pcols,kte)<a name='278'>
    real(r8) :: state_pmid(pcols,kte)<a name='279'>
    real(r8) :: state_pdel(pcols,kte)<a name='280'>
    real(r8) :: state_rpdel(pcols,kte)<a name='281'>
    real(r8) :: state_zm(pcols,kte)<a name='282'>
    real(r8) :: state_omega(pcols,kte) <a name='283'>
    <a name='284'>
    real(r8) :: state_pint(pcols,kte+1)<a name='285'>
    <a name='286'>
    real(r8) :: state1_t(pcols,kte)<a name='287'>
    real(r8) :: state1_q(pcols,kte,pcnst)<a name='288'>
    real(r8) :: state1_s(pcols,kte)<a name='289'>
    real(r8) :: state1_pmid(pcols,kte)<a name='290'>
    real(r8) :: state1_pdel(pcols,kte)<a name='291'>
    real(r8) :: state1_rpdel(pcols,kte)<a name='292'>
    real(r8) :: state1_zm(pcols,kte)<a name='293'>
    real(r8) :: state1_omega(pcols,kte) <a name='294'>
    <a name='295'>
    real(r8) :: state1_pint(pcols,kte+1)<a name='296'>
    <a name='297'>
    character*24 :: ptend_loc_name <a name='298'>
    real(r8) :: ptend_loc_s(pcols,kte)<a name='299'>
    real(r8) :: ptend_loc_q(pcols,kte,pcnst)<a name='300'>
    <a name='301'>
    character*24 :: ptend_all_name <a name='302'>
    real(r8) :: ptend_all_s(pcols,kte)<a name='303'>
    real(r8) :: ptend_all_q(pcols,kte,pcnst)<a name='304'>
<a name='305'>
    real(r8) :: tmpnaer,tmpmaer<a name='306'>
    real(r8) :: cmeliq(pcols,kte)                 <font color=#447700>! Rate of cond-evap of liq within the cloud<a name='307'></font>
    real(r8) :: nrout(pcols,kte)                  <font color=#447700>! rain number concentration (1/m3)<a name='308'></font>
    real(r8) :: nsout(pcols,kte)                  <font color=#447700>! snow number concentration (1/m3)<a name='309'></font>
    real(r8) :: sh_icwmr(pcols,kte)               <font color=#447700>! Shallow conv. cloud water<a name='310'></font>
    real(r8) :: dp_icwmr(pcols,kte)               <font color=#447700>! Deep conv. cloud water<a name='311'></font>
    real(r8) :: fice(pcols,kte)                   <font color=#447700>! Ice partitioning ratio<a name='312'></font>
    real(r8) :: fsnow(pcols,kte)                  <font color=#447700>! Fractional snow content for convection<a name='313'></font>
    real(r8) :: sh_frac(pcols,kte)                <font color=#447700>! Shallow convective cloud fraction<a name='314'></font>
    real(r8) :: dp_frac(pcols,kte)                <font color=#447700>! Deep convective cloud fraction<a name='315'></font>
    real(r8) :: cmfmc(pcols,kte+1)<a name='316'>
    real(r8) :: cmfmc2(pcols,kte+1)<a name='317'>
   <a name='318'>
    real(r8), dimension(pcols,kte) :: esl         <font color=#447700>! liquid sat vapor pressure (pa) ! for phil suggested modifications<a name='319'></font>
    real(r8), dimension(pcols,kte) :: esi         <font color=#447700>! ice    sat vapor pressure (pa)<a name='320'></font>
    real(r8), dimension(pcols,kte) :: qvs         <font color=#447700>! liquid saturation vapor mixing ratio ! for phil suggested modifications<a name='321'></font>
    real(r8), dimension(pcols,kte) :: qvi         <font color=#447700>! ice    saturation vapor mixing ratio<a name='322'></font>
<a name='323'>
<a name='324'>
    <font color=#447700>!Following variables are added by PMA for Macrophysics<a name='325'></font>
    real(r8), dimension(pcols,kte) :: ttt         <font color=#447700>! Temperature (PMA)<a name='326'></font>
    real(r8), dimension(pcols,kte) :: rh_old      <font color=#447700>! RH at previous timestep (PMA)<a name='327'></font>
    real(r8), dimension(pcols,kte) :: qi_mac      <font color=#447700>! Temperature (PMA)<a name='328'></font>
<a name='329'>
<a name='330'>
    <font color=#447700>!End variables addition by PMA<a name='331'></font>
<a name='332'>
<a name='333'>
    <font color=#447700>!Variables with CAM data structure<a name='334'></font>
    real(r8)   :: rliq(pcols)              <font color=#447700>!Vertical integral of liquid not yet in q(ixcldliq) or vertically-integrated reserved cloud condensate (m/s)<a name='335'></font>
 <a name='336'>
    <font color=#447700>!Following 6 variables are intent-out in CAM's driver for micro-physics<a name='337'></font>
    real(r8)   :: prec_str(pcols)          <font color=#447700>! [Total] Sfc flux of precip from stratiform [ m/s ] <a name='338'></font>
    real(r8)   :: snow_str(pcols)          <font color=#447700>! [Total] Sfc flux of snow from stratiform   [ m/s ]<a name='339'></font>
    real(r8)   :: prec_sed(pcols)          <font color=#447700>! Surface flux of total cloud water from sedimentation<a name='340'></font>
    real(r8)   :: snow_sed(pcols)          <font color=#447700>! Surface flux of cloud ice from sedimentation<a name='341'></font>
    real(r8)   :: prec_pcw(pcols)          <font color=#447700>! Sfc flux of precip from microphysics [ m/s ]<a name='342'></font>
    real(r8)   :: snow_pcw(pcols)          <font color=#447700>! Sfc flux of snow from microphysics [ m/s ]<a name='343'></font>
    <a name='344'>
    real(r8)   :: cflx(pcols,pcnst)        <font color=#447700>! Constituent flux from surface    <a name='345'></font>
    real(r8)   :: dlf(pcols,kte)           <font color=#447700>! Detrained water from convection schemes<a name='346'></font>
    real(r8)   :: dlf2(pcols,kte)          <font color=#447700>! Detrained water from shallow convection scheme<a name='347'></font>
    real(r8)   :: rate1cld(pcols,kte)                    <font color=#447700>! array to hold rate1ord_cw2pr_st from microphysics<a name='348'></font>
    <a name='349'>
    <font color=#447700>! Physics buffer fields<a name='350'></font>
<a name='351'>
    real(r8), dimension(pcols,kte)   :: cld          <font color=#447700>! Total cloud fraction<a name='352'></font>
    real(r8), dimension(pcols,kte)   :: ast          <font color=#447700>! Relative humidity cloud fraction<a name='353'></font>
    real(r8), dimension(pcols,kte)   :: aist         <font color=#447700>! Physical ice stratus fraction<a name='354'></font>
    real(r8), dimension(pcols,kte)   :: alst         <font color=#447700>! Physical liquid stratus fraction<a name='355'></font>
    real(r8), dimension(pcols,kte)   :: concld       <font color=#447700>! Convective cloud fraction<a name='356'></font>
    real(r8), dimension(pcols,kte)   :: qme<a name='357'>
    real(r8), dimension(pcols,kte)   :: prain        <font color=#447700>! Total precipitation (rain + snow)<a name='358'></font>
    real(r8), dimension(pcols,kte)   :: nevapr       <font color=#447700>! Evaporation of total precipitation (rain + snow)<a name='359'></font>
    real(r8), dimension(pcols,kte)   :: rel          <font color=#447700>! Liquid effective drop radius (microns)<a name='360'></font>
    real(r8), dimension(pcols,kte)   :: rei          <font color=#447700>! Ice effective drop size (microns)<a name='361'></font>
    real(r8), dimension(pcols,kte)   :: rel2         <font color=#447700>! Liquid effective drop radius (microns)<a name='362'></font>
    real(r8), dimension(pcols,kte)   :: rei2         <font color=#447700>! Ice effective drop size (microns)<a name='363'></font>
    real(r8), dimension(pcols,kte)   :: cldo         <font color=#447700>! Old cloud fraction<a name='364'></font>
    real(r8), dimension(pcols,kte)   :: wsedl        <font color=#447700>! Sedimentation velocity of liquid stratus cloud droplet [ m/s ]<a name='365'></font>
    real(r8), dimension(pcols,kte)   :: rel_fn       <font color=#447700>! Ice effective drop size at fixed number (indirect effect) (microns)<a name='366'></font>
    real(r8), dimension(pcols,kte+1) :: kkvh         <font color=#447700>! Vertical eddy diffusivity    <a name='367'></font>
#ifdef MODAL_AERO<a name='368'>
    real(r8), target, dimension(pcols,kte,pcnst) :: qqcw                <font color=#447700>! Cloud-borne aerosol<a name='369'></font>
    real(r8), dimension(pcols,kte,ntot_amode)    :: dgnumwet            <font color=#447700>! Number mode diameter<a name='370'></font>
    real(r8), dimension(pcols,kte,ntot_amode)    :: dgnum               <font color=#447700>! Number mode diameter<a name='371'></font>
    real(r8), dimension(pcols,kte)               :: rate1ord_cw2pr_st   <font color=#447700>! 1st order rate for direct conversion of <a name='372'></font>
    <font color=#447700>! strat. cloud water to precip (1/s)    ! rce 2010/05/01<a name='373'></font>
#endif<a name='374'>
    <a name='375'>
    <a name='376'>
    <font color=#447700>! physics buffer fields for COSP simulator<a name='377'></font>
    real(r8), dimension(pcols,kte+1) :: mgflxprc     <font color=#447700>! MG grid-box mean flux_large_scale_cloud_rain+snow at interfaces (kg/m2/s)<a name='378'></font>
    real(r8), dimension(pcols,kte+1) :: mgflxsnw     <font color=#447700>! MG grid-box mean flux_large_scale_cloud_snow at interfaces (kg/m2/s)<a name='379'></font>
    real(r8), dimension(pcols,kte)   :: mgmrprc      <font color=#447700>! MG grid-box mean mixingratio_large_scale_cloud_rain+snow at interfaces (kg/kg)<a name='380'></font>
    real(r8), dimension(pcols,kte)   :: mgmrsnw      <font color=#447700>! MG grid-box mean mixingratio_large_scale_cloud_snow at interfaces (kg/kg)<a name='381'></font>
    real(r8), dimension(pcols,kte)   :: mgreffrain   <font color=#447700>! MG diagnostic rain effective radius (um)<a name='382'></font>
    real(r8), dimension(pcols,kte)   :: mgreffsnow   <font color=#447700>! MG diagnostic snow effective radius (um)<a name='383'></font>
    real(r8), dimension(pcols,kte)   :: cvreffliq    <font color=#447700>! convective cloud liquid effective radius (um)<a name='384'></font>
    real(r8), dimension(pcols,kte)   :: cvreffice    <font color=#447700>! convective cloud ice effective radius (um)<a name='385'></font>
    <a name='386'>
    <font color=#447700>! physics buffer fields for radiation<a name='387'></font>
    <a name='388'>
    real(r8), dimension(pcols,kte) :: dei          <font color=#447700>! Ice effective diameter (meters) (AG: microns?)<a name='389'></font>
    real(r8), dimension(pcols,kte) :: mu           <font color=#447700>! Size distribution shape parameter for radiation<a name='390'></font>
    real(r8), dimension(pcols,kte) :: lambdac      <font color=#447700>! Size distribution slope parameter for radiation<a name='391'></font>
    real(r8), dimension(pcols,kte) :: iciwp        <font color=#447700>! In-cloud ice water path for radiation<a name='392'></font>
    real(r8), dimension(pcols,kte) :: iclwp        <font color=#447700>! In-cloud liquid water path for radiation<a name='393'></font>
    <a name='394'>
    <font color=#447700>! For rrtm optics. specificed distribution.<a name='395'></font>
    <a name='396'>
    real(r8) :: mucon                                 <font color=#447700>! Convective size distribution shape parameter<a name='397'></font>
    real(r8) :: dcon                                  <font color=#447700>! Convective size distribution effective radius (meters)  <a name='398'></font>
    real(r8) :: lamcon                                <font color=#447700>! Convective size distribution slope parameter (meters-1)<a name='399'></font>
    real(r8) :: deicon                                <font color=#447700>! Convective ice effective diameter (meters)<a name='400'></font>
    <a name='401'>
    <font color=#447700>! Physics buffer fields<a name='402'></font>
    <a name='403'>
    real(r8), dimension(pcols,kte) :: deiconv      <font color=#447700>! Ice effective diameter (microns)<a name='404'></font>
    real(r8), dimension(pcols,kte) :: muconv       <font color=#447700>! Size distribution shape parameter for radiation<a name='405'></font>
    real(r8), dimension(pcols,kte) :: lambdaconv   <font color=#447700>! Size distribution slope parameter for radiation<a name='406'></font>
    real(r8), dimension(pcols,kte) :: iciwpst      <font color=#447700>! Stratiform in-cloud ice water path for radiation<a name='407'></font>
    real(r8), dimension(pcols,kte) :: iclwpst      <font color=#447700>! Stratiform in-cloud liquid water path for radiation<a name='408'></font>
    real(r8), dimension(pcols,kte) :: iciwpconv    <font color=#447700>! Convective in-cloud ice water path for radiation<a name='409'></font>
    real(r8), dimension(pcols,kte) :: iclwpconv    <font color=#447700>! Convective in-cloud liquid water path for radiation<a name='410'></font>
    <a name='411'>
    real(r8), dimension(pcols,kte+1) :: tke          <font color=#447700>! TKE from the moist PBL scheme<a name='412'></font>
    real(r8), dimension(pcols,kte+1) :: turbtype     <font color=#447700>! Turbulence type from the moist PBL scheme<a name='413'></font>
    real(r8), dimension(pcols,kte+1) :: smaw         <font color=#447700>! Instability function of momentum from the moist PBL scheme<a name='414'></font>
    <a name='415'>
    <font color=#447700>! Local variables for in-cloud water quantities adjusted for convective water<a name='416'></font>
    <a name='417'>
    real(r8)  allcld_ice (pcols,kte)                 <font color=#447700>! All-cloud cloud ice<a name='418'></font>
    real(r8)  allcld_liq (pcols,kte)                 <font color=#447700>! All-cloud liquid<a name='419'></font>
    <a name='420'>
    <font color=#447700>! Snow<a name='421'></font>
    <a name='422'>
    real(r8), dimension(pcols,kte) :: cldfsnow     <font color=#447700>! Cloud fraction for liquid+snow<a name='423'></font>
    real(r8), dimension(pcols,kte) :: icswp        <font color=#447700>! In-cloud snow water path<a name='424'></font>
    real(r8), dimension(pcols,kte) :: des          <font color=#447700>! Snow effective diameter (m)<a name='425'></font>
    real(r8)  qsout(pcols,kte)                       <font color=#447700>! Snow mixing ratio<a name='426'></font>
    <a name='427'>
    real(r8) :: qrout(pcols,kte)                     <font color=#447700>! Rain mixing ratio<a name='428'></font>
    real(r8) :: rflx(pcols,kte+1)                   <font color=#447700>! grid-box average rain flux (kg m^-2 s^-1)<a name='429'></font>
    real(r8) :: sflx(pcols,kte+1)                   <font color=#447700>! grid-box average snow flux (kg m^-2 s^-1)<a name='430'></font>
    real(r8) :: reff_rain(pcols,kte)                <font color=#447700>! rain effective radius (um)<a name='431'></font>
    real(r8) :: reff_snow(pcols,kte)                <font color=#447700>! snow effective radius (um)<a name='432'></font>
    <a name='433'>
    real(r8)  icecldf(pcols,kte)                     <font color=#447700>! Ice cloud fraction<a name='434'></font>
    real(r8)  liqcldf(pcols,kte)                     <font color=#447700>! Liquid cloud fraction (combined into cloud)<a name='435'></font>
    real(r8)  icecldf_out(pcols,kte)                 <font color=#447700>! Ice cloud fraction<a name='436'></font>
    real(r8)  liqcldf_out(pcols,kte)                 <font color=#447700>! Liquid cloud fraction (combined into cloud)<a name='437'></font>
    <a name='438'>
    <font color=#447700>! Local variables for microphysics<a name='439'></font>
    <a name='440'>
    real(r8)  rdtime                                  <font color=#447700>! 1./dtime<a name='441'></font>
    real(r8)  qtend(pcols,kte)                       <font color=#447700>! Moisture tendencies<a name='442'></font>
    real(r8)  ttend(pcols,kte)                       <font color=#447700>! Temperature tendencies<a name='443'></font>
    real(r8)  ltend(pcols,kte)                       <font color=#447700>! Cloud liquid water tendencies<a name='444'></font>
    real(r8)  evapsnow(pcols,kte)                    <font color=#447700>! Local evaporation of snow<a name='445'></font>
    real(r8)  prodsnow(pcols,kte)                    <font color=#447700>! Local production of snow<a name='446'></font>
    real(r8)  icimr(pcols,kte)                       <font color=#447700>! In cloud ice mixing ratio<a name='447'></font>
    real(r8)  icwmr(pcols,kte)                       <font color=#447700>! In cloud water mixing ratio<a name='448'></font>
    real(r8)  icimrst(pcols,kte)                     <font color=#447700>! In stratus ice mixing ratio<a name='449'></font>
    real(r8)  icwmrst(pcols,kte)                     <font color=#447700>! In stratus water mixing ratio<a name='450'></font>
    real(r8)  icimrst_out(pcols,kte)                 <font color=#447700>! In stratus ice mixing ratio<a name='451'></font>
    real(r8)  icwmrst_out(pcols,kte)                 <font color=#447700>! In stratus water mixing ratio<a name='452'></font>
    real(r8)  cmeice(pcols,kte)                      <font color=#447700>! Rate of cond-evap of ice within the cloud<a name='453'></font>
    real(r8)  temp(pcols)<a name='454'>
    real(r8)  res(pcols,kte)<a name='455'>
    <a name='456'>
    <font color=#447700>! MG micro diagnostics<a name='457'></font>
    <a name='458'>
    real(r8)  qcsevap(pcols,kte)                     <font color=#447700>! Evaporation of falling cloud water<a name='459'></font>
    real(r8)  qisevap(pcols,kte)                     <font color=#447700>! Sublimation of falling cloud ice<a name='460'></font>
    real(r8)  qvres(pcols,kte)                       <font color=#447700>! Residual condensation term to remove excess saturation<a name='461'></font>
    real(r8)  cmeiout(pcols,kte)                     <font color=#447700>! Deposition/sublimation rate of cloud ice<a name='462'></font>
    real(r8)  vtrmc(pcols,kte)                       <font color=#447700>! Mass-weighted cloud water fallspeed<a name='463'></font>
    real(r8)  vtrmi(pcols,kte)                       <font color=#447700>! Mass-weighted cloud ice fallspeed<a name='464'></font>
    real(r8)  qcsedten(pcols,kte)                    <font color=#447700>! Cloud water mixing ratio tendency from sedimentation<a name='465'></font>
    real(r8)  qisedten(pcols,kte)                    <font color=#447700>! Cloud ice mixing ratio tendency from sedimentation<a name='466'></font>
    <a name='467'>
    real(r8)  prao(pcols,kte)  <a name='468'>
    real(r8)  prco(pcols,kte)  <a name='469'>
    real(r8)  mnuccco(pcols,kte)  <a name='470'>
    real(r8)  mnuccto(pcols,kte)  <a name='471'>
    real(r8)  mnuccdo(pcols,kte)<a name='472'>
    real(r8)  mnuccdohet(pcols,kte)<a name='473'>
    real(r8)  msacwio(pcols,kte)  <a name='474'>
    real(r8)  psacwso(pcols,kte)  <a name='475'>
    real(r8)  bergso(pcols,kte)  <a name='476'>
    real(r8)  bergo(pcols,kte)  <a name='477'>
    real(r8)  melto(pcols,kte)  <a name='478'>
    real(r8)  homoo(pcols,kte)  <a name='479'>
    real(r8)  qcreso(pcols,kte)  <a name='480'>
    real(r8)  prcio(pcols,kte)  <a name='481'>
    real(r8)  praio(pcols,kte)  <a name='482'>
    real(r8)  qireso(pcols,kte)<a name='483'>
    real(r8)  ftem(pcols,kte)<a name='484'>
    real(r8)  mnuccro(pcols,kte) <a name='485'>
    real(r8)  pracso (pcols,kte) <a name='486'>
    real(r8)  meltsdt(pcols,kte) <a name='487'>
    real(r8)  frzrdt (pcols,kte) <a name='488'>
    real(r8)  dpdlfliq(pcols,kte)<a name='489'>
    real(r8)  dpdlfice(pcols,kte)<a name='490'>
    real(r8)  shdlfliq(pcols,kte)<a name='491'>
    real(r8)  shdlfice(pcols,kte)<a name='492'>
    real(r8)  dpdlft  (pcols,kte)<a name='493'>
    real(r8)  shdlft  (pcols,kte)<a name='494'>
    <a name='495'>
#ifdef MODAL_AERO<a name='496'>
    integer l, lnum, lnumcw, lmass, lmasscw<a name='497'>
#endif<a name='498'>
    <a name='499'>
    <font color=#447700>! Variables for MG microphysics<a name='500'></font>
    <a name='501'>
    real(r8)  dum1,dum2<a name='502'>
    real(r8)  qc(pcols,kte)<a name='503'>
    real(r8)  qi(pcols,kte)<a name='504'>
    real(r8)  nc(pcols,kte)<a name='505'>
    real(r8)  ni(pcols,kte)<a name='506'>
    real(r8)  icinc(pcols,kte)                       <font color=#447700>! In cloud ice number conc<a name='507'></font>
    real(r8)  cdnumc(pcols)                          <font color=#447700>! Vertically-integrated droplet concentration<a name='508'></font>
    real(r8)  icwnc(pcols,kte)                       <font color=#447700>! In cloud water number conc<a name='509'></font>
    real(r8)  iwc(pcols,kte)                         <font color=#447700>! Grid box average ice water content<a name='510'></font>
    real(r8)  lwc(pcols,kte)                         <font color=#447700>! Grid box average liquid water content  <a name='511'></font>
    real(r8)  effliq(pcols,kte)                      <font color=#447700>! In cloud liq eff rad<a name='512'></font>
    real(r8)  effice(pcols,kte)                      <font color=#447700>! In cloud ice eff rad<a name='513'></font>
    real(r8)  effliq_fn(pcols,kte)                   <font color=#447700>! In cloud liq eff rad at fixed number concentration	<a name='514'></font>
    real(r8)  wsub(pcols,kte)                        <font color=#447700>! Sub-grid vertical velocity (m/s)<a name='515'></font>
    real(r8)  wsubi(pcols,kte)                       <font color=#447700>! Sub-grid vertical velocity for ice (m/s)<a name='516'></font>
    <a name='517'>
    <font color=#447700>! Output from mmicro_pcond<a name='518'></font>
    <a name='519'>
    real(r8)  tlat(pcols,kte)<a name='520'>
    real(r8)  qvlat(pcols,kte)<a name='521'>
    real(r8)  qcten(pcols,kte)<a name='522'>
    real(r8)  qiten(pcols,kte)<a name='523'>
    real(r8)  ncten(pcols,kte)<a name='524'>
    real(r8)  niten(pcols,kte)<a name='525'>
    real(r8)  effc(pcols,kte)<a name='526'>
    real(r8)  effc_fn(pcols,kte)                     <font color=#447700>! Liquid effective radius at fixed number (for indirect calc)<a name='527'></font>
    real(r8)  effi(pcols,kte)<a name='528'>
    real(r8)  prect(pcols)<a name='529'>
    real(r8)  preci(pcols)<a name='530'>
    <a name='531'>
    <font color=#447700>! Output from microp_aero_ts for aerosol actication<a name='532'></font>
    real(r8)  naai(pcols,kte)      <font color=#447700>!ice nucleation number<a name='533'></font>
    real(r8)  naai_hom(pcols,kte)  <font color=#447700>!ice nucleation number (homogeneous)<a name='534'></font>
    real(r8)  npccn(pcols,kte)     <font color=#447700>!liquid activation number tendency<a name='535'></font>
    real(r8)  rndst(pcols,kte,4)<a name='536'>
    real(r8)  nacon(pcols,kte,4)<a name='537'>
    <a name='538'>
    <font color=#447700>! Averaging arrays for effective radius and number....<a name='539'></font>
    <a name='540'>
    real(r8)  efiout(pcols,kte)<a name='541'>
    real(r8)  efcout(pcols,kte)<a name='542'>
    real(r8)  ncout(pcols,kte)<a name='543'>
    real(r8)  niout(pcols,kte)<a name='544'>
    <a name='545'>
    real(r8)  freqi(pcols,kte)<a name='546'>
    real(r8)  freql(pcols,kte)<a name='547'>
    <a name='548'>
    <font color=#447700>! Average cloud top radius &amp; number<a name='549'></font>
    <a name='550'>
    real(r8)  ctrel(pcols)<a name='551'>
    real(r8)  ctrei(pcols)<a name='552'>
    real(r8)  ctnl(pcols)<a name='553'>
    real(r8)  ctni(pcols)<a name='554'>
    real(r8)  fcti(pcols)<a name='555'>
    real(r8)  fctl(pcols)<a name='556'>
    <a name='557'>
    <font color=#447700>! Gather mass mixing ratio for all aerosols affecting the climate<a name='558'></font>
    <a name='559'>
    integer               :: naer_all<a name='560'>
    real(r8)     :: aermmr1(pcols,kte)<a name='561'>
    real(r8), allocatable :: aer_mmr(:,:,:)           <font color=#447700>! Aerosol mass mixing ratio<a name='562'></font>
    <a name='563'>
    real(r8)  zeros(pcols,kte)<a name='564'>
    <a name='565'>
    real(r8)  alst_mic(pcols,kte)<a name='566'>
    real(r8)  aist_mic(pcols,kte)<a name='567'>
    <a name='568'>
    real(r8), pointer :: fldcw(:,:)<a name='569'>
    real(r8) :: xland_pt<a name='570'>
    real(r8) :: snowh_pt<a name='571'>
    <font color=#447700>! ======================================================================<a name='572'></font>
    <a name='573'>
    <a name='574'>
    <font color=#447700>!cmeliq is an output from Macro physics. Its assigned zero here as Macrophysics is NOT implemented yet<a name='575'></font>
    <font color=#447700>!*** IMPORTANT-WARNING ***: The following assignment will produce an incorrect value of QME3D<a name='576'></font>
    cmeliq(:,:)=0.0_r8<a name='577'>
    <a name='578'>
    <font color=#447700>!*** IMPORTANT-WARNING *** :Should be in the namelist file. Hardwired currently<a name='579'></font>
    conv_water_in_rad = 1<a name='580'>
    <a name='581'>
#if ( WRF_CHEM == 1 )<a name='582'>
    p1st = param_first_scalar <font color=#447700>! Obtain CHEM array's first element's index<a name='583'></font>
#endif          <a name='584'>
    <a name='585'>
    <font color=#447700>! Specify diameter for each mode<a name='586'></font>
#if ( WRF_CHEM <font color=#447700>!= 1 )<a name='587'></font>
    dgnumwet(:,:,:)              = 0.1e-6_r8      <font color=#447700>!*** IMPORTANT-WARNING *** :Constant value for the whole domain (prescribed value). The value match precribe_aerosol_mixactivate, but units change<a name='588'></font>
    dgnumwet(:,:,modeptr_aitken) = 0.02e-6<a name='589'>
    dgnumwet(:,:,modeptr_coarse) = 1.0e-6 <a name='590'>
#else<a name='591'>
    if(chem_opt == 0 ) then<a name='592'>
       dgnumwet(:,:,:)              = 0.1e-6_r8      <font color=#447700>!*** IMPORTANT-WARNING *** :Constant value for the whole domain (prescribed value). The value match precribe_aerosol_mixactivate, but units change<a name='593'></font>
       dgnumwet(:,:,modeptr_aitken) = 0.02e-6<a name='594'>
       dgnumwet(:,:,modeptr_coarse) = 1.0e-6 <a name='595'>
    endif<a name='596'>
#endif<a name='597'>
    <a name='598'>
    <font color=#447700>!dgnum wet and dry are assumed to be same for now<a name='599'></font>
    dgnum(:,:,:) = dgnumwet(:,:,:) <a name='600'>
    <a name='601'>
    <font color=#447700>!Time step is stored in the (r8) format in dtime<a name='602'></font>
    dtime = dt<a name='603'>
<a name='604'>
    <a name='605'>
    <font color=#447700>!default values for radius <a name='606'></font>
    lradius(:,:,:) = 10._r8<a name='607'>
    iradius(:,:,:) = 70._r8<a name='608'>
  <a name='609'>
    <font color=#447700>!Flag for first time step<a name='610'></font>
    is_first_step  = .false.<a name='611'>
    if(itimestep == 1) then<a name='612'>
       is_first_step          = .true.<a name='613'>
       cldfra_old_mp(:,:,:)   = 0.0_r8<a name='614'>
       rate1ord_cw2pr_st(:,:) = 0.0_r8 <a name='615'>
       cldfrai(:,:,:)       = 0._r8<a name='616'>
       cldfral(:,:,:)       = 0._r8<a name='617'>
       cldfra_mp(:,:,:)     = 0._r8<a name='618'>
       cldfra_mp_all(:,:,:) = 0._r8<a name='619'>
       cldfra_conv(:,:,:)   = 0._r8<a name='620'>
<a name='621'>
       if(config_flags%shcu_physics .NE. CAMUWSHCUSCHEME) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_801">('WARNING: sh_icwmr,cmfmc,cmfmc2 and sh_frac are set to zero in CAMMGMP')<a name='622'>
       if(config_flags%cu_physics   .NE. CAMZMSCHEME)     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_802">('WARNING: dp_icwmr is set to zero in CAMMGMP')<a name='623'>
    endif<a name='624'>
    <a name='625'>
    ncol = pcols    <a name='626'>
    <font color=#447700>!This subroutine requires that ncol == 1<a name='627'></font>
    if(ncol .NE. 1) then<a name='628'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_725">('Number of CAM Columns (NCOL) in CAMMGMP scheme must be 1')<a name='629'>
    endif<a name='630'>
    <a name='631'>
    <font color=#447700>!*** IMPORTANT-WARNING ***:Initializing variables which are **NEVER** used but required for call consistency for CAM specific subroutine calls<a name='632'></font>
    concld(:,:)      =0.0_r8  <font color=#447700>!Required for computing some diagnostic variables. These diagnostic variables are <a name='633'></font>
                              <font color=#447700>!commented out for now as we didn't map 'concld' with the WRF sided variables<a name='634'></font>
    <a name='635'>
    state_omega(:,:) = 0.0_r8 <font color=#447700>!Required for calling mmicro_pcond and microp_aero_ts. Used in microp_aero_ts for <a name='636'></font>
                              <font color=#447700>!calling dropmixnuc but **NEVER** used for any output from dropmixnuc<a name='637'></font>
    <a name='638'>
    <font color=#447700>!Divide domain in chuncks and map WRF variables into CAM<a name='639'></font>
    <font color=#447700>!Loop counters are named iw,jw,kw to represent that they index WRF sided variables<a name='640'></font>
    <font color=#447700>!The CAM's side variables are kept almost same by just replacing '%' with an '_' [e.g state%t in CAM is state_t in WRF]<a name='641'></font>
    <a name='642'>
    itsm1     = its - 1 <a name='643'>
    itile_len = ite - itsm1<a name='644'>
    do jw     = jts , jte <a name='645'>
       do iw  = its , ite <a name='646'>
          <a name='647'>
          xland_pt = xland(iw,jw)<a name='648'>
          snowh_pt = snowh(iw,jw)<a name='649'>
<a name='650'>
          lchnk   = (jw - jts) * itile_len + (iw - itsm1)          <font color=#447700>!1-D index location from a 2-D tile<a name='651'></font>
          phis(1) = ht(iw,jw)  * gravit   <a name='652'>
          ktep1   = kte + 1<a name='653'>
          <a name='654'>
          <font color=#447700>!Flip vertically quantities computed at the mid points        <a name='655'></font>
          do kw  = kts, kte<a name='656'>
             kflip                = ktep1 - kw<a name='657'>
             state_pmid(1,kflip)  = p_hyd(iw,kw,jw)                   <font color=#447700>!Pressure at the mid-points (Pa) [state%pmid in CAM]  <a name='658'></font>
             dp                   = p8w(iw,kw,jw) - p8w(iw,kw+1,jw)   <font color=#447700>!Change in pressure (Pa) <a name='659'></font>
             state_pdel(1,kflip)  = dp<a name='660'>
             state_rpdel(1,kflip) = 1.0_r8/dp                         <font color=#447700>!Reciprocal of pressure difference (1/Pa) [state%rpdel in CAM]<a name='661'></font>
             state_zm(1,kflip)    = z_sea_level(iw,kw,jw) - ht(iw,jw) <font color=#447700>!Height above the ground at the midpoints (m) [state%zm in CAM]<a name='662'></font>
             state_t(1,kflip)     = t_phy(iw,kw,jw)                   <font color=#447700>!Temprature at the mid points (K) [state%t in CAM]<a name='663'></font>
             state_s(1,kflip)     = cpair *th(iw,kw,jw)*pi_phy(iw,kw,jw) + gravit*state_zm(1,kflip) + phis(1) <font color=#447700>! Dry static energy (m2/s2) [state%s in CAM]-Formula tested in vertical_diffusion.F90 of CAM<a name='664'></font>
             <a name='665'>
             <font color=#447700>!Following three formulas are obtained from ported CAM's ZM cumulus scheme<a name='666'></font>
             <font color=#447700>!Values of 0 cause a crash in entropy<a name='667'></font>
             multFrc              = 1._r8/(1._r8 + qv_curr(iw,kw,jw))<a name='668'>
             state_q(1,kflip,1)   = qv_curr(iw,kw,jw)*multFrc      <font color=#447700>!Specific humidity                       [state%q(:,:,1) in CAM]<a name='669'></font>
             state_q(1,kflip,ixcldliq) = qc_curr(iw,kw,jw)*multFrc <font color=#447700>!Convert to moist mix ratio-cloud liquid [state%q(:,:,2) in CAM]<a name='670'></font>
             state_q(1,kflip,ixcldice) = qi_curr(iw,kw,jw)*multFrc <font color=#447700>!cloud ice                               [state%q(:,:,3) in CAM]<a name='671'></font>
             state_q(1,kflip,ixnumliq) = nc3d(iw,kw,jw)*multFrc<a name='672'>
             state_q(1,kflip,ixnumice) = ni3d(iw,kw,jw)*multFrc<a name='673'>
<a name='674'>
             qi_mac(1,kflip)           = qi_curr(iw,kw,jw)*multFrc<a name='675'>
<a name='676'>
             <font color=#447700>!Check for negative constituents, value below 'qthresh_...' are reset to qmin <a name='677'></font>
             <font color=#447700>!For mass mixing ratio<a name='678'></font>
             if(abs(state_q(1,kflip,1))        &lt; qthresh_mass .and. state_q(1,kflip,1)        &lt; qmin(1))        state_q(1,kflip,1)        = qmin(1)<a name='679'>
             if(abs(state_q(1,kflip,ixcldliq)) &lt; qthresh_mass .and. state_q(1,kflip,ixcldliq) &lt; qmin(ixcldliq)) state_q(1,kflip,ixcldliq) = qmin(ixcldliq)<a name='680'>
             if(abs(state_q(1,kflip,ixcldice)) &lt; qthresh_mass .and. state_q(1,kflip,ixcldice) &lt; qmin(ixcldice)) state_q(1,kflip,ixcldice) = qmin(ixcldice)<a name='681'>
<a name='682'>
             <font color=#447700>!For number mixing ratio<a name='683'></font>
             if(abs(state_q(1,kflip,ixnumliq)) &lt; qthresh_numl .and. state_q(1,kflip,ixnumliq) &lt; qmin(ixnumliq)) state_q(1,kflip,ixnumliq) = qmin(ixnumliq)<a name='684'>
             if(abs(state_q(1,kflip,ixnumice)) &lt; qthresh_numi .and. state_q(1,kflip,ixnumice) &lt; qmin(ixnumice)) state_q(1,kflip,ixnumice) = qmin(ixnumice)<a name='685'>
<a name='686'>
<a name='687'>
             <font color=#447700>!Set negative values to qmin and generate a warning message<a name='688'></font>
             if(state_q(1,kflip,1) &lt; 0.0_r8)then<a name='689'>
                <font color=#447700>!write(wrfmessage,*)'Water vapor mass mixing ratio was:', state_q(1,kflip,1),'; Reset to',qmin(1), 'in CAMMGMP driver'<a name='690'></font>
                <font color=#447700>!call wrf_message(wrfmessage)                                <a name='691'></font>
                state_q(1,kflip,1)        = qmin(1)<a name='692'>
             endif<a name='693'>
             <a name='694'>
             if(state_q(1,kflip,ixcldliq) &lt; 0.0_r8) then<a name='695'>
                <font color=#447700>!write(wrfmessage,*)'Liquid cloud mass mixing ratio was:', state_q(1,kflip,ixcldliq),'; Reset to',qmin(ixcldliq), 'in CAMMGMP driver'<a name='696'></font>
                <font color=#447700>!call wrf_message(wrfmessage) <a name='697'></font>
                state_q(1,kflip,ixcldliq) = qmin(ixcldliq)<a name='698'>
             endif<a name='699'>
<a name='700'>
             if(state_q(1,kflip,ixcldice) &lt; 0.0_r8) then<a name='701'>
                <font color=#447700>!write(wrfmessage,*)'Ice cloud mass mixing ratio was:', state_q(1,kflip,ixcldice),'; Reset to',qmin(ixcldice), 'in CAMMGMP driver'<a name='702'></font>
                <font color=#447700>!call wrf_message(wrfmessage) <a name='703'></font>
                state_q(1,kflip,ixcldice) = qmin(ixcldice)<a name='704'>
             endif<a name='705'>
<a name='706'>
             if(state_q(1,kflip,ixnumliq) &lt; 0.0_r8) then<a name='707'>
                <font color=#447700>!write(wrfmessage,*)'Liquid droplet number was:', state_q(1,kflip,ixnumliq),'; Reset to',qmin(ixnumliq), 'in CAMMGMP driver'<a name='708'></font>
                <font color=#447700>!call wrf_message(wrfmessage) <a name='709'></font>
                state_q(1,kflip,ixnumliq) = qmin(ixnumliq)<a name='710'>
             endif<a name='711'>
             <a name='712'>
             if(state_q(1,kflip,ixnumice) &lt; 0.0_r8) then<a name='713'>
                <font color=#447700>!write(wrfmessage,*)'Ice crystal number was:', state_q(1,kflip,ixnumice),'; Reset to',qmin(ixnumice), 'in CAMMGMP driver'<a name='714'></font>
                <font color=#447700>!call wrf_message(wrfmessage) <a name='715'></font>
                state_q(1,kflip,ixnumice) = qmin(ixnumice)<a name='716'>
             endif<a name='717'>
             <font color=#447700>! For prescribed aerosols<a name='718'></font>
             qqcw(1,kflip,:)                  = 1.e-38_r8      <font color=#447700>!used in microp_aero for dropmicnuc, presently set to a constant value<a name='719'></font>
#if ( WRF_CHEM == 1 )<a name='720'>
             if(chem_opt.NE.0 .and. config_flags%CAM_MP_MAM_cpled ) then<a name='721'>
                <font color=#447700>!Following Do-Loop is obtained from chem/module_cam_mam_aerchem_driver.F <a name='722'></font>
                do l = p1st, num_chem<a name='723'>
                   l2 = lptr_chem_to_q(l)<a name='724'>
                   if ((l2 &gt;= 1) .and. (l2 &lt;= pcnst)) then<a name='725'>
                      state_q(1,kflip,l2) = chem(iw,kw,jw,l)*factconv_chem_to_q(l)<a name='726'>
                      if(state_q(1,kflip,l2) &lt; 0.0_r8) then<a name='727'>
                         <font color=#447700>!write(wrfmessage,*)'Chem species with index', l,' was:', state_q(1,kflip,l2),'; Reset to 0.0 in CAMMGMP driver'<a name='728'></font>
                         <font color=#447700>!call wrf_message(wrfmessage) <a name='729'></font>
                         state_q(1,kflip,l2) = 0.0_r8<a name='730'>
                      endif<a name='731'>
                   end if<a name='732'>
                   l2 = lptr_chem_to_qqcw(l)<a name='733'>
                   if ((l2 &gt;= 1) .and. (l2 &lt;= pcnst)) then<a name='734'>
                      qqcw(1,kflip,l2) = chem(iw,kw,jw,l)*factconv_chem_to_q(l)<a name='735'>
                       if(qqcw(1,kflip,l2)&lt; 0.0_r8) then<a name='736'>
                          <font color=#447700>!write(wrfmessage,*)'Chem species with index', l,' was:', qqcw(1,kflip,l2),'; Reset to 0.0 in CAMMGMP driver'<a name='737'></font>
                          <font color=#447700>!call wrf_message(wrfmessage) <a name='738'></font>
                         qqcw(1,kflip,l2) = 0.0_r8<a name='739'>
                      endif<a name='740'>
                   end if<a name='741'>
                end do <font color=#447700>! l<a name='742'></font>
                <font color=#447700>!Populate dgnums appropriately<a name='743'></font>
                do imode = 1 , ntot_amode<a name='744'>
                   if(is_first_step) then<a name='745'>
                      dgnum(1,kflip,imode)    = 0.0_r8 <font color=#447700>!Set it to zero for the first time step<a name='746'></font>
                      dgnumwet(1,kflip,imode) = 0.0_r8<a name='747'>
                   else<a name='748'>
                      dgnum(1,kflip,imode)    = dgnum4D(iw,kw,jw,imode)   <font color=#447700>!Obtained from 4D arrays <a name='749'></font>
                      dgnumwet(1,kflip,imode) = dgnumwet4D(iw,kw,jw,imode) <a name='750'>
                   endif<a name='751'>
                enddo<a name='752'>
             endif<a name='753'>
#endif<a name='754'>
<a name='755'>
             cldo(1,kflip)        = cldfra_mp_all(iw,kw,jw)<a name='756'>
             <a name='757'>
             <font color=#447700>!New code by PMA<a name='758'></font>
             rh_old(1,kflip)      = rh_old_mp(iw,kw,jw)<a name='759'>
             dlf(1,kflip)         = 0.0_r8<a name='760'>
             dlf2(1,kflip)        = 0.0_r8<a name='761'>
<a name='762'>
             sh_icwmr(1,kflip)    = 0.0_r8<a name='763'>
             sh_frac(1,kflip)     = 0.0_r8<a name='764'>
             dp_frac(1,kflip)     = 0._r8<a name='765'>
             if(config_flags%shcu_physics==CAMUWSHCUSCHEME) then<a name='766'>
                sh_icwmr(1,kflip)  = icwmrsh3d(iw,kw,jw)      <font color=#447700>!Shallow cumulus in-cloud water mixing ratio (kg/m2)<a name='767'></font>
                sh_frac(1,kflip)   = shfrc3d(iw,kw,jw)        <font color=#447700>!Shallow convective cloud fraction<a name='768'></font>
                dlf2(1,kflip)      = dlf2_3d(iw,kw,jw)        <font color=#447700>!PMA QC detrained from shallow<a name='769'></font>
             endif<a name='770'>
             dp_icwmr(1,kflip)     = 0.0_r8<a name='771'>
             if(config_flags%cu_physics==CAMZMSCHEME)then<a name='772'>
                dp_icwmr(1,kflip)  = icwmrdp3d(iw,kw,jw)      <font color=#447700>!Deep conv. cloud water<a name='773'></font>
                dlf(1,kflip)       = dlf3d(iw,kw,jw)          <font color=#447700>!PMA Qc detrained from deep+shallow<a name='774'></font>
             endif<a name='775'>
             <a name='776'>
          enddo<a name='777'>
          <a name='778'>
          do kw = kts, kte+1<a name='779'>
             kflip = kte - kw + 2<a name='780'>
             <a name='781'>
             state_pint(1,kflip) = p8w(iw,kw,jw)        <font color=#447700>!Pressure at interfaces [state%pint in CAM]<a name='782'></font>
             tke(1,kflip)        = tke_pbl(iw,kw,jw)    <font color=#447700>!Turbulent kinetic energy <a name='783'></font>
             kkvh(1,kflip)       = kvh3d(iw,kw,jw)      <font color=#447700>!Vertical diffusivity (m2/s)<a name='784'></font>
             turbtype(1,kflip)   = turbtype3d(iw,kw,jw) <font color=#447700>!Turbulent interface types [ no unit ]<a name='785'></font>
             smaw(1,kflip)       = smaw3d(iw,kw,jw)     <font color=#447700>!Normalized Galperin instability function for momentum  ( 0&lt;= &lt;=4.964 and 1 at neutral ) [no units]<a name='786'></font>
<a name='787'>
             cmfmc(1,kflip)      = 0.0_r8<a name='788'>
             cmfmc2(1,kflip)     = 0.0_r8<a name='789'>
             if(config_flags%shcu_physics==CAMUWSHCUSCHEME  .or. config_flags%cu_physics   == CAMZMSCHEME ) then <a name='790'>
                cmfmc(1,kflip)   = cmfmc3d(iw,kw,jw)    <font color=#447700>!Deep + Shallow Convective mass flux [ kg /s/m^2 ]<a name='791'></font>
             endif<a name='792'>
             <a name='793'>
             if(config_flags%shcu_physics==CAMUWSHCUSCHEME ) then<a name='794'>
                cmfmc2(1,kflip)  = cmfmc2_3d(iw,kw,jw)  <font color=#447700>!Shallow convective mass flux [ kg/s/m^2 ]<a name='795'></font>
             endif<a name='796'>
             <a name='797'>
          end do<a name='798'>
          do kcam = 1, kte<a name='799'>
             <font color=#447700>!Formulation for dp_frac is obtained from cloud_fraction.F90 of CAM<a name='800'></font>
             dp_frac(1,kcam)         = max(0.0_r8,min(dp1*log(1.0_r8+dp2*(cmfmc(1,kcam+1)-cmfmc2(1,kcam+1))),0.60_r8)) <font color=#447700>! Deep convective cloud fraction<a name='801'></font>
          end do<a name='802'>
<a name='803'>
<a name='804'>
          <font color=#447700>!set cflx zero for all the constituents, update the water vapor surface flux after that<a name='805'></font>
          cflx(:pcols,:) = 0.0_r8        <font color=#447700>!Surface constituent flux (kg/m2/s)<a name='806'></font>
          cflx(:pcols,1) = qfx(iw,jw)    <font color=#447700>!Surface constituent flux (kg/m2/s)<a name='807'></font>
          rliq(:pcols)   = rliq2d(iw,jw) <font color=#447700>!Vertically-integrated reserved cloud condensate (m/s)<a name='808'></font>
          <a name='809'>
<a name='810'>
          <font color=#447700>!Following assignments mimics CAM's 'physics_state_copy' call<a name='811'></font>
          state1_pmid(:,:)  = state_pmid(:,:)<a name='812'>
          state1_pdel(:,:)  = state_pdel(:,:)<a name='813'>
          state1_rpdel(:,:) = state_rpdel(:,:)<a name='814'>
          state1_zm(:,:)    = state_zm(:,:)<a name='815'>
          state1_t(:,:)     = state_t(:,:)<a name='816'>
          state1_s(:,:)     = state_s(:,:)<a name='817'>
          state1_pint(:,:)  = state_pint(:,:)<a name='818'>
          state1_q(:,:,:)   = state_q(:,:,:)<a name='819'>
          state1_omega(:,:) = state_omega(:,:) <font color=#447700>!*** IMPORTANT-WARNING ***:State_omega is *NOT* used for any meaningful computation at this time<a name='820'></font>
          <a name='821'>
          call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_INIT'>physics_ptend_init</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_PTEND_INIT_2">(ptend_loc_name,ptend_loc_q,ptend_loc_s,ptend_loc_lq,ptend_loc_ls,pcnst)  <font color=#447700>!! Initialize local ptend type <a name='822'></font>
          call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_INIT'>physics_ptend_init</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_PTEND_INIT_3">(ptend_all_name,ptend_all_q,ptend_all_s,ptend_all_lq,ptend_all_ls,pcnst)  <font color=#447700>!! Initialize output ptend type<a name='823'></font>
          <a name='824'>
#ifdef MODAL_AERO<a name='825'>
          if( is_first_step) then<a name='826'>
             do i=1,pcnst<a name='827'>
                fldcw =&gt; qqcw(:,:,i)<a name='828'>
                if(associated(fldcw)) then<a name='829'>
                   fldcw(1:pcols,1:pver)          = 1.e-38_r8<a name='830'>
                end if<a name='831'>
             end do<a name='832'>
          endif<a name='833'>
#endif<a name='834'>
          <a name='835'>
          <font color=#447700>!! If first timestep, initialize heatflux....in pbuf at all time levels.<a name='836'></font>
          <a name='837'>
          if( is_first_step) then<a name='838'>
             kkvh(:,:)     = 0._r8<a name='839'>
             tke(:,:)      = 0._r8<a name='840'>
             <font color=#447700>! *** IMPORTANT-WARNING ***:turbtype and smaw are used to compute 'smm' in microp_aero_ts subroutine but 'smm' is NEVER<a name='841'></font>
             <font color=#447700>! again used for any output from microp_aero_ts. Therefore, these variables are NOT used in any<a name='842'></font>
             <font color=#447700>! meaningful computations<a name='843'></font>
             turbtype(:,:) = 0._r8<a name='844'>
             smaw(:,:)     = 0._r8<a name='845'>
             dlf(:,:)      = 0._r8<a name='846'>
             dlf2(:,:)     = 0._r8<a name='847'>
          endif<a name='848'>
          <a name='849'>
          <font color=#447700>!! Assign default size distribution parameters for no-stratiform clouds (convection only)<a name='850'></font>
          <font color=#447700>!! Also put into physics buffer for possible separate use by radiation<a name='851'></font>
          <a name='852'>
          dcon   = 25.e-6_r8<a name='853'>
          mucon  = 5.3_r8<a name='854'>
          deicon = 50._r8<a name='855'>
          <a name='856'>
          muconv(:,:)     = mucon<a name='857'>
          lambdaconv(:,:) = (mucon + 1._r8)/dcon<a name='858'>
          deiconv(:,:)    = deicon<a name='859'>
          <a name='860'>
          <font color=#447700>!BSINGH - CALL Macrophysics<a name='861'></font>
          call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE'>Macrophysics_simple</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MACROPHYSICS_SIMPLE_1">(is_first_step, pcnst, pcols, kte, ixcldliq, ixnumliq,         &amp;<a name='862'>
               lchnk, dtime, state1_t, state_pmid, state_q, dp_icwmr, sh_icwmr, dp_frac,      &amp;<a name='863'>
               sh_frac, ast,aist,alst,qi_mac,xland_pt,snowh_pt,                               &amp;<a name='864'>
               <font color=#447700>!intent-inout<a name='865'></font>
               state1_s, state1_q, rh_old, cldo, esl, qvs, ptend_loc_name, ptend_loc_ls,      &amp;<a name='866'>
               ptend_loc_lq, ptend_loc_s,ptend_loc_q, ptend_all_name, ptend_all_ls,           &amp;<a name='867'>
               ptend_all_lq,ptend_all_s,ptend_all_q                                           )          <a name='868'>
          <a name='869'>
          do kw = kts , kte<a name='870'>
             kflip                   = kte-kw+1<a name='871'>
<a name='872'>
             cldfral(iw,kw,jw)       = alst(1,kflip)<a name='873'>
             cldfrai(iw,kw,jw)       = aist(1,kflip)<a name='874'>
             CLDFRA_MP(iw,kw,jw)     = ast(1,kflip)  <a name='875'>
             cld(1,kflip)            = ast(1,kflip)<a name='876'>
             CLDFRA_MP_all(iw,kw,jw) = min(ast(1,kflip)+min(0.8_r8,dp_frac(1,kflip)+sh_frac(1,kflip)),1._r8)<a name='877'>
             CLDFRA_CONV(iw,kw,jw)   = max(min(0.8_r8,dp_frac(1,kflip)+sh_frac(1,kflip)),0._r8)<a name='878'>
             concld(1,kflip)         = CLDFRA_CONV(iw,kw,jw) <a name='879'>
             cldo(1,kflip)           = cldfra_old_mp(iw,kw,jw)<a name='880'>
          end do<a name='881'>
<a name='882'>
          <font color=#447700>!! ------------------------------------- !<a name='883'></font>
          <font color=#447700>!! From here, process computation begins ! <a name='884'></font>
          <font color=#447700>!! ------------------------------------- !<a name='885'></font>
<a name='886'>
          <a name='887'>
          <font color=#447700>!! ----------------------- !<a name='888'></font>
          <font color=#447700>!! Microp_Driver Microphysics !<a name='889'></font>
          <font color=#447700>!! ----------------------- !<a name='890'></font>
<a name='891'>
          ptend_loc_name         = 'microp'<a name='892'>
          ptend_loc_ls           = .true.<a name='893'>
          ptend_loc_lq(1)        = .true.<a name='894'>
          ptend_loc_lq(ixcldliq) = .true.<a name='895'>
          ptend_loc_lq(ixcldice) = .true.<a name='896'>
          ptend_loc_lq(ixnumliq) = .true.<a name='897'>
          ptend_loc_lq(ixnumice) = .true.<a name='898'>
          <a name='899'>
#ifndef MODAL_AERO<a name='900'>
          call rad_cnst_get_info( 0, naero = naer_all )<a name='901'>
          allocate( aer_mmr( pcols, pver, naer_all ) )<a name='902'>
          do m = 1, naer_all<a name='903'>
             call rad_cnst_get_aer_mmr( 0, m, state1, pbuf, aermmr1 )<a name='904'>
             aer_mmr(:ncol,:,m) = aermmr1(:ncol,:)<a name='905'>
          enddo<a name='906'>
#endif<a name='907'>
          <a name='908'>
#ifdef MODAL_AERO<a name='909'>
#if ( WRF_CHEM == 1 )<a name='910'>
          do m = 1, ntot_amode<a name='911'>
             lnum = numptr_amode(m)<a name='912'>
             if( lnum &gt; 0 ) then<a name='913'>
                ptend_loc_lq(lnum)= .true.<a name='914'>
             endif<a name='915'>
             do l = 1, nspec_amode(m)<a name='916'>
                lmass = lmassptr_amode(l,m)<a name='917'>
                ptend_loc_lq(lmass)= .true.<a name='918'>
             enddo<a name='919'>
          enddo<a name='920'>
          <font color=#447700>!Do not update dummy aerosols in state if chem_opt is 0 or CAM_MP_MAM_cpled == .false.<a name='921'></font>
          if(chem_opt == 0 .or. .NOT.config_flags%CAM_MP_MAM_cpled) then<a name='922'>
             do m = 6 , pcnst   <font color=#447700>!First m = 1 to 5 are water species<a name='923'></font>
                ptend_loc_lq(m)= .false.<a name='924'>
             enddo<a name='925'>
          endif<a name='926'>
#endif<a name='927'>
#endif<a name='928'>
          <a name='929'>
          zeros(:ncol,:pver)  = 0._r8<a name='930'>
          qc(:ncol,:pver) = state1_q(:ncol,:pver,ixcldliq)<a name='931'>
          qi(:ncol,:pver) = state1_q(:ncol,:pver,ixcldice)<a name='932'>
          nc(:ncol,:pver) = state1_q(:ncol,:pver,ixnumliq)<a name='933'>
          ni(:ncol,:pver) = state1_q(:ncol,:pver,ixnumice)<a name='934'>
          <a name='935'>
          if( micro_treatment .eq. 'inter' ) then<a name='936'>
             alst_mic(:ncol,:pver) = ast(:ncol,:pver)<a name='937'>
             aist_mic(:ncol,:pver) = ast(:ncol,:pver)<a name='938'>
          elseif( micro_treatment .eq. 'compl' ) then<a name='939'>
             alst_mic(:ncol,:pver) = alst(:ncol,:pver)<a name='940'>
             aist_mic(:ncol,:pver) = aist(:ncol,:pver)<a name='941'>
          endif<a name='942'>
          <a name='943'>
#if ( WRF_CHEM <font color=#447700>!= 1 )          <a name='944'></font>
          <font color=#447700>!Adding 7 new fields to state1_q(# mixing ratio and mass mixing ratio<a name='945'></font>
          <font color=#447700>!for 3 modes of prescribed aerosols[s04,dust(+sea salt),aitken]) array. <a name='946'></font>
          <font color=#447700>!state%q holds 5 constituents already therefore the prescribed aerosol <a name='947'></font>
          <font color=#447700>!are defined from 6th to 12th constituents<a name='948'></font>
          <a name='949'>
          n = modeptr_accum    <font color=#447700>!Adding 7th constituent (# mixing ratio) <a name='950'></font>
          <font color=#447700>!tmpnaer = 1000.0e6  !This value is taken from precribe_aerosol_mixactivate! 1.e9 #/kg ~= 1.e3 #/cm3<a name='951'></font>
          tmpnaer = accum_mode <font color=#447700>!172.7e6 -For ISDAC case ONLY<a name='952'></font>
          l = numptr_amode(n)  <a name='953'>
          state1_q(:,:,l) = tmpnaer<a name='954'>
          <a name='955'>
          m = 1                <font color=#447700>!Adding 6th constituent (mass mixing ratio) <a name='956'></font>
          tmpmaer = specdens_amode(lspectype_amode(m,n)) * tmpnaer / voltonumb_amode(n)<a name='957'>
          l = lmassptr_amode(m,n)<a name='958'>
          state1_q(:,:,l) = tmpmaer<a name='959'>
          <a name='960'>
          n = modeptr_aitken   <font color=#447700>!Adding 9th constituent (# mixing ratio) <a name='961'></font>
          <font color=#447700>!tmpnaer = 300.0e6<a name='962'></font>
          tmpnaer = aitken_mode <font color=#447700>!0.0e6 -For ISDAC case ONLY<a name='963'></font>
          l = numptr_amode(n)<a name='964'>
          state1_q(:,:,l) = tmpnaer<a name='965'>
          <a name='966'>
          m = 1                <font color=#447700>!Adding 8th constituent (mass mixing ratio)<a name='967'></font>
          tmpmaer = specdens_amode(lspectype_amode(m,n)) * tmpnaer / voltonumb_amode(n)<a name='968'>
          l = lmassptr_amode(m,n)<a name='969'>
          state1_q(:,:,l) = tmpmaer<a name='970'>
          <a name='971'>
          n = modeptr_coarse   <font color=#447700>!Adding 12th constituent (# mixing ratio) <a name='972'></font>
          <font color=#447700>!tmpnaer = 0.2e6<a name='973'></font>
          tmpnaer = coarse_mode <font color=#447700>!1.1e6 -For ISDAC case ONLY<a name='974'></font>
          l = numptr_amode(n)<a name='975'>
          state1_q(:,:,l) = tmpnaer<a name='976'>
          <a name='977'>
          tmpmaer = specdens_amode(lspectype_amode(m,n)) * tmpnaer / voltonumb_amode(n)<a name='978'>
          m = 1                <font color=#447700>!Adding 10th constituent (mass mixing ratio)<a name='979'></font>
          l = lmassptr_amode(m,n)<a name='980'>
          state1_q(:,:,l) = tmpmaer*0.5<a name='981'>
          <a name='982'>
          m = 2                <font color=#447700>!Adding 11th constituent (mass mixing ratio)<a name='983'></font>
          l = lmassptr_amode(m,n)<a name='984'>
          state1_q(:,:,l) = tmpmaer*0.5<a name='985'>
#else<a name='986'>
          if(chem_opt==0 .or. .NOT. config_flags%CAM_MP_MAM_cpled) then<a name='987'>
          do k = 1, pver<a name='988'>
             n = modeptr_accum    <font color=#447700>!Adding 7th constituent (# mixing ratio) <a name='989'></font>
             tmpnaer = accum_mode <font color=#447700>!172.7e6 -For ISDAC case ONLY<a name='990'></font>
             l = numptr_amode(n)  <a name='991'>
             qqcw(1,k,l) = tmpnaer*alst(1,k)*0.8<a name='992'>
             state1_q(1,k,l) = tmpnaer-qqcw(1,k,l)<a name='993'>
             <a name='994'>
             m = 1                <font color=#447700>!Adding 6th constituent (mass mixing ratio) <a name='995'></font>
             tmpmaer = specdens_amode(lspectype_amode(m,n)) * tmpnaer / voltonumb_amode(n)<a name='996'>
             l = lmassptr_amode(m,n)<a name='997'>
             qqcw(1,k,l) = tmpmaer*alst(1,k)*0.8<a name='998'>
             state1_q(1,k,l) = tmpmaer-qqcw(1,k,l)<a name='999'>
             <a name='1000'>
             n = modeptr_aitken   <font color=#447700>!Adding 9th constituent (# mixing ratio) <a name='1001'></font>
             tmpnaer = aitken_mode <font color=#447700>!0.0e6 -For ISDAC case ONLY<a name='1002'></font>
             l = numptr_amode(n)<a name='1003'>
             qqcw(1,k,l) = tmpnaer*alst(1,k)*0.8<a name='1004'>
             state1_q(1,k,l) = tmpnaer-qqcw(1,k,l)<a name='1005'>
             <a name='1006'>
             m = 1                <font color=#447700>!Adding 8th constituent (mass mixing ratio)<a name='1007'></font>
             tmpmaer = specdens_amode(lspectype_amode(m,n)) * tmpnaer / voltonumb_amode(n)<a name='1008'>
             l = lmassptr_amode(m,n)<a name='1009'>
             qqcw(1,k,l) = tmpmaer*alst(1,k)*0.8<a name='1010'>
             state1_q(1,k,l) = tmpmaer-qqcw(1,k,l)<a name='1011'>
             n = modeptr_coarse   <font color=#447700>!Adding 12th constituent (# mixing ratio) <a name='1012'></font>
             tmpnaer = coarse_mode <font color=#447700>!1.1e6 -For ISDAC case ONLY<a name='1013'></font>
             l = numptr_amode(n)<a name='1014'>
             qqcw(1,k,l) = tmpnaer*alst(1,k)*0.8<a name='1015'>
             state1_q(1,k,l) = tmpnaer-qqcw(1,k,l)<a name='1016'>
             <a name='1017'>
             tmpmaer = specdens_amode(lspectype_amode(m,n)) * tmpnaer / voltonumb_amode(n)<a name='1018'>
             m = 1                <font color=#447700>!Adding 10th constituent (mass mixing ratio)<a name='1019'></font>
             l = lmassptr_amode(m,n)<a name='1020'>
             qqcw(1,k,l) = tmpmaer*alst(1,k)*0.8*0.5<a name='1021'>
             state1_q(1,k,l) = tmpmaer*0.5-qqcw(1,k,l)<a name='1022'>
             <a name='1023'>
             m = 2                <font color=#447700>!Adding 11th constituent (mass mixing ratio)<a name='1024'></font>
             l = lmassptr_amode(m,n)<a name='1025'>
             qqcw(1,k,l) = tmpmaer*alst(1,k)*0.8*0.5<a name='1026'>
             state1_q(1,k,l) = tmpmaer*0.5-qqcw(1,k,l)<a name='1027'>
            enddo<a name='1028'>
          endif<a name='1029'>
          <a name='1030'>
#endif           <a name='1031'>
          <font color=#447700>!! calculate aerosol activation (naai for ice, npccn for liquid) and <a name='1032'></font>
          <font color=#447700>!! dust size (rndst) and number (nacon) for contact nucleation<a name='1033'></font>
          <a name='1034'>
          <font color=#447700>! Output from the following call:wsub, wsubi, naai, naai_hom, npccn, rndst,nacon <a name='1035'></font>
          <font color=#447700>! In-out from the following call: ptend_loc_q, qqcw<a name='1036'></font>
          <font color=#447700>!*NOTE*: Added QQCW as an output<a name='1037'></font>
          call <A href='../../html_code/phys/module_cam_mp_microp_aero.F.html#MICROP_AERO_TS'>microp_aero_ts</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROP_AERO_TS_1"> ( lchnk, ncol, dtime, state1_t, zeros,      &amp; <a name='1038'>
               state1_q(1,1,1), qc, qi,                                   &amp;<a name='1039'>
               nc, ni, state1_pmid, state1_pdel, ast,                     &amp;<a name='1040'>
               alst_mic, aist_mic,                                        &amp;<a name='1041'>
               cldo, state1_pint, state1_rpdel, state1_zm, state1_omega,  &amp;<a name='1042'>
#ifdef MODAL_AERO<a name='1043'>
               state1_q, cflx, ptend_loc_q, dgnumwet, dgnum,              &amp;<a name='1044'>
#else<a name='1045'>
               aer_mmr,                                                   &amp;<a name='1046'>
#endif<a name='1047'>
               kkvh, tke, turbtype, smaw, wsub, wsubi,                    &amp;<a name='1048'>
               naai,naai_hom, npccn, rndst,nacon,qqcw)<a name='1049'>
          <a name='1050'>
          <font color=#447700>!! Call MG Microphysics<a name='1051'></font>
          <a name='1052'>
          <a name='1053'>
          <font color=#447700>!Output from the following call:rate1cld,tlat,qvlat,qcten,qiten,<a name='1054'></font>
          <font color=#447700>!     ncten,niten,effc,effc_fn,effi,prect,preci,nevapr,evapsnow,<a name='1055'></font>
          <font color=#447700>!     prain,prodsnow,cmeice,dei,mu,lambdac,qsout,des,rflx,sflx,<a name='1056'></font>
          <font color=#447700>!     qrout,reff_rain,reff_snow,qcsevap,qisevap,qvres,cmeiout,<a name='1057'></font>
          <font color=#447700>!     vtrmc,vtrmi,qcsedten,qisedten,prao,prco,mnuccco,mnuccto,<a name='1058'></font>
          <font color=#447700>!     msacwio,psacwso,bergso,bergo,melto,homoo,qcreso,prcio,<a name='1059'></font>
          <font color=#447700>!     praio,qireso,mnuccro,pracso,meltsdt,frzrdt,mnuccdo	<a name='1060'></font>
          <a name='1061'>
          <font color=#447700>!in-out from the following call: qc,qi,nc,ni,cldo<a name='1062'></font>
          <font color=#447700>!*NOTE*: Added nsout and nrout as an ouput<a name='1063'></font>
          call <A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#MMICRO_PCOND'>mmicro_pcond</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MMICRO_PCOND_1">( sub_column, lchnk, ncol, dtime, state1_t,    &amp;<a name='1064'>
               state1_q(1,1,1), qc, qi,                                   &amp;<a name='1065'>
               nc, ni, state1_pmid, state1_pdel, ast,                     &amp;<a name='1066'>
               alst_mic, aist_mic,                                        &amp;<a name='1067'>
               cldo,                                                      &amp;<a name='1068'>
               rate1cld,                                                  &amp; <a name='1069'>
               naai, npccn, rndst,nacon,                                  &amp;<a name='1070'>
               tlat, qvlat,                                               &amp;<a name='1071'>
               qcten, qiten, ncten, niten, effc,                          &amp;<a name='1072'>
               effc_fn, effi, prect, preci,                               &amp; <a name='1073'>
               nevapr, evapsnow,                                          &amp;<a name='1074'>
               prain, prodsnow, cmeice, dei, mu,                          &amp;<a name='1075'>
               lambdac, qsout, des,                                       &amp;<a name='1076'>
               rflx,sflx, qrout,reff_rain,reff_snow,                      &amp;<a name='1077'>
               qcsevap, qisevap, qvres, cmeiout,                          &amp;<a name='1078'>
               vtrmc, vtrmi, qcsedten, qisedten,                          &amp;<a name='1079'>
               prao, prco, mnuccco, mnuccto, msacwio, psacwso,            &amp;<a name='1080'>
               bergso, bergo, melto, homoo, qcreso, prcio, praio, qireso, &amp;<a name='1081'>
               mnuccro, pracso, meltsdt, frzrdt , mnuccdo, nsout, nrout )<a name='1082'>
          <a name='1083'>
          do k=1,pver<a name='1084'>
             do i=1,ncol<a name='1085'>
                if (naai(i,k) .gt. 0._r8) then<a name='1086'>
                   mnuccdohet(i,k) = mnuccdo(i,k) - (naai_hom(i,k)/naai(i,k))*mnuccdo(i,k)<a name='1087'>
                else<a name='1088'>
                   mnuccdohet(i,k) = 0._r8<a name='1089'>
                end if<a name='1090'>
             end do<a name='1091'>
          end do<a name='1092'>
          <a name='1093'>
          mgflxprc(:ncol,:pverp) = rflx(:ncol,:pverp) + sflx(:ncol,:pverp)<a name='1094'>
          mgflxsnw(:ncol,:pverp) = sflx(:ncol,:pverp)<a name='1095'>
          <a name='1096'>
          mgmrprc(:ncol,:pver) = qrout(:ncol,:pver) + qsout(:ncol,:pver)<a name='1097'>
          mgmrsnw(:ncol,:pver) = qsout(:ncol,:pver)<a name='1098'>
          <a name='1099'>
          <a name='1100'>
          mgreffrain(:ncol,:pver) = reff_rain(:ncol,:pver)<a name='1101'>
          mgreffsnow(:ncol,:pver) = reff_snow(:ncol,:pver)<a name='1102'>
          <a name='1103'>
          <font color=#447700>!! calculate effective radius of convective liquid and ice using dcon and deicon (not used by code, not useful for COSP)<a name='1104'></font>
          cvreffliq(:ncol,:pver) = 9.0_r8  <font color=#447700>!! hard-coded as average of hard-coded values used for deep/shallow convective detrainment (near line 1502)<a name='1105'></font>
          cvreffice(:ncol,:pver) = 37.0_r8 <font color=#447700>!! hard-coded as average of hard-coded values used for deep/shallow convective detrainment (near line 1505)<a name='1106'></font>
          <a name='1107'>
          <font color=#447700>!! Reassign rate1 if modal aerosols<a name='1108'></font>
#ifdef MODAL_AERO<a name='1109'>
          rate1ord_cw2pr_st(1:ncol,1:pver)=rate1cld(1:ncol,1:pver)<a name='1110'>
#endif<a name='1111'>
          <font color=#447700>!! Sedimentation velocity for liquid stratus cloud droplet<a name='1112'></font>
          <a name='1113'>
          wsedl(:ncol,:pver) = vtrmc(:ncol,:pver)<a name='1114'>
          <a name='1115'>
          <font color=#447700>!! Nominal values for no microp_driver (convective only) cloud.<a name='1116'></font>
          <font color=#447700>!! Convert snow mixing ratio to microns<a name='1117'></font>
          <a name='1118'>
          do k = 1, pver<a name='1119'>
             do i = 1, ncol <a name='1120'>
                des(i,k) = des(i,k) * 1.e6_r8<a name='1121'>
                if( ast(i,k) .lt. 1.e-4_r8 ) then<a name='1122'>
                   mu(i,k) = mucon<a name='1123'>
                   lambdac(i,k) = (mucon + 1._r8)/dcon<a name='1124'>
                   dei(i,k) = deicon<a name='1125'>
                endif<a name='1126'>
             end do<a name='1127'>
          end do<a name='1128'>
          <a name='1129'>
          <font color=#447700>!! Net microp_driver condensation rate<a name='1130'></font>
          <font color=#447700>!*** IMPORTANT-WARNING ***: Following computation of QME will yeild WRONG answer as CMELIQ is set to zero<a name='1131'></font>
          qme(:ncol,:pver) = cmeliq(:ncol,:pver) + cmeiout(:ncol,:pver) <a name='1132'>
          <a name='1133'>
          <a name='1134'>
#ifndef MODAL_AERO<a name='1135'>
          deallocate(aer_mmr) <a name='1136'>
#endif<a name='1137'>
          <a name='1138'>
          do k = 1, pver<a name='1139'>
             do i = 1, ncol<a name='1140'>
                ptend_loc_s(i,k)          =  tlat(i,k)<a name='1141'>
                ptend_loc_q(i,k,1)        = qvlat(i,k)<a name='1142'>
                ptend_loc_q(i,k,ixcldliq) = qcten(i,k)<a name='1143'>
                ptend_loc_q(i,k,ixcldice) = qiten(i,k)<a name='1144'>
                ptend_loc_q(i,k,ixnumliq) = ncten(i,k)<a name='1145'>
                ptend_loc_q(i,k,ixnumice) = niten(i,k)<a name='1146'>
             enddo<a name='1147'>
          enddo<a name='1148'>
          <a name='1149'>
          <font color=#447700>!! For precip, accumulate only total precip in prec_pwc and snow_pwc variables.<a name='1150'></font>
          <font color=#447700>!! Other precip output varirables are set to 0<a name='1151'></font>
          prec_pcw(:ncol) = prect(:ncol)<a name='1152'>
          snow_pcw(:ncol) = preci(:ncol)<a name='1153'>
          prec_sed(:ncol) = 0._r8<a name='1154'>
          snow_sed(:ncol) = 0._r8<a name='1155'>
          prec_str(:ncol) = prec_pcw(:ncol) + prec_sed(:ncol) - rliq(:ncol)<a name='1156'>
          snow_str(:ncol) = snow_pcw(:ncol) + snow_sed(:ncol) <a name='1157'>
          <a name='1158'>
          <font color=#447700>!! ------------------------------- !<a name='1159'></font>
          <font color=#447700>!! Update microphysical tendencies !<a name='1160'></font>
          <font color=#447700>!! ------------------------------- !<a name='1161'></font>
          <a name='1162'>
          call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_SUM'>physics_ptend_sum</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_PTEND_SUM_1">(ptend_loc_ls,ptend_loc_lq,ptend_loc_s,ptend_loc_q,ptend_all_ls,ptend_all_lq,ptend_all_s,ptend_all_q,pcnst)<a name='1163'>
          ptend_all_name = 'cldwat'<a name='1164'>
          call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_UPDATE'>physics_update</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_UPDATE_2">( lchnk,dtime,state1_q,ptend_loc_q,state1_s,ptend_loc_s,ptend_loc_name,ptend_loc_lq,ptend_loc_ls,pcnst)<a name='1165'>
          call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_INIT'>physics_ptend_init</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_PTEND_INIT_4">( ptend_loc_name,ptend_loc_q,ptend_loc_s, ptend_loc_lq,ptend_loc_ls,pcnst)<a name='1166'>
          <a name='1167'>
          if( micro_treatment .eq. 'inter' ) then<a name='1168'>
             icecldf(:ncol,:pver) = ast(:ncol,:pver)<a name='1169'>
             liqcldf(:ncol,:pver) = ast(:ncol,:pver)<a name='1170'>
          elseif( micro_treatment .eq. 'compl' ) then<a name='1171'>
             icecldf(:ncol,:pver) = aist(:ncol,:pver)<a name='1172'>
             liqcldf(:ncol,:pver) = alst(:ncol,:pver)<a name='1173'>
          endif<a name='1174'>
          <a name='1175'>
          <font color=#447700>!! Effective droplet radius<a name='1176'></font>
          rel(:ncol,:pver)        = effc(:ncol,:pver)<a name='1177'>
          rel_fn(:ncol,:pver)     = effc_fn(:ncol,:pver)	<a name='1178'>
          rei(:ncol,:pver)        = effi(:ncol,:pver)<a name='1179'>
          rel2(:ncol,:pver)       = rel(:ncol,:pver) * 0.9071_r8 <font color=#447700>!! Convect to effective volume radius assuming pgam = 8<a name='1180'></font>
          rei2(:ncol,:pver)       = rei(:ncol,:pver) * 0.6057_r8 <font color=#447700>!! Convect to effective volume radius at pgam = 0 for ice <a name='1181'></font>
          <font color=#447700>!! ----------------------------------------------------------- ! <a name='1182'></font>
          <font color=#447700>!! Adjust in-cloud water values to take account of convective  !<a name='1183'></font>
          <font color=#447700>!! in-cloud water. It is used to calculate the values of       !<a name='1184'></font>
          <font color=#447700>!! icwlp and iciwp to pass to the radiation.                   ! <a name='1185'></font>
          <font color=#447700>!! ----------------------------------------------------------- !<a name='1186'></font>
          allcld_ice(:ncol,:pver) = 0._r8 <font color=#447700>!! Grid-avg all cloud liquid<a name='1187'></font>
          allcld_liq(:ncol,:pver) = 0._r8 <font color=#447700>!! Grid-avg all cloud ice<a name='1188'></font>
          if( conv_water_in_rad /= 0 ) then<a name='1189'>
             <font color=#447700>!Following formulation is obtained from macrop_driver.F90 of CAM<a name='1190'></font>
             call <A href='../../html_code/phys/module_cam_cldwat.F.html#CLDWAT_FICE'>cldwat_fice</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLDWAT_FICE_2">( ncol, state1_t, fice, fsnow )<a name='1191'>
<a name='1192'>
             <font color=#447700>!Balwinder.Singh@pnnl.gov: Changed the argument list to avoid pbuf<a name='1193'></font>
             call <A href='../../html_code/phys/module_cam_mp_conv_water.F.html#CONV_WATER_4RAD'>conv_water_4rad</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONV_WATER_4RAD_1">( lchnk, ncol, ast, sh_icwmr, dp_icwmr,       &amp;<a name='1194'>
                  fice, sh_frac, dp_frac, conv_water_in_rad, rei, state1_pdel, &amp;<a name='1195'>
                  state1_q(:,:,ixcldliq), state1_q(:,:,ixcldice),              &amp;<a name='1196'>
                  allcld_liq, allcld_ice )<a name='1197'>
          else<a name='1198'>
             allcld_liq(:ncol,:) = state1_q(:ncol,:,ixcldliq)  <font color=#447700>! Grid-ave all cloud liquid<a name='1199'></font>
             allcld_ice(:ncol,:) = state1_q(:ncol,:,ixcldice)  <font color=#447700>!           "        ice <a name='1200'></font>
          end if<a name='1201'>
          <font color=#447700>!! ------------------------------------------------------------ !<a name='1202'></font>
          <font color=#447700>!! Compute in cloud ice and liquid mixing ratios                !<a name='1203'></font>
          <font color=#447700>!! Note that 'iclwp, iciwp' are used for radiation computation. !<a name='1204'></font>
          <font color=#447700>!! ------------------------------------------------------------ !<a name='1205'></font>
          do k = 1, pver<a name='1206'>
             do i = 1, ncol<a name='1207'>
                <font color=#447700>!! Limits for in-cloud mixing ratios consistent with MG microphysics<a name='1208'></font>
                <font color=#447700>!! in-cloud mixing ratio 0.0001 to 0.005 kg/kg<a name='1209'></font>
                icimr(i,k)     = min( allcld_ice(i,k) / max(0.0001_r8,cld(i,k)),0.005_r8 )<a name='1210'>
                icwmr(i,k)     = min( allcld_liq(i,k) / max(0.0001_r8,cld(i,k)),0.005_r8 )<a name='1211'>
                icimrst(i,k)   = min( state1_q(i,k,ixcldice) / max(0.0001_r8,icecldf(i,k)),0.005_r8 )<a name='1212'>
                icwmrst(i,k)   = min( state1_q(i,k,ixcldliq) / max(0.0001_r8,liqcldf(i,k)),0.005_r8 )<a name='1213'>
                icinc(i,k)     = state1_q(i,k,ixnumice) / max(0.0001_r8,icecldf(i,k)) * state1_pmid(i,k) / (287.15_r8*state1_t(i,k))<a name='1214'>
                icwnc(i,k)     = state1_q(i,k,ixnumliq) / max(0.0001_r8,liqcldf(i,k)) * state1_pmid(i,k) / (287.15_r8*state1_t(i,k))<a name='1215'>
                iwc(i,k)       = allcld_ice(i,k) * state1_pmid(i,k) / (287.15_r8*state1_t(i,k))<a name='1216'>
                lwc(i,k)       = allcld_liq(i,k) * state1_pmid(i,k) / (287.15_r8*state1_t(i,k))<a name='1217'>
                effliq(i,k)    = effc(i,k)<a name='1218'>
                effliq_fn(i,k) = effc_fn(i,k)<a name='1219'>
                effice(i,k)    = effi(i,k)<a name='1220'>
                <font color=#447700>!! Calculate total cloud water paths in each layer<a name='1221'></font>
                iciwp(i,k)     = icimr(i,k) * state1_pdel(i,k) / gravit<a name='1222'>
                iclwp(i,k)     = icwmr(i,k) * state1_pdel(i,k) / gravit<a name='1223'>
                <font color=#447700>!! Calculate microp_driver cloud water paths in each layer<a name='1224'></font>
                <font color=#447700>!! Note: uses stratiform cloud fraction!<a name='1225'></font>
                iciwpst(i,k)   = min(state1_q(i,k,ixcldice)/max(0.0001_r8,ast(i,k)),0.005_r8) * state1_pdel(i,k) / gravit<a name='1226'>
                iclwpst(i,k)   = min(state1_q(i,k,ixcldliq)/max(0.0001_r8,ast(i,k)),0.005_r8) * state1_pdel(i,k) / gravit<a name='1227'>
                <font color=#447700>!! Calculate convective in-cloud LWP.<a name='1228'></font>
                <font color=#447700>!Commented the following two diagnostics as 'concld' is not mapped correctly with variables on WRF side<a name='1229'></font>
                <font color=#447700>!iclwpconv(i,k) = max(allcld_liq(i,k) - state_q(i,k,ixcldliq),0._r8)/max(0.0001_r8,concld(i,k)) <a name='1230'></font>
                <font color=#447700>!iciwpconv(i,k) = max(allcld_ice(i,k) - state_q(i,k,ixcldice),0._r8)/max(0.0001_r8,concld(i,k)) <a name='1231'></font>
                <font color=#447700>!! ------------------------------ !<a name='1232'></font>
                <font color=#447700>!! Adjust cloud fraction for snow !<a name='1233'></font>
                <font color=#447700>!! ------------------------------ !<a name='1234'></font>
                cldfsnow(i,k) = cld(i,k)<a name='1235'>
                <font color=#447700>!! If cloud and only ice ( no convective cloud or ice ), then set to 0.<a name='1236'></font>
                if( ( cldfsnow(i,k) .gt. 1.e-4_r8 ) .and. &amp; <a name='1237'>
                     ( concld(i,k)   .lt. 1.e-4_r8 ) .and. &amp; <a name='1238'>
                     ( state1_q(i,k,ixcldliq) .lt. 1.e-10_r8 ) ) then<a name='1239'>
                   <font color=#447700>!Commented the following diagnostics as 'concld' is not mapped correctly with variables on WRF side<a name='1240'></font>
                   <font color=#447700>!cldfsnow(i,k) = 0._r8<a name='1241'></font>
                endif<a name='1242'>
                <font color=#447700>!! If no cloud and snow, then set to 0.25<a name='1243'></font>
                if( ( cldfsnow(i,k) .lt. 1.e-4_r8 ) .and. ( qsout(i,k) .gt. 1.e-6_r8 ) ) then <a name='1244'>
                   <font color=#447700>!Commented the following diagnostics as 'concld' is not mapped correctly with variables on WRF side<a name='1245'></font>
                   <font color=#447700>!cldfsnow(i,k) = 0.25_r8<a name='1246'></font>
                endif<a name='1247'>
                <font color=#447700>!! Calculate in-cloud snow water path<a name='1248'></font>
                <font color=#447700>!Commented the following diagnostics as 'concld' is not mapped correctly with variables on WRF side<a name='1249'></font>
                <font color=#447700>!icswp(i,k) = qsout(i,k) / max( 0.0001_r8, cldfsnow(i,k) ) * state1_pdel(i,k) / gravit<a name='1250'></font>
             enddo<a name='1251'>
          enddo<a name='1252'>
          <a name='1253'>
          <font color=#447700>!! --------------------- !<a name='1254'></font>
          <font color=#447700>!! History Output Fields !<a name='1255'></font>
          <font color=#447700>!! --------------------- !<a name='1256'></font>
          <a name='1257'>
          <font color=#447700>!! Column droplet concentration<a name='1258'></font>
          <a name='1259'>
          do i = 1, ncol<a name='1260'>
             cdnumc(i) = 0._r8<a name='1261'>
             do k = 1, pver<a name='1262'>
                cdnumc(i) = cdnumc(i) + state1_q(i,k,ixnumliq)*state1_pdel(i,k)/gravit<a name='1263'>
             end do<a name='1264'>
          end do<a name='1265'>
          <a name='1266'>
          <font color=#447700>!! Averaging for new output fields<a name='1267'></font>
          <a name='1268'>
          efcout(:,:)      = 10._r8 <a name='1269'>
          efiout(:,:)      = 25._r8 <a name='1270'>
          ncout(:,:)       = 0._r8<a name='1271'>
          niout(:,:)       = 0._r8	<a name='1272'>
          freql(:,:)       = 0._r8<a name='1273'>
          freqi(:,:)       = 0._r8<a name='1274'>
          liqcldf_out(:,:) = 0._r8<a name='1275'>
          icecldf_out(:,:) = 0._r8<a name='1276'>
          icwmrst_out(:,:) = 0._r8<a name='1277'>
          icimrst_out(:,:) = 0._r8<a name='1278'>
          do k = 1, pver<a name='1279'>
             do i = 1, ncol<a name='1280'>
                if( liqcldf(i,k) .gt. 0.01_r8 .and. icwmrst(i,k) .gt. 5.e-5_r8 ) then<a name='1281'>
                   efcout(i,k) = effc(i,k)<a name='1282'>
                   ncout(i,k)  = icwnc(i,k)<a name='1283'>
                   freql(i,k)  = 1._r8<a name='1284'>
                   liqcldf_out(i,k) = liqcldf(i,k)<a name='1285'>
                   icwmrst_out(i,k) = icwmrst(i,k)<a name='1286'>
                endif<a name='1287'>
                if( icecldf(i,k) .gt. 0.01_r8 .and. icimrst(i,k) .gt. 1.e-6_r8 ) then<a name='1288'>
                   efiout(i,k) = effi(i,k)<a name='1289'>
                   niout(i,k)  = icinc(i,k)<a name='1290'>
                   freqi(i,k)  = 1._r8<a name='1291'>
                   icecldf_out(i,k) = icecldf(i,k)<a name='1292'>
                   icimrst_out(i,k) = icimrst(i,k)<a name='1293'>
                endif<a name='1294'>
             end do<a name='1295'>
          end do<a name='1296'>
          <a name='1297'>
          <font color=#447700>!! Cloud top effective radius and number.<a name='1298'></font>
          <a name='1299'>
          fcti(:)  = 0._r8<a name='1300'>
          fctl(:)  = 0._r8<a name='1301'>
          ctrel(:) = 0._r8<a name='1302'>
          ctrei(:) = 0._r8<a name='1303'>
          ctnl(:)  = 0._r8<a name='1304'>
          ctni(:)  = 0._r8<a name='1305'>
          do i = 1, ncol<a name='1306'>
             do k = 1, pver<a name='1307'>
                if( liqcldf(i,k) .gt. 0.01_r8 .and. icwmrst(i,k) .gt. 1.e-7_r8 ) then<a name='1308'>
                   ctrel(i) = effc(i,k)<a name='1309'>
                   ctnl(i)  = icwnc(i,k)<a name='1310'>
                   fctl(i)  = 1._r8<a name='1311'>
                   exit<a name='1312'>
                endif<a name='1313'>
                if( icecldf(i,k) .gt. 0.01_r8 .and. icimrst(i,k) .gt. 1.e-7_r8 ) then<a name='1314'>
                   ctrei(i) = effi(i,k)<a name='1315'>
                   ctni(i)  = icinc(i,k)<a name='1316'>
                   fcti(i)  = 1._r8<a name='1317'>
                   exit<a name='1318'>
                endif<a name='1319'>
             enddo<a name='1320'>
          enddo<a name='1321'>
          <a name='1322'>
          <font color=#447700>!Following update finally updates the state variables<a name='1323'></font>
          call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_UPDATE'>physics_update</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_UPDATE_3">( lchnk,dtime,state_q,ptend_all_q,state_s,ptend_all_s,ptend_all_name,ptend_all_lq,ptend_all_ls,pcnst)<a name='1324'>
          <a name='1325'>
          <font color=#447700>!Post processing of the output from CAMMGMP                    <a name='1326'></font>
          do kw=kts,kte<a name='1327'>
             <a name='1328'>
             kflip = kte-kw+1<a name='1329'>
             <font color=#447700>!Following equation are derived following UWPBL and CAMZM schemes<a name='1330'></font>
             qv_curr(iw,kw,jw)       = state_q(1,kflip,1) / (1.0_r8 - state_q(1,kflip,1)) <a name='1331'>
             multFrc                 = 1._r8 + qv_curr(iw,kw,jw)<a name='1332'>
             <a name='1333'>
             qc_curr(iw,kw,jw)       = state_q(1,kflip,2) * multFrc<a name='1334'>
             qi_curr(iw,kw,jw)       = state_q(1,kflip,3) * multFrc <a name='1335'>
             qs_curr(iw,kw,jw)       = qsout(1,kflip)     * multFrc <a name='1336'>
             qr_curr(iw,kw,jw)       = qrout(1,kflip)     * multFrc <a name='1337'>
             <a name='1338'>
             nc3d(iw,kw,jw)          = state_q(1,kflip,4) * multFrc <a name='1339'>
             qndrop(iw,kw,jw)        =  nc3d(iw,kw,jw)              <font color=#447700>!QNDROP is used in RRTMG radiation scheme<a name='1340'></font>
             ni3d(iw,kw,jw)          = state_q(1,kflip,5) * multFrc<a name='1341'>
             <font color=#447700>!nr3d ans ns3d are in the units of #/kg but nrout and nsout are in the units of #/m3. <a name='1342'></font>
             <font color=#447700>!Therefore these variables are multiplied by ALT (inverse density(m3/kg))<a name='1343'></font>
             ns3d(iw,kw,jw)          = nsout(1,kflip) * alt(iw,kw,jw) * multFrc  <a name='1344'>
             nr3d(iw,kw,jw)          = nrout(1,kflip) * alt(iw,kw,jw) * multFrc  <a name='1345'>
             <a name='1346'>
             th(iw,kw,jw)            = (state_s(1,kflip)-gravit*z_sea_level(iw,kw,jw))/(cpair*pi_phy(iw,kw,jw))<a name='1347'>
             wsedl3d(iw,kw,jw)       = wsedl(1,kflip)<a name='1348'>
             cldfra_old_mp(iw,kw,jw) = ast(1,kflip)<a name='1349'>
<a name='1350'>
             <font color=#447700>!Update RH - PMA<a name='1351'></font>
             ttt(1,kflip)     = (state_s(1,kflip)-gravit*z_sea_level(iw,kw,jw))/cpair<a name='1352'>
             esl(1,kflip)     = <A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_18">(ttt(1,kflip),0)<a name='1353'>
             qvs(1,kflip)     = max(1.e-30_r8,epsqs*esl(1,kflip)/(state_pmid(1,kflip)-(1._r8-epsqs)*esl(1,kflip)))<a name='1354'>
             rh_old_mp(iw,kw,jw)     = max(0._r8,state_q(1,kflip,1) / qvs(1,kflip))<a name='1355'>
             lcd_old_mp(iw,kw,jw)    = alst(1,kflip)<a name='1356'>
             lradius(iw,kw,jw)    = efcout(1,kflip)<a name='1357'>
             iradius(iw,kw,jw)    = efiout(1,kflip)<a name='1358'>
             <a name='1359'>
#if ( WRF_CHEM == 1 )<a name='1360'>
             if(chem_opt .NE. 0 .and. config_flags%CAM_MP_MAM_cpled ) then<a name='1361'>
                do l = p1st, num_chem<a name='1362'>
                   l2 = lptr_chem_to_q(l)<a name='1363'>
                   if ((l2 &gt;= 1) .and. (l2 &lt;= pcnst)) then<a name='1364'>
                      chem(iw,kw,jw,l) = state_q(1,kflip,l2)/factconv_chem_to_q(l)<a name='1365'>
                   end if<a name='1366'>
                   l2 = lptr_chem_to_qqcw(l)<a name='1367'>
                   if ((l2 &gt;= 1) .and. (l2 &lt;= pcnst)) then<a name='1368'>
                      chem(iw,kw,jw,l) = qqcw(1,kflip,l2)/factconv_chem_to_q(l)<a name='1369'>
                   end if<a name='1370'>
                end do <font color=#447700>! l<a name='1371'></font>
             endif<a name='1372'>
             <a name='1373'>
             qme3d(iw,kw,jw)               = qme(1,kflip)<a name='1374'>
             prain3d(iw,kw,jw)             = prain(1,kflip)<a name='1375'>
             nevapr3d(iw,kw,jw)            = nevapr(1,kflip)<a name='1376'>
             rate1ord_cw2pr_st3d(iw,kw,jw) = rate1ord_cw2pr_st(1,kflip)<a name='1377'>
#endif   <a name='1378'>
          end do<a name='1379'>
          <a name='1380'>
          <font color=#447700>! Precipitation(for each time step) is stored in RAINNCV variable of WRF. Following precipitation <a name='1381'></font>
          <font color=#447700>! calculation is taken from 'PRECL'variable of CAM. In 'cam_diagnostic.F90' file of CAM, PRECL is <a name='1382'></font>
          <font color=#447700>! computed as PRECL=PREC_SED+PREC_PCW.<a name='1383'></font>
          <font color=#447700>! PREC_PCW and PREC_SED are output from CAMMGMP (or stratiform.F90 in CAM). Here, we store PREC_SED+PREC_PCW<a name='1384'></font>
          <font color=#447700>! (i.e. PRECL) in RAINNCV variable of WRF. Units of PRECL are m/s. We convert it to mm (millimeter) <a name='1385'></font>
          <font color=#447700>! by multiplying it by 1.e3 and multiplying it by 'DT'<a name='1386'></font>
          <a name='1387'>
          rainncv(iw,jw) = (prec_sed(1) + prec_pcw(1))*dtime*1.0e3_r8 <font color=#447700>! in mm<a name='1388'></font>
          rainnc (iw,jw) = rainnc(iw,jw)+ rainncv(iw,jw)<a name='1389'>
<a name='1390'>
          <font color=#447700>!Similar to RAINNCV, SNOWNCV is computed following CAM's SNOWL variable in 'cam_diagnostic.F90'<a name='1391'></font>
          snowncv(iw,jw) = (snow_sed(1)  + snow_pcw(1))*dtime*1.0e3_r8 <font color=#447700>! in mm<a name='1392'></font>
          snownc (iw,jw) = snownc(iw,jw) + snowncv(iw,jw)<a name='1393'>
<a name='1394'>
          sr(iw,jw) = snowncv(iw,jw)/(rainncv(iw,jw) + 1.E-12_r8)<a name='1395'>
<a name='1396'>
        <a name='1397'>
       enddo <font color=#447700>!iw loop<a name='1398'></font>
    enddo <font color=#447700>!jw loop<a name='1399'></font>
  end subroutine CAMMGMP<a name='1400'>
<a name='1401'>
  <a name='1402'>
  <a name='1403'>
  <a name='1404'>
  <font color=#447700>!---------------------------------------------------------------------------------------------<a name='1405'></font>
<A NAME='PHYSICS_UPDATE'><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_UPDATE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1406'>
  <font color=#993300>subroutine </font><font color=#cc0000>physics_update</font>(state_lchnk,dt,state_q,ptend_q,state_s,ptend_s,ptend_name,ptend_lq,ptend_ls,pcnst_in) <A href='../../call_to/PHYSICS_UPDATE.html' TARGET='index'>7</A>,<A href='../../call_from/PHYSICS_UPDATE.html' TARGET='index'>6</A><a name='1407'>
  <font color=#447700>! This subroutine partially mimics CAM's subroutine by similar name in physics_type.F90 module<a name='1408'></font>
  <font color=#447700>! Please note that it is implimented just to serve the purpose of porting CAMMGMP scheme <a name='1409'></font>
  <font color=#447700>!<a name='1410'></font>
  <font color=#447700>!Author: Balwinder.Singh@pnl.gov<a name='1411'></font>
  <font color=#447700>!---------------------------------------------------------------------------------------------<a name='1412'></font>
<a name='1413'>
    implicit none<a name='1414'>
    integer , intent(in) :: state_lchnk, pcnst_in<a name='1415'>
    real(r8), intent(in) :: dt<a name='1416'>
    <a name='1417'>
    character*24, intent(inout) :: ptend_name    <a name='1418'>
    <a name='1419'>
    logical , intent(inout) :: ptend_ls<a name='1420'>
    logical , intent(inout) :: ptend_lq(pcnst_in)<a name='1421'>
    real(r8), intent(inout) :: ptend_s(pcols,pver)<a name='1422'>
    real(r8), intent(inout) :: ptend_q(pcols,pver,pcnst_in)<a name='1423'>
    <a name='1424'>
    real(r8), intent(inout) :: state_q(pcols,pver,pcnst_in)<a name='1425'>
    real(r8), intent(inout) :: state_s(pcols,pver)<a name='1426'>
    <a name='1427'>
    character*40            :: name    <font color=#447700>! param and tracer name for qneg3<a name='1428'></font>
    character(len=16)       :: microp_scheme<a name='1429'>
    integer                 :: m,i,k,ncol<a name='1430'>
    integer                 :: ixcldice, ixcldliq, ixnumice, ixnumliq<a name='1431'>
<a name='1432'>
<a name='1433'>
    microp_scheme   = 'MG' <a name='1434'>
    ptend_top_level = 1<a name='1435'>
    ptend_bot_level = pver<a name='1436'>
    ncol = pcols<a name='1437'>
<a name='1438'>
    <font color=#447700>! Update dry static energy<a name='1439'></font>
    if(ptend_ls) then<a name='1440'>
       do k = ptend_top_level, ptend_bot_level<a name='1441'>
          do i = 1, ncol<a name='1442'>
             state_s(i,k)   = state_s(i,k)   + ptend_s(i,k) * dt<a name='1443'>
          end do<a name='1444'>
       end do<a name='1445'>
    end if<a name='1446'>
<a name='1447'>
    <font color=#447700>! Update constituents, all schemes use time split q: no tendency kept<a name='1448'></font>
    call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_11">('CLDICE', ixcldice, abort=.false.)<a name='1449'>
    call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_12">('CLDLIQ', ixcldliq, abort=.false.)<a name='1450'>
    <font color=#447700>! Check for number concentration of cloud liquid and cloud ice (if not present<a name='1451'></font>
    <font color=#447700>! the indices will be set to -1)<a name='1452'></font>
    call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_13">('NUMICE', ixnumice, abort=.false.)<a name='1453'>
    call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_14">('NUMLIQ', ixnumliq, abort=.false.)<a name='1454'>
 <a name='1455'>
    do m = 1, pcnst_in<a name='1456'>
       if(ptend_lq(m)) then<a name='1457'>
          do k = ptend_top_level, ptend_bot_level<a name='1458'>
             do i = 1,ncol<a name='1459'>
                state_q(i,k,m) = state_q(i,k,m) + ptend_q(i,k,m) * dt<a name='1460'>
             end do<a name='1461'>
          end do<a name='1462'>
<a name='1463'>
          <font color=#447700>! now test for mixing ratios which are too small<a name='1464'></font>
          <font color=#447700>! don't call qneg3 for number concentration variables<a name='1465'></font>
          if (m .ne. ixnumice  .and.  m .ne. ixnumliq) then<a name='1466'>
             name = trim(ptend_name) // '/' // trim(cnst_name(m))<a name='1467'>
             call <A href='../../html_code/phys/module_cam_mp_qneg3.F.html#QNEG3'>qneg3</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QNEG3_1">(trim(name), state_lchnk, ncol, pcols, pver, m, m, qmin(m), state_q(1,1,m))<a name='1468'>
          else<a name='1469'>
             do k = ptend_top_level, ptend_bot_level<a name='1470'>
                do i = 1,ncol<a name='1471'>
                   <font color=#447700>! checks for number concentration<a name='1472'></font>
                   state_q(i,k,m) = max(1.e-12_r8,state_q(i,k,m))<a name='1473'>
                   state_q(i,k,m) = min(1.e10_r8,state_q(i,k,m))<a name='1474'>
                end do<a name='1475'>
             end do<a name='1476'>
          end if<a name='1477'>
<a name='1478'>
       end if<a name='1479'>
    end do<a name='1480'>
<a name='1481'>
    <font color=#447700>! special tests for cloud liquid<a name='1482'></font>
    if (ixcldliq &gt; 1) then<a name='1483'>
       if(ptend_lq(ixcldliq)) then<a name='1484'>
          if (ptend_name == 'stratiform' .or. ptend_name == 'cldwat'  ) then<a name='1485'>
<a name='1486'>
          else if (ptend_name == 'convect_deep') then<a name='1487'>
             where (state_q(:ncol,:pver,ixcldliq) &lt; 1.e-36_r8)<a name='1488'>
                state_q(:ncol,:pver,ixcldliq) = 0._r8<a name='1489'>
             end where<a name='1490'>
             <font color=#447700>! also zero out number concentration<a name='1491'></font>
             if ( microp_scheme .eq. 'MG' ) then<a name='1492'>
                where (state_q(:ncol,:pver,ixcldliq) &lt; 1.e-36_r8)<a name='1493'>
                   state_q(:ncol,:pver,ixnumliq) = 0._r8<a name='1494'>
                end where<a name='1495'>
             end if<a name='1496'>
          end if<a name='1497'>
       end if<a name='1498'>
    end if<a name='1499'>
<a name='1500'>
    <font color=#447700>! special tests for cloud ice<a name='1501'></font>
    if (ixcldice &gt; 1) then<a name='1502'>
       if(ptend_lq(ixcldice)) then<a name='1503'>
          if (ptend_name == 'stratiform' .or. ptend_name == 'cldwat'  ) then<a name='1504'>
<a name='1505'>
          else if (ptend_name == 'convect_deep') then<a name='1506'>
             where (state_q(:ncol,:pver,ixcldice) &lt; 1.e-36_r8)<a name='1507'>
                state_q(:ncol,:pver,ixcldice) = 0._r8<a name='1508'>
             end where<a name='1509'>
             <font color=#447700>! also zero out number concentration<a name='1510'></font>
             if ( microp_scheme .eq. 'MG' ) then<a name='1511'>
                where (state_q(:ncol,:pver,ixcldice) &lt; 1.e-36_r8)<a name='1512'>
                   state_q(:ncol,:pver,ixnumice) = 0._r8<a name='1513'>
                end where<a name='1514'>
             end if<a name='1515'>
          end if<a name='1516'>
       end if<a name='1517'>
    end if<a name='1518'>
<a name='1519'>
    <font color=#447700>! Derive new temperature and geopotential fields if heating or water tendency not 0.<a name='1520'></font>
    <font color=#447700>!if (ptend_ls .or. ptend_lq(1)) then<a name='1521'></font>
    <font color=#447700>!   call geopotential_dse(                                                                    &amp;<a name='1522'></font>
    <font color=#447700>!        state_lnpint, state_lnpmid, state_pint  , state_pmid  , state_pdel  , state_rpdel  , &amp;<a name='1523'></font>
    <font color=#447700>!        state_s     , state_q(1,1,1),state_phis , rair        , gravit      , cpair        , &amp;<a name='1524'></font>
    <font color=#447700>!        zvir        , state_t     , state_zi    , state_zm    , ncol         )<a name='1525'></font>
    <font color=#447700>!end if<a name='1526'></font>
<a name='1527'>
    <font color=#447700>! Reset all parameterization tendency flags to false<a name='1528'></font>
    call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_RESET'>physics_ptend_reset</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_PTEND_RESET_1">(ptend_name,ptend_q,ptend_s,ptend_lq,ptend_ls,pcnst_in)<a name='1529'>
    <a name='1530'>
  end subroutine physics_update<a name='1531'>
  <a name='1532'>
  <a name='1533'>
  <font color=#447700>!---------------------------------------------------------------------------------------------<a name='1534'></font>
<A NAME='PHYSICS_PTEND_INIT'><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1535'>
  <font color=#993300>subroutine </font><font color=#cc0000>physics_ptend_init</font>(ptend_name,ptend_q,ptend_s,ptend_lq,ptend_ls,pcnst_in) <A href='../../call_to/PHYSICS_PTEND_INIT.html' TARGET='index'>7</A>,<A href='../../call_from/PHYSICS_PTEND_INIT.html' TARGET='index'>1</A><a name='1536'>
  <font color=#447700>! This subroutine partially mimics CAM's subroutine by similar name in physics_type.F90 module<a name='1537'></font>
  <font color=#447700>! Please note that it is implimented just to serve the purpose of porting CAMMGMP scheme <a name='1538'></font>
  <font color=#447700>!Author: Balwinder.Singh@pnl.gov<a name='1539'></font>
  <font color=#447700>!---------------------------------------------------------------------------------------------<a name='1540'></font>
    implicit none<a name='1541'>
    integer, intent(in)    :: pcnst_in<a name='1542'>
<a name='1543'>
    character*24, intent(inout) :: ptend_name<a name='1544'>
<a name='1545'>
    logical , intent(inout):: ptend_ls <a name='1546'>
    logical , intent(inout):: ptend_lq(pcnst_in)<a name='1547'>
    real(r8), intent(inout):: ptend_s(pcols,pver)<a name='1548'>
    real(r8), intent(inout):: ptend_q(pcols,pver,pcnst_in)<a name='1549'>
    <a name='1550'>
    ptend_name  = "none"<a name='1551'>
    ptend_lq(:) = .TRUE.<a name='1552'>
    ptend_ls    = .TRUE.<a name='1553'>
    call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_RESET'>physics_ptend_reset</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_PTEND_RESET_2">(ptend_name,ptend_q,ptend_s,ptend_lq,ptend_ls,pcnst_in)<a name='1554'>
    return<a name='1555'>
  end subroutine physics_ptend_init<a name='1556'>
  <a name='1557'>
  <a name='1558'>
<font color=#447700>!---------------------------------------------------------------------------------------------<a name='1559'></font>
<A NAME='PHYSICS_PTEND_RESET'><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_RESET' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1560'>
  <font color=#993300>subroutine </font><font color=#cc0000>physics_ptend_reset</font>(ptend_name,ptend_q,ptend_s,ptend_lq,ptend_ls,pcnst_in) <A href='../../call_to/PHYSICS_PTEND_RESET.html' TARGET='index'>2</A><a name='1561'>
<font color=#447700>! This subroutine partially mimics CAM's subroutine by similar name in physics_type.F90 module<a name='1562'></font>
<font color=#447700>! Please note that it is implimented just to serve the purpose of porting CAMMGMP scheme <a name='1563'></font>
<font color=#447700>!Author: Balwinder.Singh@pnl.gov<a name='1564'></font>
<font color=#447700>!---------------------------------------------------------------------------------------------<a name='1565'></font>
    implicit none<a name='1566'>
    integer, intent(in)    :: pcnst_in<a name='1567'>
<a name='1568'>
    character*24, intent(inout) :: ptend_name<a name='1569'>
    <a name='1570'>
    logical , intent(inout):: ptend_ls <a name='1571'>
    logical , intent(inout):: ptend_lq(pcnst_in)<a name='1572'>
    real(r8), intent(inout):: ptend_s(pcols,pver)<a name='1573'>
    real(r8), intent(inout):: ptend_q(pcols,pver,pcnst_in)<a name='1574'>
    integer :: m<a name='1575'>
    <a name='1576'>
    if(ptend_ls) then<a name='1577'>
       ptend_s = 0._r8<a name='1578'>
    endif<a name='1579'>
    do m = 1, pcnst_in<a name='1580'>
       if(ptend_lq(m)) then<a name='1581'>
          ptend_q(:,:,m) = 0._r8<a name='1582'>
       endif<a name='1583'>
    end do<a name='1584'>
<a name='1585'>
    ptend_name  = "none"<a name='1586'>
    ptend_lq(:) = .FALSE.<a name='1587'>
    ptend_ls    = .FALSE.<a name='1588'>
<a name='1589'>
    ptend_top_level = 1<a name='1590'>
    ptend_bot_level = pver<a name='1591'>
<a name='1592'>
    return<a name='1593'>
  end subroutine physics_ptend_reset<a name='1594'>
  <a name='1595'>
<a name='1596'>
<font color=#447700>!---------------------------------------------------------------------------------------------<a name='1597'></font>
<A NAME='PHYSICS_PTEND_SUM'><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_SUM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1598'>
  <font color=#993300>subroutine </font><font color=#cc0000>physics_ptend_sum</font>(ptend_ls,ptend_lq,ptend_s,ptend_q,ptend_sum_ls,ptend_sum_lq,ptend_sum_s,ptend_sum_q, pcnst_in) <A href='../../call_to/PHYSICS_PTEND_SUM.html' TARGET='index'>4</A><a name='1599'>
<font color=#447700>! This subroutine partially mimics CAM's subroutine by similar name in physics_type.F90 module<a name='1600'></font>
<font color=#447700>! Please note that it is implimented just to serve the purpose of porting CAMMGMP scheme <a name='1601'></font>
<font color=#447700>!Author: Balwinder.Singh@pnl.gov<a name='1602'></font>
<font color=#447700>!---------------------------------------------------------------------------------------------<a name='1603'></font>
<a name='1604'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1605'></font>
<font color=#447700>! Add ptend fields to ptend_sum for ptend logical flags = .true.<a name='1606'></font>
<font color=#447700>! Where ptend logical flags = .false, don't change ptend_sum<a name='1607'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1608'></font>
<a name='1609'>
<font color=#447700>!------------------------------Arguments--------------------------------<a name='1610'></font>
    integer,  intent(in) :: pcnst_in<a name='1611'>
    logical,  intent(in) :: ptend_ls                  <font color=#447700>! New parameterization flag<a name='1612'></font>
    logical,  intent(in) :: ptend_lq(pcnst_in)           <font color=#447700>! New parameterization flag<a name='1613'></font>
    real(r8), intent(in) :: ptend_s(pcols,pver)       <font color=#447700>! New parameterization tendency<a name='1614'></font>
    real(r8), intent(in) :: ptend_q(pcols,pver,pcnst_in) <font color=#447700>! New parameterization tendency<a name='1615'></font>
    <a name='1616'>
    logical,  intent(inout) :: ptend_sum_ls                  <font color=#447700>! Flag for ptend_sum <a name='1617'></font>
    logical,  intent(inout) :: ptend_sum_lq(pcnst_in)           <font color=#447700>! Flag for ptend_sum <a name='1618'></font>
    real(r8), intent(inout) :: ptend_sum_s(pcols,pver)       <font color=#447700>! Sum of incoming ptend_sum and ptend<a name='1619'></font>
    real(r8), intent(inout) :: ptend_sum_q(pcols,pver,pcnst_in) <font color=#447700>! Sum of incoming ptend_sum and ptend<a name='1620'></font>
    <a name='1621'>
<a name='1622'>
<font color=#447700>!---------------------------Local storage-------------------------------<a name='1623'></font>
    integer :: k,m                              <font color=#447700>! constituent indices<a name='1624'></font>
    integer :: ncol,i<a name='1625'>
    <a name='1626'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1627'></font>
    ptend_top_level = 1<a name='1628'>
    ptend_bot_level = pver<a name='1629'>
<a name='1630'>
    ncol = pcols<a name='1631'>
    <a name='1632'>
    if(ptend_ls) then<a name='1633'>
       ptend_sum_ls = .true.<a name='1634'>
       do i = 1, ncol<a name='1635'>
          do k = ptend_top_level, ptend_bot_level<a name='1636'>
             ptend_sum_s(i,k) = ptend_sum_s(i,k) + ptend_s(i,k)<a name='1637'>
          end do<a name='1638'>
       end do<a name='1639'>
    end if<a name='1640'>
<a name='1641'>
<font color=#447700>! Update constituents<a name='1642'></font>
    do m = 1, pcnst_in<a name='1643'>
       if(ptend_lq(m)) then<a name='1644'>
          ptend_sum_lq(m) = .true.<a name='1645'>
          do i = 1,ncol<a name='1646'>
             do k = ptend_top_level, ptend_bot_level<a name='1647'>
                ptend_sum_q(i,k,m) = ptend_sum_q(i,k,m) + ptend_q(i,k,m)<a name='1648'>
             end do<a name='1649'>
          end do<a name='1650'>
       end if<a name='1651'>
    end do<a name='1652'>
<a name='1653'>
  end subroutine physics_ptend_sum<a name='1654'>
<a name='1655'>
<a name='1656'>
<font color=#447700>!---------------------------------------------------------------------------------------------<a name='1657'></font>
<A NAME='CAL_CLDFRA_MP_1D'><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAL_CLDFRA_MP_1D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1658'>
  <font color=#993300>subroutine </font><font color=#cc0000>cal_cldfra_mp_1d</font>(cldl,cldi,qqv, qqc, qqi,tt,pp,xland_pt,snowh_pt) <A href='../../call_to/CAL_CLDFRA_MP_1D.html' TARGET='index'>3</A>,<A href='../../call_from/CAL_CLDFRA_MP_1D.html' TARGET='index'>5</A><a name='1659'>
    <font color=#447700>!Author: Po-Lun Ma<a name='1660'></font>
    <font color=#447700>!Ported by: Balwinder Singh<a name='1661'></font>
<font color=#447700>!---------------------------------------------------------------------------------------------<a name='1662'></font>
<a name='1663'>
    use <A href='../../html_code/phys/module_cam_wv_saturation.F.html#WV_SATURATION'>wv_saturation</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAL_CLDFRA_MP_1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WV_SATURATION_15">,      only: epsqs, polysvp<a name='1664'>
    use <A href='../../html_code/phys/module_cam_shr_kind_mod.F.html#SHR_KIND_MOD'>shr_kind_mod</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAL_CLDFRA_MP_1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHR_KIND_MOD_30">,  only: r8=&gt;shr_kind_r8<a name='1665'>
    use <A href='../../html_code/phys/module_cam_physconst.F.html#PHYSCONST'>physconst</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAL_CLDFRA_MP_1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSCONST_21">,          only: tmelt<a name='1666'>
    <a name='1667'>
    real(r8), intent(in) :: qqv<a name='1668'>
    real(r8), intent(in) :: qqc<a name='1669'>
    real(r8), intent(in) :: qqi<a name='1670'>
    real(r8), intent(in) :: tt<a name='1671'>
    real(r8), intent(in) :: pp<a name='1672'>
    real(r8), intent(in) :: xland_pt<a name='1673'>
    real(r8), intent(in) :: snowh_pt<a name='1674'>
    real(r8), intent(inout) :: cldl,cldi<a name='1675'>
    REAL(r8):: rhl,dV,esl,omeps,cldrh,qvl<a name='1676'>
    real(r8):: cldcr,esi,qvi,rhi,rhdif,icimr,qv,qc,qi<a name='1677'>
    <a name='1678'>
    qv=max(qqv,0._r8)<a name='1679'>
    qc=max(qqc,0._r8)<a name='1680'>
    qi=max(qqi,0._r8)<a name='1681'>
    cldi= 0._r8<a name='1682'>
    cldl= 0._r8<a name='1683'>
    <a name='1684'>
    <a name='1685'>
    cldrh=1._r8<a name='1686'>
    <a name='1687'>
    if (pp &gt;= 70000._r8) then<a name='1688'>
       if (xland_pt &lt; 1.1_r8 .and. snowh_pt &lt; 0.001_r8) then    <font color=#447700>!xland_pt=1: land, snowh_pt&lt;1e-6m=1e-3kgm-2<a name='1689'></font>
          cldcr = 0.7875_r8<a name='1690'>
       else<a name='1691'>
          cldcr = 0.8875_r8<a name='1692'>
       endif<a name='1693'>
    elseif (pp &lt;= 40000._r8) then<a name='1694'>
       cldcr = 0.8_r8<a name='1695'>
    else<a name='1696'>
       cldcr = (0.8875_r8 - 0.8_r8)/30000._r8*(pp-40000._r8)+0.8_r8<a name='1697'>
    end if<a name='1698'>
    <a name='1699'>
    cldcr=min(max(0._r8,cldcr),1._r8)<a name='1700'>
    <a name='1701'>
    dV=cldrh-cldcr<a name='1702'>
    omeps = 1._r8 - 0.622_r8<a name='1703'>
    rhdif = 0._r8<a name='1704'>
    icimr = 0._r8<a name='1705'>
    <a name='1706'>
    esl  = <A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAL_CLDFRA_MP_1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_19">(tt,0)<a name='1707'>
    qvl  = max(1.e-12_r8,epsqs*esl/(pp-(1._r8-epsqs)*esl))<a name='1708'>
    rhl  = (qv+qc)/qvl<a name='1709'>
    rhl  = min(1.1_r8,max(0._r8,rhl))<a name='1710'>
    if( rhl .ge. 1._r8 ) then<a name='1711'>
       cldl  = 1._r8<a name='1712'>
    elseif( rhl .gt. (cldrh-dV/6._r8) .and. rhl .lt. 1._r8 ) then<a name='1713'>
       cldl  = 1._r8 - (-3._r8/sqrt(2._r8)*(rhl-cldrh)/dV)**(2._r8/3._r8)<a name='1714'>
    elseif( rhl .gt. (cldrh-dV) .and. rhl .le. (cldrh-dV/6._r8) ) then<a name='1715'>
       cldl  = 4._r8*(cos((1._r8/3._r8)*(acos((3._r8/2._r8/sqrt(2._r8))* &amp;<a name='1716'>
            (1._r8+(rhl-cldrh)/dV))-2._r8*3.14159_r8)))**2._r8<a name='1717'>
    elseif( rhl .le. (cldrh-dV) ) then<a name='1718'>
       cldl  = 0._r8<a name='1719'>
    endif<a name='1720'>
    <a name='1721'>
    esi  = <A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAL_CLDFRA_MP_1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_20">(tt,1)<a name='1722'>
    if (tt.gt.tmelt) esi=esl<a name='1723'>
    qvi  = max(1.e-12_r8,epsqs*esi/(pp-(1._r8-epsqs)*esi))<a name='1724'>
    rhi  = (qv+qi)/qvi<a name='1725'>
    rhi  = min(1.1_r8,max(0._r8,rhi))<a name='1726'>
    <a name='1727'>
    if (tt &lt; 273.15_r8) then<a name='1728'>
       rhdif = (rhi-0.8_r8) / 0.3_r8   <font color=#447700>! rhmaxi=1.1 - rhmini=0.8<a name='1729'></font>
       cldi  = min(1._r8, max(rhdif,0._r8)**2._r8)<a name='1730'>
       if (qi.lt.1.e-12_r8) then<a name='1731'>
          cldi=0._r8<a name='1732'>
       else<a name='1733'>
          cldi=max(1.e-4_r8,cldi)<a name='1734'>
       endif<a name='1735'>
       <a name='1736'>
       if (qi.ge.1.e-12_r8) then<a name='1737'>
          icimr=qi/(max(cldi,1.e-20_r8))<a name='1738'>
          if (icimr.lt.1.e-7_r8) then<a name='1739'>
             cldi = max(0._r8,min(1._r8,qi/1.e-7_r8))<a name='1740'>
          endif<a name='1741'>
          if (icimr.gt.5.e-3_r8) then<a name='1742'>
             cldi = max(0._r8,min(1._r8,qi/5.e-3_r8))<a name='1743'>
          endif<a name='1744'>
       endif<a name='1745'>
    endif<a name='1746'>
    <a name='1747'>
    cldl=min(max(0._r8,cldl),1._r8)<a name='1748'>
    cldi=min(max(0._r8,cldi),1._r8)<a name='1749'>
    <a name='1750'>
  end subroutine cal_cldfra_mp_1d<a name='1751'>
<a name='1752'>
<a name='1753'>
  <font color=#447700>!---------------------------------------------------------------------------------------------<a name='1754'></font>
<A NAME='MACROPHYSICS_SIMPLE'><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1755'>
  <font color=#993300>subroutine </font><font color=#cc0000>Macrophysics_simple</font>(is_first_step, pcnst, pcols, kte, ixcldliq, ixnumliq, &amp; <A href='../../call_to/MACROPHYSICS_SIMPLE.html' TARGET='index'>1</A>,<A href='../../call_from/MACROPHYSICS_SIMPLE.html' TARGET='index'>20</A><a name='1756'>
       lchnk, dtime, state1_t, state_pmid, state_q, dp_icwmr, sh_icwmr, dp_frac,    &amp;<a name='1757'>
       sh_frac, ast,aist,alst,qi_mac,xland_pt,snowh_pt,                             &amp;<a name='1758'>
       <font color=#447700>!intent-inout<a name='1759'></font>
       state1_s, state1_q, rh_old, cldo, esl, qvs, ptend_loc_name, ptend_loc_ls,    &amp;<a name='1760'>
       ptend_loc_lq, ptend_loc_s,ptend_loc_q, ptend_all_name, ptend_all_ls,         &amp;<a name='1761'>
       ptend_all_lq,ptend_all_s,ptend_all_q )<a name='1762'>
<a name='1763'>
    <font color=#447700>! This subroutine implements macrophysical processes<a name='1764'></font>
    <font color=#447700>! <a name='1765'></font>
    <font color=#447700>! Author: Po-Lun Ma<a name='1766'></font>
    <font color=#447700>! Ported by Balwinder Singh    <a name='1767'></font>
    <font color=#447700>!-------------------------------------------------------------------------------------------<a name='1768'></font>
<a name='1769'>
    <font color=#447700>!PMA<a name='1770'></font>
    <font color=#447700>!-------------------------------------------------------------------------------------------<a name='1771'></font>
    <font color=#447700>!This simple scheme does the followings:<a name='1772'></font>
    <font color=#447700>!(1) QC detrained from convections are converted to (a) cloud water and (b) cloud ice in the<a name='1773'></font>
    <font color=#447700>!    cloudy part; and (c) vapor in the cloud-free part then latent heating from the phase <a name='1774'></font>
    <font color=#447700>!    change<a name='1775'></font>
    <font color=#447700>!(2) RH change, then apportion the change of Qv to cloudy part and cloud-free part, then <a name='1776'></font>
    <font color=#447700>!    latent heating from phase change<a name='1777'></font>
    <font color=#447700>!!(3) If a grid is super-saturated, condense to Qc and update latent heating<a name='1778'></font>
    <font color=#447700>!(4) Brutal positive moisture fixer<a name='1779'></font>
    <font color=#447700>!<a name='1780'></font>
    <font color=#447700>!The idea is to take the essential formulations from Macrophysics in CAM5, but simplify the <a name='1781'></font>
    <font color=#447700>!computation. When the full CAM5 macrophysics is implemented, this scheme should be removed<a name='1782'></font>
    <font color=#447700>!Cloud fraction calculation is in this module<a name='1783'></font>
    <font color=#447700>!-------------------------------------------------------------------------------------------<a name='1784'></font>
<a name='1785'>
    use <A href='../../html_code/phys/module_cam_wv_saturation.F.html#WV_SATURATION'>wv_saturation</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WV_SATURATION_16">, only: epsqs, polysvp<a name='1786'>
    use <A href='../../html_code/phys/module_cam_physconst.F.html#PHYSCONST'>physconst</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSCONST_22">,     only: latvap,cpair <a name='1787'>
<a name='1788'>
    <font color=#447700>!Subroutine arguments<a name='1789'></font>
<a name='1790'>
    <font color=#447700>!Intent -ins<a name='1791'></font>
    logical,  intent(in) :: is_first_step<a name='1792'>
    integer,  intent(in) :: pcnst, pcols, kte, ixcldliq, ixnumliq, lchnk<a name='1793'>
    real(r8), intent(in) :: dtime,xland_pt,snowh_pt<a name='1794'>
<a name='1795'>
    real(r8), dimension(pcols,kte), intent(in) :: state_pmid<a name='1796'>
    real(r8), dimension(pcols,kte), intent(in) :: dp_icwmr<a name='1797'>
    real(r8), dimension(pcols,kte), intent(in) :: sh_icwmr<a name='1798'>
    real(r8), dimension(pcols,kte), intent(in) :: dp_frac<a name='1799'>
    real(r8), dimension(pcols,kte), intent(in) :: sh_frac<a name='1800'>
    real(r8), dimension(pcols,kte), intent(in) :: qi_mac<a name='1801'>
<a name='1802'>
    real(r8), dimension(pcols,kte,pcnst), intent(in) :: state_q<a name='1803'>
<a name='1804'>
    <font color=#447700>!Intents-inouts<a name='1805'></font>
    character*24, intent(inout) :: ptend_loc_name, ptend_all_name  <a name='1806'>
<a name='1807'>
    logical, intent(inout) :: ptend_loc_ls, ptend_all_ls    <font color=#447700>!Flag for updating tendencies<a name='1808'></font>
    logical, dimension(pcnst),intent(inout) :: ptend_loc_lq <font color=#447700>!Flag for updating tendencies<a name='1809'></font>
    logical, dimension(pcnst),intent(inout) :: ptend_all_lq <font color=#447700>!Flag for updating tendencies<a name='1810'></font>
<a name='1811'>
    real(r8), dimension(pcols,kte),intent(inout) :: ptend_loc_s<a name='1812'>
    real(r8), dimension(pcols,kte),intent(inout) :: ptend_all_s<a name='1813'>
    real(r8), dimension(pcols,kte),intent(inout) :: rh_old  <font color=#447700>! RH at previous timestep (PMA)<a name='1814'></font>
    real(r8), dimension(pcols,kte),intent(inout) :: ast<a name='1815'>
    real(r8), dimension(pcols,kte),intent(inout) :: alst<a name='1816'>
    real(r8), dimension(pcols,kte),intent(inout) :: aist<a name='1817'>
    real(r8), dimension(pcols,kte),intent(inout) :: cldo    <font color=#447700>! Old cloud fraction<a name='1818'></font>
    real(r8), dimension(pcols,kte),intent(inout) :: esl     <font color=#447700>! liquid sat vapor pressure (pa) ! for phil suggested modifications<a name='1819'></font>
    real(r8), dimension(pcols,kte),intent(inout) :: qvs     <font color=#447700>! liquid saturation vapor mixing ratio ! for phil suggested modifications<a name='1820'></font>
    real(r8), dimension(pcols,kte),intent(inout) :: state1_s<a name='1821'>
    real(r8), dimension(pcols,kte),intent(inout) :: state1_t<a name='1822'>
<a name='1823'>
    real(r8), dimension(pcols,kte,pcnst), intent(inout) :: ptend_loc_q<a name='1824'>
    real(r8), dimension(pcols,kte,pcnst), intent(inout) :: ptend_all_q<a name='1825'>
    real(r8), dimension(pcols,kte,pcnst), intent(inout) :: state1_q<a name='1826'>
<a name='1827'>
<a name='1828'>
    <font color=#447700>!Local workspace<a name='1829'></font>
    integer  :: k<a name='1830'>
    real(r8), dimension(pcols,kte) :: cv_frac     <font color=#447700>! Total convective cloud fraction (PMA)<a name='1831'></font>
    real(r8), dimension(pcols,kte) :: st_frac     <font color=#447700>! Total stratiform cloud fraction (PMA)<a name='1832'></font>
    real(r8), dimension(pcols,kte) :: ttt         <font color=#447700>! Temperature (PMA)<a name='1833'></font>
    real(r8), dimension(pcols,kte) :: rh_curr     <font color=#447700>! RH at current  timestep (PMA)<a name='1834'></font>
    real(r8), dimension(pcols,kte) :: del_rh      <font color=#447700>! RH difference between 2 timesteps (PMA)<a name='1835'></font>
    real(r8), dimension(pcols,kte) :: qc_nc       <font color=#447700>! non-convective LWC (PMA)<a name='1836'></font>
    real(r8), dimension(pcols,kte) :: del_qq      <font color=#447700>! Qv difference between 2 timesteps (PMA)<a name='1837'></font>
    real(r8), dimension(pcols,kte) :: del_cf      <font color=#447700>! Qv difference between 2 timesteps (PMA)<a name='1838'></font>
    real(r8), dimension(pcols,kte) :: rh_temp     <font color=#447700>!<a name='1839'></font>
<a name='1840'>
    real(r8), dimension(pcols) :: qsll        <font color=#447700>!<a name='1841'></font>
    real(r8), dimension(pcols) :: tsp         <font color=#447700>!<a name='1842'></font>
    real(r8) :: cldcr<a name='1843'>
    real(r8) :: factcc,fact_adj<a name='1844'>
<a name='1845'>
<a name='1846'>
    character*250 :: wrfmessage<a name='1847'>
<a name='1848'>
   <a name='1849'>
    <font color=#447700>!<a name='1850'></font>
    <font color=#447700>!restore flags to true<a name='1851'></font>
    <font color=#447700>!<a name='1852'></font>
<a name='1853'>
    ptend_loc_name         = 'Macro1'<a name='1854'>
    ptend_loc_ls           = .true.<a name='1855'>
    ptend_loc_lq(1)        = .true.<a name='1856'>
    ptend_loc_lq(ixcldliq) = .true.<a name='1857'>
    ptend_loc_lq(ixnumliq) = .true.<a name='1858'>
<a name='1859'>
    factcc   = 0.1_r8<a name='1860'>
    fact_adj = 0.35_r8<a name='1861'>
    cldcr    = 0.8875_r8 <a name='1862'>
    <font color=#447700>!<a name='1863'></font>
    <font color=#447700>!Simple computation for condensation/evaporation <a name='1864'></font>
    <font color=#447700>!<a name='1865'></font>
    do k=1,pver<a name='1866'>
      if (state_pmid(1,k) &gt;= 70000._r8) then<a name='1867'>
         if (xland_pt &lt; 1.1_r8 .and. snowh_pt &lt; 0.001_r8) then    <font color=#447700>!xland_pt=1: land, snowh_pt&lt;1e-6m=1e-3kgm-2<a name='1868'></font>
          cldcr = 0.7875_r8<a name='1869'>
         else<a name='1870'>
          cldcr = 0.8875_r8<a name='1871'>
         endif<a name='1872'>
      elseif (state_pmid(1,k)&lt;= 40000._r8) then<a name='1873'>
        cldcr = 0.8_r8<a name='1874'>
      else   <a name='1875'>
        cldcr = (0.8875_r8 - 0.8_r8)/30000._r8*(state_pmid(1,k)-40000._r8)+0.8_r8<a name='1876'>
      end if <a name='1877'>
<a name='1878'>
       cldcr=min(max(0._r8,cldcr),1._r8)<a name='1879'>
<a name='1880'>
       call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAL_CLDFRA_MP_1D'>cal_cldfra_mp_1d</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_CLDFRA_MP_1D_1">(alst(1,k),aist(1,k),state1_q(1,k,1), state1_q(1,k,ixcldliq), qi_mac(1,k),state1_t(1,k),state_pmid(1,k),xland_pt,snowh_pt)<a name='1881'>
       qsll         = 0._r8<a name='1882'>
       tsp          = 0._r8<a name='1883'>
       del_qq(1,k)  = 0._r8<a name='1884'>
       rh_temp(1,k) = 0._r8<a name='1885'>
       cv_frac(1,k) = max(0._r8,min(0.8_r8,dp_frac(1,k)+sh_frac(1,k)))<a name='1886'>
       alst(1,k)    = (1._r8-cv_frac(1,k))*alst(1,k)<a name='1887'>
       aist(1,k)    = (1._r8-cv_frac(1,k))*aist(1,k)<a name='1888'>
       ast(1,k)     = max(alst(1,k),aist(1,k))<a name='1889'>
       st_frac(1,k) = min(1._r8,ast(1,k)+cv_frac(1,k))<a name='1890'>
       esl(1,k)     = <A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_21">(state1_t(1,k),0)<a name='1891'>
       qvs(1,k)     = max(1.e-30_r8,epsqs*esl(1,k)/(state_pmid(1,k)-(1._r8-epsqs)*esl(1,k)))<a name='1892'>
       rh_curr(1,k) = max(0._r8,state1_q(1,k,1) / qvs(1,k))<a name='1893'>
       qc_nc(1,k)   = state1_q(1,k,ixcldliq)<a name='1894'>
             <a name='1895'>
       if( is_first_step ) then<a name='1896'>
          rh_old(1,k) = rh_curr(1,k)<a name='1897'>
          cldo(1,k)   = min(1._r8,ast(1,k)+cv_frac(1,k))<a name='1898'>
       endif<a name='1899'>
       <a name='1900'>
       <font color=#447700>!<a name='1901'></font>
       <font color=#447700>!if super-saturate, condense delta RH<a name='1902'></font>
       <font color=#447700>!<a name='1903'></font>
       <a name='1904'>
       if (rh_curr(1,k) &gt; 1._r8) then<a name='1905'>
          call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#FINDSP_WATER'>findsp_water</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FINDSP_WATER_1">(lchnk,pcols,state1_q(1,k,1),state1_t(1,k),state_pmid(1,k),tsp,qsll)<a name='1906'>
          del_qq(1,k)               = min(3.e-3_r8,max(0._r8,(state1_q(1,k,1)-qsll(1))*0.999_r8))  <a name='1907'>
          ptend_loc_q(1,k,ixcldliq) =  del_qq(1,k) /dtime<a name='1908'>
          ptend_loc_s(1,k)          =  del_qq(1,k) * latvap/dtime <font color=#447700>!condensational heating<a name='1909'></font>
          ptend_loc_q(1,k,1)        = -del_qq(1,k)/dtime<a name='1910'>
<a name='1911'>
          <font color=#447700>!<a name='1912'></font>
          <font color=#447700>!if not super-saturate, compare RH diff between two timesteps,<a name='1913'></font>
          <font color=#447700>!then condense/evaporate the cloudy part<a name='1914'></font>
          <font color=#447700>!<a name='1915'></font>
       else if (rh_curr(1,k) &gt; cldcr .and. rh_curr(1,k) &lt;= 1._r8 ) then<a name='1916'>
          del_cf(1,k) = st_frac(1,k)-cldo(1,k)  <a name='1917'>
          if( del_cf(1,k) &lt; 0._r8 ) then<a name='1918'>
             del_qq(1,k)               = qc_nc(1,k)*del_cf(1,k)/cldo(1,k)*factcc<a name='1919'>
             ptend_loc_q(1,k,ixcldliq) = del_qq(1,k)  /dtime<a name='1920'>
             ptend_loc_s(1,k)          = del_qq(1,k)  * latvap/dtime <font color=#447700>!evaporative cooling<a name='1921'></font>
             ptend_loc_q(1,k,1)        = -del_qq(1,k) /dtime<a name='1922'>
             ptend_loc_q(1,k,ixnumliq) = ptend_loc_q(1,k,ixcldliq)*state1_q(1,k,ixnumliq)/max(1.e-30_r8,state1_q(1,k,ixcldliq))<a name='1923'>
             ptend_loc_q(1,k,ixnumliq) = min(0._r8,max(ptend_loc_q(1,k,ixnumliq),-state1_q(1,k,ixnumliq)/dtime))<a name='1924'>
          else if( del_cf(1,k) &gt; 0._r8 .and. cldo(1,k) &gt; 1.e-8_r8) then<a name='1925'>
             del_qq(1,k)               = min(state1_q(1,k,1)*0.1_r8,min(3.e-3_r8*st_frac(1,k),qc_nc(1,k)*del_cf(1,k)/cldo(1,k)))*factcc<a name='1926'>
             ptend_loc_q(1,k,ixcldliq) = del_qq(1,k)  /dtime<a name='1927'>
             ptend_loc_s(1,k)          = del_qq(1,k)  * latvap/dtime <font color=#447700>!condensational heating <a name='1928'></font>
             ptend_loc_q(1,k,1)        = -del_qq(1,k) /dtime<a name='1929'>
             ptend_loc_q(1,k,ixnumliq) = 0._r8<a name='1930'>
          else if( del_cf(1,k) &gt; 0._r8 .and. cldo(1,k) &lt; 1.e-8_r8) then<a name='1931'>
             del_qq(1,k)               = min(state1_q(1,k,1)*0.1_r8,2.e-5_r8*st_frac(1,k))*factcc<a name='1932'>
             ptend_loc_q(1,k,ixcldliq) = del_qq(1,k)  /dtime<a name='1933'>
             ptend_loc_s(1,k)          = del_qq(1,k)  * latvap/dtime <font color=#447700>!condensational heating <a name='1934'></font>
             ptend_loc_q(1,k,1)        = -del_qq(1,k) /dtime<a name='1935'>
             ptend_loc_q(1,k,ixnumliq) = 0._r8<a name='1936'>
          else<a name='1937'>
             del_qq(1,k)               = 0._r8<a name='1938'>
             ptend_loc_q(1,k,ixcldliq) = 0._r8<a name='1939'>
             ptend_loc_s(1,k)          = 0._r8<a name='1940'>
             ptend_loc_q(1,k,1)        = 0._r8<a name='1941'>
             ptend_loc_q(1,k,ixnumliq) = 0._r8<a name='1942'>
          end if<a name='1943'>
       else if (rh_curr(1,k) &lt; cldcr  .and. cldo(1,k) &lt;1.e-2_r8 .and. qc_nc(1,k) &gt;1.e-12_r8) then <font color=#447700>!RH&lt;cldcr, evaporate qc<a name='1944'></font>
          call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#FINDSP_WATER'>findsp_water</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FINDSP_WATER_2">(lchnk,pcols,state1_q(1,k,1),state1_t(1,k),state_pmid(1,k),tsp,qsll)                      <a name='1945'>
             del_qq(1,k)= max(min(qc_nc(1,k), (qsll(1)-state1_q(1,k,1))),0._r8)*0.99_r8<a name='1946'>
             ptend_loc_q(1,k,ixcldliq) = -del_qq(1,k) /dtime<a name='1947'>
             ptend_loc_s(1,k)          = -del_qq(1,k) * latvap/dtime <font color=#447700>!evaporative cooling<a name='1948'></font>
             ptend_loc_q(1,k,1)        =  del_qq(1,k)/dtime<a name='1949'>
             ptend_loc_q(1,k,ixnumliq) = ptend_loc_q(1,k,ixcldliq)*state1_q(1,k,ixnumliq)/max(1.e-30_r8,state1_q(1,k,ixcldliq))<a name='1950'>
             ptend_loc_q(1,k,ixnumliq) = min(0._r8,max(ptend_loc_q(1,k,ixnumliq),-state1_q(1,k,ixnumliq)/dtime))<a name='1951'>
       else if (rh_curr(1,k) &lt; cldcr  .and. cldo(1,k) &gt;=1.e-2_r8 .and. qc_nc(1,k) &gt;1.e-12_r8) then <font color=#447700>!RH&lt;cldcr, evaporate qc<a name='1952'></font>
          call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#FINDSP_WATER'>findsp_water</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FINDSP_WATER_3">(lchnk,pcols,state1_q(1,k,1),state1_t(1,k),state_pmid(1,k),tsp,qsll)<a name='1953'>
             del_qq(1,k)= max(min(qc_nc(1,k), qsll(1)-state1_q(1,k,1)),0._r8)*factcc<a name='1954'>
             ptend_loc_q(1,k,ixcldliq) = -del_qq(1,k) /dtime<a name='1955'>
             ptend_loc_s(1,k)          = -del_qq(1,k) * latvap/dtime <font color=#447700>!evaporative cooling<a name='1956'></font>
             ptend_loc_q(1,k,1)        =  del_qq(1,k)/dtime<a name='1957'>
             ptend_loc_q(1,k,ixnumliq) = ptend_loc_q(1,k,ixcldliq)*state1_q(1,k,ixnumliq)/max(1.e-30_r8,state1_q(1,k,ixcldliq))<a name='1958'>
<font color=#447700>!             ptend_loc_q(1,k,ixnumliq) = ptend_loc_q(1,k,ixcldliq)*state1_q(1,k,ixnumliq)/max(1.e-30_r8,qc_nc(1,k))<a name='1959'></font>
             ptend_loc_q(1,k,ixnumliq) = min(0._r8,max(ptend_loc_q(1,k,ixnumliq),-state1_q(1,k,ixnumliq)/dtime))<a name='1960'>
       else<a name='1961'>
             ptend_loc_q(1,k,ixcldliq) = 0._r8<a name='1962'>
             ptend_loc_s(1,k)          = 0._r8<a name='1963'>
             ptend_loc_q(1,k,1)        = 0._r8<a name='1964'>
             ptend_loc_q(1,k,ixnumliq) = 0._r8<a name='1965'>
       end if<a name='1966'>
       state1_t(1,k)=state1_t(1,k)+ptend_loc_s(1,k)*dtime/cpair<a name='1967'>
    end do  <font color=#447700>!k loop<a name='1968'></font>
    <a name='1969'>
    <font color=#447700>!<a name='1970'></font>
    <font color=#447700>!Update state1 variables and tendencies <a name='1971'></font>
    <font color=#447700>!<a name='1972'></font>
    <a name='1973'>
    call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_SUM'>physics_ptend_sum</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_PTEND_SUM_2">(ptend_loc_ls,ptend_loc_lq,ptend_loc_s,ptend_loc_q,ptend_all_ls,ptend_all_lq,ptend_all_s,ptend_all_q,pcnst)<a name='1974'>
    ptend_all_name = 'cldwat'<a name='1975'>
    call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_UPDATE'>physics_update</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_UPDATE_4">( lchnk,dtime,state1_q,ptend_loc_q,state1_s,ptend_loc_s,ptend_loc_name,ptend_loc_lq,ptend_loc_ls,pcnst)<a name='1976'>
    call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_INIT'>physics_ptend_init</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_PTEND_INIT_5">( ptend_loc_name,ptend_loc_q,ptend_loc_s, ptend_loc_lq,ptend_loc_ls,pcnst)<a name='1977'>
<a name='1978'>
    <font color=#447700>!<a name='1979'></font>
    <font color=#447700>!restore flags to true<a name='1980'></font>
    <font color=#447700>!<a name='1981'></font>
    ptend_loc_name         = 'Macro2'<a name='1982'>
    ptend_loc_ls           = .true.<a name='1983'>
    ptend_loc_lq(1)        = .true.<a name='1984'>
    ptend_loc_lq(ixcldliq) = .true.<a name='1985'>
    ptend_loc_lq(ixnumliq) = .true.<a name='1986'>
    <a name='1987'>
    <font color=#447700>!<a name='1988'></font>
    <font color=#447700>!Some limiters<a name='1989'></font>
    <font color=#447700>!<a name='1990'></font>
    <a name='1991'>
    do k = 1 , pver<a name='1992'>
       del_qq(1,k)=0._r8<a name='1993'>
       call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAL_CLDFRA_MP_1D'>cal_cldfra_mp_1d</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_CLDFRA_MP_1D_2">(alst(1,k),aist(1,k),state1_q(1,k,1), state1_q(1,k,ixcldliq), qi_mac(1,k),state1_t(1,k),state_pmid(1,k),xland_pt,snowh_pt)<a name='1994'>
       alst(1,k) = (1._r8-cv_frac(1,k))*alst(1,k)<a name='1995'>
       aist(1,k) = (1._r8-cv_frac(1,k))*aist(1,k)<a name='1996'>
       ast(1,k)  = max(alst(1,k),aist(1,k))<a name='1997'>
       st_frac(1,k) = alst(1,k)<a name='1998'>
<a name='1999'>
       qc_nc(1,k) = max(0._r8, state1_q(1,k,ixcldliq) - &amp;<a name='2000'>
            max(0._r8,(dp_frac(1,k)*dp_icwmr(1,k) +sh_frac(1,k)*sh_icwmr(1,k))))<a name='2001'>
       <font color=#447700>!<a name='2002'></font>
       <font color=#447700>!Case 1: unrealistic cloud: evaporate qc under no cldfra <a name='2003'></font>
       <font color=#447700>!<a name='2004'></font>
       <font color=#447700>! THIS SHOULD NO LONGER HAPPEN<a name='2005'></font>
       <font color=#447700>!<a name='2006'></font>
       <font color=#447700>!       if (st_frac(1,k) &lt; 1.e-8_r8 ) then<a name='2007'></font>
       <font color=#447700>!          if ( qc_nc(1,k) &gt; 0._r8 ) then<a name='2008'></font>
       <font color=#447700>!           ptend_loc_q(1,k,ixcldliq) = -(qc_nc(1,k))/dtime*0.99_r8<a name='2009'></font>
       <font color=#447700>!           ptend_loc_q(1,k,1)= qc_nc(1,k)/dtime*0.99_r8<a name='2010'></font>
       <font color=#447700>!           ptend_loc_s(1,k)  =-(qc_nc(1,k)) * latvap /dtime*0.99_r8  !evaporative cooling<a name='2011'></font>
       <font color=#447700>!           ptend_loc_q(1,k,ixnumliq) = -state1_q(1,k,ixnumliq)/dtime*0.99_r8<a name='2012'></font>
       <font color=#447700>!           ptend_loc_q(1,k,ixnumliq) = min(0._r8,-0.99_r8*state1_q(1,k,ixnumliq)/dtime)<a name='2013'></font>
       <font color=#447700>!          end if<a name='2014'></font>
          <a name='2015'>
       if (st_frac(1,k) &gt; 1.e-5_r8 ) then<a name='2016'>
          <font color=#447700>!       else  !if stratiform cldfra not zero<a name='2017'></font>
          <font color=#447700>!  <a name='2018'></font>
          <font color=#447700>!Case 2: dense cloud: evaporate some stratiform qc until qc_max<a name='2019'></font>
          <font color=#447700>!     <a name='2020'></font>
          if (qc_nc(1,k) &gt; 3.e-3_r8 * st_frac(1,k)) then<a name='2021'>
             del_qq(1,k)               = qc_nc(1,k)-3.e-3_r8* st_frac(1,k)*fact_adj<a name='2022'>
             ptend_loc_q(1,k,ixcldliq) = -del_qq(1,k)/dtime<a name='2023'>
             ptend_loc_q(1,k,1)        =  del_qq(1,k)/dtime<a name='2024'>
             ptend_loc_s(1,k)          = -del_qq(1,k) * latvap /dtime  <font color=#447700>!evaporative cooling<a name='2025'></font>
             ptend_loc_q(1,k,ixnumliq) = ptend_loc_q(1,k,ixcldliq)*state1_q(1,k,ixnumliq)/max(1.e-20_r8,state1_q(1,k,ixcldliq))<a name='2026'>
             ptend_loc_q(1,k,ixnumliq) = min(0._r8,max(ptend_loc_q(1,k,ixnumliq),-state1_q(1,k,ixnumliq)/dtime))<a name='2027'>
             <a name='2028'>
             <font color=#447700>!     <a name='2029'></font>
             <font color=#447700>!Case 3: empty cloud: condense stratiform qc until qc_min when cldfra is not zero<a name='2030'></font>
             <font color=#447700>!    <a name='2031'></font>
          else if (qc_nc(1,k) &lt; 2.e-5_r8 * st_frac(1,k)) then<a name='2032'>
             del_qq(1,k)               = 2.e-5_r8 *st_frac(1,k)-qc_nc(1,k)<a name='2033'>
             del_qq(1,k)               = max(0._r8,min(del_qq(1,k), state1_q(1,k,1)*0.1_r8))*fact_adj<a name='2034'>
             ptend_loc_q(1,k,ixcldliq) = del_qq(1,k)/dtime<a name='2035'>
             ptend_loc_q(1,k,1)        = -del_qq(1,k)/dtime<a name='2036'>
             ptend_loc_s(1,k)          = del_qq(1,k)* latvap / dtime  <font color=#447700>!condensational heating<a name='2037'></font>
          end if<a name='2038'>
       end if<a name='2039'>
       state1_t(1,k)=state1_t(1,k)+ptend_loc_s(1,k)*dtime/cpair<a name='2040'>
    end do<a name='2041'>
    <font color=#447700>!<a name='2042'></font>
    <font color=#447700>!Update state1 variables and tendencies <a name='2043'></font>
    <font color=#447700>!<a name='2044'></font>
    call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_SUM'>physics_ptend_sum</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_PTEND_SUM_3">(ptend_loc_ls,ptend_loc_lq,ptend_loc_s,ptend_loc_q,ptend_all_ls,ptend_all_lq,ptend_all_s,ptend_all_q,pcnst)<a name='2045'>
    ptend_all_name = 'cldwat'<a name='2046'>
    call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_UPDATE'>physics_update</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_UPDATE_5">( lchnk,dtime,state1_q,ptend_loc_q,state1_s,ptend_loc_s,ptend_loc_name,ptend_loc_lq,ptend_loc_ls,pcnst)<a name='2047'>
    call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_INIT'>physics_ptend_init</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_PTEND_INIT_6">( ptend_loc_name,ptend_loc_q,ptend_loc_s, ptend_loc_lq,ptend_loc_ls,pcnst)<a name='2048'>
<a name='2049'>
 go to 2000<a name='2050'>
    <font color=#447700>!<a name='2051'></font>
    <font color=#447700>!restore flags to true<a name='2052'></font>
    <font color=#447700>!<a name='2053'></font>
    <a name='2054'>
    ptend_loc_name         = 'Macro3'<a name='2055'>
    ptend_loc_ls           = .true.<a name='2056'>
    ptend_loc_lq(1)        = .true.<a name='2057'>
    ptend_loc_lq(ixcldliq) = .true.<a name='2058'>
    <a name='2059'>
    <font color=#447700>!<a name='2060'></font>
    <font color=#447700>!Last checker to remove supersaturation<a name='2061'></font>
    <font color=#447700>!<a name='2062'></font>
    do k=1,pver<a name='2063'>
       qsll = 0._r8<a name='2064'>
       tsp  = 0._r8<a name='2065'>
       del_qq(1,k)  = 0._r8<a name='2066'>
       esl(1,k)     = <A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_22">(state1_t(1,k),0)<a name='2067'>
       qvs(1,k)     = max(1.e-30_r8,epsqs*esl(1,k)/(state_pmid(1,k)-(1._r8-epsqs)*esl(1,k)))<a name='2068'>
       rh_curr(1,k) = state1_q(1,k,1) / qvs(1,k)<a name='2069'>
             <a name='2070'>
       if (rh_curr(1,k) &gt; 1._r8) then<a name='2071'>
          call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#FINDSP_WATER'>findsp_water</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FINDSP_WATER_4">(lchnk,pcols,state1_q(1,k,1),state1_t(1,k),state_pmid(1,k),tsp,qsll)<a name='2072'>
          del_qq(1,k)=min(2.e-2_r8,max(0._r8,(state1_q(1,k,1)-qsll(1))*0.999_r8))  <a name='2073'>
          ptend_loc_q(1,k,ixcldliq) =  del_qq(1,k) /dtime<a name='2074'>
          ptend_loc_s(1,k)          =  del_qq(1,k) * latvap/dtime <font color=#447700>!condensational heating<a name='2075'></font>
          ptend_loc_q(1,k,1)        = -del_qq(1,k)/dtime<a name='2076'>
       end if<a name='2077'>
       state1_t(1,k)=state1_t(1,k)+ptend_loc_s(1,k)*dtime/cpair<a name='2078'>
    end do<a name='2079'>
<a name='2080'>
    <font color=#447700>!Update state1 variables and tendencies <a name='2081'></font>
    <font color=#447700>!<a name='2082'></font>
    call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_SUM'>physics_ptend_sum</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_PTEND_SUM_4">(ptend_loc_ls,ptend_loc_lq,ptend_loc_s,ptend_loc_q,ptend_all_ls,ptend_all_lq,ptend_all_s,ptend_all_q,pcnst)<a name='2083'>
    ptend_all_name = 'cldwat'<a name='2084'>
    call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_UPDATE'>physics_update</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_UPDATE_6">( lchnk,dtime,state1_q,ptend_loc_q,state1_s,ptend_loc_s,ptend_loc_name,ptend_loc_lq,ptend_loc_ls,pcnst)<a name='2085'>
    call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_INIT'>physics_ptend_init</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_PTEND_INIT_7">( ptend_loc_name,ptend_loc_q,ptend_loc_s, ptend_loc_lq,ptend_loc_ls,pcnst)<a name='2086'>
<a name='2087'>
    <font color=#447700>!         <a name='2088'></font>
    <font color=#447700>!positive state1 variables<a name='2089'></font>
    <font color=#447700>!<a name='2090'></font>
2000 continue<a name='2091'>
    <a name='2092'>
    do k = 1 , pver<a name='2093'>
       state1_q(1,k,1)        = max(qmin(1),state1_q(1,k,1))<a name='2094'>
       state1_q(1,k,ixcldliq) = max(qmin(ixcldliq),state1_q(1,k,ixcldliq))<a name='2095'>
       state1_q(1,k,ixcldice) = max(qmin(ixcldice),state1_q(1,k,ixcldice))<a name='2096'>
       state1_q(1,k,ixnumliq) = max(qmin(ixnumliq),state1_q(1,k,ixnumliq))<a name='2097'>
       state1_q(1,k,ixnumice) = max(qmin(ixnumice),state1_q(1,k,ixnumice))<a name='2098'>
       call  <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAL_CLDFRA_MP_1D'>cal_cldfra_mp_1d</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MACROPHYSICS_SIMPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_CLDFRA_MP_1D_3">(alst(1,k),aist(1,k),state1_q(1,k,1), state1_q(1,k,ixcldliq), qi_mac(1,k),state1_t(1,k),state_pmid(1,k),xland_pt,snowh_pt)<a name='2099'>
<font color=#447700>!       ast(1,k)=max(alst(1,k),aist(1,k))<a name='2100'></font>
       aist(1,k) = (1._r8-cv_frac(1,k))*aist(1,k)<a name='2101'>
       alst(1,k) = (1._r8-cv_frac(1,k))*alst(1,k)<a name='2102'>
       ast(1,k)=max(alst(1,k),aist(1,k))<a name='2103'>
    end do<a name='2104'>
    <font color=#447700>!<a name='2105'></font>
    <font color=#447700>!PMA&lt;&lt;&lt;<a name='2106'></font>
    <font color=#447700>!<a name='2107'></font>
  end subroutine Macrophysics_simple<a name='2108'>
  <a name='2109'>
<A NAME='CAMMGMP_INIT'><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2110'>
  <font color=#993300>subroutine </font><font color=#cc0000>CAMMGMP_INIT</font>(ixcldliq_in,ixcldice_in &amp; <A href='../../call_to/CAMMGMP_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/CAMMGMP_INIT.html' TARGET='index'>8</A><a name='2111'>
       ,ixnumliq_in,ixnumice_in,chem_opt_in       &amp;    <a name='2112'>
       ,ids, ide, jds, jde, kds, kde              &amp;<a name='2113'>
       ,ims, ime, jms, jme, kms, kme              &amp;<a name='2114'>
       ,its, ite, jts, jte, kts, kte              )        <a name='2115'>
    <a name='2116'>
    <font color=#447700>!!-------------------------------------------- !<a name='2117'></font>
    <font color=#447700>!!                                             !<a name='2118'></font>
    <font color=#447700>!! Initialize the cloud water parameterization !<a name='2119'></font>
    <font color=#447700>!!                                             ! <a name='2120'></font>
    <font color=#447700>!!-------------------------------------------- !<a name='2121'></font>
    use <A href='../../html_code/phys/module_cam_mp_microp_aero.F.html#MICROP_AERO'>microp_aero</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROP_AERO_2">,     only: ini_microp_aero<a name='2122'>
    use <A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#CLDWAT2M_MICRO'>cldwat2m_micro</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLDWAT2M_MICRO_2">,  only: ini_micro<a name='2123'>
#ifdef MODAL_AERO<a name='2124'>
    use <A href='../../html_code/phys/module_cam_mp_ndrop.F.html#NDROP'>ndrop</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NDROP_3">,           only: activate_init<a name='2125'>
#endif<a name='2126'>
    <a name='2127'>
    <font color=#447700>!!-----------------------------------------------------------------------<a name='2128'></font>
    implicit none<a name='2129'>
    integer, intent(in) :: ixcldliq_in, ixcldice_in, ixnumliq_in, ixnumice_in<a name='2130'>
    integer, intent(in) :: chem_opt_in<a name='2131'>
    integer, intent(in) :: ids, ide, jds, jde, kds, kde &amp;<a name='2132'>
         ,ims, ime, jms, jme, kms, kme                  &amp;<a name='2133'>
         ,its, ite, jts, jte, kts, kte  <a name='2134'>
    <a name='2135'>
    <font color=#447700>!Local variables<a name='2136'></font>
    character(len=1000) :: msg<a name='2137'>
    integer :: jtf,ktf,itf<a name='2138'>
    <a name='2139'>
    chem_opt = chem_opt_in<a name='2140'>
<a name='2141'>
    jtf   = min(jte,jde-1)<a name='2142'>
    ktf   = min(kte,kde-1)<a name='2143'>
    itf   = min(ite,ide-1)<a name='2144'>
    <a name='2145'>
    <font color=#447700>!Map CAM veritcal level variables <a name='2146'></font>
    pver  = ktf - kts + 1<a name='2147'>
    pverp = pver + 1<a name='2148'>
    <a name='2149'>
    <font color=#447700>!!-----------------------------------------------------------------------<a name='2150'></font>
    ixcldliq = ixcldliq_in<a name='2151'>
    ixcldice = ixcldice_in<a name='2152'>
    ixnumliq = ixnumliq_in<a name='2153'>
    ixnumice = ixnumice_in<a name='2154'>
    <font color=#447700>!! Initialization routine for cloud macrophysics and microphysics<a name='2155'></font>
    <a name='2156'>
    call <A href='../../html_code/phys/module_cam_mp_cldwat2m_micro.F.html#INI_MICRO'>ini_micro</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INI_MICRO_1"><a name='2157'>
    call <A href='../../html_code/phys/module_cam_mp_microp_aero.F.html#INI_MICROP_AERO'>ini_microp_aero</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INI_MICROP_AERO_1"><a name='2158'>
    <a name='2159'>
#ifdef MODAL_AERO<a name='2160'>
#if ( WRF_CHEM <font color=#447700>!= 1 )<a name='2161'></font>
    <font color=#447700>!When WRF_CHEM is 1, activate_init is called from MODULE_CAM_MAM_INIT after initializing aerosols<a name='2162'></font>
    call <A href='../../html_code/phys/module_cam_mp_ndrop.F.html#ACTIVATE_INIT'>activate_init</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACTIVATE_INIT_2"><a name='2163'>
#else<a name='2164'>
    <font color=#447700>!BSINGH:02/01/2013: Sanity check for Non-MAM simulations<a name='2165'></font>
    if(.NOT.cam_mam_aerosols .AND. chem_opt .NE. 0) then<a name='2166'>
       write(msg,*)'CAMMGMP DRIVER - cammgmp is valid for only MAM aerosols ', &amp;<a name='2167'>
            '(chem_opts:',CBMZ_CAM_MAM3_NOAQ,CBMZ_CAM_MAM3_AQ,CBMZ_CAM_MAM7_NOAQ,CBMZ_CAM_MAM7_AQ ,')'<a name='2168'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_726">( msg )<a name='2169'>
    endif<a name='2170'>
    if(chem_opt == 0)then<a name='2171'>
       <font color=#447700>!NOTE*: Not tested yet for other CHEM packages except MAM packages<a name='2172'></font>
       call <A href='../../html_code/phys/module_cam_mp_ndrop.F.html#ACTIVATE_INIT'>activate_init</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#CAMMGMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACTIVATE_INIT_3"><a name='2173'>
    endif<a name='2174'>
#endif<a name='2175'>
#endif<a name='2176'>
    return<a name='2177'>
  end subroutine CAMMGMP_INIT<a name='2178'>
<A NAME='FINDSP_WATER'><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#FINDSP_WATER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2179'>
<font color=#993300>subroutine </font><font color=#cc0000>findsp_water</font> (lchnk, ncol, q, t, p, tsp, qsp) <A href='../../call_to/FINDSP_WATER.html' TARGET='index'>4</A>,<A href='../../call_from/FINDSP_WATER.html' TARGET='index'>7</A><a name='2180'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2181'></font>
<font color=#447700>!<a name='2182'></font>
<font color=#447700>! Purpose:<a name='2183'></font>
<font color=#447700>!     find the wet bulb temperature for a given t and q<a name='2184'></font>
<font color=#447700>!     in a longitude height section<a name='2185'></font>
<font color=#447700>!     wet bulb temp is the temperature and spec humidity that is<a name='2186'></font>
<font color=#447700>!     just saturated and has the same enthalpy<a name='2187'></font>
<font color=#447700>!     if q &gt; qs(t) then tsp &gt; t and qsp = qs(tsp) &lt; q<a name='2188'></font>
<font color=#447700>!     if q &lt; qs(t) then tsp &lt; t and qsp = qs(tsp) &gt; q<a name='2189'></font>
<font color=#447700>!<a name='2190'></font>
<font color=#447700>! Method:<a name='2191'></font>
<font color=#447700>! a Newton method is used<a name='2192'></font>
<font color=#447700>! first guess uses an algorithm provided by John Petch from the UKMO<a name='2193'></font>
<font color=#447700>! we exclude points where the physical situation is unrealistic<a name='2194'></font>
<font color=#447700>! e.g. where the temperature is outside the range of validity for the<a name='2195'></font>
<font color=#447700>!      saturation vapor pressure, or where the water vapor pressure<a name='2196'></font>
<font color=#447700>!      exceeds the ambient pressure, or the saturation specific humidity is<a name='2197'></font>
<font color=#447700>!      unrealistic<a name='2198'></font>
<font color=#447700>!<a name='2199'></font>
<font color=#447700>! Author: P. Rasch<a name='2200'></font>
<font color=#447700>!<a name='2201'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2202'></font>
<a name='2203'>
  use <A href='../../html_code/phys/module_cam_wv_saturation.F.html#WV_SATURATION'>wv_saturation</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#FINDSP_WATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WV_SATURATION_17">, only: estblf, hlatv, tmin, hlatf, rgasv, pcf, &amp;<a name='2204'>
                           cp, epsqs, ttrice,polysvp<a name='2205'>
<a name='2206'>
<font color=#447700>!<a name='2207'></font>
<font color=#447700>!     input arguments<a name='2208'></font>
<font color=#447700>!<a name='2209'></font>
   integer, intent(in) :: lchnk                 <font color=#447700>! chunk identifier<a name='2210'></font>
   integer, intent(in) :: ncol                  <font color=#447700>! number of atmospheric columns<a name='2211'></font>
<a name='2212'>
   real(r8), intent(in) :: q(pcols)        <font color=#447700>! water vapor (kg/kg)<a name='2213'></font>
   real(r8), intent(in) :: t(pcols)        <font color=#447700>! temperature (K)<a name='2214'></font>
   real(r8), intent(in) :: p(pcols)        <font color=#447700>! pressure    (Pa)<a name='2215'></font>
<font color=#447700>!<a name='2216'></font>
<font color=#447700>! output arguments<a name='2217'></font>
<font color=#447700>!<a name='2218'></font>
   real(r8), intent(out) :: tsp(pcols)      <font color=#447700>! saturation temp (K)<a name='2219'></font>
   real(r8), intent(out) :: qsp(pcols)      <font color=#447700>! saturation mixing ratio (kg/kg)<a name='2220'></font>
<font color=#447700>!<a name='2221'></font>
<font color=#447700>! local variables<a name='2222'></font>
<font color=#447700>!<a name='2223'></font>
   character*250 :: iulog<a name='2224'>
   integer i                 <font color=#447700>! work variable<a name='2225'></font>
<font color=#447700>!  integer k                 ! work variable<a name='2226'></font>
   logical lflg              <font color=#447700>! work variable<a name='2227'></font>
   integer iter              <font color=#447700>! work variable<a name='2228'></font>
   integer l                 <font color=#447700>! work variable<a name='2229'></font>
   logical :: error_found<a name='2230'>
<a name='2231'>
   real(r8) omeps                <font color=#447700>! 1 minus epsilon<a name='2232'></font>
   real(r8) trinv                <font color=#447700>! work variable<a name='2233'></font>
   real(r8) es                   <font color=#447700>! sat. vapor pressure<a name='2234'></font>
   real(r8) desdt                <font color=#447700>! change in sat vap pressure wrt temperature<a name='2235'></font>
<font color=#447700>!     real(r8) desdp                ! change in sat vap pressure wrt pressure<a name='2236'></font>
   real(r8) dqsdt                <font color=#447700>! change in sat spec. hum. wrt temperature<a name='2237'></font>
   real(r8) dgdt                 <font color=#447700>! work variable<a name='2238'></font>
   real(r8) g                    <font color=#447700>! work variable<a name='2239'></font>
   real(r8) weight(pcols)        <font color=#447700>! work variable<a name='2240'></font>
   real(r8) hlatsb               <font color=#447700>! (sublimation)<a name='2241'></font>
   real(r8) hlatvp               <font color=#447700>! (vaporization)<a name='2242'></font>
   real(r8) hltalt(pcols)   <font color=#447700>! lat. heat. of vap.<a name='2243'></font>
   real(r8) tterm                <font color=#447700>! work var.<a name='2244'></font>
   real(r8) qs                   <font color=#447700>! spec. hum. of water vapor<a name='2245'></font>
   real(r8) tc                   <font color=#447700>! crit temp of transition to ice<a name='2246'></font>
   real(r8) tt0                  <font color=#447700>! Freezing temperature. Needed for findsp <a name='2247'></font>
<a name='2248'>
<font color=#447700>! work variables<a name='2249'></font>
   real(r8) t1, q1, dt, dq<a name='2250'>
   real(r8) dtm, dqm<a name='2251'>
   real(r8) qvd, a1, tmp<a name='2252'>
   real(r8) rair<a name='2253'>
   real(r8) r1b, c1, c2, c3<a name='2254'>
   real(r8) denom<a name='2255'>
   real(r8) dttol<a name='2256'>
   real(r8) dqtol<a name='2257'>
   integer doit(pcols)<a name='2258'>
   real(r8) enin(pcols), enout(pcols)<a name='2259'>
   real(r8) tlim(pcols)<a name='2260'>
<a name='2261'>
   omeps = 1.0_r8 - epsqs<a name='2262'>
<font color=#447700>!  trinv = 1.0_r8/ttrice  ! put just before it is used, in case ttrice = 0.0  !++xl<a name='2263'></font>
   a1 = 7.5_r8*log(10._r8)<a name='2264'>
   rair =  287.04_r8<a name='2265'>
   c3 = rair*a1/cp<a name='2266'>
   dtm = 0._r8    <font color=#447700>! needed for iter=0 blowup with f90 -ei<a name='2267'></font>
   dqm = 0._r8    <font color=#447700>! needed for iter=0 blowup with f90 -ei<a name='2268'></font>
   dttol = 1.e-4_r8 <font color=#447700>! the relative temp error tolerance required to quit the iteration<a name='2269'></font>
   dqtol = 1.e-4_r8 <font color=#447700>! the relative moisture error tolerance required to quit the iteration<a name='2270'></font>
<font color=#447700>!  tmin = 173.16 ! the coldest temperature we can deal with<a name='2271'></font>
   tt0  = 273.15_r8<a name='2272'>
<font color=#447700>!<a name='2273'></font>
<font color=#447700>! max number of times to iterate the calculation<a name='2274'></font>
   iter = 8<a name='2275'>
<font color=#447700>!<a name='2276'></font>
<a name='2277'>
<font color=#447700>!  Sungsu comment out k loop<a name='2278'></font>
<font color=#447700>!  do k = 1,pver<a name='2279'></font>
<a name='2280'>
<font color=#447700>!<a name='2281'></font>
<font color=#447700>! first guess on the wet bulb temperature<a name='2282'></font>
<font color=#447700>!<a name='2283'></font>
      do i = 1,ncol<a name='2284'>
<a name='2285'>
<font color=#447700>!#ifdef DEBUG<a name='2286'></font>
<font color=#447700>!         if ( (lchnk == lchnklook(nlook) ) .and. (i == icollook(nlook) ) ) then<a name='2287'></font>
<font color=#447700>!            write (iulog,*) ' '<a name='2288'></font>
<font color=#447700>!            write (iulog,*) ' level, t, q, p', t(i), q(i), p(i)<a name='2289'></font>
<font color=#447700>!         endif<a name='2290'></font>
<font color=#447700>!#endif<a name='2291'></font>
<font color=#447700>! limit the temperature range to that relevant to the sat vap pres tables<a name='2292'></font>
<font color=#447700>!#if ( ! defined WACCM_MOZART )   <a name='2293'></font>
<font color=#447700>!         tlim(i) = min(max(t(i),173._r8),373._r8)<a name='2294'></font>
<font color=#447700>!#else<a name='2295'></font>
         tlim(i) = min(max(t(i),128._r8),373._r8)<a name='2296'>
<font color=#447700>!#endif<a name='2297'></font>
<font color=#447700>!        es = estblf(tlim(i))    <a name='2298'></font>
         es = <A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#FINDSP_WATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_23">(tlim(i),0)  <font color=#447700>!++xl<a name='2299'></font>
         denom = p(i) - omeps*es <a name='2300'>
         qs = epsqs*es/denom     <a name='2301'>
         doit(i) = 0<a name='2302'>
         enout(i) = 1._r8<a name='2303'>
<font color=#447700>! make sure a meaningful calculation is possible<a name='2304'></font>
         if (p(i) &gt; 5._r8*es .and. qs &gt; 0._r8 .and. qs &lt; 0.5_r8) then<a name='2305'>
<font color=#447700>!<a name='2306'></font>
<font color=#447700>! Saturation specific humidity<a name='2307'></font>
<font color=#447700>!<a name='2308'></font>
             qs = min(epsqs*es/denom,1._r8)<a name='2309'>
<font color=#447700>!<a name='2310'></font>
<font color=#447700>! "generalized" analytic expression for t derivative of es<a name='2311'></font>
<font color=#447700>!  accurate to within 1 percent for 173.16 &lt; t &lt; 373.16<a name='2312'></font>
<a name='2313'>
<font color=#447700>!++xl<a name='2314'></font>
<font color=#447700>! Weighting of hlat accounts for transition from water to ice<a name='2315'></font>
<font color=#447700>! polynomial expression approximates difference between es over<a name='2316'></font>
<font color=#447700>! water and es over ice from 0 to -ttrice (C) (min of ttrice is<a name='2317'></font>
<font color=#447700>! -40): required for accurate estimate of es derivative in transition<a name='2318'></font>
<font color=#447700>! range from ice to water also accounting for change of hlatv with t<a name='2319'></font>
<font color=#447700>! above freezing where const slope is given by -2369 j/(kg c) = cpv - cw<a name='2320'></font>
<font color=#447700>!  <a name='2321'></font>
<font color=#447700>!            tc     = tlim(i) - tt0<a name='2322'></font>
<font color=#447700>!            lflg   = (tc &gt;= -ttrice .and. tc &lt; 0.0_r8)<a name='2323'></font>
<font color=#447700>!            weight(i) = min(-tc*trinv,1.0_r8)<a name='2324'></font>
<font color=#447700>!            hlatsb = hlatv + weight(i)*hlatf<a name='2325'></font>
<font color=#447700>!            hlatvp = hlatv - 2369.0_r8*tc<a name='2326'></font>
<font color=#447700>!            if (tlim(i) &lt; tt0) then<a name='2327'></font>
<font color=#447700>!               hltalt(i) = hlatsb<a name='2328'></font>
<font color=#447700>!            else<a name='2329'></font>
<font color=#447700>!               hltalt(i) = hlatvp<a name='2330'></font>
<font color=#447700>!            end if<a name='2331'></font>
<font color=#447700>!<a name='2332'></font>
<font color=#447700>! No icephs or water to ice transition<a name='2333'></font>
<font color=#447700>!<a name='2334'></font>
             hlatvp = hlatv - 2369.0*(tlim(i)-tt0)<a name='2335'>
             hlatsb = hlatv<a name='2336'>
             if (tlim(i) &lt; tt0) then<a name='2337'>
               hltalt(i) = hlatsb<a name='2338'>
             else<a name='2339'>
               hltalt(i) = hlatvp<a name='2340'>
             end if<a name='2341'>
<font color=#447700>!--xl       <a name='2342'></font>
             enin(i) = cp*tlim(i) + hltalt(i)*q(i)<a name='2343'>
         <a name='2344'>
<font color=#447700>! make a guess at the wet bulb temp using a UKMO algorithm (from J. Petch)<a name='2345'></font>
             tmp =  q(i) - qs<a name='2346'>
             c1 = hltalt(i)*c3<a name='2347'>
             c2 = (tlim(i) + 36._r8)**2<a name='2348'>
             r1b    = c2/(c2 + c1*qs)<a name='2349'>
             qvd   = r1b*tmp<a name='2350'>
             tsp(i) = tlim(i) + ((hltalt(i)/cp)*qvd)<a name='2351'>
<font color=#447700>!#ifdef DEBUG <a name='2352'></font>
<font color=#447700>!             if ( (lchnk == lchnklook(nlook) ) .and. (i == icollook(nlook) ) ) then<a name='2353'></font>
<font color=#447700>!                write (iulog,*) ' relative humidity ', q(i)/qs<a name='2354'></font>
<font color=#447700>!                write (iulog,*) ' first guess ', tsp(i)<a name='2355'></font>
<font color=#447700>!             endif<a name='2356'></font>
<font color=#447700>!#endif<a name='2357'></font>
<font color=#447700>!            es = estblf(tsp(i))<a name='2358'></font>
             es = <A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#FINDSP_WATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_24">(tsp(i),0)  <font color=#447700>!++xl <a name='2359'></font>
             qsp(i) = min(epsqs*es/(p(i) - omeps*es),1._r8)<a name='2360'>
          else<a name='2361'>
             doit(i) = 1<a name='2362'>
             tsp(i) = tlim(i)<a name='2363'>
             qsp(i) = q(i)<a name='2364'>
             enin(i) = 1._r8<a name='2365'>
          endif <a name='2366'>
       end do   <font color=#447700>! end do i<a name='2367'></font>
<font color=#447700>!<a name='2368'></font>
<font color=#447700>! now iterate on first guess<a name='2369'></font>
<font color=#447700>!     <a name='2370'></font>
      do l = 1, iter<a name='2371'>
         dtm = 0<a name='2372'>
         dqm = 0<a name='2373'>
         do i = 1,ncol<a name='2374'>
            if (doit(i) == 0) then<a name='2375'>
<font color=#447700>!              es = estblf(tsp(i))<a name='2376'></font>
               es = <A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#FINDSP_WATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_25">(tsp(i),0)  <font color=#447700>!++xl<a name='2377'></font>
<font color=#447700>!<a name='2378'></font>
<font color=#447700>! Saturation specific humidity<a name='2379'></font>
<font color=#447700>!              <a name='2380'></font>
               qs = min(epsqs*es/(p(i) - omeps*es),1._r8)<a name='2381'>
<font color=#447700>!<a name='2382'></font>
<font color=#447700>! "generalized" analytic expression for t derivative of es<a name='2383'></font>
<font color=#447700>! accurate to within 1 percent for 173.16 &lt; t &lt; 373.16<a name='2384'></font>
<font color=#447700>!<a name='2385'></font>
<font color=#447700>!++xl<a name='2386'></font>
<font color=#447700>! Weighting of hlat accounts for transition from water to ice<a name='2387'></font>
<font color=#447700>! polynomial expression approximates difference between es over<a name='2388'></font>
<font color=#447700>! water and es over ice from 0 to -ttrice (C) (min of ttrice is<a name='2389'></font>
<font color=#447700>! -40): required for accurate estimate of es derivative in transition<a name='2390'></font>
<font color=#447700>! range from ice to water also accounting for change of hlatv with t<a name='2391'></font>
<font color=#447700>! above freezing where const slope is given by -2369 j/(kg c) = cpv - cw<a name='2392'></font>
<font color=#447700>!<a name='2393'></font>
<font color=#447700>!              tc     = tsp(i) - tt0<a name='2394'></font>
<font color=#447700>!              lflg   = (tc &gt;= -ttrice .and. tc &lt; 0.0_r8)<a name='2395'></font>
<font color=#447700>!              weight(i) = min(-tc*trinv,1.0_r8)<a name='2396'></font>
<font color=#447700>!              hlatsb = hlatv + weight(i)*hlatf<a name='2397'></font>
<font color=#447700>!              hlatvp = hlatv - 2369.0_r8*tc<a name='2398'></font>
<font color=#447700>!              if (tsp(i) &lt; tt0) then<a name='2399'></font>
<font color=#447700>!                 hltalt(i) = hlatsb<a name='2400'></font>
<font color=#447700>!              else<a name='2401'></font>
<font color=#447700>!                 hltalt(i) = hlatvp<a name='2402'></font>
<font color=#447700>!              end if<a name='2403'></font>
<font color=#447700>!              if (lflg) then<a name='2404'></font>
<font color=#447700>!                 tterm = pcf(1) + tc*(pcf(2) + tc*(pcf(3)+tc*(pcf(4) + tc*pcf(5))))<a name='2405'></font>
<font color=#447700>!              else<a name='2406'></font>
<font color=#447700>!                 tterm = 0.0_r8<a name='2407'></font>
<font color=#447700>!              end if<a name='2408'></font>
<font color=#447700>!              desdt = hltalt(i)*es/(rgasv*tsp(i)*tsp(i)) + tterm*trinv<a name='2409'></font>
<font color=#447700>!<a name='2410'></font>
<font color=#447700>! No icephs or water to ice transition<a name='2411'></font>
<font color=#447700>!              <a name='2412'></font>
               hlatvp = hlatv - 2369.0*(tsp(i)-tt0)<a name='2413'>
               hlatsb = hlatv<a name='2414'>
               if (tsp(i) &lt; tt0) then<a name='2415'>
                 hltalt(i) = hlatsb<a name='2416'>
               else<a name='2417'>
                 hltalt(i) = hlatvp<a name='2418'>
               end if<a name='2419'>
               desdt = hltalt(i)*es/(rgasv*tsp(i)*tsp(i))<a name='2420'>
<font color=#447700>!--xl          <a name='2421'></font>
               dqsdt = (epsqs + omeps*qs)/(p(i) - omeps*es)*desdt<a name='2422'>
<font color=#447700>!              g = cp*(tlim(i)-tsp(i)) + hltalt(i)*q(i)- hltalt(i)*qsp(i)<a name='2423'></font>
               g = enin(i) - (cp*tsp(i) + hltalt(i)*qsp(i))<a name='2424'>
               dgdt = -(cp + hltalt(i)*dqsdt)<a name='2425'>
               t1 = tsp(i) - g/dgdt<a name='2426'>
               dt = abs(t1 - tsp(i))/t1<a name='2427'>
               tsp(i) = max(t1,tmin)<a name='2428'>
<font color=#447700>!              es = estblf(tsp(i))<a name='2429'></font>
               es = <A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#FINDSP_WATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_26">(tsp(i),0)  <font color=#447700>!++xl<a name='2430'></font>
               q1 = min(epsqs*es/(p(i) - omeps*es),1._r8)<a name='2431'>
               dq = abs(q1 - qsp(i))/max(q1,1.e-12_r8)<a name='2432'>
               qsp(i) = q1<a name='2433'>
<font color=#447700>!#ifdef DEBUG   <a name='2434'></font>
<font color=#447700>!               if ( (lchnk == lchnklook(nlook) ) .and. (i == icollook(nlook) ) ) then<a name='2435'></font>
<font color=#447700>!                  write (iulog,*) ' rel chg lev, iter, t, q ', l, dt, dq, g<a name='2436'></font>
<font color=#447700>!               endif<a name='2437'></font>
<font color=#447700>!#endif         <a name='2438'></font>
               dtm = max(dtm,dt)<a name='2439'>
               dqm = max(dqm,dq)<a name='2440'>
<font color=#447700>! if converged at this point, exclude it from more iterations<a name='2441'></font>
               if (dt &lt; dttol .and. dq &lt; dqtol) then<a name='2442'>
                  doit(i) = 2<a name='2443'>
               endif<a name='2444'>
               enout(i) = cp*tsp(i) + hltalt(i)*qsp(i)<a name='2445'>
<font color=#447700>! bail out if we are too near the end of temp range<a name='2446'></font>
<font color=#447700>!#if ( ! defined WACCM_MOZART )<a name='2447'></font>
               if (tsp(i) &lt; 174.16_r8) then<a name='2448'>
<font color=#447700>!#else<a name='2449'></font>
<font color=#447700>!               if (tsp(i) &lt; 130.16_r8) then<a name='2450'></font>
<font color=#447700>!#endif<a name='2451'></font>
                  doit(i) = 4<a name='2452'>
               endif<a name='2453'>
            else<a name='2454'>
            endif<a name='2455'>
         end do              <font color=#447700>! do i = 1,ncol<a name='2456'></font>
<a name='2457'>
         if (dtm &lt; dttol .and. dqm &lt; dqtol) then<a name='2458'>
            go to 10<a name='2459'>
         endif<a name='2460'>
<a name='2461'>
      end do                 <font color=#447700>! do l = 1,iter<a name='2462'></font>
10    continue<a name='2463'>
<a name='2464'>
      error_found = .false.<a name='2465'>
      if (dtm &gt; dttol .or. dqm &gt; dqtol) then<a name='2466'>
         do i = 1,ncol<a name='2467'>
            if (doit(i) == 0) error_found = .true.<a name='2468'>
         end do<a name='2469'>
         if (error_found) then<a name='2470'>
            do i = 1,ncol<a name='2471'>
               if (doit(i) == 0) then<a name='2472'>
                  write (iulog,*) ' findsp not converging at point i ', i<a name='2473'>
                  write (iulog,*) ' t, q, p, enin ', t(i), q(i), p(i), enin(i)<a name='2474'>
                  write (iulog,*) ' tsp, qsp, enout ', tsp(i), qsp(i), enout(i)<a name='2475'>
                  call  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#FINDSP_WATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_727"> ('FINDSP')<a name='2476'>
               endif<a name='2477'>
            end do<a name='2478'>
         endif<a name='2479'>
      endif<a name='2480'>
      do i = 1,ncol<a name='2481'>
         if (doit(i) == 2 .and. abs((enin(i)-enout(i))/(enin(i)+enout(i))) &gt; 1.e-4_r8) then<a name='2482'>
            error_found = .true.<a name='2483'>
         endif<a name='2484'>
      end do<a name='2485'>
      if (error_found) then<a name='2486'>
         do i = 1,ncol<a name='2487'>
            if (doit(i) == 2 .and. abs((enin(i)-enout(i))/(enin(i)+enout(i))) &gt; 1.e-4_r8) then<a name='2488'>
               write (iulog,*) ' the enthalpy is not conserved for point ', &amp;<a name='2489'>
                  i, enin(i), enout(i)<a name='2490'>
               write (iulog,*) ' t, q, p, enin ', t(i), q(i), p(i), enin(i)<a name='2491'>
               write (iulog,*) ' tsp, qsp, enout ', tsp(i), qsp(i), enout(i)<a name='2492'>
               call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#FINDSP_WATER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_728"> ('FINDSP')<a name='2493'>
            endif<a name='2494'>
         end do<a name='2495'>
      endif<a name='2496'>
<a name='2497'>
 <font color=#447700>! end do                    ! level loop (k=1,pver)<a name='2498'></font>
<a name='2499'>
   return<a name='2500'>
end subroutine findsp_water<a name='2501'>
end module module_mp_cammgmp_driver<a name='2502'>
</pre></body></html>