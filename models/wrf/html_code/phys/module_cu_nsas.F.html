<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>!<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<A NAME='MODULE_CU_NSAS'><A href='../../html_code/phys/module_cu_nsas.F.html#MODULE_CU_NSAS' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='6'>
<font color=#993300>MODULE </font><font color=#cc0000>module_cu_nsas</font> <A href='../../call_to/MODULE_CU_NSAS.html' TARGET='index'>2</A><a name='7'>
CONTAINS<a name='8'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='9'></font>
<A NAME='CU_NSAS'><A href='../../html_code/phys/module_cu_nsas.F.html#CU_NSAS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='10'>
   <font color=#993300>subroutine </font><font color=#cc0000>cu_nsas</font>(dt,dx,p3di,p3d,pi3d,qc3d,qi3d,rho3d,itimestep,stepcu,    &amp; <A href='../../call_to/CU_NSAS.html' TARGET='index'>1</A>,<A href='../../call_from/CU_NSAS.html' TARGET='index'>2</A><a name='11'>
                     hbot,htop,cu_act_flag,                                    &amp;<a name='12'>
                     rthcuten,rqvcuten,rqccuten,rqicuten,                      &amp;<a name='13'>
                     rucuten,rvcuten,                                          &amp;<a name='14'>
                     qv3d,t3d,raincv,pratec,xland,dz8w,w,u3d,v3d,              &amp;<a name='15'>
                     hpbl,hfx,qfx,                                             &amp;<a name='16'>
                     mp_physics,dx_factor_nsas,                                &amp;<a name='17'>
                     p_qc,p_qi,p_first_scalar,                                 &amp;<a name='18'>
                     pgcon,                                                    &amp;<a name='19'>
                     cp,cliq,cpv,g,xlv,r_d,r_v,ep_1,ep_2,                      &amp;<a name='20'>
                     cice,xls,psat,f_qi,f_qc,                                  &amp;<a name='21'>
                     ids,ide, jds,jde, kds,kde,                                &amp;<a name='22'>
                     ims,ime, jms,jme, kms,kme,                                &amp;<a name='23'>
                     its,ite, jts,jte, kts,kte)<a name='24'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='25'></font>
   implicit none<a name='26'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='27'></font>
<font color=#447700>!-- dt          time step (s)<a name='28'></font>
<font color=#447700>!-- dx          grid interval (m)<a name='29'></font>
<font color=#447700>!-- p3di        3d pressure (pa) at interface level<a name='30'></font>
<font color=#447700>!-- p3d         3d pressure (pa)<a name='31'></font>
<font color=#447700>!-- pi3d        3d exner function (dimensionless)<a name='32'></font>
<font color=#447700>!-- z           height above sea level (m)<a name='33'></font>
<font color=#447700>!-- qc3d        cloud water mixing ratio (kg/kg)<a name='34'></font>
<font color=#447700>!-- qi3d        cloud ice mixing ratio (kg/kg)<a name='35'></font>
<font color=#447700>!-- qv3d        3d water vapor mixing ratio (kg/kg)<a name='36'></font>
<font color=#447700>!-- t3d         temperature (k)<a name='37'></font>
<font color=#447700>!-- raincv      cumulus scheme precipitation (mm)<a name='38'></font>
<font color=#447700>!-- w           vertical velocity (m/s)<a name='39'></font>
<font color=#447700>!-- dz8w        dz between full levels (m)<a name='40'></font>
<font color=#447700>!-- u3d         3d u-velocity interpolated to theta points (m/s)<a name='41'></font>
<font color=#447700>!-- v3d         3d v-velocity interpolated to theta points (m/s)<a name='42'></font>
<font color=#447700>!-- ids         start index for i in domain <a name='43'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='44'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='45'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='46'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='47'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='48'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='49'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='50'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='51'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='52'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='53'></font>
<font color=#447700>!-- kme         end index for k in memory <a name='54'></font>
<font color=#447700>!-- its         start index for i in tile<a name='55'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='56'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='57'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='58'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='59'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='60'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='61'></font>
   integer,  intent(in   )   ::       ids,ide, jds,jde, kds,kde,               &amp;<a name='62'>
                                      ims,ime, jms,jme, kms,kme,               &amp;<a name='63'>
                                      its,ite, jts,jte, kts,kte,               &amp;<a name='64'>
                                      itimestep, stepcu,                       &amp;<a name='65'>
                                      p_qc,p_qi,p_first_scalar<a name='66'>
   real,     intent(in   )   ::      cp,cliq,cpv,g,xlv,r_d,r_v,ep_1,ep_2,      &amp;<a name='67'>
                                     cice,xls,psat<a name='68'>
   real,     intent(in   )   ::      dt,dx<a name='69'>
   real,     optional, intent(in ) :: pgcon<a name='70'>
   real,     dimension( ims:ime, kms:kme, jms:jme ),optional                  ,&amp;<a name='71'>
             intent(inout)   ::                                       rthcuten,&amp;<a name='72'>
                                                                       rucuten,&amp;<a name='73'>
                                                                       rvcuten,&amp;<a name='74'>
                                                                      rqccuten,&amp;<a name='75'>
                                                                      rqicuten,&amp;<a name='76'>
                                                                      rqvcuten<a name='77'>
   logical, optional ::                                              F_QC,F_QI<a name='78'>
   real,     dimension( ims:ime, kms:kme, jms:jme )                           ,&amp;<a name='79'>
             intent(in   )   ::                                           qv3d,&amp;<a name='80'>
                                                                          qc3d,&amp;<a name='81'>
                                                                          qi3d,&amp;<a name='82'>
                                                                         rho3d,&amp;<a name='83'>
                                                                           p3d,&amp;<a name='84'>
                                                                          pi3d,&amp;<a name='85'>
                                                                           t3d<a name='86'>
   real,     dimension( ims:ime, kms:kme, jms:jme )                           ,&amp;<a name='87'>
             intent(in   )   ::                                           p3di<a name='88'>
   real,     dimension( ims:ime, kms:kme, jms:jme )                           ,&amp;<a name='89'>
             intent(in   )   ::                                           dz8w,&amp;  <a name='90'>
                                                                             w<a name='91'>
   real,     dimension( ims:ime, jms:jme )                                    ,&amp;<a name='92'>
             intent(inout) ::                                           raincv,&amp;<a name='93'>
                                                                        pratec<a name='94'>
   real,     dimension( ims:ime, jms:jme )                                    ,&amp;<a name='95'>
             intent(out) ::                                               hbot,&amp;<a name='96'>
                                                                          htop<a name='97'>
<font color=#447700>!<a name='98'></font>
   real,     dimension( ims:ime, jms:jme )                                    ,&amp;<a name='99'>
             intent(in   ) ::                                            xland<a name='100'>
<font color=#447700>!<a name='101'></font>
   real,     dimension( ims:ime, kms:kme, jms:jme )                           ,&amp;<a name='102'>
              intent(in   )   ::                                           u3d,&amp;<a name='103'>
                                                                           v3d<a name='104'>
   logical,  dimension( ims:ime, jms:jme )                                    ,&amp;<a name='105'>
             intent(inout) ::                                      cu_act_flag<a name='106'>
<font color=#447700>!<a name='107'></font>
   real,     dimension( ims:ime, jms:jme )                                    ,&amp;<a name='108'>
              intent(in   )   ::                                          hpbl,&amp;<a name='109'>
                                                                           hfx,&amp;<a name='110'>
                                                                           qfx<a name='111'>
   integer,   intent(in   )   ::                                    mp_physics<a name='112'>
   integer,   intent(in   )   ::                                dx_factor_nsas <a name='113'>
   integer :: ncloud<a name='114'>
<font color=#447700>!<a name='115'></font>
<font color=#447700>!local<a name='116'></font>
<font color=#447700>!<a name='117'></font>
   real,  dimension( its:ite, jts:jte )  ::                            raincv1,&amp;<a name='118'>
                                                                       raincv2,&amp;<a name='119'>
                                                                       pratec1,&amp;<a name='120'>
                                                                       pratec2<a name='121'>
   real,   dimension( its:ite, kts:kte )  ::                               del,&amp;<a name='122'>
                                                                         prsll,&amp;<a name='123'>
                                                                           dot,&amp;<a name='124'>
                                                                            u1,&amp;<a name='125'>
                                                                            v1,&amp;<a name='126'>
                                                                            t1,&amp;<a name='127'>
                                                                           q1, &amp;<a name='128'>
                                                                           qc2,&amp;<a name='129'>
                                                                           qi2<a name='130'>
   real,   dimension( its:ite, kts:kte+1 )  ::                           prsii,&amp;<a name='131'>
                                                                           zii<a name='132'>
   real,   dimension( its:ite, kts:kte )  ::                               zll <a name='133'>
   real,   dimension( its:ite)  ::                                         rain<a name='134'>
   real ::                                                          delt,rdelt<a name='135'>
   integer, dimension (its:ite)  ::                                       kbot,&amp;<a name='136'>
                                                                          ktop,&amp;<a name='137'>
                                                                          icps<a name='138'>
   real :: pgcon_use<a name='139'>
   integer ::  i,j,k,kp<a name='140'>
<font color=#447700>!<a name='141'></font>
<font color=#447700>! microphysics scheme --&gt; ncloud <a name='142'></font>
<font color=#447700>!<a name='143'></font>
   if (mp_physics .eq. 0) then<a name='144'>
     ncloud = 0<a name='145'>
   elseif ( mp_physics .eq. 1 .or. mp_physics .eq. 3 ) then<a name='146'>
     ncloud = 1<a name='147'>
   else<a name='148'>
     ncloud = 2<a name='149'>
   endif<a name='150'>
<font color=#447700>!<a name='151'></font>
   if(present(pgcon)) then<a name='152'>
     pgcon_use = pgcon<a name='153'>
   else<a name='154'>
<font color=#447700>!    pgcon_use  = 0.7     ! Gregory et al. (1997, QJRMS)<a name='155'></font>
     pgcon_use  = 0.55    <font color=#447700>! Zhang &amp; Wu (2003,JAS)<a name='156'></font>
     <font color=#447700>! 0.55 is a physically-based value used by GFS<a name='157'></font>
     <font color=#447700>! HWRF uses 0.2, for model tuning purposes<a name='158'></font>
   endif<a name='159'>
<font color=#447700>!<a name='160'></font>
   do j = jts,jte<a name='161'>
     do i = its,ite<a name='162'>
       cu_act_flag(i,j)=.TRUE.<a name='163'>
     enddo<a name='164'>
   enddo<a name='165'>
   delt=dt*stepcu<a name='166'>
   rdelt=1./delt<a name='167'>
<font color=#447700>!<a name='168'></font>
<font color=#447700>! outer most J_loop<a name='169'></font>
<font color=#447700>!<a name='170'></font>
   do j = jts,jte<a name='171'>
     do k = kts,kte<a name='172'>
       kp = k+1<a name='173'>
       do i = its,ite<a name='174'>
         dot(i,k) = -5.0e-4*g*rho3d(i,k,j)*(w(i,k,j)+w(i,kp,j))<a name='175'>
         prsll(i,k)=p3d(i,k,j)*0.001<a name='176'>
         prsii(i,k)=p3di(i,k,j)*0.001<a name='177'>
       enddo<a name='178'>
     enddo<a name='179'>
<font color=#447700>!<a name='180'></font>
     do i = its,ite<a name='181'>
       prsii(i,kte+1)=p3di(i,kte+1,j)*0.001<a name='182'>
     enddo<a name='183'>
<font color=#447700>!<a name='184'></font>
     do i = its,ite<a name='185'>
       zii(i,1)=0.0<a name='186'>
     enddo     <a name='187'>
<font color=#447700>!<a name='188'></font>
     do k = kts,kte                                            <a name='189'>
       do i = its,ite<a name='190'>
         zii(i,k+1)=zii(i,k)+dz8w(i,k,j)<a name='191'>
       enddo<a name='192'>
     enddo<a name='193'>
<font color=#447700>!<a name='194'></font>
     do k = kts,kte                <a name='195'>
       do i = its,ite                                                  <a name='196'>
         zll(i,k)=0.5*(zii(i,k)+zii(i,k+1))<a name='197'>
       enddo                                                         <a name='198'>
     enddo<a name='199'>
<font color=#447700>!<a name='200'></font>
     do k = kts,kte<a name='201'>
       do i = its,ite<a name='202'>
         del(i,k)=prsll(i,k)*g/r_d*dz8w(i,k,j)/t3d(i,k,j)<a name='203'>
         u1(i,k)=u3d(i,k,j)<a name='204'>
         v1(i,k)=v3d(i,k,j)<a name='205'>
         q1(i,k)=qv3d(i,k,j)<a name='206'>
<font color=#447700>!        q1(i,k)=qv3d(i,k,j)/(1.+qv3d(i,k,j))<a name='207'></font>
         t1(i,k)=t3d(i,k,j)<a name='208'>
         qi2(i,k) = qi3d(i,k,j)<a name='209'>
         qc2(i,k) = qc3d(i,k,j)<a name='210'>
       enddo<a name='211'>
     enddo<a name='212'>
<font color=#447700>!<a name='213'></font>
<font color=#447700>! NCEP SAS <a name='214'></font>
<font color=#447700>!<a name='215'></font>
     call <A href='../../html_code/phys/module_cu_nsas.F.html#NSAS2D'>nsas2d</A><A href='../../html_code/phys/module_cu_nsas.F.html#CU_NSAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NSAS2D_1">(delt=delt,delx=dx,del=del(its,kts),                           &amp;<a name='216'>
              prsl=prsll(its,kts),prsi=prsii(its,kts),prslk=pi3d(ims,kms,j),   &amp;<a name='217'>
              zl=zll(its,kts),                                                 &amp;<a name='218'>
              ncloud=ncloud,qc2=qc2(its,kts),qi2=qi2(its,kts),                 &amp;<a name='219'>
              q1=q1(its,kts),t1=t1(its,kts),rain=rain(its),                    &amp;<a name='220'>
              kbot=kbot(its),ktop=ktop(its),                                   &amp;<a name='221'>
              icps=icps(its),                                                  &amp;<a name='222'>
              lat=j,slimsk=xland(ims,j),dot=dot(its,kts),                      &amp;<a name='223'>
              u1=u1(its,kts), v1=v1(its,kts),                                  &amp;<a name='224'>
              cp_=cp,cliq_=cliq,cvap_=cpv,g_=g,hvap_=xlv,                      &amp;<a name='225'>
              rd_=r_d,rv_=r_v,fv_=ep_1,ep2=ep_2,                               &amp;<a name='226'>
              cice=cice,xls=xls,psat=psat,                                     &amp;<a name='227'>
              pgcon=pgcon_use,                                                 &amp;<a name='228'>
              dx_factor_nsas=dx_factor_nsas,                                   &amp;<a name='229'>
              ids=ids,ide=ide, jds=jds,jde=jde, kds=kds,kde=kde,               &amp;<a name='230'>
              ims=ims,ime=ime, jms=jms,jme=jme, kms=kms,kme=kme,               &amp;<a name='231'>
              its=its,ite=ite, jts=jts,jte=jte, kts=kts,kte=kte   )<a name='232'>
<font color=#447700>!<a name='233'></font>
     do i = its,ite<a name='234'>
       pratec1(i,j)=rain(i)*1000./(stepcu*dt)<a name='235'>
       raincv1(i,j)=rain(i)*1000./(stepcu)<a name='236'>
     enddo<a name='237'>
<font color=#447700>!<a name='238'></font>
<font color=#447700>! NCEP SCV<a name='239'></font>
<font color=#447700>!<a name='240'></font>
     call <A href='../../html_code/phys/module_cu_nsas.F.html#NSCV2D'>nscv2d</A><A href='../../html_code/phys/module_cu_nsas.F.html#CU_NSAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NSCV2D_1">(delt=delt,del=del(its,kts),prsl=prsll(its,kts),               &amp;<a name='241'>
              prsi=prsii(its,kts),prslk=pi3d(ims,kms,j),zl=zll(its,kts),       &amp;<a name='242'>
              ncloud=ncloud,qc2=qc2(its,kts),qi2=qi2(its,kts),                 &amp;<a name='243'>
              q1=q1(its,kts),t1=t1(its,kts),rain=rain(its),                    &amp;<a name='244'>
              kbot=kbot(its),ktop=ktop(its),                                   &amp;<a name='245'>
              icps=icps(its),                                                  &amp;<a name='246'>
              slimsk=xland(ims,j),dot=dot(its,kts),                            &amp;<a name='247'>
              u1=u1(its,kts), v1=v1(its,kts),                                  &amp;<a name='248'>
              cp_=cp,cliq_=cliq,cvap_=cpv,g_=g,hvap_=xlv,                      &amp;<a name='249'>
              rd_=r_d,rv_=r_v,fv_=ep_1,ep2=ep_2,                               &amp;<a name='250'>
              cice=cice,xls=xls,psat=psat,                                     &amp;<a name='251'>
              hpbl=hpbl(ims,j),hfx=hfx(ims,j),qfx=qfx(ims,j),                  &amp;<a name='252'>
              pgcon=pgcon_use,                                                 &amp;<a name='253'>
              ids=ids,ide=ide, jds=jds,jde=jde, kds=kds,kde=kde,               &amp;<a name='254'>
              ims=ims,ime=ime, jms=jms,jme=jme, kms=kms,kme=kme,               &amp;<a name='255'>
              its=its,ite=ite, jts=jts,jte=jte, kts=kts,kte=kte   )<a name='256'>
<font color=#447700>!<a name='257'></font>
     do i = its,ite<a name='258'>
       pratec2(i,j)=rain(i)*1000./(stepcu*dt)<a name='259'>
       raincv2(i,j)=rain(i)*1000./(stepcu)<a name='260'>
     enddo<a name='261'>
<font color=#447700>!<a name='262'></font>
     do i = its,ite<a name='263'>
       raincv(i,j) = raincv1(i,j) + raincv2(i,j)<a name='264'>
       pratec(i,j) = pratec1(i,j) + pratec2(i,j)<a name='265'>
       hbot(i,j) = kbot(i)<a name='266'>
       htop(i,j) = ktop(i)<a name='267'>
     enddo<a name='268'>
<font color=#447700>!<a name='269'></font>
     IF(PRESENT(rthcuten).AND.PRESENT(rqvcuten)) THEN<a name='270'>
       do k = kts,kte<a name='271'>
         do i = its,ite<a name='272'>
           rthcuten(i,k,j)=(t1(i,k)-t3d(i,k,j))/pi3d(i,k,j)*rdelt<a name='273'>
           rqvcuten(i,k,j)=(q1(i,k)-qv3d(i,k,j))*rdelt<a name='274'>
         enddo<a name='275'>
       enddo<a name='276'>
     ENDIF<a name='277'>
<font color=#447700>!<a name='278'></font>
     IF(PRESENT(rucuten).AND.PRESENT(rvcuten)) THEN<a name='279'>
       do k = kts,kte<a name='280'>
         do i = its,ite<a name='281'>
           rucuten(i,k,j)=(u1(i,k)-u3d(i,k,j))*rdelt<a name='282'>
           rvcuten(i,k,j)=(v1(i,k)-v3d(i,k,j))*rdelt<a name='283'>
         enddo<a name='284'>
       enddo<a name='285'>
     ENDIF<a name='286'>
<font color=#447700>!<a name='287'></font>
     IF(PRESENT( rqicuten )) THEN<a name='288'>
       IF ( F_QI ) THEN<a name='289'>
         do k = kts,kte<a name='290'>
           do i = its,ite<a name='291'>
             rqicuten(i,k,j)=(qi2(i,k)-qi3d(i,k,j))*rdelt<a name='292'>
           enddo<a name='293'>
         enddo<a name='294'>
       ENDIF<a name='295'>
     ENDIF<a name='296'>
<font color=#447700>!<a name='297'></font>
     IF(PRESENT( rqccuten )) THEN<a name='298'>
       IF ( F_QC ) THEN<a name='299'>
         do k = kts,kte<a name='300'>
           do i = its,ite<a name='301'>
             rqccuten(i,k,j)=(qc2(i,k)-qc3d(i,k,j))*rdelt<a name='302'>
           enddo<a name='303'>
         enddo<a name='304'>
       ENDIF<a name='305'>
     ENDIF<a name='306'>
<font color=#447700>!<a name='307'></font>
   enddo <font color=#447700>! outer most J_loop<a name='308'></font>
<font color=#447700>!<a name='309'></font>
   return<a name='310'>
   end subroutine cu_nsas<a name='311'>
<font color=#447700>!<a name='312'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='313'></font>
<font color=#447700>! NCEP SAS (Deep Convection Scheme)<a name='314'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='315'></font>
<A NAME='NSAS2D'><A href='../../html_code/phys/module_cu_nsas.F.html#NSAS2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='316'>
   <font color=#993300>subroutine </font><font color=#cc0000>nsas2d</font>(delt,delx,del,prsl,prsi,prslk,zl,                         &amp; <A href='../../call_to/NSAS2D.html' TARGET='index'>1</A><a name='317'>
            ncloud,                                                            &amp; <a name='318'>
            qc2,qi2,                                                           &amp; <a name='319'>
            q1,t1,rain,kbot,ktop,                                              &amp;<a name='320'>
            icps,                                                              &amp;<a name='321'>
            lat,slimsk,dot,u1,v1,cp_,cliq_,cvap_,g_,hvap_,rd_,rv_,fv_,ep2,     &amp;<a name='322'>
            cice,xls,psat,                                                     &amp;<a name='323'>
            pgcon,                                                             &amp;<a name='324'>
            dx_factor_nsas,                                                    &amp;<a name='325'>
            ids,ide, jds,jde, kds,kde,                                         &amp;<a name='326'>
            ims,ime, jms,jme, kms,kme,                                         &amp;<a name='327'>
            its,ite, jts,jte, kts,kte)<a name='328'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='329'></font>
<font color=#447700>!<a name='330'></font>
<font color=#447700>! subprogram:    phys_cps_sas      computes convective heating and moistening<a name='331'></font>
<font color=#447700>!                                                      and momentum transport<a name='332'></font>
<font color=#447700>!<a name='333'></font>
<font color=#447700>! abstract: computes convective heating and moistening using a one<a name='334'></font>
<font color=#447700>!   cloud type arakawa-schubert convection scheme originally developed<a name='335'></font>
<font color=#447700>!   by georg grell. the scheme has been revised at ncep since initial <a name='336'></font>
<font color=#447700>!   implementation in 1993. it includes updraft and downdraft effects.<a name='337'></font>
<font color=#447700>!   the closure is the cloud work function. both updraft and downdraft<a name='338'></font>
<font color=#447700>!   are assumed to be saturated and the heating and moistening are<a name='339'></font>
<font color=#447700>!   accomplished by the compensating environment. convective momentum transport<a name='340'></font>
<font color=#447700>!   is taken into account. the name comes from "simplified arakawa-schubert<a name='341'></font>
<font color=#447700>!   convection parameterization".<a name='342'></font>
<font color=#447700>!<a name='343'></font>
<font color=#447700>! developed by hua-lu pan, wan-shu wu, songyou hong, and jongil han<a name='344'></font>
<font color=#447700>!   implemented into wrf by kyosun sunny lim and songyou hong<a name='345'></font>
<font color=#447700>!   module with cpp-based options is available in grims <a name='346'></font>
<font color=#447700>!<a name='347'></font>
<font color=#447700>! program history log:<a name='348'></font>
<font color=#447700>!   92-03-01  hua-lu pan       operational development<a name='349'></font>
<font color=#447700>!   96-03-01  song-you hong    revised closure, and trigger <a name='350'></font>
<font color=#447700>!   99-03-01  hua-lu pan       multiple clouds<a name='351'></font>
<font color=#447700>!   06-03-01  young-hwa byun   closure based on moisture convergence (optional)<a name='352'></font>
<font color=#447700>!   09-10-01  jung-eun kim     f90 format with standard physics modules<a name='353'></font>
<font color=#447700>!   10-07-01  jong-il han      revised cloud model,trigger, as in gfs july 2010<a name='354'></font>
<font color=#447700>!   10-12-01  kyosun sunny lim wrf compatible version<a name='355'></font>
<font color=#447700>!   14-01-09  song-you hong    dx dependent trigger, closure, and mass flux<a name='356'></font>
<font color=#447700>!<a name='357'></font>
<font color=#447700>!<a name='358'></font>
<font color=#447700>! usage:    call phys_cps_sas(delt,delx,del,prsl,prsi,prslk,prsik,zl,          &amp;<a name='359'></font>
<font color=#447700>!                             q2,q1,t1,u1,v1,rcs,slimsk,dot,cldwrk,rain,       &amp;<a name='360'></font>
<font color=#447700>!                             jcap,ncloud,lat,kbot,ktop,icps,                  &amp;<a name='361'></font>
<font color=#447700>!                             ids,ide, jds,jde, kds,kde,                       &amp;<a name='362'></font>
<font color=#447700>!                             ims,ime, jms,jme, kms,kme,                       &amp;<a name='363'></font>
<font color=#447700>!                             its,ite, jts,jte, kts,kte)<a name='364'></font>
<font color=#447700>!<a name='365'></font>
<font color=#447700>!   delt     - real model integration time step<a name='366'></font>
<font color=#447700>!   delx     - real model grid interval<a name='367'></font>
<font color=#447700>!   del      - real (kms:kme) sigma layer thickness<a name='368'></font>
<font color=#447700>!   prsl     - real (ims:ime,kms:kme) pressure values<a name='369'></font>
<font color=#447700>!   prsi     - real (ims:ime,kms:kme) pressure values at interface level<a name='370'></font>
<font color=#447700>!   prslk    - real (ims:ime,kms:kme) pressure values to the kappa<a name='371'></font>
<font color=#447700>!   prsik    - real (ims:ime,kms:kme) pressure values to the kappa at interface lev.<a name='372'></font>
<font color=#447700>!   zl       - real (ims:ime,kms:kme) height above sea level<a name='373'></font>
<font color=#447700>!   zi       - real (ims:ime,kms:kme) height above sea level at interface level<a name='374'></font>
<font color=#447700>!   rcs      - real<a name='375'></font>
<font color=#447700>!   slimsk   - real (ims:ime) land(1),sea(0), ice(2) flag<a name='376'></font>
<font color=#447700>!   dot      - real (ims:ime,kms:kme) vertical velocity<a name='377'></font>
<font color=#447700>!   jcap     - integer wave number <a name='378'></font>
<font color=#447700>!   ncloud   - integer no_cloud(0),no_ice(1),cloud+ice(2) <a name='379'></font>
<font color=#447700>!   lat      - integer  current latitude index<a name='380'></font>
<font color=#447700>!<a name='381'></font>
<font color=#447700>! output argument list:<a name='382'></font>
<font color=#447700>!   q2       - real (ims:ime,kms:kme) detrained hydrometeors in kg/kg<a name='383'></font>
<font color=#447700>!            - in case of the  --&gt; qc2(cloud), qi2(ice)<a name='384'></font>
<font color=#447700>!   q1       - real (ims:ime,kms:kme) adjusted specific humidity in kg/kg<a name='385'></font>
<font color=#447700>!   t1       - real (ims:ime,kms:kme) adjusted temperature in kelvin<a name='386'></font>
<font color=#447700>!   u1       - real (ims:ime,kms:kme) adjusted zonal wind in m/s<a name='387'></font>
<font color=#447700>!   v1       - real (ims:ime,kms:kme) adjusted meridional wind in m/s<a name='388'></font>
<font color=#447700>!   cldwrk   - real (ims:ime) cloud work function<a name='389'></font>
<font color=#447700>!   rain     - real (ims:ime) convective rain in meters<a name='390'></font>
<font color=#447700>!   kbot     - integer (ims:ime) cloud bottom level<a name='391'></font>
<font color=#447700>!   ktop     - integer (ims:ime) cloud top level<a name='392'></font>
<font color=#447700>!   icps     - integer (ims:ime) bit flag indicating deep convection<a name='393'></font>
<font color=#447700>!<a name='394'></font>
<font color=#447700>! subprograms called:<a name='395'></font>
<font color=#447700>!   fpvs     - function to compute saturation vapor pressure<a name='396'></font>
<font color=#447700>!<a name='397'></font>
<font color=#447700>! remarks: function fpvs is inlined by fpp.<a name='398'></font>
<font color=#447700>!          nonstandard automatic arrays are used.<a name='399'></font>
<font color=#447700>!<a name='400'></font>
<font color=#447700>! references :<a name='401'></font>
<font color=#447700>!   pan and wu    (1995, ncep office note)<a name='402'></font>
<font color=#447700>!   hong and pan  (1998, mon wea rev)<a name='403'></font>
<font color=#447700>!   park and hong (2007,jmsj)<a name='404'></font>
<font color=#447700>!   byun and hong (2007, mon wea rev)<a name='405'></font>
<font color=#447700>!   han and pan   (2011, wea. forecasting)<a name='406'></font>
<font color=#447700>!<a name='407'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='408'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='409'></font>
   implicit none<a name='410'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='411'></font>
<font color=#447700>!<a name='412'></font>
<font color=#447700>! model tunable parameters <a name='413'></font>
<font color=#447700>!<a name='414'></font>
   real,parameter  ::  alphal = 0.5,    alphas = 0.5<a name='415'>
   real,parameter  ::  betal  = 0.05,   betas  = 0.05<a name='416'>
   real,parameter  ::  pdpdwn = 0.0,    pdetrn = 200.0<a name='417'>
   real,parameter  ::  c0     = 0.002,  c1     = 0.002<a name='418'>
   real,parameter  ::  xlamdd = 1.0e-4, xlamde = 1.0e-4<a name='419'>
   real,parameter  ::  clam   = 0.1,    cxlamu = 1.0e-4<a name='420'>
   real,parameter  ::  aafac  = 0.1<a name='421'>
   real,parameter  ::  dthk=25.<a name='422'>
   real,parameter  ::  cincrmax = 180.,cincrmin = 120.<a name='423'>
   real,parameter  ::  mbdt = 10., edtmaxl = 0.3, edtmaxs = 0.3<a name='424'>
   real,parameter  ::  evfacts = 0.3, evfactl = 0.3<a name='425'>
<font color=#447700>!<a name='426'></font>
   real,parameter  ::  tf=233.16,tcr=263.16,tcrf=1.0/(tcr-tf)<a name='427'>
   real,parameter  ::  xk1=2.e-5,xlhor=3.e4,xhver=5000.,theimax=1.<a name='428'>
   real,parameter  ::  xc1=1.e-7,xc2=1.e4,xc3=3.e3,ecesscr=3.0,edtk1=3.e4<a name='429'>
<font color=#447700>!<a name='430'></font>
<font color=#447700>!  passing variables<a name='431'></font>
<font color=#447700>!<a name='432'></font>
   real            ::  cp_,cliq_,cvap_,g_,hvap_,rd_,rv_,fv_,ep2<a name='433'>
   real            ::  pi_,qmin_,t0c_,cice,xlv0,xls,psat<a name='434'>
   real            ::  pgcon<a name='435'>
   integer         ::  dx_factor_nsas<a name='436'>
   integer         ::  lat,                                                    &amp;<a name='437'>
                       ncloud,                                                 &amp;<a name='438'>
                       ids,ide, jds,jde, kds,kde,                              &amp;<a name='439'>
                       ims,ime, jms,jme, kms,kme,                              &amp;<a name='440'>
                       its,ite, jts,jte, kts,kte<a name='441'>
<font color=#447700>!<a name='442'></font>
   real            ::  delt,rcs<a name='443'>
   real            ::  del(its:ite,kts:kte),                                   &amp;<a name='444'>
                       prsl(its:ite,kts:kte),prslk(ims:ime,kms:kme),           &amp;<a name='445'>
                       prsi(its:ite,kts:kte+1),                                &amp;<a name='446'>
                       zl(its:ite,kts:kte),                                    &amp;<a name='447'>
                       q1(its:ite,kts:kte),t1(its:ite,kts:kte),                &amp;<a name='448'>
                       u1(its:ite,kts:kte),v1(its:ite,kts:kte),                &amp;<a name='449'>
                       dot(its:ite,kts:kte)<a name='450'>
   real            ::  qi2(its:ite,kts:kte)<a name='451'>
   real            ::  qc2(its:ite,kts:kte)<a name='452'>
<font color=#447700>!<a name='453'></font>
   real            ::  rain(its:ite)<a name='454'>
   integer         ::  kbot(its:ite),ktop(its:ite),icps(its:ite)<a name='455'>
   real            ::  slimsk(ims:ime)<a name='456'>
<font color=#447700>!<a name='457'></font>
<font color=#447700>!<a name='458'></font>
<font color=#447700>!  local variables and arrays<a name='459'></font>
<font color=#447700>!<a name='460'></font>
   integer         ::  i,k,kmax,kbmax,kbm,jmn,indx,indp,kts1,kte1,kmax1,kk<a name='461'>
   real            ::  p(its:ite,kts:kte),pdot(its:ite),acrtfct(its:ite)<a name='462'>
   real            ::  zi(its:ite,kts:kte+1)<a name='463'>
   real            ::  uo(its:ite,kts:kte),vo(its:ite,kts:kte)<a name='464'>
   real            ::  to(its:ite,kts:kte),qo(its:ite,kts:kte)<a name='465'>
   real            ::  hcko(its:ite,kts:kte)<a name='466'>
   real            ::  qcko(its:ite,kts:kte),eta(its:ite,kts:kte)<a name='467'>
   real            ::  etad(its:ite,kts:kte)<a name='468'>
   real            ::  qrcdo(its:ite,kts:kte)<a name='469'>
   real            ::  pwo(its:ite,kts:kte),pwdo(its:ite,kts:kte)<a name='470'>
   real            ::  dtconv(its:ite)<a name='471'>
   real            ::  deltv(its:ite),acrt(its:ite)<a name='472'>
   real            ::  qeso(its:ite,kts:kte)<a name='473'>
   real            ::  tvo(its:ite,kts:kte),dbyo(its:ite,kts:kte)<a name='474'>
   real            ::  heo(its:ite,kts:kte),heso(its:ite,kts:kte)<a name='475'>
   real            ::  qrcd(its:ite,kts:kte)<a name='476'>
   real            ::  dellah(its:ite,kts:kte),dellaq(its:ite,kts:kte)<a name='477'>
<font color=#447700>!<a name='478'></font>
   integer         ::  kb(its:ite),kbcon(its:ite)<a name='479'>
   integer         ::  kbcon1(its:ite)<a name='480'>
   real            ::  hmax(its:ite),delq(its:ite)<a name='481'>
   real            ::  hkbo(its:ite),qkbo(its:ite),pbcdif(its:ite)<a name='482'>
   integer         ::  kbds(its:ite),lmin(its:ite),jmin(its:ite)<a name='483'>
   integer         ::  ktcon(its:ite)<a name='484'>
   integer         ::  ktcon1(its:ite)<a name='485'>
   integer         ::  kbdtr(its:ite)<a name='486'>
   integer         ::  klcl(its:ite),ktdown(its:ite)<a name='487'>
   real            ::  vmax(its:ite)<a name='488'>
   real            ::  hmin(its:ite),pwavo(its:ite)<a name='489'>
   real            ::  aa1(its:ite),vshear(its:ite)<a name='490'>
   real            ::  qevap(its:ite)<a name='491'>
   real            ::  edt(its:ite)<a name='492'>
   real            ::  edto(its:ite),pwevo(its:ite)<a name='493'>
   real            ::  qcond(its:ite)<a name='494'>
   real            ::  hcdo(its:ite,kts:kte)<a name='495'>
   real            ::  ddp(its:ite),pp2(its:ite)<a name='496'>
   real            ::  qcdo(its:ite,kts:kte)<a name='497'>
   real            ::  adet(its:ite),aatmp(its:ite)<a name='498'>
   real            ::  xhkb(its:ite),xqkb(its:ite)<a name='499'>
   real            ::  xpwav(its:ite),xpwev(its:ite),xhcd(its:ite,kts:kte)<a name='500'>
   real            ::  xaa0(its:ite),f(its:ite),xk(its:ite)<a name='501'>
   real            ::  xmb(its:ite)<a name='502'>
   real            ::  edtx(its:ite),xqcd(its:ite,kts:kte)<a name='503'>
   real            ::  hsbar(its:ite),xmbmax(its:ite)<a name='504'>
   real            ::  xlamb(its:ite,kts:kte),xlamd(its:ite)<a name='505'>
   real            ::  excess(its:ite)<a name='506'>
   real            ::  plcl(its:ite)<a name='507'>
   real            ::  delhbar(its:ite),delqbar(its:ite),deltbar(its:ite)<a name='508'>
   real,save       ::  pcrit(15), acritt(15)<a name='509'>
   real            ::  acrit(15)<a name='510'>
   real            ::  qcirs(its:ite,kts:kte),qrski(its:ite)<a name='511'>
   real            ::  dellal(its:ite,kts:kte)<a name='512'>
   real            ::  rntot(its:ite),delqev(its:ite),delq2(its:ite) <a name='513'>
<font color=#447700>!<a name='514'></font>
   real            ::  fent1(its:ite,kts:kte),fent2(its:ite,kts:kte)<a name='515'>
   real            ::  frh(its:ite,kts:kte)<a name='516'>
   real            ::  xlamud(its:ite),sumx(its:ite)<a name='517'>
   real            ::  aa2(its:ite)<a name='518'>
   real            ::  ucko(its:ite,kts:kte),vcko(its:ite,kts:kte)<a name='519'>
   real            ::  ucdo(its:ite,kts:kte),vcdo(its:ite,kts:kte)<a name='520'>
   real            ::  dellau(its:ite,kts:kte),dellav(its:ite,kts:kte)<a name='521'>
   real            ::  delubar(its:ite),delvbar(its:ite)<a name='522'>
   real            ::  qlko_ktcon(its:ite)<a name='523'>
<font color=#447700>!<a name='524'></font>
   real            ::  alpha,beta,                                             &amp;<a name='525'>
                       dt2,dtmin,dtmax,dtmaxl,dtmaxs,                          &amp;<a name='526'>
                       el2orc,eps,fact1,fact2,                                 &amp;<a name='527'>
                       tem,tem1,cincr<a name='528'>
   real            ::  dz,dp,es,pprime,qs,                                     &amp;<a name='529'>
                       dqsdp,desdt,dqsdt,gamma,                                &amp;<a name='530'>
                       dt,dq,po,thei,delx,delza,dzfac,                         &amp;<a name='531'>
                       thec,theb,thekb,thekh,theavg,thedif,                    &amp;<a name='532'>
                       omgkb,omgkbp1,omgdif,omgfac,heom,rh,thermal,chi,        &amp;<a name='533'>
                       factor,onemf,dz1,qrch,etah,qlk,qc,rfact,shear,          &amp;<a name='534'>
                       e1,dh,deta,detad,theom,edtmax,dhh,dg,aup,adw,           &amp;<a name='535'>
                       dv1,dv2,dv3,dv1q,dv2q,dv3q,dvq1,                        &amp;<a name='536'>
                       dv1u,dv2u,dv3u,dv1v,dv2v,dv3v,                          &amp;<a name='537'>
                       dellat,xdby,xqrch,xqc,xpw,xpwd,                         &amp;<a name='538'>
                       W1l,W2l,W3l,W4l,W1s,W2s,W3s,W4s,                        &amp; <a name='539'>
                       w1,w2,w3,w4,qrsk(its:ite,kts:kte),evef,ptem,ptem1<a name='540'>
<font color=#447700>!<a name='541'></font>
   logical         ::  totflg, cnvflg(its:ite),flg(its:ite),lclflg<a name='542'>
   real            ::  dx_factor<a name='543'>
<font color=#447700>!<a name='544'></font>
<font color=#447700>!  climatological critical cloud work functions for closure<a name='545'></font>
<font color=#447700>!<a name='546'></font>
   data pcrit/850.,800.,750.,700.,650.,600.,550.,500.,450.,400.,               &amp;<a name='547'>
              350.,300.,250.,200.,150./<a name='548'>
   data acritt/.0633,.0445,.0553,.0664,.075,.1082,.1521,.2216,                 &amp;<a name='549'>
              .3151,.3677,.41,.5255,.7663,1.1686,1.6851/<a name='550'>
<font color=#447700>!<a name='551'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='552'></font>
<font color=#447700>!<a name='553'></font>
<font color=#447700>! define miscellaneous values<a name='554'></font>
<font color=#447700>!<a name='555'></font>
   pi_   = 3.14159<a name='556'>
   qmin_ = 1.0e-30<a name='557'>
   t0c_ = 273.15<a name='558'>
   xlv0 = hvap_<a name='559'>
   rcs  = 1.<a name='560'>
   el2orc = hvap_*hvap_/(rv_*cp_)<a name='561'>
   eps    = rd_/rv_<a name='562'>
   fact1  = (cvap_-cliq_)/rv_<a name='563'>
   fact2  = hvap_/rv_-fact1*t0c_<a name='564'>
   kts1 = kts + 1<a name='565'>
   kte1 = kte - 1<a name='566'>
   dt2    = delt<a name='567'>
   dtmin  = max(dt2,1200.)<a name='568'>
   dtmax  = max(dt2,3600.)<a name='569'>
<font color=#447700>!<a name='570'></font>
   if (dx_factor_nsas == 1) then<a name='571'>
   dx_factor = 250. / delx <font color=#447700>! assume 2.5 ms-1 (1km) and 1.125 cms-1 (200km)<a name='572'></font>
   W1l = dx_factor * 0.1 * (-1.)<a name='573'>
   W2l = dx_factor * (-1.)<a name='574'>
   W3l = dx_factor * (-1.)<a name='575'>
   W4l = dx_factor * 0.1 * (-1.)<a name='576'>
   W1s = W1l<a name='577'>
   W2s = W2l<a name='578'>
   W3s = W3l<a name='579'>
   W4s = W4l<a name='580'>
   else <a name='581'>
   W1l = -8.E-3<a name='582'>
   W2l = -4.E-2<a name='583'>
   W3l = -5.E-3<a name='584'>
   W4l = -5.E-4<a name='585'>
   W1s = -2.E-4<a name='586'>
   W2s = -2.E-3<a name='587'>
   W3s = -1.E-3<a name='588'>
   W4s = -2.E-5<a name='589'>
   endif<a name='590'>
<font color=#447700>!<a name='591'></font>
<font color=#447700>!  initialize arrays<a name='592'></font>
<font color=#447700>!<a name='593'></font>
   lclflg = .true.<a name='594'>
   do i = its,ite<a name='595'>
     rain(i)     = 0.0<a name='596'>
     kbot(i)   = kte+1<a name='597'>
     ktop(i)   = 0<a name='598'>
     icps(i)   = 0<a name='599'>
     cnvflg(i) = .true.<a name='600'>
     dtconv(i) = 3600.<a name='601'>
     pdot(i)   = 0.0<a name='602'>
     edto(i)   = 0.0<a name='603'>
     edtx(i)   = 0.0<a name='604'>
     xmbmax(i) = 0.3<a name='605'>
     excess(i) = 0.0<a name='606'>
     plcl(i)   = 0.0<a name='607'>
     aa2(i) = 0.0<a name='608'>
     qlko_ktcon(i) = 0.0<a name='609'>
     pbcdif(i)= 0.0<a name='610'>
     lmin(i) = 1<a name='611'>
     jmin(i) = 1<a name='612'>
     edt(i) = 0.0<a name='613'>
   enddo<a name='614'>
<font color=#447700>!<a name='615'></font>
   do k = 1,15<a name='616'>
     acrit(k) = acritt(k) * (975. - pcrit(k))<a name='617'>
   enddo<a name='618'>
<font color=#447700>!<a name='619'></font>
<font color=#447700>! Define top layer for search of the downdraft originating layer<a name='620'></font>
<font color=#447700>! and the maximum thetae for updraft<a name='621'></font>
<font color=#447700>!<a name='622'></font>
   kbmax = kte <a name='623'>
   kbm   = kte <a name='624'>
   kmax  = kte <a name='625'>
   do k = kts,kte <a name='626'>
     do i = its,ite <a name='627'>
       if(prsl(i,k).gt.prsi(i,1)*0.45) kbmax = k + 1 <a name='628'>
       if(prsl(i,k).gt.prsi(i,1)*0.70) kbm   = k + 1 <a name='629'>
       if(prsl(i,k).gt.prsi(i,1)*0.04) kmax  = k + 1 <a name='630'>
     enddo <a name='631'>
   enddo <a name='632'>
   kmax = min(kmax,kte)<a name='633'>
   kmax1 = kmax - 1<a name='634'>
   kbm = min(kbm,kte)<a name='635'>
<font color=#447700>!<a name='636'></font>
<font color=#447700>! convert surface pressure to mb from cb<a name='637'></font>
<font color=#447700>!<a name='638'></font>
   do k = kts,kte<a name='639'>
     do i = its,ite<a name='640'>
       pwo(i,k)  = 0.0<a name='641'>
       pwdo(i,k) = 0.0<a name='642'>
       dellal(i,k) = 0.0<a name='643'>
       hcko(i,k) = 0.0<a name='644'>
       qcko(i,k) = 0.0<a name='645'>
       hcdo(i,k) = 0.0<a name='646'>
       qcdo(i,k) = 0.0<a name='647'>
     enddo<a name='648'>
   enddo<a name='649'>
<font color=#447700>!<a name='650'></font>
   do k = kts,kmax<a name='651'>
     do i = its,ite<a name='652'>
       p(i,k) = prsl(i,k) * 10.<a name='653'>
       pwo(i,k) = 0.0<a name='654'>
       pwdo(i,k) = 0.0<a name='655'>
       to(i,k) = t1(i,k)<a name='656'>
       qo(i,k) = q1(i,k)<a name='657'>
       dbyo(i,k) = 0.0<a name='658'>
       fent1(i,k) = 1.0<a name='659'>
       fent2(i,k) = 1.0<a name='660'>
       frh(i,k) = 0.0<a name='661'>
       ucko(i,k) = 0.0<a name='662'>
       vcko(i,k) = 0.0<a name='663'>
       ucdo(i,k) = 0.0<a name='664'>
       vcdo(i,k) = 0.0<a name='665'>
       uo(i,k) = u1(i,k) * rcs<a name='666'>
       vo(i,k) = v1(i,k) * rcs<a name='667'>
     enddo<a name='668'>
   enddo<a name='669'>
<font color=#447700>!<a name='670'></font>
<font color=#447700>! column variables<a name='671'></font>
<font color=#447700>!<a name='672'></font>
<font color=#447700>!  p is pressure of the layer (mb)<a name='673'></font>
<font color=#447700>!  t is temperature at t-dt (k)..tn<a name='674'></font>
<font color=#447700>!  q is mixing ratio at t-dt (kg/kg)..qn<a name='675'></font>
<font color=#447700>!  to is temperature at t+dt (k)... this is after advection and turbulan<a name='676'></font>
<font color=#447700>!  qo is mixing ratio at t+dt (kg/kg)..q1<a name='677'></font>
<font color=#447700>!<a name='678'></font>
   do k = kts,kmax<a name='679'>
     do i = its,ite<a name='680'>
       qeso(i,k)=0.01*fpvs(to(i,k),1,rd_,rv_,cvap_,cliq_,cice,xlv0,xls,psat,t0c_)<a name='681'>
       qeso(i,k) = eps * qeso(i,k) / (p(i,k) + (eps-1.) * qeso(i,k))<a name='682'>
       qeso(i,k) = max(qeso(i,k),qmin_)<a name='683'>
       qo(i,k)   = max(qo(i,k), 1.e-10 )<a name='684'>
       tvo(i,k)  = to(i,k) + fv_ * to(i,k) * max(qo(i,k),qmin_)<a name='685'>
     enddo<a name='686'>
   enddo<a name='687'>
<font color=#447700>!<a name='688'></font>
<font color=#447700>! compute moist static energy<a name='689'></font>
<font color=#447700>!<a name='690'></font>
   do k = kts,kmax<a name='691'>
     do i = its,ite<a name='692'>
       heo(i,k)  = g_ * zl(i,k) + cp_* to(i,k) + hvap_ * qo(i,k)<a name='693'>
       heso(i,k) = g_ * zl(i,k) + cp_* to(i,k) + hvap_ * qeso(i,k)<a name='694'>
     enddo<a name='695'>
   enddo<a name='696'>
<font color=#447700>!<a name='697'></font>
<font color=#447700>! Determine level with largest moist static energy<a name='698'></font>
<font color=#447700>! This is the level where updraft starts<a name='699'></font>
<font color=#447700>!<a name='700'></font>
   do i = its,ite<a name='701'>
     hmax(i) = heo(i,1)<a name='702'>
     kb(i) = 1<a name='703'>
   enddo<a name='704'>
<font color=#447700>!<a name='705'></font>
   do k = kts1,kbm<a name='706'>
     do i = its,ite<a name='707'>
       if(heo(i,k).gt.hmax(i)) then<a name='708'>
         kb(i) = k<a name='709'>
         hmax(i) = heo(i,k)<a name='710'>
       endif<a name='711'>
     enddo<a name='712'>
   enddo<a name='713'>
<font color=#447700>!<a name='714'></font>
   do k = kts,kmax1<a name='715'>
     do i = its,ite<a name='716'>
       if(cnvflg(i)) then<a name='717'>
         dz = .5 * (zl(i,k+1) - zl(i,k))<a name='718'>
         dp = .5 * (p(i,k+1) - p(i,k))<a name='719'>
         es = 0.01*fpvs(to(i,k+1),1,rd_,rv_,cvap_,cliq_,cice,xlv0,xls,psat,t0c_)<a name='720'>
         pprime = p(i,k+1) + (eps-1.) * es<a name='721'>
         qs = eps * es / pprime<a name='722'>
         dqsdp = - qs / pprime<a name='723'>
         desdt = es * (fact1 / to(i,k+1) + fact2 / (to(i,k+1)**2))<a name='724'>
         dqsdt = qs * p(i,k+1) * desdt / (es * pprime)<a name='725'>
         gamma = el2orc * qeso(i,k+1) / (to(i,k+1)**2)<a name='726'>
         dt = (g_ * dz + hvap_ * dqsdp * dp) / (cp_ * (1. + gamma))<a name='727'>
         dq = dqsdt * dt + dqsdp * dp<a name='728'>
         to(i,k) = to(i,k+1) + dt<a name='729'>
         qo(i,k) = qo(i,k+1) + dq<a name='730'>
         po = .5 * (p(i,k) + p(i,k+1))<a name='731'>
         qeso(i,k)=0.01*fpvs(to(i,k),1,rd_,rv_,cvap_,cliq_,cice,xlv0,xls,psat,t0c_)<a name='732'>
         qeso(i,k) = eps * qeso(i,k) / (po + (eps-1.) * qeso(i,k))<a name='733'>
         qeso(i,k) = max(qeso(i,k),qmin_)<a name='734'>
         qo(i,k)   = max(qo(i,k), 1.e-10)<a name='735'>
         frh(i,k)  = 1. - min(qo(i,k)/qeso(i,k), 1.)<a name='736'>
         heo(i,k)  = .5 * g_ * (zl(i,k) + zl(i,k+1)) +                          &amp;<a name='737'>
                cp_ * to(i,k) + hvap_ * qo(i,k)<a name='738'>
         heso(i,k) = .5 * g_ * (zl(i,k) + zl(i,k+1)) +                          &amp;<a name='739'>
                cp_ * to(i,k) + hvap_ * qeso(i,k)<a name='740'>
         uo(i,k)   = .5 * (uo(i,k) + uo(i,k+1))<a name='741'>
         vo(i,k)   = .5 * (vo(i,k) + vo(i,k+1))<a name='742'>
       endif<a name='743'>
     enddo<a name='744'>
   enddo<a name='745'>
<font color=#447700>!<a name='746'></font>
<font color=#447700>! look for convective cloud base as the level of free convection<a name='747'></font>
<font color=#447700>!<a name='748'></font>
   do i = its,ite<a name='749'>
     if(cnvflg(i)) then<a name='750'>
       indx = kb(i)<a name='751'>
       hkbo(i) = heo(i,indx)<a name='752'>
       qkbo(i) = qo(i,indx)<a name='753'>
     endif<a name='754'>
   enddo<a name='755'>
<font color=#447700>!<a name='756'></font>
   do i = its,ite<a name='757'>
     flg(i) = cnvflg(i)<a name='758'>
     kbcon(i) = kmax<a name='759'>
   enddo<a name='760'>
<font color=#447700>!<a name='761'></font>
   do k = kts,kbmax<a name='762'>
     do i = its,ite<a name='763'>
       if(flg(i).and.k.gt.kb(i)) then<a name='764'>
         hsbar(i) = heso(i,k)<a name='765'>
         if(hkbo(i).gt.hsbar(i)) then<a name='766'>
           flg(i) = .false.<a name='767'>
           kbcon(i) = k<a name='768'>
         endif<a name='769'>
       endif<a name='770'>
     enddo<a name='771'>
   enddo<a name='772'>
   do i = its,ite<a name='773'>
     if(kbcon(i).eq.kmax) cnvflg(i) = .false.<a name='774'>
   enddo<a name='775'>
<font color=#447700>!<a name='776'></font>
   totflg = .true.<a name='777'>
   do i = its,ite<a name='778'>
     totflg = totflg .and. (.not. cnvflg(i))<a name='779'>
   enddo<a name='780'>
   if(totflg) return<a name='781'>
<font color=#447700>!<a name='782'></font>
   do i = its,ite<a name='783'>
     if(cnvflg(i)) then<a name='784'>
<font color=#447700>!<a name='785'></font>
<font color=#447700>!  determine critical convective inhibition<a name='786'></font>
<font color=#447700>!  as a function of vertical velocity at cloud base.<a name='787'></font>
<font color=#447700>!<a name='788'></font>
       pdot(i)  = 10.* dot(i,kbcon(i))<a name='789'>
       if(slimsk(i).eq.1.) then<a name='790'>
         w1 = w1l<a name='791'>
         w2 = w2l<a name='792'>
         w3 = w3l<a name='793'>
         w4 = w4l<a name='794'>
       else<a name='795'>
         w1 = w1s<a name='796'>
         w2 = w2s<a name='797'>
         w3 = w3s<a name='798'>
         w4 = w4s<a name='799'>
       endif<a name='800'>
       if(pdot(i).le.w4) then<a name='801'>
         tem = (pdot(i) - w4) / (w3 - w4)<a name='802'>
       elseif(pdot(i).ge.-w4) then<a name='803'>
         tem = - (pdot(i) + w4) / (w4 - w3)<a name='804'>
       else<a name='805'>
         tem = 0.<a name='806'>
       endif<a name='807'>
       tem = max(tem,-1.)<a name='808'>
       tem = min(tem,1.)<a name='809'>
       tem = 1. - tem<a name='810'>
       tem1= .5*(cincrmax-cincrmin)<a name='811'>
       cincr = cincrmax - tem * tem1<a name='812'>
       pbcdif(i) = -p(i,kbcon(i)) + p(i,kb(i))<a name='813'>
       if(pbcdif(i).gt.cincr) cnvflg(i) = .false.<a name='814'>
     endif<a name='815'>
   enddo<a name='816'>
<font color=#447700>!<a name='817'></font>
<font color=#447700>!<a name='818'></font>
   totflg = .true.<a name='819'>
   do i = its,ite<a name='820'>
     totflg = totflg .and. (.not. cnvflg(i))<a name='821'>
   enddo<a name='822'>
   if(totflg) return<a name='823'>
<font color=#447700>!<a name='824'></font>
   do k = kts1,kte<a name='825'>
     do i = its,ite<a name='826'>
       zi(i,k) = 0.5*(zl(i,k-1)+zl(i,k))<a name='827'>
     enddo<a name='828'>
   enddo<a name='829'>
<font color=#447700>!<a name='830'></font>
   do k = kts,kte1<a name='831'>
     do i = its,ite<a name='832'>
       xlamb(i,k) = clam / zi(i,k+1) <a name='833'>
     enddo<a name='834'>
   enddo<a name='835'>
<font color=#447700>!<a name='836'></font>
<font color=#447700>!  assume that updraft entrainment rate above cloud base is<a name='837'></font>
<font color=#447700>!  same as that at cloud base<a name='838'></font>
<font color=#447700>!<a name='839'></font>
   do k = kts1,kmax1<a name='840'>
     do i = its,ite<a name='841'>
       if(cnvflg(i).and.(k.gt.kbcon(i))) then<a name='842'>
         xlamb(i,k) = xlamb(i,kbcon(i))<a name='843'>
       endif<a name='844'>
     enddo<a name='845'>
   enddo<a name='846'>
<font color=#447700>!<a name='847'></font>
<font color=#447700>!   assume the detrainment rate for the updrafts to be same as<a name='848'></font>
<font color=#447700>!   the entrainment rate at cloud base<a name='849'></font>
<font color=#447700>!<a name='850'></font>
   do i = its,ite<a name='851'>
     if(cnvflg(i)) then<a name='852'>
       xlamud(i) = xlamb(i,kbcon(i))<a name='853'>
     endif<a name='854'>
   enddo<a name='855'>
<font color=#447700>!<a name='856'></font>
<font color=#447700>!  functions rapidly decreasing with height, mimicking a cloud ensemble<a name='857'></font>
<font color=#447700>!    (Bechtold et al., 2008)<a name='858'></font>
<font color=#447700>!<a name='859'></font>
   do k = kts1,kmax1<a name='860'>
     do i = its,ite<a name='861'>
       if(cnvflg(i).and.(k.gt.kbcon(i))) then<a name='862'>
         tem = qeso(i,k)/qeso(i,kbcon(i))<a name='863'>
         fent1(i,k) = tem**2<a name='864'>
         fent2(i,k) = tem**3<a name='865'>
       endif<a name='866'>
     enddo<a name='867'>
   enddo<a name='868'>
<font color=#447700>!<a name='869'></font>
<font color=#447700>!  final entrainment rate as the sum of turbulent part and organized entrainment<a name='870'></font>
<font color=#447700>!    depending on the environmental relative humidity<a name='871'></font>
<font color=#447700>!    (Bechtold et al., 2008)<a name='872'></font>
<font color=#447700>!<a name='873'></font>
   do k = kts1,kmax1<a name='874'>
     do i = its,ite<a name='875'>
       if(cnvflg(i).and.(k.ge.kbcon(i))) then<a name='876'>
          tem = cxlamu * frh(i,k) * fent2(i,k)<a name='877'>
          xlamb(i,k) = xlamb(i,k)*fent1(i,k) + tem<a name='878'>
       endif<a name='879'>
     enddo<a name='880'>
   enddo<a name='881'>
<font color=#447700>!<a name='882'></font>
<font color=#447700>! determine updraft mass flux<a name='883'></font>
<font color=#447700>!<a name='884'></font>
   do k = kts,kte<a name='885'>
     do i = its,ite<a name='886'>
      if(cnvflg(i)) then<a name='887'>
         eta(i,k) = 1.<a name='888'>
       endif<a name='889'>
     enddo<a name='890'>
   enddo<a name='891'>
<font color=#447700>!<a name='892'></font>
   do k = kbmax,kts1,-1<a name='893'>
     do i = its,ite<a name='894'>
       if(cnvflg(i).and.k.lt.kbcon(i).and.k.ge.kb(i)) then<a name='895'>
         dz = zi(i,k+2) - zi(i,k+1)<a name='896'>
         ptem     = 0.5*(xlamb(i,k)+xlamb(i,k+1))-xlamud(i)<a name='897'>
         eta(i,k) = eta(i,k+1) / (1. + ptem * dz)<a name='898'>
       endif<a name='899'>
     enddo<a name='900'>
   enddo<a name='901'>
  do k = kts1,kmax1<a name='902'>
     do i = its,ite<a name='903'>
       if(cnvflg(i).and.k.gt.kbcon(i)) then<a name='904'>
         dz  = zi(i,k+1) - zi(i,k)<a name='905'>
         ptem = 0.5*(xlamb(i,k)+xlamb(i,k-1))-xlamud(i)<a name='906'>
         eta(i,k) = eta(i,k-1) * (1 + ptem * dz)<a name='907'>
       endif<a name='908'>
     enddo<a name='909'>
   enddo<a name='910'>
   do i = its,ite<a name='911'>
     if(cnvflg(i)) then<a name='912'>
       dz = zi(i,3) - zi(i,2)<a name='913'>
       ptem     = 0.5*(xlamb(i,1)+xlamb(i,2))-xlamud(i)<a name='914'>
       eta(i,1) = eta(i,2) / (1. + ptem * dz)<a name='915'>
     endif<a name='916'>
   enddo<a name='917'>
<font color=#447700>!<a name='918'></font>
<font color=#447700>! work up updraft cloud properties<a name='919'></font>
<font color=#447700>!<a name='920'></font>
   do i = its,ite<a name='921'>
     if(cnvflg(i)) then<a name='922'>
       indx = kb(i)<a name='923'>
       hcko(i,indx) = hkbo(i)<a name='924'>
       qcko(i,indx) = qkbo(i)<a name='925'>
       ucko(i,indx) = uo(i,indx)<a name='926'>
       vcko(i,indx) = vo(i,indx)<a name='927'>
       pwavo(i) = 0.<a name='928'>
     endif<a name='929'>
   enddo<a name='930'>
<font color=#447700>!<a name='931'></font>
<font color=#447700>! cloud property below cloud base is modified by the entrainment proces<a name='932'></font>
<font color=#447700>!<a name='933'></font>
   do k = kts1,kmax1<a name='934'>
     do i = its,ite<a name='935'>
       if(cnvflg(i).and.k.gt.kb(i)) then<a name='936'>
         dz   = zi(i,k+1) - zi(i,k)<a name='937'>
         tem  = 0.5 * (xlamb(i,k)+xlamb(i,k-1)) * dz<a name='938'>
         tem1 = 0.5 * xlamud(i) * dz<a name='939'>
         factor = 1. + tem - tem1<a name='940'>
         ptem = 0.5 * tem + pgcon<a name='941'>
         ptem1= 0.5 * tem - pgcon<a name='942'>
         hcko(i,k) = ((1.-tem1)*hcko(i,k-1)+tem*0.5*                          &amp;<a name='943'>
                     (heo(i,k)+heo(i,k-1)))/factor<a name='944'>
         ucko(i,k) = ((1.-tem1)*ucko(i,k-1)+ptem*uo(i,k)                      &amp;<a name='945'>
                     +ptem1*uo(i,k-1))/factor<a name='946'>
         vcko(i,k) = ((1.-tem1)*vcko(i,k-1)+ptem*vo(i,k)                      &amp;<a name='947'>
                     +ptem1*vo(i,k-1))/factor<a name='948'>
         dbyo(i,k) = hcko(i,k) - heso(i,k)<a name='949'>
       endif<a name='950'>
     enddo<a name='951'>
   enddo<a name='952'>
<font color=#447700>!<a name='953'></font>
<font color=#447700>!   taking account into convection inhibition due to existence of<a name='954'></font>
<font color=#447700>!    dry layers below cloud base<a name='955'></font>
<font color=#447700>!<a name='956'></font>
   do i = its,ite<a name='957'>
     flg(i) = cnvflg(i)<a name='958'>
     kbcon1(i) = kmax<a name='959'>
   enddo<a name='960'>
<font color=#447700>!<a name='961'></font>
   do k = kts1,kmax<a name='962'>
     do i = its,ite<a name='963'>
       if(flg(i).and.k.ge.kbcon(i).and.dbyo(i,k).gt.0.) then<a name='964'>
         kbcon1(i) = k<a name='965'>
         flg(i) = .false.<a name='966'>
       endif<a name='967'>
     enddo<a name='968'>
   enddo<a name='969'>
<font color=#447700>!<a name='970'></font>
   do i = its,ite<a name='971'>
     if(cnvflg(i)) then<a name='972'>
       if(kbcon1(i).eq.kmax) cnvflg(i) = .false.<a name='973'>
     endif<a name='974'>
   enddo<a name='975'>
<font color=#447700>!<a name='976'></font>
   do i = its,ite<a name='977'>
     if(cnvflg(i)) then<a name='978'>
       tem = p(i,kbcon(i)) - p(i,kbcon1(i))<a name='979'>
       if(tem.gt.dthk) then<a name='980'>
          cnvflg(i) = .false.<a name='981'>
       endif<a name='982'>
     endif<a name='983'>
   enddo<a name='984'>
<font color=#447700>!<a name='985'></font>
   totflg = .true.<a name='986'>
   do i = its,ite<a name='987'>
     totflg = totflg .and. (.not. cnvflg(i))<a name='988'>
   enddo<a name='989'>
   if(totflg) return<a name='990'>
<font color=#447700>!<a name='991'></font>
<font color=#447700>!<a name='992'></font>
<font color=#447700>!  determine cloud top<a name='993'></font>
<font color=#447700>!<a name='994'></font>
<font color=#447700>!<a name='995'></font>
   do i = its,ite<a name='996'>
     flg(i) = cnvflg(i)<a name='997'>
     ktcon(i) = 1<a name='998'>
   enddo<a name='999'>
<font color=#447700>!<a name='1000'></font>
<font color=#447700>!   check inversion<a name='1001'></font>
<font color=#447700>!<a name='1002'></font>
   do k = kts1,kmax1<a name='1003'>
     do i = its,ite<a name='1004'>
       if(dbyo(i,k).lt.0..and.flg(i).and.k.gt. kbcon1(i)) then<a name='1005'>
         ktcon(i) = k<a name='1006'>
         flg(i)   = .false.<a name='1007'>
       endif<a name='1008'>
     enddo<a name='1009'>
   enddo<a name='1010'>
<font color=#447700>!<a name='1011'></font>
<font color=#447700>!<a name='1012'></font>
<font color=#447700>! check cloud depth<a name='1013'></font>
<font color=#447700>!<a name='1014'></font>
   do i = its,ite<a name='1015'>
     if(cnvflg(i).and.(p(i,kbcon(i)) - p(i,ktcon(i))).lt.150.)                 &amp;<a name='1016'>
            cnvflg(i) = .false.<a name='1017'>
   enddo<a name='1018'>
<font color=#447700>!<a name='1019'></font>
   totflg = .true.<a name='1020'>
   do i = its,ite<a name='1021'>
     totflg = totflg .and. (.not. cnvflg(i))<a name='1022'>
   enddo<a name='1023'>
   if(totflg) return<a name='1024'>
<font color=#447700>!<a name='1025'></font>
<font color=#447700>!<a name='1026'></font>
<font color=#447700>!  search for downdraft originating level above theta-e minimum<a name='1027'></font>
<font color=#447700>!<a name='1028'></font>
   do i = its,ite <a name='1029'>
     if(cnvflg(i)) then<a name='1030'>
       hmin(i) = heo(i,kbcon1(i))<a name='1031'>
       lmin(i) = kbmax<a name='1032'>
       jmin(i) = kbmax<a name='1033'>
    endif<a name='1034'>
   enddo<a name='1035'>
<font color=#447700>!<a name='1036'></font>
   do k = kts1,kbmax <a name='1037'>
     do i = its,ite <a name='1038'>
       if(cnvflg(i).and.k.gt.kbcon1(i).and.heo(i,k).lt.hmin(i)) then<a name='1039'>
         lmin(i) = k + 1<a name='1040'>
         hmin(i) = heo(i,k)<a name='1041'>
       endif<a name='1042'>
     enddo<a name='1043'>
   enddo<a name='1044'>
<font color=#447700>!<a name='1045'></font>
<font color=#447700>! make sure that jmin is within the cloud<a name='1046'></font>
<font color=#447700>!<a name='1047'></font>
   do i = its,ite<a name='1048'>
     if(cnvflg(i)) then<a name='1049'>
       jmin(i) = min(lmin(i),ktcon(i)-1)<a name='1050'>
       jmin(i) = max(jmin(i),kbcon1(i)+1)<a name='1051'>
       if(jmin(i).ge.ktcon(i)) cnvflg(i) = .false.<a name='1052'>
     endif<a name='1053'>
   enddo<a name='1054'>
<font color=#447700>!<a name='1055'></font>
<font color=#447700>!  specify upper limit of mass flux at cloud base<a name='1056'></font>
<font color=#447700>!<a name='1057'></font>
   do i = its,ite<a name='1058'>
     if(cnvflg(i)) then<a name='1059'>
       k = kbcon(i)<a name='1060'>
       dp = 1000. * del(i,k)<a name='1061'>
       xmbmax(i) = dp / (g_ * dt2)<a name='1062'>
     endif<a name='1063'>
   enddo<a name='1064'>
<font color=#447700>!<a name='1065'></font>
<font color=#447700>!<a name='1066'></font>
<font color=#447700>! compute cloud moisture property and precipitation<a name='1067'></font>
<font color=#447700>!<a name='1068'></font>
   do i = its,ite<a name='1069'>
     aa1(i) = 0.<a name='1070'>
   enddo<a name='1071'>
<font color=#447700>!<a name='1072'></font>
   do k = kts1,kmax<a name='1073'>
     do i = its,ite<a name='1074'>
       if(cnvflg(i).and.k.gt.kb(i).and.k.lt.ktcon(i)) then<a name='1075'>
         dz = .5 * (zl(i,k+1) - zl(i,k-1))<a name='1076'>
         dz1 = (zi(i,k+1) - zi(i,k))<a name='1077'>
         gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='1078'>
         qrch = qeso(i,k)                                                      &amp;<a name='1079'>
              + gamma * dbyo(i,k) / (hvap_ * (1. + gamma))<a name='1080'>
         tem  = 0.5 * (xlamb(i,k)+xlamb(i,k-1)) * dz1<a name='1081'>
         tem1 = 0.5 * xlamud(i) * dz1<a name='1082'>
         factor = 1. + tem - tem1<a name='1083'>
         qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*                           &amp; <a name='1084'>
                    (qo(i,k)+qo(i,k-1)))/factor<a name='1085'>
         qcirs(i,k) = eta(i,k) * qcko(i,k) - eta(i,k) * qrch<a name='1086'>
<font color=#447700>!<a name='1087'></font>
<font color=#447700>! check if there is excess moisture to release latent heat<a name='1088'></font>
<font color=#447700>!<a name='1089'></font>
         if(qcirs(i,k).gt.0. .and. k.ge.kbcon(i)) then<a name='1090'>
           etah = .5 * (eta(i,k) + eta(i,k-1))<a name='1091'>
           if(ncloud.gt.0..and.k.gt.jmin(i)) then<a name='1092'>
             dp = 1000. * del(i,k)<a name='1093'>
             qlk = qcirs(i,k) / (eta(i,k) + etah * (c0 + c1) * dz1)<a name='1094'>
             dellal(i,k) = etah * c1 * dz1 * qlk * g_ / dp<a name='1095'>
           else<a name='1096'>
             qlk = qcirs(i,k) / (eta(i,k) + etah * c0 * dz1)<a name='1097'>
           endif<a name='1098'>
           aa1(i) = aa1(i) - dz1 * g_ * qlk<a name='1099'>
           qc = qlk + qrch<a name='1100'>
           pwo(i,k) = etah * c0 * dz1 * qlk<a name='1101'>
           qcko(i,k) = qc<a name='1102'>
           pwavo(i) = pwavo(i) + pwo(i,k)<a name='1103'>
         endif<a name='1104'>
       endif<a name='1105'>
     enddo<a name='1106'>
   enddo<a name='1107'>
<font color=#447700>!<a name='1108'></font>
<font color=#447700>! calculate cloud work function at t+dt<a name='1109'></font>
<font color=#447700>!<a name='1110'></font>
   do k = kts1,kmax <a name='1111'>
     do i = its,ite <a name='1112'>
       if(cnvflg(i).and.k.ge.kbcon(i).and.k.lt.ktcon(i)) then<a name='1113'>
         dz1 = zl(i,k+1) - zl(i,k)<a name='1114'>
         gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='1115'>
         rfact =  1. + fv_ * cp_ * gamma* to(i,k) / hvap_<a name='1116'>
         aa1(i) = aa1(i) +dz1 * (g_ / (cp_ * to(i,k)))                         &amp;<a name='1117'>
                  * dbyo(i,k) / (1. + gamma)* rfact<a name='1118'>
         aa1(i) = aa1(i)+dz1 * g_ * fv_ *                                      &amp;<a name='1119'>
                  max(0.,(qeso(i,k) - qo(i,k)))<a name='1120'>
       endif<a name='1121'>
     enddo<a name='1122'>
   enddo<a name='1123'>
<font color=#447700>!<a name='1124'></font>
   do i = its,ite<a name='1125'>
     if(cnvflg(i).and.aa1(i).le.0.) cnvflg(i) = .false.<a name='1126'>
   enddo<a name='1127'>
<font color=#447700>!<a name='1128'></font>
   totflg = .true.<a name='1129'>
   do i = its,ite<a name='1130'>
     totflg = totflg .and. (.not. cnvflg(i))<a name='1131'>
   enddo<a name='1132'>
   if(totflg) return<a name='1133'>
<font color=#447700>!<a name='1134'></font>
<font color=#447700>!    estimate the convective overshooting as the level<a name='1135'></font>
<font color=#447700>!    where the [aafac * cloud work function] becomes zero,<a name='1136'></font>
<font color=#447700>!    which is the final cloud top<a name='1137'></font>
<font color=#447700>!<a name='1138'></font>
   do i = its,ite<a name='1139'>
     if (cnvflg(i)) then<a name='1140'>
       aa2(i) = aafac * aa1(i)<a name='1141'>
     endif<a name='1142'>
   enddo<a name='1143'>
<font color=#447700>!<a name='1144'></font>
   do i = its,ite<a name='1145'>
     flg(i) = cnvflg(i)<a name='1146'>
     ktcon1(i) = kmax1<a name='1147'>
   enddo<a name='1148'>
<font color=#447700>!<a name='1149'></font>
   do k = kts1,kmax<a name='1150'>
     do i = its, ite<a name='1151'>
       if (flg(i)) then<a name='1152'>
         if(k.ge.ktcon(i).and.k.lt.kmax) then<a name='1153'>
           dz1 = zl(i,k+1) - zl(i,k)<a name='1154'>
           gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='1155'>
           rfact =  1. + fv_ * cp_ * gamma* to(i,k) / hvap_<a name='1156'>
           aa2(i) = aa2(i) +dz1 * (g_ / (cp_ * to(i,k)))                    &amp;<a name='1157'>
                       * dbyo(i,k) / (1. + gamma)* rfact<a name='1158'>
           if(aa2(i).lt.0.) then<a name='1159'>
             ktcon1(i) = k<a name='1160'>
             flg(i) = .false.<a name='1161'>
           endif<a name='1162'>
         endif<a name='1163'>
       endif<a name='1164'>
     enddo<a name='1165'>
   enddo<a name='1166'>
<font color=#447700>!<a name='1167'></font>
<font color=#447700>!  compute cloud moisture property, detraining cloud water<a name='1168'></font>
<font color=#447700>!  and precipitation in overshooting layers<a name='1169'></font>
<font color=#447700>!<a name='1170'></font>
   do k = kts1,kmax<a name='1171'>
     do i = its,ite<a name='1172'>
       if (cnvflg(i)) then<a name='1173'>
         if(k.ge.ktcon(i).and.k.lt.ktcon1(i)) then<a name='1174'>
           dz = (zi(i,k+1) - zi(i,k))<a name='1175'>
           gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='1176'>
           qrch = qeso(i,k)+ gamma * dbyo(i,k) / (hvap_ * (1. + gamma))<a name='1177'>
           tem  = 0.5 * (xlamb(i,k)+xlamb(i,k-1)) * dz<a name='1178'>
           tem1 = 0.5 * xlamud(i) * dz<a name='1179'>
           factor = 1. + tem - tem1<a name='1180'>
           qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*                         &amp; <a name='1181'>
                      (qo(i,k)+qo(i,k-1)))/factor<a name='1182'>
           qcirs(i,k) = eta(i,k) * qcko(i,k) - eta(i,k) * qrch<a name='1183'>
<font color=#447700>!<a name='1184'></font>
<font color=#447700>!  check if there is excess moisture to release latent heat<a name='1185'></font>
<font color=#447700>!<a name='1186'></font>
           if(qcirs(i,k).gt.0.) then<a name='1187'>
             etah = .5 * (eta(i,k) + eta(i,k-1))<a name='1188'>
             if(ncloud.gt.0.) then<a name='1189'>
               dp = 1000. * del(i,k)<a name='1190'>
               qlk = qcirs(i,k) / (eta(i,k) + etah * (c0 + c1) * dz)<a name='1191'>
               dellal(i,k) = etah * c1 * dz * qlk * g_ / dp<a name='1192'>
             else<a name='1193'>
               qlk = qcirs(i,k) / (eta(i,k) + etah * c0 * dz)<a name='1194'>
             endif<a name='1195'>
             qc = qlk + qrch<a name='1196'>
             pwo(i,k) = etah * c0 * dz * qlk<a name='1197'>
             qcko(i,k) = qc<a name='1198'>
             pwavo(i) = pwavo(i) + pwo(i,k)<a name='1199'>
           endif<a name='1200'>
         endif<a name='1201'>
       endif<a name='1202'>
     enddo<a name='1203'>
   enddo<a name='1204'>
<font color=#447700>!<a name='1205'></font>
<font color=#447700>! exchange ktcon with ktcon1<a name='1206'></font>
<font color=#447700>!<a name='1207'></font>
   do i = its,ite<a name='1208'>
     if(cnvflg(i)) then<a name='1209'>
       kk = ktcon(i)<a name='1210'>
       ktcon(i) = ktcon1(i)<a name='1211'>
       ktcon1(i) = kk<a name='1212'>
     endif<a name='1213'>
   enddo<a name='1214'>
<font color=#447700>!<a name='1215'></font>
<font color=#447700>! this section is ready for cloud water<a name='1216'></font>
<font color=#447700>!<a name='1217'></font>
   if (ncloud.gt.0) then<a name='1218'>
<font color=#447700>!<a name='1219'></font>
<font color=#447700>!  compute liquid and vapor separation at cloud top<a name='1220'></font>
<font color=#447700>! <a name='1221'></font>
     do i = its,ite<a name='1222'>
       if(cnvflg(i)) then<a name='1223'>
         k = ktcon(i)-1<a name='1224'>
         gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='1225'>
         qrch = qeso(i,k)                                                      &amp;<a name='1226'>
                + gamma * dbyo(i,k) / (hvap_ * (1. + gamma))<a name='1227'>
         dq = qcko(i,k) - qrch<a name='1228'>
<font color=#447700>!<a name='1229'></font>
<font color=#447700>!  check if there is excess moisture to release latent heat<a name='1230'></font>
<font color=#447700>!<a name='1231'></font>
         if(dq.gt.0.) then<a name='1232'>
           qlko_ktcon(i) = dq<a name='1233'>
           qcko(i,k) = qrch<a name='1234'>
         endif<a name='1235'>
       endif<a name='1236'>
     enddo<a name='1237'>
   endif<a name='1238'>
<font color=#447700>!<a name='1239'></font>
<font color=#447700>! ..... downdraft calculations .....<a name='1240'></font>
<font color=#447700>!<a name='1241'></font>
<font color=#447700>! determine downdraft strength in terms of wind shear<a name='1242'></font>
<font color=#447700>!<a name='1243'></font>
   do i = its,ite<a name='1244'>
     if(cnvflg(i)) then<a name='1245'>
       vshear(i) = 0.<a name='1246'>
     endif<a name='1247'>
   enddo<a name='1248'>
<font color=#447700>!<a name='1249'></font>
   do k = kts1,kmax<a name='1250'>
     do i = its,ite<a name='1251'>
       if(k.gt.kb(i).and.k.le.ktcon(i).and.cnvflg(i)) then<a name='1252'>
         shear= sqrt((uo(i,k)-uo(i,k-1)) ** 2                                  &amp; <a name='1253'>
                       + (vo(i,k)-vo(i,k-1)) ** 2)<a name='1254'>
         vshear(i) = vshear(i) + shear<a name='1255'>
       endif<a name='1256'>
     enddo<a name='1257'>
   enddo<a name='1258'>
<font color=#447700>!<a name='1259'></font>
   do i = its,ite<a name='1260'>
     if(cnvflg(i)) then<a name='1261'>
       vshear(i) = 1.e3 * vshear(i) / (zi(i,ktcon(i)+1)-zi(i,kb(i)+1))<a name='1262'>
       e1 = 1.591-.639*vshear(i)                                               &amp;<a name='1263'>
           +.0953*(vshear(i)**2)-.00496*(vshear(i)**3)<a name='1264'>
       edt(i)  = 1.-e1<a name='1265'>
<font color=#447700>!<a name='1266'></font>
       edt(i)  = min(edt(i),.9)<a name='1267'>
       edt(i)  = max(edt(i),.0)<a name='1268'>
       edto(i) = edt(i)<a name='1269'>
       edtx(i) = edt(i)<a name='1270'>
     endif<a name='1271'>
   enddo<a name='1272'>
<font color=#447700>!<a name='1273'></font>
<font color=#447700>! determine detrainment rate between 1 and kbdtr<a name='1274'></font>
<font color=#447700>!<a name='1275'></font>
   do i = its,ite<a name='1276'>
     if(cnvflg(i)) then<a name='1277'>
       sumx(i) = 0.<a name='1278'>
     endif<a name='1279'>
   enddo<a name='1280'>
<font color=#447700>!<a name='1281'></font>
   do k = kts,kmax1<a name='1282'>
     do i = its,ite<a name='1283'>
       if(cnvflg(i).and.k.ge.1.and.k.lt.kbcon(i)) then<a name='1284'>
         dz = zi(i,k+2) - zi(i,k+1)<a name='1285'>
         sumx(i) = sumx(i) + dz<a name='1286'>
       endif<a name='1287'>
     enddo<a name='1288'>
   enddo<a name='1289'>
<font color=#447700>!<a name='1290'></font>
   do i = its,ite<a name='1291'>
     kbdtr(i) = kbcon(i)<a name='1292'>
     beta = betas<a name='1293'>
     if(slimsk(i).eq.1.) beta = betal<a name='1294'>
     if(cnvflg(i)) then<a name='1295'>
       kbdtr(i) = kbcon(i)<a name='1296'>
       kbdtr(i) = max(kbdtr(i),1)<a name='1297'>
       dz =(sumx(i)+zi(i,2))/float(kbcon(i))<a name='1298'>
       tem = 1./float(kbcon(i))<a name='1299'>
       xlamd(i) = (1.-beta**tem)/dz<a name='1300'>
     endif<a name='1301'>
   enddo<a name='1302'>
<font color=#447700>!<a name='1303'></font>
<font color=#447700>! determine downdraft mass flux<a name='1304'></font>
<font color=#447700>!<a name='1305'></font>
   do k = kts,kmax<a name='1306'>
     do i = its,ite<a name='1307'>
       if(cnvflg(i)) then<a name='1308'>
         etad(i,k) = 1.<a name='1309'>
       endif<a name='1310'>
       qrcdo(i,k) = 0.<a name='1311'>
       qrcd(i,k) = 0.<a name='1312'>
     enddo<a name='1313'>
   enddo<a name='1314'>
<font color=#447700>!<a name='1315'></font>
   do k = kmax1,kts,-1<a name='1316'>
     do i = its,ite<a name='1317'>
       if(cnvflg(i)) then<a name='1318'>
         if(k.lt.jmin(i).and.k.ge.kbcon(i))then<a name='1319'>
           dz = (zi(i,k+2) - zi(i,k+1))<a name='1320'>
           ptem = xlamdd-xlamde<a name='1321'>
           etad(i,k) = etad(i,k+1) * (1.-ptem * dz)<a name='1322'>
         elseif(k.lt.kbcon(i))then<a name='1323'>
           dz = (zi(i,k+2) - zi(i,k+1))<a name='1324'>
           ptem = xlamd(i)+xlamdd-xlamde<a name='1325'>
           etad(i,k) = etad(i,k+1) * (1.-ptem * dz)<a name='1326'>
         endif<a name='1327'>
       endif<a name='1328'>
     enddo<a name='1329'>
   enddo<a name='1330'>
<font color=#447700>!<a name='1331'></font>
<font color=#447700>!<a name='1332'></font>
<font color=#447700>! downdraft moisture properties<a name='1333'></font>
<font color=#447700>!<a name='1334'></font>
   do i = its,ite<a name='1335'>
     if(cnvflg(i)) then<a name='1336'>
      pwevo(i) = 0.<a name='1337'>
     endif<a name='1338'>
   enddo<a name='1339'>
<font color=#447700>!<a name='1340'></font>
   do i = its,ite<a name='1341'>
     if(cnvflg(i))  then <a name='1342'>
       jmn = jmin(i)<a name='1343'>
       hcdo(i,jmn) = heo(i,jmn)<a name='1344'>
       qcdo(i,jmn) = qo(i,jmn)<a name='1345'>
       qrcdo(i,jmn) = qeso(i,jmn)<a name='1346'>
       ucdo(i,jmn) = uo(i,jmn)<a name='1347'>
       vcdo(i,jmn) = vo(i,jmn)<a name='1348'>
     endif<a name='1349'>
   enddo<a name='1350'>
<font color=#447700>!<a name='1351'></font>
   do k = kmax1,kts,-1 <a name='1352'>
     do i = its,ite <a name='1353'>
       if (cnvflg(i) .and. k.lt.jmin(i)) then<a name='1354'>
         dz = zi(i,k+2) - zi(i,k+1)<a name='1355'>
         if(k.ge.kbcon(i)) then<a name='1356'>
           tem  = xlamde * dz<a name='1357'>
           tem1 = 0.5 * xlamdd * dz<a name='1358'>
         else<a name='1359'>
           tem  = xlamde * dz<a name='1360'>
           tem1 = 0.5 * (xlamd(i)+xlamdd) * dz<a name='1361'>
          endif<a name='1362'>
          factor = 1. + tem - tem1<a name='1363'>
          ptem = 0.5 * tem - pgcon<a name='1364'>
          ptem1= 0.5 * tem + pgcon<a name='1365'>
          hcdo(i,k) = ((1.-tem1)*hcdo(i,k+1)+tem*0.5*                     &amp; <a name='1366'>
                      (heo(i,k)+heo(i,k+1)))/factor<a name='1367'>
          ucdo(i,k) = ((1.-tem1)*ucdo(i,k+1)+ptem*uo(i,k+1)               &amp; <a name='1368'>
                     +ptem1*uo(i,k))/factor<a name='1369'>
          vcdo(i,k) = ((1.-tem1)*vcdo(i,k+1)+ptem*vo(i,k+1)               &amp; <a name='1370'>
                     +ptem1*vo(i,k))/factor<a name='1371'>
          dbyo(i,k) = hcdo(i,k) - heso(i,k)<a name='1372'>
       endif<a name='1373'>
     enddo<a name='1374'>
   enddo<a name='1375'>
<font color=#447700>!<a name='1376'></font>
   do k = kmax1,kts,-1<a name='1377'>
     do i = its,ite<a name='1378'>
       if(cnvflg(i).and.k.lt.jmin(i)) then<a name='1379'>
         dq = qeso(i,k)<a name='1380'>
         dt = to(i,k)<a name='1381'>
         gamma = el2orc * dq / dt**2<a name='1382'>
         qrcdo(i,k)=dq+(1./hvap_)*(gamma/(1.+gamma))*dbyo(i,k)<a name='1383'>
         detad = etad(i,k+1) - etad(i,k)<a name='1384'>
         dz = zi(i,k+2) - zi(i,k+1)<a name='1385'>
         if(k.ge.kbcon(i)) then<a name='1386'>
            tem  = xlamde * dz<a name='1387'>
            tem1 = 0.5 * xlamdd * dz<a name='1388'>
         else<a name='1389'>
            tem  = xlamde * dz<a name='1390'>
            tem1 = 0.5 * (xlamd(i)+xlamdd) * dz<a name='1391'>
         endif<a name='1392'>
         factor = 1. + tem - tem1<a name='1393'>
         qcdo(i,k) = ((1.-tem1)*qcdo(i,k+1)+tem*0.5*                      &amp; <a name='1394'>
                     (qo(i,k)+qo(i,k+1)))/factor<a name='1395'>
         pwdo(i,k) = etad(i,k+1) * qcdo(i,k) -etad(i,k+1) * qrcdo(i,k)<a name='1396'>
         qcdo(i,k) = qrcdo(i,k)<a name='1397'>
         pwevo(i) = pwevo(i) + pwdo(i,k)<a name='1398'>
       endif<a name='1399'>
     enddo<a name='1400'>
   enddo<a name='1401'>
<font color=#447700>!<a name='1402'></font>
<font color=#447700>! final downdraft strength dependent on precip<a name='1403'></font>
<font color=#447700>! efficiency (edt), normalized condensate (pwav), and<a name='1404'></font>
<font color=#447700>! evaporate (pwev)<a name='1405'></font>
<font color=#447700>!<a name='1406'></font>
   do i = its,ite<a name='1407'>
     edtmax = edtmaxl<a name='1408'>
     if(slimsk(i).eq.2.) edtmax = edtmaxs<a name='1409'>
     if(cnvflg(i)) then<a name='1410'>
       if(pwevo(i).lt.0.) then<a name='1411'>
         edto(i) = -edto(i) * pwavo(i) / pwevo(i)<a name='1412'>
         edto(i) = min(edto(i),edtmax)<a name='1413'>
       else<a name='1414'>
         edto(i) = 0.<a name='1415'>
       endif<a name='1416'>
     endif<a name='1417'>
   enddo<a name='1418'>
<font color=#447700>!<a name='1419'></font>
<font color=#447700>! downdraft cloudwork functions<a name='1420'></font>
<font color=#447700>!<a name='1421'></font>
   do k = kmax1,kts,-1<a name='1422'>
     do i = its,ite<a name='1423'>
       if(cnvflg(i).and.k.lt.jmin(i)) then<a name='1424'>
         gamma = el2orc * qeso(i,k) / to(i,k)**2<a name='1425'>
         dhh=hcdo(i,k)<a name='1426'>
         dt=to(i,k)<a name='1427'>
         dg=gamma<a name='1428'>
         dh=heso(i,k)<a name='1429'>
         dz=-1.*(zl(i,k+1)-zl(i,k))<a name='1430'>
         aa1(i)=aa1(i)+edto(i)*dz*(g_/(cp_*dt))*((dhh-dh)/(1.+dg))             &amp;<a name='1431'>
                *(1.+fv_*cp_*dg*dt/hvap_)<a name='1432'>
         aa1(i)=aa1(i)+edto(i)*dz*g_*fv_*max(0.,(qeso(i,k)-qo(i,k)))<a name='1433'>
       endif<a name='1434'>
     enddo<a name='1435'>
   enddo<a name='1436'>
<font color=#447700>!<a name='1437'></font>
   do i = its,ite<a name='1438'>
     if(cnvflg(i).and.aa1(i).le.0.) cnvflg(i) = .false.<a name='1439'>
   enddo<a name='1440'>
<font color=#447700>!<a name='1441'></font>
   totflg = .true.<a name='1442'>
   do i = its,ite<a name='1443'>
     totflg = totflg .and. (.not. cnvflg(i))<a name='1444'>
   enddo<a name='1445'>
   if(totflg) return<a name='1446'>
<font color=#447700>!<a name='1447'></font>
<font color=#447700>! what would the change be, that a cloud with unit mass<a name='1448'></font>
<font color=#447700>! will do to the environment?<a name='1449'></font>
<font color=#447700>!<a name='1450'></font>
   do k = kts,kmax<a name='1451'>
     do i = its,ite<a name='1452'>
       if(cnvflg(i)) then<a name='1453'>
         dellah(i,k) = 0.<a name='1454'>
         dellaq(i,k) = 0.<a name='1455'>
         dellau(i,k) = 0.<a name='1456'>
         dellav(i,k) = 0.<a name='1457'>
       endif<a name='1458'>
     enddo<a name='1459'>
   enddo<a name='1460'>
<font color=#447700>!<a name='1461'></font>
   do i = its,ite<a name='1462'>
     if(cnvflg(i)) then<a name='1463'>
       dp = 1000. * del(i,1)<a name='1464'>
       dellah(i,1) = edto(i) * etad(i,1) * (hcdo(i,1)                          &amp;<a name='1465'>
                   - heo(i,1)) * g_ / dp<a name='1466'>
       dellaq(i,1) = edto(i) * etad(i,1) * (qcdo(i,1)                          &amp;<a name='1467'>
                   - qo(i,1)) * g_ / dp<a name='1468'>
       dellau(i,1) = edto(i) * etad(i,1) * (ucdo(i,1)                          &amp;<a name='1469'>
                   - uo(i,1)) * g_ / dp<a name='1470'>
       dellav(i,1) = edto(i) * etad(i,1) * (vcdo(i,1)                          &amp;<a name='1471'>
                   - vo(i,1)) * g_ / dp<a name='1472'>
     endif<a name='1473'>
   enddo<a name='1474'>
<font color=#447700>!<a name='1475'></font>
<font color=#447700>! changed due to subsidence and entrainment<a name='1476'></font>
<font color=#447700>!<a name='1477'></font>
   do k = kts1,kmax1<a name='1478'>
     do i = its,ite<a name='1479'>
       if(cnvflg(i).and.k.lt.ktcon(i)) then<a name='1480'>
         aup = 1.<a name='1481'>
         if(k.le.kb(i)) aup = 0.<a name='1482'>
         adw = 1.<a name='1483'>
         if(k.gt.jmin(i)) adw = 0.<a name='1484'>
         dv1= heo(i,k)<a name='1485'>
         dv2 = .5 * (heo(i,k) + heo(i,k-1))<a name='1486'>
         dv3= heo(i,k-1)<a name='1487'>
         dv1q= qo(i,k)<a name='1488'>
         dv2q = .5 * (qo(i,k) + qo(i,k-1))<a name='1489'>
         dv3q= qo(i,k-1)<a name='1490'>
         dv1u = uo(i,k)<a name='1491'>
         dv2u = .5 * (uo(i,k) + uo(i,k-1))<a name='1492'>
         dv3u = uo(i,k-1)<a name='1493'>
         dv1v = vo(i,k)<a name='1494'>
         dv2v = .5 * (vo(i,k) + vo(i,k-1))<a name='1495'>
         dv3v = vo(i,k-1)<a name='1496'>
         dp = 1000. * del(i,k)<a name='1497'>
         dz = zi(i,k+1) - zi(i,k)<a name='1498'>
         tem  = 0.5 * (xlamb(i,k)+xlamb(i,k-1))<a name='1499'>
         tem1 = xlamud(i)<a name='1500'>
         if(k.le.kbcon(i)) then<a name='1501'>
           ptem  = xlamde<a name='1502'>
           ptem1 = xlamd(i)+xlamdd<a name='1503'>
         else<a name='1504'>
           ptem  = xlamde<a name='1505'>
           ptem1 = xlamdd<a name='1506'>
         endif<a name='1507'>
         deta = eta(i,k) - eta(i,k-1)<a name='1508'>
         detad = etad(i,k) - etad(i,k-1)<a name='1509'>
         dellah(i,k) = dellah(i,k) +                                           &amp;<a name='1510'>
             ((aup * eta(i,k) - adw * edto(i) * etad(i,k)) * dv1               &amp;<a name='1511'>
         - (aup * eta(i,k-1) - adw * edto(i) * etad(i,k-1))* dv3               &amp;<a name='1512'>
         - (aup*tem*eta(i,k-1)+adw*edto(i)*ptem*etad(i,k))*dv2*dz              &amp; <a name='1513'>
         +  aup*tem1*eta(i,k-1)*.5*(hcko(i,k)+hcko(i,k-1))*dz                  &amp; <a name='1514'>
         +  adw*edto(i)*ptem1*etad(i,k)*.5*(hcdo(i,k)+hcdo(i,k-1))*dz) *g_/dp<a name='1515'>
         dellaq(i,k) = dellaq(i,k) +                                           &amp;<a name='1516'>
             ((aup * eta(i,k) - adw * edto(i) * etad(i,k)) * dv1q              &amp;<a name='1517'>
         - (aup * eta(i,k-1) - adw * edto(i) * etad(i,k-1))* dv3q              &amp;<a name='1518'>
         - (aup*tem*eta(i,k-1)+adw*edto(i)*ptem*etad(i,k))*dv2q*dz             &amp; <a name='1519'>
         +  aup*tem1*eta(i,k-1)*.5*(qcko(i,k)+qcko(i,k-1))*dz                  &amp; <a name='1520'>
         +  adw*edto(i)*ptem1*etad(i,k)*.5*(qrcdo(i,k)+qrcdo(i,k-1))*dz) *g_/dp<a name='1521'>
         dellau(i,k) = dellau(i,k) +                                           &amp;<a name='1522'>
             ((aup * eta(i,k) - adw * edto(i) * etad(i,k)) * dv1u              &amp;<a name='1523'>
         - (aup * eta(i,k-1) - adw * edto(i) * etad(i,k-1))* dv3u              &amp;<a name='1524'>
         - (aup*tem*eta(i,k-1)+adw*edto(i)*ptem*etad(i,k))*dv2u*dz             &amp; <a name='1525'>
         +  aup*tem1*eta(i,k-1)*.5*(ucko(i,k)+ucko(i,k-1))*dz                  &amp; <a name='1526'>
         +  adw*edto(i)*ptem1*etad(i,k)*.5*(ucdo(i,k)+ucdo(i,k-1))*dz          &amp; <a name='1527'>
         -  pgcon*(aup*eta(i,k-1)-adw*edto(i)*etad(i,k))*(dv1u-dv3u))*g_/dp<a name='1528'>
<font color=#447700>!<a name='1529'></font>
         dellav(i,k) = dellav(i,k) +                                           &amp;<a name='1530'>
             ((aup * eta(i,k) - adw * edto(i) * etad(i,k)) * dv1v              &amp;<a name='1531'>
         - (aup * eta(i,k-1) - adw * edto(i) * etad(i,k-1))* dv3v              &amp;<a name='1532'>
         - (aup*tem*eta(i,k-1)+adw*edto(i)*ptem*etad(i,k))*dv2v*dz             &amp; <a name='1533'>
         +  aup*tem1*eta(i,k-1)*.5*(vcko(i,k)+vcko(i,k-1))*dz                  &amp; <a name='1534'>
         +  adw*edto(i)*ptem1*etad(i,k)*.5*(vcdo(i,k)+vcdo(i,k-1))*dz          &amp; <a name='1535'>
         -  pgcon*(aup*eta(i,k-1)-adw*edto(i)*etad(i,k))*(dv1v-dv3v))*g_/dp<a name='1536'>
       endif<a name='1537'>
     enddo<a name='1538'>
   enddo<a name='1539'>
<font color=#447700>!<a name='1540'></font>
<font color=#447700>! cloud top<a name='1541'></font>
<font color=#447700>!<a name='1542'></font>
   do i = its,ite<a name='1543'>
     if(cnvflg(i)) then<a name='1544'>
       indx = ktcon(i)<a name='1545'>
       dp = 1000. * del(i,indx)<a name='1546'>
       dv1 = heo(i,indx-1)<a name='1547'>
       dellah(i,indx) = eta(i,indx-1) *                                        &amp;<a name='1548'>
                        (hcko(i,indx-1) - dv1) * g_ / dp<a name='1549'>
       dvq1 = qo(i,indx-1)<a name='1550'>
       dellaq(i,indx) = eta(i,indx-1) *                                        &amp;<a name='1551'>
                        (qcko(i,indx-1) - dvq1) * g_ / dp<a name='1552'>
       dv1u = uo(i,indx-1)<a name='1553'>
       dellau(i,indx) = eta(i,indx-1) *                                        &amp;<a name='1554'>
                        (ucko(i,indx-1) - dv1u) * g_ / dp<a name='1555'>
       dv1v = vo(i,indx-1)<a name='1556'>
       dellav(i,indx) = eta(i,indx-1) *                                        &amp;<a name='1557'>
                        (vcko(i,indx-1) - dv1v) * g_ / dp<a name='1558'>
<font color=#447700>!<a name='1559'></font>
<font color=#447700>!  cloud water<a name='1560'></font>
<font color=#447700>!<a name='1561'></font>
       dellal(i,indx) = eta(i,indx-1) * qlko_ktcon(i) * g_ / dp<a name='1562'>
     endif<a name='1563'>
   enddo<a name='1564'>
<font color=#447700>!<a name='1565'></font>
<font color=#447700>! final changed variable per unit mass flux<a name='1566'></font>
<font color=#447700>!<a name='1567'></font>
   do k = kts,kmax<a name='1568'>
     do i = its,ite<a name='1569'>
       if(cnvflg(i).and.k.gt.ktcon(i)) then<a name='1570'>
         qo(i,k) = q1(i,k)<a name='1571'>
         to(i,k) = t1(i,k)<a name='1572'>
       endif<a name='1573'>
       if(cnvflg(i).and.k.le.ktcon(i)) then<a name='1574'>
         qo(i,k) = dellaq(i,k) * mbdt + q1(i,k)<a name='1575'>
         dellat  = (dellah(i,k) - hvap_ * dellaq(i,k)) / cp_<a name='1576'>
         to(i,k) = dellat * mbdt + t1(i,k)<a name='1577'>
         qo(i,k) = max(qo(i,k),1.0e-10)<a name='1578'>
       endif<a name='1579'>
     enddo<a name='1580'>
   enddo<a name='1581'>
<font color=#447700>!<a name='1582'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='1583'></font>
<font color=#447700>!<a name='1584'></font>
<font color=#447700>! the above changed environment is now used to calulate the<a name='1585'></font>
<font color=#447700>! effect the arbitrary cloud (with unit mass flux)<a name='1586'></font>
<font color=#447700>! which then is used to calculate the real mass flux,<a name='1587'></font>
<font color=#447700>! necessary to keep this change in balance with the large-scale<a name='1588'></font>
<font color=#447700>! destabilization.<a name='1589'></font>
<font color=#447700>!<a name='1590'></font>
<font color=#447700>! environmental conditions again<a name='1591'></font>
<font color=#447700>!<a name='1592'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='1593'></font>
<font color=#447700>!<a name='1594'></font>
   do k = kts,kmax<a name='1595'>
     do i = its,ite<a name='1596'>
       if(cnvflg(i)) then<a name='1597'>
         qeso(i,k)=0.01* fpvs(to(i,k),1,rd_,rv_,cvap_,cliq_,cice,xlv0,xls,psat,t0c_)<a name='1598'>
         qeso(i,k) = eps * qeso(i,k) / (p(i,k) + (eps-1.) * qeso(i,k))<a name='1599'>
         qeso(i,k) = max(qeso(i,k),qmin_)<a name='1600'>
         tvo(i,k)  = to(i,k) + fv_ * to(i,k) * max(qo(i,k),qmin_)<a name='1601'>
       endif<a name='1602'>
     enddo<a name='1603'>
   enddo<a name='1604'>
<font color=#447700>!<a name='1605'></font>
   do i = its,ite<a name='1606'>
     if(cnvflg(i)) then<a name='1607'>
       xaa0(i) = 0.<a name='1608'>
       xpwav(i) = 0.<a name='1609'>
     endif<a name='1610'>
   enddo<a name='1611'>
<font color=#447700>!<a name='1612'></font>
<font color=#447700>! moist static energy<a name='1613'></font>
<font color=#447700>!<a name='1614'></font>
   do k = kts,kmax1<a name='1615'>
     do i = its,ite<a name='1616'>
       if(cnvflg(i)) then<a name='1617'>
         dz = .5 * (zl(i,k+1) - zl(i,k))<a name='1618'>
         dp = .5 * (p(i,k+1) - p(i,k))<a name='1619'>
         es =0.01*fpvs(to(i,k+1),1,rd_,rv_,cvap_,cliq_,cice,xlv0,xls,psat,t0c_)<a name='1620'>
         pprime = p(i,k+1) + (eps-1.) * es<a name='1621'>
         qs = eps * es / pprime<a name='1622'>
         dqsdp = - qs / pprime<a name='1623'>
         desdt = es * (fact1 / to(i,k+1) + fact2 / (to(i,k+1)**2))<a name='1624'>
         dqsdt = qs * p(i,k+1) * desdt / (es * pprime)<a name='1625'>
         gamma = el2orc * qeso(i,k+1) / (to(i,k+1)**2)<a name='1626'>
         dt = (g_ * dz + hvap_ * dqsdp * dp) / (cp_ * (1. + gamma))<a name='1627'>
         dq = dqsdt * dt + dqsdp * dp<a name='1628'>
         to(i,k) = to(i,k+1) + dt<a name='1629'>
         qo(i,k) = qo(i,k+1) + dq<a name='1630'>
         po = .5 * (p(i,k) + p(i,k+1))<a name='1631'>
         qeso(i,k) =0.01* fpvs(to(i,k),1,rd_,rv_,cvap_,cliq_,cice,xlv0,xls,psat,t0c_)<a name='1632'>
         qeso(i,k) = eps * qeso(i,k) / (po + (eps-1.) * qeso(i,k))<a name='1633'>
         qeso(i,k) = max(qeso(i,k),qmin_)<a name='1634'>
         qo(i,k)   = max(qo(i,k), 1.0e-10)<a name='1635'>
         heo(i,k) = .5 * g_ * (zl(i,k) + zl(i,k+1)) +                          &amp;<a name='1636'>
                     cp_ * to(i,k) + hvap_ * qo(i,k)<a name='1637'>
         heso(i,k) = .5 * g_ * (zl(i,k) + zl(i,k+1)) +                         &amp;<a name='1638'>
                     cp_ * to(i,k) + hvap_ * qeso(i,k)<a name='1639'>
       endif<a name='1640'>
     enddo<a name='1641'>
   enddo<a name='1642'>
<font color=#447700>!<a name='1643'></font>
   k = kmax<a name='1644'>
   do i = its,ite<a name='1645'>
     if(cnvflg(i)) then<a name='1646'>
       heo(i,k)  = g_ * zl(i,k) + cp_ * to(i,k) + hvap_ * qo(i,k)<a name='1647'>
       heso(i,k) = g_ * zl(i,k) + cp_ * to(i,k) + hvap_ * qeso(i,k)<a name='1648'>
     endif<a name='1649'>
   enddo<a name='1650'>
<font color=#447700>!<a name='1651'></font>
   do i = its,ite<a name='1652'>
     if(cnvflg(i)) then<a name='1653'>
       xaa0(i) = 0.<a name='1654'>
       xpwav(i) = 0.<a name='1655'>
       indx = kb(i)<a name='1656'>
       xhkb(i) = heo(i,indx)<a name='1657'>
       xqkb(i) = qo(i,indx)<a name='1658'>
       hcko(i,indx) = xhkb(i)<a name='1659'>
       qcko(i,indx) = xqkb(i)<a name='1660'>
     endif<a name='1661'>
   enddo<a name='1662'>
<font color=#447700>!<a name='1663'></font>
<font color=#447700>! ..... static control .....<a name='1664'></font>
<font color=#447700>!<a name='1665'></font>
<font color=#447700>! moisture and cloud work functions<a name='1666'></font>
<font color=#447700>!<a name='1667'></font>
   do k = kts1,kmax1<a name='1668'>
     do i = its,ite<a name='1669'>
       if(cnvflg(i).and.k.gt.kb(i).and.k.le.ktcon(i)) then<a name='1670'>
         dz = zi(i,k+1) - zi(i,k)<a name='1671'>
         tem  = 0.5 * (xlamb(i,k)+xlamb(i,k-1)) * dz<a name='1672'>
         tem1 = 0.5 * xlamud(i) * dz<a name='1673'>
         factor = 1. + tem - tem1<a name='1674'>
         hcko(i,k) = ((1.-tem1)*hcko(i,k-1)+tem*0.5*                         &amp; <a name='1675'>
                    (heo(i,k)+heo(i,k-1)))/factor<a name='1676'>
       endif<a name='1677'>
     enddo<a name='1678'>
   enddo<a name='1679'>
<font color=#447700>!<a name='1680'></font>
   do k = kts1,kmax1<a name='1681'>
     do i = its,ite<a name='1682'>
       if(cnvflg(i).and.k.gt.kb(i).and.k.lt.ktcon(i)) then<a name='1683'>
         dz = zi(i,k+1) - zi(i,k)<a name='1684'>
         gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='1685'>
         xdby = hcko(i,k) - heso(i,k)<a name='1686'>
         xqrch = qeso(i,k)                                                     &amp;<a name='1687'>
              + gamma * xdby / (hvap_ * (1. + gamma))<a name='1688'>
         tem  = 0.5 * (xlamb(i,k)+xlamb(i,k-1)) * dz<a name='1689'>
         tem1 = 0.5 * xlamud(i) * dz<a name='1690'>
         factor = 1. + tem - tem1<a name='1691'>
         qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*(qo(i,k)+qo(i,k-1)))/factor<a name='1692'>
         dq = eta(i,k) * qcko(i,k) - eta(i,k) * xqrch<a name='1693'>
         if(k.ge.kbcon(i).and.dq.gt.0.) then<a name='1694'>
           etah = .5 * (eta(i,k) + eta(i,k-1))<a name='1695'>
           if(ncloud.gt.0..and.k.gt.jmin(i)) then<a name='1696'>
             qlk = dq / (eta(i,k) + etah * (c0 + c1) * dz)<a name='1697'>
           else<a name='1698'>
             qlk = dq / (eta(i,k) + etah * c0 * dz)<a name='1699'>
           endif<a name='1700'>
           if(k.lt.ktcon1(i)) then<a name='1701'>
             xaa0(i) = xaa0(i) - dz * g_ * qlk<a name='1702'>
           endif<a name='1703'>
           qcko(i,k) = qlk + xqrch<a name='1704'>
           xpw = etah * c0 * dz * qlk<a name='1705'>
           xpwav(i) = xpwav(i) + xpw<a name='1706'>
         endif<a name='1707'>
       endif<a name='1708'>
       if(cnvflg(i).and.k.ge.kbcon(i).and.k.lt.ktcon1(i)) then<a name='1709'>
         dz1 = zl(i,k+1) - zl(i,k)<a name='1710'>
         gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='1711'>
         rfact =  1. + fv_ * cp_ * gamma                                       &amp;<a name='1712'>
                  * to(i,k) / hvap_<a name='1713'>
         xdby = hcko(i,k) - heso(i,k)<a name='1714'>
         xaa0(i) = xaa0(i)                                                     &amp;<a name='1715'>
                 + dz1 * (g_ / (cp_ * to(i,k)))                                &amp;<a name='1716'>
                 * xdby / (1. + gamma)                                         &amp;<a name='1717'>
                 * rfact<a name='1718'>
         xaa0(i)=xaa0(i)+                                                      &amp;<a name='1719'>
                  dz1 * g_ * fv_ *                                             &amp;<a name='1720'>
                  max(0.,(qeso(i,k) - qo(i,k)))<a name='1721'>
       endif<a name='1722'>
     enddo<a name='1723'>
   enddo<a name='1724'>
<font color=#447700>!<a name='1725'></font>
<font color=#447700>! ..... downdraft calculations .....<a name='1726'></font>
<font color=#447700>!<a name='1727'></font>
<font color=#447700>!<a name='1728'></font>
<font color=#447700>! downdraft moisture properties<a name='1729'></font>
<font color=#447700>!<a name='1730'></font>
   do i = its,ite<a name='1731'>
     xpwev(i) = 0.<a name='1732'>
   enddo<a name='1733'>
<font color=#447700>!<a name='1734'></font>
   do i = its,ite<a name='1735'>
     if(cnvflg(i)) then<a name='1736'>
       jmn = jmin(i)<a name='1737'>
       xhcd(i,jmn) = heo(i,jmn)<a name='1738'>
       xqcd(i,jmn) = qo(i,jmn)<a name='1739'>
       qrcd(i,jmn) = qeso(i,jmn)<a name='1740'>
     endif<a name='1741'>
   enddo<a name='1742'>
<font color=#447700>!<a name='1743'></font>
   do k = kmax1,kts,-1<a name='1744'>
     do i = its,ite<a name='1745'>
       if(cnvflg(i).and.k.lt.jmin(i)) then<a name='1746'>
         dz = zi(i,k+2) - zi(i,k+1)<a name='1747'>
         if(k.ge.kbcon(i)) then<a name='1748'>
            tem  = xlamde * dz<a name='1749'>
            tem1 = 0.5 * xlamdd * dz<a name='1750'>
         else<a name='1751'>
            tem  = xlamde * dz<a name='1752'>
            tem1 = 0.5 * (xlamd(i)+xlamdd) * dz<a name='1753'>
         endif<a name='1754'>
         factor = 1. + tem - tem1<a name='1755'>
         xhcd(i,k) = ((1.-tem1)*xhcd(i,k+1)+tem*0.5*                        &amp; <a name='1756'>
                    (heo(i,k)+heo(i,k+1)))/factor<a name='1757'>
       endif<a name='1758'>
     enddo<a name='1759'>
   enddo<a name='1760'>
<font color=#447700>!<a name='1761'></font>
   do k = kmax1,kts,-1<a name='1762'>
     do i = its,ite<a name='1763'>
       if(cnvflg(i).and.k.lt.jmin(i)) then<a name='1764'>
         dq = qeso(i,k)<a name='1765'>
         dt = to(i,k)<a name='1766'>
         gamma = el2orc * dq / dt**2<a name='1767'>
         dh = xhcd(i,k) - heso(i,k)<a name='1768'>
         qrcd(i,k)=dq+(1./hvap_)*(gamma/(1.+gamma))*dh<a name='1769'>
         dz = zi(i,k+2) - zi(i,k+1)<a name='1770'>
         if(k.ge.kbcon(i)) then<a name='1771'>
           tem  = xlamde * dz<a name='1772'>
           tem1 = 0.5 * xlamdd * dz<a name='1773'>
         else<a name='1774'>
           tem  = xlamde * dz<a name='1775'>
           tem1 = 0.5 * (xlamd(i)+xlamdd) * dz<a name='1776'>
         endif<a name='1777'>
         factor = 1. + tem - tem1<a name='1778'>
         xqcd(i,k) = ((1.-tem1)*xqcd(i,k+1)+tem*0.5*                           &amp; <a name='1779'>
                   (qo(i,k)+qo(i,k+1)))/factor<a name='1780'>
         xpwd     = etad(i,k+1) * (xqcd(i,k) - qrcd(i,k))<a name='1781'>
         xqcd(i,k)= qrcd(i,k)<a name='1782'>
         xpwev(i) = xpwev(i) + xpwd<a name='1783'>
       endif<a name='1784'>
     enddo<a name='1785'>
   enddo<a name='1786'>
<font color=#447700>!<a name='1787'></font>
   do i = its,ite<a name='1788'>
     edtmax = edtmaxl<a name='1789'>
     if(slimsk(i).eq.2.) edtmax = edtmaxs<a name='1790'>
     if(cnvflg(i)) then<a name='1791'>
       if(xpwev(i).ge.0.) then<a name='1792'>
         edtx(i) = 0.<a name='1793'>
       else<a name='1794'>
         edtx(i) = -edtx(i) * xpwav(i) / xpwev(i)<a name='1795'>
         edtx(i) = min(edtx(i),edtmax)<a name='1796'>
       endif<a name='1797'>
     endif<a name='1798'>
   enddo<a name='1799'>
<font color=#447700>!<a name='1800'></font>
<font color=#447700>! downdraft cloudwork functions<a name='1801'></font>
<font color=#447700>!<a name='1802'></font>
   do k = kmax1,kts,-1<a name='1803'>
     do i = its,ite<a name='1804'>
       if(cnvflg(i).and.k.lt.jmin(i)) then<a name='1805'>
         gamma = el2orc * qeso(i,k) / to(i,k)**2<a name='1806'>
         dhh=xhcd(i,k)<a name='1807'>
         dt= to(i,k)<a name='1808'>
         dg= gamma<a name='1809'>
         dh= heso(i,k)<a name='1810'>
         dz=-1.*(zl(i,k+1)-zl(i,k))<a name='1811'>
         xaa0(i)=xaa0(i)+edtx(i)*dz*(g_/(cp_*dt))*((dhh-dh)/(1.+dg))           &amp;<a name='1812'>
                 *(1.+fv_*cp_*dg*dt/hvap_)<a name='1813'>
         xaa0(i)=xaa0(i)+edtx(i)*                                              &amp;<a name='1814'>
                  dz*g_*fv_*max(0.,(qeso(i,k)-qo(i,k)))<a name='1815'>
       endif<a name='1816'>
     enddo<a name='1817'>
   enddo<a name='1818'>
<font color=#447700>!<a name='1819'></font>
<font color=#447700>! calculate critical cloud work function<a name='1820'></font>
<font color=#447700>!<a name='1821'></font>
   do i = its,ite<a name='1822'>
     acrt(i) = 0.<a name='1823'>
     if(cnvflg(i)) then<a name='1824'>
       if(p(i,ktcon(i)).lt.pcrit(15))then<a name='1825'>
         acrt(i)=acrit(15)*(975.-p(i,ktcon(i)))/(975.-pcrit(15))<a name='1826'>
       else if(p(i,ktcon(i)).gt.pcrit(1))then<a name='1827'>
         acrt(i)=acrit(1)<a name='1828'>
       else<a name='1829'>
         k = int((850. - p(i,ktcon(i)))/50.) + 2<a name='1830'>
         k = min(k,15)<a name='1831'>
         k = max(k,2)<a name='1832'>
         acrt(i)=acrit(k)+(acrit(k-1)-acrit(k))*                               &amp;<a name='1833'>
              (p(i,ktcon(i))-pcrit(k))/(pcrit(k-1)-pcrit(k))<a name='1834'>
        endif<a name='1835'>
      endif<a name='1836'>
    enddo<a name='1837'>
<font color=#447700>!<a name='1838'></font>
   do i = its,ite<a name='1839'>
     acrtfct(i) = 1.<a name='1840'>
     w1 = w1s<a name='1841'>
     w2 = w2s<a name='1842'>
     w3 = w3s<a name='1843'>
     w4 = w4s<a name='1844'>
     if(slimsk(i).eq.1.) then<a name='1845'>
       w1 = w1l<a name='1846'>
       w2 = w2l<a name='1847'>
       w3 = w3l<a name='1848'>
       w4 = w4l<a name='1849'>
     endif<a name='1850'>
     if(cnvflg(i)) then<a name='1851'>
       if(pdot(i).le.w4) then<a name='1852'>
         acrtfct(i) = (pdot(i) - w4) / (w3 - w4)<a name='1853'>
       elseif(pdot(i).ge.-w4) then<a name='1854'>
       acrtfct(i) = - (pdot(i) + w4) / (w4 - w3)<a name='1855'>
       else<a name='1856'>
         acrtfct(i) = 0.<a name='1857'>
       endif<a name='1858'>
       acrtfct(i) = max(acrtfct(i),-1.)<a name='1859'>
       acrtfct(i) = min(acrtfct(i),1.)<a name='1860'>
       acrtfct(i) = 1. - acrtfct(i)<a name='1861'>
       dtconv(i) = dt2 + max((1800. - dt2),0.) * (pdot(i) - w2) / (w1 - w2)   <a name='1862'>
       dtconv(i) = max(dtconv(i),dtmin)<a name='1863'>
       dtconv(i) = min(dtconv(i),dtmax)<a name='1864'>
<font color=#447700>!<a name='1865'></font>
     endif<a name='1866'>
   enddo<a name='1867'>
<font color=#447700>!<a name='1868'></font>
<font color=#447700>! large scale forcing<a name='1869'></font>
<font color=#447700>!<a name='1870'></font>
   do i = its,ite<a name='1871'>
     if(cnvflg(i)) then<a name='1872'>
       f(i) = (aa1(i) - acrt(i) * acrtfct(i)) / dtconv(i)<a name='1873'>
       if(f(i).le.0.) cnvflg(i) = .false.<a name='1874'>
     endif<a name='1875'>
     if(cnvflg(i)) then<a name='1876'>
       xk(i) = (xaa0(i) - aa1(i)) / mbdt<a name='1877'>
       if(xk(i).ge.0.) cnvflg(i) = .false.<a name='1878'>
     endif<a name='1879'>
<font color=#447700>!<a name='1880'></font>
<font color=#447700>! kernel, cloud base mass flux<a name='1881'></font>
<font color=#447700>!<a name='1882'></font>
     if(cnvflg(i)) then<a name='1883'>
       xmb(i) = -f(i) / xk(i)<a name='1884'>
       xmb(i) = min(xmb(i),xmbmax(i))<a name='1885'>
     endif<a name='1886'>
<font color=#447700>!<a name='1887'></font>
     if(cnvflg(i)) then<a name='1888'>
     endif<a name='1889'>
<font color=#447700>!<a name='1890'></font>
   enddo<a name='1891'>
   totflg = .true.<a name='1892'>
   do i = its,ite<a name='1893'>
     totflg = totflg .and. (.not. cnvflg(i))<a name='1894'>
   enddo<a name='1895'>
   if(totflg) return<a name='1896'>
<font color=#447700>!<a name='1897'></font>
<font color=#447700>! restore t0 and qo to t1 and q1 in case convection stops<a name='1898'></font>
<font color=#447700>!<a name='1899'></font>
   do k = kts,kmax<a name='1900'>
     do i = its,ite<a name='1901'>
       if (cnvflg(i)) then<a name='1902'>
       to(i,k) = t1(i,k)<a name='1903'>
       qo(i,k) = q1(i,k)<a name='1904'>
       uo(i,k) = u1(i,k)<a name='1905'>
       vo(i,k) = v1(i,k)<a name='1906'>
       qeso(i,k) = 0.01*fpvs(t1(i,k),1,rd_,rv_,cvap_,cliq_,cice,xlv0,xls,psat,t0c_)<a name='1907'>
       qeso(i,k) = eps * qeso(i,k) / (p(i,k) + (eps-1.) * qeso(i,k))<a name='1908'>
       qeso(i,k) = max(qeso(i,k),qmin_)<a name='1909'>
       endif<a name='1910'>
     enddo<a name='1911'>
   enddo<a name='1912'>
<font color=#447700>!<a name='1913'></font>
<font color=#447700>! feedback: simply the changes from the cloud with unit mass flux<a name='1914'></font>
<font color=#447700>!           multiplied by  the mass flux necessary to keep the<a name='1915'></font>
<font color=#447700>!           equilibrium with the larger-scale.<a name='1916'></font>
<font color=#447700>!<a name='1917'></font>
   do i = its,ite<a name='1918'>
     delhbar(i) = 0.<a name='1919'>
     delqbar(i) = 0.<a name='1920'>
     deltbar(i) = 0.<a name='1921'>
     qcond(i) = 0.<a name='1922'>
     qrski(i) = 0.<a name='1923'>
     delubar(i) = 0.<a name='1924'>
     delvbar(i) = 0.<a name='1925'>
   enddo<a name='1926'>
<font color=#447700>!<a name='1927'></font>
   do k = kts,kmax<a name='1928'>
     do i = its,ite<a name='1929'>
       if(cnvflg(i).and.k.le.ktcon(i)) then<a name='1930'>
         aup = 1.<a name='1931'>
         if(k.le.kb(i)) aup = 0.<a name='1932'>
         adw = 1.<a name='1933'>
         if(k.gt.jmin(i)) adw = 0.<a name='1934'>
         dellat = (dellah(i,k) - hvap_ * dellaq(i,k)) / cp_<a name='1935'>
         t1(i,k) = t1(i,k) + dellat * xmb(i) * dt2<a name='1936'>
         q1(i,k) = q1(i,k) + dellaq(i,k) * xmb(i) * dt2<a name='1937'>
         tem=1./rcs<a name='1938'>
         u1(i,k) = u1(i,k) + dellau(i,k) * xmb(i) * dt2 * tem<a name='1939'>
         v1(i,k) = v1(i,k) + dellav(i,k) * xmb(i) * dt2 * tem <a name='1940'>
         dp = 1000. * del(i,k)<a name='1941'>
         delhbar(i) = delhbar(i) + dellah(i,k)*xmb(i)*dp/g_<a name='1942'>
         delqbar(i) = delqbar(i) + dellaq(i,k)*xmb(i)*dp/g_<a name='1943'>
         deltbar(i) = deltbar(i) + dellat*xmb(i)*dp/g_<a name='1944'>
         delubar(i) = delubar(i) + dellau(i,k)*xmb(i)*dp/g_<a name='1945'>
         delvbar(i) = delvbar(i) + dellav(i,k)*xmb(i)*dp/g_<a name='1946'>
       endif<a name='1947'>
     enddo<a name='1948'>
   enddo<a name='1949'>
<font color=#447700>!<a name='1950'></font>
   do i = its,ite<a name='1951'>
     if(cnvflg(i)) then<a name='1952'>
     endif<a name='1953'>
   enddo<a name='1954'>
<font color=#447700>!<a name='1955'></font>
   do k = kts,kmax <a name='1956'>
     do i = its,ite <a name='1957'>
       if (cnvflg(i) .and. k.le.ktcon(i)) then<a name='1958'>
         qeso(i,k)=0.01* fpvs(t1(i,k),1,rd_,rv_,cvap_,cliq_,cice,xlv0,xls,psat,t0c_)<a name='1959'>
         qeso(i,k) = eps * qeso(i,k)/(p(i,k) + (eps-1.)*qeso(i,k))<a name='1960'>
         qeso(i,k) = max(qeso(i,k), qmin_ )<a name='1961'>
       endif<a name='1962'>
     enddo<a name='1963'>
   enddo<a name='1964'>
<font color=#447700>!<a name='1965'></font>
   do i = its,ite <a name='1966'>
     rntot(i) = 0.<a name='1967'>
     delqev(i) = 0.<a name='1968'>
     delq2(i) = 0.<a name='1969'>
     flg(i) = cnvflg(i) <a name='1970'>
   enddo<a name='1971'>
<font color=#447700>!<a name='1972'></font>
<font color=#447700>!  comptute rainfall  <a name='1973'></font>
<font color=#447700>!<a name='1974'></font>
   do k = kmax,kts,-1<a name='1975'>
     do i = its,ite<a name='1976'>
       if(cnvflg(i).and.k.lt.ktcon(i)) then<a name='1977'>
         aup = 1.<a name='1978'>
         if(k.le.kb(i)) aup = 0.<a name='1979'>
         adw = 1.<a name='1980'>
         if(k.ge.jmin(i)) adw = 0.<a name='1981'>
         rntot(i) = rntot(i)                                                   &amp;<a name='1982'>
               + (aup * pwo(i,k) + adw * edto(i) * pwdo(i,k))                  &amp;<a name='1983'>
               * xmb(i) * .001 * dt2<a name='1984'>
       endif<a name='1985'>
     enddo<a name='1986'>
   enddo<a name='1987'>
<font color=#447700>!<a name='1988'></font>
<font color=#447700>!  conversion rainfall (m) and compute the evaporation of falling raindrops <a name='1989'></font>
<font color=#447700>!<a name='1990'></font>
   do k = kmax,kts,-1<a name='1991'>
     do i = its,ite<a name='1992'>
       delq(i) = 0.0<a name='1993'>
       deltv(i) = 0.0<a name='1994'>
       qevap(i) = 0.0<a name='1995'>
       if(cnvflg(i).and.k.lt.ktcon(i)) then<a name='1996'>
         aup = 1.<a name='1997'>
         if(k.le.kb(i)) aup = 0.<a name='1998'>
         adw = 1.<a name='1999'>
         if(k.ge.jmin(i)) adw = 0.<a name='2000'>
         rain(i) = rain(i)                                                     &amp;<a name='2001'>
               + (aup * pwo(i,k) + adw * edto(i) * pwdo(i,k))                  &amp;<a name='2002'>
               * xmb(i) * .001 * dt2<a name='2003'>
       endif<a name='2004'>
       if(cnvflg(i).and.flg(i).and.k.lt.ktcon(i)) then<a name='2005'>
<font color=#447700>!<a name='2006'></font>
         evef = edt(i) * evfacts<a name='2007'>
         if(slimsk(i).eq.1.) evef = edt(i) * evfactl<a name='2008'>
         qcond(i) = evef * (q1(i,k) - qeso(i,k)) / (1. + el2orc *              &amp;<a name='2009'>
                  qeso(i,k) / t1(i,k)**2)<a name='2010'>
         dp = 1000. * del(i,k)<a name='2011'>
         if(rain(i).gt.0..and.qcond(i).lt.0.) then<a name='2012'>
           qevap(i) = -qcond(i) * (1. - exp(-.32 * sqrt(dt2 * rain(i))))<a name='2013'>
           qevap(i) = min(qevap(i), rain(i)*1000.*g_/dp)<a name='2014'>
           delq2(i) = delqev(i) + .001 * qevap(i) * dp / g_<a name='2015'>
           if (delq2(i).gt.rntot(i)) then<a name='2016'>
             qevap(i) = 1000.* g_ * (rntot(i) - delqev(i)) / dp<a name='2017'>
             flg(i) = .false.<a name='2018'>
           endif <a name='2019'>
         endif<a name='2020'>
         if(rain(i).gt.0..and.qevap(i).gt.0.) then<a name='2021'>
           q1(i,k) = q1(i,k) + qevap(i)<a name='2022'>
           t1(i,k) = t1(i,k) - (hvap_/cp_) * qevap(i)<a name='2023'>
           rain(i) = rain(i) - .001 * qevap(i) * dp / g_<a name='2024'>
           delqev(i) = delqev(i) + .001*dp*qevap(i)/g_<a name='2025'>
           deltv(i) =  - (hvap_/cp_)*qevap(i)/dt2<a name='2026'>
           delq(i) =  + qevap(i)/dt2<a name='2027'>
         endif<a name='2028'>
         dellaq(i,k) = dellaq(i,k) + delq(i)/xmb(i)<a name='2029'>
         delqbar(i)  = delqbar(i) + delq(i)*dp/g_<a name='2030'>
         deltbar(i)  = deltbar(i) + deltv(i)*dp/g_<a name='2031'>
       endif<a name='2032'>
     enddo<a name='2033'>
   enddo<a name='2034'>
<font color=#447700>!<a name='2035'></font>
<font color=#447700>!<a name='2036'></font>
<font color=#447700>! consider the negative rain in the event of rain evaporation and downdrafts<a name='2037'></font>
<font color=#447700>!<a name='2038'></font>
   do i = its,ite<a name='2039'>
     if(cnvflg(i)) then<a name='2040'>
       if(rain(i).lt.0..and..not.flg(i)) rain(i) = 0.<a name='2041'>
       if(rain(i).le.0.) then<a name='2042'>
         rain(i) = 0.<a name='2043'>
       else<a name='2044'>
         ktop(i) = ktcon(i)<a name='2045'>
         kbot(i) = kbcon(i)<a name='2046'>
         icps(i) = 1<a name='2047'>
       endif<a name='2048'>
     endif<a name='2049'>
   enddo<a name='2050'>
<font color=#447700>!<a name='2051'></font>
   do k = kts,kmax<a name='2052'>
     do i = its,ite<a name='2053'>
       if(cnvflg(i).and.rain(i).le.0.) then<a name='2054'>
          t1(i,k) = to(i,k)<a name='2055'>
          q1(i,k) = qo(i,k)<a name='2056'>
          u1(i,k) = uo(i,k)<a name='2057'>
          v1(i,k) = vo(i,k)<a name='2058'>
       endif<a name='2059'>
     enddo<a name='2060'>
   enddo<a name='2061'>
<font color=#447700>!<a name='2062'></font>
<font color=#447700>!  detrainment of cloud water and ice<a name='2063'></font>
<font color=#447700>!<a name='2064'></font>
   if (ncloud.gt.0) then<a name='2065'>
     do k = kts,kmax <a name='2066'>
       do i = its,ite <a name='2067'>
         if (cnvflg(i) .and. rain(i).gt.0.) then<a name='2068'>
           if (k.ge.kbcon(i).and.k.le.ktcon(i)) then<a name='2069'>
             tem  = dellal(i,k) * xmb(i) * dt2<a name='2070'>
             tem1 = max(0.0, min(1.0, (tcr-t1(i,k))*tcrf))<a name='2071'>
             if (ncloud.ge.2) then<a name='2072'>
               qi2(i,k) = qi2(i,k) + tem * tem1            <font color=#447700>! ice<a name='2073'></font>
               qc2(i,k) = qc2(i,k) + tem *(1.0-tem1)       <font color=#447700>! water<a name='2074'></font>
             else<a name='2075'>
               qc2(i,k) = qc2(i,k) + tem<a name='2076'>
             endif<a name='2077'>
           endif<a name='2078'>
         endif<a name='2079'>
       enddo<a name='2080'>
     enddo<a name='2081'>
   endif<a name='2082'>
<font color=#447700>!<a name='2083'></font>
   end subroutine nsas2d<a name='2084'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2085'></font>
<A NAME='FPVS'><A href='../../html_code/phys/module_cu_nsas.F.html#FPVS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2086'>
   REAL <font color=#993300>FUNCTION </font><font color=#cc0000>fpvs</font>(t,ice,rd,rv,cvap,cliq,cice,hvap,hsub,psat,t0c) <A href='../../call_to/FPVS.html' TARGET='index'>9</A>,<A href='../../call_from/FPVS.html' TARGET='index'>1</A><a name='2087'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2088'></font>
   IMPLICIT NONE<a name='2089'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2090'></font>
   REAL :: t,rd,rv,cvap,cliq,cice,hvap,hsub,psat,t0c,dldt,xa,xb,dldti,         &amp;<a name='2091'>
           xai,xbi,ttp,tr<a name='2092'>
   INTEGER :: ice<a name='2093'>
<font color=#447700>!<a name='2094'></font>
   ttp=t0c+0.01<a name='2095'>
   dldt=cvap-cliq<a name='2096'>
   xa=-dldt/rv<a name='2097'>
   xb=xa+hvap/(rv*ttp)<a name='2098'>
   dldti=cvap-cice<a name='2099'>
   xai=-dldti/rv<a name='2100'>
   xbi=xai+hsub/(rv*ttp)<a name='2101'>
   tr=ttp/t<a name='2102'>
   if(t.lt.ttp.and.ice.eq.1) then<a name='2103'>
     fpvs=psat*(tr**xai)*exp(xbi*(1.-tr))<a name='2104'>
   else<a name='2105'>
     fpvs=psat*(tr**xa)*exp(xb*(1.-tr))<a name='2106'>
   endif<a name='2107'>
<font color=#447700>!<a name='2108'></font>
   if (t.lt.180.) then<a name='2109'>
     tr=ttp/180.<a name='2110'>
     if(t.lt.ttp.and.ice.eq.1) then<a name='2111'>
       fpvs=psat*(tr**xai)*exp(xbi*(1.-tr))<a name='2112'>
     else<a name='2113'>
       fpvs=psat*(tr**xa)*exp(xb*(1.-tr))<a name='2114'>
     endif<a name='2115'>
   endif<a name='2116'>
<font color=#447700>!<a name='2117'></font>
   if (t.ge.330.) then<a name='2118'>
     tr=ttp/330<a name='2119'>
     if(t.lt.ttp.and.ice.eq.1) then<a name='2120'>
       fpvs=psat*(tr**xai)*exp(xbi*(1.-tr))<a name='2121'>
     else<a name='2122'>
       fpvs=psat*(tr**xa)*exp(xb*(1.-tr))<a name='2123'>
     endif<a name='2124'>
   endif<a name='2125'>
<font color=#447700>!<a name='2126'></font>
   END FUNCTION fpvs<a name='2127'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2128'></font>
<font color=#447700>!<a name='2129'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2130'></font>
<A NAME='NSASINIT'><A href='../../html_code/phys/module_cu_nsas.F.html#NSASINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2131'>
   <font color=#993300>subroutine </font><font color=#cc0000>nsasinit</font>(rthcuten,rqvcuten,rqccuten,rqicuten,                    &amp; <A href='../../call_to/NSASINIT.html' TARGET='index'>1</A><a name='2132'>
                      rucuten,rvcuten,                                         &amp;  <a name='2133'>
                      restart,p_qc,p_qi,p_first_scalar,                        &amp;<a name='2134'>
                      allowed_to_read,                                         &amp;<a name='2135'>
                      ids, ide, jds, jde, kds, kde,                            &amp;<a name='2136'>
                      ims, ime, jms, jme, kms, kme,                            &amp;<a name='2137'>
                      its, ite, jts, jte, kts, kte                  )<a name='2138'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2139'></font>
   implicit none<a name='2140'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2141'></font>
   logical , intent(in)           ::  allowed_to_read,restart<a name='2142'>
   integer , intent(in)           ::  ids, ide, jds, jde, kds, kde,            &amp;<a name='2143'>
                                      ims, ime, jms, jme, kms, kme,            &amp;<a name='2144'>
                                      its, ite, jts, jte, kts, kte<a name='2145'>
   integer , intent(in)           ::  p_first_scalar, p_qi, p_qc<a name='2146'>
   real,     dimension( ims:ime , kms:kme , jms:jme ) , intent(out) ::         &amp;<a name='2147'>
                                                              rthcuten,        &amp;<a name='2148'>
                                                              rqvcuten,        &amp;<a name='2149'>
                                                               rucuten,        &amp;<a name='2150'>
                                                               rvcuten,        &amp;<a name='2151'>
                                                              rqccuten,        &amp;<a name='2152'>
                                                              rqicuten<a name='2153'>
   integer :: i, j, k, itf, jtf, ktf<a name='2154'>
<font color=#447700>!<a name='2155'></font>
   jtf=min0(jte,jde-1)<a name='2156'>
   ktf=min0(kte,kde-1)<a name='2157'>
   itf=min0(ite,ide-1)<a name='2158'>
<font color=#447700>!<a name='2159'></font>
   if(.not.restart)then<a name='2160'>
     do j = jts,jtf<a name='2161'>
       do k = kts,ktf<a name='2162'>
         do i = its,itf<a name='2163'>
           rthcuten(i,k,j)=0.<a name='2164'>
           rqvcuten(i,k,j)=0.<a name='2165'>
           rucuten(i,k,j)=0.   <a name='2166'>
           rvcuten(i,k,j)=0.   <a name='2167'>
         enddo<a name='2168'>
       enddo<a name='2169'>
     enddo<a name='2170'>
<font color=#447700>!<a name='2171'></font>
     if (p_qc .ge. p_first_scalar) then<a name='2172'>
       do j = jts,jtf<a name='2173'>
         do k = kts,ktf<a name='2174'>
           do i = its,itf<a name='2175'>
             rqccuten(i,k,j)=0.<a name='2176'>
           enddo<a name='2177'>
         enddo<a name='2178'>
       enddo<a name='2179'>
     endif<a name='2180'>
<font color=#447700>!<a name='2181'></font>
     if (p_qi .ge. p_first_scalar) then<a name='2182'>
       do j = jts,jtf<a name='2183'>
         do k = kts,ktf<a name='2184'>
           do i = its,itf<a name='2185'>
             rqicuten(i,k,j)=0.<a name='2186'>
           enddo<a name='2187'>
         enddo<a name='2188'>
       enddo<a name='2189'>
     endif<a name='2190'>
   endif<a name='2191'>
<font color=#447700>!<a name='2192'></font>
   end subroutine nsasinit<a name='2193'>
<font color=#447700>!<a name='2194'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2195'></font>
<font color=#447700>! NCEP SCV (Shallow Convection Scheme)<a name='2196'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2197'></font>
<A NAME='NSCV2D'><A href='../../html_code/phys/module_cu_nsas.F.html#NSCV2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2198'>
   <font color=#993300>subroutine </font><font color=#cc0000>nscv2d</font>(delt,del,prsl,prsi,prslk,zl,                              &amp; <A href='../../call_to/NSCV2D.html' TARGET='index'>1</A><a name='2199'>
                 ncloud,qc2,qi2,q1,t1,rain,kbot,ktop,                          &amp;<a name='2200'>
                 icps,                                                         &amp;<a name='2201'>
                 slimsk,dot,u1,v1,                                             &amp;<a name='2202'>
                 cp_,cliq_,cvap_,g_,hvap_,rd_,rv_,fv_,ep2,                     &amp;<a name='2203'>
                 cice,xls,psat,                                                &amp;<a name='2204'>
                 hpbl,hfx,qfx,                                                 &amp;<a name='2205'>
                 pgcon,                                                        &amp;<a name='2206'>
                 ids,ide, jds,jde, kds,kde,                                    &amp;<a name='2207'>
                 ims,ime, jms,jme, kms,kme,                                    &amp;<a name='2208'>
                 its,ite, jts,jte, kts,kte)<a name='2209'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2210'></font>
<font color=#447700>! subprogram:    nscv2d           computes shallow-convective heating and moisng<a name='2211'></font>
<font color=#447700>!<a name='2212'></font>
<font color=#447700>! abstract: computes non-precipitating convective heating and moistening <a name='2213'></font>
<font color=#447700>!   using a one cloud type arakawa-schubert convection scheme as in the ncep<a name='2214'></font>
<font color=#447700>!   sas scheme. the scheme has been operational at ncep gfs model since july 2010<a name='2215'></font>
<font color=#447700>!   the scheme includes updraft and downdraft effects, but the cloud depth is <a name='2216'></font>
<font color=#447700>!   limited less than 150 hpa. <a name='2217'></font>
<font color=#447700>!<a name='2218'></font>
<font color=#447700>! developed by jong-il han and hua-lu pan <a name='2219'></font>
<font color=#447700>!   implemented into wrf by jiheon jang and songyou hong<a name='2220'></font>
<font color=#447700>!   module with cpp-based options is available in grims<a name='2221'></font>
<font color=#447700>!<a name='2222'></font>
<font color=#447700>! program history log:<a name='2223'></font>
<font color=#447700>!   10-07-01 jong-il han  initial operational implementation at ncep gfs<a name='2224'></font>
<font color=#447700>!   10-12-01 jihyeon jang implemented into wrf<a name='2225'></font>
<font color=#447700>!<a name='2226'></font>
<font color=#447700>! subprograms called:<a name='2227'></font>
<font color=#447700>!   fpvs     - function to compute saturation vapor pressure<a name='2228'></font>
<font color=#447700>!<a name='2229'></font>
<font color=#447700>! references:<a name='2230'></font>
<font color=#447700>!   han and pan (2010, wea. forecasting)<a name='2231'></font>
<font color=#447700>!   <a name='2232'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2233'></font>
   implicit none<a name='2234'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2235'></font>
<font color=#447700>!<a name='2236'></font>
<font color=#447700>!  in/out variables<a name='2237'></font>
<font color=#447700>!<a name='2238'></font>
   integer         ::  ids,ide, jds,jde, kds,kde,                              &amp;<a name='2239'>
                       ims,ime, jms,jme, kms,kme,                              &amp;<a name='2240'>
                       its,ite, jts,jte, kts,kte<a name='2241'>
   real            ::  cp_,cliq_,cvap_,g_,hvap_,rd_,rv_,fv_,ep2<a name='2242'>
   real            ::  pi_,qmin_,t0c_<a name='2243'>
   real            ::  cice,xlv0,xls,psat<a name='2244'>
<font color=#447700>!<a name='2245'></font>
   real            ::  delt<a name='2246'>
   real            ::  del(its:ite,kts:kte),                                   &amp;<a name='2247'>
                       prsl(its:ite,kts:kte),prslk(ims:ime,kms:kme),           &amp;<a name='2248'>
                       prsi(its:ite,kts:kte+1),zl(its:ite,kts:kte)<a name='2249'>
   integer         ::  ncloud<a name='2250'>
   real            ::  slimsk(ims:ime)<a name='2251'>
   real            ::  dot(its:ite,kts:kte)<a name='2252'>
   real            ::  hpbl(ims:ime)<a name='2253'>
   real            ::  rcs<a name='2254'>
   real            ::  hfx(ims:ime),qfx(ims:ime)<a name='2255'>
<font color=#447700>!<a name='2256'></font>
   real            ::  qi2(its:ite,kts:kte),qc2(its:ite,kts:kte)<a name='2257'>
   real            ::  q1(its:ite,kts:kte),                                    &amp;<a name='2258'>
                       t1(its:ite,kts:kte),                                    &amp;<a name='2259'>
                       u1(its:ite,kts:kte),                                    &amp;<a name='2260'>
                       v1(its:ite,kts:kte)<a name='2261'>
   integer         ::  icps(its:ite)<a name='2262'>
<font color=#447700>!<a name='2263'></font>
   real            ::  rain(its:ite)<a name='2264'>
   integer         ::  kbot(its:ite),ktop(its:ite)<a name='2265'>
<font color=#447700>!<a name='2266'></font>
<font color=#447700>!  local variables and arrays<a name='2267'></font>
<font color=#447700>!<a name='2268'></font>
   integer         ::  i,j,indx, jmn, k, kk, km1<a name='2269'>
   integer         ::  kpbl(its:ite)<a name='2270'>
<font color=#447700>!<a name='2271'></font>
   real            ::  dellat,                                                 &amp;<a name='2272'>
                       desdt,   deta,    detad,   dg,                          &amp;<a name='2273'>
                       dh,      dhh,     dlnsig,  dp,                          &amp;<a name='2274'>
                       dq,      dqsdp,   dqsdt,   dt,                          &amp;<a name='2275'>
                       dt2,     dtmax,   dtmin,                                &amp;<a name='2276'>
                       dv1h,    dv2h,    dv3h,                                 &amp;<a name='2277'>
                       dv1q,    dv2q,    dv3q,                                 &amp;<a name='2278'>
                       dv1u,    dv2u,    dv3u,                                 &amp;<a name='2279'>
                       dv1v,    dv2v,    dv3v,                                 &amp;<a name='2280'>
                       dz,      dz1,     e1,      clam,                        &amp;<a name='2281'>
                       aafac,                                                  &amp;<a name='2282'>
                       es,      etah,                                          &amp;<a name='2283'>
                       evef,    evfact,  evfactl,                              &amp;<a name='2284'>
                       factor,  fjcap,                                         &amp;<a name='2285'>
                       gamma,   pprime,  betaw,                                &amp;<a name='2286'>
                       qlk,     qrch,    qs,                                   &amp;<a name='2287'>
                       rfact,   shear,   tem1,                                 &amp;<a name='2288'>
                       tem2,    val,     val1,                                 &amp;<a name='2289'>
                       val2,    w1,      w1l,     w1s,                         &amp;<a name='2290'>
                       w2,      w2l,     w2s,     w3,                          &amp;<a name='2291'>
                       w3l,     w3s,     w4,      w4l,                         &amp;<a name='2292'>
                       w4s,     tem,     ptem,    ptem1,                       &amp;<a name='2293'>
                       pgcon<a name='2294'>
<font color=#447700>!<a name='2295'></font>
   integer         ::  kb(its:ite), kbcon(its:ite), kbcon1(its:ite),           &amp;<a name='2296'>
                       ktcon(its:ite), ktcon1(its:ite),                        &amp;<a name='2297'>
                       kbm(its:ite), kmax(its:ite)<a name='2298'>
<font color=#447700>!<a name='2299'></font>
   real            ::  aa1(its:ite),                                           &amp;<a name='2300'>
                       delhbar(its:ite), delq(its:ite),                        &amp;<a name='2301'>
                       delq2(its:ite),   delqev(its:ite), rntot(its:ite),      &amp;<a name='2302'>
                       delqbar(its:ite), deltbar(its:ite),                     &amp;<a name='2303'>
                       deltv(its:ite),   edt(its:ite),                         &amp;<a name='2304'>
                       wstar(its:ite),   sflx(its:ite),                        &amp;<a name='2305'>
                       pdot(its:ite),    po(its:ite,kts:kte),                  &amp;<a name='2306'>
                       qcond(its:ite),   qevap(its:ite),  hmax(its:ite),       &amp;<a name='2307'>
                       vshear(its:ite),                                        &amp;<a name='2308'>
                       xlamud(its:ite),  xmb(its:ite),    xmbmax(its:ite)<a name='2309'>
   real            ::  delubar(its:ite), delvbar(its:ite)<a name='2310'>
<font color=#447700>!<a name='2311'></font>
   real            ::  cincr<a name='2312'>
<font color=#447700>!<a name='2313'></font>
   real            ::  thx(its:ite, kts:kte)<a name='2314'>
   real            ::  rhox(its:ite)<a name='2315'>
   real            ::  tvcon<a name='2316'>
<font color=#447700>!<a name='2317'></font>
   real            ::  p(its:ite,kts:kte),       to(its:ite,kts:kte),          &amp;<a name='2318'>
                       qo(its:ite,kts:kte),      qeso(its:ite,kts:kte),        &amp;<a name='2319'>
                       uo(its:ite,kts:kte),      vo(its:ite,kts:kte)<a name='2320'>
<font color=#447700>!<a name='2321'></font>
<font color=#447700>!  cloud water<a name='2322'></font>
<font color=#447700>!<a name='2323'></font>
   real            ::  qlko_ktcon(its:ite),     dellal(its:ite,kts:kte),       &amp;<a name='2324'>
                       dbyo(its:ite,kts:kte),                                  &amp;<a name='2325'>
                       xlamue(its:ite,kts:kte),                                &amp;<a name='2326'>
                       heo(its:ite,kts:kte),    heso(its:ite,kts:kte),         &amp;<a name='2327'>
                       dellah(its:ite,kts:kte), dellaq(its:ite,kts:kte),       &amp;<a name='2328'>
                       dellau(its:ite,kts:kte), dellav(its:ite,kts:kte),       &amp;<a name='2329'>
                       ucko(its:ite,kts:kte),   vcko(its:ite,kts:kte),         &amp;<a name='2330'>
                       hcko(its:ite,kts:kte),   qcko(its:ite,kts:kte),         &amp;<a name='2331'>
                       eta(its:ite,kts:kte),    zi(its:ite,kts:kte+1),         &amp;<a name='2332'>
                       pwo(its:ite,kts:kte)<a name='2333'>
<font color=#447700>!<a name='2334'></font>
   logical         ::  totflg, cnvflg(its:ite), flg(its:ite)<a name='2335'>
<font color=#447700>!<a name='2336'></font>
<font color=#447700>!  physical parameters<a name='2337'></font>
<font color=#447700>!<a name='2338'></font>
   real,parameter  ::  c0=.002,c1=5.e-4<a name='2339'>
   real,parameter  ::  cincrmax=180.,cincrmin=120.,dthk=25.<a name='2340'>
   real            ::  el2orc,fact1,fact2,eps<a name='2341'>
   real,parameter  ::  h1=0.33333333<a name='2342'>
   real,parameter  ::  tf=233.16, tcr=263.16, tcrf=1.0/(tcr-tf)<a name='2343'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2344'></font>
   pi_ = 3.14159<a name='2345'>
   qmin_ = 1.0e-30<a name='2346'>
   t0c_ = 273.15<a name='2347'>
   xlv0 = hvap_<a name='2348'>
   km1 = kte - 1<a name='2349'>
<font color=#447700>!<a name='2350'></font>
<font color=#447700>!  compute surface buoyancy flux<a name='2351'></font>
<font color=#447700>!<a name='2352'></font>
   do k = kts,kte<a name='2353'>
     do i = its,ite<a name='2354'>
       thx(i,k) = t1(i,k)/prslk(i,k)<a name='2355'>
     enddo<a name='2356'>
   enddo<a name='2357'>
<font color=#447700>!<a name='2358'></font>
   do i = its,ite<a name='2359'>
     tvcon = (1.+fv_*q1(i,1))<a name='2360'>
     rhox(i) = prsl(i,1)*1.e3/(rd_*t1(i,1)*tvcon)<a name='2361'>
   enddo<a name='2362'>
<font color=#447700>!<a name='2363'></font>
   do i = its,ite<a name='2364'>
<font color=#447700>!    sflx(i) = heat(i)+fv_*t1(i,1)*evap(i)<a name='2365'></font>
     sflx(i) = hfx(i)/rhox(i)/cp_ + qfx(i)/rhox(i)*fv_*thx(i,1)<a name='2366'>
   enddo<a name='2367'>
<font color=#447700>!<a name='2368'></font>
<font color=#447700>!  initialize arrays<a name='2369'></font>
<font color=#447700>!<a name='2370'></font>
   do i = its,ite<a name='2371'>
     cnvflg(i) = .true.<a name='2372'>
     if(icps(i).eq.1) cnvflg(i) = .false.<a name='2373'>
     if(sflx(i).le.0.) cnvflg(i) = .false.<a name='2374'>
     if(cnvflg(i)) then<a name='2375'>
       kbot(i)=kte+1<a name='2376'>
       ktop(i)=0<a name='2377'>
     endif<a name='2378'>
     rain(i)=0.<a name='2379'>
     kbcon(i)=kte<a name='2380'>
     ktcon(i)=1<a name='2381'>
     kb(i)=kte<a name='2382'>
     pdot(i) = 0.<a name='2383'>
     qlko_ktcon(i) = 0.<a name='2384'>
     edt(i)  = 0.<a name='2385'>
     aa1(i)  = 0.<a name='2386'>
     vshear(i) = 0.<a name='2387'>
   enddo<a name='2388'>
<font color=#447700>!<a name='2389'></font>
   totflg = .true.<a name='2390'>
   do i = its,ite<a name='2391'>
     totflg = totflg .and. (.not. cnvflg(i))<a name='2392'>
   enddo<a name='2393'>
   if(totflg) return<a name='2394'>
<font color=#447700>!<a name='2395'></font>
   dt2   =  delt<a name='2396'>
   val   =         1200.<a name='2397'>
   dtmin = max(dt2, val )<a name='2398'>
   val   =         3600.<a name='2399'>
   dtmax = max(dt2, val )<a name='2400'>
<font color=#447700>!<a name='2401'></font>
<font color=#447700>!  model tunable parameters are all here<a name='2402'></font>
<font color=#447700>!<a name='2403'></font>
   clam    = .3<a name='2404'>
   aafac   = .1<a name='2405'>
   betaw   = .03<a name='2406'>
   evfact  = 0.3<a name='2407'>
   evfactl = 0.3<a name='2408'>
   val     = 1.<a name='2409'>
<font color=#447700>!<a name='2410'></font>
<font color=#447700>! define miscellaneous values<a name='2411'></font>
<font color=#447700>!<a name='2412'></font>
   el2orc = hvap_*hvap_/(rv_*cp_)<a name='2413'>
   eps    = rd_/rv_ <a name='2414'>
   fact1  = (cvap_-cliq_)/rv_<a name='2415'>
   fact2  = hvap_/rv_-fact1*t0c_<a name='2416'>
<font color=#447700>!<a name='2417'></font>
   w1l     = -8.e-3<a name='2418'>
   w2l     = -4.e-2<a name='2419'>
   w3l     = -5.e-3<a name='2420'>
   w4l     = -5.e-4<a name='2421'>
   w1s     = -2.e-4<a name='2422'>
   w2s     = -2.e-3<a name='2423'>
   w3s     = -1.e-3<a name='2424'>
   w4s     = -2.e-5<a name='2425'>
<font color=#447700>!<a name='2426'></font>
<font color=#447700>!  define top layer for search of the downdraft originating layer<a name='2427'></font>
<font color=#447700>!  and the maximum thetae for updraft<a name='2428'></font>
<font color=#447700>!<a name='2429'></font>
   do i = its,ite<a name='2430'>
     kbm(i)   = kte<a name='2431'>
     kmax(i)  = kte<a name='2432'>
   enddo<a name='2433'>
<font color=#447700>!     <a name='2434'></font>
   do k = kts,kte<a name='2435'>
     do i = its,ite<a name='2436'>
       if (prsl(i,k).gt.prsi(i,1)*0.70) kbm(i) = k + 1<a name='2437'>
       if (prsl(i,k).gt.prsi(i,1)*0.60) kmax(i) = k + 1<a name='2438'>
     enddo<a name='2439'>
   enddo<a name='2440'>
<font color=#447700>!<a name='2441'></font>
   do i = its,ite<a name='2442'>
     kbm(i)   = min(kbm(i),kmax(i))<a name='2443'>
   enddo<a name='2444'>
<font color=#447700>!<a name='2445'></font>
<font color=#447700>!  hydrostatic height assume zero terr and compute<a name='2446'></font>
<font color=#447700>!  updraft entrainment rate as an inverse function of height<a name='2447'></font>
<font color=#447700>!<a name='2448'></font>
   do k = kts+1,kte<a name='2449'>
     do i = its,ite<a name='2450'>
       zi(i,k) = 0.5*(zl(i,k-1)+zl(i,k))<a name='2451'>
     enddo<a name='2452'>
   enddo<a name='2453'>
<font color=#447700>!<a name='2454'></font>
   do k = kts,km1<a name='2455'>
     do i = its,ite<a name='2456'>
       xlamue(i,k) = clam / zi(i,k+1)<a name='2457'>
     enddo<a name='2458'>
   enddo<a name='2459'>
<font color=#447700>!<a name='2460'></font>
   do i = its,ite<a name='2461'>
     xlamue(i,kte) = xlamue(i,km1)<a name='2462'>
   enddo<a name='2463'>
<font color=#447700>!<a name='2464'></font>
<font color=#447700>!  pbl height<a name='2465'></font>
<font color=#447700>!<a name='2466'></font>
   do i = its,ite<a name='2467'>
     flg(i) = cnvflg(i)<a name='2468'>
     kpbl(i)= 1<a name='2469'>
   enddo<a name='2470'>
<font color=#447700>!<a name='2471'></font>
   do k = kts+1,km1<a name='2472'>
     do i = its,ite<a name='2473'>
       if (flg(i).and.zl(i,k).le.hpbl(i)) then <a name='2474'>
         kpbl(i) = k<a name='2475'>
       else<a name='2476'>
         flg(i) = .false.<a name='2477'>
       endif<a name='2478'>
     enddo<a name='2479'>
   enddo<a name='2480'>
<font color=#447700>!<a name='2481'></font>
   do i = its,ite<a name='2482'>
     kpbl(i)= min(kpbl(i),kbm(i))<a name='2483'>
   enddo<a name='2484'>
<font color=#447700>!<a name='2485'></font>
<font color=#447700>!   convert surface pressure to mb from cb<a name='2486'></font>
<font color=#447700>!<a name='2487'></font>
   rcs = 1.<a name='2488'>
   do k = kts,kte<a name='2489'>
     do i = its,ite<a name='2490'>
       if (cnvflg(i) .and. k .le. kmax(i)) then<a name='2491'>
         p(i,k) = prsl(i,k) * 10.0<a name='2492'>
         eta(i,k)  = 1.<a name='2493'>
         hcko(i,k) = 0.<a name='2494'>
         qcko(i,k) = 0.<a name='2495'>
         ucko(i,k) = 0.<a name='2496'>
         vcko(i,k) = 0.<a name='2497'>
         dbyo(i,k) = 0.<a name='2498'>
         pwo(i,k)  = 0.<a name='2499'>
         dellal(i,k) = 0.<a name='2500'>
         to(i,k)   = t1(i,k)<a name='2501'>
         qo(i,k)   = q1(i,k)<a name='2502'>
         uo(i,k)   = u1(i,k) * rcs<a name='2503'>
         vo(i,k)   = v1(i,k) * rcs<a name='2504'>
       endif<a name='2505'>
     enddo<a name='2506'>
   enddo<a name='2507'>
<font color=#447700>!<a name='2508'></font>
<font color=#447700>!<a name='2509'></font>
<font color=#447700>!  column variables<a name='2510'></font>
<font color=#447700>!  p is pressure of the layer (mb)<a name='2511'></font>
<font color=#447700>!  t is temperature at t-dt (k)..tn<a name='2512'></font>
<font color=#447700>!  q is mixing ratio at t-dt (kg/kg)..qn<a name='2513'></font>
<font color=#447700>!  to is temperature at t+dt (k)... this is after advection and turbulan<a name='2514'></font>
<font color=#447700>!  qo is mixing ratio at t+dt (kg/kg)..q1<a name='2515'></font>
<font color=#447700>!<a name='2516'></font>
   do k = kts, kte<a name='2517'>
     do i=its,ite<a name='2518'>
       if (cnvflg(i) .and. k .le. kmax(i)) then<a name='2519'>
         qeso(i,k) = 0.01 * fpvs(to(i,k),1,rd_,rv_,cvap_,cliq_,cice,xlv0,xls,psat,t0c_)<a name='2520'>
         qeso(i,k) = eps * qeso(i,k) / (p(i,k) + (eps-1.)*qeso(i,k))<a name='2521'>
         val1      =             1.e-8<a name='2522'>
         qeso(i,k) = max(qeso(i,k), val1)<a name='2523'>
         val2      =           1.e-10<a name='2524'>
         qo(i,k)   = max(qo(i,k), val2 )<a name='2525'>
       endif<a name='2526'>
     enddo<a name='2527'>
   enddo<a name='2528'>
<font color=#447700>!<a name='2529'></font>
<font color=#447700>!  compute moist static energy<a name='2530'></font>
<font color=#447700>!<a name='2531'></font>
   do k = kts,kte<a name='2532'>
     do i=its,ite<a name='2533'>
       if (cnvflg(i) .and. k .le. kmax(i)) then<a name='2534'>
         tem       = g_ * zl(i,k) + cp_ * to(i,k)<a name='2535'>
         heo(i,k)  = tem  + hvap_ * qo(i,k)<a name='2536'>
         heso(i,k) = tem  + hvap_ * qeso(i,k)<a name='2537'>
       endif<a name='2538'>
     enddo<a name='2539'>
   enddo<a name='2540'>
<font color=#447700>!<a name='2541'></font>
<font color=#447700>!  determine level with largest moist static energy within pbl<a name='2542'></font>
<font color=#447700>!  this is the level where updraft starts<a name='2543'></font>
<font color=#447700>!<a name='2544'></font>
   do i=its,ite<a name='2545'>
     if (cnvflg(i)) then<a name='2546'>
       hmax(i) = heo(i,1)<a name='2547'>
       kb(i) = 1<a name='2548'>
     endif<a name='2549'>
   enddo<a name='2550'>
<font color=#447700>!<a name='2551'></font>
   do k = kts+1, kte<a name='2552'>
     do i=its,ite<a name='2553'>
       if (cnvflg(i).and.k.le.kpbl(i)) then<a name='2554'>
         if(heo(i,k).gt.hmax(i)) then<a name='2555'>
           kb(i)   = k<a name='2556'>
           hmax(i) = heo(i,k)<a name='2557'>
         endif<a name='2558'>
       endif<a name='2559'>
     enddo<a name='2560'>
   enddo<a name='2561'>
<font color=#447700>!<a name='2562'></font>
   do k = kts, km1<a name='2563'>
     do i=its,ite<a name='2564'>
       if (cnvflg(i) .and. k .le. kmax(i)-1) then<a name='2565'>
         dz      = .5 * (zl(i,k+1) - zl(i,k))<a name='2566'>
         dp      = .5 * (p(i,k+1) - p(i,k))<a name='2567'>
         es = 0.01*fpvs(to(i,k+1),1,rd_,rv_,cvap_,cliq_,cice,xlv0,xls,psat,t0c_)<a name='2568'>
         pprime  = p(i,k+1) + (eps-1.) * es<a name='2569'>
         qs      = eps * es / pprime<a name='2570'>
         dqsdp   = - qs / pprime<a name='2571'>
         desdt   = es * (fact1 / to(i,k+1) + fact2 / (to(i,k+1)**2))<a name='2572'>
         dqsdt   = qs * p(i,k+1) * desdt / (es * pprime)<a name='2573'>
         gamma   = el2orc * qeso(i,k+1) / (to(i,k+1)**2)<a name='2574'>
         dt      = (g_ * dz + hvap_ * dqsdp * dp) / (cp_ * (1. + gamma))<a name='2575'>
         dq      = dqsdt * dt + dqsdp * dp<a name='2576'>
         to(i,k) = to(i,k+1) + dt<a name='2577'>
         qo(i,k) = qo(i,k+1) + dq<a name='2578'>
         po(i,k) = .5 * (p(i,k) + p(i,k+1))<a name='2579'>
       endif<a name='2580'>
     enddo<a name='2581'>
   enddo<a name='2582'>
<font color=#447700>!<a name='2583'></font>
   do k = kts, km1<a name='2584'>
     do i=its,ite<a name='2585'>
       if (cnvflg(i) .and. k .le. kmax(i)-1) then<a name='2586'>
         qeso(i,k)=0.01*fpvs(to(i,k),1,rd_,rv_,cvap_,cliq_,cice,xlv0,xls,psat,t0c_)<a name='2587'>
         qeso(i,k) = eps * qeso(i,k) / (po(i,k) + (eps-1.) * qeso(i,k))<a name='2588'>
         val1      =             1.e-8<a name='2589'>
         qeso(i,k) = max(qeso(i,k), val1)<a name='2590'>
         val2      =           1.e-10<a name='2591'>
         qo(i,k)   = max(qo(i,k), val2 )<a name='2592'>
         heo(i,k)  = .5 * g_ * (zl(i,k) + zl(i,k+1)) +                         &amp;<a name='2593'>
                        cp_ * to(i,k) + hvap_ * qo(i,k)<a name='2594'>
         heso(i,k) = .5 * g_ * (zl(i,k) + zl(i,k+1)) +                         &amp;<a name='2595'>
                        cp_ * to(i,k) + hvap_ * qeso(i,k)<a name='2596'>
         uo(i,k)   = .5 * (uo(i,k) + uo(i,k+1))<a name='2597'>
         vo(i,k)   = .5 * (vo(i,k) + vo(i,k+1))<a name='2598'>
       endif<a name='2599'>
     enddo<a name='2600'>
   enddo<a name='2601'>
<font color=#447700>!<a name='2602'></font>
<font color=#447700>!  look for the level of free convection as cloud base<a name='2603'></font>
<font color=#447700>!<a name='2604'></font>
   do i=its,ite<a name='2605'>
     flg(i)   = cnvflg(i)<a name='2606'>
     if(flg(i)) kbcon(i) = kmax(i)<a name='2607'>
   enddo<a name='2608'>
<font color=#447700>!<a name='2609'></font>
   do k = kts+1, km1<a name='2610'>
     do i=its,ite<a name='2611'>
       if (flg(i).and.k.lt.kbm(i)) then<a name='2612'>
         if(k.gt.kb(i).and.heo(i,kb(i)).gt.heso(i,k)) then<a name='2613'>
           kbcon(i) = k<a name='2614'>
           flg(i)   = .false.<a name='2615'>
         endif<a name='2616'>
       endif<a name='2617'>
     enddo<a name='2618'>
   enddo<a name='2619'>
<font color=#447700>!<a name='2620'></font>
   do i=its,ite<a name='2621'>
     if(cnvflg(i)) then<a name='2622'>
       if(kbcon(i).eq.kmax(i)) cnvflg(i) = .false.<a name='2623'>
     endif<a name='2624'>
   enddo<a name='2625'>
<font color=#447700>!<a name='2626'></font>
   totflg = .true.<a name='2627'>
   do i=its,ite<a name='2628'>
     totflg = totflg .and. (.not. cnvflg(i))<a name='2629'>
   enddo<a name='2630'>
   if(totflg) return<a name='2631'>
<font color=#447700>!<a name='2632'></font>
<font color=#447700>!  determine critical convective inhibition<a name='2633'></font>
<font color=#447700>!  as a function of vertical velocity at cloud base.<a name='2634'></font>
<font color=#447700>!<a name='2635'></font>
   do i=its,ite<a name='2636'>
     if(cnvflg(i)) then<a name='2637'>
       pdot(i)  = 10.* dot(i,kbcon(i))<a name='2638'>
     endif<a name='2639'>
   enddo<a name='2640'>
<font color=#447700>!<a name='2641'></font>
   do i=its,ite<a name='2642'>
     if(cnvflg(i)) then<a name='2643'>
       if(slimsk(i).eq.1.) then<a name='2644'>
         w1 = w1l<a name='2645'>
         w2 = w2l<a name='2646'>
         w3 = w3l<a name='2647'>
         w4 = w4l<a name='2648'>
       else<a name='2649'>
         w1 = w1s<a name='2650'>
         w2 = w2s<a name='2651'>
         w3 = w3s<a name='2652'>
         w4 = w4s<a name='2653'>
       endif<a name='2654'>
       if(pdot(i).le.w4) then<a name='2655'>
         ptem = (pdot(i) - w4) / (w3 - w4)<a name='2656'>
       elseif(pdot(i).ge.-w4) then<a name='2657'>
         ptem = - (pdot(i) + w4) / (w4 - w3)<a name='2658'>
       else<a name='2659'>
         ptem = 0.<a name='2660'>
       endif<a name='2661'>
       val1    =             -1.<a name='2662'>
       ptem = max(ptem,val1)<a name='2663'>
       val2    =             1.<a name='2664'>
       ptem = min(ptem,val2)<a name='2665'>
       ptem = 1. - ptem<a name='2666'>
       ptem1= .5*(cincrmax-cincrmin)<a name='2667'>
       cincr = cincrmax - ptem * ptem1<a name='2668'>
       tem1 = p(i,kb(i)) - p(i,kbcon(i))<a name='2669'>
       if(tem1.gt.cincr) then<a name='2670'>
         cnvflg(i) = .false.<a name='2671'>
       endif<a name='2672'>
     endif<a name='2673'>
   enddo<a name='2674'>
<font color=#447700>!<a name='2675'></font>
   totflg = .true.<a name='2676'>
   do i=its,ite<a name='2677'>
     totflg = totflg .and. (.not. cnvflg(i))<a name='2678'>
   enddo<a name='2679'>
   if(totflg) return<a name='2680'>
<font color=#447700>!<a name='2681'></font>
<font color=#447700>!  assume the detrainment rate for the updrafts to be same as <a name='2682'></font>
<font color=#447700>!  the entrainment rate at cloud base<a name='2683'></font>
<font color=#447700>!<a name='2684'></font>
   do i = its,ite<a name='2685'>
     if(cnvflg(i)) then<a name='2686'>
       xlamud(i) = xlamue(i,kbcon(i))<a name='2687'>
     endif<a name='2688'>
   enddo<a name='2689'>
<font color=#447700>!<a name='2690'></font>
<font color=#447700>!  determine updraft mass flux for the subcloud layers<a name='2691'></font>
<font color=#447700>!<a name='2692'></font>
   do k = km1, kts, -1<a name='2693'>
     do i = its,ite<a name='2694'>
       if (cnvflg(i)) then<a name='2695'>
         if(k.lt.kbcon(i).and.k.ge.kb(i)) then<a name='2696'>
           dz       = zi(i,k+2) - zi(i,k+1)<a name='2697'>
           ptem     = 0.5*(xlamue(i,k)+xlamue(i,k+1))-xlamud(i)<a name='2698'>
           eta(i,k) = eta(i,k+1) / (1. + ptem * dz)<a name='2699'>
         endif<a name='2700'>
       endif<a name='2701'>
     enddo<a name='2702'>
   enddo<a name='2703'>
<font color=#447700>!<a name='2704'></font>
<font color=#447700>!  compute mass flux above cloud base<a name='2705'></font>
<font color=#447700>!<a name='2706'></font>
   do k = kts+1, km1<a name='2707'>
     do i = its,ite<a name='2708'>
       if(cnvflg(i))then<a name='2709'>
         if(k.gt.kbcon(i).and.k.lt.kmax(i)) then<a name='2710'>
           dz       = zi(i,k+1) - zi(i,k)<a name='2711'>
           ptem     = 0.5*(xlamue(i,k)+xlamue(i,k-1))-xlamud(i)<a name='2712'>
           eta(i,k) = eta(i,k-1) * (1 + ptem * dz)<a name='2713'>
         endif<a name='2714'>
       endif<a name='2715'>
     enddo<a name='2716'>
   enddo<a name='2717'>
<font color=#447700>!<a name='2718'></font>
<font color=#447700>!  compute updraft cloud property<a name='2719'></font>
<font color=#447700>!<a name='2720'></font>
   do i = its,ite<a name='2721'>
     if(cnvflg(i)) then<a name='2722'>
       indx         = kb(i)<a name='2723'>
       hcko(i,indx) = heo(i,indx)<a name='2724'>
       ucko(i,indx) = uo(i,indx)<a name='2725'>
       vcko(i,indx) = vo(i,indx)<a name='2726'>
     endif<a name='2727'>
   enddo<a name='2728'>
<font color=#447700>!<a name='2729'></font>
   do k = kts+1, km1<a name='2730'>
     do i = its,ite<a name='2731'>
       if (cnvflg(i)) then<a name='2732'>
         if(k.gt.kb(i).and.k.lt.kmax(i)) then<a name='2733'>
           dz   = zi(i,k+1) - zi(i,k)<a name='2734'>
           tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='2735'>
           tem1 = 0.5 * xlamud(i) * dz<a name='2736'>
           factor = 1. + tem - tem1<a name='2737'>
           ptem = 0.5 * tem + pgcon<a name='2738'>
           ptem1= 0.5 * tem - pgcon<a name='2739'>
           hcko(i,k) = ((1.-tem1)*hcko(i,k-1)+tem*0.5*                         &amp;<a name='2740'>
                       (heo(i,k)+heo(i,k-1)))/factor<a name='2741'>
           ucko(i,k) = ((1.-tem1)*ucko(i,k-1)+ptem*uo(i,k)                     &amp;<a name='2742'>
                       +ptem1*uo(i,k-1))/factor<a name='2743'>
           vcko(i,k) = ((1.-tem1)*vcko(i,k-1)+ptem*vo(i,k)                     &amp;<a name='2744'>
                       +ptem1*vo(i,k-1))/factor<a name='2745'>
           dbyo(i,k) = hcko(i,k) - heso(i,k)<a name='2746'>
         endif<a name='2747'>
       endif<a name='2748'>
     enddo<a name='2749'>
   enddo<a name='2750'>
<font color=#447700>!<a name='2751'></font>
<font color=#447700>!   taking account into convection inhibition due to existence of<a name='2752'></font>
<font color=#447700>!    dry layers below cloud base<a name='2753'></font>
<font color=#447700>!<a name='2754'></font>
   do i=its,ite<a name='2755'>
     flg(i) = cnvflg(i)<a name='2756'>
     kbcon1(i) = kmax(i)<a name='2757'>
   enddo<a name='2758'>
<font color=#447700>!<a name='2759'></font>
   do k = kts+1, km1<a name='2760'>
     do i=its,ite<a name='2761'>
       if (flg(i).and.k.lt.kbm(i)) then<a name='2762'>
         if(k.ge.kbcon(i).and.dbyo(i,k).gt.0.) then<a name='2763'>
           kbcon1(i) = k<a name='2764'>
           flg(i)    = .false.<a name='2765'>
         endif<a name='2766'>
       endif<a name='2767'>
     enddo<a name='2768'>
   enddo<a name='2769'>
<font color=#447700>!<a name='2770'></font>
   do i=its,ite<a name='2771'>
     if(cnvflg(i)) then<a name='2772'>
       if(kbcon1(i).eq.kmax(i)) cnvflg(i) = .false.<a name='2773'>
     endif<a name='2774'>
   enddo<a name='2775'>
<font color=#447700>!<a name='2776'></font>
   do i=its,ite<a name='2777'>
     if(cnvflg(i)) then<a name='2778'>
       tem = p(i,kbcon(i)) - p(i,kbcon1(i))<a name='2779'>
       if(tem.gt.dthk) then<a name='2780'>
         cnvflg(i) = .false.<a name='2781'>
       endif<a name='2782'>
     endif<a name='2783'>
   enddo<a name='2784'>
<font color=#447700>!<a name='2785'></font>
   totflg = .true.<a name='2786'>
   do i = its,ite<a name='2787'>
     totflg = totflg .and. (.not. cnvflg(i))<a name='2788'>
   enddo<a name='2789'>
   if(totflg) return<a name='2790'>
<font color=#447700>!<a name='2791'></font>
<font color=#447700>!  determine first guess cloud top as the level of zero buoyancy<a name='2792'></font>
<font color=#447700>!    limited to the level of sigma=0.7<a name='2793'></font>
<font color=#447700>!<a name='2794'></font>
   do i = its,ite<a name='2795'>
     flg(i) = cnvflg(i)<a name='2796'>
     if(flg(i)) ktcon(i) = kbm(i)<a name='2797'>
   enddo<a name='2798'>
<font color=#447700>!<a name='2799'></font>
   do k = kts+1, km1<a name='2800'>
     do i=its,ite<a name='2801'>
       if (flg(i).and.k .lt. kbm(i)) then<a name='2802'>
         if(k.gt.kbcon1(i).and.dbyo(i,k).lt.0.) then<a name='2803'>
           ktcon(i) = k<a name='2804'>
           flg(i)   = .false.<a name='2805'>
         endif<a name='2806'>
       endif<a name='2807'>
     enddo<a name='2808'>
   enddo<a name='2809'>
<font color=#447700>!<a name='2810'></font>
<font color=#447700>!  specify upper limit of mass flux at cloud base<a name='2811'></font>
<font color=#447700>!<a name='2812'></font>
   do i = its,ite<a name='2813'>
     if(cnvflg(i)) then<a name='2814'>
       k = kbcon(i)<a name='2815'>
       dp = 1000. * del(i,k)<a name='2816'>
       xmbmax(i) = dp / (g_ * dt2)<a name='2817'>
     endif<a name='2818'>
   enddo<a name='2819'>
<font color=#447700>!<a name='2820'></font>
<font color=#447700>!  compute cloud moisture property and precipitation<a name='2821'></font>
<font color=#447700>!<a name='2822'></font>
   do i = its,ite<a name='2823'>
     if (cnvflg(i)) then<a name='2824'>
       aa1(i) = 0.<a name='2825'>
       qcko(i,kb(i)) = qo(i,kb(i))<a name='2826'>
     endif<a name='2827'>
   enddo<a name='2828'>
<font color=#447700>!<a name='2829'></font>
   do k = kts+1, km1<a name='2830'>
     do i = its,ite<a name='2831'>
       if (cnvflg(i)) then<a name='2832'>
         if(k.gt.kb(i).and.k.lt.ktcon(i)) then<a name='2833'>
           dz    = zi(i,k+1) - zi(i,k)<a name='2834'>
           gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='2835'>
           qrch = qeso(i,k) + gamma * dbyo(i,k) / (hvap_ * (1. + gamma))<a name='2836'>
           tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='2837'>
           tem1 = 0.5 * xlamud(i) * dz<a name='2838'>
           factor = 1. + tem - tem1<a name='2839'>
           qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*                         &amp;<a name='2840'>
                       (qo(i,k)+qo(i,k-1)))/factor<a name='2841'>
           dq = eta(i,k) * (qcko(i,k) - qrch)<a name='2842'>
<font color=#447700>!<a name='2843'></font>
<font color=#447700>!          rhbar(i) = rhbar(i) + qo(i,k) / qeso(i,k)<a name='2844'></font>
<font color=#447700>!<a name='2845'></font>
<font color=#447700>!  below lfc check if there is excess moisture to release latent heat<a name='2846'></font>
<font color=#447700>!<a name='2847'></font>
           if(k.ge.kbcon(i).and.dq.gt.0.) then<a name='2848'>
             etah = .5 * (eta(i,k) + eta(i,k-1))<a name='2849'>
             if(ncloud.gt.0) then<a name='2850'>
               dp = 1000. * del(i,k)<a name='2851'>
               qlk = dq / (eta(i,k) + etah * (c0 + c1) * dz)<a name='2852'>
               dellal(i,k) = etah * c1 * dz * qlk * g_ / dp<a name='2853'>
             else<a name='2854'>
               qlk = dq / (eta(i,k) + etah * c0 * dz)<a name='2855'>
             endif<a name='2856'>
             aa1(i) = aa1(i) - dz * g_ * qlk<a name='2857'>
             qcko(i,k)= qlk + qrch<a name='2858'>
             pwo(i,k) = etah * c0 * dz * qlk<a name='2859'>
           endif<a name='2860'>
         endif<a name='2861'>
       endif<a name='2862'>
     enddo<a name='2863'>
   enddo<a name='2864'>
<font color=#447700>!<a name='2865'></font>
<font color=#447700>!  calculate cloud work function<a name='2866'></font>
<font color=#447700>!<a name='2867'></font>
   do k = kts+1, km1<a name='2868'>
     do i = its,ite<a name='2869'>
       if (cnvflg(i)) then<a name='2870'>
         if(k.ge.kbcon(i).and.k.lt.ktcon(i)) then<a name='2871'>
           dz1 = zl(i,k+1) - zl(i,k)        <a name='2872'>
           gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='2873'>
           rfact =  1. + fv_ * cp_ * gamma * to(i,k) / hvap_<a name='2874'>
           aa1(i) = aa1(i) + dz1 * (g_ / (cp_ * to(i,k)))                      &amp;<a name='2875'>
                  * dbyo(i,k) / (1. + gamma) * rfact<a name='2876'>
           val = 0.<a name='2877'>
           aa1(i)=aa1(i)+ dz1 * g_ * fv_ * max(val,(qeso(i,k) - qo(i,k)))<a name='2878'>
         endif<a name='2879'>
       endif<a name='2880'>
     enddo<a name='2881'>
   enddo<a name='2882'>
<font color=#447700>!<a name='2883'></font>
   do i = its,ite<a name='2884'>
     if(cnvflg(i).and.aa1(i).le.0.) cnvflg(i) = .false.<a name='2885'>
   enddo<a name='2886'>
<font color=#447700>!<a name='2887'></font>
   totflg = .true.<a name='2888'>
   do i=its,ite<a name='2889'>
     totflg = totflg .and. (.not. cnvflg(i))<a name='2890'>
   enddo<a name='2891'>
   if(totflg) return<a name='2892'>
<font color=#447700>!<a name='2893'></font>
<font color=#447700>!  estimate the convective overshooting as the level<a name='2894'></font>
<font color=#447700>!    where the [aafac * cloud work function] becomes zero,<a name='2895'></font>
<font color=#447700>!    which is the final cloud top limited to the level of sigma=0.7<a name='2896'></font>
<font color=#447700>!<a name='2897'></font>
   do i = its,ite<a name='2898'>
     if (cnvflg(i)) then<a name='2899'>
       aa1(i) = aafac * aa1(i)<a name='2900'>
     endif<a name='2901'>
   enddo<a name='2902'>
<font color=#447700>!<a name='2903'></font>
   do i = its,ite<a name='2904'>
     flg(i) = cnvflg(i)<a name='2905'>
     ktcon1(i) = kbm(i)<a name='2906'>
   enddo<a name='2907'>
<font color=#447700>!<a name='2908'></font>
   do k = kts+1,km1<a name='2909'>
     do i = its,ite<a name='2910'>
       if (flg(i)) then<a name='2911'>
         if(k.ge.ktcon(i).and.k.lt.kbm(i)) then<a name='2912'>
           dz1 = zl(i,k+1) - zl(i,k)<a name='2913'>
           gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='2914'>
           rfact =  1. + fv_ * cp_ * gamma                                     &amp;<a name='2915'>
                   * to(i,k) / hvap_<a name='2916'>
           aa1(i) = aa1(i) +                                                   &amp;<a name='2917'>
                   dz1 * (g_ / (cp_ * to(i,k)))                                &amp;<a name='2918'>
                   * dbyo(i,k) / (1. + gamma) * rfact<a name='2919'>
           if(aa1(i).lt.0.) then<a name='2920'>
             ktcon1(i) = k<a name='2921'>
             flg(i) = .false.<a name='2922'>
           endif<a name='2923'>
         endif<a name='2924'>
       endif<a name='2925'>
     enddo<a name='2926'>
   enddo<a name='2927'>
<font color=#447700>!<a name='2928'></font>
<font color=#447700>!  compute cloud moisture property, detraining cloud water<a name='2929'></font>
<font color=#447700>!    and precipitation in overshooting layers<a name='2930'></font>
<font color=#447700>!<a name='2931'></font>
   do k = kts+1,km1<a name='2932'>
     do i = its,ite<a name='2933'>
       if (cnvflg(i)) then<a name='2934'>
         if(k.ge.ktcon(i).and.k.lt.ktcon1(i)) then<a name='2935'>
           dz    = zi(i,k+1) - zi(i,k)<a name='2936'>
           gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='2937'>
           qrch = qeso(i,k)                                                    &amp;<a name='2938'>
                + gamma * dbyo(i,k) / (hvap_ * (1. + gamma))<a name='2939'>
           tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1)) * dz<a name='2940'>
           tem1 = 0.5 * xlamud(i) * dz<a name='2941'>
           factor = 1. + tem - tem1<a name='2942'>
           qcko(i,k) = ((1.-tem1)*qcko(i,k-1)+tem*0.5*                         &amp;<a name='2943'>
                       (qo(i,k)+qo(i,k-1)))/factor<a name='2944'>
           dq = eta(i,k) * (qcko(i,k) - qrch)<a name='2945'>
<font color=#447700>!<a name='2946'></font>
<font color=#447700>!  check if there is excess moisture to release latent heat<a name='2947'></font>
<font color=#447700>!<a name='2948'></font>
           if(dq.gt.0.) then<a name='2949'>
             etah = .5 * (eta(i,k) + eta(i,k-1))<a name='2950'>
             if(ncloud.gt.0) then<a name='2951'>
               dp = 1000. * del(i,k)<a name='2952'>
               qlk = dq / (eta(i,k) + etah * (c0 + c1) * dz)<a name='2953'>
               dellal(i,k) = etah * c1 * dz * qlk * g_ / dp<a name='2954'>
             else<a name='2955'>
               qlk = dq / (eta(i,k) + etah * c0 * dz)<a name='2956'>
             endif<a name='2957'>
             qcko(i,k) = qlk + qrch<a name='2958'>
             pwo(i,k) = etah * c0 * dz * qlk<a name='2959'>
           endif<a name='2960'>
         endif<a name='2961'>
       endif<a name='2962'>
     enddo<a name='2963'>
   enddo<a name='2964'>
<font color=#447700>!<a name='2965'></font>
<font color=#447700>! exchange ktcon with ktcon1<a name='2966'></font>
<font color=#447700>!<a name='2967'></font>
   do i = its,ite<a name='2968'>
     if(cnvflg(i)) then<a name='2969'>
       kk = ktcon(i)<a name='2970'>
       ktcon(i) = ktcon1(i)<a name='2971'>
       ktcon1(i) = kk<a name='2972'>
     endif<a name='2973'>
   enddo<a name='2974'>
<font color=#447700>!<a name='2975'></font>
<font color=#447700>!  this section is ready for cloud water<a name='2976'></font>
<font color=#447700>!<a name='2977'></font>
   if(ncloud.gt.0) then<a name='2978'>
<font color=#447700>!<a name='2979'></font>
<font color=#447700>!  compute liquid and vapor separation at cloud top<a name='2980'></font>
<font color=#447700>!<a name='2981'></font>
     do i = its,ite<a name='2982'>
       if(cnvflg(i)) then<a name='2983'>
         k = ktcon(i) - 1<a name='2984'>
         gamma = el2orc * qeso(i,k) / (to(i,k)**2)<a name='2985'>
         qrch = qeso(i,k)                                                      &amp;<a name='2986'>
              + gamma * dbyo(i,k) / (hvap_ * (1. + gamma))<a name='2987'>
         dq = qcko(i,k) - qrch<a name='2988'>
<font color=#447700>!<a name='2989'></font>
<font color=#447700>!  check if there is excess moisture to release latent heat<a name='2990'></font>
<font color=#447700>!<a name='2991'></font>
         if(dq.gt.0.) then<a name='2992'>
           qlko_ktcon(i) = dq<a name='2993'>
           qcko(i,k) = qrch<a name='2994'>
         endif<a name='2995'>
       endif<a name='2996'>
     enddo<a name='2997'>
<font color=#447700>!<a name='2998'></font>
   endif<a name='2999'>
<font color=#447700>!<a name='3000'></font>
<font color=#447700>!--- compute precipitation efficiency in terms of windshear<a name='3001'></font>
<font color=#447700>!<a name='3002'></font>
   do i = its,ite<a name='3003'>
     if(cnvflg(i)) then<a name='3004'>
       vshear(i) = 0.<a name='3005'>
     endif<a name='3006'>
   enddo<a name='3007'>
<font color=#447700>!<a name='3008'></font>
   do k = kts+1,kte<a name='3009'>
     do i = its,ite<a name='3010'>
       if (cnvflg(i)) then<a name='3011'>
         if(k.gt.kb(i).and.k.le.ktcon(i)) then<a name='3012'>
           shear= sqrt((uo(i,k)-uo(i,k-1)) ** 2 + (vo(i,k)-vo(i,k-1)) ** 2)<a name='3013'>
           vshear(i) = vshear(i) + shear<a name='3014'>
         endif<a name='3015'>
       endif<a name='3016'>
     enddo<a name='3017'>
   enddo<a name='3018'>
<font color=#447700>!<a name='3019'></font>
   do i = its,ite<a name='3020'>
     if(cnvflg(i)) then<a name='3021'>
       vshear(i) = 1.e3 * vshear(i) / (zi(i,ktcon(i)+1)-zi(i,kb(i)+1))<a name='3022'>
       e1=1.591-.639*vshear(i)                                                 &amp;<a name='3023'>
             +.0953*(vshear(i)**2)-.00496*(vshear(i)**3)<a name='3024'>
       edt(i)=1.-e1<a name='3025'>
       val =         .9<a name='3026'>
       edt(i) = min(edt(i),val)<a name='3027'>
       val =         .0<a name='3028'>
       edt(i) = max(edt(i),val)<a name='3029'>
     endif<a name='3030'>
   enddo<a name='3031'>
<font color=#447700>!<a name='3032'></font>
<font color=#447700>!--- what would the change be, that a cloud with unit mass<a name='3033'></font>
<font color=#447700>!--- will do to the environment?<a name='3034'></font>
<font color=#447700>!<a name='3035'></font>
   do k = kts,kte<a name='3036'>
     do i = its,ite<a name='3037'>
       if(cnvflg(i) .and. k .le. kmax(i)) then<a name='3038'>
         dellah(i,k) = 0.<a name='3039'>
         dellaq(i,k) = 0.<a name='3040'>
         dellau(i,k) = 0.<a name='3041'>
         dellav(i,k) = 0.<a name='3042'>
       endif<a name='3043'>
     enddo<a name='3044'>
   enddo<a name='3045'>
<font color=#447700>!<a name='3046'></font>
<font color=#447700>!--- changed due to subsidence and entrainment<a name='3047'></font>
<font color=#447700>!<a name='3048'></font>
   do k = kts+1,km1<a name='3049'>
     do i = its,ite<a name='3050'>
       if (cnvflg(i)) then<a name='3051'>
         if(k.gt.kb(i).and.k.lt.ktcon(i)) then<a name='3052'>
           dp = 1000. * del(i,k)<a name='3053'>
           dz = zi(i,k+1) - zi(i,k)<a name='3054'>
<font color=#447700>!<a name='3055'></font>
           dv1h = heo(i,k)<a name='3056'>
           dv2h = .5 * (heo(i,k) + heo(i,k-1))<a name='3057'>
           dv3h = heo(i,k-1)<a name='3058'>
           dv1q = qo(i,k)<a name='3059'>
           dv2q = .5 * (qo(i,k) + qo(i,k-1))<a name='3060'>
           dv3q = qo(i,k-1)<a name='3061'>
           dv1u = uo(i,k)<a name='3062'>
           dv2u = .5 * (uo(i,k) + uo(i,k-1))<a name='3063'>
           dv3u = uo(i,k-1)<a name='3064'>
           dv1v = vo(i,k)<a name='3065'>
           dv2v = .5 * (vo(i,k) + vo(i,k-1))<a name='3066'>
           dv3v = vo(i,k-1)<a name='3067'>
<font color=#447700>!<a name='3068'></font>
           tem  = 0.5 * (xlamue(i,k)+xlamue(i,k-1))<a name='3069'>
           tem1 = xlamud(i)<a name='3070'>
<font color=#447700>!<a name='3071'></font>
           dellah(i,k) = dellah(i,k) +                                         &amp;<a name='3072'>
          ( eta(i,k)*dv1h - eta(i,k-1)*dv3h                                    &amp;<a name='3073'>
         -  tem*eta(i,k-1)*dv2h*dz                                             &amp;<a name='3074'>
         +  tem1*eta(i,k-1)*.5*(hcko(i,k)+hcko(i,k-1))*dz ) *g_/dp<a name='3075'>
<font color=#447700>!<a name='3076'></font>
           dellaq(i,k) = dellaq(i,k) +                                         &amp;<a name='3077'>
          ( eta(i,k)*dv1q - eta(i,k-1)*dv3q                                    &amp;<a name='3078'>
         -  tem*eta(i,k-1)*dv2q*dz                                             &amp;<a name='3079'>
         +  tem1*eta(i,k-1)*.5*(qcko(i,k)+qcko(i,k-1))*dz ) *g_/dp<a name='3080'>
<font color=#447700>!<a name='3081'></font>
           dellau(i,k) = dellau(i,k) +                                         &amp;<a name='3082'>
          ( eta(i,k)*dv1u - eta(i,k-1)*dv3u                                    &amp;<a name='3083'>
         -  tem*eta(i,k-1)*dv2u*dz                                             &amp;<a name='3084'>
         +  tem1*eta(i,k-1)*.5*(ucko(i,k)+ucko(i,k-1))*dz                      &amp;<a name='3085'>
         -  pgcon*eta(i,k-1)*(dv1u-dv3u) ) *g_/dp<a name='3086'>
<font color=#447700>!<a name='3087'></font>
           dellav(i,k) = dellav(i,k) +                                         &amp;<a name='3088'>
          ( eta(i,k)*dv1v - eta(i,k-1)*dv3v                                    &amp;<a name='3089'>
         -  tem*eta(i,k-1)*dv2v*dz                                             &amp;<a name='3090'>
         +  tem1*eta(i,k-1)*.5*(vcko(i,k)+vcko(i,k-1))*dz                      &amp;<a name='3091'>
         -  pgcon*eta(i,k-1)*(dv1v-dv3v) ) *g_/dp<a name='3092'>
<font color=#447700>!<a name='3093'></font>
         endif<a name='3094'>
       endif<a name='3095'>
     enddo<a name='3096'>
   enddo<a name='3097'>
<font color=#447700>!<a name='3098'></font>
<font color=#447700>!------- cloud top<a name='3099'></font>
<font color=#447700>!<a name='3100'></font>
   do i = its,ite<a name='3101'>
     if(cnvflg(i)) then<a name='3102'>
       indx = ktcon(i)<a name='3103'>
       dp = 1000. * del(i,indx)<a name='3104'>
       dv1h = heo(i,indx-1)<a name='3105'>
       dellah(i,indx) = eta(i,indx-1) *                                        &amp;<a name='3106'>
                       (hcko(i,indx-1) - dv1h) * g_ / dp<a name='3107'>
       dv1q = qo(i,indx-1)<a name='3108'>
       dellaq(i,indx) = eta(i,indx-1) *                                        &amp;<a name='3109'>
                       (qcko(i,indx-1) - dv1q) * g_ / dp<a name='3110'>
       dv1u = uo(i,indx-1)<a name='3111'>
       dellau(i,indx) = eta(i,indx-1) *                                        &amp;<a name='3112'>
                       (ucko(i,indx-1) - dv1u) * g_ / dp<a name='3113'>
       dv1v = vo(i,indx-1)<a name='3114'>
       dellav(i,indx) = eta(i,indx-1) *                                        &amp;<a name='3115'>
                       (vcko(i,indx-1) - dv1v) * g_ / dp<a name='3116'>
<font color=#447700>!<a name='3117'></font>
<font color=#447700>!  cloud water<a name='3118'></font>
<font color=#447700>!<a name='3119'></font>
       dellal(i,indx) = eta(i,indx-1) *                                        &amp;<a name='3120'>
                       qlko_ktcon(i) * g_ / dp<a name='3121'>
     endif<a name='3122'>
   enddo<a name='3123'>
<font color=#447700>!<a name='3124'></font>
<font color=#447700>!  mass flux at cloud base for shallow convection<a name='3125'></font>
<font color=#447700>!  (Grant, 2001)<a name='3126'></font>
<font color=#447700>!<a name='3127'></font>
   do i= its,ite<a name='3128'>
     if(cnvflg(i)) then<a name='3129'>
       k = kbcon(i)<a name='3130'>
       ptem = g_*sflx(i)*hpbl(i)/t1(i,1)<a name='3131'>
       wstar(i) = ptem**h1<a name='3132'>
       tem = po(i,k)*100. / (rd_*t1(i,k))<a name='3133'>
       xmb(i) = betaw*tem*wstar(i)<a name='3134'>
       xmb(i) = min(xmb(i),xmbmax(i))<a name='3135'>
     endif<a name='3136'>
   enddo<a name='3137'>
<font color=#447700>!<a name='3138'></font>
   do k = kts,kte<a name='3139'>
     do i = its,ite<a name='3140'>
       if (cnvflg(i) .and. k .le. kmax(i)) then<a name='3141'>
         qeso(i,k)=0.01* fpvs(t1(i,k),1,rd_,rv_,cvap_,cliq_,cice,xlv0,xls,psat,t0c_)<a name='3142'>
         qeso(i,k) = eps * qeso(i,k) / (p(i,k) + (eps-1.)*qeso(i,k))<a name='3143'>
         val     =             1.e-8<a name='3144'>
         qeso(i,k) = max(qeso(i,k), val )<a name='3145'>
       endif<a name='3146'>
     enddo<a name='3147'>
   enddo<a name='3148'>
<font color=#447700>!<a name='3149'></font>
   do i = its,ite<a name='3150'>
     delhbar(i) = 0.<a name='3151'>
     delqbar(i) = 0.<a name='3152'>
     deltbar(i) = 0.<a name='3153'>
     delubar(i) = 0.<a name='3154'>
     delvbar(i) = 0.<a name='3155'>
     qcond(i) = 0.<a name='3156'>
   enddo<a name='3157'>
<font color=#447700>!<a name='3158'></font>
   do k = kts,kte<a name='3159'>
     do i = its,ite<a name='3160'>
       if (cnvflg(i)) then<a name='3161'>
         if(k.gt.kb(i).and.k.le.ktcon(i)) then<a name='3162'>
           dellat = (dellah(i,k) - hvap_ * dellaq(i,k)) / cp_<a name='3163'>
           t1(i,k) = t1(i,k) + dellat * xmb(i) * dt2<a name='3164'>
           q1(i,k) = q1(i,k) + dellaq(i,k) * xmb(i) * dt2<a name='3165'>
           tem = 1./rcs<a name='3166'>
           u1(i,k) = u1(i,k) + dellau(i,k) * xmb(i) * dt2 * tem<a name='3167'>
           v1(i,k) = v1(i,k) + dellav(i,k) * xmb(i) * dt2 * tem<a name='3168'>
           dp = 1000. * del(i,k)<a name='3169'>
           delhbar(i) = delhbar(i) + dellah(i,k)*xmb(i)*dp/g_<a name='3170'>
           delqbar(i) = delqbar(i) + dellaq(i,k)*xmb(i)*dp/g_<a name='3171'>
           deltbar(i) = deltbar(i) + dellat*xmb(i)*dp/g_<a name='3172'>
           delubar(i) = delubar(i) + dellau(i,k)*xmb(i)*dp/g_<a name='3173'>
           delvbar(i) = delvbar(i) + dellav(i,k)*xmb(i)*dp/g_<a name='3174'>
         endif<a name='3175'>
       endif<a name='3176'>
     enddo<a name='3177'>
   enddo<a name='3178'>
<font color=#447700>!<a name='3179'></font>
   do k = kts,kte<a name='3180'>
     do i = its,ite<a name='3181'>
       if (cnvflg(i)) then<a name='3182'>
         if(k.gt.kb(i).and.k.le.ktcon(i)) then<a name='3183'>
           qeso(i,k)=0.01* fpvs(t1(i,k),1,rd_,rv_,cvap_,cliq_,cice,xlv0,xls    &amp;<a name='3184'>
                     ,psat,t0c_)<a name='3185'>
           qeso(i,k) = eps * qeso(i,k)/(p(i,k) + (eps-1.)*qeso(i,k))<a name='3186'>
           val     =             1.e-8<a name='3187'>
           qeso(i,k) = max(qeso(i,k), val )<a name='3188'>
         endif<a name='3189'>
       endif<a name='3190'>
     enddo<a name='3191'>
   enddo<a name='3192'>
<font color=#447700>!<a name='3193'></font>
   do i = its,ite<a name='3194'>
     rntot(i) = 0.<a name='3195'>
     delqev(i) = 0.<a name='3196'>
     delq2(i) = 0.<a name='3197'>
     flg(i) = cnvflg(i)<a name='3198'>
   enddo<a name='3199'>
<font color=#447700>!<a name='3200'></font>
   do k = kte,kts,-1<a name='3201'>
     do i = its,ite<a name='3202'>
       if (cnvflg(i)) then<a name='3203'>
         if(k.lt.ktcon(i).and.k.gt.kb(i)) then<a name='3204'>
           rntot(i) = rntot(i) + pwo(i,k) * xmb(i) * .001 * dt2<a name='3205'>
         endif<a name='3206'>
       endif<a name='3207'>
     enddo<a name='3208'>
   enddo<a name='3209'>
<font color=#447700>!<a name='3210'></font>
<font color=#447700>! evaporating rain<a name='3211'></font>
<font color=#447700>!<a name='3212'></font>
   do k = kte,kts,-1<a name='3213'>
     do i = its,ite<a name='3214'>
       if (k .le. kmax(i)) then<a name='3215'>
         deltv(i) = 0.<a name='3216'>
         delq(i) = 0.<a name='3217'>
         qevap(i) = 0.<a name='3218'>
         if(cnvflg(i)) then<a name='3219'>
           if(k.lt.ktcon(i).and.k.gt.kb(i)) then<a name='3220'>
             rain(i) = rain(i) + pwo(i,k) * xmb(i) * .001 * dt2<a name='3221'>
           endif<a name='3222'>
         endif<a name='3223'>
         if(flg(i).and.k.lt.ktcon(i)) then<a name='3224'>
           evef = edt(i) * evfact<a name='3225'>
           if(slimsk(i).eq.1.) evef=edt(i) * evfactl<a name='3226'>
           qcond(i) = evef * (q1(i,k) - qeso(i,k))                             &amp;<a name='3227'>
                    / (1. + el2orc * qeso(i,k) / t1(i,k)**2)<a name='3228'>
           dp = 1000. * del(i,k)<a name='3229'>
           if(rain(i).gt.0..and.qcond(i).lt.0.) then<a name='3230'>
             qevap(i) = -qcond(i) * (1.-exp(-.32*sqrt(dt2*rain(i))))<a name='3231'>
             qevap(i) = min(qevap(i), rain(i)*1000.*g_/dp)<a name='3232'>
             delq2(i) = delqev(i) + .001 * qevap(i) * dp / g_<a name='3233'>
           endif<a name='3234'>
           if(rain(i).gt.0..and.qcond(i).lt.0..and.delq2(i).gt.rntot(i)) then<a name='3235'>
             qevap(i) = 1000.* g_ * (rntot(i) - delqev(i)) / dp<a name='3236'>
             flg(i) = .false.<a name='3237'>
           endif<a name='3238'>
           if(rain(i).gt.0..and.qevap(i).gt.0.) then<a name='3239'>
             tem  = .001 * dp / g_<a name='3240'>
             tem1 = qevap(i) * tem<a name='3241'>
             if(tem1.gt.rain(i)) then<a name='3242'>
               qevap(i) = rain(i) / tem<a name='3243'>
               rain(i) = 0.<a name='3244'>
             else<a name='3245'>
               rain(i) = rain(i) - tem1<a name='3246'>
             endif<a name='3247'>
             q1(i,k) = q1(i,k) + qevap(i)<a name='3248'>
             t1(i,k) = t1(i,k) - (hvap_/cp_) * qevap(i)<a name='3249'>
             deltv(i) = - (hvap_/cp_)*qevap(i)/dt2<a name='3250'>
             delq(i) =  + qevap(i)/dt2<a name='3251'>
             delqev(i) = delqev(i) + .001*dp*qevap(i)/g_<a name='3252'>
           endif<a name='3253'>
           dellaq(i,k) = dellaq(i,k) + delq(i) / xmb(i)<a name='3254'>
           delqbar(i) = delqbar(i) + delq(i)*dp/g_<a name='3255'>
           deltbar(i) = deltbar(i) + deltv(i)*dp/g_<a name='3256'>
         endif<a name='3257'>
       endif<a name='3258'>
     enddo<a name='3259'>
   enddo<a name='3260'>
<font color=#447700>!<a name='3261'></font>
   do i = its,ite<a name='3262'>
     if(cnvflg(i)) then<a name='3263'>
       if(rain(i).lt.0..or..not.flg(i)) rain(i) = 0.<a name='3264'>
       ktop(i) = ktcon(i)<a name='3265'>
       kbot(i) = kbcon(i)<a name='3266'>
       icps(i) = 0<a name='3267'>
     endif<a name='3268'>
   enddo<a name='3269'>
<font color=#447700>!<a name='3270'></font>
<font color=#447700>! cloud water<a name='3271'></font>
<font color=#447700>!<a name='3272'></font>
   if (ncloud.gt.0) then<a name='3273'>
<font color=#447700>!<a name='3274'></font>
     do k = kts,km1<a name='3275'>
       do i = its,ite<a name='3276'>
         if (cnvflg(i)) then<a name='3277'>
           if (k.ge.kbcon(i).and.k.le.ktcon(i)) then<a name='3278'>
             tem  = dellal(i,k) * xmb(i) * dt2<a name='3279'>
             tem1 = max(0.0, min(1.0, (tcr-t1(i,k))*tcrf))<a name='3280'>
             if (ncloud.ge.2) then<a name='3281'>
               qi2(i,k) = qi2(i,k) + tem * tem1            <font color=#447700>! ice<a name='3282'></font>
               qc2(i,k) = qc2(i,k) + tem *(1.0-tem1)       <font color=#447700>! water<a name='3283'></font>
             else<a name='3284'>
               qc2(i,k) = qc2(i,k) + tem<a name='3285'>
             endif<a name='3286'>
           endif<a name='3287'>
         endif<a name='3288'>
       enddo<a name='3289'>
     enddo<a name='3290'>
<font color=#447700>!<a name='3291'></font>
   endif<a name='3292'>
<font color=#447700>!<a name='3293'></font>
      end subroutine nscv2d<a name='3294'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='3295'></font>
<font color=#447700>!<a name='3296'></font>
END MODULE module_cu_nsas<a name='3297'>
<font color=#447700>!<a name='3298'></font>
</pre></body></html>