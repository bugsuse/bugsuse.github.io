<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_CU_GF_DEEP'><A href='../../html_code/phys/module_cu_gf_deep.F.html#MODULE_CU_GF_DEEP' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_cu_gf_deep</font> <A href='../../call_to/MODULE_CU_GF_DEEP.html' TARGET='index'>2</A><a name='3'>
     real, parameter::g=9.81<a name='4'>
     real, parameter:: cp=1004.<a name='5'>
     real, parameter:: xlv=2.5e6<a name='6'>
     real, parameter::r_v=461.<a name='7'>
     real, parameter :: tcrit=258.<a name='8'>
<font color=#447700>! tuning constant for cloudwater/ice detrainment<a name='9'></font>
     real, parameter:: c1=.001 <font color=#447700>! .0005<a name='10'></font>
<font color=#447700>! parameter to turn on or off evaporation of rainwater as done in SAS<a name='11'></font>
     integer, parameter :: irainevap=0<a name='12'>
<font color=#447700>! max allowed fractional coverage (frh_thresh)<a name='13'></font>
     real, parameter::frh_thresh = .9<a name='14'>
<font color=#447700>! rh threshold. if fractional coverage ~ frh_thres, do not use cupa any further<a name='15'></font>
     real, parameter::rh_thresh = .97<a name='16'>
<font color=#447700>! tuning constant for J. Brown closure (Ichoice = 4,5,6)<a name='17'></font>
     real, parameter::betajb=1.5<a name='18'>
<font color=#447700>! tuning for shallow and mid convection. EC uses 1.5<a name='19'></font>
     integer, parameter:: use_excess=1<a name='20'>
     real, parameter :: fluxtune=1.5<a name='21'>
<font color=#447700>! flag to turn off or modify mom transport by downdrafts<a name='22'></font>
     real, parameter :: pgcd = 1.<a name='23'>
<font color=#447700>!<a name='24'></font>
<font color=#447700>! aerosol awareness, do not user yet!<a name='25'></font>
<font color=#447700>!<a name='26'></font>
     integer, parameter :: autoconv=1<a name='27'>
     integer, parameter :: aeroevap=1<a name='28'>
     real, parameter :: ccnclean=250.<a name='29'>
<font color=#447700>! still 16 ensembles for clousres<a name='30'></font>
     integer, parameter:: maxens3=16<a name='31'>
<a name='32'>
<a name='33'>
contains<a name='34'>
<a name='35'>
<a name='36'>
<A NAME='CUP_GF'><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='37'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>CUP_gf</font>(        &amp;           <A href='../../call_to/CUP_GF.html' TARGET='index'>2</A>,<A href='../../call_from/CUP_GF.html' TARGET='index'>34</A><a name='38'>
               itf,ktf,its,ite, kts,kte  &amp;<a name='39'>
<a name='40'>
              ,dicycle       &amp;  <font color=#447700>! diurnal cycle flag<a name='41'></font>
              ,ichoice       &amp;  <font color=#447700>! choice of closure, use "0" for ensemble average<a name='42'></font>
              ,ipr           &amp;  <font color=#447700>! this flag can be used for debugging prints<a name='43'></font>
              ,ccn           &amp;  <font color=#447700>! not well tested yet<a name='44'></font>
              ,DTIME         &amp;<a name='45'>
              ,imid          &amp;  <font color=#447700>! flag to turn on mid level convection<a name='46'></font>
<a name='47'>
              ,kpbl          &amp;  <font color=#447700>! level of boundary layer height<a name='48'></font>
              ,dhdt          &amp;  <font color=#447700>! boundary layer forcing (one closure for shallow)<a name='49'></font>
              ,xland         &amp;  <font color=#447700>! land mask<a name='50'></font>
<a name='51'>
              ,zo            &amp;  <font color=#447700>! heights above surface<a name='52'></font>
              ,forcing       &amp;  <font color=#447700>! only diagnostic<a name='53'></font>
              ,T             &amp;  <font color=#447700>! T before forcing<a name='54'></font>
              ,Q             &amp;  <font color=#447700>! Q before forcing<a name='55'></font>
              ,Z1            &amp;  <font color=#447700>! terrain<a name='56'></font>
              ,Tn            &amp;  <font color=#447700>! T including forcing<a name='57'></font>
              ,QO            &amp;  <font color=#447700>! Q including forcing<a name='58'></font>
              ,PO            &amp;  <font color=#447700>! pressure (mb)<a name='59'></font>
              ,PSUR          &amp;  <font color=#447700>! surface pressure (mb)<a name='60'></font>
              ,US            &amp;  <font color=#447700>! u on mass points<a name='61'></font>
              ,VS            &amp;  <font color=#447700>! v on mass points<a name='62'></font>
              ,rho           &amp;  <font color=#447700>! density<a name='63'></font>
              ,hfx           &amp;  <font color=#447700>! W/M2, positive upward<a name='64'></font>
              ,qfx           &amp;  <font color=#447700>! W/M2, positive upward<a name='65'></font>
              ,dx            &amp;  <font color=#447700>! dx is grid point dependent here<a name='66'></font>
              ,mconv         &amp;  <font color=#447700>! integrated vertical advection of moisture<a name='67'></font>
              ,omeg          &amp;  <font color=#447700>! omega (Pa/s)<a name='68'></font>
<a name='69'>
              ,csum          &amp;  <font color=#447700>! used to implement memory, set to zero if not avail<a name='70'></font>
              ,cnvwt         &amp;  <font color=#447700>! GFS needs this<a name='71'></font>
              ,zuo           &amp;  <font color=#447700>! nomalized updraft mass flux<a name='72'></font>
              ,zdo           &amp;  <font color=#447700>! nomalized downdraft mass flux<a name='73'></font>
              ,edto          &amp;<a name='74'>
              ,xmb_out       &amp;  <font color=#447700>!the xmb's may be needed for dicycle<a name='75'></font>
              ,xmbm_in       &amp;<a name='76'>
              ,xmbs_in       &amp;<a name='77'>
              ,pre           &amp;<a name='78'>
              ,outu          &amp;  <font color=#447700>! momentum tendencies at mass points<a name='79'></font>
              ,outv          &amp;<a name='80'>
              ,outt          &amp;  <font color=#447700>! temperature tendencies<a name='81'></font>
              ,outq          &amp;  <font color=#447700>! q tendencies<a name='82'></font>
              ,outqc         &amp;  <font color=#447700>! ql/qice tendencies<a name='83'></font>
              ,kbcon         &amp;<a name='84'>
              ,ktop          &amp;<a name='85'>
              ,cupclw        &amp;  <font color=#447700>! used for direct coupling to radiation, but with tuning factors<a name='86'></font>
              ,ierr          &amp;  <font color=#447700>! ierr flags are error flags, used for debugging<a name='87'></font>
              ,ierrc         &amp;<a name='88'>
<font color=#447700>!    the following should be set to zero if not available<a name='89'></font>
              ,rand_mom      &amp;  <font color=#447700>! for stochastics mom, if temporal and spatial patterns exist<a name='90'></font>
              ,rand_vmas     &amp;  <font color=#447700>! for stochastics vertmass, if temporal and spatial patterns exist<a name='91'></font>
              ,rand_clos     &amp;  <font color=#447700>! for stochastics closures, if temporal and spatial patterns exist<a name='92'></font>
              ,nranflag      &amp;  <font color=#447700>! flag to what you want perturbed<a name='93'></font>
                                <font color=#447700>! 1 = momentum transport <a name='94'></font>
                                <font color=#447700>! 2 = normalized vertical mass flux profile<a name='95'></font>
                                <font color=#447700>! 3 = closures<a name='96'></font>
                                <font color=#447700>! more is possible, talk to developer or<a name='97'></font>
                                <font color=#447700>! implement yourself. pattern is expected to be<a name='98'></font>
                                <font color=#447700>! betwee -1 and +1<a name='99'></font>
#if ( WRF_DFI_RADAR == 1 )<a name='100'>
              ,do_capsuppress,cap_suppress_j    &amp;             <a name='101'>
#endif<a name='102'>
              ,k22                              &amp;<a name='103'>
              ,jmin)<a name='104'>
<a name='105'>
   IMPLICIT NONE<a name='106'>
<a name='107'>
     integer                                                &amp;<a name='108'>
        ,intent (in   )                   ::                &amp;<a name='109'>
        nranflag,itf,ktf,its,ite, kts,kte,ipr,imid<a name='110'>
     integer, intent (in   )              ::                &amp;<a name='111'>
        ichoice<a name='112'>
     real,  dimension (its:ite,4)                           &amp;<a name='113'>
        ,intent (in  )                   ::  rand_clos<a name='114'>
     real,  dimension (its:ite)                             &amp;<a name='115'>
        ,intent (in  )                   ::  rand_mom,rand_vmas<a name='116'>
<a name='117'>
#if ( WRF_DFI_RADAR == 1 )<a name='118'>
<font color=#447700>!<a name='119'></font>
<font color=#447700>!  option of cap suppress:<a name='120'></font>
<font color=#447700>!        do_capsuppress = 1   do<a name='121'></font>
<font color=#447700>!        do_capsuppress = other   don't<a name='122'></font>
<font color=#447700>!<a name='123'></font>
<font color=#447700>!<a name='124'></font>
   INTEGER,      INTENT(IN   ) ,OPTIONAL   :: do_capsuppress<a name='125'>
   REAL, DIMENSION( its:ite ) :: cap_suppress_j<a name='126'>
#endif<a name='127'>
  <font color=#447700>!<a name='128'></font>
  <font color=#447700>! <a name='129'></font>
  <font color=#447700>!<a name='130'></font>
      real,    dimension (its:ite,1:maxens3) :: xf_ens,pr_ens<a name='131'>
  <font color=#447700>! outtem = output temp tendency (per s)<a name='132'></font>
  <font color=#447700>! outq   = output q tendency (per s)<a name='133'></font>
  <font color=#447700>! outqc  = output qc tendency (per s)<a name='134'></font>
  <font color=#447700>! pre    = output precip<a name='135'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='136'>
        ,intent (inout  )                   ::                         &amp;<a name='137'>
        cnvwt,outu,outv,OUTT,OUTQ,OUTQC,cupclw<a name='138'>
     real,    dimension (its:ite)                                      &amp;<a name='139'>
        ,intent (inout  )                   ::                         &amp;<a name='140'>
        pre,xmb_out<a name='141'>
     real,    dimension (its:ite)                                      &amp;<a name='142'>
        ,intent (in  )                   ::                            &amp;<a name='143'>
        hfx,qfx,xmbm_in,xmbs_in<a name='144'>
     integer,    dimension (its:ite)                                   &amp;<a name='145'>
        ,intent (inout  )                ::                            &amp;<a name='146'>
        kbcon,ktop<a name='147'>
     integer,    dimension (its:ite)                                   &amp;<a name='148'>
        ,intent (in  )                   ::                            &amp;<a name='149'>
        kpbl<a name='150'>
  <font color=#447700>!<a name='151'></font>
  <font color=#447700>! basic environmental input includes moisture convergence (mconv)<a name='152'></font>
  <font color=#447700>! omega (omeg), windspeed (us,vs), and a flag (ierr) to turn off<a name='153'></font>
  <font color=#447700>! convection for this call only and at that particular gridpoint<a name='154'></font>
  <font color=#447700>!<a name='155'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='156'>
        ,intent (in   )                   ::                           &amp;<a name='157'>
        dhdt,rho,T,PO,US,VS,tn<a name='158'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='159'>
        ,intent (inout   )                ::                           &amp;<a name='160'>
        omeg<a name='161'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='162'>
        ,intent (inout)                   ::                           &amp;<a name='163'>
         Q,QO,zuo,zdo<a name='164'>
     real, dimension (its:ite)                                         &amp;<a name='165'>
        ,intent (in   )                   ::                           &amp;<a name='166'>
        dx,ccn,Z1,PSUR,xland<a name='167'>
     real, dimension (its:ite)                                         &amp;<a name='168'>
        ,intent (inout   )                ::                           &amp;<a name='169'>
        mconv<a name='170'>
<a name='171'>
       <a name='172'>
       real                                                            &amp;<a name='173'>
        ,intent (in   )                   ::                           &amp;<a name='174'>
        dtime<a name='175'>
<a name='176'>
<a name='177'>
<font color=#447700>!<a name='178'></font>
<font color=#447700>!  local ensemble dependent variables in this routine<a name='179'></font>
<font color=#447700>!<a name='180'></font>
     real,    dimension (its:ite,1)  ::                                &amp;<a name='181'>
        xaa0_ens<a name='182'>
     real,    dimension (its:ite,1)  ::                                &amp;<a name='183'>
        edtc<a name='184'>
     real,    dimension (its:ite,kts:kte,1) ::                         &amp;<a name='185'>
        dellat_ens,dellaqc_ens,dellaq_ens,pwo_ens<a name='186'>
<font color=#447700>!<a name='187'></font>
<font color=#447700>!<a name='188'></font>
<font color=#447700>!<a name='189'></font>
<font color=#447700>!***************** the following are your basic environmental<a name='190'></font>
<font color=#447700>!                  variables. They carry a "_cup" if they are<a name='191'></font>
<font color=#447700>!                  on model cloud levels (staggered). They carry<a name='192'></font>
<font color=#447700>!                  an "o"-ending (z becomes zo), if they are the forced<a name='193'></font>
<font color=#447700>!                  variables. They are preceded by x (z becomes xz)<a name='194'></font>
<font color=#447700>!                  to indicate modification by some typ of cloud<a name='195'></font>
<font color=#447700>!<a name='196'></font>
  <font color=#447700>! z           = heights of model levels<a name='197'></font>
  <font color=#447700>! q           = environmental mixing ratio<a name='198'></font>
  <font color=#447700>! qes         = environmental saturation mixing ratio<a name='199'></font>
  <font color=#447700>! t           = environmental temp<a name='200'></font>
  <font color=#447700>! p           = environmental pressure<a name='201'></font>
  <font color=#447700>! he          = environmental moist static energy<a name='202'></font>
  <font color=#447700>! hes         = environmental saturation moist static energy<a name='203'></font>
  <font color=#447700>! z_cup       = heights of model cloud levels<a name='204'></font>
  <font color=#447700>! q_cup       = environmental q on model cloud levels<a name='205'></font>
  <font color=#447700>! qes_cup     = saturation q on model cloud levels<a name='206'></font>
  <font color=#447700>! t_cup       = temperature (Kelvin) on model cloud levels<a name='207'></font>
  <font color=#447700>! p_cup       = environmental pressure<a name='208'></font>
  <font color=#447700>! he_cup = moist static energy on model cloud levels<a name='209'></font>
  <font color=#447700>! hes_cup = saturation moist static energy on model cloud levels<a name='210'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='211'></font>
<font color=#447700>!<a name='212'></font>
<font color=#447700>!<a name='213'></font>
  <font color=#447700>! hcd = moist static energy in downdraft<a name='214'></font>
  <font color=#447700>! zd normalized downdraft mass flux<a name='215'></font>
  <font color=#447700>! dby = buoancy term<a name='216'></font>
  <font color=#447700>! entr = entrainment rate<a name='217'></font>
  <font color=#447700>! zd   = downdraft normalized mass flux<a name='218'></font>
  <font color=#447700>! entr= entrainment rate<a name='219'></font>
  <font color=#447700>! hcd = h in model cloud<a name='220'></font>
  <font color=#447700>! bu = buoancy term<a name='221'></font>
  <font color=#447700>! zd = normalized downdraft mass flux<a name='222'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='223'></font>
  <font color=#447700>! qcd = cloud q (including liquid water) after entrainment<a name='224'></font>
  <font color=#447700>! qrch = saturation q in cloud<a name='225'></font>
  <font color=#447700>! pwd = evaporate at that level<a name='226'></font>
  <font color=#447700>! pwev = total normalized integrated evaoprate (I2)<a name='227'></font>
  <font color=#447700>! entr= entrainment rate<a name='228'></font>
  <font color=#447700>! z1 = terrain elevation<a name='229'></font>
  <font color=#447700>! entr = downdraft entrainment rate<a name='230'></font>
  <font color=#447700>! jmin = downdraft originating level<a name='231'></font>
  <font color=#447700>! kdet = level above ground where downdraft start detraining<a name='232'></font>
  <font color=#447700>! psur        = surface pressure<a name='233'></font>
  <font color=#447700>! z1          = terrain elevation<a name='234'></font>
  <font color=#447700>! pr_ens = precipitation ensemble<a name='235'></font>
  <font color=#447700>! xf_ens = mass flux ensembles<a name='236'></font>
  <font color=#447700>! omeg = omega from large scale model<a name='237'></font>
  <font color=#447700>! mconv = moisture convergence from large scale model<a name='238'></font>
  <font color=#447700>! zd      = downdraft normalized mass flux<a name='239'></font>
  <font color=#447700>! zu      = updraft normalized mass flux<a name='240'></font>
  <font color=#447700>! dir     = "storm motion"<a name='241'></font>
  <font color=#447700>! mbdt    = arbitrary numerical parameter<a name='242'></font>
  <font color=#447700>! dtime   = dt over which forcing is applied<a name='243'></font>
  <font color=#447700>! kbcon       = LFC of parcel from k22<a name='244'></font>
  <font color=#447700>! k22         = updraft originating level<a name='245'></font>
  <font color=#447700>! ichoice       = flag if only want one closure (usually set to zero!)<a name='246'></font>
  <font color=#447700>! dby = buoancy term<a name='247'></font>
  <font color=#447700>! ktop = cloud top (output)<a name='248'></font>
  <font color=#447700>! xmb    = total base mass flux<a name='249'></font>
  <font color=#447700>! hc = cloud moist static energy<a name='250'></font>
  <font color=#447700>! hkb = moist static energy at originating level<a name='251'></font>
<a name='252'>
     real,    dimension (its:ite,kts:kte) ::                            &amp;<a name='253'>
        entr_rate_2d,mentrd_rate_2d,he,hes,qes,z, heo,heso,qeso,zo,     &amp;                    <a name='254'>
        xhe,xhes,xqes,xz,xt,xq,qes_cup,q_cup,he_cup,hes_cup,z_cup,      &amp;<a name='255'>
        p_cup,gamma_cup,t_cup, qeso_cup,qo_cup,heo_cup,heso_cup,        &amp;<a name='256'>
        zo_cup,po_cup,gammao_cup,tn_cup,                                &amp;    <a name='257'>
        xqes_cup,xq_cup,xhe_cup,xhes_cup,xz_cup,                        &amp;<a name='258'>
        xt_cup, dby,hc,zu,clw_all,                                      &amp;<a name='259'>
        dbyo,qco,qrcdo,pwdo,pwo,hcdo,qcdo,dbydo,hco,qrco,               &amp;<a name='260'>
        dbyt,xdby,xhc,xzu,                                                   &amp;<a name='261'>
<a name='262'>
  <font color=#447700>! cd  = detrainment function for updraft<a name='263'></font>
  <font color=#447700>! cdd = detrainment function for downdraft<a name='264'></font>
  <font color=#447700>! dellat = change of temperature per unit mass flux of cloud ensemble<a name='265'></font>
  <font color=#447700>! dellaq = change of q per unit mass flux of cloud ensemble<a name='266'></font>
  <font color=#447700>! dellaqc = change of qc per unit mass flux of cloud ensemble<a name='267'></font>
<a name='268'>
        cd,cdd,DELLAH,DELLAQ,DELLAT,DELLAQC,                            &amp;<a name='269'>
        u_cup,v_cup,uc,vc,ucd,vcd,dellu,dellv<a name='270'>
<a name='271'>
  <font color=#447700>! aa0 cloud work function for downdraft<a name='272'></font>
  <font color=#447700>! edt = epsilon<a name='273'></font>
  <font color=#447700>! aa0     = cloud work function without forcing effects<a name='274'></font>
  <font color=#447700>! aa1     = cloud work function with forcing effects<a name='275'></font>
  <font color=#447700>! xaa0    = cloud work function with cloud effects (ensemble dependent)<a name='276'></font>
  <font color=#447700>! edt     = epsilon<a name='277'></font>
<a name='278'>
     real,    dimension (its:ite) ::                                     &amp;<a name='279'>
       edt,edto,AA1,AA0,XAA0,HKB,                                        &amp;<a name='280'>
       HKBO,XHKB,                                                        &amp;<a name='281'>
       XMB,PWAVO,                                                        &amp;<a name='282'>
       PWEVO,BU,BUD,cap_max,                                             &amp;<a name='283'>
       cap_max_increment,closure_n,psum,psumh,sig,sigd<a name='284'>
     real,    dimension (its:ite) ::                                     &amp;<a name='285'>
        axx,edtmax,edtmin,entr_rate<a name='286'>
     integer,    dimension (its:ite) ::                                  &amp;<a name='287'>
       kzdown,KDET,K22,JMIN,kstabi,kstabm,K22x,xland1,                   &amp;  <a name='288'>
       ktopdby,KBCONx,ierr2,ierr3,KBMAX<a name='289'>
<a name='290'>
     integer,  dimension (its:ite), intent(inout) :: ierr<a name='291'>
     integer,  dimension (its:ite), intent(in) :: csum<a name='292'>
     integer                              ::                             &amp;<a name='293'>
       iloop,nens3,ki,kk,I,K<a name='294'>
     real                                 ::                             &amp;<a name='295'>
      dz,dzo,mbdt,radius,                                                &amp;<a name='296'>
      zcutdown,depth_min,zkbmax,z_detr,zktop,                            &amp;<a name='297'>
      dh,cap_maxs,trash,trash2,frh,sig_thresh<a name='298'>
     real entdo,dp,subin,detdo,entup,                                    &amp;<a name='299'>
      detup,subdown,entdoj,entupk,detupk,totmas<a name='300'>
<a name='301'>
     real, dimension (its:ite) :: lambau,flux_tun,zws,ztexec,zqexec<a name='302'>
<a name='303'>
     integer :: jprnt,jmini,start_k22<a name='304'>
     logical :: keep_going,flg(its:ite)<a name='305'>
     <a name='306'>
     character*50 :: ierrc(its:ite)<a name='307'>
     real,    dimension (its:ite,kts:kte) ::                              &amp;<a name='308'>
       up_massentr,up_massdetr,c1d                                        &amp;<a name='309'>
      ,up_massentro,up_massdetro,dd_massentro,dd_massdetro<a name='310'>
     real,    dimension (its:ite,kts:kte) ::                              &amp;<a name='311'>
       up_massentru,up_massdetru,dd_massentru,dd_massdetru<a name='312'>
     real buo_flux,pgcon,pgc,blqe<a name='313'>
    <a name='314'>
     real :: xff_mid(its:ite,2)<a name='315'>
     integer :: iversion=1<a name='316'>
     real :: denom,h_entr,umean,t_star,dq<a name='317'>
     integer, intent(IN) :: DICYCLE<a name='318'>
     real,    dimension (its:ite) :: aa1_bl,hkbo_bl,tau_bl,tau_ecmwf,wmean<a name='319'>
     real, dimension (its:ite,kts:kte) :: tn_bl, qo_bl, qeso_bl, heo_bl, heso_bl             &amp;<a name='320'>
                                              ,qeso_cup_bl,qo_cup_bl, heo_cup_bl,heso_cup_bl &amp;<a name='321'>
                                              ,gammao_cup_bl,tn_cup_bl,hco_bl,DBYo_bl<a name='322'>
     real, dimension(its:ite) :: xf_dicycle<a name='323'>
     real, intent(inout), dimension(its:ite,10) :: forcing<a name='324'>
     integer :: pmin_lev(its:ite),start_level(its:ite),ktopkeep(its:ite)<a name='325'>
     real,    dimension (its:ite,kts:kte) :: dtempdz<a name='326'>
     integer, dimension (its:ite,kts:kte) ::  k_inv_layers <a name='327'>
 <a name='328'>
<font color=#447700>! rainevap from sas<a name='329'></font>
     real zuh2(40)<a name='330'>
     real, dimension (its:ite) :: rntot,delqev,delq2,qevap,rn,qcond<a name='331'>
     real :: rain,t1,q1,elocp,evef,el2orc,evfact,evfactl,g_rain,e_dn,c_up<a name='332'>
     real :: pgeoh,dts,fp,fpi,pmin,x_add,beta,beta_u<a name='333'>
     real :: cbeg,cmid,cend,const_a,const_b,const_c<a name='334'>
      flux_tun(:)=fluxtune<a name='335'>
<font color=#447700>!      if(imid.eq.1)flux_tun(:)=fluxtune+.5<a name='336'></font>
      pmin=150.<a name='337'>
      if(imid.eq.1)pmin=75.<a name='338'>
      ktopdby(:)=0<a name='339'>
      elocp=xlv/cp<a name='340'>
      el2orc=xlv*xlv/(r_v*cp)<a name='341'>
      evfact=.3<a name='342'>
      evfactl=.3<a name='343'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='344'></font>
<font color=#447700>!<a name='345'></font>
<font color=#447700>!proportionality constant to estimate pressure gradient of updraft (Zhang and Wu, 2003, JAS<a name='346'></font>
<font color=#447700>!<a name='347'></font>
<font color=#447700>! ECMWF<a name='348'></font>
       pgcon=0.<a name='349'>
       lambau(:)=2.<a name='350'>
<font color=#447700>! here random must be between -1 and 1<a name='351'></font>
       if(nranflag == 1)then<a name='352'>
           lambau(:)=1.5+rand_mom(:)<a name='353'>
       endif<a name='354'>
<font color=#447700>! SAS<a name='355'></font>
<font color=#447700>!     lambau=0.<a name='356'></font>
<font color=#447700>!     pgcon=-.55<a name='357'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='358'></font>
      ztexec(:)     = 0.<a name='359'>
      zqexec(:)     = 0.<a name='360'>
      zws(:)        = 0.<a name='361'>
<a name='362'>
      do i=its,itf<a name='363'>
         <font color=#447700>!- buoyancy flux (H+LE)<a name='364'></font>
         buo_flux= (hfx(i)/cp+0.608*t(i,1)*qfx(i)/xlv)/rho(i,1)<a name='365'>
         pgeoh = zo(i,2)*g<a name='366'>
         <font color=#447700>!-convective-scale velocity w*<a name='367'></font>
         zws(i) = max(0.,flux_tun(i)*0.41*buo_flux*zo(i,2)*g/t(i,1))<a name='368'>
         if(zws(i) &gt; TINY(pgeoh)) then<a name='369'>
            <font color=#447700>!-convective-scale velocity w*<a name='370'></font>
            zws(i) = 1.2*zws(i)**.3333<a name='371'>
            <font color=#447700>!- temperature excess <a name='372'></font>
            ztexec(i)     = MAX(flux_tun(i)*hfx(i)/(rho(i,1)*zws(i)*cp),0.0)<a name='373'>
            <font color=#447700>!- moisture  excess<a name='374'></font>
            zqexec(i)     = MAX(flux_tun(i)*qfx(i)/xlv/(rho(i,1)*zws(i)),0.)<a name='375'>
         endif<a name='376'>
         <font color=#447700>!- zws for shallow convection closure (Grant 2001)<a name='377'></font>
         <font color=#447700>!- height of the pbl<a name='378'></font>
         zws(i) = max(0.,flux_tun(i)*0.41*buo_flux*zo(i,kpbl(i))*g/t(i,kpbl(i)))<a name='379'>
         zws(i) = 1.2*zws(i)**.3333<a name='380'>
         zws(i) = zws(i)*rho(i,kpbl(i)) <font color=#447700>!check if zrho is correct<a name='381'></font>
      enddo<a name='382'>
<font color=#447700>!     cap_maxs=225.<a name='383'></font>
<font color=#447700>!     if(imid.eq.1)cap_maxs=150.<a name='384'></font>
      cap_maxs=75. <font color=#447700>! 150.<a name='385'></font>
<font color=#447700>!     if(imid.eq.1)cap_maxs=100.<a name='386'></font>
      do i=its,itf<a name='387'>
        edto(i)=0.<a name='388'>
        closure_n(i)=16.<a name='389'>
        xmb_out(i)=0.<a name='390'>
        cap_max(i)=cap_maxs<a name='391'>
        cap_max_increment(i)=20.<a name='392'>
        if(imid.eq.1)cap_max_increment(i)=10.<a name='393'>
<font color=#447700>!<a name='394'></font>
<font color=#447700>! for water or ice<a name='395'></font>
<font color=#447700>!<a name='396'></font>
        xland1(i)=int(xland(i)+.0001) <font color=#447700>! 1.<a name='397'></font>
        if(xland(i).gt.1.5 .or. xland(i).lt.0.5)then<a name='398'>
            xland1(i)=0<a name='399'>
<font color=#447700>!            if(imid.eq.0)cap_max(i)=cap_maxs-25.<a name='400'></font>
<font color=#447700>!            if(imid.eq.1)cap_max(i)=cap_maxs-50.<a name='401'></font>
            cap_max_increment(i)=20.<a name='402'>
        else<a name='403'>
            if(ztexec(i).gt.0.)cap_max(i)=cap_max(i)+25.<a name='404'>
            if(ztexec(i).lt.0.)cap_max(i)=cap_max(i)-25.<a name='405'>
        endif<a name='406'>
        ierrc(i)=" "<a name='407'>
<font color=#447700>!       cap_max_increment(i)=1.<a name='408'></font>
      enddo<a name='409'>
      if(use_excess == 0 )then<a name='410'>
       ztexec(:)=0<a name='411'>
       zqexec(:)=0<a name='412'>
      endif<a name='413'>
#if ( WRF_DFI_RADAR == 1 )<a name='414'>
  if(do_capsuppress == 1) then<a name='415'>
      do i=its,itf<a name='416'>
          cap_max(i)=cap_maxs<a name='417'>
          if (abs(cap_suppress_j(i) - 1.0 ) &lt; 0.1 ) then<a name='418'>
             cap_max(i)=cap_maxs+75.<a name='419'>
          elseif (abs(cap_suppress_j(i) - 0.0 ) &lt; 0.1 ) then<a name='420'>
             cap_max(i)=10.0<a name='421'>
          endif<a name='422'>
      enddo<a name='423'>
  endif<a name='424'>
#endif<a name='425'>
<a name='426'>
<font color=#447700>!<a name='427'></font>
<font color=#447700>!--- initial entrainment rate (these may be changed later on in the<a name='428'></font>
<font color=#447700>!--- program<a name='429'></font>
<font color=#447700>!<a name='430'></font>
      start_level(:)=kte<a name='431'>
      do i=its,ite<a name='432'>
         c1d(i,:)= 0. <font color=#447700>!c1 ! 0. ! c1 ! max(.003,c1+float(csum(i))*.0001)<a name='433'></font>
         entr_rate(i)=7.e-5 - min(20.,float(csum(i))) * 3.e-6<a name='434'>
         if(xland1(i) == 0)entr_rate(i)=7.e-5<a name='435'>
         if(imid.eq.1)entr_rate(i)=1.e-4<a name='436'>
<font color=#447700>!         if(imid.eq.1)c1d(i,:)=c1<a name='437'></font>
         radius=.2/entr_rate(i)<a name='438'>
         frh=min(1.,3.14*radius*radius/dx(i)/dx(i))<a name='439'>
         if(frh &gt; frh_thresh)then<a name='440'>
            frh=frh_thresh<a name='441'>
            radius=sqrt(frh*dx(i)*dx(i)/3.14)<a name='442'>
            entr_rate(i)=.2/radius<a name='443'>
         endif<a name='444'>
         sig(i)=(1.-frh)**2<a name='445'>
      enddo<a name='446'>
      sig_thresh = (1.-frh_thresh)**2<a name='447'>
<a name='448'>
      <a name='449'>
<font color=#447700>!<a name='450'></font>
<font color=#447700>!--- entrainment of mass<a name='451'></font>
<font color=#447700>!<a name='452'></font>
<font color=#447700>!<a name='453'></font>
<font color=#447700>!--- initial detrainmentrates<a name='454'></font>
<font color=#447700>!<a name='455'></font>
      do k=kts,ktf<a name='456'>
      do i=its,itf<a name='457'>
        cnvwt(i,k)=0.<a name='458'>
        zuo(i,k)=0.<a name='459'>
        zdo(i,k)=0.<a name='460'>
        z(i,k)=zo(i,k)<a name='461'>
        xz(i,k)=zo(i,k)<a name='462'>
        cupclw(i,k)=0.<a name='463'>
        cd(i,k)=1.e-9 <font color=#447700>! 1.*entr_rate<a name='464'></font>
<font color=#447700>!        if(imid.eq.1)cd(i,k)=entr_rate(i)<a name='465'></font>
        cdd(i,k)=1.e-9<a name='466'>
        hcdo(i,k)=0.<a name='467'>
        qrcdo(i,k)=0.<a name='468'>
        dellaqc(i,k)=0.<a name='469'>
      enddo<a name='470'>
      enddo<a name='471'>
<font color=#447700>!<a name='472'></font>
<font color=#447700>!--- max/min allowed value for epsilon (ratio downdraft base mass flux/updraft<a name='473'></font>
<font color=#447700>!    base mass flux<a name='474'></font>
<font color=#447700>!<a name='475'></font>
      edtmax(:)=1.<a name='476'>
      if(imid.eq.1)edtmax(:)=.15<a name='477'>
      edtmin(:)=.1<a name='478'>
      if(imid.eq.1)edtmin(:)=.05<a name='479'>
<font color=#447700>!<a name='480'></font>
<font color=#447700>!--- minimum depth (m), clouds must have<a name='481'></font>
<font color=#447700>!<a name='482'></font>
      depth_min=1000.<a name='483'>
      if(imid.eq.1)depth_min=500.<a name='484'>
<font color=#447700>!<a name='485'></font>
<font color=#447700>!--- maximum depth (mb) of capping <a name='486'></font>
<font color=#447700>!--- inversion (larger cap = no convection)<a name='487'></font>
<font color=#447700>!<a name='488'></font>
      DO i=its,itf<a name='489'>
<font color=#447700>!        if(imid.eq.0)then<a name='490'></font>
<font color=#447700>!          edtmax(i)=max(0.5,.8-float(csum(i))*.015) !.3)<a name='491'></font>
<font color=#447700>!          if(xland1(i) == 1 )edtmax(i)=max(0.7,1.-float(csum(i))*.015) !.3)<a name='492'></font>
<font color=#447700>!        endif<a name='493'></font>
        kbmax(i)=1<a name='494'>
        aa0(i)=0.<a name='495'>
        aa1(i)=0.<a name='496'>
        edt(i)=0.<a name='497'>
        kstabm(i)=ktf-1<a name='498'>
        IERR2(i)=0<a name='499'>
        IERR3(i)=0<a name='500'>
        x_add=0.<a name='501'>
      enddo<a name='502'>
<font color=#447700>!     do i=its,itf<a name='503'></font>
<font color=#447700>!         cap_max(i)=cap_maxs<a name='504'></font>
<font color=#447700>!         cap_max3(i)=25.<a name='505'></font>
<a name='506'>
<font color=#447700>!     enddo<a name='507'></font>
<font color=#447700>!<a name='508'></font>
<font color=#447700>!--- max height(m) above ground where updraft air can originate<a name='509'></font>
<font color=#447700>!<a name='510'></font>
      zkbmax=4000.<a name='511'>
      if(imid.eq.1)zkbmax=2000.<a name='512'>
<font color=#447700>!<a name='513'></font>
<font color=#447700>!--- height(m) above which no downdrafts are allowed to originate<a name='514'></font>
<font color=#447700>!<a name='515'></font>
      zcutdown=4000.<a name='516'>
<font color=#447700>!<a name='517'></font>
<font color=#447700>!--- depth(m) over which downdraft detrains all its mass<a name='518'></font>
<font color=#447700>!<a name='519'></font>
      z_detr=1000.<a name='520'>
<font color=#447700>!     if(imid.eq.1)z_detr=800.<a name='521'></font>
<font color=#447700>!<a name='522'></font>
<a name='523'>
<font color=#447700>!<a name='524'></font>
<font color=#447700>!--- environmental conditions, FIRST HEIGHTS<a name='525'></font>
<font color=#447700>!<a name='526'></font>
      do i=its,itf<a name='527'>
            do k=1,maxens3<a name='528'>
               xf_ens(i,k)=0.<a name='529'>
               pr_ens(i,k)=0.<a name='530'>
            enddo<a name='531'>
      enddo<a name='532'>
<a name='533'>
<font color=#447700>!<a name='534'></font>
<font color=#447700>!--- calculate moist static energy, heights, qes<a name='535'></font>
<font color=#447700>!<a name='536'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV'>cup_env</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_6">(z,qes,he,hes,t,q,po,z1,                         &amp;<a name='537'>
           psur,ierr,tcrit,-1,                                     &amp;<a name='538'>
           itf,ktf,                                                &amp;<a name='539'>
           its,ite, kts,kte)<a name='540'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV'>cup_env</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_7">(zo,qeso,heo,heso,tn,qo,po,z1,                   &amp;<a name='541'>
           psur,ierr,tcrit,-1,                                     &amp;<a name='542'>
           itf,ktf,                                                &amp;<a name='543'>
           its,ite, kts,kte)<a name='544'>
<a name='545'>
<font color=#447700>!<a name='546'></font>
<font color=#447700>!--- environmental values on cloud levels<a name='547'></font>
<font color=#447700>!<a name='548'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV_CLEV'>cup_env_clev</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_CLEV_6">(t,qes,q,he,hes,z,po,qes_cup,q_cup,he_cup,  &amp;<a name='549'>
           hes_cup,z_cup,p_cup,gamma_cup,t_cup,psur,               &amp;<a name='550'>
           ierr,z1,                                                &amp;<a name='551'>
           itf,ktf,                                                &amp;<a name='552'>
           its,ite, kts,kte)<a name='553'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV_CLEV'>cup_env_clev</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_CLEV_7">(tn,qeso,qo,heo,heso,zo,po,qeso_cup,qo_cup, &amp;<a name='554'>
           heo_cup,heso_cup,zo_cup,po_cup,gammao_cup,tn_cup,psur,  &amp;<a name='555'>
           ierr,z1,                                                &amp;<a name='556'>
           itf,ktf,                                                &amp;<a name='557'>
           its,ite, kts,kte)<a name='558'>
      do i=its,itf<a name='559'>
        if(ierr(i).eq.0)then<a name='560'>
          if(kpbl(i).gt.5 .and. imid.eq.1)cap_max(i)=po_cup(i,kpbl(i))<a name='561'>
          u_cup(i,kts)=us(i,kts)<a name='562'>
          v_cup(i,kts)=vs(i,kts)<a name='563'>
          do k=kts+1,ktf<a name='564'>
           u_cup(i,k)=.5*(us(i,k-1)+us(i,k))<a name='565'>
           v_cup(i,k)=.5*(vs(i,k-1)+vs(i,k))<a name='566'>
          enddo<a name='567'>
        endif<a name='568'>
      enddo<a name='569'>
      do i=its,itf<a name='570'>
        if(ierr(i).eq.0)then<a name='571'>
        do k=kts,ktf<a name='572'>
          if(zo_cup(i,k).gt.zkbmax+z1(i))then<a name='573'>
            kbmax(i)=k<a name='574'>
            go to 25<a name='575'>
          endif<a name='576'>
        enddo<a name='577'>
 25     continue<a name='578'>
<font color=#447700>!<a name='579'></font>
<font color=#447700>!--- level where detrainment for downdraft starts<a name='580'></font>
<font color=#447700>!<a name='581'></font>
        do k=kts,ktf<a name='582'>
          if(zo_cup(i,k).gt.z_detr+z1(i))then<a name='583'>
            kdet(i)=k<a name='584'>
            go to 26<a name='585'>
          endif<a name='586'>
        enddo<a name='587'>
 26     continue<a name='588'>
<font color=#447700>!<a name='589'></font>
        endif<a name='590'>
      enddo<a name='591'>
<font color=#447700>!<a name='592'></font>
<font color=#447700>!<a name='593'></font>
<font color=#447700>!<a name='594'></font>
<font color=#447700>!------- DETERMINE LEVEL WITH HIGHEST MOIST STATIC ENERGY CONTENT - K22<a name='595'></font>
<font color=#447700>!<a name='596'></font>
      start_k22=2<a name='597'>
       DO 36 i=its,itf<a name='598'>
         IF(ierr(I).eq.0)THEN<a name='599'>
            k22(i)=maxloc(HEO_CUP(i,start_k22:kbmax(i)+2),1)+start_k22-1<a name='600'>
            if(K22(I).GE.KBMAX(i))then<a name='601'>
             ierr(i)=2<a name='602'>
             ierrc(i)="could not find k22"<a name='603'>
             ktop(i)=0<a name='604'>
             k22(i)=0<a name='605'>
             kbcon(i)=0<a name='606'>
           endif<a name='607'>
         endif<a name='608'>
 36   CONTINUE<a name='609'>
<font color=#447700>!<a name='610'></font>
<font color=#447700>!--- DETERMINE THE LEVEL OF CONVECTIVE CLOUD BASE  - KBCON<a name='611'></font>
<font color=#447700>!<a name='612'></font>
<a name='613'>
      do i=its,itf<a name='614'>
       IF(ierr(I).eq.0)THEN<a name='615'>
         x_add = xlv*zqexec(i)+cp*ztexec(i)<a name='616'>
         call <A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_CLOUD_BC'>get_cloud_bc</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CLOUD_BC_1">(kte,he_cup (i,1:kte),hkb (i),k22(i),x_add)<a name='617'>
         call <A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_CLOUD_BC'>get_cloud_bc</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CLOUD_BC_2">(kte,heo_cup (i,1:kte),hkbo (i),k22(i),x_add)<a name='618'>
       endif <font color=#447700>! ierr<a name='619'></font>
      enddo<a name='620'>
      jprnt=0<a name='621'>
      iloop=1<a name='622'>
      if(imid.eq.1)iloop=5<a name='623'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_KBCON'>cup_kbcon</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KBCON_6">(ierrc,cap_max_increment,iloop,k22,kbcon,heo_cup,heso_cup,  &amp;<a name='624'>
           hkbo,ierr,kbmax,po_cup,cap_max,                                      &amp;<a name='625'>
           ztexec,zqexec,                                                       &amp;<a name='626'>
           jprnt,itf,ktf,                                                       &amp;<a name='627'>
           its,ite, kts,kte,                                                    &amp;<a name='628'>
           z_cup,entr_rate,heo,imid)<a name='629'>
<font color=#447700>!<a name='630'></font>
<font color=#447700>!--- increase detrainment in stable layers<a name='631'></font>
<font color=#447700>!<a name='632'></font>
      CALL <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_MINIMI'>cup_minimi</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_MINIMI_4">(HEso_cup,Kbcon,kstabm,kstabi,ierr,                        &amp;<a name='633'>
           itf,ktf,                                                             &amp;<a name='634'>
           its,ite, kts,kte)<a name='635'>
      DO i=its,itf<a name='636'>
         IF(ierr(I) == 0)THEN<a name='637'>
           frh = min(qo_cup(i,kbcon(i))/qeso_cup(i,kbcon(i)),1.)<a name='638'>
           if(frh &gt;= rh_thresh .and. sig(i) &lt;= sig_thresh )then<a name='639'>
             ierr(i)=231<a name='640'>
             cycle<a name='641'>
           endif<a name='642'>
<font color=#447700>!<a name='643'></font>
<font color=#447700>!    never go too low...<a name='644'></font>
<font color=#447700>!<a name='645'></font>
<font color=#447700>!           if(imid.eq.0 .and. xland1(i).eq.0)x_add=150.<a name='646'></font>
           x_add=0.<a name='647'>
           do k=kbcon(i)+1,ktf<a name='648'>
             if(po(i,kbcon(i))-po(i,k) &gt; pmin+x_add)then<a name='649'>
                pmin_lev(i)=k<a name='650'>
                exit<a name='651'>
             endif<a name='652'>
           enddo<a name='653'>
<font color=#447700>!<a name='654'></font>
<font color=#447700>! initial conditions for updraft<a name='655'></font>
<font color=#447700>!<a name='656'></font>
            start_level(i)=k22(i)<a name='657'>
            x_add = xlv*zqexec(i)+cp*ztexec(i)<a name='658'>
            call <A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_CLOUD_BC'>get_cloud_bc</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CLOUD_BC_3">(kte,he_cup (i,1:kte),hkb (i),k22(i),x_add)<a name='659'>
         endif<a name='660'>
      enddo<a name='661'>
<font color=#447700>!<a name='662'></font>
<font color=#447700>!--- get inversion layers for mid level cloud tops<a name='663'></font>
<font color=#447700>!<a name='664'></font>
      if(imid.eq.1)then<a name='665'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_INVERSION_LAYERS'>get_inversion_layers</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_INVERSION_LAYERS_1">(ierr,p_cup,t_cup,z_cup,q_cup,qes_cup,k_inv_layers, &amp;<a name='666'>
                               kbcon,kstabi,dtempdz,itf,ktf,its,ite, kts,kte)<a name='667'>
      endif<a name='668'>
      DO i=its,itf<a name='669'>
         if(kstabi(i).lt.kbcon(i))then<a name='670'>
           kbcon(i)=1<a name='671'>
           ierr(i)=42<a name='672'>
         endif<a name='673'>
         do k=kts,ktf<a name='674'>
            entr_rate_2d(i,k)=entr_rate(i)<a name='675'>
         enddo<a name='676'>
         IF(ierr(I).eq.0)THEN<a name='677'>
<font color=#447700>!         if(imid.eq.0 .and. pmin_lev(i).lt.kbcon(i)+3)pmin_lev(i)=kbcon(i)+3<a name='678'></font>
            kbcon(i)=max(2,kbcon(i))<a name='679'>
            do k=kts,ktf<a name='680'>
               frh = min(qo_cup(i,k)/qeso_cup(i,k),1.)<a name='681'>
               entr_rate_2d(i,k)=entr_rate(i) *(1.3-frh)<a name='682'>
            enddo<a name='683'>
            if(imid.eq.1)then<a name='684'>
                if(k_inv_layers(i,2).gt.0 .and.   &amp;<a name='685'>
                  (po_cup(i,k22(i))-po_cup(i,k_inv_layers(i,2))).lt.500.)then<a name='686'>
<a name='687'>
                 ktop(i)=min(kstabi(i),k_inv_layers(i,2))<a name='688'>
                 ktopdby(i)=ktop(i)<a name='689'>
               else<a name='690'>
                 do k=kbcon(i)+1,ktf<a name='691'>
                  if((po_cup(i,k22(i))-po_cup(i,k)).gt.500.)then<a name='692'>
                    ktop(i)=k<a name='693'>
                    ktopdby(i)=ktop(i)<a name='694'>
                    exit<a name='695'>
                  endif<a name='696'>
                 enddo<a name='697'>
               endif <font color=#447700>! k_inv_lay<a name='698'></font>
            endif<a name='699'>
<a name='700'>
          endif<a name='701'>
      ENDDO<a name='702'>
<font color=#447700>!<a name='703'></font>
<font color=#447700>!-- get normalized mass flux, entrainment and detrainmentrates for updraft<a name='704'></font>
<font color=#447700>!<a name='705'></font>
      i=0<a name='706'>
      <font color=#447700>!- for mid level clouds we do not allow clouds taller than where stability<a name='707'></font>
      <font color=#447700>!- changes<a name='708'></font>
      if(imid.eq.1)then<a name='709'>
          call <A href='../../html_code/phys/module_cu_gf_deep.F.html#RATES_UP_PDF'>rates_up_pdf</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RATES_UP_PDF_1">(rand_vmas,ipr,'mid',ktop,ierr,po_cup,entr_rate_2d,hkbo,heo,heso_cup,zo_cup, &amp;<a name='710'>
                            xland1,kstabi,k22,kbcon,its,ite,itf,kts,kte,ktf,zuo,kpbl,ktopdby,csum,pmin_lev)<a name='711'>
      else<a name='712'>
          call <A href='../../html_code/phys/module_cu_gf_deep.F.html#RATES_UP_PDF'>rates_up_pdf</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RATES_UP_PDF_2">(rand_vmas,ipr,'deep',ktop,ierr,po_cup,entr_rate_2d,hkbo,heo,heso_cup,zo_cup, &amp;<a name='713'>
                            xland1,kstabi,k22,kbcon,its,ite,itf,kts,kte,ktf,zuo,kbcon,ktopdby,csum,pmin_lev)<a name='714'>
      endif<a name='715'>
<font color=#447700>!<a name='716'></font>
<font color=#447700>!<a name='717'></font>
<font color=#447700>!<a name='718'></font>
      do i=its,itf<a name='719'>
       if(ierr(i).eq.0)then<a name='720'>
<a name='721'>
         if(k22(i).gt.1)then<a name='722'>
            do k=1,k22(i) -1<a name='723'>
              zuo(i,k)=0.<a name='724'>
              zu (i,k)=0.<a name='725'>
              xzu(i,k)=0.<a name='726'>
            enddo<a name='727'>
         endif<a name='728'>
         do k=k22(i),ktop(i)<a name='729'>
          xzu(i,k)= zuo(i,k)<a name='730'>
          zu (i,k)= zuo(i,k)<a name='731'>
         enddo<a name='732'>
         do k=ktop(i)+1,kte<a name='733'>
           zuo(i,k)=0.<a name='734'>
           zu (i,k)=0.<a name='735'>
           xzu(i,k)=0.<a name='736'>
         enddo<a name='737'>
        endif<a name='738'>
      enddo<a name='739'>
<font color=#447700>!<a name='740'></font>
<font color=#447700>! calculate mass entrainment and detrainment<a name='741'></font>
<font color=#447700>!<a name='742'></font>
      CALL <A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_LATERAL_MASSFLUX'>get_lateral_massflux</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_LATERAL_MASSFLUX_1">(itf,ktf, its,ite, kts,kte                                &amp;<a name='743'>
                                ,ierr,ktop,zo_cup,zuo,cd,entr_rate_2d                    &amp;<a name='744'>
                                ,up_massentro, up_massdetro ,up_massentr, up_massdetr    &amp;<a name='745'>
                                ,'deep',kbcon,k22,up_massentru,up_massdetru,lambau)<a name='746'>
<a name='747'>
<a name='748'>
<font color=#447700>!<a name='749'></font>
<font color=#447700>!   NOTE: Ktop here already includes overshooting, ktopdby is without<a name='750'></font>
<font color=#447700>!   overshooting<a name='751'></font>
<font color=#447700>!<a name='752'></font>
      do k=kts,ktf<a name='753'>
       do i=its,itf<a name='754'>
         uc  (i,k)=0.<a name='755'>
         vc  (i,k)=0.<a name='756'>
         hc  (i,k)=0.<a name='757'>
         dby (i,k)=0.<a name='758'>
         hco (i,k)=0.<a name='759'>
         dbyo(i,k)=0.<a name='760'>
       enddo<a name='761'>
      enddo<a name='762'>
      do i=its,itf<a name='763'>
       IF(ierr(I).eq.0)THEN<a name='764'>
         do k=1,start_level(i)<a name='765'>
            uc(i,k)=u_cup(i,k)<a name='766'>
            vc(i,k)=v_cup(i,k)<a name='767'>
         enddo<a name='768'>
         do k=1,start_level(i)-1<a name='769'>
            hc (i,k)=he_cup(i,k)<a name='770'>
            hco(i,k)=heo_cup(i,k)<a name='771'>
         enddo<a name='772'>
         k=start_level(i)<a name='773'>
         hc (i,k)=hkb(i)<a name='774'>
         hco(i,k)=hkbo(i)<a name='775'>
       ENDIF <a name='776'>
      enddo<a name='777'>
<a name='778'>
      DO i=its,itf<a name='779'>
<a name='780'>
       ktopkeep(i)=0<a name='781'>
       dbyt(i,:)=0.<a name='782'>
       if(ierr(i) /= 0) cycle                 <a name='783'>
       ktopkeep(i)=ktop(i)<a name='784'>
       DO k=start_level(i) +1,ktop(i)  <font color=#447700>!mass cons option<a name='785'></font>
         <a name='786'>
          denom=zuo(i,k-1)-.5*up_massdetro(i,k-1)+up_massentro(i,k-1)<a name='787'>
          if(denom.lt.1.e-8)then<a name='788'>
           ierr(i)=51<a name='789'>
           exit<a name='790'>
          endif<a name='791'>
<a name='792'>
          hc(i,k)=(hc(i,k-1)*zu(i,k-1)-.5*up_massdetr(i,k-1)*hc(i,k-1)+                 &amp;<a name='793'>
                                          up_massentr(i,k-1)*he(i,k-1))   /             &amp;<a name='794'>
                            (zu(i,k-1)-.5*up_massdetr(i,k-1)+up_massentr(i,k-1))<a name='795'>
          uc(i,k)=(uc(i,k-1)*zu(i,k-1)-.5*up_massdetru(i,k-1)*uc(i,k-1)+                &amp;<a name='796'>
                                          up_massentru(i,k-1)*us(i,k-1)                 &amp;<a name='797'>
                            -pgcon*.5*(zu(i,k)+zu(i,k-1))*(u_cup(i,k)-u_cup(i,k-1))) /  &amp;<a name='798'>
                           (zu(i,k-1)-.5*up_massdetru(i,k-1)+up_massentru(i,k-1))<a name='799'>
          vc(i,k)=(vc(i,k-1)*zu(i,k-1)-.5*up_massdetru(i,k-1)*vc(i,k-1)+                &amp;<a name='800'>
                                          up_massentru(i,k-1)*vs(i,k-1)                 &amp;<a name='801'>
                         -pgcon*.5*(zu(i,k)+zu(i,k-1))*(v_cup(i,k)-v_cup(i,k-1))) /     &amp;<a name='802'>
                         (zu(i,k-1)-.5*up_massdetru(i,k-1)+up_massentru(i,k-1))<a name='803'>
          dby(i,k)=hc(i,k)-hes_cup(i,k)<a name='804'>
          hco(i,k)=(hco(i,k-1)*zuo(i,k-1)-.5*up_massdetro(i,k-1)*hco(i,k-1)+            &amp;<a name='805'>
                                             up_massentro(i,k-1)*heo(i,k-1))   /        &amp;<a name='806'>
                         (zuo(i,k-1)-.5*up_massdetro(i,k-1)+up_massentro(i,k-1))<a name='807'>
          dbyo(i,k)=hco(i,k)-heso_cup(i,k)<a name='808'>
          DZ=Zo_cup(i,K+1)-Zo_cup(i,K)<a name='809'>
          dbyt(i,k)=dbyt(i,k-1)+dbyo(i,k)*dz<a name='810'>
       ENDDO<a name='811'>
<font color=#447700>! for now no overshooting (only very little)<a name='812'></font>
       kk=maxloc(dbyt(i,:),1)<a name='813'>
       ki=maxloc(zuo(i,:),1)<a name='814'>
<font color=#447700>!       if(ipr .eq.1)write(16,*)'cupgf2',kk,ki<a name='815'></font>
<font color=#447700>!       if(kk.lt.ki+3)then<a name='816'></font>
<font color=#447700>!         ierr(i)=423<a name='817'></font>
<font color=#447700>!       endif<a name='818'></font>
<font color=#447700>!<a name='819'></font>
        do k=ktop(i)-1,kbcon(i),-1<a name='820'>
           if(dbyo(i,k).gt.0.)then<a name='821'>
              ktopkeep(i)=k+1<a name='822'>
              exit<a name='823'>
           endif<a name='824'>
        enddo<a name='825'>
        ktop(I)=ktopkeep(i)<a name='826'>
        if(ierr(i).eq.0)ktop(I)=ktopkeep(i)<a name='827'>
      ENDDO<a name='828'>
41    continue<a name='829'>
      DO i=its,itf<a name='830'>
       if(ierr(i) /= 0) cycle                 <a name='831'>
       do k=ktop(i)+1,ktf<a name='832'>
           HC(i,K)=hes_cup(i,k)<a name='833'>
           UC(i,K)=u_cup(i,k)<a name='834'>
           VC(i,K)=v_cup(i,k)<a name='835'>
           HCo(i,K)=heso_cup(i,k)<a name='836'>
           DBY(I,K)=0.<a name='837'>
           DBYo(I,K)=0.<a name='838'>
           zu(i,k)=0.<a name='839'>
           zuo(i,k)=0.<a name='840'>
           cd(i,k)=0.<a name='841'>
           entr_rate_2d(i,k)=0.<a name='842'>
           up_massentr(i,k)=0.<a name='843'>
           up_massdetr(i,k)=0.<a name='844'>
           up_massentro(i,k)=0.<a name='845'>
           up_massdetro(i,k)=0.<a name='846'>
       enddo<a name='847'>
      ENDDO<a name='848'>
<font color=#447700>!<a name='849'></font>
      DO i=its,itf<a name='850'>
        if(ierr(i)/=0)cycle<a name='851'>
        if(ktop(i).lt.kbcon(i)+2)then<a name='852'>
              ierr(i)=5<a name='853'>
              ierrc(i)='ktop too small deep'<a name='854'>
              ktop(i)=0<a name='855'>
        endif<a name='856'>
      ENDDO<a name='857'>
      DO 37 i=its,itf<a name='858'>
         kzdown(i)=0<a name='859'>
         if(ierr(i).eq.0)then<a name='860'>
            zktop=(zo_cup(i,ktop(i))-z1(i))*.6<a name='861'>
            if(imid.eq.1)zktop=(zo_cup(i,ktop(i))-z1(i))*.4<a name='862'>
            zktop=min(zktop+z1(i),zcutdown+z1(i))<a name='863'>
            do k=kts,ktf<a name='864'>
              if(zo_cup(i,k).gt.zktop)then<a name='865'>
                 kzdown(i)=k<a name='866'>
                 kzdown(i)=min(kzdown(i),kstabi(i)-1)  <font color=#447700>!<a name='867'></font>
                 go to 37<a name='868'>
              endif<a name='869'>
              enddo<a name='870'>
         endif<a name='871'>
 37   CONTINUE<a name='872'>
<font color=#447700>!<a name='873'></font>
<font color=#447700>!--- DOWNDRAFT ORIGINATING LEVEL - JMIN<a name='874'></font>
<font color=#447700>!<a name='875'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_MINIMI'>cup_minimi</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_MINIMI_5">(HEso_cup,K22,kzdown,JMIN,ierr, &amp;<a name='876'>
           itf,ktf, &amp;<a name='877'>
           its,ite, kts,kte)<a name='878'>
      DO 100 i=its,itf<a name='879'>
         IF(ierr(I).eq.0)THEN<a name='880'>
<font color=#447700>!<a name='881'></font>
<font color=#447700>!--- check whether it would have buoyancy, if there where<a name='882'></font>
<font color=#447700>!--- no entrainment/detrainment<a name='883'></font>
<font color=#447700>!<a name='884'></font>
         jmini = jmin(i)<a name='885'>
         keep_going = .TRUE.<a name='886'>
         do while ( keep_going )<a name='887'>
           keep_going = .FALSE.<a name='888'>
           if ( jmini - 1 .lt. kdet(i)   ) kdet(i) = jmini-1<a name='889'>
           if ( jmini     .ge. ktop(i)-1 ) jmini = ktop(i) - 2<a name='890'>
           ki = jmini<a name='891'>
           hcdo(i,ki)=heso_cup(i,ki)<a name='892'>
           DZ=Zo_cup(i,Ki+1)-Zo_cup(i,Ki)<a name='893'>
           dh=0.<a name='894'>
           do k=ki-1,1,-1<a name='895'>
             hcdo(i,k)=heso_cup(i,jmini)<a name='896'>
             DZ=Zo_cup(i,K+1)-Zo_cup(i,K)<a name='897'>
             dh=dh+dz*(HCDo(i,K)-heso_cup(i,k))<a name='898'>
             if(dh.gt.0.)then<a name='899'>
               jmini=jmini-1<a name='900'>
               if ( jmini .gt. 5 ) then<a name='901'>
                 keep_going = .TRUE.<a name='902'>
               else<a name='903'>
                 ierr(i) = 9<a name='904'>
                 ierrc(i) = "could not find jmini9"<a name='905'>
                 exit<a name='906'>
               endif<a name='907'>
             endif<a name='908'>
           enddo<a name='909'>
         enddo<a name='910'>
         jmin(i) = jmini <a name='911'>
         if ( jmini .le. 5 ) then<a name='912'>
           ierr(i)=4<a name='913'>
           ierrc(i) = "could not find jmini4"<a name='914'>
         endif<a name='915'>
       ENDIF<a name='916'>
100   continue<a name='917'>
<font color=#447700>!<a name='918'></font>
<font color=#447700>! - Must have at least depth_min m between cloud convective base<a name='919'></font>
<font color=#447700>!     and cloud top.<a name='920'></font>
<font color=#447700>!<a name='921'></font>
      do i=its,itf<a name='922'>
         IF(ierr(I).eq.0)THEN<a name='923'>
            if ( jmin(i) - 1 .lt. kdet(i)   ) kdet(i) = jmin(i)-1<a name='924'>
            IF(-zo_cup(I,KBCON(I))+zo_cup(I,KTOP(I)).LT.depth_min)then<a name='925'>
               ierr(i)=6<a name='926'>
               ierrc(i)="cloud depth very shallow"<a name='927'>
            endif<a name='928'>
         endif<a name='929'>
      enddo<a name='930'>
<a name='931'>
<font color=#447700>!<a name='932'></font>
<font color=#447700>!--- normalized downdraft mass flux profile,also work on bottom detrainment<a name='933'></font>
<font color=#447700>!--- in this routine<a name='934'></font>
<font color=#447700>!<a name='935'></font>
      do k=kts,ktf<a name='936'>
      do i=its,itf<a name='937'>
       zdo(i,k)=0.<a name='938'>
       cdd(i,k)=0.<a name='939'>
       dd_massentro(i,k)=0.<a name='940'>
       dd_massdetro(i,k)=0.<a name='941'>
       dd_massentru(i,k)=0.<a name='942'>
       dd_massdetru(i,k)=0.<a name='943'>
       hcdo(i,k)=heso_cup(i,k)<a name='944'>
       ucd(i,k)=u_cup(i,k)<a name='945'>
       vcd(i,k)=v_cup(i,k)<a name='946'>
       dbydo(i,k)=0.<a name='947'>
       mentrd_rate_2d(i,k)=entr_rate(i)<a name='948'>
      enddo<a name='949'>
      enddo<a name='950'>
      do i=its,itf<a name='951'>
        beta=max(.02,.05-float(csum(i))*.0015)  <font color=#447700>!.02<a name='952'></font>
<font color=#447700>!        beta=max(.05,.08-float(csum(i))*.0015)  !.02<a name='953'></font>
        if(imid.eq.0 .and. xland1(i) == 0)then<a name='954'>
<font color=#447700>!             beta=.01<a name='955'></font>
              edtmax(i)=max(0.1,.4-float(csum(i))*.015) <font color=#447700>!.3)<a name='956'></font>
        endif<a name='957'>
        if(imid.eq.1)beta=.02<a name='958'>
        bud(i)=0.<a name='959'>
        IF(ierr(I).eq.0)then<a name='960'>
        cdd(i,1:jmin(i))=1.e-9<a name='961'>
        cdd(i,jmin(i))=0.<a name='962'>
        dd_massdetro(i,:)=0.<a name='963'>
        dd_massentro(i,:)=0.<a name='964'>
        call <A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_ZU_ZD_PDF_FIM'>get_zu_zd_pdf_fim</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_ZU_ZD_PDF_FIM_1">(0,po_cup(i,:),rand_vmas(i),0.,ipr,xland1(i),zuh2,"DOWN",ierr(i),kdet(i),jmin(i),zdo(i,:),kts,kte,ktf,beta,kpbl(i),csum(i),pmin_lev(i))<a name='965'>
        if(zdo(i,jmin(i)) .lt.1.e-8)then<a name='966'>
          zdo(i,jmin(i))=0.<a name='967'>
          jmin(i)=jmin(i)-1<a name='968'>
          if(zdo(i,jmin(i)) .lt.1.e-8)then<a name='969'>
             ierr(i)=876<a name='970'>
             cycle<a name='971'>
          endif<a name='972'>
        endif<a name='973'>
        <a name='974'>
        do ki=jmin(i)  ,maxloc(zdo(i,:),1),-1<a name='975'>
          <font color=#447700>!=&gt; from jmin to maximum value zd -&gt; change entrainment<a name='976'></font>
          dzo=zo_cup(i,ki+1)-zo_cup(i,ki)<a name='977'>
          dd_massdetro(i,ki)=cdd(i,ki)*dzo*zdo(i,ki+1)<a name='978'>
          dd_massentro(i,ki)=zdo(i,ki)-zdo(i,ki+1)+dd_massdetro(i,ki)<a name='979'>
          if(dd_massentro(i,ki).lt.0.)then<a name='980'>
             dd_massentro(i,ki)=0.<a name='981'>
             dd_massdetro(i,ki)=zdo(i,ki+1)-zdo(i,ki)<a name='982'>
             if(zdo(i,ki+1).gt.0.)cdd(i,ki)=dd_massdetro(i,ki)/(dzo*zdo(i,ki+1))<a name='983'>
          endif<a name='984'>
          if(zdo(i,ki+1).gt.0.)mentrd_rate_2d(i,ki)=dd_massentro(i,ki)/(dzo*zdo(i,ki+1))<a name='985'>
        enddo<a name='986'>
        mentrd_rate_2d(i,1)=0.<a name='987'>
        do ki=maxloc(zdo(i,:),1)-1,1,-1<a name='988'>
          <font color=#447700>!=&gt; from maximum value zd to surface -&gt; change detrainment<a name='989'></font>
          dzo=zo_cup(i,ki+1)-zo_cup(i,ki)<a name='990'>
          dd_massentro(i,ki)=mentrd_rate_2d(i,ki)*dzo*zdo(i,ki+1)<a name='991'>
          dd_massdetro(i,ki) = zdo(i,ki+1)+dd_massentro(i,ki)-zdo(i,ki)<a name='992'>
          if(dd_massdetro(i,ki).lt.0.)then<a name='993'>
            dd_massdetro(i,ki)=0.<a name='994'>
            dd_massentro(i,ki)=zdo(i,ki)-zdo(i,ki+1)<a name='995'>
            if(zdo(i,ki+1).gt.0.)mentrd_rate_2d(i,ki)=dd_massentro(i,ki)/(dzo*zdo(i,ki+1))<a name='996'>
          endif<a name='997'>
          if(zdo(i,ki+1).gt.0.)cdd(i,ki)= dd_massdetro(i,ki)/(dzo*zdo(i,ki+1))<a name='998'>
        enddo<a name='999'>
         cbeg=po_cup(i,kbcon(i)) <font color=#447700>!850.<a name='1000'></font>
         cend=min(po_cup(i,ktop(i)),400.)<a name='1001'>
         cmid=.5*(cbeg+cend) <font color=#447700>!600.<a name='1002'></font>
         const_b=c1/((cmid*cmid-cbeg*cbeg)*(cbeg-cend)/(cend*cend-cbeg*cbeg)+cmid-cbeg)<a name='1003'>
         const_a=const_b*(cbeg-cend)/(cend*cend-cbeg*cbeg)<a name='1004'>
         const_c=-const_a*cbeg*cbeg-const_b*cbeg<a name='1005'>
         do k=kbcon(i)+1,ktop(i)-1<a name='1006'>
           c1d(i,k)=const_a*po_cup(i,k)*po_cup(i,k)+const_b*po_cup(i,k)+const_c<a name='1007'>
           c1d(i,k)=max(0.,c1d(i,k))<a name='1008'>
           c1d(i,k)=c1<a name='1009'>
         enddo<a name='1010'>
         if(imid.eq.1)c1d(i,:)=0.<a name='1011'>
<font color=#447700>!        do k=1,jmin(i)<a name='1012'></font>
<font color=#447700>!         c1d(i,k)=0.<a name='1013'></font>
<font color=#447700>!        enddo<a name='1014'></font>
<font color=#447700>!         c1d(i,jmin(i)-2)=c1/40.<a name='1015'></font>
<font color=#447700>!         if(imid.eq.1)c1d(i,jmin(i)-2)=c1/20.<a name='1016'></font>
<font color=#447700>!        do k=jmin(i)-1,ktop(i)<a name='1017'></font>
<font color=#447700>!          dz=zo_cup(i,ktop(i))-zo_cup(i,jmin(i))<a name='1018'></font>
<font color=#447700>!          c1d(i,k)=c1d(i,k-1)+c1*(zo_cup(i,k+1)-zo_cup(i,k))/dz<a name='1019'></font>
<font color=#447700>!          c1d(i,k)=max(0.,c1d(i,k))<a name='1020'></font>
<font color=#447700>!          c1d(i,k)=min(.002,c1d(i,k))<a name='1021'></font>
<font color=#447700>!        enddo<a name='1022'></font>
<a name='1023'>
<a name='1024'>
<font color=#447700>! downdraft moist static energy + moisture budget<a name='1025'></font>
          do k=2,jmin(i)+1<a name='1026'>
           dd_massentru(i,k-1)=dd_massentro(i,k-1)+lambau(i)*dd_massdetro(i,k-1)<a name='1027'>
           dd_massdetru(i,k-1)=dd_massdetro(i,k-1)+lambau(i)*dd_massdetro(i,k-1)<a name='1028'>
          enddo<a name='1029'>
            dbydo(i,jmin(i))=hcdo(i,jmin(i))-heso_cup(i,jmin(i))<a name='1030'>
            bud(i)=dbydo(i,jmin(i))*(zo_cup(i,jmin(i)+1)-zo_cup(i,jmin(i)))<a name='1031'>
            do ki=jmin(i)  ,1,-1<a name='1032'>
             dzo=zo_cup(i,ki+1)-zo_cup(i,ki)<a name='1033'>
             h_entr=.5*(heo(i,ki)+.5*(hco(i,ki)+hco(i,ki+1)))<a name='1034'>
             ucd(i,ki)=(ucd(i,ki+1)*zdo(i,ki+1)                                   &amp;<a name='1035'>
                         -.5*dd_massdetru(i,ki)*ucd(i,ki+1)+                      &amp;<a name='1036'>
                        dd_massentru(i,ki)*us(i,ki)                               &amp;<a name='1037'>
                        -pgcon*zdo(i,ki+1)*(us(i,ki+1)-us(i,ki)))   /             &amp;<a name='1038'>
                        (zdo(i,ki+1)-.5*dd_massdetru(i,ki)+dd_massentru(i,ki))<a name='1039'>
             vcd(i,ki)=(vcd(i,ki+1)*zdo(i,ki+1)                                   &amp;<a name='1040'>
                         -.5*dd_massdetru(i,ki)*vcd(i,ki+1)+                      &amp;<a name='1041'>
                        dd_massentru(i,ki)*vs(i,ki)                               &amp;<a name='1042'>
                        -pgcon*zdo(i,ki+1)*(vs(i,ki+1)-vs(i,ki)))   /             &amp;<a name='1043'>
                        (zdo(i,ki+1)-.5*dd_massdetru(i,ki)+dd_massentru(i,ki))<a name='1044'>
             hcdo(i,ki)=(hcdo(i,ki+1)*zdo(i,ki+1)                                 &amp;<a name='1045'>
                         -.5*dd_massdetro(i,ki)*hcdo(i,ki+1)+                     &amp;<a name='1046'>
                        dd_massentro(i,ki)*h_entr)   /                            &amp;<a name='1047'>
                        (zdo(i,ki+1)-.5*dd_massdetro(i,ki)+dd_massentro(i,ki))<a name='1048'>
             dbydo(i,ki)=hcdo(i,ki)-heso_cup(i,ki)<a name='1049'>
             bud(i)=bud(i)+dbydo(i,ki)*dzo<a name='1050'>
            enddo<a name='1051'>
          endif<a name='1052'>
<a name='1053'>
        if(bud(i).gt.0)then<a name='1054'>
          ierr(i)=7<a name='1055'>
          ierrc(i)='downdraft is not negatively buoyant '<a name='1056'>
        endif<a name='1057'>
      enddo<a name='1058'>
<font color=#447700>!<a name='1059'></font>
<font color=#447700>!--- calculate moisture properties of downdraft<a name='1060'></font>
<font color=#447700>!<a name='1061'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_DD_MOISTURE'>cup_dd_moisture</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_MOISTURE_1">(ierrc,zdo,hcdo,heso_cup,qcdo,qeso_cup,                &amp;<a name='1062'>
           pwdo,qo_cup,zo_cup,dd_massentro,dd_massdetro,jmin,ierr,gammao_cup,    &amp;<a name='1063'>
           pwevo,bu,qrcdo,qo,heo,1,                                              &amp;<a name='1064'>
           itf,ktf,                                                              &amp;<a name='1065'>
           its,ite, kts,kte)<a name='1066'>
<font color=#447700>!<a name='1067'></font>
<font color=#447700>!--- calculate moisture properties of updraft<a name='1068'></font>
<font color=#447700>!<a name='1069'></font>
      if(imid.eq.1)then<a name='1070'>
        call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_MOISTURE'>cup_up_moisture</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_MOISTURE_5">('mid',ierr,zo_cup,qco,qrco,pwo,pwavo,               &amp;<a name='1071'>
             p_cup,kbcon,ktop,dbyo,clw_all,xland1,                               &amp;<a name='1072'>
             qo,GAMMAo_cup,zuo,qeso_cup,k22,qo_cup,                              &amp;<a name='1073'>
             ZQEXEC,ccn,rho,c1d,tn_cup,up_massentr,up_massdetr,psum,psumh,       &amp;<a name='1074'>
             1,itf,ktf,                                                          &amp;<a name='1075'>
             its,ite, kts,kte)<a name='1076'>
      else<a name='1077'>
         call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_MOISTURE'>cup_up_moisture</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_MOISTURE_6">('deep',ierr,zo_cup,qco,qrco,pwo,pwavo,             &amp;<a name='1078'>
             p_cup,kbcon,ktop,dbyo,clw_all,xland1,                               &amp;<a name='1079'>
             qo,GAMMAo_cup,zuo,qeso_cup,k22,qo_cup,                              &amp;<a name='1080'>
             ZQEXEC,ccn,rho,c1d,tn_cup,up_massentr,up_massdetr,psum,psumh,       &amp;<a name='1081'>
             1,itf,ktf,                                                          &amp;<a name='1082'>
             its,ite, kts,kte)<a name='1083'>
      endif<a name='1084'>
      do i=its,itf<a name='1085'>
       if(ierr(i).eq.0)then<a name='1086'>
        do k=kts+1,ktop(i)<a name='1087'>
          dp=100.*(po_cup(i,1)-po_cup(i,2))<a name='1088'>
          cupclw(i,k)=qrco(i,k)        <font color=#447700>! my mod<a name='1089'></font>
          cnvwt(i,k)=zuo(i,k)*cupclw(i,k)*g/dp<a name='1090'>
        enddo<a name='1091'>
       endif<a name='1092'>
      enddo<a name='1093'>
<font color=#447700>!<a name='1094'></font>
<font color=#447700>!--- calculate workfunctions for updrafts<a name='1095'></font>
<font color=#447700>!<a name='1096'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_AA0'>cup_up_aa0</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA0_8">(aa0,z,zu,dby,GAMMA_CUP,t_cup,                              &amp;<a name='1097'>
           kbcon,ktop,ierr,                                                      &amp;<a name='1098'>
           itf,ktf,                                                              &amp;<a name='1099'>
           its,ite, kts,kte)<a name='1100'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_AA0'>cup_up_aa0</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA0_9">(aa1,zo,zuo,dbyo,GAMMAo_CUP,tn_cup,                         &amp;<a name='1101'>
           kbcon,ktop,ierr,                                                      &amp;<a name='1102'>
           itf,ktf,                                                              &amp;<a name='1103'>
           its,ite, kts,kte)<a name='1104'>
      do i=its,itf<a name='1105'>
         if(ierr(i).eq.0)then<a name='1106'>
           if(aa1(i).eq.0.)then<a name='1107'>
               ierr(i)=17<a name='1108'>
               ierrc(i)="cloud work function zero"<a name='1109'>
           endif<a name='1110'>
         endif<a name='1111'>
      enddo<a name='1112'>
<font color=#447700>!<a name='1113'></font>
<font color=#447700>!--- diurnal cycle closure <a name='1114'></font>
<font color=#447700>!<a name='1115'></font>
      <font color=#447700>!--- AA1 from boundary layer (bl) processes only<a name='1116'></font>
      aa1_bl      (:) = 0.0<a name='1117'>
      xf_dicycle   (:) = 0.0<a name='1118'>
      tau_ecmwf    (:) = 0.<a name='1119'>
      <font color=#447700>!- way to calculate the fraction of cape consumed by shallow convection<a name='1120'></font>
      iversion=1 <font color=#447700>! ecmwf  <a name='1121'></font>
      <font color=#447700>!iversion=0 ! orig    <a name='1122'></font>
      <font color=#447700>!<a name='1123'></font>
      <font color=#447700>! Betchold et al 2008 time-scale of cape removal<a name='1124'></font>
<font color=#447700>!<a name='1125'></font>
<font color=#447700>! wmean is of no meaning over land....<a name='1126'></font>
<font color=#447700>! still working on replacing it over water<a name='1127'></font>
<font color=#447700>!<a name='1128'></font>
      DO i=its,itf<a name='1129'>
            if(ierr(i).eq.0)then<a name='1130'>
                <font color=#447700>!- mean vertical velocity <a name='1131'></font>
                wmean(i) = 7.0 <font color=#447700>! m/s ! in the future change for Wmean == integral( W dz) / cloud_depth<a name='1132'></font>
                if(imid.eq.1)wmean(i) = 3.0<a name='1133'>
                <font color=#447700>!- time-scale cape removal from  Betchold et al. 2008<a name='1134'></font>
                tau_ecmwf(i)=( zo_cup(i,ktopdby(i))- zo_cup(i,kbcon(i)) ) / wmean(i) <a name='1135'>
                tau_ecmwf(i)= tau_ecmwf(i) * (1.0061 + 1.23E-2 * (dx(i)/1000.))<font color=#447700>! dx(i) must be in meters <a name='1136'></font>
            endif<a name='1137'>
      enddo<a name='1138'>
      tau_bl(:)     = 0.<a name='1139'>
      <font color=#447700>!<a name='1140'></font>
      IF(dicycle == 1) then<a name='1141'>
        DO i=its,itf<a name='1142'>
            <a name='1143'>
            if(ierr(i).eq.0)then<a name='1144'>
                if(xland1(i) ==  0 ) then<a name='1145'>
                  <font color=#447700>!- over water<a name='1146'></font>
                  umean= 2.0+sqrt(2.0*(US(i,1)**2+VS(i,1)**2+US(i,kbcon(i))**2+VS(i,kbcon(i))**2))<a name='1147'>
                  tau_bl(i) = (zo_cup(i,kbcon(i))- z1(i)) /umean        <a name='1148'>
                else<a name='1149'>
                  <font color=#447700>!- over land<a name='1150'></font>
                  tau_bl(i) =( zo_cup(i,ktopdby(i))- zo_cup(i,kbcon(i)) ) / wmean(i)<a name='1151'>
                endif<a name='1152'>
<a name='1153'>
            endif<a name='1154'>
        ENDDO<a name='1155'>
<a name='1156'>
        if(iversion == 1) then <a name='1157'>
        <font color=#447700>!-- version ecmwf<a name='1158'></font>
        t_star=4.  <font color=#447700>!original =1<a name='1159'></font>
<a name='1160'>
           <font color=#447700>!-- calculate pcape from BL forcing only<a name='1161'></font>
            call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_AA1BL'>cup_up_aa1bl</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA1BL_1">(aa1_bl,t,tn,q,qo,dtime,                            &amp;<a name='1162'>
                              zo_cup,zuo,dbyo_bl,GAMMAo_CUP_bl,tn_cup_bl,        &amp;<a name='1163'>
                              kbcon,ktop,ierr,                                   &amp;<a name='1164'>
                              itf,ktf,its,ite, kts,kte)<a name='1165'>
<a name='1166'>
            DO i=its,itf<a name='1167'>
<a name='1168'>
            if(ierr(i).eq.0)then<a name='1169'>
<a name='1170'>
               <font color=#447700>!- only for convection rooting in the PBL<a name='1171'></font>
               if(zo_cup(i,kbcon(i))-z1(i) &gt; zo(i,kpbl(i)+1)) then <a name='1172'>
                  aa1_bl(i) = 0.0<a name='1173'>
               else<a name='1174'>
               <font color=#447700>!- multiply aa1_bl the " time-scale" - tau_bl<a name='1175'></font>
                  aa1_bl(i) = max(0.,aa1_bl(i)/t_star* tau_bl(i))<a name='1176'>
               endif <a name='1177'>
            endif<a name='1178'>
            ENDDO<a name='1179'>
            <a name='1180'>
        else<a name='1181'>
        <a name='1182'>
          <font color=#447700>!- version for real cloud-work function<a name='1183'></font>
          <a name='1184'>
          <font color=#447700>!-get the profiles modified only by bl tendencies<a name='1185'></font>
          DO i=its,itf<a name='1186'>
           tn_bl(i,:)=0.;qo_bl(i,:)=0.<a name='1187'>
           if ( ierr(i) == 0 )then<a name='1188'>
            <font color=#447700>!below kbcon -&gt; modify profiles<a name='1189'></font>
            tn_bl(i,1:kbcon(i)) = tn(i,1:kbcon(i))<a name='1190'>
            qo_bl(i,1:kbcon(i)) = qo(i,1:kbcon(i))<a name='1191'>
                 <font color=#447700>!above kbcon -&gt; keep environment profiles<a name='1192'></font>
            tn_bl(i,kbcon(i)+1:ktf) = t(i,kbcon(i)+1:ktf)<a name='1193'>
            qo_bl(i,kbcon(i)+1:ktf) = q(i,kbcon(i)+1:ktf)<a name='1194'>
           endif <a name='1195'>
          ENDDO<a name='1196'>
          <font color=#447700>!--- calculate moist static energy, heights, qes, ... only by bl tendencies<a name='1197'></font>
          call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV'>cup_env</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_8">(zo,qeso_bl,heo_bl,heso_bl,tn_bl,qo_bl,po,z1,                              &amp;<a name='1198'>
                     psur,ierr,tcrit,-1,                                                         &amp;<a name='1199'>
                     itf,ktf, its,ite, kts,kte)<a name='1200'>
          <font color=#447700>!--- environmental values on cloud levels only by bl tendencies<a name='1201'></font>
          call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV_CLEV'>cup_env_clev</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_CLEV_8">(tn_bl,qeso_bl,qo_bl,heo_bl,heso_bl,zo,po,qeso_cup_bl,qo_cup_bl,      &amp;<a name='1202'>
                              heo_cup_bl,heso_cup_bl,zo_cup,po_cup,gammao_cup_bl,tn_cup_bl,psur, &amp;<a name='1203'>
                              ierr,z1,                                                           &amp;<a name='1204'>
                              itf,ktf,its,ite, kts,kte)<a name='1205'>
          DO i=its,itf<a name='1206'>
            IF(ierr(I).eq.0)THEN<a name='1207'>
               hkbo_bl(i)=heo_cup_bl(i,k22(i)) <a name='1208'>
            endif <font color=#447700>! ierr<a name='1209'></font>
          ENDDO<a name='1210'>
          DO k=kts,ktf<a name='1211'>
           do i=its,itf<a name='1212'>
             hco_bl (i,k)=0.<a name='1213'>
             DBYo_bl(i,k)=0.<a name='1214'>
           enddo<a name='1215'>
          ENDDO<a name='1216'>
          DO i=its,itf<a name='1217'>
            IF(ierr(I).eq.0)THEN<a name='1218'>
             do k=1,kbcon(i)-1<a name='1219'>
              hco_bl(i,k)=hkbo_bl(i)<a name='1220'>
             enddo<a name='1221'>
             k=kbcon(i)<a name='1222'>
             hco_bl (i,k)=hkbo_bl(i)<a name='1223'>
             DBYo_bl(i,k)=Hkbo_bl(i) - HESo_cup_bl(i,k)<a name='1224'>
            ENDIF<a name='1225'>
          ENDDO<a name='1226'>
<font color=#447700>!          <a name='1227'></font>
<font color=#447700>!          <a name='1228'></font>
          DO i=its,itf<a name='1229'>
            if(ierr(i).eq.0)then<a name='1230'>
               do k=kbcon(i)+1,ktop(i)<a name='1231'>
                    hco_bl(i,k)=(hco_bl(i,k-1)*zuo(i,k-1)-.5*up_massdetro(i,k-1)*hco_bl(i,k-1)+ &amp;<a name='1232'>
                               up_massentro(i,k-1)*heo_bl(i,k-1))   /                           &amp;<a name='1233'>
                               (zuo(i,k-1)-.5*up_massdetro(i,k-1)+up_massentro(i,k-1))<a name='1234'>
                    dbyo_bl(i,k)=hco_bl(i,k)-heso_cup_bl(i,k)<a name='1235'>
               enddo<a name='1236'>
               do k=ktop(i)+1,ktf<a name='1237'>
                  hco_bl (i,k)=heso_cup_bl(i,k)<a name='1238'>
                  dbyo_bl(i,k)=0.0<a name='1239'>
               enddo<a name='1240'>
            endif<a name='1241'>
          ENDDO<a name='1242'>
        <a name='1243'>
          <font color=#447700>!--- calculate workfunctions for updrafts<a name='1244'></font>
          call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_AA0'>cup_up_aa0</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA0_10">(aa1_bl,zo,zuo,dbyo_bl,GAMMAo_CUP_bl,tn_cup_bl,        &amp;<a name='1245'>
                        kbcon,ktop,ierr,                                        &amp;<a name='1246'>
                        itf,ktf,its,ite, kts,kte)<a name='1247'>
<a name='1248'>
          DO i=its,itf<a name='1249'>
            <a name='1250'>
            if(ierr(i).eq.0)then<a name='1251'>
                <font color=#447700>!- get the increment on AA0 due the BL processes<a name='1252'></font>
                aa1_bl(i) = aa1_bl(i) - aa0(i)<a name='1253'>
                <font color=#447700>!- only for convection rooting in the PBL<a name='1254'></font>
                <font color=#447700>!if(zo_cup(i,kbcon(i))-z1(i) &gt; 500.0) then !- instead 500 -&gt; zo_cup(kpbl(i))<a name='1255'></font>
                <font color=#447700>!   aa1_bl(i) = 0.0<a name='1256'></font>
                <font color=#447700>!else<a name='1257'></font>
                <font color=#447700>!   !- multiply aa1_bl the "normalized time-scale" - tau_bl/ model_timestep<a name='1258'></font>
                   aa1_bl(i) = aa1_bl(i)* tau_bl(i)/ dtime<a name='1259'>
                <font color=#447700>!endif <a name='1260'></font>
                print*,'aa0,aa1bl=',aa0(i),aa1_bl(i),aa0(i)-aa1_bl(i),tau_bl(i)<font color=#447700>!,dtime,xland(i)     <a name='1261'></font>
            endif<a name='1262'>
           ENDDO<a name='1263'>
        ENDIF<a name='1264'>
     ENDIF  <font color=#447700>! version of implementation<a name='1265'></font>
<a name='1266'>
<a name='1267'>
       axx(:)=aa1(:)<a name='1268'>
<a name='1269'>
<font color=#447700>!<a name='1270'></font>
<font color=#447700>!--- DETERMINE DOWNDRAFT STRENGTH IN TERMS OF WINDSHEAR<a name='1271'></font>
<font color=#447700>!<a name='1272'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_DD_EDT'>cup_dd_edt</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_EDT_2">(ierr,us,vs,zo,ktop,kbcon,edt,po,pwavo,  &amp;<a name='1273'>
           pwo,ccn,pwevo,edtmax,edtmin,edtc,psum,psumh,       &amp;<a name='1274'>
           rho,aeroevap,itf,ktf,                              &amp;<a name='1275'>
           its,ite, kts,kte)<a name='1276'>
        do i=its,itf<a name='1277'>
         if(ierr(i).eq.0)then<a name='1278'>
            edto(i)=edtc(i,1)<a name='1279'>
         endif<a name='1280'>
        enddo<a name='1281'>
        do k=kts,ktf<a name='1282'>
        do i=its,itf<a name='1283'>
           dellat_ens (i,k,1)=0.<a name='1284'>
           dellaq_ens (i,k,1)=0.<a name='1285'>
           dellaqc_ens(i,k,1)=0.<a name='1286'>
           pwo_ens    (i,k,1)=0.<a name='1287'>
        enddo<a name='1288'>
        enddo<a name='1289'>
<font color=#447700>!<a name='1290'></font>
<font color=#447700>!--- change per unit mass that a model cloud would modify the environment<a name='1291'></font>
<font color=#447700>!<a name='1292'></font>
<font color=#447700>!--- 1. in bottom layer<a name='1293'></font>
<font color=#447700>!<a name='1294'></font>
      do k=kts,kte<a name='1295'>
      do i=its,itf<a name='1296'>
        dellu  (i,k)=0.<a name='1297'>
        dellv  (i,k)=0.<a name='1298'>
        dellah (i,k)=0.<a name='1299'>
        dellat (i,k)=0.<a name='1300'>
        dellaq (i,k)=0.<a name='1301'>
        dellaqc(i,k)=0.<a name='1302'>
      enddo<a name='1303'>
      enddo<a name='1304'>
<font color=#447700>!<a name='1305'></font>
<font color=#447700>!----------------------------------------------  cloud level ktop<a name='1306'></font>
<font color=#447700>!<a name='1307'></font>
<font color=#447700>!- - - - - - - - - - - - - - - - - - - - - - - - model level ktop-1<a name='1308'></font>
<font color=#447700>!      .               .                 .<a name='1309'></font>
<font color=#447700>!      .               .                 .<a name='1310'></font>
<font color=#447700>!      .               .                 .<a name='1311'></font>
<font color=#447700>!      .               .                 .<a name='1312'></font>
<font color=#447700>!      .               .                 .<a name='1313'></font>
<font color=#447700>!      .               .                 .<a name='1314'></font>
<font color=#447700>!<a name='1315'></font>
<font color=#447700>!----------------------------------------------  cloud level k+2<a name='1316'></font>
<font color=#447700>!<a name='1317'></font>
<font color=#447700>!- - - - - - - - - - - - - - - - - - - - - - - - model level k+1<a name='1318'></font>
<font color=#447700>!<a name='1319'></font>
<font color=#447700>!----------------------------------------------  cloud level k+1<a name='1320'></font>
<font color=#447700>!<a name='1321'></font>
<font color=#447700>!- - - - - - - - - - - - - - - - - - - - - - - - model level k<a name='1322'></font>
<font color=#447700>!<a name='1323'></font>
<font color=#447700>!----------------------------------------------  cloud level k<a name='1324'></font>
<font color=#447700>!<a name='1325'></font>
<font color=#447700>!      .               .                 .<a name='1326'></font>
<font color=#447700>!      .               .                 .<a name='1327'></font>
<font color=#447700>!      .               .                 .<a name='1328'></font>
<font color=#447700>!      .               .                 .<a name='1329'></font>
<font color=#447700>!      .               .                 .<a name='1330'></font>
<font color=#447700>!      .               .                 .<a name='1331'></font>
<font color=#447700>!      .               .                 .<a name='1332'></font>
<font color=#447700>!      .               .                 .<a name='1333'></font>
<font color=#447700>!      .               .                 .<a name='1334'></font>
<font color=#447700>!      .               .                 .<a name='1335'></font>
<font color=#447700>!<a name='1336'></font>
<font color=#447700>!----------------------------------------------  cloud level 3<a name='1337'></font>
<font color=#447700>!<a name='1338'></font>
<font color=#447700>!- - - - - - - - - - - - - - - - - - - - - - - - model level 2<a name='1339'></font>
<font color=#447700>!<a name='1340'></font>
<font color=#447700>!----------------------------------------------  cloud level 2<a name='1341'></font>
<font color=#447700>!<a name='1342'></font>
<font color=#447700>!- - - - - - - - - - - - - - - - - - - - - - - - model level 1<a name='1343'></font>
<a name='1344'>
      do i=its,itf<a name='1345'>
        if(ierr(i).eq.0)then<a name='1346'>
         dp=100.*(po_cup(i,1)-po_cup(i,2))<a name='1347'>
         dellu(i,1)=pgcd*(edto(i)*zdo(i,2)*ucd(i,2)   &amp;<a name='1348'>
                         -edto(i)*zdo(i,2)*u_cup(i,2))*g/dp<a name='1349'>
         dellv(i,1)=pgcd*(edto(i)*zdo(i,2)*vcd(i,2)   &amp;<a name='1350'>
                         -edto(i)*zdo(i,2)*v_cup(i,2))*g/dp<a name='1351'>
<a name='1352'>
         do k=kts+1,ktop(i)<a name='1353'>
            <font color=#447700>! these three are only used at or near mass detrainment and/or entrainment levels<a name='1354'></font>
            pgc=pgcon<a name='1355'>
            entupk=0.<a name='1356'>
            if(k == k22(i)-1) entupk=zuo(i,k+1)<a name='1357'>
            detupk=0.<a name='1358'>
            entdoj=0.<a name='1359'>
            <font color=#447700>! detrainment and entrainment for fowndrafts<a name='1360'></font>
            detdo=edto(i)*dd_massdetro(i,k)<a name='1361'>
            entdo=edto(i)*dd_massentro(i,k)<a name='1362'>
            <font color=#447700>! entrainment/detrainment for updraft<a name='1363'></font>
            entup=up_massentro(i,k)<a name='1364'>
            detup=up_massdetro(i,k)<a name='1365'>
            <font color=#447700>! subsidence by downdrafts only<a name='1366'></font>
            subin=-zdo(i,k+1)*edto(i)<a name='1367'>
            subdown=-zdo(i,k)*edto(i)<a name='1368'>
            <font color=#447700>!         SPECIAL LEVELS<a name='1369'></font>
            if(k.eq.ktop(i))then<a name='1370'>
               detupk=zuo(i,ktop(i))<a name='1371'>
               subin=0.<a name='1372'>
               subdown=0.<a name='1373'>
               detdo=0.<a name='1374'>
               entdo=0.<a name='1375'>
               entup=0.<a name='1376'>
               detup=0.<a name='1377'>
            endif<a name='1378'>
            totmas=subin-subdown+detup-entup-entdo+ &amp;<a name='1379'>
                   detdo-entupk-entdoj+detupk+zuo(i,k+1)-zuo(i,k)<a name='1380'>
            if(abs(totmas).gt.1.e-6)then<a name='1381'>
               write(0,123)'totmas=',k22(i),kbcon(i),k,entup,detup,zuo(i,k+1),zuo(i,k),detdo,entdo<a name='1382'>
123     formAT(a7,1X,3i3,2E12.4,2(1x,f5.2),2e12.4)<a name='1383'>
            endif<a name='1384'>
            dp=100.*(po_cup(i,k)-po_cup(i,k+1))<a name='1385'>
             pgc=pgcon<a name='1386'>
            if(k.ge.ktop(i))pgc=0.<a name='1387'>
<a name='1388'>
             dellu(i,k) =-(zuo(i,k+1)*(uc (i,k+1)-u_cup(i,k+1) ) -                               &amp;<a name='1389'>
                            zuo(i,k  )*(uc (i,k  )-u_cup(i,k  ) ) )*g/dp                         &amp;<a name='1390'>
                          +(zdo(i,k+1)*(ucd(i,k+1)-u_cup(i,k+1) ) -                              &amp;<a name='1391'>
                            zdo(i,k  )*(ucd(i,k  )-u_cup(i,k  ) ) )*g/dp*edto(i)*pgcd<a name='1392'>
             dellv(i,k) =-(zuo(i,k+1)*(vc (i,k+1)-v_cup(i,k+1) ) -                               &amp;<a name='1393'>
                            zuo(i,k  )*(vc (i,k  )-v_cup(i,k  ) ) )*g/dp                         &amp;<a name='1394'>
                         +(zdo(i,k+1)*(vcd(i,k+1)-v_cup(i,k+1) ) -                               &amp;<a name='1395'>
                            zdo(i,k  )*(vcd(i,k  )-v_cup(i,k  ) ) )*g/dp*edto(i)*pgcd<a name='1396'>
 <a name='1397'>
       enddo   <font color=#447700>! k<a name='1398'></font>
<a name='1399'>
      endif<a name='1400'>
    enddo<a name='1401'>
<a name='1402'>
<a name='1403'>
    do i=its,itf<a name='1404'>
        <font color=#447700>!trash  = 0.0<a name='1405'></font>
        <font color=#447700>!trash2 = 0.0<a name='1406'></font>
        if(ierr(i).eq.0)then<a name='1407'>
<a name='1408'>
         dp=100.*(po_cup(i,1)-po_cup(i,2))<a name='1409'>
<a name='1410'>
         dellah(i,1)=(edto(i)*zdo(i,2)*hcdo(i,2)          &amp;<a name='1411'>
                     -edto(i)*zdo(i,2)*heo_cup(i,2))*g/dp<a name='1412'>
<a name='1413'>
         dellaq (i,1)=(edto(i)*zdo(i,2)*qcdo(i,2)         &amp;<a name='1414'>
                      -edto(i)*zdo(i,2)*qo_cup(i,2))*g/dp<a name='1415'>
        <a name='1416'>
         G_rain=  0.5*(pwo (i,1)+pwo (i,2))*g/dp<a name='1417'>
         E_dn  = -0.5*(pwdo(i,1)+pwdo(i,2))*g/dp*edto(i)  <font color=#447700>! pwdo &lt; 0 and E_dn must &gt; 0<a name='1418'></font>
         dellaq(i,1) = dellaq(i,1)+ E_dn-G_rain<a name='1419'>
         <a name='1420'>
         <font color=#447700>!--- conservation check<a name='1421'></font>
         <font color=#447700>!- water mass balance<a name='1422'></font>
         <font color=#447700>!trash = trash  + (dellaq(i,1)+dellaqc(i,1)+G_rain-E_dn)*dp/g          <a name='1423'></font>
         <font color=#447700>!- H  budget<a name='1424'></font>
         <font color=#447700>!trash2 = trash2+ (dellah(i,1))*dp/g<a name='1425'></font>
         <a name='1426'>
<a name='1427'>
         do k=kts+1,ktop(i)<a name='1428'>
            dp=100.*(po_cup(i,k)-po_cup(i,k+1))<a name='1429'>
            <font color=#447700>! these three are only used at or near mass detrainment and/or entrainment levels<a name='1430'></font>
<a name='1431'>
            dellah(i,k) =-(zuo(i,k+1)*(hco (i,k+1)-heo_cup(i,k+1) ) -                 &amp;<a name='1432'>
                           zuo(i,k  )*(hco (i,k  )-heo_cup(i,k  ) ) )*g/dp            &amp;<a name='1433'>
                         +(zdo(i,k+1)*(hcdo(i,k+1)-heo_cup(i,k+1) ) -                 &amp;<a name='1434'>
                           zdo(i,k  )*(hcdo(i,k  )-heo_cup(i,k  ) ) )*g/dp*edto(i)<a name='1435'>
                        <a name='1436'>
<a name='1437'>
            <font color=#447700>!- check H conservation <a name='1438'></font>
            <font color=#447700>! trash2 = trash2+ (dellah(i,k))*dp/g<a name='1439'></font>
        <a name='1440'>
        <a name='1441'>
            <font color=#447700>!-- take out cloud liquid water for detrainment<a name='1442'></font>
            detup=up_massdetro(i,k)<a name='1443'>
            dz=zo_cup(i,k)-zo_cup(i,k-1)<a name='1444'>
            if(k.lt.ktop(i)) dellaqc(i,k) = zuo(i,k)*c1d(i,k)*qrco(i,k)*dz/dp*g <a name='1445'>
<font color=#447700>!             dellaqc(i,k)=  detup*0.5*(qrco(i,k+1)+qrco(i,k)) *g/dp<a name='1446'></font>
            if(k.eq.ktop(i))dellaqc(i,k)= detup*0.5*(qrco(i,k+1)+qrco(i,k)) *g/dp<a name='1447'>
            <font color=#447700>!---<a name='1448'></font>
            G_rain=  0.5*(pwo (i,k)+pwo (i,k+1))*g/dp<a name='1449'>
            E_dn  = -0.5*(pwdo(i,k)+pwdo(i,k+1))*g/dp*edto(i) <font color=#447700>! pwdo &lt; 0 and E_dn must &gt; 0<a name='1450'></font>
            <font color=#447700>!-- condensation source term = detrained + flux divergence of<a name='1451'></font>
            <font color=#447700>!-- cloud liquid water (qrco) + converted to rain<a name='1452'></font>
        <a name='1453'>
            C_up = dellaqc(i,k)+(zuo(i,k+1)* qrco(i,k+1) -                           &amp;<a name='1454'>
                                zuo(i,k  )* qrco(i,k  )  )*g/dp + G_rain<a name='1455'>
<font color=#447700>!            C_up = dellaqc(i,k)+ G_rain<a name='1456'></font>
            <font color=#447700>!-- water vapor budget<a name='1457'></font>
            <font color=#447700>!-- = flux divergence z*(Q_c - Q_env)_up_and_down                        &amp;<a name='1458'></font>
            <font color=#447700>!--   - condensation term + evaporation<a name='1459'></font>
            dellaq(i,k) =-(zuo(i,k+1)*(qco (i,k+1)-qo_cup(i,k+1) ) -                 &amp;<a name='1460'>
                           zuo(i,k  )*(qco (i,k  )-qo_cup(i,k  ) ) )*g/dp            &amp;<a name='1461'>
                         +(zdo(i,k+1)*(qcdo(i,k+1)-qo_cup(i,k+1) ) -                 &amp;<a name='1462'>
                           zdo(i,k  )*(qcdo(i,k  )-qo_cup(i,k  ) ) )*g/dp*edto(i)    &amp;<a name='1463'>
                         - C_up + E_dn<a name='1464'>
            <font color=#447700>!- check water conservation liq+condensed (including rainfall)<a name='1465'></font>
            <font color=#447700>! trash= trash+ (dellaq(i,k)+dellaqc(i,k)+ G_rain-E_dn)*dp/g<a name='1466'></font>
<a name='1467'>
         enddo   <font color=#447700>! k<a name='1468'></font>
        endif<a name='1469'>
<a name='1470'>
      enddo<a name='1471'>
444   format(1x,i2,1x,7e12.4) <font color=#447700>!,1x,f7.2,2x,e13.5)<a name='1472'></font>
<font color=#447700>!<a name='1473'></font>
<font color=#447700>!--- using dellas, calculate changed environmental profiles<a name='1474'></font>
<font color=#447700>!<a name='1475'></font>
      mbdt=.1<a name='1476'>
      do i=its,itf<a name='1477'>
      xaa0_ens(i,1)=0.<a name='1478'>
      enddo<a name='1479'>
<a name='1480'>
      do i=its,itf<a name='1481'>
         if(ierr(i).eq.0)then<a name='1482'>
           do k=kts,ktf<a name='1483'>
            XHE(I,K)=DELLAH(I,K)*MBDT+HEO(I,K)<a name='1484'>
<font color=#447700>!            XQ(I,K)=max(1.e-16,(dellaqc(i,k)+DELLAQ(I,K))*MBDT+QO(I,K))<a name='1485'></font>
            XQ(I,K)=max(1.e-16,DELLAQ(I,K)*MBDT+QO(I,K))<a name='1486'>
            DELLAT(I,K)=(1./cp)*(DELLAH(I,K)-xlv*DELLAQ(I,K))<a name='1487'>
<font color=#447700>!            XT(I,K)= (DELLAT(I,K)-xlv/cp*dellaqc(i,k))*MBDT+TN(I,K)<a name='1488'></font>
            XT(I,K)= DELLAT(I,K)*MBDT+TN(I,K)<a name='1489'>
            xt(i,k)=max(190.,xt(i,k))<a name='1490'>
           enddo<a name='1491'>
         ENDIF<a name='1492'>
      enddo<a name='1493'>
      do i=its,itf<a name='1494'>
      if(ierr(i).eq.0)then<a name='1495'>
      XHE(I,ktf)=HEO(I,ktf)<a name='1496'>
      XQ(I,ktf)=QO(I,ktf)<a name='1497'>
      XT(I,ktf)=TN(I,ktf)<a name='1498'>
      endif<a name='1499'>
      enddo<a name='1500'>
<font color=#447700>!<a name='1501'></font>
<font color=#447700>!--- calculate moist static energy, heights, qes<a name='1502'></font>
<font color=#447700>!<a name='1503'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV'>cup_env</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_9">(xz,xqes,xhe,xhes,xt,xq,po,z1,                   &amp;<a name='1504'>
           psur,ierr,tcrit,-1,                                     &amp;<a name='1505'>
           itf,ktf,                                                &amp;<a name='1506'>
           its,ite, kts,kte)<a name='1507'>
<font color=#447700>!<a name='1508'></font>
<font color=#447700>!--- environmental values on cloud levels<a name='1509'></font>
<font color=#447700>!<a name='1510'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV_CLEV'>cup_env_clev</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_CLEV_9">(xt,xqes,xq,xhe,xhes,xz,po,xqes_cup,xq_cup, &amp;<a name='1511'>
           xhe_cup,xhes_cup,xz_cup,po_cup,gamma_cup,xt_cup,psur,   &amp;<a name='1512'>
           ierr,z1,                                                &amp;<a name='1513'>
           itf,ktf,                                                &amp;<a name='1514'>
           its,ite, kts,kte)<a name='1515'>
<font color=#447700>!<a name='1516'></font>
<font color=#447700>!<a name='1517'></font>
<font color=#447700>!**************************** static control<a name='1518'></font>
<font color=#447700>!<a name='1519'></font>
<font color=#447700>!--- moist static energy inside cloud<a name='1520'></font>
<font color=#447700>!<a name='1521'></font>
      do k=kts,ktf<a name='1522'>
      do i=its,itf<a name='1523'>
         xhc(i,k)=0.<a name='1524'>
         xDBY(I,K)=0.<a name='1525'>
      enddo<a name='1526'>
      enddo<a name='1527'>
      do i=its,itf<a name='1528'>
        if(ierr(i).eq.0)then<a name='1529'>
         x_add = xlv*zqexec(i)+cp*ztexec(i)<a name='1530'>
         call <A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_CLOUD_BC'>get_cloud_bc</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CLOUD_BC_4">(kte,xhe_cup (i,1:kte),xhkb (i),k22(i),x_add)<a name='1531'>
         do k=1,start_level(i)-1<a name='1532'>
            xhc(i,k)=xhe_cup(i,k)<a name='1533'>
         enddo<a name='1534'>
         k=start_level(i)<a name='1535'>
         xhc(i,k)=xhkb(i)<a name='1536'>
        endif <font color=#447700>!ierr<a name='1537'></font>
      enddo<a name='1538'>
<font color=#447700>!<a name='1539'></font>
<font color=#447700>!<a name='1540'></font>
      do i=its,itf<a name='1541'>
       if(ierr(i).eq.0)then<a name='1542'>
        do k=start_level(i)  +1,ktop(i)<a name='1543'>
         xhc(i,k)=(xhc(i,k-1)*xzu(i,k-1)-.5*up_massdetro(i,k-1)*xhc(i,k-1)  + &amp;<a name='1544'>
                                            up_massentro(i,k-1)*xhe(i,k-1)) / &amp;<a name='1545'>
                             (xzu(i,k-1)-.5*up_massdetro(i,k-1)+up_massentro(i,k-1))<a name='1546'>
         xdby(i,k)=xhc(i,k)-xhes_cup(i,k)<a name='1547'>
        enddo<a name='1548'>
        do k=ktop(i)+1,ktf<a name='1549'>
           xHC (i,K)=xhes_cup(i,k)<a name='1550'>
           xDBY(I,K)=0.<a name='1551'>
        enddo<a name='1552'>
       endif<a name='1553'>
      enddo<a name='1554'>
<a name='1555'>
<font color=#447700>!<a name='1556'></font>
<font color=#447700>!--- workfunctions for updraft<a name='1557'></font>
<font color=#447700>!<a name='1558'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_AA0'>cup_up_aa0</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA0_11">(xaa0,xz,xzu,xdby,GAMMA_CUP,xt_cup, &amp;<a name='1559'>
           kbcon,ktop,ierr,                              &amp;<a name='1560'>
           itf,ktf,                                      &amp;<a name='1561'>
           its,ite, kts,kte)<a name='1562'>
      do i=its,itf <a name='1563'>
         if(ierr(i).eq.0)then<a name='1564'>
           xaa0_ens(i,1)=xaa0(i)<a name='1565'>
           do k=kts,ktop(i)<a name='1566'>
                 do nens3=1,maxens3<a name='1567'>
                 if(nens3.eq.7)then<a name='1568'>
<font color=#447700>!--- b=0<a name='1569'></font>
                 pr_ens(i,nens3)=pr_ens(i,nens3)  &amp;<a name='1570'>
                                    +pwo(i,k)+edto(i)*pwdo(i,k) <a name='1571'>
<font color=#447700>!--- b=beta<a name='1572'></font>
                 else if(nens3.eq.8)then<a name='1573'>
                 pr_ens(i,nens3)=pr_ens(i,nens3)+ &amp;<a name='1574'>
                                    pwo(i,k)+edto(i)*pwdo(i,k)<a name='1575'>
<font color=#447700>!--- b=beta/2<a name='1576'></font>
                 else if(nens3.eq.9)then<a name='1577'>
                 pr_ens(i,nens3)=pr_ens(i,nens3)  &amp;<a name='1578'>
                                 +  pwo(i,k)+edto(i)*pwdo(i,k)<a name='1579'>
                 else<a name='1580'>
                 pr_ens(i,nens3)=pr_ens(i,nens3)+ &amp;<a name='1581'>
                                    pwo(i,k) +edto(i)*pwdo(i,k)<a name='1582'>
                 endif<a name='1583'>
                 enddo<a name='1584'>
           enddo<a name='1585'>
         if(pr_ens(i,7).lt.1.e-6)then<a name='1586'>
            ierr(i)=18<a name='1587'>
            ierrc(i)="total normalized condensate too small"<a name='1588'>
            do nens3=1,maxens3<a name='1589'>
               pr_ens(i,nens3)=0.<a name='1590'>
            enddo<a name='1591'>
         endif<a name='1592'>
         do nens3=1,maxens3<a name='1593'>
           if(pr_ens(i,nens3).lt.1.e-5)then<a name='1594'>
            pr_ens(i,nens3)=0.<a name='1595'>
           endif<a name='1596'>
         enddo<a name='1597'>
         endif<a name='1598'>
      enddo<a name='1599'>
 200  continue<a name='1600'>
<font color=#447700>!<a name='1601'></font>
<font color=#447700>!--- LARGE SCALE FORCING<a name='1602'></font>
<font color=#447700>!<a name='1603'></font>
<font color=#447700>!<a name='1604'></font>
<font color=#447700>!------- CHECK wether aa0 should have been zero, assuming this <a name='1605'></font>
<font color=#447700>!        ensemble is chosen<a name='1606'></font>
<font color=#447700>!<a name='1607'></font>
<font color=#447700>!<a name='1608'></font>
      do i=its,itf<a name='1609'>
         ierr2(i)=ierr(i)<a name='1610'>
         ierr3(i)=ierr(i)<a name='1611'>
         k22x(i)=k22(i)<a name='1612'>
      enddo<a name='1613'>
        CALL <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_MAXIMI'>cup_MAXIMI</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_MAXIMI_5">(HEO_CUP,2,KBMAX,K22x,ierr,                        &amp;<a name='1614'>
             itf,ktf,                                                     &amp;<a name='1615'>
             its,ite, kts,kte)<a name='1616'>
        iloop=2<a name='1617'>
        call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_KBCON'>cup_kbcon</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KBCON_7">(ierrc,cap_max_increment,iloop,k22x,kbconx,heo_cup, &amp;<a name='1618'>
             heso_cup,hkbo,ierr2,kbmax,po_cup,cap_max,                    &amp;<a name='1619'>
             ztexec,zqexec,                                               &amp;<a name='1620'>
             0,itf,ktf,                                                   &amp;<a name='1621'>
             its,ite, kts,kte,                                            &amp;<a name='1622'>
             z_cup,entr_rate,heo,imid)<a name='1623'>
        iloop=3<a name='1624'>
        call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_KBCON'>cup_kbcon</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KBCON_8">(ierrc,cap_max_increment,iloop,k22x,kbconx,heo_cup, &amp;<a name='1625'>
             heso_cup,hkbo,ierr3,kbmax,po_cup,cap_max,                    &amp;<a name='1626'>
             ztexec,zqexec,                                               &amp;<a name='1627'>
             0,itf,ktf,                                                   &amp;<a name='1628'>
             its,ite, kts,kte,                                            &amp;<a name='1629'>
             z_cup,entr_rate,heo,imid)<a name='1630'>
<font color=#447700>!<a name='1631'></font>
<font color=#447700>!--- calculate cloud base mass flux<a name='1632'></font>
<font color=#447700>!<a name='1633'></font>
<a name='1634'>
      DO I = its,itf<a name='1635'>
        mconv(i) = 0<a name='1636'>
        if(ierr(i)/=0)cycle<a name='1637'>
        DO K=1,ktop(i)<a name='1638'>
          dq=(qo_cup(i,k+1)-qo_cup(i,k))<a name='1639'>
          mconv(i)=mconv(i)+omeg(i,k)*dq/g<a name='1640'>
        ENDDO<a name='1641'>
      ENDDO<a name='1642'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_FORCING_ENS_3D'>cup_forcing_ens_3d</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_FORCING_ENS_3D_2">(closure_n,xland1,aa0,aa1,xaa0_ens,mbdt,dtime, &amp;<a name='1643'>
           ierr,ierr2,ierr3,xf_ens,axx,forcing,                             &amp;<a name='1644'>
           maxens3,mconv,rand_clos,                                         &amp;<a name='1645'>
           po_cup,ktop,omeg,zdo,k22,zuo,pr_ens,edto,kbcon,                  &amp;<a name='1646'>
           ichoice,                                                         &amp;<a name='1647'>
           imid,ipr,itf,ktf,                                                &amp;<a name='1648'>
           its,ite, kts,kte,                                                &amp;<a name='1649'>
           dicycle,tau_ecmwf,aa1_bl,xf_dicycle)<a name='1650'>
<font color=#447700>!<a name='1651'></font>
      do k=kts,ktf<a name='1652'>
      do i=its,itf<a name='1653'>
        if(ierr(i).eq.0)then<a name='1654'>
           dellat_ens (i,k,1)=dellat(i,k)<a name='1655'>
           dellaq_ens (i,k,1)=dellaq(i,k)<a name='1656'>
           dellaqc_ens(i,k,1)=dellaqc(i,k)<a name='1657'>
           pwo_ens    (i,k,1)=pwo(i,k) <font color=#447700>!+edto(i)*pwdo(i,k)<a name='1658'></font>
        else <a name='1659'>
           dellat_ens (i,k,1)=0.<a name='1660'>
           dellaq_ens (i,k,1)=0.<a name='1661'>
           dellaqc_ens(i,k,1)=0.<a name='1662'>
           pwo_ens    (i,k,1)=0.<a name='1663'>
        endif<a name='1664'>
      enddo<a name='1665'>
      enddo<a name='1666'>
 250  continue<a name='1667'>
<font color=#447700>!<a name='1668'></font>
<font color=#447700>!--- FEEDBACK<a name='1669'></font>
<font color=#447700>!<a name='1670'></font>
       if(imid.eq.1 .and. ichoice .le.2)then<a name='1671'>
         do i=its,itf<a name='1672'>
          <font color=#447700>!-boundary layer QE <a name='1673'></font>
          xff_mid(i,1)=0.<a name='1674'>
          xff_mid(i,2)=0.<a name='1675'>
          if(ierr(i).eq.0)then<a name='1676'>
            blqe=0.<a name='1677'>
            trash=0.<a name='1678'>
            if(k22(i).lt.kpbl(i)+1)then<a name='1679'>
               do k=1,kpbl(i)<a name='1680'>
                  blqe=blqe+100.*dhdt(i,k)*(po_cup(i,k)-po_cup(i,k+1))/g<a name='1681'>
               enddo<a name='1682'>
               trash=max((hco(i,kbcon(i))-heo_cup(i,kbcon(i))),1.e1)<a name='1683'>
               xff_mid(i,1)=max(0.,blqe/trash)<a name='1684'>
               xff_mid(i,1)=min(0.1,xff_mid(i,1))<a name='1685'>
             endif<a name='1686'>
             xff_mid(i,2)=min(0.1,.03*zws(i))<a name='1687'>
          endif<a name='1688'>
         enddo<a name='1689'>
       endif<a name='1690'>
       call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_OUTPUT_ENS_3D'>cup_output_ens_3d</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_GF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_OUTPUT_ENS_3D_2">(xff_mid,xf_ens,ierr,dellat_ens,dellaq_ens, &amp;<a name='1691'>
            dellaqc_ens,outt,                                            &amp;<a name='1692'>
            outq,outqc,zuo,pre,pwo_ens,xmb,ktop,                         &amp;<a name='1693'>
            edto,pwdo,'deep',ierr2,ierr3,                                          &amp;<a name='1694'>
            po_cup,pr_ens,maxens3,                                              &amp;<a name='1695'>
            sig,closure_n,xland1,xmbm_in,xmbs_in,                        &amp;<a name='1696'>
            ichoice,imid,ipr,itf,ktf,                                    &amp;<a name='1697'>
            its,ite, kts,kte,                                            &amp;<a name='1698'>
            dicycle,xf_dicycle )<a name='1699'>
      k=1<a name='1700'>
      do i=its,itf<a name='1701'>
          if(ierr(i).eq.0 .and.pre(i).gt.0.) then<a name='1702'>
             PRE(I)=MAX(PRE(I),0.)<a name='1703'>
             xmb_out(i)=xmb(i)<a name='1704'>
             do k=kts,ktop(i)<a name='1705'>
               outu(i,k)=dellu(i,k)*xmb(i)<a name='1706'>
               outv(i,k)=dellv(i,k)*xmb(i)<a name='1707'>
             enddo<a name='1708'>
          elseif(ierr(i).ne.0 .or. pre(i).eq.0.)then<a name='1709'>
             ktop(i)=0<a name='1710'>
             do k=kts,kte<a name='1711'>
               outt(i,k)=0.<a name='1712'>
               outq(i,k)=0.<a name='1713'>
               outqc(i,k)=0.<a name='1714'>
               outu(i,k)=0.<a name='1715'>
               outv(i,k)=0.<a name='1716'>
             enddo<a name='1717'>
          endif<a name='1718'>
      enddo<a name='1719'>
<font color=#447700>! rain evaporation as in SAS<a name='1720'></font>
<font color=#447700>!<a name='1721'></font>
      if(irainevap.eq.1)then<a name='1722'>
      do i = its,itf<a name='1723'>
       rntot(i) = 0.<a name='1724'>
       delqev(i) = 0.<a name='1725'>
       delq2(i) = 0.<a name='1726'>
       rn(i)    = 0.<a name='1727'>
       rntot(i)    = 0.<a name='1728'>
       rain=0.<a name='1729'>
       if(ierr(i).eq.0)then<a name='1730'>
         do k = ktop(i), 1, -1<a name='1731'>
              rain =  pwo(i,k) + edto(i) * pwdo(i,k)<a name='1732'>
              rntot(i) = rntot(i) + rain * xmb(i)* .001 * dtime<a name='1733'>
         enddo<a name='1734'>
       endif<a name='1735'>
      enddo<a name='1736'>
      do i = its,itf<a name='1737'>
         qevap(i) = 0.<a name='1738'>
         flg(i) = .true.<a name='1739'>
         if(ierr(i).eq.0)then<a name='1740'>
         evef = edt(i) * evfact<a name='1741'>
         if(xland(i).gt.0.5 .and. xland(i).lt.1.5) evef=edt(i) * evfactl<a name='1742'>
         do k = ktop(i), 1, -1<a name='1743'>
              rain =  pwo(i,k) + edto(i) * pwdo(i,k)<a name='1744'>
              rn(i) = rn(i) + rain * xmb(i) * .001 * dtime<a name='1745'>
              if(flg(i))then<a name='1746'>
              q1=qo(i,k)+(outq(i,k))*dtime<a name='1747'>
              t1=tn(i,k)+(outt(i,k))*dtime<a name='1748'>
              qcond(i) = evef * (q1 - qeso(i,k))            &amp;<a name='1749'>
     &amp;                 / (1. + el2orc * qeso(i,k) / t1**2)<a name='1750'>
              dp = -100.*(p_cup(i,k+1)-p_cup(i,k))<a name='1751'>
              if(rn(i).gt.0. .and. qcond(i).lt.0.) then<a name='1752'>
                qevap(i) = -qcond(i) * (1.-exp(-.32*sqrt(dtime*rn(i))))<a name='1753'>
                qevap(i) = min(qevap(i), rn(i)*1000.*g/dp)<a name='1754'>
                delq2(i) = delqev(i) + .001 * qevap(i) * dp / g<a name='1755'>
              endif<a name='1756'>
              if(rn(i).gt.0..and.qcond(i).lt.0..and. &amp;<a name='1757'>
     &amp;           delq2(i).gt.rntot(i)) then<a name='1758'>
                qevap(i) = 1000.* g * (rntot(i) - delqev(i)) / dp<a name='1759'>
                flg(i) = .false.<a name='1760'>
              endif<a name='1761'>
              if(rn(i).gt.0..and.qevap(i).gt.0.) then<a name='1762'>
                outq(i,k) = outq(i,k) + qevap(i)/dtime<a name='1763'>
                outt(i,k) = outt(i,k) - elocp * qevap(i)/dtime<a name='1764'>
                rn(i) = max(0.,rn(i) - .001 * qevap(i) * dp / g)<a name='1765'>
                pre(i) = pre(i) - qevap(i) * dp /g/dtime<a name='1766'>
                PRE(I)=MAX(PRE(I),0.)<a name='1767'>
                delqev(i) = delqev(i) + .001*dp*qevap(i)/g<a name='1768'>
              endif<a name='1769'>
          endif<a name='1770'>
        enddo<a name='1771'>
<font color=#447700>!       pre(i)=1000.*rn(i)/dtime<a name='1772'></font>
      endif<a name='1773'>
      enddo<a name='1774'>
      endif<a name='1775'>
<font color=#447700>!<a name='1776'></font>
<font color=#447700>! since kinetic energy is being dissipated, add heating accordingly (from ECMWF)<a name='1777'></font>
<font color=#447700>!<a name='1778'></font>
      do i=its,itf<a name='1779'>
          if(ierr(i).eq.0) then<a name='1780'>
             dts=0.<a name='1781'>
             fpi=0.<a name='1782'>
             do k=kts,ktop(i)<a name='1783'>
                dp=(po_cup(i,k)-po_cup(i,k+1))*100.<a name='1784'>
<font color=#447700>!total KE dissiptaion estimate<a name='1785'></font>
                dts= dts -(outu(i,k)*us(i,k)+outv(i,k)*vs(i,k))*dp/g<a name='1786'>
<font color=#447700>! fpi needed for calcualtion of conversion to pot. energyintegrated <a name='1787'></font>
                fpi = fpi  +sqrt(outu(i,k)*outu(i,k) + outv(i,k)*outv(i,k))*dp<a name='1788'>
             enddo<a name='1789'>
             if(fpi.gt.0.)then<a name='1790'>
                do k=kts,ktop(i)<a name='1791'>
                   fp= sqrt((outu(i,k)*outu(i,k)+outv(i,k)*outv(i,k)))/fpi<a name='1792'>
                   outt(i,k)=outt(i,k)+fp*dts*g/cp<a name='1793'>
                enddo<a name='1794'>
             endif<a name='1795'>
          endif<a name='1796'>
      enddo<a name='1797'>
<a name='1798'>
<a name='1799'>
<font color=#447700>!<a name='1800'></font>
<font color=#447700>!---------------------------done------------------------------<a name='1801'></font>
<font color=#447700>!<a name='1802'></font>
<a name='1803'>
   END SUBROUTINE CUP_gf<a name='1804'>
<a name='1805'>
<a name='1806'>
<A NAME='CUP_DD_EDT'><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_DD_EDT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1807'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dd_edt</font>(ierr,us,vs,z,ktop,kbcon,edt,p,pwav, &amp; <A href='../../call_to/CUP_DD_EDT.html' TARGET='index'>2</A><a name='1808'>
              pw,ccn,pwev,edtmax,edtmin,edtc,psum2,psumh,    &amp;<a name='1809'>
              rho,aeroevap,itf,ktf,                          &amp;<a name='1810'>
              its,ite, kts,kte                     )<a name='1811'>
<a name='1812'>
   IMPLICIT NONE<a name='1813'>
<a name='1814'>
     integer                                                 &amp;<a name='1815'>
        ,intent (in   )                   ::                 &amp;<a name='1816'>
        aeroevap,itf,ktf,                                    &amp;<a name='1817'>
        its,ite, kts,kte<a name='1818'>
  <font color=#447700>!<a name='1819'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='1820'></font>
  <font color=#447700>!<a name='1821'></font>
     real,    dimension (its:ite,kts:kte)                    &amp;<a name='1822'>
        ,intent (in   )                   ::                 &amp;<a name='1823'>
        rho,us,vs,z,p,pw<a name='1824'>
     real,    dimension (its:ite,1)                          &amp;<a name='1825'>
        ,intent (out  )                   ::                 &amp;<a name='1826'>
        edtc<a name='1827'>
     real,    dimension (its:ite)                            &amp;<a name='1828'>
        ,intent (out  )                   ::                 &amp;<a name='1829'>
        edt<a name='1830'>
     real,    dimension (its:ite)                            &amp;<a name='1831'>
        ,intent (in   )                   ::                 &amp;<a name='1832'>
        pwav,pwev,ccn,psum2,psumh,edtmax,edtmin<a name='1833'>
     integer, dimension (its:ite)                            &amp;<a name='1834'>
        ,intent (in   )                   ::                 &amp;<a name='1835'>
        ktop,kbcon<a name='1836'>
     integer, dimension (its:ite)                            &amp;<a name='1837'>
        ,intent (inout)                   ::                 &amp;<a name='1838'>
        ierr<a name='1839'>
<font color=#447700>!<a name='1840'></font>
<font color=#447700>!  local variables in this routine<a name='1841'></font>
<font color=#447700>!<a name='1842'></font>
<a name='1843'>
     integer i,k,kk<a name='1844'>
     real    einc,pef,pefb,prezk,zkbc<a name='1845'>
     real,    dimension (its:ite)         ::                 &amp;<a name='1846'>
      vshear,sdp,vws<a name='1847'>
     real :: prop_c,pefc,aeroadd,alpha3,beta3<a name='1848'>
     prop_c=8. <font color=#447700>!10.386<a name='1849'></font>
     alpha3 = 1.9<a name='1850'>
     beta3  = -1.13<a name='1851'>
     pefc=0.<a name='1852'>
<a name='1853'>
<font color=#447700>!<a name='1854'></font>
<font color=#447700>!--- DETERMINE DOWNDRAFT STRENGTH IN TERMS OF WINDSHEAR<a name='1855'></font>
<font color=#447700>!<a name='1856'></font>
<font color=#447700>! */ calculate an average wind shear over the depth of the cloud<a name='1857'></font>
<font color=#447700>!<a name='1858'></font>
       do i=its,itf<a name='1859'>
        edt(i)=0.<a name='1860'>
        vws(i)=0.<a name='1861'>
        sdp(i)=0.<a name='1862'>
        vshear(i)=0.<a name='1863'>
       enddo<a name='1864'>
       do i=its,itf<a name='1865'>
        edtc(i,1)=0.<a name='1866'>
       enddo<a name='1867'>
       do kk = kts,ktf-1<a name='1868'>
         do 62 i=its,itf<a name='1869'>
          IF(ierr(i).ne.0)GO TO 62<a name='1870'>
          if (kk .le. min0(ktop(i),ktf) .and. kk .ge. kbcon(i)) then<a name='1871'>
             vws(i) = vws(i)+                                        &amp;<a name='1872'>
              (abs((us(i,kk+1)-us(i,kk))/(z(i,kk+1)-z(i,kk)))        &amp;<a name='1873'>
          +   abs((vs(i,kk+1)-vs(i,kk))/(z(i,kk+1)-z(i,kk)))) *      &amp;<a name='1874'>
              (p(i,kk) - p(i,kk+1))<a name='1875'>
            sdp(i) = sdp(i) + p(i,kk) - p(i,kk+1)<a name='1876'>
          endif<a name='1877'>
          if (kk .eq. ktf-1)vshear(i) = 1.e3 * vws(i) / sdp(i)<a name='1878'>
   62   continue<a name='1879'>
       end do<a name='1880'>
      do i=its,itf<a name='1881'>
         IF(ierr(i).eq.0)then<a name='1882'>
            pef=(1.591-.639*VSHEAR(I)+.0953*(VSHEAR(I)**2)            &amp;<a name='1883'>
               -.00496*(VSHEAR(I)**3))<a name='1884'>
            if(pef.gt.0.9)pef=0.9<a name='1885'>
            if(pef.lt.0.1)pef=0.1<a name='1886'>
<font color=#447700>!<a name='1887'></font>
<font color=#447700>!--- cloud base precip efficiency<a name='1888'></font>
<font color=#447700>!<a name='1889'></font>
            zkbc=z(i,kbcon(i))*3.281e-3<a name='1890'>
            prezk=.02<a name='1891'>
            if(zkbc.gt.3.)then<a name='1892'>
               prezk=.96729352+zkbc*(-.70034167+zkbc*(.162179896+zkbc &amp;<a name='1893'>
               *(- 1.2569798E-2+zkbc*(4.2772E-4-zkbc*5.44E-6))))<a name='1894'>
            endif<a name='1895'>
            if(zkbc.gt.25)then<a name='1896'>
               prezk=2.4<a name='1897'>
            endif<a name='1898'>
            pefb=1./(1.+prezk)<a name='1899'>
            if(pefb.gt.0.9)pefb=0.9<a name='1900'>
            if(pefb.lt.0.1)pefb=0.1<a name='1901'>
            EDT(I)=1.-.5*(pefb+pef)<a name='1902'>
            if(aeroevap.gt.1)then<a name='1903'>
               aeroadd=(ccnclean**beta3)*((psumh(i))**(alpha3-1)) <font color=#447700>!*1.e6<a name='1904'></font>
<font color=#447700>!              prop_c=.9/aeroadd<a name='1905'></font>
               prop_c=.5*(pefb+pef)/aeroadd<a name='1906'>
               aeroadd=(ccn(i)**beta3)*((psum2(i))**(alpha3-1)) <font color=#447700>!*1.e6<a name='1907'></font>
               aeroadd=prop_c*aeroadd<a name='1908'>
               pefc=aeroadd<a name='1909'>
               if(pefc.gt.0.9)pefc=0.9<a name='1910'>
               if(pefc.lt.0.1)pefc=0.1<a name='1911'>
               EDT(I)=1.-pefc<a name='1912'>
               if(aeroevap.eq.2)EDT(I)=1.-.25*(pefb+pef+2.*pefc)<a name='1913'>
            endif<a name='1914'>
<a name='1915'>
<a name='1916'>
<font color=#447700>!--- edt here is 1-precipeff!<a name='1917'></font>
            einc=.2*edt(i)<a name='1918'>
            edtc(i,1)=edt(i)-einc<a name='1919'>
         endif<a name='1920'>
      enddo<a name='1921'>
      do i=its,itf<a name='1922'>
         IF(ierr(i).eq.0)then<a name='1923'>
               EDTC(I,1)=-EDTC(I,1)*pwav(I)/PWEV(I)<a name='1924'>
               IF(EDTC(I,1).GT.edtmax(i))EDTC(I,1)=edtmax(i)<a name='1925'>
               IF(EDTC(I,1).LT.edtmin(i))EDTC(I,1)=edtmin(i)<a name='1926'>
         endif<a name='1927'>
      enddo<a name='1928'>
<a name='1929'>
   END SUBROUTINE cup_dd_edt<a name='1930'>
<a name='1931'>
<a name='1932'>
<A NAME='CUP_DD_MOISTURE'><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_DD_MOISTURE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1933'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dd_moisture</font>(ierrc,zd,hcd,hes_cup,qcd,qes_cup,  &amp; <A href='../../call_to/CUP_DD_MOISTURE.html' TARGET='index'>1</A><a name='1934'>
              pwd,q_cup,z_cup,dd_massentr,dd_massdetr,jmin,ierr, &amp;<a name='1935'>
              gamma_cup,pwev,bu,qrcd,                            &amp;<a name='1936'>
              q,he,iloop,                                        &amp;<a name='1937'>
              itf,ktf,                                           &amp;<a name='1938'>
              its,ite, kts,kte                     )<a name='1939'>
<a name='1940'>
   IMPLICIT NONE<a name='1941'>
<a name='1942'>
     integer                                                     &amp;<a name='1943'>
        ,intent (in   )                   ::                     &amp;<a name='1944'>
                                  itf,ktf,                       &amp;<a name='1945'>
                                  its,ite, kts,kte<a name='1946'>
  <font color=#447700>! cdd= detrainment function <a name='1947'></font>
  <font color=#447700>! q = environmental q on model levels<a name='1948'></font>
  <font color=#447700>! q_cup = environmental q on model cloud levels<a name='1949'></font>
  <font color=#447700>! qes_cup = saturation q on model cloud levels<a name='1950'></font>
  <font color=#447700>! hes_cup = saturation h on model cloud levels<a name='1951'></font>
  <font color=#447700>! hcd = h in model cloud<a name='1952'></font>
  <font color=#447700>! bu = buoancy term<a name='1953'></font>
  <font color=#447700>! zd = normalized downdraft mass flux<a name='1954'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='1955'></font>
  <font color=#447700>! mentr_rate = entrainment rate<a name='1956'></font>
  <font color=#447700>! qcd = cloud q (including liquid water) after entrainment<a name='1957'></font>
  <font color=#447700>! qrch = saturation q in cloud<a name='1958'></font>
  <font color=#447700>! pwd = evaporate at that level<a name='1959'></font>
  <font color=#447700>! pwev = total normalized integrated evaoprate (I2)<a name='1960'></font>
  <font color=#447700>! entr= entrainment rate <a name='1961'></font>
  <font color=#447700>!<a name='1962'></font>
     real,    dimension (its:ite,kts:kte)               &amp;<a name='1963'>
        ,intent (in   )                   ::            &amp;<a name='1964'>
        zd,hes_cup,hcd,qes_cup,q_cup,z_cup,             &amp;<a name='1965'>
        dd_massentr,dd_massdetr,gamma_cup,q,he <a name='1966'>
     integer                                            &amp;<a name='1967'>
        ,intent (in   )                   ::            &amp;<a name='1968'>
        iloop<a name='1969'>
     integer, dimension (its:ite)                       &amp;<a name='1970'>
        ,intent (in   )                   ::            &amp;<a name='1971'>
        jmin<a name='1972'>
     integer, dimension (its:ite)                       &amp;<a name='1973'>
        ,intent (inout)                   ::            &amp;<a name='1974'>
        ierr<a name='1975'>
     real,    dimension (its:ite,kts:kte)&amp;<a name='1976'>
        ,intent (out  )                   ::            &amp;<a name='1977'>
        qcd,qrcd,pwd<a name='1978'>
     real,    dimension (its:ite)&amp;<a name='1979'>
        ,intent (out  )                   ::            &amp;<a name='1980'>
        pwev,bu<a name='1981'>
     character*50 :: ierrc(its:ite)<a name='1982'>
<font color=#447700>!<a name='1983'></font>
<font color=#447700>!  local variables in this routine<a name='1984'></font>
<font color=#447700>!<a name='1985'></font>
<a name='1986'>
     integer                              ::            &amp;<a name='1987'>
        i,k,ki<a name='1988'>
     real                                 ::            &amp;<a name='1989'>
        denom,dh,dz,dqeva<a name='1990'>
<a name='1991'>
      do i=its,itf<a name='1992'>
         bu(i)=0.<a name='1993'>
         pwev(i)=0.<a name='1994'>
      enddo<a name='1995'>
      do k=kts,ktf<a name='1996'>
      do i=its,itf<a name='1997'>
         qcd(i,k)=0.<a name='1998'>
         qrcd(i,k)=0.<a name='1999'>
         pwd(i,k)=0.<a name='2000'>
      enddo<a name='2001'>
      enddo<a name='2002'>
<font color=#447700>!<a name='2003'></font>
<font color=#447700>!<a name='2004'></font>
<font color=#447700>!<a name='2005'></font>
      do 100 i=its,itf<a name='2006'>
      IF(ierr(I).eq.0)then<a name='2007'>
      k=jmin(i)<a name='2008'>
      DZ=Z_cup(i,K+1)-Z_cup(i,K)<a name='2009'>
      qcd(i,k)=q_cup(i,k)<a name='2010'>
      DH=HCD(I,k)-HES_cup(I,K)<a name='2011'>
      if(dh.lt.0)then<a name='2012'>
        QRCD(I,K)=(qes_cup(i,k)+(1./XLV)*(GAMMA_cup(i,k) &amp;<a name='2013'>
                  /(1.+GAMMA_cup(i,k)))*DH)<a name='2014'>
        else<a name='2015'>
          qrcd(i,k)=qes_cup(i,k)<a name='2016'>
        endif<a name='2017'>
      pwd(i,jmin(i))=zd(i,jmin(i))*min(0.,qcd(i,k)-qrcd(i,k))<a name='2018'>
      qcd(i,k)=qrcd(i,k)<a name='2019'>
      pwev(i)=pwev(i)+pwd(i,jmin(i)) <font color=#447700>! *dz<a name='2020'></font>
<font color=#447700>!<a name='2021'></font>
      bu(i)=dz*dh<a name='2022'>
      do ki=jmin(i)-1,1,-1<a name='2023'>
         DZ=Z_cup(i,Ki+1)-Z_cup(i,Ki)<a name='2024'>
<font color=#447700>!        QCD(i,Ki)=(qCD(i,Ki+1)*(1.-.5*CDD(i,Ki+1)*DZ) &amp;<a name='2025'></font>
<font color=#447700>!                 +entr*DZ*q(i,Ki) &amp;<a name='2026'></font>
<font color=#447700>!                )/(1.+entr*DZ-.5*CDD(i,Ki+1)*DZ)<a name='2027'></font>
<font color=#447700>!        dz=qcd(i,ki)<a name='2028'></font>
<font color=#447700>!print*,"i=",i," k=",ki," qcd(i,ki+1)=",qcd(i,ki+1)<a name='2029'></font>
<font color=#447700>!print*,"zd=",zd(i,ki+1)," dd_ma=",dd_massdetr(i,ki)," q=",q(i,ki)<a name='2030'></font>
<font color=#447700>!JOE-added check for non-zero denominator:<a name='2031'></font>
         denom=zd(i,ki+1)-.5*dd_massdetr(i,ki)+dd_massentr(i,ki)<a name='2032'>
         if(denom.lt.1.e-8)then<a name='2033'>
            ierr(i)=51<a name='2034'>
            exit<a name='2035'>
         endif<a name='2036'>
         qcd(i,ki)=(qcd(i,ki+1)*zd(i,ki+1)                    &amp;<a name='2037'>
                  -.5*dd_massdetr(i,ki)*qcd(i,ki+1)+          &amp;<a name='2038'>
                  dd_massentr(i,ki)*q(i,ki))   /              &amp;<a name='2039'>
                  (zd(i,ki+1)-.5*dd_massdetr(i,ki)+dd_massentr(i,ki))<a name='2040'>
<font color=#447700>!<a name='2041'></font>
<font color=#447700>!--- to be negatively buoyant, hcd should be smaller than hes!<a name='2042'></font>
<font color=#447700>!--- ideally, dh should be negative till dd hits ground, but that is not always<a name='2043'></font>
<font color=#447700>!--- the case<a name='2044'></font>
<font color=#447700>!<a name='2045'></font>
         DH=HCD(I,ki)-HES_cup(I,Ki)<a name='2046'>
         bu(i)=bu(i)+dz*dh<a name='2047'>
         QRCD(I,Ki)=qes_cup(i,ki)+(1./XLV)*(GAMMA_cup(i,ki)   &amp;<a name='2048'>
                  /(1.+GAMMA_cup(i,ki)))*DH<a name='2049'>
         dqeva=qcd(i,ki)-qrcd(i,ki)<a name='2050'>
         if(dqeva.gt.0.)then<a name='2051'>
          dqeva=0.<a name='2052'>
          qrcd(i,ki)=qcd(i,ki)<a name='2053'>
         endif<a name='2054'>
         pwd(i,ki)=zd(i,ki)*dqeva<a name='2055'>
         qcd(i,ki)=qrcd(i,ki)<a name='2056'>
         pwev(i)=pwev(i)+pwd(i,ki) <font color=#447700>! *dz<a name='2057'></font>
<font color=#447700>!        if(iloop.eq.1.and.i.eq.102.and.j.eq.62)then<a name='2058'></font>
<font color=#447700>!         print *,'in cup_dd_moi ', hcd(i,ki),HES_cup(I,Ki),dh,dqeva<a name='2059'></font>
<font color=#447700>!        endif<a name='2060'></font>
      enddo<a name='2061'>
<font color=#447700>!<a name='2062'></font>
<font color=#447700>!--- end loop over i<a name='2063'></font>
       if( (pwev(i).eq.0.) .and. (iloop.eq.1))then<a name='2064'>
<font color=#447700>!        print *,'problem with buoy in cup_dd_moisture',i<a name='2065'></font>
         ierr(i)=7<a name='2066'>
         ierrc(i)="problem with buoy in cup_dd_moisture"<a name='2067'>
       endif<a name='2068'>
       if(BU(I).GE.0.and.iloop.eq.1)then<a name='2069'>
<font color=#447700>!        print *,'problem with buoy in cup_dd_moisture',i<a name='2070'></font>
         ierr(i)=7<a name='2071'>
         ierrc(i)="problem2 with buoy in cup_dd_moisture"<a name='2072'>
       endif<a name='2073'>
      endif<a name='2074'>
100    continue<a name='2075'>
<a name='2076'>
   END SUBROUTINE cup_dd_moisture<a name='2077'>
<a name='2078'>
<A NAME='CUP_ENV'><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2079'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_env</font>(z,qes,he,hes,t,q,p,z1,                &amp; <A href='../../call_to/CUP_ENV.html' TARGET='index'>12</A>,<A href='../../call_from/CUP_ENV.html' TARGET='index'>1</A><a name='2080'>
              psur,ierr,tcrit,itest,                        &amp;<a name='2081'>
              itf,ktf,                                      &amp;<a name='2082'>
              its,ite, kts,kte                     )<a name='2083'>
<a name='2084'>
   IMPLICIT NONE<a name='2085'>
<a name='2086'>
     integer                                                &amp;<a name='2087'>
        ,intent (in   )                   ::                &amp;<a name='2088'>
        itf,ktf,                                            &amp;<a name='2089'>
        its,ite, kts,kte<a name='2090'>
  <font color=#447700>!<a name='2091'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2092'></font>
  <font color=#447700>! q           = environmental mixing ratio<a name='2093'></font>
  <font color=#447700>! qes         = environmental saturation mixing ratio<a name='2094'></font>
  <font color=#447700>! t           = environmental temp<a name='2095'></font>
  <font color=#447700>! tv          = environmental virtual temp<a name='2096'></font>
  <font color=#447700>! p           = environmental pressure<a name='2097'></font>
  <font color=#447700>! z           = environmental heights<a name='2098'></font>
  <font color=#447700>! he          = environmental moist static energy<a name='2099'></font>
  <font color=#447700>! hes         = environmental saturation moist static energy<a name='2100'></font>
  <font color=#447700>! psur        = surface pressure<a name='2101'></font>
  <font color=#447700>! z1          = terrain elevation<a name='2102'></font>
  <font color=#447700>! <a name='2103'></font>
  <font color=#447700>!<a name='2104'></font>
     real,    dimension (its:ite,kts:kte)                &amp;<a name='2105'>
        ,intent (in   )                   ::             &amp;<a name='2106'>
        p,t,q<a name='2107'>
     real,    dimension (its:ite,kts:kte)                &amp;<a name='2108'>
        ,intent (out  )                   ::             &amp;<a name='2109'>
        he,hes,qes<a name='2110'>
     real,    dimension (its:ite,kts:kte)                &amp;<a name='2111'>
        ,intent (inout)                   ::             &amp;<a name='2112'>
        z<a name='2113'>
     real,    dimension (its:ite)                        &amp;<a name='2114'>
        ,intent (in   )                   ::             &amp;<a name='2115'>
        psur,z1<a name='2116'>
     integer, dimension (its:ite)                        &amp;<a name='2117'>
        ,intent (inout)                   ::             &amp;<a name='2118'>
        ierr<a name='2119'>
     integer                                             &amp;<a name='2120'>
        ,intent (in   )                   ::             &amp;<a name='2121'>
        itest<a name='2122'>
<font color=#447700>!<a name='2123'></font>
<font color=#447700>!  local variables in this routine<a name='2124'></font>
<font color=#447700>!<a name='2125'></font>
<a name='2126'>
     integer                              ::             &amp;<a name='2127'>
       i,k<a name='2128'>
<font color=#447700>!     real, dimension (1:2) :: AE,BE,HT<a name='2129'></font>
      real, dimension (its:ite,kts:kte) :: tv<a name='2130'>
      real :: tcrit,e,tvbar<a name='2131'>
<font color=#447700>!     real, external :: satvap<a name='2132'></font>
<font color=#447700>!     real :: satvap<a name='2133'></font>
<a name='2134'>
<a name='2135'>
<font color=#447700>!      HT(1)=XLV/CP<a name='2136'></font>
<font color=#447700>!      HT(2)=2.834E6/CP<a name='2137'></font>
<font color=#447700>!      BE(1)=.622*HT(1)/.286<a name='2138'></font>
<font color=#447700>!      AE(1)=BE(1)/273.+ALOG(610.71)<a name='2139'></font>
<font color=#447700>!      BE(2)=.622*HT(2)/.286<a name='2140'></font>
<font color=#447700>!      AE(2)=BE(2)/273.+ALOG(610.71)<a name='2141'></font>
      do k=kts,ktf<a name='2142'>
      do i=its,itf<a name='2143'>
        if(ierr(i).eq.0)then<a name='2144'>
<font color=#447700>!Csgb - IPH is for phase, dependent on TCRIT (water or ice)<a name='2145'></font>
<font color=#447700>!       IPH=1<a name='2146'></font>
<font color=#447700>!       IF(T(I,K).LE.TCRIT)IPH=2<a name='2147'></font>
<font color=#447700>!       print *, 'AE(IPH),BE(IPH) = ',AE(IPH),BE(IPH),AE(IPH)-BE(IPH),T(i,k),i,k<a name='2148'></font>
<font color=#447700>!       E=EXP(AE(IPH)-BE(IPH)/T(I,K))<a name='2149'></font>
<font color=#447700>!       print *, 'P, E = ', P(I,K), E<a name='2150'></font>
<font color=#447700>!       QES(I,K)=.622*E/(100.*P(I,K)-E)<a name='2151'></font>
        e=<A href='../../html_code/phys/module_ra_flg.F.html#SATVAP'>satvap</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SATVAP_1">(t(i,k))<a name='2152'>
        qes(i,k)=0.622*e/max(1.e-8,(p(i,k)-e))<a name='2153'>
        IF(QES(I,K).LE.1.E-16)QES(I,K)=1.E-16<a name='2154'>
        IF(QES(I,K).LT.Q(I,K))QES(I,K)=Q(I,K)<a name='2155'>
<font color=#447700>!       IF(Q(I,K).GT.QES(I,K))Q(I,K)=QES(I,K)<a name='2156'></font>
        TV(I,K)=T(I,K)+.608*Q(I,K)*T(I,K)<a name='2157'>
        endif<a name='2158'>
      enddo<a name='2159'>
      enddo<a name='2160'>
<font color=#447700>!<a name='2161'></font>
<font color=#447700>!--- z's are calculated with changed h's and q's and t's<a name='2162'></font>
<font color=#447700>!--- if itest=2<a name='2163'></font>
<font color=#447700>!<a name='2164'></font>
      if(itest.eq.1 .or. itest.eq.0)then<a name='2165'>
         do i=its,itf<a name='2166'>
           if(ierr(i).eq.0)then<a name='2167'>
             Z(I,1)=max(0.,Z1(I))-(ALOG(P(I,1))- &amp;<a name='2168'>
                 ALOG(PSUR(I)))*287.*TV(I,1)/9.81<a name='2169'>
           endif<a name='2170'>
         enddo<a name='2171'>
<a name='2172'>
<font color=#447700>! --- calculate heights<a name='2173'></font>
         DO K=kts+1,ktf<a name='2174'>
         do i=its,itf<a name='2175'>
           if(ierr(i).eq.0)then<a name='2176'>
              TVBAR=.5*TV(I,K)+.5*TV(I,K-1)<a name='2177'>
              Z(I,K)=Z(I,K-1)-(ALOG(P(I,K))- &amp;<a name='2178'>
               ALOG(P(I,K-1)))*287.*TVBAR/9.81<a name='2179'>
           endif<a name='2180'>
         enddo<a name='2181'>
         enddo<a name='2182'>
      else if(itest.eq.2)then<a name='2183'>
         do k=kts,ktf<a name='2184'>
         do i=its,itf<a name='2185'>
           if(ierr(i).eq.0)then<a name='2186'>
             z(i,k)=(he(i,k)-1004.*t(i,k)-2.5e6*q(i,k))/9.81<a name='2187'>
             z(i,k)=max(1.e-3,z(i,k))<a name='2188'>
           endif<a name='2189'>
         enddo<a name='2190'>
         enddo<a name='2191'>
      else if(itest.eq.-1)then<a name='2192'>
      endif<a name='2193'>
<font color=#447700>!<a name='2194'></font>
<font color=#447700>!--- calculate moist static energy - HE<a name='2195'></font>
<font color=#447700>!    saturated moist static energy - HES<a name='2196'></font>
<font color=#447700>!<a name='2197'></font>
       DO k=kts,ktf<a name='2198'>
       do i=its,itf<a name='2199'>
         if(ierr(i).eq.0)then<a name='2200'>
         if(itest.le.0)HE(I,K)=9.81*Z(I,K)+1004.*T(I,K)+2.5E06*Q(I,K)<a name='2201'>
         HES(I,K)=9.81*Z(I,K)+1004.*T(I,K)+2.5E06*QES(I,K)<a name='2202'>
         IF(HE(I,K).GE.HES(I,K))HE(I,K)=HES(I,K)<a name='2203'>
         endif<a name='2204'>
      enddo<a name='2205'>
      enddo<a name='2206'>
<a name='2207'>
   END SUBROUTINE cup_env<a name='2208'>
<a name='2209'>
<a name='2210'>
<A NAME='CUP_ENV_CLEV'><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV_CLEV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2211'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_env_clev</font>(t,qes,q,he,hes,z,p,qes_cup,q_cup,        &amp; <A href='../../call_to/CUP_ENV_CLEV.html' TARGET='index'>12</A><a name='2212'>
              he_cup,hes_cup,z_cup,p_cup,gamma_cup,t_cup,psur,      &amp;<a name='2213'>
              ierr,z1,                                              &amp;<a name='2214'>
              itf,ktf,                                              &amp;<a name='2215'>
              its,ite, kts,kte                       )<a name='2216'>
<a name='2217'>
   IMPLICIT NONE<a name='2218'>
<a name='2219'>
     integer                                                        &amp;<a name='2220'>
        ,intent (in   )                   ::                        &amp;<a name='2221'>
        itf,ktf,                                                    &amp;<a name='2222'>
        its,ite, kts,kte<a name='2223'>
  <font color=#447700>!<a name='2224'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2225'></font>
  <font color=#447700>! q           = environmental mixing ratio<a name='2226'></font>
  <font color=#447700>! q_cup       = environmental mixing ratio on cloud levels<a name='2227'></font>
  <font color=#447700>! qes         = environmental saturation mixing ratio<a name='2228'></font>
  <font color=#447700>! qes_cup     = environmental saturation mixing ratio on cloud levels<a name='2229'></font>
  <font color=#447700>! t           = environmental temp<a name='2230'></font>
  <font color=#447700>! t_cup       = environmental temp on cloud levels<a name='2231'></font>
  <font color=#447700>! p           = environmental pressure<a name='2232'></font>
  <font color=#447700>! p_cup       = environmental pressure on cloud levels<a name='2233'></font>
  <font color=#447700>! z           = environmental heights<a name='2234'></font>
  <font color=#447700>! z_cup       = environmental heights on cloud levels<a name='2235'></font>
  <font color=#447700>! he          = environmental moist static energy<a name='2236'></font>
  <font color=#447700>! he_cup      = environmental moist static energy on cloud levels<a name='2237'></font>
  <font color=#447700>! hes         = environmental saturation moist static energy<a name='2238'></font>
  <font color=#447700>! hes_cup     = environmental saturation moist static energy on cloud levels<a name='2239'></font>
  <font color=#447700>! gamma_cup   = gamma on cloud levels<a name='2240'></font>
  <font color=#447700>! psur        = surface pressure<a name='2241'></font>
  <font color=#447700>! z1          = terrain elevation<a name='2242'></font>
  <font color=#447700>! <a name='2243'></font>
  <font color=#447700>!<a name='2244'></font>
     real,    dimension (its:ite,kts:kte)                        &amp;<a name='2245'>
        ,intent (in   )                   ::                     &amp;<a name='2246'>
        qes,q,he,hes,z,p,t<a name='2247'>
     real,    dimension (its:ite,kts:kte)                        &amp;<a name='2248'>
        ,intent (out  )                   ::                     &amp;<a name='2249'>
        qes_cup,q_cup,he_cup,hes_cup,z_cup,p_cup,gamma_cup,t_cup<a name='2250'>
     real,    dimension (its:ite)                                &amp;<a name='2251'>
        ,intent (in   )                   ::                     &amp;<a name='2252'>
        psur,z1<a name='2253'>
     integer, dimension (its:ite)                                &amp;<a name='2254'>
        ,intent (inout)                   ::                     &amp;<a name='2255'>
        ierr<a name='2256'>
<font color=#447700>!<a name='2257'></font>
<font color=#447700>!  local variables in this routine<a name='2258'></font>
<font color=#447700>!<a name='2259'></font>
<a name='2260'>
     integer                              ::                     &amp;<a name='2261'>
       i,k<a name='2262'>
<a name='2263'>
<a name='2264'>
      do k=kts,ktf<a name='2265'>
      do i=its,itf<a name='2266'>
        qes_cup(i,k)=0.<a name='2267'>
        q_cup(i,k)=0.<a name='2268'>
        hes_cup(i,k)=0.<a name='2269'>
        he_cup(i,k)=0.<a name='2270'>
        z_cup(i,k)=0.<a name='2271'>
        p_cup(i,k)=0.<a name='2272'>
        t_cup(i,k)=0.<a name='2273'>
        gamma_cup(i,k)=0.<a name='2274'>
      enddo<a name='2275'>
      enddo<a name='2276'>
      do k=kts+1,ktf<a name='2277'>
      do i=its,itf<a name='2278'>
        if(ierr(i).eq.0)then<a name='2279'>
        qes_cup(i,k)=.5*(qes(i,k-1)+qes(i,k))<a name='2280'>
        q_cup(i,k)=.5*(q(i,k-1)+q(i,k))<a name='2281'>
        hes_cup(i,k)=.5*(hes(i,k-1)+hes(i,k))<a name='2282'>
        he_cup(i,k)=.5*(he(i,k-1)+he(i,k))<a name='2283'>
        if(he_cup(i,k).gt.hes_cup(i,k))he_cup(i,k)=hes_cup(i,k)<a name='2284'>
        z_cup(i,k)=.5*(z(i,k-1)+z(i,k))<a name='2285'>
        p_cup(i,k)=.5*(p(i,k-1)+p(i,k))<a name='2286'>
        t_cup(i,k)=.5*(t(i,k-1)+t(i,k))<a name='2287'>
        gamma_cup(i,k)=(xlv/cp)*(xlv/(r_v*t_cup(i,k) &amp;<a name='2288'>
                       *t_cup(i,k)))*qes_cup(i,k)<a name='2289'>
        endif<a name='2290'>
      enddo<a name='2291'>
      enddo<a name='2292'>
      do i=its,itf<a name='2293'>
        if(ierr(i).eq.0)then<a name='2294'>
        qes_cup(i,1)=qes(i,1)<a name='2295'>
        q_cup(i,1)=q(i,1)<a name='2296'>
<font color=#447700>!       hes_cup(i,1)=hes(i,1)<a name='2297'></font>
<font color=#447700>!       he_cup(i,1)=he(i,1)<a name='2298'></font>
        hes_cup(i,1)=9.81*z1(i)+1004.*t(i,1)+2.5e6*qes(i,1)<a name='2299'>
        he_cup(i,1)=9.81*z1(i)+1004.*t(i,1)+2.5e6*q(i,1)<a name='2300'>
        z_cup(i,1)=.5*(z(i,1)+z1(i))<a name='2301'>
        p_cup(i,1)=.5*(p(i,1)+psur(i))<a name='2302'>
        z_cup(i,1)=z1(i)<a name='2303'>
        p_cup(i,1)=psur(i)<a name='2304'>
        t_cup(i,1)=t(i,1)<a name='2305'>
        gamma_cup(i,1)=xlv/cp*(xlv/(r_v*t_cup(i,1) &amp;<a name='2306'>
                       *t_cup(i,1)))*qes_cup(i,1)<a name='2307'>
        endif<a name='2308'>
      enddo<a name='2309'>
<a name='2310'>
   END SUBROUTINE cup_env_clev<a name='2311'>
<a name='2312'>
<A NAME='CUP_FORCING_ENS_3D'><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_FORCING_ENS_3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2313'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_forcing_ens_3d</font>(closure_n,xland,aa0,aa1,xaa0,mbdt,dtime,ierr,ierr2,ierr3,&amp; <A href='../../call_to/CUP_FORCING_ENS_3D.html' TARGET='index'>2</A><a name='2314'>
              xf_ens,axx,forcing,maxens3,mconv,rand_clos,             &amp;<a name='2315'>
              p_cup,ktop,omeg,zd,k22,zu,pr_ens,edt,kbcon,             &amp;<a name='2316'>
              ichoice,                                                &amp;<a name='2317'>
              imid,ipr,itf,ktf,                                       &amp;<a name='2318'>
              its,ite, kts,kte,                                       &amp;<a name='2319'>
              dicycle,tau_ecmwf,aa1_bl,xf_dicycle  )<a name='2320'>
<a name='2321'>
   IMPLICIT NONE<a name='2322'>
<a name='2323'>
     integer                                                          &amp;<a name='2324'>
        ,intent (in   )                   ::                          &amp;<a name='2325'>
        imid,ipr,itf,ktf,                                             &amp;<a name='2326'>
        its,ite, kts,kte<a name='2327'>
     integer, intent (in   )              ::                          &amp;<a name='2328'>
        maxens3<a name='2329'>
  <font color=#447700>!<a name='2330'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2331'></font>
  <font color=#447700>! pr_ens = precipitation ensemble<a name='2332'></font>
  <font color=#447700>! xf_ens = mass flux ensembles<a name='2333'></font>
  <font color=#447700>! massfln = downdraft mass flux ensembles used in next timestep<a name='2334'></font>
  <font color=#447700>! omeg = omega from large scale model<a name='2335'></font>
  <font color=#447700>! mconv = moisture convergence from large scale model<a name='2336'></font>
  <font color=#447700>! zd      = downdraft normalized mass flux<a name='2337'></font>
  <font color=#447700>! zu      = updraft normalized mass flux<a name='2338'></font>
  <font color=#447700>! aa0     = cloud work function without forcing effects<a name='2339'></font>
  <font color=#447700>! aa1     = cloud work function with forcing effects<a name='2340'></font>
  <font color=#447700>! xaa0    = cloud work function with cloud effects (ensemble dependent)<a name='2341'></font>
  <font color=#447700>! edt     = epsilon<a name='2342'></font>
  <font color=#447700>! dir     = "storm motion"<a name='2343'></font>
  <font color=#447700>! mbdt    = arbitrary numerical parameter<a name='2344'></font>
  <font color=#447700>! dtime   = dt over which forcing is applied<a name='2345'></font>
  <font color=#447700>! iact_gr_old = flag to tell where convection was active<a name='2346'></font>
  <font color=#447700>! kbcon       = LFC of parcel from k22<a name='2347'></font>
  <font color=#447700>! k22         = updraft originating level<a name='2348'></font>
  <font color=#447700>! ichoice       = flag if only want one closure (usually set to zero!)<a name='2349'></font>
  <font color=#447700>!<a name='2350'></font>
     real,    dimension (its:ite,1:maxens3)                            &amp;<a name='2351'>
        ,intent (inout)                   ::                           &amp;<a name='2352'>
        pr_ens<a name='2353'>
     real,    dimension (its:ite,1:maxens3)                            &amp;<a name='2354'>
        ,intent (inout  )                 ::                           &amp;<a name='2355'>
        xf_ens<a name='2356'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2357'>
        ,intent (in   )                   ::                           &amp;<a name='2358'>
        zd,zu,p_cup<a name='2359'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2360'>
        ,intent (in   )                   ::                           &amp;<a name='2361'>
        omeg<a name='2362'>
     real,    dimension (its:ite,1)                                    &amp;<a name='2363'>
        ,intent (in   )                   ::                           &amp;<a name='2364'>
        xaa0<a name='2365'>
     real,    dimension (its:ite,4)                                    &amp;<a name='2366'>
        ,intent (in   )                   ::                           &amp;<a name='2367'>
       rand_clos <a name='2368'>
     real,    dimension (its:ite)                                      &amp;<a name='2369'>
        ,intent (in   )                   ::                           &amp;<a name='2370'>
        aa1,edt<a name='2371'>
     real,    dimension (its:ite)                                      &amp;<a name='2372'>
        ,intent (in   )                   ::                           &amp;<a name='2373'>
        mconv,axx<a name='2374'>
     real,    dimension (its:ite)                                      &amp;<a name='2375'>
        ,intent (inout)                   ::                           &amp;<a name='2376'>
        aa0,closure_n<a name='2377'>
     real                                                              &amp;<a name='2378'>
        ,intent (in   )                   ::                           &amp;<a name='2379'>
        mbdt<a name='2380'>
     real                                                              &amp;<a name='2381'>
        ,intent (in   )                   ::                           &amp;<a name='2382'>
        dtime<a name='2383'>
     integer, dimension (its:ite)                                      &amp;<a name='2384'>
        ,intent (inout   )                ::                           &amp;<a name='2385'>
        k22,kbcon,ktop<a name='2386'>
     integer, dimension (its:ite)                                      &amp;<a name='2387'>
        ,intent (in      )                ::                           &amp;<a name='2388'>
        xland<a name='2389'>
     integer, dimension (its:ite)                                      &amp;<a name='2390'>
        ,intent (inout)                   ::                           &amp;<a name='2391'>
        ierr,ierr2,ierr3<a name='2392'>
     integer                                                           &amp;<a name='2393'>
        ,intent (in   )                   ::                           &amp;<a name='2394'>
        ichoice<a name='2395'>
      integer, intent(IN) :: DICYCLE<a name='2396'>
      real,    intent(IN)   , dimension (its:ite) :: aa1_bl,tau_ecmwf<a name='2397'>
      real,    intent(INOUT), dimension (its:ite) :: xf_dicycle<a name='2398'>
      real,    intent(INOUT), dimension (its:ite,10) :: forcing<a name='2399'>
      <font color=#447700>!- local var<a name='2400'></font>
      real  :: xff_dicycle<a name='2401'>
<font color=#447700>!<a name='2402'></font>
<font color=#447700>!  local variables in this routine<a name='2403'></font>
<font color=#447700>!<a name='2404'></font>
<a name='2405'>
     real,    dimension (1:maxens3)       ::                           &amp;<a name='2406'>
       xff_ens3<a name='2407'>
     real,    dimension (1)               ::                           &amp;<a name='2408'>
       xk<a name='2409'>
     integer                              ::                           &amp;<a name='2410'>
       kk,i,k,n,ne<a name='2411'>
<font color=#447700>!     integer, parameter :: mkxcrt=15<a name='2412'></font>
<font color=#447700>!     real,    dimension(1:mkxcrt)        ::                           &amp;<a name='2413'></font>
<font color=#447700>!       pcrit,acrit,acritt<a name='2414'></font>
     integer, dimension (its:ite)         :: kloc<a name='2415'>
     real                                 ::                           &amp;<a name='2416'>
       a1,a_ave,xff0,xomg<font color=#447700>!,aclim1,aclim2,aclim3,aclim4<a name='2417'></font>
<a name='2418'>
     real, dimension (its:ite) :: ens_adj<a name='2419'>
<a name='2420'>
<a name='2421'>
<a name='2422'>
<font color=#447700>!<a name='2423'></font>
       ens_adj(:)=1.<a name='2424'>
       xff_dicycle = 0.<a name='2425'>
<a name='2426'>
<font color=#447700>!--- LARGE SCALE FORCING<a name='2427'></font>
<font color=#447700>!<a name='2428'></font>
       DO 100 i=its,itf<a name='2429'>
          kloc(i)=1<a name='2430'>
          IF(ierr(i).eq.0)then<a name='2431'>
           kloc(i)=maxloc(zu(i,:),1)<a name='2432'>
           ens_adj(i)=1.<a name='2433'>
<font color=#447700>!ss --- comment out adjustment over ocean<a name='2434'></font>
<font color=#447700>!ss           if(ierr2(i).gt.0.and.ierr3(i).eq.0)ens_adj(i)=0.666 ! 2./3.<a name='2435'></font>
<font color=#447700>!ss           if(ierr2(i).gt.0.and.ierr3(i).gt.0)ens_adj(i)=0.333<a name='2436'></font>
<font color=#447700>!<a name='2437'></font>
             a_ave=0.<a name='2438'>
             a_ave=axx(i)<a name='2439'>
             a_ave=max(0.,a_ave)<a name='2440'>
             a_ave=min(a_ave,aa1(i))<a name='2441'>
             a_ave=max(0.,a_ave)<a name='2442'>
             xff_ens3(:)=0.<a name='2443'>
             xff0= (AA1(I)-AA0(I))/DTIME<a name='2444'>
             xff_ens3(1)=max(0.,(AA1(I)-AA0(I))/dtime)<a name='2445'>
             xff_ens3(2)=max(0.,(AA1(I)-AA0(I))/dtime)<a name='2446'>
             xff_ens3(3)=max(0.,(AA1(I)-AA0(I))/dtime)<a name='2447'>
             xff_ens3(16)=max(0.,(AA1(I)-AA0(I))/dtime)<a name='2448'>
             forcing(i,1)=xff_ens3(2)<a name='2449'>
<font color=#447700>!   <a name='2450'></font>
<font color=#447700>!--- omeg is in bar/s, mconv done with omeg in Pa/s<a name='2451'></font>
<font color=#447700>!     more like Brown (1979), or Frank-Cohen (199?)<a name='2452'></font>
<font color=#447700>!  <a name='2453'></font>
<font color=#447700>! average aaround kbcon<a name='2454'></font>
<font color=#447700>!<a name='2455'></font>
             xomg=0.<a name='2456'>
             kk=0<a name='2457'>
             xff_ens3(4)=0.<a name='2458'>
             xff_ens3(5)=0.<a name='2459'>
             xff_ens3(6)=0.<a name='2460'>
             do k=kbcon(i)-1,kbcon(i)+1<a name='2461'>
                     if(zu(i,k).gt.0.)then<a name='2462'>
                       xomg=xomg-omeg(i,k)/9.81/max(0.5,(1.-edt(i)*zd(i,k)/zu(i,k)))<a name='2463'>
                       kk=kk+1<a name='2464'>
                     endif<a name='2465'>
             enddo<a name='2466'>
             if(kk.gt.0)xff_ens3(4)=xomg/float(kk)<a name='2467'>
            <a name='2468'>
<font color=#447700>!<a name='2469'></font>
<font color=#447700>! max below kbcon<a name='2470'></font>
<font color=#447700>!             xff_ens3(6)=-omeg(i,k22(i))/9.81<a name='2471'></font>
<font color=#447700>!             do k=k22(i),kbcon(i)<a name='2472'></font>
<font color=#447700>!                     xomg=-omeg(i,k)/9.81<a name='2473'></font>
<font color=#447700>!                     if(xomg.gt.xff_ens3(6))xff_ens3(6)=xomg<a name='2474'></font>
<font color=#447700>!             enddo<a name='2475'></font>
<font color=#447700>!<a name='2476'></font>
<font color=#447700>!             if(zu(i,kbcon(i)) &gt; 0)xff_ens3(6)=betajb*xff_ens3(6)/zu(i,kbcon(i))<a name='2477'></font>
             xff_ens3(4)=betajb*xff_ens3(4)<a name='2478'>
             xff_ens3(5)=xff_ens3(4)<a name='2479'>
             xff_ens3(6)=xff_ens3(4)<a name='2480'>
             if(xff_ens3(4).lt.0.)xff_ens3(4)=0.<a name='2481'>
             if(xff_ens3(5).lt.0.)xff_ens3(5)=0.<a name='2482'>
             if(xff_ens3(6).lt.0.)xff_ens3(6)=0.<a name='2483'>
             xff_ens3(14)=betajb*xff_ens3(4)<a name='2484'>
             forcing(i,2)=xff_ens3(4)<a name='2485'>
<font color=#447700>!<a name='2486'></font>
<font color=#447700>!--- more like Krishnamurti et al.; pick max and average values<a name='2487'></font>
<font color=#447700>!<a name='2488'></font>
              xff_ens3(7)= mconv(i)/max(0.5,(1.-edt(i)*zd(i,kbcon(i))/zu(i,kloc(i))))<a name='2489'>
              xff_ens3(8)= mconv(i)/max(0.5,(1.-edt(i)*zd(i,kbcon(i))/zu(i,kloc(i))))<a name='2490'>
              xff_ens3(9)= mconv(i)/max(0.5,(1.-edt(i)*zd(i,kbcon(i))/zu(i,kloc(i))))<a name='2491'>
              xff_ens3(15)=mconv(i)/max(0.5,(1.-edt(i)*zd(i,kbcon(i))/zu(i,kloc(i))))<a name='2492'>
             forcing(i,3)=xff_ens3(8)<a name='2493'>
<font color=#447700>!<a name='2494'></font>
<font color=#447700>!--- more like Fritsch Chappel or Kain Fritsch (plus triggers)<a name='2495'></font>
<font color=#447700>!<a name='2496'></font>
             xff_ens3(10)=AA1(i)/tau_ecmwf(i)<a name='2497'>
             xff_ens3(11)=AA1(I)/tau_ecmwf(i)<a name='2498'>
             xff_ens3(12)=AA1(I)/tau_ecmwf(i)<a name='2499'>
             xff_ens3(13)=(AA1(i))/tau_ecmwf(i) <font color=#447700>!(60.*15.) !tau_ecmwf(i)<a name='2500'></font>
<font color=#447700>!             forcing(i,4)=xff_ens3(10)<a name='2501'></font>
<font color=#447700>!- more like Bechtold et al. (JAS 2014)<a name='2502'></font>
             if(dicycle == 1) xff_dicycle = max(0.,AA1_BL(i)/tau_ecmwf(i)) <font color=#447700>!(60.*30.) !tau_ecmwf(i)<a name='2503'></font>
<font color=#447700>!gtest<a name='2504'></font>
             if(ichoice.eq.0)then<a name='2505'>
                if(xff0.lt.0.)then<a name='2506'>
                     xff_ens3(1)=0.<a name='2507'>
                     xff_ens3(2)=0.<a name='2508'>
                     xff_ens3(3)=0.<a name='2509'>
                     xff_ens3(10)=0.<a name='2510'>
                     xff_ens3(11)=0.<a name='2511'>
                     xff_ens3(12)=0.<a name='2512'>
                     xff_ens3(13)= 0.<a name='2513'>
                     xff_ens3(16)= 0.<a name='2514'>
                     closure_n(i)=12.<a name='2515'>
<font color=#447700>!                     xff_dicycle = 0.<a name='2516'></font>
                endif  <font color=#447700>!xff0<a name='2517'></font>
             endif <font color=#447700>! ichoice<a name='2518'></font>
<a name='2519'>
             XK(1)=(XAA0(I,1)-AA1(I))/MBDT<a name='2520'>
             forcing(i,4)=aa0(i)<a name='2521'>
             forcing(i,5)=aa1(i)<a name='2522'>
             forcing(i,6)=xaa0(i,1)<a name='2523'>
             forcing(i,7)=xk(1)<a name='2524'>
             if(xk(1).le.0.and.xk(1).gt.-.01*mbdt) &amp;<a name='2525'>
                           xk(1)=-.01*mbdt<a name='2526'>
             if(xk(1).gt.0.and.xk(1).lt.1.e-2)     &amp;<a name='2527'>
                           xk(1)=1.e-2<a name='2528'>
             <font color=#447700>!   enddo<a name='2529'></font>
<font color=#447700>!<a name='2530'></font>
<font color=#447700>!--- add up all ensembles<a name='2531'></font>
<font color=#447700>!<a name='2532'></font>
<font color=#447700>!<a name='2533'></font>
<font color=#447700>! over water, enfor!e small cap for some of the closures<a name='2534'></font>
<font color=#447700>!<a name='2535'></font>
              if(xland(i).lt.0.1)then<a name='2536'>
                 if(ierr2(i).gt.0.or.ierr3(i).gt.0)then<a name='2537'>
                      xff_ens3(1) =ens_adj(i)*xff_ens3(1)<a name='2538'>
                      xff_ens3(2) =ens_adj(i)*xff_ens3(2)<a name='2539'>
                      xff_ens3(3) =ens_adj(i)*xff_ens3(3)<a name='2540'>
                      xff_ens3(4) =ens_adj(i)*xff_ens3(4)<a name='2541'>
                      xff_ens3(5) =ens_adj(i)*xff_ens3(5)<a name='2542'>
                      xff_ens3(6) =ens_adj(i)*xff_ens3(6)<a name='2543'>
                      xff_ens3(7) =ens_adj(i)*xff_ens3(7)<a name='2544'>
                      xff_ens3(8) =ens_adj(i)*xff_ens3(8)<a name='2545'>
                      xff_ens3(9) =ens_adj(i)*xff_ens3(9)<a name='2546'>
                      xff_ens3(10) =ens_adj(i)*xff_ens3(10)<a name='2547'>
                      xff_ens3(11) =ens_adj(i)*xff_ens3(11)<a name='2548'>
                      xff_ens3(12) =ens_adj(i)*xff_ens3(12)<a name='2549'>
                      xff_ens3(13) =ens_adj(i)*xff_ens3(13)<a name='2550'>
                      xff_ens3(14) =ens_adj(i)*xff_ens3(14)<a name='2551'>
                      xff_ens3(15) =ens_adj(i)*xff_ens3(15)<a name='2552'>
                      xff_ens3(16) =ens_adj(i)*xff_ens3(16)<a name='2553'>
                      <font color=#447700>!srf<a name='2554'></font>
                       xff_dicycle = ens_adj(i)*xff_dicycle<a name='2555'>
                      <font color=#447700>!srf end<a name='2556'></font>
<font color=#447700>!                      xff_ens3(7) =0.<a name='2557'></font>
<font color=#447700>!                      xff_ens3(8) =0.<a name='2558'></font>
<font color=#447700>!                      xff_ens3(9) =0.<a name='2559'></font>
                 endif <font color=#447700>! ierr2<a name='2560'></font>
              endif <font color=#447700>! xland<a name='2561'></font>
<font color=#447700>!<a name='2562'></font>
<font color=#447700>! end water treatment<a name='2563'></font>
<font color=#447700>!<a name='2564'></font>
<font color=#447700>!<a name='2565'></font>
<a name='2566'>
<font color=#447700>!<a name='2567'></font>
<font color=#447700>!--- special treatment for stability closures<a name='2568'></font>
<font color=#447700>!<a name='2569'></font>
              if(XK(1).lt.0.)then<a name='2570'>
                 if(xff_ens3(1).gt.0)xf_ens(i,1)=max(0.,-xff_ens3(1)/xk(1))<a name='2571'>
                 if(xff_ens3(2).gt.0)xf_ens(i,2)=max(0.,-xff_ens3(2)/xk(1))<a name='2572'>
                 if(xff_ens3(3).gt.0)xf_ens(i,3)=max(0.,-xff_ens3(3)/xk(1))<a name='2573'>
                 if(xff_ens3(16).gt.0)xf_ens(i,16)=max(0.,-xff_ens3(16)/xk(1))<a name='2574'>
                 xf_ens(i,1)= xf_ens(i,1)+xf_ens(i,1)*rand_clos(i,1)<a name='2575'>
                 xf_ens(i,2)= xf_ens(i,2)+xf_ens(i,2)*rand_clos(i,1)<a name='2576'>
                 xf_ens(i,3)= xf_ens(i,3)+xf_ens(i,3)*rand_clos(i,1)<a name='2577'>
                 xf_ens(i,16)=xf_ens(i,16)+xf_ens(i,16)*rand_clos(i,1)<a name='2578'>
              else<a name='2579'>
                 xff_ens3(1)= 0<a name='2580'>
                 xff_ens3(2)= 0<a name='2581'>
                 xff_ens3(3)= 0<a name='2582'>
                 xff_ens3(16)=0<a name='2583'>
              endif<a name='2584'>
<font color=#447700>!<a name='2585'></font>
<font color=#447700>!--- if iresult.eq.1, following independent of xff0<a name='2586'></font>
<font color=#447700>!<a name='2587'></font>
              xf_ens(i,4)=max(0.,xff_ens3(4))<a name='2588'>
              xf_ens(i,5)=max(0.,xff_ens3(5))<a name='2589'>
              xf_ens(i,6)=max(0.,xff_ens3(6))<a name='2590'>
              xf_ens(i,14)=max(0.,xff_ens3(14))<a name='2591'>
              a1=max(1.e-5,pr_ens(i,7))<a name='2592'>
              xf_ens(i,7)=max(0.,xff_ens3(7)/a1)<a name='2593'>
              a1=max(1.e-5,pr_ens(i,8))<a name='2594'>
              xf_ens(i,8)=max(0.,xff_ens3(8)/a1)<a name='2595'>
<font color=#447700>!              forcing(i,7)=xf_ens(i,8)<a name='2596'></font>
              a1=max(1.e-5,pr_ens(i,9))<a name='2597'>
              xf_ens(i,9)=max(0.,xff_ens3(9)/a1)<a name='2598'>
              a1=max(1.e-3,pr_ens(i,15))<a name='2599'>
              xf_ens(i,15)=max(0.,xff_ens3(15)/a1)<a name='2600'>
              xf_ens(i,4)=xf_ens(i,4)+xf_ens(i,4)*rand_clos(i,2)<a name='2601'>
              xf_ens(i,5)=xf_ens(i,5)+xf_ens(i,5)*rand_clos(i,2)<a name='2602'>
              xf_ens(i,6)=xf_ens(i,6)+xf_ens(i,6)*rand_clos(i,2)<a name='2603'>
              xf_ens(i,14)=xf_ens(i,14)+xf_ens(i,14)*rand_clos(i,2)<a name='2604'>
              xf_ens(i,7)=xf_ens(i,7)+xf_ens(i,7)*rand_clos(i,3)<a name='2605'>
              xf_ens(i,8)=xf_ens(i,8)+xf_ens(i,8)*rand_clos(i,3)<a name='2606'>
              xf_ens(i,9)=xf_ens(i,9)+xf_ens(i,9)*rand_clos(i,3)<a name='2607'>
              xf_ens(i,15)=xf_ens(i,15)+xf_ens(i,15)*rand_clos(i,3)<a name='2608'>
              if(XK(1).lt.0.)then<a name='2609'>
                 xf_ens(i,10)=max(0.,-xff_ens3(10)/xk(1))<a name='2610'>
                 xf_ens(i,11)=max(0.,-xff_ens3(11)/xk(1))<a name='2611'>
                 xf_ens(i,12)=max(0.,-xff_ens3(12)/xk(1))<a name='2612'>
                 xf_ens(i,13)=max(0.,-xff_ens3(13)/xk(1))<a name='2613'>
                 xf_ens(i,10)=xf_ens(i,10)+xf_ens(i,10)*rand_clos(i,4)<a name='2614'>
                 xf_ens(i,11)=xf_ens(i,11)+xf_ens(i,11)*rand_clos(i,4)<a name='2615'>
                 xf_ens(i,12)=xf_ens(i,12)+xf_ens(i,12)*rand_clos(i,4)<a name='2616'>
                 xf_ens(i,13)=xf_ens(i,13)+xf_ens(i,13)*rand_clos(i,4)<a name='2617'>
                 forcing(i,8)=xf_ens(i,11)<a name='2618'>
              else<a name='2619'>
                 xf_ens(i,10)=0.<a name='2620'>
                 xf_ens(i,11)=0.<a name='2621'>
                 xf_ens(i,12)=0.<a name='2622'>
                 xf_ens(i,13)=0.<a name='2623'>
                 forcing(i,8)=0.<a name='2624'>
              endif<a name='2625'>
<font color=#447700>!srf-begin<a name='2626'></font>
              if(XK(1).lt.0.)then<a name='2627'>
                 xf_dicycle(i)      =  max(0.,-xff_dicycle /xk(1))<a name='2628'>
<font color=#447700>!                forcing(i,9)=xf_dicycle(i)<a name='2629'></font>
              else<a name='2630'>
                 xf_dicycle(i)      = 0.<a name='2631'>
              endif<a name='2632'>
<font color=#447700>!srf-end<a name='2633'></font>
              if(ichoice.ge.1)then<a name='2634'>
<font color=#447700>!                 closure_n(i)=0.<a name='2635'></font>
                 xf_ens(i,1)=xf_ens(i,ichoice)<a name='2636'>
                 xf_ens(i,2)=xf_ens(i,ichoice)<a name='2637'>
                 xf_ens(i,3)=xf_ens(i,ichoice)<a name='2638'>
                 xf_ens(i,4)=xf_ens(i,ichoice)<a name='2639'>
                 xf_ens(i,5)=xf_ens(i,ichoice)<a name='2640'>
                 xf_ens(i,6)=xf_ens(i,ichoice)<a name='2641'>
                 xf_ens(i,7)=xf_ens(i,ichoice)<a name='2642'>
                 xf_ens(i,8)=xf_ens(i,ichoice)<a name='2643'>
                 xf_ens(i,9)=xf_ens(i,ichoice)<a name='2644'>
                 xf_ens(i,10)=xf_ens(i,ichoice)<a name='2645'>
                 xf_ens(i,11)=xf_ens(i,ichoice)<a name='2646'>
                 xf_ens(i,12)=xf_ens(i,ichoice)<a name='2647'>
                 xf_ens(i,13)=xf_ens(i,ichoice)<a name='2648'>
                 xf_ens(i,14)=xf_ens(i,ichoice)<a name='2649'>
                 xf_ens(i,15)=xf_ens(i,ichoice)<a name='2650'>
                 xf_ens(i,16)=xf_ens(i,ichoice)<a name='2651'>
              endif<a name='2652'>
          elseif(ierr(i).ne.20.and.ierr(i).ne.0)then<a name='2653'>
              do n=1,maxens3<a name='2654'>
                 xf_ens(i,n)=0.<a name='2655'>
                 xf_dicycle(i) = 0.<a name='2656'>
             enddo<a name='2657'>
          endif <font color=#447700>! ierror<a name='2658'></font>
 100   continue<a name='2659'>
<a name='2660'>
   END SUBROUTINE cup_forcing_ens_3d<a name='2661'>
<a name='2662'>
<A NAME='CUP_KBCON'><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_KBCON' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2663'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_kbcon</font>(ierrc,cap_inc,iloop_in,k22,kbcon,he_cup,hes_cup, &amp; <A href='../../call_to/CUP_KBCON.html' TARGET='index'>9</A>,<A href='../../call_from/CUP_KBCON.html' TARGET='index'>1</A><a name='2664'>
              hkb,ierr,kbmax,p_cup,cap_max,                              &amp;<a name='2665'>
              ztexec,zqexec,                                             &amp;<a name='2666'>
              jprnt,itf,ktf,                                             &amp;<a name='2667'>
              its,ite, kts,kte,                                          &amp;<a name='2668'>
              z_cup,entr_rate,heo,imid                        )<a name='2669'>
<a name='2670'>
   IMPLICIT NONE<a name='2671'>
<font color=#447700>!<a name='2672'></font>
<a name='2673'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='2674'></font>
<a name='2675'>
     integer                                                           &amp;<a name='2676'>
        ,intent (in   )                   ::                           &amp;<a name='2677'>
        jprnt,itf,ktf,imid,                                            &amp;<a name='2678'>
        its,ite, kts,kte<a name='2679'>
  <font color=#447700>! <a name='2680'></font>
  <font color=#447700>! <a name='2681'></font>
  <font color=#447700>! <a name='2682'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2683'></font>
  <font color=#447700>!<a name='2684'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2685'>
        ,intent (in   )                   ::                           &amp;<a name='2686'>
        he_cup,hes_cup,p_cup<a name='2687'>
     real,    dimension (its:ite)                                      &amp;<a name='2688'>
        ,intent (in   )                   ::                           &amp;<a name='2689'>
        entr_rate,ztexec,zqexec,cap_inc,cap_max<a name='2690'>
     real,    dimension (its:ite)                                      &amp;<a name='2691'>
        ,intent (inout   )                   ::                        &amp;<a name='2692'>
        hkb <font color=#447700>!,cap_max<a name='2693'></font>
     integer, dimension (its:ite)                                      &amp;<a name='2694'>
        ,intent (in   )                   ::                           &amp;<a name='2695'>
        kbmax<a name='2696'>
     integer, dimension (its:ite)                                      &amp;<a name='2697'>
        ,intent (inout)                   ::                           &amp;<a name='2698'>
        kbcon,k22,ierr<a name='2699'>
     integer                                                           &amp;<a name='2700'>
        ,intent (in   )                   ::                           &amp;<a name='2701'>
        iloop_in<a name='2702'>
     character*50 :: ierrc(its:ite)<a name='2703'>
     real, dimension (its:ite,kts:kte),intent (in) :: z_cup,heo<a name='2704'>
     integer, dimension (its:ite)      ::     iloop,start_level<a name='2705'>
<font color=#447700>!<a name='2706'></font>
<font color=#447700>!  local variables in this routine<a name='2707'></font>
<font color=#447700>!<a name='2708'></font>
<a name='2709'>
     integer                              ::                           &amp;<a name='2710'>
        i,k<a name='2711'>
     real                                 ::                           &amp;<a name='2712'>
        x_add,pbcdif,plus,hetest,dz<a name='2713'>
     real, dimension (its:ite,kts:kte) ::hcot<a name='2714'>
<font color=#447700>!<a name='2715'></font>
<font color=#447700>!--- DETERMINE THE LEVEL OF CONVECTIVE CLOUD BASE  - KBCON<a name='2716'></font>
<font color=#447700>!<a name='2717'></font>
      iloop(:)=iloop_in<a name='2718'>
       DO 27 i=its,itf<a name='2719'>
      kbcon(i)=1<a name='2720'>
<font color=#447700>!<a name='2721'></font>
<font color=#447700>! reset iloop for mid level convection<a name='2722'></font>
      if(cap_max(i).gt.200 .and. imid.eq.1)iloop(i)=5<a name='2723'>
<font color=#447700>!<a name='2724'></font>
      IF(ierr(I).ne.0)GO TO 27<a name='2725'>
      start_level(i)=k22(i)<a name='2726'>
      KBCON(I)=K22(I)+1<a name='2727'>
      if(iloop(i).eq.5)KBCON(I)=K22(I)<a name='2728'>
<font color=#447700>!      if(iloop_in.eq.5)start_level(i)=kbcon(i)<a name='2729'></font>
       <font color=#447700>!== including entrainment for hetest<a name='2730'></font>
        hcot(i,1:start_level(i)) = HKB(I)<a name='2731'>
        do k=start_level(i)+1,KBMAX(i)+3<a name='2732'>
           dz=z_cup(i,k)-z_cup(i,k-1)<a name='2733'>
           hcot(i,k)= ( (1.-0.5*entr_rate(i)*dz)*hcot(i,k-1)   &amp;<a name='2734'>
                         + entr_rate(i)*dz*heo(i,k-1)       )/ &amp;<a name='2735'>
                      (1.+0.5*entr_rate(i)*dz)<a name='2736'>
        enddo<a name='2737'>
       <font color=#447700>!==<a name='2738'></font>
<a name='2739'>
      GO TO 32<a name='2740'>
 31   CONTINUE<a name='2741'>
      KBCON(I)=KBCON(I)+1<a name='2742'>
      IF(KBCON(I).GT.KBMAX(i)+2)THEN<a name='2743'>
         if(iloop(i).ne.4)then<a name='2744'>
                ierr(i)=3<a name='2745'>
                ierrc(i)="could not find reasonable kbcon in cup_kbcon"<a name='2746'>
         endif<a name='2747'>
        GO TO 27<a name='2748'>
      ENDIF<a name='2749'>
 32   CONTINUE<a name='2750'>
      hetest=hcot(i,kbcon(i)) <font color=#447700>!hkb(i) ! HE_cup(I,K22(I))<a name='2751'></font>
      IF(HETEST.LT.HES_cup(I,KBCON(I)))then<a name='2752'>
        GO TO 31<a name='2753'>
      endif<a name='2754'>
<a name='2755'>
<font color=#447700>!     cloud base pressure and max moist static energy pressure<a name='2756'></font>
<font color=#447700>!     i.e., the depth (in mb) of the layer of negative buoyancy<a name='2757'></font>
      if(KBCON(I)-K22(I).eq.1)go to 27<a name='2758'>
      if(iloop(i).eq.5 .and. (KBCON(I)-K22(I)).le.2)go to 27<a name='2759'>
      PBCDIF=-P_cup(I,KBCON(I))+P_cup(I,K22(I))<a name='2760'>
      plus=max(25.,cap_max(i)-float(iloop(i)-1)*cap_inc(i))<a name='2761'>
      if(iloop(i).eq.4)plus=cap_max(i)<a name='2762'>
<font color=#447700>!<a name='2763'></font>
<font color=#447700>! for shallow convection, if cap_max is greater than 25, it is the pressure at pbltop<a name='2764'></font>
      if(iloop(i).eq.5)plus=150.<a name='2765'>
        if(iloop(i).eq.5.and.cap_max(i).gt.200)pbcdif=-P_cup(I,KBCON(I))+cap_max(i)<a name='2766'>
      IF(PBCDIF.le.plus)THEN<a name='2767'>
        Go To 27<a name='2768'>
      ElseIF(PBCDIF.GT.plus)THEN<a name='2769'>
        K22(I)=K22(I)+1<a name='2770'>
        KBCON(I)=K22(I)+1<a name='2771'>
<font color=#447700>!==     since k22 has be changed, HKB has to be re-calculated<a name='2772'></font>
        x_add = xlv*zqexec(i)+cp*ztexec(i)<a name='2773'>
        call <A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_CLOUD_BC'>get_cloud_bc</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_KBCON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CLOUD_BC_5">(kte,he_cup (i,1:kte),hkb (i),k22(i),x_add)<a name='2774'>
<a name='2775'>
        start_level(i)=k22(i)<a name='2776'>
<font color=#447700>!        if(iloop_in.eq.5)start_level(i)=kbcon(i)<a name='2777'></font>
        hcot(i,1:start_level(i)) = hkb(I)<a name='2778'>
        do k=start_level(i)+1,KBMAX(i)+3<a name='2779'>
           dz=z_cup(i,k)-z_cup(i,k-1)<a name='2780'>
<a name='2781'>
           hcot(i,k)= ( (1.-0.5*entr_rate(i)*dz)*hcot(i,k-1)   &amp;<a name='2782'>
                         + entr_rate(i)*dz*heo(i,k-1)       )/ &amp;<a name='2783'>
                      (1.+0.5*entr_rate(i)*dz)<a name='2784'>
        enddo<a name='2785'>
       <font color=#447700>!==<a name='2786'></font>
<a name='2787'>
        if(iloop(i).eq.5)KBCON(I)=K22(I)<a name='2788'>
        IF(KBCON(I).GT.KBMAX(i)+2)THEN<a name='2789'>
            if(iloop(i).ne.4)then<a name='2790'>
                ierr(i)=3<a name='2791'>
                ierrc(i)="could not find reasonable kbcon in cup_kbcon"<a name='2792'>
            endif<a name='2793'>
            GO TO 27<a name='2794'>
        ENDIF<a name='2795'>
        GO TO 32<a name='2796'>
      ENDIF<a name='2797'>
 27   CONTINUE<a name='2798'>
<a name='2799'>
   END SUBROUTINE cup_kbcon<a name='2800'>
<a name='2801'>
<a name='2802'>
<A NAME='CUP_MAXIMI'><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_MAXIMI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2803'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_MAXIMI</font>(ARRAY,KS,KE,MAXX,ierr,              &amp; <A href='../../call_to/CUP_MAXIMI.html' TARGET='index'>5</A><a name='2804'>
              itf,ktf,                                       &amp;<a name='2805'>
              its,ite, kts,kte                     )<a name='2806'>
<a name='2807'>
   IMPLICIT NONE<a name='2808'>
<font color=#447700>!<a name='2809'></font>
<font color=#447700>!  on input<a name='2810'></font>
<font color=#447700>!<a name='2811'></font>
<a name='2812'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='2813'></font>
<a name='2814'>
     integer                                                           &amp;<a name='2815'>
        ,intent (in   )                   ::                           &amp;<a name='2816'>
         itf,ktf,                                                      &amp;<a name='2817'>
         its,ite, kts,kte<a name='2818'>
  <font color=#447700>! array input array<a name='2819'></font>
  <font color=#447700>! x output array with return values<a name='2820'></font>
  <font color=#447700>! kt output array of levels<a name='2821'></font>
  <font color=#447700>! ks,kend  check-range<a name='2822'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2823'>
        ,intent (in   )                   ::                           &amp;<a name='2824'>
         array<a name='2825'>
     integer, dimension (its:ite)                                      &amp;<a name='2826'>
        ,intent (in   )                   ::                           &amp;<a name='2827'>
         ierr,ke<a name='2828'>
     integer                                                           &amp;<a name='2829'>
        ,intent (in   )                   ::                           &amp;<a name='2830'>
         ks<a name='2831'>
     integer, dimension (its:ite)                                      &amp;<a name='2832'>
        ,intent (out  )                   ::                           &amp;<a name='2833'>
         maxx<a name='2834'>
     real,    dimension (its:ite)         ::                           &amp;<a name='2835'>
         x<a name='2836'>
     real                                 ::                           &amp;<a name='2837'>
         xar<a name='2838'>
     integer                              ::                           &amp;<a name='2839'>
         i,k<a name='2840'>
<a name='2841'>
       DO 200 i=its,itf<a name='2842'>
       MAXX(I)=KS<a name='2843'>
       if(ierr(i).eq.0)then<a name='2844'>
      X(I)=ARRAY(I,KS)<a name='2845'>
<font color=#447700>!<a name='2846'></font>
       DO 100 K=KS,KE(i)<a name='2847'>
         XAR=ARRAY(I,K)<a name='2848'>
         IF(XAR.GE.X(I)) THEN<a name='2849'>
            X(I)=XAR<a name='2850'>
            MAXX(I)=K<a name='2851'>
         ENDIF<a name='2852'>
 100  CONTINUE<a name='2853'>
      endif<a name='2854'>
 200  CONTINUE<a name='2855'>
<a name='2856'>
   END SUBROUTINE cup_MAXIMI<a name='2857'>
<a name='2858'>
<a name='2859'>
<A NAME='CUP_MINIMI'><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_MINIMI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2860'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_minimi</font>(ARRAY,KS,KEND,KT,ierr,              &amp; <A href='../../call_to/CUP_MINIMI.html' TARGET='index'>6</A><a name='2861'>
              itf,ktf,                                       &amp;<a name='2862'>
              its,ite, kts,kte                     )<a name='2863'>
<a name='2864'>
   IMPLICIT NONE<a name='2865'>
<font color=#447700>!<a name='2866'></font>
<font color=#447700>!  on input<a name='2867'></font>
<font color=#447700>!<a name='2868'></font>
<a name='2869'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='2870'></font>
<a name='2871'>
     integer                                                 &amp;<a name='2872'>
        ,intent (in   )                   ::                 &amp;<a name='2873'>
         itf,ktf,                                            &amp;<a name='2874'>
         its,ite, kts,kte<a name='2875'>
  <font color=#447700>! array input array<a name='2876'></font>
  <font color=#447700>! x output array with return values<a name='2877'></font>
  <font color=#447700>! kt output array of levels<a name='2878'></font>
  <font color=#447700>! ks,kend  check-range<a name='2879'></font>
     real,    dimension (its:ite,kts:kte)                    &amp;<a name='2880'>
        ,intent (in   )                   ::                 &amp;<a name='2881'>
         array<a name='2882'>
     integer, dimension (its:ite)                            &amp;<a name='2883'>
        ,intent (in   )                   ::                 &amp;<a name='2884'>
         ierr,ks,kend<a name='2885'>
     integer, dimension (its:ite)                            &amp;<a name='2886'>
        ,intent (out  )                   ::                 &amp;<a name='2887'>
         kt<a name='2888'>
     real,    dimension (its:ite)         ::                 &amp;<a name='2889'>
         x<a name='2890'>
     integer                              ::                 &amp;<a name='2891'>
         i,k,kstop<a name='2892'>
<a name='2893'>
       DO 200 i=its,itf<a name='2894'>
      KT(I)=KS(I)<a name='2895'>
      if(ierr(i).eq.0)then<a name='2896'>
      X(I)=ARRAY(I,KS(I))<a name='2897'>
       KSTOP=MAX(KS(I)+1,KEND(I))<a name='2898'>
<font color=#447700>!<a name='2899'></font>
       DO 100 K=KS(I)+1,KSTOP<a name='2900'>
         IF(ARRAY(I,K).LT.X(I)) THEN<a name='2901'>
              X(I)=ARRAY(I,K)<a name='2902'>
              KT(I)=K<a name='2903'>
         ENDIF<a name='2904'>
 100  CONTINUE<a name='2905'>
      endif<a name='2906'>
 200  CONTINUE<a name='2907'>
<a name='2908'>
   END SUBROUTINE cup_MINIMI<a name='2909'>
<a name='2910'>
<a name='2911'>
<A NAME='CUP_UP_AA0'><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_AA0' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2912'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_up_aa0</font>(aa0,z,zu,dby,GAMMA_CUP,t_cup,       &amp; <A href='../../call_to/CUP_UP_AA0.html' TARGET='index'>14</A><a name='2913'>
              kbcon,ktop,ierr,                               &amp;<a name='2914'>
              itf,ktf,                                       &amp;<a name='2915'>
              its,ite, kts,kte                     )<a name='2916'>
<a name='2917'>
   IMPLICIT NONE<a name='2918'>
<font color=#447700>!<a name='2919'></font>
<font color=#447700>!  on input<a name='2920'></font>
<font color=#447700>!<a name='2921'></font>
<a name='2922'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='2923'></font>
<a name='2924'>
     integer                                                 &amp;<a name='2925'>
        ,intent (in   )                   ::                 &amp;<a name='2926'>
        itf,ktf,                                             &amp;<a name='2927'>
        its,ite, kts,kte<a name='2928'>
  <font color=#447700>! aa0 cloud work function<a name='2929'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='2930'></font>
  <font color=#447700>! t_cup = temperature (Kelvin) on model cloud levels<a name='2931'></font>
  <font color=#447700>! dby = buoancy term<a name='2932'></font>
  <font color=#447700>! zu= normalized updraft mass flux<a name='2933'></font>
  <font color=#447700>! z = heights of model levels <a name='2934'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2935'></font>
  <font color=#447700>!<a name='2936'></font>
     real,    dimension (its:ite,kts:kte)                     &amp;<a name='2937'>
        ,intent (in   )                   ::                  &amp;<a name='2938'>
        z,zu,gamma_cup,t_cup,dby<a name='2939'>
     integer, dimension (its:ite)                             &amp;<a name='2940'>
        ,intent (in   )                   ::                  &amp;<a name='2941'>
        kbcon,ktop<a name='2942'>
<font color=#447700>!<a name='2943'></font>
<font color=#447700>! input and output<a name='2944'></font>
<font color=#447700>!<a name='2945'></font>
<a name='2946'>
<a name='2947'>
     integer, dimension (its:ite)                             &amp;<a name='2948'>
        ,intent (inout)                   ::                  &amp;<a name='2949'>
        ierr<a name='2950'>
     real,    dimension (its:ite)                             &amp;<a name='2951'>
        ,intent (out  )                   ::                  &amp;<a name='2952'>
        aa0<a name='2953'>
<font color=#447700>!<a name='2954'></font>
<font color=#447700>!  local variables in this routine<a name='2955'></font>
<font color=#447700>!<a name='2956'></font>
<a name='2957'>
     integer                              ::                  &amp;<a name='2958'>
        i,k<a name='2959'>
     real                                 ::                  &amp;<a name='2960'>
        dz,da<a name='2961'>
<font color=#447700>!<a name='2962'></font>
        do i=its,itf<a name='2963'>
         aa0(i)=0.<a name='2964'>
        enddo<a name='2965'>
        DO 100 k=kts+1,ktf<a name='2966'>
        DO 100 i=its,itf<a name='2967'>
         IF(ierr(i).ne.0)GO TO 100<a name='2968'>
         IF(K.LT.KBCON(I))GO TO 100<a name='2969'>
         IF(K.Gt.KTOP(I))GO TO 100<a name='2970'>
         DZ=Z(I,K)-Z(I,K-1)<a name='2971'>
         da=zu(i,k)*DZ*(9.81/(1004.*( &amp;<a name='2972'>
                (T_cup(I,K)))))*DBY(I,K-1)/ &amp;<a name='2973'>
             (1.+GAMMA_CUP(I,K))<a name='2974'>
<font color=#447700>!         IF(K.eq.KTOP(I).and.da.le.0.)go to 100<a name='2975'></font>
         AA0(I)=AA0(I)+max(0.,da)<a name='2976'>
         if(aa0(i).lt.0.)aa0(i)=0.<a name='2977'>
100     continue<a name='2978'>
<a name='2979'>
   END SUBROUTINE cup_up_aa0<a name='2980'>
<a name='2981'>
<font color=#447700>!====================================================================<a name='2982'></font>
<A NAME='NEG_CHECK'><A href='../../html_code/phys/module_cu_gf_deep.F.html#NEG_CHECK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2983'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>neg_check</font>(name,j,dt,q,outq,outt,outu,outv,                      &amp; <A href='../../call_to/NEG_CHECK.html' TARGET='index'>3</A><a name='2984'>
                                    outqc,pret,its,ite,kts,kte,itf,ktf)<a name='2985'>
<a name='2986'>
   INTEGER,      INTENT(IN   ) ::            j,its,ite,kts,kte,itf,ktf<a name='2987'>
<a name='2988'>
     real, dimension (its:ite,kts:kte  )                    ,                 &amp;<a name='2989'>
      intent(inout   ) ::                                                     &amp;<a name='2990'>
       outq,outt,outqc,outu,outv<a name='2991'>
     real, dimension (its:ite,kts:kte  )                    ,                 &amp;<a name='2992'>
      intent(inout   ) ::                                                     &amp;<a name='2993'>
       q<a name='2994'>
     real, dimension (its:ite  )                            ,                 &amp;<a name='2995'>
      intent(inout   ) ::                                                     &amp;<a name='2996'>
       pret<a name='2997'>
      character *(*), intent (in)         ::                                  &amp;<a name='2998'>
       name<a name='2999'>
     real                                                                     &amp;<a name='3000'>
        ,intent (in  )                   ::                                   &amp;<a name='3001'>
        dt<a name='3002'>
     real :: names,scalef,thresh,qmem,qmemf,qmem2,qtest,qmem1<a name='3003'>
     integer :: icheck<a name='3004'>
<font color=#447700>!<a name='3005'></font>
<font color=#447700>! first do check on vertical heating rate<a name='3006'></font>
<font color=#447700>!<a name='3007'></font>
      thresh=300.01<a name='3008'>
<font color=#447700>!      thresh=200.01        !ss<a name='3009'></font>
<font color=#447700>!      thresh=250.01<a name='3010'></font>
      names=1.<a name='3011'>
      if(name == 'shallow')then<a name='3012'>
        thresh=148.01<a name='3013'>
        names=2.<a name='3014'>
      endif<a name='3015'>
      scalef=86400.<a name='3016'>
      do i=its,itf<a name='3017'>
      icheck=0<a name='3018'>
      qmemf=1.<a name='3019'>
      qmem=0.<a name='3020'>
      do k=kts,ktf<a name='3021'>
         qmem=(outt(i,k))*86400.<a name='3022'>
         if(qmem.gt.thresh)then<a name='3023'>
           qmem2=thresh/qmem<a name='3024'>
           qmemf=min(qmemf,qmem2)<a name='3025'>
      icheck=1<a name='3026'>
<font color=#447700>!<a name='3027'></font>
<font color=#447700>!<a name='3028'></font>
<font color=#447700>!          print *,'1',' adjusted massflux by factor ',i,j,k,qmem,qmem2,qmemf,dt<a name='3029'></font>
         endif<a name='3030'>
         if(qmem.lt.-.5*thresh*names)then<a name='3031'>
           qmem2=-.5*names*thresh/qmem<a name='3032'>
           qmemf=min(qmemf,qmem2)<a name='3033'>
      icheck=2<a name='3034'>
<font color=#447700>!<a name='3035'></font>
<font color=#447700>!<a name='3036'></font>
         endif<a name='3037'>
      enddo<a name='3038'>
      do k=kts,ktf<a name='3039'>
         outq(i,k)=outq(i,k)*qmemf<a name='3040'>
         outt(i,k)=outt(i,k)*qmemf<a name='3041'>
         outu(i,k)=outu(i,k)*qmemf<a name='3042'>
         outv(i,k)=outv(i,k)*qmemf<a name='3043'>
         outqc(i,k)=outqc(i,k)*qmemf<a name='3044'>
      enddo<a name='3045'>
      pret(i)=pret(i)*qmemf <a name='3046'>
      enddo<a name='3047'>
      return<a name='3048'>
<font color=#447700>!<a name='3049'></font>
<font color=#447700>! check whether routine produces negative q's. This can happen, since <a name='3050'></font>
<font color=#447700>! tendencies are calculated based on forced q's. This should have no<a name='3051'></font>
<font color=#447700>! influence on conservation properties, it scales linear through all<a name='3052'></font>
<font color=#447700>! tendencies<a name='3053'></font>
<font color=#447700>!<a name='3054'></font>
<font color=#447700>!      return<a name='3055'></font>
<font color=#447700>!      write(14,*)'return'<a name='3056'></font>
      thresh=1.e-16<a name='3057'>
      do i=its,itf<a name='3058'>
      qmemf=1.<a name='3059'>
      do k=kts,ktf-1<a name='3060'>
         qmem=outq(i,k)<a name='3061'>
         if(abs(qmem).gt.0. .and. q(i,k).gt.1.e-6)then<a name='3062'>
         qtest=q(i,k)+(outq(i,k))*dt<a name='3063'>
         if(qtest.lt.thresh)then<a name='3064'>
<font color=#447700>!<a name='3065'></font>
<font color=#447700>! qmem2 would be the maximum allowable tendency<a name='3066'></font>
<font color=#447700>!<a name='3067'></font>
           qmem1=abs(outq(i,k))<a name='3068'>
           qmem2=abs((thresh-q(i,k))/dt)<a name='3069'>
           qmemf=min(qmemf,qmem2/qmem1)<a name='3070'>
           qmemf=max(0.,qmemf)<a name='3071'>
         endif<a name='3072'>
         endif<a name='3073'>
      enddo<a name='3074'>
      do k=kts,ktf<a name='3075'>
         outq(i,k)=outq(i,k)*qmemf<a name='3076'>
         outt(i,k)=outt(i,k)*qmemf<a name='3077'>
         outu(i,k)=outu(i,k)*qmemf<a name='3078'>
         outv(i,k)=outv(i,k)*qmemf<a name='3079'>
         outqc(i,k)=outqc(i,k)*qmemf<a name='3080'>
      enddo<a name='3081'>
      pret(i)=pret(i)*qmemf <a name='3082'>
      enddo<a name='3083'>
<a name='3084'>
   END SUBROUTINE neg_check<a name='3085'>
<a name='3086'>
<a name='3087'>
<A NAME='CUP_OUTPUT_ENS_3D'><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_OUTPUT_ENS_3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3088'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_output_ens_3d</font>(xff_mid,xf_ens,ierr,dellat,dellaq,dellaqc,  &amp; <A href='../../call_to/CUP_OUTPUT_ENS_3D.html' TARGET='index'>2</A>,<A href='../../call_from/CUP_OUTPUT_ENS_3D.html' TARGET='index'>2</A><a name='3089'>
              outtem,outq,outqc,                                            &amp;<a name='3090'>
              zu,pre,pw,xmb,ktop,                                           &amp;<a name='3091'>
              edt,pwd,name,ierr2,ierr3,p_cup,pr_ens,                        &amp;<a name='3092'>
              maxens3,                                                      &amp;<a name='3093'>
              sig,closure_n,xland1,xmbm_in,xmbs_in,                         &amp;<a name='3094'>
              ichoice,imid,ipr,itf,ktf,                                     &amp;<a name='3095'>
              its,ite, kts,kte,                                             &amp;<a name='3096'>
              dicycle,xf_dicycle )<a name='3097'>
<a name='3098'>
   IMPLICIT NONE<a name='3099'>
<font color=#447700>!<a name='3100'></font>
<font color=#447700>!  on input<a name='3101'></font>
<font color=#447700>!<a name='3102'></font>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3103'></font>
<a name='3104'>
     integer                                                           &amp;<a name='3105'>
        ,intent (in   )                   ::                           &amp;<a name='3106'>
        ichoice,imid,ipr,itf,ktf,                                      &amp;<a name='3107'>
        its,ite, kts,kte<a name='3108'>
     integer, intent (in   )              ::                           &amp;<a name='3109'>
        maxens3<a name='3110'>
  <font color=#447700>! xf_ens = ensemble mass fluxes<a name='3111'></font>
  <font color=#447700>! pr_ens = precipitation ensembles<a name='3112'></font>
  <font color=#447700>! dellat = change of temperature per unit mass flux of cloud ensemble<a name='3113'></font>
  <font color=#447700>! dellaq = change of q per unit mass flux of cloud ensemble<a name='3114'></font>
  <font color=#447700>! dellaqc = change of qc per unit mass flux of cloud ensemble<a name='3115'></font>
  <font color=#447700>! outtem = output temp tendency (per s)<a name='3116'></font>
  <font color=#447700>! outq   = output q tendency (per s)<a name='3117'></font>
  <font color=#447700>! outqc  = output qc tendency (per s)<a name='3118'></font>
  <font color=#447700>! pre    = output precip<a name='3119'></font>
  <font color=#447700>! xmb    = total base mass flux<a name='3120'></font>
  <font color=#447700>! xfac1  = correction factor<a name='3121'></font>
  <font color=#447700>! pw = pw -epsilon*pd (ensemble dependent)<a name='3122'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='3123'></font>
  <font color=#447700>!<a name='3124'></font>
     real,    dimension (its:ite,1:maxens3)                            &amp;<a name='3125'>
        ,intent (inout)                   ::                           &amp;<a name='3126'>
       xf_ens,pr_ens<a name='3127'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3128'>
        ,intent (inout  )                 ::                           &amp;<a name='3129'>
        outtem,outq,outqc<a name='3130'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3131'>
        ,intent (in  )                    ::                           &amp;<a name='3132'>
        zu,pwd,p_cup<a name='3133'>
     real,   dimension (its:ite)                                       &amp;<a name='3134'>
         ,intent (in  )                   ::                           &amp;<a name='3135'>
        sig,xmbm_in,xmbs_in,edt<a name='3136'>
     real,   dimension (its:ite,2)                                     &amp;<a name='3137'>
         ,intent (in  )                   ::                           &amp;<a name='3138'>
        xff_mid<a name='3139'>
     real,    dimension (its:ite)                                      &amp;<a name='3140'>
        ,intent (inout  )                 ::                           &amp;<a name='3141'>
        pre,xmb<a name='3142'>
     real,    dimension (its:ite)                                      &amp;<a name='3143'>
        ,intent (inout  )                 ::                           &amp;<a name='3144'>
        closure_n<a name='3145'>
     real,    dimension (its:ite,kts:kte,1)                            &amp;<a name='3146'>
        ,intent (in   )                   ::                           &amp;<a name='3147'>
       dellat,dellaqc,dellaq,pw<a name='3148'>
     integer, dimension (its:ite)                                      &amp;<a name='3149'>
        ,intent (in   )                   ::                           &amp;<a name='3150'>
        ktop,xland1<a name='3151'>
     integer, dimension (its:ite)                                      &amp;<a name='3152'>
        ,intent (inout)                   ::                           &amp;<a name='3153'>
        ierr,ierr2,ierr3<a name='3154'>
     integer, intent(IN) :: DICYCLE<a name='3155'>
     real,    intent(IN), dimension (its:ite) :: xf_dicycle<a name='3156'>
<font color=#447700>!<a name='3157'></font>
<font color=#447700>!  local variables in this routine<a name='3158'></font>
<font color=#447700>!<a name='3159'></font>
<a name='3160'>
     integer                              ::                           &amp;<a name='3161'>
        i,k,n<a name='3162'>
     real                                 ::                           &amp;<a name='3163'>
        clos_wei,dtt,dp,dtq,dtqc,dtpw,dtpwd<a name='3164'>
     real,    dimension (its:ite)         ::                           &amp;<a name='3165'>
       xmb_ave,pwtot<a name='3166'>
<font color=#447700>!<a name='3167'></font>
      character *(*), intent (in)         ::                           &amp;<a name='3168'>
       name<a name='3169'>
<a name='3170'>
<font color=#447700>!<a name='3171'></font>
      DO k=kts,kte<a name='3172'>
      do i=its,ite<a name='3173'>
        outtem (i,k)=0.<a name='3174'>
        outq   (i,k)=0.<a name='3175'>
        outqc  (i,k)=0.<a name='3176'>
      enddo<a name='3177'>
      enddo<a name='3178'>
      do i=its,itf<a name='3179'>
        pre(i)=0.<a name='3180'>
        xmb(i)=0.<a name='3181'>
      enddo<a name='3182'>
      do i=its,itf<a name='3183'>
        IF(ierr(i).eq.0)then<a name='3184'>
        do n=1,maxens3<a name='3185'>
           if(pr_ens(i,n).le.0.)then<a name='3186'>
             xf_ens(i,n)=0.<a name='3187'>
           endif<a name='3188'>
        enddo<a name='3189'>
        endif<a name='3190'>
      enddo<a name='3191'>
<font color=#447700>!<a name='3192'></font>
<font color=#447700>!--- calculate ensemble average mass fluxes<a name='3193'></font>
<font color=#447700>!<a name='3194'></font>
       <a name='3195'>
<font color=#447700>!<a name='3196'></font>
<font color=#447700>!-- now do feedback<a name='3197'></font>
<font color=#447700>!<a name='3198'></font>
<font color=#447700>!!!!! DEEP Convection !!!!!!!!!!<a name='3199'></font>
      if(imid.eq.0)then<a name='3200'>
      do i=its,itf<a name='3201'>
        if(ierr(i).eq.0)then<a name='3202'>
         k=0<a name='3203'>
         xmb_ave(i)=0.<a name='3204'>
         do n=1,maxens3<a name='3205'>
          k=k+1<a name='3206'>
          xmb_ave(i)=xmb_ave(i)+xf_ens(i,n)<a name='3207'>
         enddo<a name='3208'>
         xmb_ave(i)=xmb_ave(i)/float(k)<a name='3209'>
         <font color=#447700>!srf begin<a name='3210'></font>
         if(dicycle == 2 )then<a name='3211'>
            xmb_ave(i)=xmb_ave(i)-max(0.,xmbm_in(i),xmbs_in(i))<a name='3212'>
            xmb_ave(i)=max(0.,xmb_ave(i))<a name='3213'>
         else if (dicycle == 1) then<a name='3214'>
            xmb_ave(i)=min(xmb_ave(i),xmb_ave(i) - xf_dicycle(i))<a name='3215'>
            xmb_ave(i)=max(0.,xmb_ave(i))<a name='3216'>
         endif<a name='3217'>
<font color=#447700>! --- Now use proper count of how many closures were actually<a name='3218'></font>
<font color=#447700>!       used in cup_forcing_ens (including screening of some<a name='3219'></font>
<font color=#447700>!       closures over water) to properly normalize xmb<a name='3220'></font>
           clos_wei=16./max(1.,closure_n(i))<a name='3221'>
         xmb_ave(i)=min(xmb_ave(i),100.)<a name='3222'>
         xmb(i)=clos_wei*sig(i)*xmb_ave(i)<a name='3223'>
<a name='3224'>
           if(xmb(i) &lt; 1.e-16)then<a name='3225'>
              ierr(i)=19<a name='3226'>
           endif<a name='3227'>
<font color=#447700>!           xfac1(i)=xmb(i)<a name='3228'></font>
<font color=#447700>!           xfac2(i)=xmb(i)<a name='3229'></font>
<a name='3230'>
        endif<a name='3231'>
      ENDDO<a name='3232'>
<font color=#447700>!!!!! NOT SO DEEP Convection !!!!!!!!!!<a name='3233'></font>
      else  <font color=#447700>! imid == 1<a name='3234'></font>
         do i=its,itf<a name='3235'>
         xmb_ave(i)=0.<a name='3236'>
         IF(ierr(i).eq.0)then<a name='3237'>
<font color=#447700>! ! first get xmb_ves, depend on ichoicee<a name='3238'></font>
<font color=#447700>!<a name='3239'></font>
           if(ichoice.eq.1 .or. ichoice.eq.2)then<a name='3240'>
              xmb_ave(i)=sig(i)*xff_mid(i,ichoice)<a name='3241'>
           else if(ichoice.gt.2)then<a name='3242'>
              k=0<a name='3243'>
              do n=1,maxens3<a name='3244'>
                    k=k+1<a name='3245'>
                    xmb_ave(i)=xmb_ave(i)+xf_ens(i,n)<a name='3246'>
              enddo<a name='3247'>
              xmb_ave(i)=xmb_ave(i)/float(k)<a name='3248'>
           else if(ichoice == 0)then<a name='3249'>
              xmb_ave(i)=.5*sig(i)*(xff_mid(i,1)+xff_mid(i,2))<a name='3250'>
           endif   <font color=#447700>! ichoice gt.2<a name='3251'></font>
<font color=#447700>! which dicycle method<a name='3252'></font>
           if(dicycle == 2 )then<a name='3253'>
              xmb(i)=max(0.,xmb_ave(i)-xmbs_in(i))<a name='3254'>
           else if (dicycle == 1) then<a name='3255'>
              xmb(i)=min(xmb_ave(i),xmb_ave(i) - xf_dicycle(i))<a name='3256'>
              xmb(i)=max(0.,xmb_ave(i))<a name='3257'>
           else if (dicycle == 0) then<a name='3258'>
              xmb(i)=max(0.,xmb_ave(i))<a name='3259'>
           endif   <font color=#447700>! dicycle=1,2<a name='3260'></font>
         endif     <font color=#447700>! ierr &gt;0<a name='3261'></font>
         enddo     <font color=#447700>! i<a name='3262'></font>
      endif        <font color=#447700>! imid=1<a name='3263'></font>
<a name='3264'>
      do i=its,itf<a name='3265'>
        pwtot(i)=0.<a name='3266'>
        IF(ierr(i).eq.0)then<a name='3267'>
            DO k=kts,ktop(i)<a name='3268'>
              pwtot(i)=pwtot(i)+pw(i,k,1)<a name='3269'>
            enddo<a name='3270'>
            DO k=kts,ktop(i)<a name='3271'>
            dp=100.*(p_cup(i,k)-p_cup(i,k+1))/g<a name='3272'>
            dtt =dellat  (i,k,1)<a name='3273'>
            dtq =dellaq  (i,k,1)<a name='3274'>
<font color=#447700>! necessary to drive downdraft<a name='3275'></font>
            dtpwd=-pwd(i,k)*edt(i)<a name='3276'>
<font color=#447700>! take from dellaqc first<a name='3277'></font>
            dtqc=dellaqc (i,k,1)*dp - dtpwd<a name='3278'>
<font color=#447700>! if this is negative, it needs to come from rain<a name='3279'></font>
           if(dtqc &lt; 0.)then<a name='3280'>
             dtpwd=dtpwd-dellaqc(i,k,1)*dp<a name='3281'>
             dtqc=0.<a name='3282'>
<font color=#447700>! if this is positive, can come from clw detrainment<a name='3283'></font>
           else<a name='3284'>
             dtpwd=0.<a name='3285'>
             dtqc=dtqc/dp<a name='3286'>
           endif<a name='3287'>
           OUTTEM(I,K)= XMB(I)* dtt<a name='3288'>
           OUTQ  (I,K)= XMB(I)* dtq<a name='3289'>
           OUTQC (I,K)= XMB(I)* dtqc<a name='3290'>
           xf_ens(i,:)=sig(i)*xf_ens(i,:)<a name='3291'>
<font color=#447700>! what is evaporated<a name='3292'></font>
           PRE(I)=PRE(I)-XMB(I)*dtpwd<a name='3293'>
          enddo<a name='3294'>
          PRE(I)=-PRE(I)+XMB(I)*pwtot(i)<a name='3295'>
        endif<a name='3296'>
      enddo<a name='3297'>
<a name='3298'>
<a name='3299'>
   END SUBROUTINE cup_output_ens_3d<a name='3300'>
<font color=#447700>!-------------------------------------------------------<a name='3301'></font>
<A NAME='CUP_UP_MOISTURE'><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_MOISTURE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3302'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_up_moisture</font>(name,ierr,z_cup,qc,qrc,pw,pwav,     &amp; <A href='../../call_to/CUP_UP_MOISTURE.html' TARGET='index'>6</A>,<A href='../../call_from/CUP_UP_MOISTURE.html' TARGET='index'>1</A><a name='3303'>
              p_cup,kbcon,ktop,dby,clw_all,xland1,                &amp;<a name='3304'>
              q,GAMMA_cup,zu,qes_cup,k22,qe_cup,                  &amp;<a name='3305'>
              ZQEXEC,ccn,rho,c1d,t,                               &amp;<a name='3306'>
              up_massentr,up_massdetr,psum,psumh,                 &amp;<a name='3307'>
              itest,itf,ktf,                                      &amp;<a name='3308'>
              its,ite, kts,kte                     )<a name='3309'>
<a name='3310'>
   IMPLICIT NONE<a name='3311'>
  real, parameter :: BDISPM = 0.366       <font color=#447700>!Berry--size dispersion (martime)<a name='3312'></font>
  REAL, PARAMETER :: BDISPC = 0.146       <font color=#447700>!Berry--size dispersion (continental)<a name='3313'></font>
<font color=#447700>!<a name='3314'></font>
<font color=#447700>!  on input<a name='3315'></font>
<font color=#447700>!<a name='3316'></font>
<a name='3317'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3318'></font>
<a name='3319'>
     integer                                                      &amp;<a name='3320'>
        ,intent (in   )                   ::                      &amp;<a name='3321'>
                                  itest,itf,ktf,                  &amp;<a name='3322'>
                                  its,ite, kts,kte<a name='3323'>
  <font color=#447700>! cd= detrainment function <a name='3324'></font>
  <font color=#447700>! q = environmental q on model levels<a name='3325'></font>
  <font color=#447700>! qe_cup = environmental q on model cloud levels<a name='3326'></font>
  <font color=#447700>! qes_cup = saturation q on model cloud levels<a name='3327'></font>
  <font color=#447700>! dby = buoancy term<a name='3328'></font>
  <font color=#447700>! cd= detrainment function <a name='3329'></font>
  <font color=#447700>! zu = normalized updraft mass flux<a name='3330'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='3331'></font>
  <font color=#447700>!<a name='3332'></font>
     real,    dimension (its:ite,kts:kte)                         &amp;<a name='3333'>
        ,intent (in   )                   ::                      &amp;<a name='3334'>
        p_cup,rho,q,zu,gamma_cup,qe_cup,                          &amp;<a name='3335'>
        up_massentr,up_massdetr,dby,qes_cup,z_cup<a name='3336'>
     real,    dimension (its:ite)                                 &amp;<a name='3337'>
        ,intent (in   )                   ::                      &amp;<a name='3338'>
        zqexec<a name='3339'>
  <font color=#447700>! entr= entrainment rate <a name='3340'></font>
     integer, dimension (its:ite)                                 &amp;<a name='3341'>
        ,intent (in   )                   ::                      &amp;<a name='3342'>
        kbcon,ktop,k22,xland1<a name='3343'>
<font color=#447700>!<a name='3344'></font>
<font color=#447700>! input and output<a name='3345'></font>
<font color=#447700>!<a name='3346'></font>
<a name='3347'>
   <font color=#447700>! ierr error value, maybe modified in this routine<a name='3348'></font>
<a name='3349'>
     integer, dimension (its:ite)                                  &amp;<a name='3350'>
        ,intent (inout)                   ::                       &amp;<a name='3351'>
        ierr<a name='3352'>
      character *(*), intent (in)         ::                       &amp;<a name='3353'>
       name<a name='3354'>
   <font color=#447700>! qc = cloud q (including liquid water) after entrainment<a name='3355'></font>
   <font color=#447700>! qrch = saturation q in cloud<a name='3356'></font>
   <font color=#447700>! qrc = liquid water content in cloud after rainout<a name='3357'></font>
   <font color=#447700>! pw = condensate that will fall out at that level<a name='3358'></font>
   <font color=#447700>! pwav = totan normalized integrated condensate (I1)<a name='3359'></font>
   <font color=#447700>! c0 = conversion rate (cloud to rain)<a name='3360'></font>
<a name='3361'>
     real,    dimension (its:ite,kts:kte)                          &amp;<a name='3362'>
        ,intent (out  )                   ::                       &amp;<a name='3363'>
        qc,qrc,pw,clw_all<a name='3364'>
     real,    dimension (its:ite,kts:kte) ::                       &amp;<a name='3365'>
        qch,qrcb,pwh,clw_allh,c1d,t<a name='3366'>
     real,    dimension (its:ite)         ::                       &amp;<a name='3367'>
        pwavh<a name='3368'>
     real,    dimension (its:ite)                                  &amp;<a name='3369'>
        ,intent (out  )                   ::                       &amp;<a name='3370'>
        pwav,psum,psumh<a name='3371'>
     real,    dimension (its:ite)                                  &amp;<a name='3372'>
        ,intent (in  )                    ::                       &amp;<a name='3373'>
        ccn<a name='3374'>
<font color=#447700>!<a name='3375'></font>
<font color=#447700>!  local variables in this routine<a name='3376'></font>
<font color=#447700>!<a name='3377'></font>
<a name='3378'>
     integer                              ::                       &amp;<a name='3379'>
        iprop,iall,i,k<a name='3380'>
     integer :: start_level(its:ite)<a name='3381'>
     real                                 ::                       &amp;<a name='3382'>
        prop_ave,qrcb_h,bdsp,dp,rhoc,qrch,qaver,                   &amp;<a name='3383'>
        c0,dz,berryc0,q1,berryc<a name='3384'>
     real                                 ::                       &amp;<a name='3385'>
        denom<a name='3386'>
     real,    dimension (kts:kte)         ::                       &amp;<a name='3387'>
        prop_b<a name='3388'>
<font color=#447700>!<a name='3389'></font>
        prop_b(kts:kte)=0<a name='3390'>
        iall=0<a name='3391'>
        c0=.002<a name='3392'>
        bdsp=BDISPM<a name='3393'>
<font color=#447700>!<a name='3394'></font>
<font color=#447700>!--- no precip for small clouds<a name='3395'></font>
<font color=#447700>!<a name='3396'></font>
<font color=#447700>!        if(name.eq.'shallow')then<a name='3397'></font>
<font color=#447700>!            c0=0.002<a name='3398'></font>
<font color=#447700>!        endif<a name='3399'></font>
        do i=its,itf<a name='3400'>
          pwav(i)=0.<a name='3401'>
          pwavh(i)=0.<a name='3402'>
          psum(i)=0.<a name='3403'>
          psumh(i)=0.<a name='3404'>
        enddo<a name='3405'>
        do k=kts,ktf<a name='3406'>
        do i=its,itf<a name='3407'>
          pw(i,k)=0.<a name='3408'>
          pwh(i,k)=0.<a name='3409'>
          qc(i,k)=0.<a name='3410'>
          if(ierr(i).eq.0)qc(i,k)=qe_cup(i,k)<a name='3411'>
          if(ierr(i).eq.0)qch(i,k)=qe_cup(i,k)<a name='3412'>
          clw_all(i,k)=0.<a name='3413'>
          clw_allh(i,k)=0.<a name='3414'>
          qrc(i,k)=0.<a name='3415'>
          qrcb(i,k)=0.<a name='3416'>
        enddo<a name='3417'>
        enddo<a name='3418'>
      do i=its,itf<a name='3419'>
      if(ierr(i).eq.0)then<a name='3420'>
         start_level=k22(i)<a name='3421'>
         call <A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_CLOUD_BC'>get_cloud_bc</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_MOISTURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CLOUD_BC_6">(kte,qe_cup (i,1:kte),qaver,k22(i))<a name='3422'>
         qaver = qaver <a name='3423'>
         k=start_level(i)<a name='3424'>
         qc (i,k)= qaver <a name='3425'>
         qch (i,k)= qaver<a name='3426'>
         do k=1,start_level(i)-1<a name='3427'>
           qc (i,k)= qe_cup(i,k)<a name='3428'>
           qch (i,k)= qe_cup(i,k)<a name='3429'>
         enddo<a name='3430'>
<font color=#447700>!<a name='3431'></font>
<font color=#447700>!  initialize below originating air<a name='3432'></font>
<font color=#447700>!<a name='3433'></font>
      endif<a name='3434'>
      enddo<a name='3435'>
<a name='3436'>
       DO 100 i=its,itf<a name='3437'>
        c0=.004<a name='3438'>
         IF(ierr(i).eq.0)then<a name='3439'>
<a name='3440'>
<font color=#447700>! below LFC, but maybe above LCL<a name='3441'></font>
<font color=#447700>!<a name='3442'></font>
<font color=#447700>!            if(name == "deep" )then<a name='3443'></font>
            DO k=k22(i)+1,kbcon(i)<a name='3444'>
              qc(i,k)=   (qc(i,k-1)*zu(i,k-1)-.5*up_massdetr(i,k-1)* qc(i,k-1)+ &amp;<a name='3445'>
                         up_massentr(i,k-1)*q(i,k-1))   /                       &amp;<a name='3446'>
                         (zu(i,k-1)-.5*up_massdetr(i,k-1)+up_massentr(i,k-1))<a name='3447'>
<font color=#447700>!              QRCH=QES_cup(I,K)<a name='3448'></font>
               QRCH=QES_cup(I,K)+(1./XLV)*(GAMMA_cup(i,k)                       &amp;<a name='3449'>
                 /(1.+GAMMA_cup(i,k)))*DBY(I,K)<a name='3450'>
              if(k.lt.kbcon(i))qrch=qc(i,k)<a name='3451'>
              if(qc(i,k).gt.qrch)then<a name='3452'>
                DZ=Z_cup(i,K)-Z_cup(i,K-1)<a name='3453'>
                QRC(I,K)=(QC(I,K)-QRCH)/(1.+c0*DZ)<a name='3454'>
                PW(i,k)=c0*dz*QRC(I,K)*zu(i,k)<a name='3455'>
                qc(i,k)=qrch+qrc(i,k)<a name='3456'>
                clw_all(i,k)=qrc(i,k)<a name='3457'>
              endif<a name='3458'>
            enddo<a name='3459'>
 <font color=#447700>!           endif<a name='3460'></font>
<font color=#447700>!<a name='3461'></font>
<font color=#447700>!now do the rest<a name='3462'></font>
<font color=#447700>!<a name='3463'></font>
            DO k=kbcon(i)+1,ktop(i)<a name='3464'>
               c0=.004<a name='3465'>
               if(t(i,k).lt.270.)c0=.002<a name='3466'>
               denom=zu(i,k-1)-.5*up_massdetr(i,k-1)+up_massentr(i,k-1)<a name='3467'>
               if(denom.lt.1.e-8)then<a name='3468'>
                     ierr(i)=51<a name='3469'>
                exit<a name='3470'>
               endif<a name='3471'>
<a name='3472'>
   <a name='3473'>
               rhoc=.5*(rho(i,k)+rho(i,k-1))<a name='3474'>
               DZ=Z_cup(i,K)-Z_cup(i,K-1)<a name='3475'>
               DP=p_cup(i,K)-p_cup(i,K-1)<a name='3476'>
<font color=#447700>!<a name='3477'></font>
<font color=#447700>!--- saturation  in cloud, this is what is allowed to be in it<a name='3478'></font>
<font color=#447700>!<a name='3479'></font>
               QRCH=QES_cup(I,K)+(1./XLV)*(GAMMA_cup(i,k)                       &amp;<a name='3480'>
                 /(1.+GAMMA_cup(i,k)))*DBY(I,K)<a name='3481'>
<font color=#447700>!<a name='3482'></font>
<font color=#447700>!------    1. steady state plume equation, for what could<a name='3483'></font>
<font color=#447700>!------       be in cloud without condensation<a name='3484'></font>
<font color=#447700>!<a name='3485'></font>
<font color=#447700>!<a name='3486'></font>
               qc(i,k)=   (qc(i,k-1)*zu(i,k-1)-.5*up_massdetr(i,k-1)* qc(i,k-1)+ &amp;<a name='3487'>
                         up_massentr(i,k-1)*q(i,k-1))   /                        &amp;<a name='3488'>
                         (zu(i,k-1)-.5*up_massdetr(i,k-1)+up_massentr(i,k-1))<a name='3489'>
               qch(i,k)= (qch(i,k-1)*zu(i,k-1)-.5*up_massdetr(i,k-1)*qch(i,k-1)+ &amp;<a name='3490'>
                         up_massentr(i,k-1)*q(i,k-1))   /                        &amp;<a name='3491'>
                         (zu(i,k-1)-.5*up_massdetr(i,k-1)+up_massentr(i,k-1))<a name='3492'>
<a name='3493'>
               if(qc(i,k).le.qrch)then<a name='3494'>
                 qc(i,k)=qrch<a name='3495'>
               endif<a name='3496'>
               if(qch(i,k).le.qrch)then<a name='3497'>
                 qch(i,k)=qrch<a name='3498'>
               endif<a name='3499'>
<font color=#447700>!<a name='3500'></font>
<font color=#447700>!------- Total condensed water before rainout<a name='3501'></font>
<font color=#447700>!<a name='3502'></font>
               clw_all(i,k)=max(0.,QC(I,K)-QRCH)<a name='3503'>
               QRC(I,K)=max(0.,(QC(I,K)-QRCH)) <font color=#447700>! /(1.+C0*DZ*zu(i,k))<a name='3504'></font>
               clw_allh(i,k)=max(0.,QCH(I,K)-QRCH)<a name='3505'>
               QRCB(I,K)=max(0.,(QCH(I,K)-QRCH)) <font color=#447700>! /(1.+C0*DZ*zu(i,k))<a name='3506'></font>
               IF(autoconv.eq.2) then<a name='3507'>
<a name='3508'>
<a name='3509'>
<font color=#447700>! <a name='3510'></font>
<font color=#447700>! normalized berry<a name='3511'></font>
<font color=#447700>!<a name='3512'></font>
<font color=#447700>! first calculate for average conditions, used in cup_dd_edt!<a name='3513'></font>
<font color=#447700>! this will also determine proportionality constant prop_b, which, if applied,<a name='3514'></font>
<font color=#447700>! would give the same results as c0 under these conditions<a name='3515'></font>
<font color=#447700>!<a name='3516'></font>
                 q1=1.e3*rhoc*qrcb(i,k)  <font color=#447700>! g/m^3 ! g[h2o]/cm^3<a name='3517'></font>
                 berryc0=q1*q1/(60.0*(5.0 + 0.0366*CCNclean/                           &amp;<a name='3518'>
                    ( q1 * BDSP)  ) ) <font color=#447700>!/(<a name='3519'></font>
                 qrcb_h=((QCH(I,K)-QRCH)*zu(i,k)-qrcb(i,k-1)*(.5*up_massdetr(i,k-1)))/ &amp;<a name='3520'>
                   (zu(i,k)+.5*up_massdetr(i,k-1)+c0*dz*zu(i,k))<a name='3521'>
                 prop_b(k)=c0*qrcb_h*zu(i,k)/(1.e-3*berryc0)<a name='3522'>
                 pwh(i,k)=zu(i,k)*1.e-3*berryc0*dz*prop_b(k) <font color=#447700>! 2.<a name='3523'></font>
                 berryc=qrcb(i,k)<a name='3524'>
                 qrcb(i,k)=((QCh(I,K)-QRCH)*zu(i,k)-pwh(i,k)-qrcb(i,k-1)*(.5*up_massdetr(i,k-1)))/ &amp;<a name='3525'>
                       (zu(i,k)+.5*up_massdetr(i,k-1))<a name='3526'>
                 if(qrcb(i,k).lt.0.)then<a name='3527'>
                   berryc0=(qrcb(i,k-1)*(.5*up_massdetr(i,k-1))-(QCh(I,K)-QRCH)*zu(i,k))/zu(i,k)*1.e-3*dz*prop_b(k)<a name='3528'>
                   pwh(i,k)=zu(i,k)*1.e-3*berryc0*dz*prop_b(k)<a name='3529'>
                   qrcb(i,k)=0.<a name='3530'>
                 endif<a name='3531'>
                 QCh(I,K)=QRCb(I,K)+qrch<a name='3532'>
                 PWAVH(I)=PWAVH(I)+pwh(I,K)<a name='3533'>
                 Psumh(I)=Psumh(I)+clw_allh(I,K)*zu(i,k) *dz<a name='3534'>
        <font color=#447700>!<a name='3535'></font>
<font color=#447700>! then the real berry<a name='3536'></font>
<font color=#447700>!<a name='3537'></font>
                 q1=1.e3*rhoc*qrc(i,k)  <font color=#447700>! g/m^3 ! g[h2o]/cm^3<a name='3538'></font>
                 berryc0=q1*q1/(60.0*(5.0 + 0.0366*CCN(i)/                                             &amp;<a name='3539'>
                    ( q1 * BDSP)  ) ) <font color=#447700>!/(<a name='3540'></font>
                 berryc0=1.e-3*berryc0*dz*prop_b(k) <font color=#447700>! 2.<a name='3541'></font>
                 berryc=qrc(i,k)<a name='3542'>
                 qrc(i,k)=((QC(I,K)-QRCH)*zu(i,k)-zu(i,k)*berryc0-qrc(i,k-1)*(.5*up_massdetr(i,k-1)))/ &amp;<a name='3543'>
                       (zu(i,k)+.5*up_massdetr(i,k-1))<a name='3544'>
                 if(qrc(i,k).lt.0.)then<a name='3545'>
                    berryc0=((QC(I,K)-QRCH)*zu(i,k)-qrc(i,k-1)*(.5*up_massdetr(i,k-1)))/zu(i,k)<a name='3546'>
                    qrc(i,k)=0.<a name='3547'>
                 endif<a name='3548'>
                 pw(i,k)=berryc0*zu(i,k)<a name='3549'>
                 QC(I,K)=QRC(I,K)+qrch<a name='3550'>
<font color=#447700>!<a name='3551'></font>
<font color=#447700>!  if not running with berry at all, do the following<a name='3552'></font>
<font color=#447700>!<a name='3553'></font>
               ELSE       <font color=#447700>!c0=.002<a name='3554'></font>
                 if(iall.eq.1)then<a name='3555'>
                   qrc(i,k)=0.<a name='3556'>
                   pw(i,k)=(QC(I,K)-QRCH)*zu(i,k)<a name='3557'>
                   if(pw(i,k).lt.0.)pw(i,k)=0.<a name='3558'>
                 else<a name='3559'>
                   QRC(I,K)=(QC(I,K)-QRCH)/(1.+(c1d(i,k)+C0)*DZ)<a name='3560'>
                   PW(i,k)=c0*dz*QRC(I,K)*zu(i,k)<a name='3561'>
                   if(qrc(i,k).lt.0)then<a name='3562'>
                     qrc(i,k)=0.<a name='3563'>
                     pw(i,k)=0.<a name='3564'>
                   endif<a name='3565'>
                 endif<a name='3566'>
                 QC(I,K)=QRC(I,K)+qrch<a name='3567'>
               endif <font color=#447700>!autoconv<a name='3568'></font>
               PWAV(I)=PWAV(I)+PW(I,K)<a name='3569'>
               Psum(I)=Psum(I)+clw_all(I,K)*zu(i,k) *dz<a name='3570'>
            enddo <font color=#447700>! k=kbcon,ktop<a name='3571'></font>
<font color=#447700>! do not include liquid/ice in qc<a name='3572'></font>
       do k=k22(i)+1,ktop(i)<a name='3573'>
           qc(i,k)=qc(i,k)-qrc(i,k)<a name='3574'>
       enddo<a name='3575'>
      endif <font color=#447700>! ierr<a name='3576'></font>
<font color=#447700>!<a name='3577'></font>
<font color=#447700>!--- integrated normalized ondensate<a name='3578'></font>
<font color=#447700>!<a name='3579'></font>
 100     CONTINUE<a name='3580'>
       prop_ave=0.<a name='3581'>
       iprop=0<a name='3582'>
       do k=kts,kte<a name='3583'>
        prop_ave=prop_ave+prop_b(k)<a name='3584'>
        if(prop_b(k).gt.0)iprop=iprop+1<a name='3585'>
       enddo<a name='3586'>
       iprop=max(iprop,1)<a name='3587'>
<a name='3588'>
 END SUBROUTINE cup_up_moisture<a name='3589'>
<a name='3590'>
<font color=#447700>!--------------------------------------------------------------------<a name='3591'></font>
<a name='3592'>
<A NAME='SATVAP'><A href='../../html_code/phys/module_cu_gf_deep.F.html#SATVAP' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3593'>
 REAL <font color=#993300>FUNCTION </font><font color=#cc0000>satvap</font>(temp2) <A href='../../call_to/SATVAP.html' TARGET='index'>2</A><a name='3594'>
      implicit none<a name='3595'>
      real :: temp2, temp, toot, toto, eilog, tsot,            &amp;<a name='3596'>
     &amp;        ewlog, ewlog2, ewlog3, ewlog4<a name='3597'>
      temp = temp2-273.155<a name='3598'>
      if (temp.lt.-20.) then   <font color=#447700>!!!! ice saturation<a name='3599'></font>
        toot = 273.16 / temp2<a name='3600'>
        toto = 1 / toot<a name='3601'>
        eilog = -9.09718 * (toot - 1) - 3.56654 * (log(toot) / &amp;<a name='3602'>
     &amp;    log(10.)) + .876793 * (1 - toto) + (log(6.1071) / log(10.))<a name='3603'>
        satvap = 10 ** eilog<a name='3604'>
      else<a name='3605'>
        tsot = 373.16 / temp2<a name='3606'>
        ewlog = -7.90298 * (tsot - 1) + 5.02808 *              &amp;<a name='3607'>
     &amp;             (log(tsot) / log(10.))<a name='3608'>
        ewlog2 = ewlog - 1.3816e-07 *                          &amp;<a name='3609'>
     &amp;             (10 ** (11.344 * (1 - (1 / tsot))) - 1)<a name='3610'>
        ewlog3 = ewlog2 + .0081328 *                           &amp;<a name='3611'>
     &amp;             (10 ** (-3.49149 * (tsot - 1)) - 1)<a name='3612'>
        ewlog4 = ewlog3 + (log(1013.246) / log(10.))<a name='3613'>
        satvap = 10 ** ewlog4<a name='3614'>
      end if<a name='3615'>
 END FUNCTION<a name='3616'>
<font color=#447700>!--------------------------------------------------------------------<a name='3617'></font>
<A NAME='GET_CLOUD_BC'><A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_CLOUD_BC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3618'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>get_cloud_bc</font>(mzp,array,x_aver,k22,add) <A href='../../call_to/GET_CLOUD_BC.html' TARGET='index'>11</A><a name='3619'>
    implicit none<a name='3620'>
    integer, intent(in)     :: mzp,k22<a name='3621'>
    real   , intent(in)     :: array(mzp)<a name='3622'>
    real   , optional , intent(in)  :: add<a name='3623'>
    real   , intent(out)    :: x_aver<a name='3624'>
    integer :: i,local_order_aver,order_aver<a name='3625'>
<a name='3626'>
    <font color=#447700>!-- dimension of the average<a name='3627'></font>
    <font color=#447700>!-- a) to pick the value at k22 level, instead of a average between<a name='3628'></font>
    <font color=#447700>!--    k22-order_aver, ..., k22-1, k22 set order_aver=1)<a name='3629'></font>
    <font color=#447700>!-- b) to average between 1 and k22 =&gt; set order_aver = k22<a name='3630'></font>
    order_aver = 3 <font color=#447700>!=&gt; average between k22, k22-1 and k22-2<a name='3631'></font>
<a name='3632'>
    local_order_aver=min(k22,order_aver)<a name='3633'>
<a name='3634'>
    x_aver=0.<a name='3635'>
    do i = 1,local_order_aver<a name='3636'>
      x_aver = x_aver + array(k22-i+1)<a name='3637'>
    enddo<a name='3638'>
      x_aver = x_aver/float(local_order_aver)<a name='3639'>
    if(present(add)) x_aver = x_aver + add<a name='3640'>
<a name='3641'>
 end SUBROUTINE get_cloud_bc<a name='3642'>
 <font color=#447700>!========================================================================================<a name='3643'></font>
<a name='3644'>
<a name='3645'>
<A NAME='RATES_UP_PDF'><A href='../../html_code/phys/module_cu_gf_deep.F.html#RATES_UP_PDF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3646'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>rates_up_pdf</font>(rand_vmas,ipr,name,ktop,ierr,p_cup,entr_rate_2d,hkbo,heo,heso_cup,z_cup, &amp; <A href='../../call_to/RATES_UP_PDF.html' TARGET='index'>3</A>,<A href='../../call_from/RATES_UP_PDF.html' TARGET='index'>3</A><a name='3647'>
               xland,kstabi,k22,kbcon,its,ite,itf,kts,kte,ktf,zuo,kpbl,ktopdby,csum,pmin_lev)<a name='3648'>
     implicit none<a name='3649'>
     character *(*), intent (in)       :: name<a name='3650'>
     integer, intent(in) :: ipr,its,ite,itf,kts,kte,ktf<a name='3651'>
     real, dimension (its:ite,kts:kte),intent (inout) :: entr_rate_2d,zuo<a name='3652'>
     real, dimension (its:ite,kts:kte),intent (in) ::p_cup, heo,heso_cup,z_cup<a name='3653'>
     real, dimension (its:ite),intent (in) :: hkbo,rand_vmas<a name='3654'>
     integer, dimension (its:ite),intent (in) :: kstabi,k22,kpbl,csum,xland,pmin_lev<a name='3655'>
     integer, dimension (its:ite),intent (inout) :: kbcon,ierr,ktop,ktopdby<a name='3656'>
     <font color=#447700>!-local vars<a name='3657'></font>
     real, dimension (its:ite,kts:kte) :: hcot<a name='3658'>
     real :: beta_u,dz,dbythresh,dzh2,zustart,zubeg,massent,massdetr<a name='3659'>
     real :: dby(kts:kte),dbm(kts:kte),zux(kts:kte)<a name='3660'>
     real zuh2(40),zh2(40)<a name='3661'>
     integer :: kklev,i,kk,kbegin,k,kfinalzu<a name='3662'>
     integer, dimension (its:ite) :: start_level <a name='3663'>
     <font color=#447700>!<a name='3664'></font>
     zustart=.1<a name='3665'>
     dbythresh= 1. <font color=#447700>!.0.95 ! 0.85, 0.6<a name='3666'></font>
     if(name == 'shallow' .or. name == 'mid') dbythresh=1.<a name='3667'>
     dby(:)=0.<a name='3668'>
<a name='3669'>
     DO i=its,itf<a name='3670'>
      zux(:)=0.<a name='3671'>
      beta_u=max(.1,.2-float(csum(i))*.01)<a name='3672'>
      zuo(i,:)=0.<a name='3673'>
      dby(:)=0.<a name='3674'>
      dbm(:)=0.<a name='3675'>
      kbcon(i)=max(kbcon(i),2)<a name='3676'>
      if(ierr(i).eq.0)then<a name='3677'>
       start_level(i)=k22(i)<a name='3678'>
       zuo(i,start_level(i))=zustart<a name='3679'>
        zux(start_level(i))=zustart<a name='3680'>
        do k=start_level(i)+1,kbcon(i)<a name='3681'>
          dz=z_cup(i,k)-z_cup(i,k-1)<a name='3682'>
          massent=dz*entr_rate_2d(i,k-1)*zuo(i,k-1)<a name='3683'>
          massdetr=dz*1.e-9*zuo(i,k-1)<a name='3684'>
          zuo(i,k)=zuo(i,k-1)+massent-massdetr<a name='3685'>
          zux(k)=zuo(i,k)<a name='3686'>
        enddo<a name='3687'>
       zubeg=zustart <font color=#447700>!zuo(i,kbcon(i))<a name='3688'></font>
       if(name .eq. 'deep')then<a name='3689'>
        ktop(i)=0<a name='3690'>
        hcot(i,start_level(i))=hkbo(i)<a name='3691'>
        dz=z_cup(i,start_level(i))-z_cup(i,start_level(i)-1)<a name='3692'>
        do k=start_level(i)+1,ktf-2<a name='3693'>
           dz=z_cup(i,k)-z_cup(i,k-1)<a name='3694'>
<a name='3695'>
           hcot(i,k)=( (1.-0.5*entr_rate_2d(i,k-1)*dz)*hcot(i,k-1) &amp;<a name='3696'>
                      + entr_rate_2d(i,k-1)*dz*heo(i,k-1))/        &amp;<a name='3697'>
                      (1.+0.5*entr_rate_2d(i,k-1)*dz)<a name='3698'>
           if(k &gt;= kbcon(i)) dby(k)=dby(k-1)+(hcot(i,k)-heso_cup(i,k))*dz<a name='3699'>
           if(k &gt;= kbcon(i)) dbm(k)=hcot(i,k)-heso_cup(i,k)<a name='3700'>
        enddo<a name='3701'>
        ktopdby(i)=maxloc(dby(:),1)<a name='3702'>
        kklev=maxloc(dbm(:),1)<a name='3703'>
        do k=maxloc(dby(:),1)+1,ktf-2<a name='3704'>
          if(dby(k).lt.dbythresh*maxval(dby))then<a name='3705'>
              kfinalzu=k  - 1<a name='3706'>
              ktop(i)=kfinalzu<a name='3707'>
              go to 412<a name='3708'>
          endif<a name='3709'>
        enddo<a name='3710'>
        kfinalzu=ktf-2<a name='3711'>
        ktop(i)=kfinalzu<a name='3712'>
412     continue<a name='3713'>
<font color=#447700>!<a name='3714'></font>
<font color=#447700>! at least overshoot by one level<a name='3715'></font>
<font color=#447700>!<a name='3716'></font>
<font color=#447700>!        kfinalzu=min(max(kfinalzu,ktopdby(i)+1),ktopdby(i)+2)<a name='3717'></font>
<font color=#447700>!        ktop(i)=kfinalzu<a name='3718'></font>
        if(kfinalzu.le.kbcon(i)+2)then<a name='3719'>
              ierr(i)=41<a name='3720'>
              ktop(i)= 0<a name='3721'>
        else<a name='3722'>
<font color=#447700>!           call get_zu_zd_pdf_fim(ipr,xland(i),zuh2,"UP",ierr(i),start_level(i),             &amp;<a name='3723'></font>
<font color=#447700>!           call get_zu_zd_pdf_fim(rand_vmas(i),zubeg,ipr,xland(i),zuh2,"UP",ierr(i),kbcon(i), &amp;<a name='3724'></font>
<font color=#447700>!            kfinalzu,zuo(i,kts:kte),kts,kte,ktf,beta_u,kpbl(i),csum(i),pmin_lev(i))<a name='3725'></font>
           call <A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_ZU_ZD_PDF_FIM'>get_zu_zd_pdf_fim</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#RATES_UP_PDF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_ZU_ZD_PDF_FIM_2">(kklev,p_cup(i,:),rand_vmas(i),zubeg,ipr,xland(i),zuh2,"UP",ierr(i),k22(i), &amp;<a name='3726'>
            kfinalzu,zuo(i,kts:kte),kts,kte,ktf,beta_u,kstabi(i),csum(i),pmin_lev(i))<a name='3727'>
        endif<a name='3728'>
      endif <font color=#447700>! end deep<a name='3729'></font>
      if ( name == 'mid' ) then<a name='3730'>
       if(ktop(i) &lt;= kbcon(i)+2)then<a name='3731'>
              ierr(i)=41<a name='3732'>
              ktop(i)= 0<a name='3733'>
       else<a name='3734'>
           kfinalzu=ktop(i)<a name='3735'>
           ktopdby(i)=ktop(i)+1<a name='3736'>
          call <A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_ZU_ZD_PDF_FIM'>get_zu_zd_pdf_fim</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#RATES_UP_PDF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_ZU_ZD_PDF_FIM_3">(kklev,p_cup(i,:),rand_vmas(i),zubeg,ipr,xland(i),zuh2,"MID",ierr(i),k22(i),kfinalzu,zuo(i,kts:kte),kts,kte,ktf,beta_u,kbcon(i),csum(i),pmin_lev(i))<a name='3737'>
<font color=#447700>!           kbegin=0<a name='3738'></font>
<font color=#447700>!           dzh2=(z_cup(i,ktop(i))-z_cup(i,k22(i)))/40.<a name='3739'></font>
<font color=#447700>!           zh2(1)=z_cup(i,k22(i))<a name='3740'></font>
<font color=#447700>!           if(zuh2(1).gt.0.1 .and. kbegin.eq.0)kbegin=1<a name='3741'></font>
<font color=#447700>!           do k=2,40<a name='3742'></font>
<font color=#447700>!             zh2(k)=zh2(k-1)+dzh2<a name='3743'></font>
<font color=#447700>!             if(zuh2(k).gt.0.1 .and. kbegin.eq.0)kbegin=k<a name='3744'></font>
<font color=#447700>!           enddo<a name='3745'></font>
<font color=#447700>!           zuo(i,k22(i))=zuh2(kbegin)<a name='3746'></font>
<font color=#447700>!           do k=k22(i)+1,kfinalzu+1<a name='3747'></font>
<font color=#447700>!             do kk=kbegin,39<a name='3748'></font>
<font color=#447700>!             if(z_cup(i,k).gt.zh2(kk) .and.  z_cup(i,k).le.zh2(kk+1)) then<a name='3749'></font>
<font color=#447700>!                 zuo(i,k)=zuh2(kk)<a name='3750'></font>
<font color=#447700>!                 exit<a name='3751'></font>
<font color=#447700>!              endif<a name='3752'></font>
<font color=#447700>!             enddo<a name='3753'></font>
<font color=#447700>!           enddo<a name='3754'></font>
<font color=#447700>!           if(zuo(i,ktop(i)).lt.1.e-4)ktop(i)=ktop(i)-1<a name='3755'></font>
       endif<a name='3756'>
      endif <font color=#447700>! mid<a name='3757'></font>
      if ( name == 'shallow' ) then<a name='3758'>
       if(ktop(i) &lt;= kbcon(i)+2)then<a name='3759'>
           ierr(i)=41<a name='3760'>
           ktop(i)= 0<a name='3761'>
       else<a name='3762'>
           kfinalzu=ktop(i)<a name='3763'>
           ktopdby(i)=ktop(i)<a name='3764'>
           call <A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_ZU_ZD_PDF_FIM'>get_zu_zd_pdf_fim</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#RATES_UP_PDF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_ZU_ZD_PDF_FIM_4">(kklev,p_cup(i,:),rand_vmas(i),zubeg,ipr,xland(i),zuh2,"SH2",ierr(i),k22(i), &amp;<a name='3765'>
             kfinalzu,zuo(i,kts:kte),kts,kte,ktf,beta_u,kpbl(i),csum(i),pmin_lev(i))<a name='3766'>
<a name='3767'>
         endif<a name='3768'>
         endif <font color=#447700>! shal<a name='3769'></font>
      ENDIF <font color=#447700>! ierr<a name='3770'></font>
     ENDDO<a name='3771'>
<a name='3772'>
  END SUBROUTINE rates_up_pdf<a name='3773'>
<font color=#447700>!-------------------------------------------------------------------------<a name='3774'></font>
<A NAME='GET_ZU_ZD_PDF_FIM'><A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_ZU_ZD_PDF_FIM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3775'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>get_zu_zd_pdf_fim</font>(kklev,p,rand_vmas,zubeg,ipr,xland,zuh2,draft,ierr,kb,kt,zu,kts,kte,ktf,max_mass,kpbli,csum,pmin_lev) <A href='../../call_to/GET_ZU_ZD_PDF_FIM.html' TARGET='index'>4</A>,<A href='../../call_from/GET_ZU_ZD_PDF_FIM.html' TARGET='index'>5</A><a name='3776'>
<a name='3777'>
 implicit none<a name='3778'>
 integer, intent(in) ::ipr,xland,kb,kklev,kt,kts,kte,ktf,kpbli,csum,pmin_lev<a name='3779'>
 real, intent(in) ::max_mass,zubeg<a name='3780'>
 real, intent(inout) :: zu(kts:kte)<a name='3781'>
 real, intent(in) :: p(kts:kte)<a name='3782'>
 real  :: zuh(kts:kte),zuh2(1:40)<a name='3783'>
 integer, intent(inout) :: ierr<a name='3784'>
 character*(*), intent(in) ::draft<a name='3785'>
<a name='3786'>
 <font color=#447700>!- local var<a name='3787'></font>
 integer :: kk,k,kb_adj,kpbli_adj<a name='3788'>
 real    :: krmax,beta, alpha,kratio,tunning,FZU,rand_vmas,lev_start<a name='3789'>
 <font color=#447700>!- kb cannot be at 1st level<a name='3790'></font>
<a name='3791'>
 <font color=#447700>!-- fill zu with zeros<a name='3792'></font>
 zu=0.0<a name='3793'>
 zuh=0.0<a name='3794'>
   kb_adj=max(kb,2)<a name='3795'>
 IF(draft == "UP") then<a name='3796'>
   lev_start=min(.9,.4+csum*.013)<a name='3797'>
   kb_adj=max(kb,2)<a name='3798'>
   tunning=p(kt)+(p(kpbli)-p(kt))*lev_start<a name='3799'>
   tunning =min(0.9, (tunning-p(kb_adj))/(p(kt)-p(kb_adj))) <font color=#447700>!=.6<a name='3800'></font>
   tunning =max(0.2, tunning)<a name='3801'>
   beta    = 1.3 <font color=#447700>!2.5 ! max(2.5,2./tunning)<a name='3802'></font>
   alpha= (tunning*(beta -2.)+1.)/(1.-tunning)<a name='3803'>
#if ( <font color=#447700>! defined NO_GAMMA_SUPPORT )<a name='3804'></font>
   fzu = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_ZU_ZD_PDF_FIM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_24">(alpha + beta)/(gamma(alpha)*gamma(beta))<a name='3805'>
#else<a name='3806'>
   call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_ZU_ZD_PDF_FIM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_601"> ('compiler does not support 2008 gamma intrinsic')<a name='3807'>
#endif<a name='3808'>
  do k=kb_adj,min(kte,kt)<a name='3809'>
      kratio= (p(k)-p(kb_adj))/(p(kt)-p(kb_adj)) <font color=#447700>!float(k)/float(kt+1)<a name='3810'></font>
      zu(k) = zubeg+FZU*kratio**(alpha-1.0) * (1.0-kratio)**(beta-1.0)<a name='3811'>
   enddo<a name='3812'>
<a name='3813'>
   if(maxval(zu(kts:min(ktf,kt+1))).gt.0.)  &amp;<a name='3814'>
      zu(kts:min(ktf,kt+1))= zu(kts:min(ktf,kt+1))/maxval(zu(kts:min(ktf,kt+1)))<a name='3815'>
     do k=maxloc(zu(:),1),1,-1<a name='3816'>
       if(zu(k).lt.1.e-6)then<a name='3817'>
         kb_adj=k+1<a name='3818'>
         exit<a name='3819'>
       endif<a name='3820'>
     enddo<a name='3821'>
     kb_adj=max(2,kb_adj)<a name='3822'>
     do k=kts,kb_adj-1<a name='3823'>
       zu(k)=0.<a name='3824'>
     enddo<a name='3825'>
<a name='3826'>
 ELSEIF(draft == "SH2") then<a name='3827'>
   tunning =min(0.8, (p(kpbli)-p(kb_adj))/(p(kt)-p(kb_adj))) <font color=#447700>!=.6<a name='3828'></font>
   tunning =max(0.2, tunning)<a name='3829'>
   beta    = 2.5 <font color=#447700>!2.5 ! max(2.5,2./tunning)<a name='3830'></font>
   alpha= (tunning*(beta -2.)+1.)/(1.-tunning)<a name='3831'>
#if ( <font color=#447700>! defined NO_GAMMA_SUPPORT )<a name='3832'></font>
   fzu = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_ZU_ZD_PDF_FIM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_25">(alpha + beta)/(gamma(alpha)*gamma(beta))<a name='3833'>
#endif<a name='3834'>
  do k=kb_adj,min(kte,kt)<a name='3835'>
      kratio= (p(k)-p(kb_adj))/(p(kt)-p(kb_adj)) <font color=#447700>!float(k)/float(kt+1)<a name='3836'></font>
      zu(k) = zubeg+FZU*kratio**(alpha-1.0) * (1.0-kratio)**(beta-1.0)<a name='3837'>
   enddo<a name='3838'>
   if(maxval(zu(kts:min(ktf,kt+1))).gt.0.)  &amp;<a name='3839'>
      zu(kts:min(ktf,kt+1))= zu(kts:min(ktf,kt+1))/maxval(zu(kts:min(ktf,kt+1)))<a name='3840'>
     do k=maxloc(zu(:),1),1,-1<a name='3841'>
       if(zu(k).lt.1.e-6)then<a name='3842'>
         kb_adj=k+1<a name='3843'>
         exit<a name='3844'>
       endif<a name='3845'>
     enddo<a name='3846'>
<a name='3847'>
 ELSEIF(draft == "SH3") then<a name='3848'>
  tunning = 0.6<a name='3849'>
  beta    =2.2/tunning<a name='3850'>
  alpha   = tunning*beta<a name='3851'>
   beta    = 3.5 <font color=#447700>! max(2.5,2./tunning)<a name='3852'></font>
   alpha   = beta -2. <font color=#447700>! +1 !max(1.1,tunning*beta-abs(1.5-tunning)*5.)<a name='3853'></font>
  fzu=1.<a name='3854'>
  do k=1,40<a name='3855'>
      kratio= float(k)/float(40)<a name='3856'>
      zuh2(k) = zubeg+FZU*kratio**(alpha-1.0) * (1.0-kratio)**(beta-1.0)<a name='3857'>
   enddo<a name='3858'>
   if(maxval(zuh2(1:40)).gt.0.)  &amp;<a name='3859'>
      zuh2(:)= zuh2(:)/ maxval(zuh2(1:40))<a name='3860'>
 ELSEIF(draft == "MID") then<a name='3861'>
   kb_adj=max(kb,2)<a name='3862'>
   tunning=p(kt)+(p(kb_adj)-p(kt))*.9 <font color=#447700>!*.33<a name='3863'></font>
   tunning =min(0.9, (tunning-p(kb_adj))/(p(kt)-p(kb_adj))) <font color=#447700>!=.6<a name='3864'></font>
   tunning =max(0.2, tunning)<a name='3865'>
   beta    = 1.3 <font color=#447700>!2.5 ! max(2.5,2./tunning)<a name='3866'></font>
   alpha= (tunning*(beta -2.)+1.)/(1.-tunning)<a name='3867'>
#if ( <font color=#447700>! defined NO_GAMMA_SUPPORT )<a name='3868'></font>
   fzu = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_ZU_ZD_PDF_FIM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_26">(alpha + beta)/(gamma(alpha)*gamma(beta))<a name='3869'>
#endif<a name='3870'>
  do k=kb_adj,min(kte,kt)<a name='3871'>
      kratio= (p(k)-p(kb_adj))/(p(kt)-p(kb_adj)) <font color=#447700>!float(k)/float(kt+1)<a name='3872'></font>
      zu(k) = zubeg+FZU*kratio**(alpha-1.0) * (1.0-kratio)**(beta-1.0)<a name='3873'>
   enddo<a name='3874'>
   if(maxval(zu(kts:min(ktf,kt+1))).gt.0.)  &amp;<a name='3875'>
      zu(kts:min(ktf,kt+1))= zu(kts:min(ktf,kt+1))/maxval(zu(kts:min(ktf,kt+1)))<a name='3876'>
     do k=maxloc(zu(:),1),1,-1<a name='3877'>
       if(zu(k).lt.1.e-6)then<a name='3878'>
         kb_adj=k+1<a name='3879'>
         exit<a name='3880'>
       endif<a name='3881'>
     enddo<a name='3882'>
     kb_adj=max(2,kb_adj)<a name='3883'>
     do k=kts,kb_adj-1<a name='3884'>
       zu(k)=0.<a name='3885'>
     enddo<a name='3886'>
<a name='3887'>
 ELSEIF(draft == "DOWN" .or. draft == "DOWNM") then<a name='3888'>
<a name='3889'>
  <font color=#447700>! tunning = 0.8<a name='3890'></font>
  <font color=#447700>! beta    = 3.0/tunning<a name='3891'></font>
<font color=#447700>!  tunning = 0.8<a name='3892'></font>
<font color=#447700>!  beta    =2.0/tunning<a name='3893'></font>
<font color=#447700>!  alpha   = tunning*beta<a name='3894'></font>
<font color=#447700>!  fzu=1.<a name='3895'></font>
<font color=#447700>!  zuh(:)=0.<a name='3896'></font>
   tunning=p(kb)<a name='3897'>
   tunning =min(0.9, (tunning-p(1))/(p(kt)-p(1))) <font color=#447700>!=.6<a name='3898'></font>
   tunning =max(0.2, tunning)<a name='3899'>
   beta    = 4. <font color=#447700>!2.5 ! max(2.5,2./tunning)<a name='3900'></font>
   alpha= (tunning*(beta -2.)+1.)/(1.-tunning)<a name='3901'>
#if ( <font color=#447700>! defined NO_GAMMA_SUPPORT )<a name='3902'></font>
   fzu = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_ZU_ZD_PDF_FIM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_27">(alpha + beta)/(gamma(alpha)*gamma(beta))<a name='3903'>
#endif<a name='3904'>
  zu(:)=0.<a name='3905'>
  do k=2,min(kt,ktf)<a name='3906'>
      kratio= (p(k)-p(1))/(p(kt)-p(1))<a name='3907'>
      zu(k) = FZU*kratio**(alpha-1.0) * (1.0-kratio)**(beta-1.0)<a name='3908'>
   enddo<a name='3909'>
<font color=#447700>!   if(maxloc(zuh(:),1).ge.kpbli)then<a name='3910'></font>
<font color=#447700>!      do k=maxloc(zuh(:),1),1,-1<a name='3911'></font>
<font color=#447700>!         kk=kpbli+k-maxloc(zuh(:),1)<a name='3912'></font>
<font color=#447700>!         if(kk.gt.1)zu(kk)=zuh(k)<a name='3913'></font>
<font color=#447700>!      enddo<a name='3914'></font>
<font color=#447700>!      do k=maxloc(zuh(:),1)+1,kt<a name='3915'></font>
<font color=#447700>!         kk=kpbli+k-maxloc(zuh(:),1)<a name='3916'></font>
<font color=#447700>!         if(kk.le.kt)zu(kk)=zuh(k)<a name='3917'></font>
<font color=#447700>!      enddo<a name='3918'></font>
<font color=#447700>!   else<a name='3919'></font>
<font color=#447700>!      do k=2,kt ! maxloc(zuh(:),1)<a name='3920'></font>
<font color=#447700>!        zu(k)=zuh(k-1)<a name='3921'></font>
<font color=#447700>!      enddo<a name='3922'></font>
<font color=#447700>!   endif<a name='3923'></font>
    fzu=maxval(zu(kts:min(ktf,kt+1)))<a name='3924'>
   if(fzu.gt.0.)  &amp;<a name='3925'>
      zu(kts:min(ktf,kt+1))= zu(kts:min(ktf,kt+1))/fzu<a name='3926'>
<font color=#447700>!    if(zu(2).gt.max_mass)fzu=max_mass/zu(2) ! max(0.,zu(2)-max_mass)<a name='3927'></font>
<font color=#447700>!     do k=2,kt+1<a name='3928'></font>
<font color=#447700>!       zu(k)=fzu*zu(k)<a name='3929'></font>
<font color=#447700>!     enddo<a name='3930'></font>
     zu(1)=0.<a name='3931'>
<a name='3932'>
<a name='3933'>
  ENDIF<a name='3934'>
  <font color=#447700>!- normalize ZU<a name='3935'></font>
  <font color=#447700>!  if(maxval(zu(kts:min(ktf,kt+1))).gt.0.)  &amp;<a name='3936'></font>
  <font color=#447700>!     zu(kts:min(ktf,kt+1))= zu(kts:min(ktf,kt+1))/ maxval(zu(kts:min(ktf,kt+1)))<a name='3937'></font>
  END SUBROUTINE get_zu_zd_pdf_fim<a name='3938'>
<a name='3939'>
<font color=#447700>!-------------------------------------------------------------------------<a name='3940'></font>
<A NAME='CUP_UP_AA1BL'><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_AA1BL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3941'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_up_aa1bl</font>(aa0,t,tn,q,qo,dtime,  &amp; <A href='../../call_to/CUP_UP_AA1BL.html' TARGET='index'>1</A><a name='3942'>
              z,zu,dby,gamma_cup,t_cup,         &amp;<a name='3943'>
              kbcon,ktop,ierr,                  &amp;<a name='3944'>
              itf,ktf,                          &amp;<a name='3945'>
              its,ite, kts,kte         )<a name='3946'>
<a name='3947'>
   IMPLICIT NONE<a name='3948'>
<font color=#447700>!<a name='3949'></font>
<font color=#447700>!  on input<a name='3950'></font>
<font color=#447700>!<a name='3951'></font>
<a name='3952'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3953'></font>
<a name='3954'>
     integer                                                           &amp;<a name='3955'>
        ,intent (in   )                   ::                           &amp;<a name='3956'>
        itf,ktf,                                                       &amp;<a name='3957'>
        its,ite, kts,kte<a name='3958'>
  <font color=#447700>! aa0 cloud work function<a name='3959'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='3960'></font>
  <font color=#447700>! t_cup = temperature (Kelvin) on model cloud levels<a name='3961'></font>
  <font color=#447700>! dby = buoancy term<a name='3962'></font>
  <font color=#447700>! zu= normalized updraft mass flux<a name='3963'></font>
  <font color=#447700>! z = heights of model levels <a name='3964'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='3965'></font>
  <font color=#447700>!<a name='3966'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3967'>
        ,intent (in   )                   ::                           &amp;<a name='3968'>
        z,zu,gamma_cup,t_cup,dby,t,tn,q,qo<a name='3969'>
     integer, dimension (its:ite)                                      &amp;<a name='3970'>
        ,intent (in   )                   ::                           &amp;<a name='3971'>
        kbcon,ktop<a name='3972'>
     real, intent(in) :: dtime<a name='3973'>
<font color=#447700>!<a name='3974'></font>
<font color=#447700>! input and output<a name='3975'></font>
<font color=#447700>!<a name='3976'></font>
<a name='3977'>
<a name='3978'>
     integer, dimension (its:ite)                                      &amp;<a name='3979'>
        ,intent (inout)                   ::                           &amp;<a name='3980'>
        ierr<a name='3981'>
     real,    dimension (its:ite)                                      &amp;<a name='3982'>
        ,intent (out  )                   ::                           &amp;<a name='3983'>
        aa0<a name='3984'>
<font color=#447700>!<a name='3985'></font>
<font color=#447700>!  local variables in this routine<a name='3986'></font>
<font color=#447700>!<a name='3987'></font>
<a name='3988'>
     integer                              ::                           &amp;<a name='3989'>
        i,k<a name='3990'>
     real                                 ::                           &amp;<a name='3991'>
        dz,dA<a name='3992'>
<font color=#447700>!<a name='3993'></font>
        DO i=its,itf<a name='3994'>
         AA0(I)=0.<a name='3995'>
        ENDDO<a name='3996'>
        DO 100 k=kts+1,ktf<a name='3997'>
        DO 100 i=its,itf<a name='3998'>
         IF(ierr(i).ne.0 )GO TO 100<a name='3999'>
         IF(k.gt.KBCON(i))GO TO 100<a name='4000'>
<a name='4001'>
         DZ=Z(I,K)-Z(I,K-1)<a name='4002'>
         <font color=#447700>!print*,"dz=",i,k,z(i,k),Z(I,K-1),dz         <a name='4003'></font>
         <font color=#447700>!da=zu(i,k)*DZ*(9.81/(1004.*( &amp;<a name='4004'></font>
         <font color=#447700>!        (T_cup(I,K)))))*DBY(I,K-1)/ &amp;<a name='4005'></font>
         <font color=#447700>!     (1.+GAMMA_CUP(I,K))<a name='4006'></font>
         <font color=#447700>! IF(K.eq.KTOP(I).and.da.le.0.)go to 100<a name='4007'></font>
<a name='4008'>
         dA=  DZ*9.81*( tn(i,k)-t(i,k) + 0.608*(qo(i,k)-q(i,k)))/dtime<a name='4009'>
         AA0(I)=AA0(I)+dA<a name='4010'>
100     CONTINUE<a name='4011'>
<a name='4012'>
 END SUBROUTINE cup_up_aa1bl<a name='4013'>
<font color=#447700>!---------------------------------------------------------------------- <a name='4014'></font>
<A NAME='GET_INVERSION_LAYERS'><A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_INVERSION_LAYERS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4015'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>get_inversion_layers</font>(ierr,p_cup,t_cup,z_cup,qo_cup,qeso_cup,k_inv_layers,&amp;            <A href='../../call_to/GET_INVERSION_LAYERS.html' TARGET='index'>2</A><a name='4016'>
                     kstart,kend,dtempdz,itf,ktf,its,ite, kts,kte)<a name='4017'>
                                    <a name='4018'>
        IMPLICIT NONE<a name='4019'>
        integer                      ,intent (in ) :: itf,ktf,its,ite,kts,kte<a name='4020'>
        integer, dimension (its:ite) ,intent (in ) :: ierr,kstart,kend<a name='4021'>
        integer, dimension (its:ite) :: kend_p3<a name='4022'>
                    <a name='4023'>
        real,    dimension (its:ite,kts:kte), intent (in ) :: p_cup,t_cup,z_cup,qo_cup,qeso_cup                            <a name='4024'>
        real,    dimension (its:ite,kts:kte), intent (out) :: dtempdz                    <a name='4025'>
        integer, dimension (its:ite,kts:kte), intent (out) :: k_inv_layers<a name='4026'>
        <font color=#447700>!-local vars<a name='4027'></font>
        real   :: dp,l_mid,l_shal,first_deriv(kts:kte),sec_deriv(kts:kte)<a name='4028'>
        integer:: ken,kadd,kj,i,k,ilev,kk,ix,k800,k550,mid,shal<a name='4029'>
        <font color=#447700>!<a name='4030'></font>
        <font color=#447700>!-initialize k_inv_layers as undef<a name='4031'></font>
        l_mid=300.<a name='4032'>
        l_shal=100.<a name='4033'>
        k_inv_layers(:,:) = 1<a name='4034'>
         do i = its,itf<a name='4035'>
           if(ierr(i) == 0)then<a name='4036'>
           kend_p3(i)=kend(i)+3<a name='4037'>
           DO k = kts+1,kend_p3(i)+4<a name='4038'>
            <font color=#447700>!-  get the 1st der<a name='4039'></font>
            first_deriv(k)= (t_cup(i,k+1)-t_cup(i,k-1))/(z_cup(i,k+1)-z_cup(i,k-1))        <a name='4040'>
            dtempdz(i,k)=first_deriv(k)<a name='4041'>
               enddo<a name='4042'>
           DO k = kts+2,kend_p3(i)+3<a name='4043'>
            <font color=#447700>!  get the 2nd der<a name='4044'></font>
            sec_deriv(k)= (first_deriv(k+1)-first_deriv(k-1))/(z_cup(i,k+1)-z_cup(i,k-1))        <a name='4045'>
            sec_deriv(k)= abs(sec_deriv(k))        <a name='4046'>
           enddo<a name='4047'>
        <a name='4048'>
         ilev=max(kts+2,kstart(i)+1)<a name='4049'>
         ix=1<a name='4050'>
         k=ilev<a name='4051'>
         DO WHILE (ilev &lt; kend_p3(i)) <font color=#447700>!(z_cup(i,ilev)&lt;15000.)<a name='4052'></font>
           do kk=k,kend_p3(i)+2 <font color=#447700>!k,ktf-2<a name='4053'></font>
             <a name='4054'>
             if(sec_deriv(kk) &lt;        sec_deriv(kk+1) .and.  &amp;<a name='4055'>
                sec_deriv(kk) &lt; sec_deriv(kk-1)        ) then<a name='4056'>
              k_inv_layers(i,ix)=kk<a name='4057'>
              ix=min(5,ix+1)<a name='4058'>
              ilev=kk+1<a name='4059'>
              exit   <a name='4060'>
             endif<a name='4061'>
              ilev=kk+1<a name='4062'>
               enddo<a name='4063'>
           k=ilev<a name='4064'>
         ENDDO         <a name='4065'>
        <font color=#447700>!- 2nd criteria<a name='4066'></font>
         kadd=0<a name='4067'>
         ken=maxloc(k_inv_layers(i,:),1)<a name='4068'>
         do k=1,ken<a name='4069'>
           kk=k_inv_layers(i,k+kadd)<a name='4070'>
           if(kk.eq.1)exit<a name='4071'>
<a name='4072'>
           if( dtempdz(i,kk) &lt; dtempdz(i,kk-1) .and. &amp;<a name='4073'>
               dtempdz(i,kk) &lt; dtempdz(i,kk+1) ) then <font color=#447700>! the layer is not a local maximum<a name='4074'></font>
               kadd=kadd+1<a name='4075'>
                do kj = k,ken<a name='4076'>
               if(k_inv_layers(i,kj+kadd).gt.1)k_inv_layers(i,kj) = k_inv_layers(i,kj+kadd)<a name='4077'>
               if(k_inv_layers(i,kj+kadd).eq.1)k_inv_layers(i,kj) = 1<a name='4078'>
                enddo<a name='4079'>
           endif<a name='4080'>
         ENDDO<a name='4081'>
        endif<a name='4082'>
        ENDDO<a name='4083'>
100 format(1x,16i3)        <a name='4084'>
        <font color=#447700>!- find the locations of inversions around 800 and 550 hPa<a name='4085'></font>
        sec_deriv(:)=1.e9<a name='4086'>
        do i = its,itf<a name='4087'>
         if(ierr(i) /= 0) cycle<a name='4088'>
<a name='4089'>
         <font color=#447700>!- now find the closest layers of 800 and 550 hPa.         <a name='4090'></font>
         do k=1,maxloc(k_inv_layers(i,:),1) <font color=#447700>!kts,kte !kstart(i),kend(i) !kts,kte<a name='4091'></font>
           dp=p_cup(i,k_inv_layers(i,k))-p_cup(i,kstart(i))<a name='4092'>
           sec_deriv(k)=abs(dp)-l_shal<a name='4093'>
         enddo<a name='4094'>
         k800=minloc(abs(sec_deriv),1)<a name='4095'>
        sec_deriv(:)=1.e9<a name='4096'>
<a name='4097'>
         do k=1,maxloc(k_inv_layers(i,:),1) <font color=#447700>!kts,kte !kstart(i),kend(i) !kts,kte<a name='4098'></font>
           dp=p_cup(i,k_inv_layers(i,k))-p_cup(i,kstart(i))<a name='4099'>
           sec_deriv(k)=abs(dp)-l_mid<a name='4100'>
         enddo<a name='4101'>
         k550=minloc(abs(sec_deriv),1)<a name='4102'>
         <font color=#447700>!-save k800 and k550 in k_inv_layers array<a name='4103'></font>
         shal=1<a name='4104'>
         mid=2<a name='4105'>
         k_inv_layers(i,shal)=k_inv_layers(i,k800) <font color=#447700>! this is for shallow convection<a name='4106'></font>
         k_inv_layers(i,mid )=k_inv_layers(i,k550) <font color=#447700>! this is for mid/congestus convection<a name='4107'></font>
         k_inv_layers(i,mid+1:kte)=-1<a name='4108'>
        ENDDO<a name='4109'>
<a name='4110'>
        <a name='4111'>
 END SUBROUTINE get_inversion_layers<a name='4112'>
<font color=#447700>!-----------------------------------------------------------------------------------<a name='4113'></font>
<A NAME='DERIV3'><A href='../../html_code/phys/module_cu_gf_deep.F.html#DERIV3' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4114'>
 <font color=#993300>FUNCTION </font><font color=#cc0000>DERIV3</font>(xx, xi, yi, ni, m)<a name='4115'>
    <font color=#447700>!============================================================================*/<a name='4116'></font>
    <font color=#447700>! Evaluate first- or second-order derivatives <a name='4117'></font>
    <font color=#447700>! using three-point Lagrange interpolation <a name='4118'></font>
    <font color=#447700>! written by: Alex Godunov (October 2009)<a name='4119'></font>
    <font color=#447700>! input ...<a name='4120'></font>
    <font color=#447700>! xx    - the abscissa at which the interpolation is to be evaluated<a name='4121'></font>
    <font color=#447700>! xi()  - the arrays of data abscissas<a name='4122'></font>
    <font color=#447700>! yi()  - the arrays of data ordinates<a name='4123'></font>
    <font color=#447700>! ni - size of the arrays xi() and yi()<a name='4124'></font>
    <font color=#447700>! m  - order of a derivative (1 or 2)<a name='4125'></font>
    <font color=#447700>! output ...<a name='4126'></font>
    <font color=#447700>! deriv3  - interpolated value<a name='4127'></font>
    <font color=#447700>!============================================================================*/<a name='4128'></font>
    <a name='4129'>
    implicit none<a name='4130'>
    integer, parameter :: n=3<a name='4131'>
    integer ni, m,i, j, k, ix<a name='4132'>
    real:: deriv3, xx<a name='4133'>
    real:: xi(ni), yi(ni), x(n), f(n)<a name='4134'>
<a name='4135'>
    <font color=#447700>! exit if too high-order derivative was needed,<a name='4136'></font>
    if (m &gt; 2) then<a name='4137'>
      deriv3 = 0.0<a name='4138'>
      return<a name='4139'>
    end if<a name='4140'>
<a name='4141'>
    <font color=#447700>! if x is ouside the xi(1)-xi(ni) interval set deriv3=0.0<a name='4142'></font>
    if (xx &lt; xi(1) .or. xx &gt; xi(ni)) then<a name='4143'>
      deriv3 = 0.0<a name='4144'>
      stop "problems with finding the 2nd derivative"<a name='4145'>
    end if<a name='4146'>
<a name='4147'>
    <font color=#447700>! a binary (bisectional) search to find i so that xi(i-1) &lt; x &lt; xi(i)<a name='4148'></font>
    i = 1<a name='4149'>
    j = ni<a name='4150'>
    do while (j &gt; i+1)<a name='4151'>
      k = (i+j)/2<a name='4152'>
      if (xx &lt; xi(k)) then<a name='4153'>
        j = k<a name='4154'>
      else<a name='4155'>
        i = k<a name='4156'>
      end if<a name='4157'>
    end do<a name='4158'>
<a name='4159'>
    <font color=#447700>! shift i that will correspond to n-th order of interpolation<a name='4160'></font>
    <font color=#447700>! the search point will be in the middle in x_i, x_i+1, x_i+2 ...<a name='4161'></font>
      i = i + 1 - n/2<a name='4162'>
<a name='4163'>
    <font color=#447700>! check boundaries: if i is ouside of the range [1, ... n] -&gt; shift i<a name='4164'></font>
    if (i &lt; 1) i=1<a name='4165'>
    if (i + n &gt; ni) i=ni-n+1<a name='4166'>
<a name='4167'>
    <font color=#447700>!  old output to test i<a name='4168'></font>
    <font color=#447700>!  write(*,100) xx, i<a name='4169'></font>
    <font color=#447700>!  100 format (f10.5, I5)<a name='4170'></font>
<a name='4171'>
    <font color=#447700>! just wanted to use index i<a name='4172'></font>
    ix = i<a name='4173'>
    <font color=#447700>! initialization of f(n) and x(n)<a name='4174'></font>
    do i=1,n<a name='4175'>
      f(i) = yi(ix+i-1)<a name='4176'>
      x(i) = xi(ix+i-1)<a name='4177'>
    end do<a name='4178'>
<a name='4179'>
    <font color=#447700>! calculate the first-order derivative using Lagrange interpolation<a name='4180'></font>
    if (m == 1) then<a name='4181'>
        deriv3 =          (2.0*xx - (x(2)+x(3)))*f(1)/((x(1)-x(2))*(x(1)-x(3)))<a name='4182'>
        deriv3 = deriv3 + (2.0*xx - (x(1)+x(3)))*f(2)/((x(2)-x(1))*(x(2)-x(3)))<a name='4183'>
        deriv3 = deriv3 + (2.0*xx - (x(1)+x(2)))*f(3)/((x(3)-x(1))*(x(3)-x(2)))<a name='4184'>
    <font color=#447700>! calculate the second-order derivative using Lagrange interpolation<a name='4185'></font>
      else<a name='4186'>
        deriv3 =          2.0*f(1)/((x(1)-x(2))*(x(1)-x(3)))<a name='4187'>
        deriv3 = deriv3 + 2.0*f(2)/((x(2)-x(1))*(x(2)-x(3)))<a name='4188'>
        deriv3 = deriv3 + 2.0*f(3)/((x(3)-x(1))*(x(3)-x(2)))<a name='4189'>
    end if<a name='4190'>
 END FUNCTION DERIV3<a name='4191'>
<font color=#447700>!=============================================================================================<a name='4192'></font>
<A NAME='GET_LATERAL_MASSFLUX'><A href='../../html_code/phys/module_cu_gf_deep.F.html#GET_LATERAL_MASSFLUX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4193'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>get_lateral_massflux</font>(itf,ktf, its,ite, kts,kte                             &amp; <A href='../../call_to/GET_LATERAL_MASSFLUX.html' TARGET='index'>2</A><a name='4194'>
                                  ,ierr,ktop,zo_cup,zuo,cd,entr_rate_2d                 &amp;<a name='4195'>
                                  ,up_massentro, up_massdetro ,up_massentr, up_massdetr &amp;<a name='4196'>
                                  ,draft,kbcon,k22,up_massentru,up_massdetru,lambau)<a name='4197'>
<a name='4198'>
     Implicit none<a name='4199'>
     character *(*), intent (in) :: draft<a name='4200'>
     integer, intent(in):: itf,ktf, its,ite, kts,kte<a name='4201'>
     integer, intent(in)   , dimension(its:ite)         :: ierr,ktop,kbcon,k22<a name='4202'>
     real,    intent(in),  OPTIONAL , dimension(its:ite):: lambau<a name='4203'>
     real,    intent(in)   , dimension(its:ite,kts:kte) :: zo_cup,zuo<a name='4204'>
     real,    intent(inout), dimension(its:ite,kts:kte) :: cd,entr_rate_2d   <a name='4205'>
     real,    intent(  out), dimension(its:ite,kts:kte) :: up_massentro, up_massdetro  &amp;<a name='4206'>
                                                          ,up_massentr,  up_massdetr<a name='4207'>
     real,    intent(  out), dimension(its:ite,kts:kte),  OPTIONAL ::                  &amp;<a name='4208'>
                                                          up_massentru,up_massdetru<a name='4209'>
     <font color=#447700>!-- local vars<a name='4210'></font>
     Integer :: i,k, incr1,incr2<a name='4211'>
     REAL :: dz,trash,trash2<a name='4212'>
     <a name='4213'>
     do k=kts,kte<a name='4214'>
      do i=its,ite<a name='4215'>
         up_massentro(i,k)=0.<a name='4216'>
         up_massdetro(i,k)=0.<a name='4217'>
         up_massentr (i,k)=0.<a name='4218'>
         up_massdetr (i,k)=0.<a name='4219'>
      enddo<a name='4220'>
     enddo<a name='4221'>
     if(present(up_massentru) .and. present(up_massdetru))then<a name='4222'>
       do k=kts,kte<a name='4223'>
        do i=its,ite<a name='4224'>
          up_massentru(i,k)=0.<a name='4225'>
          up_massdetru(i,k)=0.<a name='4226'>
        enddo<a name='4227'>
       enddo<a name='4228'>
     endif<a name='4229'>
     DO i=its,itf<a name='4230'>
       if(ierr(i).eq.0)then<a name='4231'>
         <a name='4232'>
          do k=max(2,k22(i)+1),maxloc(zuo(i,:),1)<a name='4233'>
           <font color=#447700>!=&gt; below maximum value zu -&gt; change entrainment<a name='4234'></font>
           dz=zo_cup(i,k)-zo_cup(i,k-1)<a name='4235'>
        <a name='4236'>
           up_massdetro(i,k-1)=cd(i,k-1)*dz*zuo(i,k-1)<a name='4237'>
           up_massentro(i,k-1)=zuo(i,k)-zuo(i,k-1)+up_massdetro(i,k-1)<a name='4238'>
           if(up_massentro(i,k-1).lt.0.)then<a name='4239'>
              up_massentro(i,k-1)=0.<a name='4240'>
              up_massdetro(i,k-1)=zuo(i,k-1)-zuo(i,k)<a name='4241'>
              if(zuo(i,k-1).gt.0.)cd(i,k-1)=up_massdetro(i,k-1)/(dz*zuo(i,k-1))<a name='4242'>
           endif<a name='4243'>
           if(zuo(i,k-1).gt.0.)entr_rate_2d(i,k-1)=(up_massentro(i,k-1))/(dz*zuo(i,k-1))<a name='4244'>
         enddo<a name='4245'>
         do k=maxloc(zuo(i,:),1)+1,ktop(i)<a name='4246'>
           <font color=#447700>!=&gt; above maximum value zu -&gt; change detrainment<a name='4247'></font>
           dz=zo_cup(i,k)-zo_cup(i,k-1)<a name='4248'>
           up_massentro(i,k-1)=entr_rate_2d(i,k-1)*dz*zuo(i,k-1)<a name='4249'>
           up_massdetro(i,k-1)=zuo(i,k-1)+up_massentro(i,k-1)-zuo(i,k)<a name='4250'>
           if(up_massdetro(i,k-1).lt.0.)then<a name='4251'>
              up_massdetro(i,k-1)=0.<a name='4252'>
              up_massentro(i,k-1)=zuo(i,k)-zuo(i,k-1)<a name='4253'>
              if(zuo(i,k-1).gt.0.)entr_rate_2d(i,k-1)=(up_massentro(i,k-1))/(dz*zuo(i,k-1))<a name='4254'>
           endif<a name='4255'>
        <a name='4256'>
           if(zuo(i,k-1).gt.0.)cd(i,k-1)=up_massdetro(i,k-1)/(dz*zuo(i,k-1))<a name='4257'>
         enddo<a name='4258'>
         up_massdetro(i,ktop(i))=zuo(i,ktop(i))<a name='4259'>
         up_massentro(i,ktop(i))=0.<a name='4260'>
         do k=ktop(i)+1,ktf<a name='4261'>
           cd(i,k)=0.<a name='4262'>
           entr_rate_2d(i,k)=0.<a name='4263'>
           up_massentro(i,k)=0.<a name='4264'>
           up_massdetro(i,k)=0.<a name='4265'>
         enddo<a name='4266'>
         do k=2,ktf-1<a name='4267'>
           up_massentr (i,k-1)=up_massentro(i,k-1)<a name='4268'>
           up_massdetr (i,k-1)=up_massdetro(i,k-1)<a name='4269'>
         enddo         <a name='4270'>
         if(present(up_massentru) .and. present(up_massdetru))then<a name='4271'>
          do k=2,ktf-1<a name='4272'>
           up_massentru(i,k-1)=up_massentro(i,k-1)+lambau(i)*up_massdetro(i,k-1)<a name='4273'>
           up_massdetru(i,k-1)=up_massdetro(i,k-1)+lambau(i)*up_massdetro(i,k-1)<a name='4274'>
          enddo<a name='4275'>
         endif<a name='4276'>
<a name='4277'>
         trash=0.<a name='4278'>
         trash2=0.<a name='4279'>
         do k=k22(i)+1,ktop(i)<a name='4280'>
             trash2=trash2+entr_rate_2d(i,k)<a name='4281'>
         enddo<a name='4282'>
         do k=k22(i)+1,kbcon(i)<a name='4283'>
            trash=trash+entr_rate_2d(i,k)<a name='4284'>
         enddo<a name='4285'>
  <a name='4286'>
       endif<a name='4287'>
    ENDDO<a name='4288'>
 END SUBROUTINE get_lateral_massflux<a name='4289'>
<font color=#447700>!==============================================================================<a name='4290'></font>
<font color=#447700>!---------------------------------------------------------------------- <a name='4291'></font>
<A NAME='GFINIT'><A href='../../html_code/phys/module_cu_gf_deep.F.html#GFINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4292'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>gfinit</font>(RTHCUTEN,RQVCUTEN,RQCCUTEN,RQICUTEN,            &amp;<a name='4293'>
                        RUCUTEN,RVCUTEN,                            &amp;<a name='4294'>
                        restart,                                    &amp;<a name='4295'>
                        P_QC,P_QI,P_FIRST_SCALAR,                   &amp;<a name='4296'>
                        RTHFTEN, RQVFTEN,                           &amp;<a name='4297'>
                        allowed_to_read,                            &amp;<a name='4298'>
                        ids, ide, jds, jde, kds, kde,               &amp;<a name='4299'>
                        ims, ime, jms, jme, kms, kme,               &amp;<a name='4300'>
                        its, ite, jts, jte, kts, kte               )<a name='4301'>
<font color=#447700>!--------------------------------------------------------------------   <a name='4302'></font>
   IMPLICIT NONE<a name='4303'>
<font color=#447700>!--------------------------------------------------------------------<a name='4304'></font>
   LOGICAL , INTENT(IN)           ::  restart,allowed_to_read<a name='4305'>
   INTEGER , INTENT(IN)           ::  ids, ide, jds, jde, kds, kde, &amp;<a name='4306'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='4307'>
                                      its, ite, jts, jte, kts, kte<a name='4308'>
   INTEGER , INTENT(IN)           ::  P_FIRST_SCALAR, P_QI, P_QC<a name='4309'>
<a name='4310'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::       &amp;<a name='4311'>
                                                          RTHCUTEN,          &amp;<a name='4312'>
                                                          RQVCUTEN,          &amp;<a name='4313'>
                                                          RQCCUTEN,          &amp;<a name='4314'>
                                                          RQICUTEN<a name='4315'>
<a name='4316'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::       &amp;<a name='4317'>
                                                          RUCUTEN,           &amp;<a name='4318'>
                                                          RVCUTEN<a name='4319'>
<a name='4320'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::       &amp;<a name='4321'>
                                                          RTHFTEN,           &amp;<a name='4322'>
                                                          RQVFTEN<a name='4323'>
<a name='4324'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='4325'>
   jtf=min0(jte,jde-1)<a name='4326'>
   ktf=min0(kte,kde-1)<a name='4327'>
   itf=min0(ite,ide-1)<a name='4328'>
<a name='4329'>
   IF(.not.restart)THEN<a name='4330'>
     DO j=jts,jte<a name='4331'>
     DO k=kts,kte<a name='4332'>
     DO i=its,ite<a name='4333'>
        RTHCUTEN(i,k,j)=0.<a name='4334'>
        RQVCUTEN(i,k,j)=0.<a name='4335'>
        RUCUTEN(i,k,j)=0.<a name='4336'>
        RVCUTEN(i,k,j)=0.<a name='4337'>
     ENDDO<a name='4338'>
     ENDDO<a name='4339'>
     ENDDO<a name='4340'>
<a name='4341'>
<a name='4342'>
     DO j=jts,jtf<a name='4343'>
     DO k=kts,ktf<a name='4344'>
     DO i=its,itf<a name='4345'>
        RTHFTEN(i,k,j)=0.<a name='4346'>
        RQVFTEN(i,k,j)=0.<a name='4347'>
     ENDDO<a name='4348'>
     ENDDO<a name='4349'>
     ENDDO<a name='4350'>
<a name='4351'>
     IF (P_QC .ge. P_FIRST_SCALAR) THEN<a name='4352'>
        DO j=jts,jtf<a name='4353'>
        DO k=kts,ktf<a name='4354'>
        DO i=its,itf<a name='4355'>
           RQCCUTEN(i,k,j)=0.<a name='4356'>
        ENDDO<a name='4357'>
        ENDDO<a name='4358'>
        ENDDO<a name='4359'>
     ENDIF<a name='4360'>
<a name='4361'>
     IF (P_QI .ge. P_FIRST_SCALAR) THEN<a name='4362'>
        DO j=jts,jtf<a name='4363'>
        DO k=kts,ktf<a name='4364'>
        DO i=its,itf<a name='4365'>
           RQICUTEN(i,k,j)=0.<a name='4366'>
        ENDDO<a name='4367'>
        ENDDO<a name='4368'>
        ENDDO<a name='4369'>
     ENDIF<a name='4370'>
<a name='4371'>
   ENDIF<a name='4372'>
<a name='4373'>
   END SUBROUTINE gfinit<a name='4374'>
END MODULE module_cu_gf_deep<a name='4375'>
</pre></body></html>