<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if ( HYBRID_COORD==1 )<a name='2'>
#define MU(...) (c1h(k)*XXPCXX(__VA_ARGS__)+c2h(k))<a name='3'>
#define XXPCXX(...) MU(__VA_ARGS__)<a name='4'>
#endif<a name='5'>
<a name='6'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='7'></font>
<font color=#447700>!<a name='8'></font>
<A NAME='MODULE_FDDAOBS_RTFDDA'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#MODULE_FDDAOBS_RTFDDA' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='9'>
<font color=#993300>MODULE </font><font color=#cc0000>module_fddaobs_rtfdda</font> <A href='../../call_to/MODULE_FDDAOBS_RTFDDA.html' TARGET='index'>3</A><a name='10'>
<a name='11'>
<font color=#447700>! This obs-nudging FDDA module (RTFDDA) is developed by the <a name='12'></font>
<font color=#447700>! NCAR/RAL/NSAP (National Security Application Programs), under the <a name='13'></font>
<font color=#447700>! sponsorship of ATEC (Army Test and Evaluation Commands). ATEC is <a name='14'></font>
<font color=#447700>! acknowledged for releasing this capability for WRF community <a name='15'></font>
<font color=#447700>! research applications.<a name='16'></font>
<font color=#447700>!<a name='17'></font>
<font color=#447700>! The NCAR/RAL RTFDDA module was adapted, and significantly modified <a name='18'></font>
<font color=#447700>! from the obs-nudging module in the standard MM5V3.1 which was originally <a name='19'></font>
<font color=#447700>! developed by PSU (Stauffer and Seaman, 1994). <a name='20'></font>
<font color=#447700>! <a name='21'></font>
<font color=#447700>! Yubao Liu (NCAR/RAL): lead developer of the RTFDDA module <a name='22'></font>
<font color=#447700>! Al Bourgeois (NCAR/RAL): lead engineer implementing RTFDDA into WRF-ARW<a name='23'></font>
<font color=#447700>! Nov. 2006<a name='24'></font>
<font color=#447700>! <a name='25'></font>
<font color=#447700>! References:<a name='26'></font>
<font color=#447700>!   <a name='27'></font>
<font color=#447700>!   Liu, Y., A. Bourgeois, T. Warner, S. Swerdlin and J. Hacker, 2005: An<a name='28'></font>
<font color=#447700>!     implementation of obs-nudging-based FDDA into WRF for supporting <a name='29'></font>
<font color=#447700>!     ATEC test operations. 2005 WRF user workshop. Paper 10.7.<a name='30'></font>
<font color=#447700>!<a name='31'></font>
<font color=#447700>!   Liu, Y., A. Bourgeois, T. Warner, S. Swerdlin and W. Yu, 2006: An update <a name='32'></font>
<font color=#447700>!     on "obs-nudging"-based FDDA for WRF-ARW: Verification using OSSE <a name='33'></font>
<font color=#447700>!     and performance of real-time forecasts. 2006 WRF user workshop. Paper 4.7. <a name='34'></font>
<a name='35'>
<font color=#447700>!   <a name='36'></font>
<font color=#447700>!   Stauffer, D.R., and N.L. Seaman, 1994: Multi-scale four-dimensional data <a name='37'></font>
<font color=#447700>!     assimilation. J. Appl. Meteor., 33, 416-434.<a name='38'></font>
<font color=#447700>!<a name='39'></font>
<font color=#447700>!   http://www.rap.ucar.edu/projects/armyrange/references.html<a name='40'></font>
<font color=#447700>!<a name='41'></font>
<font color=#447700>! Modification History:<a name='42'></font>
<font color=#447700>!   03212007 Modified fddaobs_init to compute Lambert cone factor. -Al Bourgeois<a name='43'></font>
<a name='44'>
CONTAINS<a name='45'>
<a name='46'>
<font color=#447700>!------------------------------------------------------------------------------<a name='47'></font>
<A NAME='FDDAOBS_INIT'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='48'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>fddaobs_init</font>(nudge_opt, maxdom, inest, parid,             &amp; <A href='../../call_to/FDDAOBS_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/FDDAOBS_INIT.html' TARGET='index'>73</A><a name='49'>
                          idynin, dtramp, fdaend, restart,             &amp;<a name='50'>
                          twindo_cg, twindo, itimestep,                &amp;<a name='51'>
                          no_pbl_nudge_uv,                             &amp;<a name='52'>
                          no_pbl_nudge_t,                              &amp;<a name='53'>
                          no_pbl_nudge_q,                              &amp;<a name='54'>
                          sfc_scheme_horiz, sfc_scheme_vert,           &amp;<a name='55'>
                          maxsnd_gap,                                  &amp;<a name='56'>
                          sfcfact, sfcfacr, dpsmx,                     &amp;<a name='57'>
                          nudge_wind, nudge_temp, nudge_mois,          &amp;<a name='58'>
                          nudgezfullr1_uv, nudgezrampr1_uv,            &amp;<a name='59'>
                          nudgezfullr2_uv, nudgezrampr2_uv,            &amp;<a name='60'>
                          nudgezfullr4_uv, nudgezrampr4_uv,            &amp;<a name='61'>
                          nudgezfullr1_t,  nudgezrampr1_t,             &amp;<a name='62'>
                          nudgezfullr2_t,  nudgezrampr2_t,             &amp;<a name='63'>
                          nudgezfullr4_t,  nudgezrampr4_t,             &amp;<a name='64'>
                          nudgezfullr1_q,  nudgezrampr1_q,             &amp;<a name='65'>
                          nudgezfullr2_q,  nudgezrampr2_q,             &amp;<a name='66'>
                          nudgezfullr4_q,  nudgezrampr4_q,             &amp;<a name='67'>
                          nudgezfullmin,   nudgezrampmin, nudgezmax,   &amp;<a name='68'>
                          xlat, xlong,                                 &amp;<a name='69'>
                          start_year, start_month, start_day,          &amp;<a name='70'>
                          start_hour, start_minute, start_second,      &amp;<a name='71'>
                          p00, t00, tlp,                               &amp;<a name='72'>
                          znu, p_top,                                  &amp;<a name='73'>
#if ( EM_CORE == 1 )<a name='74'>
                          fdob,                                        &amp;<a name='75'>
#endif<a name='76'>
                          iprt,                                        &amp;<a name='77'>
                          ids,ide, jds,jde, kds,kde,                   &amp;<a name='78'>
                          ims,ime, jms,jme, kms,kme,                   &amp;<a name='79'>
                          its,ite, jts,jte, kts,kte)     <a name='80'>
<font color=#447700>!-----------------------------------------------------------------------<a name='81'></font>
<font color=#447700>!  This routine does initialization for real time fdda obs-nudging.<a name='82'></font>
<font color=#447700>!<a name='83'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='84'></font>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_64">, ONLY : g, r_d<a name='85'>
  USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_230"><a name='86'>
  USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_148">, ONLY : wrf_dm_min_real<a name='87'>
<font color=#447700>!-----------------------------------------------------------------------<a name='88'></font>
  IMPLICIT NONE<a name='89'>
<font color=#447700>!-----------------------------------------------------------------------<a name='90'></font>
<a name='91'>
<font color=#447700>!=======================================================================<a name='92'></font>
<font color=#447700>! Definitions<a name='93'></font>
<font color=#447700>!-----------<a name='94'></font>
  INTEGER, intent(in)  :: maxdom<a name='95'>
  INTEGER, intent(in)  :: nudge_opt(maxdom)<a name='96'>
  INTEGER, intent(in)  :: ids,ide, jds,jde, kds,kde,                 &amp;<a name='97'>
                          ims,ime, jms,jme, kms,kme,                 &amp;<a name='98'>
                          its,ite, jts,jte, kts,kte<a name='99'>
  INTEGER, intent(in)  :: inest<a name='100'>
  INTEGER, intent(in)  :: parid(maxdom)<a name='101'>
  INTEGER, intent(in)  :: idynin         <font color=#447700>! flag for dynamic initialization<a name='102'></font>
  REAL,    intent(in)  :: dtramp         <font color=#447700>! time period for idynin ramping (min)<a name='103'></font>
  REAL,    intent(in)  :: fdaend(maxdom) <font color=#447700>! nudging end time for domain (min)<a name='104'></font>
  LOGICAL, intent(in)  :: restart<a name='105'>
  REAL, intent(in)     :: twindo_cg      <font color=#447700>! time window on coarse grid<a name='106'></font>
  REAL, intent(in)     :: twindo<a name='107'>
  INTEGER, intent(in)  :: itimestep<a name='108'>
  INTEGER , INTENT(IN) :: no_pbl_nudge_uv(maxdom)  <font color=#447700>! flags for no wind nudging in pbl <a name='109'></font>
  INTEGER , INTENT(IN) :: no_pbl_nudge_t(maxdom)   <font color=#447700>! flags for no temperature nudging in pbl<a name='110'></font>
  INTEGER , INTENT(IN) :: no_pbl_nudge_q(maxdom)   <font color=#447700>! flags for no moisture nudging in pbl<a name='111'></font>
  INTEGER , INTENT(IN) :: sfc_scheme_horiz <font color=#447700>! horizontal spreading scheme for surf obs (wrf or orig mm5)<a name='112'></font>
  INTEGER , INTENT(IN) :: sfc_scheme_vert  <font color=#447700>! vertical spreading scheme for surf obs (orig or regime vif)<a name='113'></font>
  REAL    , INTENT(IN) :: maxsnd_gap      <font color=#447700>! max allowed pressure gap in soundings, for interp (centibars)<a name='114'></font>
  REAL, intent(in)     :: sfcfact      <font color=#447700>! scale factor applied to time window for surface obs  <a name='115'></font>
  REAL, intent(in)     :: sfcfacr      <font color=#447700>! scale fac applied to horiz rad of infl for sfc obs<a name='116'></font>
  REAL, intent(in)     :: dpsmx        <font color=#447700>! max press change allowed within hor rad of infl<a name='117'></font>
  INTEGER , INTENT(IN) :: nudge_wind(maxdom)       <font color=#447700>! wind-nudging flag<a name='118'></font>
  INTEGER , INTENT(IN) :: nudge_temp(maxdom)       <font color=#447700>! temperature-nudging flag<a name='119'></font>
  INTEGER , INTENT(IN) :: nudge_mois(maxdom)       <font color=#447700>! moisture-nudging flag<a name='120'></font>
  REAL, INTENT(IN)     :: nudgezfullr1_uv  <font color=#447700>! vert infl fcn, regime=1 full-wt   hght, winds<a name='121'></font>
  REAL, INTENT(IN)     :: nudgezrampr1_uv  <font color=#447700>! vert infl fcn, regime=1 ramp down hght, winds<a name='122'></font>
  REAL, INTENT(IN)     :: nudgezfullr2_uv  <font color=#447700>! vert infl fcn, regime=2 full-wt   hght, winds<a name='123'></font>
  REAL, INTENT(IN)     :: nudgezrampr2_uv  <font color=#447700>! vert infl fcn, regime=2 ramp down hght, winds<a name='124'></font>
  REAL, INTENT(IN)     :: nudgezfullr4_uv  <font color=#447700>! vert infl fcn, regime=4 full-wt   hght, winds<a name='125'></font>
  REAL, INTENT(IN)     :: nudgezrampr4_uv  <font color=#447700>! vert infl fcn, regime=4 ramp down hght, winds<a name='126'></font>
  REAL, INTENT(IN)     :: nudgezfullr1_t   <font color=#447700>! vert infl fcn, regime=1 full-wt   hght, temp<a name='127'></font>
  REAL, INTENT(IN)     :: nudgezrampr1_t   <font color=#447700>! vert infl fcn, regime=1 ramp down hght, temp<a name='128'></font>
  REAL, INTENT(IN)     :: nudgezfullr2_t   <font color=#447700>! vert infl fcn, regime=2 full-wt   hght, temp<a name='129'></font>
  REAL, INTENT(IN)     :: nudgezrampr2_t   <font color=#447700>! vert infl fcn, regime=2 ramp down hght, temp<a name='130'></font>
  REAL, INTENT(IN)     :: nudgezfullr4_t   <font color=#447700>! vert infl fcn, regime=4 full-wt   hght, temp<a name='131'></font>
  REAL, INTENT(IN)     :: nudgezrampr4_t   <font color=#447700>! vert infl fcn, regime=4 ramp down hght, temp<a name='132'></font>
  REAL, INTENT(IN)     :: nudgezfullr1_q   <font color=#447700>! vert infl fcn, regime=1 full-wt   hght, mois<a name='133'></font>
  REAL, INTENT(IN)     :: nudgezrampr1_q   <font color=#447700>! vert infl fcn, regime=1 ramp down hght, mois<a name='134'></font>
  REAL, INTENT(IN)     :: nudgezfullr2_q   <font color=#447700>! vert infl fcn, regime=2 full-wt   hght, mois<a name='135'></font>
  REAL, INTENT(IN)     :: nudgezrampr2_q   <font color=#447700>! vert infl fcn, regime=2 ramp down hght, mois<a name='136'></font>
  REAL, INTENT(IN)     :: nudgezfullr4_q   <font color=#447700>! vert infl fcn, regime=4 full-wt   hght, mois<a name='137'></font>
  REAL, INTENT(IN)     :: nudgezrampr4_q   <font color=#447700>! vert infl fcn, regime=4 ramp down hght, mois<a name='138'></font>
  REAL, INTENT(IN)     :: nudgezfullmin    <font color=#447700>! min dpth thru which vert infl fcn remains 1.0 (m)<a name='139'></font>
  REAL, INTENT(IN)     :: nudgezrampmin    <font color=#447700>! min dpth thru which vif decreases 1.0 to 0.0 (m)<a name='140'></font>
  REAL, INTENT(IN)     :: nudgezmax        <font color=#447700>! max dpth in which vif is nonzero (m)<a name='141'></font>
  REAL, INTENT(IN)     :: xlat ( ims:ime, jms:jme )        <font color=#447700>! latitudes on mass-point grid<a name='142'></font>
  REAL, INTENT(IN)     :: xlong( ims:ime, jms:jme )        <font color=#447700>! longitudes on mass-point grid<a name='143'></font>
  INTEGER, intent(in)  :: start_year   <font color=#447700>! Model start year<a name='144'></font>
  INTEGER, intent(in)  :: start_month  <font color=#447700>! Model start month<a name='145'></font>
  INTEGER, intent(in)  :: start_day    <font color=#447700>! Model start day<a name='146'></font>
  INTEGER, intent(in)  :: start_hour   <font color=#447700>! Model start hour<a name='147'></font>
  INTEGER, intent(in)  :: start_minute <font color=#447700>! Model start minute<a name='148'></font>
  INTEGER, intent(in)  :: start_second <font color=#447700>! Model start second<a name='149'></font>
  REAL, INTENT(IN)     :: p00          <font color=#447700>! base state pressure<a name='150'></font>
  REAL, INTENT(IN)     :: t00          <font color=#447700>! base state temperature<a name='151'></font>
  REAL, INTENT(IN)     :: tlp          <font color=#447700>! base state lapse rate<a name='152'></font>
  REAL, INTENT(IN)     :: p_top        <font color=#447700>! pressure at top of model<a name='153'></font>
  REAL, INTENT(IN)     :: znu( kms:kme )      <font color=#447700>! eta values on half (mass) levels<a name='154'></font>
#if ( EM_CORE == 1 ) <a name='155'>
  TYPE(fdob_type), intent(inout)  :: fdob<a name='156'>
#endif<a name='157'>
  LOGICAL, intent(in)  :: iprt         <font color=#447700>! Flag enabling printing warning messages<a name='158'></font>
<a name='159'>
<font color=#447700>! Local variables<a name='160'></font>
  logical            :: nudge_flag      <font color=#447700>! nudging flag for this nest <a name='161'></font>
  integer            :: ktau            <font color=#447700>! current timestep<a name='162'></font>
  integer            :: nest            <font color=#447700>! loop counter<a name='163'></font>
  integer            :: idom            <font color=#447700>! domain id<a name='164'></font>
  integer            :: parent          <font color=#447700>! parent domain<a name='165'></font>
  real               :: conv            <font color=#447700>! 180/pi<a name='166'></font>
  real               :: tl1             <font color=#447700>! Lambert standard parallel 1<a name='167'></font>
  real               :: tl2             <font color=#447700>! Lambert standard parallel 2<a name='168'></font>
  real               :: xn1<a name='169'>
  real               :: known_lat       <font color=#447700>! Latitude of domain point (i,j)=(1,1)<a name='170'></font>
  real               :: known_lon       <font color=#447700>! Longitude of domain point (i,j)=(1,1) <a name='171'></font>
  character(len=200) :: msg             <font color=#447700>! Argument to wrf_message<a name='172'></font>
  real               :: z_at_p( kms:kme )  <font color=#447700>! height at p levels<a name='173'></font>
  integer            :: i,j,k           <font color=#447700>! loop counters<a name='174'></font>
<a name='175'>
#if ( EM_CORE == 1 ) <a name='176'>
<a name='177'>
<font color=#447700>! Check to see if the nudging flag has been set. If not,<a name='178'></font>
<font color=#447700>! simply RETURN.<a name='179'></font>
  nudge_flag = (nudge_opt(inest) .eq. 1)<a name='180'>
  if (.not. nudge_flag) return<a name='181'>
<a name='182'>
  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_722">("")<a name='183'>
  write(msg,fmt='(a,i2)') ' OBSERVATION NUDGING IS ACTIVATED FOR MESH ',inest<a name='184'>
  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_723">(msg)<a name='185'>
<a name='186'>
  ktau  = itimestep<a name='187'>
  if(restart) then<a name='188'>
    fdob%ktaur = ktau<a name='189'>
  else<a name='190'>
    fdob%ktaur = 0 <a name='191'>
  endif<a name='192'>
<a name='193'>
<font color=#447700>! Create character string containing model starting-date<a name='194'></font>
  CALL <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#DATE_STRING'>date_string</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DATE_STRING_1">(start_year, start_month, start_day, start_hour,        &amp;<a name='195'>
                   start_minute, start_second, fdob%sdate)<a name='196'>
<a name='197'>
<font color=#447700>! Set flag for nudging on pressure (not sigma) surfaces.<a name='198'></font>
  fdob%iwtsig = 0<a name='199'>
<a name='200'>
<font color=#447700>!**************************************************************************<a name='201'></font>
<font color=#447700>! *** Initialize datend for dynamic initialization (ajb added 08132008) ***<a name='202'></font>
<font color=#447700>!**************************************************************************<a name='203'></font>
<font color=#447700>! Set ending nudging date (used with dynamic ramp-down) to zero.<a name='204'></font>
  fdob%datend = 0.<a name='205'>
  fdob%ieodi = 0<a name='206'>
<a name='207'>
<font color=#447700>! Check for dynamic initialization flag<a name='208'></font>
  if(idynin.eq.1)then<a name='209'>
<font color=#447700>!    Set datend to time in minutes after which data are assumed to have ended.<a name='210'></font>
     if(dtramp.gt.0.)then<a name='211'>
        fdob%datend = fdaend(inest) - dtramp<a name='212'>
     else<a name='213'>
        fdob%datend = fdaend(inest)<a name='214'>
     endif<a name='215'>
     if(iprt) then<a name='216'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_724">("")<a name='217'>
        write(msg,fmt='(a,i3,a)')                                              &amp;<a name='218'>
          ' *** DYNAMIC-INITIALIZATION OPTION FOR INEST = ', inest, ' ***'<a name='219'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_725">(msg)<a name='220'>
        write(msg,*) ' FDAEND,DATEND,DTRAMP: ',fdaend(inest),fdob%datend,dtramp<a name='221'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_726">(msg)<a name='222'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_727">("")<a name='223'>
     endif<a name='224'>
  endif<a name='225'>
<font color=#447700>! *** end dynamic initialization section ***<a name='226'></font>
<font color=#447700>!**************************************************************************<a name='227'></font>
<a name='228'>
<font color=#447700>! Store flags for surface obs spreading schemes<a name='229'></font>
  if(sfc_scheme_horiz.eq.1) then<a name='230'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_728">('MM5 scheme selected for horizontal spreading of surface obs')<a name='231'>
  elseif (sfc_scheme_horiz.eq.0) then<a name='232'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_729">('WRF scheme selected for horizontal spreading of surface obs')<a name='233'>
  else<a name='234'>
     write(msg,fmt='(a,i3)') 'Unknown h-spreading scheme for surface obs: ',sfc_scheme_horiz<a name='235'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_730">(msg)<a name='236'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_731">("Valid selections: 0=WRF scheme, 1=Original MM5 scheme")<a name='237'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_679"> ( 'fddaobs_init: module_fddaobs_rtfdda STOP' )<a name='238'>
  endif<a name='239'>
<a name='240'>
  if(sfc_scheme_vert.eq.1) then<a name='241'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_732">('Original simple scheme selected for vertical spreading of surface obs')<a name='242'>
  elseif (sfc_scheme_vert.eq.0) then<a name='243'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_733">("Regime-based VIF scheme selected for vertical spreading of surface obs")<a name='244'>
  else<a name='245'>
     write(msg,fmt='(a,i3)') 'Unknown v-spreading scheme for surface obs: ',sfc_scheme_vert<a name='246'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_734">(msg)<a name='247'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_735">("Valid selections: 0=Regime-based VIF scheme, 1=Original simple scheme")<a name='248'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_680"> ( 'fddaobs_init: module_fddaobs_rtfdda STOP' )<a name='249'>
  endif<a name='250'>
  fdob%sfc_scheme_horiz = sfc_scheme_horiz <a name='251'>
  fdob%sfc_scheme_vert  = sfc_scheme_vert<a name='252'>
<a name='253'>
<a name='254'>
<font color=#447700>! Store temporal and spatial scales<a name='255'></font>
  fdob%sfcfact = sfcfact<a name='256'>
  fdob%sfcfacr = sfcfacr<a name='257'>
<a name='258'>
<font color=#447700>! Set time window.<a name='259'></font>
  fdob%window = twindo<a name='260'>
  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_736">("")<a name='261'>
  write(msg,fmt='(a,i3)') '*** TIME WINDOW SETTINGS FOR NEST ',inest<a name='262'>
  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_737">(msg)<a name='263'>
  write(msg,fmt='(a,f6.3,2(a,f5.3))') '    TWINDO (hrs) = ',twindo,      &amp;<a name='264'>
            '  SFCFACT = ',sfcfact,'  SFCFACR = ',sfcfacr<a name='265'>
  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_738">(msg)<a name='266'>
  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_739">("")<a name='267'>
<a name='268'>
  if(inest.eq.1) then<a name='269'>
    if(twindo .eq. 0.) then<a name='270'>
      if(iprt) then<a name='271'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_740">("")<a name='272'>
        write(msg,*) '*** WARNING: TWINDO=0 on the coarse domain.'<a name='273'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_741">(msg)<a name='274'>
        write(msg,*) '*** Did you forget to set twindo in the fdda namelist?'<a name='275'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_742">(msg)<a name='276'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_743">("")<a name='277'>
      endif<a name='278'>
    endif<a name='279'>
  else        <font color=#447700>! nest<a name='280'></font>
    if(twindo .eq. 0.) then<a name='281'>
      fdob%window = twindo_cg<a name='282'>
      if(iprt) then<a name='283'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_744">("")<a name='284'>
        write(msg,fmt='(a,i2)') 'WARNING: TWINDO=0. for nest ',inest<a name='285'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_745">(msg)<a name='286'>
        write(msg,fmt='(a,f12.5,a)') 'Default to coarse-grid value of ', twindo_cg,' hrs'<a name='287'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_746">(msg)<a name='288'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_747">("")<a name='289'>
      endif<a name='290'>
    endif<a name='291'>
  endif<a name='292'>
<a name='293'>
<font color=#447700>! Initialize flags.<a name='294'></font>
<a name='295'>
  fdob%domain_tot=0<a name='296'>
  do nest=1,maxdom<a name='297'>
    fdob%domain_tot = fdob%domain_tot + nudge_opt(nest)<a name='298'>
  end do<a name='299'>
<a name='300'>
<font color=#447700>! Calculate and store dcon from dpsmx<a name='301'></font>
  if(dpsmx.gt.0.) then<a name='302'>
       fdob%dpsmx = dpsmx<a name='303'>
       fdob%dcon = 1.0/fdob%dpsmx<a name='304'>
  else <a name='305'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_681">('fddaobs_init: Namelist variable dpsmx must be greater than zero<font color=#447700>!')<a name='306'></font>
  endif<a name='307'>
<a name='308'>
<font color=#447700>! Calculate and store base-state heights at half (mass) levels.<a name='309'></font>
  CALL <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#GET_BASE_STATE_HEIGHT_COLUMN'>get_base_state_height_column</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_BASE_STATE_HEIGHT_COLUMN_1">( p_top, p00, t00, tlp, g, r_d, znu,   &amp;<a name='310'>
                                     fdob%base_state,  kts, kte, kds,kde, kms,kme )<a name='311'>
<a name='312'>
<font color=#447700>! Initialize flags for nudging within PBL.<a name='313'></font>
  fdob%nudge_uv_pbl  = .true.<a name='314'>
  fdob%nudge_t_pbl   = .true.<a name='315'>
  fdob%nudge_q_pbl   = .true.<a name='316'>
  if(no_pbl_nudge_uv(inest) .eq. 1) fdob%nudge_uv_pbl  = .false.<a name='317'>
  if(no_pbl_nudge_t(inest) .eq. 1)  fdob%nudge_t_pbl   = .false.<a name='318'>
  if(no_pbl_nudge_q(inest) .eq. 1)  fdob%nudge_q_pbl   = .false.<a name='319'>
<a name='320'>
  if(no_pbl_nudge_uv(inest) .eq. 1) then<a name='321'>
    fdob%nudge_uv_pbl  = .false.<a name='322'>
    write(msg,*) '   --&gt; Obs nudging for U/V is turned off in PBL'<a name='323'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_748">(msg)<a name='324'>
  endif<a name='325'>
  if(no_pbl_nudge_t(inest) .eq. 1)  then<a name='326'>
    fdob%nudge_t_pbl   = .false.<a name='327'>
    write(msg,*) '   --&gt; Obs nudging for T is turned off in PBL'<a name='328'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_749">(msg)<a name='329'>
  endif<a name='330'>
  if(no_pbl_nudge_q(inest) .eq. 1)  then<a name='331'>
    fdob%nudge_q_pbl   = .false.<a name='332'>
    write(msg,*) '   --&gt; Obs nudging for Q is turned off in PBL'<a name='333'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_750">(msg)<a name='334'>
  endif<a name='335'>
<a name='336'>
<font color=#447700>! Store max allowed pressure gap for interpolating between soundings<a name='337'></font>
  fdob%max_sndng_gap = maxsnd_gap<a name='338'>
  write(msg,fmt='(a,f6.1)')  &amp;<a name='339'>
  '*** MAX PRESSURE GAP (cb) for interpolation between soundings = ',maxsnd_gap<a name='340'>
  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_751">(msg)<a name='341'>
  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_752">("")<a name='342'>
<a name='343'>
<font color=#447700>! Initialize vertical influence fcn for LML obs <a name='344'></font>
  if(sfc_scheme_vert.eq.0) then<a name='345'>
    fdob%vif_uv(1) = nudgezfullr1_uv<a name='346'>
    fdob%vif_uv(2) = nudgezrampr1_uv<a name='347'>
    fdob%vif_uv(3) = nudgezfullr2_uv<a name='348'>
    fdob%vif_uv(4) = nudgezrampr2_uv<a name='349'>
    fdob%vif_uv(5) = nudgezfullr4_uv<a name='350'>
    fdob%vif_uv(6) = nudgezrampr4_uv<a name='351'>
    fdob%vif_t (1) = nudgezfullr1_t<a name='352'>
    fdob%vif_t (2) = nudgezrampr1_t<a name='353'>
    fdob%vif_t (3) = nudgezfullr2_t<a name='354'>
    fdob%vif_t (4) = nudgezrampr2_t<a name='355'>
    fdob%vif_t (5) = nudgezfullr4_t<a name='356'>
    fdob%vif_t (6) = nudgezrampr4_t<a name='357'>
    fdob%vif_q (1) = nudgezfullr1_q<a name='358'>
    fdob%vif_q (2) = nudgezrampr1_q<a name='359'>
    fdob%vif_q (3) = nudgezfullr2_q<a name='360'>
    fdob%vif_q (4) = nudgezrampr2_q<a name='361'>
    fdob%vif_q (5) = nudgezfullr4_q<a name='362'>
    fdob%vif_q (6) = nudgezrampr4_q<a name='363'>
<a name='364'>
<font color=#447700>! Sanity checks<a name='365'></font>
    if(nudgezmax.le.0.) then<a name='366'>
      write(msg,*) 'STOP<font color=#447700>! OBS NAMELIST INPUT obs_nudgezmax MUST BE GREATER THAN ZERO.'<a name='367'></font>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_753">(msg)<a name='368'>
      write(msg,*) 'THE NAMELIST VALUE IS',nudgezmax<a name='369'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_754">(msg)<a name='370'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_682"> ( 'fddaobs_init: STOP on bad obs_nudgemax value' )<a name='371'>
    endif<a name='372'>
    if(nudgezfullmin.lt.0.) then<a name='373'>
      write(msg,*) 'STOP<font color=#447700>! OBS NAMELIST INPUT obs_nudgezfullmin MUST BE NONNEGATIVE.'<a name='374'></font>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_755">(msg)<a name='375'>
      write(msg,*) 'THE NAMELIST VALUE IS',nudgezfullmin<a name='376'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_756">(msg)<a name='377'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_683"> ( 'fddaobs_init: STOP on bad obs_nudgefullmin value' )<a name='378'>
    endif<a name='379'>
    if(nudgezrampmin.lt.0.) then<a name='380'>
      write(msg,*) 'STOP<font color=#447700>! OBS NAMELIST INPUT obs_nudgezrampmin MUST BE NONNEGATIVE.'<a name='381'></font>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_757">(msg)<a name='382'>
      write(msg,*) 'THE NAMELIST VALUE IS',nudgezrampmin<a name='383'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_758">(msg)<a name='384'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_684"> ( 'fddaobs_init: STOP on bad obs_nudgerampmin value' )<a name='385'>
    endif<a name='386'>
    if(nudgezmax.lt.nudgezfullmin+nudgezrampmin) then<a name='387'>
      write(msg,*) 'STOP<font color=#447700>! INCONSISTENT OBS NAMELIST INPUTS.'<a name='388'></font>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_759">(msg)<a name='389'>
      write(msg,fmt='(3(a,f12.3))') 'obs_nudgezmax = ',nudgezmax,                &amp;<a name='390'>
                              ' obs_nudgezfullmin = ',nudgezfullmin,       &amp;<a name='391'>
                              ' obs_nudgezrampmin = ',nudgezrampmin<a name='392'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_760">(msg)<a name='393'>
      write(msg,*) 'REQUIRE NUDGEZMAX &gt;= NUDGEZFULLMIN + NUDGEZRAMPMIN'<a name='394'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_761">(msg)<a name='395'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_685"> ( 'fddaobs_init: STOP on inconsistent namelist values' )<a name='396'>
    endif<a name='397'>
 <a name='398'>
    fdob%vif_fullmin = nudgezfullmin<a name='399'>
    fdob%vif_rampmin = nudgezrampmin<a name='400'>
    fdob%vif_max     = nudgezmax<a name='401'>
 <a name='402'>
<font color=#447700>! Check to make sure that if nudgzfullmin &gt; 0, then it must be at least as large as the<a name='403'></font>
<font color=#447700>! first model half-level will be anywhere in the domain at any time within the simulation.<a name='404'></font>
<font color=#447700>! We use 1.1 times the base-state value fdob%base_state(1) for this purpose. <a name='405'></font>
<a name='406'>
    if(nudgezfullmin.gt.0.0) then<a name='407'>
        if(nudgezfullmin .lt. 1.1*fdob%base_state(1)) then<a name='408'>
           fdob%vif_fullmin = 1.1*fdob%base_state(1)<a name='409'>
        endif<a name='410'>
    endif<a name='411'>
<a name='412'>
<font color=#447700>! Print vertical weight info only if wind, temperature, or moisture nudging is requested.<a name='413'></font>
    if( (nudge_wind(inest).eq.1) .or. (nudge_temp(inest).eq.1)                             &amp;<a name='414'>
                                               .or. (nudge_mois(inest).eq.1) ) then<a name='415'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_762">("")<a name='416'>
    write(msg,fmt='(a,i2,a)') ' *** SETUP DESCRIPTION FOR SURFACE OBS NUDGING ON MESH ',inest,' :'<a name='417'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_763">(msg)<a name='418'>
<a name='419'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_764">("")<a name='420'>
    write(msg,fmt='(a,i5,a)') '  NUDGEZMAX: The maximum height at which nudging will be'//     &amp;<a name='421'>
                        ' applied from surface obs is ', nint(nudgezmax),' m AGL.'<a name='422'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_765">(msg)<a name='423'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_766">("")<a name='424'>
    write(msg,fmt='(a,i3,a)') '  NUDGEZFULLMIN: The minimum height of full nudging weight'//   &amp;<a name='425'>
                          ' for surface obs is ', nint(fdob%vif_fullmin),' m.'<a name='426'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_767">(msg)<a name='427'>
    if(nudgezfullmin.lt.fdob%vif_fullmin) then<a name='428'>
        write(msg,fmt='(a,i3,a)') '  ***WARNING***: NUDGEZFULLMIN has been increased from'//   &amp;<a name='429'>
                              ' the user-input value of ',nint(nudgezfullmin),' m.'<a name='430'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_768">(msg)<a name='431'>
        write(msg,fmt='(a,i3,a)') '  to ensure that at least the bottom model level is'//      &amp;<a name='432'>
                              ' included in full nudging.'<a name='433'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_769">(msg)<a name='434'>
    endif<a name='435'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_770">("")<a name='436'>
    write(msg,fmt='(a,i3,a)') '  NUDGEZRAMPMIN: The minimum height to ramp from full to no'//  &amp;<a name='437'>
                          ' nudging for surface obs is ', nint(nudgezrampmin),' m.'<a name='438'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_771">(msg)<a name='439'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_772">("")<a name='440'>
    endif   <font color=#447700>!endif either wind, temperature, or moisture nudging is requested<a name='441'></font>
<a name='442'>
<font color=#447700>! Print vif settings<a name='443'></font>
    if(nudge_wind(inest) .eq. 1) then<a name='444'>
      call <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_VAR'>print_vif_var</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PRINT_VIF_VAR_1">('wind', fdob%vif_uv, nudgezfullmin, nudgezrampmin)<a name='445'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_773">("")<a name='446'>
    endif<a name='447'>
    if(nudge_temp(inest) .eq. 1) then<a name='448'>
      call <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_VAR'>print_vif_var</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PRINT_VIF_VAR_2">('temp', fdob%vif_t,  nudgezfullmin, nudgezrampmin)<a name='449'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_774">("")<a name='450'>
    endif<a name='451'>
    if(nudge_mois(inest) .eq. 1) then<a name='452'>
      call <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_VAR'>print_vif_var</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PRINT_VIF_VAR_3">('mois', fdob%vif_q,  nudgezfullmin, nudgezrampmin)<a name='453'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_775">("")<a name='454'>
    endif<a name='455'>
<a name='456'>
    if( (nudge_wind(inest).eq.1) .or. (nudge_temp(inest).eq.1)                             &amp;<a name='457'>
                                                 .or. (nudge_mois(inest).eq.1) ) then<a name='458'>
    write(msg,fmt='(a,i2)') ' *** END SETUP DESCRIPTION FOR SURFACE OBS NUDGING ON MESH ',inest<a name='459'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_776">(msg)<a name='460'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_777">("")<a name='461'>
    endif<a name='462'>
  endif   <font color=#447700>!endif(sfc_scheme_vert.EQ.0)<a name='463'></font>
<a name='464'>
<font color=#447700>! Set parameters.<a name='465'></font>
  fdob%pfree = 50.0<a name='466'>
  fdob%rinfmn = 1.0<a name='467'>
  fdob%rinfmx = 2.0<a name='468'>
<a name='469'>
<font color=#447700>! Get known lat and lon and store these on all processors in fdob structure, for<a name='470'></font>
<font color=#447700>! later use in projection x-formation to map (lat,lon) to (x,y) for each obs.<a name='471'></font>
      IF (its .eq. 1 .AND. jts .eq. 1) then<a name='472'>
         known_lat = xlat(1,1)<a name='473'>
         known_lon = xlong(1,1)<a name='474'>
      ELSE<a name='475'>
         known_lat = 9999.<a name='476'>
         known_lon = 9999.<a name='477'>
      END IF<a name='478'>
      fdob%known_lat = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REAL'>wrf_dm_min_real</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REAL_3">(known_lat)<a name='479'>
      fdob%known_lon = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REAL'>wrf_dm_min_real</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#FDDAOBS_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REAL_4">(known_lon)<a name='480'>
<a name='481'>
<font color=#447700>! Calculate the nest levels, levidn. Note that each nest<a name='482'></font>
<font color=#447700>! must know the nest levels levidn(maxdom) of each domain.<a name='483'></font>
  do nest=1,maxdom<a name='484'>
<a name='485'>
<font color=#447700>! Initialize nest level for each domain.<a name='486'></font>
    if (nest .eq. 1) then<a name='487'>
      fdob%levidn(nest) = 0  <font color=#447700>! Mother domain has nest level 0<a name='488'></font>
    else<a name='489'>
      fdob%levidn(nest) = 1  <font color=#447700>! All other domains start with 1<a name='490'></font>
    endif<a name='491'>
    idom = nest<a name='492'>
100 parent = parid(idom)      <font color=#447700>! Go up the parent tree<a name='493'></font>
<a name='494'>
      if (parent .gt. 1) then   <font color=#447700>! If not up to mother domain<a name='495'></font>
        fdob%levidn(nest) = fdob%levidn(nest) + 1<a name='496'>
        idom = parent<a name='497'>
        goto 100<a name='498'>
      endif<a name='499'>
  enddo<a name='500'>
<a name='501'>
<a name='502'>
<font color=#447700>! fdob%LML_OBS_HT1_LEV = kte <a name='503'></font>
<font color=#447700>! HT1: do k = kte, kts, -1<a name='504'></font>
<font color=#447700>!        if( LML_HT1 .gt. z_at_p(k) ) then<a name='505'></font>
<font color=#447700>!          fdob%LML_OBS_HT1_LEV = k<a name='506'></font>
<font color=#447700>!          EXIT HT1 <a name='507'></font>
<font color=#447700>!        endif<a name='508'></font>
<font color=#447700>!      enddo  HT1<a name='509'></font>
<a name='510'>
<font color=#447700>! fdob%LML_OBS_HT2_LEV = kte <a name='511'></font>
<font color=#447700>! HT2: do k = kte, kts, -1<a name='512'></font>
<font color=#447700>!        if( LML_HT2 .gt. z_at_p(k) ) then<a name='513'></font>
<font color=#447700>!          fdob%LML_OBS_HT2_LEV = k<a name='514'></font>
<font color=#447700>!          EXIT HT2 <a name='515'></font>
<font color=#447700>!        endif<a name='516'></font>
<font color=#447700>!      enddo HT2 <a name='517'></font>
  RETURN<a name='518'>
#endif<a name='519'>
  END SUBROUTINE fddaobs_init<a name='520'>
<a name='521'>
#if ( EM_CORE == 1 )<a name='522'>
<font color=#447700>!-----------------------------------------------------------------------<a name='523'></font>
<A NAME='ERROB'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='524'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>errob</font>(inest, ub, vb, tb, t0, qvb, pbase, pp, rovcp,  &amp; <A href='../../call_to/ERROB.html' TARGET='index'>1</A>,<A href='../../call_from/ERROB.html' TARGET='index'>15</A><a name='525'>
                 z,                                             &amp;<a name='526'>
                 uratx, vratx, tratx, kpbl,                     &amp;<a name='527'>
                 nndgv, nerrf, niobf, maxdom,                   &amp;<a name='528'>
                 levidn, parid, nstat, nstaw,                   &amp;<a name='529'>
                 iswind, istemp, ismois, ispstr,                &amp;<a name='530'>
                 timeob, rio, rjo, rko,                         &amp;<a name='531'>
                 varobs, errf, ktau, xtime,                     &amp;<a name='532'>
                 iratio, npfi,                                  &amp;<a name='533'>
                 prt_max, prt_freq, iprt,                       &amp;<a name='534'>
                 obs_prt, stnid_prt, lat_prt, lon_prt,          &amp;<a name='535'>
                 mlat_prt, mlon_prt,                            &amp; <a name='536'>
                 ids,ide, jds,jde, kds,kde,                     &amp;<a name='537'>
                 ims,ime, jms,jme, kms,kme,                     &amp;<a name='538'>
                 its,ite, jts,jte, kts,kte  )<a name='539'>
<a name='540'>
<font color=#447700>!-----------------------------------------------------------------------<a name='541'></font>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='542'></font>
  USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_149">, ONLY : get_full_obs_vector, wrf_dm_sum_real<a name='543'>
#else<a name='544'>
  USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_150">, ONLY :                      wrf_dm_sum_real<a name='545'>
#endif<a name='546'>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_65">, ONLY : rcp<a name='547'>
<a name='548'>
<font color=#447700>!-----------------------------------------------------------------------<a name='549'></font>
  IMPLICIT NONE<a name='550'>
<font color=#447700>!-----------------------------------------------------------------------<a name='551'></font>
<font color=#447700>!<a name='552'></font>
<font color=#447700>! PURPOSE: THIS SUBROUTINE CALCULATES THE DIFFERENCE BETWEEN THE<a name='553'></font>
<font color=#447700>!     OBSERVED VALUES AND THE FORECAST VALUES AT THE OBSERVATION<a name='554'></font>
<font color=#447700>!     POINTS.  THE OBSERVED VALUES CLOSEST TO THE CURRENT<a name='555'></font>
<font color=#447700>!     FORECAST TIME (XTIME) WERE DETERMINED IN SUBROUTINE<a name='556'></font>
<font color=#447700>!     IN4DOB AND STORED IN ARRAY VAROBS.  THE DIFFERENCES<a name='557'></font>
<font color=#447700>!     CALCULATED BY SUBROUTINE ERROB WILL BE STORED IN ARRAY<a name='558'></font>
<font color=#447700>!     ERRF FOR THE NSTA OBSERVATION LOCATIONS.  MISSING<a name='559'></font>
<font color=#447700>!     OBSERVATIONS ARE DENOTED BY THE DUMMY VALUE 99999.<a name='560'></font>
<font color=#447700>!<a name='561'></font>
<font color=#447700>!     HISTORY: Original author: MM5 version???<a name='562'></font>
<font color=#447700>!              02/04/2004 - Creation of WRF version.           Al Bourgeois<a name='563'></font>
<font color=#447700>!              08/28/2006 - Conversion from F77 to F90         Al Bourgeois<a name='564'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='565'></font>
<a name='566'>
<font color=#447700>! THE STORAGE ORDER IN ERRF IS AS FOLLOWS:<a name='567'></font>
<font color=#447700>!        IVAR                VARIABLE TYPE(TAU-1)<a name='568'></font>
<font color=#447700>!        ----                --------------------<a name='569'></font>
<font color=#447700>!         1                    U error at obs loc<a name='570'></font>
<font color=#447700>!         2                    V error at obs loc<a name='571'></font>
<font color=#447700>!         3                    T error at obs loc<a name='572'></font>
<font color=#447700>!         4                    Q error at obs loc<a name='573'></font>
<font color=#447700>!         5                    Vertical layer index for PBL top at IOB, JOB<a name='574'></font>
<font color=#447700>!         6                    Model surface press at obs loc (T-points)<a name='575'></font>
<font color=#447700>!         7                    Model surface press at obs loc (U-points)<a name='576'></font>
<font color=#447700>!         8                    Model surface press at obs loc (V-points)<a name='577'></font>
<font color=#447700>!         9                    RKO at U-points<a name='578'></font>
<font color=#447700>!         10                   Model Q at obs loc (T-points)<a name='579'></font>
<a name='580'>
<font color=#447700>!-----------------------------------------------------------------------<a name='581'></font>
<font color=#447700>!<a name='582'></font>
<font color=#447700>!     Description of input arguments.<a name='583'></font>
<font color=#447700>!<a name='584'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='585'></font>
<a name='586'>
  INTEGER, INTENT(IN)  :: inest                  <font color=#447700>! Domain index.<a name='587'></font>
  INTEGER, INTENT(IN)  :: nndgv                  <font color=#447700>! Number of nudge variables.<a name='588'></font>
  INTEGER, INTENT(IN)  :: nerrf                  <font color=#447700>! Number of error fields.<a name='589'></font>
  INTEGER, INTENT(IN)  :: niobf                  <font color=#447700>! Number of observations.<a name='590'></font>
  INTEGER, INTENT(IN)  :: maxdom                 <font color=#447700>! Maximum number of domains.<a name='591'></font>
  INTEGER, INTENT(IN)  :: levidn(maxdom)         <font color=#447700>! Level of nest.<a name='592'></font>
  INTEGER, INTENT(IN)  :: parid(maxdom)          <font color=#447700>! Id of parent grid.<a name='593'></font>
  INTEGER, INTENT(IN)  :: ktau                   <font color=#447700>! Model time step index<a name='594'></font>
  REAL, INTENT(IN)     :: xtime                  <font color=#447700>! Forecast time in minutes<a name='595'></font>
  INTEGER, INTENT(IN)  :: iratio                 <font color=#447700>! Nest to parent gridsize ratio.<a name='596'></font>
  INTEGER, INTENT(IN)  :: npfi                   <font color=#447700>! Coarse-grid diagnostics freq.<a name='597'></font>
  INTEGER, INTENT(IN)  :: prt_max                <font color=#447700>! Max number of obs to print.<a name='598'></font>
  INTEGER, INTENT(IN)  :: prt_freq               <font color=#447700>! Frequency of obs to print.<a name='599'></font>
  LOGICAL, INTENT(IN)  :: iprt                   <font color=#447700>! Print flag<a name='600'></font>
  INTEGER, INTENT(IN)  :: obs_prt(prt_max)       <font color=#447700>! Print obs indices<a name='601'></font>
  INTEGER, INTENT(IN)  :: stnid_prt(40,prt_max)  <font color=#447700>! Print obs station ids<a name='602'></font>
  REAL, INTENT(IN)     :: lat_prt(prt_max)       <font color=#447700>! Print obs latitude<a name='603'></font>
  REAL, INTENT(IN)     :: lon_prt(prt_max)       <font color=#447700>! Print obs longitude<a name='604'></font>
  REAL, INTENT(IN)     :: mlat_prt(prt_max)      <font color=#447700>! Print model lat at obs loc<a name='605'></font>
  REAL, INTENT(IN)     :: mlon_prt(prt_max)      <font color=#447700>! Print model lon at obs loc<a name='606'></font>
  INTEGER, INTENT(IN)  :: nstat                  <font color=#447700>! # stations held for use<a name='607'></font>
  INTEGER, INTENT(IN)  :: nstaw                  <font color=#447700>! # stations in current window<a name='608'></font>
  INTEGER, intent(in)  :: iswind<a name='609'>
  INTEGER, intent(in)  :: istemp<a name='610'>
  INTEGER, intent(in)  :: ismois<a name='611'>
  INTEGER, intent(in)  :: ispstr<a name='612'>
  INTEGER, INTENT(IN)  :: ids,ide, jds,jde, kds,kde  <font color=#447700>! domain dims.<a name='613'></font>
  INTEGER, INTENT(IN)  :: ims,ime, jms,jme, kms,kme  <font color=#447700>! memory dims.<a name='614'></font>
  INTEGER, INTENT(IN)  :: its,ite, jts,jte, kts,kte  <font color=#447700>! tile   dims.<a name='615'></font>
<a name='616'>
  REAL,   INTENT(IN) :: ub( ims:ime, kms:kme, jms:jme )<a name='617'>
  REAL,   INTENT(IN) :: vb( ims:ime, kms:kme, jms:jme )<a name='618'>
  REAL,   INTENT(IN) :: tb( ims:ime, kms:kme, jms:jme )<a name='619'>
  REAL,   INTENT(IN) :: t0<a name='620'>
  REAL,   INTENT(IN) :: qvb( ims:ime, kms:kme, jms:jme )<a name='621'>
  REAL,   INTENT(IN) :: pbase( ims:ime, kms:kme, jms:jme )<a name='622'>
  REAL,   INTENT(IN) :: pp( ims:ime, kms:kme, jms:jme ) <font color=#447700>! Press. perturbation (Pa)<a name='623'></font>
  REAL,   INTENT(IN)  :: rovcp<a name='624'>
  REAL,    INTENT(IN) :: z( ims:ime, kms:kme, jms:jme ) <font color=#447700>! Ht above sl on half-levels<a name='625'></font>
  REAL,   INTENT(IN) :: uratx( ims:ime, jms:jme ) <font color=#447700>! U to U10 ratio on mass points.<a name='626'></font>
  REAL,   INTENT(IN) :: vratx( ims:ime, jms:jme ) <font color=#447700>! V to V10 ratio on mass points.<a name='627'></font>
  REAL,   INTENT(IN) :: tratx( ims:ime, jms:jme ) <font color=#447700>! T to TH2 ratio on mass points.<a name='628'></font>
  INTEGER,INTENT(IN) :: kpbl( ims:ime, jms:jme )  <font color=#447700>! Vertical layer index for PBL top<a name='629'></font>
  REAL,   INTENT(IN) :: timeob(niobf)             <font color=#447700>! Obs time (hrs)<a name='630'></font>
  REAL,   INTENT(IN) :: rio(niobf)                <font color=#447700>! Obs west-east coordinate (non-stag grid).<a name='631'></font>
  REAL,   INTENT(IN) :: rjo(niobf)                <font color=#447700>! Obs south-north coordinate (non-stag grid).<a name='632'></font>
  REAL,   INTENT(INOUT) :: rko(niobf)             <font color=#447700>! Obs bottom-top coordinate<a name='633'></font>
  REAL,   INTENT(INOUT) :: varobs(nndgv, niobf)<a name='634'>
  REAL,   INTENT(INOUT) :: errf(nerrf, niobf)<a name='635'>
<a name='636'>
<font color=#447700>! Local variables<a name='637'></font>
  INTEGER :: iobmg(niobf)   <font color=#447700>! Obs i-coord on mass grid<a name='638'></font>
  INTEGER :: jobmg(niobf)   <font color=#447700>! Obs j-coord on mass grid<a name='639'></font>
  INTEGER :: ia(niobf)<a name='640'>
  INTEGER :: ib(niobf)<a name='641'>
  INTEGER :: ic(niobf)<a name='642'>
  REAL :: pbbo(kds:kde)    <font color=#447700>! column base pressure (cb) at obs loc.<a name='643'></font>
  REAL :: ppbo(kds:kde)    <font color=#447700>! column pressure perturbation (cb) at obs loc.<a name='644'></font>
<a name='645'>
  REAL :: ra(niobf)<a name='646'>
  REAL :: rb(niobf)<a name='647'>
  REAL :: rc(niobf)<a name='648'>
  REAL :: dxobmg(niobf)     <font color=#447700>! Interp. fraction (x dir) referenced to mass-grid<a name='649'></font>
  REAL :: dyobmg(niobf)     <font color=#447700>! Interp. fraction (y dir) referenced to mass-grid<a name='650'></font>
  INTEGER MM(MAXDOM)<a name='651'>
  INTEGER NNL<a name='652'>
  real :: uratio( ims:ime, jms:jme )   <font color=#447700>! U to U10 ratio on momentum points.<a name='653'></font>
  real :: vratio( ims:ime, jms:jme )   <font color=#447700>! V to V10 ratio on momentum points.<a name='654'></font>
  real :: pug1,pug2,pvg1,pvg2<a name='655'>
  character(len=200) :: msg            <font color=#447700>! Argument to wrf_message<a name='656'></font>
<a name='657'>
<font color=#447700>! Define staggers for U, V, and T grids, referenced from non-staggered grid.<a name='658'></font>
  real, parameter :: gridx_t = 0.5     <font color=#447700>! Mass-point x stagger<a name='659'></font>
  real, parameter :: gridy_t = 0.5     <font color=#447700>! Mass-point y stagger<a name='660'></font>
  real, parameter :: gridx_u = 0.0     <font color=#447700>! U-point x stagger<a name='661'></font>
  real, parameter :: gridy_u = 0.5     <font color=#447700>! U-point y stagger<a name='662'></font>
  real, parameter :: gridx_v = 0.5     <font color=#447700>! V-point x stagger<a name='663'></font>
  real, parameter :: gridy_v = 0.0     <font color=#447700>! V-point y stagger<a name='664'></font>
<a name='665'>
  real :: dummy = 99999.<a name='666'>
<a name='667'>
  real :: pbhi, pphi<a name='668'>
  real :: obs_pottemp                  <font color=#447700>! Potential temperature at observation<a name='669'></font>
<a name='670'>
<font color=#447700>!***  DECLARATIONS FOR IMPLICIT NONE<a name='671'></font>
  integer nsta,ivar,n,ityp<a name='672'>
  integer iob,job,kob,iob_ms,job_ms<a name='673'>
  integer k,kbot,nml,nlb,nle<a name='674'>
  integer iobm,jobm,iobp,jobp,kobp,inpf,i,j<a name='675'>
  integer i_start,i_end,j_start,j_end    <font color=#447700>! loop ranges for uratio,vratio calc.<a name='676'></font>
  integer k_start,k_end<a name='677'>
  integer ips                            <font color=#447700>! For printing obs information<a name='678'></font>
  integer pnx                            <font color=#447700>! obs index for printout<a name='679'></font>
<a name='680'>
  real gridx,gridy,dxob,dyob,dzob,dxob_ms,dyob_ms<a name='681'>
  real pob<a name='682'>
  real hob<a name='683'>
  real uratiob,vratiob,tratiob,tratxob,fnpf<a name='684'>
<a name='685'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='686'></font>
  LOGICAL MP_LOCAL_DUMMASK(NIOBF)  <font color=#447700>! Mask for work to be done on this processor<a name='687'></font>
  LOGICAL MP_LOCAL_UOBMASK(NIOBF)  <font color=#447700>! Dot-point mask<a name='688'></font>
  LOGICAL MP_LOCAL_VOBMASK(NIOBF)  <font color=#447700>! Dot-point mask<a name='689'></font>
  LOGICAL MP_LOCAL_COBMASK(NIOBF)  <font color=#447700>! Cross-point mask<a name='690'></font>
#endif<a name='691'>
<a name='692'>
<font color=#447700>! LOGICAL, EXTERNAL :: TILE_MASK<a name='693'></font>
<a name='694'>
  NSTA=NSTAT<a name='695'>
<a name='696'>
<font color=#447700>! FIRST, DETERMINE THE GRID TYPE CORRECTION FOR U-momentum, V-momentum,<a name='697'></font>
<font color=#447700>! AND MASS POINTS, AND WHEN INEST=2, CONVERT THE STORED COARSE MESH INDICES<a name='698'></font>
<font color=#447700>! TO THE FINE MESH INDEX EQUIVALENTS<a name='699'></font>
<a name='700'>
<font color=#447700>! ITYP=1 FOR U-POINTS, ITYP=2 for V-POINTS, and ITYP=3 FOR MASS POINTS<a name='701'></font>
<a name='702'>
  if (iprt) then<a name='703'>
    write(msg,fmt='(a,i5,a,i2,a,i5,a)') '++++++CALL ERROB AT KTAU = ', &amp;<a name='704'>
            KTAU,' AND INEST = ',INEST,':  NSTA = ',NSTAW,' ++++++'<a name='705'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_778">(msg)<a name='706'>
  endif<a name='707'>
<a name='708'>
  ERRF = 0.0    <font color=#447700>! Zero out errf array<a name='709'></font>
<a name='710'>
<font color=#447700>! Set up loop bounds for this grid's boundary conditions<a name='711'></font>
  i_start = max( its-1,ids )<a name='712'>
  i_end   = min( ite+1,ide-1 )<a name='713'>
  j_start = max( jts-1,jds )<a name='714'>
  j_end   = min( jte+1,jde-1 )<a name='715'>
  k_start = kts<a name='716'>
  k_end = min( kte, kde-1 )<a name='717'>
<a name='718'>
  DO ITYP=1,3   <font color=#447700>! Big loop: ityp=1 for U, ityp=2 for V, ityp=3 for T,Q,SP <a name='719'></font>
<a name='720'>
<font color=#447700>!   Set grid stagger<a name='721'></font>
    IF(ITYP.EQ.1) THEN        <font color=#447700>! U-POINT CASE<a name='722'></font>
       GRIDX = gridx_u<a name='723'>
       GRIDY = gridy_u<a name='724'>
    ELSE IF(ITYP.EQ.2) THEN   <font color=#447700>! V-POINT CASE<a name='725'></font>
       GRIDX = gridx_v<a name='726'>
       GRIDY = gridy_v<a name='727'>
    ELSE                      <font color=#447700>! MASS-POINT CASE<a name='728'></font>
       GRIDX = gridx_t<a name='729'>
       GRIDY = gridy_t<a name='730'>
    ENDIF<a name='731'>
<a name='732'>
<font color=#447700>!   Compute URATIO and VRATIO fields on momentum (u,v) points.<a name='733'></font>
    IF(ityp.eq.1)THEN<a name='734'>
      call <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#UPOINT'>upoint</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPOINT_1">(i_start,i_end, j_start,j_end, ids,ide, ims,ime, jms,jme, uratx, uratio)<a name='735'>
    ELSE IF (ityp.eq.2) THEN<a name='736'>
      call <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#VPOINT'>vpoint</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VPOINT_1">(i_start,i_end, j_start,j_end, jds,jde, ims,ime, jms,jme, vratx, vratio)<a name='737'>
    ENDIF<a name='738'>
<a name='739'>
    IF(INEST.EQ.1) THEN       <font color=#447700>! COARSE MESH CASE...<a name='740'></font>
      DO N=1,NSTA<a name='741'>
        RA(N)=RIO(N)-GRIDX<a name='742'>
        RB(N)=RJO(N)-GRIDY<a name='743'>
        IA(N)=RA(N)<a name='744'>
        IB(N)=RB(N)<a name='745'>
        IOB=MAX0(1,IA(N))<a name='746'>
        IOB=MIN0(IOB,ide-1)<a name='747'>
        JOB=MAX0(1,IB(N))<a name='748'>
        JOB=MIN0(JOB,jde-1)<a name='749'>
        DXOB=RA(N)-FLOAT(IA(N))<a name='750'>
        DYOB=RB(N)-FLOAT(IB(N))<a name='751'>
<a name='752'>
<font color=#447700>!       Save mass-point arrays for computing rko for all var types<a name='753'></font>
        if(ityp.eq.1) then<a name='754'>
          iobmg(n) = MIN0(MAX0(1,int(RIO(n)-gridx_t)),ide-1)<a name='755'>
          jobmg(n) = MIN0(MAX0(1,int(RJO(n)-gridy_t)),jde-1)<a name='756'>
          dxobmg(n) = RIO(N)-gridx_t-FLOAT(int(RIO(N)-gridx_t))<a name='757'>
          dyobmg(n) = RJO(N)-gridy_t-FLOAT(int(RJO(N)-gridy_t))<a name='758'>
        endif<a name='759'>
        iob_ms = iobmg(n)<a name='760'>
        job_ms = jobmg(n)<a name='761'>
        dxob_ms = dxobmg(n)<a name='762'>
        dyob_ms = dyobmg(n)<a name='763'>
<a name='764'>
<a name='765'>
<font color=#447700>! ajb 20090423: BUGFIX TO OBS_IN_HEIGHT OPTION<a name='766'></font>
<font color=#447700>! This is tricky: Initialize pob to zero in all procs. Only one proc actually<a name='767'></font>
<font color=#447700>! calculates pob. If this is an obs to be converted from height-to-pressure, then<a name='768'></font>
<font color=#447700>! by definition, varobs(5,n) will initially have the missing value -888888. After<a name='769'></font>
<font color=#447700>! the pob calculation, pob will be zero in all procs except the one that calculated<a name='770'></font>
<font color=#447700>! it, and so pob is dm_summed over all procs and stored into varobs(5,n). So on<a name='771'></font>
<font color=#447700>! subsequent passes, the dm_sum will not occur because varobs(5,n) will not have a<a name='772'></font>
<font color=#447700>! missing value. If this is not an obs-in-height,  <a name='773'></font>
<a name='774'>
        pob = 0.0<a name='775'>
<a name='776'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='777'></font>
<font color=#447700>!       Set mask for obs to be handled by this processor<a name='778'></font>
        MP_LOCAL_DUMMASK(N) = <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#TILE_MASK'>TILE_MASK</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TILE_MASK_1">(IOB, JOB, its, ite, jts, jte)<a name='779'>
  <a name='780'>
        IF ( MP_LOCAL_DUMMASK(N) ) THEN<a name='781'>
#endif<a name='782'>
<a name='783'>
<font color=#447700>!         Interpolate pressure to obs location column and convert from Pa to cb.<a name='784'></font>
<a name='785'>
          do k = kds, kde<a name='786'>
            pbbo(k) = .001*(                                            &amp;<a name='787'>
               (1.-DYOB_MS)*( (1.-DXOB_MS)*pbase(IOB_MS,K,JOB_MS) +     &amp;<a name='788'>
                                  DXOB_MS *pbase(IOB_MS+1,K,JOB_MS) ) + &amp;<a name='789'>
                   DYOB_MS* ( (1.-DXOB_MS)*pbase(IOB_MS,K,JOB_MS+1) +   &amp;<a name='790'>
                                  DXOB_MS *pbase(IOB_MS+1,K,JOB_MS+1) ) )  <a name='791'>
            ppbo(k) = .001*(                                            &amp;<a name='792'>
               (1.-DYOB_MS)*( (1.-DXOB_MS)*pp(IOB_MS,K,JOB_MS) +        &amp;<a name='793'>
                                  DXOB_MS *pp(IOB_MS+1,K,JOB_MS) ) +    &amp;<a name='794'>
                   DYOB_MS* ( (1.-DXOB_MS)*pp(IOB_MS,K,JOB_MS+1) +      &amp;<a name='795'>
                                  DXOB_MS *pp(IOB_MS+1,K,JOB_MS+1) ) )  <a name='796'>
          enddo<a name='797'>
<a name='798'>
<font color=#447700>!ajb      20040119: Note based on bugfix for dot/cross points split across processors,<a name='799'></font>
<font color=#447700>!ajb                which was actually a serial code fix: The ityp=2 (v-points) and<a name='800'></font>
<font color=#447700>!ajb                ityp=3 (mass-points) cases should not use the ityp=1 (u-points)<a name='801'></font>
<font color=#447700>!ajb                case rko! This is necessary for bit-for-bit reproducability<a name='802'></font>
<font color=#447700>!ajb                with the parallel run.   (coarse mesh)<a name='803'></font>
<a name='804'>
          if(abs(rko(n)+99).lt.1.)then<a name='805'>
            pob = varobs(5,n)<a name='806'>
<a name='807'>
            if(pob .eq.-888888.) then<a name='808'>
               hob = varobs(6,n)<a name='809'>
               if(hob .gt. -800000. ) then<a name='810'>
                 pob = <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#HT_TO_P'>ht_to_p</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HT_TO_P_1">( hob, ppbo, pbbo, z, iob_ms, job_ms,          &amp;<a name='811'>
                                dxob_ms, dyob_ms, k_start, k_end, kds,kde,   &amp;<a name='812'>
                                ims,ime, jms,jme, kms,kme )<a name='813'>
               endif<a name='814'>
            endif<a name='815'>
<a name='816'>
            if(pob .gt.-800000.)then<a name='817'>
              do k=k_end-1,1,-1<a name='818'>
                kbot = k<a name='819'>
                if(pob .le. pbbo(k)+ppbo(k)) then<a name='820'>
                  goto 199<a name='821'>
                endif<a name='822'>
              enddo<a name='823'>
 199          continue<a name='824'>
<a name='825'>
              pphi = ppbo(kbot+1)<a name='826'>
              pbhi = pbbo(kbot+1)<a name='827'>
<a name='828'>
              rko(n) = real(kbot+1)-                                    &amp;<a name='829'>
                 ( (pob-pbhi-pphi) / (pbbo(kbot)+ppbo(kbot)-pbhi-pphi) )<a name='830'>
<a name='831'>
              rko(n)=max(rko(n),1.0)<a name='832'>
            endif<a name='833'>
          endif<a name='834'>
<a name='835'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='836'></font>
        ENDIF       <font color=#447700>!end IF( MP_LOCAL_DUMMASK(N) )                                 !ajb<a name='837'></font>
#endif<a name='838'>
<a name='839'>
<font color=#447700>! ajb 20090423: If obs-in-height, varobs(5,n) is sum of pob (see note above).<a name='840'></font>
        if(varobs(5,n) .eq. -888888. .and. varobs(6,n) .gt. -800000.) then<a name='841'>
           varobs(5,n) = wrf_dm_sum_real ( pob )<a name='842'>
        endif<a name='843'>
<a name='844'>
        RC(N)=RKO(N)<a name='845'>
<a name='846'>
      ENDDO      <font color=#447700>! END COARSE MESH LOOP OVER NSTA <a name='847'></font>
<a name='848'>
    ELSE       <font color=#447700>! FINE MESH CASE<a name='849'></font>
<a name='850'>
<font color=#447700>!**********************************************************************<a name='851'></font>
<font color=#447700>!ajb_07012008: Conversion of obs coordinates to the fine mesh here<a name='852'></font>
<font color=#447700>!ajb   is no longer necessary, since implementation of the WRF map pro-<a name='853'></font>
<font color=#447700>!ajb   jections (to each nest directly) is implemented in sub in4dob. <a name='854'></font>
<font color=#447700>!**********************************************************************<a name='855'></font>
<font color=#447700>!ajb<a name='856'></font>
<font color=#447700>!ajb  GET (I,J,K) OF OBSERVATIONS ON FINE MESH VALUES.<a name='857'></font>
      DO N=1,NSTA<a name='858'>
          RA(N)=RIO(N)-GRIDX           <font color=#447700>! ajb added 07012008<a name='859'></font>
          RB(N)=RJO(N)-GRIDY           <font color=#447700>! ajb added 07012008<a name='860'></font>
          IA(N)=RA(N)<a name='861'>
          IB(N)=RB(N)<a name='862'>
          IOB=MAX0(1,IA(N))<a name='863'>
          IOB=MIN0(IOB,ide-1)<a name='864'>
          JOB=MAX0(1,IB(N))<a name='865'>
          JOB=MIN0(JOB,jde-1)<a name='866'>
          DXOB=RA(N)-FLOAT(IA(N))<a name='867'>
          DYOB=RB(N)-FLOAT(IB(N))<a name='868'>
<a name='869'>
<font color=#447700>!         Save mass-point arrays for computing rko for all var types<a name='870'></font>
          if(ityp.eq.1) then<a name='871'>
            iobmg(n) = MIN0(MAX0(1,int(RIO(n)-gridx_t)),ide-1)<a name='872'>
            jobmg(n) = MIN0(MAX0(1,int(RJO(n)-gridy_t)),jde-1)<a name='873'>
            dxobmg(n) = RIO(N)-gridx_t-FLOAT(int(RIO(N)-gridx_t))<a name='874'>
            dyobmg(n) = RJO(N)-gridy_t-FLOAT(int(RJO(N)-gridy_t))<a name='875'>
          endif <a name='876'>
          iob_ms = iobmg(n)<a name='877'>
          job_ms = jobmg(n)<a name='878'>
          dxob_ms = dxobmg(n)<a name='879'>
          dyob_ms = dyobmg(n)<a name='880'>
<a name='881'>
<font color=#447700>! ajb 20090423: BUGFIX TO OBS_IN_HEIGHT OPTION (see COARSE MESH comments)<a name='882'></font>
        pob = 0.0<a name='883'>
<a name='884'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='885'></font>
<font color=#447700>!       Set mask for obs to be handled by this processor<a name='886'></font>
        MP_LOCAL_DUMMASK(N) = <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#TILE_MASK'>TILE_MASK</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TILE_MASK_2">(IOB, JOB, its, ite, jts, jte)<a name='887'>
<a name='888'>
        IF ( MP_LOCAL_DUMMASK(N) ) THEN<a name='889'>
#endif<a name='890'>
<a name='891'>
<font color=#447700>!         Interpolate pressure to obs location column and convert from Pa to cb.<a name='892'></font>
<a name='893'>
          do k = kds, kde<a name='894'>
            pbbo(k) = .001*(                                            &amp;<a name='895'>
               (1.-DYOB_MS)*( (1.-DXOB_MS)*pbase(IOB_MS,K,JOB_MS) +     &amp;<a name='896'>
                                  DXOB_MS *pbase(IOB_MS+1,K,JOB_MS) ) + &amp;<a name='897'>
                   DYOB_MS* ( (1.-DXOB_MS)*pbase(IOB_MS,K,JOB_MS+1) +   &amp;<a name='898'>
                                  DXOB_MS *pbase(IOB_MS+1,K,JOB_MS+1) ) )<a name='899'>
            ppbo(k) = .001*(                                            &amp;<a name='900'>
               (1.-DYOB_MS)*( (1.-DXOB_MS)*pp(IOB_MS,K,JOB_MS) +        &amp;<a name='901'>
                                  DXOB_MS *pp(IOB_MS+1,K,JOB_MS) ) +    &amp;<a name='902'>
                   DYOB_MS* ( (1.-DXOB_MS)*pp(IOB_MS,K,JOB_MS+1) +      &amp;<a name='903'>
                                  DXOB_MS *pp(IOB_MS+1,K,JOB_MS+1) ) )<a name='904'>
          enddo<a name='905'>
<a name='906'>
<font color=#447700>!ajb      20040119: Note based on bugfix for dot/cross points split across processors,<a name='907'></font>
<font color=#447700>!ajb                which was actually a serial code fix: The ityp=2 (v-points) and<a name='908'></font>
<font color=#447700>!ajb                itype=3 (mass-points) cases should not use the ityp=1 (u-points)<a name='909'></font>
<font color=#447700>!ajb                case) rko! This is necessary for bit-for-bit reproducability<a name='910'></font>
<font color=#447700>!ajb                with parallel run.   (fine mesh)<a name='911'></font>
<a name='912'>
          if(abs(rko(n)+99).lt.1.)then<a name='913'>
            pob = varobs(5,n)<a name='914'>
<a name='915'>
            if(pob .eq.-888888.) then<a name='916'>
               hob = varobs(6,n)<a name='917'>
               if(hob .gt. -800000. ) then<a name='918'>
                 pob = <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#HT_TO_P'>ht_to_p</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HT_TO_P_2">( hob, ppbo, pbbo, z, iob_ms, job_ms,          &amp;<a name='919'>
                                dxob_ms, dyob_ms, k_start, k_end, kds,kde,   &amp;<a name='920'>
                                ims,ime, jms,jme, kms,kme )<a name='921'>
               endif<a name='922'>
            endif<a name='923'>
<a name='924'>
            if(pob .gt.-800000.)then<a name='925'>
              do k=k_end-1,1,-1<a name='926'>
                kbot = k<a name='927'>
                if(pob .le. pbbo(k)+ppbo(k)) then<a name='928'>
                  goto 198<a name='929'>
                endif<a name='930'>
              enddo<a name='931'>
 198          continue<a name='932'>
<a name='933'>
              pphi = ppbo(kbot+1)<a name='934'>
              pbhi = pbbo(kbot+1)<a name='935'>
<a name='936'>
              rko(n) = real(kbot+1)-                                    &amp;<a name='937'>
                 ( (pob-pbhi-pphi) / (pbbo(kbot)+ppbo(kbot)-pbhi-pphi) )<a name='938'>
              rko(n)=max(rko(n),1.0)<a name='939'>
            endif<a name='940'>
          endif<a name='941'>
<a name='942'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='943'></font>
        ENDIF       <font color=#447700>!end IF( MP_LOCAL_DUMMASK(N) )                                 !ajb<a name='944'></font>
#endif<a name='945'>
<a name='946'>
<font color=#447700>! ajb 20090423: If obs-in-height, varobs(5,n) is sum of pob (see note above).<a name='947'></font>
        if(varobs(5,n) .eq. -888888. .and. varobs(6,n) .gt. -800000.) then<a name='948'>
           varobs(5,n) = wrf_dm_sum_real ( pob )<a name='949'>
        endif<a name='950'>
<a name='951'>
        RC(N)=RKO(N)<a name='952'>
<a name='953'>
      ENDDO      <font color=#447700>! END FINE MESH LOOP OVER NSTA<a name='954'></font>
    <a name='955'>
    ENDIF      <font color=#447700>! end if(inest.eq.1)<a name='956'></font>
<a name='957'>
<font color=#447700>!   INITIALIZE THE ARRAY OF DIFFERENCES BETWEEN THE OBSERVATIONS<a name='958'></font>
<font color=#447700>!   AND THE LOCAL FORECAST VALUES TO ZERO.  FOR THE FINE MESH<a name='959'></font>
<font color=#447700>!   ONLY, SET THE DIFFERENCE TO A LARGE DUMMY VALUE IF THE<a name='960'></font>
<font color=#447700>!   OBSERVATION IS OUTSIDE THE FINE MESH DOMAIN.<a name='961'></font>
<a name='962'>
<font color=#447700>!   SET DIFFERENCE VALUE TO A DUMMY VALUE FOR OBS POINTS OUTSIDE<a name='963'></font>
<font color=#447700>!   CURRENT DOMAIN<a name='964'></font>
    IF(ITYP.EQ.1) THEN<a name='965'>
      NLB=1<a name='966'>
      NLE=1<a name='967'>
    ELSE IF(ITYP.EQ.2) THEN<a name='968'>
      NLB=2<a name='969'>
      NLE=2<a name='970'>
    ELSE<a name='971'>
      NLB=3<a name='972'>
      NLE=5<a name='973'>
    ENDIF<a name='974'>
    DO IVAR=NLB,NLE<a name='975'>
      DO N=1,NSTA<a name='976'>
        IF((RA(N)-1.).LT.0)THEN<a name='977'>
           ERRF(IVAR,N)=ERRF(IVAR,N)+DUMMY<a name='978'>
        ENDIF<a name='979'>
        IF((RB(N)-1.).LT.0)THEN<a name='980'>
           ERRF(IVAR,N)=ERRF(IVAR,N)+DUMMY<a name='981'>
        ENDIF<a name='982'>
        IF((FLOAT(ide)-2.0*GRIDX-RA(N)-1.E-10).LT.0)THEN<a name='983'>
           ERRF(IVAR,N)=ERRF(IVAR,N)+DUMMY<a name='984'>
        ENDIF<a name='985'>
        IF((FLOAT(jde)-2.0*GRIDY-RB(N)-1.E-10).LT.0)THEN<a name='986'>
           ERRF(IVAR,N)=ERRF(IVAR,N)+DUMMY<a name='987'>
        ENDIF<a name='988'>
        if(rc(n).lt.1.)errf(ivar,n)=errf(ivar,n)+dummy<a name='989'>
      ENDDO<a name='990'>
    ENDDO<a name='991'>
<a name='992'>
<font color=#447700>!   NOW FIND THE EXACT OFFSET OF EACH OBSERVATION FROM THE<a name='993'></font>
<font color=#447700>!   GRID POINT TOWARD THE LOWER LEFT<a name='994'></font>
    DO N=1,NSTA<a name='995'>
        IA(N)=RA(N)<a name='996'>
        IB(N)=RB(N)<a name='997'>
        IC(N)=RC(N)<a name='998'>
    ENDDO<a name='999'>
    DO N=1,NSTA<a name='1000'>
        RA(N)=RA(N)-FLOAT(IA(N))<a name='1001'>
        RB(N)=RB(N)-FLOAT(IB(N))<a name='1002'>
        RC(N)=RC(N)-FLOAT(IC(N))<a name='1003'>
    ENDDO<a name='1004'>
<font color=#447700>!   PERFORM A TRILINEAR EIGHT-POINT (3-D) INTERPOLATION<a name='1005'></font>
<font color=#447700>!   TO FIND THE FORECAST VALUE AT THE EXACT OBSERVATION<a name='1006'></font>
<font color=#447700>!   POINTS FOR U, V, T, AND Q.<a name='1007'></font>
<a name='1008'>
<font color=#447700>!   Compute local masks for dot and cross points.<a name='1009'></font>
    if(ityp.eq.1) then<a name='1010'>
      DO N=1,NSTA<a name='1011'>
        IOB=MAX0(1,IA(N))<a name='1012'>
        IOB=MIN0(IOB,ide-1)<a name='1013'>
        JOB=MAX0(1,IB(N))<a name='1014'>
        JOB=MIN0(JOB,jde-1)<a name='1015'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1016'></font>
<font color=#447700>!       Set mask for U-momemtum points to be handled by this processor<a name='1017'></font>
        MP_LOCAL_UOBMASK(N) = <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#TILE_MASK'>TILE_MASK</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TILE_MASK_3">(IOB, JOB, its, ite, jts, jte)<a name='1018'>
#endif<a name='1019'>
      ENDDO<a name='1020'>
    endif<a name='1021'>
    if(ityp.eq.2) then<a name='1022'>
      DO N=1,NSTA<a name='1023'>
        IOB=MAX0(1,IA(N))<a name='1024'>
        IOB=MIN0(IOB,ide-1)<a name='1025'>
        JOB=MAX0(1,IB(N))<a name='1026'>
        JOB=MIN0(JOB,jde-1)<a name='1027'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1028'></font>
<font color=#447700>!       Set mask for V-momentum points to be handled by this processor<a name='1029'></font>
        MP_LOCAL_VOBMASK(N) = <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#TILE_MASK'>TILE_MASK</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TILE_MASK_4">(IOB, JOB, its, ite, jts, jte)<a name='1030'>
#endif<a name='1031'>
      ENDDO<a name='1032'>
    endif<a name='1033'>
    if(ityp.eq.3) then<a name='1034'>
      DO N=1,NSTA<a name='1035'>
        IOB=MAX0(1,IA(N))<a name='1036'>
        IOB=MIN0(IOB,ide-1)<a name='1037'>
        JOB=MAX0(1,IB(N))<a name='1038'>
        JOB=MIN0(JOB,jde-1)<a name='1039'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1040'></font>
<font color=#447700>!       Set mask for cross (mass) points to be handled by this processor<a name='1041'></font>
        MP_LOCAL_COBMASK(N) = <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#TILE_MASK'>TILE_MASK</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TILE_MASK_5">(IOB, JOB, its, ite, jts, jte)<a name='1042'>
#endif<a name='1043'>
      ENDDO<a name='1044'>
    endif<a name='1045'>
<a name='1046'>
<font color=#447700>!**********************************************************<a name='1047'></font>
<font color=#447700>!   PROCESS U VARIABLE (IVAR=1)<a name='1048'></font>
<font color=#447700>!**********************************************************<a name='1049'></font>
    IF(ITYP.EQ.1) THEN<a name='1050'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1051'></font>
      DO N=1,NSTA<a name='1052'>
        IF(MP_LOCAL_UOBMASK(N)) THEN<a name='1053'>
          ERRF(9,N)=rko(n)       <font color=#447700>!RKO is needed by neighboring processors     !ajb<a name='1054'></font>
        ENDIF<a name='1055'>
      ENDDO<a name='1056'>
#endif<a name='1057'>
      IF(ISWIND.EQ.1) THEN<a name='1058'>
        DO N=1,NSTA<a name='1059'>
          IOB=MAX0(2,IA(N))<a name='1060'>
          IOB=MIN0(IOB,ide-1)<a name='1061'>
          IOBM=MAX0(1,IOB-1)<a name='1062'>
          IOBP=MIN0(ide-1,IOB+1)<a name='1063'>
          JOB=MAX0(2,IB(N))<a name='1064'>
          JOB=MIN0(JOB,jde-1)<a name='1065'>
          JOBM=MAX0(1,JOB-1)<a name='1066'>
          JOBP=MIN0(jde-1,JOB+1)<a name='1067'>
          KOB=MIN0(K_END,IC(N))<a name='1068'>
<a name='1069'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1070'></font>
          IF(MP_LOCAL_UOBMASK(N))THEN     <font color=#447700>! Do if obs on this processor<a name='1071'></font>
#endif<a name='1072'>
            KOBP=MIN0(KOB+1,k_end)<a name='1073'>
            DXOB=RA(N)<a name='1074'>
            DYOB=RB(N)<a name='1075'>
            DZOB=RC(N)<a name='1076'>
<a name='1077'>
<font color=#447700>!           Compute surface pressure values at surrounding U and V points<a name='1078'></font>
            PUG1 = .5*( pbase(IOBM,1,JOB) + pbase(IOB,1,JOB) )<a name='1079'>
            PUG2 = .5*( pbase(IOB,1,JOB) + pbase(IOBP,1,JOB) )<a name='1080'>
<a name='1081'>
<font color=#447700>!           This is to correct obs to model sigma level using reverse similarity theory<a name='1082'></font>
            if(rko(n).eq.1.0)then<a name='1083'>
              uratiob=((1.-DYOB)*((1.-DXOB)*uratio(IOB,JOB)+     &amp;<a name='1084'>
                    DXOB*uratio(IOBP,JOB)                        &amp;<a name='1085'>
                  )+DYOB*((1.-DXOB)*uratio(IOB,JOBP)+            &amp;<a name='1086'>
                  DXOB*uratio(IOBP,JOBP)))<a name='1087'>
            else<a name='1088'>
              uratiob=1.<a name='1089'>
            endif<a name='1090'>
<font color=#447700>!YLIU       Some PBL scheme do not define the vratio/uratio<a name='1091'></font>
            if(abs(uratiob).lt.1.0e-3) then<a name='1092'>
              uratiob=1.<a name='1093'>
            endif<a name='1094'>
<a name='1095'>
<font color=#447700>!           INITIAL ERRF(IVAR,N) IS ZERO FOR OBSERVATIONS POINTS<a name='1096'></font>
<font color=#447700>!           WITHIN THE DOMAIN, AND A LARGE DUMMY VALUE FOR POINTS<a name='1097'></font>
<font color=#447700>!           OUTSIDE THE CURRENT DOMAIN<a name='1098'></font>
<a name='1099'>
<font color=#447700>!           U COMPONENT WIND ERROR<a name='1100'></font>
            ERRF(1,N)=ERRF(1,N)+uratiob*VAROBS(1,N)-((1.-DZOB)*        &amp;<a name='1101'>
                      ((1.-DyOB)*((1.-                                 &amp;<a name='1102'>
                      DxOB)*UB(IOB,KOB,JOB)+DxOB*UB(IOB+1,KOB,JOB)     &amp;<a name='1103'>
                      )+DyOB*((1.-DxOB)*UB(IOB,KOB,JOB+1)+DxOB*        &amp;<a name='1104'>
                      UB(IOB+1,KOB,JOB+1)))+DZOB*((1.-DyOB)*((1.-DxOB) &amp;<a name='1105'>
                      *UB(IOB,KOBP,JOB)+DxOB*UB(IOB+1,KOBP,JOB))+      &amp;<a name='1106'>
                      DyOB*((1.-DxOB)*UB(IOB,KOBP,JOB+1)+DxOB*         &amp;<a name='1107'>
                      UB(IOB+1,KOBP,JOB+1))))<a name='1108'>
<a name='1109'>
<font color=#447700>!      if(n.le.10) then<a name='1110'></font>
<font color=#447700>!        write(6,*)<a name='1111'></font>
<font color=#447700>!        write(6,'(a,i3,i3,i3,a,i3,a,i2)') 'ERRF1 at ',iob,job,kob,   &amp;<a name='1112'></font>
<font color=#447700>!                                     ' N = ',n,' inest = ',inest<a name='1113'></font>
<font color=#447700>!        write(6,*) 'VAROBS(1,N) = ',varobs(1,n)<a name='1114'></font>
<font color=#447700>!        write(6,*) 'VAROBS(5,N) = ',varobs(5,n)<a name='1115'></font>
<font color=#447700>!        write(6,*) 'UB(IOB,KOB,JOB) = ',UB(IOB,KOB,JOB)<a name='1116'></font>
<font color=#447700>!        write(6,*) 'UB(IOB+1,KOB,JOB) = ',UB(IOB+1,KOB,JOB)<a name='1117'></font>
<font color=#447700>!        write(6,*) 'UB(IOB,KOB,JOB+1) = ',UB(IOB,KOB,JOB+1)<a name='1118'></font>
<font color=#447700>!        write(6,*) 'UB(IOB+1,KOB,JOB+1) = ',UB(IOB+1,KOB,JOB+1)<a name='1119'></font>
<font color=#447700>!        write(6,*) 'UB(IOB,KOBP,JOB) = ',UB(IOB,KOBP,JOB)<a name='1120'></font>
<font color=#447700>!        write(6,*) 'UB(IOB+1,KOBP,JOB) = ',UB(IOB+1,KOBP,JOB)<a name='1121'></font>
<font color=#447700>!        write(6,*) 'UB(IOB,KOBP,JOB+1) = ',UB(IOB,KOBP,JOB+1)<a name='1122'></font>
<font color=#447700>!        write(6,*) 'UB(IOB+1,KOBP,JOB+1) = ',UB(IOB+1,KOBP,JOB+1)<a name='1123'></font>
<font color=#447700>!        write(6,*) 'uratiob = ',uratiob<a name='1124'></font>
<font color=#447700>!        write(6,*) 'DXOB,DYOB,DZOB = ',DXOB,DYOB,DZOB<a name='1125'></font>
<font color=#447700>!        write(6,*) 'ERRF(1,N) = ',errf(1,n)<a name='1126'></font>
<font color=#447700>!        write(6,*)<a name='1127'></font>
<font color=#447700>!      endif<a name='1128'></font>
<a name='1129'>
<a name='1130'>
<font color=#447700>!           Store model surface pressure (not the error!) at U point.<a name='1131'></font>
            ERRF(7,N)=.001*( (1.-DXOB)*PUG1 + DXOB*PUG2 )<a name='1132'>
  <a name='1133'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1134'></font>
          ENDIF       <font color=#447700>! end IF( MP_LOCAL_UOBMASK(N) )<a name='1135'></font>
#endif<a name='1136'>
        ENDDO    <font color=#447700>! END U-POINT LOOP OVER OBS<a name='1137'></font>
<a name='1138'>
      ENDIF    <font color=#447700>! end if(iswind.eq.1)<a name='1139'></font>
<a name='1140'>
    ENDIF   <font color=#447700>! ITYP=1: PROCESS U<a name='1141'></font>
<a name='1142'>
<font color=#447700>!**********************************************************<a name='1143'></font>
<font color=#447700>!   PROCESS V VARIABLE (IVAR=2)<a name='1144'></font>
<font color=#447700>!**********************************************************<a name='1145'></font>
    IF(ITYP.EQ.2) THEN<a name='1146'>
<a name='1147'>
      IF(ISWIND.EQ.1) THEN<a name='1148'>
        DO N=1,NSTA<a name='1149'>
          IOB=MAX0(2,IA(N))<a name='1150'>
          IOB=MIN0(IOB,ide-1)<a name='1151'>
          IOBM=MAX0(1,IOB-1)<a name='1152'>
          IOBP=MIN0(ide-1,IOB+1)<a name='1153'>
          JOB=MAX0(2,IB(N))<a name='1154'>
          JOB=MIN0(JOB,jde-1)<a name='1155'>
          JOBM=MAX0(1,JOB-1)<a name='1156'>
          JOBP=MIN0(jde-1,JOB+1)<a name='1157'>
          KOB=MIN0(K_END,IC(N))<a name='1158'>
<a name='1159'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1160'></font>
          IF(MP_LOCAL_VOBMASK(N))THEN     <font color=#447700>! Do if obs on this processor<a name='1161'></font>
#endif<a name='1162'>
            KOBP=MIN0(KOB+1,k_end)<a name='1163'>
            DXOB=RA(N)<a name='1164'>
            DYOB=RB(N)<a name='1165'>
            DZOB=RC(N)<a name='1166'>
<a name='1167'>
<font color=#447700>!           Compute surface pressure values at surrounding U and V points<a name='1168'></font>
            PVG1 = .5*( pbase(IOB,1,JOBM) + pbase(IOB,1,JOB) )<a name='1169'>
            PVG2 = .5*( pbase(IOB,1,JOB) + pbase(IOB,1,JOBP) )<a name='1170'>
<a name='1171'>
<font color=#447700>!           This is to correct obs to model sigma level using reverse similarity theory<a name='1172'></font>
            if(rko(n).eq.1.0)then<a name='1173'>
              vratiob=((1.-DYOB)*((1.-DXOB)*vratio(IOB,JOB)+     &amp;<a name='1174'>
                    DXOB*vratio(IOBP,JOB)                        &amp;<a name='1175'>
                  )+DYOB*((1.-DXOB)*vratio(IOB,JOBP)+            &amp;<a name='1176'>
                  DXOB*vratio(IOBP,JOBP)))<a name='1177'>
            else<a name='1178'>
              vratiob=1.<a name='1179'>
            endif<a name='1180'>
<font color=#447700>!YLIU       Some PBL scheme do not define the vratio/uratio<a name='1181'></font>
            if(abs(vratiob).lt.1.0e-3) then<a name='1182'>
              vratiob=1.<a name='1183'>
            endif<a name='1184'>
<a name='1185'>
<font color=#447700>!           INITIAL ERRF(IVAR,N) IS ZERO FOR OBSERVATIONS POINTS<a name='1186'></font>
<font color=#447700>!           WITHIN THE DOMAIN, AND A LARGE DUMMY VALUE FOR POINTS<a name='1187'></font>
<font color=#447700>!           OUTSIDE THE CURRENT DOMAIN<a name='1188'></font>
  <a name='1189'>
<font color=#447700>!           V COMPONENT WIND ERROR<a name='1190'></font>
            ERRF(2,N)=ERRF(2,N)+vratiob*VAROBS(2,N)-((1.-DZOB)*        &amp;<a name='1191'>
                     ((1.-DyOB)*((1.-                                  &amp;<a name='1192'>
                      DxOB)*VB(IOB,KOB,JOB)+DxOB*VB(IOB+1,KOB,JOB)     &amp;<a name='1193'>
                      )+DyOB*((1.-DxOB)*VB(IOB,KOB,JOB+1)+DxOB*        &amp;<a name='1194'>
                      VB(IOB+1,KOB,JOB+1)))+DZOB*((1.-DyOB)*((1.-DxOB) &amp;<a name='1195'>
                      *VB(IOB,KOBP,JOB)+DxOB*VB(IOB+1,KOBP,JOB))+      &amp;<a name='1196'>
                      DyOB*((1.-DxOB)*VB(IOB,KOBP,JOB+1)+DxOB*         &amp;<a name='1197'>
                      VB(IOB+1,KOBP,JOB+1))))<a name='1198'>
<a name='1199'>
<font color=#447700>!      if(n.le.10) then<a name='1200'></font>
<font color=#447700>!        write(6,*) <a name='1201'></font>
<font color=#447700>!        write(6,'(a,i3,i3,i3,a,i3,a,i2)') 'ERRF2 at ',iob,job,kob,   &amp;<a name='1202'></font>
<font color=#447700>!                                     ' N = ',n,' inest = ',inest<a name='1203'></font>
<font color=#447700>!        write(6,*) 'VAROBS(2,N) = ',varobs(2,n)<a name='1204'></font>
<font color=#447700>!        write(6,*) 'VAROBS(5,N) = ',varobs(5,n)<a name='1205'></font>
<font color=#447700>!        write(6,*) 'VB(IOB,KOB,JOB) = ',VB(IOB,KOB,JOB)<a name='1206'></font>
<font color=#447700>!        write(6,*) 'ERRF(2,N) = ',errf(2,n)<a name='1207'></font>
<font color=#447700>!        write(6,*) 'vratiob = ',vratiob<a name='1208'></font>
<font color=#447700>!        write(6,*)<a name='1209'></font>
<font color=#447700>!      endif<a name='1210'></font>
<a name='1211'>
  <a name='1212'>
<font color=#447700>!           Store model surface pressure (not the error!) at V point.<a name='1213'></font>
            ERRF(8,N)=.001*( (1.-DYOB)*PVG1 + DYOB*PVG2 )<a name='1214'>
  <a name='1215'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1216'></font>
          ENDIF       <font color=#447700>! end IF( MP_LOCAL_VOBMASK(N) )<a name='1217'></font>
#endif<a name='1218'>
        ENDDO    <font color=#447700>! END V-POINT LOOP OVER OBS<a name='1219'></font>
<a name='1220'>
      ENDIF    <font color=#447700>! end if(iswind.eq.1)<a name='1221'></font>
<a name='1222'>
    ENDIF   <font color=#447700>! ITYP=1: PROCESS V<a name='1223'></font>
<a name='1224'>
<font color=#447700>!**********************************************************<a name='1225'></font>
<font color=#447700>!   PROCESS MASS-POINT VARIABLES IVAR=3 (T) AND IVAR=4 (QV)<a name='1226'></font>
<font color=#447700>!**********************************************************<a name='1227'></font>
    IF(ITYP.EQ.3) THEN<a name='1228'>
<a name='1229'>
      IF(ISTEMP.EQ.1 .OR. ISMOIS.EQ.1) THEN<a name='1230'>
        DO N=1,NSTA<a name='1231'>
          IOB=MAX0(1,IA(N))<a name='1232'>
          IOB=MIN0(IOB,ide-1)<a name='1233'>
          JOB=MAX0(1,IB(N))<a name='1234'>
          JOB=MIN0(JOB,jde-1)<a name='1235'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1236'></font>
          IF(MP_LOCAL_COBMASK(N)) THEN     <font color=#447700>! Do if obs on this processor<a name='1237'></font>
#endif<a name='1238'>
            KOB=MIN0(k_end,IC(N))<a name='1239'>
            KOBP=MIN0(KOB+1,K_END)<a name='1240'>
            DXOB=RA(N)<a name='1241'>
            DYOB=RB(N)<a name='1242'>
            DZOB=RC(N)<a name='1243'>
<a name='1244'>
<font color=#447700>!           This is to correct obs to model sigma level using reverse similarity theory<a name='1245'></font>
            if(rko(n).eq.1.0)then<a name='1246'>
              tratxob=((1.-DYOB)*((1.-DXOB)*tratx(IOB,JOB)+        &amp;<a name='1247'>
                    DXOB*tratx(IOB+1,JOB)                          &amp;<a name='1248'>
                  )+DYOB*((1.-DXOB)*tratx(IOB,JOB+1)+              &amp;<a name='1249'>
                  DXOB*tratx(IOB+1,JOB+1)))<a name='1250'>
            else<a name='1251'>
              tratxob=1.<a name='1252'>
            endif<a name='1253'>
<a name='1254'>
<font color=#447700>!yliu<a name='1255'></font>
            if(abs(tratxob) .lt. 1.0E-3) tratxob=1.<a name='1256'>
<a name='1257'>
<font color=#447700>!ajb We must convert temperature to potential temperature<a name='1258'></font>
            obs_pottemp = -888888.<a name='1259'>
            if(varobs(3,n).gt.-800000. .and. varobs(5,n).gt.-800000) then<a name='1260'>
              obs_pottemp = varobs(3,n)*(100./varobs(5,n))**RCP - t0<a name='1261'>
            endif<a name='1262'>
<a name='1263'>
            ERRF(3,N)=ERRF(3,N)+tratxob*obs_pottemp-((1.-DZOB)*     &amp;<a name='1264'>
                      ((1.-DyOB)*((1.-                              &amp;<a name='1265'>
                      DxOB)*(TB(IOB,KOB,JOB))+DxOB*                 &amp;<a name='1266'>
                      (TB(IOB+1,KOB,JOB)))+DyOB*((1.-DxOB)*         &amp;<a name='1267'>
                      (TB(IOB,KOB,JOB+1))+DxOB*                     &amp;<a name='1268'>
                      (TB(IOB+1,KOB,JOB+1))))+DZOB*((1.-            &amp;<a name='1269'>
                      DyOB)*((1.-DxOB)*(TB(IOB,KOBP,JOB))+DxOB*     &amp;<a name='1270'>
                      (TB(IOB+1,KOBP,JOB)))+DyOB*((1.-DxOB)*        &amp;<a name='1271'>
                      (TB(IOB,KOBP,JOB+1))+DxOB*                    &amp;<a name='1272'>
                      (TB(IOB+1,KOBP,JOB+1)))))<a name='1273'>
<a name='1274'>
<font color=#447700>!       if(n.le.10) then<a name='1275'></font>
<font color=#447700>!         write(6,*)<a name='1276'></font>
<font color=#447700>!         write(6,'(a,i3,i3,i3,a,i3,a,i2)') 'ERRF3 at ',iob,job,kob,   &amp;<a name='1277'></font>
<font color=#447700>!                                      ' N = ',n,' inest = ',inest<a name='1278'></font>
<font color=#447700>!         write(6,*) 'VAROBS(3,N) = ',varobs(3,n)<a name='1279'></font>
<font color=#447700>!         write(6,*) 'VAROBS(5,N) = ',varobs(5,n)<a name='1280'></font>
<font color=#447700>!         write(6,*) 'TB(IOB,KOB,JOB) = ',TB(IOB,KOB,JOB)<a name='1281'></font>
<font color=#447700>!         write(6,*) 'TB(IOB+1,KOB,JOB) = ',TB(IOB+1,KOB,JOB)<a name='1282'></font>
<font color=#447700>!         write(6,*) 'TB(IOB,KOB,JOB+1) = ',TB(IOB,KOB,JOB+1)<a name='1283'></font>
<font color=#447700>!         write(6,*) 'TB(IOB+1,KOB,JOB+1) = ',TB(IOB+1,KOB,JOB+1)<a name='1284'></font>
<font color=#447700>!         write(6,*) 'TB(IOB,KOBP,JOB) = ',TB(IOB,KOBP,JOB)<a name='1285'></font>
<font color=#447700>!         write(6,*) 'TB(IOB+1,KOBP,JOB) = ',TB(IOB+1,KOBP,JOB)<a name='1286'></font>
<font color=#447700>!         write(6,*) 'TB(IOB,KOBP,JOB+1) = ',TB(IOB,KOBP,JOB+1)<a name='1287'></font>
<font color=#447700>!         write(6,*) 'TB(IOB+1,KOBP,JOB+1) = ',TB(IOB+1,KOBP,JOB+1)<a name='1288'></font>
<font color=#447700>!         write(6,*) 'tratxob = ',tratxob<a name='1289'></font>
<font color=#447700>!         write(6,*) 'DXOB,DYOB,DZOB = ',DXOB,DYOB,DZOB<a name='1290'></font>
<font color=#447700>!         write(6,*) 'ERRF(3,N) = ',errf(3,n)<a name='1291'></font>
<font color=#447700>!         write(6,*)<a name='1292'></font>
<font color=#447700>!       endif<a name='1293'></font>
<a name='1294'>
<font color=#447700>!           MOISTURE ERROR<a name='1295'></font>
            ERRF(4,N)=ERRF(4,N)+VAROBS(4,N)-((1.-DZOB)*((1.-DyOB)*((1.- &amp;<a name='1296'>
                      DxOB)*QVB(IOB,KOB,JOB)+DxOB*                      &amp;<a name='1297'>
                      QVB(IOB+1,KOB,JOB))+DyOB*((1.-DxOB)*              &amp;<a name='1298'>
                      QVB(IOB,KOB,JOB+1)+DxOB*                          &amp;<a name='1299'>
                      QVB(IOB+1,KOB,JOB+1)))+DZOB*((1.-                 &amp;<a name='1300'>
                      DyOB)*((1.-DxOB)*QVB(IOB,KOBP,JOB)+DxOB           &amp;<a name='1301'>
                      *QVB(IOB+1,KOBP,JOB))+DyOB*((1.-DxOB              &amp;<a name='1302'>
                      )*QVB(IOB,KOBP,JOB+1)+DxOB*                       &amp;<a name='1303'>
                      QVB(IOB+1,KOBP,JOB+1))))<a name='1304'>
<a name='1305'>
<font color=#447700>!           Store model moisture value (not the error!) at the location<a name='1306'></font>
<font color=#447700>!           that the error was calculated<a name='1307'></font>
            ERRF(10,N)=ERRF(10,N)+((1.-DZOB)*((1.-DyOB)*((1.- &amp;<a name='1308'>
                      DxOB)*QVB(IOB,KOB,JOB)+DxOB*                      &amp;<a name='1309'>
                      QVB(IOB+1,KOB,JOB))+DyOB*((1.-DxOB)*              &amp;<a name='1310'>
                      QVB(IOB,KOB,JOB+1)+DxOB*                          &amp;<a name='1311'>
                      QVB(IOB+1,KOB,JOB+1)))+DZOB*((1.-                 &amp;<a name='1312'>
                      DyOB)*((1.-DxOB)*QVB(IOB,KOBP,JOB)+DxOB           &amp;<a name='1313'>
                      *QVB(IOB+1,KOBP,JOB))+DyOB*((1.-DxOB              &amp;<a name='1314'>
                      )*QVB(IOB,KOBP,JOB+1)+DxOB*                       &amp;<a name='1315'>
                      QVB(IOB+1,KOBP,JOB+1))))<a name='1316'>
<a name='1317'>
<a name='1318'>
<font color=#447700>!           Store model surface pressure (not the error!) at T-point<a name='1319'></font>
            ERRF(6,N)= .001*                                            &amp;<a name='1320'>
                      ((1.-DyOB)*((1.-DxOB)*pbase(IOB,1,JOB)+DxOB*      &amp;<a name='1321'>
                      pbase(IOB+1,1,JOB))+DyOB*((1.-DxOB)*              &amp;<a name='1322'>
                      pbase(IOB,1,JOB+1)+DxOB*pbase(IOB+1,1,JOB+1) ))<a name='1323'>
<a name='1324'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1325'></font>
          ENDIF       <font color=#447700>! end IF( MP_LOCAL_COBMASK(N) )<a name='1326'></font>
#endif<a name='1327'>
        ENDDO     <font color=#447700>! END T and QV LOOP OVER OBS<a name='1328'></font>
<a name='1329'>
      ENDIF   <font color=#447700>!end if(istemp.eq.1 .or. ismois.eq.1)<a name='1330'></font>
<a name='1331'>
<font color=#447700>!*******************************************************<a name='1332'></font>
<font color=#447700>!   USE ERRF(5,N) TO STORE KPBL AT (I,J) NEAREST THE OBS<a name='1333'></font>
<font color=#447700>!*******************************************************<a name='1334'></font>
      DO N=1,NSTA<a name='1335'>
        IOB=MAX0(1,IA(N))<a name='1336'>
        IOB=MIN0(IOB,ide-1)<a name='1337'>
        JOB=MAX0(1,IB(N))<a name='1338'>
        JOB=MIN0(JOB,jde-1)<a name='1339'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1340'></font>
        IF(MP_LOCAL_COBMASK(N)) THEN    <font color=#447700>! Do if obs on this processor<a name='1341'></font>
#endif<a name='1342'>
          DXOB=RA(N)<a name='1343'>
          DYOB=RB(N)<a name='1344'>
          ERRF(5,N) = kpbl(iob+nint(dxob),job+nint(dyob))<a name='1345'>
<a name='1346'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1347'></font>
        ENDIF       <font color=#447700>! end IF( MP_LOCAL_COBMASK(N) )<a name='1348'></font>
#endif<a name='1349'>
      ENDDO<a name='1350'>
<font color=#447700>!!**********************************************************<a name='1351'></font>
    ENDIF   <font color=#447700>! end if(ityp.eq.3)<a name='1352'></font>
<a name='1353'>
  ENDDO   <font color=#447700>! END BIG LOOP<a name='1354'></font>
<a name='1355'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1356'></font>
<font color=#447700>! Gather the errf values calculated by the processors with the obs.<a name='1357'></font>
  CALL <A href='../../html_code/frame/module_dm.F.html#GET_FULL_OBS_VECTOR'>get_full_obs_vector</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_FULL_OBS_VECTOR_1">(nsta, nerrf, niobf, mp_local_uobmask,     &amp;<a name='1358'>
                           mp_local_vobmask, mp_local_cobmask, errf)<a name='1359'>
<a name='1360'>
<font color=#447700>! 02252010: Go ahead and assign rko for "obs-off" processors here, to<a name='1361'></font>
<font color=#447700>!           fix the problem where duplicate obs can be dropped from<a name='1362'></font>
<font color=#447700>!           the "obs-on" processor, but not from the others, due to<a name='1363'></font>
<font color=#447700>!           rko being -99 on the "obs-off" processors.<a name='1364'></font>
  do n=1,nsta<a name='1365'>
    rko(n) = errf(9,n)<a name='1366'>
  enddo<a name='1367'>
<font color=#447700>! 02252010: End bugfix.<a name='1368'></font>
#endif<a name='1369'>
<a name='1370'>
<font color=#447700>! Print obs information.<a name='1371'></font>
  CALL <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_OBS_INFO'>print_obs_info</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#ERROB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PRINT_OBS_INFO_1">(iprt,inest,niobf,rio,rjo,rko,                  &amp;<a name='1372'>
                      prt_max,prt_freq,obs_prt,stnid_prt,            &amp;<a name='1373'>
                      lat_prt,lon_prt,mlat_prt,mlon_prt,             &amp;<a name='1374'>
                      timeob,xtime)<a name='1375'>
<a name='1376'>
<font color=#447700>! DIFFERENCE BETWEEN OBS AND FCST IS COMPLETED<a name='1377'></font>
  IF(INEST.EQ.1)THEN<a name='1378'>
    INPF=NPFI<a name='1379'>
  ELSE<a name='1380'>
    FNPF=IRATIO**LEVIDN(INEST)<a name='1381'>
    INPF=FNPF*NPFI<a name='1382'>
  ENDIF<a name='1383'>
<font color=#447700>! Gross error check for temperature. Set all vars bad.<a name='1384'></font>
  do n=1,nsta<a name='1385'>
    if((abs(errf(3,n)).gt.20.).and.           &amp;<a name='1386'>
           (errf(3,n).gt.-800000.))then<a name='1387'>
<a name='1388'>
       errf(1,n)=-888888.<a name='1389'>
       errf(2,n)=-888888.<a name='1390'>
       errf(3,n)=-888888.<a name='1391'>
       errf(4,n)=-888888.<a name='1392'>
       varobs(1,n)=-888888.<a name='1393'>
       varobs(2,n)=-888888.<a name='1394'>
       varobs(3,n)=-888888.<a name='1395'>
       varobs(4,n)=-888888.<a name='1396'>
    endif<a name='1397'>
  enddo<a name='1398'>
<a name='1399'>
<font color=#447700>! For printout<a name='1400'></font>
<font color=#447700>!  IF(MOD(KTAU,INPF).NE.0) THEN<a name='1401'></font>
<font color=#447700>!      RETURN<a name='1402'></font>
<font color=#447700>!  ENDIF<a name='1403'></font>
<a name='1404'>
  RETURN<a name='1405'>
  END SUBROUTINE errob<a name='1406'>
<a name='1407'>
<A NAME='UPOINT'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#UPOINT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1408'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>upoint</font>(i_start,i_end, j_start,j_end, ids,ide, ims,ime, jms,jme,  &amp; <A href='../../call_to/UPOINT.html' TARGET='index'>1</A><a name='1409'>
                    arrin, arrout)<a name='1410'>
<font color=#447700>!------------------------------------------------------------------------------<a name='1411'></font>
<font color=#447700>!     PURPOSE: This subroutine interpolates a real 2D array defined over mass<a name='1412'></font>
<font color=#447700>!              coordinate points, to U (momentum) points.<a name='1413'></font>
<font color=#447700>!<a name='1414'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='1415'></font>
  IMPLICIT NONE<a name='1416'>
<a name='1417'>
  INTEGER, INTENT(IN) :: i_start     <font color=#447700>! Starting i index for this model tile<a name='1418'></font>
  INTEGER, INTENT(IN) :: i_end       <font color=#447700>! Ending   i index for this model tile<a name='1419'></font>
  INTEGER, INTENT(IN) :: j_start     <font color=#447700>! Starting j index for this model tile<a name='1420'></font>
  INTEGER, INTENT(IN) :: j_end       <font color=#447700>! Ending   j index for this model tile<a name='1421'></font>
  INTEGER, INTENT(IN) :: ids         <font color=#447700>! Starting i index for entire model domain<a name='1422'></font>
  INTEGER, INTENT(IN) :: ide         <font color=#447700>! Ending   i index for entire model domain<a name='1423'></font>
  INTEGER, INTENT(IN) :: ims         <font color=#447700>! Starting i index for model patch <a name='1424'></font>
  INTEGER, INTENT(IN) :: ime         <font color=#447700>! Ending   i index for model patch <a name='1425'></font>
  INTEGER, INTENT(IN) :: jms         <font color=#447700>! Starting j index for model patch <a name='1426'></font>
  INTEGER, INTENT(IN) :: jme         <font color=#447700>! Ending   j index for model patch <a name='1427'></font>
  REAL,   INTENT(IN)  :: arrin ( ims:ime, jms:jme )  <font color=#447700>! input array on mass points<a name='1428'></font>
  REAL,   INTENT(OUT) :: arrout( ims:ime, jms:jme )  <font color=#447700>! output array on U points <a name='1429'></font>
<a name='1430'>
<font color=#447700>! Local variables<a name='1431'></font>
  integer :: i, j<a name='1432'>
<a name='1433'>
<font color=#447700>! Do domain interior first<a name='1434'></font>
  do j = j_start, j_end<a name='1435'>
    do i = max(2,i_start), i_end<a name='1436'>
       arrout(i,j) = 0.5*(arrin(i,j)+arrin(i-1,j))<a name='1437'>
    enddo<a name='1438'>
  enddo<a name='1439'>
<a name='1440'>
<font color=#447700>! Do west-east boundaries<a name='1441'></font>
  if(i_start .eq. ids) then<a name='1442'>
    do j = j_start, j_end<a name='1443'>
      arrout(i_start,j) = arrin(i_start,j)<a name='1444'>
    enddo<a name='1445'>
  endif<a name='1446'>
  if(i_end .eq. ide-1) then<a name='1447'>
    do j = j_start, j_end<a name='1448'>
      arrout(i_end+1,j) = arrin(i_end,j)<a name='1449'>
    enddo<a name='1450'>
  endif<a name='1451'>
<a name='1452'>
  RETURN<a name='1453'>
  END SUBROUTINE upoint<a name='1454'>
<a name='1455'>
<A NAME='VPOINT'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#VPOINT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1456'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>vpoint</font>(i_start,i_end, j_start,j_end, jds,jde, ims,ime, jms,jme,  &amp; <A href='../../call_to/VPOINT.html' TARGET='index'>1</A><a name='1457'>
                    arrin, arrout)<a name='1458'>
<font color=#447700>!------------------------------------------------------------------------------<a name='1459'></font>
<font color=#447700>!     PURPOSE: This subroutine interpolates a real 2D array defined over mass<a name='1460'></font>
<font color=#447700>!              coordinate points, to V (momentum) points.<a name='1461'></font>
<font color=#447700>!<a name='1462'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='1463'></font>
  IMPLICIT NONE<a name='1464'>
<a name='1465'>
  INTEGER, INTENT(IN) :: i_start     <font color=#447700>! Starting i index for this model tile<a name='1466'></font>
  INTEGER, INTENT(IN) :: i_end       <font color=#447700>! Ending   i index for this model tile<a name='1467'></font>
  INTEGER, INTENT(IN) :: j_start     <font color=#447700>! Starting j index for this model tile<a name='1468'></font>
  INTEGER, INTENT(IN) :: j_end       <font color=#447700>! Ending   j index for this model tile<a name='1469'></font>
  INTEGER, INTENT(IN) :: jds         <font color=#447700>! Starting j index for entire model domain<a name='1470'></font>
  INTEGER, INTENT(IN) :: jde         <font color=#447700>! Ending   j index for entire model domain<a name='1471'></font>
  INTEGER, INTENT(IN) :: ims         <font color=#447700>! Starting i index for model patch <a name='1472'></font>
  INTEGER, INTENT(IN) :: ime         <font color=#447700>! Ending   i index for model patch <a name='1473'></font>
  INTEGER, INTENT(IN) :: jms         <font color=#447700>! Starting j index for model patch <a name='1474'></font>
  INTEGER, INTENT(IN) :: jme         <font color=#447700>! Ending   j index for model patch <a name='1475'></font>
  REAL,   INTENT(IN)  :: arrin ( ims:ime, jms:jme )  <font color=#447700>! input array on mass points<a name='1476'></font>
  REAL,   INTENT(OUT) :: arrout( ims:ime, jms:jme )  <font color=#447700>! output array on V points <a name='1477'></font>
<a name='1478'>
<font color=#447700>! Local variables<a name='1479'></font>
  integer :: i, j<a name='1480'>
<a name='1481'>
<font color=#447700>! Do domain interior first<a name='1482'></font>
  do j = max(2,j_start), j_end<a name='1483'>
    do i = i_start, i_end<a name='1484'>
      arrout(i,j) = 0.5*(arrin(i,j)+arrin(i,j-1))<a name='1485'>
    enddo<a name='1486'>
  enddo<a name='1487'>
<a name='1488'>
<font color=#447700>! Do south-north boundaries<a name='1489'></font>
  if(j_start .eq. jds) then<a name='1490'>
    do i = i_start, i_end<a name='1491'>
      arrout(i,j_start) = arrin(i,j_start)<a name='1492'>
    enddo<a name='1493'>
  endif<a name='1494'>
  if(j_end .eq. jde-1) then<a name='1495'>
    do i = i_start, i_end<a name='1496'>
      arrout(i,j_end+1) = arrin(i,j_end)<a name='1497'>
    enddo<a name='1498'>
  endif<a name='1499'>
<a name='1500'>
  RETURN<a name='1501'>
  END SUBROUTINE vpoint<a name='1502'>
<a name='1503'>
<A NAME='TILE_MASK'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#TILE_MASK' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1504'>
  LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>TILE_MASK</font>(iloc, jloc, its, ite, jts, jte) <A href='../../call_to/TILE_MASK.html' TARGET='index'>5</A><a name='1505'>
<font color=#447700>!------------------------------------------------------------------------------<a name='1506'></font>
<font color=#447700>! PURPOSE: Check to see if an i, j grid coordinate is in the tile index range.<a name='1507'></font>
<font color=#447700>!      <a name='1508'></font>
<font color=#447700>! Returns: TRUE if the grid coordinate (ILOC,JLOC) is in the tile defined by<a name='1509'></font>
<font color=#447700>!                  tile-range indices (its,jts) and (ite,jte)<a name='1510'></font>
<font color=#447700>!          FALSE otherwise.<a name='1511'></font>
<font color=#447700>!<a name='1512'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='1513'></font>
  IMPLICIT NONE<a name='1514'>
<a name='1515'>
  INTEGER, INTENT(IN) :: iloc<a name='1516'>
  INTEGER, INTENT(IN) :: jloc<a name='1517'>
  INTEGER, INTENT(IN) :: its<a name='1518'>
  INTEGER, INTENT(IN) :: ite<a name='1519'>
  INTEGER, INTENT(IN) :: jts<a name='1520'>
  INTEGER, INTENT(IN) :: jte<a name='1521'>
<a name='1522'>
<font color=#447700>! Local variables<a name='1523'></font>
  LOGICAL :: retval<a name='1524'>
<a name='1525'>
  TILE_MASK = (iloc .LE. ite .AND. iloc .GE. its .AND.    &amp;<a name='1526'>
               jloc .LE. jte .AND. jloc .GE. jts )<a name='1527'>
<a name='1528'>
  RETURN<a name='1529'>
  END FUNCTION TILE_MASK<a name='1530'>
<a name='1531'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1532'></font>
<A NAME='NUDOB'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1533'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>nudob</font>(j, ivar, aten, inest, ifrest, ktau, ktaur,         &amp; <A href='../../call_to/NUDOB.html' TARGET='index'>4</A>,<A href='../../call_from/NUDOB.html' TARGET='index'>21</A><a name='1534'>
                       xtime, mu, c1h, c2h, msfx, msfy,               &amp;<a name='1535'>
                       nndgv, nerrf, niobf, maxdom,                   &amp;<a name='1536'>
                       npfi, ionf, rinxy, twindo,                     &amp;<a name='1537'>
                       nudge_pbl,                                     &amp;<a name='1538'>
                       sfcfact, sfcfacr,                              &amp;<a name='1539'>
                       levidn,                                        &amp;<a name='1540'>
                       parid, nstat,                                  &amp;<a name='1541'>
                       rinfmn, rinfmx, pfree, dcon, tfaci,            &amp;<a name='1542'>
                       sfc_scheme_horiz, sfc_scheme_vert, maxsnd_gap, &amp;<a name='1543'>
                       lev_in_ob, plfo, nlevs_ob,                     &amp;<a name='1544'>
                       iratio, dx, dtmin, rio, rjo, rko,              &amp;<a name='1545'>
                       timeob, varobs, errf, pbase, ptop, pp,         &amp;<a name='1546'>
                       iswind, istemp, ismois, giv, git, giq,         &amp;<a name='1547'>
                       savwt, kpblt, nscan,                           &amp;<a name='1548'>
                       vih1, vih2, terrh, zslab,                      &amp;<a name='1549'>
                       iprt,                                          &amp;<a name='1550'>
                       ids,ide, jds,jde, kds,kde,                     &amp;  <font color=#447700>! domain dims<a name='1551'></font>
                       ims,ime, jms,jme, kms,kme,                     &amp;  <font color=#447700>! memory dims<a name='1552'></font>
                       its,ite, jts,jte, kts,kte,                     &amp;  <font color=#447700>! tile   dims<a name='1553'></font>
                       qvb, obs_scl_neg_qv_innov ) <font color=#447700>! Water vapor mixing ratio / scale negative qv innovations<a name='1554'></font>
<a name='1555'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1556'></font>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_66"><a name='1557'>
  USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_231"><a name='1558'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1559'></font>
  IMPLICIT NONE<a name='1560'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1561'></font>
<font color=#447700>!<a name='1562'></font>
<font color=#447700>! PURPOSE: THIS SUBROUTINE GENERATES NUDGING TENDENCIES FOR THE J-TH<a name='1563'></font>
<font color=#447700>!     VERTICAL SLICE (I-K PLANE) FOR FOUR-DIMENSIONAL DATA<a name='1564'></font>
<font color=#447700>!     ASSIMILATION FROM INDIVIDUAL OBSERVATIONS.  THE NUDGING<a name='1565'></font>
<font color=#447700>!     TENDENCIES ARE FOUND FROM A ONE-PASS CALCULATION OF<a name='1566'></font>
<font color=#447700>!     WEIGHTING FACTORS SIMILAR TO THE BENJAMIN-SEAMAN OBJECTIVE<a name='1567'></font>
<font color=#447700>!     ANALYSIS.  THIS SUBROUTINE IS DESIGNED FOR RAPID EXECUTION<a name='1568'></font>
<font color=#447700>!     AND MINIMAL STORAGE REQUIREMENTS.  ALGORITHMS SHOULD BE<a name='1569'></font>
<font color=#447700>!     VECTORIZED WHEREVER POSSIBLE.<a name='1570'></font>
<font color=#447700>!<a name='1571'></font>
<font color=#447700>!     HISTORY: Original author: MM5 version???<a name='1572'></font>
<font color=#447700>!              02/04/2004 - Creation of WRF version.           Al Bourgeois<a name='1573'></font>
<font color=#447700>!              08/28/2006 - Conversion from F77 to F90         Al Bourgeois<a name='1574'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='1575'></font>
<font color=#447700>!<a name='1576'></font>
<font color=#447700>! NOTE: This routine was originally designed for MM5, which uses<a name='1577'></font>
<font color=#447700>!       a nonstandard (I,J) coordinate system. For WRF, I is the <a name='1578'></font>
<font color=#447700>!       east-west running coordinate, and J is the south-north<a name='1579'></font>
<font color=#447700>!       running coordinate. So a "J-slab" here is west-east in<a name='1580'></font>
<font color=#447700>!       extent, not south-north as for MM5.      -ajb 06/10/2004<a name='1581'></font>
<font color=#447700>!<a name='1582'></font>
<font color=#447700>!     NET WEIGHTING (WT) OF THE DIFFERENCE BETWEEN THE OBSERVATIONS<a name='1583'></font>
<font color=#447700>!     AND LOCAL FORECAST VALUES IS BASED ON THE MULTIPLE OF THREE<a name='1584'></font>
<font color=#447700>!     TYPES OF FACTORS:<a name='1585'></font>
<font color=#447700>!       1) TIME WEIGHTING - ONLY OBSERVATIONS WITHIN A SELECTED<a name='1586'></font>
<font color=#447700>!          TIME WINDOW (TWINDO) CENTERED AT THE CURRENT FORECAST<a name='1587'></font>
<font color=#447700>!          TIME (XTIME) ARE USED.  OBSERVATIONS CLOSEST TO<a name='1588'></font>
<font color=#447700>!          XTIME ARE TIME-WEIGHTED MOST HEAVILY (TIMEWT)<a name='1589'></font>
<font color=#447700>!       2) VERTICAL WEIGHTING - NON-ZERO WEIGHTS (WTSIG) ARE<a name='1590'></font>
<font color=#447700>!          CALCULATED WITHIN A VERTICAL REGION OF INFLUENCE<a name='1591'></font>
<font color=#447700>!          (RINSIG).<a name='1592'></font>
<font color=#447700>!       3) HORIZONTAL WEIGHTING - NON-ZERO WEIGHTS (WTIJ) ARE<a name='1593'></font>
<font color=#447700>!          CALCULATED WITHIN A RADIUS OF INFLUENCE (RINXY).  THE<a name='1594'></font>
<font color=#447700>!          VALUE OF RIN IS DEFINED IN KILOMETERS, AND CONVERTED<a name='1595'></font>
<font color=#447700>!          TO GRID LENGTHS FOR THE APPROPRIATE MESH SIZE.<a name='1596'></font>
<font color=#447700>!<a name='1597'></font>
<font color=#447700>!     THE FIVE FORECAST VARIABLES ARE PROCESSED BY CHANGING THE<a name='1598'></font>
<font color=#447700>!     VALUE OF IVAR AS FOLLOWS:<a name='1599'></font>
<font color=#447700>!             IVAR                     VARIABLE(TAU-1)<a name='1600'></font>
<font color=#447700>!             ----                     ---------------<a name='1601'></font>
<font color=#447700>!               1                             U<a name='1602'></font>
<font color=#447700>!               2                             V<a name='1603'></font>
<font color=#447700>!               3                             T<a name='1604'></font>
<font color=#447700>!               4                             QV<a name='1605'></font>
<font color=#447700>!               5                          PSB(CROSS)   REMOVED IN V3<a name='1606'></font>
<font color=#447700>!              (6)                           PSB(DOT)<a name='1607'></font>
<font color=#447700>!<a name='1608'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1609'></font>
<font color=#447700>!<a name='1610'></font>
<font color=#447700>!     Description of input arguments.<a name='1611'></font>
<font color=#447700>!<a name='1612'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1613'></font>
<a name='1614'>
  INTEGER, INTENT(IN)  :: ids,ide, jds,jde, kds,kde  <font color=#447700>! domain dims.<a name='1615'></font>
  INTEGER, INTENT(IN)  :: ims,ime, jms,jme, kms,kme  <font color=#447700>! memory dims.<a name='1616'></font>
  INTEGER, INTENT(IN)  :: its,ite, jts,jte, kts,kte  <font color=#447700>! tile   dims.<a name='1617'></font>
  INTEGER, INTENT(IN)  :: j                          <font color=#447700>! south-north running coordinate.<a name='1618'></font>
  INTEGER, INTENT(IN)  :: ivar<a name='1619'>
  INTEGER, INTENT(IN)  :: inest                      <font color=#447700>! domain index<a name='1620'></font>
  LOGICAL, INTENT(IN)  :: ifrest<a name='1621'>
  INTEGER, INTENT(IN)  :: ktau<a name='1622'>
  INTEGER, INTENT(IN)  :: ktaur<a name='1623'>
  REAL, INTENT(IN)     :: xtime                      <font color=#447700>! forecast time in minutes<a name='1624'></font>
  INTEGER, INTENT(IN)  :: nndgv                      <font color=#447700>! number of nudge variables<a name='1625'></font>
  INTEGER, INTENT(IN)  :: nerrf                      <font color=#447700>! number of error fields<a name='1626'></font>
  INTEGER, INTENT(IN)  :: niobf                      <font color=#447700>! number of observations<a name='1627'></font>
  INTEGER, INTENT(IN)  :: maxdom                     <font color=#447700>! maximum number of domains<a name='1628'></font>
  INTEGER, INTENT(IN)  :: npfi <a name='1629'>
  INTEGER, INTENT(IN)  :: ionf<a name='1630'>
  REAL, INTENT(IN)     :: rinxy<a name='1631'>
  REAL, INTENT(IN)     :: twindo<a name='1632'>
  REAL, intent(in)     :: sfcfact                    <font color=#447700>! scale for time window (surface obs) <a name='1633'></font>
  REAL, intent(in)     :: sfcfacr                    <font color=#447700>! scale for hor rad inf (surface obs)<a name='1634'></font>
  LOGICAL, intent(in)  :: nudge_pbl                  <font color=#447700>! flag for nudging in pbl<a name='1635'></font>
  INTEGER, INTENT(IN)  :: levidn(maxdom)             <font color=#447700>! level of nest<a name='1636'></font>
  INTEGER, INTENT(IN)  :: parid(maxdom)              <font color=#447700>! parent domain id<a name='1637'></font>
  INTEGER, INTENT(IN)  :: nstat                      <font color=#447700>! number of obs stations<a name='1638'></font>
  REAL,    INTENT(IN)  :: rinfmn          <font color=#447700>! minimum radius of influence<a name='1639'></font>
  REAL,    INTENT(IN)  :: rinfmx          <font color=#447700>! maximum radius of influence<a name='1640'></font>
  REAL,    INTENT(IN)  :: pfree           <font color=#447700>! pressure level (cb) where terrain effect becomes small<a name='1641'></font>
  REAL,    INTENT(IN)  :: dcon            <font color=#447700>! 1/DPSMX<a name='1642'></font>
  REAL,    INTENT(IN)  :: tfaci           <font color=#447700>! scale factor used for ramp-down in dynamic initialization<a name='1643'></font>
  INTEGER , INTENT(IN) :: sfc_scheme_horiz <font color=#447700>! horizontal spreading scheme for surf obs (wrf or orig mm5)<a name='1644'></font>
  INTEGER , INTENT(IN) :: sfc_scheme_vert  <font color=#447700>! vertical   spreading scheme for surf obs (orig or regime vif)<a name='1645'></font>
  REAL    , INTENT(IN) :: maxsnd_gap      <font color=#447700>! max allowed pressure gap in soundings, for interp (centibars)<a name='1646'></font>
  REAL, INTENT(IN)     :: lev_in_ob(niobf)           <font color=#447700>! Level in sounding-type obs.<a name='1647'></font>
  REAL, intent(IN)     :: plfo(niobf)                <font color=#447700>! Index for type of obs platform<a name='1648'></font>
  REAL, INTENT(IN)     :: nlevs_ob(niobf)            <font color=#447700>! Number of levels in sounding.<a name='1649'></font>
  INTEGER, INTENT(IN)  :: iratio                     <font color=#447700>! Nest to parent gridsize ratio.<a name='1650'></font>
  REAL, INTENT(IN)     :: dx                         <font color=#447700>! This domain grid cell-size (m)<a name='1651'></font>
  REAL, INTENT(IN)     :: dtmin                      <font color=#447700>! Model time step in minutes<a name='1652'></font>
  REAL, INTENT(IN)     :: rio(niobf)                 <font color=#447700>! Obs west-east coordinate (non-stag grid).<a name='1653'></font>
  REAL, INTENT(IN)     :: rjo(niobf)                 <font color=#447700>! Obs south-north coordinate (non-stag grid).<a name='1654'></font>
  REAL, INTENT(INOUT)  :: rko(niobf)                 <font color=#447700>! Obs vertical coordinate.<a name='1655'></font>
  REAL, INTENT(IN)     :: timeob(niobf)<a name='1656'>
  REAL, INTENT(IN)     :: varobs(nndgv,niobf)<a name='1657'>
  REAL, INTENT(IN)     :: errf(nerrf, niobf)<a name='1658'>
  REAL, INTENT(IN)     :: pbase( ims:ime, kms:kme )  <font color=#447700>! Base pressure.<a name='1659'></font>
  REAL, INTENT(IN)     :: ptop<a name='1660'>
  REAL, INTENT(IN)     :: pp( ims:ime, kms:kme ) <font color=#447700>! Pressure perturbation (Pa)<a name='1661'></font>
  REAL, INTENT(IN) , DIMENSION(ims:ime)    :: mu   <font color=#447700>! Air mass on u, v, or mass-grid<a name='1662'></font>
  REAL, INTENT(IN) , DIMENSION(kms:kme)    :: c1h  <font color=#447700>! Hybrid coordinate weight<a name='1663'></font>
  REAL, INTENT(IN) , DIMENSION(kms:kme)    :: c2h  <font color=#447700>! Hybrid coordinate weight<a name='1664'></font>
  REAL, INTENT(IN)     :: msfx(ims:ime)  <font color=#447700>! Map scale (only used for vars u &amp; v)<a name='1665'></font>
  REAL, INTENT(IN)     :: msfy(ims:ime)  <font color=#447700>! Map scale (only used for vars u &amp; v)<a name='1666'></font>
  INTEGER, intent(in)  :: iswind        <font color=#447700>! Nudge flag for wind<a name='1667'></font>
  INTEGER, intent(in)  :: istemp        <font color=#447700>! Nudge flag for temperature<a name='1668'></font>
  INTEGER, intent(in)  :: ismois        <font color=#447700>! Nudge flag for moisture<a name='1669'></font>
  REAL, intent(in)     :: giv           <font color=#447700>! Coefficient for wind<a name='1670'></font>
  REAL, intent(in)     :: git           <font color=#447700>! Coefficient for temperature<a name='1671'></font>
  REAL, intent(in)     :: giq           <font color=#447700>! Coefficient for moisture<a name='1672'></font>
  REAL, INTENT(INOUT)  :: aten( ims:ime, kms:kme)<a name='1673'>
  REAL, INTENT(INOUT)  :: savwt( nndgv, ims:ime, kms:kme )<a name='1674'>
  INTEGER, INTENT(IN)  :: kpblt(ims:ime)<a name='1675'>
  INTEGER, INTENT(IN)  :: nscan                      <font color=#447700>! number of scans<a name='1676'></font>
  REAL, INTENT(IN)     :: vih1(its:ite) <font color=#447700>! Vert infl ht (m) abv grd for full wts<a name='1677'></font>
  REAL, INTENT(IN)     :: vih2(its:ite) <font color=#447700>! Vert infl ht (m) abv grd for ramp<a name='1678'></font>
  REAL, INTENT(IN)     :: terrh(ims:ime) <font color=#447700>! Terrain height (m)<a name='1679'></font>
<font color=#447700>! INTEGER, INTENT(IN)  :: vik1(its:ite) ! Vertical infl k-level for full wts<a name='1680'></font>
<font color=#447700>! INTEGER, INTENT(IN)  :: vik2(its:ite) ! Vertical infl k-level for ramp<a name='1681'></font>
  REAL, INTENT(IN)     :: zslab(ims:ime, kms:kme)    <font color=#447700>! model ht above sea level (m)<a name='1682'></font>
  LOGICAL, INTENT(IN)  :: iprt                       <font color=#447700>! print flag<a name='1683'></font>
  REAL                 :: abs_pdiff_below, abs_pdiff_above<a name='1684'>
  REAL,   INTENT(IN)   :: qvb( ims:ime, kms:kme, jms:jme ) <font color=#447700>! Water vapor mixing ratio (QV)<a name='1685'></font>
  INTEGER, INTENT(IN)  :: obs_scl_neg_qv_innov <font color=#447700>! User choice on whether negative qv innovations should be scaled<a name='1686'></font>
  REAL                 :: qvb_at_cur_loc, qvb_at_ob_loc <font color=#447700>! QV at the current model or the observation location<a name='1687'></font>
  REAL                 :: SCALE_FACTOR_NEG_QV_INNOV <font color=#447700>! Multiply QV innovation by this factor to avoid nudging toward negative QV<a name='1688'></font>
  REAL                 :: QVB_CUR_LOC_OVER_OB_LOC <font color=#447700>! Ratio of QV at current model location compared to ob location<a name='1689'></font>
<a name='1690'>
<font color=#447700>! Local variables<a name='1691'></font>
  integer :: mm(maxdom)<a name='1692'>
  integer :: kobs                  <font color=#447700>! k-lev below obs (for obs straddling pblt)<a name='1693'></font>
  integer :: kpbl_obs(nstat)       <font color=#447700>! kpbl at grid point (IOB,JOB) (ajb 20090519)<a name='1694'></font>
  real :: ra(niobf)<a name='1695'>
  real :: rb(niobf)<a name='1696'>
  real :: psurf(niobf)<a name='1697'>
  real :: wtsig(kms:kme),wt(ims:ime,kms:kme),wt2err(ims:ime,kms:kme)<a name='1698'>
  real :: rscale(ims:ime)           <font color=#447700>! For converting to rho-coupled units.<a name='1699'></font>
  real :: wtij(ims:ime)             <font color=#447700>! For holding weights in i-loop<a name='1700'></font>
  real :: reserf(100)<a name='1701'>
  character*40 name<a name='1702'>
  character*3 chr_hr<a name='1703'>
  character(len=200) :: msg            <font color=#447700>! Argument to wrf_message<a name='1704'></font>
<a name='1705'>
<font color=#447700>!***  DECLARATIONS FOR IMPLICIT NONE<a name='1706'></font>
  integer :: i,k,iplo,icut,ipl,inpf,infr,jjjn<a name='1707'>
  integer :: igrid,n,nml,nnl,nsthis,nsmetar,nsspeci,nsship<a name='1708'>
  integer :: nssynop,nstemp,nspilot,nssatwnds,nssams,nsprofs<a name='1709'>
  integer :: maxi,mini,maxj,minj,nnn,nsndlev,njcsnd,kob<a name='1710'>
  integer :: komin,komax,nn,nhi,nlo,nnjc<a name='1711'>
  integer :: i_s,i_e<a name='1712'>
  integer :: istq<a name='1713'>
  real :: gfactor,rfactor,gridx,gridy,rindx,ris<a name='1714'>
  real :: grfacx,grfacy<a name='1715'>
  real :: timewt,pob<a name='1716'>
  real :: ri,rj,rx,ry,rsq,pdfac,erfivr,dk,slope,rinfac<a name='1717'>
  real :: dprim,dsq,d     <font color=#447700>! vars for mm5 surface-ob weighting<a name='1718'></font>
  real :: rinprs,pijk,pobhi,poblo,pdiffj,w2eowt,gitq<a name='1719'>
  real :: dz_ramp         <font color=#447700>! For ramping weights for surface obs <a name='1720'></font>
<a name='1721'>
  real :: scratch<a name='1722'>
  integer :: kk <font color=#447700>!ajb temp<a name='1723'></font>
<a name='1724'>
<font color=#447700>!      print *,'start nudob, nstat,j,ivar=',nstat,j,ivar<a name='1725'></font>
<font color=#447700>!      if(ivar.ne.4)return<a name='1726'></font>
<font color=#447700>!yliu start -- for multi-scans: NSCAN=0: original<a name='1727'></font>
<font color=#447700>!                               NSCAN=1: added a scan with a larger Ri and smaller G<a name='1728'></font>
<font color=#447700>!       if(NSCAN.ne.0 .and. NSCAN.ne.1)  stop<a name='1729'></font>
<font color=#447700>! ajb note: Will need to increase memory for SAVWT if NSCAN=1:<a name='1730'></font>
  if(NSCAN.ne.0) then<a name='1731'>
    IF (iprt) then<a name='1732'>
        write(msg,*) 'SAVWT must be resized for NSCAN=1'<a name='1733'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_779">(msg)<a name='1734'>
    ENDIF<a name='1735'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_686"> ( 'wrf_fddaobs_in: in4dob' )<a name='1736'>
  endif<a name='1737'>
  IPLO=0  + NSCAN*4<a name='1738'>
  GFACTOR=1. +  NSCAN*(-1. + 0.33333) <a name='1739'>
  RFACTOR=1. +  NSCAN*(-1. + 3.0)<a name='1740'>
<font color=#447700>!yliu end<a name='1741'></font>
<font color=#447700>! jc<a name='1742'></font>
<a name='1743'>
<font color=#447700>! return if too close to j boundary<a name='1744'></font>
  if(inest.eq.1.and.ivar.lt.3.and.(j.le.2.or.j.ge.jde-1)) then<a name='1745'>
<font color=#447700>!       write(6,*) '1 RETURN: IVAR = ',ivar,' J = ',j,<a name='1746'></font>
<font color=#447700>!    $             ' too close to boundary.'<a name='1747'></font>
    return<a name='1748'>
  endif<a name='1749'>
  if(inest.eq.1.and.ivar.ge.3.and.(j.le.2.or.j.ge.jde-2)) then<a name='1750'>
<font color=#447700>!       write(6,*) '2 RETURN: IVAR = ',ivar,' J = ',j,<a name='1751'></font>
<font color=#447700>!    $             ' too close to boundary.'<a name='1752'></font>
    return<a name='1753'>
  endif<a name='1754'>
<a name='1755'>
<font color=#447700>! COMPUTE IPL WHICH REPRESENTS IVAR FOR EACH MESH IN SAVWT MODS<a name='1756'></font>
  ICUT=0<a name='1757'>
  IF(INEST.GT.1)ICUT=1<a name='1758'>
  i_s = max0(2+icut,its)<a name='1759'>
  i_e = min0(ide-1-icut,ite)<a name='1760'>
<a name='1761'>
  IPL=IVAR    + IPLO     <font color=#447700>!yliu +IPLO<a name='1762'></font>
<a name='1763'>
<font color=#447700>! DEFINE GRID-TYPE OFFSET FACTORS, IGRID AND GRID<a name='1764'></font>
<a name='1765'>
  INPF=(IRATIO**LEVIDN(INEST))*NPFI<a name='1766'>
  INFR=(IRATIO**LEVIDN(INEST))*IONF<a name='1767'>
<a name='1768'>
  GRIDX=0.0<a name='1769'>
  GRIDY=0.0<a name='1770'>
  IGRID=0<a name='1771'>
  IF(IVAR.GE.3)THEN<a name='1772'>
    GRIDX=0.5<a name='1773'>
    GRIDY=0.5<a name='1774'>
    IGRID=1<a name='1775'>
  ELSEIF(IVAR.eq.1) THEN<a name='1776'>
    GRIDY=0.5<a name='1777'>
    GRIDX=0.0<a name='1778'>
    IGRID=1<a name='1779'>
  ELSEIF(IVAR.eq.2) THEN<a name='1780'>
    GRIDX=0.5<a name='1781'>
    GRIDY=0.0<a name='1782'>
    IGRID=1<a name='1783'>
  ENDIF<a name='1784'>
<a name='1785'>
<font color=#447700>! TRANSFORM THE HORIZONTAL RADIUS OF INFLUENCE, RINXY, FROM<a name='1786'></font>
<font color=#447700>! KILOMETERS TO GRID LENGTHS, RINDX<a name='1787'></font>
<a name='1788'>
  RINDX=RINXY*1000./DX          * RFACTOR   <font color=#447700>!yliu *RFACTOR<a name='1789'></font>
  RIS=RINDX*RINDX<a name='1790'>
  IF(IFREST.AND.KTAU.EQ.KTAUR)GOTO 5<a name='1791'>
  IF(MOD(KTAU,INFR).NE.0)GOTO 126<a name='1792'>
5 CONTINUE<a name='1793'>
  IF (iprt) THEN<a name='1794'>
   IF(J.EQ.10) then<a name='1795'>
       write(msg,6) INEST,J,KTAU,XTIME,IVAR,IPL,rindx<a name='1796'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_780">(msg)<a name='1797'>
   ENDIF<a name='1798'>
  ENDIF<a name='1799'>
6 FORMAT(1X,'OBS NUDGING FOR IN,J,KTAU,XTIME,',                    &amp;<a name='1800'>
            'IVAR,IPL: ',I2,1X,I2,1X,I5,1X,F8.2,1X,I2,1X,I2,       &amp;<a name='1801'>
            ' rindx=',f4.1)<a name='1802'>
<a name='1803'>
<font color=#447700>!********************************************************************<a name='1804'></font>
<font color=#447700>!ajb_07012008  Setting ra and rb for the fine mesh her is now simple.<a name='1805'></font>
<font color=#447700>!              Values are no longer calculated here based on the<a name='1806'></font>
<font color=#447700>!              coarse mesh, since direct use of WRF map projections<a name='1807'></font>
<font color=#447700>!              on each nest was implemented in subroutine in4dob.<a name='1808'></font>
<font color=#447700>!********************************************************************<a name='1809'></font>
<font color=#447700>! SET RA AND RB<a name='1810'></font>
  DO N=1,NSTAT<a name='1811'>
    RA(N)=RIO(N)-GRIDX<a name='1812'>
    RB(N)=RJO(N)-GRIDY<a name='1813'>
  ENDDO<a name='1814'>
<a name='1815'>
<font color=#447700>! INITIALIZE WEIGHTING ARRAYS TO ZERO<a name='1816'></font>
  DO I=its,ite<a name='1817'>
    DO K=1,kte<a name='1818'>
      WT(I,K)=0.0<a name='1819'>
      WT2ERR(I,K)=0.0<a name='1820'>
    ENDDO<a name='1821'>
  ENDDO<a name='1822'>
<a name='1823'>
<font color=#447700>! DO P* COMPUTATIONS ON DOT POINTS FOR IVAR.LT.3 (U AND V)<a name='1824'></font>
<font color=#447700>! AND CROSS POINTS FOR IVAR.GE.3 (T,Q,P*).<a name='1825'></font>
<font color=#447700>!<a name='1826'></font>
<font color=#447700>! COMPUTE P* AT OBS LOCATION (RA,RB).  DO THIS AS SEPARATE VECTOR LOOP H<a name='1827'></font>
<font color=#447700>! SO IT IS ALREADY AVAILABLE IN NSTAT LOOP 120 BELOW<a name='1828'></font>
<a name='1829'>
<font color=#447700>! PSURF IS NOT AVAILABLE GLOBALLY, THEREFORE, THE BILINEAR INTERPOLATION<a name='1830'></font>
<font color=#447700>! AROUND THE OBS POINT IS DONE IN ERROB() AND STORED IN ERRF([678],N) FOR<a name='1831'></font>
<font color=#447700>! THE POINT (6=PRESS, 7=U-MOM, 8=V-MOM).<a name='1832'></font>
<font color=#447700>! ajb 05052009: psurf is actually pbase(k=1) interpolated to obs (i,j).<a name='1833'></font>
  DO N=1,NSTAT<a name='1834'>
    IF(IVAR.GE.3)THEN<a name='1835'>
      PSURF(N)=ERRF(6,N)<a name='1836'>
    ELSE<a name='1837'>
      IF(IVAR.EQ.1)THEN<a name='1838'>
        PSURF(N)=ERRF(7,N)        <font color=#447700>! U-points<a name='1839'></font>
      ELSE<a name='1840'>
        PSURF(N)=ERRF(8,N)        <font color=#447700>! V-points<a name='1841'></font>
      ENDIF<a name='1842'>
    ENDIF<a name='1843'>
  ENDDO<a name='1844'>
<a name='1845'>
<font color=#447700>! DETERMINE THE LIMITS OF THE SEARCH REGION FOR THE CURRENT<a name='1846'></font>
<font color=#447700>! J-STRIP<a name='1847'></font>
<a name='1848'>
  MAXJ=J+IFIX(RINDX*RINFMX+0.99)                                             <font color=#447700>!ajb<a name='1849'></font>
  MINJ=J-IFIX(RINDX*RINFMX+0.99)                                             <font color=#447700>!ajb<a name='1850'></font>
<a name='1851'>
<font color=#447700>! jc comment out this? want to use obs beyond the domain?<a name='1852'></font>
<font color=#447700>!      MAXJ=MIN0(JL-IGRID,MAXJ)           !yliu<a name='1853'></font>
<font color=#447700>!      MINJ=MAX0(1,MINJ)                  !yliu<a name='1854'></font>
<a name='1855'>
  n=1<a name='1856'>
<a name='1857'>
<font color=#447700>!***********************************************************************<a name='1858'></font>
  DO nnn=1,NSTAT   <font color=#447700>! BEGIN OUTER LOOP FOR THE NSTAT OBSERVATIONS<a name='1859'></font>
<font color=#447700>!***********************************************************************<a name='1860'></font>
<font color=#447700>! Soundings are consecutive obs, but they need to be treated as a single <a name='1861'></font>
<font color=#447700>! entity. Thus change the looping to nnn, with n defined separately.<a name='1862'></font>
<a name='1863'>
<a name='1864'>
<font color=#447700>!yliu <a name='1865'></font>
<font color=#447700>!  note for sfc data: nsndlev=1 and njcsnd=1<a name='1866'></font>
    nsndlev=int(nlevs_ob(n)-lev_in_ob(n))+1   <a name='1867'>
<a name='1868'>
<font color=#447700>! yliu start -- set together with the other parts<a name='1869'></font>
<font color=#447700>! test: do the sounding levels as individual obs<a name='1870'></font>
<font color=#447700>!   nsndlev=1<a name='1871'></font>
<font color=#447700>! yliu end<a name='1872'></font>
    njcsnd=nsndlev<a name='1873'>
<font color=#447700>! set pob here, to be used later<a name='1874'></font>
    pob=varobs(5,n)<a name='1875'>
<a name='1876'>
<font color=#447700>!     print *, "s-- n=,nsndlev",n,njcsnd,J, ipl<a name='1877'></font>
<font color=#447700>!     print *, "s--",ivar,(errf(ivar,i),i=n,n+njcsnd)<a name='1878'></font>
<font color=#447700>! CHECK TO SEE OF STATION N HAS DATA FOR VARIABLE IVAR<a name='1879'></font>
<font color=#447700>! AND IF IT IS SUFFICIENTLY CLOSE TO THE J STRIP.  THIS<a name='1880'></font>
<font color=#447700>! SHOULD ELIMINATE MOST STATIONS FROM FURTHER CONSIDER-<a name='1881'></font>
<font color=#447700>! ATION.<a name='1882'></font>
<a name='1883'>
<font color=#447700>!yliu: Skip bad obs if it is sfc or single level sounding.<a name='1884'></font>
<font color=#447700>!yliu: Before this (020918), a snd will be skipped if its first <a name='1885'></font>
<font color=#447700>!yliu        level has bad data- often true due to elevation<a name='1886'></font>
<a name='1887'>
    IF( ABS(ERRF(IVAR,N)).GT.9.E4 .and. njcsnd.eq.1 ) THEN<a name='1888'>
<font color=#447700>!     print *, " bad obs skipped"<a name='1889'></font>
<a name='1890'>
    ELSEIF( RB(N).LT.FLOAT(MINJ) .OR. RB(N).GT.FLOAT(MAXJ) ) THEN<a name='1891'>
<font color=#447700>!     print *, " skipped obs far away from this J-slice"<a name='1892'></font>
<a name='1893'>
<font color=#447700>!----------------------------------------------------------------------<a name='1894'></font>
    ELSE    <font color=#447700>! BEGIN SECTION FOR PROCESSING THE OBSERVATION<a name='1895'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1896'></font>
<a name='1897'>
<font color=#447700>! DETERMINE THE LIMITS OF APPLICATION OF THE OBS IN THE VERTICAL<a name='1898'></font>
<font color=#447700>! FOR THE VERTICAL WEIGHTING, WTSIG<a name='1899'></font>
<a name='1900'>
<font color=#447700>! ASSIMILATE OBSERVATIONS ON PRESSURE LEVELS, EXCEPT FOR SURFACE<a name='1901'></font>
<font color=#447700>!ajb 20021210: (Bugfix) RKO is not available globally. It is computed in<a name='1902'></font>
<font color=#447700>!ajb ERROB() by the processor handling the obs point, and stored in ERRF(9,N).<a name='1903'></font>
<a name='1904'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1905'></font>
      rko(n) = errf(9,n)        <font color=#447700>!ajb 20021210<a name='1906'></font>
      kpbl_obs(n) = errf(5,n)   <font color=#447700>!ajb 20090519<a name='1907'></font>
#endif<a name='1908'>
<font color=#447700>!ajb 20090427 added .45 to rko so KOB is equal to 1 only if RKO &gt; 1.05<a name='1909'></font>
      KOB=nint(RKO(N)+0.45)<a name='1910'>
      KOB=MIN0(kte,KOB)<a name='1911'>
      KOB=MAX0(1,KOB)<a name='1912'>
<a name='1913'>
<font color=#447700>! ASSIMILATE SURFACE LAYER DATA ON SIGMA<a name='1914'></font>
      IF(KOB.EQ.1.AND.IVAR.LE.4.and.nlevs_ob(n).lt.1.5) THEN<a name='1915'>
<a name='1916'>
<font color=#447700>! Compute temporal weight<a name='1917'></font>
        timewt = <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#GET_TIMEWT'>get_timewt</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_TIMEWT_1">(xtime,dtmin,twindo,sfcfact,timeob(n))<a name='1918'>
<a name='1919'>
        DO K=1,kte<a name='1920'>
          WTSIG(K)=0.0<a name='1921'>
        ENDDO<a name='1922'>
<font color=#447700>! DEFINE WTSIG: (FOR SRP: SPREAD SURFACE DATA THROUGH LOWEST 200 M)<a name='1923'></font>
<font color=#447700>!       WTSIG(1)=1.0<a name='1924'></font>
<font color=#447700>!       WTSIG(2)=0.67<a name='1925'></font>
<font color=#447700>!       WTSIG(3)=0.33<a name='1926'></font>
<font color=#447700>!       KOMIN=3<a name='1927'></font>
<font color=#447700>!       KOMAX=1<a name='1928'></font>
<font color=#447700>! DEFINE THE MAX AND MIN I VALUES FOR POSSIBLE NONZERO<a name='1929'></font>
<font color=#447700>! WEIGHTS, BASED ON THE RADIUS OF INFLUENCE, RINDX (IN GRID LENGTHS).<a name='1930'></font>
<font color=#447700>! fix this because kpblt at 1 and il is 0<a name='1931'></font>
        MAXI=IFIX(RA(N)+0.99+RINDX*sfcfacr)<a name='1932'>
        MAXI=MIN0(ide-1,MAXI)<a name='1933'>
        MINI=IFIX(RA(N)-RINDX*sfcfacr-0.99)<a name='1934'>
        MINI=MAX0(2,MINI)<a name='1935'>
<font color=#447700>!yliu start<a name='1936'></font>
<font color=#447700>! use also obs outside of this domain  -- surface obs<a name='1937'></font>
<font color=#447700>!     if(RA(N).LT.0.-RINDX .or. RA(N).GT.float(IL+RINDX) .or.<a name='1938'></font>
<font color=#447700>!    &amp;   RB(N).LT.0.-RINDX .or. RB(N).GT.float(JL+RINDX)) then<a name='1939'></font>
<font color=#447700>!        print *, " skipped obs far away from this domain"<a name='1940'></font>
<font color=#447700>! currently can use obs within this domain or ones very close to (1/3<a name='1941'></font>
<font color=#447700>!   influence of radius in the coarse domain) this<a name='1942'></font>
<font color=#447700>!   domain. In later case, use BC column value to approximate the model value<a name='1943'></font>
<font color=#447700>!   at obs point -- ERRF need model field in errob.F !!<a name='1944'></font>
        if (  RA(N).GE.(0.-RINDX*sfcfacr/3)                        &amp;<a name='1945'>
        .and. RA(N).LE.float(ide)+RINDX*sfcfacr/3                  &amp;<a name='1946'>
        .and. RB(N).GE.(0.-RINDX*sfcfacr/3)                        &amp;<a name='1947'>
        .and. RB(N).LE.float(jde)+RINDX*sfcfacr/3) then<a name='1948'>
<a name='1949'>
<font color=#447700>! or use obs within this domain only<a name='1950'></font>
<font color=#447700>!     if(RA(N).LT.1 .or. RA(N).GT.float(IL) .or.<a name='1951'></font>
<font color=#447700>!    &amp;   RB(N).LT.1 .or. RB(N).GT.float(JL)) then<a name='1952'></font>
<font color=#447700>!        print *, " skipped obs far outside of this domain"<a name='1953'></font>
<font color=#447700>!        if(j.eq.3 .and. ivar.eq.3) then<a name='1954'></font>
<font color=#447700>!           write(6,*) 'N = ',n,' exit 120 3'<a name='1955'></font>
<font color=#447700>!        endif<a name='1956'></font>
<font color=#447700>!yliu end<a name='1957'></font>
<font color=#447700>!<a name='1958'></font>
<font color=#447700>! LOOP THROUGH THE NECESSARY GRID POINTS SURROUNDING<a name='1959'></font>
<font color=#447700>! OBSERVATION N.  COMPUTE THE HORIZONTAL DISTANCE TO<a name='1960'></font>
<font color=#447700>! THE OBS AND FIND THE WEIGHTING SUM OVER ALL OBS<a name='1961'></font>
          RJ=FLOAT(J)<a name='1962'>
          RX=RJ-RB(N)<a name='1963'>
<font color=#447700>! WEIGHTS FOR THE 3-D VARIABLES<a name='1964'></font>
          ERFIVR=ERRF(IVAR,N)<a name='1965'>
          QVB_AT_OB_LOC=ERRF(10,N)<a name='1966'>
 <a name='1967'>
<font color=#447700>!ajb Compute and add weights to sum only if nudge_pbl switch is on.<a name='1968'></font>
          if(nudge_pbl) then<a name='1969'>
<a name='1970'>
<font color=#447700>! Apply selected horizontal spreading scheme.<a name='1971'></font>
            if(SFC_SCHEME_HORIZ.eq.1) then        <font color=#447700>! original mm5 scheme <a name='1972'></font>
              DO I=max0(its,MINI),min0(ite,MAXI)<a name='1973'>
                RI=FLOAT(I)<a name='1974'>
                RY=RI-RA(N)<a name='1975'>
                RIS=RINDX*RINDX*sfcfacr*sfcfacr<a name='1976'>
                RSQ=RX*RX+RY*RY<a name='1977'>
<font color=#447700>! THIS FUNCTION DECREASES WTIJ AS PSFC CHANGES WITHIN SEARCH RADIUS<a name='1978'></font>
                DPRIM=SQRT(RSQ)<a name='1979'>
                D=DPRIM+RINDX*DCON*ABS(psurf(n)-.001*pbase(i,1))<a name='1980'>
                DSQ=D*D<a name='1981'>
                WTIJ(i)=(RIS-DSQ)/(RIS+DSQ)<a name='1982'>
                WTIJ(i)=AMAX1(0.0,WTIJ(i))<a name='1983'>
              ENDDO<a name='1984'>
            else                                 <font color=#447700>! wrf scheme <a name='1985'></font>
              DO I=max0(its,MINI),min0(ite,MAXI)<a name='1986'>
                RI=FLOAT(I)<a name='1987'>
                RY=RI-RA(N)<a name='1988'>
                RIS=RINDX*RINDX*sfcfacr*sfcfacr<a name='1989'>
                RSQ=RX*RX+RY*RY<a name='1990'>
<font color=#447700>! THIS FUNCTION DECREASES WTIJ AS PSFC CHANGES WITHIN SEARCH RADIUS<a name='1991'></font>
                wtij(i)=(ris-rsq)/(ris+rsq)<a name='1992'>
                scratch = (abs (psurf(n)-.001*pbase(i,1))*DCON)<a name='1993'>
                pdfac=1.-AMIN1(1.0,scratch)<a name='1994'>
                wtij(i)=wtij(i)*pdfac<a name='1995'>
                WTIJ(i)=AMAX1(0.0,WTIJ(i))<a name='1996'>
              ENDDO<a name='1997'>
            endif<a name='1998'>
<a name='1999'>
<font color=#447700>! Apply selected vertical spreading scheme.<a name='2000'></font>
            if(SFC_SCHEME_VERT.eq.1) then         <font color=#447700>! original simple scheme <a name='2001'></font>
<a name='2002'>
              DO I=max0(its,MINI),min0(ite,MAXI)<a name='2003'>
<a name='2004'>
<font color=#447700>! try making sfc obs weighting go thru pbl<a name='2005'></font>
                komax=max0(3,kpblt(i))<a name='2006'>
                IF (iprt) THEN<a name='2007'>
                  if (kpblt(i).gt.25 .and. ktau.ne.0)                         &amp;<a name='2008'>
                                     write(6,552)inest,i,j,kpblt(i)<a name='2009'>
552               FORMAT('kpblt is gt 25, inest,i,j,kpblt=',4i4)<a name='2010'>
                ENDIF<a name='2011'>
<a name='2012'>
                if(kpblt(i).gt.25) komax=3<a name='2013'>
                komin=1<a name='2014'>
                dk=float(komax)<a name='2015'>
<a name='2016'>
                do k=komin,komax<a name='2017'>
<a name='2018'>
                  wtsig(k)=float(komax-k+1)/dk<a name='2019'>
                  WT(I,K)=WT(I,K)+TIMEWT*WTSIG(K)*WTIJ(i)<a name='2020'>
<a name='2021'>
                  <font color=#447700>!See Reen et al. poster/extended abstract (P13) from 2013 WRF<a name='2022'></font>
                  <font color=#447700>!User's Workshop regarding the following moisture innovation <a name='2023'></font>
                  <font color=#447700>!scaling code.<a name='2024'></font>
                  <font color=#447700>!If dealing with moisture and user chose to scale certain<a name='2025'></font>
                  <font color=#447700>!negative QV innovations<a name='2026'></font>
                  IF((IVAR.EQ.4).AND.(obs_scl_neg_qv_innov.gt.0)) THEN<a name='2027'>
                   QVB_AT_CUR_LOC = MAX(QVB(I,K,J),0.0)<a name='2028'>
                   <font color=#447700>!If the moisture innovation is negative and the model moisture<a name='2029'></font>
                   <font color=#447700>! is less at the current location where we are about to apply <a name='2030'></font>
                   <font color=#447700>! the innovation than at the location where the ob was taken<a name='2031'></font>
                   IF((ERFIVR.LT.0).AND.(QVB_AT_CUR_LOC.LT.QVB_AT_OB_LOC)) THEN<a name='2032'>
                    <font color=#447700>!The ratio of the model moisture at the current location <a name='2033'></font>
                    <font color=#447700>! compared to the ob location will be used to scale the<a name='2034'></font>
                    <font color=#447700>!  innovation.<a name='2035'></font>
                    QVB_CUR_LOC_OVER_OB_LOC = QVB_AT_CUR_LOC/QVB_AT_OB_LOC<a name='2036'>
                    IF(obs_scl_neg_qv_innov.eq.1) THEN<a name='2037'>
                     <font color=#447700>!Limit the innovation such that it cannot nudge towards a<a name='2038'></font>
                     <font color=#447700>!negative value<a name='2039'></font>
                     SCALE_FACTOR_NEG_QV_INNOV = MIN(1.0,ABS(QVB_AT_CUR_LOC/ERFIVR))<a name='2040'>
                    ELSE<a name='2041'>
                     <font color=#447700>!If the user chose a value for obs_scl_neg_qv_innov that<a name='2042'></font>
                     <font color=#447700>!this code is unaware of, stop WRF<a name='2043'></font>
                     IF (iprt) then<a name='2044'>
                      write(msg,*) 'Unknown value of obs_scl_neg_qv_innov = ',obs_scl_neg_qv_innov<a name='2045'>
                      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_781">(msg)<a name='2046'>
                     ENDIF<a name='2047'>
                     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_687"> ( 'module_fddaobs_rtfdda: nudob: Unknown value of obs_scl_neg_qv_innov' )<a name='2048'>
                    ENDIF<a name='2049'>
                    <font color=#447700>!Scale the innovation<a name='2050'></font>
                    ERFIVR = ERFIVR*SCALE_FACTOR_NEG_QV_INNOV<a name='2051'>
                   ENDIF<a name='2052'>
<a name='2053'>
                  ENDIF<a name='2054'>
                  WT2ERR(I,K)=WT2ERR(I,K)+TIMEWT*TIMEWT*WTIJ(i)*WTIJ(i)*WTSIG(K)    &amp;<a name='2055'>
                              *WTSIG(K)*ERFIVR<a name='2056'>
<a name='2057'>
                enddo<a name='2058'>
              ENDDO<a name='2059'>
<a name='2060'>
            else                                <font color=#447700>! regime-based vif scheme<a name='2061'></font>
<a name='2062'>
<font color=#447700>! Here we calculate weights in the vertical coordinate, based on vih1 and vih2.<a name='2063'></font>
<font color=#447700>! In the equation for wtsig(k), Z=zslab(i,k)-terrh(i) contains the model Z-values<a name='2064'></font>
<font color=#447700>! (height above ground in meters) on a J-slab. The equation produces wtsig = 1.0 at<a name='2065'></font>
<font color=#447700>! levels 1 to K, where z(K) &lt; vih1 &lt; z(K+1). For the example below, in the equation<a name='2066'></font>
<font color=#447700>! for wtsig(k), the expression vih1(i)-Z(i,k) is strictly positive for k=1,2,3 since<a name='2067'></font>
<font color=#447700>! levels 1, 2, and 3 are below vih1. So xtsig(k)=min(1.0, 1.0-x) where x &gt; 0 ==&gt;<a name='2068'></font>
<font color=#447700>! wtsig(k)=1 for k=1,2,3.<a name='2069'></font>
<font color=#447700>!<a name='2070'></font>
<font color=#447700>!    For levels K+1 and up, wtsig will decrease linearly with height, with values<a name='2071'></font>
<font color=#447700>! along the ramp that has value 1.0 at vih1 and 0.0 at vih2. In the example:<a name='2072'></font>
<font color=#447700>!<a name='2073'></font>
<font color=#447700>!   dz_ramp  = 1/(200-150) = 1/50<a name='2074'></font>
<font color=#447700>!   xtsig(4) = 1 + (150-175)/50 = 1 - 1/2 = 1/2<a name='2075'></font>
<font color=#447700>!<a name='2076'></font>
<font color=#447700>!       WTSIG<a name='2077'></font>
<font color=#447700>!         1 -|*    *     *     *     *     *<a name='2078'></font>
<font color=#447700>!            |<a name='2079'></font>
<font color=#447700>!            |                                *<a name='2080'></font>
<font color=#447700>!            |<a name='2081'></font>
<font color=#447700>!            |                                   *<a name='2082'></font>
<font color=#447700>!            |<a name='2083'></font>
<font color=#447700>!            |                                      *<a name='2084'></font>
<font color=#447700>!         0 -|--|-------|-----------|------|----|----|---------|----&gt;  Z = HT ABOVE<a name='2085'></font>
<font color=#447700>!              15      55          115    150  175  200       250          GROUND<a name='2086'></font>
<font color=#447700>!              k=1     k=2         k=3    vih1 k=4  vih2      k=5<a name='2087'></font>
 <a name='2088'>
              DO I=max0(its,MINI),min0(ite,MAXI)<a name='2089'>
<a name='2090'>
                dz_ramp = 1.0 / max( 1.0, vih2(i)-vih1(i) )   <font color=#447700>! vih2 &gt;= vih1 by construct<a name='2091'></font>
<a name='2092'>
           LML: do k = kts, kte <a name='2093'>
                  wtsig(k) = min( 1.0, 1.0 + ( vih1(i)-zslab(i,k)+terrh(i) ) * dz_ramp )<a name='2094'>
                  wtsig(k) = max( 0.0, wtsig(k))<a name='2095'>
<a name='2096'>
                  if(wtsig(k).le.0.0) EXIT LML<a name='2097'>
                    WT(I,K)=WT(I,K)+TIMEWT*WTSIG(K)*WTIJ(i)<a name='2098'>
<a name='2099'>
                   <font color=#447700>!See Reen et al. poster/extended abstract (P13) from 2013 WRF<a name='2100'></font>
                   <font color=#447700>!User's Workshop regarding the following moisture innovation<a name='2101'></font>
                   <font color=#447700>!If dealing with moisture and user chose to scale certain<a name='2102'></font>
                   <font color=#447700>!negative QV innovations<a name='2103'></font>
                   IF((IVAR.EQ.4).AND.(obs_scl_neg_qv_innov.gt.0)) THEN<a name='2104'>
                    QVB_AT_CUR_LOC = MAX(QVB(I,K,J),0.0)<a name='2105'>
                    <font color=#447700>!If the moisture innovation is negative and the model<a name='2106'></font>
                    <font color=#447700>!moisture<a name='2107'></font>
                    <font color=#447700>! is less at the current location where we are about to apply<a name='2108'></font>
                    <font color=#447700>! the innovation than at the location where the ob was taken<a name='2109'></font>
                    IF((ERFIVR.LT.0).AND.(QVB_AT_CUR_LOC.LT.QVB_AT_OB_LOC)) THEN<a name='2110'>
                     <font color=#447700>!The ratio of the model moisture at the current location<a name='2111'></font>
                     <font color=#447700>! compared to the ob location will be used to scale the<a name='2112'></font>
                     <font color=#447700>!  innovation.<a name='2113'></font>
                     QVB_CUR_LOC_OVER_OB_LOC = QVB_AT_CUR_LOC/QVB_AT_OB_LOC<a name='2114'>
                     IF(obs_scl_neg_qv_innov.eq.1) THEN<a name='2115'>
                      <font color=#447700>!Limit the innovation such that it cannot nudge towards a<a name='2116'></font>
                      <font color=#447700>!negative value<a name='2117'></font>
                      SCALE_FACTOR_NEG_QV_INNOV = MIN(1.0,ABS(QVB_AT_CUR_LOC/ERFIVR))<a name='2118'>
                     ELSE<a name='2119'>
                      <font color=#447700>!If the user chose a value for obs_scl_neg_qv_innov that<a name='2120'></font>
                      <font color=#447700>!this code is unaware of, stop WRF<a name='2121'></font>
                      IF (iprt) then<a name='2122'>
                       write(msg,*) 'Unknown value of obs_scl_neg_qv_innov = ',obs_scl_neg_qv_innov<a name='2123'>
                       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_782">(msg)<a name='2124'>
                      ENDIF<a name='2125'>
                      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_688"> ( 'module_fddaobs_rtfdda: nudob: Unknown value of obs_scl_neg_qv_innov' )<a name='2126'>
                     ENDIF<a name='2127'>
                     <font color=#447700>!Scale the innovation<a name='2128'></font>
                     ERFIVR = ERFIVR*SCALE_FACTOR_NEG_QV_INNOV<a name='2129'>
<a name='2130'>
                    ENDIF<a name='2131'>
                   ENDIF<a name='2132'>
<a name='2133'>
<a name='2134'>
                   WT2ERR(I,K)=WT2ERR(I,K)+TIMEWT*TIMEWT*WTIJ(i)*WTIJ(i)*WTSIG(K)    &amp;<a name='2135'>
                                *WTSIG(K)*ERFIVR<a name='2136'>
                  enddo LML<a name='2137'>
              ENDDO<a name='2138'>
            endif<a name='2139'>
<a name='2140'>
          endif <font color=#447700>! end if nudge-pbl switch is on<a name='2141'></font>
<a name='2142'>
        endif   <font color=#447700>! end check for obs in domain<a name='2143'></font>
<font color=#447700>! END SURFACE-LAYER OBS NUDGING<a name='2144'></font>
<a name='2145'>
      ELSE    <a name='2146'>
<a name='2147'>
<font color=#447700>! Compute temporal weight<a name='2148'></font>
        timewt = <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#GET_TIMEWT'>get_timewt</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_TIMEWT_2">(xtime,dtmin,twindo,1.,timeob(n))<a name='2149'>
<a name='2150'>
<a name='2151'>
<font color=#447700>! BEGIN CALCULATIONS TO SPREAD OBS INFLUENCE ALONG PRESSURE LEVELS<a name='2152'></font>
<font color=#447700>!<a name='2153'></font>
<font color=#447700>!       print *,'in upper air section'<a name='2154'></font>
<font color=#447700>! DEFINE THE MAX AND MIN I VALUES FOR POSSIBLE NONZERO<a name='2155'></font>
<font color=#447700>! WEIGHTS, BASED ON THE RADIUS OF INFLUENCE, RINDX, AND RINFAC.<a name='2156'></font>
<font color=#447700>! RINFAC VARIES AS A LINEAR FUNCTION FROM FROM RINFMN AT P*+PTOP<a name='2157'></font>
<font color=#447700>! TO RINFMX AT PFREE AND "ABOVE" (LOWER PRESSURE).<a name='2158'></font>
<font color=#447700>!ajb          SLOPE=(RINFMN-RINFMX)/(PSBO(N)+PTOP-PFREE)<a name='2159'></font>
<a name='2160'>
        slope = (RINFMN-RINFMX)/(psurf(n)-PFREE)<a name='2161'>
<a name='2162'>
        RINFAC=SLOPE*POB+RINFMX-SLOPE*pfree<a name='2163'>
        RINFAC=AMAX1(RINFAC,RINFMN)<a name='2164'>
        RINFAC=AMIN1(RINFAC,RINFMX)<a name='2165'>
<font color=#447700>!yliu: for multilevel upper-air data, take the maximum<a name='2166'></font>
<font color=#447700>!      for the I loop.<a name='2167'></font>
        if(nsndlev.gt.1) RINFAC = RINFMX <a name='2168'>
<font color=#447700>!yliu end<a name='2169'></font>
<a name='2170'>
        MAXI=IFIX(RA(N)+0.99+RINDX*RINFAC)<a name='2171'>
        MAXI=MIN0(ide-IGRID,MAXI)<a name='2172'>
        MINI=IFIX(RA(N)-RINDX*RINFAC-0.99)<a name='2173'>
        MINI=MAX0(1,MINI)<a name='2174'>
<a name='2175'>
<font color=#447700>! yliu start<a name='2176'></font>
<font color=#447700>! use also obs outside of but close to this domain  -- upr data   <a name='2177'></font>
<font color=#447700>!     if(   RA(N).LT.(0.-RINFAC*RINDX)<a name='2178'></font>
<font color=#447700>!    &amp; .or. RA(N).GT.float(IL)+RINFAC*RINDX<a name='2179'></font>
<font color=#447700>!    &amp; .or. RB(N).LT.(0.-RINFAC*RINDX)<a name='2180'></font>
<font color=#447700>!    &amp; .or. RB(N).GT.float(JL)+RINFAC*RINDX)then          <a name='2181'></font>
<font color=#447700>!        print *, " skipped obs far away from this I-range"<a name='2182'></font>
<font color=#447700>! currently can use obs within this domain or ones very close to (1/3<a name='2183'></font>
<font color=#447700>!   influence of radius in the coarse domain) this <a name='2184'></font>
<font color=#447700>!   domain. In later case, use BC column value to approximate the model value <a name='2185'></font>
<font color=#447700>!   at obs point -- ERRF need model field in errob.F !!<a name='2186'></font>
<a name='2187'>
<font color=#447700>!cc         if (i.eq.39 .and. j.eq.34) then<a name='2188'></font>
<font color=#447700>!cc            write(6,*) 'RA(N) = ',ra(n) <a name='2189'></font>
<font color=#447700>!cc            write(6,*) 'rinfac = ',rinfac,' rindx = ',rindx<a name='2190'></font>
<font color=#447700>!cc         endif<a name='2191'></font>
        if(   RA(N).GE.(0.-RINFAC*RINDX/3)                      &amp;<a name='2192'>
        .and. RA(N).LE.float(ide)+RINFAC*RINDX/3                &amp;<a name='2193'>
        .and. RB(N).GE.(0.-RINFAC*RINDX/3)                      &amp;<a name='2194'>
        .and. RB(N).LE.float(jde)+RINFAC*RINDX/3) then<a name='2195'>
<font color=#447700>! or use obs within this domain only<a name='2196'></font>
<font color=#447700>!     if(RA(N).LT.1 .or. RA(N).GT.float(IL) .or.<a name='2197'></font>
<font color=#447700>!    &amp;   RB(N).LT.1 .or. RB(N).GT.float(JL)) then<a name='2198'></font>
<font color=#447700>!        print *, " skipped obs far outside of this domain"<a name='2199'></font>
<a name='2200'>
<font color=#447700>! yliu end<a name='2201'></font>
<font color=#447700>! is this 2 needed here - kpbl not used?<a name='2202'></font>
<font color=#447700>!          MINI=MAX0(2,MINI)<a name='2203'></font>
<a name='2204'>
<font color=#447700>! LOOP THROUGH THE NECESSARY GRID POINTS SURROUNDING<a name='2205'></font>
<font color=#447700>! OBSERVATION N.  COMPUTE THE HORIZONTAL DISTANCE TO<a name='2206'></font>
<font color=#447700>! THE OBS AND FIND THE WEIGHTING SUM OVER ALL OBS<a name='2207'></font>
          RJ=FLOAT(J)<a name='2208'>
          RX=RJ-RB(N)<a name='2209'>
<font color=#447700>! WEIGHTS FOR THE 3-D VARIABLES<a name='2210'></font>
<font color=#447700>!<a name='2211'></font>
          ERFIVR=ERRF(IVAR,N)<a name='2212'>
<font color=#447700>! Model QV at the observation location<a name='2213'></font>
          QVB_AT_OB_LOC=ERRF(10,N)<a name='2214'>
<font color=#447700>! jc<a name='2215'></font>
          nsndlev=int(nlevs_ob(n)-lev_in_ob(n))+1<a name='2216'>
<font color=#447700>! yliu start<a name='2217'></font>
<font color=#447700>! test: do the sounding levels as individual obs<a name='2218'></font>
<font color=#447700>!        nsndlev=1<a name='2219'></font>
<font color=#447700>! yliu end<a name='2220'></font>
          njcsnd=nsndlev<a name='2221'>
<font color=#447700>!<a name='2222'></font>
          DO I=max0(its,MINI),min0(ite,MAXI)<a name='2223'>
<font color=#447700>! jc<a name='2224'></font>
            RI=FLOAT(I)<a name='2225'>
            RY=RI-RA(N)<a name='2226'>
            RIS=RINDX*RINFAC*RINDX*RINFAC<a name='2227'>
            RSQ=RX*RX+RY*RY<a name='2228'>
<font color=#447700>! yliu test: for upper-air data, keep D1 influence radii<a name='2229'></font>
            WTIJ(i)=(RIS-RSQ)/(RIS+RSQ)<a name='2230'>
<a name='2231'>
            WTIJ=AMAX1(0.0,WTIJ(i))<a name='2232'>
<font color=#447700>! weight ob in vertical with +- 50 mb<a name='2233'></font>
<font color=#447700>! yliu: 75 hba for single upper-air, 30hba for multi-level soundings<a name='2234'></font>
            if(nsndlev.eq.1) then<a name='2235'>
              rinprs=7.5<a name='2236'>
<font color=#447700>! <a name='2237'></font>
            else<a name='2238'>
             rinprs=3.0<a name='2239'>
            endif<a name='2240'>
<font color=#447700>! yliu end<a name='2241'></font>
<a name='2242'>
<font color=#447700>!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$<a name='2243'></font>
<font color=#447700>!   ---  HANDLE 1-LEVEL and MULTI-LEVEL OBSERVATIONS SEPARATELY  ---<a name='2244'></font>
<font color=#447700>!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$<a name='2245'></font>
<a name='2246'>
            if(nsndlev.eq.1)then <a name='2247'>
<font color=#447700>!----------------------------------------------------------------------<a name='2248'></font>
<font color=#447700>!         ---   HANDLE 1-LEVEL OBSERVATIONS  ---<a name='2249'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2250'></font>
<a name='2251'>
<font color=#447700>!         if(I.eq.MINI) print *, "  Single snd "<a name='2252'></font>
<font color=#447700>! ERFIVR is the residual (difference) between the ob and the model<a name='2253'></font>
<font color=#447700>! at that point. We can analyze that residual up and down.<a name='2254'></font>
<font color=#447700>! First find komin for ob.<a name='2255'></font>
<font color=#447700>!yliu start -- in the old code, komax and komin were reversed!<a name='2256'></font>
              do k=kte,1,-1<a name='2257'>
                pijk = .001*(pbase(i,k)+pp(i,k))<a name='2258'>
<font color=#447700>!               print *,'k,pijk,pob,rinprs=',k,pijk,pob,rinprs<a name='2259'></font>
                if(pijk.ge.(pob+rinprs)) then<a name='2260'>
                  komin=k<a name='2261'>
                  go to 325<a name='2262'>
                endif<a name='2263'>
              enddo<a name='2264'>
              komin=1<a name='2265'>
 325          continue<a name='2266'>
<font color=#447700>! now find komax for ob<a name='2267'></font>
              do k=3,kte<a name='2268'>
                pijk = .001*(pbase(i,k)+pp(i,k))<a name='2269'>
                if(pijk.le.(pob-rinprs)) then<a name='2270'>
                  komax=k<a name='2271'>
                  go to 326<a name='2272'>
                endif<a name='2273'>
              enddo<a name='2274'>
              komax=kte   <font color=#447700>! yliu 20050706<a name='2275'></font>
 326          continue<a name='2276'>
<a name='2277'>
<font color=#447700>! yliu: single-level upper-air data will act either above or below the PBL top<a name='2278'></font>
<font color=#447700>! ajb: Reset komin or komax. if kobs&gt;kpbl_obs, komin=kpbl_obs+1, else komax=kpbl_obs  <a name='2279'></font>
<a name='2280'>
              if( (kpblt(i).le.komax) .and. (kpblt(i).ge.komin) ) then<a name='2281'>
                 kobs = 1<a name='2282'>
                 OBS_K: do k = komin, komax<a name='2283'>
                     if( pob .gt. .001*(pbase(i,k)+pp(i,k)) ) then<a name='2284'>
                        kobs = k<a name='2285'>
                        EXIT OBS_K<a name='2286'>
                     endif<a name='2287'>
                 enddo OBS_K<a name='2288'>
<a name='2289'>
                 if(kobs.gt.kpbl_obs(n)) then<a name='2290'>
<font color=#447700>! Obs will act only above the PBL top<a name='2291'></font>
                     komin=max0(kobs, komin)   <font color=#447700>! kobs here is kpblt(i)+1<a name='2292'></font>
                 else                          <font color=#447700>! Obs acts below PBL top<a name='2293'></font>
<font color=#447700>! Obs will act only below the PBL top<a name='2294'></font>
                     komax=min0(kpblt(i), komax)<a name='2295'>
                 endif<a name='2296'>
              endif<a name='2297'>
<font color=#447700>! yliu end<a name='2298'></font>
<font color=#447700>!<a name='2299'></font>
<font color=#447700>!           print *,'1 level, komin,komax=',komin,komax<a name='2300'></font>
<font color=#447700>!           if(i.eq.MINI) then<a name='2301'></font>
<font color=#447700>!             print *, "yyyyyyyyyyS IPL erfivr=", IPL, ERFIVR,J,pob<a name='2302'></font>
<font color=#447700>!             ERFIVR=0<a name='2303'></font>
<font color=#447700>!           endif<a name='2304'></font>
              do k=1,kte<a name='2305'>
                reserf(k)=0.0<a name='2306'>
                wtsig(k)=0.0<a name='2307'>
              enddo<a name='2308'>
<font color=#447700>!yliu end<a name='2309'></font>
<a name='2310'>
<font color=#447700>!ajb Add weights to sum only if nudge_pbl switch is on OR obs is above pbl top.<a name='2311'></font>
              if(nudge_pbl .or. komin.ge.kpblt(i)) then<a name='2312'>
                do k=komin,komax<a name='2313'>
                  pijk = .001*(pbase(i,k)+pp(i,k))<a name='2314'>
                  reserf(k)=erfivr<a name='2315'>
                  wtsig(k)=1.-abs(pijk-pob)/rinprs<a name='2316'>
                  wtsig(k)=amax1(wtsig(k),0.0)<a name='2317'>
<font color=#447700>!             print *,'k,pijk,pob,rinprs,wtsig=',k,pijk,pob,rinprs,wtsig(k)<a name='2318'></font>
<font color=#447700>! Now calculate WT and WT2ERR for each i,j,k point                      cajb<a name='2319'></font>
                  WT(I,K)=WT(I,K)+TIMEWT*WTIJ(i)*wtsig(k)<a name='2320'>
<a name='2321'>
<a name='2322'>
                  <font color=#447700>!See Reen et al. poster/extended abstract (P13) from 2013 WRF<a name='2323'></font>
                  <font color=#447700>!User's Workshop regarding the following moisture innovation<a name='2324'></font>
                  <font color=#447700>!scaling code.<a name='2325'></font>
                  <font color=#447700>!If dealing with moisture and user chose to scale certain<a name='2326'></font>
                  <font color=#447700>!negative QV innovations<a name='2327'></font>
                  IF((IVAR.EQ.4).AND.(obs_scl_neg_qv_innov.GT.0)) THEN<a name='2328'>
                   QVB_AT_CUR_LOC = MAX(QVB(I,K,J),0.0)<a name='2329'>
                   <font color=#447700>!If the moisture innovation is negative and the model moisture<a name='2330'></font>
                   <font color=#447700>! is less at the current location where we are about to apply<a name='2331'></font>
                   <font color=#447700>! the innovation than at the location where the ob was taken<a name='2332'></font>
                   IF((ERFIVR.LT.0).AND.(QVB_AT_CUR_LOC.LT.QVB_AT_OB_LOC)) THEN<a name='2333'>
                    <font color=#447700>!The ratio of the model moisture at the current location<a name='2334'></font>
                    <font color=#447700>! compared to the ob location will be used to scale the<a name='2335'></font>
                    <font color=#447700>!  innovation.<a name='2336'></font>
                    QVB_CUR_LOC_OVER_OB_LOC = QVB_AT_CUR_LOC/QVB_AT_OB_LOC<a name='2337'>
                    IF(obs_scl_neg_qv_innov.eq.1) THEN<a name='2338'>
                     <font color=#447700>!Limit the innovation such that it cannot nudge towards a<a name='2339'></font>
                     <font color=#447700>!negative value<a name='2340'></font>
                     SCALE_FACTOR_NEG_QV_INNOV = MIN(1.0,ABS(QVB_AT_CUR_LOC/ERFIVR))<a name='2341'>
                    ELSE<a name='2342'>
                     <font color=#447700>!If the user chose an value for obs_scl_neg_qv_innov that<a name='2343'></font>
                     <font color=#447700>!this code is unaware of, stop WRF<a name='2344'></font>
                     IF (iprt) then<a name='2345'>
                      write(msg,*) 'Unknown value of obs_scl_neg_qv_innov = ',obs_scl_neg_qv_innov<a name='2346'>
                      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_783">(msg)<a name='2347'>
                     ENDIF<a name='2348'>
                     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_689"> ( 'module_fddaobs_rtfdda: nudob: Unknown value of obs_scl_neg_qv_innov' )<a name='2349'>
                    ENDIF<a name='2350'>
                    reserf(k) = reserf(k)*SCALE_FACTOR_NEG_QV_INNOV<a name='2351'>
                   ENDIF<a name='2352'>
                  ENDIF<a name='2353'>
<a name='2354'>
                  WT2ERR(I,K)=WT2ERR(I,K)+TIMEWT*TIMEWT*WTIJ(i)*WTIJ(i)*        &amp;<a name='2355'>
                              reserf(k)*wtsig(k)*wtsig(k)<a name='2356'>
                enddo<a name='2357'>
              endif<a name='2358'>
<a name='2359'>
            else<a name='2360'>
<a name='2361'>
<font color=#447700>!----------------------------------------------------------------------<a name='2362'></font>
<font color=#447700>!         ---   HANDLE MULTI-LEVEL OBSERVATIONS  ---<a name='2363'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2364'></font>
<font color=#447700>!yliu start <a name='2365'></font>
<font color=#447700>!           if(I.eq.MINI) print *, "  Multi-level  snd "<a name='2366'></font>
<font color=#447700>!             print *, "   n=,nsndlev",n,nsndlev,nlevs_ob(n),lev_in_ob(n)  &amp;<a name='2367'></font>
<font color=#447700>!                  ,nlevs_ob(n+nsndlev-1),lev_in_ob(n+nsndlev-1) <a name='2368'></font>
              if(nlevs_ob(n+nsndlev-1).ne.lev_in_ob(n+nsndlev-1)) then<a name='2369'>
                IF (iprt) THEN<a name='2370'>
                  write(msg,*) "n = ",n,"nsndlev = ",nsndlev <a name='2371'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_784">(msg)<a name='2372'>
                  write(msg,*) "nlevs_ob,lev_in_ob",                          &amp;<a name='2373'>
                           nlevs_ob(n+nsndlev-1),lev_in_ob(n+nsndlev-1)<a name='2374'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_785">(msg)<a name='2375'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_786">("in nudobs.F: sounding level messed up, stopping")<a name='2376'>
                ENDIF<a name='2377'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_690"> ( 'wrf_fddaobs_in: in4dob' )<a name='2378'>
             endif       <a name='2379'>
<font color=#447700>!yliu end<a name='2380'></font>
<font color=#447700>! This is for a multi-level observation<a name='2381'></font>
<font color=#447700>! The trick here is that the sounding is "one ob". You don't<a name='2382'></font>
<font color=#447700>!    want multiple levels to each be treated like separate<a name='2383'></font>
<font color=#447700>!    and independent observations.<a name='2384'></font>
<font color=#447700>! At each i,j want to interpolate sounding to the model levels at that<a name='2385'></font>
<font color=#447700>!    particular point.<a name='2386'></font>
              komin=1<a name='2387'>
              komax=kte-2<a name='2388'>
<font color=#447700>! this loop goes to 1501<a name='2389'></font>
<font color=#447700>! do from kte-2 to 1 so don't adjust top of model. Arbitrary.<a name='2390'></font>
<font color=#447700>!yliu start<a name='2391'></font>
              do k=1,kte<a name='2392'>
                reserf(k)=0.0<a name='2393'>
                wtsig(k)=0.0<a name='2394'>
              enddo<a name='2395'>
<font color=#447700>!yliu end<a name='2396'></font>
<a name='2397'>
              do k=komax,komin,-1<a name='2398'>
  <a name='2399'>
                pijk = .001*(pbase(i,k)+pp(i,k))<a name='2400'>
<a name='2401'>
<font color=#447700>! if sigma level pressure is .gt. than the lowest ob level, don't interpolate<a name='2402'></font>
                if(pijk.gt.varobs(5,n)) then<a name='2403'>
                  go to 1501<a name='2404'>
                endif<a name='2405'>
<a name='2406'>
<font color=#447700>! if sigma level pressure is .lt. than the highest ob level, don't interpolate<a name='2407'></font>
                if(pijk.le.varobs(5,n+nsndlev-1)) then <a name='2408'>
                  go to 1501<a name='2409'>
                endif<a name='2410'>
<a name='2411'>
<font color=#447700>! now interpolate sounding to this k<a name='2412'></font>
<font color=#447700>! yliu start-- recalculate WTij for each k-level<a name='2413'></font>
<font color=#447700>!ajb      SLOPE = (RINFMN-RINFMX)/(pdoc(i,j)+PTOP-PFREE)        <a name='2414'></font>
                slope = (RINFMN-RINFMX)/ (.001*pbase(i,1)-PFREE)<a name='2415'>
                RINFAC=SLOPE*pijk+RINFMX-SLOPE*PFREE              <a name='2416'>
                RINFAC=AMAX1(RINFAC,RINFMN)      <a name='2417'>
                RINFAC=AMIN1(RINFAC,RINFMX)<a name='2418'>
                RIS=RINDX*RINFAC*RINDX*RINFAC  <a name='2419'>
                RSQ=RX*RX+RY*RY               <a name='2420'>
<a name='2421'>
<font color=#447700>! for upper-air data, keep D1 influence radii<a name='2422'></font>
                WTIJ(i)=(RIS-RSQ)/(RIS+RSQ)      <a name='2423'>
                WTIJ(i)=AMAX1(0.0,WTIJ(i))<a name='2424'>
<font color=#447700>! yliu end<a name='2425'></font>
<font color=#447700>! Set the pressure difference between the current model level and<a name='2426'></font>
<font color=#447700>! both the level above and below to a number larger than the maximum (BPR)<a name='2427'></font>
               abs_pdiff_above = maxsnd_gap+1.0<a name='2428'>
               abs_pdiff_below = maxsnd_gap+1.0<a name='2429'>
<a name='2430'>
<font color=#447700>! this loop goes to 1503<a name='2431'></font>
                do nn=2,nsndlev<a name='2432'>
<a name='2433'>
<font color=#447700>! only set pobhi if varobs(ivar) is ok<a name='2434'></font>
                  pobhi=-888888.<a name='2435'>
<a name='2436'>
                  if(varobs(ivar,n+nn-1).gt.-800000.                           &amp;<a name='2437'>
                  .and. varobs(5,n+nn-1).gt.-800000.) then<a name='2438'>
                    pobhi=varobs(5,n+nn-1)<a name='2439'>
                    nhi=n+nn-1<a name='2440'>
<font color=#447700>! Check if current level in the innovation is above the current<a name='2441'></font>
<font color=#447700>! model level but within maxsnd_gap (BPR)<a name='2442'></font>
                    abs_pdiff_above=abs(pobhi-pijk)<a name='2443'>
                    if(pobhi.le.pijk .and. abs_pdiff_above.le.maxsnd_gap) then<a name='2444'>
                      go to 1502        <font color=#447700>! within maxsnd_gap of obs height<a name='2445'></font>
                    endif<a name='2446'>
                  endif<a name='2447'>
<a name='2448'>
                enddo<a name='2449'>
<a name='2450'>
<font color=#447700>! OLD: did not find any ob above within maxsnd_gap/2, so jump out<a name='2451'></font>
<font color=#447700>! NEW: did not find any ob above within maxsnd_gap, so jump out<a name='2452'></font>
<a name='2453'>
                go to 1501<a name='2454'>
 1502           continue<a name='2455'>
<a name='2456'>
                nlo=nhi-1<a name='2457'>
                do nnjc=nhi-1,n,-1 <a name='2458'>
                  if(varobs(ivar,nnjc).gt.-800000.                             &amp;<a name='2459'>
                  .and. varobs(5,nnjc).gt.-800000.) then<a name='2460'>
                    poblo=varobs(5,nnjc)<a name='2461'>
                    nlo=nnjc<a name='2462'>
<font color=#447700>! Check if current level in the innovation is below the current<a name='2463'></font>
<font color=#447700>! model level but within maxsnd_gap (BPR)<a name='2464'></font>
                    abs_pdiff_below=abs(poblo-pijk)<a name='2465'>
                    if(poblo.ge.pijk .and. abs_pdiff_below.le.maxsnd_gap) then<a name='2466'>
                      go to 1505        <font color=#447700>! within maxsnd_gap of obs height<a name='2467'></font>
                    endif<a name='2468'>
                  endif<a name='2469'>
                enddo<a name='2470'>
<font color=#447700>!yliu end --<a name='2471'></font>
<a name='2472'>
<font color=#447700>! OLD: did not find any ob below within maxsnd_gap/2, so jump out<a name='2473'></font>
<font color=#447700>! NEW: did not find any ob below within maxsnd_gap, so jump out<a name='2474'></font>
<a name='2475'>
                go to 1501<a name='2476'>
 1505           continue<a name='2477'>
<font color=#447700>!BPR BEGIN<a name='2478'></font>
<font color=#447700>! Ensure that sum of gap between model level and the closest<a name='2479'></font>
<font color=#447700>! innovation level above that combined with the sum of the gap<a name='2480'></font>
<font color=#447700>! between the model level and the closest innovation level below<a name='2481'></font>
<font color=#447700>! that is less than or equal to the maximum allowed gap<a name='2482'></font>
                if((abs_pdiff_below+abs_pdiff_above).gt.maxsnd_gap) then<a name='2483'>
                 goto 1501<a name='2484'>
                endif<a name='2485'>
<a name='2486'>
<font color=#447700>! interpolate to model level<a name='2487'></font>
<font color=#447700>! Avoid potential division by zero (or near-zero) that may now<a name='2488'></font>
<font color=#447700>! occur when the model pressure exactly matches the pressure of<a name='2489'></font>
<font color=#447700>! one of the levels in the innovation profile.<a name='2490'></font>
<font color=#447700>! Note that these variables are in terms of cb so we are assuming that<a name='2491'></font>
<font color=#447700>! if the closest innovation level below the model level is within<a name='2492'></font>
<font color=#447700>! 0.00001 hPa of the the closest innovation level above the model<a name='2493'></font>
<font color=#447700>! level then those two levels are identical. (BPR)<a name='2494'></font>
                IF(abs(pobhi-poblo).lt.0.000001) THEN<a name='2495'>
                 pdiffj=0<a name='2496'>
                ELSE<a name='2497'>
                 <font color=#447700>!Original code just used following statement<a name='2498'></font>
                 pdiffj=alog(pijk/poblo)/alog(pobhi/poblo)<a name='2499'>
                ENDIF<a name='2500'>
<a name='2501'>
                reserf(k)=errf(ivar,nlo)+                               &amp;<a name='2502'>
                            (errf(ivar,nhi)-errf(ivar,nlo))*pdiffj<a name='2503'>
<a name='2504'>
                <font color=#447700>!See Reen et al. poster/extended abstract (P13) from 2013 WRF<a name='2505'></font>
                <font color=#447700>!User's Workshop regarding the following moisture innovation<a name='2506'></font>
                <font color=#447700>!scaling code.<a name='2507'></font>
                <font color=#447700>!If dealing with moisture and user chose to scale certain<a name='2508'></font>
                <font color=#447700>!negative QV innovations<a name='2509'></font>
                IF((IVAR.EQ.4).AND.(obs_scl_neg_qv_innov.GT.0)) THEN<a name='2510'>
                 QVB_AT_CUR_LOC = QVB(I,K,J)<a name='2511'>
                 <font color=#447700>!Vertically intepolate observed moisture<a name='2512'></font>
                 QVB_AT_OB_LOC=errf(10,nlo)+                               &amp;<a name='2513'>
                              (errf(10,nhi)-errf(10,nlo))*pdiffj<a name='2514'>
                 <font color=#447700>!If the moisture innovation is negative and the model<a name='2515'></font>
                 <font color=#447700>!moisture<a name='2516'></font>
                 <font color=#447700>! is less at the current location where we are about to apply<a name='2517'></font>
                 <font color=#447700>! the innovation than at the location where the ob was taken<a name='2518'></font>
                 IF((reserf(k).LT.0).AND.(QVB_AT_CUR_LOC.LT.QVB_AT_OB_LOC)) THEN<a name='2519'>
                  <font color=#447700>!The ratio of the model moisture at the current location<a name='2520'></font>
                  <font color=#447700>! compared to the ob location will be used to scale the<a name='2521'></font>
                  <font color=#447700>!  innovation.<a name='2522'></font>
                  QVB_CUR_LOC_OVER_OB_LOC = QVB_AT_CUR_LOC/QVB_AT_OB_LOC<a name='2523'>
                  IF(obs_scl_neg_qv_innov.eq.1) THEN<a name='2524'>
                   <font color=#447700>!Limit the innovation such that it cannot nudge towards a<a name='2525'></font>
                   <font color=#447700>!negative value<a name='2526'></font>
                   SCALE_FACTOR_NEG_QV_INNOV = MIN(1.0,ABS(QVB_AT_CUR_LOC/reserf(k)))<a name='2527'>
                  ELSE<a name='2528'>
                   <font color=#447700>!If the user chose a value for obs_scl_neg_qv_innov that<a name='2529'></font>
                   <font color=#447700>!this code is unaware of, stop WRF<a name='2530'></font>
                   IF (iprt) then<a name='2531'>
                    write(msg,*) 'Unknown value of obs_scl_neg_qv_innov = ',obs_scl_neg_qv_innov<a name='2532'>
                    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_787">(msg)<a name='2533'>
                   ENDIF<a name='2534'>
                   call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_691"> ( 'module_fddaobs_rtfdda: nudob: Unknown value of obs_scl_neg_qv_innov' )<a name='2535'>
                  ENDIF<a name='2536'>
                  reserf(k) = reserf(k)*SCALE_FACTOR_NEG_QV_INNOV<a name='2537'>
                 ENDIF<a name='2538'>
<a name='2539'>
                ENDIF<a name='2540'>
<a name='2541'>
                wtsig(k)=1.<a name='2542'>
  <a name='2543'>
 1501           continue<a name='2544'>
<a name='2545'>
<font color=#447700>! now calculate WT and WT2ERR for each i,j,k point                               cajb<a name='2546'></font>
<font color=#447700>!ajb Add weights to sum only if nudge_pbl switch is on OR k &gt; kpblt.<a name='2547'></font>
                if(nudge_pbl .or. k.gt.kpblt(i)) then<a name='2548'>
<a name='2549'>
                  WT(I,K)=WT(I,K)+TIMEWT*WTIJ(i)*wtsig(k)<a name='2550'>
  <a name='2551'>
                  WT2ERR(I,K)=WT2ERR(I,K)+TIMEWT*TIMEWT*WTIJ(i)*WTIJ(i)*        &amp;<a name='2552'>
                              reserf(k)*wtsig(k)*wtsig(k)<a name='2553'>
                endif<a name='2554'>
<a name='2555'>
              enddo   <font color=#447700>! enddo k levels<a name='2556'></font>
<a name='2557'>
<font color=#447700>! end multi-levels<a name='2558'></font>
            endif  <font color=#447700>! end if(nsndlev.eq.1)<a name='2559'></font>
<font color=#447700>!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$<a name='2560'></font>
<font color=#447700>!   END 1-LEVEL AND MULTI-LEVEL OBSERVATIONS<a name='2561'></font>
<font color=#447700>!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$<a name='2562'></font>
<font color=#447700>!<a name='2563'></font>
          ENDDO <font color=#447700>! END DO MINI,MAXI LOOP<a name='2564'></font>
<a name='2565'>
        endif <font color=#447700>! check for obs in domain<a name='2566'></font>
<a name='2567'>
<font color=#447700>! END OF NUDGING TO OBS ON PRESSURE LEVELS<a name='2568'></font>
<a name='2569'>
      ENDIF <font color=#447700>!end IF(KOB.EQ.1.AND.IVAR.LE.4.and.nlevs_ob(n).lt.1.5)<a name='2570'></font>
<a name='2571'>
<font color=#447700>!----------------------------------------------------------------------<a name='2572'></font>
    ENDIF  <font color=#447700>! END SECTION FOR PROCESSING OF OBSERVATION<a name='2573'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2574'></font>
<a name='2575'>
<font color=#447700>!   n=n+1<a name='2576'></font>
    n=n+njcsnd<a name='2577'>
<a name='2578'>
<font color=#447700>!yliu  1202 continue<a name='2579'></font>
    if(n.gt.nstat)then<a name='2580'>
<font color=#447700>!     print *,'n,nstat=',n,nstat,ivar,j<a name='2581'></font>
      go to 1203<a name='2582'>
    endif<a name='2583'>
<font color=#447700>!   print *, "e-- n=,nsndlev",n,njcsnd,nlevs_ob(n),lev_in_ob(n) <a name='2584'></font>
<a name='2585'>
<font color=#447700>!***********************************************************************<a name='2586'></font>
  ENDDO  <font color=#447700>! END OUTER LOOP FOR THE NSTAT OBSERVATIONS<a name='2587'></font>
<font color=#447700>!***********************************************************************<a name='2588'></font>
<a name='2589'>
 1203 continue<a name='2590'>
<a name='2591'>
<font color=#447700>! WEIGHTS AND WEIGHTED DIFFERENCES HAVE BEEN SUMMED.  NOW<a name='2592'></font>
<font color=#447700>! APPLY THE NUDGING FACTOR AND THE RESULTANT TENDENCY TO<a name='2593'></font>
<font color=#447700>! THE ATEN ARRAY<a name='2594'></font>
<font color=#447700>! ASSURE THAT WT(I,K) AND WTP(I,K) ARE NONZERO SINCE<a name='2595'></font>
<font color=#447700>! THEY ARE USED BELOW IN THE DENOMINATOR.<a name='2596'></font>
  DO K=kts,kte<a name='2597'>
    DO I=its,ite<a name='2598'>
      IF(WT(I,K).EQ.0)THEN<a name='2599'>
        WT2ERR(I,K)=0.0<a name='2600'>
      ENDIF<a name='2601'>
      IF(WT(I,K).EQ.0)THEN<a name='2602'>
        WT(I,K)=1.0<a name='2603'>
      ENDIF<a name='2604'>
    ENDDO<a name='2605'>
  ENDDO<a name='2606'>
<a name='2607'>
126 CONTINUE<a name='2608'>
<a name='2609'>
  IF(IVAR.GE.3)GOTO 170<a name='2610'>
<font color=#447700>! this is for u,v<a name='2611'></font>
<font color=#447700>! 3-D DOT POINT TENDENCIES<a name='2612'></font>
 <a name='2613'>
<font color=#447700>! Calculate scales for converting nudge factor from u (v)<a name='2614'></font>
<font color=#447700>! to rho_u (or rho_v) units.<a name='2615'></font>
<a name='2616'>
  IF (IVAR == 1) THEN<a name='2617'>
     call <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#CALC_RCOUPLE_SCALES'>calc_rcouple_scales</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_RCOUPLE_SCALES_1">(mu,msfy,rscale,ims,ime,its,ite)<a name='2618'>
  ELSE IF (IVAR == 2) THEN<a name='2619'>
     call <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#CALC_RCOUPLE_SCALES'>calc_rcouple_scales</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#NUDOB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_RCOUPLE_SCALES_2">(mu,msfx,rscale,ims,ime,its,ite)<a name='2620'>
  END IF<a name='2621'>
 <a name='2622'>
  DO K=1,kte<a name='2623'>
<a name='2624'>
    DO I=i_s,i_e<a name='2625'>
<a name='2626'>
      IF(MOD(KTAU,INFR).EQ.0.OR.(IFREST.AND.KTAU.EQ.KTAUR))THEN<a name='2627'>
        W2EOWT=WT2ERR(I,K)/WT(I,K)<a name='2628'>
      ELSE<a name='2629'>
        W2EOWT=SAVWT(IPL,I,K)<a name='2630'>
<a name='2631'>
<font color=#447700>!        write(6,'(a,4i4,f8.3)') 'i,j,k,ipl,W2EOWT = ',i,j,k,ipl,W2EOWT<a name='2632'></font>
<a name='2633'>
      ENDIF<a name='2634'>
<a name='2635'>
<font color=#447700>!      if(ivar .eq. 1 .and. i.eq.38 .and. j.eq.78 .and. k.eq.1) then<a name='2636'></font>
<font color=#447700>!           scratch = GIV*RSCALE(I)*W2EOWT*TFACI*ISWIND*GFACTOR<a name='2637'></font>
<font color=#447700>!           write(6,*) 'ATEN calc: k = ',k<a name='2638'></font>
<font color=#447700>!           write(6,*) 'U before: aten = ',aten(i,k),' scr = ',scratch<a name='2639'></font>
<font color=#447700>!           write(6,*) 'GIV = ',giv,' rscale = ',rscale(i),<a name='2640'></font>
<font color=#447700>!     $               ' W2EOWT = ',w2eowt<a name='2641'></font>
<font color=#447700>!           write(6,*) 'TFACI = ',tfaci,' ISWIND = ',iswind,<a name='2642'></font>
<font color=#447700>!     $               ' GFACTOR = ',gfactor<a name='2643'></font>
<font color=#447700>!       endif<a name='2644'></font>
<font color=#447700>!<a name='2645'></font>
<font color=#447700>!      if(ivar .eq. 2 .and. i.eq.39 .and. j.eq.29) then<a name='2646'></font>
<font color=#447700>!           scratch = GIV*RSCALE(I)*W2EOWT*TFACI*ISWIND*GFACTOR<a name='2647'></font>
<font color=#447700>!           write(6,*) 'ATEN calc: k = ',k<a name='2648'></font>
<font color=#447700>!           write(6,*) 'V before: aten = ',aten(i,k),' scr = ',scratch<a name='2649'></font>
<font color=#447700>!           write(6,*) 'GIV = ',giv,' rscale = ',rscale(i),<a name='2650'></font>
<font color=#447700>!     $                ' W2EOWT = ',w2eowt<a name='2651'></font>
<font color=#447700>!           write(6,*) 'TFACI = ',tfaci,' ISWIND = ',iswind,<a name='2652'></font>
<font color=#447700>!     $                ' GFACTOR = ',gfactor<a name='2653'></font>
<font color=#447700>!       endif<a name='2654'></font>
<a name='2655'>
<font color=#447700>!      if(ivar .eq. 1 .and. i.eq.38 .and. (j.ge.36.and.j.le.62) .and. k.eq.7) then<a name='2656'></font>
<font color=#447700>!           scratch = GIV*RSCALE(I)*W2EOWT*TFACI*ISWIND*GFACTOR<a name='2657'></font>
<font color=#447700>!           write(6,*)<a name='2658'></font>
<font color=#447700>!           write(6,*) 'ATEN calc: j = ',j,' k = ',k<a name='2659'></font>
<font color=#447700>!           write(6,*) 'U before: aten = ',aten(i,k),' scr = ',scratch<a name='2660'></font>
<font color=#447700>!           write(6,*) 'GIV = ',giv,' rscale = ',rscale(i),' W2EOWT = ',w2eowt<a name='2661'></font>
<font color=#447700>!           write(6,*) 'TFACI = ',tfaci,' ISWIND = ',iswind,' GFACTOR = ',gfactor<a name='2662'></font>
<font color=#447700>!       endif<a name='2663'></font>
<a name='2664'>
        ATEN(i,k)=ATEN(i,k)+GIV*RSCALE(I)                        &amp;<a name='2665'>
                    *W2EOWT*TFACI                           &amp;<a name='2666'>
                    *ISWIND       *GFACTOR   <font color=#447700>!yliu *GFACTOR <a name='2667'></font>
<a name='2668'>
<font color=#447700>!      if(ivar .eq. 1 .and. i.eq.38 .and. j.eq.78 .and. k.eq.1) then<a name='2669'></font>
<font color=#447700>!           write(6,*) 'U after: aten = ',aten(i,k),' scr = ',scratch<a name='2670'></font>
<font color=#447700>!      endif<a name='2671'></font>
<font color=#447700>!      if(ivar .eq. 2 .and. i.eq.39 .and. j.eq.29) then<a name='2672'></font>
<font color=#447700>!           write(6,*) 'V after: aten = ',aten(i,k),' scr = ',scratch<a name='2673'></font>
<font color=#447700>!      endif<a name='2674'></font>
<a name='2675'>
    ENDDO<a name='2676'>
  ENDDO<a name='2677'>
<a name='2678'>
  IF(MOD(KTAU,INFR).EQ.0.OR.(IFREST.AND.KTAU.EQ.KTAUR))THEN<a name='2679'>
    DO K=1,kte<a name='2680'>
      DO I=its,ite<a name='2681'>
        SAVWT(IPL,I,K)=WT2ERR(I,K)/WT(I,K)<a name='2682'>
<a name='2683'>
<font color=#447700>!        write(6,'(a,4i4,f8.3)') 'i,j,k,ipl,savwt = ',i,j,k,ipl,savwt(ipl,i,k)<a name='2684'></font>
      ENDDO<a name='2685'>
    ENDDO<a name='2686'>
  ENDIF<a name='2687'>
<a name='2688'>
  RETURN<a name='2689'>
<a name='2690'>
170 CONTINUE<a name='2691'>
<a name='2692'>
<font color=#447700>! 3-D CROSS-POINT TENDENCIES<a name='2693'></font>
<font color=#447700>! this is for t (ivar=3) and q (ivsr=4)<a name='2694'></font>
  IF(3-IVAR.LT.0)THEN<a name='2695'>
    GITQ=GIQ<a name='2696'>
  ELSE<a name='2697'>
    GITQ=GIT<a name='2698'>
  ENDIF<a name='2699'>
  IF(3-IVAR.LT.0)THEN<a name='2700'>
    ISTQ=ISMOIS<a name='2701'>
  ELSE<a name='2702'>
    ISTQ=ISTEMP<a name='2703'>
  ENDIF<a name='2704'>
<a name='2705'>
  DO K=1,kte<a name='2706'>
    DO I=i_s,i_e<a name='2707'>
      IF(MOD(KTAU,INFR).EQ.0.OR.(IFREST.AND.KTAU.EQ.KTAUR))THEN<a name='2708'>
        W2EOWT=WT2ERR(I,K)/WT(I,K)<a name='2709'>
      ELSE<a name='2710'>
        W2EOWT=SAVWT(IPL,I,K)<a name='2711'>
      ENDIF<a name='2712'>
<a name='2713'>
<font color=#447700>!        if(ivar .eq. 3 .and. i.eq.39 .and. j.eq.49) then<a name='2714'></font>
<font color=#447700>!            scratch = GITQ*MU(I)*W2EOWT*TFACI*ISTQ*GFACTOR<a name='2715'></font>
<font color=#447700>!            write(6,*) 'ATEN calc: k = ',k<a name='2716'></font>
<font color=#447700>!            write(6,*) 'T before: aten = ',aten(i,k),' scr = ',scratch<a name='2717'></font>
<font color=#447700>!            write(6,*) 'GITQ = ',gitq,' MU = ',MU(i),                  &amp;<a name='2718'></font>
<font color=#447700>!                       ' W2EOWT = ',w2eowt<a name='2719'></font>
<font color=#447700>!            write(6,*) ' TFACI = ',tfaci,' ISTQ = ',istq,              &amp;<a name='2720'></font>
<font color=#447700>!                       ' GFACTOR = ',gfactor<a name='2721'></font>
<font color=#447700>!        endif<a name='2722'></font>
 <a name='2723'>
<font color=#447700>!        if(ivar .eq. 4 .and. i.eq.39 .and. j.eq.29) then<a name='2724'></font>
<font color=#447700>!            scratch = GITQ*MU(I)*W2EOWT*TFACI*ISTQ*GFACTOR<a name='2725'></font>
<font color=#447700>!            write(6,*) 'ATEN calc: k = ',k<a name='2726'></font>
<font color=#447700>!            write(6,*) 'Q before: aten = ',aten(i,k),' scr = ',scratch<a name='2727'></font>
<font color=#447700>!            write(6,*) 'GITQ = ',gitq,' MU = ',MU(i),<a name='2728'></font>
<font color=#447700>!     $                 ' W2EOWT = ',w2eowt<a name='2729'></font>
<font color=#447700>!            write(6,*) ' TFACI = ',tfaci,' ISTQ = ',istq,<a name='2730'></font>
<font color=#447700>!     $                 ' GFACTOR = ',gfactor<a name='2731'></font>
<font color=#447700>!        endif<a name='2732'></font>
<a name='2733'>
      ATEN(i,k)=ATEN(i,k)+GITQ*MU(I)                       &amp;<a name='2734'>
                  *W2EOWT*TFACI*ISTQ       *GFACTOR   <font color=#447700>!yliu *GFACTOR<a name='2735'></font>
<a name='2736'>
<font color=#447700>!        if(ivar .eq. 3 .and. i.eq.39 .and. j.eq.49) then<a name='2737'></font>
<font color=#447700>!            write(6,*) 'T after: aten = ',aten(i,k),' scr = ',scratch<a name='2738'></font>
<font color=#447700>!        endif<a name='2739'></font>
<font color=#447700>!        if(ivar .eq. 4 .and. i.eq.39 .and. j.eq.29) then<a name='2740'></font>
<font color=#447700>!            write(6,*) 'Q after: aten = ',aten(i,k),' scr = ',scratch<a name='2741'></font>
<font color=#447700>!        endif<a name='2742'></font>
<a name='2743'>
    ENDDO<a name='2744'>
  ENDDO<a name='2745'>
<a name='2746'>
  IF(MOD(KTAU,INFR).EQ.0.OR.(IFREST.AND.KTAU.EQ.KTAUR)) THEN<a name='2747'>
    DO K=1,kte<a name='2748'>
      DO I=its,ite<a name='2749'>
        SAVWT(IPL,I,K)=WT2ERR(I,K)/WT(I,K)<a name='2750'>
      ENDDO<a name='2751'>
    ENDDO<a name='2752'>
  ENDIF<a name='2753'>
<a name='2754'>
  RETURN<a name='2755'>
  END SUBROUTINE nudob<a name='2756'>
<a name='2757'>
<A NAME='DATE_STRING'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#DATE_STRING' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2758'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>date_string</font>(year, month, day, hour, minute, second, cdate) <A href='../../call_to/DATE_STRING.html' TARGET='index'>1</A><a name='2759'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2760'></font>
<font color=#447700>!  PURPOSE: Form a date string (YYYY-MM-DD_hh:mm:ss) from integer<a name='2761'></font>
<font color=#447700>!           components.<a name='2762'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2763'></font>
  IMPLICIT NONE<a name='2764'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2765'></font>
<a name='2766'>
  INTEGER, INTENT(IN)  :: year<a name='2767'>
  INTEGER, INTENT(IN)  :: month<a name='2768'>
  INTEGER, INTENT(IN)  :: day<a name='2769'>
  INTEGER, INTENT(IN)  :: hour<a name='2770'>
  INTEGER, INTENT(IN)  :: minute<a name='2771'>
  INTEGER, INTENT(IN)  :: second<a name='2772'>
  CHARACTER*19, INTENT(INOUT) :: cdate<a name='2773'>
<a name='2774'>
<font color=#447700>! Local variables<a name='2775'></font>
  integer   :: ic                    <font color=#447700>! loop counter<a name='2776'></font>
<a name='2777'>
      cdate(1:19)  = "0000-00-00_00:00:00"<a name='2778'>
      write(cdate( 1: 4),'(i4)') year<a name='2779'>
      write(cdate( 6: 7),'(i2)') month<a name='2780'>
      write(cdate( 9:10),'(i2)') day<a name='2781'>
      write(cdate(12:13),'(i2)') hour<a name='2782'>
      write(cdate(15:16),'(i2)') minute<a name='2783'>
      write(cdate(18:19),'(i2)') second<a name='2784'>
      do ic = 1,19<a name='2785'>
        if(cdate(ic:ic) .eq. " ") cdate(ic:ic) = "0"<a name='2786'>
      enddo<a name='2787'>
<a name='2788'>
  RETURN<a name='2789'>
  END SUBROUTINE date_string<a name='2790'>
<a name='2791'>
<A NAME='CALC_RCOUPLE_SCALES'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#CALC_RCOUPLE_SCALES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2792'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_rcouple_scales</font>(a, msf, rscale, ims,ime, its,ite) <A href='../../call_to/CALC_RCOUPLE_SCALES.html' TARGET='index'>2</A><a name='2793'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2794'></font>
  IMPLICIT NONE<a name='2795'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2796'></font>
<a name='2797'>
  INTEGER, INTENT(IN)  :: ims,ime           <font color=#447700>! Memory dimensions<a name='2798'></font>
  INTEGER, INTENT(IN)  :: its,ite           <font color=#447700>! Tile   dimensions<a name='2799'></font>
  REAL, INTENT(IN)     :: a( ims:ime )      <font color=#447700>! Air mass array <a name='2800'></font>
  REAL, INTENT(IN)     :: msf( ims:ime )    <font color=#447700>! Map scale factor array<a name='2801'></font>
  REAL, INTENT(OUT)    :: rscale( ims:ime ) <font color=#447700>! Scales for rho-coupling<a name='2802'></font>
<a name='2803'>
<font color=#447700>! Local variables<a name='2804'></font>
  integer :: i<a name='2805'>
<a name='2806'>
<font color=#447700>! Calculate scales to be used for producing rho-coupled nudging factors.<a name='2807'></font>
  do i = its,ite<a name='2808'>
    rscale(i) = a(i)/msf(i)<a name='2809'>
  enddo<a name='2810'>
<a name='2811'>
  RETURN<a name='2812'>
  END SUBROUTINE calc_rcouple_scales<a name='2813'>
<a name='2814'>
<A NAME='PRINT_OBS_INFO'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_OBS_INFO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2815'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>print_obs_info</font>(iprt,inest,niobf,rio,rjo,rko,                &amp; <A href='../../call_to/PRINT_OBS_INFO.html' TARGET='index'>1</A>,<A href='../../call_from/PRINT_OBS_INFO.html' TARGET='index'>7</A><a name='2816'>
                            prt_max,prt_freq,obs,stnid,lat,lon,          &amp;<a name='2817'>
                            mlat,mlon,timeob,xtime)<a name='2818'>
<font color=#447700>!*************************************************************************<a name='2819'></font>
<font color=#447700>! Purpose: Print obs information.<a name='2820'></font>
<font color=#447700>!*************************************************************************<a name='2821'></font>
<a name='2822'>
  IMPLICIT NONE<a name='2823'>
<a name='2824'>
  LOGICAL, intent(in)    :: iprt          <font color=#447700>! Print flag<a name='2825'></font>
  INTEGER, intent(in)    :: inest         <font color=#447700>! Nest level<a name='2826'></font>
  INTEGER, intent(in)    :: niobf         <font color=#447700>! Maximum number of observations<a name='2827'></font>
  REAL,    intent(in)    :: rio(niobf)    <font color=#447700>! West-east coord (non-stagger)<a name='2828'></font>
  REAL,    intent(in)    :: rjo(niobf)    <font color=#447700>! South-north coord (non-stagger)<a name='2829'></font>
  REAL,    intent(in)    :: rko(niobf)    <font color=#447700>! Bottom-top north coord (non-stagger)<a name='2830'></font>
  INTEGER, intent(in)    :: prt_max        <font color=#447700>! Max no. of obs for diagnostic printout<a name='2831'></font>
  INTEGER, intent(in)    :: prt_freq       <font color=#447700>! Frequency for diagnostic printout<a name='2832'></font>
  INTEGER, intent(in)    :: obs(prt_max)  <font color=#447700>! Saved obs indices to print<a name='2833'></font>
  INTEGER, intent(in)    :: stnid(40,prt_max) <font color=#447700>! Saved station ids<a name='2834'></font>
  REAL,    intent(in)    :: lat(prt_max)  <font color=#447700>! Saved latitudes<a name='2835'></font>
  REAL,    intent(in)    :: lon(prt_max)  <font color=#447700>! Saved longitudes<a name='2836'></font>
  REAL,    intent(in)    :: mlat(prt_max) <font color=#447700>! Saved model latitudes<a name='2837'></font>
  REAL,    intent(in)    :: mlon(prt_max) <font color=#447700>! Saved longitudes<a name='2838'></font>
  REAL,    intent(in)    :: timeob(niobf) <font color=#447700>! Times of each observation (hours)<a name='2839'></font>
  REAL,    intent(in)    :: xtime         <font color=#447700>! Model time in minutes<a name='2840'></font>
<a name='2841'>
<font color=#447700>! Local variables<a name='2842'></font>
  integer :: i                    <font color=#447700>! Loop counter over obs station chars<a name='2843'></font>
  integer :: n                    <font color=#447700>! Loop counter over obs<a name='2844'></font>
  integer :: pnx                  <font color=#447700>! Obs index for printout<a name='2845'></font>
  character(len=200) :: msg       <font color=#447700>! Argument to wrf_message<a name='2846'></font>
  character(len=20)  :: station_id <font color=#447700>! Station id of observation<a name='2847'></font>
<a name='2848'>
  if(iprt) then<a name='2849'>
    if(prt_max.gt.0) then<a name='2850'>
<a name='2851'>
      if(obs(1).ne.-999) then<a name='2852'>
<a name='2853'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_OBS_INFO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_788">("")<a name='2854'>
        write(msg,fmt='(a,i4,a,f8.1,a)') 'REPORTING OBS MASS-PT LOCS FOR NEST ',  &amp;<a name='2855'>
                                     inest,' AT XTIME=',xtime,' MINUTES'<a name='2856'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_OBS_INFO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_789">(msg)<a name='2857'>
<a name='2858'>
        write(msg,fmt='(a,i4,a,i5,a)') 'FREQ=',prt_freq,', MAX=',prt_max,         &amp;<a name='2859'>
                           ' LOCS, NEWLY READ OBS ONLY, -999 =&gt; OBS OFF PROC'<a name='2860'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_OBS_INFO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_790">(msg)<a name='2861'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_OBS_INFO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_791">("")<a name='2862'>
<a name='2863'>
        write(msg,fmt='(3a)') '    OBS#     I       J       K     OBS LAT',       &amp;<a name='2864'>
                          '  OBS LON   XLAT(I,J)  XLONG(I,J)  TIME(hrs)',     &amp;<a name='2865'>
                          '  OBS STATION ID'<a name='2866'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_OBS_INFO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_792">(msg)<a name='2867'>
<a name='2868'>
      endif<a name='2869'>
    endif<a name='2870'>
<a name='2871'>
<font color=#447700>! Note: rio and rjo are referenced to non-staggered grid (not mass-point!)<a name='2872'></font>
<font color=#447700>!       Hence subtract .5 from each to get mass-point coords.<a name='2873'></font>
    do n=1,prt_max<a name='2874'>
       pnx = obs(n)<a name='2875'>
       if(pnx.ne.-999) then<a name='2876'>
<font color=#447700>!          Retrieve 15 chars of station id<a name='2877'></font>
           do i = 1,15<a name='2878'>
              station_id(i:i) = char(stnid(i,n))<a name='2879'>
           enddo<a name='2880'>
           write(msg,fmt='(2x,i7,3f8.3,2f9.3,2x,f9.3,2x,f9.3,3x,f6.2,7x,a15)')    &amp;<a name='2881'>
               pnx,rio(pnx)-.5,rjo(pnx)-.5,rko(pnx),lat(n),lon(n),            &amp;<a name='2882'>
               mlat(n),mlon(n),timeob(pnx),station_id<a name='2883'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_OBS_INFO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_793">(msg)<a name='2884'>
       endif<a name='2885'>
    enddo<a name='2886'>
    if(obs(1).ne.-999) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_OBS_INFO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_794">("")<a name='2887'>
  endif<a name='2888'>
  END SUBROUTINE print_obs_info<a name='2889'>
<a name='2890'>
<A NAME='HT_TO_P'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#HT_TO_P' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2891'>
  REAL <font color=#993300>FUNCTION </font><font color=#cc0000>ht_to_p</font>( h, pbbc, ppbc, z, ic, jc, dx, dy,                    &amp; <A href='../../call_to/HT_TO_P.html' TARGET='index'>2</A>,<A href='../../call_from/HT_TO_P.html' TARGET='index'>1</A><a name='2892'>
                         k_start, k_end, kds,kde, ims,ime, jms,jme, kms,kme )<a name='2893'>
<a name='2894'>
<font color=#447700>!******************************************************************************<a name='2895'></font>
<font color=#447700>! Purpose: Interpolate pressure at a specified x (ic), y (jc), and height (h).<a name='2896'></font>
<font color=#447700>!          The input pressure column pbbc+ppbc (base and perturbn) must already<a name='2897'></font>
<font color=#447700>!          be horizontally interpolated to the x, y position. The subroutine<a name='2898'></font>
<font color=#447700>!          get_height_column is called here to horizontally interpolated the<a name='2899'></font>
<font color=#447700>!          3D height field z to get a height column at (iob, job).<a name='2900'></font>
<font color=#447700>!******************************************************************************<a name='2901'></font>
<a name='2902'>
  IMPLICIT NONE<a name='2903'>
<a name='2904'>
  REAL,    INTENT(IN)  :: h                                <font color=#447700>! height value (m)<a name='2905'></font>
  INTEGER, INTENT(IN)  :: k_start, k_end                   <font color=#447700>! loop bounds  <a name='2906'></font>
  INTEGER, INTENT(IN)  :: kds,kde                          <font color=#447700>! vertical dim.<a name='2907'></font>
  INTEGER, INTENT(IN)  :: ims,ime, jms,jme, kms,kme        <font color=#447700>! memory dims.<a name='2908'></font>
  REAL,    INTENT(IN)  :: pbbc(kds:kde)                    <font color=#447700>! column base pressure (cb)<a name='2909'></font>
  REAL,    INTENT(IN)  :: ppbc(kds:kde)                    <font color=#447700>! column pressure perturbation (cb)<a name='2910'></font>
  REAL,    INTENT(IN)  :: z( ims:ime, kms:kme, jms:jme )   <font color=#447700>! ht (m) above sl on half-levels<a name='2911'></font>
  INTEGER, INTENT(IN)  :: ic                               <font color=#447700>! i-coord of desired p<a name='2912'></font>
  INTEGER, INTENT(IN)  :: jc                               <font color=#447700>! j-coord of desired p<a name='2913'></font>
  REAL,    INTENT(IN)  :: dx                               <font color=#447700>! interp. fraction (x dir)<a name='2914'></font>
  REAL,    INTENT(IN)  :: dy                               <font color=#447700>! interp. fraction (y dir)<a name='2915'></font>
<a name='2916'>
<font color=#447700>! Local variables<a name='2917'></font>
  INTEGER :: k               <font color=#447700>! loop counter<a name='2918'></font>
  INTEGER :: klo             <font color=#447700>! lower k bound<a name='2919'></font>
  REAL :: zlo                <font color=#447700>! lower z bound for h<a name='2920'></font>
  REAL :: zhi                <font color=#447700>! upper z bound for h<a name='2921'></font>
  REAL :: p                  <font color=#447700>! interpolated pressure value<a name='2922'></font>
  REAL :: ln_p               <font color=#447700>! log p<a name='2923'></font>
  REAL :: ln_plo             <font color=#447700>! log plo<a name='2924'></font>
  REAL :: ln_phi             <font color=#447700>! log phi<a name='2925'></font>
  REAL :: z_at_p( kms:kme )  <font color=#447700>! height at p levels<a name='2926'></font>
<a name='2927'>
<font color=#447700>! Get interpolated z column on pressure (half-) levels at (ic,jc)<a name='2928'></font>
  call <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#GET_HEIGHT_COLUMN'>get_height_column</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#HT_TO_P' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_HEIGHT_COLUMN_1">(z, ic, jc, dx, dy, z_at_p,                   &amp;<a name='2929'>
                         k_start, k_end, kds,kde,                     &amp;<a name='2930'>
                         ims,ime, jms,jme, kms,kme )<a name='2931'>
<a name='2932'>
<font color=#447700>! Now we have pbbc, ppbc, z_at_p, so compute p at h. First, find<a name='2933'></font>
<font color=#447700>! bounding layers klo and khi so that z_at_p(klo) &lt;= h &lt;= z_at_p(khi)<a name='2934'></font>
<a name='2935'>
  ZLEVS: do k = k_start+1, k_end<a name='2936'>
    klo = k-1<a name='2937'>
    if(h .le. z_at_p(k)) then<a name='2938'>
      EXIT ZLEVS<a name='2939'>
    endif<a name='2940'>
  enddo ZLEVS<a name='2941'>
<a name='2942'>
  zlo = z_at_p(klo)<a name='2943'>
  zhi = z_at_p(klo+1)<a name='2944'>
<a name='2945'>
<font color=#447700>! Interpolate natural log of pressure<a name='2946'></font>
  ln_plo = log( pbbc(klo+1) + ppbc(klo+1) )<a name='2947'>
  ln_phi = log( pbbc(klo) + ppbc(klo) )<a name='2948'>
  if(h.le.zlo) then<a name='2949'>
    ln_p = ln_phi     <font color=#447700>! set to k=1 pressure <a name='2950'></font>
  else if (h.ge.zhi) then<a name='2951'>
    ln_p = ln_plo     <font color=#447700>! set to k=k_end pressure <a name='2952'></font>
  else<a name='2953'>
    ln_p = ln_plo + (ln_phi-ln_plo)*((zhi-h)/(zhi-zlo)) <a name='2954'>
  endif<a name='2955'>
<a name='2956'>
<font color=#447700>! Return pressure<a name='2957'></font>
  p = exp(ln_p)<a name='2958'>
  ht_to_p = p<a name='2959'>
  RETURN<a name='2960'>
  END FUNCTION ht_to_p<a name='2961'>
<a name='2962'>
<A NAME='GET_HEIGHT_COLUMN'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#GET_HEIGHT_COLUMN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2963'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>get_height_column</font>( z, ic, jc, dx, dy, z_at_p,                  &amp; <A href='../../call_to/GET_HEIGHT_COLUMN.html' TARGET='index'>1</A><a name='2964'>
                                k_start, k_end, kds,kde,                    &amp;<a name='2965'>
                                ims,ime, jms,jme, kms,kme )<a name='2966'>
<font color=#447700>!*************************************************************************<a name='2967'></font>
<font color=#447700>! Purpose: Compute column height at ic, jc location on p levels<a name='2968'></font>
<font color=#447700>!*************************************************************************<a name='2969'></font>
<a name='2970'>
  IMPLICIT NONE<a name='2971'>
<a name='2972'>
  INTEGER, INTENT(IN)  :: k_start, k_end                   <font color=#447700>! Loop bounds  <a name='2973'></font>
  INTEGER, INTENT(IN)  :: kds,kde                          <font color=#447700>! vertical dim.<a name='2974'></font>
  INTEGER, INTENT(IN)  :: ims,ime, jms,jme, kms,kme        <font color=#447700>! memory dims.<a name='2975'></font>
  REAL,    INTENT(IN)  :: z( ims:ime, kms:kme, jms:jme )   <font color=#447700>! ht (m) on half-levels<a name='2976'></font>
  INTEGER, INTENT(IN)  :: ic                               <font color=#447700>! i-coord of desired p<a name='2977'></font>
  INTEGER, INTENT(IN)  :: jc                               <font color=#447700>! j-coord of desired p<a name='2978'></font>
  REAL,    INTENT(IN)  :: dx                               <font color=#447700>! interp. fraction (x dir)<a name='2979'></font>
  REAL,    INTENT(IN)  :: dy                               <font color=#447700>! interp. fraction (y dir)<a name='2980'></font>
  REAL,    INTENT(OUT) :: z_at_p( kms:kme )                <font color=#447700>! column height at p levels<a name='2981'></font>
<a name='2982'>
<font color=#447700>! Local variables<a name='2983'></font>
  INTEGER :: k             <font color=#447700>! loop counter<a name='2984'></font>
<a name='2985'>
<a name='2986'>
  do k = kds, kde<a name='2987'>
      z_at_p(k) =                                     &amp; <a name='2988'>
         (1.-DY)*( (1.-DX)*z(IC,K,JC) +               &amp;<a name='2989'>
                            DX *z(IC+1,K,JC) ) +      &amp;<a name='2990'>
             DY* ( (1.-DX)*z(IC,K,JC+1) +             &amp;<a name='2991'>
                            DX *z(IC+1,K,JC+1) )<a name='2992'>
  enddo<a name='2993'>
<a name='2994'>
  END SUBROUTINE get_height_column<a name='2995'>
<a name='2996'>
<A NAME='GET_BASE_STATE_HEIGHT_COLUMN'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#GET_BASE_STATE_HEIGHT_COLUMN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2997'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>get_base_state_height_column</font>( p_top, p00, t00, a, g, r_d,    &amp; <A href='../../call_to/GET_BASE_STATE_HEIGHT_COLUMN.html' TARGET='index'>1</A><a name='2998'>
                               znu, z_at_p,  k_start, k_end, kds,kde, kms,kme )<a name='2999'>
<font color=#447700>!********************************************************<a name='3000'></font>
<font color=#447700>! Purpose: Compute base-state column height on p levels.<a name='3001'></font>
<font color=#447700>!    See, e.g., eqns 1.3-1.5 in MM5 User's Guide.<a name='3002'></font>
<font color=#447700>!    Height is a function of pressure plus the constants:<a name='3003'></font>
<font color=#447700>!    p00  - sea level pressure (Pa)<a name='3004'></font>
<font color=#447700>!    t00  - sea level temperature (K)<a name='3005'></font>
<font color=#447700>!    a    - base state lapse rate (k/m)<a name='3006'></font>
<font color=#447700>!    r_d  - gas constant (J/Kg/K)   (Joule=1kg/m**2/s**2)<a name='3007'></font>
<font color=#447700>!    g    - gravitational constant (m/s**2)<a name='3008'></font>
<font color=#447700>!********************************************************<a name='3009'></font>
<a name='3010'>
  IMPLICIT NONE<a name='3011'>
<a name='3012'>
  REAL, INTENT(IN)     :: p_top        <font color=#447700>! pressure at top of model<a name='3013'></font>
  REAL, INTENT(IN)     :: p00          <font color=#447700>! base state pressure<a name='3014'></font>
  REAL, INTENT(IN)     :: t00          <font color=#447700>! base state temperature<a name='3015'></font>
  REAL, INTENT(IN)     :: a            <font color=#447700>! base state lapse rate<a name='3016'></font>
  REAL, INTENT(IN)     :: g                <font color=#447700>! gravity constant<a name='3017'></font>
  REAL, INTENT(IN)     :: r_d              <font color=#447700>! gas constant<a name='3018'></font>
  INTEGER, INTENT(IN)  :: k_start, k_end   <font color=#447700>! Loop bounds  <a name='3019'></font>
  INTEGER, INTENT(IN)  :: kds,kde          <font color=#447700>! vertical dim.<a name='3020'></font>
  INTEGER, INTENT(IN)  :: kms,kme          <font color=#447700>! vertical memory dim.<a name='3021'></font>
  REAL, INTENT(IN)  :: znu( kms:kme )      <font color=#447700>! eta values on half (mass) levels<a name='3022'></font>
  REAL, INTENT(OUT) :: z_at_p( kms:kme )   <font color=#447700>! column height at p levels<a name='3023'></font>
<a name='3024'>
<font color=#447700>! Local variables<a name='3025'></font>
  integer :: k             <font color=#447700>! loop counter<a name='3026'></font>
  real    :: ps0           <font color=#447700>! base state pressure at surface<a name='3027'></font>
  real    :: pb(kms:kme)   <font color=#447700>! pressure on half eta levels<a name='3028'></font>
  real    :: logterm       <font color=#447700>! temporary for Z calculation <a name='3029'></font>
  real    :: ginv          <font color=#447700>! 1/g<a name='3030'></font>
  <a name='3031'>
  ginv = 1/g<a name='3032'>
<a name='3033'>
<font color=#447700>! Compute base state pressure on half eta levels.<a name='3034'></font>
   do k = k_start, k_end<a name='3035'>
     pb(k) = znu(k)*(p00 - p_top) + p_top<a name='3036'>
   enddo<a name='3037'>
<a name='3038'>
<font color=#447700>! Use hydrostatic relation to compute height at pressure levels.<a name='3039'></font>
   do k = k_start, k_end<a name='3040'>
     logterm = log(pb(k)/p00)<a name='3041'>
     z_at_p(k) = .5*r_d*a*ginv*logterm*logterm - r_d*t00*ginv*logterm<a name='3042'>
   enddo<a name='3043'>
<a name='3044'>
  END SUBROUTINE get_base_state_height_column<a name='3045'>
<a name='3046'>
<A NAME='GET_TIMEWT'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#GET_TIMEWT' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3047'>
  REAL <font color=#993300>FUNCTION </font><font color=#cc0000>get_timewt</font>(xtime,dtmin,twindo,scalef,obtime) <A href='../../call_to/GET_TIMEWT.html' TARGET='index'>2</A><a name='3048'>
<font color=#447700>!*************************************************************************<a name='3049'></font>
<font color=#447700>! Purpose: Compute the temporal weight factor for an observation<a name='3050'></font>
<font color=#447700>!*************************************************************************<a name='3051'></font>
<a name='3052'>
  IMPLICIT NONE<a name='3053'>
<a name='3054'>
  REAL, INTENT(IN)  :: xtime              <font color=#447700>! model time (minutes)<a name='3055'></font>
  REAL, INTENT(IN)  :: dtmin              <font color=#447700>! model timestep (minutes)<a name='3056'></font>
  REAL, INTENT(IN)  :: twindo             <font color=#447700>! half window (hours)<a name='3057'></font>
  REAL, INTENT(IN)  :: scalef             <font color=#447700>! window scale factor<a name='3058'></font>
  REAL, INTENT(IN)  :: obtime             <font color=#447700>! observation time (hours)<a name='3059'></font>
<a name='3060'>
<font color=#447700>! Local variables<a name='3061'></font>
  real :: fdtim            <font color=#447700>! reference time (minutes)<a name='3062'></font>
  real :: tw1              <font color=#447700>! half of twindo, scaled, in minutes<a name='3063'></font>
  real :: tw2              <font color=#447700>! twindo, scaled, in minutes<a name='3064'></font>
  real :: tconst           <font color=#447700>! reciprical of tw1<a name='3065'></font>
  real :: ttim             <font color=#447700>! obtime in minutes<a name='3066'></font>
  real :: dift             <font color=#447700>! | fdtim-ttim |<a name='3067'></font>
  real :: timewt           <font color=#447700>! returned weight<a name='3068'></font>
<a name='3069'>
<font color=#447700>! DETERMINE THE TIME-WEIGHT FACTOR FOR N<a name='3070'></font>
  FDTIM=XTIME-DTMIN<a name='3071'>
<font color=#447700>! TWINDO IS IN MINUTES:<a name='3072'></font>
  TW1=TWINDO/2.*60.*scalef<a name='3073'>
  TW2=TWINDO*60.*scalef<a name='3074'>
  TCONST=1./TW1<a name='3075'>
  TIMEWT=0.0<a name='3076'>
  TTIM=obtime*60.<a name='3077'>
<font color=#447700>!***********TTIM=TARGET TIME IN MINUTES<a name='3078'></font>
  DIFT=ABS(FDTIM-TTIM)<a name='3079'>
  IF(DIFT.LE.TW1)TIMEWT=1.0<a name='3080'>
  IF(DIFT.GT.TW1.AND.DIFT.LE.TW2) THEN<a name='3081'>
     IF(FDTIM.LT.TTIM)TIMEWT=(FDTIM-(TTIM-TW2))*TCONST<a name='3082'>
     IF(FDTIM.GT.TTIM)TIMEWT=((TTIM+TW2)-FDTIM)*TCONST<a name='3083'>
  ENDIF<a name='3084'>
  get_timewt = timewt<a name='3085'>
  END FUNCTION get_timewt<a name='3086'>
<a name='3087'>
<A NAME='PRINT_VIF_VAR'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_VAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3088'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>print_vif_var</font>(var, vif, nfullmin, nrampmin ) <A href='../../call_to/PRINT_VIF_VAR.html' TARGET='index'>3</A>,<A href='../../call_from/PRINT_VIF_VAR.html' TARGET='index'>6</A><a name='3089'>
<font color=#447700>!********************************************************<a name='3090'></font>
<font color=#447700>! Purpose: Print a description of the vertical influence<a name='3091'></font>
<font color=#447700>!          function for a given variable.<a name='3092'></font>
<font color=#447700>!********************************************************<a name='3093'></font>
  IMPLICIT NONE<a name='3094'>
<a name='3095'>
  character(len=4), intent(in)  :: var      <font color=#447700>! Variable (wind, temp, mois)<a name='3096'></font>
  real,             intent(in)  :: vif(6)   <font color=#447700>! Vertical influence function<a name='3097'></font>
  real,             intent(in)  :: nfullmin <font color=#447700>! Vert infl fcn full nudge min<a name='3098'></font>
  real,             intent(in)  :: nrampmin <font color=#447700>! Vert infl fcn ramp decr min<a name='3099'></font>
<a name='3100'>
<font color=#447700>! Local variables<a name='3101'></font>
  character(len=200) :: msg1, msg2<a name='3102'>
  character(len=8) :: regime<a name='3103'>
  real :: nfullr1, nrampr1<a name='3104'>
  real :: nfullr2, nrampr2<a name='3105'>
  real :: nfullr4, nrampr4<a name='3106'>
<a name='3107'>
  nfullr1 = vif(1)<a name='3108'>
  nrampr1 = vif(2)<a name='3109'>
  nfullr2 = vif(3)<a name='3110'>
  nrampr2 = vif(4)<a name='3111'>
  nfullr4 = vif(5)<a name='3112'>
  nrampr4 = vif(6)<a name='3113'>
<a name='3114'>
  if(var.eq.'wind') then<a name='3115'>
    write(msg1,fmt='(a)') '  For winds:'<a name='3116'>
  elseif (var.eq.'temp') then<a name='3117'>
    write(msg1,fmt='(a)') '  For temperature:'<a name='3118'>
  elseif (var.eq.'mois') then<a name='3119'>
    write(msg1,fmt='(a)') '  For moisture:'<a name='3120'>
  else<a name='3121'>
    write(msg1,fmt='(a,a4)') 'Unknown variable type: ',var<a name='3122'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_VAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_795">(msg1)<a name='3123'>
    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_VAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_692"> ( 'print_vif_var: module_fddaobs_rtfdda STOP' )<a name='3124'>
  endif<a name='3125'>
      <a name='3126'>
  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_VAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_796">(msg1)<a name='3127'>
<a name='3128'>
<font color=#447700>! For this variable, print a description of the vif for each regime <a name='3129'></font>
  call <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_REGIME'>print_vif_regime</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_VAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PRINT_VIF_REGIME_1">(1, nfullr1, nrampr1, nfullmin, nrampmin) <a name='3130'>
  call <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_REGIME'>print_vif_regime</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_VAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PRINT_VIF_REGIME_2">(2, nfullr2, nrampr2, nfullmin, nrampmin) <a name='3131'>
  call <A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_REGIME'>print_vif_regime</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_VAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PRINT_VIF_REGIME_3">(4, nfullr4, nrampr4, nfullmin, nrampmin) <a name='3132'>
<a name='3133'>
  END SUBROUTINE print_vif_var<a name='3134'>
<a name='3135'>
<A NAME='PRINT_VIF_REGIME'><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_REGIME' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3136'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>print_vif_regime</font>(reg, nfullr, nrampr, nfullmin, nrampmin ) <A href='../../call_to/PRINT_VIF_REGIME.html' TARGET='index'>3</A>,<A href='../../call_from/PRINT_VIF_REGIME.html' TARGET='index'>3</A><a name='3137'>
<font color=#447700>!********************************************************<a name='3138'></font>
<font color=#447700>! Purpose: Print a description of the vertical influence<a name='3139'></font>
<font color=#447700>!          function for a given regime.<a name='3140'></font>
<font color=#447700>!********************************************************<a name='3141'></font>
  IMPLICIT NONE<a name='3142'>
<a name='3143'>
  integer, intent(in)  :: reg          <font color=#447700>! Regime number (1, 2, 4)<a name='3144'></font>
  real,    intent(in)  :: nfullr       <font color=#447700>! Full nudge range for regime<a name='3145'></font>
  real,    intent(in)  :: nrampr       <font color=#447700>! Rampdown range for regime<a name='3146'></font>
  real,    intent(in)  :: nfullmin     <font color=#447700>! Vert infl fcn full nudge min<a name='3147'></font>
  real,    intent(in)  :: nrampmin     <font color=#447700>! Vert infl fcn ramp decr min<a name='3148'></font>
<a name='3149'>
<font color=#447700>! Local variables<a name='3150'></font>
  character(len=200) :: msg1, msg2<a name='3151'>
  character(len=8) :: regime<a name='3152'>
<a name='3153'>
  if(reg.eq.1) then<a name='3154'>
     write(regime,fmt='(a)') 'Regime 1'<a name='3155'>
  elseif (reg.eq.2) then<a name='3156'>
     write(regime,fmt='(a)') 'Regime 2'<a name='3157'>
  elseif (reg.eq.4) then<a name='3158'>
     write(regime,fmt='(a)') 'Regime 4'<a name='3159'>
  else<a name='3160'>
     write(msg1,fmt='(a,i3)') 'Unknown regime number: ',reg<a name='3161'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_REGIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_797">(msg1)<a name='3162'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_REGIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_693"> ( 'print_vif_regime: module_fddaobs_rtfdda STOP' )<a name='3163'>
  endif<a name='3164'>
<a name='3165'>
<font color=#447700>!Set msg1 for description of full weighting range<a name='3166'></font>
  if(nfullr.lt.0) then<a name='3167'>
     if(nfullr.eq.-5000) then<a name='3168'>
       write(msg1,fmt='(2x,a8,a)') regime, ': Full weighting to the PBL top'<a name='3169'>
     elseif (nfullr.lt.-5000) then<a name='3170'>
       write(msg1,fmt='(2x,a8,a,i4,a)') regime, ': Full weighting to ',int(-5000.-nfullr), &amp;<a name='3171'>
                                          ' m above the PBL top'<a name='3172'>
     else<a name='3173'>
       write(msg1,fmt='(2x,a8,a,i4,a)') regime, ': Full weighting to ',int(nfullr+5000.),  &amp;<a name='3174'>
                                          ' m below the PBL top'<a name='3175'>
     endif<a name='3176'>
  else<a name='3177'>
     write(msg1,fmt='(2x,a8,a,i4,a)') regime, ': Full weighting through ',                 &amp;<a name='3178'>
                                     int(max(nfullr,nfullmin)),' m'<a name='3179'>
  endif<a name='3180'>
<a name='3181'>
<font color=#447700>!Set msg2 for description of rampdown range<a name='3182'></font>
  if(nrampr.lt.0) then<a name='3183'>
     if(nrampr.eq.-5000) then<a name='3184'>
       write(msg2,fmt='(a)') ' and a vertical rampdown up to the PBL top.'<a name='3185'>
     elseif (nrampr.lt.-5000) then<a name='3186'>
       write(msg2,fmt='(a,i4,a)') ' and a vertical rampdown to ',int(-5000.-nrampr),    &amp;<a name='3187'>
                            ' m above the PBL top.'<a name='3188'>
     else<a name='3189'>
       write(msg2,fmt='(a,i4,a)') ' and a vertical rampdown to ',int(nrampr+5000.),     &amp;<a name='3190'>
                            ' m below the PBL top.'<a name='3191'>
     endif<a name='3192'>
  else<a name='3193'>
     write(msg2,fmt='(a,i4,a)') ' and a vertical rampdown in the next ',                &amp;<a name='3194'>
                          int(max(nrampr,nrampmin)),' m.'<a name='3195'>
  endif<a name='3196'>
  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fddaobs_rtfdda.F.html#PRINT_VIF_REGIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_798">(TRIM(msg1)//msg2)<a name='3197'>
<a name='3198'>
  END SUBROUTINE print_vif_regime<a name='3199'>
#endif<a name='3200'>
<a name='3201'>
END MODULE module_fddaobs_rtfdda<a name='3202'>
<a name='3203'>
</pre></body></html>