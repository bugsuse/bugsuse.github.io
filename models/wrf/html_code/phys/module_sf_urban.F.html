<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_SF_URBAN'><A href='../../html_code/phys/module_sf_urban.F.html#MODULE_SF_URBAN' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sf_urban</font> <A href='../../call_to/MODULE_SF_URBAN.html' TARGET='index'>7</A><a name='3'>
<a name='4'>
<font color=#447700>!===============================================================================<a name='5'></font>
<font color=#447700>!     Single-Layer Urban Canopy Model for WRF Noah-LSM<a name='6'></font>
<font color=#447700>!     Original Version: 2002/11/06 by Hiroyuki Kusaka<a name='7'></font>
<font color=#447700>!     Last Update:      2006/08/24 by Fei Chen and Mukul Tewari (NCAR/RAL)  <a name='8'></font>
<font color=#447700>!===============================================================================<a name='9'></font>
<a name='10'>
   CHARACTER(LEN=4)                :: LU_DATA_TYPE<a name='11'>
<a name='12'>
   INTEGER                         :: ICATE<a name='13'>
<a name='14'>
   REAL, ALLOCATABLE, DIMENSION(:) :: ZR_TBL<a name='15'>
   REAL, ALLOCATABLE, DIMENSION(:) :: Z0C_TBL<a name='16'>
   REAL, ALLOCATABLE, DIMENSION(:) :: Z0HC_TBL<a name='17'>
   REAL, ALLOCATABLE, DIMENSION(:) :: ZDC_TBL<a name='18'>
   REAL, ALLOCATABLE, DIMENSION(:) :: SVF_TBL<a name='19'>
   REAL, ALLOCATABLE, DIMENSION(:) :: R_TBL<a name='20'>
   REAL, ALLOCATABLE, DIMENSION(:) :: RW_TBL<a name='21'>
   REAL, ALLOCATABLE, DIMENSION(:) :: HGT_TBL<a name='22'>
   REAL, ALLOCATABLE, DIMENSION(:) :: AH_TBL<a name='23'>
   REAL, ALLOCATABLE, DIMENSION(:) :: ALH_TBL<a name='24'>
   REAL, ALLOCATABLE, DIMENSION(:) :: BETR_TBL<a name='25'>
   REAL, ALLOCATABLE, DIMENSION(:) :: BETB_TBL<a name='26'>
   REAL, ALLOCATABLE, DIMENSION(:) :: BETG_TBL<a name='27'>
   REAL, ALLOCATABLE, DIMENSION(:) :: FRC_URB_TBL<a name='28'>
<a name='29'>
   REAL, ALLOCATABLE, DIMENSION(:) :: COP_TBL<a name='30'>
   REAL, ALLOCATABLE, DIMENSION(:) :: PWIN_TBL<a name='31'>
   REAL, ALLOCATABLE, DIMENSION(:) :: BETA_TBL<a name='32'>
   INTEGER, ALLOCATABLE, DIMENSION(:) :: SW_COND_TBL<a name='33'>
   REAL, ALLOCATABLE, DIMENSION(:) :: TIME_ON_TBL<a name='34'>
   REAL, ALLOCATABLE, DIMENSION(:) :: TIME_OFF_TBL<a name='35'>
   REAL, ALLOCATABLE, DIMENSION(:) :: TARGTEMP_TBL<a name='36'>
   REAL, ALLOCATABLE, DIMENSION(:) :: GAPTEMP_TBL<a name='37'>
   REAL, ALLOCATABLE, DIMENSION(:) :: TARGHUM_TBL<a name='38'>
   REAL, ALLOCATABLE, DIMENSION(:) :: GAPHUM_TBL<a name='39'>
   REAL, ALLOCATABLE, DIMENSION(:) :: PERFLO_TBL<a name='40'>
   REAL, ALLOCATABLE, DIMENSION(:) :: HSESF_TBL<a name='41'>
<a name='42'>
   REAL, ALLOCATABLE, DIMENSION(:) :: CAPR_TBL, CAPB_TBL, CAPG_TBL<a name='43'>
   REAL, ALLOCATABLE, DIMENSION(:) :: AKSR_TBL, AKSB_TBL, AKSG_TBL<a name='44'>
   REAL, ALLOCATABLE, DIMENSION(:) :: ALBR_TBL, ALBB_TBL, ALBG_TBL<a name='45'>
   REAL, ALLOCATABLE, DIMENSION(:) :: EPSR_TBL, EPSB_TBL, EPSG_TBL<a name='46'>
   REAL, ALLOCATABLE, DIMENSION(:) :: Z0R_TBL,  Z0B_TBL,  Z0G_TBL<a name='47'>
   REAL, ALLOCATABLE, DIMENSION(:) :: SIGMA_ZED_TBL<a name='48'>
   REAL, ALLOCATABLE, DIMENSION(:) :: Z0HB_TBL, Z0HG_TBL<a name='49'>
   REAL, ALLOCATABLE, DIMENSION(:) :: TRLEND_TBL, TBLEND_TBL, TGLEND_TBL<a name='50'>
   REAL, ALLOCATABLE, DIMENSION(:) :: AKANDA_URBAN_TBL<a name='51'>
<font color=#447700>!for BEP<a name='52'></font>
<a name='53'>
   <font color=#447700>! MAXDIRS :: The maximum number of street directions we're allowed to define<a name='54'></font>
   INTEGER, PARAMETER :: MAXDIRS = 3<a name='55'>
   <font color=#447700>! MAXHGTS :: The maximum number of building height bins we're allowed to define<a name='56'></font>
   INTEGER, PARAMETER :: MAXHGTS = 50<a name='57'>
<a name='58'>
   INTEGER, ALLOCATABLE, DIMENSION(:)   :: NUMDIR_TBL<a name='59'>
   REAL,    ALLOCATABLE, DIMENSION(:,:) :: STREET_DIRECTION_TBL<a name='60'>
   REAL,    ALLOCATABLE, DIMENSION(:,:) :: STREET_WIDTH_TBL<a name='61'>
   REAL,    ALLOCATABLE, DIMENSION(:,:) :: BUILDING_WIDTH_TBL<a name='62'>
   INTEGER, ALLOCATABLE, DIMENSION(:)   :: NUMHGT_TBL<a name='63'>
   REAL,    ALLOCATABLE, DIMENSION(:,:) :: HEIGHT_BIN_TBL<a name='64'>
   REAL,    ALLOCATABLE, DIMENSION(:,:) :: HPERCENT_BIN_TBL<a name='65'>
<font color=#447700>!end BEP<a name='66'></font>
   INTEGER                         :: BOUNDR_DATA,BOUNDB_DATA,BOUNDG_DATA<a name='67'>
   INTEGER                         :: CH_SCHEME_DATA, TS_SCHEME_DATA<a name='68'>
   INTEGER                         :: ahoption        <font color=#447700>! Miao, 2007/01/17, cal. ah<a name='69'></font>
   REAL, DIMENSION(1:24)           :: ahdiuprf        <font color=#447700>! ah diurnal profile, tloc: 1-24<a name='70'></font>
   REAL, DIMENSION(1:24)           :: hsequip_tbl<a name='71'>
<a name='72'>
<font color=#447700>!===Yang, 2014/10/08, urban hydrological processes for single layer UCM===<a name='73'></font>
   INTEGER                         :: IMP_SCHEME, IRI_SCHEME<a name='74'>
   INTEGER                         :: alhoption       <font color=#447700>! anthropogenic latent heat option<a name='75'></font>
   INTEGER                         :: groption        <font color=#447700>! anthropogenic latent heat option<a name='76'></font>
   REAL                            :: fgr             <font color=#447700>! green roof fraction<a name='77'></font>
   REAL                            :: oasis           <font color=#447700>! urban oasis parameter<a name='78'></font>
   REAL, DIMENSION(1:4)            :: DZGR            <font color=#447700>! Layer depth of green roof <a name='79'></font>
   REAL, DIMENSION(1:4)            :: alhseason       <font color=#447700>! seasonal variation of alh<a name='80'></font>
   REAL, DIMENSION(1:48)           :: alhdiuprf       <font color=#447700>! alh diurnal profile, tloc2: 1-48<a name='81'></font>
   REAL, DIMENSION(1:3)            :: porimp          <font color=#447700>! porosity of pavement over impervious surface<a name='82'></font>
   REAL, DIMENSION(1:3)            :: dengimp         <font color=#447700>! maximum water-holding depth of pavement<a name='83'></font>
<a name='84'>
<font color=#447700>!===end hydrological processes===<a name='85'></font>
   <a name='86'>
   INTEGER                         :: allocate_status <a name='87'>
<a name='88'>
<font color=#447700>!   INTEGER                         :: num_roof_layers<a name='89'></font>
<font color=#447700>!   INTEGER                         :: num_wall_layers<a name='90'></font>
<font color=#447700>!   INTEGER                         :: num_road_layers<a name='91'></font>
<a name='92'>
   CHARACTER (LEN=256) , PRIVATE   :: mesg<a name='93'>
<a name='94'>
   CONTAINS<a name='95'>
<a name='96'>
<font color=#447700>!===============================================================================<a name='97'></font>
<font color=#447700>!<a name='98'></font>
<font color=#447700>! Author:<a name='99'></font>
<font color=#447700>!      Hiroyuki KUSAKA, PhD<a name='100'></font>
<font color=#447700>!      University of Tsukuba, JAPAN<a name='101'></font>
<font color=#447700>!      (CRIEPI, NCAR/MMM visiting scientist, 2002-2004)<a name='102'></font>
<font color=#447700>!      kusaka@ccs.tsukuba.ac.jp<a name='103'></font>
<font color=#447700>!<a name='104'></font>
<font color=#447700>! Co-Researchers:<a name='105'></font>
<font color=#447700>!     Fei CHEN, PhD<a name='106'></font>
<font color=#447700>!      NCAR/RAP feichen@ucar.edu<a name='107'></font>
<font color=#447700>!     Mukul TEWARI, PhD<a name='108'></font>
<font color=#447700>!      NCAR/RAP mukul@ucar.edu<a name='109'></font>
<font color=#447700>!<a name='110'></font>
<font color=#447700>! Purpose:<a name='111'></font>
<font color=#447700>!     Calculate surface temeprature, fluxes, canopy air temperature, and canopy wind<a name='112'></font>
<font color=#447700>!<a name='113'></font>
<font color=#447700>! Subroutines:<a name='114'></font>
<font color=#447700>!     module_sf_urban<a name='115'></font>
<font color=#447700>!       |- urban<a name='116'></font>
<font color=#447700>!            |- read_param<a name='117'></font>
<font color=#447700>!            |- mos or jurges<a name='118'></font>
<font color=#447700>!            |- multi_layer or force_restore<a name='119'></font>
<font color=#447700>!       |- urban_param_init &lt;-- URBPARM.TBL<a name='120'></font>
<font color=#447700>!       |- urban_var_init<a name='121'></font>
<font color=#447700>!<a name='122'></font>
<font color=#447700>! Input Data from WRF [MKS unit]:<a name='123'></font>
<font color=#447700>!<a name='124'></font>
<font color=#447700>!     UTYPE  [-]     : Urban type. 1=Commercial/Industrial; 2=High-intensity residential; <a name='125'></font>
<font color=#447700>!                    : 3=low-intensity residential <a name='126'></font>
<font color=#447700>!     TA     [K]     : Potential temperature at 1st wrf level (absolute temp)<a name='127'></font>
<font color=#447700>!     QA     [kg/kg] : Mixing ratio at 1st atmospheric level<a name='128'></font>
<font color=#447700>!     UA     [m/s]   : Wind speed at 1st atmospheric level<a name='129'></font>
<font color=#447700>!     SSG    [W/m/m] : Short wave downward radiation at a flat surface<a name='130'></font>
<font color=#447700>!                      Note this is the total of direct and diffusive solar<a name='131'></font>
<font color=#447700>!                      downward radiation. If without two components, the<a name='132'></font>
<font color=#447700>!                      single solar downward can be used instead.<a name='133'></font>
<font color=#447700>!                      SSG = SSGD + SSGQ<a name='134'></font>
<font color=#447700>!     LSOLAR [-]     : Indicating the input type of solar downward radiation<a name='135'></font>
<font color=#447700>!                      True: both direct and diffusive solar radiation <a name='136'></font>
<font color=#447700>!                      are available<a name='137'></font>
<font color=#447700>!                      False: only total downward ridiation is available.<a name='138'></font>
<font color=#447700>!     SSGD   [W/m/m] : Direct solar radiation at a flat surface<a name='139'></font>
<font color=#447700>!                      if SSGD is not available, one can assume a ratio SRATIO<a name='140'></font>
<font color=#447700>!                      (e.g., 0.7), so that SSGD = SRATIO*SSG <a name='141'></font>
<font color=#447700>!     SSGQ   [W/m/m] : Diffuse solar radiation at a flat surface<a name='142'></font>
<font color=#447700>!                      If SSGQ is not available, SSGQ = SSG - SSGD<a name='143'></font>
<font color=#447700>!     LLG    [W/m/m] : Long wave downward radiation at a flat surface <a name='144'></font>
<font color=#447700>!     RAIN   [mm/h]  : Precipitation<a name='145'></font>
<font color=#447700>!     RHOO   [kg/m/m/m] : Air density<a name='146'></font>
<font color=#447700>!     ZA     [m]     : First atmospheric level<a name='147'></font>
<font color=#447700>!                      as a lowest boundary condition<a name='148'></font>
<font color=#447700>!     DECLIN [rad]   : solar declination<a name='149'></font>
<font color=#447700>!     COSZ           : = sin(fai)*sin(del)+cos(fai)*cos(del)*cos(omg)<a name='150'></font>
<font color=#447700>!     OMG    [rad]   : solar hour angle<a name='151'></font>
<font color=#447700>!     XLAT   [deg]   : latitude<a name='152'></font>
<font color=#447700>!     DELT   [sec]   : Time step<a name='153'></font>
<font color=#447700>!     ZNT    [m]     : Roughnes length<a name='154'></font>
<font color=#447700>!<a name='155'></font>
<font color=#447700>! Output Data to WRF [MKS unit]:<a name='156'></font>
<font color=#447700>!<a name='157'></font>
<font color=#447700>!     TS  [K]            : Surface potential temperature (absolute temp)<a name='158'></font>
<font color=#447700>!     QS  [-]            : Surface humidity<a name='159'></font>
<font color=#447700>!<a name='160'></font>
<font color=#447700>!     SH  [W/m/m/]       : Sensible heat flux, = FLXTH*RHOO*CPP<a name='161'></font>
<font color=#447700>!     LH  [W/m/m]        : Latent heat flux, = FLXHUM*RHOO*ELL<a name='162'></font>
<font color=#447700>!     LH_INEMATIC [kg/m/m/sec]: Moisture Kinematic flux, = FLXHUM*RHOO<a name='163'></font>
<font color=#447700>!     SW  [W/m/m]        : Upward shortwave radiation flux, <a name='164'></font>
<font color=#447700>!                          = SSG-SNET*697.7*60. (697.7*60.=100.*100.*4.186)<a name='165'></font>
<font color=#447700>!     ALB [-]            : Time-varying albedo<a name='166'></font>
<font color=#447700>!     LW  [W/m/m]        : Upward longwave radiation flux, <a name='167'></font>
<font color=#447700>!                          = LNET*697.7*60.-LLG<a name='168'></font>
<font color=#447700>!     G   [W/m/m]        : Heat Flux into the Ground<a name='169'></font>
<font color=#447700>!     RN  [W/m/m]        : Net radiation<a name='170'></font>
<font color=#447700>!<a name='171'></font>
<font color=#447700>!     PSIM  [-]          : Diagnostic similarity stability function for momentum<a name='172'></font>
<font color=#447700>!     PSIH  [-]          : Diagnostic similarity stability function for heat<a name='173'></font>
<font color=#447700>!<a name='174'></font>
<font color=#447700>!     TC  [K]            : Diagnostic canopy air temperature<a name='175'></font>
<font color=#447700>!     QC  [-]            : Diagnostic canopy humidity<a name='176'></font>
<font color=#447700>!<a name='177'></font>
<font color=#447700>!     TH2 [K]            : Diagnostic potential temperature at 2 m<a name='178'></font>
<font color=#447700>!     Q2  [-]            : Diagnostic humidity at 2 m<a name='179'></font>
<font color=#447700>!     U10 [m/s]          : Diagnostic u wind component at 10 m<a name='180'></font>
<font color=#447700>!     V10 [m/s]          : Diagnostic v wind component at 10 m<a name='181'></font>
<font color=#447700>!<a name='182'></font>
<font color=#447700>!     CHS, CHS2 [m/s]    : CH*U at ZA, CH*U at 2 m (not used)<a name='183'></font>
<font color=#447700>!<a name='184'></font>
<font color=#447700>! Important parameters:<a name='185'></font>
<font color=#447700>!<a name='186'></font>
<font color=#447700>! Morphology of the urban canyon:<a name='187'></font>
<font color=#447700>! These parameters assigned in the URBPARM.TBL<a name='188'></font>
<font color=#447700>!<a name='189'></font>
<font color=#447700>!    ZR  [m]             : roof level (building height)<a name='190'></font>
<font color=#447700>!    SIGMA_ZED [m]       : Standard Deviation of roof height<a name='191'></font>
<font color=#447700>!    ROOF_WIDTH [m]      : roof (i.e., building) width<a name='192'></font>
<font color=#447700>!    ROAD_WIDTH [m]      : road width<a name='193'></font>
<font color=#447700>!<a name='194'></font>
<font color=#447700>! Parameters derived from the morphological terms above.<a name='195'></font>
<font color=#447700>! These parameters are computed in the code.<a name='196'></font>
<font color=#447700>!<a name='197'></font>
<font color=#447700>!    HGT [-]             : normalized building height<a name='198'></font>
<font color=#447700>!    SVF [-]             : sky view factor<a name='199'></font>
<font color=#447700>!    R   [-]             : Normalized roof width (a.k.a. "building coverage ratio")<a name='200'></font>
<font color=#447700>!    RW  [-]             : = 1 - R<a name='201'></font>
<font color=#447700>!    Z0C [m]             : Roughness length above canyon for momentum (1/10 of ZR)<a name='202'></font>
<font color=#447700>!    Z0HC [m]            : Roughness length above canyon for heat (1/10 of Z0C)<a name='203'></font>
<font color=#447700>!    ZDC [m]             : Zero plane displacement height (1/5 of ZR)<a name='204'></font>
<font color=#447700>!<a name='205'></font>
<font color=#447700>! Following parameter are assigned in run/URBPARM.TBL<a name='206'></font>
<font color=#447700>!<a name='207'></font>
<font color=#447700>!  AH  [ W m{-2} ]        : anthropogenic heat  ( W m{-2} in the table, converted internally to cal cm{-2} )<a name='208'></font>
<font color=#447700>!  ALH [ W m{-2} ]        : anthropogenic latent heat  ( W m{-2} in the table, converted internally to cal cm{-2} )<a name='209'></font>
<font color=#447700>!  CAPR[ J m{-3} K{-1} ]  : heat capacity of roof ( units converted in code to [ cal cm{-3} deg{-1} ] )<a name='210'></font>
<font color=#447700>!  CAPB[ J m{-3} K{-1} ]  : heat capacity of building wall ( units converted in code to [ cal cm{-3} deg{-1} ] )<a name='211'></font>
<font color=#447700>!  CAPG[ J m{-3} K{-1} ]  : heat capacity of road ( units converted in code to [ cal cm{-3} deg{-1} ] )<a name='212'></font>
<font color=#447700>!  AKSR [ J m{-1} s{-1} K{-1} ] : thermal conductivity of roof ( units converted in code to [ cal cm{-1} s{-1} deg{-1} ] )<a name='213'></font>
<font color=#447700>!  AKSB [ J m{-1} s{-1} K{-1} ] : thermal conductivity of building wall ( units converted in code to [ cal cm{-1} s{-1} deg{-1} ] )<a name='214'></font>
<font color=#447700>!  AKSG [ J m{-1} s{-1} K{-1} ] : thermal conductivity of road ( units converted in code to [ cal cm{-1} s{-1} deg{-1} ] )<a name='215'></font>
<font color=#447700>!  ALBR [-]               : surface albedo of roof<a name='216'></font>
<font color=#447700>!  ALBB [-]               : surface albedo of building wall<a name='217'></font>
<font color=#447700>!  ALBG [-]               : surface albedo of road<a name='218'></font>
<font color=#447700>!  EPSR [-]               : surface emissivity of roof<a name='219'></font>
<font color=#447700>!  EPSB [-]               : surface emissivity of building wall<a name='220'></font>
<font color=#447700>!  EPSG [-]               : surface emissivity of road<a name='221'></font>
<font color=#447700>!  Z0B [m]                : roughness length for momentum of building wall (only for CH_SCHEME = 1)<a name='222'></font>
<font color=#447700>!  Z0G [m]                : roughness length for momentum of road (only for CH_SCHEME = 1)<a name='223'></font>
<font color=#447700>!  Z0HB [m]               : roughness length for heat of building wall (only for CH_SCHEME = 1)<a name='224'></font>
<font color=#447700>!  Z0HG [m]               : roughness length for heat of road<a name='225'></font>
<font color=#447700>!  num_roof_layers        : number of layers within roof<a name='226'></font>
<font color=#447700>!  num_wall_layers        : number of layers within building walls<a name='227'></font>
<font color=#447700>!  num_road_layers        : number of layers within below road surface<a name='228'></font>
<font color=#447700>!   NOTE: for now, these layers are defined as same as the number of soil layers in namelist.input<a name='229'></font>
<font color=#447700>!  DZR [cm]               : thickness of each roof layer<a name='230'></font>
<font color=#447700>!  DZB [cm]               : thickness of each building wall layer<a name='231'></font>
<font color=#447700>!  DZG [cm]               : thickness of each ground layer<a name='232'></font>
<font color=#447700>!  BOUNDR [integer 1 or 2] : Boundary Condition for Roof Layer Temp [1: Zero-Flux, 2: T = Constant]<a name='233'></font>
<font color=#447700>!  BOUNDB [integer 1 or 2] : Boundary Condition for Building Wall Layer Temp [1: Zero-Flux, 2: T = Constant]<a name='234'></font>
<font color=#447700>!  BOUNDG [integer 1 or 2] : Boundary Condition for Road Layer Temp [1: Zero-Flux, 2: T = Constant]<a name='235'></font>
<font color=#447700>!  TRLEND [K]             : lower boundary condition of roof temperature<a name='236'></font>
<font color=#447700>!  TBLEND [K]             : lower boundary condition of building temperature<a name='237'></font>
<font color=#447700>!  TGLEND [K]             : lower boundary condition of ground temperature<a name='238'></font>
<font color=#447700>!  CH_SCHEME [integer 1 or 2] : Sfc exchange scheme used for building wall and road<a name='239'></font>
<font color=#447700>!                         [1: M-O Similarity Theory,  2: Empirical Form (recommend)]<a name='240'></font>
<font color=#447700>!  TS_SCHEME [integer 1 or 2] : Scheme for computing surface temperature (for roof, wall, and road)<a name='241'></font>
<font color=#447700>!                         [1: 4-layer model,  2: Force-Restore method]<a name='242'></font>
<font color=#447700>!  IMP_SCHEME[integer 1 or 2] : Evaporation scheme for impervious surfaces (roof, wall, and road)<a name='243'></font>
<font color=#447700>!                         [1: Hypothesized evaporation during large rainfall events<a name='244'></font>
<font color=#447700>!                         [2: Water-holding scheme over impervious surface<a name='245'></font>
<font color=#447700>!  IRI_SCHEME[integer 0 or 1] : Scheme for urban irrigation<a name='246'></font>
<font color=#447700>!                         [0: No irrigation,  1: Summertime (May-Sep) irrigation everyday at 9pm]<a name='247'></font>
<font color=#447700>!for BEP<a name='248'></font>
<font color=#447700>!  numdir [ - ]             : Number of street directions defined for a particular urban category<a name='249'></font>
<font color=#447700>!  street_direction [ deg ] : Direction of streets for a particular urban category and a particular street direction<a name='250'></font>
<font color=#447700>!  street_width [ m ]       : Width of street for a particular urban category and a particular street direction<a name='251'></font>
<font color=#447700>!  building_width [ m ]     : Width of buildings for a particular urban category and a particular street direction<a name='252'></font>
<font color=#447700>!  numhgt [ - ]             : Number of building height levels defined for a particular urban category<a name='253'></font>
<font color=#447700>!  height_bin [ m ]         : Building height bins defined for a particular urban category.<a name='254'></font>
<font color=#447700>!  hpercent_bin [ % ]       : Percentage of a particular urban category populated by buildings of particular height bins<a name='255'></font>
<font color=#447700>!end BEP<a name='256'></font>
<font color=#447700>! Moved from URBPARM.TBL<a name='257'></font>
<font color=#447700>!<a name='258'></font>
<font color=#447700>!  BETR [-]            : minimum moisture availability of roof<a name='259'></font>
<font color=#447700>!  BETB [-]            : minimum moisture availability of building wall<a name='260'></font>
<font color=#447700>!  BETG [-]            : minimum moisture availability of road<a name='261'></font>
<font color=#447700>!  Z0R [m]                : roughness length for momentum of roof<a name='262'></font>
<font color=#447700>!  Z0HB [m]               : roughness length for heat of building wall (only for CH_SCHEME = 1)<a name='263'></font>
<font color=#447700>!  Z0HG [m]               : roughness length for heat of road<a name='264'></font>
<font color=#447700>!  num_roof_layers        : number of layers within roof<a name='265'></font>
<font color=#447700>!  num_wall_layers        : number of layers within building walls<a name='266'></font>
<font color=#447700>!  num_road_layers        : number of layers within below road surface<a name='267'></font>
<font color=#447700>!   NOTE: for now, these layers are defined as same as the number of soil layers in namelist.input<a name='268'></font>
<font color=#447700>!<a name='269'></font>
<font color=#447700>! References:<a name='270'></font>
<font color=#447700>!     Kusaka and Kimura (2004) J.Appl.Meteor., vol.43, p1899-1910<a name='271'></font>
<font color=#447700>!     Kusaka and Kimura (2004) J.Meteor.Soc.Japan, vol.82, p45-65<a name='272'></font>
<font color=#447700>!     Kusaka et al. (2001) Bound.-Layer Meteor., vol.101, p329-358<a name='273'></font>
<font color=#447700>!<a name='274'></font>
<font color=#447700>! History:<a name='275'></font>
<font color=#447700>!     2014/10,         modified by Jiachuan Yang (ASU)<a name='276'></font>
<font color=#447700>!     2006/06          modified by H. Kusaka (Univ. Tsukuba), M. Tewari <a name='277'></font>
<font color=#447700>!     2005/10/26,      modified by Fei Chen, Mukul Tewari<a name='278'></font>
<font color=#447700>!     2003/07/21 WRF , modified  by H. Kusaka of CRIEPI (NCAR/MMM)<a name='279'></font>
<font color=#447700>!     2001/08/26 PhD , modified  by H. Kusaka of CRIEPI (Univ.Tsukuba)<a name='280'></font>
<font color=#447700>!     1999/08/25 LCM , developed by H. Kusaka of CRIEPI (Univ.Tsukuba)<a name='281'></font>
<font color=#447700>!<a name='282'></font>
<font color=#447700>!===============================================================================<a name='283'></font>
<font color=#447700>!<a name='284'></font>
<font color=#447700>!  subroutine urban:<a name='285'></font>
<font color=#447700>!<a name='286'></font>
<font color=#447700>!===============================================================================<a name='287'></font>
<a name='288'>
<A NAME='URBAN'><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='289'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>urban</font>(LSOLAR,                                           &amp; <font color=#447700>! L <A href='../../call_to/URBAN.html' TARGET='index'>5</A>,<A href='../../call_from/URBAN.html' TARGET='index'>31</A><a name='290'></font>
                    num_roof_layers,num_wall_layers,num_road_layers,  &amp; <font color=#447700>! I<a name='291'></font>
                    DZR,DZB,DZG,                                      &amp; <font color=#447700>! I<a name='292'></font>
                    UTYPE,TA,QA,UA,U1,V1,SSG,SSGD,SSGQ,LLG,RAIN,RHOO, &amp; <font color=#447700>! I<a name='293'></font>
                    ZA,DECLIN,COSZ,OMG,XLAT,DELT,ZNT,                 &amp; <font color=#447700>! I<a name='294'></font>
                    CHS, CHS2,                                        &amp; <font color=#447700>! I<a name='295'></font>
                    TR, TB, TG, TC, QC, UC,                           &amp; <font color=#447700>! H<a name='296'></font>
                    TRL,TBL,TGL,                                      &amp; <font color=#447700>! H<a name='297'></font>
                    XXXR, XXXB, XXXG, XXXC,                           &amp; <font color=#447700>! H<a name='298'></font>
                    TS,QS,SH,LH,LH_KINEMATIC,                         &amp; <font color=#447700>! O<a name='299'></font>
                    SW,ALB,LW,G,RN,PSIM,PSIH,                         &amp; <font color=#447700>! O<a name='300'></font>
                    GZ1OZ0,                                           &amp; <font color=#447700>! O<a name='301'></font>
                    CMR_URB,CHR_URB,CMC_URB,CHC_URB,                  &amp; <font color=#447700>! I/O<a name='302'></font>
                    U10,V10,TH2,Q2,UST,mh_urb,stdh_urb,lf_urb,        &amp; <font color=#447700>! O <a name='303'></font>
                    lp_urb,hgt_urb,frc_urb,lb_urb,zo_check,           &amp; <font color=#447700>! O<a name='304'></font>
                    CMCR,TGR,TGRL,SMR,CMGR_URB,CHGR_URB,jmonth,       &amp; <font color=#447700>! H<a name='305'></font>
                    DRELR,DRELB,DRELG,FLXHUMR,FLXHUMB,FLXHUMG)<a name='306'>
<a name='307'>
   IMPLICIT NONE<a name='308'>
<a name='309'>
   REAL, PARAMETER    :: CP=0.24          <font color=#447700>! heat capacity of dry air  [cgs unit]<a name='310'></font>
   REAL, PARAMETER    :: EL=583.          <font color=#447700>! latent heat of vaporation [cgs unit]<a name='311'></font>
   REAL, PARAMETER    :: SIG=8.17E-11     <font color=#447700>! stefun bolzman constant   [cgs unit]<a name='312'></font>
   REAL, PARAMETER    :: SIG_SI=5.67E-8   <font color=#447700>!                           [MKS unit]<a name='313'></font>
   REAL, PARAMETER    :: AK=0.4           <font color=#447700>! kalman const.                [-]<a name='314'></font>
   REAL, PARAMETER    :: PI=3.14159       <font color=#447700>! pi                           [-]<a name='315'></font>
   REAL, PARAMETER    :: TETENA=7.5       <font color=#447700>! const. of Tetens Equation    [-]<a name='316'></font>
   REAL, PARAMETER    :: TETENB=237.3     <font color=#447700>! const. of Tetens Equation    [-]<a name='317'></font>
   REAL, PARAMETER    :: SRATIO=0.75      <font color=#447700>! ratio between direct/total solar [-]<a name='318'></font>
<a name='319'>
   REAL, PARAMETER    :: CPP=1004.5       <font color=#447700>! heat capacity of dry air    [J/K/kg]<a name='320'></font>
   REAL, PARAMETER    :: ELL=2.442E+06    <font color=#447700>! latent heat of vaporization [J/kg]<a name='321'></font>
   REAL, PARAMETER    :: XKA=2.4E-5<a name='322'>
<a name='323'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='324'></font>
<font color=#447700>! C: configuration variables<a name='325'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='326'></font>
<a name='327'>
   LOGICAL, INTENT(IN) :: LSOLAR  <font color=#447700>! logical    [true=both, false=SSG only]<a name='328'></font>
<a name='329'>
<font color=#447700>!  The following variables are also model configuration variables, but are <a name='330'></font>
<font color=#447700>!  defined in the URBAN.TBL and in the contains statement in the top of <a name='331'></font>
<font color=#447700>!  the module_urban_init, so we should not declare them here.<a name='332'></font>
<a name='333'>
  INTEGER, INTENT(IN) :: num_roof_layers<a name='334'>
  INTEGER, INTENT(IN) :: num_wall_layers<a name='335'>
  INTEGER, INTENT(IN) :: num_road_layers<a name='336'>
<a name='337'>
<a name='338'>
  REAL, INTENT(IN), DIMENSION(1:num_roof_layers) :: DZR <font color=#447700>! grid interval of roof layers [cm]<a name='339'></font>
  REAL, INTENT(IN), DIMENSION(1:num_wall_layers) :: DZB <font color=#447700>! grid interval of wall layers [cm]<a name='340'></font>
  REAL, INTENT(IN), DIMENSION(1:num_road_layers) :: DZG <font color=#447700>! grid interval of road layers [cm]<a name='341'></font>
<a name='342'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='343'></font>
<font color=#447700>! I: input variables from LSM to Urban<a name='344'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='345'></font>
<a name='346'>
   INTEGER, INTENT(IN) :: UTYPE <font color=#447700>! urban type [1=Commercial/Industrial, 2=High-intensity residential, <a name='347'></font>
                                <font color=#447700>! 3=low-intensity residential]<a name='348'></font>
   INTEGER, INTENT(IN) :: jmonth<font color=#447700>! current month <a name='349'></font>
   REAL, INTENT(IN)    :: TA   <font color=#447700>! potential temp at 1st atmospheric level [K]<a name='350'></font>
   REAL, INTENT(IN)    :: QA   <font color=#447700>! mixing ratio at 1st atmospheric level  [kg/kg]<a name='351'></font>
   REAL, INTENT(IN)    :: UA   <font color=#447700>! wind speed at 1st atmospheric level    [m/s]<a name='352'></font>
   REAL, INTENT(IN)    :: U1   <font color=#447700>! u at 1st atmospheric level             [m/s]<a name='353'></font>
   REAL, INTENT(IN)    :: V1   <font color=#447700>! v at 1st atmospheric level             [m/s]<a name='354'></font>
   REAL, INTENT(IN)    :: SSG  <font color=#447700>! downward total short wave radiation    [W/m/m]<a name='355'></font>
   REAL, INTENT(IN)    :: LLG  <font color=#447700>! downward long wave radiation           [W/m/m]<a name='356'></font>
   REAL, INTENT(IN)    :: RAIN <font color=#447700>! precipitation                          [mm/h]<a name='357'></font>
   REAL, INTENT(IN)    :: RHOO <font color=#447700>! air density                            [kg/m^3]<a name='358'></font>
   REAL, INTENT(IN)    :: ZA   <font color=#447700>! first atmospheric level                [m]<a name='359'></font>
   REAL, INTENT(IN)    :: DECLIN <font color=#447700>! solar declination                    [rad]<a name='360'></font>
   REAL, INTENT(IN)    :: COSZ <font color=#447700>! sin(fai)*sin(del)+cos(fai)*cos(del)*cos(omg)<a name='361'></font>
   REAL, INTENT(IN)    :: OMG  <font color=#447700>! solar hour angle                       [rad]<a name='362'></font>
<a name='363'>
   REAL, INTENT(IN)    :: XLAT <font color=#447700>! latitude                               [deg]<a name='364'></font>
   REAL, INTENT(IN)    :: DELT <font color=#447700>! time step                              [s]<a name='365'></font>
   REAL, INTENT(IN)    :: CHS,CHS2 <font color=#447700>! CH*U at za and 2 m             [m/s]<a name='366'></font>
<a name='367'>
   REAL, INTENT(INOUT) :: SSGD <font color=#447700>! downward direct short wave radiation   [W/m/m]<a name='368'></font>
   REAL, INTENT(INOUT) :: SSGQ <font color=#447700>! downward diffuse short wave radiation  [W/m/m]<a name='369'></font>
   REAL, INTENT(INOUT) :: CMR_URB<a name='370'>
   REAL, INTENT(INOUT) :: CHR_URB<a name='371'>
   REAL, INTENT(INOUT) :: CMC_URB<a name='372'>
   REAL, INTENT(INOUT) :: CHC_URB<a name='373'>
   REAL, INTENT(INOUT) :: ZNT  <font color=#447700>! roughness length                       [m]    ! modified by danli<a name='374'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='375'></font>
<font color=#447700>! I: NUDAPT Input Parameters<a name='376'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='377'></font>
   REAL, INTENT(INOUT) :: mh_urb   <font color=#447700>! mean building height [m]<a name='378'></font>
   REAL, INTENT(INOUT) :: stdh_urb <font color=#447700>! standard deviation of building height [m]<a name='379'></font>
   REAL, INTENT(INOUT) :: hgt_urb  <font color=#447700>! area weighted mean building height [m] <a name='380'></font>
   REAL, INTENT(INOUT) :: lp_urb   <font color=#447700>! plan area fraction [-]<a name='381'></font>
   REAL, INTENT(INOUT) :: frc_urb  <font color=#447700>! urban fraction [-]<a name='382'></font>
   REAL, INTENT(INOUT) :: lb_urb   <font color=#447700>! building surface to plan area ratio [-]<a name='383'></font>
   REAL, INTENT(INOUT), DIMENSION(4) :: lf_urb   <font color=#447700>! frontal area index [-]<a name='384'></font>
   REAL, INTENT(INOUT) :: zo_check  <font color=#447700>! check for printing ZOC<a name='385'></font>
<a name='386'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='387'></font>
<font color=#447700>! O: output variables from Urban to LSM <a name='388'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='389'></font>
<a name='390'>
   REAL, INTENT(OUT) :: TS     <font color=#447700>! surface potential temperature    [K]<a name='391'></font>
   REAL, INTENT(OUT) :: QS     <font color=#447700>! surface humidity                 [K]<a name='392'></font>
   REAL, INTENT(OUT) :: SH     <font color=#447700>! sensible heat flux               [W/m/m]<a name='393'></font>
   REAL, INTENT(OUT) :: LH     <font color=#447700>! latent heat flux                 [W/m/m]<a name='394'></font>
   REAL, INTENT(OUT) :: LH_KINEMATIC <font color=#447700>! latent heat, kinetic     [kg/m/m/s]<a name='395'></font>
   REAL, INTENT(OUT) :: SW     <font color=#447700>! upward short wave radiation flux [W/m/m]<a name='396'></font>
   REAL, INTENT(OUT) :: ALB    <font color=#447700>! time-varying albedo            [fraction]<a name='397'></font>
   REAL, INTENT(OUT) :: LW     <font color=#447700>! upward long wave radiation flux  [W/m/m]<a name='398'></font>
   REAL, INTENT(OUT) :: G      <font color=#447700>! heat flux into the ground        [W/m/m]<a name='399'></font>
   REAL, INTENT(OUT) :: RN     <font color=#447700>! net radition                     [W/m/m]<a name='400'></font>
   REAL, INTENT(OUT) :: PSIM   <font color=#447700>! similality stability shear function for momentum<a name='401'></font>
   REAL, INTENT(OUT) :: PSIH   <font color=#447700>! similality stability shear function for heat<a name='402'></font>
   REAL, INTENT(OUT) :: GZ1OZ0   <a name='403'>
   REAL, INTENT(OUT) :: U10    <font color=#447700>! u at 10m                         [m/s]<a name='404'></font>
   REAL, INTENT(OUT) :: V10    <font color=#447700>! u at 10m                         [m/s]<a name='405'></font>
   REAL, INTENT(OUT) :: TH2    <font color=#447700>! potential temperature at 2 m     [K]<a name='406'></font>
   REAL, INTENT(OUT) :: Q2     <font color=#447700>! humidity at 2 m                  [-]<a name='407'></font>
<font color=#447700>!m   REAL, INTENT(OUT) :: CHS,CHS2 ! CH*U at za and 2 m             [m/s]<a name='408'></font>
   REAL, INTENT(OUT) :: UST    <font color=#447700>! friction velocity                [m/s]<a name='409'></font>
<a name='410'>
<a name='411'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='412'></font>
<font color=#447700>! H: Historical (state) variables of Urban : LSM &lt;--&gt; Urban<a name='413'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='414'></font>
<a name='415'>
<font color=#447700>! TR: roof temperature              [K];      TRP: at previous time step [K]<a name='416'></font>
<font color=#447700>! TB: building wall temperature     [K];      TBP: at previous time step [K]<a name='417'></font>
<font color=#447700>! TG: road temperature              [K];      TGP: at previous time step [K]<a name='418'></font>
<font color=#447700>! TC: urban-canopy air temperature  [K];      TCP: at previous time step [K]<a name='419'></font>
<font color=#447700>!                                                  (absolute temperature)<a name='420'></font>
<font color=#447700>! QC: urban-canopy air mixing ratio [kg/kg];  QCP: at previous time step [kg/kg]<a name='421'></font>
<font color=#447700>!<a name='422'></font>
<font color=#447700>! XXXR: Monin-Obkhov length for roof          [dimensionless]<a name='423'></font>
<font color=#447700>! XXXB: Monin-Obkhov length for building wall [dimensionless]<a name='424'></font>
<font color=#447700>! XXXG: Monin-Obkhov length for road          [dimensionless]<a name='425'></font>
<font color=#447700>! XXXC: Monin-Obkhov length for urban-canopy  [dimensionless]<a name='426'></font>
<font color=#447700>!<a name='427'></font>
<font color=#447700>! TRL, TBL, TGL: layer temperature [K] (absolute temperature)<a name='428'></font>
<a name='429'>
   REAL, INTENT(INOUT):: TR, TB, TG, TC, QC, UC<a name='430'>
   REAL, INTENT(INOUT):: XXXR, XXXB, XXXG, XXXC<a name='431'>
<a name='432'>
   REAL, DIMENSION(1:num_roof_layers), INTENT(INOUT) :: TRL<a name='433'>
   REAL, DIMENSION(1:num_wall_layers), INTENT(INOUT) :: TBL<a name='434'>
   REAL, DIMENSION(1:num_road_layers), INTENT(INOUT) :: TGL<a name='435'>
<a name='436'>
<font color=#447700>!===Yang,2014/10/08, urban hydrological variables for single layer UCM===<a name='437'></font>
<font color=#447700>! FLXHUMR: evaporation over roof  [m/s];     FLXHUMRP: at previous time step [m/s]<a name='438'></font>
<font color=#447700>! FLXHUMB: evaporation over wall  [m/s];     FLXHUMBP: at previous time step [m/s]<a name='439'></font>
<font color=#447700>! FLXHUMG: evaporation over road  [m/s];     FLXHUMGP: at previous time step [m/s]<a name='440'></font>
<a name='441'>
<font color=#447700>! DRELR: water retention depth on roof [m];  DRELRP: at previous time stp [m] <a name='442'></font>
<font color=#447700>! DRELB: water retention depth on wall [m];  DRELBP: at previous time stp [m] <a name='443'></font>
<font color=#447700>! DRELG: water retention depth on road [m];  DRELGP: at previous time stp [m]<a name='444'></font>
  <a name='445'>
<font color=#447700>! TGR: green roof surface temperature  [K];      TGRP: at previous time step [K]<a name='446'></font>
<font color=#447700>! CMCR: Canopy intercepted water on green roof;  CMCRP: at previous time step<a name='447'></font>
<font color=#447700>! SMR: soil moisture at each layer on roof [-];  SMRP: at previous time step<a name='448'></font>
<font color=#447700>! TGRL:layer temperature on green roof [K]<a name='449'></font>
  <a name='450'>
   REAL, INTENT(INOUT):: FLXHUMR,FLXHUMB,FLXHUMG,DRELR,DRELB,DRELG<a name='451'>
   REAL, INTENT(INOUT):: TGR,CMCR,CHGR_URB,CMGR_URB<a name='452'>
   REAL, DIMENSION(1:num_roof_layers), INTENT(INOUT) :: SMR        <a name='453'>
   REAL, DIMENSION(1:num_roof_layers), INTENT(INOUT) :: TGRL<a name='454'>
<a name='455'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='456'></font>
<font color=#447700>! L:  Local variables from read_param<a name='457'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='458'></font>
<a name='459'>
   REAL :: ZR, Z0C, Z0HC, ZDC, SVF, R, RW, HGT, AH, ALH<a name='460'>
   REAL :: SIGMA_ZED<a name='461'>
   REAL :: CAPR, CAPB, CAPG, AKSR, AKSB, AKSG, ALBR, ALBB, ALBG <a name='462'>
   REAL :: EPSR, EPSB, EPSG, Z0R,  Z0B,  Z0G,  Z0HB, Z0HG<a name='463'>
   REAL :: TRLEND,TBLEND,TGLEND<a name='464'>
   REAL :: T1VR, T1VC,TH2V<a name='465'>
   REAL :: RLMO_URB<a name='466'>
   REAL :: AKANDA_URBAN<a name='467'>
   <a name='468'>
   REAL :: TH2X                                                <font color=#447700>!m<a name='469'></font>
   <a name='470'>
   INTEGER :: BOUNDR, BOUNDB, BOUNDG<a name='471'>
   INTEGER :: CH_SCHEME, TS_SCHEME<a name='472'>
<a name='473'>
   LOGICAL :: SHADOW  <font color=#447700>! [true=consider svf and shadow effects, false=consider svf effect only]<a name='474'></font>
<a name='475'>
<font color=#447700>!for BEP<a name='476'></font>
   INTEGER                        :: NUMDIR<a name='477'>
   REAL,    DIMENSION ( MAXDIRS ) :: STREET_DIRECTION<a name='478'>
   REAL,    DIMENSION ( MAXDIRS ) :: STREET_WIDTH<a name='479'>
   REAL,    DIMENSION ( MAXDIRS ) :: BUILDING_WIDTH<a name='480'>
   INTEGER                        :: NUMHGT<a name='481'>
   REAL,    DIMENSION ( MAXHGTS ) :: HEIGHT_BIN<a name='482'>
   REAL,    DIMENSION ( MAXHGTS ) :: HPERCENT_BIN<a name='483'>
<font color=#447700>!end BEP<a name='484'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='485'></font>
<font color=#447700>! L: Local variables<a name='486'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='487'></font>
<a name='488'>
   REAL :: BETR, BETB, BETG<a name='489'>
   REAL :: SX, SD, SQ, RX<a name='490'>
   REAL :: UR, ZC, XLB, BB<a name='491'>
   REAL :: Z, RIBB, RIBG, RIBC, BHR, BHB, BHG, BHC<a name='492'>
   REAL :: TSC, LNET, SNET, FLXUV, THG, FLXTH, FLXHUM, FLXG<a name='493'>
   REAL :: W, VFGS, VFGW, VFWG, VFWS, VFWW<a name='494'>
   REAL :: HOUI1, HOUI2, HOUI3, HOUI4, HOUI5, HOUI6, HOUI7, HOUI8<a name='495'>
   REAL :: SLX, SLX1, SLX2, SLX3, SLX4, SLX5, SLX6, SLX7, SLX8<a name='496'>
   REAL :: FLXTHR, FLXTHB, FLXTHG<a name='497'>
   REAL :: SR, SB, SG, RR, RB, RG<a name='498'>
   REAL :: SR1, SR2, SB1, SB2, SG1, SG2, RR1, RR2, RB1, RB2, RG1, RG2<a name='499'>
   REAL :: HR, HB, HG, ELER, ELEB, ELEG, G0R, G0B, G0G<a name='500'>
   REAL :: ALPHAC, ALPHAR, ALPHAB, ALPHAG<a name='501'>
   REAL :: CHC, CHR, CHB, CHG, CDC, CDR, CDB, CDG, CDGR<a name='502'>
   REAL :: C1R, C1B, C1G, TE, TC1, TC2, QC1, QC2, QS0R, QS0B, QS0G,RHO,ES<a name='503'>
<a name='504'>
   REAL :: DESDT<a name='505'>
   REAL :: F<a name='506'>
   REAL :: DQS0RDTR<a name='507'>
   REAL :: DRRDTR, DHRDTR, DELERDTR, DG0RDTR<a name='508'>
   REAL :: DTR, DFDT<a name='509'>
   REAL :: FX, FY, GF, GX, GY<a name='510'>
   REAL :: DTCDTB, DTCDTG<a name='511'>
   REAL :: DQCDTB, DQCDTG<a name='512'>
   REAL :: DRBDTB1,  DRBDTG1,  DRBDTB2,  DRBDTG2<a name='513'>
   REAL :: DRGDTB1,  DRGDTG1,  DRGDTB2,  DRGDTG2<a name='514'>
   REAL :: DRBDTB,   DRBDTG,   DRGDTB,   DRGDTG<a name='515'>
   REAL :: DHBDTB,   DHBDTG,   DHGDTB,   DHGDTG<a name='516'>
   REAL :: DELEBDTB, DELEBDTG, DELEGDTG, DELEGDTB<a name='517'>
   REAL :: DG0BDTB,  DG0BDTG,  DG0GDTG,  DG0GDTB<a name='518'>
   REAL :: DQS0BDTB, DQS0GDTG<a name='519'>
   REAL :: DTB, DTG, DTC<a name='520'>
<a name='521'>
   REAL :: THEATAZ    <font color=#447700>! Solar Zenith Angle [rad]<a name='522'></font>
   REAL :: THEATAS    <font color=#447700>! = PI/2. - THETAZ<a name='523'></font>
   REAL :: FAI        <font color=#447700>! Latitude [rad]<a name='524'></font>
   REAL :: CNT,SNT<a name='525'>
   REAL :: PS         <font color=#447700>! Surface Pressure [hPa]<a name='526'></font>
   REAL :: TAV        <font color=#447700>! Vertial Temperature [K] <a name='527'></font>
<a name='528'>
   REAL :: XXX, X, Z0, Z0H, CD, CH<a name='529'>
   REAL :: XXX2, PSIM2, PSIH2, XXX10, PSIM10, PSIH10<a name='530'>
   REAL :: PSIX, PSIT, PSIX2, PSIT2, PSIX10, PSIT10<a name='531'>
<a name='532'>
   REAL :: TRP, TBP, TGP, TCP, QCP, TST, QST<a name='533'>
<a name='534'>
   REAL :: WDR,HGT2,BW,DHGT<a name='535'>
   REAL, parameter :: VonK = 0.4<a name='536'>
   REAL :: lambda_f,alpha_macd,beta_macd,lambda_fr<a name='537'>
<a name='538'>
   INTEGER :: iteration, K, NUDAPT <a name='539'>
   INTEGER :: tloc, tloc2, Kalh<a name='540'>
<a name='541'>
<font color=#447700>!===Yang,2014/10/08, urban hydrological variables for single layer UCM===<a name='542'></font>
   REAL :: FLXHUMRP, FLXHUMBP, FLXHUMGP<a name='543'>
   REAL :: DRELRP, DRELBP, DRELGP<a name='544'>
   REAL :: TGRP, CMCRP<a name='545'>
   REAL, DIMENSION(1:num_roof_layers) :: ZSOILR, ETR, SMRP<a name='546'>
<font color=#447700>!===Define parameters for green roof===<a name='547'></font>
   INTEGER :: KZ<a name='548'>
   REAL :: RUNOFF1, RUNOFF2, RUNOFF3<a name='549'>
   REAL :: SGR, SGR1, T1VGR, CHGR, ALPHAGR <a name='550'>
   REAL :: FLXTHGR, FLXHUMGR, HGR, ELEGR, G0GR<a name='551'>
   REAL :: QS0GR, EPGR, EDIR, ETTR, FV, DTGR, DRIP<a name='552'>
<font color=#447700>!   REAL :: DQS0GRDTGR, ETR, ECR,RAIN1, RAINDR, DEW, ETAR, BETGR<a name='553'></font>
   REAL :: DQS0GRDTGR, ECR,RAIN1, RAINDR, DEW, ETAR, BETGR<a name='554'>
<font color=#447700>!   REAL :: DF1, RGR, RGRR, RCH, RR1, RR2, YY, ZZ1, SSOILR<a name='555'></font>
   REAL :: DF1, RGR, RGRR, RCH, YY, ZZ1, SSOILR<a name='556'>
   REAL :: DRRDTGR, DHRDTGR, DELERDTGR, DG0RDTGR, DFDVT  <a name='557'>
   real,parameter  :: SHDFAC   = 0.80   <font color=#447700>! Vegetated area fraction of green roof vegetation<a name='558'></font>
   real,parameter  :: ALBV     = 0.20   <font color=#447700>! green roof albedo<a name='559'></font>
   real,parameter  :: EPSV     = 0.93   <font color=#447700>! green roof emissivity<a name='560'></font>
   real,parameter  :: LAI      = 1.50   <font color=#447700>! leaf area index on green roof<a name='561'></font>
   real,parameter  :: CMCMAX   = 0.5E-3 <font color=#447700>! Maximum canopy interception capacity   <a name='562'></font>
   real,parameter  :: SMCREF   = 0.329  <font color=#447700>! Reference soil moisture<a name='563'></font>
   real,parameter  :: SMCDRY   = 0.066  <font color=#447700>! Residual  soil moisture<a name='564'></font>
   real,parameter  :: SMCWLT   = 0.084  <font color=#447700>! Wilting point        <a name='565'></font>
   real,parameter  :: SMCMAX   = 0.439  <font color=#447700>! Saturated soil moisture<a name='566'></font>
   real,parameter  :: RSMAX    = 5000   <font color=#447700>! Maximum stomatal resistance<a name='567'></font>
   real,parameter  :: RSMIN    = 100    <font color=#447700>! Minimum stomatal resistance<a name='568'></font>
   real,parameter  :: RGL      = 100    <font color=#447700>! Radiation limit where photosynthesis begins<a name='569'></font>
   real,parameter  :: CFACTR   = 0.5    <font color=#447700>! Parameter used in the canopy inteception calculation        <a name='570'></font>
   real,parameter  :: DWSAT    = 0.143E-4 <font color=#447700>! Saturated soil conductivity            <a name='571'></font>
   real,parameter  :: DKSAT    = 3.38E-6  <font color=#447700>! Saturated soil diffusivity<a name='572'></font>
   real,parameter  :: BEXP     = 5.25   <font color=#447700>! B parameter in soil hydraulic calculation<a name='573'></font>
   real,parameter  :: FXEXP    = 2.0    <font color=#447700>! Parameter for computing direct soil evaporation        <a name='574'></font>
   real,parameter  :: ZBOT     = -2.0   <a name='575'>
   real,parameter  :: QUARTZ   = 0.40<a name='576'>
   real,parameter  :: CSOIL    = 2.0E+6<a name='577'>
   real,parameter  :: HS       = 36<a name='578'>
   integer,parameter ::  NROOT = 2      <font color=#447700>! Root depth layer of green roof<a name='579'></font>
   integer,parameter ::  NGR   = 4      <font color=#447700>! Layer of green roof<a name='580'></font>
   integer,parameter ::  IMPR  = 1     <a name='581'>
   integer,parameter ::  IMPB  = 2      <a name='582'>
   integer,parameter ::  IMPG  = 3    <a name='583'>
<a name='584'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='585'></font>
<font color=#447700>! Set parameters<a name='586'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='587'></font>
<a name='588'>
<font color=#447700>! Miao, 2007/01/17, cal. ah<a name='589'></font>
   if(ahoption==1) then<a name='590'>
     tloc=mod(int(OMG/PI*180./15.+12.+0.5 ),24)<a name='591'>
     if(tloc.lt.0) tloc=tloc+24<a name='592'>
     if(tloc==0) tloc=24<a name='593'>
   endif<a name='594'>
<font color=#447700>! Yang, 2014/10/08, cal. alh<a name='595'></font>
   if(alhoption==1) then<a name='596'>
     tloc2=mod(int((OMG/PI*180./15.+12.)*2.+0.5 ),48)<a name='597'>
     if(tloc2.lt.0) tloc2=tloc2+48<a name='598'>
     if(tloc2==0) tloc2=48<a name='599'>
   endif<a name='600'>
<a name='601'>
   CALL <A href='../../html_code/phys/module_sf_urban.F.html#READ_PARAM'>read_param</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_PARAM_1">(UTYPE,ZR,SIGMA_ZED,Z0C,Z0HC,ZDC,SVF,R,RW,HGT,  &amp;<a name='602'>
                   AH,CAPR,CAPB,CAPG,AKSR,AKSB,AKSG,ALBR,ALBB,    &amp;<a name='603'>
                   ALBG,EPSR,EPSB,EPSG,Z0R,Z0B,Z0G,Z0HB,Z0HG,     &amp;<a name='604'>
                   BETR,BETB,BETG,TRLEND,TBLEND,TGLEND,           &amp;<a name='605'>
<font color=#447700>!for BEP<a name='606'></font>
                   NUMDIR, STREET_DIRECTION, STREET_WIDTH,        &amp; <a name='607'>
                   BUILDING_WIDTH, NUMHGT, HEIGHT_BIN,            &amp; <a name='608'>
                   HPERCENT_BIN,                                  &amp; <a name='609'>
<font color=#447700>!end BEP<a name='610'></font>
                   BOUNDR,BOUNDB,BOUNDG,CH_SCHEME,TS_SCHEME,      &amp;<a name='611'>
                   AKANDA_URBAN,ALH)<a name='612'>
<a name='613'>
<font color=#447700>! Glotfelty, 2012/07/05, NUDAPT Modification<a name='614'></font>
<a name='615'>
 if(mh_urb.gt.0.0)THEN <a name='616'>
  <font color=#447700>!write(mesg,*) 'Mean Height NUDAPT',mh_urb<a name='617'></font>
  <font color=#447700>!call wrf_message(mesg)<a name='618'></font>
  <font color=#447700>!write(mesg,*) 'Mean Height Table',ZR<a name='619'></font>
  <font color=#447700>!call wrf_message(mesg)<a name='620'></font>
  if(zo_check.eq.1)THEN<a name='621'>
   write(mesg,*) 'Mean Height NUDAPT',mh_urb<a name='622'>
   call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1005">(mesg)<a name='623'>
   write(mesg,*) 'Mean Height Table',ZR<a name='624'>
   call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1006">(mesg)<a name='625'>
   write(mesg,*) 'Roughness Length Table',Z0C<a name='626'>
   call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1007">(mesg)<a name='627'>
   write(mesg,*) 'Roof Roughness Length Table',Z0R<a name='628'>
   call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1008">(mesg)<a name='629'>
   write(mesg,*) 'Sky View Factor Table',SVF<a name='630'>
   call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1009">(mesg)<a name='631'>
   write(mesg,*) 'Normalized Height Table',HGT<a name='632'>
   call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1010">(mesg)<a name='633'>
   write(mesg,*) 'Plan Area Fraction', lp_urb<a name='634'>
   call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1011">(mesg)<a name='635'>
   write(mesg,*) 'Plan Area Fraction table', R<a name='636'>
   call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1012">(mesg)<a name='637'>
  end if<a name='638'>
  <font color=#447700>!write(mesg,*) 'Area Weighted Mean Height',hgt_urb<a name='639'></font>
  <font color=#447700>!call wrf_message(mesg)<a name='640'></font>
  <font color=#447700>!write(mesg,*) 'Plan Area Fraction', lp_urb<a name='641'></font>
  <font color=#447700>!call wrf_message(mesg)<a name='642'></font>
  <font color=#447700>!write(mesg,*) 'STD Height', stdh_urb<a name='643'></font>
  <font color=#447700>!call wrf_message(mesg)<a name='644'></font>
  <font color=#447700>!write(mesg,*) 'Frontal Area Index',lf_urb<a name='645'></font>
  <font color=#447700>!call wrf_message(mesg)<a name='646'></font>
  <font color=#447700>!write(mesg,*) 'Urban Fraction',frc_urb<a name='647'></font>
  <font color=#447700>!call wrf_message(mesg)<a name='648'></font>
  <font color=#447700>!write(mesg,*) 'Building Surf Ratio',lb_urb<a name='649'></font>
  <font color=#447700>!call wrf_message(mesg)<a name='650'></font>
 <a name='651'>
 <font color=#447700>!Calculate Building Width and Street Width Based on BEP formulation<a name='652'></font>
 if(lb_urb.gt.lp_urb)THEN<a name='653'>
  BW=2.*hgt_urb*lp_urb/(lb_urb-lp_urb)<a name='654'>
  SW=2.*hgt_urb*lp_urb*((frc_urb/lp_urb)-1.)/(lb_urb-lp_urb)<a name='655'>
  <font color=#447700>!write(mesg,*) 'Building Width',BW<a name='656'></font>
  <font color=#447700>!call wrf_message(mesg)<a name='657'></font>
  <font color=#447700>!write(mesg,*) 'Street Width',SW<a name='658'></font>
  <font color=#447700>!call wrf_message(mesg)<a name='659'></font>
 elseif (SW.lt.0.0.or.BW.lt.0.0)then<a name='660'>
  BW=BUILDING_WIDTH(1)<a name='661'>
  SW=STREET_WIDTH(1)<a name='662'>
 else<a name='663'>
    BW=BUILDING_WIDTH(1)<a name='664'>
  SW=STREET_WIDTH(1)<a name='665'>
 end if<a name='666'>
 <a name='667'>
 <font color=#447700>!Assign NUDAPT Parameters<a name='668'></font>
   ZR = mh_urb<a name='669'>
    R = lp_urb<a name='670'>
    RW = 1.0-R<a name='671'>
   HGT = mh_urb/(BW+SW)<a name='672'>
   SIGMA_ZED = stdh_urb<a name='673'>
<a name='674'>
 <font color=#447700>!Calculate Wind Direction and Assign Appropriae lf_urb<a name='675'></font>
   <font color=#447700>!WDR = (180.0/PI)*ATAN2(U10,V10)<a name='676'></font>
   <a name='677'>
   IF(WDR.ge.0.0.and.WDR.lt.22.5)THEN<a name='678'>
     lambda_f = lf_urb(1)<a name='679'>
   ELSEIF(WDR.ge.-22.5.and.WDR.lt.0.0)THEN<a name='680'>
     lambda_f = lf_urb(1)<a name='681'>
   ELSEIF(WDR.gt.157.5.and.WDR.le.180.0)THEN<a name='682'>
     lambda_f = lf_urb(1)<a name='683'>
   ELSEIF(WDR.lt.-157.5)THEN<a name='684'>
     lambda_f = lf_urb(1)<a name='685'>
   ELSEIF(WDR.gt.22.5.and.WDR.le.67.5)THEN<a name='686'>
     lambda_f = lf_urb(2)<a name='687'>
   ELSEIF(WDR.ge.-67.5.and.WDR.lt.-22.5)THEN<a name='688'>
     lambda_f = lf_urb(2)<a name='689'>
   ELSEIF(WDR.gt.67.5.and.WDR.le.112.5)THEN<a name='690'>
     lambda_f = lf_urb(3)<a name='691'>
   ELSEIF(WDR.ge.-112.5.and.WDR.lt.-67.5)THEN<a name='692'>
     lambda_f = lf_urb(3)<a name='693'>
   ELSEIF(WDR.gt.112.5.and.WDR.le.157.5)THEN<a name='694'>
     lambda_f = lf_urb(4)<a name='695'>
   ELSEIF(WDR.ge.-157.5.and.WDR.lt.-112.5)THEN<a name='696'>
     lambda_f = lf_urb(4)<a name='697'>
   ELSE<a name='698'>
     lambda_f = lf_urb(1)<a name='699'>
   ENDIF<a name='700'>
<a name='701'>
  <font color=#447700>!Calculate the following urban canyon geometry parameters following Macdonald's (1998) formulations<a name='702'></font>
      Cd         = 1.2<a name='703'>
      alpha_macd = 4.43<a name='704'>
      beta_macd  = 1.0<a name='705'>
<a name='706'>
<a name='707'>
      ZDC = ZR * ( 1.0 + ( alpha_macd ** ( -R ) )  * ( R - 1.0 ) )<a name='708'>
<a name='709'>
      Z0C = ZR * ( 1.0 - ZDC/ZR ) * &amp;<a name='710'>
           exp (-(0.5 * beta_macd * Cd / (VonK**2) * ( 1.0-ZDC/ZR) * lambda_f )**(-0.5))<a name='711'>
     <a name='712'>
      if(zo_check.eq.1)THEN<a name='713'>
        write(mesg,*) 'Roughness Length NUDAPT',Z0C<a name='714'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1013">(mesg)<a name='715'>
      end if<a name='716'>
<a name='717'>
      lambda_fr  = stdh_urb/(SW + BW)<a name='718'>
<a name='719'>
       Z0R = ZR * ( 1.0 - ZDC/ZR) &amp;<a name='720'>
             * exp ( -(0.5 * beta_macd * Cd / (VonK**2) &amp;<a name='721'>
              * ( 1.0-ZDC/ZR) * lambda_fr )**(-0.5))<a name='722'>
<a name='723'>
    <a name='724'>
<a name='725'>
       Z0HC = 0.1 * Z0C<a name='726'>
<a name='727'>
  <font color=#447700>! Calculate Sky View Factor<a name='728'></font>
<a name='729'>
     DHGT=HGT/100.<a name='730'>
     HGT2=0.<a name='731'>
     VFWS=0.<a name='732'>
     HGT2=HGT-DHGT/2.<a name='733'>
      do NUDAPT=1,99<a name='734'>
         HGT2=HGT2-DHGT<a name='735'>
         VFWS=VFWS+0.25*(1.-HGT2/SQRT(HGT2**2.+RW**2.))<a name='736'>
      end do<a name='737'>
<a name='738'>
     VFWS=VFWS/99.<a name='739'>
     VFWS=VFWS*2.<a name='740'>
<a name='741'>
     VFGS=1.-2.*VFWS*HGT/RW<a name='742'>
     SVF=VFGS<a name='743'>
<a name='744'>
    if(zo_check.eq.1)THEN<a name='745'>
      write(mesg,*) 'Roof Roughness Length NUDAPT',Z0R<a name='746'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1014">(mesg)<a name='747'>
      write(mesg,*) 'Sky View Factor NUDAPT',SVF<a name='748'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1015">(mesg)<a name='749'>
      write(mesg,*) 'normalized Height NUDAPT', HGT<a name='750'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1016">(mesg)<a name='751'>
    end if<a name='752'>
<a name='753'>
<a name='754'>
 endif<a name='755'>
<a name='756'>
 <font color=#447700>!End NUDAPT Modification<a name='757'></font>
<a name='758'>
<a name='759'>
<font color=#447700>! Miao, 2007/01/17, cal. ah<a name='760'></font>
   if(ahoption==1) AH=AH*ahdiuprf(tloc)<a name='761'>
<a name='762'>
<font color=#447700>! Yang, 2014/10/08, cal. alh<a name='763'></font>
   Kalh=0<a name='764'>
   if(alhoption==1) THEN<a name='765'>
     if(jmonth==3 .or. jmonth==4 .or. jmonth==5) Kalh=1<a name='766'>
     if(jmonth==6 .or. jmonth==7 .or. jmonth==8) Kalh=2<a name='767'>
     if(jmonth==9 .or. jmonth==10.or. jmonth==11)Kalh=3<a name='768'>
     if(jmonth==12.or. jmonth==1 .or. jmonth==2) Kalh=4<a name='769'>
   endif<a name='770'>
   if(alhoption==1) ALH = ALH*alhdiuprf(tloc2)*alhseason(Kalh)<a name='771'>
<a name='772'>
   IF( ZDC+Z0C+2. &gt;= ZA) THEN<a name='773'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1210"> ("ZDC + Z0C + 2m is larger than the 1st WRF level "// &amp;<a name='774'>
                           "Stop in subroutine urban - change ZDC and Z0C" ) <a name='775'>
   END IF<a name='776'>
<a name='777'>
   IF(.NOT.LSOLAR) THEN<a name='778'>
     SSGD = SRATIO*SSG<a name='779'>
     SSGQ = SSG - SSGD<a name='780'>
   ENDIF<a name='781'>
   SSGD = SRATIO*SSG   <font color=#447700>! No radiation scheme has SSGD and SSGQ.<a name='782'></font>
   SSGQ = SSG - SSGD<a name='783'>
<a name='784'>
   W=2.*1.*HGT<a name='785'>
   VFGS=SVF<a name='786'>
   VFGW=1.-SVF<a name='787'>
   VFWG=(1.-SVF)*(1.-R)/W<a name='788'>
   VFWS=VFWG<a name='789'>
   VFWW=1.-2.*VFWG<a name='790'>
<a name='791'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='792'></font>
<font color=#447700>! Convert unit from MKS to cgs<a name='793'></font>
<font color=#447700>! Renew surface and layer temperatures<a name='794'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='795'></font>
<a name='796'>
   SX=(SSGD+SSGQ)/697.7/60.  <font color=#447700>! downward short wave radition [ly/min]<a name='797'></font>
   SD=SSGD/697.7/60.         <font color=#447700>! downward direct short wave radiation<a name='798'></font>
   SQ=SSGQ/697.7/60.         <font color=#447700>! downward diffuse short wave radiation<a name='799'></font>
   RX=LLG/697.7/60.          <font color=#447700>! downward long wave radiation<a name='800'></font>
   RHO=RHOO*0.001            <font color=#447700>! air density at first atmospheric level<a name='801'></font>
<a name='802'>
   TRP=TR<a name='803'>
   TBP=TB<a name='804'>
   TGP=TG<a name='805'>
   TCP=TC<a name='806'>
   QCP=QC<a name='807'>
<a name='808'>
<font color=#447700>!===Yang,2014/10/08, urban hydrological variables for single layer UCM===<a name='809'></font>
   FLXHUMRP = FLXHUMR<a name='810'>
   FLXHUMBP = FLXHUMB<a name='811'>
   FLXHUMGP = FLXHUMG<a name='812'>
   DRELRP = DRELR<a name='813'>
   DRELBP = DRELB<a name='814'>
   DRELGP = DRELG<a name='815'>
   TGRP   = TGR<a name='816'>
   CMCRP  = CMCR<a name='817'>
   SMRP   = SMR <a name='818'>
<a name='819'>
<font color=#447700>!===Yang,2014/10/08, urban irrigation, May-Sep, 9-10pm<a name='820'></font>
   IF(IRI_SCHEME==1) THEN<a name='821'>
       IF (tloc==21 .or. tloc==22) THEN<a name='822'>
         IF(jmonth==5 .or. jmonth==6 .or. jmonth ==7 .or. &amp;<a name='823'>
          jmonth==8 .or. jmonth==9 ) THEN<a name='824'>
            DO KZ = 1,2<a name='825'>
               SMRP(KZ)= SMCREF<a name='826'>
             END DO<a name='827'>
       ENDIF<a name='828'>
     ENDIF<a name='829'>
   ENDIF<a name='830'>
<a name='831'>
   TAV=TA*(1.+0.61*QA)<a name='832'>
   PS=RHOO*287.*TAV/100. <font color=#447700>![hPa]<a name='833'></font>
<a name='834'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='835'></font>
<font color=#447700>! Canopy wind<a name='836'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='837'></font>
<a name='838'>
   IF ( ZR + 2. &lt; ZA ) THEN<a name='839'>
     UR=UA*LOG((ZR-ZDC)/Z0C)/LOG((ZA-ZDC)/Z0C)<a name='840'>
     ZC=0.7*ZR<a name='841'>
     XLB=0.4*(ZR-ZDC)<a name='842'>
     <font color=#447700>! BB formulation from Inoue (1963)<a name='843'></font>
     BB = 0.4 * ZR / ( XLB * alog( ( ZR - ZDC ) / Z0C ) )<a name='844'>
     UC=UR*EXP(-BB*(1.-ZC/ZR))<a name='845'>
   ELSE<a name='846'>
     <font color=#447700>! PRINT *, 'Warning ZR + 2m  is larger than the 1st WRF level' <a name='847'></font>
     ZC=ZA/2.<a name='848'>
     UC=UA/2.<a name='849'>
   END IF<a name='850'>
<a name='851'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='852'></font>
<font color=#447700>! Net Short Wave Radiation at roof, wall, and road<a name='853'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='854'></font>
<a name='855'>
   SHADOW = .false.<a name='856'>
<font color=#447700>!   SHADOW = .true.<a name='857'></font>
<a name='858'>
   IF (SSG &gt; 0.0) THEN<a name='859'>
<a name='860'>
     IF(.NOT.SHADOW) THEN              <font color=#447700>! no shadow effects model<a name='861'></font>
<a name='862'>
       SR1=SX*(1.-ALBR)<a name='863'>
       SGR1=SX*(1.-ALBV)<a name='864'>
       SG1=SX*VFGS*(1.-ALBG)<a name='865'>
       SB1=SX*VFWS*(1.-ALBB)<a name='866'>
       SG2=SB1*ALBB/(1.-ALBB)*VFGW*(1.-ALBG)<a name='867'>
       SB2=SG1*ALBG/(1.-ALBG)*VFWG*(1.-ALBB)<a name='868'>
<a name='869'>
     ELSE                              <font color=#447700>! shadow effects model<a name='870'></font>
<a name='871'>
       FAI=XLAT*PI/180.<a name='872'>
<a name='873'>
       THEATAS=ABS(ASIN(COSZ))<a name='874'>
       THEATAZ=ABS(ACOS(COSZ))<a name='875'>
<a name='876'>
       SNT=COS(DECLIN)*SIN(OMG)/COS(THEATAS)<a name='877'>
       CNT=(COSZ*SIN(FAI)-SIN(DECLIN))/COS(THEATAS)/COS(FAI)<a name='878'>
<a name='879'>
       HOUI1=(SNT*COS(PI/8.)    -CNT*SIN(PI/8.))<a name='880'>
       HOUI2=(SNT*COS(2.*PI/8.) -CNT*SIN(2.*PI/8.))<a name='881'>
       HOUI3=(SNT*COS(3.*PI/8.) -CNT*SIN(3.*PI/8.))<a name='882'>
       HOUI4=(SNT*COS(4.*PI/8.) -CNT*SIN(4.*PI/8.))<a name='883'>
       HOUI5=(SNT*COS(5.*PI/8.) -CNT*SIN(5.*PI/8.))<a name='884'>
       HOUI6=(SNT*COS(6.*PI/8.) -CNT*SIN(6.*PI/8.))<a name='885'>
       HOUI7=(SNT*COS(7.*PI/8.) -CNT*SIN(7.*PI/8.))<a name='886'>
       HOUI8=(SNT*COS(8.*PI/8.) -CNT*SIN(8.*PI/8.))<a name='887'>
<a name='888'>
       SLX1=HGT*ABS(TAN(THEATAZ))*ABS(HOUI1)<a name='889'>
       SLX2=HGT*ABS(TAN(THEATAZ))*ABS(HOUI2)<a name='890'>
       SLX3=HGT*ABS(TAN(THEATAZ))*ABS(HOUI3)<a name='891'>
       SLX4=HGT*ABS(TAN(THEATAZ))*ABS(HOUI4)<a name='892'>
       SLX5=HGT*ABS(TAN(THEATAZ))*ABS(HOUI5)<a name='893'>
       SLX6=HGT*ABS(TAN(THEATAZ))*ABS(HOUI6)<a name='894'>
       SLX7=HGT*ABS(TAN(THEATAZ))*ABS(HOUI7)<a name='895'>
       SLX8=HGT*ABS(TAN(THEATAZ))*ABS(HOUI8)<a name='896'>
<a name='897'>
       IF(SLX1 &gt; RW) SLX1=RW<a name='898'>
       IF(SLX2 &gt; RW) SLX2=RW<a name='899'>
       IF(SLX3 &gt; RW) SLX3=RW<a name='900'>
       IF(SLX4 &gt; RW) SLX4=RW<a name='901'>
       IF(SLX5 &gt; RW) SLX5=RW<a name='902'>
       IF(SLX6 &gt; RW) SLX6=RW<a name='903'>
       IF(SLX7 &gt; RW) SLX7=RW<a name='904'>
       IF(SLX8 &gt; RW) SLX8=RW<a name='905'>
<a name='906'>
       SLX=(SLX1+SLX2+SLX3+SLX4+SLX5+SLX6+SLX7+SLX8)/8.<a name='907'>
<a name='908'>
       SR1=SD*(1.-ALBR)+SQ*(1.-ALBR)<a name='909'>
       SGR1=SD*(1.-ALBV)+SQ*(1.-ALBV)<a name='910'>
       SG1=SD*(RW-SLX)/RW*(1.-ALBG)+SQ*VFGS*(1.-ALBG)<a name='911'>
       SB1=SD*SLX/W*(1.-ALBB)+SQ*VFWS*(1.-ALBB)<a name='912'>
       SG2=SB1*ALBB/(1.-ALBB)*VFGW*(1.-ALBG)<a name='913'>
       SB2=SG1*ALBG/(1.-ALBG)*VFWG*(1.-ALBB)<a name='914'>
<a name='915'>
     END IF<a name='916'>
<a name='917'>
     SR=SR1<a name='918'>
     SGR=SGR1<a name='919'>
     SG=SG1+SG2<a name='920'>
     SB=SB1+SB2<a name='921'>
<a name='922'>
     IF (GROPTION ==1) THEN<a name='923'>
     SNET=R*FGR*SGR+R*(1.-FGR)*SR+W*SB+RW*SG<a name='924'>
     ELSE<a name='925'>
     SNET=R*SR+W*SB+RW*SG<a name='926'>
     ENDIF<a name='927'>
<a name='928'>
   ELSE<a name='929'>
<a name='930'>
     SR=0.<a name='931'>
     SG=0.<a name='932'>
     SGR=0.<a name='933'>
     SB=0.<a name='934'>
     SNET=0.<a name='935'>
<a name='936'>
   END IF<a name='937'>
<a name='938'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='939'></font>
<font color=#447700>! Roof<a name='940'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='941'></font>
<a name='942'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='943'></font>
<font color=#447700>! CHR, CDR, BETR<a name='944'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='945'></font>
<a name='946'>
   <font color=#447700>! Z=ZA-ZDC<a name='947'></font>
   <font color=#447700>! BHR=LOG(Z0R/Z0HR)/0.4<a name='948'></font>
   <font color=#447700>! RIBR=(9.8*2./(TA+TRP))*(TA-TRP)*(Z+Z0R)/(UA*UA)<a name='949'></font>
   <font color=#447700>! CALL mos(XXXR,ALPHAR,CDR,BHR,RIBR,Z,Z0R,UA,TA,TRP,RHO)<a name='950'></font>
<a name='951'>
   <font color=#447700>! Alternative option for MOST using SFCDIF routine from Noah<a name='952'></font>
   <font color=#447700>! Virtual temperatures needed by SFCDIF<a name='953'></font>
   T1VR = TRP* (1.0+ 0.61 * QA) <a name='954'>
   TH2V = (TA + ( 0.0098 * ZA)) * (1.0+ 0.61 * QA)<a name='955'>
  <a name='956'>
   <font color=#447700>! note that CHR_URB contains UA (=CHR_MOS*UA)<a name='957'></font>
   RLMO_URB=0.0<a name='958'>
   CALL <A href='../../html_code/phys/module_sf_urban.F.html#SFCDIF_URB'>SFCDIF_URB</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIF_URB_1"> (ZA,Z0R,T1VR,TH2V,UA,AKANDA_URBAN,CMR_URB,CHR_URB,RLMO_URB,CDR)<a name='959'>
   ALPHAR =  RHO*CP*CHR_URB<a name='960'>
   CHR=ALPHAR/RHO/CP/UA<a name='961'>
<a name='962'>
<font color=#447700>! Yang, 03/12/2014 -- LH for impervious roof surface  <a name='963'></font>
   RAIN1 = RAIN * 0.001 /3600          <font color=#447700>! CONVERT FROM mm/hr to m/s<a name='964'></font>
   IF (IMP_SCHEME==1) then<a name='965'>
   IF (RAIN &gt; 1.) BETR=0.7<a name='966'>
   ENDIF   <a name='967'>
<a name='968'>
   IF (IMP_SCHEME==2) then<a name='969'>
   IF (FLXHUMRP &lt;= 0.) FLXHUMRP = 0. <a name='970'>
<font color=#447700>!  Compute water retention depth from previous time step <a name='971'></font>
   DrelR = DrelRP+(RAIN1-FLXHUMRP)*DELT/porimp(IMPR)<a name='972'>
   IF (RAIN &gt; 0. .AND. DrelR &lt; DrelRP) DrelR = DrelRP <a name='973'>
  <a name='974'>
   IF (DrelR &lt;= 0.) then<a name='975'>
   DrelR  = 0.0<a name='976'>
   BETR	  = 0.0<a name='977'>
   ELSEIf (DrelR &lt;= dengimp(IMPR)) then<a name='978'>
   BETR = DrelR/dengimp(IMPR)*porimp(IMPR)<a name='979'>
   ELSE<a name='980'>
   DrelR = dengimp(IMPR)<a name='981'>
   BETR  = porimp(IMPR)   <a name='982'>
   ENDIF<a name='983'>
<a name='984'>
   IF ( BETR &lt; 1.E-5 ) BETR = 0.0<a name='985'>
   ENDIF<a name='986'>
<a name='987'>
   IF (TS_SCHEME == 1) THEN <a name='988'>
<a name='989'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='990'></font>
<font color=#447700>! TR  Solving Non-Linear Equation by Newton-Rapson<a name='991'></font>
<font color=#447700>! TRL Solving Heat Equation by Tri Diagonal Matrix Algorithm  <a name='992'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='993'></font>
<font color=#447700>!      TSC=TRP-273.15                          <a name='994'></font>
<font color=#447700>!      ES=EXP(19.482-4303.4/(TSC+243.5))        ! WMO<a name='995'></font>
<font color=#447700>!      ES=6.11*10.**(TETENA*TSC/(TETENB+TSC))   ! Tetens<a name='996'></font>
<font color=#447700>!      DESDT=( 6.1078*(2500.-2.4*TSC)/ &amp;        ! Tetens<a name='997'></font>
<font color=#447700>!            (0.46151*(TSC+273.15)**2.) )*10.**(7.5*TSC/(237.3+TSC)) <a name='998'></font>
<font color=#447700>!      ES=6.11*EXP((2.5*10.**6./461.51)*(TRP-273.15)/(273.15*TRP) ) ! Clausius-Clapeyron <a name='999'></font>
<font color=#447700>!      DESDT=(2.5*10.**6./461.51)*ES/(TRP**2.)                      ! Clausius-Clapeyron<a name='1000'></font>
<font color=#447700>!      QS0R=0.622*ES/(PS-0.378*ES) <a name='1001'></font>
<font color=#447700>!      DQS0RDTR = DESDT*0.622*PS/((PS-0.378*ES)**2.) <a name='1002'></font>
<font color=#447700>!      DQS0RDTR = 17.269*(273.15-35.86)/((TRP-35.86)**2.)*QS0R<a name='1003'></font>
<a name='1004'>
<font color=#447700>!    TRP=350.<a name='1005'></font>
<a name='1006'>
     DO ITERATION=1,20<a name='1007'>
<a name='1008'>
       ES=6.11*EXP( (2.5*10.**6./461.51)*(TRP-273.15)/(273.15*TRP) )<a name='1009'>
       DESDT=(2.5*10.**6./461.51)*ES/(TRP**2.)<a name='1010'>
       QS0R=0.622*ES/(PS-0.378*ES) <a name='1011'>
       DQS0RDTR = DESDT*0.622*PS/((PS-0.378*ES)**2.) <a name='1012'>
<a name='1013'>
       RR=EPSR*(RX-SIG*(TRP**4.)/60.)<a name='1014'>
       HR=RHO*CP*CHR*UA*(TRP-TA)*100.<a name='1015'>
       ELER=RHO*EL*CHR*UA*BETR*(QS0R-QA)*100.<a name='1016'>
       G0R=AKSR*(TRP-TRL(1))/(DZR(1)/2.)<a name='1017'>
<a name='1018'>
       F = SR + RR - HR - ELER - G0R<a name='1019'>
<a name='1020'>
       DRRDTR = (-4.*EPSR*SIG*TRP**3.)/60.<a name='1021'>
       DHRDTR = RHO*CP*CHR*UA*100.<a name='1022'>
       DELERDTR = RHO*EL*CHR*UA*BETR*DQS0RDTR*100.<a name='1023'>
       DG0RDTR =  2.*AKSR/DZR(1)<a name='1024'>
<a name='1025'>
       DFDT = DRRDTR - DHRDTR - DELERDTR - DG0RDTR <a name='1026'>
       DTR = F/DFDT<a name='1027'>
<a name='1028'>
       TR = TRP - DTR<a name='1029'>
       TRP = TR<a name='1030'>
<a name='1031'>
       IF( ABS(F) &lt; 0.000001 .AND. ABS(DTR) &lt; 0.000001 ) EXIT<a name='1032'>
<a name='1033'>
     END DO<a name='1034'>
<a name='1035'>
<font color=#447700>! multi-layer heat equation model<a name='1036'></font>
<a name='1037'>
     CALL <A href='../../html_code/phys/module_sf_urban.F.html#MULTI_LAYER'>multi_layer</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MULTI_LAYER_1">(num_roof_layers,BOUNDR,G0R,CAPR,AKSR,TRL,DZR,DELT,TRLEND)<a name='1038'>
<a name='1039'>
   ELSE<a name='1040'>
<a name='1041'>
     ES=6.11*EXP( (2.5*10.**6./461.51)*(TRP-273.15)/(273.15*TRP) )<a name='1042'>
     QS0R=0.622*ES/(PS-0.378*ES)        <a name='1043'>
<a name='1044'>
     RR=EPSR*(RX-SIG*(TRP**4.)/60.)<a name='1045'>
     HR=RHO*CP*CHR*UA*(TRP-TA)*100.<a name='1046'>
     ELER=RHO*EL*CHR*UA*BETR*(QS0R-QA)*100.<a name='1047'>
     G0R=SR+RR-HR-ELER<a name='1048'>
<a name='1049'>
     CALL <A href='../../html_code/phys/module_sf_urban.F.html#FORCE_RESTORE'>force_restore</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FORCE_RESTORE_1">(CAPR,AKSR,DELT,SR,RR,HR,ELER,TRLEND,TRP,TR)<a name='1050'>
<a name='1051'>
     TRP=TR<a name='1052'>
<a name='1053'>
   END IF<a name='1054'>
<a name='1055'>
   FLXTHR=HR/RHO/CP/100.<a name='1056'>
   FLXHUMR=ELER/RHO/EL/100.<a name='1057'>
<a name='1058'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1059'></font>
<font color=#447700>! Green Roof<a name='1060'></font>
<font color=#447700>! Must use multiple layers scheme (TS_SCHEME=1)<a name='1061'></font>
<font color=#447700>!-------------------------------------------------------------------------------     <a name='1062'></font>
   IF (GROPTION == 1) THEN<a name='1063'>
   T1VGR = TGRP* (1.0+ 0.61 * QA) <a name='1064'>
   RLMO_URB=0.0<a name='1065'>
   CALL <A href='../../html_code/phys/module_sf_urban.F.html#SFCDIF_URB'>SFCDIF_URB</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIF_URB_2"> (ZA,Z0R,T1VGR,TH2V,UA,AKANDA_URBAN,CMGR_URB,CHGR_URB,RLMO_URB,CDGR)<a name='1066'>
   ALPHAGR =  RHO*CP*CHGR_URB<a name='1067'>
   CHGR=ALPHAGR/RHO/CP/UA<a name='1068'>
   RUNOFF1 = 0.0<a name='1069'>
   RUNOFF2 = 0.0<a name='1070'>
   RUNOFF3 = 0.0<a name='1071'>
<a name='1072'>
   KZ = 1<a name='1073'>
   ZSOILR (KZ) = - DZGR (KZ) <a name='1074'>
   DO KZ = 2,NGR<a name='1075'>
      ZSOILR (KZ) = - DZGR(KZ) + ZSOILR (KZ -1)<a name='1076'>
   END DO<a name='1077'>
<a name='1078'>
   DO ITERATION=1,100<a name='1079'>
       KZ=1     <a name='1080'>
       ES=6.11*EXP( (2.5*10.**6./461.51)*(TGRP-273.15)/(273.15*TGRP) )<a name='1081'>
       DESDT=(2.5*10.**6./461.51)*ES/(TGRP**2.)<a name='1082'>
       QS0GR=0.622*ES/(PS-0.378*ES) <a name='1083'>
       DQS0GRDTGR = DESDT*0.622*PS/((PS-0.378*ES)**2.) <a name='1084'>
       EPGR=RHOO*CHGR*UA*(QS0GR-QA)   <font color=#447700>! Potential evaporation [kg/m2/s]<a name='1085'></font>
<a name='1086'>
       IF (EPGR &gt; 0.0) THEN<a name='1087'>
       <font color=#447700>! Direct evaporation from soil on green roof <a name='1088'></font>
       CALL <A href='../../html_code/phys/module_sf_urban.F.html#DIREVAP'>DIREVAP</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIREVAP_1"> (EDIR,EPGR,SMRP(KZ),SHDFAC,SMCMAX,SMCDRY,FXEXP)    <a name='1089'>
       <font color=#447700>! Evapotranspiration and canopy intercepted evaporation<a name='1090'></font>
       CALL <A href='../../html_code/phys/module_sf_urban.F.html#TRANSP'>TRANSP</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRANSP_2">  (ETTR,ETR,ECR,SHDFAC,EPGR,CMCRP,CFACTR,CMCMAX,LAI,RSMIN,RSMAX,RGL,SX, &amp;<a name='1091'>
                     TGRP,TA,QA,SMRP,SMCWLT,SMCREF,CPP,PS,CHGR,EPSV,DELT,NROOT,NGR,DZGR, &amp;<a name='1092'>
                     ZSOILR,HS)<a name='1093'>
       <font color=#447700>! Update moisture in soil layers<a name='1094'></font>
       CALL <A href='../../html_code/phys/module_sf_urban.F.html#SMFLX'>SMFLX</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMFLX_4">   (SMRP,SMR,NGR,CMCRP,CMCR,DELT,RAIN,ZSOILR,SMCMAX,BEXP,SMCWLT,DKSAT,&amp;<a name='1095'>
                     DWSAT,SHDFAC,CMCMAX,RUNOFF1,RUNOFF2,RUNOFF3,EDIR,ECR,ETR,DRIP)  <a name='1096'>
       else <a name='1097'>
       DEW  = - EPGR<a name='1098'>
       RAINDR = RAIN  + DEW * 3600.<a name='1099'>
       EDIR=0.0<a name='1100'>
       ECR =0.0<a name='1101'>
       ETTR=0.0<a name='1102'>
       CALL <A href='../../html_code/phys/module_sf_urban.F.html#SMFLX'>SMFLX</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMFLX_5"> (SMRP,SMR,NGR,CMCRP,CMCR,DELT,RAINDR,ZSOILR,SMCMAX,BEXP,SMCWLT,DKSAT,&amp;<a name='1103'>
                   DWSAT,SHDFAC,CMCMAX,RUNOFF1,RUNOFF2,RUNOFF3,EDIR,ECR,ETR,DRIP)  <a name='1104'>
       END IF<a name='1105'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1106'></font>
<font color=#447700>! CONVERT MODELED EVAPOTRANSPIRATION FROM  M S-1  TO  KG M-2 S-1.<a name='1107'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1108'></font>
       EDIR = EDIR  * 1000.0<a name='1109'>
       ETTR = ETTR  * 1000.0<a name='1110'>
       ECR  = ECR   * 1000.0<a name='1111'>
       ETAR = EDIR + ETTR + ECR<a name='1112'>
       IF (ETAR &lt; 1.E-20) ETAR = 0.0<a name='1113'>
<a name='1114'>
       IF ( EPGR &lt;= 0.0 ) THEN<a name='1115'>
         BETGR = 0.0<a name='1116'>
       ELSE<a name='1117'>
         BETGR = ETAR / EPGR <a name='1118'>
       END IF   <a name='1119'>
       ELEGR= ETAR* RHO * EL /RHOO * 100<a name='1120'>
          <a name='1121'>
       CALL <A href='../../html_code/phys/module_sf_urban.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_6"> (DF1,SMR(KZ), QUARTZ, SMCMAX )<a name='1122'>
       DF1 = DF1 * EXP(-2.0 * SHDFAC)  <a name='1123'>
       RGR = EPSV*(RX-SIG*(TGRP**4.)/60.)<a name='1124'>
       RGRR= (SGR+RGR) * 697.7 * 60.<a name='1125'>
       RCH = RHOO*CPP*CHGR<a name='1126'>
       RR1 = EPSV*(TA**4) * 6.48E-8 / (PS* CHGR) + 1.0<a name='1127'>
       IF (RAIN &gt;  0.0) then<a name='1128'>
       RR2 = RR1 + RAIN / 3600 * 4.218E+3 / RCH<a name='1129'>
       else<a name='1130'>
       RR2 = RR1<a name='1131'>
       end if <a name='1132'>
       YY  = TA + (RGRR / RCH - BETGR * EPGR * ELL/ RCH) / RR2  <a name='1133'>
       ZZ1 = DF1 / (-0.5 * ZSOILR (KZ) * RCH * RR2 ) + 1.0<a name='1134'>
<a name='1135'>
<a name='1136'>
       HGR=RHO*CP*CHGR*UA*(TGRP-TA)*100.     <a name='1137'>
       RUNOFF3 = RUNOFF3/ DELT<a name='1138'>
       RUNOFF2 = RUNOFF2+ RUNOFF3      <a name='1139'>
       G0GR    = DF1*(TGRP-TGRL(1))/(DZGR(1)/2.)/697.7/60<a name='1140'>
<a name='1141'>
       FV = SGR + RGR - HGR - ELEGR - G0GR<a name='1142'>
       DRRDTGR   = (-4.*EPSV*SIG*TGRP**3.)/60.<a name='1143'>
       DHRDTGR   = RHO*CP*CHGR*UA*100.<a name='1144'>
       DELERDTGR = RHO*EL*CHGR*UA*BETGR*DQS0GRDTGR*100.<a name='1145'>
       DG0RDTGR  = 2.*DF1/ DZGR(KZ) * ( 1.0 / 4.1868 ) * 1.E-4<a name='1146'>
       DFDVT = DRRDTGR - DHRDTGR - DELERDTGR - DG0RDTGR <a name='1147'>
       DTGR = FV/DFDVT/ 6<a name='1148'>
       TGR  = TGRP - DTGR<a name='1149'>
       TGRP = TGR<a name='1150'>
<a name='1151'>
       IF( ABS(FV) &lt; 0.0001 .AND. ABS(DTGR) &lt; 0.001 ) then<a name='1152'>
       EXIT<a name='1153'>
       ENDIF<a name='1154'>
     END DO<a name='1155'>
       <font color=#447700>! Update temperature in soil layer<a name='1156'></font>
       CALL <A href='../../html_code/phys/module_sf_urban.F.html#SHFLX'>SHFLX</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHFLX_5"> (SSOILR,TGRL,SMR,SMCMAX,NGR,TGRP,DELT,YY,ZZ1,ZSOILR,       &amp;<a name='1157'>
                  TRLEND,ZBOT,SMCWLT,DF1,QUARTZ,CSOIL,CAPR)     <a name='1158'>
   FLXTHGR=HGR/RHO/CP/100.<a name='1159'>
   FLXHUMGR=ELEGR/RHO/EL/100.<a name='1160'>
ELSE<a name='1161'>
   FLXTHGR=0.<a name='1162'>
   FLXHUMGR=0.<a name='1163'>
ENDIF<a name='1164'>
<a name='1165'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1166'></font>
<font color=#447700>!  Wall and Road <a name='1167'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1168'></font>
<a name='1169'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1170'></font>
<font color=#447700>!  CHC, CHB, CDB, BETB, CHG, CDG, BETG<a name='1171'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1172'></font>
<a name='1173'>
   <font color=#447700>! Z=ZA-ZDC<a name='1174'></font>
   <font color=#447700>! BHC=LOG(Z0C/Z0HC)/0.4<a name='1175'></font>
   <font color=#447700>! RIBC=(9.8*2./(TA+TCP))*(TA-TCP)*(Z+Z0C)/(UA*UA)<a name='1176'></font>
   <font color=#447700>!<a name='1177'></font>
   <font color=#447700>! CALL mos(XXXC,ALPHAC,CDC,BHC,RIBC,Z,Z0C,UA,TA,TCP,RHO)<a name='1178'></font>
   <font color=#447700>! Virtual temperatures needed by SFCDIF routine from Noah<a name='1179'></font>
<a name='1180'>
   T1VC = TCP* (1.0+ 0.61 * QA) <a name='1181'>
   RLMO_URB=0.0<a name='1182'>
   CALL <A href='../../html_code/phys/module_sf_urban.F.html#SFCDIF_URB'>SFCDIF_URB</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIF_URB_3">(ZA,Z0C,T1VC,TH2V,UA,AKANDA_URBAN,CMC_URB,CHC_URB,RLMO_URB,CDC)<a name='1183'>
   ALPHAC =  RHO*CP*CHC_URB<a name='1184'>
<a name='1185'>
   IF (CH_SCHEME == 1) THEN <a name='1186'>
<a name='1187'>
     Z=ZDC<a name='1188'>
     BHB=LOG(Z0B/Z0HB)/0.4<a name='1189'>
     BHG=LOG(Z0G/Z0HG)/0.4<a name='1190'>
     RIBB=(9.8*2./(TCP+TBP))*(TCP-TBP)*(Z+Z0B)/(UC*UC)<a name='1191'>
     RIBG=(9.8*2./(TCP+TGP))*(TCP-TGP)*(Z+Z0G)/(UC*UC)<a name='1192'>
<a name='1193'>
     CALL <A href='../../html_code/phys/module_sf_urban.F.html#MOS'>mos</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MOS_1">(XXXB,ALPHAB,CDB,BHB,RIBB,Z,Z0B,UC,TCP,TBP,RHO)<a name='1194'>
     CALL <A href='../../html_code/phys/module_sf_urban.F.html#MOS'>mos</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MOS_2">(XXXG,ALPHAG,CDG,BHG,RIBG,Z,Z0G,UC,TCP,TGP,RHO)<a name='1195'>
<a name='1196'>
   ELSE<a name='1197'>
<a name='1198'>
     ALPHAB=RHO*CP*(6.15+4.18*UC)/1200.<a name='1199'>
     IF(UC &gt; 5.) ALPHAB=RHO*CP*(7.51*UC**0.78)/1200.<a name='1200'>
     ALPHAG=RHO*CP*(6.15+4.18*UC)/1200.<a name='1201'>
     IF(UC &gt; 5.) ALPHAG=RHO*CP*(7.51*UC**0.78)/1200.<a name='1202'>
<a name='1203'>
   END IF<a name='1204'>
<a name='1205'>
   CHC=ALPHAC/RHO/CP/UA<a name='1206'>
   CHB=ALPHAB/RHO/CP/UC<a name='1207'>
   CHG=ALPHAG/RHO/CP/UC<a name='1208'>
<a name='1209'>
<font color=#447700>!Yang 10/10/2013 -- LH from impervious wall and ground<a name='1210'></font>
 IF (IMP_SCHEME==1) then<a name='1211'>
   BETB=0.0<a name='1212'>
   IF(RAIN &gt; 1.) BETG=0.7<a name='1213'>
 ENDIF<a name='1214'>
<a name='1215'>
 IF (IMP_SCHEME==2) then<a name='1216'>
   IF (FLXHUMBP &lt;= 0.) FLXHUMBP = 0. <a name='1217'>
   IF (FLXHUMGP &lt;= 0.) FLXHUMGP = 0. <a name='1218'>
<font color=#447700>! Compute water retention from previous time step for wall and ground<a name='1219'></font>
  DrelB = DrelBP+(RAIN1-FLXHUMBP)*DELT/porimp(IMPB) <a name='1220'>
    IF (RAIN &gt; 0. .AND. DrelB &lt; DrelBP) DrelB = DrelBP <a name='1221'>
  DrelG = DrelGP+(RAIN1-FLXHUMGP)*DELT/porimp(IMPG)  <a name='1222'>
    IF (RAIN &gt; 0. .AND. DrelG &lt; DrelGP) DrelG = DrelGP <a name='1223'>
  <a name='1224'>
  IF (DrelB &lt;= 0.) then<a name='1225'>
  DrelB   = 0.0<a name='1226'>
  BETB    = 0.0<a name='1227'>
  ELSEIf (DrelB &lt;= dengimp(IMPB)) then<a name='1228'>
  BETB  = DrelB/dengimp(IMPB)*porimp(IMPB) <a name='1229'>
  ELSE<a name='1230'>
  DrelB = dengimp(IMPB)<a name='1231'>
  BETB = porimp(IMPB) <a name='1232'>
  ENDIF<a name='1233'>
<a name='1234'>
  IF (DrelG &lt;= 0.) then<a name='1235'>
  DrelG   = 0.0<a name='1236'>
  BETG    = 0.0<a name='1237'>
  ELSEIf (DrelG &lt;= dengimp(IMPG)) then<a name='1238'>
  BETG  = DrelG/dengimp(IMPG)*porimp(IMPG) <a name='1239'>
  ELSE<a name='1240'>
  DrelG = dengimp(IMPG)<a name='1241'>
  BETG  = porimp(IMPG) <a name='1242'>
  ENDIF<a name='1243'>
<a name='1244'>
  if ( BETG &lt; 1.E-5 ) BETG = 0.0<a name='1245'>
  if ( BETB &lt; 1.E-5 ) BETB = 0.0<a name='1246'>
 <a name='1247'>
ENDIF<a name='1248'>
<a name='1249'>
   IF (TS_SCHEME == 1) THEN<a name='1250'>
<a name='1251'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1252'></font>
<font color=#447700>!  TB, TG  Solving Non-Linear Simultaneous Equation by Newton-Rapson<a name='1253'></font>
<font color=#447700>!  TBL,TGL Solving Heat Equation by Tri Diagonal Matrix Algorithm  <a name='1254'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1255'></font>
<a name='1256'>
<font color=#447700>!    TBP=350.<a name='1257'></font>
<font color=#447700>!    TGP=350.<a name='1258'></font>
<a name='1259'>
     DO ITERATION=1,20<a name='1260'>
<a name='1261'>
       ES=6.11*EXP( (2.5*10.**6./461.51)*(TBP-273.15)/(273.15*TBP) ) <a name='1262'>
       DESDT=(2.5*10.**6./461.51)*ES/(TBP**2.)<a name='1263'>
       QS0B=0.622*ES/(PS-0.378*ES) <a name='1264'>
       DQS0BDTB=DESDT*0.622*PS/((PS-0.378*ES)**2.)<a name='1265'>
<a name='1266'>
       ES=6.11*EXP( (2.5*10.**6./461.51)*(TGP-273.15)/(273.15*TGP) ) <a name='1267'>
       DESDT=(2.5*10.**6./461.51)*ES/(TGP**2.)<a name='1268'>
       QS0G=0.622*ES/(PS-0.378*ES)        <a name='1269'>
       DQS0GDTG=DESDT*0.22*PS/((PS-0.378*ES)**2.) <a name='1270'>
<a name='1271'>
       RG1=EPSG*( RX*VFGS          &amp;<a name='1272'>
       +EPSB*VFGW*SIG*TBP**4./60.  &amp;<a name='1273'>
       -SIG*TGP**4./60. )<a name='1274'>
<a name='1275'>
       RB1=EPSB*( RX*VFWS         &amp;<a name='1276'>
       +EPSG*VFWG*SIG*TGP**4./60. &amp;<a name='1277'>
       +EPSB*VFWW*SIG*TBP**4./60. &amp;<a name='1278'>
       -SIG*TBP**4./60. )<a name='1279'>
<a name='1280'>
       RG2=EPSG*( (1.-EPSB)*(1.-SVF)*VFWS*RX                  &amp;<a name='1281'>
       +(1.-EPSB)*(1.-SVF)*VFWG*EPSG*SIG*TGP**4./60.          &amp;<a name='1282'>
       +EPSB*(1.-EPSB)*(1.-SVF)*(1.-2.*VFWS)*SIG*TBP**4./60. )<a name='1283'>
<a name='1284'>
       RB2=EPSB*( (1.-EPSG)*VFWG*VFGS*RX                          &amp;<a name='1285'>
       +(1.-EPSG)*EPSB*VFGW*VFWG*SIG*(TBP**4.)/60.                &amp;<a name='1286'>
       +(1.-EPSB)*VFWS*(1.-2.*VFWS)*RX                            &amp;<a name='1287'>
       +(1.-EPSB)*VFWG*(1.-2.*VFWS)*EPSG*SIG*EPSG*TGP**4./60.     &amp;<a name='1288'>
       +EPSB*(1.-EPSB)*(1.-2.*VFWS)*(1.-2.*VFWS)*SIG*TBP**4./60. )<a name='1289'>
<a name='1290'>
       RG=RG1+RG2<a name='1291'>
       RB=RB1+RB2<a name='1292'>
<a name='1293'>
       DRBDTB1=EPSB*(4.*EPSB*SIG*TB**3.*VFWW-4.*SIG*TB**3.)/60.<a name='1294'>
       DRBDTG1=EPSB*(4.*EPSG*SIG*TG**3.*VFWG)/60.<a name='1295'>
       DRBDTB2=EPSB*(4.*(1.-EPSG)*EPSB*SIG*TB**3.*VFGW*VFWG &amp;<a name='1296'>
               +4.*EPSB*(1.-EPSB)*SIG*TB**3.*VFWW*VFWW)/60.<a name='1297'>
       DRBDTG2=EPSB*(4.*(1.-EPSB)*EPSG*SIG*TG**3.*VFWG*VFWW)/60.<a name='1298'>
<a name='1299'>
       DRGDTB1=EPSG*(4.*EPSB*SIG*TB**3.*VFGW)/60.<a name='1300'>
       DRGDTG1=EPSG*(-4.*SIG*TG**3.)/60.<a name='1301'>
       DRGDTB2=EPSG*(4.*EPSB*(1.-EPSB)*SIG*TB**3.*VFWW*VFGW)/60.<a name='1302'>
       DRGDTG2=EPSG*(4.*(1.-EPSB)*EPSG*SIG*TG**3.*VFWG*VFGW)/60.<a name='1303'>
<a name='1304'>
       DRBDTB=DRBDTB1+DRBDTB2<a name='1305'>
       DRBDTG=DRBDTG1+DRBDTG2<a name='1306'>
       DRGDTB=DRGDTB1+DRGDTB2<a name='1307'>
       DRGDTG=DRGDTG1+DRGDTG2<a name='1308'>
<a name='1309'>
       HB=RHO*CP*CHB*UC*(TBP-TCP)*100.<a name='1310'>
       HG=RHO*CP*CHG*UC*(TGP-TCP)*100.<a name='1311'>
<a name='1312'>
       DTCDTB=W*ALPHAB/(RW*ALPHAC+RW*ALPHAG+W*ALPHAB)<a name='1313'>
       DTCDTG=RW*ALPHAG/(RW*ALPHAC+RW*ALPHAG+W*ALPHAB)<a name='1314'>
<a name='1315'>
       DHBDTB=RHO*CP*CHB*UC*(1.-DTCDTB)*100.<a name='1316'>
       DHBDTG=RHO*CP*CHB*UC*(0.-DTCDTG)*100.<a name='1317'>
       DHGDTG=RHO*CP*CHG*UC*(1.-DTCDTG)*100.<a name='1318'>
       DHGDTB=RHO*CP*CHG*UC*(0.-DTCDTB)*100.<a name='1319'>
<a name='1320'>
       ELEB=RHO*EL*CHB*UC*BETB*(QS0B-QCP)*100.<a name='1321'>
       ELEG=RHO*EL*CHG*UC*BETG*(QS0G-QCP)*100.<a name='1322'>
<a name='1323'>
       DQCDTB=W*ALPHAB*BETB*DQS0BDTB/(RW*ALPHAC+RW*ALPHAG*BETG+W*ALPHAB*BETB)<a name='1324'>
       DQCDTG=RW*ALPHAG*BETG*DQS0GDTG/(RW*ALPHAC+RW*ALPHAG*BETG+W*ALPHAB*BETB)<a name='1325'>
<a name='1326'>
       DELEBDTB=RHO*EL*CHB*UC*BETB*(DQS0BDTB-DQCDTB)*100.<a name='1327'>
       DELEBDTG=RHO*EL*CHB*UC*BETB*(0.-DQCDTG)*100.<a name='1328'>
       DELEGDTG=RHO*EL*CHG*UC*BETG*(DQS0GDTG-DQCDTG)*100.<a name='1329'>
       DELEGDTB=RHO*EL*CHG*UC*BETG*(0.-DQCDTB)*100.<a name='1330'>
<a name='1331'>
       G0B=AKSB*(TBP-TBL(1))/(DZB(1)/2.)<a name='1332'>
       G0G=AKSG*(TGP-TGL(1))/(DZG(1)/2.)<a name='1333'>
<a name='1334'>
       DG0BDTB=2.*AKSB/DZB(1)<a name='1335'>
       DG0BDTG=0.<a name='1336'>
       DG0GDTG=2.*AKSG/DZG(1)<a name='1337'>
       DG0GDTB=0.<a name='1338'>
<a name='1339'>
       F = SB + RB - HB - ELEB - G0B<a name='1340'>
       FX = DRBDTB - DHBDTB - DELEBDTB - DG0BDTB <a name='1341'>
       FY = DRBDTG - DHBDTG - DELEBDTG - DG0BDTG<a name='1342'>
<a name='1343'>
       GF = SG + RG - HG - ELEG - G0G<a name='1344'>
       GX = DRGDTB - DHGDTB - DELEGDTB - DG0GDTB<a name='1345'>
       GY = DRGDTG - DHGDTG - DELEGDTG - DG0GDTG <a name='1346'>
<a name='1347'>
       DTB =  (GF*FY-F*GY)/(FX*GY-GX*FY)<a name='1348'>
       DTG = -(GF+GX*DTB)/GY<a name='1349'>
<a name='1350'>
       TB = TBP + DTB<a name='1351'>
       TG = TGP + DTG<a name='1352'>
<a name='1353'>
       TBP = TB<a name='1354'>
       TGP = TG<a name='1355'>
<a name='1356'>
       TC1=RW*ALPHAC+RW*ALPHAG+W*ALPHAB<a name='1357'>
       TC2=RW*ALPHAC*TA+RW*ALPHAG*TGP+W*ALPHAB*TBP<a name='1358'>
       TC=TC2/TC1<a name='1359'>
<a name='1360'>
       QC1=RW*ALPHAC+RW*ALPHAG*BETG+W*ALPHAB*BETB<a name='1361'>
       QC2=RW*ALPHAC*QA+RW*ALPHAG*BETG*QS0G+W*ALPHAB*BETB*QS0B<a name='1362'>
       QC=QC2/QC1<a name='1363'>
<a name='1364'>
       DTC=TCP - TC<a name='1365'>
       TCP=TC<a name='1366'>
       QCP=QC<a name='1367'>
<a name='1368'>
       IF( ABS(F) &lt; 0.000001 .AND. ABS(DTB) &lt; 0.000001 &amp;<a name='1369'>
        .AND. ABS(GF) &lt; 0.000001 .AND. ABS(DTG) &lt; 0.000001 &amp;<a name='1370'>
        .AND. ABS(DTC) &lt; 0.000001) EXIT<a name='1371'>
<a name='1372'>
     END DO<a name='1373'>
<a name='1374'>
     CALL <A href='../../html_code/phys/module_sf_urban.F.html#MULTI_LAYER'>multi_layer</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MULTI_LAYER_2">(num_wall_layers,BOUNDB,G0B,CAPB,AKSB,TBL,DZB,DELT,TBLEND)<a name='1375'>
<a name='1376'>
     CALL <A href='../../html_code/phys/module_sf_urban.F.html#MULTI_LAYER'>multi_layer</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MULTI_LAYER_3">(num_road_layers,BOUNDG,G0G,CAPG,AKSG,TGL,DZG,DELT,TGLEND)<a name='1377'>
<a name='1378'>
   ELSE<a name='1379'>
<a name='1380'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1381'></font>
<font color=#447700>!  TB, TG  by Force-Restore Method <a name='1382'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1383'></font>
<a name='1384'>
       ES=6.11*EXP((2.5*10.**6./461.51)*(TBP-273.15)/(273.15*TBP) )<a name='1385'>
       QS0B=0.622*ES/(PS-0.378*ES)       <a name='1386'>
<a name='1387'>
       ES=6.11*EXP((2.5*10.**6./461.51)*(TGP-273.15)/(273.15*TGP) )<a name='1388'>
       QS0G=0.622*ES/(PS-0.378*ES)        <a name='1389'>
<a name='1390'>
       RG1=EPSG*( RX*VFGS             &amp;<a name='1391'>
       +EPSB*VFGW*SIG*TBP**4./60.     &amp;<a name='1392'>
       -SIG*TGP**4./60. )<a name='1393'>
<a name='1394'>
       RB1=EPSB*( RX*VFWS &amp;<a name='1395'>
       +EPSG*VFWG*SIG*TGP**4./60. &amp;<a name='1396'>
       +EPSB*VFWW*SIG*TBP**4./60. &amp;<a name='1397'>
       -SIG*TBP**4./60. )<a name='1398'>
<a name='1399'>
       RG2=EPSG*( (1.-EPSB)*(1.-SVF)*VFWS*RX                   &amp;<a name='1400'>
       +(1.-EPSB)*(1.-SVF)*VFWG*EPSG*SIG*TGP**4./60.           &amp;<a name='1401'>
       +EPSB*(1.-EPSB)*(1.-SVF)*(1.-2.*VFWS)*SIG*TBP**4./60. )<a name='1402'>
<a name='1403'>
       RB2=EPSB*( (1.-EPSG)*VFWG*VFGS*RX                          &amp;<a name='1404'>
       +(1.-EPSG)*EPSB*VFGW*VFWG*SIG*(TBP**4.)/60.                &amp;<a name='1405'>
       +(1.-EPSB)*VFWS*(1.-2.*VFWS)*RX                            &amp;<a name='1406'>
       +(1.-EPSB)*VFWG*(1.-2.*VFWS)*EPSG*SIG*EPSG*TGP**4./60.     &amp;<a name='1407'>
       +EPSB*(1.-EPSB)*(1.-2.*VFWS)*(1.-2.*VFWS)*SIG*TBP**4./60. )<a name='1408'>
<a name='1409'>
       RG=RG1+RG2<a name='1410'>
       RB=RB1+RB2<a name='1411'>
<a name='1412'>
       HB=RHO*CP*CHB*UC*(TBP-TCP)*100.<a name='1413'>
       ELEB=RHO*EL*CHB*UC*BETB*(QS0B-QCP)*100.<a name='1414'>
       G0B=SB+RB-HB-ELEB<a name='1415'>
<a name='1416'>
       HG=RHO*CP*CHG*UC*(TGP-TCP)*100.<a name='1417'>
       ELEG=RHO*EL*CHG*UC*BETG*(QS0G-QCP)*100.<a name='1418'>
       G0G=SG+RG-HG-ELEG<a name='1419'>
<a name='1420'>
       CALL <A href='../../html_code/phys/module_sf_urban.F.html#FORCE_RESTORE'>force_restore</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FORCE_RESTORE_2">(CAPB,AKSB,DELT,SB,RB,HB,ELEB,TBLEND,TBP,TB)<a name='1421'>
       CALL <A href='../../html_code/phys/module_sf_urban.F.html#FORCE_RESTORE'>force_restore</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FORCE_RESTORE_3">(CAPG,AKSG,DELT,SG,RG,HG,ELEG,TGLEND,TGP,TG)<a name='1422'>
<a name='1423'>
       TBP=TB<a name='1424'>
       TGP=TG<a name='1425'>
<a name='1426'>
       TC1=RW*ALPHAC+RW*ALPHAG+W*ALPHAB<a name='1427'>
       TC2=RW*ALPHAC*TA+RW*ALPHAG*TGP+W*ALPHAB*TBP<a name='1428'>
       TC=TC2/TC1<a name='1429'>
<a name='1430'>
       QC1=RW*ALPHAC+RW*ALPHAG*BETG+W*ALPHAB*BETB<a name='1431'>
       QC2=RW*ALPHAC*QA+RW*ALPHAG*BETG*QS0G+W*ALPHAB*BETB*QS0B<a name='1432'>
       QC=QC2/QC1<a name='1433'>
<a name='1434'>
       TCP=TC<a name='1435'>
       QCP=QC<a name='1436'>
<a name='1437'>
   END IF<a name='1438'>
<a name='1439'>
<a name='1440'>
   FLXTHB=HB/RHO/CP/100.<a name='1441'>
   FLXHUMB=ELEB/RHO/EL/100.<a name='1442'>
   FLXTHG=HG/RHO/CP/100.<a name='1443'>
   FLXHUMG=ELEG/RHO/EL/100.<a name='1444'>
<a name='1445'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1446'></font>
<font color=#447700>! Total Fluxes from Urban Canopy<a name='1447'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1448'></font>
<font color=#447700>!===Yang, 2014/10/08, cal. ah. alh. green roof===<a name='1449'></font>
 if(groption==1) then<a name='1450'>
   if(ahoption==1) then<a name='1451'>
     FLXTH  = ((1.-FGR)*R*FLXTHR + FGR*R*FLXTHGR + W*FLXTHB + RW*FLXTHG)+ AH/RHOO/CPP<a name='1452'>
   else<a name='1453'>
     FLXTH  = ((1.-FGR)*R*FLXTHR + FGR*R*FLXTHGR + W*FLXTHB + RW*FLXTHG)<a name='1454'>
   endif<a name='1455'>
   if(alhoption==1) then<a name='1456'>
     FLXHUM  = ((1.-FGR)*R*FLXHUMR + FGR*R*FLXHUMGR + W*FLXHUMB + RW*FLXHUMG)+ ALH/RHOO/ELL<a name='1457'>
   else<a name='1458'>
     FLXHUM  = ((1.-FGR)*R*FLXHUMR + FGR*R*FLXHUMGR + W*FLXHUMB + RW*FLXHUMG)<a name='1459'>
   endif<a name='1460'>
   FLXUV  = ((1.-FGR)*R*CDR + FGR*R*CDGR + RW*CDC )*UA*UA<a name='1461'>
   FLXG =   ((1.-FGR)*R*G0R + FGR*R*G0GR+ W*G0B + RW*G0G)<a name='1462'>
   LNET =   (1.-FGR) * R * RR + FGR *R* RGR + W * RB +  RW * RG <a name='1463'>
 else<a name='1464'>
   if(ahoption==1) then<a name='1465'>
     FLXTH  = ( R*FLXTHR  + W*FLXTHB  + RW*FLXTHG ) + AH/RHOO/CPP<a name='1466'>
   else<a name='1467'>
     FLXTH  = ( R*FLXTHR  + W*FLXTHB  + RW*FLXTHG )<a name='1468'>
   endif<a name='1469'>
   if(alhoption==1) then<a name='1470'>
     FLXHUM = ( R*FLXHUMR + W*FLXHUMB + RW*FLXHUMG )+ ALH/RHOO/ELL<a name='1471'>
   else<a name='1472'>
     FLXHUM = ( R*FLXHUMR + W*FLXHUMB + RW*FLXHUMG )<a name='1473'>
   endif<a name='1474'>
   FLXUV  = ( R*CDR + RW*CDC )*UA*UA<a name='1475'>
   FLXG =   ( R*G0R + W*G0B + RW*G0G )<a name='1476'>
   LNET =     R*RR + W*RB + RW*RG<a name='1477'>
 endif<a name='1478'>
<a name='1479'>
<font color=#447700>!----------------------------------------------------------------------------<a name='1480'></font>
<font color=#447700>! Convert Unit: FLUXES and u* T* q*  --&gt; WRF<a name='1481'></font>
<font color=#447700>!----------------------------------------------------------------------------<a name='1482'></font>
<a name='1483'>
   SH    = FLXTH  * RHOO * CPP    <font color=#447700>! Sensible heat flux          [W/m/m]<a name='1484'></font>
   LH    = FLXHUM * RHOO * ELL    <font color=#447700>! Latent heat flux            [W/m/m]<a name='1485'></font>
   LH_KINEMATIC = FLXHUM * RHOO   <font color=#447700>! Latent heat, Kinematic      [kg/m/m/s]<a name='1486'></font>
   LW    = LLG - (LNET*697.7*60.) <font color=#447700>! Upward longwave radiation   [W/m/m]<a name='1487'></font>
   SW    = SSG - (SNET*697.7*60.) <font color=#447700>! Upward shortwave radiation  [W/m/m]<a name='1488'></font>
   ALB   = 0.<a name='1489'>
   IF( ABS(SSG) &gt; 0.0001) ALB = SW/SSG <font color=#447700>! Effective albedo [-] <a name='1490'></font>
   G = -FLXG*697.7*60.            <font color=#447700>! [W/m/m]<a name='1491'></font>
   RN = (SNET+LNET)*697.7*60.     <font color=#447700>! Net radiation [W/m/m]<a name='1492'></font>
<a name='1493'>
   UST = SQRT(FLXUV)              <font color=#447700>! u* [m/s]<a name='1494'></font>
   TST = -FLXTH/UST               <font color=#447700>! T* [K]<a name='1495'></font>
   QST = -FLXHUM/UST              <font color=#447700>! q* [-]<a name='1496'></font>
<a name='1497'>
<font color=#447700>!------------------------------------------------------<a name='1498'></font>
<font color=#447700>!  diagnostic GRID AVERAGED  PSIM  PSIH  TS QS --&gt; WRF<a name='1499'></font>
<font color=#447700>!------------------------------------------------------<a name='1500'></font>
<a name='1501'>
   Z0 = Z0C <a name='1502'>
   Z0H = Z0HC<a name='1503'>
   Z = ZA - ZDC<a name='1504'>
   ZNT = Z0   <font color=#447700>! add by Dan Li<a name='1505'></font>
<a name='1506'>
   XXX = 0.4*9.81*Z*TST/TA/UST/UST<a name='1507'>
<a name='1508'>
   IF ( XXX &gt;= 1. ) XXX = 1.<a name='1509'>
   IF ( XXX &lt;= -5. ) XXX = -5.<a name='1510'>
<a name='1511'>
   IF ( XXX &gt; 0 ) THEN<a name='1512'>
     PSIM = -5. * XXX<a name='1513'>
     PSIH = -5. * XXX<a name='1514'>
   ELSE<a name='1515'>
     X = (1.-16.*XXX)**0.25<a name='1516'>
     PSIM = 2.*ALOG((1.+X)/2.) + ALOG((1.+X*X)/2.) - 2.*ATAN(X) + PI/2.<a name='1517'>
     PSIH = 2.*ALOG((1.+X*X)/2.)<a name='1518'>
   END IF<a name='1519'>
<a name='1520'>
   GZ1OZ0 = ALOG(Z/Z0)<a name='1521'>
   CD = 0.4**2./(ALOG(Z/Z0)-PSIM)**2.<a name='1522'>
<font color=#447700>!<a name='1523'></font>
<font color=#447700>!m   CH = 0.4**2./(ALOG(Z/Z0)-PSIM)/(ALOG(Z/Z0H)-PSIH)<a name='1524'></font>
<font color=#447700>!m   CHS = 0.4*UST/(ALOG(Z/Z0H)-PSIH)<a name='1525'></font>
<font color=#447700>!m   TS = TA + FLXTH/CH/UA    ! surface potential temp (flux temp)<a name='1526'></font>
<font color=#447700>!m   QS = QA + FLXHUM/CH/UA   ! surface humidity<a name='1527'></font>
<font color=#447700>!<a name='1528'></font>
   TS = TA + FLXTH/CHS    <font color=#447700>! surface potential temp (flux temp)<a name='1529'></font>
   QS = QA + FLXHUM/CHS   <font color=#447700>! surface humidity<a name='1530'></font>
<a name='1531'>
<font color=#447700>!-------------------------------------------------------<a name='1532'></font>
<font color=#447700>!  diagnostic  GRID AVERAGED  U10  V10  TH2  Q2 --&gt; WRF<a name='1533'></font>
<font color=#447700>!-------------------------------------------------------<a name='1534'></font>
<a name='1535'>
   XXX2 = (2./Z)*XXX<a name='1536'>
   IF ( XXX2 &gt;= 1. ) XXX2 = 1.<a name='1537'>
   IF ( XXX2 &lt;= -5. ) XXX2 = -5.<a name='1538'>
<a name='1539'>
   IF ( XXX2 &gt; 0 ) THEN<a name='1540'>
      PSIM2 = -5. * XXX2<a name='1541'>
      PSIH2 = -5. * XXX2<a name='1542'>
   ELSE<a name='1543'>
      X = (1.-16.*XXX2)**0.25<a name='1544'>
      PSIM2 = 2.*ALOG((1.+X)/2.) + ALOG((1.+X*X)/2.) - 2.*ATAN(X) + 2.*ATAN(1.)<a name='1545'>
      PSIH2 = 2.*ALOG((1.+X*X)/2.)<a name='1546'>
   END IF<a name='1547'>
<font color=#447700>!<a name='1548'></font>
<font color=#447700>!m   CHS2 = 0.4*UST/(ALOG(2./Z0H)-PSIH2)<a name='1549'></font>
<font color=#447700>!<a name='1550'></font>
<a name='1551'>
   XXX10 = (10./Z)*XXX<a name='1552'>
   IF ( XXX10 &gt;= 1. ) XXX10 = 1.<a name='1553'>
   IF ( XXX10 &lt;= -5. ) XXX10 = -5.<a name='1554'>
<a name='1555'>
   IF ( XXX10 &gt; 0 ) THEN<a name='1556'>
      PSIM10 = -5. * XXX10<a name='1557'>
      PSIH10 = -5. * XXX10<a name='1558'>
   ELSE<a name='1559'>
      X = (1.-16.*XXX10)**0.25<a name='1560'>
      PSIM10 = 2.*ALOG((1.+X)/2.) + ALOG((1.+X*X)/2.) - 2.*ATAN(X) + 2.*ATAN(1.)<a name='1561'>
      PSIH10 = 2.*ALOG((1.+X*X)/2.)<a name='1562'>
   END IF<a name='1563'>
<a name='1564'>
   PSIX = ALOG(Z/Z0) - PSIM<a name='1565'>
   PSIT = ALOG(Z/Z0H) - PSIH<a name='1566'>
<a name='1567'>
   PSIX2 = ALOG(2./Z0) - PSIM2<a name='1568'>
   PSIT2 = ALOG(2./Z0H) - PSIH2<a name='1569'>
<a name='1570'>
   PSIX10 = ALOG(10./Z0) - PSIM10<a name='1571'>
   PSIT10 = ALOG(10./Z0H) - PSIH10<a name='1572'>
<a name='1573'>
   U10 = U1 * (PSIX10/PSIX)       <font color=#447700>! u at 10 m [m/s]<a name='1574'></font>
   V10 = V1 * (PSIX10/PSIX)       <font color=#447700>! v at 10 m [m/s]<a name='1575'></font>
<a name='1576'>
<font color=#447700>!   TH2 = TS + (TA-TS)*(PSIT2/PSIT)   ! potential temp at 2 m [K]<a name='1577'></font>
<font color=#447700>!  TH2 = TS + (TA-TS)*(PSIT2/PSIT)   ! Fei: this seems to be temp (not potential) at 2 m [K]<a name='1578'></font>
<font color=#447700>!Fei: consistant with M-O theory<a name='1579'></font>
   TH2 = TS + (TA-TS) *(CHS/CHS2) <a name='1580'>
<a name='1581'>
   Q2 = QS + (QA-QS)*(PSIT2/PSIT)    <font color=#447700>! humidity at 2 m       [-]<a name='1582'></font>
<a name='1583'>
<font color=#447700>!   TS = (LW/SIG_SI/0.88)**0.25       ! Radiative temperature [K]<a name='1584'></font>
<a name='1585'>
   END SUBROUTINE urban<a name='1586'>
<font color=#447700>!===============================================================================<a name='1587'></font>
<font color=#447700>!<a name='1588'></font>
<font color=#447700>!  mos<a name='1589'></font>
<font color=#447700>!<a name='1590'></font>
<font color=#447700>!===============================================================================<a name='1591'></font>
<A NAME='MOS'><A href='../../html_code/phys/module_sf_urban.F.html#MOS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1592'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>mos</font>(XXX,ALPHA,CD,B1,RIB,Z,Z0,UA,TA,TSF,RHO) <A href='../../call_to/MOS.html' TARGET='index'>2</A><a name='1593'>
<a name='1594'>
<font color=#447700>!  XXX:   z/L (requires iteration by Newton-Rapson method)<a name='1595'></font>
<font color=#447700>!  B1:    Stanton number<a name='1596'></font>
<font color=#447700>!  PSIM:  = PSIX of LSM<a name='1597'></font>
<font color=#447700>!  PSIH:  = PSIT of LSM<a name='1598'></font>
<a name='1599'>
   IMPLICIT NONE<a name='1600'>
<a name='1601'>
   REAL, PARAMETER     :: CP=0.24<a name='1602'>
   REAL, INTENT(IN)    :: B1, Z, Z0, UA, TA, TSF, RHO<a name='1603'>
   REAL, INTENT(OUT)   :: ALPHA, CD<a name='1604'>
   REAL, INTENT(INOUT) :: XXX, RIB<a name='1605'>
   REAL                :: XXX0, X, X0, FAIH, DPSIM, DPSIH<a name='1606'>
   REAL                :: F, DF, XXXP, US, TS, AL, XKB, DD, PSIM, PSIH<a name='1607'>
   INTEGER             :: NEWT<a name='1608'>
   INTEGER, PARAMETER  :: NEWT_END=10<a name='1609'>
<a name='1610'>
   IF(RIB &lt;= -15.) RIB=-15. <a name='1611'>
<a name='1612'>
   IF(RIB &lt; 0.) THEN<a name='1613'>
<a name='1614'>
      DO NEWT=1,NEWT_END<a name='1615'>
<a name='1616'>
        IF(XXX &gt;= 0.) XXX=-1.E-3<a name='1617'>
<a name='1618'>
        XXX0=XXX*Z0/(Z+Z0)<a name='1619'>
<a name='1620'>
        X=(1.-16.*XXX)**0.25<a name='1621'>
        X0=(1.-16.*XXX0)**0.25<a name='1622'>
<a name='1623'>
        PSIM=ALOG((Z+Z0)/Z0) &amp;<a name='1624'>
            -ALOG((X+1.)**2.*(X**2.+1.)) &amp;<a name='1625'>
            +2.*ATAN(X) &amp;<a name='1626'>
            +ALOG((X+1.)**2.*(X0**2.+1.)) &amp;<a name='1627'>
            -2.*ATAN(X0)<a name='1628'>
        FAIH=1./SQRT(1.-16.*XXX)<a name='1629'>
        PSIH=ALOG((Z+Z0)/Z0)+0.4*B1 &amp;<a name='1630'>
            -2.*ALOG(SQRT(1.-16.*XXX)+1.) &amp;<a name='1631'>
            +2.*ALOG(SQRT(1.-16.*XXX0)+1.)<a name='1632'>
<a name='1633'>
        DPSIM=(1.-16.*XXX)**(-0.25)/XXX &amp;<a name='1634'>
             -(1.-16.*XXX0)**(-0.25)/XXX<a name='1635'>
        DPSIH=1./SQRT(1.-16.*XXX)/XXX &amp;<a name='1636'>
             -1./SQRT(1.-16.*XXX0)/XXX<a name='1637'>
<a name='1638'>
        F=RIB*PSIM**2./PSIH-XXX<a name='1639'>
<a name='1640'>
        DF=RIB*(2.*DPSIM*PSIM*PSIH-DPSIH*PSIM**2.) &amp;<a name='1641'>
          /PSIH**2.-1.<a name='1642'>
<a name='1643'>
        XXXP=XXX<a name='1644'>
        XXX=XXXP-F/DF<a name='1645'>
        IF(XXX &lt;= -10.) XXX=-10.<a name='1646'>
<a name='1647'>
      END DO<a name='1648'>
<a name='1649'>
   ELSE IF(RIB &gt;= 0.142857) THEN<a name='1650'>
<a name='1651'>
      XXX=0.714<a name='1652'>
      PSIM=ALOG((Z+Z0)/Z0)+7.*XXX<a name='1653'>
      PSIH=PSIM+0.4*B1<a name='1654'>
<a name='1655'>
   ELSE<a name='1656'>
<a name='1657'>
      AL=ALOG((Z+Z0)/Z0)<a name='1658'>
      XKB=0.4*B1<a name='1659'>
      DD=-4.*RIB*7.*XKB*AL+(AL+XKB)**2.<a name='1660'>
      IF(DD &lt;= 0.) DD=0.<a name='1661'>
      XXX=(AL+XKB-2.*RIB*7.*AL-SQRT(DD))/(2.*(RIB*7.**2-7.))<a name='1662'>
      PSIM=ALOG((Z+Z0)/Z0)+7.*MIN(XXX,0.714)<a name='1663'>
      PSIH=PSIM+0.4*B1<a name='1664'>
<a name='1665'>
   END IF<a name='1666'>
<a name='1667'>
   US=0.4*UA/PSIM             <font color=#447700>! u*<a name='1668'></font>
   IF(US &lt;= 0.01) US=0.01<a name='1669'>
   TS=0.4*(TA-TSF)/PSIH       <font color=#447700>! T*<a name='1670'></font>
<a name='1671'>
   CD=US*US/UA**2.            <font color=#447700>! CD<a name='1672'></font>
   ALPHA=RHO*CP*0.4*US/PSIH   <font color=#447700>! RHO*CP*CH*U<a name='1673'></font>
<a name='1674'>
   RETURN <a name='1675'>
   END SUBROUTINE mos<a name='1676'>
<font color=#447700>!===============================================================================<a name='1677'></font>
<font color=#447700>!<a name='1678'></font>
<font color=#447700>!  louis79<a name='1679'></font>
<font color=#447700>!<a name='1680'></font>
<font color=#447700>!===============================================================================<a name='1681'></font>
<A NAME='LOUIS79'><A href='../../html_code/phys/module_sf_urban.F.html#LOUIS79' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1682'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>louis79</font>(ALPHA,CD,RIB,Z,Z0,UA,RHO)<a name='1683'>
<a name='1684'>
   IMPLICIT NONE<a name='1685'>
<a name='1686'>
   REAL, PARAMETER     :: CP=0.24<a name='1687'>
   REAL, INTENT(IN)    :: Z, Z0, UA, RHO<a name='1688'>
   REAL, INTENT(OUT)   :: ALPHA, CD<a name='1689'>
   REAL, INTENT(INOUT) :: RIB<a name='1690'>
   REAL                :: A2, XX, CH, CMB, CHB<a name='1691'>
<a name='1692'>
   A2=(0.4/ALOG(Z/Z0))**2.<a name='1693'>
<a name='1694'>
   IF(RIB &lt;= -15.) RIB=-15.<a name='1695'>
<a name='1696'>
   IF(RIB &gt;= 0.0) THEN<a name='1697'>
      IF(RIB &gt;= 0.142857) THEN <a name='1698'>
         XX=0.714<a name='1699'>
      ELSE <a name='1700'>
         XX=RIB*LOG(Z/Z0)/(1.-7.*RIB)<a name='1701'>
      END IF <a name='1702'>
      CH=0.16/0.74/(LOG(Z/Z0)+7.*MIN(XX,0.714))**2.<a name='1703'>
      CD=0.16/(LOG(Z/Z0)+7.*MIN(XX,0.714))**2.<a name='1704'>
   ELSE <a name='1705'>
      CMB=7.4*A2*9.4*SQRT(Z/Z0)<a name='1706'>
      CHB=5.3*A2*9.4*SQRT(Z/Z0)<a name='1707'>
      CH=A2/0.74*(1.-9.4*RIB/(1.+CHB*SQRT(-RIB)))<a name='1708'>
      CD=A2*(1.-9.4*RIB/(1.+CHB*SQRT(-RIB)))<a name='1709'>
   END IF<a name='1710'>
<a name='1711'>
   ALPHA=RHO*CP*CH*UA<a name='1712'>
<a name='1713'>
   RETURN <a name='1714'>
   END SUBROUTINE louis79<a name='1715'>
<font color=#447700>!===============================================================================<a name='1716'></font>
<font color=#447700>!<a name='1717'></font>
<font color=#447700>!  louis82<a name='1718'></font>
<font color=#447700>!<a name='1719'></font>
<font color=#447700>!===============================================================================<a name='1720'></font>
<A NAME='LOUIS82'><A href='../../html_code/phys/module_sf_urban.F.html#LOUIS82' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1721'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>louis82</font>(ALPHA,CD,RIB,Z,Z0,UA,RHO)<a name='1722'>
<a name='1723'>
   IMPLICIT NONE<a name='1724'>
<a name='1725'>
   REAL, PARAMETER     :: CP=0.24<a name='1726'>
   REAL, INTENT(IN)    :: Z, Z0, UA, RHO<a name='1727'>
   REAL, INTENT(OUT)   :: ALPHA, CD<a name='1728'>
   REAL, INTENT(INOUT) :: RIB <a name='1729'>
   REAL                :: A2, FM, FH, CH, CHH <a name='1730'>
<a name='1731'>
   A2=(0.4/ALOG(Z/Z0))**2.<a name='1732'>
<a name='1733'>
   IF(RIB &lt;= -15.) RIB=-15.<a name='1734'>
<a name='1735'>
   IF(RIB &gt;= 0.0) THEN <a name='1736'>
      FM=1./((1.+(2.*5.*RIB)/SQRT(1.+5.*RIB)))<a name='1737'>
      FH=1./(1.+(3.*5.*RIB)*SQRT(1.+5.*RIB))<a name='1738'>
      CH=A2*FH<a name='1739'>
      CD=A2*FM<a name='1740'>
   ELSE <a name='1741'>
      CHH=5.*3.*5.*A2*SQRT(Z/Z0)<a name='1742'>
      FM=1.-(2.*5.*RIB)/(1.+3.*5.*5.*A2*SQRT(Z/Z0+1.)*(-RIB))<a name='1743'>
      FH=1.-(3.*5.*RIB)/(1.+CHH*SQRT(-RIB))<a name='1744'>
      CH=A2*FH<a name='1745'>
      CD=A2*FM<a name='1746'>
   END IF<a name='1747'>
<a name='1748'>
   ALPHA=RHO*CP*CH*UA<a name='1749'>
<a name='1750'>
   RETURN<a name='1751'>
   END SUBROUTINE louis82<a name='1752'>
<font color=#447700>!===============================================================================<a name='1753'></font>
<font color=#447700>!<a name='1754'></font>
<font color=#447700>!  multi_layer<a name='1755'></font>
<font color=#447700>!<a name='1756'></font>
<font color=#447700>!===============================================================================<a name='1757'></font>
<A NAME='MULTI_LAYER'><A href='../../html_code/phys/module_sf_urban.F.html#MULTI_LAYER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1758'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>multi_layer</font>(KM,BOUND,G0,CAP,AKS,TSL,DZ,DELT,TSLEND) <A href='../../call_to/MULTI_LAYER.html' TARGET='index'>3</A>,<A href='../../call_from/MULTI_LAYER.html' TARGET='index'>1</A><a name='1759'>
<a name='1760'>
   IMPLICIT NONE<a name='1761'>
<a name='1762'>
   REAL, INTENT(IN)                   :: G0<a name='1763'>
<a name='1764'>
   REAL, INTENT(IN)                   :: CAP<a name='1765'>
<a name='1766'>
   REAL, INTENT(IN)                   :: AKS<a name='1767'>
<a name='1768'>
   REAL, INTENT(IN)                   :: DELT      <font color=#447700>! Time step [ s ]<a name='1769'></font>
<a name='1770'>
   REAL, INTENT(IN)                   :: TSLEND<a name='1771'>
<a name='1772'>
   INTEGER, INTENT(IN)                :: KM<a name='1773'>
<a name='1774'>
   INTEGER, INTENT(IN)                :: BOUND<a name='1775'>
<a name='1776'>
   REAL, DIMENSION(KM), INTENT(IN)    :: DZ<a name='1777'>
<a name='1778'>
   REAL, DIMENSION(KM), INTENT(INOUT) :: TSL<a name='1779'>
<a name='1780'>
   REAL, DIMENSION(KM)                :: A, B, C, D, X, P, Q<a name='1781'>
<a name='1782'>
   REAL                               :: DZEND<a name='1783'>
<a name='1784'>
   INTEGER                            :: K<a name='1785'>
<a name='1786'>
   DZEND=DZ(KM)<a name='1787'>
<a name='1788'>
   A(1) = 0.0<a name='1789'>
<a name='1790'>
   B(1) = CAP*DZ(1)/DELT &amp;<a name='1791'>
          +2.*AKS/(DZ(1)+DZ(2))<a name='1792'>
   C(1) = -2.*AKS/(DZ(1)+DZ(2))<a name='1793'>
   D(1) = CAP*DZ(1)/DELT*TSL(1) + G0<a name='1794'>
<a name='1795'>
   DO K=2,KM-1<a name='1796'>
      A(K) = -2.*AKS/(DZ(K-1)+DZ(K))<a name='1797'>
      B(K) = CAP*DZ(K)/DELT + 2.*AKS/(DZ(K-1)+DZ(K)) + 2.*AKS/(DZ(K)+DZ(K+1)) <a name='1798'>
      C(K) = -2.*AKS/(DZ(K)+DZ(K+1))<a name='1799'>
      D(K) = CAP*DZ(K)/DELT*TSL(K)<a name='1800'>
   END DO <a name='1801'>
<a name='1802'>
   IF(BOUND == 1) THEN                  <font color=#447700>! Flux=0<a name='1803'></font>
      A(KM) = -2.*AKS/(DZ(KM-1)+DZ(KM))<a name='1804'>
      B(KM) = CAP*DZ(KM)/DELT + 2.*AKS/(DZ(KM-1)+DZ(KM))  <a name='1805'>
      C(KM) = 0.0<a name='1806'>
      D(KM) = CAP*DZ(KM)/DELT*TSL(KM)<a name='1807'>
   ELSE                                 <font color=#447700>! T=constant<a name='1808'></font>
      A(KM) = -2.*AKS/(DZ(KM-1)+DZ(KM))<a name='1809'>
      B(KM) = CAP*DZ(KM)/DELT + 2.*AKS/(DZ(KM-1)+DZ(KM)) + 2.*AKS/(DZ(KM)+DZEND) <a name='1810'>
      C(KM) = 0.0<a name='1811'>
      D(KM) = CAP*DZ(KM)/DELT*TSL(KM) + 2.*AKS*TSLEND/(DZ(KM)+DZEND)<a name='1812'>
   END IF <a name='1813'>
<a name='1814'>
   P(1) = -C(1)/B(1)<a name='1815'>
   Q(1) =  <A href='../../html_code/share/dfi.F.html#D'>D</A><A href='../../html_code/phys/module_sf_urban.F.html#MULTI_LAYER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_21">(1)/B(1)<a name='1816'>
<a name='1817'>
   DO K=2,KM<a name='1818'>
      P(K) = -C(K)/(A(K)*P(K-1)+B(K))<a name='1819'>
      Q(K) = (-A(K)*Q(K-1)+D(K))/(A(K)*P(K-1)+B(K))<a name='1820'>
   END DO <a name='1821'>
<a name='1822'>
   X(KM) = Q(KM)<a name='1823'>
<a name='1824'>
   DO K=KM-1,1,-1<a name='1825'>
      X(K) = P(K)*X(K+1)+Q(K)<a name='1826'>
   END DO <a name='1827'>
<a name='1828'>
   DO K=1,KM<a name='1829'>
      TSL(K) = X(K)<a name='1830'>
   END DO <a name='1831'>
<a name='1832'>
   RETURN <a name='1833'>
   END SUBROUTINE multi_layer<a name='1834'>
<font color=#447700>!===============================================================================<a name='1835'></font>
<font color=#447700>!<a name='1836'></font>
<font color=#447700>!  subroutine read_param<a name='1837'></font>
<font color=#447700>!<a name='1838'></font>
<font color=#447700>!===============================================================================<a name='1839'></font>
<A NAME='READ_PARAM'><A href='../../html_code/phys/module_sf_urban.F.html#READ_PARAM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1840'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>read_param</font>(UTYPE,                                        &amp; <font color=#447700>! in <A href='../../call_to/READ_PARAM.html' TARGET='index'>1</A><a name='1841'></font>
                         ZR,SIGMA_ZED,Z0C,Z0HC,ZDC,SVF,R,RW,HGT,AH,    &amp; <font color=#447700>! out<a name='1842'></font>
                         CAPR,CAPB,CAPG,AKSR,AKSB,AKSG,ALBR,ALBB,ALBG, &amp; <font color=#447700>! out<a name='1843'></font>
                         EPSR,EPSB,EPSG,Z0R,Z0B,Z0G,Z0HB,Z0HG,         &amp; <font color=#447700>! out<a name='1844'></font>
                         BETR,BETB,BETG,TRLEND,TBLEND,TGLEND,          &amp; <font color=#447700>! out<a name='1845'></font>
<font color=#447700>!for BEP<a name='1846'></font>
                         NUMDIR, STREET_DIRECTION, STREET_WIDTH,       &amp; <font color=#447700>! out<a name='1847'></font>
                         BUILDING_WIDTH, NUMHGT, HEIGHT_BIN,           &amp; <font color=#447700>! out<a name='1848'></font>
                         HPERCENT_BIN,                                 &amp; <font color=#447700>! out<a name='1849'></font>
<font color=#447700>!end BEP<a name='1850'></font>
                         BOUNDR,BOUNDB,BOUNDG,CH_SCHEME,TS_SCHEME,     &amp; <font color=#447700>! out<a name='1851'></font>
                         AKANDA_URBAN,ALH)         <font color=#447700>! out<a name='1852'></font>
<a name='1853'>
   INTEGER, INTENT(IN)  :: UTYPE <a name='1854'>
<a name='1855'>
   REAL, INTENT(OUT)    :: ZR,Z0C,Z0HC,ZDC,SVF,R,RW,HGT,AH,ALH,          &amp;<a name='1856'>
                           CAPR,CAPB,CAPG,AKSR,AKSB,AKSG,ALBR,ALBB,ALBG, &amp;<a name='1857'>
                           SIGMA_ZED,                                    &amp;<a name='1858'>
                           EPSR,EPSB,EPSG,Z0R,Z0B,Z0G,Z0HB,Z0HG,         &amp;<a name='1859'>
                           BETR,BETB,BETG,TRLEND,TBLEND,TGLEND<a name='1860'>
   REAL, INTENT(OUT)    :: AKANDA_URBAN<a name='1861'>
<font color=#447700>!for BEP<a name='1862'></font>
   INTEGER,                     INTENT(OUT) :: NUMDIR<a name='1863'>
   REAL,    DIMENSION(MAXDIRS), INTENT(OUT) :: STREET_DIRECTION<a name='1864'>
   REAL,    DIMENSION(MAXDIRS), INTENT(OUT) :: STREET_WIDTH<a name='1865'>
   REAL,    DIMENSION(MAXDIRS), INTENT(OUT) :: BUILDING_WIDTH<a name='1866'>
   INTEGER,                     INTENT(OUT) :: NUMHGT<a name='1867'>
   REAL,    DIMENSION(MAXHGTS), INTENT(OUT) :: HEIGHT_BIN<a name='1868'>
   REAL,    DIMENSION(MAXHGTS), INTENT(OUT) :: HPERCENT_BIN<a name='1869'>
   <a name='1870'>
<font color=#447700>!end BEP<a name='1871'></font>
<a name='1872'>
   INTEGER, INTENT(OUT) :: BOUNDR,BOUNDB,BOUNDG,CH_SCHEME,TS_SCHEME<a name='1873'>
<a name='1874'>
   ZR =     ZR_TBL(UTYPE)<a name='1875'>
   SIGMA_ZED = SIGMA_ZED_TBL(UTYPE)<a name='1876'>
   Z0C=     Z0C_TBL(UTYPE)<a name='1877'>
   Z0HC=    Z0HC_TBL(UTYPE)<a name='1878'>
   ZDC=     ZDC_TBL(UTYPE)<a name='1879'>
   SVF=     SVF_TBL(UTYPE)<a name='1880'>
   R=       R_TBL(UTYPE)<a name='1881'>
   RW=      RW_TBL(UTYPE)<a name='1882'>
   HGT=     HGT_TBL(UTYPE)<a name='1883'>
   AH=      AH_TBL(UTYPE)<a name='1884'>
   ALH=     ALH_TBL(UTYPE)<a name='1885'>
   BETR=    BETR_TBL(UTYPE)<a name='1886'>
   BETB=    BETB_TBL(UTYPE)<a name='1887'>
   BETG=    BETG_TBL(UTYPE)<a name='1888'>
<a name='1889'>
<font color=#447700>!m   FRC_URB= FRC_URB_TBL(UTYPE)<a name='1890'></font>
<a name='1891'>
   CAPR=    CAPR_TBL(UTYPE)<a name='1892'>
   CAPB=    CAPB_TBL(UTYPE)<a name='1893'>
   CAPG=    CAPG_TBL(UTYPE)<a name='1894'>
   AKSR=    AKSR_TBL(UTYPE)<a name='1895'>
   AKSB=    AKSB_TBL(UTYPE)<a name='1896'>
   AKSG=    AKSG_TBL(UTYPE)<a name='1897'>
   ALBR=    ALBR_TBL(UTYPE)<a name='1898'>
   ALBB=    ALBB_TBL(UTYPE)<a name='1899'>
   ALBG=    ALBG_TBL(UTYPE)<a name='1900'>
   EPSR=    EPSR_TBL(UTYPE)<a name='1901'>
   EPSB=    EPSB_TBL(UTYPE)<a name='1902'>
   EPSG=    EPSG_TBL(UTYPE)<a name='1903'>
   Z0R=     Z0R_TBL(UTYPE)<a name='1904'>
   Z0B=     Z0B_TBL(UTYPE)<a name='1905'>
   Z0G=     Z0G_TBL(UTYPE)<a name='1906'>
   Z0HB=    Z0HB_TBL(UTYPE)<a name='1907'>
   Z0HG=    Z0HG_TBL(UTYPE)<a name='1908'>
   TRLEND=  TRLEND_TBL(UTYPE)<a name='1909'>
   TBLEND=  TBLEND_TBL(UTYPE)<a name='1910'>
   TGLEND=  TGLEND_TBL(UTYPE)<a name='1911'>
   BOUNDR=  BOUNDR_DATA<a name='1912'>
   BOUNDB=  BOUNDB_DATA<a name='1913'>
   BOUNDG=  BOUNDG_DATA<a name='1914'>
   CH_SCHEME = CH_SCHEME_DATA<a name='1915'>
   TS_SCHEME = TS_SCHEME_DATA<a name='1916'>
   AKANDA_URBAN = AKANDA_URBAN_TBL(UTYPE)<a name='1917'>
<a name='1918'>
<font color=#447700>!for BEP<a name='1919'></font>
<a name='1920'>
   STREET_DIRECTION = -1.E36<a name='1921'>
   STREET_WIDTH     = -1.E36<a name='1922'>
   BUILDING_WIDTH   = -1.E36<a name='1923'>
   HEIGHT_BIN       = -1.E36<a name='1924'>
   HPERCENT_BIN     = -1.E36<a name='1925'>
<a name='1926'>
   NUMDIR                     = NUMDIR_TBL ( UTYPE )<a name='1927'>
   STREET_DIRECTION(1:NUMDIR) = STREET_DIRECTION_TBL( 1:NUMDIR, UTYPE )<a name='1928'>
   STREET_WIDTH    (1:NUMDIR) = STREET_WIDTH_TBL    ( 1:NUMDIR, UTYPE )<a name='1929'>
   BUILDING_WIDTH  (1:NUMDIR) = BUILDING_WIDTH_TBL  ( 1:NUMDIR, UTYPE )<a name='1930'>
   NUMHGT                     = NUMHGT_TBL ( UTYPE )<a name='1931'>
   HEIGHT_BIN      (1:NUMHGT) = HEIGHT_BIN_TBL   ( 1:NUMHGT , UTYPE )<a name='1932'>
   HPERCENT_BIN    (1:NUMHGT) = HPERCENT_BIN_TBL ( 1:NUMHGT , UTYPE )<a name='1933'>
<a name='1934'>
<font color=#447700>!end BEP<a name='1935'></font>
   END SUBROUTINE read_param<a name='1936'>
<font color=#447700>!===============================================================================<a name='1937'></font>
<font color=#447700>!<a name='1938'></font>
<font color=#447700>! subroutine urban_param_init: Read parameters from URBPARM.TBL<a name='1939'></font>
<font color=#447700>!<a name='1940'></font>
<font color=#447700>!===============================================================================<a name='1941'></font>
<A NAME='URBAN_PARAM_INIT'><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1942'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>urban_param_init</font>(DZR,DZB,DZG,num_soil_layers, &amp; <A href='../../call_to/URBAN_PARAM_INIT.html' TARGET='index'>2</A>,<A href='../../call_from/URBAN_PARAM_INIT.html' TARGET='index'>62</A><a name='1943'>
                               sf_urban_physics)<a name='1944'>
<font color=#447700>!                              num_roof_layers,num_wall_layers,num_road_layers)<a name='1945'></font>
<a name='1946'>
   IMPLICIT NONE<a name='1947'>
<a name='1948'>
   INTEGER, INTENT(IN) :: num_soil_layers<a name='1949'>
<a name='1950'>
<font color=#447700>!   REAL, DIMENSION(1:num_roof_layers), INTENT(INOUT) :: DZR<a name='1951'></font>
<font color=#447700>!   REAL, DIMENSION(1:num_wall_layers), INTENT(INOUT) :: DZB<a name='1952'></font>
<font color=#447700>!   REAL, DIMENSION(1:num_road_layers), INTENT(INOUT) :: DZG<a name='1953'></font>
   REAL, DIMENSION(1:num_soil_layers), INTENT(INOUT) :: DZR<a name='1954'>
   REAL, DIMENSION(1:num_soil_layers), INTENT(INOUT) :: DZB<a name='1955'>
   REAL, DIMENSION(1:num_soil_layers), INTENT(INOUT) :: DZG<a name='1956'>
   INTEGER,                            INTENT(IN)    :: SF_URBAN_PHYSICS<a name='1957'>
<a name='1958'>
   INTEGER :: LC, K<a name='1959'>
   INTEGER :: IOSTATUS, ALLOCATE_STATUS<a name='1960'>
   INTEGER :: num_roof_layers<a name='1961'>
   INTEGER :: num_wall_layers<a name='1962'>
   INTEGER :: num_road_layers<a name='1963'>
   INTEGER :: dummy <a name='1964'>
   REAL    :: DHGT, HGT, VFWS, VFGS<a name='1965'>
<a name='1966'>
   REAL, allocatable, dimension(:) :: ROOF_WIDTH<a name='1967'>
   REAL, allocatable, dimension(:) :: ROAD_WIDTH<a name='1968'>
<a name='1969'>
   character(len=512) :: string<a name='1970'>
   character(len=128) :: name<a name='1971'>
   integer :: indx<a name='1972'>
<a name='1973'>
   real, parameter :: VonK = 0.4<a name='1974'>
   real :: lambda_p<a name='1975'>
   real :: lambda_f<a name='1976'>
   real :: Cd<a name='1977'>
   real :: alpha_macd<a name='1978'>
   real :: beta_macd<a name='1979'>
   real :: lambda_fr<a name='1980'>
<a name='1981'>
<a name='1982'>
<font color=#447700>!for BEP<a name='1983'></font>
   real :: dummy_hgt<a name='1984'>
   real :: dummy_pct<a name='1985'>
   real :: pctsum<a name='1986'>
<font color=#447700>!end BEP<a name='1987'></font>
   num_roof_layers = num_soil_layers<a name='1988'>
   num_wall_layers = num_soil_layers<a name='1989'>
   num_road_layers = num_soil_layers<a name='1990'>
<a name='1991'>
<a name='1992'>
   ICATE=0<a name='1993'>
<a name='1994'>
   OPEN (UNIT=11,                &amp;<a name='1995'>
         FILE='URBPARM.TBL', &amp;<a name='1996'>
         ACCESS='SEQUENTIAL',    &amp;<a name='1997'>
         STATUS='OLD',           &amp;<a name='1998'>
         ACTION='READ',          &amp;<a name='1999'>
         POSITION='REWIND',      &amp;<a name='2000'>
         IOSTAT=IOSTATUS)<a name='2001'>
<a name='2002'>
   IF (IOSTATUS &gt; 0) THEN<a name='2003'>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1211">('ERROR OPEN URBPARM.TBL')<a name='2004'>
   ENDIF<a name='2005'>
<a name='2006'>
   READLOOP : do <a name='2007'>
      read(11,'(A512)', iostat=iostatus) string<a name='2008'>
      if (iostatus /= 0) exit READLOOP<a name='2009'>
      if (string(1:1) == "#") cycle READLOOP<a name='2010'>
      if (trim(string) == "") cycle READLOOP<a name='2011'>
      indx = index(string,":")<a name='2012'>
      if (indx &lt;= 0) cycle READLOOP<a name='2013'>
      name = trim(adjustl(string(1:indx-1)))<a name='2014'>
      <a name='2015'>
      <font color=#447700>! Here are the variables we expect to be defined in the URBPARM.TBL:<a name='2016'></font>
      if (name == "Number of urban categories") then<a name='2017'>
         read(string(indx+1:),*) icate<a name='2018'>
         IF (.not. ALLOCATED(ZR_TBL)) then<a name='2019'>
            ALLOCATE( ZR_TBL(ICATE), stat=allocate_status )<a name='2020'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1212">('Error allocating ZR_TBL in urban_param_init')<a name='2021'>
            ALLOCATE( SIGMA_ZED_TBL(ICATE), stat=allocate_status )<a name='2022'>
            if(allocate_status /= 0)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1213">('Error allocating SIGMA_ZED_TBL in urban_param_init')<a name='2023'>
            ALLOCATE( Z0C_TBL(ICATE), stat=allocate_status )<a name='2024'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1214">('Error allocating Z0C_TBL in urban_param_init')<a name='2025'>
            ALLOCATE( Z0HC_TBL(ICATE), stat=allocate_status ) <a name='2026'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1215">('Error allocating Z0HC_TBL in urban_param_init')<a name='2027'>
            ALLOCATE( ZDC_TBL(ICATE), stat=allocate_status )<a name='2028'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1216">('Error allocating ZDC_TBL in urban_param_init')<a name='2029'>
            ALLOCATE( SVF_TBL(ICATE), stat=allocate_status ) <a name='2030'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1217">('Error allocating SVF_TBL in urban_param_init')<a name='2031'>
            ALLOCATE( R_TBL(ICATE), stat=allocate_status )<a name='2032'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1218">('Error allocating R_TBL in urban_param_init')<a name='2033'>
            ALLOCATE( RW_TBL(ICATE), stat=allocate_status )<a name='2034'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1219">('Error allocating RW_TBL in urban_param_init')<a name='2035'>
            ALLOCATE( HGT_TBL(ICATE), stat=allocate_status )<a name='2036'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1220">('Error allocating HGT_TBL in urban_param_init')<a name='2037'>
            ALLOCATE( AH_TBL(ICATE), stat=allocate_status )<a name='2038'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1221">('Error allocating AH_TBL in urban_param_init')<a name='2039'>
            ALLOCATE( ALH_TBL(ICATE), stat=allocate_status )<a name='2040'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1222">('Error allocating ALH_TBL in urban_param_init')<a name='2041'>
            ALLOCATE( BETR_TBL(ICATE), stat=allocate_status )<a name='2042'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1223">('Error allocating BETR_TBL in urban_param_init')<a name='2043'>
            ALLOCATE( BETB_TBL(ICATE), stat=allocate_status )<a name='2044'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1224">('Error allocating BETB_TBL in urban_param_init')<a name='2045'>
            ALLOCATE( BETG_TBL(ICATE), stat=allocate_status )<a name='2046'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1225">('Error allocating BETG_TBL in urban_param_init')<a name='2047'>
            ALLOCATE( CAPR_TBL(ICATE), stat=allocate_status )<a name='2048'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1226">('Error allocating CAPR_TBL in urban_param_init')<a name='2049'>
            ALLOCATE( CAPB_TBL(ICATE), stat=allocate_status )<a name='2050'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1227">('Error allocating CAPB_TBL in urban_param_init')<a name='2051'>
            ALLOCATE( CAPG_TBL(ICATE), stat=allocate_status )<a name='2052'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1228">('Error allocating CAPG_TBL in urban_param_init')<a name='2053'>
            ALLOCATE( AKSR_TBL(ICATE), stat=allocate_status )<a name='2054'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1229">('Error allocating AKSR_TBL in urban_param_init')<a name='2055'>
            ALLOCATE( AKSB_TBL(ICATE), stat=allocate_status )<a name='2056'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1230">('Error allocating AKSB_TBL in urban_param_init')<a name='2057'>
            ALLOCATE( AKSG_TBL(ICATE), stat=allocate_status )<a name='2058'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1231">('Error allocating AKSG_TBL in urban_param_init')<a name='2059'>
            ALLOCATE( ALBR_TBL(ICATE), stat=allocate_status )<a name='2060'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1232">('Error allocating ALBR_TBL in urban_param_init')<a name='2061'>
            ALLOCATE( ALBB_TBL(ICATE), stat=allocate_status )<a name='2062'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1233">('Error allocating ALBB_TBL in urban_param_init')<a name='2063'>
            ALLOCATE( ALBG_TBL(ICATE), stat=allocate_status )<a name='2064'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1234">('Error allocating ALBG_TBL in urban_param_init')<a name='2065'>
            ALLOCATE( EPSR_TBL(ICATE), stat=allocate_status )<a name='2066'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1235">('Error allocating EPSR_TBL in urban_param_init')<a name='2067'>
            ALLOCATE( EPSB_TBL(ICATE), stat=allocate_status )<a name='2068'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1236">('Error allocating EPSB_TBL in urban_param_init')<a name='2069'>
            ALLOCATE( EPSG_TBL(ICATE), stat=allocate_status )<a name='2070'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1237">('Error allocating EPSG_TBL in urban_param_init')<a name='2071'>
            ALLOCATE( Z0R_TBL(ICATE), stat=allocate_status )<a name='2072'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1238">('Error allocating Z0R_TBL in urban_param_init')<a name='2073'>
            ALLOCATE( Z0B_TBL(ICATE), stat=allocate_status )<a name='2074'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1239">('Error allocating Z0B_TBL in urban_param_init')<a name='2075'>
            ALLOCATE( Z0G_TBL(ICATE), stat=allocate_status )<a name='2076'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1240">('Error allocating Z0G_TBL in urban_param_init')<a name='2077'>
            ALLOCATE( AKANDA_URBAN_TBL(ICATE), stat=allocate_status )<a name='2078'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1241">('Error allocating AKANDA_URBAN_TBL in urban_param_init')<a name='2079'>
            ALLOCATE( Z0HB_TBL(ICATE), stat=allocate_status )<a name='2080'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1242">('Error allocating Z0HB_TBL in urban_param_init')<a name='2081'>
            ALLOCATE( Z0HG_TBL(ICATE), stat=allocate_status )<a name='2082'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1243">('Error allocating Z0HG_TBL in urban_param_init')<a name='2083'>
            ALLOCATE( TRLEND_TBL(ICATE), stat=allocate_status )<a name='2084'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1244">('Error allocating TRLEND_TBL in urban_param_init')<a name='2085'>
            ALLOCATE( TBLEND_TBL(ICATE), stat=allocate_status )<a name='2086'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1245">('Error allocating TBLEND_TBL in urban_param_init')<a name='2087'>
            ALLOCATE( TGLEND_TBL(ICATE), stat=allocate_status )<a name='2088'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1246">('Error allocating TGLEND_TBL in urban_param_init')<a name='2089'>
            ALLOCATE( FRC_URB_TBL(ICATE), stat=allocate_status )<a name='2090'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1247">('Error allocating FRC_URB_TBL in urban_param_init')<a name='2091'>
            <font color=#447700>! ALLOCATE( ROOF_WIDTH(ICATE), stat=allocate_status )<a name='2092'></font>
            <font color=#447700>! if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1248">('Error allocating ROOF_WIDTH in urban_param_init')<a name='2093'></font>
            <font color=#447700>! ALLOCATE( ROAD_WIDTH(ICATE), stat=allocate_status )<a name='2094'></font>
            <font color=#447700>! if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1249">('Error allocating ROAD_WIDTH in urban_param_init')<a name='2095'></font>
            <font color=#447700>!for BEP<a name='2096'></font>
            ALLOCATE( NUMDIR_TBL(ICATE), stat=allocate_status )<a name='2097'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1250">('Error allocating NUMDIR_TBL in urban_param_init')<a name='2098'>
            ALLOCATE( STREET_DIRECTION_TBL(MAXDIRS , ICATE), stat=allocate_status )<a name='2099'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1251">('Error allocating STREET_DIRECTION_TBL in urban_param_init')<a name='2100'>
            ALLOCATE( STREET_WIDTH_TBL(MAXDIRS , ICATE), stat=allocate_status )<a name='2101'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1252">('Error allocating STREET_WIDTH_TBL in urban_param_init')<a name='2102'>
            ALLOCATE( BUILDING_WIDTH_TBL(MAXDIRS , ICATE), stat=allocate_status )<a name='2103'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1253">('Error allocating BUILDING_WIDTH_TBL in urban_param_init')<a name='2104'>
            ALLOCATE( NUMHGT_TBL(ICATE), stat=allocate_status )<a name='2105'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1254">('Error allocating NUMHGT_TBL in urban_param_init')<a name='2106'>
            ALLOCATE( HEIGHT_BIN_TBL(MAXHGTS , ICATE), stat=allocate_status )<a name='2107'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1255">('Error allocating HEIGHT_BIN_TBL in urban_param_init')<a name='2108'>
            ALLOCATE( HPERCENT_BIN_TBL(MAXHGTS , ICATE), stat=allocate_status )<a name='2109'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1256">('Error allocating HPERCENT_BIN_TBL in urban_param_init')<a name='2110'>
            ALLOCATE( COP_TBL(ICATE), stat=allocate_status )<a name='2111'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1257">('Error allocating COP_TBL in urban_param_init')<a name='2112'>
            ALLOCATE( PWIN_TBL(ICATE), stat=allocate_status )<a name='2113'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1258">('Error allocating PWIN_TBL in urban_param_init')<a name='2114'>
            ALLOCATE( BETA_TBL(ICATE), stat=allocate_status )<a name='2115'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1259">('Error allocating BETA_TBL in urban_param_init')<a name='2116'>
            ALLOCATE( SW_COND_TBL(ICATE), stat=allocate_status )<a name='2117'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1260">('Error allocating SW_COND_TBL in urban_param_init')<a name='2118'>
            ALLOCATE( TIME_ON_TBL(ICATE), stat=allocate_status )<a name='2119'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1261">('Error allocating TIME_ON_TBL in urban_param_init')<a name='2120'>
            ALLOCATE( TIME_OFF_TBL(ICATE), stat=allocate_status )<a name='2121'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1262">('Error allocating TIME_OFF_TBL in urban_param_init')<a name='2122'>
            ALLOCATE( TARGTEMP_TBL(ICATE), stat=allocate_status )<a name='2123'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1263">('Error allocating TARGTEMP_TBL in urban_param_init')<a name='2124'>
            ALLOCATE( GAPTEMP_TBL(ICATE), stat=allocate_status )<a name='2125'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1264">('Error allocating GAPTEMP_TBL in urban_param_init')<a name='2126'>
            ALLOCATE( TARGHUM_TBL(ICATE), stat=allocate_status )<a name='2127'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1265">('Error allocating TARGHUM_TBL in urban_param_init')<a name='2128'>
            ALLOCATE( GAPHUM_TBL(ICATE), stat=allocate_status )<a name='2129'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1266">('Error allocating GAPHUM_TBL in urban_param_init')<a name='2130'>
            ALLOCATE( PERFLO_TBL(ICATE), stat=allocate_status )<a name='2131'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1267">('Error allocating PERFLO_TBL in urban_param_init')<a name='2132'>
            ALLOCATE( HSESF_TBL(ICATE), stat=allocate_status )<a name='2133'>
            if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1268">('Error allocating HSESF_TBL in urban_param_init')<a name='2134'>
         endif<a name='2135'>
         numdir_tbl = 0<a name='2136'>
         street_direction_tbl = -1.E36<a name='2137'>
         street_width_tbl = 0<a name='2138'>
         building_width_tbl = 0<a name='2139'>
         numhgt_tbl = 0<a name='2140'>
         height_bin_tbl = -1.E36<a name='2141'>
         hpercent_bin_tbl = -1.E36<a name='2142'>
<font color=#447700>!end BEP<a name='2143'></font>
<a name='2144'>
      else if (name == "ZR") then<a name='2145'>
         read(string(indx+1:),*) zr_tbl(1:icate)<a name='2146'>
      else if (name == "SIGMA_ZED") then<a name='2147'>
         read(string(indx+1:),*) sigma_zed_tbl(1:icate)<a name='2148'>
      else if (name == "ROOF_WIDTH") then<a name='2149'>
         ALLOCATE( ROOF_WIDTH(ICATE), stat=allocate_status )<a name='2150'>
         if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1269">('Error allocating ROOF_WIDTH in urban_param_init')<a name='2151'>
<a name='2152'>
         read(string(indx+1:),*) roof_width(1:icate)<a name='2153'>
      else if (name == "ROAD_WIDTH") then<a name='2154'>
         ALLOCATE( ROAD_WIDTH(ICATE), stat=allocate_status )<a name='2155'>
         if(allocate_status /= 0) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1270">('Error allocating ROAD_WIDTH in urban_param_init')<a name='2156'>
         read(string(indx+1:),*) road_width(1:icate)<a name='2157'>
      else if (name == "AH") then<a name='2158'>
         read(string(indx+1:),*) ah_tbl(1:icate)<a name='2159'>
      else if (name == "ALH") then<a name='2160'>
         read(string(indx+1:),*) alh_tbl(1:icate)<a name='2161'>
      else if (name == "FRC_URB") then<a name='2162'>
         read(string(indx+1:),*) frc_urb_tbl(1:icate)<a name='2163'>
      else if (name == "CAPR") then<a name='2164'>
         read(string(indx+1:),*) capr_tbl(1:icate)<a name='2165'>
         <font color=#447700>! Convert CAPR_TBL from J m{-3} K{-1} to cal cm{-3} deg{-1}<a name='2166'></font>
         capr_tbl = capr_tbl * ( 1.0 / 4.1868 ) * 1.E-6<a name='2167'>
      else if (name == "CAPB") then<a name='2168'>
         read(string(indx+1:),*) capb_tbl(1:icate)<a name='2169'>
         <font color=#447700>! Convert CABR_TBL from J m{-3} K{-1} to cal cm{-3} deg{-1}<a name='2170'></font>
         capb_tbl = capb_tbl * ( 1.0 / 4.1868 ) * 1.E-6<a name='2171'>
      else if (name == "CAPG") then<a name='2172'>
         read(string(indx+1:),*) capg_tbl(1:icate)<a name='2173'>
         <font color=#447700>! Convert CABG_TBL from J m{-3} K{-1} to cal cm{-3} deg{-1}<a name='2174'></font>
         capg_tbl = capg_tbl * ( 1.0 / 4.1868 ) * 1.E-6<a name='2175'>
      else if (name == "AKSR") then<a name='2176'>
         read(string(indx+1:),*) aksr_tbl(1:icate)<a name='2177'>
         <font color=#447700>! Convert AKSR_TBL from J m{-1} s{-1} K{-1} to cal cm{-1} s{-1} deg{-1}<a name='2178'></font>
         AKSR_TBL = AKSR_TBL * ( 1.0 / 4.1868 ) * 1.E-2<a name='2179'>
      else if (name == "AKSB") then<a name='2180'>
         read(string(indx+1:),*) aksb_tbl(1:icate)<a name='2181'>
         <font color=#447700>! Convert AKSB_TBL from J m{-1} s{-1} K{-1} to cal cm{-1} s{-1} deg{-1}<a name='2182'></font>
         AKSB_TBL = AKSB_TBL * ( 1.0 / 4.1868 ) * 1.E-2<a name='2183'>
      else if (name == "AKSG") then<a name='2184'>
         read(string(indx+1:),*) aksg_tbl(1:icate)<a name='2185'>
         <font color=#447700>! Convert AKSG_TBL from J m{-1} s{-1} K{-1} to cal cm{-1} s{-1} deg{-1}<a name='2186'></font>
         AKSG_TBL = AKSG_TBL * ( 1.0 / 4.1868 ) * 1.E-2<a name='2187'>
      else if (name == "ALBR") then<a name='2188'>
         read(string(indx+1:),*) albr_tbl(1:icate)<a name='2189'>
      else if (name == "ALBB") then<a name='2190'>
         read(string(indx+1:),*) albb_tbl(1:icate)<a name='2191'>
      else if (name == "ALBG") then<a name='2192'>
         read(string(indx+1:),*) albg_tbl(1:icate)<a name='2193'>
      else if (name == "EPSR") then<a name='2194'>
         read(string(indx+1:),*) epsr_tbl(1:icate)<a name='2195'>
      else if (name == "EPSB") then<a name='2196'>
         read(string(indx+1:),*) epsb_tbl(1:icate)<a name='2197'>
      else if (name == "EPSG") then<a name='2198'>
         read(string(indx+1:),*) epsg_tbl(1:icate)<a name='2199'>
      else if (name == "AKANDA_URBAN") then<a name='2200'>
         read(string(indx+1:),*) akanda_urban_tbl(1:icate)<a name='2201'>
      else if (name == "Z0B") then<a name='2202'>
         read(string(indx+1:),*) z0b_tbl(1:icate)<a name='2203'>
      else if (name == "Z0G") then<a name='2204'>
         read(string(indx+1:),*) z0g_tbl(1:icate)<a name='2205'>
      else if (name == "DDZR") then<a name='2206'>
         read(string(indx+1:),*) dzr(1:num_roof_layers)<a name='2207'>
         <font color=#447700>! Convert thicknesses from m to cm<a name='2208'></font>
         dzr = dzr * 100.0<a name='2209'>
      else if (name == "DDZB") then<a name='2210'>
         read(string(indx+1:),*) dzb(1:num_wall_layers)<a name='2211'>
         <font color=#447700>! Convert thicknesses from m to cm<a name='2212'></font>
         dzb = dzb * 100.0<a name='2213'>
      else if (name == "DDZG") then<a name='2214'>
         read(string(indx+1:),*) dzg(1:num_road_layers)<a name='2215'>
         <font color=#447700>! Convert thicknesses from m to cm<a name='2216'></font>
         dzg = dzg * 100.0<a name='2217'>
      else if (name == "BOUNDR") then<a name='2218'>
         read(string(indx+1:),*) boundr_data<a name='2219'>
      else if (name == "BOUNDB") then<a name='2220'>
         read(string(indx+1:),*) boundb_data<a name='2221'>
      else if (name == "BOUNDG") then<a name='2222'>
         read(string(indx+1:),*) boundg_data<a name='2223'>
      else if (name == "TRLEND") then<a name='2224'>
         read(string(indx+1:),*) trlend_tbl(1:icate)<a name='2225'>
      else if (name == "TBLEND") then<a name='2226'>
         read(string(indx+1:),*) tblend_tbl(1:icate)<a name='2227'>
      else if (name == "TGLEND") then<a name='2228'>
         read(string(indx+1:),*) tglend_tbl(1:icate)<a name='2229'>
      else if (name == "CH_SCHEME") then<a name='2230'>
         read(string(indx+1:),*) ch_scheme_data<a name='2231'>
      else if (name == "TS_SCHEME") then<a name='2232'>
         read(string(indx+1:),*) ts_scheme_data<a name='2233'>
      else if (name == "AHOPTION") then<a name='2234'>
         read(string(indx+1:),*) ahoption<a name='2235'>
      else if (name == "AHDIUPRF") then<a name='2236'>
         read(string(indx+1:),*) ahdiuprf(1:24)<a name='2237'>
      else if (name == "ALHOPTION") then<a name='2238'>
         read(string(indx+1:),*) alhoption<a name='2239'>
      else if (name == "ALHSEASON") then<a name='2240'>
         read(string(indx+1:),*) alhseason(1:4)<a name='2241'>
      else if (name == "ALHDIUPRF") then<a name='2242'>
         read(string(indx+1:),*) alhdiuprf(1:48)<a name='2243'>
      else if (name == "PORIMP") then<a name='2244'>
         read(string(indx+1:),*) porimp(1:3)<a name='2245'>
      else if (name == "DENGIMP") then<a name='2246'>
         read(string(indx+1:),*) dengimp(1:3)<a name='2247'>
      else if (name == "IMP_SCHEME") then<a name='2248'>
         read(string(indx+1:),*) imp_scheme<a name='2249'>
      else if (name == "IRI_SCHEME") then<a name='2250'>
         read(string(indx+1:),*) iri_scheme<a name='2251'>
      else if (name == "OASIS") then<a name='2252'>
         read(string(indx+1:),*) oasis<a name='2253'>
      else if (name == "GROPTION") then<a name='2254'>
         read(string(indx+1:),*) groption<a name='2255'>
      else if (name == "FGR") then<a name='2256'>
         read(string(indx+1:),*) fgr<a name='2257'>
      else if (name == "DZGR") then<a name='2258'>
         read(string(indx+1:),*) dzgr(1:4)<a name='2259'>
<font color=#447700>!for BEP<a name='2260'></font>
      else if (name == "STREET PARAMETERS") then<a name='2261'>
<a name='2262'>
         STREETLOOP : do<a name='2263'>
            read(11,'(A512)', iostat=iostatus) string<a name='2264'>
            if (string(1:1) == "#") cycle STREETLOOP<a name='2265'>
            if (trim(string) == "") cycle STREETLOOP<a name='2266'>
            if (string == "END STREET PARAMETERS") exit STREETLOOP<a name='2267'>
            read(string, *) k <font color=#447700>! , dirst, ws, bs<a name='2268'></font>
            numdir_tbl(k) = numdir_tbl(k) + 1<a name='2269'>
            read(string, *) k, street_direction_tbl(numdir_tbl(k),k), &amp;<a name='2270'>
                               street_width_tbl(numdir_tbl(k),k), &amp;<a name='2271'>
                               building_width_tbl(numdir_tbl(k),k)<a name='2272'>
         enddo STREETLOOP<a name='2273'>
<a name='2274'>
      else if (name == "BUILDING HEIGHTS") then<a name='2275'>
<a name='2276'>
         read(string(indx+1:),*) k<a name='2277'>
         HEIGHTLOOP : do<a name='2278'>
            read(11,'(A512)', iostat=iostatus) string<a name='2279'>
            if (string(1:1) == "#") cycle HEIGHTLOOP<a name='2280'>
            if (trim(string) == "") cycle HEIGHTLOOP<a name='2281'>
            if (string == "END BUILDING HEIGHTS") exit HEIGHTLOOP<a name='2282'>
            read(string,*) dummy_hgt, dummy_pct<a name='2283'>
            numhgt_tbl(k) = numhgt_tbl(k) + 1<a name='2284'>
            height_bin_tbl(numhgt_tbl(k), k) = dummy_hgt<a name='2285'>
            hpercent_bin_tbl(numhgt_tbl(k),k) = dummy_pct<a name='2286'>
            <a name='2287'>
         enddo HEIGHTLOOP<a name='2288'>
         pctsum = sum ( hpercent_bin_tbl(:,k) , mask=(hpercent_bin_tbl(:,k)&gt;-1.E25 ) )<a name='2289'>
         if ( pctsum /= 100.) then<a name='2290'>
            write (*,'(//,"Building height percentages for category ", I2, " must sum to 100.0")') k<a name='2291'>
            write (*,'("Currently, they sum to ", F6.2,/)') pctsum<a name='2292'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1271">('pctsum is not equal to 100.') <a name='2293'>
         endif<a name='2294'>
      else if ( name == "Z0R") then<a name='2295'>
         read(string(indx+1:),*) Z0R_tbl(1:icate)<a name='2296'>
      else if ( name == "COP") then<a name='2297'>
         read(string(indx+1:),*) cop_tbl(1:icate)<a name='2298'>
      else if ( name == "PWIN") then<a name='2299'>
         read(string(indx+1:),*) pwin_tbl(1:icate)<a name='2300'>
      else if ( name == "BETA") then<a name='2301'>
         read(string(indx+1:),*) beta_tbl(1:icate)<a name='2302'>
      else if ( name == "SW_COND") then<a name='2303'>
         read(string(indx+1:),*) sw_cond_tbl(1:icate)<a name='2304'>
      else if ( name == "TIME_ON") then<a name='2305'>
         read(string(indx+1:),*) time_on_tbl(1:icate)<a name='2306'>
      else if ( name == "TIME_OFF") then<a name='2307'>
         read(string(indx+1:),*) time_off_tbl(1:icate)<a name='2308'>
      else if ( name == "TARGTEMP") then<a name='2309'>
         read(string(indx+1:),*) targtemp_tbl(1:icate)<a name='2310'>
      else if ( name == "GAPTEMP") then<a name='2311'>
         read(string(indx+1:),*) gaptemp_tbl(1:icate)<a name='2312'>
      else if ( name == "TARGHUM") then<a name='2313'>
         read(string(indx+1:),*) targhum_tbl(1:icate)<a name='2314'>
      else if ( name == "GAPHUM") then<a name='2315'>
         read(string(indx+1:),*) gaphum_tbl(1:icate)<a name='2316'>
      else if ( name == "PERFLO") then<a name='2317'>
         read(string(indx+1:),*) perflo_tbl(1:icate)<a name='2318'>
      else if (name == "HSEQUIP") then<a name='2319'>
         read(string(indx+1:),*) hsequip_tbl(1:24)<a name='2320'>
      else if (name == "HSEQUIP_SCALE_FACTOR") then<a name='2321'>
         read(string(indx+1:),*) hsesf_tbl(1:icate)<a name='2322'>
<font color=#447700>!end BEP         <a name='2323'></font>
      else<a name='2324'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_PARAM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1272">('URBPARM.TBL: Unrecognized NAME = "'//trim(name)//'" in Subr URBAN_PARAM_INIT')<a name='2325'>
      endif<a name='2326'>
   enddo READLOOP<a name='2327'>
<a name='2328'>
   CLOSE(11)<a name='2329'>
<a name='2330'>
   <font color=#447700>! Assign a few table values that do not need to come from URBPARM.TBL<a name='2331'></font>
<a name='2332'>
   Z0HB_TBL = 0.1 * Z0B_TBL<a name='2333'>
   Z0HG_TBL = 0.1 * Z0G_TBL<a name='2334'>
<a name='2335'>
   DO LC = 1, ICATE<a name='2336'>
<a name='2337'>
      <font color=#447700>! HGT:  Normalized height<a name='2338'></font>
      HGT_TBL(LC) = ZR_TBL(LC) / ( ROAD_WIDTH(LC) + ROOF_WIDTH(LC) )<a name='2339'>
<a name='2340'>
      <font color=#447700>! R:  Normalized Roof Width (a.k.a. "building coverage ratio")<a name='2341'></font>
      R_TBL(LC)  = ROOF_WIDTH(LC) / ( ROAD_WIDTH(LC) + ROOF_WIDTH(LC) )<a name='2342'>
<a name='2343'>
      RW_TBL(LC) = 1.0 - R_TBL(LC)<a name='2344'>
      BETR_TBL(LC) = 0.0<a name='2345'>
      BETB_TBL(LC) = 0.0<a name='2346'>
      BETG_TBL(LC) = 0.0<a name='2347'>
<a name='2348'>
      <font color=#447700>! The following urban canyon geometry parameters are following Macdonald's (1998) formulations<a name='2349'></font>
      <a name='2350'>
      <font color=#447700>! Lambda_P :: Plan areal fraction, which corresponds to R for a 2-d canyon.<a name='2351'></font>
      <font color=#447700>! Lambda_F :: Frontal area index, which corresponds to HGT for a 2-d canyon<a name='2352'></font>
      <font color=#447700>! Cd       :: Drag coefficient ( 1.2 from Grimmond and Oke, 1998 )<a name='2353'></font>
      <font color=#447700>! Alpha_macd :: Emperical coefficient ( 4.43 from Macdonald et al., 1998 )<a name='2354'></font>
      <font color=#447700>! Beta_macd  :: Correction factor for the drag coefficient ( 1.0 from Macdonald et al., 1998 )<a name='2355'></font>
<a name='2356'>
      Lambda_P = R_TBL(LC)<a name='2357'>
      Lambda_F = HGT_TBL(LC)<a name='2358'>
      Cd         = 1.2<a name='2359'>
      alpha_macd = 4.43 <a name='2360'>
      beta_macd  = 1.0<a name='2361'>
<a name='2362'>
<a name='2363'>
      ZDC_TBL(LC) = ZR_TBL(LC) * ( 1.0 + ( alpha_macd ** ( -Lambda_P ) )  * ( Lambda_P - 1.0 ) )<a name='2364'>
<a name='2365'>
      Z0C_TBL(LC) = ZR_TBL(LC) * ( 1.0 - ZDC_TBL(LC)/ZR_TBL(LC) ) * &amp;<a name='2366'>
           exp (-(0.5 * beta_macd * Cd / (VonK**2) * ( 1.0-ZDC_TBL(LC)/ZR_TBL(LC) ) * Lambda_F )**(-0.5))<a name='2367'>
<a name='2368'>
      IF (SF_URBAN_PHYSICS == 1) THEN<a name='2369'>
         <font color=#447700>! Include roof height variability in Macdonald<a name='2370'></font>
         <font color=#447700>! to parameterize Z0R as a function of ZR_SD (Standard Deviation)<a name='2371'></font>
         Lambda_FR  = SIGMA_ZED_TBL(LC) / ( ROAD_WIDTH(LC) + ROOF_WIDTH(LC) )<a name='2372'>
         Z0R_TBL(LC) = ZR_TBL(LC) * ( 1.0 - ZDC_TBL(LC)/ZR_TBL(LC) ) &amp;<a name='2373'>
              * exp ( -(0.5 * beta_macd * Cd / (VonK**2) &amp;<a name='2374'>
              * ( 1.0-ZDC_TBL(LC)/ZR_TBL(LC) ) * Lambda_FR )**(-0.5))<a name='2375'>
      ENDIF<a name='2376'>
<a name='2377'>
      <font color=#447700>!<a name='2378'></font>
      <font color=#447700>! Z0HC still one-tenth of Z0C, as before ?<a name='2379'></font>
      <font color=#447700>!<a name='2380'></font>
<a name='2381'>
      Z0HC_TBL(LC) = 0.1 * Z0C_TBL(LC)<a name='2382'>
<a name='2383'>
      <font color=#447700>!<a name='2384'></font>
      <font color=#447700>! Calculate Sky View Factor:<a name='2385'></font>
      <font color=#447700>!<a name='2386'></font>
      DHGT=HGT_TBL(LC)/100.<a name='2387'>
      HGT=0.<a name='2388'>
      VFWS=0.<a name='2389'>
      HGT=HGT_TBL(LC)-DHGT/2.<a name='2390'>
      do k=1,99<a name='2391'>
         HGT=HGT-DHGT<a name='2392'>
         VFWS=VFWS+0.25*(1.-HGT/SQRT(HGT**2.+RW_TBL(LC)**2.))<a name='2393'>
      end do<a name='2394'>
<a name='2395'>
     VFWS=VFWS/99.<a name='2396'>
     VFWS=VFWS*2.<a name='2397'>
<a name='2398'>
     VFGS=1.-2.*VFWS*HGT_TBL(LC)/RW_TBL(LC)<a name='2399'>
     SVF_TBL(LC)=VFGS<a name='2400'>
   END DO<a name='2401'>
<a name='2402'>
   deallocate(roof_width)<a name='2403'>
   deallocate(road_width)<a name='2404'>
<a name='2405'>
   END SUBROUTINE urban_param_init<a name='2406'>
<font color=#447700>!===========================================================================<a name='2407'></font>
<font color=#447700>!<a name='2408'></font>
<font color=#447700>! subroutine urban_var_init: initialization of urban state variables<a name='2409'></font>
<font color=#447700>!<a name='2410'></font>
<font color=#447700>!===========================================================================<a name='2411'></font>
<A NAME='URBAN_VAR_INIT'><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2412'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>urban_var_init</font>(ISURBAN, TSURFACE0_URB,TLAYER0_URB,TDEEP0_URB,IVGTYP,  &amp; <font color=#447700>! in <A href='../../call_to/URBAN_VAR_INIT.html' TARGET='index'>2</A>,<A href='../../call_from/URBAN_VAR_INIT.html' TARGET='index'>35</A><a name='2413'></font>
                             ims,ime,jms,jme,kms,kme,num_soil_layers,         &amp; <font color=#447700>! in<a name='2414'></font>
<font color=#447700>!                             num_roof_layers,num_wall_layers,num_road_layers, &amp; ! in<a name='2415'></font>
<font color=#447700>!                              num_roof_layers,num_wall_layers,num_road_layers, &amp; !urban<a name='2416'></font>
                             LOW_DENSITY_RESIDENTIAL,                    &amp;<a name='2417'>
		             HIGH_DENSITY_RESIDENTIAL,                   &amp;<a name='2418'>
		             HIGH_INTENSITY_INDUSTRIAL,                    &amp;<a name='2419'>
                             restart,sf_urban_physics,                     &amp; <font color=#447700>!in<a name='2420'></font>
                             XXXR_URB2D,XXXB_URB2D,XXXG_URB2D,XXXC_URB2D,  &amp; <font color=#447700>! inout<a name='2421'></font>
                             TR_URB2D,TB_URB2D,TG_URB2D,TC_URB2D,QC_URB2D, &amp; <font color=#447700>! inout<a name='2422'></font>
                             TRL_URB3D,TBL_URB3D,TGL_URB3D,                &amp; <font color=#447700>! inout<a name='2423'></font>
                             SH_URB2D,LH_URB2D,G_URB2D,RN_URB2D,           &amp; <font color=#447700>! inout<a name='2424'></font>
                             TS_URB2D,                                     &amp; <font color=#447700>! inout<a name='2425'></font>
                             num_urban_layers,                             &amp; <font color=#447700>! in<a name='2426'></font>
                             num_urban_hi,                                 &amp; <font color=#447700>! in<a name='2427'></font>
                             TRB_URB4D,TW1_URB4D,TW2_URB4D,TGB_URB4D,      &amp; <font color=#447700>! inout<a name='2428'></font>
                             TLEV_URB3D,QLEV_URB3D,                        &amp; <font color=#447700>! inout<a name='2429'></font>
                             TW1LEV_URB3D,TW2LEV_URB3D,                    &amp; <font color=#447700>! inout<a name='2430'></font>
                             TGLEV_URB3D,TFLEV_URB3D,                      &amp; <font color=#447700>! inout<a name='2431'></font>
                             SF_AC_URB3D,LF_AC_URB3D,CM_AC_URB3D,          &amp; <font color=#447700>! inout<a name='2432'></font>
                             SFVENT_URB3D,LFVENT_URB3D,                    &amp; <font color=#447700>! inout<a name='2433'></font>
                             SFWIN1_URB3D,SFWIN2_URB3D,                    &amp; <font color=#447700>! inout<a name='2434'></font>
                             SFW1_URB3D,SFW2_URB3D,SFR_URB3D,SFG_URB3D,    &amp; <font color=#447700>! inout<a name='2435'></font>
                             LP_URB2D,HI_URB2D,LB_URB2D,                   &amp; <font color=#447700>! inout<a name='2436'></font>
                             HGT_URB2D,MH_URB2D,STDH_URB2D,                &amp; <font color=#447700>! inout<a name='2437'></font>
                             LF_URB2D,                                     &amp; <font color=#447700>! inout<a name='2438'></font>
                             CMCR_URB2D,TGR_URB2D,TGRL_URB3D,SMR_URB3D,    &amp; <font color=#447700>! inout<a name='2439'></font>
                             DRELR_URB2D,DRELB_URB2D,DRELG_URB2D,          &amp; <font color=#447700>! inout<a name='2440'></font>
                             FLXHUMR_URB2D, FLXHUMB_URB2D, FLXHUMG_URB2D,  &amp; <font color=#447700>! inout<a name='2441'></font>
                             A_U_BEP,A_V_BEP,A_T_BEP,A_Q_BEP,              &amp; <font color=#447700>! inout multi-layer urban<a name='2442'></font>
                             A_E_BEP,B_U_BEP,B_V_BEP,                      &amp; <font color=#447700>! inout multi-layer urban<a name='2443'></font>
                             B_T_BEP,B_Q_BEP,B_E_BEP,DLG_BEP,              &amp; <font color=#447700>! inout multi-layer urban<a name='2444'></font>
                             DL_U_BEP,SF_BEP,VL_BEP,                       &amp; <font color=#447700>! inout multi-layer urban<a name='2445'></font>
                             FRC_URB2D, UTYPE_URB2D)                         <font color=#447700>! inout<a name='2446'></font>
   IMPLICIT NONE<a name='2447'>
<a name='2448'>
   INTEGER, INTENT(IN) :: ISURBAN, sf_urban_physics<a name='2449'>
   INTEGER, INTENT(IN) :: LOW_DENSITY_RESIDENTIAL, HIGH_DENSITY_RESIDENTIAL, HIGH_INTENSITY_INDUSTRIAL<a name='2450'>
   INTEGER, INTENT(IN) :: ims,ime,jms,jme,kms,kme,num_soil_layers<a name='2451'>
   INTEGER, INTENT(IN) :: num_urban_layers                            <font color=#447700>!multi-layer urban<a name='2452'></font>
   INTEGER, INTENT(IN) :: num_urban_hi                                <font color=#447700>!multi-layer urban<a name='2453'></font>
<font color=#447700>!   INTEGER, INTENT(IN) :: num_roof_layers, num_wall_layers, num_road_layers<a name='2454'></font>
<a name='2455'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN)                    :: TSURFACE0_URB<a name='2456'>
   REAL, DIMENSION( ims:ime, 1:num_soil_layers, jms:jme ), INTENT(IN) :: TLAYER0_URB<a name='2457'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN)                    :: TDEEP0_URB<a name='2458'>
   INTEGER, DIMENSION( ims:ime, jms:jme ), INTENT(IN)                 :: IVGTYP<a name='2459'>
   LOGICAL , INTENT(IN) :: restart<a name='2460'>
 <a name='2461'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TR_URB2D<a name='2462'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TB_URB2D<a name='2463'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TG_URB2D<a name='2464'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TC_URB2D<a name='2465'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: QC_URB2D<a name='2466'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXR_URB2D<a name='2467'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXB_URB2D<a name='2468'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXG_URB2D<a name='2469'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXC_URB2D<a name='2470'>
<a name='2471'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: DRELR_URB2D<a name='2472'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: DRELB_URB2D<a name='2473'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: DRELG_URB2D<a name='2474'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: FLXHUMR_URB2D<a name='2475'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: FLXHUMB_URB2D<a name='2476'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: FLXHUMG_URB2D<a name='2477'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CMCR_URB2D<a name='2478'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TGR_URB2D<a name='2479'>
<a name='2480'>
<font color=#447700>!   REAL, DIMENSION(ims:ime, 1:num_roof_layers, jms:jme), INTENT(INOUT) :: TRL_URB3D<a name='2481'></font>
<font color=#447700>!   REAL, DIMENSION(ims:ime, 1:num_wall_layers, jms:jme), INTENT(INOUT) :: TBL_URB3D<a name='2482'></font>
<font color=#447700>!   REAL, DIMENSION(ims:ime, 1:num_road_layers, jms:jme), INTENT(INOUT) :: TGL_URB3D<a name='2483'></font>
   REAL, DIMENSION(ims:ime, 1:num_soil_layers, jms:jme), INTENT(INOUT) :: TRL_URB3D<a name='2484'>
   REAL, DIMENSION(ims:ime, 1:num_soil_layers, jms:jme), INTENT(INOUT) :: TBL_URB3D<a name='2485'>
   REAL, DIMENSION(ims:ime, 1:num_soil_layers, jms:jme), INTENT(INOUT) :: TGL_URB3D<a name='2486'>
   REAL, DIMENSION(ims:ime, 1:num_soil_layers, jms:jme), INTENT(INOUT) :: TGRL_URB3D<a name='2487'>
   REAL, DIMENSION(ims:ime, 1:num_soil_layers, jms:jme), INTENT(INOUT) :: SMR_URB3D<a name='2488'>
<a name='2489'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: SH_URB2D<a name='2490'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: LH_URB2D<a name='2491'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: G_URB2D<a name='2492'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: RN_URB2D<a name='2493'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TS_URB2D<a name='2494'>
<a name='2495'>
<font color=#447700>! multi-layer UCM variables<a name='2496'></font>
   REAL, DIMENSION(ims:ime, 1:num_urban_layers, jms:jme), INTENT(INOUT) :: TRB_URB4D<a name='2497'>
   REAL, DIMENSION(ims:ime, 1:num_urban_layers, jms:jme), INTENT(INOUT) :: TW1_URB4D<a name='2498'>
   REAL, DIMENSION(ims:ime, 1:num_urban_layers, jms:jme), INTENT(INOUT) :: TW2_URB4D<a name='2499'>
   REAL, DIMENSION(ims:ime, 1:num_urban_layers, jms:jme), INTENT(INOUT) :: TGB_URB4D<a name='2500'>
   REAL, DIMENSION(ims:ime, 1:num_urban_layers, jms:jme), INTENT(INOUT) :: TLEV_URB3D<a name='2501'>
   REAL, DIMENSION(ims:ime, 1:num_urban_layers, jms:jme), INTENT(INOUT) :: QLEV_URB3D<a name='2502'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: TW1LEV_URB3D<a name='2503'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: TW2LEV_URB3D<a name='2504'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: TGLEV_URB3D<a name='2505'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: TFLEV_URB3D<a name='2506'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: LF_AC_URB3D<a name='2507'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: SF_AC_URB3D<a name='2508'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CM_AC_URB3D<a name='2509'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: SFVENT_URB3D<a name='2510'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: LFVENT_URB3D<a name='2511'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: SFWIN1_URB3D<a name='2512'>
   REAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: SFWIN2_URB3D<a name='2513'>
   REAL, DIMENSION(ims:ime, 1:num_urban_layers, jms:jme), INTENT(INOUT) :: SFW1_URB3D<a name='2514'>
   REAL, DIMENSION(ims:ime, 1:num_urban_layers, jms:jme), INTENT(INOUT) :: SFW2_URB3D<a name='2515'>
   REAL, DIMENSION(ims:ime, 1:num_urban_layers, jms:jme), INTENT(INOUT) :: SFR_URB3D<a name='2516'>
   REAL, DIMENSION(ims:ime, 1:num_urban_layers, jms:jme), INTENT(INOUT) :: SFG_URB3D<a name='2517'>
   REAL, DIMENSION( ims:ime,1:num_urban_hi, jms:jme), INTENT(INOUT) :: HI_URB2D<a name='2518'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: LP_URB2D<a name='2519'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: LB_URB2D<a name='2520'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: HGT_URB2D<a name='2521'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: MH_URB2D<a name='2522'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: STDH_URB2D<a name='2523'>
   REAL, DIMENSION( ims:ime, 4,jms:jme ), INTENT(INOUT) :: LF_URB2D<a name='2524'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: A_U_BEP<a name='2525'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: A_V_BEP<a name='2526'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: A_T_BEP<a name='2527'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: A_Q_BEP<a name='2528'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: A_E_BEP<a name='2529'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: B_U_BEP<a name='2530'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: B_V_BEP<a name='2531'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: B_T_BEP<a name='2532'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: B_Q_BEP<a name='2533'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: B_E_BEP<a name='2534'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: VL_BEP<a name='2535'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: DLG_BEP<a name='2536'>
   REAL, DIMENSION(ims:ime, kms:kme,jms:jme),INTENT(INOUT) :: SF_BEP<a name='2537'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: DL_U_BEP<a name='2538'>
<font color=#447700>!<a name='2539'></font>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: FRC_URB2D<a name='2540'>
   INTEGER, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: UTYPE_URB2D<a name='2541'>
   INTEGER                                            :: UTYPE_URB<a name='2542'>
<font color=#447700>!FS<a name='2543'></font>
   INTEGER :: SWITCH_URB<a name='2544'>
<a name='2545'>
   INTEGER :: I,J,K,CHECK<a name='2546'>
<a name='2547'>
   CHECK = 0<a name='2548'>
<a name='2549'>
   DO I=ims,ime<a name='2550'>
    DO J=jms,jme<a name='2551'>
<a name='2552'>
<font color=#447700>!      XXXR_URB2D(I,J)=0.<a name='2553'></font>
<font color=#447700>!      XXXB_URB2D(I,J)=0.<a name='2554'></font>
<font color=#447700>!      XXXG_URB2D(I,J)=0.<a name='2555'></font>
<font color=#447700>!      XXXC_URB2D(I,J)=0.<a name='2556'></font>
<a name='2557'>
      SH_URB2D(I,J)=0.<a name='2558'>
      LH_URB2D(I,J)=0.<a name='2559'>
      G_URB2D(I,J)=0.<a name='2560'>
      RN_URB2D(I,J)=0.<a name='2561'>
      <a name='2562'>
<font color=#447700>!m<a name='2563'></font>
<font color=#447700>!FS   FRC_URB2D(I,J)=0.<a name='2564'></font>
      UTYPE_URB2D(I,J)=0<a name='2565'>
      SWITCH_URB=0<a name='2566'>
<a name='2567'>
            IF( IVGTYP(I,J) == ISURBAN)  THEN<a name='2568'>
               UTYPE_URB2D(I,J) = 2  <font color=#447700>! for default. high-intensity<a name='2569'></font>
               UTYPE_URB = UTYPE_URB2D(I,J)  <font color=#447700>! for default. high-intensity<a name='2570'></font>
               IF (HGT_URB2D(I,J)&gt;0.) THEN<a name='2571'>
                  CONTINUE<a name='2572'>
               ELSE<a name='2573'>
                  WRITE(mesg,*) 'USING DEFAULT URBAN MORPHOLOGY'<a name='2574'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1017">(mesg)<a name='2575'>
                  LP_URB2D(I,J)=0.<a name='2576'>
                  LB_URB2D(I,J)=0.<a name='2577'>
                  HGT_URB2D(I,J)=0.<a name='2578'>
                  IF ( sf_urban_physics == 1 ) THEN<a name='2579'>
                     MH_URB2D(I,J)=0.<a name='2580'>
                     STDH_URB2D(I,J)=0.<a name='2581'>
                     DO K=1,4<a name='2582'>
                       LF_URB2D(I,K,J)=0.<a name='2583'>
                     ENDDO<a name='2584'>
                  ELSE IF ( ( sf_urban_physics == 2 ) .or. ( sf_urban_physics == 3 ) ) THEN<a name='2585'>
                     DO K=1,num_urban_hi<a name='2586'>
                        HI_URB2D(I,K,J)=0.<a name='2587'>
                     ENDDO<a name='2588'>
                  ENDIF<a name='2589'>
               ENDIF<a name='2590'>
                IF (FRC_URB2D(I,J)&gt;0.and.FRC_URB2D(I,J)&lt;=1.) THEN<a name='2591'>
                  CONTINUE<a name='2592'>
                ELSE<a name='2593'>
                  WRITE(mesg,*) 'WARNING, FRC_URB2D = 0 BUT IVGTYP IS URBAN'<a name='2594'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1018">(mesg)<a name='2595'>
                  WRITE(mesg,*) 'WARNING, THE URBAN FRACTION WILL BE READ FROM URBPARM.TBL'<a name='2596'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1019">(mesg)<a name='2597'>
                  FRC_URB2D(I,J) = FRC_URB_TBL(UTYPE_URB)<a name='2598'>
                ENDIF           <a name='2599'>
               SWITCH_URB=1<a name='2600'>
            ENDIF <a name='2601'>
<a name='2602'>
            IF( IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL) THEN<a name='2603'>
               UTYPE_URB2D(I,J) = 1  <font color=#447700>! low-intensity residential<a name='2604'></font>
               UTYPE_URB = UTYPE_URB2D(I,J)  <font color=#447700>! low-intensity residential<a name='2605'></font>
               IF (HGT_URB2D(I,J)&gt;0.) THEN<a name='2606'>
                  CONTINUE<a name='2607'>
               ELSE<a name='2608'>
                  WRITE(mesg,*) 'USING DEFAULT URBAN MORPHOLOGY'<a name='2609'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1020">(mesg)<a name='2610'>
                  LP_URB2D(I,J)=0.<a name='2611'>
                  LB_URB2D(I,J)=0.<a name='2612'>
                  HGT_URB2D(I,J)=0.<a name='2613'>
                  IF ( sf_urban_physics == 1 ) THEN<a name='2614'>
                     MH_URB2D(I,J)=0.<a name='2615'>
                     STDH_URB2D(I,J)=0.<a name='2616'>
                     DO K=1,4<a name='2617'>
                       LF_URB2D(I,K,J)=0.<a name='2618'>
                     ENDDO<a name='2619'>
                  ELSE IF ( ( sf_urban_physics == 2 ) .or. ( sf_urban_physics == 3 ) ) THEN<a name='2620'>
                     DO K=1,num_urban_hi<a name='2621'>
                        HI_URB2D(I,K,J)=0.<a name='2622'>
                     ENDDO<a name='2623'>
                  ENDIF<a name='2624'>
               ENDIF<a name='2625'>
                IF (FRC_URB2D(I,J)&gt;0.and.FRC_URB2D(I,J)&lt;=1.) THEN<a name='2626'>
                  CONTINUE<a name='2627'>
                ELSE<a name='2628'>
                  WRITE(mesg,*) 'WARNING, FRC_URB2D = 0 BUT IVGTYP IS URBAN'<a name='2629'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1021">(mesg)<a name='2630'>
                  WRITE(mesg,*) 'WARNING, THE URBAN FRACTION WILL BE READ FROM URBPARM.TBL'<a name='2631'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1022">(mesg)<a name='2632'>
                  FRC_URB2D(I,J) = FRC_URB_TBL(UTYPE_URB)<a name='2633'>
                ENDIF         <a name='2634'>
              SWITCH_URB=1<a name='2635'>
            ENDIF<a name='2636'>
<a name='2637'>
           IF( IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL) THEN<a name='2638'>
               UTYPE_URB2D(I,J) = 2  <font color=#447700>! high-intensity<a name='2639'></font>
               UTYPE_URB = UTYPE_URB2D(I,J)  <font color=#447700>! high-intensity<a name='2640'></font>
              IF (HGT_URB2D(I,J)&gt;0.) THEN<a name='2641'>
                  CONTINUE<a name='2642'>
               ELSE<a name='2643'>
                  WRITE(mesg,*) 'USING DEFAULT URBAN MORPHOLOGY'<a name='2644'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1023">(mesg)<a name='2645'>
                  LP_URB2D(I,J)=0.<a name='2646'>
                  LB_URB2D(I,J)=0.<a name='2647'>
                  HGT_URB2D(I,J)=0.<a name='2648'>
                  IF ( sf_urban_physics == 1 ) THEN<a name='2649'>
                     MH_URB2D(I,J)=0.<a name='2650'>
                     STDH_URB2D(I,J)=0.<a name='2651'>
                     DO K=1,4<a name='2652'>
                       LF_URB2D(I,K,J)=0.<a name='2653'>
                     ENDDO<a name='2654'>
                  ELSE IF ( ( sf_urban_physics == 2 ) .or. ( sf_urban_physics == 3 ) ) THEN<a name='2655'>
                     DO K=1,num_urban_hi<a name='2656'>
                        HI_URB2D(I,K,J)=0.<a name='2657'>
                     ENDDO<a name='2658'>
                  ENDIF<a name='2659'>
               ENDIF<a name='2660'>
                IF (FRC_URB2D(I,J)&gt;0.and.FRC_URB2D(I,J)&lt;=1.) THEN<a name='2661'>
                  CONTINUE<a name='2662'>
                ELSE<a name='2663'>
                  WRITE(mesg,*) 'WARNING, FRC_URB2D = 0 BUT IVGTYP IS URBAN'<a name='2664'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1024">(mesg)<a name='2665'>
                  WRITE(mesg,*) 'WARNING, THE URBAN FRACTION WILL BE READ FROM URBPARM.TBL'<a name='2666'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1025">(mesg)<a name='2667'>
                  FRC_URB2D(I,J) = FRC_URB_TBL(UTYPE_URB)<a name='2668'>
                ENDIF<a name='2669'>
              SWITCH_URB=1<a name='2670'>
            ENDIF<a name='2671'>
<a name='2672'>
            IF( IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN<a name='2673'>
               UTYPE_URB2D(I,J) = 3  <font color=#447700>!  Commercial/Industrial/Transportation<a name='2674'></font>
               UTYPE_URB = UTYPE_URB2D(I,J)  <font color=#447700>!  Commercial/Industrial/Transportation<a name='2675'></font>
              IF (HGT_URB2D(I,J)&gt;0.) THEN<a name='2676'>
                  CONTINUE<a name='2677'>
               ELSE<a name='2678'>
                  WRITE(mesg,*) 'USING DEFAULT URBAN MORPHOLOGY'<a name='2679'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1026">(mesg)<a name='2680'>
                  LP_URB2D(I,J)=0.<a name='2681'>
                  LB_URB2D(I,J)=0.<a name='2682'>
                  HGT_URB2D(I,J)=0.<a name='2683'>
                  IF ( sf_urban_physics == 1 ) THEN<a name='2684'>
                     MH_URB2D(I,J)=0.<a name='2685'>
                     STDH_URB2D(I,J)=0.<a name='2686'>
                     DO K=1,4<a name='2687'>
                       LF_URB2D(I,K,J)=0.<a name='2688'>
                     ENDDO<a name='2689'>
                  ELSE IF ( ( sf_urban_physics == 2 ) .or. ( sf_urban_physics == 3 ) ) THEN<a name='2690'>
                     DO K=1,num_urban_hi<a name='2691'>
                        HI_URB2D(I,K,J)=0.<a name='2692'>
                     ENDDO<a name='2693'>
                  ENDIF<a name='2694'>
               ENDIF<a name='2695'>
                IF (FRC_URB2D(I,J)&gt;0.and.FRC_URB2D(I,J)&lt;=1.) THEN<a name='2696'>
                  CONTINUE<a name='2697'>
                ELSE<a name='2698'>
                  WRITE(mesg,*) 'WARNING, FRC_URB2D = 0 BUT IVGTYP IS URBAN'<a name='2699'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1027">(mesg)<a name='2700'>
                  WRITE(mesg,*) 'WARNING, THE URBAN FRACTION WILL BE READ FROM URBPARM.TBL'<a name='2701'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1028">(mesg)<a name='2702'>
                  FRC_URB2D(I,J) = FRC_URB_TBL(UTYPE_URB)<a name='2703'>
                ENDIF<a name='2704'>
               SWITCH_URB=1<a name='2705'>
            ENDIF<a name='2706'>
<a name='2707'>
            IF (SWITCH_URB==1) THEN<a name='2708'>
                CONTINUE<a name='2709'>
            ELSE<a name='2710'>
                FRC_URB2D(I,J)=0.<a name='2711'>
                LP_URB2D(I,J)=0.<a name='2712'>
                LB_URB2D(I,J)=0.<a name='2713'>
                HGT_URB2D(I,J)=0.<a name='2714'>
                IF ( sf_urban_physics == 1 ) THEN<a name='2715'>
                   MH_URB2D(I,J)=0.<a name='2716'>
                   STDH_URB2D(I,J)=0.<a name='2717'>
                   DO K=1,4<a name='2718'>
                      LF_URB2D(I,K,J)=0.<a name='2719'>
                   ENDDO<a name='2720'>
                ELSE IF ( ( sf_urban_physics == 2 ) .or. ( sf_urban_physics == 3 ) ) THEN<a name='2721'>
                   DO K=1,num_urban_hi<a name='2722'>
                      HI_URB2D(I,K,J)=0.<a name='2723'>
                   ENDDO<a name='2724'>
                ENDIF<a name='2725'>
            ENDIF<a name='2726'>
<a name='2727'>
<a name='2728'>
      QC_URB2D(I,J)=0.01<a name='2729'>
<a name='2730'>
       IF (.not.restart) THEN<a name='2731'>
<a name='2732'>
      XXXR_URB2D(I,J)=0.<a name='2733'>
      XXXB_URB2D(I,J)=0.<a name='2734'>
      XXXG_URB2D(I,J)=0.<a name='2735'>
      XXXC_URB2D(I,J)=0.<a name='2736'>
<a name='2737'>
      IF ( sf_urban_physics == 1 ) THEN<a name='2738'>
      DRELR_URB2D(I,J) = 0.<a name='2739'>
      DRELB_URB2D(I,J) = 0.<a name='2740'>
      DRELG_URB2D(I,J) = 0.<a name='2741'>
      FLXHUMR_URB2D(I,J) = 0.<a name='2742'>
      FLXHUMB_URB2D(I,J) = 0.<a name='2743'>
      FLXHUMG_URB2D(I,J) = 0.<a name='2744'>
      CMCR_URB2D(I,J)  = 0.<a name='2745'>
      TGR_URB2D(I,J)=TSURFACE0_URB(I,J)+0.<a name='2746'>
      ENDIF<a name='2747'>
<a name='2748'>
      TC_URB2D(I,J)=TSURFACE0_URB(I,J)+0.<a name='2749'>
      TR_URB2D(I,J)=TSURFACE0_URB(I,J)+0.<a name='2750'>
      TB_URB2D(I,J)=TSURFACE0_URB(I,J)+0.<a name='2751'>
      TG_URB2D(I,J)=TSURFACE0_URB(I,J)+0.<a name='2752'>
<font color=#447700>!<a name='2753'></font>
      TS_URB2D(I,J)=TSURFACE0_URB(I,J)+0.<a name='2754'>
<a name='2755'>
<font color=#447700>!     DO K=1,num_roof_layers<a name='2756'></font>
<font color=#447700>!     DO K=1,num_soil_layers<a name='2757'></font>
<font color=#447700>!         TRL_URB3D(I,1,J)=TLAYER0_URB(I,1,J)+0.<a name='2758'></font>
<font color=#447700>!         TRL_URB3D(I,2,J)=TLAYER0_URB(I,2,J)+0.<a name='2759'></font>
<font color=#447700>!         TRL_URB3D(I,3,J)=TLAYER0_URB(I,3,J)+0.<a name='2760'></font>
<font color=#447700>!         TRL_URB3D(I,4,J)=TLAYER0_URB(I,4,J)+0.<a name='2761'></font>
<a name='2762'>
          TRL_URB3D(I,1,J)=TLAYER0_URB(I,1,J)+0.<a name='2763'>
          TRL_URB3D(I,2,J)=0.5*(TLAYER0_URB(I,1,J)+TLAYER0_URB(I,2,J))<a name='2764'>
          TRL_URB3D(I,3,J)=TLAYER0_URB(I,2,J)+0.<a name='2765'>
          TRL_URB3D(I,4,J)=TLAYER0_URB(I,2,J)+(TLAYER0_URB(I,3,J)-TLAYER0_URB(I,2,J))*0.29<a name='2766'>
<a name='2767'>
      IF ( sf_urban_physics == 1 ) THEN<a name='2768'>
          TGRL_URB3D(I,1,J)=TLAYER0_URB(I,1,J)+0.<a name='2769'>
          TGRL_URB3D(I,2,J)=0.5*(TLAYER0_URB(I,1,J)+TLAYER0_URB(I,2,J))<a name='2770'>
          TGRL_URB3D(I,3,J)=TLAYER0_URB(I,2,J)+0.<a name='2771'>
          TGRL_URB3D(I,4,J)=TLAYER0_URB(I,2,J)+(TLAYER0_URB(I,3,J)-TLAYER0_URB(I,2,J))*0.29<a name='2772'>
<a name='2773'>
          SMR_URB3D(I,1,J)=0.2<a name='2774'>
          SMR_URB3D(I,2,J)=0.2<a name='2775'>
          SMR_URB3D(I,3,J)=0.2<a name='2776'>
          SMR_URB3D(I,4,J)=0.<a name='2777'>
      ENDIF<a name='2778'>
<font color=#447700>!     END DO<a name='2779'></font>
<a name='2780'>
<font color=#447700>!      DO K=1,num_wall_layers<a name='2781'></font>
<font color=#447700>!      DO K=1,num_soil_layers<a name='2782'></font>
<font color=#447700>!m        TBL_URB3D(I,1,J)=TLAYER0_URB(I,1,J)+0.<a name='2783'></font>
<font color=#447700>!m        TBL_URB3D(I,2,J)=TLAYER0_URB(I,2,J)+0.<a name='2784'></font>
<font color=#447700>!m        TBL_URB3D(I,3,J)=TLAYER0_URB(I,3,J)+0.<a name='2785'></font>
<font color=#447700>!m        TBL_URB3D(I,4,J)=TLAYER0_URB(I,4,J)+0.<a name='2786'></font>
<a name='2787'>
        TBL_URB3D(I,1,J)=TLAYER0_URB(I,1,J)+0.<a name='2788'>
        TBL_URB3D(I,2,J)=0.5*(TLAYER0_URB(I,1,J)+TLAYER0_URB(I,2,J))<a name='2789'>
        TBL_URB3D(I,3,J)=TLAYER0_URB(I,2,J)+0.<a name='2790'>
        TBL_URB3D(I,4,J)=TLAYER0_URB(I,2,J)+(TLAYER0_URB(I,3,J)-TLAYER0_URB(I,2,J))*0.29<a name='2791'>
<a name='2792'>
<font color=#447700>!      END DO<a name='2793'></font>
<a name='2794'>
<font color=#447700>!      DO K=1,num_road_layers<a name='2795'></font>
      DO K=1,num_soil_layers<a name='2796'>
        TGL_URB3D(I,K,J)=TLAYER0_URB(I,K,J)+0.<a name='2797'>
      END DO<a name='2798'>
      <a name='2799'>
<font color=#447700>! multi-layer urban<a name='2800'></font>
<font color=#447700>!      IF( sf_urban_physics .EQ. 2)THEN<a name='2801'></font>
       IF((SF_URBAN_PHYSICS.eq.2).OR.(SF_URBAN_PHYSICS.eq.3)) THEN<a name='2802'>
      DO k=1,num_urban_layers<a name='2803'>
<font color=#447700>!        TRB_URB4D(I,k,J)=TSURFACE0_URB(I,J)<a name='2804'></font>
<font color=#447700>!        TW1_URB4D(I,k,J)=TSURFACE0_URB(I,J)<a name='2805'></font>
<font color=#447700>!        TW2_URB4D(I,k,J)=TSURFACE0_URB(I,J)<a name='2806'></font>
<font color=#447700>!        TGB_URB4D(I,k,J)=TSURFACE0_URB(I,J)<a name='2807'></font>
<font color=#447700>!MT        TRB_URB4D(I,K,J)=tlayer0_urb(I,1,J)<a name='2808'></font>
<font color=#447700>!MT        TW1_URB4D(I,K,J)=tlayer0_urb(I,1,J)<a name='2809'></font>
<font color=#447700>!MT        TW2_URB4D(I,K,J)=tlayer0_urb(I,1,J)<a name='2810'></font>
        IF (UTYPE_URB2D(I,J) &gt; 0) THEN<a name='2811'>
           TRB_URB4D(I,K,J)=TBLEND_TBL(UTYPE_URB2D(I,J))<a name='2812'>
           TW1_URB4D(I,K,J)=TBLEND_TBL(UTYPE_URB2D(I,J))<a name='2813'>
           TW2_URB4D(I,K,J)=TBLEND_TBL(UTYPE_URB2D(I,J))<a name='2814'>
        ELSE<a name='2815'>
           TRB_URB4D(I,K,J)=tlayer0_urb(I,1,J)<a name='2816'>
           TW1_URB4D(I,K,J)=tlayer0_urb(I,1,J)<a name='2817'>
           TW2_URB4D(I,K,J)=tlayer0_urb(I,1,J)<a name='2818'>
        ENDIF<a name='2819'>
        TGB_URB4D(I,K,J)=tlayer0_urb(I,1,J)<a name='2820'>
        SFW1_URB3D(I,K,J)=0.<a name='2821'>
        SFW2_URB3D(I,K,J)=0.<a name='2822'>
        SFR_URB3D(I,K,J)=0.<a name='2823'>
        SFG_URB3D(I,K,J)=0.<a name='2824'>
      ENDDO<a name='2825'>
       <a name='2826'>
       ENDIF <a name='2827'>
              <a name='2828'>
      if (SF_URBAN_PHYSICS.EQ.3) then<a name='2829'>
         LF_AC_URB3D(I,J)=0.<a name='2830'>
         SF_AC_URB3D(I,J)=0.<a name='2831'>
         CM_AC_URB3D(I,J)=0.<a name='2832'>
         SFVENT_URB3D(I,J)=0.<a name='2833'>
         LFVENT_URB3D(I,J)=0.<a name='2834'>
<a name='2835'>
         DO K=1,num_urban_layers<a name='2836'>
            TLEV_URB3D(I,K,J)=tlayer0_urb(I,1,J)<a name='2837'>
            TW1LEV_URB3D(I,K,J)=tlayer0_urb(I,1,J)<a name='2838'>
            TW2LEV_URB3D(I,K,J)=tlayer0_urb(I,1,J)<a name='2839'>
            TGLEV_URB3D(I,K,J)=tlayer0_urb(I,1,J)<a name='2840'>
            TFLEV_URB3D(I,K,J)=tlayer0_urb(I,1,J)<a name='2841'>
            QLEV_URB3D(I,K,J)=0.01<a name='2842'>
            SFWIN1_URB3D(I,K,J)=0.<a name='2843'>
            SFWIN2_URB3D(I,K,J)=0.<a name='2844'>
<font color=#447700>!rm         LF_AC_URB3D(I,J)=0.<a name='2845'></font>
<font color=#447700>!rm         SF_AC_URB3D(I,J)=0.<a name='2846'></font>
<font color=#447700>!rm         CM_AC_URB3D(I,J)=0.<a name='2847'></font>
<font color=#447700>!rm         SFVENT_URB3D(I,J)=0.<a name='2848'></font>
<font color=#447700>!rm         LFVENT_URB3D(I,J)=0.<a name='2849'></font>
         ENDDO<a name='2850'>
<a name='2851'>
      endif<a name='2852'>
<a name='2853'>
<font color=#447700>!      IF( sf_urban_physics .EQ. 2 )THEN<a name='2854'></font>
      IF((SF_URBAN_PHYSICS.eq.2).OR.(SF_URBAN_PHYSICS.eq.3)) THEN<a name='2855'>
      DO K= KMS,KME<a name='2856'>
          SF_BEP(I,K,J)=1.<a name='2857'>
          VL_BEP(I,K,J)=1.<a name='2858'>
          A_U_BEP(I,K,J)=0.<a name='2859'>
          A_V_BEP(I,K,J)=0.<a name='2860'>
          A_T_BEP(I,K,J)=0.<a name='2861'>
          A_E_BEP(I,K,J)=0.<a name='2862'>
          A_Q_BEP(I,K,J)=0.<a name='2863'>
          B_U_BEP(I,K,J)=0.<a name='2864'>
          B_V_BEP(I,K,J)=0.<a name='2865'>
          B_T_BEP(I,K,J)=0.<a name='2866'>
          B_E_BEP(I,K,J)=0.<a name='2867'>
          B_Q_BEP(I,K,J)=0.<a name='2868'>
          DLG_BEP(I,K,J)=0.<a name='2869'>
          DL_U_BEP(I,K,J)=0.<a name='2870'>
      END DO<a name='2871'>
      ENDIF       <font color=#447700>!sf_urban_physics=2<a name='2872'></font>
     ENDIF        <font color=#447700>!restart<a name='2873'></font>
<a name='2874'>
<a name='2875'>
      IF (CHECK.EQ.0)THEN<a name='2876'>
      IF(IVGTYP(I,J).EQ.1)THEN<a name='2877'>
        write(mesg,*) 'TSURFACE0_URB',TSURFACE0_URB(I,J)<a name='2878'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1029">(mesg)<a name='2879'>
        write(mesg,*) 'TDEEP0_URB', TDEEP0_URB(I,J)<a name='2880'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1030">(mesg)<a name='2881'>
        write(mesg,*) 'IVGTYP',IVGTYP(I,J)<a name='2882'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1031">(mesg)<a name='2883'>
        write(mesg,*) 'TR_URB2D',TR_URB2D(I,J)<a name='2884'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1032">(mesg)<a name='2885'>
        write(mesg,*) 'TB_URB2D',TB_URB2D(I,J)<a name='2886'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1033">(mesg)<a name='2887'>
        write(mesg,*) 'TG_URB2D',TG_URB2D(I,J)<a name='2888'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1034">(mesg)<a name='2889'>
        write(mesg,*) 'TC_URB2D',TC_URB2D(I,J)<a name='2890'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1035">(mesg)<a name='2891'>
        write(mesg,*) 'QC_URB2D',QC_URB2D(I,J)<a name='2892'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1036">(mesg)<a name='2893'>
        write(mesg,*) 'XXXR_URB2D',XXXR_URB2D(I,J)<a name='2894'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1037">(mesg)<a name='2895'>
        write(mesg,*) 'SH_URB2D',SH_URB2D(I,J)<a name='2896'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1038">(mesg)<a name='2897'>
        write(mesg,*) 'LH_URB2D',LH_URB2D(I,J)<a name='2898'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1039">(mesg)<a name='2899'>
        write(mesg,*) 'G_URB2D',G_URB2D(I,J)<a name='2900'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1040">(mesg)<a name='2901'>
        write(mesg,*) 'RN_URB2D',RN_URB2D(I,J)<a name='2902'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1041">(mesg)<a name='2903'>
        write(mesg,*) 'TS_URB2D',TS_URB2D(I,J)<a name='2904'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1042">(mesg)<a name='2905'>
        write(mesg,*) 'LF_AC_URB3D', LF_AC_URB3D(I,J)<a name='2906'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1043">(mesg)<a name='2907'>
        write(mesg,*) 'SF_AC_URB3D', SF_AC_URB3D(I,J)<a name='2908'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1044">(mesg)<a name='2909'>
        write(mesg,*) 'CM_AC_URB3D', CM_AC_URB3D(I,J)<a name='2910'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1045">(mesg)<a name='2911'>
        write(mesg,*) 'SFVENT_URB3D', SFVENT_URB3D(I,J)<a name='2912'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1046">(mesg)<a name='2913'>
        write(mesg,*) 'LFVENT_URB3D', LFVENT_URB3D(I,J)<a name='2914'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1047">(mesg)<a name='2915'>
        write(mesg,*) 'FRC_URB2D', FRC_URB2D(I,J)<a name='2916'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1048">(mesg)<a name='2917'>
        write(mesg,*) 'UTYPE_URB2D', UTYPE_URB2D(I,J)<a name='2918'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1049">(mesg)<a name='2919'>
        write(mesg,*) 'I',I,'J',J<a name='2920'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1050">(mesg)<a name='2921'>
        write(mesg,*) 'num_urban_hi', num_urban_hi<a name='2922'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_urban.F.html#URBAN_VAR_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1051">(mesg)<a name='2923'>
        CHECK = 1<a name='2924'>
       END IF<a name='2925'>
       END IF<a name='2926'>
<a name='2927'>
    END DO<a name='2928'>
   END DO<a name='2929'>
   RETURN<a name='2930'>
   END SUBROUTINE urban_var_init<a name='2931'>
<font color=#447700>!===========================================================================<a name='2932'></font>
<font color=#447700>!<a name='2933'></font>
<font color=#447700>!  force_restore<a name='2934'></font>
<font color=#447700>!<a name='2935'></font>
<font color=#447700>!===========================================================================<a name='2936'></font>
<A NAME='FORCE_RESTORE'><A href='../../html_code/phys/module_sf_urban.F.html#FORCE_RESTORE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2937'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>force_restore</font>(CAP,AKS,DELT,S,R,H,LE,TSLEND,TSP,TS) <A href='../../call_to/FORCE_RESTORE.html' TARGET='index'>3</A><a name='2938'>
<a name='2939'>
     REAL, INTENT(IN)  :: CAP,AKS,DELT,S,R,H,LE,TSLEND,TSP<a name='2940'>
     REAL, INTENT(OUT) :: TS<a name='2941'>
     REAL              :: C1,C2<a name='2942'>
<a name='2943'>
     C2=24.*3600./2./3.14159<a name='2944'>
     C1=SQRT(0.5*C2*CAP*AKS)<a name='2945'>
<a name='2946'>
     TS = TSP + DELT*( (S+R-H-LE)/C1 -(TSP-TSLEND)/C2 )<a name='2947'>
<a name='2948'>
   END SUBROUTINE force_restore<a name='2949'>
<font color=#447700>!===========================================================================<a name='2950'></font>
<font color=#447700>!<a name='2951'></font>
<font color=#447700>!  bisection (not used)<a name='2952'></font>
<font color=#447700>!<a name='2953'></font>
<font color=#447700>!============================================================================== <a name='2954'></font>
<A NAME='BISECTION'><A href='../../html_code/phys/module_sf_urban.F.html#BISECTION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2955'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>bisection</font>(TSP,PS,S,EPS,RX,SIG,RHO,CP,CH,UA,QA,TA,EL,BET,AKS,TSL,DZ,TS) <a name='2956'>
<a name='2957'>
     REAL, INTENT(IN) :: TSP,PS,S,EPS,RX,SIG,RHO,CP,CH,UA,QA,TA,EL,BET,AKS,TSL,DZ<a name='2958'>
     REAL, INTENT(OUT) :: TS<a name='2959'>
     REAL :: ES,QS0,R,H,ELE,G0,F1,F<a name='2960'>
<a name='2961'>
     TS1 = TSP - 5.<a name='2962'>
     TS2 = TSP + 5.<a name='2963'>
<a name='2964'>
     DO ITERATION = 1,22<a name='2965'>
<a name='2966'>
       ES=6.11*EXP( (2.5*10.**6./461.51)*(TS1-273.15)/(273.15*TS1) )<a name='2967'>
       QS0=0.622*ES/(PS-0.378*ES)<a name='2968'>
       R=EPS*(RX-SIG*(TS1**4.)/60.)<a name='2969'>
       H=RHO*CP*CH*UA*(TS1-TA)*100.<a name='2970'>
       ELE=RHO*EL*CH*UA*BET*(QS0-QA)*100.<a name='2971'>
       G0=AKS*(TS1-TSL)/(DZ/2.)<a name='2972'>
       F1= S + R - H - ELE - G0<a name='2973'>
<a name='2974'>
       TS=0.5*(TS1+TS2)<a name='2975'>
<a name='2976'>
       ES=6.11*EXP( (2.5*10.**6./461.51)*(TS-273.15)/(273.15*TS) )<a name='2977'>
       QS0=0.622*ES/(PS-0.378*ES) <a name='2978'>
       R=EPS*(RX-SIG*(TS**4.)/60.)<a name='2979'>
       H=RHO*CP*CH*UA*(TS-TA)*100.<a name='2980'>
       ELE=RHO*EL*CH*UA*BET*(QS0-QA)*100.<a name='2981'>
       G0=AKS*(TS-TSL)/(DZ/2.)<a name='2982'>
       F = S + R - H - ELE - G0<a name='2983'>
<a name='2984'>
       IF (F1*F &gt; 0.0) THEN<a name='2985'>
         TS1=TS<a name='2986'>
        ELSE<a name='2987'>
         TS2=TS<a name='2988'>
       END IF<a name='2989'>
<a name='2990'>
     END DO<a name='2991'>
<a name='2992'>
     RETURN<a name='2993'>
END SUBROUTINE bisection<a name='2994'>
<font color=#447700>!===========================================================================<a name='2995'></font>
<a name='2996'>
<A NAME='SFCDIF_URB'><A href='../../html_code/phys/module_sf_urban.F.html#SFCDIF_URB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2997'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>SFCDIF_URB</font> (ZLM,Z0,THZ0,THLM,SFCSPD,AKANDA,AKMS,AKHS,RLMO,CD) <A href='../../call_to/SFCDIF_URB.html' TARGET='index'>3</A><a name='2998'>
<a name='2999'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3000'></font>
<font color=#447700>! SUBROUTINE SFCDIF_URB (Urban version of SFCDIF_off)<a name='3001'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3002'></font>
<font color=#447700>! CALCULATE SURFACE LAYER EXCHANGE COEFFICIENTS VIA ITERATIVE PROCESS.<a name='3003'></font>
<font color=#447700>! SEE CHEN ET AL (1997, BLM)<a name='3004'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3005'></font>
<a name='3006'>
      IMPLICIT NONE<a name='3007'>
      REAL     WWST, WWST2, G, VKRM, EXCM, BETA, BTG, ELFC, WOLD, WNEW<a name='3008'>
      REAL     PIHF, EPSU2, EPSUST, EPSIT, EPSA, ZTMIN, ZTMAX, HPBL,     &amp;<a name='3009'>
     &amp; SQVISC<a name='3010'>
      REAL     RIC, RRIC, FHNEU, RFC,RLMO_THR, RFAC, ZZ, PSLMU, PSLMS, PSLHU,     &amp;<a name='3011'>
     &amp; PSLHS<a name='3012'>
      REAL     XX, PSPMU, YY, PSPMS, PSPHU, PSPHS, ZLM, Z0, THZ0, THLM<a name='3013'>
      REAL     SFCSPD, AKANDA, AKMS, AKHS, ZU, ZT, RDZ, CXCH<a name='3014'>
      REAL     DTHV, DU2, BTGH, WSTAR2, USTAR, ZSLU, ZSLT, RLOGU, RLOGT<a name='3015'>
      REAL     RLMO, ZETALT, ZETALU, ZETAU, ZETAT, XLU4, XLT4, XU4, XT4<a name='3016'>
<font color=#447700>!CC   ......REAL ZTFC<a name='3017'></font>
<a name='3018'>
      REAL     XLU, XLT, XU, XT, PSMZ, SIMM, PSHZ, SIMH, USTARK, RLMN,  &amp;<a name='3019'>
     &amp;         RLMA<a name='3020'>
<a name='3021'>
      INTEGER  ITRMX, ILECH, ITR<a name='3022'>
      REAL,    INTENT(OUT) :: CD<a name='3023'>
      PARAMETER                                                         &amp;<a name='3024'>
     &amp;        (WWST = 1.2,WWST2 = WWST * WWST,G = 9.8,VKRM = 0.40,      &amp;<a name='3025'>
     &amp;         EXCM = 0.001                                             &amp;<a name='3026'>
     &amp;        ,BETA = 1./270.,BTG = BETA * G,ELFC = VKRM * BTG          &amp;<a name='3027'>
     &amp;                  ,WOLD =.15,WNEW = 1. - WOLD,ITRMX = 05,         &amp;<a name='3028'>
     &amp;                   PIHF = 3.14159265/2.)<a name='3029'>
      PARAMETER                                                         &amp;<a name='3030'>
     &amp;         (EPSU2 = 1.E-4,EPSUST = 0.07,EPSIT = 1.E-4,EPSA = 1.E-8  &amp;<a name='3031'>
     &amp;         ,ZTMIN = -5.,ZTMAX = 1.,HPBL = 1000.0                    &amp;<a name='3032'>
     &amp;          ,SQVISC = 258.2)<a name='3033'>
      PARAMETER                                                         &amp;<a name='3034'>
     &amp;       (RIC = 0.183,RRIC = 1.0/ RIC,FHNEU = 0.8,RFC = 0.191       &amp;<a name='3035'>
     &amp;        ,RLMO_THR = 0.001,RFAC = RIC / (FHNEU * RFC * RFC))<a name='3036'>
<a name='3037'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3038'></font>
<font color=#447700>! NOTE: THE TWO CODE BLOCKS BELOW DEFINE FUNCTIONS<a name='3039'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3040'></font>
<font color=#447700>! LECH'S SURFACE FUNCTIONS<a name='3041'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3042'></font>
      PSLMU (ZZ)= -0.96* log (1.0-4.5* ZZ)<a name='3043'>
      PSLMS (ZZ)= ZZ * RRIC -2.076* (1. -1./ (ZZ +1.))<a name='3044'>
      PSLHU (ZZ)= -0.96* log (1.0-4.5* ZZ)<a name='3045'>
<a name='3046'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3047'></font>
<font color=#447700>! PAULSON'S SURFACE FUNCTIONS<a name='3048'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3049'></font>
      PSLHS (ZZ)= ZZ * RFAC -2.076* (1. -1./ (ZZ +1.))<a name='3050'>
      PSPMU (XX)= -2.* log ( (XX +1.)*0.5) - log ( (XX * XX +1.)*0.5)   &amp;<a name='3051'>
     &amp;        +2.* ATAN (XX)                                            &amp;<a name='3052'>
     &amp;- PIHF<a name='3053'>
      PSPMS (YY)= 5.* YY<a name='3054'>
      PSPHU (XX)= -2.* log ( (XX * XX +1.)*0.5)<a name='3055'>
<a name='3056'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3057'></font>
<font color=#447700>! THIS ROUTINE SFCDIF CAN HANDLE BOTH OVER OPEN WATER (SEA, OCEAN) AND<a name='3058'></font>
<font color=#447700>! OVER SOLID SURFACE (LAND, SEA-ICE).<a name='3059'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3060'></font>
      PSPHS (YY)= 5.* YY<a name='3061'>
<a name='3062'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3063'></font>
<font color=#447700>!     ZTFC: RATIO OF ZOH/ZOM  LESS OR EQUAL THAN 1<a name='3064'></font>
<font color=#447700>!     C......ZTFC=0.1<a name='3065'></font>
<font color=#447700>!     CZIL: CONSTANT C IN Zilitinkevich, S. S.1995,:NOTE ABOUT ZT<a name='3066'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3067'></font>
      ILECH = 0<a name='3068'>
<a name='3069'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3070'></font>
<font color=#447700>!      ZILFC = - CZIL * VKRM * SQVISC<a name='3071'></font>
<font color=#447700>!     C.......ZT=Z0*ZTFC<a name='3072'></font>
      ZU = Z0<a name='3073'>
      RDZ = 1./ ZLM<a name='3074'>
      CXCH = EXCM * RDZ<a name='3075'>
      DTHV = THLM - THZ0<a name='3076'>
<a name='3077'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3078'></font>
<font color=#447700>! BELJARS CORRECTION OF USTAR<a name='3079'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3080'></font>
      DU2 = MAX (SFCSPD * SFCSPD,EPSU2)<a name='3081'>
<font color=#447700>!cc   If statements to avoid TANGENT LINEAR problems near zero<a name='3082'></font>
      BTGH = BTG * HPBL<a name='3083'>
      IF (BTGH * AKHS * DTHV .ne. 0.0) THEN<a name='3084'>
         WSTAR2 = WWST2* ABS (BTGH * AKHS * DTHV)** (2./3.)<a name='3085'>
      ELSE<a name='3086'>
         WSTAR2 = 0.0<a name='3087'>
      END IF<a name='3088'>
<a name='3089'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3090'></font>
<font color=#447700>! ZILITINKEVITCH APPROACH FOR ZT<a name='3091'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3092'></font>
      USTAR = MAX (SQRT (AKMS * SQRT (DU2+ WSTAR2)),EPSUST)<a name='3093'>
<a name='3094'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3095'></font>
<font color=#447700>! KCL/TL Try Kanda approach instead (Kanda et al. 2007, JAMC)<a name='3096'></font>
<font color=#447700>!      ZT = EXP (ZILFC * SQRT (USTAR * Z0))* Z0<a name='3097'></font>
      ZT = EXP (2.0-AKANDA*(SQVISC**2 * USTAR * Z0)**0.25)* Z0<a name='3098'>
      <a name='3099'>
      ZSLU = ZLM + ZU<a name='3100'>
<a name='3101'>
      ZSLT = ZLM + ZT<a name='3102'>
      RLOGU = log (ZSLU / ZU)<a name='3103'>
<a name='3104'>
      RLOGT = log (ZSLT / ZT)<a name='3105'>
<a name='3106'>
      RLMO = ELFC * AKHS * DTHV / USTAR **3<a name='3107'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3108'></font>
<font color=#447700>! 1./MONIN-OBUKKHOV LENGTH-SCALE<a name='3109'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3110'></font>
      DO ITR = 1,ITRMX<a name='3111'>
         ZETALT = MAX (ZSLT * RLMO,ZTMIN)<a name='3112'>
         RLMO = ZETALT / ZSLT<a name='3113'>
         ZETALU = ZSLU * RLMO<a name='3114'>
         ZETAU = ZU * RLMO<a name='3115'>
<a name='3116'>
         ZETAT = ZT * RLMO<a name='3117'>
         IF (ILECH .eq. 0) THEN<a name='3118'>
            IF (RLMO .lt. 0.0)THEN <a name='3119'>
               XLU4 = 1. -16.* ZETALU<a name='3120'>
               XLT4 = 1. -16.* ZETALT<a name='3121'>
               XU4 = 1. -16.* ZETAU<a name='3122'>
<a name='3123'>
               XT4 = 1. -16.* ZETAT<a name='3124'>
               XLU = SQRT (SQRT (XLU4))<a name='3125'>
               XLT = SQRT (SQRT (XLT4))<a name='3126'>
               XU = SQRT (SQRT (XU4))<a name='3127'>
<a name='3128'>
               XT = SQRT (SQRT (XT4))<a name='3129'>
<a name='3130'>
               PSMZ = PSPMU (XU)<a name='3131'>
               SIMM = PSPMU (XLU) - PSMZ + RLOGU<a name='3132'>
               PSHZ = PSPHU (XT)<a name='3133'>
               SIMH = PSPHU (XLT) - PSHZ + RLOGT<a name='3134'>
            ELSE<a name='3135'>
               ZETALU = MIN (ZETALU,ZTMAX)<a name='3136'>
               ZETALT = MIN (ZETALT,ZTMAX)<a name='3137'>
               PSMZ = PSPMS (ZETAU)<a name='3138'>
               SIMM = PSPMS (ZETALU) - PSMZ + RLOGU<a name='3139'>
               PSHZ = PSPHS (ZETAT)<a name='3140'>
               SIMH = PSPHS (ZETALT) - PSHZ + RLOGT<a name='3141'>
            END IF<a name='3142'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3143'></font>
<font color=#447700>! LECH'S FUNCTIONS<a name='3144'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3145'></font>
         ELSE<a name='3146'>
            IF (RLMO .lt. 0.)THEN<a name='3147'>
               PSMZ = PSLMU (ZETAU)<a name='3148'>
               SIMM = PSLMU (ZETALU) - PSMZ + RLOGU<a name='3149'>
               PSHZ = PSLHU (ZETAT)<a name='3150'>
               SIMH = PSLHU (ZETALT) - PSHZ + RLOGT<a name='3151'>
            ELSE<a name='3152'>
               ZETALU = MIN (ZETALU,ZTMAX)<a name='3153'>
               ZETALT = MIN (ZETALT,ZTMAX)<a name='3154'>
               PSMZ = PSLMS (ZETAU)<a name='3155'>
               SIMM = PSLMS (ZETALU) - PSMZ + RLOGU<a name='3156'>
               PSHZ = PSLHS (ZETAT)<a name='3157'>
               SIMH = PSLHS (ZETALT) - PSHZ + RLOGT<a name='3158'>
            END IF<a name='3159'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3160'></font>
<font color=#447700>! BELJAARS CORRECTION FOR USTAR<a name='3161'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3162'></font>
         END IF<a name='3163'>
            USTAR = MAX (SQRT (AKMS * SQRT (DU2+ WSTAR2)),EPSUST)<a name='3164'>
            <font color=#447700>!KCL/TL<a name='3165'></font>
            <font color=#447700>!ZT = EXP (ZILFC * SQRT (USTAR * Z0))* Z0<a name='3166'></font>
            ZT = EXP (2.0-AKANDA*(SQVISC**2 * USTAR * Z0)**0.25)* Z0<a name='3167'>
            ZSLT = ZLM + ZT<a name='3168'>
            RLOGT = log (ZSLT / ZT)<a name='3169'>
            USTARK = USTAR * VKRM<a name='3170'>
            AKMS = MAX (USTARK / SIMM,CXCH)<a name='3171'>
            AKHS = MAX (USTARK / SIMH,CXCH)<a name='3172'>
<font color=#447700>!<a name='3173'></font>
         IF (BTGH * AKHS * DTHV .ne. 0.0) THEN<a name='3174'>
            WSTAR2 = WWST2* ABS (BTGH * AKHS * DTHV)** (2./3.)<a name='3175'>
         ELSE<a name='3176'>
            WSTAR2 = 0.0<a name='3177'>
         END IF<a name='3178'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3179'></font>
         RLMN = ELFC * AKHS * DTHV / USTAR **3<a name='3180'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3181'></font>
<font color=#447700>!     IF(ABS((RLMN-RLMO)/RLMA).LT.EPSIT)    GO TO 110<a name='3182'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3183'></font>
         RLMA = RLMO * WOLD+ RLMN * WNEW<a name='3184'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3185'></font>
         RLMO = RLMA<a name='3186'>
<a name='3187'>
      END DO<a name='3188'>
<a name='3189'>
      CD = USTAR*USTAR/SFCSPD**2<a name='3190'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3191'></font>
  END SUBROUTINE SFCDIF_URB<a name='3192'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3193'></font>
<font color=#447700>!===========================================================================<a name='3194'></font>
<font color=#447700>!  DIREVAP <a name='3195'></font>
<font color=#447700>!  CALCULATE DIRECT SOIL EVAPORATION<a name='3196'></font>
<font color=#447700>!===========================================================================<a name='3197'></font>
<A NAME='DIREVAP'><A href='../../html_code/phys/module_sf_urban.F.html#DIREVAP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3198'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>DIREVAP</font> (EDIR,ETP,SMC,SHDFAC,SMCMAX,SMCDRY,FXEXP) <A href='../../call_to/DIREVAP.html' TARGET='index'>1</A><a name='3199'>
<a name='3200'>
     REAL, INTENT(IN)  :: ETP,SMC,SHDFAC,SMCMAX,SMCDRY,FXEXP<a name='3201'>
     REAL, INTENT(OUT) :: EDIR<a name='3202'>
     REAL              :: FX, SRATIO<a name='3203'>
<a name='3204'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3205'></font>
<font color=#447700>! FX &gt; 1 REPRESENTS DEMAND CONTROL<a name='3206'></font>
<font color=#447700>! FX &lt; 1 REPRESENTS FLUX CONTROL<a name='3207'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3208'></font>
      SRATIO = (SMC - SMCDRY) / (SMCMAX - SMCDRY)<a name='3209'>
      IF (SRATIO &gt; 0.) THEN<a name='3210'>
        FX = SRATIO**FXEXP<a name='3211'>
        FX = MAX ( MIN ( FX, 1. ) ,0. )<a name='3212'>
      ELSE<a name='3213'>
        FX = 0.<a name='3214'>
      ENDIF<a name='3215'>
      EDIR = FX * ( 1.0- SHDFAC ) * ETP * 0.001<a name='3216'>
      <a name='3217'>
 END SUBROUTINE DIREVAP<a name='3218'>
<font color=#447700>!===========================================================================<a name='3219'></font>
<font color=#447700>!  TRANSP<a name='3220'></font>
<font color=#447700>!  CALCULATE EVAPOTRANSPIRATION FOR VEGETATIO SURFACE<a name='3221'></font>
<font color=#447700>!===========================================================================<a name='3222'></font>
      <a name='3223'>
<A NAME='TRANSP'><A href='../../html_code/phys/module_sf_urban.F.html#TRANSP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3224'>
     <font color=#993300>SUBROUTINE </font><font color=#cc0000>TRANSP</font> (ETT,ET,EC,SHDFAC,ETP1,CMC,CFACTR,CMCMAX,LAI,RSMIN,RSMAX,RGL,SX, &amp; <A href='../../call_to/TRANSP.html' TARGET='index'>2</A><a name='3225'>
                        TS,TA,QA,SMC,SMCWLT,SMCREF,CPP,PS,CH,EPSV,DELT, NROOT,NSOIL,    &amp;<a name='3226'>
                        DZVR, ZSOIL, HS)<a name='3227'>
     INTEGER, INTENT(IN)   :: NROOT, NSOIL<a name='3228'>
     REAL, INTENT(IN)  :: SHDFAC,ETP1,CMC,CFACTR,CMCMAX,LAI,RSMIN,RSMAX,RGL,SX,TA<a name='3229'>
     REAL, INTENT(IN)  :: TS,QA, SMCWLT, SMCREF, CPP, PS,CH, EPSV, DELT, HS<a name='3230'>
     REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: ZSOIL, DZVR, SMC<a name='3231'>
     REAL, DIMENSION(1:NSOIL), INTENT(INOUT):: ET<a name='3232'>
     REAL, INTENT(OUT) :: EC, ETT<a name='3233'>
     REAL              :: RC, RCS, RCT, RCQ, RCSOIL, FF, WS, SLV, DESDT<a name='3234'>
     REAL              :: SIGMA, PC, CMC2MS, SGX, DENOM, RTX, ETT1<a name='3235'>
     INTEGER           :: K<a name='3236'>
     REAL, DIMENSION(1:NROOT) ::  PART, GX<a name='3237'>
     <a name='3238'>
     SLV    = 2.501E+6<a name='3239'>
     SIGMA  = 5.67E-8<a name='3240'>
     ETT    = 0.0<a name='3241'>
     DO K = 1, NSOIL<a name='3242'>
       ET(K) = 0.<a name='3243'>
     END DO<a name='3244'>
     <a name='3245'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3246'></font>
<font color=#447700>! INITIALIZE CANOPY RESISTANCE MULTIPLIER TERMS.<a name='3247'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3248'></font>
      RCS = 0.0<a name='3249'>
      RCT = 0.0<a name='3250'>
      RCQ = 0.0<a name='3251'>
      RCSOIL = 0.0<a name='3252'>
      <a name='3253'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3254'></font>
<font color=#447700>! CONTRIBUTION DUE TO INCOMING SOLAR RADIATION<a name='3255'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3256'></font>
      FF  = 0.55*2.0* SX*697.7 * 60/ (RGL * LAI)<a name='3257'>
      RCS = (FF + RSMIN / RSMAX) / (1.0+ FF)<a name='3258'>
      RCS = MAX (RCS,0.0001)<a name='3259'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3260'></font>
<font color=#447700>! CONTRIBUTION DUE TO AIR TEMPERATURE AT FIRST MODEL LEVEL ABOVE GROUND<a name='3261'></font>
<font color=#447700>! RCT EXPRESSION FROM NOILHAN AND PLANTON (1989, MWR).<a name='3262'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3263'></font>
      RCT = 1.0- 0.0016* ( (298 - TA)**2.0)<a name='3264'>
      RCT = MAX (RCT,0.0001)<a name='3265'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3266'></font>
<font color=#447700>! CONTRIBUTION DUE TO VAPOR PRESSURE DEFICIT AT FIRST MODEL LEVEL.<a name='3267'></font>
<font color=#447700>! RCQ EXPRESSION FROM SSIB  (Niyogi and Raman, 1997)<a name='3268'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3269'></font>
      EA = 6.11*EXP((2.5*10.**6./461.51)*(TA-273.15)/(273.15*TA) )<a name='3270'>
      WS = 0.622*EA/1013   <a name='3271'>
      RCQ = 1.0/ (1.0+ HS * (WS - QA))<a name='3272'>
      RCQ = MAX (RCQ,0.01)<a name='3273'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3274'></font>
<font color=#447700>! CONTRIBUTION DUE TO SOIL MOISTURE AVAILABILITY.<a name='3275'></font>
<font color=#447700>! DETERMINE CONTRIBUTION FROM EACH SOIL LAYER, THEN ADD THEM UP.<a name='3276'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3277'></font>
      DO K = 1, NROOT  <a name='3278'>
       GX(K) = (SMC(K) - SMCWLT) / (SMCREF - SMCWLT)<a name='3279'>
         IF (GX(K) &gt;  1.) GX(K) = 1.<a name='3280'>
         IF (GX(K) &lt;  0.) GX(K) = 0.<a name='3281'>
         PART (K) = ( -DZVR (K)/ ZSOIL (3)) * GX(K)<a name='3282'>
      END DO<a name='3283'>
      <a name='3284'>
      SGX =0.0<a name='3285'>
      DO K = 1, NROOT <a name='3286'>
        SGX    = SGX    + GX (K)<a name='3287'>
        RCSOIL = RCSOIL + PART (K)<a name='3288'>
      END DO<a name='3289'>
      SGX =SGX / NROOT<a name='3290'>
      <a name='3291'>
      RCSOIL = MAX (RCSOIL,0.0001)<a name='3292'>
<a name='3293'>
      RC = RSMIN / (LAI * RCS * RCT * RCQ * RCSOIL)<a name='3294'>
      DESDT = 0.622*SLV*EA/461.51/TA/TA/1013<a name='3295'>
      DELTA = (SLV / CPP)* DESDT<a name='3296'>
      RR = (4.* EPSV *SIGMA * 287.04 / CPP)* (TA **4.)/ (TS * CH) + 1.0<a name='3297'>
      PC = (RR + DELTA)/ (RR * (1. + RC * CH) + DELTA)  <a name='3298'>
      <a name='3299'>
      IF (CMC .ne. 0.0) THEN<a name='3300'>
         ETT1 = SHDFAC * PC * ETP1 * (1.0- (CMC / CMCMAX) ** CFACTR) * 0.001<a name='3301'>
      ELSE<a name='3302'>
         ETT1 = SHDFAC * PC * ETP1 * 0.001<a name='3303'>
      ENDIF<a name='3304'>
<a name='3305'>
      DENOM = 0.<a name='3306'>
      DO K = 1, NROOT <a name='3307'>
         RTX= (-DZVR (K)/ ZSOIL (3)) + GX(K) - SGX<a name='3308'>
         GX (K) = GX (K) * MAX ( RTX, 0. )<a name='3309'>
         DENOM  = DENOM + GX (K)<a name='3310'>
      END DO <a name='3311'>
      IF (DENOM .le. 0.0) DENOM =1.<a name='3312'>
      <a name='3313'>
      DO K = 1, NROOT <a name='3314'>
         ET(K) = ETT1 * GX (K) / DENOM<a name='3315'>
         ETT   = ETT + ET (K)<a name='3316'>
      END DO<a name='3317'>
      <a name='3318'>
      <a name='3319'>
      IF (CMC &gt; 0.0) THEN<a name='3320'>
      EC = SHDFAC * ( ( CMC / CMCMAX ) ** CFACTR ) * ETP1 * 0.001<a name='3321'>
      ELSE<a name='3322'>
      EC = 0.0<a name='3323'>
      END IF<a name='3324'>
      CMC2MS = CMC / DELT<a name='3325'>
      EC   = MIN ( CMC2MS, EC )<a name='3326'>
      <a name='3327'>
  END SUBROUTINE TRANSP<a name='3328'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3329'></font>
<font color=#447700>! SUBROUTINE SMFLX<a name='3330'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3331'></font>
  <a name='3332'>
<A NAME='SMFLX'><A href='../../html_code/phys/module_sf_urban.F.html#SMFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3333'>
       <font color=#993300>SUBROUTINE </font><font color=#cc0000>SMFLX</font> (SMCP,SMC,NSOIL,CMCP,CMC,DT,PRCP1,ZSOIL,       &amp; <A href='../../call_to/SMFLX.html' TARGET='index'>5</A>,<A href='../../call_from/SMFLX.html' TARGET='index'>9</A><a name='3334'>
     &amp;                   SMCMAX,BEXP,SMCWLT,DKSAT,DWSAT,               &amp;<a name='3335'>
     &amp;                   SHDFAC,CMCMAX,RUNOFF1,RUNOFF2,RUNOFF3,        &amp;<a name='3336'>
                         EDIR,EC,ET,DRIP)              <a name='3337'>
<a name='3338'>
<font color=#447700>! CALCULATE SOIL MOISTURE FLUX.  THE SOIL MOISTURE CONTENT IS UPDATED WITH<a name='3339'></font>
<font color=#447700>! PROGNOSTIC EQNS. THE CANOPY MOISTURE CONTENT (CMC) IS ALSO UPDATED.<a name='3340'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3341'></font>
      IMPLICIT NONE<a name='3342'>
<a name='3343'>
      INTEGER, INTENT(IN)   :: NSOIL<a name='3344'>
      INTEGER               :: I,K<a name='3345'>
      REAL, INTENT(IN)      :: BEXP, CMCMAX, DKSAT,DWSAT, DT, EC, EDIR,  &amp;<a name='3346'>
                               PRCP1, SHDFAC, SMCMAX, SMCWLT<a name='3347'>
      REAL, INTENT(OUT)     :: DRIP, RUNOFF1, RUNOFF2, RUNOFF3<a name='3348'>
      REAL, INTENT(IN)      :: CMCP<a name='3349'>
      REAL, INTENT(OUT)     :: CMC<a name='3350'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: ZSOIL, ET<a name='3351'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: SMCP<a name='3352'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT)  :: SMC<a name='3353'>
      REAL, DIMENSION(1:NSOIL)               :: AI, BI, CI, STCF,RHSTS, RHSTT<a name='3354'>
      REAL                  :: EXCESS,PCPDRP,RHSCT,TRHSCT<a name='3355'>
<a name='3356'>
<a name='3357'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3358'></font>
<font color=#447700>! ADD PRECIPITATION TO EXISTING CMC.IF RESULTING AMT EXCEEDS MAX CAPACITY,<a name='3359'></font>
<font color=#447700>! IT BECOMES DRIP AND WILL FALL TO THE GRND.<a name='3360'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3361'></font>
      RHSCT = SHDFAC * PRCP1 * 0.001 /3600. - EC<a name='3362'>
      DRIP = 0.<a name='3363'>
      TRHSCT = DT * RHSCT<a name='3364'>
      EXCESS = CMCP + TRHSCT<a name='3365'>
<a name='3366'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3367'></font>
<font color=#447700>! PCPDRP IS THE COMBINED PRCP1 AND DRIP (FROM CMCP) THAT GOES INTO THE<a name='3368'></font>
<font color=#447700>! SOIL<a name='3369'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3370'></font>
      IF (EXCESS &gt; CMCMAX) DRIP = EXCESS - CMCMAX<a name='3371'>
      PCPDRP = (1. - SHDFAC) * PRCP1 * 0.001 /3600. + DRIP / DT<a name='3372'>
<a name='3373'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3374'></font>
<font color=#447700>! CALL SUBROUTINES SRT AND SSTEP TO SOLVE THE SOIL MOISTURE<a name='3375'></font>
<font color=#447700>! TENDENCY EQUATIONS.<a name='3376'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3377'></font>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#SRT'>SRT</A><A href='../../html_code/phys/module_sf_urban.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SRT_5"> (RHSTT,EDIR,ET,SMCP,NSOIL,PCPDRP,ZSOIL,DWSAT,DKSAT,    &amp;<a name='3378'>
                   SMCMAX,BEXP,RUNOFF1,RUNOFF2,DT,SMCWLT,AI,BI,CI) <a name='3379'>
                   <a name='3380'>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#SSTEP'>SSTEP</A><A href='../../html_code/phys/module_sf_urban.F.html#SMFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SSTEP_5"> (SMCP,SMC,CMCP,CMC,RHSTT,RHSCT,DT,NSOIL,SMCMAX,     &amp;<a name='3381'>
                        CMCMAX,RUNOFF3,ZSOIL,AI,BI,CI)<a name='3382'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3383'></font>
  END SUBROUTINE SMFLX<a name='3384'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3385'></font>
<a name='3386'>
<A NAME='SRT'><A href='../../html_code/phys/module_sf_urban.F.html#SRT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3387'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SRT</font> (RHSTT,EDIR,ET,SMCP,NSOIL,PCPDRP,ZSOIL,DWSAT,    &amp; <A href='../../call_to/SRT.html' TARGET='index'>5</A>,<A href='../../call_from/SRT.html' TARGET='index'>10</A><a name='3388'>
                      DKSAT,SMCMAX,BEXP,RUNOFF1,            &amp;<a name='3389'>
                      RUNOFF2,DT,SMCWLT,AI,BI,CI)<a name='3390'>
<a name='3391'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3392'></font>
<font color=#447700>! CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY TERM OF THE SOIL<a name='3393'></font>
<font color=#447700>! WATER DIFFUSION EQUATION.  ALSO TO COMPUTE ( PREPARE ) THE MATRIX<a name='3394'></font>
<font color=#447700>! COEFFICIENTS FOR THE TRI-DIAGONAL MATRIX OF THE IMPLICIT TIME SCHEME.<a name='3395'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3396'></font>
      IMPLICIT NONE<a name='3397'>
      INTEGER, INTENT(IN)       :: NSOIL<a name='3398'>
      INTEGER                   :: K, KS<a name='3399'>
<a name='3400'>
      REAL, INTENT(IN)          :: BEXP, DKSAT, DT, DWSAT, EDIR,  &amp;<a name='3401'>
                                   PCPDRP, SMCMAX, SMCWLT<a name='3402'>
      REAL, INTENT(OUT)         :: RUNOFF1, RUNOFF2<a name='3403'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: SMCP, ZSOIL, ET<a name='3404'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT)  :: RHSTT<a name='3405'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT)  :: AI, BI, CI<a name='3406'>
      REAL, DIMENSION(1:NSOIL)  :: DDMAX<a name='3407'>
      REAL                      :: DD, DDT, DDZ, DDZ2, DENOM,       &amp;<a name='3408'>
                                   DENOM2, DSMDZ, DSMDZ2, DT1,      &amp;<a name='3409'>
                                   INFMAX,MXSMC,MXSMC2,NUMER,PDDUM, &amp;<a name='3410'>
                                   PX,SMCAV, SSTT, PAR,         &amp;<a name='3411'>
                                   VAL, WCND, WCND2, WDF, WDF2,KDT<a name='3412'>
<a name='3413'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3414'></font>
<font color=#447700>! DETERMINE RAINFALL INFILTRATION RATE AND RUNOFF.  INCLUDE THE<a name='3415'></font>
<font color=#447700>! INFILTRATION FORMULE FROM SCHAAKE AND KOREN MODEL.<a name='3416'></font>
<font color=#447700>! MODIFIED BY Q DUAN<a name='3417'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3418'></font>
         <a name='3419'>
         PDDUM = PCPDRP<a name='3420'>
         RUNOFF1 = 0.0<a name='3421'>
         PAR = 2.0E-6<a name='3422'>
         <a name='3423'>
         IF (PCPDRP /=  0.0) THEN         <a name='3424'>
         SMCAV = SMCMAX - SMCWLT<a name='3425'>
         DDMAX (1) = - ZSOIL (1)* SMCAV<a name='3426'>
         DDMAX (1) = DDMAX (1)* (1.0- (SMCP (1) - SMCWLT)/ SMCAV)        <a name='3427'>
         DDMAX (2) = (ZSOIL (1) - ZSOIL (2))* SMCAV<a name='3428'>
         DDMAX (2) = DDMAX (2)* (1.0- (SMCP (2) - SMCWLT)/ SMCAV)<a name='3429'>
         DDMAX (3) = (ZSOIL (2) - ZSOIL (3))* SMCAV<a name='3430'>
         DDMAX (3) = DDMAX (3)* (1.0- (SMCP (3) - SMCWLT)/ SMCAV)<a name='3431'>
         <a name='3432'>
         DD = DDMAX(1)+DDMAX(2)+DDMAX(3)<a name='3433'>
         DT1 = DT/86400<a name='3434'>
         KDT = 3.0 * DKSAT / PAR<a name='3435'>
         VAL = (1. - EXP ( - KDT * DT1))<a name='3436'>
         DDT = DD * VAL<a name='3437'>
         PX = PCPDRP * DT<a name='3438'>
         IF (PX &lt;  0.0) PX = 0.0<a name='3439'>
<a name='3440'>
         INFMAX = (PX * (DDT / (PX + DDT)))/ DT<a name='3441'>
         MXSMC = SMCP (1)<a name='3442'>
         CALL <A href='../../html_code/phys/module_sf_urban.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_urban.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_5"> (WDF,WCND,MXSMC,SMCMAX,BEXP,DKSAT,DWSAT)<a name='3443'>
         INFMAX = MAX (INFMAX,WCND)<a name='3444'>
         INFMAX = MIN (INFMAX,PX/DT)<a name='3445'>
         <a name='3446'>
<a name='3447'>
         IF (PCPDRP &gt;  INFMAX) THEN<a name='3448'>
          RUNOFF1  = PCPDRP - INFMAX<a name='3449'>
          PDDUM = INFMAX<a name='3450'>
         END IF<a name='3451'>
        END IF<a name='3452'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3453'></font>
<font color=#447700>! TOP LAYER<a name='3454'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3455'></font>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_urban.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_6"> (WDF,WCND,SMCP(1),SMCMAX,BEXP,DKSAT,DWSAT)<a name='3456'>
      DDZ = 1. / ( - .5 * ZSOIL (2) )<a name='3457'>
      AI (1) = 0.0<a name='3458'>
      BI (1) = WDF * DDZ / ( - ZSOIL (1) )<a name='3459'>
      CI (1) = - BI (1)   <a name='3460'>
      DSMDZ = (SMCP (1) - SMCP (2) )/( - 0.5 * ZSOIL(2))<a name='3461'>
      RHSTT (1) = (WDF * DSMDZ + WCND- PDDUM + EDIR + ET(1))/ ZSOIL (1)<a name='3462'>
      SSTT = WDF * DSMDZ + WCND+ EDIR + ET(1)<a name='3463'>
<a name='3464'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3465'></font>
<font color=#447700>! LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABV PROCESS<a name='3466'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3467'></font>
      DDZ2 = 0.0<a name='3468'>
      DO K = 2,NSOIL-1<a name='3469'>
         DENOM2 = (ZSOIL (K -1) - ZSOIL (K))<a name='3470'>
         IF (K /= NSOIL-1) THEN<a name='3471'>
            MXSMC2 = SMCP (K)<a name='3472'>
            CALL <A href='../../html_code/phys/module_sf_urban.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_urban.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_7"> (WDF2,WCND2,MXSMC2,SMCMAX,BEXP,DKSAT,DWSAT)<a name='3473'>
            DENOM = (ZSOIL (K -1) - ZSOIL (K +1))<a name='3474'>
            DSMDZ2 = (SMCP (K) - SMCP (K +1)) / (DENOM * 0.5)<a name='3475'>
            DDZ2 = 2.0 / DENOM<a name='3476'>
            CI (K) = - WDF2 * DDZ2 / DENOM2<a name='3477'>
         ELSE<a name='3478'>
          CALL <A href='../../html_code/phys/module_sf_urban.F.html#WDFCND'>WDFCND</A><A href='../../html_code/phys/module_sf_urban.F.html#SRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WDFCND_8"> (WDF2,WCND2,SMCP(NSOIL-1),SMCMAX,BEXP,DKSAT,DWSAT)<a name='3479'>
            DSMDZ2 = 0.0<a name='3480'>
            CI (K) = 0.0<a name='3481'>
         END IF  <a name='3482'>
         NUMER = (WDF2 * DSMDZ2) - (WDF * DSMDZ)         &amp;<a name='3483'>
                 - WCND+ ET(K)<a name='3484'>
         RHSTT (K) = NUMER / ( - DENOM2)<a name='3485'>
         AI (K) = - WDF * DDZ / DENOM2<a name='3486'>
         BI (K) = - ( AI (K) + CI (K) )<a name='3487'>
         IF (K .eq. NSOIL-1) THEN<a name='3488'>
            RUNOFF2 = 0.0<a name='3489'>
         END IF<a name='3490'>
         IF (K .ne. NSOIL-1) THEN<a name='3491'>
            WDF = WDF2<a name='3492'>
            WCND = WCND2<a name='3493'>
            DSMDZ = DSMDZ2<a name='3494'>
            DDZ = DDZ2<a name='3495'>
         END IF<a name='3496'>
      END DO<a name='3497'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3498'></font>
  END SUBROUTINE SRT<a name='3499'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3500'></font>
<a name='3501'>
<A NAME='SSTEP'><A href='../../html_code/phys/module_sf_urban.F.html#SSTEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3502'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SSTEP</font> (SMCP,SMC,CMCP,CMC,RHSTT,RHSCT,DT,     &amp; <A href='../../call_to/SSTEP.html' TARGET='index'>5</A>,<A href='../../call_from/SSTEP.html' TARGET='index'>3</A><a name='3503'>
                        NSOIL,SMCMAX,CMCMAX,RUNOFF3,ZSOIL,        &amp;<a name='3504'>
                        AI,BI,CI)<a name='3505'>
<a name='3506'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3507'></font>
<font color=#447700>! SUBROUTINE SSTEP<a name='3508'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3509'></font>
<font color=#447700>! CALCULATE/UPDATE SOIL MOISTURE CONTENT VALUES AND CANOPY MOISTURE<a name='3510'></font>
<font color=#447700>! CONTENT VALUES.<a name='3511'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3512'></font>
      IMPLICIT NONE<a name='3513'>
      INTEGER, INTENT(IN)       :: NSOIL<a name='3514'>
      INTEGER                   :: I, K, KK11<a name='3515'>
<a name='3516'>
      REAL, INTENT(IN)          :: CMCMAX, DT, SMCMAX<a name='3517'>
      REAL, INTENT(OUT)         :: RUNOFF3<a name='3518'>
      REAL, INTENT(IN)          :: CMCP<a name='3519'>
      REAL, INTENT(OUT)         :: CMC<a name='3520'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)     :: SMCP, ZSOIL<a name='3521'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT)    :: SMC<a name='3522'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT)  :: RHSTT<a name='3523'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT)  :: AI, BI, CI <a name='3524'>
      REAL, DIMENSION(1:NSOIL)  :: RHSTTin, SMCOUT,SMCIN<a name='3525'>
      REAL, DIMENSION(1:NSOIL)  :: CIin<a name='3526'>
      REAL                      :: DDZ, RHSCT, WPLUS, STOT<a name='3527'>
<a name='3528'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3529'></font>
<font color=#447700>! CREATE 'AMOUNT' VALUES OF VARIABLES TO BE INPUT TO THE<a name='3530'></font>
<font color=#447700>! TRI-DIAGONAL MATRIX ROUTINE.<a name='3531'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3532'></font>
      DO K = 1,NSOIL-1<a name='3533'>
         RHSTT (K) = RHSTT (K) * DT<a name='3534'>
         AI (K) = AI (K) * DT<a name='3535'>
         BI (K) = 1. + BI (K) * DT<a name='3536'>
         CI (K) = CI (K) * DT<a name='3537'>
      END DO<a name='3538'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3539'></font>
<font color=#447700>! COPY VALUES FOR INPUT VARIABLES BEFORE CALL TO ROSR12<a name='3540'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3541'></font>
      DO K = 1,NSOIL-1<a name='3542'>
         RHSTTin (K) = RHSTT (K)<a name='3543'>
      END DO<a name='3544'>
      DO K = 1,NSOIL-1<a name='3545'>
         CIin (K) = CI (K)<a name='3546'>
      END DO<a name='3547'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3548'></font>
<font color=#447700>! CALL ROSR12 TO SOLVE THE TRI-DIAGONAL MATRIX<a name='3549'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3550'></font>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#ROSR12'>ROSR12</A><A href='../../html_code/phys/module_sf_urban.F.html#SSTEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROSR12_6"> (CI,AI,BI,CIin,RHSTTin,RHSTT,NSOIL-1)<a name='3551'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3552'></font>
<font color=#447700>! SUM THE PREVIOUS SMC VALUE AND THE MATRIX SOLUTION TO GET A<a name='3553'></font>
<font color=#447700>! NEW VALUE.  MIN ALLOWABLE VALUE OF SMC WILL BE 0.02.<a name='3554'></font>
<font color=#447700>! RUNOFF3: RUNOFF WITHIN SOIL LAYERS<a name='3555'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3556'></font>
      WPLUS = 0.0<a name='3557'>
      RUNOFF3 = 0.<a name='3558'>
<a name='3559'>
      DDZ = - ZSOIL (1)<a name='3560'>
      DO K = 1,NSOIL-1<a name='3561'>
         IF (K /= 1) DDZ = ZSOIL (K - 1) - ZSOIL (K)<a name='3562'>
         SMCOUT (K) = SMCP (K) + CI (K) + WPLUS / DDZ<a name='3563'>
         STOT = SMCOUT (K)<a name='3564'>
         IF (STOT &gt; SMCMAX) THEN<a name='3565'>
            IF (K .eq. 1) THEN<a name='3566'>
               DDZ = - ZSOIL (1)<a name='3567'>
            ELSE<a name='3568'>
               KK11 = K - 1<a name='3569'>
               DDZ = - ZSOIL (K) + ZSOIL (KK11)<a name='3570'>
            END IF<a name='3571'>
            WPLUS = (STOT - SMCMAX) * DDZ<a name='3572'>
         ELSE<a name='3573'>
            WPLUS = 0.<a name='3574'>
         END IF<a name='3575'>
         SMC (K) = MAX ( MIN (STOT,SMCMAX),0.066 )<a name='3576'>
      END DO<a name='3577'>
<a name='3578'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3579'></font>
<font color=#447700>! UPDATE CANOPY WATER CONTENT/INTERCEPTION (CMC).  CONVERT RHSCT TO<a name='3580'></font>
<font color=#447700>! AN 'AMOUNT' VALUE AND ADD TO PREVIOUS CMC VALUE TO GET NEW CMC.<a name='3581'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3582'></font>
      RUNOFF3 = WPLUS<a name='3583'>
      CMC = CMCP + DT * RHSCT<a name='3584'>
      IF (CMC &lt; 1.E-20) CMC = 0.0<a name='3585'>
      CMC = MIN (CMC,CMCMAX)<a name='3586'>
<a name='3587'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3588'></font>
  END SUBROUTINE SSTEP<a name='3589'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3590'></font>
<a name='3591'>
<A NAME='WDFCND'><A href='../../html_code/phys/module_sf_urban.F.html#WDFCND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3592'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>WDFCND</font> (WDF,WCND,SMC,SMCMAX,BEXP,DKSAT,DWSAT) <A href='../../call_to/WDFCND.html' TARGET='index'>8</A><a name='3593'>
<a name='3594'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3595'></font>
<font color=#447700>! SUBROUTINE WDFCND<a name='3596'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3597'></font>
<font color=#447700>! CALCULATE SOIL WATER DIFFUSIVITY AND SOIL HYDRAULIC CONDUCTIVITY.<a name='3598'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3599'></font>
      IMPLICIT NONE<a name='3600'>
      REAL     BEXP<a name='3601'>
      REAL     DKSAT<a name='3602'>
      REAL     DWSAT<a name='3603'>
      REAL     EXPON<a name='3604'>
      REAL     FACTR1<a name='3605'>
      REAL     FACTR2<a name='3606'>
      REAL     SMC<a name='3607'>
      REAL     SMCMAX<a name='3608'>
      REAL     WCND<a name='3609'>
<a name='3610'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3611'></font>
<font color=#447700>!     CALC THE RATIO OF THE ACTUAL TO THE MAX PSBL SOIL H2O CONTENT<a name='3612'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3613'></font>
      REAL     WDF<a name='3614'>
      FACTR1 = 0.05 / SMCMAX<a name='3615'>
<a name='3616'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3617'></font>
<font color=#447700>! PREP AN EXPNTL COEF AND CALC THE SOIL WATER DIFFUSIVITY AND CONDUCTIVITY<a name='3618'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3619'></font>
      FACTR2 = SMC / SMCMAX<a name='3620'>
      FACTR1 = MIN(FACTR1,FACTR2)<a name='3621'>
      EXPON  = BEXP + 2.0<a name='3622'>
      WDF    = DWSAT * FACTR2 ** EXPON<a name='3623'>
      EXPON  = (2.0 * BEXP) + 3.0<a name='3624'>
      WCND   = DKSAT * FACTR2 ** EXPON<a name='3625'>
<a name='3626'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3627'></font>
  END SUBROUTINE WDFCND<a name='3628'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3629'></font>
<font color=#447700>! SUBROUTINE ROSR12<a name='3630'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3631'></font>
<font color=#447700>! INVERT (SOLVE) THE TRI-DIAGONAL MATRIX PROBLEM SHOWN BELOW:<a name='3632'></font>
<font color=#447700>! ###                                            ### ###  ###   ###  ###<a name='3633'></font>
<font color=#447700>! #B(1), C(1),  0  ,  0  ,  0  ,   . . .  ,    0   # #      #   #      #<a name='3634'></font>
<font color=#447700>! #A(2), B(2), C(2),  0  ,  0  ,   . . .  ,    0   # #      #   #      #<a name='3635'></font>
<font color=#447700>! # 0  , A(3), B(3), C(3),  0  ,   . . .  ,    0   # #      #   # D(3) #<a name='3636'></font>
<font color=#447700>! # 0  ,  0  , A(4), B(4), C(4),   . . .  ,    0   # # P(4) #   # D(4) #<a name='3637'></font>
<font color=#447700>! # 0  ,  0  ,  0  , A(5), B(5),   . . .  ,    0   # # P(5) #   # D(5) #<a name='3638'></font>
<font color=#447700>! # .                                          .   # #  .   # = #   .  #<a name='3639'></font>
<font color=#447700>! # .                                          .   # #  .   #   #   .  #<a name='3640'></font>
<font color=#447700>! # .                                          .   # #  .   #   #   .  #<a name='3641'></font>
<font color=#447700>! # 0  , . . . , 0 , A(M-2), B(M-2), C(M-2),   0   # #P(M-2)#   #D(M-2)#<a name='3642'></font>
<font color=#447700>! # 0  , . . . , 0 ,   0   , A(M-1), B(M-1), C(M-1)# #P(M-1)#   #D(M-1)#<a name='3643'></font>
<font color=#447700>! # 0  , . . . , 0 ,   0   ,   0   ,  A(M) ,  B(M) # # P(M) #   # D(M) #<a name='3644'></font>
<font color=#447700>! ###                                            ### ###  ###   ###  ###<a name='3645'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3646'></font>
  <a name='3647'>
<A NAME='ROSR12'><A href='../../html_code/phys/module_sf_urban.F.html#ROSR12' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3648'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ROSR12</font> (P,A,B,C,D,DELTA,NSOIL) <A href='../../call_to/ROSR12.html' TARGET='index'>7</A><a name='3649'>
      IMPLICIT NONE<a name='3650'>
<a name='3651'>
      INTEGER, INTENT(IN)   :: NSOIL<a name='3652'>
      INTEGER               :: K, KK<a name='3653'>
<a name='3654'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN):: A, B, D<a name='3655'>
      REAL, DIMENSION(1:NSOIL),INTENT(INOUT):: C,P,DELTA<a name='3656'>
<a name='3657'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3658'></font>
<font color=#447700>! INITIALIZE EQN COEF C FOR THE LOWEST SOIL LAYER<a name='3659'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3660'></font>
      C (NSOIL) = 0.0<a name='3661'>
      P (1) = - C (1) / B (1)<a name='3662'>
      DELTA (1) = D (1) / B (1)<a name='3663'>
      DO K = 2,NSOIL<a name='3664'>
         P (K) = - C (K) * ( 1.0 / (B (K) + A (K) * P (K -1)) )<a name='3665'>
         DELTA (K) = (D (K) - A (K)* DELTA (K -1))* (1.0/ (B (K) + A (K)&amp;<a name='3666'>
                    * P (K -1)))<a name='3667'>
      END DO<a name='3668'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3669'></font>
<font color=#447700>! SET P TO DELTA FOR LOWEST SOIL LAYER<a name='3670'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3671'></font>
      P (NSOIL) = DELTA (NSOIL)<a name='3672'>
<a name='3673'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3674'></font>
<font color=#447700>! ADJUST P FOR SOIL LAYERS 2 THRU NSOIL<a name='3675'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3676'></font>
      DO K = 2,NSOIL<a name='3677'>
         KK = NSOIL - K + 1<a name='3678'>
         P (KK) = P (KK) * P (KK +1) + DELTA (KK)<a name='3679'>
      END DO<a name='3680'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3681'></font>
  END SUBROUTINE ROSR12<a name='3682'>
<font color=#447700>!----------------------------------------------------------------------<a name='3683'></font>
<a name='3684'>
<A NAME='SHFLX'><A href='../../html_code/phys/module_sf_urban.F.html#SHFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3685'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SHFLX</font> (SSOIL,STC,SMC,SMCMAX,NSOIL,T1,DT,YY,ZZ1,ZSOIL, &amp; <A href='../../call_to/SHFLX.html' TARGET='index'>5</A>,<A href='../../call_from/SHFLX.html' TARGET='index'>8</A><a name='3686'>
                         TBOT,ZBOT,SMCWLT,DF1,QUARTZ,CSOIL,CAPR)<a name='3687'>
<a name='3688'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3689'></font>
<font color=#447700>! SUBROUTINE SHFLX<a name='3690'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3691'></font>
<font color=#447700>! UPDATE THE TEMPERATURE STATE OF THE SOIL COLUMN BASED ON THE THERMAL<a name='3692'></font>
<font color=#447700>! DIFFUSION EQUATION AND UPDATE THE FROZEN SOIL MOISTURE CONTENT BASED<a name='3693'></font>
<font color=#447700>! ON THE TEMPERATURE.<a name='3694'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3695'></font>
      IMPLICIT NONE<a name='3696'>
<a name='3697'>
      INTEGER, INTENT(IN)   :: NSOIL<a name='3698'>
      INTEGER               :: I<a name='3699'>
<a name='3700'>
      REAL, INTENT(IN)      :: DF1,DT,SMCMAX, SMCWLT, TBOT,YY, ZBOT,ZZ1, QUARTZ<a name='3701'>
      REAL, INTENT(IN)      :: CSOIL, CAPR<a name='3702'>
      REAL, INTENT(INOUT)   :: T1<a name='3703'>
      REAL, INTENT(OUT)     :: SSOIL<a name='3704'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)    :: SMC,ZSOIL<a name='3705'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: STC<a name='3706'>
      REAL, DIMENSION(1:NSOIL)             :: AI, BI, CI, STCF,RHSTS<a name='3707'>
<a name='3708'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3709'></font>
<font color=#447700>! HRT ROUTINE CALCS THE RIGHT HAND SIDE OF THE SOIL TEMP DIF EQN<a name='3710'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3711'></font>
<a name='3712'>
      <font color=#447700>! Land case<a name='3713'></font>
<a name='3714'>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#HRT'>HRT</A><A href='../../html_code/phys/module_sf_urban.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HRT_3"> (RHSTS,STC,SMC,SMCMAX,NSOIL,ZSOIL,YY,ZZ1,TBOT,        &amp;<a name='3715'>
                ZBOT,DT,DF1,AI,BI,CI,QUARTZ,CSOIL,CAPR)<a name='3716'>
<a name='3717'>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#HSTEP'>HSTEP</A><A href='../../html_code/phys/module_sf_urban.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HSTEP_5"> (STCF,STC,RHSTS,DT,NSOIL,AI,BI,CI)<a name='3718'>
<a name='3719'>
      DO I = 1,NSOIL<a name='3720'>
         STC (I) = STCF (I)<a name='3721'>
      ENDDO<a name='3722'>
<a name='3723'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3724'></font>
<font color=#447700>! CALCULATE SURFACE SOIL HEAT FLUX<a name='3725'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3726'></font>
      T1 = (YY + (ZZ1- 1.0) * STC (1)) / ZZ1<a name='3727'>
      SSOIL = DF1 * (STC (1) - T1) / (0.5 * ZSOIL (1))<a name='3728'>
<a name='3729'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3730'></font>
  END SUBROUTINE SHFLX<a name='3731'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3732'></font>
<font color=#447700>! SUBROUTINE HRT<a name='3733'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3734'></font>
<font color=#447700>! CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY TERM OF THE SOIL<a name='3735'></font>
<font color=#447700>! THERMAL DIFFUSION EQUATION.  ALSO TO COMPUTE ( PREPARE ) THE MATRIX<a name='3736'></font>
<font color=#447700>! COEFFICIENTS FOR THE TRI-DIAGONAL MATRIX OF THE IMPLICIT TIME SCHEME.<a name='3737'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3738'></font>
<a name='3739'>
<A NAME='HRT'><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3740'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>HRT</font> (RHSTS,STC,SMC,SMCMAX,NSOIL,ZSOIL,YY,ZZ1,          &amp; <A href='../../call_to/HRT.html' TARGET='index'>3</A>,<A href='../../call_from/HRT.html' TARGET='index'>17</A><a name='3741'>
                       TBOT,ZBOT,DT,DF1,AI,BI,CI,QUARTZ,CSOIL,CAPR)<a name='3742'>
                       <a name='3743'>
      IMPLICIT NONE<a name='3744'>
      LOGICAL              :: ITAVG<a name='3745'>
      INTEGER, INTENT(IN)  :: NSOIL<a name='3746'>
      INTEGER              :: I, K<a name='3747'>
<a name='3748'>
      REAL, INTENT(IN)     :: DF1, DT,SMCMAX ,TBOT,YY,ZZ1, ZBOT, QUARTZ, CSOIL, CAPR<a name='3749'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: SMC,STC,ZSOIL<a name='3750'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT)  :: RHSTS<a name='3751'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT)  :: AI, BI,CI<a name='3752'>
      REAL                 :: DDZ, DDZ2, DENOM, DF1K, DTSDZ,DF1N,      &amp;<a name='3753'>
                              DTSDZ2,HCPCT,QTOT,SSOIL,SICE,TAVG,TBK,     &amp;<a name='3754'>
                              TBK1,TSNSR,TSURF<a name='3755'>
      REAL, PARAMETER      :: CAIR = 1004.0, CH2O = 4.2E6<a name='3756'>
<a name='3757'>
<a name='3758'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3759'></font>
<font color=#447700>! INITIALIZE LOGICAL FOR SOIL LAYER TEMPERATURE AVERAGING.<a name='3760'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3761'></font>
       ITAVG = .TRUE.<a name='3762'>
       <a name='3763'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3764'></font>
<font color=#447700>! TOP SOIL LAYER<a name='3765'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3766'></font>
      HCPCT = SMC (1)* CH2O + (1.0- SMCMAX)* CSOIL + (SMCMAX - SMC (1))&amp;<a name='3767'>
       * CAIR                                                          <a name='3768'>
      DDZ = 1.0 / ( -0.5 * ZSOIL (2) )<a name='3769'>
      AI (1) = 0.0<a name='3770'>
      CI (1) = (DF1 * DDZ) / (ZSOIL (1) * HCPCT)<a name='3771'>
<a name='3772'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3773'></font>
<font color=#447700>! CALCULATE THE VERTICAL SOIL TEMP GRADIENT BTWN THE 1ST AND 2ND SOIL<a name='3774'></font>
<font color=#447700>! LAYERS.  THEN CALCULATE THE SUBSURFACE HEAT FLUX. <a name='3775'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3776'></font>
      BI (1) = - CI (1) + DF1 / (0.5 * ZSOIL (1) * ZSOIL (1)* HCPCT *    &amp;<a name='3777'>
       ZZ1)<a name='3778'>
      DTSDZ = (STC (1) - STC (2)) / (-0.5 * ZSOIL (2))<a name='3779'>
      SSOIL = DF1 * (STC (1) - YY) / (0.5 * ZSOIL (1) * ZZ1)<a name='3780'>
      DENOM = (ZSOIL (1) * HCPCT)<a name='3781'>
<a name='3782'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3783'></font>
<font color=#447700>! NEXT CAPTURE THE VERTICAL DIFFERENCE OF THE HEAT FLUX AT TOP AND<a name='3784'></font>
<font color=#447700>! BOTTOM OF FIRST SOIL LAYER FOR USE IN HEAT FLUX CONSTRAINT<a name='3785'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3786'></font>
      RHSTS (1) = (DF1 * DTSDZ - SSOIL) / DENOM<a name='3787'>
      QTOT = -1.0* RHSTS (1)* DENOM<a name='3788'>
      IF (ITAVG) THEN<a name='3789'>
         TSURF = (YY + (ZZ1-1) * STC (1)) / ZZ1<a name='3790'>
         CALL <A href='../../html_code/phys/module_sf_urban.F.html#TBND'>TBND</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TBND_4"> (STC (1),STC (2),ZSOIL,ZBOT,1,NSOIL,TBK)<a name='3791'>
     ENDIF<a name='3792'>
      DDZ2 = 0.0<a name='3793'>
      DF1N = DF1<a name='3794'>
<a name='3795'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3796'></font>
<font color=#447700>! LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABOVE PROCESS<a name='3797'></font>
<font color=#447700>! (EXCEPT SUBSFC OR "GROUND" HEAT FLUX NOT REPEATED IN LOWER LAYERS)<a name='3798'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3799'></font>
      DO K = 2,NSOIL<a name='3800'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3801'></font>
<font color=#447700>! THIS SECTION FOR LAYER 2 OR GREATER, BUT NOT LAST LAYER.<a name='3802'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3803'></font>
         IF (K &lt; NSOIL-1 ) THEN<a name='3804'>
         HCPCT = SMC (K)* CH2O + (1.0- SMCMAX)* CSOIL + (SMCMAX - SMC (  &amp;<a name='3805'>
                K))* CAIR <a name='3806'>
            CALL <A href='../../html_code/phys/module_sf_urban.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_7">  (DF1K, SMC(K), QUARTZ, SMCMAX)<a name='3807'>
            DENOM = 0.5 * ( ZSOIL (K -1) - ZSOIL (K +1) )<a name='3808'>
            DTSDZ2 = (STC (K) - STC (K +1) ) / DENOM<a name='3809'>
            DDZ2 = 2. / (ZSOIL (K -1) - ZSOIL (K +1))<a name='3810'>
<a name='3811'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3812'></font>
<font color=#447700>! IF TEMPERATURE AVERAGING INVOKED (ITAVG=TRUE; ELSE SKIP):  CALCULATE<a name='3813'></font>
<font color=#447700>! TEMP AT BOTTOM OF LAYER.<a name='3814'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3815'></font>
            CI (K) = - DF1K * DDZ2 / ( (ZSOIL (K -1) - ZSOIL (K)) *      &amp;<a name='3816'>
       HCPCT)<a name='3817'>
            IF (ITAVG) THEN<a name='3818'>
               CALL <A href='../../html_code/phys/module_sf_urban.F.html#TBND'>TBND</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TBND_5"> (STC (K),STC (K +1),ZSOIL,ZBOT,K,NSOIL,TBK1)<a name='3819'>
            END IF<a name='3820'>
<a name='3821'>
         ELSEIF (K == NSOIL-1) THEN<a name='3822'>
         <a name='3823'>
         HCPCT = SMC (K)* CH2O + (1.0- SMCMAX)* CSOIL + (SMCMAX- SMC (  &amp;<a name='3824'>
                K))* CAIR <a name='3825'>
            CALL <A href='../../html_code/phys/module_sf_urban.F.html#TDFCND'>TDFCND</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFCND_8">  (DF1K, SMC(K), QUARTZ, SMCMAX)<a name='3826'>
            DENOM = 0.5 * ( ZSOIL (K -1) - ZSOIL (K +1) )<a name='3827'>
            DTSDZ2 = (STC (K) - STC (K +1) ) / DENOM<a name='3828'>
            DDZ2 = 2. / (ZSOIL (K -1) - ZSOIL (K +1))<a name='3829'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3830'></font>
<font color=#447700>! IF TEMPERATURE AVERAGING INVOKED (ITAVG=TRUE; ELSE SKIP):  CALCULATE<a name='3831'></font>
<font color=#447700>! TEMP AT BOTTOM OF LAST LAYER.<a name='3832'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3833'></font>
            CI (K) = - DF1K * DDZ2 / ( (ZSOIL (K -1) - ZSOIL (K)) *      &amp;<a name='3834'>
       HCPCT)<a name='3835'>
            IF (ITAVG) THEN<a name='3836'>
               CALL <A href='../../html_code/phys/module_sf_urban.F.html#TBND'>TBND</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TBND_6"> (STC (K),TBOT,ZSOIL,ZBOT,K,NSOIL,TBK1)<a name='3837'>
            END IF        <a name='3838'>
         ELSE         <a name='3839'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3840'></font>
<font color=#447700>! SPECIAL CASE OF BOTTOM LAYER (CONCRETE ROOF)<a name='3841'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3842'></font>
            HCPCT = CAPR * 4.1868 * 1.E6<a name='3843'>
            DF1K  = 3.24<a name='3844'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3845'></font>
<font color=#447700>! CALC THE VERTICAL TEMP GRADIENT THRU BOTTOM LAYER.<a name='3846'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3847'></font>
            DENOM = .5 * (ZSOIL (K -1) + ZSOIL (K)) - ZBOT<a name='3848'>
            DTSDZ2 = (STC (K) - TBOT) / DENOM<a name='3849'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3850'></font>
<font color=#447700>! IF TEMPERATURE AVERAGING INVOKED (ITAVG=TRUE; ELSE SKIP):  CALCULATE<a name='3851'></font>
<font color=#447700>! TEMP AT BOTTOM OF LAST LAYER.<a name='3852'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3853'></font>
            CI (K) = 0.<a name='3854'>
            IF (ITAVG) THEN<a name='3855'>
               CALL <A href='../../html_code/phys/module_sf_urban.F.html#TBND'>TBND</A><A href='../../html_code/phys/module_sf_urban.F.html#HRT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TBND_7"> (STC (K),TBOT,ZSOIL,ZBOT,K,NSOIL,TBK1)<a name='3856'>
            END IF<a name='3857'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3858'></font>
<font color=#447700>! THIS ENDS SPECIAL LOOP FOR BOTTOM LAYER.<a name='3859'></font>
         END IF<a name='3860'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3861'></font>
<font color=#447700>! CALCULATE RHSTS FOR THIS LAYER AFTER CALC'NG A PARTIAL PRODUCT.<a name='3862'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3863'></font>
         DENOM = ( ZSOIL (K) - ZSOIL (K -1) ) * HCPCT<a name='3864'>
         RHSTS (K) = ( DF1K * DTSDZ2- DF1N * DTSDZ ) / DENOM<a name='3865'>
         QTOT = -1.0* DENOM * RHSTS (K)<a name='3866'>
<a name='3867'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3868'></font>
<font color=#447700>! CALC MATRIX COEFS, AI, AND BI FOR THIS LAYER.<a name='3869'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3870'></font>
         AI (K) = - DF1N * DDZ / ( (ZSOIL (K -1) - ZSOIL (K)) * HCPCT)<a name='3871'>
<a name='3872'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3873'></font>
<font color=#447700>! RESET VALUES OF DF1, DTSDZ, DDZ, AND TBK FOR LOOP TO NEXT SOIL LAYER.<a name='3874'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3875'></font>
         BI (K) = - (AI (K) + CI (K))<a name='3876'>
         TBK = TBK1<a name='3877'>
         DF1N = DF1K<a name='3878'>
         DTSDZ = DTSDZ2<a name='3879'>
         DDZ = DDZ2<a name='3880'>
      END DO<a name='3881'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3882'></font>
  END SUBROUTINE HRT<a name='3883'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3884'></font>
<a name='3885'>
<A NAME='HSTEP'><A href='../../html_code/phys/module_sf_urban.F.html#HSTEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3886'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>HSTEP</font> (STCOUT,STCIN,RHSTS,DT,NSOIL,AI,BI,CI) <A href='../../call_to/HSTEP.html' TARGET='index'>5</A>,<A href='../../call_from/HSTEP.html' TARGET='index'>4</A><a name='3887'>
<font color=#447700>!      CALCULATE/UPDATE THE SOIL TEMPERATURE FIELD.<a name='3888'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3889'></font>
      IMPLICIT NONE<a name='3890'>
      INTEGER, INTENT(IN)  :: NSOIL<a name='3891'>
      INTEGER              :: K<a name='3892'>
<a name='3893'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN):: STCIN<a name='3894'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT):: STCOUT<a name='3895'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT):: RHSTS<a name='3896'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT):: AI,BI,CI<a name='3897'>
      REAL, DIMENSION(1:NSOIL) :: RHSTSin<a name='3898'>
      REAL, DIMENSION(1:NSOIL) :: CIin<a name='3899'>
      REAL                 :: DT<a name='3900'>
<a name='3901'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3902'></font>
<font color=#447700>! CREATE FINITE DIFFERENCE VALUES FOR USE IN ROSR12 ROUTINE<a name='3903'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3904'></font>
      DO K = 1,NSOIL<a name='3905'>
         RHSTS (K) = RHSTS (K) * DT<a name='3906'>
         AI (K) = AI (K) * DT<a name='3907'>
         BI (K) = 1. + BI (K) * DT<a name='3908'>
         CI (K) = CI (K) * DT<a name='3909'>
      END DO<a name='3910'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3911'></font>
<font color=#447700>! COPY VALUES FOR INPUT VARIABLES BEFORE CALL TO ROSR12<a name='3912'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3913'></font>
      DO K = 1,NSOIL<a name='3914'>
         RHSTSin (K) = RHSTS (K)<a name='3915'>
      END DO<a name='3916'>
      DO K = 1,NSOIL<a name='3917'>
         CIin (K) = CI (K)<a name='3918'>
      END DO<a name='3919'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3920'></font>
<font color=#447700>! SOLVE THE TRI-DIAGONAL MATRIX EQUATION<a name='3921'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3922'></font>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#ROSR12'>ROSR12</A><A href='../../html_code/phys/module_sf_urban.F.html#HSTEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROSR12_7"> (CI,AI,BI,CIin,RHSTSin,RHSTS,NSOIL)<a name='3923'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3924'></font>
<font color=#447700>! CALC/UPDATE THE SOIL TEMPS USING MATRIX SOLUTION<a name='3925'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3926'></font>
      DO K = 1,NSOIL<a name='3927'>
         STCOUT (K) = STCIN (K) + CI (K)<a name='3928'>
      END DO<a name='3929'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3930'></font>
  END SUBROUTINE HSTEP<a name='3931'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3932'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3933'></font>
<a name='3934'>
<A NAME='TBND'><A href='../../html_code/phys/module_sf_urban.F.html#TBND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3935'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TBND</font> (TU,TB,ZSOIL,ZBOT,K,NSOIL,TBND1) <A href='../../call_to/TBND.html' TARGET='index'>7</A><a name='3936'>
<a name='3937'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3938'></font>
<font color=#447700>! SUBROUTINE TBND<a name='3939'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3940'></font>
<font color=#447700>! CALCULATE TEMPERATURE ON THE BOUNDARY OF THE LAYER BY INTERPOLATION OF<a name='3941'></font>
<font color=#447700>! THE MIDDLE LAYER TEMPERATURES<a name='3942'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3943'></font>
      IMPLICIT NONE<a name='3944'>
      INTEGER, INTENT(IN)       :: NSOIL<a name='3945'>
      INTEGER                   :: K<a name='3946'>
      REAL, INTENT(IN)          :: TB, TU, ZBOT<a name='3947'>
      REAL, INTENT(OUT)         :: TBND1<a name='3948'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)   :: ZSOIL<a name='3949'>
      REAL                      :: ZB, ZUP<a name='3950'>
<a name='3951'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3952'></font>
<font color=#447700>! USE SURFACE TEMPERATURE ON THE TOP OF THE FIRST LAYER<a name='3953'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3954'></font>
     IF (K == 1) THEN<a name='3955'>
         ZUP = 0.<a name='3956'>
      ELSE<a name='3957'>
         ZUP = ZSOIL (K -1)<a name='3958'>
      END IF<a name='3959'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3960'></font>
<font color=#447700>! USE DEPTH OF THE CONSTANT BOTTOM TEMPERATURE WHEN INTERPOLATE<a name='3961'></font>
<font color=#447700>! TEMPERATURE INTO THE LAST LAYER BOUNDARY<a name='3962'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3963'></font>
      IF (K ==  NSOIL) THEN<a name='3964'>
         ZB = 2.* ZBOT - ZSOIL (K)<a name='3965'>
      ELSE<a name='3966'>
         ZB = ZSOIL (K +1)<a name='3967'>
      END IF<a name='3968'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3969'></font>
<font color=#447700>! LINEAR INTERPOLATION BETWEEN THE AVERAGE LAYER TEMPERATURES<a name='3970'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3971'></font>
<a name='3972'>
      TBND1 = TU + (TB - TU)* (ZUP - ZSOIL (K))/ (ZUP - ZB)<a name='3973'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3974'></font>
  END SUBROUTINE TBND<a name='3975'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3976'></font>
<A NAME='TDFCND'><A href='../../html_code/phys/module_sf_urban.F.html#TDFCND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3977'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TDFCND</font> (DF, SMC, QZ, SMCMAX) <A href='../../call_to/TDFCND.html' TARGET='index'>8</A><a name='3978'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3979'></font>
<font color=#447700>! CALCULATE THERMAL CONDUCTIVITY OF THE SOIL<a name='3980'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3981'></font>
<font color=#447700>! PETERS-LIDARD APPROACH (PETERS-LIDARD et al., 1998)<a name='3982'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3983'></font>
      IMPLICIT NONE<a name='3984'>
      REAL, INTENT(IN)          :: QZ,  SMC, SMCMAX<a name='3985'>
      REAL, INTENT(OUT)         :: DF<a name='3986'>
      REAL                      :: AKE, GAMMD, THKDRY, THKO,         &amp;<a name='3987'>
                                   THKQTZ,THKSAT,THKS,THKW,SATRATIO<a name='3988'>
<a name='3989'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3990'></font>
<font color=#447700>! IF THE SOIL HAS ANY MOISTURE CONTENT COMPUTE A PARTIAL SUM/PRODUCT<a name='3991'></font>
<font color=#447700>! OTHERWISE USE A CONSTANT VALUE WHICH WORKS WELL WITH MOST SOILS<a name='3992'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='3993'></font>
<font color=#447700>!  THKW ......WATER THERMAL CONDUCTIVITY<a name='3994'></font>
<font color=#447700>!  THKQTZ ....THERMAL CONDUCTIVITY FOR QUARTZ<a name='3995'></font>
<font color=#447700>!  THKO ......THERMAL CONDUCTIVITY FOR OTHER SOIL COMPONENTS<a name='3996'></font>
<font color=#447700>!  THKS ......THERMAL CONDUCTIVITY FOR THE SOLIDS COMBINED(QUARTZ+OTHER)<a name='3997'></font>
<font color=#447700>!  SMCMAX ....POROSITY (= SMCMAX)<a name='3998'></font>
<font color=#447700>!  QZ .........QUARTZ CONTENT (SOIL TYPE DEPENDENT)<a name='3999'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4000'></font>
<font color=#447700>! USE AS IN PETERS-LIDARD, 1998 (MODIF. FROM JOHANSEN, 1975).<a name='4001'></font>
<a name='4002'>
<font color=#447700>!                                  PABLO GRUNMANN, 08/17/98<a name='4003'></font>
<font color=#447700>! REFS.:<a name='4004'></font>
<font color=#447700>!      FAROUKI, O.T.,1986: THERMAL PROPERTIES OF SOILS. SERIES ON ROCK<a name='4005'></font>
<font color=#447700>!              AND SOIL MECHANICS, VOL. 11, TRANS TECH, 136 PP.<a name='4006'></font>
<font color=#447700>!      JOHANSEN, O., 1975: THERMAL CONDUCTIVITY OF SOILS. PH.D. THESIS,<a name='4007'></font>
<font color=#447700>!              UNIVERSITY OF TRONDHEIM,<a name='4008'></font>
<font color=#447700>!      PETERS-LIDARD, C. D., ET AL., 1998: THE EFFECT OF SOIL THERMAL<a name='4009'></font>
<font color=#447700>!              CONDUCTIVITY PARAMETERIZATION ON SURFACE ENERGY FLUXES<a name='4010'></font>
<font color=#447700>!              AND TEMPERATURES. JOURNAL OF THE ATMOSPHERIC SCIENCES,<a name='4011'></font>
<font color=#447700>!              VOL. 55, PP. 1209-1224.<a name='4012'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='4013'></font>
<font color=#447700>! NEEDS PARAMETERS<a name='4014'></font>
<font color=#447700>! POROSITY(SOIL TYPE):<a name='4015'></font>
<font color=#447700>!      POROS = SMCMAX<a name='4016'></font>
<font color=#447700>! SATURATION RATIO:<a name='4017'></font>
<font color=#447700>! PARAMETERS  W/(M.K)<a name='4018'></font>
      SATRATIO = SMC / SMCMAX<a name='4019'>
<font color=#447700>! WATER CONDUCTIVITY:<a name='4020'></font>
      THKW = 0.57<a name='4021'>
<font color=#447700>! THERMAL CONDUCTIVITY OF "OTHER" SOIL COMPONENTS<a name='4022'></font>
<font color=#447700>!      IF (QZ .LE. 0.2) THKO = 3.0<a name='4023'></font>
      THKO = 2.0<a name='4024'>
<font color=#447700>! QUARTZ' CONDUCTIVITY<a name='4025'></font>
      THKQTZ = 7.7<a name='4026'>
<font color=#447700>! SOLIDS' CONDUCTIVITY<a name='4027'></font>
      THKS = (THKQTZ ** QZ)* (THKO ** (1. - QZ))<a name='4028'>
<a name='4029'>
<font color=#447700>! SATURATED THERMAL CONDUCTIVITY<a name='4030'></font>
      THKSAT = THKS ** (1. - SMCMAX)* THKW ** (SMCMAX)<a name='4031'>
<a name='4032'>
<font color=#447700>! DRY DENSITY IN KG/M3<a name='4033'></font>
      GAMMD = (1. - SMCMAX)*2700.<a name='4034'>
<a name='4035'>
<font color=#447700>! DRY THERMAL CONDUCTIVITY IN W.M-1.K-1<a name='4036'></font>
      THKDRY = (0.135* GAMMD+ 64.7)/ (2700. - 0.947* GAMMD)<a name='4037'>
<a name='4038'>
<font color=#447700>! KERSTEN NUMBER (USING "FINE" FORMULA, VALID FOR SOILS CONTAINING AT<a name='4039'></font>
<font color=#447700>! LEAST 5% OF PARTICLES WITH DIAMETER LESS THAN 2.E-6 METERS.)<a name='4040'></font>
<font color=#447700>! (FOR "COARSE" FORMULA, SEE PETERS-LIDARD ET AL., 1998).<a name='4041'></font>
<a name='4042'>
         IF ( SATRATIO &gt;  0.1 ) THEN<a name='4043'>
<a name='4044'>
            AKE = LOG10 (SATRATIO) + 1.0<a name='4045'>
<a name='4046'>
<font color=#447700>! USE K = KDRY<a name='4047'></font>
         ELSE<a name='4048'>
<a name='4049'>
            AKE = 0.0<a name='4050'>
         END IF<a name='4051'>
<font color=#447700>!  THERMAL CONDUCTIVITY<a name='4052'></font>
<a name='4053'>
      DF = AKE * (THKSAT - THKDRY) + THKDRY<a name='4054'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4055'></font>
  END SUBROUTINE TDFCND<a name='4056'>
<font color=#447700>! ----------------------------------------------------------------------<a name='4057'></font>
<font color=#447700>!===========================================================================<a name='4058'></font>
END MODULE module_sf_urban<a name='4059'>
</pre></body></html>