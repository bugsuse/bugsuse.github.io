<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if ( RWORDSIZE == 4 )<a name='2'>
#  define VREC vsrec<a name='3'>
#  define VSQRT vssqrt<a name='4'>
#else<a name='5'>
#  define VREC vrec<a name='6'>
#  define VSQRT vsqrt<a name='7'>
#endif<a name='8'>
<a name='9'>
<font color=#447700>!Including inline expansion statistical function <a name='10'></font>
<A NAME='MODULE_MP_WSM5'><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#MODULE_MP_WSM5' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='11'>
<font color=#993300>MODULE </font><font color=#cc0000>module_mp_wsm5</font> <A href='../../call_to/MODULE_MP_WSM5.html' TARGET='index'>2</A><a name='12'>
<font color=#447700>!<a name='13'></font>
<font color=#447700>!<a name='14'></font>
   REAL, PARAMETER, PRIVATE :: dtcldcr     = 120. <font color=#447700>! maximum time step for minor loops<a name='15'></font>
   REAL, PARAMETER, PRIVATE :: n0r = 8.e6         <font color=#447700>! intercept parameter rain<a name='16'></font>
   REAL, PARAMETER, PRIVATE :: avtr = 841.9       <font color=#447700>! a constant for terminal velocity of rain<a name='17'></font>
   REAL, PARAMETER, PRIVATE :: bvtr = 0.8         <font color=#447700>! a constant for terminal velocity of rain<a name='18'></font>
   REAL, PARAMETER, PRIVATE :: r0 = .8e-5         <font color=#447700>! 8 microm  in contrast to 10 micro m<a name='19'></font>
   REAL, PARAMETER, PRIVATE :: peaut = .55        <font color=#447700>! collection efficiency<a name='20'></font>
   REAL, PARAMETER, PRIVATE :: xncr = 3.e8        <font color=#447700>! maritime cloud in contrast to 3.e8 in tc80<a name='21'></font>
   REAL, PARAMETER, PRIVATE :: xmyu = 1.718e-5    <font color=#447700>! the dynamic viscosity kgm-1s-1<a name='22'></font>
   REAL, PARAMETER, PRIVATE :: avts = 11.72       <font color=#447700>! a constant for terminal velocity of snow<a name='23'></font>
   REAL, PARAMETER, PRIVATE :: bvts = .41         <font color=#447700>! a constant for terminal velocity of snow<a name='24'></font>
   REAL, PARAMETER, PRIVATE :: n0smax =  1.e11    <font color=#447700>! maximum n0s (t=-90C unlimited)<a name='25'></font>
   REAL, PARAMETER, PRIVATE :: lamdarmax = 8.e4   <font color=#447700>! limited maximum value for slope parameter of rain<a name='26'></font>
   REAL, PARAMETER, PRIVATE :: lamdasmax = 1.e5   <font color=#447700>! limited maximum value for slope parameter of snow<a name='27'></font>
   REAL, PARAMETER, PRIVATE :: lamdagmax = 6.e4   <font color=#447700>! limited maximum value for slope parameter of graupel<a name='28'></font>
   REAL, PARAMETER, PRIVATE :: dicon = 11.9       <font color=#447700>! constant for the cloud-ice diamter<a name='29'></font>
   REAL, PARAMETER, PRIVATE :: dimax = 500.e-6    <font color=#447700>! limited maximum value for the cloud-ice diamter<a name='30'></font>
   REAL, PARAMETER, PRIVATE :: n0s = 2.e6         <font color=#447700>! temperature dependent intercept parameter snow<a name='31'></font>
   REAL, PARAMETER, PRIVATE :: alpha = .12        <font color=#447700>! .122 exponen factor for n0s<a name='32'></font>
   REAL, PARAMETER, PRIVATE :: pfrz1 = 100.       <font color=#447700>! constant in Biggs freezing<a name='33'></font>
   REAL, PARAMETER, PRIVATE :: pfrz2 = 0.66       <font color=#447700>! constant in Biggs freezing<a name='34'></font>
   REAL, PARAMETER, PRIVATE :: qcrmin = 1.e-9     <font color=#447700>! minimun values for qr, qs, and qg<a name='35'></font>
   REAL, PARAMETER, PRIVATE :: eacrc = 1.0        <font color=#447700>! Snow/cloud-water collection efficiency<a name='36'></font>
   REAL, SAVE ::                                      &amp;<a name='37'>
             qc0, qck1,bvtr1,bvtr2,bvtr3,bvtr4,g1pbr, &amp;<a name='38'>
             g3pbr,g4pbr,g5pbro2,pvtr,eacrr,pacrr,    &amp;<a name='39'>
             precr1,precr2,xmmax,roqimax,bvts1,       &amp;<a name='40'>
             bvts2,bvts3,bvts4,g1pbs,g3pbs,g4pbs,     &amp;<a name='41'>
             g5pbso2,pvts,pacrs,precs1,precs2,pidn0r, &amp;<a name='42'>
             pidn0s,xlv1,pacrc,                       &amp;<a name='43'>
             rslopermax,rslopesmax,rslopegmax,        &amp;<a name='44'>
             rsloperbmax,rslopesbmax,rslopegbmax,     &amp;<a name='45'>
             rsloper2max,rslopes2max,rslopeg2max,     &amp;<a name='46'>
             rsloper3max,rslopes3max,rslopeg3max<a name='47'>
<font color=#447700>!<a name='48'></font>
<font color=#447700>! Specifies code-inlining of fpvs function in WSM52D below. JM 20040507<a name='49'></font>
<font color=#447700>!<a name='50'></font>
CONTAINS<a name='51'>
<font color=#447700>!===================================================================<a name='52'></font>
<font color=#447700>!<a name='53'></font>
<A NAME='WSM5'><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM5' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='54'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>wsm5</font>(th, q, qc, qr, qi, qs                            &amp; <A href='../../call_to/WSM5.html' TARGET='index'>2</A>,<A href='../../call_from/WSM5.html' TARGET='index'>7</A><a name='55'>
                 ,den, pii, p, delz                                &amp;<a name='56'>
                 ,delt,g, cpd, cpv, rd, rv, t0c                    &amp;<a name='57'>
                 ,ep1, ep2, qmin                                   &amp;<a name='58'>
                 ,XLS, XLV0, XLF0, den0, denr                      &amp;<a name='59'>
                 ,cliq,cice,psat                                   &amp;<a name='60'>
                 ,rain, rainncv                                    &amp;<a name='61'>
                 ,snow, snowncv                                    &amp;<a name='62'>
                 ,sr                                               &amp;<a name='63'>
                 ,ids,ide, jds,jde, kds,kde                        &amp;<a name='64'>
                 ,ims,ime, jms,jme, kms,kme                        &amp;<a name='65'>
                 ,its,ite, jts,jte, kts,kte                        &amp;<a name='66'>
                                                                   )<a name='67'>
#ifdef _OPENMP<a name='68'>
  use omp_lib<a name='69'>
#endif<a name='70'>
<font color=#447700>!-------------------------------------------------------------------<a name='71'></font>
  IMPLICIT NONE<a name='72'>
<font color=#447700>!-------------------------------------------------------------------<a name='73'></font>
<font color=#447700>!<a name='74'></font>
<font color=#447700>!  This code is a 5-class mixed ice microphyiscs scheme (WSM5) of the WRF<a name='75'></font>
<font color=#447700>!  Single-Moment MicroPhyiscs (WSMMP). The WSMMP assumes that ice nuclei<a name='76'></font>
<font color=#447700>!  number concentration is a function of temperature, and seperate assumption<a name='77'></font>
<font color=#447700>!  is developed, in which ice crystal number concentration is a function<a name='78'></font>
<font color=#447700>!  of ice amount. A theoretical background of the ice-microphysics and related<a name='79'></font>
<font color=#447700>!  processes in the WSMMPs are described in Hong et al. (2004).<a name='80'></font>
<font color=#447700>!  Production terms in the WSM6 scheme are described in Hong and Lim (2006).<a name='81'></font>
<font color=#447700>!  All units are in m.k.s. and source/sink terms in kgkg-1s-1.<a name='82'></font>
<font color=#447700>!<a name='83'></font>
<font color=#447700>!  WSM5 cloud scheme<a name='84'></font>
<font color=#447700>!<a name='85'></font>
<font color=#447700>!  Coded by Song-You Hong (Yonsei Univ.)<a name='86'></font>
<font color=#447700>!             Jimy Dudhia (NCAR) and Shu-Hua Chen (UC Davis)<a name='87'></font>
<font color=#447700>!             Summer 2002<a name='88'></font>
<font color=#447700>!<a name='89'></font>
<font color=#447700>!  Implemented by Song-You Hong (Yonsei Univ.) and Jimy Dudhia (NCAR)<a name='90'></font>
<font color=#447700>!             Summer 2003<a name='91'></font>
<font color=#447700>!<a name='92'></font>
<font color=#447700>!  Reference) Hong, Dudhia, Chen (HDC, 2004) Mon. Wea. Rev.<a name='93'></font>
<font color=#447700>!             Rutledge, Hobbs (RH83, 1983) J. Atmos. Sci.<a name='94'></font>
<font color=#447700>!             Hong and Lim (HL, 2006) J. Korean Meteor. Soc.<a name='95'></font>
<font color=#447700>!<a name='96'></font>
  INTEGER,      INTENT(IN   )    ::   ids,ide, jds,jde, kds,kde , &amp;<a name='97'>
                                      ims,ime, jms,jme, kms,kme , &amp;<a name='98'>
                                      its,ite, jts,jte, kts,kte<a name='99'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),                 &amp;<a name='100'>
        INTENT(INOUT) ::                                          &amp;<a name='101'>
                                                             th,  &amp;<a name='102'>
                                                              q,  &amp;<a name='103'>
                                                              qc, &amp;<a name='104'>
                                                              qi, &amp;<a name='105'>
                                                              qr, &amp;<a name='106'>
                                                              qs<a name='107'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),                 &amp;<a name='108'>
        INTENT(IN   ) ::                                          &amp;<a name='109'>
                                                             den, &amp;<a name='110'>
                                                             pii, &amp;<a name='111'>
                                                               p, &amp;<a name='112'>
                                                            delz<a name='113'>
  REAL, INTENT(IN   ) ::                                    delt, &amp;<a name='114'>
                                                               g, &amp;<a name='115'>
                                                              rd, &amp;<a name='116'>
                                                              rv, &amp;<a name='117'>
                                                             t0c, &amp;<a name='118'>
                                                            den0, &amp;<a name='119'>
                                                             cpd, &amp;<a name='120'>
                                                             cpv, &amp;<a name='121'>
                                                             ep1, &amp;<a name='122'>
                                                             ep2, &amp;<a name='123'>
                                                            qmin, &amp;<a name='124'>
                                                             XLS, &amp;<a name='125'>
                                                            XLV0, &amp;<a name='126'>
                                                            XLF0, &amp;<a name='127'>
                                                            cliq, &amp;<a name='128'>
                                                            cice, &amp;<a name='129'>
                                                            psat, &amp;<a name='130'>
                                                            denr<a name='131'>
  REAL, DIMENSION( ims:ime , jms:jme ),                           &amp;<a name='132'>
        INTENT(INOUT) ::                                    rain, &amp;<a name='133'>
                                                         rainncv, &amp;<a name='134'>
                                                              sr<a name='135'>
<a name='136'>
  REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL,                 &amp;<a name='137'>
        INTENT(INOUT) ::                                    snow, &amp;<a name='138'>
                                                         snowncv<a name='139'>
<a name='140'>
<font color=#447700>! LOCAL VAR<a name='141'></font>
  REAL, DIMENSION( its:ite , kts:kte ) ::   t<a name='142'>
  REAL, DIMENSION( its:ite , kts:kte, 2 ) ::   qci, qrs<a name='143'>
  CHARACTER*256 :: emess<a name='144'>
  INTEGER :: mkx_test<a name='145'>
  INTEGER ::               i,j,k<a name='146'>
<a name='147'>
#ifdef _ACCEL_PROF<a name='148'>
  INTEGER :: l<a name='149'>
  real*8 wsm3_t(8,256), wsm5_t(8,256), t1, t2<a name='150'>
  common /wsm_times/ wsm3_t(8,256), wsm5_t(8,256)<a name='151'>
#endif<a name='152'>
<a name='153'>
<a name='154'>
<font color=#447700>!-------------------------------------------------------------------<a name='155'></font>
<a name='156'>
#ifdef _ACCEL_PROF<a name='157'>
call cpu_time(t1)<a name='158'>
#endif<a name='159'>
<a name='160'>
#ifndef RUN_ON_GPU<a name='161'>
<a name='162'>
#ifdef _ACCEL<a name='163'>
<a name='164'>
      <font color=#447700>!  Need to send th, pii, qc, qi, qr, qs<a name='165'></font>
      <font color=#447700>!  Don't send t<a name='166'></font>
<a name='167'>
      CALL <A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM52D'>wsm52D</A><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM5' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WSM52D_2">(th, pii, q, qc, qr, qi, qs                       &amp;<a name='168'>
                  ,den                                             &amp;<a name='169'>
                  ,p, delz                                         &amp;<a name='170'>
                  ,delt,g, cpd, cpv, rd, rv, t0c                   &amp;<a name='171'>
                  ,ep1, ep2, qmin                                  &amp;<a name='172'>
                  ,XLS, XLV0, XLF0, den0, denr                     &amp;<a name='173'>
                  ,cliq,cice,psat                                  &amp;<a name='174'>
                  ,rain,rainncv                                    &amp;<a name='175'>
                  ,sr                                              &amp;<a name='176'>
                  ,ids,ide, jds,jde, kds,kde                       &amp;<a name='177'>
                  ,ims,ime, jms,jme, kms,kme                       &amp;<a name='178'>
                  ,its,ite, jts,jte, kts,kte                       &amp;<a name='179'>
                  ,snow,snowncv                                    &amp;<a name='180'>
                                                                   )<a name='181'>
<a name='182'>
#else<a name='183'>
<a name='184'>
      DO j=jts,jte<a name='185'>
         DO k=kts,kte<a name='186'>
         DO i=its,ite<a name='187'>
            t(i,k)=th(i,k,j)*pii(i,k,j)<a name='188'>
            qci(i,k,1) = qc(i,k,j)<a name='189'>
            qci(i,k,2) = qi(i,k,j)<a name='190'>
            qrs(i,k,1) = qr(i,k,j)<a name='191'>
            qrs(i,k,2) = qs(i,k,j)<a name='192'>
         ENDDO<a name='193'>
         ENDDO<a name='194'>
<a name='195'>
         <font color=#447700>!  Sending array starting locations of optional variables may cause<a name='196'></font>
         <font color=#447700>!  troubles, so we explicitly change the call.<a name='197'></font>
<a name='198'>
         CALL <A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM52D'>wsm52D</A><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM5' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WSM52D_3">(t, q(ims,kms,j), qci, qrs                     &amp;<a name='199'>
                    ,den(ims,kms,j)                                &amp;<a name='200'>
                    ,p(ims,kms,j), delz(ims,kms,j)                 &amp;<a name='201'>
                    ,delt,g, cpd, cpv, rd, rv, t0c                 &amp;<a name='202'>
                    ,ep1, ep2, qmin                                &amp;<a name='203'>
                    ,XLS, XLV0, XLF0, den0, denr                   &amp;<a name='204'>
                    ,cliq,cice,psat                                &amp;<a name='205'>
                    ,j                                             &amp;<a name='206'>
                    ,rain(ims,j),rainncv(ims,j)                    &amp;<a name='207'>
                    ,sr(ims,j)                                     &amp;<a name='208'>
                    ,ids,ide, jds,jde, kds,kde                     &amp;<a name='209'>
                    ,ims,ime, jms,jme, kms,kme                     &amp;<a name='210'>
                    ,its,ite, jts,jte, kts,kte                     &amp;<a name='211'>
                    ,snow,snowncv                                  &amp;<a name='212'>
                                                                   )<a name='213'>
<a name='214'>
         DO K=kts,kte<a name='215'>
         DO I=its,ite<a name='216'>
            th(i,k,j)=t(i,k)/pii(i,k,j)<a name='217'>
            qc(i,k,j) = qci(i,k,1)<a name='218'>
            qi(i,k,j) = qci(i,k,2)<a name='219'>
            qr(i,k,j) = qrs(i,k,1)<a name='220'>
            qs(i,k,j) = qrs(i,k,2)<a name='221'>
         ENDDO<a name='222'>
         ENDDO<a name='223'>
      ENDDO<a name='224'>
#endif<a name='225'>
#else<a name='226'>
      CALL get_wsm5_gpu_levels ( mkx_test )<a name='227'>
      IF ( mkx_test .LT. kte ) THEN<a name='228'>
        WRITE(emess,*)'Number of levels compiled for GPU WSM5 too small. ',      &amp;<a name='229'>
                      mkx_test,' &lt; ',kte<a name='230'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM5' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_891">(emess)<a name='231'>
      ENDIF<a name='232'>
      CALL wsm5_host (                                                           &amp;<a name='233'>
                    th(its:ite,kts:kte,jts:jte), pii(its:ite,kts:kte,jts:jte)    &amp;<a name='234'>
                   ,q(its:ite,kts:kte,jts:jte), qc(its:ite,kts:kte,jts:jte)      &amp;<a name='235'>
                   ,qi(its:ite,kts:kte,jts:jte), qr(its:ite,kts:kte,jts:jte)     &amp;<a name='236'>
                   ,qs(its:ite,kts:kte,jts:jte), den(its:ite,kts:kte,jts:jte)    &amp;<a name='237'>
                   ,p(its:ite,kts:kte,jts:jte), delz(its:ite,kts:kte,jts:jte)    &amp;<a name='238'>
                   ,delt                                                         &amp;<a name='239'>
                   ,rain(its:ite,jts:jte),rainncv(its:ite,jts:jte)               &amp;<a name='240'>
                   ,snow(its:ite,jts:jte),snowncv(its:ite,jts:jte)               &amp;<a name='241'>
                   ,sr(its:ite,jts:jte)                                          &amp;<a name='242'>
                   ,its, ite,  jts, jte,  kts, kte                               &amp;<a name='243'>
                   ,its, ite,  jts, jte,  kts, kte                               &amp;<a name='244'>
                   ,its, ite,  jts, jte,  kts, kte                               &amp;<a name='245'>
          )<a name='246'>
#endif<a name='247'>
<a name='248'>
<a name='249'>
#ifdef _ACCEL_PROF<a name='250'>
  call cpu_time(t2)<a name='251'>
#ifdef _OPENMP<a name='252'>
  l = omp_get_thread_num() + 1<a name='253'>
#else<a name='254'>
  l = 1<a name='255'>
#endif<a name='256'>
  wsm5_t(1,l) = wsm5_t(1,l) + (t2 - t1)<a name='257'>
#endif<a name='258'>
<a name='259'>
  END SUBROUTINE wsm5<a name='260'>
<a name='261'>
<a name='262'>
#ifdef _ACCEL<a name='263'>
<a name='264'>
<font color=#447700>!===================================================================<a name='265'></font>
<font color=#447700>!<a name='266'></font>
<A NAME='WSM52D'><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM52D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='267'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>wsm52D</font>(th, pii, q, qc, qr, qi, qqs, den, p, delz     &amp; <A href='../../call_to/WSM52D.html' TARGET='index'>3</A>,<A href='../../call_from/WSM52D.html' TARGET='index'>10</A><a name='268'>
                   ,delt,g, cpd, cpv, rd, rv, t0c                 &amp;<a name='269'>
                   ,ep1, ep2, qmin                                &amp;<a name='270'>
                   ,XLS, XLV0, XLF0, den0, denr                   &amp;<a name='271'>
                   ,cliq,cice,psat                                &amp;<a name='272'>
                   ,rain,rainncv                                  &amp;<a name='273'>
                   ,sr                                            &amp;<a name='274'>
                   ,ids,ide, jds,jde, kds,kde                     &amp;<a name='275'>
                   ,ims,ime, jms,jme, kms,kme                     &amp;<a name='276'>
                   ,its,ite, jts,jte, kts,kte                     &amp;<a name='277'>
                   ,snow,snowncv                                  &amp;<a name='278'>
                                                                  )<a name='279'>
<font color=#447700>!-------------------------------------------------------------------<a name='280'></font>
  IMPLICIT NONE<a name='281'>
<font color=#447700>!-------------------------------------------------------------------<a name='282'></font>
  INTEGER,      INTENT(IN   )    ::   ids,ide, jds,jde, kds,kde , &amp;<a name='283'>
                                      ims,ime, jms,jme, kms,kme , &amp;<a name='284'>
                                      its,ite, jts,jte, kts,kte<a name='285'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),                 &amp;<a name='286'>
        INTENT(INOUT) ::                                          &amp;<a name='287'>
                                                              th<a name='288'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),                 &amp;<a name='289'>
        INTENT(IN) ::                                             &amp;<a name='290'>
                                                             pii<a name='291'>
  REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),                  &amp;<a name='292'>
        INTENT(INOUT) ::                                          &amp;<a name='293'>
                                                              qc, &amp;<a name='294'>
                                                              qr, &amp;<a name='295'>
                                                              qi, &amp;<a name='296'>
                                                             qqs<a name='297'>
  REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),                  &amp;<a name='298'>
        INTENT(INOUT) ::                                          &amp;<a name='299'>
                                                               q<a name='300'>
  REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),                  &amp;<a name='301'>
        INTENT(IN   ) ::                                          &amp;<a name='302'>
                                                             den, &amp;<a name='303'>
                                                               p, &amp;<a name='304'>
                                                            delz<a name='305'>
  REAL, INTENT(IN   ) ::                                    delt, &amp;<a name='306'>
                                                               g, &amp;<a name='307'>
                                                             cpd, &amp;<a name='308'>
                                                             cpv, &amp;<a name='309'>
                                                             t0c, &amp;<a name='310'>
                                                            den0, &amp;<a name='311'>
                                                              rd, &amp;<a name='312'>
                                                              rv, &amp;<a name='313'>
                                                             ep1, &amp;<a name='314'>
                                                             ep2, &amp;<a name='315'>
                                                            qmin, &amp;<a name='316'>
                                                             XLS, &amp;<a name='317'>
                                                            XLV0, &amp;<a name='318'>
                                                            XLF0, &amp;<a name='319'>
                                                            cliq, &amp;<a name='320'>
                                                            cice, &amp;<a name='321'>
                                                            psat, &amp;<a name='322'>
                                                            denr<a name='323'>
  REAL, DIMENSION( ims:ime, jms:jme ),                            &amp;<a name='324'>
        INTENT(INOUT) ::                                    rain, &amp;<a name='325'>
                                                         rainncv, &amp;<a name='326'>
                                                              sr<a name='327'>
<a name='328'>
  REAL, DIMENSION( ims:ime, jms:jme ),     OPTIONAL,              &amp;<a name='329'>
        INTENT(INOUT) ::                                    snow, &amp;<a name='330'>
                                                         snowncv<a name='331'>
<a name='332'>
<font color=#447700>! LOCAL VAR<a name='333'></font>
  REAL, DIMENSION( its:ite , kts:kte , 2) ::                      &amp;<a name='334'>
                                                              rh, &amp;<a name='335'>
                                                              qs, &amp;<a name='336'>
                                                          rslope, &amp;<a name='337'>
                                                         rslope2, &amp;<a name='338'>
                                                         rslope3, &amp;<a name='339'>
                                                         rslopeb, &amp;<a name='340'>
                                                            falk, &amp;<a name='341'>
                                                            fall, &amp;<a name='342'>
                                                           work1<a name='343'>
  REAL, DIMENSION( its:ite , kts:kte, jts:jte ) ::                &amp;<a name='344'>
                                                               t<a name='345'>
  REAL, DIMENSION( its:ite , kts:kte , 2 ) ::                     &amp;<a name='346'>
                                                             qci, &amp;<a name='347'>
                                                             qrs<a name='348'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='349'>
                                                           falkc, &amp;<a name='350'>
                                                           fallc, &amp;<a name='351'>
                                                              xl, &amp;<a name='352'>
                                                             cpm, &amp;<a name='353'>
                                                          denfac, &amp;<a name='354'>
                                                             xni, &amp;<a name='355'>
                                                          n0sfac, &amp;<a name='356'>
                                                           work2, &amp;<a name='357'>
                                                          work1c, &amp;<a name='358'>
                                                          work2c<a name='359'>
<a name='360'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='361'>
                                                           pigen, &amp;<a name='362'>
                                                           pidep, &amp;<a name='363'>
                                                           psdep, &amp;<a name='364'>
                                                           praut, &amp;<a name='365'>
                                                           psaut, &amp;<a name='366'>
                                                           prevp, &amp;<a name='367'>
                                                           psevp, &amp;<a name='368'>
                                                           pracw, &amp;<a name='369'>
                                                           psacw, &amp;<a name='370'>
                                                           psaci, &amp;<a name='371'>
                                                           pcond, &amp;<a name='372'>
                                                           psmlt<a name='373'>
  INTEGER ::                                                      &amp;<a name='374'>
                                                           mstep, &amp;<a name='375'>
                                                           numdt<a name='376'>
  REAL ::                                                 rmstep<a name='377'>
  REAL dtcldden, rdelz, rdtcld<a name='378'>
  LOGICAL ::                                              flgcld<a name='379'>
<a name='380'>
#define WSM_NO_CONDITIONAL_IN_VECTOR<a name='381'>
#ifdef WSM_NO_CONDITIONAL_IN_VECTOR<a name='382'>
  REAL ::                     xal, xbl<a name='383'>
#endif<a name='384'>
<a name='385'>
  REAL  ::  pi,                                                   &amp;<a name='386'>
            cpmcal, xlcal, lamdar, lamdas, diffus,                &amp;<a name='387'>
            viscos, xka, venfac, conden, diffac,                  &amp;<a name='388'>
            x, y, z, a, b, c, d, e,                               &amp;<a name='389'>
            qdt, holdrr, holdrs, supcol, supcolt, pvt,            &amp;<a name='390'>
            coeres, supsat, dtcld, xmi, eacrs, satdt,             &amp;<a name='391'>
            vt2i,vt2s,acrfac,                                     &amp;<a name='392'>
            qimax, diameter, xni0, roqi0,                         &amp;<a name='393'>
            fallsum, fallsum_qsi, xlwork2, factor, source,        &amp;<a name='394'>
            value, xlf, pfrzdtc, pfrzdtr, supice,  holdc, holdci<a name='395'>
<font color=#447700>! variables for optimization<a name='396'></font>
  REAL, DIMENSION( its:ite )           ::                    tvec1<a name='397'>
  REAL ::                                                    temp <a name='398'>
  INTEGER :: i, j, k,                                             &amp;<a name='399'>
            iprt, latd, lond, loop, loops, ifsat, n<a name='400'>
<font color=#447700>! Temporaries used for inlining fpvs function<a name='401'></font>
  REAL  :: dldti, xb, xai, tr, xbi, xa, hvap, cvap, hsub, dldt, ttp<a name='402'>
  REAL  :: logtr<a name='403'>
<font color=#447700>!<a name='404'></font>
<font color=#447700>!=================================================================<a name='405'></font>
<font color=#447700>!   compute internal functions<a name='406'></font>
<font color=#447700>!<a name='407'></font>
      cpmcal(x) = cpd*(1.-max(x,qmin))+max(x,qmin)*cpv<a name='408'>
      xlcal(x) = xlv0-xlv1*(x-t0c)<a name='409'>
<font color=#447700>!----------------------------------------------------------------<a name='410'></font>
<font color=#447700>!     size distributions: (x=mixing ratio, y=air density):<a name='411'></font>
<font color=#447700>!     valid for mixing ratio &gt; 1.e-9 kg/kg.<a name='412'></font>
<font color=#447700>!<a name='413'></font>
<font color=#447700>! Optimizatin : A**B =&gt; exp(log(A)*(B))<a name='414'></font>
      lamdar(x,y)=   sqrt(sqrt(pidn0r/(x*y)))      <font color=#447700>! (pidn0r/(x*y))**.25<a name='415'></font>
      lamdas(x,y,z)= sqrt(sqrt(pidn0s*z/(x*y)))    <font color=#447700>! (pidn0s*z/(x*y))**.25<a name='416'></font>
<font color=#447700>!<a name='417'></font>
<font color=#447700>!----------------------------------------------------------------<a name='418'></font>
<font color=#447700>!     diffus: diffusion coefficient of the water vapor<a name='419'></font>
<font color=#447700>!     viscos: kinematic viscosity(m2s-1)<a name='420'></font>
<font color=#447700>!     diffus(x,y) = 8.794e-5 * exp(log(x)*(1.81)) / y        ! 8.794e-5*x**1.81/y<a name='421'></font>
<font color=#447700>!     viscos(x,y) = 1.496e-6 * (x*sqrt(x)) /(x+120.)/y  ! 1.496e-6*x**1.5/(x+120.)/y<a name='422'></font>
<font color=#447700>!     xka(x,y) = 1.414e3*viscos(x,y)*y<a name='423'></font>
<font color=#447700>!     diffac(a,b,c,d,e) = d*a*a/(xka(c,d)*rv*c*c)+1./(e*diffus(c,b))<a name='424'></font>
<font color=#447700>!     venfac(a,b,c) = exp(log((viscos(b,c)/diffus(b,a)))*((.3333333)))         &amp;<a name='425'></font>
<font color=#447700>!                    /sqrt(viscos(b,c))*sqrt(sqrt(den0/c))<a name='426'></font>
<font color=#447700>!     conden(a,b,c,d,e) = (max(b,qmin)-c)/(1.+d*d/(rv*e)*c/(a*a))<a name='427'></font>
<font color=#447700>!<a name='428'></font>
<font color=#447700>!<a name='429'></font>
      pi = 4. * atan(1.)<a name='430'>
<font color=#447700>!<a name='431'></font>
<font color=#447700>!----------------------------------------------------------------<a name='432'></font>
<font color=#447700>!     paddint 0 for negative values generated by dynamics<a name='433'></font>
<font color=#447700>!<a name='434'></font>
<a name='435'>
<font color=#447700>!<a name='436'></font>
<font color=#447700>! Moved outside of accelerator region<a name='437'></font>
<font color=#447700>!<a name='438'></font>
      loops = max(nint(delt/dtcldcr),1)<a name='439'>
      dtcld = delt/loops<a name='440'>
      if(delt.le.dtcldcr) dtcld = delt<a name='441'>
<font color=#447700>!<a name='442'></font>
<a name='443'>
<font color=#447700>!....!$acc        local(t) &amp;<a name='444'></font>
<a name='445'>
      IF ( PRESENT (snowncv) .AND. PRESENT (snow)) THEN<a name='446'>
<a name='447'>
<font color=#447700>!$acc region &amp;<a name='448'></font>
<font color=#447700>!$acc        local(t) &amp;<a name='449'></font>
<font color=#447700>!$acc        copyin(delz(:,:,:),p(:,:,:),den(:,:,:),pii(:,:,:)) &amp;<a name='450'></font>
<font color=#447700>!$acc        copyout(snowncv(:,:),rainncv(:,:),sr(:,:)) &amp;<a name='451'></font>
<font color=#447700>!$acc        copy(qqs(:,:,:),qr(:,:,:),qi(:,:,:),qc(:,:,:)) &amp;<a name='452'></font>
<font color=#447700>!$acc        copy(th(:,:,:),q(:,:,:),snow(:,:),rain(:,:))<a name='453'></font>
<font color=#447700>!$acc do &amp;<a name='454'></font>
<font color=#447700>!$acc        private(rh,qs,rslope,rslope2,rslope3,rslopeb,falk,fall) &amp;<a name='455'></font>
<font color=#447700>!$acc        private(work1,qci,qrs,falkc,fallc,xl,cpm,denfac,xni) &amp;<a name='456'></font>
<font color=#447700>!$acc        private(n0sfac,work2,work1c,work2c,pigen,pidep,psdep) &amp;<a name='457'></font>
<font color=#447700>!$acc        private(praut,psaut,prevp,psevp) &amp;<a name='458'></font>
<font color=#447700>!$acc        private(pracw,psacw,psaci,pcond,psmlt) &amp;<a name='459'></font>
<font color=#447700>!$acc        parallel<a name='460'></font>
      do j = jts, jte<a name='461'>
<font color=#447700>!$acc do &amp;<a name='462'></font>
<font color=#447700>!$acc        private(numdt,mstep) &amp;<a name='463'></font>
<font color=#447700>!$acc        kernel vector<a name='464'></font>
        do i = its, ite<a name='465'>
        do k = kts, kte<a name='466'>
          t(i,k,j)=th(i,k,j)*pii(i,k,j)<a name='467'>
          qci(i,k,1) = max(qc(i,k,j),0.0)<a name='468'>
          qci(i,k,2) = max(qi(i,k,j),0.0)<a name='469'>
          qrs(i,k,1) = max(qr(i,k,j),0.0)<a name='470'>
          qrs(i,k,2) = max(qqs(i,k,j),0.0)<a name='471'>
        enddo<a name='472'>
<font color=#447700>!<a name='473'></font>
<font color=#447700>!----------------------------------------------------------------<a name='474'></font>
<font color=#447700>!     latent heat for phase changes and heat capacity. neglect the<a name='475'></font>
<font color=#447700>!     changes during microphysical process calculation<a name='476'></font>
<font color=#447700>!     emanuel(1994)<a name='477'></font>
<font color=#447700>!<a name='478'></font>
      do k = kts, kte<a name='479'>
          cpm(i,k) = cpmcal(q(i,k,j))<a name='480'>
          xl(i,k) = xlcal(t(i,k,j))<a name='481'>
      enddo<a name='482'>
<font color=#447700>!<a name='483'></font>
<font color=#447700>!----------------------------------------------------------------<a name='484'></font>
<font color=#447700>!     compute the minor time steps.<a name='485'></font>
<font color=#447700>!<a name='486'></font>
<font color=#447700>!     loops = max(nint(delt/dtcldcr),1)<a name='487'></font>
<font color=#447700>!     dtcld = delt/loops<a name='488'></font>
<font color=#447700>!     if(delt.le.dtcldcr) dtcld = delt<a name='489'></font>
<font color=#447700>!<a name='490'></font>
      do loop = 1,loops<a name='491'>
<font color=#447700>!<a name='492'></font>
<font color=#447700>!----------------------------------------------------------------<a name='493'></font>
<font color=#447700>!     initialize the large scale variables<a name='494'></font>
<font color=#447700>!<a name='495'></font>
        mstep = 1<a name='496'>
        flgcld = .true.<a name='497'>
<font color=#447700>!<a name='498'></font>
      do k = kts, kte<a name='499'>
          denfac(i,k) = sqrt(den0/den(i,k,j))<a name='500'>
      enddo<a name='501'>
<font color=#447700>!     do k = kts, kte<a name='502'></font>
<font color=#447700>!       CALL VREC( tvec1(its), den(its,k,j), ite-its+1)<a name='503'></font>
<font color=#447700>!       do i = its, ite<a name='504'></font>
<font color=#447700>!         tvec1(i) = tvec1(i)*den0<a name='505'></font>
<font color=#447700>!       enddo<a name='506'></font>
<font color=#447700>!       CALL VSQRT( denfac(its,k), tvec1(its), ite-its+1)<a name='507'></font>
<font color=#447700>!     enddo<a name='508'></font>
<font color=#447700>!<a name='509'></font>
<font color=#447700>! Inline expansion for fpvs<a name='510'></font>
<font color=#447700>!         qs(i,k,1) = fpvs(t(i,k,j),0,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='511'></font>
<font color=#447700>!         qs(i,k,2) = fpvs(t(i,k,j),1,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='512'></font>
      hsub = xls<a name='513'>
      hvap = xlv0<a name='514'>
      cvap = cpv<a name='515'>
      ttp=t0c+0.01<a name='516'>
      dldt=cvap-cliq<a name='517'>
      xa=-dldt/rv<a name='518'>
      xb=xa+hvap/(rv*ttp)<a name='519'>
      dldti=cvap-cice<a name='520'>
      xai=-dldti/rv<a name='521'>
      xbi=xai+hsub/(rv*ttp)<a name='522'>
<a name='523'>
<font color=#447700>! this is for compilers where the conditional inhibits vectorization<a name='524'></font>
#ifdef WSM_NO_CONDITIONAL_IN_VECTOR<a name='525'>
      do k = kts, kte<a name='526'>
          if(t(i,k,j).lt.ttp) then<a name='527'>
            xal = xai<a name='528'>
            xbl = xbi<a name='529'>
          else<a name='530'>
            xal = xa<a name='531'>
            xbl = xb<a name='532'>
          endif<a name='533'>
          tr=ttp/t(i,k,j)<a name='534'>
          logtr=log(tr)<a name='535'>
          qs(i,k,1)=psat*exp(logtr*(xa)+xb*(1.-tr))<a name='536'>
          qs(i,k,1) = ep2 * qs(i,k,1) / (p(i,k,j) - qs(i,k,1))<a name='537'>
          qs(i,k,1) = max(qs(i,k,1),qmin)<a name='538'>
          rh(i,k,1) = max(q(i,k,j) / qs(i,k,1),qmin)<a name='539'>
          qs(i,k,2)=psat*exp(logtr*(xal)+xbl*(1.-tr))<a name='540'>
          qs(i,k,2) = ep2 * qs(i,k,2) / (p(i,k,j) - qs(i,k,2))<a name='541'>
          qs(i,k,2) = max(qs(i,k,2),qmin)<a name='542'>
          rh(i,k,2) = max(q(i,k,j) / qs(i,k,2),qmin)<a name='543'>
      enddo<a name='544'>
#else<a name='545'>
      do k = kts, kte<a name='546'>
          tr=ttp/t(i,k,j)<a name='547'>
          logtr=log(tr)<a name='548'>
          qs(i,k,1)=psat*exp(logtr*(xa)+xb*(1.-tr))<a name='549'>
          qs(i,k,1) = ep2 * qs(i,k,1) / (p(i,k,j) - qs(i,k,1))<a name='550'>
          qs(i,k,1) = max(qs(i,k,1),qmin)<a name='551'>
          rh(i,k,1) = max(q(i,k,j) / qs(i,k,1),qmin)<a name='552'>
          if(t(i,k,j).lt.ttp) then<a name='553'>
            qs(i,k,2)=psat*exp(logtr*(xai)+xbi*(1.-tr))<a name='554'>
          else<a name='555'>
            qs(i,k,2)=psat*exp(logtr*(xa)+xb*(1.-tr))<a name='556'>
          endif<a name='557'>
          qs(i,k,2) = ep2 * qs(i,k,2) / (p(i,k,j) - qs(i,k,2))<a name='558'>
          qs(i,k,2) = max(qs(i,k,2),qmin)<a name='559'>
          rh(i,k,2) = max(q(i,k,j) / qs(i,k,2),qmin)<a name='560'>
      enddo<a name='561'>
#endif<a name='562'>
<a name='563'>
<font color=#447700>!<a name='564'></font>
<font color=#447700>!----------------------------------------------------------------<a name='565'></font>
<font color=#447700>!     initialize the variables for microphysical physics<a name='566'></font>
<font color=#447700>!<a name='567'></font>
<font color=#447700>!<a name='568'></font>
      do k = kts, kte<a name='569'>
          prevp(i,k) = 0.<a name='570'>
          psdep(i,k) = 0.<a name='571'>
          praut(i,k) = 0.<a name='572'>
          psaut(i,k) = 0.<a name='573'>
          pracw(i,k) = 0.<a name='574'>
          psaci(i,k) = 0.<a name='575'>
          psacw(i,k) = 0.<a name='576'>
          pigen(i,k) = 0.<a name='577'>
          pidep(i,k) = 0.<a name='578'>
          pcond(i,k) = 0.<a name='579'>
          psmlt(i,k) = 0.<a name='580'>
          psevp(i,k) = 0.<a name='581'>
          falk(i,k,1) = 0.<a name='582'>
          falk(i,k,2) = 0.<a name='583'>
          fall(i,k,1) = 0.<a name='584'>
          fall(i,k,2) = 0.<a name='585'>
          fallc(i,k) = 0.<a name='586'>
          falkc(i,k) = 0.<a name='587'>
          xni(i,k) = 1.e3<a name='588'>
      enddo<a name='589'>
<font color=#447700>!<a name='590'></font>
<font color=#447700>!----------------------------------------------------------------<a name='591'></font>
<font color=#447700>!     compute the fallout term:<a name='592'></font>
<font color=#447700>!     first, vertical terminal velosity for minor loops<a name='593'></font>
<font color=#447700>!<a name='594'></font>
      do k = kts, kte<a name='595'>
          supcol = t0c-t(i,k,j)<a name='596'>
<font color=#447700>!---------------------------------------------------------------<a name='597'></font>
<font color=#447700>! n0s: Intercept parameter for snow [m-4] [HDC 6]<a name='598'></font>
<font color=#447700>!---------------------------------------------------------------<a name='599'></font>
          n0sfac(i,k) = max(min(exp(alpha*supcol),n0smax/n0s),1.)<a name='600'>
          if(qrs(i,k,1).le.qcrmin)then<a name='601'>
            rslope(i,k,1) = rslopermax<a name='602'>
            rslopeb(i,k,1) = rsloperbmax<a name='603'>
            rslope2(i,k,1) = rsloper2max<a name='604'>
            rslope3(i,k,1) = rsloper3max<a name='605'>
          else<a name='606'>
            rslope(i,k,1) = 1./lamdar(qrs(i,k,1),den(i,k,j))<a name='607'>
            rslopeb(i,k,1) = exp(log(rslope(i,k,1))*(bvtr))<a name='608'>
            rslope2(i,k,1) = rslope(i,k,1)*rslope(i,k,1)<a name='609'>
            rslope3(i,k,1) = rslope2(i,k,1)*rslope(i,k,1)<a name='610'>
          endif<a name='611'>
          if(qrs(i,k,2).le.qcrmin)then<a name='612'>
            rslope(i,k,2) = rslopesmax<a name='613'>
            rslopeb(i,k,2) = rslopesbmax<a name='614'>
            rslope2(i,k,2) = rslopes2max<a name='615'>
            rslope3(i,k,2) = rslopes3max<a name='616'>
          else<a name='617'>
            rslope(i,k,2) = 1./lamdas(qrs(i,k,2),den(i,k,j),n0sfac(i,k))<a name='618'>
            rslopeb(i,k,2) = exp(log(rslope(i,k,2))*(bvts))<a name='619'>
            rslope2(i,k,2) = rslope(i,k,2)*rslope(i,k,2)<a name='620'>
            rslope3(i,k,2) = rslope2(i,k,2)*rslope(i,k,2)<a name='621'>
          endif<a name='622'>
<font color=#447700>!-------------------------------------------------------------<a name='623'></font>
<font color=#447700>! Ni: ice crystal number concentraiton   [HDC 5c]<a name='624'></font>
<font color=#447700>!-------------------------------------------------------------<a name='625'></font>
<font color=#447700>!         xni(i,k) = min(max(5.38e7*(den(i,k,j)                                  &amp;<a name='626'></font>
<font color=#447700>!                   *max(qci(i,k,2),qmin))**0.75,1.e3),1.e6)<a name='627'></font>
          temp = (den(i,k,j)*max(qci(i,k,2),qmin))<a name='628'>
          temp = sqrt(sqrt(temp*temp*temp))<a name='629'>
          xni(i,k) = min(max(5.38e7*temp,1.e3),1.e6)<a name='630'>
      enddo<a name='631'>
<font color=#447700>!<a name='632'></font>
      numdt = 1<a name='633'>
      do k = kte, kts, -1<a name='634'>
          work1(i,k,1) = pvtr*rslopeb(i,k,1)*denfac(i,k)/delz(i,k,j)<a name='635'>
          work1(i,k,2) = pvts*rslopeb(i,k,2)*denfac(i,k)/delz(i,k,j)<a name='636'>
          numdt = max(nint(max(work1(i,k,1),work1(i,k,2))*dtcld+.5),1)<a name='637'>
          if(numdt.ge.mstep) mstep = numdt<a name='638'>
      enddo<a name='639'>
        rmstep = 1./mstep<a name='640'>
<font color=#447700>!<a name='641'></font>
      do n = 1, mstep<a name='642'>
        k = kte<a name='643'>
<font color=#447700>!             falk(i,k,1) = den(i,k,j)*qrs(i,k,1)*work1(i,k,1)/mstep(i)<a name='644'></font>
<font color=#447700>!             falk(i,k,2) = den(i,k,j)*qrs(i,k,2)*work1(i,k,2)/mstep(i)<a name='645'></font>
              falk(i,k,1) = den(i,k,j)*qrs(i,k,1)*work1(i,k,1)*rmstep<a name='646'>
              falk(i,k,2) = den(i,k,j)*qrs(i,k,2)*work1(i,k,2)*rmstep<a name='647'>
              fall(i,k,1) = fall(i,k,1)+falk(i,k,1)<a name='648'>
              fall(i,k,2) = fall(i,k,2)+falk(i,k,2)<a name='649'>
<font color=#447700>!             qrs(i,k,1) = max(qrs(i,k,1)-falk(i,k,1)*dtcld/den(i,k,j),0.)<a name='650'></font>
<font color=#447700>!             qrs(i,k,2) = max(qrs(i,k,2)-falk(i,k,2)*dtcld/den(i,k,j),0.)<a name='651'></font>
              dtcldden = dtcld/den(i,k,j)<a name='652'>
              qrs(i,k,1) = max(qrs(i,k,1)-falk(i,k,1)*dtcldden,0.)<a name='653'>
              qrs(i,k,2) = max(qrs(i,k,2)-falk(i,k,2)*dtcldden,0.)<a name='654'>
<font color=#447700>!           endif<a name='655'></font>
        do k = kte-1, kts, -1<a name='656'>
              falk(i,k,1) = den(i,k,j)*qrs(i,k,1)*work1(i,k,1)*rmstep<a name='657'>
              falk(i,k,2) = den(i,k,j)*qrs(i,k,2)*work1(i,k,2)*rmstep<a name='658'>
              fall(i,k,1) = fall(i,k,1)+falk(i,k,1)<a name='659'>
              fall(i,k,2) = fall(i,k,2)+falk(i,k,2)<a name='660'>
              dtcldden = dtcld/den(i,k,j)<a name='661'>
              rdelz = 1./delz(i,k,j)<a name='662'>
              qrs(i,k,1) = max(qrs(i,k,1)-(falk(i,k,1)-falk(i,k+1,1)           &amp;<a name='663'>
                          *delz(i,k+1,j)*rdelz)*dtcldden,0.)<a name='664'>
              qrs(i,k,2) = max(qrs(i,k,2)-(falk(i,k,2)-falk(i,k+1,2)           &amp;<a name='665'>
                          *delz(i,k+1,j)*rdelz)*dtcldden,0.)<a name='666'>
        enddo<a name='667'>
        do k = kte, kts, -1<a name='668'>
              if(t(i,k,j).gt.t0c.and.qrs(i,k,2).gt.0.) then<a name='669'>
<font color=#447700>!----------------------------------------------------------------<a name='670'></font>
<font color=#447700>! psmlt: melting of snow [HL A33] [RH83 A25]<a name='671'></font>
<font color=#447700>!       (T&gt;T0: S-&gt;R)<a name='672'></font>
<font color=#447700>!----------------------------------------------------------------<a name='673'></font>
                xlf = xlf0<a name='674'>
<font color=#447700>!               work2(i,k)= venfac(p(i,k),t(i,k,j),den(i,k,j))<a name='675'></font>
                work2(i,k)= (exp(log(((1.496e-6*((t(i,k,j))*sqrt(t(i,k,j)))        &amp;<a name='676'>
                            /((t(i,k,j))+120.)/(den(i,k,j)))/(8.794e-5             &amp;<a name='677'>
                            *exp(log(t(i,k,j))*(1.81))/p(i,k,j))))                 &amp;<a name='678'>
                            *((.3333333)))/sqrt((1.496e-6*((t(i,k,j))            &amp;<a name='679'>
                            *sqrt(t(i,k,j)))/((t(i,k,j))+120.)/(den(i,k,j))))        &amp;<a name='680'>
                            *sqrt(sqrt(den0/(den(i,k,j)))))<a name='681'>
                coeres = rslope2(i,k,2)*sqrt(rslope(i,k,2)*rslopeb(i,k,2))<a name='682'>
<font color=#447700>!               psmlt(i,k) = xka(t(i,k,j),den(i,k,j))/xlf*(t0c-t(i,k,j))*pi/2.       &amp;<a name='683'></font>
<font color=#447700>!                           *n0sfac(i,k)*(precs1*rslope2(i,k,2)+precs2         &amp;<a name='684'></font>
<font color=#447700>!                           *work2(i,k)*coeres)<a name='685'></font>
                psmlt(i,k) = (1.414e3*(1.496e-6*((t(i,k,j))*sqrt(t(i,k,j)))        &amp;         <a name='686'>
                            /((t(i,k,j))+120.)/(den(i,k,j)) )*(den(i,k,j)))          &amp;<a name='687'>
                            /xlf*(t0c-t(i,k,j))*pi/2.                            &amp;<a name='688'>
                            *n0sfac(i,k)*(precs1*rslope2(i,k,2)+precs2         &amp;<a name='689'>
                            *work2(i,k)*coeres)<a name='690'>
                psmlt(i,k) = min(max(psmlt(i,k)*dtcld/mstep,                &amp;<a name='691'>
                            -qrs(i,k,2)/mstep),0.)<a name='692'>
                qrs(i,k,2) = qrs(i,k,2) + psmlt(i,k)<a name='693'>
                qrs(i,k,1) = qrs(i,k,1) - psmlt(i,k)<a name='694'>
                t(i,k,j) = t(i,k,j) + xlf/cpm(i,k)*psmlt(i,k)<a name='695'>
              endif<a name='696'>
        enddo<a name='697'>
      enddo<a name='698'>
<a name='699'>
<a name='700'>
<font color=#447700>!---------------------------------------------------------------<a name='701'></font>
<font color=#447700>! Vice [ms-1] : fallout of ice crystal [HDC 5a]<a name='702'></font>
<font color=#447700>!---------------------------------------------------------------<a name='703'></font>
      mstep = 1<a name='704'>
      numdt = 1<a name='705'>
      do k = kte, kts, -1<a name='706'>
          if(qci(i,k,2).le.0.) then<a name='707'>
            work2c(i,k) = 0.<a name='708'>
          else<a name='709'>
            xmi = den(i,k,j)*qci(i,k,2)/xni(i,k)<a name='710'>
<font color=#447700>!           diameter  = min(dicon * sqrt(xmi),dimax)<a name='711'></font>
            diameter  = max(min(dicon * sqrt(xmi),dimax), 1.e-25)<a name='712'>
            work1c(i,k) = 1.49e4*exp(log(diameter)*(1.31))<a name='713'>
            work2c(i,k) = work1c(i,k)/delz(i,k,j)<a name='714'>
          endif<a name='715'>
          numdt = max(nint(work2c(i,k)*dtcld+.5),1)<a name='716'>
          if(numdt.ge.mstep) mstep = numdt<a name='717'>
      enddo<a name='718'>
<font color=#447700>!<a name='719'></font>
      do n = 1, mstep<a name='720'>
        k = kte<a name='721'>
            falkc(i,k) = den(i,k,j)*qci(i,k,2)*work2c(i,k)/mstep<a name='722'>
            holdc = falkc(i,k)<a name='723'>
            fallc(i,k) = fallc(i,k)+falkc(i,k)<a name='724'>
            holdci = qci(i,k,2)<a name='725'>
            qci(i,k,2) = max(qci(i,k,2)-falkc(i,k)*dtcld/den(i,k,j),0.)<a name='726'>
<font color=#447700>!         endif<a name='727'></font>
        do k = kte-1, kts, -1<a name='728'>
              falkc(i,k) = den(i,k,j)*qci(i,k,2)*work2c(i,k)/mstep<a name='729'>
              holdc = falkc(i,k)<a name='730'>
              fallc(i,k) = fallc(i,k)+falkc(i,k)<a name='731'>
              holdci = qci(i,k,2)<a name='732'>
              qci(i,k,2) = max(qci(i,k,2)-(falkc(i,k)-falkc(i,k+1)             &amp;<a name='733'>
                          *delz(i,k+1,j)/delz(i,k,j))*dtcld/den(i,k,j),0.)<a name='734'>
<font color=#447700>!           endif<a name='735'></font>
        enddo<a name='736'>
      enddo<a name='737'>
<font color=#447700>!<a name='738'></font>
<font color=#447700>!<a name='739'></font>
<font color=#447700>!----------------------------------------------------------------<a name='740'></font>
<font color=#447700>!      rain (unit is mm/sec;kgm-2s-1: /1000*delt ===&gt; m)==&gt; mm for wrf<a name='741'></font>
<font color=#447700>!<a name='742'></font>
        fallsum = fall(i,1,1)+fall(i,1,2)+fallc(i,1)<a name='743'>
        fallsum_qsi = fall(i,1,2)+fallc(i,1)<a name='744'>
        rainncv(i,j) = 0.<a name='745'>
        if(fallsum.gt.0.) then<a name='746'>
          rainncv(i,j) = fallsum*delz(i,1,j)/denr*dtcld*1000.<a name='747'>
          rain(i,j) = fallsum*delz(i,1,j)/denr*dtcld*1000. + rain(i,j)<a name='748'>
        endif<a name='749'>
        snowncv(i,j) = 0.<a name='750'>
        if(fallsum_qsi.gt.0.) then<a name='751'>
          snowncv(i,j) = fallsum_qsi*delz(i,kts,j)/denr*dtcld*1000.<a name='752'>
          snow(i,j) = fallsum_qsi*delz(i,kts,j)/denr*dtcld*1000. + snow(i,j)<a name='753'>
        endif<a name='754'>
        sr(i,j) = 0.<a name='755'>
        if(fallsum.gt.0.)sr(i,j)=fallsum_qsi*delz(i,kts,j)/denr*dtcld*1000.        &amp;    <a name='756'>
        /(rainncv(i,j)+1.e-12)<a name='757'>
<font color=#447700>!<a name='758'></font>
<font color=#447700>!---------------------------------------------------------------<a name='759'></font>
<font color=#447700>! pimlt: instantaneous melting of cloud ice [HL A47] [RH83 A28]<a name='760'></font>
<font color=#447700>!       (T&gt;T0: I-&gt;C)<a name='761'></font>
<font color=#447700>!---------------------------------------------------------------<a name='762'></font>
      do k = kts, kte<a name='763'>
          supcol = t0c-t(i,k,j)<a name='764'>
          xlf = xls-xl(i,k)<a name='765'>
          if(supcol.lt.0.) xlf = xlf0<a name='766'>
          if(supcol.lt.0.and.qci(i,k,2).gt.0.) then<a name='767'>
            qci(i,k,1) = qci(i,k,1) + qci(i,k,2)<a name='768'>
            t(i,k,j) = t(i,k,j) - xlf/cpm(i,k)*qci(i,k,2)<a name='769'>
            qci(i,k,2) = 0.<a name='770'>
          endif<a name='771'>
<font color=#447700>!---------------------------------------------------------------<a name='772'></font>
<font color=#447700>! pihmf: homogeneous freezing of cloud water below -40c [HL A45]<a name='773'></font>
<font color=#447700>!        (T&lt;-40C: C-&gt;I)<a name='774'></font>
<font color=#447700>!---------------------------------------------------------------<a name='775'></font>
          if(supcol.gt.40..and.qci(i,k,1).gt.0.) then<a name='776'>
            qci(i,k,2) = qci(i,k,2) + qci(i,k,1)<a name='777'>
            t(i,k,j) = t(i,k,j) + xlf/cpm(i,k)*qci(i,k,1)<a name='778'>
            qci(i,k,1) = 0.<a name='779'>
          endif<a name='780'>
<font color=#447700>!---------------------------------------------------------------<a name='781'></font>
<font color=#447700>! pihtf: heterogeneous freezing of cloud water [HL A44]<a name='782'></font>
<font color=#447700>!        (T0&gt;T&gt;-40C: C-&gt;I)<a name='783'></font>
<font color=#447700>!---------------------------------------------------------------<a name='784'></font>
          if(supcol.gt.0..and.qci(i,k,1).gt.0.) then<a name='785'>
            supcolt=min(supcol,50.)<a name='786'>
<font color=#447700>!           pfrzdtc = min(pfrz1*(exp(pfrz2*supcol)-1.)                         &amp;<a name='787'></font>
<font color=#447700>!              *den(i,k,j)/denr/xncr*qci(i,k,1)**2*dtcld,qci(i,k,1))<a name='788'></font>
            pfrzdtc = min(pfrz1*(exp(pfrz2*supcolt)-1.)                        &amp;<a name='789'>
            *den(i,k,j)/denr/xncr*qci(i,k,1)*qci(i,k,1)*dtcld,qci(i,k,1))<a name='790'>
            qci(i,k,2) = qci(i,k,2) + pfrzdtc<a name='791'>
            t(i,k,j) = t(i,k,j) + xlf/cpm(i,k)*pfrzdtc<a name='792'>
            qci(i,k,1) = qci(i,k,1)-pfrzdtc<a name='793'>
          endif<a name='794'>
<font color=#447700>!---------------------------------------------------------------<a name='795'></font>
<font color=#447700>! psfrz: freezing of rain water [HL A20] [LFO 45]<a name='796'></font>
<font color=#447700>!        (T&lt;T0, R-&gt;S)<a name='797'></font>
<font color=#447700>!---------------------------------------------------------------<a name='798'></font>
          if(supcol.gt.0..and.qrs(i,k,1).gt.0.) then<a name='799'>
            supcolt=min(supcol,50.)<a name='800'>
<font color=#447700>!           pfrzdtr = min(20.*pi**2*pfrz1*n0r*denr/den(i,k,j)                    &amp;<a name='801'></font>
<font color=#447700>!                 *(exp(pfrz2*supcol)-1.)*rslope(i,k,1)**7*dtcld,              &amp;<a name='802'></font>
<font color=#447700>!                 qrs(i,k,1))<a name='803'></font>
            temp = rslope(i,k,1)<a name='804'>
            temp = temp*temp*temp*temp*temp*temp*temp<a name='805'>
            pfrzdtr = min(20.*(pi*pi)*pfrz1*n0r*denr/den(i,k,j)                  &amp;<a name='806'>
                  *(exp(pfrz2*supcolt)-1.)*temp*dtcld,                         &amp;<a name='807'>
                  qrs(i,k,1))<a name='808'>
            qrs(i,k,2) = qrs(i,k,2) + pfrzdtr<a name='809'>
            t(i,k,j) = t(i,k,j) + xlf/cpm(i,k)*pfrzdtr<a name='810'>
            qrs(i,k,1) = qrs(i,k,1)-pfrzdtr<a name='811'>
          endif<a name='812'>
      enddo<a name='813'>
<font color=#447700>!<a name='814'></font>
<font color=#447700>!----------------------------------------------------------------<a name='815'></font>
<font color=#447700>!     rsloper: reverse of the slope parameter of the rain(m)<a name='816'></font>
<font color=#447700>!     xka:    thermal conductivity of air(jm-1s-1k-1)<a name='817'></font>
<font color=#447700>!     work1:  the thermodynamic term in the denominator associated with<a name='818'></font>
<font color=#447700>!             heat conduction and vapor diffusion<a name='819'></font>
<font color=#447700>!             (ry88, y93, h85)<a name='820'></font>
<font color=#447700>!     work2: parameter associated with the ventilation effects(y93)<a name='821'></font>
<font color=#447700>!<a name='822'></font>
      do k = kts, kte<a name='823'>
          if(qrs(i,k,1).le.qcrmin)then<a name='824'>
            rslope(i,k,1) = rslopermax<a name='825'>
            rslopeb(i,k,1) = rsloperbmax<a name='826'>
            rslope2(i,k,1) = rsloper2max<a name='827'>
            rslope3(i,k,1) = rsloper3max<a name='828'>
          else<a name='829'>
<font color=#447700>!           rslope(i,k,1) = 1./lamdar(qrs(i,k,1),den(i,k,j))<a name='830'></font>
            rslope(i,k,1) = 1./(sqrt(sqrt(pidn0r/((qrs(i,k,1))*(den(i,k,j))))))<a name='831'>
            rslopeb(i,k,1) = exp(log(rslope(i,k,1))*(bvtr))<a name='832'>
            rslope2(i,k,1) = rslope(i,k,1)*rslope(i,k,1)<a name='833'>
            rslope3(i,k,1) = rslope2(i,k,1)*rslope(i,k,1)<a name='834'>
          endif<a name='835'>
          if(qrs(i,k,2).le.qcrmin)then<a name='836'>
            rslope(i,k,2) = rslopesmax<a name='837'>
            rslopeb(i,k,2) = rslopesbmax<a name='838'>
            rslope2(i,k,2) = rslopes2max<a name='839'>
            rslope3(i,k,2) = rslopes3max<a name='840'>
          else<a name='841'>
<font color=#447700>!            rslope(i,k,2) = 1./lamdas(qrs(i,k,2),den(i,k,j),n0sfac(i,k))<a name='842'></font>
            rslope(i,k,2) = 1./(sqrt(sqrt(pidn0s*(n0sfac(i,k))/((qrs(i,k,2))   &amp;  <a name='843'>
                          *(den(i,k,j))))))<a name='844'>
            rslopeb(i,k,2) = exp(log(rslope(i,k,2))*(bvts))<a name='845'>
            rslope2(i,k,2) = rslope(i,k,2)*rslope(i,k,2)<a name='846'>
            rslope3(i,k,2) = rslope2(i,k,2)*rslope(i,k,2)<a name='847'>
          endif<a name='848'>
      enddo<a name='849'>
<font color=#447700>!<a name='850'></font>
      do k = kts, kte<a name='851'>
<font color=#447700>!         work1(i,k,1) = diffac(xl(i,k),p(i,k,j),t(i,k,j),den(i,k,j),qs(i,k,1))<a name='852'></font>
          work1(i,k,1) = ((((den(i,k,j))*(xl(i,k))*(xl(i,k)))*((t(i,k,j))+120.)    &amp;<a name='853'>
                       *(den(i,k,j)))/(1.414e3*(1.496e-6*((t(i,k,j))*sqrt(t(i,k,j))))&amp;<a name='854'>
                       *(den(i,k,j))*(rv*(t(i,k,j))*(t(i,k,j)))))                    &amp;<a name='855'>
                      +  p(i,k,j)/((qs(i,k,1))*(8.794e-5*exp(log(t(i,k,j))*(1.81))))<a name='856'>
<font color=#447700>!         work1(i,k,2) = diffac(xls,p(i,k,j),t(i,k,j),den(i,k,j),qs(i,k,2))<a name='857'></font>
          work1(i,k,2) = ((((den(i,k,j))*(xls)*(xls))*((t(i,k,j))+120.)*(den(i,k,j)))&amp;<a name='858'>
                       /(1.414e3*(1.496e-6*((t(i,k,j))*sqrt(t(i,k,j))))*(den(i,k,j)) &amp;<a name='859'>
                       *(rv*(t(i,k,j))*(t(i,k,j))))                                &amp;<a name='860'>
                      + p(i,k,j)/(qs(i,k,2)*(8.794e-5*exp(log(t(i,k,j))*(1.81)))))<a name='861'>
<font color=#447700>!         work2(i,k) = venfac(p(i,k,j),t(i,k,j),den(i,k,j))<a name='862'></font>
          work2(i,k) = (exp(.3333333*log(((1.496e-6 * ((t(i,k,j))*sqrt(t(i,k,j)))) &amp;<a name='863'>
                     *p(i,k,j))/(((t(i,k,j))+120.)*den(i,k,j)*(8.794e-5              &amp;<a name='864'>
                     *exp(log(t(i,k,j))*(1.81))))))*sqrt(sqrt(den0/(den(i,k,j))))) &amp;<a name='865'>
                      /sqrt((1.496e-6*((t(i,k,j))*sqrt(t(i,k,j))))                 &amp;<a name='866'>
                      /(((t(i,k,j))+120.)*den(i,k,j)))<a name='867'>
      enddo <a name='868'>
<font color=#447700>!<a name='869'></font>
<font color=#447700>!===============================================================<a name='870'></font>
<font color=#447700>!<a name='871'></font>
<font color=#447700>! warm rain processes<a name='872'></font>
<font color=#447700>!<a name='873'></font>
<font color=#447700>! - follows the processes in RH83 and LFO except for autoconcersion<a name='874'></font>
<font color=#447700>!<a name='875'></font>
<font color=#447700>!===============================================================<a name='876'></font>
<font color=#447700>!<a name='877'></font>
      do k = kts, kte<a name='878'>
          supsat = max(q(i,k,j),qmin)-qs(i,k,1)<a name='879'>
          satdt = supsat/dtcld<a name='880'>
<font color=#447700>!---------------------------------------------------------------<a name='881'></font>
<font color=#447700>! praut: auto conversion rate from cloud to rain [HDC 16]<a name='882'></font>
<font color=#447700>!        (C-&gt;R)<a name='883'></font>
<font color=#447700>!---------------------------------------------------------------<a name='884'></font>
          if(qci(i,k,1).gt.qc0) then<a name='885'>
            praut(i,k) = qck1*exp(log(qci(i,k,1))*((7./3.)))<a name='886'>
            praut(i,k) = min(praut(i,k),qci(i,k,1)/dtcld)<a name='887'>
          endif<a name='888'>
<font color=#447700>!---------------------------------------------------------------<a name='889'></font>
<font color=#447700>! pracw: accretion of cloud water by rain [HL A40] [LFO 51]<a name='890'></font>
<font color=#447700>!        (C-&gt;R)<a name='891'></font>
<font color=#447700>!---------------------------------------------------------------<a name='892'></font>
          if(qrs(i,k,1).gt.qcrmin.and.qci(i,k,1).gt.qmin) then<a name='893'>
            pracw(i,k) = min(pacrr*rslope3(i,k,1)*rslopeb(i,k,1)               &amp; <a name='894'>
                         *qci(i,k,1)*denfac(i,k),qci(i,k,1)/dtcld)<a name='895'>
          endif<a name='896'>
<font color=#447700>!---------------------------------------------------------------<a name='897'></font>
<font color=#447700>! prevp: evaporation/condensation rate of rain [HDC 14]<a name='898'></font>
<font color=#447700>!        (V-&gt;R or R-&gt;V)<a name='899'></font>
<font color=#447700>!---------------------------------------------------------------<a name='900'></font>
          if(qrs(i,k,1).gt.0.) then<a name='901'>
            coeres = rslope2(i,k,1)*sqrt(rslope(i,k,1)*rslopeb(i,k,1))<a name='902'>
            prevp(i,k) = (rh(i,k,1)-1.)*(precr1*rslope2(i,k,1)                 &amp;<a name='903'>
                         +precr2*work2(i,k)*coeres)/work1(i,k,1)<a name='904'>
            if(prevp(i,k).lt.0.) then<a name='905'>
              prevp(i,k) = max(prevp(i,k),-qrs(i,k,1)/dtcld)<a name='906'>
              prevp(i,k) = max(prevp(i,k),satdt/2)<a name='907'>
            else<a name='908'>
              prevp(i,k) = min(prevp(i,k),satdt/2)<a name='909'>
            endif<a name='910'>
          endif<a name='911'>
      enddo<a name='912'>
<font color=#447700>!<a name='913'></font>
<font color=#447700>!===============================================================<a name='914'></font>
<font color=#447700>!<a name='915'></font>
<font color=#447700>! cold rain processes<a name='916'></font>
<font color=#447700>!<a name='917'></font>
<font color=#447700>! - follows the revised ice microphysics processes in HDC<a name='918'></font>
<font color=#447700>! - the processes same as in RH83 and RH84  and LFO behave<a name='919'></font>
<font color=#447700>!   following ice crystal hapits defined in HDC, inclduing<a name='920'></font>
<font color=#447700>!   intercept parameter for snow (n0s), ice crystal number<a name='921'></font>
<font color=#447700>!   concentration (ni), ice nuclei number concentration<a name='922'></font>
<font color=#447700>!   (n0i), ice diameter (d)<a name='923'></font>
<font color=#447700>!<a name='924'></font>
<font color=#447700>!===============================================================<a name='925'></font>
<font color=#447700>!<a name='926'></font>
      rdtcld = 1./dtcld<a name='927'>
      do k = kts, kte<a name='928'>
          supcol = t0c-t(i,k,j)<a name='929'>
          supsat = max(q(i,k,j),qmin)-qs(i,k,2)<a name='930'>
          satdt = supsat/dtcld<a name='931'>
          ifsat = 0<a name='932'>
<font color=#447700>!-------------------------------------------------------------<a name='933'></font>
<font color=#447700>! Ni: ice crystal number concentraiton   [HDC 5c]<a name='934'></font>
<font color=#447700>!-------------------------------------------------------------<a name='935'></font>
<font color=#447700>!         xni(i,k) = min(max(5.38e7*(den(i,k,j)                                  &amp;<a name='936'></font>
<font color=#447700>!                      *max(qci(i,k,2),qmin))**0.75,1.e3),1.e6)<a name='937'></font>
          temp = (den(i,k,j)*max(qci(i,k,2),qmin))<a name='938'>
          temp = sqrt(sqrt(temp*temp*temp))<a name='939'>
          xni(i,k) = min(max(5.38e7*temp,1.e3),1.e6)<a name='940'>
          eacrs = exp(0.07*(-supcol))<a name='941'>
<font color=#447700>!<a name='942'></font>
          if(supcol.gt.0) then<a name='943'>
            if(qrs(i,k,2).gt.qcrmin.and.qci(i,k,2).gt.qmin) then<a name='944'>
              xmi = den(i,k,j)*qci(i,k,2)/xni(i,k)<a name='945'>
              diameter  = min(dicon * sqrt(xmi),dimax)<a name='946'>
              vt2i = 1.49e4*diameter**1.31<a name='947'>
              vt2s = pvts*rslopeb(i,k,2)*denfac(i,k)<a name='948'>
<font color=#447700>!-------------------------------------------------------------<a name='949'></font>
<font color=#447700>! psaci: Accretion of cloud ice by rain [HDC 10]<a name='950'></font>
<font color=#447700>!        (T&lt;T0: I-&gt;S)<a name='951'></font>
<font color=#447700>!-------------------------------------------------------------<a name='952'></font>
              acrfac = 2.*rslope3(i,k,2)+2.*diameter*rslope2(i,k,2)            &amp;<a name='953'>
                      +diameter**2*rslope(i,k,2)<a name='954'>
              psaci(i,k) = pi*qci(i,k,2)*eacrs*n0s*n0sfac(i,k)                 &amp;<a name='955'>
                           *abs(vt2s-vt2i)*acrfac/4.<a name='956'>
            endif<a name='957'>
          endif<a name='958'>
<font color=#447700>!-------------------------------------------------------------<a name='959'></font>
<font color=#447700>! psacw: Accretion of cloud water by snow  [HL A7] [LFO 24]<a name='960'></font>
<font color=#447700>!        (T&lt;T0: C-&gt;S, and T&gt;=T0: C-&gt;R)<a name='961'></font>
<font color=#447700>!-------------------------------------------------------------<a name='962'></font>
          if(qrs(i,k,2).gt.qcrmin.and.qci(i,k,1).gt.qmin) then<a name='963'>
            psacw(i,k) = min(pacrc*n0sfac(i,k)*rslope3(i,k,2)                  &amp;<a name='964'>
                           *rslopeb(i,k,2)*qci(i,k,1)*denfac(i,k)              &amp;<a name='965'>
<font color=#447700>!                          ,qci(i,k,1)/dtcld)<a name='966'></font>
                           ,qci(i,k,1)*rdtcld)<a name='967'>
          endif<a name='968'>
          if(supcol .gt. 0) then<a name='969'>
<font color=#447700>!-------------------------------------------------------------<a name='970'></font>
<font color=#447700>! pidep: Deposition/Sublimation rate of ice [HDC 9]<a name='971'></font>
<font color=#447700>!       (T&lt;T0: V-&gt;I or I-&gt;V)<a name='972'></font>
<font color=#447700>!-------------------------------------------------------------<a name='973'></font>
            if(qci(i,k,2).gt.0.and.ifsat.ne.1) then<a name='974'>
              xmi = den(i,k,j)*qci(i,k,2)/xni(i,k)<a name='975'>
              diameter = dicon * sqrt(xmi)<a name='976'>
              pidep(i,k) = 4.*diameter*xni(i,k)*(rh(i,k,2)-1.)/work1(i,k,2)<a name='977'>
              supice = satdt-prevp(i,k)<a name='978'>
              if(pidep(i,k).lt.0.) then<a name='979'>
<font color=#447700>!               pidep(i,k) = max(max(pidep(i,k),satdt/2),supice)<a name='980'></font>
<font color=#447700>!               pidep(i,k) = max(pidep(i,k),-qci(i,k,2)/dtcld)<a name='981'></font>
                pidep(i,k) = max(max(pidep(i,k),satdt*.5),supice)<a name='982'>
                pidep(i,k) = max(pidep(i,k),-qci(i,k,2)*rdtcld)<a name='983'>
              else<a name='984'>
<font color=#447700>!               pidep(i,k) = min(min(pidep(i,k),satdt/2),supice)<a name='985'></font>
                pidep(i,k) = min(min(pidep(i,k),satdt*.5),supice)<a name='986'>
              endif<a name='987'>
              if(abs(prevp(i,k)+pidep(i,k)).ge.abs(satdt)) ifsat = 1<a name='988'>
            endif<a name='989'>
<font color=#447700>!-------------------------------------------------------------<a name='990'></font>
<font color=#447700>! psdep: deposition/sublimation rate of snow [HDC 14]<a name='991'></font>
<font color=#447700>!        (V-&gt;S or S-&gt;V)<a name='992'></font>
<font color=#447700>!-------------------------------------------------------------<a name='993'></font>
            if(qrs(i,k,2).gt.0..and.ifsat.ne.1) then<a name='994'>
              coeres = rslope2(i,k,2)*sqrt(rslope(i,k,2)*rslopeb(i,k,2))<a name='995'>
              psdep(i,k) = (rh(i,k,2)-1.)*n0sfac(i,k)                          &amp;<a name='996'>
                           *(precs1*rslope2(i,k,2)+precs2                      &amp;<a name='997'>
                           *work2(i,k)*coeres)/work1(i,k,2)<a name='998'>
              supice = satdt-prevp(i,k)-pidep(i,k)<a name='999'>
              if(psdep(i,k).lt.0.) then<a name='1000'>
<font color=#447700>!               psdep(i,k) = max(psdep(i,k),-qrs(i,k,2)/dtcld)<a name='1001'></font>
<font color=#447700>!               psdep(i,k) = max(max(psdep(i,k),satdt/2),supice)<a name='1002'></font>
                psdep(i,k) = max(psdep(i,k),-qrs(i,k,2)*rdtcld)<a name='1003'>
                psdep(i,k) = max(max(psdep(i,k),satdt*.5),supice)<a name='1004'>
              else<a name='1005'>
<font color=#447700>!             psdep(i,k) = min(min(psdep(i,k),satdt/2),supice)<a name='1006'></font>
                psdep(i,k) = min(min(psdep(i,k),satdt*.5),supice)<a name='1007'>
              endif<a name='1008'>
              if(abs(prevp(i,k)+pidep(i,k)+psdep(i,k)).ge.abs(satdt))          &amp;<a name='1009'>
                ifsat = 1<a name='1010'>
            endif<a name='1011'>
<font color=#447700>!-------------------------------------------------------------<a name='1012'></font>
<font color=#447700>! pigen: generation(nucleation) of ice from vapor [HL A50] [HDC 7-8]<a name='1013'></font>
<font color=#447700>!       (T&lt;T0: V-&gt;I)<a name='1014'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1015'></font>
            if(supsat.gt.0.and.ifsat.ne.1) then<a name='1016'>
              supice = satdt-prevp(i,k)-pidep(i,k)-psdep(i,k)<a name='1017'>
              xni0 = 1.e3*exp(0.1*supcol)<a name='1018'>
              roqi0 = 4.92e-11*exp(log(xni0)*(1.33))<a name='1019'>
              pigen(i,k) = max(0.,(roqi0/den(i,k,j)-max(qci(i,k,2),0.))          &amp;<a name='1020'>
<font color=#447700>!                        /dtcld)<a name='1021'></font>
                         *rdtcld)<a name='1022'>
              pigen(i,k) = min(min(pigen(i,k),satdt),supice)<a name='1023'>
            endif<a name='1024'>
<font color=#447700>!<a name='1025'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1026'></font>
<font color=#447700>! psaut: conversion(aggregation) of ice to snow [HDC 12]<a name='1027'></font>
<font color=#447700>!       (T&lt;T0: I-&gt;S)<a name='1028'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1029'></font>
            if(qci(i,k,2).gt.0.) then<a name='1030'>
              qimax = roqimax/den(i,k,j)<a name='1031'>
<font color=#447700>!             psaut(i,k) = max(0.,(qci(i,k,2)-qimax)/dtcld)<a name='1032'></font>
              psaut(i,k) = max(0.,(qci(i,k,2)-qimax)*rdtcld)<a name='1033'>
            endif<a name='1034'>
          endif<a name='1035'>
<font color=#447700>!-------------------------------------------------------------<a name='1036'></font>
<font color=#447700>! psevp: Evaporation of melting snow [HL A35] [RH83 A27]<a name='1037'></font>
<font color=#447700>!       (T&gt;T0: S-&gt;V)<a name='1038'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1039'></font>
          if(supcol.lt.0.) then<a name='1040'>
            if(qrs(i,k,2).gt.0..and.rh(i,k,1).lt.1.)                           &amp;<a name='1041'>
              psevp(i,k) = psdep(i,k)*work1(i,k,2)/work1(i,k,1)<a name='1042'>
<font color=#447700>!              psevp(i,k) = min(max(psevp(i,k),-qrs(i,k,2)/dtcld),0.)<a name='1043'></font>
              psevp(i,k) = min(max(psevp(i,k),-qrs(i,k,2)*rdtcld),0.)<a name='1044'>
          endif<a name='1045'>
      enddo<a name='1046'>
<font color=#447700>!<a name='1047'></font>
<font color=#447700>!<a name='1048'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1049'></font>
<font color=#447700>!     check mass conservation of generation terms and feedback to the<a name='1050'></font>
<font color=#447700>!     large scale<a name='1051'></font>
<font color=#447700>!<a name='1052'></font>
      do k = kts, kte<a name='1053'>
          if(t(i,k,j).le.t0c) then<a name='1054'>
<font color=#447700>!<a name='1055'></font>
<font color=#447700>!     cloud water<a name='1056'></font>
<font color=#447700>!<a name='1057'></font>
            value = max(qmin,qci(i,k,1))<a name='1058'>
            source = (praut(i,k)+pracw(i,k)+psacw(i,k))*dtcld<a name='1059'>
            if (source.gt.value) then<a name='1060'>
              factor = value/source<a name='1061'>
              praut(i,k) = praut(i,k)*factor<a name='1062'>
              pracw(i,k) = pracw(i,k)*factor<a name='1063'>
              psacw(i,k) = psacw(i,k)*factor<a name='1064'>
            endif<a name='1065'>
<font color=#447700>!<a name='1066'></font>
<font color=#447700>!     cloud ice<a name='1067'></font>
<font color=#447700>!<a name='1068'></font>
            value = max(qmin,qci(i,k,2))<a name='1069'>
            source = (psaut(i,k)+psaci(i,k)-pigen(i,k)-pidep(i,k))*dtcld<a name='1070'>
            if (source.gt.value) then<a name='1071'>
              factor = value/source<a name='1072'>
              psaut(i,k) = psaut(i,k)*factor<a name='1073'>
              psaci(i,k) = psaci(i,k)*factor<a name='1074'>
              pigen(i,k) = pigen(i,k)*factor<a name='1075'>
              pidep(i,k) = pidep(i,k)*factor<a name='1076'>
            endif<a name='1077'>
<font color=#447700>!<a name='1078'></font>
<font color=#447700>!     rain<a name='1079'></font>
<font color=#447700>!<a name='1080'></font>
<font color=#447700>!<a name='1081'></font>
            value = max(qmin,qrs(i,k,1))<a name='1082'>
            source = (-praut(i,k)-pracw(i,k)-prevp(i,k))*dtcld<a name='1083'>
            if (source.gt.value) then<a name='1084'>
              factor = value/source<a name='1085'>
              praut(i,k) = praut(i,k)*factor<a name='1086'>
              pracw(i,k) = pracw(i,k)*factor<a name='1087'>
              prevp(i,k) = prevp(i,k)*factor<a name='1088'>
            endif<a name='1089'>
<font color=#447700>!<a name='1090'></font>
<font color=#447700>!    snow<a name='1091'></font>
<font color=#447700>!<a name='1092'></font>
            value = max(qmin,qrs(i,k,2))<a name='1093'>
            source = (-psdep(i,k)-psaut(i,k)-psaci(i,k)-psacw(i,k))*dtcld  <a name='1094'>
            if (source.gt.value) then<a name='1095'>
              factor = value/source<a name='1096'>
              psdep(i,k) = psdep(i,k)*factor<a name='1097'>
              psaut(i,k) = psaut(i,k)*factor<a name='1098'>
              psaci(i,k) = psaci(i,k)*factor<a name='1099'>
              psacw(i,k) = psacw(i,k)*factor<a name='1100'>
            endif<a name='1101'>
<font color=#447700>!<a name='1102'></font>
            work2(i,k)=-(prevp(i,k)+psdep(i,k)+pigen(i,k)+pidep(i,k))<a name='1103'>
<font color=#447700>!     update<a name='1104'></font>
            q(i,k,j) = q(i,k,j)+work2(i,k)*dtcld<a name='1105'>
            qci(i,k,1) = max(qci(i,k,1)-(praut(i,k)+pracw(i,k)                 &amp;<a name='1106'>
                        +psacw(i,k))*dtcld,0.)<a name='1107'>
            qrs(i,k,1) = max(qrs(i,k,1)+(praut(i,k)+pracw(i,k)                 &amp;<a name='1108'>
                        +prevp(i,k))*dtcld,0.)<a name='1109'>
            qci(i,k,2) = max(qci(i,k,2)-(psaut(i,k)+psaci(i,k)                 &amp;<a name='1110'>
                        -pigen(i,k)-pidep(i,k))*dtcld,0.)<a name='1111'>
            qrs(i,k,2) = max(qrs(i,k,2)+(psdep(i,k)+psaut(i,k)                 &amp;<a name='1112'>
                        +psaci(i,k)+psacw(i,k))*dtcld,0.)<a name='1113'>
            xlf = xls-xl(i,k)<a name='1114'>
            xlwork2 = -xls*(psdep(i,k)+pidep(i,k)+pigen(i,k))                  &amp;<a name='1115'>
                      -xl(i,k)*prevp(i,k)-xlf*psacw(i,k)<a name='1116'>
            t(i,k,j) = t(i,k,j)-xlwork2/cpm(i,k)*dtcld<a name='1117'>
          else<a name='1118'>
<font color=#447700>!<a name='1119'></font>
<font color=#447700>!     cloud water<a name='1120'></font>
<font color=#447700>!<a name='1121'></font>
            value = max(qmin,qci(i,k,1))<a name='1122'>
            source=(praut(i,k)+pracw(i,k)+psacw(i,k))*dtcld<a name='1123'>
            if (source.gt.value) then<a name='1124'>
              factor = value/source<a name='1125'>
              praut(i,k) = praut(i,k)*factor<a name='1126'>
              pracw(i,k) = pracw(i,k)*factor<a name='1127'>
              psacw(i,k) = psacw(i,k)*factor<a name='1128'>
            endif<a name='1129'>
<font color=#447700>!<a name='1130'></font>
<font color=#447700>!     rain<a name='1131'></font>
<font color=#447700>!<a name='1132'></font>
            value = max(qmin,qrs(i,k,1))<a name='1133'>
            source = (-praut(i,k)-pracw(i,k)-prevp(i,k)-psacw(i,k))*dtcld<a name='1134'>
            if (source.gt.value) then<a name='1135'>
              factor = value/source<a name='1136'>
              praut(i,k) = praut(i,k)*factor<a name='1137'>
              pracw(i,k) = pracw(i,k)*factor<a name='1138'>
              prevp(i,k) = prevp(i,k)*factor<a name='1139'>
              psacw(i,k) = psacw(i,k)*factor<a name='1140'>
            endif  <a name='1141'>
<font color=#447700>!<a name='1142'></font>
<font color=#447700>!     snow<a name='1143'></font>
<font color=#447700>!<a name='1144'></font>
            value = max(qcrmin,qrs(i,k,2))<a name='1145'>
            source=(-psevp(i,k))*dtcld<a name='1146'>
            if (source.gt.value) then<a name='1147'>
              factor = value/source<a name='1148'>
              psevp(i,k) = psevp(i,k)*factor<a name='1149'>
            endif<a name='1150'>
            work2(i,k)=-(prevp(i,k)+psevp(i,k))<a name='1151'>
<font color=#447700>!     update<a name='1152'></font>
            q(i,k,j) = q(i,k,j)+work2(i,k)*dtcld<a name='1153'>
            qci(i,k,1) = max(qci(i,k,1)-(praut(i,k)+pracw(i,k)                 &amp;<a name='1154'>
                        +psacw(i,k))*dtcld,0.)<a name='1155'>
            qrs(i,k,1) = max(qrs(i,k,1)+(praut(i,k)+pracw(i,k)                 &amp;<a name='1156'>
                        +prevp(i,k) +psacw(i,k))*dtcld,0.)<a name='1157'>
            qrs(i,k,2) = max(qrs(i,k,2)+psevp(i,k)*dtcld,0.)<a name='1158'>
            xlf = xls-xl(i,k)<a name='1159'>
            xlwork2 = -xl(i,k)*(prevp(i,k)+psevp(i,k))<a name='1160'>
            t(i,k,j) = t(i,k,j)-xlwork2/cpm(i,k)*dtcld<a name='1161'>
          endif<a name='1162'>
      enddo<a name='1163'>
<font color=#447700>!<a name='1164'></font>
<font color=#447700>! Inline expansion for fpvs<a name='1165'></font>
<font color=#447700>!         qs(i,k,1) = fpvs(t(i,k,j),0,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='1166'></font>
<font color=#447700>!         qs(i,k,2) = fpvs(t(i,k,j),1,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='1167'></font>
      hsub = xls<a name='1168'>
      hvap = xlv0<a name='1169'>
      cvap = cpv<a name='1170'>
      ttp=t0c+0.01<a name='1171'>
      dldt=cvap-cliq<a name='1172'>
      xa=-dldt/rv<a name='1173'>
      xb=xa+hvap/(rv*ttp)<a name='1174'>
      dldti=cvap-cice<a name='1175'>
      xai=-dldti/rv<a name='1176'>
      xbi=xai+hsub/(rv*ttp)<a name='1177'>
      do k = kts, kte<a name='1178'>
          tr=ttp/t(i,k,j)<a name='1179'>
          logtr = log(tr)<a name='1180'>
          qs(i,k,1)=psat*exp(logtr*(xa)+xb*(1.-tr))<a name='1181'>
          qs(i,k,1) = ep2 * qs(i,k,1) / (p(i,k,j) - qs(i,k,1))<a name='1182'>
          qs(i,k,1) = max(qs(i,k,1),qmin)<a name='1183'>
      enddo<a name='1184'>
<font color=#447700>!<a name='1185'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1186'></font>
<font color=#447700>!  pcond: condensational/evaporational rate of cloud water [HL A46] [RH83 A6]<a name='1187'></font>
<font color=#447700>!     if there exists additional water vapor condensated/if<a name='1188'></font>
<font color=#447700>!     evaporation of cloud water is not enough to remove subsaturation<a name='1189'></font>
<font color=#447700>!<a name='1190'></font>
      do k = kts, kte<a name='1191'>
<font color=#447700>!         work1(i,k,1) = conden(t(i,k,j),q(i,k,j),qs(i,k,1),xl(i,k),cpm(i,k))<a name='1192'></font>
          work1(i,k,1) = ((max(q(i,k,j),qmin)-(qs(i,k,1)))/(1.+(xl(i,k))         &amp;   <a name='1193'>
                        *(xl(i,k))/(rv*(cpm(i,k)))*(qs(i,k,1))                 &amp;<a name='1194'>
                        /((t(i,k,j))*(t(i,k,j)))))<a name='1195'>
          work2(i,k) = qci(i,k,1)+work1(i,k,1)<a name='1196'>
          pcond(i,k) = min(max(work1(i,k,1)/dtcld,0.),max(q(i,k,j),0.)/dtcld)<a name='1197'>
          if(qci(i,k,1).gt.0..and.work1(i,k,1).lt.0.)                          &amp;<a name='1198'>
            pcond(i,k) = max(work1(i,k,1),-qci(i,k,1))/dtcld<a name='1199'>
          q(i,k,j) = q(i,k,j)-pcond(i,k)*dtcld<a name='1200'>
          qci(i,k,1) = max(qci(i,k,1)+pcond(i,k)*dtcld,0.)<a name='1201'>
          t(i,k,j) = t(i,k,j)+pcond(i,k)*xl(i,k)/cpm(i,k)*dtcld<a name='1202'>
      enddo<a name='1203'>
<font color=#447700>!<a name='1204'></font>
<font color=#447700>!<a name='1205'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1206'></font>
<font color=#447700>!     padding for small values<a name='1207'></font>
<font color=#447700>!<a name='1208'></font>
      do k = kts, kte<a name='1209'>
          if(qci(i,k,1).le.qmin) qci(i,k,1) = 0.0<a name='1210'>
          if(qci(i,k,2).le.qmin) qci(i,k,2) = 0.0<a name='1211'>
      enddo<a name='1212'>
      enddo                  <font color=#447700>! big loops<a name='1213'></font>
<a name='1214'>
         DO K=kts,kte<a name='1215'>
            th(i,k,j)=t(i,k,j)/pii(i,k,j)<a name='1216'>
            qc(i,k,j) = qci(i,k,1)<a name='1217'>
            qi(i,k,j) = qci(i,k,2)<a name='1218'>
            qr(i,k,j) = qrs(i,k,1)<a name='1219'>
            qqs(i,k,j) = qrs(i,k,2)<a name='1220'>
         ENDDO<a name='1221'>
<a name='1222'>
<a name='1223'>
<a name='1224'>
      ENDDO     <font color=#447700>!  i loop<a name='1225'></font>
      enddo     <font color=#447700>!  j loop<a name='1226'></font>
<font color=#447700>!$acc end region<a name='1227'></font>
<a name='1228'>
    ELSE<a name='1229'>
<a name='1230'>
<font color=#447700>!<a name='1231'></font>
<font color=#447700>! Moved outside of accelerator region<a name='1232'></font>
<font color=#447700>!<a name='1233'></font>
      loops = max(nint(delt/dtcldcr),1)<a name='1234'>
      dtcld = delt/loops<a name='1235'>
      if(delt.le.dtcldcr) dtcld = delt<a name='1236'>
<a name='1237'>
<font color=#447700>!$acc region &amp;<a name='1238'></font>
<font color=#447700>!$acc        local(t) &amp;<a name='1239'></font>
<font color=#447700>!$acc        copyin(delz(:,:,:),p(:,:,:),den(:,:,:),pii(:,:,:)) &amp;<a name='1240'></font>
<font color=#447700>!$acc        copyout(rainncv(:,:),sr(:,:)) &amp;<a name='1241'></font>
<font color=#447700>!$acc        copy(qqs(:,:,:),qr(:,:,:),qi(:,:,:),qc(:,:,:)) &amp;<a name='1242'></font>
<font color=#447700>!$acc        copy(th(:,:,:),q(:,:,:),rain(:,:))<a name='1243'></font>
<font color=#447700>!$acc do &amp;<a name='1244'></font>
<font color=#447700>!$acc        private(rh,qs,rslope,rslope2,rslope3,rslopeb,falk,fall) &amp;<a name='1245'></font>
<font color=#447700>!$acc        private(work1,qci,qrs,falkc,fallc,xl,cpm,denfac,xni) &amp;<a name='1246'></font>
<font color=#447700>!$acc        private(n0sfac,work2,work1c,work2c,pigen,pidep,psdep) &amp;<a name='1247'></font>
<font color=#447700>!$acc        private(praut,psaut,prevp,psevp) &amp;<a name='1248'></font>
<font color=#447700>!$acc        private(pracw,psacw,psaci,pcond,psmlt) &amp;<a name='1249'></font>
<font color=#447700>!$acc        parallel<a name='1250'></font>
      do j = jts, jte<a name='1251'>
<font color=#447700>!$acc do &amp;<a name='1252'></font>
<font color=#447700>!$acc        private(numdt,mstep) &amp;<a name='1253'></font>
<font color=#447700>!$acc        kernel vector<a name='1254'></font>
        do i = its, ite<a name='1255'>
        do k = kts, kte<a name='1256'>
          t(i,k,j)=th(i,k,j)*pii(i,k,j)<a name='1257'>
          qci(i,k,1) = max(qc(i,k,j),0.0)<a name='1258'>
          qci(i,k,2) = max(qi(i,k,j),0.0)<a name='1259'>
          qrs(i,k,1) = max(qr(i,k,j),0.0)<a name='1260'>
          qrs(i,k,2) = max(qqs(i,k,j),0.0)<a name='1261'>
        enddo<a name='1262'>
<font color=#447700>!<a name='1263'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1264'></font>
<font color=#447700>!     latent heat for phase changes and heat capacity. neglect the<a name='1265'></font>
<font color=#447700>!     changes during microphysical process calculation<a name='1266'></font>
<font color=#447700>!     emanuel(1994)<a name='1267'></font>
<font color=#447700>!<a name='1268'></font>
      do k = kts, kte<a name='1269'>
          cpm(i,k) = cpmcal(q(i,k,j))<a name='1270'>
          xl(i,k) = xlcal(t(i,k,j))<a name='1271'>
      enddo<a name='1272'>
<font color=#447700>!<a name='1273'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1274'></font>
<font color=#447700>!     compute the minor time steps.<a name='1275'></font>
<font color=#447700>!<a name='1276'></font>
<font color=#447700>!     loops = max(nint(delt/dtcldcr),1)<a name='1277'></font>
<font color=#447700>!     dtcld = delt/loops<a name='1278'></font>
<font color=#447700>!     if(delt.le.dtcldcr) dtcld = delt<a name='1279'></font>
<font color=#447700>!<a name='1280'></font>
      do loop = 1,loops<a name='1281'>
<font color=#447700>!<a name='1282'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1283'></font>
<font color=#447700>!     initialize the large scale variables<a name='1284'></font>
<font color=#447700>!<a name='1285'></font>
        mstep = 1<a name='1286'>
        flgcld = .true.<a name='1287'>
<font color=#447700>!<a name='1288'></font>
      do k = kts, kte<a name='1289'>
          denfac(i,k) = sqrt(den0/den(i,k,j))<a name='1290'>
      enddo<a name='1291'>
<font color=#447700>!     do k = kts, kte<a name='1292'></font>
<font color=#447700>!       CALL VREC( tvec1(its), den(its,k,j), ite-its+1)<a name='1293'></font>
<font color=#447700>!       do i = its, ite<a name='1294'></font>
<font color=#447700>!         tvec1(i) = tvec1(i)*den0<a name='1295'></font>
<font color=#447700>!       enddo<a name='1296'></font>
<font color=#447700>!       CALL VSQRT( denfac(its,k), tvec1(its), ite-its+1)<a name='1297'></font>
<font color=#447700>!     enddo<a name='1298'></font>
<font color=#447700>!<a name='1299'></font>
<font color=#447700>! Inline expansion for fpvs<a name='1300'></font>
<font color=#447700>!         qs(i,k,1) = fpvs(t(i,k,j),0,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='1301'></font>
<font color=#447700>!         qs(i,k,2) = fpvs(t(i,k,j),1,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='1302'></font>
      hsub = xls<a name='1303'>
      hvap = xlv0<a name='1304'>
      cvap = cpv<a name='1305'>
      ttp=t0c+0.01<a name='1306'>
      dldt=cvap-cliq<a name='1307'>
      xa=-dldt/rv<a name='1308'>
      xb=xa+hvap/(rv*ttp)<a name='1309'>
      dldti=cvap-cice<a name='1310'>
      xai=-dldti/rv<a name='1311'>
      xbi=xai+hsub/(rv*ttp)<a name='1312'>
<a name='1313'>
<font color=#447700>! this is for compilers where the conditional inhibits vectorization<a name='1314'></font>
#ifdef WSM_NO_CONDITIONAL_IN_VECTOR<a name='1315'>
      do k = kts, kte<a name='1316'>
          if(t(i,k,j).lt.ttp) then<a name='1317'>
            xal = xai<a name='1318'>
            xbl = xbi<a name='1319'>
          else<a name='1320'>
            xal = xa<a name='1321'>
            xbl = xb<a name='1322'>
          endif<a name='1323'>
          tr=ttp/t(i,k,j)<a name='1324'>
          logtr=log(tr)<a name='1325'>
          qs(i,k,1)=psat*exp(logtr*(xa)+xb*(1.-tr))<a name='1326'>
          qs(i,k,1) = ep2 * qs(i,k,1) / (p(i,k,j) - qs(i,k,1))<a name='1327'>
          qs(i,k,1) = max(qs(i,k,1),qmin)<a name='1328'>
          rh(i,k,1) = max(q(i,k,j) / qs(i,k,1),qmin)<a name='1329'>
          qs(i,k,2)=psat*exp(logtr*(xal)+xbl*(1.-tr))<a name='1330'>
          qs(i,k,2) = ep2 * qs(i,k,2) / (p(i,k,j) - qs(i,k,2))<a name='1331'>
          qs(i,k,2) = max(qs(i,k,2),qmin)<a name='1332'>
          rh(i,k,2) = max(q(i,k,j) / qs(i,k,2),qmin)<a name='1333'>
      enddo<a name='1334'>
#else<a name='1335'>
      do k = kts, kte<a name='1336'>
          tr=ttp/t(i,k,j)<a name='1337'>
          logtr=log(tr)<a name='1338'>
          qs(i,k,1)=psat*exp(logtr*(xa)+xb*(1.-tr))<a name='1339'>
          qs(i,k,1) = ep2 * qs(i,k,1) / (p(i,k,j) - qs(i,k,1))<a name='1340'>
          qs(i,k,1) = max(qs(i,k,1),qmin)<a name='1341'>
          rh(i,k,1) = max(q(i,k,j) / qs(i,k,1),qmin)<a name='1342'>
          if(t(i,k,j).lt.ttp) then<a name='1343'>
            qs(i,k,2)=psat*exp(logtr*(xai)+xbi*(1.-tr))<a name='1344'>
          else<a name='1345'>
            qs(i,k,2)=psat*exp(logtr*(xa)+xb*(1.-tr))<a name='1346'>
          endif<a name='1347'>
          qs(i,k,2) = ep2 * qs(i,k,2) / (p(i,k,j) - qs(i,k,2))<a name='1348'>
          qs(i,k,2) = max(qs(i,k,2),qmin)<a name='1349'>
          rh(i,k,2) = max(q(i,k,j) / qs(i,k,2),qmin)<a name='1350'>
      enddo<a name='1351'>
#endif<a name='1352'>
<font color=#447700>!<a name='1353'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1354'></font>
<font color=#447700>!     initialize the variables for microphysical physics<a name='1355'></font>
<font color=#447700>!<a name='1356'></font>
<font color=#447700>!<a name='1357'></font>
      do k = kts, kte<a name='1358'>
          prevp(i,k) = 0.<a name='1359'>
          psdep(i,k) = 0.<a name='1360'>
          praut(i,k) = 0.<a name='1361'>
          psaut(i,k) = 0.<a name='1362'>
          pracw(i,k) = 0.<a name='1363'>
          psaci(i,k) = 0.<a name='1364'>
          psacw(i,k) = 0.<a name='1365'>
          pigen(i,k) = 0.<a name='1366'>
          pidep(i,k) = 0.<a name='1367'>
          pcond(i,k) = 0.<a name='1368'>
          psmlt(i,k) = 0.<a name='1369'>
          psevp(i,k) = 0.<a name='1370'>
          falk(i,k,1) = 0.<a name='1371'>
          falk(i,k,2) = 0.<a name='1372'>
          fall(i,k,1) = 0.<a name='1373'>
          fall(i,k,2) = 0.<a name='1374'>
          fallc(i,k) = 0.<a name='1375'>
          falkc(i,k) = 0.<a name='1376'>
          xni(i,k) = 1.e3<a name='1377'>
      enddo<a name='1378'>
<font color=#447700>!<a name='1379'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1380'></font>
<font color=#447700>!     compute the fallout term:<a name='1381'></font>
<font color=#447700>!     first, vertical terminal velosity for minor loops<a name='1382'></font>
<font color=#447700>!<a name='1383'></font>
      do k = kts, kte<a name='1384'>
          supcol = t0c-t(i,k,j)<a name='1385'>
<font color=#447700>!---------------------------------------------------------------<a name='1386'></font>
<font color=#447700>! n0s: Intercept parameter for snow [m-4] [HDC 6]<a name='1387'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1388'></font>
          n0sfac(i,k) = max(min(exp(alpha*supcol),n0smax/n0s),1.)<a name='1389'>
          if(qrs(i,k,1).le.qcrmin)then<a name='1390'>
            rslope(i,k,1) = rslopermax<a name='1391'>
            rslopeb(i,k,1) = rsloperbmax<a name='1392'>
            rslope2(i,k,1) = rsloper2max<a name='1393'>
            rslope3(i,k,1) = rsloper3max<a name='1394'>
          else<a name='1395'>
            rslope(i,k,1) = 1./lamdar(qrs(i,k,1),den(i,k,j))<a name='1396'>
            rslopeb(i,k,1) = exp(log(rslope(i,k,1))*(bvtr))<a name='1397'>
            rslope2(i,k,1) = rslope(i,k,1)*rslope(i,k,1)<a name='1398'>
            rslope3(i,k,1) = rslope2(i,k,1)*rslope(i,k,1)<a name='1399'>
          endif<a name='1400'>
          if(qrs(i,k,2).le.qcrmin)then<a name='1401'>
            rslope(i,k,2) = rslopesmax<a name='1402'>
            rslopeb(i,k,2) = rslopesbmax<a name='1403'>
            rslope2(i,k,2) = rslopes2max<a name='1404'>
            rslope3(i,k,2) = rslopes3max<a name='1405'>
          else<a name='1406'>
            rslope(i,k,2) = 1./lamdas(qrs(i,k,2),den(i,k,j),n0sfac(i,k))<a name='1407'>
            rslopeb(i,k,2) = exp(log(rslope(i,k,2))*(bvts))<a name='1408'>
            rslope2(i,k,2) = rslope(i,k,2)*rslope(i,k,2)<a name='1409'>
            rslope3(i,k,2) = rslope2(i,k,2)*rslope(i,k,2)<a name='1410'>
          endif<a name='1411'>
<font color=#447700>!-------------------------------------------------------------<a name='1412'></font>
<font color=#447700>! Ni: ice crystal number concentraiton   [HDC 5c]<a name='1413'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1414'></font>
<font color=#447700>!         xni(i,k) = min(max(5.38e7*(den(i,k,j)                                  &amp;<a name='1415'></font>
<font color=#447700>!                   *max(qci(i,k,2),qmin))**0.75,1.e3),1.e6)<a name='1416'></font>
          temp = (den(i,k,j)*max(qci(i,k,2),qmin))<a name='1417'>
          temp = sqrt(sqrt(temp*temp*temp))<a name='1418'>
          xni(i,k) = min(max(5.38e7*temp,1.e3),1.e6)<a name='1419'>
      enddo<a name='1420'>
<font color=#447700>!<a name='1421'></font>
      numdt = 1<a name='1422'>
      do k = kte, kts, -1<a name='1423'>
          work1(i,k,1) = pvtr*rslopeb(i,k,1)*denfac(i,k)/delz(i,k,j)<a name='1424'>
          work1(i,k,2) = pvts*rslopeb(i,k,2)*denfac(i,k)/delz(i,k,j)<a name='1425'>
          numdt = max(nint(max(work1(i,k,1),work1(i,k,2))*dtcld+.5),1)<a name='1426'>
          if(numdt.ge.mstep) mstep = numdt<a name='1427'>
      enddo<a name='1428'>
        rmstep = 1./mstep<a name='1429'>
<font color=#447700>!<a name='1430'></font>
      do n = 1, mstep<a name='1431'>
        k = kte<a name='1432'>
<font color=#447700>!             falk(i,k,1) = den(i,k,j)*qrs(i,k,1)*work1(i,k,1)/mstep(i)<a name='1433'></font>
<font color=#447700>!             falk(i,k,2) = den(i,k,j)*qrs(i,k,2)*work1(i,k,2)/mstep(i)<a name='1434'></font>
              falk(i,k,1) = den(i,k,j)*qrs(i,k,1)*work1(i,k,1)*rmstep<a name='1435'>
              falk(i,k,2) = den(i,k,j)*qrs(i,k,2)*work1(i,k,2)*rmstep<a name='1436'>
              fall(i,k,1) = fall(i,k,1)+falk(i,k,1)<a name='1437'>
              fall(i,k,2) = fall(i,k,2)+falk(i,k,2)<a name='1438'>
<font color=#447700>!             qrs(i,k,1) = max(qrs(i,k,1)-falk(i,k,1)*dtcld/den(i,k,j),0.)<a name='1439'></font>
<font color=#447700>!             qrs(i,k,2) = max(qrs(i,k,2)-falk(i,k,2)*dtcld/den(i,k,j),0.)<a name='1440'></font>
              dtcldden = dtcld/den(i,k,j)<a name='1441'>
              qrs(i,k,1) = max(qrs(i,k,1)-falk(i,k,1)*dtcldden,0.)<a name='1442'>
              qrs(i,k,2) = max(qrs(i,k,2)-falk(i,k,2)*dtcldden,0.)<a name='1443'>
<font color=#447700>!           endif<a name='1444'></font>
        do k = kte-1, kts, -1<a name='1445'>
              falk(i,k,1) = den(i,k,j)*qrs(i,k,1)*work1(i,k,1)*rmstep<a name='1446'>
              falk(i,k,2) = den(i,k,j)*qrs(i,k,2)*work1(i,k,2)*rmstep<a name='1447'>
              fall(i,k,1) = fall(i,k,1)+falk(i,k,1)<a name='1448'>
              fall(i,k,2) = fall(i,k,2)+falk(i,k,2)<a name='1449'>
              dtcldden = dtcld/den(i,k,j)<a name='1450'>
              rdelz = 1./delz(i,k,j)<a name='1451'>
              qrs(i,k,1) = max(qrs(i,k,1)-(falk(i,k,1)-falk(i,k+1,1)           &amp;<a name='1452'>
                          *delz(i,k+1,j)*rdelz)*dtcldden,0.)<a name='1453'>
              qrs(i,k,2) = max(qrs(i,k,2)-(falk(i,k,2)-falk(i,k+1,2)           &amp;<a name='1454'>
                          *delz(i,k+1,j)*rdelz)*dtcldden,0.)<a name='1455'>
        enddo<a name='1456'>
        do k = kte, kts, -1<a name='1457'>
              if(t(i,k,j).gt.t0c.and.qrs(i,k,2).gt.0.) then<a name='1458'>
<font color=#447700>!----------------------------------------------------------------<a name='1459'></font>
<font color=#447700>! psmlt: melting of snow [HL A33] [RH83 A25]<a name='1460'></font>
<font color=#447700>!       (T&gt;T0: S-&gt;R)<a name='1461'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1462'></font>
                xlf = xlf0<a name='1463'>
<font color=#447700>!               work2(i,k)= venfac(p(i,k),t(i,k,j),den(i,k,j))<a name='1464'></font>
                work2(i,k)= (exp(log(((1.496e-6*((t(i,k,j))*sqrt(t(i,k,j)))        &amp;<a name='1465'>
                            /((t(i,k,j))+120.)/(den(i,k,j)))/(8.794e-5             &amp;<a name='1466'>
                            *exp(log(t(i,k,j))*(1.81))/p(i,k,j))))                 &amp;<a name='1467'>
                            *((.3333333)))/sqrt((1.496e-6*((t(i,k,j))            &amp;<a name='1468'>
                            *sqrt(t(i,k,j)))/((t(i,k,j))+120.)/(den(i,k,j))))        &amp;<a name='1469'>
                            *sqrt(sqrt(den0/(den(i,k,j)))))<a name='1470'>
                coeres = rslope2(i,k,2)*sqrt(rslope(i,k,2)*rslopeb(i,k,2))<a name='1471'>
<font color=#447700>!               psmlt(i,k) = xka(t(i,k,j),den(i,k,j))/xlf*(t0c-t(i,k,j))*pi/2.       &amp;<a name='1472'></font>
<font color=#447700>!                           *n0sfac(i,k)*(precs1*rslope2(i,k,2)+precs2         &amp;<a name='1473'></font>
<font color=#447700>!                           *work2(i,k)*coeres)<a name='1474'></font>
                psmlt(i,k) = (1.414e3*(1.496e-6*((t(i,k,j))*sqrt(t(i,k,j)))        &amp;         <a name='1475'>
                            /((t(i,k,j))+120.)/(den(i,k,j)) )*(den(i,k,j)))          &amp;<a name='1476'>
                            /xlf*(t0c-t(i,k,j))*pi/2.                            &amp;<a name='1477'>
                            *n0sfac(i,k)*(precs1*rslope2(i,k,2)+precs2         &amp;<a name='1478'>
                            *work2(i,k)*coeres)<a name='1479'>
                psmlt(i,k) = min(max(psmlt(i,k)*dtcld/mstep,                &amp;<a name='1480'>
                            -qrs(i,k,2)/mstep),0.)<a name='1481'>
                qrs(i,k,2) = qrs(i,k,2) + psmlt(i,k)<a name='1482'>
                qrs(i,k,1) = qrs(i,k,1) - psmlt(i,k)<a name='1483'>
                t(i,k,j) = t(i,k,j) + xlf/cpm(i,k)*psmlt(i,k)<a name='1484'>
              endif<a name='1485'>
        enddo<a name='1486'>
      enddo<a name='1487'>
<font color=#447700>!---------------------------------------------------------------<a name='1488'></font>
<font color=#447700>! Vice [ms-1] : fallout of ice crystal [HDC 5a]<a name='1489'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1490'></font>
      mstep = 1<a name='1491'>
      numdt = 1<a name='1492'>
      do k = kte, kts, -1<a name='1493'>
          if(qci(i,k,2).le.0.) then<a name='1494'>
            work2c(i,k) = 0.<a name='1495'>
          else<a name='1496'>
            xmi = den(i,k,j)*qci(i,k,2)/xni(i,k)<a name='1497'>
<font color=#447700>!           diameter  = min(dicon * sqrt(xmi),dimax)<a name='1498'></font>
            diameter  = max(min(dicon * sqrt(xmi),dimax), 1.e-25)<a name='1499'>
            work1c(i,k) = 1.49e4*exp(log(diameter)*(1.31))<a name='1500'>
            work2c(i,k) = work1c(i,k)/delz(i,k,j)<a name='1501'>
          endif<a name='1502'>
          numdt = max(nint(work2c(i,k)*dtcld+.5),1)<a name='1503'>
          if(numdt.ge.mstep) mstep = numdt<a name='1504'>
      enddo<a name='1505'>
<font color=#447700>!<a name='1506'></font>
      do n = 1, mstep<a name='1507'>
        k = kte<a name='1508'>
            falkc(i,k) = den(i,k,j)*qci(i,k,2)*work2c(i,k)/mstep<a name='1509'>
            holdc = falkc(i,k)<a name='1510'>
            fallc(i,k) = fallc(i,k)+falkc(i,k)<a name='1511'>
            holdci = qci(i,k,2)<a name='1512'>
            qci(i,k,2) = max(qci(i,k,2)-falkc(i,k)*dtcld/den(i,k,j),0.)<a name='1513'>
        do k = kte-1, kts, -1<a name='1514'>
              falkc(i,k) = den(i,k,j)*qci(i,k,2)*work2c(i,k)/mstep<a name='1515'>
              holdc = falkc(i,k)<a name='1516'>
              fallc(i,k) = fallc(i,k)+falkc(i,k)<a name='1517'>
              holdci = qci(i,k,2)<a name='1518'>
              qci(i,k,2) = max(qci(i,k,2)-(falkc(i,k)-falkc(i,k+1)             &amp;<a name='1519'>
                          *delz(i,k+1,j)/delz(i,k,j))*dtcld/den(i,k,j),0.)<a name='1520'>
        enddo<a name='1521'>
      enddo<a name='1522'>
<font color=#447700>!<a name='1523'></font>
<font color=#447700>!<a name='1524'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1525'></font>
<font color=#447700>!      rain (unit is mm/sec;kgm-2s-1: /1000*delt ===&gt; m)==&gt; mm for wrf<a name='1526'></font>
<font color=#447700>!<a name='1527'></font>
        fallsum = fall(i,1,1)+fall(i,1,2)+fallc(i,1)<a name='1528'>
        fallsum_qsi = fall(i,1,2)+fallc(i,1)<a name='1529'>
        rainncv(i,j) = 0.<a name='1530'>
        if(fallsum.gt.0.) then<a name='1531'>
          rainncv(i,j) = fallsum*delz(i,1,j)/denr*dtcld*1000.<a name='1532'>
          rain(i,j) = fallsum*delz(i,1,j)/denr*dtcld*1000. + rain(i,j)<a name='1533'>
        endif<a name='1534'>
        sr(i,j) = 0.<a name='1535'>
        if(fallsum.gt.0.)sr(i,j)=fallsum_qsi*delz(i,kts,j)/denr*dtcld*1000.        &amp;    <a name='1536'>
        /(rainncv(i,j)+1.e-12)<a name='1537'>
<font color=#447700>!<a name='1538'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1539'></font>
<font color=#447700>! pimlt: instantaneous melting of cloud ice [HL A47] [RH83 A28]<a name='1540'></font>
<font color=#447700>!       (T&gt;T0: I-&gt;C)<a name='1541'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1542'></font>
      do k = kts, kte<a name='1543'>
          supcol = t0c-t(i,k,j)<a name='1544'>
          xlf = xls-xl(i,k)<a name='1545'>
          if(supcol.lt.0.) xlf = xlf0<a name='1546'>
          if(supcol.lt.0.and.qci(i,k,2).gt.0.) then<a name='1547'>
            qci(i,k,1) = qci(i,k,1) + qci(i,k,2)<a name='1548'>
            t(i,k,j) = t(i,k,j) - xlf/cpm(i,k)*qci(i,k,2)<a name='1549'>
            qci(i,k,2) = 0.<a name='1550'>
          endif<a name='1551'>
<font color=#447700>!---------------------------------------------------------------<a name='1552'></font>
<font color=#447700>! pihmf: homogeneous freezing of cloud water below -40c [HL A45]<a name='1553'></font>
<font color=#447700>!        (T&lt;-40C: C-&gt;I)<a name='1554'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1555'></font>
          if(supcol.gt.40..and.qci(i,k,1).gt.0.) then<a name='1556'>
            qci(i,k,2) = qci(i,k,2) + qci(i,k,1)<a name='1557'>
            t(i,k,j) = t(i,k,j) + xlf/cpm(i,k)*qci(i,k,1)<a name='1558'>
            qci(i,k,1) = 0.<a name='1559'>
          endif<a name='1560'>
<font color=#447700>!---------------------------------------------------------------<a name='1561'></font>
<font color=#447700>! pihtf: heterogeneous freezing of cloud water [HL A44]<a name='1562'></font>
<font color=#447700>!        (T0&gt;T&gt;-40C: C-&gt;I)<a name='1563'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1564'></font>
          if(supcol.gt.0..and.qci(i,k,1).gt.0.) then<a name='1565'>
            supcolt=min(supcol,50.)<a name='1566'>
<font color=#447700>!           pfrzdtc = min(pfrz1*(exp(pfrz2*supcol)-1.)                         &amp;<a name='1567'></font>
<font color=#447700>!              *den(i,k,j)/denr/xncr*qci(i,k,1)**2*dtcld,qci(i,k,1))<a name='1568'></font>
            pfrzdtc = min(pfrz1*(exp(pfrz2*supcolt)-1.)                        &amp;<a name='1569'>
            *den(i,k,j)/denr/xncr*qci(i,k,1)*qci(i,k,1)*dtcld,qci(i,k,1))<a name='1570'>
            qci(i,k,2) = qci(i,k,2) + pfrzdtc<a name='1571'>
            t(i,k,j) = t(i,k,j) + xlf/cpm(i,k)*pfrzdtc<a name='1572'>
            qci(i,k,1) = qci(i,k,1)-pfrzdtc<a name='1573'>
          endif<a name='1574'>
<font color=#447700>!---------------------------------------------------------------<a name='1575'></font>
<font color=#447700>! psfrz: freezing of rain water [HL A20] [LFO 45]<a name='1576'></font>
<font color=#447700>!        (T&lt;T0, R-&gt;S)<a name='1577'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1578'></font>
          if(supcol.gt.0..and.qrs(i,k,1).gt.0.) then<a name='1579'>
            supcolt=min(supcol,50.)<a name='1580'>
<font color=#447700>!           pfrzdtr = min(20.*pi**2*pfrz1*n0r*denr/den(i,k,j)                    &amp;<a name='1581'></font>
<font color=#447700>!                 *(exp(pfrz2*supcol)-1.)*rslope(i,k,1)**7*dtcld,              &amp;<a name='1582'></font>
<font color=#447700>!                 qrs(i,k,1))<a name='1583'></font>
            temp = rslope(i,k,1)<a name='1584'>
            temp = temp*temp*temp*temp*temp*temp*temp<a name='1585'>
            pfrzdtr = min(20.*(pi*pi)*pfrz1*n0r*denr/den(i,k,j)                  &amp;<a name='1586'>
                  *(exp(pfrz2*supcolt)-1.)*temp*dtcld,                         &amp;<a name='1587'>
                  qrs(i,k,1))<a name='1588'>
            qrs(i,k,2) = qrs(i,k,2) + pfrzdtr<a name='1589'>
            t(i,k,j) = t(i,k,j) + xlf/cpm(i,k)*pfrzdtr<a name='1590'>
            qrs(i,k,1) = qrs(i,k,1)-pfrzdtr<a name='1591'>
          endif<a name='1592'>
      enddo<a name='1593'>
<font color=#447700>!<a name='1594'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1595'></font>
<font color=#447700>!     rsloper: reverse of the slope parameter of the rain(m)<a name='1596'></font>
<font color=#447700>!     xka:    thermal conductivity of air(jm-1s-1k-1)<a name='1597'></font>
<font color=#447700>!     work1:  the thermodynamic term in the denominator associated with<a name='1598'></font>
<font color=#447700>!             heat conduction and vapor diffusion<a name='1599'></font>
<font color=#447700>!             (ry88, y93, h85)<a name='1600'></font>
<font color=#447700>!     work2: parameter associated with the ventilation effects(y93)<a name='1601'></font>
<font color=#447700>!<a name='1602'></font>
      do k = kts, kte<a name='1603'>
          if(qrs(i,k,1).le.qcrmin)then<a name='1604'>
            rslope(i,k,1) = rslopermax<a name='1605'>
            rslopeb(i,k,1) = rsloperbmax<a name='1606'>
            rslope2(i,k,1) = rsloper2max<a name='1607'>
            rslope3(i,k,1) = rsloper3max<a name='1608'>
          else<a name='1609'>
<font color=#447700>!           rslope(i,k,1) = 1./lamdar(qrs(i,k,1),den(i,k,j))<a name='1610'></font>
            rslope(i,k,1) = 1./(sqrt(sqrt(pidn0r/((qrs(i,k,1))*(den(i,k,j))))))<a name='1611'>
            rslopeb(i,k,1) = exp(log(rslope(i,k,1))*(bvtr))<a name='1612'>
            rslope2(i,k,1) = rslope(i,k,1)*rslope(i,k,1)<a name='1613'>
            rslope3(i,k,1) = rslope2(i,k,1)*rslope(i,k,1)<a name='1614'>
          endif<a name='1615'>
          if(qrs(i,k,2).le.qcrmin)then<a name='1616'>
            rslope(i,k,2) = rslopesmax<a name='1617'>
            rslopeb(i,k,2) = rslopesbmax<a name='1618'>
            rslope2(i,k,2) = rslopes2max<a name='1619'>
            rslope3(i,k,2) = rslopes3max<a name='1620'>
          else<a name='1621'>
<font color=#447700>!            rslope(i,k,2) = 1./lamdas(qrs(i,k,2),den(i,k,j),n0sfac(i,k))<a name='1622'></font>
            rslope(i,k,2) = 1./(sqrt(sqrt(pidn0s*(n0sfac(i,k))/((qrs(i,k,2))   &amp;  <a name='1623'>
                          *(den(i,k,j))))))<a name='1624'>
            rslopeb(i,k,2) = exp(log(rslope(i,k,2))*(bvts))<a name='1625'>
            rslope2(i,k,2) = rslope(i,k,2)*rslope(i,k,2)<a name='1626'>
            rslope3(i,k,2) = rslope2(i,k,2)*rslope(i,k,2)<a name='1627'>
          endif<a name='1628'>
      enddo<a name='1629'>
<font color=#447700>!<a name='1630'></font>
      do k = kts, kte<a name='1631'>
<font color=#447700>!         work1(i,k,1) = diffac(xl(i,k),p(i,k,j),t(i,k,j),den(i,k,j),qs(i,k,1))<a name='1632'></font>
          work1(i,k,1) = ((((den(i,k,j))*(xl(i,k))*(xl(i,k)))*((t(i,k,j))+120.)    &amp;<a name='1633'>
                       *(den(i,k,j)))/(1.414e3*(1.496e-6*((t(i,k,j))*sqrt(t(i,k,j))))&amp;<a name='1634'>
                       *(den(i,k,j))*(rv*(t(i,k,j))*(t(i,k,j)))))                    &amp;<a name='1635'>
                      +  p(i,k,j)/((qs(i,k,1))*(8.794e-5*exp(log(t(i,k,j))*(1.81))))<a name='1636'>
<font color=#447700>!         work1(i,k,2) = diffac(xls,p(i,k,j),t(i,k,j),den(i,k,j),qs(i,k,2))<a name='1637'></font>
          work1(i,k,2) = ((((den(i,k,j))*(xls)*(xls))*((t(i,k,j))+120.)*(den(i,k,j)))&amp;<a name='1638'>
                       /(1.414e3*(1.496e-6*((t(i,k,j))*sqrt(t(i,k,j))))*(den(i,k,j)) &amp;<a name='1639'>
                       *(rv*(t(i,k,j))*(t(i,k,j))))                                &amp;<a name='1640'>
                      + p(i,k,j)/(qs(i,k,2)*(8.794e-5*exp(log(t(i,k,j))*(1.81)))))<a name='1641'>
<font color=#447700>!         work2(i,k) = venfac(p(i,k,j),t(i,k,j),den(i,k,j))<a name='1642'></font>
          work2(i,k) = (exp(.3333333*log(((1.496e-6 * ((t(i,k,j))*sqrt(t(i,k,j)))) &amp;<a name='1643'>
                     *p(i,k,j))/(((t(i,k,j))+120.)*den(i,k,j)*(8.794e-5              &amp;<a name='1644'>
                     *exp(log(t(i,k,j))*(1.81))))))*sqrt(sqrt(den0/(den(i,k,j))))) &amp;<a name='1645'>
                      /sqrt((1.496e-6*((t(i,k,j))*sqrt(t(i,k,j))))                 &amp;<a name='1646'>
                      /(((t(i,k,j))+120.)*den(i,k,j)))<a name='1647'>
      enddo <a name='1648'>
<font color=#447700>!<a name='1649'></font>
<font color=#447700>!===============================================================<a name='1650'></font>
<font color=#447700>!<a name='1651'></font>
<font color=#447700>! warm rain processes<a name='1652'></font>
<font color=#447700>!<a name='1653'></font>
<font color=#447700>! - follows the processes in RH83 and LFO except for autoconcersion<a name='1654'></font>
<font color=#447700>!<a name='1655'></font>
<font color=#447700>!===============================================================<a name='1656'></font>
<font color=#447700>!<a name='1657'></font>
      do k = kts, kte<a name='1658'>
          supsat = max(q(i,k,j),qmin)-qs(i,k,1)<a name='1659'>
          satdt = supsat/dtcld<a name='1660'>
<font color=#447700>!---------------------------------------------------------------<a name='1661'></font>
<font color=#447700>! praut: auto conversion rate from cloud to rain [HDC 16]<a name='1662'></font>
<font color=#447700>!        (C-&gt;R)<a name='1663'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1664'></font>
          if(qci(i,k,1).gt.qc0) then<a name='1665'>
            praut(i,k) = qck1*exp(log(qci(i,k,1))*((7./3.)))<a name='1666'>
            praut(i,k) = min(praut(i,k),qci(i,k,1)/dtcld)<a name='1667'>
          endif<a name='1668'>
<font color=#447700>!---------------------------------------------------------------<a name='1669'></font>
<font color=#447700>! pracw: accretion of cloud water by rain [HL A40] [LFO 51]<a name='1670'></font>
<font color=#447700>!        (C-&gt;R)<a name='1671'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1672'></font>
          if(qrs(i,k,1).gt.qcrmin.and.qci(i,k,1).gt.qmin) then<a name='1673'>
            pracw(i,k) = min(pacrr*rslope3(i,k,1)*rslopeb(i,k,1)               &amp; <a name='1674'>
                         *qci(i,k,1)*denfac(i,k),qci(i,k,1)/dtcld)<a name='1675'>
          endif<a name='1676'>
<font color=#447700>!---------------------------------------------------------------<a name='1677'></font>
<font color=#447700>! prevp: evaporation/condensation rate of rain [HDC 14]<a name='1678'></font>
<font color=#447700>!        (V-&gt;R or R-&gt;V)<a name='1679'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1680'></font>
          if(qrs(i,k,1).gt.0.) then<a name='1681'>
            coeres = rslope2(i,k,1)*sqrt(rslope(i,k,1)*rslopeb(i,k,1))<a name='1682'>
            prevp(i,k) = (rh(i,k,1)-1.)*(precr1*rslope2(i,k,1)                 &amp;<a name='1683'>
                         +precr2*work2(i,k)*coeres)/work1(i,k,1)<a name='1684'>
            if(prevp(i,k).lt.0.) then<a name='1685'>
              prevp(i,k) = max(prevp(i,k),-qrs(i,k,1)/dtcld)<a name='1686'>
              prevp(i,k) = max(prevp(i,k),satdt/2)<a name='1687'>
            else<a name='1688'>
              prevp(i,k) = min(prevp(i,k),satdt/2)<a name='1689'>
            endif<a name='1690'>
          endif<a name='1691'>
      enddo<a name='1692'>
<font color=#447700>!<a name='1693'></font>
<font color=#447700>!===============================================================<a name='1694'></font>
<font color=#447700>!<a name='1695'></font>
<font color=#447700>! cold rain processes<a name='1696'></font>
<font color=#447700>!<a name='1697'></font>
<font color=#447700>! - follows the revised ice microphysics processes in HDC<a name='1698'></font>
<font color=#447700>! - the processes same as in RH83 and RH84  and LFO behave<a name='1699'></font>
<font color=#447700>!   following ice crystal hapits defined in HDC, inclduing<a name='1700'></font>
<font color=#447700>!   intercept parameter for snow (n0s), ice crystal number<a name='1701'></font>
<font color=#447700>!   concentration (ni), ice nuclei number concentration<a name='1702'></font>
<font color=#447700>!   (n0i), ice diameter (d)<a name='1703'></font>
<font color=#447700>!<a name='1704'></font>
<font color=#447700>!===============================================================<a name='1705'></font>
<font color=#447700>!<a name='1706'></font>
      rdtcld = 1./dtcld<a name='1707'>
      do k = kts, kte<a name='1708'>
          supcol = t0c-t(i,k,j)<a name='1709'>
          supsat = max(q(i,k,j),qmin)-qs(i,k,2)<a name='1710'>
          satdt = supsat/dtcld<a name='1711'>
          ifsat = 0<a name='1712'>
<font color=#447700>!-------------------------------------------------------------<a name='1713'></font>
<font color=#447700>! Ni: ice crystal number concentraiton   [HDC 5c]<a name='1714'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1715'></font>
<font color=#447700>!         xni(i,k) = min(max(5.38e7*(den(i,k,j)                                  &amp;<a name='1716'></font>
<font color=#447700>!                      *max(qci(i,k,2),qmin))**0.75,1.e3),1.e6)<a name='1717'></font>
          temp = (den(i,k,j)*max(qci(i,k,2),qmin))<a name='1718'>
          temp = sqrt(sqrt(temp*temp*temp))<a name='1719'>
          xni(i,k) = min(max(5.38e7*temp,1.e3),1.e6)<a name='1720'>
          eacrs = exp(0.07*(-supcol))<a name='1721'>
<font color=#447700>!<a name='1722'></font>
          if(supcol.gt.0) then<a name='1723'>
            if(qrs(i,k,2).gt.qcrmin.and.qci(i,k,2).gt.qmin) then<a name='1724'>
              xmi = den(i,k,j)*qci(i,k,2)/xni(i,k)<a name='1725'>
              diameter  = min(dicon * sqrt(xmi),dimax)<a name='1726'>
              vt2i = 1.49e4*diameter**1.31<a name='1727'>
              vt2s = pvts*rslopeb(i,k,2)*denfac(i,k)<a name='1728'>
<font color=#447700>!-------------------------------------------------------------<a name='1729'></font>
<font color=#447700>! psaci: Accretion of cloud ice by rain [HDC 10]<a name='1730'></font>
<font color=#447700>!        (T&lt;T0: I-&gt;S)<a name='1731'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1732'></font>
              acrfac = 2.*rslope3(i,k,2)+2.*diameter*rslope2(i,k,2)            &amp;<a name='1733'>
                      +diameter**2*rslope(i,k,2)<a name='1734'>
              psaci(i,k) = pi*qci(i,k,2)*eacrs*n0s*n0sfac(i,k)                 &amp;<a name='1735'>
                           *abs(vt2s-vt2i)*acrfac/4.<a name='1736'>
            endif<a name='1737'>
          endif<a name='1738'>
<font color=#447700>!-------------------------------------------------------------<a name='1739'></font>
<font color=#447700>! psacw: Accretion of cloud water by snow  [HL A7] [LFO 24]<a name='1740'></font>
<font color=#447700>!        (T&lt;T0: C-&gt;S, and T&gt;=T0: C-&gt;R)<a name='1741'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1742'></font>
          if(qrs(i,k,2).gt.qcrmin.and.qci(i,k,1).gt.qmin) then<a name='1743'>
            psacw(i,k) = min(pacrc*n0sfac(i,k)*rslope3(i,k,2)                  &amp;<a name='1744'>
                           *rslopeb(i,k,2)*qci(i,k,1)*denfac(i,k)              &amp;<a name='1745'>
<font color=#447700>!                          ,qci(i,k,1)/dtcld)<a name='1746'></font>
                           ,qci(i,k,1)*rdtcld)<a name='1747'>
          endif<a name='1748'>
          if(supcol .gt. 0) then<a name='1749'>
<font color=#447700>!-------------------------------------------------------------<a name='1750'></font>
<font color=#447700>! pidep: Deposition/Sublimation rate of ice [HDC 9]<a name='1751'></font>
<font color=#447700>!       (T&lt;T0: V-&gt;I or I-&gt;V)<a name='1752'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1753'></font>
            if(qci(i,k,2).gt.0.and.ifsat.ne.1) then<a name='1754'>
              xmi = den(i,k,j)*qci(i,k,2)/xni(i,k)<a name='1755'>
              diameter = dicon * sqrt(xmi)<a name='1756'>
              pidep(i,k) = 4.*diameter*xni(i,k)*(rh(i,k,2)-1.)/work1(i,k,2)<a name='1757'>
              supice = satdt-prevp(i,k)<a name='1758'>
              if(pidep(i,k).lt.0.) then<a name='1759'>
<font color=#447700>!               pidep(i,k) = max(max(pidep(i,k),satdt/2),supice)<a name='1760'></font>
<font color=#447700>!               pidep(i,k) = max(pidep(i,k),-qci(i,k,2)/dtcld)<a name='1761'></font>
                pidep(i,k) = max(max(pidep(i,k),satdt*.5),supice)<a name='1762'>
                pidep(i,k) = max(pidep(i,k),-qci(i,k,2)*rdtcld)<a name='1763'>
              else<a name='1764'>
<font color=#447700>!               pidep(i,k) = min(min(pidep(i,k),satdt/2),supice)<a name='1765'></font>
                pidep(i,k) = min(min(pidep(i,k),satdt*.5),supice)<a name='1766'>
              endif<a name='1767'>
              if(abs(prevp(i,k)+pidep(i,k)).ge.abs(satdt)) ifsat = 1<a name='1768'>
            endif<a name='1769'>
<font color=#447700>!-------------------------------------------------------------<a name='1770'></font>
<font color=#447700>! psdep: deposition/sublimation rate of snow [HDC 14]<a name='1771'></font>
<font color=#447700>!        (V-&gt;S or S-&gt;V)<a name='1772'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1773'></font>
            if(qrs(i,k,2).gt.0..and.ifsat.ne.1) then<a name='1774'>
              coeres = rslope2(i,k,2)*sqrt(rslope(i,k,2)*rslopeb(i,k,2))<a name='1775'>
              psdep(i,k) = (rh(i,k,2)-1.)*n0sfac(i,k)                          &amp;<a name='1776'>
                           *(precs1*rslope2(i,k,2)+precs2                      &amp;<a name='1777'>
                           *work2(i,k)*coeres)/work1(i,k,2)<a name='1778'>
              supice = satdt-prevp(i,k)-pidep(i,k)<a name='1779'>
              if(psdep(i,k).lt.0.) then<a name='1780'>
<font color=#447700>!               psdep(i,k) = max(psdep(i,k),-qrs(i,k,2)/dtcld)<a name='1781'></font>
<font color=#447700>!               psdep(i,k) = max(max(psdep(i,k),satdt/2),supice)<a name='1782'></font>
                psdep(i,k) = max(psdep(i,k),-qrs(i,k,2)*rdtcld)<a name='1783'>
                psdep(i,k) = max(max(psdep(i,k),satdt*.5),supice)<a name='1784'>
              else<a name='1785'>
<font color=#447700>!             psdep(i,k) = min(min(psdep(i,k),satdt/2),supice)<a name='1786'></font>
                psdep(i,k) = min(min(psdep(i,k),satdt*.5),supice)<a name='1787'>
              endif<a name='1788'>
              if(abs(prevp(i,k)+pidep(i,k)+psdep(i,k)).ge.abs(satdt))          &amp;<a name='1789'>
                ifsat = 1<a name='1790'>
            endif<a name='1791'>
<font color=#447700>!-------------------------------------------------------------<a name='1792'></font>
<font color=#447700>! pigen: generation(nucleation) of ice from vapor [HL A50] [HDC 7-8]<a name='1793'></font>
<font color=#447700>!       (T&lt;T0: V-&gt;I)<a name='1794'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1795'></font>
            if(supsat.gt.0.and.ifsat.ne.1) then<a name='1796'>
              supice = satdt-prevp(i,k)-pidep(i,k)-psdep(i,k)<a name='1797'>
              xni0 = 1.e3*exp(0.1*supcol)<a name='1798'>
              roqi0 = 4.92e-11*exp(log(xni0)*(1.33))<a name='1799'>
              pigen(i,k) = max(0.,(roqi0/den(i,k,j)-max(qci(i,k,2),0.))          &amp;<a name='1800'>
<font color=#447700>!                        /dtcld)<a name='1801'></font>
                         *rdtcld)<a name='1802'>
              pigen(i,k) = min(min(pigen(i,k),satdt),supice)<a name='1803'>
            endif<a name='1804'>
<font color=#447700>!<a name='1805'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1806'></font>
<font color=#447700>! psaut: conversion(aggregation) of ice to snow [HDC 12]<a name='1807'></font>
<font color=#447700>!       (T&lt;T0: I-&gt;S)<a name='1808'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1809'></font>
            if(qci(i,k,2).gt.0.) then<a name='1810'>
              qimax = roqimax/den(i,k,j)<a name='1811'>
<font color=#447700>!             psaut(i,k) = max(0.,(qci(i,k,2)-qimax)/dtcld)<a name='1812'></font>
              psaut(i,k) = max(0.,(qci(i,k,2)-qimax)*rdtcld)<a name='1813'>
            endif<a name='1814'>
          endif<a name='1815'>
<font color=#447700>!-------------------------------------------------------------<a name='1816'></font>
<font color=#447700>! psevp: Evaporation of melting snow [HL A35] [RH83 A27]<a name='1817'></font>
<font color=#447700>!       (T&gt;T0: S-&gt;V)<a name='1818'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1819'></font>
          if(supcol.lt.0.) then<a name='1820'>
            if(qrs(i,k,2).gt.0..and.rh(i,k,1).lt.1.)                           &amp;<a name='1821'>
              psevp(i,k) = psdep(i,k)*work1(i,k,2)/work1(i,k,1)<a name='1822'>
<font color=#447700>!              psevp(i,k) = min(max(psevp(i,k),-qrs(i,k,2)/dtcld),0.)<a name='1823'></font>
              psevp(i,k) = min(max(psevp(i,k),-qrs(i,k,2)*rdtcld),0.)<a name='1824'>
          endif<a name='1825'>
      enddo<a name='1826'>
<font color=#447700>!<a name='1827'></font>
<font color=#447700>!<a name='1828'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1829'></font>
<font color=#447700>!     check mass conservation of generation terms and feedback to the<a name='1830'></font>
<font color=#447700>!     large scale<a name='1831'></font>
<font color=#447700>!<a name='1832'></font>
      do k = kts, kte<a name='1833'>
          if(t(i,k,j).le.t0c) then<a name='1834'>
<font color=#447700>!<a name='1835'></font>
<font color=#447700>!     cloud water<a name='1836'></font>
<font color=#447700>!<a name='1837'></font>
            value = max(qmin,qci(i,k,1))<a name='1838'>
            source = (praut(i,k)+pracw(i,k)+psacw(i,k))*dtcld<a name='1839'>
            if (source.gt.value) then<a name='1840'>
              factor = value/source<a name='1841'>
              praut(i,k) = praut(i,k)*factor<a name='1842'>
              pracw(i,k) = pracw(i,k)*factor<a name='1843'>
              psacw(i,k) = psacw(i,k)*factor<a name='1844'>
            endif<a name='1845'>
<font color=#447700>!<a name='1846'></font>
<font color=#447700>!     cloud ice<a name='1847'></font>
<font color=#447700>!<a name='1848'></font>
            value = max(qmin,qci(i,k,2))<a name='1849'>
            source = (psaut(i,k)+psaci(i,k)-pigen(i,k)-pidep(i,k))*dtcld<a name='1850'>
            if (source.gt.value) then<a name='1851'>
              factor = value/source<a name='1852'>
              psaut(i,k) = psaut(i,k)*factor<a name='1853'>
              psaci(i,k) = psaci(i,k)*factor<a name='1854'>
              pigen(i,k) = pigen(i,k)*factor<a name='1855'>
              pidep(i,k) = pidep(i,k)*factor<a name='1856'>
            endif<a name='1857'>
<font color=#447700>!<a name='1858'></font>
<font color=#447700>!     rain<a name='1859'></font>
<font color=#447700>!<a name='1860'></font>
<font color=#447700>!<a name='1861'></font>
            value = max(qmin,qrs(i,k,1))<a name='1862'>
            source = (-praut(i,k)-pracw(i,k)-prevp(i,k))*dtcld<a name='1863'>
            if (source.gt.value) then<a name='1864'>
              factor = value/source<a name='1865'>
              praut(i,k) = praut(i,k)*factor<a name='1866'>
              pracw(i,k) = pracw(i,k)*factor<a name='1867'>
              prevp(i,k) = prevp(i,k)*factor<a name='1868'>
            endif<a name='1869'>
<font color=#447700>!<a name='1870'></font>
<font color=#447700>!    snow<a name='1871'></font>
<font color=#447700>!<a name='1872'></font>
            value = max(qmin,qrs(i,k,2))<a name='1873'>
            source = (-psdep(i,k)-psaut(i,k)-psaci(i,k)-psacw(i,k))*dtcld  <a name='1874'>
            if (source.gt.value) then<a name='1875'>
              factor = value/source<a name='1876'>
              psdep(i,k) = psdep(i,k)*factor<a name='1877'>
              psaut(i,k) = psaut(i,k)*factor<a name='1878'>
              psaci(i,k) = psaci(i,k)*factor<a name='1879'>
              psacw(i,k) = psacw(i,k)*factor<a name='1880'>
            endif<a name='1881'>
<font color=#447700>!<a name='1882'></font>
            work2(i,k)=-(prevp(i,k)+psdep(i,k)+pigen(i,k)+pidep(i,k))<a name='1883'>
<font color=#447700>!     update<a name='1884'></font>
            q(i,k,j) = q(i,k,j)+work2(i,k)*dtcld<a name='1885'>
            qci(i,k,1) = max(qci(i,k,1)-(praut(i,k)+pracw(i,k)                 &amp;<a name='1886'>
                        +psacw(i,k))*dtcld,0.)<a name='1887'>
            qrs(i,k,1) = max(qrs(i,k,1)+(praut(i,k)+pracw(i,k)                 &amp;<a name='1888'>
                        +prevp(i,k))*dtcld,0.)<a name='1889'>
            qci(i,k,2) = max(qci(i,k,2)-(psaut(i,k)+psaci(i,k)                 &amp;<a name='1890'>
                        -pigen(i,k)-pidep(i,k))*dtcld,0.)<a name='1891'>
            qrs(i,k,2) = max(qrs(i,k,2)+(psdep(i,k)+psaut(i,k)                 &amp;<a name='1892'>
                        +psaci(i,k)+psacw(i,k))*dtcld,0.)<a name='1893'>
            xlf = xls-xl(i,k)<a name='1894'>
            xlwork2 = -xls*(psdep(i,k)+pidep(i,k)+pigen(i,k))                  &amp;<a name='1895'>
                      -xl(i,k)*prevp(i,k)-xlf*psacw(i,k)<a name='1896'>
            t(i,k,j) = t(i,k,j)-xlwork2/cpm(i,k)*dtcld<a name='1897'>
          else<a name='1898'>
<font color=#447700>!<a name='1899'></font>
<font color=#447700>!     cloud water<a name='1900'></font>
<font color=#447700>!<a name='1901'></font>
            value = max(qmin,qci(i,k,1))<a name='1902'>
            source=(praut(i,k)+pracw(i,k)+psacw(i,k))*dtcld<a name='1903'>
            if (source.gt.value) then<a name='1904'>
              factor = value/source<a name='1905'>
              praut(i,k) = praut(i,k)*factor<a name='1906'>
              pracw(i,k) = pracw(i,k)*factor<a name='1907'>
              psacw(i,k) = psacw(i,k)*factor<a name='1908'>
            endif<a name='1909'>
<font color=#447700>!<a name='1910'></font>
<font color=#447700>!     rain<a name='1911'></font>
<font color=#447700>!<a name='1912'></font>
            value = max(qmin,qrs(i,k,1))<a name='1913'>
            source = (-praut(i,k)-pracw(i,k)-prevp(i,k)-psacw(i,k))*dtcld<a name='1914'>
            if (source.gt.value) then<a name='1915'>
              factor = value/source<a name='1916'>
              praut(i,k) = praut(i,k)*factor<a name='1917'>
              pracw(i,k) = pracw(i,k)*factor<a name='1918'>
              prevp(i,k) = prevp(i,k)*factor<a name='1919'>
              psacw(i,k) = psacw(i,k)*factor<a name='1920'>
            endif  <a name='1921'>
<font color=#447700>!<a name='1922'></font>
<font color=#447700>!     snow<a name='1923'></font>
<font color=#447700>!<a name='1924'></font>
            value = max(qcrmin,qrs(i,k,2))<a name='1925'>
            source=(-psevp(i,k))*dtcld<a name='1926'>
            if (source.gt.value) then<a name='1927'>
              factor = value/source<a name='1928'>
              psevp(i,k) = psevp(i,k)*factor<a name='1929'>
            endif<a name='1930'>
            work2(i,k)=-(prevp(i,k)+psevp(i,k))<a name='1931'>
<font color=#447700>!     update<a name='1932'></font>
            q(i,k,j) = q(i,k,j)+work2(i,k)*dtcld<a name='1933'>
            qci(i,k,1) = max(qci(i,k,1)-(praut(i,k)+pracw(i,k)                 &amp;<a name='1934'>
                        +psacw(i,k))*dtcld,0.)<a name='1935'>
            qrs(i,k,1) = max(qrs(i,k,1)+(praut(i,k)+pracw(i,k)                 &amp;<a name='1936'>
                        +prevp(i,k) +psacw(i,k))*dtcld,0.)<a name='1937'>
            qrs(i,k,2) = max(qrs(i,k,2)+psevp(i,k)*dtcld,0.)<a name='1938'>
            xlf = xls-xl(i,k)<a name='1939'>
            xlwork2 = -xl(i,k)*(prevp(i,k)+psevp(i,k))<a name='1940'>
            t(i,k,j) = t(i,k,j)-xlwork2/cpm(i,k)*dtcld<a name='1941'>
          endif<a name='1942'>
      enddo<a name='1943'>
<font color=#447700>!<a name='1944'></font>
<font color=#447700>! Inline expansion for fpvs<a name='1945'></font>
<font color=#447700>!         qs(i,k,1) = fpvs(t(i,k,j),0,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='1946'></font>
<font color=#447700>!         qs(i,k,2) = fpvs(t(i,k,j),1,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='1947'></font>
      hsub = xls<a name='1948'>
      hvap = xlv0<a name='1949'>
      cvap = cpv<a name='1950'>
      ttp=t0c+0.01<a name='1951'>
      dldt=cvap-cliq<a name='1952'>
      xa=-dldt/rv<a name='1953'>
      xb=xa+hvap/(rv*ttp)<a name='1954'>
      dldti=cvap-cice<a name='1955'>
      xai=-dldti/rv<a name='1956'>
      xbi=xai+hsub/(rv*ttp)<a name='1957'>
      do k = kts, kte<a name='1958'>
          tr=ttp/t(i,k,j)<a name='1959'>
          logtr = log(tr)<a name='1960'>
          qs(i,k,1)=psat*exp(logtr*(xa)+xb*(1.-tr))<a name='1961'>
          qs(i,k,1) = ep2 * qs(i,k,1) / (p(i,k,j) - qs(i,k,1))<a name='1962'>
          qs(i,k,1) = max(qs(i,k,1),qmin)<a name='1963'>
      enddo<a name='1964'>
<font color=#447700>!<a name='1965'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1966'></font>
<font color=#447700>!  pcond: condensational/evaporational rate of cloud water [HL A46] [RH83 A6]<a name='1967'></font>
<font color=#447700>!     if there exists additional water vapor condensated/if<a name='1968'></font>
<font color=#447700>!     evaporation of cloud water is not enough to remove subsaturation<a name='1969'></font>
<font color=#447700>!<a name='1970'></font>
      do k = kts, kte<a name='1971'>
<font color=#447700>!         work1(i,k,1) = conden(t(i,k,j),q(i,k,j),qs(i,k,1),xl(i,k),cpm(i,k))<a name='1972'></font>
          work1(i,k,1) = ((max(q(i,k,j),qmin)-(qs(i,k,1)))/(1.+(xl(i,k))         &amp;   <a name='1973'>
                        *(xl(i,k))/(rv*(cpm(i,k)))*(qs(i,k,1))                 &amp;<a name='1974'>
                        /((t(i,k,j))*(t(i,k,j)))))<a name='1975'>
          work2(i,k) = qci(i,k,1)+work1(i,k,1)<a name='1976'>
          pcond(i,k) = min(max(work1(i,k,1)/dtcld,0.),max(q(i,k,j),0.)/dtcld)<a name='1977'>
          if(qci(i,k,1).gt.0..and.work1(i,k,1).lt.0.)                          &amp;<a name='1978'>
            pcond(i,k) = max(work1(i,k,1),-qci(i,k,1))/dtcld<a name='1979'>
          q(i,k,j) = q(i,k,j)-pcond(i,k)*dtcld<a name='1980'>
          qci(i,k,1) = max(qci(i,k,1)+pcond(i,k)*dtcld,0.)<a name='1981'>
          t(i,k,j) = t(i,k,j)+pcond(i,k)*xl(i,k)/cpm(i,k)*dtcld<a name='1982'>
      enddo<a name='1983'>
<font color=#447700>!<a name='1984'></font>
<font color=#447700>!<a name='1985'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1986'></font>
<font color=#447700>!     padding for small values<a name='1987'></font>
<font color=#447700>!<a name='1988'></font>
      do k = kts, kte<a name='1989'>
          if(qci(i,k,1).le.qmin) qci(i,k,1) = 0.0<a name='1990'>
          if(qci(i,k,2).le.qmin) qci(i,k,2) = 0.0<a name='1991'>
      enddo<a name='1992'>
      enddo                  <font color=#447700>! big loops<a name='1993'></font>
<a name='1994'>
         DO K=kts,kte<a name='1995'>
            th(i,k,j)=t(i,k,j)/pii(i,k,j)<a name='1996'>
            qc(i,k,j) = qci(i,k,1)<a name='1997'>
            qi(i,k,j) = qci(i,k,2)<a name='1998'>
            qr(i,k,j) = qrs(i,k,1)<a name='1999'>
            qqs(i,k,j) = qrs(i,k,2)<a name='2000'>
         ENDDO<a name='2001'>
<a name='2002'>
      ENDDO     <font color=#447700>!  i loop<a name='2003'></font>
      enddo     <font color=#447700>!  j loop<a name='2004'></font>
<font color=#447700>!$acc end region<a name='2005'></font>
<a name='2006'>
    ENDIF<a name='2007'>
<a name='2008'>
  END SUBROUTINE wsm52d<a name='2009'>
<a name='2010'>
<a name='2011'>
#else<a name='2012'>
<a name='2013'>
<font color=#447700>!===================================================================<a name='2014'></font>
<font color=#447700>!<a name='2015'></font>
<A NAME='WSM52D'><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM52D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2016'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>wsm52D</font>(t, q, qci, qrs, den, p, delz                  &amp; <A href='../../call_to/WSM52D.html' TARGET='index'>3</A>,<A href='../../call_from/WSM52D.html' TARGET='index'>10</A><a name='2017'>
                   ,delt,g, cpd, cpv, rd, rv, t0c                 &amp;<a name='2018'>
                   ,ep1, ep2, qmin                                &amp;<a name='2019'>
                   ,XLS, XLV0, XLF0, den0, denr                   &amp;<a name='2020'>
                   ,cliq,cice,psat                                &amp;<a name='2021'>
                   ,lat                                           &amp;<a name='2022'>
                   ,rain,rainncv                                  &amp;<a name='2023'>
                   ,sr                                            &amp;<a name='2024'>
                   ,ids,ide, jds,jde, kds,kde                     &amp;<a name='2025'>
                   ,ims,ime, jms,jme, kms,kme                     &amp;<a name='2026'>
                   ,its,ite, jts,jte, kts,kte                     &amp;<a name='2027'>
                   ,snow,snowncv                                  &amp;<a name='2028'>
                                                                  )<a name='2029'>
<font color=#447700>!-------------------------------------------------------------------<a name='2030'></font>
  IMPLICIT NONE<a name='2031'>
<font color=#447700>!-------------------------------------------------------------------<a name='2032'></font>
  INTEGER,      INTENT(IN   )    ::   ids,ide, jds,jde, kds,kde , &amp;<a name='2033'>
                                      ims,ime, jms,jme, kms,kme , &amp;<a name='2034'>
                                      its,ite, jts,jte, kts,kte,  &amp;<a name='2035'>
                                      lat<a name='2036'>
  REAL, DIMENSION( its:ite , kts:kte ),                           &amp;<a name='2037'>
        INTENT(INOUT) ::                                          &amp;<a name='2038'>
                                                               t<a name='2039'>
  REAL, DIMENSION( its:ite , kts:kte, 2 ),                        &amp;<a name='2040'>
        INTENT(INOUT) ::                                          &amp;<a name='2041'>
                                                             qci, &amp;<a name='2042'>
                                                             qrs<a name='2043'>
  REAL, DIMENSION( ims:ime , kms:kme ),                           &amp;<a name='2044'>
        INTENT(INOUT) ::                                          &amp;<a name='2045'>
                                                               q<a name='2046'>
  REAL, DIMENSION( ims:ime , kms:kme ),                           &amp;<a name='2047'>
        INTENT(IN   ) ::                                          &amp;<a name='2048'>
                                                             den, &amp;<a name='2049'>
                                                               p, &amp;<a name='2050'>
                                                            delz<a name='2051'>
  REAL, INTENT(IN   ) ::                                    delt, &amp;<a name='2052'>
                                                               g, &amp;<a name='2053'>
                                                             cpd, &amp;<a name='2054'>
                                                             cpv, &amp;<a name='2055'>
                                                             t0c, &amp;<a name='2056'>
                                                            den0, &amp;<a name='2057'>
                                                              rd, &amp;<a name='2058'>
                                                              rv, &amp;<a name='2059'>
                                                             ep1, &amp;<a name='2060'>
                                                             ep2, &amp;<a name='2061'>
                                                            qmin, &amp;<a name='2062'>
                                                             XLS, &amp;<a name='2063'>
                                                            XLV0, &amp;<a name='2064'>
                                                            XLF0, &amp;<a name='2065'>
                                                            cliq, &amp;<a name='2066'>
                                                            cice, &amp;<a name='2067'>
                                                            psat, &amp;<a name='2068'>
                                                            denr<a name='2069'>
  REAL, DIMENSION( ims:ime ),                                     &amp;<a name='2070'>
        INTENT(INOUT) ::                                    rain, &amp;<a name='2071'>
                                                         rainncv, &amp;<a name='2072'>
                                                              sr<a name='2073'>
<a name='2074'>
  REAL, DIMENSION( ims:ime, jms:jme ),     OPTIONAL,              &amp;<a name='2075'>
        INTENT(INOUT) ::                                    snow, &amp;<a name='2076'>
                                                         snowncv<a name='2077'>
<a name='2078'>
<font color=#447700>! LOCAL VAR<a name='2079'></font>
  REAL, DIMENSION( its:ite , kts:kte , 2) ::                      &amp;<a name='2080'>
                                                              rh, &amp;<a name='2081'>
                                                              qs, &amp;<a name='2082'>
                                                          rslope, &amp;<a name='2083'>
                                                         rslope2, &amp;<a name='2084'>
                                                         rslope3, &amp;<a name='2085'>
                                                         rslopeb, &amp;<a name='2086'>
                                                            falk, &amp;<a name='2087'>
                                                            fall, &amp;<a name='2088'>
                                                           work1<a name='2089'>
<a name='2090'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='2091'>
                                                           falkc, &amp;<a name='2092'>
                                                           fallc, &amp;<a name='2093'>
                                                              xl, &amp;<a name='2094'>
                                                             cpm, &amp;<a name='2095'>
                                                          denfac, &amp;<a name='2096'>
                                                             xni, &amp;<a name='2097'>
                                                          n0sfac, &amp;<a name='2098'>
                                                           work2, &amp;<a name='2099'>
                                                          work1c, &amp;<a name='2100'>
                                                          work2c<a name='2101'>
<a name='2102'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='2103'>
                                                           pigen, &amp;<a name='2104'>
                                                           pidep, &amp;<a name='2105'>
                                                           psdep, &amp;<a name='2106'>
                                                           praut, &amp;<a name='2107'>
                                                           psaut, &amp;<a name='2108'>
                                                           prevp, &amp;<a name='2109'>
                                                           psevp, &amp;<a name='2110'>
                                                           pracw, &amp;<a name='2111'>
                                                           psacw, &amp;<a name='2112'>
                                                           psaci, &amp;<a name='2113'>
                                                           pcond, &amp;<a name='2114'>
                                                           psmlt<a name='2115'>
  INTEGER, DIMENSION( its:ite ) ::                                &amp;<a name='2116'>
                                                           mstep, &amp;<a name='2117'>
                                                           numdt<a name='2118'>
  REAL, DIMENSION(its:ite) ::                             rmstep<a name='2119'>
  REAL dtcldden, rdelz, rdtcld<a name='2120'>
  LOGICAL, DIMENSION( its:ite ) ::                        flgcld<a name='2121'>
<a name='2122'>
#define WSM_NO_CONDITIONAL_IN_VECTOR<a name='2123'>
#ifdef WSM_NO_CONDITIONAL_IN_VECTOR<a name='2124'>
  REAL, DIMENSION(its:ite) :: xal, xbl<a name='2125'>
#endif<a name='2126'>
<a name='2127'>
  REAL  ::  pi,                                                   &amp;<a name='2128'>
            cpmcal, xlcal, lamdar, lamdas, diffus,                &amp;<a name='2129'>
            viscos, xka, venfac, conden, diffac,                  &amp;<a name='2130'>
            x, y, z, a, b, c, d, e,                               &amp;<a name='2131'>
            qdt, holdrr, holdrs, supcol, supcolt, pvt,            &amp;<a name='2132'>
            coeres, supsat, dtcld, xmi, eacrs, satdt,             &amp;<a name='2133'>
            vt2i,vt2s,acrfac,                                     &amp;<a name='2134'>
            qimax, diameter, xni0, roqi0,                         &amp;<a name='2135'>
            fallsum, fallsum_qsi, xlwork2, factor, source,        &amp;<a name='2136'>
            value, xlf, pfrzdtc, pfrzdtr, supice,  holdc, holdci<a name='2137'>
<font color=#447700>! variables for optimization<a name='2138'></font>
  REAL, DIMENSION( its:ite )           ::                    tvec1<a name='2139'>
  REAL ::                                                    temp <a name='2140'>
  INTEGER :: i, j, k, mstepmax,                                   &amp;<a name='2141'>
            iprt, latd, lond, loop, loops, ifsat, n<a name='2142'>
<font color=#447700>! Temporaries used for inlining fpvs function<a name='2143'></font>
  REAL  :: dldti, xb, xai, tr, xbi, xa, hvap, cvap, hsub, dldt, ttp<a name='2144'>
  REAL  :: logtr<a name='2145'>
<font color=#447700>!<a name='2146'></font>
<font color=#447700>!=================================================================<a name='2147'></font>
<font color=#447700>!   compute internal functions<a name='2148'></font>
<font color=#447700>!<a name='2149'></font>
      cpmcal(x) = cpd*(1.-max(x,qmin))+max(x,qmin)*cpv<a name='2150'>
      xlcal(x) = xlv0-xlv1*(x-t0c)<a name='2151'>
<font color=#447700>!----------------------------------------------------------------<a name='2152'></font>
<font color=#447700>!     size distributions: (x=mixing ratio, y=air density):<a name='2153'></font>
<font color=#447700>!     valid for mixing ratio &gt; 1.e-9 kg/kg.<a name='2154'></font>
<font color=#447700>!<a name='2155'></font>
<font color=#447700>! Optimizatin : A**B =&gt; exp(log(A)*(B))<a name='2156'></font>
      lamdar(x,y)=   sqrt(sqrt(pidn0r/(x*y)))      <font color=#447700>! (pidn0r/(x*y))**.25<a name='2157'></font>
      lamdas(x,y,z)= sqrt(sqrt(pidn0s*z/(x*y)))    <font color=#447700>! (pidn0s*z/(x*y))**.25<a name='2158'></font>
<font color=#447700>!<a name='2159'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2160'></font>
<font color=#447700>!     diffus: diffusion coefficient of the water vapor<a name='2161'></font>
<font color=#447700>!     viscos: kinematic viscosity(m2s-1)<a name='2162'></font>
<font color=#447700>!     diffus(x,y) = 8.794e-5 * exp(log(x)*(1.81)) / y        ! 8.794e-5*x**1.81/y<a name='2163'></font>
<font color=#447700>!     viscos(x,y) = 1.496e-6 * (x*sqrt(x)) /(x+120.)/y  ! 1.496e-6*x**1.5/(x+120.)/y<a name='2164'></font>
<font color=#447700>!     xka(x,y) = 1.414e3*viscos(x,y)*y<a name='2165'></font>
<font color=#447700>!     diffac(a,b,c,d,e) = d*a*a/(xka(c,d)*rv*c*c)+1./(e*diffus(c,b))<a name='2166'></font>
<font color=#447700>!     venfac(a,b,c) = exp(log((viscos(b,c)/diffus(b,a)))*((.3333333)))         &amp;<a name='2167'></font>
<font color=#447700>!                    /sqrt(viscos(b,c))*sqrt(sqrt(den0/c))<a name='2168'></font>
<font color=#447700>!     conden(a,b,c,d,e) = (max(b,qmin)-c)/(1.+d*d/(rv*e)*c/(a*a))<a name='2169'></font>
<font color=#447700>!<a name='2170'></font>
<font color=#447700>!<a name='2171'></font>
      pi = 4. * atan(1.)<a name='2172'>
<font color=#447700>!<a name='2173'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2174'></font>
<font color=#447700>!     paddint 0 for negative values generated by dynamics<a name='2175'></font>
<font color=#447700>!<a name='2176'></font>
      do k = kts, kte<a name='2177'>
        do i = its, ite<a name='2178'>
          qci(i,k,1) = max(qci(i,k,1),0.0)<a name='2179'>
          qrs(i,k,1) = max(qrs(i,k,1),0.0)<a name='2180'>
          qci(i,k,2) = max(qci(i,k,2),0.0)<a name='2181'>
          qrs(i,k,2) = max(qrs(i,k,2),0.0)<a name='2182'>
        enddo<a name='2183'>
      enddo<a name='2184'>
<font color=#447700>!<a name='2185'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2186'></font>
<font color=#447700>!     latent heat for phase changes and heat capacity. neglect the<a name='2187'></font>
<font color=#447700>!     changes during microphysical process calculation<a name='2188'></font>
<font color=#447700>!     emanuel(1994)<a name='2189'></font>
<font color=#447700>!<a name='2190'></font>
      do k = kts, kte<a name='2191'>
        do i = its, ite<a name='2192'>
          cpm(i,k) = cpmcal(q(i,k))<a name='2193'>
          xl(i,k) = xlcal(t(i,k))<a name='2194'>
        enddo<a name='2195'>
      enddo<a name='2196'>
<font color=#447700>!<a name='2197'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2198'></font>
<font color=#447700>!     compute the minor time steps.<a name='2199'></font>
<font color=#447700>!<a name='2200'></font>
      loops = max(nint(delt/dtcldcr),1)<a name='2201'>
      dtcld = delt/loops<a name='2202'>
      if(delt.le.dtcldcr) dtcld = delt<a name='2203'>
<font color=#447700>!<a name='2204'></font>
      do loop = 1,loops<a name='2205'>
<font color=#447700>!<a name='2206'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2207'></font>
<font color=#447700>!     initialize the large scale variables<a name='2208'></font>
<font color=#447700>!<a name='2209'></font>
      do i = its, ite<a name='2210'>
        mstep(i) = 1<a name='2211'>
        flgcld(i) = .true.<a name='2212'>
      enddo<a name='2213'>
<font color=#447700>!<a name='2214'></font>
<font color=#447700>!     do k = kts, kte<a name='2215'></font>
<font color=#447700>!       do i = its, ite<a name='2216'></font>
<font color=#447700>!         denfac(i,k) = sqrt(den0/den(i,k))<a name='2217'></font>
<font color=#447700>!       enddo<a name='2218'></font>
<font color=#447700>!     enddo<a name='2219'></font>
      do k = kts, kte<a name='2220'>
        CALL <A href='../../html_code/frame/libmassv.F.html#VREC'>VREC</A><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM52D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VREC_6">( tvec1(its), den(its,k), ite-its+1)<a name='2221'>
        do i = its, ite<a name='2222'>
          tvec1(i) = tvec1(i)*den0<a name='2223'>
        enddo<a name='2224'>
        CALL <A href='../../html_code/frame/libmassv.F.html#VSQRT'>VSQRT</A><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM52D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VSQRT_6">( denfac(its,k), tvec1(its), ite-its+1)<a name='2225'>
      enddo<a name='2226'>
<font color=#447700>!<a name='2227'></font>
<font color=#447700>! Inline expansion for fpvs<a name='2228'></font>
<font color=#447700>!         qs(i,k,1) = fpvs(t(i,k),0,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='2229'></font>
<font color=#447700>!         qs(i,k,2) = fpvs(t(i,k),1,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='2230'></font>
      hsub = xls<a name='2231'>
      hvap = xlv0<a name='2232'>
      cvap = cpv<a name='2233'>
      ttp=t0c+0.01<a name='2234'>
      dldt=cvap-cliq<a name='2235'>
      xa=-dldt/rv<a name='2236'>
      xb=xa+hvap/(rv*ttp)<a name='2237'>
      dldti=cvap-cice<a name='2238'>
      xai=-dldti/rv<a name='2239'>
      xbi=xai+hsub/(rv*ttp)<a name='2240'>
<a name='2241'>
<font color=#447700>! this is for compilers where the conditional inhibits vectorization<a name='2242'></font>
#ifdef WSM_NO_CONDITIONAL_IN_VECTOR<a name='2243'>
      do k = kts, kte<a name='2244'>
        do i = its, ite<a name='2245'>
          if(t(i,k).lt.ttp) then<a name='2246'>
            xal(i) = xai<a name='2247'>
            xbl(i) = xbi<a name='2248'>
          else<a name='2249'>
            xal(i) = xa<a name='2250'>
            xbl(i) = xb<a name='2251'>
          endif<a name='2252'>
        enddo<a name='2253'>
        do i = its, ite<a name='2254'>
          tr=ttp/t(i,k)<a name='2255'>
          logtr=log(tr)<a name='2256'>
          qs(i,k,1)=psat*exp(logtr*(xa)+xb*(1.-tr))<a name='2257'>
          qs(i,k,1) = ep2 * qs(i,k,1) / (p(i,k) - qs(i,k,1))<a name='2258'>
          qs(i,k,1) = max(qs(i,k,1),qmin)<a name='2259'>
          rh(i,k,1) = max(q(i,k) / qs(i,k,1),qmin)<a name='2260'>
          qs(i,k,2)=psat*exp(logtr*(xal(i))+xbl(i)*(1.-tr))<a name='2261'>
          qs(i,k,2) = ep2 * qs(i,k,2) / (p(i,k) - qs(i,k,2))<a name='2262'>
          qs(i,k,2) = max(qs(i,k,2),qmin)<a name='2263'>
          rh(i,k,2) = max(q(i,k) / qs(i,k,2),qmin)<a name='2264'>
        enddo<a name='2265'>
      enddo<a name='2266'>
#else<a name='2267'>
      do k = kts, kte<a name='2268'>
        do i = its, ite<a name='2269'>
          tr=ttp/t(i,k)<a name='2270'>
          logtr=log(tr)<a name='2271'>
          qs(i,k,1)=psat*exp(logtr*(xa)+xb*(1.-tr))<a name='2272'>
          qs(i,k,1) = ep2 * qs(i,k,1) / (p(i,k) - qs(i,k,1))<a name='2273'>
          qs(i,k,1) = max(qs(i,k,1),qmin)<a name='2274'>
          rh(i,k,1) = max(q(i,k) / qs(i,k,1),qmin)<a name='2275'>
          if(t(i,k).lt.ttp) then<a name='2276'>
            qs(i,k,2)=psat*exp(logtr*(xai)+xbi*(1.-tr))<a name='2277'>
          else<a name='2278'>
            qs(i,k,2)=psat*exp(logtr*(xa)+xb*(1.-tr))<a name='2279'>
          endif<a name='2280'>
          qs(i,k,2) = ep2 * qs(i,k,2) / (p(i,k) - qs(i,k,2))<a name='2281'>
          qs(i,k,2) = max(qs(i,k,2),qmin)<a name='2282'>
          rh(i,k,2) = max(q(i,k) / qs(i,k,2),qmin)<a name='2283'>
        enddo<a name='2284'>
      enddo<a name='2285'>
#endif<a name='2286'>
<font color=#447700>!<a name='2287'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2288'></font>
<font color=#447700>!     initialize the variables for microphysical physics<a name='2289'></font>
<font color=#447700>!<a name='2290'></font>
<font color=#447700>!<a name='2291'></font>
      do k = kts, kte<a name='2292'>
        do i = its, ite<a name='2293'>
          prevp(i,k) = 0.<a name='2294'>
          psdep(i,k) = 0.<a name='2295'>
          praut(i,k) = 0.<a name='2296'>
          psaut(i,k) = 0.<a name='2297'>
          pracw(i,k) = 0.<a name='2298'>
          psaci(i,k) = 0.<a name='2299'>
          psacw(i,k) = 0.<a name='2300'>
          pigen(i,k) = 0.<a name='2301'>
          pidep(i,k) = 0.<a name='2302'>
          pcond(i,k) = 0.<a name='2303'>
          psmlt(i,k) = 0.<a name='2304'>
          psevp(i,k) = 0.<a name='2305'>
          falk(i,k,1) = 0.<a name='2306'>
          falk(i,k,2) = 0.<a name='2307'>
          fall(i,k,1) = 0.<a name='2308'>
          fall(i,k,2) = 0.<a name='2309'>
          fallc(i,k) = 0.<a name='2310'>
          falkc(i,k) = 0.<a name='2311'>
          xni(i,k) = 1.e3<a name='2312'>
        enddo<a name='2313'>
      enddo<a name='2314'>
<font color=#447700>!<a name='2315'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2316'></font>
<font color=#447700>!     compute the fallout term:<a name='2317'></font>
<font color=#447700>!     first, vertical terminal velosity for minor loops<a name='2318'></font>
<font color=#447700>!<a name='2319'></font>
      do k = kts, kte<a name='2320'>
        do i = its, ite<a name='2321'>
          supcol = t0c-t(i,k)<a name='2322'>
<font color=#447700>!---------------------------------------------------------------<a name='2323'></font>
<font color=#447700>! n0s: Intercept parameter for snow [m-4] [HDC 6]<a name='2324'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2325'></font>
          n0sfac(i,k) = max(min(exp(alpha*supcol),n0smax/n0s),1.)<a name='2326'>
          if(qrs(i,k,1).le.qcrmin)then<a name='2327'>
            rslope(i,k,1) = rslopermax<a name='2328'>
            rslopeb(i,k,1) = rsloperbmax<a name='2329'>
            rslope2(i,k,1) = rsloper2max<a name='2330'>
            rslope3(i,k,1) = rsloper3max<a name='2331'>
          else<a name='2332'>
            rslope(i,k,1) = 1./lamdar(qrs(i,k,1),den(i,k))<a name='2333'>
            rslopeb(i,k,1) = exp(log(rslope(i,k,1))*(bvtr))<a name='2334'>
            rslope2(i,k,1) = rslope(i,k,1)*rslope(i,k,1)<a name='2335'>
            rslope3(i,k,1) = rslope2(i,k,1)*rslope(i,k,1)<a name='2336'>
          endif<a name='2337'>
          if(qrs(i,k,2).le.qcrmin)then<a name='2338'>
            rslope(i,k,2) = rslopesmax<a name='2339'>
            rslopeb(i,k,2) = rslopesbmax<a name='2340'>
            rslope2(i,k,2) = rslopes2max<a name='2341'>
            rslope3(i,k,2) = rslopes3max<a name='2342'>
          else<a name='2343'>
            rslope(i,k,2) = 1./lamdas(qrs(i,k,2),den(i,k),n0sfac(i,k))<a name='2344'>
            rslopeb(i,k,2) = exp(log(rslope(i,k,2))*(bvts))<a name='2345'>
            rslope2(i,k,2) = rslope(i,k,2)*rslope(i,k,2)<a name='2346'>
            rslope3(i,k,2) = rslope2(i,k,2)*rslope(i,k,2)<a name='2347'>
          endif<a name='2348'>
<font color=#447700>!-------------------------------------------------------------<a name='2349'></font>
<font color=#447700>! Ni: ice crystal number concentraiton   [HDC 5c]<a name='2350'></font>
<font color=#447700>!-------------------------------------------------------------<a name='2351'></font>
<font color=#447700>!         xni(i,k) = min(max(5.38e7*(den(i,k)                                  &amp;<a name='2352'></font>
<font color=#447700>!                   *max(qci(i,k,2),qmin))**0.75,1.e3),1.e6)<a name='2353'></font>
          temp = (den(i,k)*max(qci(i,k,2),qmin))<a name='2354'>
          temp = sqrt(sqrt(temp*temp*temp))<a name='2355'>
          xni(i,k) = min(max(5.38e7*temp,1.e3),1.e6)<a name='2356'>
        enddo<a name='2357'>
      enddo<a name='2358'>
<font color=#447700>!<a name='2359'></font>
      mstepmax = 1<a name='2360'>
      numdt = 1<a name='2361'>
      do k = kte, kts, -1<a name='2362'>
        do i = its, ite<a name='2363'>
          work1(i,k,1) = pvtr*rslopeb(i,k,1)*denfac(i,k)/delz(i,k)<a name='2364'>
          work1(i,k,2) = pvts*rslopeb(i,k,2)*denfac(i,k)/delz(i,k)<a name='2365'>
          numdt(i) = max(nint(max(work1(i,k,1),work1(i,k,2))*dtcld+.5),1)<a name='2366'>
          if(numdt(i).ge.mstep(i)) mstep(i) = numdt(i)<a name='2367'>
        enddo<a name='2368'>
      enddo<a name='2369'>
      do i = its, ite<a name='2370'>
        if(mstepmax.le.mstep(i)) mstepmax = mstep(i)<a name='2371'>
        rmstep(i) = 1./mstep(i)<a name='2372'>
      enddo<a name='2373'>
<font color=#447700>!<a name='2374'></font>
      do n = 1, mstepmax<a name='2375'>
        k = kte<a name='2376'>
        do i = its, ite<a name='2377'>
          if(n.le.mstep(i)) then<a name='2378'>
<font color=#447700>!             falk(i,k,1) = den(i,k)*qrs(i,k,1)*work1(i,k,1)/mstep(i)<a name='2379'></font>
<font color=#447700>!             falk(i,k,2) = den(i,k)*qrs(i,k,2)*work1(i,k,2)/mstep(i)<a name='2380'></font>
              falk(i,k,1) = den(i,k)*qrs(i,k,1)*work1(i,k,1)*rmstep(i)<a name='2381'>
              falk(i,k,2) = den(i,k)*qrs(i,k,2)*work1(i,k,2)*rmstep(i)<a name='2382'>
              fall(i,k,1) = fall(i,k,1)+falk(i,k,1)<a name='2383'>
              fall(i,k,2) = fall(i,k,2)+falk(i,k,2)<a name='2384'>
<font color=#447700>!             qrs(i,k,1) = max(qrs(i,k,1)-falk(i,k,1)*dtcld/den(i,k),0.)<a name='2385'></font>
<font color=#447700>!             qrs(i,k,2) = max(qrs(i,k,2)-falk(i,k,2)*dtcld/den(i,k),0.)<a name='2386'></font>
              dtcldden = dtcld/den(i,k)<a name='2387'>
              qrs(i,k,1) = max(qrs(i,k,1)-falk(i,k,1)*dtcldden,0.)<a name='2388'>
              qrs(i,k,2) = max(qrs(i,k,2)-falk(i,k,2)*dtcldden,0.)<a name='2389'>
            endif<a name='2390'>
          enddo<a name='2391'>
        do k = kte-1, kts, -1<a name='2392'>
          do i = its, ite<a name='2393'>
            if(n.le.mstep(i)) then<a name='2394'>
              falk(i,k,1) = den(i,k)*qrs(i,k,1)*work1(i,k,1)*rmstep(i)<a name='2395'>
              falk(i,k,2) = den(i,k)*qrs(i,k,2)*work1(i,k,2)*rmstep(i)<a name='2396'>
              fall(i,k,1) = fall(i,k,1)+falk(i,k,1)<a name='2397'>
              fall(i,k,2) = fall(i,k,2)+falk(i,k,2)<a name='2398'>
              dtcldden = dtcld/den(i,k)<a name='2399'>
              rdelz = 1./delz(i,k)<a name='2400'>
              qrs(i,k,1) = max(qrs(i,k,1)-(falk(i,k,1)-falk(i,k+1,1)           &amp;<a name='2401'>
                          *delz(i,k+1)*rdelz)*dtcldden,0.)<a name='2402'>
              qrs(i,k,2) = max(qrs(i,k,2)-(falk(i,k,2)-falk(i,k+1,2)           &amp;<a name='2403'>
                          *delz(i,k+1)*rdelz)*dtcldden,0.)<a name='2404'>
            endif<a name='2405'>
          enddo<a name='2406'>
        enddo<a name='2407'>
        do k = kte, kts, -1<a name='2408'>
          do i = its, ite<a name='2409'>
            if(n.le.mstep(i)) then<a name='2410'>
              if(t(i,k).gt.t0c.and.qrs(i,k,2).gt.0.) then<a name='2411'>
<font color=#447700>!----------------------------------------------------------------<a name='2412'></font>
<font color=#447700>! psmlt: melting of snow [HL A33] [RH83 A25]<a name='2413'></font>
<font color=#447700>!       (T&gt;T0: S-&gt;R)<a name='2414'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2415'></font>
                xlf = xlf0<a name='2416'>
<font color=#447700>!               work2(i,k)= venfac(p(i,k),t(i,k),den(i,k))<a name='2417'></font>
                work2(i,k)= (exp(log(((1.496e-6*((t(i,k))*sqrt(t(i,k)))        &amp;<a name='2418'>
                            /((t(i,k))+120.)/(den(i,k)))/(8.794e-5             &amp;<a name='2419'>
                            *exp(log(t(i,k))*(1.81))/p(i,k))))                 &amp;<a name='2420'>
                            *((.3333333)))/sqrt((1.496e-6*((t(i,k))            &amp;<a name='2421'>
                            *sqrt(t(i,k)))/((t(i,k))+120.)/(den(i,k))))        &amp;<a name='2422'>
                            *sqrt(sqrt(den0/(den(i,k)))))<a name='2423'>
                coeres = rslope2(i,k,2)*sqrt(rslope(i,k,2)*rslopeb(i,k,2))<a name='2424'>
<font color=#447700>!               psmlt(i,k) = xka(t(i,k),den(i,k))/xlf*(t0c-t(i,k))*pi/2.       &amp;<a name='2425'></font>
<font color=#447700>!                           *n0sfac(i,k)*(precs1*rslope2(i,k,2)+precs2         &amp;<a name='2426'></font>
<font color=#447700>!                           *work2(i,k)*coeres)<a name='2427'></font>
                psmlt(i,k) = (1.414e3*(1.496e-6*((t(i,k))*sqrt(t(i,k)))        &amp;         <a name='2428'>
                            /((t(i,k))+120.)/(den(i,k)) )*(den(i,k)))          &amp;<a name='2429'>
                            /xlf*(t0c-t(i,k))*pi/2.                            &amp;<a name='2430'>
                            *n0sfac(i,k)*(precs1*rslope2(i,k,2)+precs2         &amp;<a name='2431'>
                            *work2(i,k)*coeres)<a name='2432'>
                psmlt(i,k) = min(max(psmlt(i,k)*dtcld/mstep(i),                &amp;<a name='2433'>
                            -qrs(i,k,2)/mstep(i)),0.)<a name='2434'>
                qrs(i,k,2) = qrs(i,k,2) + psmlt(i,k)<a name='2435'>
                qrs(i,k,1) = qrs(i,k,1) - psmlt(i,k)<a name='2436'>
                t(i,k) = t(i,k) + xlf/cpm(i,k)*psmlt(i,k)<a name='2437'>
              endif<a name='2438'>
            endif<a name='2439'>
          enddo<a name='2440'>
        enddo<a name='2441'>
      enddo<a name='2442'>
<font color=#447700>!---------------------------------------------------------------<a name='2443'></font>
<font color=#447700>! Vice [ms-1] : fallout of ice crystal [HDC 5a]<a name='2444'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2445'></font>
      mstepmax = 1<a name='2446'>
      mstep = 1<a name='2447'>
      numdt = 1<a name='2448'>
      do k = kte, kts, -1<a name='2449'>
        do i = its, ite<a name='2450'>
          if(qci(i,k,2).le.0.) then<a name='2451'>
            work2c(i,k) = 0.<a name='2452'>
          else<a name='2453'>
            xmi = den(i,k)*qci(i,k,2)/xni(i,k)<a name='2454'>
<font color=#447700>!           diameter  = min(dicon * sqrt(xmi),dimax)<a name='2455'></font>
            diameter  = max(min(dicon * sqrt(xmi),dimax), 1.e-25)<a name='2456'>
            work1c(i,k) = 1.49e4*exp(log(diameter)*(1.31))<a name='2457'>
            work2c(i,k) = work1c(i,k)/delz(i,k)<a name='2458'>
          endif<a name='2459'>
          numdt(i) = max(nint(work2c(i,k)*dtcld+.5),1)<a name='2460'>
          if(numdt(i).ge.mstep(i)) mstep(i) = numdt(i)<a name='2461'>
        enddo<a name='2462'>
      enddo<a name='2463'>
      do i = its, ite<a name='2464'>
        if(mstepmax.le.mstep(i)) mstepmax = mstep(i)<a name='2465'>
      enddo<a name='2466'>
<font color=#447700>!<a name='2467'></font>
      do n = 1, mstepmax<a name='2468'>
        k = kte<a name='2469'>
        do i = its, ite<a name='2470'>
          if(n.le.mstep(i)) then<a name='2471'>
            falkc(i,k) = den(i,k)*qci(i,k,2)*work2c(i,k)/mstep(i)<a name='2472'>
            holdc = falkc(i,k)<a name='2473'>
            fallc(i,k) = fallc(i,k)+falkc(i,k)<a name='2474'>
            holdci = qci(i,k,2)<a name='2475'>
            qci(i,k,2) = max(qci(i,k,2)-falkc(i,k)*dtcld/den(i,k),0.)<a name='2476'>
          endif<a name='2477'>
        enddo<a name='2478'>
        do k = kte-1, kts, -1<a name='2479'>
          do i = its, ite<a name='2480'>
            if(n.le.mstep(i)) then<a name='2481'>
              falkc(i,k) = den(i,k)*qci(i,k,2)*work2c(i,k)/mstep(i)<a name='2482'>
              holdc = falkc(i,k)<a name='2483'>
              fallc(i,k) = fallc(i,k)+falkc(i,k)<a name='2484'>
              holdci = qci(i,k,2)<a name='2485'>
              qci(i,k,2) = max(qci(i,k,2)-(falkc(i,k)-falkc(i,k+1)             &amp;<a name='2486'>
                          *delz(i,k+1)/delz(i,k))*dtcld/den(i,k),0.)<a name='2487'>
            endif<a name='2488'>
          enddo<a name='2489'>
        enddo<a name='2490'>
      enddo<a name='2491'>
<font color=#447700>!<a name='2492'></font>
<font color=#447700>!<a name='2493'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2494'></font>
<font color=#447700>!      rain (unit is mm/sec;kgm-2s-1: /1000*delt ===&gt; m)==&gt; mm for wrf<a name='2495'></font>
<font color=#447700>!<a name='2496'></font>
      do i = its, ite<a name='2497'>
        fallsum = fall(i,1,1)+fall(i,1,2)+fallc(i,1)<a name='2498'>
        fallsum_qsi = fall(i,1,2)+fallc(i,1)<a name='2499'>
        rainncv(i) = 0.<a name='2500'>
        if(fallsum.gt.0.) then<a name='2501'>
          rainncv(i) = fallsum*delz(i,1)/denr*dtcld*1000.<a name='2502'>
          rain(i) = fallsum*delz(i,1)/denr*dtcld*1000. + rain(i)<a name='2503'>
        endif<a name='2504'>
        IF ( PRESENT (snowncv) .AND. PRESENT (snow)) THEN<a name='2505'>
        snowncv(i,lat) = 0.<a name='2506'>
        if(fallsum_qsi.gt.0.) then<a name='2507'>
          snowncv(i,lat) = fallsum_qsi*delz(i,kts)/denr*dtcld*1000.<a name='2508'>
          snow(i,lat) = fallsum_qsi*delz(i,kts)/denr*dtcld*1000. + snow(i,lat)<a name='2509'>
        endif<a name='2510'>
        ENDIF<a name='2511'>
        sr(i) = 0.<a name='2512'>
        if(fallsum.gt.0.)sr(i)=fallsum_qsi*delz(i,kts)/denr*dtcld*1000.        &amp;    <a name='2513'>
        /(rainncv(i)+1.e-12)<a name='2514'>
      enddo<a name='2515'>
<font color=#447700>!<a name='2516'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2517'></font>
<font color=#447700>! pimlt: instantaneous melting of cloud ice [HL A47] [RH83 A28]<a name='2518'></font>
<font color=#447700>!       (T&gt;T0: I-&gt;C)<a name='2519'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2520'></font>
      do k = kts, kte<a name='2521'>
        do i = its, ite<a name='2522'>
          supcol = t0c-t(i,k)<a name='2523'>
          xlf = xls-xl(i,k)<a name='2524'>
          if(supcol.lt.0.) xlf = xlf0<a name='2525'>
          if(supcol.lt.0.and.qci(i,k,2).gt.0.) then<a name='2526'>
            qci(i,k,1) = qci(i,k,1) + qci(i,k,2)<a name='2527'>
            t(i,k) = t(i,k) - xlf/cpm(i,k)*qci(i,k,2)<a name='2528'>
            qci(i,k,2) = 0.<a name='2529'>
          endif<a name='2530'>
<font color=#447700>!---------------------------------------------------------------<a name='2531'></font>
<font color=#447700>! pihmf: homogeneous freezing of cloud water below -40c [HL A45]<a name='2532'></font>
<font color=#447700>!        (T&lt;-40C: C-&gt;I)<a name='2533'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2534'></font>
          if(supcol.gt.40..and.qci(i,k,1).gt.0.) then<a name='2535'>
            qci(i,k,2) = qci(i,k,2) + qci(i,k,1)<a name='2536'>
            t(i,k) = t(i,k) + xlf/cpm(i,k)*qci(i,k,1)<a name='2537'>
            qci(i,k,1) = 0.<a name='2538'>
          endif<a name='2539'>
<font color=#447700>!---------------------------------------------------------------<a name='2540'></font>
<font color=#447700>! pihtf: heterogeneous freezing of cloud water [HL A44]<a name='2541'></font>
<font color=#447700>!        (T0&gt;T&gt;-40C: C-&gt;I)<a name='2542'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2543'></font>
          if(supcol.gt.0..and.qci(i,k,1).gt.0.) then<a name='2544'>
            supcolt=min(supcol,50.)<a name='2545'>
<font color=#447700>!           pfrzdtc = min(pfrz1*(exp(pfrz2*supcol)-1.)                         &amp;<a name='2546'></font>
<font color=#447700>!              *den(i,k)/denr/xncr*qci(i,k,1)**2*dtcld,qci(i,k,1))<a name='2547'></font>
            pfrzdtc = min(pfrz1*(exp(pfrz2*supcolt)-1.)                        &amp;<a name='2548'>
            *den(i,k)/denr/xncr*qci(i,k,1)*qci(i,k,1)*dtcld,qci(i,k,1))<a name='2549'>
            qci(i,k,2) = qci(i,k,2) + pfrzdtc<a name='2550'>
            t(i,k) = t(i,k) + xlf/cpm(i,k)*pfrzdtc<a name='2551'>
            qci(i,k,1) = qci(i,k,1)-pfrzdtc<a name='2552'>
          endif<a name='2553'>
<font color=#447700>!---------------------------------------------------------------<a name='2554'></font>
<font color=#447700>! psfrz: freezing of rain water [HL A20] [LFO 45]<a name='2555'></font>
<font color=#447700>!        (T&lt;T0, R-&gt;S)<a name='2556'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2557'></font>
          if(supcol.gt.0..and.qrs(i,k,1).gt.0.) then<a name='2558'>
            supcolt=min(supcol,50.)<a name='2559'>
<font color=#447700>!           pfrzdtr = min(20.*pi**2*pfrz1*n0r*denr/den(i,k)                    &amp;<a name='2560'></font>
<font color=#447700>!                 *(exp(pfrz2*supcol)-1.)*rslope(i,k,1)**7*dtcld,              &amp;<a name='2561'></font>
<font color=#447700>!                 qrs(i,k,1))<a name='2562'></font>
            temp = rslope(i,k,1)<a name='2563'>
            temp = temp*temp*temp*temp*temp*temp*temp<a name='2564'>
            pfrzdtr = min(20.*(pi*pi)*pfrz1*n0r*denr/den(i,k)                  &amp;<a name='2565'>
                  *(exp(pfrz2*supcolt)-1.)*temp*dtcld,                         &amp;<a name='2566'>
                  qrs(i,k,1))<a name='2567'>
            qrs(i,k,2) = qrs(i,k,2) + pfrzdtr<a name='2568'>
            t(i,k) = t(i,k) + xlf/cpm(i,k)*pfrzdtr<a name='2569'>
            qrs(i,k,1) = qrs(i,k,1)-pfrzdtr<a name='2570'>
          endif<a name='2571'>
        enddo<a name='2572'>
      enddo<a name='2573'>
<font color=#447700>!<a name='2574'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2575'></font>
<font color=#447700>!     rsloper: reverse of the slope parameter of the rain(m)<a name='2576'></font>
<font color=#447700>!     xka:    thermal conductivity of air(jm-1s-1k-1)<a name='2577'></font>
<font color=#447700>!     work1:  the thermodynamic term in the denominator associated with<a name='2578'></font>
<font color=#447700>!             heat conduction and vapor diffusion<a name='2579'></font>
<font color=#447700>!             (ry88, y93, h85)<a name='2580'></font>
<font color=#447700>!     work2: parameter associated with the ventilation effects(y93)<a name='2581'></font>
<font color=#447700>!<a name='2582'></font>
      do k = kts, kte<a name='2583'>
        do i = its, ite<a name='2584'>
          if(qrs(i,k,1).le.qcrmin)then<a name='2585'>
            rslope(i,k,1) = rslopermax<a name='2586'>
            rslopeb(i,k,1) = rsloperbmax<a name='2587'>
            rslope2(i,k,1) = rsloper2max<a name='2588'>
            rslope3(i,k,1) = rsloper3max<a name='2589'>
          else<a name='2590'>
<font color=#447700>!           rslope(i,k,1) = 1./lamdar(qrs(i,k,1),den(i,k))<a name='2591'></font>
            rslope(i,k,1) = 1./(sqrt(sqrt(pidn0r/((qrs(i,k,1))*(den(i,k))))))<a name='2592'>
            rslopeb(i,k,1) = exp(log(rslope(i,k,1))*(bvtr))<a name='2593'>
            rslope2(i,k,1) = rslope(i,k,1)*rslope(i,k,1)<a name='2594'>
            rslope3(i,k,1) = rslope2(i,k,1)*rslope(i,k,1)<a name='2595'>
          endif<a name='2596'>
          if(qrs(i,k,2).le.qcrmin)then<a name='2597'>
            rslope(i,k,2) = rslopesmax<a name='2598'>
            rslopeb(i,k,2) = rslopesbmax<a name='2599'>
            rslope2(i,k,2) = rslopes2max<a name='2600'>
            rslope3(i,k,2) = rslopes3max<a name='2601'>
          else<a name='2602'>
<font color=#447700>!            rslope(i,k,2) = 1./lamdas(qrs(i,k,2),den(i,k),n0sfac(i,k))<a name='2603'></font>
            rslope(i,k,2) = 1./(sqrt(sqrt(pidn0s*(n0sfac(i,k))/((qrs(i,k,2))   &amp;  <a name='2604'>
                          *(den(i,k))))))<a name='2605'>
            rslopeb(i,k,2) = exp(log(rslope(i,k,2))*(bvts))<a name='2606'>
            rslope2(i,k,2) = rslope(i,k,2)*rslope(i,k,2)<a name='2607'>
            rslope3(i,k,2) = rslope2(i,k,2)*rslope(i,k,2)<a name='2608'>
          endif<a name='2609'>
        enddo<a name='2610'>
      enddo<a name='2611'>
<font color=#447700>!<a name='2612'></font>
      do k = kts, kte<a name='2613'>
        do i = its, ite<a name='2614'>
<font color=#447700>!         work1(i,k,1) = diffac(xl(i,k),p(i,k),t(i,k),den(i,k),qs(i,k,1))<a name='2615'></font>
          work1(i,k,1) = ((((den(i,k))*(xl(i,k))*(xl(i,k)))*((t(i,k))+120.)    &amp;<a name='2616'>
                       *(den(i,k)))/(1.414e3*(1.496e-6*((t(i,k))*sqrt(t(i,k))))&amp;<a name='2617'>
                       *(den(i,k))*(rv*(t(i,k))*(t(i,k)))))                    &amp;<a name='2618'>
                      +  p(i,k)/((qs(i,k,1))*(8.794e-5*exp(log(t(i,k))*(1.81))))<a name='2619'>
<font color=#447700>!         work1(i,k,2) = diffac(xls,p(i,k),t(i,k),den(i,k),qs(i,k,2))<a name='2620'></font>
          work1(i,k,2) = ((((den(i,k))*(xls)*(xls))*((t(i,k))+120.)*(den(i,k)))&amp;<a name='2621'>
                       /(1.414e3*(1.496e-6*((t(i,k))*sqrt(t(i,k))))*(den(i,k)) &amp;<a name='2622'>
                       *(rv*(t(i,k))*(t(i,k))))                                &amp;<a name='2623'>
                      + p(i,k)/(qs(i,k,2)*(8.794e-5*exp(log(t(i,k))*(1.81)))))<a name='2624'>
<font color=#447700>!         work2(i,k) = venfac(p(i,k),t(i,k),den(i,k))<a name='2625'></font>
          work2(i,k) = (exp(.3333333*log(((1.496e-6 * ((t(i,k))*sqrt(t(i,k)))) &amp;<a name='2626'>
                     *p(i,k))/(((t(i,k))+120.)*den(i,k)*(8.794e-5              &amp;<a name='2627'>
                     *exp(log(t(i,k))*(1.81))))))*sqrt(sqrt(den0/(den(i,k))))) &amp;<a name='2628'>
                      /sqrt((1.496e-6*((t(i,k))*sqrt(t(i,k))))                 &amp;<a name='2629'>
                      /(((t(i,k))+120.)*den(i,k)))<a name='2630'>
        enddo <a name='2631'>
      enddo <a name='2632'>
<font color=#447700>!<a name='2633'></font>
<font color=#447700>!===============================================================<a name='2634'></font>
<font color=#447700>!<a name='2635'></font>
<font color=#447700>! warm rain processes<a name='2636'></font>
<font color=#447700>!<a name='2637'></font>
<font color=#447700>! - follows the processes in RH83 and LFO except for autoconcersion<a name='2638'></font>
<font color=#447700>!<a name='2639'></font>
<font color=#447700>!===============================================================<a name='2640'></font>
<font color=#447700>!<a name='2641'></font>
      do k = kts, kte<a name='2642'>
        do i = its, ite<a name='2643'>
          supsat = max(q(i,k),qmin)-qs(i,k,1)<a name='2644'>
          satdt = supsat/dtcld<a name='2645'>
<font color=#447700>!---------------------------------------------------------------<a name='2646'></font>
<font color=#447700>! praut: auto conversion rate from cloud to rain [HDC 16]<a name='2647'></font>
<font color=#447700>!        (C-&gt;R)<a name='2648'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2649'></font>
          if(qci(i,k,1).gt.qc0) then<a name='2650'>
            praut(i,k) = qck1*exp(log(qci(i,k,1))*((7./3.)))<a name='2651'>
            praut(i,k) = min(praut(i,k),qci(i,k,1)/dtcld)<a name='2652'>
          endif<a name='2653'>
<font color=#447700>!---------------------------------------------------------------<a name='2654'></font>
<font color=#447700>! pracw: accretion of cloud water by rain [HL A40] [LFO 51]<a name='2655'></font>
<font color=#447700>!        (C-&gt;R)<a name='2656'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2657'></font>
          if(qrs(i,k,1).gt.qcrmin.and.qci(i,k,1).gt.qmin) then<a name='2658'>
            pracw(i,k) = min(pacrr*rslope3(i,k,1)*rslopeb(i,k,1)               &amp; <a name='2659'>
                         *qci(i,k,1)*denfac(i,k),qci(i,k,1)/dtcld)<a name='2660'>
          endif<a name='2661'>
<font color=#447700>!---------------------------------------------------------------<a name='2662'></font>
<font color=#447700>! prevp: evaporation/condensation rate of rain [HDC 14]<a name='2663'></font>
<font color=#447700>!        (V-&gt;R or R-&gt;V)<a name='2664'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2665'></font>
          if(qrs(i,k,1).gt.0.) then<a name='2666'>
            coeres = rslope2(i,k,1)*sqrt(rslope(i,k,1)*rslopeb(i,k,1))<a name='2667'>
            prevp(i,k) = (rh(i,k,1)-1.)*(precr1*rslope2(i,k,1)                 &amp;<a name='2668'>
                         +precr2*work2(i,k)*coeres)/work1(i,k,1)<a name='2669'>
            if(prevp(i,k).lt.0.) then<a name='2670'>
              prevp(i,k) = max(prevp(i,k),-qrs(i,k,1)/dtcld)<a name='2671'>
              prevp(i,k) = max(prevp(i,k),satdt/2)<a name='2672'>
            else<a name='2673'>
              prevp(i,k) = min(prevp(i,k),satdt/2)<a name='2674'>
            endif<a name='2675'>
          endif<a name='2676'>
        enddo<a name='2677'>
      enddo<a name='2678'>
<font color=#447700>!<a name='2679'></font>
<font color=#447700>!===============================================================<a name='2680'></font>
<font color=#447700>!<a name='2681'></font>
<font color=#447700>! cold rain processes<a name='2682'></font>
<font color=#447700>!<a name='2683'></font>
<font color=#447700>! - follows the revised ice microphysics processes in HDC<a name='2684'></font>
<font color=#447700>! - the processes same as in RH83 and RH84  and LFO behave<a name='2685'></font>
<font color=#447700>!   following ice crystal hapits defined in HDC, inclduing<a name='2686'></font>
<font color=#447700>!   intercept parameter for snow (n0s), ice crystal number<a name='2687'></font>
<font color=#447700>!   concentration (ni), ice nuclei number concentration<a name='2688'></font>
<font color=#447700>!   (n0i), ice diameter (d)<a name='2689'></font>
<font color=#447700>!<a name='2690'></font>
<font color=#447700>!===============================================================<a name='2691'></font>
<font color=#447700>!<a name='2692'></font>
      rdtcld = 1./dtcld<a name='2693'>
      do k = kts, kte<a name='2694'>
        do i = its, ite<a name='2695'>
          supcol = t0c-t(i,k)<a name='2696'>
          supsat = max(q(i,k),qmin)-qs(i,k,2)<a name='2697'>
          satdt = supsat/dtcld<a name='2698'>
          ifsat = 0<a name='2699'>
<font color=#447700>!-------------------------------------------------------------<a name='2700'></font>
<font color=#447700>! Ni: ice crystal number concentraiton   [HDC 5c]<a name='2701'></font>
<font color=#447700>!-------------------------------------------------------------<a name='2702'></font>
<font color=#447700>!         xni(i,k) = min(max(5.38e7*(den(i,k)                                  &amp;<a name='2703'></font>
<font color=#447700>!                      *max(qci(i,k,2),qmin))**0.75,1.e3),1.e6)<a name='2704'></font>
          temp = (den(i,k)*max(qci(i,k,2),qmin))<a name='2705'>
          temp = sqrt(sqrt(temp*temp*temp))<a name='2706'>
          xni(i,k) = min(max(5.38e7*temp,1.e3),1.e6)<a name='2707'>
          eacrs = exp(0.07*(-supcol))<a name='2708'>
<font color=#447700>!<a name='2709'></font>
          if(supcol.gt.0) then<a name='2710'>
            if(qrs(i,k,2).gt.qcrmin.and.qci(i,k,2).gt.qmin) then<a name='2711'>
              xmi = den(i,k)*qci(i,k,2)/xni(i,k)<a name='2712'>
              diameter  = min(dicon * sqrt(xmi),dimax)<a name='2713'>
              vt2i = 1.49e4*diameter**1.31<a name='2714'>
              vt2s = pvts*rslopeb(i,k,2)*denfac(i,k)<a name='2715'>
<font color=#447700>!-------------------------------------------------------------<a name='2716'></font>
<font color=#447700>! psaci: Accretion of cloud ice by rain [HDC 10]<a name='2717'></font>
<font color=#447700>!        (T&lt;T0: I-&gt;S)<a name='2718'></font>
<font color=#447700>!-------------------------------------------------------------<a name='2719'></font>
              acrfac = 2.*rslope3(i,k,2)+2.*diameter*rslope2(i,k,2)            &amp;<a name='2720'>
                      +diameter**2*rslope(i,k,2)<a name='2721'>
              psaci(i,k) = pi*qci(i,k,2)*eacrs*n0s*n0sfac(i,k)                 &amp;<a name='2722'>
                           *abs(vt2s-vt2i)*acrfac/4.<a name='2723'>
            endif<a name='2724'>
          endif<a name='2725'>
<font color=#447700>!-------------------------------------------------------------<a name='2726'></font>
<font color=#447700>! psacw: Accretion of cloud water by snow  [HL A7] [LFO 24]<a name='2727'></font>
<font color=#447700>!        (T&lt;T0: C-&gt;S, and T&gt;=T0: C-&gt;R)<a name='2728'></font>
<font color=#447700>!-------------------------------------------------------------<a name='2729'></font>
          if(qrs(i,k,2).gt.qcrmin.and.qci(i,k,1).gt.qmin) then<a name='2730'>
            psacw(i,k) = min(pacrc*n0sfac(i,k)*rslope3(i,k,2)                  &amp;<a name='2731'>
                           *rslopeb(i,k,2)*qci(i,k,1)*denfac(i,k)              &amp;<a name='2732'>
<font color=#447700>!                          ,qci(i,k,1)/dtcld)<a name='2733'></font>
                           ,qci(i,k,1)*rdtcld)<a name='2734'>
          endif<a name='2735'>
          if(supcol .gt. 0) then<a name='2736'>
<font color=#447700>!-------------------------------------------------------------<a name='2737'></font>
<font color=#447700>! pidep: Deposition/Sublimation rate of ice [HDC 9]<a name='2738'></font>
<font color=#447700>!       (T&lt;T0: V-&gt;I or I-&gt;V)<a name='2739'></font>
<font color=#447700>!-------------------------------------------------------------<a name='2740'></font>
            if(qci(i,k,2).gt.0.and.ifsat.ne.1) then<a name='2741'>
              xmi = den(i,k)*qci(i,k,2)/xni(i,k)<a name='2742'>
              diameter = dicon * sqrt(xmi)<a name='2743'>
              pidep(i,k) = 4.*diameter*xni(i,k)*(rh(i,k,2)-1.)/work1(i,k,2)<a name='2744'>
              supice = satdt-prevp(i,k)<a name='2745'>
              if(pidep(i,k).lt.0.) then<a name='2746'>
<font color=#447700>!               pidep(i,k) = max(max(pidep(i,k),satdt/2),supice)<a name='2747'></font>
<font color=#447700>!               pidep(i,k) = max(pidep(i,k),-qci(i,k,2)/dtcld)<a name='2748'></font>
                pidep(i,k) = max(max(pidep(i,k),satdt*.5),supice)<a name='2749'>
                pidep(i,k) = max(pidep(i,k),-qci(i,k,2)*rdtcld)<a name='2750'>
              else<a name='2751'>
<font color=#447700>!               pidep(i,k) = min(min(pidep(i,k),satdt/2),supice)<a name='2752'></font>
                pidep(i,k) = min(min(pidep(i,k),satdt*.5),supice)<a name='2753'>
              endif<a name='2754'>
              if(abs(prevp(i,k)+pidep(i,k)).ge.abs(satdt)) ifsat = 1<a name='2755'>
            endif<a name='2756'>
<font color=#447700>!-------------------------------------------------------------<a name='2757'></font>
<font color=#447700>! psdep: deposition/sublimation rate of snow [HDC 14]<a name='2758'></font>
<font color=#447700>!        (V-&gt;S or S-&gt;V)<a name='2759'></font>
<font color=#447700>!-------------------------------------------------------------<a name='2760'></font>
            if(qrs(i,k,2).gt.0..and.ifsat.ne.1) then<a name='2761'>
              coeres = rslope2(i,k,2)*sqrt(rslope(i,k,2)*rslopeb(i,k,2))<a name='2762'>
              psdep(i,k) = (rh(i,k,2)-1.)*n0sfac(i,k)                          &amp;<a name='2763'>
                           *(precs1*rslope2(i,k,2)+precs2                      &amp;<a name='2764'>
                           *work2(i,k)*coeres)/work1(i,k,2)<a name='2765'>
              supice = satdt-prevp(i,k)-pidep(i,k)<a name='2766'>
              if(psdep(i,k).lt.0.) then<a name='2767'>
<font color=#447700>!               psdep(i,k) = max(psdep(i,k),-qrs(i,k,2)/dtcld)<a name='2768'></font>
<font color=#447700>!               psdep(i,k) = max(max(psdep(i,k),satdt/2),supice)<a name='2769'></font>
                psdep(i,k) = max(psdep(i,k),-qrs(i,k,2)*rdtcld)<a name='2770'>
                psdep(i,k) = max(max(psdep(i,k),satdt*.5),supice)<a name='2771'>
              else<a name='2772'>
<font color=#447700>!             psdep(i,k) = min(min(psdep(i,k),satdt/2),supice)<a name='2773'></font>
                psdep(i,k) = min(min(psdep(i,k),satdt*.5),supice)<a name='2774'>
              endif<a name='2775'>
              if(abs(prevp(i,k)+pidep(i,k)+psdep(i,k)).ge.abs(satdt))          &amp;<a name='2776'>
                ifsat = 1<a name='2777'>
            endif<a name='2778'>
<font color=#447700>!-------------------------------------------------------------<a name='2779'></font>
<font color=#447700>! pigen: generation(nucleation) of ice from vapor [HL A50] [HDC 7-8]<a name='2780'></font>
<font color=#447700>!       (T&lt;T0: V-&gt;I)<a name='2781'></font>
<font color=#447700>!-------------------------------------------------------------<a name='2782'></font>
            if(supsat.gt.0.and.ifsat.ne.1) then<a name='2783'>
              supice = satdt-prevp(i,k)-pidep(i,k)-psdep(i,k)<a name='2784'>
              xni0 = 1.e3*exp(0.1*supcol)<a name='2785'>
              roqi0 = 4.92e-11*exp(log(xni0)*(1.33))<a name='2786'>
              pigen(i,k) = max(0.,(roqi0/den(i,k)-max(qci(i,k,2),0.))          &amp;<a name='2787'>
<font color=#447700>!                        /dtcld)<a name='2788'></font>
                         *rdtcld)<a name='2789'>
              pigen(i,k) = min(min(pigen(i,k),satdt),supice)<a name='2790'>
            endif<a name='2791'>
<font color=#447700>!<a name='2792'></font>
<font color=#447700>!-------------------------------------------------------------<a name='2793'></font>
<font color=#447700>! psaut: conversion(aggregation) of ice to snow [HDC 12]<a name='2794'></font>
<font color=#447700>!       (T&lt;T0: I-&gt;S)<a name='2795'></font>
<font color=#447700>!-------------------------------------------------------------<a name='2796'></font>
            if(qci(i,k,2).gt.0.) then<a name='2797'>
              qimax = roqimax/den(i,k)<a name='2798'>
<font color=#447700>!             psaut(i,k) = max(0.,(qci(i,k,2)-qimax)/dtcld)<a name='2799'></font>
              psaut(i,k) = max(0.,(qci(i,k,2)-qimax)*rdtcld)<a name='2800'>
            endif<a name='2801'>
          endif<a name='2802'>
<font color=#447700>!-------------------------------------------------------------<a name='2803'></font>
<font color=#447700>! psevp: Evaporation of melting snow [HL A35] [RH83 A27]<a name='2804'></font>
<font color=#447700>!       (T&gt;T0: S-&gt;V)<a name='2805'></font>
<font color=#447700>!-------------------------------------------------------------<a name='2806'></font>
          if(supcol.lt.0.) then<a name='2807'>
            if(qrs(i,k,2).gt.0..and.rh(i,k,1).lt.1.)                           &amp;<a name='2808'>
              psevp(i,k) = psdep(i,k)*work1(i,k,2)/work1(i,k,1)<a name='2809'>
<font color=#447700>!              psevp(i,k) = min(max(psevp(i,k),-qrs(i,k,2)/dtcld),0.)<a name='2810'></font>
              psevp(i,k) = min(max(psevp(i,k),-qrs(i,k,2)*rdtcld),0.)<a name='2811'>
          endif<a name='2812'>
        enddo<a name='2813'>
      enddo<a name='2814'>
<font color=#447700>!<a name='2815'></font>
<font color=#447700>!<a name='2816'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2817'></font>
<font color=#447700>!     check mass conservation of generation terms and feedback to the<a name='2818'></font>
<font color=#447700>!     large scale<a name='2819'></font>
<font color=#447700>!<a name='2820'></font>
      do k = kts, kte<a name='2821'>
        do i = its, ite<a name='2822'>
          if(t(i,k).le.t0c) then<a name='2823'>
<font color=#447700>!<a name='2824'></font>
<font color=#447700>!     cloud water<a name='2825'></font>
<font color=#447700>!<a name='2826'></font>
            value = max(qmin,qci(i,k,1))<a name='2827'>
            source = (praut(i,k)+pracw(i,k)+psacw(i,k))*dtcld<a name='2828'>
            if (source.gt.value) then<a name='2829'>
              factor = value/source<a name='2830'>
              praut(i,k) = praut(i,k)*factor<a name='2831'>
              pracw(i,k) = pracw(i,k)*factor<a name='2832'>
              psacw(i,k) = psacw(i,k)*factor<a name='2833'>
            endif<a name='2834'>
<font color=#447700>!<a name='2835'></font>
<font color=#447700>!     cloud ice<a name='2836'></font>
<font color=#447700>!<a name='2837'></font>
            value = max(qmin,qci(i,k,2))<a name='2838'>
            source = (psaut(i,k)+psaci(i,k)-pigen(i,k)-pidep(i,k))*dtcld<a name='2839'>
            if (source.gt.value) then<a name='2840'>
              factor = value/source<a name='2841'>
              psaut(i,k) = psaut(i,k)*factor<a name='2842'>
              psaci(i,k) = psaci(i,k)*factor<a name='2843'>
              pigen(i,k) = pigen(i,k)*factor<a name='2844'>
              pidep(i,k) = pidep(i,k)*factor<a name='2845'>
            endif<a name='2846'>
<font color=#447700>!<a name='2847'></font>
<font color=#447700>!     rain<a name='2848'></font>
<font color=#447700>!<a name='2849'></font>
<font color=#447700>!<a name='2850'></font>
            value = max(qmin,qrs(i,k,1))<a name='2851'>
            source = (-praut(i,k)-pracw(i,k)-prevp(i,k))*dtcld<a name='2852'>
            if (source.gt.value) then<a name='2853'>
              factor = value/source<a name='2854'>
              praut(i,k) = praut(i,k)*factor<a name='2855'>
              pracw(i,k) = pracw(i,k)*factor<a name='2856'>
              prevp(i,k) = prevp(i,k)*factor<a name='2857'>
            endif<a name='2858'>
<font color=#447700>!<a name='2859'></font>
<font color=#447700>!    snow<a name='2860'></font>
<font color=#447700>!<a name='2861'></font>
            value = max(qmin,qrs(i,k,2))<a name='2862'>
            source = (-psdep(i,k)-psaut(i,k)-psaci(i,k)-psacw(i,k))*dtcld  <a name='2863'>
            if (source.gt.value) then<a name='2864'>
              factor = value/source<a name='2865'>
              psdep(i,k) = psdep(i,k)*factor<a name='2866'>
              psaut(i,k) = psaut(i,k)*factor<a name='2867'>
              psaci(i,k) = psaci(i,k)*factor<a name='2868'>
              psacw(i,k) = psacw(i,k)*factor<a name='2869'>
            endif<a name='2870'>
<font color=#447700>!<a name='2871'></font>
            work2(i,k)=-(prevp(i,k)+psdep(i,k)+pigen(i,k)+pidep(i,k))<a name='2872'>
<font color=#447700>!     update<a name='2873'></font>
            q(i,k) = q(i,k)+work2(i,k)*dtcld<a name='2874'>
            qci(i,k,1) = max(qci(i,k,1)-(praut(i,k)+pracw(i,k)                 &amp;<a name='2875'>
                        +psacw(i,k))*dtcld,0.)<a name='2876'>
            qrs(i,k,1) = max(qrs(i,k,1)+(praut(i,k)+pracw(i,k)                 &amp;<a name='2877'>
                        +prevp(i,k))*dtcld,0.)<a name='2878'>
            qci(i,k,2) = max(qci(i,k,2)-(psaut(i,k)+psaci(i,k)                 &amp;<a name='2879'>
                        -pigen(i,k)-pidep(i,k))*dtcld,0.)<a name='2880'>
            qrs(i,k,2) = max(qrs(i,k,2)+(psdep(i,k)+psaut(i,k)                 &amp;<a name='2881'>
                        +psaci(i,k)+psacw(i,k))*dtcld,0.)<a name='2882'>
            xlf = xls-xl(i,k)<a name='2883'>
            xlwork2 = -xls*(psdep(i,k)+pidep(i,k)+pigen(i,k))                  &amp;<a name='2884'>
                      -xl(i,k)*prevp(i,k)-xlf*psacw(i,k)<a name='2885'>
            t(i,k) = t(i,k)-xlwork2/cpm(i,k)*dtcld<a name='2886'>
          else<a name='2887'>
<font color=#447700>!<a name='2888'></font>
<font color=#447700>!     cloud water<a name='2889'></font>
<font color=#447700>!<a name='2890'></font>
            value = max(qmin,qci(i,k,1))<a name='2891'>
            source=(praut(i,k)+pracw(i,k)+psacw(i,k))*dtcld<a name='2892'>
            if (source.gt.value) then<a name='2893'>
              factor = value/source<a name='2894'>
              praut(i,k) = praut(i,k)*factor<a name='2895'>
              pracw(i,k) = pracw(i,k)*factor<a name='2896'>
              psacw(i,k) = psacw(i,k)*factor<a name='2897'>
            endif<a name='2898'>
<font color=#447700>!<a name='2899'></font>
<font color=#447700>!     rain<a name='2900'></font>
<font color=#447700>!<a name='2901'></font>
            value = max(qmin,qrs(i,k,1))<a name='2902'>
            source = (-praut(i,k)-pracw(i,k)-prevp(i,k)-psacw(i,k))*dtcld<a name='2903'>
            if (source.gt.value) then<a name='2904'>
              factor = value/source<a name='2905'>
              praut(i,k) = praut(i,k)*factor<a name='2906'>
              pracw(i,k) = pracw(i,k)*factor<a name='2907'>
              prevp(i,k) = prevp(i,k)*factor<a name='2908'>
              psacw(i,k) = psacw(i,k)*factor<a name='2909'>
            endif  <a name='2910'>
<font color=#447700>!<a name='2911'></font>
<font color=#447700>!     snow<a name='2912'></font>
<font color=#447700>!<a name='2913'></font>
            value = max(qcrmin,qrs(i,k,2))<a name='2914'>
            source=(-psevp(i,k))*dtcld<a name='2915'>
            if (source.gt.value) then<a name='2916'>
              factor = value/source<a name='2917'>
              psevp(i,k) = psevp(i,k)*factor<a name='2918'>
            endif<a name='2919'>
            work2(i,k)=-(prevp(i,k)+psevp(i,k))<a name='2920'>
<font color=#447700>!     update<a name='2921'></font>
            q(i,k) = q(i,k)+work2(i,k)*dtcld<a name='2922'>
            qci(i,k,1) = max(qci(i,k,1)-(praut(i,k)+pracw(i,k)                 &amp;<a name='2923'>
                        +psacw(i,k))*dtcld,0.)<a name='2924'>
            qrs(i,k,1) = max(qrs(i,k,1)+(praut(i,k)+pracw(i,k)                 &amp;<a name='2925'>
                        +prevp(i,k) +psacw(i,k))*dtcld,0.)<a name='2926'>
            qrs(i,k,2) = max(qrs(i,k,2)+psevp(i,k)*dtcld,0.)<a name='2927'>
            xlf = xls-xl(i,k)<a name='2928'>
            xlwork2 = -xl(i,k)*(prevp(i,k)+psevp(i,k))<a name='2929'>
            t(i,k) = t(i,k)-xlwork2/cpm(i,k)*dtcld<a name='2930'>
          endif<a name='2931'>
        enddo<a name='2932'>
      enddo<a name='2933'>
<font color=#447700>!<a name='2934'></font>
<font color=#447700>! Inline expansion for fpvs<a name='2935'></font>
<font color=#447700>!         qs(i,k,1) = fpvs(t(i,k),0,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='2936'></font>
<font color=#447700>!         qs(i,k,2) = fpvs(t(i,k),1,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='2937'></font>
      hsub = xls<a name='2938'>
      hvap = xlv0<a name='2939'>
      cvap = cpv<a name='2940'>
      ttp=t0c+0.01<a name='2941'>
      dldt=cvap-cliq<a name='2942'>
      xa=-dldt/rv<a name='2943'>
      xb=xa+hvap/(rv*ttp)<a name='2944'>
      dldti=cvap-cice<a name='2945'>
      xai=-dldti/rv<a name='2946'>
      xbi=xai+hsub/(rv*ttp)<a name='2947'>
      do k = kts, kte<a name='2948'>
      do i = its, ite<a name='2949'>
          tr=ttp/t(i,k)<a name='2950'>
          logtr = log(tr)<a name='2951'>
          qs(i,k,1)=psat*exp(logtr*(xa)+xb*(1.-tr))<a name='2952'>
          qs(i,k,1) = ep2 * qs(i,k,1) / (p(i,k) - qs(i,k,1))<a name='2953'>
          qs(i,k,1) = max(qs(i,k,1),qmin)<a name='2954'>
        enddo<a name='2955'>
      enddo<a name='2956'>
<font color=#447700>!<a name='2957'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2958'></font>
<font color=#447700>!  pcond: condensational/evaporational rate of cloud water [HL A46] [RH83 A6]<a name='2959'></font>
<font color=#447700>!     if there exists additional water vapor condensated/if<a name='2960'></font>
<font color=#447700>!     evaporation of cloud water is not enough to remove subsaturation<a name='2961'></font>
<font color=#447700>!<a name='2962'></font>
      do k = kts, kte<a name='2963'>
        do i = its, ite<a name='2964'>
<font color=#447700>!         work1(i,k,1) = conden(t(i,k),q(i,k),qs(i,k,1),xl(i,k),cpm(i,k))<a name='2965'></font>
          work1(i,k,1) = ((max(q(i,k),qmin)-(qs(i,k,1)))/(1.+(xl(i,k))         &amp;   <a name='2966'>
                        *(xl(i,k))/(rv*(cpm(i,k)))*(qs(i,k,1))                 &amp;<a name='2967'>
                        /((t(i,k))*(t(i,k)))))<a name='2968'>
          work2(i,k) = qci(i,k,1)+work1(i,k,1)<a name='2969'>
          pcond(i,k) = min(max(work1(i,k,1)/dtcld,0.),max(q(i,k),0.)/dtcld)<a name='2970'>
          if(qci(i,k,1).gt.0..and.work1(i,k,1).lt.0.)                          &amp;<a name='2971'>
            pcond(i,k) = max(work1(i,k,1),-qci(i,k,1))/dtcld<a name='2972'>
          q(i,k) = q(i,k)-pcond(i,k)*dtcld<a name='2973'>
          qci(i,k,1) = max(qci(i,k,1)+pcond(i,k)*dtcld,0.)<a name='2974'>
          t(i,k) = t(i,k)+pcond(i,k)*xl(i,k)/cpm(i,k)*dtcld<a name='2975'>
        enddo<a name='2976'>
      enddo<a name='2977'>
<font color=#447700>!<a name='2978'></font>
<font color=#447700>!<a name='2979'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2980'></font>
<font color=#447700>!     padding for small values<a name='2981'></font>
<font color=#447700>!<a name='2982'></font>
      do k = kts, kte<a name='2983'>
        do i = its, ite<a name='2984'>
          if(qci(i,k,1).le.qmin) qci(i,k,1) = 0.0<a name='2985'>
          if(qci(i,k,2).le.qmin) qci(i,k,2) = 0.0<a name='2986'>
        enddo<a name='2987'>
      enddo<a name='2988'>
      enddo                  <font color=#447700>! big loops<a name='2989'></font>
  END SUBROUTINE wsm52d<a name='2990'>
<a name='2991'>
#endif<a name='2992'>
<a name='2993'>
<font color=#447700>! ...................................................................<a name='2994'></font>
<A NAME='RGMMA'><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#RGMMA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2995'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>rgmma</font>(x) <A href='../../call_to/RGMMA.html' TARGET='index'>76</A><a name='2996'>
<font color=#447700>!-------------------------------------------------------------------<a name='2997'></font>
  IMPLICIT NONE<a name='2998'>
<font color=#447700>!-------------------------------------------------------------------<a name='2999'></font>
<font color=#447700>!     rgmma function:  use infinite product form<a name='3000'></font>
      REAL :: euler<a name='3001'>
      PARAMETER (euler=0.577215664901532)<a name='3002'>
      REAL :: x, y<a name='3003'>
      INTEGER :: i<a name='3004'>
      if(x.eq.1.)then<a name='3005'>
        rgmma=0.<a name='3006'>
          else<a name='3007'>
        rgmma=x*exp(euler*x)<a name='3008'>
        do i=1,10000<a name='3009'>
          y=float(i)<a name='3010'>
          rgmma=rgmma*(1.000+x/y)*exp(-x/y)<a name='3011'>
        enddo<a name='3012'>
        rgmma=1./rgmma<a name='3013'>
      endif<a name='3014'>
      END FUNCTION rgmma<a name='3015'>
<font color=#447700>!<a name='3016'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='3017'></font>
<A NAME='FPVS'><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#FPVS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3018'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>fpvs</font>(t,ice,rd,rv,cvap,cliq,cice,hvap,hsub,psat,t0c) <A href='../../call_to/FPVS.html' TARGET='index'>9</A>,<A href='../../call_from/FPVS.html' TARGET='index'>1</A><a name='3019'>
<font color=#447700>!--------------------------------------------------------------------------<a name='3020'></font>
      IMPLICIT NONE<a name='3021'>
<font color=#447700>!--------------------------------------------------------------------------<a name='3022'></font>
      REAL t,rd,rv,cvap,cliq,cice,hvap,hsub,psat,t0c,dldt,xa,xb,dldti,         &amp;<a name='3023'>
           xai,xbi,ttp,tr<a name='3024'>
      INTEGER ice<a name='3025'>
<font color=#447700>! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<a name='3026'></font>
      ttp=t0c+0.01<a name='3027'>
      dldt=cvap-cliq<a name='3028'>
      xa=-dldt/rv<a name='3029'>
      xb=xa+hvap/(rv*ttp)<a name='3030'>
      dldti=cvap-cice<a name='3031'>
      xai=-dldti/rv<a name='3032'>
      xbi=xai+hsub/(rv*ttp)<a name='3033'>
      tr=ttp/t<a name='3034'>
      if(t.lt.ttp.and.ice.eq.1) then<a name='3035'>
        fpvs=psat*exp(log(tr)*(xai))*exp(xbi*(1.-tr))<a name='3036'>
      else<a name='3037'>
        fpvs=psat*exp(log(tr)*(xa))*exp(xb*(1.-tr))<a name='3038'>
      endif<a name='3039'>
<font color=#447700>! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<a name='3040'></font>
      END FUNCTION fpvs<a name='3041'>
<font color=#447700>!-------------------------------------------------------------------<a name='3042'></font>
<A NAME='WSM5INIT'><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM5INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3043'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>wsm5init</font>(den0,denr,dens,cl,cpv,allowed_to_read) <A href='../../call_to/WSM5INIT.html' TARGET='index'>1</A>,<A href='../../call_from/WSM5INIT.html' TARGET='index'>17</A><a name='3044'>
<font color=#447700>!-------------------------------------------------------------------<a name='3045'></font>
  IMPLICIT NONE<a name='3046'>
<font color=#447700>!-------------------------------------------------------------------<a name='3047'></font>
<font color=#447700>!.... constants which may not be tunable<a name='3048'></font>
   REAL, INTENT(IN) :: den0,denr,dens,cl,cpv<a name='3049'>
   LOGICAL, INTENT(IN) :: allowed_to_read<a name='3050'>
   REAL :: pi<a name='3051'>
<font color=#447700>!<a name='3052'></font>
   pi = 4.*atan(1.)<a name='3053'>
   xlv1 = cl-cpv<a name='3054'>
<font color=#447700>!<a name='3055'></font>
   qc0  = 4./3.*pi*denr*r0**3*xncr/den0  <font color=#447700>! 0.419e-3 -- .61e-3<a name='3056'></font>
   qck1 = .104*9.8*peaut/(xncr*denr)**(1./3.)/xmyu*den0**(4./3.) <font color=#447700>! 7.03<a name='3057'></font>
<font color=#447700>!<a name='3058'></font>
   bvtr1 = 1.+bvtr<a name='3059'>
   bvtr2 = 2.5+.5*bvtr<a name='3060'>
   bvtr3 = 3.+bvtr<a name='3061'>
   bvtr4 = 4.+bvtr<a name='3062'>
   g1pbr = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM5INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_56">(bvtr1)<a name='3063'>
   g3pbr = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM5INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_57">(bvtr3)<a name='3064'>
   g4pbr = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM5INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_58">(bvtr4)            <font color=#447700>! 17.837825<a name='3065'></font>
   g5pbro2 = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM5INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_59">(bvtr2)          <font color=#447700>! 1.8273<a name='3066'></font>
   pvtr = avtr*g4pbr/6.<a name='3067'>
   eacrr = 1.0<a name='3068'>
   pacrr = pi*n0r*avtr*g3pbr*.25*eacrr<a name='3069'>
   precr1 = 2.*pi*n0r*.78<a name='3070'>
   precr2 = 2.*pi*n0r*.31*avtr**.5*g5pbro2<a name='3071'>
   xmmax = (dimax/dicon)**2<a name='3072'>
   roqimax = 2.08e22*dimax**8<a name='3073'>
<font color=#447700>!<a name='3074'></font>
   bvts1 = 1.+bvts<a name='3075'>
   bvts2 = 2.5+.5*bvts<a name='3076'>
   bvts3 = 3.+bvts<a name='3077'>
   bvts4 = 4.+bvts<a name='3078'>
   g1pbs = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM5INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_60">(bvts1)    <font color=#447700>!.8875<a name='3079'></font>
   g3pbs = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM5INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_61">(bvts3)<a name='3080'>
   g4pbs = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM5INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_62">(bvts4)    <font color=#447700>! 12.0786<a name='3081'></font>
   g5pbso2 = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm5_accel.F.html#WSM5INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_63">(bvts2)<a name='3082'>
   pvts = avts*g4pbs/6.<a name='3083'>
   pacrs = pi*n0s*avts*g3pbs*.25<a name='3084'>
   precs1 = 4.*n0s*.65<a name='3085'>
   precs2 = 4.*n0s*.44*avts**.5*g5pbso2<a name='3086'>
   pidn0r =  pi*denr*n0r<a name='3087'>
   pidn0s =  pi*dens*n0s<a name='3088'>
   pacrc = pi*n0s*avts*g3pbs*.25*eacrc<a name='3089'>
<font color=#447700>!<a name='3090'></font>
   rslopermax = 1./lamdarmax<a name='3091'>
   rslopesmax = 1./lamdasmax<a name='3092'>
   rsloperbmax = rslopermax ** bvtr<a name='3093'>
   rslopesbmax = rslopesmax ** bvts<a name='3094'>
   rsloper2max = rslopermax * rslopermax<a name='3095'>
   rslopes2max = rslopesmax * rslopesmax<a name='3096'>
   rsloper3max = rsloper2max * rslopermax<a name='3097'>
   rslopes3max = rslopes2max * rslopesmax<a name='3098'>
<font color=#447700>!<a name='3099'></font>
  END SUBROUTINE wsm5init<a name='3100'>
END MODULE module_mp_wsm5<a name='3101'>
</pre></body></html>