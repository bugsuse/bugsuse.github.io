<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2'></font>
<font color=#447700>!.. This subroutine computes the moisture tendencies of water vapor,<a name='3'></font>
<font color=#447700>!.. cloud droplets, rain, cloud ice (pristine), snow, and graupel.<a name='4'></font>
<font color=#447700>!.. Prior to WRFv2.2 this code was based on Reisner et al (1998), but<a name='5'></font>
<font color=#447700>!.. few of those pieces remain.  A complete description is now found in<a name='6'></font>
<font color=#447700>!.. Thompson, G., P. R. Field, R. M. Rasmussen, and W. D. Hall, 2008:<a name='7'></font>
<font color=#447700>!.. Explicit Forecasts of winter precipitation using an improved bulk<a name='8'></font>
<font color=#447700>!.. microphysics scheme. Part II: Implementation of a new snow<a name='9'></font>
<font color=#447700>!.. parameterization.  Mon. Wea. Rev., 136, 5095-5115.<a name='10'></font>
<font color=#447700>!.. Prior to WRFv3.1, this code was single-moment rain prediction as<a name='11'></font>
<font color=#447700>!.. described in the reference above, but in v3.1 and higher, the<a name='12'></font>
<font color=#447700>!.. scheme is two-moment rain (predicted rain number concentration).<a name='13'></font>
<font color=#447700>!..<a name='14'></font>
<font color=#447700>!.. Beginning with WRFv3.6, this is also the "aerosol-aware" scheme as<a name='15'></font>
<font color=#447700>!.. described in Thompson, G. and T. Eidhammer, 2014:  A study of<a name='16'></font>
<font color=#447700>!.. aerosol impacts on clouds and precipitation development in a large<a name='17'></font>
<font color=#447700>!.. winter cyclone.  J. Atmos. Sci., 71, 3636-3658.  Setting WRF<a name='18'></font>
<font color=#447700>!.. namelist option mp_physics=8 utilizes the older one-moment cloud<a name='19'></font>
<font color=#447700>!.. water with constant droplet concentration set as Nt_c (found below)<a name='20'></font>
<font color=#447700>!.. while mp_physics=28 uses double-moment cloud droplet number<a name='21'></font>
<font color=#447700>!.. concentration, which is not permitted to exceed Nt_c_max below.<a name='22'></font>
<font color=#447700>!..<a name='23'></font>
<font color=#447700>!.. Most importantly, users may wish to modify the prescribed number of<a name='24'></font>
<font color=#447700>!.. cloud droplets (Nt_c; see guidelines mentioned below).  Otherwise,<a name='25'></font>
<font color=#447700>!.. users may alter the rain and graupel size distribution parameters<a name='26'></font>
<font color=#447700>!.. to use exponential (Marshal-Palmer) or generalized gamma shape.<a name='27'></font>
<font color=#447700>!.. The snow field assumes a combination of two gamma functions (from<a name='28'></font>
<font color=#447700>!.. Field et al. 2005) and would require significant modifications<a name='29'></font>
<font color=#447700>!.. throughout the entire code to alter its shape as well as accretion<a name='30'></font>
<font color=#447700>!.. rates.  Users may also alter the constants used for density of rain,<a name='31'></font>
<font color=#447700>!.. graupel, ice, and snow, but the latter is not constant when using<a name='32'></font>
<font color=#447700>!.. Paul Field's snow distribution and moments methods.  Other values<a name='33'></font>
<font color=#447700>!.. users can modify include the constants for mass and/or velocity<a name='34'></font>
<font color=#447700>!.. power law relations and assumed capacitances used in deposition/<a name='35'></font>
<font color=#447700>!.. sublimation/evaporation/melting.<a name='36'></font>
<font color=#447700>!.. Remaining values should probably be left alone.<a name='37'></font>
<font color=#447700>!..<a name='38'></font>
<font color=#447700>!..Author: Greg Thompson, NCAR-RAL, gthompsn@ucar.edu, 303-497-2805<a name='39'></font>
<font color=#447700>!..Last modified: 04 Aug 2017   Aerosol additions to v3.5.1 code 9/2013<a name='40'></font>
<font color=#447700>!..                 Cloud fraction additions 11/2014 part of pre-v3.7<a name='41'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='42'></font>
<font color=#447700>!wrft:model_layer:physics<a name='43'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='44'></font>
<font color=#447700>!<a name='45'></font>
<A NAME='MODULE_MP_THOMPSON'><A href='../../html_code/phys/module_mp_thompson.F.html#MODULE_MP_THOMPSON' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='46'>
      <font color=#993300>MODULE </font><font color=#cc0000>module_mp_thompson</font> <A href='../../call_to/MODULE_MP_THOMPSON.html' TARGET='index'>4</A><a name='47'>
<a name='48'>
      USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_mp_thompson.F.html#module_mp_thompson.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_66"><a name='49'>
      USE <A href='../../html_code/phys/module_mp_radar.F.html#MODULE_MP_RADAR'>module_mp_radar</A><A href='../../html_code/phys/module_mp_thompson.F.html#module_mp_thompson.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MP_RADAR_6"><a name='50'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='51'></font>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/phys/module_mp_thompson.F.html#module_mp_thompson.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_159">, ONLY : wrf_dm_max_real<a name='52'>
#endif<a name='53'>
<a name='54'>
      IMPLICIT NONE<a name='55'>
<a name='56'>
      LOGICAL, PARAMETER, PRIVATE:: iiwarm = .false.<a name='57'>
      LOGICAL, PRIVATE:: is_aerosol_aware = .false.<a name='58'>
      LOGICAL, PARAMETER, PRIVATE:: dustyIce = .true.<a name='59'>
      LOGICAL, PARAMETER, PRIVATE:: homogIce = .true.<a name='60'>
<a name='61'>
      INTEGER, PARAMETER, PRIVATE:: IFDRY = 0<a name='62'>
      REAL, PARAMETER, PRIVATE:: T_0 = 273.15<a name='63'>
      REAL, PARAMETER, PRIVATE:: PI = 3.1415926536<a name='64'>
<a name='65'>
<font color=#447700>!..Densities of rain, snow, graupel, and cloud ice.<a name='66'></font>
      REAL, PARAMETER, PRIVATE:: rho_w = 1000.0<a name='67'>
      REAL, PARAMETER, PRIVATE:: rho_s = 100.0<a name='68'>
      REAL, PARAMETER, PRIVATE:: rho_g = 500.0<a name='69'>
      REAL, PARAMETER, PRIVATE:: rho_i = 890.0<a name='70'>
<a name='71'>
<font color=#447700>!..Prescribed number of cloud droplets.  Set according to known data or<a name='72'></font>
<font color=#447700>!.. roughly 100 per cc (100.E6 m^-3) for Maritime cases and<a name='73'></font>
<font color=#447700>!.. 300 per cc (300.E6 m^-3) for Continental.  Gamma shape parameter,<a name='74'></font>
<font color=#447700>!.. mu_c, calculated based on Nt_c is important in autoconversion<a name='75'></font>
<font color=#447700>!.. scheme.  In 2-moment cloud water, Nt_c represents a maximum of<a name='76'></font>
<font color=#447700>!.. droplet concentration and nu_c is also variable depending on local<a name='77'></font>
<font color=#447700>!.. droplet number concentration.<a name='78'></font>
      REAL, PARAMETER, PRIVATE:: Nt_c = 100.E6<a name='79'>
      REAL, PARAMETER, PRIVATE:: Nt_c_max = 1999.E6<a name='80'>
<a name='81'>
<font color=#447700>!..Declaration of constants for assumed CCN/IN aerosols when none in<a name='82'></font>
<font color=#447700>!.. the input data.  Look inside the init routine for modifications<a name='83'></font>
<font color=#447700>!.. due to surface land-sea points or vegetation characteristics.<a name='84'></font>
      REAL, PARAMETER, PRIVATE:: naIN0 = 1.5E6<a name='85'>
      REAL, PARAMETER, PRIVATE:: naIN1 = 0.5E6<a name='86'>
      REAL, PARAMETER, PRIVATE:: naCCN0 = 300.0E6<a name='87'>
      REAL, PARAMETER, PRIVATE:: naCCN1 = 50.0E6<a name='88'>
<a name='89'>
<font color=#447700>!..Generalized gamma distributions for rain, graupel and cloud ice.<a name='90'></font>
<font color=#447700>!.. N(D) = N_0 * D**mu * exp(-lamda*D);  mu=0 is exponential.<a name='91'></font>
      REAL, PARAMETER, PRIVATE:: mu_r = 0.0<a name='92'>
      REAL, PARAMETER, PRIVATE:: mu_g = 0.0<a name='93'>
      REAL, PARAMETER, PRIVATE:: mu_i = 0.0<a name='94'>
      REAL, PRIVATE:: mu_c<a name='95'>
<a name='96'>
<font color=#447700>!..Sum of two gamma distrib for snow (Field et al. 2005).<a name='97'></font>
<font color=#447700>!.. N(D) = M2**4/M3**3 * [Kap0*exp(-M2*Lam0*D/M3)<a name='98'></font>
<font color=#447700>!..    + Kap1*(M2/M3)**mu_s * D**mu_s * exp(-M2*Lam1*D/M3)]<a name='99'></font>
<font color=#447700>!.. M2 and M3 are the (bm_s)th and (bm_s+1)th moments respectively<a name='100'></font>
<font color=#447700>!.. calculated as function of ice water content and temperature.<a name='101'></font>
      REAL, PARAMETER, PRIVATE:: mu_s = 0.6357<a name='102'>
      REAL, PARAMETER, PRIVATE:: Kap0 = 490.6<a name='103'>
      REAL, PARAMETER, PRIVATE:: Kap1 = 17.46<a name='104'>
      REAL, PARAMETER, PRIVATE:: Lam0 = 20.78<a name='105'>
      REAL, PARAMETER, PRIVATE:: Lam1 = 3.29<a name='106'>
<a name='107'>
<font color=#447700>!..Y-intercept parameter for graupel is not constant and depends on<a name='108'></font>
<font color=#447700>!.. mixing ratio.  Also, when mu_g is non-zero, these become equiv<a name='109'></font>
<font color=#447700>!.. y-intercept for an exponential distrib and proper values are<a name='110'></font>
<font color=#447700>!.. computed based on same mixing ratio and total number concentration.<a name='111'></font>
      REAL, PARAMETER, PRIVATE:: gonv_min = 1.E4<a name='112'>
      REAL, PARAMETER, PRIVATE:: gonv_max = 3.E6<a name='113'>
<a name='114'>
<font color=#447700>!..Mass power law relations:  mass = am*D**bm<a name='115'></font>
<font color=#447700>!.. Snow from Field et al. (2005), others assume spherical form.<a name='116'></font>
      REAL, PARAMETER, PRIVATE:: am_r = PI*rho_w/6.0<a name='117'>
      REAL, PARAMETER, PRIVATE:: bm_r = 3.0<a name='118'>
      REAL, PARAMETER, PRIVATE:: am_s = 0.069<a name='119'>
      REAL, PARAMETER, PRIVATE:: bm_s = 2.0<a name='120'>
      REAL, PARAMETER, PRIVATE:: am_g = PI*rho_g/6.0<a name='121'>
      REAL, PARAMETER, PRIVATE:: bm_g = 3.0<a name='122'>
      REAL, PARAMETER, PRIVATE:: am_i = PI*rho_i/6.0<a name='123'>
      REAL, PARAMETER, PRIVATE:: bm_i = 3.0<a name='124'>
<a name='125'>
<font color=#447700>!..Fallspeed power laws relations:  v = (av*D**bv)*exp(-fv*D)<a name='126'></font>
<font color=#447700>!.. Rain from Ferrier (1994), ice, snow, and graupel from<a name='127'></font>
<font color=#447700>!.. Thompson et al (2008). Coefficient fv is zero for graupel/ice.<a name='128'></font>
      REAL, PARAMETER, PRIVATE:: av_r = 4854.0<a name='129'>
      REAL, PARAMETER, PRIVATE:: bv_r = 1.0<a name='130'>
      REAL, PARAMETER, PRIVATE:: fv_r = 195.0<a name='131'>
      REAL, PARAMETER, PRIVATE:: av_s = 40.0<a name='132'>
      REAL, PARAMETER, PRIVATE:: bv_s = 0.55<a name='133'>
      REAL, PARAMETER, PRIVATE:: fv_s = 100.0<a name='134'>
      REAL, PARAMETER, PRIVATE:: av_g = 442.0<a name='135'>
      REAL, PARAMETER, PRIVATE:: bv_g = 0.89<a name='136'>
      REAL, PARAMETER, PRIVATE:: av_i = 1847.5<a name='137'>
      REAL, PARAMETER, PRIVATE:: bv_i = 1.0<a name='138'>
      REAL, PARAMETER, PRIVATE:: av_c = 0.316946E8<a name='139'>
      REAL, PARAMETER, PRIVATE:: bv_c = 2.0<a name='140'>
<a name='141'>
<font color=#447700>!..Capacitance of sphere and plates/aggregates: D**3, D**2<a name='142'></font>
      REAL, PARAMETER, PRIVATE:: C_cube = 0.5<a name='143'>
      REAL, PARAMETER, PRIVATE:: C_sqrd = 0.15<a name='144'>
<a name='145'>
<font color=#447700>!..Collection efficiencies.  Rain/snow/graupel collection of cloud<a name='146'></font>
<font color=#447700>!.. droplets use variables (Ef_rw, Ef_sw, Ef_gw respectively) and<a name='147'></font>
<font color=#447700>!.. get computed elsewhere because they are dependent on stokes<a name='148'></font>
<font color=#447700>!.. number.<a name='149'></font>
      REAL, PARAMETER, PRIVATE:: Ef_si = 0.05<a name='150'>
      REAL, PARAMETER, PRIVATE:: Ef_rs = 0.95<a name='151'>
      REAL, PARAMETER, PRIVATE:: Ef_rg = 0.75<a name='152'>
      REAL, PARAMETER, PRIVATE:: Ef_ri = 0.95<a name='153'>
<a name='154'>
<font color=#447700>!..Minimum microphys values<a name='155'></font>
<font color=#447700>!.. R1 value, 1.E-12, cannot be set lower because of numerical<a name='156'></font>
<font color=#447700>!.. problems with Paul Field's moments and should not be set larger<a name='157'></font>
<font color=#447700>!.. because of truncation problems in snow/ice growth.<a name='158'></font>
      REAL, PARAMETER, PRIVATE:: R1 = 1.E-12<a name='159'>
      REAL, PARAMETER, PRIVATE:: R2 = 1.E-6<a name='160'>
      REAL, PARAMETER, PRIVATE:: eps = 1.E-15<a name='161'>
<a name='162'>
<font color=#447700>!..Constants in Cooper curve relation for cloud ice number.<a name='163'></font>
      REAL, PARAMETER, PRIVATE:: TNO = 5.0<a name='164'>
      REAL, PARAMETER, PRIVATE:: ATO = 0.304<a name='165'>
<a name='166'>
<font color=#447700>!..Rho_not used in fallspeed relations (rho_not/rho)**.5 adjustment.<a name='167'></font>
      REAL, PARAMETER, PRIVATE:: rho_not = 101325.0/(287.05*298.0)<a name='168'>
<a name='169'>
<font color=#447700>!..Schmidt number<a name='170'></font>
      REAL, PARAMETER, PRIVATE:: Sc = 0.632<a name='171'>
      REAL, PRIVATE:: Sc3<a name='172'>
<a name='173'>
<font color=#447700>!..Homogeneous freezing temperature<a name='174'></font>
      REAL, PARAMETER, PRIVATE:: HGFR = 235.16<a name='175'>
<a name='176'>
<font color=#447700>!..Water vapor and air gas constants at constant pressure<a name='177'></font>
      REAL, PARAMETER, PRIVATE:: Rv = 461.5<a name='178'>
      REAL, PARAMETER, PRIVATE:: oRv = 1./Rv<a name='179'>
      REAL, PARAMETER, PRIVATE:: R = 287.04<a name='180'>
      REAL, PARAMETER, PRIVATE:: Cp = 1004.0<a name='181'>
      REAL, PARAMETER, PRIVATE:: R_uni = 8.314                           <font color=#447700>! J (mol K)-1<a name='182'></font>
<a name='183'>
      DOUBLE PRECISION, PARAMETER, PRIVATE:: k_b = 1.38065E-23           <font color=#447700>! Boltzmann constant [J/K]<a name='184'></font>
      DOUBLE PRECISION, PARAMETER, PRIVATE:: M_w = 18.01528E-3           <font color=#447700>! molecular mass of water [kg/mol]<a name='185'></font>
      DOUBLE PRECISION, PARAMETER, PRIVATE:: M_a = 28.96E-3              <font color=#447700>! molecular mass of air [kg/mol]<a name='186'></font>
      DOUBLE PRECISION, PARAMETER, PRIVATE:: N_avo = 6.022E23            <font color=#447700>! Avogadro number [1/mol]<a name='187'></font>
      DOUBLE PRECISION, PARAMETER, PRIVATE:: ma_w = M_w / N_avo          <font color=#447700>! mass of water molecule [kg]<a name='188'></font>
      REAL, PARAMETER, PRIVATE:: ar_volume = 4./3.*PI*(2.5e-6)**3        <font color=#447700>! assume radius of 0.025 micrometer, 2.5e-6 cm<a name='189'></font>
<a name='190'>
<font color=#447700>!..Enthalpy of sublimation, vaporization, and fusion at 0C.<a name='191'></font>
      REAL, PARAMETER, PRIVATE:: lsub = 2.834E6<a name='192'>
      REAL, PARAMETER, PRIVATE:: lvap0 = 2.5E6<a name='193'>
      REAL, PARAMETER, PRIVATE:: lfus = lsub - lvap0<a name='194'>
      REAL, PARAMETER, PRIVATE:: olfus = 1./lfus<a name='195'>
<a name='196'>
<font color=#447700>!..Ice initiates with this mass (kg), corresponding diameter calc.<a name='197'></font>
<font color=#447700>!..Min diameters and mass of cloud, rain, snow, and graupel (m, kg).<a name='198'></font>
      REAL, PARAMETER, PRIVATE:: xm0i = 1.E-12<a name='199'>
      REAL, PARAMETER, PRIVATE:: D0c = 1.E-6<a name='200'>
      REAL, PARAMETER, PRIVATE:: D0r = 50.E-6<a name='201'>
      REAL, PARAMETER, PRIVATE:: D0s = 200.E-6<a name='202'>
      REAL, PARAMETER, PRIVATE:: D0g = 250.E-6<a name='203'>
      REAL, PRIVATE:: D0i, xm0s, xm0g<a name='204'>
<a name='205'>
<font color=#447700>!..Lookup table dimensions<a name='206'></font>
      INTEGER, PARAMETER, PRIVATE:: nbins = 100<a name='207'>
      INTEGER, PARAMETER, PRIVATE:: nbc = nbins<a name='208'>
      INTEGER, PARAMETER, PRIVATE:: nbi = nbins<a name='209'>
      INTEGER, PARAMETER, PRIVATE:: nbr = nbins<a name='210'>
      INTEGER, PARAMETER, PRIVATE:: nbs = nbins<a name='211'>
      INTEGER, PARAMETER, PRIVATE:: nbg = nbins<a name='212'>
      INTEGER, PARAMETER, PRIVATE:: ntb_c = 37<a name='213'>
      INTEGER, PARAMETER, PRIVATE:: ntb_i = 64<a name='214'>
      INTEGER, PARAMETER, PRIVATE:: ntb_r = 37<a name='215'>
      INTEGER, PARAMETER, PRIVATE:: ntb_s = 28<a name='216'>
      INTEGER, PARAMETER, PRIVATE:: ntb_g = 28<a name='217'>
      INTEGER, PARAMETER, PRIVATE:: ntb_g1 = 28<a name='218'>
      INTEGER, PARAMETER, PRIVATE:: ntb_r1 = 37<a name='219'>
      INTEGER, PARAMETER, PRIVATE:: ntb_i1 = 55<a name='220'>
      INTEGER, PARAMETER, PRIVATE:: ntb_t = 9<a name='221'>
      INTEGER, PRIVATE:: nic1, nic2, nii2, nii3, nir2, nir3, nis2, nig2, nig3<a name='222'>
      INTEGER, PARAMETER, PRIVATE:: ntb_arc = 7<a name='223'>
      INTEGER, PARAMETER, PRIVATE:: ntb_arw = 9<a name='224'>
      INTEGER, PARAMETER, PRIVATE:: ntb_art = 7<a name='225'>
      INTEGER, PARAMETER, PRIVATE:: ntb_arr = 5<a name='226'>
      INTEGER, PARAMETER, PRIVATE:: ntb_ark = 4<a name='227'>
      INTEGER, PARAMETER, PRIVATE:: ntb_IN = 55<a name='228'>
      INTEGER, PRIVATE:: niIN2<a name='229'>
<a name='230'>
      DOUBLE PRECISION, DIMENSION(nbins+1):: xDx<a name='231'>
      DOUBLE PRECISION, DIMENSION(nbc):: Dc, dtc<a name='232'>
      DOUBLE PRECISION, DIMENSION(nbi):: Di, dti<a name='233'>
      DOUBLE PRECISION, DIMENSION(nbr):: Dr, dtr<a name='234'>
      DOUBLE PRECISION, DIMENSION(nbs):: Ds, dts<a name='235'>
      DOUBLE PRECISION, DIMENSION(nbg):: Dg, dtg<a name='236'>
      DOUBLE PRECISION, DIMENSION(nbc):: t_Nc<a name='237'>
<a name='238'>
<font color=#447700>!..Lookup tables for cloud water content (kg/m**3).<a name='239'></font>
      REAL, DIMENSION(ntb_c), PARAMETER, PRIVATE:: &amp;<a name='240'>
      r_c = (/1.e-6,2.e-6,3.e-6,4.e-6,5.e-6,6.e-6,7.e-6,8.e-6,9.e-6, &amp;<a name='241'>
              1.e-5,2.e-5,3.e-5,4.e-5,5.e-5,6.e-5,7.e-5,8.e-5,9.e-5, &amp;<a name='242'>
              1.e-4,2.e-4,3.e-4,4.e-4,5.e-4,6.e-4,7.e-4,8.e-4,9.e-4, &amp;<a name='243'>
              1.e-3,2.e-3,3.e-3,4.e-3,5.e-3,6.e-3,7.e-3,8.e-3,9.e-3, &amp;<a name='244'>
              1.e-2/)<a name='245'>
<a name='246'>
<font color=#447700>!..Lookup tables for cloud ice content (kg/m**3).<a name='247'></font>
      REAL, DIMENSION(ntb_i), PARAMETER, PRIVATE:: &amp;<a name='248'>
      r_i = (/1.e-10,2.e-10,3.e-10,4.e-10, &amp;<a name='249'>
              5.e-10,6.e-10,7.e-10,8.e-10,9.e-10, &amp;<a name='250'>
              1.e-9,2.e-9,3.e-9,4.e-9,5.e-9,6.e-9,7.e-9,8.e-9,9.e-9, &amp;<a name='251'>
              1.e-8,2.e-8,3.e-8,4.e-8,5.e-8,6.e-8,7.e-8,8.e-8,9.e-8, &amp;<a name='252'>
              1.e-7,2.e-7,3.e-7,4.e-7,5.e-7,6.e-7,7.e-7,8.e-7,9.e-7, &amp;<a name='253'>
              1.e-6,2.e-6,3.e-6,4.e-6,5.e-6,6.e-6,7.e-6,8.e-6,9.e-6, &amp;<a name='254'>
              1.e-5,2.e-5,3.e-5,4.e-5,5.e-5,6.e-5,7.e-5,8.e-5,9.e-5, &amp;<a name='255'>
              1.e-4,2.e-4,3.e-4,4.e-4,5.e-4,6.e-4,7.e-4,8.e-4,9.e-4, &amp;<a name='256'>
              1.e-3/)<a name='257'>
<a name='258'>
<font color=#447700>!..Lookup tables for rain content (kg/m**3).<a name='259'></font>
      REAL, DIMENSION(ntb_r), PARAMETER, PRIVATE:: &amp;<a name='260'>
      r_r = (/1.e-6,2.e-6,3.e-6,4.e-6,5.e-6,6.e-6,7.e-6,8.e-6,9.e-6, &amp;<a name='261'>
              1.e-5,2.e-5,3.e-5,4.e-5,5.e-5,6.e-5,7.e-5,8.e-5,9.e-5, &amp;<a name='262'>
              1.e-4,2.e-4,3.e-4,4.e-4,5.e-4,6.e-4,7.e-4,8.e-4,9.e-4, &amp;<a name='263'>
              1.e-3,2.e-3,3.e-3,4.e-3,5.e-3,6.e-3,7.e-3,8.e-3,9.e-3, &amp;<a name='264'>
              1.e-2/)<a name='265'>
<a name='266'>
<font color=#447700>!..Lookup tables for graupel content (kg/m**3).<a name='267'></font>
      REAL, DIMENSION(ntb_g), PARAMETER, PRIVATE:: &amp;<a name='268'>
      r_g = (/1.e-5,2.e-5,3.e-5,4.e-5,5.e-5,6.e-5,7.e-5,8.e-5,9.e-5, &amp;<a name='269'>
              1.e-4,2.e-4,3.e-4,4.e-4,5.e-4,6.e-4,7.e-4,8.e-4,9.e-4, &amp;<a name='270'>
              1.e-3,2.e-3,3.e-3,4.e-3,5.e-3,6.e-3,7.e-3,8.e-3,9.e-3, &amp;<a name='271'>
              1.e-2/)<a name='272'>
<a name='273'>
<font color=#447700>!..Lookup tables for snow content (kg/m**3).<a name='274'></font>
      REAL, DIMENSION(ntb_s), PARAMETER, PRIVATE:: &amp;<a name='275'>
      r_s = (/1.e-5,2.e-5,3.e-5,4.e-5,5.e-5,6.e-5,7.e-5,8.e-5,9.e-5, &amp;<a name='276'>
              1.e-4,2.e-4,3.e-4,4.e-4,5.e-4,6.e-4,7.e-4,8.e-4,9.e-4, &amp;<a name='277'>
              1.e-3,2.e-3,3.e-3,4.e-3,5.e-3,6.e-3,7.e-3,8.e-3,9.e-3, &amp;<a name='278'>
              1.e-2/)<a name='279'>
<a name='280'>
<font color=#447700>!..Lookup tables for rain y-intercept parameter (/m**4).<a name='281'></font>
      REAL, DIMENSION(ntb_r1), PARAMETER, PRIVATE:: &amp;<a name='282'>
      N0r_exp = (/1.e6,2.e6,3.e6,4.e6,5.e6,6.e6,7.e6,8.e6,9.e6, &amp;<a name='283'>
                  1.e7,2.e7,3.e7,4.e7,5.e7,6.e7,7.e7,8.e7,9.e7, &amp;<a name='284'>
                  1.e8,2.e8,3.e8,4.e8,5.e8,6.e8,7.e8,8.e8,9.e8, &amp;<a name='285'>
                  1.e9,2.e9,3.e9,4.e9,5.e9,6.e9,7.e9,8.e9,9.e9, &amp;<a name='286'>
                  1.e10/)<a name='287'>
<a name='288'>
<font color=#447700>!..Lookup tables for graupel y-intercept parameter (/m**4).<a name='289'></font>
      REAL, DIMENSION(ntb_g1), PARAMETER, PRIVATE:: &amp;<a name='290'>
      N0g_exp = (/1.e4,2.e4,3.e4,4.e4,5.e4,6.e4,7.e4,8.e4,9.e4, &amp;<a name='291'>
                  1.e5,2.e5,3.e5,4.e5,5.e5,6.e5,7.e5,8.e5,9.e5, &amp;<a name='292'>
                  1.e6,2.e6,3.e6,4.e6,5.e6,6.e6,7.e6,8.e6,9.e6, &amp;<a name='293'>
                  1.e7/)<a name='294'>
<a name='295'>
<font color=#447700>!..Lookup tables for ice number concentration (/m**3).<a name='296'></font>
      REAL, DIMENSION(ntb_i1), PARAMETER, PRIVATE:: &amp;<a name='297'>
      Nt_i = (/1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0, &amp;<a name='298'>
               1.e1,2.e1,3.e1,4.e1,5.e1,6.e1,7.e1,8.e1,9.e1, &amp;<a name='299'>
               1.e2,2.e2,3.e2,4.e2,5.e2,6.e2,7.e2,8.e2,9.e2, &amp;<a name='300'>
               1.e3,2.e3,3.e3,4.e3,5.e3,6.e3,7.e3,8.e3,9.e3, &amp;<a name='301'>
               1.e4,2.e4,3.e4,4.e4,5.e4,6.e4,7.e4,8.e4,9.e4, &amp;<a name='302'>
               1.e5,2.e5,3.e5,4.e5,5.e5,6.e5,7.e5,8.e5,9.e5, &amp;<a name='303'>
               1.e6/)<a name='304'>
<a name='305'>
<font color=#447700>!..Aerosol table parameter: Number of available aerosols, vertical<a name='306'></font>
<font color=#447700>!.. velocity, temperature, aerosol mean radius, and hygroscopicity.<a name='307'></font>
      REAL, DIMENSION(ntb_arc), PARAMETER, PRIVATE:: &amp;<a name='308'>
      ta_Na = (/10.0, 31.6, 100.0, 316.0, 1000.0, 3160.0, 10000.0/)<a name='309'>
      REAL, DIMENSION(ntb_arw), PARAMETER, PRIVATE:: &amp;<a name='310'>
      ta_Ww = (/0.01, 0.0316, 0.1, 0.316, 1.0, 3.16, 10.0, 31.6, 100.0/)<a name='311'>
      REAL, DIMENSION(ntb_art), PARAMETER, PRIVATE:: &amp;<a name='312'>
      ta_Tk = (/243.15, 253.15, 263.15, 273.15, 283.15, 293.15, 303.15/)<a name='313'>
      REAL, DIMENSION(ntb_arr), PARAMETER, PRIVATE:: &amp;<a name='314'>
      ta_Ra = (/0.01, 0.02, 0.04, 0.08, 0.16/)<a name='315'>
      REAL, DIMENSION(ntb_ark), PARAMETER, PRIVATE:: &amp;<a name='316'>
      ta_Ka = (/0.2, 0.4, 0.6, 0.8/)<a name='317'>
<a name='318'>
<font color=#447700>!..Lookup tables for IN concentration (/m**3) from 0.001 to 1000/Liter.<a name='319'></font>
      REAL, DIMENSION(ntb_IN), PARAMETER, PRIVATE:: &amp;<a name='320'>
      Nt_IN = (/1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0, &amp;<a name='321'>
               1.e1,2.e1,3.e1,4.e1,5.e1,6.e1,7.e1,8.e1,9.e1, &amp;<a name='322'>
               1.e2,2.e2,3.e2,4.e2,5.e2,6.e2,7.e2,8.e2,9.e2, &amp;<a name='323'>
               1.e3,2.e3,3.e3,4.e3,5.e3,6.e3,7.e3,8.e3,9.e3, &amp;<a name='324'>
               1.e4,2.e4,3.e4,4.e4,5.e4,6.e4,7.e4,8.e4,9.e4, &amp;<a name='325'>
               1.e5,2.e5,3.e5,4.e5,5.e5,6.e5,7.e5,8.e5,9.e5, &amp;<a name='326'>
               1.e6/)<a name='327'>
<a name='328'>
<font color=#447700>!..For snow moments conversions (from Field et al. 2005)<a name='329'></font>
      REAL, DIMENSION(10), PARAMETER, PRIVATE:: &amp;<a name='330'>
      sa = (/ 5.065339, -0.062659, -3.032362, 0.029469, -0.000285, &amp;<a name='331'>
              0.31255,   0.000204,  0.003199, 0.0,      -0.015952/)<a name='332'>
      REAL, DIMENSION(10), PARAMETER, PRIVATE:: &amp;<a name='333'>
      sb = (/ 0.476221, -0.015896,  0.165977, 0.007468, -0.000141, &amp;<a name='334'>
              0.060366,  0.000079,  0.000594, 0.0,      -0.003577/)<a name='335'>
<a name='336'>
<font color=#447700>!..Temperatures (5 C interval 0 to -40) used in lookup tables.<a name='337'></font>
      REAL, DIMENSION(ntb_t), PARAMETER, PRIVATE:: &amp;<a name='338'>
      Tc = (/-0.01, -5., -10., -15., -20., -25., -30., -35., -40./)<a name='339'>
<a name='340'>
<font color=#447700>!..Lookup tables for various accretion/collection terms.<a name='341'></font>
<font color=#447700>!.. ntb_x refers to the number of elements for rain, snow, graupel,<a name='342'></font>
<font color=#447700>!.. and temperature array indices.  Variables beginning with t-p/c/m/n<a name='343'></font>
<font color=#447700>!.. represent lookup tables.  Save compile-time memory by making<a name='344'></font>
<font color=#447700>!.. allocatable (2009Jun12, J. Michalakes).<a name='345'></font>
      INTEGER, PARAMETER, PRIVATE:: R8SIZE = 8<a name='346'>
      INTEGER, PARAMETER, PRIVATE:: R4SIZE = 4<a name='347'>
      REAL (KIND=R8SIZE), ALLOCATABLE, DIMENSION(:,:,:,:)::             &amp;<a name='348'>
                tcg_racg, tmr_racg, tcr_gacr, tmg_gacr,                 &amp;<a name='349'>
                tnr_racg, tnr_gacr<a name='350'>
      REAL (KIND=R8SIZE), ALLOCATABLE, DIMENSION(:,:,:,:)::             &amp;<a name='351'>
                tcs_racs1, tmr_racs1, tcs_racs2, tmr_racs2,             &amp;<a name='352'>
                tcr_sacr1, tms_sacr1, tcr_sacr2, tms_sacr2,             &amp;<a name='353'>
                tnr_racs1, tnr_racs2, tnr_sacr1, tnr_sacr2<a name='354'>
      REAL (KIND=R8SIZE), ALLOCATABLE, DIMENSION(:,:,:,:)::             &amp;<a name='355'>
                tpi_qcfz, tni_qcfz<a name='356'>
      REAL (KIND=R8SIZE), ALLOCATABLE, DIMENSION(:,:,:,:)::             &amp;<a name='357'>
                tpi_qrfz, tpg_qrfz, tni_qrfz, tnr_qrfz<a name='358'>
      REAL (KIND=R8SIZE), ALLOCATABLE, DIMENSION(:,:)::                 &amp;<a name='359'>
                tps_iaus, tni_iaus, tpi_ide<a name='360'>
      REAL (KIND=R8SIZE), ALLOCATABLE, DIMENSION(:,:):: t_Efrw<a name='361'>
      REAL (KIND=R8SIZE), ALLOCATABLE, DIMENSION(:,:):: t_Efsw<a name='362'>
      REAL (KIND=R8SIZE), ALLOCATABLE, DIMENSION(:,:,:):: tnr_rev<a name='363'>
      REAL (KIND=R8SIZE), ALLOCATABLE, DIMENSION(:,:,:)::               &amp;<a name='364'>
                tpc_wev, tnc_wev<a name='365'>
      REAL (KIND=R4SIZE), ALLOCATABLE, DIMENSION(:,:,:,:,:):: tnccn_act<a name='366'>
<a name='367'>
<font color=#447700>!..Variables holding a bunch of exponents and gamma values (cloud water,<a name='368'></font>
<font color=#447700>!.. cloud ice, rain, snow, then graupel).<a name='369'></font>
      REAL, DIMENSION(5,15), PRIVATE:: cce, ccg<a name='370'>
      REAL, DIMENSION(15), PRIVATE::  ocg1, ocg2<a name='371'>
      REAL, DIMENSION(7), PRIVATE:: cie, cig<a name='372'>
      REAL, PRIVATE:: oig1, oig2, obmi<a name='373'>
      REAL, DIMENSION(13), PRIVATE:: cre, crg<a name='374'>
      REAL, PRIVATE:: ore1, org1, org2, org3, obmr<a name='375'>
      REAL, DIMENSION(18), PRIVATE:: cse, csg<a name='376'>
      REAL, PRIVATE:: oams, obms, ocms<a name='377'>
      REAL, DIMENSION(12), PRIVATE:: cge, cgg<a name='378'>
      REAL, PRIVATE:: oge1, ogg1, ogg2, ogg3, oamg, obmg, ocmg<a name='379'>
<a name='380'>
<font color=#447700>!..Declaration of precomputed constants in various rate eqns.<a name='381'></font>
      REAL:: t1_qr_qc, t1_qr_qi, t2_qr_qi, t1_qg_qc, t1_qs_qc, t1_qs_qi<a name='382'>
      REAL:: t1_qr_ev, t2_qr_ev<a name='383'>
      REAL:: t1_qs_sd, t2_qs_sd, t1_qg_sd, t2_qg_sd<a name='384'>
      REAL:: t1_qs_me, t2_qs_me, t1_qg_me, t2_qg_me<a name='385'>
<a name='386'>
<font color=#447700>!+---+<a name='387'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='388'></font>
<font color=#447700>!..END DECLARATIONS<a name='389'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='390'></font>
<font color=#447700>!+---+<a name='391'></font>
<font color=#447700>!ctrlL<a name='392'></font>
<a name='393'>
      CONTAINS<a name='394'>
<a name='395'>
<A NAME='THOMPSON_INIT'><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='396'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>thompson_init</font>(hgt, nwfa2d, nwfa, nifa, dx, dy,         &amp; <A href='../../call_to/THOMPSON_INIT.html' TARGET='index'>2</A>,<A href='../../call_from/THOMPSON_INIT.html' TARGET='index'>45</A><a name='397'>
                          is_start,                                     &amp;<a name='398'>
                          ids, ide, jds, jde, kds, kde,                 &amp;<a name='399'>
                          ims, ime, jms, jme, kms, kme,                 &amp;<a name='400'>
                          its, ite, jts, jte, kts, kte)<a name='401'>
<a name='402'>
      IMPLICIT NONE<a name='403'>
<a name='404'>
      INTEGER, INTENT(IN):: ids,ide, jds,jde, kds,kde, &amp;<a name='405'>
                            ims,ime, jms,jme, kms,kme, &amp;<a name='406'>
                            its,ite, jts,jte, kts,kte<a name='407'>
      REAL, DIMENSION(ims:ime,kms:kme,jms:jme), INTENT(IN):: hgt<a name='408'>
<a name='409'>
<font color=#447700>!..OPTIONAL variables that control application of aerosol-aware scheme<a name='410'></font>
<a name='411'>
      REAL, DIMENSION(ims:ime,kms:kme,jms:jme), OPTIONAL, INTENT(INOUT) :: nwfa, nifa<a name='412'>
      REAL, DIMENSION(ims:ime,jms:jme), OPTIONAL, INTENT(INOUT) :: nwfa2d<a name='413'>
      REAL, OPTIONAL, INTENT(IN) :: DX, DY<a name='414'>
      LOGICAL, OPTIONAL, INTENT(IN) :: is_start<a name='415'>
      CHARACTER*256:: mp_debug<a name='416'>
<a name='417'>
<a name='418'>
      INTEGER:: i, j, k, l, m, n<a name='419'>
      REAL:: h_01, niIN3, niCCN3, max_test<a name='420'>
      LOGICAL:: micro_init, has_CCN, has_IN<a name='421'>
<a name='422'>
      is_aerosol_aware = .FALSE.<a name='423'>
      micro_init = .FALSE.<a name='424'>
      has_CCN    = .FALSE.<a name='425'>
      has_IN     = .FALSE.<a name='426'>
<a name='427'>
      write(mp_debug,*) ' DEBUG  checking column of hgt ', its+1,jts+1<a name='428'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_659">(250, mp_debug)<a name='429'>
      do k = kts, kte<a name='430'>
         write(mp_debug,*) ' DEBUGT  k, hgt = ', k, hgt(its+1,k,jts+1)<a name='431'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_660">(250, mp_debug)<a name='432'>
      enddo<a name='433'>
<a name='434'>
      if (PRESENT(nwfa2d) .AND. PRESENT(nwfa) .AND. PRESENT(nifa)) is_aerosol_aware = .TRUE.<a name='435'>
<a name='436'>
      if (is_aerosol_aware) then<a name='437'>
<a name='438'>
<font color=#447700>!..Check for existing aerosol data, both CCN and IN aerosols.  If missing<a name='439'></font>
<font color=#447700>!.. fill in just a basic vertical profile, somewhat boundary-layer following.<a name='440'></font>
<a name='441'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='442'></font>
      max_test = wrf_dm_max_real ( MAXVAL(nwfa(its:ite-1,:,jts:jte-1)) )<a name='443'>
#else<a name='444'>
      max_test = MAXVAL ( nwfa(its:ite-1,:,jts:jte-1) )<a name='445'>
#endif<a name='446'>
<a name='447'>
      if (max_test .lt. eps) then<a name='448'>
         write(mp_debug,*) ' Apparently there are no initial CCN aerosols.'<a name='449'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_661">(100, mp_debug)<a name='450'>
         write(mp_debug,*) '   checked column at point (i,j) = ', its,jts<a name='451'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_662">(100, mp_debug)<a name='452'>
         do j = jts, min(jde-1,jte)<a name='453'>
         do i = its, min(ide-1,ite)<a name='454'>
            if (hgt(i,1,j).le.1000.0) then<a name='455'>
               h_01 = 0.8<a name='456'>
            elseif (hgt(i,1,j).ge.2500.0) then<a name='457'>
               h_01 = 0.01<a name='458'>
            else<a name='459'>
               h_01 = 0.8*cos(hgt(i,1,j)*0.001 - 1.0)<a name='460'>
            endif<a name='461'>
            niCCN3 = -1.0*ALOG(naCCN1/naCCN0)/h_01<a name='462'>
            nwfa(i,1,j) = naCCN1+naCCN0*exp(-((hgt(i,2,j)-hgt(i,1,j))/1000.)*niCCN3)<a name='463'>
            do k = 2, kte<a name='464'>
               nwfa(i,k,j) = naCCN1+naCCN0*exp(-((hgt(i,k,j)-hgt(i,1,j))/1000.)*niCCN3)<a name='465'>
            enddo<a name='466'>
         enddo<a name='467'>
         enddo<a name='468'>
      else<a name='469'>
         has_CCN    = .TRUE.<a name='470'>
         write(mp_debug,*) ' Apparently initial CCN aerosols are present.'<a name='471'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_663">(100, mp_debug)<a name='472'>
         write(mp_debug,*) '   column sum at point (i,j) = ', its,jts, SUM(nwfa(its,:,jts))<a name='473'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_664">(100, mp_debug)<a name='474'>
      endif<a name='475'>
<a name='476'>
<a name='477'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='478'></font>
      max_test = wrf_dm_max_real ( MAXVAL(nifa(its:ite-1,:,jts:jte-1)) )<a name='479'>
#else<a name='480'>
      max_test = MAXVAL ( nifa(its:ite-1,:,jts:jte-1) )<a name='481'>
#endif<a name='482'>
<a name='483'>
      if (max_test .lt. eps) then<a name='484'>
         write(mp_debug,*) ' Apparently there are no initial IN aerosols.'<a name='485'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_665">(100, mp_debug)<a name='486'>
         write(mp_debug,*) '   checked column at point (i,j) = ', its,jts<a name='487'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_666">(100, mp_debug)<a name='488'>
         do j = jts, min(jde-1,jte)<a name='489'>
         do i = its, min(ide-1,ite)<a name='490'>
            if (hgt(i,1,j).le.1000.0) then<a name='491'>
               h_01 = 0.8<a name='492'>
            elseif (hgt(i,1,j).ge.2500.0) then<a name='493'>
               h_01 = 0.01<a name='494'>
            else<a name='495'>
               h_01 = 0.8*cos(hgt(i,1,j)*0.001 - 1.0)<a name='496'>
            endif<a name='497'>
            niIN3 = -1.0*ALOG(naIN1/naIN0)/h_01<a name='498'>
            nifa(i,1,j) = naIN1+naIN0*exp(-((hgt(i,2,j)-hgt(i,1,j))/1000.)*niIN3)<a name='499'>
            do k = 2, kte<a name='500'>
               nifa(i,k,j) = naIN1+naIN0*exp(-((hgt(i,k,j)-hgt(i,1,j))/1000.)*niIN3)<a name='501'>
            enddo<a name='502'>
         enddo<a name='503'>
         enddo<a name='504'>
      else<a name='505'>
         has_IN     = .TRUE.<a name='506'>
         write(mp_debug,*) ' Apparently initial IN aerosols are present.'<a name='507'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_667">(100, mp_debug)<a name='508'>
         write(mp_debug,*) '   column sum at point (i,j) = ', its,jts, SUM(nifa(its,:,jts))<a name='509'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_668">(100, mp_debug)<a name='510'>
      endif<a name='511'>
<a name='512'>
<font color=#447700>!..Capture initial state lowest level CCN aerosol data in 2D array.<a name='513'></font>
<a name='514'>
<font color=#447700>!     do j = jts, min(jde-1,jte)<a name='515'></font>
<font color=#447700>!     do i = its, min(ide-1,ite)<a name='516'></font>
<font color=#447700>!        nwfa2d(i,j) = nwfa(i,kts,j)<a name='517'></font>
<font color=#447700>!     enddo<a name='518'></font>
<font color=#447700>!     enddo<a name='519'></font>
<a name='520'>
<font color=#447700>!..Scale the lowest level aerosol data into an emissions rate.  This is<a name='521'></font>
<font color=#447700>!.. very far from ideal, but need higher emissions where larger amount<a name='522'></font>
<font color=#447700>!.. of existing and lesser emissions where not already lots of aerosols<a name='523'></font>
<font color=#447700>!.. for first-order simplistic approach.  Later, proper connection to<a name='524'></font>
<font color=#447700>!.. emission inventory would be better, but, for now, scale like this:<a name='525'></font>
<font color=#447700>!.. where: Nwfa=50 per cc, emit 0.875E4 aerosols per kg per second<a name='526'></font>
<font color=#447700>!..        Nwfa=500 per cc, emit 0.875E5 aerosols per kg per second<a name='527'></font>
<font color=#447700>!..        Nwfa=5000 per cc, emit 0.875E6 aerosols per kg per second<a name='528'></font>
<font color=#447700>!.. for a grid with 20km spacing and scale accordingly for other spacings.<a name='529'></font>
<a name='530'>
      if (is_start) then<a name='531'>
         if (SQRT(DX*DY)/20000.0 .ge. 1.0) then<a name='532'>
            h_01 = 0.875<a name='533'>
         else<a name='534'>
            h_01 = (0.875 + 0.125*((20000.-SQRT(DX*DY))/16000.)) * SQRT(DX*DY)/20000.<a name='535'>
         endif<a name='536'>
         write(mp_debug,*) '   aerosol surface flux emission scale factor is: ', h_01<a name='537'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_669">(100, mp_debug)<a name='538'>
         do j = jts, min(jde-1,jte)<a name='539'>
         do i = its, min(ide-1,ite)<a name='540'>
            nwfa2d(i,j) = 10.0**(LOG10(nwfa(i,kts,j)*1.E-6)-3.69897)<a name='541'>
            nwfa2d(i,j) = nwfa2d(i,j)*h_01 * 1.E6<a name='542'>
         enddo<a name='543'>
         enddo<a name='544'>
<font color=#447700>!     else<a name='545'></font>
<font color=#447700>!        write(mp_debug,*) '   sample (lower-left) aerosol surface flux emission rate: ', nwfa2d(1,1)<a name='546'></font>
<font color=#447700>!        CALL wrf_debug(100, mp_debug)<a name='547'></font>
      endif<a name='548'>
<a name='549'>
      endif<a name='550'>
<a name='551'>
<a name='552'>
<font color=#447700>!..Allocate space for lookup tables (J. Michalakes 2009Jun08).<a name='553'></font>
<a name='554'>
      if (.NOT. ALLOCATED(tcg_racg) ) then<a name='555'>
         ALLOCATE(tcg_racg(ntb_g1,ntb_g,ntb_r1,ntb_r))<a name='556'>
         micro_init = .TRUE.<a name='557'>
      endif<a name='558'>
<a name='559'>
      if (.NOT. ALLOCATED(tmr_racg)) ALLOCATE(tmr_racg(ntb_g1,ntb_g,ntb_r1,ntb_r))<a name='560'>
      if (.NOT. ALLOCATED(tcr_gacr)) ALLOCATE(tcr_gacr(ntb_g1,ntb_g,ntb_r1,ntb_r))<a name='561'>
      if (.NOT. ALLOCATED(tmg_gacr)) ALLOCATE(tmg_gacr(ntb_g1,ntb_g,ntb_r1,ntb_r))<a name='562'>
      if (.NOT. ALLOCATED(tnr_racg)) ALLOCATE(tnr_racg(ntb_g1,ntb_g,ntb_r1,ntb_r))<a name='563'>
      if (.NOT. ALLOCATED(tnr_gacr)) ALLOCATE(tnr_gacr(ntb_g1,ntb_g,ntb_r1,ntb_r))<a name='564'>
<a name='565'>
      if (.NOT. ALLOCATED(tcs_racs1)) ALLOCATE(tcs_racs1(ntb_s,ntb_t,ntb_r1,ntb_r))<a name='566'>
      if (.NOT. ALLOCATED(tmr_racs1)) ALLOCATE(tmr_racs1(ntb_s,ntb_t,ntb_r1,ntb_r))<a name='567'>
      if (.NOT. ALLOCATED(tcs_racs2)) ALLOCATE(tcs_racs2(ntb_s,ntb_t,ntb_r1,ntb_r))<a name='568'>
      if (.NOT. ALLOCATED(tmr_racs2)) ALLOCATE(tmr_racs2(ntb_s,ntb_t,ntb_r1,ntb_r))<a name='569'>
      if (.NOT. ALLOCATED(tcr_sacr1)) ALLOCATE(tcr_sacr1(ntb_s,ntb_t,ntb_r1,ntb_r))<a name='570'>
      if (.NOT. ALLOCATED(tms_sacr1)) ALLOCATE(tms_sacr1(ntb_s,ntb_t,ntb_r1,ntb_r))<a name='571'>
      if (.NOT. ALLOCATED(tcr_sacr2)) ALLOCATE(tcr_sacr2(ntb_s,ntb_t,ntb_r1,ntb_r))<a name='572'>
      if (.NOT. ALLOCATED(tms_sacr2)) ALLOCATE(tms_sacr2(ntb_s,ntb_t,ntb_r1,ntb_r))<a name='573'>
      if (.NOT. ALLOCATED(tnr_racs1)) ALLOCATE(tnr_racs1(ntb_s,ntb_t,ntb_r1,ntb_r))<a name='574'>
      if (.NOT. ALLOCATED(tnr_racs2)) ALLOCATE(tnr_racs2(ntb_s,ntb_t,ntb_r1,ntb_r))<a name='575'>
      if (.NOT. ALLOCATED(tnr_sacr1)) ALLOCATE(tnr_sacr1(ntb_s,ntb_t,ntb_r1,ntb_r))<a name='576'>
      if (.NOT. ALLOCATED(tnr_sacr2)) ALLOCATE(tnr_sacr2(ntb_s,ntb_t,ntb_r1,ntb_r))<a name='577'>
<a name='578'>
      if (.NOT. ALLOCATED(tpi_qcfz)) ALLOCATE(tpi_qcfz(ntb_c,nbc,45,ntb_IN))<a name='579'>
      if (.NOT. ALLOCATED(tni_qcfz)) ALLOCATE(tni_qcfz(ntb_c,nbc,45,ntb_IN))<a name='580'>
<a name='581'>
      if (.NOT. ALLOCATED(tpi_qrfz)) ALLOCATE(tpi_qrfz(ntb_r,ntb_r1,45,ntb_IN))<a name='582'>
      if (.NOT. ALLOCATED(tpg_qrfz)) ALLOCATE(tpg_qrfz(ntb_r,ntb_r1,45,ntb_IN))<a name='583'>
      if (.NOT. ALLOCATED(tni_qrfz)) ALLOCATE(tni_qrfz(ntb_r,ntb_r1,45,ntb_IN))<a name='584'>
      if (.NOT. ALLOCATED(tnr_qrfz)) ALLOCATE(tnr_qrfz(ntb_r,ntb_r1,45,ntb_IN))<a name='585'>
<a name='586'>
      if (.NOT. ALLOCATED(tps_iaus)) ALLOCATE(tps_iaus(ntb_i,ntb_i1))<a name='587'>
      if (.NOT. ALLOCATED(tni_iaus)) ALLOCATE(tni_iaus(ntb_i,ntb_i1))<a name='588'>
      if (.NOT. ALLOCATED(tpi_ide)) ALLOCATE(tpi_ide(ntb_i,ntb_i1))<a name='589'>
<a name='590'>
      if (.NOT. ALLOCATED(t_Efrw)) ALLOCATE(t_Efrw(nbr,nbc))<a name='591'>
      if (.NOT. ALLOCATED(t_Efsw)) ALLOCATE(t_Efsw(nbs,nbc))<a name='592'>
<a name='593'>
      if (.NOT. ALLOCATED(tnr_rev)) ALLOCATE(tnr_rev(nbr, ntb_r1, ntb_r))<a name='594'>
      if (.NOT. ALLOCATED(tpc_wev)) ALLOCATE(tpc_wev(nbc,ntb_c,nbc))<a name='595'>
      if (.NOT. ALLOCATED(tnc_wev)) ALLOCATE(tnc_wev(nbc,ntb_c,nbc))<a name='596'>
<a name='597'>
      if (.NOT. ALLOCATED(tnccn_act))                                   &amp;<a name='598'>
            ALLOCATE(tnccn_act(ntb_arc,ntb_arw,ntb_art,ntb_arr,ntb_ark))<a name='599'>
<a name='600'>
      if (micro_init) then<a name='601'>
<a name='602'>
<font color=#447700>!..From Martin et al. (1994), assign gamma shape parameter mu for cloud<a name='603'></font>
<font color=#447700>!.. drops according to general dispersion characteristics (disp=~0.25<a name='604'></font>
<font color=#447700>!.. for Maritime and 0.45 for Continental).<a name='605'></font>
<font color=#447700>!.. disp=SQRT((mu+2)/(mu+1) - 1) so mu varies from 15 for Maritime<a name='606'></font>
<font color=#447700>!.. to 2 for really dirty air.  This not used in 2-moment cloud water<a name='607'></font>
<font color=#447700>!.. scheme and nu_c used instead and varies from 2 to 15 (integer-only).<a name='608'></font>
      mu_c = MIN(15., (1000.E6/Nt_c + 2.))<a name='609'>
<a name='610'>
<font color=#447700>!..Schmidt number to one-third used numerous times.<a name='611'></font>
      Sc3 = Sc**(1./3.)<a name='612'>
<a name='613'>
<font color=#447700>!..Compute min ice diam from mass, min snow/graupel mass from diam.<a name='614'></font>
      D0i = (xm0i/am_i)**(1./bm_i)<a name='615'>
      xm0s = am_s * D0s**bm_s<a name='616'>
      xm0g = am_g * D0g**bm_g<a name='617'>
<a name='618'>
<font color=#447700>!..These constants various exponents and gamma() assoc with cloud,<a name='619'></font>
<font color=#447700>!.. rain, snow, and graupel.<a name='620'></font>
      do n = 1, 15<a name='621'>
         cce(1,n) = n + 1.<a name='622'>
         cce(2,n) = bm_r + n + 1.<a name='623'>
         cce(3,n) = bm_r + n + 4.<a name='624'>
         cce(4,n) = n + bv_c + 1.<a name='625'>
         cce(5,n) = bm_r + n + bv_c + 1.<a name='626'>
         ccg(1,n) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_6">(cce(1,n))<a name='627'>
         ccg(2,n) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_7">(cce(2,n))<a name='628'>
         ccg(3,n) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_8">(cce(3,n))<a name='629'>
         ccg(4,n) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_9">(cce(4,n))<a name='630'>
         ccg(5,n) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_10">(cce(5,n))<a name='631'>
         ocg1(n) = 1./ccg(1,n)<a name='632'>
         ocg2(n) = 1./ccg(2,n)<a name='633'>
      enddo<a name='634'>
<a name='635'>
      cie(1) = mu_i + 1.<a name='636'>
      cie(2) = bm_i + mu_i + 1.<a name='637'>
      cie(3) = bm_i + mu_i + bv_i + 1.<a name='638'>
      cie(4) = mu_i + bv_i + 1.<a name='639'>
      cie(5) = mu_i + 2.<a name='640'>
      cie(6) = bm_i*0.5 + mu_i + bv_i + 1.<a name='641'>
      cie(7) = bm_i*0.5 + mu_i + 1.<a name='642'>
      cig(1) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_11">(cie(1))<a name='643'>
      cig(2) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_12">(cie(2))<a name='644'>
      cig(3) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_13">(cie(3))<a name='645'>
      cig(4) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_14">(cie(4))<a name='646'>
      cig(5) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_15">(cie(5))<a name='647'>
      cig(6) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_16">(cie(6))<a name='648'>
      cig(7) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_17">(cie(7))<a name='649'>
      oig1 = 1./cig(1)<a name='650'>
      oig2 = 1./cig(2)<a name='651'>
      obmi = 1./bm_i<a name='652'>
<a name='653'>
      cre(1) = bm_r + 1.<a name='654'>
      cre(2) = mu_r + 1.<a name='655'>
      cre(3) = bm_r + mu_r + 1.<a name='656'>
      cre(4) = bm_r*2. + mu_r + 1.<a name='657'>
      cre(5) = mu_r + bv_r + 1.<a name='658'>
      cre(6) = bm_r + mu_r + bv_r + 1.<a name='659'>
      cre(7) = bm_r*0.5 + mu_r + bv_r + 1.<a name='660'>
      cre(8) = bm_r + mu_r + bv_r + 3.<a name='661'>
      cre(9) = mu_r + bv_r + 3.<a name='662'>
      cre(10) = mu_r + 2.<a name='663'>
      cre(11) = 0.5*(bv_r + 5. + 2.*mu_r)<a name='664'>
      cre(12) = bm_r*0.5 + mu_r + 1.<a name='665'>
      cre(13) = bm_r*2. + mu_r + bv_r + 1.<a name='666'>
      do n = 1, 13<a name='667'>
         crg(n) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_18">(cre(n))<a name='668'>
      enddo<a name='669'>
      obmr = 1./bm_r<a name='670'>
      ore1 = 1./cre(1)<a name='671'>
      org1 = 1./crg(1)<a name='672'>
      org2 = 1./crg(2)<a name='673'>
      org3 = 1./crg(3)<a name='674'>
<a name='675'>
      cse(1) = bm_s + 1.<a name='676'>
      cse(2) = bm_s + 2.<a name='677'>
      cse(3) = bm_s*2.<a name='678'>
      cse(4) = bm_s + bv_s + 1.<a name='679'>
      cse(5) = bm_s*2. + bv_s + 1.<a name='680'>
      cse(6) = bm_s*2. + 1.<a name='681'>
      cse(7) = bm_s + mu_s + 1.<a name='682'>
      cse(8) = bm_s + mu_s + 2.<a name='683'>
      cse(9) = bm_s + mu_s + 3.<a name='684'>
      cse(10) = bm_s + mu_s + bv_s + 1.<a name='685'>
      cse(11) = bm_s*2. + mu_s + bv_s + 1.<a name='686'>
      cse(12) = bm_s*2. + mu_s + 1.<a name='687'>
      cse(13) = bv_s + 2.<a name='688'>
      cse(14) = bm_s + bv_s<a name='689'>
      cse(15) = mu_s + 1.<a name='690'>
      cse(16) = 1.0 + (1.0 + bv_s)/2.<a name='691'>
      cse(17) = cse(16) + mu_s + 1.<a name='692'>
      cse(18) = bv_s + mu_s + 3.<a name='693'>
      do n = 1, 18<a name='694'>
         csg(n) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_19">(cse(n))<a name='695'>
      enddo<a name='696'>
      oams = 1./am_s<a name='697'>
      obms = 1./bm_s<a name='698'>
      ocms = oams**obms<a name='699'>
<a name='700'>
      cge(1) = bm_g + 1.<a name='701'>
      cge(2) = mu_g + 1.<a name='702'>
      cge(3) = bm_g + mu_g + 1.<a name='703'>
      cge(4) = bm_g*2. + mu_g + 1.<a name='704'>
      cge(5) = bm_g*2. + mu_g + bv_g + 1.<a name='705'>
      cge(6) = bm_g + mu_g + bv_g + 1.<a name='706'>
      cge(7) = bm_g + mu_g + bv_g + 2.<a name='707'>
      cge(8) = bm_g + mu_g + bv_g + 3.<a name='708'>
      cge(9) = mu_g + bv_g + 3.<a name='709'>
      cge(10) = mu_g + 2.<a name='710'>
      cge(11) = 0.5*(bv_g + 5. + 2.*mu_g)<a name='711'>
      cge(12) = 0.5*(bv_g + 5.) + mu_g<a name='712'>
      do n = 1, 12<a name='713'>
         cgg(n) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_20">(cge(n))<a name='714'>
      enddo<a name='715'>
      oamg = 1./am_g<a name='716'>
      obmg = 1./bm_g<a name='717'>
      ocmg = oamg**obmg<a name='718'>
      oge1 = 1./cge(1)<a name='719'>
      ogg1 = 1./cgg(1)<a name='720'>
      ogg2 = 1./cgg(2)<a name='721'>
      ogg3 = 1./cgg(3)<a name='722'>
<a name='723'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='724'></font>
<font color=#447700>!..Simplify various rate eqns the best we can now.<a name='725'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='726'></font>
<a name='727'>
<font color=#447700>!..Rain collecting cloud water and cloud ice<a name='728'></font>
      t1_qr_qc = PI*.25*av_r * crg(9)<a name='729'>
      t1_qr_qi = PI*.25*av_r * crg(9)<a name='730'>
      t2_qr_qi = PI*.25*am_r*av_r * crg(8)<a name='731'>
<a name='732'>
<font color=#447700>!..Graupel collecting cloud water<a name='733'></font>
      t1_qg_qc = PI*.25*av_g * cgg(9)<a name='734'>
<a name='735'>
<font color=#447700>!..Snow collecting cloud water<a name='736'></font>
      t1_qs_qc = PI*.25*av_s<a name='737'>
<a name='738'>
<font color=#447700>!..Snow collecting cloud ice<a name='739'></font>
      t1_qs_qi = PI*.25*av_s<a name='740'>
<a name='741'>
<font color=#447700>!..Evaporation of rain; ignore depositional growth of rain.<a name='742'></font>
      t1_qr_ev = 0.78 * crg(10)<a name='743'>
      t2_qr_ev = 0.308*Sc3*SQRT(av_r) * crg(11)<a name='744'>
<a name='745'>
<font color=#447700>!..Sublimation/depositional growth of snow<a name='746'></font>
      t1_qs_sd = 0.86<a name='747'>
      t2_qs_sd = 0.28*Sc3*SQRT(av_s)<a name='748'>
<a name='749'>
<font color=#447700>!..Melting of snow<a name='750'></font>
      t1_qs_me = PI*4.*C_sqrd*olfus * 0.86<a name='751'>
      t2_qs_me = PI*4.*C_sqrd*olfus * 0.28*Sc3*SQRT(av_s)<a name='752'>
<a name='753'>
<font color=#447700>!..Sublimation/depositional growth of graupel<a name='754'></font>
      t1_qg_sd = 0.86 * cgg(10)<a name='755'>
      t2_qg_sd = 0.28*Sc3*SQRT(av_g) * cgg(11)<a name='756'>
<a name='757'>
<font color=#447700>!..Melting of graupel<a name='758'></font>
      t1_qg_me = PI*4.*C_cube*olfus * 0.86 * cgg(10)<a name='759'>
      t2_qg_me = PI*4.*C_cube*olfus * 0.28*Sc3*SQRT(av_g) * cgg(11)<a name='760'>
<a name='761'>
<font color=#447700>!..Constants for helping find lookup table indexes.<a name='762'></font>
      nic2 = NINT(ALOG10(r_c(1)))<a name='763'>
      nii2 = NINT(ALOG10(r_i(1)))<a name='764'>
      nii3 = NINT(ALOG10(Nt_i(1)))<a name='765'>
      nir2 = NINT(ALOG10(r_r(1)))<a name='766'>
      nir3 = NINT(ALOG10(N0r_exp(1)))<a name='767'>
      nis2 = NINT(ALOG10(r_s(1)))<a name='768'>
      nig2 = NINT(ALOG10(r_g(1)))<a name='769'>
      nig3 = NINT(ALOG10(N0g_exp(1)))<a name='770'>
      niIN2 = NINT(ALOG10(Nt_IN(1)))<a name='771'>
<a name='772'>
<font color=#447700>!..Create bins of cloud water (from min diameter up to 100 microns).<a name='773'></font>
      Dc(1) = D0c*1.0d0<a name='774'>
      dtc(1) = D0c*1.0d0<a name='775'>
      do n = 2, nbc<a name='776'>
         Dc(n) = Dc(n-1) + 1.0D-6<a name='777'>
         dtc(n) = (Dc(n) - Dc(n-1))<a name='778'>
      enddo<a name='779'>
<a name='780'>
<font color=#447700>!..Create bins of cloud ice (from min diameter up to 5x min snow size).<a name='781'></font>
      xDx(1) = D0i*1.0d0<a name='782'>
      xDx(nbi+1) = 5.0d0*D0s<a name='783'>
      do n = 2, nbi<a name='784'>
         xDx(n) = DEXP(DFLOAT(n-1)/DFLOAT(nbi) &amp;<a name='785'>
                  *DLOG(xDx(nbi+1)/xDx(1)) +DLOG(xDx(1)))<a name='786'>
      enddo<a name='787'>
      do n = 1, nbi<a name='788'>
         Di(n) = DSQRT(xDx(n)*xDx(n+1))<a name='789'>
         dti(n) = xDx(n+1) - xDx(n)<a name='790'>
      enddo<a name='791'>
<a name='792'>
<font color=#447700>!..Create bins of rain (from min diameter up to 5 mm).<a name='793'></font>
      xDx(1) = D0r*1.0d0<a name='794'>
      xDx(nbr+1) = 0.005d0<a name='795'>
      do n = 2, nbr<a name='796'>
         xDx(n) = DEXP(DFLOAT(n-1)/DFLOAT(nbr) &amp;<a name='797'>
                  *DLOG(xDx(nbr+1)/xDx(1)) +DLOG(xDx(1)))<a name='798'>
      enddo<a name='799'>
      do n = 1, nbr<a name='800'>
         Dr(n) = DSQRT(xDx(n)*xDx(n+1))<a name='801'>
         dtr(n) = xDx(n+1) - xDx(n)<a name='802'>
      enddo<a name='803'>
<a name='804'>
<font color=#447700>!..Create bins of snow (from min diameter up to 2 cm).<a name='805'></font>
      xDx(1) = D0s*1.0d0<a name='806'>
      xDx(nbs+1) = 0.02d0<a name='807'>
      do n = 2, nbs<a name='808'>
         xDx(n) = DEXP(DFLOAT(n-1)/DFLOAT(nbs) &amp;<a name='809'>
                  *DLOG(xDx(nbs+1)/xDx(1)) +DLOG(xDx(1)))<a name='810'>
      enddo<a name='811'>
      do n = 1, nbs<a name='812'>
         Ds(n) = DSQRT(xDx(n)*xDx(n+1))<a name='813'>
         dts(n) = xDx(n+1) - xDx(n)<a name='814'>
      enddo<a name='815'>
<a name='816'>
<font color=#447700>!..Create bins of graupel (from min diameter up to 5 cm).<a name='817'></font>
      xDx(1) = D0g*1.0d0<a name='818'>
      xDx(nbg+1) = 0.05d0<a name='819'>
      do n = 2, nbg<a name='820'>
         xDx(n) = DEXP(DFLOAT(n-1)/DFLOAT(nbg) &amp;<a name='821'>
                  *DLOG(xDx(nbg+1)/xDx(1)) +DLOG(xDx(1)))<a name='822'>
      enddo<a name='823'>
      do n = 1, nbg<a name='824'>
         Dg(n) = DSQRT(xDx(n)*xDx(n+1))<a name='825'>
         dtg(n) = xDx(n+1) - xDx(n)<a name='826'>
      enddo<a name='827'>
<a name='828'>
<font color=#447700>!..Create bins of cloud droplet number concentration (1 to 3000 per cc).<a name='829'></font>
      xDx(1) = 1.0d0<a name='830'>
      xDx(nbc+1) = 3000.0d0<a name='831'>
      do n = 2, nbc<a name='832'>
         xDx(n) = DEXP(DFLOAT(n-1)/DFLOAT(nbc)                          &amp;<a name='833'>
                  *DLOG(xDx(nbc+1)/xDx(1)) +DLOG(xDx(1)))<a name='834'>
      enddo<a name='835'>
      do n = 1, nbc<a name='836'>
         t_Nc(n) = DSQRT(xDx(n)*xDx(n+1)) * 1.D6<a name='837'>
      enddo<a name='838'>
      nic1 = DLOG(t_Nc(nbc)/t_Nc(1))<a name='839'>
<a name='840'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='841'></font>
<font color=#447700>!..Create lookup tables for most costly calculations.<a name='842'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='843'></font>
<a name='844'>
      do m = 1, ntb_r<a name='845'>
         do k = 1, ntb_r1<a name='846'>
            do j = 1, ntb_g<a name='847'>
               do i = 1, ntb_g1<a name='848'>
                  tcg_racg(i,j,k,m) = 0.0d0<a name='849'>
                  tmr_racg(i,j,k,m) = 0.0d0<a name='850'>
                  tcr_gacr(i,j,k,m) = 0.0d0<a name='851'>
                  tmg_gacr(i,j,k,m) = 0.0d0<a name='852'>
                  tnr_racg(i,j,k,m) = 0.0d0<a name='853'>
                  tnr_gacr(i,j,k,m) = 0.0d0<a name='854'>
               enddo<a name='855'>
            enddo<a name='856'>
         enddo<a name='857'>
      enddo<a name='858'>
<a name='859'>
      do m = 1, ntb_r<a name='860'>
         do k = 1, ntb_r1<a name='861'>
            do j = 1, ntb_t<a name='862'>
               do i = 1, ntb_s<a name='863'>
                  tcs_racs1(i,j,k,m) = 0.0d0<a name='864'>
                  tmr_racs1(i,j,k,m) = 0.0d0<a name='865'>
                  tcs_racs2(i,j,k,m) = 0.0d0<a name='866'>
                  tmr_racs2(i,j,k,m) = 0.0d0<a name='867'>
                  tcr_sacr1(i,j,k,m) = 0.0d0<a name='868'>
                  tms_sacr1(i,j,k,m) = 0.0d0<a name='869'>
                  tcr_sacr2(i,j,k,m) = 0.0d0<a name='870'>
                  tms_sacr2(i,j,k,m) = 0.0d0<a name='871'>
                  tnr_racs1(i,j,k,m) = 0.0d0<a name='872'>
                  tnr_racs2(i,j,k,m) = 0.0d0<a name='873'>
                  tnr_sacr1(i,j,k,m) = 0.0d0<a name='874'>
                  tnr_sacr2(i,j,k,m) = 0.0d0<a name='875'>
               enddo<a name='876'>
            enddo<a name='877'>
         enddo<a name='878'>
      enddo<a name='879'>
<a name='880'>
      do m = 1, ntb_IN<a name='881'>
         do k = 1, 45<a name='882'>
            do j = 1, ntb_r1<a name='883'>
               do i = 1, ntb_r<a name='884'>
                  tpi_qrfz(i,j,k,m) = 0.0d0<a name='885'>
                  tni_qrfz(i,j,k,m) = 0.0d0<a name='886'>
                  tpg_qrfz(i,j,k,m) = 0.0d0<a name='887'>
                  tnr_qrfz(i,j,k,m) = 0.0d0<a name='888'>
               enddo<a name='889'>
            enddo<a name='890'>
            do j = 1, nbc<a name='891'>
               do i = 1, ntb_c<a name='892'>
                  tpi_qcfz(i,j,k,m) = 0.0d0<a name='893'>
                  tni_qcfz(i,j,k,m) = 0.0d0<a name='894'>
               enddo<a name='895'>
            enddo<a name='896'>
         enddo<a name='897'>
      enddo<a name='898'>
<a name='899'>
      do j = 1, ntb_i1<a name='900'>
         do i = 1, ntb_i<a name='901'>
            tps_iaus(i,j) = 0.0d0<a name='902'>
            tni_iaus(i,j) = 0.0d0<a name='903'>
            tpi_ide(i,j) = 0.0d0<a name='904'>
         enddo<a name='905'>
      enddo<a name='906'>
<a name='907'>
      do j = 1, nbc<a name='908'>
         do i = 1, nbr<a name='909'>
            t_Efrw(i,j) = 0.0<a name='910'>
         enddo<a name='911'>
         do i = 1, nbs<a name='912'>
            t_Efsw(i,j) = 0.0<a name='913'>
         enddo<a name='914'>
      enddo<a name='915'>
<a name='916'>
      do k = 1, ntb_r<a name='917'>
         do j = 1, ntb_r1<a name='918'>
            do i = 1, nbr<a name='919'>
               tnr_rev(i,j,k) = 0.0d0<a name='920'>
            enddo<a name='921'>
         enddo<a name='922'>
      enddo<a name='923'>
<a name='924'>
      do k = 1, nbc<a name='925'>
         do j = 1, ntb_c<a name='926'>
            do i = 1, nbc<a name='927'>
               tpc_wev(i,j,k) = 0.0d0<a name='928'>
               tnc_wev(i,j,k) = 0.0d0<a name='929'>
            enddo<a name='930'>
         enddo<a name='931'>
      enddo<a name='932'>
<a name='933'>
      do m = 1, ntb_ark<a name='934'>
         do l = 1, ntb_arr<a name='935'>
            do k = 1, ntb_art<a name='936'>
               do j = 1, ntb_arw<a name='937'>
                  do i = 1, ntb_arc<a name='938'>
                     tnccn_act(i,j,k,l,m) = 1.0<a name='939'>
                  enddo<a name='940'>
               enddo<a name='941'>
            enddo<a name='942'>
         enddo<a name='943'>
      enddo<a name='944'>
<a name='945'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_670">(150, 'CREATING MICROPHYSICS LOOKUP TABLES ... ')<a name='946'>
      WRITE (wrf_err_message, '(a, f5.2, a, f5.2, a, f5.2, a, f5.2)') &amp;<a name='947'>
          ' using: mu_c=',mu_c,' mu_i=',mu_i,' mu_r=',mu_r,' mu_g=',mu_g<a name='948'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_671">(150, wrf_err_message)<a name='949'>
<a name='950'>
<font color=#447700>!..Read a static file containing CCN activation of aerosols. The<a name='951'></font>
<font color=#447700>!.. data were created from a parcel model by Feingold &amp; Heymsfield with<a name='952'></font>
<font color=#447700>!.. further changes by Eidhammer and Kriedenweis.<a name='953'></font>
      if (is_aerosol_aware) then<a name='954'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_672">(200, '  calling table_ccnAct routine')<a name='955'>
         call <A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_CCNACT'>table_ccnAct</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TABLE_CCNACT_1"><a name='956'>
      endif<a name='957'>
<a name='958'>
<font color=#447700>!..Collision efficiency between rain/snow and cloud water.<a name='959'></font>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_673">(200, '  creating qc collision eff tables')<a name='960'>
      call <A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_EFRW'>table_Efrw</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TABLE_EFRW_1"><a name='961'>
      call <A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_EFSW'>table_Efsw</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TABLE_EFSW_1"><a name='962'>
<a name='963'>
<font color=#447700>!..Drop evaporation.<a name='964'></font>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_674">(200, '  creating rain evap table')<a name='965'>
      call <A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_DROPEVAP'>table_dropEvap</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TABLE_DROPEVAP_1"><a name='966'>
<a name='967'>
<font color=#447700>!..Initialize various constants for computing radar reflectivity.<a name='968'></font>
      xam_r = am_r<a name='969'>
      xbm_r = bm_r<a name='970'>
      xmu_r = mu_r<a name='971'>
      xam_s = am_s<a name='972'>
      xbm_s = bm_s<a name='973'>
      xmu_s = mu_s<a name='974'>
      xam_g = am_g<a name='975'>
      xbm_g = bm_g<a name='976'>
      xmu_g = mu_g<a name='977'>
      call <A href='../../html_code/phys/module_mp_radar.F.html#RADAR_INIT'>radar_init</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADAR_INIT_6"><a name='978'>
<a name='979'>
      if (.not. iiwarm) then<a name='980'>
<a name='981'>
<font color=#447700>!..Rain collecting graupel &amp; graupel collecting rain.<a name='982'></font>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_675">(200, '  creating rain collecting graupel table')<a name='983'>
      call <A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG'>qr_acr_qg</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QR_ACR_QG_1"><a name='984'>
<a name='985'>
<font color=#447700>!..Rain collecting snow &amp; snow collecting rain.<a name='986'></font>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_676">(200, '  creating rain collecting snow table')<a name='987'>
      call <A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS'>qr_acr_qs</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QR_ACR_QS_1"><a name='988'>
<a name='989'>
<font color=#447700>!..Cloud water and rain freezing (Bigg, 1953).<a name='990'></font>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_677">(200, '  creating freezing of water drops table')<a name='991'>
      call <A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O'>freezeH2O</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FREEZEH2O_1"><a name='992'>
<a name='993'>
<font color=#447700>!..Conversion of some ice mass into snow category.<a name='994'></font>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_678">(200, '  creating ice converting to snow table')<a name='995'>
      call <A href='../../html_code/phys/module_mp_thompson.F.html#QI_AUT_QS'>qi_aut_qs</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QI_AUT_QS_1"><a name='996'>
<a name='997'>
      endif<a name='998'>
<a name='999'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#THOMPSON_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_679">(150, ' ... DONE microphysical lookup tables')<a name='1000'>
<a name='1001'>
      endif<a name='1002'>
<a name='1003'>
      END SUBROUTINE thompson_init<a name='1004'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1005'></font>
<font color=#447700>!ctrlL<a name='1006'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1007'></font>
<font color=#447700>!..This is a wrapper routine designed to transfer values from 3D to 1D.<a name='1008'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1009'></font>
<A NAME='MP_GT_DRIVER'><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1010'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>mp_gt_driver</font>(qv, qc, qr, qi, qs, qg, ni, nr, nc,       &amp; <A href='../../call_to/MP_GT_DRIVER.html' TARGET='index'>2</A>,<A href='../../call_from/MP_GT_DRIVER.html' TARGET='index'>14</A><a name='1011'>
                              nwfa, nifa, nwfa2d,                       &amp;<a name='1012'>
                              th, pii, p, w, dz, dt_in, itimestep,      &amp;<a name='1013'>
                              RAINNC, RAINNCV, &amp;<a name='1014'>
                              SNOWNC, SNOWNCV, &amp;<a name='1015'>
                              GRAUPELNC, GRAUPELNCV, SR, &amp;<a name='1016'>
#if ( WRF_CHEM == 1 )<a name='1017'>
                              rainprod, evapprod, &amp;<a name='1018'>
#endif<a name='1019'>
                              refl_10cm, diagflag, do_radar_ref,      &amp;<a name='1020'>
                              re_cloud, re_ice, re_snow,              &amp;<a name='1021'>
                              has_reqc, has_reqi, has_reqs,           &amp;<a name='1022'>
                              ids,ide, jds,jde, kds,kde, &amp;             <font color=#447700>! domain dims<a name='1023'></font>
                              ims,ime, jms,jme, kms,kme, &amp;             <font color=#447700>! memory dims<a name='1024'></font>
                              its,ite, jts,jte, kts,kte)               <font color=#447700>! tile dims<a name='1025'></font>
<a name='1026'>
      implicit none<a name='1027'>
<a name='1028'>
<font color=#447700>!..Subroutine arguments<a name='1029'></font>
      INTEGER, INTENT(IN):: ids,ide, jds,jde, kds,kde, &amp;<a name='1030'>
                            ims,ime, jms,jme, kms,kme, &amp;<a name='1031'>
                            its,ite, jts,jte, kts,kte<a name='1032'>
      REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT):: &amp;<a name='1033'>
                          qv, qc, qr, qi, qs, qg, ni, nr, th<a name='1034'>
      REAL, DIMENSION(ims:ime, kms:kme, jms:jme), OPTIONAL, INTENT(INOUT):: &amp;<a name='1035'>
                          nc, nwfa, nifa<a name='1036'>
      REAL, DIMENSION(ims:ime, jms:jme), OPTIONAL, INTENT(IN):: nwfa2d<a name='1037'>
      REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT):: &amp;<a name='1038'>
                          re_cloud, re_ice, re_snow<a name='1039'>
      INTEGER, INTENT(IN):: has_reqc, has_reqi, has_reqs<a name='1040'>
#if ( WRF_CHEM == 1 )<a name='1041'>
      REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT):: &amp;<a name='1042'>
                          rainprod, evapprod<a name='1043'>
#endif<a name='1044'>
      REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN):: &amp;<a name='1045'>
                          pii, p, w, dz<a name='1046'>
      REAL, DIMENSION(ims:ime, jms:jme), INTENT(INOUT):: &amp;<a name='1047'>
                          RAINNC, RAINNCV, SR<a name='1048'>
      REAL, DIMENSION(ims:ime, jms:jme), OPTIONAL, INTENT(INOUT)::      &amp;<a name='1049'>
                          SNOWNC, SNOWNCV, GRAUPELNC, GRAUPELNCV<a name='1050'>
      REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT)::       &amp;<a name='1051'>
                          refl_10cm<a name='1052'>
      REAL, INTENT(IN):: dt_in<a name='1053'>
      INTEGER, INTENT(IN):: itimestep<a name='1054'>
<a name='1055'>
<font color=#447700>!..Local variables<a name='1056'></font>
      REAL, DIMENSION(kts:kte):: &amp;<a name='1057'>
                          qv1d, qc1d, qi1d, qr1d, qs1d, qg1d, ni1d,     &amp;<a name='1058'>
                          nr1d, nc1d, nwfa1d, nifa1d,                   &amp;<a name='1059'>
                          t1d, p1d, w1d, dz1d, rho, dBZ<a name='1060'>
      REAL, DIMENSION(kts:kte):: re_qc1d, re_qi1d, re_qs1d<a name='1061'>
#if ( WRF_CHEM == 1 )<a name='1062'>
      REAL, DIMENSION(kts:kte):: &amp;<a name='1063'>
                          rainprod1d, evapprod1d<a name='1064'>
#endif<a name='1065'>
      REAL, DIMENSION(its:ite, jts:jte):: pcp_ra, pcp_sn, pcp_gr, pcp_ic<a name='1066'>
      REAL:: dt, pptrain, pptsnow, pptgraul, pptice<a name='1067'>
      REAL:: qc_max, qr_max, qs_max, qi_max, qg_max, ni_max, nr_max<a name='1068'>
      REAL:: nwfa1<a name='1069'>
      INTEGER:: i, j, k<a name='1070'>
      INTEGER:: imax_qc,imax_qr,imax_qi,imax_qs,imax_qg,imax_ni,imax_nr<a name='1071'>
      INTEGER:: jmax_qc,jmax_qr,jmax_qi,jmax_qs,jmax_qg,jmax_ni,jmax_nr<a name='1072'>
      INTEGER:: kmax_qc,kmax_qr,kmax_qi,kmax_qs,kmax_qg,kmax_ni,kmax_nr<a name='1073'>
      INTEGER:: i_start, j_start, i_end, j_end<a name='1074'>
      LOGICAL, OPTIONAL, INTENT(IN) :: diagflag<a name='1075'>
      INTEGER, OPTIONAL, INTENT(IN) :: do_radar_ref<a name='1076'>
      CHARACTER*256:: mp_debug<a name='1077'>
<a name='1078'>
<font color=#447700>!+---+<a name='1079'></font>
<a name='1080'>
      i_start = its<a name='1081'>
      j_start = jts<a name='1082'>
      i_end   = MIN(ite, ide-1)<a name='1083'>
      j_end   = MIN(jte, jde-1)<a name='1084'>
<a name='1085'>
<font color=#447700>!..For idealized testing by developer.<a name='1086'></font>
<font color=#447700>!     if ( (ide-ids+1).gt.4 .and. (jde-jds+1).lt.4 .and.                &amp;<a name='1087'></font>
<font color=#447700>!          ids.eq.its.and.ide.eq.ite.and.jds.eq.jts.and.jde.eq.jte) then<a name='1088'></font>
<font color=#447700>!        i_start = its + 2<a name='1089'></font>
<font color=#447700>!        i_end   = ite<a name='1090'></font>
<font color=#447700>!        j_start = jts<a name='1091'></font>
<font color=#447700>!        j_end   = jte<a name='1092'></font>
<font color=#447700>!     endif<a name='1093'></font>
<a name='1094'>
      dt = dt_in<a name='1095'>
   <a name='1096'>
      qc_max = 0.<a name='1097'>
      qr_max = 0.<a name='1098'>
      qs_max = 0.<a name='1099'>
      qi_max = 0.<a name='1100'>
      qg_max = 0<a name='1101'>
      ni_max = 0.<a name='1102'>
      nr_max = 0.<a name='1103'>
      imax_qc = 0<a name='1104'>
      imax_qr = 0<a name='1105'>
      imax_qi = 0<a name='1106'>
      imax_qs = 0<a name='1107'>
      imax_qg = 0<a name='1108'>
      imax_ni = 0<a name='1109'>
      imax_nr = 0<a name='1110'>
      jmax_qc = 0<a name='1111'>
      jmax_qr = 0<a name='1112'>
      jmax_qi = 0<a name='1113'>
      jmax_qs = 0<a name='1114'>
      jmax_qg = 0<a name='1115'>
      jmax_ni = 0<a name='1116'>
      jmax_nr = 0<a name='1117'>
      kmax_qc = 0<a name='1118'>
      kmax_qr = 0<a name='1119'>
      kmax_qi = 0<a name='1120'>
      kmax_qs = 0<a name='1121'>
      kmax_qg = 0<a name='1122'>
      kmax_ni = 0<a name='1123'>
      kmax_nr = 0<a name='1124'>
      do i = 1, 256<a name='1125'>
         mp_debug(i:i) = char(0)<a name='1126'>
      enddo<a name='1127'>
<a name='1128'>
      if (.NOT. is_aerosol_aware .AND. PRESENT(nc) .AND. PRESENT(nwfa)  &amp;<a name='1129'>
                .AND. PRESENT(nifa) .AND. PRESENT(nwfa2d)) then<a name='1130'>
         write(mp_debug,*) 'WARNING, nc-nwfa-nifa-nwfa2d present but is_aerosol_aware is FALSE'<a name='1131'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_680">(0, mp_debug)<a name='1132'>
      endif<a name='1133'>
<a name='1134'>
      j_loop:  do j = j_start, j_end<a name='1135'>
      i_loop:  do i = i_start, i_end<a name='1136'>
<a name='1137'>
         pptrain = 0.<a name='1138'>
         pptsnow = 0.<a name='1139'>
         pptgraul = 0.<a name='1140'>
         pptice = 0.<a name='1141'>
         RAINNCV(i,j) = 0.<a name='1142'>
         IF ( PRESENT (snowncv) ) THEN<a name='1143'>
            SNOWNCV(i,j) = 0.<a name='1144'>
         ENDIF<a name='1145'>
         IF ( PRESENT (graupelncv) ) THEN<a name='1146'>
            GRAUPELNCV(i,j) = 0.<a name='1147'>
         ENDIF<a name='1148'>
         SR(i,j) = 0.<a name='1149'>
<a name='1150'>
         do k = kts, kte<a name='1151'>
            t1d(k) = th(i,k,j)*pii(i,k,j)<a name='1152'>
            p1d(k) = p(i,k,j)<a name='1153'>
            w1d(k) = w(i,k,j)<a name='1154'>
            dz1d(k) = dz(i,k,j)<a name='1155'>
            qv1d(k) = qv(i,k,j)<a name='1156'>
            qc1d(k) = qc(i,k,j)<a name='1157'>
            qi1d(k) = qi(i,k,j)<a name='1158'>
            qr1d(k) = qr(i,k,j)<a name='1159'>
            qs1d(k) = qs(i,k,j)<a name='1160'>
            qg1d(k) = qg(i,k,j)<a name='1161'>
            ni1d(k) = ni(i,k,j)<a name='1162'>
            nr1d(k) = nr(i,k,j)<a name='1163'>
         enddo<a name='1164'>
         if (is_aerosol_aware) then<a name='1165'>
            do k = kts, kte<a name='1166'>
               nc1d(k) = nc(i,k,j)<a name='1167'>
               nwfa1d(k) = nwfa(i,k,j)<a name='1168'>
               nifa1d(k) = nifa(i,k,j)<a name='1169'>
            enddo<a name='1170'>
            nwfa1 = nwfa2d(i,j)<a name='1171'>
         else<a name='1172'>
            do k = kts, kte<a name='1173'>
               rho(k) = 0.622*p1d(k)/(R*t1d(k)*(qv1d(k)+0.622))<a name='1174'>
               nc1d(k) = Nt_c/rho(k)<a name='1175'>
               nwfa1d(k) = 11.1E6/rho(k)<a name='1176'>
               nifa1d(k) = naIN1*0.01/rho(k)<a name='1177'>
            enddo<a name='1178'>
            nwfa1 = 11.1E6<a name='1179'>
         endif<a name='1180'>
<a name='1181'>
         call <A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON'>mp_thompson</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MP_THOMPSON_1">(qv1d, qc1d, qi1d, qr1d, qs1d, qg1d, ni1d,     &amp;<a name='1182'>
                      nr1d, nc1d, nwfa1d, nifa1d, t1d, p1d, w1d, dz1d,  &amp;<a name='1183'>
                      pptrain, pptsnow, pptgraul, pptice, &amp;<a name='1184'>
#if ( WRF_CHEM == 1 )<a name='1185'>
                      rainprod1d, evapprod1d, &amp;<a name='1186'>
#endif<a name='1187'>
                      kts, kte, dt, i, j)<a name='1188'>
<a name='1189'>
         pcp_ra(i,j) = pptrain<a name='1190'>
         pcp_sn(i,j) = pptsnow<a name='1191'>
         pcp_gr(i,j) = pptgraul<a name='1192'>
         pcp_ic(i,j) = pptice<a name='1193'>
         RAINNCV(i,j) = pptrain + pptsnow + pptgraul + pptice<a name='1194'>
         RAINNC(i,j) = RAINNC(i,j) + pptrain + pptsnow + pptgraul + pptice<a name='1195'>
         IF ( PRESENT(snowncv) .AND. PRESENT(snownc) ) THEN<a name='1196'>
            SNOWNCV(i,j) = pptsnow + pptice<a name='1197'>
            SNOWNC(i,j) = SNOWNC(i,j) + pptsnow + pptice<a name='1198'>
         ENDIF<a name='1199'>
         IF ( PRESENT(graupelncv) .AND. PRESENT(graupelnc) ) THEN<a name='1200'>
            GRAUPELNCV(i,j) = pptgraul<a name='1201'>
            GRAUPELNC(i,j) = GRAUPELNC(i,j) + pptgraul<a name='1202'>
         ENDIF<a name='1203'>
         SR(i,j) = (pptsnow + pptgraul + pptice)/(RAINNCV(i,j)+1.e-12)<a name='1204'>
<a name='1205'>
<a name='1206'>
<a name='1207'>
<font color=#447700>!..Reset lowest model level to initial state aerosols (fake sfc source).<a name='1208'></font>
<font color=#447700>!.. Changed 13 May 2013 to fake emissions in which nwfa2d is aerosol<a name='1209'></font>
<font color=#447700>!.. number tendency (number per kg per second).<a name='1210'></font>
         if (is_aerosol_aware) then<a name='1211'>
<font color=#447700>!-GT        nwfa1d(kts) = nwfa1<a name='1212'></font>
            nwfa1d(kts) = nwfa1d(kts) + nwfa2d(i,j)*dt_in<a name='1213'>
<a name='1214'>
            do k = kts, kte<a name='1215'>
               nc(i,k,j) = nc1d(k)<a name='1216'>
               nwfa(i,k,j) = nwfa1d(k)<a name='1217'>
               nifa(i,k,j) = nifa1d(k)<a name='1218'>
            enddo<a name='1219'>
         endif<a name='1220'>
<a name='1221'>
         do k = kts, kte<a name='1222'>
            qv(i,k,j) = qv1d(k)<a name='1223'>
            qc(i,k,j) = qc1d(k)<a name='1224'>
            qi(i,k,j) = qi1d(k)<a name='1225'>
            qr(i,k,j) = qr1d(k)<a name='1226'>
            qs(i,k,j) = qs1d(k)<a name='1227'>
            qg(i,k,j) = qg1d(k)<a name='1228'>
            ni(i,k,j) = ni1d(k)<a name='1229'>
            nr(i,k,j) = nr1d(k)<a name='1230'>
            th(i,k,j) = t1d(k)/pii(i,k,j)<a name='1231'>
#if ( WRF_CHEM == 1 )<a name='1232'>
            rainprod(i,k,j) = rainprod1d(k)<a name='1233'>
            evapprod(i,k,j) = evapprod1d(k)<a name='1234'>
#endif<a name='1235'>
            if (qc1d(k) .gt. qc_max) then<a name='1236'>
             imax_qc = i<a name='1237'>
             jmax_qc = j<a name='1238'>
             kmax_qc = k<a name='1239'>
             qc_max = qc1d(k)<a name='1240'>
            elseif (qc1d(k) .lt. 0.0) then<a name='1241'>
             write(mp_debug,*) 'WARNING, negative qc ', qc1d(k),        &amp;<a name='1242'>
                        ' at i,j,k=', i,j,k<a name='1243'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_681">(150, mp_debug)<a name='1244'>
            endif<a name='1245'>
            if (qr1d(k) .gt. qr_max) then<a name='1246'>
             imax_qr = i<a name='1247'>
             jmax_qr = j<a name='1248'>
             kmax_qr = k<a name='1249'>
             qr_max = qr1d(k)<a name='1250'>
            elseif (qr1d(k) .lt. 0.0) then<a name='1251'>
             write(mp_debug,*) 'WARNING, negative qr ', qr1d(k),        &amp;<a name='1252'>
                        ' at i,j,k=', i,j,k<a name='1253'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_682">(150, mp_debug)<a name='1254'>
            endif<a name='1255'>
            if (nr1d(k) .gt. nr_max) then<a name='1256'>
             imax_nr = i<a name='1257'>
             jmax_nr = j<a name='1258'>
             kmax_nr = k<a name='1259'>
             nr_max = nr1d(k)<a name='1260'>
            elseif (nr1d(k) .lt. 0.0) then<a name='1261'>
             write(mp_debug,*) 'WARNING, negative nr ', nr1d(k),        &amp;<a name='1262'>
                        ' at i,j,k=', i,j,k<a name='1263'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_683">(150, mp_debug)<a name='1264'>
            endif<a name='1265'>
            if (qs1d(k) .gt. qs_max) then<a name='1266'>
             imax_qs = i<a name='1267'>
             jmax_qs = j<a name='1268'>
             kmax_qs = k<a name='1269'>
             qs_max = qs1d(k)<a name='1270'>
            elseif (qs1d(k) .lt. 0.0) then<a name='1271'>
             write(mp_debug,*) 'WARNING, negative qs ', qs1d(k),        &amp;<a name='1272'>
                        ' at i,j,k=', i,j,k<a name='1273'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_684">(150, mp_debug)<a name='1274'>
            endif<a name='1275'>
            if (qi1d(k) .gt. qi_max) then<a name='1276'>
             imax_qi = i<a name='1277'>
             jmax_qi = j<a name='1278'>
             kmax_qi = k<a name='1279'>
             qi_max = qi1d(k)<a name='1280'>
            elseif (qi1d(k) .lt. 0.0) then<a name='1281'>
             write(mp_debug,*) 'WARNING, negative qi ', qi1d(k),        &amp;<a name='1282'>
                        ' at i,j,k=', i,j,k<a name='1283'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_685">(150, mp_debug)<a name='1284'>
            endif<a name='1285'>
            if (qg1d(k) .gt. qg_max) then<a name='1286'>
             imax_qg = i<a name='1287'>
             jmax_qg = j<a name='1288'>
             kmax_qg = k<a name='1289'>
             qg_max = qg1d(k)<a name='1290'>
            elseif (qg1d(k) .lt. 0.0) then<a name='1291'>
             write(mp_debug,*) 'WARNING, negative qg ', qg1d(k),        &amp;<a name='1292'>
                        ' at i,j,k=', i,j,k<a name='1293'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_686">(150, mp_debug)<a name='1294'>
            endif<a name='1295'>
            if (ni1d(k) .gt. ni_max) then<a name='1296'>
             imax_ni = i<a name='1297'>
             jmax_ni = j<a name='1298'>
             kmax_ni = k<a name='1299'>
             ni_max = ni1d(k)<a name='1300'>
            elseif (ni1d(k) .lt. 0.0) then<a name='1301'>
             write(mp_debug,*) 'WARNING, negative ni ', ni1d(k),        &amp;<a name='1302'>
                        ' at i,j,k=', i,j,k<a name='1303'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_687">(150, mp_debug)<a name='1304'>
            endif<a name='1305'>
            if (qv1d(k) .lt. 0.0) then<a name='1306'>
             write(mp_debug,*) 'WARNING, negative qv ', qv1d(k),        &amp;<a name='1307'>
                        ' at i,j,k=', i,j,k<a name='1308'>
             CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_688">(150, mp_debug)<a name='1309'>
             if (k.lt.kte-2 .and. k.gt.kts+1) then<a name='1310'>
                write(mp_debug,*) '   below and above are: ', qv(i,k-1,j), qv(i,k+1,j)<a name='1311'>
                CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_689">(150, mp_debug)<a name='1312'>
                qv(i,k,j) = MAX(1.E-7, 0.5*(qv(i,k-1,j) + qv(i,k+1,j)))<a name='1313'>
             else<a name='1314'>
                qv(i,k,j) = 1.E-7<a name='1315'>
             endif<a name='1316'>
            endif<a name='1317'>
         enddo<a name='1318'>
<a name='1319'>
         IF ( PRESENT (diagflag) ) THEN<a name='1320'>
         if (diagflag .and. do_radar_ref == 1) then<a name='1321'>
          call <A href='../../html_code/phys/module_mp_thompson.F.html#CALC_REFL10CM'>calc_refl10cm</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_REFL10CM_1"> (qv1d, qc1d, qr1d, nr1d, qs1d, qg1d,       &amp;<a name='1322'>
                      t1d, p1d, dBZ, kts, kte, i, j)<a name='1323'>
          do k = kts, kte<a name='1324'>
             refl_10cm(i,k,j) = MAX(-35., dBZ(k))<a name='1325'>
          enddo<a name='1326'>
         endif<a name='1327'>
         ENDIF<a name='1328'>
<a name='1329'>
         IF (has_reqc.ne.0 .and. has_reqi.ne.0 .and. has_reqs.ne.0) THEN<a name='1330'>
          do k = kts, kte<a name='1331'>
             re_qc1d(k) = 2.49E-6<a name='1332'>
             re_qi1d(k) = 4.99E-6<a name='1333'>
             re_qs1d(k) = 9.99E-6<a name='1334'>
          enddo<a name='1335'>
          call <A href='../../html_code/phys/module_mp_thompson.F.html#CALC_EFFECTRAD'>calc_effectRad</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_EFFECTRAD_1"> (t1d, p1d, qv1d, qc1d, nc1d, qi1d, ni1d, qs1d,  &amp;<a name='1336'>
                      re_qc1d, re_qi1d, re_qs1d, kts, kte)<a name='1337'>
          do k = kts, kte<a name='1338'>
             re_cloud(i,k,j) = MAX(2.49E-6, MIN(re_qc1d(k), 50.E-6))<a name='1339'>
             re_ice(i,k,j)   = MAX(4.99E-6, MIN(re_qi1d(k), 125.E-6))<a name='1340'>
             re_snow(i,k,j)  = MAX(9.99E-6, MIN(re_qs1d(k), 999.E-6))<a name='1341'>
          enddo<a name='1342'>
         ENDIF<a name='1343'>
<a name='1344'>
      enddo i_loop<a name='1345'>
      enddo j_loop<a name='1346'>
<a name='1347'>
<font color=#447700>! DEBUG - GT<a name='1348'></font>
      write(mp_debug,'(a,7(a,e13.6,1x,a,i3,a,i3,a,i3,a,1x))') 'MP-GT:', &amp;<a name='1349'>
         'qc: ', qc_max, '(', imax_qc, ',', jmax_qc, ',', kmax_qc, ')', &amp;<a name='1350'>
         'qr: ', qr_max, '(', imax_qr, ',', jmax_qr, ',', kmax_qr, ')', &amp;<a name='1351'>
         'qi: ', qi_max, '(', imax_qi, ',', jmax_qi, ',', kmax_qi, ')', &amp;<a name='1352'>
         'qs: ', qs_max, '(', imax_qs, ',', jmax_qs, ',', kmax_qs, ')', &amp;<a name='1353'>
         'qg: ', qg_max, '(', imax_qg, ',', jmax_qg, ',', kmax_qg, ')', &amp;<a name='1354'>
         'ni: ', ni_max, '(', imax_ni, ',', jmax_ni, ',', kmax_ni, ')', &amp;<a name='1355'>
         'nr: ', nr_max, '(', imax_nr, ',', jmax_nr, ',', kmax_nr, ')'<a name='1356'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_GT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_690">(150, mp_debug)<a name='1357'>
<font color=#447700>! END DEBUG - GT<a name='1358'></font>
<a name='1359'>
      do i = 1, 256<a name='1360'>
         mp_debug(i:i) = char(0)<a name='1361'>
      enddo<a name='1362'>
<a name='1363'>
      END SUBROUTINE mp_gt_driver<a name='1364'>
<a name='1365'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1366'></font>
<font color=#447700>!ctrlL<a name='1367'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1368'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1369'></font>
<font color=#447700>!.. This subroutine computes the moisture tendencies of water vapor,<a name='1370'></font>
<font color=#447700>!.. cloud droplets, rain, cloud ice (pristine), snow, and graupel.<a name='1371'></font>
<font color=#447700>!.. Previously this code was based on Reisner et al (1998), but few of<a name='1372'></font>
<font color=#447700>!.. those pieces remain.  A complete description is now found in<a name='1373'></font>
<font color=#447700>!.. Thompson et al. (2004, 2008).<a name='1374'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1375'></font>
<font color=#447700>!<a name='1376'></font>
<A NAME='MP_THOMPSON'><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1377'>
      <font color=#993300>subroutine </font><font color=#cc0000>mp_thompson</font> (qv1d, qc1d, qi1d, qr1d, qs1d, qg1d, ni1d, &amp; <A href='../../call_to/MP_THOMPSON.html' TARGET='index'>1</A>,<A href='../../call_from/MP_THOMPSON.html' TARGET='index'>14</A><a name='1378'>
                          nr1d, nc1d, nwfa1d, nifa1d, t1d, p1d, w1d, dzq, &amp;<a name='1379'>
                          pptrain, pptsnow, pptgraul, pptice, &amp;<a name='1380'>
#if ( WRF_CHEM == 1 )<a name='1381'>
                          rainprod, evapprod, &amp;<a name='1382'>
#endif<a name='1383'>
                          kts, kte, dt, ii, jj)<a name='1384'>
<a name='1385'>
      implicit none<a name='1386'>
<a name='1387'>
<font color=#447700>!..Sub arguments<a name='1388'></font>
      INTEGER, INTENT(IN):: kts, kte, ii, jj<a name='1389'>
      REAL, DIMENSION(kts:kte), INTENT(INOUT):: &amp;<a name='1390'>
                          qv1d, qc1d, qi1d, qr1d, qs1d, qg1d, ni1d, &amp;<a name='1391'>
                          nr1d, nc1d, nwfa1d, nifa1d, t1d<a name='1392'>
      REAL, DIMENSION(kts:kte), INTENT(IN):: p1d, w1d, dzq<a name='1393'>
      REAL, INTENT(INOUT):: pptrain, pptsnow, pptgraul, pptice<a name='1394'>
      REAL, INTENT(IN):: dt<a name='1395'>
#if ( WRF_CHEM == 1 )<a name='1396'>
      REAL, DIMENSION(kts:kte), INTENT(INOUT):: &amp;<a name='1397'>
                          rainprod, evapprod<a name='1398'>
#endif<a name='1399'>
<a name='1400'>
<font color=#447700>!..Local variables<a name='1401'></font>
      REAL, DIMENSION(kts:kte):: tten, qvten, qcten, qiten, &amp;<a name='1402'>
           qrten, qsten, qgten, niten, nrten, ncten, nwfaten, nifaten<a name='1403'>
<a name='1404'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: prw_vcd<a name='1405'>
<a name='1406'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: pnc_wcd, pnc_wau, pnc_rcw, &amp;<a name='1407'>
           pnc_scw, pnc_gcw<a name='1408'>
<a name='1409'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: pna_rca, pna_sca, pna_gca, &amp;<a name='1410'>
           pnd_rcd, pnd_scd, pnd_gcd<a name='1411'>
<a name='1412'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: prr_wau, prr_rcw, prr_rcs, &amp;<a name='1413'>
           prr_rcg, prr_sml, prr_gml, &amp;<a name='1414'>
           prr_rci, prv_rev,          &amp;<a name='1415'>
           pnr_wau, pnr_rcs, pnr_rcg, &amp;<a name='1416'>
           pnr_rci, pnr_sml, pnr_gml, &amp;<a name='1417'>
           pnr_rev, pnr_rcr, pnr_rfz<a name='1418'>
<a name='1419'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: pri_inu, pni_inu, pri_ihm, &amp;<a name='1420'>
           pni_ihm, pri_wfz, pni_wfz, &amp;<a name='1421'>
           pri_rfz, pni_rfz, pri_ide, &amp;<a name='1422'>
           pni_ide, pri_rci, pni_rci, &amp;<a name='1423'>
           pni_sci, pni_iau, pri_iha, pni_iha<a name='1424'>
<a name='1425'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: prs_iau, prs_sci, prs_rcs, &amp;<a name='1426'>
           prs_scw, prs_sde, prs_ihm, &amp;<a name='1427'>
           prs_ide<a name='1428'>
<a name='1429'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: prg_scw, prg_rfz, prg_gde, &amp;<a name='1430'>
           prg_gcw, prg_rci, prg_rcs, &amp;<a name='1431'>
           prg_rcg, prg_ihm<a name='1432'>
<a name='1433'>
      DOUBLE PRECISION, PARAMETER:: zeroD0 = 0.0d0<a name='1434'>
<a name='1435'>
      REAL, DIMENSION(kts:kte):: temp, pres, qv<a name='1436'>
      REAL, DIMENSION(kts:kte):: rc, ri, rr, rs, rg, ni, nr, nc, nwfa, nifa<a name='1437'>
      REAL, DIMENSION(kts:kte):: rho, rhof, rhof2<a name='1438'>
      REAL, DIMENSION(kts:kte):: qvs, qvsi, delQvs<a name='1439'>
      REAL, DIMENSION(kts:kte):: satw, sati, ssatw, ssati<a name='1440'>
      REAL, DIMENSION(kts:kte):: diffu, visco, vsc2, &amp;<a name='1441'>
           tcond, lvap, ocp, lvt2<a name='1442'>
<a name='1443'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: ilamr, ilamg, N0_r, N0_g<a name='1444'>
      REAL, DIMENSION(kts:kte):: mvd_r, mvd_c<a name='1445'>
      REAL, DIMENSION(kts:kte):: smob, smo2, smo1, smo0, &amp;<a name='1446'>
           smoc, smod, smoe, smof<a name='1447'>
<a name='1448'>
      REAL, DIMENSION(kts:kte):: sed_r, sed_s, sed_g, sed_i, sed_n,sed_c<a name='1449'>
<a name='1450'>
      REAL:: rgvm, delta_tp, orho, lfus2<a name='1451'>
      REAL, DIMENSION(5):: onstep<a name='1452'>
      DOUBLE PRECISION:: N0_exp, N0_min, lam_exp, lamc, lamr, lamg<a name='1453'>
      DOUBLE PRECISION:: lami, ilami, ilamc<a name='1454'>
      REAL:: xDc, Dc_b, Dc_g, xDi, xDr, xDs, xDg, Ds_m, Dg_m<a name='1455'>
      DOUBLE PRECISION:: Dr_star, Dc_star<a name='1456'>
      REAL:: zeta1, zeta, taud, tau<a name='1457'>
      REAL:: stoke_r, stoke_s, stoke_g, stoke_i<a name='1458'>
      REAL:: vti, vtr, vts, vtg, vtc<a name='1459'>
      REAL, DIMENSION(kts:kte+1):: vtik, vtnik, vtrk, vtnrk, vtsk, vtgk,  &amp;<a name='1460'>
           vtck, vtnck<a name='1461'>
      REAL, DIMENSION(kts:kte):: vts_boost<a name='1462'>
      REAL:: Mrat, ils1, ils2, t1_vts, t2_vts, t3_vts, t4_vts, C_snow<a name='1463'>
      REAL:: a_, b_, loga_, A1, A2, tf<a name='1464'>
      REAL:: tempc, tc0, r_mvd1, r_mvd2, xkrat<a name='1465'>
      REAL:: xnc, xri, xni, xmi, oxmi, xrc, xrr, xnr<a name='1466'>
      REAL:: xsat, rate_max, sump, ratio<a name='1467'>
      REAL:: clap, fcd, dfcd<a name='1468'>
      REAL:: otemp, rvs, rvs_p, rvs_pp, gamsc, alphsc, t1_evap, t1_subl<a name='1469'>
      REAL:: r_frac, g_frac<a name='1470'>
      REAL:: Ef_rw, Ef_sw, Ef_gw, Ef_rr<a name='1471'>
      REAL:: Ef_ra, Ef_sa, Ef_ga<a name='1472'>
      REAL:: dtsave, odts, odt, odzq, hgt_agl<a name='1473'>
      REAL:: xslw1, ygra1, zans1, eva_factor<a name='1474'>
      INTEGER:: i, k, k2, n, nn, nstep, k_0, kbot, IT, iexfrq<a name='1475'>
      INTEGER, DIMENSION(5):: ksed1<a name='1476'>
      INTEGER:: nir, nis, nig, nii, nic, niin<a name='1477'>
      INTEGER:: idx_tc, idx_t, idx_s, idx_g1, idx_g, idx_r1, idx_r,     &amp;<a name='1478'>
                idx_i1, idx_i, idx_c, idx, idx_d, idx_n, idx_in<a name='1479'>
<a name='1480'>
      LOGICAL:: melti, no_micro<a name='1481'>
      LOGICAL, DIMENSION(kts:kte):: L_qc, L_qi, L_qr, L_qs, L_qg<a name='1482'>
      LOGICAL:: debug_flag<a name='1483'>
      CHARACTER*256:: mp_debug<a name='1484'>
      INTEGER:: nu_c<a name='1485'>
<a name='1486'>
<font color=#447700>!+---+<a name='1487'></font>
<a name='1488'>
      debug_flag = .false.<a name='1489'>
<font color=#447700>!     if (ii.eq.901 .and. jj.eq.379) debug_flag = .true.<a name='1490'></font>
      if(debug_flag) then<a name='1491'>
        write(mp_debug, *) 'DEBUG INFO, mp_thompson at (i,j) ', ii, ', ', jj<a name='1492'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_691">(550, mp_debug)<a name='1493'>
      endif<a name='1494'>
<a name='1495'>
      no_micro = .true.<a name='1496'>
      dtsave = dt<a name='1497'>
      odt = 1./dt<a name='1498'>
      odts = 1./dtsave<a name='1499'>
      iexfrq = 1<a name='1500'>
<a name='1501'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1502'></font>
<font color=#447700>!.. Source/sink terms.  First 2 chars: "pr" represents source/sink of<a name='1503'></font>
<font color=#447700>!.. mass while "pn" represents source/sink of number.  Next char is one<a name='1504'></font>
<font color=#447700>!.. of "v" for water vapor, "r" for rain, "i" for cloud ice, "w" for<a name='1505'></font>
<font color=#447700>!.. cloud water, "s" for snow, and "g" for graupel.  Next chars<a name='1506'></font>
<font color=#447700>!.. represent processes: "de" for sublimation/deposition, "ev" for<a name='1507'></font>
<font color=#447700>!.. evaporation, "fz" for freezing, "ml" for melting, "au" for<a name='1508'></font>
<font color=#447700>!.. autoconversion, "nu" for ice nucleation, "hm" for Hallet/Mossop<a name='1509'></font>
<font color=#447700>!.. secondary ice production, and "c" for collection followed by the<a name='1510'></font>
<font color=#447700>!.. character for the species being collected.  ALL of these terms are<a name='1511'></font>
<font color=#447700>!.. positive (except for deposition/sublimation terms which can switch<a name='1512'></font>
<font color=#447700>!.. signs based on super/subsaturation) and are treated as negatives<a name='1513'></font>
<font color=#447700>!.. where necessary in the tendency equations.<a name='1514'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1515'></font>
<a name='1516'>
      do k = kts, kte<a name='1517'>
         tten(k) = 0.<a name='1518'>
         qvten(k) = 0.<a name='1519'>
         qcten(k) = 0.<a name='1520'>
         qiten(k) = 0.<a name='1521'>
         qrten(k) = 0.<a name='1522'>
         qsten(k) = 0.<a name='1523'>
         qgten(k) = 0.<a name='1524'>
         niten(k) = 0.<a name='1525'>
         nrten(k) = 0.<a name='1526'>
         ncten(k) = 0.<a name='1527'>
         nwfaten(k) = 0.<a name='1528'>
         nifaten(k) = 0.<a name='1529'>
<a name='1530'>
         prw_vcd(k) = 0.<a name='1531'>
<a name='1532'>
         pnc_wcd(k) = 0.<a name='1533'>
         pnc_wau(k) = 0.<a name='1534'>
         pnc_rcw(k) = 0.<a name='1535'>
         pnc_scw(k) = 0.<a name='1536'>
         pnc_gcw(k) = 0.<a name='1537'>
<a name='1538'>
         prv_rev(k) = 0.<a name='1539'>
         prr_wau(k) = 0.<a name='1540'>
         prr_rcw(k) = 0.<a name='1541'>
         prr_rcs(k) = 0.<a name='1542'>
         prr_rcg(k) = 0.<a name='1543'>
         prr_sml(k) = 0.<a name='1544'>
         prr_gml(k) = 0.<a name='1545'>
         prr_rci(k) = 0.<a name='1546'>
         pnr_wau(k) = 0.<a name='1547'>
         pnr_rcs(k) = 0.<a name='1548'>
         pnr_rcg(k) = 0.<a name='1549'>
         pnr_rci(k) = 0.<a name='1550'>
         pnr_sml(k) = 0.<a name='1551'>
         pnr_gml(k) = 0.<a name='1552'>
         pnr_rev(k) = 0.<a name='1553'>
         pnr_rcr(k) = 0.<a name='1554'>
         pnr_rfz(k) = 0.<a name='1555'>
<a name='1556'>
         pri_inu(k) = 0.<a name='1557'>
         pni_inu(k) = 0.<a name='1558'>
         pri_ihm(k) = 0.<a name='1559'>
         pni_ihm(k) = 0.<a name='1560'>
         pri_wfz(k) = 0.<a name='1561'>
         pni_wfz(k) = 0.<a name='1562'>
         pri_rfz(k) = 0.<a name='1563'>
         pni_rfz(k) = 0.<a name='1564'>
         pri_ide(k) = 0.<a name='1565'>
         pni_ide(k) = 0.<a name='1566'>
         pri_rci(k) = 0.<a name='1567'>
         pni_rci(k) = 0.<a name='1568'>
         pni_sci(k) = 0.<a name='1569'>
         pni_iau(k) = 0.<a name='1570'>
         pri_iha(k) = 0.<a name='1571'>
         pni_iha(k) = 0.<a name='1572'>
<a name='1573'>
         prs_iau(k) = 0.<a name='1574'>
         prs_sci(k) = 0.<a name='1575'>
         prs_rcs(k) = 0.<a name='1576'>
         prs_scw(k) = 0.<a name='1577'>
         prs_sde(k) = 0.<a name='1578'>
         prs_ihm(k) = 0.<a name='1579'>
         prs_ide(k) = 0.<a name='1580'>
<a name='1581'>
         prg_scw(k) = 0.<a name='1582'>
         prg_rfz(k) = 0.<a name='1583'>
         prg_gde(k) = 0.<a name='1584'>
         prg_gcw(k) = 0.<a name='1585'>
         prg_rci(k) = 0.<a name='1586'>
         prg_rcs(k) = 0.<a name='1587'>
         prg_rcg(k) = 0.<a name='1588'>
         prg_ihm(k) = 0.<a name='1589'>
<a name='1590'>
         pna_rca(k) = 0.<a name='1591'>
         pna_sca(k) = 0.<a name='1592'>
         pna_gca(k) = 0.<a name='1593'>
<a name='1594'>
         pnd_rcd(k) = 0.<a name='1595'>
         pnd_scd(k) = 0.<a name='1596'>
         pnd_gcd(k) = 0.<a name='1597'>
      enddo<a name='1598'>
#if ( WRF_CHEM == 1 )<a name='1599'>
      do k = kts, kte<a name='1600'>
         rainprod(k) = 0.<a name='1601'>
         evapprod(k) = 0.<a name='1602'>
      enddo<a name='1603'>
#endif<a name='1604'>
<a name='1605'>
<font color=#447700>!..Bug fix (2016Jun15), prevent use of uninitialized value(s) of snow moments.<a name='1606'></font>
      do k = kts, kte<a name='1607'>
         smo0(k) = 0.<a name='1608'>
         smo1(k) = 0.<a name='1609'>
         smo2(k) = 0.<a name='1610'>
         smob(k) = 0.<a name='1611'>
         smoc(k) = 0.<a name='1612'>
         smod(k) = 0.<a name='1613'>
         smoe(k) = 0.<a name='1614'>
         smof(k) = 0.<a name='1615'>
      enddo<a name='1616'>
<a name='1617'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1618'></font>
<font color=#447700>!..Put column of data into local arrays.<a name='1619'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1620'></font>
      do k = kts, kte<a name='1621'>
         temp(k) = t1d(k)<a name='1622'>
         qv(k) = MAX(1.E-10, qv1d(k))<a name='1623'>
         pres(k) = p1d(k)<a name='1624'>
         rho(k) = 0.622*pres(k)/(R*temp(k)*(qv(k)+0.622))<a name='1625'>
         nwfa(k) = MAX(11.1E6, MIN(9999.E6, nwfa1d(k)*rho(k)))<a name='1626'>
         nifa(k) = MAX(naIN1*0.01, MIN(9999.E6, nifa1d(k)*rho(k)))<a name='1627'>
<a name='1628'>
         if (qc1d(k) .gt. R1) then<a name='1629'>
            no_micro = .false.<a name='1630'>
            rc(k) = qc1d(k)*rho(k)<a name='1631'>
            nc(k) = MAX(2., nc1d(k)*rho(k))<a name='1632'>
            L_qc(k) = .true.<a name='1633'>
            nu_c = MIN(15, NINT(1000.E6/nc(k)) + 2)<a name='1634'>
            lamc = (nc(k)*am_r*ccg(2,nu_c)*ocg1(nu_c)/rc(k))**obmr<a name='1635'>
            xDc = (bm_r + nu_c + 1.) / lamc<a name='1636'>
            if (xDc.lt. D0c) then<a name='1637'>
             lamc = cce(2,nu_c)/D0c<a name='1638'>
            elseif (xDc.gt. D0r*2.) then<a name='1639'>
             lamc = cce(2,nu_c)/(D0r*2.)<a name='1640'>
            endif<a name='1641'>
            nc(k) = MIN( DBLE(Nt_c_max), ccg(1,nu_c)*ocg2(nu_c)*rc(k)   &amp;<a name='1642'>
                  / am_r*lamc**bm_r)<a name='1643'>
            if (.NOT. is_aerosol_aware) nc(k) = Nt_c<a name='1644'>
         else<a name='1645'>
            qc1d(k) = 0.0<a name='1646'>
            nc1d(k) = 0.0<a name='1647'>
            rc(k) = R1<a name='1648'>
            nc(k) = 2.<a name='1649'>
            L_qc(k) = .false.<a name='1650'>
         endif<a name='1651'>
<a name='1652'>
         if (qi1d(k) .gt. R1) then<a name='1653'>
            no_micro = .false.<a name='1654'>
            ri(k) = qi1d(k)*rho(k)<a name='1655'>
            ni(k) = MAX(R2, ni1d(k)*rho(k))<a name='1656'>
            if (ni(k).le. R2) then<a name='1657'>
               lami = cie(2)/25.E-6<a name='1658'>
               ni(k) = MIN(499.D3, cig(1)*oig2*ri(k)/am_i*lami**bm_i)<a name='1659'>
            endif<a name='1660'>
            L_qi(k) = .true.<a name='1661'>
            lami = (am_i*cig(2)*oig1*ni(k)/ri(k))**obmi<a name='1662'>
            ilami = 1./lami<a name='1663'>
            xDi = (bm_i + mu_i + 1.) * ilami<a name='1664'>
            if (xDi.lt. 5.E-6) then<a name='1665'>
             lami = cie(2)/5.E-6<a name='1666'>
             ni(k) = MIN(499.D3, cig(1)*oig2*ri(k)/am_i*lami**bm_i)<a name='1667'>
            elseif (xDi.gt. 300.E-6) then<a name='1668'>
             lami = cie(2)/300.E-6<a name='1669'>
             ni(k) = cig(1)*oig2*ri(k)/am_i*lami**bm_i<a name='1670'>
            endif<a name='1671'>
         else<a name='1672'>
            qi1d(k) = 0.0<a name='1673'>
            ni1d(k) = 0.0<a name='1674'>
            ri(k) = R1<a name='1675'>
            ni(k) = R2<a name='1676'>
            L_qi(k) = .false.<a name='1677'>
         endif<a name='1678'>
<a name='1679'>
         if (qr1d(k) .gt. R1) then<a name='1680'>
            no_micro = .false.<a name='1681'>
            rr(k) = qr1d(k)*rho(k)<a name='1682'>
            nr(k) = MAX(R2, nr1d(k)*rho(k))<a name='1683'>
            if (nr(k).le. R2) then<a name='1684'>
               mvd_r(k) = 1.0E-3<a name='1685'>
               lamr = (3.0 + mu_r + 0.672) / mvd_r(k)<a name='1686'>
               nr(k) = crg(2)*org3*rr(k)*lamr**bm_r / am_r<a name='1687'>
            endif<a name='1688'>
            L_qr(k) = .true.<a name='1689'>
            lamr = (am_r*crg(3)*org2*nr(k)/rr(k))**obmr<a name='1690'>
            mvd_r(k) = (3.0 + mu_r + 0.672) / lamr<a name='1691'>
            if (mvd_r(k) .gt. 2.5E-3) then<a name='1692'>
               mvd_r(k) = 2.5E-3<a name='1693'>
               lamr = (3.0 + mu_r + 0.672) / mvd_r(k)<a name='1694'>
               nr(k) = crg(2)*org3*rr(k)*lamr**bm_r / am_r<a name='1695'>
            elseif (mvd_r(k) .lt. D0r*0.75) then<a name='1696'>
               mvd_r(k) = D0r*0.75<a name='1697'>
               lamr = (3.0 + mu_r + 0.672) / mvd_r(k)<a name='1698'>
               nr(k) = crg(2)*org3*rr(k)*lamr**bm_r / am_r<a name='1699'>
            endif<a name='1700'>
         else<a name='1701'>
            qr1d(k) = 0.0<a name='1702'>
            nr1d(k) = 0.0<a name='1703'>
            rr(k) = R1<a name='1704'>
            nr(k) = R2<a name='1705'>
            L_qr(k) = .false.<a name='1706'>
         endif<a name='1707'>
         if (qs1d(k) .gt. R1) then<a name='1708'>
            no_micro = .false.<a name='1709'>
            rs(k) = qs1d(k)*rho(k)<a name='1710'>
            L_qs(k) = .true.<a name='1711'>
         else<a name='1712'>
            qs1d(k) = 0.0<a name='1713'>
            rs(k) = R1<a name='1714'>
            L_qs(k) = .false.<a name='1715'>
         endif<a name='1716'>
         if (qg1d(k) .gt. R1) then<a name='1717'>
            no_micro = .false.<a name='1718'>
            rg(k) = qg1d(k)*rho(k)<a name='1719'>
            L_qg(k) = .true.<a name='1720'>
         else<a name='1721'>
            qg1d(k) = 0.0<a name='1722'>
            rg(k) = R1<a name='1723'>
            L_qg(k) = .false.<a name='1724'>
         endif<a name='1725'>
      enddo<a name='1726'>
<a name='1727'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1728'></font>
<font color=#447700>!     if (debug_flag) then<a name='1729'></font>
<font color=#447700>!      write(mp_debug,*) 'DEBUG-VERBOSE at (i,j) ', ii, ', ', jj<a name='1730'></font>
<font color=#447700>!      CALL wrf_debug(550, mp_debug)<a name='1731'></font>
<font color=#447700>!      do k = kts, kte<a name='1732'></font>
<font color=#447700>!        write(mp_debug, '(a,i3,f8.2,1x,f7.2,1x, 11(1x,e13.6))')        &amp;<a name='1733'></font>
<font color=#447700>!    &amp;              'VERBOSE: ', k, pres(k)*0.01, temp(k)-273.15, qv(k), rc(k), rr(k), ri(k), rs(k), rg(k), nc(k), nr(k), ni(k), nwfa(k), nifa(k)<a name='1734'></font>
<font color=#447700>!        CALL wrf_debug(550, mp_debug)<a name='1735'></font>
<font color=#447700>!      enddo<a name='1736'></font>
<font color=#447700>!     endif<a name='1737'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1738'></font>
<a name='1739'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1740'></font>
<font color=#447700>!..Derive various thermodynamic variables frequently used.<a name='1741'></font>
<font color=#447700>!.. Saturation vapor pressure (mixing ratio) over liquid/ice comes from<a name='1742'></font>
<font color=#447700>!.. Flatau et al. 1992; enthalpy (latent heat) of vaporization from<a name='1743'></font>
<font color=#447700>!.. Bohren &amp; Albrecht 1998; others from Pruppacher &amp; Klett 1978.<a name='1744'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1745'></font>
      do k = kts, kte<a name='1746'>
         tempc = temp(k) - 273.15<a name='1747'>
         rhof(k) = SQRT(RHO_NOT/rho(k))<a name='1748'>
         rhof2(k) = SQRT(rhof(k))<a name='1749'>
         qvs(k) = <A href='../../html_code/share/dfi.F.html#RSLF'>rslf</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSLF_1">(pres(k), temp(k))<a name='1750'>
         delQvs(k) = MAX(0.0, rslf(pres(k), 273.15)-qv(k))<a name='1751'>
         if (tempc .le. 0.0) then<a name='1752'>
          qvsi(k) = <A href='../../html_code/share/dfi.F.html#RSIF'>rsif</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSIF_1">(pres(k), temp(k))<a name='1753'>
         else<a name='1754'>
          qvsi(k) = qvs(k)<a name='1755'>
         endif<a name='1756'>
         satw(k) = qv(k)/qvs(k)<a name='1757'>
         sati(k) = qv(k)/qvsi(k)<a name='1758'>
         ssatw(k) = satw(k) - 1.<a name='1759'>
         ssati(k) = sati(k) - 1.<a name='1760'>
         if (abs(ssatw(k)).lt. eps) ssatw(k) = 0.0<a name='1761'>
         if (abs(ssati(k)).lt. eps) ssati(k) = 0.0<a name='1762'>
         if (no_micro .and. ssati(k).gt. 0.0) no_micro = .false.<a name='1763'>
         diffu(k) = 2.11E-5*(temp(k)/273.15)**1.94 * (101325./pres(k))<a name='1764'>
         if (tempc .ge. 0.0) then<a name='1765'>
            visco(k) = (1.718+0.0049*tempc)*1.0E-5<a name='1766'>
         else<a name='1767'>
            visco(k) = (1.718+0.0049*tempc-1.2E-5*tempc*tempc)*1.0E-5<a name='1768'>
         endif<a name='1769'>
         ocp(k) = 1./(Cp*(1.+0.887*qv(k)))<a name='1770'>
         vsc2(k) = SQRT(rho(k)/visco(k))<a name='1771'>
         lvap(k) = lvap0 + (2106.0 - 4218.0)*tempc<a name='1772'>
         tcond(k) = (5.69 + 0.0168*tempc)*1.0E-5 * 418.936<a name='1773'>
      enddo<a name='1774'>
<a name='1775'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1776'></font>
<font color=#447700>!..If no existing hydrometeor species and no chance to initiate ice or<a name='1777'></font>
<font color=#447700>!.. condense cloud water, just exit quickly!<a name='1778'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1779'></font>
<a name='1780'>
      if (no_micro) return<a name='1781'>
<a name='1782'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1783'></font>
<font color=#447700>!..Calculate y-intercept, slope, and useful moments for snow.<a name='1784'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1785'></font>
      if (.not. iiwarm) then<a name='1786'>
      do k = kts, kte<a name='1787'>
         if (.not. L_qs(k)) CYCLE<a name='1788'>
         tc0 = MIN(-0.1, temp(k)-273.15)<a name='1789'>
         smob(k) = rs(k)*oams<a name='1790'>
<a name='1791'>
<font color=#447700>!..All other moments based on reference, 2nd moment.  If bm_s.ne.2,<a name='1792'></font>
<font color=#447700>!.. then we must compute actual 2nd moment and use as reference.<a name='1793'></font>
         if (bm_s.gt.(2.0-1.e-3) .and. bm_s.lt.(2.0+1.e-3)) then<a name='1794'>
            smo2(k) = smob(k)<a name='1795'>
         else<a name='1796'>
            loga_ = sa(1) + sa(2)*tc0 + sa(3)*bm_s &amp;<a name='1797'>
               + sa(4)*tc0*bm_s + sa(5)*tc0*tc0 &amp;<a name='1798'>
               + sa(6)*bm_s*bm_s + sa(7)*tc0*tc0*bm_s &amp;<a name='1799'>
               + sa(8)*tc0*bm_s*bm_s + sa(9)*tc0*tc0*tc0 &amp;<a name='1800'>
               + sa(10)*bm_s*bm_s*bm_s<a name='1801'>
            a_ = 10.0**loga_<a name='1802'>
            b_ = sb(1) + sb(2)*tc0 + sb(3)*bm_s &amp;<a name='1803'>
               + sb(4)*tc0*bm_s + sb(5)*tc0*tc0 &amp;<a name='1804'>
               + sb(6)*bm_s*bm_s + sb(7)*tc0*tc0*bm_s &amp;<a name='1805'>
               + sb(8)*tc0*bm_s*bm_s + sb(9)*tc0*tc0*tc0 &amp;<a name='1806'>
               + sb(10)*bm_s*bm_s*bm_s<a name='1807'>
            smo2(k) = (smob(k)/a_)**(1./b_)<a name='1808'>
         endif<a name='1809'>
<a name='1810'>
<font color=#447700>!..Calculate 0th moment.  Represents snow number concentration.<a name='1811'></font>
         loga_ = sa(1) + sa(2)*tc0 + sa(5)*tc0*tc0 + sa(9)*tc0*tc0*tc0<a name='1812'>
         a_ = 10.0**loga_<a name='1813'>
         b_ = sb(1) + sb(2)*tc0 + sb(5)*tc0*tc0 + sb(9)*tc0*tc0*tc0<a name='1814'>
         smo0(k) = a_ * smo2(k)**b_<a name='1815'>
<a name='1816'>
<font color=#447700>!..Calculate 1st moment.  Useful for depositional growth and melting.<a name='1817'></font>
         loga_ = sa(1) + sa(2)*tc0 + sa(3) &amp;<a name='1818'>
               + sa(4)*tc0 + sa(5)*tc0*tc0 &amp;<a name='1819'>
               + sa(6) + sa(7)*tc0*tc0 &amp;<a name='1820'>
               + sa(8)*tc0 + sa(9)*tc0*tc0*tc0 &amp;<a name='1821'>
               + sa(10)<a name='1822'>
         a_ = 10.0**loga_<a name='1823'>
         b_ = sb(1)+ sb(2)*tc0 + sb(3) + sb(4)*tc0 &amp;<a name='1824'>
              + sb(5)*tc0*tc0 + sb(6) &amp;<a name='1825'>
              + sb(7)*tc0*tc0 + sb(8)*tc0 &amp;<a name='1826'>
              + sb(9)*tc0*tc0*tc0 + sb(10)<a name='1827'>
         smo1(k) = a_ * smo2(k)**b_<a name='1828'>
<a name='1829'>
<font color=#447700>!..Calculate bm_s+1 (th) moment.  Useful for diameter calcs.<a name='1830'></font>
         loga_ = sa(1) + sa(2)*tc0 + sa(3)*cse(1) &amp;<a name='1831'>
               + sa(4)*tc0*cse(1) + sa(5)*tc0*tc0 &amp;<a name='1832'>
               + sa(6)*cse(1)*cse(1) + sa(7)*tc0*tc0*cse(1) &amp;<a name='1833'>
               + sa(8)*tc0*cse(1)*cse(1) + sa(9)*tc0*tc0*tc0 &amp;<a name='1834'>
               + sa(10)*cse(1)*cse(1)*cse(1)<a name='1835'>
         a_ = 10.0**loga_<a name='1836'>
         b_ = sb(1)+ sb(2)*tc0 + sb(3)*cse(1) + sb(4)*tc0*cse(1) &amp;<a name='1837'>
              + sb(5)*tc0*tc0 + sb(6)*cse(1)*cse(1) &amp;<a name='1838'>
              + sb(7)*tc0*tc0*cse(1) + sb(8)*tc0*cse(1)*cse(1) &amp;<a name='1839'>
              + sb(9)*tc0*tc0*tc0 + sb(10)*cse(1)*cse(1)*cse(1)<a name='1840'>
         smoc(k) = a_ * smo2(k)**b_<a name='1841'>
<a name='1842'>
<font color=#447700>!..Calculate bv_s+2 (th) moment.  Useful for riming.<a name='1843'></font>
         loga_ = sa(1) + sa(2)*tc0 + sa(3)*cse(13) &amp;<a name='1844'>
               + sa(4)*tc0*cse(13) + sa(5)*tc0*tc0 &amp;<a name='1845'>
               + sa(6)*cse(13)*cse(13) + sa(7)*tc0*tc0*cse(13) &amp;<a name='1846'>
               + sa(8)*tc0*cse(13)*cse(13) + sa(9)*tc0*tc0*tc0 &amp;<a name='1847'>
               + sa(10)*cse(13)*cse(13)*cse(13)<a name='1848'>
         a_ = 10.0**loga_<a name='1849'>
         b_ = sb(1)+ sb(2)*tc0 + sb(3)*cse(13) + sb(4)*tc0*cse(13) &amp;<a name='1850'>
              + sb(5)*tc0*tc0 + sb(6)*cse(13)*cse(13) &amp;<a name='1851'>
              + sb(7)*tc0*tc0*cse(13) + sb(8)*tc0*cse(13)*cse(13) &amp;<a name='1852'>
              + sb(9)*tc0*tc0*tc0 + sb(10)*cse(13)*cse(13)*cse(13)<a name='1853'>
         smoe(k) = a_ * smo2(k)**b_<a name='1854'>
<a name='1855'>
<font color=#447700>!..Calculate 1+(bv_s+1)/2 (th) moment.  Useful for depositional growth.<a name='1856'></font>
         loga_ = sa(1) + sa(2)*tc0 + sa(3)*cse(16) &amp;<a name='1857'>
               + sa(4)*tc0*cse(16) + sa(5)*tc0*tc0 &amp;<a name='1858'>
               + sa(6)*cse(16)*cse(16) + sa(7)*tc0*tc0*cse(16) &amp;<a name='1859'>
               + sa(8)*tc0*cse(16)*cse(16) + sa(9)*tc0*tc0*tc0 &amp;<a name='1860'>
               + sa(10)*cse(16)*cse(16)*cse(16)<a name='1861'>
         a_ = 10.0**loga_<a name='1862'>
         b_ = sb(1)+ sb(2)*tc0 + sb(3)*cse(16) + sb(4)*tc0*cse(16) &amp;<a name='1863'>
              + sb(5)*tc0*tc0 + sb(6)*cse(16)*cse(16) &amp;<a name='1864'>
              + sb(7)*tc0*tc0*cse(16) + sb(8)*tc0*cse(16)*cse(16) &amp;<a name='1865'>
              + sb(9)*tc0*tc0*tc0 + sb(10)*cse(16)*cse(16)*cse(16)<a name='1866'>
         smof(k) = a_ * smo2(k)**b_<a name='1867'>
<a name='1868'>
      enddo<a name='1869'>
<a name='1870'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1871'></font>
<font color=#447700>!..Calculate y-intercept, slope values for graupel.<a name='1872'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1873'></font>
      N0_min = gonv_max<a name='1874'>
      k_0 = kts<a name='1875'>
      do k = kte, kts, -1<a name='1876'>
         if (temp(k).ge.270.65) k_0 = MAX(k_0, k)<a name='1877'>
      enddo<a name='1878'>
      do k = kte, kts, -1<a name='1879'>
         if (k.gt.k_0 .and. L_qr(k) .and. mvd_r(k).gt.100.E-6) then<a name='1880'>
            xslw1 = 4.01 + alog10(mvd_r(k))<a name='1881'>
         else<a name='1882'>
            xslw1 = 0.01<a name='1883'>
         endif<a name='1884'>
         ygra1 = 4.31 + alog10(max(5.E-5, rg(k)))<a name='1885'>
         zans1 = 3.1 + (100./(300.*xslw1*ygra1/(10./xslw1+1.+0.25*ygra1)+30.+10.*ygra1))<a name='1886'>
         N0_exp = 10.**(zans1)<a name='1887'>
         N0_exp = MAX(DBLE(gonv_min), MIN(N0_exp, DBLE(gonv_max)))<a name='1888'>
         N0_min = MIN(N0_exp, N0_min)<a name='1889'>
         N0_exp = N0_min<a name='1890'>
         lam_exp = (N0_exp*am_g*cgg(1)/rg(k))**oge1<a name='1891'>
         lamg = lam_exp * (cgg(3)*ogg2*ogg1)**obmg<a name='1892'>
         ilamg(k) = 1./lamg<a name='1893'>
         N0_g(k) = N0_exp/(cgg(2)*lam_exp) * lamg**cge(2)<a name='1894'>
      enddo<a name='1895'>
<a name='1896'>
      endif<a name='1897'>
<a name='1898'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1899'></font>
<font color=#447700>!..Calculate y-intercept, slope values for rain.<a name='1900'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1901'></font>
      do k = kte, kts, -1<a name='1902'>
         lamr = (am_r*crg(3)*org2*nr(k)/rr(k))**obmr<a name='1903'>
         ilamr(k) = 1./lamr<a name='1904'>
         mvd_r(k) = (3.0 + mu_r + 0.672) / lamr<a name='1905'>
         N0_r(k) = nr(k)*org2*lamr**cre(2)<a name='1906'>
      enddo<a name='1907'>
<a name='1908'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1909'></font>
<font color=#447700>!..Compute warm-rain process terms (except evap done later).<a name='1910'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1911'></font>
<a name='1912'>
      do k = kts, kte<a name='1913'>
<a name='1914'>
<font color=#447700>!..Rain self-collection follows Seifert, 1994 and drop break-up<a name='1915'></font>
<font color=#447700>!.. follows Verlinde and Cotton, 1993.                                        RAIN2M<a name='1916'></font>
         if (L_qr(k) .and. mvd_r(k).gt. D0r) then<a name='1917'>
<font color=#447700>!-GT      Ef_rr = 1.0<a name='1918'></font>
<font color=#447700>!-GT      if (mvd_r(k) .gt. 1500.0E-6) then<a name='1919'></font>
             Ef_rr = 1.0 - EXP(2300.0*(mvd_r(k)-1950.0E-6))<a name='1920'>
<font color=#447700>!-GT      endif<a name='1921'></font>
          pnr_rcr(k) = Ef_rr * 2.0*nr(k)*rr(k)<a name='1922'>
         endif<a name='1923'>
<a name='1924'>
         mvd_c(k) = D0c<a name='1925'>
         if (L_qc(k)) then<a name='1926'>
          nu_c = MIN(15, NINT(1000.E6/nc(k)) + 2)<a name='1927'>
          xDc = MAX(D0c*1.E6, ((rc(k)/(am_r*nc(k)))**obmr) * 1.E6)<a name='1928'>
          lamc = (nc(k)*am_r* ccg(2,nu_c) * ocg1(nu_c) / rc(k))**obmr<a name='1929'>
          mvd_c(k) = (3.0+nu_c+0.672) / lamc<a name='1930'>
         endif<a name='1931'>
<a name='1932'>
<font color=#447700>!..Autoconversion follows Berry &amp; Reinhardt (1974) with characteristic<a name='1933'></font>
<font color=#447700>!.. diameters correctly computed from gamma distrib of cloud droplets.<a name='1934'></font>
         if (rc(k).gt. 0.01e-3) then<a name='1935'>
          Dc_g = ((ccg(3,nu_c)*ocg2(nu_c))**obmr / lamc) * 1.E6<a name='1936'>
          Dc_b = (xDc*xDc*xDc*Dc_g*Dc_g*Dc_g - xDc*xDc*xDc*xDc*xDc*xDc) &amp;<a name='1937'>
                 **(1./6.)<a name='1938'>
          zeta1 = 0.5*((6.25E-6*xDc*Dc_b*Dc_b*Dc_b - 0.4) &amp;<a name='1939'>
                     + abs(6.25E-6*xDc*Dc_b*Dc_b*Dc_b - 0.4))<a name='1940'>
          zeta = 0.027*rc(k)*zeta1<a name='1941'>
          taud = 0.5*((0.5*Dc_b - 7.5) + abs(0.5*Dc_b - 7.5)) + R1<a name='1942'>
          tau  = 3.72/(rc(k)*taud)<a name='1943'>
          prr_wau(k) = zeta/tau<a name='1944'>
          prr_wau(k) = MIN(DBLE(rc(k)*odts), prr_wau(k))<a name='1945'>
          pnr_wau(k) = prr_wau(k) / (am_r*nu_c*D0r*D0r*D0r)              <font color=#447700>! RAIN2M<a name='1946'></font>
          pnc_wau(k) = MIN(DBLE(nc(k)*odts), prr_wau(k)                 &amp;<a name='1947'>
                     / (am_r*mvd_c(k)*mvd_c(k)*mvd_c(k)))                   <font color=#447700>! Qc2M<a name='1948'></font>
         endif<a name='1949'>
<a name='1950'>
<font color=#447700>!..Rain collecting cloud water.  In CE, assume Dc&lt;&lt;Dr and vtc=~0.<a name='1951'></font>
         if (L_qr(k) .and. mvd_r(k).gt. D0r .and. mvd_c(k).gt. D0c) then<a name='1952'>
          lamr = 1./ilamr(k)<a name='1953'>
          idx = 1 + INT(nbr*DLOG(mvd_r(k)/Dr(1))/DLOG(Dr(nbr)/Dr(1)))<a name='1954'>
          idx = MIN(idx, nbr)<a name='1955'>
          Ef_rw = t_Efrw(idx, INT(mvd_c(k)*1.E6))<a name='1956'>
          prr_rcw(k) = rhof(k)*t1_qr_qc*Ef_rw*rc(k)*N0_r(k) &amp;<a name='1957'>
                         *((lamr+fv_r)**(-cre(9)))<a name='1958'>
          prr_rcw(k) = MIN(DBLE(rc(k)*odts), prr_rcw(k))<a name='1959'>
          pnc_rcw(k) = rhof(k)*t1_qr_qc*Ef_rw*nc(k)*N0_r(k)             &amp;<a name='1960'>
                         *((lamr+fv_r)**(-cre(9)))                          <font color=#447700>! Qc2M<a name='1961'></font>
          pnc_rcw(k) = MIN(DBLE(nc(k)*odts), pnc_rcw(k))<a name='1962'>
         endif<a name='1963'>
<a name='1964'>
<font color=#447700>!..Rain collecting aerosols, wet scavenging.<a name='1965'></font>
         if (L_qr(k) .and. mvd_r(k).gt. D0r) then<a name='1966'>
          Ef_ra = <A href='../../html_code/phys/module_mp_thompson.F.html#EFF_AERO'>Eff_aero</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EFF_AERO_1">(mvd_r(k),0.04E-6,visco(k),rho(k),temp(k),'r')<a name='1967'>
          lamr = 1./ilamr(k)<a name='1968'>
          pna_rca(k) = rhof(k)*t1_qr_qc*Ef_ra*nwfa(k)*N0_r(k)           &amp;<a name='1969'>
                         *((lamr+fv_r)**(-cre(9)))<a name='1970'>
          pna_rca(k) = MIN(DBLE(nwfa(k)*odts), pna_rca(k))<a name='1971'>
<a name='1972'>
          Ef_ra = <A href='../../html_code/phys/module_mp_thompson.F.html#EFF_AERO'>Eff_aero</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EFF_AERO_2">(mvd_r(k),0.8E-6,visco(k),rho(k),temp(k),'r')<a name='1973'>
          pnd_rcd(k) = rhof(k)*t1_qr_qc*Ef_ra*nifa(k)*N0_r(k)           &amp;<a name='1974'>
                         *((lamr+fv_r)**(-cre(9)))<a name='1975'>
          pnd_rcd(k) = MIN(DBLE(nifa(k)*odts), pnd_rcd(k))<a name='1976'>
         endif<a name='1977'>
<a name='1978'>
      enddo<a name='1979'>
<a name='1980'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1981'></font>
<font color=#447700>!..Compute all frozen hydrometeor species' process terms.<a name='1982'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='1983'></font>
      if (.not. iiwarm) then<a name='1984'>
      do k = kts, kte<a name='1985'>
         vts_boost(k) = 1.5<a name='1986'>
<a name='1987'>
<font color=#447700>!..Temperature lookup table indexes.<a name='1988'></font>
         tempc = temp(k) - 273.15<a name='1989'>
         idx_tc = MAX(1, MIN(NINT(-tempc), 45) )<a name='1990'>
         idx_t = INT( (tempc-2.5)/5. ) - 1<a name='1991'>
         idx_t = MAX(1, -idx_t)<a name='1992'>
         idx_t = MIN(idx_t, ntb_t)<a name='1993'>
         IT = MAX(1, MIN(NINT(-tempc), 31) )<a name='1994'>
<a name='1995'>
<font color=#447700>!..Cloud water lookup table index.<a name='1996'></font>
         if (rc(k).gt. r_c(1)) then<a name='1997'>
          nic = NINT(ALOG10(rc(k)))<a name='1998'>
          do nn = nic-1, nic+1<a name='1999'>
             n = nn<a name='2000'>
             if ( (rc(k)/10.**nn).ge.1.0 .and. &amp;<a name='2001'>
                  (rc(k)/10.**nn).lt.10.0) goto 141<a name='2002'>
          enddo<a name='2003'>
 141      continue<a name='2004'>
          idx_c = INT(rc(k)/10.**n) + 10*(n-nic2) - (n-nic2)<a name='2005'>
          idx_c = MAX(1, MIN(idx_c, ntb_c))<a name='2006'>
         else<a name='2007'>
          idx_c = 1<a name='2008'>
         endif<a name='2009'>
<a name='2010'>
<font color=#447700>!..Cloud droplet number lookup table index.<a name='2011'></font>
         idx_n = NINT(1.0 + FLOAT(nbc) * DLOG(nc(k)/t_Nc(1)) / nic1)<a name='2012'>
         idx_n = MAX(1, MIN(idx_n, nbc))<a name='2013'>
<a name='2014'>
<font color=#447700>!..Cloud ice lookup table indexes.<a name='2015'></font>
         if (ri(k).gt. r_i(1)) then<a name='2016'>
          nii = NINT(ALOG10(ri(k)))<a name='2017'>
          do nn = nii-1, nii+1<a name='2018'>
             n = nn<a name='2019'>
             if ( (ri(k)/10.**nn).ge.1.0 .and. &amp;<a name='2020'>
                  (ri(k)/10.**nn).lt.10.0) goto 142<a name='2021'>
          enddo<a name='2022'>
 142      continue<a name='2023'>
          idx_i = INT(ri(k)/10.**n) + 10*(n-nii2) - (n-nii2)<a name='2024'>
          idx_i = MAX(1, MIN(idx_i, ntb_i))<a name='2025'>
         else<a name='2026'>
          idx_i = 1<a name='2027'>
         endif<a name='2028'>
<a name='2029'>
         if (ni(k).gt. Nt_i(1)) then<a name='2030'>
          nii = NINT(ALOG10(ni(k)))<a name='2031'>
          do nn = nii-1, nii+1<a name='2032'>
             n = nn<a name='2033'>
             if ( (ni(k)/10.**nn).ge.1.0 .and. &amp;<a name='2034'>
                  (ni(k)/10.**nn).lt.10.0) goto 143<a name='2035'>
          enddo<a name='2036'>
 143      continue<a name='2037'>
          idx_i1 = INT(ni(k)/10.**n) + 10*(n-nii3) - (n-nii3)<a name='2038'>
          idx_i1 = MAX(1, MIN(idx_i1, ntb_i1))<a name='2039'>
         else<a name='2040'>
          idx_i1 = 1<a name='2041'>
         endif<a name='2042'>
<a name='2043'>
<font color=#447700>!..Rain lookup table indexes.<a name='2044'></font>
         if (rr(k).gt. r_r(1)) then<a name='2045'>
          nir = NINT(ALOG10(rr(k)))<a name='2046'>
          do nn = nir-1, nir+1<a name='2047'>
             n = nn<a name='2048'>
             if ( (rr(k)/10.**nn).ge.1.0 .and. &amp;<a name='2049'>
                  (rr(k)/10.**nn).lt.10.0) goto 144<a name='2050'>
          enddo<a name='2051'>
 144      continue<a name='2052'>
          idx_r = INT(rr(k)/10.**n) + 10*(n-nir2) - (n-nir2)<a name='2053'>
          idx_r = MAX(1, MIN(idx_r, ntb_r))<a name='2054'>
<a name='2055'>
          lamr = 1./ilamr(k)<a name='2056'>
          lam_exp = lamr * (crg(3)*org2*org1)**bm_r<a name='2057'>
          N0_exp = org1*rr(k)/am_r * lam_exp**cre(1)<a name='2058'>
          nir = NINT(DLOG10(N0_exp))<a name='2059'>
          do nn = nir-1, nir+1<a name='2060'>
             n = nn<a name='2061'>
             if ( (N0_exp/10.**nn).ge.1.0 .and. &amp;<a name='2062'>
                  (N0_exp/10.**nn).lt.10.0) goto 145<a name='2063'>
          enddo<a name='2064'>
 145      continue<a name='2065'>
          idx_r1 = INT(N0_exp/10.**n) + 10*(n-nir3) - (n-nir3)<a name='2066'>
          idx_r1 = MAX(1, MIN(idx_r1, ntb_r1))<a name='2067'>
         else<a name='2068'>
          idx_r = 1<a name='2069'>
          idx_r1 = ntb_r1<a name='2070'>
         endif<a name='2071'>
<a name='2072'>
<font color=#447700>!..Snow lookup table index.<a name='2073'></font>
         if (rs(k).gt. r_s(1)) then<a name='2074'>
          nis = NINT(ALOG10(rs(k)))<a name='2075'>
          do nn = nis-1, nis+1<a name='2076'>
             n = nn<a name='2077'>
             if ( (rs(k)/10.**nn).ge.1.0 .and. &amp;<a name='2078'>
                  (rs(k)/10.**nn).lt.10.0) goto 146<a name='2079'>
          enddo<a name='2080'>
 146      continue<a name='2081'>
          idx_s = INT(rs(k)/10.**n) + 10*(n-nis2) - (n-nis2)<a name='2082'>
          idx_s = MAX(1, MIN(idx_s, ntb_s))<a name='2083'>
         else<a name='2084'>
          idx_s = 1<a name='2085'>
         endif<a name='2086'>
<a name='2087'>
<font color=#447700>!..Graupel lookup table index.<a name='2088'></font>
         if (rg(k).gt. r_g(1)) then<a name='2089'>
          nig = NINT(ALOG10(rg(k)))<a name='2090'>
          do nn = nig-1, nig+1<a name='2091'>
             n = nn<a name='2092'>
             if ( (rg(k)/10.**nn).ge.1.0 .and. &amp;<a name='2093'>
                  (rg(k)/10.**nn).lt.10.0) goto 147<a name='2094'>
          enddo<a name='2095'>
 147      continue<a name='2096'>
          idx_g = INT(rg(k)/10.**n) + 10*(n-nig2) - (n-nig2)<a name='2097'>
          idx_g = MAX(1, MIN(idx_g, ntb_g))<a name='2098'>
<a name='2099'>
          lamg = 1./ilamg(k)<a name='2100'>
          lam_exp = lamg * (cgg(3)*ogg2*ogg1)**bm_g<a name='2101'>
          N0_exp = ogg1*rg(k)/am_g * lam_exp**cge(1)<a name='2102'>
          nig = NINT(DLOG10(N0_exp))<a name='2103'>
          do nn = nig-1, nig+1<a name='2104'>
             n = nn<a name='2105'>
             if ( (N0_exp/10.**nn).ge.1.0 .and. &amp;<a name='2106'>
                  (N0_exp/10.**nn).lt.10.0) goto 148<a name='2107'>
          enddo<a name='2108'>
 148      continue<a name='2109'>
          idx_g1 = INT(N0_exp/10.**n) + 10*(n-nig3) - (n-nig3)<a name='2110'>
          idx_g1 = MAX(1, MIN(idx_g1, ntb_g1))<a name='2111'>
         else<a name='2112'>
          idx_g = 1<a name='2113'>
          idx_g1 = ntb_g1<a name='2114'>
         endif<a name='2115'>
<a name='2116'>
<font color=#447700>!..Deposition/sublimation prefactor (from Srivastava &amp; Coen 1992).<a name='2117'></font>
         otemp = 1./temp(k)<a name='2118'>
         rvs = rho(k)*qvsi(k)<a name='2119'>
         rvs_p = rvs*otemp*(lsub*otemp*oRv - 1.)<a name='2120'>
         rvs_pp = rvs * ( otemp*(lsub*otemp*oRv - 1.) &amp;<a name='2121'>
                         *otemp*(lsub*otemp*oRv - 1.) &amp;<a name='2122'>
                         + (-2.*lsub*otemp*otemp*otemp*oRv) &amp;<a name='2123'>
                         + otemp*otemp)<a name='2124'>
         gamsc = lsub*diffu(k)/tcond(k) * rvs_p<a name='2125'>
         alphsc = 0.5*(gamsc/(1.+gamsc))*(gamsc/(1.+gamsc)) &amp;<a name='2126'>
                    * rvs_pp/rvs_p * rvs/rvs_p<a name='2127'>
         alphsc = MAX(1.E-9, alphsc)<a name='2128'>
         xsat = ssati(k)<a name='2129'>
         if (abs(xsat).lt. 1.E-9) xsat=0.<a name='2130'>
         t1_subl = 4.*PI*( 1.0 - alphsc*xsat &amp;<a name='2131'>
                + 2.*alphsc*alphsc*xsat*xsat &amp;<a name='2132'>
                - 5.*alphsc*alphsc*alphsc*xsat*xsat*xsat ) &amp;<a name='2133'>
                / (1.+gamsc)<a name='2134'>
<a name='2135'>
<font color=#447700>!..Snow collecting cloud water.  In CE, assume Dc&lt;&lt;Ds and vtc=~0.<a name='2136'></font>
         if (L_qc(k) .and. mvd_c(k).gt. D0c) then<a name='2137'>
          xDs = 0.0<a name='2138'>
          if (L_qs(k)) xDs = smoc(k) / smob(k)<a name='2139'>
          if (xDs .gt. D0s) then<a name='2140'>
           idx = 1 + INT(nbs*DLOG(xDs/Ds(1))/DLOG(Ds(nbs)/Ds(1)))<a name='2141'>
           idx = MIN(idx, nbs)<a name='2142'>
           Ef_sw = t_Efsw(idx, INT(mvd_c(k)*1.E6))<a name='2143'>
           prs_scw(k) = rhof(k)*t1_qs_qc*Ef_sw*rc(k)*smoe(k)<a name='2144'>
           pnc_scw(k) = rhof(k)*t1_qs_qc*Ef_sw*nc(k)*smoe(k)                <font color=#447700>! Qc2M<a name='2145'></font>
           pnc_scw(k) = MIN(DBLE(nc(k)*odts), pnc_scw(k))<a name='2146'>
          endif<a name='2147'>
<a name='2148'>
<font color=#447700>!..Graupel collecting cloud water.  In CE, assume Dc&lt;&lt;Dg and vtc=~0.<a name='2149'></font>
          if (rg(k).ge. r_g(1) .and. mvd_c(k).gt. D0c) then<a name='2150'>
           xDg = (bm_g + mu_g + 1.) * ilamg(k)<a name='2151'>
           vtg = rhof(k)*av_g*cgg(6)*ogg3 * ilamg(k)**bv_g<a name='2152'>
           stoke_g = mvd_c(k)*mvd_c(k)*vtg*rho_w/(9.*visco(k)*xDg)<a name='2153'>
           if (xDg.gt. D0g) then<a name='2154'>
            if (stoke_g.ge.0.4 .and. stoke_g.le.10.) then<a name='2155'>
             Ef_gw = 0.55*ALOG10(2.51*stoke_g)<a name='2156'>
            elseif (stoke_g.lt.0.4) then<a name='2157'>
             Ef_gw = 0.0<a name='2158'>
            elseif (stoke_g.gt.10) then<a name='2159'>
             Ef_gw = 0.77<a name='2160'>
            endif<a name='2161'>
            prg_gcw(k) = rhof(k)*t1_qg_qc*Ef_gw*rc(k)*N0_g(k) &amp;<a name='2162'>
                          *ilamg(k)**cge(9)<a name='2163'>
            pnc_gcw(k) = rhof(k)*t1_qg_qc*Ef_gw*nc(k)*N0_g(k)           &amp;<a name='2164'>
                          *ilamg(k)**cge(9)                                 <font color=#447700>! Qc2M<a name='2165'></font>
            pnc_gcw(k) = MIN(DBLE(nc(k)*odts), pnc_gcw(k))<a name='2166'>
           endif<a name='2167'>
          endif<a name='2168'>
         endif<a name='2169'>
<a name='2170'>
<font color=#447700>!..Snow and graupel collecting aerosols, wet scavenging.<a name='2171'></font>
         if (rs(k) .gt. r_s(1)) then<a name='2172'>
          xDs = smoc(k) / smob(k)<a name='2173'>
          Ef_sa = <A href='../../html_code/phys/module_mp_thompson.F.html#EFF_AERO'>Eff_aero</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EFF_AERO_3">(xDs,0.04E-6,visco(k),rho(k),temp(k),'s')<a name='2174'>
          pna_sca(k) = rhof(k)*t1_qs_qc*Ef_sa*nwfa(k)*smoe(k)<a name='2175'>
          pna_sca(k) = MIN(DBLE(nwfa(k)*odts), pna_sca(k))<a name='2176'>
<a name='2177'>
          Ef_sa = <A href='../../html_code/phys/module_mp_thompson.F.html#EFF_AERO'>Eff_aero</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EFF_AERO_4">(xDs,0.8E-6,visco(k),rho(k),temp(k),'s')<a name='2178'>
          pnd_scd(k) = rhof(k)*t1_qs_qc*Ef_sa*nifa(k)*smoe(k)<a name='2179'>
          pnd_scd(k) = MIN(DBLE(nifa(k)*odts), pnd_scd(k))<a name='2180'>
         endif<a name='2181'>
         if (rg(k) .gt. r_g(1)) then<a name='2182'>
          xDg = (bm_g + mu_g + 1.) * ilamg(k)<a name='2183'>
          Ef_ga = <A href='../../html_code/phys/module_mp_thompson.F.html#EFF_AERO'>Eff_aero</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EFF_AERO_5">(xDg,0.04E-6,visco(k),rho(k),temp(k),'g')<a name='2184'>
          pna_gca(k) = rhof(k)*t1_qg_qc*Ef_ga*nwfa(k)*N0_g(k)           &amp;<a name='2185'>
                        *ilamg(k)**cge(9)<a name='2186'>
          pna_gca(k) = MIN(DBLE(nwfa(k)*odts), pna_gca(k))<a name='2187'>
<a name='2188'>
          Ef_ga = <A href='../../html_code/phys/module_mp_thompson.F.html#EFF_AERO'>Eff_aero</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EFF_AERO_6">(xDg,0.8E-6,visco(k),rho(k),temp(k),'g')<a name='2189'>
          pnd_gcd(k) = rhof(k)*t1_qg_qc*Ef_ga*nifa(k)*N0_g(k)           &amp;<a name='2190'>
                        *ilamg(k)**cge(9)<a name='2191'>
          pnd_gcd(k) = MIN(DBLE(nifa(k)*odts), pnd_gcd(k))<a name='2192'>
         endif<a name='2193'>
<a name='2194'>
<font color=#447700>!..Rain collecting snow.  Cannot assume Wisner (1972) approximation<a name='2195'></font>
<font color=#447700>!.. or Mizuno (1990) approach so we solve the CE explicitly and store<a name='2196'></font>
<font color=#447700>!.. results in lookup table.<a name='2197'></font>
         if (rr(k).ge. r_r(1)) then<a name='2198'>
          if (rs(k).ge. r_s(1)) then<a name='2199'>
           if (temp(k).lt.T_0) then<a name='2200'>
            prr_rcs(k) = -(tmr_racs2(idx_s,idx_t,idx_r1,idx_r) &amp;<a name='2201'>
                           + tcr_sacr2(idx_s,idx_t,idx_r1,idx_r) &amp;<a name='2202'>
                           + tmr_racs1(idx_s,idx_t,idx_r1,idx_r) &amp;<a name='2203'>
                           + tcr_sacr1(idx_s,idx_t,idx_r1,idx_r))<a name='2204'>
            prs_rcs(k) = tmr_racs2(idx_s,idx_t,idx_r1,idx_r) &amp;<a name='2205'>
                         + tcr_sacr2(idx_s,idx_t,idx_r1,idx_r) &amp;<a name='2206'>
                         - tcs_racs1(idx_s,idx_t,idx_r1,idx_r) &amp;<a name='2207'>
                         - tms_sacr1(idx_s,idx_t,idx_r1,idx_r)<a name='2208'>
            prg_rcs(k) = tmr_racs1(idx_s,idx_t,idx_r1,idx_r) &amp;<a name='2209'>
                         + tcr_sacr1(idx_s,idx_t,idx_r1,idx_r) &amp;<a name='2210'>
                         + tcs_racs1(idx_s,idx_t,idx_r1,idx_r) &amp;<a name='2211'>
                         + tms_sacr1(idx_s,idx_t,idx_r1,idx_r)<a name='2212'>
            prr_rcs(k) = MAX(DBLE(-rr(k)*odts), prr_rcs(k))<a name='2213'>
            prs_rcs(k) = MAX(DBLE(-rs(k)*odts), prs_rcs(k))<a name='2214'>
            prg_rcs(k) = MIN(DBLE((rr(k)+rs(k))*odts), prg_rcs(k))<a name='2215'>
            pnr_rcs(k) = tnr_racs1(idx_s,idx_t,idx_r1,idx_r)            &amp;   <font color=#447700>! RAIN2M<a name='2216'></font>
                         + tnr_racs2(idx_s,idx_t,idx_r1,idx_r)          &amp;<a name='2217'>
                         + tnr_sacr1(idx_s,idx_t,idx_r1,idx_r)          &amp;<a name='2218'>
                         + tnr_sacr2(idx_s,idx_t,idx_r1,idx_r)<a name='2219'>
           else<a name='2220'>
            prs_rcs(k) = -tcs_racs1(idx_s,idx_t,idx_r1,idx_r)           &amp;<a name='2221'>
                         - tms_sacr1(idx_s,idx_t,idx_r1,idx_r)          &amp;<a name='2222'>
                         + tmr_racs2(idx_s,idx_t,idx_r1,idx_r)          &amp;<a name='2223'>
                         + tcr_sacr2(idx_s,idx_t,idx_r1,idx_r)<a name='2224'>
            prs_rcs(k) = MAX(DBLE(-rs(k)*odts), prs_rcs(k))<a name='2225'>
            prr_rcs(k) = -prs_rcs(k)<a name='2226'>
            pnr_rcs(k) = tnr_racs2(idx_s,idx_t,idx_r1,idx_r)            &amp;   <font color=#447700>! RAIN2M<a name='2227'></font>
                         + tnr_sacr2(idx_s,idx_t,idx_r1,idx_r)<a name='2228'>
           endif<a name='2229'>
           pnr_rcs(k) = MIN(DBLE(nr(k)*odts), pnr_rcs(k))<a name='2230'>
          endif<a name='2231'>
<a name='2232'>
<font color=#447700>!..Rain collecting graupel.  Cannot assume Wisner (1972) approximation<a name='2233'></font>
<font color=#447700>!.. or Mizuno (1990) approach so we solve the CE explicitly and store<a name='2234'></font>
<font color=#447700>!.. results in lookup table.<a name='2235'></font>
          if (rg(k).ge. r_g(1)) then<a name='2236'>
           if (temp(k).lt.T_0) then<a name='2237'>
            prg_rcg(k) = tmr_racg(idx_g1,idx_g,idx_r1,idx_r) &amp;<a name='2238'>
                         + tcr_gacr(idx_g1,idx_g,idx_r1,idx_r)<a name='2239'>
            prg_rcg(k) = MIN(DBLE(rr(k)*odts), prg_rcg(k))<a name='2240'>
            prr_rcg(k) = -prg_rcg(k)<a name='2241'>
            pnr_rcg(k) = tnr_racg(idx_g1,idx_g,idx_r1,idx_r)            &amp;   <font color=#447700>! RAIN2M<a name='2242'></font>
                         + tnr_gacr(idx_g1,idx_g,idx_r1,idx_r)<a name='2243'>
            pnr_rcg(k) = MIN(DBLE(nr(k)*odts), pnr_rcg(k))<a name='2244'>
           else<a name='2245'>
            prr_rcg(k) = tcg_racg(idx_g1,idx_g,idx_r1,idx_r)<a name='2246'>
            prr_rcg(k) = MIN(DBLE(rg(k)*odts), prr_rcg(k))<a name='2247'>
            prg_rcg(k) = -prr_rcg(k)<a name='2248'>
<font color=#447700>!..Put in explicit drop break-up due to collisions.<a name='2249'></font>
            pnr_rcg(k) = -5.*tnr_gacr(idx_g1,idx_g,idx_r1,idx_r)         <font color=#447700>! RAIN2M<a name='2250'></font>
           endif<a name='2251'>
          endif<a name='2252'>
         endif<a name='2253'>
<a name='2254'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2255'></font>
<font color=#447700>!..Next IF block handles only those processes below 0C.<a name='2256'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2257'></font>
<a name='2258'>
         if (temp(k).lt.T_0) then<a name='2259'>
<a name='2260'>
          vts_boost(k) = 1.0<a name='2261'>
          rate_max = (qv(k)-qvsi(k))*rho(k)*odts*0.999<a name='2262'>
<a name='2263'>
<font color=#447700>!+---+---------------- BEGIN NEW ICE NUCLEATION -----------------------+<a name='2264'></font>
<font color=#447700>!..Freezing of supercooled water (rain or cloud) is influenced by dust<a name='2265'></font>
<font color=#447700>!.. but still using Bigg 1953 with a temperature adjustment of a few<a name='2266'></font>
<font color=#447700>!.. degrees depending on dust concentration.  A default value by way<a name='2267'></font>
<font color=#447700>!.. of idx_IN is 1.0 per Liter of air is used when dustyIce flag is<a name='2268'></font>
<font color=#447700>!.. false.  Next, a combination of deposition/condensation freezing<a name='2269'></font>
<font color=#447700>!.. using DeMott et al (2010) dust nucleation when water saturated or<a name='2270'></font>
<font color=#447700>!.. Phillips et al (2008) when below water saturation; else, without<a name='2271'></font>
<font color=#447700>!.. dustyIce flag, use the previous Cooper (1986) temperature-dependent<a name='2272'></font>
<font color=#447700>!.. value.  Lastly, allow homogeneous freezing of deliquesced aerosols<a name='2273'></font>
<font color=#447700>!.. following Koop et al. (2001, Nature).<a name='2274'></font>
<font color=#447700>!.. Implemented by T. Eidhammer and G. Thompson 2012Dec18<a name='2275'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2276'></font>
<a name='2277'>
          if (dustyIce .AND. is_aerosol_aware) then<a name='2278'>
           xni = <A href='../../html_code/phys/module_mp_thompson.F.html#ICEDEMOTT'>iceDeMott</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICEDEMOTT_1">(tempc,qvs(k),qvs(k),qvsi(k),rho(k),nifa(k))<a name='2279'>
          else<a name='2280'>
           xni = 1.0 *1000.                                               <font color=#447700>! Default is 1.0 per Liter<a name='2281'></font>
          endif<a name='2282'>
<a name='2283'>
<font color=#447700>!..Ice nuclei lookup table index.<a name='2284'></font>
          if (xni.gt. Nt_IN(1)) then<a name='2285'>
           niin = NINT(ALOG10(xni))<a name='2286'>
           do nn = niin-1, niin+1<a name='2287'>
              n = nn<a name='2288'>
              if ( (xni/10.**nn).ge.1.0 .and. &amp;<a name='2289'>
                   (xni/10.**nn).lt.10.0) goto 149<a name='2290'>
           enddo<a name='2291'>
 149       continue<a name='2292'>
           idx_IN = INT(xni/10.**n) + 10*(n-niin2) - (n-niin2)<a name='2293'>
           idx_IN = MAX(1, MIN(idx_IN, ntb_IN))<a name='2294'>
          else<a name='2295'>
           idx_IN = 1<a name='2296'>
          endif<a name='2297'>
<a name='2298'>
<font color=#447700>!..Freezing of water drops into graupel/cloud ice (Bigg 1953).<a name='2299'></font>
          if (rr(k).gt. r_r(1)) then<a name='2300'>
           prg_rfz(k) = tpg_qrfz(idx_r,idx_r1,idx_tc,idx_IN)*odts<a name='2301'>
           pri_rfz(k) = tpi_qrfz(idx_r,idx_r1,idx_tc,idx_IN)*odts<a name='2302'>
           pni_rfz(k) = tni_qrfz(idx_r,idx_r1,idx_tc,idx_IN)*odts<a name='2303'>
           pnr_rfz(k) = tnr_qrfz(idx_r,idx_r1,idx_tc,idx_IN)*odts          <font color=#447700>! RAIN2M<a name='2304'></font>
           pnr_rfz(k) = MIN(DBLE(nr(k)*odts), pnr_rfz(k))<a name='2305'>
          elseif (rr(k).gt. R1 .and. temp(k).lt.HGFR) then<a name='2306'>
           pri_rfz(k) = rr(k)*odts<a name='2307'>
           pnr_rfz(k) = nr(k)*odts                                         <font color=#447700>! RAIN2M<a name='2308'></font>
           pni_rfz(k) = pnr_rfz(k)<a name='2309'>
          endif<a name='2310'>
<a name='2311'>
          if (rc(k).gt. r_c(1)) then<a name='2312'>
           pri_wfz(k) = tpi_qcfz(idx_c,idx_n,idx_tc,idx_IN)*odts<a name='2313'>
           pri_wfz(k) = MIN(DBLE(rc(k)*odts), pri_wfz(k))<a name='2314'>
           pni_wfz(k) = tni_qcfz(idx_c,idx_n,idx_tc,idx_IN)*odts<a name='2315'>
           pni_wfz(k) = MIN(DBLE(nc(k)*odts), pri_wfz(k)/(2.*xm0i),     &amp;<a name='2316'>
                                pni_wfz(k))<a name='2317'>
          elseif (rc(k).gt. R1 .and. temp(k).lt.HGFR) then<a name='2318'>
           pri_wfz(k) = rc(k)*odts<a name='2319'>
           pni_wfz(k) = nc(k)*odts<a name='2320'>
          endif<a name='2321'>
<a name='2322'>
<font color=#447700>!..Deposition nucleation of dust/mineral from DeMott et al (2010)<a name='2323'></font>
<font color=#447700>!.. we may need to relax the temperature and ssati constraints.<a name='2324'></font>
          if ( (ssati(k).ge. 0.25) .or. (ssatw(k).gt. eps &amp;<a name='2325'>
                                .and. temp(k).lt.253.15) ) then<a name='2326'>
           if (dustyIce .AND. is_aerosol_aware) then<a name='2327'>
            xnc = <A href='../../html_code/phys/module_mp_thompson.F.html#ICEDEMOTT'>iceDeMott</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICEDEMOTT_2">(tempc,qv(k),qvs(k),qvsi(k),rho(k),nifa(k))<a name='2328'>
           else<a name='2329'>
            xnc = MIN(250.E3, TNO*EXP(ATO*(T_0-temp(k))))<a name='2330'>
           endif<a name='2331'>
           xni = ni(k) + (pni_rfz(k)+pni_wfz(k))*dtsave<a name='2332'>
           pni_inu(k) = 0.5*(xnc-xni + abs(xnc-xni))*odts<a name='2333'>
           pri_inu(k) = MIN(DBLE(rate_max), xm0i*pni_inu(k))<a name='2334'>
           pni_inu(k) = pri_inu(k)/xm0i<a name='2335'>
          endif<a name='2336'>
<a name='2337'>
<font color=#447700>!..Freezing of aqueous aerosols based on Koop et al (2001, Nature)<a name='2338'></font>
          xni = smo0(k)+ni(k) + (pni_rfz(k)+pni_wfz(k)+pni_inu(k))*dtsave<a name='2339'>
          if (is_aerosol_aware .AND. homogIce .AND. (xni.le.500.E3)     &amp;<a name='2340'>
     &amp;                .AND.(temp(k).lt.238).AND.(ssati(k).ge.0.4) ) then<a name='2341'>
            xnc = <A href='../../html_code/phys/module_mp_thompson.F.html#ICEKOOP'>iceKoop</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICEKOOP_1">(temp(k),qv(k),qvs(k),nwfa(k), dtsave)<a name='2342'>
            pni_iha(k) = xnc*odts<a name='2343'>
            pri_iha(k) = MIN(DBLE(rate_max), xm0i*0.1*pni_iha(k))<a name='2344'>
            pni_iha(k) = pri_iha(k)/(xm0i*0.1)<a name='2345'>
          endif<a name='2346'>
<font color=#447700>!+---+------------------ END NEW ICE NUCLEATION -----------------------+<a name='2347'></font>
<a name='2348'>
<a name='2349'>
<font color=#447700>!..Deposition/sublimation of cloud ice (Srivastava &amp; Coen 1992).<a name='2350'></font>
          if (L_qi(k)) then<a name='2351'>
           lami = (am_i*cig(2)*oig1*ni(k)/ri(k))**obmi<a name='2352'>
           ilami = 1./lami<a name='2353'>
           xDi = MAX(DBLE(D0i), (bm_i + mu_i + 1.) * ilami)<a name='2354'>
           xmi = am_i*xDi**bm_i<a name='2355'>
           oxmi = 1./xmi<a name='2356'>
           pri_ide(k) = C_cube*t1_subl*diffu(k)*ssati(k)*rvs &amp;<a name='2357'>
                  *oig1*cig(5)*ni(k)*ilami<a name='2358'>
<a name='2359'>
           if (pri_ide(k) .lt. 0.0) then<a name='2360'>
            pri_ide(k) = MAX(DBLE(-ri(k)*odts), pri_ide(k), DBLE(rate_max))<a name='2361'>
            pni_ide(k) = pri_ide(k)*oxmi<a name='2362'>
            pni_ide(k) = MAX(DBLE(-ni(k)*odts), pni_ide(k))<a name='2363'>
           else<a name='2364'>
            pri_ide(k) = MIN(pri_ide(k), DBLE(rate_max))<a name='2365'>
            prs_ide(k) = (1.0D0-tpi_ide(idx_i,idx_i1))*pri_ide(k)<a name='2366'>
            pri_ide(k) = tpi_ide(idx_i,idx_i1)*pri_ide(k)<a name='2367'>
           endif<a name='2368'>
<a name='2369'>
<font color=#447700>!..Some cloud ice needs to move into the snow category.  Use lookup<a name='2370'></font>
<font color=#447700>!.. table that resulted from explicit bin representation of distrib.<a name='2371'></font>
           if ( (idx_i.eq. ntb_i) .or. (xDi.gt. 5.0*D0s) ) then<a name='2372'>
            prs_iau(k) = ri(k)*.99*odts<a name='2373'>
            pni_iau(k) = ni(k)*.95*odts<a name='2374'>
           elseif (xDi.lt. 0.1*D0s) then<a name='2375'>
            prs_iau(k) = 0.<a name='2376'>
            pni_iau(k) = 0.<a name='2377'>
           else<a name='2378'>
            prs_iau(k) = tps_iaus(idx_i,idx_i1)*odts<a name='2379'>
            prs_iau(k) = MIN(DBLE(ri(k)*.99*odts), prs_iau(k))<a name='2380'>
            pni_iau(k) = tni_iaus(idx_i,idx_i1)*odts<a name='2381'>
            pni_iau(k) = MIN(DBLE(ni(k)*.95*odts), pni_iau(k))<a name='2382'>
           endif<a name='2383'>
          endif<a name='2384'>
<a name='2385'>
<font color=#447700>!..Deposition/sublimation of snow/graupel follows Srivastava &amp; Coen<a name='2386'></font>
<font color=#447700>!.. (1992).<a name='2387'></font>
          if (L_qs(k)) then<a name='2388'>
           C_snow = C_sqrd + (tempc+1.5)*(C_cube-C_sqrd)/(-30.+1.5)<a name='2389'>
           C_snow = MAX(C_sqrd, MIN(C_snow, C_cube))<a name='2390'>
           prs_sde(k) = C_snow*t1_subl*diffu(k)*ssati(k)*rvs &amp;<a name='2391'>
                        * (t1_qs_sd*smo1(k) &amp;<a name='2392'>
                         + t2_qs_sd*rhof2(k)*vsc2(k)*smof(k))<a name='2393'>
           if (prs_sde(k).lt. 0.) then<a name='2394'>
            prs_sde(k) = MAX(DBLE(-rs(k)*odts), prs_sde(k), DBLE(rate_max))<a name='2395'>
           else<a name='2396'>
            prs_sde(k) = MIN(prs_sde(k), DBLE(rate_max))<a name='2397'>
           endif<a name='2398'>
          endif<a name='2399'>
<a name='2400'>
          if (L_qg(k) .and. ssati(k).lt. -eps) then<a name='2401'>
           prg_gde(k) = C_cube*t1_subl*diffu(k)*ssati(k)*rvs &amp;<a name='2402'>
               * N0_g(k) * (t1_qg_sd*ilamg(k)**cge(10) &amp;<a name='2403'>
               + t2_qg_sd*vsc2(k)*rhof2(k)*ilamg(k)**cge(11))<a name='2404'>
           if (prg_gde(k).lt. 0.) then<a name='2405'>
            prg_gde(k) = MAX(DBLE(-rg(k)*odts), prg_gde(k), DBLE(rate_max))<a name='2406'>
           else<a name='2407'>
            prg_gde(k) = MIN(prg_gde(k), DBLE(rate_max))<a name='2408'>
           endif<a name='2409'>
          endif<a name='2410'>
<a name='2411'>
<font color=#447700>!..Snow collecting cloud ice.  In CE, assume Di&lt;&lt;Ds and vti=~0.<a name='2412'></font>
          if (L_qi(k)) then<a name='2413'>
           lami = (am_i*cig(2)*oig1*ni(k)/ri(k))**obmi<a name='2414'>
           ilami = 1./lami<a name='2415'>
           xDi = MAX(DBLE(D0i), (bm_i + mu_i + 1.) * ilami)<a name='2416'>
           xmi = am_i*xDi**bm_i<a name='2417'>
           oxmi = 1./xmi<a name='2418'>
           if (rs(k).ge. r_s(1)) then<a name='2419'>
            prs_sci(k) = t1_qs_qi*rhof(k)*Ef_si*ri(k)*smoe(k)<a name='2420'>
            pni_sci(k) = prs_sci(k) * oxmi<a name='2421'>
           endif<a name='2422'>
<a name='2423'>
<font color=#447700>!..Rain collecting cloud ice.  In CE, assume Di&lt;&lt;Dr and vti=~0.<a name='2424'></font>
           if (rr(k).ge. r_r(1) .and. mvd_r(k).gt. 4.*xDi) then<a name='2425'>
            lamr = 1./ilamr(k)<a name='2426'>
            pri_rci(k) = rhof(k)*t1_qr_qi*Ef_ri*ri(k)*N0_r(k) &amp;<a name='2427'>
                           *((lamr+fv_r)**(-cre(9)))<a name='2428'>
            pnr_rci(k) = rhof(k)*t1_qr_qi*Ef_ri*ni(k)*N0_r(k)           &amp;   <font color=#447700>! RAIN2M<a name='2429'></font>
                           *((lamr+fv_r)**(-cre(9)))<a name='2430'>
            pni_rci(k) = pri_rci(k) * oxmi<a name='2431'>
            prr_rci(k) = rhof(k)*t2_qr_qi*Ef_ri*ni(k)*N0_r(k) &amp;<a name='2432'>
                           *((lamr+fv_r)**(-cre(8)))<a name='2433'>
            prr_rci(k) = MIN(DBLE(rr(k)*odts), prr_rci(k))<a name='2434'>
            prg_rci(k) = pri_rci(k) + prr_rci(k)<a name='2435'>
           endif<a name='2436'>
          endif<a name='2437'>
<a name='2438'>
<font color=#447700>!..Ice multiplication from rime-splinters (Hallet &amp; Mossop 1974).<a name='2439'></font>
          if (prg_gcw(k).gt. eps .and. tempc.gt.-8.0) then<a name='2440'>
           tf = 0.<a name='2441'>
           if (tempc.ge.-5.0 .and. tempc.lt.-3.0) then<a name='2442'>
            tf = 0.5*(-3.0 - tempc)<a name='2443'>
           elseif (tempc.gt.-8.0 .and. tempc.lt.-5.0) then<a name='2444'>
            tf = 0.33333333*(8.0 + tempc)<a name='2445'>
           endif<a name='2446'>
           pni_ihm(k) = 3.5E8*tf*prg_gcw(k)<a name='2447'>
           pri_ihm(k) = xm0i*pni_ihm(k)<a name='2448'>
           prs_ihm(k) = prs_scw(k)/(prs_scw(k)+prg_gcw(k)) &amp;<a name='2449'>
                          * pri_ihm(k)<a name='2450'>
           prg_ihm(k) = prg_gcw(k)/(prs_scw(k)+prg_gcw(k)) &amp;<a name='2451'>
                          * pri_ihm(k)<a name='2452'>
          endif<a name='2453'>
<a name='2454'>
<font color=#447700>!..A portion of rimed snow converts to graupel but some remains snow.<a name='2455'></font>
<font color=#447700>!.. Interp from 15 to 95% as riming factor increases from 2.0 to 30.0<a name='2456'></font>
<font color=#447700>!.. 0.028 came from (.95-.15)/(30.-2.).  This remains ad-hoc and should<a name='2457'></font>
<font color=#447700>!.. be revisited.<a name='2458'></font>
          if (prs_scw(k).gt.2.0*prs_sde(k) .and. &amp;<a name='2459'>
                         prs_sde(k).gt.eps) then<a name='2460'>
           r_frac = MIN(30.0D0, prs_scw(k)/prs_sde(k))<a name='2461'>
           g_frac = MIN(0.95, 0.15 + (r_frac-2.)*.028)<a name='2462'>
           vts_boost(k) = MIN(1.5, 1.1 + (r_frac-2.)*.016)<a name='2463'>
           prg_scw(k) = g_frac*prs_scw(k)<a name='2464'>
           prs_scw(k) = (1. - g_frac)*prs_scw(k)<a name='2465'>
          endif<a name='2466'>
<a name='2467'>
         else<a name='2468'>
<a name='2469'>
<font color=#447700>!..Melt snow and graupel and enhance from collisions with liquid.<a name='2470'></font>
<font color=#447700>!.. We also need to sublimate snow and graupel if subsaturated.<a name='2471'></font>
          if (L_qs(k)) then<a name='2472'>
           prr_sml(k) = (tempc*tcond(k)-lvap0*diffu(k)*delQvs(k))       &amp;<a name='2473'>
                      * (t1_qs_me*smo1(k) + t2_qs_me*rhof2(k)*vsc2(k)*smof(k))<a name='2474'>
           prr_sml(k) = prr_sml(k) + 4218.*olfus*tempc &amp;<a name='2475'>
                                   * (prr_rcs(k)+prs_scw(k))<a name='2476'>
           prr_sml(k) = MIN(DBLE(rs(k)*odts), MAX(0.D0, prr_sml(k)))<a name='2477'>
           pnr_sml(k) = smo0(k)/rs(k)*prr_sml(k) * 10.0**(-0.25*tempc)      <font color=#447700>! RAIN2M<a name='2478'></font>
           pnr_sml(k) = MIN(DBLE(smo0(k)*odts), pnr_sml(k))<a name='2479'>
<font color=#447700>!          if (tempc.gt.3.5 .or. rs(k).lt.0.005E-3) pnr_sml(k)=0.0<a name='2480'></font>
<a name='2481'>
           if (ssati(k).lt. 0.) then<a name='2482'>
            prs_sde(k) = C_cube*t1_subl*diffu(k)*ssati(k)*rvs &amp;<a name='2483'>
                         * (t1_qs_sd*smo1(k) &amp;<a name='2484'>
                          + t2_qs_sd*rhof2(k)*vsc2(k)*smof(k))<a name='2485'>
            prs_sde(k) = MAX(DBLE(-rs(k)*odts), prs_sde(k))<a name='2486'>
           endif<a name='2487'>
          endif<a name='2488'>
<a name='2489'>
          if (L_qg(k)) then<a name='2490'>
           prr_gml(k) = (tempc*tcond(k)-lvap0*diffu(k)*delQvs(k))       &amp;<a name='2491'>
                      * N0_g(k)*(t1_qg_me*ilamg(k)**cge(10)             &amp;<a name='2492'>
                      + t2_qg_me*rhof2(k)*vsc2(k)*ilamg(k)**cge(11))<a name='2493'>
<font color=#447700>!-GT       prr_gml(k) = prr_gml(k) + 4218.*olfus*tempc &amp;<a name='2494'></font>
<font color=#447700>!-GT                               * (prr_rcg(k)+prg_gcw(k))<a name='2495'></font>
           prr_gml(k) = MIN(DBLE(rg(k)*odts), MAX(0.D0, prr_gml(k)))<a name='2496'>
           pnr_gml(k) = N0_g(k)*cgg(2)*ilamg(k)**cge(2) / rg(k)         &amp;   <font color=#447700>! RAIN2M<a name='2497'></font>
                      * prr_gml(k) * 10.0**(-0.5*tempc)<a name='2498'>
<font color=#447700>!          if (tempc.gt.7.5 .or. rg(k).lt.0.005E-3) pnr_gml(k)=0.0<a name='2499'></font>
<a name='2500'>
           if (ssati(k).lt. 0.) then<a name='2501'>
            prg_gde(k) = C_cube*t1_subl*diffu(k)*ssati(k)*rvs &amp;<a name='2502'>
                * N0_g(k) * (t1_qg_sd*ilamg(k)**cge(10) &amp;<a name='2503'>
                + t2_qg_sd*vsc2(k)*rhof2(k)*ilamg(k)**cge(11))<a name='2504'>
            prg_gde(k) = MAX(DBLE(-rg(k)*odts), prg_gde(k))<a name='2505'>
           endif<a name='2506'>
          endif<a name='2507'>
<a name='2508'>
<font color=#447700>!.. This change will be required if users run adaptive time step that<a name='2509'></font>
<font color=#447700>!.. results in delta-t that is generally too long to allow cloud water<a name='2510'></font>
<font color=#447700>!.. collection by snow/graupel above melting temperature.<a name='2511'></font>
<font color=#447700>!.. Credit to Bjorn-Egil Nygaard for discovering.<a name='2512'></font>
          if (dt .gt. 120.) then<a name='2513'>
             prr_rcw(k)=prr_rcw(k)+prs_scw(k)+prg_gcw(k)<a name='2514'>
             prs_scw(k)=0.<a name='2515'>
             prg_gcw(k)=0.<a name='2516'>
          endif<a name='2517'>
<a name='2518'>
         endif<a name='2519'>
<a name='2520'>
      enddo<a name='2521'>
      endif<a name='2522'>
<a name='2523'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2524'></font>
<font color=#447700>!..Ensure we do not deplete more hydrometeor species than exists.<a name='2525'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2526'></font>
      do k = kts, kte<a name='2527'>
<a name='2528'>
<font color=#447700>!..If ice supersaturated, ensure sum of depos growth terms does not<a name='2529'></font>
<font color=#447700>!.. deplete more vapor than possibly exists.  If subsaturated, limit<a name='2530'></font>
<font color=#447700>!.. sum of sublimation terms such that vapor does not reproduce ice<a name='2531'></font>
<font color=#447700>!.. supersat again.<a name='2532'></font>
         sump = pri_inu(k) + pri_ide(k) + prs_ide(k) &amp;<a name='2533'>
              + prs_sde(k) + prg_gde(k) + pri_iha(k)<a name='2534'>
         rate_max = (qv(k)-qvsi(k))*rho(k)*odts*0.999<a name='2535'>
         if ( (sump.gt. eps .and. sump.gt. rate_max) .or. &amp;<a name='2536'>
              (sump.lt. -eps .and. sump.lt. rate_max) ) then<a name='2537'>
          ratio = rate_max/sump<a name='2538'>
          pri_inu(k) = pri_inu(k) * ratio<a name='2539'>
          pri_ide(k) = pri_ide(k) * ratio<a name='2540'>
          pni_ide(k) = pni_ide(k) * ratio<a name='2541'>
          prs_ide(k) = prs_ide(k) * ratio<a name='2542'>
          prs_sde(k) = prs_sde(k) * ratio<a name='2543'>
          prg_gde(k) = prg_gde(k) * ratio<a name='2544'>
          pri_iha(k) = pri_iha(k) * ratio<a name='2545'>
         endif<a name='2546'>
<a name='2547'>
<font color=#447700>!..Cloud water conservation.<a name='2548'></font>
         sump = -prr_wau(k) - pri_wfz(k) - prr_rcw(k) &amp;<a name='2549'>
                - prs_scw(k) - prg_scw(k) - prg_gcw(k)<a name='2550'>
         rate_max = -rc(k)*odts<a name='2551'>
         if (sump.lt. rate_max .and. L_qc(k)) then<a name='2552'>
          ratio = rate_max/sump<a name='2553'>
          prr_wau(k) = prr_wau(k) * ratio<a name='2554'>
          pri_wfz(k) = pri_wfz(k) * ratio<a name='2555'>
          prr_rcw(k) = prr_rcw(k) * ratio<a name='2556'>
          prs_scw(k) = prs_scw(k) * ratio<a name='2557'>
          prg_scw(k) = prg_scw(k) * ratio<a name='2558'>
          prg_gcw(k) = prg_gcw(k) * ratio<a name='2559'>
         endif<a name='2560'>
<a name='2561'>
<font color=#447700>!..Cloud ice conservation.<a name='2562'></font>
         sump = pri_ide(k) - prs_iau(k) - prs_sci(k) &amp;<a name='2563'>
                - pri_rci(k)<a name='2564'>
         rate_max = -ri(k)*odts<a name='2565'>
         if (sump.lt. rate_max .and. L_qi(k)) then<a name='2566'>
          ratio = rate_max/sump<a name='2567'>
          pri_ide(k) = pri_ide(k) * ratio<a name='2568'>
          prs_iau(k) = prs_iau(k) * ratio<a name='2569'>
          prs_sci(k) = prs_sci(k) * ratio<a name='2570'>
          pri_rci(k) = pri_rci(k) * ratio<a name='2571'>
         endif<a name='2572'>
<a name='2573'>
<font color=#447700>!..Rain conservation.<a name='2574'></font>
         sump = -prg_rfz(k) - pri_rfz(k) - prr_rci(k) &amp;<a name='2575'>
                + prr_rcs(k) + prr_rcg(k)<a name='2576'>
         rate_max = -rr(k)*odts<a name='2577'>
         if (sump.lt. rate_max .and. L_qr(k)) then<a name='2578'>
          ratio = rate_max/sump<a name='2579'>
          prg_rfz(k) = prg_rfz(k) * ratio<a name='2580'>
          pri_rfz(k) = pri_rfz(k) * ratio<a name='2581'>
          prr_rci(k) = prr_rci(k) * ratio<a name='2582'>
          prr_rcs(k) = prr_rcs(k) * ratio<a name='2583'>
          prr_rcg(k) = prr_rcg(k) * ratio<a name='2584'>
         endif<a name='2585'>
<a name='2586'>
<font color=#447700>!..Snow conservation.<a name='2587'></font>
         sump = prs_sde(k) - prs_ihm(k) - prr_sml(k) &amp;<a name='2588'>
                + prs_rcs(k)<a name='2589'>
         rate_max = -rs(k)*odts<a name='2590'>
         if (sump.lt. rate_max .and. L_qs(k)) then<a name='2591'>
          ratio = rate_max/sump<a name='2592'>
          prs_sde(k) = prs_sde(k) * ratio<a name='2593'>
          prs_ihm(k) = prs_ihm(k) * ratio<a name='2594'>
          prr_sml(k) = prr_sml(k) * ratio<a name='2595'>
          prs_rcs(k) = prs_rcs(k) * ratio<a name='2596'>
         endif<a name='2597'>
<a name='2598'>
<font color=#447700>!..Graupel conservation.<a name='2599'></font>
         sump = prg_gde(k) - prg_ihm(k) - prr_gml(k) &amp;<a name='2600'>
              + prg_rcg(k)<a name='2601'>
         rate_max = -rg(k)*odts<a name='2602'>
         if (sump.lt. rate_max .and. L_qg(k)) then<a name='2603'>
          ratio = rate_max/sump<a name='2604'>
          prg_gde(k) = prg_gde(k) * ratio<a name='2605'>
          prg_ihm(k) = prg_ihm(k) * ratio<a name='2606'>
          prr_gml(k) = prr_gml(k) * ratio<a name='2607'>
          prg_rcg(k) = prg_rcg(k) * ratio<a name='2608'>
         endif<a name='2609'>
<a name='2610'>
<font color=#447700>!..Re-enforce proper mass conservation for subsequent elements in case<a name='2611'></font>
<font color=#447700>!.. any of the above terms were altered.  Thanks P. Blossey. 2009Sep28<a name='2612'></font>
         pri_ihm(k) = prs_ihm(k) + prg_ihm(k)<a name='2613'>
         ratio = MIN( ABS(prr_rcg(k)), ABS(prg_rcg(k)) )<a name='2614'>
         prr_rcg(k) = ratio * SIGN(1.0, SNGL(prr_rcg(k)))<a name='2615'>
         prg_rcg(k) = -prr_rcg(k)<a name='2616'>
         if (temp(k).gt.T_0) then<a name='2617'>
            ratio = MIN( ABS(prr_rcs(k)), ABS(prs_rcs(k)) )<a name='2618'>
            prr_rcs(k) = ratio * SIGN(1.0, SNGL(prr_rcs(k)))<a name='2619'>
            prs_rcs(k) = -prr_rcs(k)<a name='2620'>
         endif<a name='2621'>
<a name='2622'>
      enddo<a name='2623'>
<a name='2624'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2625'></font>
<font color=#447700>!..Calculate tendencies of all species but constrain the number of ice<a name='2626'></font>
<font color=#447700>!.. to reasonable values.<a name='2627'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2628'></font>
      do k = kts, kte<a name='2629'>
         orho = 1./rho(k)<a name='2630'>
         lfus2 = lsub - lvap(k)<a name='2631'>
<a name='2632'>
<font color=#447700>!..Aerosol number tendency<a name='2633'></font>
         if (is_aerosol_aware) then<a name='2634'>
            nwfaten(k) = nwfaten(k) - (pna_rca(k) + pna_sca(k)          &amp;<a name='2635'>
                       + pna_gca(k) + pni_iha(k)) * orho<a name='2636'>
            nifaten(k) = nifaten(k) - (pnd_rcd(k) + pnd_scd(k)          &amp;<a name='2637'>
                       + pnd_gcd(k)) * orho<a name='2638'>
            if (dustyIce) then<a name='2639'>
               nifaten(k) = nifaten(k) - pni_inu(k)*orho<a name='2640'>
            else<a name='2641'>
               nifaten(k) = 0.<a name='2642'>
            endif<a name='2643'>
         endif<a name='2644'>
<a name='2645'>
<font color=#447700>!..Water vapor tendency<a name='2646'></font>
         qvten(k) = qvten(k) + (-pri_inu(k) - pri_iha(k) - pri_ide(k)   &amp;<a name='2647'>
                      - prs_ide(k) - prs_sde(k) - prg_gde(k)) &amp;<a name='2648'>
                      * orho<a name='2649'>
<a name='2650'>
<font color=#447700>!..Cloud water tendency<a name='2651'></font>
         qcten(k) = qcten(k) + (-prr_wau(k) - pri_wfz(k) &amp;<a name='2652'>
                      - prr_rcw(k) - prs_scw(k) - prg_scw(k) &amp;<a name='2653'>
                      - prg_gcw(k)) &amp;<a name='2654'>
                      * orho<a name='2655'>
<a name='2656'>
<font color=#447700>!..Cloud water number tendency<a name='2657'></font>
         ncten(k) = ncten(k) + (-pnc_wau(k) - pnc_rcw(k) &amp;<a name='2658'>
                      - pni_wfz(k) - pnc_scw(k) - pnc_gcw(k)) &amp;<a name='2659'>
                      * orho<a name='2660'>
<a name='2661'>
<font color=#447700>!..Cloud water mass/number balance; keep mass-wt mean size between<a name='2662'></font>
<font color=#447700>!.. 1 and 50 microns.  Also no more than Nt_c_max drops total.<a name='2663'></font>
         xrc=MAX(R1, (qc1d(k) + qcten(k)*dtsave)*rho(k))<a name='2664'>
         xnc=MAX(2., (nc1d(k) + ncten(k)*dtsave)*rho(k))<a name='2665'>
         if (xrc .gt. R1) then<a name='2666'>
          nu_c = MIN(15, NINT(1000.E6/xnc) + 2)<a name='2667'>
          lamc = (xnc*am_r*ccg(2,nu_c)*ocg1(nu_c)/rc(k))**obmr<a name='2668'>
          xDc = (bm_r + nu_c + 1.) / lamc<a name='2669'>
          if (xDc.lt. D0c) then<a name='2670'>
           lamc = cce(2,nu_c)/D0c<a name='2671'>
           xnc = ccg(1,nu_c)*ocg2(nu_c)*xrc/am_r*lamc**bm_r<a name='2672'>
           ncten(k) = (xnc-nc1d(k)*rho(k))*odts*orho<a name='2673'>
          elseif (xDc.gt. D0r*2.) then<a name='2674'>
           lamc = cce(2,nu_c)/(D0r*2.)<a name='2675'>
           xnc = ccg(1,nu_c)*ocg2(nu_c)*xrc/am_r*lamc**bm_r<a name='2676'>
           ncten(k) = (xnc-nc1d(k)*rho(k))*odts*orho<a name='2677'>
          endif<a name='2678'>
         else<a name='2679'>
          ncten(k) = -nc1d(k)*odts<a name='2680'>
         endif<a name='2681'>
         xnc=MAX(0.,(nc1d(k) + ncten(k)*dtsave)*rho(k))<a name='2682'>
         if (xnc.gt.Nt_c_max) &amp;<a name='2683'>
                ncten(k) = (Nt_c_max-nc1d(k)*rho(k))*odts*orho<a name='2684'>
<a name='2685'>
<font color=#447700>!..Cloud ice mixing ratio tendency<a name='2686'></font>
         qiten(k) = qiten(k) + (pri_inu(k) + pri_iha(k) + pri_ihm(k)    &amp;<a name='2687'>
                      + pri_wfz(k) + pri_rfz(k) + pri_ide(k) &amp;<a name='2688'>
                      - prs_iau(k) - prs_sci(k) - pri_rci(k)) &amp;<a name='2689'>
                      * orho<a name='2690'>
<a name='2691'>
<font color=#447700>!..Cloud ice number tendency.<a name='2692'></font>
         niten(k) = niten(k) + (pni_inu(k) + pni_iha(k) + pni_ihm(k)    &amp;<a name='2693'>
                      + pni_wfz(k) + pni_rfz(k) + pni_ide(k) &amp;<a name='2694'>
                      - pni_iau(k) - pni_sci(k) - pni_rci(k)) &amp;<a name='2695'>
                      * orho<a name='2696'>
<a name='2697'>
<font color=#447700>!..Cloud ice mass/number balance; keep mass-wt mean size between<a name='2698'></font>
<font color=#447700>!.. 5 and 300 microns.  Also no more than 500 xtals per liter.<a name='2699'></font>
         xri=MAX(R1,(qi1d(k) + qiten(k)*dtsave)*rho(k))<a name='2700'>
         xni=MAX(R2,(ni1d(k) + niten(k)*dtsave)*rho(k))<a name='2701'>
         if (xri.gt. R1) then<a name='2702'>
           lami = (am_i*cig(2)*oig1*xni/xri)**obmi<a name='2703'>
           ilami = 1./lami<a name='2704'>
           xDi = (bm_i + mu_i + 1.) * ilami<a name='2705'>
           if (xDi.lt. 5.E-6) then<a name='2706'>
            lami = cie(2)/5.E-6<a name='2707'>
            xni = MIN(499.D3, cig(1)*oig2*xri/am_i*lami**bm_i)<a name='2708'>
            niten(k) = (xni-ni1d(k)*rho(k))*odts*orho<a name='2709'>
           elseif (xDi.gt. 300.E-6) then<a name='2710'>
            lami = cie(2)/300.E-6<a name='2711'>
            xni = cig(1)*oig2*xri/am_i*lami**bm_i<a name='2712'>
            niten(k) = (xni-ni1d(k)*rho(k))*odts*orho<a name='2713'>
           endif<a name='2714'>
         else<a name='2715'>
          niten(k) = -ni1d(k)*odts<a name='2716'>
         endif<a name='2717'>
         xni=MAX(0.,(ni1d(k) + niten(k)*dtsave)*rho(k))<a name='2718'>
         if (xni.gt.499.E3) &amp;<a name='2719'>
                niten(k) = (499.E3-ni1d(k)*rho(k))*odts*orho<a name='2720'>
<a name='2721'>
<font color=#447700>!..Rain tendency<a name='2722'></font>
         qrten(k) = qrten(k) + (prr_wau(k) + prr_rcw(k) &amp;<a name='2723'>
                      + prr_sml(k) + prr_gml(k) + prr_rcs(k) &amp;<a name='2724'>
                      + prr_rcg(k) - prg_rfz(k) &amp;<a name='2725'>
                      - pri_rfz(k) - prr_rci(k)) &amp;<a name='2726'>
                      * orho<a name='2727'>
<a name='2728'>
<font color=#447700>!..Rain number tendency<a name='2729'></font>
         nrten(k) = nrten(k) + (pnr_wau(k) + pnr_sml(k) + pnr_gml(k)    &amp;<a name='2730'>
                      - (pnr_rfz(k) + pnr_rcr(k) + pnr_rcg(k)           &amp;<a name='2731'>
                      + pnr_rcs(k) + pnr_rci(k)) )                      &amp;<a name='2732'>
                      * orho<a name='2733'>
<a name='2734'>
<font color=#447700>!..Rain mass/number balance; keep median volume diameter between<a name='2735'></font>
<font color=#447700>!.. 37 microns (D0r*0.75) and 2.5 mm.<a name='2736'></font>
         xrr=MAX(R1,(qr1d(k) + qrten(k)*dtsave)*rho(k))<a name='2737'>
         xnr=MAX(R2,(nr1d(k) + nrten(k)*dtsave)*rho(k))<a name='2738'>
         if (xrr.gt. R1) then<a name='2739'>
           lamr = (am_r*crg(3)*org2*xnr/xrr)**obmr<a name='2740'>
           mvd_r(k) = (3.0 + mu_r + 0.672) / lamr<a name='2741'>
           if (mvd_r(k) .gt. 2.5E-3) then<a name='2742'>
              mvd_r(k) = 2.5E-3<a name='2743'>
              lamr = (3.0 + mu_r + 0.672) / mvd_r(k)<a name='2744'>
              xnr = crg(2)*org3*xrr*lamr**bm_r / am_r<a name='2745'>
              nrten(k) = (xnr-nr1d(k)*rho(k))*odts*orho<a name='2746'>
           elseif (mvd_r(k) .lt. D0r*0.75) then<a name='2747'>
              mvd_r(k) = D0r*0.75<a name='2748'>
              lamr = (3.0 + mu_r + 0.672) / mvd_r(k)<a name='2749'>
              xnr = crg(2)*org3*xrr*lamr**bm_r / am_r<a name='2750'>
              nrten(k) = (xnr-nr1d(k)*rho(k))*odts*orho<a name='2751'>
           endif<a name='2752'>
         else<a name='2753'>
           qrten(k) = -qr1d(k)*odts<a name='2754'>
           nrten(k) = -nr1d(k)*odts<a name='2755'>
         endif<a name='2756'>
<a name='2757'>
<font color=#447700>!..Snow tendency<a name='2758'></font>
         qsten(k) = qsten(k) + (prs_iau(k) + prs_sde(k) &amp;<a name='2759'>
                      + prs_sci(k) + prs_scw(k) + prs_rcs(k) &amp;<a name='2760'>
                      + prs_ide(k) - prs_ihm(k) - prr_sml(k)) &amp;<a name='2761'>
                      * orho<a name='2762'>
<a name='2763'>
<font color=#447700>!..Graupel tendency<a name='2764'></font>
         qgten(k) = qgten(k) + (prg_scw(k) + prg_rfz(k) &amp;<a name='2765'>
                      + prg_gde(k) + prg_rcg(k) + prg_gcw(k) &amp;<a name='2766'>
                      + prg_rci(k) + prg_rcs(k) - prg_ihm(k) &amp;<a name='2767'>
                      - prr_gml(k)) &amp;<a name='2768'>
                      * orho<a name='2769'>
<a name='2770'>
<font color=#447700>!..Temperature tendency<a name='2771'></font>
         if (temp(k).lt.T_0) then<a name='2772'>
          tten(k) = tten(k) &amp;<a name='2773'>
                    + ( lsub*ocp(k)*(pri_inu(k) + pri_ide(k) &amp;<a name='2774'>
                                     + prs_ide(k) + prs_sde(k) &amp;<a name='2775'>
                                     + prg_gde(k) + pri_iha(k)) &amp;<a name='2776'>
                     + lfus2*ocp(k)*(pri_wfz(k) + pri_rfz(k) &amp;<a name='2777'>
                                     + prg_rfz(k) + prs_scw(k) &amp;<a name='2778'>
                                     + prg_scw(k) + prg_gcw(k) &amp;<a name='2779'>
                                     + prg_rcs(k) + prs_rcs(k) &amp;<a name='2780'>
                                     + prr_rci(k) + prg_rcg(k)) &amp;<a name='2781'>
                       )*orho * (1-IFDRY)<a name='2782'>
         else<a name='2783'>
          tten(k) = tten(k) &amp;<a name='2784'>
                    + ( lfus*ocp(k)*(-prr_sml(k) - prr_gml(k) &amp;<a name='2785'>
                                     - prr_rcg(k) - prr_rcs(k)) &amp;<a name='2786'>
                      + lsub*ocp(k)*(prs_sde(k) + prg_gde(k)) &amp;<a name='2787'>
                       )*orho * (1-IFDRY)<a name='2788'>
         endif<a name='2789'>
<a name='2790'>
      enddo<a name='2791'>
<a name='2792'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2793'></font>
<font color=#447700>!..Update variables for TAU+1 before condensation &amp; sedimention.<a name='2794'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2795'></font>
      do k = kts, kte<a name='2796'>
         temp(k) = t1d(k) + DT*tten(k)<a name='2797'>
         otemp = 1./temp(k)<a name='2798'>
         tempc = temp(k) - 273.15<a name='2799'>
         qv(k) = MAX(1.E-10, qv1d(k) + DT*qvten(k))<a name='2800'>
         rho(k) = 0.622*pres(k)/(R*temp(k)*(qv(k)+0.622))<a name='2801'>
         rhof(k) = SQRT(RHO_NOT/rho(k))<a name='2802'>
         rhof2(k) = SQRT(rhof(k))<a name='2803'>
         qvs(k) = <A href='../../html_code/share/dfi.F.html#RSLF'>rslf</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSLF_2">(pres(k), temp(k))<a name='2804'>
         ssatw(k) = qv(k)/qvs(k) - 1.<a name='2805'>
         if (abs(ssatw(k)).lt. eps) ssatw(k) = 0.0<a name='2806'>
         diffu(k) = 2.11E-5*(temp(k)/273.15)**1.94 * (101325./pres(k))<a name='2807'>
         if (tempc .ge. 0.0) then<a name='2808'>
            visco(k) = (1.718+0.0049*tempc)*1.0E-5<a name='2809'>
         else<a name='2810'>
            visco(k) = (1.718+0.0049*tempc-1.2E-5*tempc*tempc)*1.0E-5<a name='2811'>
         endif<a name='2812'>
         vsc2(k) = SQRT(rho(k)/visco(k))<a name='2813'>
         lvap(k) = lvap0 + (2106.0 - 4218.0)*tempc<a name='2814'>
         tcond(k) = (5.69 + 0.0168*tempc)*1.0E-5 * 418.936<a name='2815'>
         ocp(k) = 1./(Cp*(1.+0.887*qv(k)))<a name='2816'>
         lvt2(k)=lvap(k)*lvap(k)*ocp(k)*oRv*otemp*otemp<a name='2817'>
<a name='2818'>
         nwfa(k) = MAX(11.1E6, (nwfa1d(k) + nwfaten(k)*DT)*rho(k))<a name='2819'>
<a name='2820'>
         if ((qc1d(k) + qcten(k)*DT) .gt. R1) then<a name='2821'>
            rc(k) = (qc1d(k) + qcten(k)*DT)*rho(k)<a name='2822'>
            nc(k) = MAX(2., (nc1d(k) + ncten(k)*DT)*rho(k))<a name='2823'>
            if (.NOT. is_aerosol_aware) nc(k) = Nt_c<a name='2824'>
            L_qc(k) = .true.<a name='2825'>
         else<a name='2826'>
            rc(k) = R1<a name='2827'>
            nc(k) = 2.<a name='2828'>
            L_qc(k) = .false.<a name='2829'>
         endif<a name='2830'>
<a name='2831'>
         if ((qi1d(k) + qiten(k)*DT) .gt. R1) then<a name='2832'>
            ri(k) = (qi1d(k) + qiten(k)*DT)*rho(k)<a name='2833'>
            ni(k) = MAX(R2, (ni1d(k) + niten(k)*DT)*rho(k))<a name='2834'>
            L_qi(k) = .true. <a name='2835'>
         else<a name='2836'>
            ri(k) = R1<a name='2837'>
            ni(k) = R2<a name='2838'>
            L_qi(k) = .false.<a name='2839'>
         endif<a name='2840'>
<a name='2841'>
         if ((qr1d(k) + qrten(k)*DT) .gt. R1) then<a name='2842'>
            rr(k) = (qr1d(k) + qrten(k)*DT)*rho(k)<a name='2843'>
            nr(k) = MAX(R2, (nr1d(k) + nrten(k)*DT)*rho(k))<a name='2844'>
            L_qr(k) = .true.<a name='2845'>
            lamr = (am_r*crg(3)*org2*nr(k)/rr(k))**obmr<a name='2846'>
            mvd_r(k) = (3.0 + mu_r + 0.672) / lamr<a name='2847'>
            if (mvd_r(k) .gt. 2.5E-3) then<a name='2848'>
               mvd_r(k) = 2.5E-3<a name='2849'>
               lamr = (3.0 + mu_r + 0.672) / mvd_r(k)<a name='2850'>
               nr(k) = crg(2)*org3*rr(k)*lamr**bm_r / am_r<a name='2851'>
            elseif (mvd_r(k) .lt. D0r*0.75) then<a name='2852'>
               mvd_r(k) = D0r*0.75<a name='2853'>
               lamr = (3.0 + mu_r + 0.672) / mvd_r(k)<a name='2854'>
               nr(k) = crg(2)*org3*rr(k)*lamr**bm_r / am_r<a name='2855'>
            endif<a name='2856'>
         else<a name='2857'>
            rr(k) = R1<a name='2858'>
            nr(k) = R2<a name='2859'>
            L_qr(k) = .false.<a name='2860'>
         endif<a name='2861'>
               <a name='2862'>
         if ((qs1d(k) + qsten(k)*DT) .gt. R1) then<a name='2863'>
            rs(k) = (qs1d(k) + qsten(k)*DT)*rho(k)<a name='2864'>
            L_qs(k) = .true.<a name='2865'>
         else<a name='2866'>
            rs(k) = R1<a name='2867'>
            L_qs(k) = .false.<a name='2868'>
         endif<a name='2869'>
<a name='2870'>
         if ((qg1d(k) + qgten(k)*DT) .gt. R1) then<a name='2871'>
            rg(k) = (qg1d(k) + qgten(k)*DT)*rho(k)<a name='2872'>
            L_qg(k) = .true.<a name='2873'>
         else<a name='2874'>
            rg(k) = R1<a name='2875'>
            L_qg(k) = .false.<a name='2876'>
         endif<a name='2877'>
      enddo<a name='2878'>
<a name='2879'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2880'></font>
<font color=#447700>!..With tendency-updated mixing ratios, recalculate snow moments and<a name='2881'></font>
<font color=#447700>!.. intercepts/slopes of graupel and rain.<a name='2882'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2883'></font>
      if (.not. iiwarm) then<a name='2884'>
      do k = kts, kte<a name='2885'>
         smo2(k) = 0.<a name='2886'>
         smob(k) = 0.<a name='2887'>
         smoc(k) = 0.<a name='2888'>
         smod(k) = 0.<a name='2889'>
      enddo<a name='2890'>
      do k = kts, kte<a name='2891'>
         if (.not. L_qs(k)) CYCLE<a name='2892'>
         tc0 = MIN(-0.1, temp(k)-273.15)<a name='2893'>
         smob(k) = rs(k)*oams<a name='2894'>
<a name='2895'>
<font color=#447700>!..All other moments based on reference, 2nd moment.  If bm_s.ne.2,<a name='2896'></font>
<font color=#447700>!.. then we must compute actual 2nd moment and use as reference.<a name='2897'></font>
         if (bm_s.gt.(2.0-1.e-3) .and. bm_s.lt.(2.0+1.e-3)) then<a name='2898'>
            smo2(k) = smob(k)<a name='2899'>
         else<a name='2900'>
            loga_ = sa(1) + sa(2)*tc0 + sa(3)*bm_s &amp;<a name='2901'>
               + sa(4)*tc0*bm_s + sa(5)*tc0*tc0 &amp;<a name='2902'>
               + sa(6)*bm_s*bm_s + sa(7)*tc0*tc0*bm_s &amp;<a name='2903'>
               + sa(8)*tc0*bm_s*bm_s + sa(9)*tc0*tc0*tc0 &amp;<a name='2904'>
               + sa(10)*bm_s*bm_s*bm_s<a name='2905'>
            a_ = 10.0**loga_<a name='2906'>
            b_ = sb(1) + sb(2)*tc0 + sb(3)*bm_s &amp;<a name='2907'>
               + sb(4)*tc0*bm_s + sb(5)*tc0*tc0 &amp;<a name='2908'>
               + sb(6)*bm_s*bm_s + sb(7)*tc0*tc0*bm_s &amp;<a name='2909'>
               + sb(8)*tc0*bm_s*bm_s + sb(9)*tc0*tc0*tc0 &amp;<a name='2910'>
               + sb(10)*bm_s*bm_s*bm_s<a name='2911'>
            smo2(k) = (smob(k)/a_)**(1./b_)<a name='2912'>
         endif<a name='2913'>
<a name='2914'>
<font color=#447700>!..Calculate bm_s+1 (th) moment.  Useful for diameter calcs.<a name='2915'></font>
         loga_ = sa(1) + sa(2)*tc0 + sa(3)*cse(1) &amp;<a name='2916'>
               + sa(4)*tc0*cse(1) + sa(5)*tc0*tc0 &amp;<a name='2917'>
               + sa(6)*cse(1)*cse(1) + sa(7)*tc0*tc0*cse(1) &amp;<a name='2918'>
               + sa(8)*tc0*cse(1)*cse(1) + sa(9)*tc0*tc0*tc0 &amp;<a name='2919'>
               + sa(10)*cse(1)*cse(1)*cse(1)<a name='2920'>
         a_ = 10.0**loga_<a name='2921'>
         b_ = sb(1)+ sb(2)*tc0 + sb(3)*cse(1) + sb(4)*tc0*cse(1) &amp;<a name='2922'>
              + sb(5)*tc0*tc0 + sb(6)*cse(1)*cse(1) &amp;<a name='2923'>
              + sb(7)*tc0*tc0*cse(1) + sb(8)*tc0*cse(1)*cse(1) &amp;<a name='2924'>
              + sb(9)*tc0*tc0*tc0 + sb(10)*cse(1)*cse(1)*cse(1)<a name='2925'>
         smoc(k) = a_ * smo2(k)**b_<a name='2926'>
<a name='2927'>
<font color=#447700>!..Calculate bm_s+bv_s (th) moment.  Useful for sedimentation.<a name='2928'></font>
         loga_ = sa(1) + sa(2)*tc0 + sa(3)*cse(14) &amp;<a name='2929'>
               + sa(4)*tc0*cse(14) + sa(5)*tc0*tc0 &amp;<a name='2930'>
               + sa(6)*cse(14)*cse(14) + sa(7)*tc0*tc0*cse(14) &amp;<a name='2931'>
               + sa(8)*tc0*cse(14)*cse(14) + sa(9)*tc0*tc0*tc0 &amp;<a name='2932'>
               + sa(10)*cse(14)*cse(14)*cse(14)<a name='2933'>
         a_ = 10.0**loga_<a name='2934'>
         b_ = sb(1)+ sb(2)*tc0 + sb(3)*cse(14) + sb(4)*tc0*cse(14) &amp;<a name='2935'>
              + sb(5)*tc0*tc0 + sb(6)*cse(14)*cse(14) &amp;<a name='2936'>
              + sb(7)*tc0*tc0*cse(14) + sb(8)*tc0*cse(14)*cse(14) &amp;<a name='2937'>
              + sb(9)*tc0*tc0*tc0 + sb(10)*cse(14)*cse(14)*cse(14)<a name='2938'>
         smod(k) = a_ * smo2(k)**b_<a name='2939'>
      enddo<a name='2940'>
<a name='2941'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2942'></font>
<font color=#447700>!..Calculate y-intercept, slope values for graupel.<a name='2943'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2944'></font>
      N0_min = gonv_max<a name='2945'>
      k_0 = kts<a name='2946'>
      do k = kte, kts, -1<a name='2947'>
         if (temp(k).ge.270.65) k_0 = MAX(k_0, k)<a name='2948'>
      enddo<a name='2949'>
      do k = kte, kts, -1<a name='2950'>
         if (k.gt.k_0 .and. L_qr(k) .and. mvd_r(k).gt.100.E-6) then<a name='2951'>
            xslw1 = 4.01 + alog10(mvd_r(k))<a name='2952'>
         else<a name='2953'>
            xslw1 = 0.01<a name='2954'>
         endif<a name='2955'>
         ygra1 = 4.31 + alog10(max(5.E-5, rg(k)))<a name='2956'>
         zans1 = 3.1 + (100./(300.*xslw1*ygra1/(10./xslw1+1.+0.25*ygra1)+30.+10.*ygra1))<a name='2957'>
         N0_exp = 10.**(zans1)<a name='2958'>
         N0_exp = MAX(DBLE(gonv_min), MIN(N0_exp, DBLE(gonv_max)))<a name='2959'>
         N0_min = MIN(N0_exp, N0_min)<a name='2960'>
         N0_exp = N0_min<a name='2961'>
         lam_exp = (N0_exp*am_g*cgg(1)/rg(k))**oge1<a name='2962'>
         lamg = lam_exp * (cgg(3)*ogg2*ogg1)**obmg<a name='2963'>
         ilamg(k) = 1./lamg<a name='2964'>
         N0_g(k) = N0_exp/(cgg(2)*lam_exp) * lamg**cge(2)<a name='2965'>
      enddo<a name='2966'>
<a name='2967'>
      endif<a name='2968'>
<a name='2969'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2970'></font>
<font color=#447700>!..Calculate y-intercept, slope values for rain.<a name='2971'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2972'></font>
      do k = kte, kts, -1<a name='2973'>
         lamr = (am_r*crg(3)*org2*nr(k)/rr(k))**obmr<a name='2974'>
         ilamr(k) = 1./lamr<a name='2975'>
         mvd_r(k) = (3.0 + mu_r + 0.672) / lamr<a name='2976'>
         N0_r(k) = nr(k)*org2*lamr**cre(2)<a name='2977'>
      enddo<a name='2978'>
<a name='2979'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2980'></font>
<font color=#447700>!..Cloud water condensation and evaporation.  Nucleate cloud droplets<a name='2981'></font>
<font color=#447700>!.. using explicit CCN aerosols with hygroscopicity like sulfates using<a name='2982'></font>
<font color=#447700>!.. parcel model lookup table results provided by T. Eidhammer.  Evap<a name='2983'></font>
<font color=#447700>!.. drops using calculation of max drop size capable of evaporating in<a name='2984'></font>
<font color=#447700>!.. single timestep and explicit number of drops smaller than Dc_star<a name='2985'></font>
<font color=#447700>!.. from lookup table.<a name='2986'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2987'></font>
      do k = kts, kte<a name='2988'>
         orho = 1./rho(k)<a name='2989'>
         if ( (ssatw(k).gt. eps) .or. (ssatw(k).lt. -eps .and. &amp;<a name='2990'>
                   L_qc(k)) ) then<a name='2991'>
          clap = (qv(k)-qvs(k))/(1. + lvt2(k)*qvs(k))<a name='2992'>
          do n = 1, 3<a name='2993'>
             fcd = qvs(k)* EXP(lvt2(k)*clap) - qv(k) + clap<a name='2994'>
             dfcd = qvs(k)*lvt2(k)* EXP(lvt2(k)*clap) + 1.<a name='2995'>
             clap = clap - fcd/dfcd<a name='2996'>
          enddo<a name='2997'>
          xrc = rc(k) + clap*rho(k)<a name='2998'>
          xnc = 0.<a name='2999'>
          if (xrc.gt. R1) then<a name='3000'>
           prw_vcd(k) = clap*odt<a name='3001'>
<font color=#447700>!+---+-----------------------------------------------------------------+ !  DROPLET NUCLEATION<a name='3002'></font>
           if (clap .gt. eps) then<a name='3003'>
            if (is_aerosol_aware) then<a name='3004'>
               xnc = MAX(2., activ_ncloud(temp(k), w1d(k), nwfa(k)))<a name='3005'>
            else<a name='3006'>
               xnc = Nt_c<a name='3007'>
            endif<a name='3008'>
            pnc_wcd(k) = 0.5*(xnc-nc(k) + abs(xnc-nc(k)))*odts*orho<a name='3009'>
<a name='3010'>
<font color=#447700>!+---+-----------------------------------------------------------------+ !  EVAPORATION<a name='3011'></font>
           elseif (clap .lt. -eps .AND. ssatw(k).lt.-1.E-6 .AND. is_aerosol_aware) then<a name='3012'>
            tempc = temp(k) - 273.15<a name='3013'>
            otemp = 1./temp(k)<a name='3014'>
            rvs = rho(k)*qvs(k)<a name='3015'>
            rvs_p = rvs*otemp*(lvap(k)*otemp*oRv - 1.)<a name='3016'>
            rvs_pp = rvs * ( otemp*(lvap(k)*otemp*oRv - 1.) &amp;<a name='3017'>
                            *otemp*(lvap(k)*otemp*oRv - 1.) &amp;<a name='3018'>
                            + (-2.*lvap(k)*otemp*otemp*otemp*oRv) &amp;<a name='3019'>
                            + otemp*otemp)<a name='3020'>
            gamsc = lvap(k)*diffu(k)/tcond(k) * rvs_p<a name='3021'>
            alphsc = 0.5*(gamsc/(1.+gamsc))*(gamsc/(1.+gamsc)) &amp;<a name='3022'>
                       * rvs_pp/rvs_p * rvs/rvs_p<a name='3023'>
            alphsc = MAX(1.E-9, alphsc)<a name='3024'>
            xsat = ssatw(k)<a name='3025'>
            if (abs(xsat).lt. 1.E-9) xsat=0.<a name='3026'>
            t1_evap = 2.*PI*( 1.0 - alphsc*xsat  &amp;<a name='3027'>
                   + 2.*alphsc*alphsc*xsat*xsat  &amp;<a name='3028'>
                   - 5.*alphsc*alphsc*alphsc*xsat*xsat*xsat ) &amp;<a name='3029'>
                   / (1.+gamsc)<a name='3030'>
<a name='3031'>
            Dc_star = DSQRT(-2.D0*DT * t1_evap/(2.*PI) &amp;<a name='3032'>
                    * 4.*diffu(k)*ssatw(k)*rvs/rho_w)<a name='3033'>
            idx_d = MAX(1, MIN(INT(1.E6*Dc_star), nbc))<a name='3034'>
<a name='3035'>
            idx_n = NINT(1.0 + FLOAT(nbc) * DLOG(nc(k)/t_Nc(1)) / nic1)<a name='3036'>
            idx_n = MAX(1, MIN(idx_n, nbc))<a name='3037'>
<a name='3038'>
<font color=#447700>!..Cloud water lookup table index.<a name='3039'></font>
            if (rc(k).gt. r_c(1)) then<a name='3040'>
             nic = NINT(ALOG10(rc(k)))<a name='3041'>
             do nn = nic-1, nic+1<a name='3042'>
                n = nn<a name='3043'>
                if ( (rc(k)/10.**nn).ge.1.0 .and. &amp;<a name='3044'>
                     (rc(k)/10.**nn).lt.10.0) goto 159<a name='3045'>
             enddo<a name='3046'>
 159         continue<a name='3047'>
             idx_c = INT(rc(k)/10.**n) + 10*(n-nic2) - (n-nic2)<a name='3048'>
             idx_c = MAX(1, MIN(idx_c, ntb_c))<a name='3049'>
            else<a name='3050'>
             idx_c = 1<a name='3051'>
            endif<a name='3052'>
<a name='3053'>
           <font color=#447700>!prw_vcd(k) = MAX(DBLE(-rc(k)*orho*odt),                     &amp;<a name='3054'></font>
           <font color=#447700>!           -tpc_wev(idx_d, idx_c, idx_n)*orho*odt)<a name='3055'></font>
            prw_vcd(k) = MAX(DBLE(-rc(k)*0.99*orho*odt), prw_vcd(k))<a name='3056'>
            pnc_wcd(k) = MAX(DBLE(-nc(k)*0.99*orho*odt),                &amp;<a name='3057'>
                       -tnc_wev(idx_d, idx_c, idx_n)*orho*odt)<a name='3058'>
<a name='3059'>
           endif<a name='3060'>
          else<a name='3061'>
           prw_vcd(k) = -rc(k)*orho*odt<a name='3062'>
           pnc_wcd(k) = -nc(k)*orho*odt<a name='3063'>
          endif<a name='3064'>
<a name='3065'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3066'></font>
<a name='3067'>
          qvten(k) = qvten(k) - prw_vcd(k)<a name='3068'>
          qcten(k) = qcten(k) + prw_vcd(k)<a name='3069'>
          ncten(k) = ncten(k) + pnc_wcd(k)<a name='3070'>
          nwfaten(k) = nwfaten(k) - pnc_wcd(k)<a name='3071'>
          tten(k) = tten(k) + lvap(k)*ocp(k)*prw_vcd(k)*(1-IFDRY)<a name='3072'>
          rc(k) = MAX(R1, (qc1d(k) + DT*qcten(k))*rho(k))<a name='3073'>
          nc(k) = MAX(2., (nc1d(k) + DT*ncten(k))*rho(k))<a name='3074'>
          if (.NOT. is_aerosol_aware) nc(k) = Nt_c<a name='3075'>
          qv(k) = MAX(1.E-10, qv1d(k) + DT*qvten(k))<a name='3076'>
          temp(k) = t1d(k) + DT*tten(k)<a name='3077'>
          rho(k) = 0.622*pres(k)/(R*temp(k)*(qv(k)+0.622))<a name='3078'>
          qvs(k) = <A href='../../html_code/share/dfi.F.html#RSLF'>rslf</A><A href='../../html_code/phys/module_mp_thompson.F.html#MP_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSLF_3">(pres(k), temp(k))<a name='3079'>
          ssatw(k) = qv(k)/qvs(k) - 1.<a name='3080'>
         endif<a name='3081'>
      enddo<a name='3082'>
<a name='3083'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3084'></font>
<font color=#447700>!.. If still subsaturated, allow rain to evaporate, following<a name='3085'></font>
<font color=#447700>!.. Srivastava &amp; Coen (1992).<a name='3086'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3087'></font>
      do k = kts, kte<a name='3088'>
         if ( (ssatw(k).lt. -eps) .and. L_qr(k) &amp;<a name='3089'>
                     .and. (.not.(prw_vcd(k).gt. 0.)) ) then<a name='3090'>
          tempc = temp(k) - 273.15<a name='3091'>
          otemp = 1./temp(k)<a name='3092'>
          orho = 1./rho(k)<a name='3093'>
          rhof(k) = SQRT(RHO_NOT*orho)<a name='3094'>
          rhof2(k) = SQRT(rhof(k))<a name='3095'>
          diffu(k) = 2.11E-5*(temp(k)/273.15)**1.94 * (101325./pres(k))<a name='3096'>
          if (tempc .ge. 0.0) then<a name='3097'>
             visco(k) = (1.718+0.0049*tempc)*1.0E-5<a name='3098'>
          else<a name='3099'>
             visco(k) = (1.718+0.0049*tempc-1.2E-5*tempc*tempc)*1.0E-5<a name='3100'>
          endif<a name='3101'>
          vsc2(k) = SQRT(rho(k)/visco(k))<a name='3102'>
          lvap(k) = lvap0 + (2106.0 - 4218.0)*tempc<a name='3103'>
          tcond(k) = (5.69 + 0.0168*tempc)*1.0E-5 * 418.936<a name='3104'>
          ocp(k) = 1./(Cp*(1.+0.887*qv(k)))<a name='3105'>
<a name='3106'>
          rvs = rho(k)*qvs(k)<a name='3107'>
          rvs_p = rvs*otemp*(lvap(k)*otemp*oRv - 1.)<a name='3108'>
          rvs_pp = rvs * ( otemp*(lvap(k)*otemp*oRv - 1.) &amp;<a name='3109'>
                          *otemp*(lvap(k)*otemp*oRv - 1.) &amp;<a name='3110'>
                          + (-2.*lvap(k)*otemp*otemp*otemp*oRv) &amp;<a name='3111'>
                          + otemp*otemp)<a name='3112'>
          gamsc = lvap(k)*diffu(k)/tcond(k) * rvs_p<a name='3113'>
          alphsc = 0.5*(gamsc/(1.+gamsc))*(gamsc/(1.+gamsc)) &amp;<a name='3114'>
                     * rvs_pp/rvs_p * rvs/rvs_p<a name='3115'>
          alphsc = MAX(1.E-9, alphsc)<a name='3116'>
          xsat   = MIN(-1.E-9, ssatw(k))<a name='3117'>
          t1_evap = 2.*PI*( 1.0 - alphsc*xsat  &amp;<a name='3118'>
                 + 2.*alphsc*alphsc*xsat*xsat  &amp;<a name='3119'>
                 - 5.*alphsc*alphsc*alphsc*xsat*xsat*xsat ) &amp;<a name='3120'>
                 / (1.+gamsc)<a name='3121'>
<a name='3122'>
          lamr = 1./ilamr(k)<a name='3123'>
<font color=#447700>!..Rapidly eliminate near zero values when low humidity (&lt;95%)<a name='3124'></font>
          if (qv(k)/qvs(k) .lt. 0.95 .AND. rr(k)*orho.le.1.E-8) then<a name='3125'>
          prv_rev(k) = rr(k)*orho*odts<a name='3126'>
          else<a name='3127'>
          prv_rev(k) = t1_evap*diffu(k)*(-ssatw(k))*N0_r(k)*rvs &amp;<a name='3128'>
              * (t1_qr_ev*ilamr(k)**cre(10) &amp;<a name='3129'>
              + t2_qr_ev*vsc2(k)*rhof2(k)*((lamr+0.5*fv_r)**(-cre(11))))<a name='3130'>
          rate_max = MIN((rr(k)*orho*odts), (qvs(k)-qv(k))*odts)<a name='3131'>
          prv_rev(k) = MIN(DBLE(rate_max), prv_rev(k)*orho)<a name='3132'>
<a name='3133'>
<font color=#447700>!..TEST: G. Thompson  10 May 2013<a name='3134'></font>
<font color=#447700>!..Reduce the rain evaporation in same places as melting graupel occurs. <a name='3135'></font>
<font color=#447700>!..Rationale: falling and simultaneous melting graupel in subsaturated<a name='3136'></font>
<font color=#447700>!..regions will not melt as fast because particle temperature stays<a name='3137'></font>
<font color=#447700>!..at 0C.  Also not much shedding of the water from the graupel so<a name='3138'></font>
<font color=#447700>!..likely that the water-coated graupel evaporating much slower than<a name='3139'></font>
<font color=#447700>!..if the water was immediately shed off.<a name='3140'></font>
          IF (prr_gml(k).gt.0.0) THEN<a name='3141'>
             eva_factor = MIN(1.0, 0.01+(0.99-0.01)*(tempc/20.0))<a name='3142'>
             prv_rev(k) = prv_rev(k)*eva_factor<a name='3143'>
          ENDIF<a name='3144'>
          endif<a name='3145'>
<a name='3146'>
          pnr_rev(k) = MIN(DBLE(nr(k)*0.99*orho*odts),                  &amp;   <font color=#447700>! RAIN2M<a name='3147'></font>
                       prv_rev(k) * nr(k)/rr(k))<a name='3148'>
<a name='3149'>
          qrten(k) = qrten(k) - prv_rev(k)<a name='3150'>
          qvten(k) = qvten(k) + prv_rev(k)<a name='3151'>
          nrten(k) = nrten(k) - pnr_rev(k)<a name='3152'>
          nwfaten(k) = nwfaten(k) + pnr_rev(k)<a name='3153'>
          tten(k) = tten(k) - lvap(k)*ocp(k)*prv_rev(k)*(1-IFDRY)<a name='3154'>
<a name='3155'>
          rr(k) = MAX(R1, (qr1d(k) + DT*qrten(k))*rho(k))<a name='3156'>
          qv(k) = MAX(1.E-10, qv1d(k) + DT*qvten(k))<a name='3157'>
          nr(k) = MAX(R2, (nr1d(k) + DT*nrten(k))*rho(k))<a name='3158'>
          temp(k) = t1d(k) + DT*tten(k)<a name='3159'>
          rho(k) = 0.622*pres(k)/(R*temp(k)*(qv(k)+0.622))<a name='3160'>
         endif<a name='3161'>
      enddo<a name='3162'>
#if ( WRF_CHEM == 1 )<a name='3163'>
      do k = kts, kte<a name='3164'>
         evapprod(k) = prv_rev(k) - (min(zeroD0,prs_sde(k)) + &amp;<a name='3165'>
                                     min(zeroD0,prg_gde(k)))<a name='3166'>
         rainprod(k) = prr_wau(k) + prr_rcw(k) + prs_scw(k) + &amp;<a name='3167'>
                                    prg_scw(k) + prs_iau(k) + &amp;<a name='3168'>
                                    prg_gcw(k) + prs_sci(k) + &amp;<a name='3169'>
                                    pri_rci(k)<a name='3170'>
      enddo<a name='3171'>
#endif<a name='3172'>
<a name='3173'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3174'></font>
<font color=#447700>!..Find max terminal fallspeed (distribution mass-weighted mean<a name='3175'></font>
<font color=#447700>!.. velocity) and use it to determine if we need to split the timestep<a name='3176'></font>
<font color=#447700>!.. (var nstep&gt;1).  Either way, only bother to do sedimentation below<a name='3177'></font>
<font color=#447700>!.. 1st level that contains any sedimenting particles (k=ksed1 on down).<a name='3178'></font>
<font color=#447700>!.. New in v3.0+ is computing separate for rain, ice, snow, and<a name='3179'></font>
<font color=#447700>!.. graupel species thus making code faster with credit to J. Schmidt.<a name='3180'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3181'></font>
      nstep = 0<a name='3182'>
      onstep(:) = 1.0<a name='3183'>
      ksed1(:) = 1<a name='3184'>
      do k = kte+1, kts, -1<a name='3185'>
         vtrk(k) = 0.<a name='3186'>
         vtnrk(k) = 0.<a name='3187'>
         vtik(k) = 0.<a name='3188'>
         vtnik(k) = 0.<a name='3189'>
         vtsk(k) = 0.<a name='3190'>
         vtgk(k) = 0.<a name='3191'>
         vtck(k) = 0.<a name='3192'>
         vtnck(k) = 0.<a name='3193'>
      enddo<a name='3194'>
      do k = kte, kts, -1<a name='3195'>
         vtr = 0.<a name='3196'>
         rhof(k) = SQRT(RHO_NOT/rho(k))<a name='3197'>
<a name='3198'>
         if (rr(k).gt. R1) then<a name='3199'>
          lamr = (am_r*crg(3)*org2*nr(k)/rr(k))**obmr<a name='3200'>
          vtr = rhof(k)*av_r*crg(6)*org3 * lamr**cre(3)                 &amp;<a name='3201'>
                      *((lamr+fv_r)**(-cre(6)))<a name='3202'>
          vtrk(k) = vtr<a name='3203'>
<font color=#447700>! First below is technically correct:<a name='3204'></font>
<font color=#447700>!         vtr = rhof(k)*av_r*crg(5)*org2 * lamr**cre(2)                 &amp;<a name='3205'></font>
<font color=#447700>!                     *((lamr+fv_r)**(-cre(5)))<a name='3206'></font>
<font color=#447700>! Test: make number fall faster (but still slower than mass)<a name='3207'></font>
<font color=#447700>! Goal: less prominent size sorting<a name='3208'></font>
          vtr = rhof(k)*av_r*crg(7)/crg(12) * lamr**cre(12)             &amp;<a name='3209'>
                      *((lamr+fv_r)**(-cre(7)))<a name='3210'>
          vtnrk(k) = vtr<a name='3211'>
         else<a name='3212'>
          vtrk(k) = vtrk(k+1)<a name='3213'>
          vtnrk(k) = vtnrk(k+1)<a name='3214'>
         endif<a name='3215'>
<a name='3216'>
         if (MAX(vtrk(k),vtnrk(k)) .gt. 1.E-3) then<a name='3217'>
            ksed1(1) = MAX(ksed1(1), k)<a name='3218'>
            delta_tp = dzq(k)/(MAX(vtrk(k),vtnrk(k)))<a name='3219'>
            nstep = MAX(nstep, INT(DT/delta_tp + 1.))<a name='3220'>
         endif<a name='3221'>
      enddo<a name='3222'>
      if (ksed1(1) .eq. kte) ksed1(1) = kte-1<a name='3223'>
      if (nstep .gt. 0) onstep(1) = 1./REAL(nstep)<a name='3224'>
<a name='3225'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3226'></font>
<a name='3227'>
      hgt_agl = 0.<a name='3228'>
      do k = kts, kte-1<a name='3229'>
         if (rc(k) .gt. R2) ksed1(5) = k<a name='3230'>
         hgt_agl = hgt_agl + dzq(k)<a name='3231'>
         if (hgt_agl .gt. 500.0) goto 151<a name='3232'>
      enddo<a name='3233'>
 151  continue<a name='3234'>
<a name='3235'>
      do k = ksed1(5), kts, -1<a name='3236'>
         vtc = 0.<a name='3237'>
         if (rc(k) .gt. R1 .and. w1d(k) .lt. 1.E-1) then<a name='3238'>
          nu_c = MIN(15, NINT(1000.E6/nc(k)) + 2)<a name='3239'>
          lamc = (nc(k)*am_r*ccg(2,nu_c)*ocg1(nu_c)/rc(k))**obmr<a name='3240'>
          ilamc = 1./lamc<a name='3241'>
          vtc = rhof(k)*av_c*ccg(5,nu_c)*ocg2(nu_c) * ilamc**bv_c<a name='3242'>
          vtck(k) = vtc<a name='3243'>
          vtc = rhof(k)*av_c*ccg(4,nu_c)*ocg1(nu_c) * ilamc**bv_c<a name='3244'>
          vtnck(k) = vtc<a name='3245'>
         endif<a name='3246'>
      enddo<a name='3247'>
<a name='3248'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3249'></font>
<a name='3250'>
      if (.not. iiwarm) then<a name='3251'>
<a name='3252'>
       nstep = 0<a name='3253'>
       do k = kte, kts, -1<a name='3254'>
          vti = 0.<a name='3255'>
<a name='3256'>
          if (ri(k).gt. R1) then<a name='3257'>
           lami = (am_i*cig(2)*oig1*ni(k)/ri(k))**obmi<a name='3258'>
           ilami = 1./lami<a name='3259'>
           vti = rhof(k)*av_i*cig(3)*oig2 * ilami**bv_i<a name='3260'>
           vtik(k) = vti<a name='3261'>
<font color=#447700>! First below is technically correct:<a name='3262'></font>
<font color=#447700>!          vti = rhof(k)*av_i*cig(4)*oig1 * ilami**bv_i<a name='3263'></font>
<font color=#447700>! Goal: less prominent size sorting<a name='3264'></font>
           vti = rhof(k)*av_i*cig(6)/cig(7) * ilami**bv_i<a name='3265'>
           vtnik(k) = vti<a name='3266'>
          else<a name='3267'>
           vtik(k) = vtik(k+1)<a name='3268'>
           vtnik(k) = vtnik(k+1)<a name='3269'>
          endif<a name='3270'>
<a name='3271'>
          if (vtik(k) .gt. 1.E-3) then<a name='3272'>
             ksed1(2) = MAX(ksed1(2), k)<a name='3273'>
             delta_tp = dzq(k)/vtik(k)<a name='3274'>
             nstep = MAX(nstep, INT(DT/delta_tp + 1.))<a name='3275'>
          endif<a name='3276'>
       enddo<a name='3277'>
       if (ksed1(2) .eq. kte) ksed1(2) = kte-1<a name='3278'>
       if (nstep .gt. 0) onstep(2) = 1./REAL(nstep)<a name='3279'>
<a name='3280'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3281'></font>
<a name='3282'>
       nstep = 0<a name='3283'>
       do k = kte, kts, -1<a name='3284'>
          vts = 0.<a name='3285'>
<a name='3286'>
          if (rs(k).gt. R1) then<a name='3287'>
           xDs = smoc(k) / smob(k)<a name='3288'>
           Mrat = 1./xDs<a name='3289'>
           ils1 = 1./(Mrat*Lam0 + fv_s)<a name='3290'>
           ils2 = 1./(Mrat*Lam1 + fv_s)<a name='3291'>
           t1_vts = Kap0*csg(4)*ils1**cse(4)<a name='3292'>
           t2_vts = Kap1*Mrat**mu_s*csg(10)*ils2**cse(10)<a name='3293'>
           ils1 = 1./(Mrat*Lam0)<a name='3294'>
           ils2 = 1./(Mrat*Lam1)<a name='3295'>
           t3_vts = Kap0*csg(1)*ils1**cse(1)<a name='3296'>
           t4_vts = Kap1*Mrat**mu_s*csg(7)*ils2**cse(7)<a name='3297'>
           vts = rhof(k)*av_s * (t1_vts+t2_vts)/(t3_vts+t4_vts)<a name='3298'>
           if (temp(k).gt. (T_0+0.1)) then<a name='3299'>
            vtsk(k) = MAX(vts*vts_boost(k),                             &amp;<a name='3300'>
     &amp;                vts*((vtrk(k)-vts*vts_boost(k))/(temp(k)-T_0)))<a name='3301'>
           else<a name='3302'>
            vtsk(k) = vts*vts_boost(k)<a name='3303'>
           endif<a name='3304'>
          else<a name='3305'>
            vtsk(k) = vtsk(k+1)<a name='3306'>
          endif<a name='3307'>
<a name='3308'>
          if (vtsk(k) .gt. 1.E-3) then<a name='3309'>
             ksed1(3) = MAX(ksed1(3), k)<a name='3310'>
             delta_tp = dzq(k)/vtsk(k)<a name='3311'>
             nstep = MAX(nstep, INT(DT/delta_tp + 1.))<a name='3312'>
          endif<a name='3313'>
       enddo<a name='3314'>
       if (ksed1(3) .eq. kte) ksed1(3) = kte-1<a name='3315'>
       if (nstep .gt. 0) onstep(3) = 1./REAL(nstep)<a name='3316'>
<a name='3317'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3318'></font>
<a name='3319'>
       nstep = 0<a name='3320'>
       do k = kte, kts, -1<a name='3321'>
          vtg = 0.<a name='3322'>
<a name='3323'>
          if (rg(k).gt. R1) then<a name='3324'>
           vtg = rhof(k)*av_g*cgg(6)*ogg3 * ilamg(k)**bv_g<a name='3325'>
           if (temp(k).gt. T_0) then<a name='3326'>
            vtgk(k) = MAX(vtg, vtrk(k))<a name='3327'>
           else<a name='3328'>
            vtgk(k) = vtg<a name='3329'>
           endif<a name='3330'>
          else<a name='3331'>
            vtgk(k) = vtgk(k+1)<a name='3332'>
          endif<a name='3333'>
<a name='3334'>
          if (vtgk(k) .gt. 1.E-3) then<a name='3335'>
             ksed1(4) = MAX(ksed1(4), k)<a name='3336'>
             delta_tp = dzq(k)/vtgk(k)<a name='3337'>
             nstep = MAX(nstep, INT(DT/delta_tp + 1.))<a name='3338'>
          endif<a name='3339'>
       enddo<a name='3340'>
       if (ksed1(4) .eq. kte) ksed1(4) = kte-1<a name='3341'>
       if (nstep .gt. 0) onstep(4) = 1./REAL(nstep)<a name='3342'>
      endif<a name='3343'>
<a name='3344'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3345'></font>
<font color=#447700>!..Sedimentation of mixing ratio is the integral of v(D)*m(D)*N(D)*dD,<a name='3346'></font>
<font color=#447700>!.. whereas neglect m(D) term for number concentration.  Therefore,<a name='3347'></font>
<font color=#447700>!.. cloud ice has proper differential sedimentation.<a name='3348'></font>
<font color=#447700>!.. New in v3.0+ is computing separate for rain, ice, snow, and<a name='3349'></font>
<font color=#447700>!.. graupel species thus making code faster with credit to J. Schmidt.<a name='3350'></font>
<font color=#447700>!.. Bug fix, 2013Nov01 to tendencies using rho(k+1) correction thanks to<a name='3351'></font>
<font color=#447700>!.. Eric Skyllingstad.<a name='3352'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3353'></font>
<a name='3354'>
      nstep = NINT(1./onstep(1))<a name='3355'>
      do n = 1, nstep<a name='3356'>
         do k = kte, kts, -1<a name='3357'>
            sed_r(k) = vtrk(k)*rr(k)<a name='3358'>
            sed_n(k) = vtnrk(k)*nr(k)<a name='3359'>
         enddo<a name='3360'>
         k = kte<a name='3361'>
         odzq = 1./dzq(k)<a name='3362'>
         orho = 1./rho(k)<a name='3363'>
         qrten(k) = qrten(k) - sed_r(k)*odzq*onstep(1)*orho<a name='3364'>
         nrten(k) = nrten(k) - sed_n(k)*odzq*onstep(1)*orho<a name='3365'>
         rr(k) = MAX(R1, rr(k) - sed_r(k)*odzq*DT*onstep(1))<a name='3366'>
         nr(k) = MAX(R2, nr(k) - sed_n(k)*odzq*DT*onstep(1))<a name='3367'>
         do k = ksed1(1), kts, -1<a name='3368'>
            odzq = 1./dzq(k)<a name='3369'>
            orho = 1./rho(k)<a name='3370'>
            qrten(k) = qrten(k) + (sed_r(k+1)-sed_r(k))                 &amp;<a name='3371'>
                                               *odzq*onstep(1)*orho<a name='3372'>
            nrten(k) = nrten(k) + (sed_n(k+1)-sed_n(k))                 &amp;<a name='3373'>
                                               *odzq*onstep(1)*orho<a name='3374'>
            rr(k) = MAX(R1, rr(k) + (sed_r(k+1)-sed_r(k)) &amp;<a name='3375'>
                                           *odzq*DT*onstep(1))<a name='3376'>
            nr(k) = MAX(R2, nr(k) + (sed_n(k+1)-sed_n(k)) &amp;<a name='3377'>
                                           *odzq*DT*onstep(1))<a name='3378'>
         enddo<a name='3379'>
<a name='3380'>
         if (rr(kts).gt.R1*10.) &amp;<a name='3381'>
         pptrain = pptrain + sed_r(kts)*DT*onstep(1)<a name='3382'>
      enddo<a name='3383'>
<a name='3384'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3385'></font>
<a name='3386'>
      do k = kte, kts, -1<a name='3387'>
         sed_c(k) = vtck(k)*rc(k)<a name='3388'>
         sed_n(k) = vtnck(k)*nc(k)<a name='3389'>
      enddo<a name='3390'>
      do k = ksed1(5), kts, -1<a name='3391'>
         odzq = 1./dzq(k)<a name='3392'>
         orho = 1./rho(k)<a name='3393'>
         qcten(k) = qcten(k) + (sed_c(k+1)-sed_c(k)) *odzq*orho<a name='3394'>
         ncten(k) = ncten(k) + (sed_n(k+1)-sed_n(k)) *odzq*orho<a name='3395'>
         rc(k) = MAX(R1, rc(k) + (sed_c(k+1)-sed_c(k)) *odzq*DT)<a name='3396'>
         nc(k) = MAX(10., nc(k) + (sed_n(k+1)-sed_n(k)) *odzq*DT)<a name='3397'>
      enddo<a name='3398'>
<a name='3399'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3400'></font>
<a name='3401'>
      nstep = NINT(1./onstep(2))<a name='3402'>
      do n = 1, nstep<a name='3403'>
         do k = kte, kts, -1<a name='3404'>
            sed_i(k) = vtik(k)*ri(k)<a name='3405'>
            sed_n(k) = vtnik(k)*ni(k)<a name='3406'>
         enddo<a name='3407'>
         k = kte<a name='3408'>
         odzq = 1./dzq(k)<a name='3409'>
         orho = 1./rho(k)<a name='3410'>
         qiten(k) = qiten(k) - sed_i(k)*odzq*onstep(2)*orho<a name='3411'>
         niten(k) = niten(k) - sed_n(k)*odzq*onstep(2)*orho<a name='3412'>
         ri(k) = MAX(R1, ri(k) - sed_i(k)*odzq*DT*onstep(2))<a name='3413'>
         ni(k) = MAX(R2, ni(k) - sed_n(k)*odzq*DT*onstep(2))<a name='3414'>
         do k = ksed1(2), kts, -1<a name='3415'>
            odzq = 1./dzq(k)<a name='3416'>
            orho = 1./rho(k)<a name='3417'>
            qiten(k) = qiten(k) + (sed_i(k+1)-sed_i(k))                 &amp;<a name='3418'>
                                               *odzq*onstep(2)*orho<a name='3419'>
            niten(k) = niten(k) + (sed_n(k+1)-sed_n(k))                 &amp;<a name='3420'>
                                               *odzq*onstep(2)*orho<a name='3421'>
            ri(k) = MAX(R1, ri(k) + (sed_i(k+1)-sed_i(k)) &amp;<a name='3422'>
                                           *odzq*DT*onstep(2))<a name='3423'>
            ni(k) = MAX(R2, ni(k) + (sed_n(k+1)-sed_n(k)) &amp;<a name='3424'>
                                           *odzq*DT*onstep(2))<a name='3425'>
         enddo<a name='3426'>
<a name='3427'>
         if (ri(kts).gt.R1*10.) &amp;<a name='3428'>
         pptice = pptice + sed_i(kts)*DT*onstep(2)<a name='3429'>
      enddo<a name='3430'>
<a name='3431'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3432'></font>
<a name='3433'>
      nstep = NINT(1./onstep(3))<a name='3434'>
      do n = 1, nstep<a name='3435'>
         do k = kte, kts, -1<a name='3436'>
            sed_s(k) = vtsk(k)*rs(k)<a name='3437'>
         enddo<a name='3438'>
         k = kte<a name='3439'>
         odzq = 1./dzq(k)<a name='3440'>
         orho = 1./rho(k)<a name='3441'>
         qsten(k) = qsten(k) - sed_s(k)*odzq*onstep(3)*orho<a name='3442'>
         rs(k) = MAX(R1, rs(k) - sed_s(k)*odzq*DT*onstep(3))<a name='3443'>
         do k = ksed1(3), kts, -1<a name='3444'>
            odzq = 1./dzq(k)<a name='3445'>
            orho = 1./rho(k)<a name='3446'>
            qsten(k) = qsten(k) + (sed_s(k+1)-sed_s(k))                 &amp;<a name='3447'>
                                               *odzq*onstep(3)*orho<a name='3448'>
            rs(k) = MAX(R1, rs(k) + (sed_s(k+1)-sed_s(k)) &amp;<a name='3449'>
                                           *odzq*DT*onstep(3))<a name='3450'>
         enddo<a name='3451'>
<a name='3452'>
         if (rs(kts).gt.R1*10.) &amp;<a name='3453'>
         pptsnow = pptsnow + sed_s(kts)*DT*onstep(3)<a name='3454'>
      enddo<a name='3455'>
<a name='3456'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3457'></font>
<a name='3458'>
      nstep = NINT(1./onstep(4))<a name='3459'>
      do n = 1, nstep<a name='3460'>
         do k = kte, kts, -1<a name='3461'>
            sed_g(k) = vtgk(k)*rg(k)<a name='3462'>
         enddo<a name='3463'>
         k = kte<a name='3464'>
         odzq = 1./dzq(k)<a name='3465'>
         orho = 1./rho(k)<a name='3466'>
         qgten(k) = qgten(k) - sed_g(k)*odzq*onstep(4)*orho<a name='3467'>
         rg(k) = MAX(R1, rg(k) - sed_g(k)*odzq*DT*onstep(4))<a name='3468'>
         do k = ksed1(4), kts, -1<a name='3469'>
            odzq = 1./dzq(k)<a name='3470'>
            orho = 1./rho(k)<a name='3471'>
            qgten(k) = qgten(k) + (sed_g(k+1)-sed_g(k))                 &amp;<a name='3472'>
                                               *odzq*onstep(4)*orho<a name='3473'>
            rg(k) = MAX(R1, rg(k) + (sed_g(k+1)-sed_g(k)) &amp;<a name='3474'>
                                           *odzq*DT*onstep(4))<a name='3475'>
         enddo<a name='3476'>
<a name='3477'>
         if (rg(kts).gt.R1*10.) &amp;<a name='3478'>
         pptgraul = pptgraul + sed_g(kts)*DT*onstep(4)<a name='3479'>
      enddo<a name='3480'>
<a name='3481'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3482'></font>
<font color=#447700>!.. Instantly melt any cloud ice into cloud water if above 0C and<a name='3483'></font>
<font color=#447700>!.. instantly freeze any cloud water found below HGFR.<a name='3484'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3485'></font>
      if (.not. iiwarm) then<a name='3486'>
      do k = kts, kte<a name='3487'>
         xri = MAX(0.0, qi1d(k) + qiten(k)*DT)<a name='3488'>
         if ( (temp(k).gt. T_0) .and. (xri.gt. 0.0) ) then<a name='3489'>
          qcten(k) = qcten(k) + xri*odt<a name='3490'>
          ncten(k) = ncten(k) + ni1d(k)*odt<a name='3491'>
          qiten(k) = qiten(k) - xri*odt<a name='3492'>
          niten(k) = -ni1d(k)*odt<a name='3493'>
          tten(k) = tten(k) - lfus*ocp(k)*xri*odt*(1-IFDRY)<a name='3494'>
         endif<a name='3495'>
<a name='3496'>
         xrc = MAX(0.0, qc1d(k) + qcten(k)*DT)<a name='3497'>
         if ( (temp(k).lt. HGFR) .and. (xrc.gt. 0.0) ) then<a name='3498'>
          lfus2 = lsub - lvap(k)<a name='3499'>
          xnc = nc1d(k) + ncten(k)*DT<a name='3500'>
          qiten(k) = qiten(k) + xrc*odt<a name='3501'>
          niten(k) = niten(k) + xnc*odt<a name='3502'>
          qcten(k) = qcten(k) - xrc*odt<a name='3503'>
          ncten(k) = ncten(k) - xnc*odt<a name='3504'>
          tten(k) = tten(k) + lfus2*ocp(k)*xrc*odt*(1-IFDRY)<a name='3505'>
         endif<a name='3506'>
      enddo<a name='3507'>
      endif<a name='3508'>
<a name='3509'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3510'></font>
<font color=#447700>!.. All tendencies computed, apply and pass back final values to parent.<a name='3511'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3512'></font>
      do k = kts, kte<a name='3513'>
         t1d(k)  = t1d(k) + tten(k)*DT<a name='3514'>
         qv1d(k) = MAX(1.E-10, qv1d(k) + qvten(k)*DT)<a name='3515'>
         qc1d(k) = qc1d(k) + qcten(k)*DT<a name='3516'>
         nc1d(k) = MAX(2./rho(k), nc1d(k) + ncten(k)*DT)<a name='3517'>
         nwfa1d(k) = MAX(11.1E6/rho(k), MIN(9999.E6/rho(k),             &amp;<a name='3518'>
                       (nwfa1d(k)+nwfaten(k)*DT)))<a name='3519'>
         nifa1d(k) = MAX(naIN1*0.01, MIN(9999.E6/rho(k),                &amp;<a name='3520'>
                       (nifa1d(k)+nifaten(k)*DT)))<a name='3521'>
<a name='3522'>
         if (qc1d(k) .le. R1) then<a name='3523'>
           qc1d(k) = 0.0<a name='3524'>
           nc1d(k) = 0.0<a name='3525'>
         else<a name='3526'>
           nu_c = MIN(15, NINT(1000.E6/(nc1d(k)*rho(k))) + 2)<a name='3527'>
           lamc = (am_r*ccg(2,nu_c)*ocg1(nu_c)*nc1d(k)/qc1d(k))**obmr<a name='3528'>
           xDc = (bm_r + nu_c + 1.) / lamc<a name='3529'>
           if (xDc.lt. D0c) then<a name='3530'>
            lamc = cce(2,nu_c)/D0c<a name='3531'>
           elseif (xDc.gt. D0r*2.) then<a name='3532'>
            lamc = cce(2,nu_c)/(D0r*2.)<a name='3533'>
           endif<a name='3534'>
           nc1d(k) = MIN(ccg(1,nu_c)*ocg2(nu_c)*qc1d(k)/am_r*lamc**bm_r,&amp;<a name='3535'>
                         DBLE(Nt_c_max)/rho(k))<a name='3536'>
         endif<a name='3537'>
<a name='3538'>
         qi1d(k) = qi1d(k) + qiten(k)*DT<a name='3539'>
         ni1d(k) = MAX(R2/rho(k), ni1d(k) + niten(k)*DT)<a name='3540'>
         if (qi1d(k) .le. R1) then<a name='3541'>
           qi1d(k) = 0.0<a name='3542'>
           ni1d(k) = 0.0<a name='3543'>
         else<a name='3544'>
           lami = (am_i*cig(2)*oig1*ni1d(k)/qi1d(k))**obmi<a name='3545'>
           ilami = 1./lami<a name='3546'>
           xDi = (bm_i + mu_i + 1.) * ilami<a name='3547'>
           if (xDi.lt. 5.E-6) then<a name='3548'>
            lami = cie(2)/5.E-6<a name='3549'>
           elseif (xDi.gt. 300.E-6) then<a name='3550'>
            lami = cie(2)/300.E-6<a name='3551'>
           endif<a name='3552'>
           ni1d(k) = MIN(cig(1)*oig2*qi1d(k)/am_i*lami**bm_i,           &amp;<a name='3553'>
                         499.D3/rho(k))<a name='3554'>
         endif<a name='3555'>
         qr1d(k) = qr1d(k) + qrten(k)*DT<a name='3556'>
         nr1d(k) = MAX(R2/rho(k), nr1d(k) + nrten(k)*DT)<a name='3557'>
         if (qr1d(k) .le. R1) then<a name='3558'>
           qr1d(k) = 0.0<a name='3559'>
           nr1d(k) = 0.0<a name='3560'>
         else<a name='3561'>
           lamr = (am_r*crg(3)*org2*nr1d(k)/qr1d(k))**obmr<a name='3562'>
           mvd_r(k) = (3.0 + mu_r + 0.672) / lamr<a name='3563'>
           if (mvd_r(k) .gt. 2.5E-3) then<a name='3564'>
              mvd_r(k) = 2.5E-3<a name='3565'>
           elseif (mvd_r(k) .lt. D0r*0.75) then<a name='3566'>
              mvd_r(k) = D0r*0.75<a name='3567'>
           endif<a name='3568'>
           lamr = (3.0 + mu_r + 0.672) / mvd_r(k)<a name='3569'>
           nr1d(k) = crg(2)*org3*qr1d(k)*lamr**bm_r / am_r<a name='3570'>
         endif<a name='3571'>
         qs1d(k) = qs1d(k) + qsten(k)*DT<a name='3572'>
         if (qs1d(k) .le. R1) qs1d(k) = 0.0<a name='3573'>
         qg1d(k) = qg1d(k) + qgten(k)*DT<a name='3574'>
         if (qg1d(k) .le. R1) qg1d(k) = 0.0<a name='3575'>
      enddo<a name='3576'>
<a name='3577'>
      end subroutine mp_thompson<a name='3578'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3579'></font>
<font color=#447700>!ctrlL<a name='3580'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3581'></font>
<font color=#447700>!..Creation of the lookup tables and support functions found below here.<a name='3582'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3583'></font>
<font color=#447700>!..Rain collecting graupel (and inverse).  Explicit CE integration.<a name='3584'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3585'></font>
<a name='3586'>
<A NAME='QR_ACR_QG'><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3587'>
      <font color=#993300>subroutine </font><font color=#cc0000>qr_acr_qg</font> <A href='../../call_to/QR_ACR_QG.html' TARGET='index'>1</A>,<A href='../../call_from/QR_ACR_QG.html' TARGET='index'>21</A><a name='3588'>
<a name='3589'>
      implicit none<a name='3590'>
<a name='3591'>
<font color=#447700>!..Local variables<a name='3592'></font>
      INTEGER:: i, j, k, m, n, n2<a name='3593'>
      INTEGER:: km, km_s, km_e<a name='3594'>
      DOUBLE PRECISION, DIMENSION(nbg):: vg, N_g<a name='3595'>
      DOUBLE PRECISION, DIMENSION(nbr):: vr, N_r<a name='3596'>
      DOUBLE PRECISION:: N0_r, N0_g, lam_exp, lamg, lamr<a name='3597'>
      DOUBLE PRECISION:: massg, massr, dvg, dvr, t1, t2, z1, z2, y1, y2<a name='3598'>
      LOGICAL force_read_thompson, write_thompson_tables<a name='3599'>
      LOGICAL lexist,lopen<a name='3600'>
      INTEGER good<a name='3601'>
      LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='3602'>
<a name='3603'>
<font color=#447700>!+---+<a name='3604'></font>
<a name='3605'>
      CALL nl_get_force_read_thompson(1,force_read_thompson)<a name='3606'>
      CALL nl_get_write_thompson_tables(1,write_thompson_tables)<a name='3607'>
<a name='3608'>
      good = 0<a name='3609'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='3610'>
        INQUIRE(FILE="qr_acr_qg.dat",EXIST=lexist)<a name='3611'>
        IF ( lexist ) THEN<a name='3612'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_825">("ThompMP: read qr_acr_qg.dat stead of computing")<a name='3613'>
          OPEN(63,file="qr_acr_qg.dat",form="unformatted",err=1234)<a name='3614'>
          READ(63,err=1234) tcg_racg<a name='3615'>
          READ(63,err=1234) tmr_racg<a name='3616'>
          READ(63,err=1234) tcr_gacr<a name='3617'>
          READ(63,err=1234) tmg_gacr<a name='3618'>
          READ(63,err=1234) tnr_racg<a name='3619'>
          READ(63,err=1234) tnr_gacr<a name='3620'>
          good = 1<a name='3621'>
 1234     CONTINUE<a name='3622'>
          IF ( good .NE. 1 ) THEN<a name='3623'>
            INQUIRE(63,opened=lopen)<a name='3624'>
            IF (lopen) THEN<a name='3625'>
              IF( force_read_thompson ) THEN<a name='3626'>
                CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_875">("Error reading qr_acr_qg.dat. Aborting because force_read_thompson is .true.")<a name='3627'>
              ENDIF<a name='3628'>
              CLOSE(63)<a name='3629'>
            ELSE<a name='3630'>
              IF( force_read_thompson ) THEN<a name='3631'>
                CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_876">("Error opening qr_acr_qg.dat. Aborting because force_read_thompson is .true.")<a name='3632'>
              ENDIF<a name='3633'>
            ENDIF<a name='3634'>
         ELSE<a name='3635'>
            INQUIRE(63,opened=lopen)<a name='3636'>
            IF (lopen) THEN<a name='3637'>
              CLOSE(63)<a name='3638'>
            ENDIF<a name='3639'>
          ENDIF<a name='3640'>
        ELSE<a name='3641'>
          IF( force_read_thompson ) THEN<a name='3642'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_877">("Non-existent qr_acr_qg.dat. Aborting because force_read_thompson is .true.")<a name='3643'>
          ENDIF<a name='3644'>
        ENDIF<a name='3645'>
      ENDIF<a name='3646'>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='3647'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_8">(good,1)<a name='3648'>
#endif<a name='3649'>
<a name='3650'>
      IF ( good .EQ. 1 ) THEN<a name='3651'>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='3652'></font>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_1">(tcg_racg,SIZE(tcg_racg))<a name='3653'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_2">(tmr_racg,SIZE(tmr_racg))<a name='3654'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_3">(tcr_gacr,SIZE(tcr_gacr))<a name='3655'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_4">(tmg_gacr,SIZE(tmg_gacr))<a name='3656'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_5">(tnr_racg,SIZE(tnr_racg))<a name='3657'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_6">(tnr_gacr,SIZE(tnr_gacr))<a name='3658'>
#endif<a name='3659'>
      ELSE<a name='3660'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_826">("ThompMP: computing qr_acr_qg")<a name='3661'>
        do n2 = 1, nbr<a name='3662'>
<font color=#447700>!        vr(n2) = av_r*Dr(n2)**bv_r * DEXP(-fv_r*Dr(n2))<a name='3663'></font>
         vr(n2) = -0.1021 + 4.932E3*Dr(n2) - 0.9551E6*Dr(n2)*Dr(n2)     &amp;<a name='3664'>
              + 0.07934E9*Dr(n2)*Dr(n2)*Dr(n2)                          &amp;<a name='3665'>
              - 0.002362E12*Dr(n2)*Dr(n2)*Dr(n2)*Dr(n2)<a name='3666'>
        enddo<a name='3667'>
        do n = 1, nbg<a name='3668'>
         vg(n) = av_g*Dg(n)**bv_g<a name='3669'>
        enddo<a name='3670'>
<a name='3671'>
<font color=#447700>!..Note values returned from wrf_dm_decomp1d are zero-based, add 1 for<a name='3672'></font>
<font color=#447700>!.. fortran indices.  J. Michalakes, 2009Oct30.<a name='3673'></font>
<a name='3674'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='3675'></font>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_DECOMP1D'>wrf_dm_decomp1d</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_DECOMP1D_1"> ( ntb_r*ntb_r1, km_s, km_e )<a name='3676'>
#else<a name='3677'>
        km_s = 0<a name='3678'>
        km_e = ntb_r*ntb_r1 - 1<a name='3679'>
#endif<a name='3680'>
<a name='3681'>
        do km = km_s, km_e<a name='3682'>
         m = km / ntb_r1 + 1<a name='3683'>
         k = mod( km , ntb_r1 ) + 1<a name='3684'>
<a name='3685'>
         lam_exp = (N0r_exp(k)*am_r*crg(1)/r_r(m))**ore1<a name='3686'>
         lamr = lam_exp * (crg(3)*org2*org1)**obmr<a name='3687'>
         N0_r = N0r_exp(k)/(crg(2)*lam_exp) * lamr**cre(2)<a name='3688'>
         do n2 = 1, nbr<a name='3689'>
            N_r(n2) = N0_r*Dr(n2)**mu_r *DEXP(-lamr*Dr(n2))*dtr(n2)<a name='3690'>
         enddo<a name='3691'>
<a name='3692'>
         do j = 1, ntb_g<a name='3693'>
         do i = 1, ntb_g1<a name='3694'>
            lam_exp = (N0g_exp(i)*am_g*cgg(1)/r_g(j))**oge1<a name='3695'>
            lamg = lam_exp * (cgg(3)*ogg2*ogg1)**obmg<a name='3696'>
            N0_g = N0g_exp(i)/(cgg(2)*lam_exp) * lamg**cge(2)<a name='3697'>
            do n = 1, nbg<a name='3698'>
               N_g(n) = N0_g*Dg(n)**mu_g * DEXP(-lamg*Dg(n))*dtg(n)<a name='3699'>
            enddo<a name='3700'>
<a name='3701'>
            t1 = 0.0d0<a name='3702'>
            t2 = 0.0d0<a name='3703'>
            z1 = 0.0d0<a name='3704'>
            z2 = 0.0d0<a name='3705'>
            y1 = 0.0d0<a name='3706'>
            y2 = 0.0d0<a name='3707'>
            do n2 = 1, nbr<a name='3708'>
               massr = am_r * Dr(n2)**bm_r<a name='3709'>
               do n = 1, nbg<a name='3710'>
                  massg = am_g * Dg(n)**bm_g<a name='3711'>
<a name='3712'>
                  dvg = 0.5d0*((vr(n2) - vg(n)) + DABS(vr(n2)-vg(n)))<a name='3713'>
                  dvr = 0.5d0*((vg(n) - vr(n2)) + DABS(vg(n)-vr(n2)))<a name='3714'>
<a name='3715'>
                  t1 = t1+ PI*.25*Ef_rg*(Dg(n)+Dr(n2))*(Dg(n)+Dr(n2)) &amp;<a name='3716'>
                      *dvg*massg * N_g(n)* N_r(n2)<a name='3717'>
                  z1 = z1+ PI*.25*Ef_rg*(Dg(n)+Dr(n2))*(Dg(n)+Dr(n2)) &amp;<a name='3718'>
                      *dvg*massr * N_g(n)* N_r(n2)<a name='3719'>
                  y1 = y1+ PI*.25*Ef_rg*(Dg(n)+Dr(n2))*(Dg(n)+Dr(n2)) &amp;<a name='3720'>
                      *dvg       * N_g(n)* N_r(n2)<a name='3721'>
<a name='3722'>
                  t2 = t2+ PI*.25*Ef_rg*(Dg(n)+Dr(n2))*(Dg(n)+Dr(n2)) &amp;<a name='3723'>
                      *dvr*massr * N_g(n)* N_r(n2)<a name='3724'>
                  y2 = y2+ PI*.25*Ef_rg*(Dg(n)+Dr(n2))*(Dg(n)+Dr(n2)) &amp;<a name='3725'>
                      *dvr       * N_g(n)* N_r(n2)<a name='3726'>
                  z2 = z2+ PI*.25*Ef_rg*(Dg(n)+Dr(n2))*(Dg(n)+Dr(n2)) &amp;<a name='3727'>
                      *dvr*massg * N_g(n)* N_r(n2)<a name='3728'>
               enddo<a name='3729'>
 97            continue<a name='3730'>
            enddo<a name='3731'>
            tcg_racg(i,j,k,m) = t1<a name='3732'>
            tmr_racg(i,j,k,m) = DMIN1(z1, r_r(m)*1.0d0)<a name='3733'>
            tcr_gacr(i,j,k,m) = t2<a name='3734'>
            tmg_gacr(i,j,k,m) = z2<a name='3735'>
            tnr_racg(i,j,k,m) = y1<a name='3736'>
            tnr_gacr(i,j,k,m) = y2<a name='3737'>
         enddo<a name='3738'>
         enddo<a name='3739'>
        enddo<a name='3740'>
<a name='3741'>
<font color=#447700>!..Note wrf_dm_gatherv expects zero-based km_s, km_e (J. Michalakes, 2009Oct30).<a name='3742'></font>
<a name='3743'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='3744'></font>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_1">(tcg_racg, ntb_g*ntb_g1, km_s, km_e, R8SIZE)<a name='3745'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_2">(tmr_racg, ntb_g*ntb_g1, km_s, km_e, R8SIZE)<a name='3746'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_3">(tcr_gacr, ntb_g*ntb_g1, km_s, km_e, R8SIZE)<a name='3747'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_4">(tmg_gacr, ntb_g*ntb_g1, km_s, km_e, R8SIZE)<a name='3748'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_5">(tnr_racg, ntb_g*ntb_g1, km_s, km_e, R8SIZE)<a name='3749'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_6">(tnr_gacr, ntb_g*ntb_g1, km_s, km_e, R8SIZE)<a name='3750'>
#endif<a name='3751'>
<a name='3752'>
        IF ( write_thompson_tables .AND. wrf_dm_on_monitor() ) THEN<a name='3753'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_827">("Writing qr_acr_qg.dat in Thompson MP init")<a name='3754'>
          OPEN(63,file="qr_acr_qg.dat",form="unformatted",err=9234)<a name='3755'>
          WRITE(63,err=9234) tcg_racg<a name='3756'>
          WRITE(63,err=9234) tmr_racg<a name='3757'>
          WRITE(63,err=9234) tcr_gacr<a name='3758'>
          WRITE(63,err=9234) tmg_gacr<a name='3759'>
          WRITE(63,err=9234) tnr_racg<a name='3760'>
          WRITE(63,err=9234) tnr_gacr<a name='3761'>
          CLOSE(63)<a name='3762'>
          RETURN    <font color=#447700>! ----- RETURN<a name='3763'></font>
 9234     CONTINUE<a name='3764'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_878">("Error writing qr_acr_qg.dat")<a name='3765'>
        ENDIF<a name='3766'>
      ENDIF<a name='3767'>
<a name='3768'>
      end subroutine qr_acr_qg<a name='3769'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3770'></font>
<font color=#447700>!ctrlL<a name='3771'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3772'></font>
<font color=#447700>!..Rain collecting snow (and inverse).  Explicit CE integration.<a name='3773'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3774'></font>
<a name='3775'>
<A NAME='QR_ACR_QS'><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3776'>
      <font color=#993300>subroutine </font><font color=#cc0000>qr_acr_qs</font> <A href='../../call_to/QR_ACR_QS.html' TARGET='index'>1</A>,<A href='../../call_from/QR_ACR_QS.html' TARGET='index'>33</A><a name='3777'>
<a name='3778'>
      implicit none<a name='3779'>
<a name='3780'>
<font color=#447700>!..Local variables<a name='3781'></font>
      INTEGER:: i, j, k, m, n, n2<a name='3782'>
      INTEGER:: km, km_s, km_e<a name='3783'>
      DOUBLE PRECISION, DIMENSION(nbr):: vr, D1, N_r<a name='3784'>
      DOUBLE PRECISION, DIMENSION(nbs):: vs, N_s<a name='3785'>
      DOUBLE PRECISION:: loga_, a_, b_, second, M0, M2, M3, Mrat, oM3<a name='3786'>
      DOUBLE PRECISION:: N0_r, lam_exp, lamr, slam1, slam2<a name='3787'>
      DOUBLE PRECISION:: dvs, dvr, masss, massr<a name='3788'>
      DOUBLE PRECISION:: t1, t2, t3, t4, z1, z2, z3, z4<a name='3789'>
      DOUBLE PRECISION:: y1, y2, y3, y4<a name='3790'>
      LOGICAL force_read_thompson, write_thompson_tables<a name='3791'>
      LOGICAL lexist,lopen<a name='3792'>
      INTEGER good<a name='3793'>
      LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='3794'>
<a name='3795'>
<font color=#447700>!+---+<a name='3796'></font>
<a name='3797'>
      CALL nl_get_force_read_thompson(1,force_read_thompson)<a name='3798'>
      CALL nl_get_write_thompson_tables(1,write_thompson_tables)<a name='3799'>
<a name='3800'>
      good = 0<a name='3801'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='3802'>
        INQUIRE(FILE="qr_acr_qs.dat",EXIST=lexist)<a name='3803'>
        IF ( lexist ) THEN<a name='3804'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_828">("ThompMP: read qr_acr_qs.dat instead of computing")<a name='3805'>
          OPEN(63,file="qr_acr_qs.dat",form="unformatted",err=1234)<a name='3806'>
          READ(63,err=1234)tcs_racs1<a name='3807'>
          READ(63,err=1234)tmr_racs1<a name='3808'>
          READ(63,err=1234)tcs_racs2<a name='3809'>
          READ(63,err=1234)tmr_racs2<a name='3810'>
          READ(63,err=1234)tcr_sacr1<a name='3811'>
          READ(63,err=1234)tms_sacr1<a name='3812'>
          READ(63,err=1234)tcr_sacr2<a name='3813'>
          READ(63,err=1234)tms_sacr2<a name='3814'>
          READ(63,err=1234)tnr_racs1<a name='3815'>
          READ(63,err=1234)tnr_racs2<a name='3816'>
          READ(63,err=1234)tnr_sacr1<a name='3817'>
          READ(63,err=1234)tnr_sacr2<a name='3818'>
          good = 1<a name='3819'>
 1234     CONTINUE<a name='3820'>
          IF ( good .NE. 1 ) THEN<a name='3821'>
            INQUIRE(63,opened=lopen)<a name='3822'>
            IF (lopen) THEN<a name='3823'>
              IF( force_read_thompson ) THEN<a name='3824'>
                CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_879">("Error reading qr_acr_qs.dat. Aborting because force_read_thompson is .true.")<a name='3825'>
              ENDIF<a name='3826'>
              CLOSE(63)<a name='3827'>
            ELSE<a name='3828'>
              IF( force_read_thompson ) THEN<a name='3829'>
                CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_880">("Error opening qr_acr_qs.dat. Aborting because force_read_thompson is .true.")<a name='3830'>
              ENDIF<a name='3831'>
            ENDIF<a name='3832'>
          ELSE<a name='3833'>
            INQUIRE(63,opened=lopen)<a name='3834'>
            IF (lopen) THEN<a name='3835'>
              CLOSE(63)<a name='3836'>
            ENDIF<a name='3837'>
          ENDIF<a name='3838'>
        ELSE<a name='3839'>
          IF( force_read_thompson ) THEN<a name='3840'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_881">("Non-existent qr_acr_qs.dat. Aborting because force_read_thompson is .true.")<a name='3841'>
          ENDIF<a name='3842'>
        ENDIF<a name='3843'>
      ENDIF<a name='3844'>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='3845'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_9">(good,1)<a name='3846'>
#endif<a name='3847'>
<a name='3848'>
      IF ( good .EQ. 1 ) THEN<a name='3849'>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='3850'></font>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_7">(tcs_racs1,SIZE(tcs_racs1))<a name='3851'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_8">(tmr_racs1,SIZE(tmr_racs1))<a name='3852'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_9">(tcs_racs2,SIZE(tcs_racs2))<a name='3853'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_10">(tmr_racs2,SIZE(tmr_racs2))<a name='3854'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_11">(tcr_sacr1,SIZE(tcr_sacr1))<a name='3855'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_12">(tms_sacr1,SIZE(tms_sacr1))<a name='3856'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_13">(tcr_sacr2,SIZE(tcr_sacr2))<a name='3857'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_14">(tms_sacr2,SIZE(tms_sacr2))<a name='3858'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_15">(tnr_racs1,SIZE(tnr_racs1))<a name='3859'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_16">(tnr_racs2,SIZE(tnr_racs2))<a name='3860'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_17">(tnr_sacr1,SIZE(tnr_sacr1))<a name='3861'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_18">(tnr_sacr2,SIZE(tnr_sacr2))<a name='3862'>
#endif<a name='3863'>
      ELSE<a name='3864'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_829">("ThompMP: computing qr_acr_qs")<a name='3865'>
        do n2 = 1, nbr<a name='3866'>
<font color=#447700>!        vr(n2) = av_r*Dr(n2)**bv_r * DEXP(-fv_r*Dr(n2))<a name='3867'></font>
         vr(n2) = -0.1021 + 4.932E3*Dr(n2) - 0.9551E6*Dr(n2)*Dr(n2)     &amp;<a name='3868'>
              + 0.07934E9*Dr(n2)*Dr(n2)*Dr(n2)                          &amp;<a name='3869'>
              - 0.002362E12*Dr(n2)*Dr(n2)*Dr(n2)*Dr(n2)<a name='3870'>
         D1(n2) = (vr(n2)/av_s)**(1./bv_s)<a name='3871'>
        enddo<a name='3872'>
        do n = 1, nbs<a name='3873'>
         vs(n) = 1.5*av_s*Ds(n)**bv_s * DEXP(-fv_s*Ds(n))<a name='3874'>
        enddo<a name='3875'>
<a name='3876'>
<font color=#447700>!..Note values returned from wrf_dm_decomp1d are zero-based, add 1 for<a name='3877'></font>
<font color=#447700>!.. fortran indices.  J. Michalakes, 2009Oct30.<a name='3878'></font>
<a name='3879'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='3880'></font>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_DECOMP1D'>wrf_dm_decomp1d</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_DECOMP1D_2"> ( ntb_r*ntb_r1, km_s, km_e )<a name='3881'>
#else<a name='3882'>
        km_s = 0<a name='3883'>
        km_e = ntb_r*ntb_r1 - 1<a name='3884'>
#endif<a name='3885'>
<a name='3886'>
        do km = km_s, km_e<a name='3887'>
         m = km / ntb_r1 + 1<a name='3888'>
         k = mod( km , ntb_r1 ) + 1<a name='3889'>
<a name='3890'>
         lam_exp = (N0r_exp(k)*am_r*crg(1)/r_r(m))**ore1<a name='3891'>
         lamr = lam_exp * (crg(3)*org2*org1)**obmr<a name='3892'>
         N0_r = N0r_exp(k)/(crg(2)*lam_exp) * lamr**cre(2)<a name='3893'>
         do n2 = 1, nbr<a name='3894'>
            N_r(n2) = N0_r*Dr(n2)**mu_r * DEXP(-lamr*Dr(n2))*dtr(n2)<a name='3895'>
         enddo<a name='3896'>
<a name='3897'>
         do j = 1, ntb_t<a name='3898'>
            do i = 1, ntb_s<a name='3899'>
<a name='3900'>
<font color=#447700>!..From the bm_s moment, compute plus one moment.  If we are not<a name='3901'></font>
<font color=#447700>!.. using bm_s=2, then we must transform to the pure 2nd moment<a name='3902'></font>
<font color=#447700>!.. (variable called "second") and then to the bm_s+1 moment.<a name='3903'></font>
<a name='3904'>
               M2 = r_s(i)*oams *1.0d0<a name='3905'>
               if (bm_s.gt.2.0-1.E-3 .and. bm_s.lt.2.0+1.E-3) then<a name='3906'>
                  loga_ = sa(1) + sa(2)*Tc(j) + sa(3)*bm_s &amp;<a name='3907'>
                     + sa(4)*Tc(j)*bm_s + sa(5)*Tc(j)*Tc(j) &amp;<a name='3908'>
                     + sa(6)*bm_s*bm_s + sa(7)*Tc(j)*Tc(j)*bm_s &amp;<a name='3909'>
                     + sa(8)*Tc(j)*bm_s*bm_s + sa(9)*Tc(j)*Tc(j)*Tc(j) &amp;<a name='3910'>
                     + sa(10)*bm_s*bm_s*bm_s<a name='3911'>
                  a_ = 10.0**loga_<a name='3912'>
                  b_ = sb(1) + sb(2)*Tc(j) + sb(3)*bm_s &amp;<a name='3913'>
                     + sb(4)*Tc(j)*bm_s + sb(5)*Tc(j)*Tc(j) &amp;<a name='3914'>
                     + sb(6)*bm_s*bm_s + sb(7)*Tc(j)*Tc(j)*bm_s &amp;<a name='3915'>
                     + sb(8)*Tc(j)*bm_s*bm_s + sb(9)*Tc(j)*Tc(j)*Tc(j) &amp;<a name='3916'>
                     + sb(10)*bm_s*bm_s*bm_s<a name='3917'>
                  second = (M2/a_)**(1./b_)<a name='3918'>
               else<a name='3919'>
                  second = M2<a name='3920'>
               endif<a name='3921'>
<a name='3922'>
               loga_ = sa(1) + sa(2)*Tc(j) + sa(3)*cse(1) &amp;<a name='3923'>
                  + sa(4)*Tc(j)*cse(1) + sa(5)*Tc(j)*Tc(j) &amp;<a name='3924'>
                  + sa(6)*cse(1)*cse(1) + sa(7)*Tc(j)*Tc(j)*cse(1) &amp;<a name='3925'>
                  + sa(8)*Tc(j)*cse(1)*cse(1) + sa(9)*Tc(j)*Tc(j)*Tc(j) &amp;<a name='3926'>
                  + sa(10)*cse(1)*cse(1)*cse(1)<a name='3927'>
               a_ = 10.0**loga_<a name='3928'>
               b_ = sb(1)+sb(2)*Tc(j)+sb(3)*cse(1) + sb(4)*Tc(j)*cse(1) &amp;<a name='3929'>
                  + sb(5)*Tc(j)*Tc(j) + sb(6)*cse(1)*cse(1) &amp;<a name='3930'>
                  + sb(7)*Tc(j)*Tc(j)*cse(1) + sb(8)*Tc(j)*cse(1)*cse(1) &amp;<a name='3931'>
                  + sb(9)*Tc(j)*Tc(j)*Tc(j)+sb(10)*cse(1)*cse(1)*cse(1)<a name='3932'>
               M3 = a_ * second**b_<a name='3933'>
<a name='3934'>
               oM3 = 1./M3<a name='3935'>
               Mrat = M2*(M2*oM3)*(M2*oM3)*(M2*oM3)<a name='3936'>
               M0   = (M2*oM3)**mu_s<a name='3937'>
               slam1 = M2 * oM3 * Lam0<a name='3938'>
               slam2 = M2 * oM3 * Lam1<a name='3939'>
<a name='3940'>
               do n = 1, nbs<a name='3941'>
                  N_s(n) = Mrat*(Kap0*DEXP(-slam1*Ds(n)) &amp;<a name='3942'>
                      + Kap1*M0*Ds(n)**mu_s * DEXP(-slam2*Ds(n)))*dts(n)<a name='3943'>
               enddo<a name='3944'>
<a name='3945'>
               t1 = 0.0d0<a name='3946'>
               t2 = 0.0d0<a name='3947'>
               t3 = 0.0d0<a name='3948'>
               t4 = 0.0d0<a name='3949'>
               z1 = 0.0d0<a name='3950'>
               z2 = 0.0d0<a name='3951'>
               z3 = 0.0d0<a name='3952'>
               z4 = 0.0d0<a name='3953'>
               y1 = 0.0d0<a name='3954'>
               y2 = 0.0d0<a name='3955'>
               y3 = 0.0d0<a name='3956'>
               y4 = 0.0d0<a name='3957'>
               do n2 = 1, nbr<a name='3958'>
                  massr = am_r * Dr(n2)**bm_r<a name='3959'>
                  do n = 1, nbs<a name='3960'>
                     masss = am_s * Ds(n)**bm_s<a name='3961'>
      <a name='3962'>
                     dvs = 0.5d0*((vr(n2) - vs(n)) + DABS(vr(n2)-vs(n)))<a name='3963'>
                     dvr = 0.5d0*((vs(n) - vr(n2)) + DABS(vs(n)-vr(n2)))<a name='3964'>
<a name='3965'>
                     if (massr .gt. 1.5*masss) then<a name='3966'>
                     t1 = t1+ PI*.25*Ef_rs*(Ds(n)+Dr(n2))*(Ds(n)+Dr(n2)) &amp;<a name='3967'>
                         *dvs*masss * N_s(n)* N_r(n2)<a name='3968'>
                     z1 = z1+ PI*.25*Ef_rs*(Ds(n)+Dr(n2))*(Ds(n)+Dr(n2)) &amp;<a name='3969'>
                         *dvs*massr * N_s(n)* N_r(n2)<a name='3970'>
                     y1 = y1+ PI*.25*Ef_rs*(Ds(n)+Dr(n2))*(Ds(n)+Dr(n2)) &amp;<a name='3971'>
                         *dvs       * N_s(n)* N_r(n2)<a name='3972'>
                     else<a name='3973'>
                     t3 = t3+ PI*.25*Ef_rs*(Ds(n)+Dr(n2))*(Ds(n)+Dr(n2)) &amp;<a name='3974'>
                         *dvs*masss * N_s(n)* N_r(n2)<a name='3975'>
                     z3 = z3+ PI*.25*Ef_rs*(Ds(n)+Dr(n2))*(Ds(n)+Dr(n2)) &amp;<a name='3976'>
                         *dvs*massr * N_s(n)* N_r(n2)<a name='3977'>
                     y3 = y3+ PI*.25*Ef_rs*(Ds(n)+Dr(n2))*(Ds(n)+Dr(n2)) &amp;<a name='3978'>
                         *dvs       * N_s(n)* N_r(n2)<a name='3979'>
                     endif<a name='3980'>
<a name='3981'>
                     if (massr .gt. 1.5*masss) then<a name='3982'>
                     t2 = t2+ PI*.25*Ef_rs*(Ds(n)+Dr(n2))*(Ds(n)+Dr(n2)) &amp;<a name='3983'>
                         *dvr*massr * N_s(n)* N_r(n2)<a name='3984'>
                     y2 = y2+ PI*.25*Ef_rs*(Ds(n)+Dr(n2))*(Ds(n)+Dr(n2)) &amp;<a name='3985'>
                         *dvr       * N_s(n)* N_r(n2)<a name='3986'>
                     z2 = z2+ PI*.25*Ef_rs*(Ds(n)+Dr(n2))*(Ds(n)+Dr(n2)) &amp;<a name='3987'>
                         *dvr*masss * N_s(n)* N_r(n2)<a name='3988'>
                     else<a name='3989'>
                     t4 = t4+ PI*.25*Ef_rs*(Ds(n)+Dr(n2))*(Ds(n)+Dr(n2)) &amp;<a name='3990'>
                         *dvr*massr * N_s(n)* N_r(n2)<a name='3991'>
                     y4 = y4+ PI*.25*Ef_rs*(Ds(n)+Dr(n2))*(Ds(n)+Dr(n2)) &amp;<a name='3992'>
                         *dvr       * N_s(n)* N_r(n2)<a name='3993'>
                     z4 = z4+ PI*.25*Ef_rs*(Ds(n)+Dr(n2))*(Ds(n)+Dr(n2)) &amp;<a name='3994'>
                         *dvr*masss * N_s(n)* N_r(n2)<a name='3995'>
                     endif<a name='3996'>
<a name='3997'>
                  enddo<a name='3998'>
               enddo<a name='3999'>
               tcs_racs1(i,j,k,m) = t1<a name='4000'>
               tmr_racs1(i,j,k,m) = DMIN1(z1, r_r(m)*1.0d0)<a name='4001'>
               tcs_racs2(i,j,k,m) = t3<a name='4002'>
               tmr_racs2(i,j,k,m) = z3<a name='4003'>
               tcr_sacr1(i,j,k,m) = t2<a name='4004'>
               tms_sacr1(i,j,k,m) = z2<a name='4005'>
               tcr_sacr2(i,j,k,m) = t4<a name='4006'>
               tms_sacr2(i,j,k,m) = z4<a name='4007'>
               tnr_racs1(i,j,k,m) = y1<a name='4008'>
               tnr_racs2(i,j,k,m) = y3<a name='4009'>
               tnr_sacr1(i,j,k,m) = y2<a name='4010'>
               tnr_sacr2(i,j,k,m) = y4<a name='4011'>
            enddo<a name='4012'>
         enddo<a name='4013'>
        enddo<a name='4014'>
<a name='4015'>
<font color=#447700>!..Note wrf_dm_gatherv expects zero-based km_s, km_e (J. Michalakes, 2009Oct30).<a name='4016'></font>
<a name='4017'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='4018'></font>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_7">(tcs_racs1, ntb_s*ntb_t, km_s, km_e, R8SIZE)<a name='4019'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_8">(tmr_racs1, ntb_s*ntb_t, km_s, km_e, R8SIZE)<a name='4020'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_9">(tcs_racs2, ntb_s*ntb_t, km_s, km_e, R8SIZE)<a name='4021'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_10">(tmr_racs2, ntb_s*ntb_t, km_s, km_e, R8SIZE)<a name='4022'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_11">(tcr_sacr1, ntb_s*ntb_t, km_s, km_e, R8SIZE)<a name='4023'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_12">(tms_sacr1, ntb_s*ntb_t, km_s, km_e, R8SIZE)<a name='4024'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_13">(tcr_sacr2, ntb_s*ntb_t, km_s, km_e, R8SIZE)<a name='4025'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_14">(tms_sacr2, ntb_s*ntb_t, km_s, km_e, R8SIZE)<a name='4026'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_15">(tnr_racs1, ntb_s*ntb_t, km_s, km_e, R8SIZE)<a name='4027'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_16">(tnr_racs2, ntb_s*ntb_t, km_s, km_e, R8SIZE)<a name='4028'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_17">(tnr_sacr1, ntb_s*ntb_t, km_s, km_e, R8SIZE)<a name='4029'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV'>wrf_dm_gatherv</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_18">(tnr_sacr2, ntb_s*ntb_t, km_s, km_e, R8SIZE)<a name='4030'>
#endif<a name='4031'>
<a name='4032'>
        IF ( write_thompson_tables .AND. wrf_dm_on_monitor() ) THEN<a name='4033'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_830">("Writing qr_acr_qs.dat in Thompson MP init")<a name='4034'>
          OPEN(63,file="qr_acr_qs.dat",form="unformatted",err=9234)<a name='4035'>
          WRITE(63,err=9234)tcs_racs1<a name='4036'>
          WRITE(63,err=9234)tmr_racs1<a name='4037'>
          WRITE(63,err=9234)tcs_racs2<a name='4038'>
          WRITE(63,err=9234)tmr_racs2<a name='4039'>
          WRITE(63,err=9234)tcr_sacr1<a name='4040'>
          WRITE(63,err=9234)tms_sacr1<a name='4041'>
          WRITE(63,err=9234)tcr_sacr2<a name='4042'>
          WRITE(63,err=9234)tms_sacr2<a name='4043'>
          WRITE(63,err=9234)tnr_racs1<a name='4044'>
          WRITE(63,err=9234)tnr_racs2<a name='4045'>
          WRITE(63,err=9234)tnr_sacr1<a name='4046'>
          WRITE(63,err=9234)tnr_sacr2<a name='4047'>
          CLOSE(63)<a name='4048'>
          RETURN    <font color=#447700>! ----- RETURN<a name='4049'></font>
 9234     CONTINUE<a name='4050'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#QR_ACR_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_882">("Error writing qr_acr_qs.dat")<a name='4051'>
        ENDIF<a name='4052'>
      ENDIF<a name='4053'>
<a name='4054'>
      end subroutine qr_acr_qs<a name='4055'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4056'></font>
<font color=#447700>!ctrlL<a name='4057'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4058'></font>
<font color=#447700>!..This is a literal adaptation of Bigg (1954) probability of drops of<a name='4059'></font>
<font color=#447700>!..a particular volume freezing.  Given this probability, simply freeze<a name='4060'></font>
<font color=#447700>!..the proportion of drops summing their masses.<a name='4061'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4062'></font>
<a name='4063'>
<A NAME='FREEZEH2O'><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4064'>
      <font color=#993300>subroutine </font><font color=#cc0000>freezeH2O</font> <A href='../../call_to/FREEZEH2O.html' TARGET='index'>1</A>,<A href='../../call_from/FREEZEH2O.html' TARGET='index'>14</A><a name='4065'>
<a name='4066'>
      implicit none<a name='4067'>
<a name='4068'>
<font color=#447700>!..Local variables<a name='4069'></font>
      INTEGER:: i, j, k, m, n, n2<a name='4070'>
      DOUBLE PRECISION, DIMENSION(nbr):: N_r, massr<a name='4071'>
      DOUBLE PRECISION, DIMENSION(nbc):: N_c, massc<a name='4072'>
      DOUBLE PRECISION:: sum1, sum2, sumn1, sumn2, &amp;<a name='4073'>
                         prob, vol, Texp, orho_w, &amp;<a name='4074'>
                         lam_exp, lamr, N0_r, lamc, N0_c, y<a name='4075'>
      INTEGER:: nu_c<a name='4076'>
      REAL:: T_adjust<a name='4077'>
      LOGICAL force_read_thompson, write_thompson_tables<a name='4078'>
      LOGICAL lexist,lopen<a name='4079'>
      INTEGER good<a name='4080'>
      LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='4081'>
<a name='4082'>
<font color=#447700>!+---+<a name='4083'></font>
      CALL nl_get_force_read_thompson(1,force_read_thompson)<a name='4084'>
      CALL nl_get_write_thompson_tables(1,write_thompson_tables)<a name='4085'>
<a name='4086'>
      good = 0<a name='4087'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='4088'>
        INQUIRE(FILE="freezeH2O.dat",EXIST=lexist)<a name='4089'>
        IF ( lexist ) THEN<a name='4090'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_831">("ThompMP: read freezeH2O.dat stead of computing")<a name='4091'>
          OPEN(63,file="freezeH2O.dat",form="unformatted",err=1234)<a name='4092'>
          READ(63,err=1234)tpi_qrfz<a name='4093'>
          READ(63,err=1234)tni_qrfz<a name='4094'>
          READ(63,err=1234)tpg_qrfz<a name='4095'>
          READ(63,err=1234)tnr_qrfz<a name='4096'>
          READ(63,err=1234)tpi_qcfz<a name='4097'>
          READ(63,err=1234)tni_qcfz<a name='4098'>
          good = 1<a name='4099'>
 1234     CONTINUE<a name='4100'>
          IF ( good .NE. 1 ) THEN<a name='4101'>
            INQUIRE(63,opened=lopen)<a name='4102'>
            IF (lopen) THEN<a name='4103'>
              IF( force_read_thompson ) THEN<a name='4104'>
                CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_883">("Error reading freezeH2O.dat. Aborting because force_read_thompson is .true.")<a name='4105'>
              ENDIF<a name='4106'>
              CLOSE(63)<a name='4107'>
            ELSE<a name='4108'>
              IF( force_read_thompson ) THEN<a name='4109'>
                CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_884">("Error opening freezeH2O.dat. Aborting because force_read_thompson is .true.")<a name='4110'>
              ENDIF<a name='4111'>
            ENDIF<a name='4112'>
          ELSE<a name='4113'>
            INQUIRE(63,opened=lopen)<a name='4114'>
            IF (lopen) THEN<a name='4115'>
              CLOSE(63)<a name='4116'>
            ENDIF<a name='4117'>
          ENDIF<a name='4118'>
        ELSE<a name='4119'>
          IF( force_read_thompson ) THEN<a name='4120'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_885">("Non-existent freezeH2O.dat. Aborting because force_read_thompson is .true.")<a name='4121'>
          ENDIF<a name='4122'>
        ENDIF<a name='4123'>
      ENDIF<a name='4124'>
<a name='4125'>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='4126'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_10">(good,1)<a name='4127'>
#endif<a name='4128'>
<a name='4129'>
      IF ( good .EQ. 1 ) THEN<a name='4130'>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='4131'></font>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_19">(tpi_qrfz,SIZE(tpi_qrfz))<a name='4132'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_20">(tni_qrfz,SIZE(tni_qrfz))<a name='4133'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_21">(tpg_qrfz,SIZE(tpg_qrfz))<a name='4134'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_22">(tnr_qrfz,SIZE(tnr_qrfz))<a name='4135'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_23">(tpi_qcfz,SIZE(tpi_qcfz))<a name='4136'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE'>wrf_dm_bcast_double</A><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_DOUBLE_24">(tni_qcfz,SIZE(tni_qcfz))<a name='4137'>
#endif<a name='4138'>
      ELSE<a name='4139'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_832">("ThompMP: computing freezeH2O")<a name='4140'>
<a name='4141'>
        orho_w = 1./rho_w<a name='4142'>
<a name='4143'>
        do n2 = 1, nbr<a name='4144'>
         massr(n2) = am_r*Dr(n2)**bm_r<a name='4145'>
        enddo<a name='4146'>
        do n = 1, nbc<a name='4147'>
         massc(n) = am_r*Dc(n)**bm_r<a name='4148'>
        enddo<a name='4149'>
<a name='4150'>
<font color=#447700>!..Freeze water (smallest drops become cloud ice, otherwise graupel).<a name='4151'></font>
        do m = 1, ntb_IN<a name='4152'>
        T_adjust = MAX(-3.0, MIN(3.0 - ALOG10(Nt_IN(m)), 3.0))<a name='4153'>
        do k = 1, 45<a name='4154'>
<font color=#447700>!         print*, ' Freezing water for temp = ', -k<a name='4155'></font>
         Texp = DEXP( DFLOAT(k) - T_adjust*1.0D0 ) - 1.0D0<a name='4156'>
         do j = 1, ntb_r1<a name='4157'>
            do i = 1, ntb_r<a name='4158'>
               lam_exp = (N0r_exp(j)*am_r*crg(1)/r_r(i))**ore1<a name='4159'>
               lamr = lam_exp * (crg(3)*org2*org1)**obmr<a name='4160'>
               N0_r = N0r_exp(j)/(crg(2)*lam_exp) * lamr**cre(2)<a name='4161'>
               sum1 = 0.0d0<a name='4162'>
               sum2 = 0.0d0<a name='4163'>
               sumn1 = 0.0d0<a name='4164'>
               sumn2 = 0.0d0<a name='4165'>
               do n2 = nbr, 1, -1<a name='4166'>
                  N_r(n2) = N0_r*Dr(n2)**mu_r*DEXP(-lamr*Dr(n2))*dtr(n2)<a name='4167'>
                  vol = massr(n2)*orho_w<a name='4168'>
                  prob = MAX(0.0D0, 1.0D0 - DEXP(-120.0D0*vol*5.2D-4 * Texp))<a name='4169'>
                  if (massr(n2) .lt. xm0g) then<a name='4170'>
                     sumn1 = sumn1 + prob*N_r(n2)<a name='4171'>
                     sum1 = sum1 + prob*N_r(n2)*massr(n2)<a name='4172'>
                  else<a name='4173'>
                     sumn2 = sumn2 + prob*N_r(n2)<a name='4174'>
                     sum2 = sum2 + prob*N_r(n2)*massr(n2)<a name='4175'>
                  endif<a name='4176'>
                  if ((sum1+sum2).ge.r_r(i)) EXIT<a name='4177'>
               enddo<a name='4178'>
               tpi_qrfz(i,j,k,m) = sum1<a name='4179'>
               tni_qrfz(i,j,k,m) = sumn1<a name='4180'>
               tpg_qrfz(i,j,k,m) = sum2<a name='4181'>
               tnr_qrfz(i,j,k,m) = sumn2<a name='4182'>
            enddo<a name='4183'>
         enddo<a name='4184'>
<a name='4185'>
         do j = 1, nbc<a name='4186'>
            nu_c = MIN(15, NINT(1000.E6/t_Nc(j)) + 2)<a name='4187'>
            do i = 1, ntb_c<a name='4188'>
               lamc = (t_Nc(j)*am_r* ccg(2,nu_c) * ocg1(nu_c) / r_c(i))**obmr<a name='4189'>
               N0_c = t_Nc(j)*ocg1(nu_c) * lamc**cce(1,nu_c)<a name='4190'>
               sum1 = 0.0d0<a name='4191'>
               sumn2 = 0.0d0<a name='4192'>
               do n = nbc, 1, -1<a name='4193'>
                  vol = massc(n)*orho_w<a name='4194'>
                  prob = MAX(0.0D0, 1.0D0 - DEXP(-120.0D0*vol*5.2D-4 * Texp))<a name='4195'>
                  N_c(n) = N0_c*Dc(n)**nu_c*EXP(-lamc*Dc(n))*dtc(n)<a name='4196'>
                  sumn2 = MIN(t_Nc(j), sumn2 + prob*N_c(n))<a name='4197'>
                  sum1 = sum1 + prob*N_c(n)*massc(n)<a name='4198'>
                  if (sum1 .ge. r_c(i)) EXIT<a name='4199'>
               enddo<a name='4200'>
               tpi_qcfz(i,j,k,m) = sum1<a name='4201'>
               tni_qcfz(i,j,k,m) = sumn2<a name='4202'>
            enddo<a name='4203'>
         enddo<a name='4204'>
        enddo<a name='4205'>
        enddo<a name='4206'>
<a name='4207'>
        IF ( write_thompson_tables .AND. wrf_dm_on_monitor() ) THEN<a name='4208'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_833">("Writing freezeH2O.dat in Thompson MP init")<a name='4209'>
          OPEN(63,file="freezeH2O.dat",form="unformatted",err=9234)<a name='4210'>
          WRITE(63,err=9234)tpi_qrfz<a name='4211'>
          WRITE(63,err=9234)tni_qrfz<a name='4212'>
          WRITE(63,err=9234)tpg_qrfz<a name='4213'>
          WRITE(63,err=9234)tnr_qrfz<a name='4214'>
          WRITE(63,err=9234)tpi_qcfz<a name='4215'>
          WRITE(63,err=9234)tni_qcfz<a name='4216'>
          CLOSE(63)<a name='4217'>
          RETURN    <font color=#447700>! ----- RETURN<a name='4218'></font>
 9234     CONTINUE<a name='4219'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#FREEZEH2O' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_886">("Error writing freezeH2O.dat")<a name='4220'>
        ENDIF<a name='4221'>
      ENDIF<a name='4222'>
<a name='4223'>
      end subroutine freezeH2O<a name='4224'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4225'></font>
<font color=#447700>!ctrlL<a name='4226'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4227'></font>
<font color=#447700>!..Cloud ice converting to snow since portion greater than min snow<a name='4228'></font>
<font color=#447700>!.. size.  Given cloud ice content (kg/m**3), number concentration<a name='4229'></font>
<font color=#447700>!.. (#/m**3) and gamma shape parameter, mu_i, break the distrib into<a name='4230'></font>
<font color=#447700>!.. bins and figure out the mass/number of ice with sizes larger than<a name='4231'></font>
<font color=#447700>!.. D0s.  Also, compute incomplete gamma function for the integration<a name='4232'></font>
<font color=#447700>!.. of ice depositional growth from diameter=0 to D0s.  Amount of<a name='4233'></font>
<font color=#447700>!.. ice depositional growth is this portion of distrib while larger<a name='4234'></font>
<font color=#447700>!.. diameters contribute to snow growth (as in Harrington et al. 1995).<a name='4235'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4236'></font>
<a name='4237'>
<A NAME='QI_AUT_QS'><A href='../../html_code/phys/module_mp_thompson.F.html#QI_AUT_QS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4238'>
      <font color=#993300>subroutine </font><font color=#cc0000>qi_aut_qs</font> <A href='../../call_to/QI_AUT_QS.html' TARGET='index'>1</A>,<A href='../../call_from/QI_AUT_QS.html' TARGET='index'>1</A><a name='4239'>
<a name='4240'>
      implicit none<a name='4241'>
<a name='4242'>
<font color=#447700>!..Local variables<a name='4243'></font>
      INTEGER:: i, j, n2<a name='4244'>
      DOUBLE PRECISION, DIMENSION(nbi):: N_i<a name='4245'>
      DOUBLE PRECISION:: N0_i, lami, Di_mean, t1, t2<a name='4246'>
      REAL:: xlimit_intg<a name='4247'>
<a name='4248'>
<font color=#447700>!+---+<a name='4249'></font>
<a name='4250'>
      do j = 1, ntb_i1<a name='4251'>
         do i = 1, ntb_i<a name='4252'>
            lami = (am_i*cig(2)*oig1*Nt_i(j)/r_i(i))**obmi<a name='4253'>
            Di_mean = (bm_i + mu_i + 1.) / lami<a name='4254'>
            N0_i = Nt_i(j)*oig1 * lami**cie(1)<a name='4255'>
            t1 = 0.0d0<a name='4256'>
            t2 = 0.0d0<a name='4257'>
            if (SNGL(Di_mean) .gt. 5.*D0s) then<a name='4258'>
             t1 = r_i(i)<a name='4259'>
             t2 = Nt_i(j)<a name='4260'>
             tpi_ide(i,j) = 0.0D0<a name='4261'>
            elseif (SNGL(Di_mean) .lt. D0i) then<a name='4262'>
             t1 = 0.0D0<a name='4263'>
             t2 = 0.0D0<a name='4264'>
             tpi_ide(i,j) = 1.0D0<a name='4265'>
            else<a name='4266'>
             xlimit_intg = lami*D0s<a name='4267'>
             tpi_ide(i,j) = <A href='../../html_code/phys/module_mp_thompson.F.html#GAMMP'>GAMMP</A><A href='../../html_code/phys/module_mp_thompson.F.html#QI_AUT_QS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMP_2">(mu_i+2.0, xlimit_intg) * 1.0D0<a name='4268'>
             do n2 = 1, nbi<a name='4269'>
               N_i(n2) = N0_i*Di(n2)**mu_i * DEXP(-lami*Di(n2))*dti(n2)<a name='4270'>
               if (Di(n2).ge.D0s) then<a name='4271'>
                  t1 = t1 + N_i(n2) * am_i*Di(n2)**bm_i<a name='4272'>
                  t2 = t2 + N_i(n2)<a name='4273'>
               endif<a name='4274'>
             enddo<a name='4275'>
            endif<a name='4276'>
            tps_iaus(i,j) = t1<a name='4277'>
            tni_iaus(i,j) = t2<a name='4278'>
         enddo<a name='4279'>
      enddo<a name='4280'>
<a name='4281'>
      end subroutine qi_aut_qs<a name='4282'>
<font color=#447700>!ctrlL<a name='4283'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4284'></font>
<font color=#447700>!..Variable collision efficiency for rain collecting cloud water using<a name='4285'></font>
<font color=#447700>!.. method of Beard and Grover, 1974 if a/A less than 0.25; otherwise<a name='4286'></font>
<font color=#447700>!.. uses polynomials to get close match of Pruppacher &amp; Klett Fig 14-9.<a name='4287'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4288'></font>
<a name='4289'>
<A NAME='TABLE_EFRW'><A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_EFRW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4290'>
      <font color=#993300>subroutine </font><font color=#cc0000>table_Efrw</font> <A href='../../call_to/TABLE_EFRW.html' TARGET='index'>1</A><a name='4291'>
<a name='4292'>
      implicit none<a name='4293'>
<a name='4294'>
<font color=#447700>!..Local variables<a name='4295'></font>
      DOUBLE PRECISION:: vtr, stokes, reynolds, Ef_rw<a name='4296'>
      DOUBLE PRECISION:: p, yc0, F, G, H, z, K0, X<a name='4297'>
      INTEGER:: i, j<a name='4298'>
<a name='4299'>
      do j = 1, nbc<a name='4300'>
      do i = 1, nbr<a name='4301'>
         Ef_rw = 0.0<a name='4302'>
         p = Dc(j)/Dr(i)<a name='4303'>
         if (Dr(i).lt.50.E-6 .or. Dc(j).lt.3.E-6) then<a name='4304'>
          t_Efrw(i,j) = 0.0<a name='4305'>
         elseif (p.gt.0.25) then<a name='4306'>
          X = Dc(j)*1.D6<a name='4307'>
          if (Dr(i) .lt. 75.e-6) then<a name='4308'>
             Ef_rw = 0.026794*X - 0.20604<a name='4309'>
          elseif (Dr(i) .lt. 125.e-6) then<a name='4310'>
             Ef_rw = -0.00066842*X*X + 0.061542*X - 0.37089<a name='4311'>
          elseif (Dr(i) .lt. 175.e-6) then<a name='4312'>
             Ef_rw = 4.091e-06*X*X*X*X - 0.00030908*X*X*X               &amp;<a name='4313'>
                   + 0.0066237*X*X - 0.0013687*X - 0.073022<a name='4314'>
          elseif (Dr(i) .lt. 250.e-6) then<a name='4315'>
             Ef_rw = 9.6719e-5*X*X*X - 0.0068901*X*X + 0.17305*X        &amp;<a name='4316'>
                   - 0.65988<a name='4317'>
          elseif (Dr(i) .lt. 350.e-6) then<a name='4318'>
             Ef_rw = 9.0488e-5*X*X*X - 0.006585*X*X + 0.16606*X         &amp;<a name='4319'>
                   - 0.56125<a name='4320'>
          else<a name='4321'>
             Ef_rw = 0.00010721*X*X*X - 0.0072962*X*X + 0.1704*X        &amp;<a name='4322'>
                   - 0.46929<a name='4323'>
          endif<a name='4324'>
         else<a name='4325'>
          vtr = -0.1021 + 4.932E3*Dr(i) - 0.9551E6*Dr(i)*Dr(i) &amp;<a name='4326'>
              + 0.07934E9*Dr(i)*Dr(i)*Dr(i) &amp;<a name='4327'>
              - 0.002362E12*Dr(i)*Dr(i)*Dr(i)*Dr(i)<a name='4328'>
          stokes = Dc(j)*Dc(j)*vtr*rho_w/(9.*1.718E-5*Dr(i))<a name='4329'>
          reynolds = 9.*stokes/(p*p*rho_w)<a name='4330'>
<a name='4331'>
          F = DLOG(reynolds)<a name='4332'>
          G = -0.1007D0 - 0.358D0*F + 0.0261D0*F*F<a name='4333'>
          K0 = DEXP(G)<a name='4334'>
          z = DLOG(stokes/(K0+1.D-15))<a name='4335'>
          H = 0.1465D0 + 1.302D0*z - 0.607D0*z*z + 0.293D0*z*z*z<a name='4336'>
          yc0 = 2.0D0/PI * ATAN(H)<a name='4337'>
          Ef_rw = (yc0+p)*(yc0+p) / ((1.+p)*(1.+p))<a name='4338'>
<a name='4339'>
         endif<a name='4340'>
<a name='4341'>
         t_Efrw(i,j) = MAX(0.0, MIN(SNGL(Ef_rw), 0.95))<a name='4342'>
<a name='4343'>
      enddo<a name='4344'>
      enddo<a name='4345'>
<a name='4346'>
      end subroutine table_Efrw<a name='4347'>
<font color=#447700>!ctrlL<a name='4348'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4349'></font>
<font color=#447700>!..Variable collision efficiency for snow collecting cloud water using<a name='4350'></font>
<font color=#447700>!.. method of Wang and Ji, 2000 except equate melted snow diameter to<a name='4351'></font>
<font color=#447700>!.. their "effective collision cross-section."<a name='4352'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4353'></font>
<a name='4354'>
<A NAME='TABLE_EFSW'><A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_EFSW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4355'>
      <font color=#993300>subroutine </font><font color=#cc0000>table_Efsw</font> <A href='../../call_to/TABLE_EFSW.html' TARGET='index'>1</A><a name='4356'>
<a name='4357'>
      implicit none<a name='4358'>
<a name='4359'>
<font color=#447700>!..Local variables<a name='4360'></font>
      DOUBLE PRECISION:: Ds_m, vts, vtc, stokes, reynolds, Ef_sw<a name='4361'>
      DOUBLE PRECISION:: p, yc0, F, G, H, z, K0<a name='4362'>
      INTEGER:: i, j<a name='4363'>
<a name='4364'>
      do j = 1, nbc<a name='4365'>
      vtc = 1.19D4 * (1.0D4*Dc(j)*Dc(j)*0.25D0)<a name='4366'>
      do i = 1, nbs<a name='4367'>
         vts = av_s*Ds(i)**bv_s * DEXP(-fv_s*Ds(i)) - vtc<a name='4368'>
         Ds_m = (am_s*Ds(i)**bm_s / am_r)**obmr<a name='4369'>
         p = Dc(j)/Ds_m<a name='4370'>
         if (p.gt.0.25 .or. Ds(i).lt.D0s .or. Dc(j).lt.6.E-6 &amp;<a name='4371'>
               .or. vts.lt.1.E-3) then<a name='4372'>
          t_Efsw(i,j) = 0.0<a name='4373'>
         else<a name='4374'>
          stokes = Dc(j)*Dc(j)*vts*rho_w/(9.*1.718E-5*Ds_m)<a name='4375'>
          reynolds = 9.*stokes/(p*p*rho_w)<a name='4376'>
<a name='4377'>
          F = DLOG(reynolds)<a name='4378'>
          G = -0.1007D0 - 0.358D0*F + 0.0261D0*F*F<a name='4379'>
          K0 = DEXP(G)<a name='4380'>
          z = DLOG(stokes/(K0+1.D-15))<a name='4381'>
          H = 0.1465D0 + 1.302D0*z - 0.607D0*z*z + 0.293D0*z*z*z<a name='4382'>
          yc0 = 2.0D0/PI * ATAN(H)<a name='4383'>
          Ef_sw = (yc0+p)*(yc0+p) / ((1.+p)*(1.+p))<a name='4384'>
<a name='4385'>
          t_Efsw(i,j) = MAX(0.0, MIN(SNGL(Ef_sw), 0.95))<a name='4386'>
         endif<a name='4387'>
<a name='4388'>
      enddo<a name='4389'>
      enddo<a name='4390'>
<a name='4391'>
      end subroutine table_Efsw<a name='4392'>
<font color=#447700>!ctrlL<a name='4393'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4394'></font>
<font color=#447700>!..Function to compute collision efficiency of collector species (rain,<a name='4395'></font>
<font color=#447700>!.. snow, graupel) of aerosols.  Follows Wang et al, 2010, ACP, which<a name='4396'></font>
<font color=#447700>!.. follows Slinn (1983).<a name='4397'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4398'></font>
<a name='4399'>
<A NAME='EFF_AERO'><A href='../../html_code/phys/module_mp_thompson.F.html#EFF_AERO' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4400'>
      real <font color=#993300>function </font><font color=#cc0000>Eff_aero</font>(D, Da, visc,rhoa,Temp,species) <A href='../../call_to/EFF_AERO.html' TARGET='index'>6</A><a name='4401'>
<a name='4402'>
      implicit none<a name='4403'>
      real:: D, Da, visc, rhoa, Temp<a name='4404'>
      character(LEN=1):: species<a name='4405'>
      real:: aval, Cc, diff, Re, Sc, St, St2, vt, Eff<a name='4406'>
      real, parameter:: boltzman = 1.3806503E-23<a name='4407'>
      real, parameter:: meanPath = 0.0256E-6<a name='4408'>
<a name='4409'>
      vt = 1.<a name='4410'>
      if (species .eq. 'r') then<a name='4411'>
         vt = -0.1021 + 4.932E3*D - 0.9551E6*D*D                        &amp;<a name='4412'>
              + 0.07934E9*D*D*D - 0.002362E12*D*D*D*D<a name='4413'>
      elseif (species .eq. 's') then<a name='4414'>
         vt = av_s*D**bv_s<a name='4415'>
      elseif (species .eq. 'g') then<a name='4416'>
         vt = av_g*D**bv_g<a name='4417'>
      endif<a name='4418'>
<a name='4419'>
      Cc    = 1. + 2.*meanPath/Da *(1.257+0.4*exp(-0.55*Da/meanPath))<a name='4420'>
      diff  = boltzman*Temp*Cc/(3.*PI*visc*Da)<a name='4421'>
<a name='4422'>
      Re    = 0.5*rhoa*D*vt/visc<a name='4423'>
      Sc    = visc/(rhoa*diff)<a name='4424'>
<a name='4425'>
      St    = Da*Da*vt*1000./(9.*visc*D)<a name='4426'>
      aval  = 1.+LOG(1.+Re)<a name='4427'>
      St2   = (1.2 + 1./12.*aval)/(1.+aval)<a name='4428'>
<a name='4429'>
      Eff = 4./(Re*Sc) * (1. + 0.4*SQRT(Re)*Sc**0.3333                  &amp;<a name='4430'>
                             + 0.16*SQRT(Re)*SQRT(Sc))                  &amp;<a name='4431'>
               + 4.*Da/D * (0.02 + Da/D*(1.+2.*SQRT(Re)))<a name='4432'>
<a name='4433'>
      if (St.gt.St2) Eff = Eff  + ( (St-St2)/(St-St2+0.666667))**1.5<a name='4434'>
      Eff_aero = MAX(1.E-5, MIN(Eff, 1.0))<a name='4435'>
<a name='4436'>
      end function Eff_aero<a name='4437'>
<a name='4438'>
<font color=#447700>!ctrlL<a name='4439'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4440'></font>
<font color=#447700>!..Integrate rain size distribution from zero to D-star to compute the<a name='4441'></font>
<font color=#447700>!.. number of drops smaller than D-star that evaporate in a single<a name='4442'></font>
<font color=#447700>!.. timestep.  Drops larger than D-star dont evaporate entirely so do<a name='4443'></font>
<font color=#447700>!.. not affect number concentration.<a name='4444'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4445'></font>
<a name='4446'>
<A NAME='TABLE_DROPEVAP'><A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_DROPEVAP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4447'>
      <font color=#993300>subroutine </font><font color=#cc0000>table_dropEvap</font> <A href='../../call_to/TABLE_DROPEVAP.html' TARGET='index'>1</A><a name='4448'>
<a name='4449'>
      implicit none<a name='4450'>
<a name='4451'>
<font color=#447700>!..Local variables<a name='4452'></font>
      INTEGER:: i, j, k, n<a name='4453'>
      DOUBLE PRECISION, DIMENSION(nbc):: N_c, massc<a name='4454'>
      DOUBLE PRECISION:: summ, summ2, lamc, N0_c<a name='4455'>
      INTEGER:: nu_c<a name='4456'>
<font color=#447700>!      DOUBLE PRECISION:: Nt_r, N0, lam_exp, lam<a name='4457'></font>
<font color=#447700>!      REAL:: xlimit_intg<a name='4458'></font>
<a name='4459'>
      do n = 1, nbc<a name='4460'>
         massc(n) = am_r*Dc(n)**bm_r<a name='4461'>
      enddo<a name='4462'>
<a name='4463'>
      do k = 1, nbc<a name='4464'>
         nu_c = MIN(15, NINT(1000.E6/t_Nc(k)) + 2)<a name='4465'>
         do j = 1, ntb_c<a name='4466'>
            lamc = (t_Nc(k)*am_r* ccg(2,nu_c)*ocg1(nu_c) / r_c(j))**obmr<a name='4467'>
            N0_c = t_Nc(k)*ocg1(nu_c) * lamc**cce(1,nu_c)<a name='4468'>
            do i = 1, nbc<a name='4469'>
<font color=#447700>!-GT           tnc_wev(i,j,k) = GAMMP(nu_c+1., SNGL(Dc(i)*lamc))*t_Nc(k)<a name='4470'></font>
               N_c(i) = N0_c* Dc(i)**nu_c*EXP(-lamc*Dc(i))*dtc(i)<a name='4471'>
<font color=#447700>!     if(j.eq.18 .and. k.eq.50) print*, ' N_c = ', N_c(i)<a name='4472'></font>
               summ = 0.<a name='4473'>
               summ2 = 0.<a name='4474'>
               do n = 1, i<a name='4475'>
                  summ = summ + massc(n)*N_c(n)<a name='4476'>
                  summ2 = summ2 + N_c(n)<a name='4477'>
               enddo<a name='4478'>
<font color=#447700>!      if(j.eq.18 .and. k.eq.50) print*, '  DEBUG-TABLE: ', r_c(j), t_Nc(k), summ2, summ<a name='4479'></font>
               tpc_wev(i,j,k) = summ<a name='4480'>
               tnc_wev(i,j,k) = summ2<a name='4481'>
            enddo<a name='4482'>
         enddo<a name='4483'>
      enddo<a name='4484'>
<a name='4485'>
<font color=#447700>!<a name='4486'></font>
<font color=#447700>!..To do the same thing for rain.<a name='4487'></font>
<font color=#447700>!<a name='4488'></font>
<font color=#447700>!     do k = 1, ntb_r<a name='4489'></font>
<font color=#447700>!     do j = 1, ntb_r1<a name='4490'></font>
<font color=#447700>!        lam_exp = (N0r_exp(j)*am_r*crg(1)/r_r(k))**ore1<a name='4491'></font>
<font color=#447700>!        lam = lam_exp * (crg(3)*org2*org1)**obmr<a name='4492'></font>
<font color=#447700>!        N0 = N0r_exp(j)/(crg(2)*lam_exp) * lam**cre(2)<a name='4493'></font>
<font color=#447700>!        Nt_r = N0 * crg(2) / lam**cre(2)<a name='4494'></font>
<font color=#447700>!        do i = 1, nbr<a name='4495'></font>
<font color=#447700>!           xlimit_intg = lam*Dr(i)<a name='4496'></font>
<font color=#447700>!           tnr_rev(i,j,k) = GAMMP(mu_r+1.0, xlimit_intg) * Nt_r<a name='4497'></font>
<font color=#447700>!        enddo<a name='4498'></font>
<font color=#447700>!     enddo<a name='4499'></font>
<font color=#447700>!     enddo<a name='4500'></font>
<a name='4501'>
<font color=#447700>! TO APPLY TABLE ABOVE<a name='4502'></font>
<font color=#447700>!..Rain lookup table indexes.<a name='4503'></font>
<font color=#447700>!         Dr_star = DSQRT(-2.D0*DT * t1_evap/(2.*PI) &amp;<a name='4504'></font>
<font color=#447700>!                 * 0.78*4.*diffu(k)*xsat*rvs/rho_w)<a name='4505'></font>
<font color=#447700>!         idx_d = NINT(1.0 + FLOAT(nbr) * DLOG(Dr_star/D0r)             &amp;<a name='4506'></font>
<font color=#447700>!               / DLOG(Dr(nbr)/D0r))<a name='4507'></font>
<font color=#447700>!         idx_d = MAX(1, MIN(idx_d, nbr))<a name='4508'></font>
<font color=#447700>!<a name='4509'></font>
<font color=#447700>!         nir = NINT(ALOG10(rr(k)))<a name='4510'></font>
<font color=#447700>!         do nn = nir-1, nir+1<a name='4511'></font>
<font color=#447700>!            n = nn<a name='4512'></font>
<font color=#447700>!            if ( (rr(k)/10.**nn).ge.1.0 .and. &amp;<a name='4513'></font>
<font color=#447700>!                 (rr(k)/10.**nn).lt.10.0) goto 154<a name='4514'></font>
<font color=#447700>!         enddo<a name='4515'></font>
<font color=#447700>!154      continue<a name='4516'></font>
<font color=#447700>!         idx_r = INT(rr(k)/10.**n) + 10*(n-nir2) - (n-nir2)<a name='4517'></font>
<font color=#447700>!         idx_r = MAX(1, MIN(idx_r, ntb_r))<a name='4518'></font>
<font color=#447700>!<a name='4519'></font>
<font color=#447700>!         lamr = (am_r*crg(3)*org2*nr(k)/rr(k))**obmr<a name='4520'></font>
<font color=#447700>!         lam_exp = lamr * (crg(3)*org2*org1)**bm_r<a name='4521'></font>
<font color=#447700>!         N0_exp = org1*rr(k)/am_r * lam_exp**cre(1)<a name='4522'></font>
<font color=#447700>!         nir = NINT(DLOG10(N0_exp))<a name='4523'></font>
<font color=#447700>!         do nn = nir-1, nir+1<a name='4524'></font>
<font color=#447700>!            n = nn<a name='4525'></font>
<font color=#447700>!            if ( (N0_exp/10.**nn).ge.1.0 .and. &amp;<a name='4526'></font>
<font color=#447700>!                 (N0_exp/10.**nn).lt.10.0) goto 155<a name='4527'></font>
<font color=#447700>!         enddo<a name='4528'></font>
<font color=#447700>!155      continue<a name='4529'></font>
<font color=#447700>!         idx_r1 = INT(N0_exp/10.**n) + 10*(n-nir3) - (n-nir3)<a name='4530'></font>
<font color=#447700>!         idx_r1 = MAX(1, MIN(idx_r1, ntb_r1))<a name='4531'></font>
<font color=#447700>!<a name='4532'></font>
<font color=#447700>!         pnr_rev(k) = MIN(nr(k)*odts, SNGL(tnr_rev(idx_d,idx_r1,idx_r) &amp;   ! RAIN2M<a name='4533'></font>
<font color=#447700>!                    * odts))<a name='4534'></font>
<a name='4535'>
      end subroutine table_dropEvap<a name='4536'>
<font color=#447700>!<a name='4537'></font>
<font color=#447700>!ctrlL<a name='4538'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4539'></font>
<font color=#447700>!..Fill the table of CCN activation data created from parcel model run<a name='4540'></font>
<font color=#447700>!.. by Trude Eidhammer with inputs of aerosol number concentration,<a name='4541'></font>
<font color=#447700>!.. vertical velocity, temperature, lognormal mean aerosol radius, and<a name='4542'></font>
<font color=#447700>!.. hygroscopicity, kappa.  The data are read from external file and<a name='4543'></font>
<font color=#447700>!.. contain activated fraction of CCN for given conditions.<a name='4544'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4545'></font>
<a name='4546'>
<A NAME='TABLE_CCNACT'><A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_CCNACT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4547'>
      <font color=#993300>subroutine </font><font color=#cc0000>table_ccnAct</font> <A href='../../call_to/TABLE_CCNACT.html' TARGET='index'>1</A>,<A href='../../call_from/TABLE_CCNACT.html' TARGET='index'>8</A><a name='4548'>
<a name='4549'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_CCNACT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_239"><a name='4550'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_CCNACT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_160"><a name='4551'>
      implicit none<a name='4552'>
<a name='4553'>
      LOGICAL, EXTERNAL:: wrf_dm_on_monitor<a name='4554'>
<a name='4555'>
<font color=#447700>!..Local variables<a name='4556'></font>
      INTEGER:: iunit_mp_th1, i<a name='4557'>
      LOGICAL:: opened<a name='4558'>
      CHARACTER*64 errmess<a name='4559'>
<a name='4560'>
      iunit_mp_th1 = -1<a name='4561'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='4562'>
        DO i = 20,99<a name='4563'>
          INQUIRE ( i , OPENED = opened )<a name='4564'>
          IF ( .NOT. opened ) THEN<a name='4565'>
            iunit_mp_th1 = i<a name='4566'>
            GOTO 2010<a name='4567'>
          ENDIF<a name='4568'>
        ENDDO<a name='4569'>
 2010   CONTINUE<a name='4570'>
      ENDIF<a name='4571'>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='4572'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_CCNACT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_289"> ( iunit_mp_th1 , IWORDSIZE )<a name='4573'>
#endif<a name='4574'>
      IF ( iunit_mp_th1 &lt; 0 ) THEN<a name='4575'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_CCNACT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_887"> ( 'module_mp_thompson: table_ccnAct: '//   &amp;<a name='4576'>
           'Can not find unused fortran unit to read in lookup table.')<a name='4577'>
      ENDIF<a name='4578'>
<a name='4579'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='4580'>
        WRITE(errmess, '(A,I2)') 'module_mp_thompson: opening CCN_ACTIVATE.BIN on unit ',iunit_mp_th1<a name='4581'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_CCNACT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_692">(150, errmess)<a name='4582'>
        OPEN(iunit_mp_th1,FILE='CCN_ACTIVATE.BIN',                      &amp;<a name='4583'>
             FORM='UNFORMATTED',STATUS='OLD',ERR=9009)<a name='4584'>
      ENDIF<a name='4585'>
<a name='4586'>
#define DM_BCAST_MACRO(A) CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_CCNACT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_290">(A, size(A)*R4SIZE)<a name='4587'>
<a name='4588'>
      IF ( wrf_dm_on_monitor() ) READ(iunit_mp_th1,ERR=9010) tnccn_act<a name='4589'>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='4590'></font>
      DM_BCAST_MACRO(tnccn_act)<a name='4591'>
#endif<a name='4592'>
<a name='4593'>
<a name='4594'>
      RETURN<a name='4595'>
 9009 CONTINUE<a name='4596'>
      WRITE( errmess , '(A,I2)' ) 'module_mp_thompson: error opening CCN_ACTIVATE.BIN on unit ',iunit_mp_th1<a name='4597'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_CCNACT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_888">(errmess)<a name='4598'>
      RETURN<a name='4599'>
 9010 CONTINUE<a name='4600'>
      WRITE( errmess , '(A,I2)' ) 'module_mp_thompson: error reading CCN_ACTIVATE.BIN on unit ',iunit_mp_th1<a name='4601'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_thompson.F.html#TABLE_CCNACT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_889">(errmess)<a name='4602'>
<a name='4603'>
      end subroutine table_ccnAct<a name='4604'>
<font color=#447700>!^L<a name='4605'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4606'></font>
<font color=#447700>!..Retrieve fraction of CCN that gets activated given the model temp,<a name='4607'></font>
<font color=#447700>!.. vertical velocity, and available CCN concentration.  The lookup<a name='4608'></font>
<font color=#447700>!.. table (read from external file) has CCN concentration varying the<a name='4609'></font>
<font color=#447700>!.. quickest, then updraft, then temperature, then mean aerosol radius,<a name='4610'></font>
<font color=#447700>!.. and finally hygroscopicity, kappa.<a name='4611'></font>
<font color=#447700>!.. TO_DO ITEM:  For radiation cooling producing fog, in which case the<a name='4612'></font>
<font color=#447700>!.. updraft velocity could easily be negative, we could use the temp<a name='4613'></font>
<font color=#447700>!.. and its tendency to diagnose a pretend postive updraft velocity.<a name='4614'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4615'></font>
<A NAME='ACTIV_NCLOUD'><A href='../../html_code/phys/module_mp_thompson.F.html#ACTIV_NCLOUD' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4616'>
      real <font color=#993300>function </font><font color=#cc0000>activ_ncloud</font>(Tt, Ww, NCCN)<a name='4617'>
<a name='4618'>
      implicit none<a name='4619'>
      REAL, INTENT(IN):: Tt, Ww, NCCN<a name='4620'>
      REAL:: n_local, w_local<a name='4621'>
      INTEGER:: i, j, k, l, m, n<a name='4622'>
      REAL:: A, B, C, D, t, u, x1, x2, y1, y2, nx, wy, fraction<a name='4623'>
<a name='4624'>
<a name='4625'>
<font color=#447700>!     ta_Na = (/10.0, 31.6, 100.0, 316.0, 1000.0, 3160.0, 10000.0/)  ntb_arc<a name='4626'></font>
<font color=#447700>!     ta_Ww = (/0.01, 0.0316, 0.1, 0.316, 1.0, 3.16, 10.0, 31.6, 100.0/)  ntb_arw<a name='4627'></font>
<font color=#447700>!     ta_Tk = (/243.15, 253.15, 263.15, 273.15, 283.15, 293.15, 303.15/)  ntb_art<a name='4628'></font>
<font color=#447700>!     ta_Ra = (/0.01, 0.02, 0.04, 0.08, 0.16/)  ntb_arr<a name='4629'></font>
<font color=#447700>!     ta_Ka = (/0.2, 0.4, 0.6, 0.8/)  ntb_ark<a name='4630'></font>
<a name='4631'>
      n_local = NCCN * 1.E-6<a name='4632'>
      w_local = Ww<a name='4633'>
<a name='4634'>
      if (n_local .ge. ta_Na(ntb_arc)) then<a name='4635'>
         n_local = ta_Na(ntb_arc) - 1.0<a name='4636'>
      elseif (n_local .le. ta_Na(1)) then<a name='4637'>
         n_local = ta_Na(1) + 1.0<a name='4638'>
      endif<a name='4639'>
      do n = 2, ntb_arc<a name='4640'>
         if (n_local.ge.ta_Na(n-1) .and. n_local.lt.ta_Na(n)) goto 8003<a name='4641'>
      enddo<a name='4642'>
 8003 continue<a name='4643'>
      i = n<a name='4644'>
      x1 = LOG(ta_Na(i-1))<a name='4645'>
      x2 = LOG(ta_Na(i))<a name='4646'>
<a name='4647'>
      if (w_local .ge. ta_Ww(ntb_arw)) then<a name='4648'>
         w_local = ta_Ww(ntb_arw) - 1.0<a name='4649'>
      elseif (w_local .le. ta_Ww(1)) then<a name='4650'>
         w_local = ta_Ww(1) + 0.001<a name='4651'>
      endif<a name='4652'>
      do n = 2, ntb_arw<a name='4653'>
         if (w_local.ge.ta_Ww(n-1) .and. w_local.lt.ta_Ww(n)) goto 8005<a name='4654'>
      enddo<a name='4655'>
 8005 continue<a name='4656'>
      j = n<a name='4657'>
      y1 = LOG(ta_Ww(j-1))<a name='4658'>
      y2 = LOG(ta_Ww(j))<a name='4659'>
<a name='4660'>
      k = MAX(1, MIN( NINT( (Tt - ta_Tk(1))*0.1) + 1, ntb_art))<a name='4661'>
<a name='4662'>
<font color=#447700>!..The next two values are indexes of mean aerosol radius and<a name='4663'></font>
<font color=#447700>!.. hygroscopicity.  Currently these are constant but a future version<a name='4664'></font>
<font color=#447700>!.. should implement other variables to allow more freedom such as<a name='4665'></font>
<font color=#447700>!.. at least simple separation of tiny size sulfates from larger<a name='4666'></font>
<font color=#447700>!.. sea salts.<a name='4667'></font>
      l = 3<a name='4668'>
      m = 2<a name='4669'>
<a name='4670'>
      A = tnccn_act(i-1,j-1,k,l,m)<a name='4671'>
      B = tnccn_act(i,j-1,k,l,m)<a name='4672'>
      C = tnccn_act(i,j,k,l,m)<a name='4673'>
      D = tnccn_act(i-1,j,k,l,m)<a name='4674'>
      nx = LOG(n_local)<a name='4675'>
      wy = LOG(w_local)<a name='4676'>
<a name='4677'>
      t = (nx-x1)/(x2-x1)<a name='4678'>
      u = (wy-y1)/(y2-y1)<a name='4679'>
<a name='4680'>
<font color=#447700>!     t = (n_local-ta(Na(i-1))/(ta_Na(i)-ta_Na(i-1))<a name='4681'></font>
<font color=#447700>!     u = (w_local-ta_Ww(j-1))/(ta_Ww(j)-ta_Ww(j-1))<a name='4682'></font>
<a name='4683'>
      fraction = (1.0-t)*(1.0-u)*A + t*(1.0-u)*B + t*u*C + (1.0-t)*u*D<a name='4684'>
<a name='4685'>
<font color=#447700>!     if (NCCN*fraction .gt. 0.75*Nt_c_max) then<a name='4686'></font>
<font color=#447700>!        write(*,*) ' DEBUG-GT ', n_local, w_local, Tt, i, j, k<a name='4687'></font>
<font color=#447700>!     endif<a name='4688'></font>
<a name='4689'>
      activ_ncloud = NCCN*fraction<a name='4690'>
<a name='4691'>
      end function activ_ncloud<a name='4692'>
<a name='4693'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4694'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4695'></font>
<A NAME='GCF'><A href='../../html_code/phys/module_mp_thompson.F.html#GCF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4696'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>GCF</font>(GAMMCF,A,X,GLN) <A href='../../call_to/GCF.html' TARGET='index'>1</A>,<A href='../../call_from/GCF.html' TARGET='index'>1</A><a name='4697'>
<font color=#447700>!     --- RETURNS THE INCOMPLETE GAMMA FUNCTION Q(A,X) EVALUATED BY ITS<a name='4698'></font>
<font color=#447700>!     --- CONTINUED FRACTION REPRESENTATION AS GAMMCF.  ALSO RETURNS<a name='4699'></font>
<font color=#447700>!     --- LN(GAMMA(A)) AS GLN.  THE CONTINUED FRACTION IS EVALUATED BY<a name='4700'></font>
<font color=#447700>!     --- A MODIFIED LENTZ METHOD.<a name='4701'></font>
<font color=#447700>!     --- USES GAMMLN<a name='4702'></font>
      IMPLICIT NONE<a name='4703'>
      INTEGER, PARAMETER:: ITMAX=100<a name='4704'>
      REAL, PARAMETER:: gEPS=3.E-7<a name='4705'>
      REAL, PARAMETER:: FPMIN=1.E-30<a name='4706'>
      REAL, INTENT(IN):: A, X<a name='4707'>
      REAL:: GAMMCF,GLN<a name='4708'>
      INTEGER:: I<a name='4709'>
      REAL:: AN,B,C,D,DEL,H<a name='4710'>
      GLN=<A href='../../html_code/phys/module_mp_thompson.F.html#GAMMLN'>GAMMLN</A><A href='../../html_code/phys/module_mp_thompson.F.html#GCF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMLN_3">(A)<a name='4711'>
      B=X+1.-A<a name='4712'>
      C=1./FPMIN<a name='4713'>
      D=1./B<a name='4714'>
      H=D<a name='4715'>
      DO 11 I=1,ITMAX<a name='4716'>
        AN=-I*(I-A)<a name='4717'>
        B=B+2.<a name='4718'>
        D=AN*D+B<a name='4719'>
        IF(ABS(D).LT.FPMIN)D=FPMIN<a name='4720'>
        C=B+AN/C<a name='4721'>
        IF(ABS(C).LT.FPMIN)C=FPMIN<a name='4722'>
        D=1./D<a name='4723'>
        DEL=D*C<a name='4724'>
        H=H*DEL<a name='4725'>
        IF(ABS(DEL-1.).LT.gEPS)GOTO 1<a name='4726'>
 11   CONTINUE<a name='4727'>
      PRINT *, 'A TOO LARGE, ITMAX TOO SMALL IN GCF'<a name='4728'>
 1    GAMMCF=EXP(-X+A*LOG(X)-GLN)*H<a name='4729'>
      END SUBROUTINE GCF<a name='4730'>
<font color=#447700>!  (C) Copr. 1986-92 Numerical Recipes Software 2.02<a name='4731'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4732'></font>
<A NAME='GSER'><A href='../../html_code/phys/module_mp_thompson.F.html#GSER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4733'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>GSER</font>(GAMSER,A,X,GLN) <A href='../../call_to/GSER.html' TARGET='index'>2</A>,<A href='../../call_from/GSER.html' TARGET='index'>2</A><a name='4734'>
<font color=#447700>!     --- RETURNS THE INCOMPLETE GAMMA FUNCTION P(A,X) EVALUATED BY ITS<a name='4735'></font>
<font color=#447700>!     --- ITS SERIES REPRESENTATION AS GAMSER.  ALSO RETURNS LN(GAMMA(A)) <a name='4736'></font>
<font color=#447700>!     --- AS GLN.<a name='4737'></font>
<font color=#447700>!     --- USES GAMMLN<a name='4738'></font>
      IMPLICIT NONE<a name='4739'>
      INTEGER, PARAMETER:: ITMAX=100<a name='4740'>
      REAL, PARAMETER:: gEPS=3.E-7<a name='4741'>
      REAL, INTENT(IN):: A, X<a name='4742'>
      REAL:: GAMSER,GLN<a name='4743'>
      INTEGER:: N<a name='4744'>
      REAL:: AP,DEL,SUM<a name='4745'>
      GLN=<A href='../../html_code/phys/module_mp_thompson.F.html#GAMMLN'>GAMMLN</A><A href='../../html_code/phys/module_mp_thompson.F.html#GSER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMLN_4">(A)<a name='4746'>
      IF(X.LE.0.)THEN<a name='4747'>
        IF(X.LT.0.) PRINT *, 'X &lt; 0 IN GSER'<a name='4748'>
        GAMSER=0.<a name='4749'>
        RETURN<a name='4750'>
      ENDIF<a name='4751'>
      AP=A<a name='4752'>
      SUM=1./A<a name='4753'>
      DEL=SUM<a name='4754'>
      DO 11 N=1,ITMAX<a name='4755'>
        AP=AP+1.<a name='4756'>
        DEL=DEL*X/AP<a name='4757'>
        SUM=SUM+DEL<a name='4758'>
        IF(ABS(DEL).LT.ABS(SUM)*gEPS)GOTO 1<a name='4759'>
 11   CONTINUE<a name='4760'>
      PRINT *,'A TOO LARGE, ITMAX TOO SMALL IN GSER'<a name='4761'>
 1    GAMSER=SUM*EXP(-X+A*LOG(X)-GLN)<a name='4762'>
      END SUBROUTINE GSER<a name='4763'>
<font color=#447700>!  (C) Copr. 1986-92 Numerical Recipes Software 2.02<a name='4764'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4765'></font>
<A NAME='GAMMLN'><A href='../../html_code/phys/module_mp_thompson.F.html#GAMMLN' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4766'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>GAMMLN</font>(XX) <A href='../../call_to/GAMMLN.html' TARGET='index'>4</A><a name='4767'>
<font color=#447700>!     --- RETURNS THE VALUE LN(GAMMA(XX)) FOR XX &gt; 0.<a name='4768'></font>
      IMPLICIT NONE<a name='4769'>
      REAL, INTENT(IN):: XX<a name='4770'>
      DOUBLE PRECISION, PARAMETER:: STP = 2.5066282746310005D0<a name='4771'>
      DOUBLE PRECISION, DIMENSION(6), PARAMETER:: &amp;<a name='4772'>
               COF = (/76.18009172947146D0, -86.50532032941677D0, &amp;<a name='4773'>
                       24.01409824083091D0, -1.231739572450155D0, &amp;<a name='4774'>
                      .1208650973866179D-2, -.5395239384953D-5/)<a name='4775'>
      DOUBLE PRECISION:: SER,TMP,X,Y<a name='4776'>
      INTEGER:: J<a name='4777'>
<a name='4778'>
      X=XX<a name='4779'>
      Y=X<a name='4780'>
      TMP=X+5.5D0<a name='4781'>
      TMP=(X+0.5D0)*LOG(TMP)-TMP<a name='4782'>
      SER=1.000000000190015D0<a name='4783'>
      DO 11 J=1,6<a name='4784'>
        Y=Y+1.D0<a name='4785'>
        SER=SER+COF(J)/Y<a name='4786'>
11    CONTINUE<a name='4787'>
      GAMMLN=TMP+LOG(STP*SER/X)<a name='4788'>
      END FUNCTION GAMMLN<a name='4789'>
<font color=#447700>!  (C) Copr. 1986-92 Numerical Recipes Software 2.02<a name='4790'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4791'></font>
<A NAME='GAMMP'><A href='../../html_code/phys/module_mp_thompson.F.html#GAMMP' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4792'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>GAMMP</font>(A,X) <A href='../../call_to/GAMMP.html' TARGET='index'>2</A>,<A href='../../call_from/GAMMP.html' TARGET='index'>4</A><a name='4793'>
<font color=#447700>!     --- COMPUTES THE INCOMPLETE GAMMA FUNCTION P(A,X)<a name='4794'></font>
<font color=#447700>!     --- SEE ABRAMOWITZ AND STEGUN 6.5.1<a name='4795'></font>
<font color=#447700>!     --- USES GCF,GSER<a name='4796'></font>
      IMPLICIT NONE<a name='4797'>
      REAL, INTENT(IN):: A,X<a name='4798'>
      REAL:: GAMMCF,GAMSER,GLN<a name='4799'>
      GAMMP = 0.<a name='4800'>
      IF((X.LT.0.) .OR. (A.LE.0.)) THEN<a name='4801'>
        PRINT *, 'BAD ARGUMENTS IN GAMMP'<a name='4802'>
        RETURN<a name='4803'>
      ELSEIF(X.LT.A+1.)THEN<a name='4804'>
        CALL <A href='../../html_code/phys/module_mp_thompson.F.html#GSER'>GSER</A><A href='../../html_code/phys/module_mp_thompson.F.html#GAMMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GSER_2">(GAMSER,A,X,GLN)<a name='4805'>
        GAMMP=GAMSER<a name='4806'>
      ELSE<a name='4807'>
        CALL <A href='../../html_code/phys/module_mp_thompson.F.html#GCF'>GCF</A><A href='../../html_code/phys/module_mp_thompson.F.html#GAMMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GCF_1">(GAMMCF,A,X,GLN)<a name='4808'>
        GAMMP=1.-GAMMCF<a name='4809'>
      ENDIF<a name='4810'>
      END FUNCTION GAMMP<a name='4811'>
<font color=#447700>!  (C) Copr. 1986-92 Numerical Recipes Software 2.02<a name='4812'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4813'></font>
<A NAME='WGAMMA'><A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4814'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>WGAMMA</font>(y) <A href='../../call_to/WGAMMA.html' TARGET='index'>20</A><a name='4815'>
<a name='4816'>
      IMPLICIT NONE<a name='4817'>
      REAL, INTENT(IN):: y<a name='4818'>
<a name='4819'>
      WGAMMA = EXP(GAMMLN(y))<a name='4820'>
<a name='4821'>
      END FUNCTION WGAMMA<a name='4822'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4823'></font>
<font color=#447700>! THIS FUNCTION CALCULATES THE LIQUID SATURATION VAPOR MIXING RATIO AS<a name='4824'></font>
<font color=#447700>! A FUNCTION OF TEMPERATURE AND PRESSURE<a name='4825'></font>
<font color=#447700>!<a name='4826'></font>
<A NAME='RSLF'><A href='../../html_code/phys/module_mp_thompson.F.html#RSLF' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4827'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>RSLF</font>(P,T) <A href='../../call_to/RSLF.html' TARGET='index'>9</A><a name='4828'>
<a name='4829'>
      IMPLICIT NONE<a name='4830'>
      REAL, INTENT(IN):: P, T<a name='4831'>
      REAL:: ESL,X<a name='4832'>
      REAL, PARAMETER:: C0= .611583699E03<a name='4833'>
      REAL, PARAMETER:: C1= .444606896E02<a name='4834'>
      REAL, PARAMETER:: C2= .143177157E01<a name='4835'>
      REAL, PARAMETER:: C3= .264224321E-1<a name='4836'>
      REAL, PARAMETER:: C4= .299291081E-3<a name='4837'>
      REAL, PARAMETER:: C5= .203154182E-5<a name='4838'>
      REAL, PARAMETER:: C6= .702620698E-8<a name='4839'>
      REAL, PARAMETER:: C7= .379534310E-11<a name='4840'>
      REAL, PARAMETER:: C8=-.321582393E-13<a name='4841'>
<a name='4842'>
      X=MAX(-80.,T-273.16)<a name='4843'>
<a name='4844'>
<font color=#447700>!      ESL=612.2*EXP(17.67*X/(T-29.65))<a name='4845'></font>
      ESL=C0+X*(C1+X*(C2+X*(C3+X*(C4+X*(C5+X*(C6+X*(C7+X*C8)))))))<a name='4846'>
      ESL=MIN(ESL, P*0.15)        <font color=#447700>! Even with P=1050mb and T=55C, the sat. vap. pres only contributes to ~15% of total pres.<a name='4847'></font>
      RSLF=.622*ESL/(P-ESL)<a name='4848'>
<a name='4849'>
<font color=#447700>!    ALTERNATIVE<a name='4850'></font>
<font color=#447700>!  ; Source: Murphy and Koop, Review of the vapour pressure of ice and<a name='4851'></font>
<font color=#447700>!             supercooled water for atmospheric applications, Q. J. R.<a name='4852'></font>
<font color=#447700>!             Meteorol. Soc (2005), 131, pp. 1539-1565.<a name='4853'></font>
<font color=#447700>!    ESL = EXP(54.842763 - 6763.22 / T - 4.210 * ALOG(T) + 0.000367 * T<a name='4854'></font>
<font color=#447700>!        + TANH(0.0415 * (T - 218.8)) * (53.878 - 1331.22<a name='4855'></font>
<font color=#447700>!        / T - 9.44523 * ALOG(T) + 0.014025 * T))<a name='4856'></font>
<a name='4857'>
      END FUNCTION RSLF<a name='4858'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4859'></font>
<font color=#447700>! THIS FUNCTION CALCULATES THE ICE SATURATION VAPOR MIXING RATIO AS A<a name='4860'></font>
<font color=#447700>! FUNCTION OF TEMPERATURE AND PRESSURE<a name='4861'></font>
<font color=#447700>!<a name='4862'></font>
<A NAME='RSIF'><A href='../../html_code/phys/module_mp_thompson.F.html#RSIF' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4863'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>RSIF</font>(P,T) <A href='../../call_to/RSIF.html' TARGET='index'>4</A><a name='4864'>
<a name='4865'>
      IMPLICIT NONE<a name='4866'>
      REAL, INTENT(IN):: P, T<a name='4867'>
      REAL:: ESI,X<a name='4868'>
      REAL, PARAMETER:: C0= .609868993E03<a name='4869'>
      REAL, PARAMETER:: C1= .499320233E02<a name='4870'>
      REAL, PARAMETER:: C2= .184672631E01<a name='4871'>
      REAL, PARAMETER:: C3= .402737184E-1<a name='4872'>
      REAL, PARAMETER:: C4= .565392987E-3<a name='4873'>
      REAL, PARAMETER:: C5= .521693933E-5<a name='4874'>
      REAL, PARAMETER:: C6= .307839583E-7<a name='4875'>
      REAL, PARAMETER:: C7= .105785160E-9<a name='4876'>
      REAL, PARAMETER:: C8= .161444444E-12<a name='4877'>
<a name='4878'>
      X=MAX(-80.,T-273.16)<a name='4879'>
      ESI=C0+X*(C1+X*(C2+X*(C3+X*(C4+X*(C5+X*(C6+X*(C7+X*C8)))))))<a name='4880'>
      ESI=MIN(ESI, P*0.15)<a name='4881'>
      RSIF=.622*ESI/(P-ESI)<a name='4882'>
<a name='4883'>
<font color=#447700>!    ALTERNATIVE<a name='4884'></font>
<font color=#447700>!  ; Source: Murphy and Koop, Review of the vapour pressure of ice and<a name='4885'></font>
<font color=#447700>!             supercooled water for atmospheric applications, Q. J. R.<a name='4886'></font>
<font color=#447700>!             Meteorol. Soc (2005), 131, pp. 1539-1565.<a name='4887'></font>
<font color=#447700>!     ESI = EXP(9.550426 - 5723.265/T + 3.53068*ALOG(T) - 0.00728332*T)<a name='4888'></font>
<a name='4889'>
      END FUNCTION RSIF<a name='4890'>
<a name='4891'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4892'></font>
<A NAME='ICEDEMOTT'><A href='../../html_code/phys/module_mp_thompson.F.html#ICEDEMOTT' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4893'>
      real <font color=#993300>function </font><font color=#cc0000>iceDeMott</font>(tempc, qv, qvs, qvsi, rho, nifa) <A href='../../call_to/ICEDEMOTT.html' TARGET='index'>2</A><a name='4894'>
      implicit none<a name='4895'>
<a name='4896'>
      REAL, INTENT(IN):: tempc, qv, qvs, qvsi, rho, nifa<a name='4897'>
<a name='4898'>
<font color=#447700>!..Local vars<a name='4899'></font>
      REAL:: satw, sati, siw, p_x, si0x, dtt, dsi, dsw, dab, fc, hx<a name='4900'>
      REAL:: ntilde, n_in, nmax, nhat, mux, xni, nifa_cc<a name='4901'>
      REAL, PARAMETER:: p_c1    = 1000.<a name='4902'>
      REAL, PARAMETER:: p_rho_c = 0.76<a name='4903'>
      REAL, PARAMETER:: p_alpha = 1.0<a name='4904'>
      REAL, PARAMETER:: p_gam   = 2.<a name='4905'>
      REAL, PARAMETER:: delT    = 5.<a name='4906'>
      REAL, PARAMETER:: T0x     = -40.<a name='4907'>
      REAL, PARAMETER:: Sw0x    = 0.97<a name='4908'>
      REAL, PARAMETER:: delSi   = 0.1<a name='4909'>
      REAL, PARAMETER:: hdm     = 0.15<a name='4910'>
      REAL, PARAMETER:: p_psi   = 0.058707*p_gam/p_rho_c<a name='4911'>
      REAL, PARAMETER:: aap     = 1.<a name='4912'>
      REAL, PARAMETER:: bbp     = 0.<a name='4913'>
      REAL, PARAMETER:: y1p     = -35.<a name='4914'>
      REAL, PARAMETER:: y2p     = -25.<a name='4915'>
      REAL, PARAMETER:: rho_not0 = 101325./(287.05*273.15)<a name='4916'>
<a name='4917'>
<font color=#447700>!+---+<a name='4918'></font>
<a name='4919'>
      xni = 0.0<a name='4920'>
<font color=#447700>!     satw = qv/qvs<a name='4921'></font>
<font color=#447700>!     sati = qv/qvsi<a name='4922'></font>
<font color=#447700>!     siw = qvs/qvsi<a name='4923'></font>
<font color=#447700>!     p_x = -1.0261+(3.1656e-3*tempc)+(5.3938e-4*(tempc*tempc))         &amp;<a name='4924'></font>
<font color=#447700>!                +  (8.2584e-6*(tempc*tempc*tempc))<a name='4925'></font>
<font color=#447700>!     si0x = 1.+(10.**p_x)<a name='4926'></font>
<font color=#447700>!     if (sati.ge.si0x .and. satw.lt.0.985) then<a name='4927'></font>
<font color=#447700>!        dtt = delta_p (tempc, T0x, T0x+delT, 1., hdm)<a name='4928'></font>
<font color=#447700>!        dsi = delta_p (sati, Si0x, Si0x+delSi, 0., 1.)<a name='4929'></font>
<font color=#447700>!        dsw = delta_p (satw, Sw0x, 1., 0., 1.)<a name='4930'></font>
<font color=#447700>!        fc = dtt*dsi*0.5<a name='4931'></font>
<font color=#447700>!        hx = min(fc+((1.-fc)*dsw), 1.)<a name='4932'></font>
<font color=#447700>!        ntilde = p_c1*p_gam*((exp(12.96*(sati-1.1)))**0.3) / p_rho_c<a name='4933'></font>
<font color=#447700>!        if (tempc .le. y1p) then<a name='4934'></font>
<font color=#447700>!           n_in = ntilde<a name='4935'></font>
<font color=#447700>!        elseif (tempc .ge. y2p) then<a name='4936'></font>
<font color=#447700>!           n_in = p_psi*p_c1*exp(12.96*(sati-1.)-0.639)<a name='4937'></font>
<font color=#447700>!        else<a name='4938'></font>
<font color=#447700>!           if (tempc .le. -30.) then<a name='4939'></font>
<font color=#447700>!              nmax = p_c1*p_gam*(exp(12.96*(siw-1.1)))**0.3/p_rho_c<a name='4940'></font>
<font color=#447700>!           else<a name='4941'></font>
<font color=#447700>!              nmax = p_psi*p_c1*exp(12.96*(siw-1.)-0.639)<a name='4942'></font>
<font color=#447700>!           endif<a name='4943'></font>
<font color=#447700>!           ntilde = MIN(ntilde, nmax)<a name='4944'></font>
<font color=#447700>!           nhat = MIN(p_psi*p_c1*exp(12.96*(sati-1.)-0.639), nmax)<a name='4945'></font>
<font color=#447700>!           dab = delta_p (tempc, y1p, y2p, aap, bbp)<a name='4946'></font>
<font color=#447700>!           n_in = MIN(nhat*(ntilde/nhat)**dab, nmax)<a name='4947'></font>
<font color=#447700>!        endif<a name='4948'></font>
<font color=#447700>!        mux = hx*p_alpha*n_in*rho<a name='4949'></font>
<font color=#447700>!        xni = mux*((6700.*nifa)-200.)/((6700.*5.E5)-200.)<a name='4950'></font>
<font color=#447700>!     elseif (satw.ge.0.985 .and. tempc.gt.HGFR-273.15) then<a name='4951'></font>
         nifa_cc = nifa*RHO_NOT0*1.E-6/rho<a name='4952'>
<font color=#447700>!        xni  = 3.*nifa_cc**(1.25)*exp((0.46*(-tempc))-11.6)              !  [DeMott, 2015]<a name='4953'></font>
         xni = (5.94e-5*(-tempc)**3.33)                                 &amp; <font color=#447700>!  [DeMott, 2010]<a name='4954'></font>
                    * (nifa_cc**((-0.0264*(tempc))+0.0033))<a name='4955'>
         xni = xni*rho/RHO_NOT0 * 1000.<a name='4956'>
<font color=#447700>!     endif<a name='4957'></font>
<a name='4958'>
      iceDeMott = MAX(0., xni)<a name='4959'>
<a name='4960'>
      end FUNCTION iceDeMott<a name='4961'>
<a name='4962'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4963'></font>
<font color=#447700>!..Newer research since Koop et al (2001) suggests that the freezing<a name='4964'></font>
<font color=#447700>!.. rate should be lower than original paper, so J_rate is reduced<a name='4965'></font>
<font color=#447700>!.. by two orders of magnitude.<a name='4966'></font>
<a name='4967'>
<A NAME='ICEKOOP'><A href='../../html_code/phys/module_mp_thompson.F.html#ICEKOOP' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4968'>
      real <font color=#993300>function </font><font color=#cc0000>iceKoop</font>(temp, qv, qvs, naero, dt) <A href='../../call_to/ICEKOOP.html' TARGET='index'>1</A><a name='4969'>
      implicit none<a name='4970'>
<a name='4971'>
      REAL, INTENT(IN):: temp, qv, qvs, naero, DT<a name='4972'>
      REAL:: mu_diff, a_w_i, delta_aw, log_J_rate, J_rate, prob_h, satw<a name='4973'>
      REAL:: xni<a name='4974'>
<a name='4975'>
      xni = 0.0<a name='4976'>
      satw = qv/qvs<a name='4977'>
      mu_diff    = 210368.0 + (131.438*temp) - (3.32373E6/temp)         &amp;<a name='4978'>
     &amp;           - (41729.1*alog(temp))<a name='4979'>
      a_w_i      = exp(mu_diff/(R_uni*temp))<a name='4980'>
      delta_aw   = satw - a_w_i<a name='4981'>
      log_J_rate = -906.7 + (8502.0*delta_aw)                           &amp;<a name='4982'>
     &amp;           - (26924.0*delta_aw*delta_aw)                          &amp;<a name='4983'>
     &amp;           + (29180.0*delta_aw*delta_aw*delta_aw)<a name='4984'>
      log_J_rate = MIN(20.0, log_J_rate)<a name='4985'>
      J_rate     = 10.**log_J_rate                                       <font color=#447700>! cm-3 s-1<a name='4986'></font>
      prob_h     = MIN(1.-exp(-J_rate*ar_volume*DT), 1.)<a name='4987'>
      if (prob_h .gt. 0.) then<a name='4988'>
         xni     = MIN(prob_h*naero, 1000.E3)<a name='4989'>
      endif<a name='4990'>
<a name='4991'>
      iceKoop = MAX(0.0, xni)<a name='4992'>
<a name='4993'>
      end FUNCTION iceKoop<a name='4994'>
<a name='4995'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='4996'></font>
<font color=#447700>!.. Helper routine for Phillips et al (2008) ice nucleation.  Trude<a name='4997'></font>
<a name='4998'>
<A NAME='DELTA_P'><A href='../../html_code/phys/module_mp_thompson.F.html#DELTA_P' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4999'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>delta_p</font> (yy, y1, y2, aa, bb)<a name='5000'>
      IMPLICIT NONE<a name='5001'>
<a name='5002'>
      REAL, INTENT(IN):: yy, y1, y2, aa, bb<a name='5003'>
      REAL:: dab, A, B, a0, a1, a2, a3<a name='5004'>
<a name='5005'>
      A   = 6.*(aa-bb)/((y2-y1)*(y2-y1)*(y2-y1))<a name='5006'>
      B   = aa+(A*y1*y1*y1/6.)-(A*y1*y1*y2*0.5)<a name='5007'>
      a0  = B<a name='5008'>
      a1  = A*y1*y2<a name='5009'>
      a2  = -A*(y1+y2)*0.5<a name='5010'>
      a3  = A/3.<a name='5011'>
<a name='5012'>
      if (yy.le.y1) then <a name='5013'>
         dab = aa<a name='5014'>
      else if (yy.ge.y2) then<a name='5015'>
         dab = bb<a name='5016'>
      else<a name='5017'>
         dab = a0+(a1*yy)+(a2*yy*yy)+(a3*yy*yy*yy)<a name='5018'>
      endif<a name='5019'>
<a name='5020'>
      if (dab.lt.aa) then <a name='5021'>
         dab = aa<a name='5022'>
      endif<a name='5023'>
      if (dab.gt.bb) then <a name='5024'>
         dab = bb<a name='5025'>
      endif<a name='5026'>
      delta_p = dab<a name='5027'>
<a name='5028'>
      END FUNCTION delta_p <a name='5029'>
<a name='5030'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5031'></font>
<font color=#447700>!ctrlL<a name='5032'></font>
<a name='5033'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5034'></font>
<font color=#447700>!..Compute _radiation_ effective radii of cloud water, ice, and snow.<a name='5035'></font>
<font color=#447700>!.. These are entirely consistent with microphysics assumptions, not<a name='5036'></font>
<font color=#447700>!.. constant or otherwise ad hoc as is internal to most radiation<a name='5037'></font>
<font color=#447700>!.. schemes.  Since only the smallest snowflakes should impact<a name='5038'></font>
<font color=#447700>!.. radiation, compute from first portion of complicated Field number<a name='5039'></font>
<font color=#447700>!.. distribution, not the second part, which is the larger sizes.<a name='5040'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5041'></font>
<a name='5042'>
<A NAME='CALC_EFFECTRAD'><A href='../../html_code/phys/module_mp_thompson.F.html#CALC_EFFECTRAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5043'>
      <font color=#993300>subroutine </font><font color=#cc0000>calc_effectRad</font> (t1d, p1d, qv1d, qc1d, nc1d, qi1d, ni1d, qs1d,   &amp; <A href='../../call_to/CALC_EFFECTRAD.html' TARGET='index'>1</A><a name='5044'>
     &amp;                re_qc1d, re_qi1d, re_qs1d, kts, kte)<a name='5045'>
<a name='5046'>
      IMPLICIT NONE<a name='5047'>
<a name='5048'>
<font color=#447700>!..Sub arguments<a name='5049'></font>
      INTEGER, INTENT(IN):: kts, kte<a name='5050'>
      REAL, DIMENSION(kts:kte), INTENT(IN)::                            &amp;<a name='5051'>
     &amp;                    t1d, p1d, qv1d, qc1d, nc1d, qi1d, ni1d, qs1d<a name='5052'>
      REAL, DIMENSION(kts:kte), INTENT(INOUT):: re_qc1d, re_qi1d, re_qs1d<a name='5053'>
<font color=#447700>!..Local variables<a name='5054'></font>
      INTEGER:: k<a name='5055'>
      REAL, DIMENSION(kts:kte):: rho, rc, nc, ri, ni, rs<a name='5056'>
      REAL:: smo2, smob, smoc<a name='5057'>
      REAL:: tc0, loga_, a_, b_<a name='5058'>
      DOUBLE PRECISION:: lamc, lami<a name='5059'>
      LOGICAL:: has_qc, has_qi, has_qs<a name='5060'>
      INTEGER:: inu_c<a name='5061'>
      real, dimension(15), parameter:: g_ratio = (/24,60,120,210,336,   &amp;<a name='5062'>
     &amp;                504,720,990,1320,1716,2184,2730,3360,4080,4896/)<a name='5063'>
<a name='5064'>
      has_qc = .false.<a name='5065'>
      has_qi = .false.<a name='5066'>
      has_qs = .false.<a name='5067'>
<a name='5068'>
      do k = kts, kte<a name='5069'>
         rho(k) = 0.622*p1d(k)/(R*t1d(k)*(qv1d(k)+0.622))<a name='5070'>
         rc(k) = MAX(R1, qc1d(k)*rho(k))<a name='5071'>
         nc(k) = MAX(R2, nc1d(k)*rho(k))<a name='5072'>
         if (.NOT. is_aerosol_aware) nc(k) = Nt_c<a name='5073'>
         if (rc(k).gt.R1 .and. nc(k).gt.R2) has_qc = .true.<a name='5074'>
         ri(k) = MAX(R1, qi1d(k)*rho(k))<a name='5075'>
         ni(k) = MAX(R2, ni1d(k)*rho(k))<a name='5076'>
         if (ri(k).gt.R1 .and. ni(k).gt.R2) has_qi = .true.<a name='5077'>
         rs(k) = MAX(R1, qs1d(k)*rho(k))<a name='5078'>
         if (rs(k).gt.R1) has_qs = .true.<a name='5079'>
      enddo<a name='5080'>
<a name='5081'>
      if (has_qc) then<a name='5082'>
      do k = kts, kte<a name='5083'>
         if (rc(k).le.R1 .or. nc(k).le.R2) CYCLE<a name='5084'>
         if (nc(k).lt.100) then<a name='5085'>
            inu_c = 15<a name='5086'>
         elseif (nc(k).gt.1.E10) then<a name='5087'>
            inu_c = 2<a name='5088'>
         else<a name='5089'>
            inu_c = MIN(15, NINT(1000.E6/nc(k)) + 2)<a name='5090'>
         endif<a name='5091'>
         lamc = (nc(k)*am_r*g_ratio(inu_c)/rc(k))**obmr<a name='5092'>
         re_qc1d(k) = MAX(2.51E-6, MIN(SNGL(0.5D0 * DBLE(3.+inu_c)/lamc), 50.E-6))<a name='5093'>
      enddo<a name='5094'>
      endif<a name='5095'>
<a name='5096'>
      if (has_qi) then<a name='5097'>
      do k = kts, kte<a name='5098'>
         if (ri(k).le.R1 .or. ni(k).le.R2) CYCLE<a name='5099'>
         lami = (am_i*cig(2)*oig1*ni(k)/ri(k))**obmi<a name='5100'>
         re_qi1d(k) = MAX(5.01E-6, MIN(SNGL(0.5D0 * DBLE(3.+mu_i)/lami), 125.E-6))<a name='5101'>
      enddo<a name='5102'>
      endif<a name='5103'>
<a name='5104'>
      if (has_qs) then<a name='5105'>
      do k = kts, kte<a name='5106'>
         if (rs(k).le.R1) CYCLE<a name='5107'>
         tc0 = MIN(-0.1, t1d(k)-273.15)<a name='5108'>
         smob = rs(k)*oams<a name='5109'>
<a name='5110'>
<font color=#447700>!..All other moments based on reference, 2nd moment.  If bm_s.ne.2,<a name='5111'></font>
<font color=#447700>!.. then we must compute actual 2nd moment and use as reference.<a name='5112'></font>
         if (bm_s.gt.(2.0-1.e-3) .and. bm_s.lt.(2.0+1.e-3)) then<a name='5113'>
            smo2 = smob<a name='5114'>
         else<a name='5115'>
            loga_ = sa(1) + sa(2)*tc0 + sa(3)*bm_s &amp;<a name='5116'>
     &amp;         + sa(4)*tc0*bm_s + sa(5)*tc0*tc0 &amp;<a name='5117'>
     &amp;         + sa(6)*bm_s*bm_s + sa(7)*tc0*tc0*bm_s &amp;<a name='5118'>
     &amp;         + sa(8)*tc0*bm_s*bm_s + sa(9)*tc0*tc0*tc0 &amp;<a name='5119'>
     &amp;         + sa(10)*bm_s*bm_s*bm_s<a name='5120'>
            a_ = 10.0**loga_<a name='5121'>
            b_ = sb(1) + sb(2)*tc0 + sb(3)*bm_s &amp;<a name='5122'>
     &amp;         + sb(4)*tc0*bm_s + sb(5)*tc0*tc0 &amp;<a name='5123'>
     &amp;         + sb(6)*bm_s*bm_s + sb(7)*tc0*tc0*bm_s &amp;<a name='5124'>
     &amp;         + sb(8)*tc0*bm_s*bm_s + sb(9)*tc0*tc0*tc0 &amp;<a name='5125'>
     &amp;         + sb(10)*bm_s*bm_s*bm_s<a name='5126'>
            smo2 = (smob/a_)**(1./b_)<a name='5127'>
         endif<a name='5128'>
<font color=#447700>!..Calculate bm_s+1 (th) moment.  Useful for diameter calcs.<a name='5129'></font>
         loga_ = sa(1) + sa(2)*tc0 + sa(3)*cse(1) &amp;<a name='5130'>
     &amp;         + sa(4)*tc0*cse(1) + sa(5)*tc0*tc0 &amp;<a name='5131'>
     &amp;         + sa(6)*cse(1)*cse(1) + sa(7)*tc0*tc0*cse(1) &amp;<a name='5132'>
     &amp;         + sa(8)*tc0*cse(1)*cse(1) + sa(9)*tc0*tc0*tc0 &amp;<a name='5133'>
     &amp;         + sa(10)*cse(1)*cse(1)*cse(1)<a name='5134'>
         a_ = 10.0**loga_<a name='5135'>
         b_ = sb(1)+ sb(2)*tc0 + sb(3)*cse(1) + sb(4)*tc0*cse(1) &amp;<a name='5136'>
     &amp;        + sb(5)*tc0*tc0 + sb(6)*cse(1)*cse(1) &amp;<a name='5137'>
     &amp;        + sb(7)*tc0*tc0*cse(1) + sb(8)*tc0*cse(1)*cse(1) &amp;<a name='5138'>
     &amp;        + sb(9)*tc0*tc0*tc0 + sb(10)*cse(1)*cse(1)*cse(1)<a name='5139'>
         smoc = a_ * smo2**b_<a name='5140'>
         re_qs1d(k) = MAX(10.E-6, MIN(0.5*(smoc/smob), 999.E-6))<a name='5141'>
      enddo<a name='5142'>
      endif<a name='5143'>
<a name='5144'>
      end subroutine calc_effectRad<a name='5145'>
<a name='5146'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5147'></font>
<font color=#447700>!..Compute radar reflectivity assuming 10 cm wavelength radar and using<a name='5148'></font>
<font color=#447700>!.. Rayleigh approximation.  Only complication is melted snow/graupel<a name='5149'></font>
<font color=#447700>!.. which we treat as water-coated ice spheres and use Uli Blahak's<a name='5150'></font>
<font color=#447700>!.. library of routines.  The meltwater fraction is simply the amount<a name='5151'></font>
<font color=#447700>!.. of frozen species remaining from what initially existed at the<a name='5152'></font>
<font color=#447700>!.. melting level interface.<a name='5153'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5154'></font>
<a name='5155'>
<A NAME='CALC_REFL10CM'><A href='../../html_code/phys/module_mp_thompson.F.html#CALC_REFL10CM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5156'>
      <font color=#993300>subroutine </font><font color=#cc0000>calc_refl10cm</font> (qv1d, qc1d, qr1d, nr1d, qs1d, qg1d,     &amp; <A href='../../call_to/CALC_REFL10CM.html' TARGET='index'>1</A>,<A href='../../call_from/CALC_REFL10CM.html' TARGET='index'>2</A><a name='5157'>
                          t1d, p1d, dBZ, kts, kte, ii, jj)<a name='5158'>
<a name='5159'>
      IMPLICIT NONE<a name='5160'>
<a name='5161'>
<font color=#447700>!..Sub arguments<a name='5162'></font>
      INTEGER, INTENT(IN):: kts, kte, ii, jj<a name='5163'>
      REAL, DIMENSION(kts:kte), INTENT(IN)::                            &amp;<a name='5164'>
                          qv1d, qc1d, qr1d, nr1d, qs1d, qg1d, t1d, p1d<a name='5165'>
      REAL, DIMENSION(kts:kte), INTENT(INOUT):: dBZ<a name='5166'>
<font color=#447700>!     REAL, DIMENSION(kts:kte), INTENT(INOUT):: vt_dBZ<a name='5167'></font>
<a name='5168'>
<font color=#447700>!..Local variables<a name='5169'></font>
      REAL, DIMENSION(kts:kte):: temp, pres, qv, rho, rhof<a name='5170'>
      REAL, DIMENSION(kts:kte):: rc, rr, nr, rs, rg<a name='5171'>
<a name='5172'>
      DOUBLE PRECISION, DIMENSION(kts:kte):: ilamr, ilamg, N0_r, N0_g<a name='5173'>
      REAL, DIMENSION(kts:kte):: mvd_r<a name='5174'>
      REAL, DIMENSION(kts:kte):: smob, smo2, smoc, smoz<a name='5175'>
      REAL:: oM3, M0, Mrat, slam1, slam2, xDs<a name='5176'>
      REAL:: ils1, ils2, t1_vts, t2_vts, t3_vts, t4_vts<a name='5177'>
      REAL:: vtr_dbz_wt, vts_dbz_wt, vtg_dbz_wt<a name='5178'>
<a name='5179'>
      REAL, DIMENSION(kts:kte):: ze_rain, ze_snow, ze_graupel<a name='5180'>
<a name='5181'>
      DOUBLE PRECISION:: N0_exp, N0_min, lam_exp, lamr, lamg<a name='5182'>
      REAL:: a_, b_, loga_, tc0<a name='5183'>
      DOUBLE PRECISION:: fmelt_s, fmelt_g<a name='5184'>
<a name='5185'>
      INTEGER:: i, k, k_0, kbot, n<a name='5186'>
      LOGICAL:: melti<a name='5187'>
      LOGICAL, DIMENSION(kts:kte):: L_qr, L_qs, L_qg<a name='5188'>
<a name='5189'>
      DOUBLE PRECISION:: cback, x, eta, f_d<a name='5190'>
      REAL:: xslw1, ygra1, zans1<a name='5191'>
<a name='5192'>
<font color=#447700>!+---+<a name='5193'></font>
<a name='5194'>
      do k = kts, kte<a name='5195'>
         dBZ(k) = -35.0<a name='5196'>
      enddo<a name='5197'>
<a name='5198'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5199'></font>
<font color=#447700>!..Put column of data into local arrays.<a name='5200'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5201'></font>
      do k = kts, kte<a name='5202'>
         temp(k) = t1d(k)<a name='5203'>
         qv(k) = MAX(1.E-10, qv1d(k))<a name='5204'>
         pres(k) = p1d(k)<a name='5205'>
         rho(k) = 0.622*pres(k)/(R*temp(k)*(qv(k)+0.622))<a name='5206'>
         rhof(k) = SQRT(RHO_NOT/rho(k))<a name='5207'>
         rc(k) = MAX(R1, qc1d(k)*rho(k))<a name='5208'>
         if (qr1d(k) .gt. R1) then<a name='5209'>
            rr(k) = qr1d(k)*rho(k)<a name='5210'>
            nr(k) = MAX(R2, nr1d(k)*rho(k))<a name='5211'>
            lamr = (am_r*crg(3)*org2*nr(k)/rr(k))**obmr<a name='5212'>
            ilamr(k) = 1./lamr<a name='5213'>
            N0_r(k) = nr(k)*org2*lamr**cre(2)<a name='5214'>
            mvd_r(k) = (3.0 + mu_r + 0.672) * ilamr(k)<a name='5215'>
            L_qr(k) = .true.<a name='5216'>
         else<a name='5217'>
            rr(k) = R1<a name='5218'>
            nr(k) = R1<a name='5219'>
            mvd_r(k) = 50.E-6<a name='5220'>
            L_qr(k) = .false.<a name='5221'>
         endif<a name='5222'>
         if (qs1d(k) .gt. R2) then<a name='5223'>
            rs(k) = qs1d(k)*rho(k)<a name='5224'>
            L_qs(k) = .true.<a name='5225'>
         else<a name='5226'>
            rs(k) = R1<a name='5227'>
            L_qs(k) = .false.<a name='5228'>
         endif<a name='5229'>
         if (qg1d(k) .gt. R2) then<a name='5230'>
            rg(k) = qg1d(k)*rho(k)<a name='5231'>
            L_qg(k) = .true.<a name='5232'>
         else<a name='5233'>
            rg(k) = R1<a name='5234'>
            L_qg(k) = .false.<a name='5235'>
         endif<a name='5236'>
      enddo<a name='5237'>
<a name='5238'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5239'></font>
<font color=#447700>!..Calculate y-intercept, slope, and useful moments for snow.<a name='5240'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5241'></font>
      do k = kts, kte<a name='5242'>
         tc0 = MIN(-0.1, temp(k)-273.15)<a name='5243'>
         smob(k) = rs(k)*oams<a name='5244'>
<a name='5245'>
<font color=#447700>!..All other moments based on reference, 2nd moment.  If bm_s.ne.2,<a name='5246'></font>
<font color=#447700>!.. then we must compute actual 2nd moment and use as reference.<a name='5247'></font>
         if (bm_s.gt.(2.0-1.e-3) .and. bm_s.lt.(2.0+1.e-3)) then<a name='5248'>
            smo2(k) = smob(k)<a name='5249'>
         else<a name='5250'>
            loga_ = sa(1) + sa(2)*tc0 + sa(3)*bm_s &amp;<a name='5251'>
     &amp;         + sa(4)*tc0*bm_s + sa(5)*tc0*tc0 &amp;<a name='5252'>
     &amp;         + sa(6)*bm_s*bm_s + sa(7)*tc0*tc0*bm_s &amp;<a name='5253'>
     &amp;         + sa(8)*tc0*bm_s*bm_s + sa(9)*tc0*tc0*tc0 &amp;<a name='5254'>
     &amp;         + sa(10)*bm_s*bm_s*bm_s<a name='5255'>
            a_ = 10.0**loga_<a name='5256'>
            b_ = sb(1) + sb(2)*tc0 + sb(3)*bm_s &amp;<a name='5257'>
     &amp;         + sb(4)*tc0*bm_s + sb(5)*tc0*tc0 &amp;<a name='5258'>
     &amp;         + sb(6)*bm_s*bm_s + sb(7)*tc0*tc0*bm_s &amp;<a name='5259'>
     &amp;         + sb(8)*tc0*bm_s*bm_s + sb(9)*tc0*tc0*tc0 &amp;<a name='5260'>
     &amp;         + sb(10)*bm_s*bm_s*bm_s<a name='5261'>
            smo2(k) = (smob(k)/a_)**(1./b_)<a name='5262'>
         endif<a name='5263'>
<a name='5264'>
<font color=#447700>!..Calculate bm_s+1 (th) moment.  Useful for diameter calcs.<a name='5265'></font>
         loga_ = sa(1) + sa(2)*tc0 + sa(3)*cse(1) &amp;<a name='5266'>
     &amp;         + sa(4)*tc0*cse(1) + sa(5)*tc0*tc0 &amp;<a name='5267'>
     &amp;         + sa(6)*cse(1)*cse(1) + sa(7)*tc0*tc0*cse(1) &amp;<a name='5268'>
     &amp;         + sa(8)*tc0*cse(1)*cse(1) + sa(9)*tc0*tc0*tc0 &amp;<a name='5269'>
     &amp;         + sa(10)*cse(1)*cse(1)*cse(1)<a name='5270'>
         a_ = 10.0**loga_<a name='5271'>
         b_ = sb(1)+ sb(2)*tc0 + sb(3)*cse(1) + sb(4)*tc0*cse(1) &amp;<a name='5272'>
     &amp;        + sb(5)*tc0*tc0 + sb(6)*cse(1)*cse(1) &amp;<a name='5273'>
     &amp;        + sb(7)*tc0*tc0*cse(1) + sb(8)*tc0*cse(1)*cse(1) &amp;<a name='5274'>
     &amp;        + sb(9)*tc0*tc0*tc0 + sb(10)*cse(1)*cse(1)*cse(1)<a name='5275'>
         smoc(k) = a_ * smo2(k)**b_<a name='5276'>
<a name='5277'>
<font color=#447700>!..Calculate bm_s*2 (th) moment.  Useful for reflectivity.<a name='5278'></font>
         loga_ = sa(1) + sa(2)*tc0 + sa(3)*cse(3) &amp;<a name='5279'>
     &amp;         + sa(4)*tc0*cse(3) + sa(5)*tc0*tc0 &amp;<a name='5280'>
     &amp;         + sa(6)*cse(3)*cse(3) + sa(7)*tc0*tc0*cse(3) &amp;<a name='5281'>
     &amp;         + sa(8)*tc0*cse(3)*cse(3) + sa(9)*tc0*tc0*tc0 &amp;<a name='5282'>
     &amp;         + sa(10)*cse(3)*cse(3)*cse(3)<a name='5283'>
         a_ = 10.0**loga_<a name='5284'>
         b_ = sb(1)+ sb(2)*tc0 + sb(3)*cse(3) + sb(4)*tc0*cse(3) &amp;<a name='5285'>
     &amp;        + sb(5)*tc0*tc0 + sb(6)*cse(3)*cse(3) &amp;<a name='5286'>
     &amp;        + sb(7)*tc0*tc0*cse(3) + sb(8)*tc0*cse(3)*cse(3) &amp;<a name='5287'>
     &amp;        + sb(9)*tc0*tc0*tc0 + sb(10)*cse(3)*cse(3)*cse(3)<a name='5288'>
         smoz(k) = a_ * smo2(k)**b_<a name='5289'>
      enddo<a name='5290'>
<a name='5291'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5292'></font>
<font color=#447700>!..Calculate y-intercept, slope values for graupel.<a name='5293'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5294'></font>
<a name='5295'>
      N0_min = gonv_max<a name='5296'>
      k_0 = kts<a name='5297'>
      do k = kte, kts, -1<a name='5298'>
         if (temp(k).ge.270.65) k_0 = MAX(k_0, k)<a name='5299'>
      enddo<a name='5300'>
      do k = kte, kts, -1<a name='5301'>
         if (k.gt.k_0 .and. L_qr(k) .and. mvd_r(k).gt.100.E-6) then<a name='5302'>
            xslw1 = 4.01 + alog10(mvd_r(k))<a name='5303'>
         else<a name='5304'>
            xslw1 = 0.01<a name='5305'>
         endif<a name='5306'>
         ygra1 = 4.31 + alog10(max(5.E-5, rg(k)))<a name='5307'>
         zans1 = 3.1 + (100./(300.*xslw1*ygra1/(10./xslw1+1.+0.25*ygra1)+30.+10.*ygra1))<a name='5308'>
         N0_exp = 10.**(zans1)<a name='5309'>
         N0_exp = MAX(DBLE(gonv_min), MIN(N0_exp, DBLE(gonv_max)))<a name='5310'>
         N0_min = MIN(N0_exp, N0_min)<a name='5311'>
         N0_exp = N0_min<a name='5312'>
         lam_exp = (N0_exp*am_g*cgg(1)/rg(k))**oge1<a name='5313'>
         lamg = lam_exp * (cgg(3)*ogg2*ogg1)**obmg<a name='5314'>
         ilamg(k) = 1./lamg<a name='5315'>
         N0_g(k) = N0_exp/(cgg(2)*lam_exp) * lamg**cge(2)<a name='5316'>
      enddo<a name='5317'>
<a name='5318'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5319'></font>
<font color=#447700>!..Locate K-level of start of melting (k_0 is level above).<a name='5320'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5321'></font>
      melti = .false.<a name='5322'>
      k_0 = kts<a name='5323'>
      do k = kte-1, kts, -1<a name='5324'>
         if ( (temp(k).gt.273.15) .and. L_qr(k)                         &amp;<a name='5325'>
     &amp;                            .and. (L_qs(k+1).or.L_qg(k+1)) ) then<a name='5326'>
            k_0 = MAX(k+1, k_0)<a name='5327'>
            melti=.true.<a name='5328'>
            goto 195<a name='5329'>
         endif<a name='5330'>
      enddo<a name='5331'>
 195  continue<a name='5332'>
<a name='5333'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5334'></font>
<font color=#447700>!..Assume Rayleigh approximation at 10 cm wavelength. Rain (all temps)<a name='5335'></font>
<font color=#447700>!.. and non-water-coated snow and graupel when below freezing are<a name='5336'></font>
<font color=#447700>!.. simple. Integrations of m(D)*m(D)*N(D)*dD.<a name='5337'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5338'></font>
<a name='5339'>
      do k = kts, kte<a name='5340'>
         ze_rain(k) = 1.e-22<a name='5341'>
         ze_snow(k) = 1.e-22<a name='5342'>
         ze_graupel(k) = 1.e-22<a name='5343'>
         if (L_qr(k)) ze_rain(k) = N0_r(k)*crg(4)*ilamr(k)**cre(4)<a name='5344'>
         if (L_qs(k)) ze_snow(k) = (0.176/0.93) * (6.0/PI)*(6.0/PI)     &amp;<a name='5345'>
     &amp;                           * (am_s/900.0)*(am_s/900.0)*smoz(k)<a name='5346'>
         if (L_qg(k)) ze_graupel(k) = (0.176/0.93) * (6.0/PI)*(6.0/PI)  &amp;<a name='5347'>
     &amp;                              * (am_g/900.0)*(am_g/900.0)         &amp;<a name='5348'>
     &amp;                              * N0_g(k)*cgg(4)*ilamg(k)**cge(4)<a name='5349'>
      enddo<a name='5350'>
<a name='5351'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5352'></font>
<font color=#447700>!..Special case of melting ice (snow/graupel) particles.  Assume the<a name='5353'></font>
<font color=#447700>!.. ice is surrounded by the liquid water.  Fraction of meltwater is<a name='5354'></font>
<font color=#447700>!.. extremely simple based on amount found above the melting level.<a name='5355'></font>
<font color=#447700>!.. Uses code from Uli Blahak (rayleigh_soak_wetgraupel and supporting<a name='5356'></font>
<font color=#447700>!.. routines).<a name='5357'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5358'></font>
<a name='5359'>
      if (.not. iiwarm .and. melti .and. k_0.ge.2) then<a name='5360'>
       do k = k_0-1, kts, -1<a name='5361'>
<a name='5362'>
<font color=#447700>!..Reflectivity contributed by melting snow<a name='5363'></font>
          if (L_qs(k) .and. L_qs(k_0) ) then<a name='5364'>
           fmelt_s = MAX(0.05d0, MIN(1.0d0-rs(k)/rs(k_0), 0.99d0))<a name='5365'>
           eta = 0.d0<a name='5366'>
           oM3 = 1./smoc(k)<a name='5367'>
           M0 = (smob(k)*oM3)<a name='5368'>
           Mrat = smob(k)*M0*M0*M0<a name='5369'>
           slam1 = M0 * Lam0<a name='5370'>
           slam2 = M0 * Lam1<a name='5371'>
           do n = 1, nrbins<a name='5372'>
              x = am_s * xxDs(n)**bm_s<a name='5373'>
              call <A href='../../html_code/phys/module_mp_radar.F.html#RAYLEIGH_SOAK_WETGRAUPEL'>rayleigh_soak_wetgraupel</A><A href='../../html_code/phys/module_mp_thompson.F.html#CALC_REFL10CM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAYLEIGH_SOAK_WETGRAUPEL_11"> (x, DBLE(ocms), DBLE(obms), &amp;<a name='5374'>
     &amp;              fmelt_s, melt_outside_s, m_w_0, m_i_0, lamda_radar, &amp;<a name='5375'>
     &amp;              CBACK, mixingrulestring_s, matrixstring_s,          &amp;<a name='5376'>
     &amp;              inclusionstring_s, hoststring_s,                    &amp;<a name='5377'>
     &amp;              hostmatrixstring_s, hostinclusionstring_s)<a name='5378'>
              f_d = Mrat*(Kap0*DEXP(-slam1*xxDs(n))                     &amp;<a name='5379'>
     &amp;              + Kap1*(M0*xxDs(n))**mu_s * DEXP(-slam2*xxDs(n)))<a name='5380'>
              eta = eta + f_d * CBACK * simpson(n) * xdts(n)<a name='5381'>
           enddo<a name='5382'>
           ze_snow(k) = SNGL(lamda4 / (pi5 * K_w) * eta)<a name='5383'>
          endif<a name='5384'>
<a name='5385'>
<font color=#447700>!..Reflectivity contributed by melting graupel<a name='5386'></font>
<a name='5387'>
          if (L_qg(k) .and. L_qg(k_0) ) then<a name='5388'>
           fmelt_g = MAX(0.05d0, MIN(1.0d0-rg(k)/rg(k_0), 0.99d0))<a name='5389'>
           eta = 0.d0<a name='5390'>
           lamg = 1./ilamg(k)<a name='5391'>
           do n = 1, nrbins<a name='5392'>
              x = am_g * xxDg(n)**bm_g<a name='5393'>
              call <A href='../../html_code/phys/module_mp_radar.F.html#RAYLEIGH_SOAK_WETGRAUPEL'>rayleigh_soak_wetgraupel</A><A href='../../html_code/phys/module_mp_thompson.F.html#CALC_REFL10CM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAYLEIGH_SOAK_WETGRAUPEL_12"> (x, DBLE(ocmg), DBLE(obmg), &amp;<a name='5394'>
     &amp;              fmelt_g, melt_outside_g, m_w_0, m_i_0, lamda_radar, &amp;<a name='5395'>
     &amp;              CBACK, mixingrulestring_g, matrixstring_g,          &amp;<a name='5396'>
     &amp;              inclusionstring_g, hoststring_g,                    &amp;<a name='5397'>
     &amp;              hostmatrixstring_g, hostinclusionstring_g)<a name='5398'>
              f_d = N0_g(k)*xxDg(n)**mu_g * DEXP(-lamg*xxDg(n))<a name='5399'>
              eta = eta + f_d * CBACK * simpson(n) * xdtg(n)<a name='5400'>
           enddo<a name='5401'>
           ze_graupel(k) = SNGL(lamda4 / (pi5 * K_w) * eta)<a name='5402'>
          endif<a name='5403'>
<a name='5404'>
       enddo<a name='5405'>
      endif<a name='5406'>
<a name='5407'>
      do k = kte, kts, -1<a name='5408'>
         dBZ(k) = 10.*log10((ze_rain(k)+ze_snow(k)+ze_graupel(k))*1.d18)<a name='5409'>
      enddo<a name='5410'>
<a name='5411'>
<a name='5412'>
<font color=#447700>!..Reflectivity-weighted terminal velocity (snow, rain, graupel, mix).<a name='5413'></font>
<font color=#447700>!     do k = kte, kts, -1<a name='5414'></font>
<font color=#447700>!        vt_dBZ(k) = 1.E-3<a name='5415'></font>
<font color=#447700>!        if (rs(k).gt.R2) then<a name='5416'></font>
<font color=#447700>!         Mrat = smob(k) / smoc(k)<a name='5417'></font>
<font color=#447700>!         ils1 = 1./(Mrat*Lam0 + fv_s)<a name='5418'></font>
<font color=#447700>!         ils2 = 1./(Mrat*Lam1 + fv_s)<a name='5419'></font>
<font color=#447700>!         t1_vts = Kap0*csg(5)*ils1**cse(5)<a name='5420'></font>
<font color=#447700>!         t2_vts = Kap1*Mrat**mu_s*csg(11)*ils2**cse(11)<a name='5421'></font>
<font color=#447700>!         ils1 = 1./(Mrat*Lam0)<a name='5422'></font>
<font color=#447700>!         ils2 = 1./(Mrat*Lam1)<a name='5423'></font>
<font color=#447700>!         t3_vts = Kap0*csg(6)*ils1**cse(6)<a name='5424'></font>
<font color=#447700>!         t4_vts = Kap1*Mrat**mu_s*csg(12)*ils2**cse(12)<a name='5425'></font>
<font color=#447700>!         vts_dbz_wt = rhof(k)*av_s * (t1_vts+t2_vts)/(t3_vts+t4_vts)<a name='5426'></font>
<font color=#447700>!         if (temp(k).ge.273.15 .and. temp(k).lt.275.15) then<a name='5427'></font>
<font color=#447700>!            vts_dbz_wt = vts_dbz_wt*1.5<a name='5428'></font>
<font color=#447700>!         elseif (temp(k).ge.275.15) then<a name='5429'></font>
<font color=#447700>!            vts_dbz_wt = vts_dbz_wt*2.0<a name='5430'></font>
<font color=#447700>!         endif<a name='5431'></font>
<font color=#447700>!        else<a name='5432'></font>
<font color=#447700>!         vts_dbz_wt = 1.E-3<a name='5433'></font>
<font color=#447700>!        endif<a name='5434'></font>
<a name='5435'>
<font color=#447700>!        if (rr(k).gt.R1) then<a name='5436'></font>
<font color=#447700>!         lamr = 1./ilamr(k)<a name='5437'></font>
<font color=#447700>!         vtr_dbz_wt = rhof(k)*av_r*crg(13)*(lamr+fv_r)**(-cre(13))      &amp;<a name='5438'></font>
<font color=#447700>!    &amp;               / (crg(4)*lamr**(-cre(4)))<a name='5439'></font>
<font color=#447700>!        else<a name='5440'></font>
<font color=#447700>!         vtr_dbz_wt = 1.E-3<a name='5441'></font>
<font color=#447700>!        endif<a name='5442'></font>
<a name='5443'>
<font color=#447700>!        if (rg(k).gt.R2) then<a name='5444'></font>
<font color=#447700>!         lamg = 1./ilamg(k)<a name='5445'></font>
<font color=#447700>!         vtg_dbz_wt = rhof(k)*av_g*cgg(5)*lamg**(-cge(5))               &amp;<a name='5446'></font>
<font color=#447700>!    &amp;               / (cgg(4)*lamg**(-cge(4)))<a name='5447'></font>
<font color=#447700>!        else<a name='5448'></font>
<font color=#447700>!         vtg_dbz_wt = 1.E-3<a name='5449'></font>
<font color=#447700>!        endif<a name='5450'></font>
<a name='5451'>
<font color=#447700>!        vt_dBZ(k) = (vts_dbz_wt*ze_snow(k) + vtr_dbz_wt*ze_rain(k)      &amp;<a name='5452'></font>
<font color=#447700>!    &amp;                + vtg_dbz_wt*ze_graupel(k))                        &amp;<a name='5453'></font>
<font color=#447700>!    &amp;                / (ze_rain(k)+ze_snow(k)+ze_graupel(k))<a name='5454'></font>
<font color=#447700>!     enddo<a name='5455'></font>
<a name='5456'>
      end subroutine calc_refl10cm<a name='5457'>
<font color=#447700>!<a name='5458'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5459'></font>
<a name='5460'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5461'></font>
END MODULE module_mp_thompson<a name='5462'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='5463'></font>
</pre></body></html>