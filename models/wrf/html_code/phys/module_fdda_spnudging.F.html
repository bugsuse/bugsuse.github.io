<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!wrf:model_layer:physics<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>! Code contributed by Gonzalo Miguez-Macho, Univ. de Santiago de Compostela, Galicia, Spain<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<A NAME='MODULE_FDDA_SPNUDGING'><A href='../../html_code/phys/module_fdda_spnudging.F.html#MODULE_FDDA_SPNUDGING' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='6'>
<font color=#993300>MODULE </font><font color=#cc0000>module_fdda_spnudging</font> <A href='../../call_to/MODULE_FDDA_SPNUDGING.html' TARGET='index'>2</A><a name='7'>
<a name='8'>
#ifdef DM_PARALLEL<a name='9'>
  USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#module_fdda_spnudging.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_147"> , ONLY : ntasks_x, ntasks_y, local_communicator_x, local_communicator_y, data_order_xzy<a name='10'>
#endif<a name='11'>
  USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#module_fdda_spnudging.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_49"> , ONLY : wrf_err_message<a name='12'>
<a name='13'>
CONTAINS<a name='14'>
<font color=#447700>!<a name='15'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='16'></font>
<font color=#447700>!<a name='17'></font>
<A NAME='SPECTRAL_NUDGING'><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='18'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>spectral_nudging</font>(grid,itimestep,dt,xtime,id,analysis_interval, end_fdda_hour, &amp; <A href='../../call_to/SPECTRAL_NUDGING.html' TARGET='index'>1</A>,<A href='../../call_from/SPECTRAL_NUDGING.html' TARGET='index'>25</A><a name='19'>
               if_no_pbl_nudging_uv, if_no_pbl_nudging_t, if_no_pbl_nudging_ph,&amp;<a name='20'>
               if_zfac_uv, k_zfac_uv, dk_zfac_uv, &amp; <a name='21'>
               if_zfac_t, k_zfac_t, dk_zfac_t, &amp;<a name='22'>
               if_zfac_ph, k_zfac_ph, dk_zfac_ph, &amp;<a name='23'>
               guv, gt, gph, if_ramping, dtramp_min, xwavenum, ywavenum, &amp;<a name='24'>
               u3d,v3d,th3d,ph3d,                 &amp;<a name='25'>
               u_ndg_old,v_ndg_old,t_ndg_old,ph_ndg_old,       &amp;<a name='26'>
               u_ndg_new,v_ndg_new,t_ndg_new,ph_ndg_new,       &amp;<a name='27'>
               RUNDGDTEN,RVNDGDTEN,RTHNDGDTEN,RPHNDGDTEN,&amp;<a name='28'>
               pblh, ht, z, z_at_w,                             &amp;<a name='29'>
               ids,ide, jds,jde, kds,kde,                           &amp;<a name='30'>
               ims,ime, jms,jme, kms,kme,                           &amp;<a name='31'>
               i_start,i_end, j_start,j_end, kts,kte, num_tiles, &amp;<a name='32'>
               ips,ipe,jps,jpe,kps,kpe,                   &amp;<a name='33'>
               imsx,imex,jmsx,jmex,kmsx,kmex,                    &amp;<a name='34'>
               ipsx,ipex,jpsx,jpex,kpsx,kpex,                   &amp;<a name='35'>
               imsy,imey,jmsy,jmey,kmsy,kmey,                    &amp;<a name='36'>
               ipsy,ipey,jpsy,jpey,kpsy,kpey                   )<a name='37'>
<a name='38'>
<a name='39'>
<a name='40'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_120"><a name='41'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_227">, ONLY : domain<a name='42'>
<a name='43'>
<font color=#447700>!-------------------------------------------------------------------<a name='44'></font>
   implicit none<a name='45'>
<font color=#447700>!-------------------------------------------------------------------<a name='46'></font>
<font color=#447700>!-- u3d         3d u-velocity staggered on u points<a name='47'></font>
<font color=#447700>!-- v3d         3d v-velocity staggered on v points<a name='48'></font>
<font color=#447700>!-- th3d        3d potential temperature (k)<a name='49'></font>
<font color=#447700>!---ph3d        3d perturbation geopotential<a name='50'></font>
<font color=#447700>!-- rundgdten   staggered u tendency due to<a name='51'></font>
<font color=#447700>!               spectral nudging (m/s/s)<a name='52'></font>
<font color=#447700>!-- rvndgdten   staggered v tendency due to<a name='53'></font>
<font color=#447700>!               spectral nudging (m/s/s)<a name='54'></font>
<font color=#447700>!-- rthndgdten  theta tendency due to<a name='55'></font>
<font color=#447700>!               spectral nudging (K/s)<a name='56'></font>
<font color=#447700>!-- phndgdten  ph tendency due to<a name='57'></font>
<font color=#447700>!               spectral nudging (m2/s2/s)<a name='58'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='59'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='60'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='61'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='62'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='63'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='64'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='65'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='66'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='67'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='68'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='69'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='70'></font>
<font color=#447700>!-- its         start index for i in tile<a name='71'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='72'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='73'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='74'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='75'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='76'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='77'></font>
<font color=#447700>!<a name='78'></font>
   TYPE(domain) , TARGET          :: grid<a name='79'>
<a name='80'>
   INTEGER,  INTENT(IN)   ::      itimestep, analysis_interval, end_fdda_hour<a name='81'>
<a name='82'>
   INTEGER,  INTENT(IN)   ::      if_no_pbl_nudging_uv, if_no_pbl_nudging_t, &amp;<a name='83'>
                                  if_no_pbl_nudging_ph<a name='84'>
   INTEGER,  INTENT(IN)   ::      if_zfac_uv, if_zfac_t, if_zfac_ph<a name='85'>
   INTEGER,  INTENT(IN)   ::      k_zfac_uv,  k_zfac_t, k_zfac_ph<a name='86'>
   INTEGER,  INTENT(IN)   ::      dk_zfac_uv,  dk_zfac_t, dk_zfac_ph<a name='87'>
   INTEGER,  INTENT(IN)   ::      if_ramping<a name='88'>
   INTEGER,  INTENT(IN)   ::      xwavenum,ywavenum<a name='89'>
<a name='90'>
   INTEGER , INTENT(IN)   ::      id<a name='91'>
   REAL,     INTENT(IN)   ::      DT, xtime, dtramp_min<a name='92'>
<a name='93'>
   INTEGER,  INTENT(IN)   ::      ids,ide, jds,jde, kds,kde, &amp;<a name='94'>
                                  ims,ime, jms,jme, kms,kme, &amp;<a name='95'>
                                  kts,kte, num_tiles,        &amp;<a name='96'>
                                  ips,ipe,jps,jpe,kps,kpe,   &amp;<a name='97'>
                                  imsx,imex,jmsx,jmex,kmsx,kmex,   &amp;<a name='98'>
                                  ipsx,ipex,jpsx,jpex,kpsx,kpex,   &amp;<a name='99'>
                                  imsy,imey,jmsy,jmey,kmsy,kmey,   &amp;<a name='100'>
                                  ipsy,ipey,jpsy,jpey,kpsy,kpey <a name='101'>
<a name='102'>
   INTEGER, DIMENSION(num_tiles), INTENT(IN) ::                   &amp;<a name='103'>
  &amp;                                    i_start,i_end,j_start,j_end<a name='104'>
 <a name='105'>
   REAL,     DIMENSION( ims:ime, kms:kme, jms:jme ), &amp;<a name='106'>
             INTENT(IN)   ::                  ph3d, &amp;<a name='107'>
                                              th3d, &amp;<a name='108'>
                                                 z, &amp;<a name='109'>
                                            z_at_w<a name='110'>
<a name='111'>
   REAL,     DIMENSION( ims:ime, kms:kme, jms:jme ), &amp;<a name='112'>
             INTENT(INOUT)   ::           rundgdten, &amp;<a name='113'>
                                          rvndgdten, &amp;<a name='114'>
                                         rthndgdten, &amp;<a name='115'>
                                         rphndgdten<a name='116'>
<a name='117'>
<a name='118'>
   REAL,     DIMENSION( ims:ime, kms:kme, jms:jme ), &amp;<a name='119'>
             INTENT(INOUT)   ::           u_ndg_old, &amp;<a name='120'>
                                          v_ndg_old, &amp;<a name='121'>
                                          t_ndg_old, &amp;<a name='122'>
                                          ph_ndg_old, &amp;<a name='123'>
                                          u_ndg_new, &amp;<a name='124'>
                                          v_ndg_new, &amp;<a name='125'>
                                          t_ndg_new, &amp;<a name='126'>
                                          ph_ndg_new<a name='127'>
<a name='128'>
   REAL,     DIMENSION( ims:ime, kms:kme, jms:jme ), &amp;<a name='129'>
             INTENT(IN)   ::                    u3d, &amp;<a name='130'>
                                                v3d<a name='131'>
<a name='132'>
   REAL,  DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: pblh, &amp;<a name='133'>
                                                         ht<a name='134'>
<a name='135'>
   REAL, INTENT(IN)    :: guv, gt ,gph<a name='136'>
<a name='137'>
   INTEGER             :: its,ite, jts,jte,ij<a name='138'>
   INTEGER             :: i, j, k, itsu, jtsv, itf, jtf, ktf, i0, k0, j0<a name='139'>
   REAL                :: xtime_old, xtime_new, coef, val_analysis<a name='140'>
   INTEGER             :: kpbl, dbg_level<a name='141'>
<a name='142'>
   REAL                :: zpbl, zagl, zagl_bot, zagl_top, tfac, actual_end_fdda_min<a name='143'>
   REAL, DIMENSION( ips:ipe, kps:kpe, jps:jpe, 4 ) :: wpbl  <font color=#447700>! 1: u, 2: v, 3: t, 4: ph<a name='144'></font>
   REAL, DIMENSION( kps:kpe, 4 )                   :: wzfac <font color=#447700>! 1: u, 2: v, 3: t, 4: ph<a name='145'></font>
<a name='146'>
   LOGICAL , EXTERNAL  :: wrf_dm_on_monitor<a name='147'>
<a name='148'>
   CHARACTER (LEN=256) :: wrf_err_message<a name='149'>
<a name='150'>
#if  <font color=#447700>! ( NMM_CORE == 1 )<a name='151'></font>
<a name='152'>
      DO ij = 1 , num_tiles<a name='153'>
          its=i_start(ij)<a name='154'>
          ite=i_end(ij)<a name='155'>
          jts=j_start(ij)<a name='156'>
          jte=j_end(ij)<a name='157'>
      ENDDO<a name='158'>
<font color=#447700>!GMM default values for vertical coefficients, set here<a name='159'></font>
   wpbl(:,:,:,:) = 1.0<a name='160'>
   wzfac(:,:) = 1.0<a name='161'>
<a name='162'>
 <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='163'></font>
 <font color=#447700>!$OMP PRIVATE ( ij, i,j,k ) ! only for part of the calculation.<a name='164'></font>
 DO ij = 1 , num_tiles<a name='165'>
     DO j = jts, jte<a name='166'>
     DO k = kts, kte<a name='167'>
     DO i = its, ite<a name='168'>
       RUNDGDTEN(i,k,j) = 0.0<a name='169'>
       RVNDGDTEN(i,k,j) = 0.0<a name='170'>
       RTHNDGDTEN(i,k,j) = 0.0<a name='171'>
       RPHNDGDTEN(i,k,j) = 0.0<a name='172'>
     ENDDO<a name='173'>
     ENDDO<a name='174'>
     ENDDO<a name='175'>
 ENDDO<a name='176'>
 <font color=#447700>!$OMP END PARALLEL DO<a name='177'></font>
<a name='178'>
 actual_end_fdda_min = end_fdda_hour*60.0<a name='179'>
 IF( if_ramping == 1 .AND. dtramp_min &gt; 0.0 ) &amp;<a name='180'>
       actual_end_fdda_min = end_fdda_hour*60.0 + ABS(dtramp_min)<a name='181'>
 IF( xtime &gt; actual_end_fdda_min ) RETURN<a name='182'>
<a name='183'>
 <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='184'></font>
 <font color=#447700>!$OMP PRIVATE ( ij, i,j,k ) ! only for part of the calculation. <a name='185'></font>
 <font color=#447700>!GMM Transpose and filtering needs to be done on patch<a name='186'></font>
 <a name='187'>
 DO ij = 1 , num_tiles<a name='188'>
<a name='189'>
<font color=#447700>!  actual_end_fdda_min = end_fdda_hour*60.0<a name='190'></font>
<font color=#447700>!  IF( if_ramping == 1 .AND. dtramp_min &gt; 0.0 ) &amp;<a name='191'></font>
<font color=#447700>!      actual_end_fdda_min = end_fdda_hour*60.0 + ABS(dtramp_min)<a name='192'></font>
<a name='193'>
   xtime_old = FLOOR(xtime/analysis_interval) * analysis_interval * 1.0<a name='194'>
   xtime_new = xtime_old + analysis_interval<a name='195'>
   coef = (xtime-xtime_old)/(xtime_new-xtime_old)<a name='196'>
<a name='197'>
   IF ( wrf_dm_on_monitor()) THEN<a name='198'>
<a name='199'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#GET_WRF_DEBUG_LEVEL'>get_wrf_debug_level</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_WRF_DEBUG_LEVEL_8">( dbg_level )<a name='200'>
<a name='201'>
     IF( xtime-xtime_old &lt; 0.5*dt/60.0 ) THEN<a name='202'>
<a name='203'>
       IF( xtime &lt; end_fdda_hour*60.0 ) THEN<a name='204'>
         WRITE(wrf_err_message,FMT='(a,i2.2,a,f15.3,a)') &amp;<a name='205'>
          'D',id,' Spectral nudging read in new data at time = ', xtime, ' min.'<a name='206'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_697">( TRIM(wrf_err_message) )<a name='207'>
         WRITE(wrf_err_message,FMT='(a,i2.2,a,2(f15.3,1x),a)') &amp;<a name='208'>
          'D',id,' Spectral nudging bracketing times = ', xtime_old, xtime_new, ' min.'<a name='209'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_698">( TRIM(wrf_err_message) )<a name='210'>
       ENDIF<a name='211'>
<a name='212'>
       actual_end_fdda_min = end_fdda_hour*60.0<a name='213'>
       IF( if_ramping == 1 .AND. dtramp_min &gt; 0.0 ) &amp;<a name='214'>
           actual_end_fdda_min = end_fdda_hour*60.0 + ABS(dtramp_min)<a name='215'>
<a name='216'>
       IF( dbg_level .GE. 10 .AND. xtime &lt;= actual_end_fdda_min ) THEN<a name='217'>
<font color=#447700>!        Find the mid point of the tile and print out the sample values<a name='218'></font>
         i0 = (ite-its)/2+its<a name='219'>
         j0 = (jte-jts)/2+jts <a name='220'>
<a name='221'>
         IF( guv &gt; 0.0 ) THEN<a name='222'>
           DO k = kts, kte<a name='223'>
             WRITE(wrf_err_message,'(a,i1,a,3i4,a,f10.4,a,f10.4)') &amp;<a name='224'>
               '    D0',id,' sample analysis values at i,k,j=', i0, k, j0, &amp;<a name='225'>
               ' u_ndg_old=', u_ndg_old(i0,k,j0), ' u_ndg_new=', u_ndg_new(i0,k,j0)<a name='226'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_699">( TRIM(wrf_err_message) )<a name='227'>
           ENDDO<a name='228'>
           DO k = kts, kte<a name='229'>
             WRITE(wrf_err_message,'(a,i1,a,3i4,a,f10.4,a,f10.4)') &amp;<a name='230'>
               '    D0',id,' sample analysis values at i,k,j=', i0, k, j0, &amp;<a name='231'>
               ' v_ndg_old=', v_ndg_old(i0,k,j0), ' v_ndg_new=', v_ndg_new(i0,k,j0)<a name='232'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_700">( TRIM(wrf_err_message) )<a name='233'>
           ENDDO<a name='234'>
         ENDIF<a name='235'>
<a name='236'>
         IF( gt &gt; 0.0 ) THEN<a name='237'>
           DO k = kts, kte<a name='238'>
             WRITE(wrf_err_message,'(a,i1,a,3i4,a,f10.4,a,f10.4)') &amp;<a name='239'>
               '    D0',id,' sample analysis values at i,k,j=', i0, k, j0, &amp;<a name='240'>
               ' t_ndg_old=', t_ndg_old(i0,k,j0), ' t_ndg_new=', t_ndg_new(i0,k,j0)<a name='241'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_701">( TRIM(wrf_err_message) )<a name='242'>
           ENDDO<a name='243'>
         ENDIF<a name='244'>
<a name='245'>
         IF( gph &gt; 0.0 ) THEN<a name='246'>
           DO k = kts, kte<a name='247'>
             WRITE(wrf_err_message,'(a,i1,a,3i4,a,f10.4,a,f10.4)') &amp;<a name='248'>
               '    D0',id,' sample analysis values at i,k,j=', i0, k, j0, &amp;<a name='249'>
               ' ph_ndg_old=', ph_ndg_old(i0,k,j0), ' ph_ndg_new=', ph_ndg_new(i0,k,j0)<a name='250'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_702">( TRIM(wrf_err_message) )<a name='251'>
           ENDDO<a name='252'>
         ENDIF<a name='253'>
<a name='254'>
       ENDIF<a name='255'>
     ENDIF<a name='256'>
   ENDIF<a name='257'>
<a name='258'>
   jtsv=MAX0(jts,jds+1)<a name='259'>
   itsu=MAX0(its,ids+1)<a name='260'>
<a name='261'>
   jtf=MIN0(jte,jde-1)<a name='262'>
   ktf=MIN0(kte,kde-1)<a name='263'>
   itf=MIN0(ite,ide-1)<a name='264'>
<font color=#447700>!<a name='265'></font>
<font color=#447700>! If the user-defined namelist switches (if_no_pbl_nudging_uv, if_no_pbl_nudging_t, <a name='266'></font>
<font color=#447700>! if_no_pbl_nudging_ph swithes) are set to 1, compute the weighting function, wpbl(:,k,:,:), <a name='267'></font>
<font color=#447700>! based on the PBL depth.  wpbl = 1 above the PBL and wpbl = 0 in the PBL.  If all <a name='268'></font>
<font color=#447700>! the switche are set to zero, wpbl = 1 (default value).<a name='269'></font>
<font color=#447700>!<a name='270'></font>
<font color=#447700>!GMM If those are set to zero, then check if the user-defined namelist switches (if_zfac_uv, if_zfac_t,<a name='271'></font>
<font color=#447700>! if_zfac_ph swithes) are set to 1, compute the weighting function, wzfac(k,:),<a name='272'></font>
<font color=#447700>! based on the namelist specified k values (k_zfac_uv, k_zfac_t and k_zfac_ph) <a name='273'></font>
<font color=#447700>! below which analysis nudging is turned off (wzfac = 1 above k_zfac_x and = 0 in below k_zfac_x).<a name='274'></font>
<font color=#447700>!  The strength of nudging increases linearly from k_zfac to kzfac + dk_zfac <a name='275'></font>
<font color=#447700>! (dk_zfac_uv, dk_zfac_t and kd_zfac_ph are also set in the namelist, default value is 1).<a name='276'></font>
<font color=#447700>!If all switches are set to zero, wzfac = 1 (default value).<a name='277'></font>
<font color=#447700>!<a name='278'></font>
<a name='279'>
   IF( if_no_pbl_nudging_uv == 1 ) THEN<a name='280'>
<a name='281'>
     DO j=jts,jtf <a name='282'>
     DO i=itsu,itf<a name='283'>
<a name='284'>
       kpbl = 1<a name='285'>
       zpbl = 0.5 * ( pblh(i-1,j) + pblh(i,j) )<a name='286'>
<a name='287'>
       loop_ku: DO k=kts,ktf <a name='288'>
         zagl_bot = 0.5 * ( z_at_w(i-1,k,  j)-ht(i-1,j) + z_at_w(i,k,  j)-ht(i,j) )<a name='289'>
         zagl_top = 0.5 * ( z_at_w(i-1,k+1,j)-ht(i-1,j) + z_at_w(i,k+1,j)-ht(i,j) )<a name='290'>
         IF( zpbl &gt;= zagl_bot .AND. zpbl &lt; zagl_top ) THEN<a name='291'>
           kpbl = k<a name='292'>
           EXIT loop_ku<a name='293'>
         ENDIF<a name='294'>
       ENDDO loop_ku<a name='295'>
<a name='296'>
       DO k=kts,ktf<a name='297'>
          wpbl(i, k, j, 1) = max ( min ( float(k-kpbl) / float(dk_zfac_uv) , 1. ) , 0.)<a name='298'>
       ENDDO<a name='299'>
<a name='300'>
     ENDDO<a name='301'>
     ENDDO<a name='302'>
<a name='303'>
     DO i=its,itf<a name='304'>
     DO j=jtsv,jtf<a name='305'>
<a name='306'>
       kpbl = 1<a name='307'>
       zpbl = 0.5 * ( pblh(i,j-1) + pblh(i,j) )<a name='308'>
<a name='309'>
       loop_kv: DO k=kts,ktf<a name='310'>
         zagl_bot = 0.5 * ( z_at_w(i,k,  j-1)-ht(i,j-1) + z_at_w(i,k,  j)-ht(i,j) )<a name='311'>
         zagl_top = 0.5 * ( z_at_w(i,k+1,j-1)-ht(i,j-1) + z_at_w(i,k+1,j)-ht(i,j) )<a name='312'>
         IF( zpbl &gt;= zagl_bot .AND. zpbl &lt; zagl_top ) THEN<a name='313'>
           kpbl = k<a name='314'>
           EXIT loop_kv<a name='315'>
         ENDIF<a name='316'>
       ENDDO loop_kv<a name='317'>
<a name='318'>
       DO k=kts,ktf<a name='319'>
          wpbl(i, k, j, 2) = max ( min ( float(k-kpbl) / float(dk_zfac_uv) , 1. ) , 0.)<a name='320'>
       ENDDO<a name='321'>
<a name='322'>
     ENDDO<a name='323'>
     ENDDO<a name='324'>
<a name='325'>
   ELSEIF( if_zfac_uv == 1 ) THEN<a name='326'>
<a name='327'>
     DO j=jts,jte<a name='328'>
     DO k=kts,ktf<a name='329'>
     DO i=its,ite<a name='330'>
          wpbl(i, k, j, 1) = max ( min ( float(k-k_zfac_uv) / float(dk_zfac_uv) , 1. ) , 0.)<a name='331'>
          wpbl(i, k, j, 2) = wpbl(i, k, j, 1)<a name='332'>
     ENDDO<a name='333'>
     ENDDO<a name='334'>
     ENDDO<a name='335'>
<a name='336'>
   ENDIF<a name='337'>
<a name='338'>
<a name='339'>
   IF( if_no_pbl_nudging_t == 1 ) THEN<a name='340'>
   <a name='341'>
     DO j=jts,jtf<a name='342'>
     DO i=its,itf<a name='343'>
<a name='344'>
       kpbl = 1<a name='345'>
       zpbl = pblh(i,j)<a name='346'>
        <a name='347'>
       loop_kt: DO k=kts,ktf<a name='348'>
         zagl_bot = z_at_w(i,k,  j)-ht(i,j)<a name='349'>
         zagl_top = z_at_w(i,k+1,j)-ht(i,j)<a name='350'>
         IF( zpbl &gt;= zagl_bot .AND. zpbl &lt; zagl_top ) THEN<a name='351'>
           kpbl = k<a name='352'>
           EXIT loop_kt<a name='353'>
         ENDIF<a name='354'>
       ENDDO loop_kt<a name='355'>
<a name='356'>
       DO k=kts,ktf<a name='357'>
          wpbl(i, k, j, 3) = max ( min ( float(k-kpbl) / float(dk_zfac_t) , 1. ) , 0.)<a name='358'>
       ENDDO <a name='359'>
        <a name='360'>
     ENDDO<a name='361'>
     ENDDO<a name='362'>
<a name='363'>
   ELSEIF( if_zfac_t == 1 ) THEN<a name='364'>
<a name='365'>
     DO j=jts,jtf<a name='366'>
     DO k=kts,ktf<a name='367'>
     DO i=its,itf<a name='368'>
          wpbl(i, k, j, 3) = max ( min ( float(k-k_zfac_t) / float(dk_zfac_t) , 1. ) , 0.)<a name='369'>
     ENDDO<a name='370'>
     ENDDO<a name='371'>
     ENDDO<a name='372'>
<a name='373'>
   ENDIF<a name='374'>
<a name='375'>
<a name='376'>
   IF( if_no_pbl_nudging_ph == 1 ) THEN<a name='377'>
   <a name='378'>
     DO j=jts,jtf<a name='379'>
     DO i=its,itf<a name='380'>
<a name='381'>
       kpbl = 1<a name='382'>
       zpbl = pblh(i,j)<a name='383'>
          <a name='384'>
       loop_kph: DO k=kts,kte<a name='385'>
         zagl = z_at_w(i,k,  j)-ht(i,j)<a name='386'>
         IF( zpbl &gt;= zagl) THEN<a name='387'>
           kpbl = k<a name='388'>
           EXIT loop_kph<a name='389'>
         ENDIF<a name='390'>
       ENDDO loop_kph<a name='391'>
<a name='392'>
       DO k=kts,kte<a name='393'>
          wpbl(i, k, j, 4) = max ( min ( float(k-kpbl) / float(dk_zfac_ph) , 1. ) , 0.)<a name='394'>
       ENDDO <a name='395'>
            <a name='396'>
     ENDDO  <a name='397'>
     ENDDO<a name='398'>
        <a name='399'>
   ELSEIF( if_zfac_ph == 1 ) THEN<a name='400'>
<a name='401'>
     DO j=jts,jtf<a name='402'>
     DO k=kts,kte<a name='403'>
     DO i=its,itf<a name='404'>
          wpbl(i, k, j, 4) = max ( min ( float(k-k_zfac_ph) / float(dk_zfac_ph) , 1. ) , 0.)<a name='405'>
     ENDDO<a name='406'>
     ENDDO<a name='407'>
     ENDDO<a name='408'>
<a name='409'>
   ENDIF<a name='410'>
<a name='411'>
<a name='412'>
<font color=#447700>! If if_ramping and dtramp_min are defined by user, comput a time weighting function, tfac, <a name='413'></font>
<font color=#447700>! for analysis nudging so that at the end of the nudging period (which has to be at a <a name='414'></font>
<font color=#447700>! analysis time) we ramp down the nudging coefficient, based on the use-defined sign of dtramp_min.<a name='415'></font>
<font color=#447700>!<a name='416'></font>
<font color=#447700>! When dtramp_min is negative, ramping ends at end_fdda_hour and starts at <a name='417'></font>
<font color=#447700>! end_fdda_hour-ABS(dtramp_min).  <a name='418'></font>
<font color=#447700>!<a name='419'></font>
<font color=#447700>! When dtramp_min is positive, ramping starts at end_fdda_hour and ends at <a name='420'></font>
<font color=#447700>! end_fdda_hour+ABS(dtramp_min). In this case, the obs values are extrapolated using <a name='421'></font>
<font color=#447700>! the obs tendency saved from the previous FDDA wondow.  More specifically for extrapolation, <a name='422'></font>
<font color=#447700>! coef (see codes below) is recalculated to reflect extrapolation during the ramping period.<a name='423'></font>
<font color=#447700>!<a name='424'></font>
   tfac = 1.0<a name='425'>
<a name='426'>
   IF( if_ramping == 1 .AND. ABS(dtramp_min) &gt; 0.0 ) THEN<a name='427'>
 <a name='428'>
     IF( dtramp_min &lt;= 0.0 ) THEN<a name='429'>
       actual_end_fdda_min = end_fdda_hour*60.0<a name='430'>
     ELSE<a name='431'>
       actual_end_fdda_min = end_fdda_hour*60.0 + dtramp_min<a name='432'>
     ENDIF<a name='433'>
<a name='434'>
     IF( xtime &lt; actual_end_fdda_min-ABS(dtramp_min) )THEN <a name='435'>
       tfac = 1.0<a name='436'>
     ELSEIF( xtime &gt;= actual_end_fdda_min-ABS(dtramp_min) .AND. xtime &lt;= actual_end_fdda_min )THEN<a name='437'>
       tfac = ( actual_end_fdda_min - xtime ) / ABS(dtramp_min)<a name='438'>
       IF( dtramp_min &gt; 0.0 ) coef = (xtime-xtime_old+analysis_interval)/analysis_interval<a name='439'>
     ELSE                                                     <a name='440'>
       tfac = 0.0<a name='441'>
     ENDIF<a name='442'>
<a name='443'>
   ENDIF                                                  <a name='444'>
<a name='445'>
   ENDDO<a name='446'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='447'></font>
<a name='448'>
<font color=#447700>!<a name='449'></font>
<font color=#447700>! Compute 3-D nudging tendencies for u, v<a name='450'></font>
<font color=#447700>!<a name='451'></font>
<font color=#447700>!<a name='452'></font>
<font color=#447700>!GMM Fist calculate differences between model variables and analysis values,<a name='453'></font>
<font color=#447700>!then filter in the x and y direction all wave numbers higher than<a name='454'></font>
<font color=#447700>! xwavenum and ywavenum, as specified in the namelist.<a name='455'></font>
<font color=#447700>!If either xwavenum or ywavenum are not specified,<a name='456'></font>
<font color=#447700>! default values are zero, and spectral nudging is turned off<a name='457'></font>
<font color=#447700>!Then use the filtered differences to calculate the spectral nudging tendencies<a name='458'></font>
<a name='459'>
IF(guv &gt; 0. ) then<a name='460'>
<a name='461'>
 <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='462'></font>
 <font color=#447700>!$OMP PRIVATE ( ij, i,j,k )<a name='463'></font>
 DO ij = 1 , num_tiles<a name='464'>
<a name='465'>
   DO j=jts,jte<a name='466'>
   DO k=kts,ktf<a name='467'>
   DO i=its,ite<a name='468'>
     val_analysis = u_ndg_old(i,k,j) *( 1.0 - coef ) + u_ndg_new(i,k,j) * coef<a name='469'>
     <a name='470'>
     grid%dif_analysis(i,k,j) = val_analysis - u3d(i,k,j)<a name='471'>
<a name='472'>
   ENDDO<a name='473'>
   ENDDO<a name='474'>
   ENDDO<a name='475'>
 <a name='476'>
 ENDDO<a name='477'>
 <font color=#447700>!$OMP END PARALLEL DO<a name='478'></font>
<a name='479'>
<font color=#447700>!Filter<a name='480'></font>
<a name='481'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='482'></font>
# include "<A href='../../html_code/include/XPOSE_SPECTRAL_NUDGING_z2x.inc.html'>XPOSE_SPECTRAL_NUDGING_z2x.inc</A>"<A NAME="XPOSE_SPECTRAL_NUDGING_z2x.inc_1"><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='483'>
<a name='484'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DX'>spectral_nudging_filter_3dx</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DX_1">( grid%dif_xxx, xwavenum,    &amp;<a name='485'>
                                ids, ide, jds, jde, kds, kde,         &amp;<a name='486'>
                                imsx, imex, jmsx, jmex, kmsx, kmex,     &amp;<a name='487'>
                                ipsx, ipex, jpsx, jpex, kpsx, MIN(kde-1,kpex) ) <a name='488'>
<a name='489'>
# include "<A href='../../html_code/include/XPOSE_SPECTRAL_NUDGING_x2y.inc.html'>XPOSE_SPECTRAL_NUDGING_x2y.inc</A>"<A NAME="XPOSE_SPECTRAL_NUDGING_x2y.inc_2"><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='490'>
<a name='491'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DY'>spectral_nudging_filter_3dy</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DY_1">( grid%dif_yyy, ywavenum,    &amp;<a name='492'>
                                ids, ide, jds, jde, kds, kde,         &amp;<a name='493'>
                                imsy, imey, jmsy, jmey, kmsy, kmey,     &amp;<a name='494'>
                                ipsy, ipey, jpsy, jpey, kpsy, MIN(kde-1,kpey) )<a name='495'>
<a name='496'>
# include "<A href='../../html_code/include/XPOSE_SPECTRAL_NUDGING_y2z.inc.html'>XPOSE_SPECTRAL_NUDGING_y2z.inc</A>"<A NAME="XPOSE_SPECTRAL_NUDGING_y2z.inc_3"><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='497'>
<a name='498'>
<a name='499'>
#else<a name='500'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DX'>spectral_nudging_filter_3dx</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DX_2">( grid%dif_analysis, xwavenum,     &amp;<a name='501'>
                                ids, ide, jds, jde, kds, kde,       &amp;<a name='502'>
                                ims, ime, jms, jme, kms, kme,       &amp;<a name='503'>
                                ips, ipe, jps, jpe, kps, MIN(kde-1,kpe) )<a name='504'>
<a name='505'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DY'>spectral_nudging_filter_3dy</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DY_2">( grid%dif_analysis, ywavenum,      &amp;<a name='506'>
                                ids, ide, jds, jde, kds, kde,       &amp;<a name='507'>
                                ims, ime, jms, jme, kms, kme,       &amp;<a name='508'>
                                ips, ipe, jps, jpe, kps, MIN(kde-1,kpe) )<a name='509'>
#endif<a name='510'>
<a name='511'>
<font color=#447700>! Calculate tendency<a name='512'></font>
<a name='513'>
 <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='514'></font>
 <font color=#447700>!$OMP PRIVATE ( ij, i,j,k )<a name='515'></font>
 DO ij = 1 , num_tiles<a name='516'>
<a name='517'>
   DO j=jts,jte<a name='518'>
   DO k=kts,ktf<a name='519'>
   DO i=its,ite<a name='520'>
     RUNDGDTEN(i,k,j) = guv * wpbl(i,k,j,1) * wzfac(k,1) * tfac * &amp;<a name='521'>
                        grid%dif_analysis(i,k,j)<a name='522'>
   ENDDO<a name='523'>
   ENDDO<a name='524'>
   ENDDO<a name='525'>
<a name='526'>
<a name='527'>
<font color=#447700>!<a name='528'></font>
<font color=#447700>! Now V component<a name='529'></font>
<font color=#447700>!<a name='530'></font>
<a name='531'>
   DO j=jts,jte<a name='532'>
   DO k=kts,ktf<a name='533'>
   DO i=its,ite<a name='534'>
     val_analysis = v_ndg_old(i,k,j) *( 1.0 - coef ) + v_ndg_new(i,k,j) * coef<a name='535'>
<a name='536'>
     grid%dif_analysis(i,k,j) = val_analysis - v3d(i,k,j)<a name='537'>
<a name='538'>
   ENDDO<a name='539'>
   ENDDO<a name='540'>
   ENDDO<a name='541'>
<a name='542'>
 ENDDO<a name='543'>
 <font color=#447700>!$OMP END PARALLEL DO<a name='544'></font>
<a name='545'>
<font color=#447700>!<a name='546'></font>
<font color=#447700>! Filter<a name='547'></font>
<font color=#447700>!<a name='548'></font>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='549'></font>
# include "<A href='../../html_code/include/XPOSE_SPECTRAL_NUDGING_z2x.inc.html'>XPOSE_SPECTRAL_NUDGING_z2x.inc</A>"<A NAME="XPOSE_SPECTRAL_NUDGING_z2x.inc_4"><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='550'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DX'>spectral_nudging_filter_3dx</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DX_3">( grid%dif_xxx, xwavenum,     &amp;<a name='551'>
                                ids, ide, jds, jde, kds, kde,         &amp;<a name='552'>
                                imsx, imex, jmsx, jmex, kmsx, kmex,     &amp;<a name='553'>
                                ipsx, ipex, jpsx, jpex, kpsx, MIN(kde-1,kpex) )<a name='554'>
<a name='555'>
# include "<A href='../../html_code/include/XPOSE_SPECTRAL_NUDGING_x2y.inc.html'>XPOSE_SPECTRAL_NUDGING_x2y.inc</A>"<A NAME="XPOSE_SPECTRAL_NUDGING_x2y.inc_5"><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='556'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DY'>spectral_nudging_filter_3dy</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DY_3">( grid%dif_yyy, ywavenum,   &amp;<a name='557'>
                                ids, ide, jds, jde, kds, kde-1,         &amp;<a name='558'>
                                imsy, imey, jmsy, jmey, kmsy, kmey,     &amp;<a name='559'>
                                ipsy, ipey, jpsy, jpey, kpsy, MIN(kde-1,kpey) )<a name='560'>
<a name='561'>
# include "<A href='../../html_code/include/XPOSE_SPECTRAL_NUDGING_y2z.inc.html'>XPOSE_SPECTRAL_NUDGING_y2z.inc</A>"<A NAME="XPOSE_SPECTRAL_NUDGING_y2z.inc_6"><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='562'>
<a name='563'>
<a name='564'>
#else<a name='565'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DX'>spectral_nudging_filter_3dx</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DX_4">( grid%dif_analysis, xwavenum,    &amp;<a name='566'>
                                ids, ide, jds, jde, kds, kde,       &amp;<a name='567'>
                                ims, ime, jms, jme, kms, kme,       &amp;<a name='568'>
                                ips, ipe, jps, jpe, kps, MIN(kde-1,kpe) )<a name='569'>
<a name='570'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DY'>spectral_nudging_filter_3dy</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DY_4">( grid%dif_analysis, ywavenum,    &amp;<a name='571'>
                                ids, ide, jds, jde, kds, kde,       &amp;<a name='572'>
                                ims, ime, jms, jme, kms, kme,       &amp;<a name='573'>
                                ips, ipe, jps, jpe, kps, MIN(kde-1,kpe) )<a name='574'>
#endif<a name='575'>
<a name='576'>
<font color=#447700>! Calculate tendency<a name='577'></font>
<a name='578'>
 <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='579'></font>
 <font color=#447700>!$OMP PRIVATE ( ij, i,j,k )<a name='580'></font>
 DO ij = 1 , num_tiles<a name='581'>
<a name='582'>
   DO j=jts,jte<a name='583'>
   DO k=kts,ktf<a name='584'>
   DO i=its,ite<a name='585'>
     RVNDGDTEN(i,k,j) = guv * wpbl(i,k,j,2) * wzfac(k,2) * tfac * &amp;<a name='586'>
                        grid%dif_analysis(i,k,j)<a name='587'>
   ENDDO<a name='588'>
   ENDDO<a name='589'>
   ENDDO<a name='590'>
<a name='591'>
 ENDDO<a name='592'>
 <font color=#447700>!$OMP END PARALLEL DO<a name='593'></font>
<a name='594'>
ENDIF<a name='595'>
<a name='596'>
IF(gt &gt; 0. ) then<a name='597'>
<a name='598'>
 <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='599'></font>
 <font color=#447700>!$OMP PRIVATE ( ij, i,j,k )<a name='600'></font>
 DO ij = 1 , num_tiles<a name='601'>
<a name='602'>
   DO j=jts,jte<a name='603'>
   DO k=kts,ktf<a name='604'>
   DO i=its,ite<a name='605'>
     val_analysis = t_ndg_old(i,k,j) *( 1.0 - coef ) + t_ndg_new(i,k,j) * coef<a name='606'>
<a name='607'>
     grid%dif_analysis(i,k,j) = val_analysis - th3d(i,k,j) + 300.<a name='608'>
<a name='609'>
   ENDDO<a name='610'>
   ENDDO<a name='611'>
   ENDDO<a name='612'>
<a name='613'>
 ENDDO<a name='614'>
 <font color=#447700>!$OMP END PARALLEL DO<a name='615'></font>
<a name='616'>
<font color=#447700>!Filter<a name='617'></font>
<a name='618'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='619'></font>
# include "<A href='../../html_code/include/XPOSE_SPECTRAL_NUDGING_z2x.inc.html'>XPOSE_SPECTRAL_NUDGING_z2x.inc</A>"<A NAME="XPOSE_SPECTRAL_NUDGING_z2x.inc_7"><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='620'>
<a name='621'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DX'>spectral_nudging_filter_3dx</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DX_5">( grid%dif_xxx, xwavenum,    &amp;<a name='622'>
                                ids, ide, jds, jde, kds, kde,         &amp;<a name='623'>
                                imsx, imex, jmsx, jmex, kmsx, kmex,     &amp;<a name='624'>
                                ipsx, ipex, jpsx, jpex, kpsx, MIN(kde-1,kpex) )<a name='625'>
<a name='626'>
# include "<A href='../../html_code/include/XPOSE_SPECTRAL_NUDGING_x2y.inc.html'>XPOSE_SPECTRAL_NUDGING_x2y.inc</A>"<A NAME="XPOSE_SPECTRAL_NUDGING_x2y.inc_8"><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='627'>
<a name='628'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DY'>spectral_nudging_filter_3dy</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DY_5">( grid%dif_yyy, ywavenum,    &amp;<a name='629'>
                                ids, ide, jds, jde, kds, kde,         &amp;<a name='630'>
                                imsy, imey, jmsy, jmey, kmsy, kmey,     &amp;<a name='631'>
                                ipsy, ipey, jpsy, jpey, kpsy, MIN(kde-1,kpey) )<a name='632'>
<a name='633'>
# include "<A href='../../html_code/include/XPOSE_SPECTRAL_NUDGING_y2z.inc.html'>XPOSE_SPECTRAL_NUDGING_y2z.inc</A>"<A NAME="XPOSE_SPECTRAL_NUDGING_y2z.inc_9"><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='634'>
<a name='635'>
<a name='636'>
#else<a name='637'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DX'>spectral_nudging_filter_3dx</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DX_6">( grid%dif_analysis, xwavenum,     &amp;<a name='638'>
                                ids, ide, jds, jde, kds, kde,       &amp;<a name='639'>
                                ims, ime, jms, jme, kms, kme,       &amp;<a name='640'>
                                ips, ipe, jps, jpe, kps, MIN(kde-1,kpe) )<a name='641'>
<a name='642'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DY'>spectral_nudging_filter_3dy</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DY_6">( grid%dif_analysis, ywavenum,      &amp;<a name='643'>
                                ids, ide, jds, jde, kds, kde,       &amp;<a name='644'>
                                ims, ime, jms, jme, kms, kme,       &amp;<a name='645'>
                                ips, ipe, jps, jpe, kps, MIN(kde-1,kpe) )<a name='646'>
#endif<a name='647'>
<a name='648'>
<font color=#447700>! Calculate tendency<a name='649'></font>
<a name='650'>
 <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='651'></font>
 <font color=#447700>!$OMP PRIVATE ( ij, i,j,k )<a name='652'></font>
 DO ij = 1 , num_tiles<a name='653'>
<a name='654'>
   DO j=jts,jte<a name='655'>
   DO k=kts,ktf<a name='656'>
   DO i=its,ite<a name='657'>
     RTHNDGDTEN(i,k,j) = gt * wpbl(i,k,j,3) * wzfac(k,3) * tfac * &amp;<a name='658'>
                        grid%dif_analysis(i,k,j)<a name='659'>
   ENDDO<a name='660'>
   ENDDO<a name='661'>
   ENDDO<a name='662'>
<a name='663'>
 ENDDO<a name='664'>
 <font color=#447700>!$OMP END PARALLEL DO<a name='665'></font>
<a name='666'>
ENDIF<a name='667'>
<a name='668'>
IF(gph &gt; 0. ) then<a name='669'>
<a name='670'>
 <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='671'></font>
 <font color=#447700>!$OMP PRIVATE ( ij, i,j,k )<a name='672'></font>
 DO ij = 1 , num_tiles<a name='673'>
<a name='674'>
   DO j=jts,jte<a name='675'>
   DO k=kts,kte<a name='676'>
   DO i=its,ite<a name='677'>
     val_analysis = ph_ndg_old(i,k,j) *( 1.0 - coef ) + ph_ndg_new(i,k,j) * coef<a name='678'>
<a name='679'>
     grid%dif_analysis(i,k,j) = val_analysis - ph3d(i,k,j)<a name='680'>
<a name='681'>
   ENDDO<a name='682'>
   ENDDO<a name='683'>
   ENDDO<a name='684'>
<a name='685'>
 ENDDO<a name='686'>
 <font color=#447700>!$OMP END PARALLEL DO<a name='687'></font>
<a name='688'>
<font color=#447700>!Filter<a name='689'></font>
<a name='690'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='691'></font>
# include "<A href='../../html_code/include/XPOSE_SPECTRAL_NUDGING_z2x.inc.html'>XPOSE_SPECTRAL_NUDGING_z2x.inc</A>"<A NAME="XPOSE_SPECTRAL_NUDGING_z2x.inc_10"><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='692'>
<a name='693'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DX'>spectral_nudging_filter_3dx</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DX_7">( grid%dif_xxx, xwavenum,    &amp;<a name='694'>
                                ids, ide, jds, jde, kds, kde,         &amp;<a name='695'>
                                imsx, imex, jmsx, jmex, kmsx, kmex,     &amp;<a name='696'>
                                ipsx, ipex, jpsx, jpex, kpsx, kpex  )<a name='697'>
<a name='698'>
# include "<A href='../../html_code/include/XPOSE_SPECTRAL_NUDGING_x2y.inc.html'>XPOSE_SPECTRAL_NUDGING_x2y.inc</A>"<A NAME="XPOSE_SPECTRAL_NUDGING_x2y.inc_11"><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='699'>
<a name='700'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DY'>spectral_nudging_filter_3dy</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DY_7">( grid%dif_yyy, ywavenum,    &amp;<a name='701'>
                                ids, ide, jds, jde, kds, kde,         &amp;<a name='702'>
                                imsy, imey, jmsy, jmey, kmsy, kmey,     &amp;<a name='703'>
                                ipsy, ipey, jpsy, jpey, kpsy, kpey  )<a name='704'>
<a name='705'>
# include "<A href='../../html_code/include/XPOSE_SPECTRAL_NUDGING_y2z.inc.html'>XPOSE_SPECTRAL_NUDGING_y2z.inc</A>"<A NAME="XPOSE_SPECTRAL_NUDGING_y2z.inc_12"><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='706'>
<a name='707'>
<a name='708'>
#else<a name='709'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DX'>spectral_nudging_filter_3dx</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DX_8">( grid%dif_analysis, xwavenum,     &amp;<a name='710'>
                                ids, ide, jds, jde, kds, kde,       &amp;<a name='711'>
                                ims, ime, jms, jme, kms, kme,       &amp;<a name='712'>
                                ips, ipe, jps, jpe, kps, kpe )<a name='713'>
<a name='714'>
     CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DY'>spectral_nudging_filter_3dy</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRAL_NUDGING_FILTER_3DY_8">( grid%dif_analysis, ywavenum,      &amp;<a name='715'>
                                ids, ide, jds, jde, kds, kde,       &amp;<a name='716'>
                                ims, ime, jms, jme, kms, kme,       &amp;<a name='717'>
                                ips, ipe, jps, jpe, kps, kpe  )<a name='718'>
#endif<a name='719'>
<a name='720'>
<font color=#447700>! Calculate tendency<a name='721'></font>
<a name='722'>
 <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='723'></font>
 <font color=#447700>!$OMP PRIVATE ( ij, i,j,k )<a name='724'></font>
 DO ij = 1 , num_tiles<a name='725'>
<a name='726'>
   DO j=jts,jte<a name='727'>
   DO k=kts,kte<a name='728'>
   DO i=its,ite<a name='729'>
     RPHNDGDTEN(i,k,j) = gph * wpbl(i,k,j,4) * wzfac(k,4) * tfac * &amp;<a name='730'>
                        grid%dif_analysis(i,k,j)<a name='731'>
   ENDDO<a name='732'>
   ENDDO<a name='733'>
   ENDDO<a name='734'>
<a name='735'>
 ENDDO<a name='736'>
 <font color=#447700>!$OMP END PARALLEL DO<a name='737'></font>
<a name='738'>
ENDIF<a name='739'>
<a name='740'>
#endif<a name='741'>
<a name='742'>
   END SUBROUTINE spectral_nudging<a name='743'>
<a name='744'>
<font color=#447700>!------------------------------------------------------------------------------<a name='745'></font>
<a name='746'>
<A NAME='SPECTRAL_NUDGING_FILTER_3DX'><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='747'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>spectral_nudging_filter_3dx</font>( f, nwave,            &amp; <A href='../../call_to/SPECTRAL_NUDGING_FILTER_3DX.html' TARGET='index'>8</A>,<A href='../../call_from/SPECTRAL_NUDGING_FILTER_3DX.html' TARGET='index'>3</A><a name='748'>
                            ids, ide, jds, jde, kds, kde,    &amp;<a name='749'>
                            ims, ime, jms, jme, kms, kme,    &amp;<a name='750'>
                            its, ite, jts, jte, kts, kte )<a name='751'>
<a name='752'>
  IMPLICIT NONE<a name='753'>
<a name='754'>
  INTEGER ,       INTENT(IN   ) :: nwave<a name='755'>
  INTEGER ,       INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='756'>
                                   ims, ime, jms, jme, kms, kme, &amp;<a name='757'>
                                   its, ite, jts, jte, kts, kte<a name='758'>
<a name='759'>
  REAL , DIMENSION( ims:ime , kms:kme, jms:jme ) , INTENT(INOUT) ::  f<a name='760'>
<a name='761'>
  REAL , DIMENSION(1:ide-ids+1,1:kte-kts+1) :: sheet<a name='762'>
  INTEGER ::  i, j, j_end, k, nx, ny<a name='763'>
<a name='764'>
  <font color=#447700>! Variables will stay in domain form since this routine is meaningless<a name='765'></font>
  <font color=#447700>! unless tile extent is the same as domain extent in E/W direction, i.e.,<a name='766'></font>
  <font color=#447700>! the processor has access to all grid points in E/W direction.<a name='767'></font>
  <font color=#447700>! There may be other ways of doing FFTs, but we haven't learned them yet...<a name='768'></font>
<a name='769'>
  <font color=#447700>! Check to make sure we have full access to all E/W points<a name='770'></font>
  IF ((its /= ids) .OR. (ite /= ide)) THEN<a name='771'>
     WRITE ( wrf_err_message , * ) 'module_spectral_nudging: 3d: (its /= ids) or (ite /= ide)',its,ids,ite,ide<a name='772'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_640"> ( TRIM( wrf_err_message ) )<a name='773'>
  END IF<a name='774'>
<a name='775'>
<a name='776'>
  nx = ide-ids+1 <a name='777'>
  ny = kte-kts+1 <font color=#447700>! we can filter extra level for variables that are non-Z-staggered<a name='778'></font>
  j_end = MIN(jte, jde-1)<a name='779'>
  IF (j_end == jde-1) j_end = jde<a name='780'>
  DO j = jts, j_end<a name='781'>
<a name='782'>
        DO k=kts,kte<a name='783'>
        DO i=ids,ide-1<a name='784'>
           sheet(i-ids+1,k-kts+1) = <A href='../../html_code/phys/module_mp_full_sbm.F.html#F'>f</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="F_12">(i,k,j)<a name='785'>
        END DO<a name='786'>
           sheet(ide,k-kts+1) = 0.<a name='787'>
        END DO<a name='788'>
<a name='789'>
        CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRALNUDGINGFILTERFFT2DNCAR'>spectralnudgingfilterfft2dncar</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRALNUDGINGFILTERFFT2DNCAR_1">(nx,ny,nwave,sheet)<a name='790'>
<a name='791'>
        DO k=kts,kte<a name='792'>
           DO i=ids,ide<a name='793'>
              f(i,k,j) = sheet(i-ids+1,k-kts+1)<a name='794'>
           END DO<a name='795'>
        END DO<a name='796'>
  END DO <font color=#447700>! outer j (latitude) loop<a name='797'></font>
<a name='798'>
END SUBROUTINE spectral_nudging_filter_3dx<a name='799'>
<font color=#447700>!------------------------------------------------------------------------------<a name='800'></font>
<a name='801'>
<A NAME='SPECTRAL_NUDGING_FILTER_3DY'><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='802'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>spectral_nudging_filter_3dy</font>( f, nwave,   &amp; <A href='../../call_to/SPECTRAL_NUDGING_FILTER_3DY.html' TARGET='index'>8</A>,<A href='../../call_from/SPECTRAL_NUDGING_FILTER_3DY.html' TARGET='index'>3</A><a name='803'>
                            ids, ide, jds, jde, kds, kde,    &amp;<a name='804'>
                            ims, ime, jms, jme, kms, kme,    &amp;<a name='805'>
                            its, ite, jts, jte, kts, kte )<a name='806'>
<a name='807'>
  IMPLICIT NONE<a name='808'>
<a name='809'>
  INTEGER ,       INTENT(IN   ) :: nwave<a name='810'>
  INTEGER ,       INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='811'>
                                   ims, ime, jms, jme, kms, kme, &amp;<a name='812'>
                                   its, ite, jts, jte, kts, kte<a name='813'>
<a name='814'>
  REAL , DIMENSION( ims:ime , kms:kme, jms:jme ) , INTENT(INOUT) ::  f<a name='815'>
<a name='816'>
  REAL , DIMENSION(1:jde-jds+1,1:kte-kts+1) :: sheet<a name='817'>
  INTEGER ::  i, j, i_end, k, nx, ny<a name='818'>
<a name='819'>
  <font color=#447700>! Variables will stay in domain form since this routine is meaningless<a name='820'></font>
  <font color=#447700>! unless tile extent is the same as domain extent in S/N direction, i.e.,<a name='821'></font>
  <font color=#447700>! the processor has access to all grid points in S/N direction.<a name='822'></font>
  <font color=#447700>! There may be other ways of doing FFTs, but we haven't learned them yet...<a name='823'></font>
<a name='824'>
  <font color=#447700>! Check to make sure we have full access to all S/N points<a name='825'></font>
  IF ((jts /= jds) .OR. (jte /= jde)) THEN<a name='826'>
     WRITE ( wrf_err_message , * ) 'module_spectral_nudging: 3d: (jts /= jds) or (jte /= jde)',jts,jds,jte,jde<a name='827'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_641"> ( TRIM( wrf_err_message ) )<a name='828'>
  END IF<a name='829'>
<a name='830'>
<a name='831'>
  nx = jde-jds+1<a name='832'>
  ny = kte-kts+1 <font color=#447700>! we can filter extra level for variables that are non-Z-staggered<a name='833'></font>
  i_end = MIN(ite, ide-1)<a name='834'>
  IF (i_end == ide-1) i_end = ide<a name='835'>
  DO i = its, i_end<a name='836'>
<a name='837'>
        DO k=kts,kte<a name='838'>
        DO j=jds,jde<a name='839'>
           sheet(j-jds+1,k-kts+1) = <A href='../../html_code/phys/module_mp_full_sbm.F.html#F'>f</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="F_13">(i,k,j)<a name='840'>
        END DO<a name='841'>
           sheet(jde,k-kts+1) = 0.<a name='842'>
        END DO<a name='843'>
<a name='844'>
        CALL <A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRALNUDGINGFILTERFFT2DNCAR'>spectralnudgingfilterfft2dncar</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRAL_NUDGING_FILTER_3DY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPECTRALNUDGINGFILTERFFT2DNCAR_2">(nx,ny,nwave,sheet)<a name='845'>
<a name='846'>
        DO k=kts,kte<a name='847'>
           DO j=jds,jde<a name='848'>
              f(i,k,j) = sheet(j-jds+1,k-kts+1)<a name='849'>
           END DO<a name='850'>
        END DO<a name='851'>
  END DO <font color=#447700>! outer i (longitude) loop<a name='852'></font>
<a name='853'>
END SUBROUTINE spectral_nudging_filter_3dy<a name='854'>
<a name='855'>
<font color=#447700>!------------------------------------------------------------------------------<a name='856'></font>
<a name='857'>
<A NAME='SPECTRALNUDGINGFILTERFFT2DNCAR'><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRALNUDGINGFILTERFFT2DNCAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='858'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>spectralnudgingfilterfft2dncar</font>(nx,ny,nwave,fin) <A href='../../call_to/SPECTRALNUDGINGFILTERFFT2DNCAR.html' TARGET='index'>2</A>,<A href='../../call_from/SPECTRALNUDGINGFILTERFFT2DNCAR.html' TARGET='index'>3</A><a name='859'>
  IMPLICIT NONE<a name='860'>
  INTEGER , INTENT(IN) :: nx, ny, nwave<a name='861'>
  REAL , DIMENSION(nx,ny), INTENT(INOUT) :: fin<a name='862'>
<a name='863'>
  INTEGER :: i, j<a name='864'>
  REAL, dimension(nx,ny) :: fp<a name='865'>
<a name='866'>
  INTEGER :: lensave, ier, nh, n1<a name='867'>
  INTEGER :: lot, jump, n, inc, lenr, lensav, lenwrk<a name='868'>
  REAL, DIMENSION(nx+15) :: wsave<a name='869'>
  REAL, DIMENSION(nx,ny) :: work<a name='870'>
  <a name='871'>
<a name='872'>
<a name='873'>
<a name='874'>
<font color=#447700>!  we are following the naming convention of the fftpack5 routines<a name='875'></font>
<a name='876'>
  n = nx<a name='877'>
  lot = ny<a name='878'>
  lensav = n+15<a name='879'>
  inc = 1<a name='880'>
  lenr = nx*ny<a name='881'>
  jump = nx<a name='882'>
  lenwrk = lenr<a name='883'>
<a name='884'>
<font color=#447700>!  forward transform<a name='885'></font>
<font color=#447700>!  initialize coefficients, place in wsave<a name='886'></font>
<font color=#447700>!   (should place this in init and save wsave at program start)<a name='887'></font>
<a name='888'>
  call rfftmi(n,wsave,lensav,ier)<a name='889'>
  IF(ier /= 0) THEN<a name='890'>
    write(wrf_err_message,*) ' error in rfftmi ',ier<a name='891'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRALNUDGINGFILTERFFT2DNCAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_703">(TRIM(wrf_err_message))<a name='892'>
  END IF<a name='893'>
<a name='894'>
<font color=#447700>!  do the forward transform<a name='895'></font>
<a name='896'>
  call rfftmf( lot, jump, n, inc, fin, lenr, wsave, lensav, work, lenwrk, ier )<a name='897'>
  IF(ier /= 0) THEN<a name='898'>
    write(wrf_err_message,*) ' error in rfftmf ',ier<a name='899'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRALNUDGINGFILTERFFT2DNCAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_704">(TRIM(wrf_err_message))<a name='900'>
  END IF<a name='901'>
<a name='902'>
      nh = min(max(1 + 2*nwave,0),n)<a name='903'>
<a name='904'>
<a name='905'>
<font color=#447700>! filter all waves with wavenumber larger than nwave<a name='906'></font>
<a name='907'>
  fp = 1.<a name='908'>
<a name='909'>
  DO j=1,ny<a name='910'>
     DO i=nh+1,n<a name='911'>
         fp(i,j) = 0.<a name='912'>
     ENDDO<a name='913'>
  ENDDO<a name='914'>
<a name='915'>
  DO j=1,ny<a name='916'>
    DO i=1,nx<a name='917'>
      fin(i,j) = fp(i,j)*fin(i,j)<a name='918'>
    ENDDO<a name='919'>
  ENDDO<a name='920'>
<a name='921'>
<font color=#447700>!  do the backward transform<a name='922'></font>
<a name='923'>
  call rfftmb( lot, jump, n, inc, fin, lenr, wsave, lensav, work, lenwrk, ier )<a name='924'>
  IF(ier /= 0) THEN<a name='925'>
    write(wrf_err_message,*) ' error in rfftmb ',ier<a name='926'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#SPECTRALNUDGINGFILTERFFT2DNCAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_705">(TRIM(wrf_err_message))<a name='927'>
  END IF<a name='928'>
<a name='929'>
END SUBROUTINE spectralnudgingfilterfft2dncar<a name='930'>
<a name='931'>
<font color=#447700>!-------------------------------------------------------------------<a name='932'></font>
<a name='933'>
<A NAME='FDDASPNUDGINGINIT'><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='934'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>fddaspnudginginit</font>(id,rundgdten,rvndgdten,rthndgdten,rphndgdten, &amp; <A href='../../call_to/FDDASPNUDGINGINIT.html' TARGET='index'>1</A>,<A href='../../call_from/FDDASPNUDGINGINIT.html' TARGET='index'>23</A><a name='935'>
               run_hours,  &amp;<a name='936'>
               if_no_pbl_nudging_uv, if_no_pbl_nudging_t, if_no_pbl_nudging_ph, &amp;<a name='937'>
               if_zfac_uv, k_zfac_uv, dk_zfac_uv, &amp;<a name='938'>
               if_zfac_t, k_zfac_t, dk_zfac_t, &amp;<a name='939'>
               if_zfac_ph, k_zfac_ph, dk_zfac_ph, &amp;               <a name='940'>
               guv, gt, gph, if_ramping, dtramp_min, end_fdda_hour, &amp;<a name='941'>
               xwavenum,ywavenum,                          &amp;<a name='942'>
                      restart, allowed_to_read,                    &amp;<a name='943'>
                      ids, ide, jds, jde, kds, kde,                &amp;<a name='944'>
                      ims, ime, jms, jme, kms, kme,                &amp;<a name='945'>
                      its, ite, jts, jte, kts, kte                 )<a name='946'>
<font color=#447700>!-------------------------------------------------------------------<a name='947'></font>
   IMPLICIT NONE<a name='948'>
<font color=#447700>!-------------------------------------------------------------------<a name='949'></font>
<font color=#447700>!<a name='950'></font>
   INTEGER , INTENT(IN)         ::  id<a name='951'>
   LOGICAL, INTENT(IN)          ::  restart, allowed_to_read<a name='952'>
   INTEGER, INTENT(IN)          ::  ids, ide, jds, jde, kds, kde, &amp;<a name='953'>
                                    ims, ime, jms, jme, kms, kme, &amp;<a name='954'>
                                    its, ite, jts, jte, kts, kte<a name='955'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(OUT) :: &amp;<a name='956'>
                                                       rundgdten, &amp;<a name='957'>
                                                       rvndgdten, &amp;<a name='958'>
                                                      rthndgdten, &amp;<a name='959'>
                                                      rphndgdten<a name='960'>
   INTEGER,  INTENT(IN)   ::      run_hours<a name='961'>
   INTEGER,  INTENT(IN)   ::      if_no_pbl_nudging_uv, if_no_pbl_nudging_t, &amp;<a name='962'>
                                  if_no_pbl_nudging_ph, end_fdda_hour<a name='963'>
   INTEGER,  INTENT(IN)   ::      if_zfac_uv, if_zfac_t, if_zfac_ph<a name='964'>
   INTEGER,  INTENT(IN)   ::      k_zfac_uv,  k_zfac_t,  k_zfac_ph<a name='965'>
   INTEGER,  INTENT(IN)   ::      dk_zfac_uv,  dk_zfac_t,  dk_zfac_ph<a name='966'>
   INTEGER,  INTENT(IN)   ::      if_ramping<a name='967'>
   INTEGER,  INTENT(IN)   ::      xwavenum,ywavenum<a name='968'>
   REAL,     INTENT(IN)   ::      dtramp_min<a name='969'>
   REAL, INTENT(IN)       ::      guv, gt, gph<a name='970'>
   REAL                   ::      actual_end_fdda_min<a name='971'>
<a name='972'>
   INTEGER :: i, j, k<a name='973'>
<a name='974'>
   LOGICAL , EXTERNAL     ::      wrf_dm_on_monitor<a name='975'>
<a name='976'>
   CHARACTER (LEN=256) :: wrf_err_message<a name='977'>
<a name='978'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='979'>
<a name='980'>
     IF( guv &gt; 0.0) THEN<a name='981'>
       WRITE(wrf_err_message,'(a,i1,a,e12.4,a,i4,a,i4)') &amp;<a name='982'>
           'D0',id,' Spectral nudging for wind is turned on and Guv= ', guv,' xwave= ',xwavenum,' ywavenum= ',ywavenum<a name='983'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_706">(TRIM(wrf_err_message))<a name='984'>
     ELSE IF( guv &lt; 0.0 ) THEN<a name='985'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_642">('In grid FDDA, Guv must be positive.')<a name='986'>
     ELSE<a name='987'>
       WRITE(wrf_err_message,'(a,i1,a,e12.4)') &amp;<a name='988'>
           'D0',id,' Spectral nudging for wind is turned off and Guv= ', guv<a name='989'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_707">(TRIM(wrf_err_message))<a name='990'>
     ENDIF<a name='991'>
<a name='992'>
     IF( gt &gt; 0.0) THEN<a name='993'>
       WRITE(wrf_err_message,'(a,i1,a,e12.4,a,i4,a,i4)') &amp;<a name='994'>
           'D0',id,' Spectral nudging for temperature is turned on and Gt= ', gt,' xwave= ',xwavenum,' ywavenum= ',ywavenum<a name='995'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_708">(TRIM(wrf_err_message))<a name='996'>
     ELSE IF( gt &lt; 0.0 ) THEN<a name='997'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_643">('In grid FDDA, Gt must be positive.')<a name='998'>
     ELSE<a name='999'>
       WRITE(wrf_err_message,'(a,i1,a,e12.4)') &amp;<a name='1000'>
           'D0',id,' Spectral nudging for temperature is turned off and Gt= ', gt<a name='1001'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_709">(TRIM(wrf_err_message))<a name='1002'>
     ENDIF<a name='1003'>
<a name='1004'>
     IF( gph &gt; 0.0) THEN<a name='1005'>
       WRITE(wrf_err_message,'(a,i1,a,e12.4,a,i4,a,i4)') &amp;<a name='1006'>
         'D0',id,' Spectral nudging for geopotential is turned on and Gph= ', gph,' xwave= ',xwavenum,' ywavenum= ',ywavenum<a name='1007'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_710">(TRIM(wrf_err_message))<a name='1008'>
     ELSE IF( gph &lt; 0.0 ) THEN<a name='1009'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_644">('In grid FDDA, Gph must be positive.')<a name='1010'>
     ELSE<a name='1011'>
       WRITE(wrf_err_message,'(a,i1,a,e12.4)') &amp;<a name='1012'>
         'D0',id,' Spectral nudging for geopotential is turned off and Gph= ', gph<a name='1013'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_711">(TRIM(wrf_err_message))<a name='1014'>
     ENDIF<a name='1015'>
<a name='1016'>
     IF( guv &gt; 0.0 .AND. if_no_pbl_nudging_uv == 1 ) THEN<a name='1017'>
        WRITE(wrf_err_message,'(a,i1,a)') &amp;<a name='1018'>
           'D0',id,' Spectral nudging for wind is turned off within the PBL.'<a name='1019'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_712">(TRIM(wrf_err_message))<a name='1020'>
             IF( dk_zfac_uv &lt; 1 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_645">('In spectral nudging, dk_zfac_uv must be greater or equal than 1.')<a name='1021'>
     ELSEIF( guv &gt; 0.0 .AND. if_zfac_uv == 1 ) THEN<a name='1022'>
        WRITE(wrf_err_message,'(a,i1,a,i3)') &amp;<a name='1023'>
           'D0',id,' Spectral nudging for wind is turned off below layer', k_zfac_uv<a name='1024'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_713">(TRIM(wrf_err_message))<a name='1025'>
             IF( dk_zfac_uv &lt; 1 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_646">('In spectral nudging, dk_zfac_uv must  be greater or equal than 1.')       <a name='1026'>
     ENDIF<a name='1027'>
<a name='1028'>
<a name='1029'>
     IF( gt &gt; 0.0 .AND. if_no_pbl_nudging_t == 1 ) THEN<a name='1030'>
        WRITE(wrf_err_message,'(a,i1,a)') &amp;<a name='1031'>
           'D0',id,' Spectral nudging for temperature is turned off within the PBL.'<a name='1032'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_714">(TRIM(wrf_err_message))<a name='1033'>
             IF( dk_zfac_t &lt; 1 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_647">('In spectral nudging, dk_zfac_t must be greater or equal than 1.')<a name='1034'>
     ELSEIF( gt &gt; 0.0 .AND. if_zfac_t == 1 ) THEN<a name='1035'>
        WRITE(wrf_err_message,'(a,i1,a,i3)') &amp;<a name='1036'>
           'D0',id,' Spectral nudging for temperature is turned off below layer', k_zfac_t<a name='1037'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_715">(TRIM(wrf_err_message))<a name='1038'>
            IF( dk_zfac_t &lt; 1 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_648">('In spectral nudging, dk_zfac_t must be greater or equal than 1.')<a name='1039'>
     ENDIF<a name='1040'>
<a name='1041'>
<a name='1042'>
     IF( gph &gt; 0.0 .AND. if_no_pbl_nudging_ph == 1 ) THEN<a name='1043'>
        WRITE(wrf_err_message,'(a,i1,a)') &amp;<a name='1044'>
         'D0',id,' Spectral nudging for geopotential is turned off within the PBL.'<a name='1045'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_716">(TRIM(wrf_err_message))<a name='1046'>
            IF( dk_zfac_ph &lt; 1 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_649">('In spectral nudging, dk_zfac_ph must be greater or equal than 1.')<a name='1047'>
     ELSEIF( gph &gt; 0.0 .AND. if_zfac_ph == 1 ) THEN<a name='1048'>
        WRITE(wrf_err_message,'(a,i1,a,i3)') &amp;<a name='1049'>
          'D0',id,' Spectral nudging for geopotential is turned off below layer', &amp;<a name='1050'>
           k_zfac_ph<a name='1051'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_717">(TRIM(wrf_err_message))<a name='1052'>
            IF( dk_zfac_ph &lt; 1 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_650">('In spectral nudging, dk_zfac_ph must be greater or equal than 1.')<a name='1053'>
     ENDIF<a name='1054'>
<a name='1055'>
     IF( if_ramping == 1 .AND. ABS(dtramp_min) &gt; 0.0 ) THEN<a name='1056'>
       IF( dtramp_min &lt;= 0.0 ) THEN<a name='1057'>
         actual_end_fdda_min = end_fdda_hour*60.0<a name='1058'>
       ELSE<a name='1059'>
         actual_end_fdda_min = end_fdda_hour*60.0 + ABS(dtramp_min)<a name='1060'>
       ENDIF<a name='1061'>
<a name='1062'>
       IF( actual_end_fdda_min &lt;= run_hours*60. ) THEN<a name='1063'>
          WRITE(wrf_err_message,'(a,i1,a)') &amp;<a name='1064'>
            'D0',id,' Spectral nudging is ramped down near the end of the nudging period,'<a name='1065'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_718">(TRIM(wrf_err_message))<a name='1066'>
<a name='1067'>
          WRITE(wrf_err_message,'(a,f6.2,a,f6.2,a)') &amp;<a name='1068'>
             '      starting at ', (actual_end_fdda_min - ABS(dtramp_min))/60.0,&amp;<a name='1069'>
             'h, ending at ', actual_end_fdda_min/60.0,'h.'<a name='1070'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_fdda_spnudging.F.html#FDDASPNUDGINGINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_719">(TRIM(wrf_err_message))<a name='1071'>
       ENDIF<a name='1072'>
     ENDIF<a name='1073'>
<a name='1074'>
   ENDIF<a name='1075'>
<a name='1076'>
   IF(.not.restart) THEN<a name='1077'>
     DO j = jts,jte<a name='1078'>
     DO k = kts,kte<a name='1079'>
     DO i = its,ite<a name='1080'>
        rundgdten(i,k,j) = 0.<a name='1081'>
        rvndgdten(i,k,j) = 0.<a name='1082'>
        rthndgdten(i,k,j) = 0.<a name='1083'>
        rphndgdten(i,k,j) = 0.<a name='1084'>
     ENDDO<a name='1085'>
     ENDDO<a name='1086'>
     ENDDO<a name='1087'>
   ENDIF<a name='1088'>
<a name='1089'>
   END SUBROUTINE fddaspnudginginit<a name='1090'>
<font color=#447700>!-------------------------------------------------------------------<a name='1091'></font>
<a name='1092'>
END MODULE module_fdda_spnudging<a name='1093'>
</pre></body></html>